void InitTo330Pointer(unsigned char ChipType, struct vb_device_info *pVBInfo)\r\n{\r\npVBInfo->MCLKData = XGI340New_MCLKData;\r\npVBInfo->LCDResInfo = 0;\r\npVBInfo->LCDTypeInfo = 0;\r\npVBInfo->LCDInfo = 0;\r\npVBInfo->VBInfo = 0;\r\npVBInfo->TVInfo = 0;\r\npVBInfo->SR18 = XGI340_SR18;\r\npVBInfo->CR40 = XGI340_cr41;\r\nif (ChipType < XG20)\r\nXGI_GetVBType(pVBInfo);\r\nif ((pVBInfo->VBType & VB_SIS301LV) || (pVBInfo->VBType & VB_SIS302LV))\r\npVBInfo->LCDCapList = XGI_LCDDLCapList;\r\nelse\r\npVBInfo->LCDCapList = XGI_LCDCapList;\r\nif (ChipType >= XG20)\r\npVBInfo->XGINew_CR97 = 0x10;\r\nif (ChipType == XG27) {\r\nunsigned char temp;\r\npVBInfo->MCLKData = XGI27New_MCLKData;\r\npVBInfo->CR40 = XGI27_cr41;\r\npVBInfo->XGINew_CR97 = 0xc1;\r\npVBInfo->SR18 = XG27_SR18;\r\ntemp = xgifb_reg_get(pVBInfo->P3c4, 0x3B);\r\nif (((temp & 0x88) == 0x80) || ((temp & 0x88) == 0x08))\r\npVBInfo->XGINew_CR97 = 0x80;\r\n}\r\n}\r\nstatic void XGI_SetSeqRegs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char SRdata, i;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x00, 0x03);\r\nfor (i = 0; i < 4; i++) {\r\nSRdata = XGI330_StandTable.SR[i];\r\nxgifb_reg_set(pVBInfo->P3c4, i+1, SRdata);\r\n}\r\n}\r\nstatic void XGI_SetCRTCRegs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CRTCdata;\r\nunsigned short i;\r\nCRTCdata = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\nCRTCdata &= 0x7f;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, CRTCdata);\r\nfor (i = 0; i <= 0x18; i++) {\r\nCRTCdata = XGI330_StandTable.CRTC[i];\r\nxgifb_reg_set(pVBInfo->P3d4, i, CRTCdata);\r\n}\r\n}\r\nstatic void XGI_SetATTRegs(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char ARdata;\r\nunsigned short i, modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nfor (i = 0; i <= 0x13; i++) {\r\nARdata = XGI330_StandTable.ATTR[i];\r\nif ((modeflag & Charx8Dot) && i == 0x13) {\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) {\r\nARdata = 0;\r\n} else if ((pVBInfo->VBInfo &\r\n(SetCRT2ToTV | SetCRT2ToLCD)) &&\r\n(pVBInfo->VBInfo & SetInSlaveMode)) {\r\nARdata = 0;\r\n}\r\n}\r\ninb(pVBInfo->P3da);\r\noutb(i, pVBInfo->P3c0);\r\noutb(ARdata, pVBInfo->P3c0);\r\n}\r\ninb(pVBInfo->P3da);\r\noutb(0x14, pVBInfo->P3c0);\r\noutb(0x00, pVBInfo->P3c0);\r\ninb(pVBInfo->P3da);\r\noutb(0x20, pVBInfo->P3c0);\r\n}\r\nstatic void XGI_SetGRCRegs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char GRdata;\r\nunsigned short i;\r\nfor (i = 0; i <= 0x08; i++) {\r\nGRdata = XGI330_StandTable.GRC[i];\r\nxgifb_reg_set(pVBInfo->P3ce, i, GRdata);\r\n}\r\nif (pVBInfo->ModeType > ModeVGA) {\r\nGRdata = xgifb_reg_get(pVBInfo->P3ce, 0x05);\r\nGRdata &= 0xBF;\r\nxgifb_reg_set(pVBInfo->P3ce, 0x05, GRdata);\r\n}\r\n}\r\nstatic void XGI_ClearExt1Regs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i;\r\nfor (i = 0x0A; i <= 0x0E; i++)\r\nxgifb_reg_set(pVBInfo->P3c4, i, 0x00);\r\n}\r\nstatic unsigned char XGI_SetDefaultVCLK(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x31, ~0x30, 0x20);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, XGI_VCLKData[0].SR2B);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, XGI_VCLKData[0].SR2C);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x31, ~0x30, 0x10);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, XGI_VCLKData[1].SR2B);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, XGI_VCLKData[1].SR2C);\r\nxgifb_reg_and(pVBInfo->P3c4, 0x31, ~0x30);\r\nreturn 0;\r\n}\r\nstatic unsigned char XGI_AjustCRT2Rate(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex, unsigned short *i,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax, tempbx, resinfo, modeflag, infoflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\ntempbx = XGI330_RefIndex[RefreshRateTableIndex + (*i)].ModeID;\r\ntempax = 0;\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC) {\r\ntempax |= SupportRAMDAC2;\r\nif (pVBInfo->VBType & VB_XGI301C)\r\ntempax |= SupportCRT2in301C;\r\n}\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\ntempax |= SupportLCD;\r\nif (pVBInfo->LCDResInfo != Panel_1280x1024 &&\r\npVBInfo->LCDResInfo != Panel_1280x960 &&\r\n(pVBInfo->LCDInfo & LCDNonExpanding) &&\r\nresinfo >= 9)\r\nreturn 0;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\ntempax |= SupportHiVision;\r\nif ((pVBInfo->VBInfo & SetInSlaveMode) &&\r\n((resinfo == 4) ||\r\n(resinfo == 3 && (pVBInfo->SetFlag & TVSimuMode)) ||\r\n(resinfo > 7)))\r\nreturn 0;\r\n} else if (pVBInfo->VBInfo & (SetCRT2ToAVIDEO | SetCRT2ToSVIDEO |\r\nSetCRT2ToSCART | SetCRT2ToYPbPr525750 |\r\nSetCRT2ToHiVision)) {\r\ntempax |= SupportTV;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV |\r\nVB_SIS302LV | VB_XGI301C))\r\ntempax |= SupportTV1024;\r\nif (!(pVBInfo->VBInfo & TVSetPAL) &&\r\n(modeflag & NoSupportSimuTV) &&\r\n(pVBInfo->VBInfo & SetInSlaveMode) &&\r\n(!(pVBInfo->VBInfo & SetNotSimuMode)))\r\nreturn 0;\r\n}\r\nfor (; XGI330_RefIndex[RefreshRateTableIndex + (*i)].ModeID ==\r\ntempbx; (*i)--) {\r\ninfoflag = XGI330_RefIndex[RefreshRateTableIndex + (*i)].\r\nExt_InfoFlag;\r\nif (infoflag & tempax)\r\nreturn 1;\r\nif ((*i) == 0)\r\nbreak;\r\n}\r\nfor ((*i) = 0;; (*i)++) {\r\ninfoflag = XGI330_RefIndex[RefreshRateTableIndex + (*i)].\r\nExt_InfoFlag;\r\nif (XGI330_RefIndex[RefreshRateTableIndex + (*i)].ModeID\r\n!= tempbx) {\r\nreturn 0;\r\n}\r\nif (infoflag & tempax)\r\nreturn 1;\r\n}\r\nreturn 1;\r\n}\r\nstatic void XGI_SetSync(unsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short sync, temp;\r\nsync = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag >> 8;\r\nsync &= 0xC0;\r\ntemp = 0x2F;\r\ntemp |= sync;\r\noutb(temp, pVBInfo->P3c2);\r\n}\r\nstatic void XGI_SetCRT1Timing_H(struct vb_device_info *pVBInfo,\r\nstruct xgi_hw_device_info *HwDeviceExtension)\r\n{\r\nunsigned char data, data1, pushax;\r\nunsigned short i, j;\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\ndata &= 0x7F;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, data);\r\ndata = pVBInfo->TimingH.data[0];\r\nxgifb_reg_set(pVBInfo->P3d4, 0, data);\r\nfor (i = 0x01; i <= 0x04; i++) {\r\ndata = pVBInfo->TimingH.data[i];\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 1), data);\r\n}\r\nfor (i = 0x05; i <= 0x06; i++) {\r\ndata = pVBInfo->TimingH.data[i];\r\nxgifb_reg_set(pVBInfo->P3c4, (unsigned short) (i + 6), data);\r\n}\r\nj = xgifb_reg_get(pVBInfo->P3c4, 0x0e);\r\nj &= 0x1F;\r\ndata = pVBInfo->TimingH.data[7];\r\ndata &= 0xE0;\r\ndata |= j;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x0e, data);\r\nif (HwDeviceExtension->jChipType >= XG20) {\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x04);\r\ndata = data - 1;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x04, data);\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x05);\r\ndata1 = data;\r\ndata1 &= 0xE0;\r\ndata &= 0x1F;\r\nif (data == 0) {\r\npushax = data;\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x0c);\r\ndata &= 0xFB;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x0c, data);\r\ndata = pushax;\r\n}\r\ndata = data - 1;\r\ndata |= data1;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x05, data);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x0e);\r\ndata >>= 5;\r\ndata = data + 3;\r\nif (data > 7)\r\ndata = data - 7;\r\ndata <<= 5;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0e, ~0xE0, data);\r\n}\r\n}\r\nstatic void XGI_SetCRT1Timing_V(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char data;\r\nunsigned short i, j;\r\nfor (i = 0x00; i <= 0x01; i++) {\r\ndata = pVBInfo->TimingV.data[i];\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 6), data);\r\n}\r\nfor (i = 0x02; i <= 0x03; i++) {\r\ndata = pVBInfo->TimingV.data[i];\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 0x0e), data);\r\n}\r\nfor (i = 0x04; i <= 0x05; i++) {\r\ndata = pVBInfo->TimingV.data[i];\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 0x11), data);\r\n}\r\nj = xgifb_reg_get(pVBInfo->P3c4, 0x0a);\r\nj &= 0xC0;\r\ndata = pVBInfo->TimingV.data[6];\r\ndata &= 0x3F;\r\ndata |= j;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x0a, data);\r\ndata = pVBInfo->TimingV.data[6];\r\ndata &= 0x80;\r\ndata >>= 2;\r\ni = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ni &= DoubleScanMode;\r\nif (i)\r\ndata |= 0x80;\r\nj = xgifb_reg_get(pVBInfo->P3d4, 0x09);\r\nj &= 0x5F;\r\ndata |= j;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x09, data);\r\n}\r\nstatic void XGI_SetCRT1CRTC(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo,\r\nstruct xgi_hw_device_info *HwDeviceExtension)\r\n{\r\nunsigned char index, data;\r\nunsigned short i;\r\nindex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC;\r\nindex = index & IndexMask;\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\ndata &= 0x7F;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, data);\r\nfor (i = 0; i < 8; i++)\r\npVBInfo->TimingH.data[i]\r\n= XGI_CRT1Table[index].CR[i];\r\nfor (i = 0; i < 7; i++)\r\npVBInfo->TimingV.data[i]\r\n= XGI_CRT1Table[index].CR[i + 8];\r\nXGI_SetCRT1Timing_H(pVBInfo, HwDeviceExtension);\r\nXGI_SetCRT1Timing_V(ModeIdIndex, pVBInfo);\r\nif (pVBInfo->ModeType > 0x03)\r\nxgifb_reg_set(pVBInfo->P3d4, 0x14, 0x4F);\r\n}\r\nstatic void XGI_SetXG21CRTC(unsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char index, Tempax, Tempbx, Tempcx, Tempdx;\r\nunsigned short Temp1, Temp2, Temp3;\r\nindex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC;\r\nTempax = XGI_CRT1Table[index].CR[3];\r\nTempcx = Tempax;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2E, Tempax);\r\nTempdx = XGI_CRT1Table[index].CR[5];\r\nTempdx &= 0xC0;\r\nTemp1 = Tempdx;\r\nTemp1 <<= 2;\r\nTemp1 |= Tempax;\r\nTempax = XGI_CRT1Table[index].CR[4];\r\nTempax &= 0x1F;\r\nTempbx = XGI_CRT1Table[index].CR[6];\r\nTempbx &= 0x04;\r\nTempbx <<= 3;\r\nTempax |= Tempbx;\r\nTemp2 = Temp1 & 0x3C0;\r\nTemp2 |= Tempax;\r\nTempcx &= 0x3F;\r\nif (Tempax < Tempcx)\r\nTemp2 |= 0x40;\r\nTemp2 &= 0xFF;\r\nTempax = (unsigned char) Temp2;\r\nTempax <<= 2;\r\nTempdx >>= 6;\r\nTempax |= Tempdx;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2F, Tempax);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x30, 0xE3, 00);\r\nTempax = XGI_CRT1Table[index].CR[10];\r\nTempbx = Tempax;\r\nTempax &= 0x01;\r\nxgifb_reg_or(pVBInfo->P3c4, 0x33, Tempax);\r\nTempax = XGI_CRT1Table[index].CR[9];\r\nTempcx = Tempbx >> 1;\r\nTempdx = Tempax & 0x04;\r\nTempdx <<= 5;\r\nTempcx |= Tempdx;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x34, Tempcx);\r\nTemp1 = Tempdx;\r\nTemp1 <<= 1;\r\nTemp1 |= Tempbx;\r\nTempax &= 0x80;\r\nTemp2 = Tempax << 2;\r\nTemp1 |= Temp2;\r\nTempax = XGI_CRT1Table[index].CR[14];\r\nTempax &= 0x08;\r\nTemp2 = Tempax;\r\nTemp2 <<= 7;\r\nTemp1 |= Temp2;\r\nTempax = XGI_CRT1Table[index].CR[11];\r\nTempax &= 0x0F;\r\nTempbx = XGI_CRT1Table[index].CR[14];\r\nTempbx &= 0x20;\r\nTempbx >>= 1;\r\nTempax |= Tempbx;\r\nTemp2 = Temp1 & 0x7E0;\r\nTemp2 |= Tempax;\r\nTemp3 = Temp1 & 0x1F;\r\nif (Tempax < Temp3)\r\nTemp2 |= 0x20;\r\nTemp2 &= 0xFF;\r\nTempax = (unsigned char) Temp2;\r\nTempax <<= 2;\r\nTemp1 &= 0x600;\r\nTemp1 >>= 9;\r\nTempbx = (unsigned char) Temp1;\r\nTempax |= Tempbx;\r\nTempax &= 0x7F;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x3F, Tempax);\r\n}\r\nstatic void XGI_SetXG27CRTC(unsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short index, Tempax, Tempbx, Tempcx;\r\nindex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC;\r\nTempax = XGI_CRT1Table[index].CR[3];\r\nTempbx = Tempax;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2E, Tempax);\r\nTempax = XGI_CRT1Table[index].CR[5];\r\nTempax &= 0xC0;\r\nTempbx |= (Tempax << 2);\r\nTempax = XGI_CRT1Table[index].CR[4];\r\nTempax &= 0x1F;\r\nTempcx = Tempax;\r\nTempax = XGI_CRT1Table[index].CR[6];\r\nTempax &= 0x04;\r\nTempax <<= 3;\r\nTempcx |= Tempax;\r\nTempbx = Tempbx & 0x3C0;\r\nTempbx |= Tempcx;\r\nTempax = XGI_CRT1Table[index].CR[3];\r\nTempax &= 0x3F;\r\nif (Tempcx <= Tempax)\r\nTempbx += 0x40;\r\nTempax = XGI_CRT1Table[index].CR[5];\r\nTempax &= 0xC0;\r\nTempax >>= 6;\r\nTempax |= ((Tempbx << 2) & 0xFF);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2F, Tempax);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x30, 0xE3, 00);\r\nTempax = XGI_CRT1Table[index].CR[10];\r\nxgifb_reg_set(pVBInfo->P3c4, 0x34, Tempax);\r\nTempcx = Tempax;\r\nTempax = XGI_CRT1Table[index].CR[9];\r\nTempbx = Tempax;\r\nTempax = Tempax & 0x04;\r\nTempax >>= 2;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x35, ~0x01, Tempax);\r\nTempcx |= (Tempax << 8);\r\nTempcx |= ((Tempbx & 0x80) << 2);\r\nTempax = XGI_CRT1Table[index].CR[14];\r\nTempax &= 0x08;\r\nTempcx |= (Tempax << 7);\r\nTempax = XGI_CRT1Table[index].CR[11];\r\nTempax &= 0x0F;\r\nTempbx = XGI_CRT1Table[index].CR[14];\r\nTempbx &= 0x20;\r\nTempbx >>= 1;\r\nTempax |= Tempbx;\r\nTempbx = Tempcx;\r\nTempbx &= 0x7E0;\r\nTempbx |= Tempax;\r\nif (Tempbx <= Tempcx)\r\nTempbx |= 0x20;\r\nTempax = (Tempbx << 2) & 0xFF;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x3F, ~0xFC, Tempax);\r\nTempax = Tempcx >> 8;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x35, ~0x07, Tempax);\r\n}\r\nstatic void XGI_SetXG27FPBits(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char temp;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\ntemp = (temp & 3) << 6;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x06, ~0xc0, temp & 0x80);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x09, ~0xc0, temp | 0x80);\r\n}\r\nstatic void xgifb_set_lcd(int chip_id,\r\nstruct vb_device_info *pVBInfo,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short temp;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x2E, 0x00);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x2F, 0x00);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x46, 0x00);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x47, 0x00);\r\nif (chip_id == XG27) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\nif ((temp & 0x03) == 0) {\r\nxgifb_reg_set(pVBInfo->P3d4, 0x46, 0x13);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x47, 0x13);\r\n}\r\n}\r\nif (chip_id == XG27) {\r\nXGI_SetXG27FPBits(pVBInfo);\r\n} else {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\nif (temp & 0x01) {\r\nxgifb_reg_or(pVBInfo->P3c4, 0x06, 0x40);\r\nxgifb_reg_or(pVBInfo->P3c4, 0x09, 0x40);\r\n}\r\n}\r\nxgifb_reg_or(pVBInfo->P3c4, 0x1E, 0x01);\r\nxgifb_reg_and(pVBInfo->P3c4, 0x30, ~0x20);\r\nxgifb_reg_and(pVBInfo->P3c4, 0x35, ~0x80);\r\ntemp = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\nif (temp & 0x4000)\r\nxgifb_reg_or(pVBInfo->P3c4, 0x30, 0x20);\r\nif (temp & 0x8000)\r\nxgifb_reg_or(pVBInfo->P3c4, 0x35, 0x80);\r\n}\r\nstatic void XGI_UpdateXG21CRTC(unsigned short ModeNo,\r\nstruct vb_device_info *pVBInfo,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nint index = -1;\r\nxgifb_reg_and(pVBInfo->P3d4, 0x11, 0x7F);\r\nif (ModeNo == 0x2E &&\r\n(XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC ==\r\nRES640x480x60))\r\nindex = 12;\r\nelse if (ModeNo == 0x2E && (XGI330_RefIndex[RefreshRateTableIndex].\r\nExt_CRT1CRTC == RES640x480x72))\r\nindex = 13;\r\nelse if (ModeNo == 0x2F)\r\nindex = 14;\r\nelse if (ModeNo == 0x50)\r\nindex = 15;\r\nelse if (ModeNo == 0x59)\r\nindex = 16;\r\nif (index != -1) {\r\nxgifb_reg_set(pVBInfo->P3d4, 0x02,\r\nXGI_UpdateCRT1Table[index].CR02);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x03,\r\nXGI_UpdateCRT1Table[index].CR03);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x15,\r\nXGI_UpdateCRT1Table[index].CR15);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x16,\r\nXGI_UpdateCRT1Table[index].CR16);\r\n}\r\n}\r\nstatic void XGI_SetCRT1DE(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short resindex, tempax, tempbx, tempcx, temp, modeflag;\r\nunsigned char data;\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ntempax = XGI330_ModeResInfo[resindex].HTotal;\r\ntempbx = XGI330_ModeResInfo[resindex].VTotal;\r\nif (modeflag & HalfDCLK)\r\ntempax >>= 1;\r\nif (modeflag & HalfDCLK)\r\ntempax <<= 1;\r\ntemp = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\nif (temp & InterlaceMode)\r\ntempbx >>= 1;\r\nif (modeflag & DoubleScanMode)\r\ntempbx <<= 1;\r\ntempcx = 8;\r\ntempax /= tempcx;\r\ntempax -= 1;\r\ntempbx -= 1;\r\ntempcx = tempax;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\ndata &= 0x7F;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, data);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x01, (unsigned short) (tempcx & 0xff));\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x0b, ~0x0c,\r\n(unsigned short) ((tempcx & 0x0ff00) >> 10));\r\nxgifb_reg_set(pVBInfo->P3d4, 0x12, (unsigned short) (tempbx & 0xff));\r\ntempax = 0;\r\ntempbx >>= 8;\r\nif (tempbx & 0x01)\r\ntempax |= 0x02;\r\nif (tempbx & 0x02)\r\ntempax |= 0x40;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x42, tempax);\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x07);\r\ntempax = 0;\r\nif (tempbx & 0x04)\r\ntempax |= 0x02;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x0a, ~0x02, tempax);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, temp);\r\n}\r\nstatic void XGI_SetCRT1Offset(unsigned short ModeNo,\r\nunsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp, ah, al, temp2, i, DisplayUnit;\r\ntemp = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeInfo;\r\ntemp >>= 8;\r\ntemp = XGI330_ScreenOffset[temp];\r\ntemp2 = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\ntemp2 &= InterlaceMode;\r\nif (temp2)\r\ntemp <<= 1;\r\ntemp2 = pVBInfo->ModeType - ModeEGA;\r\nswitch (temp2) {\r\ncase 0:\r\ntemp2 = 1;\r\nbreak;\r\ncase 1:\r\ntemp2 = 2;\r\nbreak;\r\ncase 2:\r\ntemp2 = 4;\r\nbreak;\r\ncase 3:\r\ntemp2 = 4;\r\nbreak;\r\ncase 4:\r\ntemp2 = 6;\r\nbreak;\r\ncase 5:\r\ntemp2 = 8;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif ((ModeNo >= 0x26) && (ModeNo <= 0x28))\r\ntemp = temp * temp2 + temp2 / 2;\r\nelse\r\ntemp *= temp2;\r\nDisplayUnit = temp;\r\ntemp2 = temp;\r\ntemp >>= 8;\r\ntemp &= 0x0F;\r\ni = xgifb_reg_get(pVBInfo->P3c4, 0x0E);\r\ni &= 0xF0;\r\ni |= temp;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x0E, i);\r\ntemp = (unsigned char) temp2;\r\ntemp &= 0xFF;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x13, temp);\r\ntemp2 = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\ntemp2 &= InterlaceMode;\r\nif (temp2)\r\nDisplayUnit >>= 1;\r\nDisplayUnit <<= 5;\r\nah = (DisplayUnit & 0xff00) >> 8;\r\nal = DisplayUnit & 0x00ff;\r\nif (al == 0)\r\nah += 1;\r\nelse\r\nah += 2;\r\nif (HwDeviceExtension->jChipType >= XG20)\r\nif ((ModeNo == 0x4A) | (ModeNo == 0x49))\r\nah -= 1;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x10, ah);\r\n}\r\nstatic unsigned short XGI_GetVCLK2Ptr(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short VCLKIndex, modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\nif (pVBInfo->LCDResInfo != Panel_1024x768)\r\nVCLKIndex = VCLK108_2_315 + 5;\r\nelse\r\nVCLKIndex = VCLK65_315 + 2;\r\n} else if (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (pVBInfo->SetFlag & RPLLDIV2XO)\r\nVCLKIndex = TVCLKBASE_315_25 + HiTVVCLKDIV2;\r\nelse\r\nVCLKIndex = TVCLKBASE_315_25 + HiTVVCLK;\r\nif (pVBInfo->SetFlag & TVSimuMode) {\r\nif (modeflag & Charx8Dot)\r\nVCLKIndex = TVCLKBASE_315_25 + HiTVSimuVCLK;\r\nelse\r\nVCLKIndex = TVCLKBASE_315_25 + HiTVTextVCLK;\r\n}\r\nif (pVBInfo->VBType & VB_SIS301LV) {\r\nif (pVBInfo->SetFlag & RPLLDIV2XO)\r\nVCLKIndex = YPbPr525iVCLK_2;\r\nelse\r\nVCLKIndex = YPbPr525iVCLK;\r\n}\r\n} else if (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (pVBInfo->SetFlag & RPLLDIV2XO)\r\nVCLKIndex = TVCLKBASE_315_25 + TVVCLKDIV2;\r\nelse\r\nVCLKIndex = TVCLKBASE_315_25 + TVVCLK;\r\n} else {\r\nVCLKIndex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK;\r\nVCLKIndex &= IndexMask;\r\n}\r\nreturn VCLKIndex;\r\n}\r\nstatic void XGI_SetCRT1VCLK(unsigned short ModeIdIndex,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char index, data;\r\nunsigned short vclkindex;\r\nif ((pVBInfo->IF_DEF_LVDS == 0) &&\r\n(pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV |\r\nVB_SIS302LV | VB_XGI301C)) &&\r\n(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)) {\r\nvclkindex = XGI_GetVCLK2Ptr(ModeIdIndex, RefreshRateTableIndex,\r\npVBInfo);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x31) & 0xCF;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x31, data);\r\ndata = XGI_VBVCLKData[vclkindex].Part4_A;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, data);\r\ndata = XGI_VBVCLKData[vclkindex].Part4_B;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, data);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2D, 0x01);\r\n} else {\r\nindex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK;\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x31) & 0xCF;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x31, data);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, XGI_VCLKData[index].SR2B);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, XGI_VCLKData[index].SR2C);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2D, 0x01);\r\n}\r\nif (HwDeviceExtension->jChipType >= XG20) {\r\nif (XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag &\r\nHalfDCLK) {\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x2B);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, data);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x2C);\r\nindex = data;\r\nindex &= 0xE0;\r\ndata &= 0x1F;\r\ndata <<= 1;\r\ndata += 1;\r\ndata |= index;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, data);\r\n}\r\n}\r\n}\r\nstatic void XGI_SetXG21FPBits(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char temp;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\ntemp = (temp & 1) << 6;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x06, ~0x40, temp);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x09, ~0xc0, temp | 0x80);\r\n}\r\nstatic void XGI_SetCRT1FIFO(struct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data;\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x3D);\r\ndata &= 0xfe;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x3D, data);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x08, 0x34);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x09);\r\ndata &= 0xC0;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x09, data | 0x30);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x3D);\r\ndata |= 0x01;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x3D, data);\r\nif (HwDeviceExtension->jChipType == XG21)\r\nXGI_SetXG21FPBits(pVBInfo);\r\n}\r\nstatic void XGI_SetVCLKState(struct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data, data2 = 0;\r\nshort VCLK;\r\nunsigned char index;\r\nindex = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK;\r\nindex &= IndexMask;\r\nVCLK = XGI_VCLKData[index].CLOCK;\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x32);\r\ndata &= 0xf3;\r\nif (VCLK >= 200)\r\ndata |= 0x0c;\r\nif (HwDeviceExtension->jChipType >= XG20)\r\ndata &= ~0x04;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x32, data);\r\nif (HwDeviceExtension->jChipType < XG20) {\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x1F);\r\ndata &= 0xE7;\r\nif (VCLK < 200)\r\ndata |= 0x10;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x1F, data);\r\n}\r\ndata2 = 0x00;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x07, 0xFC, data2);\r\nif (HwDeviceExtension->jChipType >= XG27)\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x40, 0xFC, data2 & 0x03);\r\n}\r\nstatic void XGI_SetCRT1ModeRegs(struct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data, data2, data3, infoflag = 0, modeflag, resindex,\r\nxres;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ninfoflag = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\nif (xgifb_reg_get(pVBInfo->P3d4, 0x31) & 0x01)\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x1F, 0x3F, 0x00);\r\ndata = infoflag;\r\ndata2 = 0;\r\ndata2 |= 0x02;\r\ndata3 = pVBInfo->ModeType - ModeVGA;\r\ndata3 <<= 2;\r\ndata2 |= data3;\r\ndata &= InterlaceMode;\r\nif (data)\r\ndata2 |= 0x20;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x06, ~0x3F, data2);\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nxres = XGI330_ModeResInfo[resindex].HTotal;\r\ndata = 0x0000;\r\nif (infoflag & InterlaceMode) {\r\nif (xres == 1024)\r\ndata = 0x0035;\r\nelse if (xres == 1280)\r\ndata = 0x0048;\r\n}\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x19, 0xFF, data);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x19, 0xFC, 0);\r\nif (modeflag & HalfDCLK)\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x01, 0xF7, 0x08);\r\ndata2 = 0;\r\nif (modeflag & LineCompareOff)\r\ndata2 |= 0x08;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0F, ~0x48, data2);\r\ndata = 0x60;\r\ndata = data ^ 0x60;\r\ndata = data ^ 0xA0;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x21, 0x1F, data);\r\nXGI_SetVCLKState(HwDeviceExtension, RefreshRateTableIndex, pVBInfo);\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x31);\r\nif (HwDeviceExtension->jChipType == XG27) {\r\nif (data & 0x40)\r\ndata = 0x2c;\r\nelse\r\ndata = 0x6c;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x52, data);\r\nxgifb_reg_or(pVBInfo->P3d4, 0x51, 0x10);\r\n} else if (HwDeviceExtension->jChipType >= XG20) {\r\nif (data & 0x40)\r\ndata = 0x33;\r\nelse\r\ndata = 0x73;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x52, data);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x51, 0x02);\r\n} else {\r\nif (data & 0x40)\r\ndata = 0x2c;\r\nelse\r\ndata = 0x6c;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x52, data);\r\n}\r\n}\r\nstatic void XGI_WriteDAC(unsigned short dl,\r\nunsigned short ah,\r\nunsigned short al,\r\nunsigned short dh,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short bh, bl;\r\nbh = ah;\r\nbl = al;\r\nif (dl != 0) {\r\nswap(bh, dh);\r\nif (dl == 1)\r\nswap(bl, dh);\r\nelse\r\nswap(bl, bh);\r\n}\r\noutb((unsigned short) dh, pVBInfo->P3c9);\r\noutb((unsigned short) bh, pVBInfo->P3c9);\r\noutb((unsigned short) bl, pVBInfo->P3c9);\r\n}\r\nstatic void XGI_LoadDAC(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data, data2, i, k, m, n, o, si, di, bx, dl, al, ah, dh;\r\nconst unsigned short *table = XGINew_VGA_DAC;\r\noutb(0xFF, pVBInfo->P3c6);\r\noutb(0x00, pVBInfo->P3c8);\r\nfor (i = 0; i < 16; i++) {\r\ndata = table[i];\r\nfor (k = 0; k < 3; k++) {\r\ndata2 = 0;\r\nif (data & 0x01)\r\ndata2 = 0x2A;\r\nif (data & 0x02)\r\ndata2 += 0x15;\r\noutb(data2, pVBInfo->P3c9);\r\ndata >>= 2;\r\n}\r\n}\r\nfor (i = 16; i < 32; i++) {\r\ndata = table[i];\r\nfor (k = 0; k < 3; k++)\r\noutb(data, pVBInfo->P3c9);\r\n}\r\nsi = 32;\r\nfor (m = 0; m < 9; m++) {\r\ndi = si;\r\nbx = si + 0x04;\r\ndl = 0;\r\nfor (n = 0; n < 3; n++) {\r\nfor (o = 0; o < 5; o++) {\r\ndh = table[si];\r\nah = table[di];\r\nal = table[bx];\r\nsi++;\r\nXGI_WriteDAC(dl, ah, al, dh, pVBInfo);\r\n}\r\nsi -= 2;\r\nfor (o = 0; o < 3; o++) {\r\ndh = table[bx];\r\nah = table[di];\r\nal = table[si];\r\nsi--;\r\nXGI_WriteDAC(dl, ah, al, dh, pVBInfo);\r\n}\r\ndl++;\r\n}\r\nsi += 5;\r\n}\r\n}\r\nstatic void XGI_GetLVDSResInfo(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short resindex, xres, yres, modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nxres = XGI330_ModeResInfo[resindex].HTotal;\r\nyres = XGI330_ModeResInfo[resindex].VTotal;\r\nif (modeflag & HalfDCLK)\r\nxres <<= 1;\r\nif (modeflag & DoubleScanMode)\r\nyres <<= 1;\r\nif (xres == 720)\r\nxres = 640;\r\npVBInfo->VGAHDE = xres;\r\npVBInfo->HDE = xres;\r\npVBInfo->VGAVDE = yres;\r\npVBInfo->VDE = yres;\r\n}\r\nstatic void const *XGI_GetLcdPtr(struct XGI330_LCDDataTablStruct const *table,\r\nunsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i, tempdx, tempbx, modeflag;\r\ntempbx = 0;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ni = 0;\r\nwhile (table[i].PANELID != 0xff) {\r\ntempdx = pVBInfo->LCDResInfo;\r\nif (tempbx & 0x0080) {\r\ntempbx &= (~0x0080);\r\ntempdx = pVBInfo->LCDTypeInfo;\r\n}\r\nif (pVBInfo->LCDInfo & EnableScalingLCD)\r\ntempdx &= (~PanelResInfo);\r\nif (table[i].PANELID == tempdx) {\r\ntempbx = table[i].MASK;\r\ntempdx = pVBInfo->LCDInfo;\r\nif (modeflag & HalfDCLK)\r\ntempdx |= SetLCDLowResolution;\r\ntempbx &= tempdx;\r\nif (tempbx == table[i].CAP)\r\nbreak;\r\n}\r\ni++;\r\n}\r\nreturn table[i].DATAPTR;\r\n}\r\nstatic struct SiS_TVData const *XGI_GetTVPtr(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i, tempdx, tempal, modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ntempal = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\ntempal = tempal & 0x3f;\r\ntempdx = pVBInfo->TVInfo;\r\nif (pVBInfo->VBInfo & SetInSlaveMode)\r\ntempdx = tempdx | SetTVLockMode;\r\nif (modeflag & HalfDCLK)\r\ntempdx = tempdx | SetTVLowResolution;\r\ni = 0;\r\nwhile (XGI_TVDataTable[i].MASK != 0xffff) {\r\nif ((tempdx & XGI_TVDataTable[i].MASK) ==\r\nXGI_TVDataTable[i].CAP)\r\nbreak;\r\ni++;\r\n}\r\nreturn &XGI_TVDataTable[i].DATAPTR[tempal];\r\n}\r\nstatic void XGI_GetLVDSData(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nstruct SiS_LVDSData const *LCDPtr;\r\nif (!(pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)))\r\nreturn;\r\nLCDPtr = XGI_GetLcdPtr(XGI_EPLLCDDataPtr, ModeIdIndex, pVBInfo);\r\npVBInfo->VGAHT = LCDPtr->VGAHT;\r\npVBInfo->VGAVT = LCDPtr->VGAVT;\r\npVBInfo->HT = LCDPtr->LCDHT;\r\npVBInfo->VT = LCDPtr->LCDVT;\r\nif (pVBInfo->LCDInfo & (SetLCDtoNonExpanding | EnableScalingLCD))\r\nreturn;\r\nif ((pVBInfo->LCDResInfo == Panel_1024x768) ||\r\n(pVBInfo->LCDResInfo == Panel_1024x768x75)) {\r\npVBInfo->HDE = 1024;\r\npVBInfo->VDE = 768;\r\n} else if ((pVBInfo->LCDResInfo == Panel_1280x1024) ||\r\n(pVBInfo->LCDResInfo == Panel_1280x1024x75)) {\r\npVBInfo->HDE = 1280;\r\npVBInfo->VDE = 1024;\r\n} else if (pVBInfo->LCDResInfo == Panel_1400x1050) {\r\npVBInfo->HDE = 1400;\r\npVBInfo->VDE = 1050;\r\n} else {\r\npVBInfo->HDE = 1600;\r\npVBInfo->VDE = 1200;\r\n}\r\n}\r\nstatic void XGI_ModCRT1Regs(unsigned short ModeIdIndex,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i;\r\nstruct XGI_LVDSCRT1HDataStruct const *LCDPtr = NULL;\r\nstruct XGI_LVDSCRT1VDataStruct const *LCDPtr1 = NULL;\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\nLCDPtr = XGI_GetLcdPtr(xgifb_epllcd_crt1_h, ModeIdIndex,\r\npVBInfo);\r\nfor (i = 0; i < 8; i++)\r\npVBInfo->TimingH.data[i] = LCDPtr[0].Reg[i];\r\n}\r\nXGI_SetCRT1Timing_H(pVBInfo, HwDeviceExtension);\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\nLCDPtr1 = XGI_GetLcdPtr(xgifb_epllcd_crt1_v, ModeIdIndex,\r\npVBInfo);\r\nfor (i = 0; i < 7; i++)\r\npVBInfo->TimingV.data[i] = LCDPtr1[0].Reg[i];\r\n}\r\nXGI_SetCRT1Timing_V(ModeIdIndex, pVBInfo);\r\n}\r\nstatic unsigned short XGI_GetLCDCapPtr(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char tempal, tempah, tempbl, i;\r\ntempah = xgifb_reg_get(pVBInfo->P3d4, 0x36);\r\ntempal = tempah & 0x0F;\r\ntempah = tempah & 0xF0;\r\ni = 0;\r\ntempbl = pVBInfo->LCDCapList[i].LCD_ID;\r\nwhile (tempbl != 0xFF) {\r\nif (tempbl & 0x80) {\r\ntempal = tempah;\r\ntempbl = tempbl & ~(0x80);\r\n}\r\nif (tempal == tempbl)\r\nbreak;\r\ni++;\r\ntempbl = pVBInfo->LCDCapList[i].LCD_ID;\r\n}\r\nreturn i;\r\n}\r\nstatic unsigned short XGI_GetLCDCapPtr1(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempah, tempal, tempbl, i;\r\ntempal = pVBInfo->LCDResInfo;\r\ntempah = pVBInfo->LCDTypeInfo;\r\ni = 0;\r\ntempbl = pVBInfo->LCDCapList[i].LCD_ID;\r\nwhile (tempbl != 0xFF) {\r\nif ((tempbl & 0x80) && (tempbl != 0x80)) {\r\ntempal = tempah;\r\ntempbl &= ~0x80;\r\n}\r\nif (tempal == tempbl)\r\nbreak;\r\ni++;\r\ntempbl = pVBInfo->LCDCapList[i].LCD_ID;\r\n}\r\nif (tempbl == 0xFF) {\r\npVBInfo->LCDResInfo = Panel_1024x768;\r\npVBInfo->LCDTypeInfo = 0;\r\ni = 0;\r\n}\r\nreturn i;\r\n}\r\nstatic void XGI_GetLCDSync(unsigned short *HSyncWidth,\r\nunsigned short *VSyncWidth,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short Index;\r\nIndex = XGI_GetLCDCapPtr(pVBInfo);\r\n*HSyncWidth = pVBInfo->LCDCapList[Index].LCD_HSyncWidth;\r\n*VSyncWidth = pVBInfo->LCDCapList[Index].LCD_VSyncWidth;\r\n}\r\nstatic void XGI_SetLVDSRegs(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx, tempax, tempcx, tempdx, push1, push2, modeflag;\r\nunsigned long temp, temp1, temp2, temp3, push3;\r\nstruct XGI330_LCDDataDesStruct2 const *LCDPtr1 = NULL;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nLCDPtr1 = XGI_GetLcdPtr(XGI_EPLLCDDesDataPtr, ModeIdIndex, pVBInfo);\r\nXGI_GetLCDSync(&tempax, &tempbx, pVBInfo);\r\npush1 = tempbx;\r\npush2 = tempax;\r\nif ((pVBInfo->LCDResInfo == Panel_1024x768) ||\r\n(pVBInfo->LCDResInfo == Panel_1024x768x75)) {\r\ntempax = 1024;\r\ntempbx = 768;\r\n} else if ((pVBInfo->LCDResInfo == Panel_1280x1024) ||\r\n(pVBInfo->LCDResInfo == Panel_1280x1024x75)) {\r\ntempax = 1280;\r\ntempbx = 1024;\r\n} else if (pVBInfo->LCDResInfo == Panel_1400x1050) {\r\ntempax = 1400;\r\ntempbx = 1050;\r\n} else {\r\ntempax = 1600;\r\ntempbx = 1200;\r\n}\r\nif (pVBInfo->LCDInfo & SetLCDtoNonExpanding) {\r\npVBInfo->HDE = tempax;\r\npVBInfo->VDE = tempbx;\r\npVBInfo->VGAHDE = tempax;\r\npVBInfo->VGAVDE = tempbx;\r\n}\r\ntempax = pVBInfo->HT;\r\ntempbx = LCDPtr1->LCDHDES;\r\ntempcx = pVBInfo->HDE;\r\ntempbx = tempbx & 0x0fff;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1A, tempbx & 0x07);\r\ntempcx >>= 3;\r\ntempbx >>= 3;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x16,\r\n(unsigned short) (tempbx & 0xff));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x17,\r\n(unsigned short) (tempcx & 0xff));\r\ntempax = pVBInfo->HT;\r\ntempbx = LCDPtr1->LCDHRS;\r\ntempcx = push2;\r\nif (pVBInfo->LCDInfo & EnableScalingLCD)\r\ntempcx = LCDPtr1->LCDHSync;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\ntempax = tempbx & 0x07;\r\ntempax >>= 5;\r\ntempcx >>= 3;\r\ntempbx >>= 3;\r\ntempcx &= 0x1f;\r\ntempax |= tempcx;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x15, tempax);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x14,\r\n(unsigned short) (tempbx & 0xff));\r\ntempax = pVBInfo->VT;\r\ntempbx = LCDPtr1->LCDVDES;\r\ntempcx = pVBInfo->VDE;\r\ntempbx = tempbx & 0x0fff;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1b,\r\n(unsigned short) (tempbx & 0xff));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1c,\r\n(unsigned short) (tempcx & 0xff));\r\ntempbx = (tempbx >> 8) & 0x07;\r\ntempcx = (tempcx >> 8) & 0x07;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1d,\r\n(unsigned short) ((tempcx << 3)\r\n| tempbx));\r\ntempax = pVBInfo->VT;\r\ntempbx = LCDPtr1->LCDVRS;\r\ntempcx = push1;\r\nif (pVBInfo->LCDInfo & EnableScalingLCD)\r\ntempcx = LCDPtr1->LCDVSync;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x18,\r\n(unsigned short) (tempbx & 0xff));\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x19, ~0x0f,\r\n(unsigned short) (tempcx & 0x0f));\r\ntempax = ((tempbx >> 8) & 0x07) << 3;\r\ntempbx = pVBInfo->VGAVDE;\r\nif (tempbx != pVBInfo->VDE)\r\ntempax |= 0x40;\r\nif (pVBInfo->LCDInfo & XGI_EnableLVDSDDA)\r\ntempax |= 0x40;\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x1a, 0x07,\r\ntempax);\r\ntempbx = pVBInfo->VDE;\r\ntempax = pVBInfo->VGAVDE;\r\ntemp = tempax;\r\ntemp1 = (temp << 18) / tempbx;\r\ntempdx = (unsigned short) ((temp << 18) % tempbx);\r\nif (tempdx != 0)\r\ntemp1 += 1;\r\ntemp2 = temp1;\r\npush3 = temp2;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x37,\r\n(unsigned short) (temp2 & 0xff));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x36,\r\n(unsigned short) ((temp2 >> 8) & 0xff));\r\ntempbx = (unsigned short) (temp2 >> 16);\r\ntempax = tempbx & 0x03;\r\ntempbx = pVBInfo->VGAVDE;\r\nif (tempbx == pVBInfo->VDE)\r\ntempax |= 0x04;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x35, tempax);\r\nif (pVBInfo->VBType & VB_XGI301C) {\r\ntemp2 = push3;\r\nxgifb_reg_set(pVBInfo->Part4Port,\r\n0x3c,\r\n(unsigned short) (temp2 & 0xff));\r\nxgifb_reg_set(pVBInfo->Part4Port,\r\n0x3b,\r\n(unsigned short) ((temp2 >> 8) &\r\n0xff));\r\ntempbx = (unsigned short) (temp2 >> 16);\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x3a,\r\n~0xc0,\r\n(unsigned short) ((tempbx &\r\n0xff) << 6));\r\ntempcx = pVBInfo->VGAVDE;\r\nif (tempcx == pVBInfo->VDE)\r\nxgifb_reg_and_or(pVBInfo->Part4Port,\r\n0x30, ~0x0c, 0x00);\r\nelse\r\nxgifb_reg_and_or(pVBInfo->Part4Port,\r\n0x30, ~0x0c, 0x08);\r\n}\r\ntempcx = pVBInfo->VGAHDE;\r\ntempbx = pVBInfo->HDE;\r\ntemp1 = tempcx << 16;\r\ntempax = (unsigned short) (temp1 / tempbx);\r\nif ((tempbx & 0xffff) == (tempcx & 0xffff))\r\ntempax = 65535;\r\ntemp3 = tempax;\r\ntemp1 = pVBInfo->VGAHDE << 16;\r\ntemp1 /= temp3;\r\ntemp3 <<= 16;\r\ntemp1 -= 1;\r\ntemp3 = (temp3 & 0xffff0000) + (temp1 & 0xffff);\r\ntempax = (unsigned short) (temp3 & 0xff);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1f, tempax);\r\ntemp1 = pVBInfo->VGAVDE << 18;\r\ntemp1 = temp1 / push3;\r\ntempbx = (unsigned short) (temp1 & 0xffff);\r\nif (pVBInfo->LCDResInfo == Panel_1024x768)\r\ntempbx -= 1;\r\ntempax = ((tempbx >> 8) & 0xff) << 3;\r\ntempax |= (unsigned short) ((temp3 >> 8) & 0x07);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x20,\r\n(unsigned short) (tempax & 0xff));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x21,\r\n(unsigned short) (tempbx & 0xff));\r\ntemp3 >>= 16;\r\nif (modeflag & HalfDCLK)\r\ntemp3 >>= 1;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x22,\r\n(unsigned short) ((temp3 >> 8) & 0xff));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x23,\r\n(unsigned short) (temp3 & 0xff));\r\n}\r\nstatic void XGI_GetLCDVCLKPtr(unsigned char *di_0, unsigned char *di_1,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short index;\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\nindex = XGI_GetLCDCapPtr1(pVBInfo);\r\nif (pVBInfo->VBInfo & SetCRT2ToLCD) {\r\n*di_0 = pVBInfo->LCDCapList[index].LCUCHAR_VCLKData1;\r\n*di_1 = pVBInfo->LCDCapList[index].LCUCHAR_VCLKData2;\r\n} else {\r\n*di_0 = pVBInfo->LCDCapList[index].LCDA_VCLKData1;\r\n*di_1 = pVBInfo->LCDCapList[index].LCDA_VCLKData2;\r\n}\r\n}\r\n}\r\nstatic unsigned char XGI_GetVCLKPtr(unsigned short RefreshRateTableIndex,\r\nunsigned short ModeIdIndex, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short index, modeflag;\r\nunsigned char tempal;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif ((pVBInfo->SetFlag & ProgrammingCRT2) &&\r\n(!(pVBInfo->LCDInfo & EnableScalingLCD))) {\r\nindex = XGI_GetLCDCapPtr(pVBInfo);\r\ntempal = pVBInfo->LCDCapList[index].LCD_VCLK;\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA))\r\nreturn tempal;\r\nif (pVBInfo->VBType &\r\n(VB_SIS301B |\r\nVB_SIS302B |\r\nVB_SIS301LV |\r\nVB_SIS302LV |\r\nVB_XGI301C)) {\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\ntempal = TVCLKBASE_315 + HiTVVCLKDIV2;\r\nif (!(pVBInfo->TVInfo & RPLLDIV2XO))\r\ntempal = TVCLKBASE_315 + HiTVVCLK;\r\nif (pVBInfo->TVInfo & TVSimuMode) {\r\ntempal = TVCLKBASE_315 + HiTVSimuVCLK;\r\nif (!(modeflag & Charx8Dot))\r\ntempal = TVCLKBASE_315 +\r\nHiTVTextVCLK;\r\n}\r\nreturn tempal;\r\n}\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p) {\r\ntempal = XGI_YPbPr750pVCLK;\r\nreturn tempal;\r\n}\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p) {\r\ntempal = YPbPr525pVCLK;\r\nreturn tempal;\r\n}\r\ntempal = NTSC1024VCLK;\r\nif (!(pVBInfo->TVInfo & NTSC1024x768)) {\r\ntempal = TVCLKBASE_315 + TVVCLKDIV2;\r\nif (!(pVBInfo->TVInfo & RPLLDIV2XO))\r\ntempal = TVCLKBASE_315 + TVVCLK;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToTV)\r\nreturn tempal;\r\n}\r\n}\r\ninb((pVBInfo->P3ca + 0x02));\r\ntempal = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK;\r\nreturn tempal;\r\n}\r\nstatic void XGI_GetVCLKLen(unsigned char tempal, unsigned char *di_0,\r\nunsigned char *di_1, struct vb_device_info *pVBInfo)\r\n{\r\nif (pVBInfo->VBType & (VB_SIS301 | VB_SIS301B | VB_SIS302B\r\n| VB_SIS301LV | VB_SIS302LV | VB_XGI301C)) {\r\nif ((!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)) &&\r\n(pVBInfo->SetFlag & ProgrammingCRT2)) {\r\n*di_0 = XGI_VBVCLKData[tempal].Part4_A;\r\n*di_1 = XGI_VBVCLKData[tempal].Part4_B;\r\n}\r\n} else {\r\n*di_0 = XGI_VCLKData[tempal].SR2B;\r\n*di_1 = XGI_VCLKData[tempal].SR2C;\r\n}\r\n}\r\nstatic void XGI_SetCRT2ECLK(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char di_0, di_1, tempal;\r\nint i;\r\ntempal = XGI_GetVCLKPtr(RefreshRateTableIndex, ModeIdIndex, pVBInfo);\r\nXGI_GetVCLKLen(tempal, &di_0, &di_1, pVBInfo);\r\nXGI_GetLCDVCLKPtr(&di_0, &di_1, pVBInfo);\r\nfor (i = 0; i < 4; i++) {\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x31, ~0x30,\r\n(unsigned short) (0x10 * i));\r\nif ((!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA))\r\n&& (!(pVBInfo->VBInfo & SetInSlaveMode))) {\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2e, di_0);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2f, di_1);\r\n} else {\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2b, di_0);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2c, di_1);\r\n}\r\n}\r\n}\r\nstatic void XGI_UpdateModeInfo(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempcl, tempch, temp, tempbl, tempax;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempcl = 0;\r\ntempch = 0;\r\ntemp = xgifb_reg_get(pVBInfo->P3c4, 0x01);\r\nif (!(temp & 0x20)) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x17);\r\nif (temp & 0x80) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x53);\r\nif (!(temp & 0x40))\r\ntempcl |= ActiveCRT1;\r\n}\r\n}\r\ntemp = xgifb_reg_get(pVBInfo->Part1Port, 0x2e);\r\ntemp &= 0x0f;\r\nif (!(temp == 0x08)) {\r\ntempax = xgifb_reg_get(pVBInfo->Part1Port, 0x13);\r\nif (tempax & 0x04)\r\ntempcl = tempcl | ActiveLCD;\r\ntemp &= 0x05;\r\nif (!(tempcl & ActiveLCD))\r\nif (temp == 0x01)\r\ntempcl |= ActiveCRT2;\r\nif (temp == 0x04)\r\ntempcl |= ActiveLCD;\r\nif (temp == 0x05) {\r\ntemp = xgifb_reg_get(pVBInfo->Part2Port, 0x00);\r\nif (!(temp & 0x08))\r\ntempch |= ActiveAVideo;\r\nif (!(temp & 0x04))\r\ntempch |= ActiveSVideo;\r\nif (temp & 0x02)\r\ntempch |= ActiveSCART;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (temp & 0x01)\r\ntempch |= ActiveHiTV;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\ntemp = xgifb_reg_get(\r\npVBInfo->Part2Port,\r\n0x4d);\r\nif (temp & 0x10)\r\ntempch |= ActiveYPbPr;\r\n}\r\nif (tempch != 0)\r\ntempcl |= ActiveTV;\r\n}\r\n}\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x3d);\r\nif (tempcl & ActiveLCD) {\r\nif ((pVBInfo->SetFlag & ReserveTVOption)) {\r\nif (temp & ActiveTV)\r\ntempcl |= ActiveTV;\r\n}\r\n}\r\ntemp = tempcl;\r\ntempbl = ~XGI_ModeSwitchStatus;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x3d, tempbl, temp);\r\nif (!(pVBInfo->SetFlag & ReserveTVOption))\r\nxgifb_reg_set(pVBInfo->P3d4, 0x3e, tempch);\r\n}\r\n}\r\nvoid XGI_GetVBType(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short flag, tempbx, tempah;\r\ntempbx = VB_SIS302B;\r\nflag = xgifb_reg_get(pVBInfo->Part4Port, 0x00);\r\nif (flag == 0x02)\r\ngoto finish;\r\ntempbx = VB_SIS301;\r\nflag = xgifb_reg_get(pVBInfo->Part4Port, 0x01);\r\nif (flag < 0xB0)\r\ngoto finish;\r\ntempbx = VB_SIS301B;\r\nif (flag < 0xC0)\r\ngoto bigger_than_0xB0;\r\ntempbx = VB_XGI301C;\r\nif (flag < 0xD0)\r\ngoto bigger_than_0xB0;\r\ntempbx = VB_SIS301LV;\r\nif (flag < 0xE0)\r\ngoto bigger_than_0xB0;\r\ntempbx = VB_SIS302LV;\r\ntempah = xgifb_reg_get(pVBInfo->Part4Port, 0x39);\r\nif (tempah != 0xFF)\r\ntempbx = VB_XGI301C;\r\nbigger_than_0xB0:\r\nif (tempbx & (VB_SIS301B | VB_SIS302B)) {\r\nflag = xgifb_reg_get(pVBInfo->Part4Port, 0x23);\r\nif (!(flag & 0x02))\r\ntempbx = tempbx | VB_NoLCD;\r\n}\r\nfinish:\r\npVBInfo->VBType = tempbx;\r\n}\r\nstatic void XGI_GetVBInfo(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax, push, tempbx, temp, modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\npVBInfo->SetFlag = 0;\r\npVBInfo->ModeType = modeflag & ModeTypeMask;\r\ntempbx = 0;\r\nif (!(pVBInfo->VBType & 0xFFFF))\r\nreturn;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x30);\r\ntempbx = tempbx | temp;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x31);\r\npush = temp;\r\npush <<= 8;\r\ntempax = temp << 8;\r\ntempbx = tempbx | tempax;\r\ntemp = (SetCRT2ToDualEdge | SetCRT2ToYPbPr525750 | XGI_SetCRT2ToLCDA\r\n| SetInSlaveMode | DisableCRT2Display);\r\ntemp = 0xFFFF ^ temp;\r\ntempbx &= temp;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x38);\r\nif (pVBInfo->VBType & (VB_SIS302B | VB_SIS301LV | VB_SIS302LV |\r\nVB_XGI301C)) {\r\nif (temp & EnableDualEdge) {\r\ntempbx |= SetCRT2ToDualEdge;\r\nif (temp & SetToLCDA)\r\ntempbx |= XGI_SetCRT2ToLCDA;\r\n}\r\n}\r\nif (pVBInfo->VBType & (VB_SIS301LV|VB_SIS302LV|VB_XGI301C)) {\r\nif (temp & SetYPbPr) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x35);\r\ntemp &= YPbPrMode;\r\ntempbx |= SetCRT2ToHiVision;\r\nif (temp != YPbPrMode1080i) {\r\ntempbx &= (~SetCRT2ToHiVision);\r\ntempbx |= SetCRT2ToYPbPr525750;\r\n}\r\n}\r\n}\r\ntempax = push;\r\ntemp = 0x09FC;\r\nif (!(tempbx & temp)) {\r\ntempax |= DisableCRT2Display;\r\ntempbx = 0;\r\n}\r\nif (!(pVBInfo->VBType & VB_NoLCD)) {\r\nif (tempbx & XGI_SetCRT2ToLCDA) {\r\nif (tempbx & SetSimuScanMode)\r\ntempbx &= (~(SetCRT2ToLCD | SetCRT2ToRAMDAC |\r\nSwitchCRT2));\r\nelse\r\ntempbx &= (~(SetCRT2ToLCD | SetCRT2ToRAMDAC |\r\nSetCRT2ToTV | SwitchCRT2));\r\n}\r\n}\r\nif (!(tempbx & (SwitchCRT2 | SetSimuScanMode))) {\r\nif (tempbx & SetCRT2ToRAMDAC) {\r\ntempbx &= (0xFF00 | SetCRT2ToRAMDAC |\r\nSwitchCRT2 | SetSimuScanMode);\r\ntempbx &= (0x00FF | (~SetCRT2ToYPbPr525750));\r\n}\r\n}\r\nif (!(pVBInfo->VBType & VB_NoLCD)) {\r\nif (tempbx & SetCRT2ToLCD) {\r\ntempbx &= (0xFF00 | SetCRT2ToLCD | SwitchCRT2 |\r\nSetSimuScanMode);\r\ntempbx &= (0x00FF | (~SetCRT2ToYPbPr525750));\r\n}\r\n}\r\nif (tempbx & SetCRT2ToSCART) {\r\ntempbx &= (0xFF00 | SetCRT2ToSCART | SwitchCRT2 |\r\nSetSimuScanMode);\r\ntempbx &= (0x00FF | (~SetCRT2ToYPbPr525750));\r\n}\r\nif (tempbx & SetCRT2ToYPbPr525750)\r\ntempbx &= (0xFF00 | SwitchCRT2 | SetSimuScanMode);\r\nif (tempbx & SetCRT2ToHiVision)\r\ntempbx &= (0xFF00 | SetCRT2ToHiVision | SwitchCRT2 |\r\nSetSimuScanMode);\r\nif (tempax & DisableCRT2Display) {\r\nif (!(tempbx & (SwitchCRT2 | SetSimuScanMode)))\r\ntempbx = DisableCRT2Display;\r\n}\r\nif (!(tempbx & DisableCRT2Display)) {\r\nif ((!(tempbx & DriverMode)) || (!(modeflag & CRT2Mode))) {\r\nif (!(tempbx & XGI_SetCRT2ToLCDA))\r\ntempbx |= (SetInSlaveMode | SetSimuScanMode);\r\n}\r\nif ((tempbx & SetInSlaveMode) && (tempbx & XGI_SetCRT2ToLCDA)) {\r\ntempbx ^= (SetCRT2ToLCD | XGI_SetCRT2ToLCDA |\r\nSetCRT2ToDualEdge);\r\npVBInfo->SetFlag |= ReserveTVOption;\r\n}\r\n}\r\npVBInfo->VBInfo = tempbx;\r\n}\r\nstatic void XGI_GetTVInfo(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx = 0, resinfo = 0, modeflag, index1;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\ntempbx = xgifb_reg_get(pVBInfo->P3d4, 0x35);\r\nif (tempbx & TVSetPAL) {\r\ntempbx &= (SetCHTVOverScan |\r\nTVSetPALM |\r\nTVSetPALN |\r\nTVSetPAL);\r\nif (tempbx & TVSetPALM)\r\ntempbx &= ~TVSetPAL;\r\n} else\r\ntempbx &= (SetCHTVOverScan |\r\nTVSetNTSCJ |\r\nTVSetPAL);\r\nif (pVBInfo->VBInfo & SetCRT2ToSCART)\r\ntempbx |= TVSetPAL;\r\nif (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\nindex1 = xgifb_reg_get(pVBInfo->P3d4, 0x35);\r\nindex1 &= YPbPrMode;\r\nif (index1 == YPbPrMode525i)\r\ntempbx |= TVSetYPbPr525i;\r\nif (index1 == YPbPrMode525p)\r\ntempbx = tempbx | TVSetYPbPr525p;\r\nif (index1 == YPbPrMode750p)\r\ntempbx = tempbx | TVSetYPbPr750p;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision)\r\ntempbx = tempbx | TVSetHiVision | TVSetPAL;\r\nif ((pVBInfo->VBInfo & SetInSlaveMode) &&\r\n(!(pVBInfo->VBInfo & SetNotSimuMode)))\r\ntempbx |= TVSimuMode;\r\nif (!(tempbx & TVSetPAL) && (modeflag > 13) && (resinfo == 8))\r\ntempbx |= NTSC1024x768;\r\ntempbx |= RPLLDIV2XO;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (pVBInfo->VBInfo & SetInSlaveMode)\r\ntempbx &= (~RPLLDIV2XO);\r\n} else if (tempbx & (TVSetYPbPr525p | TVSetYPbPr750p)) {\r\ntempbx &= (~RPLLDIV2XO);\r\n} else if (!(pVBInfo->VBType & (VB_SIS301B | VB_SIS302B |\r\nVB_SIS301LV | VB_SIS302LV |\r\nVB_XGI301C))) {\r\nif (tempbx & TVSimuMode)\r\ntempbx &= (~RPLLDIV2XO);\r\n}\r\n}\r\npVBInfo->TVInfo = tempbx;\r\n}\r\nstatic unsigned char XGI_GetLCDInfo(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp, tempax, tempbx, resinfo = 0, LCDIdIndex;\r\npVBInfo->LCDResInfo = 0;\r\npVBInfo->LCDTypeInfo = 0;\r\npVBInfo->LCDInfo = 0;\r\nresinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x36);\r\ntempbx = temp & 0x0F;\r\nif (tempbx == 0)\r\ntempbx = Panel_1024x768;\r\nif ((tempbx == Panel_1024x768) || (tempbx == Panel_1280x1024)) {\r\nif (pVBInfo->VBInfo & DriverMode) {\r\ntempax = xgifb_reg_get(pVBInfo->P3d4, 0x33);\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)\r\ntempax &= 0x0F;\r\nelse\r\ntempax >>= 4;\r\nif ((resinfo == 6) || (resinfo == 9)) {\r\nif (tempax >= 3)\r\ntempbx |= PanelRef75Hz;\r\n} else if ((resinfo == 7) || (resinfo == 8)) {\r\nif (tempax >= 4)\r\ntempbx |= PanelRef75Hz;\r\n}\r\n}\r\n}\r\npVBInfo->LCDResInfo = tempbx;\r\nif (!(pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)))\r\nreturn 0;\r\ntempbx = 0;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\ntemp &= (ScalingLCD | LCDNonExpanding | LCDSyncBit | SetPWDEnable);\r\ntempbx |= temp;\r\nLCDIdIndex = XGI_GetLCDCapPtr1(pVBInfo);\r\ntempax = pVBInfo->LCDCapList[LCDIdIndex].LCD_Capability;\r\nif (((pVBInfo->VBType & VB_SIS302LV) ||\r\n(pVBInfo->VBType & VB_XGI301C)) && (tempax & XGI_LCDDualLink))\r\ntempbx |= SetLCDDualLink;\r\nif ((pVBInfo->LCDResInfo == Panel_1400x1050) &&\r\n(pVBInfo->VBInfo & SetCRT2ToLCD) && (resinfo == 9) &&\r\n(!(tempbx & EnableScalingLCD)))\r\ntempbx |= SetLCDtoNonExpanding;\r\nif (pVBInfo->VBInfo & SetInSlaveMode) {\r\nif (pVBInfo->VBInfo & SetNotSimuMode)\r\ntempbx |= XGI_LCDVESATiming;\r\n} else {\r\ntempbx |= XGI_LCDVESATiming;\r\n}\r\npVBInfo->LCDInfo = tempbx;\r\nreturn 1;\r\n}\r\nunsigned char XGI_SearchModeID(unsigned short ModeNo,\r\nunsigned short *ModeIdIndex)\r\n{\r\nfor (*ModeIdIndex = 0;; (*ModeIdIndex)++) {\r\nif (XGI330_EModeIDTable[*ModeIdIndex].Ext_ModeID == ModeNo)\r\nbreak;\r\nif (XGI330_EModeIDTable[*ModeIdIndex].Ext_ModeID == 0xFF)\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic unsigned char XG21GPIODataTransfer(unsigned char ujDate)\r\n{\r\nunsigned char ujRet = 0;\r\nunsigned char i = 0;\r\nfor (i = 0; i < 8; i++) {\r\nujRet <<= 1;\r\nujRet |= (ujDate >> i) & 1;\r\n}\r\nreturn ujRet;\r\n}\r\nstatic unsigned char XGI_XG21GetPSCValue(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR4A, temp;\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\nxgifb_reg_and(pVBInfo->P3d4, 0x4A, ~0x23);\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\ntemp = XG21GPIODataTransfer(temp);\r\ntemp &= 0x23;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4A, CR4A);\r\nreturn temp;\r\n}\r\nstatic unsigned char XGI_XG27GetPSCValue(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR4A, CRB4, temp;\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\nxgifb_reg_and(pVBInfo->P3d4, 0x4A, ~0x0C);\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\ntemp &= 0x0C;\r\ntemp >>= 2;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4A, CR4A);\r\nCRB4 = xgifb_reg_get(pVBInfo->P3d4, 0xB4);\r\ntemp |= ((CRB4 & 0x04) << 3);\r\nreturn temp;\r\n}\r\nstatic void XGI_XG21BLSignalVDD(unsigned short tempbh, unsigned short tempbl,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR4A, temp;\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\ntempbh &= 0x23;\r\ntempbl &= 0x23;\r\nxgifb_reg_and(pVBInfo->P3d4, 0x4A, ~tempbh);\r\nif (tempbh & 0x20) {\r\ntemp = (tempbl >> 4) & 0x02;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0xB4, ~0x02, temp);\r\n}\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\ntemp = XG21GPIODataTransfer(temp);\r\ntemp &= ~tempbh;\r\ntemp |= tempbl;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x48, temp);\r\n}\r\nstatic void XGI_XG27BLSignalVDD(unsigned short tempbh, unsigned short tempbl,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR4A, temp;\r\nunsigned short tempbh0, tempbl0;\r\ntempbh0 = tempbh;\r\ntempbl0 = tempbl;\r\ntempbh0 &= 0x20;\r\ntempbl0 &= 0x20;\r\ntempbh0 >>= 3;\r\ntempbl0 >>= 3;\r\nif (tempbh & 0x20) {\r\ntemp = (tempbl >> 4) & 0x02;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0xB4, ~0x02, temp);\r\n}\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0xB4, ~tempbh0, tempbl0);\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\ntempbh &= 0x03;\r\ntempbl &= 0x03;\r\ntempbh <<= 2;\r\ntempbl <<= 2;\r\nxgifb_reg_and(pVBInfo->P3d4, 0x4A, ~tempbh);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x48, ~tempbh, tempbl);\r\n}\r\nstatic void XGI_DisplayOn(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *pXGIHWDE,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x01, 0xDF, 0x00);\r\nif (pXGIHWDE->jChipType == XG21) {\r\nif (pVBInfo->IF_DEF_LVDS == 1) {\r\nif (!(XGI_XG21GetPSCValue(pVBInfo) & 0x1)) {\r\nXGI_XG21BLSignalVDD(0x01, 0x01, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S2);\r\n}\r\nif (!(XGI_XG21GetPSCValue(pVBInfo) & 0x20))\r\nXGI_XG21BLSignalVDD(0x20, 0x20, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S3);\r\nXGI_XG21BLSignalVDD(0x02, 0x02, pVBInfo);\r\n} else {\r\nXGI_XG21BLSignalVDD(0x20, 0x20, pVBInfo);\r\n}\r\n}\r\nif (pXGIHWDE->jChipType == XG27) {\r\nif (pVBInfo->IF_DEF_LVDS == 1) {\r\nif (!(XGI_XG27GetPSCValue(pVBInfo) & 0x1)) {\r\nXGI_XG27BLSignalVDD(0x01, 0x01, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S2);\r\n}\r\nif (!(XGI_XG27GetPSCValue(pVBInfo) & 0x20))\r\nXGI_XG27BLSignalVDD(0x20, 0x20, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S3);\r\nXGI_XG27BLSignalVDD(0x02, 0x02, pVBInfo);\r\n} else {\r\nXGI_XG27BLSignalVDD(0x20, 0x20, pVBInfo);\r\n}\r\n}\r\n}\r\nvoid XGI_DisplayOff(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *pXGIHWDE,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nif (pXGIHWDE->jChipType == XG21) {\r\nif (pVBInfo->IF_DEF_LVDS == 1) {\r\nXGI_XG21BLSignalVDD(0x02, 0x00, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S3);\r\n} else {\r\nXGI_XG21BLSignalVDD(0x20, 0x00, pVBInfo);\r\n}\r\n}\r\nif (pXGIHWDE->jChipType == XG27) {\r\nif ((XGI_XG27GetPSCValue(pVBInfo) & 0x2)) {\r\nXGI_XG27BLSignalVDD(0x02, 0x00, pVBInfo);\r\nmdelay(xgifb_info->lvds_data.PSC_S3);\r\n}\r\nif (pVBInfo->IF_DEF_LVDS == 0)\r\nXGI_XG27BLSignalVDD(0x20, 0x00, pVBInfo);\r\n}\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x01, 0xDF, 0x20);\r\n}\r\nstatic void XGI_WaitDisply(struct vb_device_info *pVBInfo)\r\n{\r\nwhile ((inb(pVBInfo->P3da) & 0x01))\r\nbreak;\r\nwhile (!(inb(pVBInfo->P3da) & 0x01))\r\nbreak;\r\n}\r\nstatic void XGI_AutoThreshold(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x01, 0x40);\r\n}\r\nstatic void XGI_SaveCRT2Info(unsigned short ModeNo,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp1, temp2;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x34, ModeNo);\r\ntemp1 = (pVBInfo->VBInfo & SetInSlaveMode) >> 8;\r\ntemp2 = ~(SetInSlaveMode >> 8);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x31, temp2, temp1);\r\n}\r\nstatic void XGI_GetCRT2ResInfo(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short xres, yres, modeflag, resindex;\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nxres = XGI330_ModeResInfo[resindex].HTotal;\r\nyres = XGI330_ModeResInfo[resindex].VTotal;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif (modeflag & HalfDCLK)\r\nxres *= 2;\r\nif (modeflag & DoubleScanMode)\r\nyres *= 2;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToLCD))\r\ngoto exit;\r\nif (pVBInfo->LCDResInfo == Panel_1600x1200) {\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (yres == 1024)\r\nyres = 1056;\r\n}\r\n}\r\nif (pVBInfo->LCDResInfo == Panel_1280x1024) {\r\nif (yres == 400)\r\nyres = 405;\r\nelse if (yres == 350)\r\nyres = 360;\r\nif (pVBInfo->LCDInfo & XGI_LCDVESATiming) {\r\nif (yres == 360)\r\nyres = 375;\r\n}\r\n}\r\nif (pVBInfo->LCDResInfo == Panel_1024x768) {\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (!(pVBInfo->LCDInfo & LCDNonExpanding)) {\r\nif (yres == 350)\r\nyres = 357;\r\nelse if (yres == 400)\r\nyres = 420;\r\nelse if (yres == 480)\r\nyres = 525;\r\n}\r\n}\r\n}\r\nif (xres == 720)\r\nxres = 640;\r\nexit:\r\npVBInfo->VGAHDE = xres;\r\npVBInfo->HDE = xres;\r\npVBInfo->VGAVDE = yres;\r\npVBInfo->VDE = yres;\r\n}\r\nstatic unsigned char XGI_IsLCDDualLink(struct vb_device_info *pVBInfo)\r\n{\r\nif ((pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) &&\r\n(pVBInfo->LCDInfo & SetLCDDualLink))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void XGI_GetRAMDAC2DATA(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax, tempbx, temp1, temp2, modeflag = 0, tempcx,\r\nCRT1Index;\r\npVBInfo->RVBHCMAX = 1;\r\npVBInfo->RVBHCFACT = 1;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nCRT1Index = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC;\r\nCRT1Index &= IndexMask;\r\ntemp1 = (unsigned short) XGI_CRT1Table[CRT1Index].CR[0];\r\ntemp2 = (unsigned short) XGI_CRT1Table[CRT1Index].CR[5];\r\ntempax = (temp1 & 0xFF) | ((temp2 & 0x03) << 8);\r\ntempbx = (unsigned short) XGI_CRT1Table[CRT1Index].CR[8];\r\ntempcx = (unsigned short)\r\nXGI_CRT1Table[CRT1Index].CR[14] << 8;\r\ntempcx &= 0x0100;\r\ntempcx <<= 2;\r\ntempbx |= tempcx;\r\ntemp1 = (unsigned short) XGI_CRT1Table[CRT1Index].CR[9];\r\nif (temp1 & 0x01)\r\ntempbx |= 0x0100;\r\nif (temp1 & 0x20)\r\ntempbx |= 0x0200;\r\ntempax += 5;\r\nif (modeflag & Charx8Dot)\r\ntempax *= 8;\r\nelse\r\ntempax *= 9;\r\npVBInfo->VGAHT = tempax;\r\npVBInfo->HT = tempax;\r\ntempbx++;\r\npVBInfo->VGAVT = tempbx;\r\npVBInfo->VT = tempbx;\r\n}\r\nstatic void XGI_GetCRT2Data(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax = 0, tempbx = 0, modeflag, resinfo;\r\nstruct SiS_LCDData const *LCDPtr = NULL;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\npVBInfo->NewFlickerMode = 0;\r\npVBInfo->RVBHRS = 50;\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC) {\r\nXGI_GetRAMDAC2DATA(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nreturn;\r\n}\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\nLCDPtr = XGI_GetLcdPtr(XGI_LCDDataTable, ModeIdIndex,\r\npVBInfo);\r\npVBInfo->RVBHCMAX = LCDPtr->RVBHCMAX;\r\npVBInfo->RVBHCFACT = LCDPtr->RVBHCFACT;\r\npVBInfo->VGAHT = LCDPtr->VGAHT;\r\npVBInfo->VGAVT = LCDPtr->VGAVT;\r\npVBInfo->HT = LCDPtr->LCDHT;\r\npVBInfo->VT = LCDPtr->LCDVT;\r\nif (pVBInfo->LCDResInfo == Panel_1024x768) {\r\ntempax = 1024;\r\ntempbx = 768;\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (pVBInfo->VGAVDE == 357)\r\ntempbx = 527;\r\nelse if (pVBInfo->VGAVDE == 420)\r\ntempbx = 620;\r\nelse if (pVBInfo->VGAVDE == 525)\r\ntempbx = 775;\r\nelse if (pVBInfo->VGAVDE == 600)\r\ntempbx = 775;\r\n}\r\n} else if (pVBInfo->LCDResInfo == Panel_1024x768x75) {\r\ntempax = 1024;\r\ntempbx = 768;\r\n} else if (pVBInfo->LCDResInfo == Panel_1280x1024) {\r\ntempax = 1280;\r\nif (pVBInfo->VGAVDE == 360)\r\ntempbx = 768;\r\nelse if (pVBInfo->VGAVDE == 375)\r\ntempbx = 800;\r\nelse if (pVBInfo->VGAVDE == 405)\r\ntempbx = 864;\r\nelse\r\ntempbx = 1024;\r\n} else if (pVBInfo->LCDResInfo == Panel_1280x1024x75) {\r\ntempax = 1280;\r\ntempbx = 1024;\r\n} else if (pVBInfo->LCDResInfo == Panel_1280x960) {\r\ntempax = 1280;\r\nif (pVBInfo->VGAVDE == 350)\r\ntempbx = 700;\r\nelse if (pVBInfo->VGAVDE == 400)\r\ntempbx = 800;\r\nelse if (pVBInfo->VGAVDE == 1024)\r\ntempbx = 960;\r\nelse\r\ntempbx = 960;\r\n} else if (pVBInfo->LCDResInfo == Panel_1400x1050) {\r\ntempax = 1400;\r\ntempbx = 1050;\r\nif (pVBInfo->VGAVDE == 1024) {\r\ntempax = 1280;\r\ntempbx = 1024;\r\n}\r\n} else if (pVBInfo->LCDResInfo == Panel_1600x1200) {\r\ntempax = 1600;\r\ntempbx = 1200;\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (pVBInfo->VGAVDE == 350)\r\ntempbx = 875;\r\nelse if (pVBInfo->VGAVDE == 400)\r\ntempbx = 1000;\r\n}\r\n}\r\nif (pVBInfo->LCDInfo & LCDNonExpanding) {\r\ntempax = pVBInfo->VGAHDE;\r\ntempbx = pVBInfo->VGAVDE;\r\n}\r\npVBInfo->HDE = tempax;\r\npVBInfo->VDE = tempbx;\r\nreturn;\r\n}\r\nif (pVBInfo->VBInfo & (SetCRT2ToTV)) {\r\nstruct SiS_TVData const *TVPtr;\r\nTVPtr = XGI_GetTVPtr(ModeIdIndex, RefreshRateTableIndex,\r\npVBInfo);\r\npVBInfo->RVBHCMAX = TVPtr->RVBHCMAX;\r\npVBInfo->RVBHCFACT = TVPtr->RVBHCFACT;\r\npVBInfo->VGAHT = TVPtr->VGAHT;\r\npVBInfo->VGAVT = TVPtr->VGAVT;\r\npVBInfo->HDE = TVPtr->TVHDE;\r\npVBInfo->VDE = TVPtr->TVVDE;\r\npVBInfo->RVBHRS = TVPtr->RVBHRS;\r\npVBInfo->NewFlickerMode = TVPtr->FlickerMode;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (resinfo == 0x08)\r\npVBInfo->NewFlickerMode = 0x40;\r\nelse if (resinfo == 0x09)\r\npVBInfo->NewFlickerMode = 0x40;\r\nelse if (resinfo == 0x12)\r\npVBInfo->NewFlickerMode = 0x40;\r\nif (pVBInfo->VGAVDE == 350)\r\npVBInfo->TVInfo |= TVSimuMode;\r\ntempax = ExtHiTVHT;\r\ntempbx = ExtHiTVVT;\r\nif (pVBInfo->VBInfo & SetInSlaveMode) {\r\nif (pVBInfo->TVInfo & TVSimuMode) {\r\ntempax = StHiTVHT;\r\ntempbx = StHiTVVT;\r\nif (!(modeflag & Charx8Dot)) {\r\ntempax = StHiTextTVHT;\r\ntempbx = StHiTextTVVT;\r\n}\r\n}\r\n}\r\n} else if (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p) {\r\ntempax = YPbPrTV750pHT;\r\ntempbx = YPbPrTV750pVT;\r\n}\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p) {\r\ntempax = YPbPrTV525pHT;\r\ntempbx = YPbPrTV525pVT;\r\n} else if (pVBInfo->TVInfo & TVSetYPbPr525i) {\r\ntempax = YPbPrTV525iHT;\r\ntempbx = YPbPrTV525iVT;\r\nif (pVBInfo->TVInfo & NTSC1024x768)\r\ntempax = NTSC1024x768HT;\r\n}\r\n} else {\r\ntempax = PALHT;\r\ntempbx = PALVT;\r\nif (!(pVBInfo->TVInfo & TVSetPAL)) {\r\ntempax = NTSCHT;\r\ntempbx = NTSCVT;\r\nif (pVBInfo->TVInfo & NTSC1024x768)\r\ntempax = NTSC1024x768HT;\r\n}\r\n}\r\npVBInfo->HT = tempax;\r\npVBInfo->VT = tempbx;\r\n}\r\n}\r\nstatic void XGI_SetCRT2VCLK(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char di_0, di_1, tempal;\r\ntempal = XGI_GetVCLKPtr(RefreshRateTableIndex, ModeIdIndex, pVBInfo);\r\nXGI_GetVCLKLen(tempal, &di_0, &di_1, pVBInfo);\r\nXGI_GetLCDVCLKPtr(&di_0, &di_1, pVBInfo);\r\nif (pVBInfo->VBType & VB_SIS301) {\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0A, 0x10);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0B, di_1);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0A, di_0);\r\n} else {\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0A, di_0);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0B, di_1);\r\n}\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x00, 0x12);\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC)\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x12, 0x28);\r\nelse\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x12, 0x08);\r\n}\r\nstatic unsigned short XGI_GetColorDepth(unsigned short ModeIdIndex)\r\n{\r\nunsigned short ColorDepth[6] = { 1, 2, 4, 4, 6, 8 };\r\nshort index;\r\nunsigned short modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nindex = (modeflag & ModeTypeMask) - ModeEGA;\r\nif (index < 0)\r\nindex = 0;\r\nreturn ColorDepth[index];\r\n}\r\nstatic unsigned short XGI_GetOffset(unsigned short ModeNo,\r\nunsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short temp, colordepth, modeinfo, index, infoflag,\r\nColorDepth[] = { 0x01, 0x02, 0x04 };\r\nmodeinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeInfo;\r\ninfoflag = XGI330_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\nindex = (modeinfo >> 8) & 0xFF;\r\ntemp = XGI330_ScreenOffset[index];\r\nif (infoflag & InterlaceMode)\r\ntemp <<= 1;\r\ncolordepth = XGI_GetColorDepth(ModeIdIndex);\r\nif ((ModeNo >= 0x7C) && (ModeNo <= 0x7E)) {\r\ntemp = ModeNo - 0x7C;\r\ncolordepth = ColorDepth[temp];\r\ntemp = 0x6B;\r\nif (infoflag & InterlaceMode)\r\ntemp <<= 1;\r\n}\r\nreturn temp * colordepth;\r\n}\r\nstatic void XGI_SetCRT2Offset(unsigned short ModeNo,\r\nunsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short offset;\r\nunsigned char temp;\r\nif (pVBInfo->VBInfo & SetInSlaveMode)\r\nreturn;\r\noffset = XGI_GetOffset(ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\ntemp = (unsigned char) (offset & 0xFF);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x07, temp);\r\ntemp = (unsigned char) ((offset & 0xFF00) >> 8);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x09, temp);\r\ntemp = (unsigned char) (((offset >> 3) & 0xFF) + 1);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x03, temp);\r\n}\r\nstatic void XGI_SetCRT2FIFO(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x01, 0x3B);\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x02, ~(0x3F), 0x04);\r\n}\r\nstatic void XGI_PreSetGroup1(unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nu8 tempcx;\r\nXGI_SetCRT2Offset(ModeNo, ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetCRT2FIFO(pVBInfo);\r\nfor (tempcx = 4; tempcx < 7; tempcx++)\r\nxgifb_reg_set(pVBInfo->Part1Port, tempcx, 0x0);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x50, 0x00);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x02, 0x44);\r\n}\r\nstatic void XGI_SetGroup1(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp = 0, tempax = 0, tempbx = 0, tempcx = 0,\r\npushbx = 0, CRT1Index, modeflag;\r\nCRT1Index = XGI330_RefIndex[RefreshRateTableIndex].Ext_CRT1CRTC;\r\nCRT1Index &= IndexMask;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif (modeflag & HalfDCLK) {\r\ntemp = (pVBInfo->VGAHT / 2 - 1) & 0x0FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x08, temp);\r\ntemp = (((pVBInfo->VGAHT / 2 - 1) & 0xFF00) >> 8) << 4;\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x09, ~0x0F0, temp);\r\ntemp = (pVBInfo->VGAHDE / 2 + 16) & 0x0FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0A, temp);\r\ntempcx = ((pVBInfo->VGAHT - pVBInfo->VGAHDE) / 2) >> 2;\r\npushbx = pVBInfo->VGAHDE / 2 + 16;\r\ntempcx >>= 1;\r\ntempbx = pushbx + tempcx;\r\ntempcx += tempbx;\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC) {\r\ntempbx = XGI_CRT1Table[CRT1Index].CR[4];\r\ntempbx |= ((XGI_CRT1Table[CRT1Index].CR[14] &\r\n0xC0) << 2);\r\ntempbx = (tempbx - 3) << 3;\r\ntempcx = XGI_CRT1Table[CRT1Index].CR[5];\r\ntempcx &= 0x1F;\r\ntemp = XGI_CRT1Table[CRT1Index].CR[15];\r\ntemp = (temp & 0x04) << (5 - 2);\r\ntempcx = ((tempcx | temp) - 3) << 3;\r\n}\r\ntempbx += 4;\r\ntempcx += 4;\r\nif (tempcx > (pVBInfo->VGAHT / 2))\r\ntempcx = pVBInfo->VGAHT / 2;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0B, temp);\r\n} else {\r\ntemp = (pVBInfo->VGAHT - 1) & 0x0FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x08, temp);\r\ntemp = (((pVBInfo->VGAHT - 1) & 0xFF00) >> 8) << 4;\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x09, ~0x0F0, temp);\r\ntemp = (pVBInfo->VGAHDE + 16) & 0x0FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0A, temp);\r\ntempcx = (pVBInfo->VGAHT - pVBInfo->VGAHDE) >> 2;\r\npushbx = pVBInfo->VGAHDE + 16;\r\ntempcx >>= 1;\r\ntempbx = pushbx + tempcx;\r\ntempcx += tempbx;\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC) {\r\ntempbx = XGI_CRT1Table[CRT1Index].CR[3];\r\ntempbx |= ((XGI_CRT1Table[CRT1Index].CR[5] &\r\n0xC0) << 2);\r\ntempbx = (tempbx - 3) << 3;\r\ntempcx = XGI_CRT1Table[CRT1Index].CR[4];\r\ntempcx &= 0x1F;\r\ntemp = XGI_CRT1Table[CRT1Index].CR[6];\r\ntemp = (temp & 0x04) << (5 - 2);\r\ntempcx = ((tempcx | temp) - 3) << 3;\r\ntempbx += 16;\r\ntempcx += 16;\r\n}\r\nif (tempcx > pVBInfo->VGAHT)\r\ntempcx = pVBInfo->VGAHT;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0B, temp);\r\n}\r\ntempax = (tempax & 0x00FF) | (tempbx & 0xFF00);\r\ntempbx = pushbx;\r\ntempbx = (tempbx & 0x00FF) | ((tempbx & 0xFF00) << 4);\r\ntempax |= (tempbx & 0xFF00);\r\ntemp = (tempax & 0xFF00) >> 8;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0C, temp);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0D, temp);\r\ntempcx = (pVBInfo->VGAVT - 1);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0E, temp);\r\ntempbx = pVBInfo->VGAVDE - 1;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0F, temp);\r\ntemp = ((tempbx & 0xFF00) << 3) >> 8;\r\ntemp |= ((tempcx & 0xFF00) >> 8);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x12, temp);\r\ntempbx = (pVBInfo->VGAVT + pVBInfo->VGAVDE) >> 1;\r\ntempcx = ((pVBInfo->VGAVT - pVBInfo->VGAVDE) >> 4) + tempbx + 1;\r\nif (pVBInfo->VBInfo & SetCRT2ToRAMDAC) {\r\ntempbx = XGI_CRT1Table[CRT1Index].CR[10];\r\ntemp = XGI_CRT1Table[CRT1Index].CR[9];\r\nif (temp & 0x04)\r\ntempbx |= 0x0100;\r\nif (temp & 0x080)\r\ntempbx |= 0x0200;\r\ntemp = XGI_CRT1Table[CRT1Index].CR[14];\r\nif (temp & 0x08)\r\ntempbx |= 0x0400;\r\ntemp = XGI_CRT1Table[CRT1Index].CR[11];\r\ntempcx = (tempcx & 0xFF00) | (temp & 0x00FF);\r\n}\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x10, temp);\r\ntemp = ((tempbx & 0xFF00) >> 8) << 4;\r\ntemp = ((tempcx & 0x000F) | (temp));\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x11, temp);\r\ntempax = 0;\r\nif (modeflag & DoubleScanMode)\r\ntempax |= 0x80;\r\nif (modeflag & HalfDCLK)\r\ntempax |= 0x40;\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x2C, ~0x0C0, tempax);\r\n}\r\nstatic unsigned short XGI_GetVGAHT2(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned long tempax, tempbx;\r\ntempbx = ((pVBInfo->VGAVT - pVBInfo->VGAVDE) * pVBInfo->RVBHCMAX)\r\n& 0xFFFF;\r\ntempax = (pVBInfo->VT - pVBInfo->VDE) * pVBInfo->RVBHCFACT;\r\ntempax = (tempax * pVBInfo->HT) / tempbx;\r\nreturn (unsigned short) tempax;\r\n}\r\nstatic void XGI_SetLockRegs(unsigned short ModeNo, unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short push1, push2, tempax, tempbx = 0, tempcx, temp, resinfo,\r\nmodeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nif (!(pVBInfo->VBInfo & SetInSlaveMode))\r\nreturn;\r\ntemp = 0xFF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x03, temp);\r\ntempcx = 0x08;\r\nif (pVBInfo->VBType & (VB_SIS301LV | VB_SIS302LV | VB_XGI301C))\r\nmodeflag |= Charx8Dot;\r\ntempax = pVBInfo->VGAHDE;\r\nif (modeflag & HalfDCLK)\r\ntempax >>= 1;\r\ntempax = (tempax / tempcx) - 1;\r\ntempbx |= ((tempax & 0x00FF) << 8);\r\ntemp = tempax & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x04, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (!(pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)))\r\ntemp += 2;\r\nif ((pVBInfo->VBInfo & SetCRT2ToHiVision) &&\r\n!(pVBInfo->VBType & VB_SIS301LV) && (resinfo == 7))\r\ntemp -= 2;\r\n}\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x05, temp);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x06, 0x03);\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\nif (pVBInfo->VBInfo & SetCRT2ToTV)\r\ntempax = pVBInfo->VGAHT;\r\nelse\r\ntempax = XGI_GetVGAHT2(pVBInfo);\r\n}\r\nif (tempax >= pVBInfo->VGAHT)\r\ntempax = pVBInfo->VGAHT;\r\nif (modeflag & HalfDCLK)\r\ntempax >>= 1;\r\ntempax = (tempax / tempcx) - 5;\r\ntempcx = tempax;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\ntemp = (tempbx & 0x00FF) - 1;\r\nif (!(modeflag & HalfDCLK)) {\r\ntemp -= 6;\r\nif (pVBInfo->TVInfo & TVSimuMode) {\r\ntemp -= 4;\r\ntemp -= 10;\r\n}\r\n}\r\n} else {\r\ntempbx = (tempbx & 0xFF00) >> 8;\r\ntempcx = (tempcx + tempbx) >> 1;\r\ntemp = (tempcx & 0x00FF) + 2;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\ntemp -= 1;\r\nif (!(modeflag & HalfDCLK)) {\r\nif ((modeflag & Charx8Dot)) {\r\ntemp += 4;\r\nif (pVBInfo->VGAHDE >= 800)\r\ntemp -= 6;\r\n}\r\n}\r\n} else if (!(modeflag & HalfDCLK)) {\r\ntemp -= 4;\r\nif (pVBInfo->LCDResInfo != Panel_1280x960 &&\r\npVBInfo->VGAHDE >= 800) {\r\ntemp -= 7;\r\nif (pVBInfo->VGAHDE >= 1280 &&\r\npVBInfo->LCDResInfo != Panel_1280x960 &&\r\n(pVBInfo->LCDInfo & LCDNonExpanding))\r\ntemp += 28;\r\n}\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x07, temp);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x08, 0);\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (pVBInfo->TVInfo & TVSimuMode) {\r\nif (ModeNo == 0x50) {\r\nif (pVBInfo->TVInfo == SetNTSCTV) {\r\nxgifb_reg_set(pVBInfo->Part1Port,\r\n0x07, 0x30);\r\nxgifb_reg_set(pVBInfo->Part1Port,\r\n0x08, 0x03);\r\n} else {\r\nxgifb_reg_set(pVBInfo->Part1Port,\r\n0x07, 0x2f);\r\nxgifb_reg_set(pVBInfo->Part1Port,\r\n0x08, 0x02);\r\n}\r\n}\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x18, 0x03);\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x19, 0xF0, 0x00);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x09, 0xFF);\r\ntempbx = pVBInfo->VGAVT;\r\npush1 = tempbx;\r\ntempcx = 0x121;\r\ntempbx = pVBInfo->VGAVDE;\r\nif (tempbx == 357)\r\ntempbx = 350;\r\nif (tempbx == 360)\r\ntempbx = 350;\r\nif (tempbx == 375)\r\ntempbx = 350;\r\nif (tempbx == 405)\r\ntempbx = 400;\r\nif (tempbx == 525)\r\ntempbx = 480;\r\npush2 = tempbx;\r\nif (pVBInfo->VBInfo & SetCRT2ToLCD) {\r\nif (pVBInfo->LCDResInfo == Panel_1024x768) {\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (tempbx == 350)\r\ntempbx += 5;\r\nif (tempbx == 480)\r\ntempbx += 5;\r\n}\r\n}\r\n}\r\ntempbx--;\r\ntempbx--;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x10, temp);\r\ntempbx = push2;\r\ntempbx--;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0E, temp);\r\nif (tempbx & 0x0100)\r\ntempcx |= 0x0002;\r\ntempax = 0x000B;\r\nif (modeflag & DoubleScanMode)\r\ntempax |= 0x08000;\r\nif (tempbx & 0x0200)\r\ntempcx |= 0x0040;\r\ntemp = (tempax & 0xFF00) >> 8;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0B, temp);\r\nif (tempbx & 0x0400)\r\ntempcx |= 0x0600;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x11, 0x00);\r\ntempax = push1;\r\ntempax -= tempbx;\r\ntempax >>= 2;\r\npush1 = tempax;\r\nif (resinfo != 0x09) {\r\ntempax <<= 1;\r\ntempbx += tempax;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif ((pVBInfo->VBType & VB_SIS301LV) &&\r\n!(pVBInfo->TVInfo & TVSetHiVision)) {\r\nif ((pVBInfo->TVInfo & TVSimuMode) &&\r\n(pVBInfo->TVInfo & TVSetPAL)) {\r\nif (!(pVBInfo->VBType & VB_SIS301LV) ||\r\n!(pVBInfo->TVInfo &\r\n(TVSetYPbPr525p |\r\nTVSetYPbPr750p |\r\nTVSetHiVision)))\r\ntempbx += 40;\r\n}\r\n} else {\r\ntempbx -= 10;\r\n}\r\n} else if (pVBInfo->TVInfo & TVSimuMode) {\r\nif (pVBInfo->TVInfo & TVSetPAL) {\r\nif (pVBInfo->VBType & VB_SIS301LV) {\r\nif (!(pVBInfo->TVInfo &\r\n(TVSetYPbPr525p |\r\nTVSetYPbPr750p |\r\nTVSetHiVision)))\r\ntempbx += 40;\r\n} else {\r\ntempbx += 40;\r\n}\r\n}\r\n}\r\ntempax = push1;\r\ntempax >>= 2;\r\ntempax++;\r\ntempax += tempbx;\r\npush1 = tempax;\r\nif ((pVBInfo->TVInfo & TVSetPAL)) {\r\nif (tempbx <= 513) {\r\nif (tempax >= 513)\r\ntempbx = 513;\r\n}\r\n}\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0C, temp);\r\ntempbx--;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x10, temp);\r\nif (tempbx & 0x0100)\r\ntempcx |= 0x0008;\r\nif (tempbx & 0x0200)\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x0B, 0x0FF, 0x20);\r\ntempbx++;\r\nif (tempbx & 0x0100)\r\ntempcx |= 0x0004;\r\nif (tempbx & 0x0200)\r\ntempcx |= 0x0080;\r\nif (tempbx & 0x0400)\r\ntempcx |= 0x0C00;\r\ntempbx = push1;\r\ntemp = tempbx & 0x00FF;\r\ntemp &= 0x0F;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0D, temp);\r\nif (tempbx & 0x0010)\r\ntempcx |= 0x2000;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0A, temp);\r\ntemp = (tempcx & 0x0FF00) >> 8;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x17, temp);\r\ntempax = modeflag;\r\ntemp = (tempax & 0xFF00) >> 8;\r\ntemp = (temp >> 1) & 0x09;\r\nif (pVBInfo->VBType & (VB_SIS301LV | VB_SIS302LV | VB_XGI301C))\r\ntemp |= 0x01;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x16, temp);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x0F, 0);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x12, 0);\r\nif (pVBInfo->LCDInfo & LCDRGB18Bit)\r\ntemp = 0x80;\r\nelse\r\ntemp = 0x00;\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1A, temp);\r\n}\r\nstatic void XGI_SetGroup2(unsigned short ModeNo, unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i, j, tempax, tempbx, tempcx, temp, push1, push2,\r\nmodeflag;\r\nunsigned char const *TimingPoint;\r\nunsigned long longtemp, tempeax, tempebx, temp2, tempecx;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ntempax = 0;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToAVIDEO))\r\ntempax |= 0x0800;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToSVIDEO))\r\ntempax |= 0x0400;\r\nif (pVBInfo->VBInfo & SetCRT2ToSCART)\r\ntempax |= 0x0200;\r\nif (!(pVBInfo->TVInfo & TVSetPAL))\r\ntempax |= 0x1000;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision)\r\ntempax |= 0x0100;\r\nif (pVBInfo->TVInfo & (TVSetYPbPr525p | TVSetYPbPr750p))\r\ntempax &= 0xfe00;\r\ntempax = (tempax & 0xff00) >> 8;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x0, tempax);\r\nTimingPoint = XGI330_NTSCTiming;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\nTimingPoint = XGI330_PALTiming;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nTimingPoint = XGI330_HiTVExtTiming;\r\nif (pVBInfo->VBInfo & SetInSlaveMode)\r\nTimingPoint = XGI330_HiTVSt2Timing;\r\nif (pVBInfo->SetFlag & TVSimuMode)\r\nTimingPoint = XGI330_HiTVSt1Timing;\r\nif (!(modeflag & Charx8Dot))\r\nTimingPoint = XGI330_HiTVTextTiming;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\nif (pVBInfo->TVInfo & TVSetYPbPr525i)\r\nTimingPoint = XGI330_YPbPr525iTiming;\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p)\r\nTimingPoint = XGI330_YPbPr525pTiming;\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p)\r\nTimingPoint = XGI330_YPbPr750pTiming;\r\n}\r\nfor (i = 0x01, j = 0; i <= 0x2D; i++, j++)\r\nxgifb_reg_set(pVBInfo->Part2Port, i, TimingPoint[j]);\r\nfor (i = 0x39; i <= 0x45; i++, j++)\r\nxgifb_reg_set(pVBInfo->Part2Port, i, TimingPoint[j]);\r\nif (pVBInfo->VBInfo & SetCRT2ToTV)\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x3A, 0x1F, 0x00);\r\ntemp = pVBInfo->NewFlickerMode;\r\ntemp &= 0x80;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x0A, 0xFF, temp);\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\ntempax = 520;\r\nelse\r\ntempax = 440;\r\nif (pVBInfo->VDE <= tempax) {\r\ntempax -= pVBInfo->VDE;\r\ntempax >>= 2;\r\ntempax = (tempax & 0x00FF) | ((tempax & 0x00FF) << 8);\r\npush1 = tempax;\r\ntemp = (tempax & 0xFF00) >> 8;\r\ntemp += (unsigned short) TimingPoint[0];\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBInfo & (SetCRT2ToAVIDEO\r\n| SetCRT2ToSVIDEO | SetCRT2ToSCART\r\n| SetCRT2ToYPbPr525750)) {\r\ntempcx = pVBInfo->VGAHDE;\r\nif (tempcx >= 1024) {\r\ntemp = 0x17;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\ntemp = 0x19;\r\n}\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x01, temp);\r\ntempax = push1;\r\ntemp = (tempax & 0xFF00) >> 8;\r\ntemp += TimingPoint[1];\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif ((pVBInfo->VBInfo & (SetCRT2ToAVIDEO\r\n| SetCRT2ToSVIDEO | SetCRT2ToSCART\r\n| SetCRT2ToYPbPr525750))) {\r\ntempcx = pVBInfo->VGAHDE;\r\nif (tempcx >= 1024) {\r\ntemp = 0x1D;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\ntemp = 0x52;\r\n}\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x02, temp);\r\n}\r\ntempcx = pVBInfo->HT;\r\nif (XGI_IsLCDDualLink(pVBInfo))\r\ntempcx >>= 1;\r\ntempcx -= 2;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x1B, temp);\r\ntemp = (tempcx & 0xFF00) >> 8;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x1D, ~0x0F, temp);\r\ntempcx = pVBInfo->HT >> 1;\r\npush1 = tempcx;\r\ntempcx += 7;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision)\r\ntempcx -= 4;\r\ntemp = tempcx & 0x00FF;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x22, 0x0F, temp);\r\ntempbx = TimingPoint[j] | ((TimingPoint[j + 1]) << 8);\r\ntempbx += tempcx;\r\npush2 = tempbx;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x24, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x25, 0x0F, temp);\r\ntempbx = push2;\r\ntempbx = tempbx + 8;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\ntempbx = tempbx - 4;\r\ntempcx = tempbx;\r\n}\r\ntemp = (tempbx & 0x00FF) << 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x29, 0x0F, temp);\r\nj += 2;\r\ntempcx += (TimingPoint[j] | ((TimingPoint[j + 1]) << 8));\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x27, temp);\r\ntemp = ((tempcx & 0xFF00) >> 8) << 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x28, 0x0F, temp);\r\ntempcx += 8;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision)\r\ntempcx -= 4;\r\ntemp = tempcx & 0xFF;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x2A, 0x0F, temp);\r\ntempcx = push1;\r\nj += 2;\r\ntemp = TimingPoint[j] | ((TimingPoint[j + 1]) << 8);\r\ntempcx -= temp;\r\ntemp = tempcx & 0x00FF;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x2D, 0x0F, temp);\r\ntempcx -= 11;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToTV)) {\r\ntempax = XGI_GetVGAHT2(pVBInfo);\r\ntempcx = tempax - 1;\r\n}\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x2E, temp);\r\ntempbx = pVBInfo->VDE;\r\nif (pVBInfo->VGAVDE == 360)\r\ntempbx = 746;\r\nif (pVBInfo->VGAVDE == 375)\r\ntempbx = 746;\r\nif (pVBInfo->VGAVDE == 405)\r\ntempbx = 853;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (pVBInfo->VBType &\r\n(VB_SIS301LV | VB_SIS302LV | VB_XGI301C)) {\r\nif (!(pVBInfo->TVInfo &\r\n(TVSetYPbPr525p | TVSetYPbPr750p)))\r\ntempbx >>= 1;\r\n} else\r\ntempbx >>= 1;\r\n}\r\ntempbx -= 2;\r\ntemp = tempbx & 0x00FF;\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (pVBInfo->VBType & VB_SIS301LV) {\r\nif (pVBInfo->TVInfo & TVSetHiVision) {\r\nif (pVBInfo->VBInfo & SetInSlaveMode) {\r\nif (ModeNo == 0x2f)\r\ntemp += 1;\r\n}\r\n}\r\n} else if (pVBInfo->VBInfo & SetInSlaveMode) {\r\nif (ModeNo == 0x2f)\r\ntemp += 1;\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x2F, temp);\r\ntemp = (tempcx & 0xFF00) >> 8;\r\ntemp |= ((tempbx & 0xFF00) >> 8) << 6;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToHiVision)) {\r\nif (pVBInfo->VBType & VB_SIS301LV) {\r\nif (pVBInfo->TVInfo & TVSetHiVision) {\r\ntemp |= 0x10;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToSVIDEO))\r\ntemp |= 0x20;\r\n}\r\n} else {\r\ntemp |= 0x10;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToSVIDEO))\r\ntemp |= 0x20;\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x30, temp);\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempbx = pVBInfo->VDE;\r\ntempcx = tempbx - 2;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (!(pVBInfo->TVInfo & (TVSetYPbPr525p\r\n| TVSetYPbPr750p)))\r\ntempbx >>= 1;\r\n}\r\nif (pVBInfo->VBType & (VB_SIS302LV | VB_XGI301C)) {\r\ntemp = 0;\r\nif (tempcx & 0x0400)\r\ntemp |= 0x20;\r\nif (tempbx & 0x0400)\r\ntemp |= 0x40;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x10, temp);\r\n}\r\ntemp = (((tempbx - 3) & 0x0300) >> 8) << 5;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x46, temp);\r\ntemp = (tempbx - 3) & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x47, temp);\r\n}\r\ntempbx = tempbx & 0x00FF;\r\nif (!(modeflag & HalfDCLK)) {\r\ntempcx = pVBInfo->VGAHDE;\r\nif (tempcx >= pVBInfo->HDE) {\r\ntempbx |= 0x2000;\r\ntempax &= 0x00FF;\r\n}\r\n}\r\ntempcx = 0x0101;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (pVBInfo->VGAHDE >= 1024) {\r\ntempcx = 0x1920;\r\nif (pVBInfo->VGAHDE >= 1280) {\r\ntempcx = 0x1420;\r\ntempbx = tempbx & 0xDFFF;\r\n}\r\n}\r\n}\r\nif (!(tempbx & 0x2000)) {\r\nif (modeflag & HalfDCLK)\r\ntempcx = (tempcx & 0xFF00) | ((tempcx & 0x00FF) << 1);\r\npush1 = tempbx;\r\ntempeax = pVBInfo->VGAHDE;\r\ntempebx = (tempcx & 0xFF00) >> 8;\r\nlongtemp = tempeax * tempebx;\r\ntempecx = tempcx & 0x00FF;\r\nlongtemp = longtemp / tempecx;\r\ntempecx = 8 * 1024;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempecx = tempecx * 8;\r\n}\r\nlongtemp = longtemp * tempecx;\r\ntempecx = pVBInfo->HDE;\r\ntemp2 = longtemp % tempecx;\r\ntempeax = longtemp / tempecx;\r\nif (temp2 != 0)\r\ntempeax += 1;\r\ntempax = (unsigned short) tempeax;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempcx = ((tempax & 0xFF00) >> 5) >> 8;\r\n}\r\ntempbx = push1;\r\ntempbx = (unsigned short) (((tempeax & 0x0000FF00) & 0x1F00)\r\n| (tempbx & 0x00FF));\r\ntempax = (unsigned short) (((tempeax & 0x000000FF) << 8)\r\n| (tempax & 0x00FF));\r\ntemp = (tempax & 0xFF00) >> 8;\r\n} else {\r\ntemp = (tempax & 0x00FF) >> 8;\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x44, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x45, ~0x03F, temp);\r\ntemp = tempcx & 0x00FF;\r\nif (tempbx & 0x2000)\r\ntemp = 0;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToLCD))\r\ntemp |= 0x18;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x46, ~0x1F, temp);\r\nif (pVBInfo->TVInfo & TVSetPAL) {\r\ntempbx = 0x0382;\r\ntempcx = 0x007e;\r\n} else {\r\ntempbx = 0x0369;\r\ntempcx = 0x0061;\r\n}\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x4b, temp);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x4c, temp);\r\ntemp = ((tempcx & 0xFF00) >> 8) & 0x03;\r\ntemp <<= 2;\r\ntemp |= ((tempbx & 0xFF00) >> 8) & 0x03;\r\nif (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\ntemp |= 0x10;\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p)\r\ntemp |= 0x20;\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p)\r\ntemp |= 0x60;\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x4d, temp);\r\ntemp = xgifb_reg_get(pVBInfo->Part2Port, 0x43);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x43, (unsigned short) (temp - 3));\r\nif (!(pVBInfo->TVInfo & (TVSetYPbPr525p | TVSetYPbPr750p))) {\r\nif (pVBInfo->TVInfo & NTSC1024x768) {\r\nTimingPoint = XGI_NTSC1024AdjTime;\r\nfor (i = 0x1c, j = 0; i <= 0x30; i++, j++) {\r\nxgifb_reg_set(pVBInfo->Part2Port, i,\r\nTimingPoint[j]);\r\n}\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x43, 0x72);\r\n}\r\n}\r\nif (pVBInfo->VBType & VB_XGI301C) {\r\nif (pVBInfo->TVInfo & TVSetPALM)\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x4E, ~0x08,\r\n0x08);\r\n}\r\nif (pVBInfo->TVInfo & TVSetPALM) {\r\ntempax = xgifb_reg_get(pVBInfo->Part2Port, 0x01);\r\ntempax--;\r\nxgifb_reg_and(pVBInfo->Part2Port, 0x01, tempax);\r\nxgifb_reg_and(pVBInfo->Part2Port, 0x00, 0xEF);\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision) {\r\nif (!(pVBInfo->VBInfo & SetInSlaveMode))\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x0B, 0x00);\r\n}\r\n}\r\nstatic void XGI_SetLCDRegs(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short pushbx, tempax, tempbx, tempcx, temp, tempah,\r\ntempbh, tempch;\r\nstruct XGI_LCDDesStruct const *LCDBDesPtr = NULL;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToLCD))\r\nreturn;\r\ntempbx = pVBInfo->HDE;\r\nif (XGI_IsLCDDualLink(pVBInfo))\r\ntempbx >>= 1;\r\ntempbx -= 1;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x2C, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x2B, 0x0F, temp);\r\ntemp = 0x01;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x0B, temp);\r\ntempbx = pVBInfo->VDE;\r\ntempbx--;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x03, temp);\r\ntemp = ((tempbx & 0xFF00) >> 8) & 0x07;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x0C, ~0x07, temp);\r\ntempcx = pVBInfo->VT - 1;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x19, temp);\r\ntemp = (tempcx & 0xFF00) >> 8;\r\ntemp <<= 5;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x1A, temp);\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x09, 0xF0, 0x00);\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x0A, 0xF0, 0x00);\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x17, 0xFB, 0x00);\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x18, 0xDF, 0x00);\r\nif ((pVBInfo->VBType & VB_SIS301LV) || (pVBInfo->VBType & VB_SIS302LV))\r\nLCDBDesPtr = XGI_GetLcdPtr(xgifb_lcddldes, ModeIdIndex,\r\npVBInfo);\r\nelse\r\nLCDBDesPtr = XGI_GetLcdPtr(XGI_LCDDesDataTable, ModeIdIndex,\r\npVBInfo);\r\ntempah = pVBInfo->LCDResInfo;\r\ntempah &= PanelResInfo;\r\nif ((tempah == Panel_1024x768) || (tempah == Panel_1024x768x75)) {\r\ntempbx = 1024;\r\ntempcx = 768;\r\n} else if ((tempah == Panel_1280x1024) ||\r\n(tempah == Panel_1280x1024x75)) {\r\ntempbx = 1280;\r\ntempcx = 1024;\r\n} else if (tempah == Panel_1400x1050) {\r\ntempbx = 1400;\r\ntempcx = 1050;\r\n} else {\r\ntempbx = 1600;\r\ntempcx = 1200;\r\n}\r\nif (pVBInfo->LCDInfo & EnableScalingLCD) {\r\ntempbx = pVBInfo->HDE;\r\ntempcx = pVBInfo->VDE;\r\n}\r\npushbx = tempbx;\r\ntempax = pVBInfo->VT;\r\npVBInfo->LCDHDES = LCDBDesPtr->LCDHDES;\r\npVBInfo->LCDHRS = LCDBDesPtr->LCDHRS;\r\npVBInfo->LCDVDES = LCDBDesPtr->LCDVDES;\r\npVBInfo->LCDVRS = LCDBDesPtr->LCDVRS;\r\ntempbx = pVBInfo->LCDVDES;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x05, temp);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x06, temp);\r\ntempch = ((tempcx & 0xFF00) >> 8) & 0x07;\r\ntempbh = ((tempbx & 0xFF00) >> 8) & 0x07;\r\ntempah = tempch;\r\ntempah <<= 3;\r\ntempah |= tempbh;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x02, tempah);\r\nXGI_GetLCDSync(&tempax, &tempbx, pVBInfo);\r\ntempcx = tempbx;\r\ntempax = pVBInfo->VT;\r\ntempbx = pVBInfo->LCDVRS;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x04, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\ntemp <<= 4;\r\ntemp |= (tempcx & 0x000F);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x01, temp);\r\ntempcx = pushbx;\r\ntempax = pVBInfo->HT;\r\ntempbx = pVBInfo->LCDHDES;\r\ntempbx &= 0x0FFF;\r\nif (XGI_IsLCDDualLink(pVBInfo)) {\r\ntempax >>= 1;\r\ntempbx >>= 1;\r\ntempcx >>= 1;\r\n}\r\nif (pVBInfo->VBType & VB_SIS302LV)\r\ntempbx += 1;\r\nif (pVBInfo->VBType & VB_XGI301C)\r\ntempbx += 1;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x1F, temp);\r\ntemp = ((tempbx & 0xFF00) >> 8) << 4;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x20, temp);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x23, temp);\r\ntemp = (tempcx & 0xFF00) >> 8;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x25, temp);\r\nXGI_GetLCDSync(&tempax, &tempbx, pVBInfo);\r\ntempcx = tempax;\r\ntempax = pVBInfo->HT;\r\ntempbx = pVBInfo->LCDHRS;\r\nif (XGI_IsLCDDualLink(pVBInfo)) {\r\ntempax >>= 1;\r\ntempbx >>= 1;\r\ntempcx >>= 1;\r\n}\r\nif (pVBInfo->VBType & VB_SIS302LV)\r\ntempbx += 1;\r\ntempcx += tempbx;\r\nif (tempcx >= tempax)\r\ntempcx -= tempax;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x1C, temp);\r\ntemp = (tempbx & 0xFF00) >> 8;\r\ntemp <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x1D, ~0x0F0, temp);\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x21, temp);\r\nif (!(pVBInfo->LCDInfo & XGI_LCDVESATiming)) {\r\nif (pVBInfo->VGAVDE == 525) {\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B\r\n| VB_SIS301LV | VB_SIS302LV\r\n| VB_XGI301C)) {\r\ntemp = 0xC6;\r\n} else\r\ntemp = 0xC4;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x2f, temp);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x30, 0xB3);\r\n}\r\nif (pVBInfo->VGAVDE == 420) {\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B\r\n| VB_SIS301LV | VB_SIS302LV\r\n| VB_XGI301C)) {\r\ntemp = 0x4F;\r\n} else\r\ntemp = 0x4E;\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x2f, temp);\r\n}\r\n}\r\n}\r\nstatic struct XGI301C_Tap4TimingStruct const\r\n*XGI_GetTap4Ptr(unsigned short tempcx, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax, tempbx, i;\r\nstruct XGI301C_Tap4TimingStruct const *Tap4TimingPtr;\r\nif (tempcx == 0) {\r\ntempax = pVBInfo->VGAHDE;\r\ntempbx = pVBInfo->HDE;\r\n} else {\r\ntempax = pVBInfo->VGAVDE;\r\ntempbx = pVBInfo->VDE;\r\n}\r\nif (tempax <= tempbx)\r\nreturn &xgifb_tap4_timing[0];\r\nTap4TimingPtr = xgifb_ntsc_525_tap4_timing;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\nTap4TimingPtr = PALTap4Timing;\r\nif (pVBInfo->VBInfo & SetCRT2ToYPbPr525750) {\r\nif ((pVBInfo->TVInfo & TVSetYPbPr525i) ||\r\n(pVBInfo->TVInfo & TVSetYPbPr525p))\r\nTap4TimingPtr = xgifb_ntsc_525_tap4_timing;\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p)\r\nTap4TimingPtr = YPbPr750pTap4Timing;\r\n}\r\nif (pVBInfo->VBInfo & SetCRT2ToHiVision)\r\nTap4TimingPtr = xgifb_tap4_timing;\r\ni = 0;\r\nwhile (Tap4TimingPtr[i].DE != 0xFFFF) {\r\nif (Tap4TimingPtr[i].DE == tempax)\r\nbreak;\r\ni++;\r\n}\r\nreturn &Tap4TimingPtr[i];\r\n}\r\nstatic void XGI_SetTap4Regs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i, j;\r\nstruct XGI301C_Tap4TimingStruct const *Tap4TimingPtr;\r\nif (!(pVBInfo->VBType & VB_XGI301C))\r\nreturn;\r\nTap4TimingPtr = XGI_GetTap4Ptr(0, pVBInfo);\r\nfor (i = 0x80, j = 0; i <= 0xBF; i++, j++)\r\nxgifb_reg_set(pVBInfo->Part2Port, i, Tap4TimingPtr->Reg[j]);\r\nif ((pVBInfo->VBInfo & SetCRT2ToTV) &&\r\n(!(pVBInfo->VBInfo & SetCRT2ToHiVision))) {\r\nTap4TimingPtr = XGI_GetTap4Ptr(1, pVBInfo);\r\nfor (i = 0xC0, j = 0; i < 0xFF; i++, j++)\r\nxgifb_reg_set(pVBInfo->Part2Port,\r\ni,\r\nTap4TimingPtr->Reg[j]);\r\n}\r\nif ((pVBInfo->VBInfo & SetCRT2ToTV) &&\r\n(!(pVBInfo->VBInfo & SetCRT2ToHiVision)))\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x4E, ~0x14, 0x04);\r\nelse\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x4E, ~0x14, 0x10);\r\n}\r\nstatic void XGI_SetGroup3(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i;\r\nunsigned char const *tempdi;\r\nunsigned short modeflag;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x00, 0x00);\r\nif (pVBInfo->TVInfo & TVSetPAL) {\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x13, 0xFA);\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x14, 0xC8);\r\n} else {\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x13, 0xF5);\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x14, 0xB7);\r\n}\r\nif (!(pVBInfo->VBInfo & SetCRT2ToTV))\r\nreturn;\r\nif (pVBInfo->TVInfo & TVSetPALM) {\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x13, 0xFA);\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x14, 0xC8);\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x3D, 0xA8);\r\n}\r\nif ((pVBInfo->VBInfo & SetCRT2ToHiVision) || (pVBInfo->VBInfo\r\n& SetCRT2ToYPbPr525750)) {\r\nif (pVBInfo->TVInfo & TVSetYPbPr525i)\r\nreturn;\r\ntempdi = XGI330_HiTVGroup3Data;\r\nif (pVBInfo->SetFlag & TVSimuMode) {\r\ntempdi = XGI330_HiTVGroup3Simu;\r\nif (!(modeflag & Charx8Dot))\r\ntempdi = XGI330_HiTVGroup3Text;\r\n}\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p)\r\ntempdi = XGI330_Ren525pGroup3;\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p)\r\ntempdi = XGI330_Ren750pGroup3;\r\nfor (i = 0; i <= 0x3E; i++)\r\nxgifb_reg_set(pVBInfo->Part3Port, i, tempdi[i]);\r\nif (pVBInfo->VBType & VB_XGI301C) {\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p)\r\nxgifb_reg_set(pVBInfo->Part3Port, 0x28, 0x3f);\r\n}\r\n}\r\n}\r\nstatic void XGI_SetGroup4(unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax, tempcx, tempbx, modeflag, temp, temp2;\r\nunsigned long tempebx, tempeax, templong;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ntemp = pVBInfo->RVBHCFACT;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x13, temp);\r\ntempbx = pVBInfo->RVBHCMAX;\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x14, temp);\r\ntemp2 = ((tempbx & 0xFF00) >> 8) << 7;\r\ntempcx = pVBInfo->VGAHT - 1;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x16, temp);\r\ntemp = ((tempcx & 0xFF00) >> 8) << 3;\r\ntemp2 |= temp;\r\ntempcx = pVBInfo->VGAVT - 1;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToTV))\r\ntempcx -= 5;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x17, temp);\r\ntemp = temp2 | ((tempcx & 0xFF00) >> 8);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x15, temp);\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x0D, 0x08);\r\ntempcx = pVBInfo->VBInfo;\r\ntempbx = pVBInfo->VGAHDE;\r\nif (modeflag & HalfDCLK)\r\ntempbx >>= 1;\r\nif (XGI_IsLCDDualLink(pVBInfo))\r\ntempbx >>= 1;\r\nif (tempcx & SetCRT2ToHiVision) {\r\ntemp = 0;\r\nif (tempbx <= 1024)\r\ntemp = 0xA0;\r\nif (tempbx == 1280)\r\ntemp = 0xC0;\r\n} else if (tempcx & SetCRT2ToTV) {\r\ntemp = 0xA0;\r\nif (tempbx <= 800)\r\ntemp = 0x80;\r\n} else {\r\ntemp = 0x80;\r\nif (pVBInfo->VBInfo & SetCRT2ToLCD) {\r\ntemp = 0;\r\nif (tempbx > 800)\r\ntemp = 0x60;\r\n}\r\n}\r\nif (pVBInfo->TVInfo & (TVSetYPbPr525p | TVSetYPbPr750p)) {\r\ntemp = 0x00;\r\nif (pVBInfo->VGAHDE == 1280)\r\ntemp = 0x40;\r\nif (pVBInfo->VGAHDE == 1024)\r\ntemp = 0x20;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x0E, ~0xEF, temp);\r\ntempebx = pVBInfo->VDE;\r\ntempcx = pVBInfo->RVBHRS;\r\ntemp = tempcx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x18, temp);\r\ntempeax = pVBInfo->VGAVDE;\r\ntempcx |= 0x04000;\r\nif (tempeax <= tempebx) {\r\ntempcx = (tempcx & (~0x4000));\r\ntempeax = pVBInfo->VGAVDE;\r\n} else {\r\ntempeax -= tempebx;\r\n}\r\ntemplong = (tempeax * 256 * 1024) % tempebx;\r\ntempeax = (tempeax * 256 * 1024) / tempebx;\r\ntempebx = tempeax;\r\nif (templong != 0)\r\ntempebx++;\r\ntemp = (unsigned short) (tempebx & 0x000000FF);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x1B, temp);\r\ntemp = (unsigned short) ((tempebx & 0x0000FF00) >> 8);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x1A, temp);\r\ntempbx = (unsigned short) (tempebx >> 16);\r\ntemp = tempbx & 0x00FF;\r\ntemp <<= 4;\r\ntemp |= ((tempcx & 0xFF00) >> 8);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x19, temp);\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntemp = 0x0028;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x1C, temp);\r\ntempax = pVBInfo->VGAHDE;\r\nif (modeflag & HalfDCLK)\r\ntempax >>= 1;\r\nif (XGI_IsLCDDualLink(pVBInfo))\r\ntempax >>= 1;\r\nif (pVBInfo->VBInfo & SetCRT2ToLCD) {\r\nif (tempax > 800)\r\ntempax -= 800;\r\n} else if (pVBInfo->VGAHDE > 800) {\r\nif (pVBInfo->VGAHDE == 1024)\r\ntempax = (tempax * 25 / 32) - 1;\r\nelse\r\ntempax = (tempax * 20 / 32) - 1;\r\n}\r\ntempax -= 1;\r\ntemp = (tempax & 0xFF00) >> 8;\r\ntemp = (temp & 0x0003) << 4;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x1E, temp);\r\ntemp = (tempax & 0x00FF);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x1D, temp);\r\nif (pVBInfo->VBInfo & (SetCRT2ToTV | SetCRT2ToHiVision)) {\r\nif (pVBInfo->VGAHDE > 800)\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x1E, 0x08);\r\n}\r\ntemp = 0x0036;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (!(pVBInfo->TVInfo & (NTSC1024x768\r\n| TVSetYPbPr525p | TVSetYPbPr750p\r\n| TVSetHiVision))) {\r\ntemp |= 0x0001;\r\nif ((pVBInfo->VBInfo & SetInSlaveMode)\r\n&& (!(pVBInfo->TVInfo\r\n& TVSimuMode)))\r\ntemp &= (~0x0001);\r\n}\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x1F, 0x00C0, temp);\r\ntempbx = pVBInfo->HT;\r\nif (XGI_IsLCDDualLink(pVBInfo))\r\ntempbx >>= 1;\r\ntempbx = (tempbx >> 1) - 2;\r\ntemp = ((tempbx & 0x0700) >> 8) << 3;\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x21, 0x00C0, temp);\r\ntemp = tempbx & 0x00FF;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x22, temp);\r\n}\r\nXGI_SetCRT2VCLK(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\n}\r\nstatic void XGINew_EnableCRT2(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x1E, 0xFF, 0x20);\r\n}\r\nstatic void XGI_SetGroup5(struct vb_device_info *pVBInfo)\r\n{\r\nif (pVBInfo->ModeType == ModeVGA) {\r\nif (!(pVBInfo->VBInfo & (SetInSlaveMode | LoadDACFlag\r\n| DisableCRT2Display))) {\r\nXGINew_EnableCRT2(pVBInfo);\r\n}\r\n}\r\n}\r\nstatic void XGI_DisableGatingCRT(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x63, 0xBF, 0x00);\r\n}\r\nstatic unsigned char XGI_XG21CheckLVDSMode(struct xgifb_video_info *xgifb_info,\r\nunsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short xres, yres, colordepth, modeflag, resindex;\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nxres = XGI330_ModeResInfo[resindex].HTotal;\r\nyres = XGI330_ModeResInfo[resindex].VTotal;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif (!(modeflag & Charx8Dot)) {\r\nxres /= 9;\r\nxres *= 8;\r\n}\r\nif ((ModeNo > 0x13) && (modeflag & HalfDCLK))\r\nxres *= 2;\r\nif ((ModeNo > 0x13) && (modeflag & DoubleScanMode))\r\nyres *= 2;\r\nif (xres > xgifb_info->lvds_data.LVDSHDE)\r\nreturn 0;\r\nif (yres > xgifb_info->lvds_data.LVDSVDE)\r\nreturn 0;\r\nif (xres != xgifb_info->lvds_data.LVDSHDE ||\r\nyres != xgifb_info->lvds_data.LVDSVDE) {\r\ncolordepth = XGI_GetColorDepth(ModeIdIndex);\r\nif (colordepth > 2)\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void xgifb_set_lvds(struct xgifb_video_info *xgifb_info,\r\nint chip_id,\r\nunsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char temp, Miscdata;\r\nunsigned short xres, yres, modeflag, resindex;\r\nunsigned short LVDSHT, LVDSHBS, LVDSHRS, LVDSHRE, LVDSHBE;\r\nunsigned short LVDSVT, LVDSVBS, LVDSVRS, LVDSVRE, LVDSVBE;\r\nunsigned short value;\r\ntemp = (unsigned char) ((xgifb_info->lvds_data.LVDS_Capability &\r\n(LCDPolarity << 8)) >> 8);\r\ntemp &= LCDPolarity;\r\nMiscdata = inb(pVBInfo->P3cc);\r\noutb((Miscdata & 0x3F) | temp, pVBInfo->P3c2);\r\ntemp = xgifb_info->lvds_data.LVDS_Capability & LCDPolarity;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x35, ~0x80, temp & 0x80);\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x30, ~0x20, (temp & 0x40) >> 1);\r\nif (chip_id == XG27)\r\nXGI_SetXG27FPBits(pVBInfo);\r\nelse\r\nXGI_SetXG21FPBits(pVBInfo);\r\nresindex = XGI330_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nxres = XGI330_ModeResInfo[resindex].HTotal;\r\nyres = XGI330_ModeResInfo[resindex].VTotal;\r\nmodeflag = XGI330_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nif (!(modeflag & Charx8Dot))\r\nxres = xres * 8 / 9;\r\nLVDSHT = xgifb_info->lvds_data.LVDSHT;\r\nLVDSHBS = xres + (xgifb_info->lvds_data.LVDSHDE - xres) / 2;\r\nif (LVDSHBS > LVDSHT)\r\nLVDSHBS -= LVDSHT;\r\nLVDSHRS = LVDSHBS + xgifb_info->lvds_data.LVDSHFP;\r\nif (LVDSHRS > LVDSHT)\r\nLVDSHRS -= LVDSHT;\r\nLVDSHRE = LVDSHRS + xgifb_info->lvds_data.LVDSHSYNC;\r\nif (LVDSHRE > LVDSHT)\r\nLVDSHRE -= LVDSHT;\r\nLVDSHBE = LVDSHBS + LVDSHT - xgifb_info->lvds_data.LVDSHDE;\r\nLVDSVT = xgifb_info->lvds_data.LVDSVT;\r\nLVDSVBS = yres + (xgifb_info->lvds_data.LVDSVDE - yres) / 2;\r\nif (modeflag & DoubleScanMode)\r\nLVDSVBS += yres / 2;\r\nif (LVDSVBS > LVDSVT)\r\nLVDSVBS -= LVDSVT;\r\nLVDSVRS = LVDSVBS + xgifb_info->lvds_data.LVDSVFP;\r\nif (LVDSVRS > LVDSVT)\r\nLVDSVRS -= LVDSVT;\r\nLVDSVRE = LVDSVRS + xgifb_info->lvds_data.LVDSVSYNC;\r\nif (LVDSVRE > LVDSVT)\r\nLVDSVRE -= LVDSVT;\r\nLVDSVBE = LVDSVBS + LVDSVT - xgifb_info->lvds_data.LVDSVDE;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x11);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, temp & 0x7f);\r\nif (!(modeflag & Charx8Dot))\r\nxgifb_reg_or(pVBInfo->P3c4, 0x1, 0x1);\r\nvalue = (LVDSHT >> 3) - 5;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0B, ~0x03, (value & 0x300) >> 8);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x0, (value & 0xFF));\r\nvalue = (LVDSHBS >> 3) - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0B, ~0x30, (value & 0x300) >> 4);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x2, (value & 0xFF));\r\nvalue = (LVDSHBE >> 3) - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0C, ~0x03, (value & 0xC0) >> 6);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x05, ~0x80, (value & 0x20) << 2);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x03, ~0x1F, value & 0x1F);\r\nvalue = (LVDSHRS >> 3) + 2;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0B, ~0xC0, (value & 0x300) >> 2);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4, (value & 0xFF));\r\nvalue--;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x2F, ~0x03, (value & 0x300) >> 8);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2E, (value & 0xFF));\r\nvalue = (LVDSHRE >> 3) + 2;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0C, ~0x04, (value & 0x20) >> 3);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x05, ~0x1F, value & 0x1F);\r\nvalue--;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x2F, ~0xFC, value << 2);\r\nvalue = LVDSVT - 2;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0A, ~0x01, (value & 0x400) >> 10);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x20, (value & 0x200) >> 4);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x01, (value & 0x100) >> 8);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x06, (value & 0xFF));\r\nvalue = LVDSVBS - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0A, ~0x04, (value & 0x400) >> 8);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x09, ~0x20, (value & 0x200) >> 4);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x08, (value & 0x100) >> 5);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x15, (value & 0xFF));\r\nvalue = LVDSVBE - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0A, ~0x10, (value & 0x100) >> 4);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x16, (value & 0xFF));\r\nvalue = LVDSVRS - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0A, ~0x08, (value & 0x400) >> 7);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x80, (value & 0x200) >> 2);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x07, ~0x04, (value & 0x100) >> 6);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x10, (value & 0xFF));\r\nif (chip_id == XG27) {\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x35, ~0x07,\r\n(value & 0x700) >> 8);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x34, value & 0xFF);\r\n} else {\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x3F, ~0x03,\r\n(value & 0x600) >> 9);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x34, (value >> 1) & 0xFF);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x33, ~0x01, value & 0x01);\r\n}\r\nvalue = LVDSVRE - 1;\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x0A, ~0x20, (value & 0x10) << 1);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x11, ~0x0F, value & 0x0F);\r\nif (chip_id == XG27)\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x3F, ~0xFC,\r\n(value << 2) & 0xFC);\r\nelse\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x3F, ~0xFC,\r\n(value << 2) & 0x7C);\r\nfor (temp = 0, value = 0; temp < 3; temp++) {\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x31, ~0x30, value);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x2B, xgifb_info->lvds_data.VCLKData1);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x2C, xgifb_info->lvds_data.VCLKData2);\r\nvalue += 0x10;\r\n}\r\nif (!(modeflag & Charx8Dot)) {\r\ninb(pVBInfo->P3da);\r\noutb(0x13, pVBInfo->P3c0);\r\noutb(0x00, pVBInfo->P3c0);\r\ninb(pVBInfo->P3da);\r\noutb(0x20, pVBInfo->P3c0);\r\ninb(pVBInfo->P3da);\r\n}\r\n}\r\nstatic unsigned char XGI_IsLCDON(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempax;\r\ntempax = pVBInfo->VBInfo;\r\nif (tempax & SetCRT2ToDualEdge)\r\nreturn 0;\r\nelse if (tempax & (DisableCRT2Display | SwitchCRT2 | SetSimuScanMode))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void XGI_DisableBridge(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempah = 0;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempah = 0x3F;\r\nif (!(pVBInfo->VBInfo &\r\n(DisableCRT2Display | SetSimuScanMode))) {\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) {\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge)\r\ntempah = 0x7F;\r\n}\r\n}\r\nxgifb_reg_and(pVBInfo->Part4Port, 0x1F, tempah);\r\nif (pVBInfo->VBType & (VB_SIS302LV | VB_XGI301C)) {\r\nif (((pVBInfo->VBInfo &\r\n(SetCRT2ToLCD | XGI_SetCRT2ToLCDA))) ||\r\n(XGI_IsLCDON(pVBInfo)))\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x30, 0x80);\r\n}\r\nif (pVBInfo->VBInfo & (DisableCRT2Display | XGI_SetCRT2ToLCDA |\r\nSetSimuScanMode))\r\nXGI_DisplayOff(xgifb_info, HwDeviceExtension, pVBInfo);\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)\r\nxgifb_reg_and(pVBInfo->Part1Port, 0x1e, 0xdf);\r\nxgifb_reg_and(pVBInfo->P3c4, 0x32, 0xdf);\r\nif ((pVBInfo->VBInfo & (SetSimuScanMode | SetCRT2ToDualEdge)))\r\nxgifb_reg_and(pVBInfo->Part2Port, 0x00, 0xdf);\r\nif ((pVBInfo->VBInfo &\r\n(DisableCRT2Display | SetSimuScanMode)) ||\r\n((!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)) &&\r\n(pVBInfo->VBInfo &\r\n(SetCRT2ToRAMDAC | SetCRT2ToLCD | SetCRT2ToTV))))\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x00, 0x80);\r\nif ((pVBInfo->VBInfo &\r\n(DisableCRT2Display | SetSimuScanMode)) ||\r\n(!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)) ||\r\n(pVBInfo->VBInfo &\r\n(SetCRT2ToRAMDAC | SetCRT2ToLCD | SetCRT2ToTV))) {\r\ntempah = xgifb_reg_get(pVBInfo->Part1Port, 0x00);\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x00, 0x10);\r\nxgifb_reg_and(pVBInfo->Part1Port, 0x1E, 0xDF);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x00, tempah);\r\n}\r\n} else {\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | SetCRT2ToTV)) {\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x00, 0x80);\r\nxgifb_reg_and(pVBInfo->Part1Port, 0x1E, 0xDF);\r\nxgifb_reg_and(pVBInfo->P3c4, 0x32, 0xDF);\r\n}\r\nif (pVBInfo->VBInfo & (DisableCRT2Display | XGI_SetCRT2ToLCDA\r\n| SetSimuScanMode))\r\nXGI_DisplayOff(xgifb_info, HwDeviceExtension, pVBInfo);\r\n}\r\n}\r\nstatic unsigned short XGI_GetTVPtrIndex(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx = 0;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\ntempbx = 2;\r\nif (pVBInfo->TVInfo & TVSetHiVision)\r\ntempbx = 4;\r\nif (pVBInfo->TVInfo & TVSetYPbPr525i)\r\ntempbx = 6;\r\nif (pVBInfo->TVInfo & TVSetYPbPr525p)\r\ntempbx = 8;\r\nif (pVBInfo->TVInfo & TVSetYPbPr750p)\r\ntempbx = 10;\r\nif (pVBInfo->TVInfo & TVSimuMode)\r\ntempbx++;\r\nreturn tempbx;\r\n}\r\nstatic void XGI_GetTVPtrIndex2(unsigned short *tempbx, unsigned char *tempcl,\r\nunsigned char *tempch, struct vb_device_info *pVBInfo)\r\n{\r\n*tempbx = 0;\r\n*tempcl = 0;\r\n*tempch = 0;\r\nif (pVBInfo->TVInfo & TVSetPAL)\r\n*tempbx = 1;\r\nif (pVBInfo->TVInfo & TVSetPALM)\r\n*tempbx = 2;\r\nif (pVBInfo->TVInfo & TVSetPALN)\r\n*tempbx = 3;\r\nif (pVBInfo->TVInfo & NTSC1024x768) {\r\n*tempbx = 4;\r\nif (pVBInfo->TVInfo & TVSetPALM)\r\n*tempbx = 5;\r\n}\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif ((!(pVBInfo->VBInfo & SetInSlaveMode)) || (pVBInfo->TVInfo\r\n& TVSimuMode)) {\r\n*tempbx += 8;\r\n*tempcl += 1;\r\n}\r\n}\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C))\r\n(*tempch)++;\r\n}\r\nstatic void XGI_SetDelayComp(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char tempah, tempbl, tempbh;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA\r\n| SetCRT2ToTV | SetCRT2ToRAMDAC)) {\r\ntempbh = 0;\r\ntempbl = XGI301TVDelay;\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge)\r\ntempbl >>= 4;\r\nif (pVBInfo->VBInfo &\r\n(SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\ntempbh = XGI301LCDDelay;\r\nif (!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA))\r\ntempbl = tempbh;\r\n}\r\ntempbl &= 0x0F;\r\ntempbh &= 0xF0;\r\ntempah = xgifb_reg_get(pVBInfo->Part1Port, 0x2D);\r\nif (pVBInfo->VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToLCD\r\n| SetCRT2ToTV)) {\r\ntempah &= 0xF0;\r\ntempah |= tempbl;\r\n}\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) {\r\ntempah &= 0x0F;\r\ntempah |= tempbh;\r\n}\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x2D, tempah);\r\n}\r\n}\r\n}\r\nstatic void XGI_SetLCDCap_A(unsigned short tempcx,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x37);\r\nif (temp & LCDRGB18Bit) {\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x19, 0x0F,\r\n(unsigned short) (0x20 | (tempcx & 0x00C0)));\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x1A, 0x7F, 0x80);\r\n} else {\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x19, 0x0F,\r\n(unsigned short) (0x30 | (tempcx & 0x00C0)));\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x1A, 0x7F, 0x00);\r\n}\r\n}\r\nstatic void XGI_SetLCDCap_B(unsigned short tempcx,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nif (tempcx & EnableLCD24bpp)\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x1A, 0xE0,\r\n(unsigned short) (((tempcx & 0x00ff) >> 6)\r\n| 0x0c));\r\nelse\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x1A, 0xE0,\r\n(unsigned short) (((tempcx & 0x00ff) >> 6)\r\n| 0x18));\r\n}\r\nstatic void XGI_LongWait(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short i;\r\ni = xgifb_reg_get(pVBInfo->P3c4, 0x1F);\r\nif (!(i & 0xC0)) {\r\nfor (i = 0; i < 0xFFFF; i++) {\r\nif (!(inb(pVBInfo->P3da) & 0x08))\r\nbreak;\r\n}\r\nfor (i = 0; i < 0xFFFF; i++) {\r\nif ((inb(pVBInfo->P3da) & 0x08))\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void SetSpectrum(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short index;\r\nindex = XGI_GetLCDCapPtr(pVBInfo);\r\nxgifb_reg_and(pVBInfo->Part4Port, 0x30, 0x8F);\r\nXGI_LongWait(pVBInfo);\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x30, 0x20);\r\nXGI_LongWait(pVBInfo);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x31,\r\npVBInfo->LCDCapList[index].Spectrum_31);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x32,\r\npVBInfo->LCDCapList[index].Spectrum_32);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x33,\r\npVBInfo->LCDCapList[index].Spectrum_33);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x34,\r\npVBInfo->LCDCapList[index].Spectrum_34);\r\nXGI_LongWait(pVBInfo);\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x30, 0x40);\r\n}\r\nstatic void XGI_SetLCDCap(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempcx;\r\ntempcx = pVBInfo->LCDCapList[XGI_GetLCDCapPtr(pVBInfo)].LCD_Capability;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV |\r\nVB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBType &\r\n(VB_SIS301LV | VB_SIS302LV | VB_XGI301C)) {\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x24,\r\n(unsigned char) (tempcx & 0x1F));\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x0D,\r\n~((EnableVBCLKDRVLOW | EnablePLLSPLOW) >> 8),\r\n(unsigned short) ((tempcx & (EnableVBCLKDRVLOW\r\n| EnablePLLSPLOW)) >> 8));\r\nif (pVBInfo->VBInfo & SetCRT2ToLCD)\r\nXGI_SetLCDCap_B(tempcx, pVBInfo);\r\nelse if (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)\r\nXGI_SetLCDCap_A(tempcx, pVBInfo);\r\nif (pVBInfo->VBType & (VB_SIS302LV | VB_XGI301C)) {\r\nif (tempcx & EnableSpectrum)\r\nSetSpectrum(pVBInfo);\r\n}\r\n} else {\r\nXGI_SetLCDCap_A(tempcx, pVBInfo);\r\n}\r\n}\r\nstatic void XGI_SetAntiFlicker(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx;\r\nunsigned char tempah;\r\nif (pVBInfo->TVInfo & (TVSetYPbPr525p | TVSetYPbPr750p))\r\nreturn;\r\ntempbx = XGI_GetTVPtrIndex(pVBInfo);\r\ntempbx &= 0xFE;\r\ntempah = TVAntiFlickList[tempbx];\r\ntempah <<= 4;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x0A, 0x8F, tempah);\r\n}\r\nstatic void XGI_SetEdgeEnhance(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx;\r\nunsigned char tempah;\r\ntempbx = XGI_GetTVPtrIndex(pVBInfo);\r\ntempbx &= 0xFE;\r\ntempah = TVEdgeList[tempbx];\r\ntempah <<= 5;\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x3A, 0x1F, tempah);\r\n}\r\nstatic void XGI_SetPhaseIncr(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx;\r\nunsigned char tempcl, tempch;\r\nunsigned long tempData;\r\nXGI_GetTVPtrIndex2(&tempbx, &tempcl, &tempch, pVBInfo);\r\ntempData = TVPhaseList[tempbx];\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x31, (unsigned short) (tempData\r\n& 0x000000FF));\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x32, (unsigned short) ((tempData\r\n& 0x0000FF00) >> 8));\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x33, (unsigned short) ((tempData\r\n& 0x00FF0000) >> 16));\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x34, (unsigned short) ((tempData\r\n& 0xFF000000) >> 24));\r\n}\r\nstatic void XGI_SetYFilter(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx, index;\r\nunsigned char const *filterPtr;\r\nunsigned char tempcl, tempch, tempal;\r\nXGI_GetTVPtrIndex2(&tempbx, &tempcl, &tempch, pVBInfo);\r\nswitch (tempbx) {\r\ncase 0x00:\r\ncase 0x04:\r\nfilterPtr = NTSCYFilter1;\r\nbreak;\r\ncase 0x01:\r\nfilterPtr = PALYFilter1;\r\nbreak;\r\ncase 0x02:\r\ncase 0x05:\r\ncase 0x0D:\r\ncase 0x03:\r\nfilterPtr = xgifb_palmn_yfilter1;\r\nbreak;\r\ncase 0x08:\r\ncase 0x0C:\r\ncase 0x0A:\r\ncase 0x0B:\r\ncase 0x09:\r\nfilterPtr = xgifb_yfilter2;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\ntempal = XGI330_EModeIDTable[ModeIdIndex].VB_ExtTVYFilterIndex;\r\nif (tempcl == 0)\r\nindex = tempal * 4;\r\nelse\r\nindex = tempal * 7;\r\nif ((tempcl == 0) && (tempch == 1)) {\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x35, 0);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x36, 0);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x37, 0);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x38, filterPtr[index++]);\r\n} else {\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x35, filterPtr[index++]);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x36, filterPtr[index++]);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x37, filterPtr[index++]);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x38, filterPtr[index++]);\r\n}\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x48, filterPtr[index++]);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x49, filterPtr[index++]);\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x4A, filterPtr[index++]);\r\n}\r\n}\r\nstatic void XGI_OEM310Setting(unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nXGI_SetDelayComp(pVBInfo);\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA))\r\nXGI_SetLCDCap(pVBInfo);\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nXGI_SetPhaseIncr(pVBInfo);\r\nXGI_SetYFilter(ModeIdIndex, pVBInfo);\r\nXGI_SetAntiFlicker(pVBInfo);\r\nif (pVBInfo->VBType & VB_SIS301)\r\nXGI_SetEdgeEnhance(pVBInfo);\r\n}\r\n}\r\nstatic void XGI_SetCRT2ModeRegs(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbl;\r\nshort tempcl;\r\nunsigned char tempah;\r\ntempah = 0;\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\ntempah = xgifb_reg_get(pVBInfo->Part1Port, 0x00);\r\ntempah &= ~0x10;\r\ntempah |= 0x40;\r\nif (pVBInfo->VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToTV\r\n| SetCRT2ToLCD)) {\r\ntempah = 0x40;\r\ntempcl = pVBInfo->ModeType;\r\ntempcl -= ModeVGA;\r\nif (tempcl >= 0) {\r\ntempah = (0x008 >> tempcl);\r\nif (tempah == 0)\r\ntempah = 1;\r\ntempah |= 0x040;\r\n}\r\nif (pVBInfo->VBInfo & SetInSlaveMode)\r\ntempah ^= 0x50;\r\n}\r\n}\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x00, tempah);\r\ntempah = 0x08;\r\ntempbl = 0xf0;\r\nif (pVBInfo->VBInfo & DisableCRT2Display)\r\ngoto reg_and_or;\r\ntempah = 0x00;\r\ntempbl = 0xff;\r\nif (!(pVBInfo->VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToTV |\r\nSetCRT2ToLCD | XGI_SetCRT2ToLCDA)))\r\ngoto reg_and_or;\r\nif ((pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) &&\r\n(!(pVBInfo->VBInfo & SetSimuScanMode))) {\r\ntempbl &= 0xf7;\r\ntempah |= 0x01;\r\ngoto reg_and_or;\r\n}\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) {\r\ntempbl &= 0xf7;\r\ntempah |= 0x01;\r\n}\r\nif (!(pVBInfo->VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToTV | SetCRT2ToLCD)))\r\ngoto reg_and_or;\r\ntempbl &= 0xf8;\r\ntempah = 0x01;\r\nif (!(pVBInfo->VBInfo & SetInSlaveMode))\r\ntempah |= 0x02;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToRAMDAC)) {\r\ntempah = tempah ^ 0x05;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToLCD))\r\ntempah = tempah ^ 0x01;\r\n}\r\nif (!(pVBInfo->VBInfo & SetCRT2ToDualEdge))\r\ntempah |= 0x08;\r\nreg_and_or:\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x2e, tempbl, tempah);\r\nif (pVBInfo->VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToTV | SetCRT2ToLCD\r\n| XGI_SetCRT2ToLCDA)) {\r\ntempah &= (~0x08);\r\nif ((pVBInfo->ModeType == ModeVGA) && (!(pVBInfo->VBInfo\r\n& SetInSlaveMode))) {\r\ntempah |= 0x010;\r\n}\r\ntempah |= 0x080;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\ntempah |= 0x020;\r\nif (pVBInfo->VBInfo & DriverMode)\r\ntempah = tempah ^ 0x20;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x0D, ~0x0BF, tempah);\r\ntempah = 0;\r\nif (pVBInfo->LCDInfo & SetLCDDualLink)\r\ntempah |= 0x40;\r\nif (pVBInfo->VBInfo & SetCRT2ToTV) {\r\nif (pVBInfo->TVInfo & RPLLDIV2XO)\r\ntempah |= 0x40;\r\n}\r\nif ((pVBInfo->LCDResInfo == Panel_1280x1024)\r\n|| (pVBInfo->LCDResInfo == Panel_1280x1024x75))\r\ntempah |= 0x80;\r\nif (pVBInfo->LCDResInfo == Panel_1280x960)\r\ntempah |= 0x80;\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0C, tempah);\r\n}\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\ntempah = 0;\r\ntempbl = 0xfb;\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge) {\r\ntempbl = 0xff;\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)\r\ntempah |= 0x04;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x13, tempbl, tempah);\r\ntempah = 0x00;\r\ntempbl = 0xcf;\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge)\r\ntempah |= 0x30;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x2c, tempbl, tempah);\r\ntempah = 0;\r\ntempbl = 0x3f;\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge)\r\ntempah |= 0xc0;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x21, tempbl, tempah);\r\n}\r\ntempah = 0;\r\ntempbl = 0x7f;\r\nif (!(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)) {\r\ntempbl = 0xff;\r\nif (!(pVBInfo->VBInfo & SetCRT2ToDualEdge))\r\ntempah |= 0x80;\r\n}\r\nxgifb_reg_and_or(pVBInfo->Part4Port, 0x23, tempbl, tempah);\r\nif (pVBInfo->VBType & (VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->LCDInfo & SetLCDDualLink) {\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x27, 0x20);\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x34, 0x10);\r\n}\r\n}\r\n}\r\nvoid XGI_UnLockCRT2(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x2f, 0xFF, 0x01);\r\n}\r\nvoid XGI_LockCRT2(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_and_or(pVBInfo->Part1Port, 0x2F, 0xFE, 0x00);\r\n}\r\nunsigned short XGI_GetRatePtrCRT2(struct xgi_hw_device_info *pXGIHWDE,\r\nunsigned short ModeNo, unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nconst u8 LCDARefreshIndex[] = {\r\n0x00, 0x00, 0x03, 0x01, 0x01, 0x01, 0x01, 0x00 };\r\nunsigned short RefreshRateTableIndex, i, index, temp;\r\nindex = xgifb_reg_get(pVBInfo->P3d4, 0x33);\r\nindex >>= pVBInfo->SelectCRT2Rate;\r\nindex &= 0x0F;\r\nif (pVBInfo->LCDInfo & LCDNonExpanding)\r\nindex = 0;\r\nif (index > 0)\r\nindex--;\r\nif (pVBInfo->SetFlag & ProgrammingCRT2) {\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | XGI_SetCRT2ToLCDA)) {\r\ntemp = LCDARefreshIndex[pVBInfo->LCDResInfo & 0x07];\r\nif (index > temp)\r\nindex = temp;\r\n}\r\n}\r\nRefreshRateTableIndex = XGI330_EModeIDTable[ModeIdIndex].REFindex;\r\nModeNo = XGI330_RefIndex[RefreshRateTableIndex].ModeID;\r\nif (pXGIHWDE->jChipType >= XG20) {\r\nif ((XGI330_RefIndex[RefreshRateTableIndex].XRes == 800) &&\r\n(XGI330_RefIndex[RefreshRateTableIndex].YRes == 600)) {\r\nindex++;\r\n}\r\nif ((XGI330_RefIndex[RefreshRateTableIndex].XRes == 1024) &&\r\n(XGI330_RefIndex[RefreshRateTableIndex].YRes == 768)) {\r\nindex++;\r\n}\r\nif ((XGI330_RefIndex[RefreshRateTableIndex].XRes == 1280) &&\r\n(XGI330_RefIndex[RefreshRateTableIndex].YRes == 1024)) {\r\nindex++;\r\n}\r\n}\r\ni = 0;\r\ndo {\r\nif (XGI330_RefIndex[RefreshRateTableIndex + i].\r\nModeID != ModeNo)\r\nbreak;\r\ntemp = XGI330_RefIndex[RefreshRateTableIndex + i].Ext_InfoFlag;\r\ntemp &= ModeTypeMask;\r\nif (temp < pVBInfo->ModeType)\r\nbreak;\r\ni++;\r\nindex--;\r\n} while (index != 0xFFFF);\r\nif (!(pVBInfo->VBInfo & SetCRT2ToRAMDAC)) {\r\nif (pVBInfo->VBInfo & SetInSlaveMode) {\r\ntemp = XGI330_RefIndex[RefreshRateTableIndex + i - 1].\r\nExt_InfoFlag;\r\nif (temp & InterlaceMode)\r\ni++;\r\n}\r\n}\r\ni--;\r\nif ((pVBInfo->SetFlag & ProgrammingCRT2)) {\r\ntemp = XGI_AjustCRT2Rate(ModeIdIndex, RefreshRateTableIndex,\r\n&i, pVBInfo);\r\n}\r\nreturn RefreshRateTableIndex + i;\r\n}\r\nstatic void XGI_SetLCDAGroup(unsigned short ModeNo, unsigned short ModeIdIndex,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short RefreshRateTableIndex;\r\npVBInfo->SetFlag |= ProgrammingCRT2;\r\nRefreshRateTableIndex = XGI_GetRatePtrCRT2(HwDeviceExtension, ModeNo,\r\nModeIdIndex, pVBInfo);\r\nXGI_GetLVDSResInfo(ModeIdIndex, pVBInfo);\r\nXGI_GetLVDSData(ModeIdIndex, pVBInfo);\r\nXGI_ModCRT1Regs(ModeIdIndex, HwDeviceExtension, pVBInfo);\r\nXGI_SetLVDSRegs(ModeIdIndex, pVBInfo);\r\nXGI_SetCRT2ECLK(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\n}\r\nstatic unsigned char XGI_SetCRT2Group301(unsigned short ModeNo,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short ModeIdIndex, RefreshRateTableIndex;\r\npVBInfo->SetFlag |= ProgrammingCRT2;\r\nXGI_SearchModeID(ModeNo, &ModeIdIndex);\r\npVBInfo->SelectCRT2Rate = 4;\r\nRefreshRateTableIndex = XGI_GetRatePtrCRT2(HwDeviceExtension, ModeNo,\r\nModeIdIndex, pVBInfo);\r\nXGI_SaveCRT2Info(ModeNo, pVBInfo);\r\nXGI_GetCRT2ResInfo(ModeIdIndex, pVBInfo);\r\nXGI_GetCRT2Data(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_PreSetGroup1(ModeNo, ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetGroup1(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetLockRegs(ModeNo, ModeIdIndex, pVBInfo);\r\nXGI_SetGroup2(ModeNo, ModeIdIndex, pVBInfo);\r\nXGI_SetLCDRegs(ModeIdIndex, pVBInfo);\r\nXGI_SetTap4Regs(pVBInfo);\r\nXGI_SetGroup3(ModeIdIndex, pVBInfo);\r\nXGI_SetGroup4(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetCRT2VCLK(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetGroup5(pVBInfo);\r\nXGI_AutoThreshold(pVBInfo);\r\nreturn 1;\r\n}\r\nvoid XGI_SenseCRT1(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CRTCData[17] = { 0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81,\r\n0x0B, 0x3E, 0xE9, 0x0B, 0xDF, 0xE7, 0x04, 0x00, 0x00,\r\n0x05, 0x00 };\r\nunsigned char SR01 = 0, SR1F = 0, SR07 = 0, SR06 = 0;\r\nunsigned char CR17, CR63, SR31;\r\nunsigned short temp;\r\nint i;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x05, 0x86);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x57, 0x4A);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x53, (xgifb_reg_get(\r\npVBInfo->P3d4, 0x53) | 0x02));\r\nSR31 = xgifb_reg_get(pVBInfo->P3c4, 0x31);\r\nCR63 = xgifb_reg_get(pVBInfo->P3d4, 0x63);\r\nSR01 = xgifb_reg_get(pVBInfo->P3c4, 0x01);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x01, (unsigned char) (SR01 & 0xDF));\r\nxgifb_reg_set(pVBInfo->P3d4, 0x63, (unsigned char) (CR63 & 0xBF));\r\nCR17 = xgifb_reg_get(pVBInfo->P3d4, 0x17);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x17, (unsigned char) (CR17 | 0x80));\r\nSR1F = xgifb_reg_get(pVBInfo->P3c4, 0x1F);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x1F, (unsigned char) (SR1F | 0x04));\r\nSR07 = xgifb_reg_get(pVBInfo->P3c4, 0x07);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x07, (unsigned char) (SR07 & 0xFB));\r\nSR06 = xgifb_reg_get(pVBInfo->P3c4, 0x06);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x06, (unsigned char) (SR06 & 0xC3));\r\nxgifb_reg_set(pVBInfo->P3d4, 0x11, 0x00);\r\nfor (i = 0; i < 8; i++)\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) i, CRTCData[i]);\r\nfor (i = 8; i < 11; i++)\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 8),\r\nCRTCData[i]);\r\nfor (i = 11; i < 13; i++)\r\nxgifb_reg_set(pVBInfo->P3d4, (unsigned short) (i + 4),\r\nCRTCData[i]);\r\nfor (i = 13; i < 16; i++)\r\nxgifb_reg_set(pVBInfo->P3c4, (unsigned short) (i - 3),\r\nCRTCData[i]);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x0E, (unsigned char) (CRTCData[16]\r\n& 0xE0));\r\nxgifb_reg_set(pVBInfo->P3c4, 0x31, 0x00);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2B, 0x1B);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x2C, 0xE1);\r\noutb(0x00, pVBInfo->P3c8);\r\nfor (i = 0; i < 256 * 3; i++)\r\noutb(0x0F, (pVBInfo->P3c8 + 1));\r\nmdelay(1);\r\nXGI_WaitDisply(pVBInfo);\r\ntemp = inb(pVBInfo->P3c2);\r\nif (temp & 0x10)\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x32, 0xDF, 0x20);\r\nelse\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x32, 0xDF, 0x00);\r\noutb(0x00, pVBInfo->P3c8);\r\nfor (i = 0; i < 256 * 3; i++)\r\noutb(0, (pVBInfo->P3c8 + 1));\r\nxgifb_reg_set(pVBInfo->P3c4, 0x01, SR01);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x63, CR63);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x31, SR31);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x53, (xgifb_reg_get(\r\npVBInfo->P3d4, 0x53) & 0xFD));\r\nxgifb_reg_set(pVBInfo->P3c4, 0x1F, (unsigned char) SR1F);\r\n}\r\nstatic void XGI_EnableBridge(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempah;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBInfo & SetCRT2ToDualEdge)\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x1E, 0x20);\r\nif (pVBInfo->VBInfo & (SetCRT2ToLCD | SetCRT2ToTV |\r\nSetCRT2ToRAMDAC)) {\r\ntempah = xgifb_reg_get(pVBInfo->P3c4, 0x32);\r\ntempah &= 0xDF;\r\nif (pVBInfo->VBInfo & SetInSlaveMode) {\r\nif (!(pVBInfo->VBInfo & SetCRT2ToRAMDAC))\r\ntempah |= 0x20;\r\n}\r\nxgifb_reg_set(pVBInfo->P3c4, 0x32, tempah);\r\nxgifb_reg_or(pVBInfo->P3c4, 0x1E, 0x20);\r\ntempah = xgifb_reg_get(pVBInfo->Part1Port, 0x2E);\r\nif (!(tempah & 0x80))\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x2E, 0x80);\r\nxgifb_reg_and(pVBInfo->Part1Port, 0x00, 0x7F);\r\n}\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\nxgifb_reg_and_or(pVBInfo->Part2Port, 0x00, ~0xE0,\r\n0x20);\r\nif (pVBInfo->VBType & (VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBInfo &\r\n(SetCRT2ToLCD | XGI_SetCRT2ToLCDA))\r\nxgifb_reg_and(pVBInfo->Part4Port, 0x2A,\r\n0x7F);\r\nxgifb_reg_and(pVBInfo->Part4Port, 0x30, 0x7F);\r\n}\r\n}\r\ntempah = 0x00;\r\nif (!(pVBInfo->VBInfo & DisableCRT2Display)) {\r\ntempah = 0xc0;\r\nif (!(pVBInfo->VBInfo & SetSimuScanMode) &&\r\n(pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) &&\r\n(pVBInfo->VBInfo & SetCRT2ToDualEdge)) {\r\ntempah = tempah & 0x40;\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA)\r\ntempah = tempah ^ 0xC0;\r\n}\r\n}\r\nxgifb_reg_or(pVBInfo->Part4Port, 0x1F, tempah);\r\nXGI_DisableGatingCRT(pVBInfo);\r\nXGI_DisplayOn(xgifb_info, HwDeviceExtension, pVBInfo);\r\n}\r\nelse {\r\nif (pVBInfo->VBInfo & (SetCRT2ToTV | SetCRT2ToLCD\r\n| XGI_SetCRT2ToLCDA))\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x1E, 0x20);\r\ntempah = xgifb_reg_get(pVBInfo->Part1Port, 0x2E);\r\nif (!(tempah & 0x80))\r\nxgifb_reg_or(pVBInfo->Part1Port, 0x2E, 0x80);\r\nxgifb_reg_and(pVBInfo->Part1Port, 0x00, 0x7F);\r\nXGI_DisplayOn(xgifb_info, HwDeviceExtension, pVBInfo);\r\n}\r\n}\r\nstatic void XGI_SetCRT1Group(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned short ModeNo, unsigned short ModeIdIndex,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short RefreshRateTableIndex, temp;\r\nXGI_SetSeqRegs(pVBInfo);\r\noutb(XGI330_StandTable.MISC, pVBInfo->P3c2);\r\nXGI_SetCRTCRegs(pVBInfo);\r\nXGI_SetATTRegs(ModeIdIndex, pVBInfo);\r\nXGI_SetGRCRegs(pVBInfo);\r\nXGI_ClearExt1Regs(pVBInfo);\r\nif (HwDeviceExtension->jChipType == XG27) {\r\nif (pVBInfo->IF_DEF_LVDS == 0)\r\nXGI_SetDefaultVCLK(pVBInfo);\r\n}\r\ntemp = ~ProgrammingCRT2;\r\npVBInfo->SetFlag &= temp;\r\npVBInfo->SelectCRT2Rate = 0;\r\nif (pVBInfo->VBType & (VB_SIS301B | VB_SIS302B | VB_SIS301LV\r\n| VB_SIS302LV | VB_XGI301C)) {\r\nif (pVBInfo->VBInfo & (SetSimuScanMode | XGI_SetCRT2ToLCDA\r\n| SetInSlaveMode)) {\r\npVBInfo->SetFlag |= ProgrammingCRT2;\r\n}\r\n}\r\nRefreshRateTableIndex = XGI_GetRatePtrCRT2(HwDeviceExtension, ModeNo,\r\nModeIdIndex, pVBInfo);\r\nif (RefreshRateTableIndex != 0xFFFF) {\r\nXGI_SetSync(RefreshRateTableIndex, pVBInfo);\r\nXGI_SetCRT1CRTC(ModeIdIndex, RefreshRateTableIndex,\r\npVBInfo, HwDeviceExtension);\r\nXGI_SetCRT1DE(ModeIdIndex, RefreshRateTableIndex, pVBInfo);\r\nXGI_SetCRT1Offset(ModeNo, ModeIdIndex, RefreshRateTableIndex,\r\nHwDeviceExtension, pVBInfo);\r\nXGI_SetCRT1VCLK(ModeIdIndex, HwDeviceExtension,\r\nRefreshRateTableIndex, pVBInfo);\r\n}\r\nif (HwDeviceExtension->jChipType >= XG21) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x38);\r\nif (temp & 0xA0) {\r\nif (HwDeviceExtension->jChipType == XG27)\r\nXGI_SetXG27CRTC(RefreshRateTableIndex, pVBInfo);\r\nelse\r\nXGI_SetXG21CRTC(RefreshRateTableIndex, pVBInfo);\r\nXGI_UpdateXG21CRTC(ModeNo, pVBInfo,\r\nRefreshRateTableIndex);\r\nxgifb_set_lcd(HwDeviceExtension->jChipType,\r\npVBInfo, RefreshRateTableIndex);\r\nif (pVBInfo->IF_DEF_LVDS == 1)\r\nxgifb_set_lvds(xgifb_info,\r\nHwDeviceExtension->jChipType,\r\nModeIdIndex, pVBInfo);\r\n}\r\n}\r\npVBInfo->SetFlag &= (~ProgrammingCRT2);\r\nXGI_SetCRT1FIFO(HwDeviceExtension, pVBInfo);\r\nXGI_SetCRT1ModeRegs(HwDeviceExtension, ModeIdIndex,\r\nRefreshRateTableIndex, pVBInfo);\r\nXGI_LoadDAC(pVBInfo);\r\n}\r\nunsigned char XGISetModeNew(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned short ModeNo)\r\n{\r\nunsigned short ModeIdIndex;\r\nstruct vb_device_info VBINF;\r\nstruct vb_device_info *pVBInfo = &VBINF;\r\npVBInfo->IF_DEF_LVDS = 0;\r\nif (HwDeviceExtension->jChipType >= XG20)\r\npVBInfo->VBType = 0;\r\nXGIRegInit(pVBInfo, xgifb_info->vga_base);\r\nif (HwDeviceExtension->jChipType == XG21) {\r\nif ((xgifb_reg_get(pVBInfo->P3d4, 0x38) & 0xE0) == 0xC0)\r\npVBInfo->IF_DEF_LVDS = 1;\r\n}\r\nif (HwDeviceExtension->jChipType == XG27) {\r\nif ((xgifb_reg_get(pVBInfo->P3d4, 0x38) & 0xE0) == 0xC0) {\r\nif (xgifb_reg_get(pVBInfo->P3d4, 0x30) & 0x20)\r\npVBInfo->IF_DEF_LVDS = 1;\r\n}\r\n}\r\nInitTo330Pointer(HwDeviceExtension->jChipType, pVBInfo);\r\nif (ModeNo & 0x80)\r\nModeNo = ModeNo & 0x7F;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x05, 0x86);\r\nif (HwDeviceExtension->jChipType < XG20)\r\nXGI_UnLockCRT2(pVBInfo);\r\nXGI_SearchModeID(ModeNo, &ModeIdIndex);\r\nif (HwDeviceExtension->jChipType < XG20) {\r\nXGI_GetVBInfo(ModeIdIndex, pVBInfo);\r\nXGI_GetTVInfo(ModeIdIndex, pVBInfo);\r\nXGI_GetLCDInfo(ModeIdIndex, pVBInfo);\r\nXGI_DisableBridge(xgifb_info, HwDeviceExtension, pVBInfo);\r\nif (pVBInfo->VBInfo & (SetSimuScanMode | XGI_SetCRT2ToLCDA) ||\r\n(!(pVBInfo->VBInfo & SwitchCRT2))) {\r\nXGI_SetCRT1Group(xgifb_info, HwDeviceExtension, ModeNo,\r\nModeIdIndex, pVBInfo);\r\nif (pVBInfo->VBInfo & XGI_SetCRT2ToLCDA) {\r\nXGI_SetLCDAGroup(ModeNo, ModeIdIndex,\r\nHwDeviceExtension, pVBInfo);\r\n}\r\n}\r\nif (pVBInfo->VBInfo & (SetSimuScanMode | SwitchCRT2)) {\r\nswitch (HwDeviceExtension->ujVBChipID) {\r\ncase VB_CHIP_301:\r\ncase VB_CHIP_302:\r\nXGI_SetCRT2Group301(ModeNo, HwDeviceExtension,\r\npVBInfo);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nXGI_SetCRT2ModeRegs(pVBInfo);\r\nXGI_OEM310Setting(ModeIdIndex, pVBInfo);\r\nXGI_EnableBridge(xgifb_info, HwDeviceExtension, pVBInfo);\r\n}\r\nelse {\r\nif (pVBInfo->IF_DEF_LVDS == 1)\r\nif (!XGI_XG21CheckLVDSMode(xgifb_info, ModeNo,\r\nModeIdIndex))\r\nreturn 0;\r\npVBInfo->ModeType = XGI330_EModeIDTable[ModeIdIndex].\r\nExt_ModeFlag & ModeTypeMask;\r\npVBInfo->SetFlag = 0;\r\npVBInfo->VBInfo = DisableCRT2Display;\r\nXGI_DisplayOff(xgifb_info, HwDeviceExtension, pVBInfo);\r\nXGI_SetCRT1Group(xgifb_info, HwDeviceExtension, ModeNo,\r\nModeIdIndex, pVBInfo);\r\nXGI_DisplayOn(xgifb_info, HwDeviceExtension, pVBInfo);\r\n}\r\nXGI_UpdateModeInfo(pVBInfo);\r\nif (HwDeviceExtension->jChipType < XG20)\r\nXGI_LockCRT2(pVBInfo);\r\nreturn 1;\r\n}

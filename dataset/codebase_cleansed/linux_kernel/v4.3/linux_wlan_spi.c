static int __init wilc_bus_probe(struct spi_device *spi)\r\n{\r\nPRINT_D(BUS_DBG, "spiModalias: %s\n", spi->modalias);\r\nPRINT_D(BUS_DBG, "spiMax-Speed: %d\n", spi->max_speed_hz);\r\nwilc_spi_dev = spi;\r\nprintk("Driver Initializing success\n");\r\nreturn 0;\r\n}\r\nstatic int __exit wilc_bus_remove(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}\r\nvoid linux_spi_deinit(void *vp)\r\n{\r\nspi_unregister_driver(&wilc_bus);\r\nSPEED = MIN_SPEED;\r\nPRINT_ER("@@@@@@@@@@@@ restore SPI speed to %d @@@@@@@@@\n", SPEED);\r\n}\r\nint linux_spi_init(void *vp)\r\n{\r\nint ret = 1;\r\nstatic int called;\r\nif (called == 0) {\r\ncalled++;\r\nret = spi_register_driver(&wilc_bus);\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_write(uint8_t *b, uint32_t len)\r\n{\r\nint ret;\r\nif (len > 0 && b != NULL) {\r\nstruct spi_message msg;\r\nPRINT_D(BUS_DBG, "Request writing %d bytes\n", len);\r\nstruct spi_transfer tr = {\r\n.tx_buf = b,\r\n.len = len,\r\n.speed_hz = SPEED,\r\n.delay_usecs = 0,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\n} else {\r\nPRINT_ER("can't write data with the following length: %d\n", len);\r\nPRINT_ER("FAILED due to NULL buffer or ZERO length check the following length: %d\n", len);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_write(uint8_t *b, uint32_t len)\r\n{\r\nint ret;\r\nif (len > 0 && b != NULL) {\r\nint i = 0;\r\nint blk = len / TXRX_PHASE_SIZE;\r\nint remainder = len % TXRX_PHASE_SIZE;\r\nchar *r_buffer = kzalloc(TXRX_PHASE_SIZE, GFP_KERNEL);\r\nif (!r_buffer) {\r\nPRINT_ER("Failed to allocate memory for r_buffer\n");\r\n}\r\nif (blk) {\r\nwhile (i < blk) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.tx_buf = b + (i * TXRX_PHASE_SIZE),\r\n.len = TXRX_PHASE_SIZE,\r\n.speed_hz = SPEED,\r\n.bits_per_word = 8,\r\n.delay_usecs = 0,\r\n};\r\ntr.rx_buf = r_buffer;\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\ni++;\r\n}\r\n}\r\nif (remainder) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.tx_buf = b + (blk * TXRX_PHASE_SIZE),\r\n.len = remainder,\r\n.speed_hz = SPEED,\r\n.bits_per_word = 8,\r\n.delay_usecs = 0,\r\n};\r\ntr.rx_buf = r_buffer;\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\n}\r\nkfree(r_buffer);\r\n} else {\r\nPRINT_ER("can't write data with the following length: %d\n", len);\r\nPRINT_ER("FAILED due to NULL buffer or ZERO length check the following length: %d\n", len);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_write(uint8_t *b, uint32_t len)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nif (len > 0 && b != NULL) {\r\nstruct spi_transfer tr = {\r\n.tx_buf = b,\r\n.len = len,\r\n.speed_hz = SPEED,\r\n.delay_usecs = 0,\r\n};\r\nchar *r_buffer = kzalloc(len, GFP_KERNEL);\r\nif (!r_buffer) {\r\nPRINT_ER("Failed to allocate memory for r_buffer\n");\r\n}\r\ntr.rx_buf = r_buffer;\r\nPRINT_D(BUS_DBG, "Request writing %d bytes\n", len);\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\nkfree(r_buffer);\r\n} else {\r\nPRINT_ER("can't write data with the following length: %d\n", len);\r\nPRINT_ER("FAILED due to NULL buffer or ZERO length check the following length: %d\n", len);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_read(unsigned char *rb, unsigned long rlen)\r\n{\r\nint ret;\r\nif (rlen > 0) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.rx_buf = rb,\r\n.len = rlen,\r\n.speed_hz = SPEED,\r\n.delay_usecs = 0,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\n} else {\r\nPRINT_ER("can't read data with the following length: %ld\n", rlen);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_read(unsigned char *rb, unsigned long rlen)\r\n{\r\nint ret;\r\nif (rlen > 0) {\r\nint i = 0;\r\nint blk = rlen / TXRX_PHASE_SIZE;\r\nint remainder = rlen % TXRX_PHASE_SIZE;\r\nchar *t_buffer = kzalloc(TXRX_PHASE_SIZE, GFP_KERNEL);\r\nif (!t_buffer) {\r\nPRINT_ER("Failed to allocate memory for t_buffer\n");\r\n}\r\nif (blk) {\r\nwhile (i < blk) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.rx_buf = rb + (i * TXRX_PHASE_SIZE),\r\n.len = TXRX_PHASE_SIZE,\r\n.speed_hz = SPEED,\r\n.bits_per_word = 8,\r\n.delay_usecs = 0,\r\n};\r\ntr.tx_buf = t_buffer;\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\ni++;\r\n}\r\n}\r\nif (remainder) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.rx_buf = rb + (blk * TXRX_PHASE_SIZE),\r\n.len = remainder,\r\n.speed_hz = SPEED,\r\n.bits_per_word = 8,\r\n.delay_usecs = 0,\r\n};\r\ntr.tx_buf = t_buffer;\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\n}\r\nkfree(t_buffer);\r\n} else {\r\nPRINT_ER("can't read data with the following length: %ld\n", rlen);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_read(unsigned char *rb, unsigned long rlen)\r\n{\r\nint ret;\r\nif (rlen > 0) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.rx_buf = rb,\r\n.len = rlen,\r\n.speed_hz = SPEED,\r\n.delay_usecs = 0,\r\n};\r\nchar *t_buffer = kzalloc(rlen, GFP_KERNEL);\r\nif (!t_buffer) {\r\nPRINT_ER("Failed to allocate memory for t_buffer\n");\r\n}\r\ntr.tx_buf = t_buffer;\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\nkfree(t_buffer);\r\n} else {\r\nPRINT_ER("can't read data with the following length: %ld\n", rlen);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_write_read(unsigned char *wb, unsigned char *rb, unsigned int rlen)\r\n{\r\nint ret;\r\nif (rlen > 0) {\r\nstruct spi_message msg;\r\nstruct spi_transfer tr = {\r\n.rx_buf = rb,\r\n.tx_buf = wb,\r\n.len = rlen,\r\n.speed_hz = SPEED,\r\n.bits_per_word = 8,\r\n.delay_usecs = 0,\r\n};\r\nmemset(&msg, 0, sizeof(msg));\r\nspi_message_init(&msg);\r\nmsg.spi = wilc_spi_dev;\r\nmsg.is_dma_mapped = USE_SPI_DMA;\r\nspi_message_add_tail(&tr, &msg);\r\nret = spi_sync(wilc_spi_dev, &msg);\r\nif (ret < 0) {\r\nPRINT_ER("SPI transaction failed\n");\r\n}\r\n} else {\r\nPRINT_ER("can't read data with the following length: %d\n", rlen);\r\nret = -1;\r\n}\r\n(ret < 0) ? (ret = 0) : (ret = 1);\r\nreturn ret;\r\n}\r\nint linux_spi_set_max_speed(void)\r\n{\r\nSPEED = MAX_SPEED;\r\nPRINT_INFO(BUS_DBG, "@@@@@@@@@@@@ change SPI speed to %d @@@@@@@@@\n", SPEED);\r\nreturn 1;\r\n}

static int huc_ucode_xfer(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_uc_fw *huc_fw = &dev_priv->huc.fw;\r\nstruct i915_vma *vma;\r\nunsigned long offset = 0;\r\nu32 size;\r\nint ret;\r\nret = i915_gem_object_set_to_gtt_domain(huc_fw->obj, false);\r\nif (ret) {\r\nDRM_DEBUG_DRIVER("set-domain failed %d\n", ret);\r\nreturn ret;\r\n}\r\nvma = i915_gem_object_ggtt_pin(huc_fw->obj, NULL, 0, 0,\r\nPIN_OFFSET_BIAS | GUC_WOPCM_TOP);\r\nif (IS_ERR(vma)) {\r\nDRM_DEBUG_DRIVER("pin failed %d\n", (int)PTR_ERR(vma));\r\nreturn PTR_ERR(vma);\r\n}\r\nintel_uncore_forcewake_get(dev_priv, FORCEWAKE_ALL);\r\noffset = guc_ggtt_offset(vma) + huc_fw->header_offset;\r\nI915_WRITE(DMA_ADDR_0_LOW, lower_32_bits(offset));\r\nI915_WRITE(DMA_ADDR_0_HIGH, upper_32_bits(offset) & 0xFFFF);\r\nI915_WRITE(DMA_ADDR_1_LOW, 0);\r\nI915_WRITE(DMA_ADDR_1_HIGH, DMA_ADDRESS_SPACE_WOPCM);\r\nsize = huc_fw->header_size + huc_fw->ucode_size;\r\nI915_WRITE(DMA_COPY_SIZE, size);\r\nI915_WRITE(DMA_CTRL, _MASKED_BIT_ENABLE(HUC_UKERNEL | START_DMA));\r\nret = wait_for((I915_READ(DMA_CTRL) & START_DMA) == 0, 100);\r\nDRM_DEBUG_DRIVER("HuC DMA transfer wait over with ret %d\n", ret);\r\nI915_WRITE(DMA_CTRL, _MASKED_BIT_DISABLE(HUC_UKERNEL));\r\nintel_uncore_forcewake_put(dev_priv, FORCEWAKE_ALL);\r\ni915_vma_unpin(vma);\r\nreturn ret;\r\n}\r\nvoid intel_huc_select_fw(struct intel_huc *huc)\r\n{\r\nstruct drm_i915_private *dev_priv = huc_to_i915(huc);\r\nhuc->fw.path = NULL;\r\nhuc->fw.fetch_status = INTEL_UC_FIRMWARE_NONE;\r\nhuc->fw.load_status = INTEL_UC_FIRMWARE_NONE;\r\nhuc->fw.type = INTEL_UC_FW_TYPE_HUC;\r\nif (i915.huc_firmware_path) {\r\nhuc->fw.path = i915.huc_firmware_path;\r\nhuc->fw.major_ver_wanted = 0;\r\nhuc->fw.minor_ver_wanted = 0;\r\n} else if (IS_SKYLAKE(dev_priv)) {\r\nhuc->fw.path = I915_SKL_HUC_UCODE;\r\nhuc->fw.major_ver_wanted = SKL_HUC_FW_MAJOR;\r\nhuc->fw.minor_ver_wanted = SKL_HUC_FW_MINOR;\r\n} else if (IS_BROXTON(dev_priv)) {\r\nhuc->fw.path = I915_BXT_HUC_UCODE;\r\nhuc->fw.major_ver_wanted = BXT_HUC_FW_MAJOR;\r\nhuc->fw.minor_ver_wanted = BXT_HUC_FW_MINOR;\r\n} else if (IS_KABYLAKE(dev_priv) || IS_COFFEELAKE(dev_priv)) {\r\nhuc->fw.path = I915_KBL_HUC_UCODE;\r\nhuc->fw.major_ver_wanted = KBL_HUC_FW_MAJOR;\r\nhuc->fw.minor_ver_wanted = KBL_HUC_FW_MINOR;\r\n} else if (IS_GEMINILAKE(dev_priv)) {\r\nhuc->fw.path = I915_GLK_HUC_UCODE;\r\nhuc->fw.major_ver_wanted = GLK_HUC_FW_MAJOR;\r\nhuc->fw.minor_ver_wanted = GLK_HUC_FW_MINOR;\r\n} else {\r\nDRM_ERROR("No HuC firmware known for platform with HuC!\n");\r\nreturn;\r\n}\r\n}\r\nvoid intel_huc_init_hw(struct intel_huc *huc)\r\n{\r\nstruct drm_i915_private *dev_priv = huc_to_i915(huc);\r\nint err;\r\nDRM_DEBUG_DRIVER("%s fw status: fetch %s, load %s\n",\r\nhuc->fw.path,\r\nintel_uc_fw_status_repr(huc->fw.fetch_status),\r\nintel_uc_fw_status_repr(huc->fw.load_status));\r\nif (huc->fw.fetch_status != INTEL_UC_FIRMWARE_SUCCESS)\r\nreturn;\r\nhuc->fw.load_status = INTEL_UC_FIRMWARE_PENDING;\r\nerr = huc_ucode_xfer(dev_priv);\r\nhuc->fw.load_status = err ?\r\nINTEL_UC_FIRMWARE_FAIL : INTEL_UC_FIRMWARE_SUCCESS;\r\nDRM_DEBUG_DRIVER("%s fw status: fetch %s, load %s\n",\r\nhuc->fw.path,\r\nintel_uc_fw_status_repr(huc->fw.fetch_status),\r\nintel_uc_fw_status_repr(huc->fw.load_status));\r\nif (huc->fw.load_status != INTEL_UC_FIRMWARE_SUCCESS)\r\nDRM_ERROR("Failed to complete HuC uCode load with ret %d\n", err);\r\nreturn;\r\n}\r\nvoid intel_guc_auth_huc(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_guc *guc = &dev_priv->guc;\r\nstruct intel_huc *huc = &dev_priv->huc;\r\nstruct i915_vma *vma;\r\nint ret;\r\nu32 data[2];\r\nif (huc->fw.load_status != INTEL_UC_FIRMWARE_SUCCESS)\r\nreturn;\r\nvma = i915_gem_object_ggtt_pin(huc->fw.obj, NULL, 0, 0,\r\nPIN_OFFSET_BIAS | GUC_WOPCM_TOP);\r\nif (IS_ERR(vma)) {\r\nDRM_ERROR("failed to pin huc fw object %d\n",\r\n(int)PTR_ERR(vma));\r\nreturn;\r\n}\r\ndata[0] = INTEL_GUC_ACTION_AUTHENTICATE_HUC;\r\ndata[1] = guc_ggtt_offset(vma) + huc->fw.rsa_offset;\r\nret = intel_guc_send(guc, data, ARRAY_SIZE(data));\r\nif (ret) {\r\nDRM_ERROR("HuC: GuC did not ack Auth request %d\n", ret);\r\ngoto out;\r\n}\r\nret = intel_wait_for_register(dev_priv,\r\nHUC_STATUS2,\r\nHUC_FW_VERIFIED,\r\nHUC_FW_VERIFIED,\r\n50);\r\nif (ret) {\r\nDRM_ERROR("HuC: Authentication failed %d\n", ret);\r\ngoto out;\r\n}\r\nout:\r\ni915_vma_unpin(vma);\r\n}

struct cflayer *cfmuxl_create(void)\r\n{\r\nstruct cfmuxl *this = kzalloc(sizeof(struct cfmuxl), GFP_ATOMIC);\r\nif (!this)\r\nreturn NULL;\r\nthis->layer.receive = cfmuxl_receive;\r\nthis->layer.transmit = cfmuxl_transmit;\r\nthis->layer.ctrlcmd = cfmuxl_ctrlcmd;\r\nINIT_LIST_HEAD(&this->srvl_list);\r\nINIT_LIST_HEAD(&this->frml_list);\r\nspin_lock_init(&this->transmit_lock);\r\nspin_lock_init(&this->receive_lock);\r\nsnprintf(this->layer.name, CAIF_LAYER_NAME_SZ, "mux");\r\nreturn &this->layer;\r\n}\r\nint cfmuxl_set_dnlayer(struct cflayer *layr, struct cflayer *dn, u8 phyid)\r\n{\r\nstruct cfmuxl *muxl = (struct cfmuxl *) layr;\r\nspin_lock_bh(&muxl->transmit_lock);\r\nlist_add_rcu(&dn->node, &muxl->frml_list);\r\nspin_unlock_bh(&muxl->transmit_lock);\r\nreturn 0;\r\n}\r\nstatic struct cflayer *get_from_id(struct list_head *list, u16 id)\r\n{\r\nstruct cflayer *lyr;\r\nlist_for_each_entry_rcu(lyr, list, node) {\r\nif (lyr->id == id)\r\nreturn lyr;\r\n}\r\nreturn NULL;\r\n}\r\nint cfmuxl_set_uplayer(struct cflayer *layr, struct cflayer *up, u8 linkid)\r\n{\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nstruct cflayer *old;\r\nspin_lock_bh(&muxl->receive_lock);\r\nold = get_from_id(&muxl->srvl_list, linkid);\r\nif (old != NULL)\r\nlist_del_rcu(&old->node);\r\nlist_add_rcu(&up->node, &muxl->srvl_list);\r\nspin_unlock_bh(&muxl->receive_lock);\r\nreturn 0;\r\n}\r\nstruct cflayer *cfmuxl_remove_dnlayer(struct cflayer *layr, u8 phyid)\r\n{\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nstruct cflayer *dn;\r\nint idx = phyid % DN_CACHE_SIZE;\r\nspin_lock_bh(&muxl->transmit_lock);\r\nRCU_INIT_POINTER(muxl->dn_cache[idx], NULL);\r\ndn = get_from_id(&muxl->frml_list, phyid);\r\nif (dn == NULL)\r\ngoto out;\r\nlist_del_rcu(&dn->node);\r\ncaif_assert(dn != NULL);\r\nout:\r\nspin_unlock_bh(&muxl->transmit_lock);\r\nreturn dn;\r\n}\r\nstatic struct cflayer *get_up(struct cfmuxl *muxl, u16 id)\r\n{\r\nstruct cflayer *up;\r\nint idx = id % UP_CACHE_SIZE;\r\nup = rcu_dereference(muxl->up_cache[idx]);\r\nif (up == NULL || up->id != id) {\r\nspin_lock_bh(&muxl->receive_lock);\r\nup = get_from_id(&muxl->srvl_list, id);\r\nrcu_assign_pointer(muxl->up_cache[idx], up);\r\nspin_unlock_bh(&muxl->receive_lock);\r\n}\r\nreturn up;\r\n}\r\nstatic struct cflayer *get_dn(struct cfmuxl *muxl, struct dev_info *dev_info)\r\n{\r\nstruct cflayer *dn;\r\nint idx = dev_info->id % DN_CACHE_SIZE;\r\ndn = rcu_dereference(muxl->dn_cache[idx]);\r\nif (dn == NULL || dn->id != dev_info->id) {\r\nspin_lock_bh(&muxl->transmit_lock);\r\ndn = get_from_id(&muxl->frml_list, dev_info->id);\r\nrcu_assign_pointer(muxl->dn_cache[idx], dn);\r\nspin_unlock_bh(&muxl->transmit_lock);\r\n}\r\nreturn dn;\r\n}\r\nstruct cflayer *cfmuxl_remove_uplayer(struct cflayer *layr, u8 id)\r\n{\r\nstruct cflayer *up;\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nint idx = id % UP_CACHE_SIZE;\r\nif (id == 0) {\r\npr_warn("Trying to remove control layer\n");\r\nreturn NULL;\r\n}\r\nspin_lock_bh(&muxl->receive_lock);\r\nup = get_from_id(&muxl->srvl_list, id);\r\nif (up == NULL)\r\ngoto out;\r\nRCU_INIT_POINTER(muxl->up_cache[idx], NULL);\r\nlist_del_rcu(&up->node);\r\nout:\r\nspin_unlock_bh(&muxl->receive_lock);\r\nreturn up;\r\n}\r\nstatic int cfmuxl_receive(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nint ret;\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nu8 id;\r\nstruct cflayer *up;\r\nif (cfpkt_extr_head(pkt, &id, 1) < 0) {\r\npr_err("erroneous Caif Packet\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\nrcu_read_lock();\r\nup = get_up(muxl, id);\r\nif (up == NULL) {\r\npr_debug("Received data on unknown link ID = %d (0x%x)"\r\n" up == NULL", id, id);\r\ncfpkt_destroy(pkt);\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\ncfsrvl_get(up);\r\nrcu_read_unlock();\r\nret = up->receive(up, pkt);\r\ncfsrvl_put(up);\r\nreturn ret;\r\n}\r\nstatic int cfmuxl_transmit(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nint err;\r\nu8 linkid;\r\nstruct cflayer *dn;\r\nstruct caif_payload_info *info = cfpkt_info(pkt);\r\nBUG_ON(!info);\r\nrcu_read_lock();\r\ndn = get_dn(muxl, info->dev_info);\r\nif (dn == NULL) {\r\npr_debug("Send data on unknown phy ID = %d (0x%x)\n",\r\ninfo->dev_info->id, info->dev_info->id);\r\nrcu_read_unlock();\r\ncfpkt_destroy(pkt);\r\nreturn -ENOTCONN;\r\n}\r\ninfo->hdr_len += 1;\r\nlinkid = info->channel_id;\r\ncfpkt_add_head(pkt, &linkid, 1);\r\ncffrml_hold(dn);\r\nrcu_read_unlock();\r\nerr = dn->transmit(dn, pkt);\r\ncffrml_put(dn);\r\nreturn err;\r\n}\r\nstatic void cfmuxl_ctrlcmd(struct cflayer *layr, enum caif_ctrlcmd ctrl,\r\nint phyid)\r\n{\r\nstruct cfmuxl *muxl = container_obj(layr);\r\nstruct cflayer *layer;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(layer, &muxl->srvl_list, node) {\r\nif (cfsrvl_phyid_match(layer, phyid) && layer->ctrlcmd) {\r\nif ((ctrl == _CAIF_CTRLCMD_PHYIF_DOWN_IND ||\r\nctrl == CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND) &&\r\nlayer->id != 0)\r\ncfmuxl_remove_uplayer(layr, layer->id);\r\nlayer->ctrlcmd(layer, ctrl, phyid);\r\n}\r\n}\r\nrcu_read_unlock();\r\n}

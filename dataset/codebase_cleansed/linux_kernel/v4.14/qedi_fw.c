void qedi_iscsi_unmap_sg_list(struct qedi_cmd *cmd)\r\n{\r\nstruct scsi_cmnd *sc = cmd->scsi_cmd;\r\nif (cmd->io_tbl.sge_valid && sc) {\r\ncmd->io_tbl.sge_valid = 0;\r\nscsi_dma_unmap(sc);\r\n}\r\n}\r\nstatic void qedi_process_logout_resp(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_logout_rsp *resp_hdr;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_logout_response_hdr *cqe_logout_response;\r\nstruct qedi_cmd *cmd;\r\ncmd = (struct qedi_cmd *)task->dd_data;\r\ncqe_logout_response = &cqe->cqe_common.iscsi_hdr.logout_response;\r\nspin_lock(&session->back_lock);\r\nresp_hdr = (struct iscsi_logout_rsp *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = cqe_logout_response->opcode;\r\nresp_hdr->flags = cqe_logout_response->flags;\r\nresp_hdr->hlength = 0;\r\nresp_hdr->itt = build_itt(cqe->cqe_solicited.itid, conn->session->age);\r\nresp_hdr->statsn = cpu_to_be32(cqe_logout_response->stat_sn);\r\nresp_hdr->exp_cmdsn = cpu_to_be32(cqe_logout_response->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(cqe_logout_response->max_cmd_sn);\r\nresp_hdr->t2wait = cpu_to_be32(cqe_logout_response->time_2_wait);\r\nresp_hdr->t2retain = cpu_to_be32(cqe_logout_response->time_2_retain);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\nif (likely(cmd->io_cmd_in_list)) {\r\ncmd->io_cmd_in_list = false;\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\n} else {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"Active cmd list node already deleted, tid=0x%x, cid=0x%x, io_cmd_node=%p\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id,\r\n&cmd->io_cmd);\r\n}\r\ncmd->state = RESPONSE_RECEIVED;\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr, NULL, 0);\r\nspin_unlock(&session->back_lock);\r\n}\r\nstatic void qedi_process_text_resp(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_task_context *task_ctx;\r\nstruct iscsi_text_rsp *resp_hdr_ptr;\r\nstruct iscsi_text_response_hdr *cqe_text_response;\r\nstruct qedi_cmd *cmd;\r\nint pld_len;\r\nu32 *tmp;\r\ncmd = (struct qedi_cmd *)task->dd_data;\r\ntask_ctx = qedi_get_task_mem(&qedi->tasks, cmd->task_id);\r\ncqe_text_response = &cqe->cqe_common.iscsi_hdr.text_response;\r\nspin_lock(&session->back_lock);\r\nresp_hdr_ptr = (struct iscsi_text_rsp *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr_ptr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr_ptr->opcode = cqe_text_response->opcode;\r\nresp_hdr_ptr->flags = cqe_text_response->flags;\r\nresp_hdr_ptr->hlength = 0;\r\nhton24(resp_hdr_ptr->dlength,\r\n(cqe_text_response->hdr_second_dword &\r\nISCSI_TEXT_RESPONSE_HDR_DATA_SEG_LEN_MASK));\r\ntmp = (u32 *)resp_hdr_ptr->dlength;\r\nresp_hdr_ptr->itt = build_itt(cqe->cqe_solicited.itid,\r\nconn->session->age);\r\nresp_hdr_ptr->ttt = cqe_text_response->ttt;\r\nresp_hdr_ptr->statsn = cpu_to_be32(cqe_text_response->stat_sn);\r\nresp_hdr_ptr->exp_cmdsn = cpu_to_be32(cqe_text_response->exp_cmd_sn);\r\nresp_hdr_ptr->max_cmdsn = cpu_to_be32(cqe_text_response->max_cmd_sn);\r\npld_len = cqe_text_response->hdr_second_dword &\r\nISCSI_TEXT_RESPONSE_HDR_DATA_SEG_LEN_MASK;\r\nqedi_conn->gen_pdu.resp_wr_ptr = qedi_conn->gen_pdu.resp_buf + pld_len;\r\nmemset(task_ctx, '\0', sizeof(*task_ctx));\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\nif (likely(cmd->io_cmd_in_list)) {\r\ncmd->io_cmd_in_list = false;\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\n} else {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"Active cmd list node already deleted, tid=0x%x, cid=0x%x, io_cmd_node=%p\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id,\r\n&cmd->io_cmd);\r\n}\r\ncmd->state = RESPONSE_RECEIVED;\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr_ptr,\r\nqedi_conn->gen_pdu.resp_buf,\r\n(qedi_conn->gen_pdu.resp_wr_ptr -\r\nqedi_conn->gen_pdu.resp_buf));\r\nspin_unlock(&session->back_lock);\r\n}\r\nstatic void qedi_tmf_resp_work(struct work_struct *work)\r\n{\r\nstruct qedi_cmd *qedi_cmd =\r\ncontainer_of(work, struct qedi_cmd, tmf_work);\r\nstruct qedi_conn *qedi_conn = qedi_cmd->conn;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_tm_rsp *resp_hdr_ptr;\r\nstruct iscsi_cls_session *cls_sess;\r\nint rval = 0;\r\nset_bit(QEDI_CONN_FW_CLEANUP, &qedi_conn->flags);\r\nresp_hdr_ptr = (struct iscsi_tm_rsp *)qedi_cmd->tmf_resp_buf;\r\ncls_sess = iscsi_conn_to_session(qedi_conn->cls_conn);\r\niscsi_block_session(session->cls_session);\r\nrval = qedi_cleanup_all_io(qedi, qedi_conn, qedi_cmd->task, true);\r\nif (rval) {\r\nqedi_clear_task_idx(qedi, qedi_cmd->task_id);\r\niscsi_unblock_session(session->cls_session);\r\ngoto exit_tmf_resp;\r\n}\r\niscsi_unblock_session(session->cls_session);\r\nqedi_clear_task_idx(qedi, qedi_cmd->task_id);\r\nspin_lock(&session->back_lock);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr_ptr, NULL, 0);\r\nspin_unlock(&session->back_lock);\r\nexit_tmf_resp:\r\nkfree(resp_hdr_ptr);\r\nclear_bit(QEDI_CONN_FW_CLEANUP, &qedi_conn->flags);\r\n}\r\nstatic void qedi_process_tmf_resp(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_tmf_response_hdr *cqe_tmp_response;\r\nstruct iscsi_tm_rsp *resp_hdr_ptr;\r\nstruct iscsi_tm *tmf_hdr;\r\nstruct qedi_cmd *qedi_cmd = NULL;\r\nu32 *tmp;\r\ncqe_tmp_response = &cqe->cqe_common.iscsi_hdr.tmf_response;\r\nqedi_cmd = task->dd_data;\r\nqedi_cmd->tmf_resp_buf = kzalloc(sizeof(*resp_hdr_ptr), GFP_KERNEL);\r\nif (!qedi_cmd->tmf_resp_buf) {\r\nQEDI_ERR(&qedi->dbg_ctx,\r\n"Failed to allocate resp buf, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\nreturn;\r\n}\r\nspin_lock(&session->back_lock);\r\nresp_hdr_ptr = (struct iscsi_tm_rsp *)qedi_cmd->tmf_resp_buf;\r\nmemset(resp_hdr_ptr, 0, sizeof(struct iscsi_tm_rsp));\r\nresp_hdr_ptr->opcode = cqe_tmp_response->opcode;\r\nresp_hdr_ptr->flags = cqe_tmp_response->hdr_flags;\r\nresp_hdr_ptr->response = cqe_tmp_response->hdr_response;\r\nresp_hdr_ptr->hlength = 0;\r\nhton24(resp_hdr_ptr->dlength,\r\n(cqe_tmp_response->hdr_second_dword &\r\nISCSI_TMF_RESPONSE_HDR_DATA_SEG_LEN_MASK));\r\ntmp = (u32 *)resp_hdr_ptr->dlength;\r\nresp_hdr_ptr->itt = build_itt(cqe->cqe_solicited.itid,\r\nconn->session->age);\r\nresp_hdr_ptr->statsn = cpu_to_be32(cqe_tmp_response->stat_sn);\r\nresp_hdr_ptr->exp_cmdsn = cpu_to_be32(cqe_tmp_response->exp_cmd_sn);\r\nresp_hdr_ptr->max_cmdsn = cpu_to_be32(cqe_tmp_response->max_cmd_sn);\r\ntmf_hdr = (struct iscsi_tm *)qedi_cmd->task->hdr;\r\nif (likely(qedi_cmd->io_cmd_in_list)) {\r\nqedi_cmd->io_cmd_in_list = false;\r\nlist_del_init(&qedi_cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\n}\r\nif (((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_LOGICAL_UNIT_RESET) ||\r\n((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_TARGET_WARM_RESET) ||\r\n((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_TARGET_COLD_RESET)) {\r\nINIT_WORK(&qedi_cmd->tmf_work, qedi_tmf_resp_work);\r\nqueue_work(qedi->tmf_thread, &qedi_cmd->tmf_work);\r\ngoto unblock_sess;\r\n}\r\nqedi_clear_task_idx(qedi, qedi_cmd->task_id);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr_ptr, NULL, 0);\r\nkfree(resp_hdr_ptr);\r\nunblock_sess:\r\nspin_unlock(&session->back_lock);\r\n}\r\nstatic void qedi_process_login_resp(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_task_context *task_ctx;\r\nstruct iscsi_login_rsp *resp_hdr_ptr;\r\nstruct iscsi_login_response_hdr *cqe_login_response;\r\nstruct qedi_cmd *cmd;\r\nint pld_len;\r\nu32 *tmp;\r\ncmd = (struct qedi_cmd *)task->dd_data;\r\ncqe_login_response = &cqe->cqe_common.iscsi_hdr.login_response;\r\ntask_ctx = qedi_get_task_mem(&qedi->tasks, cmd->task_id);\r\nspin_lock(&session->back_lock);\r\nresp_hdr_ptr = (struct iscsi_login_rsp *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr_ptr, 0, sizeof(struct iscsi_login_rsp));\r\nresp_hdr_ptr->opcode = cqe_login_response->opcode;\r\nresp_hdr_ptr->flags = cqe_login_response->flags_attr;\r\nresp_hdr_ptr->hlength = 0;\r\nhton24(resp_hdr_ptr->dlength,\r\n(cqe_login_response->hdr_second_dword &\r\nISCSI_LOGIN_RESPONSE_HDR_DATA_SEG_LEN_MASK));\r\ntmp = (u32 *)resp_hdr_ptr->dlength;\r\nresp_hdr_ptr->itt = build_itt(cqe->cqe_solicited.itid,\r\nconn->session->age);\r\nresp_hdr_ptr->tsih = cqe_login_response->tsih;\r\nresp_hdr_ptr->statsn = cpu_to_be32(cqe_login_response->stat_sn);\r\nresp_hdr_ptr->exp_cmdsn = cpu_to_be32(cqe_login_response->exp_cmd_sn);\r\nresp_hdr_ptr->max_cmdsn = cpu_to_be32(cqe_login_response->max_cmd_sn);\r\nresp_hdr_ptr->status_class = cqe_login_response->status_class;\r\nresp_hdr_ptr->status_detail = cqe_login_response->status_detail;\r\npld_len = cqe_login_response->hdr_second_dword &\r\nISCSI_LOGIN_RESPONSE_HDR_DATA_SEG_LEN_MASK;\r\nqedi_conn->gen_pdu.resp_wr_ptr = qedi_conn->gen_pdu.resp_buf + pld_len;\r\nif (likely(cmd->io_cmd_in_list)) {\r\ncmd->io_cmd_in_list = false;\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\n}\r\nmemset(task_ctx, '\0', sizeof(*task_ctx));\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr_ptr,\r\nqedi_conn->gen_pdu.resp_buf,\r\n(qedi_conn->gen_pdu.resp_wr_ptr -\r\nqedi_conn->gen_pdu.resp_buf));\r\nspin_unlock(&session->back_lock);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\ncmd->state = RESPONSE_RECEIVED;\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\n}\r\nstatic void qedi_get_rq_bdq_buf(struct qedi_ctx *qedi,\r\nstruct iscsi_cqe_unsolicited *cqe,\r\nchar *ptr, int len)\r\n{\r\nu16 idx = 0;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"pld_len [%d], bdq_prod_idx [%d], idx [%d]\n",\r\nlen, qedi->bdq_prod_idx,\r\n(qedi->bdq_prod_idx % qedi->rq_num_entries));\r\nidx = cqe->rqe_opaque.lo;\r\nif (idx > (QEDI_BDQ_NUM - 1)) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"wrong idx %d returned by FW, dropping the unsolicited pkt\n",\r\nidx);\r\nreturn;\r\n}\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"rqe_opaque.lo [0x%p], rqe_opaque.hi [0x%p], idx [%d]\n",\r\ncqe->rqe_opaque.lo, cqe->rqe_opaque.hi, idx);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"unsol_cqe_type = %d\n", cqe->unsol_cqe_type);\r\nswitch (cqe->unsol_cqe_type) {\r\ncase ISCSI_CQE_UNSOLICITED_SINGLE:\r\ncase ISCSI_CQE_UNSOLICITED_FIRST:\r\nif (len)\r\nmemcpy(ptr, (void *)qedi->bdq[idx].buf_addr, len);\r\nbreak;\r\ncase ISCSI_CQE_UNSOLICITED_MIDDLE:\r\ncase ISCSI_CQE_UNSOLICITED_LAST:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void qedi_put_rq_bdq_buf(struct qedi_ctx *qedi,\r\nstruct iscsi_cqe_unsolicited *cqe,\r\nint count)\r\n{\r\nu16 tmp;\r\nu16 idx = 0;\r\nstruct scsi_bd *pbl;\r\nidx = cqe->rqe_opaque.lo;\r\nif (idx > (QEDI_BDQ_NUM - 1)) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"wrong idx %d returned by FW, dropping the unsolicited pkt\n",\r\nidx);\r\nreturn;\r\n}\r\npbl = (struct scsi_bd *)qedi->bdq_pbl;\r\npbl += (qedi->bdq_prod_idx % qedi->rq_num_entries);\r\npbl->address.hi = cpu_to_le32(QEDI_U64_HI(qedi->bdq[idx].buf_dma));\r\npbl->address.lo = cpu_to_le32(QEDI_U64_LO(qedi->bdq[idx].buf_dma));\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"pbl [0x%p] pbl->address hi [0x%llx] lo [0x%llx] idx [%d]\n",\r\npbl, pbl->address.hi, pbl->address.lo, idx);\r\npbl->opaque.hi = 0;\r\npbl->opaque.lo = cpu_to_le32(QEDI_U64_LO(idx));\r\nqedi->bdq_prod_idx += count;\r\nwritew(qedi->bdq_prod_idx, qedi->bdq_primary_prod);\r\ntmp = readw(qedi->bdq_primary_prod);\r\nwritew(qedi->bdq_prod_idx, qedi->bdq_secondary_prod);\r\ntmp = readw(qedi->bdq_secondary_prod);\r\n}\r\nstatic void qedi_unsol_pdu_adjust_bdq(struct qedi_ctx *qedi,\r\nstruct iscsi_cqe_unsolicited *cqe,\r\nu32 pdu_len, u32 num_bdqs,\r\nchar *bdq_data)\r\n{\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"num_bdqs [%d]\n", num_bdqs);\r\nqedi_get_rq_bdq_buf(qedi, cqe, bdq_data, pdu_len);\r\nqedi_put_rq_bdq_buf(qedi, cqe, (num_bdqs + 1));\r\n}\r\nstatic int qedi_process_nopin_mesg(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn, u16 que_idx)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_nop_in_hdr *cqe_nop_in;\r\nstruct iscsi_nopin *hdr;\r\nstruct qedi_cmd *cmd;\r\nint tgt_async_nop = 0;\r\nu32 lun[2];\r\nu32 pdu_len, num_bdqs;\r\nchar bdq_data[QEDI_BDQ_BUF_SIZE];\r\nunsigned long flags;\r\nspin_lock_bh(&session->back_lock);\r\ncqe_nop_in = &cqe->cqe_common.iscsi_hdr.nop_in;\r\npdu_len = cqe_nop_in->hdr_second_dword &\r\nISCSI_NOP_IN_HDR_DATA_SEG_LEN_MASK;\r\nnum_bdqs = pdu_len / QEDI_BDQ_BUF_SIZE;\r\nhdr = (struct iscsi_nopin *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(hdr, 0, sizeof(struct iscsi_hdr));\r\nhdr->opcode = cqe_nop_in->opcode;\r\nhdr->max_cmdsn = cpu_to_be32(cqe_nop_in->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(cqe_nop_in->exp_cmd_sn);\r\nhdr->statsn = cpu_to_be32(cqe_nop_in->stat_sn);\r\nhdr->ttt = cpu_to_be32(cqe_nop_in->ttt);\r\nif (cqe->cqe_common.cqe_type == ISCSI_CQE_TYPE_UNSOLICITED) {\r\nspin_lock_irqsave(&qedi->hba_lock, flags);\r\nqedi_unsol_pdu_adjust_bdq(qedi, &cqe->cqe_unsolicited,\r\npdu_len, num_bdqs, bdq_data);\r\nhdr->itt = RESERVED_ITT;\r\ntgt_async_nop = 1;\r\nspin_unlock_irqrestore(&qedi->hba_lock, flags);\r\ngoto done;\r\n}\r\nif (task) {\r\ncmd = task->dd_data;\r\nhdr->flags = ISCSI_FLAG_CMD_FINAL;\r\nhdr->itt = build_itt(cqe->cqe_solicited.itid,\r\nconn->session->age);\r\nlun[0] = 0xffffffff;\r\nlun[1] = 0xffffffff;\r\nmemcpy(&hdr->lun, lun, sizeof(struct scsi_lun));\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\ncmd->state = RESPONSE_RECEIVED;\r\nspin_lock(&qedi_conn->list_lock);\r\nif (likely(cmd->io_cmd_in_list)) {\r\ncmd->io_cmd_in_list = false;\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\n}\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\n}\r\ndone:\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr, bdq_data, pdu_len);\r\nspin_unlock_bh(&session->back_lock);\r\nreturn tgt_async_nop;\r\n}\r\nstatic void qedi_process_async_mesg(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn,\r\nu16 que_idx)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_async_msg_hdr *cqe_async_msg;\r\nstruct iscsi_async *resp_hdr;\r\nu32 lun[2];\r\nu32 pdu_len, num_bdqs;\r\nchar bdq_data[QEDI_BDQ_BUF_SIZE];\r\nunsigned long flags;\r\nspin_lock_bh(&session->back_lock);\r\ncqe_async_msg = &cqe->cqe_common.iscsi_hdr.async_msg;\r\npdu_len = cqe_async_msg->hdr_second_dword &\r\nISCSI_ASYNC_MSG_HDR_DATA_SEG_LEN_MASK;\r\nnum_bdqs = pdu_len / QEDI_BDQ_BUF_SIZE;\r\nif (cqe->cqe_common.cqe_type == ISCSI_CQE_TYPE_UNSOLICITED) {\r\nspin_lock_irqsave(&qedi->hba_lock, flags);\r\nqedi_unsol_pdu_adjust_bdq(qedi, &cqe->cqe_unsolicited,\r\npdu_len, num_bdqs, bdq_data);\r\nspin_unlock_irqrestore(&qedi->hba_lock, flags);\r\n}\r\nresp_hdr = (struct iscsi_async *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = cqe_async_msg->opcode;\r\nresp_hdr->flags = 0x80;\r\nlun[0] = cpu_to_be32(cqe_async_msg->lun.lo);\r\nlun[1] = cpu_to_be32(cqe_async_msg->lun.hi);\r\nmemcpy(&resp_hdr->lun, lun, sizeof(struct scsi_lun));\r\nresp_hdr->exp_cmdsn = cpu_to_be32(cqe_async_msg->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(cqe_async_msg->max_cmd_sn);\r\nresp_hdr->statsn = cpu_to_be32(cqe_async_msg->stat_sn);\r\nresp_hdr->async_event = cqe_async_msg->async_event;\r\nresp_hdr->async_vcode = cqe_async_msg->async_vcode;\r\nresp_hdr->param1 = cpu_to_be16(cqe_async_msg->param1_rsrv);\r\nresp_hdr->param2 = cpu_to_be16(cqe_async_msg->param2_rsrv);\r\nresp_hdr->param3 = cpu_to_be16(cqe_async_msg->param3_rsrv);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr, bdq_data,\r\npdu_len);\r\nspin_unlock_bh(&session->back_lock);\r\n}\r\nstatic void qedi_process_reject_mesg(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn,\r\nuint16_t que_idx)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_reject_hdr *cqe_reject;\r\nstruct iscsi_reject *hdr;\r\nu32 pld_len, num_bdqs;\r\nunsigned long flags;\r\nspin_lock_bh(&session->back_lock);\r\ncqe_reject = &cqe->cqe_common.iscsi_hdr.reject;\r\npld_len = cqe_reject->hdr_second_dword &\r\nISCSI_REJECT_HDR_DATA_SEG_LEN_MASK;\r\nnum_bdqs = pld_len / QEDI_BDQ_BUF_SIZE;\r\nif (cqe->cqe_common.cqe_type == ISCSI_CQE_TYPE_UNSOLICITED) {\r\nspin_lock_irqsave(&qedi->hba_lock, flags);\r\nqedi_unsol_pdu_adjust_bdq(qedi, &cqe->cqe_unsolicited,\r\npld_len, num_bdqs, conn->data);\r\nspin_unlock_irqrestore(&qedi->hba_lock, flags);\r\n}\r\nhdr = (struct iscsi_reject *)&qedi_conn->gen_pdu.resp_hdr;\r\nmemset(hdr, 0, sizeof(struct iscsi_hdr));\r\nhdr->opcode = cqe_reject->opcode;\r\nhdr->reason = cqe_reject->hdr_reason;\r\nhdr->flags = cqe_reject->hdr_flags;\r\nhton24(hdr->dlength, (cqe_reject->hdr_second_dword &\r\nISCSI_REJECT_HDR_DATA_SEG_LEN_MASK));\r\nhdr->max_cmdsn = cpu_to_be32(cqe_reject->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(cqe_reject->exp_cmd_sn);\r\nhdr->statsn = cpu_to_be32(cqe_reject->stat_sn);\r\nhdr->ffffffff = cpu_to_be32(0xffffffff);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr,\r\nconn->data, pld_len);\r\nspin_unlock_bh(&session->back_lock);\r\n}\r\nstatic void qedi_scsi_completion(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct scsi_cmnd *sc_cmd;\r\nstruct qedi_cmd *cmd = task->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct iscsi_scsi_rsp *hdr;\r\nstruct iscsi_data_in_hdr *cqe_data_in;\r\nint datalen = 0;\r\nstruct qedi_conn *qedi_conn;\r\nu32 iscsi_cid;\r\nbool mark_cmd_node_deleted = false;\r\nu8 cqe_err_bits = 0;\r\niscsi_cid = cqe->cqe_common.conn_id;\r\nqedi_conn = qedi->cid_que.conn_cid_tbl[iscsi_cid];\r\ncqe_data_in = &cqe->cqe_common.iscsi_hdr.data_in;\r\ncqe_err_bits =\r\ncqe->cqe_common.error_bitmap.error_bits.cqe_error_status_bits;\r\nspin_lock_bh(&session->back_lock);\r\nsc_cmd = cmd->scsi_cmd;\r\nif (!sc_cmd) {\r\nQEDI_WARN(&qedi->dbg_ctx, "sc_cmd is NULL!\n");\r\ngoto error;\r\n}\r\nif (!sc_cmd->SCp.ptr) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"SCp.ptr is NULL, returned in another context.\n");\r\ngoto error;\r\n}\r\nif (!sc_cmd->request) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"sc_cmd->request is NULL, sc_cmd=%p.\n",\r\nsc_cmd);\r\ngoto error;\r\n}\r\nif (!sc_cmd->request->special) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"request->special is NULL so request not valid, sc_cmd=%p.\n",\r\nsc_cmd);\r\ngoto error;\r\n}\r\nif (!sc_cmd->request->q) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"request->q is NULL so request is not valid, sc_cmd=%p.\n",\r\nsc_cmd);\r\ngoto error;\r\n}\r\nqedi_iscsi_unmap_sg_list(cmd);\r\nhdr = (struct iscsi_scsi_rsp *)task->hdr;\r\nhdr->opcode = cqe_data_in->opcode;\r\nhdr->max_cmdsn = cpu_to_be32(cqe_data_in->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(cqe_data_in->exp_cmd_sn);\r\nhdr->itt = build_itt(cqe->cqe_solicited.itid, conn->session->age);\r\nhdr->response = cqe_data_in->reserved1;\r\nhdr->cmd_status = cqe_data_in->status_rsvd;\r\nhdr->flags = cqe_data_in->flags;\r\nhdr->residual_count = cpu_to_be32(cqe_data_in->residual_count);\r\nif (hdr->cmd_status == SAM_STAT_CHECK_CONDITION) {\r\ndatalen = cqe_data_in->reserved2 &\r\nISCSI_COMMON_HDR_DATA_SEG_LEN_MASK;\r\nmemcpy((char *)conn->data, (char *)cmd->sense_buffer, datalen);\r\n}\r\nif (unlikely(cqe_err_bits &&\r\nGET_FIELD(cqe_err_bits, CQE_ERROR_BITMAP_UNDER_RUN_ERR))) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"Under flow itt=0x%x proto flags=0x%x tid=0x%x cid 0x%x fw resid 0x%x sc dlen 0x%x\n",\r\nhdr->itt, cqe_data_in->flags, cmd->task_id,\r\nqedi_conn->iscsi_conn_id, hdr->residual_count,\r\nscsi_bufflen(sc_cmd));\r\nhdr->residual_count = cpu_to_be32(scsi_bufflen(sc_cmd));\r\nhdr->flags |= ISCSI_FLAG_CMD_UNDERFLOW;\r\nhdr->flags &= (~ISCSI_FLAG_CMD_OVERFLOW);\r\n}\r\nspin_lock(&qedi_conn->list_lock);\r\nif (likely(cmd->io_cmd_in_list)) {\r\ncmd->io_cmd_in_list = false;\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\nmark_cmd_node_deleted = true;\r\n}\r\nspin_unlock(&qedi_conn->list_lock);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\ncmd->state = RESPONSE_RECEIVED;\r\nif (qedi_io_tracing)\r\nqedi_trace_io(qedi, task, cmd->task_id, QEDI_IO_TRACE_RSP);\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr,\r\nconn->data, datalen);\r\nerror:\r\nspin_unlock_bh(&session->back_lock);\r\n}\r\nstatic void qedi_mtask_completion(struct qedi_ctx *qedi,\r\nunion iscsi_cqe *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *conn, uint16_t que_idx)\r\n{\r\nstruct iscsi_conn *iscsi_conn;\r\nu32 hdr_opcode;\r\nhdr_opcode = cqe->cqe_common.iscsi_hdr.common.hdr_first_byte;\r\niscsi_conn = conn->cls_conn->dd_data;\r\nswitch (hdr_opcode) {\r\ncase ISCSI_OPCODE_SCSI_RESPONSE:\r\ncase ISCSI_OPCODE_DATA_IN:\r\nqedi_scsi_completion(qedi, cqe, task, iscsi_conn);\r\nbreak;\r\ncase ISCSI_OPCODE_LOGIN_RESPONSE:\r\nqedi_process_login_resp(qedi, cqe, task, conn);\r\nbreak;\r\ncase ISCSI_OPCODE_TMF_RESPONSE:\r\nqedi_process_tmf_resp(qedi, cqe, task, conn);\r\nbreak;\r\ncase ISCSI_OPCODE_TEXT_RESPONSE:\r\nqedi_process_text_resp(qedi, cqe, task, conn);\r\nbreak;\r\ncase ISCSI_OPCODE_LOGOUT_RESPONSE:\r\nqedi_process_logout_resp(qedi, cqe, task, conn);\r\nbreak;\r\ncase ISCSI_OPCODE_NOP_IN:\r\nqedi_process_nopin_mesg(qedi, cqe, task, conn, que_idx);\r\nbreak;\r\ndefault:\r\nQEDI_ERR(&qedi->dbg_ctx, "unknown opcode\n");\r\n}\r\n}\r\nstatic void qedi_process_nopin_local_cmpl(struct qedi_ctx *qedi,\r\nstruct iscsi_cqe_solicited *cqe,\r\nstruct iscsi_task *task,\r\nstruct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct qedi_cmd *cmd = task->dd_data;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_UNSOL,\r\n"itid=0x%x, cmd task id=0x%x\n",\r\ncqe->itid, cmd->task_id);\r\ncmd->state = RESPONSE_RECEIVED;\r\nqedi_clear_task_idx(qedi, cmd->task_id);\r\nspin_lock_bh(&session->back_lock);\r\n__iscsi_put_task(task);\r\nspin_unlock_bh(&session->back_lock);\r\n}\r\nstatic void qedi_process_cmd_cleanup_resp(struct qedi_ctx *qedi,\r\nstruct iscsi_cqe_solicited *cqe,\r\nstruct iscsi_task *task,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct qedi_work_map *work, *work_tmp;\r\nu32 proto_itt = cqe->itid;\r\nu32 ptmp_itt = 0;\r\nitt_t protoitt = 0;\r\nint found = 0;\r\nstruct qedi_cmd *qedi_cmd = NULL;\r\nu32 rtid = 0;\r\nu32 iscsi_cid;\r\nstruct qedi_conn *qedi_conn;\r\nstruct qedi_cmd *cmd_new, *dbg_cmd;\r\nstruct iscsi_task *mtask;\r\nstruct iscsi_tm *tmf_hdr = NULL;\r\niscsi_cid = cqe->conn_id;\r\nqedi_conn = qedi->cid_que.conn_cid_tbl[iscsi_cid];\r\nspin_lock_bh(&qedi_conn->tmf_work_lock);\r\nlist_for_each_entry_safe(work, work_tmp, &qedi_conn->tmf_work_list,\r\nlist) {\r\nif (work->rtid == proto_itt) {\r\nqedi_cmd = work->qedi_cmd;\r\nif (!qedi_cmd->list_tmf_work) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"TMF work not found, cqe->tid=0x%x, cid=0x%x\n",\r\nproto_itt, qedi_conn->iscsi_conn_id);\r\nWARN_ON(1);\r\n}\r\nfound = 1;\r\nmtask = qedi_cmd->task;\r\ntmf_hdr = (struct iscsi_tm *)mtask->hdr;\r\nrtid = work->rtid;\r\nlist_del_init(&work->list);\r\nkfree(work);\r\nqedi_cmd->list_tmf_work = NULL;\r\n}\r\n}\r\nspin_unlock_bh(&qedi_conn->tmf_work_lock);\r\nif (found) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"TMF work, cqe->tid=0x%x, tmf flags=0x%x, cid=0x%x\n",\r\nproto_itt, tmf_hdr->flags, qedi_conn->iscsi_conn_id);\r\nif ((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_ABORT_TASK) {\r\nspin_lock_bh(&conn->session->back_lock);\r\nprotoitt = build_itt(get_itt(tmf_hdr->rtt),\r\nconn->session->age);\r\ntask = iscsi_itt_to_task(conn, protoitt);\r\nspin_unlock_bh(&conn->session->back_lock);\r\nif (!task) {\r\nQEDI_NOTICE(&qedi->dbg_ctx,\r\n"IO task completed, tmf rtt=0x%x, cid=0x%x\n",\r\nget_itt(tmf_hdr->rtt),\r\nqedi_conn->iscsi_conn_id);\r\nreturn;\r\n}\r\ndbg_cmd = task->dd_data;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"Abort tmf rtt=0x%x, i/o itt=0x%x, i/o tid=0x%x, cid=0x%x\n",\r\nget_itt(tmf_hdr->rtt), get_itt(task->itt),\r\ndbg_cmd->task_id, qedi_conn->iscsi_conn_id);\r\nif (qedi_cmd->state == CLEANUP_WAIT_FAILED)\r\nqedi_cmd->state = CLEANUP_RECV;\r\nqedi_clear_task_idx(qedi_conn->qedi, rtid);\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_del_init(&dbg_cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_cmd->state = CLEANUP_RECV;\r\nwake_up_interruptible(&qedi_conn->wait_queue);\r\n}\r\n} else if (qedi_conn->cmd_cleanup_req > 0) {\r\nspin_lock_bh(&conn->session->back_lock);\r\nqedi_get_proto_itt(qedi, cqe->itid, &ptmp_itt);\r\nprotoitt = build_itt(ptmp_itt, conn->session->age);\r\ntask = iscsi_itt_to_task(conn, protoitt);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"cleanup io itid=0x%x, protoitt=0x%x, cmd_cleanup_cmpl=%d, cid=0x%x\n",\r\ncqe->itid, protoitt, qedi_conn->cmd_cleanup_cmpl,\r\nqedi_conn->iscsi_conn_id);\r\nspin_unlock_bh(&conn->session->back_lock);\r\nif (!task) {\r\nQEDI_NOTICE(&qedi->dbg_ctx,\r\n"task is null, itid=0x%x, cid=0x%x\n",\r\ncqe->itid, qedi_conn->iscsi_conn_id);\r\nreturn;\r\n}\r\nqedi_conn->cmd_cleanup_cmpl++;\r\nwake_up(&qedi_conn->wait_queue);\r\ncmd_new = task->dd_data;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_TID,\r\n"Freeing tid=0x%x for cid=0x%x\n",\r\ncqe->itid, qedi_conn->iscsi_conn_id);\r\nqedi_clear_task_idx(qedi_conn->qedi, cqe->itid);\r\n} else {\r\nqedi_get_proto_itt(qedi, cqe->itid, &ptmp_itt);\r\nprotoitt = build_itt(ptmp_itt, conn->session->age);\r\ntask = iscsi_itt_to_task(conn, protoitt);\r\nQEDI_ERR(&qedi->dbg_ctx,\r\n"Delayed or untracked cleanup response, itt=0x%x, tid=0x%x, cid=0x%x, task=%p\n",\r\nprotoitt, cqe->itid, qedi_conn->iscsi_conn_id, task);\r\n}\r\n}\r\nvoid qedi_fp_process_cqes(struct qedi_work *work)\r\n{\r\nstruct qedi_ctx *qedi = work->qedi;\r\nunion iscsi_cqe *cqe = &work->cqe;\r\nstruct iscsi_task *task = NULL;\r\nstruct iscsi_nopout *nopout_hdr;\r\nstruct qedi_conn *q_conn;\r\nstruct iscsi_conn *conn;\r\nstruct qedi_cmd *qedi_cmd;\r\nu32 comp_type;\r\nu32 iscsi_cid;\r\nu32 hdr_opcode;\r\nu16 que_idx = work->que_idx;\r\nu8 cqe_err_bits = 0;\r\ncomp_type = cqe->cqe_common.cqe_type;\r\nhdr_opcode = cqe->cqe_common.iscsi_hdr.common.hdr_first_byte;\r\ncqe_err_bits =\r\ncqe->cqe_common.error_bitmap.error_bits.cqe_error_status_bits;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_CONN,\r\n"fw_cid=0x%x, cqe type=0x%x, opcode=0x%x\n",\r\ncqe->cqe_common.conn_id, comp_type, hdr_opcode);\r\nif (comp_type >= MAX_ISCSI_CQES_TYPE) {\r\nQEDI_WARN(&qedi->dbg_ctx, "Invalid CqE type\n");\r\nreturn;\r\n}\r\niscsi_cid = cqe->cqe_common.conn_id;\r\nq_conn = qedi->cid_que.conn_cid_tbl[iscsi_cid];\r\nif (!q_conn) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"Session no longer exists for cid=0x%x!!\n",\r\niscsi_cid);\r\nreturn;\r\n}\r\nconn = q_conn->cls_conn->dd_data;\r\nif (unlikely(cqe_err_bits &&\r\nGET_FIELD(cqe_err_bits,\r\nCQE_ERROR_BITMAP_DATA_DIGEST_ERR))) {\r\niscsi_conn_failure(conn, ISCSI_ERR_DATA_DGST);\r\nreturn;\r\n}\r\nswitch (comp_type) {\r\ncase ISCSI_CQE_TYPE_SOLICITED:\r\ncase ISCSI_CQE_TYPE_SOLICITED_WITH_SENSE:\r\nqedi_cmd = container_of(work, struct qedi_cmd, cqe_work);\r\ntask = qedi_cmd->task;\r\nif (!task) {\r\nQEDI_WARN(&qedi->dbg_ctx, "task is NULL\n");\r\nreturn;\r\n}\r\nnopout_hdr = (struct iscsi_nopout *)task->hdr;\r\nif ((nopout_hdr->itt == RESERVED_ITT) &&\r\n(cqe->cqe_solicited.itid != (u16)RESERVED_ITT)) {\r\nqedi_process_nopin_local_cmpl(qedi, &cqe->cqe_solicited,\r\ntask, q_conn);\r\n} else {\r\ncqe->cqe_solicited.itid =\r\nqedi_get_itt(cqe->cqe_solicited);\r\nqedi_mtask_completion(qedi, cqe, task, q_conn, que_idx);\r\n}\r\nbreak;\r\ncase ISCSI_CQE_TYPE_UNSOLICITED:\r\nswitch (hdr_opcode) {\r\ncase ISCSI_OPCODE_NOP_IN:\r\nqedi_process_nopin_mesg(qedi, cqe, task, q_conn,\r\nque_idx);\r\nbreak;\r\ncase ISCSI_OPCODE_ASYNC_MSG:\r\nqedi_process_async_mesg(qedi, cqe, task, q_conn,\r\nque_idx);\r\nbreak;\r\ncase ISCSI_OPCODE_REJECT:\r\nqedi_process_reject_mesg(qedi, cqe, task, q_conn,\r\nque_idx);\r\nbreak;\r\n}\r\ngoto exit_fp_process;\r\ncase ISCSI_CQE_TYPE_DUMMY:\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM, "Dummy CqE\n");\r\ngoto exit_fp_process;\r\ncase ISCSI_CQE_TYPE_TASK_CLEANUP:\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM, "CleanUp CqE\n");\r\nqedi_process_cmd_cleanup_resp(qedi, &cqe->cqe_solicited, task,\r\nconn);\r\ngoto exit_fp_process;\r\ndefault:\r\nQEDI_ERR(&qedi->dbg_ctx, "Error cqe.\n");\r\nbreak;\r\n}\r\nexit_fp_process:\r\nreturn;\r\n}\r\nstatic void qedi_ring_doorbell(struct qedi_conn *qedi_conn)\r\n{\r\nstruct iscsi_db_data dbell = { 0 };\r\ndbell.agg_flags = 0;\r\ndbell.params |= DB_DEST_XCM << ISCSI_DB_DATA_DEST_SHIFT;\r\ndbell.params |= DB_AGG_CMD_SET << ISCSI_DB_DATA_AGG_CMD_SHIFT;\r\ndbell.params |=\r\nDQ_XCM_ISCSI_SQ_PROD_CMD << ISCSI_DB_DATA_AGG_VAL_SEL_SHIFT;\r\ndbell.sq_prod = qedi_conn->ep->fw_sq_prod_idx;\r\nwritel(*(u32 *)&dbell, qedi_conn->ep->p_doorbell);\r\nwmb();\r\nmmiowb();\r\nQEDI_INFO(&qedi_conn->qedi->dbg_ctx, QEDI_LOG_MP_REQ,\r\n"prod_idx=0x%x, fw_prod_idx=0x%x, cid=0x%x\n",\r\nqedi_conn->ep->sq_prod_idx, qedi_conn->ep->fw_sq_prod_idx,\r\nqedi_conn->iscsi_conn_id);\r\n}\r\nstatic u16 qedi_get_wqe_idx(struct qedi_conn *qedi_conn)\r\n{\r\nstruct qedi_endpoint *ep;\r\nu16 rval;\r\nep = qedi_conn->ep;\r\nrval = ep->sq_prod_idx;\r\nep->sq_prod_idx++;\r\nep->fw_sq_prod_idx++;\r\nif (ep->sq_prod_idx == QEDI_SQ_SIZE)\r\nep->sq_prod_idx = 0;\r\nreturn rval;\r\n}\r\nint qedi_send_iscsi_login(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct iscsi_login_req_hdr login_req_pdu_header;\r\nstruct scsi_sgl_task_params tx_sgl_task_params;\r\nstruct scsi_sgl_task_params rx_sgl_task_params;\r\nstruct iscsi_task_params task_params;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_login_req *login_hdr;\r\nstruct scsi_sge *req_sge = NULL;\r\nstruct scsi_sge *resp_sge = NULL;\r\nstruct qedi_cmd *qedi_cmd;\r\nstruct qedi_endpoint *ep;\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\nreq_sge = (struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\nresp_sge = (struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nqedi_cmd = (struct qedi_cmd *)task->dd_data;\r\nep = qedi_conn->ep;\r\nlogin_hdr = (struct iscsi_login_req *)task->hdr;\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\nqedi_cmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&login_req_pdu_header, 0, sizeof(login_req_pdu_header));\r\nmemset(&tx_sgl_task_params, 0, sizeof(tx_sgl_task_params));\r\nmemset(&rx_sgl_task_params, 0, sizeof(rx_sgl_task_params));\r\nlogin_req_pdu_header.opcode = login_hdr->opcode;\r\nlogin_req_pdu_header.version_min = login_hdr->min_version;\r\nlogin_req_pdu_header.version_max = login_hdr->max_version;\r\nlogin_req_pdu_header.flags_attr = login_hdr->flags;\r\nlogin_req_pdu_header.isid_tabc = swab32p((u32 *)login_hdr->isid);\r\nlogin_req_pdu_header.isid_d = swab16p((u16 *)&login_hdr->isid[4]);\r\nlogin_req_pdu_header.tsih = login_hdr->tsih;\r\nlogin_req_pdu_header.hdr_second_dword = ntoh24(login_hdr->dlength);\r\nqedi_update_itt_map(qedi, tid, task->itt, qedi_cmd);\r\nlogin_req_pdu_header.itt = qedi_set_itt(tid, get_itt(task->itt));\r\nlogin_req_pdu_header.cid = qedi_conn->iscsi_conn_id;\r\nlogin_req_pdu_header.cmd_sn = be32_to_cpu(login_hdr->cmdsn);\r\nlogin_req_pdu_header.exp_stat_sn = be32_to_cpu(login_hdr->exp_statsn);\r\nlogin_req_pdu_header.exp_stat_sn = 0;\r\ntx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\ntx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.req_dma_addr);\r\ntx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.req_dma_addr >> 32);\r\ntx_sgl_task_params.total_buffer_size = ntoh24(login_hdr->dlength);\r\ntx_sgl_task_params.num_sges = 1;\r\nrx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nrx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.resp_dma_addr);\r\nrx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.resp_dma_addr >> 32);\r\nrx_sgl_task_params.total_buffer_size = resp_sge->sge_len;\r\nrx_sgl_task_params.num_sges = 1;\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = 0;\r\ntask_params.tx_io_size = ntoh24(login_hdr->dlength);\r\ntask_params.rx_io_size = resp_sge->sge_len;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nrval = init_initiator_login_request_task(&task_params,\r\n&login_req_pdu_header,\r\n&tx_sgl_task_params,\r\n&rx_sgl_task_params);\r\nif (rval)\r\nreturn -1;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&qedi_cmd->io_cmd, &qedi_conn->active_cmd_list);\r\nqedi_cmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nint qedi_send_iscsi_logout(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct iscsi_logout_req_hdr logout_pdu_header;\r\nstruct scsi_sgl_task_params tx_sgl_task_params;\r\nstruct scsi_sgl_task_params rx_sgl_task_params;\r\nstruct iscsi_task_params task_params;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct iscsi_logout *logout_hdr = NULL;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct qedi_cmd *qedi_cmd;\r\nstruct qedi_endpoint *ep;\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\nqedi_cmd = (struct qedi_cmd *)task->dd_data;\r\nlogout_hdr = (struct iscsi_logout *)task->hdr;\r\nep = qedi_conn->ep;\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\nqedi_cmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&logout_pdu_header, 0, sizeof(logout_pdu_header));\r\nmemset(&tx_sgl_task_params, 0, sizeof(tx_sgl_task_params));\r\nmemset(&rx_sgl_task_params, 0, sizeof(rx_sgl_task_params));\r\nlogout_pdu_header.opcode = logout_hdr->opcode;\r\nlogout_pdu_header.reason_code = 0x80 | logout_hdr->flags;\r\nqedi_update_itt_map(qedi, tid, task->itt, qedi_cmd);\r\nlogout_pdu_header.itt = qedi_set_itt(tid, get_itt(task->itt));\r\nlogout_pdu_header.exp_stat_sn = be32_to_cpu(logout_hdr->exp_statsn);\r\nlogout_pdu_header.cmd_sn = be32_to_cpu(logout_hdr->cmdsn);\r\nlogout_pdu_header.cid = qedi_conn->iscsi_conn_id;\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = 0;\r\ntask_params.tx_io_size = 0;\r\ntask_params.rx_io_size = 0;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nrval = init_initiator_logout_request_task(&task_params,\r\n&logout_pdu_header,\r\nNULL, NULL);\r\nif (rval)\r\nreturn -1;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&qedi_cmd->io_cmd, &qedi_conn->active_cmd_list);\r\nqedi_cmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nint qedi_cleanup_all_io(struct qedi_ctx *qedi, struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task, bool in_recovery)\r\n{\r\nint rval;\r\nstruct iscsi_task *ctask;\r\nstruct qedi_cmd *cmd, *cmd_tmp;\r\nstruct iscsi_tm *tmf_hdr;\r\nunsigned int lun = 0;\r\nbool lun_reset = false;\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nif (task) {\r\ntmf_hdr = (struct iscsi_tm *)task->hdr;\r\nif ((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_LOGICAL_UNIT_RESET) {\r\nlun_reset = true;\r\nlun = scsilun_to_int(&tmf_hdr->lun);\r\n}\r\n}\r\nqedi_conn->cmd_cleanup_req = 0;\r\nqedi_conn->cmd_cleanup_cmpl = 0;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"active_cmd_count=%d, cid=0x%x, in_recovery=%d, lun_reset=%d\n",\r\nqedi_conn->active_cmd_count, qedi_conn->iscsi_conn_id,\r\nin_recovery, lun_reset);\r\nif (lun_reset)\r\nspin_lock_bh(&session->back_lock);\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_for_each_entry_safe(cmd, cmd_tmp, &qedi_conn->active_cmd_list,\r\nio_cmd) {\r\nctask = cmd->task;\r\nif (ctask == task)\r\ncontinue;\r\nif (lun_reset) {\r\nif (cmd->scsi_cmd && cmd->scsi_cmd->device) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"tid=0x%x itt=0x%x scsi_cmd_ptr=%p device=%p task_state=%d cmd_state=0%x cid=0x%x\n",\r\ncmd->task_id, get_itt(ctask->itt),\r\ncmd->scsi_cmd, cmd->scsi_cmd->device,\r\nctask->state, cmd->state,\r\nqedi_conn->iscsi_conn_id);\r\nif (cmd->scsi_cmd->device->lun != lun)\r\ncontinue;\r\n}\r\n}\r\nqedi_conn->cmd_cleanup_req++;\r\nqedi_iscsi_cleanup_task(ctask, true);\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"Deleted active cmd list node io_cmd=%p, cid=0x%x\n",\r\n&cmd->io_cmd, qedi_conn->iscsi_conn_id);\r\n}\r\nspin_unlock(&qedi_conn->list_lock);\r\nif (lun_reset)\r\nspin_unlock_bh(&session->back_lock);\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"cmd_cleanup_req=%d, cid=0x%x\n",\r\nqedi_conn->cmd_cleanup_req,\r\nqedi_conn->iscsi_conn_id);\r\nrval = wait_event_interruptible_timeout(qedi_conn->wait_queue,\r\n((qedi_conn->cmd_cleanup_req ==\r\nqedi_conn->cmd_cleanup_cmpl) ||\r\nqedi_conn->ep),\r\n5 * HZ);\r\nif (rval) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"i/o cmd_cleanup_req=%d, equal to cmd_cleanup_cmpl=%d, cid=0x%x\n",\r\nqedi_conn->cmd_cleanup_req,\r\nqedi_conn->cmd_cleanup_cmpl,\r\nqedi_conn->iscsi_conn_id);\r\nreturn 0;\r\n}\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"i/o cmd_cleanup_req=%d, not equal to cmd_cleanup_cmpl=%d, cid=0x%x\n",\r\nqedi_conn->cmd_cleanup_req,\r\nqedi_conn->cmd_cleanup_cmpl,\r\nqedi_conn->iscsi_conn_id);\r\niscsi_host_for_each_session(qedi->shost,\r\nqedi_mark_device_missing);\r\nqedi_ops->common->drain(qedi->cdev);\r\nif (!wait_event_interruptible_timeout(qedi_conn->wait_queue,\r\n(qedi_conn->cmd_cleanup_req ==\r\nqedi_conn->cmd_cleanup_cmpl),\r\n5 * HZ)) {\r\niscsi_host_for_each_session(qedi->shost,\r\nqedi_mark_device_available);\r\nreturn -1;\r\n}\r\niscsi_host_for_each_session(qedi->shost,\r\nqedi_mark_device_available);\r\nreturn 0;\r\n}\r\nvoid qedi_clearsq(struct qedi_ctx *qedi, struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct qedi_endpoint *qedi_ep;\r\nint rval;\r\nqedi_ep = qedi_conn->ep;\r\nqedi_conn->cmd_cleanup_req = 0;\r\nqedi_conn->cmd_cleanup_cmpl = 0;\r\nif (!qedi_ep) {\r\nQEDI_WARN(&qedi->dbg_ctx,\r\n"Cannot proceed, ep already disconnected, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\nreturn;\r\n}\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"Clearing SQ for cid=0x%x, conn=%p, ep=%p\n",\r\nqedi_conn->iscsi_conn_id, qedi_conn, qedi_ep);\r\nqedi_ops->clear_sq(qedi->cdev, qedi_ep->handle);\r\nrval = qedi_cleanup_all_io(qedi, qedi_conn, task, true);\r\nif (rval) {\r\nQEDI_ERR(&qedi->dbg_ctx,\r\n"fatal error, need hard reset, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nstatic int qedi_wait_for_cleanup_request(struct qedi_ctx *qedi,\r\nstruct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task,\r\nstruct qedi_cmd *qedi_cmd,\r\nstruct qedi_work_map *list_work)\r\n{\r\nstruct qedi_cmd *cmd = (struct qedi_cmd *)task->dd_data;\r\nint wait;\r\nwait = wait_event_interruptible_timeout(qedi_conn->wait_queue,\r\n((qedi_cmd->state ==\r\nCLEANUP_RECV) ||\r\n((qedi_cmd->type == TYPEIO) &&\r\n(cmd->state ==\r\nRESPONSE_RECEIVED))),\r\n5 * HZ);\r\nif (!wait) {\r\nqedi_cmd->state = CLEANUP_WAIT_FAILED;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"Cleanup timedout tid=0x%x, issue connection recovery, cid=0x%x\n",\r\ncmd->task_id, qedi_conn->iscsi_conn_id);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void qedi_tmf_work(struct work_struct *work)\r\n{\r\nstruct qedi_cmd *qedi_cmd =\r\ncontainer_of(work, struct qedi_cmd, tmf_work);\r\nstruct qedi_conn *qedi_conn = qedi_cmd->conn;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_cls_session *cls_sess;\r\nstruct qedi_work_map *list_work = NULL;\r\nstruct iscsi_task *mtask;\r\nstruct qedi_cmd *cmd;\r\nstruct iscsi_task *ctask;\r\nstruct iscsi_tm *tmf_hdr;\r\ns16 rval = 0;\r\ns16 tid = 0;\r\nmtask = qedi_cmd->task;\r\ntmf_hdr = (struct iscsi_tm *)mtask->hdr;\r\ncls_sess = iscsi_conn_to_session(qedi_conn->cls_conn);\r\nset_bit(QEDI_CONN_FW_CLEANUP, &qedi_conn->flags);\r\nctask = iscsi_itt_to_task(conn, tmf_hdr->rtt);\r\nif (!ctask || !ctask->sc) {\r\nQEDI_ERR(&qedi->dbg_ctx, "Task already completed\n");\r\ngoto abort_ret;\r\n}\r\ncmd = (struct qedi_cmd *)ctask->dd_data;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"Abort tmf rtt=0x%x, cmd itt=0x%x, cmd tid=0x%x, cid=0x%x\n",\r\nget_itt(tmf_hdr->rtt), get_itt(ctask->itt), cmd->task_id,\r\nqedi_conn->iscsi_conn_id);\r\nif (qedi_do_not_recover) {\r\nQEDI_ERR(&qedi->dbg_ctx, "DONT SEND CLEANUP/ABORT %d\n",\r\nqedi_do_not_recover);\r\ngoto abort_ret;\r\n}\r\nlist_work = kzalloc(sizeof(*list_work), GFP_ATOMIC);\r\nif (!list_work) {\r\nQEDI_ERR(&qedi->dbg_ctx, "Memory allocation failed\n");\r\ngoto abort_ret;\r\n}\r\nqedi_cmd->type = TYPEIO;\r\nlist_work->qedi_cmd = qedi_cmd;\r\nlist_work->rtid = cmd->task_id;\r\nlist_work->state = QEDI_WORK_SCHEDULED;\r\nqedi_cmd->list_tmf_work = list_work;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"Queue tmf work=%p, list node=%p, cid=0x%x, tmf flags=0x%x\n",\r\nlist_work->ptr_tmf_work, list_work, qedi_conn->iscsi_conn_id,\r\ntmf_hdr->flags);\r\nspin_lock_bh(&qedi_conn->tmf_work_lock);\r\nlist_add_tail(&list_work->list, &qedi_conn->tmf_work_list);\r\nspin_unlock_bh(&qedi_conn->tmf_work_lock);\r\nqedi_iscsi_cleanup_task(ctask, false);\r\nrval = qedi_wait_for_cleanup_request(qedi, qedi_conn, ctask, qedi_cmd,\r\nlist_work);\r\nif (rval == -1) {\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_INFO,\r\n"FW cleanup got escalated, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\ngoto ldel_exit;\r\n}\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1) {\r\nQEDI_ERR(&qedi->dbg_ctx, "Invalid tid, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\ngoto ldel_exit;\r\n}\r\nqedi_cmd->task_id = tid;\r\nqedi_send_iscsi_tmf(qedi_conn, qedi_cmd->task);\r\nabort_ret:\r\nclear_bit(QEDI_CONN_FW_CLEANUP, &qedi_conn->flags);\r\nreturn;\r\nldel_exit:\r\nspin_lock_bh(&qedi_conn->tmf_work_lock);\r\nif (!qedi_cmd->list_tmf_work) {\r\nlist_del_init(&list_work->list);\r\nqedi_cmd->list_tmf_work = NULL;\r\nkfree(list_work);\r\n}\r\nspin_unlock_bh(&qedi_conn->tmf_work_lock);\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_del_init(&cmd->io_cmd);\r\nqedi_conn->active_cmd_count--;\r\nspin_unlock(&qedi_conn->list_lock);\r\nclear_bit(QEDI_CONN_FW_CLEANUP, &qedi_conn->flags);\r\n}\r\nstatic int qedi_send_iscsi_tmf(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *mtask)\r\n{\r\nstruct iscsi_tmf_request_hdr tmf_pdu_header;\r\nstruct iscsi_task_params task_params;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct iscsi_conn *conn = qedi_conn->cls_conn->dd_data;\r\nstruct iscsi_task *ctask;\r\nstruct iscsi_tm *tmf_hdr;\r\nstruct qedi_cmd *qedi_cmd;\r\nstruct qedi_cmd *cmd;\r\nstruct qedi_endpoint *ep;\r\nu32 scsi_lun[2];\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\ntmf_hdr = (struct iscsi_tm *)mtask->hdr;\r\nqedi_cmd = (struct qedi_cmd *)mtask->dd_data;\r\nep = qedi_conn->ep;\r\nif (!ep)\r\nreturn -ENODEV;\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\nqedi_cmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&tmf_pdu_header, 0, sizeof(tmf_pdu_header));\r\nqedi_update_itt_map(qedi, tid, mtask->itt, qedi_cmd);\r\ntmf_pdu_header.itt = qedi_set_itt(tid, get_itt(mtask->itt));\r\ntmf_pdu_header.cmd_sn = be32_to_cpu(tmf_hdr->cmdsn);\r\nmemcpy(scsi_lun, &tmf_hdr->lun, sizeof(struct scsi_lun));\r\ntmf_pdu_header.lun.lo = be32_to_cpu(scsi_lun[0]);\r\ntmf_pdu_header.lun.hi = be32_to_cpu(scsi_lun[1]);\r\nif ((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_ABORT_TASK) {\r\nctask = iscsi_itt_to_task(conn, tmf_hdr->rtt);\r\nif (!ctask || !ctask->sc) {\r\nQEDI_ERR(&qedi->dbg_ctx,\r\n"Could not get reference task\n");\r\nreturn 0;\r\n}\r\ncmd = (struct qedi_cmd *)ctask->dd_data;\r\ntmf_pdu_header.rtt =\r\nqedi_set_itt(cmd->task_id,\r\nget_itt(tmf_hdr->rtt));\r\n} else {\r\ntmf_pdu_header.rtt = ISCSI_RESERVED_TAG;\r\n}\r\ntmf_pdu_header.opcode = tmf_hdr->opcode;\r\ntmf_pdu_header.function = tmf_hdr->flags;\r\ntmf_pdu_header.hdr_second_dword = ntoh24(tmf_hdr->dlength);\r\ntmf_pdu_header.ref_cmd_sn = be32_to_cpu(tmf_hdr->refcmdsn);\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = 0;\r\ntask_params.tx_io_size = 0;\r\ntask_params.rx_io_size = 0;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nrval = init_initiator_tmf_request_task(&task_params,\r\n&tmf_pdu_header);\r\nif (rval)\r\nreturn -1;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&qedi_cmd->io_cmd, &qedi_conn->active_cmd_list);\r\nqedi_cmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nint qedi_iscsi_abort_work(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *mtask)\r\n{\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_tm *tmf_hdr;\r\nstruct qedi_cmd *qedi_cmd = (struct qedi_cmd *)mtask->dd_data;\r\ns16 tid = 0;\r\ntmf_hdr = (struct iscsi_tm *)mtask->hdr;\r\nqedi_cmd->task = mtask;\r\nif ((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_ABORT_TASK) {\r\nqedi_cmd->state = CLEANUP_WAIT;\r\nINIT_WORK(&qedi_cmd->tmf_work, qedi_tmf_work);\r\nqueue_work(qedi->tmf_thread, &qedi_cmd->tmf_work);\r\n} else if (((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_LOGICAL_UNIT_RESET) ||\r\n((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_TARGET_WARM_RESET) ||\r\n((tmf_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) ==\r\nISCSI_TM_FUNC_TARGET_COLD_RESET)) {\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1) {\r\nQEDI_ERR(&qedi->dbg_ctx, "Invalid tid, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\nreturn -1;\r\n}\r\nqedi_cmd->task_id = tid;\r\nqedi_send_iscsi_tmf(qedi_conn, qedi_cmd->task);\r\n} else {\r\nQEDI_ERR(&qedi->dbg_ctx, "Invalid tmf, cid=0x%x\n",\r\nqedi_conn->iscsi_conn_id);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nint qedi_send_iscsi_text(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct iscsi_text_request_hdr text_request_pdu_header;\r\nstruct scsi_sgl_task_params tx_sgl_task_params;\r\nstruct scsi_sgl_task_params rx_sgl_task_params;\r\nstruct iscsi_task_params task_params;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_text *text_hdr;\r\nstruct scsi_sge *req_sge = NULL;\r\nstruct scsi_sge *resp_sge = NULL;\r\nstruct qedi_cmd *qedi_cmd;\r\nstruct qedi_endpoint *ep;\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\nreq_sge = (struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\nresp_sge = (struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nqedi_cmd = (struct qedi_cmd *)task->dd_data;\r\ntext_hdr = (struct iscsi_text *)task->hdr;\r\nep = qedi_conn->ep;\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\nqedi_cmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&text_request_pdu_header, 0, sizeof(text_request_pdu_header));\r\nmemset(&tx_sgl_task_params, 0, sizeof(tx_sgl_task_params));\r\nmemset(&rx_sgl_task_params, 0, sizeof(rx_sgl_task_params));\r\ntext_request_pdu_header.opcode = text_hdr->opcode;\r\ntext_request_pdu_header.flags_attr = text_hdr->flags;\r\nqedi_update_itt_map(qedi, tid, task->itt, qedi_cmd);\r\ntext_request_pdu_header.itt = qedi_set_itt(tid, get_itt(task->itt));\r\ntext_request_pdu_header.ttt = text_hdr->ttt;\r\ntext_request_pdu_header.cmd_sn = be32_to_cpu(text_hdr->cmdsn);\r\ntext_request_pdu_header.exp_stat_sn = be32_to_cpu(text_hdr->exp_statsn);\r\ntext_request_pdu_header.hdr_second_dword = ntoh24(text_hdr->dlength);\r\ntx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\ntx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.req_dma_addr);\r\ntx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.req_dma_addr >> 32);\r\ntx_sgl_task_params.total_buffer_size = req_sge->sge_len;\r\ntx_sgl_task_params.num_sges = 1;\r\nrx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nrx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.resp_dma_addr);\r\nrx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.resp_dma_addr >> 32);\r\nrx_sgl_task_params.total_buffer_size = resp_sge->sge_len;\r\nrx_sgl_task_params.num_sges = 1;\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = 0;\r\ntask_params.tx_io_size = ntoh24(text_hdr->dlength);\r\ntask_params.rx_io_size = resp_sge->sge_len;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nrval = init_initiator_text_request_task(&task_params,\r\n&text_request_pdu_header,\r\n&tx_sgl_task_params,\r\n&rx_sgl_task_params);\r\nif (rval)\r\nreturn -1;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&qedi_cmd->io_cmd, &qedi_conn->active_cmd_list);\r\nqedi_cmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nint qedi_send_iscsi_nopout(struct qedi_conn *qedi_conn,\r\nstruct iscsi_task *task,\r\nchar *datap, int data_len, int unsol)\r\n{\r\nstruct iscsi_nop_out_hdr nop_out_pdu_header;\r\nstruct scsi_sgl_task_params tx_sgl_task_params;\r\nstruct scsi_sgl_task_params rx_sgl_task_params;\r\nstruct iscsi_task_params task_params;\r\nstruct qedi_ctx *qedi = qedi_conn->qedi;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct iscsi_nopout *nopout_hdr;\r\nstruct scsi_sge *req_sge = NULL;\r\nstruct scsi_sge *resp_sge = NULL;\r\nstruct qedi_cmd *qedi_cmd;\r\nstruct qedi_endpoint *ep;\r\nu32 scsi_lun[2];\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\nreq_sge = (struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\nresp_sge = (struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nqedi_cmd = (struct qedi_cmd *)task->dd_data;\r\nnopout_hdr = (struct iscsi_nopout *)task->hdr;\r\nep = qedi_conn->ep;\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\nqedi_cmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&nop_out_pdu_header, 0, sizeof(nop_out_pdu_header));\r\nmemset(&tx_sgl_task_params, 0, sizeof(tx_sgl_task_params));\r\nmemset(&rx_sgl_task_params, 0, sizeof(rx_sgl_task_params));\r\nnop_out_pdu_header.opcode = nopout_hdr->opcode;\r\nSET_FIELD(nop_out_pdu_header.flags_attr, ISCSI_NOP_OUT_HDR_CONST1, 1);\r\nSET_FIELD(nop_out_pdu_header.flags_attr, ISCSI_NOP_OUT_HDR_RSRV, 0);\r\nmemcpy(scsi_lun, &nopout_hdr->lun, sizeof(struct scsi_lun));\r\nnop_out_pdu_header.lun.lo = be32_to_cpu(scsi_lun[0]);\r\nnop_out_pdu_header.lun.hi = be32_to_cpu(scsi_lun[1]);\r\nnop_out_pdu_header.cmd_sn = be32_to_cpu(nopout_hdr->cmdsn);\r\nnop_out_pdu_header.exp_stat_sn = be32_to_cpu(nopout_hdr->exp_statsn);\r\nqedi_update_itt_map(qedi, tid, task->itt, qedi_cmd);\r\nif (nopout_hdr->ttt != ISCSI_TTT_ALL_ONES) {\r\nnop_out_pdu_header.itt = be32_to_cpu(nopout_hdr->itt);\r\nnop_out_pdu_header.ttt = be32_to_cpu(nopout_hdr->ttt);\r\n} else {\r\nnop_out_pdu_header.itt = qedi_set_itt(tid, get_itt(task->itt));\r\nnop_out_pdu_header.ttt = ISCSI_TTT_ALL_ONES;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&qedi_cmd->io_cmd, &qedi_conn->active_cmd_list);\r\nqedi_cmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\n}\r\nif (data_len) {\r\ntx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.req_bd_tbl;\r\ntx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.req_dma_addr);\r\ntx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.req_dma_addr >> 32);\r\ntx_sgl_task_params.total_buffer_size = data_len;\r\ntx_sgl_task_params.num_sges = 1;\r\nrx_sgl_task_params.sgl =\r\n(struct scsi_sge *)qedi_conn->gen_pdu.resp_bd_tbl;\r\nrx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(qedi_conn->gen_pdu.resp_dma_addr);\r\nrx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)qedi_conn->gen_pdu.resp_dma_addr >> 32);\r\nrx_sgl_task_params.total_buffer_size = resp_sge->sge_len;\r\nrx_sgl_task_params.num_sges = 1;\r\n}\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = 0;\r\ntask_params.tx_io_size = data_len;\r\ntask_params.rx_io_size = resp_sge->sge_len;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nrval = init_initiator_nop_out_task(&task_params,\r\n&nop_out_pdu_header,\r\n&tx_sgl_task_params,\r\n&rx_sgl_task_params);\r\nif (rval)\r\nreturn -1;\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nstatic int qedi_split_bd(struct qedi_cmd *cmd, u64 addr, int sg_len,\r\nint bd_index)\r\n{\r\nstruct scsi_sge *bd = cmd->io_tbl.sge_tbl;\r\nint frag_size, sg_frags;\r\nsg_frags = 0;\r\nwhile (sg_len) {\r\nif (addr % QEDI_PAGE_SIZE)\r\nfrag_size =\r\n(QEDI_PAGE_SIZE - (addr % QEDI_PAGE_SIZE));\r\nelse\r\nfrag_size = (sg_len > QEDI_BD_SPLIT_SZ) ? 0 :\r\n(sg_len % QEDI_BD_SPLIT_SZ);\r\nif (frag_size == 0)\r\nfrag_size = QEDI_BD_SPLIT_SZ;\r\nbd[bd_index + sg_frags].sge_addr.lo = (addr & 0xffffffff);\r\nbd[bd_index + sg_frags].sge_addr.hi = (addr >> 32);\r\nbd[bd_index + sg_frags].sge_len = (u16)frag_size;\r\nQEDI_INFO(&cmd->conn->qedi->dbg_ctx, QEDI_LOG_IO,\r\n"split sge %d: addr=%llx, len=%x",\r\n(bd_index + sg_frags), addr, frag_size);\r\naddr += (u64)frag_size;\r\nsg_frags++;\r\nsg_len -= frag_size;\r\n}\r\nreturn sg_frags;\r\n}\r\nstatic int qedi_map_scsi_sg(struct qedi_ctx *qedi, struct qedi_cmd *cmd)\r\n{\r\nstruct scsi_cmnd *sc = cmd->scsi_cmd;\r\nstruct scsi_sge *bd = cmd->io_tbl.sge_tbl;\r\nstruct scatterlist *sg;\r\nint byte_count = 0;\r\nint bd_count = 0;\r\nint sg_count;\r\nint sg_len;\r\nint sg_frags;\r\nu64 addr, end_addr;\r\nint i;\r\nWARN_ON(scsi_sg_count(sc) > QEDI_ISCSI_MAX_BDS_PER_CMD);\r\nsg_count = dma_map_sg(&qedi->pdev->dev, scsi_sglist(sc),\r\nscsi_sg_count(sc), sc->sc_data_direction);\r\nsg = scsi_sglist(sc);\r\nif ((sg_count == 1) && (sg_dma_len(sg) <= MAX_SGLEN_FOR_CACHESGL)) {\r\nsg_len = sg_dma_len(sg);\r\naddr = (u64)sg_dma_address(sg);\r\nbd[bd_count].sge_addr.lo = (addr & 0xffffffff);\r\nbd[bd_count].sge_addr.hi = (addr >> 32);\r\nbd[bd_count].sge_len = (u16)sg_len;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_IO,\r\n"single-cashed-sgl: bd_count:%d addr=%llx, len=%x",\r\nsg_count, addr, sg_len);\r\nreturn ++bd_count;\r\n}\r\nscsi_for_each_sg(sc, sg, sg_count, i) {\r\nsg_len = sg_dma_len(sg);\r\naddr = (u64)sg_dma_address(sg);\r\nend_addr = (addr + sg_len);\r\nif ((i == 0) && (sg_count > 1) && (end_addr % QEDI_PAGE_SIZE))\r\ncmd->use_slowpath = true;\r\nelse if ((i == (sg_count - 1)) &&\r\n(sg_count > 1) && (addr % QEDI_PAGE_SIZE))\r\ncmd->use_slowpath = true;\r\nelse if ((i != 0) && (i != (sg_count - 1)) &&\r\n((addr % QEDI_PAGE_SIZE) ||\r\n(end_addr % QEDI_PAGE_SIZE)))\r\ncmd->use_slowpath = true;\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_IO, "sg[%d] size=0x%x",\r\ni, sg_len);\r\nif (sg_len > QEDI_BD_SPLIT_SZ) {\r\nsg_frags = qedi_split_bd(cmd, addr, sg_len, bd_count);\r\n} else {\r\nsg_frags = 1;\r\nbd[bd_count].sge_addr.lo = addr & 0xffffffff;\r\nbd[bd_count].sge_addr.hi = addr >> 32;\r\nbd[bd_count].sge_len = sg_len;\r\n}\r\nbyte_count += sg_len;\r\nbd_count += sg_frags;\r\n}\r\nif (byte_count != scsi_bufflen(sc))\r\nQEDI_ERR(&qedi->dbg_ctx,\r\n"byte_count = %d != scsi_bufflen = %d\n", byte_count,\r\nscsi_bufflen(sc));\r\nelse\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_IO, "byte_count = %d\n",\r\nbyte_count);\r\nWARN_ON(byte_count != scsi_bufflen(sc));\r\nreturn bd_count;\r\n}\r\nstatic void qedi_iscsi_map_sg_list(struct qedi_cmd *cmd)\r\n{\r\nint bd_count;\r\nstruct scsi_cmnd *sc = cmd->scsi_cmd;\r\nif (scsi_sg_count(sc)) {\r\nbd_count = qedi_map_scsi_sg(cmd->conn->qedi, cmd);\r\nif (bd_count == 0)\r\nreturn;\r\n} else {\r\nstruct scsi_sge *bd = cmd->io_tbl.sge_tbl;\r\nbd[0].sge_addr.lo = 0;\r\nbd[0].sge_addr.hi = 0;\r\nbd[0].sge_len = 0;\r\nbd_count = 0;\r\n}\r\ncmd->io_tbl.sge_valid = bd_count;\r\n}\r\nstatic void qedi_cpy_scsi_cdb(struct scsi_cmnd *sc, u32 *dstp)\r\n{\r\nu32 dword;\r\nint lpcnt;\r\nu8 *srcp;\r\nlpcnt = sc->cmd_len / sizeof(dword);\r\nsrcp = (u8 *)sc->cmnd;\r\nwhile (lpcnt--) {\r\nmemcpy(&dword, (const void *)srcp, 4);\r\n*dstp = cpu_to_be32(dword);\r\nsrcp += 4;\r\ndstp++;\r\n}\r\nif (sc->cmd_len & 0x3) {\r\ndword = (u32)srcp[0] | ((u32)srcp[1] << 8);\r\n*dstp = cpu_to_be32(dword);\r\n}\r\n}\r\nvoid qedi_trace_io(struct qedi_ctx *qedi, struct iscsi_task *task,\r\nu16 tid, int8_t direction)\r\n{\r\nstruct qedi_io_log *io_log;\r\nstruct iscsi_conn *conn = task->conn;\r\nstruct qedi_conn *qedi_conn = conn->dd_data;\r\nstruct scsi_cmnd *sc_cmd = task->sc;\r\nunsigned long flags;\r\nu8 op;\r\nspin_lock_irqsave(&qedi->io_trace_lock, flags);\r\nio_log = &qedi->io_trace_buf[qedi->io_trace_idx];\r\nio_log->direction = direction;\r\nio_log->task_id = tid;\r\nio_log->cid = qedi_conn->iscsi_conn_id;\r\nio_log->lun = sc_cmd->device->lun;\r\nio_log->op = sc_cmd->cmnd[0];\r\nop = sc_cmd->cmnd[0];\r\nio_log->lba[0] = sc_cmd->cmnd[2];\r\nio_log->lba[1] = sc_cmd->cmnd[3];\r\nio_log->lba[2] = sc_cmd->cmnd[4];\r\nio_log->lba[3] = sc_cmd->cmnd[5];\r\nio_log->bufflen = scsi_bufflen(sc_cmd);\r\nio_log->sg_count = scsi_sg_count(sc_cmd);\r\nio_log->fast_sgs = qedi->fast_sgls;\r\nio_log->cached_sgs = qedi->cached_sgls;\r\nio_log->slow_sgs = qedi->slow_sgls;\r\nio_log->cached_sge = qedi->use_cached_sge;\r\nio_log->slow_sge = qedi->use_slow_sge;\r\nio_log->fast_sge = qedi->use_fast_sge;\r\nio_log->result = sc_cmd->result;\r\nio_log->jiffies = jiffies;\r\nio_log->blk_req_cpu = smp_processor_id();\r\nif (direction == QEDI_IO_TRACE_REQ) {\r\nio_log->req_cpu = smp_processor_id() % qedi->num_queues;\r\nio_log->intr_cpu = 0;\r\nio_log->blk_rsp_cpu = 0;\r\n} else if (direction == QEDI_IO_TRACE_RSP) {\r\nio_log->req_cpu = smp_processor_id() % qedi->num_queues;\r\nio_log->intr_cpu = qedi->intr_cpu;\r\nio_log->blk_rsp_cpu = smp_processor_id();\r\n}\r\nqedi->io_trace_idx++;\r\nif (qedi->io_trace_idx == QEDI_IO_TRACE_SIZE)\r\nqedi->io_trace_idx = 0;\r\nqedi->use_cached_sge = false;\r\nqedi->use_slow_sge = false;\r\nqedi->use_fast_sge = false;\r\nspin_unlock_irqrestore(&qedi->io_trace_lock, flags);\r\n}\r\nint qedi_iscsi_send_ioreq(struct iscsi_task *task)\r\n{\r\nstruct iscsi_conn *conn = task->conn;\r\nstruct iscsi_session *session = conn->session;\r\nstruct Scsi_Host *shost = iscsi_session_to_shost(session->cls_session);\r\nstruct qedi_ctx *qedi = iscsi_host_priv(shost);\r\nstruct qedi_conn *qedi_conn = conn->dd_data;\r\nstruct qedi_cmd *cmd = task->dd_data;\r\nstruct scsi_cmnd *sc = task->sc;\r\nstruct iscsi_cmd_hdr cmd_pdu_header;\r\nstruct scsi_sgl_task_params tx_sgl_task_params;\r\nstruct scsi_sgl_task_params rx_sgl_task_params;\r\nstruct scsi_sgl_task_params *prx_sgl = NULL;\r\nstruct scsi_sgl_task_params *ptx_sgl = NULL;\r\nstruct iscsi_task_params task_params;\r\nstruct iscsi_conn_params conn_params;\r\nstruct scsi_initiator_cmd_params cmd_params;\r\nstruct iscsi_task_context *fw_task_ctx;\r\nstruct iscsi_cls_conn *cls_conn;\r\nstruct iscsi_scsi_req *hdr = (struct iscsi_scsi_req *)task->hdr;\r\nenum iscsi_task_type task_type = MAX_ISCSI_TASK_TYPE;\r\nstruct qedi_endpoint *ep;\r\nu32 scsi_lun[2];\r\ns16 tid = 0;\r\nu16 sq_idx = 0;\r\nu16 cq_idx;\r\nint rval = 0;\r\nep = qedi_conn->ep;\r\ncls_conn = qedi_conn->cls_conn;\r\nconn = cls_conn->dd_data;\r\nqedi_iscsi_map_sg_list(cmd);\r\nint_to_scsilun(sc->device->lun, (struct scsi_lun *)scsi_lun);\r\ntid = qedi_get_task_idx(qedi);\r\nif (tid == -1)\r\nreturn -ENOMEM;\r\nfw_task_ctx =\r\n(struct iscsi_task_context *)qedi_get_task_mem(&qedi->tasks, tid);\r\nmemset(fw_task_ctx, 0, sizeof(struct iscsi_task_context));\r\ncmd->task_id = tid;\r\nmemset(&task_params, 0, sizeof(task_params));\r\nmemset(&cmd_pdu_header, 0, sizeof(cmd_pdu_header));\r\nmemset(&tx_sgl_task_params, 0, sizeof(tx_sgl_task_params));\r\nmemset(&rx_sgl_task_params, 0, sizeof(rx_sgl_task_params));\r\nmemset(&conn_params, 0, sizeof(conn_params));\r\nmemset(&cmd_params, 0, sizeof(cmd_params));\r\ncq_idx = smp_processor_id() % qedi->num_queues;\r\nSET_FIELD(cmd_pdu_header.flags_attr, ISCSI_CMD_HDR_ATTR,\r\nISCSI_ATTR_SIMPLE);\r\nif (hdr->cdb[0] != TEST_UNIT_READY) {\r\nif (sc->sc_data_direction == DMA_TO_DEVICE) {\r\nSET_FIELD(cmd_pdu_header.flags_attr,\r\nISCSI_CMD_HDR_WRITE, 1);\r\ntask_type = ISCSI_TASK_TYPE_INITIATOR_WRITE;\r\n} else {\r\nSET_FIELD(cmd_pdu_header.flags_attr,\r\nISCSI_CMD_HDR_READ, 1);\r\ntask_type = ISCSI_TASK_TYPE_INITIATOR_READ;\r\n}\r\n}\r\ncmd_pdu_header.lun.lo = be32_to_cpu(scsi_lun[0]);\r\ncmd_pdu_header.lun.hi = be32_to_cpu(scsi_lun[1]);\r\nqedi_update_itt_map(qedi, tid, task->itt, cmd);\r\ncmd_pdu_header.itt = qedi_set_itt(tid, get_itt(task->itt));\r\ncmd_pdu_header.expected_transfer_length = cpu_to_be32(hdr->data_length);\r\ncmd_pdu_header.hdr_second_dword = ntoh24(hdr->dlength);\r\ncmd_pdu_header.cmd_sn = be32_to_cpu(hdr->cmdsn);\r\ncmd_pdu_header.hdr_first_byte = hdr->opcode;\r\nqedi_cpy_scsi_cdb(sc, (u32 *)cmd_pdu_header.cdb);\r\nif (task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE) {\r\ntx_sgl_task_params.sgl = cmd->io_tbl.sge_tbl;\r\ntx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(cmd->io_tbl.sge_tbl_dma);\r\ntx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)cmd->io_tbl.sge_tbl_dma >> 32);\r\ntx_sgl_task_params.total_buffer_size = scsi_bufflen(sc);\r\ntx_sgl_task_params.num_sges = cmd->io_tbl.sge_valid;\r\nif (cmd->use_slowpath)\r\ntx_sgl_task_params.small_mid_sge = true;\r\n} else if (task_type == ISCSI_TASK_TYPE_INITIATOR_READ) {\r\nrx_sgl_task_params.sgl = cmd->io_tbl.sge_tbl;\r\nrx_sgl_task_params.sgl_phys_addr.lo =\r\n(u32)(cmd->io_tbl.sge_tbl_dma);\r\nrx_sgl_task_params.sgl_phys_addr.hi =\r\n(u32)((u64)cmd->io_tbl.sge_tbl_dma >> 32);\r\nrx_sgl_task_params.total_buffer_size = scsi_bufflen(sc);\r\nrx_sgl_task_params.num_sges = cmd->io_tbl.sge_valid;\r\n}\r\nconn_params.first_burst_length = conn->session->first_burst;\r\nconn_params.max_send_pdu_length = conn->max_xmit_dlength;\r\nconn_params.max_burst_length = conn->session->max_burst;\r\nif (conn->session->initial_r2t_en)\r\nconn_params.initial_r2t = true;\r\nif (conn->session->imm_data_en)\r\nconn_params.immediate_data = true;\r\ncmd_params.sense_data_buffer_phys_addr.lo = (u32)cmd->sense_buffer_dma;\r\ncmd_params.sense_data_buffer_phys_addr.hi =\r\n(u32)((u64)cmd->sense_buffer_dma >> 32);\r\ntask_params.context = fw_task_ctx;\r\ntask_params.conn_icid = (u16)qedi_conn->iscsi_conn_id;\r\ntask_params.itid = tid;\r\ntask_params.cq_rss_number = cq_idx;\r\nif (task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE)\r\ntask_params.tx_io_size = scsi_bufflen(sc);\r\nelse if (task_type == ISCSI_TASK_TYPE_INITIATOR_READ)\r\ntask_params.rx_io_size = scsi_bufflen(sc);\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nQEDI_INFO(&qedi->dbg_ctx, QEDI_LOG_IO,\r\n"%s: %s-SGL: sg_len=0x%x num_sges=0x%x first-sge-lo=0x%x first-sge-hi=0x%x\n",\r\n(task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE) ?\r\n"Write " : "Read ", (cmd->io_tbl.sge_valid == 1) ?\r\n"Single" : (cmd->use_slowpath ? "SLOW" : "FAST"),\r\n(u16)cmd->io_tbl.sge_valid, scsi_bufflen(sc),\r\n(u32)(cmd->io_tbl.sge_tbl_dma),\r\n(u32)((u64)cmd->io_tbl.sge_tbl_dma >> 32));\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\nif (task_params.tx_io_size != 0)\r\nptx_sgl = &tx_sgl_task_params;\r\nif (task_params.rx_io_size != 0)\r\nprx_sgl = &rx_sgl_task_params;\r\nrval = init_initiator_rw_iscsi_task(&task_params, &conn_params,\r\n&cmd_params, &cmd_pdu_header,\r\nptx_sgl, prx_sgl,\r\nNULL);\r\nif (rval)\r\nreturn -1;\r\nspin_lock(&qedi_conn->list_lock);\r\nlist_add_tail(&cmd->io_cmd, &qedi_conn->active_cmd_list);\r\ncmd->io_cmd_in_list = true;\r\nqedi_conn->active_cmd_count++;\r\nspin_unlock(&qedi_conn->list_lock);\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}\r\nint qedi_iscsi_cleanup_task(struct iscsi_task *task, bool mark_cmd_node_deleted)\r\n{\r\nstruct iscsi_task_params task_params;\r\nstruct qedi_endpoint *ep;\r\nstruct iscsi_conn *conn = task->conn;\r\nstruct qedi_conn *qedi_conn = conn->dd_data;\r\nstruct qedi_cmd *cmd = task->dd_data;\r\nu16 sq_idx = 0;\r\nint rval = 0;\r\nQEDI_INFO(&qedi_conn->qedi->dbg_ctx, QEDI_LOG_SCSI_TM,\r\n"issue cleanup tid=0x%x itt=0x%x task_state=%d cmd_state=0%x cid=0x%x\n",\r\ncmd->task_id, get_itt(task->itt), task->state,\r\ncmd->state, qedi_conn->iscsi_conn_id);\r\nmemset(&task_params, 0, sizeof(task_params));\r\nep = qedi_conn->ep;\r\nsq_idx = qedi_get_wqe_idx(qedi_conn);\r\ntask_params.sqe = &ep->sq[sq_idx];\r\nmemset(task_params.sqe, 0, sizeof(struct iscsi_wqe));\r\ntask_params.itid = cmd->task_id;\r\nrval = init_cleanup_task(&task_params);\r\nif (rval)\r\nreturn rval;\r\nqedi_ring_doorbell(qedi_conn);\r\nreturn 0;\r\n}

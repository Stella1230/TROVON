static void da9062_thermal_poll_on(struct work_struct *work)\r\n{\r\nstruct da9062_thermal *thermal = container_of(work,\r\nstruct da9062_thermal,\r\nwork.work);\r\nunsigned long delay;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_write(thermal->hw->regmap,\r\nDA9062AA_EVENT_B,\r\nDA9062AA_E_TEMP_MASK);\r\nif (ret < 0) {\r\ndev_err(thermal->dev,\r\n"Cannot clear the TJUNC temperature status\n");\r\ngoto err_enable_irq;\r\n}\r\nret = regmap_read(thermal->hw->regmap,\r\nDA9062AA_EVENT_B,\r\n&val);\r\nif (ret < 0) {\r\ndev_err(thermal->dev,\r\n"Cannot check the TJUNC temperature status\n");\r\ngoto err_enable_irq;\r\n}\r\nif (val & DA9062AA_E_TEMP_MASK) {\r\nmutex_lock(&thermal->lock);\r\nthermal->temperature = DA9062_MILLI_CELSIUS(125);\r\nmutex_unlock(&thermal->lock);\r\nthermal_zone_device_update(thermal->zone,\r\nTHERMAL_EVENT_UNSPECIFIED);\r\ndelay = msecs_to_jiffies(thermal->zone->passive_delay);\r\nschedule_delayed_work(&thermal->work, delay);\r\nreturn;\r\n}\r\nmutex_lock(&thermal->lock);\r\nthermal->temperature = DA9062_MILLI_CELSIUS(0);\r\nmutex_unlock(&thermal->lock);\r\nthermal_zone_device_update(thermal->zone,\r\nTHERMAL_EVENT_UNSPECIFIED);\r\nerr_enable_irq:\r\nenable_irq(thermal->irq);\r\n}\r\nstatic irqreturn_t da9062_thermal_irq_handler(int irq, void *data)\r\n{\r\nstruct da9062_thermal *thermal = data;\r\ndisable_irq_nosync(thermal->irq);\r\nschedule_delayed_work(&thermal->work, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9062_thermal_get_mode(struct thermal_zone_device *z,\r\nenum thermal_device_mode *mode)\r\n{\r\nstruct da9062_thermal *thermal = z->devdata;\r\n*mode = thermal->mode;\r\nreturn 0;\r\n}\r\nstatic int da9062_thermal_get_trip_type(struct thermal_zone_device *z,\r\nint trip,\r\nenum thermal_trip_type *type)\r\n{\r\nstruct da9062_thermal *thermal = z->devdata;\r\nswitch (trip) {\r\ncase 0:\r\n*type = THERMAL_TRIP_HOT;\r\nbreak;\r\ndefault:\r\ndev_err(thermal->dev,\r\n"Driver does not support more than 1 trip-wire\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9062_thermal_get_trip_temp(struct thermal_zone_device *z,\r\nint trip,\r\nint *temp)\r\n{\r\nstruct da9062_thermal *thermal = z->devdata;\r\nswitch (trip) {\r\ncase 0:\r\n*temp = DA9062_MILLI_CELSIUS(125);\r\nbreak;\r\ndefault:\r\ndev_err(thermal->dev,\r\n"Driver does not support more than 1 trip-wire\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9062_thermal_get_temp(struct thermal_zone_device *z,\r\nint *temp)\r\n{\r\nstruct da9062_thermal *thermal = z->devdata;\r\nmutex_lock(&thermal->lock);\r\n*temp = thermal->temperature;\r\nmutex_unlock(&thermal->lock);\r\nreturn 0;\r\n}\r\nstatic int da9062_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct da9062 *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9062_thermal *thermal;\r\nunsigned int pp_tmp = DA9062_DEFAULT_POLLING_MS_PERIOD;\r\nconst struct of_device_id *match;\r\nint ret = 0;\r\nmatch = of_match_node(da9062_compatible_reg_id_table,\r\npdev->dev.of_node);\r\nif (!match)\r\nreturn -ENXIO;\r\nif (pdev->dev.of_node) {\r\nif (!of_property_read_u32(pdev->dev.of_node,\r\n"polling-delay-passive",\r\n&pp_tmp)) {\r\nif (pp_tmp < DA9062_MIN_POLLING_MS_PERIOD ||\r\npp_tmp > DA9062_MAX_POLLING_MS_PERIOD) {\r\ndev_warn(&pdev->dev,\r\n"Out-of-range polling period %d ms\n",\r\npp_tmp);\r\npp_tmp = DA9062_DEFAULT_POLLING_MS_PERIOD;\r\n}\r\n}\r\n}\r\nthermal = devm_kzalloc(&pdev->dev, sizeof(struct da9062_thermal),\r\nGFP_KERNEL);\r\nif (!thermal) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nthermal->config = match->data;\r\nthermal->hw = chip;\r\nthermal->mode = THERMAL_DEVICE_ENABLED;\r\nthermal->dev = &pdev->dev;\r\nINIT_DELAYED_WORK(&thermal->work, da9062_thermal_poll_on);\r\nmutex_init(&thermal->lock);\r\nthermal->zone = thermal_zone_device_register(thermal->config->name,\r\n1, 0, thermal,\r\n&da9062_thermal_ops, NULL, pp_tmp,\r\n0);\r\nif (IS_ERR(thermal->zone)) {\r\ndev_err(&pdev->dev, "Cannot register thermal zone device\n");\r\nret = PTR_ERR(thermal->zone);\r\ngoto err;\r\n}\r\ndev_dbg(&pdev->dev,\r\n"TJUNC temperature polling period set at %d ms\n",\r\nthermal->zone->passive_delay);\r\nret = platform_get_irq_byname(pdev, "THERMAL");\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to get platform IRQ.\n");\r\ngoto err_zone;\r\n}\r\nthermal->irq = ret;\r\nret = request_threaded_irq(thermal->irq, NULL,\r\nda9062_thermal_irq_handler,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"THERMAL", thermal);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to request thermal device IRQ.\n");\r\ngoto err_zone;\r\n}\r\nplatform_set_drvdata(pdev, thermal);\r\nreturn 0;\r\nerr_zone:\r\nthermal_zone_device_unregister(thermal->zone);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int da9062_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct da9062_thermal *thermal = platform_get_drvdata(pdev);\r\nfree_irq(thermal->irq, thermal);\r\ncancel_delayed_work_sync(&thermal->work);\r\nthermal_zone_device_unregister(thermal->zone);\r\nreturn 0;\r\n}

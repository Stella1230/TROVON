static void\r\nia_css_binary_dvs_env(const struct ia_css_binary_info *info,\r\nconst struct ia_css_resolution *dvs_env,\r\nstruct ia_css_resolution *binary_dvs_env)\r\n{\r\nif (info->enable.dvs_envelope) {\r\nassert(dvs_env != NULL);\r\nbinary_dvs_env->width = max(dvs_env->width, SH_CSS_MIN_DVS_ENVELOPE);\r\nbinary_dvs_env->height = max(dvs_env->height, SH_CSS_MIN_DVS_ENVELOPE);\r\n}\r\n}\r\nstatic void\r\nia_css_binary_internal_res(const struct ia_css_frame_info *in_info,\r\nconst struct ia_css_frame_info *bds_out_info,\r\nconst struct ia_css_frame_info *out_info,\r\nconst struct ia_css_resolution *dvs_env,\r\nconst struct ia_css_binary_info *info,\r\nstruct ia_css_resolution *internal_res)\r\n{\r\nunsigned int isp_tmp_internal_width = 0,\r\nisp_tmp_internal_height = 0;\r\nbool binary_supports_yuv_ds = info->enable.ds & 2;\r\nstruct ia_css_resolution binary_dvs_env;\r\nbinary_dvs_env.width = 0;\r\nbinary_dvs_env.height = 0;\r\nia_css_binary_dvs_env(info, dvs_env, &binary_dvs_env);\r\nif (binary_supports_yuv_ds) {\r\nif (in_info != NULL) {\r\nisp_tmp_internal_width = in_info->res.width\r\n+ info->pipeline.left_cropping + binary_dvs_env.width;\r\nisp_tmp_internal_height = in_info->res.height\r\n+ info->pipeline.top_cropping + binary_dvs_env.height;\r\n}\r\n} else if ((bds_out_info != NULL) && (out_info != NULL) &&\r\n(bds_out_info->res.width >= out_info->res.width)) {\r\nisp_tmp_internal_width = bds_out_info->padded_width;\r\nisp_tmp_internal_height = bds_out_info->res.height;\r\n} else {\r\nif (out_info != NULL) {\r\nisp_tmp_internal_width = out_info->padded_width;\r\nisp_tmp_internal_height = out_info->res.height;\r\n}\r\n}\r\ninternal_res->width = __ISP_INTERNAL_WIDTH(isp_tmp_internal_width,\r\n(int)binary_dvs_env.width,\r\ninfo->pipeline.left_cropping, info->pipeline.mode,\r\ninfo->pipeline.c_subsampling,\r\ninfo->output.num_chunks, info->pipeline.pipelining);\r\ninternal_res->height = __ISP_INTERNAL_HEIGHT(isp_tmp_internal_height,\r\ninfo->pipeline.top_cropping,\r\nbinary_dvs_env.height);\r\n}\r\nstatic enum ia_css_err\r\n#ifndef ISP2401\r\nia_css_binary_compute_shading_table_bayer_origin(\r\nconst struct ia_css_binary *binary,\r\nunsigned int required_bds_factor,\r\nconst struct ia_css_stream_config *stream_config,\r\nstruct sh_css_shading_table_bayer_origin_compute_results *res)\r\n#else\r\nsh_css_binary_get_sc_requirements(\r\nconst struct ia_css_binary *binary,\r\nunsigned int required_bds_factor,\r\nconst struct ia_css_stream_config *stream_config,\r\nstruct sh_css_binary_sc_requirements *scr)\r\n#endif\r\n{\r\nenum ia_css_err err;\r\n#ifndef ISP2401\r\n#else\r\n#endif\r\nunsigned int bds_num, bds_den;\r\n#ifndef ISP2401\r\nunsigned int bs_hor_ratio_in;\r\nunsigned int bs_hor_ratio_out;\r\nunsigned int bs_ver_ratio_in;\r\nunsigned int bs_ver_ratio_out;\r\n#else\r\nunsigned int bs_hor_ratio_in, bs_hor_ratio_out, bs_ver_ratio_in, bs_ver_ratio_out;\r\n#endif\r\n#ifndef ISP2401\r\nunsigned int left_padding_bqs;\r\n#else\r\nunsigned int left_padding_bqs;\r\n#endif\r\n#ifndef ISP2401\r\nunsigned int need_bds_factor_2_00;\r\nunsigned int left_padding_adjusted_bqs;\r\nunsigned int bad_bqs_on_left_before_bs;\r\nunsigned int bad_bqs_on_left_after_bs;\r\nunsigned int bad_bqs_on_top_before_bs;\r\nunsigned int bad_bqs_on_top_after_bs;\r\nerr = sh_css_bds_factor_get_numerator_denominator\r\n(required_bds_factor, &bds_num, &bds_den);\r\nif (err != IA_CSS_SUCCESS)\r\n#else\r\nunsigned int need_bds_factor_2_00, need_bds_factor_1_50, need_bds_factor_1_25;\r\nunsigned int left_padding_adjusted_bqs;\r\nunsigned int top_padding_bqs;\r\nint bds_frac_acc = FRAC_ACC;\r\nunsigned int right_shift_bqs_before_bs;\r\nunsigned int right_shift_bqs_after_bs;\r\nunsigned int down_shift_bqs_before_bs;\r\nunsigned int down_shift_bqs_after_bs;\r\nunsigned int sensor_data_origin_x_bqs_on_internal;\r\nunsigned int sensor_data_origin_y_bqs_on_internal;\r\nIA_CSS_ENTER_PRIVATE("binary=%p, required_bds_factor=%d, stream_config=%p",\r\nbinary, required_bds_factor, stream_config);\r\nerr = sh_css_bds_factor_get_numerator_denominator(required_bds_factor, &bds_num, &bds_den);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\n#endif\r\nreturn err;\r\n#ifdef ISP2401\r\n}\r\n#endif\r\n#ifndef ISP2401\r\n#else\r\nIA_CSS_LOG("bds_num=%d, bds_den=%d", bds_num, bds_den);\r\n#endif\r\nbs_hor_ratio_in = bds_num;\r\nbs_hor_ratio_out = bds_den;\r\nbs_ver_ratio_in = bds_num;\r\nbs_ver_ratio_out = bds_den;\r\n#ifndef ISP2401\r\n#else\r\n#endif\r\nif (stream_config->left_padding == -1)\r\nleft_padding_bqs = _ISP_BQS(binary->left_padding);\r\nelse\r\n#ifndef ISP2401\r\nleft_padding_bqs = (unsigned int)((int)ISP_VEC_NELEMS\r\n- _ISP_BQS(stream_config->left_padding));\r\n#else\r\nleft_padding_bqs = (unsigned int)((int)ISP_VEC_NELEMS - _ISP_BQS(stream_config->left_padding));\r\n#endif\r\n#ifndef ISP2401\r\n#else\r\nIA_CSS_LOG("stream.left_padding=%d, binary.left_padding=%d, left_padding_bqs=%d",\r\nstream_config->left_padding, binary->left_padding, left_padding_bqs);\r\n#endif\r\nneed_bds_factor_2_00 = ((binary->info->sp.bds.supported_bds_factors &\r\n(PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_50) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_3_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_4_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_4_50) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_5_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_6_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_8_00))) != 0);\r\n#ifndef ISP2401\r\nif (need_bds_factor_2_00 && binary->info->sp.pipeline.left_cropping > 0)\r\nleft_padding_adjusted_bqs = left_padding_bqs + ISP_VEC_NELEMS;\r\nelse\r\n#else\r\nneed_bds_factor_1_50 = ((binary->info->sp.bds.supported_bds_factors &\r\n(PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_1_50) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_25) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_3_00) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_4_50) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_6_00))) != 0);\r\nneed_bds_factor_1_25 = ((binary->info->sp.bds.supported_bds_factors &\r\n(PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_1_25) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_50) |\r\nPACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_5_00))) != 0);\r\nif (binary->info->sp.pipeline.left_cropping > 0 &&\r\n(need_bds_factor_2_00 || need_bds_factor_1_50 || need_bds_factor_1_25)) {\r\nunsigned int first_vec_adjusted_bqs\r\n= ISP_VEC_NELEMS * bs_hor_ratio_in / bs_hor_ratio_out;\r\nleft_padding_adjusted_bqs = first_vec_adjusted_bqs\r\n- _ISP_BQS(binary->info->sp.pipeline.left_cropping);\r\n} else\r\n#endif\r\nleft_padding_adjusted_bqs = left_padding_bqs;\r\n#ifndef ISP2401\r\nbad_bqs_on_left_before_bs = 0;\r\nbad_bqs_on_top_before_bs = 0;\r\n#else\r\nIA_CSS_LOG("supported_bds_factors=%d, need_bds_factor:2_00=%d, 1_50=%d, 1_25=%d",\r\nbinary->info->sp.bds.supported_bds_factors,\r\nneed_bds_factor_2_00, need_bds_factor_1_50, need_bds_factor_1_25);\r\nIA_CSS_LOG("left_cropping=%d, left_padding_adjusted_bqs=%d",\r\nbinary->info->sp.pipeline.left_cropping, left_padding_adjusted_bqs);\r\ntop_padding_bqs = 0;\r\nif (binary->info->sp.pipeline.top_cropping > 0 &&\r\n(required_bds_factor == SH_CSS_BDS_FACTOR_1_25 ||\r\nrequired_bds_factor == SH_CSS_BDS_FACTOR_1_50 ||\r\nrequired_bds_factor == SH_CSS_BDS_FACTOR_2_00)) {\r\nint top_cropping_bqs = _ISP_BQS(binary->info->sp.pipeline.top_cropping);\r\nint factor = bds_num * bds_frac_acc / bds_den;\r\nint top_padding_bqsxfrac_acc = (top_cropping_bqs * factor - top_cropping_bqs * bds_frac_acc)\r\n+ (2 * bds_frac_acc - factor);\r\ntop_padding_bqs = (unsigned int)((top_padding_bqsxfrac_acc + bds_frac_acc/2 - 1) / bds_frac_acc);\r\n}\r\nIA_CSS_LOG("top_cropping=%d, top_padding_bqs=%d", binary->info->sp.pipeline.top_cropping, top_padding_bqs);\r\nright_shift_bqs_before_bs = 0;\r\ndown_shift_bqs_before_bs = 0;\r\n#endif\r\n#ifndef ISP2401\r\nbad_bqs_on_left_after_bs = 0;\r\nbad_bqs_on_top_after_bs = 0;\r\n#else\r\nif (need_bds_factor_2_00 || need_bds_factor_1_50 || need_bds_factor_1_25) {\r\nright_shift_bqs_before_bs = 1;\r\ndown_shift_bqs_before_bs = 1;\r\n}\r\nIA_CSS_LOG("right_shift_bqs_before_bs=%d, down_shift_bqs_before_bs=%d",\r\nright_shift_bqs_before_bs, down_shift_bqs_before_bs);\r\nright_shift_bqs_after_bs = 0;\r\ndown_shift_bqs_after_bs = 0;\r\n#endif\r\n#ifndef ISP2401\r\nres->sc_bayer_origin_x_bqs_on_shading_table\r\n= ((left_padding_adjusted_bqs + bad_bqs_on_left_before_bs)\r\n* bs_hor_ratio_out + bs_hor_ratio_in/2) / bs_hor_ratio_in\r\n+ bad_bqs_on_left_after_bs;\r\nres->sc_bayer_origin_y_bqs_on_shading_table\r\n= (bad_bqs_on_top_before_bs\r\n* bs_ver_ratio_out + bs_ver_ratio_in/2) / bs_ver_ratio_in\r\n+ bad_bqs_on_top_after_bs;\r\nres->bayer_scale_hor_ratio_in = (uint32_t)bs_hor_ratio_in;\r\nres->bayer_scale_hor_ratio_out = (uint32_t)bs_hor_ratio_out;\r\nres->bayer_scale_ver_ratio_in = (uint32_t)bs_ver_ratio_in;\r\nres->bayer_scale_ver_ratio_out = (uint32_t)bs_ver_ratio_out;\r\n#else\r\nif (binary->info->mem_offsets.offsets.param->dmem.dp.size != 0) {\r\nright_shift_bqs_after_bs = 1;\r\ndown_shift_bqs_after_bs = 1;\r\n}\r\nIA_CSS_LOG("right_shift_bqs_after_bs=%d, down_shift_bqs_after_bs=%d",\r\nright_shift_bqs_after_bs, down_shift_bqs_after_bs);\r\n{\r\nunsigned int bs_frac = bds_frac_acc;\r\nunsigned int bs_out, bs_in;\r\nbs_out = bs_hor_ratio_out * bs_frac;\r\nbs_in = bs_hor_ratio_in * bs_frac;\r\nsensor_data_origin_x_bqs_on_internal\r\n= ((left_padding_adjusted_bqs + right_shift_bqs_before_bs) * bs_out + bs_in/2) / bs_in\r\n+ right_shift_bqs_after_bs;\r\nbs_out = bs_ver_ratio_out * bs_frac;\r\nbs_in = bs_ver_ratio_in * bs_frac;\r\nsensor_data_origin_y_bqs_on_internal\r\n= ((top_padding_bqs + down_shift_bqs_before_bs) * bs_out + bs_in/2) / bs_in\r\n+ down_shift_bqs_after_bs;\r\n}\r\nscr->bayer_scale_hor_ratio_in = (uint32_t)bs_hor_ratio_in;\r\nscr->bayer_scale_hor_ratio_out = (uint32_t)bs_hor_ratio_out;\r\nscr->bayer_scale_ver_ratio_in = (uint32_t)bs_ver_ratio_in;\r\nscr->bayer_scale_ver_ratio_out = (uint32_t)bs_ver_ratio_out;\r\nscr->sensor_data_origin_x_bqs_on_internal = (uint32_t)sensor_data_origin_x_bqs_on_internal;\r\nscr->sensor_data_origin_y_bqs_on_internal = (uint32_t)sensor_data_origin_y_bqs_on_internal;\r\nIA_CSS_LOG("sc_requirements: %d, %d, %d, %d, %d, %d",\r\nscr->bayer_scale_hor_ratio_in, scr->bayer_scale_hor_ratio_out,\r\nscr->bayer_scale_ver_ratio_in, scr->bayer_scale_ver_ratio_out,\r\nscr->sensor_data_origin_x_bqs_on_internal, scr->sensor_data_origin_y_bqs_on_internal);\r\n#endif\r\n#ifdef ISP2401\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\n#endif\r\nreturn err;\r\n}\r\nstatic void sh_css_binary_common_grid_info(const struct ia_css_binary *binary,\r\nstruct ia_css_grid_info *info)\r\n{\r\nassert(binary != NULL);\r\nassert(info != NULL);\r\ninfo->isp_in_width = binary->internal_frame_info.res.width;\r\ninfo->isp_in_height = binary->internal_frame_info.res.height;\r\ninfo->vamem_type = IA_CSS_VAMEM_TYPE_2;\r\n}\r\nvoid\r\nia_css_binary_dvs_grid_info(const struct ia_css_binary *binary,\r\nstruct ia_css_grid_info *info,\r\nstruct ia_css_pipe *pipe)\r\n{\r\nstruct ia_css_dvs_grid_info *dvs_info;\r\n(void)pipe;\r\nassert(binary != NULL);\r\nassert(info != NULL);\r\ndvs_info = &info->dvs_grid.dvs_grid_info;\r\ndvs_info->enable = binary->info->sp.enable.dis;\r\ndvs_info->width = binary->dis.grid.dim.width;\r\ndvs_info->height = binary->dis.grid.dim.height;\r\ndvs_info->aligned_width = binary->dis.grid.pad.width;\r\ndvs_info->aligned_height = binary->dis.grid.pad.height;\r\ndvs_info->bqs_per_grid_cell = 1 << binary->dis.deci_factor_log2;\r\ndvs_info->num_hor_coefs = binary->dis.coef.dim.width;\r\ndvs_info->num_ver_coefs = binary->dis.coef.dim.height;\r\nsh_css_binary_common_grid_info(binary, info);\r\n}\r\nvoid\r\nia_css_binary_dvs_stat_grid_info(\r\nconst struct ia_css_binary *binary,\r\nstruct ia_css_grid_info *info,\r\nstruct ia_css_pipe *pipe)\r\n{\r\n(void)pipe;\r\nsh_css_binary_common_grid_info(binary, info);\r\nreturn;\r\n}\r\nenum ia_css_err\r\nia_css_binary_3a_grid_info(const struct ia_css_binary *binary,\r\nstruct ia_css_grid_info *info,\r\nstruct ia_css_pipe *pipe)\r\n{\r\nstruct ia_css_3a_grid_info *s3a_info;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER_PRIVATE("binary=%p, info=%p, pipe=%p",\r\nbinary, info, pipe);\r\nassert(binary != NULL);\r\nassert(info != NULL);\r\ns3a_info = &info->s3a_grid;\r\ns3a_info->enable = binary->info->sp.enable.s3a;\r\ns3a_info->width = binary->s3atbl_width;\r\ns3a_info->height = binary->s3atbl_height;\r\ns3a_info->aligned_width = binary->s3atbl_isp_width;\r\ns3a_info->aligned_height = binary->s3atbl_isp_height;\r\ns3a_info->bqs_per_grid_cell = (1 << binary->deci_factor_log2);\r\ns3a_info->deci_factor_log2 = binary->deci_factor_log2;\r\ns3a_info->elem_bit_depth = SH_CSS_BAYER_BITS;\r\ns3a_info->use_dmem = binary->info->sp.s3a.s3atbl_use_dmem;\r\n#if defined(HAS_NO_HMEM)\r\ns3a_info->has_histogram = 1;\r\n#else\r\ns3a_info->has_histogram = 0;\r\n#endif\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic void\r\nbinary_init_pc_histogram(struct sh_css_pc_histogram *histo)\r\n{\r\nassert(histo != NULL);\r\nhisto->length = 0;\r\nhisto->run = NULL;\r\nhisto->stall = NULL;\r\n}\r\nstatic void\r\nbinary_init_metrics(struct sh_css_binary_metrics *metrics,\r\nconst struct ia_css_binary_info *info)\r\n{\r\nassert(metrics != NULL);\r\nassert(info != NULL);\r\nmetrics->mode = info->pipeline.mode;\r\nmetrics->id = info->id;\r\nmetrics->next = NULL;\r\nbinary_init_pc_histogram(&metrics->isp_histogram);\r\nbinary_init_pc_histogram(&metrics->sp_histogram);\r\n}\r\nstatic bool\r\nbinary_supports_output_format(const struct ia_css_binary_xinfo *info,\r\nenum ia_css_frame_format format)\r\n{\r\nint i;\r\nassert(info != NULL);\r\nfor (i = 0; i < info->num_output_formats; i++) {\r\nif (info->output_formats[i] == format)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nbinary_supports_input_format(const struct ia_css_binary_xinfo *info,\r\nenum ia_css_stream_format format)\r\n{\r\nassert(info != NULL);\r\n(void)format;\r\nreturn true;\r\n}\r\nstatic bool\r\nbinary_supports_vf_format(const struct ia_css_binary_xinfo *info,\r\nenum ia_css_frame_format format)\r\n{\r\nint i;\r\nassert(info != NULL);\r\nfor (i = 0; i < info->num_vf_formats; i++) {\r\nif (info->vf_formats[i] == format)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nsupports_bds_factor(uint32_t supported_factors,\r\nuint32_t bds_factor)\r\n{\r\nreturn ((supported_factors & PACK_BDS_FACTOR(bds_factor)) != 0);\r\n}\r\nstatic enum ia_css_err\r\nbinary_init_info(struct ia_css_binary_xinfo *info, unsigned int i,\r\nbool *binary_found)\r\n{\r\nconst unsigned char *blob = sh_css_blob_info[i].blob;\r\nunsigned size = sh_css_blob_info[i].header.blob.size;\r\nif ((info == NULL) || (binary_found == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n*info = sh_css_blob_info[i].header.info.isp;\r\n*binary_found = blob != NULL;\r\ninfo->blob_index = i;\r\nif (!size)\r\nreturn IA_CSS_SUCCESS;\r\ninfo->xmem_addr = sh_css_load_blob(blob, size);\r\nif (!info->xmem_addr)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nenum ia_css_err\r\nia_css_binary_init_infos(void)\r\n{\r\nunsigned int i;\r\nunsigned int num_of_isp_binaries = sh_css_num_binaries - NUM_OF_SPS - NUM_OF_BLS;\r\nif (num_of_isp_binaries == 0)\r\nreturn IA_CSS_SUCCESS;\r\nall_binaries = sh_css_malloc(num_of_isp_binaries *\r\nsizeof(*all_binaries));\r\nif (all_binaries == NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nfor (i = 0; i < num_of_isp_binaries; i++) {\r\nenum ia_css_err ret;\r\nstruct ia_css_binary_xinfo *binary = &all_binaries[i];\r\nbool binary_found;\r\nret = binary_init_info(binary, i, &binary_found);\r\nif (ret != IA_CSS_SUCCESS)\r\nreturn ret;\r\nif (!binary_found)\r\ncontinue;\r\nbinary->next = binary_infos[binary->sp.pipeline.mode];\r\nbinary_infos[binary->sp.pipeline.mode] = binary;\r\nbinary->blob = &sh_css_blob_info[i];\r\nbinary->mem_offsets = sh_css_blob_info[i].mem_offsets;\r\n}\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nenum ia_css_err\r\nia_css_binary_uninit(void)\r\n{\r\nunsigned int i;\r\nstruct ia_css_binary_xinfo *b;\r\nfor (i = 0; i < IA_CSS_BINARY_NUM_MODES; i++) {\r\nfor (b = binary_infos[i]; b; b = b->next) {\r\nif (b->xmem_addr)\r\nhmm_free(b->xmem_addr);\r\nb->xmem_addr = mmgr_NULL;\r\n}\r\nbinary_infos[i] = NULL;\r\n}\r\nsh_css_free(all_binaries);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic int\r\nbinary_grid_deci_factor_log2(int width, int height)\r\n{\r\n#define MAX_SPEC_DECI_FACT_LOG2 5\r\n#define MIN_SPEC_DECI_FACT_LOG2 3\r\n#define DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ 1280\r\n#define DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ 640\r\nint smallest_factor;\r\nint spec_factor;\r\nassert(ISP_BQ_GRID_WIDTH(width, MAX_SPEC_DECI_FACT_LOG2) <= SH_CSS_MAX_BQ_GRID_WIDTH);\r\nassert(ISP_BQ_GRID_HEIGHT(height, MAX_SPEC_DECI_FACT_LOG2) <= SH_CSS_MAX_BQ_GRID_HEIGHT);\r\nsmallest_factor = MAX_SPEC_DECI_FACT_LOG2;\r\nwhile (ISP_BQ_GRID_WIDTH(width, smallest_factor - 1) <= SH_CSS_MAX_BQ_GRID_WIDTH &&\r\nISP_BQ_GRID_HEIGHT(height, smallest_factor - 1) <= SH_CSS_MAX_BQ_GRID_HEIGHT\r\n&& smallest_factor > MIN_SPEC_DECI_FACT_LOG2)\r\nsmallest_factor--;\r\nif (_ISP_BQS(width) >= DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ)\r\nspec_factor = 5;\r\nelse if (_ISP_BQS(width) >= DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ)\r\nspec_factor = 4;\r\nelse\r\nspec_factor = 3;\r\nreturn max(smallest_factor, spec_factor);\r\n#undef MAX_SPEC_DECI_FACT_LOG2\r\n#undef MIN_SPEC_DECI_FACT_LOG2\r\n#undef DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ\r\n#undef DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ\r\n}\r\nstatic int\r\nbinary_in_frame_padded_width(int in_frame_width,\r\nint isp_internal_width,\r\nint dvs_env_width,\r\nint stream_config_left_padding,\r\nint left_cropping,\r\nbool need_scaling)\r\n{\r\nint rval;\r\nint nr_of_left_paddings;\r\n#if defined(USE_INPUT_SYSTEM_VERSION_2401)\r\nnr_of_left_paddings = 0;\r\n#else\r\nnr_of_left_paddings = 2*ISP_VEC_NELEMS;\r\n#endif\r\nif (need_scaling) {\r\nif (stream_config_left_padding != -1) {\r\nrval =\r\nCEIL_MUL(in_frame_width + nr_of_left_paddings,\r\n2*ISP_VEC_NELEMS);\r\n} else {\r\nin_frame_width += dvs_env_width;\r\nrval =\r\nCEIL_MUL(in_frame_width +\r\n(left_cropping ? nr_of_left_paddings : 0),\r\n2*ISP_VEC_NELEMS);\r\n}\r\n} else {\r\nrval = isp_internal_width;\r\n}\r\nreturn rval;\r\n}\r\nenum ia_css_err\r\nia_css_binary_fill_info(const struct ia_css_binary_xinfo *xinfo,\r\nbool online,\r\nbool two_ppc,\r\nenum ia_css_stream_format stream_format,\r\nconst struct ia_css_frame_info *in_info,\r\nconst struct ia_css_frame_info *bds_out_info,\r\nconst struct ia_css_frame_info *out_info[],\r\nconst struct ia_css_frame_info *vf_info,\r\nstruct ia_css_binary *binary,\r\nstruct ia_css_resolution *dvs_env,\r\nint stream_config_left_padding,\r\nbool accelerator)\r\n{\r\nconst struct ia_css_binary_info *info = &xinfo->sp;\r\nunsigned int dvs_env_width = 0,\r\ndvs_env_height = 0,\r\nvf_log_ds = 0,\r\ns3a_log_deci = 0,\r\nbits_per_pixel = 0,\r\nsc_3a_dis_width = 0,\r\nsc_3a_dis_padded_width = 0,\r\nsc_3a_dis_height = 0,\r\nisp_internal_width = 0,\r\nisp_internal_height = 0,\r\ns3a_isp_width = 0;\r\nbool need_scaling = false;\r\nstruct ia_css_resolution binary_dvs_env, internal_res;\r\nenum ia_css_err err;\r\nunsigned int i;\r\nconst struct ia_css_frame_info *bin_out_info = NULL;\r\nassert(info != NULL);\r\nassert(binary != NULL);\r\nbinary->info = xinfo;\r\nif (!accelerator) {\r\nerr = ia_css_isp_param_allocate_isp_parameters(\r\n&binary->mem_params, &binary->css_params,\r\n&info->mem_initializers);\r\nif (err != IA_CSS_SUCCESS) {\r\nreturn err;\r\n}\r\n}\r\nfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++) {\r\nif (out_info[i] && (out_info[i]->res.width != 0)) {\r\nbin_out_info = out_info[i];\r\nbreak;\r\n}\r\n}\r\nif (in_info != NULL && bin_out_info != NULL) {\r\nneed_scaling = (in_info->res.width != bin_out_info->res.width) ||\r\n(in_info->res.height != bin_out_info->res.height);\r\n}\r\nbinary_dvs_env.width = 0;\r\nbinary_dvs_env.height = 0;\r\nia_css_binary_dvs_env(info, dvs_env, &binary_dvs_env);\r\ndvs_env_width = binary_dvs_env.width;\r\ndvs_env_height = binary_dvs_env.height;\r\nbinary->dvs_envelope.width = dvs_env_width;\r\nbinary->dvs_envelope.height = dvs_env_height;\r\ninternal_res.width = 0;\r\ninternal_res.height = 0;\r\nia_css_binary_internal_res(in_info, bds_out_info, bin_out_info, dvs_env,\r\ninfo, &internal_res);\r\nisp_internal_width = internal_res.width;\r\nisp_internal_height = internal_res.height;\r\nif (bin_out_info != NULL)\r\nbinary->internal_frame_info.format = bin_out_info->format;\r\nbinary->internal_frame_info.res.width = isp_internal_width;\r\nbinary->internal_frame_info.padded_width = CEIL_MUL(isp_internal_width, 2*ISP_VEC_NELEMS);\r\nbinary->internal_frame_info.res.height = isp_internal_height;\r\nbinary->internal_frame_info.raw_bit_depth = bits_per_pixel;\r\nif (in_info != NULL) {\r\nbinary->effective_in_frame_res.width = in_info->res.width;\r\nbinary->effective_in_frame_res.height = in_info->res.height;\r\nbits_per_pixel = in_info->raw_bit_depth;\r\nbinary->in_frame_info.res.width = in_info->res.width + info->pipeline.left_cropping;\r\nbinary->in_frame_info.res.height = in_info->res.height + info->pipeline.top_cropping;\r\nbinary->in_frame_info.res.width += dvs_env_width;\r\nbinary->in_frame_info.res.height += dvs_env_height;\r\nbinary->in_frame_info.padded_width =\r\nbinary_in_frame_padded_width(in_info->res.width,\r\nisp_internal_width,\r\ndvs_env_width,\r\nstream_config_left_padding,\r\ninfo->pipeline.left_cropping,\r\nneed_scaling);\r\nbinary->in_frame_info.format = in_info->format;\r\nbinary->in_frame_info.raw_bayer_order = in_info->raw_bayer_order;\r\nbinary->in_frame_info.crop_info = in_info->crop_info;\r\n}\r\nif (online) {\r\nbits_per_pixel = ia_css_util_input_format_bpp(\r\nstream_format, two_ppc);\r\n}\r\nbinary->in_frame_info.raw_bit_depth = bits_per_pixel;\r\nfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++) {\r\nif (out_info[i] != NULL) {\r\nbinary->out_frame_info[i].res.width = out_info[i]->res.width;\r\nbinary->out_frame_info[i].res.height = out_info[i]->res.height;\r\nbinary->out_frame_info[i].padded_width = out_info[i]->padded_width;\r\nif (info->pipeline.mode == IA_CSS_BINARY_MODE_COPY) {\r\nbinary->out_frame_info[i].raw_bit_depth = bits_per_pixel;\r\n} else {\r\nbinary->out_frame_info[i].raw_bit_depth = 16;\r\n}\r\nbinary->out_frame_info[i].format = out_info[i]->format;\r\n}\r\n}\r\nif (vf_info && (vf_info->res.width != 0)) {\r\nerr = ia_css_vf_configure(binary, bin_out_info, (struct ia_css_frame_info *)vf_info, &vf_log_ds);\r\nif (err != IA_CSS_SUCCESS) {\r\nif (!accelerator) {\r\nia_css_isp_param_destroy_isp_parameters(\r\n&binary->mem_params,\r\n&binary->css_params);\r\n}\r\nreturn err;\r\n}\r\n}\r\nbinary->vf_downscale_log2 = vf_log_ds;\r\nbinary->online = online;\r\nbinary->input_format = stream_format;\r\nif ((vf_info != NULL) && (vf_info->res.width != 0)) {\r\nunsigned int vf_out_vecs, vf_out_width, vf_out_height;\r\nbinary->vf_frame_info.format = vf_info->format;\r\nif (bin_out_info == NULL)\r\nreturn IA_CSS_ERR_INTERNAL_ERROR;\r\nvf_out_vecs = __ISP_VF_OUTPUT_WIDTH_VECS(bin_out_info->padded_width,\r\nvf_log_ds);\r\nvf_out_width = _ISP_VF_OUTPUT_WIDTH(vf_out_vecs);\r\nvf_out_height = _ISP_VF_OUTPUT_HEIGHT(bin_out_info->res.height,\r\nvf_log_ds);\r\nif (info->pipeline.mode == IA_CSS_BINARY_MODE_PREVIEW) {\r\nbinary->out_frame_info[0].res.width =\r\n(bin_out_info->res.width >> vf_log_ds);\r\nbinary->out_frame_info[0].padded_width = vf_out_width;\r\nbinary->out_frame_info[0].res.height = vf_out_height;\r\nbinary->vf_frame_info.res.width = 0;\r\nbinary->vf_frame_info.padded_width = 0;\r\nbinary->vf_frame_info.res.height = 0;\r\n} else {\r\nbinary->vf_frame_info.res.width =\r\n(bin_out_info->res.width >> vf_log_ds);\r\nbinary->vf_frame_info.padded_width = vf_out_width;\r\nbinary->vf_frame_info.res.height = vf_out_height;\r\n}\r\n} else {\r\nbinary->vf_frame_info.res.width = 0;\r\nbinary->vf_frame_info.padded_width = 0;\r\nbinary->vf_frame_info.res.height = 0;\r\n}\r\nif (info->enable.ca_gdc) {\r\nbinary->morph_tbl_width =\r\n_ISP_MORPH_TABLE_WIDTH(isp_internal_width);\r\nbinary->morph_tbl_aligned_width =\r\n_ISP_MORPH_TABLE_ALIGNED_WIDTH(isp_internal_width);\r\nbinary->morph_tbl_height =\r\n_ISP_MORPH_TABLE_HEIGHT(isp_internal_height);\r\n} else {\r\nbinary->morph_tbl_width = 0;\r\nbinary->morph_tbl_aligned_width = 0;\r\nbinary->morph_tbl_height = 0;\r\n}\r\nsc_3a_dis_width = binary->in_frame_info.res.width;\r\nsc_3a_dis_padded_width = binary->in_frame_info.padded_width;\r\nsc_3a_dis_height = binary->in_frame_info.res.height;\r\nif (bds_out_info != NULL && in_info != NULL &&\r\nbds_out_info->res.width != in_info->res.width) {\r\nsc_3a_dis_width = bds_out_info->res.width + info->pipeline.left_cropping;\r\nsc_3a_dis_padded_width = isp_internal_width;\r\nsc_3a_dis_height = isp_internal_height;\r\n}\r\ns3a_isp_width = _ISP_S3A_ELEMS_ISP_WIDTH(sc_3a_dis_padded_width,\r\ninfo->pipeline.left_cropping);\r\nif (info->s3a.fixed_s3a_deci_log) {\r\ns3a_log_deci = info->s3a.fixed_s3a_deci_log;\r\n} else {\r\ns3a_log_deci = binary_grid_deci_factor_log2(s3a_isp_width,\r\nsc_3a_dis_height);\r\n}\r\nbinary->deci_factor_log2 = s3a_log_deci;\r\nif (info->enable.s3a) {\r\nbinary->s3atbl_width =\r\n_ISP_S3ATBL_WIDTH(sc_3a_dis_width,\r\ns3a_log_deci);\r\nbinary->s3atbl_height =\r\n_ISP_S3ATBL_HEIGHT(sc_3a_dis_height,\r\ns3a_log_deci);\r\nbinary->s3atbl_isp_width =\r\n_ISP_S3ATBL_ISP_WIDTH(s3a_isp_width,\r\ns3a_log_deci);\r\nbinary->s3atbl_isp_height =\r\n_ISP_S3ATBL_ISP_HEIGHT(sc_3a_dis_height,\r\ns3a_log_deci);\r\n} else {\r\nbinary->s3atbl_width = 0;\r\nbinary->s3atbl_height = 0;\r\nbinary->s3atbl_isp_width = 0;\r\nbinary->s3atbl_isp_height = 0;\r\n}\r\nif (info->enable.sc) {\r\nbinary->sctbl_width_per_color =\r\n#ifndef ISP2401\r\n_ISP_SCTBL_WIDTH_PER_COLOR(sc_3a_dis_padded_width,\r\ns3a_log_deci);\r\n#else\r\n_ISP_SCTBL_WIDTH_PER_COLOR(isp_internal_width, s3a_log_deci);\r\n#endif\r\nbinary->sctbl_aligned_width_per_color =\r\nSH_CSS_MAX_SCTBL_ALIGNED_WIDTH_PER_COLOR;\r\nbinary->sctbl_height =\r\n#ifndef ISP2401\r\n_ISP_SCTBL_HEIGHT(sc_3a_dis_height, s3a_log_deci);\r\n#else\r\n_ISP_SCTBL_HEIGHT(isp_internal_height, s3a_log_deci);\r\nbinary->sctbl_legacy_width_per_color =\r\n_ISP_SCTBL_LEGACY_WIDTH_PER_COLOR(sc_3a_dis_padded_width, s3a_log_deci);\r\nbinary->sctbl_legacy_height =\r\n_ISP_SCTBL_LEGACY_HEIGHT(sc_3a_dis_height, s3a_log_deci);\r\n#endif\r\n} else {\r\nbinary->sctbl_width_per_color = 0;\r\nbinary->sctbl_aligned_width_per_color = 0;\r\nbinary->sctbl_height = 0;\r\n#ifdef ISP2401\r\nbinary->sctbl_legacy_width_per_color = 0;\r\nbinary->sctbl_legacy_height = 0;\r\n#endif\r\n}\r\nia_css_sdis_init_info(&binary->dis,\r\nsc_3a_dis_width,\r\nsc_3a_dis_padded_width,\r\nsc_3a_dis_height,\r\ninfo->pipeline.isp_pipe_version,\r\ninfo->enable.dis);\r\nif (info->pipeline.left_cropping)\r\nbinary->left_padding = 2 * ISP_VEC_NELEMS - info->pipeline.left_cropping;\r\nelse\r\nbinary->left_padding = 0;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nenum ia_css_err\r\nia_css_binary_find(struct ia_css_binary_descr *descr,\r\nstruct ia_css_binary *binary)\r\n{\r\nint mode;\r\nbool online;\r\nbool two_ppc;\r\nenum ia_css_stream_format stream_format;\r\nconst struct ia_css_frame_info *req_in_info,\r\n*req_bds_out_info,\r\n*req_out_info[IA_CSS_BINARY_MAX_OUTPUT_PORTS],\r\n*req_bin_out_info = NULL,\r\n*req_vf_info;\r\nstruct ia_css_binary_xinfo *xcandidate;\r\n#ifndef ISP2401\r\nbool need_ds, need_dz, need_dvs, need_xnr, need_dpc;\r\n#else\r\nbool need_ds, need_dz, need_dvs, need_xnr, need_dpc, need_tnr;\r\n#endif\r\nbool striped;\r\nbool enable_yuv_ds;\r\nbool enable_high_speed;\r\nbool enable_dvs_6axis;\r\nbool enable_reduced_pipe;\r\nbool enable_capture_pp_bli;\r\n#ifdef ISP2401\r\nbool enable_luma_only;\r\n#endif\r\nenum ia_css_err err = IA_CSS_ERR_INTERNAL_ERROR;\r\nbool continuous;\r\nunsigned int isp_pipe_version;\r\nstruct ia_css_resolution dvs_env, internal_res;\r\nunsigned int i;\r\nassert(descr != NULL);\r\nassert(binary != NULL);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() enter: descr=%p, (mode=%d), binary=%p\n",\r\ndescr, descr->mode,\r\nbinary);\r\nmode = descr->mode;\r\nonline = descr->online;\r\ntwo_ppc = descr->two_ppc;\r\nstream_format = descr->stream_format;\r\nreq_in_info = descr->in_info;\r\nreq_bds_out_info = descr->bds_out_info;\r\nfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++) {\r\nreq_out_info[i] = descr->out_info[i];\r\nif (req_out_info[i] && (req_out_info[i]->res.width != 0))\r\nreq_bin_out_info = req_out_info[i];\r\n}\r\nif (req_bin_out_info == NULL)\r\nreturn IA_CSS_ERR_INTERNAL_ERROR;\r\n#ifndef ISP2401\r\nreq_vf_info = descr->vf_info;\r\n#else\r\nif ((descr->vf_info != NULL) && (descr->vf_info->res.width == 0))\r\nreq_vf_info = NULL;\r\nelse\r\nreq_vf_info = descr->vf_info;\r\n#endif\r\nneed_xnr = descr->enable_xnr;\r\nneed_ds = descr->enable_fractional_ds;\r\nneed_dz = false;\r\nneed_dvs = false;\r\nneed_dpc = descr->enable_dpc;\r\n#ifdef ISP2401\r\nneed_tnr = descr->enable_tnr;\r\n#endif\r\nenable_yuv_ds = descr->enable_yuv_ds;\r\nenable_high_speed = descr->enable_high_speed;\r\nenable_dvs_6axis = descr->enable_dvs_6axis;\r\nenable_reduced_pipe = descr->enable_reduced_pipe;\r\nenable_capture_pp_bli = descr->enable_capture_pp_bli;\r\n#ifdef ISP2401\r\nenable_luma_only = descr->enable_luma_only;\r\n#endif\r\ncontinuous = descr->continuous;\r\nstriped = descr->striped;\r\nisp_pipe_version = descr->isp_pipe_version;\r\ndvs_env.width = 0;\r\ndvs_env.height = 0;\r\ninternal_res.width = 0;\r\ninternal_res.height = 0;\r\nif (mode == IA_CSS_BINARY_MODE_VIDEO) {\r\ndvs_env = descr->dvs_env;\r\nneed_dz = descr->enable_dz;\r\nneed_dvs = dvs_env.width || dvs_env.height;\r\n}\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "BINARY INFO:\n");\r\nfor (i = 0; i < IA_CSS_BINARY_NUM_MODES; i++) {\r\nxcandidate = binary_infos[i];\r\nif (xcandidate) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "%d:\n", i);\r\nwhile (xcandidate) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, " Name:%s Type:%d Cont:%d\n",\r\nxcandidate->blob->name, xcandidate->type,\r\nxcandidate->sp.enable.continuous);\r\nxcandidate = xcandidate->next;\r\n}\r\n}\r\n}\r\nfor (xcandidate = binary_infos[mode]; xcandidate;\r\nxcandidate = xcandidate->next) {\r\nstruct ia_css_binary_info *candidate = &xcandidate->sp;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() candidate = %p, mode = %d ID = %d\n",\r\ncandidate, candidate->pipeline.mode, candidate->id);\r\nif (!candidate->enable.continuous &&\r\ncontinuous && (mode != IA_CSS_BINARY_MODE_COPY)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d && (%d != %d)\n",\r\n__LINE__, candidate->enable.continuous,\r\ncontinuous, mode,\r\nIA_CSS_BINARY_MODE_COPY);\r\ncontinue;\r\n}\r\nif (striped && candidate->iterator.num_stripes == 1) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: binary is not striped\n",\r\n__LINE__);\r\ncontinue;\r\n}\r\nif (candidate->pipeline.isp_pipe_version != isp_pipe_version &&\r\n(mode != IA_CSS_BINARY_MODE_COPY) &&\r\n(mode != IA_CSS_BINARY_MODE_CAPTURE_PP) &&\r\n(mode != IA_CSS_BINARY_MODE_VF_PP)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d != %d)\n",\r\n__LINE__,\r\ncandidate->pipeline.isp_pipe_version, isp_pipe_version);\r\ncontinue;\r\n}\r\nif (!candidate->enable.reduced_pipe && enable_reduced_pipe) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__,\r\ncandidate->enable.reduced_pipe,\r\nenable_reduced_pipe);\r\ncontinue;\r\n}\r\nif (!candidate->enable.dvs_6axis && enable_dvs_6axis) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__,\r\ncandidate->enable.dvs_6axis,\r\nenable_dvs_6axis);\r\ncontinue;\r\n}\r\nif (candidate->enable.high_speed && !enable_high_speed) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: %d && !%d\n",\r\n__LINE__,\r\ncandidate->enable.high_speed,\r\nenable_high_speed);\r\ncontinue;\r\n}\r\nif (!candidate->enable.xnr && need_xnr) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: %d && !%d\n",\r\n__LINE__,\r\ncandidate->enable.xnr,\r\nneed_xnr);\r\ncontinue;\r\n}\r\nif (!(candidate->enable.ds & 2) && enable_yuv_ds) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__,\r\n((candidate->enable.ds & 2) != 0),\r\nenable_yuv_ds);\r\ncontinue;\r\n}\r\nif ((candidate->enable.ds & 2) && !enable_yuv_ds) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: %d && !%d\n",\r\n__LINE__,\r\n((candidate->enable.ds & 2) != 0),\r\nenable_yuv_ds);\r\ncontinue;\r\n}\r\nif (mode == IA_CSS_BINARY_MODE_VIDEO &&\r\ncandidate->enable.ds && need_ds)\r\nneed_dz = false;\r\nif ((req_vf_info != NULL) && !(candidate->enable.vf_veceven ||\r\ncandidate->vf_dec.is_variable ||\r\nxcandidate->num_output_pins > 1)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%p != NULL) && !(%d || %d || (%d >%d))\n",\r\n__LINE__, req_vf_info,\r\ncandidate->enable.vf_veceven,\r\ncandidate->vf_dec.is_variable,\r\nxcandidate->num_output_pins, 1);\r\ncontinue;\r\n}\r\nif (!candidate->enable.dvs_envelope && need_dvs) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__,\r\ncandidate->enable.dvs_envelope, (int)need_dvs);\r\ncontinue;\r\n}\r\nia_css_binary_internal_res(req_in_info, req_bds_out_info,\r\nreq_bin_out_info, &dvs_env, candidate, &internal_res);\r\nif (internal_res.width > candidate->internal.max_width) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d > %d)\n",\r\n__LINE__, internal_res.width,\r\ncandidate->internal.max_width);\r\ncontinue;\r\n}\r\nif (internal_res.height > candidate->internal.max_height) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d > %d)\n",\r\n__LINE__, internal_res.height,\r\ncandidate->internal.max_height);\r\ncontinue;\r\n}\r\nif (!candidate->enable.ds && need_ds && !(xcandidate->num_output_pins > 1)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__, candidate->enable.ds, (int)need_ds);\r\ncontinue;\r\n}\r\nif (!candidate->enable.uds && !candidate->enable.dvs_6axis && need_dz) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && !%d && %d\n",\r\n__LINE__, candidate->enable.uds,\r\ncandidate->enable.dvs_6axis, (int)need_dz);\r\ncontinue;\r\n}\r\nif (online && candidate->input.source == IA_CSS_BINARY_INPUT_MEMORY) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: %d && (%d == %d)\n",\r\n__LINE__, online, candidate->input.source,\r\nIA_CSS_BINARY_INPUT_MEMORY);\r\ncontinue;\r\n}\r\nif (!online && candidate->input.source == IA_CSS_BINARY_INPUT_SENSOR) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && (%d == %d)\n",\r\n__LINE__, online, candidate->input.source,\r\nIA_CSS_BINARY_INPUT_SENSOR);\r\ncontinue;\r\n}\r\nif (req_bin_out_info->res.width < candidate->output.min_width ||\r\nreq_bin_out_info->res.width > candidate->output.max_width) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d > %d) || (%d < %d)\n",\r\n__LINE__,\r\nreq_bin_out_info->padded_width,\r\ncandidate->output.min_width,\r\nreq_bin_out_info->padded_width,\r\ncandidate->output.max_width);\r\ncontinue;\r\n}\r\nif (xcandidate->num_output_pins > 1 &&\r\nreq_vf_info) {\r\nif (req_vf_info->res.width > candidate->output.max_width) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d < %d)\n",\r\n__LINE__,\r\nreq_vf_info->res.width,\r\ncandidate->output.max_width);\r\ncontinue;\r\n}\r\n}\r\nif (req_in_info->padded_width > candidate->input.max_width) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d > %d)\n",\r\n__LINE__, req_in_info->padded_width,\r\ncandidate->input.max_width);\r\ncontinue;\r\n}\r\nif (!binary_supports_output_format(xcandidate, req_bin_out_info->format)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d\n",\r\n__LINE__,\r\nbinary_supports_output_format(xcandidate, req_bin_out_info->format));\r\ncontinue;\r\n}\r\n#ifdef ISP2401\r\nif (!binary_supports_input_format(xcandidate, descr->stream_format)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d\n",\r\n__LINE__,\r\nbinary_supports_input_format(xcandidate, req_in_info->format));\r\ncontinue;\r\n}\r\n#endif\r\nif (xcandidate->num_output_pins > 1 &&\r\nreq_vf_info &&\r\n!binary_supports_output_format(xcandidate, req_vf_info->format)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d > %d) && (%p != NULL) && !%d\n",\r\n__LINE__, xcandidate->num_output_pins, 1,\r\nreq_vf_info,\r\nbinary_supports_output_format(xcandidate, req_vf_info->format));\r\ncontinue;\r\n}\r\nif (xcandidate->num_output_pins == 1 &&\r\nreq_vf_info && candidate->enable.vf_veceven &&\r\n!binary_supports_vf_format(xcandidate, req_vf_info->format)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d == %d) && (%p != NULL) && %d && !%d\n",\r\n__LINE__, xcandidate->num_output_pins, 1,\r\nreq_vf_info, candidate->enable.vf_veceven,\r\nbinary_supports_vf_format(xcandidate, req_vf_info->format));\r\ncontinue;\r\n}\r\nif (xcandidate->num_output_pins == 1 &&\r\nreq_vf_info && candidate->enable.vf_veceven) {\r\nif (req_vf_info->res.width > candidate->output.max_width) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: (%d < %d)\n",\r\n__LINE__,\r\nreq_vf_info->res.width,\r\ncandidate->output.max_width);\r\ncontinue;\r\n}\r\n}\r\nif (!supports_bds_factor(candidate->bds.supported_bds_factors,\r\ndescr->required_bds_factor)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\n",\r\n__LINE__, candidate->bds.supported_bds_factors,\r\ndescr->required_bds_factor);\r\ncontinue;\r\n}\r\nif (!candidate->enable.dpc && need_dpc) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\n",\r\n__LINE__, candidate->enable.dpc,\r\ndescr->enable_dpc);\r\ncontinue;\r\n}\r\nif (candidate->uds.use_bci && enable_capture_pp_bli) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\n",\r\n__LINE__, candidate->uds.use_bci,\r\ndescr->enable_capture_pp_bli);\r\ncontinue;\r\n}\r\n#ifdef ISP2401\r\nif (candidate->enable.luma_only != enable_luma_only) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: %d != %d\n",\r\n__LINE__, candidate->enable.luma_only,\r\ndescr->enable_luma_only);\r\ncontinue;\r\n}\r\nif(!candidate->enable.tnr && need_tnr) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() [%d] continue: !%d && %d\n",\r\n__LINE__, candidate->enable.tnr,\r\ndescr->enable_tnr);\r\ncontinue;\r\n}\r\n#endif\r\nerr = ia_css_binary_fill_info(xcandidate, online, two_ppc,\r\nstream_format, req_in_info,\r\nreq_bds_out_info,\r\nreq_out_info, req_vf_info,\r\nbinary, &dvs_env,\r\ndescr->stream_config_left_padding,\r\nfalse);\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nbinary_init_metrics(&binary->metrics, &binary->info->sp);\r\nbreak;\r\n}\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() selected = %p, mode = %d ID = %d\n",\r\nxcandidate, xcandidate ? xcandidate->sp.pipeline.mode : 0, xcandidate ? xcandidate->sp.id : 0);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_binary_find() leave: return_err=%d\n", err);\r\nreturn err;\r\n}\r\nunsigned\r\nia_css_binary_max_vf_width(void)\r\n{\r\nif (binary_infos[IA_CSS_BINARY_MODE_VF_PP])\r\nreturn binary_infos[IA_CSS_BINARY_MODE_VF_PP]->sp.output.max_width;\r\nreturn 0;\r\n}\r\nvoid\r\nia_css_binary_destroy_isp_parameters(struct ia_css_binary *binary)\r\n{\r\nif (binary) {\r\nia_css_isp_param_destroy_isp_parameters(&binary->mem_params,\r\n&binary->css_params);\r\n}\r\n}\r\nvoid\r\nia_css_binary_get_isp_binaries(struct ia_css_binary_xinfo **binaries,\r\nuint32_t *num_isp_binaries)\r\n{\r\nassert(binaries != NULL);\r\nif (num_isp_binaries)\r\n*num_isp_binaries = 0;\r\n*binaries = all_binaries;\r\nif (all_binaries && num_isp_binaries) {\r\nif (sh_css_num_binaries > 0)\r\n*num_isp_binaries = sh_css_num_binaries - 1;\r\n}\r\n}

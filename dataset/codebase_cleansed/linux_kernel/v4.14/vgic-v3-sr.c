static u64 __hyp_text __gic_v3_get_lr(unsigned int lr)\r\n{\r\nswitch (lr & 0xf) {\r\ncase 0:\r\nreturn read_gicreg(ICH_LR0_EL2);\r\ncase 1:\r\nreturn read_gicreg(ICH_LR1_EL2);\r\ncase 2:\r\nreturn read_gicreg(ICH_LR2_EL2);\r\ncase 3:\r\nreturn read_gicreg(ICH_LR3_EL2);\r\ncase 4:\r\nreturn read_gicreg(ICH_LR4_EL2);\r\ncase 5:\r\nreturn read_gicreg(ICH_LR5_EL2);\r\ncase 6:\r\nreturn read_gicreg(ICH_LR6_EL2);\r\ncase 7:\r\nreturn read_gicreg(ICH_LR7_EL2);\r\ncase 8:\r\nreturn read_gicreg(ICH_LR8_EL2);\r\ncase 9:\r\nreturn read_gicreg(ICH_LR9_EL2);\r\ncase 10:\r\nreturn read_gicreg(ICH_LR10_EL2);\r\ncase 11:\r\nreturn read_gicreg(ICH_LR11_EL2);\r\ncase 12:\r\nreturn read_gicreg(ICH_LR12_EL2);\r\ncase 13:\r\nreturn read_gicreg(ICH_LR13_EL2);\r\ncase 14:\r\nreturn read_gicreg(ICH_LR14_EL2);\r\ncase 15:\r\nreturn read_gicreg(ICH_LR15_EL2);\r\n}\r\nunreachable();\r\n}\r\nstatic void __hyp_text __gic_v3_set_lr(u64 val, int lr)\r\n{\r\nswitch (lr & 0xf) {\r\ncase 0:\r\nwrite_gicreg(val, ICH_LR0_EL2);\r\nbreak;\r\ncase 1:\r\nwrite_gicreg(val, ICH_LR1_EL2);\r\nbreak;\r\ncase 2:\r\nwrite_gicreg(val, ICH_LR2_EL2);\r\nbreak;\r\ncase 3:\r\nwrite_gicreg(val, ICH_LR3_EL2);\r\nbreak;\r\ncase 4:\r\nwrite_gicreg(val, ICH_LR4_EL2);\r\nbreak;\r\ncase 5:\r\nwrite_gicreg(val, ICH_LR5_EL2);\r\nbreak;\r\ncase 6:\r\nwrite_gicreg(val, ICH_LR6_EL2);\r\nbreak;\r\ncase 7:\r\nwrite_gicreg(val, ICH_LR7_EL2);\r\nbreak;\r\ncase 8:\r\nwrite_gicreg(val, ICH_LR8_EL2);\r\nbreak;\r\ncase 9:\r\nwrite_gicreg(val, ICH_LR9_EL2);\r\nbreak;\r\ncase 10:\r\nwrite_gicreg(val, ICH_LR10_EL2);\r\nbreak;\r\ncase 11:\r\nwrite_gicreg(val, ICH_LR11_EL2);\r\nbreak;\r\ncase 12:\r\nwrite_gicreg(val, ICH_LR12_EL2);\r\nbreak;\r\ncase 13:\r\nwrite_gicreg(val, ICH_LR13_EL2);\r\nbreak;\r\ncase 14:\r\nwrite_gicreg(val, ICH_LR14_EL2);\r\nbreak;\r\ncase 15:\r\nwrite_gicreg(val, ICH_LR15_EL2);\r\nbreak;\r\n}\r\n}\r\nstatic void __hyp_text __vgic_v3_write_ap0rn(u32 val, int n)\r\n{\r\nswitch (n) {\r\ncase 0:\r\nwrite_gicreg(val, ICH_AP0R0_EL2);\r\nbreak;\r\ncase 1:\r\nwrite_gicreg(val, ICH_AP0R1_EL2);\r\nbreak;\r\ncase 2:\r\nwrite_gicreg(val, ICH_AP0R2_EL2);\r\nbreak;\r\ncase 3:\r\nwrite_gicreg(val, ICH_AP0R3_EL2);\r\nbreak;\r\n}\r\n}\r\nstatic void __hyp_text __vgic_v3_write_ap1rn(u32 val, int n)\r\n{\r\nswitch (n) {\r\ncase 0:\r\nwrite_gicreg(val, ICH_AP1R0_EL2);\r\nbreak;\r\ncase 1:\r\nwrite_gicreg(val, ICH_AP1R1_EL2);\r\nbreak;\r\ncase 2:\r\nwrite_gicreg(val, ICH_AP1R2_EL2);\r\nbreak;\r\ncase 3:\r\nwrite_gicreg(val, ICH_AP1R3_EL2);\r\nbreak;\r\n}\r\n}\r\nstatic u32 __hyp_text __vgic_v3_read_ap0rn(int n)\r\n{\r\nu32 val;\r\nswitch (n) {\r\ncase 0:\r\nval = read_gicreg(ICH_AP0R0_EL2);\r\nbreak;\r\ncase 1:\r\nval = read_gicreg(ICH_AP0R1_EL2);\r\nbreak;\r\ncase 2:\r\nval = read_gicreg(ICH_AP0R2_EL2);\r\nbreak;\r\ncase 3:\r\nval = read_gicreg(ICH_AP0R3_EL2);\r\nbreak;\r\ndefault:\r\nunreachable();\r\n}\r\nreturn val;\r\n}\r\nstatic u32 __hyp_text __vgic_v3_read_ap1rn(int n)\r\n{\r\nu32 val;\r\nswitch (n) {\r\ncase 0:\r\nval = read_gicreg(ICH_AP1R0_EL2);\r\nbreak;\r\ncase 1:\r\nval = read_gicreg(ICH_AP1R1_EL2);\r\nbreak;\r\ncase 2:\r\nval = read_gicreg(ICH_AP1R2_EL2);\r\nbreak;\r\ncase 3:\r\nval = read_gicreg(ICH_AP1R3_EL2);\r\nbreak;\r\ndefault:\r\nunreachable();\r\n}\r\nreturn val;\r\n}\r\nvoid __hyp_text __vgic_v3_save_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct vgic_v3_cpu_if *cpu_if = &vcpu->arch.vgic_cpu.vgic_v3;\r\nu64 used_lrs = vcpu->arch.vgic_cpu.used_lrs;\r\nu64 val;\r\nif (!cpu_if->vgic_sre) {\r\ndsb(st);\r\ncpu_if->vgic_vmcr = read_gicreg(ICH_VMCR_EL2);\r\n}\r\nif (used_lrs) {\r\nint i;\r\nu32 nr_pre_bits;\r\ncpu_if->vgic_elrsr = read_gicreg(ICH_ELSR_EL2);\r\nwrite_gicreg(0, ICH_HCR_EL2);\r\nval = read_gicreg(ICH_VTR_EL2);\r\nnr_pre_bits = vtr_to_nr_pre_bits(val);\r\nfor (i = 0; i < used_lrs; i++) {\r\nif (cpu_if->vgic_elrsr & (1 << i))\r\ncpu_if->vgic_lr[i] &= ~ICH_LR_STATE;\r\nelse\r\ncpu_if->vgic_lr[i] = __gic_v3_get_lr(i);\r\n__gic_v3_set_lr(0, i);\r\n}\r\nswitch (nr_pre_bits) {\r\ncase 7:\r\ncpu_if->vgic_ap0r[3] = __vgic_v3_read_ap0rn(3);\r\ncpu_if->vgic_ap0r[2] = __vgic_v3_read_ap0rn(2);\r\ncase 6:\r\ncpu_if->vgic_ap0r[1] = __vgic_v3_read_ap0rn(1);\r\ndefault:\r\ncpu_if->vgic_ap0r[0] = __vgic_v3_read_ap0rn(0);\r\n}\r\nswitch (nr_pre_bits) {\r\ncase 7:\r\ncpu_if->vgic_ap1r[3] = __vgic_v3_read_ap1rn(3);\r\ncpu_if->vgic_ap1r[2] = __vgic_v3_read_ap1rn(2);\r\ncase 6:\r\ncpu_if->vgic_ap1r[1] = __vgic_v3_read_ap1rn(1);\r\ndefault:\r\ncpu_if->vgic_ap1r[0] = __vgic_v3_read_ap1rn(0);\r\n}\r\n} else {\r\nif (static_branch_unlikely(&vgic_v3_cpuif_trap))\r\nwrite_gicreg(0, ICH_HCR_EL2);\r\ncpu_if->vgic_elrsr = 0xffff;\r\ncpu_if->vgic_ap0r[0] = 0;\r\ncpu_if->vgic_ap0r[1] = 0;\r\ncpu_if->vgic_ap0r[2] = 0;\r\ncpu_if->vgic_ap0r[3] = 0;\r\ncpu_if->vgic_ap1r[0] = 0;\r\ncpu_if->vgic_ap1r[1] = 0;\r\ncpu_if->vgic_ap1r[2] = 0;\r\ncpu_if->vgic_ap1r[3] = 0;\r\n}\r\nval = read_gicreg(ICC_SRE_EL2);\r\nwrite_gicreg(val | ICC_SRE_EL2_ENABLE, ICC_SRE_EL2);\r\nif (!cpu_if->vgic_sre) {\r\nisb();\r\nwrite_gicreg(1, ICC_SRE_EL1);\r\n}\r\n}\r\nvoid __hyp_text __vgic_v3_restore_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct vgic_v3_cpu_if *cpu_if = &vcpu->arch.vgic_cpu.vgic_v3;\r\nu64 used_lrs = vcpu->arch.vgic_cpu.used_lrs;\r\nu64 val;\r\nu32 nr_pre_bits;\r\nint i;\r\nif (!cpu_if->vgic_sre) {\r\nwrite_gicreg(0, ICC_SRE_EL1);\r\nisb();\r\nwrite_gicreg(cpu_if->vgic_vmcr, ICH_VMCR_EL2);\r\n}\r\nval = read_gicreg(ICH_VTR_EL2);\r\nnr_pre_bits = vtr_to_nr_pre_bits(val);\r\nif (used_lrs) {\r\nwrite_gicreg(cpu_if->vgic_hcr, ICH_HCR_EL2);\r\nswitch (nr_pre_bits) {\r\ncase 7:\r\n__vgic_v3_write_ap0rn(cpu_if->vgic_ap0r[3], 3);\r\n__vgic_v3_write_ap0rn(cpu_if->vgic_ap0r[2], 2);\r\ncase 6:\r\n__vgic_v3_write_ap0rn(cpu_if->vgic_ap0r[1], 1);\r\ndefault:\r\n__vgic_v3_write_ap0rn(cpu_if->vgic_ap0r[0], 0);\r\n}\r\nswitch (nr_pre_bits) {\r\ncase 7:\r\n__vgic_v3_write_ap1rn(cpu_if->vgic_ap1r[3], 3);\r\n__vgic_v3_write_ap1rn(cpu_if->vgic_ap1r[2], 2);\r\ncase 6:\r\n__vgic_v3_write_ap1rn(cpu_if->vgic_ap1r[1], 1);\r\ndefault:\r\n__vgic_v3_write_ap1rn(cpu_if->vgic_ap1r[0], 0);\r\n}\r\nfor (i = 0; i < used_lrs; i++)\r\n__gic_v3_set_lr(cpu_if->vgic_lr[i], i);\r\n} else {\r\nif (static_branch_unlikely(&vgic_v3_cpuif_trap))\r\nwrite_gicreg(cpu_if->vgic_hcr, ICH_HCR_EL2);\r\n}\r\nif (!cpu_if->vgic_sre) {\r\nisb();\r\ndsb(sy);\r\n}\r\nwrite_gicreg(read_gicreg(ICC_SRE_EL2) & ~ICC_SRE_EL2_ENABLE,\r\nICC_SRE_EL2);\r\n}\r\nvoid __hyp_text __vgic_v3_init_lrs(void)\r\n{\r\nint max_lr_idx = vtr_to_max_lr_idx(read_gicreg(ICH_VTR_EL2));\r\nint i;\r\nfor (i = 0; i <= max_lr_idx; i++)\r\n__gic_v3_set_lr(0, i);\r\n}\r\nu64 __hyp_text __vgic_v3_get_ich_vtr_el2(void)\r\n{\r\nreturn read_gicreg(ICH_VTR_EL2);\r\n}\r\nu64 __hyp_text __vgic_v3_read_vmcr(void)\r\n{\r\nreturn read_gicreg(ICH_VMCR_EL2);\r\n}\r\nvoid __hyp_text __vgic_v3_write_vmcr(u32 vmcr)\r\n{\r\nwrite_gicreg(vmcr, ICH_VMCR_EL2);\r\n}\r\nstatic int __hyp_text __vgic_v3_bpr_min(void)\r\n{\r\nreturn 8 - vtr_to_nr_pre_bits(read_gicreg(ICH_VTR_EL2));\r\n}\r\nstatic int __hyp_text __vgic_v3_get_group(struct kvm_vcpu *vcpu)\r\n{\r\nu32 esr = kvm_vcpu_get_hsr(vcpu);\r\nu8 crm = (esr & ESR_ELx_SYS64_ISS_CRM_MASK) >> ESR_ELx_SYS64_ISS_CRM_SHIFT;\r\nreturn crm != 8;\r\n}\r\nstatic int __hyp_text __vgic_v3_highest_priority_lr(struct kvm_vcpu *vcpu,\r\nu32 vmcr,\r\nu64 *lr_val)\r\n{\r\nunsigned int used_lrs = vcpu->arch.vgic_cpu.used_lrs;\r\nu8 priority = GICv3_IDLE_PRIORITY;\r\nint i, lr = -1;\r\nfor (i = 0; i < used_lrs; i++) {\r\nu64 val = __gic_v3_get_lr(i);\r\nu8 lr_prio = (val & ICH_LR_PRIORITY_MASK) >> ICH_LR_PRIORITY_SHIFT;\r\nif ((val & ICH_LR_STATE) != ICH_LR_PENDING_BIT)\r\ncontinue;\r\nif (!(val & ICH_LR_GROUP) && !(vmcr & ICH_VMCR_ENG0_MASK))\r\ncontinue;\r\nif ((val & ICH_LR_GROUP) && !(vmcr & ICH_VMCR_ENG1_MASK))\r\ncontinue;\r\nif (lr_prio >= priority)\r\ncontinue;\r\npriority = lr_prio;\r\n*lr_val = val;\r\nlr = i;\r\n}\r\nif (lr == -1)\r\n*lr_val = ICC_IAR1_EL1_SPURIOUS;\r\nreturn lr;\r\n}\r\nstatic int __hyp_text __vgic_v3_find_active_lr(struct kvm_vcpu *vcpu,\r\nint intid, u64 *lr_val)\r\n{\r\nunsigned int used_lrs = vcpu->arch.vgic_cpu.used_lrs;\r\nint i;\r\nfor (i = 0; i < used_lrs; i++) {\r\nu64 val = __gic_v3_get_lr(i);\r\nif ((val & ICH_LR_VIRTUAL_ID_MASK) == intid &&\r\n(val & ICH_LR_ACTIVE_BIT)) {\r\n*lr_val = val;\r\nreturn i;\r\n}\r\n}\r\n*lr_val = ICC_IAR1_EL1_SPURIOUS;\r\nreturn -1;\r\n}\r\nstatic int __hyp_text __vgic_v3_get_highest_active_priority(void)\r\n{\r\nu8 nr_apr_regs = vtr_to_nr_apr_regs(read_gicreg(ICH_VTR_EL2));\r\nu32 hap = 0;\r\nint i;\r\nfor (i = 0; i < nr_apr_regs; i++) {\r\nu32 val;\r\nval = __vgic_v3_read_ap0rn(i);\r\nval |= __vgic_v3_read_ap1rn(i);\r\nif (!val) {\r\nhap += 32;\r\ncontinue;\r\n}\r\nreturn (hap + __ffs(val)) << __vgic_v3_bpr_min();\r\n}\r\nreturn GICv3_IDLE_PRIORITY;\r\n}\r\nstatic unsigned int __hyp_text __vgic_v3_get_bpr0(u32 vmcr)\r\n{\r\nreturn (vmcr & ICH_VMCR_BPR0_MASK) >> ICH_VMCR_BPR0_SHIFT;\r\n}\r\nstatic unsigned int __hyp_text __vgic_v3_get_bpr1(u32 vmcr)\r\n{\r\nunsigned int bpr;\r\nif (vmcr & ICH_VMCR_CBPR_MASK) {\r\nbpr = __vgic_v3_get_bpr0(vmcr);\r\nif (bpr < 7)\r\nbpr++;\r\n} else {\r\nbpr = (vmcr & ICH_VMCR_BPR1_MASK) >> ICH_VMCR_BPR1_SHIFT;\r\n}\r\nreturn bpr;\r\n}\r\nstatic u8 __hyp_text __vgic_v3_pri_to_pre(u8 pri, u32 vmcr, int grp)\r\n{\r\nunsigned int bpr;\r\nif (!grp)\r\nbpr = __vgic_v3_get_bpr0(vmcr) + 1;\r\nelse\r\nbpr = __vgic_v3_get_bpr1(vmcr);\r\nreturn pri & (GENMASK(7, 0) << bpr);\r\n}\r\nstatic void __hyp_text __vgic_v3_set_active_priority(u8 pri, u32 vmcr, int grp)\r\n{\r\nu8 pre, ap;\r\nu32 val;\r\nint apr;\r\npre = __vgic_v3_pri_to_pre(pri, vmcr, grp);\r\nap = pre >> __vgic_v3_bpr_min();\r\napr = ap / 32;\r\nif (!grp) {\r\nval = __vgic_v3_read_ap0rn(apr);\r\n__vgic_v3_write_ap0rn(val | BIT(ap % 32), apr);\r\n} else {\r\nval = __vgic_v3_read_ap1rn(apr);\r\n__vgic_v3_write_ap1rn(val | BIT(ap % 32), apr);\r\n}\r\n}\r\nstatic int __hyp_text __vgic_v3_clear_highest_active_priority(void)\r\n{\r\nu8 nr_apr_regs = vtr_to_nr_apr_regs(read_gicreg(ICH_VTR_EL2));\r\nu32 hap = 0;\r\nint i;\r\nfor (i = 0; i < nr_apr_regs; i++) {\r\nu32 ap0, ap1;\r\nint c0, c1;\r\nap0 = __vgic_v3_read_ap0rn(i);\r\nap1 = __vgic_v3_read_ap1rn(i);\r\nif (!ap0 && !ap1) {\r\nhap += 32;\r\ncontinue;\r\n}\r\nc0 = ap0 ? __ffs(ap0) : 32;\r\nc1 = ap1 ? __ffs(ap1) : 32;\r\nif (c0 < c1) {\r\nap0 &= ~BIT(c0);\r\n__vgic_v3_write_ap0rn(ap0, i);\r\nhap += c0;\r\n} else {\r\nap1 &= ~BIT(c1);\r\n__vgic_v3_write_ap1rn(ap1, i);\r\nhap += c1;\r\n}\r\nreturn hap << __vgic_v3_bpr_min();\r\n}\r\nreturn GICv3_IDLE_PRIORITY;\r\n}\r\nstatic void __hyp_text __vgic_v3_read_iar(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu64 lr_val;\r\nu8 lr_prio, pmr;\r\nint lr, grp;\r\ngrp = __vgic_v3_get_group(vcpu);\r\nlr = __vgic_v3_highest_priority_lr(vcpu, vmcr, &lr_val);\r\nif (lr < 0)\r\ngoto spurious;\r\nif (grp != !!(lr_val & ICH_LR_GROUP))\r\ngoto spurious;\r\npmr = (vmcr & ICH_VMCR_PMR_MASK) >> ICH_VMCR_PMR_SHIFT;\r\nlr_prio = (lr_val & ICH_LR_PRIORITY_MASK) >> ICH_LR_PRIORITY_SHIFT;\r\nif (pmr <= lr_prio)\r\ngoto spurious;\r\nif (__vgic_v3_get_highest_active_priority() <= __vgic_v3_pri_to_pre(lr_prio, vmcr, grp))\r\ngoto spurious;\r\nlr_val &= ~ICH_LR_STATE;\r\nif ((lr_val & ICH_LR_VIRTUAL_ID_MASK) <= VGIC_MAX_SPI)\r\nlr_val |= ICH_LR_ACTIVE_BIT;\r\n__gic_v3_set_lr(lr_val, lr);\r\n__vgic_v3_set_active_priority(lr_prio, vmcr, grp);\r\nvcpu_set_reg(vcpu, rt, lr_val & ICH_LR_VIRTUAL_ID_MASK);\r\nreturn;\r\nspurious:\r\nvcpu_set_reg(vcpu, rt, ICC_IAR1_EL1_SPURIOUS);\r\n}\r\nstatic void __hyp_text __vgic_v3_clear_active_lr(int lr, u64 lr_val)\r\n{\r\nlr_val &= ~ICH_LR_ACTIVE_BIT;\r\nif (lr_val & ICH_LR_HW) {\r\nu32 pid;\r\npid = (lr_val & ICH_LR_PHYS_ID_MASK) >> ICH_LR_PHYS_ID_SHIFT;\r\ngic_write_dir(pid);\r\n}\r\n__gic_v3_set_lr(lr_val, lr);\r\n}\r\nstatic void __hyp_text __vgic_v3_bump_eoicount(void)\r\n{\r\nu32 hcr;\r\nhcr = read_gicreg(ICH_HCR_EL2);\r\nhcr += 1 << ICH_HCR_EOIcount_SHIFT;\r\nwrite_gicreg(hcr, ICH_HCR_EL2);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_dir(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu32 vid = vcpu_get_reg(vcpu, rt);\r\nu64 lr_val;\r\nint lr;\r\nif (!(vmcr & ICH_VMCR_EOIM_MASK))\r\nreturn;\r\nif (vid >= VGIC_MIN_LPI)\r\nreturn;\r\nlr = __vgic_v3_find_active_lr(vcpu, vid, &lr_val);\r\nif (lr == -1) {\r\n__vgic_v3_bump_eoicount();\r\nreturn;\r\n}\r\n__vgic_v3_clear_active_lr(lr, lr_val);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_eoir(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu32 vid = vcpu_get_reg(vcpu, rt);\r\nu64 lr_val;\r\nu8 lr_prio, act_prio;\r\nint lr, grp;\r\ngrp = __vgic_v3_get_group(vcpu);\r\nact_prio = __vgic_v3_clear_highest_active_priority();\r\nif (vid >= VGIC_MIN_LPI)\r\nreturn;\r\nif (vmcr & ICH_VMCR_EOIM_MASK)\r\nreturn;\r\nlr = __vgic_v3_find_active_lr(vcpu, vid, &lr_val);\r\nif (lr == -1) {\r\n__vgic_v3_bump_eoicount();\r\nreturn;\r\n}\r\nlr_prio = (lr_val & ICH_LR_PRIORITY_MASK) >> ICH_LR_PRIORITY_SHIFT;\r\nif (grp != !!(lr_val & ICH_LR_GROUP) ||\r\n__vgic_v3_pri_to_pre(lr_prio, vmcr, grp) != act_prio)\r\nreturn;\r\n__vgic_v3_clear_active_lr(lr, lr_val);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_igrpen0(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nvcpu_set_reg(vcpu, rt, !!(vmcr & ICH_VMCR_ENG0_MASK));\r\n}\r\nstatic void __hyp_text __vgic_v3_read_igrpen1(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nvcpu_set_reg(vcpu, rt, !!(vmcr & ICH_VMCR_ENG1_MASK));\r\n}\r\nstatic void __hyp_text __vgic_v3_write_igrpen0(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu64 val = vcpu_get_reg(vcpu, rt);\r\nif (val & 1)\r\nvmcr |= ICH_VMCR_ENG0_MASK;\r\nelse\r\nvmcr &= ~ICH_VMCR_ENG0_MASK;\r\n__vgic_v3_write_vmcr(vmcr);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_igrpen1(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu64 val = vcpu_get_reg(vcpu, rt);\r\nif (val & 1)\r\nvmcr |= ICH_VMCR_ENG1_MASK;\r\nelse\r\nvmcr &= ~ICH_VMCR_ENG1_MASK;\r\n__vgic_v3_write_vmcr(vmcr);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_bpr0(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nvcpu_set_reg(vcpu, rt, __vgic_v3_get_bpr0(vmcr));\r\n}\r\nstatic void __hyp_text __vgic_v3_read_bpr1(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nvcpu_set_reg(vcpu, rt, __vgic_v3_get_bpr1(vmcr));\r\n}\r\nstatic void __hyp_text __vgic_v3_write_bpr0(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu64 val = vcpu_get_reg(vcpu, rt);\r\nu8 bpr_min = __vgic_v3_bpr_min() - 1;\r\nif (val < bpr_min)\r\nval = bpr_min;\r\nval <<= ICH_VMCR_BPR0_SHIFT;\r\nval &= ICH_VMCR_BPR0_MASK;\r\nvmcr &= ~ICH_VMCR_BPR0_MASK;\r\nvmcr |= val;\r\n__vgic_v3_write_vmcr(vmcr);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_bpr1(struct kvm_vcpu *vcpu, u32 vmcr, int rt)\r\n{\r\nu64 val = vcpu_get_reg(vcpu, rt);\r\nu8 bpr_min = __vgic_v3_bpr_min();\r\nif (vmcr & ICH_VMCR_CBPR_MASK)\r\nreturn;\r\nif (val < bpr_min)\r\nval = bpr_min;\r\nval <<= ICH_VMCR_BPR1_SHIFT;\r\nval &= ICH_VMCR_BPR1_MASK;\r\nvmcr &= ~ICH_VMCR_BPR1_MASK;\r\nvmcr |= val;\r\n__vgic_v3_write_vmcr(vmcr);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_apxrn(struct kvm_vcpu *vcpu, int rt, int n)\r\n{\r\nu32 val;\r\nif (!__vgic_v3_get_group(vcpu))\r\nval = __vgic_v3_read_ap0rn(n);\r\nelse\r\nval = __vgic_v3_read_ap1rn(n);\r\nvcpu_set_reg(vcpu, rt, val);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_apxrn(struct kvm_vcpu *vcpu, int rt, int n)\r\n{\r\nu32 val = vcpu_get_reg(vcpu, rt);\r\nif (!__vgic_v3_get_group(vcpu))\r\n__vgic_v3_write_ap0rn(val, n);\r\nelse\r\n__vgic_v3_write_ap1rn(val, n);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_apxr0(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_read_apxrn(vcpu, rt, 0);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_apxr1(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_read_apxrn(vcpu, rt, 1);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_apxr2(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_read_apxrn(vcpu, rt, 2);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_apxr3(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_read_apxrn(vcpu, rt, 3);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_apxr0(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_write_apxrn(vcpu, rt, 0);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_apxr1(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_write_apxrn(vcpu, rt, 1);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_apxr2(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_write_apxrn(vcpu, rt, 2);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_apxr3(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\n__vgic_v3_write_apxrn(vcpu, rt, 3);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_hppir(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu64 lr_val;\r\nint lr, lr_grp, grp;\r\ngrp = __vgic_v3_get_group(vcpu);\r\nlr = __vgic_v3_highest_priority_lr(vcpu, vmcr, &lr_val);\r\nif (lr == -1)\r\ngoto spurious;\r\nlr_grp = !!(lr_val & ICH_LR_GROUP);\r\nif (lr_grp != grp)\r\nlr_val = ICC_IAR1_EL1_SPURIOUS;\r\nspurious:\r\nvcpu_set_reg(vcpu, rt, lr_val & ICH_LR_VIRTUAL_ID_MASK);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_pmr(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nvmcr &= ICH_VMCR_PMR_MASK;\r\nvmcr >>= ICH_VMCR_PMR_SHIFT;\r\nvcpu_set_reg(vcpu, rt, vmcr);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_pmr(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu32 val = vcpu_get_reg(vcpu, rt);\r\nval <<= ICH_VMCR_PMR_SHIFT;\r\nval &= ICH_VMCR_PMR_MASK;\r\nvmcr &= ~ICH_VMCR_PMR_MASK;\r\nvmcr |= val;\r\nwrite_gicreg(vmcr, ICH_VMCR_EL2);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_rpr(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu32 val = __vgic_v3_get_highest_active_priority();\r\nvcpu_set_reg(vcpu, rt, val);\r\n}\r\nstatic void __hyp_text __vgic_v3_read_ctlr(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu32 vtr, val;\r\nvtr = read_gicreg(ICH_VTR_EL2);\r\nval = ((vtr >> 29) & 7) << ICC_CTLR_EL1_PRI_BITS_SHIFT;\r\nval |= ((vtr >> 23) & 7) << ICC_CTLR_EL1_ID_BITS_SHIFT;\r\nval |= ((vtr >> 22) & 1) << ICC_CTLR_EL1_SEIS_SHIFT;\r\nval |= ((vtr >> 21) & 1) << ICC_CTLR_EL1_A3V_SHIFT;\r\nval |= ((vmcr & ICH_VMCR_EOIM_MASK) >> ICH_VMCR_EOIM_SHIFT) << ICC_CTLR_EL1_EOImode_SHIFT;\r\nval |= (vmcr & ICH_VMCR_CBPR_MASK) >> ICH_VMCR_CBPR_SHIFT;\r\nvcpu_set_reg(vcpu, rt, val);\r\n}\r\nstatic void __hyp_text __vgic_v3_write_ctlr(struct kvm_vcpu *vcpu,\r\nu32 vmcr, int rt)\r\n{\r\nu32 val = vcpu_get_reg(vcpu, rt);\r\nif (val & ICC_CTLR_EL1_CBPR_MASK)\r\nvmcr |= ICH_VMCR_CBPR_MASK;\r\nelse\r\nvmcr &= ~ICH_VMCR_CBPR_MASK;\r\nif (val & ICC_CTLR_EL1_EOImode_MASK)\r\nvmcr |= ICH_VMCR_EOIM_MASK;\r\nelse\r\nvmcr &= ~ICH_VMCR_EOIM_MASK;\r\nwrite_gicreg(vmcr, ICH_VMCR_EL2);\r\n}\r\nint __hyp_text __vgic_v3_perform_cpuif_access(struct kvm_vcpu *vcpu)\r\n{\r\nint rt;\r\nu32 esr;\r\nu32 vmcr;\r\nvoid (*fn)(struct kvm_vcpu *, u32, int);\r\nbool is_read;\r\nu32 sysreg;\r\nesr = kvm_vcpu_get_hsr(vcpu);\r\nif (vcpu_mode_is_32bit(vcpu)) {\r\nif (!kvm_condition_valid(vcpu))\r\nreturn 1;\r\nsysreg = esr_cp15_to_sysreg(esr);\r\n} else {\r\nsysreg = esr_sys64_to_sysreg(esr);\r\n}\r\nis_read = (esr & ESR_ELx_SYS64_ISS_DIR_MASK) == ESR_ELx_SYS64_ISS_DIR_READ;\r\nswitch (sysreg) {\r\ncase SYS_ICC_IAR0_EL1:\r\ncase SYS_ICC_IAR1_EL1:\r\nif (unlikely(!is_read))\r\nreturn 0;\r\nfn = __vgic_v3_read_iar;\r\nbreak;\r\ncase SYS_ICC_EOIR0_EL1:\r\ncase SYS_ICC_EOIR1_EL1:\r\nif (unlikely(is_read))\r\nreturn 0;\r\nfn = __vgic_v3_write_eoir;\r\nbreak;\r\ncase SYS_ICC_IGRPEN1_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_igrpen1;\r\nelse\r\nfn = __vgic_v3_write_igrpen1;\r\nbreak;\r\ncase SYS_ICC_BPR1_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_bpr1;\r\nelse\r\nfn = __vgic_v3_write_bpr1;\r\nbreak;\r\ncase SYS_ICC_AP0Rn_EL1(0):\r\ncase SYS_ICC_AP1Rn_EL1(0):\r\nif (is_read)\r\nfn = __vgic_v3_read_apxr0;\r\nelse\r\nfn = __vgic_v3_write_apxr0;\r\nbreak;\r\ncase SYS_ICC_AP0Rn_EL1(1):\r\ncase SYS_ICC_AP1Rn_EL1(1):\r\nif (is_read)\r\nfn = __vgic_v3_read_apxr1;\r\nelse\r\nfn = __vgic_v3_write_apxr1;\r\nbreak;\r\ncase SYS_ICC_AP0Rn_EL1(2):\r\ncase SYS_ICC_AP1Rn_EL1(2):\r\nif (is_read)\r\nfn = __vgic_v3_read_apxr2;\r\nelse\r\nfn = __vgic_v3_write_apxr2;\r\nbreak;\r\ncase SYS_ICC_AP0Rn_EL1(3):\r\ncase SYS_ICC_AP1Rn_EL1(3):\r\nif (is_read)\r\nfn = __vgic_v3_read_apxr3;\r\nelse\r\nfn = __vgic_v3_write_apxr3;\r\nbreak;\r\ncase SYS_ICC_HPPIR0_EL1:\r\ncase SYS_ICC_HPPIR1_EL1:\r\nif (unlikely(!is_read))\r\nreturn 0;\r\nfn = __vgic_v3_read_hppir;\r\nbreak;\r\ncase SYS_ICC_IGRPEN0_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_igrpen0;\r\nelse\r\nfn = __vgic_v3_write_igrpen0;\r\nbreak;\r\ncase SYS_ICC_BPR0_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_bpr0;\r\nelse\r\nfn = __vgic_v3_write_bpr0;\r\nbreak;\r\ncase SYS_ICC_DIR_EL1:\r\nif (unlikely(is_read))\r\nreturn 0;\r\nfn = __vgic_v3_write_dir;\r\nbreak;\r\ncase SYS_ICC_RPR_EL1:\r\nif (unlikely(!is_read))\r\nreturn 0;\r\nfn = __vgic_v3_read_rpr;\r\nbreak;\r\ncase SYS_ICC_CTLR_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_ctlr;\r\nelse\r\nfn = __vgic_v3_write_ctlr;\r\nbreak;\r\ncase SYS_ICC_PMR_EL1:\r\nif (is_read)\r\nfn = __vgic_v3_read_pmr;\r\nelse\r\nfn = __vgic_v3_write_pmr;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nvmcr = __vgic_v3_read_vmcr();\r\nrt = kvm_vcpu_sys_get_rt(vcpu);\r\nfn(vcpu, vmcr, rt);\r\nreturn 1;\r\n}

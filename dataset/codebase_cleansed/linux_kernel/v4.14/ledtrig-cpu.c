void ledtrig_cpu(enum cpu_led_event ledevt)\r\n{\r\nstruct led_trigger_cpu *trig = this_cpu_ptr(&cpu_trig);\r\nbool is_active = trig->is_active;\r\nswitch (ledevt) {\r\ncase CPU_LED_IDLE_END:\r\ncase CPU_LED_START:\r\nis_active = true;\r\nbreak;\r\ncase CPU_LED_IDLE_START:\r\ncase CPU_LED_STOP:\r\ncase CPU_LED_HALTED:\r\nis_active = false;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (is_active != trig->is_active) {\r\nunsigned int active_cpus;\r\nunsigned int total_cpus;\r\ntrig->is_active = is_active;\r\natomic_add(is_active ? 1 : -1, &num_active_cpus);\r\nactive_cpus = atomic_read(&num_active_cpus);\r\ntotal_cpus = num_present_cpus();\r\nled_trigger_event(trig->_trig,\r\nis_active ? LED_FULL : LED_OFF);\r\nled_trigger_event(trig_cpu_all,\r\nDIV_ROUND_UP(LED_FULL * active_cpus, total_cpus));\r\n}\r\n}\r\nstatic int ledtrig_cpu_syscore_suspend(void)\r\n{\r\nledtrig_cpu(CPU_LED_STOP);\r\nreturn 0;\r\n}\r\nstatic void ledtrig_cpu_syscore_resume(void)\r\n{\r\nledtrig_cpu(CPU_LED_START);\r\n}\r\nstatic void ledtrig_cpu_syscore_shutdown(void)\r\n{\r\nledtrig_cpu(CPU_LED_HALTED);\r\n}\r\nstatic int ledtrig_online_cpu(unsigned int cpu)\r\n{\r\nledtrig_cpu(CPU_LED_START);\r\nreturn 0;\r\n}\r\nstatic int ledtrig_prepare_down_cpu(unsigned int cpu)\r\n{\r\nledtrig_cpu(CPU_LED_STOP);\r\nreturn 0;\r\n}\r\nstatic int __init ledtrig_cpu_init(void)\r\n{\r\nint cpu;\r\nint ret;\r\nBUILD_BUG_ON(CONFIG_NR_CPUS > 9999);\r\nled_trigger_register_simple("cpu", &trig_cpu_all);\r\nfor_each_possible_cpu(cpu) {\r\nstruct led_trigger_cpu *trig = &per_cpu(cpu_trig, cpu);\r\nsnprintf(trig->name, MAX_NAME_LEN, "cpu%d", cpu);\r\nled_trigger_register_simple(trig->name, &trig->_trig);\r\n}\r\nregister_syscore_ops(&ledtrig_cpu_syscore_ops);\r\nret = cpuhp_setup_state(CPUHP_AP_ONLINE_DYN, "leds/trigger:starting",\r\nledtrig_online_cpu, ledtrig_prepare_down_cpu);\r\nif (ret < 0)\r\npr_err("CPU hotplug notifier for ledtrig-cpu could not be registered: %d\n",\r\nret);\r\npr_info("ledtrig-cpu: registered to indicate activity on CPUs\n");\r\nreturn 0;\r\n}

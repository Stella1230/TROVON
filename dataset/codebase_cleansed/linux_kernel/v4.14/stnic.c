static inline void\r\nSTNIC_DELAY (void)\r\n{\r\nvword trash;\r\ntrash = *(vword *) 0xa0000000;\r\ntrash = *(vword *) 0xa0000000;\r\ntrash = *(vword *) 0xa0000000;\r\n}\r\nstatic inline byte\r\nSTNIC_READ (int reg)\r\n{\r\nbyte val;\r\nval = (*(vhalf *) (PA_83902 + ((reg) << 1)) >> 8) & 0xff;\r\nSTNIC_DELAY ();\r\nreturn val;\r\n}\r\nstatic inline void\r\nSTNIC_WRITE (int reg, byte val)\r\n{\r\n*(vhalf *) (PA_83902 + ((reg) << 1)) = ((half) (val) << 8);\r\nSTNIC_DELAY ();\r\n}\r\nstatic int __init stnic_probe(void)\r\n{\r\nstruct net_device *dev;\r\nint i, err;\r\nstruct ei_device *ei_local;\r\nif (! MACH_SE)\r\nreturn -ENODEV;\r\ndev = alloc_ei_netdev();\r\nif (!dev)\r\nreturn -ENOMEM;\r\n#ifdef CONFIG_SH_STANDARD_BIOS\r\nsh_bios_get_node_addr (stnic_eadr);\r\n#endif\r\nfor (i = 0; i < ETH_ALEN; i++)\r\ndev->dev_addr[i] = stnic_eadr[i];\r\ndev->base_addr = 0x1000;\r\ndev->irq = IRQ_STNIC;\r\ndev->netdev_ops = &ei_netdev_ops;\r\nerr = request_irq (dev->irq, ei_interrupt, 0, DRV_NAME, dev);\r\nif (err) {\r\nnetdev_emerg(dev, " unable to get IRQ %d.\n", dev->irq);\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nei_status.name = dev->name;\r\nei_status.word16 = 1;\r\n#ifdef __LITTLE_ENDIAN__\r\nei_status.bigendian = 0;\r\n#else\r\nei_status.bigendian = 1;\r\n#endif\r\nei_status.tx_start_page = START_PG;\r\nei_status.rx_start_page = START_PG + TX_PAGES;\r\nei_status.stop_page = STOP_PG;\r\nei_status.reset_8390 = &stnic_reset;\r\nei_status.get_8390_hdr = &stnic_get_hdr;\r\nei_status.block_input = &stnic_block_input;\r\nei_status.block_output = &stnic_block_output;\r\nstnic_init (dev);\r\nei_local = netdev_priv(dev);\r\nei_local->msg_enable = stnic_msg_enable;\r\nerr = register_netdev(dev);\r\nif (err) {\r\nfree_irq(dev->irq, dev);\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nstnic_dev = dev;\r\nnetdev_info(dev, "NS ST-NIC 83902A\n");\r\nreturn 0;\r\n}\r\nstatic void\r\nstnic_reset (struct net_device *dev)\r\n{\r\nstruct ei_device *ei_local = netdev_priv(dev);\r\n*(vhalf *) PA_83902_RST = 0;\r\nudelay (5);\r\nnetif_warn(ei_local, hw, dev, "8390 reset done (%ld).\n", jiffies);\r\n*(vhalf *) PA_83902_RST = ~0;\r\nudelay (5);\r\n}\r\nstatic void\r\nstnic_get_hdr (struct net_device *dev, struct e8390_pkt_hdr *hdr,\r\nint ring_page)\r\n{\r\nstruct ei_device *ei_local = netdev_priv(dev);\r\nhalf buf[2];\r\nSTNIC_WRITE (PG0_RSAR0, 0);\r\nSTNIC_WRITE (PG0_RSAR1, ring_page);\r\nSTNIC_WRITE (PG0_RBCR0, 4);\r\nSTNIC_WRITE (PG0_RBCR1, 0);\r\nSTNIC_WRITE (STNIC_CR, CR_RRD | CR_PG0 | CR_STA);\r\nbuf[0] = *(vhalf *) PA_83902_IF;\r\nSTNIC_DELAY ();\r\nbuf[1] = *(vhalf *) PA_83902_IF;\r\nSTNIC_DELAY ();\r\nhdr->next = buf[0] >> 8;\r\nhdr->status = buf[0] & 0xff;\r\n#ifdef __LITTLE_ENDIAN__\r\nhdr->count = buf[1];\r\n#else\r\nhdr->count = ((buf[1] >> 8) & 0xff) | (buf[1] << 8);\r\n#endif\r\nnetif_dbg(ei_local, probe, dev, "ring %x status %02x next %02x count %04x.\n",\r\nring_page, hdr->status, hdr->next, hdr->count);\r\nSTNIC_WRITE (STNIC_CR, CR_RDMA | CR_PG0 | CR_STA);\r\n}\r\nstatic void\r\nstnic_block_input (struct net_device *dev, int length, struct sk_buff *skb,\r\nint offset)\r\n{\r\nchar *buf = skb->data;\r\nhalf val;\r\nSTNIC_WRITE (PG0_RSAR0, offset & 0xff);\r\nSTNIC_WRITE (PG0_RSAR1, offset >> 8);\r\nSTNIC_WRITE (PG0_RBCR0, length & 0xff);\r\nSTNIC_WRITE (PG0_RBCR1, length >> 8);\r\nSTNIC_WRITE (STNIC_CR, CR_RRD | CR_PG0 | CR_STA);\r\nif (length & 1)\r\nlength++;\r\nwhile (length > 0)\r\n{\r\nval = *(vhalf *) PA_83902_IF;\r\n#ifdef __LITTLE_ENDIAN__\r\n*buf++ = val & 0xff;\r\n*buf++ = val >> 8;\r\n#else\r\n*buf++ = val >> 8;\r\n*buf++ = val & 0xff;\r\n#endif\r\nSTNIC_DELAY ();\r\nlength -= sizeof (half);\r\n}\r\nSTNIC_WRITE (STNIC_CR, CR_RDMA | CR_PG0 | CR_STA);\r\n}\r\nstatic void\r\nstnic_block_output (struct net_device *dev, int length,\r\nconst unsigned char *buf, int output_page)\r\n{\r\nSTNIC_WRITE (PG0_RBCR0, 1);\r\nSTNIC_WRITE (STNIC_CR, CR_RRD | CR_PG0 | CR_STA);\r\nSTNIC_DELAY ();\r\nSTNIC_WRITE (PG0_RBCR0, length & 0xff);\r\nSTNIC_WRITE (PG0_RBCR1, length >> 8);\r\nSTNIC_WRITE (PG0_RSAR0, 0);\r\nSTNIC_WRITE (PG0_RSAR1, output_page);\r\nSTNIC_WRITE (STNIC_CR, CR_RWR | CR_PG0 | CR_STA);\r\nif (length & 1)\r\nlength++;\r\nwhile (length > 0)\r\n{\r\n#ifdef __LITTLE_ENDIAN__\r\n*(vhalf *) PA_83902_IF = ((half) buf[1] << 8) | buf[0];\r\n#else\r\n*(vhalf *) PA_83902_IF = ((half) buf[0] << 8) | buf[1];\r\n#endif\r\nSTNIC_DELAY ();\r\nbuf += sizeof (half);\r\nlength -= sizeof (half);\r\n}\r\nSTNIC_WRITE (STNIC_CR, CR_RDMA | CR_PG0 | CR_STA);\r\n}\r\nstatic void\r\nstnic_init (struct net_device *dev)\r\n{\r\nstnic_reset (dev);\r\nNS8390_init (dev, 0);\r\n}\r\nstatic void __exit stnic_cleanup(void)\r\n{\r\nunregister_netdev(stnic_dev);\r\nfree_irq(stnic_dev->irq, stnic_dev);\r\nfree_netdev(stnic_dev);\r\n}

static inline int mtk_jpeg_verify_align(u32 val, int align, u32 reg)\r\n{\r\nif (val & (align - 1)) {\r\npr_err("mtk-jpeg: write reg %x without %d align\n", reg, align);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mtk_jpeg_decide_format(struct mtk_jpeg_dec_param *param)\r\n{\r\nparam->src_color = (param->sampling_w[0] << 20) |\r\n(param->sampling_h[0] << 16) |\r\n(param->sampling_w[1] << 12) |\r\n(param->sampling_h[1] << 8) |\r\n(param->sampling_w[2] << 4) |\r\n(param->sampling_h[2]);\r\nparam->uv_brz_w = 0;\r\nswitch (param->src_color) {\r\ncase MTK_JPEG_COLOR_444:\r\nparam->uv_brz_w = 1;\r\nparam->dst_fourcc = V4L2_PIX_FMT_YUV422M;\r\nbreak;\r\ncase MTK_JPEG_COLOR_422X2:\r\ncase MTK_JPEG_COLOR_422:\r\nparam->dst_fourcc = V4L2_PIX_FMT_YUV422M;\r\nbreak;\r\ncase MTK_JPEG_COLOR_422V:\r\ncase MTK_JPEG_COLOR_422VX2:\r\nparam->uv_brz_w = 1;\r\nparam->dst_fourcc = V4L2_PIX_FMT_YUV420M;\r\nbreak;\r\ncase MTK_JPEG_COLOR_420:\r\nparam->dst_fourcc = V4L2_PIX_FMT_YUV420M;\r\nbreak;\r\ncase MTK_JPEG_COLOR_400:\r\nparam->dst_fourcc = V4L2_PIX_FMT_GREY;\r\nbreak;\r\ndefault:\r\nparam->dst_fourcc = 0;\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mtk_jpeg_calc_mcu(struct mtk_jpeg_dec_param *param)\r\n{\r\nu32 factor_w, factor_h;\r\nu32 i, comp, blk;\r\nfactor_w = 2 + param->sampling_w[0];\r\nfactor_h = 2 + param->sampling_h[0];\r\nparam->mcu_w = (param->pic_w + (1 << factor_w) - 1) >> factor_w;\r\nparam->mcu_h = (param->pic_h + (1 << factor_h) - 1) >> factor_h;\r\nparam->total_mcu = param->mcu_w * param->mcu_h;\r\nparam->unit_num = ((param->pic_w + 7) >> 3) * ((param->pic_h + 7) >> 3);\r\nparam->blk_num = 0;\r\nfor (i = 0; i < MTK_JPEG_COMP_MAX; i++) {\r\nparam->blk_comp[i] = 0;\r\nif (i >= param->comp_num)\r\ncontinue;\r\nparam->blk_comp[i] = param->sampling_w[i] *\r\nparam->sampling_h[i];\r\nparam->blk_num += param->blk_comp[i];\r\n}\r\nparam->membership = 0;\r\nfor (i = 0, blk = 0, comp = 0; i < MTK_JPEG_BLOCK_MAX; i++) {\r\nif (i < param->blk_num && comp < param->comp_num) {\r\nu32 tmp;\r\ntmp = (0x04 + (comp & 0x3));\r\nparam->membership |= tmp << (i * 3);\r\nif (++blk == param->blk_comp[comp]) {\r\ncomp++;\r\nblk = 0;\r\n}\r\n} else {\r\nparam->membership |= 7 << (i * 3);\r\n}\r\n}\r\n}\r\nstatic void mtk_jpeg_calc_dma_group(struct mtk_jpeg_dec_param *param)\r\n{\r\nu32 factor_mcu = 3;\r\nif (param->src_color == MTK_JPEG_COLOR_444 &&\r\nparam->dst_fourcc == V4L2_PIX_FMT_YUV422M)\r\nfactor_mcu = 4;\r\nelse if (param->src_color == MTK_JPEG_COLOR_422V &&\r\nparam->dst_fourcc == V4L2_PIX_FMT_YUV420M)\r\nfactor_mcu = 4;\r\nelse if (param->src_color == MTK_JPEG_COLOR_422X2 &&\r\nparam->dst_fourcc == V4L2_PIX_FMT_YUV422M)\r\nfactor_mcu = 2;\r\nelse if (param->src_color == MTK_JPEG_COLOR_400 ||\r\n(param->src_color & 0x0FFFF) == 0)\r\nfactor_mcu = 4;\r\nparam->dma_mcu = 1 << factor_mcu;\r\nparam->dma_group = param->mcu_w / param->dma_mcu;\r\nparam->dma_last_mcu = param->mcu_w % param->dma_mcu;\r\nif (param->dma_last_mcu)\r\nparam->dma_group++;\r\nelse\r\nparam->dma_last_mcu = param->dma_mcu;\r\n}\r\nstatic int mtk_jpeg_calc_dst_size(struct mtk_jpeg_dec_param *param)\r\n{\r\nu32 i, padding_w;\r\nu32 ds_row_h[3];\r\nu32 brz_w[3];\r\nbrz_w[0] = 0;\r\nbrz_w[1] = param->uv_brz_w;\r\nbrz_w[2] = brz_w[1];\r\nfor (i = 0; i < param->comp_num; i++) {\r\nif (brz_w[i] > 3)\r\nreturn -1;\r\npadding_w = param->mcu_w * MTK_JPEG_DCTSIZE *\r\nparam->sampling_w[i];\r\nparam->comp_w[i] = padding_w >> brz_w[i];\r\nparam->comp_w[i] = mtk_jpeg_align(param->comp_w[i],\r\nMTK_JPEG_DCTSIZE);\r\nparam->img_stride[i] = i ? mtk_jpeg_align(param->comp_w[i], 16)\r\n: mtk_jpeg_align(param->comp_w[i], 32);\r\nds_row_h[i] = (MTK_JPEG_DCTSIZE * param->sampling_h[i]);\r\n}\r\nparam->dec_w = param->img_stride[0];\r\nparam->dec_h = ds_row_h[0] * param->mcu_h;\r\nfor (i = 0; i < MTK_JPEG_COMP_MAX; i++) {\r\nparam->mem_stride[i] = param->img_stride[i];\r\nparam->comp_size[i] = param->mem_stride[i] * ds_row_h[i] *\r\nparam->mcu_h;\r\n}\r\nparam->y_size = param->comp_size[0];\r\nparam->uv_size = param->comp_size[1];\r\nparam->dec_size = param->y_size + (param->uv_size << 1);\r\nreturn 0;\r\n}\r\nint mtk_jpeg_dec_fill_param(struct mtk_jpeg_dec_param *param)\r\n{\r\nif (mtk_jpeg_decide_format(param))\r\nreturn -1;\r\nmtk_jpeg_calc_mcu(param);\r\nmtk_jpeg_calc_dma_group(param);\r\nif (mtk_jpeg_calc_dst_size(param))\r\nreturn -2;\r\nreturn 0;\r\n}\r\nu32 mtk_jpeg_dec_get_int_status(void __iomem *base)\r\n{\r\nu32 ret;\r\nret = readl(base + JPGDEC_REG_INTERRUPT_STATUS) & BIT_INQST_MASK_ALLIRQ;\r\nif (ret)\r\nwritel(ret, base + JPGDEC_REG_INTERRUPT_STATUS);\r\nreturn ret;\r\n}\r\nu32 mtk_jpeg_dec_enum_result(u32 irq_result)\r\n{\r\nif (irq_result & BIT_INQST_MASK_EOF)\r\nreturn MTK_JPEG_DEC_RESULT_EOF_DONE;\r\nif (irq_result & BIT_INQST_MASK_PAUSE)\r\nreturn MTK_JPEG_DEC_RESULT_PAUSE;\r\nif (irq_result & BIT_INQST_MASK_UNDERFLOW)\r\nreturn MTK_JPEG_DEC_RESULT_UNDERFLOW;\r\nif (irq_result & BIT_INQST_MASK_OVERFLOW)\r\nreturn MTK_JPEG_DEC_RESULT_OVERFLOW;\r\nif (irq_result & BIT_INQST_MASK_ERROR_BS)\r\nreturn MTK_JPEG_DEC_RESULT_ERROR_BS;\r\nreturn MTK_JPEG_DEC_RESULT_ERROR_UNKNOWN;\r\n}\r\nvoid mtk_jpeg_dec_start(void __iomem *base)\r\n{\r\nwritel(0, base + JPGDEC_REG_TRIG);\r\n}\r\nstatic void mtk_jpeg_dec_soft_reset(void __iomem *base)\r\n{\r\nwritel(0x0000FFFF, base + JPGDEC_REG_INTERRUPT_STATUS);\r\nwritel(0x00, base + JPGDEC_REG_RESET);\r\nwritel(0x01, base + JPGDEC_REG_RESET);\r\n}\r\nstatic void mtk_jpeg_dec_hard_reset(void __iomem *base)\r\n{\r\nwritel(0x00, base + JPGDEC_REG_RESET);\r\nwritel(0x10, base + JPGDEC_REG_RESET);\r\n}\r\nvoid mtk_jpeg_dec_reset(void __iomem *base)\r\n{\r\nmtk_jpeg_dec_soft_reset(base);\r\nmtk_jpeg_dec_hard_reset(base);\r\n}\r\nstatic void mtk_jpeg_dec_set_brz_factor(void __iomem *base, u8 yscale_w,\r\nu8 yscale_h, u8 uvscale_w, u8 uvscale_h)\r\n{\r\nu32 val;\r\nval = (uvscale_h << 12) | (uvscale_w << 8) |\r\n(yscale_h << 4) | yscale_w;\r\nwritel(val, base + JPGDEC_REG_BRZ_FACTOR);\r\n}\r\nstatic void mtk_jpeg_dec_set_dst_bank0(void __iomem *base, u32 addr_y,\r\nu32 addr_u, u32 addr_v)\r\n{\r\nmtk_jpeg_verify_align(addr_y, 16, JPGDEC_REG_DEST_ADDR0_Y);\r\nwritel(addr_y, base + JPGDEC_REG_DEST_ADDR0_Y);\r\nmtk_jpeg_verify_align(addr_u, 16, JPGDEC_REG_DEST_ADDR0_U);\r\nwritel(addr_u, base + JPGDEC_REG_DEST_ADDR0_U);\r\nmtk_jpeg_verify_align(addr_v, 16, JPGDEC_REG_DEST_ADDR0_V);\r\nwritel(addr_v, base + JPGDEC_REG_DEST_ADDR0_V);\r\n}\r\nstatic void mtk_jpeg_dec_set_dst_bank1(void __iomem *base, u32 addr_y,\r\nu32 addr_u, u32 addr_v)\r\n{\r\nwritel(addr_y, base + JPGDEC_REG_DEST_ADDR1_Y);\r\nwritel(addr_u, base + JPGDEC_REG_DEST_ADDR1_U);\r\nwritel(addr_v, base + JPGDEC_REG_DEST_ADDR1_V);\r\n}\r\nstatic void mtk_jpeg_dec_set_mem_stride(void __iomem *base, u32 stride_y,\r\nu32 stride_uv)\r\n{\r\nwritel((stride_y & 0xFFFF), base + JPGDEC_REG_STRIDE_Y);\r\nwritel((stride_uv & 0xFFFF), base + JPGDEC_REG_STRIDE_UV);\r\n}\r\nstatic void mtk_jpeg_dec_set_img_stride(void __iomem *base, u32 stride_y,\r\nu32 stride_uv)\r\n{\r\nwritel((stride_y & 0xFFFF), base + JPGDEC_REG_IMG_STRIDE_Y);\r\nwritel((stride_uv & 0xFFFF), base + JPGDEC_REG_IMG_STRIDE_UV);\r\n}\r\nstatic void mtk_jpeg_dec_set_pause_mcu_idx(void __iomem *base, u32 idx)\r\n{\r\nwritel(idx & 0x0003FFFFFF, base + JPGDEC_REG_PAUSE_MCU_NUM);\r\n}\r\nstatic void mtk_jpeg_dec_set_dec_mode(void __iomem *base, u32 mode)\r\n{\r\nwritel(mode & 0x03, base + JPGDEC_REG_OPERATION_MODE);\r\n}\r\nstatic void mtk_jpeg_dec_set_bs_write_ptr(void __iomem *base, u32 ptr)\r\n{\r\nmtk_jpeg_verify_align(ptr, 16, JPGDEC_REG_FILE_BRP);\r\nwritel(ptr, base + JPGDEC_REG_FILE_BRP);\r\n}\r\nstatic void mtk_jpeg_dec_set_bs_info(void __iomem *base, u32 addr, u32 size)\r\n{\r\nmtk_jpeg_verify_align(addr, 16, JPGDEC_REG_FILE_ADDR);\r\nmtk_jpeg_verify_align(size, 128, JPGDEC_REG_FILE_TOTAL_SIZE);\r\nwritel(addr, base + JPGDEC_REG_FILE_ADDR);\r\nwritel(size, base + JPGDEC_REG_FILE_TOTAL_SIZE);\r\n}\r\nstatic void mtk_jpeg_dec_set_comp_id(void __iomem *base, u32 id_y, u32 id_u,\r\nu32 id_v)\r\n{\r\nu32 val;\r\nval = ((id_y & 0x00FF) << 24) | ((id_u & 0x00FF) << 16) |\r\n((id_v & 0x00FF) << 8);\r\nwritel(val, base + JPGDEC_REG_COMP_ID);\r\n}\r\nstatic void mtk_jpeg_dec_set_total_mcu(void __iomem *base, u32 num)\r\n{\r\nwritel(num - 1, base + JPGDEC_REG_TOTAL_MCU_NUM);\r\n}\r\nstatic void mtk_jpeg_dec_set_comp0_du(void __iomem *base, u32 num)\r\n{\r\nwritel(num - 1, base + JPGDEC_REG_COMP0_DATA_UNIT_NUM);\r\n}\r\nstatic void mtk_jpeg_dec_set_du_membership(void __iomem *base, u32 member,\r\nu32 gmc, u32 isgray)\r\n{\r\nif (isgray)\r\nmember = 0x3FFFFFFC;\r\nmember |= (isgray << 31) | (gmc << 30);\r\nwritel(member, base + JPGDEC_REG_DU_CTRL);\r\n}\r\nstatic void mtk_jpeg_dec_set_q_table(void __iomem *base, u32 id0, u32 id1,\r\nu32 id2)\r\n{\r\nu32 val;\r\nval = ((id0 & 0x0f) << 8) | ((id1 & 0x0f) << 4) | ((id2 & 0x0f) << 0);\r\nwritel(val, base + JPGDEC_REG_QT_ID);\r\n}\r\nstatic void mtk_jpeg_dec_set_dma_group(void __iomem *base, u32 mcu_group,\r\nu32 group_num, u32 last_mcu)\r\n{\r\nu32 val;\r\nval = (((mcu_group - 1) & 0x00FF) << 16) |\r\n(((group_num - 1) & 0x007F) << 8) |\r\n((last_mcu - 1) & 0x00FF);\r\nwritel(val, base + JPGDEC_REG_WDMA_CTRL);\r\n}\r\nstatic void mtk_jpeg_dec_set_sampling_factor(void __iomem *base, u32 comp_num,\r\nu32 y_w, u32 y_h, u32 u_w,\r\nu32 u_h, u32 v_w, u32 v_h)\r\n{\r\nu32 val;\r\nu32 y_wh = (MTK_JPEG_DUNUM_MASK(y_w) << 2) | MTK_JPEG_DUNUM_MASK(y_h);\r\nu32 u_wh = (MTK_JPEG_DUNUM_MASK(u_w) << 2) | MTK_JPEG_DUNUM_MASK(u_h);\r\nu32 v_wh = (MTK_JPEG_DUNUM_MASK(v_w) << 2) | MTK_JPEG_DUNUM_MASK(v_h);\r\nif (comp_num == 1)\r\nval = 0;\r\nelse\r\nval = (y_wh << 8) | (u_wh << 4) | v_wh;\r\nwritel(val, base + JPGDEC_REG_DU_NUM);\r\n}\r\nvoid mtk_jpeg_dec_set_config(void __iomem *base,\r\nstruct mtk_jpeg_dec_param *config,\r\nstruct mtk_jpeg_bs *bs,\r\nstruct mtk_jpeg_fb *fb)\r\n{\r\nmtk_jpeg_dec_set_brz_factor(base, 0, 0, config->uv_brz_w, 0);\r\nmtk_jpeg_dec_set_dec_mode(base, 0);\r\nmtk_jpeg_dec_set_comp0_du(base, config->unit_num);\r\nmtk_jpeg_dec_set_total_mcu(base, config->total_mcu);\r\nmtk_jpeg_dec_set_bs_info(base, bs->str_addr, bs->size);\r\nmtk_jpeg_dec_set_bs_write_ptr(base, bs->end_addr);\r\nmtk_jpeg_dec_set_du_membership(base, config->membership, 1,\r\n(config->comp_num == 1) ? 1 : 0);\r\nmtk_jpeg_dec_set_comp_id(base, config->comp_id[0], config->comp_id[1],\r\nconfig->comp_id[2]);\r\nmtk_jpeg_dec_set_q_table(base, config->qtbl_num[0],\r\nconfig->qtbl_num[1], config->qtbl_num[2]);\r\nmtk_jpeg_dec_set_sampling_factor(base, config->comp_num,\r\nconfig->sampling_w[0],\r\nconfig->sampling_h[0],\r\nconfig->sampling_w[1],\r\nconfig->sampling_h[1],\r\nconfig->sampling_w[2],\r\nconfig->sampling_h[2]);\r\nmtk_jpeg_dec_set_mem_stride(base, config->mem_stride[0],\r\nconfig->mem_stride[1]);\r\nmtk_jpeg_dec_set_img_stride(base, config->img_stride[0],\r\nconfig->img_stride[1]);\r\nmtk_jpeg_dec_set_dst_bank0(base, fb->plane_addr[0],\r\nfb->plane_addr[1], fb->plane_addr[2]);\r\nmtk_jpeg_dec_set_dst_bank1(base, 0, 0, 0);\r\nmtk_jpeg_dec_set_dma_group(base, config->dma_mcu, config->dma_group,\r\nconfig->dma_last_mcu);\r\nmtk_jpeg_dec_set_pause_mcu_idx(base, config->total_mcu);\r\n}

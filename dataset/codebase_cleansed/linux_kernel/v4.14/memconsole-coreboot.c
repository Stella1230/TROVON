static ssize_t memconsole_coreboot_read(char *buf, loff_t pos, size_t count)\r\n{\r\nu32 cursor = cbmem_console->cursor & CURSOR_MASK;\r\nu32 flags = cbmem_console->cursor & ~CURSOR_MASK;\r\nu32 size = cbmem_console_size;\r\nstruct seg {\r\nu32 phys;\r\nu32 len;\r\n} seg[2] = { {0}, {0} };\r\nsize_t done = 0;\r\nint i;\r\nif (flags & OVERFLOW) {\r\nif (cursor > size)\r\ncursor = 0;\r\nseg[0] = (struct seg){.phys = cursor, .len = size - cursor};\r\nseg[1] = (struct seg){.phys = 0, .len = cursor};\r\n} else {\r\nseg[0] = (struct seg){.phys = 0, .len = min(cursor, size)};\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(seg) && count > done; i++) {\r\ndone += memory_read_from_buffer(buf + done, count - done, &pos,\r\ncbmem_console->body + seg[i].phys, seg[i].len);\r\npos -= seg[i].len;\r\n}\r\nreturn done;\r\n}\r\nstatic int memconsole_coreboot_init(phys_addr_t physaddr)\r\n{\r\nstruct cbmem_cons __iomem *tmp_cbmc;\r\ntmp_cbmc = memremap(physaddr, sizeof(*tmp_cbmc), MEMREMAP_WB);\r\nif (!tmp_cbmc)\r\nreturn -ENOMEM;\r\ncbmem_console_size = tmp_cbmc->size_dont_access_after_boot;\r\ncbmem_console = memremap(physaddr,\r\ncbmem_console_size + sizeof(*cbmem_console),\r\nMEMREMAP_WB);\r\nmemunmap(tmp_cbmc);\r\nif (!cbmem_console)\r\nreturn -ENOMEM;\r\nmemconsole_setup(memconsole_coreboot_read);\r\nreturn 0;\r\n}\r\nstatic int memconsole_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct lb_cbmem_ref entry;\r\nret = coreboot_table_find(CB_TAG_CBMEM_CONSOLE, &entry, sizeof(entry));\r\nif (ret)\r\nreturn ret;\r\nret = memconsole_coreboot_init(entry.cbmem_addr);\r\nif (ret)\r\nreturn ret;\r\nreturn memconsole_sysfs_init();\r\n}\r\nstatic int memconsole_remove(struct platform_device *pdev)\r\n{\r\nmemconsole_exit();\r\nif (cbmem_console)\r\nmemunmap(cbmem_console);\r\nreturn 0;\r\n}\r\nstatic int __init platform_memconsole_init(void)\r\n{\r\nstruct platform_device *pdev;\r\npdev = platform_device_register_simple("memconsole", -1, NULL, 0);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\nplatform_driver_register(&memconsole_driver);\r\nreturn 0;\r\n}

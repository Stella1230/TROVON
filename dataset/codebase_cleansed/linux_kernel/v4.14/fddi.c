static int fddi_header(struct sk_buff *skb, struct net_device *dev,\r\nunsigned short type,\r\nconst void *daddr, const void *saddr, unsigned int len)\r\n{\r\nint hl = FDDI_K_SNAP_HLEN;\r\nstruct fddihdr *fddi;\r\nif(type != ETH_P_IP && type != ETH_P_IPV6 && type != ETH_P_ARP)\r\nhl=FDDI_K_8022_HLEN-3;\r\nfddi = skb_push(skb, hl);\r\nfddi->fc = FDDI_FC_K_ASYNC_LLC_DEF;\r\nif(type == ETH_P_IP || type == ETH_P_IPV6 || type == ETH_P_ARP)\r\n{\r\nfddi->hdr.llc_snap.dsap = FDDI_EXTENDED_SAP;\r\nfddi->hdr.llc_snap.ssap = FDDI_EXTENDED_SAP;\r\nfddi->hdr.llc_snap.ctrl = FDDI_UI_CMD;\r\nfddi->hdr.llc_snap.oui[0] = 0x00;\r\nfddi->hdr.llc_snap.oui[1] = 0x00;\r\nfddi->hdr.llc_snap.oui[2] = 0x00;\r\nfddi->hdr.llc_snap.ethertype = htons(type);\r\n}\r\nif (saddr != NULL)\r\nmemcpy(fddi->saddr, saddr, dev->addr_len);\r\nelse\r\nmemcpy(fddi->saddr, dev->dev_addr, dev->addr_len);\r\nif (daddr != NULL)\r\n{\r\nmemcpy(fddi->daddr, daddr, dev->addr_len);\r\nreturn hl;\r\n}\r\nreturn -hl;\r\n}\r\n__be16 fddi_type_trans(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct fddihdr *fddi = (struct fddihdr *)skb->data;\r\n__be16 type;\r\nskb->dev = dev;\r\nskb_reset_mac_header(skb);\r\nif(fddi->hdr.llc_8022_1.dsap==0xe0)\r\n{\r\nskb_pull(skb, FDDI_K_8022_HLEN-3);\r\ntype = htons(ETH_P_802_2);\r\n}\r\nelse\r\n{\r\nskb_pull(skb, FDDI_K_SNAP_HLEN);\r\ntype=fddi->hdr.llc_snap.ethertype;\r\n}\r\nif (*fddi->daddr & 0x01)\r\n{\r\nif (memcmp(fddi->daddr, dev->broadcast, FDDI_K_ALEN) == 0)\r\nskb->pkt_type = PACKET_BROADCAST;\r\nelse\r\nskb->pkt_type = PACKET_MULTICAST;\r\n}\r\nelse if (dev->flags & IFF_PROMISC)\r\n{\r\nif (memcmp(fddi->daddr, dev->dev_addr, FDDI_K_ALEN))\r\nskb->pkt_type = PACKET_OTHERHOST;\r\n}\r\nreturn type;\r\n}\r\nstatic void fddi_setup(struct net_device *dev)\r\n{\r\ndev->header_ops = &fddi_header_ops;\r\ndev->type = ARPHRD_FDDI;\r\ndev->hard_header_len = FDDI_K_SNAP_HLEN+3;\r\ndev->mtu = FDDI_K_SNAP_DLEN;\r\ndev->min_mtu = FDDI_K_SNAP_HLEN;\r\ndev->max_mtu = FDDI_K_SNAP_DLEN;\r\ndev->addr_len = FDDI_K_ALEN;\r\ndev->tx_queue_len = 100;\r\ndev->flags = IFF_BROADCAST | IFF_MULTICAST;\r\nmemset(dev->broadcast, 0xFF, FDDI_K_ALEN);\r\n}\r\nstruct net_device *alloc_fddidev(int sizeof_priv)\r\n{\r\nreturn alloc_netdev(sizeof_priv, "fddi%d", NET_NAME_UNKNOWN,\r\nfddi_setup);\r\n}

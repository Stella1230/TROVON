static int max77620_thermal_read_temp(void *data, int *temp)\r\n{\r\nstruct max77620_therm_info *mtherm = data;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(mtherm->rmap, MAX77620_REG_STATLBT, &val);\r\nif (ret < 0) {\r\ndev_err(mtherm->dev, "Failed to read STATLBT: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (val & MAX77620_IRQ_TJALRM2_MASK)\r\n*temp = MAX77620_TJALARM2_TEMP;\r\nelse if (val & MAX77620_IRQ_TJALRM1_MASK)\r\n*temp = MAX77620_TJALARM1_TEMP;\r\nelse\r\n*temp = MAX77620_NORMAL_OPERATING_TEMP;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t max77620_thermal_irq(int irq, void *data)\r\n{\r\nstruct max77620_therm_info *mtherm = data;\r\nif (irq == mtherm->irq_tjalarm1)\r\ndev_warn(mtherm->dev, "Junction Temp Alarm1(120C) occurred\n");\r\nelse if (irq == mtherm->irq_tjalarm2)\r\ndev_crit(mtherm->dev, "Junction Temp Alarm2(140C) occurred\n");\r\nthermal_zone_device_update(mtherm->tz_device,\r\nTHERMAL_EVENT_UNSPECIFIED);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int max77620_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct max77620_therm_info *mtherm;\r\nint ret;\r\nmtherm = devm_kzalloc(&pdev->dev, sizeof(*mtherm), GFP_KERNEL);\r\nif (!mtherm)\r\nreturn -ENOMEM;\r\nmtherm->irq_tjalarm1 = platform_get_irq(pdev, 0);\r\nmtherm->irq_tjalarm2 = platform_get_irq(pdev, 1);\r\nif ((mtherm->irq_tjalarm1 < 0) || (mtherm->irq_tjalarm2 < 0)) {\r\ndev_err(&pdev->dev, "Alarm irq number not available\n");\r\nreturn -EINVAL;\r\n}\r\nmtherm->dev = &pdev->dev;\r\nmtherm->rmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!mtherm->rmap) {\r\ndev_err(&pdev->dev, "Failed to get parent regmap\n");\r\nreturn -ENODEV;\r\n}\r\ndevice_set_of_node_from_dev(&pdev->dev, pdev->dev.parent);\r\nmtherm->tz_device = devm_thermal_zone_of_sensor_register(&pdev->dev, 0,\r\nmtherm, &max77620_thermal_ops);\r\nif (IS_ERR(mtherm->tz_device)) {\r\nret = PTR_ERR(mtherm->tz_device);\r\ndev_err(&pdev->dev, "Failed to register thermal zone: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, mtherm->irq_tjalarm1, NULL,\r\nmax77620_thermal_irq,\r\nIRQF_ONESHOT | IRQF_SHARED,\r\ndev_name(&pdev->dev), mtherm);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to request irq1: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, mtherm->irq_tjalarm2, NULL,\r\nmax77620_thermal_irq,\r\nIRQF_ONESHOT | IRQF_SHARED,\r\ndev_name(&pdev->dev), mtherm);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to request irq2: %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, mtherm);\r\nreturn 0;\r\n}

static void o2_pci_set_baseclk(struct sdhci_pci_chip *chip, u32 value)\r\n{\r\nu32 scratch_32;\r\npci_read_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, &scratch_32);\r\nscratch_32 &= 0x0000FFFF;\r\nscratch_32 |= value;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, scratch_32);\r\n}\r\nstatic void o2_pci_led_enable(struct sdhci_pci_chip *chip)\r\n{\r\nint ret;\r\nu32 scratch_32;\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG0, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~O2_SD_FREG0_LEDOFF;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG0, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_TEST_REG, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 |= O2_SD_LED_ENABLE;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_TEST_REG, scratch_32);\r\n}\r\nstatic void sdhci_pci_o2_fujin2_pci_init(struct sdhci_pci_chip *chip)\r\n{\r\nu32 scratch_32;\r\nint ret;\r\nret = pci_read_config_dword(chip->pdev, O2_SD_DEV_CTRL, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~((1 << 12) | (1 << 13) | (1 << 14));\r\npci_write_config_dword(chip->pdev, O2_SD_DEV_CTRL, scratch_32);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_MISC_REG5, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~((1 << 19) | (1 << 11));\r\nscratch_32 |= (1 << 10);\r\npci_write_config_dword(chip->pdev, O2_SD_MISC_REG5, scratch_32);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_TEST_REG, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 |= (1 << 4);\r\npci_write_config_dword(chip->pdev, O2_SD_TEST_REG, scratch_32);\r\npci_write_config_dword(chip->pdev, O2_SD_DELAY_CTRL, 0x00002492);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_LD0_CTRL, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(3 << 12);\r\npci_write_config_dword(chip->pdev, O2_SD_LD0_CTRL, scratch_32);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_CAP_REG0, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(0x01FE);\r\nscratch_32 |= 0x00CC;\r\npci_write_config_dword(chip->pdev, O2_SD_CAP_REG0, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_TUNING_CTRL, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(0x000000FF);\r\nscratch_32 |= 0x00000066;\r\npci_write_config_dword(chip->pdev, O2_SD_TUNING_CTRL, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_UHS2_L1_CTRL, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(0x000000FC);\r\nscratch_32 |= 0x00000084;\r\npci_write_config_dword(chip->pdev, O2_SD_UHS2_L1_CTRL, scratch_32);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_FUNC_REG3, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~((1 << 21) | (1 << 30));\r\npci_write_config_dword(chip->pdev, O2_SD_FUNC_REG3, scratch_32);\r\nret = pci_read_config_dword(chip->pdev, O2_SD_CAPS, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(0xf0000000);\r\nscratch_32 |= 0x30000000;\r\npci_write_config_dword(chip->pdev, O2_SD_CAPS, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_MISC_CTRL4, &scratch_32);\r\nif (ret)\r\nreturn;\r\nscratch_32 &= ~(0x000f0000);\r\nscratch_32 |= 0x00080000;\r\npci_write_config_dword(chip->pdev, O2_SD_MISC_CTRL4, scratch_32);\r\n}\r\nint sdhci_pci_o2_probe_slot(struct sdhci_pci_slot *slot)\r\n{\r\nstruct sdhci_pci_chip *chip;\r\nstruct sdhci_host *host;\r\nu32 reg;\r\nchip = slot->chip;\r\nhost = slot->host;\r\nswitch (chip->pdev->device) {\r\ncase PCI_DEVICE_ID_O2_SDS0:\r\ncase PCI_DEVICE_ID_O2_SEABIRD0:\r\ncase PCI_DEVICE_ID_O2_SEABIRD1:\r\ncase PCI_DEVICE_ID_O2_SDS1:\r\ncase PCI_DEVICE_ID_O2_FUJIN2:\r\nreg = sdhci_readl(host, O2_SD_VENDOR_SETTING);\r\nif (reg & 0x1)\r\nhost->quirks |= SDHCI_QUIRK_MULTIBLOCK_READ_ACMD12;\r\nif (chip->pdev->device != PCI_DEVICE_ID_O2_FUJIN2)\r\nbreak;\r\nreg = sdhci_readl(host, O2_SD_VENDOR_SETTING2);\r\nreg |= (1 << 12);\r\nsdhci_writel(host, reg, O2_SD_VENDOR_SETTING2);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint sdhci_pci_o2_probe(struct sdhci_pci_chip *chip)\r\n{\r\nint ret;\r\nu8 scratch;\r\nu32 scratch_32;\r\nswitch (chip->pdev->device) {\r\ncase PCI_DEVICE_ID_O2_8220:\r\ncase PCI_DEVICE_ID_O2_8221:\r\ncase PCI_DEVICE_ID_O2_8320:\r\ncase PCI_DEVICE_ID_O2_8321:\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch &= 0x7f;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\npci_write_config_byte(chip->pdev, O2_SD_MULTI_VCC3V, 0x08);\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_CLKREQ, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x20;\r\npci_write_config_byte(chip->pdev, O2_SD_CLKREQ, scratch);\r\nret = pci_read_config_byte(chip->pdev, O2_SD_CAPS, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x01;\r\npci_write_config_byte(chip->pdev, O2_SD_CAPS, scratch);\r\npci_write_config_byte(chip->pdev, O2_SD_CAPS, 0x73);\r\npci_write_config_byte(chip->pdev, O2_SD_ADMA1, 0x39);\r\npci_write_config_byte(chip->pdev, O2_SD_ADMA2, 0x08);\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_INF_MOD, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x08;\r\npci_write_config_byte(chip->pdev, O2_SD_INF_MOD, scratch);\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x80;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\nbreak;\r\ncase PCI_DEVICE_ID_O2_SDS0:\r\ncase PCI_DEVICE_ID_O2_SDS1:\r\ncase PCI_DEVICE_ID_O2_FUJIN2:\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch &= 0x7f;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\nif (chip->pdev->device == PCI_DEVICE_ID_O2_FUJIN2) {\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG0,\r\n&scratch_32);\r\nscratch_32 = ((scratch_32 & 0xFF000000) >> 24);\r\nif ((scratch_32 == 0x11) || (scratch_32 == 0x12)) {\r\nscratch_32 = 0x2c280000;\r\no2_pci_set_baseclk(chip, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG4,\r\n&scratch_32);\r\nscratch_32 |= O2_SD_FREG4_ENABLE_CLK_SET;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG4,\r\nscratch_32);\r\npci_write_config_byte(chip->pdev,\r\nO2_SD_TUNING_CTRL, 0x44);\r\nbreak;\r\n}\r\n}\r\no2_pci_led_enable(chip);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_CLK_SETTING, &scratch_32);\r\nif (ret)\r\nreturn ret;\r\nscratch_32 &= ~(0xFF00);\r\nscratch_32 |= 0x07E0C800;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_CLK_SETTING, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_CLKREQ, &scratch_32);\r\nif (ret)\r\nreturn ret;\r\nscratch_32 |= 0x3;\r\npci_write_config_dword(chip->pdev, O2_SD_CLKREQ, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, &scratch_32);\r\nif (ret)\r\nreturn ret;\r\nscratch_32 &= ~(0x1F3F070E);\r\nscratch_32 |= 0x18270106;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_CAP_REG2, &scratch_32);\r\nif (ret)\r\nreturn ret;\r\nscratch_32 &= ~(0xE0);\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_CAP_REG2, scratch_32);\r\nif (chip->pdev->device == PCI_DEVICE_ID_O2_FUJIN2)\r\nsdhci_pci_o2_fujin2_pci_init(chip);\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x80;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\nbreak;\r\ncase PCI_DEVICE_ID_O2_SEABIRD0:\r\ncase PCI_DEVICE_ID_O2_SEABIRD1:\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch &= 0x7f;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, &scratch_32);\r\nif ((scratch_32 & 0xff000000) == 0x01000000) {\r\nscratch_32 &= 0x0000FFFF;\r\nscratch_32 |= 0x1F340000;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, scratch_32);\r\n} else {\r\nscratch_32 &= 0x0000FFFF;\r\nscratch_32 |= 0x2c280000;\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_PLL_SETTING, scratch_32);\r\nret = pci_read_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG4,\r\n&scratch_32);\r\nscratch_32 |= (1 << 22);\r\npci_write_config_dword(chip->pdev,\r\nO2_SD_FUNC_REG4, scratch_32);\r\n}\r\npci_write_config_byte(chip->pdev,\r\nO2_SD_TUNING_CTRL, 0x55);\r\nret = pci_read_config_byte(chip->pdev,\r\nO2_SD_LOCK_WP, &scratch);\r\nif (ret)\r\nreturn ret;\r\nscratch |= 0x80;\r\npci_write_config_byte(chip->pdev, O2_SD_LOCK_WP, scratch);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint sdhci_pci_o2_resume(struct sdhci_pci_chip *chip)\r\n{\r\nsdhci_pci_o2_probe(chip);\r\nreturn sdhci_pci_resume_host(chip);\r\n}

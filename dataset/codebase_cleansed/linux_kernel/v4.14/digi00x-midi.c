static int midi_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nint err;\r\nerr = snd_dg00x_stream_lock_try(dg00x);\r\nif (err < 0)\r\nreturn err;\r\nmutex_lock(&dg00x->mutex);\r\ndg00x->substreams_counter++;\r\nerr = snd_dg00x_stream_start_duplex(dg00x, 0);\r\nmutex_unlock(&dg00x->mutex);\r\nif (err < 0)\r\nsnd_dg00x_stream_lock_release(dg00x);\r\nreturn err;\r\n}\r\nstatic int midi_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nmutex_lock(&dg00x->mutex);\r\ndg00x->substreams_counter--;\r\nsnd_dg00x_stream_stop_duplex(dg00x);\r\nmutex_unlock(&dg00x->mutex);\r\nsnd_dg00x_stream_lock_release(dg00x);\r\nreturn 0;\r\n}\r\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned int port;\r\nunsigned long flags;\r\nif (substream->rmidi->device == 0)\r\nport = substream->number;\r\nelse\r\nport = 2;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\namdtp_dot_midi_trigger(&dg00x->tx_stream, port, substream);\r\nelse\r\namdtp_dot_midi_trigger(&dg00x->tx_stream, port, NULL);\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned int port;\r\nunsigned long flags;\r\nif (substream->rmidi->device == 0)\r\nport = substream->number;\r\nelse\r\nport = 2;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\namdtp_dot_midi_trigger(&dg00x->rx_stream, port, substream);\r\nelse\r\namdtp_dot_midi_trigger(&dg00x->rx_stream, port, NULL);\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic void set_substream_names(struct snd_dg00x *dg00x,\r\nstruct snd_rawmidi *rmidi, bool is_console)\r\n{\r\nstruct snd_rawmidi_substream *subs;\r\nstruct snd_rawmidi_str *str;\r\nint i;\r\nfor (i = 0; i < 2; ++i) {\r\nstr = &rmidi->streams[i];\r\nlist_for_each_entry(subs, &str->substreams, list) {\r\nif (!is_console) {\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s MIDI %d",\r\ndg00x->card->shortname,\r\nsubs->number + 1);\r\n} else {\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s control",\r\ndg00x->card->shortname);\r\n}\r\n}\r\n}\r\n}\r\nstatic int add_substream_pair(struct snd_dg00x *dg00x, unsigned int out_ports,\r\nunsigned int in_ports, bool is_console)\r\n{\r\nstatic const struct snd_rawmidi_ops capture_ops = {\r\n.open = midi_open,\r\n.close = midi_close,\r\n.trigger = midi_capture_trigger,\r\n};\r\nstatic const struct snd_rawmidi_ops playback_ops = {\r\n.open = midi_open,\r\n.close = midi_close,\r\n.trigger = midi_playback_trigger,\r\n};\r\nconst char *label;\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nerr = snd_rawmidi_new(dg00x->card, dg00x->card->driver, is_console,\r\nout_ports, in_ports, &rmidi);\r\nif (err < 0)\r\nreturn err;\r\nrmidi->private_data = dg00x;\r\nif (!is_console)\r\nlabel = "%s control";\r\nelse\r\nlabel = "%s MIDI";\r\nsnprintf(rmidi->name, sizeof(rmidi->name), label,\r\ndg00x->card->shortname);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &playback_ops);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &capture_ops);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT |\r\nSNDRV_RAWMIDI_INFO_OUTPUT |\r\nSNDRV_RAWMIDI_INFO_DUPLEX;\r\nset_substream_names(dg00x, rmidi, is_console);\r\nreturn 0;\r\n}\r\nint snd_dg00x_create_midi_devices(struct snd_dg00x *dg00x)\r\n{\r\nint err;\r\nerr = add_substream_pair(dg00x, DOT_MIDI_OUT_PORTS, DOT_MIDI_IN_PORTS,\r\nfalse);\r\nif (err < 0)\r\nreturn err;\r\nif (dg00x->is_console)\r\nerr = add_substream_pair(dg00x, 1, 1, true);\r\nreturn err;\r\n}

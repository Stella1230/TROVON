static void aperfmperf_snapshot_khz(void *dummy)\r\n{\r\nu64 aperf, aperf_delta;\r\nu64 mperf, mperf_delta;\r\nstruct aperfmperf_sample *s = this_cpu_ptr(&samples);\r\nktime_t now = ktime_get();\r\ns64 time_delta = ktime_ms_delta(now, s->time);\r\nunsigned long flags;\r\nif (time_delta < APERFMPERF_CACHE_THRESHOLD_MS)\r\nreturn;\r\nlocal_irq_save(flags);\r\nrdmsrl(MSR_IA32_APERF, aperf);\r\nrdmsrl(MSR_IA32_MPERF, mperf);\r\nlocal_irq_restore(flags);\r\naperf_delta = aperf - s->aperf;\r\nmperf_delta = mperf - s->mperf;\r\nif (mperf_delta == 0)\r\nreturn;\r\ns->time = now;\r\ns->aperf = aperf;\r\ns->mperf = mperf;\r\nif (time_delta > APERFMPERF_STALE_THRESHOLD_MS)\r\ns->khz = 0;\r\nelse\r\ns->khz = div64_u64((cpu_khz * aperf_delta), mperf_delta);\r\n}\r\nunsigned int arch_freq_get_on_cpu(int cpu)\r\n{\r\nunsigned int khz;\r\nif (!cpu_khz)\r\nreturn 0;\r\nif (!static_cpu_has(X86_FEATURE_APERFMPERF))\r\nreturn 0;\r\nsmp_call_function_single(cpu, aperfmperf_snapshot_khz, NULL, 1);\r\nkhz = per_cpu(samples.khz, cpu);\r\nif (khz)\r\nreturn khz;\r\nmsleep(APERFMPERF_REFRESH_DELAY_MS);\r\nsmp_call_function_single(cpu, aperfmperf_snapshot_khz, NULL, 1);\r\nreturn per_cpu(samples.khz, cpu);\r\n}

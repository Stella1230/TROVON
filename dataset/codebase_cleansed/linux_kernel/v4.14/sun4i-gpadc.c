static int sun4i_gpadc_probe(struct platform_device *pdev)\r\n{\r\nstruct sun4i_gpadc_dev *dev;\r\nstruct resource *mem;\r\nconst struct of_device_id *of_id;\r\nconst struct mfd_cell *cells;\r\nunsigned int irq, size;\r\nint ret;\r\nof_id = of_match_node(sun4i_gpadc_of_match, pdev->dev.of_node);\r\nif (!of_id)\r\nreturn -EINVAL;\r\nswitch ((long)of_id->data) {\r\ncase ARCH_SUN4I_A10:\r\ncells = sun4i_gpadc_cells;\r\nsize = ARRAY_SIZE(sun4i_gpadc_cells);\r\nbreak;\r\ncase ARCH_SUN5I_A13:\r\ncells = sun5i_gpadc_cells;\r\nsize = ARRAY_SIZE(sun5i_gpadc_cells);\r\nbreak;\r\ncase ARCH_SUN6I_A31:\r\ncells = sun6i_gpadc_cells;\r\nsize = ARRAY_SIZE(sun6i_gpadc_cells);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndev = devm_kzalloc(&pdev->dev, sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndev->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(dev->base))\r\nreturn PTR_ERR(dev->base);\r\ndev->dev = &pdev->dev;\r\ndev_set_drvdata(dev->dev, dev);\r\ndev->regmap = devm_regmap_init_mmio(dev->dev, dev->base,\r\n&sun4i_gpadc_regmap_config);\r\nif (IS_ERR(dev->regmap)) {\r\nret = PTR_ERR(dev->regmap);\r\ndev_err(&pdev->dev, "failed to init regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\nregmap_write(dev->regmap, SUN4I_GPADC_INT_FIFOC, 0);\r\nirq = platform_get_irq(pdev, 0);\r\nret = devm_regmap_add_irq_chip(&pdev->dev, dev->regmap, irq,\r\nIRQF_ONESHOT, 0,\r\n&sun4i_gpadc_regmap_irq_chip,\r\n&dev->regmap_irqc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add irq chip: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_mfd_add_devices(dev->dev, 0, cells, size, NULL, 0, NULL);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add MFD devices: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

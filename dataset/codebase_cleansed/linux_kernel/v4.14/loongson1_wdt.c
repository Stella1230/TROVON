static int ls1x_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\r\nwritel(0x1, drvdata->base + WDT_SET);\r\nreturn 0;\r\n}\r\nstatic int ls1x_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\r\nunsigned int max_hw_heartbeat = wdt_dev->max_hw_heartbeat_ms / 1000;\r\nunsigned int counts;\r\nwdt_dev->timeout = timeout;\r\ncounts = drvdata->clk_rate * min(timeout, max_hw_heartbeat);\r\nwritel(counts, drvdata->base + WDT_TIMER);\r\nreturn 0;\r\n}\r\nstatic int ls1x_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\r\nwritel(0x1, drvdata->base + WDT_EN);\r\nreturn 0;\r\n}\r\nstatic int ls1x_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\r\nwritel(0x0, drvdata->base + WDT_EN);\r\nreturn 0;\r\n}\r\nstatic int ls1x_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata;\r\nstruct watchdog_device *ls1x_wdt;\r\nunsigned long clk_rate;\r\nstruct resource *res;\r\nint err;\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndrvdata->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(drvdata->base))\r\nreturn PTR_ERR(drvdata->base);\r\ndrvdata->clk = devm_clk_get(&pdev->dev, pdev->name);\r\nif (IS_ERR(drvdata->clk))\r\nreturn PTR_ERR(drvdata->clk);\r\nerr = clk_prepare_enable(drvdata->clk);\r\nif (err) {\r\ndev_err(&pdev->dev, "clk enable failed\n");\r\nreturn err;\r\n}\r\nclk_rate = clk_get_rate(drvdata->clk);\r\nif (!clk_rate) {\r\nerr = -EINVAL;\r\ngoto err0;\r\n}\r\ndrvdata->clk_rate = clk_rate;\r\nls1x_wdt = &drvdata->wdt;\r\nls1x_wdt->info = &ls1x_wdt_info;\r\nls1x_wdt->ops = &ls1x_wdt_ops;\r\nls1x_wdt->timeout = DEFAULT_HEARTBEAT;\r\nls1x_wdt->min_timeout = 1;\r\nls1x_wdt->max_hw_heartbeat_ms = U32_MAX / clk_rate * 1000;\r\nls1x_wdt->parent = &pdev->dev;\r\nwatchdog_init_timeout(ls1x_wdt, heartbeat, &pdev->dev);\r\nwatchdog_set_nowayout(ls1x_wdt, nowayout);\r\nwatchdog_set_drvdata(ls1x_wdt, drvdata);\r\nerr = watchdog_register_device(&drvdata->wdt);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to register watchdog device\n");\r\ngoto err0;\r\n}\r\nplatform_set_drvdata(pdev, drvdata);\r\ndev_info(&pdev->dev, "Loongson1 Watchdog driver registered\n");\r\nreturn 0;\r\nerr0:\r\nclk_disable_unprepare(drvdata->clk);\r\nreturn err;\r\n}\r\nstatic int ls1x_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct ls1x_wdt_drvdata *drvdata = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&drvdata->wdt);\r\nclk_disable_unprepare(drvdata->clk);\r\nreturn 0;\r\n}

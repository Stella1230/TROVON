static inline u8 ads7828_cmd_byte(u8 cmd, int ch)\r\n{\r\nreturn cmd | (((ch >> 1) | (ch & 0x01) << 2) << 4);\r\n}\r\nstatic ssize_t ads7828_show_in(struct device *dev, struct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ads7828_data *data = dev_get_drvdata(dev);\r\nu8 cmd = ads7828_cmd_byte(data->cmd_byte, attr->index);\r\nunsigned int regval;\r\nint err;\r\nerr = regmap_read(data->regmap, cmd, &regval);\r\nif (err < 0)\r\nreturn err;\r\nreturn sprintf(buf, "%d\n",\r\nDIV_ROUND_CLOSEST(regval * data->lsb_resol, 1000));\r\n}\r\nstatic int ads7828_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct ads7828_platform_data *pdata = dev_get_platdata(dev);\r\nstruct ads7828_data *data;\r\nstruct device *hwmon_dev;\r\nunsigned int vref_mv = ADS7828_INT_VREF_MV;\r\nunsigned int vref_uv;\r\nbool diff_input = false;\r\nbool ext_vref = false;\r\nunsigned int regval;\r\nenum ads7828_chips chip;\r\nstruct regulator *reg;\r\ndata = devm_kzalloc(dev, sizeof(struct ads7828_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (pdata) {\r\ndiff_input = pdata->diff_input;\r\next_vref = pdata->ext_vref;\r\nif (ext_vref && pdata->vref_mv)\r\nvref_mv = pdata->vref_mv;\r\n} else if (dev->of_node) {\r\ndiff_input = of_property_read_bool(dev->of_node,\r\n"ti,differential-input");\r\nreg = devm_regulator_get_optional(dev, "vref");\r\nif (!IS_ERR(reg)) {\r\nvref_uv = regulator_get_voltage(reg);\r\nvref_mv = DIV_ROUND_CLOSEST(vref_uv, 1000);\r\nif (vref_mv < ADS7828_EXT_VREF_MV_MIN ||\r\nvref_mv > ADS7828_EXT_VREF_MV_MAX)\r\nreturn -EINVAL;\r\next_vref = true;\r\n}\r\n}\r\nif (client->dev.of_node)\r\nchip = (enum ads7828_chips)\r\nof_device_get_match_data(&client->dev);\r\nelse\r\nchip = id->driver_data;\r\nvref_mv = clamp_val(vref_mv, ADS7828_EXT_VREF_MV_MIN,\r\nADS7828_EXT_VREF_MV_MAX);\r\nif (chip == ads7828) {\r\ndata->lsb_resol = DIV_ROUND_CLOSEST(vref_mv * 1000, 4096);\r\ndata->regmap = devm_regmap_init_i2c(client,\r\n&ads2828_regmap_config);\r\n} else {\r\ndata->lsb_resol = DIV_ROUND_CLOSEST(vref_mv * 1000, 256);\r\ndata->regmap = devm_regmap_init_i2c(client,\r\n&ads2830_regmap_config);\r\n}\r\nif (IS_ERR(data->regmap))\r\nreturn PTR_ERR(data->regmap);\r\ndata->cmd_byte = ext_vref ? ADS7828_CMD_PD1 : ADS7828_CMD_PD3;\r\nif (!diff_input)\r\ndata->cmd_byte |= ADS7828_CMD_SD_SE;\r\nif (!ext_vref)\r\nregmap_read(data->regmap, data->cmd_byte, &regval);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\ndata,\r\nads7828_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

static int cht_wc_byte_reg_read(void *context, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nstruct i2c_client *client = context;\r\nint ret, orig_addr = client->addr;\r\nif (!(reg & REG_ADDR_MASK)) {\r\ndev_err(&client->dev, "Error I2C address not specified\n");\r\nreturn -EINVAL;\r\n}\r\nclient->addr = (reg & REG_ADDR_MASK) >> REG_ADDR_SHIFT;\r\nret = i2c_smbus_read_byte_data(client, reg & REG_OFFSET_MASK);\r\nclient->addr = orig_addr;\r\nif (ret < 0)\r\nreturn ret;\r\n*val = ret;\r\nreturn 0;\r\n}\r\nstatic int cht_wc_byte_reg_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct i2c_client *client = context;\r\nint ret, orig_addr = client->addr;\r\nif (!(reg & REG_ADDR_MASK)) {\r\ndev_err(&client->dev, "Error I2C address not specified\n");\r\nreturn -EINVAL;\r\n}\r\nclient->addr = (reg & REG_ADDR_MASK) >> REG_ADDR_SHIFT;\r\nret = i2c_smbus_write_byte_data(client, reg & REG_OFFSET_MASK, val);\r\nclient->addr = orig_addr;\r\nreturn ret;\r\n}\r\nstatic int cht_wc_probe(struct i2c_client *client)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct intel_soc_pmic *pmic;\r\nacpi_status status;\r\nunsigned long long hrv;\r\nint ret;\r\nstatus = acpi_evaluate_integer(ACPI_HANDLE(dev), "_HRV", NULL, &hrv);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(dev, "Failed to get PMIC hardware revision\n");\r\nreturn -ENODEV;\r\n}\r\nif (hrv != CHT_WC_HRV) {\r\ndev_err(dev, "Invalid PMIC hardware revision: %llu\n", hrv);\r\nreturn -ENODEV;\r\n}\r\nif (client->irq < 0) {\r\ndev_err(dev, "Invalid IRQ\n");\r\nreturn -EINVAL;\r\n}\r\npmic = devm_kzalloc(dev, sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic)\r\nreturn -ENOMEM;\r\npmic->irq = client->irq;\r\npmic->dev = dev;\r\ni2c_set_clientdata(client, pmic);\r\npmic->regmap = devm_regmap_init(dev, NULL, client, &cht_wc_regmap_cfg);\r\nif (IS_ERR(pmic->regmap))\r\nreturn PTR_ERR(pmic->regmap);\r\nret = devm_regmap_add_irq_chip(dev, pmic->regmap, pmic->irq,\r\nIRQF_ONESHOT | IRQF_SHARED, 0,\r\n&cht_wc_regmap_irq_chip,\r\n&pmic->irq_chip_data);\r\nif (ret)\r\nreturn ret;\r\nreturn devm_mfd_add_devices(dev, PLATFORM_DEVID_NONE,\r\ncht_wc_dev, ARRAY_SIZE(cht_wc_dev), NULL, 0,\r\nregmap_irq_get_domain(pmic->irq_chip_data));\r\n}\r\nstatic void cht_wc_shutdown(struct i2c_client *client)\r\n{\r\nstruct intel_soc_pmic *pmic = i2c_get_clientdata(client);\r\ndisable_irq(pmic->irq);\r\n}\r\nstatic int __maybe_unused cht_wc_suspend(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\ndisable_irq(pmic->irq);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused cht_wc_resume(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\nenable_irq(pmic->irq);\r\nreturn 0;\r\n}

static int max11100_read_single(struct iio_dev *indio_dev, int *val)\r\n{\r\nint ret;\r\nstruct max11100_state *state = iio_priv(indio_dev);\r\nret = spi_read(state->spi, state->buffer, sizeof(state->buffer));\r\nif (ret) {\r\ndev_err(&indio_dev->dev, "SPI transfer failed\n");\r\nreturn ret;\r\n}\r\nif (state->buffer[0]) {\r\ndev_err(&indio_dev->dev, "Invalid value: buffer[0] != 0\n");\r\nreturn -EINVAL;\r\n}\r\n*val = (state->buffer[1] << 8) | state->buffer[2];\r\nreturn 0;\r\n}\r\nstatic int max11100_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long info)\r\n{\r\nint ret, vref_uv;\r\nstruct max11100_state *state = iio_priv(indio_dev);\r\nswitch (info) {\r\ncase IIO_CHAN_INFO_RAW:\r\nret = max11100_read_single(indio_dev, val);\r\nif (ret)\r\nreturn ret;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\nvref_uv = regulator_get_voltage(state->vref_reg);\r\nif (vref_uv < 0)\r\nreturn -EINVAL;\r\n*val = vref_uv / 1000;\r\n*val2 = MAX11100_LSB_DIV;\r\nreturn IIO_VAL_FRACTIONAL;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int max11100_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev;\r\nstruct max11100_state *state;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*state));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, indio_dev);\r\nstate = iio_priv(indio_dev);\r\nstate->spi = spi;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->dev.of_node = spi->dev.of_node;\r\nindio_dev->name = "max11100";\r\nindio_dev->info = &max11100_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = max11100_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(max11100_channels);\r\nstate->vref_reg = devm_regulator_get(&spi->dev, "vref");\r\nif (IS_ERR(state->vref_reg))\r\nreturn PTR_ERR(state->vref_reg);\r\nret = regulator_enable(state->vref_reg);\r\nif (ret)\r\nreturn ret;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto disable_regulator;\r\nreturn 0;\r\ndisable_regulator:\r\nregulator_disable(state->vref_reg);\r\nreturn ret;\r\n}\r\nstatic int max11100_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct max11100_state *state = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nregulator_disable(state->vref_reg);\r\nreturn 0;\r\n}

static int ti_sci_dev_id(struct device *dev)\r\n{\r\nstruct generic_pm_domain_data *genpd_data = dev_gpd_data(dev);\r\nstruct ti_sci_genpd_dev_data *sci_dev_data = genpd_data->data;\r\nreturn sci_dev_data->idx;\r\n}\r\nstatic const struct ti_sci_handle *ti_sci_dev_to_sci_handle(struct device *dev)\r\n{\r\nstruct generic_pm_domain *pd = pd_to_genpd(dev->pm_domain);\r\nstruct ti_sci_pm_domain *ti_sci_genpd = genpd_to_ti_sci_pd(pd);\r\nreturn ti_sci_genpd->ti_sci;\r\n}\r\nstatic int ti_sci_dev_start(struct device *dev)\r\n{\r\nconst struct ti_sci_handle *ti_sci = ti_sci_dev_to_sci_handle(dev);\r\nint idx = ti_sci_dev_id(dev);\r\nreturn ti_sci->ops.dev_ops.get_device(ti_sci, idx);\r\n}\r\nstatic int ti_sci_dev_stop(struct device *dev)\r\n{\r\nconst struct ti_sci_handle *ti_sci = ti_sci_dev_to_sci_handle(dev);\r\nint idx = ti_sci_dev_id(dev);\r\nreturn ti_sci->ops.dev_ops.put_device(ti_sci, idx);\r\n}\r\nstatic int ti_sci_pd_attach_dev(struct generic_pm_domain *domain,\r\nstruct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct of_phandle_args pd_args;\r\nstruct ti_sci_pm_domain *ti_sci_genpd = genpd_to_ti_sci_pd(domain);\r\nconst struct ti_sci_handle *ti_sci = ti_sci_genpd->ti_sci;\r\nstruct ti_sci_genpd_dev_data *sci_dev_data;\r\nstruct generic_pm_domain_data *genpd_data;\r\nint idx, ret = 0;\r\nret = of_parse_phandle_with_args(np, "power-domains",\r\n"#power-domain-cells", 0, &pd_args);\r\nif (ret < 0)\r\nreturn ret;\r\nif (pd_args.args_count != 1)\r\nreturn -EINVAL;\r\nidx = pd_args.args[0];\r\nret = ti_sci->ops.dev_ops.is_valid(ti_sci, idx);\r\nif (ret)\r\nreturn -EINVAL;\r\nsci_dev_data = kzalloc(sizeof(*sci_dev_data), GFP_KERNEL);\r\nif (!sci_dev_data)\r\nreturn -ENOMEM;\r\nsci_dev_data->idx = idx;\r\ngenpd_data = dev_gpd_data(dev);\r\ngenpd_data->data = sci_dev_data;\r\nreturn 0;\r\n}\r\nstatic void ti_sci_pd_detach_dev(struct generic_pm_domain *domain,\r\nstruct device *dev)\r\n{\r\nstruct generic_pm_domain_data *genpd_data = dev_gpd_data(dev);\r\nstruct ti_sci_genpd_dev_data *sci_dev_data = genpd_data->data;\r\nkfree(sci_dev_data);\r\ngenpd_data->data = NULL;\r\n}\r\nstatic int ti_sci_pm_domain_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct ti_sci_pm_domain *ti_sci_pd;\r\nint ret;\r\nti_sci_pd = devm_kzalloc(dev, sizeof(*ti_sci_pd), GFP_KERNEL);\r\nif (!ti_sci_pd)\r\nreturn -ENOMEM;\r\nti_sci_pd->ti_sci = devm_ti_sci_get_handle(dev);\r\nif (IS_ERR(ti_sci_pd->ti_sci))\r\nreturn PTR_ERR(ti_sci_pd->ti_sci);\r\nti_sci_pd->dev = dev;\r\nti_sci_pd->pd.name = "ti_sci_pd";\r\nti_sci_pd->pd.attach_dev = ti_sci_pd_attach_dev;\r\nti_sci_pd->pd.detach_dev = ti_sci_pd_detach_dev;\r\nti_sci_pd->pd.dev_ops.start = ti_sci_dev_start;\r\nti_sci_pd->pd.dev_ops.stop = ti_sci_dev_stop;\r\npm_genpd_init(&ti_sci_pd->pd, NULL, true);\r\nret = of_genpd_add_provider_simple(np, &ti_sci_pd->pd);\r\nreturn ret;\r\n}

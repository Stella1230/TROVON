static unsigned int sad_max_channels(const u8 *sad)\r\n{\r\nreturn 1 + (sad[0] & 7);\r\n}\r\nstatic int eld_limit_rates(struct snd_pcm_hw_params *params,\r\nstruct snd_pcm_hw_rule *rule)\r\n{\r\nstruct snd_interval *r = hw_param_interval(params, rule->var);\r\nconst struct snd_interval *c;\r\nunsigned int rate_mask = 7, i;\r\nconst u8 *sad, *eld = rule->private;\r\nsad = drm_eld_sad(eld);\r\nif (sad) {\r\nc = hw_param_interval_c(params, SNDRV_PCM_HW_PARAM_CHANNELS);\r\nfor (i = drm_eld_sad_count(eld); i > 0; i--, sad += 3) {\r\nunsigned max_channels = sad_max_channels(sad);\r\nif (c->min <= max_channels)\r\nrate_mask |= sad[1];\r\n}\r\n}\r\nreturn snd_interval_list(r, ARRAY_SIZE(eld_rates), eld_rates,\r\nrate_mask);\r\n}\r\nstatic int eld_limit_channels(struct snd_pcm_hw_params *params,\r\nstruct snd_pcm_hw_rule *rule)\r\n{\r\nstruct snd_interval *c = hw_param_interval(params, rule->var);\r\nconst struct snd_interval *r;\r\nstruct snd_interval t = { .min = 1, .max = 2, .integer = 1, };\r\nunsigned int i;\r\nconst u8 *sad, *eld = rule->private;\r\nsad = drm_eld_sad(eld);\r\nif (sad) {\r\nunsigned int rate_mask = 0;\r\nr = hw_param_interval_c(params, SNDRV_PCM_HW_PARAM_RATE);\r\nfor (i = 0; i < ARRAY_SIZE(eld_rates); i++)\r\nif (r->min <= eld_rates[i] && r->max >= eld_rates[i])\r\nrate_mask |= BIT(i);\r\nfor (i = drm_eld_sad_count(eld); i > 0; i--, sad += 3)\r\nif (rate_mask & sad[1])\r\nt.max = max(t.max, sad_max_channels(sad));\r\n}\r\nreturn snd_interval_refine(c, &t);\r\n}\r\nint snd_pcm_hw_constraint_eld(struct snd_pcm_runtime *runtime, void *eld)\r\n{\r\nint ret;\r\nret = snd_pcm_hw_rule_add(runtime, 0, SNDRV_PCM_HW_PARAM_RATE,\r\neld_limit_rates, eld,\r\nSNDRV_PCM_HW_PARAM_CHANNELS, -1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_pcm_hw_rule_add(runtime, 0, SNDRV_PCM_HW_PARAM_CHANNELS,\r\neld_limit_channels, eld,\r\nSNDRV_PCM_HW_PARAM_RATE, -1);\r\nreturn ret;\r\n}

static ssize_t show_name(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nconst char *name;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_name);\r\nname = pvr2_ctrl_get_desc(cip->cptr);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_name(cid=%d) is %s",\r\ncip->chptr, cip->ctl_id, name);\r\nif (!name) return -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", name);\r\n}\r\nstatic ssize_t show_type(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nconst char *name;\r\nenum pvr2_ctl_type tp;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_type);\r\ntp = pvr2_ctrl_get_type(cip->cptr);\r\nswitch (tp) {\r\ncase pvr2_ctl_int: name = "integer"; break;\r\ncase pvr2_ctl_enum: name = "enum"; break;\r\ncase pvr2_ctl_bitmask: name = "bitmask"; break;\r\ncase pvr2_ctl_bool: name = "boolean"; break;\r\ndefault: name = "?"; break;\r\n}\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_type(cid=%d) is %s",\r\ncip->chptr, cip->ctl_id, name);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", name);\r\n}\r\nstatic ssize_t show_min(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nlong val;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_min);\r\nval = pvr2_ctrl_get_min(cip->cptr);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_min(cid=%d) is %ld",\r\ncip->chptr, cip->ctl_id, val);\r\nreturn scnprintf(buf, PAGE_SIZE, "%ld\n", val);\r\n}\r\nstatic ssize_t show_max(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nlong val;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_max);\r\nval = pvr2_ctrl_get_max(cip->cptr);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_max(cid=%d) is %ld",\r\ncip->chptr, cip->ctl_id, val);\r\nreturn scnprintf(buf, PAGE_SIZE, "%ld\n", val);\r\n}\r\nstatic ssize_t show_def(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint val;\r\nint ret;\r\nunsigned int cnt = 0;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_def);\r\nret = pvr2_ctrl_get_def(cip->cptr, &val);\r\nif (ret < 0) return ret;\r\nret = pvr2_ctrl_value_to_sym(cip->cptr, ~0, val,\r\nbuf, PAGE_SIZE - 1, &cnt);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_def(cid=%d) is %.*s (%d)",\r\ncip->chptr, cip->ctl_id, cnt, buf, val);\r\nbuf[cnt] = '\n';\r\nreturn cnt + 1;\r\n}\r\nstatic ssize_t show_val_norm(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint val;\r\nint ret;\r\nunsigned int cnt = 0;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_val);\r\nret = pvr2_ctrl_get_value(cip->cptr, &val);\r\nif (ret < 0) return ret;\r\nret = pvr2_ctrl_value_to_sym(cip->cptr, ~0, val,\r\nbuf, PAGE_SIZE - 1, &cnt);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_val_norm(cid=%d) is %.*s (%d)",\r\ncip->chptr, cip->ctl_id, cnt, buf, val);\r\nbuf[cnt] = '\n';\r\nreturn cnt+1;\r\n}\r\nstatic ssize_t show_val_custom(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint val;\r\nint ret;\r\nunsigned int cnt = 0;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_custom);\r\nret = pvr2_ctrl_get_value(cip->cptr, &val);\r\nif (ret < 0) return ret;\r\nret = pvr2_ctrl_custom_value_to_sym(cip->cptr, ~0, val,\r\nbuf, PAGE_SIZE - 1, &cnt);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_val_custom(cid=%d) is %.*s (%d)",\r\ncip->chptr, cip->ctl_id, cnt, buf, val);\r\nbuf[cnt] = '\n';\r\nreturn cnt+1;\r\n}\r\nstatic ssize_t show_enum(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nlong val;\r\nunsigned int bcnt, ccnt, ecnt;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_enum);\r\necnt = pvr2_ctrl_get_cnt(cip->cptr);\r\nbcnt = 0;\r\nfor (val = 0; val < ecnt; val++) {\r\npvr2_ctrl_get_valname(cip->cptr, val, buf + bcnt,\r\nPAGE_SIZE - bcnt, &ccnt);\r\nif (!ccnt) continue;\r\nbcnt += ccnt;\r\nif (bcnt >= PAGE_SIZE) break;\r\nbuf[bcnt] = '\n';\r\nbcnt++;\r\n}\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_enum(cid=%d)",\r\ncip->chptr, cip->ctl_id);\r\nreturn bcnt;\r\n}\r\nstatic ssize_t show_bits(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint valid_bits, msk;\r\nunsigned int bcnt, ccnt;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_bits);\r\nvalid_bits = pvr2_ctrl_get_mask(cip->cptr);\r\nbcnt = 0;\r\nfor (msk = 1; valid_bits; msk <<= 1) {\r\nif (!(msk & valid_bits)) continue;\r\nvalid_bits &= ~msk;\r\npvr2_ctrl_get_valname(cip->cptr, msk, buf + bcnt,\r\nPAGE_SIZE - bcnt, &ccnt);\r\nbcnt += ccnt;\r\nif (bcnt >= PAGE_SIZE) break;\r\nbuf[bcnt] = '\n';\r\nbcnt++;\r\n}\r\npvr2_sysfs_trace("pvr2_sysfs(%p) show_bits(cid=%d)",\r\ncip->chptr, cip->ctl_id);\r\nreturn bcnt;\r\n}\r\nstatic int store_val_any(struct pvr2_sysfs_ctl_item *cip, int customfl,\r\nconst char *buf,unsigned int count)\r\n{\r\nint ret;\r\nint mask,val;\r\nif (customfl) {\r\nret = pvr2_ctrl_custom_sym_to_value(cip->cptr, buf, count,\r\n&mask, &val);\r\n} else {\r\nret = pvr2_ctrl_sym_to_value(cip->cptr, buf, count,\r\n&mask, &val);\r\n}\r\nif (ret < 0) return ret;\r\nret = pvr2_ctrl_set_mask_value(cip->cptr, mask, val);\r\npvr2_hdw_commit_ctl(cip->chptr->channel.hdw);\r\nreturn ret;\r\n}\r\nstatic ssize_t store_val_norm(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint ret;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_val);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) store_val_norm(cid=%d) \"%.*s\"",\r\ncip->chptr, cip->ctl_id, (int)count, buf);\r\nret = store_val_any(cip, 0, buf, count);\r\nif (!ret) ret = count;\r\nreturn ret;\r\n}\r\nstatic ssize_t store_val_custom(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nint ret;\r\ncip = container_of(attr, struct pvr2_sysfs_ctl_item, attr_custom);\r\npvr2_sysfs_trace("pvr2_sysfs(%p) store_val_custom(cid=%d) \"%.*s\"",\r\ncip->chptr, cip->ctl_id, (int)count, buf);\r\nret = store_val_any(cip, 1, buf, count);\r\nif (!ret) ret = count;\r\nreturn ret;\r\n}\r\nstatic void pvr2_sysfs_add_control(struct pvr2_sysfs *sfp,int ctl_id)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip;\r\nstruct pvr2_ctrl *cptr;\r\nunsigned int cnt,acnt;\r\nint ret;\r\ncptr = pvr2_hdw_get_ctrl_by_index(sfp->channel.hdw,ctl_id);\r\nif (!cptr) return;\r\ncip = kzalloc(sizeof(*cip),GFP_KERNEL);\r\nif (!cip) return;\r\npvr2_sysfs_trace("Creating pvr2_sysfs_ctl_item id=%p",cip);\r\ncip->cptr = cptr;\r\ncip->ctl_id = ctl_id;\r\ncip->chptr = sfp;\r\ncip->item_next = NULL;\r\nif (sfp->item_last) {\r\nsfp->item_last->item_next = cip;\r\n} else {\r\nsfp->item_first = cip;\r\n}\r\nsfp->item_last = cip;\r\nsysfs_attr_init(&cip->attr_name.attr);\r\ncip->attr_name.attr.name = "name";\r\ncip->attr_name.attr.mode = S_IRUGO;\r\ncip->attr_name.show = show_name;\r\nsysfs_attr_init(&cip->attr_type.attr);\r\ncip->attr_type.attr.name = "type";\r\ncip->attr_type.attr.mode = S_IRUGO;\r\ncip->attr_type.show = show_type;\r\nsysfs_attr_init(&cip->attr_min.attr);\r\ncip->attr_min.attr.name = "min_val";\r\ncip->attr_min.attr.mode = S_IRUGO;\r\ncip->attr_min.show = show_min;\r\nsysfs_attr_init(&cip->attr_max.attr);\r\ncip->attr_max.attr.name = "max_val";\r\ncip->attr_max.attr.mode = S_IRUGO;\r\ncip->attr_max.show = show_max;\r\nsysfs_attr_init(&cip->attr_def.attr);\r\ncip->attr_def.attr.name = "def_val";\r\ncip->attr_def.attr.mode = S_IRUGO;\r\ncip->attr_def.show = show_def;\r\nsysfs_attr_init(&cip->attr_val.attr);\r\ncip->attr_val.attr.name = "cur_val";\r\ncip->attr_val.attr.mode = S_IRUGO;\r\nsysfs_attr_init(&cip->attr_custom.attr);\r\ncip->attr_custom.attr.name = "custom_val";\r\ncip->attr_custom.attr.mode = S_IRUGO;\r\nsysfs_attr_init(&cip->attr_enum.attr);\r\ncip->attr_enum.attr.name = "enum_val";\r\ncip->attr_enum.attr.mode = S_IRUGO;\r\ncip->attr_enum.show = show_enum;\r\nsysfs_attr_init(&cip->attr_bits.attr);\r\ncip->attr_bits.attr.name = "bit_val";\r\ncip->attr_bits.attr.mode = S_IRUGO;\r\ncip->attr_bits.show = show_bits;\r\nif (pvr2_ctrl_is_writable(cptr)) {\r\ncip->attr_val.attr.mode |= S_IWUSR|S_IWGRP;\r\ncip->attr_custom.attr.mode |= S_IWUSR|S_IWGRP;\r\n}\r\nacnt = 0;\r\ncip->attr_gen[acnt++] = &cip->attr_name.attr;\r\ncip->attr_gen[acnt++] = &cip->attr_type.attr;\r\ncip->attr_gen[acnt++] = &cip->attr_val.attr;\r\ncip->attr_gen[acnt++] = &cip->attr_def.attr;\r\ncip->attr_val.show = show_val_norm;\r\ncip->attr_val.store = store_val_norm;\r\nif (pvr2_ctrl_has_custom_symbols(cptr)) {\r\ncip->attr_gen[acnt++] = &cip->attr_custom.attr;\r\ncip->attr_custom.show = show_val_custom;\r\ncip->attr_custom.store = store_val_custom;\r\n}\r\nswitch (pvr2_ctrl_get_type(cptr)) {\r\ncase pvr2_ctl_enum:\r\ncip->attr_gen[acnt++] = &cip->attr_enum.attr;\r\nbreak;\r\ncase pvr2_ctl_int:\r\ncip->attr_gen[acnt++] = &cip->attr_min.attr;\r\ncip->attr_gen[acnt++] = &cip->attr_max.attr;\r\nbreak;\r\ncase pvr2_ctl_bitmask:\r\ncip->attr_gen[acnt++] = &cip->attr_bits.attr;\r\nbreak;\r\ndefault: break;\r\n}\r\ncnt = scnprintf(cip->name,sizeof(cip->name)-1,"ctl_%s",\r\npvr2_ctrl_get_name(cptr));\r\ncip->name[cnt] = 0;\r\ncip->grp.name = cip->name;\r\ncip->grp.attrs = cip->attr_gen;\r\nret = sysfs_create_group(&sfp->class_dev->kobj,&cip->grp);\r\nif (ret) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"sysfs_create_group error: %d",\r\nret);\r\nreturn;\r\n}\r\ncip->created_ok = !0;\r\n}\r\nstatic void pvr2_sysfs_add_debugifc(struct pvr2_sysfs *sfp)\r\n{\r\nstruct pvr2_sysfs_debugifc *dip;\r\nint ret;\r\ndip = kzalloc(sizeof(*dip),GFP_KERNEL);\r\nif (!dip) return;\r\nsysfs_attr_init(&dip->attr_debugcmd.attr);\r\ndip->attr_debugcmd.attr.name = "debugcmd";\r\ndip->attr_debugcmd.attr.mode = S_IRUGO|S_IWUSR|S_IWGRP;\r\ndip->attr_debugcmd.show = debugcmd_show;\r\ndip->attr_debugcmd.store = debugcmd_store;\r\nsysfs_attr_init(&dip->attr_debuginfo.attr);\r\ndip->attr_debuginfo.attr.name = "debuginfo";\r\ndip->attr_debuginfo.attr.mode = S_IRUGO;\r\ndip->attr_debuginfo.show = debuginfo_show;\r\nsfp->debugifc = dip;\r\nret = device_create_file(sfp->class_dev,&dip->attr_debugcmd);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\ndip->debugcmd_created_ok = !0;\r\n}\r\nret = device_create_file(sfp->class_dev,&dip->attr_debuginfo);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\ndip->debuginfo_created_ok = !0;\r\n}\r\n}\r\nstatic void pvr2_sysfs_tear_down_debugifc(struct pvr2_sysfs *sfp)\r\n{\r\nif (!sfp->debugifc) return;\r\nif (sfp->debugifc->debuginfo_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->debugifc->attr_debuginfo);\r\n}\r\nif (sfp->debugifc->debugcmd_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->debugifc->attr_debugcmd);\r\n}\r\nkfree(sfp->debugifc);\r\nsfp->debugifc = NULL;\r\n}\r\nstatic void pvr2_sysfs_add_controls(struct pvr2_sysfs *sfp)\r\n{\r\nunsigned int idx,cnt;\r\ncnt = pvr2_hdw_get_ctrl_count(sfp->channel.hdw);\r\nfor (idx = 0; idx < cnt; idx++) {\r\npvr2_sysfs_add_control(sfp,idx);\r\n}\r\n}\r\nstatic void pvr2_sysfs_tear_down_controls(struct pvr2_sysfs *sfp)\r\n{\r\nstruct pvr2_sysfs_ctl_item *cip1,*cip2;\r\nfor (cip1 = sfp->item_first; cip1; cip1 = cip2) {\r\ncip2 = cip1->item_next;\r\nif (cip1->created_ok) {\r\nsysfs_remove_group(&sfp->class_dev->kobj,&cip1->grp);\r\n}\r\npvr2_sysfs_trace("Destroying pvr2_sysfs_ctl_item id=%p",cip1);\r\nkfree(cip1);\r\n}\r\n}\r\nstatic void pvr2_sysfs_class_release(struct class *class)\r\n{\r\nstruct pvr2_sysfs_class *clp;\r\nclp = container_of(class,struct pvr2_sysfs_class,class);\r\npvr2_sysfs_trace("Destroying pvr2_sysfs_class id=%p",clp);\r\nkfree(clp);\r\n}\r\nstatic void pvr2_sysfs_release(struct device *class_dev)\r\n{\r\npvr2_sysfs_trace("Releasing class_dev id=%p",class_dev);\r\nkfree(class_dev);\r\n}\r\nstatic void class_dev_destroy(struct pvr2_sysfs *sfp)\r\n{\r\nstruct device *dev;\r\nif (!sfp->class_dev) return;\r\n#ifdef CONFIG_VIDEO_PVRUSB2_DEBUGIFC\r\npvr2_sysfs_tear_down_debugifc(sfp);\r\n#endif\r\npvr2_sysfs_tear_down_controls(sfp);\r\nif (sfp->hdw_desc_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_hdw_desc);\r\n}\r\nif (sfp->hdw_name_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_hdw_name);\r\n}\r\nif (sfp->bus_info_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_bus_info);\r\n}\r\nif (sfp->v4l_minor_number_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_v4l_minor_number);\r\n}\r\nif (sfp->v4l_radio_minor_number_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_v4l_radio_minor_number);\r\n}\r\nif (sfp->unit_number_created_ok) {\r\ndevice_remove_file(sfp->class_dev,\r\n&sfp->attr_unit_number);\r\n}\r\npvr2_sysfs_trace("Destroying class_dev id=%p",sfp->class_dev);\r\ndev_set_drvdata(sfp->class_dev, NULL);\r\ndev = sfp->class_dev->parent;\r\nsfp->class_dev->parent = NULL;\r\nput_device(dev);\r\ndevice_unregister(sfp->class_dev);\r\nsfp->class_dev = NULL;\r\n}\r\nstatic ssize_t v4l_minor_number_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%d\n",\r\npvr2_hdw_v4l_get_minor_number(sfp->channel.hdw,\r\npvr2_v4l_type_video));\r\n}\r\nstatic ssize_t bus_info_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%s\n",\r\npvr2_hdw_get_bus_info(sfp->channel.hdw));\r\n}\r\nstatic ssize_t hdw_name_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%s\n",\r\npvr2_hdw_get_type(sfp->channel.hdw));\r\n}\r\nstatic ssize_t hdw_desc_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%s\n",\r\npvr2_hdw_get_desc(sfp->channel.hdw));\r\n}\r\nstatic ssize_t v4l_radio_minor_number_show(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%d\n",\r\npvr2_hdw_v4l_get_minor_number(sfp->channel.hdw,\r\npvr2_v4l_type_radio));\r\n}\r\nstatic ssize_t unit_number_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn scnprintf(buf,PAGE_SIZE,"%d\n",\r\npvr2_hdw_get_unit_number(sfp->channel.hdw));\r\n}\r\nstatic void class_dev_create(struct pvr2_sysfs *sfp,\r\nstruct pvr2_sysfs_class *class_ptr)\r\n{\r\nstruct usb_device *usb_dev;\r\nstruct device *class_dev;\r\nint ret;\r\nusb_dev = pvr2_hdw_get_dev(sfp->channel.hdw);\r\nif (!usb_dev) return;\r\nclass_dev = kzalloc(sizeof(*class_dev),GFP_KERNEL);\r\nif (!class_dev) return;\r\npvr2_sysfs_trace("Creating class_dev id=%p",class_dev);\r\nclass_dev->class = &class_ptr->class;\r\ndev_set_name(class_dev, "%s",\r\npvr2_hdw_get_device_identifier(sfp->channel.hdw));\r\nclass_dev->parent = get_device(&usb_dev->dev);\r\nsfp->class_dev = class_dev;\r\ndev_set_drvdata(class_dev, sfp);\r\nret = device_register(class_dev);\r\nif (ret) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_register failed");\r\nput_device(class_dev);\r\nreturn;\r\n}\r\nsysfs_attr_init(&sfp->attr_v4l_minor_number.attr);\r\nsfp->attr_v4l_minor_number.attr.name = "v4l_minor_number";\r\nsfp->attr_v4l_minor_number.attr.mode = S_IRUGO;\r\nsfp->attr_v4l_minor_number.show = v4l_minor_number_show;\r\nsfp->attr_v4l_minor_number.store = NULL;\r\nret = device_create_file(sfp->class_dev,\r\n&sfp->attr_v4l_minor_number);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->v4l_minor_number_created_ok = !0;\r\n}\r\nsysfs_attr_init(&sfp->attr_v4l_radio_minor_number.attr);\r\nsfp->attr_v4l_radio_minor_number.attr.name = "v4l_radio_minor_number";\r\nsfp->attr_v4l_radio_minor_number.attr.mode = S_IRUGO;\r\nsfp->attr_v4l_radio_minor_number.show = v4l_radio_minor_number_show;\r\nsfp->attr_v4l_radio_minor_number.store = NULL;\r\nret = device_create_file(sfp->class_dev,\r\n&sfp->attr_v4l_radio_minor_number);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->v4l_radio_minor_number_created_ok = !0;\r\n}\r\nsysfs_attr_init(&sfp->attr_unit_number.attr);\r\nsfp->attr_unit_number.attr.name = "unit_number";\r\nsfp->attr_unit_number.attr.mode = S_IRUGO;\r\nsfp->attr_unit_number.show = unit_number_show;\r\nsfp->attr_unit_number.store = NULL;\r\nret = device_create_file(sfp->class_dev,&sfp->attr_unit_number);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->unit_number_created_ok = !0;\r\n}\r\nsysfs_attr_init(&sfp->attr_bus_info.attr);\r\nsfp->attr_bus_info.attr.name = "bus_info_str";\r\nsfp->attr_bus_info.attr.mode = S_IRUGO;\r\nsfp->attr_bus_info.show = bus_info_show;\r\nsfp->attr_bus_info.store = NULL;\r\nret = device_create_file(sfp->class_dev,\r\n&sfp->attr_bus_info);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->bus_info_created_ok = !0;\r\n}\r\nsysfs_attr_init(&sfp->attr_hdw_name.attr);\r\nsfp->attr_hdw_name.attr.name = "device_hardware_type";\r\nsfp->attr_hdw_name.attr.mode = S_IRUGO;\r\nsfp->attr_hdw_name.show = hdw_name_show;\r\nsfp->attr_hdw_name.store = NULL;\r\nret = device_create_file(sfp->class_dev,\r\n&sfp->attr_hdw_name);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->hdw_name_created_ok = !0;\r\n}\r\nsysfs_attr_init(&sfp->attr_hdw_desc.attr);\r\nsfp->attr_hdw_desc.attr.name = "device_hardware_description";\r\nsfp->attr_hdw_desc.attr.mode = S_IRUGO;\r\nsfp->attr_hdw_desc.show = hdw_desc_show;\r\nsfp->attr_hdw_desc.store = NULL;\r\nret = device_create_file(sfp->class_dev,\r\n&sfp->attr_hdw_desc);\r\nif (ret < 0) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"device_create_file error: %d",\r\nret);\r\n} else {\r\nsfp->hdw_desc_created_ok = !0;\r\n}\r\npvr2_sysfs_add_controls(sfp);\r\n#ifdef CONFIG_VIDEO_PVRUSB2_DEBUGIFC\r\npvr2_sysfs_add_debugifc(sfp);\r\n#endif\r\n}\r\nstatic void pvr2_sysfs_internal_check(struct pvr2_channel *chp)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = container_of(chp,struct pvr2_sysfs,channel);\r\nif (!sfp->channel.mc_head->disconnect_flag) return;\r\npvr2_trace(PVR2_TRACE_STRUCT,"Destroying pvr2_sysfs id=%p",sfp);\r\nclass_dev_destroy(sfp);\r\npvr2_channel_done(&sfp->channel);\r\nkfree(sfp);\r\n}\r\nstruct pvr2_sysfs *pvr2_sysfs_create(struct pvr2_context *mp,\r\nstruct pvr2_sysfs_class *class_ptr)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = kzalloc(sizeof(*sfp),GFP_KERNEL);\r\nif (!sfp) return sfp;\r\npvr2_trace(PVR2_TRACE_STRUCT,"Creating pvr2_sysfs id=%p",sfp);\r\npvr2_channel_init(&sfp->channel,mp);\r\nsfp->channel.check_func = pvr2_sysfs_internal_check;\r\nclass_dev_create(sfp,class_ptr);\r\nreturn sfp;\r\n}\r\nstruct pvr2_sysfs_class *pvr2_sysfs_class_create(void)\r\n{\r\nstruct pvr2_sysfs_class *clp;\r\nclp = kzalloc(sizeof(*clp),GFP_KERNEL);\r\nif (!clp) return clp;\r\npvr2_sysfs_trace("Creating and registering pvr2_sysfs_class id=%p",\r\nclp);\r\nclp->class.name = "pvrusb2";\r\nclp->class.class_release = pvr2_sysfs_class_release;\r\nclp->class.dev_release = pvr2_sysfs_release;\r\nif (class_register(&clp->class)) {\r\npvr2_sysfs_trace(\r\n"Registration failed for pvr2_sysfs_class id=%p",clp);\r\nkfree(clp);\r\nclp = NULL;\r\n}\r\nreturn clp;\r\n}\r\nvoid pvr2_sysfs_class_destroy(struct pvr2_sysfs_class *clp)\r\n{\r\npvr2_sysfs_trace("Unregistering pvr2_sysfs_class id=%p", clp);\r\nclass_unregister(&clp->class);\r\n}\r\nstatic ssize_t debuginfo_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\npvr2_hdw_trigger_module_log(sfp->channel.hdw);\r\nreturn pvr2_debugifc_print_info(sfp->channel.hdw,buf,PAGE_SIZE);\r\n}\r\nstatic ssize_t debugcmd_show(struct device *class_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nreturn pvr2_debugifc_print_status(sfp->channel.hdw,buf,PAGE_SIZE);\r\n}\r\nstatic ssize_t debugcmd_store(struct device *class_dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pvr2_sysfs *sfp;\r\nint ret;\r\nsfp = dev_get_drvdata(class_dev);\r\nif (!sfp) return -EINVAL;\r\nret = pvr2_debugifc_docmd(sfp->channel.hdw,buf,count);\r\nif (ret < 0) return ret;\r\nreturn count;\r\n}

void cosm_set_shutdown_status(struct cosm_device *cdev, u8 shutdown_status)\r\n{\r\ndev_dbg(&cdev->dev, "Shutdown Status %s -> %s\n",\r\ncosm_shutdown_status_string[cdev->shutdown_status],\r\ncosm_shutdown_status_string[shutdown_status]);\r\ncdev->shutdown_status = shutdown_status;\r\n}\r\nvoid cosm_set_state(struct cosm_device *cdev, u8 state)\r\n{\r\ndev_dbg(&cdev->dev, "State %s -> %s\n",\r\ncosm_state_string[cdev->state],\r\ncosm_state_string[state]);\r\ncdev->state = state;\r\nsysfs_notify_dirent(cdev->state_sysfs);\r\n}\r\nstatic ssize_t\r\nfamily_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nreturn cdev->hw_ops->family(cdev, buf);\r\n}\r\nstatic ssize_t\r\nstepping_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nreturn cdev->hw_ops->stepping(cdev, buf);\r\n}\r\nstatic ssize_t\r\nstate_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev || cdev->state >= MIC_LAST)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n",\r\ncosm_state_string[cdev->state]);\r\n}\r\nstatic ssize_t\r\nstate_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nint rc;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nif (sysfs_streq(buf, "boot")) {\r\nrc = cosm_start(cdev);\r\ngoto done;\r\n}\r\nif (sysfs_streq(buf, "reset")) {\r\nrc = cosm_reset(cdev);\r\ngoto done;\r\n}\r\nif (sysfs_streq(buf, "shutdown")) {\r\nrc = cosm_shutdown(cdev);\r\ngoto done;\r\n}\r\nrc = -EINVAL;\r\ndone:\r\nif (rc)\r\ncount = rc;\r\nreturn count;\r\n}\r\nstatic ssize_t shutdown_status_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev || cdev->shutdown_status >= MIC_STATUS_LAST)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n",\r\ncosm_shutdown_status_string[cdev->shutdown_status]);\r\n}\r\nstatic ssize_t\r\nheartbeat_enable_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%d\n", cdev->sysfs_heartbeat_enable);\r\n}\r\nstatic ssize_t\r\nheartbeat_enable_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nint enable;\r\nint ret;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nmutex_lock(&cdev->cosm_mutex);\r\nret = kstrtoint(buf, 10, &enable);\r\nif (ret)\r\ngoto unlock;\r\ncdev->sysfs_heartbeat_enable = enable;\r\nif (cdev->state == MIC_ONLINE)\r\ncdev->heartbeat_watchdog_enable = enable;\r\nret = count;\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t\r\ncmdline_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nchar *cmdline;\r\nif (!cdev)\r\nreturn -EINVAL;\r\ncmdline = cdev->cmdline;\r\nif (cmdline)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", cmdline);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\ncmdline_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nmutex_lock(&cdev->cosm_mutex);\r\nkfree(cdev->cmdline);\r\ncdev->cmdline = kmalloc(count + 1, GFP_KERNEL);\r\nif (!cdev->cmdline) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(cdev->cmdline, buf, count);\r\nif (cdev->cmdline[count - 1] == '\n')\r\ncdev->cmdline[count - 1] = '\0';\r\nelse\r\ncdev->cmdline[count] = '\0';\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nfirmware_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nchar *firmware;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nfirmware = cdev->firmware;\r\nif (firmware)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", firmware);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nfirmware_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nmutex_lock(&cdev->cosm_mutex);\r\nkfree(cdev->firmware);\r\ncdev->firmware = kmalloc(count + 1, GFP_KERNEL);\r\nif (!cdev->firmware) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(cdev->firmware, buf, count);\r\nif (cdev->firmware[count - 1] == '\n')\r\ncdev->firmware[count - 1] = '\0';\r\nelse\r\ncdev->firmware[count] = '\0';\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nramdisk_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nchar *ramdisk;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nramdisk = cdev->ramdisk;\r\nif (ramdisk)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", ramdisk);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nramdisk_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nmutex_lock(&cdev->cosm_mutex);\r\nkfree(cdev->ramdisk);\r\ncdev->ramdisk = kmalloc(count + 1, GFP_KERNEL);\r\nif (!cdev->ramdisk) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(cdev->ramdisk, buf, count);\r\nif (cdev->ramdisk[count - 1] == '\n')\r\ncdev->ramdisk[count - 1] = '\0';\r\nelse\r\ncdev->ramdisk[count] = '\0';\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nbootmode_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nchar *bootmode;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nbootmode = cdev->bootmode;\r\nif (bootmode)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", bootmode);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nbootmode_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nif (!sysfs_streq(buf, "linux") && !sysfs_streq(buf, "flash"))\r\nreturn -EINVAL;\r\nmutex_lock(&cdev->cosm_mutex);\r\nkfree(cdev->bootmode);\r\ncdev->bootmode = kmalloc(count + 1, GFP_KERNEL);\r\nif (!cdev->bootmode) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(cdev->bootmode, buf, count);\r\nif (cdev->bootmode[count - 1] == '\n')\r\ncdev->bootmode[count - 1] = '\0';\r\nelse\r\ncdev->bootmode[count] = '\0';\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nlog_buf_addr_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%p\n", cdev->log_buf_addr);\r\n}\r\nstatic ssize_t\r\nlog_buf_addr_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nint ret;\r\nunsigned long addr;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nret = kstrtoul(buf, 16, &addr);\r\nif (ret)\r\ngoto exit;\r\ncdev->log_buf_addr = (void *)addr;\r\nret = count;\r\nexit:\r\nreturn ret;\r\n}\r\nstatic ssize_t\r\nlog_buf_len_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nif (!cdev)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%p\n", cdev->log_buf_len);\r\n}\r\nstatic ssize_t\r\nlog_buf_len_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cosm_device *cdev = dev_get_drvdata(dev);\r\nint ret;\r\nunsigned long addr;\r\nif (!cdev)\r\nreturn -EINVAL;\r\nret = kstrtoul(buf, 16, &addr);\r\nif (ret)\r\ngoto exit;\r\ncdev->log_buf_len = (int *)addr;\r\nret = count;\r\nexit:\r\nreturn ret;\r\n}\r\nvoid cosm_sysfs_init(struct cosm_device *cdev)\r\n{\r\ncdev->attr_group = cosm_default_groups;\r\n}

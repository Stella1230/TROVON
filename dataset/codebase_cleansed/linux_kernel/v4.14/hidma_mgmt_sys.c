static int set_priority(struct hidma_mgmt_dev *mdev, unsigned int i, u64 val)\r\n{\r\nu64 tmp;\r\nint rc;\r\nif (i >= mdev->dma_channels)\r\nreturn -EINVAL;\r\ntmp = mdev->priority[i];\r\nmdev->priority[i] = val;\r\nrc = hidma_mgmt_setup(mdev);\r\nif (rc)\r\nmdev->priority[i] = tmp;\r\nreturn rc;\r\n}\r\nstatic int set_weight(struct hidma_mgmt_dev *mdev, unsigned int i, u64 val)\r\n{\r\nu64 tmp;\r\nint rc;\r\nif (i >= mdev->dma_channels)\r\nreturn -EINVAL;\r\ntmp = mdev->weight[i];\r\nmdev->weight[i] = val;\r\nrc = hidma_mgmt_setup(mdev);\r\nif (rc)\r\nmdev->weight[i] = tmp;\r\nreturn rc;\r\n}\r\nstatic ssize_t show_values(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct hidma_mgmt_dev *mdev = platform_get_drvdata(pdev);\r\nunsigned int i;\r\nbuf[0] = 0;\r\nfor (i = 0; i < ARRAY_SIZE(hidma_mgmt_files); i++) {\r\nif (strcmp(attr->attr.name, hidma_mgmt_files[i].name) == 0) {\r\nsprintf(buf, "%d\n", hidma_mgmt_files[i].get(mdev));\r\nbreak;\r\n}\r\n}\r\nreturn strlen(buf);\r\n}\r\nstatic ssize_t set_values(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct hidma_mgmt_dev *mdev = platform_get_drvdata(pdev);\r\nunsigned long tmp;\r\nunsigned int i;\r\nint rc;\r\nrc = kstrtoul(buf, 0, &tmp);\r\nif (rc)\r\nreturn rc;\r\nfor (i = 0; i < ARRAY_SIZE(hidma_mgmt_files); i++) {\r\nif (strcmp(attr->attr.name, hidma_mgmt_files[i].name) == 0) {\r\nrc = hidma_mgmt_files[i].set(mdev, tmp);\r\nif (rc)\r\nreturn rc;\r\nbreak;\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t show_values_channel(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *buf)\r\n{\r\nstruct hidma_chan_attr *chattr;\r\nstruct hidma_mgmt_dev *mdev;\r\nbuf[0] = 0;\r\nchattr = container_of(attr, struct hidma_chan_attr, attr);\r\nmdev = chattr->mdev;\r\nif (strcmp(attr->attr.name, "priority") == 0)\r\nsprintf(buf, "%d\n", mdev->priority[chattr->index]);\r\nelse if (strcmp(attr->attr.name, "weight") == 0)\r\nsprintf(buf, "%d\n", mdev->weight[chattr->index]);\r\nreturn strlen(buf);\r\n}\r\nstatic ssize_t set_values_channel(struct kobject *kobj,\r\nstruct kobj_attribute *attr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct hidma_chan_attr *chattr;\r\nstruct hidma_mgmt_dev *mdev;\r\nunsigned long tmp;\r\nint rc;\r\nchattr = container_of(attr, struct hidma_chan_attr, attr);\r\nmdev = chattr->mdev;\r\nrc = kstrtoul(buf, 0, &tmp);\r\nif (rc)\r\nreturn rc;\r\nif (strcmp(attr->attr.name, "priority") == 0) {\r\nrc = set_priority(mdev, chattr->index, tmp);\r\nif (rc)\r\nreturn rc;\r\n} else if (strcmp(attr->attr.name, "weight") == 0) {\r\nrc = set_weight(mdev, chattr->index, tmp);\r\nif (rc)\r\nreturn rc;\r\n}\r\nreturn count;\r\n}\r\nstatic int create_sysfs_entry(struct hidma_mgmt_dev *dev, char *name, int mode)\r\n{\r\nstruct device_attribute *attrs;\r\nchar *name_copy;\r\nattrs = devm_kmalloc(&dev->pdev->dev,\r\nsizeof(struct device_attribute), GFP_KERNEL);\r\nif (!attrs)\r\nreturn -ENOMEM;\r\nname_copy = devm_kstrdup(&dev->pdev->dev, name, GFP_KERNEL);\r\nif (!name_copy)\r\nreturn -ENOMEM;\r\nattrs->attr.name = name_copy;\r\nattrs->attr.mode = mode;\r\nattrs->show = show_values;\r\nattrs->store = set_values;\r\nsysfs_attr_init(&attrs->attr);\r\nreturn device_create_file(&dev->pdev->dev, attrs);\r\n}\r\nstatic int create_sysfs_entry_channel(struct hidma_mgmt_dev *mdev, char *name,\r\nint mode, int index,\r\nstruct kobject *parent)\r\n{\r\nstruct hidma_chan_attr *chattr;\r\nchar *name_copy;\r\nchattr = devm_kmalloc(&mdev->pdev->dev, sizeof(*chattr), GFP_KERNEL);\r\nif (!chattr)\r\nreturn -ENOMEM;\r\nname_copy = devm_kstrdup(&mdev->pdev->dev, name, GFP_KERNEL);\r\nif (!name_copy)\r\nreturn -ENOMEM;\r\nchattr->mdev = mdev;\r\nchattr->index = index;\r\nchattr->attr.attr.name = name_copy;\r\nchattr->attr.attr.mode = mode;\r\nchattr->attr.show = show_values_channel;\r\nchattr->attr.store = set_values_channel;\r\nsysfs_attr_init(&chattr->attr.attr);\r\nreturn sysfs_create_file(parent, &chattr->attr.attr);\r\n}\r\nint hidma_mgmt_init_sys(struct hidma_mgmt_dev *mdev)\r\n{\r\nunsigned int i;\r\nint rc;\r\nint required;\r\nstruct kobject *chanops;\r\nrequired = sizeof(*mdev->chroots) * mdev->dma_channels;\r\nmdev->chroots = devm_kmalloc(&mdev->pdev->dev, required, GFP_KERNEL);\r\nif (!mdev->chroots)\r\nreturn -ENOMEM;\r\nchanops = kobject_create_and_add("chanops", &mdev->pdev->dev.kobj);\r\nif (!chanops)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < mdev->dma_channels; i++) {\r\nchar name[20];\r\nsnprintf(name, sizeof(name), "chan%d", i);\r\nmdev->chroots[i] = kobject_create_and_add(name, chanops);\r\nif (!mdev->chroots[i])\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(hidma_mgmt_files); i++) {\r\nrc = create_sysfs_entry(mdev, hidma_mgmt_files[i].name,\r\nhidma_mgmt_files[i].mode);\r\nif (rc)\r\nreturn rc;\r\n}\r\nfor (i = 0; i < mdev->dma_channels; i++) {\r\nrc = create_sysfs_entry_channel(mdev, "priority",\r\n(S_IRUGO | S_IWUGO), i,\r\nmdev->chroots[i]);\r\nif (rc)\r\nreturn rc;\r\nrc = create_sysfs_entry_channel(mdev, "weight",\r\n(S_IRUGO | S_IWUGO), i,\r\nmdev->chroots[i]);\r\nif (rc)\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}

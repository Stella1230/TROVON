static void fjes_get_ethtool_stats(struct net_device *netdev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\nint epidx;\r\nchar *p;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(fjes_gstrings_stats); i++) {\r\np = (char *)adapter + fjes_gstrings_stats[i].stat_offset;\r\ndata[i] = (fjes_gstrings_stats[i].sizeof_stat == sizeof(u64))\r\n? *(u64 *)p : *(u32 *)p;\r\n}\r\nfor (epidx = 0; epidx < hw->max_epid; epidx++) {\r\nif (epidx == hw->my_epid)\r\ncontinue;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.com_regist_buf_exec;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.com_unregist_buf_exec;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.send_intr_rx;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.send_intr_unshare;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.send_intr_zoneupdate;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.recv_intr_rx;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.recv_intr_unshare;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.recv_intr_stop;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.recv_intr_zoneupdate;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats.tx_buffer_full;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.tx_dropped_not_shared;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.tx_dropped_ver_mismatch;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.tx_dropped_buf_size_mismatch;\r\ndata[i++] = hw->ep_shm_info[epidx].ep_stats\r\n.tx_dropped_vlanid_mismatch;\r\n}\r\n}\r\nstatic void fjes_get_strings(struct net_device *netdev,\r\nu32 stringset, u8 *data)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\nu8 *p = data;\r\nint i;\r\nswitch (stringset) {\r\ncase ETH_SS_STATS:\r\nfor (i = 0; i < ARRAY_SIZE(fjes_gstrings_stats); i++) {\r\nmemcpy(p, fjes_gstrings_stats[i].stat_string,\r\nETH_GSTRING_LEN);\r\np += ETH_GSTRING_LEN;\r\n}\r\nfor (i = 0; i < hw->max_epid; i++) {\r\nif (i == hw->my_epid)\r\ncontinue;\r\nsprintf(p, "ep%u_com_regist_buf_exec", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_com_unregist_buf_exec", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_send_intr_rx", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_send_intr_unshare", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_send_intr_zoneupdate", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_recv_intr_rx", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_recv_intr_unshare", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_recv_intr_stop", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_recv_intr_zoneupdate", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_tx_buffer_full", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_tx_dropped_not_shared", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_tx_dropped_ver_mismatch", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_tx_dropped_buf_size_mismatch", i);\r\np += ETH_GSTRING_LEN;\r\nsprintf(p, "ep%u_tx_dropped_vlanid_mismatch", i);\r\np += ETH_GSTRING_LEN;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int fjes_get_sset_count(struct net_device *netdev, int sset)\r\n{\r\nswitch (sset) {\r\ncase ETH_SS_STATS:\r\nreturn FJES_STATS_LEN;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic void fjes_get_drvinfo(struct net_device *netdev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct platform_device *plat_dev;\r\nplat_dev = adapter->plat_dev;\r\nstrlcpy(drvinfo->driver, fjes_driver_name, sizeof(drvinfo->driver));\r\nstrlcpy(drvinfo->version, fjes_driver_version,\r\nsizeof(drvinfo->version));\r\nstrlcpy(drvinfo->fw_version, "none", sizeof(drvinfo->fw_version));\r\nsnprintf(drvinfo->bus_info, sizeof(drvinfo->bus_info),\r\n"platform:%s", plat_dev->name);\r\n}\r\nstatic int fjes_get_link_ksettings(struct net_device *netdev,\r\nstruct ethtool_link_ksettings *ecmd)\r\n{\r\nethtool_link_ksettings_zero_link_mode(ecmd, supported);\r\nethtool_link_ksettings_zero_link_mode(ecmd, advertising);\r\necmd->base.duplex = DUPLEX_FULL;\r\necmd->base.autoneg = AUTONEG_DISABLE;\r\necmd->base.port = PORT_NONE;\r\necmd->base.speed = 20000;\r\nreturn 0;\r\n}\r\nstatic int fjes_get_regs_len(struct net_device *netdev)\r\n{\r\n#define FJES_REGS_LEN 37\r\nreturn FJES_REGS_LEN * sizeof(u32);\r\n}\r\nstatic void fjes_get_regs(struct net_device *netdev,\r\nstruct ethtool_regs *regs, void *p)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\nu32 *regs_buff = p;\r\nmemset(p, 0, FJES_REGS_LEN * sizeof(u32));\r\nregs->version = 1;\r\nregs_buff[0] = rd32(XSCT_OWNER_EPID);\r\nregs_buff[1] = rd32(XSCT_MAX_EP);\r\nregs_buff[4] = rd32(XSCT_DCTL);\r\nregs_buff[8] = rd32(XSCT_CR);\r\nregs_buff[9] = rd32(XSCT_CS);\r\nregs_buff[10] = rd32(XSCT_SHSTSAL);\r\nregs_buff[11] = rd32(XSCT_SHSTSAH);\r\nregs_buff[13] = rd32(XSCT_REQBL);\r\nregs_buff[14] = rd32(XSCT_REQBAL);\r\nregs_buff[15] = rd32(XSCT_REQBAH);\r\nregs_buff[17] = rd32(XSCT_RESPBL);\r\nregs_buff[18] = rd32(XSCT_RESPBAL);\r\nregs_buff[19] = rd32(XSCT_RESPBAH);\r\nregs_buff[32] = rd32(XSCT_IS);\r\nregs_buff[33] = rd32(XSCT_IMS);\r\nregs_buff[34] = rd32(XSCT_IMC);\r\nregs_buff[35] = rd32(XSCT_IG);\r\nregs_buff[36] = rd32(XSCT_ICTL);\r\n}\r\nstatic int fjes_set_dump(struct net_device *netdev, struct ethtool_dump *dump)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\nint ret = 0;\r\nif (dump->flag) {\r\nif (hw->debug_mode)\r\nreturn -EPERM;\r\nhw->debug_mode = dump->flag;\r\nmutex_lock(&hw->hw_info.lock);\r\nret = fjes_hw_start_debug(hw);\r\nmutex_unlock(&hw->hw_info.lock);\r\nif (ret)\r\nhw->debug_mode = 0;\r\n} else {\r\nif (!hw->debug_mode)\r\nreturn -EPERM;\r\nmutex_lock(&hw->hw_info.lock);\r\nret = fjes_hw_stop_debug(hw);\r\nmutex_unlock(&hw->hw_info.lock);\r\n}\r\nreturn ret;\r\n}\r\nstatic int fjes_get_dump_flag(struct net_device *netdev,\r\nstruct ethtool_dump *dump)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\ndump->len = hw->hw_info.trace_size;\r\ndump->version = 1;\r\ndump->flag = hw->debug_mode;\r\nreturn 0;\r\n}\r\nstatic int fjes_get_dump_data(struct net_device *netdev,\r\nstruct ethtool_dump *dump, void *buf)\r\n{\r\nstruct fjes_adapter *adapter = netdev_priv(netdev);\r\nstruct fjes_hw *hw = &adapter->hw;\r\nint ret = 0;\r\nif (hw->hw_info.trace)\r\nmemcpy(buf, hw->hw_info.trace, hw->hw_info.trace_size);\r\nelse\r\nret = -EPERM;\r\nreturn ret;\r\n}\r\nvoid fjes_set_ethtool_ops(struct net_device *netdev)\r\n{\r\nnetdev->ethtool_ops = &fjes_ethtool_ops;\r\n}

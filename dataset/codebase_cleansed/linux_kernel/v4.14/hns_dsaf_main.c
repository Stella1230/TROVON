int hns_dsaf_get_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nint ret, i;\r\nu32 desc_num;\r\nu32 buf_size;\r\nu32 reset_offset = 0;\r\nu32 res_idx = 0;\r\nconst char *mode_str;\r\nstruct regmap *syscon;\r\nstruct resource *res;\r\nstruct device_node *np = dsaf_dev->dev->of_node, *np_temp;\r\nstruct platform_device *pdev = to_platform_device(dsaf_dev->dev);\r\nif (dev_of_node(dsaf_dev->dev)) {\r\nif (of_device_is_compatible(np, "hisilicon,hns-dsaf-v1"))\r\ndsaf_dev->dsaf_ver = AE_VERSION_1;\r\nelse\r\ndsaf_dev->dsaf_ver = AE_VERSION_2;\r\n} else if (is_acpi_node(dsaf_dev->dev->fwnode)) {\r\nif (acpi_dev_found(hns_dsaf_acpi_match[0].id))\r\ndsaf_dev->dsaf_ver = AE_VERSION_1;\r\nelse if (acpi_dev_found(hns_dsaf_acpi_match[1].id))\r\ndsaf_dev->dsaf_ver = AE_VERSION_2;\r\nelse\r\nreturn -ENXIO;\r\n} else {\r\ndev_err(dsaf_dev->dev, "cannot get cfg data from of or acpi\n");\r\nreturn -ENXIO;\r\n}\r\nret = device_property_read_string(dsaf_dev->dev, "mode", &mode_str);\r\nif (ret) {\r\ndev_err(dsaf_dev->dev, "get dsaf mode fail, ret=%d!\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < DSAF_MODE_MAX; i++) {\r\nif (g_dsaf_mode_match[i] &&\r\n!strcmp(mode_str, g_dsaf_mode_match[i]))\r\nbreak;\r\n}\r\nif (i >= DSAF_MODE_MAX ||\r\ni == DSAF_MODE_INVALID || i == DSAF_MODE_ENABLE) {\r\ndev_err(dsaf_dev->dev,\r\n"%s prs mode str fail!\n", dsaf_dev->ae_dev.name);\r\nreturn -EINVAL;\r\n}\r\ndsaf_dev->dsaf_mode = (enum dsaf_mode)i;\r\nif (dsaf_dev->dsaf_mode > DSAF_MODE_ENABLE)\r\ndsaf_dev->dsaf_en = HRD_DSAF_NO_DSAF_MODE;\r\nelse\r\ndsaf_dev->dsaf_en = HRD_DSAF_MODE;\r\nif ((i == DSAF_MODE_ENABLE_16VM) ||\r\n(i == DSAF_MODE_DISABLE_2PORT_8VM) ||\r\n(i == DSAF_MODE_DISABLE_6PORT_2VM))\r\ndsaf_dev->dsaf_tc_mode = HRD_DSAF_8TC_MODE;\r\nelse\r\ndsaf_dev->dsaf_tc_mode = HRD_DSAF_4TC_MODE;\r\nif (dev_of_node(dsaf_dev->dev)) {\r\nnp_temp = of_parse_phandle(np, "subctrl-syscon", 0);\r\nsyscon = syscon_node_to_regmap(np_temp);\r\nof_node_put(np_temp);\r\nif (IS_ERR_OR_NULL(syscon)) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nres_idx++);\r\nif (!res) {\r\ndev_err(dsaf_dev->dev, "subctrl info is needed!\n");\r\nreturn -ENOMEM;\r\n}\r\ndsaf_dev->sc_base = devm_ioremap_resource(&pdev->dev,\r\nres);\r\nif (IS_ERR(dsaf_dev->sc_base))\r\nreturn PTR_ERR(dsaf_dev->sc_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nres_idx++);\r\nif (!res) {\r\ndev_err(dsaf_dev->dev, "serdes-ctrl info is needed!\n");\r\nreturn -ENOMEM;\r\n}\r\ndsaf_dev->sds_base = devm_ioremap_resource(&pdev->dev,\r\nres);\r\nif (IS_ERR(dsaf_dev->sds_base))\r\nreturn PTR_ERR(dsaf_dev->sds_base);\r\n} else {\r\ndsaf_dev->sub_ctrl = syscon;\r\n}\r\n}\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "ppe-base");\r\nif (!res) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, res_idx++);\r\nif (!res) {\r\ndev_err(dsaf_dev->dev, "ppe-base info is needed!\n");\r\nreturn -ENOMEM;\r\n}\r\n}\r\ndsaf_dev->ppe_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dsaf_dev->ppe_base))\r\nreturn PTR_ERR(dsaf_dev->ppe_base);\r\ndsaf_dev->ppe_paddr = res->start;\r\nif (!HNS_DSAF_IS_DEBUG(dsaf_dev)) {\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\n"dsaf-base");\r\nif (!res) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nres_idx);\r\nif (!res) {\r\ndev_err(dsaf_dev->dev,\r\n"dsaf-base info is needed!\n");\r\nreturn -ENOMEM;\r\n}\r\n}\r\ndsaf_dev->io_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dsaf_dev->io_base))\r\nreturn PTR_ERR(dsaf_dev->io_base);\r\n}\r\nret = device_property_read_u32(dsaf_dev->dev, "desc-num", &desc_num);\r\nif (ret < 0 || desc_num < HNS_DSAF_MIN_DESC_CNT ||\r\ndesc_num > HNS_DSAF_MAX_DESC_CNT) {\r\ndev_err(dsaf_dev->dev, "get desc-num(%d) fail, ret=%d!\n",\r\ndesc_num, ret);\r\nreturn -EINVAL;\r\n}\r\ndsaf_dev->desc_num = desc_num;\r\nret = device_property_read_u32(dsaf_dev->dev, "reset-field-offset",\r\n&reset_offset);\r\nif (ret < 0) {\r\ndev_dbg(dsaf_dev->dev,\r\n"get reset-field-offset fail, ret=%d!\r\n", ret);\r\n}\r\ndsaf_dev->reset_offset = reset_offset;\r\nret = device_property_read_u32(dsaf_dev->dev, "buf-size", &buf_size);\r\nif (ret < 0) {\r\ndev_err(dsaf_dev->dev,\r\n"get buf-size fail, ret=%d!\r\n", ret);\r\nreturn ret;\r\n}\r\ndsaf_dev->buf_size = buf_size;\r\ndsaf_dev->buf_size_type = hns_rcb_buf_size2type(buf_size);\r\nif (dsaf_dev->buf_size_type < 0) {\r\ndev_err(dsaf_dev->dev,\r\n"buf_size(%d) is wrong!\n", buf_size);\r\nreturn -EINVAL;\r\n}\r\ndsaf_dev->misc_op = hns_misc_op_get(dsaf_dev);\r\nif (!dsaf_dev->misc_op)\r\nreturn -ENOMEM;\r\nif (!dma_set_mask_and_coherent(dsaf_dev->dev, DMA_BIT_MASK(64ULL)))\r\ndev_dbg(dsaf_dev->dev, "set mask to 64bit\n");\r\nelse\r\ndev_err(dsaf_dev->dev, "set mask to 64bit fail!\n");\r\nreturn 0;\r\n}\r\nstatic void hns_dsaf_sbm_link_sram_init_en(struct dsaf_device *dsaf_dev)\r\n{\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_CFG_0_REG, DSAF_CFG_SBM_INIT_S, 1);\r\n}\r\nstatic void\r\nhns_dsaf_reg_cnt_clr_ce(struct dsaf_device *dsaf_dev, u32 reg_cnt_clr_ce)\r\n{\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_DSA_REG_CNT_CLR_CE_REG,\r\nDSAF_CNT_CLR_CE_S, reg_cnt_clr_ce);\r\n}\r\nstatic void\r\nhns_dsaf_ppe_qid_cfg(struct dsaf_device *dsaf_dev, u32 qid_cfg)\r\n{\r\nu32 i;\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\ndsaf_set_dev_field(dsaf_dev,\r\nDSAF_PPE_QID_CFG_0_REG + 0x0004 * i,\r\nDSAF_PPE_QID_CFG_M, DSAF_PPE_QID_CFG_S,\r\nqid_cfg);\r\n}\r\n}\r\nstatic void hns_dsaf_mix_def_qid_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu16 max_q_per_vf, max_vfn;\r\nu32 q_id, q_num_per_port;\r\nu32 i;\r\nhns_rcb_get_queue_mode(dsaf_dev->dsaf_mode, &max_vfn, &max_q_per_vf);\r\nq_num_per_port = max_vfn * max_q_per_vf;\r\nfor (i = 0, q_id = 0; i < DSAF_SERVICE_NW_NUM; i++) {\r\ndsaf_set_dev_field(dsaf_dev,\r\nDSAF_MIX_DEF_QID_0_REG + 0x0004 * i,\r\n0xff, 0, q_id);\r\nq_id += q_num_per_port;\r\n}\r\n}\r\nstatic void hns_dsaf_inner_qid_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu16 max_q_per_vf, max_vfn;\r\nu32 q_id, q_num_per_port;\r\nu32 mac_id;\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver))\r\nreturn;\r\nhns_rcb_get_queue_mode(dsaf_dev->dsaf_mode, &max_vfn, &max_q_per_vf);\r\nq_num_per_port = max_vfn * max_q_per_vf;\r\nfor (mac_id = 0, q_id = 0; mac_id < DSAF_SERVICE_NW_NUM; mac_id++) {\r\ndsaf_set_dev_field(dsaf_dev,\r\nDSAFV2_SERDES_LBK_0_REG + 4 * mac_id,\r\nDSAFV2_SERDES_LBK_QID_M,\r\nDSAFV2_SERDES_LBK_QID_S,\r\nq_id);\r\nq_id += q_num_per_port;\r\n}\r\n}\r\nstatic void hns_dsaf_sw_port_type_cfg(struct dsaf_device *dsaf_dev,\r\nenum dsaf_sw_port_type port_type)\r\n{\r\nu32 i;\r\nfor (i = 0; i < DSAF_SW_PORT_NUM; i++) {\r\ndsaf_set_dev_field(dsaf_dev,\r\nDSAF_SW_PORT_TYPE_0_REG + 0x0004 * i,\r\nDSAF_SW_PORT_TYPE_M, DSAF_SW_PORT_TYPE_S,\r\nport_type);\r\n}\r\n}\r\nstatic void hns_dsaf_stp_port_type_cfg(struct dsaf_device *dsaf_dev,\r\nenum dsaf_stp_port_type port_type)\r\n{\r\nu32 i;\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\ndsaf_set_dev_field(dsaf_dev,\r\nDSAF_STP_PORT_TYPE_0_REG + 0x0004 * i,\r\nDSAF_STP_PORT_TYPE_M, DSAF_STP_PORT_TYPE_S,\r\nport_type);\r\n}\r\n}\r\nstatic void hns_dsaf_sbm_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_sbm_cfg;\r\nu32 i;\r\nfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\r\no_sbm_cfg = dsaf_read_dev(dsaf_dev,\r\nDSAF_SBM_CFG_REG_0_REG + 0x80 * i);\r\ndsaf_set_bit(o_sbm_cfg, DSAF_SBM_CFG_EN_S, 1);\r\ndsaf_set_bit(o_sbm_cfg, DSAF_SBM_CFG_SHCUT_EN_S, 0);\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_SBM_CFG_REG_0_REG + 0x80 * i, o_sbm_cfg);\r\n}\r\n}\r\nstatic int hns_dsaf_sbm_cfg_mib_en(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 sbm_cfg_mib_en;\r\nu32 i;\r\nu32 reg;\r\nu32 read_cnt;\r\nfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\r\nreg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\r\ndsaf_set_dev_bit(dsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S, 0);\r\n}\r\nfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\r\nreg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\r\ndsaf_set_dev_bit(dsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S, 1);\r\n}\r\nfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\r\nread_cnt = 0;\r\nreg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\r\ndo {\r\nudelay(1);\r\nsbm_cfg_mib_en = dsaf_get_dev_bit(\r\ndsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S);\r\nread_cnt++;\r\n} while (sbm_cfg_mib_en == 0 &&\r\nread_cnt < DSAF_CFG_READ_CNT);\r\nif (sbm_cfg_mib_en == 0) {\r\ndev_err(dsaf_dev->dev,\r\n"sbm_cfg_mib_en fail,%s,sbm_num=%d\n",\r\ndsaf_dev->ae_dev.name, i);\r\nreturn -ENODEV;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void hns_dsaf_sbm_bp_wl_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_sbm_bp_cfg;\r\nu32 reg;\r\nu32 i;\r\nfor (i = 0; i < DSAF_XGE_NUM; i++) {\r\nreg = DSAF_SBM_BP_CFG_0_XGE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_COM_MAX_BUF_NUM_M,\r\nDSAF_SBM_CFG0_COM_MAX_BUF_NUM_S, 512);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_VC0_MAX_BUF_NUM_M,\r\nDSAF_SBM_CFG0_VC0_MAX_BUF_NUM_S, 0);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_VC1_MAX_BUF_NUM_M,\r\nDSAF_SBM_CFG0_VC1_MAX_BUF_NUM_S, 0);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_1_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG1_TC4_MAX_BUF_NUM_M,\r\nDSAF_SBM_CFG1_TC4_MAX_BUF_NUM_S, 0);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG1_TC0_MAX_BUF_NUM_M,\r\nDSAF_SBM_CFG1_TC0_MAX_BUF_NUM_S, 0);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_2_XGE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_SET_BUF_NUM_S, 104);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_RESET_BUF_NUM_S, 128);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_3_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\r\nDSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 110);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\r\nDSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 160);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_4_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\r\nDSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 128);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\r\nDSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 192);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\nreg = DSAF_SBM_BP_CFG_2_PPE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_SET_BUF_NUM_S, 10);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_RESET_BUF_NUM_S, 12);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\nreg = DSAF_SBM_BP_CFG_2_ROCEE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_SET_BUF_NUM_S, 2);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\r\nDSAF_SBM_CFG2_RESET_BUF_NUM_S, 4);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\n}\r\nstatic void hns_dsafv2_sbm_bp_wl_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_sbm_bp_cfg;\r\nu32 reg;\r\nu32 i;\r\nfor (i = 0; i < DSAFV2_SBM_XGE_CHN; i++) {\r\nreg = DSAF_SBM_BP_CFG_0_XGE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_COM_MAX_BUF_NUM_M,\r\nDSAFV2_SBM_CFG0_COM_MAX_BUF_NUM_S, 256);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_VC0_MAX_BUF_NUM_M,\r\nDSAFV2_SBM_CFG0_VC0_MAX_BUF_NUM_S, 0);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_VC1_MAX_BUF_NUM_M,\r\nDSAFV2_SBM_CFG0_VC1_MAX_BUF_NUM_S, 0);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_1_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG1_TC4_MAX_BUF_NUM_M,\r\nDSAFV2_SBM_CFG1_TC4_MAX_BUF_NUM_S, 0);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG1_TC0_MAX_BUF_NUM_M,\r\nDSAFV2_SBM_CFG1_TC0_MAX_BUF_NUM_S, 0);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_2_XGE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG2_SET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_SET_BUF_NUM_S, 104);\r\ndsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG2_RESET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_RESET_BUF_NUM_S, 128);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_3_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\r\nDSAFV2_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 55);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\r\nDSAFV2_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 110);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\nreg = DSAF_SBM_BP_CFG_4_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG4_SET_BUF_NUM_NO_PFC_M,\r\nDSAFV2_SBM_CFG4_SET_BUF_NUM_NO_PFC_S, 128);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG4_RESET_BUF_NUM_NO_PFC_M,\r\nDSAFV2_SBM_CFG4_RESET_BUF_NUM_NO_PFC_S, 192);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\nfor (i = 0; i < DSAFV2_SBM_PPE_CHN; i++) {\r\nreg = DSAF_SBM_BP_CFG_2_PPE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG2_PPE_SET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_PPE_SET_BUF_NUM_S, 2);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG2_PPE_RESET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_PPE_RESET_BUF_NUM_S, 3);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG2_PPE_CFG_USEFUL_NUM_M,\r\nDSAFV2_SBM_CFG2_PPE_CFG_USEFUL_NUM_S, 52);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\nfor (i = 0; i < DASFV2_ROCEE_CRD_NUM; i++) {\r\nreg = DSAFV2_SBM_BP_CFG_2_ROCEE_REG_0_REG + 0x80 * i;\r\no_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG2_ROCEE_SET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_ROCEE_SET_BUF_NUM_S, 2);\r\ndsaf_set_field(o_sbm_bp_cfg,\r\nDSAFV2_SBM_CFG2_ROCEE_RESET_BUF_NUM_M,\r\nDSAFV2_SBM_CFG2_ROCEE_RESET_BUF_NUM_S, 4);\r\ndsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\r\n}\r\n}\r\nstatic void hns_dsaf_voq_bp_all_thrd_cfg(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 voq_bp_all_thrd;\r\nu32 i;\r\nfor (i = 0; i < DSAF_VOQ_NUM; i++) {\r\nvoq_bp_all_thrd = dsaf_read_dev(\r\ndsaf_dev, DSAF_VOQ_BP_ALL_THRD_0_REG + 0x40 * i);\r\nif (i < DSAF_XGE_NUM) {\r\ndsaf_set_field(voq_bp_all_thrd,\r\nDSAF_VOQ_BP_ALL_DOWNTHRD_M,\r\nDSAF_VOQ_BP_ALL_DOWNTHRD_S, 930);\r\ndsaf_set_field(voq_bp_all_thrd,\r\nDSAF_VOQ_BP_ALL_UPTHRD_M,\r\nDSAF_VOQ_BP_ALL_UPTHRD_S, 950);\r\n} else {\r\ndsaf_set_field(voq_bp_all_thrd,\r\nDSAF_VOQ_BP_ALL_DOWNTHRD_M,\r\nDSAF_VOQ_BP_ALL_DOWNTHRD_S, 220);\r\ndsaf_set_field(voq_bp_all_thrd,\r\nDSAF_VOQ_BP_ALL_UPTHRD_M,\r\nDSAF_VOQ_BP_ALL_UPTHRD_S, 230);\r\n}\r\ndsaf_write_dev(\r\ndsaf_dev, DSAF_VOQ_BP_ALL_THRD_0_REG + 0x40 * i,\r\nvoq_bp_all_thrd);\r\n}\r\n}\r\nstatic void hns_dsaf_tbl_tcam_match_cfg(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data)\r\n{\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MATCH_CFG_L_REG,\r\nptbl_tcam_data->tbl_tcam_data_low);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MATCH_CFG_H_REG,\r\nptbl_tcam_data->tbl_tcam_data_high);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_data_cfg(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data)\r\n{\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_LOW_0_REG,\r\nptbl_tcam_data->tbl_tcam_data_low);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_HIGH_0_REG,\r\nptbl_tcam_data->tbl_tcam_data_high);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_mcast_cfg(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_tbl_tcam_mcast_cfg *mcast)\r\n{\r\nu32 mcast_cfg4;\r\nmcast_cfg4 = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG);\r\ndsaf_set_bit(mcast_cfg4, DSAF_TBL_MCAST_CFG4_ITEM_VLD_S,\r\nmcast->tbl_mcast_item_vld);\r\ndsaf_set_bit(mcast_cfg4, DSAF_TBL_MCAST_CFG4_OLD_EN_S,\r\nmcast->tbl_mcast_old_en);\r\ndsaf_set_field(mcast_cfg4, DSAF_TBL_MCAST_CFG4_VM128_112_M,\r\nDSAF_TBL_MCAST_CFG4_VM128_112_S,\r\nmcast->tbl_mcast_port_msk[4]);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG, mcast_cfg4);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG,\r\nmcast->tbl_mcast_port_msk[3]);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG,\r\nmcast->tbl_mcast_port_msk[2]);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG,\r\nmcast->tbl_mcast_port_msk[1]);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG,\r\nmcast->tbl_mcast_port_msk[0]);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_ucast_cfg(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_tbl_tcam_ucast_cfg *tbl_tcam_ucast)\r\n{\r\nu32 ucast_cfg1;\r\nucast_cfg1 = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_UCAST_CFG_0_REG);\r\ndsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_MAC_DISCARD_S,\r\ntbl_tcam_ucast->tbl_ucast_mac_discard);\r\ndsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_ITEM_VLD_S,\r\ntbl_tcam_ucast->tbl_ucast_item_vld);\r\ndsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_OLD_EN_S,\r\ntbl_tcam_ucast->tbl_ucast_old_en);\r\ndsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_DVC_S,\r\ntbl_tcam_ucast->tbl_ucast_dvc);\r\ndsaf_set_field(ucast_cfg1, DSAF_TBL_UCAST_CFG1_OUT_PORT_M,\r\nDSAF_TBL_UCAST_CFG1_OUT_PORT_S,\r\ntbl_tcam_ucast->tbl_ucast_out_port);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_UCAST_CFG_0_REG, ucast_cfg1);\r\n}\r\nstatic void hns_dsaf_tbl_line_cfg(struct dsaf_device *dsaf_dev,\r\nstruct dsaf_tbl_line_cfg *tbl_lin)\r\n{\r\nu32 tbl_line;\r\ntbl_line = dsaf_read_dev(dsaf_dev, DSAF_TBL_LIN_CFG_0_REG);\r\ndsaf_set_bit(tbl_line, DSAF_TBL_LINE_CFG_MAC_DISCARD_S,\r\ntbl_lin->tbl_line_mac_discard);\r\ndsaf_set_bit(tbl_line, DSAF_TBL_LINE_CFG_DVC_S,\r\ntbl_lin->tbl_line_dvc);\r\ndsaf_set_field(tbl_line, DSAF_TBL_LINE_CFG_OUT_PORT_M,\r\nDSAF_TBL_LINE_CFG_OUT_PORT_S,\r\ntbl_lin->tbl_line_out_port);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_LIN_CFG_0_REG, tbl_line);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_mcast_pul(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_tbl_pul;\r\no_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\n}\r\nstatic void hns_dsaf_tbl_line_pul(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 tbl_pul;\r\ntbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\r\ndsaf_set_bit(tbl_pul, DSAF_TBL_PUL_LINE_VLD_S, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, tbl_pul);\r\ndsaf_set_bit(tbl_pul, DSAF_TBL_PUL_LINE_VLD_S, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, tbl_pul);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_data_mcast_pul(\r\nstruct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_tbl_pul;\r\no_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 1);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 0);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_data_ucast_pul(\r\nstruct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_tbl_pul;\r\no_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 1);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_UCAST_VLD_S, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 0);\r\ndsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_UCAST_VLD_S, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\r\n}\r\nvoid hns_dsaf_set_promisc_mode(struct dsaf_device *dsaf_dev, u32 en)\r\n{\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver) && !HNS_DSAF_IS_DEBUG(dsaf_dev))\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_CFG_0_REG,\r\nDSAF_CFG_MIX_MODE_S, !!en);\r\n}\r\nstatic void hns_dsaf_tbl_stat_en(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 o_tbl_ctrl;\r\no_tbl_ctrl = dsaf_read_dev(dsaf_dev, DSAF_TBL_DFX_CTRL_0_REG);\r\ndsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_LINE_LKUP_NUM_EN_S, 1);\r\ndsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_UC_LKUP_NUM_EN_S, 1);\r\ndsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_MC_LKUP_NUM_EN_S, 1);\r\ndsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_BC_LKUP_NUM_EN_S, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_DFX_CTRL_0_REG, o_tbl_ctrl);\r\n}\r\nstatic void hns_dsaf_rocee_bp_en(struct dsaf_device *dsaf_dev)\r\n{\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver))\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_XGE_CTRL_SIG_CFG_0_REG,\r\nDSAF_FC_XGE_TX_PAUSE_S, 1);\r\n}\r\nstatic void hns_dsaf_int_xge_msk_set(struct dsaf_device *dsaf_dev,\r\nu32 chnn_num, u32 mask_set)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_XGE_INT_MSK_0_REG + 0x4 * chnn_num, mask_set);\r\n}\r\nstatic void hns_dsaf_int_ppe_msk_set(struct dsaf_device *dsaf_dev,\r\nu32 chnn_num, u32 msk_set)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_PPE_INT_MSK_0_REG + 0x4 * chnn_num, msk_set);\r\n}\r\nstatic void hns_dsaf_int_rocee_msk_set(struct dsaf_device *dsaf_dev,\r\nu32 chnn, u32 msk_set)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_ROCEE_INT_MSK_0_REG + 0x4 * chnn, msk_set);\r\n}\r\nstatic void\r\nhns_dsaf_int_tbl_msk_set(struct dsaf_device *dsaf_dev, u32 msk_set)\r\n{\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_INT_MSK_0_REG, msk_set);\r\n}\r\nstatic void hns_dsaf_int_xge_src_clr(struct dsaf_device *dsaf_dev,\r\nu32 chnn_num, u32 int_src)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_XGE_INT_SRC_0_REG + 0x4 * chnn_num, int_src);\r\n}\r\nstatic void hns_dsaf_int_ppe_src_clr(struct dsaf_device *dsaf_dev,\r\nu32 chnn, u32 int_src)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_PPE_INT_SRC_0_REG + 0x4 * chnn, int_src);\r\n}\r\nstatic void hns_dsaf_int_rocee_src_clr(struct dsaf_device *dsaf_dev,\r\nu32 chnn, u32 int_src)\r\n{\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_ROCEE_INT_SRC_0_REG + 0x4 * chnn, int_src);\r\n}\r\nstatic void hns_dsaf_int_tbl_src_clr(struct dsaf_device *dsaf_dev,\r\nu32 int_src)\r\n{\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_INT_SRC_0_REG, int_src);\r\n}\r\nstatic void hns_dsaf_single_line_tbl_cfg(\r\nstruct dsaf_device *dsaf_dev,\r\nu32 address, struct dsaf_tbl_line_cfg *ptbl_line)\r\n{\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_line_addr_cfg(dsaf_dev, address);\r\nhns_dsaf_tbl_line_cfg(dsaf_dev, ptbl_line);\r\nhns_dsaf_tbl_line_pul(dsaf_dev);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nstatic void hns_dsaf_tcam_uc_cfg(\r\nstruct dsaf_device *dsaf_dev, u32 address,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\r\nstruct dsaf_tbl_tcam_ucast_cfg *ptbl_tcam_ucast)\r\n{\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\r\nhns_dsaf_tbl_tcam_data_cfg(dsaf_dev, ptbl_tcam_data);\r\nhns_dsaf_tbl_tcam_ucast_cfg(dsaf_dev, ptbl_tcam_ucast);\r\nhns_dsaf_tbl_tcam_data_ucast_pul(dsaf_dev);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nstatic void hns_dsaf_tcam_mc_cfg(\r\nstruct dsaf_device *dsaf_dev, u32 address,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_mask,\r\nstruct dsaf_tbl_tcam_mcast_cfg *ptbl_tcam_mcast)\r\n{\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\r\nhns_dsaf_tbl_tcam_data_cfg(dsaf_dev, ptbl_tcam_data);\r\nhns_dsaf_tbl_tcam_mcast_cfg(dsaf_dev, ptbl_tcam_mcast);\r\nif (ptbl_tcam_mask)\r\nhns_dsaf_tbl_tcam_match_cfg(dsaf_dev, ptbl_tcam_mask);\r\nhns_dsaf_tbl_tcam_data_mcast_pul(dsaf_dev);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nstatic void hns_dsaf_tcam_mc_invld(struct dsaf_device *dsaf_dev, u32 address)\r\n{\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG, 0);\r\nhns_dsaf_tbl_tcam_mcast_pul(dsaf_dev);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nvoid hns_dsaf_tcam_addr_get(struct dsaf_drv_tbl_tcam_key *mac_key, u8 *addr)\r\n{\r\naddr[0] = mac_key->high.bits.mac_0;\r\naddr[1] = mac_key->high.bits.mac_1;\r\naddr[2] = mac_key->high.bits.mac_2;\r\naddr[3] = mac_key->high.bits.mac_3;\r\naddr[4] = mac_key->low.bits.mac_4;\r\naddr[5] = mac_key->low.bits.mac_5;\r\n}\r\nstatic void hns_dsaf_tcam_uc_get(\r\nstruct dsaf_device *dsaf_dev, u32 address,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\r\nstruct dsaf_tbl_tcam_ucast_cfg *ptbl_tcam_ucast)\r\n{\r\nu32 tcam_read_data0;\r\nu32 tcam_read_data4;\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\r\nhns_dsaf_tbl_tcam_load_pul(dsaf_dev);\r\nptbl_tcam_data->tbl_tcam_data_high\r\n= dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\r\nptbl_tcam_data->tbl_tcam_data_low\r\n= dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\r\ntcam_read_data0 = dsaf_read_dev(dsaf_dev,\r\nDSAF_TBL_TCAM_RAM_RDATA0_0_REG);\r\ntcam_read_data4 = dsaf_read_dev(dsaf_dev,\r\nDSAF_TBL_TCAM_RAM_RDATA4_0_REG);\r\nptbl_tcam_ucast->tbl_ucast_item_vld\r\n= dsaf_get_bit(tcam_read_data4,\r\nDSAF_TBL_MCAST_CFG4_ITEM_VLD_S);\r\nptbl_tcam_ucast->tbl_ucast_old_en\r\n= dsaf_get_bit(tcam_read_data4, DSAF_TBL_MCAST_CFG4_OLD_EN_S);\r\nptbl_tcam_ucast->tbl_ucast_mac_discard\r\n= dsaf_get_bit(tcam_read_data0,\r\nDSAF_TBL_UCAST_CFG1_MAC_DISCARD_S);\r\nptbl_tcam_ucast->tbl_ucast_out_port\r\n= dsaf_get_field(tcam_read_data0,\r\nDSAF_TBL_UCAST_CFG1_OUT_PORT_M,\r\nDSAF_TBL_UCAST_CFG1_OUT_PORT_S);\r\nptbl_tcam_ucast->tbl_ucast_dvc\r\n= dsaf_get_bit(tcam_read_data0, DSAF_TBL_UCAST_CFG1_DVC_S);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nstatic void hns_dsaf_tcam_mc_get(\r\nstruct dsaf_device *dsaf_dev, u32 address,\r\nstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\r\nstruct dsaf_tbl_tcam_mcast_cfg *ptbl_tcam_mcast)\r\n{\r\nu32 data_tmp;\r\nspin_lock_bh(&dsaf_dev->tcam_lock);\r\nhns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\r\nhns_dsaf_tbl_tcam_load_pul(dsaf_dev);\r\nptbl_tcam_data->tbl_tcam_data_high =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\r\nptbl_tcam_data->tbl_tcam_data_low =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\r\nptbl_tcam_mcast->tbl_mcast_port_msk[0] =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA0_0_REG);\r\nptbl_tcam_mcast->tbl_mcast_port_msk[1] =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA1_0_REG);\r\nptbl_tcam_mcast->tbl_mcast_port_msk[2] =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA2_0_REG);\r\nptbl_tcam_mcast->tbl_mcast_port_msk[3] =\r\ndsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA3_0_REG);\r\ndata_tmp = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA4_0_REG);\r\nptbl_tcam_mcast->tbl_mcast_item_vld =\r\ndsaf_get_bit(data_tmp, DSAF_TBL_MCAST_CFG4_ITEM_VLD_S);\r\nptbl_tcam_mcast->tbl_mcast_old_en =\r\ndsaf_get_bit(data_tmp, DSAF_TBL_MCAST_CFG4_OLD_EN_S);\r\nptbl_tcam_mcast->tbl_mcast_port_msk[4] =\r\ndsaf_get_field(data_tmp, DSAF_TBL_MCAST_CFG4_VM128_112_M,\r\nDSAF_TBL_MCAST_CFG4_VM128_112_S);\r\nspin_unlock_bh(&dsaf_dev->tcam_lock);\r\n}\r\nstatic void hns_dsaf_tbl_line_init(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 i;\r\nstruct dsaf_tbl_line_cfg tbl_line[] = {{1, 0, 0} };\r\nfor (i = 0; i < DSAF_LINE_SUM; i++)\r\nhns_dsaf_single_line_tbl_cfg(dsaf_dev, i, tbl_line);\r\n}\r\nstatic void hns_dsaf_tbl_tcam_init(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 i;\r\nstruct dsaf_tbl_tcam_data tcam_data[] = {{0, 0} };\r\nstruct dsaf_tbl_tcam_ucast_cfg tcam_ucast[] = {{0, 0, 0, 0, 0} };\r\nfor (i = 0; i < DSAF_TCAM_SUM; i++)\r\nhns_dsaf_tcam_uc_cfg(dsaf_dev, i, tcam_data, tcam_ucast);\r\n}\r\nstatic void hns_dsaf_pfc_en_cfg(struct dsaf_device *dsaf_dev,\r\nint mac_id, int tc_en)\r\n{\r\ndsaf_write_dev(dsaf_dev, DSAF_PFC_EN_0_REG + mac_id * 4, tc_en);\r\n}\r\nstatic void hns_dsaf_set_pfc_pause(struct dsaf_device *dsaf_dev,\r\nint mac_id, int tx_en, int rx_en)\r\n{\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nif (!tx_en || !rx_en)\r\ndev_err(dsaf_dev->dev, "dsaf v1 can not close pfc!\n");\r\nreturn;\r\n}\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\r\nDSAF_PFC_PAUSE_RX_EN_B, !!rx_en);\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\r\nDSAF_PFC_PAUSE_TX_EN_B, !!tx_en);\r\n}\r\nint hns_dsaf_set_rx_mac_pause_en(struct dsaf_device *dsaf_dev, int mac_id,\r\nu32 en)\r\n{\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nif (!en) {\r\ndev_err(dsaf_dev->dev, "dsafv1 can't close rx_pause!\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\ndsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\r\nDSAF_MAC_PAUSE_RX_EN_B, !!en);\r\nreturn 0;\r\n}\r\nvoid hns_dsaf_get_rx_mac_pause_en(struct dsaf_device *dsaf_dev, int mac_id,\r\nu32 *en)\r\n{\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver))\r\n*en = 1;\r\nelse\r\n*en = dsaf_get_dev_bit(dsaf_dev,\r\nDSAF_PAUSE_CFG_REG + mac_id * 4,\r\nDSAF_MAC_PAUSE_RX_EN_B);\r\n}\r\nstatic void hns_dsaf_comm_init(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 i;\r\nu32 o_dsaf_cfg;\r\nbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\r\no_dsaf_cfg = dsaf_read_dev(dsaf_dev, DSAF_CFG_0_REG);\r\ndsaf_set_bit(o_dsaf_cfg, DSAF_CFG_EN_S, dsaf_dev->dsaf_en);\r\ndsaf_set_bit(o_dsaf_cfg, DSAF_CFG_TC_MODE_S, dsaf_dev->dsaf_tc_mode);\r\ndsaf_set_bit(o_dsaf_cfg, DSAF_CFG_CRC_EN_S, 0);\r\ndsaf_set_bit(o_dsaf_cfg, DSAF_CFG_MIX_MODE_S, 0);\r\ndsaf_set_bit(o_dsaf_cfg, DSAF_CFG_LOCA_ADDR_EN_S, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_CFG_0_REG, o_dsaf_cfg);\r\nhns_dsaf_reg_cnt_clr_ce(dsaf_dev, 1);\r\nhns_dsaf_stp_port_type_cfg(dsaf_dev, DSAF_STP_PORT_TYPE_FORWARD);\r\nhns_dsaf_ppe_qid_cfg(dsaf_dev, DSAF_DEFAUTL_QUEUE_NUM_PER_PPE);\r\nhns_dsaf_mix_def_qid_cfg(dsaf_dev);\r\nhns_dsaf_inner_qid_cfg(dsaf_dev);\r\nhns_dsaf_sw_port_type_cfg(dsaf_dev, DSAF_SW_PORT_TYPE_NON_VLAN);\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\nhns_dsaf_pfc_en_cfg(dsaf_dev, i, 0);\r\nhns_dsaf_set_pfc_pause(dsaf_dev, i, is_ver1, is_ver1);\r\n}\r\nfor (i = 0; i < DSAF_COMM_CHN; i++) {\r\nhns_dsaf_int_xge_src_clr(dsaf_dev, i, 0xfffffffful);\r\nhns_dsaf_int_ppe_src_clr(dsaf_dev, i, 0xfffffffful);\r\nhns_dsaf_int_rocee_src_clr(dsaf_dev, i, 0xfffffffful);\r\nhns_dsaf_int_xge_msk_set(dsaf_dev, i, 0xfffffffful);\r\nhns_dsaf_int_ppe_msk_set(dsaf_dev, i, 0xfffffffful);\r\nhns_dsaf_int_rocee_msk_set(dsaf_dev, i, 0xfffffffful);\r\n}\r\nhns_dsaf_int_tbl_src_clr(dsaf_dev, 0xfffffffful);\r\nhns_dsaf_int_tbl_msk_set(dsaf_dev, 0xfffffffful);\r\n}\r\nstatic void hns_dsaf_inode_init(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 reg;\r\nu32 tc_cfg;\r\nu32 i;\r\nif (dsaf_dev->dsaf_tc_mode == HRD_DSAF_4TC_MODE)\r\ntc_cfg = HNS_DSAF_I4TC_CFG;\r\nelse\r\ntc_cfg = HNS_DSAF_I8TC_CFG;\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nfor (i = 0; i < DSAF_INODE_NUM; i++) {\r\nreg = DSAF_INODE_IN_PORT_NUM_0_REG + 0x80 * i;\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAF_INODE_IN_PORT_NUM_M,\r\nDSAF_INODE_IN_PORT_NUM_S,\r\ni % DSAF_XGE_NUM);\r\n}\r\n} else {\r\nfor (i = 0; i < DSAF_PORT_TYPE_NUM; i++) {\r\nreg = DSAF_INODE_IN_PORT_NUM_0_REG + 0x80 * i;\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAF_INODE_IN_PORT_NUM_M,\r\nDSAF_INODE_IN_PORT_NUM_S, 0);\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAFV2_INODE_IN_PORT1_NUM_M,\r\nDSAFV2_INODE_IN_PORT1_NUM_S, 1);\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAFV2_INODE_IN_PORT2_NUM_M,\r\nDSAFV2_INODE_IN_PORT2_NUM_S, 2);\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAFV2_INODE_IN_PORT3_NUM_M,\r\nDSAFV2_INODE_IN_PORT3_NUM_S, 3);\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAFV2_INODE_IN_PORT4_NUM_M,\r\nDSAFV2_INODE_IN_PORT4_NUM_S, 4);\r\ndsaf_set_dev_field(dsaf_dev, reg,\r\nDSAFV2_INODE_IN_PORT5_NUM_M,\r\nDSAFV2_INODE_IN_PORT5_NUM_S, 5);\r\n}\r\n}\r\nfor (i = 0; i < DSAF_INODE_NUM; i++) {\r\nreg = DSAF_INODE_PRI_TC_CFG_0_REG + 0x80 * i;\r\ndsaf_write_dev(dsaf_dev, reg, tc_cfg);\r\n}\r\n}\r\nstatic int hns_dsaf_sbm_init(struct dsaf_device *dsaf_dev)\r\n{\r\nu32 flag;\r\nu32 finish_msk;\r\nu32 cnt = 0;\r\nint ret;\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nhns_dsaf_sbm_bp_wl_cfg(dsaf_dev);\r\nfinish_msk = DSAF_SRAM_INIT_OVER_M;\r\n} else {\r\nhns_dsafv2_sbm_bp_wl_cfg(dsaf_dev);\r\nfinish_msk = DSAFV2_SRAM_INIT_OVER_M;\r\n}\r\nhns_dsaf_sbm_cfg(dsaf_dev);\r\nret = hns_dsaf_sbm_cfg_mib_en(dsaf_dev);\r\nif (ret) {\r\ndev_err(dsaf_dev->dev,\r\n"hns_dsaf_sbm_cfg_mib_en fail,%s, ret=%d\n",\r\ndsaf_dev->ae_dev.name, ret);\r\nreturn ret;\r\n}\r\nhns_dsaf_sbm_link_sram_init_en(dsaf_dev);\r\ndo {\r\nusleep_range(200, 210);\r\nflag = dsaf_get_dev_field(dsaf_dev, DSAF_SRAM_INIT_OVER_0_REG,\r\nfinish_msk, DSAF_SRAM_INIT_OVER_S);\r\ncnt++;\r\n} while (flag != (finish_msk >> DSAF_SRAM_INIT_OVER_S) &&\r\ncnt < DSAF_CFG_READ_CNT);\r\nif (flag != (finish_msk >> DSAF_SRAM_INIT_OVER_S)) {\r\ndev_err(dsaf_dev->dev,\r\n"hns_dsaf_sbm_init fail %s, flag=%d, cnt=%d\n",\r\ndsaf_dev->ae_dev.name, flag, cnt);\r\nreturn -ENODEV;\r\n}\r\nhns_dsaf_rocee_bp_en(dsaf_dev);\r\nreturn 0;\r\n}\r\nstatic void hns_dsaf_tbl_init(struct dsaf_device *dsaf_dev)\r\n{\r\nhns_dsaf_tbl_stat_en(dsaf_dev);\r\nhns_dsaf_tbl_tcam_init(dsaf_dev);\r\nhns_dsaf_tbl_line_init(dsaf_dev);\r\n}\r\nstatic void hns_dsaf_voq_init(struct dsaf_device *dsaf_dev)\r\n{\r\nhns_dsaf_voq_bp_all_thrd_cfg(dsaf_dev);\r\n}\r\nstatic int hns_dsaf_init_hw(struct dsaf_device *dsaf_dev)\r\n{\r\nint ret;\r\ndev_dbg(dsaf_dev->dev,\r\n"hns_dsaf_init_hw begin %s !\n", dsaf_dev->ae_dev.name);\r\ndsaf_dev->misc_op->dsaf_reset(dsaf_dev, 0);\r\nmdelay(10);\r\ndsaf_dev->misc_op->dsaf_reset(dsaf_dev, 1);\r\nhns_dsaf_comm_init(dsaf_dev);\r\nhns_dsaf_inode_init(dsaf_dev);\r\nret = hns_dsaf_sbm_init(dsaf_dev);\r\nif (ret)\r\nreturn ret;\r\nhns_dsaf_tbl_init(dsaf_dev);\r\nhns_dsaf_voq_init(dsaf_dev);\r\nreturn 0;\r\n}\r\nstatic void hns_dsaf_remove_hw(struct dsaf_device *dsaf_dev)\r\n{\r\ndsaf_dev->misc_op->dsaf_reset(dsaf_dev, 0);\r\n}\r\nstatic int hns_dsaf_init(struct dsaf_device *dsaf_dev)\r\n{\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nu32 i;\r\nint ret;\r\nif (HNS_DSAF_IS_DEBUG(dsaf_dev))\r\nreturn 0;\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver))\r\ndsaf_dev->tcam_max_num = DSAF_TCAM_SUM;\r\nelse\r\ndsaf_dev->tcam_max_num =\r\nDSAF_TCAM_SUM - DSAFV2_MAC_FUZZY_TCAM_NUM;\r\nspin_lock_init(&dsaf_dev->tcam_lock);\r\nret = hns_dsaf_init_hw(dsaf_dev);\r\nif (ret)\r\nreturn ret;\r\npriv->soft_mac_tbl = vzalloc(sizeof(*priv->soft_mac_tbl)\r\n* DSAF_TCAM_SUM);\r\nif (!priv->soft_mac_tbl) {\r\nret = -ENOMEM;\r\ngoto remove_hw;\r\n}\r\nfor (i = 0; i < DSAF_TCAM_SUM; i++)\r\n(priv->soft_mac_tbl + i)->index = DSAF_INVALID_ENTRY_IDX;\r\nreturn 0;\r\nremove_hw:\r\nhns_dsaf_remove_hw(dsaf_dev);\r\nreturn ret;\r\n}\r\nstatic void hns_dsaf_free(struct dsaf_device *dsaf_dev)\r\n{\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nhns_dsaf_remove_hw(dsaf_dev);\r\nvfree(priv->soft_mac_tbl);\r\npriv->soft_mac_tbl = NULL;\r\n}\r\nstatic u16 hns_dsaf_find_soft_mac_entry(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_tbl_tcam_key *mac_key)\r\n{\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\r\nu32 i;\r\nsoft_mac_entry = priv->soft_mac_tbl;\r\nfor (i = 0; i < dsaf_dev->tcam_max_num; i++) {\r\nif ((soft_mac_entry->index != DSAF_INVALID_ENTRY_IDX) &&\r\n(soft_mac_entry->tcam_key.high.val == mac_key->high.val) &&\r\n(soft_mac_entry->tcam_key.low.val == mac_key->low.val))\r\nreturn soft_mac_entry->index;\r\nsoft_mac_entry++;\r\n}\r\nreturn DSAF_INVALID_ENTRY_IDX;\r\n}\r\nstatic u16 hns_dsaf_find_empty_mac_entry(struct dsaf_device *dsaf_dev)\r\n{\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\r\nu32 i;\r\nsoft_mac_entry = priv->soft_mac_tbl;\r\nfor (i = 0; i < dsaf_dev->tcam_max_num; i++) {\r\nif (soft_mac_entry->index == DSAF_INVALID_ENTRY_IDX)\r\nreturn i;\r\nsoft_mac_entry++;\r\n}\r\nreturn DSAF_INVALID_ENTRY_IDX;\r\n}\r\nstatic void hns_dsaf_set_mac_key(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_tbl_tcam_key *mac_key, u16 vlan_id, u8 in_port_num,\r\nu8 *addr)\r\n{\r\nu8 port;\r\nif (dsaf_dev->dsaf_mode <= DSAF_MODE_ENABLE)\r\nport = 0;\r\nelse\r\nport = in_port_num;\r\nmac_key->high.bits.mac_0 = addr[0];\r\nmac_key->high.bits.mac_1 = addr[1];\r\nmac_key->high.bits.mac_2 = addr[2];\r\nmac_key->high.bits.mac_3 = addr[3];\r\nmac_key->low.bits.mac_4 = addr[4];\r\nmac_key->low.bits.mac_5 = addr[5];\r\nmac_key->low.bits.port_vlan = 0;\r\ndsaf_set_field(mac_key->low.bits.port_vlan, DSAF_TBL_TCAM_KEY_VLAN_M,\r\nDSAF_TBL_TCAM_KEY_VLAN_S, vlan_id);\r\ndsaf_set_field(mac_key->low.bits.port_vlan, DSAF_TBL_TCAM_KEY_PORT_M,\r\nDSAF_TBL_TCAM_KEY_PORT_S, port);\r\nmac_key->low.bits.port_vlan = le16_to_cpu(mac_key->low.bits.port_vlan);\r\n}\r\nint hns_dsaf_set_mac_uc_entry(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_mac_single_dest_entry *mac_entry)\r\n{\r\nu16 entry_index = DSAF_INVALID_ENTRY_IDX;\r\nstruct dsaf_drv_tbl_tcam_key mac_key;\r\nstruct dsaf_tbl_tcam_ucast_cfg mac_data;\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\r\nstruct dsaf_tbl_tcam_data tcam_data;\r\nif (MAC_IS_ALL_ZEROS(mac_entry->addr) ||\r\nMAC_IS_BROADCAST(mac_entry->addr) ||\r\nMAC_IS_MULTICAST(mac_entry->addr)) {\r\ndev_err(dsaf_dev->dev, "set_uc %s Mac %pM err!\n",\r\ndsaf_dev->ae_dev.name, mac_entry->addr);\r\nreturn -EINVAL;\r\n}\r\nhns_dsaf_set_mac_key(dsaf_dev, &mac_key, mac_entry->in_vlan_id,\r\nmac_entry->in_port_num, mac_entry->addr);\r\nentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\nentry_index = hns_dsaf_find_empty_mac_entry(dsaf_dev);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\ndev_err(dsaf_dev->dev,\r\n"set_uc_entry failed, %s Mac key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\n}\r\ndev_dbg(dsaf_dev->dev,\r\n"set_uc_entry, %s Mac key(%#x:%#x) entry_index%d\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val, entry_index);\r\nmac_data.tbl_ucast_item_vld = 1;\r\nmac_data.tbl_ucast_mac_discard = 0;\r\nmac_data.tbl_ucast_old_en = 0;\r\nmac_data.tbl_ucast_dvc = 0;\r\nmac_data.tbl_ucast_out_port = mac_entry->port_num;\r\ntcam_data.tbl_tcam_data_high = cpu_to_le32(mac_key.high.val);\r\ntcam_data.tbl_tcam_data_low = cpu_to_le32(mac_key.low.val);\r\nhns_dsaf_tcam_uc_cfg(dsaf_dev, entry_index, &tcam_data, &mac_data);\r\nsoft_mac_entry += entry_index;\r\nsoft_mac_entry->index = entry_index;\r\nsoft_mac_entry->tcam_key.high.val = mac_key.high.val;\r\nsoft_mac_entry->tcam_key.low.val = mac_key.low.val;\r\nreturn 0;\r\n}\r\nint hns_dsaf_rm_mac_addr(\r\nstruct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_mac_single_dest_entry *mac_entry)\r\n{\r\nu16 entry_index = DSAF_INVALID_ENTRY_IDX;\r\nstruct dsaf_tbl_tcam_ucast_cfg mac_data;\r\nstruct dsaf_drv_tbl_tcam_key mac_key;\r\nif (!is_valid_ether_addr(mac_entry->addr)) {\r\ndev_err(dsaf_dev->dev, "rm_uc_addr %s Mac %pM err!\n",\r\ndsaf_dev->ae_dev.name, mac_entry->addr);\r\nreturn -EINVAL;\r\n}\r\nhns_dsaf_set_mac_key(dsaf_dev, &mac_key, mac_entry->in_vlan_id,\r\nmac_entry->in_port_num, mac_entry->addr);\r\nentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\ndev_info(dsaf_dev->dev,\r\n"rm_uc_addr no tcam, %s Mac key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn 0;\r\n}\r\ndev_dbg(dsaf_dev->dev,\r\n"rm_uc_addr, %s Mac key(%#x:%#x) entry_index%d\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val, entry_index);\r\nhns_dsaf_tcam_uc_get(\r\ndsaf_dev, entry_index,\r\n(struct dsaf_tbl_tcam_data *)&mac_key,\r\n&mac_data);\r\nif (mac_entry->port_num != mac_data.tbl_ucast_out_port)\r\nreturn -EFAULT;\r\nreturn hns_dsaf_del_mac_entry(dsaf_dev,\r\nmac_entry->in_vlan_id,\r\nmac_entry->in_port_num,\r\nmac_entry->addr);\r\n}\r\nstatic void hns_dsaf_mc_mask_bit_clear(char *dst, const char *src)\r\n{\r\nu16 *a = (u16 *)dst;\r\nconst u16 *b = (const u16 *)src;\r\na[0] &= b[0];\r\na[1] &= b[1];\r\na[2] &= b[2];\r\n}\r\nint hns_dsaf_add_mac_mc_port(struct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_mac_single_dest_entry *mac_entry)\r\n{\r\nu16 entry_index = DSAF_INVALID_ENTRY_IDX;\r\nstruct dsaf_drv_tbl_tcam_key mac_key;\r\nstruct dsaf_drv_tbl_tcam_key mask_key;\r\nstruct dsaf_tbl_tcam_data *pmask_key = NULL;\r\nstruct dsaf_tbl_tcam_mcast_cfg mac_data;\r\nstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\r\nstruct dsaf_drv_tbl_tcam_key tmp_mac_key;\r\nstruct dsaf_tbl_tcam_data tcam_data;\r\nu8 mc_addr[ETH_ALEN];\r\nu8 *mc_mask;\r\nint mskid;\r\nif (MAC_IS_ALL_ZEROS(mac_entry->addr)) {\r\ndev_err(dsaf_dev->dev, "set_entry failed,addr %pM!\n",\r\nmac_entry->addr);\r\nreturn -EINVAL;\r\n}\r\nether_addr_copy(mc_addr, mac_entry->addr);\r\nmc_mask = dsaf_dev->mac_cb[mac_entry->in_port_num]->mc_mask;\r\nif (!AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nhns_dsaf_mc_mask_bit_clear(mc_addr, mc_mask);\r\nhns_dsaf_set_mac_key(dsaf_dev, &mask_key,\r\n0x0,\r\n0xff,\r\nmc_mask);\r\nmask_key.high.val = le32_to_cpu(mask_key.high.val);\r\nmask_key.low.val = le32_to_cpu(mask_key.low.val);\r\npmask_key = (struct dsaf_tbl_tcam_data *)(&mask_key);\r\n}\r\nhns_dsaf_set_mac_key(\r\ndsaf_dev, &mac_key, mac_entry->in_vlan_id,\r\nmac_entry->in_port_num, mc_addr);\r\nmemset(&mac_data, 0, sizeof(struct dsaf_tbl_tcam_mcast_cfg));\r\nentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\nentry_index = hns_dsaf_find_empty_mac_entry(dsaf_dev);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\ndev_err(dsaf_dev->dev,\r\n"set_uc_entry failed, %s Mac key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nhns_dsaf_tcam_mc_get(dsaf_dev, entry_index, &tcam_data,\r\n&mac_data);\r\ntmp_mac_key.high.val =\r\nle32_to_cpu(tcam_data.tbl_tcam_data_high);\r\ntmp_mac_key.low.val = le32_to_cpu(tcam_data.tbl_tcam_data_low);\r\n}\r\nif (mac_entry->port_num < DSAF_SERVICE_NW_NUM) {\r\nmskid = mac_entry->port_num;\r\n} else if (mac_entry->port_num >= DSAF_BASE_INNER_PORT_NUM) {\r\nmskid = mac_entry->port_num -\r\nDSAF_BASE_INNER_PORT_NUM + DSAF_SERVICE_NW_NUM;\r\n} else {\r\ndev_err(dsaf_dev->dev,\r\n"%s,pnum(%d)error,key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name, mac_entry->port_num,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\ndsaf_set_bit(mac_data.tbl_mcast_port_msk[mskid / 32], mskid % 32, 1);\r\nmac_data.tbl_mcast_old_en = 0;\r\nmac_data.tbl_mcast_item_vld = 1;\r\ndev_dbg(dsaf_dev->dev,\r\n"set_uc_entry, %s Mac key(%#x:%#x) entry_index%d\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val, entry_index);\r\ntcam_data.tbl_tcam_data_high = cpu_to_le32(mac_key.high.val);\r\ntcam_data.tbl_tcam_data_low = cpu_to_le32(mac_key.low.val);\r\nhns_dsaf_tcam_mc_cfg(dsaf_dev, entry_index, &tcam_data,\r\npmask_key, &mac_data);\r\nsoft_mac_entry += entry_index;\r\nsoft_mac_entry->index = entry_index;\r\nsoft_mac_entry->tcam_key.high.val = mac_key.high.val;\r\nsoft_mac_entry->tcam_key.low.val = mac_key.low.val;\r\nreturn 0;\r\n}\r\nint hns_dsaf_del_mac_entry(struct dsaf_device *dsaf_dev, u16 vlan_id,\r\nu8 in_port_num, u8 *addr)\r\n{\r\nu16 entry_index = DSAF_INVALID_ENTRY_IDX;\r\nstruct dsaf_drv_tbl_tcam_key mac_key;\r\nstruct dsaf_drv_priv *priv =\r\n(struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\r\nif (MAC_IS_ALL_ZEROS(addr) || MAC_IS_BROADCAST(addr)) {\r\ndev_err(dsaf_dev->dev, "del_entry failed,addr %pM!\n",\r\naddr);\r\nreturn -EINVAL;\r\n}\r\nhns_dsaf_set_mac_key(dsaf_dev, &mac_key, vlan_id, in_port_num, addr);\r\nentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\ndev_err(dsaf_dev->dev,\r\n"del_mac_entry failed, %s Mac key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(dsaf_dev->dev,\r\n"del_mac_entry, %s Mac key(%#x:%#x) entry_index%d\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val, entry_index);\r\nhns_dsaf_tcam_mc_invld(dsaf_dev, entry_index);\r\nsoft_mac_entry += entry_index;\r\nsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\r\nreturn 0;\r\n}\r\nint hns_dsaf_del_mac_mc_port(struct dsaf_device *dsaf_dev,\r\nstruct dsaf_drv_mac_single_dest_entry *mac_entry)\r\n{\r\nu16 entry_index = DSAF_INVALID_ENTRY_IDX;\r\nstruct dsaf_drv_tbl_tcam_key mac_key;\r\nstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\r\nu16 vlan_id;\r\nu8 in_port_num;\r\nstruct dsaf_tbl_tcam_mcast_cfg mac_data;\r\nstruct dsaf_tbl_tcam_data tcam_data;\r\nint mskid;\r\nconst u8 empty_msk[sizeof(mac_data.tbl_mcast_port_msk)] = {0};\r\nstruct dsaf_drv_tbl_tcam_key mask_key, tmp_mac_key;\r\nstruct dsaf_tbl_tcam_data *pmask_key = NULL;\r\nu8 mc_addr[ETH_ALEN];\r\nu8 *mc_mask;\r\nif (!(void *)mac_entry) {\r\ndev_err(dsaf_dev->dev,\r\n"hns_dsaf_del_mac_mc_port mac_entry is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nif (MAC_IS_ALL_ZEROS(mac_entry->addr)) {\r\ndev_err(dsaf_dev->dev, "del_port failed, addr %pM!\n",\r\nmac_entry->addr);\r\nreturn -EINVAL;\r\n}\r\nether_addr_copy(mc_addr, mac_entry->addr);\r\nmc_mask = dsaf_dev->mac_cb[mac_entry->in_port_num]->mc_mask;\r\nif (!AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\nhns_dsaf_mc_mask_bit_clear(mc_addr, mc_mask);\r\nhns_dsaf_set_mac_key(dsaf_dev, &mask_key, 0x00, 0xff, mc_addr);\r\nmask_key.high.val = le32_to_cpu(mask_key.high.val);\r\nmask_key.low.val = le32_to_cpu(mask_key.low.val);\r\npmask_key = (struct dsaf_tbl_tcam_data *)(&mask_key);\r\n}\r\nvlan_id = mac_entry->in_vlan_id;\r\nin_port_num = mac_entry->in_port_num;\r\nhns_dsaf_set_mac_key(dsaf_dev, &mac_key, vlan_id, in_port_num, mc_addr);\r\nentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\r\nif (entry_index == DSAF_INVALID_ENTRY_IDX) {\r\ndev_err(dsaf_dev->dev,\r\n"find_soft_mac_entry failed, %s Mac key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(dsaf_dev->dev,\r\n"del_mac_mc_port, %s key(%#x:%#x) index%d\n",\r\ndsaf_dev->ae_dev.name, mac_key.high.val,\r\nmac_key.low.val, entry_index);\r\nhns_dsaf_tcam_mc_get(dsaf_dev, entry_index, &tcam_data, &mac_data);\r\ntmp_mac_key.high.val = le32_to_cpu(tcam_data.tbl_tcam_data_high);\r\ntmp_mac_key.low.val = le32_to_cpu(tcam_data.tbl_tcam_data_low);\r\nif (mac_entry->port_num < DSAF_SERVICE_NW_NUM) {\r\nmskid = mac_entry->port_num;\r\n} else if (mac_entry->port_num >= DSAF_BASE_INNER_PORT_NUM) {\r\nmskid = mac_entry->port_num -\r\nDSAF_BASE_INNER_PORT_NUM + DSAF_SERVICE_NW_NUM;\r\n} else {\r\ndev_err(dsaf_dev->dev,\r\n"%s,pnum(%d)error,key(%#x:%#x)\n",\r\ndsaf_dev->ae_dev.name, mac_entry->port_num,\r\nmac_key.high.val, mac_key.low.val);\r\nreturn -EINVAL;\r\n}\r\ndsaf_set_bit(mac_data.tbl_mcast_port_msk[mskid / 32], mskid % 32, 0);\r\nif (!memcmp(mac_data.tbl_mcast_port_msk, empty_msk,\r\nsizeof(mac_data.tbl_mcast_port_msk))) {\r\nhns_dsaf_tcam_mc_invld(dsaf_dev, entry_index);\r\nsoft_mac_entry += entry_index;\r\nsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\r\n} else {\r\ntcam_data.tbl_tcam_data_high = cpu_to_le32(mac_key.high.val);\r\ntcam_data.tbl_tcam_data_low = cpu_to_le32(mac_key.low.val);\r\nhns_dsaf_tcam_mc_cfg(dsaf_dev, entry_index,\r\n&tcam_data,\r\npmask_key, &mac_data);\r\n}\r\nreturn 0;\r\n}\r\nint hns_dsaf_clr_mac_mc_port(struct dsaf_device *dsaf_dev, u8 mac_id,\r\nu8 port_num)\r\n{\r\nstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\r\nstruct dsaf_tbl_tcam_mcast_cfg mac_data;\r\nint ret = 0, i;\r\nif (HNS_DSAF_IS_DEBUG(dsaf_dev))\r\nreturn 0;\r\nfor (i = 0; i < DSAF_TCAM_SUM - DSAFV2_MAC_FUZZY_TCAM_NUM; i++) {\r\nu8 addr[ETH_ALEN];\r\nu8 port;\r\nsoft_mac_entry = priv->soft_mac_tbl + i;\r\nhns_dsaf_tcam_addr_get(&soft_mac_entry->tcam_key, addr);\r\nport = dsaf_get_field(\r\nsoft_mac_entry->tcam_key.low.bits.port_vlan,\r\nDSAF_TBL_TCAM_KEY_PORT_M,\r\nDSAF_TBL_TCAM_KEY_PORT_S);\r\nif (soft_mac_entry->index != DSAF_INVALID_ENTRY_IDX &&\r\nport == mac_id &&\r\nis_multicast_ether_addr(addr) &&\r\n!is_broadcast_ether_addr(addr)) {\r\nconst u32 empty_msk[DSAF_PORT_MSK_NUM] = {0};\r\nstruct dsaf_drv_mac_single_dest_entry mac_entry;\r\nether_addr_copy(mac_entry.addr, addr);\r\nmac_entry.in_vlan_id = dsaf_get_field(\r\nsoft_mac_entry->tcam_key.low.bits.port_vlan,\r\nDSAF_TBL_TCAM_KEY_VLAN_M,\r\nDSAF_TBL_TCAM_KEY_VLAN_S);\r\nmac_entry.in_port_num = mac_id;\r\nmac_entry.port_num = port_num;\r\nif (hns_dsaf_del_mac_mc_port(dsaf_dev, &mac_entry)) {\r\nret = -EINVAL;\r\ncontinue;\r\n}\r\nhns_dsaf_tcam_mc_get(dsaf_dev, i,\r\n(struct dsaf_tbl_tcam_data *)\r\n(&soft_mac_entry->tcam_key),\r\n&mac_data);\r\ndsaf_set_bit(mac_data.tbl_mcast_port_msk[mac_id / 32],\r\nmac_id % 32, 0);\r\nif (!memcmp(mac_data.tbl_mcast_port_msk, empty_msk,\r\nsizeof(u32) * DSAF_PORT_MSK_NUM)) {\r\nmac_entry.port_num = mac_id;\r\nif (hns_dsaf_del_mac_mc_port(dsaf_dev,\r\n&mac_entry)) {\r\nret = -EINVAL;\r\ncontinue;\r\n}\r\n}\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic struct dsaf_device *hns_dsaf_alloc_dev(struct device *dev,\r\nsize_t sizeof_priv)\r\n{\r\nstruct dsaf_device *dsaf_dev;\r\ndsaf_dev = devm_kzalloc(dev,\r\nsizeof(*dsaf_dev) + sizeof_priv, GFP_KERNEL);\r\nif (unlikely(!dsaf_dev)) {\r\ndsaf_dev = ERR_PTR(-ENOMEM);\r\n} else {\r\ndsaf_dev->dev = dev;\r\ndev_set_drvdata(dev, dsaf_dev);\r\n}\r\nreturn dsaf_dev;\r\n}\r\nstatic void hns_dsaf_free_dev(struct dsaf_device *dsaf_dev)\r\n{\r\n(void)dev_set_drvdata(dsaf_dev->dev, NULL);\r\n}\r\nstatic void hns_dsaf_pfc_unit_cnt(struct dsaf_device *dsaf_dev, int mac_id,\r\nenum dsaf_port_rate_mode rate)\r\n{\r\nu32 unit_cnt;\r\nswitch (rate) {\r\ncase DSAF_PORT_RATE_10000:\r\nunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_XGE;\r\nbreak;\r\ncase DSAF_PORT_RATE_1000:\r\nunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_GE_1000;\r\nbreak;\r\ncase DSAF_PORT_RATE_2500:\r\nunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_GE_1000;\r\nbreak;\r\ndefault:\r\nunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_XGE;\r\n}\r\ndsaf_set_dev_field(dsaf_dev,\r\n(DSAF_PFC_UNIT_CNT_0_REG + 0x4 * (u64)mac_id),\r\nDSAF_PFC_UNINT_CNT_M, DSAF_PFC_UNINT_CNT_S,\r\nunit_cnt);\r\n}\r\nvoid hns_dsaf_port_work_rate_cfg(struct dsaf_device *dsaf_dev, int mac_id,\r\nenum dsaf_port_rate_mode rate_mode)\r\n{\r\nu32 port_work_mode;\r\nport_work_mode = dsaf_read_dev(\r\ndsaf_dev, DSAF_XGE_GE_WORK_MODE_0_REG + 0x4 * (u64)mac_id);\r\nif (rate_mode == DSAF_PORT_RATE_10000)\r\ndsaf_set_bit(port_work_mode, DSAF_XGE_GE_WORK_MODE_S, 1);\r\nelse\r\ndsaf_set_bit(port_work_mode, DSAF_XGE_GE_WORK_MODE_S, 0);\r\ndsaf_write_dev(dsaf_dev,\r\nDSAF_XGE_GE_WORK_MODE_0_REG + 0x4 * (u64)mac_id,\r\nport_work_mode);\r\nhns_dsaf_pfc_unit_cnt(dsaf_dev, mac_id, rate_mode);\r\n}\r\nvoid hns_dsaf_fix_mac_mode(struct hns_mac_cb *mac_cb)\r\n{\r\nenum dsaf_port_rate_mode mode;\r\nstruct dsaf_device *dsaf_dev = mac_cb->dsaf_dev;\r\nint mac_id = mac_cb->mac_id;\r\nif (mac_cb->mac_type != HNAE_PORT_SERVICE)\r\nreturn;\r\nif (mac_cb->phy_if == PHY_INTERFACE_MODE_XGMII)\r\nmode = DSAF_PORT_RATE_10000;\r\nelse\r\nmode = DSAF_PORT_RATE_1000;\r\nhns_dsaf_port_work_rate_cfg(dsaf_dev, mac_id, mode);\r\n}\r\nstatic u32 hns_dsaf_get_inode_prio_reg(int index)\r\n{\r\nint base_index, offset;\r\nu32 base_addr = DSAF_INODE_IN_PRIO_PAUSE_BASE_REG;\r\nbase_index = (index + 1) / DSAF_REG_PER_ZONE;\r\noffset = (index + 1) % DSAF_REG_PER_ZONE;\r\nreturn base_addr + DSAF_INODE_IN_PRIO_PAUSE_BASE_OFFSET * base_index +\r\nDSAF_INODE_IN_PRIO_PAUSE_OFFSET * offset;\r\n}\r\nvoid hns_dsaf_update_stats(struct dsaf_device *dsaf_dev, u32 node_num)\r\n{\r\nstruct dsaf_hw_stats *hw_stats\r\n= &dsaf_dev->hw_stats[node_num];\r\nbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\r\nint i;\r\nu32 reg_tmp;\r\nhw_stats->pad_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_PAD_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->man_pkts += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_FINAL_IN_MAN_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->rx_pkts += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_FINAL_IN_PKT_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->rx_pkt_id += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_SBM_PID_NUM_0_REG + 0x80 * (u64)node_num);\r\nreg_tmp = is_ver1 ? DSAF_INODE_FINAL_IN_PAUSE_NUM_0_REG :\r\nDSAFV2_INODE_FINAL_IN_PAUSE_NUM_0_REG;\r\nhw_stats->rx_pause_frame +=\r\ndsaf_read_dev(dsaf_dev, reg_tmp + 0x80 * (u64)node_num);\r\nhw_stats->release_buf_num += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_SBM_RELS_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->sbm_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_SBM_DROP_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->crc_false += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_CRC_FALSE_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->bp_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_BP_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->rslt_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_RSLT_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->local_addr_false += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_LOCAL_ADDR_FALSE_NUM_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->vlan_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_SW_VLAN_TAG_DISC_0_REG + 0x80 * (u64)node_num);\r\nhw_stats->stp_drop += dsaf_read_dev(dsaf_dev,\r\nDSAF_INODE_IN_DATA_STP_DISC_0_REG + 0x80 * (u64)node_num);\r\nif ((node_num < DSAF_SERVICE_NW_NUM) && !is_ver1) {\r\nfor (i = 0; i < DSAF_PRIO_NR; i++) {\r\nreg_tmp = hns_dsaf_get_inode_prio_reg(i);\r\nhw_stats->rx_pfc[i] += dsaf_read_dev(dsaf_dev,\r\nreg_tmp + 0x4 * (u64)node_num);\r\nhw_stats->tx_pfc[i] += dsaf_read_dev(dsaf_dev,\r\nDSAF_XOD_XGE_PFC_PRIO_CNT_BASE_REG +\r\nDSAF_XOD_XGE_PFC_PRIO_CNT_OFFSET * i +\r\n0xF0 * (u64)node_num);\r\n}\r\n}\r\nhw_stats->tx_pkts += dsaf_read_dev(dsaf_dev,\r\nDSAF_XOD_RCVPKT_CNT_0_REG + 0x90 * (u64)node_num);\r\n}\r\nvoid hns_dsaf_get_regs(struct dsaf_device *ddev, u32 port, void *data)\r\n{\r\nu32 i = 0;\r\nu32 j;\r\nu32 *p = data;\r\nu32 reg_tmp;\r\nbool is_ver1 = AE_IS_VER1(ddev->dsaf_ver);\r\np[0] = dsaf_read_dev(ddev, DSAF_SRAM_INIT_OVER_0_REG);\r\np[1] = dsaf_read_dev(ddev, DSAF_CFG_0_REG);\r\np[2] = dsaf_read_dev(ddev, DSAF_ECC_ERR_INVERT_0_REG);\r\np[3] = dsaf_read_dev(ddev, DSAF_ABNORMAL_TIMEOUT_0_REG);\r\np[4] = dsaf_read_dev(ddev, DSAF_FSM_TIMEOUT_0_REG);\r\np[5] = dsaf_read_dev(ddev, DSAF_DSA_REG_CNT_CLR_CE_REG);\r\np[6] = dsaf_read_dev(ddev, DSAF_DSA_SBM_INF_FIFO_THRD_REG);\r\np[7] = dsaf_read_dev(ddev, DSAF_DSA_SRAM_1BIT_ECC_SEL_REG);\r\np[8] = dsaf_read_dev(ddev, DSAF_DSA_SRAM_1BIT_ECC_CNT_REG);\r\np[9] = dsaf_read_dev(ddev, DSAF_PFC_EN_0_REG + port * 4);\r\np[10] = dsaf_read_dev(ddev, DSAF_PFC_UNIT_CNT_0_REG + port * 4);\r\np[11] = dsaf_read_dev(ddev, DSAF_XGE_INT_MSK_0_REG + port * 4);\r\np[12] = dsaf_read_dev(ddev, DSAF_XGE_INT_SRC_0_REG + port * 4);\r\np[13] = dsaf_read_dev(ddev, DSAF_XGE_INT_STS_0_REG + port * 4);\r\np[14] = dsaf_read_dev(ddev, DSAF_XGE_INT_MSK_0_REG + port * 4);\r\np[15] = dsaf_read_dev(ddev, DSAF_PPE_INT_MSK_0_REG + port * 4);\r\np[16] = dsaf_read_dev(ddev, DSAF_ROCEE_INT_MSK_0_REG + port * 4);\r\np[17] = dsaf_read_dev(ddev, DSAF_XGE_INT_SRC_0_REG + port * 4);\r\np[18] = dsaf_read_dev(ddev, DSAF_PPE_INT_SRC_0_REG + port * 4);\r\np[19] = dsaf_read_dev(ddev, DSAF_ROCEE_INT_SRC_0_REG + port * 4);\r\np[20] = dsaf_read_dev(ddev, DSAF_XGE_INT_STS_0_REG + port * 4);\r\np[21] = dsaf_read_dev(ddev, DSAF_PPE_INT_STS_0_REG + port * 4);\r\np[22] = dsaf_read_dev(ddev, DSAF_ROCEE_INT_STS_0_REG + port * 4);\r\np[23] = dsaf_read_dev(ddev, DSAF_PPE_QID_CFG_0_REG + port * 4);\r\nfor (i = 0; i < DSAF_SW_PORT_NUM; i++)\r\np[24 + i] = dsaf_read_dev(ddev,\r\nDSAF_SW_PORT_TYPE_0_REG + i * 4);\r\np[32] = dsaf_read_dev(ddev, DSAF_MIX_DEF_QID_0_REG + port * 4);\r\nfor (i = 0; i < DSAF_SW_PORT_NUM; i++)\r\np[33 + i] = dsaf_read_dev(ddev,\r\nDSAF_PORT_DEF_VLAN_0_REG + i * 4);\r\nfor (i = 0; i < DSAF_TOTAL_QUEUE_NUM; i++)\r\np[41 + i] = dsaf_read_dev(ddev,\r\nDSAF_VM_DEF_VLAN_0_REG + i * 4);\r\np[170] = dsaf_read_dev(ddev, DSAF_INODE_CUT_THROUGH_CFG_0_REG);\r\np[171] = dsaf_read_dev(ddev,\r\nDSAF_INODE_ECC_ERR_ADDR_0_REG + port * 0x80);\r\nfor (i = 0; i < DSAF_INODE_NUM / DSAF_COMM_CHN; i++) {\r\nj = i * DSAF_COMM_CHN + port;\r\np[172 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_IN_PORT_NUM_0_REG + j * 0x80);\r\np[175 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_PRI_TC_CFG_0_REG + j * 0x80);\r\np[178 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_BP_STATUS_0_REG + j * 0x80);\r\np[181 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_PAD_DISCARD_NUM_0_REG + j * 0x80);\r\np[184 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_FINAL_IN_MAN_NUM_0_REG + j * 0x80);\r\np[187 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_FINAL_IN_PKT_NUM_0_REG + j * 0x80);\r\np[190 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_SBM_PID_NUM_0_REG + j * 0x80);\r\nreg_tmp = is_ver1 ? DSAF_INODE_FINAL_IN_PAUSE_NUM_0_REG :\r\nDSAFV2_INODE_FINAL_IN_PAUSE_NUM_0_REG;\r\np[193 + i] = dsaf_read_dev(ddev, reg_tmp + j * 0x80);\r\np[196 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_SBM_RELS_NUM_0_REG + j * 0x80);\r\np[199 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_SBM_DROP_NUM_0_REG + j * 0x80);\r\np[202 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_CRC_FALSE_NUM_0_REG + j * 0x80);\r\np[205 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_BP_DISCARD_NUM_0_REG + j * 0x80);\r\np[208 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_RSLT_DISCARD_NUM_0_REG + j * 0x80);\r\np[211 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_LOCAL_ADDR_FALSE_NUM_0_REG + j * 0x80);\r\np[214 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_VOQ_OVER_NUM_0_REG + j * 0x80);\r\np[217 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_BD_SAVE_STATUS_0_REG + j * 4);\r\np[220 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_BD_ORDER_STATUS_0_REG + j * 4);\r\np[223 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_SW_VLAN_TAG_DISC_0_REG + j * 4);\r\np[224 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_IN_DATA_STP_DISC_0_REG + j * 4);\r\n}\r\np[227] = dsaf_read_dev(ddev, DSAF_INODE_GE_FC_EN_0_REG + port * 4);\r\nfor (i = 0; i < DSAF_INODE_NUM / DSAF_COMM_CHN; i++) {\r\nj = i * DSAF_COMM_CHN + port;\r\np[228 + i] = dsaf_read_dev(ddev,\r\nDSAF_INODE_VC0_IN_PKT_NUM_0_REG + j * 4);\r\n}\r\np[231] = dsaf_read_dev(ddev,\r\nDSAF_INODE_VC1_IN_PKT_NUM_0_REG + port * 4);\r\nfor (i = 0; i < HNS_DSAF_SBM_NUM(ddev) / DSAF_COMM_CHN; i++) {\r\nj = i * DSAF_COMM_CHN + port;\r\np[232 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_CFG_REG_0_REG + j * 0x80);\r\np[235 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CFG_0_XGE_REG_0_REG + j * 0x80);\r\np[238 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CFG_1_REG_0_REG + j * 0x80);\r\np[241 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CFG_2_XGE_REG_0_REG + j * 0x80);\r\np[244 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_FREE_CNT_0_0_REG + j * 0x80);\r\np[245 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_FREE_CNT_1_0_REG + j * 0x80);\r\np[248 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CNT_0_0_REG + j * 0x80);\r\np[251 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CNT_1_0_REG + j * 0x80);\r\np[254 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CNT_2_0_REG + j * 0x80);\r\np[257 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CNT_3_0_REG + j * 0x80);\r\np[260 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_INER_ST_0_REG + j * 0x80);\r\np[263 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_MIB_REQ_FAILED_TC_0_REG + j * 0x80);\r\np[266 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_CNT_0_REG + j * 0x80);\r\np[269 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_DROP_CNT_0_REG + j * 0x80);\r\np[272 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_INF_OUTPORT_CNT_0_REG + j * 0x80);\r\np[275 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC0_CNT_0_REG + j * 0x80);\r\np[278 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC1_CNT_0_REG + j * 0x80);\r\np[281 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC2_CNT_0_REG + j * 0x80);\r\np[284 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC3_CNT_0_REG + j * 0x80);\r\np[287 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC4_CNT_0_REG + j * 0x80);\r\np[290 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC5_CNT_0_REG + j * 0x80);\r\np[293 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC6_CNT_0_REG + j * 0x80);\r\np[296 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_INPORT_TC7_CNT_0_REG + j * 0x80);\r\np[299 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_REQ_CNT_0_REG + j * 0x80);\r\np[302 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_LNK_RELS_CNT_0_REG + j * 0x80);\r\np[305 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CFG_3_REG_0_REG + j * 0x80);\r\np[308 + i] = dsaf_read_dev(ddev,\r\nDSAF_SBM_BP_CFG_4_REG_0_REG + j * 0x80);\r\n}\r\nfor (i = 0; i < DSAF_XOD_NUM; i++) {\r\np[311 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_TSA_TC0_TC3_CFG_0_REG + i * 0x90);\r\np[319 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_TSA_TC4_TC7_CFG_0_REG + i * 0x90);\r\np[327 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_BW_TC0_TC3_CFG_0_REG + i * 0x90);\r\np[335 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_BW_TC4_TC7_CFG_0_REG + i * 0x90);\r\np[343 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_BW_OFFSET_CFG_0_REG + i * 0x90);\r\np[351 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ETS_TOKEN_CFG_0_REG + i * 0x90);\r\n}\r\np[359] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_0_0_REG + port * 0x90);\r\np[360] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_1_0_REG + port * 0x90);\r\np[361] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_2_0_REG + port * 0x90);\r\nfor (i = 0; i < DSAF_XOD_BIG_NUM / DSAF_COMM_CHN; i++) {\r\nj = i * DSAF_COMM_CHN + port;\r\np[362 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_GNT_L_0_REG + j * 0x90);\r\np[365 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_GNT_H_0_REG + j * 0x90);\r\np[368 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_CONNECT_STATE_0_REG + j * 0x90);\r\np[371 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVPKT_CNT_0_REG + j * 0x90);\r\np[374 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVTC0_CNT_0_REG + j * 0x90);\r\np[377 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVTC1_CNT_0_REG + j * 0x90);\r\np[380 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVTC2_CNT_0_REG + j * 0x90);\r\np[383 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVTC3_CNT_0_REG + j * 0x90);\r\np[386 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVVC0_CNT_0_REG + j * 0x90);\r\np[389 + i] = dsaf_read_dev(ddev,\r\nDSAF_XOD_RCVVC1_CNT_0_REG + j * 0x90);\r\n}\r\np[392] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN0_CNT_0_REG + port * 0x90);\r\np[393] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN1_CNT_0_REG + port * 0x90);\r\np[394] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN2_CNT_0_REG + port * 0x90);\r\np[395] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN3_CNT_0_REG + port * 0x90);\r\np[396] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN4_CNT_0_REG + port * 0x90);\r\np[397] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN5_CNT_0_REG + port * 0x90);\r\np[398] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN6_CNT_0_REG + port * 0x90);\r\np[399] = dsaf_read_dev(ddev,\r\nDSAF_XOD_XGE_RCVIN7_CNT_0_REG + port * 0x90);\r\np[400] = dsaf_read_dev(ddev,\r\nDSAF_XOD_PPE_RCVIN0_CNT_0_REG + port * 0x90);\r\np[401] = dsaf_read_dev(ddev,\r\nDSAF_XOD_PPE_RCVIN1_CNT_0_REG + port * 0x90);\r\np[402] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ROCEE_RCVIN0_CNT_0_REG + port * 0x90);\r\np[403] = dsaf_read_dev(ddev,\r\nDSAF_XOD_ROCEE_RCVIN1_CNT_0_REG + port * 0x90);\r\np[404] = dsaf_read_dev(ddev,\r\nDSAF_XOD_FIFO_STATUS_0_REG + port * 0x90);\r\nfor (i = 0; i < DSAF_VOQ_NUM / DSAF_COMM_CHN; i++) {\r\nj = (i * DSAF_COMM_CHN + port) * 0x90;\r\np[405 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_ECC_INVERT_EN_0_REG + j);\r\np[408 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_SRAM_PKT_NUM_0_REG + j);\r\np[411 + i] = dsaf_read_dev(ddev, DSAF_VOQ_IN_PKT_NUM_0_REG + j);\r\np[414 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_OUT_PKT_NUM_0_REG + j);\r\np[417 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_ECC_ERR_ADDR_0_REG + j);\r\np[420 + i] = dsaf_read_dev(ddev, DSAF_VOQ_BP_STATUS_0_REG + j);\r\np[423 + i] = dsaf_read_dev(ddev, DSAF_VOQ_SPUP_IDLE_0_REG + j);\r\np[426 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_XGE_XOD_REQ_0_0_REG + j);\r\np[429 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_XGE_XOD_REQ_1_0_REG + j);\r\np[432 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_PPE_XOD_REQ_0_REG + j);\r\np[435 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_ROCEE_XOD_REQ_0_REG + j);\r\np[438 + i] = dsaf_read_dev(ddev,\r\nDSAF_VOQ_BP_ALL_THRD_0_REG + j);\r\n}\r\np[441] = dsaf_read_dev(ddev, DSAF_TBL_CTRL_0_REG);\r\np[442] = dsaf_read_dev(ddev, DSAF_TBL_INT_MSK_0_REG);\r\np[443] = dsaf_read_dev(ddev, DSAF_TBL_INT_SRC_0_REG);\r\np[444] = dsaf_read_dev(ddev, DSAF_TBL_INT_STS_0_REG);\r\np[445] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_ADDR_0_REG);\r\np[446] = dsaf_read_dev(ddev, DSAF_TBL_LINE_ADDR_0_REG);\r\np[447] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_HIGH_0_REG);\r\np[448] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_LOW_0_REG);\r\np[449] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG);\r\np[450] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG);\r\np[451] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG);\r\np[452] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG);\r\np[453] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG);\r\np[454] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_UCAST_CFG_0_REG);\r\np[455] = dsaf_read_dev(ddev, DSAF_TBL_LIN_CFG_0_REG);\r\np[456] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\r\np[457] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\r\np[458] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA4_0_REG);\r\np[459] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA3_0_REG);\r\np[460] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA2_0_REG);\r\np[461] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA1_0_REG);\r\np[462] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA0_0_REG);\r\np[463] = dsaf_read_dev(ddev, DSAF_TBL_LIN_RDATA_0_REG);\r\nfor (i = 0; i < DSAF_SW_PORT_NUM; i++) {\r\nj = i * 0x8;\r\np[464 + 2 * i] = dsaf_read_dev(ddev,\r\nDSAF_TBL_DA0_MIS_INFO1_0_REG + j);\r\np[465 + 2 * i] = dsaf_read_dev(ddev,\r\nDSAF_TBL_DA0_MIS_INFO0_0_REG + j);\r\n}\r\np[480] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO2_0_REG);\r\np[481] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO1_0_REG);\r\np[482] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO0_0_REG);\r\np[483] = dsaf_read_dev(ddev, DSAF_TBL_PUL_0_REG);\r\np[484] = dsaf_read_dev(ddev, DSAF_TBL_OLD_RSLT_0_REG);\r\np[485] = dsaf_read_dev(ddev, DSAF_TBL_OLD_SCAN_VAL_0_REG);\r\np[486] = dsaf_read_dev(ddev, DSAF_TBL_DFX_CTRL_0_REG);\r\np[487] = dsaf_read_dev(ddev, DSAF_TBL_DFX_STAT_0_REG);\r\np[488] = dsaf_read_dev(ddev, DSAF_TBL_DFX_STAT_2_0_REG);\r\np[489] = dsaf_read_dev(ddev, DSAF_TBL_LKUP_NUM_I_0_REG);\r\np[490] = dsaf_read_dev(ddev, DSAF_TBL_LKUP_NUM_O_0_REG);\r\np[491] = dsaf_read_dev(ddev, DSAF_TBL_UCAST_BCAST_MIS_INFO_0_0_REG);\r\np[492] = dsaf_read_dev(ddev, DSAF_INODE_FIFO_WL_0_REG + port * 0x4);\r\np[493] = dsaf_read_dev(ddev, DSAF_ONODE_FIFO_WL_0_REG + port * 0x4);\r\np[494] = dsaf_read_dev(ddev, DSAF_XGE_GE_WORK_MODE_0_REG + port * 0x4);\r\np[495] = dsaf_read_dev(ddev,\r\nDSAF_XGE_APP_RX_LINK_UP_0_REG + port * 0x4);\r\np[496] = dsaf_read_dev(ddev, DSAF_NETPORT_CTRL_SIG_0_REG + port * 0x4);\r\np[497] = dsaf_read_dev(ddev, DSAF_XGE_CTRL_SIG_CFG_0_REG + port * 0x4);\r\nif (!is_ver1)\r\np[498] = dsaf_read_dev(ddev, DSAF_PAUSE_CFG_REG + port * 0x4);\r\nfor (i = 499; i < 504; i++)\r\np[i] = 0xdddddddd;\r\n}\r\nstatic char *hns_dsaf_get_node_stats_strings(char *data, int node,\r\nstruct dsaf_device *dsaf_dev)\r\n{\r\nchar *buff = data;\r\nint i;\r\nbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_pad_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_manage_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_rx_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_rx_pkt_id", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_rx_pause_frame", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_release_buf_num", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_sbm_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_crc_false_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_bp_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_lookup_rslt_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_local_rslt_fail_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_vlan_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nsnprintf(buff, ETH_GSTRING_LEN, "innod%d_stp_drop_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nif (node < DSAF_SERVICE_NW_NUM && !is_ver1) {\r\nfor (i = 0; i < DSAF_PRIO_NR; i++) {\r\nsnprintf(buff + 0 * ETH_GSTRING_LEN * DSAF_PRIO_NR,\r\nETH_GSTRING_LEN, "inod%d_pfc_prio%d_pkts",\r\nnode, i);\r\nsnprintf(buff + 1 * ETH_GSTRING_LEN * DSAF_PRIO_NR,\r\nETH_GSTRING_LEN, "onod%d_pfc_prio%d_pkts",\r\nnode, i);\r\nbuff += ETH_GSTRING_LEN;\r\n}\r\nbuff += 1 * DSAF_PRIO_NR * ETH_GSTRING_LEN;\r\n}\r\nsnprintf(buff, ETH_GSTRING_LEN, "onnod%d_tx_pkts", node);\r\nbuff += ETH_GSTRING_LEN;\r\nreturn buff;\r\n}\r\nstatic u64 *hns_dsaf_get_node_stats(struct dsaf_device *ddev, u64 *data,\r\nint node_num)\r\n{\r\nu64 *p = data;\r\nint i;\r\nstruct dsaf_hw_stats *hw_stats = &ddev->hw_stats[node_num];\r\nbool is_ver1 = AE_IS_VER1(ddev->dsaf_ver);\r\np[0] = hw_stats->pad_drop;\r\np[1] = hw_stats->man_pkts;\r\np[2] = hw_stats->rx_pkts;\r\np[3] = hw_stats->rx_pkt_id;\r\np[4] = hw_stats->rx_pause_frame;\r\np[5] = hw_stats->release_buf_num;\r\np[6] = hw_stats->sbm_drop;\r\np[7] = hw_stats->crc_false;\r\np[8] = hw_stats->bp_drop;\r\np[9] = hw_stats->rslt_drop;\r\np[10] = hw_stats->local_addr_false;\r\np[11] = hw_stats->vlan_drop;\r\np[12] = hw_stats->stp_drop;\r\nif (node_num < DSAF_SERVICE_NW_NUM && !is_ver1) {\r\nfor (i = 0; i < DSAF_PRIO_NR; i++) {\r\np[13 + i + 0 * DSAF_PRIO_NR] = hw_stats->rx_pfc[i];\r\np[13 + i + 1 * DSAF_PRIO_NR] = hw_stats->tx_pfc[i];\r\n}\r\np[29] = hw_stats->tx_pkts;\r\nreturn &p[30];\r\n}\r\np[13] = hw_stats->tx_pkts;\r\nreturn &p[14];\r\n}\r\nvoid hns_dsaf_get_stats(struct dsaf_device *ddev, u64 *data, int port)\r\n{\r\nu64 *p = data;\r\nint node_num = port;\r\np = hns_dsaf_get_node_stats(ddev, p, node_num);\r\nnode_num = port + DSAF_PPE_INODE_BASE;\r\n(void)hns_dsaf_get_node_stats(ddev, p, node_num);\r\n}\r\nint hns_dsaf_get_sset_count(struct dsaf_device *dsaf_dev, int stringset)\r\n{\r\nbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\r\nif (stringset == ETH_SS_STATS) {\r\nif (is_ver1)\r\nreturn DSAF_STATIC_NUM;\r\nelse\r\nreturn DSAF_V2_STATIC_NUM;\r\n}\r\nreturn 0;\r\n}\r\nvoid hns_dsaf_get_strings(int stringset, u8 *data, int port,\r\nstruct dsaf_device *dsaf_dev)\r\n{\r\nchar *buff = (char *)data;\r\nint node = port;\r\nif (stringset != ETH_SS_STATS)\r\nreturn;\r\nbuff = hns_dsaf_get_node_stats_strings(buff, node, dsaf_dev);\r\nnode = port + DSAF_PPE_INODE_BASE;\r\n(void)hns_dsaf_get_node_stats_strings(buff, node, dsaf_dev);\r\n}\r\nint hns_dsaf_get_regs_count(void)\r\n{\r\nreturn DSAF_DUMP_REGS_NUM;\r\n}\r\nvoid hns_dsaf_set_promisc_tcam(struct dsaf_device *dsaf_dev,\r\nu32 port, bool enable)\r\n{\r\nstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\r\nstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\r\nu16 entry_index;\r\nstruct dsaf_drv_tbl_tcam_key tbl_tcam_data, tbl_tcam_mask;\r\nstruct dsaf_tbl_tcam_mcast_cfg mac_data = {0};\r\nif ((AE_IS_VER1(dsaf_dev->dsaf_ver)) || HNS_DSAF_IS_DEBUG(dsaf_dev))\r\nreturn;\r\nentry_index = dsaf_promisc_tcam_entry(port);\r\nmemset(&tbl_tcam_data, 0, sizeof(tbl_tcam_data));\r\nmemset(&tbl_tcam_mask, 0, sizeof(tbl_tcam_mask));\r\nif (enable) {\r\ndsaf_set_field(tbl_tcam_data.low.bits.port_vlan,\r\nDSAF_TBL_TCAM_KEY_PORT_M,\r\nDSAF_TBL_TCAM_KEY_PORT_S, port);\r\ndsaf_set_field(tbl_tcam_mask.low.bits.port_vlan,\r\nDSAF_TBL_TCAM_KEY_PORT_M,\r\nDSAF_TBL_TCAM_KEY_PORT_S, 0xf);\r\ndsaf_set_bit(mac_data.tbl_mcast_port_msk[0],\r\nDSAF_SERVICE_NW_NUM, true);\r\nmac_data.tbl_mcast_item_vld = true;\r\n} else {\r\nmac_data.tbl_mcast_item_vld = false;\r\n}\r\ndev_dbg(dsaf_dev->dev,\r\n"set_promisc_entry, %s Mac key(%#x:%#x) entry_index%d\n",\r\ndsaf_dev->ae_dev.name, tbl_tcam_data.high.val,\r\ntbl_tcam_data.low.val, entry_index);\r\nhns_dsaf_tcam_mc_cfg(dsaf_dev, entry_index,\r\n(struct dsaf_tbl_tcam_data *)&tbl_tcam_data,\r\n(struct dsaf_tbl_tcam_data *)&tbl_tcam_mask,\r\n&mac_data);\r\nsoft_mac_entry += entry_index;\r\nsoft_mac_entry->index = enable ? entry_index : DSAF_INVALID_ENTRY_IDX;\r\n}\r\nstatic int hns_dsaf_probe(struct platform_device *pdev)\r\n{\r\nstruct dsaf_device *dsaf_dev;\r\nint ret;\r\ndsaf_dev = hns_dsaf_alloc_dev(&pdev->dev, sizeof(struct dsaf_drv_priv));\r\nif (IS_ERR(dsaf_dev)) {\r\nret = PTR_ERR(dsaf_dev);\r\ndev_err(&pdev->dev,\r\n"dsaf_probe dsaf_alloc_dev failed, ret = %#x!\n", ret);\r\nreturn ret;\r\n}\r\nret = hns_dsaf_get_cfg(dsaf_dev);\r\nif (ret)\r\ngoto free_dev;\r\nret = hns_dsaf_init(dsaf_dev);\r\nif (ret)\r\ngoto free_dev;\r\nret = hns_mac_init(dsaf_dev);\r\nif (ret)\r\ngoto uninit_dsaf;\r\nret = hns_ppe_init(dsaf_dev);\r\nif (ret)\r\ngoto uninit_mac;\r\nret = hns_dsaf_ae_init(dsaf_dev);\r\nif (ret)\r\ngoto uninit_ppe;\r\nreturn 0;\r\nuninit_ppe:\r\nhns_ppe_uninit(dsaf_dev);\r\nuninit_mac:\r\nhns_mac_uninit(dsaf_dev);\r\nuninit_dsaf:\r\nhns_dsaf_free(dsaf_dev);\r\nfree_dev:\r\nhns_dsaf_free_dev(dsaf_dev);\r\nreturn ret;\r\n}\r\nstatic int hns_dsaf_remove(struct platform_device *pdev)\r\n{\r\nstruct dsaf_device *dsaf_dev = dev_get_drvdata(&pdev->dev);\r\nhns_dsaf_ae_uninit(dsaf_dev);\r\nhns_ppe_uninit(dsaf_dev);\r\nhns_mac_uninit(dsaf_dev);\r\nhns_dsaf_free(dsaf_dev);\r\nhns_dsaf_free_dev(dsaf_dev);\r\nreturn 0;\r\n}\r\nint hns_dsaf_roce_reset(struct fwnode_handle *dsaf_fwnode, bool dereset)\r\n{\r\nstruct dsaf_device *dsaf_dev;\r\nstruct platform_device *pdev;\r\nu32 mp;\r\nu32 sl;\r\nu32 credit;\r\nint i;\r\nconst u32 port_map[DSAF_ROCE_CREDIT_CHN][DSAF_ROCE_CHAN_MODE_NUM] = {\r\n{DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0},\r\n{DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0},\r\n{DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0},\r\n{DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0},\r\n{DSAF_ROCE_PORT_4, DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1},\r\n{DSAF_ROCE_PORT_4, DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1},\r\n{DSAF_ROCE_PORT_5, DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1},\r\n{DSAF_ROCE_PORT_5, DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1},\r\n};\r\nconst u32 sl_map[DSAF_ROCE_CREDIT_CHN][DSAF_ROCE_CHAN_MODE_NUM] = {\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_0},\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_1, DSAF_ROCE_SL_1},\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_2},\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_1, DSAF_ROCE_SL_3},\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_0},\r\n{DSAF_ROCE_SL_1, DSAF_ROCE_SL_1, DSAF_ROCE_SL_1},\r\n{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_2},\r\n{DSAF_ROCE_SL_1, DSAF_ROCE_SL_1, DSAF_ROCE_SL_3},\r\n};\r\nif (is_of_node(dsaf_fwnode)) {\r\npdev = of_find_device_by_node(to_of_node(dsaf_fwnode));\r\n} else if (is_acpi_device_node(dsaf_fwnode)) {\r\npdev = hns_dsaf_find_platform_device(dsaf_fwnode);\r\n} else {\r\npr_err("fwnode is neither OF or ACPI type\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdev) {\r\npr_err("couldn't find platform device for node\n");\r\nreturn -ENODEV;\r\n}\r\ndsaf_dev = dev_get_drvdata(&pdev->dev);\r\nif (!dsaf_dev) {\r\ndev_err(&pdev->dev, "dsaf_dev is NULL\n");\r\nreturn -ENODEV;\r\n}\r\nif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\r\ndev_err(dsaf_dev->dev, "%s v1 chip doesn't support RoCE!\n",\r\ndsaf_dev->ae_dev.name);\r\nreturn -ENODEV;\r\n}\r\nif (!dereset) {\r\ndsaf_dev->misc_op->hns_dsaf_srst_chns(dsaf_dev, DSAF_CHNS_MASK,\r\nfalse);\r\ndsaf_dev->misc_op->hns_dsaf_roce_srst(dsaf_dev, false);\r\n} else {\r\nmp = dsaf_read_dev(dsaf_dev, DSAF_ROCE_PORT_MAP_REG);\r\nfor (i = 0; i < DSAF_ROCE_CREDIT_CHN; i++)\r\ndsaf_set_field(mp, 7 << i * 3, i * 3,\r\nport_map[i][DSAF_ROCE_6PORT_MODE]);\r\ndsaf_set_field(mp, 3 << i * 3, i * 3, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_ROCE_PORT_MAP_REG, mp);\r\nsl = dsaf_read_dev(dsaf_dev, DSAF_ROCE_SL_MAP_REG);\r\nfor (i = 0; i < DSAF_ROCE_CREDIT_CHN; i++)\r\ndsaf_set_field(sl, 3 << i * 2, i * 2,\r\nsl_map[i][DSAF_ROCE_6PORT_MODE]);\r\ndsaf_write_dev(dsaf_dev, DSAF_ROCE_SL_MAP_REG, sl);\r\ndsaf_dev->misc_op->hns_dsaf_srst_chns(dsaf_dev, DSAF_CHNS_MASK,\r\ntrue);\r\nmsleep(SRST_TIME_INTERVAL);\r\ndsaf_dev->misc_op->hns_dsaf_roce_srst(dsaf_dev, true);\r\ncredit = dsaf_read_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG);\r\ndsaf_set_bit(credit, DSAF_SBM_ROCEE_CFG_CRD_EN_B, 0);\r\ndsaf_write_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG, credit);\r\ndsaf_set_bit(credit, DSAF_SBM_ROCEE_CFG_CRD_EN_B, 1);\r\ndsaf_write_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG, credit);\r\n}\r\nreturn 0;\r\n}

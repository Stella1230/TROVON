int pblk_write_to_cache(struct pblk *pblk, struct bio *bio, unsigned long flags)\r\n{\r\nstruct pblk_w_ctx w_ctx;\r\nsector_t lba = pblk_get_lba(bio);\r\nunsigned int bpos, pos;\r\nint nr_entries = pblk_get_secs(bio);\r\nint i, ret;\r\nretry:\r\nret = pblk_rb_may_write_user(&pblk->rwb, bio, nr_entries, &bpos);\r\nswitch (ret) {\r\ncase NVM_IO_REQUEUE:\r\nio_schedule();\r\ngoto retry;\r\ncase NVM_IO_ERR:\r\npblk_pipeline_stop(pblk);\r\ngoto out;\r\n}\r\nif (unlikely(!bio_has_data(bio)))\r\ngoto out;\r\nw_ctx.flags = flags;\r\npblk_ppa_set_empty(&w_ctx.ppa);\r\nfor (i = 0; i < nr_entries; i++) {\r\nvoid *data = bio_data(bio);\r\nw_ctx.lba = lba + i;\r\npos = pblk_rb_wrap_pos(&pblk->rwb, bpos + i);\r\npblk_rb_write_entry_user(&pblk->rwb, data, w_ctx, pos);\r\nbio_advance(bio, PBLK_EXPOSED_PAGE_SIZE);\r\n}\r\n#ifdef CONFIG_NVM_DEBUG\r\natomic_long_add(nr_entries, &pblk->inflight_writes);\r\natomic_long_add(nr_entries, &pblk->req_writes);\r\n#endif\r\npblk_rl_inserted(&pblk->rl, nr_entries);\r\nout:\r\npblk_write_should_kick(pblk);\r\nreturn ret;\r\n}\r\nint pblk_write_gc_to_cache(struct pblk *pblk, void *data, u64 *lba_list,\r\nunsigned int nr_entries, unsigned int nr_rec_entries,\r\nstruct pblk_line *gc_line, unsigned long flags)\r\n{\r\nstruct pblk_w_ctx w_ctx;\r\nunsigned int bpos, pos;\r\nint i, valid_entries;\r\nretry:\r\nif (!pblk_rb_may_write_gc(&pblk->rwb, nr_rec_entries, &bpos)) {\r\nio_schedule();\r\ngoto retry;\r\n}\r\nw_ctx.flags = flags;\r\npblk_ppa_set_empty(&w_ctx.ppa);\r\nfor (i = 0, valid_entries = 0; i < nr_entries; i++) {\r\nif (lba_list[i] == ADDR_EMPTY)\r\ncontinue;\r\nw_ctx.lba = lba_list[i];\r\npos = pblk_rb_wrap_pos(&pblk->rwb, bpos + valid_entries);\r\npblk_rb_write_entry_gc(&pblk->rwb, data, w_ctx, gc_line, pos);\r\ndata += PBLK_EXPOSED_PAGE_SIZE;\r\nvalid_entries++;\r\n}\r\nWARN_ONCE(nr_rec_entries != valid_entries,\r\n"pblk: inconsistent GC write\n");\r\n#ifdef CONFIG_NVM_DEBUG\r\natomic_long_add(valid_entries, &pblk->inflight_writes);\r\natomic_long_add(valid_entries, &pblk->recov_gc_writes);\r\n#endif\r\npblk_write_should_kick(pblk);\r\nreturn NVM_IO_OK;\r\n}

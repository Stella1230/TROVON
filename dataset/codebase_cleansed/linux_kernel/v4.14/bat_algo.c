void batadv_algo_init(void)\r\n{\r\nINIT_HLIST_HEAD(&batadv_algo_list);\r\n}\r\nstatic struct batadv_algo_ops *batadv_algo_get(char *name)\r\n{\r\nstruct batadv_algo_ops *bat_algo_ops = NULL, *bat_algo_ops_tmp;\r\nhlist_for_each_entry(bat_algo_ops_tmp, &batadv_algo_list, list) {\r\nif (strcmp(bat_algo_ops_tmp->name, name) != 0)\r\ncontinue;\r\nbat_algo_ops = bat_algo_ops_tmp;\r\nbreak;\r\n}\r\nreturn bat_algo_ops;\r\n}\r\nint batadv_algo_register(struct batadv_algo_ops *bat_algo_ops)\r\n{\r\nstruct batadv_algo_ops *bat_algo_ops_tmp;\r\nbat_algo_ops_tmp = batadv_algo_get(bat_algo_ops->name);\r\nif (bat_algo_ops_tmp) {\r\npr_info("Trying to register already registered routing algorithm: %s\n",\r\nbat_algo_ops->name);\r\nreturn -EEXIST;\r\n}\r\nif (!bat_algo_ops->iface.enable ||\r\n!bat_algo_ops->iface.disable ||\r\n!bat_algo_ops->iface.update_mac ||\r\n!bat_algo_ops->iface.primary_set ||\r\n!bat_algo_ops->neigh.cmp ||\r\n!bat_algo_ops->neigh.is_similar_or_better) {\r\npr_info("Routing algo '%s' does not implement required ops\n",\r\nbat_algo_ops->name);\r\nreturn -EINVAL;\r\n}\r\nINIT_HLIST_NODE(&bat_algo_ops->list);\r\nhlist_add_head(&bat_algo_ops->list, &batadv_algo_list);\r\nreturn 0;\r\n}\r\nint batadv_algo_select(struct batadv_priv *bat_priv, char *name)\r\n{\r\nstruct batadv_algo_ops *bat_algo_ops;\r\nbat_algo_ops = batadv_algo_get(name);\r\nif (!bat_algo_ops)\r\nreturn -EINVAL;\r\nbat_priv->algo_ops = bat_algo_ops;\r\nreturn 0;\r\n}\r\nint batadv_algo_seq_print_text(struct seq_file *seq, void *offset)\r\n{\r\nstruct batadv_algo_ops *bat_algo_ops;\r\nseq_puts(seq, "Available routing algorithms:\n");\r\nhlist_for_each_entry(bat_algo_ops, &batadv_algo_list, list) {\r\nseq_printf(seq, " * %s\n", bat_algo_ops->name);\r\n}\r\nreturn 0;\r\n}\r\nstatic int batadv_param_set_ra(const char *val, const struct kernel_param *kp)\r\n{\r\nstruct batadv_algo_ops *bat_algo_ops;\r\nchar *algo_name = (char *)val;\r\nsize_t name_len = strlen(algo_name);\r\nif (name_len > 0 && algo_name[name_len - 1] == '\n')\r\nalgo_name[name_len - 1] = '\0';\r\nbat_algo_ops = batadv_algo_get(algo_name);\r\nif (!bat_algo_ops) {\r\npr_err("Routing algorithm '%s' is not supported\n", algo_name);\r\nreturn -EINVAL;\r\n}\r\nreturn param_set_copystring(algo_name, kp);\r\n}\r\nstatic int batadv_algo_dump_entry(struct sk_buff *msg, u32 portid, u32 seq,\r\nstruct batadv_algo_ops *bat_algo_ops)\r\n{\r\nvoid *hdr;\r\nhdr = genlmsg_put(msg, portid, seq, &batadv_netlink_family,\r\nNLM_F_MULTI, BATADV_CMD_GET_ROUTING_ALGOS);\r\nif (!hdr)\r\nreturn -EMSGSIZE;\r\nif (nla_put_string(msg, BATADV_ATTR_ALGO_NAME, bat_algo_ops->name))\r\ngoto nla_put_failure;\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(msg, hdr);\r\nreturn -EMSGSIZE;\r\n}\r\nint batadv_algo_dump(struct sk_buff *msg, struct netlink_callback *cb)\r\n{\r\nint portid = NETLINK_CB(cb->skb).portid;\r\nstruct batadv_algo_ops *bat_algo_ops;\r\nint skip = cb->args[0];\r\nint i = 0;\r\nhlist_for_each_entry(bat_algo_ops, &batadv_algo_list, list) {\r\nif (i++ < skip)\r\ncontinue;\r\nif (batadv_algo_dump_entry(msg, portid, cb->nlh->nlmsg_seq,\r\nbat_algo_ops)) {\r\ni--;\r\nbreak;\r\n}\r\n}\r\ncb->args[0] = i;\r\nreturn msg->len;\r\n}

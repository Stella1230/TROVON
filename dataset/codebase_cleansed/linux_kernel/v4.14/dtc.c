static int is_power_of_2(int x)\r\n{\r\nreturn (x > 0) && ((x & (x - 1)) == 0);\r\n}\r\nstatic void fill_fullpaths(struct node *tree, const char *prefix)\r\n{\r\nstruct node *child;\r\nconst char *unit;\r\ntree->fullpath = join_path(prefix, tree->name);\r\nunit = strchr(tree->name, '@');\r\nif (unit)\r\ntree->basenamelen = unit - tree->name;\r\nelse\r\ntree->basenamelen = strlen(tree->name);\r\nfor_each_child(tree, child)\r\nfill_fullpaths(child, tree->fullpath);\r\n}\r\nstatic const char *guess_type_by_name(const char *fname, const char *fallback)\r\n{\r\nconst char *s;\r\ns = strrchr(fname, '.');\r\nif (s == NULL)\r\nreturn fallback;\r\nif (!strcasecmp(s, ".dts"))\r\nreturn "dts";\r\nif (!strcasecmp(s, ".dtb"))\r\nreturn "dtb";\r\nreturn fallback;\r\n}\r\nstatic const char *guess_input_format(const char *fname, const char *fallback)\r\n{\r\nstruct stat statbuf;\r\nfdt32_t magic;\r\nFILE *f;\r\nif (stat(fname, &statbuf) != 0)\r\nreturn fallback;\r\nif (S_ISDIR(statbuf.st_mode))\r\nreturn "fs";\r\nif (!S_ISREG(statbuf.st_mode))\r\nreturn fallback;\r\nf = fopen(fname, "r");\r\nif (f == NULL)\r\nreturn fallback;\r\nif (fread(&magic, 4, 1, f) != 1) {\r\nfclose(f);\r\nreturn fallback;\r\n}\r\nfclose(f);\r\nif (fdt32_to_cpu(magic) == FDT_MAGIC)\r\nreturn "dtb";\r\nreturn guess_type_by_name(fname, fallback);\r\n}\r\nint main(int argc, char *argv[])\r\n{\r\nstruct dt_info *dti;\r\nconst char *inform = NULL;\r\nconst char *outform = NULL;\r\nconst char *outname = "-";\r\nconst char *depname = NULL;\r\nbool force = false, sort = false;\r\nconst char *arg;\r\nint opt;\r\nFILE *outf = NULL;\r\nint outversion = DEFAULT_FDT_VERSION;\r\nlong long cmdline_boot_cpuid = -1;\r\nquiet = 0;\r\nreservenum = 0;\r\nminsize = 0;\r\npadsize = 0;\r\nalignsize = 0;\r\nwhile ((opt = util_getopt_long()) != EOF) {\r\nswitch (opt) {\r\ncase 'I':\r\ninform = optarg;\r\nbreak;\r\ncase 'O':\r\noutform = optarg;\r\nbreak;\r\ncase 'o':\r\noutname = optarg;\r\nbreak;\r\ncase 'V':\r\noutversion = strtol(optarg, NULL, 0);\r\nbreak;\r\ncase 'd':\r\ndepname = optarg;\r\nbreak;\r\ncase 'R':\r\nreservenum = strtol(optarg, NULL, 0);\r\nbreak;\r\ncase 'S':\r\nminsize = strtol(optarg, NULL, 0);\r\nbreak;\r\ncase 'p':\r\npadsize = strtol(optarg, NULL, 0);\r\nbreak;\r\ncase 'a':\r\nalignsize = strtol(optarg, NULL, 0);\r\nif (!is_power_of_2(alignsize))\r\ndie("Invalid argument \"%d\" to -a option\n",\r\nalignsize);\r\nbreak;\r\ncase 'f':\r\nforce = true;\r\nbreak;\r\ncase 'q':\r\nquiet++;\r\nbreak;\r\ncase 'b':\r\ncmdline_boot_cpuid = strtoll(optarg, NULL, 0);\r\nbreak;\r\ncase 'i':\r\nsrcfile_add_search_path(optarg);\r\nbreak;\r\ncase 'v':\r\nutil_version();\r\ncase 'H':\r\nif (streq(optarg, "legacy"))\r\nphandle_format = PHANDLE_LEGACY;\r\nelse if (streq(optarg, "epapr"))\r\nphandle_format = PHANDLE_EPAPR;\r\nelse if (streq(optarg, "both"))\r\nphandle_format = PHANDLE_BOTH;\r\nelse\r\ndie("Invalid argument \"%s\" to -H option\n",\r\noptarg);\r\nbreak;\r\ncase 's':\r\nsort = true;\r\nbreak;\r\ncase 'W':\r\nparse_checks_option(true, false, optarg);\r\nbreak;\r\ncase 'E':\r\nparse_checks_option(false, true, optarg);\r\nbreak;\r\ncase '@':\r\ngenerate_symbols = 1;\r\nbreak;\r\ncase 'A':\r\nauto_label_aliases = 1;\r\nbreak;\r\ncase 'h':\r\nusage(NULL);\r\ndefault:\r\nusage("unknown option");\r\n}\r\n}\r\nif (argc > (optind+1))\r\nusage("missing files");\r\nelse if (argc < (optind+1))\r\narg = "-";\r\nelse\r\narg = argv[optind];\r\nif (minsize && padsize)\r\ndie("Can't set both -p and -S\n");\r\nif (depname) {\r\ndepfile = fopen(depname, "w");\r\nif (!depfile)\r\ndie("Couldn't open dependency file %s: %s\n", depname,\r\nstrerror(errno));\r\nfprintf(depfile, "%s:", outname);\r\n}\r\nif (inform == NULL)\r\ninform = guess_input_format(arg, "dts");\r\nif (outform == NULL) {\r\noutform = guess_type_by_name(outname, NULL);\r\nif (outform == NULL) {\r\nif (streq(inform, "dts"))\r\noutform = "dtb";\r\nelse\r\noutform = "dts";\r\n}\r\n}\r\nif (streq(inform, "dts"))\r\ndti = dt_from_source(arg);\r\nelse if (streq(inform, "fs"))\r\ndti = dt_from_fs(arg);\r\nelse if(streq(inform, "dtb"))\r\ndti = dt_from_blob(arg);\r\nelse\r\ndie("Unknown input format \"%s\"\n", inform);\r\ndti->outname = outname;\r\nif (depfile) {\r\nfputc('\n', depfile);\r\nfclose(depfile);\r\n}\r\nif (cmdline_boot_cpuid != -1)\r\ndti->boot_cpuid_phys = cmdline_boot_cpuid;\r\nfill_fullpaths(dti->dt, "");\r\nprocess_checks(force, dti);\r\nif (dti->dtsflags & DTSF_PLUGIN) {\r\ngenerate_fixups = 1;\r\n}\r\nif (auto_label_aliases)\r\ngenerate_label_tree(dti, "aliases", false);\r\nif (generate_symbols)\r\ngenerate_label_tree(dti, "__symbols__", true);\r\nif (generate_fixups) {\r\ngenerate_fixups_tree(dti, "__fixups__");\r\ngenerate_local_fixups_tree(dti, "__local_fixups__");\r\n}\r\nif (sort)\r\nsort_tree(dti);\r\nif (streq(outname, "-")) {\r\noutf = stdout;\r\n} else {\r\noutf = fopen(outname, "wb");\r\nif (! outf)\r\ndie("Couldn't open output file %s: %s\n",\r\noutname, strerror(errno));\r\n}\r\nif (streq(outform, "dts")) {\r\ndt_to_source(outf, dti);\r\n} else if (streq(outform, "dtb")) {\r\ndt_to_blob(outf, dti, outversion);\r\n} else if (streq(outform, "asm")) {\r\ndt_to_asm(outf, dti, outversion);\r\n} else if (streq(outform, "null")) {\r\n} else {\r\ndie("Unknown output format \"%s\"\n", outform);\r\n}\r\nexit(0);\r\n}

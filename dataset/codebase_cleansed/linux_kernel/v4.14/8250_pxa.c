static int __maybe_unused serial_pxa_suspend(struct device *dev)\r\n{\r\nstruct pxa8250_data *data = dev_get_drvdata(dev);\r\nserial8250_suspend_port(data->line);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused serial_pxa_resume(struct device *dev)\r\n{\r\nstruct pxa8250_data *data = dev_get_drvdata(dev);\r\nserial8250_resume_port(data->line);\r\nreturn 0;\r\n}\r\nstatic void serial_pxa_dl_write(struct uart_8250_port *up, int value)\r\n{\r\nunsigned int dll;\r\nserial_out(up, UART_DLL, value & 0xff);\r\ndll = serial_in(up, UART_DLL);\r\nWARN_ON(dll != (value & 0xff));\r\nserial_out(up, UART_DLM, value >> 8 & 0xff);\r\n}\r\nstatic void serial_pxa_pm(struct uart_port *port, unsigned int state,\r\nunsigned int oldstate)\r\n{\r\nstruct pxa8250_data *data = port->private_data;\r\nif (!state)\r\nclk_prepare_enable(data->clk);\r\nelse\r\nclk_disable_unprepare(data->clk);\r\n}\r\nstatic int serial_pxa_probe(struct platform_device *pdev)\r\n{\r\nstruct uart_8250_port uart = {};\r\nstruct pxa8250_data *data;\r\nstruct resource *mmres, *irqres;\r\nint ret;\r\nmmres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nirqres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!mmres || !irqres)\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(data->clk))\r\nreturn PTR_ERR(data->clk);\r\nret = clk_prepare(data->clk);\r\nif (ret)\r\nreturn ret;\r\nuart.port.type = PORT_XSCALE;\r\nuart.port.iotype = UPIO_MEM32;\r\nuart.port.mapbase = mmres->start;\r\nuart.port.regshift = 2;\r\nuart.port.irq = irqres->start;\r\nuart.port.fifosize = 64;\r\nuart.port.flags = UPF_IOREMAP | UPF_SKIP_TEST;\r\nuart.port.dev = &pdev->dev;\r\nuart.port.uartclk = clk_get_rate(data->clk);\r\nuart.port.pm = serial_pxa_pm;\r\nuart.port.private_data = data;\r\nuart.dl_write = serial_pxa_dl_write;\r\nret = serial8250_register_8250_port(&uart);\r\nif (ret < 0)\r\ngoto err_clk;\r\ndata->line = ret;\r\nplatform_set_drvdata(pdev, data);\r\nreturn 0;\r\nerr_clk:\r\nclk_unprepare(data->clk);\r\nreturn ret;\r\n}\r\nstatic int serial_pxa_remove(struct platform_device *pdev)\r\n{\r\nstruct pxa8250_data *data = platform_get_drvdata(pdev);\r\nserial8250_unregister_port(data->line);\r\nclk_unprepare(data->clk);\r\nreturn 0;\r\n}\r\nstatic int __init early_serial_pxa_setup(struct earlycon_device *device,\r\nconst char *options)\r\n{\r\nstruct uart_port *port = &device->port;\r\nif (!(device->port.membase || device->port.iobase))\r\nreturn -ENODEV;\r\nport->regshift = 2;\r\nreturn early_serial8250_setup(device, NULL);\r\n}

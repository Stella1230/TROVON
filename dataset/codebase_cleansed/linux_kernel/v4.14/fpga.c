static void fpga_mask_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - OMAP_FPGA_IRQ_BASE;\r\nif (irq < 8)\r\n__raw_writeb((__raw_readb(OMAP1510_FPGA_IMR_LO)\r\n& ~(1 << irq)), OMAP1510_FPGA_IMR_LO);\r\nelse if (irq < 16)\r\n__raw_writeb((__raw_readb(OMAP1510_FPGA_IMR_HI)\r\n& ~(1 << (irq - 8))), OMAP1510_FPGA_IMR_HI);\r\nelse\r\n__raw_writeb((__raw_readb(INNOVATOR_FPGA_IMR2)\r\n& ~(1 << (irq - 16))), INNOVATOR_FPGA_IMR2);\r\n}\r\nstatic inline u32 get_fpga_unmasked_irqs(void)\r\n{\r\nreturn\r\n((__raw_readb(OMAP1510_FPGA_ISR_LO) &\r\n__raw_readb(OMAP1510_FPGA_IMR_LO))) |\r\n((__raw_readb(OMAP1510_FPGA_ISR_HI) &\r\n__raw_readb(OMAP1510_FPGA_IMR_HI)) << 8) |\r\n((__raw_readb(INNOVATOR_FPGA_ISR2) &\r\n__raw_readb(INNOVATOR_FPGA_IMR2)) << 16);\r\n}\r\nstatic void fpga_ack_irq(struct irq_data *d)\r\n{\r\n}\r\nstatic void fpga_unmask_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - OMAP_FPGA_IRQ_BASE;\r\nif (irq < 8)\r\n__raw_writeb((__raw_readb(OMAP1510_FPGA_IMR_LO) | (1 << irq)),\r\nOMAP1510_FPGA_IMR_LO);\r\nelse if (irq < 16)\r\n__raw_writeb((__raw_readb(OMAP1510_FPGA_IMR_HI)\r\n| (1 << (irq - 8))), OMAP1510_FPGA_IMR_HI);\r\nelse\r\n__raw_writeb((__raw_readb(INNOVATOR_FPGA_IMR2)\r\n| (1 << (irq - 16))), INNOVATOR_FPGA_IMR2);\r\n}\r\nstatic void fpga_mask_ack_irq(struct irq_data *d)\r\n{\r\nfpga_mask_irq(d);\r\nfpga_ack_irq(d);\r\n}\r\nstatic void innovator_fpga_IRQ_demux(struct irq_desc *desc)\r\n{\r\nu32 stat;\r\nint fpga_irq;\r\nstat = get_fpga_unmasked_irqs();\r\nif (!stat)\r\nreturn;\r\nfor (fpga_irq = OMAP_FPGA_IRQ_BASE;\r\n(fpga_irq < OMAP_FPGA_IRQ_END) && stat;\r\nfpga_irq++, stat >>= 1) {\r\nif (stat & 1) {\r\ngeneric_handle_irq(fpga_irq);\r\n}\r\n}\r\n}\r\nvoid omap1510_fpga_init_irq(void)\r\n{\r\nint i, res;\r\n__raw_writeb(0, OMAP1510_FPGA_IMR_LO);\r\n__raw_writeb(0, OMAP1510_FPGA_IMR_HI);\r\n__raw_writeb(0, INNOVATOR_FPGA_IMR2);\r\nfor (i = OMAP_FPGA_IRQ_BASE; i < OMAP_FPGA_IRQ_END; i++) {\r\nif (i == OMAP1510_INT_FPGA_TS) {\r\nirq_set_chip(i, &omap_fpga_irq_ack);\r\n}\r\nelse {\r\nirq_set_chip(i, &omap_fpga_irq);\r\n}\r\nirq_set_handler(i, handle_edge_irq);\r\nirq_clear_status_flags(i, IRQ_NOREQUEST);\r\n}\r\nres = gpio_request(13, "FPGA irq");\r\nif (res) {\r\npr_err("%s failed to get gpio\n", __func__);\r\nreturn;\r\n}\r\ngpio_direction_input(13);\r\nirq_set_irq_type(gpio_to_irq(13), IRQ_TYPE_EDGE_RISING);\r\nirq_set_chained_handler(OMAP1510_INT_FPGA, innovator_fpga_IRQ_demux);\r\n}

static void duramar2150_c2port_access(struct c2port_device *dev, int status)\r\n{\r\nu8 v;\r\nmutex_lock(&update_lock);\r\nv = inb(DIR_PORT);\r\nif (status)\r\noutb(v | (C2D | C2CK), DIR_PORT);\r\nelse\r\noutb(v & ~(C2D | C2CK), DIR_PORT);\r\nmutex_unlock(&update_lock);\r\n}\r\nstatic void duramar2150_c2port_c2d_dir(struct c2port_device *dev, int dir)\r\n{\r\nu8 v;\r\nmutex_lock(&update_lock);\r\nv = inb(DIR_PORT);\r\nif (dir)\r\noutb(v & ~C2D, DIR_PORT);\r\nelse\r\noutb(v | C2D, DIR_PORT);\r\nmutex_unlock(&update_lock);\r\n}\r\nstatic int duramar2150_c2port_c2d_get(struct c2port_device *dev)\r\n{\r\nreturn inb(DATA_PORT) & C2D;\r\n}\r\nstatic void duramar2150_c2port_c2d_set(struct c2port_device *dev, int status)\r\n{\r\nu8 v;\r\nmutex_lock(&update_lock);\r\nv = inb(DATA_PORT);\r\nif (status)\r\noutb(v | C2D, DATA_PORT);\r\nelse\r\noutb(v & ~C2D, DATA_PORT);\r\nmutex_unlock(&update_lock);\r\n}\r\nstatic void duramar2150_c2port_c2ck_set(struct c2port_device *dev, int status)\r\n{\r\nu8 v;\r\nmutex_lock(&update_lock);\r\nv = inb(DATA_PORT);\r\nif (status)\r\noutb(v | C2CK, DATA_PORT);\r\nelse\r\noutb(v & ~C2CK, DATA_PORT);\r\nmutex_unlock(&update_lock);\r\n}\r\nstatic int __init duramar2150_c2port_init(void)\r\n{\r\nstruct resource *res;\r\nint ret = 0;\r\nres = request_region(0x325, 2, "c2port");\r\nif (!res)\r\nreturn -EBUSY;\r\nduramar2150_c2port_dev = c2port_device_register("uc",\r\n&duramar2150_c2port_ops, NULL);\r\nif (IS_ERR(duramar2150_c2port_dev)) {\r\nret = PTR_ERR(duramar2150_c2port_dev);\r\ngoto free_region;\r\n}\r\nreturn 0;\r\nfree_region:\r\nrelease_region(0x325, 2);\r\nreturn ret;\r\n}\r\nstatic void __exit duramar2150_c2port_exit(void)\r\n{\r\nduramar2150_c2port_access(duramar2150_c2port_dev, 0);\r\nc2port_device_unregister(duramar2150_c2port_dev);\r\nrelease_region(0x325, 2);\r\n}

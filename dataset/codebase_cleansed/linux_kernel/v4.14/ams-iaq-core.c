static int ams_iaqcore_read_measurement(struct ams_iaqcore_data *data)\r\n{\r\nstruct i2c_client *client = data->client;\r\nint ret;\r\nstruct i2c_msg msg = {\r\n.addr = client->addr,\r\n.flags = client->flags | I2C_M_RD,\r\n.len = AMS_IAQCORE_DATA_SIZE,\r\n.buf = (char *) &data->buffer,\r\n};\r\nret = i2c_transfer(client->adapter, &msg, 1);\r\nreturn (ret == AMS_IAQCORE_DATA_SIZE) ? 0 : ret;\r\n}\r\nstatic int ams_iaqcore_get_measurement(struct ams_iaqcore_data *data)\r\n{\r\nint ret;\r\nif (!time_after(jiffies, data->last_update + HZ))\r\nreturn 0;\r\nret = ams_iaqcore_read_measurement(data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->last_update = jiffies;\r\nreturn 0;\r\n}\r\nstatic int ams_iaqcore_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int *val,\r\nint *val2, long mask)\r\n{\r\nstruct ams_iaqcore_data *data = iio_priv(indio_dev);\r\nint ret;\r\nif (mask != IIO_CHAN_INFO_PROCESSED)\r\nreturn -EINVAL;\r\nmutex_lock(&data->lock);\r\nret = ams_iaqcore_get_measurement(data);\r\nif (ret)\r\ngoto err_out;\r\nswitch (chan->address) {\r\ncase AMS_IAQCORE_VOC_CO2_IDX:\r\n*val = 0;\r\n*val2 = be16_to_cpu(data->buffer.co2_ppm);\r\nret = IIO_VAL_INT_PLUS_MICRO;\r\nbreak;\r\ncase AMS_IAQCORE_VOC_RESISTANCE_IDX:\r\n*val = be32_to_cpu(data->buffer.resistance);\r\nret = IIO_VAL_INT;\r\nbreak;\r\ncase AMS_IAQCORE_VOC_TVOC_IDX:\r\n*val = 0;\r\n*val2 = be16_to_cpu(data->buffer.voc_ppb);\r\nret = IIO_VAL_INT_PLUS_NANO;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nerr_out:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic int ams_iaqcore_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct ams_iaqcore_data *data;\r\nindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*data));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\ndata = iio_priv(indio_dev);\r\ni2c_set_clientdata(client, indio_dev);\r\ndata->client = client;\r\ndata->last_update = jiffies - HZ;\r\nmutex_init(&data->lock);\r\nindio_dev->dev.parent = &client->dev;\r\nindio_dev->info = &ams_iaqcore_info;\r\nindio_dev->name = dev_name(&client->dev);\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = ams_iaqcore_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(ams_iaqcore_channels);\r\nreturn devm_iio_device_register(&client->dev, indio_dev);\r\n}

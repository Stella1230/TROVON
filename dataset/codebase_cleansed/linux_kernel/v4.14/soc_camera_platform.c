static struct soc_camera_platform_priv *get_priv(struct platform_device *pdev)\r\n{\r\nstruct v4l2_subdev *subdev = platform_get_drvdata(pdev);\r\nreturn container_of(subdev, struct soc_camera_platform_priv, subdev);\r\n}\r\nstatic int soc_camera_platform_s_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\nreturn p->set_capture(p, enable);\r\n}\r\nstatic int soc_camera_platform_fill_fmt(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *format)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *mf = &format->format;\r\nmf->width = p->format.width;\r\nmf->height = p->format.height;\r\nmf->code = p->format.code;\r\nmf->colorspace = p->format.colorspace;\r\nmf->field = p->format.field;\r\nreturn 0;\r\n}\r\nstatic int soc_camera_platform_s_power(struct v4l2_subdev *sd, int on)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\nreturn soc_camera_set_power(p->icd->control, &p->icd->sdesc->subdev_desc, NULL, on);\r\n}\r\nstatic int soc_camera_platform_enum_mbus_code(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\nif (code->pad || code->index)\r\nreturn -EINVAL;\r\ncode->code = p->format.code;\r\nreturn 0;\r\n}\r\nstatic int soc_camera_platform_get_selection(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\nif (sel->which != V4L2_SUBDEV_FORMAT_ACTIVE)\r\nreturn -EINVAL;\r\nswitch (sel->target) {\r\ncase V4L2_SEL_TGT_CROP_BOUNDS:\r\ncase V4L2_SEL_TGT_CROP_DEFAULT:\r\ncase V4L2_SEL_TGT_CROP:\r\nsel->r.left = 0;\r\nsel->r.top = 0;\r\nsel->r.width = p->format.width;\r\nsel->r.height = p->format.height;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int soc_camera_platform_g_mbus_config(struct v4l2_subdev *sd,\r\nstruct v4l2_mbus_config *cfg)\r\n{\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(sd);\r\ncfg->flags = p->mbus_param;\r\ncfg->type = p->mbus_type;\r\nreturn 0;\r\n}\r\nstatic int soc_camera_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct soc_camera_host *ici;\r\nstruct soc_camera_platform_priv *priv;\r\nstruct soc_camera_platform_info *p = pdev->dev.platform_data;\r\nstruct soc_camera_device *icd;\r\nif (!p)\r\nreturn -EINVAL;\r\nif (!p->icd) {\r\ndev_err(&pdev->dev,\r\n"Platform has not set soc_camera_device pointer!\n");\r\nreturn -EINVAL;\r\n}\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nicd = p->icd;\r\nplatform_set_drvdata(pdev, &priv->subdev);\r\nicd->control = &pdev->dev;\r\nici = to_soc_camera_host(icd->parent);\r\nv4l2_subdev_init(&priv->subdev, &platform_subdev_ops);\r\nv4l2_set_subdevdata(&priv->subdev, p);\r\nstrncpy(priv->subdev.name, dev_name(&pdev->dev), V4L2_SUBDEV_NAME_SIZE);\r\nreturn v4l2_device_register_subdev(&ici->v4l2_dev, &priv->subdev);\r\n}\r\nstatic int soc_camera_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct soc_camera_platform_priv *priv = get_priv(pdev);\r\nstruct soc_camera_platform_info *p = v4l2_get_subdevdata(&priv->subdev);\r\np->icd->control = NULL;\r\nv4l2_device_unregister_subdev(&priv->subdev);\r\nreturn 0;\r\n}

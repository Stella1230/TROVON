static int\r\nnfp_devlink_fill_eth_port(struct nfp_port *port,\r\nstruct nfp_eth_table_port *copy)\r\n{\r\nstruct nfp_eth_table_port *eth_port;\r\neth_port = __nfp_port_get_eth_port(port);\r\nif (!eth_port)\r\nreturn -EINVAL;\r\nmemcpy(copy, eth_port, sizeof(*eth_port));\r\nreturn 0;\r\n}\r\nstatic int\r\nnfp_devlink_fill_eth_port_from_id(struct nfp_pf *pf, unsigned int port_index,\r\nstruct nfp_eth_table_port *copy)\r\n{\r\nstruct nfp_port *port;\r\nport = nfp_port_from_id(pf, NFP_PORT_PHYS_PORT, port_index);\r\nreturn nfp_devlink_fill_eth_port(port, copy);\r\n}\r\nstatic int\r\nnfp_devlink_set_lanes(struct nfp_pf *pf, unsigned int idx, unsigned int lanes)\r\n{\r\nstruct nfp_nsp *nsp;\r\nint ret;\r\nnsp = nfp_eth_config_start(pf->cpp, idx);\r\nif (IS_ERR(nsp))\r\nreturn PTR_ERR(nsp);\r\nret = __nfp_eth_set_split(nsp, lanes);\r\nif (ret) {\r\nnfp_eth_config_cleanup_end(nsp);\r\nreturn ret;\r\n}\r\nret = nfp_eth_config_commit_end(nsp);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret)\r\nreturn 0;\r\nreturn nfp_net_refresh_port_table_sync(pf);\r\n}\r\nstatic int\r\nnfp_devlink_port_split(struct devlink *devlink, unsigned int port_index,\r\nunsigned int count)\r\n{\r\nstruct nfp_pf *pf = devlink_priv(devlink);\r\nstruct nfp_eth_table_port eth_port;\r\nint ret;\r\nif (count < 2)\r\nreturn -EINVAL;\r\nmutex_lock(&pf->lock);\r\nrtnl_lock();\r\nret = nfp_devlink_fill_eth_port_from_id(pf, port_index, &eth_port);\r\nrtnl_unlock();\r\nif (ret)\r\ngoto out;\r\nif (eth_port.is_split || eth_port.port_lanes % count) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = nfp_devlink_set_lanes(pf, eth_port.index,\r\neth_port.port_lanes / count);\r\nout:\r\nmutex_unlock(&pf->lock);\r\nreturn ret;\r\n}\r\nstatic int\r\nnfp_devlink_port_unsplit(struct devlink *devlink, unsigned int port_index)\r\n{\r\nstruct nfp_pf *pf = devlink_priv(devlink);\r\nstruct nfp_eth_table_port eth_port;\r\nint ret;\r\nmutex_lock(&pf->lock);\r\nrtnl_lock();\r\nret = nfp_devlink_fill_eth_port_from_id(pf, port_index, &eth_port);\r\nrtnl_unlock();\r\nif (ret)\r\ngoto out;\r\nif (!eth_port.is_split) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = nfp_devlink_set_lanes(pf, eth_port.index, eth_port.port_lanes);\r\nout:\r\nmutex_unlock(&pf->lock);\r\nreturn ret;\r\n}\r\nstatic int nfp_devlink_eswitch_mode_get(struct devlink *devlink, u16 *mode)\r\n{\r\nstruct nfp_pf *pf = devlink_priv(devlink);\r\nint ret;\r\nmutex_lock(&pf->lock);\r\nif (!pf->app) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nret = nfp_app_eswitch_mode_get(pf->app, mode);\r\nout:\r\nmutex_unlock(&pf->lock);\r\nreturn ret;\r\n}\r\nint nfp_devlink_port_register(struct nfp_app *app, struct nfp_port *port)\r\n{\r\nstruct nfp_eth_table_port eth_port;\r\nstruct devlink *devlink;\r\nint ret;\r\nrtnl_lock();\r\nret = nfp_devlink_fill_eth_port(port, &eth_port);\r\nrtnl_unlock();\r\nif (ret)\r\nreturn ret;\r\ndevlink_port_type_eth_set(&port->dl_port, port->netdev);\r\nif (eth_port.is_split)\r\ndevlink_port_split_set(&port->dl_port, eth_port.label_port);\r\ndevlink = priv_to_devlink(app->pf);\r\nreturn devlink_port_register(devlink, &port->dl_port, port->eth_id);\r\n}\r\nvoid nfp_devlink_port_unregister(struct nfp_port *port)\r\n{\r\ndevlink_port_unregister(&port->dl_port);\r\n}

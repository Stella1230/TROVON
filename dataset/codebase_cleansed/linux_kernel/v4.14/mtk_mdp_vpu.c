static inline struct mtk_mdp_ctx *vpu_to_ctx(struct mtk_mdp_vpu *vpu)\r\n{\r\nreturn container_of(vpu, struct mtk_mdp_ctx, vpu);\r\n}\r\nstatic void mtk_mdp_vpu_handle_init_ack(struct mdp_ipi_comm_ack *msg)\r\n{\r\nstruct mtk_mdp_vpu *vpu = (struct mtk_mdp_vpu *)\r\n(unsigned long)msg->ap_inst;\r\nvpu->vsi = (struct mdp_process_vsi *)\r\nvpu_mapping_dm_addr(vpu->pdev, msg->vpu_inst_addr);\r\nvpu->inst_addr = msg->vpu_inst_addr;\r\n}\r\nstatic void mtk_mdp_vpu_ipi_handler(void *data, unsigned int len, void *priv)\r\n{\r\nunsigned int msg_id = *(unsigned int *)data;\r\nstruct mdp_ipi_comm_ack *msg = (struct mdp_ipi_comm_ack *)data;\r\nstruct mtk_mdp_vpu *vpu = (struct mtk_mdp_vpu *)\r\n(unsigned long)msg->ap_inst;\r\nstruct mtk_mdp_ctx *ctx;\r\nvpu->failure = msg->status;\r\nif (!vpu->failure) {\r\nswitch (msg_id) {\r\ncase VPU_MDP_INIT_ACK:\r\nmtk_mdp_vpu_handle_init_ack(data);\r\nbreak;\r\ncase VPU_MDP_DEINIT_ACK:\r\ncase VPU_MDP_PROCESS_ACK:\r\nbreak;\r\ndefault:\r\nctx = vpu_to_ctx(vpu);\r\ndev_err(&ctx->mdp_dev->pdev->dev,\r\n"handle unknown ipi msg:0x%x\n",\r\nmsg_id);\r\nbreak;\r\n}\r\n} else {\r\nctx = vpu_to_ctx(vpu);\r\nmtk_mdp_dbg(0, "[%d]:msg 0x%x, failure:%d", ctx->id,\r\nmsg_id, vpu->failure);\r\n}\r\n}\r\nint mtk_mdp_vpu_register(struct platform_device *pdev)\r\n{\r\nstruct mtk_mdp_dev *mdp = platform_get_drvdata(pdev);\r\nint err;\r\nerr = vpu_ipi_register(mdp->vpu_dev, IPI_MDP,\r\nmtk_mdp_vpu_ipi_handler, "mdp_vpu", NULL);\r\nif (err)\r\ndev_err(&mdp->pdev->dev,\r\n"vpu_ipi_registration fail status=%d\n", err);\r\nreturn err;\r\n}\r\nstatic int mtk_mdp_vpu_send_msg(void *msg, int len, struct mtk_mdp_vpu *vpu,\r\nint id)\r\n{\r\nstruct mtk_mdp_ctx *ctx = vpu_to_ctx(vpu);\r\nint err;\r\nif (!vpu->pdev) {\r\nmtk_mdp_dbg(1, "[%d]:vpu pdev is NULL", ctx->id);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&ctx->mdp_dev->vpulock);\r\nerr = vpu_ipi_send(vpu->pdev, (enum ipi_id)id, msg, len);\r\nif (err)\r\ndev_err(&ctx->mdp_dev->pdev->dev,\r\n"vpu_ipi_send fail status %d\n", err);\r\nmutex_unlock(&ctx->mdp_dev->vpulock);\r\nreturn err;\r\n}\r\nstatic int mtk_mdp_vpu_send_ap_ipi(struct mtk_mdp_vpu *vpu, uint32_t msg_id)\r\n{\r\nint err;\r\nstruct mdp_ipi_comm msg;\r\nmsg.msg_id = msg_id;\r\nmsg.ipi_id = IPI_MDP;\r\nmsg.vpu_inst_addr = vpu->inst_addr;\r\nmsg.ap_inst = (unsigned long)vpu;\r\nerr = mtk_mdp_vpu_send_msg((void *)&msg, sizeof(msg), vpu, IPI_MDP);\r\nif (!err && vpu->failure)\r\nerr = -EINVAL;\r\nreturn err;\r\n}\r\nint mtk_mdp_vpu_init(struct mtk_mdp_vpu *vpu)\r\n{\r\nint err;\r\nstruct mdp_ipi_init msg;\r\nstruct mtk_mdp_ctx *ctx = vpu_to_ctx(vpu);\r\nvpu->pdev = ctx->mdp_dev->vpu_dev;\r\nmsg.msg_id = AP_MDP_INIT;\r\nmsg.ipi_id = IPI_MDP;\r\nmsg.ap_inst = (unsigned long)vpu;\r\nerr = mtk_mdp_vpu_send_msg((void *)&msg, sizeof(msg), vpu, IPI_MDP);\r\nif (!err && vpu->failure)\r\nerr = -EINVAL;\r\nreturn err;\r\n}\r\nint mtk_mdp_vpu_deinit(struct mtk_mdp_vpu *vpu)\r\n{\r\nreturn mtk_mdp_vpu_send_ap_ipi(vpu, AP_MDP_DEINIT);\r\n}\r\nint mtk_mdp_vpu_process(struct mtk_mdp_vpu *vpu)\r\n{\r\nreturn mtk_mdp_vpu_send_ap_ipi(vpu, AP_MDP_PROCESS);\r\n}

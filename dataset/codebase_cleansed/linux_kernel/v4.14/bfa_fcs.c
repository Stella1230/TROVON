static void\r\nbfa_fcs_exit_comp(void *fcs_cbarg)\r\n{\r\nstruct bfa_fcs_s *fcs = fcs_cbarg;\r\nstruct bfad_s *bfad = fcs->bfad;\r\ncomplete(&bfad->comp);\r\n}\r\nvoid\r\nbfa_fcs_init(struct bfa_fcs_s *fcs)\r\n{\r\nbfa_sm_send_event(&fcs->fabric, BFA_FCS_FABRIC_SM_CREATE);\r\nbfa_trc(fcs, 0);\r\n}\r\nvoid\r\nbfa_fcs_update_cfg(struct bfa_fcs_s *fcs)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = &fcs->fabric;\r\nstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\r\nstruct bfa_ioc_s *ioc = &fabric->fcs->bfa->ioc;\r\nport_cfg->nwwn = ioc->attr->nwwn;\r\nport_cfg->pwwn = ioc->attr->pwwn;\r\n}\r\nvoid\r\nbfa_fcs_stop(struct bfa_fcs_s *fcs)\r\n{\r\nbfa_wc_init(&fcs->wc, bfa_fcs_exit_comp, fcs);\r\nbfa_wc_up(&fcs->wc);\r\nbfa_fcs_fabric_modstop(fcs);\r\nbfa_wc_wait(&fcs->wc);\r\n}\r\nvoid\r\nbfa_fcs_pbc_vport_init(struct bfa_fcs_s *fcs)\r\n{\r\nint i, npbc_vports;\r\nstruct bfi_pbc_vport_s pbc_vports[BFI_PBC_MAX_VPORTS];\r\nif (!fcs->min_cfg) {\r\nnpbc_vports =\r\nbfa_iocfc_get_pbc_vports(fcs->bfa, pbc_vports);\r\nfor (i = 0; i < npbc_vports; i++)\r\nbfa_fcb_pbc_vport_create(fcs->bfa->bfad, pbc_vports[i]);\r\n}\r\n}\r\nvoid\r\nbfa_fcs_driver_info_init(struct bfa_fcs_s *fcs,\r\nstruct bfa_fcs_driver_info_s *driver_info)\r\n{\r\nfcs->driver_info = *driver_info;\r\nbfa_fcs_fabric_psymb_init(&fcs->fabric);\r\nbfa_fcs_fabric_nsymb_init(&fcs->fabric);\r\n}\r\nvoid\r\nbfa_fcs_exit(struct bfa_fcs_s *fcs)\r\n{\r\nbfa_wc_init(&fcs->wc, bfa_fcs_exit_comp, fcs);\r\nbfa_wc_up(&fcs->wc);\r\nbfa_trc(fcs, 0);\r\nbfa_lps_delete(fcs->fabric.lps);\r\nbfa_sm_send_event(&fcs->fabric, BFA_FCS_FABRIC_SM_DELETE);\r\nbfa_wc_wait(&fcs->wc);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_uninit(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_CREATE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\r\nbfa_fcs_fabric_init(fabric);\r\nbfa_fcs_lport_init(&fabric->bport, &fabric->bport.port_cfg);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_UP:\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_created(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_START:\r\nif (!bfa_fcport_is_linkup(fabric->fcs->bfa)) {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbreak;\r\n}\r\nif (bfa_fcport_get_topology(bfa) ==\r\nBFA_PORT_TOPOLOGY_LOOP) {\r\nfabric->fab_type = BFA_FCS_FABRIC_LOOP;\r\nfabric->bport.pid = bfa_fcport_get_myalpa(bfa);\r\nfabric->bport.pid = bfa_hton3b(fabric->bport.pid);\r\nbfa_sm_set_state(fabric,\r\nbfa_fcs_fabric_sm_online);\r\nbfa_fcs_fabric_set_opertype(fabric);\r\nbfa_fcs_lport_online(&fabric->bport);\r\n} else {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\r\nbfa_fcs_fabric_login(fabric);\r\n}\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_UP:\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_linkdown(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_LINK_UP:\r\nif (bfa_fcport_get_topology(bfa) != BFA_PORT_TOPOLOGY_LOOP) {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\r\nbfa_fcs_fabric_login(fabric);\r\nbreak;\r\n}\r\nfabric->fab_type = BFA_FCS_FABRIC_LOOP;\r\nfabric->bport.pid = bfa_fcport_get_myalpa(bfa);\r\nfabric->bport.pid = bfa_hton3b(fabric->bport.pid);\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\r\nbfa_fcs_fabric_set_opertype(fabric);\r\nbfa_fcs_lport_online(&fabric->bport);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_RETRY_OP:\r\ncase BFA_FCS_FABRIC_SM_LOOPBACK:\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_STOP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\r\nbfa_fcs_fabric_stop(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_flogi(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_CONT_OP:\r\nbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\r\nfabric->bb_credit);\r\nfabric->fab_type = BFA_FCS_FABRIC_SWITCHED;\r\nif (fabric->auth_reqd && fabric->is_auth) {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth);\r\nbfa_trc(fabric->fcs, event);\r\n} else {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\r\nbfa_fcs_fabric_notify_online(fabric);\r\n}\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_RETRY_OP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi_retry);\r\nbfa_timer_start(fabric->fcs->bfa, &fabric->delay_timer,\r\nbfa_fcs_fabric_delay, fabric,\r\nBFA_FCS_FABRIC_RETRY_DELAY);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LOOPBACK:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_loopback);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbfa_fcs_fabric_set_opertype(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_NO_FABRIC:\r\nfabric->fab_type = BFA_FCS_FABRIC_N2N;\r\nbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\r\nfabric->bb_credit);\r\nbfa_fcs_fabric_notify_online(fabric);\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_nofabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_flogi_retry(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_DELAYED:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\r\nbfa_fcs_fabric_login(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_timer_stop(&fabric->delay_timer);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_timer_stop(&fabric->delay_timer);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_auth(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_AUTH_FAILED:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth_failed);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_AUTH_SUCCESS:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\r\nbfa_fcs_fabric_notify_online(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_PERF_EVFP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_evfp);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nvoid\r\nbfa_fcs_fabric_sm_auth_failed(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_fcs_fabric_notify_offline(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nvoid\r\nbfa_fcs_fabric_sm_loopback(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_fcs_fabric_notify_offline(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_nofabric(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbfa_fcs_fabric_notify_offline(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_NO_FABRIC:\r\nbfa_trc(fabric->fcs, fabric->bb_credit);\r\nbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\r\nfabric->bb_credit);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_RETRY_OP:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nvoid\r\nbfa_fcs_fabric_sm_online(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\r\nif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP) {\r\nbfa_fcs_lport_offline(&fabric->bport);\r\n} else {\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbfa_fcs_fabric_notify_offline(fabric);\r\n}\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_DELETE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\r\nbfa_fcs_fabric_delete(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_STOP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_stopping);\r\nbfa_fcs_fabric_stop(fabric);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_AUTH_FAILED:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth_failed);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_AUTH_SUCCESS:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_evfp(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_CONT_OP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_evfp_done);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_ISOLATE:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_isolated);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_evfp_done(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_isolated(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)fabric->fcs->bfad;\r\nchar pwwn_ptr[BFA_STRING_32];\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nwwn2str(pwwn_ptr, fabric->bport.port_cfg.pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Port is isolated due to VF_ID mismatch. "\r\n"PWWN: %s Port VF_ID: %04x switch port VF_ID: %04x.",\r\npwwn_ptr, fabric->fcs->port_vfid,\r\nfabric->event_arg.swp_vfid);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_deleting(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_DELCOMP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_uninit);\r\nbfa_wc_down(&fabric->fcs->wc);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_UP:\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbfa_fcs_fabric_notify_offline(fabric);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_stopping(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_STOPCOMP:\r\nif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP) {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\r\n} else {\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\r\nbfa_sm_send_event(fabric->lps, BFA_LPS_SM_LOGOUT);\r\n}\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_UP:\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP)\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\r\nelse\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_sm_cleanup(struct bfa_fcs_fabric_s *fabric,\r\nenum bfa_fcs_fabric_event event)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_FABRIC_SM_STOPCOMP:\r\ncase BFA_FCS_FABRIC_SM_LOGOCOMP:\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\r\nbfa_wc_down(&(fabric->fcs)->wc);\r\nbreak;\r\ncase BFA_FCS_FABRIC_SM_LINK_DOWN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fabric->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_init(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\r\nport_cfg->roles = BFA_LPORT_ROLE_FCP_IM;\r\nport_cfg->nwwn = fabric->fcs->bfa->ioc.attr->nwwn;\r\nport_cfg->pwwn = fabric->fcs->bfa->ioc.attr->pwwn;\r\n}\r\nvoid\r\nbfa_fcs_fabric_psymb_init(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\r\nchar model[BFA_ADAPTER_MODEL_NAME_LEN] = {0};\r\nstruct bfa_fcs_driver_info_s *driver_info = &fabric->fcs->driver_info;\r\nbfa_ioc_get_adapter_model(&fabric->fcs->bfa->ioc, model);\r\nstrncpy((char *)&port_cfg->sym_name, model,\r\nBFA_FCS_PORT_SYMBNAME_MODEL_SZ);\r\nstrncat((char *)&port_cfg->sym_name, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nstrncat((char *)&port_cfg->sym_name, (char *)driver_info->version,\r\nBFA_FCS_PORT_SYMBNAME_VERSION_SZ);\r\nstrncat((char *)&port_cfg->sym_name, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nstrncat((char *)&port_cfg->sym_name,\r\n(char *)driver_info->host_machine_name,\r\nBFA_FCS_PORT_SYMBNAME_MACHINENAME_SZ);\r\nstrncat((char *)&port_cfg->sym_name, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nif (driver_info->host_os_patch[0] == '\0') {\r\nstrncat((char *)&port_cfg->sym_name,\r\n(char *)driver_info->host_os_name,\r\nBFA_FCS_OS_STR_LEN);\r\nstrncat((char *)&port_cfg->sym_name,\r\nBFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\n} else {\r\nstrncat((char *)&port_cfg->sym_name,\r\n(char *)driver_info->host_os_name,\r\nBFA_FCS_PORT_SYMBNAME_OSINFO_SZ);\r\nstrncat((char *)&port_cfg->sym_name,\r\nBFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nstrncat((char *)&port_cfg->sym_name,\r\n(char *)driver_info->host_os_patch,\r\nBFA_FCS_PORT_SYMBNAME_OSPATCH_SZ);\r\n}\r\nport_cfg->sym_name.symname[BFA_SYMNAME_MAXLEN - 1] = 0;\r\n}\r\nvoid\r\nbfa_fcs_fabric_nsymb_init(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\r\nchar model[BFA_ADAPTER_MODEL_NAME_LEN] = {0};\r\nstruct bfa_fcs_driver_info_s *driver_info = &fabric->fcs->driver_info;\r\nbfa_ioc_get_adapter_model(&fabric->fcs->bfa->ioc, model);\r\nstrncpy((char *)&port_cfg->node_sym_name, model,\r\nBFA_FCS_PORT_SYMBNAME_MODEL_SZ);\r\nstrncat((char *)&port_cfg->node_sym_name,\r\nBFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nstrncat((char *)&port_cfg->node_sym_name, (char *)driver_info->version,\r\nBFA_FCS_PORT_SYMBNAME_VERSION_SZ);\r\nstrncat((char *)&port_cfg->node_sym_name,\r\nBFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nstrncat((char *)&port_cfg->node_sym_name,\r\n(char *)driver_info->host_machine_name,\r\nBFA_FCS_PORT_SYMBNAME_MACHINENAME_SZ);\r\nstrncat((char *)&port_cfg->node_sym_name,\r\nBFA_FCS_PORT_SYMBNAME_SEPARATOR,\r\nsizeof(BFA_FCS_PORT_SYMBNAME_SEPARATOR));\r\nport_cfg->node_sym_name.symname[BFA_SYMNAME_MAXLEN - 1] = 0;\r\n}\r\nvoid\r\nbfa_cb_lps_flogi_comp(void *bfad, void *uarg, bfa_status_t status)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = uarg;\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_trc(fabric->fcs, status);\r\nswitch (status) {\r\ncase BFA_STATUS_OK:\r\nfabric->stats.flogi_accepts++;\r\nbreak;\r\ncase BFA_STATUS_INVALID_MAC:\r\nfabric->stats.flogi_acc_err++;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\r\nreturn;\r\ncase BFA_STATUS_EPROTOCOL:\r\nswitch (fabric->lps->ext_status) {\r\ncase BFA_EPROTO_BAD_ACCEPT:\r\nfabric->stats.flogi_acc_err++;\r\nbreak;\r\ncase BFA_EPROTO_UNKNOWN_RSP:\r\nfabric->stats.flogi_unknown_rsp++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\r\nreturn;\r\ncase BFA_STATUS_FABRIC_RJT:\r\nfabric->stats.flogi_rejects++;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\r\nreturn;\r\ndefault:\r\nfabric->stats.flogi_rsp_err++;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\r\nreturn;\r\n}\r\nfabric->bb_credit = fabric->lps->pr_bbcred;\r\nbfa_trc(fabric->fcs, fabric->bb_credit);\r\nif (!(fabric->lps->brcd_switch))\r\nfabric->fabric_name = fabric->lps->pr_nwwn;\r\nif (fabric->lps->fport) {\r\nfabric->bport.pid = fabric->lps->lp_pid;\r\nfabric->is_npiv = fabric->lps->npiv_en;\r\nfabric->is_auth = fabric->lps->auth_req;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_CONT_OP);\r\n} else {\r\nfabric->bport.port_topo.pn2n.rem_port_wwn =\r\nfabric->lps->pr_pwwn;\r\nfabric->fab_type = BFA_FCS_FABRIC_N2N;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_NO_FABRIC);\r\n}\r\nbfa_trc(fabric->fcs, fabric->bport.pid);\r\nbfa_trc(fabric->fcs, fabric->is_npiv);\r\nbfa_trc(fabric->fcs, fabric->is_auth);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_login(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nstruct bfa_lport_cfg_s *pcfg = &fabric->bport.port_cfg;\r\nu8 alpa = 0;\r\nbfa_lps_flogi(fabric->lps, fabric, alpa, bfa_fcport_get_maxfrsize(bfa),\r\npcfg->pwwn, pcfg->nwwn, fabric->auth_reqd);\r\nfabric->stats.flogi_sent++;\r\n}\r\nstatic void\r\nbfa_fcs_fabric_notify_online(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe, *qen;\r\nbfa_trc(fabric->fcs, fabric->fabric_name);\r\nbfa_fcs_fabric_set_opertype(fabric);\r\nfabric->stats.fabric_onlines++;\r\nbfa_fcs_lport_online(&fabric->bport);\r\nlist_for_each_safe(qe, qen, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nbfa_fcs_vport_online(vport);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_notify_offline(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe, *qen;\r\nbfa_trc(fabric->fcs, fabric->fabric_name);\r\nfabric->stats.fabric_offlines++;\r\nlist_for_each_safe(qe, qen, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nbfa_fcs_vport_offline(vport);\r\n}\r\nbfa_fcs_lport_offline(&fabric->bport);\r\nfabric->fabric_name = 0;\r\nfabric->fabric_ip_addr[0] = 0;\r\n}\r\nstatic void\r\nbfa_fcs_fabric_delay(void *cbarg)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = cbarg;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_DELAYED);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_stop(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe, *qen;\r\nbfa_wc_init(&fabric->stop_wc, bfa_fcs_fabric_stop_comp, fabric);\r\nlist_for_each_safe(qe, qen, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nbfa_wc_up(&fabric->stop_wc);\r\nbfa_fcs_vport_fcs_stop(vport);\r\n}\r\nbfa_wc_up(&fabric->stop_wc);\r\nbfa_fcs_lport_stop(&fabric->bport);\r\nbfa_wc_wait(&fabric->stop_wc);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_delete(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nbfa_fcs_vport_fcs_delete(vport);\r\n}\r\nbfa_fcs_lport_delete(&fabric->bport);\r\nbfa_wc_wait(&fabric->wc);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_delete_comp(void *cbarg)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = cbarg;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_DELCOMP);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_stop_comp(void *cbarg)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = cbarg;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_STOPCOMP);\r\n}\r\nvoid\r\nbfa_fcs_fabric_modstop(struct bfa_fcs_s *fcs)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric;\r\nbfa_trc(fcs, 0);\r\nfabric = &fcs->fabric;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_STOP);\r\n}\r\nvoid\r\nbfa_fcs_fabric_modstart(struct bfa_fcs_s *fcs)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric;\r\nbfa_trc(fcs, 0);\r\nfabric = &fcs->fabric;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_START);\r\n}\r\nvoid\r\nbfa_fcs_fabric_link_up(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LINK_UP);\r\n}\r\nvoid\r\nbfa_fcs_fabric_link_down(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LINK_DOWN);\r\n}\r\nvoid\r\nbfa_fcs_fabric_addvport(struct bfa_fcs_fabric_s *fabric,\r\nstruct bfa_fcs_vport_s *vport)\r\n{\r\nbfa_trc(fabric->fcs, fabric->vf_id);\r\nlist_add_tail(&vport->qe, &fabric->vport_q);\r\nfabric->num_vports++;\r\nbfa_wc_up(&fabric->wc);\r\n}\r\nvoid\r\nbfa_fcs_fabric_delvport(struct bfa_fcs_fabric_s *fabric,\r\nstruct bfa_fcs_vport_s *vport)\r\n{\r\nlist_del(&vport->qe);\r\nfabric->num_vports--;\r\nbfa_wc_down(&fabric->wc);\r\n}\r\nstruct bfa_fcs_vport_s *\r\nbfa_fcs_fabric_vport_lookup(struct bfa_fcs_fabric_s *fabric, wwn_t pwwn)\r\n{\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nif (bfa_fcs_lport_get_pwwn(&vport->lport) == pwwn)\r\nreturn vport;\r\n}\r\nreturn NULL;\r\n}\r\nu16\r\nbfa_fcs_fabric_get_switch_oui(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nwwn_t fab_nwwn;\r\nu8 *tmp;\r\nu16 oui;\r\nfab_nwwn = fabric->lps->pr_nwwn;\r\ntmp = (u8 *)&fab_nwwn;\r\noui = (tmp[3] << 8) | tmp[4];\r\nreturn oui;\r\n}\r\nvoid\r\nbfa_fcs_fabric_uf_recv(struct bfa_fcs_fabric_s *fabric, struct fchs_s *fchs,\r\nu16 len)\r\n{\r\nu32 pid = fchs->d_id;\r\nstruct bfa_fcs_vport_s *vport;\r\nstruct list_head *qe;\r\nstruct fc_els_cmd_s *els_cmd = (struct fc_els_cmd_s *) (fchs + 1);\r\nstruct fc_logi_s *flogi = (struct fc_logi_s *) els_cmd;\r\nbfa_trc(fabric->fcs, len);\r\nbfa_trc(fabric->fcs, pid);\r\nif ((pid == bfa_ntoh3b(FC_FABRIC_PORT)) &&\r\n(els_cmd->els_code == FC_ELS_FLOGI) &&\r\n(flogi->port_name == bfa_fcs_lport_get_pwwn(&fabric->bport))) {\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LOOPBACK);\r\nreturn;\r\n}\r\nif (fchs->d_id == bfa_hton3b(FC_FABRIC_PORT)) {\r\nbfa_trc(fabric->fcs, pid);\r\nbfa_fcs_fabric_process_uf(fabric, fchs, len);\r\nreturn;\r\n}\r\nif (fabric->bport.pid == pid) {\r\nbfa_trc(fabric->fcs, els_cmd->els_code);\r\nif (els_cmd->els_code == FC_ELS_AUTH) {\r\nbfa_trc(fabric->fcs, els_cmd->els_code);\r\nreturn;\r\n}\r\nbfa_trc(fabric->fcs, *(u8 *) ((u8 *) fchs));\r\nbfa_fcs_lport_uf_recv(&fabric->bport, fchs, len);\r\nreturn;\r\n}\r\nlist_for_each(qe, &fabric->vport_q) {\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nif (vport->lport.pid == pid) {\r\nbfa_fcs_lport_uf_recv(&vport->lport, fchs, len);\r\nreturn;\r\n}\r\n}\r\nif (!bfa_fcs_fabric_is_switched(fabric))\r\nbfa_fcs_lport_uf_recv(&fabric->bport, fchs, len);\r\nbfa_trc(fabric->fcs, fchs->type);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_process_uf(struct bfa_fcs_fabric_s *fabric, struct fchs_s *fchs,\r\nu16 len)\r\n{\r\nstruct fc_els_cmd_s *els_cmd = (struct fc_els_cmd_s *) (fchs + 1);\r\nbfa_trc(fabric->fcs, els_cmd->els_code);\r\nswitch (els_cmd->els_code) {\r\ncase FC_ELS_FLOGI:\r\nbfa_fcs_fabric_process_flogi(fabric, fchs, len);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_fabric_process_flogi(struct bfa_fcs_fabric_s *fabric,\r\nstruct fchs_s *fchs, u16 len)\r\n{\r\nstruct fc_logi_s *flogi = (struct fc_logi_s *) (fchs + 1);\r\nstruct bfa_fcs_lport_s *bport = &fabric->bport;\r\nbfa_trc(fabric->fcs, fchs->s_id);\r\nfabric->stats.flogi_rcvd++;\r\nif (flogi->csp.port_type) {\r\nbfa_trc(fabric->fcs, flogi->port_name);\r\nfabric->stats.flogi_rejected++;\r\nreturn;\r\n}\r\nfabric->bb_credit = be16_to_cpu(flogi->csp.bbcred);\r\nbport->port_topo.pn2n.rem_port_wwn = flogi->port_name;\r\nbport->port_topo.pn2n.reply_oxid = fchs->ox_id;\r\nbfa_fcs_fabric_send_flogi_acc(fabric);\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_NO_FABRIC);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_send_flogi_acc(struct bfa_fcs_fabric_s *fabric)\r\n{\r\nstruct bfa_lport_cfg_s *pcfg = &fabric->bport.port_cfg;\r\nstruct bfa_fcs_lport_n2n_s *n2n_port = &fabric->bport.port_topo.pn2n;\r\nstruct bfa_s *bfa = fabric->fcs->bfa;\r\nstruct bfa_fcxp_s *fcxp;\r\nu16 reqlen;\r\nstruct fchs_s fchs;\r\nfcxp = bfa_fcs_fcxp_alloc(fabric->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nreqlen = fc_flogi_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nbfa_hton3b(FC_FABRIC_PORT),\r\nn2n_port->reply_oxid, pcfg->pwwn,\r\npcfg->nwwn,\r\nbfa_fcport_get_maxfrsize(bfa),\r\nbfa_fcport_get_rx_bbcredit(bfa), 0);\r\nbfa_fcxp_send(fcxp, NULL, fabric->vf_id, fabric->lps->bfa_tag,\r\nBFA_FALSE, FC_CLASS_3,\r\nreqlen, &fchs, bfa_fcs_fabric_flogiacc_comp, fabric,\r\nFC_MAX_PDUSZ, 0);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_flogiacc_comp(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rspfchs)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = cbarg;\r\nbfa_trc(fabric->fcs, status);\r\n}\r\nstatic void\r\nbfa_fcs_fabric_aen_post(struct bfa_fcs_lport_s *port,\r\nenum bfa_port_aen_event event)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)port->fabric->fcs->bfad;\r\nstruct bfa_aen_entry_s *aen_entry;\r\nbfad_get_aen_entry(bfad, aen_entry);\r\nif (!aen_entry)\r\nreturn;\r\naen_entry->aen_data.port.pwwn = bfa_fcs_lport_get_pwwn(port);\r\naen_entry->aen_data.port.fwwn = bfa_fcs_lport_get_fabric_name(port);\r\nbfad_im_post_vendor_event(aen_entry, bfad, ++port->fcs->fcs_aen_seq,\r\nBFA_AEN_CAT_PORT, event);\r\n}\r\nvoid\r\nbfa_fcs_fabric_set_fabric_name(struct bfa_fcs_fabric_s *fabric,\r\nwwn_t fabric_name)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)fabric->fcs->bfad;\r\nchar pwwn_ptr[BFA_STRING_32];\r\nchar fwwn_ptr[BFA_STRING_32];\r\nbfa_trc(fabric->fcs, fabric_name);\r\nif (fabric->fabric_name == 0) {\r\nfabric->fabric_name = fabric_name;\r\n} else {\r\nfabric->fabric_name = fabric_name;\r\nwwn2str(pwwn_ptr, bfa_fcs_lport_get_pwwn(&fabric->bport));\r\nwwn2str(fwwn_ptr,\r\nbfa_fcs_lport_get_fabric_name(&fabric->bport));\r\nBFA_LOG(KERN_WARNING, bfad, bfa_log_level,\r\n"Base port WWN = %s Fabric WWN = %s\n",\r\npwwn_ptr, fwwn_ptr);\r\nbfa_fcs_fabric_aen_post(&fabric->bport,\r\nBFA_PORT_AEN_FABRIC_NAME_CHANGE);\r\n}\r\n}\r\nvoid\r\nbfa_cb_lps_flogo_comp(void *bfad, void *uarg)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = uarg;\r\nbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LOGOCOMP);\r\n}\r\nbfa_fcs_vf_t *\r\nbfa_fcs_vf_lookup(struct bfa_fcs_s *fcs, u16 vf_id)\r\n{\r\nbfa_trc(fcs, vf_id);\r\nif (vf_id == FC_VF_ID_NULL)\r\nreturn &fcs->fabric;\r\nreturn NULL;\r\n}\r\nvoid\r\nbfa_fcs_vf_get_ports(bfa_fcs_vf_t *vf, wwn_t lpwwn[], int *nlports)\r\n{\r\nstruct list_head *qe;\r\nstruct bfa_fcs_vport_s *vport;\r\nint i = 0;\r\nstruct bfa_fcs_s *fcs;\r\nif (vf == NULL || lpwwn == NULL || *nlports == 0)\r\nreturn;\r\nfcs = vf->fcs;\r\nbfa_trc(fcs, vf->vf_id);\r\nbfa_trc(fcs, (uint32_t) *nlports);\r\nlpwwn[i++] = vf->bport.port_cfg.pwwn;\r\nlist_for_each(qe, &vf->vport_q) {\r\nif (i >= *nlports)\r\nbreak;\r\nvport = (struct bfa_fcs_vport_s *) qe;\r\nlpwwn[i++] = vport->lport.port_cfg.pwwn;\r\n}\r\nbfa_trc(fcs, i);\r\n*nlports = i;\r\n}\r\nstatic void\r\nbfa_fcs_port_event_handler(void *cbarg, enum bfa_port_linkstate event)\r\n{\r\nstruct bfa_fcs_s *fcs = cbarg;\r\nbfa_trc(fcs, event);\r\nswitch (event) {\r\ncase BFA_PORT_LINKUP:\r\nbfa_fcs_fabric_link_up(&fcs->fabric);\r\nbreak;\r\ncase BFA_PORT_LINKDOWN:\r\nbfa_fcs_fabric_link_down(&fcs->fabric);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_uf_recv(void *cbarg, struct bfa_uf_s *uf)\r\n{\r\nstruct bfa_fcs_s *fcs = (struct bfa_fcs_s *) cbarg;\r\nstruct fchs_s *fchs = bfa_uf_get_frmbuf(uf);\r\nu16 len = bfa_uf_get_frmlen(uf);\r\nstruct fc_vft_s *vft;\r\nstruct bfa_fcs_fabric_s *fabric;\r\nif (fchs->routing == FC_RTG_EXT_HDR &&\r\nfchs->cat_info == FC_CAT_VFT_HDR) {\r\nbfa_stats(fcs, uf.tagged);\r\nvft = bfa_uf_get_frmbuf(uf);\r\nif (fcs->port_vfid == vft->vf_id)\r\nfabric = &fcs->fabric;\r\nelse\r\nfabric = bfa_fcs_vf_lookup(fcs, (u16) vft->vf_id);\r\nif (!fabric) {\r\nWARN_ON(1);\r\nbfa_stats(fcs, uf.vfid_unknown);\r\nbfa_uf_free(uf);\r\nreturn;\r\n}\r\nfchs = (struct fchs_s *) (vft + 1);\r\nlen -= sizeof(struct fc_vft_s);\r\nbfa_trc(fcs, vft->vf_id);\r\n} else {\r\nbfa_stats(fcs, uf.untagged);\r\nfabric = &fcs->fabric;\r\n}\r\nbfa_trc(fcs, ((u32 *) fchs)[0]);\r\nbfa_trc(fcs, ((u32 *) fchs)[1]);\r\nbfa_trc(fcs, ((u32 *) fchs)[2]);\r\nbfa_trc(fcs, ((u32 *) fchs)[3]);\r\nbfa_trc(fcs, ((u32 *) fchs)[4]);\r\nbfa_trc(fcs, ((u32 *) fchs)[5]);\r\nbfa_trc(fcs, len);\r\nbfa_fcs_fabric_uf_recv(fabric, fchs, len);\r\nbfa_uf_free(uf);\r\n}\r\nvoid\r\nbfa_fcs_attach(struct bfa_fcs_s *fcs, struct bfa_s *bfa, struct bfad_s *bfad,\r\nbfa_boolean_t min_cfg)\r\n{\r\nstruct bfa_fcs_fabric_s *fabric = &fcs->fabric;\r\nfcs->bfa = bfa;\r\nfcs->bfad = bfad;\r\nfcs->min_cfg = min_cfg;\r\nfcs->num_rport_logins = 0;\r\nbfa->fcs = BFA_TRUE;\r\nfcbuild_init();\r\nbfa_fcport_event_register(fcs->bfa, bfa_fcs_port_event_handler, fcs);\r\nbfa_uf_recv_register(fcs->bfa, bfa_fcs_uf_recv, fcs);\r\nmemset(fabric, 0, sizeof(struct bfa_fcs_fabric_s));\r\nfabric->fcs = fcs;\r\nINIT_LIST_HEAD(&fabric->vport_q);\r\nINIT_LIST_HEAD(&fabric->vf_q);\r\nfabric->lps = bfa_lps_alloc(fcs->bfa);\r\nWARN_ON(!fabric->lps);\r\nbfa_wc_init(&fabric->wc, bfa_fcs_fabric_delete_comp, fabric);\r\nbfa_wc_up(&fabric->wc);\r\nbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_uninit);\r\nbfa_fcs_lport_attach(&fabric->bport, fabric->fcs, FC_VF_ID_NULL, NULL);\r\n}

static int iwch_finish_mem_reg(struct iwch_mr *mhp, u32 stag)\r\n{\r\nu32 mmid;\r\nmhp->attr.state = 1;\r\nmhp->attr.stag = stag;\r\nmmid = stag >> 8;\r\nmhp->ibmr.rkey = mhp->ibmr.lkey = stag;\r\npr_debug("%s mmid 0x%x mhp %p\n", __func__, mmid, mhp);\r\nreturn insert_handle(mhp->rhp, &mhp->rhp->mmidr, mhp, mmid);\r\n}\r\nint iwch_register_mem(struct iwch_dev *rhp, struct iwch_pd *php,\r\nstruct iwch_mr *mhp, int shift)\r\n{\r\nu32 stag;\r\nint ret;\r\nif (cxio_register_phys_mem(&rhp->rdev,\r\n&stag, mhp->attr.pdid,\r\nmhp->attr.perms,\r\nmhp->attr.zbva,\r\nmhp->attr.va_fbo,\r\nmhp->attr.len,\r\nshift - 12,\r\nmhp->attr.pbl_size, mhp->attr.pbl_addr))\r\nreturn -ENOMEM;\r\nret = iwch_finish_mem_reg(mhp, stag);\r\nif (ret)\r\ncxio_dereg_mem(&rhp->rdev, mhp->attr.stag, mhp->attr.pbl_size,\r\nmhp->attr.pbl_addr);\r\nreturn ret;\r\n}\r\nint iwch_alloc_pbl(struct iwch_mr *mhp, int npages)\r\n{\r\nmhp->attr.pbl_addr = cxio_hal_pblpool_alloc(&mhp->rhp->rdev,\r\nnpages << 3);\r\nif (!mhp->attr.pbl_addr)\r\nreturn -ENOMEM;\r\nmhp->attr.pbl_size = npages;\r\nreturn 0;\r\n}\r\nvoid iwch_free_pbl(struct iwch_mr *mhp)\r\n{\r\ncxio_hal_pblpool_free(&mhp->rhp->rdev, mhp->attr.pbl_addr,\r\nmhp->attr.pbl_size << 3);\r\n}\r\nint iwch_write_pbl(struct iwch_mr *mhp, __be64 *pages, int npages, int offset)\r\n{\r\nreturn cxio_write_pbl(&mhp->rhp->rdev, pages,\r\nmhp->attr.pbl_addr + (offset << 3), npages);\r\n}

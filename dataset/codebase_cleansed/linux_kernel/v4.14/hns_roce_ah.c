struct ib_ah *hns_roce_create_ah(struct ib_pd *ibpd,\r\nstruct rdma_ah_attr *ah_attr,\r\nstruct ib_udata *udata)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibpd->device);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct ib_gid_attr gid_attr;\r\nstruct hns_roce_ah *ah;\r\nu16 vlan_tag = 0xffff;\r\nstruct in6_addr in6;\r\nconst struct ib_global_route *grh = rdma_ah_read_grh(ah_attr);\r\nunion ib_gid sgid;\r\nint ret;\r\nah = kzalloc(sizeof(*ah), GFP_ATOMIC);\r\nif (!ah)\r\nreturn ERR_PTR(-ENOMEM);\r\nmemcpy(&in6, grh->dgid.raw, sizeof(grh->dgid.raw));\r\nif (rdma_is_multicast_addr(&in6)) {\r\nrdma_get_mcast_mac(&in6, ah->av.mac);\r\n} else {\r\nu8 *dmac = rdma_ah_retrieve_dmac(ah_attr);\r\nif (!dmac) {\r\nkfree(ah);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nmemcpy(ah->av.mac, dmac, ETH_ALEN);\r\n}\r\nret = ib_get_cached_gid(ibpd->device, rdma_ah_get_port_num(ah_attr),\r\ngrh->sgid_index, &sgid, &gid_attr);\r\nif (ret) {\r\ndev_err(dev, "get sgid failed! ret = %d\n", ret);\r\nkfree(ah);\r\nreturn ERR_PTR(ret);\r\n}\r\nif (gid_attr.ndev) {\r\nif (is_vlan_dev(gid_attr.ndev))\r\nvlan_tag = vlan_dev_vlan_id(gid_attr.ndev);\r\ndev_put(gid_attr.ndev);\r\n}\r\nif (vlan_tag < 0x1000)\r\nvlan_tag |= (rdma_ah_get_sl(ah_attr) &\r\nHNS_ROCE_VLAN_SL_BIT_MASK) <<\r\nHNS_ROCE_VLAN_SL_SHIFT;\r\nah->av.port_pd = cpu_to_be32(to_hr_pd(ibpd)->pdn |\r\n(rdma_ah_get_port_num(ah_attr) <<\r\nHNS_ROCE_PORT_NUM_SHIFT));\r\nah->av.gid_index = grh->sgid_index;\r\nah->av.vlan = cpu_to_le16(vlan_tag);\r\ndev_dbg(dev, "gid_index = 0x%x,vlan = 0x%x\n", ah->av.gid_index,\r\nah->av.vlan);\r\nif (rdma_ah_get_static_rate(ah_attr))\r\nah->av.stat_rate = IB_RATE_10_GBPS;\r\nmemcpy(ah->av.dgid, grh->dgid.raw, HNS_ROCE_GID_SIZE);\r\nah->av.sl_tclass_flowlabel = cpu_to_le32(rdma_ah_get_sl(ah_attr) <<\r\nHNS_ROCE_SL_SHIFT);\r\nreturn &ah->ibah;\r\n}\r\nint hns_roce_query_ah(struct ib_ah *ibah, struct rdma_ah_attr *ah_attr)\r\n{\r\nstruct hns_roce_ah *ah = to_hr_ah(ibah);\r\nmemset(ah_attr, 0, sizeof(*ah_attr));\r\nrdma_ah_set_sl(ah_attr, (le32_to_cpu(ah->av.sl_tclass_flowlabel) >>\r\nHNS_ROCE_SL_SHIFT));\r\nrdma_ah_set_port_num(ah_attr, (le32_to_cpu(ah->av.port_pd) >>\r\nHNS_ROCE_PORT_NUM_SHIFT));\r\nrdma_ah_set_static_rate(ah_attr, ah->av.stat_rate);\r\nrdma_ah_set_grh(ah_attr, NULL,\r\n(le32_to_cpu(ah->av.sl_tclass_flowlabel) &\r\nHNS_ROCE_FLOW_LABLE_MASK), ah->av.gid_index,\r\nah->av.hop_limit,\r\n(le32_to_cpu(ah->av.sl_tclass_flowlabel) >>\r\nHNS_ROCE_TCLASS_SHIFT));\r\nrdma_ah_set_dgid_raw(ah_attr, ah->av.dgid);\r\nreturn 0;\r\n}\r\nint hns_roce_destroy_ah(struct ib_ah *ah)\r\n{\r\nkfree(to_hr_ah(ah));\r\nreturn 0;\r\n}

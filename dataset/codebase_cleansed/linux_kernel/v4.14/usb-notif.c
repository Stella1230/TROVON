static\r\nint i2400mu_notification_grok(struct i2400mu *i2400mu, const void *buf,\r\nsize_t buf_len)\r\n{\r\nint ret;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nd_fnstart(4, dev, "(i2400m %p buf %p buf_len %zu)\n",\r\ni2400mu, buf, buf_len);\r\nret = -EIO;\r\nif (buf_len < sizeof(i2400m_ZERO_BARKER))\r\ngoto error_bad_size;\r\nret = 0;\r\nif (!memcmp(i2400m_ZERO_BARKER, buf, sizeof(i2400m_ZERO_BARKER))) {\r\ni2400mu_rx_kick(i2400mu);\r\ngoto out;\r\n}\r\nret = i2400m_is_boot_barker(i2400m, buf, buf_len);\r\nif (unlikely(ret >= 0))\r\nret = i2400m_dev_reset_handle(i2400m, "device rebooted");\r\nelse\r\ni2400m_unknown_barker(i2400m, buf, buf_len);\r\nerror_bad_size:\r\nout:\r\nd_fnend(4, dev, "(i2400m %p buf %p buf_len %zu) = %d\n",\r\ni2400mu, buf, buf_len, ret);\r\nreturn ret;\r\n}\r\nstatic\r\nvoid i2400mu_notification_cb(struct urb *urb)\r\n{\r\nint ret;\r\nstruct i2400mu *i2400mu = urb->context;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nd_fnstart(4, dev, "(urb %p status %d actual_length %d)\n",\r\nurb, urb->status, urb->actual_length);\r\nret = urb->status;\r\nswitch (ret) {\r\ncase 0:\r\nret = i2400mu_notification_grok(i2400mu, urb->transfer_buffer,\r\nurb->actual_length);\r\nif (ret == -EIO && edc_inc(&i2400mu->urb_edc, EDC_MAX_ERRORS,\r\nEDC_ERROR_TIMEFRAME))\r\ngoto error_exceeded;\r\nif (ret == -ENOMEM)\r\ngoto error_exceeded;\r\nbreak;\r\ncase -EINVAL:\r\ncase -ENODEV:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ncase -ECONNRESET:\r\ngoto out;\r\ndefault:\r\nif (edc_inc(&i2400mu->urb_edc,\r\nEDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME))\r\ngoto error_exceeded;\r\ndev_err(dev, "notification: URB error %d, retrying\n",\r\nurb->status);\r\n}\r\nusb_mark_last_busy(i2400mu->usb_dev);\r\nret = usb_submit_urb(i2400mu->notif_urb, GFP_ATOMIC);\r\nswitch (ret) {\r\ncase 0:\r\ncase -EINVAL:\r\ncase -ENODEV:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ncase -ECONNRESET:\r\nbreak;\r\ndefault:\r\ndev_err(dev, "notification: cannot submit URB: %d\n", ret);\r\ngoto error_submit;\r\n}\r\nd_fnend(4, dev, "(urb %p status %d actual_length %d) = void\n",\r\nurb, urb->status, urb->actual_length);\r\nreturn;\r\nerror_exceeded:\r\ndev_err(dev, "maximum errors in notification URB exceeded; "\r\n"resetting device\n");\r\nerror_submit:\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\nout:\r\nd_fnend(4, dev, "(urb %p status %d actual_length %d) = void\n",\r\nurb, urb->status, urb->actual_length);\r\n}\r\nint i2400mu_notification_setup(struct i2400mu *i2400mu)\r\n{\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nint usb_pipe, ret = 0;\r\nstruct usb_endpoint_descriptor *epd;\r\nchar *buf;\r\nd_fnstart(4, dev, "(i2400m %p)\n", i2400mu);\r\nbuf = kmalloc(I2400MU_MAX_NOTIFICATION_LEN, GFP_KERNEL | GFP_DMA);\r\nif (buf == NULL) {\r\nret = -ENOMEM;\r\ngoto error_buf_alloc;\r\n}\r\ni2400mu->notif_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!i2400mu->notif_urb) {\r\nret = -ENOMEM;\r\ngoto error_alloc_urb;\r\n}\r\nepd = usb_get_epd(i2400mu->usb_iface,\r\ni2400mu->endpoint_cfg.notification);\r\nusb_pipe = usb_rcvintpipe(i2400mu->usb_dev, epd->bEndpointAddress);\r\nusb_fill_int_urb(i2400mu->notif_urb, i2400mu->usb_dev, usb_pipe,\r\nbuf, I2400MU_MAX_NOTIFICATION_LEN,\r\ni2400mu_notification_cb, i2400mu, epd->bInterval);\r\nret = usb_submit_urb(i2400mu->notif_urb, GFP_KERNEL);\r\nif (ret != 0) {\r\ndev_err(dev, "notification: cannot submit URB: %d\n", ret);\r\ngoto error_submit;\r\n}\r\nd_fnend(4, dev, "(i2400m %p) = %d\n", i2400mu, ret);\r\nreturn ret;\r\nerror_submit:\r\nusb_free_urb(i2400mu->notif_urb);\r\nerror_alloc_urb:\r\nkfree(buf);\r\nerror_buf_alloc:\r\nd_fnend(4, dev, "(i2400m %p) = %d\n", i2400mu, ret);\r\nreturn ret;\r\n}\r\nvoid i2400mu_notification_release(struct i2400mu *i2400mu)\r\n{\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nd_fnstart(4, dev, "(i2400mu %p)\n", i2400mu);\r\nif (i2400mu->notif_urb != NULL) {\r\nusb_kill_urb(i2400mu->notif_urb);\r\nkfree(i2400mu->notif_urb->transfer_buffer);\r\nusb_free_urb(i2400mu->notif_urb);\r\ni2400mu->notif_urb = NULL;\r\n}\r\nd_fnend(4, dev, "(i2400mu %p)\n", i2400mu);\r\n}

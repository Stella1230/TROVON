static void icp_opal_teardown_cpu(void)\r\n{\r\nint hw_cpu = hard_smp_processor_id();\r\nopal_int_set_mfrr(hw_cpu, 0xff);\r\n}\r\nstatic void icp_opal_flush_ipi(void)\r\n{\r\nif (opal_int_eoi((0x00 << 24) | XICS_IPI) > 0)\r\nforce_external_irq_replay();\r\n}\r\nstatic unsigned int icp_opal_get_xirr(void)\r\n{\r\nunsigned int kvm_xirr;\r\n__be32 hw_xirr;\r\nint64_t rc;\r\nkvm_xirr = kvmppc_get_xics_latch();\r\nif (kvm_xirr)\r\nreturn kvm_xirr;\r\nrc = opal_int_get_xirr(&hw_xirr, false);\r\nif (rc < 0)\r\nreturn 0;\r\nreturn be32_to_cpu(hw_xirr);\r\n}\r\nstatic unsigned int icp_opal_get_irq(void)\r\n{\r\nunsigned int xirr;\r\nunsigned int vec;\r\nunsigned int irq;\r\nxirr = icp_opal_get_xirr();\r\nvec = xirr & 0x00ffffff;\r\nif (vec == XICS_IRQ_SPURIOUS)\r\nreturn 0;\r\nirq = irq_find_mapping(xics_host, vec);\r\nif (likely(irq)) {\r\nxics_push_cppr(vec);\r\nreturn irq;\r\n}\r\nxics_mask_unknown_vec(vec);\r\nif (opal_int_eoi(xirr) > 0)\r\nforce_external_irq_replay();\r\nreturn 0;\r\n}\r\nstatic void icp_opal_set_cpu_priority(unsigned char cppr)\r\n{\r\nif (cppr >= DEFAULT_PRIORITY)\r\ncppr = LOWEST_PRIORITY;\r\nxics_set_base_cppr(cppr);\r\nopal_int_set_cppr(cppr);\r\niosync();\r\n}\r\nstatic void icp_opal_eoi(struct irq_data *d)\r\n{\r\nunsigned int hw_irq = (unsigned int)irqd_to_hwirq(d);\r\nint64_t rc;\r\niosync();\r\nrc = opal_int_eoi((xics_pop_cppr() << 24) | hw_irq);\r\nif (rc > 0)\r\nforce_external_irq_replay();\r\n}\r\nstatic void icp_opal_cause_ipi(int cpu)\r\n{\r\nint hw_cpu = get_hard_smp_processor_id(cpu);\r\nkvmppc_set_host_ipi(cpu, 1);\r\nopal_int_set_mfrr(hw_cpu, IPI_PRIORITY);\r\n}\r\nstatic irqreturn_t icp_opal_ipi_action(int irq, void *dev_id)\r\n{\r\nint cpu = smp_processor_id();\r\nkvmppc_set_host_ipi(cpu, 0);\r\nopal_int_set_mfrr(get_hard_smp_processor_id(cpu), 0xff);\r\nreturn smp_ipi_demux();\r\n}\r\nvoid icp_opal_flush_interrupt(void)\r\n{\r\nunsigned int xirr;\r\nunsigned int vec;\r\ndo {\r\nxirr = icp_opal_get_xirr();\r\nvec = xirr & 0x00ffffff;\r\nif (vec == XICS_IRQ_SPURIOUS)\r\nbreak;\r\nif (vec == XICS_IPI) {\r\nint cpu = smp_processor_id();\r\nkvmppc_set_host_ipi(cpu, 0);\r\nopal_int_set_mfrr(get_hard_smp_processor_id(cpu), 0xff);\r\n} else {\r\npr_err("XICS: hw interrupt 0x%x to offline cpu, "\r\n"disabling\n", vec);\r\nxics_mask_unknown_vec(vec);\r\n}\r\n} while (opal_int_eoi(xirr) > 0);\r\n}\r\nint icp_opal_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "ibm,opal-intc");\r\nif (!np)\r\nreturn -ENODEV;\r\nicp_ops = &icp_opal_ops;\r\nprintk("XICS: Using OPAL ICP fallbacks\n");\r\nreturn 0;\r\n}

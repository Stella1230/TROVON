u32\r\nnvbios_volt_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct bit_entry bit_P;\r\nu32 volt = 0;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2)\r\nvolt = nvbios_rd32(bios, bit_P.offset + 0x0c);\r\nelse\r\nif (bit_P.version == 1)\r\nvolt = nvbios_rd32(bios, bit_P.offset + 0x10);\r\nif (volt) {\r\n*ver = nvbios_rd08(bios, volt + 0);\r\nswitch (*ver) {\r\ncase 0x12:\r\n*hdr = 5;\r\n*cnt = nvbios_rd08(bios, volt + 2);\r\n*len = nvbios_rd08(bios, volt + 1);\r\nreturn volt;\r\ncase 0x20:\r\n*hdr = nvbios_rd08(bios, volt + 1);\r\n*cnt = nvbios_rd08(bios, volt + 2);\r\n*len = nvbios_rd08(bios, volt + 3);\r\nreturn volt;\r\ncase 0x30:\r\ncase 0x40:\r\ncase 0x50:\r\n*hdr = nvbios_rd08(bios, volt + 1);\r\n*cnt = nvbios_rd08(bios, volt + 3);\r\n*len = nvbios_rd08(bios, volt + 2);\r\nreturn volt;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_volt_parse(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_volt *info)\r\n{\r\nu32 volt = nvbios_volt_table(bios, ver, hdr, cnt, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!volt * *ver) {\r\ncase 0x12:\r\ninfo->type = NVBIOS_VOLT_GPIO;\r\ninfo->vidmask = nvbios_rd08(bios, volt + 0x04);\r\ninfo->ranged = false;\r\nbreak;\r\ncase 0x20:\r\ninfo->type = NVBIOS_VOLT_GPIO;\r\ninfo->vidmask = nvbios_rd08(bios, volt + 0x05);\r\ninfo->ranged = false;\r\nbreak;\r\ncase 0x30:\r\ninfo->type = NVBIOS_VOLT_GPIO;\r\ninfo->vidmask = nvbios_rd08(bios, volt + 0x04);\r\ninfo->ranged = false;\r\nbreak;\r\ncase 0x40:\r\ninfo->type = NVBIOS_VOLT_GPIO;\r\ninfo->base = nvbios_rd32(bios, volt + 0x04);\r\ninfo->step = nvbios_rd16(bios, volt + 0x08);\r\ninfo->vidmask = nvbios_rd08(bios, volt + 0x0b);\r\ninfo->ranged = true;\r\ninfo->min = min(info->base,\r\ninfo->base + info->step * info->vidmask);\r\ninfo->max = nvbios_rd32(bios, volt + 0x0e);\r\nbreak;\r\ncase 0x50:\r\ninfo->min = nvbios_rd32(bios, volt + 0x0a);\r\ninfo->max = nvbios_rd32(bios, volt + 0x0e);\r\ninfo->base = nvbios_rd32(bios, volt + 0x12) & 0x00ffffff;\r\nif (nvbios_rd32(bios, volt + 0x4) & 1) {\r\ninfo->type = NVBIOS_VOLT_PWM;\r\ninfo->pwm_freq = nvbios_rd32(bios, volt + 0x5) / 1000;\r\ninfo->pwm_range = nvbios_rd32(bios, volt + 0x16);\r\n} else {\r\ninfo->type = NVBIOS_VOLT_GPIO;\r\ninfo->vidmask = nvbios_rd08(bios, volt + 0x06);\r\ninfo->step = nvbios_rd16(bios, volt + 0x16);\r\ninfo->ranged =\r\n!!(nvbios_rd08(bios, volt + 0x4) & 0x2);\r\n}\r\nbreak;\r\n}\r\nreturn volt;\r\n}\r\nu32\r\nnvbios_volt_entry(struct nvkm_bios *bios, int idx, u8 *ver, u8 *len)\r\n{\r\nu8 hdr, cnt;\r\nu32 volt = nvbios_volt_table(bios, ver, &hdr, &cnt, len);\r\nif (volt && idx < cnt) {\r\nvolt = volt + hdr + (idx * *len);\r\nreturn volt;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_volt_entry_parse(struct nvkm_bios *bios, int idx, u8 *ver, u8 *len,\r\nstruct nvbios_volt_entry *info)\r\n{\r\nu32 volt = nvbios_volt_entry(bios, idx, ver, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!volt * *ver) {\r\ncase 0x12:\r\ncase 0x20:\r\ninfo->voltage = nvbios_rd08(bios, volt + 0x00) * 10000;\r\ninfo->vid = nvbios_rd08(bios, volt + 0x01);\r\nbreak;\r\ncase 0x30:\r\ninfo->voltage = nvbios_rd08(bios, volt + 0x00) * 10000;\r\ninfo->vid = nvbios_rd08(bios, volt + 0x01) >> 2;\r\nbreak;\r\ncase 0x40:\r\nbreak;\r\ncase 0x50:\r\ninfo->voltage = nvbios_rd32(bios, volt) & 0x001fffff;\r\ninfo->vid = (nvbios_rd32(bios, volt) >> 23) & 0xff;\r\nbreak;\r\n}\r\nreturn volt;\r\n}

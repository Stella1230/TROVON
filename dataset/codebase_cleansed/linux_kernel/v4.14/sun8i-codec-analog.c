static int adda_reg_read(void *context, unsigned int reg, unsigned int *val)\r\n{\r\nvoid __iomem *base = (void __iomem *)context;\r\nu32 tmp;\r\nwritel(readl(base) | ADDA_PR_RESET, base);\r\nwritel(readl(base) & ~ADDA_PR_WRITE, base);\r\ntmp = readl(base);\r\ntmp &= ~(ADDA_PR_ADDR_MASK << ADDA_PR_ADDR_SHIFT);\r\ntmp |= (reg & ADDA_PR_ADDR_MASK) << ADDA_PR_ADDR_SHIFT;\r\nwritel(tmp, base);\r\n*val = readl(base) & ADDA_PR_DATA_OUT_MASK;\r\nreturn 0;\r\n}\r\nstatic int adda_reg_write(void *context, unsigned int reg, unsigned int val)\r\n{\r\nvoid __iomem *base = (void __iomem *)context;\r\nu32 tmp;\r\nwritel(readl(base) | ADDA_PR_RESET, base);\r\ntmp = readl(base);\r\ntmp &= ~(ADDA_PR_ADDR_MASK << ADDA_PR_ADDR_SHIFT);\r\ntmp |= (reg & ADDA_PR_ADDR_MASK) << ADDA_PR_ADDR_SHIFT;\r\nwritel(tmp, base);\r\ntmp = readl(base);\r\ntmp &= ~(ADDA_PR_DATA_IN_MASK << ADDA_PR_DATA_IN_SHIFT);\r\ntmp |= (val & ADDA_PR_DATA_IN_MASK) << ADDA_PR_DATA_IN_SHIFT;\r\nwritel(tmp, base);\r\nwritel(readl(base) | ADDA_PR_WRITE, base);\r\nwritel(readl(base) & ~ADDA_PR_WRITE, base);\r\nreturn 0;\r\n}\r\nstatic int sun8i_headphone_amp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct snd_soc_component *component = snd_soc_dapm_to_component(w->dapm);\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\nsnd_soc_component_update_bits(component, SUN8I_ADDA_PAEN_HP_CTRL,\r\nBIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN),\r\nBIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN));\r\nmsleep(700);\r\n} else if (SND_SOC_DAPM_EVENT_OFF(event)) {\r\nsnd_soc_component_update_bits(component, SUN8I_ADDA_PAEN_HP_CTRL,\r\nBIT(SUN8I_ADDA_PAEN_HP_CTRL_HPPAEN),\r\n0x0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_add_headphone(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_add_component_controls(cmpnt,\r\nsun8i_codec_headphone_controls,\r\nARRAY_SIZE(sun8i_codec_headphone_controls));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Headphone controls: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_headphone_widgets,\r\nARRAY_SIZE(sun8i_codec_headphone_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Headphone DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, sun8i_codec_headphone_routes,\r\nARRAY_SIZE(sun8i_codec_headphone_routes));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Headphone DAPM routes: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_add_mbias(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_mbias_widgets,\r\nARRAY_SIZE(sun8i_codec_mbias_widgets));\r\nif (ret)\r\ndev_err(dev, "Failed to add MBIAS DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int sun8i_codec_add_hmic(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_hmic_widgets,\r\nARRAY_SIZE(sun8i_codec_hmic_widgets));\r\nif (ret)\r\ndev_err(dev, "Failed to add Mic3 DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int sun8i_codec_add_linein(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_add_component_controls(cmpnt,\r\nsun8i_codec_linein_controls,\r\nARRAY_SIZE(sun8i_codec_linein_controls));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line In controls: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_linein_widgets,\r\nARRAY_SIZE(sun8i_codec_linein_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line In DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, sun8i_codec_linein_routes,\r\nARRAY_SIZE(sun8i_codec_linein_routes));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line In DAPM routes: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_add_lineout(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_add_component_controls(cmpnt,\r\nsun8i_codec_lineout_controls,\r\nARRAY_SIZE(sun8i_codec_lineout_controls));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line Out controls: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_lineout_widgets,\r\nARRAY_SIZE(sun8i_codec_lineout_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line Out DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, sun8i_codec_lineout_routes,\r\nARRAY_SIZE(sun8i_codec_lineout_routes));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Line Out DAPM routes: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_add_mic2(struct snd_soc_component *cmpnt)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nret = snd_soc_add_component_controls(cmpnt,\r\nsun8i_codec_mic2_controls,\r\nARRAY_SIZE(sun8i_codec_mic2_controls));\r\nif (ret) {\r\ndev_err(dev, "Failed to add MIC2 controls: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_new_controls(dapm, sun8i_codec_mic2_widgets,\r\nARRAY_SIZE(sun8i_codec_mic2_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add MIC2 DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, sun8i_codec_mic2_routes,\r\nARRAY_SIZE(sun8i_codec_mic2_routes));\r\nif (ret) {\r\ndev_err(dev, "Failed to add MIC2 DAPM routes: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_analog_add_mixer(struct snd_soc_component *cmpnt,\r\nconst struct sun8i_codec_analog_quirks *quirks)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_component_get_dapm(cmpnt);\r\nstruct device *dev = cmpnt->dev;\r\nint ret;\r\nif (!quirks->has_mic2 && !quirks->has_linein) {\r\nret = snd_soc_dapm_new_controls(dapm,\r\nsun8i_v3s_codec_mixer_widgets,\r\nARRAY_SIZE(sun8i_v3s_codec_mixer_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add V3s Mixer DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\n} else {\r\nret = snd_soc_dapm_new_controls(dapm,\r\nsun8i_codec_mixer_widgets,\r\nARRAY_SIZE(sun8i_codec_mixer_widgets));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Mixer DAPM widgets: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, sun8i_codec_mixer_routes,\r\nARRAY_SIZE(sun8i_codec_mixer_routes));\r\nif (ret) {\r\ndev_err(dev, "Failed to add Mixer DAPM routes: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_analog_cmpnt_probe(struct snd_soc_component *cmpnt)\r\n{\r\nstruct device *dev = cmpnt->dev;\r\nconst struct sun8i_codec_analog_quirks *quirks;\r\nint ret;\r\nquirks = of_device_get_match_data(dev);\r\nret = sun8i_codec_analog_add_mixer(cmpnt, quirks);\r\nif (ret)\r\nreturn ret;\r\nif (quirks->has_headphone) {\r\nret = sun8i_codec_add_headphone(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (quirks->has_hmic) {\r\nret = sun8i_codec_add_hmic(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (quirks->has_linein) {\r\nret = sun8i_codec_add_linein(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (quirks->has_lineout) {\r\nret = sun8i_codec_add_lineout(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (quirks->has_mbias) {\r\nret = sun8i_codec_add_mbias(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (quirks->has_mic2) {\r\nret = sun8i_codec_add_mic2(cmpnt);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun8i_codec_analog_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct regmap *regmap;\r\nvoid __iomem *base;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base)) {\r\ndev_err(&pdev->dev, "Failed to map the registers\n");\r\nreturn PTR_ERR(base);\r\n}\r\nregmap = devm_regmap_init(&pdev->dev, NULL, base, &adda_pr_regmap_cfg);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&pdev->dev, "Failed to create regmap\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nreturn devm_snd_soc_register_component(&pdev->dev,\r\n&sun8i_codec_analog_cmpnt_drv,\r\nNULL, 0);\r\n}

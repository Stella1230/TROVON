static int meson_reset_reset(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct meson_reset *data =\r\ncontainer_of(rcdev, struct meson_reset, rcdev);\r\nunsigned int bank = id / BITS_PER_REG;\r\nunsigned int offset = id % BITS_PER_REG;\r\nvoid __iomem *reg_addr = data->reg_base + (bank << 2);\r\nif (bank >= REG_COUNT)\r\nreturn -EINVAL;\r\nwritel(BIT(offset), reg_addr);\r\nreturn 0;\r\n}\r\nstatic int meson_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct meson_reset *data;\r\nstruct resource *res;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->reg_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->reg_base))\r\nreturn PTR_ERR(data->reg_base);\r\nplatform_set_drvdata(pdev, data);\r\ndata->rcdev.owner = THIS_MODULE;\r\ndata->rcdev.nr_resets = REG_COUNT * BITS_PER_REG;\r\ndata->rcdev.ops = &meson_reset_ops;\r\ndata->rcdev.of_node = pdev->dev.of_node;\r\nreturn devm_reset_controller_register(&pdev->dev, &data->rcdev);\r\n}

static bool\r\nebt_vlan_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct ebt_vlan_info *info = par->matchinfo;\r\nunsigned short TCI;\r\nunsigned short id;\r\nunsigned char prio;\r\n__be16 encap;\r\nif (skb_vlan_tag_present(skb)) {\r\nTCI = skb_vlan_tag_get(skb);\r\nencap = skb->protocol;\r\n} else {\r\nconst struct vlan_hdr *fp;\r\nstruct vlan_hdr _frame;\r\nfp = skb_header_pointer(skb, 0, sizeof(_frame), &_frame);\r\nif (fp == NULL)\r\nreturn false;\r\nTCI = ntohs(fp->h_vlan_TCI);\r\nencap = fp->h_vlan_encapsulated_proto;\r\n}\r\nid = TCI & VLAN_VID_MASK;\r\nprio = (TCI >> 13) & 0x7;\r\nif (GET_BITMASK(EBT_VLAN_ID))\r\nEXIT_ON_MISMATCH(id, EBT_VLAN_ID);\r\nif (GET_BITMASK(EBT_VLAN_PRIO))\r\nEXIT_ON_MISMATCH(prio, EBT_VLAN_PRIO);\r\nif (GET_BITMASK(EBT_VLAN_ENCAP))\r\nEXIT_ON_MISMATCH(encap, EBT_VLAN_ENCAP);\r\nreturn true;\r\n}\r\nstatic int ebt_vlan_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct ebt_vlan_info *info = par->matchinfo;\r\nconst struct ebt_entry *e = par->entryinfo;\r\nif (e->ethproto != htons(ETH_P_8021Q)) {\r\npr_debug("passed entry proto %2.4X is not 802.1Q (8100)\n",\r\nntohs(e->ethproto));\r\nreturn -EINVAL;\r\n}\r\nif (info->bitmask & ~EBT_VLAN_MASK) {\r\npr_debug("bitmask %2X is out of mask (%2X)\n",\r\ninfo->bitmask, EBT_VLAN_MASK);\r\nreturn -EINVAL;\r\n}\r\nif (info->invflags & ~EBT_VLAN_MASK) {\r\npr_debug("inversion flags %2X is out of mask (%2X)\n",\r\ninfo->invflags, EBT_VLAN_MASK);\r\nreturn -EINVAL;\r\n}\r\nif (GET_BITMASK(EBT_VLAN_ID)) {\r\nif (!!info->id) {\r\nif (info->id > VLAN_N_VID) {\r\npr_debug("id %d is out of range (1-4096)\n",\r\ninfo->id);\r\nreturn -EINVAL;\r\n}\r\ninfo->bitmask &= ~EBT_VLAN_PRIO;\r\n}\r\n}\r\nif (GET_BITMASK(EBT_VLAN_PRIO)) {\r\nif ((unsigned char) info->prio > 7) {\r\npr_debug("prio %d is out of range (0-7)\n",\r\ninfo->prio);\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (GET_BITMASK(EBT_VLAN_ENCAP)) {\r\nif ((unsigned short) ntohs(info->encap) < ETH_ZLEN) {\r\npr_debug("encap frame length %d is less than "\r\n"minimal\n", ntohs(info->encap));\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ebt_vlan_init(void)\r\n{\r\npr_debug("ebtables 802.1Q extension module v" MODULE_VERS "\n");\r\nreturn xt_register_match(&ebt_vlan_mt_reg);\r\n}\r\nstatic void __exit ebt_vlan_fini(void)\r\n{\r\nxt_unregister_match(&ebt_vlan_mt_reg);\r\n}

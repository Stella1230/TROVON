static u32 meson_sm_get_cmd(const struct meson_sm_chip *chip,\r\nunsigned int cmd_index)\r\n{\r\nconst struct meson_sm_cmd *cmd = chip->cmd;\r\nwhile (cmd->smc_id && cmd->index != cmd_index)\r\ncmd++;\r\nreturn cmd->smc_id;\r\n}\r\nstatic u32 __meson_sm_call(u32 cmd, u32 arg0, u32 arg1, u32 arg2,\r\nu32 arg3, u32 arg4)\r\n{\r\nstruct arm_smccc_res res;\r\narm_smccc_smc(cmd, arg0, arg1, arg2, arg3, arg4, 0, 0, &res);\r\nreturn res.a0;\r\n}\r\nstatic void __iomem *meson_sm_map_shmem(u32 cmd_shmem, unsigned int size)\r\n{\r\nu32 sm_phy_base;\r\nsm_phy_base = __meson_sm_call(cmd_shmem, 0, 0, 0, 0, 0);\r\nif (!sm_phy_base)\r\nreturn 0;\r\nreturn ioremap_cache(sm_phy_base, size);\r\n}\r\nint meson_sm_call(unsigned int cmd_index, u32 *ret, u32 arg0,\r\nu32 arg1, u32 arg2, u32 arg3, u32 arg4)\r\n{\r\nu32 cmd, lret;\r\nif (!fw.chip)\r\nreturn -ENOENT;\r\ncmd = meson_sm_get_cmd(fw.chip, cmd_index);\r\nif (!cmd)\r\nreturn -EINVAL;\r\nlret = __meson_sm_call(cmd, arg0, arg1, arg2, arg3, arg4);\r\nif (ret)\r\n*ret = lret;\r\nreturn 0;\r\n}\r\nint meson_sm_call_read(void *buffer, unsigned int bsize, unsigned int cmd_index,\r\nu32 arg0, u32 arg1, u32 arg2, u32 arg3, u32 arg4)\r\n{\r\nu32 size;\r\nint ret;\r\nif (!fw.chip)\r\nreturn -ENOENT;\r\nif (!fw.chip->cmd_shmem_out_base)\r\nreturn -EINVAL;\r\nif (bsize > fw.chip->shmem_size)\r\nreturn -EINVAL;\r\nif (meson_sm_call(cmd_index, &size, arg0, arg1, arg2, arg3, arg4) < 0)\r\nreturn -EINVAL;\r\nif (size > bsize)\r\nreturn -EINVAL;\r\nret = size;\r\nif (!size)\r\nsize = bsize;\r\nif (buffer)\r\nmemcpy(buffer, fw.sm_shmem_out_base, size);\r\nreturn ret;\r\n}\r\nint meson_sm_call_write(void *buffer, unsigned int size, unsigned int cmd_index,\r\nu32 arg0, u32 arg1, u32 arg2, u32 arg3, u32 arg4)\r\n{\r\nu32 written;\r\nif (!fw.chip)\r\nreturn -ENOENT;\r\nif (size > fw.chip->shmem_size)\r\nreturn -EINVAL;\r\nif (!fw.chip->cmd_shmem_in_base)\r\nreturn -EINVAL;\r\nmemcpy(fw.sm_shmem_in_base, buffer, size);\r\nif (meson_sm_call(cmd_index, &written, arg0, arg1, arg2, arg3, arg4) < 0)\r\nreturn -EINVAL;\r\nif (!written)\r\nreturn -EINVAL;\r\nreturn written;\r\n}\r\nint __init meson_sm_init(void)\r\n{\r\nconst struct meson_sm_chip *chip;\r\nconst struct of_device_id *matched_np;\r\nstruct device_node *np;\r\nnp = of_find_matching_node_and_match(NULL, meson_sm_ids, &matched_np);\r\nif (!np)\r\nreturn -ENODEV;\r\nchip = matched_np->data;\r\nif (!chip) {\r\npr_err("unable to setup secure-monitor data\n");\r\ngoto out;\r\n}\r\nif (chip->cmd_shmem_in_base) {\r\nfw.sm_shmem_in_base = meson_sm_map_shmem(chip->cmd_shmem_in_base,\r\nchip->shmem_size);\r\nif (WARN_ON(!fw.sm_shmem_in_base))\r\ngoto out;\r\n}\r\nif (chip->cmd_shmem_out_base) {\r\nfw.sm_shmem_out_base = meson_sm_map_shmem(chip->cmd_shmem_out_base,\r\nchip->shmem_size);\r\nif (WARN_ON(!fw.sm_shmem_out_base))\r\ngoto out_in_base;\r\n}\r\nfw.chip = chip;\r\npr_info("secure-monitor enabled\n");\r\nreturn 0;\r\nout_in_base:\r\niounmap(fw.sm_shmem_in_base);\r\nout:\r\nreturn -EINVAL;\r\n}

static irqreturn_t\r\nsnic_isr_msix_wq(int irq, void *data)\r\n{\r\nstruct snic *snic = data;\r\nunsigned long wq_work_done = 0;\r\nsnic->s_stats.misc.last_isr_time = jiffies;\r\natomic64_inc(&snic->s_stats.misc.ack_isr_cnt);\r\nwq_work_done = snic_wq_cmpl_handler(snic, -1);\r\nsvnic_intr_return_credits(&snic->intr[SNIC_MSIX_WQ],\r\nwq_work_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t\r\nsnic_isr_msix_io_cmpl(int irq, void *data)\r\n{\r\nstruct snic *snic = data;\r\nunsigned long iocmpl_work_done = 0;\r\nsnic->s_stats.misc.last_isr_time = jiffies;\r\natomic64_inc(&snic->s_stats.misc.cmpl_isr_cnt);\r\niocmpl_work_done = snic_fwcq_cmpl_handler(snic, -1);\r\nsvnic_intr_return_credits(&snic->intr[SNIC_MSIX_IO_CMPL],\r\niocmpl_work_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t\r\nsnic_isr_msix_err_notify(int irq, void *data)\r\n{\r\nstruct snic *snic = data;\r\nsnic->s_stats.misc.last_isr_time = jiffies;\r\natomic64_inc(&snic->s_stats.misc.errnotify_isr_cnt);\r\nsvnic_intr_return_all_credits(&snic->intr[SNIC_MSIX_ERR_NOTIFY]);\r\nsnic_log_q_error(snic);\r\nsnic_handle_link_event(snic);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid\r\nsnic_free_intr(struct snic *snic)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(snic->msix); i++) {\r\nif (snic->msix[i].requested) {\r\nfree_irq(pci_irq_vector(snic->pdev, i),\r\nsnic->msix[i].devid);\r\n}\r\n}\r\n}\r\nint\r\nsnic_request_intr(struct snic *snic)\r\n{\r\nint ret = 0, i;\r\nenum vnic_dev_intr_mode intr_mode;\r\nintr_mode = svnic_dev_get_intr_mode(snic->vdev);\r\nSNIC_BUG_ON(intr_mode != VNIC_DEV_INTR_MODE_MSIX);\r\nsprintf(snic->msix[SNIC_MSIX_WQ].devname,\r\n"%.11s-scsi-wq",\r\nsnic->name);\r\nsnic->msix[SNIC_MSIX_WQ].isr = snic_isr_msix_wq;\r\nsnic->msix[SNIC_MSIX_WQ].devid = snic;\r\nsprintf(snic->msix[SNIC_MSIX_IO_CMPL].devname,\r\n"%.11s-io-cmpl",\r\nsnic->name);\r\nsnic->msix[SNIC_MSIX_IO_CMPL].isr = snic_isr_msix_io_cmpl;\r\nsnic->msix[SNIC_MSIX_IO_CMPL].devid = snic;\r\nsprintf(snic->msix[SNIC_MSIX_ERR_NOTIFY].devname,\r\n"%.11s-err-notify",\r\nsnic->name);\r\nsnic->msix[SNIC_MSIX_ERR_NOTIFY].isr = snic_isr_msix_err_notify;\r\nsnic->msix[SNIC_MSIX_ERR_NOTIFY].devid = snic;\r\nfor (i = 0; i < ARRAY_SIZE(snic->msix); i++) {\r\nret = request_irq(pci_irq_vector(snic->pdev, i),\r\nsnic->msix[i].isr,\r\n0,\r\nsnic->msix[i].devname,\r\nsnic->msix[i].devid);\r\nif (ret) {\r\nSNIC_HOST_ERR(snic->shost,\r\n"MSI-X: request_irq(%d) failed %d\n",\r\ni,\r\nret);\r\nsnic_free_intr(snic);\r\nbreak;\r\n}\r\nsnic->msix[i].requested = 1;\r\n}\r\nreturn ret;\r\n}\r\nint\r\nsnic_set_intr_mode(struct snic *snic)\r\n{\r\nunsigned int n = ARRAY_SIZE(snic->wq);\r\nunsigned int m = SNIC_CQ_IO_CMPL_MAX;\r\nunsigned int vecs = n + m + 1;\r\nBUILD_BUG_ON((ARRAY_SIZE(snic->wq) + SNIC_CQ_IO_CMPL_MAX) >\r\nARRAY_SIZE(snic->intr));\r\nif (snic->wq_count < n || snic->cq_count < n + m)\r\ngoto fail;\r\nif (pci_alloc_irq_vectors(snic->pdev, vecs, vecs, PCI_IRQ_MSIX) < 0)\r\ngoto fail;\r\nsnic->wq_count = n;\r\nsnic->cq_count = n + m;\r\nsnic->intr_count = vecs;\r\nsnic->err_intr_offset = SNIC_MSIX_ERR_NOTIFY;\r\nSNIC_ISR_DBG(snic->shost, "Using MSI-X Interrupts\n");\r\nsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_MSIX);\r\nreturn 0;\r\nfail:\r\nsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_UNKNOWN);\r\nreturn -EINVAL;\r\n}\r\nvoid\r\nsnic_clear_intr_mode(struct snic *snic)\r\n{\r\npci_free_irq_vectors(snic->pdev);\r\nsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_INTX);\r\n}

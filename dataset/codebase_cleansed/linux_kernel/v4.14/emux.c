int snd_emux_new(struct snd_emux **remu)\r\n{\r\nstruct snd_emux *emu;\r\n*remu = NULL;\r\nemu = kzalloc(sizeof(*emu), GFP_KERNEL);\r\nif (emu == NULL)\r\nreturn -ENOMEM;\r\nspin_lock_init(&emu->voice_lock);\r\nmutex_init(&emu->register_mutex);\r\nemu->client = -1;\r\n#if IS_ENABLED(CONFIG_SND_SEQUENCER_OSS)\r\nemu->oss_synth = NULL;\r\n#endif\r\nemu->max_voices = 0;\r\nemu->use_time = 0;\r\nsetup_timer(&emu->tlist, snd_emux_timer_callback, (unsigned long)emu);\r\nemu->timer_active = 0;\r\n*remu = emu;\r\nreturn 0;\r\n}\r\nstatic int sf_sample_new(void *private_data, struct snd_sf_sample *sp,\r\nstruct snd_util_memhdr *hdr,\r\nconst void __user *buf, long count)\r\n{\r\nstruct snd_emux *emu = private_data;\r\nreturn emu->ops.sample_new(emu, sp, hdr, buf, count);\r\n}\r\nstatic int sf_sample_free(void *private_data, struct snd_sf_sample *sp,\r\nstruct snd_util_memhdr *hdr)\r\n{\r\nstruct snd_emux *emu = private_data;\r\nreturn emu->ops.sample_free(emu, sp, hdr);\r\n}\r\nstatic void sf_sample_reset(void *private_data)\r\n{\r\nstruct snd_emux *emu = private_data;\r\nemu->ops.sample_reset(emu);\r\n}\r\nint snd_emux_register(struct snd_emux *emu, struct snd_card *card, int index, char *name)\r\n{\r\nint err;\r\nstruct snd_sf_callback sf_cb;\r\nif (snd_BUG_ON(!emu->hw || emu->max_voices <= 0))\r\nreturn -EINVAL;\r\nif (snd_BUG_ON(!card || !name))\r\nreturn -EINVAL;\r\nemu->card = card;\r\nemu->name = kstrdup(name, GFP_KERNEL);\r\nemu->voices = kcalloc(emu->max_voices, sizeof(struct snd_emux_voice),\r\nGFP_KERNEL);\r\nif (emu->voices == NULL)\r\nreturn -ENOMEM;\r\nmemset(&sf_cb, 0, sizeof(sf_cb));\r\nsf_cb.private_data = emu;\r\nif (emu->ops.sample_new)\r\nsf_cb.sample_new = sf_sample_new;\r\nif (emu->ops.sample_free)\r\nsf_cb.sample_free = sf_sample_free;\r\nif (emu->ops.sample_reset)\r\nsf_cb.sample_reset = sf_sample_reset;\r\nemu->sflist = snd_sf_new(&sf_cb, emu->memhdr);\r\nif (emu->sflist == NULL)\r\nreturn -ENOMEM;\r\nif ((err = snd_emux_init_hwdep(emu)) < 0)\r\nreturn err;\r\nsnd_emux_init_voices(emu);\r\nsnd_emux_init_seq(emu, card, index);\r\n#if IS_ENABLED(CONFIG_SND_SEQUENCER_OSS)\r\nsnd_emux_init_seq_oss(emu);\r\n#endif\r\nsnd_emux_init_virmidi(emu, card);\r\nsnd_emux_proc_init(emu, card, index);\r\nreturn 0;\r\n}\r\nint snd_emux_free(struct snd_emux *emu)\r\n{\r\nunsigned long flags;\r\nif (! emu)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&emu->voice_lock, flags);\r\nif (emu->timer_active)\r\ndel_timer(&emu->tlist);\r\nspin_unlock_irqrestore(&emu->voice_lock, flags);\r\nsnd_emux_proc_free(emu);\r\nsnd_emux_delete_virmidi(emu);\r\n#if IS_ENABLED(CONFIG_SND_SEQUENCER_OSS)\r\nsnd_emux_detach_seq_oss(emu);\r\n#endif\r\nsnd_emux_detach_seq(emu);\r\nsnd_emux_delete_hwdep(emu);\r\nsnd_sf_free(emu->sflist);\r\nkfree(emu->voices);\r\nkfree(emu->name);\r\nkfree(emu);\r\nreturn 0;\r\n}\r\nstatic int __init alsa_emux_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit alsa_emux_exit(void)\r\n{\r\n}

static irqreturn_t dir685_tk_irq_thread(int irq, void *data)\r\n{\r\nstruct dir685_touchkeys *tk = data;\r\nconst int num_bits = min_t(int, ARRAY_SIZE(tk->codes), 16);\r\nunsigned long changed;\r\nu8 buf[6];\r\nunsigned long key;\r\nint i;\r\nint err;\r\nmemset(buf, 0, sizeof(buf));\r\nerr = i2c_master_recv(tk->client, buf, sizeof(buf));\r\nif (err != sizeof(buf)) {\r\ndev_err(tk->dev, "short read %d\n", err);\r\nreturn IRQ_HANDLED;\r\n}\r\ndev_dbg(tk->dev, "IN: %*ph\n", (int)sizeof(buf), buf);\r\nkey = be16_to_cpup((__be16 *) &buf[4]);\r\nchanged = tk->cur_key ^ key;\r\nfor_each_set_bit(i, &changed, num_bits) {\r\ndev_dbg(tk->dev, "key %d is %s\n", i,\r\ntest_bit(i, &key) ? "down" : "up");\r\ninput_report_key(tk->input, tk->codes[i], test_bit(i, &key));\r\n}\r\ntk->cur_key = key;\r\ninput_sync(tk->input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int dir685_tk_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct dir685_touchkeys *tk;\r\nstruct device *dev = &client->dev;\r\nu8 bl_data[] = { 0xa7, 0x40 };\r\nint err;\r\nint i;\r\ntk = devm_kzalloc(&client->dev, sizeof(*tk), GFP_KERNEL);\r\nif (!tk)\r\nreturn -ENOMEM;\r\ntk->input = devm_input_allocate_device(dev);\r\nif (!tk->input)\r\nreturn -ENOMEM;\r\ntk->client = client;\r\ntk->dev = dev;\r\ntk->input->keycodesize = sizeof(u16);\r\ntk->input->keycodemax = ARRAY_SIZE(tk->codes);\r\ntk->input->keycode = tk->codes;\r\ntk->codes[0] = KEY_UP;\r\ntk->codes[1] = KEY_DOWN;\r\ntk->codes[2] = KEY_LEFT;\r\ntk->codes[3] = KEY_RIGHT;\r\ntk->codes[4] = KEY_ENTER;\r\ntk->codes[5] = KEY_WPS_BUTTON;\r\ntk->codes[6] = KEY_RESERVED;\r\n__set_bit(EV_KEY, tk->input->evbit);\r\nfor (i = 0; i < ARRAY_SIZE(tk->codes); i++)\r\n__set_bit(tk->codes[i], tk->input->keybit);\r\n__clear_bit(KEY_RESERVED, tk->input->keybit);\r\ntk->input->name = "D-Link DIR-685 touchkeys";\r\ntk->input->id.bustype = BUS_I2C;\r\nerr = input_register_device(tk->input);\r\nif (err)\r\nreturn err;\r\nerr = i2c_master_send(client, bl_data, sizeof(bl_data));\r\nif (err != sizeof(bl_data))\r\ndev_warn(tk->dev, "error setting brightness level\n");\r\nif (!client->irq) {\r\ndev_err(dev, "no IRQ on the I2C device\n");\r\nreturn -ENODEV;\r\n}\r\nerr = devm_request_threaded_irq(dev, client->irq,\r\nNULL, dir685_tk_irq_thread,\r\nIRQF_ONESHOT,\r\n"dir685-tk", tk);\r\nif (err) {\r\ndev_err(dev, "can't request IRQ\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

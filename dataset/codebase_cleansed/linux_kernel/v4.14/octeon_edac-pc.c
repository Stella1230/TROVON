static int co_cache_error_event(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct co_cache_error *p = container_of(this, struct co_cache_error,\r\nnotifier);\r\nunsigned int core = cvmx_get_core_num();\r\nunsigned int cpu = smp_processor_id();\r\nu64 icache_err = read_octeon_c0_icacheerr();\r\nu64 dcache_err;\r\nif (event) {\r\ndcache_err = cache_err_dcache[core];\r\ncache_err_dcache[core] = 0;\r\n} else {\r\ndcache_err = read_octeon_c0_dcacheerr();\r\n}\r\nif (icache_err & 1) {\r\nedac_device_printk(p->ed, KERN_ERR,\r\n"CacheErr (Icache):%llx, core %d/cpu %d, cp0_errorepc == %lx\n",\r\n(unsigned long long)icache_err, core, cpu,\r\nread_c0_errorepc());\r\nwrite_octeon_c0_icacheerr(0);\r\nedac_device_handle_ce(p->ed, cpu, 1, "icache");\r\n}\r\nif (dcache_err & 1) {\r\nedac_device_printk(p->ed, KERN_ERR,\r\n"CacheErr (Dcache):%llx, core %d/cpu %d, cp0_errorepc == %lx\n",\r\n(unsigned long long)dcache_err, core, cpu,\r\nread_c0_errorepc());\r\nif (event)\r\nedac_device_handle_ue(p->ed, cpu, 0, "dcache");\r\nelse\r\nedac_device_handle_ce(p->ed, cpu, 0, "dcache");\r\nif (OCTEON_IS_OCTEON2())\r\nwrite_octeon_c0_dcacheerr(1);\r\nelse\r\nwrite_octeon_c0_dcacheerr(0);\r\n}\r\nreturn NOTIFY_STOP;\r\n}\r\nstatic int co_cache_error_probe(struct platform_device *pdev)\r\n{\r\nstruct co_cache_error *p = devm_kzalloc(&pdev->dev, sizeof(*p),\r\nGFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\np->notifier.notifier_call = co_cache_error_event;\r\nplatform_set_drvdata(pdev, p);\r\np->ed = edac_device_alloc_ctl_info(0, "cpu", num_possible_cpus(),\r\n"cache", 2, 0, NULL, 0,\r\nedac_device_alloc_index());\r\nif (!p->ed)\r\ngoto err;\r\np->ed->dev = &pdev->dev;\r\np->ed->dev_name = dev_name(&pdev->dev);\r\np->ed->mod_name = "octeon-cpu";\r\np->ed->ctl_name = "cache";\r\nif (edac_device_add_device(p->ed)) {\r\npr_err("%s: edac_device_add_device() failed\n", __func__);\r\ngoto err1;\r\n}\r\nregister_co_cache_error_notifier(&p->notifier);\r\nreturn 0;\r\nerr1:\r\nedac_device_free_ctl_info(p->ed);\r\nerr:\r\nreturn -ENXIO;\r\n}\r\nstatic int co_cache_error_remove(struct platform_device *pdev)\r\n{\r\nstruct co_cache_error *p = platform_get_drvdata(pdev);\r\nunregister_co_cache_error_notifier(&p->notifier);\r\nedac_device_del_device(&pdev->dev);\r\nedac_device_free_ctl_info(p->ed);\r\nreturn 0;\r\n}

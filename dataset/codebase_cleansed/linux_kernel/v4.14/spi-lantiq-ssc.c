static u32 lantiq_ssc_readl(const struct lantiq_ssc_spi *spi, u32 reg)\r\n{\r\nreturn __raw_readl(spi->regbase + reg);\r\n}\r\nstatic void lantiq_ssc_writel(const struct lantiq_ssc_spi *spi, u32 val,\r\nu32 reg)\r\n{\r\n__raw_writel(val, spi->regbase + reg);\r\n}\r\nstatic void lantiq_ssc_maskl(const struct lantiq_ssc_spi *spi, u32 clr,\r\nu32 set, u32 reg)\r\n{\r\nu32 val = __raw_readl(spi->regbase + reg);\r\nval &= ~clr;\r\nval |= set;\r\n__raw_writel(val, spi->regbase + reg);\r\n}\r\nstatic unsigned int tx_fifo_level(const struct lantiq_ssc_spi *spi)\r\n{\r\nu32 fstat = lantiq_ssc_readl(spi, LTQ_SPI_FSTAT);\r\nreturn (fstat & LTQ_SPI_FSTAT_TXFFL_M) >> LTQ_SPI_FSTAT_TXFFL_S;\r\n}\r\nstatic unsigned int rx_fifo_level(const struct lantiq_ssc_spi *spi)\r\n{\r\nu32 fstat = lantiq_ssc_readl(spi, LTQ_SPI_FSTAT);\r\nreturn fstat & LTQ_SPI_FSTAT_RXFFL_M;\r\n}\r\nstatic unsigned int tx_fifo_free(const struct lantiq_ssc_spi *spi)\r\n{\r\nreturn spi->tx_fifo_size - tx_fifo_level(spi);\r\n}\r\nstatic void rx_fifo_reset(const struct lantiq_ssc_spi *spi)\r\n{\r\nu32 val = spi->rx_fifo_size << LTQ_SPI_RXFCON_RXFITL_S;\r\nval |= LTQ_SPI_RXFCON_RXFEN | LTQ_SPI_RXFCON_RXFLU;\r\nlantiq_ssc_writel(spi, val, LTQ_SPI_RXFCON);\r\n}\r\nstatic void tx_fifo_reset(const struct lantiq_ssc_spi *spi)\r\n{\r\nu32 val = 1 << LTQ_SPI_TXFCON_TXFITL_S;\r\nval |= LTQ_SPI_TXFCON_TXFEN | LTQ_SPI_TXFCON_TXFLU;\r\nlantiq_ssc_writel(spi, val, LTQ_SPI_TXFCON);\r\n}\r\nstatic void rx_fifo_flush(const struct lantiq_ssc_spi *spi)\r\n{\r\nlantiq_ssc_maskl(spi, 0, LTQ_SPI_RXFCON_RXFLU, LTQ_SPI_RXFCON);\r\n}\r\nstatic void tx_fifo_flush(const struct lantiq_ssc_spi *spi)\r\n{\r\nlantiq_ssc_maskl(spi, 0, LTQ_SPI_TXFCON_TXFLU, LTQ_SPI_TXFCON);\r\n}\r\nstatic void hw_enter_config_mode(const struct lantiq_ssc_spi *spi)\r\n{\r\nlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_CLREN, LTQ_SPI_WHBSTATE);\r\n}\r\nstatic void hw_enter_active_mode(const struct lantiq_ssc_spi *spi)\r\n{\r\nlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_SETEN, LTQ_SPI_WHBSTATE);\r\n}\r\nstatic void hw_setup_speed_hz(const struct lantiq_ssc_spi *spi,\r\nunsigned int max_speed_hz)\r\n{\r\nu32 spi_clk, brt;\r\nspi_clk = clk_get_rate(spi->fpi_clk) / 2;\r\nif (max_speed_hz > spi_clk)\r\nbrt = 0;\r\nelse\r\nbrt = spi_clk / max_speed_hz - 1;\r\nif (brt > 0xFFFF)\r\nbrt = 0xFFFF;\r\ndev_dbg(spi->dev, "spi_clk %u, max_speed_hz %u, brt %u\n",\r\nspi_clk, max_speed_hz, brt);\r\nlantiq_ssc_writel(spi, brt, LTQ_SPI_BRT);\r\n}\r\nstatic void hw_setup_bits_per_word(const struct lantiq_ssc_spi *spi,\r\nunsigned int bits_per_word)\r\n{\r\nu32 bm;\r\nbm = (bits_per_word - 1) << LTQ_SPI_CON_BM_S;\r\nlantiq_ssc_maskl(spi, LTQ_SPI_CON_BM_M, bm, LTQ_SPI_CON);\r\n}\r\nstatic void hw_setup_clock_mode(const struct lantiq_ssc_spi *spi,\r\nunsigned int mode)\r\n{\r\nu32 con_set = 0, con_clr = 0;\r\nif (mode & SPI_CPHA)\r\ncon_clr |= LTQ_SPI_CON_PH;\r\nelse\r\ncon_set |= LTQ_SPI_CON_PH;\r\nif (mode & SPI_CPOL)\r\ncon_set |= LTQ_SPI_CON_PO | LTQ_SPI_CON_IDLE;\r\nelse\r\ncon_clr |= LTQ_SPI_CON_PO | LTQ_SPI_CON_IDLE;\r\nif (mode & SPI_LSB_FIRST)\r\ncon_clr |= LTQ_SPI_CON_HB;\r\nelse\r\ncon_set |= LTQ_SPI_CON_HB;\r\nif (mode & SPI_LOOP)\r\ncon_set |= LTQ_SPI_CON_LB;\r\nelse\r\ncon_clr |= LTQ_SPI_CON_LB;\r\nlantiq_ssc_maskl(spi, con_clr, con_set, LTQ_SPI_CON);\r\n}\r\nstatic void lantiq_ssc_hw_init(const struct lantiq_ssc_spi *spi)\r\n{\r\nconst struct lantiq_ssc_hwcfg *hwcfg = spi->hwcfg;\r\nlantiq_ssc_writel(spi, 1 << LTQ_SPI_CLC_RMC_S, LTQ_SPI_CLC);\r\nhw_enter_config_mode(spi);\r\nlantiq_ssc_maskl(spi, 0, LTQ_SPI_WHBSTATE_CLR_ERRORS, LTQ_SPI_WHBSTATE);\r\nlantiq_ssc_writel(spi, LTQ_SPI_CON_RUEN | LTQ_SPI_CON_AEN |\r\nLTQ_SPI_CON_TEN | LTQ_SPI_CON_REN | LTQ_SPI_CON_TXOFF |\r\nLTQ_SPI_CON_RXOFF, LTQ_SPI_CON);\r\nhw_setup_bits_per_word(spi, spi->bits_per_word);\r\nhw_setup_clock_mode(spi, SPI_MODE_0);\r\nlantiq_ssc_writel(spi, LTQ_SPI_WHBSTATE_SETMS |\r\nLTQ_SPI_WHBSTATE_CLR_ERRORS,\r\nLTQ_SPI_WHBSTATE);\r\nlantiq_ssc_writel(spi, 0, LTQ_SPI_GPOCON);\r\nlantiq_ssc_writel(spi, 0xFF00, LTQ_SPI_FPGO);\r\nrx_fifo_reset(spi);\r\ntx_fifo_reset(spi);\r\nlantiq_ssc_writel(spi, hwcfg->irnen_t | hwcfg->irnen_r |\r\nLTQ_SPI_IRNEN_E, LTQ_SPI_IRNEN);\r\n}\r\nstatic int lantiq_ssc_setup(struct spi_device *spidev)\r\n{\r\nstruct spi_master *master = spidev->master;\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(master);\r\nunsigned int cs = spidev->chip_select;\r\nu32 gpocon;\r\nif (gpio_is_valid(spidev->cs_gpio))\r\nreturn 0;\r\ndev_dbg(spi->dev, "using internal chipselect %u\n", cs);\r\nif (cs < spi->base_cs) {\r\ndev_err(spi->dev,\r\n"chipselect %i too small (min %i)\n", cs, spi->base_cs);\r\nreturn -EINVAL;\r\n}\r\ngpocon = 1 << ((cs - spi->base_cs) + LTQ_SPI_GPOCON_ISCSBN_S);\r\nif (spidev->mode & SPI_CS_HIGH)\r\ngpocon |= 1 << (cs - spi->base_cs);\r\nlantiq_ssc_maskl(spi, 0, gpocon, LTQ_SPI_GPOCON);\r\nreturn 0;\r\n}\r\nstatic int lantiq_ssc_prepare_message(struct spi_master *master,\r\nstruct spi_message *message)\r\n{\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(master);\r\nhw_enter_config_mode(spi);\r\nhw_setup_clock_mode(spi, message->spi->mode);\r\nhw_enter_active_mode(spi);\r\nreturn 0;\r\n}\r\nstatic void hw_setup_transfer(struct lantiq_ssc_spi *spi,\r\nstruct spi_device *spidev, struct spi_transfer *t)\r\n{\r\nunsigned int speed_hz = t->speed_hz;\r\nunsigned int bits_per_word = t->bits_per_word;\r\nu32 con;\r\nif (bits_per_word != spi->bits_per_word ||\r\nspeed_hz != spi->speed_hz) {\r\nhw_enter_config_mode(spi);\r\nhw_setup_speed_hz(spi, speed_hz);\r\nhw_setup_bits_per_word(spi, bits_per_word);\r\nhw_enter_active_mode(spi);\r\nspi->speed_hz = speed_hz;\r\nspi->bits_per_word = bits_per_word;\r\n}\r\ncon = lantiq_ssc_readl(spi, LTQ_SPI_CON);\r\nif (t->tx_buf)\r\ncon &= ~LTQ_SPI_CON_TXOFF;\r\nelse\r\ncon |= LTQ_SPI_CON_TXOFF;\r\nif (t->rx_buf)\r\ncon &= ~LTQ_SPI_CON_RXOFF;\r\nelse\r\ncon |= LTQ_SPI_CON_RXOFF;\r\nlantiq_ssc_writel(spi, con, LTQ_SPI_CON);\r\n}\r\nstatic int lantiq_ssc_unprepare_message(struct spi_master *master,\r\nstruct spi_message *message)\r\n{\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(master);\r\nflush_workqueue(spi->wq);\r\nlantiq_ssc_maskl(spi, 0, LTQ_SPI_CON_TXOFF | LTQ_SPI_CON_RXOFF,\r\nLTQ_SPI_CON);\r\nreturn 0;\r\n}\r\nstatic void tx_fifo_write(struct lantiq_ssc_spi *spi)\r\n{\r\nconst u8 *tx8;\r\nconst u16 *tx16;\r\nconst u32 *tx32;\r\nu32 data;\r\nunsigned int tx_free = tx_fifo_free(spi);\r\nwhile (spi->tx_todo && tx_free) {\r\nswitch (spi->bits_per_word) {\r\ncase 2 ... 8:\r\ntx8 = spi->tx;\r\ndata = *tx8;\r\nspi->tx_todo--;\r\nspi->tx++;\r\nbreak;\r\ncase 16:\r\ntx16 = (u16 *) spi->tx;\r\ndata = *tx16;\r\nspi->tx_todo -= 2;\r\nspi->tx += 2;\r\nbreak;\r\ncase 32:\r\ntx32 = (u32 *) spi->tx;\r\ndata = *tx32;\r\nspi->tx_todo -= 4;\r\nspi->tx += 4;\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\ndata = 0;\r\nbreak;\r\n}\r\nlantiq_ssc_writel(spi, data, LTQ_SPI_TB);\r\ntx_free--;\r\n}\r\n}\r\nstatic void rx_fifo_read_full_duplex(struct lantiq_ssc_spi *spi)\r\n{\r\nu8 *rx8;\r\nu16 *rx16;\r\nu32 *rx32;\r\nu32 data;\r\nunsigned int rx_fill = rx_fifo_level(spi);\r\nwhile (rx_fill) {\r\ndata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\r\nswitch (spi->bits_per_word) {\r\ncase 2 ... 8:\r\nrx8 = spi->rx;\r\n*rx8 = data;\r\nspi->rx_todo--;\r\nspi->rx++;\r\nbreak;\r\ncase 16:\r\nrx16 = (u16 *) spi->rx;\r\n*rx16 = data;\r\nspi->rx_todo -= 2;\r\nspi->rx += 2;\r\nbreak;\r\ncase 32:\r\nrx32 = (u32 *) spi->rx;\r\n*rx32 = data;\r\nspi->rx_todo -= 4;\r\nspi->rx += 4;\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\nbreak;\r\n}\r\nrx_fill--;\r\n}\r\n}\r\nstatic void rx_fifo_read_half_duplex(struct lantiq_ssc_spi *spi)\r\n{\r\nu32 data, *rx32;\r\nu8 *rx8;\r\nunsigned int rxbv, shift;\r\nunsigned int rx_fill = rx_fifo_level(spi);\r\nwhile (rx_fill) {\r\nif (spi->rx_todo < 4) {\r\nrxbv = (lantiq_ssc_readl(spi, LTQ_SPI_STAT) &\r\nLTQ_SPI_STAT_RXBV_M) >> LTQ_SPI_STAT_RXBV_S;\r\ndata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\r\nshift = (rxbv - 1) * 8;\r\nrx8 = spi->rx;\r\nwhile (rxbv) {\r\n*rx8++ = (data >> shift) & 0xFF;\r\nrxbv--;\r\nshift -= 8;\r\nspi->rx_todo--;\r\nspi->rx++;\r\n}\r\n} else {\r\ndata = lantiq_ssc_readl(spi, LTQ_SPI_RB);\r\nrx32 = (u32 *) spi->rx;\r\n*rx32++ = data;\r\nspi->rx_todo -= 4;\r\nspi->rx += 4;\r\n}\r\nrx_fill--;\r\n}\r\n}\r\nstatic void rx_request(struct lantiq_ssc_spi *spi)\r\n{\r\nunsigned int rxreq, rxreq_max;\r\nrxreq = spi->rx_todo;\r\nrxreq_max = spi->rx_fifo_size * 4;\r\nif (rxreq > rxreq_max)\r\nrxreq = rxreq_max;\r\nlantiq_ssc_writel(spi, rxreq, LTQ_SPI_RXREQ);\r\n}\r\nstatic irqreturn_t lantiq_ssc_xmit_interrupt(int irq, void *data)\r\n{\r\nstruct lantiq_ssc_spi *spi = data;\r\nif (spi->tx) {\r\nif (spi->rx && spi->rx_todo)\r\nrx_fifo_read_full_duplex(spi);\r\nif (spi->tx_todo)\r\ntx_fifo_write(spi);\r\nelse if (!tx_fifo_level(spi))\r\ngoto completed;\r\n} else if (spi->rx) {\r\nif (spi->rx_todo) {\r\nrx_fifo_read_half_duplex(spi);\r\nif (spi->rx_todo)\r\nrx_request(spi);\r\nelse\r\ngoto completed;\r\n} else {\r\ngoto completed;\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\ncompleted:\r\nqueue_work(spi->wq, &spi->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t lantiq_ssc_err_interrupt(int irq, void *data)\r\n{\r\nstruct lantiq_ssc_spi *spi = data;\r\nu32 stat = lantiq_ssc_readl(spi, LTQ_SPI_STAT);\r\nif (!(stat & LTQ_SPI_STAT_ERRORS))\r\nreturn IRQ_NONE;\r\nif (stat & LTQ_SPI_STAT_RUE)\r\ndev_err(spi->dev, "receive underflow error\n");\r\nif (stat & LTQ_SPI_STAT_TUE)\r\ndev_err(spi->dev, "transmit underflow error\n");\r\nif (stat & LTQ_SPI_STAT_AE)\r\ndev_err(spi->dev, "abort error\n");\r\nif (stat & LTQ_SPI_STAT_RE)\r\ndev_err(spi->dev, "receive overflow error\n");\r\nif (stat & LTQ_SPI_STAT_TE)\r\ndev_err(spi->dev, "transmit overflow error\n");\r\nif (stat & LTQ_SPI_STAT_ME)\r\ndev_err(spi->dev, "mode error\n");\r\nlantiq_ssc_maskl(spi, 0, LTQ_SPI_WHBSTATE_CLR_ERRORS, LTQ_SPI_WHBSTATE);\r\nif (spi->master->cur_msg)\r\nspi->master->cur_msg->status = -EIO;\r\nqueue_work(spi->wq, &spi->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int transfer_start(struct lantiq_ssc_spi *spi, struct spi_device *spidev,\r\nstruct spi_transfer *t)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&spi->lock, flags);\r\nspi->tx = t->tx_buf;\r\nspi->rx = t->rx_buf;\r\nif (t->tx_buf) {\r\nspi->tx_todo = t->len;\r\ntx_fifo_write(spi);\r\n}\r\nif (spi->rx) {\r\nspi->rx_todo = t->len;\r\nif (!spi->tx)\r\nrx_request(spi);\r\n}\r\nspin_unlock_irqrestore(&spi->lock, flags);\r\nreturn t->len;\r\n}\r\nstatic void lantiq_ssc_bussy_work(struct work_struct *work)\r\n{\r\nstruct lantiq_ssc_spi *spi;\r\nunsigned long long timeout = 8LL * 1000LL;\r\nunsigned long end;\r\nspi = container_of(work, typeof(*spi), work);\r\ndo_div(timeout, spi->speed_hz);\r\ntimeout += timeout + 100;\r\nend = jiffies + msecs_to_jiffies(timeout);\r\ndo {\r\nu32 stat = lantiq_ssc_readl(spi, LTQ_SPI_STAT);\r\nif (!(stat & LTQ_SPI_STAT_BSY)) {\r\nspi_finalize_current_transfer(spi->master);\r\nreturn;\r\n}\r\ncond_resched();\r\n} while (!time_after_eq(jiffies, end));\r\nif (spi->master->cur_msg)\r\nspi->master->cur_msg->status = -EIO;\r\nspi_finalize_current_transfer(spi->master);\r\n}\r\nstatic void lantiq_ssc_handle_err(struct spi_master *master,\r\nstruct spi_message *message)\r\n{\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(master);\r\nrx_fifo_flush(spi);\r\ntx_fifo_flush(spi);\r\n}\r\nstatic void lantiq_ssc_set_cs(struct spi_device *spidev, bool enable)\r\n{\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(spidev->master);\r\nunsigned int cs = spidev->chip_select;\r\nu32 fgpo;\r\nif (!!(spidev->mode & SPI_CS_HIGH) == enable)\r\nfgpo = (1 << (cs - spi->base_cs));\r\nelse\r\nfgpo = (1 << (cs - spi->base_cs + LTQ_SPI_FGPO_SETOUTN_S));\r\nlantiq_ssc_writel(spi, fgpo, LTQ_SPI_FPGO);\r\n}\r\nstatic int lantiq_ssc_transfer_one(struct spi_master *master,\r\nstruct spi_device *spidev,\r\nstruct spi_transfer *t)\r\n{\r\nstruct lantiq_ssc_spi *spi = spi_master_get_devdata(master);\r\nhw_setup_transfer(spi, spidev, t);\r\nreturn transfer_start(spi, spidev, t);\r\n}\r\nstatic int lantiq_ssc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct spi_master *master;\r\nstruct resource *res;\r\nstruct lantiq_ssc_spi *spi;\r\nconst struct lantiq_ssc_hwcfg *hwcfg;\r\nconst struct of_device_id *match;\r\nint err, rx_irq, tx_irq, err_irq;\r\nu32 id, supports_dma, revision;\r\nunsigned int num_cs;\r\nmatch = of_match_device(lantiq_ssc_match, dev);\r\nif (!match) {\r\ndev_err(dev, "no device match\n");\r\nreturn -EINVAL;\r\n}\r\nhwcfg = match->data;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "failed to get resources\n");\r\nreturn -ENXIO;\r\n}\r\nrx_irq = platform_get_irq_byname(pdev, LTQ_SPI_RX_IRQ_NAME);\r\nif (rx_irq < 0) {\r\ndev_err(dev, "failed to get %s\n", LTQ_SPI_RX_IRQ_NAME);\r\nreturn -ENXIO;\r\n}\r\ntx_irq = platform_get_irq_byname(pdev, LTQ_SPI_TX_IRQ_NAME);\r\nif (tx_irq < 0) {\r\ndev_err(dev, "failed to get %s\n", LTQ_SPI_TX_IRQ_NAME);\r\nreturn -ENXIO;\r\n}\r\nerr_irq = platform_get_irq_byname(pdev, LTQ_SPI_ERR_IRQ_NAME);\r\nif (err_irq < 0) {\r\ndev_err(dev, "failed to get %s\n", LTQ_SPI_ERR_IRQ_NAME);\r\nreturn -ENXIO;\r\n}\r\nmaster = spi_alloc_master(dev, sizeof(struct lantiq_ssc_spi));\r\nif (!master)\r\nreturn -ENOMEM;\r\nspi = spi_master_get_devdata(master);\r\nspi->master = master;\r\nspi->dev = dev;\r\nspi->hwcfg = hwcfg;\r\nplatform_set_drvdata(pdev, spi);\r\nspi->regbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(spi->regbase)) {\r\nerr = PTR_ERR(spi->regbase);\r\ngoto err_master_put;\r\n}\r\nerr = devm_request_irq(dev, rx_irq, lantiq_ssc_xmit_interrupt,\r\n0, LTQ_SPI_RX_IRQ_NAME, spi);\r\nif (err)\r\ngoto err_master_put;\r\nerr = devm_request_irq(dev, tx_irq, lantiq_ssc_xmit_interrupt,\r\n0, LTQ_SPI_TX_IRQ_NAME, spi);\r\nif (err)\r\ngoto err_master_put;\r\nerr = devm_request_irq(dev, err_irq, lantiq_ssc_err_interrupt,\r\n0, LTQ_SPI_ERR_IRQ_NAME, spi);\r\nif (err)\r\ngoto err_master_put;\r\nspi->spi_clk = devm_clk_get(dev, "gate");\r\nif (IS_ERR(spi->spi_clk)) {\r\nerr = PTR_ERR(spi->spi_clk);\r\ngoto err_master_put;\r\n}\r\nerr = clk_prepare_enable(spi->spi_clk);\r\nif (err)\r\ngoto err_master_put;\r\n#if defined(CONFIG_LANTIQ) && !defined(CONFIG_COMMON_CLK)\r\nspi->fpi_clk = clk_get_fpi();\r\n#else\r\nspi->fpi_clk = clk_get(dev, "freq");\r\n#endif\r\nif (IS_ERR(spi->fpi_clk)) {\r\nerr = PTR_ERR(spi->fpi_clk);\r\ngoto err_clk_disable;\r\n}\r\nnum_cs = 8;\r\nof_property_read_u32(pdev->dev.of_node, "num-cs", &num_cs);\r\nspi->base_cs = 1;\r\nof_property_read_u32(pdev->dev.of_node, "base-cs", &spi->base_cs);\r\nspin_lock_init(&spi->lock);\r\nspi->bits_per_word = 8;\r\nspi->speed_hz = 0;\r\nmaster->dev.of_node = pdev->dev.of_node;\r\nmaster->num_chipselect = num_cs;\r\nmaster->setup = lantiq_ssc_setup;\r\nmaster->set_cs = lantiq_ssc_set_cs;\r\nmaster->handle_err = lantiq_ssc_handle_err;\r\nmaster->prepare_message = lantiq_ssc_prepare_message;\r\nmaster->unprepare_message = lantiq_ssc_unprepare_message;\r\nmaster->transfer_one = lantiq_ssc_transfer_one;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_LSB_FIRST | SPI_CS_HIGH |\r\nSPI_LOOP;\r\nmaster->bits_per_word_mask = SPI_BPW_RANGE_MASK(2, 8) |\r\nSPI_BPW_MASK(16) | SPI_BPW_MASK(32);\r\nspi->wq = alloc_ordered_workqueue(dev_name(dev), 0);\r\nif (!spi->wq) {\r\nerr = -ENOMEM;\r\ngoto err_clk_put;\r\n}\r\nINIT_WORK(&spi->work, lantiq_ssc_bussy_work);\r\nid = lantiq_ssc_readl(spi, LTQ_SPI_ID);\r\nspi->tx_fifo_size = (id & LTQ_SPI_ID_TXFS_M) >> LTQ_SPI_ID_TXFS_S;\r\nspi->rx_fifo_size = (id & LTQ_SPI_ID_RXFS_M) >> LTQ_SPI_ID_RXFS_S;\r\nsupports_dma = (id & LTQ_SPI_ID_CFG_M) >> LTQ_SPI_ID_CFG_S;\r\nrevision = id & LTQ_SPI_ID_REV_M;\r\nlantiq_ssc_hw_init(spi);\r\ndev_info(dev,\r\n"Lantiq SSC SPI controller (Rev %i, TXFS %u, RXFS %u, DMA %u)\n",\r\nrevision, spi->tx_fifo_size, spi->rx_fifo_size, supports_dma);\r\nerr = devm_spi_register_master(dev, master);\r\nif (err) {\r\ndev_err(dev, "failed to register spi_master\n");\r\ngoto err_wq_destroy;\r\n}\r\nreturn 0;\r\nerr_wq_destroy:\r\ndestroy_workqueue(spi->wq);\r\nerr_clk_put:\r\nclk_put(spi->fpi_clk);\r\nerr_clk_disable:\r\nclk_disable_unprepare(spi->spi_clk);\r\nerr_master_put:\r\nspi_master_put(master);\r\nreturn err;\r\n}\r\nstatic int lantiq_ssc_remove(struct platform_device *pdev)\r\n{\r\nstruct lantiq_ssc_spi *spi = platform_get_drvdata(pdev);\r\nlantiq_ssc_writel(spi, 0, LTQ_SPI_IRNEN);\r\nlantiq_ssc_writel(spi, 0, LTQ_SPI_CLC);\r\nrx_fifo_flush(spi);\r\ntx_fifo_flush(spi);\r\nhw_enter_config_mode(spi);\r\ndestroy_workqueue(spi->wq);\r\nclk_disable_unprepare(spi->spi_clk);\r\nclk_put(spi->fpi_clk);\r\nreturn 0;\r\n}

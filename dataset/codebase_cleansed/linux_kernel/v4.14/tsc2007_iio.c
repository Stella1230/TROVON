static int tsc2007_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct tsc2007_iio *iio = iio_priv(indio_dev);\r\nstruct tsc2007 *tsc = iio->ts;\r\nint adc_chan = chan->channel;\r\nint ret = 0;\r\nif (adc_chan >= ARRAY_SIZE(tsc2007_iio_channel))\r\nreturn -EINVAL;\r\nif (mask != IIO_CHAN_INFO_RAW)\r\nreturn -EINVAL;\r\nmutex_lock(&tsc->mlock);\r\nswitch (chan->channel) {\r\ncase 0:\r\n*val = tsc2007_xfer(tsc, READ_X);\r\nbreak;\r\ncase 1:\r\n*val = tsc2007_xfer(tsc, READ_Y);\r\nbreak;\r\ncase 2:\r\n*val = tsc2007_xfer(tsc, READ_Z1);\r\nbreak;\r\ncase 3:\r\n*val = tsc2007_xfer(tsc, READ_Z2);\r\nbreak;\r\ncase 4:\r\n*val = tsc2007_xfer(tsc, (ADC_ON_12BIT | TSC2007_MEASURE_AUX));\r\nbreak;\r\ncase 5: {\r\nstruct ts_event tc;\r\ntc.x = tsc2007_xfer(tsc, READ_X);\r\ntc.z1 = tsc2007_xfer(tsc, READ_Z1);\r\ntc.z2 = tsc2007_xfer(tsc, READ_Z2);\r\n*val = tsc2007_calculate_resistance(tsc, &tc);\r\nbreak;\r\n}\r\ncase 6:\r\n*val = tsc2007_is_pen_down(tsc);\r\nbreak;\r\ncase 7:\r\n*val = tsc2007_xfer(tsc,\r\n(ADC_ON_12BIT | TSC2007_MEASURE_TEMP0));\r\nbreak;\r\ncase 8:\r\n*val = tsc2007_xfer(tsc,\r\n(ADC_ON_12BIT | TSC2007_MEASURE_TEMP1));\r\nbreak;\r\n}\r\ntsc2007_xfer(tsc, PWRDOWN);\r\nmutex_unlock(&tsc->mlock);\r\nret = IIO_VAL_INT;\r\nreturn ret;\r\n}\r\nint tsc2007_iio_configure(struct tsc2007 *ts)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct tsc2007_iio *iio;\r\nint error;\r\nindio_dev = devm_iio_device_alloc(&ts->client->dev, sizeof(*iio));\r\nif (!indio_dev) {\r\ndev_err(&ts->client->dev, "iio_device_alloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\niio = iio_priv(indio_dev);\r\niio->ts = ts;\r\nindio_dev->name = "tsc2007";\r\nindio_dev->dev.parent = &ts->client->dev;\r\nindio_dev->info = &tsc2007_iio_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = tsc2007_iio_channel;\r\nindio_dev->num_channels = ARRAY_SIZE(tsc2007_iio_channel);\r\nerror = devm_iio_device_register(&ts->client->dev, indio_dev);\r\nif (error) {\r\ndev_err(&ts->client->dev,\r\n"iio_device_register() failed: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

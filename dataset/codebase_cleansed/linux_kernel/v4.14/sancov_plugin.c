static unsigned int sancov_execute(void)\r\n{\r\nbasic_block bb;\r\nFOR_EACH_BB_FN(bb, cfun) {\r\nconst_gimple stmt;\r\ngcall *gcall;\r\ngimple_stmt_iterator gsi = gsi_after_labels(bb);\r\nif (gsi_end_p(gsi))\r\ncontinue;\r\nstmt = gsi_stmt(gsi);\r\ngcall = as_a_gcall(gimple_build_call(sancov_fndecl, 0));\r\ngimple_set_location(gcall, gimple_location(stmt));\r\ngsi_insert_before(&gsi, gcall, GSI_SAME_STMT);\r\n}\r\nreturn 0;\r\n}\r\nstatic void sancov_start_unit(void __unused *gcc_data, void __unused *user_data)\r\n{\r\ntree leaf_attr, nothrow_attr;\r\ntree BT_FN_VOID = build_function_type_list(void_type_node, NULL_TREE);\r\nsancov_fndecl = build_fn_decl("__sanitizer_cov_trace_pc", BT_FN_VOID);\r\nDECL_ASSEMBLER_NAME(sancov_fndecl);\r\nTREE_PUBLIC(sancov_fndecl) = 1;\r\nDECL_EXTERNAL(sancov_fndecl) = 1;\r\nDECL_ARTIFICIAL(sancov_fndecl) = 1;\r\nDECL_PRESERVE_P(sancov_fndecl) = 1;\r\nDECL_UNINLINABLE(sancov_fndecl) = 1;\r\nTREE_USED(sancov_fndecl) = 1;\r\nnothrow_attr = tree_cons(get_identifier("nothrow"), NULL, NULL);\r\ndecl_attributes(&sancov_fndecl, nothrow_attr, 0);\r\ngcc_assert(TREE_NOTHROW(sancov_fndecl));\r\n#if BUILDING_GCC_VERSION > 4005\r\nleaf_attr = tree_cons(get_identifier("leaf"), NULL, NULL);\r\ndecl_attributes(&sancov_fndecl, leaf_attr, 0);\r\n#endif\r\n}\r\n__visible int plugin_init(struct plugin_name_args *plugin_info, struct plugin_gcc_version *version)\r\n{\r\nint i;\r\nconst char * const plugin_name = plugin_info->base_name;\r\nconst int argc = plugin_info->argc;\r\nconst struct plugin_argument * const argv = plugin_info->argv;\r\nbool enable = true;\r\nstatic const struct ggc_root_tab gt_ggc_r_gt_sancov[] = {\r\n{\r\n.base = &sancov_fndecl,\r\n.nelt = 1,\r\n.stride = sizeof(sancov_fndecl),\r\n.cb = &gt_ggc_mx_tree_node,\r\n.pchw = &gt_pch_nx_tree_node\r\n},\r\nLAST_GGC_ROOT_TAB\r\n};\r\n#if BUILDING_GCC_VERSION >= 4009\r\nPASS_INFO(sancov, "asan", 0, PASS_POS_INSERT_BEFORE);\r\n#else\r\nPASS_INFO(sancov, "nrv", 1, PASS_POS_INSERT_BEFORE);\r\n#endif\r\nif (!plugin_default_version_check(version, &gcc_version)) {\r\nerror(G_("incompatible gcc/plugin versions"));\r\nreturn 1;\r\n}\r\nfor (i = 0; i < argc; ++i) {\r\nif (!strcmp(argv[i].key, "no-sancov")) {\r\nenable = false;\r\ncontinue;\r\n}\r\nerror(G_("unknown option '-fplugin-arg-%s-%s'"), plugin_name, argv[i].key);\r\n}\r\nregister_callback(plugin_name, PLUGIN_INFO, NULL, &sancov_plugin_info);\r\nif (!enable)\r\nreturn 0;\r\n#if BUILDING_GCC_VERSION < 6000\r\nregister_callback(plugin_name, PLUGIN_START_UNIT, &sancov_start_unit, NULL);\r\nregister_callback(plugin_name, PLUGIN_REGISTER_GGC_ROOTS, NULL, (void *)&gt_ggc_r_gt_sancov);\r\nregister_callback(plugin_name, PLUGIN_PASS_MANAGER_SETUP, NULL, &sancov_pass_info);\r\n#endif\r\nreturn 0;\r\n}

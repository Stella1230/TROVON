int snd_fw_transaction(struct fw_unit *unit, int tcode,\r\nu64 offset, void *buffer, size_t length,\r\nunsigned int flags)\r\n{\r\nstruct fw_device *device = fw_parent_device(unit);\r\nint generation, rcode, tries = 0;\r\ngeneration = flags & FW_GENERATION_MASK;\r\nfor (;;) {\r\nif (!(flags & FW_FIXED_GENERATION)) {\r\ngeneration = device->generation;\r\nsmp_rmb();\r\n}\r\nrcode = fw_run_transaction(device->card, tcode,\r\ndevice->node_id, generation,\r\ndevice->max_speed, offset,\r\nbuffer, length);\r\nif (rcode == RCODE_COMPLETE)\r\nreturn 0;\r\nif (rcode == RCODE_GENERATION && (flags & FW_FIXED_GENERATION))\r\nreturn -EAGAIN;\r\nif (rcode_is_permanent_error(rcode) || ++tries >= 3) {\r\nif (!(flags & FW_QUIET))\r\ndev_err(&unit->device,\r\n"transaction failed: %s\n",\r\nfw_rcode_string(rcode));\r\nreturn -EIO;\r\n}\r\nmsleep(ERROR_RETRY_DELAY_MS);\r\n}\r\n}\r\nvoid snd_fw_schedule_registration(struct fw_unit *unit,\r\nstruct delayed_work *dwork)\r\n{\r\nu64 now, delay;\r\nnow = get_jiffies_64();\r\ndelay = fw_parent_device(unit)->card->reset_jiffies\r\n+ msecs_to_jiffies(PROBE_DELAY_MS);\r\nif (time_after64(delay, now))\r\ndelay -= now;\r\nelse\r\ndelay = 0;\r\nmod_delayed_work(system_wq, dwork, delay);\r\n}

static int mxl111sf_i2c_bitbang_sendbyte(struct mxl111sf_state *state,\r\nu8 byte)\r\n{\r\nint i, ret;\r\nu8 data = 0;\r\nmxl_i2c("(0x%02x)", byte);\r\nret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nfor (i = 0; i < 8; i++) {\r\ndata = (byte & (0x80 >> i)) ? SW_SDA_OUT : 0;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | data | SW_SCL_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n}\r\nif (!(byte & 1)) {\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n}\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nif (data & SW_SDA_IN)\r\nret = -EIO;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_bitbang_recvbyte(struct mxl111sf_state *state,\r\nu8 *pbyte)\r\n{\r\nint i, ret;\r\nu8 byte = 0;\r\nu8 data = 0;\r\nmxl_i2c("()");\r\n*pbyte = 0;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nfor (i = 0; i < 8; i++) {\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN |\r\nSW_SCL_OUT | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nif (data & SW_SDA_IN)\r\nbyte |= (0x80 >> i);\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n}\r\n*pbyte = byte;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_start(struct mxl111sf_state *state)\r\n{\r\nint ret;\r\nmxl_i2c("()");\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN);\r\nmxl_fail(ret);\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_stop(struct mxl111sf_state *state)\r\n{\r\nint ret;\r\nmxl_i2c("()");\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_SCL_OUT | SW_SDA_OUT);\r\nmxl_fail(ret);\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_ack(struct mxl111sf_state *state)\r\n{\r\nint ret;\r\nu8 b = 0;\r\nmxl_i2c("()");\r\nret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &b);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nmxl_fail(ret);\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_nack(struct mxl111sf_state *state)\r\n{\r\nint ret;\r\nmxl_i2c("()");\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_write_reg(state, SW_I2C_ADDR,\r\n0x10 | SW_I2C_EN | SW_SDA_OUT);\r\nmxl_fail(ret);\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_sw_xfer_msg(struct mxl111sf_state *state,\r\nstruct i2c_msg *msg)\r\n{\r\nint i, ret;\r\nmxl_i2c("()");\r\nif (msg->flags & I2C_M_RD) {\r\nret = mxl111sf_i2c_start(state);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_i2c_bitbang_sendbyte(state,\r\n(msg->addr << 1) | 0x01);\r\nif (mxl_fail(ret)) {\r\nmxl111sf_i2c_stop(state);\r\ngoto fail;\r\n}\r\nfor (i = 0; i < msg->len; i++) {\r\nret = mxl111sf_i2c_bitbang_recvbyte(state,\r\n&msg->buf[i]);\r\nif (mxl_fail(ret)) {\r\nmxl111sf_i2c_stop(state);\r\ngoto fail;\r\n}\r\nif (i < msg->len - 1)\r\nmxl111sf_i2c_ack(state);\r\n}\r\nmxl111sf_i2c_nack(state);\r\nret = mxl111sf_i2c_stop(state);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n} else {\r\nret = mxl111sf_i2c_start(state);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_i2c_bitbang_sendbyte(state,\r\n(msg->addr << 1) & 0xfe);\r\nif (mxl_fail(ret)) {\r\nmxl111sf_i2c_stop(state);\r\ngoto fail;\r\n}\r\nfor (i = 0; i < msg->len; i++) {\r\nret = mxl111sf_i2c_bitbang_sendbyte(state,\r\nmsg->buf[i]);\r\nif (mxl_fail(ret)) {\r\nmxl111sf_i2c_stop(state);\r\ngoto fail;\r\n}\r\n}\r\nmxl111sf_i2c_stop(state);\r\n}\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_send_data(struct mxl111sf_state *state,\r\nu8 index, u8 *wdata)\r\n{\r\nint ret = mxl111sf_ctrl_msg(state, wdata[0],\r\n&wdata[1], 25, NULL, 0);\r\nmxl_fail(ret);\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_i2c_get_data(struct mxl111sf_state *state,\r\nu8 index, u8 *wdata, u8 *rdata)\r\n{\r\nint ret = mxl111sf_ctrl_msg(state, wdata[0],\r\n&wdata[1], 25, rdata, 24);\r\nmxl_fail(ret);\r\nreturn ret;\r\n}\r\nstatic u8 mxl111sf_i2c_check_status(struct mxl111sf_state *state)\r\n{\r\nu8 status = 0;\r\nu8 buf[26];\r\nmxl_i2c_adv("()");\r\nbuf[0] = USB_READ_I2C_CMD;\r\nbuf[1] = 0x00;\r\nbuf[2] = I2C_INT_STATUS_REG;\r\nbuf[3] = 0x00;\r\nbuf[4] = 0x00;\r\nbuf[5] = USB_END_I2C_CMD;\r\nmxl111sf_i2c_get_data(state, 0, buf, buf);\r\nif (buf[1] & 0x04)\r\nstatus = 1;\r\nreturn status;\r\n}\r\nstatic u8 mxl111sf_i2c_check_fifo(struct mxl111sf_state *state)\r\n{\r\nu8 status = 0;\r\nu8 buf[26];\r\nmxl_i2c("()");\r\nbuf[0] = USB_READ_I2C_CMD;\r\nbuf[1] = 0x00;\r\nbuf[2] = I2C_MUX_REG;\r\nbuf[3] = 0x00;\r\nbuf[4] = 0x00;\r\nbuf[5] = I2C_INT_STATUS_REG;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0x00;\r\nbuf[8] = USB_END_I2C_CMD;\r\nmxl111sf_i2c_get_data(state, 0, buf, buf);\r\nif (0x08 == (buf[1] & 0x08))\r\nstatus = 1;\r\nif ((buf[5] & 0x02) == 0x02)\r\nmxl_i2c("(buf[5] & 0x02) == 0x02");\r\nreturn status;\r\n}\r\nstatic int mxl111sf_i2c_readagain(struct mxl111sf_state *state,\r\nu8 count, u8 *rbuf)\r\n{\r\nu8 i2c_w_data[26];\r\nu8 i2c_r_data[24];\r\nu8 i = 0;\r\nu8 fifo_status = 0;\r\nint status = 0;\r\nmxl_i2c("read %d bytes", count);\r\nwhile ((fifo_status == 0) && (i++ < 5))\r\nfifo_status = mxl111sf_i2c_check_fifo(state);\r\ni2c_w_data[0] = 0xDD;\r\ni2c_w_data[1] = 0x00;\r\nfor (i = 2; i < 26; i++)\r\ni2c_w_data[i] = 0xFE;\r\nfor (i = 0; i < count; i++) {\r\ni2c_w_data[2+(i*3)] = 0x0C;\r\ni2c_w_data[3+(i*3)] = 0x00;\r\ni2c_w_data[4+(i*3)] = 0x00;\r\n}\r\nmxl111sf_i2c_get_data(state, 0, i2c_w_data, i2c_r_data);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("error!");\r\n} else {\r\nfor (i = 0; i < count; i++) {\r\nrbuf[i] = i2c_r_data[(i*3)+1];\r\nmxl_i2c("%02x\t %02x",\r\ni2c_r_data[(i*3)+1],\r\ni2c_r_data[(i*3)+2]);\r\n}\r\nstatus = 1;\r\n}\r\nreturn status;\r\n}\r\nstatic int mxl111sf_i2c_hw_xfer_msg(struct mxl111sf_state *state,\r\nstruct i2c_msg *msg)\r\n{\r\nint i, k, ret = 0;\r\nu16 index = 0;\r\nu8 buf[26];\r\nu8 i2c_r_data[24];\r\nu16 block_len;\r\nu16 left_over_len;\r\nu8 rd_status[8];\r\nu8 ret_status;\r\nu8 readbuff[26];\r\nmxl_i2c("addr: 0x%02x, read buff len: %d, write buff len: %d",\r\nmsg->addr, (msg->flags & I2C_M_RD) ? msg->len : 0,\r\n(!(msg->flags & I2C_M_RD)) ? msg->len : 0);\r\nfor (index = 0; index < 26; index++)\r\nbuf[index] = USB_END_I2C_CMD;\r\nbuf[0] = USB_WRITE_I2C_CMD;\r\nbuf[1] = 0x00;\r\nbuf[2] = I2C_MUX_REG;\r\nbuf[3] = 0x80;\r\nbuf[4] = 0x00;\r\nbuf[5] = I2C_MUX_REG;\r\nbuf[6] = 0x81;\r\nbuf[7] = 0x00;\r\nbuf[8] = 0x14;\r\nbuf[9] = 0xff;\r\nbuf[10] = 0x00;\r\n#if 0\r\nbuf[8] = 0x24;\r\nbuf[9] = 0xF7;\r\nbuf[10] = 0x00;\r\n#endif\r\nbuf[11] = 0x24;\r\nbuf[12] = 0xF7;\r\nbuf[13] = 0x00;\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nif (!(msg->flags & I2C_M_RD) && (msg->len > 0)) {\r\nmxl_i2c("%d\t%02x", msg->len, msg->buf[0]);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x5E;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nbuf[5] = I2C_SLAVE_ADDR_REG;\r\nbuf[6] = (msg->addr);\r\nbuf[7] = 0x00;\r\nbuf[8] = USB_END_I2C_CMD;\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK writing slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x4E;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\nblock_len = (msg->len / 8);\r\nleft_over_len = (msg->len % 8);\r\nindex = 0;\r\nmxl_i2c("block_len %d, left_over_len %d",\r\nblock_len, left_over_len);\r\nfor (index = 0; index < block_len; index++) {\r\nfor (i = 0; i < 8; i++) {\r\nbuf[2+(i*3)] = I2C_DATA_REG;\r\nbuf[3+(i*3)] = msg->buf[(index*8)+i];\r\nbuf[4+(i*3)] = 0x00;\r\n}\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK writing slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x4E;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\n}\r\nif (left_over_len) {\r\nfor (k = 0; k < 26; k++)\r\nbuf[k] = USB_END_I2C_CMD;\r\nbuf[0] = 0x99;\r\nbuf[1] = 0x00;\r\nfor (i = 0; i < left_over_len; i++) {\r\nbuf[2+(i*3)] = I2C_DATA_REG;\r\nbuf[3+(i*3)] = msg->buf[(index*8)+i];\r\nmxl_i2c("index = %d %d data %d",\r\nindex, i, msg->buf[(index*8)+i]);\r\nbuf[4+(i*3)] = 0x00;\r\n}\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK writing slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x4E;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\n}\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x4E;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\n}\r\nif ((msg->flags & I2C_M_RD) && (msg->len > 0)) {\r\nmxl_i2c("read buf len %d", msg->len);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xDF;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nbuf[5] = 0x14;\r\nbuf[6] = (msg->len & 0xFF);\r\nbuf[7] = 0;\r\nbuf[8] = I2C_SLAVE_ADDR_REG;\r\nbuf[9] = msg->addr;\r\nbuf[10] = 0x00;\r\nbuf[11] = USB_END_I2C_CMD;\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK reading slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xC7;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\nblock_len = ((msg->len) / 8);\r\nleft_over_len = ((msg->len) % 8);\r\nindex = 0;\r\nmxl_i2c("block_len %d, left_over_len %d",\r\nblock_len, left_over_len);\r\nbuf[0] = USB_READ_I2C_CMD;\r\nbuf[1] = 0x00;\r\nfor (index = 0; index < block_len; index++) {\r\nfor (i = 0; i < 8; i++) {\r\nbuf[2+(i*3)] = I2C_DATA_REG;\r\nbuf[3+(i*3)] = 0x00;\r\nbuf[4+(i*3)] = 0x00;\r\n}\r\nret = mxl111sf_i2c_get_data(state, 0, buf, i2c_r_data);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK reading slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xC7;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nrd_status[i] = i2c_r_data[(i*3)+2];\r\nif (rd_status[i] == 0x04) {\r\nif (i < 7) {\r\nmxl_i2c("i2c fifo empty! @ %d",\r\ni);\r\nmsg->buf[(index*8)+i] =\r\ni2c_r_data[(i*3)+1];\r\nret_status =\r\nmxl111sf_i2c_readagain(\r\nstate, 8-(i+1),\r\nreadbuff);\r\nif (ret_status == 1) {\r\nfor (k = 0;\r\nk < 8-(i+1);\r\nk++) {\r\nmsg->buf[(index*8)+(k+i+1)] =\r\nreadbuff[k];\r\nmxl_i2c("read data: %02x\t %02x",\r\nmsg->buf[(index*8)+(k+i)],\r\n(index*8)+(k+i));\r\nmxl_i2c("read data: %02x\t %02x",\r\nmsg->buf[(index*8)+(k+i+1)],\r\nreadbuff[k]);\r\n}\r\ngoto stop_copy;\r\n} else {\r\nmxl_i2c("readagain ERROR!");\r\n}\r\n} else {\r\nmsg->buf[(index*8)+i] =\r\ni2c_r_data[(i*3)+1];\r\n}\r\n} else {\r\nmsg->buf[(index*8)+i] =\r\ni2c_r_data[(i*3)+1];\r\n}\r\n}\r\nstop_copy:\r\n;\r\n}\r\nif (left_over_len) {\r\nfor (k = 0; k < 26; k++)\r\nbuf[k] = USB_END_I2C_CMD;\r\nbuf[0] = 0xDD;\r\nbuf[1] = 0x00;\r\nfor (i = 0; i < left_over_len; i++) {\r\nbuf[2+(i*3)] = I2C_DATA_REG;\r\nbuf[3+(i*3)] = 0x00;\r\nbuf[4+(i*3)] = 0x00;\r\n}\r\nret = mxl111sf_i2c_get_data(state, 0, buf,\r\ni2c_r_data);\r\nif (mxl111sf_i2c_check_status(state) == 1) {\r\nmxl_i2c("NACK reading slave address %02x",\r\nmsg->addr);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xC7;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nret = -EIO;\r\ngoto exit;\r\n}\r\nfor (i = 0; i < left_over_len; i++) {\r\nmsg->buf[(block_len*8)+i] =\r\ni2c_r_data[(i*3)+1];\r\nmxl_i2c("read data: %02x\t %02x",\r\ni2c_r_data[(i*3)+1],\r\ni2c_r_data[(i*3)+2]);\r\n}\r\n}\r\nbuf[0] = USB_WRITE_I2C_CMD;\r\nbuf[1] = 0x00;\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0x17;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\nbuf[5] = USB_END_I2C_CMD;\r\nret = mxl111sf_i2c_send_data(state, 0, buf);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xC7;\r\nbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\r\n}\r\nexit:\r\nbuf[0] = USB_WRITE_I2C_CMD;\r\nbuf[1] = 0x00;\r\nbuf[5] = USB_END_I2C_CMD;\r\nmxl111sf_i2c_send_data(state, 0, buf);\r\nbuf[2] = I2C_CONTROL_REG;\r\nbuf[3] = 0xDF;\r\nbuf[4] = 0x03;\r\nbuf[5] = I2C_MUX_REG;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0x00;\r\nbuf[8] = USB_END_I2C_CMD;\r\nmxl111sf_i2c_send_data(state, 0, buf);\r\nbuf[2] = I2C_MUX_REG;\r\nbuf[3] = 0x81;\r\nbuf[4] = 0x00;\r\nbuf[5] = I2C_MUX_REG;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0x00;\r\nbuf[8] = I2C_MUX_REG;\r\nbuf[9] = 0x00;\r\nbuf[10] = 0x00;\r\nbuf[11] = USB_END_I2C_CMD;\r\nmxl111sf_i2c_send_data(state, 0, buf);\r\nreturn ret;\r\n}\r\nint mxl111sf_i2c_xfer(struct i2c_adapter *adap,\r\nstruct i2c_msg msg[], int num)\r\n{\r\nstruct dvb_usb_device *d = i2c_get_adapdata(adap);\r\nstruct mxl111sf_state *state = d->priv;\r\nint hwi2c = (state->chip_rev > MXL111SF_V6);\r\nint i, ret;\r\nif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\r\nreturn -EAGAIN;\r\nfor (i = 0; i < num; i++) {\r\nret = (hwi2c) ?\r\nmxl111sf_i2c_hw_xfer_msg(state, &msg[i]) :\r\nmxl111sf_i2c_sw_xfer_msg(state, &msg[i]);\r\nif (mxl_fail(ret)) {\r\nmxl_debug_adv("failed with error %d on i2c transaction %d of %d, %sing %d bytes to/from 0x%02x",\r\nret, i+1, num,\r\n(msg[i].flags & I2C_M_RD) ?\r\n"read" : "writ",\r\nmsg[i].len, msg[i].addr);\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&d->i2c_mutex);\r\nreturn i == num ? num : -EREMOTEIO;\r\n}

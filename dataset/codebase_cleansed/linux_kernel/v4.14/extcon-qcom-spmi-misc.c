static void qcom_usb_extcon_detect_cable(struct work_struct *work)\r\n{\r\nbool id;\r\nint ret;\r\nstruct qcom_usb_extcon_info *info = container_of(to_delayed_work(work),\r\nstruct qcom_usb_extcon_info,\r\nwq_detcable);\r\nret = irq_get_irqchip_state(info->irq, IRQCHIP_STATE_LINE_LEVEL, &id);\r\nif (ret)\r\nreturn;\r\nextcon_set_state_sync(info->edev, EXTCON_USB_HOST, !id);\r\n}\r\nstatic irqreturn_t qcom_usb_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct qcom_usb_extcon_info *info = dev_id;\r\nqueue_delayed_work(system_power_efficient_wq, &info->wq_detcable,\r\ninfo->debounce_jiffies);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int qcom_usb_extcon_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct qcom_usb_extcon_info *info;\r\nint ret;\r\ninfo = devm_kzalloc(dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->edev = devm_extcon_dev_allocate(dev, qcom_usb_extcon_cable);\r\nif (IS_ERR(info->edev)) {\r\ndev_err(dev, "failed to allocate extcon device\n");\r\nreturn -ENOMEM;\r\n}\r\nret = devm_extcon_dev_register(dev, info->edev);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to register extcon device\n");\r\nreturn ret;\r\n}\r\ninfo->debounce_jiffies = msecs_to_jiffies(USB_ID_DEBOUNCE_MS);\r\nINIT_DELAYED_WORK(&info->wq_detcable, qcom_usb_extcon_detect_cable);\r\ninfo->irq = platform_get_irq_byname(pdev, "usb_id");\r\nif (info->irq < 0)\r\nreturn info->irq;\r\nret = devm_request_threaded_irq(dev, info->irq, NULL,\r\nqcom_usb_irq_handler,\r\nIRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\npdev->name, info);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to request handler for ID IRQ\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, info);\r\ndevice_init_wakeup(dev, 1);\r\nqcom_usb_extcon_detect_cable(&info->wq_detcable.work);\r\nreturn 0;\r\n}\r\nstatic int qcom_usb_extcon_remove(struct platform_device *pdev)\r\n{\r\nstruct qcom_usb_extcon_info *info = platform_get_drvdata(pdev);\r\ncancel_delayed_work_sync(&info->wq_detcable);\r\nreturn 0;\r\n}\r\nstatic int qcom_usb_extcon_suspend(struct device *dev)\r\n{\r\nstruct qcom_usb_extcon_info *info = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (device_may_wakeup(dev))\r\nret = enable_irq_wake(info->irq);\r\nreturn ret;\r\n}\r\nstatic int qcom_usb_extcon_resume(struct device *dev)\r\n{\r\nstruct qcom_usb_extcon_info *info = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (device_may_wakeup(dev))\r\nret = disable_irq_wake(info->irq);\r\nreturn ret;\r\n}

static irqreturn_t sirfsoc_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *ce = dev_id;\r\nWARN_ON(!(readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_STATUS) &\r\nBIT(0)));\r\nwritel_relaxed(BIT(0), sirfsoc_timer_base + SIRFSOC_TIMER_STATUS);\r\nce->event_handler(ce);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic u64 notrace sirfsoc_timer_read(struct clocksource *cs)\r\n{\r\nu64 cycles;\r\nwritel_relaxed(SIRFSOC_TIMER_LATCH_BIT,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_LATCH);\r\ncycles = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_LATCHED_HI);\r\ncycles = (cycles << 32) |\r\nreadl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_LATCHED_LO);\r\nreturn cycles;\r\n}\r\nstatic int sirfsoc_timer_set_next_event(unsigned long delta,\r\nstruct clock_event_device *ce)\r\n{\r\nunsigned long now, next;\r\nwritel_relaxed(SIRFSOC_TIMER_LATCH_BIT,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_LATCH);\r\nnow = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_LATCHED_LO);\r\nnext = now + delta;\r\nwritel_relaxed(next, sirfsoc_timer_base + SIRFSOC_TIMER_MATCH_0);\r\nwritel_relaxed(SIRFSOC_TIMER_LATCH_BIT,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_LATCH);\r\nnow = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_LATCHED_LO);\r\nreturn next - now > delta ? -ETIME : 0;\r\n}\r\nstatic int sirfsoc_timer_shutdown(struct clock_event_device *evt)\r\n{\r\nu32 val = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_INT_EN);\r\nwritel_relaxed(val & ~BIT(0),\r\nsirfsoc_timer_base + SIRFSOC_TIMER_INT_EN);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_timer_set_oneshot(struct clock_event_device *evt)\r\n{\r\nu32 val = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_INT_EN);\r\nwritel_relaxed(val | BIT(0), sirfsoc_timer_base + SIRFSOC_TIMER_INT_EN);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_clocksource_suspend(struct clocksource *cs)\r\n{\r\nint i;\r\nwritel_relaxed(SIRFSOC_TIMER_LATCH_BIT,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_LATCH);\r\nfor (i = 0; i < SIRFSOC_TIMER_REG_CNT; i++)\r\nsirfsoc_timer_reg_val[i] =\r\nreadl_relaxed(sirfsoc_timer_base +\r\nsirfsoc_timer_reg_list[i]);\r\n}\r\nstatic void sirfsoc_clocksource_resume(struct clocksource *cs)\r\n{\r\nint i;\r\nfor (i = 0; i < SIRFSOC_TIMER_REG_CNT - 2; i++)\r\nwritel_relaxed(sirfsoc_timer_reg_val[i],\r\nsirfsoc_timer_base + sirfsoc_timer_reg_list[i]);\r\nwritel_relaxed(sirfsoc_timer_reg_val[SIRFSOC_TIMER_REG_CNT - 2],\r\nsirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_LO);\r\nwritel_relaxed(sirfsoc_timer_reg_val[SIRFSOC_TIMER_REG_CNT - 1],\r\nsirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_HI);\r\n}\r\nstatic u64 notrace sirfsoc_read_sched_clock(void)\r\n{\r\nreturn sirfsoc_timer_read(NULL);\r\n}\r\nstatic void __init sirfsoc_clockevent_init(void)\r\n{\r\nsirfsoc_clockevent.cpumask = cpumask_of(0);\r\nclockevents_config_and_register(&sirfsoc_clockevent, PRIMA2_CLOCK_FREQ,\r\n2, -2);\r\n}\r\nstatic int __init sirfsoc_prima2_timer_init(struct device_node *np)\r\n{\r\nunsigned long rate;\r\nstruct clk *clk;\r\nint ret;\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("Failed to get clock\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\npr_err("Failed to enable clock\n");\r\nreturn ret;\r\n}\r\nrate = clk_get_rate(clk);\r\nif (rate < PRIMA2_CLOCK_FREQ || rate % PRIMA2_CLOCK_FREQ) {\r\npr_err("Invalid clock rate\n");\r\nreturn -EINVAL;\r\n}\r\nsirfsoc_timer_base = of_iomap(np, 0);\r\nif (!sirfsoc_timer_base) {\r\npr_err("unable to map timer cpu registers\n");\r\nreturn -ENXIO;\r\n}\r\nsirfsoc_timer_irq.irq = irq_of_parse_and_map(np, 0);\r\nwritel_relaxed(rate / PRIMA2_CLOCK_FREQ / 2 - 1,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_DIV);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_LO);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_HI);\r\nwritel_relaxed(BIT(0), sirfsoc_timer_base + SIRFSOC_TIMER_STATUS);\r\nret = clocksource_register_hz(&sirfsoc_clocksource, PRIMA2_CLOCK_FREQ);\r\nif (ret) {\r\npr_err("Failed to register clocksource\n");\r\nreturn ret;\r\n}\r\nsched_clock_register(sirfsoc_read_sched_clock, 64, PRIMA2_CLOCK_FREQ);\r\nret = setup_irq(sirfsoc_timer_irq.irq, &sirfsoc_timer_irq);\r\nif (ret) {\r\npr_err("Failed to setup irq\n");\r\nreturn ret;\r\n}\r\nsirfsoc_clockevent_init();\r\nreturn 0;\r\n}

void ams_delta_latch_write(int base, int ngpio, u16 mask, u16 value)\r\n{\r\nint bit = 0;\r\nu16 bitpos = 1 << bit;\r\nfor (; bit < ngpio; bit++, bitpos = bitpos << 1) {\r\nif (!(mask & bitpos))\r\ncontinue;\r\nelse\r\ngpio_set_value(base + bit, (value & bitpos) != 0);\r\n}\r\n}\r\nstatic int ams_delta_camera_power(struct device *dev, int power)\r\n{\r\nif (power)\r\nled_trigger_event(ams_delta_camera_led_trigger, LED_FULL);\r\nelse\r\nled_trigger_event(ams_delta_camera_led_trigger, LED_OFF);\r\nreturn 0;\r\n}\r\nstatic void __init ams_delta_init(void)\r\n{\r\nomap_cfg_reg(UART1_TX);\r\nomap_cfg_reg(UART1_RTS);\r\nomap_cfg_reg(H19_1610_CAM_EXCLK);\r\nomap_cfg_reg(J15_1610_CAM_LCLK);\r\nomap_cfg_reg(L18_1610_CAM_VS);\r\nomap_cfg_reg(L15_1610_CAM_HS);\r\nomap_cfg_reg(L19_1610_CAM_D0);\r\nomap_cfg_reg(K14_1610_CAM_D1);\r\nomap_cfg_reg(K15_1610_CAM_D2);\r\nomap_cfg_reg(K19_1610_CAM_D3);\r\nomap_cfg_reg(K18_1610_CAM_D4);\r\nomap_cfg_reg(J14_1610_CAM_D5);\r\nomap_cfg_reg(J19_1610_CAM_D6);\r\nomap_cfg_reg(J18_1610_CAM_D7);\r\nomap_serial_init();\r\nomap_register_i2c_bus(1, 100, NULL, 0);\r\nomap1_usb_init(&ams_delta_usb_config);\r\nomap1_set_camera_info(&ams_delta_camera_platform_data);\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\nled_trigger_register_simple("ams_delta_camera",\r\n&ams_delta_camera_led_trigger);\r\n#endif\r\ngpio_led_register_device(-1, &leds_pdata);\r\nplatform_add_devices(ams_delta_devices, ARRAY_SIZE(ams_delta_devices));\r\nams_delta_init_fiq();\r\nomap_writew(omap_readw(ARM_RSTCT1) | 0x0004, ARM_RSTCT1);\r\nomapfb_set_lcd_config(&ams_delta_lcd_config);\r\n}\r\nstatic void modem_pm(struct uart_port *port, unsigned int state, unsigned old)\r\n{\r\nstruct modem_private_data *priv = port->private_data;\r\nint ret;\r\nif (IS_ERR(priv->regulator))\r\nreturn;\r\nif (state == old)\r\nreturn;\r\nif (state == 0)\r\nret = regulator_enable(priv->regulator);\r\nelse if (old == 0)\r\nret = regulator_disable(priv->regulator);\r\nelse\r\nret = 0;\r\nif (ret)\r\ndev_warn(port->dev,\r\n"ams_delta modem_pm: failed to %sable regulator: %d\n",\r\nstate ? "dis" : "en", ret);\r\n}\r\nstatic int __init late_init(void)\r\n{\r\nint err;\r\nif (!machine_is_ams_delta())\r\nreturn -ENODEV;\r\nerr = gpio_request_array(latch_gpios, ARRAY_SIZE(latch_gpios));\r\nif (err) {\r\npr_err("Couldn't take over latch1/latch2 GPIO pins\n");\r\nreturn err;\r\n}\r\nplatform_add_devices(late_devices, ARRAY_SIZE(late_devices));\r\nerr = platform_device_register(&modem_nreset_device);\r\nif (err) {\r\npr_err("Couldn't register the modem regulator device\n");\r\nreturn err;\r\n}\r\nomap_cfg_reg(M14_1510_GPIO2);\r\nams_delta_modem_ports[0].irq =\r\ngpio_to_irq(AMS_DELTA_GPIO_PIN_MODEM_IRQ);\r\nerr = gpio_request(AMS_DELTA_GPIO_PIN_MODEM_IRQ, "modem");\r\nif (err) {\r\npr_err("Couldn't request gpio pin for modem\n");\r\nreturn err;\r\n}\r\ngpio_direction_input(AMS_DELTA_GPIO_PIN_MODEM_IRQ);\r\nmodem_priv.regulator = ERR_PTR(-ENODEV);\r\nams_delta_latch2_write(AMS_DELTA_LATCH2_MODEM_CODEC,\r\nAMS_DELTA_LATCH2_MODEM_CODEC);\r\nerr = platform_device_register(&ams_delta_modem_device);\r\nif (err)\r\ngoto gpio_free;\r\nmodem_priv.regulator = regulator_get(&ams_delta_modem_device.dev,\r\n"RESET#");\r\nif (IS_ERR(modem_priv.regulator)) {\r\nerr = PTR_ERR(modem_priv.regulator);\r\ngoto unregister;\r\n}\r\nreturn 0;\r\nunregister:\r\nplatform_device_unregister(&ams_delta_modem_device);\r\ngpio_free:\r\ngpio_free(AMS_DELTA_GPIO_PIN_MODEM_IRQ);\r\nreturn err;\r\n}\r\nstatic void __init ams_delta_init_late(void)\r\n{\r\nomap1_init_late();\r\nlate_init();\r\n}\r\nstatic void __init ams_delta_map_io(void)\r\n{\r\nomap15xx_map_io();\r\niotable_init(ams_delta_io_desc, ARRAY_SIZE(ams_delta_io_desc));\r\n}

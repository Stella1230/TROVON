static enum fpga_mgr_states alt_pr_fpga_state(struct fpga_manager *mgr)\r\n{\r\nstruct alt_pr_priv *priv = mgr->priv;\r\nconst char *err = "unknown";\r\nenum fpga_mgr_states ret = FPGA_MGR_STATE_UNKNOWN;\r\nu32 val;\r\nval = readl(priv->reg_base + ALT_PR_CSR_OFST);\r\nval &= ALT_PR_CSR_STATUS_MSK;\r\nswitch (val) {\r\ncase ALT_PR_CSR_STATUS_NRESET:\r\nreturn FPGA_MGR_STATE_RESET;\r\ncase ALT_PR_CSR_STATUS_PR_ERR:\r\nerr = "pr error";\r\nret = FPGA_MGR_STATE_WRITE_ERR;\r\nbreak;\r\ncase ALT_PR_CSR_STATUS_CRC_ERR:\r\nerr = "crc error";\r\nret = FPGA_MGR_STATE_WRITE_ERR;\r\nbreak;\r\ncase ALT_PR_CSR_STATUS_BAD_BITS:\r\nerr = "bad bits";\r\nret = FPGA_MGR_STATE_WRITE_ERR;\r\nbreak;\r\ncase ALT_PR_CSR_STATUS_PR_IN_PROG:\r\nreturn FPGA_MGR_STATE_WRITE;\r\ncase ALT_PR_CSR_STATUS_PR_SUCCESS:\r\nreturn FPGA_MGR_STATE_OPERATING;\r\ndefault:\r\nbreak;\r\n}\r\ndev_err(&mgr->dev, "encountered error code %d (%s) in %s()\n",\r\nval, err, __func__);\r\nreturn ret;\r\n}\r\nstatic int alt_pr_fpga_write_init(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info,\r\nconst char *buf, size_t count)\r\n{\r\nstruct alt_pr_priv *priv = mgr->priv;\r\nu32 val;\r\nif (!(info->flags & FPGA_MGR_PARTIAL_RECONFIG)) {\r\ndev_err(&mgr->dev, "%s Partial Reconfiguration flag not set\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\nval = readl(priv->reg_base + ALT_PR_CSR_OFST);\r\nif (val & ALT_PR_CSR_PR_START) {\r\ndev_err(&mgr->dev,\r\n"%s Partial Reconfiguration already started\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\nwritel(val | ALT_PR_CSR_PR_START, priv->reg_base + ALT_PR_CSR_OFST);\r\nreturn 0;\r\n}\r\nstatic int alt_pr_fpga_write(struct fpga_manager *mgr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct alt_pr_priv *priv = mgr->priv;\r\nu32 *buffer_32 = (u32 *)buf;\r\nsize_t i = 0;\r\nif (count <= 0)\r\nreturn -EINVAL;\r\nwhile (count >= sizeof(u32)) {\r\nwritel(buffer_32[i++], priv->reg_base);\r\ncount -= sizeof(u32);\r\n}\r\nswitch (count) {\r\ncase 3:\r\nwritel(buffer_32[i++] & 0x00ffffff, priv->reg_base);\r\nbreak;\r\ncase 2:\r\nwritel(buffer_32[i++] & 0x0000ffff, priv->reg_base);\r\nbreak;\r\ncase 1:\r\nwritel(buffer_32[i++] & 0x000000ff, priv->reg_base);\r\nbreak;\r\ncase 0:\r\nbreak;\r\ndefault:\r\nreturn -EFAULT;\r\n}\r\nif (alt_pr_fpga_state(mgr) == FPGA_MGR_STATE_WRITE_ERR)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int alt_pr_fpga_write_complete(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info)\r\n{\r\nu32 i = 0;\r\ndo {\r\nswitch (alt_pr_fpga_state(mgr)) {\r\ncase FPGA_MGR_STATE_WRITE_ERR:\r\nreturn -EIO;\r\ncase FPGA_MGR_STATE_OPERATING:\r\ndev_info(&mgr->dev,\r\n"successful partial reconfiguration\n");\r\nreturn 0;\r\ndefault:\r\nbreak;\r\n}\r\nudelay(1);\r\n} while (info->config_complete_timeout_us > i++);\r\ndev_err(&mgr->dev, "timed out waiting for write to complete\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nint alt_pr_register(struct device *dev, void __iomem *reg_base)\r\n{\r\nstruct alt_pr_priv *priv;\r\nu32 val;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->reg_base = reg_base;\r\nval = readl(priv->reg_base + ALT_PR_CSR_OFST);\r\ndev_dbg(dev, "%s status=%d start=%d\n", __func__,\r\n(val & ALT_PR_CSR_STATUS_MSK) >> ALT_PR_CSR_STATUS_SFT,\r\n(int)(val & ALT_PR_CSR_PR_START));\r\nreturn fpga_mgr_register(dev, dev_name(dev), &alt_pr_ops, priv);\r\n}\r\nint alt_pr_unregister(struct device *dev)\r\n{\r\ndev_dbg(dev, "%s\n", __func__);\r\nfpga_mgr_unregister(dev);\r\nreturn 0;\r\n}

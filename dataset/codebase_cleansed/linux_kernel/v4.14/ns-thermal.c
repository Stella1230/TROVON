static int ns_thermal_get_temp(void *data, int *temp)\r\n{\r\nstruct ns_thermal *ns_thermal = data;\r\nint offset = thermal_zone_get_offset(ns_thermal->tz);\r\nint slope = thermal_zone_get_slope(ns_thermal->tz);\r\nu32 val;\r\nval = readl(ns_thermal->pvtmon + PVTMON_CONTROL0);\r\nif ((val & PVTMON_CONTROL0_SEL_MASK) != PVTMON_CONTROL0_SEL_TEMP_MONITOR) {\r\nval &= ~PVTMON_CONTROL0_SEL_MASK;\r\nval |= PVTMON_CONTROL0_SEL_TEMP_MONITOR;\r\nwritel(val, ns_thermal->pvtmon + PVTMON_CONTROL0);\r\n}\r\nval = readl(ns_thermal->pvtmon + PVTMON_STATUS);\r\n*temp = slope * val + offset;\r\nreturn 0;\r\n}\r\nstatic int ns_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ns_thermal *ns_thermal;\r\nns_thermal = devm_kzalloc(dev, sizeof(*ns_thermal), GFP_KERNEL);\r\nif (!ns_thermal)\r\nreturn -ENOMEM;\r\nns_thermal->pvtmon = of_iomap(dev_of_node(dev), 0);\r\nif (WARN_ON(!ns_thermal->pvtmon))\r\nreturn -ENOENT;\r\nns_thermal->tz = devm_thermal_zone_of_sensor_register(dev, 0,\r\nns_thermal,\r\n&ns_thermal_ops);\r\nif (IS_ERR(ns_thermal->tz)) {\r\niounmap(ns_thermal->pvtmon);\r\nreturn PTR_ERR(ns_thermal->tz);\r\n}\r\nplatform_set_drvdata(pdev, ns_thermal);\r\nreturn 0;\r\n}\r\nstatic int ns_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct ns_thermal *ns_thermal = platform_get_drvdata(pdev);\r\niounmap(ns_thermal->pvtmon);\r\nreturn 0;\r\n}

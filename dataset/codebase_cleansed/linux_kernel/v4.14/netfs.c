int __fscache_register_netfs(struct fscache_netfs *netfs)\r\n{\r\nstruct fscache_netfs *ptr;\r\nstruct fscache_cookie *cookie;\r\nint ret;\r\n_enter("{%s}", netfs->name);\r\nINIT_LIST_HEAD(&netfs->link);\r\ncookie = kmem_cache_zalloc(fscache_cookie_jar, GFP_KERNEL);\r\nif (!cookie) {\r\n_leave(" = -ENOMEM");\r\nreturn -ENOMEM;\r\n}\r\natomic_set(&cookie->usage, 1);\r\natomic_set(&cookie->n_children, 0);\r\natomic_set(&cookie->n_active, 1);\r\ncookie->def = &fscache_fsdef_netfs_def;\r\ncookie->parent = &fscache_fsdef_index;\r\ncookie->netfs_data = netfs;\r\ncookie->flags = 1 << FSCACHE_COOKIE_ENABLED;\r\nspin_lock_init(&cookie->lock);\r\nspin_lock_init(&cookie->stores_lock);\r\nINIT_HLIST_HEAD(&cookie->backing_objects);\r\ndown_write(&fscache_addremove_sem);\r\nret = -EEXIST;\r\nlist_for_each_entry(ptr, &fscache_netfs_list, link) {\r\nif (strcmp(ptr->name, netfs->name) == 0)\r\ngoto already_registered;\r\n}\r\natomic_inc(&cookie->parent->usage);\r\natomic_inc(&cookie->parent->n_children);\r\nnetfs->primary_index = cookie;\r\nlist_add(&netfs->link, &fscache_netfs_list);\r\nret = 0;\r\npr_notice("Netfs '%s' registered for caching\n", netfs->name);\r\nalready_registered:\r\nup_write(&fscache_addremove_sem);\r\nif (ret < 0)\r\nkmem_cache_free(fscache_cookie_jar, cookie);\r\n_leave(" = %d", ret);\r\nreturn ret;\r\n}\r\nvoid __fscache_unregister_netfs(struct fscache_netfs *netfs)\r\n{\r\n_enter("{%s.%u}", netfs->name, netfs->version);\r\ndown_write(&fscache_addremove_sem);\r\nlist_del(&netfs->link);\r\nfscache_relinquish_cookie(netfs->primary_index, 0);\r\nup_write(&fscache_addremove_sem);\r\npr_notice("Netfs '%s' unregistered from caching\n",\r\nnetfs->name);\r\n_leave("");\r\n}

static int tonga_start_in_protection_mode(struct pp_smumgr *smumgr)\r\n{\r\nint result;\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_RESET_CNTL, rst_reg, 1);\r\nresult = smu7_upload_smu_firmware_image(smumgr);\r\nif (result)\r\nreturn result;\r\ncgs_write_ind_register(smumgr->device, CGS_IND_REG__SMC,\r\nixSMU_STATUS, 0);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_CLOCK_CNTL_0, ck_disable, 0);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_RESET_CNTL, rst_reg, 0);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMU_INPUT_DATA, AUTO_START, 1);\r\ncgs_write_ind_register(smumgr->device, CGS_IND_REG__SMC,\r\nixFIRMWARE_FLAGS, 0);\r\nSMUM_WAIT_VFPF_INDIRECT_FIELD(smumgr, SMC_IND,\r\nRCU_UC_EVENTS, INTERRUPTS_ENABLED, 1);\r\nsmu7_send_msg_to_smc_offset(smumgr);\r\nSMUM_WAIT_VFPF_INDIRECT_FIELD_UNEQUAL(smumgr, SMC_IND,\r\nSMU_STATUS, SMU_DONE, 0);\r\nif (1 != SMUM_READ_VFPF_INDIRECT_FIELD(smumgr->device,\r\nCGS_IND_REG__SMC, SMU_STATUS, SMU_PASS)) {\r\npr_err("SMU Firmware start failed\n");\r\nreturn -EINVAL;\r\n}\r\nSMUM_WAIT_VFPF_INDIRECT_FIELD(smumgr, SMC_IND,\r\nFIRMWARE_FLAGS, INTERRUPTS_ENABLED, 1);\r\nreturn 0;\r\n}\r\nstatic int tonga_start_in_non_protection_mode(struct pp_smumgr *smumgr)\r\n{\r\nint result = 0;\r\nSMUM_WAIT_VFPF_INDIRECT_FIELD_UNEQUAL(smumgr, SMC_IND,\r\nRCU_UC_EVENTS, boot_seq_done, 0);\r\ncgs_write_ind_register(smumgr->device, CGS_IND_REG__SMC,\r\nixFIRMWARE_FLAGS, 0);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_RESET_CNTL, rst_reg, 1);\r\nresult = smu7_upload_smu_firmware_image(smumgr);\r\nif (result != 0)\r\nreturn result;\r\nsmu7_program_jump_on_start(smumgr);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_CLOCK_CNTL_0, ck_disable, 0);\r\nSMUM_WRITE_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMC_SYSCON_RESET_CNTL, rst_reg, 0);\r\nSMUM_WAIT_VFPF_INDIRECT_FIELD(smumgr, SMC_IND,\r\nFIRMWARE_FLAGS, INTERRUPTS_ENABLED, 1);\r\nreturn result;\r\n}\r\nstatic int tonga_start_smu(struct pp_smumgr *smumgr)\r\n{\r\nint result;\r\nif (!(smu7_is_smc_ram_running(smumgr) ||\r\ncgs_is_virtualization_enabled(smumgr->device))) {\r\nif (0 == SMUM_READ_VFPF_INDIRECT_FIELD(smumgr->device, CGS_IND_REG__SMC,\r\nSMU_FIRMWARE, SMU_MODE)) {\r\nresult = tonga_start_in_non_protection_mode(smumgr);\r\nif (result)\r\nreturn result;\r\n} else {\r\nresult = tonga_start_in_protection_mode(smumgr);\r\nif (result)\r\nreturn result;\r\n}\r\n}\r\nresult = smu7_request_smu_load_fw(smumgr);\r\nreturn result;\r\n}\r\nstatic int tonga_smu_init(struct pp_smumgr *smumgr)\r\n{\r\nstruct tonga_smumgr *tonga_priv = NULL;\r\nint i;\r\ntonga_priv = kzalloc(sizeof(struct tonga_smumgr), GFP_KERNEL);\r\nif (tonga_priv == NULL)\r\nreturn -ENOMEM;\r\nsmumgr->backend = tonga_priv;\r\nif (smu7_init(smumgr))\r\nreturn -EINVAL;\r\nfor (i = 0; i < SMU72_MAX_LEVELS_GRAPHICS; i++)\r\ntonga_priv->activity_target[i] = 30;\r\nreturn 0;\r\n}

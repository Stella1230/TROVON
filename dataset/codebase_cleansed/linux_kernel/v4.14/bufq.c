void ia_css_queue_map_init(void)\r\n{\r\nunsigned int i, j;\r\nfor (i = 0; i < SH_CSS_MAX_SP_THREADS; i++) {\r\nfor (j = 0; j < SH_CSS_MAX_NUM_QUEUES; j++)\r\nqueue_availability[i][j] = true;\r\n}\r\nfor (i = 0; i < SH_CSS_MAX_SP_THREADS; i++) {\r\nfor (j = 0; j < IA_CSS_NUM_DYNAMIC_BUFFER_TYPE; j++)\r\nbuffer_type_to_queue_id_map[i][j] = SH_CSS_INVALID_QUEUE_ID;\r\n}\r\n}\r\nvoid ia_css_queue_map(\r\nunsigned int thread_id,\r\nenum ia_css_buffer_type buf_type,\r\nbool map)\r\n{\r\nassert(buf_type < IA_CSS_NUM_DYNAMIC_BUFFER_TYPE);\r\nassert(thread_id < SH_CSS_MAX_SP_THREADS);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_queue_map() enter: buf_type=%d, thread_id=%d\n", buf_type, thread_id);\r\nif (map)\r\nmap_buffer_type_to_queue_id(thread_id, buf_type);\r\nelse\r\nunmap_buffer_type_to_queue_id(thread_id, buf_type);\r\n}\r\nbool ia_css_query_internal_queue_id(\r\nenum ia_css_buffer_type buf_type,\r\nunsigned int thread_id,\r\nenum sh_css_queue_id *val)\r\n{\r\nIA_CSS_ENTER("buf_type=%d, thread_id=%d, val = %p", buf_type, thread_id, val);\r\nif ((val == NULL) || (thread_id >= SH_CSS_MAX_SP_THREADS) || (buf_type >= IA_CSS_NUM_DYNAMIC_BUFFER_TYPE)) {\r\nIA_CSS_LEAVE("return_val = false");\r\nreturn false;\r\n}\r\n*val = buffer_type_to_queue_id_map[thread_id][buf_type];\r\nif ((*val == SH_CSS_INVALID_QUEUE_ID) || (*val >= SH_CSS_MAX_NUM_QUEUES)) {\r\nIA_CSS_LOG("INVALID queue ID MAP = %d\n", *val);\r\nIA_CSS_LEAVE("return_val = false");\r\nreturn false;\r\n}\r\nIA_CSS_LEAVE("return_val = true");\r\nreturn true;\r\n}\r\nstatic void map_buffer_type_to_queue_id(\r\nunsigned int thread_id,\r\nenum ia_css_buffer_type buf_type)\r\n{\r\nunsigned int i;\r\nassert(thread_id < SH_CSS_MAX_SP_THREADS);\r\nassert(buf_type < IA_CSS_NUM_DYNAMIC_BUFFER_TYPE);\r\nassert(buffer_type_to_queue_id_map[thread_id][buf_type] == SH_CSS_INVALID_QUEUE_ID);\r\nif (buf_type == IA_CSS_BUFFER_TYPE_PARAMETER_SET) {\r\nassert(queue_availability[thread_id][IA_CSS_PARAMETER_SET_QUEUE_ID]);\r\nqueue_availability[thread_id][IA_CSS_PARAMETER_SET_QUEUE_ID] = false;\r\nbuffer_type_to_queue_id_map[thread_id][buf_type] = IA_CSS_PARAMETER_SET_QUEUE_ID;\r\nreturn;\r\n}\r\nif (buf_type == IA_CSS_BUFFER_TYPE_PER_FRAME_PARAMETER_SET) {\r\nassert(queue_availability[thread_id][IA_CSS_PER_FRAME_PARAMETER_SET_QUEUE_ID]);\r\nqueue_availability[thread_id][IA_CSS_PER_FRAME_PARAMETER_SET_QUEUE_ID] = false;\r\nbuffer_type_to_queue_id_map[thread_id][buf_type] = IA_CSS_PER_FRAME_PARAMETER_SET_QUEUE_ID;\r\nreturn;\r\n}\r\nfor (i = SH_CSS_QUEUE_C_ID; i < SH_CSS_MAX_NUM_QUEUES; i++) {\r\nif (queue_availability[thread_id][i] == true) {\r\nqueue_availability[thread_id][i] = false;\r\nbuffer_type_to_queue_id_map[thread_id][buf_type] = i;\r\nbreak;\r\n}\r\n}\r\nassert(i != SH_CSS_MAX_NUM_QUEUES);\r\nreturn;\r\n}\r\nstatic void unmap_buffer_type_to_queue_id(\r\nunsigned int thread_id,\r\nenum ia_css_buffer_type buf_type)\r\n{\r\nint queue_id;\r\nassert(thread_id < SH_CSS_MAX_SP_THREADS);\r\nassert(buf_type < IA_CSS_NUM_DYNAMIC_BUFFER_TYPE);\r\nassert(buffer_type_to_queue_id_map[thread_id][buf_type] != SH_CSS_INVALID_QUEUE_ID);\r\nqueue_id = buffer_type_to_queue_id_map[thread_id][buf_type];\r\nbuffer_type_to_queue_id_map[thread_id][buf_type] = SH_CSS_INVALID_QUEUE_ID;\r\nqueue_availability[thread_id][queue_id] = true;\r\n}\r\nstatic ia_css_queue_t *bufq_get_qhandle(\r\nenum sh_css_queue_type type,\r\nenum sh_css_queue_id id,\r\nint thread)\r\n{\r\nia_css_queue_t *q = NULL;\r\nswitch (type) {\r\ncase sh_css_host2sp_buffer_queue:\r\nif ((thread >= SH_CSS_MAX_SP_THREADS) || (thread < 0) ||\r\n(id == SH_CSS_INVALID_QUEUE_ID))\r\nbreak;\r\nq = &css_queues.host2sp_buffer_queue_handles[thread][id];\r\nbreak;\r\ncase sh_css_sp2host_buffer_queue:\r\nif (id == SH_CSS_INVALID_QUEUE_ID)\r\nbreak;\r\nq = &css_queues.sp2host_buffer_queue_handles[id];\r\nbreak;\r\ncase sh_css_host2sp_psys_event_queue:\r\nq = &css_queues.host2sp_psys_event_queue_handle;\r\nbreak;\r\ncase sh_css_sp2host_psys_event_queue:\r\nq = &css_queues.sp2host_psys_event_queue_handle;\r\nbreak;\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\ncase sh_css_host2sp_isys_event_queue:\r\nq = &css_queues.host2sp_isys_event_queue_handle;\r\nbreak;\r\ncase sh_css_sp2host_isys_event_queue:\r\nq = &css_queues.sp2host_isys_event_queue_handle;\r\nbreak;\r\n#endif\r\ncase sh_css_host2sp_tag_cmd_queue:\r\nq = &css_queues.host2sp_tag_cmd_queue_handle;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn q;\r\n}\r\nSTORAGE_CLASS_INLINE void\r\ninit_bufq(unsigned int desc_offset,\r\nunsigned int elems_offset,\r\nia_css_queue_t *handle)\r\n{\r\nconst struct ia_css_fw_info *fw;\r\nunsigned int q_base_addr;\r\nia_css_queue_remote_t remoteq;\r\nfw = &sh_css_sp_fw;\r\nq_base_addr = fw->info.sp.host_sp_queue;\r\nremoteq.location = IA_CSS_QUEUE_LOC_SP;\r\nremoteq.proc_id = SP0_ID;\r\nremoteq.cb_desc_addr = q_base_addr + desc_offset;\r\nremoteq.cb_elems_addr = q_base_addr + elems_offset;\r\nia_css_queue_remote_init(handle, &remoteq);\r\n}\r\nvoid ia_css_bufq_init(void)\r\n{\r\nint i, j;\r\nIA_CSS_ENTER_PRIVATE("");\r\nfor (i = 0; i < SH_CSS_MAX_SP_THREADS; i++)\r\nfor (j = 0; j < SH_CSS_MAX_NUM_QUEUES; j++) {\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, host2sp_buffer_queues_desc[i][j]),\r\n(uint32_t)offsetof(struct host_sp_queues, host2sp_buffer_queues_elems[i][j]),\r\n&css_queues.host2sp_buffer_queue_handles[i][j]);\r\n}\r\nfor (i = 0; i < SH_CSS_MAX_NUM_QUEUES; i++) {\r\ninit_bufq(offsetof(struct host_sp_queues, sp2host_buffer_queues_desc[i]),\r\noffsetof(struct host_sp_queues, sp2host_buffer_queues_elems[i]),\r\n&css_queues.sp2host_buffer_queue_handles[i]);\r\n}\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, host2sp_psys_event_queue_desc),\r\n(uint32_t)offsetof(struct host_sp_queues, host2sp_psys_event_queue_elems),\r\n&css_queues.host2sp_psys_event_queue_handle);\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, sp2host_psys_event_queue_desc),\r\n(uint32_t)offsetof(struct host_sp_queues, sp2host_psys_event_queue_elems),\r\n&css_queues.sp2host_psys_event_queue_handle);\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, host2sp_isys_event_queue_desc),\r\n(uint32_t)offsetof(struct host_sp_queues, host2sp_isys_event_queue_elems),\r\n&css_queues.host2sp_isys_event_queue_handle);\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, sp2host_isys_event_queue_desc),\r\n(uint32_t)offsetof(struct host_sp_queues, sp2host_isys_event_queue_elems),\r\n&css_queues.sp2host_isys_event_queue_handle);\r\ninit_bufq((uint32_t)offsetof(struct host_sp_queues, host2sp_tag_cmd_queue_desc),\r\n(uint32_t)offsetof(struct host_sp_queues, host2sp_tag_cmd_queue_elems),\r\n&css_queues.host2sp_tag_cmd_queue_handle);\r\n#endif\r\nIA_CSS_LEAVE_PRIVATE("");\r\n}\r\nenum ia_css_err ia_css_bufq_enqueue_buffer(\r\nint thread_index,\r\nint queue_id,\r\nuint32_t item)\r\n{\r\nenum ia_css_err return_err = IA_CSS_SUCCESS;\r\nia_css_queue_t *q;\r\nint error;\r\nIA_CSS_ENTER_PRIVATE("queue_id=%d", queue_id);\r\nif ((thread_index >= SH_CSS_MAX_SP_THREADS) || (thread_index < 0) ||\r\n(queue_id == SH_CSS_INVALID_QUEUE_ID))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nq = bufq_get_qhandle(sh_css_host2sp_buffer_queue,\r\nqueue_id,\r\nthread_index);\r\nif (q != NULL) {\r\nerror = ia_css_queue_enqueue(q, item);\r\nreturn_err = ia_css_convert_errno(error);\r\n} else {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn_err = IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nIA_CSS_LEAVE_ERR_PRIVATE(return_err);\r\nreturn return_err;\r\n}\r\nenum ia_css_err ia_css_bufq_dequeue_buffer(\r\nint queue_id,\r\nuint32_t *item)\r\n{\r\nenum ia_css_err return_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nIA_CSS_ENTER_PRIVATE("queue_id=%d", queue_id);\r\nif ((item == NULL) ||\r\n(queue_id <= SH_CSS_INVALID_QUEUE_ID) ||\r\n(queue_id >= SH_CSS_MAX_NUM_QUEUES)\r\n)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nq = bufq_get_qhandle(sh_css_sp2host_buffer_queue,\r\nqueue_id,\r\n-1);\r\nif (q != NULL) {\r\nerror = ia_css_queue_dequeue(q, item);\r\nreturn_err = ia_css_convert_errno(error);\r\n} else {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn_err = IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nIA_CSS_LEAVE_ERR_PRIVATE(return_err);\r\nreturn return_err;\r\n}\r\nenum ia_css_err ia_css_bufq_enqueue_psys_event(\r\nuint8_t evt_id,\r\nuint8_t evt_payload_0,\r\nuint8_t evt_payload_1,\r\nuint8_t evt_payload_2)\r\n{\r\nenum ia_css_err return_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nIA_CSS_ENTER_PRIVATE("evt_id=%d", evt_id);\r\nq = bufq_get_qhandle(sh_css_host2sp_psys_event_queue, -1, -1);\r\nif (NULL == q) {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nerror = ia_css_eventq_send(q,\r\nevt_id, evt_payload_0, evt_payload_1, evt_payload_2);\r\nreturn_err = ia_css_convert_errno(error);\r\nIA_CSS_LEAVE_ERR_PRIVATE(return_err);\r\nreturn return_err;\r\n}\r\nenum ia_css_err ia_css_bufq_dequeue_psys_event(\r\nuint8_t item[BUFQ_EVENT_SIZE])\r\n{\r\nenum ia_css_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nif (item == NULL)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nq = bufq_get_qhandle(sh_css_sp2host_psys_event_queue, -1, -1);\r\nif (NULL == q) {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nerror = ia_css_eventq_recv(q, item);\r\nreturn ia_css_convert_errno(error);\r\n}\r\nenum ia_css_err ia_css_bufq_dequeue_isys_event(\r\nuint8_t item[BUFQ_EVENT_SIZE])\r\n{\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\nenum ia_css_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nif (item == NULL)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nq = bufq_get_qhandle(sh_css_sp2host_isys_event_queue, -1, -1);\r\nif (q == NULL) {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nerror = ia_css_eventq_recv(q, item);\r\nreturn ia_css_convert_errno(error);\r\n#else\r\n(void)item;\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n#endif\r\n}\r\nenum ia_css_err ia_css_bufq_enqueue_isys_event(uint8_t evt_id)\r\n{\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\nenum ia_css_err return_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nIA_CSS_ENTER_PRIVATE("event_id=%d", evt_id);\r\nq = bufq_get_qhandle(sh_css_host2sp_isys_event_queue, -1, -1);\r\nif (q == NULL) {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nerror = ia_css_eventq_send(q, evt_id, 0, 0, 0);\r\nreturn_err = ia_css_convert_errno(error);\r\nIA_CSS_LEAVE_ERR_PRIVATE(return_err);\r\nreturn return_err;\r\n#else\r\n(void)evt_id;\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n#endif\r\n}\r\nenum ia_css_err ia_css_bufq_enqueue_tag_cmd(\r\nuint32_t item)\r\n{\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\nenum ia_css_err return_err;\r\nint error = 0;\r\nia_css_queue_t *q;\r\nIA_CSS_ENTER_PRIVATE("item=%d", item);\r\nq = bufq_get_qhandle(sh_css_host2sp_tag_cmd_queue, -1, -1);\r\nif (NULL == q) {\r\nIA_CSS_ERROR("queue is not initialized");\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nerror = ia_css_queue_enqueue(q, item);\r\nreturn_err = ia_css_convert_errno(error);\r\nIA_CSS_LEAVE_ERR_PRIVATE(return_err);\r\nreturn return_err;\r\n#else\r\n(void)item;\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n#endif\r\n}\r\nenum ia_css_err ia_css_bufq_deinit(void)\r\n{\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void bufq_dump_queue_info(const char *prefix, ia_css_queue_t *qhandle)\r\n{\r\nuint32_t free = 0, used = 0;\r\nassert(prefix != NULL && qhandle != NULL);\r\nia_css_queue_get_used_space(qhandle, &used);\r\nia_css_queue_get_free_space(qhandle, &free);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "%s: used=%u free=%u\n",\r\nprefix, used, free);\r\n}\r\nvoid ia_css_bufq_dump_queue_info(void)\r\n{\r\nint i, j;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "Queue Information:\n");\r\nfor (i = 0; i < SH_CSS_MAX_SP_THREADS; i++) {\r\nfor (j = 0; j < SH_CSS_MAX_NUM_QUEUES; j++) {\r\nsnprintf(prefix, BUFQ_DUMP_FILE_NAME_PREFIX_SIZE,\r\n"host2sp_buffer_queue[%u][%u]", i, j);\r\nbufq_dump_queue_info(prefix,\r\n&css_queues.host2sp_buffer_queue_handles[i][j]);\r\n}\r\n}\r\nfor (i = 0; i < SH_CSS_MAX_NUM_QUEUES; i++) {\r\nsnprintf(prefix, BUFQ_DUMP_FILE_NAME_PREFIX_SIZE,\r\n"sp2host_buffer_queue[%u]", i);\r\nbufq_dump_queue_info(prefix,\r\n&css_queues.sp2host_buffer_queue_handles[i]);\r\n}\r\nbufq_dump_queue_info("host2sp_psys_event",\r\n&css_queues.host2sp_psys_event_queue_handle);\r\nbufq_dump_queue_info("sp2host_psys_event",\r\n&css_queues.sp2host_psys_event_queue_handle);\r\n#if !defined(HAS_NO_INPUT_SYSTEM)\r\nbufq_dump_queue_info("host2sp_isys_event",\r\n&css_queues.host2sp_isys_event_queue_handle);\r\nbufq_dump_queue_info("sp2host_isys_event",\r\n&css_queues.sp2host_isys_event_queue_handle);\r\nbufq_dump_queue_info("host2sp_tag_cmd",\r\n&css_queues.host2sp_tag_cmd_queue_handle);\r\n#endif\r\n}

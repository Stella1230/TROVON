static int qcom_apcs_ipc_send_data(struct mbox_chan *chan, void *data)\r\n{\r\nstruct qcom_apcs_ipc *apcs = container_of(chan->mbox,\r\nstruct qcom_apcs_ipc, mbox);\r\nunsigned long idx = (unsigned long)chan->con_priv;\r\nwritel(BIT(idx), apcs->reg);\r\nreturn 0;\r\n}\r\nstatic int qcom_apcs_ipc_probe(struct platform_device *pdev)\r\n{\r\nstruct qcom_apcs_ipc *apcs;\r\nstruct resource *res;\r\nunsigned long offset;\r\nvoid __iomem *base;\r\nunsigned long i;\r\nint ret;\r\napcs = devm_kzalloc(&pdev->dev, sizeof(*apcs), GFP_KERNEL);\r\nif (!apcs)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\noffset = (unsigned long)of_device_get_match_data(&pdev->dev);\r\napcs->reg = base + offset;\r\nfor (i = 0; i < ARRAY_SIZE(apcs->mbox_chans); i++)\r\napcs->mbox_chans[i].con_priv = (void *)i;\r\napcs->mbox.dev = &pdev->dev;\r\napcs->mbox.ops = &qcom_apcs_ipc_ops;\r\napcs->mbox.chans = apcs->mbox_chans;\r\napcs->mbox.num_chans = ARRAY_SIZE(apcs->mbox_chans);\r\nret = mbox_controller_register(&apcs->mbox);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register APCS IPC controller\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, apcs);\r\nreturn 0;\r\n}\r\nstatic int qcom_apcs_ipc_remove(struct platform_device *pdev)\r\n{\r\nstruct qcom_apcs_ipc *apcs = platform_get_drvdata(pdev);\r\nmbox_controller_unregister(&apcs->mbox);\r\nreturn 0;\r\n}\r\nstatic int __init qcom_apcs_ipc_init(void)\r\n{\r\nreturn platform_driver_register(&qcom_apcs_ipc_driver);\r\n}\r\nstatic void __exit qcom_apcs_ipc_exit(void)\r\n{\r\nplatform_driver_unregister(&qcom_apcs_ipc_driver);\r\n}

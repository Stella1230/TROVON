static void xlr_resource_init(struct resource *res, int offset, int irq)\r\n{\r\nres->name = "gmac";\r\nres->start = CPHYSADDR(nlm_mmio_base(offset));\r\nres->end = res->start + 0xfff;\r\nres->flags = IORESOURCE_MEM;\r\nres++;\r\nres->name = "gmac";\r\nres->start = irq;\r\nres->end = irq;\r\nres->flags = IORESOURCE_IRQ;\r\n}\r\nstatic struct platform_device *gmac_controller2_init(void *gmac0_addr)\r\n{\r\nint mac;\r\nstatic struct xlr_net_data ndata1 = {\r\n.phy_interface = PHY_INTERFACE_MODE_SGMII,\r\n.rfr_station = FMN_STNID_GMAC1_FR_0,\r\n.bucket_size = xlr_board_fmn_config.bucket_size,\r\n.gmac_fmn_info = &xlr_board_fmn_config.gmac[1],\r\n};\r\nstatic struct platform_device xlr_net_dev1 = {\r\n.name = "xlr-net",\r\n.id = 1,\r\n.dev.platform_data = &ndata1,\r\n};\r\ngmac4_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GMAC_4_OFFSET)), 0xfff);\r\nndata1.serdes_addr = gmac4_addr;\r\nndata1.pcs_addr = gmac4_addr;\r\nndata1.mii_addr = gmac0_addr;\r\nndata1.gpio_addr = gpio_addr;\r\nndata1.cpu_mask = nlm_current_node()->coremask;\r\nxlr_net_dev1.resource = xlr_net1_res;\r\nfor (mac = 0; mac < 4; mac++) {\r\nndata1.tx_stnid[mac] = FMN_STNID_GMAC1_TX0 + mac;\r\nndata1.phy_addr[mac] = mac + 4 + 0x10;\r\nxlr_resource_init(&xlr_net1_res[mac * 2],\r\nxlr_gmac_offsets[mac + 4],\r\nxlr_gmac_irqs[mac + 4]);\r\n}\r\nxlr_net_dev1.num_resources = 8;\r\nreturn &xlr_net_dev1;\r\n}\r\nstatic void xls_gmac_init(void)\r\n{\r\nint mac;\r\nstruct platform_device *xlr_net_dev1;\r\nvoid __iomem *gmac0_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GMAC_0_OFFSET)), 0xfff);\r\nstatic struct xlr_net_data ndata0 = {\r\n.rfr_station = FMN_STNID_GMACRFR_0,\r\n.bucket_size = xlr_board_fmn_config.bucket_size,\r\n.gmac_fmn_info = &xlr_board_fmn_config.gmac[0],\r\n};\r\nstatic struct platform_device xlr_net_dev0 = {\r\n.name = "xlr-net",\r\n.id = 0,\r\n};\r\nxlr_net_dev0.dev.platform_data = &ndata0;\r\nndata0.serdes_addr = gmac0_addr;\r\nndata0.pcs_addr = gmac0_addr;\r\nndata0.mii_addr = gmac0_addr;\r\ngpio_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GPIO_OFFSET)), 0xfff);\r\nndata0.gpio_addr = gpio_addr;\r\nndata0.cpu_mask = nlm_current_node()->coremask;\r\nxlr_net_dev0.resource = xlr_net0_res;\r\nswitch (nlm_prom_info.board_major_version) {\r\ncase 12:\r\nndata0.phy_interface = PHY_INTERFACE_MODE_RGMII;\r\nndata0.tx_stnid[0] = FMN_STNID_GMAC0_TX0;\r\nndata0.phy_addr[0] = 0;\r\nxlr_net_dev0.num_resources = 2;\r\nxlr_resource_init(&xlr_net0_res[0], xlr_gmac_offsets[0],\r\nxlr_gmac_irqs[0]);\r\nplatform_device_register(&xlr_net_dev0);\r\nbreak;\r\ndefault:\r\nndata0.phy_interface = PHY_INTERFACE_MODE_SGMII;\r\nfor (mac = 0; mac < 4; mac++) {\r\nndata0.tx_stnid[mac] = FMN_STNID_GMAC0_TX0 + mac;\r\nndata0.phy_addr[mac] = mac + 0x10;\r\nxlr_resource_init(&xlr_net0_res[mac * 2],\r\nxlr_gmac_offsets[mac],\r\nxlr_gmac_irqs[mac]);\r\n}\r\nxlr_net_dev0.num_resources = 8;\r\nplatform_device_register(&xlr_net_dev0);\r\nxlr_net_dev1 = gmac_controller2_init(gmac0_addr);\r\nplatform_device_register(xlr_net_dev1);\r\n}\r\n}\r\nstatic void xlr_gmac_init(void)\r\n{\r\nint mac;\r\nstatic struct xlr_net_data ndata0 = {\r\n.phy_interface = PHY_INTERFACE_MODE_RGMII,\r\n.serdes_addr = NULL,\r\n.pcs_addr = NULL,\r\n.rfr_station = FMN_STNID_GMACRFR_0,\r\n.bucket_size = xlr_board_fmn_config.bucket_size,\r\n.gmac_fmn_info = &xlr_board_fmn_config.gmac[0],\r\n.gpio_addr = NULL,\r\n};\r\nstatic struct platform_device xlr_net_dev0 = {\r\n.name = "xlr-net",\r\n.id = 0,\r\n.dev.platform_data = &ndata0,\r\n};\r\nndata0.mii_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GMAC_0_OFFSET)), 0xfff);\r\nndata0.cpu_mask = nlm_current_node()->coremask;\r\nfor (mac = 0; mac < MAX_NUM_XLR_GMAC; mac++) {\r\nndata0.tx_stnid[mac] = FMN_STNID_GMAC0_TX0 + mac;\r\nndata0.phy_addr[mac] = mac;\r\nxlr_resource_init(&xlr_net0_res[mac * 2], xlr_gmac_offsets[mac],\r\nxlr_gmac_irqs[mac]);\r\n}\r\nxlr_net_dev0.num_resources = 8;\r\nxlr_net_dev0.resource = xlr_net0_res;\r\nplatform_device_register(&xlr_net_dev0);\r\n}\r\nstatic int __init xlr_net_init(void)\r\n{\r\nif (nlm_chip_is_xls())\r\nxls_gmac_init();\r\nelse\r\nxlr_gmac_init();\r\nreturn 0;\r\n}

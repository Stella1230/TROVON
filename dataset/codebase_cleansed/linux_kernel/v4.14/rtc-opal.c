static void opal_to_tm(u32 y_m_d, u64 h_m_s_ms, struct rtc_time *tm)\r\n{\r\ntm->tm_year = ((bcd2bin(y_m_d >> 24) * 100) +\r\nbcd2bin((y_m_d >> 16) & 0xff)) - 1900;\r\ntm->tm_mon = bcd2bin((y_m_d >> 8) & 0xff) - 1;\r\ntm->tm_mday = bcd2bin(y_m_d & 0xff);\r\ntm->tm_hour = bcd2bin((h_m_s_ms >> 56) & 0xff);\r\ntm->tm_min = bcd2bin((h_m_s_ms >> 48) & 0xff);\r\ntm->tm_sec = bcd2bin((h_m_s_ms >> 40) & 0xff);\r\ntm->tm_wday = -1;\r\n}\r\nstatic void tm_to_opal(struct rtc_time *tm, u32 *y_m_d, u64 *h_m_s_ms)\r\n{\r\n*y_m_d |= ((u32)bin2bcd((tm->tm_year + 1900) / 100)) << 24;\r\n*y_m_d |= ((u32)bin2bcd((tm->tm_year + 1900) % 100)) << 16;\r\n*y_m_d |= ((u32)bin2bcd((tm->tm_mon + 1))) << 8;\r\n*y_m_d |= ((u32)bin2bcd(tm->tm_mday));\r\n*h_m_s_ms |= ((u64)bin2bcd(tm->tm_hour)) << 56;\r\n*h_m_s_ms |= ((u64)bin2bcd(tm->tm_min)) << 48;\r\n*h_m_s_ms |= ((u64)bin2bcd(tm->tm_sec)) << 40;\r\n}\r\nstatic int opal_get_rtc_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nlong rc = OPAL_BUSY;\r\nu32 y_m_d;\r\nu64 h_m_s_ms;\r\n__be32 __y_m_d;\r\n__be64 __h_m_s_ms;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_read(&__y_m_d, &__h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse\r\nmsleep(10);\r\n}\r\nif (rc != OPAL_SUCCESS)\r\nreturn -EIO;\r\ny_m_d = be32_to_cpu(__y_m_d);\r\nh_m_s_ms = be64_to_cpu(__h_m_s_ms);\r\nopal_to_tm(y_m_d, h_m_s_ms, tm);\r\nreturn 0;\r\n}\r\nstatic int opal_set_rtc_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nlong rc = OPAL_BUSY;\r\nu32 y_m_d = 0;\r\nu64 h_m_s_ms = 0;\r\ntm_to_opal(tm, &y_m_d, &h_m_s_ms);\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_write(y_m_d, h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse\r\nmsleep(10);\r\n}\r\nreturn rc == OPAL_SUCCESS ? 0 : -EIO;\r\n}\r\nstatic int opal_get_tpo_time(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\n__be32 __y_m_d, __h_m;\r\nstruct opal_msg msg;\r\nint rc, token;\r\nu64 h_m_s_ms;\r\nu32 y_m_d;\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\nif (token != -ERESTARTSYS)\r\npr_err("Failed to get the async token\n");\r\nreturn token;\r\n}\r\nrc = opal_tpo_read(token, &__y_m_d, &__h_m);\r\nif (rc != OPAL_ASYNC_COMPLETION) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = opal_async_wait_response(token, &msg);\r\nif (rc) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = opal_get_async_rc(msg);\r\nif (rc != OPAL_SUCCESS) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ny_m_d = be32_to_cpu(__y_m_d);\r\nh_m_s_ms = ((u64)be32_to_cpu(__h_m) << 32);\r\nif (y_m_d == 0 && h_m_s_ms == 0) {\r\npr_debug("No alarm is set\n");\r\nrc = -ENOENT;\r\ngoto exit;\r\n} else {\r\npr_debug("Alarm set to %x %llx\n", y_m_d, h_m_s_ms);\r\n}\r\nopal_to_tm(y_m_d, h_m_s_ms, &alarm->time);\r\nexit:\r\nopal_async_release_token(token);\r\nreturn rc;\r\n}\r\nstatic int opal_set_tpo_time(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nu64 h_m_s_ms = 0;\r\nstruct opal_msg msg;\r\nu32 y_m_d = 0;\r\nint token, rc;\r\nif (alarm->enabled) {\r\ntm_to_opal(&alarm->time, &y_m_d, &h_m_s_ms);\r\npr_debug("Alarm set to %x %llx\n", y_m_d, h_m_s_ms);\r\n} else {\r\npr_debug("Alarm getting disabled\n");\r\n}\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\nif (token != -ERESTARTSYS)\r\npr_err("Failed to get the async token\n");\r\nreturn token;\r\n}\r\nrc = opal_tpo_write(token, y_m_d,\r\n(u32)((h_m_s_ms >> 32) & 0xffff0000));\r\nif (rc != OPAL_ASYNC_COMPLETION) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = opal_async_wait_response(token, &msg);\r\nif (rc) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = opal_get_async_rc(msg);\r\nif (rc != OPAL_SUCCESS)\r\nrc = -EIO;\r\nexit:\r\nopal_async_release_token(token);\r\nreturn rc;\r\n}\r\nint opal_tpo_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct rtc_wkalrm alarm = { .enabled = 0 };\r\nreturn enabled ? 0 : opal_set_tpo_time(dev, &alarm);\r\n}\r\nstatic int opal_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nif (pdev->dev.of_node &&\r\n(of_property_read_bool(pdev->dev.of_node, "wakeup-source") ||\r\nof_property_read_bool(pdev->dev.of_node, "has-tpo"))) {\r\ndevice_set_wakeup_capable(&pdev->dev, true);\r\nopal_rtc_ops.read_alarm = opal_get_tpo_time;\r\nopal_rtc_ops.set_alarm = opal_set_tpo_time;\r\nopal_rtc_ops.alarm_irq_enable = opal_tpo_alarm_irq_enable;\r\n}\r\nrtc = devm_rtc_device_register(&pdev->dev, DRVNAME, &opal_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nrtc->uie_unsupported = 1;\r\nreturn 0;\r\n}\r\nstatic int __init opal_rtc_init(void)\r\n{\r\nif (!firmware_has_feature(FW_FEATURE_OPAL))\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&opal_rtc_driver);\r\n}\r\nstatic void __exit opal_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&opal_rtc_driver);\r\n}

int ufshcd_dwc_dme_set_attrs(struct ufs_hba *hba,\r\nconst struct ufshcd_dme_attr_val *v, int n)\r\n{\r\nint ret = 0;\r\nint attr_node = 0;\r\nfor (attr_node = 0; attr_node < n; attr_node++) {\r\nret = ufshcd_dme_set_attr(hba, v[attr_node].attr_sel,\r\nATTR_SET_NOR, v[attr_node].mib_val, v[attr_node].peer);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ufshcd_dwc_program_clk_div(struct ufs_hba *hba, u32 divider_val)\r\n{\r\nufshcd_writel(hba, divider_val, DWC_UFS_REG_HCLKDIV);\r\n}\r\nstatic int ufshcd_dwc_link_is_up(struct ufs_hba *hba)\r\n{\r\nint dme_result = 0;\r\nufshcd_dme_get(hba, UIC_ARG_MIB(VS_POWERSTATE), &dme_result);\r\nif (dme_result == UFSHCD_LINK_IS_UP) {\r\nufshcd_set_link_active(hba);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ufshcd_dwc_connection_setup(struct ufs_hba *hba)\r\n{\r\nconst struct ufshcd_dme_attr_val setup_attrs[] = {\r\n{ UIC_ARG_MIB(T_CONNECTIONSTATE), 0, DME_LOCAL },\r\n{ UIC_ARG_MIB(N_DEVICEID), 0, DME_LOCAL },\r\n{ UIC_ARG_MIB(N_DEVICEID_VALID), 0, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_PEERDEVICEID), 1, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_PEERCPORTID), 0, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_TRAFFICCLASS), 0, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_CPORTFLAGS), 0x6, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_CPORTMODE), 1, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_CONNECTIONSTATE), 1, DME_LOCAL },\r\n{ UIC_ARG_MIB(T_CONNECTIONSTATE), 0, DME_PEER },\r\n{ UIC_ARG_MIB(N_DEVICEID), 1, DME_PEER },\r\n{ UIC_ARG_MIB(N_DEVICEID_VALID), 1, DME_PEER },\r\n{ UIC_ARG_MIB(T_PEERDEVICEID), 1, DME_PEER },\r\n{ UIC_ARG_MIB(T_PEERCPORTID), 0, DME_PEER },\r\n{ UIC_ARG_MIB(T_TRAFFICCLASS), 0, DME_PEER },\r\n{ UIC_ARG_MIB(T_CPORTFLAGS), 0x6, DME_PEER },\r\n{ UIC_ARG_MIB(T_CPORTMODE), 1, DME_PEER },\r\n{ UIC_ARG_MIB(T_CONNECTIONSTATE), 1, DME_PEER }\r\n};\r\nreturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs, ARRAY_SIZE(setup_attrs));\r\n}\r\nint ufshcd_dwc_link_startup_notify(struct ufs_hba *hba,\r\nenum ufs_notify_change_status status)\r\n{\r\nint err = 0;\r\nif (status == PRE_CHANGE) {\r\nufshcd_dwc_program_clk_div(hba, DWC_UFS_REG_HCLKDIV_DIV_125);\r\nif (hba->vops->phy_initialization) {\r\nerr = hba->vops->phy_initialization(hba);\r\nif (err) {\r\ndev_err(hba->dev, "Phy setup failed (%d)\n",\r\nerr);\r\ngoto out;\r\n}\r\n}\r\n} else {\r\nerr = ufshcd_dwc_link_is_up(hba);\r\nif (err) {\r\ndev_err(hba->dev, "Link is not up\n");\r\ngoto out;\r\n}\r\nerr = ufshcd_dwc_connection_setup(hba);\r\nif (err)\r\ndev_err(hba->dev, "Connection setup failed (%d)\n",\r\nerr);\r\n}\r\nout:\r\nreturn err;\r\n}

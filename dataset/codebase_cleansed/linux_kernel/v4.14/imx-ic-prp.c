static inline struct prp_priv *sd_to_priv(struct v4l2_subdev *sd)\r\n{\r\nstruct imx_ic_priv *ic_priv = v4l2_get_subdevdata(sd);\r\nreturn ic_priv->prp_priv;\r\n}\r\nstatic int prp_start(struct prp_priv *priv)\r\n{\r\nstruct imx_ic_priv *ic_priv = priv->ic_priv;\r\nbool src_is_vdic;\r\npriv->ipu = priv->md->ipu[ic_priv->ipu_id];\r\nsrc_is_vdic = !!(priv->src_sd->grp_id & IMX_MEDIA_GRP_ID_VDIC);\r\nipu_set_ic_src_mux(priv->ipu, priv->csi_id, src_is_vdic);\r\nreturn 0;\r\n}\r\nstatic void prp_stop(struct prp_priv *priv)\r\n{\r\n}\r\nstatic struct v4l2_mbus_framefmt *\r\n__prp_get_fmt(struct prp_priv *priv, struct v4l2_subdev_pad_config *cfg,\r\nunsigned int pad, enum v4l2_subdev_format_whence which)\r\n{\r\nstruct imx_ic_priv *ic_priv = priv->ic_priv;\r\nif (which == V4L2_SUBDEV_FORMAT_TRY)\r\nreturn v4l2_subdev_get_try_format(&ic_priv->sd, cfg, pad);\r\nelse\r\nreturn &priv->format_mbus;\r\n}\r\nstatic int prp_enum_mbus_code(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nstruct v4l2_mbus_framefmt *infmt;\r\nint ret = 0;\r\nmutex_lock(&priv->lock);\r\nswitch (code->pad) {\r\ncase PRP_SINK_PAD:\r\nret = imx_media_enum_ipu_format(&code->code, code->index,\r\nCS_SEL_ANY);\r\nbreak;\r\ncase PRP_SRC_PAD_PRPENC:\r\ncase PRP_SRC_PAD_PRPVF:\r\nif (code->index != 0) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ninfmt = __prp_get_fmt(priv, cfg, PRP_SINK_PAD, code->which);\r\ncode->code = infmt->code;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_get_fmt(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *sdformat)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nstruct v4l2_mbus_framefmt *fmt;\r\nint ret = 0;\r\nif (sdformat->pad >= PRP_NUM_PADS)\r\nreturn -EINVAL;\r\nmutex_lock(&priv->lock);\r\nfmt = __prp_get_fmt(priv, cfg, sdformat->pad, sdformat->which);\r\nif (!fmt) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nsdformat->format = *fmt;\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_set_fmt(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *sdformat)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nstruct v4l2_mbus_framefmt *fmt, *infmt;\r\nconst struct imx_media_pixfmt *cc;\r\nint ret = 0;\r\nu32 code;\r\nif (sdformat->pad >= PRP_NUM_PADS)\r\nreturn -EINVAL;\r\nmutex_lock(&priv->lock);\r\nif (priv->stream_count > 0) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ninfmt = __prp_get_fmt(priv, cfg, PRP_SINK_PAD, sdformat->which);\r\nswitch (sdformat->pad) {\r\ncase PRP_SINK_PAD:\r\nv4l_bound_align_image(&sdformat->format.width, MIN_W, MAX_W,\r\nW_ALIGN, &sdformat->format.height,\r\nMIN_H, MAX_H, H_ALIGN, S_ALIGN);\r\ncc = imx_media_find_ipu_format(sdformat->format.code,\r\nCS_SEL_ANY);\r\nif (!cc) {\r\nimx_media_enum_ipu_format(&code, 0, CS_SEL_ANY);\r\ncc = imx_media_find_ipu_format(code, CS_SEL_ANY);\r\nsdformat->format.code = cc->codes[0];\r\n}\r\nimx_media_fill_default_mbus_fields(&sdformat->format, infmt,\r\ntrue);\r\nbreak;\r\ncase PRP_SRC_PAD_PRPENC:\r\ncase PRP_SRC_PAD_PRPVF:\r\nsdformat->format = *infmt;\r\nbreak;\r\n}\r\nfmt = __prp_get_fmt(priv, cfg, sdformat->pad, sdformat->which);\r\n*fmt = sdformat->format;\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_link_setup(struct media_entity *entity,\r\nconst struct media_pad *local,\r\nconst struct media_pad *remote, u32 flags)\r\n{\r\nstruct v4l2_subdev *sd = media_entity_to_v4l2_subdev(entity);\r\nstruct imx_ic_priv *ic_priv = v4l2_get_subdevdata(sd);\r\nstruct prp_priv *priv = ic_priv->prp_priv;\r\nstruct v4l2_subdev *remote_sd;\r\nint ret = 0;\r\ndev_dbg(ic_priv->dev, "link setup %s -> %s", remote->entity->name,\r\nlocal->entity->name);\r\nremote_sd = media_entity_to_v4l2_subdev(remote->entity);\r\nmutex_lock(&priv->lock);\r\nif (local->flags & MEDIA_PAD_FL_SINK) {\r\nif (flags & MEDIA_LNK_FL_ENABLED) {\r\nif (priv->src_sd) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nif (priv->sink_sd_prpenc && (remote_sd->grp_id &\r\nIMX_MEDIA_GRP_ID_VDIC)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\npriv->src_sd = remote_sd;\r\n} else {\r\npriv->src_sd = NULL;\r\n}\r\ngoto out;\r\n}\r\nif (flags & MEDIA_LNK_FL_ENABLED) {\r\nswitch (local->index) {\r\ncase PRP_SRC_PAD_PRPENC:\r\nif (priv->sink_sd_prpenc) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nif (priv->src_sd && (priv->src_sd->grp_id &\r\nIMX_MEDIA_GRP_ID_VDIC)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\npriv->sink_sd_prpenc = remote_sd;\r\nbreak;\r\ncase PRP_SRC_PAD_PRPVF:\r\nif (priv->sink_sd_prpvf) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\npriv->sink_sd_prpvf = remote_sd;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\n} else {\r\nswitch (local->index) {\r\ncase PRP_SRC_PAD_PRPENC:\r\npriv->sink_sd_prpenc = NULL;\r\nbreak;\r\ncase PRP_SRC_PAD_PRPVF:\r\npriv->sink_sd_prpvf = NULL;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\n}\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_link_validate(struct v4l2_subdev *sd,\r\nstruct media_link *link,\r\nstruct v4l2_subdev_format *source_fmt,\r\nstruct v4l2_subdev_format *sink_fmt)\r\n{\r\nstruct imx_ic_priv *ic_priv = v4l2_get_subdevdata(sd);\r\nstruct prp_priv *priv = ic_priv->prp_priv;\r\nstruct imx_media_subdev *csi;\r\nint ret;\r\nret = v4l2_subdev_link_validate_default(sd, link,\r\nsource_fmt, sink_fmt);\r\nif (ret)\r\nreturn ret;\r\ncsi = imx_media_find_upstream_subdev(priv->md, &ic_priv->sd.entity,\r\nIMX_MEDIA_GRP_ID_CSI);\r\nif (IS_ERR(csi))\r\ncsi = NULL;\r\nmutex_lock(&priv->lock);\r\nif (priv->src_sd->grp_id & IMX_MEDIA_GRP_ID_VDIC) {\r\nif (priv->sink_sd_prpenc)\r\nret = -EINVAL;\r\ngoto out;\r\n} else {\r\nif (!csi) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\n}\r\nif (csi) {\r\nswitch (csi->sd->grp_id) {\r\ncase IMX_MEDIA_GRP_ID_CSI0:\r\npriv->csi_id = 0;\r\nbreak;\r\ncase IMX_MEDIA_GRP_ID_CSI1:\r\npriv->csi_id = 1;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\n} else {\r\npriv->csi_id = 0;\r\n}\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_s_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct imx_ic_priv *ic_priv = v4l2_get_subdevdata(sd);\r\nstruct prp_priv *priv = ic_priv->prp_priv;\r\nint ret = 0;\r\nmutex_lock(&priv->lock);\r\nif (!priv->src_sd || (!priv->sink_sd_prpenc && !priv->sink_sd_prpvf)) {\r\nret = -EPIPE;\r\ngoto out;\r\n}\r\nif (priv->stream_count != !enable)\r\ngoto update_count;\r\ndev_dbg(ic_priv->dev, "stream %s\n", enable ? "ON" : "OFF");\r\nif (enable)\r\nret = prp_start(priv);\r\nelse\r\nprp_stop(priv);\r\nif (ret)\r\ngoto out;\r\nret = v4l2_subdev_call(priv->src_sd, video, s_stream, enable);\r\nret = (ret && ret != -ENOIOCTLCMD) ? ret : 0;\r\nif (ret) {\r\nif (enable)\r\nprp_stop(priv);\r\ngoto out;\r\n}\r\nupdate_count:\r\npriv->stream_count += enable ? 1 : -1;\r\nif (priv->stream_count < 0)\r\npriv->stream_count = 0;\r\nout:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int prp_g_frame_interval(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_frame_interval *fi)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nif (fi->pad >= PRP_NUM_PADS)\r\nreturn -EINVAL;\r\nmutex_lock(&priv->lock);\r\nfi->interval = priv->frame_interval;\r\nmutex_unlock(&priv->lock);\r\nreturn 0;\r\n}\r\nstatic int prp_s_frame_interval(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_frame_interval *fi)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nif (fi->pad >= PRP_NUM_PADS)\r\nreturn -EINVAL;\r\nmutex_lock(&priv->lock);\r\npriv->frame_interval = fi->interval;\r\nmutex_unlock(&priv->lock);\r\nreturn 0;\r\n}\r\nstatic int prp_registered(struct v4l2_subdev *sd)\r\n{\r\nstruct prp_priv *priv = sd_to_priv(sd);\r\nint i, ret;\r\nu32 code;\r\npriv->md = dev_get_drvdata(sd->v4l2_dev->dev);\r\nfor (i = 0; i < PRP_NUM_PADS; i++) {\r\npriv->pad[i].flags = (i == PRP_SINK_PAD) ?\r\nMEDIA_PAD_FL_SINK : MEDIA_PAD_FL_SOURCE;\r\n}\r\npriv->frame_interval.numerator = 1;\r\npriv->frame_interval.denominator = 30;\r\nimx_media_enum_ipu_format(&code, 0, CS_SEL_YUV);\r\nret = imx_media_init_mbus_fmt(&priv->format_mbus, 640, 480, code,\r\nV4L2_FIELD_NONE, NULL);\r\nif (ret)\r\nreturn ret;\r\nreturn media_entity_pads_init(&sd->entity, PRP_NUM_PADS, priv->pad);\r\n}\r\nstatic int prp_init(struct imx_ic_priv *ic_priv)\r\n{\r\nstruct prp_priv *priv;\r\npriv = devm_kzalloc(ic_priv->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nmutex_init(&priv->lock);\r\nic_priv->prp_priv = priv;\r\npriv->ic_priv = ic_priv;\r\nreturn 0;\r\n}\r\nstatic void prp_remove(struct imx_ic_priv *ic_priv)\r\n{\r\nstruct prp_priv *priv = ic_priv->prp_priv;\r\nmutex_destroy(&priv->lock);\r\n}

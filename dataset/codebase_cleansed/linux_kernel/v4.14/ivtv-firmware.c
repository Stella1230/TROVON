static int load_fw_direct(const char *fn, volatile u8 __iomem *mem, struct ivtv *itv, long size)\r\n{\r\nconst struct firmware *fw = NULL;\r\nint retries = 3;\r\nretry:\r\nif (retries && request_firmware(&fw, fn, &itv->pdev->dev) == 0) {\r\nint i;\r\nvolatile u32 __iomem *dst = (volatile u32 __iomem *)mem;\r\nconst u32 *src = (const u32 *)fw->data;\r\nif (fw->size != size) {\r\nIVTV_INFO("Retry: file loaded was not %s (expected size %ld, got %zu)\n", fn, size, fw->size);\r\nrelease_firmware(fw);\r\nretries--;\r\ngoto retry;\r\n}\r\nfor (i = 0; i < fw->size; i += 4) {\r\n__raw_writel(*src, dst);\r\ndst++;\r\nsrc++;\r\n}\r\nIVTV_INFO("Loaded %s firmware (%zu bytes)\n", fn, fw->size);\r\nrelease_firmware(fw);\r\nreturn size;\r\n}\r\nIVTV_ERR("Unable to open firmware %s (must be %ld bytes)\n", fn, size);\r\nIVTV_ERR("Did you put the firmware in the hotplug firmware directory?\n");\r\nreturn -ENOMEM;\r\n}\r\nvoid ivtv_halt_firmware(struct ivtv *itv)\r\n{\r\nIVTV_DEBUG_INFO("Preparing for firmware halt.\n");\r\nif (itv->has_cx23415 && itv->dec_mbox.mbox)\r\nivtv_vapi(itv, CX2341X_DEC_HALT_FW, 0);\r\nif (itv->enc_mbox.mbox)\r\nivtv_vapi(itv, CX2341X_ENC_HALT_FW, 0);\r\nivtv_msleep_timeout(10, 0);\r\nitv->enc_mbox.mbox = itv->dec_mbox.mbox = NULL;\r\nIVTV_DEBUG_INFO("Stopping VDM\n");\r\nwrite_reg(IVTV_CMD_VDM_STOP, IVTV_REG_VDM);\r\nIVTV_DEBUG_INFO("Stopping AO\n");\r\nwrite_reg(IVTV_CMD_AO_STOP, IVTV_REG_AO);\r\nIVTV_DEBUG_INFO("pinging (?) APU\n");\r\nwrite_reg(IVTV_CMD_APU_PING, IVTV_REG_APU);\r\nIVTV_DEBUG_INFO("Stopping VPU\n");\r\nif (!itv->has_cx23415)\r\nwrite_reg(IVTV_CMD_VPU_STOP16, IVTV_REG_VPU);\r\nelse\r\nwrite_reg(IVTV_CMD_VPU_STOP15, IVTV_REG_VPU);\r\nIVTV_DEBUG_INFO("Resetting Hw Blocks\n");\r\nwrite_reg(IVTV_CMD_HW_BLOCKS_RST, IVTV_REG_HW_BLOCKS);\r\nIVTV_DEBUG_INFO("Stopping SPU\n");\r\nwrite_reg(IVTV_CMD_SPU_STOP, IVTV_REG_SPU);\r\nivtv_msleep_timeout(10, 0);\r\nIVTV_DEBUG_INFO("init Encoder SDRAM pre-charge\n");\r\nwrite_reg(IVTV_CMD_SDRAM_PRECHARGE_INIT, IVTV_REG_ENC_SDRAM_PRECHARGE);\r\nIVTV_DEBUG_INFO("init Encoder SDRAM refresh to 1us\n");\r\nwrite_reg(IVTV_CMD_SDRAM_REFRESH_INIT, IVTV_REG_ENC_SDRAM_REFRESH);\r\nif (itv->has_cx23415) {\r\nIVTV_DEBUG_INFO("init Decoder SDRAM pre-charge\n");\r\nwrite_reg(IVTV_CMD_SDRAM_PRECHARGE_INIT, IVTV_REG_DEC_SDRAM_PRECHARGE);\r\nIVTV_DEBUG_INFO("init Decoder SDRAM refresh to 1us\n");\r\nwrite_reg(IVTV_CMD_SDRAM_REFRESH_INIT, IVTV_REG_DEC_SDRAM_REFRESH);\r\n}\r\nIVTV_DEBUG_INFO("Sleeping for %dms\n", IVTV_SDRAM_SLEEPTIME);\r\nivtv_msleep_timeout(IVTV_SDRAM_SLEEPTIME, 0);\r\n}\r\nvoid ivtv_firmware_versions(struct ivtv *itv)\r\n{\r\nu32 data[CX2341X_MBOX_MAX_DATA];\r\nivtv_vapi_result(itv, data, CX2341X_ENC_GET_VERSION, 0);\r\nIVTV_INFO("Encoder revision: 0x%08x\n", data[0]);\r\nif (data[0] != 0x02060039)\r\nIVTV_WARN("Recommended firmware version is 0x02060039.\n");\r\nif (itv->has_cx23415) {\r\nivtv_vapi_result(itv, data, CX2341X_DEC_GET_VERSION, 0);\r\nIVTV_INFO("Decoder revision: 0x%08x\n", data[0]);\r\n}\r\n}\r\nstatic int ivtv_firmware_copy(struct ivtv *itv)\r\n{\r\nIVTV_DEBUG_INFO("Loading encoder image\n");\r\nif (load_fw_direct(CX2341X_FIRM_ENC_FILENAME,\r\nitv->enc_mem, itv, IVTV_FW_ENC_SIZE) != IVTV_FW_ENC_SIZE) {\r\nIVTV_DEBUG_WARN("failed loading encoder firmware\n");\r\nreturn -3;\r\n}\r\nif (!itv->has_cx23415)\r\nreturn 0;\r\nIVTV_DEBUG_INFO("Loading decoder image\n");\r\nif (load_fw_direct(CX2341X_FIRM_DEC_FILENAME,\r\nitv->dec_mem, itv, IVTV_FW_DEC_SIZE) != IVTV_FW_DEC_SIZE) {\r\nIVTV_DEBUG_WARN("failed loading decoder firmware\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic volatile struct ivtv_mailbox __iomem *ivtv_search_mailbox(const volatile u8 __iomem *mem, u32 size)\r\n{\r\nint i;\r\nfor (i = 0; i < size; i += 0x100) {\r\nif (readl(mem + i) == 0x12345678 &&\r\nreadl(mem + i + 4) == 0x34567812 &&\r\nreadl(mem + i + 8) == 0x56781234 &&\r\nreadl(mem + i + 12) == 0x78123456) {\r\nreturn (volatile struct ivtv_mailbox __iomem *)(mem + i + 16);\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nint ivtv_firmware_init(struct ivtv *itv)\r\n{\r\nint err;\r\nivtv_halt_firmware(itv);\r\nerr = ivtv_firmware_copy(itv);\r\nif (err) {\r\nIVTV_DEBUG_WARN("Error %d loading firmware\n", err);\r\nreturn err;\r\n}\r\nwrite_reg(read_reg(IVTV_REG_SPU) & IVTV_MASK_SPU_ENABLE, IVTV_REG_SPU);\r\nivtv_msleep_timeout(100, 0);\r\nif (itv->has_cx23415)\r\nwrite_reg(read_reg(IVTV_REG_VPU) & IVTV_MASK_VPU_ENABLE15, IVTV_REG_VPU);\r\nelse\r\nwrite_reg(read_reg(IVTV_REG_VPU) & IVTV_MASK_VPU_ENABLE16, IVTV_REG_VPU);\r\nivtv_msleep_timeout(100, 0);\r\nitv->enc_mbox.mbox = ivtv_search_mailbox(itv->enc_mem, IVTV_ENCODER_SIZE);\r\nif (itv->enc_mbox.mbox == NULL)\r\nIVTV_ERR("Encoder mailbox not found\n");\r\nelse if (ivtv_vapi(itv, CX2341X_ENC_PING_FW, 0)) {\r\nIVTV_ERR("Encoder firmware dead!\n");\r\nitv->enc_mbox.mbox = NULL;\r\n}\r\nif (itv->enc_mbox.mbox == NULL)\r\nreturn -ENODEV;\r\nif (!itv->has_cx23415)\r\nreturn 0;\r\nitv->dec_mbox.mbox = ivtv_search_mailbox(itv->dec_mem, IVTV_DECODER_SIZE);\r\nif (itv->dec_mbox.mbox == NULL) {\r\nIVTV_ERR("Decoder mailbox not found\n");\r\n} else if (itv->has_cx23415 && ivtv_vapi(itv, CX2341X_DEC_PING_FW, 0)) {\r\nIVTV_ERR("Decoder firmware dead!\n");\r\nitv->dec_mbox.mbox = NULL;\r\n} else {\r\nivtv_yuv_filter_check(itv);\r\n}\r\nreturn itv->dec_mbox.mbox ? 0 : -ENODEV;\r\n}\r\nvoid ivtv_init_mpeg_decoder(struct ivtv *itv)\r\n{\r\nu32 data[CX2341X_MBOX_MAX_DATA];\r\nlong readbytes;\r\nvolatile u8 __iomem *mem_offset;\r\ndata[0] = 0;\r\ndata[1] = itv->cxhdl.width;\r\ndata[2] = itv->cxhdl.height;\r\ndata[3] = itv->cxhdl.audio_properties;\r\nif (ivtv_api(itv, CX2341X_DEC_SET_DECODER_SOURCE, 4, data)) {\r\nIVTV_ERR("ivtv_init_mpeg_decoder failed to set decoder source\n");\r\nreturn;\r\n}\r\nif (ivtv_vapi(itv, CX2341X_DEC_START_PLAYBACK, 2, 0, 1) != 0) {\r\nIVTV_ERR("ivtv_init_mpeg_decoder failed to start playback\n");\r\nreturn;\r\n}\r\nivtv_api_get_data(&itv->dec_mbox, IVTV_MBOX_DMA, 2, data);\r\nmem_offset = itv->dec_mem + data[1];\r\nif ((readbytes = load_fw_direct(IVTV_DECODE_INIT_MPEG_FILENAME,\r\nmem_offset, itv, IVTV_DECODE_INIT_MPEG_SIZE)) <= 0) {\r\nIVTV_DEBUG_WARN("failed to read mpeg decoder initialisation file %s\n",\r\nIVTV_DECODE_INIT_MPEG_FILENAME);\r\n} else {\r\nivtv_vapi(itv, CX2341X_DEC_SCHED_DMA_FROM_HOST, 3, 0, readbytes, 0);\r\nivtv_msleep_timeout(100, 0);\r\n}\r\nivtv_vapi(itv, CX2341X_DEC_STOP_PLAYBACK, 4, 0, 0, 0, 1);\r\n}\r\nstatic int ivtv_firmware_restart(struct ivtv *itv)\r\n{\r\nint rc = 0;\r\nv4l2_std_id std;\r\nif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT)\r\nivtv_call_hw(itv, IVTV_HW_SAA7127, video, s_routing,\r\nSAA7127_INPUT_TYPE_TEST_IMAGE,\r\nitv->card->video_outputs[itv->active_output].video_output,\r\n0);\r\nmutex_lock(&itv->udma.lock);\r\nrc = ivtv_firmware_init(itv);\r\nif (rc) {\r\nmutex_unlock(&itv->udma.lock);\r\nreturn rc;\r\n}\r\nivtv_mailbox_cache_invalidate(itv);\r\nstd = itv->std;\r\nitv->std = 0;\r\nivtv_s_std_enc(itv, std);\r\nif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT) {\r\nivtv_init_mpeg_decoder(itv);\r\nstd = itv->std_out;\r\nitv->std_out = 0;\r\nivtv_s_std_dec(itv, std);\r\nif (itv->ivtvfb_restore)\r\nitv->ivtvfb_restore(itv);\r\nivtv_set_osd_alpha(itv);\r\nivtv_call_hw(itv, IVTV_HW_SAA7127, video, s_routing,\r\nSAA7127_INPUT_TYPE_NORMAL,\r\nitv->card->video_outputs[itv->active_output].video_output,\r\n0);\r\n}\r\nmutex_unlock(&itv->udma.lock);\r\nreturn rc;\r\n}\r\nint ivtv_firmware_check(struct ivtv *itv, char *where)\r\n{\r\nint res = 0;\r\nif (ivtv_vapi(itv, CX2341X_ENC_PING_FW, 0) < 0) {\r\nIVTV_WARN("Encoder has died : %s\n", where);\r\nres = -1;\r\n}\r\nif (!res && !atomic_read(&itv->capturing) &&\r\n(!atomic_read(&itv->decoding) ||\r\n(atomic_read(&itv->decoding) < 2 && test_bit(IVTV_F_I_DEC_YUV,\r\n&itv->i_flags)))) {\r\nif (ivtv_vapi(itv, CX2341X_ENC_MISC, 1, 12) < 0) {\r\nIVTV_WARN("Audio has died (Encoder OK) : %s\n", where);\r\nres = -2;\r\n}\r\n}\r\nif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT) {\r\nif (res != -2 && read_dec(0x100) != read_dec(0x104)) {\r\nivtv_msleep_timeout(14, 0);\r\nif (read_dec(0x100) != read_dec(0x104)) {\r\nIVTV_WARN("Audio has died (Decoder) : %s\n",\r\nwhere);\r\nres = -1;\r\n}\r\n}\r\nif (ivtv_vapi(itv, CX2341X_DEC_PING_FW, 0) < 0) {\r\nIVTV_WARN("Decoder has died : %s\n", where);\r\nres = -1;\r\n}\r\n}\r\nif (res && !atomic_read(&itv->capturing) &&\r\n!atomic_read(&itv->decoding)) {\r\nIVTV_INFO("Detected in %s that firmware had failed - Reloading\n",\r\nwhere);\r\nres = ivtv_firmware_restart(itv);\r\nif (!res) {\r\nIVTV_INFO("Firmware restart okay\n");\r\nres = -EAGAIN;\r\n} else {\r\nIVTV_INFO("Firmware restart failed\n");\r\n}\r\n} else if (res) {\r\nres = -EIO;\r\n}\r\nreturn res;\r\n}

static irqreturn_t sun4i_lradc_irq(int irq, void *dev_id)\r\n{\r\nstruct sun4i_lradc_data *lradc = dev_id;\r\nu32 i, ints, val, voltage, diff, keycode = 0, closest = 0xffffffff;\r\nints = readl(lradc->base + LRADC_INTS);\r\nif (ints & CHAN0_KEYUP_IRQ) {\r\ninput_report_key(lradc->input, lradc->chan0_keycode, 0);\r\nlradc->chan0_keycode = 0;\r\n}\r\nif ((ints & CHAN0_KEYDOWN_IRQ) && lradc->chan0_keycode == 0) {\r\nval = readl(lradc->base + LRADC_DATA0) & 0x3f;\r\nvoltage = val * lradc->vref / 63;\r\nfor (i = 0; i < lradc->chan0_map_count; i++) {\r\ndiff = abs(lradc->chan0_map[i].voltage - voltage);\r\nif (diff < closest) {\r\nclosest = diff;\r\nkeycode = lradc->chan0_map[i].keycode;\r\n}\r\n}\r\nlradc->chan0_keycode = keycode;\r\ninput_report_key(lradc->input, lradc->chan0_keycode, 1);\r\n}\r\ninput_sync(lradc->input);\r\nwritel(ints, lradc->base + LRADC_INTS);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sun4i_lradc_open(struct input_dev *dev)\r\n{\r\nstruct sun4i_lradc_data *lradc = input_get_drvdata(dev);\r\nint error;\r\nerror = regulator_enable(lradc->vref_supply);\r\nif (error)\r\nreturn error;\r\nlradc->vref = regulator_get_voltage(lradc->vref_supply) * 2 / 3;\r\nwritel(FIRST_CONVERT_DLY(2) | LEVELA_B_CNT(1) | HOLD_EN(1) |\r\nSAMPLE_RATE(0) | ENABLE(1), lradc->base + LRADC_CTRL);\r\nwritel(CHAN0_KEYUP_IRQ | CHAN0_KEYDOWN_IRQ, lradc->base + LRADC_INTC);\r\nreturn 0;\r\n}\r\nstatic void sun4i_lradc_close(struct input_dev *dev)\r\n{\r\nstruct sun4i_lradc_data *lradc = input_get_drvdata(dev);\r\nwritel(FIRST_CONVERT_DLY(2) | LEVELA_B_CNT(1) | HOLD_EN(1) |\r\nSAMPLE_RATE(2), lradc->base + LRADC_CTRL);\r\nwritel(0, lradc->base + LRADC_INTC);\r\nregulator_disable(lradc->vref_supply);\r\n}\r\nstatic int sun4i_lradc_load_dt_keymap(struct device *dev,\r\nstruct sun4i_lradc_data *lradc)\r\n{\r\nstruct device_node *np, *pp;\r\nint i;\r\nint error;\r\nnp = dev->of_node;\r\nif (!np)\r\nreturn -EINVAL;\r\nlradc->chan0_map_count = of_get_child_count(np);\r\nif (lradc->chan0_map_count == 0) {\r\ndev_err(dev, "keymap is missing in device tree\n");\r\nreturn -EINVAL;\r\n}\r\nlradc->chan0_map = devm_kmalloc_array(dev, lradc->chan0_map_count,\r\nsizeof(struct sun4i_lradc_keymap),\r\nGFP_KERNEL);\r\nif (!lradc->chan0_map)\r\nreturn -ENOMEM;\r\ni = 0;\r\nfor_each_child_of_node(np, pp) {\r\nstruct sun4i_lradc_keymap *map = &lradc->chan0_map[i];\r\nu32 channel;\r\nerror = of_property_read_u32(pp, "channel", &channel);\r\nif (error || channel != 0) {\r\ndev_err(dev, "%s: Inval channel prop\n", pp->name);\r\nreturn -EINVAL;\r\n}\r\nerror = of_property_read_u32(pp, "voltage", &map->voltage);\r\nif (error) {\r\ndev_err(dev, "%s: Inval voltage prop\n", pp->name);\r\nreturn -EINVAL;\r\n}\r\nerror = of_property_read_u32(pp, "linux,code", &map->keycode);\r\nif (error) {\r\ndev_err(dev, "%s: Inval linux,code prop\n", pp->name);\r\nreturn -EINVAL;\r\n}\r\ni++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun4i_lradc_probe(struct platform_device *pdev)\r\n{\r\nstruct sun4i_lradc_data *lradc;\r\nstruct device *dev = &pdev->dev;\r\nint i;\r\nint error;\r\nlradc = devm_kzalloc(dev, sizeof(struct sun4i_lradc_data), GFP_KERNEL);\r\nif (!lradc)\r\nreturn -ENOMEM;\r\nerror = sun4i_lradc_load_dt_keymap(dev, lradc);\r\nif (error)\r\nreturn error;\r\nlradc->vref_supply = devm_regulator_get(dev, "vref");\r\nif (IS_ERR(lradc->vref_supply))\r\nreturn PTR_ERR(lradc->vref_supply);\r\nlradc->dev = dev;\r\nlradc->input = devm_input_allocate_device(dev);\r\nif (!lradc->input)\r\nreturn -ENOMEM;\r\nlradc->input->name = pdev->name;\r\nlradc->input->phys = "sun4i_lradc/input0";\r\nlradc->input->open = sun4i_lradc_open;\r\nlradc->input->close = sun4i_lradc_close;\r\nlradc->input->id.bustype = BUS_HOST;\r\nlradc->input->id.vendor = 0x0001;\r\nlradc->input->id.product = 0x0001;\r\nlradc->input->id.version = 0x0100;\r\n__set_bit(EV_KEY, lradc->input->evbit);\r\nfor (i = 0; i < lradc->chan0_map_count; i++)\r\n__set_bit(lradc->chan0_map[i].keycode, lradc->input->keybit);\r\ninput_set_drvdata(lradc->input, lradc);\r\nlradc->base = devm_ioremap_resource(dev,\r\nplatform_get_resource(pdev, IORESOURCE_MEM, 0));\r\nif (IS_ERR(lradc->base))\r\nreturn PTR_ERR(lradc->base);\r\nerror = devm_request_irq(dev, platform_get_irq(pdev, 0),\r\nsun4i_lradc_irq, 0,\r\n"sun4i-a10-lradc-keys", lradc);\r\nif (error)\r\nreturn error;\r\nerror = input_register_device(lradc->input);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}

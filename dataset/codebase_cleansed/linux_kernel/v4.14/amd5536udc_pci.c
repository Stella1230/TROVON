static void udc_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct udc *dev;\r\ndev = pci_get_drvdata(pdev);\r\nusb_del_gadget_udc(&udc->gadget);\r\nif (WARN_ON(dev->driver))\r\nreturn;\r\nfree_dma_pools(dev);\r\nwritel(AMD_BIT(UDC_DEVCFG_SOFTRESET), &dev->regs->cfg);\r\nfree_irq(pdev->irq, dev);\r\niounmap(dev->virt_addr);\r\nrelease_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\npci_disable_device(pdev);\r\nudc_remove(dev);\r\n}\r\nstatic int udc_pci_probe(\r\nstruct pci_dev *pdev,\r\nconst struct pci_device_id *id\r\n)\r\n{\r\nstruct udc *dev;\r\nunsigned long resource;\r\nunsigned long len;\r\nint retval = 0;\r\nif (udc) {\r\ndev_dbg(&pdev->dev, "already probed\n");\r\nreturn -EBUSY;\r\n}\r\ndev = kzalloc(sizeof(struct udc), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (pci_enable_device(pdev) < 0) {\r\nretval = -ENODEV;\r\ngoto err_pcidev;\r\n}\r\nresource = pci_resource_start(pdev, 0);\r\nlen = pci_resource_len(pdev, 0);\r\nif (!request_mem_region(resource, len, name)) {\r\ndev_dbg(&pdev->dev, "pci device used already\n");\r\nretval = -EBUSY;\r\ngoto err_memreg;\r\n}\r\ndev->virt_addr = ioremap_nocache(resource, len);\r\nif (!dev->virt_addr) {\r\ndev_dbg(&pdev->dev, "start address cannot be mapped\n");\r\nretval = -EFAULT;\r\ngoto err_ioremap;\r\n}\r\nif (!pdev->irq) {\r\ndev_err(&pdev->dev, "irq not set\n");\r\nretval = -ENODEV;\r\ngoto err_irq;\r\n}\r\nspin_lock_init(&dev->lock);\r\ndev->csr = dev->virt_addr + UDC_CSR_ADDR;\r\ndev->regs = dev->virt_addr + UDC_DEVCFG_ADDR;\r\ndev->ep_regs = dev->virt_addr + UDC_EPREGS_ADDR;\r\ndev->rxfifo = (u32 __iomem *)(dev->virt_addr + UDC_RXFIFO_ADDR);\r\ndev->txfifo = (u32 __iomem *)(dev->virt_addr + UDC_TXFIFO_ADDR);\r\nif (request_irq(pdev->irq, udc_irq, IRQF_SHARED, name, dev) != 0) {\r\ndev_dbg(&pdev->dev, "request_irq(%d) fail\n", pdev->irq);\r\nretval = -EBUSY;\r\ngoto err_irq;\r\n}\r\npci_set_drvdata(pdev, dev);\r\ndev->chiprev = pdev->revision;\r\npci_set_master(pdev);\r\npci_try_set_mwi(pdev);\r\nif (use_dma) {\r\nretval = init_dma_pools(dev);\r\nif (retval != 0)\r\ngoto err_dma;\r\n}\r\ndev->phys_addr = resource;\r\ndev->irq = pdev->irq;\r\ndev->pdev = pdev;\r\ndev->dev = &pdev->dev;\r\nif (udc_probe(dev)) {\r\nretval = -ENODEV;\r\ngoto err_probe;\r\n}\r\nreturn 0;\r\nerr_probe:\r\nif (use_dma)\r\nfree_dma_pools(dev);\r\nerr_dma:\r\nfree_irq(pdev->irq, dev);\r\nerr_irq:\r\niounmap(dev->virt_addr);\r\nerr_ioremap:\r\nrelease_mem_region(resource, len);\r\nerr_memreg:\r\npci_disable_device(pdev);\r\nerr_pcidev:\r\nkfree(dev);\r\nreturn retval;\r\n}

static int wm831x_reg_locked(struct wm831x *wm831x, unsigned short reg)\r\n{\r\nif (!wm831x->locked)\r\nreturn 0;\r\nswitch (reg) {\r\ncase WM831X_WATCHDOG:\r\ncase WM831X_DC4_CONTROL:\r\ncase WM831X_ON_PIN_CONTROL:\r\ncase WM831X_BACKUP_CHARGER_CONTROL:\r\ncase WM831X_CHARGER_CONTROL_1:\r\ncase WM831X_CHARGER_CONTROL_2:\r\nreturn 1;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nvoid wm831x_reg_lock(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nret = wm831x_reg_write(wm831x, WM831X_SECURITY_KEY, 0);\r\nif (ret == 0) {\r\ndev_vdbg(wm831x->dev, "Registers locked\n");\r\nmutex_lock(&wm831x->io_lock);\r\nWARN_ON(wm831x->locked);\r\nwm831x->locked = 1;\r\nmutex_unlock(&wm831x->io_lock);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to lock registers: %d\n", ret);\r\n}\r\n}\r\nint wm831x_reg_unlock(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nret = wm831x_reg_write(wm831x, WM831X_SECURITY_KEY, 0x9716);\r\nif (ret == 0) {\r\ndev_vdbg(wm831x->dev, "Registers unlocked\n");\r\nmutex_lock(&wm831x->io_lock);\r\nWARN_ON(!wm831x->locked);\r\nwm831x->locked = 0;\r\nmutex_unlock(&wm831x->io_lock);\r\n}\r\nreturn ret;\r\n}\r\nstatic bool wm831x_reg_readable(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase WM831X_RESET_ID:\r\ncase WM831X_REVISION:\r\ncase WM831X_PARENT_ID:\r\ncase WM831X_SYSVDD_CONTROL:\r\ncase WM831X_THERMAL_MONITORING:\r\ncase WM831X_POWER_STATE:\r\ncase WM831X_WATCHDOG:\r\ncase WM831X_ON_PIN_CONTROL:\r\ncase WM831X_RESET_CONTROL:\r\ncase WM831X_CONTROL_INTERFACE:\r\ncase WM831X_SECURITY_KEY:\r\ncase WM831X_SOFTWARE_SCRATCH:\r\ncase WM831X_OTP_CONTROL:\r\ncase WM831X_GPIO_LEVEL:\r\ncase WM831X_SYSTEM_STATUS:\r\ncase WM831X_ON_SOURCE:\r\ncase WM831X_OFF_SOURCE:\r\ncase WM831X_SYSTEM_INTERRUPTS:\r\ncase WM831X_INTERRUPT_STATUS_1:\r\ncase WM831X_INTERRUPT_STATUS_2:\r\ncase WM831X_INTERRUPT_STATUS_3:\r\ncase WM831X_INTERRUPT_STATUS_4:\r\ncase WM831X_INTERRUPT_STATUS_5:\r\ncase WM831X_IRQ_CONFIG:\r\ncase WM831X_SYSTEM_INTERRUPTS_MASK:\r\ncase WM831X_INTERRUPT_STATUS_1_MASK:\r\ncase WM831X_INTERRUPT_STATUS_2_MASK:\r\ncase WM831X_INTERRUPT_STATUS_3_MASK:\r\ncase WM831X_INTERRUPT_STATUS_4_MASK:\r\ncase WM831X_INTERRUPT_STATUS_5_MASK:\r\ncase WM831X_RTC_WRITE_COUNTER:\r\ncase WM831X_RTC_TIME_1:\r\ncase WM831X_RTC_TIME_2:\r\ncase WM831X_RTC_ALARM_1:\r\ncase WM831X_RTC_ALARM_2:\r\ncase WM831X_RTC_CONTROL:\r\ncase WM831X_RTC_TRIM:\r\ncase WM831X_TOUCH_CONTROL_1:\r\ncase WM831X_TOUCH_CONTROL_2:\r\ncase WM831X_TOUCH_DATA_X:\r\ncase WM831X_TOUCH_DATA_Y:\r\ncase WM831X_TOUCH_DATA_Z:\r\ncase WM831X_AUXADC_DATA:\r\ncase WM831X_AUXADC_CONTROL:\r\ncase WM831X_AUXADC_SOURCE:\r\ncase WM831X_COMPARATOR_CONTROL:\r\ncase WM831X_COMPARATOR_1:\r\ncase WM831X_COMPARATOR_2:\r\ncase WM831X_COMPARATOR_3:\r\ncase WM831X_COMPARATOR_4:\r\ncase WM831X_GPIO1_CONTROL:\r\ncase WM831X_GPIO2_CONTROL:\r\ncase WM831X_GPIO3_CONTROL:\r\ncase WM831X_GPIO4_CONTROL:\r\ncase WM831X_GPIO5_CONTROL:\r\ncase WM831X_GPIO6_CONTROL:\r\ncase WM831X_GPIO7_CONTROL:\r\ncase WM831X_GPIO8_CONTROL:\r\ncase WM831X_GPIO9_CONTROL:\r\ncase WM831X_GPIO10_CONTROL:\r\ncase WM831X_GPIO11_CONTROL:\r\ncase WM831X_GPIO12_CONTROL:\r\ncase WM831X_GPIO13_CONTROL:\r\ncase WM831X_GPIO14_CONTROL:\r\ncase WM831X_GPIO15_CONTROL:\r\ncase WM831X_GPIO16_CONTROL:\r\ncase WM831X_CHARGER_CONTROL_1:\r\ncase WM831X_CHARGER_CONTROL_2:\r\ncase WM831X_CHARGER_STATUS:\r\ncase WM831X_BACKUP_CHARGER_CONTROL:\r\ncase WM831X_STATUS_LED_1:\r\ncase WM831X_STATUS_LED_2:\r\ncase WM831X_CURRENT_SINK_1:\r\ncase WM831X_CURRENT_SINK_2:\r\ncase WM831X_DCDC_ENABLE:\r\ncase WM831X_LDO_ENABLE:\r\ncase WM831X_DCDC_STATUS:\r\ncase WM831X_LDO_STATUS:\r\ncase WM831X_DCDC_UV_STATUS:\r\ncase WM831X_LDO_UV_STATUS:\r\ncase WM831X_DC1_CONTROL_1:\r\ncase WM831X_DC1_CONTROL_2:\r\ncase WM831X_DC1_ON_CONFIG:\r\ncase WM831X_DC1_SLEEP_CONTROL:\r\ncase WM831X_DC1_DVS_CONTROL:\r\ncase WM831X_DC2_CONTROL_1:\r\ncase WM831X_DC2_CONTROL_2:\r\ncase WM831X_DC2_ON_CONFIG:\r\ncase WM831X_DC2_SLEEP_CONTROL:\r\ncase WM831X_DC2_DVS_CONTROL:\r\ncase WM831X_DC3_CONTROL_1:\r\ncase WM831X_DC3_CONTROL_2:\r\ncase WM831X_DC3_ON_CONFIG:\r\ncase WM831X_DC3_SLEEP_CONTROL:\r\ncase WM831X_DC4_CONTROL:\r\ncase WM831X_DC4_SLEEP_CONTROL:\r\ncase WM831X_EPE1_CONTROL:\r\ncase WM831X_EPE2_CONTROL:\r\ncase WM831X_LDO1_CONTROL:\r\ncase WM831X_LDO1_ON_CONTROL:\r\ncase WM831X_LDO1_SLEEP_CONTROL:\r\ncase WM831X_LDO2_CONTROL:\r\ncase WM831X_LDO2_ON_CONTROL:\r\ncase WM831X_LDO2_SLEEP_CONTROL:\r\ncase WM831X_LDO3_CONTROL:\r\ncase WM831X_LDO3_ON_CONTROL:\r\ncase WM831X_LDO3_SLEEP_CONTROL:\r\ncase WM831X_LDO4_CONTROL:\r\ncase WM831X_LDO4_ON_CONTROL:\r\ncase WM831X_LDO4_SLEEP_CONTROL:\r\ncase WM831X_LDO5_CONTROL:\r\ncase WM831X_LDO5_ON_CONTROL:\r\ncase WM831X_LDO5_SLEEP_CONTROL:\r\ncase WM831X_LDO6_CONTROL:\r\ncase WM831X_LDO6_ON_CONTROL:\r\ncase WM831X_LDO6_SLEEP_CONTROL:\r\ncase WM831X_LDO7_CONTROL:\r\ncase WM831X_LDO7_ON_CONTROL:\r\ncase WM831X_LDO7_SLEEP_CONTROL:\r\ncase WM831X_LDO8_CONTROL:\r\ncase WM831X_LDO8_ON_CONTROL:\r\ncase WM831X_LDO8_SLEEP_CONTROL:\r\ncase WM831X_LDO9_CONTROL:\r\ncase WM831X_LDO9_ON_CONTROL:\r\ncase WM831X_LDO9_SLEEP_CONTROL:\r\ncase WM831X_LDO10_CONTROL:\r\ncase WM831X_LDO10_ON_CONTROL:\r\ncase WM831X_LDO10_SLEEP_CONTROL:\r\ncase WM831X_LDO11_ON_CONTROL:\r\ncase WM831X_LDO11_SLEEP_CONTROL:\r\ncase WM831X_POWER_GOOD_SOURCE_1:\r\ncase WM831X_POWER_GOOD_SOURCE_2:\r\ncase WM831X_CLOCK_CONTROL_1:\r\ncase WM831X_CLOCK_CONTROL_2:\r\ncase WM831X_FLL_CONTROL_1:\r\ncase WM831X_FLL_CONTROL_2:\r\ncase WM831X_FLL_CONTROL_3:\r\ncase WM831X_FLL_CONTROL_4:\r\ncase WM831X_FLL_CONTROL_5:\r\ncase WM831X_UNIQUE_ID_1:\r\ncase WM831X_UNIQUE_ID_2:\r\ncase WM831X_UNIQUE_ID_3:\r\ncase WM831X_UNIQUE_ID_4:\r\ncase WM831X_UNIQUE_ID_5:\r\ncase WM831X_UNIQUE_ID_6:\r\ncase WM831X_UNIQUE_ID_7:\r\ncase WM831X_UNIQUE_ID_8:\r\ncase WM831X_FACTORY_OTP_ID:\r\ncase WM831X_FACTORY_OTP_1:\r\ncase WM831X_FACTORY_OTP_2:\r\ncase WM831X_FACTORY_OTP_3:\r\ncase WM831X_FACTORY_OTP_4:\r\ncase WM831X_FACTORY_OTP_5:\r\ncase WM831X_CUSTOMER_OTP_ID:\r\ncase WM831X_DC1_OTP_CONTROL:\r\ncase WM831X_DC2_OTP_CONTROL:\r\ncase WM831X_DC3_OTP_CONTROL:\r\ncase WM831X_LDO1_2_OTP_CONTROL:\r\ncase WM831X_LDO3_4_OTP_CONTROL:\r\ncase WM831X_LDO5_6_OTP_CONTROL:\r\ncase WM831X_LDO7_8_OTP_CONTROL:\r\ncase WM831X_LDO9_10_OTP_CONTROL:\r\ncase WM831X_LDO11_EPE_CONTROL:\r\ncase WM831X_GPIO1_OTP_CONTROL:\r\ncase WM831X_GPIO2_OTP_CONTROL:\r\ncase WM831X_GPIO3_OTP_CONTROL:\r\ncase WM831X_GPIO4_OTP_CONTROL:\r\ncase WM831X_GPIO5_OTP_CONTROL:\r\ncase WM831X_GPIO6_OTP_CONTROL:\r\ncase WM831X_DBE_CHECK_DATA:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool wm831x_reg_writeable(struct device *dev, unsigned int reg)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(dev);\r\nif (wm831x_reg_locked(wm831x, reg))\r\nreturn false;\r\nswitch (reg) {\r\ncase WM831X_SYSVDD_CONTROL:\r\ncase WM831X_THERMAL_MONITORING:\r\ncase WM831X_POWER_STATE:\r\ncase WM831X_WATCHDOG:\r\ncase WM831X_ON_PIN_CONTROL:\r\ncase WM831X_RESET_CONTROL:\r\ncase WM831X_CONTROL_INTERFACE:\r\ncase WM831X_SECURITY_KEY:\r\ncase WM831X_SOFTWARE_SCRATCH:\r\ncase WM831X_OTP_CONTROL:\r\ncase WM831X_GPIO_LEVEL:\r\ncase WM831X_INTERRUPT_STATUS_1:\r\ncase WM831X_INTERRUPT_STATUS_2:\r\ncase WM831X_INTERRUPT_STATUS_3:\r\ncase WM831X_INTERRUPT_STATUS_4:\r\ncase WM831X_INTERRUPT_STATUS_5:\r\ncase WM831X_IRQ_CONFIG:\r\ncase WM831X_SYSTEM_INTERRUPTS_MASK:\r\ncase WM831X_INTERRUPT_STATUS_1_MASK:\r\ncase WM831X_INTERRUPT_STATUS_2_MASK:\r\ncase WM831X_INTERRUPT_STATUS_3_MASK:\r\ncase WM831X_INTERRUPT_STATUS_4_MASK:\r\ncase WM831X_INTERRUPT_STATUS_5_MASK:\r\ncase WM831X_RTC_TIME_1:\r\ncase WM831X_RTC_TIME_2:\r\ncase WM831X_RTC_ALARM_1:\r\ncase WM831X_RTC_ALARM_2:\r\ncase WM831X_RTC_CONTROL:\r\ncase WM831X_RTC_TRIM:\r\ncase WM831X_TOUCH_CONTROL_1:\r\ncase WM831X_TOUCH_CONTROL_2:\r\ncase WM831X_AUXADC_CONTROL:\r\ncase WM831X_AUXADC_SOURCE:\r\ncase WM831X_COMPARATOR_CONTROL:\r\ncase WM831X_COMPARATOR_1:\r\ncase WM831X_COMPARATOR_2:\r\ncase WM831X_COMPARATOR_3:\r\ncase WM831X_COMPARATOR_4:\r\ncase WM831X_GPIO1_CONTROL:\r\ncase WM831X_GPIO2_CONTROL:\r\ncase WM831X_GPIO3_CONTROL:\r\ncase WM831X_GPIO4_CONTROL:\r\ncase WM831X_GPIO5_CONTROL:\r\ncase WM831X_GPIO6_CONTROL:\r\ncase WM831X_GPIO7_CONTROL:\r\ncase WM831X_GPIO8_CONTROL:\r\ncase WM831X_GPIO9_CONTROL:\r\ncase WM831X_GPIO10_CONTROL:\r\ncase WM831X_GPIO11_CONTROL:\r\ncase WM831X_GPIO12_CONTROL:\r\ncase WM831X_GPIO13_CONTROL:\r\ncase WM831X_GPIO14_CONTROL:\r\ncase WM831X_GPIO15_CONTROL:\r\ncase WM831X_GPIO16_CONTROL:\r\ncase WM831X_CHARGER_CONTROL_1:\r\ncase WM831X_CHARGER_CONTROL_2:\r\ncase WM831X_CHARGER_STATUS:\r\ncase WM831X_BACKUP_CHARGER_CONTROL:\r\ncase WM831X_STATUS_LED_1:\r\ncase WM831X_STATUS_LED_2:\r\ncase WM831X_CURRENT_SINK_1:\r\ncase WM831X_CURRENT_SINK_2:\r\ncase WM831X_DCDC_ENABLE:\r\ncase WM831X_LDO_ENABLE:\r\ncase WM831X_DC1_CONTROL_1:\r\ncase WM831X_DC1_CONTROL_2:\r\ncase WM831X_DC1_ON_CONFIG:\r\ncase WM831X_DC1_SLEEP_CONTROL:\r\ncase WM831X_DC1_DVS_CONTROL:\r\ncase WM831X_DC2_CONTROL_1:\r\ncase WM831X_DC2_CONTROL_2:\r\ncase WM831X_DC2_ON_CONFIG:\r\ncase WM831X_DC2_SLEEP_CONTROL:\r\ncase WM831X_DC2_DVS_CONTROL:\r\ncase WM831X_DC3_CONTROL_1:\r\ncase WM831X_DC3_CONTROL_2:\r\ncase WM831X_DC3_ON_CONFIG:\r\ncase WM831X_DC3_SLEEP_CONTROL:\r\ncase WM831X_DC4_CONTROL:\r\ncase WM831X_DC4_SLEEP_CONTROL:\r\ncase WM831X_EPE1_CONTROL:\r\ncase WM831X_EPE2_CONTROL:\r\ncase WM831X_LDO1_CONTROL:\r\ncase WM831X_LDO1_ON_CONTROL:\r\ncase WM831X_LDO1_SLEEP_CONTROL:\r\ncase WM831X_LDO2_CONTROL:\r\ncase WM831X_LDO2_ON_CONTROL:\r\ncase WM831X_LDO2_SLEEP_CONTROL:\r\ncase WM831X_LDO3_CONTROL:\r\ncase WM831X_LDO3_ON_CONTROL:\r\ncase WM831X_LDO3_SLEEP_CONTROL:\r\ncase WM831X_LDO4_CONTROL:\r\ncase WM831X_LDO4_ON_CONTROL:\r\ncase WM831X_LDO4_SLEEP_CONTROL:\r\ncase WM831X_LDO5_CONTROL:\r\ncase WM831X_LDO5_ON_CONTROL:\r\ncase WM831X_LDO5_SLEEP_CONTROL:\r\ncase WM831X_LDO6_CONTROL:\r\ncase WM831X_LDO6_ON_CONTROL:\r\ncase WM831X_LDO6_SLEEP_CONTROL:\r\ncase WM831X_LDO7_CONTROL:\r\ncase WM831X_LDO7_ON_CONTROL:\r\ncase WM831X_LDO7_SLEEP_CONTROL:\r\ncase WM831X_LDO8_CONTROL:\r\ncase WM831X_LDO8_ON_CONTROL:\r\ncase WM831X_LDO8_SLEEP_CONTROL:\r\ncase WM831X_LDO9_CONTROL:\r\ncase WM831X_LDO9_ON_CONTROL:\r\ncase WM831X_LDO9_SLEEP_CONTROL:\r\ncase WM831X_LDO10_CONTROL:\r\ncase WM831X_LDO10_ON_CONTROL:\r\ncase WM831X_LDO10_SLEEP_CONTROL:\r\ncase WM831X_LDO11_ON_CONTROL:\r\ncase WM831X_LDO11_SLEEP_CONTROL:\r\ncase WM831X_POWER_GOOD_SOURCE_1:\r\ncase WM831X_POWER_GOOD_SOURCE_2:\r\ncase WM831X_CLOCK_CONTROL_1:\r\ncase WM831X_CLOCK_CONTROL_2:\r\ncase WM831X_FLL_CONTROL_1:\r\ncase WM831X_FLL_CONTROL_2:\r\ncase WM831X_FLL_CONTROL_3:\r\ncase WM831X_FLL_CONTROL_4:\r\ncase WM831X_FLL_CONTROL_5:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool wm831x_reg_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase WM831X_SYSTEM_STATUS:\r\ncase WM831X_ON_SOURCE:\r\ncase WM831X_OFF_SOURCE:\r\ncase WM831X_GPIO_LEVEL:\r\ncase WM831X_SYSTEM_INTERRUPTS:\r\ncase WM831X_INTERRUPT_STATUS_1:\r\ncase WM831X_INTERRUPT_STATUS_2:\r\ncase WM831X_INTERRUPT_STATUS_3:\r\ncase WM831X_INTERRUPT_STATUS_4:\r\ncase WM831X_INTERRUPT_STATUS_5:\r\ncase WM831X_RTC_TIME_1:\r\ncase WM831X_RTC_TIME_2:\r\ncase WM831X_TOUCH_DATA_X:\r\ncase WM831X_TOUCH_DATA_Y:\r\ncase WM831X_TOUCH_DATA_Z:\r\ncase WM831X_AUXADC_DATA:\r\ncase WM831X_CHARGER_STATUS:\r\ncase WM831X_DCDC_STATUS:\r\ncase WM831X_LDO_STATUS:\r\ncase WM831X_DCDC_UV_STATUS:\r\ncase WM831X_LDO_UV_STATUS:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nint wm831x_reg_read(struct wm831x *wm831x, unsigned short reg)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(wm831x->regmap, reg, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nelse\r\nreturn val;\r\n}\r\nint wm831x_bulk_read(struct wm831x *wm831x, unsigned short reg,\r\nint count, u16 *buf)\r\n{\r\nreturn regmap_bulk_read(wm831x->regmap, reg, buf, count);\r\n}\r\nstatic int wm831x_write(struct wm831x *wm831x, unsigned short reg,\r\nint bytes, void *src)\r\n{\r\nu16 *buf = src;\r\nint i, ret;\r\nBUG_ON(bytes % 2);\r\nBUG_ON(bytes <= 0);\r\nfor (i = 0; i < bytes / 2; i++) {\r\nif (wm831x_reg_locked(wm831x, reg))\r\nreturn -EPERM;\r\ndev_vdbg(wm831x->dev, "Write %04x to R%d(0x%x)\n",\r\nbuf[i], reg + i, reg + i);\r\nret = regmap_write(wm831x->regmap, reg + i, buf[i]);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint wm831x_reg_write(struct wm831x *wm831x, unsigned short reg,\r\nunsigned short val)\r\n{\r\nint ret;\r\nmutex_lock(&wm831x->io_lock);\r\nret = wm831x_write(wm831x, reg, 2, &val);\r\nmutex_unlock(&wm831x->io_lock);\r\nreturn ret;\r\n}\r\nint wm831x_set_bits(struct wm831x *wm831x, unsigned short reg,\r\nunsigned short mask, unsigned short val)\r\n{\r\nint ret;\r\nmutex_lock(&wm831x->io_lock);\r\nif (!wm831x_reg_locked(wm831x, reg))\r\nret = regmap_update_bits(wm831x->regmap, reg, mask, val);\r\nelse\r\nret = -EPERM;\r\nmutex_unlock(&wm831x->io_lock);\r\nreturn ret;\r\n}\r\nint wm831x_device_init(struct wm831x *wm831x, int irq)\r\n{\r\nstruct wm831x_pdata *pdata = &wm831x->pdata;\r\nint rev, wm831x_num;\r\nenum wm831x_parent parent;\r\nint ret, i;\r\nmutex_init(&wm831x->io_lock);\r\nmutex_init(&wm831x->key_lock);\r\ndev_set_drvdata(wm831x->dev, wm831x);\r\nwm831x->soft_shutdown = pdata->soft_shutdown;\r\nret = wm831x_reg_read(wm831x, WM831X_PARENT_ID);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read parent ID: %d\n", ret);\r\ngoto err;\r\n}\r\nswitch (ret) {\r\ncase 0x6204:\r\ncase 0x6246:\r\nbreak;\r\ndefault:\r\ndev_err(wm831x->dev, "Device is not a WM831x: ID %x\n", ret);\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nret = wm831x_reg_read(wm831x, WM831X_REVISION);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read revision: %d\n", ret);\r\ngoto err;\r\n}\r\nrev = (ret & WM831X_PARENT_REV_MASK) >> WM831X_PARENT_REV_SHIFT;\r\nret = wm831x_reg_read(wm831x, WM831X_RESET_ID);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read device ID: %d\n", ret);\r\ngoto err;\r\n}\r\nif (ret == 0) {\r\ndev_info(wm831x->dev, "Device is an engineering sample\n");\r\nret = wm831x->type;\r\n}\r\nswitch (ret) {\r\ncase WM8310:\r\nparent = WM8310;\r\nwm831x->num_gpio = 16;\r\nwm831x->charger_irq_wake = 1;\r\nif (rev > 0) {\r\nwm831x->has_gpio_ena = 1;\r\nwm831x->has_cs_sts = 1;\r\n}\r\ndev_info(wm831x->dev, "WM8310 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8311:\r\nparent = WM8311;\r\nwm831x->num_gpio = 16;\r\nwm831x->charger_irq_wake = 1;\r\nif (rev > 0) {\r\nwm831x->has_gpio_ena = 1;\r\nwm831x->has_cs_sts = 1;\r\n}\r\ndev_info(wm831x->dev, "WM8311 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8312:\r\nparent = WM8312;\r\nwm831x->num_gpio = 16;\r\nwm831x->charger_irq_wake = 1;\r\nif (rev > 0) {\r\nwm831x->has_gpio_ena = 1;\r\nwm831x->has_cs_sts = 1;\r\n}\r\ndev_info(wm831x->dev, "WM8312 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8320:\r\nparent = WM8320;\r\nwm831x->num_gpio = 12;\r\ndev_info(wm831x->dev, "WM8320 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8321:\r\nparent = WM8321;\r\nwm831x->num_gpio = 12;\r\ndev_info(wm831x->dev, "WM8321 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8325:\r\nparent = WM8325;\r\nwm831x->num_gpio = 12;\r\ndev_info(wm831x->dev, "WM8325 revision %c\n", 'A' + rev);\r\nbreak;\r\ncase WM8326:\r\nparent = WM8326;\r\nwm831x->num_gpio = 12;\r\ndev_info(wm831x->dev, "WM8326 revision %c\n", 'A' + rev);\r\nbreak;\r\ndefault:\r\ndev_err(wm831x->dev, "Unknown WM831x device %04x\n", ret);\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nif (parent != wm831x->type)\r\ndev_warn(wm831x->dev, "Device was registered as a WM%x\n",\r\nwm831x->type);\r\nret = wm831x_reg_read(wm831x, WM831X_SECURITY_KEY);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read security key: %d\n", ret);\r\ngoto err;\r\n}\r\nif (ret != 0) {\r\ndev_warn(wm831x->dev, "Security key had non-zero value %x\n",\r\nret);\r\nwm831x_reg_write(wm831x, WM831X_SECURITY_KEY, 0);\r\n}\r\nwm831x->locked = 1;\r\nif (pdata->pre_init) {\r\nret = pdata->pre_init(wm831x);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "pre_init() failed: %d\n", ret);\r\ngoto err;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pdata->gpio_defaults); i++) {\r\nif (!pdata->gpio_defaults[i])\r\ncontinue;\r\nwm831x_reg_write(wm831x,\r\nWM831X_GPIO1_CONTROL + i,\r\npdata->gpio_defaults[i] & 0xffff);\r\n}\r\nif (pdata->wm831x_num)\r\nwm831x_num = pdata->wm831x_num * 10;\r\nelse\r\nwm831x_num = -1;\r\nret = wm831x_irq_init(wm831x, irq);\r\nif (ret != 0)\r\ngoto err;\r\nwm831x_auxadc_init(wm831x);\r\nswitch (parent) {\r\ncase WM8310:\r\nret = mfd_add_devices(wm831x->dev, wm831x_num,\r\nwm8310_devs, ARRAY_SIZE(wm8310_devs),\r\nNULL, 0, NULL);\r\nbreak;\r\ncase WM8311:\r\nret = mfd_add_devices(wm831x->dev, wm831x_num,\r\nwm8311_devs, ARRAY_SIZE(wm8311_devs),\r\nNULL, 0, NULL);\r\nif (!pdata->disable_touch)\r\nmfd_add_devices(wm831x->dev, wm831x_num,\r\ntouch_devs, ARRAY_SIZE(touch_devs),\r\nNULL, 0, NULL);\r\nbreak;\r\ncase WM8312:\r\nret = mfd_add_devices(wm831x->dev, wm831x_num,\r\nwm8312_devs, ARRAY_SIZE(wm8312_devs),\r\nNULL, 0, NULL);\r\nif (!pdata->disable_touch)\r\nmfd_add_devices(wm831x->dev, wm831x_num,\r\ntouch_devs, ARRAY_SIZE(touch_devs),\r\nNULL, 0, NULL);\r\nbreak;\r\ncase WM8320:\r\ncase WM8321:\r\ncase WM8325:\r\ncase WM8326:\r\nret = mfd_add_devices(wm831x->dev, wm831x_num,\r\nwm8320_devs, ARRAY_SIZE(wm8320_devs),\r\nNULL, 0, NULL);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to add children\n");\r\ngoto err_irq;\r\n}\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_2);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read clock status: %d\n", ret);\r\ngoto err_irq;\r\n}\r\nif (ret & WM831X_XTAL_ENA) {\r\nret = mfd_add_devices(wm831x->dev, wm831x_num,\r\nrtc_devs, ARRAY_SIZE(rtc_devs),\r\nNULL, 0, NULL);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to add RTC: %d\n", ret);\r\ngoto err_irq;\r\n}\r\n} else {\r\ndev_info(wm831x->dev, "32.768kHz clock disabled, no RTC\n");\r\n}\r\nif (pdata->backlight) {\r\nret = mfd_add_devices(wm831x->dev, wm831x_num, backlight_devs,\r\nARRAY_SIZE(backlight_devs), NULL,\r\n0, NULL);\r\nif (ret < 0)\r\ndev_err(wm831x->dev, "Failed to add backlight: %d\n",\r\nret);\r\n}\r\nwm831x_otp_init(wm831x);\r\nif (pdata->post_init) {\r\nret = pdata->post_init(wm831x);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "post_init() failed: %d\n", ret);\r\ngoto err_irq;\r\n}\r\n}\r\nreturn 0;\r\nerr_irq:\r\nwm831x_irq_exit(wm831x);\r\nerr:\r\nmfd_remove_devices(wm831x->dev);\r\nreturn ret;\r\n}\r\nvoid wm831x_device_exit(struct wm831x *wm831x)\r\n{\r\nwm831x_otp_exit(wm831x);\r\nmfd_remove_devices(wm831x->dev);\r\nfree_irq(wm831x_irq(wm831x, WM831X_IRQ_AUXADC_DATA), wm831x);\r\nwm831x_irq_exit(wm831x);\r\n}\r\nint wm831x_device_suspend(struct wm831x *wm831x)\r\n{\r\nint reg, mask;\r\nif (wm831x->charger_irq_wake) {\r\nreg = wm831x_reg_read(wm831x, WM831X_INTERRUPT_STATUS_2_MASK);\r\nmask = WM831X_CHG_BATT_HOT_EINT |\r\nWM831X_CHG_BATT_COLD_EINT |\r\nWM831X_CHG_BATT_FAIL_EINT |\r\nWM831X_CHG_OV_EINT | WM831X_CHG_END_EINT |\r\nWM831X_CHG_TO_EINT | WM831X_CHG_MODE_EINT |\r\nWM831X_CHG_START_EINT;\r\nif (reg & mask)\r\nreg = wm831x_reg_read(wm831x,\r\nWM831X_INTERRUPT_STATUS_2);\r\nif (reg & mask) {\r\ndev_info(wm831x->dev,\r\n"Acknowledging masked charger IRQs: %x\n",\r\nreg & mask);\r\nwm831x_reg_write(wm831x, WM831X_INTERRUPT_STATUS_2,\r\nreg & mask);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid wm831x_device_shutdown(struct wm831x *wm831x)\r\n{\r\nif (wm831x->soft_shutdown) {\r\ndev_info(wm831x->dev, "Initiating shutdown...\n");\r\nwm831x_set_bits(wm831x, WM831X_POWER_STATE, WM831X_CHIP_ON, 0);\r\n}\r\n}

int mlx5e_create_tir(struct mlx5_core_dev *mdev,\r\nstruct mlx5e_tir *tir, u32 *in, int inlen)\r\n{\r\nint err;\r\nerr = mlx5_core_create_tir(mdev, in, inlen, &tir->tirn);\r\nif (err)\r\nreturn err;\r\nlist_add(&tir->list, &mdev->mlx5e_res.td.tirs_list);\r\nreturn 0;\r\n}\r\nvoid mlx5e_destroy_tir(struct mlx5_core_dev *mdev,\r\nstruct mlx5e_tir *tir)\r\n{\r\nmlx5_core_destroy_tir(mdev, tir->tirn);\r\nlist_del(&tir->list);\r\n}\r\nstatic int mlx5e_create_mkey(struct mlx5_core_dev *mdev, u32 pdn,\r\nstruct mlx5_core_mkey *mkey)\r\n{\r\nint inlen = MLX5_ST_SZ_BYTES(create_mkey_in);\r\nvoid *mkc;\r\nu32 *in;\r\nint err;\r\nin = kvzalloc(inlen, GFP_KERNEL);\r\nif (!in)\r\nreturn -ENOMEM;\r\nmkc = MLX5_ADDR_OF(create_mkey_in, in, memory_key_mkey_entry);\r\nMLX5_SET(mkc, mkc, access_mode, MLX5_MKC_ACCESS_MODE_PA);\r\nMLX5_SET(mkc, mkc, lw, 1);\r\nMLX5_SET(mkc, mkc, lr, 1);\r\nMLX5_SET(mkc, mkc, pd, pdn);\r\nMLX5_SET(mkc, mkc, length64, 1);\r\nMLX5_SET(mkc, mkc, qpn, 0xffffff);\r\nerr = mlx5_core_create_mkey(mdev, mkey, in, inlen);\r\nkvfree(in);\r\nreturn err;\r\n}\r\nint mlx5e_create_mdev_resources(struct mlx5_core_dev *mdev)\r\n{\r\nstruct mlx5e_resources *res = &mdev->mlx5e_res;\r\nint err;\r\nerr = mlx5_core_alloc_pd(mdev, &res->pdn);\r\nif (err) {\r\nmlx5_core_err(mdev, "alloc pd failed, %d\n", err);\r\nreturn err;\r\n}\r\nerr = mlx5_core_alloc_transport_domain(mdev, &res->td.tdn);\r\nif (err) {\r\nmlx5_core_err(mdev, "alloc td failed, %d\n", err);\r\ngoto err_dealloc_pd;\r\n}\r\nerr = mlx5e_create_mkey(mdev, res->pdn, &res->mkey);\r\nif (err) {\r\nmlx5_core_err(mdev, "create mkey failed, %d\n", err);\r\ngoto err_dealloc_transport_domain;\r\n}\r\nerr = mlx5_alloc_bfreg(mdev, &res->bfreg, false, false);\r\nif (err) {\r\nmlx5_core_err(mdev, "alloc bfreg failed, %d\n", err);\r\ngoto err_destroy_mkey;\r\n}\r\nINIT_LIST_HEAD(&mdev->mlx5e_res.td.tirs_list);\r\nreturn 0;\r\nerr_destroy_mkey:\r\nmlx5_core_destroy_mkey(mdev, &res->mkey);\r\nerr_dealloc_transport_domain:\r\nmlx5_core_dealloc_transport_domain(mdev, res->td.tdn);\r\nerr_dealloc_pd:\r\nmlx5_core_dealloc_pd(mdev, res->pdn);\r\nreturn err;\r\n}\r\nvoid mlx5e_destroy_mdev_resources(struct mlx5_core_dev *mdev)\r\n{\r\nstruct mlx5e_resources *res = &mdev->mlx5e_res;\r\nmlx5_free_bfreg(mdev, &res->bfreg);\r\nmlx5_core_destroy_mkey(mdev, &res->mkey);\r\nmlx5_core_dealloc_transport_domain(mdev, res->td.tdn);\r\nmlx5_core_dealloc_pd(mdev, res->pdn);\r\n}\r\nint mlx5e_refresh_tirs(struct mlx5e_priv *priv, bool enable_uc_lb)\r\n{\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nstruct mlx5e_tir *tir;\r\nint err = -ENOMEM;\r\nu32 tirn = 0;\r\nint inlen;\r\nvoid *in;\r\ninlen = MLX5_ST_SZ_BYTES(modify_tir_in);\r\nin = kvzalloc(inlen, GFP_KERNEL);\r\nif (!in)\r\ngoto out;\r\nif (enable_uc_lb)\r\nMLX5_SET(modify_tir_in, in, ctx.self_lb_block,\r\nMLX5_TIRC_SELF_LB_BLOCK_BLOCK_UNICAST_);\r\nMLX5_SET(modify_tir_in, in, bitmask.self_lb_en, 1);\r\nlist_for_each_entry(tir, &mdev->mlx5e_res.td.tirs_list, list) {\r\ntirn = tir->tirn;\r\nerr = mlx5_core_modify_tir(mdev, tirn, in, inlen);\r\nif (err)\r\ngoto out;\r\n}\r\nout:\r\nkvfree(in);\r\nif (err)\r\nnetdev_err(priv->netdev, "refresh tir(0x%x) failed, %d\n", tirn, err);\r\nreturn err;\r\n}

int bpf_prog1(struct bpf_perf_event_data *ctx)\r\n{\r\nchar fmt[] = "CPU-%d period %lld ip %llx";\r\nu32 cpu = bpf_get_smp_processor_id();\r\nstruct key_t key;\r\nu64 *val, one = 1;\r\nif (ctx->sample_period < 10000)\r\nreturn 0;\r\nbpf_get_current_comm(&key.comm, sizeof(key.comm));\r\nkey.kernstack = bpf_get_stackid(ctx, &stackmap, KERN_STACKID_FLAGS);\r\nkey.userstack = bpf_get_stackid(ctx, &stackmap, USER_STACKID_FLAGS);\r\nif ((int)key.kernstack < 0 && (int)key.userstack < 0) {\r\nbpf_trace_printk(fmt, sizeof(fmt), cpu, ctx->sample_period,\r\nPT_REGS_IP(&ctx->regs));\r\nreturn 0;\r\n}\r\nval = bpf_map_lookup_elem(&counts, &key);\r\nif (val)\r\n(*val)++;\r\nelse\r\nbpf_map_update_elem(&counts, &key, &one, BPF_NOEXIST);\r\nreturn 0;\r\n}

static inline int pvrdma_cmd_recv(struct pvrdma_dev *dev,\r\nunion pvrdma_cmd_resp *resp,\r\nunsigned resp_code)\r\n{\r\nint err;\r\ndev_dbg(&dev->pdev->dev, "receive response from device\n");\r\nerr = wait_for_completion_interruptible_timeout(&dev->cmd_done,\r\nmsecs_to_jiffies(PVRDMA_CMD_TIMEOUT));\r\nif (err == 0 || err == -ERESTARTSYS) {\r\ndev_warn(&dev->pdev->dev,\r\n"completion timeout or interrupted\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nspin_lock(&dev->cmd_lock);\r\nmemcpy(resp, dev->resp_slot, sizeof(*resp));\r\nspin_unlock(&dev->cmd_lock);\r\nif (resp->hdr.ack != resp_code) {\r\ndev_warn(&dev->pdev->dev,\r\n"unknown response %#x expected %#x\n",\r\nresp->hdr.ack, resp_code);\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint\r\npvrdma_cmd_post(struct pvrdma_dev *dev, union pvrdma_cmd_req *req,\r\nunion pvrdma_cmd_resp *resp, unsigned resp_code)\r\n{\r\nint err;\r\ndev_dbg(&dev->pdev->dev, "post request to device\n");\r\ndown(&dev->cmd_sema);\r\nBUILD_BUG_ON(sizeof(union pvrdma_cmd_req) !=\r\nsizeof(struct pvrdma_cmd_modify_qp));\r\nspin_lock(&dev->cmd_lock);\r\nmemcpy(dev->cmd_slot, req, sizeof(*req));\r\nspin_unlock(&dev->cmd_lock);\r\ninit_completion(&dev->cmd_done);\r\npvrdma_write_reg(dev, PVRDMA_REG_REQUEST, 0);\r\nmb();\r\nerr = pvrdma_read_reg(dev, PVRDMA_REG_ERR);\r\nif (err == 0) {\r\nif (resp != NULL)\r\nerr = pvrdma_cmd_recv(dev, resp, resp_code);\r\n} else {\r\ndev_warn(&dev->pdev->dev,\r\n"failed to write request error reg: %d\n", err);\r\nerr = -EFAULT;\r\n}\r\nup(&dev->cmd_sema);\r\nreturn err;\r\n}

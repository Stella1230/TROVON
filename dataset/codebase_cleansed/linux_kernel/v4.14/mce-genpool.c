static bool is_duplicate_mce_record(struct mce_evt_llist *t, struct mce_evt_llist *l)\r\n{\r\nstruct mce_evt_llist *node;\r\nstruct mce *m1, *m2;\r\nm1 = &t->mce;\r\nllist_for_each_entry(node, &l->llnode, llnode) {\r\nm2 = &node->mce;\r\nif (!mce_cmp(m1, m2))\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstruct llist_node *mce_gen_pool_prepare_records(void)\r\n{\r\nstruct llist_node *head;\r\nLLIST_HEAD(new_head);\r\nstruct mce_evt_llist *node, *t;\r\nhead = llist_del_all(&mce_event_llist);\r\nif (!head)\r\nreturn NULL;\r\nllist_for_each_entry_safe(node, t, head, llnode) {\r\nif (!is_duplicate_mce_record(node, t))\r\nllist_add(&node->llnode, &new_head);\r\n}\r\nreturn new_head.first;\r\n}\r\nvoid mce_gen_pool_process(struct work_struct *__unused)\r\n{\r\nstruct llist_node *head;\r\nstruct mce_evt_llist *node, *tmp;\r\nstruct mce *mce;\r\nhead = llist_del_all(&mce_event_llist);\r\nif (!head)\r\nreturn;\r\nhead = llist_reverse_order(head);\r\nllist_for_each_entry_safe(node, tmp, head, llnode) {\r\nmce = &node->mce;\r\nblocking_notifier_call_chain(&x86_mce_decoder_chain, 0, mce);\r\ngen_pool_free(mce_evt_pool, (unsigned long)node, sizeof(*node));\r\n}\r\n}\r\nbool mce_gen_pool_empty(void)\r\n{\r\nreturn llist_empty(&mce_event_llist);\r\n}\r\nint mce_gen_pool_add(struct mce *mce)\r\n{\r\nstruct mce_evt_llist *node;\r\nif (!mce_evt_pool)\r\nreturn -EINVAL;\r\nnode = (void *)gen_pool_alloc(mce_evt_pool, sizeof(*node));\r\nif (!node) {\r\npr_warn_ratelimited("MCE records pool full!\n");\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(&node->mce, mce, sizeof(*mce));\r\nllist_add(&node->llnode, &mce_event_llist);\r\nreturn 0;\r\n}\r\nstatic int mce_gen_pool_create(void)\r\n{\r\nstruct gen_pool *tmpp;\r\nint ret = -ENOMEM;\r\ntmpp = gen_pool_create(ilog2(sizeof(struct mce_evt_llist)), -1);\r\nif (!tmpp)\r\ngoto out;\r\nret = gen_pool_add(tmpp, (unsigned long)gen_pool_buf, MCE_POOLSZ, -1);\r\nif (ret) {\r\ngen_pool_destroy(tmpp);\r\ngoto out;\r\n}\r\nmce_evt_pool = tmpp;\r\nout:\r\nreturn ret;\r\n}\r\nint mce_gen_pool_init(void)\r\n{\r\nif (mce_evt_pool)\r\nreturn 0;\r\nreturn mce_gen_pool_create();\r\n}

void bdisp_dbg_perf_begin(struct bdisp_dev *bdisp)\r\n{\r\nbdisp->dbg.hw_start = ktime_get();\r\n}\r\nvoid bdisp_dbg_perf_end(struct bdisp_dev *bdisp)\r\n{\r\ns64 time_us;\r\ntime_us = ktime_us_delta(ktime_get(), bdisp->dbg.hw_start);\r\nif (!bdisp->dbg.min_duration)\r\nbdisp->dbg.min_duration = time_us;\r\nelse\r\nbdisp->dbg.min_duration = min(time_us, bdisp->dbg.min_duration);\r\nbdisp->dbg.last_duration = time_us;\r\nbdisp->dbg.max_duration = max(time_us, bdisp->dbg.max_duration);\r\nbdisp->dbg.tot_duration += time_us;\r\n}\r\nstatic void bdisp_dbg_dump_ins(struct seq_file *s, u32 val)\r\n{\r\nseq_printf(s, "INS\t0x%08X\t", val);\r\nswitch (val & BLT_INS_S1_MASK) {\r\ncase BLT_INS_S1_OFF:\r\nbreak;\r\ncase BLT_INS_S1_MEM:\r\nseq_puts(s, "SRC1=mem - ");\r\nbreak;\r\ncase BLT_INS_S1_CF:\r\nseq_puts(s, "SRC1=ColorFill - ");\r\nbreak;\r\ncase BLT_INS_S1_COPY:\r\nseq_puts(s, "SRC1=copy - ");\r\nbreak;\r\ncase BLT_INS_S1_FILL:\r\nseq_puts(s, "SRC1=fil - ");\r\nbreak;\r\ndefault:\r\nseq_puts(s, "SRC1=??? - ");\r\nbreak;\r\n}\r\nswitch (val & BLT_INS_S2_MASK) {\r\ncase BLT_INS_S2_OFF:\r\nbreak;\r\ncase BLT_INS_S2_MEM:\r\nseq_puts(s, "SRC2=mem - ");\r\nbreak;\r\ncase BLT_INS_S2_CF:\r\nseq_puts(s, "SRC2=ColorFill - ");\r\nbreak;\r\ndefault:\r\nseq_puts(s, "SRC2=??? - ");\r\nbreak;\r\n}\r\nif ((val & BLT_INS_S3_MASK) == BLT_INS_S3_MEM)\r\nseq_puts(s, "SRC3=mem - ");\r\nif (val & BLT_INS_IVMX)\r\nseq_puts(s, "IVMX - ");\r\nif (val & BLT_INS_CLUT)\r\nseq_puts(s, "CLUT - ");\r\nif (val & BLT_INS_SCALE)\r\nseq_puts(s, "Scale - ");\r\nif (val & BLT_INS_FLICK)\r\nseq_puts(s, "Flicker - ");\r\nif (val & BLT_INS_CLIP)\r\nseq_puts(s, "Clip - ");\r\nif (val & BLT_INS_CKEY)\r\nseq_puts(s, "ColorKey - ");\r\nif (val & BLT_INS_OVMX)\r\nseq_puts(s, "OVMX - ");\r\nif (val & BLT_INS_DEI)\r\nseq_puts(s, "Deint - ");\r\nif (val & BLT_INS_PMASK)\r\nseq_puts(s, "PlaneMask - ");\r\nif (val & BLT_INS_VC1R)\r\nseq_puts(s, "VC1R - ");\r\nif (val & BLT_INS_ROTATE)\r\nseq_puts(s, "Rotate - ");\r\nif (val & BLT_INS_GRAD)\r\nseq_puts(s, "GradFill - ");\r\nif (val & BLT_INS_AQLOCK)\r\nseq_puts(s, "AQLock - ");\r\nif (val & BLT_INS_PACE)\r\nseq_puts(s, "Pace - ");\r\nif (val & BLT_INS_IRQ)\r\nseq_puts(s, "IRQ - ");\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_tty(struct seq_file *s, u32 val)\r\n{\r\nseq_printf(s, "TTY\t0x%08X\t", val);\r\nseq_printf(s, "Pitch=%d - ", val & 0xFFFF);\r\nswitch ((val & BLT_TTY_COL_MASK) >> BLT_TTY_COL_SHIFT) {\r\ncase BDISP_RGB565:\r\nseq_puts(s, "RGB565 - ");\r\nbreak;\r\ncase BDISP_RGB888:\r\nseq_puts(s, "RGB888 - ");\r\nbreak;\r\ncase BDISP_XRGB8888:\r\nseq_puts(s, "xRGB888 - ");\r\nbreak;\r\ncase BDISP_ARGB8888:\r\nseq_puts(s, "ARGB8888 - ");\r\nbreak;\r\ncase BDISP_NV12:\r\nseq_puts(s, "NV12 - ");\r\nbreak;\r\ncase BDISP_YUV_3B:\r\nseq_puts(s, "YUV420P - ");\r\nbreak;\r\ndefault:\r\nseq_puts(s, "ColorFormat ??? - ");\r\nbreak;\r\n}\r\nif (val & BLT_TTY_ALPHA_R)\r\nseq_puts(s, "AlphaRange - ");\r\nif (val & BLT_TTY_CR_NOT_CB)\r\nseq_puts(s, "CrNotCb - ");\r\nif (val & BLT_TTY_MB)\r\nseq_puts(s, "MB - ");\r\nif (val & BLT_TTY_HSO)\r\nseq_puts(s, "HSO inverse - ");\r\nif (val & BLT_TTY_VSO)\r\nseq_puts(s, "VSO inverse - ");\r\nif (val & BLT_TTY_DITHER)\r\nseq_puts(s, "Dither - ");\r\nif (val & BLT_TTY_CHROMA)\r\nseq_puts(s, "Write CHROMA - ");\r\nif (val & BLT_TTY_BIG_END)\r\nseq_puts(s, "BigEndian - ");\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_xy(struct seq_file *s, u32 val, char *name)\r\n{\r\nseq_printf(s, "%s\t0x%08X\t", name, val);\r\nseq_printf(s, "(%d,%d)\n", val & 0xFFFF, (val >> 16));\r\n}\r\nstatic void bdisp_dbg_dump_sz(struct seq_file *s, u32 val, char *name)\r\n{\r\nseq_printf(s, "%s\t0x%08X\t", name, val);\r\nseq_printf(s, "%dx%d\n", val & 0x1FFF, (val >> 16) & 0x1FFF);\r\n}\r\nstatic void bdisp_dbg_dump_sty(struct seq_file *s,\r\nu32 val, u32 addr, char *name)\r\n{\r\nbool s1, s2, s3;\r\nseq_printf(s, "%s\t0x%08X\t", name, val);\r\nif (!addr || !name || (strlen(name) < 2))\r\ngoto done;\r\ns1 = name[strlen(name) - 1] == '1';\r\ns2 = name[strlen(name) - 1] == '2';\r\ns3 = name[strlen(name) - 1] == '3';\r\nseq_printf(s, "Pitch=%d - ", val & 0xFFFF);\r\nswitch ((val & BLT_TTY_COL_MASK) >> BLT_TTY_COL_SHIFT) {\r\ncase BDISP_RGB565:\r\nseq_puts(s, "RGB565 - ");\r\nbreak;\r\ncase BDISP_RGB888:\r\nseq_puts(s, "RGB888 - ");\r\nbreak;\r\ncase BDISP_XRGB8888:\r\nseq_puts(s, "xRGB888 - ");\r\nbreak;\r\ncase BDISP_ARGB8888:\r\nseq_puts(s, "ARGB888 - ");\r\nbreak;\r\ncase BDISP_NV12:\r\nseq_puts(s, "NV12 - ");\r\nbreak;\r\ncase BDISP_YUV_3B:\r\nseq_puts(s, "YUV420P - ");\r\nbreak;\r\ndefault:\r\nseq_puts(s, "ColorFormat ??? - ");\r\nbreak;\r\n}\r\nif ((val & BLT_TTY_ALPHA_R) && !s3)\r\nseq_puts(s, "AlphaRange - ");\r\nif ((val & BLT_S1TY_A1_SUBSET) && !s3)\r\nseq_puts(s, "A1SubSet - ");\r\nif ((val & BLT_TTY_MB) && !s1)\r\nseq_puts(s, "MB - ");\r\nif (val & BLT_TTY_HSO)\r\nseq_puts(s, "HSO inverse - ");\r\nif (val & BLT_TTY_VSO)\r\nseq_puts(s, "VSO inverse - ");\r\nif ((val & BLT_S1TY_CHROMA_EXT) && (s1 || s2))\r\nseq_puts(s, "ChromaExt - ");\r\nif ((val & BLT_S3TY_BLANK_ACC) && s3)\r\nseq_puts(s, "Blank Acc - ");\r\nif ((val & BTL_S1TY_SUBBYTE) && !s3)\r\nseq_puts(s, "SubByte - ");\r\nif ((val & BLT_S1TY_RGB_EXP) && !s3)\r\nseq_puts(s, "RGBExpand - ");\r\nif ((val & BLT_TTY_BIG_END) && !s3)\r\nseq_puts(s, "BigEndian - ");\r\ndone:\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_fctl(struct seq_file *s, u32 val)\r\n{\r\nseq_printf(s, "FCTL\t0x%08X\t", val);\r\nif ((val & BLT_FCTL_Y_HV_SCALE) == BLT_FCTL_Y_HV_SCALE)\r\nseq_puts(s, "Resize Luma - ");\r\nelse if ((val & BLT_FCTL_Y_HV_SCALE) == BLT_FCTL_Y_HV_SAMPLE)\r\nseq_puts(s, "Sample Luma - ");\r\nif ((val & BLT_FCTL_HV_SCALE) == BLT_FCTL_HV_SCALE)\r\nseq_puts(s, "Resize Chroma");\r\nelse if ((val & BLT_FCTL_HV_SCALE) == BLT_FCTL_HV_SAMPLE)\r\nseq_puts(s, "Sample Chroma");\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_rsf(struct seq_file *s, u32 val, char *name)\r\n{\r\nu32 inc;\r\nseq_printf(s, "%s\t0x%08X\t", name, val);\r\nif (!val)\r\ngoto done;\r\ninc = val & 0xFFFF;\r\nseq_printf(s, "H: %d(6.10) / scale~%dx0.1 - ", inc, 1024 * 10 / inc);\r\ninc = val >> 16;\r\nseq_printf(s, "V: %d(6.10) / scale~%dx0.1", inc, 1024 * 10 / inc);\r\ndone:\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_rzi(struct seq_file *s, u32 val, char *name)\r\n{\r\nseq_printf(s, "%s\t0x%08X\t", name, val);\r\nif (!val)\r\ngoto done;\r\nseq_printf(s, "H: init=%d repeat=%d - ", val & 0x3FF, (val >> 12) & 7);\r\nval >>= 16;\r\nseq_printf(s, "V: init=%d repeat=%d", val & 0x3FF, (val >> 12) & 7);\r\ndone:\r\nseq_putc(s, '\n');\r\n}\r\nstatic void bdisp_dbg_dump_ivmx(struct seq_file *s,\r\nu32 c0, u32 c1, u32 c2, u32 c3)\r\n{\r\nseq_printf(s, "IVMX0\t0x%08X\n", c0);\r\nseq_printf(s, "IVMX1\t0x%08X\n", c1);\r\nseq_printf(s, "IVMX2\t0x%08X\n", c2);\r\nseq_printf(s, "IVMX3\t0x%08X\t", c3);\r\nif (!c0 && !c1 && !c2 && !c3) {\r\nseq_putc(s, '\n');\r\nreturn;\r\n}\r\nif ((c0 == bdisp_rgb_to_yuv[0]) &&\r\n(c1 == bdisp_rgb_to_yuv[1]) &&\r\n(c2 == bdisp_rgb_to_yuv[2]) &&\r\n(c3 == bdisp_rgb_to_yuv[3])) {\r\nseq_puts(s, "RGB to YUV\n");\r\nreturn;\r\n}\r\nif ((c0 == bdisp_yuv_to_rgb[0]) &&\r\n(c1 == bdisp_yuv_to_rgb[1]) &&\r\n(c2 == bdisp_yuv_to_rgb[2]) &&\r\n(c3 == bdisp_yuv_to_rgb[3])) {\r\nseq_puts(s, "YUV to RGB\n");\r\nreturn;\r\n}\r\nseq_puts(s, "Unknown conversion\n");\r\n}\r\nstatic int bdisp_dbg_last_nodes(struct seq_file *s, void *data)\r\n{\r\nstruct bdisp_dev *bdisp = s->private;\r\nstruct bdisp_node *node;\r\nint i = 0;\r\nif (!bdisp->dbg.copy_node[0]) {\r\nseq_puts(s, "No node built yet\n");\r\nreturn 0;\r\n}\r\ndo {\r\nnode = bdisp->dbg.copy_node[i];\r\nif (!node)\r\nbreak;\r\nseq_printf(s, "--------\nNode %d:\n", i);\r\nseq_puts(s, "-- General --\n");\r\nseq_printf(s, "NIP\t0x%08X\n", node->nip);\r\nseq_printf(s, "CIC\t0x%08X\n", node->cic);\r\nbdisp_dbg_dump_ins(s, node->ins);\r\nseq_printf(s, "ACK\t0x%08X\n", node->ack);\r\nseq_puts(s, "-- Target --\n");\r\nseq_printf(s, "TBA\t0x%08X\n", node->tba);\r\nbdisp_dbg_dump_tty(s, node->tty);\r\nbdisp_dbg_dump_xy(s, node->txy, "TXY");\r\nbdisp_dbg_dump_sz(s, node->tsz, "TSZ");\r\nseq_puts(s, "-- Source 1 --\n");\r\nseq_printf(s, "S1BA\t0x%08X\n", node->s1ba);\r\nbdisp_dbg_dump_sty(s, node->s1ty, node->s1ba, "S1TY");\r\nbdisp_dbg_dump_xy(s, node->s1xy, "S1XY");\r\nseq_puts(s, "-- Source 2 --\n");\r\nseq_printf(s, "S2BA\t0x%08X\n", node->s2ba);\r\nbdisp_dbg_dump_sty(s, node->s2ty, node->s2ba, "S2TY");\r\nbdisp_dbg_dump_xy(s, node->s2xy, "S2XY");\r\nbdisp_dbg_dump_sz(s, node->s2sz, "S2SZ");\r\nseq_puts(s, "-- Source 3 --\n");\r\nseq_printf(s, "S3BA\t0x%08X\n", node->s3ba);\r\nbdisp_dbg_dump_sty(s, node->s3ty, node->s3ba, "S3TY");\r\nbdisp_dbg_dump_xy(s, node->s3xy, "S3XY");\r\nbdisp_dbg_dump_sz(s, node->s3sz, "S3SZ");\r\nseq_puts(s, "-- Filter & Mask --\n");\r\nbdisp_dbg_dump_fctl(s, node->fctl);\r\nseq_puts(s, "-- Chroma Filter --\n");\r\nbdisp_dbg_dump_rsf(s, node->rsf, "RSF");\r\nbdisp_dbg_dump_rzi(s, node->rzi, "RZI");\r\nseq_printf(s, "HFP\t0x%08X\n", node->hfp);\r\nseq_printf(s, "VFP\t0x%08X\n", node->vfp);\r\nseq_puts(s, "-- Luma Filter --\n");\r\nbdisp_dbg_dump_rsf(s, node->y_rsf, "Y_RSF");\r\nbdisp_dbg_dump_rzi(s, node->y_rzi, "Y_RZI");\r\nseq_printf(s, "Y_HFP\t0x%08X\n", node->y_hfp);\r\nseq_printf(s, "Y_VFP\t0x%08X\n", node->y_vfp);\r\nseq_puts(s, "-- Input Versatile Matrix --\n");\r\nbdisp_dbg_dump_ivmx(s, node->ivmx0, node->ivmx1,\r\nnode->ivmx2, node->ivmx3);\r\n} while ((++i < MAX_NB_NODE) && node->nip);\r\nreturn 0;\r\n}\r\nstatic int bdisp_dbg_last_nodes_raw(struct seq_file *s, void *data)\r\n{\r\nstruct bdisp_dev *bdisp = s->private;\r\nstruct bdisp_node *node;\r\nu32 *val;\r\nint j, i = 0;\r\nif (!bdisp->dbg.copy_node[0]) {\r\nseq_puts(s, "No node built yet\n");\r\nreturn 0;\r\n}\r\ndo {\r\nnode = bdisp->dbg.copy_node[i];\r\nif (!node)\r\nbreak;\r\nseq_printf(s, "--------\nNode %d:\n", i);\r\nval = (u32 *)node;\r\nfor (j = 0; j < sizeof(struct bdisp_node) / sizeof(u32); j++)\r\nseq_printf(s, "0x%08X\n", *val++);\r\n} while ((++i < MAX_NB_NODE) && node->nip);\r\nreturn 0;\r\n}\r\nstatic const char *bdisp_fmt_to_str(struct bdisp_frame frame)\r\n{\r\nswitch (frame.fmt->pixelformat) {\r\ncase V4L2_PIX_FMT_YUV420:\r\nreturn "YUV420P";\r\ncase V4L2_PIX_FMT_NV12:\r\nif (frame.field == V4L2_FIELD_INTERLACED)\r\nreturn "NV12 interlaced";\r\nelse\r\nreturn "NV12";\r\ncase V4L2_PIX_FMT_RGB565:\r\nreturn "RGB16";\r\ncase V4L2_PIX_FMT_RGB24:\r\nreturn "RGB24";\r\ncase V4L2_PIX_FMT_XBGR32:\r\nreturn "XRGB";\r\ncase V4L2_PIX_FMT_ABGR32:\r\nreturn "ARGB";\r\ndefault:\r\nreturn "????";\r\n}\r\n}\r\nstatic int bdisp_dbg_last_request(struct seq_file *s, void *data)\r\n{\r\nstruct bdisp_dev *bdisp = s->private;\r\nstruct bdisp_request *request = &bdisp->dbg.copy_request;\r\nstruct bdisp_frame src, dst;\r\nif (!request->nb_req) {\r\nseq_puts(s, "No request\n");\r\nreturn 0;\r\n}\r\nsrc = request->src;\r\ndst = request->dst;\r\nseq_printf(s, "\nRequest #%d\n", request->nb_req);\r\nseq_printf(s, "Format: %s\t\t\t%s\n",\r\nbdisp_fmt_to_str(src), bdisp_fmt_to_str(dst));\r\nseq_printf(s, "Crop area: %dx%d @ %d,%d ==>\t%dx%d @ %d,%d\n",\r\nsrc.crop.width, src.crop.height,\r\nsrc.crop.left, src.crop.top,\r\ndst.crop.width, dst.crop.height,\r\ndst.crop.left, dst.crop.top);\r\nseq_printf(s, "Buff size: %dx%d\t\t%dx%d\n\n",\r\nsrc.width, src.height, dst.width, dst.height);\r\nif (request->hflip)\r\nseq_puts(s, "Horizontal flip\n\n");\r\nif (request->vflip)\r\nseq_puts(s, "Vertical flip\n\n");\r\nreturn 0;\r\n}\r\nstatic int bdisp_dbg_regs(struct seq_file *s, void *data)\r\n{\r\nstruct bdisp_dev *bdisp = s->private;\r\nint ret;\r\nunsigned int i;\r\nret = pm_runtime_get_sync(bdisp->dev);\r\nif (ret < 0) {\r\nseq_puts(s, "Cannot wake up IP\n");\r\nreturn 0;\r\n}\r\nseq_printf(s, "Reg @ = 0x%p\n", bdisp->regs);\r\nseq_puts(s, "\nStatic:\n");\r\nDUMP(BLT_CTL);\r\nDUMP(BLT_ITS);\r\nDUMP(BLT_STA1);\r\nDUMP(BLT_AQ1_CTL);\r\nDUMP(BLT_AQ1_IP);\r\nDUMP(BLT_AQ1_LNA);\r\nDUMP(BLT_AQ1_STA);\r\nDUMP(BLT_ITM0);\r\nseq_puts(s, "\nPlugs:\n");\r\nDUMP(BLT_PLUGS1_OP2);\r\nDUMP(BLT_PLUGS1_CHZ);\r\nDUMP(BLT_PLUGS1_MSZ);\r\nDUMP(BLT_PLUGS1_PGZ);\r\nDUMP(BLT_PLUGS2_OP2);\r\nDUMP(BLT_PLUGS2_CHZ);\r\nDUMP(BLT_PLUGS2_MSZ);\r\nDUMP(BLT_PLUGS2_PGZ);\r\nDUMP(BLT_PLUGS3_OP2);\r\nDUMP(BLT_PLUGS3_CHZ);\r\nDUMP(BLT_PLUGS3_MSZ);\r\nDUMP(BLT_PLUGS3_PGZ);\r\nDUMP(BLT_PLUGT_OP2);\r\nDUMP(BLT_PLUGT_CHZ);\r\nDUMP(BLT_PLUGT_MSZ);\r\nDUMP(BLT_PLUGT_PGZ);\r\nseq_puts(s, "\nNode:\n");\r\nDUMP(BLT_NIP);\r\nDUMP(BLT_CIC);\r\nDUMP(BLT_INS);\r\nDUMP(BLT_ACK);\r\nDUMP(BLT_TBA);\r\nDUMP(BLT_TTY);\r\nDUMP(BLT_TXY);\r\nDUMP(BLT_TSZ);\r\nDUMP(BLT_S1BA);\r\nDUMP(BLT_S1TY);\r\nDUMP(BLT_S1XY);\r\nDUMP(BLT_S2BA);\r\nDUMP(BLT_S2TY);\r\nDUMP(BLT_S2XY);\r\nDUMP(BLT_S2SZ);\r\nDUMP(BLT_S3BA);\r\nDUMP(BLT_S3TY);\r\nDUMP(BLT_S3XY);\r\nDUMP(BLT_S3SZ);\r\nDUMP(BLT_FCTL);\r\nDUMP(BLT_RSF);\r\nDUMP(BLT_RZI);\r\nDUMP(BLT_HFP);\r\nDUMP(BLT_VFP);\r\nDUMP(BLT_Y_RSF);\r\nDUMP(BLT_Y_RZI);\r\nDUMP(BLT_Y_HFP);\r\nDUMP(BLT_Y_VFP);\r\nDUMP(BLT_IVMX0);\r\nDUMP(BLT_IVMX1);\r\nDUMP(BLT_IVMX2);\r\nDUMP(BLT_IVMX3);\r\nDUMP(BLT_OVMX0);\r\nDUMP(BLT_OVMX1);\r\nDUMP(BLT_OVMX2);\r\nDUMP(BLT_OVMX3);\r\nDUMP(BLT_DEI);\r\nseq_puts(s, "\nFilter:\n");\r\nfor (i = 0; i < BLT_NB_H_COEF; i++) {\r\nseq_printf(s, "BLT_HFC%d \t0x%08X\n", i,\r\nreadl(bdisp->regs + BLT_HFC_N + i * 4));\r\n}\r\nfor (i = 0; i < BLT_NB_V_COEF; i++) {\r\nseq_printf(s, "BLT_VFC%d \t0x%08X\n", i,\r\nreadl(bdisp->regs + BLT_VFC_N + i * 4));\r\n}\r\nseq_puts(s, "\nLuma filter:\n");\r\nfor (i = 0; i < BLT_NB_H_COEF; i++) {\r\nseq_printf(s, "BLT_Y_HFC%d \t0x%08X\n", i,\r\nreadl(bdisp->regs + BLT_Y_HFC_N + i * 4));\r\n}\r\nfor (i = 0; i < BLT_NB_V_COEF; i++) {\r\nseq_printf(s, "BLT_Y_VFC%d \t0x%08X\n", i,\r\nreadl(bdisp->regs + BLT_Y_VFC_N + i * 4));\r\n}\r\npm_runtime_put(bdisp->dev);\r\nreturn 0;\r\n}\r\nstatic int bdisp_dbg_perf(struct seq_file *s, void *data)\r\n{\r\nstruct bdisp_dev *bdisp = s->private;\r\nstruct bdisp_request *request = &bdisp->dbg.copy_request;\r\ns64 avg_time_us;\r\nint avg_fps, min_fps, max_fps, last_fps;\r\nif (!request->nb_req) {\r\nseq_puts(s, "No request\n");\r\nreturn 0;\r\n}\r\navg_time_us = div64_s64(bdisp->dbg.tot_duration, request->nb_req);\r\nif (avg_time_us > SECOND)\r\navg_fps = 0;\r\nelse\r\navg_fps = SECOND / (s32)avg_time_us;\r\nif (bdisp->dbg.min_duration > SECOND)\r\nmin_fps = 0;\r\nelse\r\nmin_fps = SECOND / (s32)bdisp->dbg.min_duration;\r\nif (bdisp->dbg.max_duration > SECOND)\r\nmax_fps = 0;\r\nelse\r\nmax_fps = SECOND / (s32)bdisp->dbg.max_duration;\r\nif (bdisp->dbg.last_duration > SECOND)\r\nlast_fps = 0;\r\nelse\r\nlast_fps = SECOND / (s32)bdisp->dbg.last_duration;\r\nseq_printf(s, "HW processing (%d requests):\n", request->nb_req);\r\nseq_printf(s, " Average: %5lld us (%3d fps)\n",\r\navg_time_us, avg_fps);\r\nseq_printf(s, " Min-Max: %5lld us (%3d fps) - %5lld us (%3d fps)\n",\r\nbdisp->dbg.min_duration, min_fps,\r\nbdisp->dbg.max_duration, max_fps);\r\nseq_printf(s, " Last: %5lld us (%3d fps)\n",\r\nbdisp->dbg.last_duration, last_fps);\r\nreturn 0;\r\n}\r\nint bdisp_debugfs_create(struct bdisp_dev *bdisp)\r\n{\r\nchar dirname[16];\r\nsnprintf(dirname, sizeof(dirname), "%s%d", BDISP_NAME, bdisp->id);\r\nbdisp->dbg.debugfs_entry = debugfs_create_dir(dirname, NULL);\r\nif (!bdisp->dbg.debugfs_entry)\r\ngoto err;\r\nif (!bdisp_dbg_create_entry(regs))\r\ngoto err;\r\nif (!bdisp_dbg_create_entry(last_nodes))\r\ngoto err;\r\nif (!bdisp_dbg_create_entry(last_nodes_raw))\r\ngoto err;\r\nif (!bdisp_dbg_create_entry(last_request))\r\ngoto err;\r\nif (!bdisp_dbg_create_entry(perf))\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nbdisp_debugfs_remove(bdisp);\r\nreturn -ENOMEM;\r\n}\r\nvoid bdisp_debugfs_remove(struct bdisp_dev *bdisp)\r\n{\r\ndebugfs_remove_recursive(bdisp->dbg.debugfs_entry);\r\nbdisp->dbg.debugfs_entry = NULL;\r\n}

static unsigned long hi655x_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn 32768;\r\n}\r\nstatic int hi655x_clk_enable(struct clk_hw *hw, bool enable)\r\n{\r\nstruct hi655x_clk *hi655x_clk =\r\ncontainer_of(hw, struct hi655x_clk, clk_hw);\r\nstruct hi655x_pmic *hi655x = hi655x_clk->hi655x;\r\nreturn regmap_update_bits(hi655x->regmap, HI655X_CLK_BASE,\r\nHI655X_CLK_SET, enable ? HI655X_CLK_SET : 0);\r\n}\r\nstatic int hi655x_clk_prepare(struct clk_hw *hw)\r\n{\r\nreturn hi655x_clk_enable(hw, true);\r\n}\r\nstatic void hi655x_clk_unprepare(struct clk_hw *hw)\r\n{\r\nhi655x_clk_enable(hw, false);\r\n}\r\nstatic int hi655x_clk_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct hi655x_clk *hi655x_clk =\r\ncontainer_of(hw, struct hi655x_clk, clk_hw);\r\nstruct hi655x_pmic *hi655x = hi655x_clk->hi655x;\r\nint ret;\r\nuint32_t val;\r\nret = regmap_read(hi655x->regmap, HI655X_CLK_BASE, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn val & HI655X_CLK_BASE;\r\n}\r\nstatic int hi655x_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device *parent = pdev->dev.parent;\r\nstruct hi655x_pmic *hi655x = dev_get_drvdata(parent);\r\nstruct hi655x_clk *hi655x_clk;\r\nconst char *clk_name = "hi655x-clk";\r\nstruct clk_init_data init = {\r\n.name = clk_name,\r\n.ops = &hi655x_clk_ops\r\n};\r\nint ret;\r\nhi655x_clk = devm_kzalloc(&pdev->dev, sizeof(*hi655x_clk), GFP_KERNEL);\r\nif (!hi655x_clk)\r\nreturn -ENOMEM;\r\nof_property_read_string_index(parent->of_node, "clock-output-names",\r\n0, &clk_name);\r\nhi655x_clk->clk_hw.init = &init;\r\nhi655x_clk->hi655x = hi655x;\r\nplatform_set_drvdata(pdev, hi655x_clk);\r\nret = devm_clk_hw_register(&pdev->dev, &hi655x_clk->clk_hw);\r\nif (ret)\r\nreturn ret;\r\nreturn of_clk_add_hw_provider(parent->of_node, of_clk_hw_simple_get,\r\n&hi655x_clk->clk_hw);\r\n}

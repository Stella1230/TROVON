int sram_check_protect_exec(struct sram_dev *sram, struct sram_reserve *block,\r\nstruct sram_partition *part)\r\n{\r\nunsigned long base = (unsigned long)part->base;\r\nunsigned long end = base + block->size;\r\nif (!PAGE_ALIGNED(base) || !PAGE_ALIGNED(end)) {\r\ndev_err(sram->dev,\r\n"SRAM pool marked with 'protect-exec' is not page aligned and will not be created.\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nint sram_add_protect_exec(struct sram_partition *part)\r\n{\r\nmutex_lock(&exec_pool_list_mutex);\r\nlist_add_tail(&part->list, &exec_pool_list);\r\nmutex_unlock(&exec_pool_list_mutex);\r\nreturn 0;\r\n}\r\nvoid *sram_exec_copy(struct gen_pool *pool, void *dst, void *src,\r\nsize_t size)\r\n{\r\nstruct sram_partition *part = NULL, *p;\r\nunsigned long base;\r\nint pages;\r\nvoid *dst_cpy;\r\nmutex_lock(&exec_pool_list_mutex);\r\nlist_for_each_entry(p, &exec_pool_list, list) {\r\nif (p->pool == pool)\r\npart = p;\r\n}\r\nmutex_unlock(&exec_pool_list_mutex);\r\nif (!part)\r\nreturn NULL;\r\nif (!addr_in_gen_pool(pool, (unsigned long)dst, size))\r\nreturn NULL;\r\nbase = (unsigned long)part->base;\r\npages = PAGE_ALIGN(size) / PAGE_SIZE;\r\nmutex_lock(&part->lock);\r\nset_memory_nx((unsigned long)base, pages);\r\nset_memory_rw((unsigned long)base, pages);\r\ndst_cpy = fncpy(dst, src, size);\r\nset_memory_ro((unsigned long)base, pages);\r\nset_memory_x((unsigned long)base, pages);\r\nmutex_unlock(&part->lock);\r\nreturn dst_cpy;\r\n}

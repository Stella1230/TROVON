void da7219_aad_jack_det(struct snd_soc_codec *codec, struct snd_soc_jack *jack)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nda7219->aad->jack = jack;\r\nda7219->aad->jack_inserted = false;\r\nsnd_soc_jack_report(jack, 0, DA7219_AAD_REPORT_ALL_MASK);\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_ACCDET_EN_MASK,\r\n(jack ? DA7219_ACCDET_EN_MASK : 0));\r\n}\r\nstatic void da7219_aad_btn_det_work(struct work_struct *work)\r\n{\r\nstruct da7219_aad_priv *da7219_aad =\r\ncontainer_of(work, struct da7219_aad_priv, btn_det_work);\r\nstruct snd_soc_codec *codec = da7219_aad->codec;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nu8 statusa, micbias_ctrl;\r\nbool micbias_up = false;\r\nint retries = 0;\r\nsnd_soc_update_bits(codec, DA7219_HP_L_CTRL,\r\nDA7219_HP_L_AMP_OE_MASK,\r\nDA7219_HP_L_AMP_OE_MASK);\r\nsnd_soc_update_bits(codec, DA7219_HP_R_CTRL,\r\nDA7219_HP_R_AMP_OE_MASK,\r\nDA7219_HP_R_AMP_OE_MASK);\r\nsnd_soc_dapm_force_enable_pin(dapm, "Mic Bias");\r\nsnd_soc_dapm_sync(dapm);\r\ndo {\r\nstatusa = snd_soc_read(codec, DA7219_ACCDET_STATUS_A);\r\nif (statusa & DA7219_MICBIAS_UP_STS_MASK)\r\nmicbias_up = true;\r\nelse if (retries++ < DA7219_AAD_MICBIAS_CHK_RETRIES)\r\nmsleep(DA7219_AAD_MICBIAS_CHK_DELAY);\r\n} while ((!micbias_up) && (retries < DA7219_AAD_MICBIAS_CHK_RETRIES));\r\nif (retries >= DA7219_AAD_MICBIAS_CHK_RETRIES)\r\ndev_warn(codec->dev, "Mic bias status check timed out");\r\nif (da7219_aad->micbias_pulse_lvl && da7219_aad->micbias_pulse_time) {\r\nmicbias_ctrl = snd_soc_read(codec, DA7219_MICBIAS_CTRL);\r\nsnd_soc_update_bits(codec, DA7219_MICBIAS_CTRL,\r\nDA7219_MICBIAS1_LEVEL_MASK,\r\nda7219_aad->micbias_pulse_lvl);\r\nmsleep(da7219_aad->micbias_pulse_time);\r\nsnd_soc_write(codec, DA7219_MICBIAS_CTRL, micbias_ctrl);\r\n}\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_BUTTON_CONFIG_MASK,\r\nda7219_aad->btn_cfg);\r\n}\r\nstatic void da7219_aad_hptest_work(struct work_struct *work)\r\n{\r\nstruct da7219_aad_priv *da7219_aad =\r\ncontainer_of(work, struct da7219_aad_priv, hptest_work);\r\nstruct snd_soc_codec *codec = da7219_aad->codec;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nu16 tonegen_freq_hptest;\r\nu8 pll_srm_sts, pll_ctrl, gain_ramp_ctrl, accdet_cfg8;\r\nint report = 0, ret = 0;\r\nsnd_soc_dapm_mutex_lock(dapm);\r\nmutex_lock(&da7219->ctrl_lock);\r\nmutex_lock(&da7219->pll_lock);\r\nif (da7219->mclk) {\r\nret = clk_prepare_enable(da7219->mclk);\r\nif (ret) {\r\ndev_err(codec->dev, "Failed to enable mclk - %d\n", ret);\r\nmutex_unlock(&da7219->pll_lock);\r\nmutex_unlock(&da7219->ctrl_lock);\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\nreturn;\r\n}\r\n}\r\npll_srm_sts = snd_soc_read(codec, DA7219_PLL_SRM_STS);\r\nif (pll_srm_sts & DA7219_PLL_SRM_STS_MCLK) {\r\ntonegen_freq_hptest = cpu_to_le16(DA7219_AAD_HPTEST_RAMP_FREQ);\r\npll_ctrl = snd_soc_read(codec, DA7219_PLL_CTRL);\r\nif ((pll_ctrl & DA7219_PLL_MODE_MASK) == DA7219_PLL_MODE_BYPASS)\r\nda7219_set_pll(codec, DA7219_SYSCLK_PLL,\r\nDA7219_PLL_FREQ_OUT_98304);\r\n} else {\r\ntonegen_freq_hptest = cpu_to_le16(DA7219_AAD_HPTEST_RAMP_FREQ_INT_OSC);\r\n}\r\ngain_ramp_ctrl = snd_soc_read(codec, DA7219_GAIN_RAMP_CTRL);\r\nsnd_soc_write(codec, DA7219_GAIN_RAMP_CTRL, DA7219_GAIN_RAMP_RATE_X8);\r\nregcache_cache_bypass(da7219->regmap, true);\r\nsnd_soc_write(codec, DA7219_TONE_GEN_CFG1, 0);\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_8,\r\nDA7219_HPTEST_EN_MASK | DA7219_HPTEST_RES_SEL_MASK,\r\nDA7219_HPTEST_EN_MASK |\r\nDA7219_HPTEST_RES_SEL_1KOHMS);\r\nsnd_soc_write(codec, DA7219_DAC_L_GAIN, DA7219_DAC_DIGITAL_GAIN_0DB);\r\nsnd_soc_write(codec, DA7219_DAC_R_GAIN, DA7219_DAC_DIGITAL_GAIN_0DB);\r\nsnd_soc_write(codec, DA7219_HP_L_GAIN, DA7219_HP_AMP_GAIN_0DB);\r\nsnd_soc_write(codec, DA7219_HP_R_GAIN, DA7219_HP_AMP_GAIN_0DB);\r\nsnd_soc_update_bits(codec, DA7219_DAC_FILTERS1, DA7219_HPF_MODE_MASK,\r\n0);\r\nsnd_soc_update_bits(codec, DA7219_DAC_FILTERS4, DA7219_DAC_EQ_EN_MASK,\r\n0);\r\nsnd_soc_update_bits(codec, DA7219_DAC_FILTERS5,\r\nDA7219_DAC_SOFTMUTE_EN_MASK, 0);\r\nsnd_soc_update_bits(codec, DA7219_CP_CTRL, DA7219_CP_EN_MASK,\r\nDA7219_CP_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_DIG_ROUTING_DAC,\r\nDA7219_DAC_L_SRC_MASK | DA7219_DAC_R_SRC_MASK,\r\nDA7219_DAC_L_SRC_TONEGEN |\r\nDA7219_DAC_R_SRC_TONEGEN);\r\nsnd_soc_update_bits(codec, DA7219_DAC_L_CTRL,\r\nDA7219_DAC_L_EN_MASK | DA7219_DAC_L_MUTE_EN_MASK,\r\nDA7219_DAC_L_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_DAC_R_CTRL,\r\nDA7219_DAC_R_EN_MASK | DA7219_DAC_R_MUTE_EN_MASK,\r\nDA7219_DAC_R_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_MIXOUT_L_SELECT,\r\nDA7219_MIXOUT_L_MIX_SELECT_MASK,\r\nDA7219_MIXOUT_L_MIX_SELECT_MASK);\r\nsnd_soc_update_bits(codec, DA7219_MIXOUT_R_SELECT,\r\nDA7219_MIXOUT_R_MIX_SELECT_MASK,\r\nDA7219_MIXOUT_R_MIX_SELECT_MASK);\r\nsnd_soc_update_bits(codec, DA7219_DROUTING_ST_OUTFILT_1L,\r\nDA7219_OUTFILT_ST_1L_SRC_MASK,\r\nDA7219_DMIX_ST_SRC_OUTFILT1L);\r\nsnd_soc_update_bits(codec, DA7219_DROUTING_ST_OUTFILT_1R,\r\nDA7219_OUTFILT_ST_1R_SRC_MASK,\r\nDA7219_DMIX_ST_SRC_OUTFILT1R);\r\nsnd_soc_update_bits(codec, DA7219_MIXOUT_L_CTRL,\r\nDA7219_MIXOUT_L_AMP_EN_MASK,\r\nDA7219_MIXOUT_L_AMP_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_MIXOUT_R_CTRL,\r\nDA7219_MIXOUT_R_AMP_EN_MASK,\r\nDA7219_MIXOUT_R_AMP_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_HP_L_CTRL,\r\nDA7219_HP_L_AMP_OE_MASK | DA7219_HP_L_AMP_EN_MASK,\r\nDA7219_HP_L_AMP_OE_MASK | DA7219_HP_L_AMP_EN_MASK);\r\nsnd_soc_update_bits(codec, DA7219_HP_R_CTRL,\r\nDA7219_HP_R_AMP_OE_MASK | DA7219_HP_R_AMP_EN_MASK,\r\nDA7219_HP_R_AMP_OE_MASK | DA7219_HP_R_AMP_EN_MASK);\r\nmsleep(DA7219_SETTLING_DELAY);\r\nsnd_soc_update_bits(codec, DA7219_HP_L_CTRL,\r\nDA7219_HP_L_AMP_MUTE_EN_MASK |\r\nDA7219_HP_L_AMP_MIN_GAIN_EN_MASK, 0);\r\nsnd_soc_update_bits(codec, DA7219_HP_R_CTRL,\r\nDA7219_HP_R_AMP_MUTE_EN_MASK |\r\nDA7219_HP_R_AMP_MIN_GAIN_EN_MASK, 0);\r\nif (!(pll_srm_sts & DA7219_PLL_SRM_STS_MCLK))\r\nmsleep(DA7219_AAD_HPTEST_INT_OSC_PATH_DELAY);\r\nsnd_soc_write(codec, DA7219_TONE_GEN_ON_PER, DA7219_BEEP_ON_PER_MASK);\r\nregmap_raw_write(da7219->regmap, DA7219_TONE_GEN_FREQ1_L,\r\n&tonegen_freq_hptest, sizeof(tonegen_freq_hptest));\r\nsnd_soc_update_bits(codec, DA7219_TONE_GEN_CFG2,\r\nDA7219_SWG_SEL_MASK | DA7219_TONE_GEN_GAIN_MASK,\r\nDA7219_SWG_SEL_SRAMP |\r\nDA7219_TONE_GEN_GAIN_MINUS_15DB);\r\nsnd_soc_write(codec, DA7219_TONE_GEN_CFG1, DA7219_START_STOPN_MASK);\r\nmsleep(DA7219_AAD_HPTEST_PERIOD);\r\naccdet_cfg8 = snd_soc_read(codec, DA7219_ACCDET_CONFIG_8);\r\nif (accdet_cfg8 & DA7219_HPTEST_COMP_MASK)\r\nreport |= SND_JACK_HEADPHONE;\r\nelse\r\nreport |= SND_JACK_LINEOUT;\r\nsnd_soc_write(codec, DA7219_TONE_GEN_CFG1, 0);\r\nmsleep(DA7219_AAD_HPTEST_PERIOD);\r\nregcache_mark_dirty(da7219->regmap);\r\nregcache_sync_region(da7219->regmap, DA7219_HP_L_CTRL,\r\nDA7219_HP_R_CTRL);\r\nmsleep(DA7219_SETTLING_DELAY);\r\nregcache_sync_region(da7219->regmap, DA7219_MIXOUT_L_CTRL,\r\nDA7219_MIXOUT_R_CTRL);\r\nregcache_sync_region(da7219->regmap, DA7219_DROUTING_ST_OUTFILT_1L,\r\nDA7219_DROUTING_ST_OUTFILT_1R);\r\nregcache_sync_region(da7219->regmap, DA7219_MIXOUT_L_SELECT,\r\nDA7219_MIXOUT_R_SELECT);\r\nregcache_sync_region(da7219->regmap, DA7219_DAC_L_CTRL,\r\nDA7219_DAC_R_CTRL);\r\nregcache_sync_region(da7219->regmap, DA7219_DIG_ROUTING_DAC,\r\nDA7219_DIG_ROUTING_DAC);\r\nregcache_sync_region(da7219->regmap, DA7219_CP_CTRL, DA7219_CP_CTRL);\r\nregcache_sync_region(da7219->regmap, DA7219_DAC_FILTERS5,\r\nDA7219_DAC_FILTERS5);\r\nregcache_sync_region(da7219->regmap, DA7219_DAC_FILTERS4,\r\nDA7219_DAC_FILTERS1);\r\nregcache_sync_region(da7219->regmap, DA7219_HP_L_GAIN,\r\nDA7219_HP_R_GAIN);\r\nregcache_sync_region(da7219->regmap, DA7219_DAC_L_GAIN,\r\nDA7219_DAC_R_GAIN);\r\nregcache_sync_region(da7219->regmap, DA7219_TONE_GEN_ON_PER,\r\nDA7219_TONE_GEN_ON_PER);\r\nregcache_sync_region(da7219->regmap, DA7219_TONE_GEN_FREQ1_L,\r\nDA7219_TONE_GEN_FREQ1_U);\r\nregcache_sync_region(da7219->regmap, DA7219_TONE_GEN_CFG1,\r\nDA7219_TONE_GEN_CFG2);\r\nregcache_cache_bypass(da7219->regmap, false);\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_8,\r\nDA7219_HPTEST_EN_MASK, 0);\r\nif (!(pll_srm_sts & DA7219_PLL_SRM_STS_MCLK))\r\nmsleep(DA7219_AAD_HPTEST_INT_OSC_PATH_DELAY);\r\nsnd_soc_write(codec, DA7219_GAIN_RAMP_CTRL, gain_ramp_ctrl);\r\nsnd_soc_update_bits(codec, DA7219_HP_L_CTRL, DA7219_HP_L_AMP_OE_MASK,\r\nDA7219_HP_L_AMP_OE_MASK);\r\nsnd_soc_update_bits(codec, DA7219_HP_R_CTRL, DA7219_HP_R_AMP_OE_MASK,\r\nDA7219_HP_R_AMP_OE_MASK);\r\nif ((pll_srm_sts & DA7219_PLL_SRM_STS_MCLK) &&\r\n((pll_ctrl & DA7219_PLL_MODE_MASK) == DA7219_PLL_MODE_BYPASS))\r\nda7219_set_pll(codec, DA7219_SYSCLK_MCLK, 0);\r\nif (da7219->mclk)\r\nclk_disable_unprepare(da7219->mclk);\r\nmutex_unlock(&da7219->pll_lock);\r\nmutex_unlock(&da7219->ctrl_lock);\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\nif (da7219_aad->jack_inserted)\r\nsnd_soc_jack_report(da7219_aad->jack, report,\r\nSND_JACK_HEADSET | SND_JACK_LINEOUT);\r\n}\r\nstatic irqreturn_t da7219_aad_irq_thread(int irq, void *data)\r\n{\r\nstruct da7219_aad_priv *da7219_aad = data;\r\nstruct snd_soc_codec *codec = da7219_aad->codec;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nu8 events[DA7219_AAD_IRQ_REG_MAX];\r\nu8 statusa;\r\nint i, report = 0, mask = 0;\r\nregmap_bulk_read(da7219->regmap, DA7219_ACCDET_IRQ_EVENT_A,\r\nevents, DA7219_AAD_IRQ_REG_MAX);\r\nif (!events[DA7219_AAD_IRQ_REG_A] && !events[DA7219_AAD_IRQ_REG_B])\r\nreturn IRQ_NONE;\r\nstatusa = snd_soc_read(codec, DA7219_ACCDET_STATUS_A);\r\nregmap_bulk_write(da7219->regmap, DA7219_ACCDET_IRQ_EVENT_A,\r\nevents, DA7219_AAD_IRQ_REG_MAX);\r\ndev_dbg(codec->dev, "IRQ events = 0x%x|0x%x, status = 0x%x\n",\r\nevents[DA7219_AAD_IRQ_REG_A], events[DA7219_AAD_IRQ_REG_B],\r\nstatusa);\r\nif (statusa & DA7219_JACK_INSERTION_STS_MASK) {\r\nif (events[DA7219_AAD_IRQ_REG_A] &\r\nDA7219_E_JACK_INSERTED_MASK) {\r\nreport |= SND_JACK_MECHANICAL;\r\nmask |= SND_JACK_MECHANICAL;\r\nda7219_aad->jack_inserted = true;\r\n}\r\nif (events[DA7219_AAD_IRQ_REG_A] &\r\nDA7219_E_JACK_DETECT_COMPLETE_MASK) {\r\nif (statusa & DA7219_JACK_TYPE_STS_MASK) {\r\nreport |= SND_JACK_HEADSET;\r\nmask |= SND_JACK_HEADSET | SND_JACK_LINEOUT;\r\nschedule_work(&da7219_aad->btn_det_work);\r\n} else {\r\nschedule_work(&da7219_aad->hptest_work);\r\n}\r\n}\r\nif (statusa & DA7219_JACK_TYPE_STS_MASK) {\r\nfor (i = 0; i < DA7219_AAD_MAX_BUTTONS; ++i) {\r\nif (events[DA7219_AAD_IRQ_REG_B] &\r\n(DA7219_E_BUTTON_A_PRESSED_MASK << i)) {\r\nreport |= SND_JACK_BTN_0 >> i;\r\nmask |= SND_JACK_BTN_0 >> i;\r\n}\r\n}\r\nsnd_soc_jack_report(da7219_aad->jack, report, mask);\r\nfor (i = 0; i < DA7219_AAD_MAX_BUTTONS; ++i) {\r\nif (events[DA7219_AAD_IRQ_REG_B] &\r\n(DA7219_E_BUTTON_A_RELEASED_MASK >> i)) {\r\nreport &= ~(SND_JACK_BTN_0 >> i);\r\nmask |= SND_JACK_BTN_0 >> i;\r\n}\r\n}\r\n}\r\n} else {\r\nif (events[DA7219_AAD_IRQ_REG_A] & DA7219_E_JACK_REMOVED_MASK) {\r\nreport = 0;\r\nmask |= DA7219_AAD_REPORT_ALL_MASK;\r\nda7219_aad->jack_inserted = false;\r\nsnd_soc_update_bits(codec, DA7219_HP_R_CTRL,\r\nDA7219_HP_R_AMP_OE_MASK, 0);\r\nsnd_soc_update_bits(codec, DA7219_HP_L_CTRL,\r\nDA7219_HP_L_AMP_OE_MASK, 0);\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_BUTTON_CONFIG_MASK, 0);\r\nsnd_soc_dapm_disable_pin(dapm, "Mic Bias");\r\nsnd_soc_dapm_sync(dapm);\r\ncancel_work_sync(&da7219_aad->btn_det_work);\r\ncancel_work_sync(&da7219_aad->hptest_work);\r\n}\r\n}\r\nsnd_soc_jack_report(da7219_aad->jack, report, mask);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic enum da7219_aad_micbias_pulse_lvl\r\nda7219_aad_fw_micbias_pulse_lvl(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 2800:\r\nreturn DA7219_AAD_MICBIAS_PULSE_LVL_2_8V;\r\ncase 2900:\r\nreturn DA7219_AAD_MICBIAS_PULSE_LVL_2_9V;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid micbias pulse level");\r\nreturn DA7219_AAD_MICBIAS_PULSE_LVL_OFF;\r\n}\r\n}\r\nstatic enum da7219_aad_btn_cfg\r\nda7219_aad_fw_btn_cfg(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 2:\r\nreturn DA7219_AAD_BTN_CFG_2MS;\r\ncase 5:\r\nreturn DA7219_AAD_BTN_CFG_5MS;\r\ncase 10:\r\nreturn DA7219_AAD_BTN_CFG_10MS;\r\ncase 50:\r\nreturn DA7219_AAD_BTN_CFG_50MS;\r\ncase 100:\r\nreturn DA7219_AAD_BTN_CFG_100MS;\r\ncase 200:\r\nreturn DA7219_AAD_BTN_CFG_200MS;\r\ncase 500:\r\nreturn DA7219_AAD_BTN_CFG_500MS;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid button config");\r\nreturn DA7219_AAD_BTN_CFG_10MS;\r\n}\r\n}\r\nstatic enum da7219_aad_mic_det_thr\r\nda7219_aad_fw_mic_det_thr(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 200:\r\nreturn DA7219_AAD_MIC_DET_THR_200_OHMS;\r\ncase 500:\r\nreturn DA7219_AAD_MIC_DET_THR_500_OHMS;\r\ncase 750:\r\nreturn DA7219_AAD_MIC_DET_THR_750_OHMS;\r\ncase 1000:\r\nreturn DA7219_AAD_MIC_DET_THR_1000_OHMS;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid mic detect threshold");\r\nreturn DA7219_AAD_MIC_DET_THR_500_OHMS;\r\n}\r\n}\r\nstatic enum da7219_aad_jack_ins_deb\r\nda7219_aad_fw_jack_ins_deb(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 5:\r\nreturn DA7219_AAD_JACK_INS_DEB_5MS;\r\ncase 10:\r\nreturn DA7219_AAD_JACK_INS_DEB_10MS;\r\ncase 20:\r\nreturn DA7219_AAD_JACK_INS_DEB_20MS;\r\ncase 50:\r\nreturn DA7219_AAD_JACK_INS_DEB_50MS;\r\ncase 100:\r\nreturn DA7219_AAD_JACK_INS_DEB_100MS;\r\ncase 200:\r\nreturn DA7219_AAD_JACK_INS_DEB_200MS;\r\ncase 500:\r\nreturn DA7219_AAD_JACK_INS_DEB_500MS;\r\ncase 1000:\r\nreturn DA7219_AAD_JACK_INS_DEB_1S;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid jack insert debounce");\r\nreturn DA7219_AAD_JACK_INS_DEB_20MS;\r\n}\r\n}\r\nstatic enum da7219_aad_jack_det_rate\r\nda7219_aad_fw_jack_det_rate(struct snd_soc_codec *codec, const char *str)\r\n{\r\nif (!strcmp(str, "32ms_64ms")) {\r\nreturn DA7219_AAD_JACK_DET_RATE_32_64MS;\r\n} else if (!strcmp(str, "64ms_128ms")) {\r\nreturn DA7219_AAD_JACK_DET_RATE_64_128MS;\r\n} else if (!strcmp(str, "128ms_256ms")) {\r\nreturn DA7219_AAD_JACK_DET_RATE_128_256MS;\r\n} else if (!strcmp(str, "256ms_512ms")) {\r\nreturn DA7219_AAD_JACK_DET_RATE_256_512MS;\r\n} else {\r\ndev_warn(codec->dev, "Invalid jack detect rate");\r\nreturn DA7219_AAD_JACK_DET_RATE_256_512MS;\r\n}\r\n}\r\nstatic enum da7219_aad_jack_rem_deb\r\nda7219_aad_fw_jack_rem_deb(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 1:\r\nreturn DA7219_AAD_JACK_REM_DEB_1MS;\r\ncase 5:\r\nreturn DA7219_AAD_JACK_REM_DEB_5MS;\r\ncase 10:\r\nreturn DA7219_AAD_JACK_REM_DEB_10MS;\r\ncase 20:\r\nreturn DA7219_AAD_JACK_REM_DEB_20MS;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid jack removal debounce");\r\nreturn DA7219_AAD_JACK_REM_DEB_1MS;\r\n}\r\n}\r\nstatic enum da7219_aad_btn_avg\r\nda7219_aad_fw_btn_avg(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 1:\r\nreturn DA7219_AAD_BTN_AVG_1;\r\ncase 2:\r\nreturn DA7219_AAD_BTN_AVG_2;\r\ncase 4:\r\nreturn DA7219_AAD_BTN_AVG_4;\r\ncase 8:\r\nreturn DA7219_AAD_BTN_AVG_8;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid button average value");\r\nreturn DA7219_AAD_BTN_AVG_2;\r\n}\r\n}\r\nstatic enum da7219_aad_adc_1bit_rpt\r\nda7219_aad_fw_adc_1bit_rpt(struct snd_soc_codec *codec, u32 val)\r\n{\r\nswitch (val) {\r\ncase 1:\r\nreturn DA7219_AAD_ADC_1BIT_RPT_1;\r\ncase 2:\r\nreturn DA7219_AAD_ADC_1BIT_RPT_2;\r\ncase 4:\r\nreturn DA7219_AAD_ADC_1BIT_RPT_4;\r\ncase 8:\r\nreturn DA7219_AAD_ADC_1BIT_RPT_8;\r\ndefault:\r\ndev_warn(codec->dev, "Invalid ADC 1-bit repeat value");\r\nreturn DA7219_AAD_ADC_1BIT_RPT_1;\r\n}\r\n}\r\nstatic struct da7219_aad_pdata *da7219_aad_fw_to_pdata(struct snd_soc_codec *codec)\r\n{\r\nstruct device *dev = codec->dev;\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct fwnode_handle *aad_np;\r\nstruct da7219_aad_pdata *aad_pdata;\r\nconst char *fw_str;\r\nu32 fw_val32;\r\naad_np = device_get_named_child_node(dev, "da7219_aad");\r\nif (!aad_np)\r\nreturn NULL;\r\naad_pdata = devm_kzalloc(codec->dev, sizeof(*aad_pdata), GFP_KERNEL);\r\nif (!aad_pdata)\r\nreturn NULL;\r\naad_pdata->irq = i2c->irq;\r\nif (fwnode_property_read_u32(aad_np, "dlg,micbias-pulse-lvl",\r\n&fw_val32) >= 0)\r\naad_pdata->micbias_pulse_lvl =\r\nda7219_aad_fw_micbias_pulse_lvl(codec, fw_val32);\r\nelse\r\naad_pdata->micbias_pulse_lvl = DA7219_AAD_MICBIAS_PULSE_LVL_OFF;\r\nif (fwnode_property_read_u32(aad_np, "dlg,micbias-pulse-time",\r\n&fw_val32) >= 0)\r\naad_pdata->micbias_pulse_time = fw_val32;\r\nif (fwnode_property_read_u32(aad_np, "dlg,btn-cfg", &fw_val32) >= 0)\r\naad_pdata->btn_cfg = da7219_aad_fw_btn_cfg(codec, fw_val32);\r\nelse\r\naad_pdata->btn_cfg = DA7219_AAD_BTN_CFG_10MS;\r\nif (fwnode_property_read_u32(aad_np, "dlg,mic-det-thr", &fw_val32) >= 0)\r\naad_pdata->mic_det_thr =\r\nda7219_aad_fw_mic_det_thr(codec, fw_val32);\r\nelse\r\naad_pdata->mic_det_thr = DA7219_AAD_MIC_DET_THR_500_OHMS;\r\nif (fwnode_property_read_u32(aad_np, "dlg,jack-ins-deb", &fw_val32) >= 0)\r\naad_pdata->jack_ins_deb =\r\nda7219_aad_fw_jack_ins_deb(codec, fw_val32);\r\nelse\r\naad_pdata->jack_ins_deb = DA7219_AAD_JACK_INS_DEB_20MS;\r\nif (!fwnode_property_read_string(aad_np, "dlg,jack-det-rate", &fw_str))\r\naad_pdata->jack_det_rate =\r\nda7219_aad_fw_jack_det_rate(codec, fw_str);\r\nelse\r\naad_pdata->jack_det_rate = DA7219_AAD_JACK_DET_RATE_256_512MS;\r\nif (fwnode_property_read_u32(aad_np, "dlg,jack-rem-deb", &fw_val32) >= 0)\r\naad_pdata->jack_rem_deb =\r\nda7219_aad_fw_jack_rem_deb(codec, fw_val32);\r\nelse\r\naad_pdata->jack_rem_deb = DA7219_AAD_JACK_REM_DEB_1MS;\r\nif (fwnode_property_read_u32(aad_np, "dlg,a-d-btn-thr", &fw_val32) >= 0)\r\naad_pdata->a_d_btn_thr = (u8) fw_val32;\r\nelse\r\naad_pdata->a_d_btn_thr = 0xA;\r\nif (fwnode_property_read_u32(aad_np, "dlg,d-b-btn-thr", &fw_val32) >= 0)\r\naad_pdata->d_b_btn_thr = (u8) fw_val32;\r\nelse\r\naad_pdata->d_b_btn_thr = 0x16;\r\nif (fwnode_property_read_u32(aad_np, "dlg,b-c-btn-thr", &fw_val32) >= 0)\r\naad_pdata->b_c_btn_thr = (u8) fw_val32;\r\nelse\r\naad_pdata->b_c_btn_thr = 0x21;\r\nif (fwnode_property_read_u32(aad_np, "dlg,c-mic-btn-thr", &fw_val32) >= 0)\r\naad_pdata->c_mic_btn_thr = (u8) fw_val32;\r\nelse\r\naad_pdata->c_mic_btn_thr = 0x3E;\r\nif (fwnode_property_read_u32(aad_np, "dlg,btn-avg", &fw_val32) >= 0)\r\naad_pdata->btn_avg = da7219_aad_fw_btn_avg(codec, fw_val32);\r\nelse\r\naad_pdata->btn_avg = DA7219_AAD_BTN_AVG_2;\r\nif (fwnode_property_read_u32(aad_np, "dlg,adc-1bit-rpt", &fw_val32) >= 0)\r\naad_pdata->adc_1bit_rpt =\r\nda7219_aad_fw_adc_1bit_rpt(codec, fw_val32);\r\nelse\r\naad_pdata->adc_1bit_rpt = DA7219_AAD_ADC_1BIT_RPT_1;\r\nreturn aad_pdata;\r\n}\r\nstatic void da7219_aad_handle_pdata(struct snd_soc_codec *codec)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nstruct da7219_aad_priv *da7219_aad = da7219->aad;\r\nstruct da7219_pdata *pdata = da7219->pdata;\r\nif ((pdata) && (pdata->aad_pdata)) {\r\nstruct da7219_aad_pdata *aad_pdata = pdata->aad_pdata;\r\nu8 cfg, mask;\r\nda7219_aad->irq = aad_pdata->irq;\r\nswitch (aad_pdata->micbias_pulse_lvl) {\r\ncase DA7219_AAD_MICBIAS_PULSE_LVL_2_8V:\r\ncase DA7219_AAD_MICBIAS_PULSE_LVL_2_9V:\r\nda7219_aad->micbias_pulse_lvl =\r\n(aad_pdata->micbias_pulse_lvl <<\r\nDA7219_MICBIAS1_LEVEL_SHIFT);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nda7219_aad->micbias_pulse_time = aad_pdata->micbias_pulse_time;\r\nswitch (aad_pdata->btn_cfg) {\r\ncase DA7219_AAD_BTN_CFG_2MS:\r\ncase DA7219_AAD_BTN_CFG_5MS:\r\ncase DA7219_AAD_BTN_CFG_10MS:\r\ncase DA7219_AAD_BTN_CFG_50MS:\r\ncase DA7219_AAD_BTN_CFG_100MS:\r\ncase DA7219_AAD_BTN_CFG_200MS:\r\ncase DA7219_AAD_BTN_CFG_500MS:\r\nda7219_aad->btn_cfg = (aad_pdata->btn_cfg <<\r\nDA7219_BUTTON_CONFIG_SHIFT);\r\n}\r\ncfg = 0;\r\nmask = 0;\r\nswitch (aad_pdata->mic_det_thr) {\r\ncase DA7219_AAD_MIC_DET_THR_200_OHMS:\r\ncase DA7219_AAD_MIC_DET_THR_500_OHMS:\r\ncase DA7219_AAD_MIC_DET_THR_750_OHMS:\r\ncase DA7219_AAD_MIC_DET_THR_1000_OHMS:\r\ncfg |= (aad_pdata->mic_det_thr <<\r\nDA7219_MIC_DET_THRESH_SHIFT);\r\nmask |= DA7219_MIC_DET_THRESH_MASK;\r\n}\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1, mask, cfg);\r\ncfg = 0;\r\nmask = 0;\r\nswitch (aad_pdata->jack_ins_deb) {\r\ncase DA7219_AAD_JACK_INS_DEB_5MS:\r\ncase DA7219_AAD_JACK_INS_DEB_10MS:\r\ncase DA7219_AAD_JACK_INS_DEB_20MS:\r\ncase DA7219_AAD_JACK_INS_DEB_50MS:\r\ncase DA7219_AAD_JACK_INS_DEB_100MS:\r\ncase DA7219_AAD_JACK_INS_DEB_200MS:\r\ncase DA7219_AAD_JACK_INS_DEB_500MS:\r\ncase DA7219_AAD_JACK_INS_DEB_1S:\r\ncfg |= (aad_pdata->jack_ins_deb <<\r\nDA7219_JACKDET_DEBOUNCE_SHIFT);\r\nmask |= DA7219_JACKDET_DEBOUNCE_MASK;\r\n}\r\nswitch (aad_pdata->jack_det_rate) {\r\ncase DA7219_AAD_JACK_DET_RATE_32_64MS:\r\ncase DA7219_AAD_JACK_DET_RATE_64_128MS:\r\ncase DA7219_AAD_JACK_DET_RATE_128_256MS:\r\ncase DA7219_AAD_JACK_DET_RATE_256_512MS:\r\ncfg |= (aad_pdata->jack_det_rate <<\r\nDA7219_JACK_DETECT_RATE_SHIFT);\r\nmask |= DA7219_JACK_DETECT_RATE_MASK;\r\n}\r\nswitch (aad_pdata->jack_rem_deb) {\r\ncase DA7219_AAD_JACK_REM_DEB_1MS:\r\ncase DA7219_AAD_JACK_REM_DEB_5MS:\r\ncase DA7219_AAD_JACK_REM_DEB_10MS:\r\ncase DA7219_AAD_JACK_REM_DEB_20MS:\r\ncfg |= (aad_pdata->jack_rem_deb <<\r\nDA7219_JACKDET_REM_DEB_SHIFT);\r\nmask |= DA7219_JACKDET_REM_DEB_MASK;\r\n}\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_2, mask, cfg);\r\nsnd_soc_write(codec, DA7219_ACCDET_CONFIG_3,\r\naad_pdata->a_d_btn_thr);\r\nsnd_soc_write(codec, DA7219_ACCDET_CONFIG_4,\r\naad_pdata->d_b_btn_thr);\r\nsnd_soc_write(codec, DA7219_ACCDET_CONFIG_5,\r\naad_pdata->b_c_btn_thr);\r\nsnd_soc_write(codec, DA7219_ACCDET_CONFIG_6,\r\naad_pdata->c_mic_btn_thr);\r\ncfg = 0;\r\nmask = 0;\r\nswitch (aad_pdata->btn_avg) {\r\ncase DA7219_AAD_BTN_AVG_1:\r\ncase DA7219_AAD_BTN_AVG_2:\r\ncase DA7219_AAD_BTN_AVG_4:\r\ncase DA7219_AAD_BTN_AVG_8:\r\ncfg |= (aad_pdata->btn_avg <<\r\nDA7219_BUTTON_AVERAGE_SHIFT);\r\nmask |= DA7219_BUTTON_AVERAGE_MASK;\r\n}\r\nswitch (aad_pdata->adc_1bit_rpt) {\r\ncase DA7219_AAD_ADC_1BIT_RPT_1:\r\ncase DA7219_AAD_ADC_1BIT_RPT_2:\r\ncase DA7219_AAD_ADC_1BIT_RPT_4:\r\ncase DA7219_AAD_ADC_1BIT_RPT_8:\r\ncfg |= (aad_pdata->adc_1bit_rpt <<\r\nDA7219_ADC_1_BIT_REPEAT_SHIFT);\r\nmask |= DA7219_ADC_1_BIT_REPEAT_MASK;\r\n}\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_7, mask, cfg);\r\n}\r\n}\r\nvoid da7219_aad_suspend(struct snd_soc_codec *codec)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nstruct da7219_aad_priv *da7219_aad = da7219->aad;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nu8 micbias_ctrl;\r\nif (da7219_aad->jack) {\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_ACCDET_EN_MASK, 0);\r\nif (da7219_aad->jack_inserted) {\r\nmicbias_ctrl = snd_soc_read(codec, DA7219_MICBIAS_CTRL);\r\nif (micbias_ctrl & DA7219_MICBIAS1_EN_MASK) {\r\nsnd_soc_dapm_disable_pin(dapm, "Mic Bias");\r\nsnd_soc_dapm_sync(dapm);\r\nda7219_aad->micbias_resume_enable = true;\r\n}\r\n}\r\n}\r\n}\r\nvoid da7219_aad_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nstruct da7219_aad_priv *da7219_aad = da7219->aad;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nif (da7219_aad->jack) {\r\nif (da7219_aad->jack_inserted &&\r\nda7219_aad->micbias_resume_enable) {\r\nsnd_soc_dapm_force_enable_pin(dapm, "Mic Bias");\r\nsnd_soc_dapm_sync(dapm);\r\nda7219_aad->micbias_resume_enable = false;\r\n}\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_ACCDET_EN_MASK,\r\nDA7219_ACCDET_EN_MASK);\r\n}\r\n}\r\nint da7219_aad_init(struct snd_soc_codec *codec)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nstruct da7219_aad_priv *da7219_aad;\r\nu8 mask[DA7219_AAD_IRQ_REG_MAX];\r\nint ret;\r\nda7219_aad = devm_kzalloc(codec->dev, sizeof(*da7219_aad), GFP_KERNEL);\r\nif (!da7219_aad)\r\nreturn -ENOMEM;\r\nda7219->aad = da7219_aad;\r\nda7219_aad->codec = codec;\r\nif (da7219->pdata && !da7219->pdata->aad_pdata)\r\nda7219->pdata->aad_pdata = da7219_aad_fw_to_pdata(codec);\r\nda7219_aad_handle_pdata(codec);\r\nsnd_soc_update_bits(codec, DA7219_ACCDET_CONFIG_1,\r\nDA7219_BUTTON_CONFIG_MASK, 0);\r\nINIT_WORK(&da7219_aad->btn_det_work, da7219_aad_btn_det_work);\r\nINIT_WORK(&da7219_aad->hptest_work, da7219_aad_hptest_work);\r\nret = request_threaded_irq(da7219_aad->irq, NULL,\r\nda7219_aad_irq_thread,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"da7219-aad", da7219_aad);\r\nif (ret) {\r\ndev_err(codec->dev, "Failed to request IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\nmemset(mask, 0, DA7219_AAD_IRQ_REG_MAX);\r\nregmap_bulk_write(da7219->regmap, DA7219_ACCDET_IRQ_MASK_A,\r\n&mask, DA7219_AAD_IRQ_REG_MAX);\r\nreturn 0;\r\n}\r\nvoid da7219_aad_exit(struct snd_soc_codec *codec)\r\n{\r\nstruct da7219_priv *da7219 = snd_soc_codec_get_drvdata(codec);\r\nstruct da7219_aad_priv *da7219_aad = da7219->aad;\r\nu8 mask[DA7219_AAD_IRQ_REG_MAX];\r\nmemset(mask, DA7219_BYTE_MASK, DA7219_AAD_IRQ_REG_MAX);\r\nregmap_bulk_write(da7219->regmap, DA7219_ACCDET_IRQ_MASK_A,\r\nmask, DA7219_AAD_IRQ_REG_MAX);\r\nfree_irq(da7219_aad->irq, da7219_aad);\r\ncancel_work_sync(&da7219_aad->btn_det_work);\r\ncancel_work_sync(&da7219_aad->hptest_work);\r\n}

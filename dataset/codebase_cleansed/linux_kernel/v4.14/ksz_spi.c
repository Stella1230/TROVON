static int ksz_spi_read_reg(struct spi_device *spi, u32 reg, u8 *val,\r\nunsigned int len)\r\n{\r\nu32 txbuf;\r\nint ret;\r\ntxbuf = reg & SPI_ADDR_MASK;\r\ntxbuf |= KS_SPIOP_RD << SPI_ADDR_SHIFT;\r\ntxbuf <<= SPI_TURNAROUND_SHIFT;\r\ntxbuf = cpu_to_be32(txbuf);\r\nret = spi_write_then_read(spi, &txbuf, 4, val, len);\r\nreturn ret;\r\n}\r\nstatic int ksz_spi_read(struct ksz_device *dev, u32 reg, u8 *data,\r\nunsigned int len)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nreturn ksz_spi_read_reg(spi, reg, data, len);\r\n}\r\nstatic int ksz_spi_read8(struct ksz_device *dev, u32 reg, u8 *val)\r\n{\r\nreturn ksz_spi_read(dev, reg, val, 1);\r\n}\r\nstatic int ksz_spi_read16(struct ksz_device *dev, u32 reg, u16 *val)\r\n{\r\nint ret = ksz_spi_read(dev, reg, (u8 *)val, 2);\r\nif (!ret)\r\n*val = be16_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int ksz_spi_read24(struct ksz_device *dev, u32 reg, u32 *val)\r\n{\r\nint ret;\r\n*val = 0;\r\nret = ksz_spi_read(dev, reg, (u8 *)val, 3);\r\nif (!ret) {\r\n*val = be32_to_cpu(*val);\r\n*val >>= 8;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ksz_spi_read32(struct ksz_device *dev, u32 reg, u32 *val)\r\n{\r\nint ret = ksz_spi_read(dev, reg, (u8 *)val, 4);\r\nif (!ret)\r\n*val = be32_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int ksz_spi_write_reg(struct spi_device *spi, u32 reg, u8 *val,\r\nunsigned int len)\r\n{\r\nu32 txbuf;\r\nu8 data[12];\r\nint i;\r\ntxbuf = reg & SPI_ADDR_MASK;\r\ntxbuf |= (KS_SPIOP_WR << SPI_ADDR_SHIFT);\r\ntxbuf <<= SPI_TURNAROUND_SHIFT;\r\ntxbuf = cpu_to_be32(txbuf);\r\ndata[0] = txbuf & 0xFF;\r\ndata[1] = (txbuf & 0xFF00) >> 8;\r\ndata[2] = (txbuf & 0xFF0000) >> 16;\r\ndata[3] = (txbuf & 0xFF000000) >> 24;\r\nfor (i = 0; i < len; i++)\r\ndata[i + 4] = val[i];\r\nreturn spi_write(spi, &data, 4 + len);\r\n}\r\nstatic int ksz_spi_write8(struct ksz_device *dev, u32 reg, u8 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nreturn ksz_spi_write_reg(spi, reg, &value, 1);\r\n}\r\nstatic int ksz_spi_write16(struct ksz_device *dev, u32 reg, u16 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nvalue = cpu_to_be16(value);\r\nreturn ksz_spi_write_reg(spi, reg, (u8 *)&value, 2);\r\n}\r\nstatic int ksz_spi_write24(struct ksz_device *dev, u32 reg, u32 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nvalue <<= 8;\r\nvalue = cpu_to_be32(value);\r\nreturn ksz_spi_write_reg(spi, reg, (u8 *)&value, 3);\r\n}\r\nstatic int ksz_spi_write32(struct ksz_device *dev, u32 reg, u32 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nvalue = cpu_to_be32(value);\r\nreturn ksz_spi_write_reg(spi, reg, (u8 *)&value, 4);\r\n}\r\nstatic int ksz_spi_probe(struct spi_device *spi)\r\n{\r\nstruct ksz_device *dev;\r\nint ret;\r\ndev = ksz_switch_alloc(&spi->dev, &ksz_spi_ops, spi);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (spi->dev.platform_data)\r\ndev->pdata = spi->dev.platform_data;\r\nret = ksz_switch_register(dev);\r\nif (ret)\r\nreturn ret;\r\nspi_set_drvdata(spi, dev);\r\nreturn 0;\r\n}\r\nstatic int ksz_spi_remove(struct spi_device *spi)\r\n{\r\nstruct ksz_device *dev = spi_get_drvdata(spi);\r\nif (dev)\r\nksz_switch_remove(dev);\r\nreturn 0;\r\n}

static void\r\nfill_row(short *private, const short *public, unsigned width, unsigned padding)\r\n{\r\nassert((int)width >= 0);\r\nassert((int)padding >= 0);\r\nmemcpy (private, public, width*sizeof(short));\r\nmemset (&private[width], 0, padding*sizeof(short));\r\n}\r\nvoid ia_css_sdis_horicoef_vmem_encode (\r\nstruct sh_css_isp_sdis_hori_coef_tbl *to,\r\nconst struct ia_css_dvs_coefficients *from,\r\nunsigned size)\r\n{\r\nunsigned aligned_width = from->grid.aligned_width * from->grid.bqs_per_grid_cell;\r\nunsigned width = from->grid.num_hor_coefs;\r\nint padding = aligned_width-width;\r\nunsigned stride = size/IA_CSS_DVS_NUM_COEF_TYPES/sizeof(short);\r\nunsigned total_bytes = aligned_width*IA_CSS_DVS_NUM_COEF_TYPES*sizeof(short);\r\nshort *public = from->hor_coefs;\r\nshort *private = (short*)to;\r\nunsigned type;\r\nassert(padding >= 0);\r\nassert(total_bytes <= size);\r\nassert(size % (IA_CSS_DVS_NUM_COEF_TYPES*ISP_VEC_NELEMS*sizeof(short)) == 0);\r\nfor (type = 0; type < IA_CSS_DVS_NUM_COEF_TYPES; type++) {\r\nfill_row(&private[type*stride], &public[type*width], width, padding);\r\n}\r\n}\r\nvoid ia_css_sdis_vertcoef_vmem_encode (\r\nstruct sh_css_isp_sdis_vert_coef_tbl *to,\r\nconst struct ia_css_dvs_coefficients *from,\r\nunsigned size)\r\n{\r\nunsigned aligned_height = from->grid.aligned_height * from->grid.bqs_per_grid_cell;\r\nunsigned height = from->grid.num_ver_coefs;\r\nint padding = aligned_height-height;\r\nunsigned stride = size/IA_CSS_DVS_NUM_COEF_TYPES/sizeof(short);\r\nunsigned total_bytes = aligned_height*IA_CSS_DVS_NUM_COEF_TYPES*sizeof(short);\r\nshort *public = from->ver_coefs;\r\nshort *private = (short*)to;\r\nunsigned type;\r\nassert(padding >= 0);\r\nassert(total_bytes <= size);\r\nassert(size % (IA_CSS_DVS_NUM_COEF_TYPES*ISP_VEC_NELEMS*sizeof(short)) == 0);\r\nfor (type = 0; type < IA_CSS_DVS_NUM_COEF_TYPES; type++) {\r\nfill_row(&private[type*stride], &public[type*height], height, padding);\r\n}\r\n}\r\nvoid ia_css_sdis_horiproj_encode (\r\nstruct sh_css_isp_sdis_hori_proj_tbl *to,\r\nconst struct ia_css_dvs_coefficients *from,\r\nunsigned size)\r\n{\r\n(void)to;\r\n(void)from;\r\n(void)size;\r\n}\r\nvoid ia_css_sdis_vertproj_encode (\r\nstruct sh_css_isp_sdis_vert_proj_tbl *to,\r\nconst struct ia_css_dvs_coefficients *from,\r\nunsigned size)\r\n{\r\n(void)to;\r\n(void)from;\r\n(void)size;\r\n}\r\nvoid ia_css_get_isp_dis_coefficients(\r\nstruct ia_css_stream *stream,\r\nshort *horizontal_coefficients,\r\nshort *vertical_coefficients)\r\n{\r\nstruct ia_css_isp_parameters *params;\r\nunsigned int hor_num_isp, ver_num_isp;\r\nunsigned int hor_num_3a, ver_num_3a;\r\nint i;\r\nstruct ia_css_binary *dvs_binary;\r\nIA_CSS_ENTER("void");\r\nassert(horizontal_coefficients != NULL);\r\nassert(vertical_coefficients != NULL);\r\nparams = stream->isp_params_configs;\r\ndvs_binary = ia_css_stream_get_dvs_binary(stream);\r\nif (!dvs_binary)\r\nreturn;\r\nhor_num_isp = dvs_binary->dis.coef.pad.width;\r\nver_num_isp = dvs_binary->dis.coef.pad.height;\r\nhor_num_3a = dvs_binary->dis.coef.dim.width;\r\nver_num_3a = dvs_binary->dis.coef.dim.height;\r\nfor (i = 0; i < IA_CSS_DVS_NUM_COEF_TYPES; i++) {\r\nfill_row(&horizontal_coefficients[i*hor_num_isp],\r\n&params->dvs_coefs.hor_coefs[i*hor_num_3a], hor_num_3a, hor_num_isp-hor_num_3a);\r\n}\r\nfor (i = 0; i < SH_CSS_DIS_VER_NUM_COEF_TYPES(dvs_binary); i++) {\r\nfill_row(&vertical_coefficients[i*ver_num_isp],\r\n&params->dvs_coefs.ver_coefs[i*ver_num_3a], ver_num_3a, ver_num_isp-ver_num_3a);\r\n}\r\nIA_CSS_LEAVE("void");\r\n}\r\nsize_t\r\nia_css_sdis_hor_coef_tbl_bytes(\r\nconst struct ia_css_binary *binary)\r\n{\r\nif (binary->info->sp.pipeline.isp_pipe_version == 1)\r\nreturn sizeof(short) * IA_CSS_DVS_NUM_COEF_TYPES * binary->dis.coef.pad.width;\r\nelse\r\nreturn sizeof(short) * IA_CSS_DVS2_NUM_COEF_TYPES * binary->dis.coef.pad.width;\r\n}\r\nsize_t\r\nia_css_sdis_ver_coef_tbl_bytes(\r\nconst struct ia_css_binary *binary)\r\n{\r\nreturn sizeof(short) * SH_CSS_DIS_VER_NUM_COEF_TYPES(binary) * binary->dis.coef.pad.height;\r\n}\r\nvoid\r\nia_css_sdis_init_info(\r\nstruct ia_css_sdis_info *dis,\r\nunsigned sc_3a_dis_width,\r\nunsigned sc_3a_dis_padded_width,\r\nunsigned sc_3a_dis_height,\r\nunsigned isp_pipe_version,\r\nunsigned enabled)\r\n{\r\nif (!enabled) {\r\nstruct ia_css_sdis_info default_dis = IA_CSS_DEFAULT_SDIS_INFO;\r\n*dis = default_dis;\r\nreturn;\r\n}\r\ndis->deci_factor_log2 = SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->grid.dim.width =\r\n_ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->grid.dim.height =\r\n_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->grid.pad.width =\r\nCEIL_SHIFT(_ISP_BQS(sc_3a_dis_padded_width), SH_CSS_DIS_DECI_FACTOR_LOG2);\r\ndis->grid.pad.height =\r\nCEIL_SHIFT(_ISP_BQS(sc_3a_dis_height), SH_CSS_DIS_DECI_FACTOR_LOG2);\r\ndis->coef.dim.width =\r\n(_ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2) << SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->coef.dim.height =\r\n(_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2) << SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->coef.pad.width =\r\n__ISP_SDIS_HOR_COEF_NUM_VECS(sc_3a_dis_padded_width) * ISP_VEC_NELEMS;\r\ndis->coef.pad.height =\r\n__ISP_SDIS_VER_COEF_NUM_VECS(sc_3a_dis_height) * ISP_VEC_NELEMS;\r\nif (isp_pipe_version == 1) {\r\ndis->proj.dim.width =\r\n_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\r\ndis->proj.dim.height =\r\n_ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\r\n} else {\r\ndis->proj.dim.width =\r\n(_ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2) *\r\n(_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2);\r\ndis->proj.dim.height =\r\n(_ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2) *\r\n(_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2);\r\n}\r\ndis->proj.pad.width =\r\n__ISP_SDIS_HOR_PROJ_NUM_ISP(sc_3a_dis_padded_width,\r\nsc_3a_dis_height,\r\nSH_CSS_DIS_DECI_FACTOR_LOG2,\r\nisp_pipe_version);\r\ndis->proj.pad.height =\r\n__ISP_SDIS_VER_PROJ_NUM_ISP(sc_3a_dis_padded_width,\r\nSH_CSS_DIS_DECI_FACTOR_LOG2);\r\n}\r\nvoid ia_css_sdis_clear_coefficients(\r\nstruct ia_css_dvs_coefficients *dvs_coefs)\r\n{\r\ndvs_coefs->hor_coefs = NULL;\r\ndvs_coefs->ver_coefs = NULL;\r\n}\r\nenum ia_css_err\r\nia_css_get_dvs_statistics(\r\nstruct ia_css_dvs_statistics *host_stats,\r\nconst struct ia_css_isp_dvs_statistics *isp_stats)\r\n{\r\nstruct ia_css_isp_dvs_statistics_map *map;\r\nenum ia_css_err ret = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER("host_stats=%p, isp_stats=%p", host_stats, isp_stats);\r\nassert(host_stats != NULL);\r\nassert(isp_stats != NULL);\r\nmap = ia_css_isp_dvs_statistics_map_allocate(isp_stats, NULL);\r\nif (map) {\r\nmmgr_load(isp_stats->data_ptr, map->data_ptr, isp_stats->size);\r\nia_css_translate_dvs_statistics(host_stats, map);\r\nia_css_isp_dvs_statistics_map_free(map);\r\n} else {\r\nIA_CSS_ERROR("out of memory");\r\nret = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nIA_CSS_LEAVE_ERR(ret);\r\nreturn ret;\r\n}\r\nvoid\r\nia_css_translate_dvs_statistics(\r\nstruct ia_css_dvs_statistics *host_stats,\r\nconst struct ia_css_isp_dvs_statistics_map *isp_stats)\r\n{\r\nunsigned int hor_num_isp, ver_num_isp, hor_num_dvs, ver_num_dvs, i;\r\nint32_t *hor_ptr_dvs, *ver_ptr_dvs, *hor_ptr_isp, *ver_ptr_isp;\r\nassert(host_stats != NULL);\r\nassert(host_stats->hor_proj != NULL);\r\nassert(host_stats->ver_proj != NULL);\r\nassert(isp_stats != NULL);\r\nassert(isp_stats->hor_proj != NULL);\r\nassert(isp_stats->ver_proj != NULL);\r\nIA_CSS_ENTER("hproj=%p, vproj=%p, haddr=%p, vaddr=%p",\r\nhost_stats->hor_proj, host_stats->ver_proj,\r\nisp_stats->hor_proj, isp_stats->ver_proj);\r\nhor_num_isp = host_stats->grid.aligned_height;\r\nver_num_isp = host_stats->grid.aligned_width;\r\nhor_ptr_isp = isp_stats->hor_proj;\r\nver_ptr_isp = isp_stats->ver_proj;\r\nhor_num_dvs = host_stats->grid.height;\r\nver_num_dvs = host_stats->grid.width;\r\nhor_ptr_dvs = host_stats->hor_proj;\r\nver_ptr_dvs = host_stats->ver_proj;\r\nfor (i = 0; i < IA_CSS_DVS_NUM_COEF_TYPES; i++) {\r\nmemcpy(hor_ptr_dvs, hor_ptr_isp, hor_num_dvs * sizeof(int32_t));\r\nhor_ptr_isp += hor_num_isp;\r\nhor_ptr_dvs += hor_num_dvs;\r\nmemcpy(ver_ptr_dvs, ver_ptr_isp, ver_num_dvs * sizeof(int32_t));\r\nver_ptr_isp += ver_num_isp;\r\nver_ptr_dvs += ver_num_dvs;\r\n}\r\nIA_CSS_LEAVE("void");\r\n}\r\nstruct ia_css_isp_dvs_statistics *\r\nia_css_isp_dvs_statistics_allocate(\r\nconst struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_isp_dvs_statistics *me;\r\nint hor_size, ver_size;\r\nassert(grid != NULL);\r\nIA_CSS_ENTER("grid=%p", grid);\r\nif (!grid->enable)\r\nreturn NULL;\r\nme = sh_css_calloc(1,sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nhor_size = CEIL_MUL(sizeof(int) * IA_CSS_DVS_NUM_COEF_TYPES * grid->aligned_height,\r\nHIVE_ISP_DDR_WORD_BYTES);\r\nver_size = CEIL_MUL(sizeof(int) * IA_CSS_DVS_NUM_COEF_TYPES * grid->aligned_width,\r\nHIVE_ISP_DDR_WORD_BYTES);\r\nme->size = hor_size + ver_size;\r\nme->data_ptr = mmgr_malloc(me->size);\r\nif (me->data_ptr == mmgr_NULL)\r\ngoto err;\r\nme->hor_size = hor_size;\r\nme->hor_proj = me->data_ptr;\r\nme->ver_size = ver_size;\r\nme->ver_proj = me->data_ptr + hor_size;\r\nIA_CSS_LEAVE("return=%p", me);\r\nreturn me;\r\nerr:\r\nia_css_isp_dvs_statistics_free(me);\r\nIA_CSS_LEAVE("return=%p", NULL);\r\nreturn NULL;\r\n}\r\nstruct ia_css_isp_dvs_statistics_map *\r\nia_css_isp_dvs_statistics_map_allocate(\r\nconst struct ia_css_isp_dvs_statistics *isp_stats,\r\nvoid *data_ptr)\r\n{\r\nstruct ia_css_isp_dvs_statistics_map *me;\r\nchar *base_ptr;\r\nme = sh_css_malloc(sizeof(*me));\r\nif (!me) {\r\nIA_CSS_LOG("cannot allocate memory");\r\ngoto err;\r\n}\r\nme->data_ptr = data_ptr;\r\nme->data_allocated = data_ptr == NULL;\r\nif (!me->data_ptr) {\r\nme->data_ptr = sh_css_malloc(isp_stats->size);\r\nif (!me->data_ptr) {\r\nIA_CSS_LOG("cannot allocate memory");\r\ngoto err;\r\n}\r\n}\r\nbase_ptr = me->data_ptr;\r\nme->size = isp_stats->size;\r\nme->hor_proj = (void*)base_ptr;\r\nme->ver_proj = (void*)(base_ptr + isp_stats->hor_size);\r\nreturn me;\r\nerr:\r\nif (me)\r\nsh_css_free(me);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_isp_dvs_statistics_map_free(struct ia_css_isp_dvs_statistics_map *me)\r\n{\r\nif (me) {\r\nif (me->data_allocated)\r\nsh_css_free(me->data_ptr);\r\nsh_css_free(me);\r\n}\r\n}\r\nvoid\r\nia_css_isp_dvs_statistics_free(struct ia_css_isp_dvs_statistics *me)\r\n{\r\nif (me != NULL) {\r\nhmm_free(me->data_ptr);\r\nsh_css_free(me);\r\n}\r\n}\r\nvoid ia_css_sdis_horicoef_debug_dtrace(\r\nconst struct ia_css_dvs_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis_vertcoef_debug_dtrace(\r\nconst struct ia_css_dvs_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis_horiproj_debug_dtrace(\r\nconst struct ia_css_dvs_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis_vertproj_debug_dtrace(\r\nconst struct ia_css_dvs_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}

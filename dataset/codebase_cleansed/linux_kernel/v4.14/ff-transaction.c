static void finish_transmit_midi_msg(struct snd_ff *ff, unsigned int port,\r\nint rcode)\r\n{\r\nstruct snd_rawmidi_substream *substream =\r\nACCESS_ONCE(ff->rx_midi_substreams[port]);\r\nif (rcode_is_permanent_error(rcode)) {\r\nff->rx_midi_error[port] = true;\r\nreturn;\r\n}\r\nif (rcode != RCODE_COMPLETE) {\r\nff->next_ktime[port] = 0;\r\nschedule_work(&ff->rx_midi_work[port]);\r\nreturn;\r\n}\r\nsnd_rawmidi_transmit_ack(substream, ff->rx_bytes[port]);\r\nff->rx_bytes[port] = 0;\r\nif (!snd_rawmidi_transmit_empty(substream))\r\nschedule_work(&ff->rx_midi_work[port]);\r\n}\r\nstatic void finish_transmit_midi0_msg(struct fw_card *card, int rcode,\r\nvoid *data, size_t length,\r\nvoid *callback_data)\r\n{\r\nstruct snd_ff *ff =\r\ncontainer_of(callback_data, struct snd_ff, transactions[0]);\r\nfinish_transmit_midi_msg(ff, 0, rcode);\r\n}\r\nstatic void finish_transmit_midi1_msg(struct fw_card *card, int rcode,\r\nvoid *data, size_t length,\r\nvoid *callback_data)\r\n{\r\nstruct snd_ff *ff =\r\ncontainer_of(callback_data, struct snd_ff, transactions[1]);\r\nfinish_transmit_midi_msg(ff, 1, rcode);\r\n}\r\nstatic inline void fill_midi_buf(struct snd_ff *ff, unsigned int port,\r\nunsigned int index, u8 byte)\r\n{\r\nff->msg_buf[port][index] = cpu_to_le32(byte);\r\n}\r\nstatic void transmit_midi_msg(struct snd_ff *ff, unsigned int port)\r\n{\r\nstruct snd_rawmidi_substream *substream =\r\nACCESS_ONCE(ff->rx_midi_substreams[port]);\r\nu8 *buf = (u8 *)ff->msg_buf[port];\r\nint i, len;\r\nstruct fw_device *fw_dev = fw_parent_device(ff->unit);\r\nunsigned long long addr;\r\nint generation;\r\nfw_transaction_callback_t callback;\r\nif (substream == NULL || snd_rawmidi_transmit_empty(substream))\r\nreturn;\r\nif (ff->rx_bytes[port] > 0 || ff->rx_midi_error[port])\r\nreturn;\r\nif (ktime_after(ff->next_ktime[port], ktime_get())) {\r\nschedule_work(&ff->rx_midi_work[port]);\r\nreturn;\r\n}\r\nlen = snd_rawmidi_transmit_peek(substream, buf,\r\nSND_FF_MAXIMIM_MIDI_QUADS);\r\nif (len <= 0)\r\nreturn;\r\nfor (i = len - 1; i >= 0; i--)\r\nfill_midi_buf(ff, port, i, buf[i]);\r\nif (port == 0) {\r\naddr = ff->spec->protocol->midi_rx_port_0_reg;\r\ncallback = finish_transmit_midi0_msg;\r\n} else {\r\naddr = ff->spec->protocol->midi_rx_port_1_reg;\r\ncallback = finish_transmit_midi1_msg;\r\n}\r\nff->next_ktime[port] = ktime_add_ns(ktime_get(),\r\nlen * 8 * NSEC_PER_SEC / 31250);\r\nff->rx_bytes[port] = len;\r\ngeneration = fw_dev->generation;\r\nsmp_rmb();\r\nfw_send_request(fw_dev->card, &ff->transactions[port],\r\nTCODE_WRITE_BLOCK_REQUEST,\r\nfw_dev->node_id, generation, fw_dev->max_speed,\r\naddr, &ff->msg_buf[port], len * 4,\r\ncallback, &ff->transactions[port]);\r\n}\r\nstatic void transmit_midi0_msg(struct work_struct *work)\r\n{\r\nstruct snd_ff *ff = container_of(work, struct snd_ff, rx_midi_work[0]);\r\ntransmit_midi_msg(ff, 0);\r\n}\r\nstatic void transmit_midi1_msg(struct work_struct *work)\r\n{\r\nstruct snd_ff *ff = container_of(work, struct snd_ff, rx_midi_work[1]);\r\ntransmit_midi_msg(ff, 1);\r\n}\r\nstatic void handle_midi_msg(struct fw_card *card, struct fw_request *request,\r\nint tcode, int destination, int source,\r\nint generation, unsigned long long offset,\r\nvoid *data, size_t length, void *callback_data)\r\n{\r\nstruct snd_ff *ff = callback_data;\r\n__le32 *buf = data;\r\nu32 quad;\r\nu8 byte;\r\nunsigned int index;\r\nstruct snd_rawmidi_substream *substream;\r\nint i;\r\nfw_send_response(card, request, RCODE_COMPLETE);\r\nfor (i = 0; i < length / 4; i++) {\r\nquad = le32_to_cpu(buf[i]);\r\nindex = (quad >> 8) & 0xff;\r\nif (index > 0) {\r\nsubstream = ACCESS_ONCE(ff->tx_midi_substreams[0]);\r\nif (substream != NULL) {\r\nbyte = quad & 0xff;\r\nsnd_rawmidi_receive(substream, &byte, 1);\r\n}\r\n}\r\nindex = (quad >> 24) & 0xff;\r\nif (index > 0) {\r\nsubstream = ACCESS_ONCE(ff->tx_midi_substreams[1]);\r\nif (substream != NULL) {\r\nbyte = (quad >> 16) & 0xff;\r\nsnd_rawmidi_receive(substream, &byte, 1);\r\n}\r\n}\r\n}\r\n}\r\nstatic int allocate_own_address(struct snd_ff *ff, int i)\r\n{\r\nstruct fw_address_region midi_msg_region;\r\nint err;\r\nff->async_handler.length = SND_FF_MAXIMIM_MIDI_QUADS * 4;\r\nff->async_handler.address_callback = handle_midi_msg;\r\nff->async_handler.callback_data = ff;\r\nmidi_msg_region.start = 0x000100000000ull * i;\r\nmidi_msg_region.end = midi_msg_region.start + ff->async_handler.length;\r\nerr = fw_core_add_address_handler(&ff->async_handler, &midi_msg_region);\r\nif (err >= 0) {\r\nif (ff->async_handler.offset & 0x0000ffffffff) {\r\nfw_core_remove_address_handler(&ff->async_handler);\r\nerr = -EAGAIN;\r\n}\r\n}\r\nreturn err;\r\n}\r\nint snd_ff_transaction_reregister(struct snd_ff *ff)\r\n{\r\nstruct fw_card *fw_card = fw_parent_device(ff->unit)->card;\r\nu32 addr;\r\n__le32 reg;\r\naddr = (fw_card->node_id << 16) | (ff->async_handler.offset >> 32);\r\nreg = cpu_to_le32(addr);\r\nreturn snd_fw_transaction(ff->unit, TCODE_WRITE_QUADLET_REQUEST,\r\nff->spec->protocol->midi_high_addr_reg,\r\n&reg, sizeof(reg), 0);\r\n}\r\nint snd_ff_transaction_register(struct snd_ff *ff)\r\n{\r\nint i, err;\r\nfor (i = 0; i < 0xffff; i++) {\r\nerr = allocate_own_address(ff, i);\r\nif (err != -EBUSY && err != -EAGAIN)\r\nbreak;\r\n}\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ff_transaction_reregister(ff);\r\nif (err < 0)\r\nreturn err;\r\nINIT_WORK(&ff->rx_midi_work[0], transmit_midi0_msg);\r\nINIT_WORK(&ff->rx_midi_work[1], transmit_midi1_msg);\r\nreturn 0;\r\n}\r\nvoid snd_ff_transaction_unregister(struct snd_ff *ff)\r\n{\r\n__le32 reg;\r\nif (ff->async_handler.callback_data == NULL)\r\nreturn;\r\nff->async_handler.callback_data = NULL;\r\nreg = cpu_to_le32(0x00000000);\r\nsnd_fw_transaction(ff->unit, TCODE_WRITE_QUADLET_REQUEST,\r\nff->spec->protocol->midi_high_addr_reg,\r\n&reg, sizeof(reg), 0);\r\nfw_core_remove_address_handler(&ff->async_handler);\r\n}

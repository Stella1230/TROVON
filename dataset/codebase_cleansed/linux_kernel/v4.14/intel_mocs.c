static bool get_mocs_settings(struct drm_i915_private *dev_priv,\r\nstruct drm_i915_mocs_table *table)\r\n{\r\nbool result = false;\r\nif (IS_GEN9_BC(dev_priv) || IS_CANNONLAKE(dev_priv)) {\r\ntable->size = ARRAY_SIZE(skylake_mocs_table);\r\ntable->table = skylake_mocs_table;\r\nresult = true;\r\n} else if (IS_GEN9_LP(dev_priv)) {\r\ntable->size = ARRAY_SIZE(broxton_mocs_table);\r\ntable->table = broxton_mocs_table;\r\nresult = true;\r\n} else {\r\nWARN_ONCE(INTEL_INFO(dev_priv)->gen >= 9,\r\n"Platform that should have a MOCS table does not.\n");\r\n}\r\nif (IS_GEN9(dev_priv)) {\r\nint i;\r\nfor (i = 0; i < table->size; i++)\r\nif (WARN_ON(table->table[i].l3cc_value &\r\n(L3_ESC(1) | L3_SCC(0x7))))\r\nreturn false;\r\n}\r\nreturn result;\r\n}\r\nstatic i915_reg_t mocs_register(enum intel_engine_id engine_id, int index)\r\n{\r\nswitch (engine_id) {\r\ncase RCS:\r\nreturn GEN9_GFX_MOCS(index);\r\ncase VCS:\r\nreturn GEN9_MFX0_MOCS(index);\r\ncase BCS:\r\nreturn GEN9_BLT_MOCS(index);\r\ncase VECS:\r\nreturn GEN9_VEBOX_MOCS(index);\r\ncase VCS2:\r\nreturn GEN9_MFX1_MOCS(index);\r\ndefault:\r\nMISSING_CASE(engine_id);\r\nreturn INVALID_MMIO_REG;\r\n}\r\n}\r\nint intel_mocs_init_engine(struct intel_engine_cs *engine)\r\n{\r\nstruct drm_i915_private *dev_priv = engine->i915;\r\nstruct drm_i915_mocs_table table;\r\nunsigned int index;\r\nif (!get_mocs_settings(dev_priv, &table))\r\nreturn 0;\r\nif (WARN_ON(table.size > GEN9_NUM_MOCS_ENTRIES))\r\nreturn -ENODEV;\r\nfor (index = 0; index < table.size; index++)\r\nI915_WRITE(mocs_register(engine->id, index),\r\ntable.table[index].control_value);\r\nfor (; index < GEN9_NUM_MOCS_ENTRIES; index++)\r\nI915_WRITE(mocs_register(engine->id, index),\r\ntable.table[0].control_value);\r\nreturn 0;\r\n}\r\nstatic int emit_mocs_control_table(struct drm_i915_gem_request *req,\r\nconst struct drm_i915_mocs_table *table)\r\n{\r\nenum intel_engine_id engine = req->engine->id;\r\nunsigned int index;\r\nu32 *cs;\r\nif (WARN_ON(table->size > GEN9_NUM_MOCS_ENTRIES))\r\nreturn -ENODEV;\r\ncs = intel_ring_begin(req, 2 + 2 * GEN9_NUM_MOCS_ENTRIES);\r\nif (IS_ERR(cs))\r\nreturn PTR_ERR(cs);\r\n*cs++ = MI_LOAD_REGISTER_IMM(GEN9_NUM_MOCS_ENTRIES);\r\nfor (index = 0; index < table->size; index++) {\r\n*cs++ = i915_mmio_reg_offset(mocs_register(engine, index));\r\n*cs++ = table->table[index].control_value;\r\n}\r\nfor (; index < GEN9_NUM_MOCS_ENTRIES; index++) {\r\n*cs++ = i915_mmio_reg_offset(mocs_register(engine, index));\r\n*cs++ = table->table[0].control_value;\r\n}\r\n*cs++ = MI_NOOP;\r\nintel_ring_advance(req, cs);\r\nreturn 0;\r\n}\r\nstatic inline u32 l3cc_combine(const struct drm_i915_mocs_table *table,\r\nu16 low,\r\nu16 high)\r\n{\r\nreturn table->table[low].l3cc_value |\r\ntable->table[high].l3cc_value << 16;\r\n}\r\nstatic int emit_mocs_l3cc_table(struct drm_i915_gem_request *req,\r\nconst struct drm_i915_mocs_table *table)\r\n{\r\nunsigned int i;\r\nu32 *cs;\r\nif (WARN_ON(table->size > GEN9_NUM_MOCS_ENTRIES))\r\nreturn -ENODEV;\r\ncs = intel_ring_begin(req, 2 + GEN9_NUM_MOCS_ENTRIES);\r\nif (IS_ERR(cs))\r\nreturn PTR_ERR(cs);\r\n*cs++ = MI_LOAD_REGISTER_IMM(GEN9_NUM_MOCS_ENTRIES / 2);\r\nfor (i = 0; i < table->size/2; i++) {\r\n*cs++ = i915_mmio_reg_offset(GEN9_LNCFCMOCS(i));\r\n*cs++ = l3cc_combine(table, 2 * i, 2 * i + 1);\r\n}\r\nif (table->size & 0x01) {\r\n*cs++ = i915_mmio_reg_offset(GEN9_LNCFCMOCS(i));\r\n*cs++ = l3cc_combine(table, 2 * i, 0);\r\ni++;\r\n}\r\nfor (; i < GEN9_NUM_MOCS_ENTRIES / 2; i++) {\r\n*cs++ = i915_mmio_reg_offset(GEN9_LNCFCMOCS(i));\r\n*cs++ = l3cc_combine(table, 0, 0);\r\n}\r\n*cs++ = MI_NOOP;\r\nintel_ring_advance(req, cs);\r\nreturn 0;\r\n}\r\nvoid intel_mocs_init_l3cc_table(struct drm_i915_private *dev_priv)\r\n{\r\nstruct drm_i915_mocs_table table;\r\nunsigned int i;\r\nif (!get_mocs_settings(dev_priv, &table))\r\nreturn;\r\nfor (i = 0; i < table.size/2; i++)\r\nI915_WRITE(GEN9_LNCFCMOCS(i), l3cc_combine(&table, 2*i, 2*i+1));\r\nif (table.size & 0x01) {\r\nI915_WRITE(GEN9_LNCFCMOCS(i), l3cc_combine(&table, 2*i, 0));\r\ni++;\r\n}\r\nfor (; i < (GEN9_NUM_MOCS_ENTRIES / 2); i++)\r\nI915_WRITE(GEN9_LNCFCMOCS(i), l3cc_combine(&table, 0, 0));\r\n}\r\nint intel_rcs_context_init_mocs(struct drm_i915_gem_request *req)\r\n{\r\nstruct drm_i915_mocs_table t;\r\nint ret;\r\nif (get_mocs_settings(req->i915, &t)) {\r\nret = emit_mocs_control_table(req, &t);\r\nif (ret)\r\nreturn ret;\r\nret = emit_mocs_l3cc_table(req, &t);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

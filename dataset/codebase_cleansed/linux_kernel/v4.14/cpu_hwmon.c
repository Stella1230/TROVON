int loongson3_cpu_temp(int cpu)\r\n{\r\nu32 reg, prid_rev;\r\nreg = LOONGSON_CHIPTEMP(cpu);\r\nprid_rev = read_c0_prid() & PRID_REV_MASK;\r\nswitch (prid_rev) {\r\ncase PRID_REV_LOONGSON3A_R1:\r\nreg = (reg >> 8) & 0xff;\r\nbreak;\r\ncase PRID_REV_LOONGSON3A_R2:\r\ncase PRID_REV_LOONGSON3B_R1:\r\ncase PRID_REV_LOONGSON3B_R2:\r\nreg = ((reg >> 8) & 0xff) - 100;\r\nbreak;\r\ncase PRID_REV_LOONGSON3A_R3:\r\nreg = (reg & 0xffff)*731/0x4000 - 273;\r\nbreak;\r\n}\r\nreturn (int)reg * 1000;\r\n}\r\nstatic ssize_t get_hwmon_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "cpu-hwmon\n");\r\n}\r\nstatic ssize_t cpu_temp_label(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint id = (to_sensor_dev_attr(attr))->index - 1;\r\nreturn sprintf(buf, "CPU %d Temperature\n", id);\r\n}\r\nstatic ssize_t get_cpu_temp(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint id = (to_sensor_dev_attr(attr))->index - 1;\r\nint value = loongson3_cpu_temp(id);\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic int create_sysfs_cputemp_files(struct kobject *kobj)\r\n{\r\nint i, ret = 0;\r\nfor (i=0; i<nr_packages; i++)\r\nret = sysfs_create_files(kobj, hwmon_cputemp[i]);\r\nreturn ret;\r\n}\r\nstatic void remove_sysfs_cputemp_files(struct kobject *kobj)\r\n{\r\nint i;\r\nfor (i=0; i<nr_packages; i++)\r\nsysfs_remove_files(kobj, hwmon_cputemp[i]);\r\n}\r\nstatic void do_thermal_timer(struct work_struct *work)\r\n{\r\nint i, value, temp_max = 0;\r\nfor (i=0; i<nr_packages; i++) {\r\nvalue = loongson3_cpu_temp(i);\r\nif (value > temp_max)\r\ntemp_max = value;\r\n}\r\nif (temp_max <= CPU_THERMAL_THRESHOLD)\r\nschedule_delayed_work(&thermal_work, msecs_to_jiffies(5000));\r\nelse\r\norderly_poweroff(true);\r\n}\r\nstatic int __init loongson_hwmon_init(void)\r\n{\r\nint ret;\r\npr_info("Loongson Hwmon Enter...\n");\r\ncpu_hwmon_dev = hwmon_device_register(NULL);\r\nif (IS_ERR(cpu_hwmon_dev)) {\r\nret = -ENOMEM;\r\npr_err("hwmon_device_register fail!\n");\r\ngoto fail_hwmon_device_register;\r\n}\r\nnr_packages = loongson_sysconf.nr_cpus /\r\nloongson_sysconf.cores_per_package;\r\nret = sysfs_create_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nif (ret) {\r\npr_err("fail to create loongson hwmon!\n");\r\ngoto fail_sysfs_create_group_hwmon;\r\n}\r\nret = create_sysfs_cputemp_files(&cpu_hwmon_dev->kobj);\r\nif (ret) {\r\npr_err("fail to create cpu temperature interface!\n");\r\ngoto fail_create_sysfs_cputemp_files;\r\n}\r\nINIT_DEFERRABLE_WORK(&thermal_work, do_thermal_timer);\r\nschedule_delayed_work(&thermal_work, msecs_to_jiffies(20000));\r\nreturn ret;\r\nfail_create_sysfs_cputemp_files:\r\nsysfs_remove_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nfail_sysfs_create_group_hwmon:\r\nhwmon_device_unregister(cpu_hwmon_dev);\r\nfail_hwmon_device_register:\r\nreturn ret;\r\n}\r\nstatic void __exit loongson_hwmon_exit(void)\r\n{\r\ncancel_delayed_work_sync(&thermal_work);\r\nremove_sysfs_cputemp_files(&cpu_hwmon_dev->kobj);\r\nsysfs_remove_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nhwmon_device_unregister(cpu_hwmon_dev);\r\n}

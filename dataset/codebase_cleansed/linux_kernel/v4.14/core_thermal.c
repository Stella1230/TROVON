static inline u8 mlxsw_state_to_duty(int state)\r\n{\r\nreturn DIV_ROUND_CLOSEST(state * MLXSW_THERMAL_MAX_DUTY,\r\nMLXSW_THERMAL_MAX_STATE);\r\n}\r\nstatic inline int mlxsw_duty_to_state(u8 duty)\r\n{\r\nreturn DIV_ROUND_CLOSEST(duty * MLXSW_THERMAL_MAX_STATE,\r\nMLXSW_THERMAL_MAX_DUTY);\r\n}\r\nstatic int mlxsw_get_cooling_device_idx(struct mlxsw_thermal *thermal,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nint i;\r\nfor (i = 0; i < MLXSW_MFCR_PWMS_MAX; i++)\r\nif (thermal->cdevs[i] == cdev)\r\nreturn i;\r\nreturn -ENODEV;\r\n}\r\nstatic int mlxsw_thermal_bind(struct thermal_zone_device *tzdev,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nstruct device *dev = thermal->bus_info->dev;\r\nint i, err;\r\nif (mlxsw_get_cooling_device_idx(thermal, cdev) < 0)\r\nreturn 0;\r\nfor (i = 0; i < MLXSW_THERMAL_NUM_TRIPS; i++) {\r\nconst struct mlxsw_thermal_trip *trip = &thermal->trips[i];\r\nerr = thermal_zone_bind_cooling_device(tzdev, i, cdev,\r\ntrip->max_state,\r\ntrip->min_state,\r\nTHERMAL_WEIGHT_DEFAULT);\r\nif (err < 0) {\r\ndev_err(dev, "Failed to bind cooling device to trip %d\n", i);\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_unbind(struct thermal_zone_device *tzdev,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nstruct device *dev = thermal->bus_info->dev;\r\nint i;\r\nint err;\r\nif (mlxsw_get_cooling_device_idx(thermal, cdev) < 0)\r\nreturn 0;\r\nfor (i = 0; i < MLXSW_THERMAL_NUM_TRIPS; i++) {\r\nerr = thermal_zone_unbind_cooling_device(tzdev, i, cdev);\r\nif (err < 0) {\r\ndev_err(dev, "Failed to unbind cooling device\n");\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_mode(struct thermal_zone_device *tzdev,\r\nenum thermal_device_mode *mode)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\n*mode = thermal->mode;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_set_mode(struct thermal_zone_device *tzdev,\r\nenum thermal_device_mode mode)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nmutex_lock(&tzdev->lock);\r\nif (mode == THERMAL_DEVICE_ENABLED)\r\ntzdev->polling_delay = MLXSW_THERMAL_POLL_INT;\r\nelse\r\ntzdev->polling_delay = 0;\r\nmutex_unlock(&tzdev->lock);\r\nthermal->mode = mode;\r\nthermal_zone_device_update(tzdev, THERMAL_EVENT_UNSPECIFIED);\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_temp(struct thermal_zone_device *tzdev,\r\nint *p_temp)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nstruct device *dev = thermal->bus_info->dev;\r\nchar mtmp_pl[MLXSW_REG_MTMP_LEN];\r\nunsigned int temp;\r\nint err;\r\nmlxsw_reg_mtmp_pack(mtmp_pl, 0, false, false);\r\nerr = mlxsw_reg_query(thermal->core, MLXSW_REG(mtmp), mtmp_pl);\r\nif (err) {\r\ndev_err(dev, "Failed to query temp sensor\n");\r\nreturn err;\r\n}\r\nmlxsw_reg_mtmp_unpack(mtmp_pl, &temp, NULL, NULL);\r\n*p_temp = (int) temp;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_trip_type(struct thermal_zone_device *tzdev,\r\nint trip,\r\nenum thermal_trip_type *p_type)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nif (trip < 0 || trip >= MLXSW_THERMAL_NUM_TRIPS)\r\nreturn -EINVAL;\r\n*p_type = thermal->trips[trip].type;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_trip_temp(struct thermal_zone_device *tzdev,\r\nint trip, int *p_temp)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nif (trip < 0 || trip >= MLXSW_THERMAL_NUM_TRIPS)\r\nreturn -EINVAL;\r\n*p_temp = thermal->trips[trip].temp;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_set_trip_temp(struct thermal_zone_device *tzdev,\r\nint trip, int temp)\r\n{\r\nstruct mlxsw_thermal *thermal = tzdev->devdata;\r\nif (trip < 0 || trip >= MLXSW_THERMAL_NUM_TRIPS ||\r\ntemp > MLXSW_THERMAL_MAX_TEMP)\r\nreturn -EINVAL;\r\nthermal->trips[trip].temp = temp;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_max_state(struct thermal_cooling_device *cdev,\r\nunsigned long *p_state)\r\n{\r\n*p_state = MLXSW_THERMAL_MAX_STATE;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_get_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long *p_state)\r\n{\r\nstruct mlxsw_thermal *thermal = cdev->devdata;\r\nstruct device *dev = thermal->bus_info->dev;\r\nchar mfsc_pl[MLXSW_REG_MFSC_LEN];\r\nint err, idx;\r\nu8 duty;\r\nidx = mlxsw_get_cooling_device_idx(thermal, cdev);\r\nif (idx < 0)\r\nreturn idx;\r\nmlxsw_reg_mfsc_pack(mfsc_pl, idx, 0);\r\nerr = mlxsw_reg_query(thermal->core, MLXSW_REG(mfsc), mfsc_pl);\r\nif (err) {\r\ndev_err(dev, "Failed to query PWM duty\n");\r\nreturn err;\r\n}\r\nduty = mlxsw_reg_mfsc_pwm_duty_cycle_get(mfsc_pl);\r\n*p_state = mlxsw_duty_to_state(duty);\r\nreturn 0;\r\n}\r\nstatic int mlxsw_thermal_set_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long state)\r\n{\r\nstruct mlxsw_thermal *thermal = cdev->devdata;\r\nstruct device *dev = thermal->bus_info->dev;\r\nchar mfsc_pl[MLXSW_REG_MFSC_LEN];\r\nint err, idx;\r\nidx = mlxsw_get_cooling_device_idx(thermal, cdev);\r\nif (idx < 0)\r\nreturn idx;\r\nmlxsw_reg_mfsc_pack(mfsc_pl, idx, mlxsw_state_to_duty(state));\r\nerr = mlxsw_reg_write(thermal->core, MLXSW_REG(mfsc), mfsc_pl);\r\nif (err) {\r\ndev_err(dev, "Failed to write PWM duty\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mlxsw_thermal_init(struct mlxsw_core *core,\r\nconst struct mlxsw_bus_info *bus_info,\r\nstruct mlxsw_thermal **p_thermal)\r\n{\r\nchar mfcr_pl[MLXSW_REG_MFCR_LEN] = { 0 };\r\nenum mlxsw_reg_mfcr_pwm_frequency freq;\r\nstruct device *dev = bus_info->dev;\r\nstruct mlxsw_thermal *thermal;\r\nu16 tacho_active;\r\nu8 pwm_active;\r\nint err, i;\r\nthermal = devm_kzalloc(dev, sizeof(*thermal),\r\nGFP_KERNEL);\r\nif (!thermal)\r\nreturn -ENOMEM;\r\nthermal->core = core;\r\nthermal->bus_info = bus_info;\r\nmemcpy(thermal->trips, default_thermal_trips, sizeof(thermal->trips));\r\nerr = mlxsw_reg_query(thermal->core, MLXSW_REG(mfcr), mfcr_pl);\r\nif (err) {\r\ndev_err(dev, "Failed to probe PWMs\n");\r\ngoto err_free_thermal;\r\n}\r\nmlxsw_reg_mfcr_unpack(mfcr_pl, &freq, &tacho_active, &pwm_active);\r\nfor (i = 0; i < MLXSW_MFCR_TACHOS_MAX; i++) {\r\nif (tacho_active & BIT(i)) {\r\nchar mfsl_pl[MLXSW_REG_MFSL_LEN];\r\nmlxsw_reg_mfsl_pack(mfsl_pl, i, 0, 0);\r\nerr = mlxsw_reg_query(thermal->core, MLXSW_REG(mfsl),\r\nmfsl_pl);\r\nif (err)\r\ngoto err_free_thermal;\r\nmlxsw_reg_mfsl_tach_min_set(mfsl_pl, 0);\r\nerr = mlxsw_reg_write(thermal->core, MLXSW_REG(mfsl),\r\nmfsl_pl);\r\nif (err)\r\ngoto err_free_thermal;\r\n}\r\n}\r\nfor (i = 0; i < MLXSW_MFCR_PWMS_MAX; i++) {\r\nif (pwm_active & BIT(i)) {\r\nstruct thermal_cooling_device *cdev;\r\ncdev = thermal_cooling_device_register("Fan", thermal,\r\n&mlxsw_cooling_ops);\r\nif (IS_ERR(cdev)) {\r\nerr = PTR_ERR(cdev);\r\ndev_err(dev, "Failed to register cooling device\n");\r\ngoto err_unreg_cdevs;\r\n}\r\nthermal->cdevs[i] = cdev;\r\n}\r\n}\r\nthermal->tzdev = thermal_zone_device_register("mlxsw",\r\nMLXSW_THERMAL_NUM_TRIPS,\r\nMLXSW_THERMAL_TRIP_MASK,\r\nthermal,\r\n&mlxsw_thermal_ops,\r\nNULL, 0,\r\nMLXSW_THERMAL_POLL_INT);\r\nif (IS_ERR(thermal->tzdev)) {\r\nerr = PTR_ERR(thermal->tzdev);\r\ndev_err(dev, "Failed to register thermal zone\n");\r\ngoto err_unreg_cdevs;\r\n}\r\nthermal->mode = THERMAL_DEVICE_ENABLED;\r\n*p_thermal = thermal;\r\nreturn 0;\r\nerr_unreg_cdevs:\r\nfor (i = 0; i < MLXSW_MFCR_PWMS_MAX; i++)\r\nif (thermal->cdevs[i])\r\nthermal_cooling_device_unregister(thermal->cdevs[i]);\r\nerr_free_thermal:\r\ndevm_kfree(dev, thermal);\r\nreturn err;\r\n}\r\nvoid mlxsw_thermal_fini(struct mlxsw_thermal *thermal)\r\n{\r\nint i;\r\nif (thermal->tzdev) {\r\nthermal_zone_device_unregister(thermal->tzdev);\r\nthermal->tzdev = NULL;\r\n}\r\nfor (i = 0; i < MLXSW_MFCR_PWMS_MAX; i++) {\r\nif (thermal->cdevs[i]) {\r\nthermal_cooling_device_unregister(thermal->cdevs[i]);\r\nthermal->cdevs[i] = NULL;\r\n}\r\n}\r\ndevm_kfree(thermal->bus_info->dev, thermal);\r\n}

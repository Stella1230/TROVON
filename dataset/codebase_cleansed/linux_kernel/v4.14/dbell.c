void doorbell_global_ipi(int cpu)\r\n{\r\nu32 tag = get_hard_smp_processor_id(cpu);\r\nkvmppc_set_host_ipi(cpu, 1);\r\nppc_msgsnd_sync();\r\nppc_msgsnd(PPC_DBELL_MSGTYPE, 0, tag);\r\n}\r\nvoid doorbell_core_ipi(int cpu)\r\n{\r\nu32 tag = cpu_thread_in_core(cpu);\r\nkvmppc_set_host_ipi(cpu, 1);\r\nppc_msgsnd_sync();\r\nppc_msgsnd(PPC_DBELL_MSGTYPE, 0, tag);\r\n}\r\nint doorbell_try_core_ipi(int cpu)\r\n{\r\nint this_cpu = get_cpu();\r\nint ret = 0;\r\nif (cpumask_test_cpu(cpu, cpu_sibling_mask(this_cpu))) {\r\ndoorbell_core_ipi(cpu);\r\nret = 1;\r\n}\r\nput_cpu();\r\nreturn ret;\r\n}\r\nvoid doorbell_exception(struct pt_regs *regs)\r\n{\r\nstruct pt_regs *old_regs = set_irq_regs(regs);\r\nirq_enter();\r\nppc_msgsync();\r\nmay_hard_irq_enable();\r\nkvmppc_set_host_ipi(smp_processor_id(), 0);\r\n__this_cpu_inc(irq_stat.doorbell_irqs);\r\nsmp_ipi_demux_relaxed();\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}\r\nvoid doorbell_exception(struct pt_regs *regs)\r\n{\r\nprintk(KERN_WARNING "Received doorbell on non-smp system\n");\r\n}

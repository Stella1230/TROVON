static int cpuidle_get_count_percent(unsigned int id, double *percent,\r\nunsigned int cpu)\r\n{\r\nunsigned long long statediff = current_count[cpu][id]\r\n- previous_count[cpu][id];\r\ndprint("%s: - diff: %llu - percent: %f (%u)\n",\r\ncpuidle_cstates[id].name, timediff, *percent, cpu);\r\nif (timediff == 0)\r\n*percent = 0.0;\r\nelse\r\n*percent = ((100.0 * statediff) / timediff);\r\ndprint("%s: - timediff: %llu - statediff: %llu - percent: %f (%u)\n",\r\ncpuidle_cstates[id].name, timediff, statediff, *percent, cpu);\r\nreturn 0;\r\n}\r\nstatic int cpuidle_start(void)\r\n{\r\nint cpu, state;\r\nclock_gettime(CLOCK_REALTIME, &start_time);\r\nfor (cpu = 0; cpu < cpu_count; cpu++) {\r\nfor (state = 0; state < cpuidle_sysfs_monitor.hw_states_num;\r\nstate++) {\r\nprevious_count[cpu][state] =\r\ncpuidle_state_time(cpu, state);\r\ndprint("CPU %d - State: %d - Val: %llu\n",\r\ncpu, state, previous_count[cpu][state]);\r\n}\r\n};\r\nreturn 0;\r\n}\r\nstatic int cpuidle_stop(void)\r\n{\r\nint cpu, state;\r\nstruct timespec end_time;\r\nclock_gettime(CLOCK_REALTIME, &end_time);\r\ntimediff = timespec_diff_us(start_time, end_time);\r\nfor (cpu = 0; cpu < cpu_count; cpu++) {\r\nfor (state = 0; state < cpuidle_sysfs_monitor.hw_states_num;\r\nstate++) {\r\ncurrent_count[cpu][state] =\r\ncpuidle_state_time(cpu, state);\r\ndprint("CPU %d - State: %d - Val: %llu\n",\r\ncpu, state, previous_count[cpu][state]);\r\n}\r\n};\r\nreturn 0;\r\n}\r\nvoid fix_up_intel_idle_driver_name(char *tmp, int num)\r\n{\r\nif (!strncmp(tmp, "NHM-", 4)) {\r\nswitch (num) {\r\ncase 1:\r\nstrcpy(tmp, "C1");\r\nbreak;\r\ncase 2:\r\nstrcpy(tmp, "C3");\r\nbreak;\r\ncase 3:\r\nstrcpy(tmp, "C6");\r\nbreak;\r\n}\r\n} else if (!strncmp(tmp, "SNB-", 4)) {\r\nswitch (num) {\r\ncase 1:\r\nstrcpy(tmp, "C1");\r\nbreak;\r\ncase 2:\r\nstrcpy(tmp, "C3");\r\nbreak;\r\ncase 3:\r\nstrcpy(tmp, "C6");\r\nbreak;\r\ncase 4:\r\nstrcpy(tmp, "C7");\r\nbreak;\r\n}\r\n} else if (!strncmp(tmp, "ATM-", 4)) {\r\nswitch (num) {\r\ncase 1:\r\nstrcpy(tmp, "C1");\r\nbreak;\r\ncase 2:\r\nstrcpy(tmp, "C2");\r\nbreak;\r\ncase 3:\r\nstrcpy(tmp, "C4");\r\nbreak;\r\ncase 4:\r\nstrcpy(tmp, "C6");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic struct cpuidle_monitor *cpuidle_register(void)\r\n{\r\nint num;\r\nchar *tmp;\r\ncpuidle_sysfs_monitor.hw_states_num = cpuidle_state_count(0);\r\nif (cpuidle_sysfs_monitor.hw_states_num <= 0)\r\nreturn NULL;\r\nfor (num = 0; num < cpuidle_sysfs_monitor.hw_states_num; num++) {\r\ntmp = cpuidle_state_name(0, num);\r\nif (tmp == NULL)\r\ncontinue;\r\nfix_up_intel_idle_driver_name(tmp, num);\r\nstrncpy(cpuidle_cstates[num].name, tmp, CSTATE_NAME_LEN - 1);\r\nfree(tmp);\r\ntmp = cpuidle_state_desc(0, num);\r\nif (tmp == NULL)\r\ncontinue;\r\nstrncpy(cpuidle_cstates[num].desc, tmp, CSTATE_DESC_LEN - 1);\r\nfree(tmp);\r\ncpuidle_cstates[num].range = RANGE_THREAD;\r\ncpuidle_cstates[num].id = num;\r\ncpuidle_cstates[num].get_count_percent =\r\ncpuidle_get_count_percent;\r\n};\r\nprevious_count = malloc(sizeof(long long *) * cpu_count);\r\ncurrent_count = malloc(sizeof(long long *) * cpu_count);\r\nfor (num = 0; num < cpu_count; num++) {\r\nprevious_count[num] = malloc(sizeof(long long) *\r\ncpuidle_sysfs_monitor.hw_states_num);\r\ncurrent_count[num] = malloc(sizeof(long long) *\r\ncpuidle_sysfs_monitor.hw_states_num);\r\n}\r\ncpuidle_sysfs_monitor.name_len = strlen(cpuidle_sysfs_monitor.name);\r\nreturn &cpuidle_sysfs_monitor;\r\n}\r\nvoid cpuidle_unregister(void)\r\n{\r\nint num;\r\nfor (num = 0; num < cpu_count; num++) {\r\nfree(previous_count[num]);\r\nfree(current_count[num]);\r\n}\r\nfree(previous_count);\r\nfree(current_count);\r\n}

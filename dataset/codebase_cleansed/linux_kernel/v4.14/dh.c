static inline void dh_clear_params(struct dh_ctx *ctx)\r\n{\r\nmpi_free(ctx->p);\r\nmpi_free(ctx->g);\r\nctx->p = NULL;\r\nctx->g = NULL;\r\n}\r\nstatic void dh_free_ctx(struct dh_ctx *ctx)\r\n{\r\ndh_clear_params(ctx);\r\nmpi_free(ctx->xa);\r\nctx->xa = NULL;\r\n}\r\nstatic int _compute_val(const struct dh_ctx *ctx, MPI base, MPI val)\r\n{\r\nreturn mpi_powm(val, base, ctx->xa, ctx->p);\r\n}\r\nstatic inline struct dh_ctx *dh_get_ctx(struct crypto_kpp *tfm)\r\n{\r\nreturn kpp_tfm_ctx(tfm);\r\n}\r\nstatic int dh_check_params_length(unsigned int p_len)\r\n{\r\nreturn (p_len < 1536) ? -EINVAL : 0;\r\n}\r\nstatic int dh_set_params(struct dh_ctx *ctx, struct dh *params)\r\n{\r\nif (unlikely(!params->p || !params->g))\r\nreturn -EINVAL;\r\nif (dh_check_params_length(params->p_size << 3))\r\nreturn -EINVAL;\r\nctx->p = mpi_read_raw_data(params->p, params->p_size);\r\nif (!ctx->p)\r\nreturn -EINVAL;\r\nctx->g = mpi_read_raw_data(params->g, params->g_size);\r\nif (!ctx->g) {\r\nmpi_free(ctx->p);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dh_set_secret(struct crypto_kpp *tfm, const void *buf,\r\nunsigned int len)\r\n{\r\nstruct dh_ctx *ctx = dh_get_ctx(tfm);\r\nstruct dh params;\r\ndh_free_ctx(ctx);\r\nif (crypto_dh_decode_key(buf, len, &params) < 0)\r\nreturn -EINVAL;\r\nif (dh_set_params(ctx, &params) < 0)\r\nreturn -EINVAL;\r\nctx->xa = mpi_read_raw_data(params.key, params.key_size);\r\nif (!ctx->xa) {\r\ndh_clear_params(ctx);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dh_compute_value(struct kpp_request *req)\r\n{\r\nstruct crypto_kpp *tfm = crypto_kpp_reqtfm(req);\r\nstruct dh_ctx *ctx = dh_get_ctx(tfm);\r\nMPI base, val = mpi_alloc(0);\r\nint ret = 0;\r\nint sign;\r\nif (!val)\r\nreturn -ENOMEM;\r\nif (unlikely(!ctx->xa)) {\r\nret = -EINVAL;\r\ngoto err_free_val;\r\n}\r\nif (req->src) {\r\nbase = mpi_read_raw_from_sgl(req->src, req->src_len);\r\nif (!base) {\r\nret = -EINVAL;\r\ngoto err_free_val;\r\n}\r\n} else {\r\nbase = ctx->g;\r\n}\r\nret = _compute_val(ctx, base, val);\r\nif (ret)\r\ngoto err_free_base;\r\nret = mpi_write_to_sgl(val, req->dst, req->dst_len, &sign);\r\nif (ret)\r\ngoto err_free_base;\r\nif (sign < 0)\r\nret = -EBADMSG;\r\nerr_free_base:\r\nif (req->src)\r\nmpi_free(base);\r\nerr_free_val:\r\nmpi_free(val);\r\nreturn ret;\r\n}\r\nstatic unsigned int dh_max_size(struct crypto_kpp *tfm)\r\n{\r\nstruct dh_ctx *ctx = dh_get_ctx(tfm);\r\nreturn mpi_get_size(ctx->p);\r\n}\r\nstatic void dh_exit_tfm(struct crypto_kpp *tfm)\r\n{\r\nstruct dh_ctx *ctx = dh_get_ctx(tfm);\r\ndh_free_ctx(ctx);\r\n}\r\nstatic int dh_init(void)\r\n{\r\nreturn crypto_register_kpp(&dh);\r\n}\r\nstatic void dh_exit(void)\r\n{\r\ncrypto_unregister_kpp(&dh);\r\n}

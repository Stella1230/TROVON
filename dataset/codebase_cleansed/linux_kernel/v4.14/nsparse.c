acpi_status\r\nacpi_ns_execute_table(u32 table_index, struct acpi_namespace_node *start_node)\r\n{\r\nacpi_status status;\r\nstruct acpi_table_header *table;\r\nacpi_owner_id owner_id;\r\nstruct acpi_evaluate_info *info = NULL;\r\nu32 aml_length;\r\nu8 *aml_start;\r\nunion acpi_operand_object *method_obj = NULL;\r\nACPI_FUNCTION_TRACE(ns_execute_table);\r\nstatus = acpi_get_table_by_index(table_index, &table);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (table->length < sizeof(struct acpi_table_header)) {\r\nreturn_ACPI_STATUS(AE_BAD_HEADER);\r\n}\r\naml_start = (u8 *)table + sizeof(struct acpi_table_header);\r\naml_length = table->length - sizeof(struct acpi_table_header);\r\nstatus = acpi_tb_get_owner_id(table_index, &owner_id);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nmethod_obj = acpi_ut_create_internal_object(ACPI_TYPE_METHOD);\r\nif (!method_obj) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\ninfo = ACPI_ALLOCATE_ZEROED(sizeof(struct acpi_evaluate_info));\r\nif (!info) {\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE,\r\n"Create table code block: %p\n", method_obj));\r\nmethod_obj->method.aml_start = aml_start;\r\nmethod_obj->method.aml_length = aml_length;\r\nmethod_obj->method.owner_id = owner_id;\r\nmethod_obj->method.info_flags |= ACPI_METHOD_MODULE_LEVEL;\r\ninfo->pass_number = ACPI_IMODE_EXECUTE;\r\ninfo->node = start_node;\r\ninfo->obj_desc = method_obj;\r\ninfo->node_flags = info->node->flags;\r\ninfo->full_pathname = acpi_ns_get_normalized_pathname(info->node, TRUE);\r\nif (!info->full_pathname) {\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\nstatus = acpi_ps_execute_table(info);\r\ncleanup:\r\nif (info) {\r\nACPI_FREE(info->full_pathname);\r\ninfo->full_pathname = NULL;\r\n}\r\nACPI_FREE(info);\r\nacpi_ut_remove_reference(method_obj);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ns_one_complete_parse(u32 pass_number,\r\nu32 table_index,\r\nstruct acpi_namespace_node *start_node)\r\n{\r\nunion acpi_parse_object *parse_root;\r\nacpi_status status;\r\nu32 aml_length;\r\nu8 *aml_start;\r\nstruct acpi_walk_state *walk_state;\r\nstruct acpi_table_header *table;\r\nacpi_owner_id owner_id;\r\nACPI_FUNCTION_TRACE(ns_one_complete_parse);\r\nstatus = acpi_get_table_by_index(table_index, &table);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (table->length < sizeof(struct acpi_table_header)) {\r\nreturn_ACPI_STATUS(AE_BAD_HEADER);\r\n}\r\naml_start = (u8 *)table + sizeof(struct acpi_table_header);\r\naml_length = table->length - sizeof(struct acpi_table_header);\r\nstatus = acpi_tb_get_owner_id(table_index, &owner_id);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nparse_root = acpi_ps_create_scope_op(aml_start);\r\nif (!parse_root) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nwalk_state = acpi_ds_create_walk_state(owner_id, NULL, NULL, NULL);\r\nif (!walk_state) {\r\nacpi_ps_free_op(parse_root);\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nstatus = acpi_ds_init_aml_walk(walk_state, parse_root, NULL,\r\naml_start, aml_length, NULL,\r\n(u8)pass_number);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ds_delete_walk_state(walk_state);\r\ngoto cleanup;\r\n}\r\nif (ACPI_COMPARE_NAME(table->signature, ACPI_SIG_OSDT) &&\r\npass_number == ACPI_IMODE_LOAD_PASS1) {\r\nwalk_state->namespace_override = TRUE;\r\n}\r\nif (start_node && start_node != acpi_gbl_root_node) {\r\nstatus =\r\nacpi_ds_scope_stack_push(start_node, ACPI_TYPE_METHOD,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ds_delete_walk_state(walk_state);\r\ngoto cleanup;\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE,\r\n"*PARSE* pass %u parse\n", pass_number));\r\nacpi_ex_enter_interpreter();\r\nstatus = acpi_ps_parse_aml(walk_state);\r\nacpi_ex_exit_interpreter();\r\ncleanup:\r\nacpi_ps_delete_parse_tree(parse_root);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ns_parse_table(u32 table_index, struct acpi_namespace_node *start_node)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ns_parse_table);\r\nif (acpi_gbl_parse_table_as_term_list) {\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE, "**** Start load pass\n"));\r\nstatus = acpi_ns_execute_table(table_index, start_node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE, "**** Start pass 1\n"));\r\nstatus = acpi_ns_one_complete_parse(ACPI_IMODE_LOAD_PASS1,\r\ntable_index, start_node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE, "**** Start pass 2\n"));\r\nstatus = acpi_ns_one_complete_parse(ACPI_IMODE_LOAD_PASS2,\r\ntable_index, start_node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}

static irqreturn_t pmic_thermal_irq_handler(int irq, void *data)\r\n{\r\nstruct platform_device *pdev = data;\r\nstruct thermal_zone_device *tzd;\r\nstruct pmic_thermal_data *td;\r\nstruct intel_soc_pmic *pmic;\r\nstruct regmap *regmap;\r\nu8 reg_val, mask, irq_stat, trip;\r\nu16 reg, evt_stat_reg;\r\nint i, j, ret;\r\npmic = dev_get_drvdata(pdev->dev.parent);\r\nregmap = pmic->regmap;\r\ntd = (struct pmic_thermal_data *)\r\nplatform_get_device_id(pdev)->driver_data;\r\nfor (i = 0; i < td->num_maps; i++) {\r\nfor (j = 0; j < td->maps[i].num_trips; j++) {\r\nreg = td->maps[i].trip_config[j].irq_reg;\r\nmask = td->maps[i].trip_config[j].irq_mask;\r\nif (regmap_read(regmap, reg, &ret))\r\nreturn IRQ_HANDLED;\r\nreg_val = (u8)ret;\r\nirq_stat = ((u8)ret & mask);\r\nif (!irq_stat)\r\ncontinue;\r\nevt_stat_reg = td->maps[i].trip_config[j].evt_stat;\r\nif (regmap_read(regmap, evt_stat_reg, &ret))\r\nreturn IRQ_HANDLED;\r\ntrip = td->maps[i].trip_config[j].trip_num;\r\ntzd = thermal_zone_get_zone_by_name(td->maps[i].handle);\r\nif (!IS_ERR(tzd))\r\nthermal_zone_device_update(tzd,\r\nTHERMAL_EVENT_UNSPECIFIED);\r\nregmap_write(regmap, reg, reg_val & mask);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pmic_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct regmap_irq_chip_data *regmap_irq_chip;\r\nstruct pmic_thermal_data *thermal_data;\r\nint ret, irq, virq, i, j, pmic_irq_count;\r\nstruct intel_soc_pmic *pmic;\r\nstruct regmap *regmap;\r\nstruct device *dev;\r\nu16 reg;\r\nu8 mask;\r\ndev = &pdev->dev;\r\npmic = dev_get_drvdata(pdev->dev.parent);\r\nif (!pmic) {\r\ndev_err(dev, "Failed to get struct intel_soc_pmic pointer\n");\r\nreturn -ENODEV;\r\n}\r\nthermal_data = (struct pmic_thermal_data *)\r\nplatform_get_device_id(pdev)->driver_data;\r\nif (!thermal_data) {\r\ndev_err(dev, "No thermal data initialized!!\n");\r\nreturn -ENODEV;\r\n}\r\nregmap = pmic->regmap;\r\nregmap_irq_chip = pmic->irq_chip_data;\r\npmic_irq_count = 0;\r\nwhile ((irq = platform_get_irq(pdev, pmic_irq_count)) != -ENXIO) {\r\nvirq = regmap_irq_get_virq(regmap_irq_chip, irq);\r\nif (virq < 0) {\r\ndev_err(dev, "failed to get virq by irq %d\n", irq);\r\nreturn virq;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, virq,\r\nNULL, pmic_thermal_irq_handler,\r\nIRQF_ONESHOT, "pmic_thermal", pdev);\r\nif (ret) {\r\ndev_err(dev, "request irq(%d) failed: %d\n", virq, ret);\r\nreturn ret;\r\n}\r\npmic_irq_count++;\r\n}\r\nfor (i = 0; i < thermal_data->num_maps; i++) {\r\nfor (j = 0; j < thermal_data->maps[i].num_trips; j++) {\r\nreg = thermal_data->maps[i].trip_config[j].irq_en;\r\nmask = thermal_data->maps[i].trip_config[j].irq_en_mask;\r\nret = regmap_update_bits(regmap, reg, mask, 0x00);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

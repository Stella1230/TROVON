static void snd_cobalt_card_free(struct snd_cobalt_card *cobsc)\r\n{\r\nif (cobsc == NULL)\r\nreturn;\r\ncobsc->s->alsa = NULL;\r\nkfree(cobsc);\r\n}\r\nstatic void snd_cobalt_card_private_free(struct snd_card *sc)\r\n{\r\nif (sc == NULL)\r\nreturn;\r\nsnd_cobalt_card_free(sc->private_data);\r\nsc->private_data = NULL;\r\nsc->private_free = NULL;\r\n}\r\nstatic int snd_cobalt_card_create(struct cobalt_stream *s,\r\nstruct snd_card *sc,\r\nstruct snd_cobalt_card **cobsc)\r\n{\r\n*cobsc = kzalloc(sizeof(struct snd_cobalt_card), GFP_KERNEL);\r\nif (*cobsc == NULL)\r\nreturn -ENOMEM;\r\n(*cobsc)->s = s;\r\n(*cobsc)->sc = sc;\r\nsc->private_data = *cobsc;\r\nsc->private_free = snd_cobalt_card_private_free;\r\nreturn 0;\r\n}\r\nstatic int snd_cobalt_card_set_names(struct snd_cobalt_card *cobsc)\r\n{\r\nstruct cobalt_stream *s = cobsc->s;\r\nstruct cobalt *cobalt = s->cobalt;\r\nstruct snd_card *sc = cobsc->sc;\r\nstrlcpy(sc->driver, "cobalt", sizeof(sc->driver));\r\nsnprintf(sc->shortname, sizeof(sc->shortname), "cobalt-%d-%d",\r\ncobalt->instance, s->video_channel);\r\nsnprintf(sc->longname, sizeof(sc->longname),\r\n"Cobalt %d HDMI %d",\r\ncobalt->instance, s->video_channel);\r\nreturn 0;\r\n}\r\nint cobalt_alsa_init(struct cobalt_stream *s)\r\n{\r\nstruct cobalt *cobalt = s->cobalt;\r\nstruct snd_card *sc = NULL;\r\nstruct snd_cobalt_card *cobsc;\r\nint ret;\r\nret = snd_card_new(&cobalt->pci_dev->dev, SNDRV_DEFAULT_IDX1,\r\nSNDRV_DEFAULT_STR1, THIS_MODULE, 0, &sc);\r\nif (ret) {\r\ncobalt_err("snd_card_new() failed with err %d\n", ret);\r\ngoto err_exit;\r\n}\r\nret = snd_cobalt_card_create(s, sc, &cobsc);\r\nif (ret) {\r\ncobalt_err("snd_cobalt_card_create() failed with err %d\n",\r\nret);\r\ngoto err_exit_free;\r\n}\r\nsnd_cobalt_card_set_names(cobsc);\r\nret = snd_cobalt_pcm_create(cobsc);\r\nif (ret) {\r\ncobalt_err("snd_cobalt_pcm_create() failed with err %d\n",\r\nret);\r\ngoto err_exit_free;\r\n}\r\ns->alsa = cobsc;\r\nret = snd_card_register(sc);\r\nif (ret) {\r\ns->alsa = NULL;\r\ncobalt_err("snd_card_register() failed with err %d\n", ret);\r\ngoto err_exit_free;\r\n}\r\nreturn 0;\r\nerr_exit_free:\r\nif (sc != NULL)\r\nsnd_card_free(sc);\r\nkfree(cobsc);\r\nerr_exit:\r\nreturn ret;\r\n}\r\nvoid cobalt_alsa_exit(struct cobalt_stream *s)\r\n{\r\nstruct snd_cobalt_card *cobsc = s->alsa;\r\nif (cobsc)\r\nsnd_card_free(cobsc->sc);\r\ns->alsa = NULL;\r\n}

static int lp87565_gpio_get(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(chip);\r\nint ret, val;\r\nret = regmap_read(gpio->map, LP87565_REG_GPIO_IN, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !!(val & BIT(offset));\r\n}\r\nstatic void lp87565_gpio_set(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(chip);\r\nregmap_update_bits(gpio->map, LP87565_REG_GPIO_OUT,\r\nBIT(offset), value ? BIT(offset) : 0);\r\n}\r\nstatic int lp87565_gpio_get_direction(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(chip);\r\nint ret, val;\r\nret = regmap_read(gpio->map, LP87565_REG_GPIO_CONFIG, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !(val & BIT(offset));\r\n}\r\nstatic int lp87565_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(chip);\r\nreturn regmap_update_bits(gpio->map,\r\nLP87565_REG_GPIO_CONFIG,\r\nBIT(offset), 0);\r\n}\r\nstatic int lp87565_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned int offset, int value)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(chip);\r\nlp87565_gpio_set(chip, offset, value);\r\nreturn regmap_update_bits(gpio->map,\r\nLP87565_REG_GPIO_CONFIG,\r\nBIT(offset), BIT(offset));\r\n}\r\nstatic int lp87565_gpio_request(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(gc);\r\nint ret;\r\nswitch (offset) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\nret = regmap_update_bits(gpio->map,\r\nLP87565_REG_PIN_FUNCTION,\r\nBIT(offset), BIT(offset));\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lp87565_gpio_set_config(struct gpio_chip *gc, unsigned int offset,\r\nunsigned long config)\r\n{\r\nstruct lp87565_gpio *gpio = gpiochip_get_data(gc);\r\nswitch (pinconf_to_config_param(config)) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\nreturn regmap_update_bits(gpio->map,\r\nLP87565_REG_GPIO_CONFIG,\r\nBIT(offset +\r\n__ffs(LP87565_GOIO1_OD)),\r\nBIT(offset +\r\n__ffs(LP87565_GOIO1_OD)));\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nreturn regmap_update_bits(gpio->map,\r\nLP87565_REG_GPIO_CONFIG,\r\nBIT(offset +\r\n__ffs(LP87565_GOIO1_OD)), 0);\r\ndefault:\r\nreturn -ENOTSUPP;\r\n}\r\n}\r\nstatic int lp87565_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct lp87565_gpio *gpio;\r\nstruct lp87565 *lp87565;\r\nint ret;\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio)\r\nreturn -ENOMEM;\r\nlp87565 = dev_get_drvdata(pdev->dev.parent);\r\ngpio->chip = template_chip;\r\ngpio->chip.parent = lp87565->dev;\r\ngpio->map = lp87565->regmap;\r\nret = devm_gpiochip_add_data(&pdev->dev, &gpio->chip, gpio);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

static nokprobe_inline\r\nint __skip_singlestep(struct kprobe *p, struct pt_regs *regs,\r\nstruct kprobe_ctlblk *kcb, unsigned long orig_nip)\r\n{\r\nregs->nip = (unsigned long)p->addr + MCOUNT_INSN_SIZE;\r\nif (unlikely(p->post_handler)) {\r\nkcb->kprobe_status = KPROBE_HIT_SSDONE;\r\np->post_handler(p, regs, 0);\r\n}\r\n__this_cpu_write(current_kprobe, NULL);\r\nif (orig_nip)\r\nregs->nip = orig_nip;\r\nreturn 1;\r\n}\r\nint skip_singlestep(struct kprobe *p, struct pt_regs *regs,\r\nstruct kprobe_ctlblk *kcb)\r\n{\r\nif (kprobe_ftrace(p))\r\nreturn __skip_singlestep(p, regs, kcb, 0);\r\nelse\r\nreturn 0;\r\n}\r\nvoid kprobe_ftrace_handler(unsigned long nip, unsigned long parent_nip,\r\nstruct ftrace_ops *ops, struct pt_regs *regs)\r\n{\r\nstruct kprobe *p;\r\nstruct kprobe_ctlblk *kcb;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nhard_irq_disable();\r\np = get_kprobe((kprobe_opcode_t *)nip);\r\nif (unlikely(!p) || kprobe_disabled(p))\r\ngoto end;\r\nkcb = get_kprobe_ctlblk();\r\nif (kprobe_running()) {\r\nkprobes_inc_nmissed_count(p);\r\n} else {\r\nunsigned long orig_nip = regs->nip;\r\nregs->nip -= MCOUNT_INSN_SIZE;\r\n__this_cpu_write(current_kprobe, p);\r\nkcb->kprobe_status = KPROBE_HIT_ACTIVE;\r\nif (!p->pre_handler || !p->pre_handler(p, regs))\r\n__skip_singlestep(p, regs, kcb, orig_nip);\r\n}\r\nend:\r\nlocal_irq_restore(flags);\r\n}\r\nint arch_prepare_kprobe_ftrace(struct kprobe *p)\r\n{\r\np->ainsn.insn = NULL;\r\np->ainsn.boostable = -1;\r\nreturn 0;\r\n}

static void sirfsoc_usp_hwinit(struct sirfsoc_spi *sspi)\r\n{\r\nwritel(readl(sspi->base + sspi->regs->usp_mode1) &\r\n~SIRFSOC_USP_EN, sspi->base + sspi->regs->usp_mode1);\r\nwritel(readl(sspi->base + sspi->regs->usp_mode1) |\r\nSIRFSOC_USP_EN, sspi->base + sspi->regs->usp_mode1);\r\n}\r\nstatic void spi_sirfsoc_rx_word_u8(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu8 *rx = sspi->rx;\r\ndata = readl(sspi->base + sspi->regs->rxfifo_data);\r\nif (rx) {\r\n*rx++ = (u8) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_word--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u8(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u8 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + sspi->regs->txfifo_data);\r\nsspi->left_tx_word--;\r\n}\r\nstatic void spi_sirfsoc_rx_word_u16(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu16 *rx = sspi->rx;\r\ndata = readl(sspi->base + sspi->regs->rxfifo_data);\r\nif (rx) {\r\n*rx++ = (u16) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_word--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u16(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u16 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + sspi->regs->txfifo_data);\r\nsspi->left_tx_word--;\r\n}\r\nstatic void spi_sirfsoc_rx_word_u32(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu32 *rx = sspi->rx;\r\ndata = readl(sspi->base + sspi->regs->rxfifo_data);\r\nif (rx) {\r\n*rx++ = (u32) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_word--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u32(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u32 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + sspi->regs->txfifo_data);\r\nsspi->left_tx_word--;\r\n}\r\nstatic irqreturn_t spi_sirfsoc_irq(int irq, void *dev_id)\r\n{\r\nstruct sirfsoc_spi *sspi = dev_id;\r\nu32 spi_stat;\r\nspi_stat = readl(sspi->base + sspi->regs->int_st);\r\nif (sspi->tx_by_cmd && sspi->type == SIRF_REAL_SPI\r\n&& (spi_stat & SIRFSOC_SPI_FRM_END)) {\r\ncomplete(&sspi->tx_done);\r\nwritel(0x0, sspi->base + sspi->regs->int_en);\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (spi_stat & SIRFSOC_SPI_RX_OFLOW ||\r\nspi_stat & SIRFSOC_SPI_TX_UFLOW) {\r\ncomplete(&sspi->tx_done);\r\ncomplete(&sspi->rx_done);\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\ncase SIRF_USP_SPI_P2:\r\nwritel(0x0, sspi->base + sspi->regs->int_en);\r\nbreak;\r\ncase SIRF_USP_SPI_A7:\r\nwritel(~0UL, sspi->base + sspi->regs->usp_int_en_clr);\r\nbreak;\r\n}\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (spi_stat & SIRFSOC_SPI_TXFIFO_EMPTY)\r\ncomplete(&sspi->tx_done);\r\nwhile (!(readl(sspi->base + sspi->regs->int_st) &\r\nSIRFSOC_SPI_RX_IO_DMA))\r\ncpu_relax();\r\ncomplete(&sspi->rx_done);\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\ncase SIRF_USP_SPI_P2:\r\nwritel(0x0, sspi->base + sspi->regs->int_en);\r\nbreak;\r\ncase SIRF_USP_SPI_A7:\r\nwritel(~0UL, sspi->base + sspi->regs->usp_int_en_clr);\r\nbreak;\r\n}\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void spi_sirfsoc_dma_fini_callback(void *data)\r\n{\r\nstruct completion *dma_complete = data;\r\ncomplete(dma_complete);\r\n}\r\nstatic void spi_sirfsoc_cmd_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nint timeout = t->len * 10;\r\nu32 cmd;\r\nsspi = spi_master_get_devdata(spi->master);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + sspi->regs->txfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + sspi->regs->txfifo_op);\r\nmemcpy(&cmd, sspi->tx, t->len);\r\nif (sspi->word_width == 1 && !(spi->mode & SPI_LSB_FIRST))\r\ncmd = cpu_to_be32(cmd) >>\r\n((SIRFSOC_MAX_CMD_BYTES - t->len) * 8);\r\nif (sspi->word_width == 2 && t->len == 4 &&\r\n(!(spi->mode & SPI_LSB_FIRST)))\r\ncmd = ((cmd & 0xffff) << 16) | (cmd >> 16);\r\nwritel(cmd, sspi->base + sspi->regs->spi_cmd);\r\nwritel(SIRFSOC_SPI_FRM_END_INT_EN,\r\nsspi->base + sspi->regs->int_en);\r\nwritel(SIRFSOC_SPI_CMD_TX_EN,\r\nsspi->base + sspi->regs->tx_rx_en);\r\nif (wait_for_completion_timeout(&sspi->tx_done, timeout) == 0) {\r\ndev_err(&spi->dev, "cmd transfer timeout\n");\r\nreturn;\r\n}\r\nsspi->left_rx_word -= t->len;\r\n}\r\nstatic void spi_sirfsoc_dma_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nstruct dma_async_tx_descriptor *rx_desc, *tx_desc;\r\nint timeout = t->len * 10;\r\nsspi = spi_master_get_devdata(spi->master);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + sspi->regs->txfifo_op);\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->txfifo_op);\r\nwritel(0, sspi->base + sspi->regs->int_en);\r\nbreak;\r\ncase SIRF_USP_SPI_P2:\r\nwritel(0x0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0x0, sspi->base + sspi->regs->txfifo_op);\r\nwritel(0, sspi->base + sspi->regs->int_en);\r\nbreak;\r\ncase SIRF_USP_SPI_A7:\r\nwritel(0x0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0x0, sspi->base + sspi->regs->txfifo_op);\r\nwritel(~0UL, sspi->base + sspi->regs->usp_int_en_clr);\r\nbreak;\r\n}\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nif (sspi->left_tx_word < sspi->dat_max_frm_len) {\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\nwritel(readl(sspi->base + sspi->regs->spi_ctrl) |\r\nSIRFSOC_SPI_ENA_AUTO_CLR |\r\nSIRFSOC_SPI_MUL_DAT_MODE,\r\nsspi->base + sspi->regs->spi_ctrl);\r\nwritel(sspi->left_tx_word - 1,\r\nsspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(sspi->left_tx_word - 1,\r\nsspi->base + sspi->regs->rx_dma_io_len);\r\nbreak;\r\ncase SIRF_USP_SPI_P2:\r\ncase SIRF_USP_SPI_A7:\r\nwritel(sspi->left_tx_word * sspi->word_width,\r\nsspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(sspi->left_tx_word * sspi->word_width,\r\nsspi->base + sspi->regs->rx_dma_io_len);\r\nbreak;\r\n}\r\n} else {\r\nif (sspi->type == SIRF_REAL_SPI)\r\nwritel(readl(sspi->base + sspi->regs->spi_ctrl),\r\nsspi->base + sspi->regs->spi_ctrl);\r\nwritel(0, sspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(0, sspi->base + sspi->regs->rx_dma_io_len);\r\n}\r\nsspi->dst_start = dma_map_single(&spi->dev, sspi->rx, t->len,\r\n(t->tx_buf != t->rx_buf) ?\r\nDMA_FROM_DEVICE : DMA_BIDIRECTIONAL);\r\nrx_desc = dmaengine_prep_slave_single(sspi->rx_chan,\r\nsspi->dst_start, t->len, DMA_DEV_TO_MEM,\r\nDMA_PREP_INTERRUPT | DMA_CTRL_ACK);\r\nrx_desc->callback = spi_sirfsoc_dma_fini_callback;\r\nrx_desc->callback_param = &sspi->rx_done;\r\nsspi->src_start = dma_map_single(&spi->dev, (void *)sspi->tx, t->len,\r\n(t->tx_buf != t->rx_buf) ?\r\nDMA_TO_DEVICE : DMA_BIDIRECTIONAL);\r\ntx_desc = dmaengine_prep_slave_single(sspi->tx_chan,\r\nsspi->src_start, t->len, DMA_MEM_TO_DEV,\r\nDMA_PREP_INTERRUPT | DMA_CTRL_ACK);\r\ntx_desc->callback = spi_sirfsoc_dma_fini_callback;\r\ntx_desc->callback_param = &sspi->tx_done;\r\ndmaengine_submit(tx_desc);\r\ndmaengine_submit(rx_desc);\r\ndma_async_issue_pending(sspi->tx_chan);\r\ndma_async_issue_pending(sspi->rx_chan);\r\nwritel(SIRFSOC_SPI_RX_EN | SIRFSOC_SPI_TX_EN,\r\nsspi->base + sspi->regs->tx_rx_en);\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7) {\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->txfifo_op);\r\n}\r\nif (wait_for_completion_timeout(&sspi->rx_done, timeout) == 0) {\r\ndev_err(&spi->dev, "transfer timeout\n");\r\ndmaengine_terminate_all(sspi->rx_chan);\r\n} else\r\nsspi->left_rx_word = 0;\r\nif (wait_for_completion_timeout(&sspi->tx_done, timeout) == 0) {\r\ndev_err(&spi->dev, "transfer timeout\n");\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7)\r\nwritel(0, sspi->base + sspi->regs->tx_rx_en);\r\ndmaengine_terminate_all(sspi->tx_chan);\r\n}\r\ndma_unmap_single(&spi->dev, sspi->src_start, t->len, DMA_TO_DEVICE);\r\ndma_unmap_single(&spi->dev, sspi->dst_start, t->len, DMA_FROM_DEVICE);\r\nwritel(0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0, sspi->base + sspi->regs->txfifo_op);\r\nif (sspi->left_tx_word >= sspi->dat_max_frm_len)\r\nwritel(0, sspi->base + sspi->regs->tx_rx_en);\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7)\r\nwritel(0, sspi->base + sspi->regs->tx_rx_en);\r\n}\r\nstatic void spi_sirfsoc_pio_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nint timeout = t->len * 10;\r\nunsigned int data_units;\r\nsspi = spi_master_get_devdata(spi->master);\r\ndo {\r\nwritel(SIRFSOC_SPI_FIFO_RESET,\r\nsspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_RESET,\r\nsspi->base + sspi->regs->txfifo_op);\r\nswitch (sspi->type) {\r\ncase SIRF_USP_SPI_P2:\r\nwritel(0x0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0x0, sspi->base + sspi->regs->txfifo_op);\r\nwritel(0, sspi->base + sspi->regs->int_en);\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nwritel(min((sspi->left_tx_word * sspi->word_width),\r\nsspi->fifo_size),\r\nsspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(min((sspi->left_rx_word * sspi->word_width),\r\nsspi->fifo_size),\r\nsspi->base + sspi->regs->rx_dma_io_len);\r\nbreak;\r\ncase SIRF_USP_SPI_A7:\r\nwritel(0x0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0x0, sspi->base + sspi->regs->txfifo_op);\r\nwritel(~0UL, sspi->base + sspi->regs->usp_int_en_clr);\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nwritel(min((sspi->left_tx_word * sspi->word_width),\r\nsspi->fifo_size),\r\nsspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(min((sspi->left_rx_word * sspi->word_width),\r\nsspi->fifo_size),\r\nsspi->base + sspi->regs->rx_dma_io_len);\r\nbreak;\r\ncase SIRF_REAL_SPI:\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->txfifo_op);\r\nwritel(0, sspi->base + sspi->regs->int_en);\r\nwritel(readl(sspi->base + sspi->regs->int_st),\r\nsspi->base + sspi->regs->int_st);\r\nwritel(readl(sspi->base + sspi->regs->spi_ctrl) |\r\nSIRFSOC_SPI_MUL_DAT_MODE |\r\nSIRFSOC_SPI_ENA_AUTO_CLR,\r\nsspi->base + sspi->regs->spi_ctrl);\r\ndata_units = sspi->fifo_size / sspi->word_width;\r\nwritel(min(sspi->left_tx_word, data_units) - 1,\r\nsspi->base + sspi->regs->tx_dma_io_len);\r\nwritel(min(sspi->left_rx_word, data_units) - 1,\r\nsspi->base + sspi->regs->rx_dma_io_len);\r\nbreak;\r\n}\r\nwhile (!((readl(sspi->base + sspi->regs->txfifo_st)\r\n& SIRFSOC_SPI_FIFO_FULL_MASK(sspi))) &&\r\nsspi->left_tx_word)\r\nsspi->tx_word(sspi);\r\nwritel(SIRFSOC_SPI_TXFIFO_EMPTY_INT_EN |\r\nSIRFSOC_SPI_TX_UFLOW_INT_EN |\r\nSIRFSOC_SPI_RX_OFLOW_INT_EN |\r\nSIRFSOC_SPI_RX_IO_DMA_INT_EN,\r\nsspi->base + sspi->regs->int_en);\r\nwritel(SIRFSOC_SPI_RX_EN | SIRFSOC_SPI_TX_EN,\r\nsspi->base + sspi->regs->tx_rx_en);\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7) {\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START,\r\nsspi->base + sspi->regs->txfifo_op);\r\n}\r\nif (!wait_for_completion_timeout(&sspi->tx_done, timeout) ||\r\n!wait_for_completion_timeout(&sspi->rx_done, timeout)) {\r\ndev_err(&spi->dev, "transfer timeout\n");\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7)\r\nwritel(0, sspi->base + sspi->regs->tx_rx_en);\r\nbreak;\r\n}\r\nwhile (!((readl(sspi->base + sspi->regs->rxfifo_st)\r\n& SIRFSOC_SPI_FIFO_EMPTY_MASK(sspi))) &&\r\nsspi->left_rx_word)\r\nsspi->rx_word(sspi);\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7)\r\nwritel(0, sspi->base + sspi->regs->tx_rx_en);\r\nwritel(0, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(0, sspi->base + sspi->regs->txfifo_op);\r\n} while (sspi->left_tx_word != 0 || sspi->left_rx_word != 0);\r\n}\r\nstatic int spi_sirfsoc_transfer(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nsspi = spi_master_get_devdata(spi->master);\r\nsspi->tx = t->tx_buf;\r\nsspi->rx = t->rx_buf;\r\nsspi->left_tx_word = sspi->left_rx_word = t->len / sspi->word_width;\r\nreinit_completion(&sspi->rx_done);\r\nreinit_completion(&sspi->tx_done);\r\nif (sspi->type == SIRF_REAL_SPI && sspi->tx_by_cmd)\r\nspi_sirfsoc_cmd_transfer(spi, t);\r\nelse if (IS_DMA_VALID(t))\r\nspi_sirfsoc_dma_transfer(spi, t);\r\nelse\r\nspi_sirfsoc_pio_transfer(spi, t);\r\nreturn t->len - sspi->left_rx_word * sspi->word_width;\r\n}\r\nstatic void spi_sirfsoc_chipselect(struct spi_device *spi, int value)\r\n{\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(spi->master);\r\nif (sspi->hw_cs) {\r\nu32 regval;\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\nregval = readl(sspi->base + sspi->regs->spi_ctrl);\r\nswitch (value) {\r\ncase BITBANG_CS_ACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval |= SIRFSOC_SPI_CS_IO_OUT;\r\nelse\r\nregval &= ~SIRFSOC_SPI_CS_IO_OUT;\r\nbreak;\r\ncase BITBANG_CS_INACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval &= ~SIRFSOC_SPI_CS_IO_OUT;\r\nelse\r\nregval |= SIRFSOC_SPI_CS_IO_OUT;\r\nbreak;\r\n}\r\nwritel(regval, sspi->base + sspi->regs->spi_ctrl);\r\nbreak;\r\ncase SIRF_USP_SPI_P2:\r\ncase SIRF_USP_SPI_A7:\r\nregval = readl(sspi->base +\r\nsspi->regs->usp_pin_io_data);\r\nswitch (value) {\r\ncase BITBANG_CS_ACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval |= SIRFSOC_USP_CS_HIGH_VALUE;\r\nelse\r\nregval &= ~(SIRFSOC_USP_CS_HIGH_VALUE);\r\nbreak;\r\ncase BITBANG_CS_INACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval &= ~(SIRFSOC_USP_CS_HIGH_VALUE);\r\nelse\r\nregval |= SIRFSOC_USP_CS_HIGH_VALUE;\r\nbreak;\r\n}\r\nwritel(regval,\r\nsspi->base + sspi->regs->usp_pin_io_data);\r\nbreak;\r\n}\r\n} else {\r\nswitch (value) {\r\ncase BITBANG_CS_ACTIVE:\r\ngpio_direction_output(spi->cs_gpio,\r\nspi->mode & SPI_CS_HIGH ? 1 : 0);\r\nbreak;\r\ncase BITBANG_CS_INACTIVE:\r\ngpio_direction_output(spi->cs_gpio,\r\nspi->mode & SPI_CS_HIGH ? 0 : 1);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int spi_sirfsoc_config_mode(struct spi_device *spi)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nu32 regval, usp_mode1;\r\nsspi = spi_master_get_devdata(spi->master);\r\nregval = readl(sspi->base + sspi->regs->spi_ctrl);\r\nusp_mode1 = readl(sspi->base + sspi->regs->usp_mode1);\r\nif (!(spi->mode & SPI_CS_HIGH)) {\r\nregval |= SIRFSOC_SPI_CS_IDLE_STAT;\r\nusp_mode1 &= ~SIRFSOC_USP_CS_HIGH_VALID;\r\n} else {\r\nregval &= ~SIRFSOC_SPI_CS_IDLE_STAT;\r\nusp_mode1 |= SIRFSOC_USP_CS_HIGH_VALID;\r\n}\r\nif (!(spi->mode & SPI_LSB_FIRST)) {\r\nregval |= SIRFSOC_SPI_TRAN_MSB;\r\nusp_mode1 &= ~SIRFSOC_USP_LSB;\r\n} else {\r\nregval &= ~SIRFSOC_SPI_TRAN_MSB;\r\nusp_mode1 |= SIRFSOC_USP_LSB;\r\n}\r\nif (spi->mode & SPI_CPOL) {\r\nregval |= SIRFSOC_SPI_CLK_IDLE_STAT;\r\nusp_mode1 |= SIRFSOC_USP_SCLK_IDLE_STAT;\r\n} else {\r\nregval &= ~SIRFSOC_SPI_CLK_IDLE_STAT;\r\nusp_mode1 &= ~SIRFSOC_USP_SCLK_IDLE_STAT;\r\n}\r\nif (((spi->mode & SPI_CPOL) && (spi->mode & SPI_CPHA)) ||\r\n(!(spi->mode & SPI_CPOL) && !(spi->mode & SPI_CPHA))) {\r\nregval &= ~SIRFSOC_SPI_DRV_POS_EDGE;\r\nusp_mode1 |= (SIRFSOC_USP_TXD_FALLING_EDGE |\r\nSIRFSOC_USP_RXD_FALLING_EDGE);\r\n} else {\r\nregval |= SIRFSOC_SPI_DRV_POS_EDGE;\r\nusp_mode1 &= ~(SIRFSOC_USP_RXD_FALLING_EDGE |\r\nSIRFSOC_USP_TXD_FALLING_EDGE);\r\n}\r\nwritel((SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, sspi->fifo_size - 2) <<\r\nSIRFSOC_SPI_FIFO_SC_OFFSET) |\r\n(SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, sspi->fifo_size / 2) <<\r\nSIRFSOC_SPI_FIFO_LC_OFFSET) |\r\n(SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, 2) <<\r\nSIRFSOC_SPI_FIFO_HC_OFFSET),\r\nsspi->base + sspi->regs->txfifo_level_chk);\r\nwritel((SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, 2) <<\r\nSIRFSOC_SPI_FIFO_SC_OFFSET) |\r\n(SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, sspi->fifo_size / 2) <<\r\nSIRFSOC_SPI_FIFO_LC_OFFSET) |\r\n(SIRFSOC_SPI_FIFO_LEVEL_CHK_MASK(sspi, sspi->fifo_size - 2) <<\r\nSIRFSOC_SPI_FIFO_HC_OFFSET),\r\nsspi->base + sspi->regs->rxfifo_level_chk);\r\nswitch (sspi->type) {\r\ncase SIRF_REAL_SPI:\r\nregval |= SIRFSOC_SPI_CS_IO_MODE;\r\nwritel(regval, sspi->base + sspi->regs->spi_ctrl);\r\nbreak;\r\ncase SIRF_USP_SPI_P2:\r\ncase SIRF_USP_SPI_A7:\r\nusp_mode1 |= SIRFSOC_USP_SYNC_MODE;\r\nusp_mode1 |= SIRFSOC_USP_TFS_IO_MODE;\r\nusp_mode1 &= ~SIRFSOC_USP_TFS_IO_INPUT;\r\nwritel(usp_mode1, sspi->base + sspi->regs->usp_mode1);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nspi_sirfsoc_setup_transfer(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nu8 bits_per_word = 0;\r\nint hz = 0;\r\nu32 regval, txfifo_ctrl, rxfifo_ctrl, tx_frm_ctl, rx_frm_ctl, usp_mode2;\r\nsspi = spi_master_get_devdata(spi->master);\r\nbits_per_word = (t) ? t->bits_per_word : spi->bits_per_word;\r\nhz = t && t->speed_hz ? t->speed_hz : spi->max_speed_hz;\r\nusp_mode2 = regval = (sspi->ctrl_freq / (2 * hz)) - 1;\r\nif (regval > 0xFFFF || regval < 0) {\r\ndev_err(&spi->dev, "Speed %d not supported\n", hz);\r\nreturn -EINVAL;\r\n}\r\nswitch (bits_per_word) {\r\ncase 8:\r\nregval |= SIRFSOC_SPI_TRAN_DAT_FORMAT_8;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u8;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u8;\r\nbreak;\r\ncase 12:\r\ncase 16:\r\nregval |= (bits_per_word == 12) ?\r\nSIRFSOC_SPI_TRAN_DAT_FORMAT_12 :\r\nSIRFSOC_SPI_TRAN_DAT_FORMAT_16;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u16;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u16;\r\nbreak;\r\ncase 32:\r\nregval |= SIRFSOC_SPI_TRAN_DAT_FORMAT_32;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u32;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u32;\r\nbreak;\r\ndefault:\r\ndev_err(&spi->dev, "bpw %d not supported\n", bits_per_word);\r\nreturn -EINVAL;\r\n}\r\nsspi->word_width = DIV_ROUND_UP(bits_per_word, 8);\r\ntxfifo_ctrl = (((sspi->fifo_size / 2) &\r\nSIRFSOC_SPI_FIFO_THD_MASK(sspi))\r\n<< SIRFSOC_SPI_FIFO_THD_OFFSET) |\r\n(sspi->word_width >> 1);\r\nrxfifo_ctrl = (((sspi->fifo_size / 2) &\r\nSIRFSOC_SPI_FIFO_THD_MASK(sspi))\r\n<< SIRFSOC_SPI_FIFO_THD_OFFSET) |\r\n(sspi->word_width >> 1);\r\nwritel(txfifo_ctrl, sspi->base + sspi->regs->txfifo_ctrl);\r\nwritel(rxfifo_ctrl, sspi->base + sspi->regs->rxfifo_ctrl);\r\nif (sspi->type == SIRF_USP_SPI_P2 ||\r\nsspi->type == SIRF_USP_SPI_A7) {\r\ntx_frm_ctl = 0;\r\ntx_frm_ctl |= ((bits_per_word - 1) & SIRFSOC_USP_TX_DATA_MASK)\r\n<< SIRFSOC_USP_TX_DATA_OFFSET;\r\ntx_frm_ctl |= ((bits_per_word + 1 + SIRFSOC_USP_TXD_DELAY_LEN\r\n- 1) & SIRFSOC_USP_TX_SYNC_MASK) <<\r\nSIRFSOC_USP_TX_SYNC_OFFSET;\r\ntx_frm_ctl |= ((bits_per_word + 1 + SIRFSOC_USP_TXD_DELAY_LEN\r\n+ 2 - 1) & SIRFSOC_USP_TX_FRAME_MASK) <<\r\nSIRFSOC_USP_TX_FRAME_OFFSET;\r\ntx_frm_ctl |= ((bits_per_word - 1) &\r\nSIRFSOC_USP_TX_SHIFTER_MASK) <<\r\nSIRFSOC_USP_TX_SHIFTER_OFFSET;\r\nrx_frm_ctl = 0;\r\nrx_frm_ctl |= ((bits_per_word - 1) & SIRFSOC_USP_RX_DATA_MASK)\r\n<< SIRFSOC_USP_RX_DATA_OFFSET;\r\nrx_frm_ctl |= ((bits_per_word + 1 + SIRFSOC_USP_RXD_DELAY_LEN\r\n+ 2 - 1) & SIRFSOC_USP_RX_FRAME_MASK) <<\r\nSIRFSOC_USP_RX_FRAME_OFFSET;\r\nrx_frm_ctl |= ((bits_per_word - 1)\r\n& SIRFSOC_USP_RX_SHIFTER_MASK) <<\r\nSIRFSOC_USP_RX_SHIFTER_OFFSET;\r\nwritel(tx_frm_ctl | (((usp_mode2 >> 10) &\r\nSIRFSOC_USP_CLK_10_11_MASK) <<\r\nSIRFSOC_USP_CLK_10_11_OFFSET),\r\nsspi->base + sspi->regs->usp_tx_frame_ctrl);\r\nwritel(rx_frm_ctl | (((usp_mode2 >> 12) &\r\nSIRFSOC_USP_CLK_12_15_MASK) <<\r\nSIRFSOC_USP_CLK_12_15_OFFSET),\r\nsspi->base + sspi->regs->usp_rx_frame_ctrl);\r\nwritel(readl(sspi->base + sspi->regs->usp_mode2) |\r\n((usp_mode2 & SIRFSOC_USP_CLK_DIVISOR_MASK) <<\r\nSIRFSOC_USP_CLK_DIVISOR_OFFSET) |\r\n(SIRFSOC_USP_RXD_DELAY_LEN <<\r\nSIRFSOC_USP_RXD_DELAY_OFFSET) |\r\n(SIRFSOC_USP_TXD_DELAY_LEN <<\r\nSIRFSOC_USP_TXD_DELAY_OFFSET),\r\nsspi->base + sspi->regs->usp_mode2);\r\n}\r\nif (sspi->type == SIRF_REAL_SPI)\r\nwritel(regval, sspi->base + sspi->regs->spi_ctrl);\r\nspi_sirfsoc_config_mode(spi);\r\nif (sspi->type == SIRF_REAL_SPI) {\r\nif (t && t->tx_buf && !t->rx_buf &&\r\n(t->len <= SIRFSOC_MAX_CMD_BYTES)) {\r\nsspi->tx_by_cmd = true;\r\nwritel(readl(sspi->base + sspi->regs->spi_ctrl) |\r\n(SIRFSOC_SPI_CMD_BYTE_NUM((t->len - 1)) |\r\nSIRFSOC_SPI_CMD_MODE),\r\nsspi->base + sspi->regs->spi_ctrl);\r\n} else {\r\nsspi->tx_by_cmd = false;\r\nwritel(readl(sspi->base + sspi->regs->spi_ctrl) &\r\n~SIRFSOC_SPI_CMD_MODE,\r\nsspi->base + sspi->regs->spi_ctrl);\r\n}\r\n}\r\nif (IS_DMA_VALID(t)) {\r\nwritel(0, sspi->base + sspi->regs->tx_dma_io_ctrl);\r\nwritel(SIRFSOC_SPI_RX_DMA_FLUSH,\r\nsspi->base + sspi->regs->rx_dma_io_ctrl);\r\n} else {\r\nwritel(SIRFSOC_SPI_IO_MODE_SEL,\r\nsspi->base + sspi->regs->tx_dma_io_ctrl);\r\nwritel(SIRFSOC_SPI_IO_MODE_SEL,\r\nsspi->base + sspi->regs->rx_dma_io_ctrl);\r\n}\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_setup(struct spi_device *spi)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nint ret = 0;\r\nsspi = spi_master_get_devdata(spi->master);\r\nif (spi->cs_gpio == -ENOENT)\r\nsspi->hw_cs = true;\r\nelse {\r\nsspi->hw_cs = false;\r\nif (!spi_get_ctldata(spi)) {\r\nvoid *cs = kmalloc(sizeof(int), GFP_KERNEL);\r\nif (!cs) {\r\nret = -ENOMEM;\r\ngoto exit;\r\n}\r\nret = gpio_is_valid(spi->cs_gpio);\r\nif (!ret) {\r\ndev_err(&spi->dev, "no valid gpio\n");\r\nret = -ENOENT;\r\ngoto exit;\r\n}\r\nret = gpio_request(spi->cs_gpio, DRIVER_NAME);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to request gpio\n");\r\ngoto exit;\r\n}\r\nspi_set_ctldata(spi, cs);\r\n}\r\n}\r\nspi_sirfsoc_config_mode(spi);\r\nspi_sirfsoc_chipselect(spi, BITBANG_CS_INACTIVE);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic void spi_sirfsoc_cleanup(struct spi_device *spi)\r\n{\r\nif (spi_get_ctldata(spi)) {\r\ngpio_free(spi->cs_gpio);\r\nkfree(spi_get_ctldata(spi));\r\n}\r\n}\r\nstatic int spi_sirfsoc_probe(struct platform_device *pdev)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nstruct spi_master *master;\r\nstruct resource *mem_res;\r\nstruct sirf_spi_comp_data *spi_comp_data;\r\nint irq;\r\nint ret;\r\nconst struct of_device_id *match;\r\nret = device_reset(&pdev->dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "SPI reset failed!\n");\r\nreturn ret;\r\n}\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(*sspi));\r\nif (!master) {\r\ndev_err(&pdev->dev, "Unable to allocate SPI master\n");\r\nreturn -ENOMEM;\r\n}\r\nmatch = of_match_node(spi_sirfsoc_of_match, pdev->dev.of_node);\r\nplatform_set_drvdata(pdev, master);\r\nsspi = spi_master_get_devdata(master);\r\nsspi->fifo_full_offset = ilog2(sspi->fifo_size);\r\nspi_comp_data = (struct sirf_spi_comp_data *)match->data;\r\nsspi->regs = spi_comp_data->regs;\r\nsspi->type = spi_comp_data->type;\r\nsspi->fifo_level_chk_mask = (sspi->fifo_size / 4) - 1;\r\nsspi->dat_max_frm_len = spi_comp_data->dat_max_frm_len;\r\nsspi->fifo_size = spi_comp_data->fifo_size;\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nsspi->base = devm_ioremap_resource(&pdev->dev, mem_res);\r\nif (IS_ERR(sspi->base)) {\r\nret = PTR_ERR(sspi->base);\r\ngoto free_master;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nret = -ENXIO;\r\ngoto free_master;\r\n}\r\nret = devm_request_irq(&pdev->dev, irq, spi_sirfsoc_irq, 0,\r\nDRIVER_NAME, sspi);\r\nif (ret)\r\ngoto free_master;\r\nsspi->bitbang.master = master;\r\nsspi->bitbang.chipselect = spi_sirfsoc_chipselect;\r\nsspi->bitbang.setup_transfer = spi_sirfsoc_setup_transfer;\r\nsspi->bitbang.txrx_bufs = spi_sirfsoc_transfer;\r\nsspi->bitbang.master->setup = spi_sirfsoc_setup;\r\nsspi->bitbang.master->cleanup = spi_sirfsoc_cleanup;\r\nmaster->bus_num = pdev->id;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_LSB_FIRST | SPI_CS_HIGH;\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(8) | SPI_BPW_MASK(12) |\r\nSPI_BPW_MASK(16) | SPI_BPW_MASK(32);\r\nmaster->max_speed_hz = SIRFSOC_SPI_DEFAULT_FRQ;\r\nmaster->flags = SPI_MASTER_MUST_RX | SPI_MASTER_MUST_TX;\r\nsspi->bitbang.master->dev.of_node = pdev->dev.of_node;\r\nsspi->rx_chan = dma_request_slave_channel(&pdev->dev, "rx");\r\nif (!sspi->rx_chan) {\r\ndev_err(&pdev->dev, "can not allocate rx dma channel\n");\r\nret = -ENODEV;\r\ngoto free_master;\r\n}\r\nsspi->tx_chan = dma_request_slave_channel(&pdev->dev, "tx");\r\nif (!sspi->tx_chan) {\r\ndev_err(&pdev->dev, "can not allocate tx dma channel\n");\r\nret = -ENODEV;\r\ngoto free_rx_dma;\r\n}\r\nsspi->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sspi->clk)) {\r\nret = PTR_ERR(sspi->clk);\r\ngoto free_tx_dma;\r\n}\r\nclk_prepare_enable(sspi->clk);\r\nif (spi_comp_data->hwinit)\r\nspi_comp_data->hwinit(sspi);\r\nsspi->ctrl_freq = clk_get_rate(sspi->clk);\r\ninit_completion(&sspi->rx_done);\r\ninit_completion(&sspi->tx_done);\r\nret = spi_bitbang_start(&sspi->bitbang);\r\nif (ret)\r\ngoto free_clk;\r\ndev_info(&pdev->dev, "registered, bus number = %d\n", master->bus_num);\r\nreturn 0;\r\nfree_clk:\r\nclk_disable_unprepare(sspi->clk);\r\nclk_put(sspi->clk);\r\nfree_tx_dma:\r\ndma_release_channel(sspi->tx_chan);\r\nfree_rx_dma:\r\ndma_release_channel(sspi->rx_chan);\r\nfree_master:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int spi_sirfsoc_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master;\r\nstruct sirfsoc_spi *sspi;\r\nmaster = platform_get_drvdata(pdev);\r\nsspi = spi_master_get_devdata(master);\r\nspi_bitbang_stop(&sspi->bitbang);\r\nclk_disable_unprepare(sspi->clk);\r\nclk_put(sspi->clk);\r\ndma_release_channel(sspi->rx_chan);\r\ndma_release_channel(sspi->tx_chan);\r\nspi_master_put(master);\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_suspend(struct device *dev)\r\n{\r\nstruct spi_master *master = dev_get_drvdata(dev);\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(master);\r\nint ret;\r\nret = spi_master_suspend(master);\r\nif (ret)\r\nreturn ret;\r\nclk_disable(sspi->clk);\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_resume(struct device *dev)\r\n{\r\nstruct spi_master *master = dev_get_drvdata(dev);\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(master);\r\nclk_enable(sspi->clk);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + sspi->regs->txfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + sspi->regs->rxfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + sspi->regs->txfifo_op);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + sspi->regs->rxfifo_op);\r\nreturn 0;\r\n}

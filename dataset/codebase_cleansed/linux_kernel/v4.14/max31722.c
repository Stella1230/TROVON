static int max31722_set_mode(struct max31722_data *data, u8 mode)\r\n{\r\nint ret;\r\nstruct spi_device *spi = data->spi_device;\r\nu8 buf[2] = {\r\nMAX31722_REG_CFG | MAX31722_WRITE_MASK,\r\n(data->mode & MAX31722_MODE_MASK) | mode\r\n};\r\nret = spi_write(spi, &buf, sizeof(buf));\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "failed to set sensor mode.\n");\r\nreturn ret;\r\n}\r\ndata->mode = (data->mode & MAX31722_MODE_MASK) | mode;\r\nreturn 0;\r\n}\r\nstatic ssize_t max31722_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nssize_t ret;\r\nstruct max31722_data *data = dev_get_drvdata(dev);\r\nret = spi_w8r16(data->spi_device, MAX31722_REG_TEMP_LSB);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", (s16)le16_to_cpu(ret) * 125 / 32);\r\n}\r\nstatic int max31722_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct max31722_data *data;\r\ndata = devm_kzalloc(&spi->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, data);\r\ndata->spi_device = spi;\r\ndata->mode = MAX31722_MODE_CONTINUOUS | MAX31722_RESOLUTION_12BIT;\r\nret = max31722_set_mode(data, MAX31722_MODE_CONTINUOUS);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->hwmon_dev = hwmon_device_register_with_groups(&spi->dev,\r\nspi->modalias,\r\ndata,\r\nmax31722_groups);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nmax31722_set_mode(data, MAX31722_MODE_STANDBY);\r\nreturn PTR_ERR(data->hwmon_dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max31722_remove(struct spi_device *spi)\r\n{\r\nstruct max31722_data *data = spi_get_drvdata(spi);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nreturn max31722_set_mode(data, MAX31722_MODE_STANDBY);\r\n}\r\nstatic int __maybe_unused max31722_suspend(struct device *dev)\r\n{\r\nstruct spi_device *spi_device = to_spi_device(dev);\r\nstruct max31722_data *data = spi_get_drvdata(spi_device);\r\nreturn max31722_set_mode(data, MAX31722_MODE_STANDBY);\r\n}\r\nstatic int __maybe_unused max31722_resume(struct device *dev)\r\n{\r\nstruct spi_device *spi_device = to_spi_device(dev);\r\nstruct max31722_data *data = spi_get_drvdata(spi_device);\r\nreturn max31722_set_mode(data, MAX31722_MODE_CONTINUOUS);\r\n}

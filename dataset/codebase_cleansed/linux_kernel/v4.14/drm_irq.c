int drm_irq_install(struct drm_device *dev, int irq)\r\n{\r\nint ret;\r\nunsigned long sh_flags = 0;\r\nif (!drm_core_check_feature(dev, DRIVER_HAVE_IRQ))\r\nreturn -EINVAL;\r\nif (irq == 0)\r\nreturn -EINVAL;\r\nif (!dev->dev_private)\r\nreturn -EINVAL;\r\nif (dev->irq_enabled)\r\nreturn -EBUSY;\r\ndev->irq_enabled = true;\r\nDRM_DEBUG("irq=%d\n", irq);\r\nif (dev->driver->irq_preinstall)\r\ndev->driver->irq_preinstall(dev);\r\nif (drm_core_check_feature(dev, DRIVER_IRQ_SHARED))\r\nsh_flags = IRQF_SHARED;\r\nret = request_irq(irq, dev->driver->irq_handler,\r\nsh_flags, dev->driver->name, dev);\r\nif (ret < 0) {\r\ndev->irq_enabled = false;\r\nreturn ret;\r\n}\r\nif (dev->driver->irq_postinstall)\r\nret = dev->driver->irq_postinstall(dev);\r\nif (ret < 0) {\r\ndev->irq_enabled = false;\r\nif (drm_core_check_feature(dev, DRIVER_LEGACY))\r\nvga_client_register(dev->pdev, NULL, NULL, NULL);\r\nfree_irq(irq, dev);\r\n} else {\r\ndev->irq = irq;\r\n}\r\nreturn ret;\r\n}\r\nint drm_irq_uninstall(struct drm_device *dev)\r\n{\r\nunsigned long irqflags;\r\nbool irq_enabled;\r\nint i;\r\nif (!drm_core_check_feature(dev, DRIVER_HAVE_IRQ))\r\nreturn -EINVAL;\r\nirq_enabled = dev->irq_enabled;\r\ndev->irq_enabled = false;\r\nif (dev->num_crtcs) {\r\nspin_lock_irqsave(&dev->vbl_lock, irqflags);\r\nfor (i = 0; i < dev->num_crtcs; i++) {\r\nstruct drm_vblank_crtc *vblank = &dev->vblank[i];\r\nif (!vblank->enabled)\r\ncontinue;\r\nWARN_ON(drm_core_check_feature(dev, DRIVER_MODESET));\r\ndrm_vblank_disable_and_save(dev, i);\r\nwake_up(&vblank->queue);\r\n}\r\nspin_unlock_irqrestore(&dev->vbl_lock, irqflags);\r\n}\r\nif (!irq_enabled)\r\nreturn -EINVAL;\r\nDRM_DEBUG("irq=%d\n", dev->irq);\r\nif (drm_core_check_feature(dev, DRIVER_LEGACY))\r\nvga_client_register(dev->pdev, NULL, NULL, NULL);\r\nif (dev->driver->irq_uninstall)\r\ndev->driver->irq_uninstall(dev);\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nint drm_legacy_irq_control(struct drm_device *dev, void *data,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_control *ctl = data;\r\nint ret = 0, irq;\r\nif (!drm_core_check_feature(dev, DRIVER_HAVE_IRQ))\r\nreturn 0;\r\nif (!drm_core_check_feature(dev, DRIVER_LEGACY))\r\nreturn 0;\r\nif (WARN_ON(!dev->pdev))\r\nreturn -EINVAL;\r\nswitch (ctl->func) {\r\ncase DRM_INST_HANDLER:\r\nirq = dev->pdev->irq;\r\nif (dev->if_version < DRM_IF_VERSION(1, 2) &&\r\nctl->irq != irq)\r\nreturn -EINVAL;\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_irq_install(dev, irq);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\ncase DRM_UNINST_HANDLER:\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_irq_uninstall(dev);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}

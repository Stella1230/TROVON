static void print_summary(uint32_t status, uint32_t l2_err,\r\nuint32_t memio_err)\r\n{\r\nprintk("Bus watcher error counters: %08x %08x\n", l2_err, memio_err);\r\nprintk("\nLast recorded signature:\n");\r\nprintk("Request %02x from %d, answered by %d with Dcode %d\n",\r\n(unsigned int)(G_SCD_BERR_TID(status) & 0x3f),\r\n(int)(G_SCD_BERR_TID(status) >> 6),\r\n(int)G_SCD_BERR_RID(status),\r\n(int)G_SCD_BERR_DCODE(status));\r\n}\r\nvoid check_bus_watcher(void)\r\n{\r\nu32 status, l2_err, memio_err;\r\n#if defined(CONFIG_SIBYTE_BCM112X) || defined(CONFIG_SIBYTE_SB1250)\r\nstatus = csr_in32(IOADDR(A_SCD_BUS_ERR_STATUS_DEBUG));\r\n#elif defined(CONFIG_SIBYTE_BCM1x55) || defined(CONFIG_SIBYTE_BCM1x80)\r\nstatus = csr_in32(IOADDR(A_BCM1480_BUS_ERR_STATUS_DEBUG));\r\n#else\r\n#error bus watcher being built for unknown Sibyte SOC!\r\n#endif\r\nif (!(status & 0x7fffffff)) {\r\nprintk("Using last values reaped by bus watcher driver\n");\r\nstatus = bw_stats.status;\r\nl2_err = bw_stats.l2_err;\r\nmemio_err = bw_stats.memio_err;\r\n} else {\r\nl2_err = csr_in32(IOADDR(A_BUS_L2_ERRORS));\r\nmemio_err = csr_in32(IOADDR(A_BUS_MEM_IO_ERRORS));\r\n}\r\nif (status & ~(1UL << 31))\r\nprint_summary(status, l2_err, memio_err);\r\nelse\r\nprintk("Bus watcher indicates no error\n");\r\n}\r\nstatic int bw_proc_show(struct seq_file *m, void *v)\r\n{\r\nstruct bw_stats_struct *stats = m->private;\r\nseq_puts(m, "SiByte Bus Watcher statistics\n");\r\nseq_puts(m, "-----------------------------\n");\r\nseq_printf(m, "L2-d-cor %8ld\nL2-d-bad %8ld\n",\r\nstats->l2_cor_d, stats->l2_bad_d);\r\nseq_printf(m, "L2-t-cor %8ld\nL2-t-bad %8ld\n",\r\nstats->l2_cor_t, stats->l2_bad_t);\r\nseq_printf(m, "MC-d-cor %8ld\nMC-d-bad %8ld\n",\r\nstats->mem_cor_d, stats->mem_bad_d);\r\nseq_printf(m, "IO-err %8ld\n", stats->bus_error);\r\nseq_puts(m, "\nLast recorded signature:\n");\r\nseq_printf(m, "Request %02x from %d, answered by %d with Dcode %d\n",\r\n(unsigned int)(G_SCD_BERR_TID(stats->status) & 0x3f),\r\n(int)(G_SCD_BERR_TID(stats->status) >> 6),\r\n(int)G_SCD_BERR_RID(stats->status),\r\n(int)G_SCD_BERR_DCODE(stats->status));\r\nif (stats->status & M_SCD_BERR_MULTERRS)\r\nseq_puts(m, "Multiple errors observed since last check.\n");\r\nif (stats->status_printed) {\r\nseq_puts(m, "(no change since last printing)\n");\r\n} else {\r\nstats->status_printed = 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bw_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, bw_proc_show, PDE_DATA(inode));\r\n}\r\nstatic void create_proc_decoder(struct bw_stats_struct *stats)\r\n{\r\nstruct proc_dir_entry *ent;\r\nent = proc_create_data("bus_watcher", S_IWUSR | S_IRUGO, NULL,\r\n&bw_proc_fops, stats);\r\nif (!ent) {\r\nprintk(KERN_INFO "Unable to initialize bus_watcher /proc entry\n");\r\nreturn;\r\n}\r\n}\r\nstatic irqreturn_t sibyte_bw_int(int irq, void *data)\r\n{\r\nstruct bw_stats_struct *stats = data;\r\nunsigned long cntr;\r\n#ifdef CONFIG_SIBYTE_BW_TRACE\r\nint i;\r\n#endif\r\n#ifdef CONFIG_SIBYTE_BW_TRACE\r\ncsr_out32(M_SCD_TRACE_CFG_FREEZE, IOADDR(A_SCD_TRACE_CFG));\r\ncsr_out32(M_SCD_TRACE_CFG_START_READ, IOADDR(A_SCD_TRACE_CFG));\r\nfor (i=0; i<256*6; i++)\r\nprintk("%016llx\n",\r\n(long long)__raw_readq(IOADDR(A_SCD_TRACE_READ)));\r\ncsr_out32(M_SCD_TRACE_CFG_RESET, IOADDR(A_SCD_TRACE_CFG));\r\ncsr_out32(M_SCD_TRACE_CFG_START, IOADDR(A_SCD_TRACE_CFG));\r\n#endif\r\nstats->status = csr_in32(IOADDR(A_SCD_BUS_ERR_STATUS));\r\nstats->status_printed = 0;\r\nstats->l2_err = cntr = csr_in32(IOADDR(A_BUS_L2_ERRORS));\r\nstats->l2_cor_d += G_SCD_L2ECC_CORR_D(cntr);\r\nstats->l2_bad_d += G_SCD_L2ECC_BAD_D(cntr);\r\nstats->l2_cor_t += G_SCD_L2ECC_CORR_T(cntr);\r\nstats->l2_bad_t += G_SCD_L2ECC_BAD_T(cntr);\r\ncsr_out32(0, IOADDR(A_BUS_L2_ERRORS));\r\nstats->memio_err = cntr = csr_in32(IOADDR(A_BUS_MEM_IO_ERRORS));\r\nstats->mem_cor_d += G_SCD_MEM_ECC_CORR(cntr);\r\nstats->mem_bad_d += G_SCD_MEM_ECC_BAD(cntr);\r\nstats->bus_error += G_SCD_MEM_BUSERR(cntr);\r\ncsr_out32(0, IOADDR(A_BUS_MEM_IO_ERRORS));\r\nreturn IRQ_HANDLED;\r\n}\r\nint __init sibyte_bus_watcher(void)\r\n{\r\nmemset(&bw_stats, 0, sizeof(struct bw_stats_struct));\r\nbw_stats.status_printed = 1;\r\nif (request_irq(K_INT_BAD_ECC, sibyte_bw_int, 0, "Bus watcher", &bw_stats)) {\r\nprintk("Failed to register bus watcher BAD_ECC irq\n");\r\nreturn -1;\r\n}\r\nif (request_irq(K_INT_COR_ECC, sibyte_bw_int, 0, "Bus watcher", &bw_stats)) {\r\nfree_irq(K_INT_BAD_ECC, &bw_stats);\r\nprintk("Failed to register bus watcher COR_ECC irq\n");\r\nreturn -1;\r\n}\r\nif (request_irq(K_INT_IO_BUS, sibyte_bw_int, 0, "Bus watcher", &bw_stats)) {\r\nfree_irq(K_INT_BAD_ECC, &bw_stats);\r\nfree_irq(K_INT_COR_ECC, &bw_stats);\r\nprintk("Failed to register bus watcher IO_BUS irq\n");\r\nreturn -1;\r\n}\r\n#ifdef CONFIG_PROC_FS\r\ncreate_proc_decoder(&bw_stats);\r\n#endif\r\n#ifdef CONFIG_SIBYTE_BW_TRACE\r\ncsr_out32((M_SCD_TRSEQ_ASAMPLE | M_SCD_TRSEQ_DSAMPLE |\r\nK_SCD_TRSEQ_TRIGGER_ALL),\r\nIOADDR(A_SCD_TRACE_SEQUENCE_0));\r\ncsr_out32(M_SCD_TRACE_CFG_RESET, IOADDR(A_SCD_TRACE_CFG));\r\ncsr_out32(M_SCD_TRACE_CFG_START, IOADDR(A_SCD_TRACE_CFG));\r\n#endif\r\nreturn 0;\r\n}

unsigned char SROMbyReadEmbedded(void __iomem *iobase,\r\nunsigned char byContntOffset)\r\n{\r\nunsigned short wDelay, wNoACK;\r\nunsigned char byWait;\r\nunsigned char byData;\r\nunsigned char byOrg;\r\nbyData = 0xFF;\r\nVNSvInPortB(iobase + MAC_REG_I2MCFG, &byOrg);\r\nVNSvOutPortB(iobase + MAC_REG_I2MCFG, (byOrg & (~I2MCFG_NORETRY)));\r\nfor (wNoACK = 0; wNoACK < W_MAX_I2CRETRY; wNoACK++) {\r\nVNSvOutPortB(iobase + MAC_REG_I2MTGID, EEP_I2C_DEV_ID);\r\nVNSvOutPortB(iobase + MAC_REG_I2MTGAD, byContntOffset);\r\nVNSvOutPortB(iobase + MAC_REG_I2MCSR, I2MCSR_EEMR);\r\nfor (wDelay = 0; wDelay < W_MAX_TIMEOUT; wDelay++) {\r\nVNSvInPortB(iobase + MAC_REG_I2MCSR, &byWait);\r\nif (byWait & (I2MCSR_DONE | I2MCSR_NACK))\r\nbreak;\r\nPCAvDelayByIO(CB_DELAY_LOOP_WAIT);\r\n}\r\nif ((wDelay < W_MAX_TIMEOUT) &&\r\n(!(byWait & I2MCSR_NACK))) {\r\nbreak;\r\n}\r\n}\r\nVNSvInPortB(iobase + MAC_REG_I2MDIPT, &byData);\r\nVNSvOutPortB(iobase + MAC_REG_I2MCFG, byOrg);\r\nreturn byData;\r\n}\r\nvoid SROMvReadAllContents(void __iomem *iobase, unsigned char *pbyEepromRegs)\r\n{\r\nint ii;\r\nfor (ii = 0; ii < EEP_MAX_CONTEXT_SIZE; ii++) {\r\n*pbyEepromRegs = SROMbyReadEmbedded(iobase,\r\n(unsigned char)ii);\r\npbyEepromRegs++;\r\n}\r\n}\r\nvoid SROMvReadEtherAddress(void __iomem *iobase,\r\nunsigned char *pbyEtherAddress)\r\n{\r\nunsigned char ii;\r\nfor (ii = 0; ii < ETH_ALEN; ii++) {\r\n*pbyEtherAddress = SROMbyReadEmbedded(iobase, ii);\r\npbyEtherAddress++;\r\n}\r\n}

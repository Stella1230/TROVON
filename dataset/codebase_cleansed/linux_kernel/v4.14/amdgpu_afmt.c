static void amdgpu_afmt_calc_cts(uint32_t clock, int *CTS, int *N, int freq)\r\n{\r\nint n, cts;\r\nunsigned long div, mul;\r\nn = 128 * freq;\r\ncts = clock * 1000;\r\ndiv = gcd(n, cts);\r\nn /= div;\r\ncts /= div;\r\nmul = ((128*freq/1000) + (n-1))/n;\r\nn *= mul;\r\ncts *= mul;\r\nif (n < (128*freq/1500))\r\npr_warn("Calculated ACR N value is too small. You may experience audio problems.\n");\r\nif (n > (128*freq/300))\r\npr_warn("Calculated ACR N value is too large. You may experience audio problems.\n");\r\n*N = n;\r\n*CTS = cts;\r\nDRM_DEBUG("Calculated ACR timing N=%d CTS=%d for frequency %d\n",\r\n*N, *CTS, freq);\r\n}\r\nstruct amdgpu_afmt_acr amdgpu_afmt_acr(uint32_t clock)\r\n{\r\nstruct amdgpu_afmt_acr res;\r\nu8 i;\r\nfor (i = 0; i < ARRAY_SIZE(amdgpu_afmt_predefined_acr); i++) {\r\nif (amdgpu_afmt_predefined_acr[i].clock == clock)\r\nreturn amdgpu_afmt_predefined_acr[i];\r\n}\r\namdgpu_afmt_calc_cts(clock, &res.cts_32khz, &res.n_32khz, 32000);\r\namdgpu_afmt_calc_cts(clock, &res.cts_44_1khz, &res.n_44_1khz, 44100);\r\namdgpu_afmt_calc_cts(clock, &res.cts_48khz, &res.n_48khz, 48000);\r\nreturn res;\r\n}

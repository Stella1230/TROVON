static int nettel_reboot_notifier(struct notifier_block *nb, unsigned long val, void *v)\r\n{\r\nstruct cfi_private *cfi = nettel_intel_map.fldrv_priv;\r\nunsigned long b;\r\nfor (b = 0; (b < nettel_intel_partitions[3].size); b += 0x100000) {\r\ncfi_send_gen_cmd(0xff, 0x55, b, &nettel_intel_map, cfi,\r\ncfi->device_type, NULL);\r\n}\r\nreturn(NOTIFY_OK);\r\n}\r\nstatic int __init nettel_init(void)\r\n{\r\nvolatile unsigned long *amdpar;\r\nunsigned long amdaddr, maxsize;\r\nint num_amd_partitions=0;\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nvolatile unsigned long *intel0par, *intel1par;\r\nunsigned long orig_bootcspar, orig_romcs1par;\r\nunsigned long intel0addr, intel0size;\r\nunsigned long intel1addr, intel1size;\r\nint intelboot, intel0cs, intel1cs;\r\nint num_intel_partitions;\r\n#endif\r\nint rc = 0;\r\nnettel_mmcrp = (void *) ioremap_nocache(0xfffef000, 4096);\r\nif (nettel_mmcrp == NULL) {\r\nprintk("SNAPGEAR: failed to disable MMCR cache??\n");\r\nreturn(-EIO);\r\n}\r\n*((unsigned char *) (nettel_mmcrp + 0xc64)) = 0x01;\r\namdpar = (volatile unsigned long *) (nettel_mmcrp + 0xc4);\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nintelboot = 0;\r\nintel0cs = SC520_PAR_ROMCS1;\r\nintel0par = (volatile unsigned long *) (nettel_mmcrp + 0xc0);\r\nintel1cs = SC520_PAR_ROMCS2;\r\nintel1par = (volatile unsigned long *) (nettel_mmcrp + 0xbc);\r\norig_bootcspar = *amdpar;\r\norig_romcs1par = *intel0par;\r\n*intel0par = 0;\r\n*intel1par = 0;\r\n#endif\r\namdaddr = 0x20000000;\r\nmaxsize = AMD_WINDOW_MAXSIZE;\r\n*amdpar = SC520_PAR(SC520_PAR_BOOTCS, amdaddr, maxsize);\r\n__asm__ ("wbinvd");\r\nnettel_amd_map.phys = amdaddr;\r\nnettel_amd_map.virt = ioremap_nocache(amdaddr, maxsize);\r\nif (!nettel_amd_map.virt) {\r\nprintk("SNAPGEAR: failed to ioremap() BOOTCS\n");\r\niounmap(nettel_mmcrp);\r\nreturn(-EIO);\r\n}\r\nsimple_map_init(&nettel_amd_map);\r\nif ((amd_mtd = do_map_probe("jedec_probe", &nettel_amd_map))) {\r\nprintk(KERN_NOTICE "SNAPGEAR: AMD flash device size = %dK\n",\r\n(int)(amd_mtd->size>>10));\r\namd_mtd->owner = THIS_MODULE;\r\nnum_amd_partitions = NUM_AMD_PARTITIONS;\r\nif (amd_mtd->size < AMD_WINDOW_MAXSIZE)\r\nnum_amd_partitions--;\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nmaxsize = SC520_PAR_TO_SIZE(orig_romcs1par);\r\nif (maxsize < (32 * 1024 * 1024))\r\nmaxsize = (32 * 1024 * 1024);\r\nintel0addr = amdaddr + maxsize;\r\n#endif\r\n} else {\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nintelboot++;\r\nif (!orig_romcs1par) {\r\nintel0cs = SC520_PAR_BOOTCS;\r\nintel0par = (volatile unsigned long *)\r\n(nettel_mmcrp + 0xc4);\r\nintel1cs = SC520_PAR_ROMCS1;\r\nintel1par = (volatile unsigned long *)\r\n(nettel_mmcrp + 0xc0);\r\nintel0addr = SC520_PAR_TO_ADDR(orig_bootcspar);\r\nmaxsize = SC520_PAR_TO_SIZE(orig_bootcspar);\r\n} else {\r\nintel0cs = SC520_PAR_ROMCS1;\r\nintel0par = (volatile unsigned long *)\r\n(nettel_mmcrp + 0xc0);\r\nintel1cs = SC520_PAR_BOOTCS;\r\nintel1par = (volatile unsigned long *)\r\n(nettel_mmcrp + 0xc4);\r\nintel0addr = SC520_PAR_TO_ADDR(orig_romcs1par);\r\nmaxsize = SC520_PAR_TO_SIZE(orig_romcs1par);\r\n}\r\namd_mtd = NULL;\r\niounmap(nettel_amd_map.virt);\r\nnettel_amd_map.virt = NULL;\r\n#else\r\nrc = -ENXIO;\r\ngoto out_unmap2;\r\n#endif\r\n}\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nif (maxsize < (32 * 1024 * 1024))\r\nmaxsize = (32 * 1024 * 1024);\r\n*intel0par = SC520_PAR(intel0cs, intel0addr, maxsize);\r\n*intel1par = 0;\r\nnettel_intel_map.size = maxsize;\r\nnettel_intel_map.phys = intel0addr;\r\nnettel_intel_map.virt = ioremap_nocache(intel0addr, maxsize);\r\nif (!nettel_intel_map.virt) {\r\nprintk("SNAPGEAR: failed to ioremap() ROMCS1\n");\r\nrc = -EIO;\r\ngoto out_unmap2;\r\n}\r\nsimple_map_init(&nettel_intel_map);\r\nintel_mtd = do_map_probe("cfi_probe", &nettel_intel_map);\r\nif (!intel_mtd) {\r\nrc = -ENXIO;\r\ngoto out_unmap1;\r\n}\r\nintel0size = intel_mtd->size;\r\n*intel0par = SC520_PAR(intel0cs, intel0addr, intel0size);\r\nintel1addr = intel0addr + intel0size;\r\n*intel1par = SC520_PAR(intel1cs, intel1addr, maxsize);\r\n__asm__ ("wbinvd");\r\nmaxsize += intel0size;\r\nmap_destroy(intel_mtd);\r\nintel_mtd = NULL;\r\niounmap(nettel_intel_map.virt);\r\nnettel_intel_map.size = maxsize;\r\nnettel_intel_map.virt = ioremap_nocache(intel0addr, maxsize);\r\nif (!nettel_intel_map.virt) {\r\nprintk("SNAPGEAR: failed to ioremap() ROMCS1/2\n");\r\nrc = -EIO;\r\ngoto out_unmap2;\r\n}\r\nintel_mtd = do_map_probe("cfi_probe", &nettel_intel_map);\r\nif (! intel_mtd) {\r\nrc = -ENXIO;\r\ngoto out_unmap1;\r\n}\r\nintel1size = intel_mtd->size - intel0size;\r\nif (intel1size > 0) {\r\n*intel1par = SC520_PAR(intel1cs, intel1addr, intel1size);\r\n__asm__ ("wbinvd");\r\n} else {\r\n*intel1par = 0;\r\n}\r\nprintk(KERN_NOTICE "SNAPGEAR: Intel flash device size = %lldKiB\n",\r\n(unsigned long long)(intel_mtd->size >> 10));\r\nintel_mtd->owner = THIS_MODULE;\r\nnum_intel_partitions = ARRAY_SIZE(nettel_intel_partitions);\r\nif (intelboot) {\r\nnettel_intel_partitions[1].size = (intel0size + intel1size) -\r\n(1024*1024 + intel_mtd->erasesize);\r\nnettel_intel_partitions[3].size = intel0size + intel1size;\r\nnettel_intel_partitions[4].offset =\r\n(intel0size + intel1size) - intel_mtd->erasesize;\r\nnettel_intel_partitions[4].size = intel_mtd->erasesize;\r\nnettel_intel_partitions[5].offset =\r\nnettel_intel_partitions[4].offset;\r\nnettel_intel_partitions[5].size =\r\nnettel_intel_partitions[4].size;\r\n} else {\r\nnum_intel_partitions -= 2;\r\n}\r\nrc = mtd_device_register(intel_mtd, nettel_intel_partitions,\r\nnum_intel_partitions);\r\nif (rc)\r\ngoto out_map_destroy;\r\n#endif\r\nif (amd_mtd) {\r\nrc = mtd_device_register(amd_mtd, nettel_amd_partitions,\r\nnum_amd_partitions);\r\nif (rc)\r\ngoto out_mtd_unreg;\r\n}\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nregister_reboot_notifier(&nettel_notifier_block);\r\n#endif\r\nreturn rc;\r\nout_mtd_unreg:\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nmtd_device_unregister(intel_mtd);\r\nout_map_destroy:\r\nmap_destroy(intel_mtd);\r\nout_unmap1:\r\niounmap(nettel_intel_map.virt);\r\n#endif\r\nout_unmap2:\r\niounmap(nettel_mmcrp);\r\niounmap(nettel_amd_map.virt);\r\nreturn rc;\r\n}\r\nstatic void __exit nettel_cleanup(void)\r\n{\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nunregister_reboot_notifier(&nettel_notifier_block);\r\n#endif\r\nif (amd_mtd) {\r\nmtd_device_unregister(amd_mtd);\r\nmap_destroy(amd_mtd);\r\n}\r\nif (nettel_mmcrp) {\r\niounmap(nettel_mmcrp);\r\nnettel_mmcrp = NULL;\r\n}\r\nif (nettel_amd_map.virt) {\r\niounmap(nettel_amd_map.virt);\r\nnettel_amd_map.virt = NULL;\r\n}\r\n#ifdef CONFIG_MTD_CFI_INTELEXT\r\nif (intel_mtd) {\r\nmtd_device_unregister(intel_mtd);\r\nmap_destroy(intel_mtd);\r\n}\r\nif (nettel_intel_map.virt) {\r\niounmap(nettel_intel_map.virt);\r\nnettel_intel_map.virt = NULL;\r\n}\r\n#endif\r\n}

static void stmmac_config_hw_tstamping(void __iomem *ioaddr, u32 data)\r\n{\r\nwritel(data, ioaddr + PTP_TCR);\r\n}\r\nstatic u32 stmmac_config_sub_second_increment(void __iomem *ioaddr,\r\nu32 ptp_clock, int gmac4)\r\n{\r\nu32 value = readl(ioaddr + PTP_TCR);\r\nunsigned long data;\r\nif (value & PTP_TCR_TSCFUPDT)\r\ndata = (1000000000ULL / 50000000);\r\nelse\r\ndata = (1000000000ULL / ptp_clock);\r\nif (!(value & PTP_TCR_TSCTRLSSR))\r\ndata = (data * 1000) / 465;\r\ndata &= PTP_SSIR_SSINC_MASK;\r\nif (gmac4)\r\ndata = data << GMAC4_PTP_SSIR_SSINC_SHIFT;\r\nwritel(data, ioaddr + PTP_SSIR);\r\nreturn data;\r\n}\r\nstatic int stmmac_init_systime(void __iomem *ioaddr, u32 sec, u32 nsec)\r\n{\r\nint limit;\r\nu32 value;\r\nwritel(sec, ioaddr + PTP_STSUR);\r\nwritel(nsec, ioaddr + PTP_STNSUR);\r\nvalue = readl(ioaddr + PTP_TCR);\r\nvalue |= PTP_TCR_TSINIT;\r\nwritel(value, ioaddr + PTP_TCR);\r\nlimit = 10;\r\nwhile (limit--) {\r\nif (!(readl(ioaddr + PTP_TCR) & PTP_TCR_TSINIT))\r\nbreak;\r\nmdelay(10);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic int stmmac_config_addend(void __iomem *ioaddr, u32 addend)\r\n{\r\nu32 value;\r\nint limit;\r\nwritel(addend, ioaddr + PTP_TAR);\r\nvalue = readl(ioaddr + PTP_TCR);\r\nvalue |= PTP_TCR_TSADDREG;\r\nwritel(value, ioaddr + PTP_TCR);\r\nlimit = 10;\r\nwhile (limit--) {\r\nif (!(readl(ioaddr + PTP_TCR) & PTP_TCR_TSADDREG))\r\nbreak;\r\nmdelay(10);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic int stmmac_adjust_systime(void __iomem *ioaddr, u32 sec, u32 nsec,\r\nint add_sub, int gmac4)\r\n{\r\nu32 value;\r\nint limit;\r\nif (add_sub) {\r\nif (gmac4)\r\nsec = (100000000ULL - sec);\r\nvalue = readl(ioaddr + PTP_TCR);\r\nif (value & PTP_TCR_TSCTRLSSR)\r\nnsec = (PTP_DIGITAL_ROLLOVER_MODE - nsec);\r\nelse\r\nnsec = (PTP_BINARY_ROLLOVER_MODE - nsec);\r\n}\r\nwritel(sec, ioaddr + PTP_STSUR);\r\nvalue = (add_sub << PTP_STNSUR_ADDSUB_SHIFT) | nsec;\r\nwritel(value, ioaddr + PTP_STNSUR);\r\nvalue = readl(ioaddr + PTP_TCR);\r\nvalue |= PTP_TCR_TSUPDT;\r\nwritel(value, ioaddr + PTP_TCR);\r\nlimit = 10;\r\nwhile (limit--) {\r\nif (!(readl(ioaddr + PTP_TCR) & PTP_TCR_TSUPDT))\r\nbreak;\r\nmdelay(10);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic u64 stmmac_get_systime(void __iomem *ioaddr)\r\n{\r\nu64 ns;\r\nns = readl(ioaddr + PTP_STNSR);\r\nns += readl(ioaddr + PTP_STSR) * 1000000000ULL;\r\nreturn ns;\r\n}

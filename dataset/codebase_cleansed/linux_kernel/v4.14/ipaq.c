static int ipaq_open(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nint result = 0;\r\nint retries = connect_retries;\r\nmsleep(1000*initial_wait);\r\nwhile (retries) {\r\nretries--;\r\nresult = usb_control_msg(serial->dev,\r\nusb_sndctrlpipe(serial->dev, 0), 0x22, 0x21,\r\n0x1, 0, NULL, 0, 100);\r\nif (!result)\r\nbreak;\r\nmsleep(1000);\r\n}\r\nif (!retries && result) {\r\ndev_err(&port->dev, "%s - failed doing control urb, error %d\n",\r\n__func__, result);\r\nreturn result;\r\n}\r\nreturn usb_serial_generic_open(tty, port);\r\n}\r\nstatic int ipaq_calc_num_ports(struct usb_serial *serial,\r\nstruct usb_serial_endpoints *epds)\r\n{\r\nif (epds->num_bulk_in == 0 || epds->num_bulk_out == 0)\r\nreturn -ENODEV;\r\nif (epds->num_bulk_in > 1 && epds->num_bulk_out > 1) {\r\nepds->bulk_in[0] = epds->bulk_in[1];\r\nepds->bulk_out[0] = epds->bulk_out[1];\r\n}\r\nepds->num_bulk_in = 1;\r\nepds->num_bulk_out = 1;\r\nreturn 1;\r\n}\r\nstatic int ipaq_startup(struct usb_serial *serial)\r\n{\r\nif (serial->dev->actconfig->desc.bConfigurationValue != 1) {\r\ndev_err(&serial->dev->dev, "active config #%d != 1 ??\n",\r\nserial->dev->actconfig->desc.bConfigurationValue);\r\nreturn -ENODEV;\r\n}\r\nreturn usb_reset_configuration(serial->dev);\r\n}

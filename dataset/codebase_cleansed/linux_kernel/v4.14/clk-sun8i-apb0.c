static struct clk *sun8i_a23_apb0_register(struct device_node *node,\r\nvoid __iomem *reg)\r\n{\r\nconst char *clk_name = node->name;\r\nconst char *clk_parent;\r\nstruct clk *clk;\r\nint ret;\r\nclk_parent = of_clk_get_parent_name(node, 0);\r\nif (!clk_parent)\r\nreturn ERR_PTR(-EINVAL);\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nclk = clk_register_divider(NULL, clk_name, clk_parent, 0, reg,\r\n0, 2, 0, NULL);\r\nif (IS_ERR(clk))\r\nreturn clk;\r\nret = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nif (ret)\r\ngoto err_unregister;\r\nreturn clk;\r\nerr_unregister:\r\nclk_unregister_divider(clk);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void sun8i_a23_apb0_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nstruct resource res;\r\nstruct clk *clk;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\nif (PTR_ERR(reg) != -EINVAL)\r\npr_err("Could not get registers for a23-apb0-clk\n");\r\nreturn;\r\n}\r\nclk = sun8i_a23_apb0_register(node, reg);\r\nif (IS_ERR(clk))\r\ngoto err_unmap;\r\nreturn;\r\nerr_unmap:\r\niounmap(reg);\r\nof_address_to_resource(node, 0, &res);\r\nrelease_mem_region(res.start, resource_size(&res));\r\n}\r\nstatic int sun8i_a23_apb0_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *r;\r\nvoid __iomem *reg;\r\nstruct clk *clk;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nreg = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(reg))\r\nreturn PTR_ERR(reg);\r\nclk = sun8i_a23_apb0_register(np, reg);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nreturn 0;\r\n}

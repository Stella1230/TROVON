static int emac_mdio_read(struct mii_bus *bus, int addr, int regnum)\r\n{\r\nstruct emac_adapter *adpt = bus->priv;\r\nu32 reg;\r\nemac_reg_update32(adpt->base + EMAC_PHY_STS, PHY_ADDR_BMSK,\r\n(addr << PHY_ADDR_SHFT));\r\nreg = SUP_PREAMBLE |\r\n((MDIO_CLK_25_4 << MDIO_CLK_SEL_SHFT) & MDIO_CLK_SEL_BMSK) |\r\n((regnum << MDIO_REG_ADDR_SHFT) & MDIO_REG_ADDR_BMSK) |\r\nMDIO_START | MDIO_RD_NWR;\r\nwritel(reg, adpt->base + EMAC_MDIO_CTRL);\r\nif (readl_poll_timeout(adpt->base + EMAC_MDIO_CTRL, reg,\r\n!(reg & (MDIO_START | MDIO_BUSY)),\r\n100, MDIO_WAIT_TIMES * 100))\r\nreturn -EIO;\r\nreturn (reg >> MDIO_DATA_SHFT) & MDIO_DATA_BMSK;\r\n}\r\nstatic int emac_mdio_write(struct mii_bus *bus, int addr, int regnum, u16 val)\r\n{\r\nstruct emac_adapter *adpt = bus->priv;\r\nu32 reg;\r\nemac_reg_update32(adpt->base + EMAC_PHY_STS, PHY_ADDR_BMSK,\r\n(addr << PHY_ADDR_SHFT));\r\nreg = SUP_PREAMBLE |\r\n((MDIO_CLK_25_4 << MDIO_CLK_SEL_SHFT) & MDIO_CLK_SEL_BMSK) |\r\n((regnum << MDIO_REG_ADDR_SHFT) & MDIO_REG_ADDR_BMSK) |\r\n((val << MDIO_DATA_SHFT) & MDIO_DATA_BMSK) |\r\nMDIO_START;\r\nwritel(reg, adpt->base + EMAC_MDIO_CTRL);\r\nif (readl_poll_timeout(adpt->base + EMAC_MDIO_CTRL, reg,\r\n!(reg & (MDIO_START | MDIO_BUSY)), 100,\r\nMDIO_WAIT_TIMES * 100))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nint emac_phy_config(struct platform_device *pdev, struct emac_adapter *adpt)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct mii_bus *mii_bus;\r\nint ret;\r\nadpt->mii_bus = mii_bus = devm_mdiobus_alloc(&pdev->dev);\r\nif (!mii_bus)\r\nreturn -ENOMEM;\r\nmii_bus->name = "emac-mdio";\r\nsnprintf(mii_bus->id, MII_BUS_ID_SIZE, "%s", pdev->name);\r\nmii_bus->read = emac_mdio_read;\r\nmii_bus->write = emac_mdio_write;\r\nmii_bus->parent = &pdev->dev;\r\nmii_bus->priv = adpt;\r\nif (has_acpi_companion(&pdev->dev)) {\r\nu32 phy_addr;\r\nret = mdiobus_register(mii_bus);\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not register mdio bus\n");\r\nreturn ret;\r\n}\r\nret = device_property_read_u32(&pdev->dev, "phy-channel",\r\n&phy_addr);\r\nif (ret)\r\nadpt->phydev = phy_find_first(mii_bus);\r\nelse\r\nadpt->phydev = mdiobus_get_phy(mii_bus, phy_addr);\r\nif (adpt->phydev)\r\nget_device(&adpt->phydev->mdio.dev);\r\n} else {\r\nstruct device_node *phy_np;\r\nret = of_mdiobus_register(mii_bus, np);\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not register mdio bus\n");\r\nreturn ret;\r\n}\r\nphy_np = of_parse_phandle(np, "phy-handle", 0);\r\nadpt->phydev = of_phy_find_device(phy_np);\r\nof_node_put(phy_np);\r\n}\r\nif (!adpt->phydev) {\r\ndev_err(&pdev->dev, "could not find external phy\n");\r\nmdiobus_unregister(mii_bus);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}

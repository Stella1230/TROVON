static irqreturn_t jornada720_kbd_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct jornadakbd *jornadakbd = platform_get_drvdata(pdev);\r\nstruct input_dev *input = jornadakbd->input;\r\nu8 count, kbd_data, scan_code;\r\njornada_ssp_start();\r\nif (jornada_ssp_inout(GETSCANKEYCODE) != TXDUMMY) {\r\ndev_dbg(&pdev->dev,\r\n"GetKeycode command failed with ETIMEDOUT, flushed bus\n");\r\n} else {\r\ncount = jornada_ssp_byte(TXDUMMY);\r\nwhile (count--) {\r\nkbd_data = jornada_ssp_byte(TXDUMMY);\r\nscan_code = kbd_data & 0x7f;\r\ninput_event(input, EV_MSC, MSC_SCAN, scan_code);\r\ninput_report_key(input, jornadakbd->keymap[scan_code],\r\n!(kbd_data & 0x80));\r\ninput_sync(input);\r\n}\r\n}\r\njornada_ssp_end();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int jornada720_kbd_probe(struct platform_device *pdev)\r\n{\r\nstruct jornadakbd *jornadakbd;\r\nstruct input_dev *input_dev;\r\nint i, err, irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0)\r\nreturn irq < 0 ? irq : -EINVAL;\r\njornadakbd = devm_kzalloc(&pdev->dev, sizeof(*jornadakbd), GFP_KERNEL);\r\ninput_dev = devm_input_allocate_device(&pdev->dev);\r\nif (!jornadakbd || !input_dev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, jornadakbd);\r\nmemcpy(jornadakbd->keymap, jornada_std_keymap,\r\nsizeof(jornada_std_keymap));\r\njornadakbd->input = input_dev;\r\ninput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\r\ninput_dev->name = "HP Jornada 720 keyboard";\r\ninput_dev->phys = "jornadakbd/input0";\r\ninput_dev->keycode = jornadakbd->keymap;\r\ninput_dev->keycodesize = sizeof(unsigned short);\r\ninput_dev->keycodemax = ARRAY_SIZE(jornada_std_keymap);\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->dev.parent = &pdev->dev;\r\nfor (i = 0; i < ARRAY_SIZE(jornadakbd->keymap); i++)\r\n__set_bit(jornadakbd->keymap[i], input_dev->keybit);\r\n__clear_bit(KEY_RESERVED, input_dev->keybit);\r\ninput_set_capability(input_dev, EV_MSC, MSC_SCAN);\r\nerr = devm_request_irq(&pdev->dev, irq, jornada720_kbd_interrupt,\r\nIRQF_TRIGGER_FALLING, "jornadakbd", pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "unable to grab IRQ%d: %d\n", irq, err);\r\nreturn err;\r\n}\r\nreturn input_register_device(jornadakbd->input);\r\n}

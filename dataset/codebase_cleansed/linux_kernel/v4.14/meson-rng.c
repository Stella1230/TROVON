static int meson_rng_read(struct hwrng *rng, void *buf, size_t max, bool wait)\r\n{\r\nstruct meson_rng_data *data =\r\ncontainer_of(rng, struct meson_rng_data, rng);\r\n*(u32 *)buf = readl_relaxed(data->base + RNG_DATA);\r\nreturn sizeof(u32);\r\n}\r\nstatic void meson_rng_clk_disable(void *data)\r\n{\r\nclk_disable_unprepare(data);\r\n}\r\nstatic int meson_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct meson_rng_data *data;\r\nstruct resource *res;\r\nint ret;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->pdev = pdev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(data->base))\r\nreturn PTR_ERR(data->base);\r\ndata->core_clk = devm_clk_get(dev, "core");\r\nif (IS_ERR(data->core_clk))\r\ndata->core_clk = NULL;\r\nif (data->core_clk) {\r\nret = clk_prepare_enable(data->core_clk);\r\nif (ret)\r\nreturn ret;\r\nret = devm_add_action_or_reset(dev, meson_rng_clk_disable,\r\ndata->core_clk);\r\nif (ret)\r\nreturn ret;\r\n}\r\ndata->rng.name = pdev->name;\r\ndata->rng.read = meson_rng_read;\r\nplatform_set_drvdata(pdev, data);\r\nreturn devm_hwrng_register(dev, &data->rng);\r\n}

static int tps65217_pmic_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nint rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nreturn tps65217_set_bits(tps, TPS65217_REG_ENABLE,\r\ndev->desc->enable_mask, dev->desc->enable_mask,\r\nTPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_pmic_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nint rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nreturn tps65217_clear_bits(tps, TPS65217_REG_ENABLE,\r\ndev->desc->enable_mask, TPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_pmic_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nint ret;\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nret = tps65217_set_bits(tps, dev->desc->vsel_reg, dev->desc->vsel_mask,\r\nselector, TPS65217_PROTECT_L2);\r\nswitch (rid) {\r\ncase TPS65217_DCDC_1 ... TPS65217_DCDC_3:\r\nret = tps65217_set_bits(tps, TPS65217_REG_DEFSLEW,\r\nTPS65217_DEFSLEW_GO, TPS65217_DEFSLEW_GO,\r\nTPS65217_PROTECT_L2);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps65217_pmic_set_suspend_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nreturn tps65217_clear_bits(tps, dev->desc->bypass_reg,\r\ndev->desc->bypass_mask,\r\nTPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_pmic_set_suspend_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nif (!tps->strobes[rid])\r\nreturn -EINVAL;\r\nreturn tps65217_set_bits(tps, dev->desc->bypass_reg,\r\ndev->desc->bypass_mask,\r\ntps->strobes[rid], TPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65217_board *pdata = dev_get_platdata(tps->dev);\r\nstruct regulator_dev *rdev;\r\nstruct regulator_config config = { };\r\nint i, ret;\r\nunsigned int val;\r\nif (tps65217_chip_id(tps) != TPS65217) {\r\ndev_err(&pdev->dev, "Invalid tps chip version\n");\r\nreturn -ENODEV;\r\n}\r\ntps->strobes = devm_kzalloc(&pdev->dev, sizeof(u8) *\r\nTPS65217_NUM_REGULATOR, GFP_KERNEL);\r\nplatform_set_drvdata(pdev, tps);\r\nfor (i = 0; i < TPS65217_NUM_REGULATOR; i++) {\r\nconfig.dev = tps->dev;\r\nif (pdata)\r\nconfig.init_data = pdata->tps65217_init_data[i];\r\nconfig.driver_data = tps;\r\nconfig.regmap = tps->regmap;\r\nrdev = devm_regulator_register(&pdev->dev, &regulators[i],\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(tps->dev, "failed to register %s regulator\n",\r\npdev->name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nret = tps65217_reg_read(tps, regulators[i].bypass_reg, &val);\r\ntps->strobes[i] = val & regulators[i].bypass_mask;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init tps65217_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&tps65217_regulator_driver);\r\n}\r\nstatic void __exit tps65217_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&tps65217_regulator_driver);\r\n}

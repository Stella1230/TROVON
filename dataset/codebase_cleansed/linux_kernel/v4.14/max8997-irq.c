static struct i2c_client *get_i2c(struct max8997_dev *max8997,\r\nenum max8997_irq_source src)\r\n{\r\nswitch (src) {\r\ncase PMIC_INT1 ... PMIC_INT4:\r\nreturn max8997->i2c;\r\ncase FUEL_GAUGE:\r\nreturn NULL;\r\ncase MUIC_INT1 ... MUIC_INT3:\r\nreturn max8997->muic;\r\ncase GPIO_LOW ... GPIO_HI:\r\nreturn max8997->i2c;\r\ncase FLASH_STATUS:\r\nreturn max8997->i2c;\r\ndefault:\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\n}\r\nstatic void max8997_irq_lock(struct irq_data *data)\r\n{\r\nstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&max8997->irqlock);\r\n}\r\nstatic void max8997_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++) {\r\nu8 mask_reg = max8997_mask_reg[i];\r\nstruct i2c_client *i2c = get_i2c(max8997, i);\r\nif (mask_reg == MAX8997_REG_INVALID ||\r\nIS_ERR_OR_NULL(i2c))\r\ncontinue;\r\nmax8997->irq_masks_cache[i] = max8997->irq_masks_cur[i];\r\nmax8997_write_reg(i2c, max8997_mask_reg[i],\r\nmax8997->irq_masks_cur[i]);\r\n}\r\nmutex_unlock(&max8997->irqlock);\r\n}\r\ninline static const struct max8997_irq_data *\r\nirq_to_max8997_irq(struct max8997_dev *max8997, struct irq_data *data)\r\n{\r\nreturn &max8997_irqs[data->hwirq];\r\n}\r\nstatic void max8997_irq_mask(struct irq_data *data)\r\n{\r\nstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\r\nconst struct max8997_irq_data *irq_data = irq_to_max8997_irq(max8997,\r\ndata);\r\nmax8997->irq_masks_cur[irq_data->group] |= irq_data->mask;\r\n}\r\nstatic void max8997_irq_unmask(struct irq_data *data)\r\n{\r\nstruct max8997_dev *max8997 = irq_data_get_irq_chip_data(data);\r\nconst struct max8997_irq_data *irq_data = irq_to_max8997_irq(max8997,\r\ndata);\r\nmax8997->irq_masks_cur[irq_data->group] &= ~irq_data->mask;\r\n}\r\nstatic irqreturn_t max8997_irq_thread(int irq, void *data)\r\n{\r\nstruct max8997_dev *max8997 = data;\r\nu8 irq_reg[MAX8997_IRQ_GROUP_NR] = {};\r\nu8 irq_src;\r\nint ret;\r\nint i, cur_irq;\r\nret = max8997_read_reg(max8997->i2c, MAX8997_REG_INTSRC, &irq_src);\r\nif (ret < 0) {\r\ndev_err(max8997->dev, "Failed to read interrupt source: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nif (irq_src & MAX8997_IRQSRC_PMIC) {\r\nmax8997_bulk_read(max8997->i2c, MAX8997_REG_INT1, 4,\r\n&irq_reg[PMIC_INT1]);\r\n}\r\nif (irq_src & MAX8997_IRQSRC_FUELGAUGE) {\r\nirq_reg[FUEL_GAUGE] = 0;\r\n}\r\nif (irq_src & MAX8997_IRQSRC_MUIC) {\r\nmax8997_bulk_read(max8997->muic, MAX8997_MUIC_REG_INT1, 3,\r\n&irq_reg[MUIC_INT1]);\r\n}\r\nif (irq_src & MAX8997_IRQSRC_GPIO) {\r\nu8 gpio_info[MAX8997_NUM_GPIO];\r\nirq_reg[GPIO_LOW] = 0;\r\nirq_reg[GPIO_HI] = 0;\r\nmax8997_bulk_read(max8997->i2c, MAX8997_REG_GPIOCNTL1,\r\nMAX8997_NUM_GPIO, gpio_info);\r\nfor (i = 0; i < MAX8997_NUM_GPIO; i++) {\r\nbool interrupt = false;\r\nswitch (gpio_info[i] & MAX8997_GPIO_INT_MASK) {\r\ncase MAX8997_GPIO_INT_BOTH:\r\nif (max8997->gpio_status[i] != gpio_info[i])\r\ninterrupt = true;\r\nbreak;\r\ncase MAX8997_GPIO_INT_RISE:\r\nif ((max8997->gpio_status[i] != gpio_info[i]) &&\r\n(gpio_info[i] & MAX8997_GPIO_DATA_MASK))\r\ninterrupt = true;\r\nbreak;\r\ncase MAX8997_GPIO_INT_FALL:\r\nif ((max8997->gpio_status[i] != gpio_info[i]) &&\r\n!(gpio_info[i] & MAX8997_GPIO_DATA_MASK))\r\ninterrupt = true;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (interrupt) {\r\nif (i < 8)\r\nirq_reg[GPIO_LOW] |= (1 << i);\r\nelse\r\nirq_reg[GPIO_HI] |= (1 << (i - 8));\r\n}\r\n}\r\n}\r\nif (irq_src & MAX8997_IRQSRC_FLASH) {\r\nret = max8997_read_reg(max8997->i2c, MAX8997_REG_FLASHSTATUS,\r\n&irq_reg[FLASH_STATUS]);\r\n}\r\nfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++)\r\nirq_reg[i] &= ~max8997->irq_masks_cur[i];\r\nfor (i = 0; i < MAX8997_IRQ_NR; i++) {\r\nif (irq_reg[max8997_irqs[i].group] & max8997_irqs[i].mask) {\r\ncur_irq = irq_find_mapping(max8997->irq_domain, i);\r\nif (cur_irq)\r\nhandle_nested_irq(cur_irq);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint max8997_irq_resume(struct max8997_dev *max8997)\r\n{\r\nif (max8997->irq && max8997->irq_domain)\r\nmax8997_irq_thread(0, max8997);\r\nreturn 0;\r\n}\r\nstatic int max8997_irq_domain_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct max8997_dev *max8997 = d->host_data;\r\nirq_set_chip_data(irq, max8997);\r\nirq_set_chip_and_handler(irq, &max8997_irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(irq, 1);\r\nirq_set_noprobe(irq);\r\nreturn 0;\r\n}\r\nint max8997_irq_init(struct max8997_dev *max8997)\r\n{\r\nstruct irq_domain *domain;\r\nint i;\r\nint ret;\r\nu8 val;\r\nif (!max8997->irq) {\r\ndev_warn(max8997->dev, "No interrupt specified.\n");\r\nreturn 0;\r\n}\r\nmutex_init(&max8997->irqlock);\r\nfor (i = 0; i < MAX8997_IRQ_GROUP_NR; i++) {\r\nstruct i2c_client *i2c;\r\nmax8997->irq_masks_cur[i] = 0xff;\r\nmax8997->irq_masks_cache[i] = 0xff;\r\ni2c = get_i2c(max8997, i);\r\nif (IS_ERR_OR_NULL(i2c))\r\ncontinue;\r\nif (max8997_mask_reg[i] == MAX8997_REG_INVALID)\r\ncontinue;\r\nmax8997_write_reg(i2c, max8997_mask_reg[i], 0xff);\r\n}\r\nfor (i = 0; i < MAX8997_NUM_GPIO; i++) {\r\nmax8997->gpio_status[i] = (max8997_read_reg(max8997->i2c,\r\nMAX8997_REG_GPIOCNTL1 + i,\r\n&val)\r\n& MAX8997_GPIO_DATA_MASK) ?\r\ntrue : false;\r\n}\r\ndomain = irq_domain_add_linear(NULL, MAX8997_IRQ_NR,\r\n&max8997_irq_domain_ops, max8997);\r\nif (!domain) {\r\ndev_err(max8997->dev, "could not create irq domain\n");\r\nreturn -ENODEV;\r\n}\r\nmax8997->irq_domain = domain;\r\nret = request_threaded_irq(max8997->irq, NULL, max8997_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"max8997-irq", max8997);\r\nif (ret) {\r\ndev_err(max8997->dev, "Failed to request IRQ %d: %d\n",\r\nmax8997->irq, ret);\r\nreturn ret;\r\n}\r\nif (!max8997->ono)\r\nreturn 0;\r\nret = request_threaded_irq(max8997->ono, NULL, max8997_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT, "max8997-ono", max8997);\r\nif (ret)\r\ndev_err(max8997->dev, "Failed to request ono-IRQ %d: %d\n",\r\nmax8997->ono, ret);\r\nreturn 0;\r\n}\r\nvoid max8997_irq_exit(struct max8997_dev *max8997)\r\n{\r\nif (max8997->ono)\r\nfree_irq(max8997->ono, max8997);\r\nif (max8997->irq)\r\nfree_irq(max8997->irq, max8997);\r\n}

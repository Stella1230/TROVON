bool ntfs_stamp_usnjrnl(ntfs_volume *vol)\r\n{\r\nntfs_debug("Entering.");\r\nif (likely(!NVolUsnJrnlStamped(vol))) {\r\nsle64 stamp;\r\nstruct page *page;\r\nUSN_HEADER *uh;\r\npage = ntfs_map_page(vol->usnjrnl_max_ino->i_mapping, 0);\r\nif (IS_ERR(page)) {\r\nntfs_error(vol->sb, "Failed to read from "\r\n"$UsnJrnl/$DATA/$Max attribute.");\r\nreturn false;\r\n}\r\nuh = (USN_HEADER*)page_address(page);\r\nstamp = get_current_ntfs_time();\r\nntfs_debug("Stamping transaction log ($UsnJrnl): old "\r\n"journal_id 0x%llx, old lowest_valid_usn "\r\n"0x%llx, new journal_id 0x%llx, new "\r\n"lowest_valid_usn 0x%llx.",\r\n(long long)sle64_to_cpu(uh->journal_id),\r\n(long long)sle64_to_cpu(uh->lowest_valid_usn),\r\n(long long)sle64_to_cpu(stamp),\r\ni_size_read(vol->usnjrnl_j_ino));\r\nuh->lowest_valid_usn =\r\ncpu_to_sle64(i_size_read(vol->usnjrnl_j_ino));\r\nuh->journal_id = stamp;\r\nflush_dcache_page(page);\r\nset_page_dirty(page);\r\nntfs_unmap_page(page);\r\nNVolSetUsnJrnlStamped(vol);\r\n}\r\nntfs_debug("Done.");\r\nreturn true;\r\n}

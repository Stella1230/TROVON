static int pci_dio_insn_bits_di_b(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned long iobase = dev->iobase + reg;\r\ndata[1] = inb(iobase);\r\nif (s->n_chan > 8)\r\ndata[1] |= (inb(iobase + 1) << 8);\r\nif (s->n_chan > 16)\r\ndata[1] |= (inb(iobase + 2) << 16);\r\nif (s->n_chan > 24)\r\ndata[1] |= (inb(iobase + 3) << 24);\r\nreturn insn->n;\r\n}\r\nstatic int pci_dio_insn_bits_di_w(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned long iobase = dev->iobase + reg;\r\ndata[1] = inw(iobase);\r\nif (s->n_chan > 16)\r\ndata[1] |= (inw(iobase + 2) << 16);\r\nreturn insn->n;\r\n}\r\nstatic int pci_dio_insn_bits_do_b(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned long iobase = dev->iobase + reg;\r\nif (comedi_dio_update_state(s, data)) {\r\noutb(s->state & 0xff, iobase);\r\nif (s->n_chan > 8)\r\noutb((s->state >> 8) & 0xff, iobase + 1);\r\nif (s->n_chan > 16)\r\noutb((s->state >> 16) & 0xff, iobase + 2);\r\nif (s->n_chan > 24)\r\noutb((s->state >> 24) & 0xff, iobase + 3);\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int pci_dio_insn_bits_do_w(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned long iobase = dev->iobase + reg;\r\nif (comedi_dio_update_state(s, data)) {\r\noutw(s->state & 0xffff, iobase);\r\nif (s->n_chan > 16)\r\noutw((s->state >> 16) & 0xffff, iobase + 2);\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int pci_dio_reset(struct comedi_device *dev, unsigned long cardtype)\r\n{\r\nif (cardtype == TYPE_PCI1752 || cardtype == TYPE_PCI1756)\r\noutw(0, dev->iobase + PCI1752_CFC_REG);\r\nswitch (cardtype) {\r\ncase TYPE_PCI1730:\r\ncase TYPE_PCI1733:\r\ncase TYPE_PCI1736:\r\noutb(0, dev->iobase + PCI173X_INT_EN_REG);\r\noutb(0x0f, dev->iobase + PCI173X_INT_CLR_REG);\r\noutb(0, dev->iobase + PCI173X_INT_RF_REG);\r\nbreak;\r\ncase TYPE_PCI1739:\r\ncase TYPE_PCI1750:\r\ncase TYPE_PCI1751:\r\noutb(0x88, dev->iobase + PCI1750_INT_REG);\r\nbreak;\r\ncase TYPE_PCI1753:\r\ncase TYPE_PCI1753E:\r\noutb(0x88, dev->iobase + PCI1753_INT_REG(0));\r\noutb(0x80, dev->iobase + PCI1753_INT_REG(1));\r\noutb(0x80, dev->iobase + PCI1753_INT_REG(2));\r\noutb(0x80, dev->iobase + PCI1753_INT_REG(3));\r\nif (cardtype == TYPE_PCI1753E) {\r\noutb(0x88, dev->iobase + PCI1753E_INT_REG(0));\r\noutb(0x80, dev->iobase + PCI1753E_INT_REG(1));\r\noutb(0x80, dev->iobase + PCI1753E_INT_REG(2));\r\noutb(0x80, dev->iobase + PCI1753E_INT_REG(3));\r\n}\r\nbreak;\r\ncase TYPE_PCI1754:\r\ncase TYPE_PCI1756:\r\noutw(0x08, dev->iobase + PCI1754_INT_REG(0));\r\noutw(0x08, dev->iobase + PCI1754_INT_REG(1));\r\nif (cardtype == TYPE_PCI1754) {\r\noutw(0x08, dev->iobase + PCI1754_INT_REG(2));\r\noutw(0x08, dev->iobase + PCI1754_INT_REG(3));\r\n}\r\nbreak;\r\ncase TYPE_PCI1762:\r\noutw(0x0101, dev->iobase + PCI1762_INT_REG);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pci_dio_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct dio_boardtype *board = NULL;\r\nconst struct diosubd_data *d;\r\nstruct comedi_subdevice *s;\r\nint ret, subdev, i, j;\r\nif (context < ARRAY_SIZE(boardtypes))\r\nboard = &boardtypes[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nif (context == TYPE_PCI1736)\r\ndev->iobase = pci_resource_start(pcidev, 0);\r\nelse\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\npci_dio_reset(dev, context);\r\nret = comedi_alloc_subdevices(dev, board->nsubdevs);\r\nif (ret)\r\nreturn ret;\r\nsubdev = 0;\r\nfor (i = 0; i < PCI_DIO_MAX_DI_SUBDEVS; i++) {\r\nd = &board->sdi[i];\r\nif (d->chans) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = d->chans;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = board->is_16bit\r\n? pci_dio_insn_bits_di_w\r\n: pci_dio_insn_bits_di_b;\r\ns->private = (void *)d->addr;\r\n}\r\n}\r\nfor (i = 0; i < PCI_DIO_MAX_DO_SUBDEVS; i++) {\r\nd = &board->sdo[i];\r\nif (d->chans) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = d->chans;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = board->is_16bit\r\n? pci_dio_insn_bits_do_w\r\n: pci_dio_insn_bits_do_b;\r\ns->private = (void *)d->addr;\r\nif (board->is_16bit) {\r\noutw(0, dev->iobase + d->addr);\r\nif (s->n_chan > 16)\r\noutw(0, dev->iobase + d->addr + 2);\r\n} else {\r\noutb(0, dev->iobase + d->addr);\r\nif (s->n_chan > 8)\r\noutb(0, dev->iobase + d->addr + 1);\r\nif (s->n_chan > 16)\r\noutb(0, dev->iobase + d->addr + 2);\r\nif (s->n_chan > 24)\r\noutb(0, dev->iobase + d->addr + 3);\r\n}\r\n}\r\n}\r\nfor (i = 0; i < PCI_DIO_MAX_DIO_SUBDEVG; i++) {\r\nd = &board->sdio[i];\r\nfor (j = 0; j < d->chans; j++) {\r\ns = &dev->subdevices[subdev++];\r\nret = subdev_8255_init(dev, s, NULL,\r\nd->addr + j * I8255_SIZE);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nif (board->id_reg) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_INTERNAL;\r\ns->n_chan = 4;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = board->is_16bit ? pci_dio_insn_bits_di_w\r\n: pci_dio_insn_bits_di_b;\r\ns->private = (void *)board->id_reg;\r\n}\r\nif (board->timer_regbase) {\r\ns = &dev->subdevices[subdev++];\r\ndev->pacer = comedi_8254_init(dev->iobase +\r\nboard->timer_regbase,\r\n0, I8254_IO8, 0);\r\nif (!dev->pacer)\r\nreturn -ENOMEM;\r\ncomedi_8254_subdevice_init(s, dev->pacer);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned long pci_dio_override_cardtype(struct pci_dev *pcidev,\r\nunsigned long cardtype)\r\n{\r\nif (cardtype != TYPE_PCI1753)\r\nreturn cardtype;\r\nif (pci_enable_device(pcidev) < 0)\r\nreturn cardtype;\r\nif (pci_request_region(pcidev, 2, "adv_pci_dio") == 0) {\r\nunsigned long reg = pci_resource_start(pcidev, 2) + 53;\r\noutb(0x05, reg);\r\nif ((inb(reg) & 0x07) == 0x02) {\r\noutb(0x02, reg);\r\nif ((inb(reg) & 0x07) == 0x05)\r\ncardtype = TYPE_PCI1753E;\r\n}\r\npci_release_region(pcidev, 2);\r\n}\r\npci_disable_device(pcidev);\r\nreturn cardtype;\r\n}\r\nstatic int adv_pci_dio_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned long cardtype;\r\ncardtype = pci_dio_override_cardtype(dev, id->driver_data);\r\nreturn comedi_pci_auto_config(dev, &adv_pci_dio_driver, cardtype);\r\n}

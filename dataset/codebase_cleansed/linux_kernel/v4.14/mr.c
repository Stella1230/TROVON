void mlx5_init_mkey_table(struct mlx5_core_dev *dev)\r\n{\r\nstruct mlx5_mkey_table *table = &dev->priv.mkey_table;\r\nmemset(table, 0, sizeof(*table));\r\nrwlock_init(&table->lock);\r\nINIT_RADIX_TREE(&table->tree, GFP_ATOMIC);\r\n}\r\nvoid mlx5_cleanup_mkey_table(struct mlx5_core_dev *dev)\r\n{\r\n}\r\nint mlx5_core_create_mkey_cb(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_mkey *mkey,\r\nu32 *in, int inlen,\r\nu32 *out, int outlen,\r\nmlx5_cmd_cbk_t callback, void *context)\r\n{\r\nstruct mlx5_mkey_table *table = &dev->priv.mkey_table;\r\nu32 lout[MLX5_ST_SZ_DW(create_mkey_out)] = {0};\r\nu32 mkey_index;\r\nvoid *mkc;\r\nint err;\r\nu8 key;\r\nspin_lock_irq(&dev->priv.mkey_lock);\r\nkey = dev->priv.mkey_key++;\r\nspin_unlock_irq(&dev->priv.mkey_lock);\r\nmkc = MLX5_ADDR_OF(create_mkey_in, in, memory_key_mkey_entry);\r\nMLX5_SET(create_mkey_in, in, opcode, MLX5_CMD_OP_CREATE_MKEY);\r\nMLX5_SET(mkc, mkc, mkey_7_0, key);\r\nif (callback)\r\nreturn mlx5_cmd_exec_cb(dev, in, inlen, out, outlen,\r\ncallback, context);\r\nerr = mlx5_cmd_exec(dev, in, inlen, lout, sizeof(lout));\r\nif (err)\r\nreturn err;\r\nmkey_index = MLX5_GET(create_mkey_out, lout, mkey_index);\r\nmkey->iova = MLX5_GET64(mkc, mkc, start_addr);\r\nmkey->size = MLX5_GET64(mkc, mkc, len);\r\nmkey->key = mlx5_idx_to_mkey(mkey_index) | key;\r\nmkey->pd = MLX5_GET(mkc, mkc, pd);\r\nmlx5_core_dbg(dev, "out 0x%x, key 0x%x, mkey 0x%x\n",\r\nmkey_index, key, mkey->key);\r\nwrite_lock_irq(&table->lock);\r\nerr = radix_tree_insert(&table->tree, mlx5_base_mkey(mkey->key), mkey);\r\nwrite_unlock_irq(&table->lock);\r\nif (err) {\r\nmlx5_core_warn(dev, "failed radix tree insert of mkey 0x%x, %d\n",\r\nmlx5_base_mkey(mkey->key), err);\r\nmlx5_core_destroy_mkey(dev, mkey);\r\n}\r\nreturn err;\r\n}\r\nint mlx5_core_create_mkey(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_mkey *mkey,\r\nu32 *in, int inlen)\r\n{\r\nreturn mlx5_core_create_mkey_cb(dev, mkey, in, inlen,\r\nNULL, 0, NULL, NULL);\r\n}\r\nint mlx5_core_destroy_mkey(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_mkey *mkey)\r\n{\r\nstruct mlx5_mkey_table *table = &dev->priv.mkey_table;\r\nu32 out[MLX5_ST_SZ_DW(destroy_mkey_out)] = {0};\r\nu32 in[MLX5_ST_SZ_DW(destroy_mkey_in)] = {0};\r\nstruct mlx5_core_mkey *deleted_mkey;\r\nunsigned long flags;\r\nwrite_lock_irqsave(&table->lock, flags);\r\ndeleted_mkey = radix_tree_delete(&table->tree, mlx5_base_mkey(mkey->key));\r\nwrite_unlock_irqrestore(&table->lock, flags);\r\nif (!deleted_mkey) {\r\nmlx5_core_warn(dev, "failed radix tree delete of mkey 0x%x\n",\r\nmlx5_base_mkey(mkey->key));\r\nreturn -ENOENT;\r\n}\r\nMLX5_SET(destroy_mkey_in, in, opcode, MLX5_CMD_OP_DESTROY_MKEY);\r\nMLX5_SET(destroy_mkey_in, in, mkey_index, mlx5_mkey_to_idx(mkey->key));\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_query_mkey(struct mlx5_core_dev *dev, struct mlx5_core_mkey *mkey,\r\nu32 *out, int outlen)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(query_mkey_in)] = {0};\r\nmemset(out, 0, outlen);\r\nMLX5_SET(query_mkey_in, in, opcode, MLX5_CMD_OP_QUERY_MKEY);\r\nMLX5_SET(query_mkey_in, in, mkey_index, mlx5_mkey_to_idx(mkey->key));\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, outlen);\r\n}\r\nint mlx5_core_dump_fill_mkey(struct mlx5_core_dev *dev, struct mlx5_core_mkey *_mkey,\r\nu32 *mkey)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(query_special_contexts_out)] = {0};\r\nu32 in[MLX5_ST_SZ_DW(query_special_contexts_in)] = {0};\r\nint err;\r\nMLX5_SET(query_special_contexts_in, in, opcode,\r\nMLX5_CMD_OP_QUERY_SPECIAL_CONTEXTS);\r\nerr = mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\nif (!err)\r\n*mkey = MLX5_GET(query_special_contexts_out, out,\r\ndump_fill_mkey);\r\nreturn err;\r\n}\r\nstatic inline u32 mlx5_get_psv(u32 *out, int psv_index)\r\n{\r\nswitch (psv_index) {\r\ncase 1: return MLX5_GET(create_psv_out, out, psv1_index);\r\ncase 2: return MLX5_GET(create_psv_out, out, psv2_index);\r\ncase 3: return MLX5_GET(create_psv_out, out, psv3_index);\r\ndefault: return MLX5_GET(create_psv_out, out, psv0_index);\r\n}\r\n}\r\nint mlx5_core_create_psv(struct mlx5_core_dev *dev, u32 pdn,\r\nint npsvs, u32 *sig_index)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_psv_out)] = {0};\r\nu32 in[MLX5_ST_SZ_DW(create_psv_in)] = {0};\r\nint i, err;\r\nif (npsvs > MLX5_MAX_PSVS)\r\nreturn -EINVAL;\r\nMLX5_SET(create_psv_in, in, opcode, MLX5_CMD_OP_CREATE_PSV);\r\nMLX5_SET(create_psv_in, in, pd, pdn);\r\nMLX5_SET(create_psv_in, in, num_psv, npsvs);\r\nerr = mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nfor (i = 0; i < npsvs; i++)\r\nsig_index[i] = mlx5_get_psv(out, i);\r\nreturn err;\r\n}\r\nint mlx5_core_destroy_psv(struct mlx5_core_dev *dev, int psv_num)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(destroy_psv_out)] = {0};\r\nu32 in[MLX5_ST_SZ_DW(destroy_psv_in)] = {0};\r\nMLX5_SET(destroy_psv_in, in, opcode, MLX5_CMD_OP_DESTROY_PSV);\r\nMLX5_SET(destroy_psv_in, in, psvn, psv_num);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}

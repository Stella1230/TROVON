int tpm_read_log_acpi(struct tpm_chip *chip)\r\n{\r\nstruct acpi_tcpa *buff;\r\nacpi_status status;\r\nvoid __iomem *virt;\r\nu64 len, start;\r\nstruct tpm_bios_log *log;\r\nif (chip->flags & TPM_CHIP_FLAG_TPM2)\r\nreturn -ENODEV;\r\nlog = &chip->log;\r\nif (!chip->acpi_dev_handle)\r\nreturn -ENODEV;\r\nstatus = acpi_get_table(ACPI_SIG_TCPA, 1,\r\n(struct acpi_table_header **)&buff);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nswitch(buff->platform_class) {\r\ncase BIOS_SERVER:\r\nlen = buff->server.log_max_len;\r\nstart = buff->server.log_start_addr;\r\nbreak;\r\ncase BIOS_CLIENT:\r\ndefault:\r\nlen = buff->client.log_max_len;\r\nstart = buff->client.log_start_addr;\r\nbreak;\r\n}\r\nif (!len) {\r\ndev_warn(&chip->dev, "%s: TCPA log area empty\n", __func__);\r\nreturn -EIO;\r\n}\r\nlog->bios_event_log = kmalloc(len, GFP_KERNEL);\r\nif (!log->bios_event_log)\r\nreturn -ENOMEM;\r\nlog->bios_event_log_end = log->bios_event_log + len;\r\nvirt = acpi_os_map_iomem(start, len);\r\nif (!virt)\r\ngoto err;\r\nmemcpy_fromio(log->bios_event_log, virt, len);\r\nacpi_os_unmap_iomem(virt, len);\r\nreturn 0;\r\nerr:\r\nkfree(log->bios_event_log);\r\nlog->bios_event_log = NULL;\r\nreturn -EIO;\r\n}

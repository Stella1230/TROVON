static int sprd_hwspinlock_trylock(struct hwspinlock *lock)\r\n{\r\nstruct sprd_hwspinlock_dev *sprd_hwlock =\r\ndev_get_drvdata(lock->bank->dev);\r\nvoid __iomem *addr = lock->priv;\r\nint user_id, lock_id;\r\nif (!readl(addr))\r\nreturn 1;\r\nlock_id = hwlock_to_id(lock);\r\nuser_id = readl(sprd_hwlock->base + HWSPINLOCK_MASTERID(lock_id));\r\ndev_warn(sprd_hwlock->bank.dev,\r\n"hwspinlock [%d] lock failed and master/user id = %d!\n",\r\nlock_id, user_id);\r\nreturn 0;\r\n}\r\nstatic void sprd_hwspinlock_unlock(struct hwspinlock *lock)\r\n{\r\nvoid __iomem *lock_addr = lock->priv;\r\nwritel(HWSPINLOCK_NOTTAKEN, lock_addr);\r\n}\r\nstatic void sprd_hwspinlock_relax(struct hwspinlock *lock)\r\n{\r\nndelay(10);\r\n}\r\nstatic int sprd_hwspinlock_probe(struct platform_device *pdev)\r\n{\r\nstruct sprd_hwspinlock_dev *sprd_hwlock;\r\nstruct hwspinlock *lock;\r\nstruct resource *res;\r\nint i, ret;\r\nif (!pdev->dev.of_node)\r\nreturn -ENODEV;\r\nsprd_hwlock = devm_kzalloc(&pdev->dev,\r\nsizeof(struct sprd_hwspinlock_dev) +\r\nSPRD_HWLOCKS_NUM * sizeof(*lock),\r\nGFP_KERNEL);\r\nif (!sprd_hwlock)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nsprd_hwlock->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(sprd_hwlock->base))\r\nreturn PTR_ERR(sprd_hwlock->base);\r\nsprd_hwlock->clk = devm_clk_get(&pdev->dev, "enable");\r\nif (IS_ERR(sprd_hwlock->clk)) {\r\ndev_err(&pdev->dev, "get hwspinlock clock failed!\n");\r\nreturn PTR_ERR(sprd_hwlock->clk);\r\n}\r\nclk_prepare_enable(sprd_hwlock->clk);\r\nwritel(HWSPINLOCK_USER_BITS, sprd_hwlock->base + HWSPINLOCK_RECCTRL);\r\nfor (i = 0; i < SPRD_HWLOCKS_NUM; i++) {\r\nlock = &sprd_hwlock->bank.lock[i];\r\nlock->priv = sprd_hwlock->base + HWSPINLOCK_TOKEN(i);\r\n}\r\nplatform_set_drvdata(pdev, sprd_hwlock);\r\npm_runtime_enable(&pdev->dev);\r\nret = hwspin_lock_register(&sprd_hwlock->bank, &pdev->dev,\r\n&sprd_hwspinlock_ops, 0, SPRD_HWLOCKS_NUM);\r\nif (ret) {\r\npm_runtime_disable(&pdev->dev);\r\nclk_disable_unprepare(sprd_hwlock->clk);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sprd_hwspinlock_remove(struct platform_device *pdev)\r\n{\r\nstruct sprd_hwspinlock_dev *sprd_hwlock = platform_get_drvdata(pdev);\r\nhwspin_lock_unregister(&sprd_hwlock->bank);\r\npm_runtime_disable(&pdev->dev);\r\nclk_disable_unprepare(sprd_hwlock->clk);\r\nreturn 0;\r\n}\r\nstatic int __init sprd_hwspinlock_init(void)\r\n{\r\nreturn platform_driver_register(&sprd_hwspinlock_driver);\r\n}\r\nstatic void __exit sprd_hwspinlock_exit(void)\r\n{\r\nplatform_driver_unregister(&sprd_hwspinlock_driver);\r\n}

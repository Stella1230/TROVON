static int noinline arc_get_timer_clk(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nint ret;\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("timer missing clk\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\npr_err("Couldn't enable parent clk\n");\r\nreturn ret;\r\n}\r\narc_timer_freq = clk_get_rate(clk);\r\nreturn 0;\r\n}\r\nstatic u64 arc_read_gfrc(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 l, h;\r\nlocal_irq_save(flags);\r\n__mcip_cmd(CMD_GFRC_READ_LO, 0);\r\nl = read_aux_reg(ARC_REG_MCIP_READBACK);\r\n__mcip_cmd(CMD_GFRC_READ_HI, 0);\r\nh = read_aux_reg(ARC_REG_MCIP_READBACK);\r\nlocal_irq_restore(flags);\r\nreturn (((u64)h) << 32) | l;\r\n}\r\nstatic int __init arc_cs_setup_gfrc(struct device_node *node)\r\n{\r\nstruct mcip_bcr mp;\r\nint ret;\r\nREAD_BCR(ARC_REG_MCIP_BCR, mp);\r\nif (!mp.gfrc) {\r\npr_warn("Global-64-bit-Ctr clocksource not detected\n");\r\nreturn -ENXIO;\r\n}\r\nret = arc_get_timer_clk(node);\r\nif (ret)\r\nreturn ret;\r\nreturn clocksource_register_hz(&arc_counter_gfrc, arc_timer_freq);\r\n}\r\nstatic u64 arc_read_rtc(struct clocksource *cs)\r\n{\r\nunsigned long status;\r\nu32 l, h;\r\ndo {\r\nl = read_aux_reg(AUX_RTC_LOW);\r\nh = read_aux_reg(AUX_RTC_HIGH);\r\nstatus = read_aux_reg(AUX_RTC_CTRL);\r\n} while (!(status & _BITUL(31)));\r\nreturn (((u64)h) << 32) | l;\r\n}\r\nstatic int __init arc_cs_setup_rtc(struct device_node *node)\r\n{\r\nstruct bcr_timer timer;\r\nint ret;\r\nREAD_BCR(ARC_REG_TIMERS_BCR, timer);\r\nif (!timer.rtc) {\r\npr_warn("Local-64-bit-Ctr clocksource not detected\n");\r\nreturn -ENXIO;\r\n}\r\nif (IS_ENABLED(CONFIG_SMP)) {\r\npr_warn("Local-64-bit-Ctr not usable in SMP\n");\r\nreturn -EINVAL;\r\n}\r\nret = arc_get_timer_clk(node);\r\nif (ret)\r\nreturn ret;\r\nwrite_aux_reg(AUX_RTC_CTRL, 1);\r\nreturn clocksource_register_hz(&arc_counter_rtc, arc_timer_freq);\r\n}\r\nstatic u64 arc_read_timer1(struct clocksource *cs)\r\n{\r\nreturn (u64) read_aux_reg(ARC_REG_TIMER1_CNT);\r\n}\r\nstatic int __init arc_cs_setup_timer1(struct device_node *node)\r\n{\r\nint ret;\r\nif (IS_ENABLED(CONFIG_SMP))\r\nreturn -EINVAL;\r\nret = arc_get_timer_clk(node);\r\nif (ret)\r\nreturn ret;\r\nwrite_aux_reg(ARC_REG_TIMER1_LIMIT, ARC_TIMERN_MAX);\r\nwrite_aux_reg(ARC_REG_TIMER1_CNT, 0);\r\nwrite_aux_reg(ARC_REG_TIMER1_CTRL, TIMER_CTRL_NH);\r\nreturn clocksource_register_hz(&arc_counter_timer1, arc_timer_freq);\r\n}\r\nstatic void arc_timer_event_setup(unsigned int cycles)\r\n{\r\nwrite_aux_reg(ARC_REG_TIMER0_LIMIT, cycles);\r\nwrite_aux_reg(ARC_REG_TIMER0_CNT, 0);\r\nwrite_aux_reg(ARC_REG_TIMER0_CTRL, TIMER_CTRL_IE | TIMER_CTRL_NH);\r\n}\r\nstatic int arc_clkevent_set_next_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\narc_timer_event_setup(delta);\r\nreturn 0;\r\n}\r\nstatic int arc_clkevent_set_periodic(struct clock_event_device *dev)\r\n{\r\narc_timer_event_setup(arc_timer_freq / HZ);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t timer_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = this_cpu_ptr(&arc_clockevent_device);\r\nint irq_reenable = clockevent_state_periodic(evt);\r\nwrite_aux_reg(ARC_REG_TIMER0_CTRL, irq_reenable | TIMER_CTRL_NH);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int arc_timer_starting_cpu(unsigned int cpu)\r\n{\r\nstruct clock_event_device *evt = this_cpu_ptr(&arc_clockevent_device);\r\nevt->cpumask = cpumask_of(smp_processor_id());\r\nclockevents_config_and_register(evt, arc_timer_freq, 0, ARC_TIMERN_MAX);\r\nenable_percpu_irq(arc_timer_irq, 0);\r\nreturn 0;\r\n}\r\nstatic int arc_timer_dying_cpu(unsigned int cpu)\r\n{\r\ndisable_percpu_irq(arc_timer_irq);\r\nreturn 0;\r\n}\r\nstatic int __init arc_clockevent_setup(struct device_node *node)\r\n{\r\nstruct clock_event_device *evt = this_cpu_ptr(&arc_clockevent_device);\r\nint ret;\r\narc_timer_irq = irq_of_parse_and_map(node, 0);\r\nif (arc_timer_irq <= 0) {\r\npr_err("clockevent: missing irq\n");\r\nreturn -EINVAL;\r\n}\r\nret = arc_get_timer_clk(node);\r\nif (ret) {\r\npr_err("clockevent: missing clk\n");\r\nreturn ret;\r\n}\r\nret = request_percpu_irq(arc_timer_irq, timer_irq_handler,\r\n"Timer0 (per-cpu-tick)", evt);\r\nif (ret) {\r\npr_err("clockevent: unable to request irq\n");\r\nreturn ret;\r\n}\r\nret = cpuhp_setup_state(CPUHP_AP_ARC_TIMER_STARTING,\r\n"clockevents/arc/timer:starting",\r\narc_timer_starting_cpu,\r\narc_timer_dying_cpu);\r\nif (ret) {\r\npr_err("Failed to setup hotplug state\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init arc_of_timer_init(struct device_node *np)\r\n{\r\nstatic int init_count = 0;\r\nint ret;\r\nif (!init_count) {\r\ninit_count = 1;\r\nret = arc_clockevent_setup(np);\r\n} else {\r\nret = arc_cs_setup_timer1(np);\r\n}\r\nreturn ret;\r\n}

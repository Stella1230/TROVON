static int lan88xx_phy_config_intr(struct phy_device *phydev)\r\n{\r\nint rc;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\r\nrc = phy_write(phydev, LAN88XX_INT_MASK, 0x7FFF);\r\nrc = phy_read(phydev, LAN88XX_INT_STS);\r\nrc = phy_write(phydev, LAN88XX_INT_MASK,\r\nLAN88XX_INT_MASK_MDINTPIN_EN_ |\r\nLAN88XX_INT_MASK_LINK_CHANGE_);\r\n} else {\r\nrc = phy_write(phydev, LAN88XX_INT_MASK, 0);\r\n}\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int lan88xx_phy_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint rc = phy_read(phydev, LAN88XX_INT_STS);\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int lan88xx_suspend(struct phy_device *phydev)\r\n{\r\nstruct lan88xx_priv *priv = phydev->priv;\r\nif (!priv->wolopts)\r\ngenphy_suspend(phydev);\r\nreturn 0;\r\n}\r\nstatic int lan88xx_probe(struct phy_device *phydev)\r\n{\r\nstruct device *dev = &phydev->mdio.dev;\r\nstruct lan88xx_priv *priv;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->wolopts = 0;\r\npriv->chip_id = phy_read_mmd(phydev, 3, LAN88XX_MMD3_CHIP_ID);\r\npriv->chip_rev = phy_read_mmd(phydev, 3, LAN88XX_MMD3_CHIP_REV);\r\nphydev->priv = priv;\r\nreturn 0;\r\n}\r\nstatic void lan88xx_remove(struct phy_device *phydev)\r\n{\r\nstruct device *dev = &phydev->mdio.dev;\r\nstruct lan88xx_priv *priv = phydev->priv;\r\nif (priv)\r\ndevm_kfree(dev, priv);\r\n}\r\nstatic int lan88xx_set_wol(struct phy_device *phydev,\r\nstruct ethtool_wolinfo *wol)\r\n{\r\nstruct lan88xx_priv *priv = phydev->priv;\r\npriv->wolopts = wol->wolopts;\r\nreturn 0;\r\n}\r\nstatic void lan88xx_set_mdix(struct phy_device *phydev)\r\n{\r\nint buf;\r\nint val;\r\nswitch (phydev->mdix_ctrl) {\r\ncase ETH_TP_MDI:\r\nval = LAN88XX_EXT_MODE_CTRL_MDI_;\r\nbreak;\r\ncase ETH_TP_MDI_X:\r\nval = LAN88XX_EXT_MODE_CTRL_MDI_X_;\r\nbreak;\r\ncase ETH_TP_MDI_AUTO:\r\nval = LAN88XX_EXT_MODE_CTRL_AUTO_MDIX_;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nphy_write(phydev, LAN88XX_EXT_PAGE_ACCESS, LAN88XX_EXT_PAGE_SPACE_1);\r\nbuf = phy_read(phydev, LAN88XX_EXT_MODE_CTRL);\r\nbuf &= ~LAN88XX_EXT_MODE_CTRL_MDIX_MASK_;\r\nbuf |= val;\r\nphy_write(phydev, LAN88XX_EXT_MODE_CTRL, buf);\r\nphy_write(phydev, LAN88XX_EXT_PAGE_ACCESS, LAN88XX_EXT_PAGE_SPACE_0);\r\n}\r\nstatic int lan88xx_config_aneg(struct phy_device *phydev)\r\n{\r\nlan88xx_set_mdix(phydev);\r\nreturn genphy_config_aneg(phydev);\r\n}

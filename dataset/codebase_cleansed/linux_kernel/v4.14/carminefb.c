static int carmine_find_mode(const struct fb_var_screeninfo *var)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(car_modes); i++)\r\nif (car_modes[i].hdp == var->xres &&\r\ncar_modes[i].vdp == var->yres)\r\nreturn i;\r\nreturn -EINVAL;\r\n}\r\nstatic void c_set_disp_reg(const struct carmine_fb *par,\r\nu32 offset, u32 val)\r\n{\r\nwritel(val, par->display_reg + offset);\r\n}\r\nstatic u32 c_get_disp_reg(const struct carmine_fb *par,\r\nu32 offset)\r\n{\r\nreturn readl(par->display_reg + offset);\r\n}\r\nstatic void c_set_hw_reg(const struct carmine_hw *hw,\r\nu32 offset, u32 val)\r\n{\r\nwritel(val, hw->v_regs + offset);\r\n}\r\nstatic u32 c_get_hw_reg(const struct carmine_hw *hw,\r\nu32 offset)\r\n{\r\nreturn readl(hw->v_regs + offset);\r\n}\r\nstatic int carmine_setcolreg(unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp, struct fb_info *info)\r\n{\r\nif (regno >= 16)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\ntransp >>= 8;\r\n((__be32 *)info->pseudo_palette)[regno] = cpu_to_be32(transp << 24 |\r\nred << 0 | green << 8 | blue << 16);\r\nreturn 0;\r\n}\r\nstatic int carmine_check_var(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nint ret;\r\nret = carmine_find_mode(var);\r\nif (ret < 0)\r\nreturn ret;\r\nif (var->grayscale || var->rotate || var->nonstd)\r\nreturn -EINVAL;\r\nvar->xres_virtual = var->xres;\r\nvar->yres_virtual = var->yres;\r\nvar->bits_per_pixel = 32;\r\n#ifdef __BIG_ENDIAN\r\nvar->transp.offset = 24;\r\nvar->red.offset = 0;\r\nvar->green.offset = 8;\r\nvar->blue.offset = 16;\r\n#else\r\nvar->transp.offset = 24;\r\nvar->red.offset = 16;\r\nvar->green.offset = 8;\r\nvar->blue.offset = 0;\r\n#endif\r\nvar->red.length = 8;\r\nvar->green.length = 8;\r\nvar->blue.length = 8;\r\nvar->transp.length = 8;\r\nvar->red.msb_right = 0;\r\nvar->green.msb_right = 0;\r\nvar->blue.msb_right = 0;\r\nvar->transp.msb_right = 0;\r\nreturn 0;\r\n}\r\nstatic void carmine_init_display_param(struct carmine_fb *par)\r\n{\r\nu32 width;\r\nu32 height;\r\nu32 param;\r\nu32 window_size;\r\nu32 soffset = par->smem_offset;\r\nc_set_disp_reg(par, CARMINE_DISP_REG_C_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_MLMR_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_CURSOR_MODE,\r\nCARMINE_CURSOR0_PRIORITY_MASK |\r\nCARMINE_CURSOR1_PRIORITY_MASK |\r\nCARMINE_CURSOR_CUTZ_MASK);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_CUR1_POS, 0 << 16 | 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_CUR2_POS, 0 << 16 | 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_EXT_MODE, CARMINE_WINDOW_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_EXT_MODE,\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_EXT_MODE, CARMINE_EXTEND_MODE |\r\nCARMINE_EXT_CMODE_DIRECT24_RGBA);\r\nwidth = par->res->hdp * 4 / CARMINE_DISP_WIDTH_UNIT;\r\nwidth = width << CARMINE_DISP_WIDTH_SHIFT;\r\nheight = par->res->vdp - 1;\r\nparam = width | height;\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIDTH, width);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_MODE_W_H, param);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_MODE_W_H, param);\r\nwindow_size = (par->res->vdp - 1) << CARMINE_DISP_WIN_H_SHIFT;\r\nwindow_size |= par->res->hdp;\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_WIN_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_WIN_SIZE, window_size);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_ORG_ADR, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_ORG_ADR, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_ORG_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_DISP_ADR, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_DISP_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_DISP_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_DISP_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_DISP_ADR1, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_DISP_ADR0, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_DISP_ADR0, soffset);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_DISP_POS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L0, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L1, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L2, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L3, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L4, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L5, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L6, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_BLEND_MODE_L7, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L1_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7_TRANS, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7RM, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7PX, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L0PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L2PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L3PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L4PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L5PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L6PY, 0);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_L7PY, 0);\r\n}\r\nstatic void set_display_parameters(struct carmine_fb *par)\r\n{\r\nu32 mode;\r\nu32 hdp, vdp, htp, hsp, hsw, vtr, vsp, vsw;\r\nhdp = par->res->hdp - 1;\r\nvdp = par->res->vdp - 1;\r\nhtp = par->res->htp - 1;\r\nhsp = par->res->hsp - 1;\r\nhsw = par->res->hsw - 1;\r\nvtr = par->res->vtr - 1;\r\nvsp = par->res->vsp - 1;\r\nvsw = par->res->vsw - 1;\r\nc_set_disp_reg(par, CARMINE_DISP_REG_H_TOTAL,\r\nhtp << CARMINE_DISP_HTP_SHIFT);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_H_PERIOD,\r\n(hdp << CARMINE_DISP_HDB_SHIFT) | hdp);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_V_H_W_H_POS,\r\n(vsw << CARMINE_DISP_VSW_SHIFT) |\r\n(hsw << CARMINE_DISP_HSW_SHIFT) |\r\n(hsp));\r\nc_set_disp_reg(par, CARMINE_DISP_REG_V_TOTAL,\r\nvtr << CARMINE_DISP_VTR_SHIFT);\r\nc_set_disp_reg(par, CARMINE_DISP_REG_V_PERIOD_POS,\r\n(vdp << CARMINE_DISP_VDP_SHIFT) | vsp);\r\nmode = c_get_disp_reg(par, CARMINE_DISP_REG_DCM1);\r\nmode = (mode & ~CARMINE_DISP_DCM_MASK) |\r\n(par->res->disp_mode & CARMINE_DISP_DCM_MASK);\r\nmode |= CARMINE_DEN | CARMINE_L0E;\r\nc_set_disp_reg(par, CARMINE_DISP_REG_DCM1, mode);\r\n}\r\nstatic int carmine_set_par(struct fb_info *info)\r\n{\r\nstruct carmine_fb *par = info->par;\r\nint ret;\r\nret = carmine_find_mode(&info->var);\r\nif (ret < 0)\r\nreturn ret;\r\npar->new_mode = ret;\r\nif (par->cur_mode != par->new_mode) {\r\npar->cur_mode = par->new_mode;\r\npar->res = &car_modes[par->new_mode];\r\ncarmine_init_display_param(par);\r\nset_display_parameters(par);\r\n}\r\ninfo->fix.line_length = info->var.xres * info->var.bits_per_pixel / 8;\r\nreturn 0;\r\n}\r\nstatic int init_hardware(struct carmine_hw *hw)\r\n{\r\nu32 flags;\r\nu32 loops;\r\nu32 ret;\r\nc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE,\r\nCARMINE_DFLT_IP_CLOCK_ENABLE);\r\nc_set_hw_reg(hw, CARMINE_DISP0_REG + CARMINE_DISP_REG_DCM1, 0);\r\nc_set_hw_reg(hw, CARMINE_DISP1_REG + CARMINE_DISP_REG_DCM1, 0);\r\nc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_SOFTWARE_RESET, 1);\r\nc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_SOFTWARE_RESET, 0);\r\nflags = CARMINE_DFLT_IP_DCTL_IO_CONT1 << 16 |\r\nCARMINE_DFLT_IP_DCTL_IO_CONT0;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_IOCONT1_IOCONT0,\r\nflags);\r\nflags = CARMINE_DFLT_IP_DCTL_MODE << 16 | CARMINE_DFLT_IP_DCTL_ADD;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_MODE_ADD,\r\nflags);\r\nflags = CARMINE_DFLT_IP_DCTL_SET_TIME1 << 16 |\r\nCARMINE_DFLT_IP_DCTL_EMODE;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_SETTIME1_EMODE,\r\nflags);\r\nflags = CARMINE_DFLT_IP_DCTL_REFRESH << 16 |\r\nCARMINE_DFLT_IP_DCTL_SET_TIME2;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_REFRESH_SETTIME2,\r\nflags);\r\nflags = CARMINE_DFLT_IP_DCTL_RESERVE2 << 16 |\r\nCARMINE_DFLT_IP_DCTL_FIFO_DEPTH;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV2_RSV1, flags);\r\nflags = CARMINE_DFLT_IP_DCTL_DDRIF2 << 16 | CARMINE_DFLT_IP_DCTL_DDRIF1;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_DDRIF2_DDRIF1,\r\nflags);\r\nflags = CARMINE_DFLT_IP_DCTL_RESERVE0 << 16 |\r\nCARMINE_DFLT_IP_DCTL_STATES;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV0_STATES,\r\nflags);\r\nif (CARMINE_DCTL_DLL_RESET) {\r\nfor (loops = 0; loops < CARMINE_DCTL_INIT_WAIT_LIMIT; loops++) {\r\nret = c_get_hw_reg(hw, CARMINE_DCTL_REG +\r\nCARMINE_DCTL_REG_RSV0_STATES);\r\nret &= CARMINE_DCTL_REG_STATES_MASK;\r\nif (!ret)\r\nbreak;\r\nmdelay(CARMINE_DCTL_INIT_WAIT_INTERVAL);\r\n}\r\nif (loops >= CARMINE_DCTL_INIT_WAIT_LIMIT) {\r\nprintk(KERN_ERR "DRAM init failed\n");\r\nreturn -EIO;\r\n}\r\n}\r\nflags = CARMINE_DFLT_IP_DCTL_MODE_AFT_RST << 16 |\r\nCARMINE_DFLT_IP_DCTL_ADD;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_MODE_ADD, flags);\r\nflags = CARMINE_DFLT_IP_DCTL_RESERVE0 << 16 |\r\nCARMINE_DFLT_IP_DCTL_STATES_AFT_RST;\r\nc_set_hw_reg(hw, CARMINE_DCTL_REG + CARMINE_DCTL_REG_RSV0_STATES,\r\nflags);\r\nc_set_hw_reg(hw, CARMINE_WB_REG + CARMINE_WB_REG_WBM,\r\nCARMINE_WB_REG_WBM_DEFAULT);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_VRINTM, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_VRERRM, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_PX, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_PY, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_LX, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_LY, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_TX, 0);\r\nc_set_hw_reg(hw, CARMINE_GRAPH_REG + CARMINE_GRAPH_REG_DC_OFFSET_TY, 0);\r\nreturn 0;\r\n}\r\nstatic int alloc_carmine_fb(void __iomem *regs, void __iomem *smem_base,\r\nint smem_offset, struct device *device,\r\nstruct fb_info **rinfo)\r\n{\r\nint ret;\r\nstruct fb_info *info;\r\nstruct carmine_fb *par;\r\ninfo = framebuffer_alloc(sizeof *par, device);\r\nif (!info)\r\nreturn -ENOMEM;\r\npar = info->par;\r\npar->display_reg = regs;\r\npar->smem_offset = smem_offset;\r\ninfo->screen_base = smem_base + smem_offset;\r\ninfo->screen_size = CARMINE_DISPLAY_MEM;\r\ninfo->fbops = &carminefb_ops;\r\ninfo->fix = carminefb_fix;\r\ninfo->pseudo_palette = par->pseudo_palette;\r\ninfo->flags = FBINFO_DEFAULT;\r\nret = fb_alloc_cmap(&info->cmap, 256, 1);\r\nif (ret < 0)\r\ngoto err_free_fb;\r\nif (fb_mode >= ARRAY_SIZE(carmine_modedb))\r\nfb_mode = CARMINEFB_DEFAULT_VIDEO_MODE;\r\npar->cur_mode = par->new_mode = ~0;\r\nret = fb_find_mode(&info->var, info, fb_mode_str, carmine_modedb,\r\nARRAY_SIZE(carmine_modedb),\r\n&carmine_modedb[fb_mode], 32);\r\nif (!ret || ret == 4) {\r\nret = -EINVAL;\r\ngoto err_dealloc_cmap;\r\n}\r\nfb_videomode_to_modelist(carmine_modedb, ARRAY_SIZE(carmine_modedb),\r\n&info->modelist);\r\nret = register_framebuffer(info);\r\nif (ret < 0)\r\ngoto err_dealloc_cmap;\r\nfb_info(info, "%s frame buffer device\n", info->fix.id);\r\n*rinfo = info;\r\nreturn 0;\r\nerr_dealloc_cmap:\r\nfb_dealloc_cmap(&info->cmap);\r\nerr_free_fb:\r\nframebuffer_release(info);\r\nreturn ret;\r\n}\r\nstatic void cleanup_fb_device(struct fb_info *info)\r\n{\r\nif (info) {\r\nunregister_framebuffer(info);\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\n}\r\n}\r\nstatic int carminefb_probe(struct pci_dev *dev, const struct pci_device_id *ent)\r\n{\r\nstruct carmine_hw *hw;\r\nstruct device *device = &dev->dev;\r\nstruct fb_info *info;\r\nint ret;\r\nret = pci_enable_device(dev);\r\nif (ret)\r\nreturn ret;\r\nret = -ENOMEM;\r\nhw = kzalloc(sizeof *hw, GFP_KERNEL);\r\nif (!hw)\r\ngoto err_enable_pci;\r\ncarminefb_fix.mmio_start = pci_resource_start(dev, CARMINE_CONFIG_BAR);\r\ncarminefb_fix.mmio_len = pci_resource_len(dev, CARMINE_CONFIG_BAR);\r\nif (!request_mem_region(carminefb_fix.mmio_start,\r\ncarminefb_fix.mmio_len,\r\n"carminefb regbase")) {\r\nprintk(KERN_ERR "carminefb: Can't reserve regbase.\n");\r\nret = -EBUSY;\r\ngoto err_free_hw;\r\n}\r\nhw->v_regs = ioremap_nocache(carminefb_fix.mmio_start,\r\ncarminefb_fix.mmio_len);\r\nif (!hw->v_regs) {\r\nprintk(KERN_ERR "carminefb: Can't remap %s register.\n",\r\ncarminefb_fix.id);\r\ngoto err_free_reg_mmio;\r\n}\r\ncarminefb_fix.smem_start = pci_resource_start(dev, CARMINE_MEMORY_BAR);\r\ncarminefb_fix.smem_len = pci_resource_len(dev, CARMINE_MEMORY_BAR);\r\nif (carminefb_fix.smem_len > CARMINE_TOTAL_DIPLAY_MEM)\r\ncarminefb_fix.smem_len = CARMINE_TOTAL_DIPLAY_MEM;\r\nelse if (carminefb_fix.smem_len < CARMINE_TOTAL_DIPLAY_MEM) {\r\nprintk(KERN_ERR "carminefb: Memory bar is only %d bytes, %d "\r\n"are required.", carminefb_fix.smem_len,\r\nCARMINE_TOTAL_DIPLAY_MEM);\r\ngoto err_unmap_vregs;\r\n}\r\nif (!request_mem_region(carminefb_fix.smem_start,\r\ncarminefb_fix.smem_len, "carminefb smem")) {\r\nprintk(KERN_ERR "carminefb: Can't reserve smem.\n");\r\ngoto err_unmap_vregs;\r\n}\r\nhw->screen_mem = ioremap_nocache(carminefb_fix.smem_start,\r\ncarminefb_fix.smem_len);\r\nif (!hw->screen_mem) {\r\nprintk(KERN_ERR "carmine: Can't ioremap smem area.\n");\r\ngoto err_reg_smem;\r\n}\r\nret = init_hardware(hw);\r\nif (ret)\r\ngoto err_unmap_screen;\r\ninfo = NULL;\r\nif (fb_displays & CARMINE_USE_DISPLAY0) {\r\nret = alloc_carmine_fb(hw->v_regs + CARMINE_DISP0_REG,\r\nhw->screen_mem, CARMINE_DISPLAY_MEM * 0,\r\ndevice, &info);\r\nif (ret)\r\ngoto err_deinit_hw;\r\n}\r\nhw->fb[0] = info;\r\ninfo = NULL;\r\nif (fb_displays & CARMINE_USE_DISPLAY1) {\r\nret = alloc_carmine_fb(hw->v_regs + CARMINE_DISP1_REG,\r\nhw->screen_mem, CARMINE_DISPLAY_MEM * 1,\r\ndevice, &info);\r\nif (ret)\r\ngoto err_cleanup_fb0;\r\n}\r\nhw->fb[1] = info;\r\ninfo = NULL;\r\npci_set_drvdata(dev, hw);\r\nreturn 0;\r\nerr_cleanup_fb0:\r\ncleanup_fb_device(hw->fb[0]);\r\nerr_deinit_hw:\r\nc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE, 0);\r\nerr_unmap_screen:\r\niounmap(hw->screen_mem);\r\nerr_reg_smem:\r\nrelease_mem_region(carminefb_fix.smem_start, carminefb_fix.smem_len);\r\nerr_unmap_vregs:\r\niounmap(hw->v_regs);\r\nerr_free_reg_mmio:\r\nrelease_mem_region(carminefb_fix.mmio_start, carminefb_fix.mmio_len);\r\nerr_free_hw:\r\nkfree(hw);\r\nerr_enable_pci:\r\npci_disable_device(dev);\r\nreturn ret;\r\n}\r\nstatic void carminefb_remove(struct pci_dev *dev)\r\n{\r\nstruct carmine_hw *hw = pci_get_drvdata(dev);\r\nstruct fb_fix_screeninfo fix;\r\nint i;\r\nif (hw->fb[0])\r\nfix = hw->fb[0]->fix;\r\nelse\r\nfix = hw->fb[1]->fix;\r\nc_set_hw_reg(hw, CARMINE_DISP0_REG + CARMINE_DISP_REG_DCM1, 0);\r\nc_set_hw_reg(hw, CARMINE_DISP1_REG + CARMINE_DISP_REG_DCM1, 0);\r\nc_set_hw_reg(hw, CARMINE_CTL_REG + CARMINE_CTL_REG_CLOCK_ENABLE, 0);\r\nfor (i = 0; i < MAX_DISPLAY; i++)\r\ncleanup_fb_device(hw->fb[i]);\r\niounmap(hw->screen_mem);\r\nrelease_mem_region(fix.smem_start, fix.smem_len);\r\niounmap(hw->v_regs);\r\nrelease_mem_region(fix.mmio_start, fix.mmio_len);\r\npci_disable_device(dev);\r\nkfree(hw);\r\n}\r\nstatic int __init carminefb_init(void)\r\n{\r\nif (!(fb_displays &\r\n(CARMINE_USE_DISPLAY0 | CARMINE_USE_DISPLAY1))) {\r\nprintk(KERN_ERR "If you disable both displays than you don't "\r\n"need the driver at all\n");\r\nreturn -EINVAL;\r\n}\r\nreturn pci_register_driver(&carmine_pci_driver);\r\n}\r\nstatic void __exit carminefb_cleanup(void)\r\n{\r\npci_unregister_driver(&carmine_pci_driver);\r\n}

static void ccu_nkmp_find_best(unsigned long parent, unsigned long rate,\r\nstruct _ccu_nkmp *nkmp)\r\n{\r\nunsigned long best_rate = 0;\r\nunsigned long best_n = 0, best_k = 0, best_m = 0, best_p = 0;\r\nunsigned long _n, _k, _m, _p;\r\nfor (_k = nkmp->min_k; _k <= nkmp->max_k; _k++) {\r\nfor (_n = nkmp->min_n; _n <= nkmp->max_n; _n++) {\r\nfor (_m = nkmp->min_m; _m <= nkmp->max_m; _m++) {\r\nfor (_p = nkmp->min_p; _p <= nkmp->max_p; _p <<= 1) {\r\nunsigned long tmp_rate;\r\ntmp_rate = parent * _n * _k / (_m * _p);\r\nif (tmp_rate > rate)\r\ncontinue;\r\nif ((rate - tmp_rate) < (rate - best_rate)) {\r\nbest_rate = tmp_rate;\r\nbest_n = _n;\r\nbest_k = _k;\r\nbest_m = _m;\r\nbest_p = _p;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nnkmp->n = best_n;\r\nnkmp->k = best_k;\r\nnkmp->m = best_m;\r\nnkmp->p = best_p;\r\n}\r\nstatic void ccu_nkmp_disable(struct clk_hw *hw)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nreturn ccu_gate_helper_disable(&nkmp->common, nkmp->enable);\r\n}\r\nstatic int ccu_nkmp_enable(struct clk_hw *hw)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nreturn ccu_gate_helper_enable(&nkmp->common, nkmp->enable);\r\n}\r\nstatic int ccu_nkmp_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nreturn ccu_gate_helper_is_enabled(&nkmp->common, nkmp->enable);\r\n}\r\nstatic unsigned long ccu_nkmp_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nunsigned long n, m, k, p;\r\nu32 reg;\r\nreg = readl(nkmp->common.base + nkmp->common.reg);\r\nn = reg >> nkmp->n.shift;\r\nn &= (1 << nkmp->n.width) - 1;\r\nn += nkmp->n.offset;\r\nif (!n)\r\nn++;\r\nk = reg >> nkmp->k.shift;\r\nk &= (1 << nkmp->k.width) - 1;\r\nk += nkmp->k.offset;\r\nif (!k)\r\nk++;\r\nm = reg >> nkmp->m.shift;\r\nm &= (1 << nkmp->m.width) - 1;\r\nm += nkmp->m.offset;\r\nif (!m)\r\nm++;\r\np = reg >> nkmp->p.shift;\r\np &= (1 << nkmp->p.width) - 1;\r\nreturn (parent_rate * n * k >> p) / m;\r\n}\r\nstatic long ccu_nkmp_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nstruct _ccu_nkmp _nkmp;\r\n_nkmp.min_n = nkmp->n.min ?: 1;\r\n_nkmp.max_n = nkmp->n.max ?: 1 << nkmp->n.width;\r\n_nkmp.min_k = nkmp->k.min ?: 1;\r\n_nkmp.max_k = nkmp->k.max ?: 1 << nkmp->k.width;\r\n_nkmp.min_m = 1;\r\n_nkmp.max_m = nkmp->m.max ?: 1 << nkmp->m.width;\r\n_nkmp.min_p = 1;\r\n_nkmp.max_p = nkmp->p.max ?: 1 << ((1 << nkmp->p.width) - 1);\r\nccu_nkmp_find_best(*parent_rate, rate, &_nkmp);\r\nreturn *parent_rate * _nkmp.n * _nkmp.k / (_nkmp.m * _nkmp.p);\r\n}\r\nstatic int ccu_nkmp_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\r\nstruct _ccu_nkmp _nkmp;\r\nunsigned long flags;\r\nu32 reg;\r\n_nkmp.min_n = nkmp->n.min ?: 1;\r\n_nkmp.max_n = nkmp->n.max ?: 1 << nkmp->n.width;\r\n_nkmp.min_k = nkmp->k.min ?: 1;\r\n_nkmp.max_k = nkmp->k.max ?: 1 << nkmp->k.width;\r\n_nkmp.min_m = 1;\r\n_nkmp.max_m = nkmp->m.max ?: 1 << nkmp->m.width;\r\n_nkmp.min_p = 1;\r\n_nkmp.max_p = nkmp->p.max ?: 1 << ((1 << nkmp->p.width) - 1);\r\nccu_nkmp_find_best(parent_rate, rate, &_nkmp);\r\nspin_lock_irqsave(nkmp->common.lock, flags);\r\nreg = readl(nkmp->common.base + nkmp->common.reg);\r\nreg &= ~GENMASK(nkmp->n.width + nkmp->n.shift - 1, nkmp->n.shift);\r\nreg &= ~GENMASK(nkmp->k.width + nkmp->k.shift - 1, nkmp->k.shift);\r\nreg &= ~GENMASK(nkmp->m.width + nkmp->m.shift - 1, nkmp->m.shift);\r\nreg &= ~GENMASK(nkmp->p.width + nkmp->p.shift - 1, nkmp->p.shift);\r\nreg |= (_nkmp.n - nkmp->n.offset) << nkmp->n.shift;\r\nreg |= (_nkmp.k - nkmp->k.offset) << nkmp->k.shift;\r\nreg |= (_nkmp.m - nkmp->m.offset) << nkmp->m.shift;\r\nreg |= ilog2(_nkmp.p) << nkmp->p.shift;\r\nwritel(reg, nkmp->common.base + nkmp->common.reg);\r\nspin_unlock_irqrestore(nkmp->common.lock, flags);\r\nccu_helper_wait_for_lock(&nkmp->common, nkmp->lock);\r\nreturn 0;\r\n}

static int ahci_dm816_get_mpy_bits(unsigned long refclk_rate)\r\n{\r\nunsigned long pll_multiplier;\r\nint i;\r\npll_multiplier = AHCI_DM816_PLL_OUT / (refclk_rate / 100);\r\nfor (i = 0; i < ARRAY_SIZE(pll_mpy_table); i++) {\r\nif (pll_mpy_table[i] == pll_multiplier)\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nstatic int ahci_dm816_phy_init(struct ahci_host_priv *hpriv, struct device *dev)\r\n{\r\nunsigned long refclk_rate;\r\nint mpy;\r\nu32 val;\r\nif (!hpriv->clks[1]) {\r\ndev_err(dev, "reference clock not supplied\n");\r\nreturn -EINVAL;\r\n}\r\nrefclk_rate = clk_get_rate(hpriv->clks[1]);\r\nif ((refclk_rate % 100) != 0) {\r\ndev_err(dev, "reference clock rate must be divisible by 100\n");\r\nreturn -EINVAL;\r\n}\r\nmpy = ahci_dm816_get_mpy_bits(refclk_rate);\r\nif (mpy < 0) {\r\ndev_err(dev, "can't calculate the MPY bits value\n");\r\nreturn -EINVAL;\r\n}\r\nval = AHCI_DM816_PHY_MPY(mpy) | AHCI_DM816_PHY_LOS(1) |\r\nAHCI_DM816_PHY_RXCDR(4) | AHCI_DM816_PHY_RXEQ(1) |\r\nAHCI_DM816_PHY_TXSWING(3) | AHCI_DM816_PHY_ENPLL(1);\r\nwritel(val, hpriv->mmio + AHCI_DM816_P0PHYCR_REG);\r\nval = AHCI_DM816_PHY_LOS(1) | AHCI_DM816_PHY_RXCDR(4) |\r\nAHCI_DM816_PHY_RXEQ(1) | AHCI_DM816_PHY_TXSWING(3);\r\nwritel(val, hpriv->mmio + AHCI_DM816_P1PHYCR_REG);\r\nreturn 0;\r\n}\r\nstatic int ahci_dm816_softreset(struct ata_link *link,\r\nunsigned int *class, unsigned long deadline)\r\n{\r\nint pmp, ret;\r\npmp = sata_srst_pmp(link);\r\nret = ahci_do_softreset(link, class, pmp, deadline, ahci_check_ready);\r\nif (pmp && ret == -EBUSY)\r\nreturn ahci_do_softreset(link, class, 0,\r\ndeadline, ahci_check_ready);\r\nreturn ret;\r\n}\r\nstatic int ahci_dm816_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ahci_host_priv *hpriv;\r\nint rc;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nrc = ahci_dm816_phy_init(hpriv, dev);\r\nif (rc)\r\ngoto disable_resources;\r\nrc = ahci_platform_init_host(pdev, hpriv,\r\n&ahci_dm816_port_info,\r\n&ahci_dm816_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

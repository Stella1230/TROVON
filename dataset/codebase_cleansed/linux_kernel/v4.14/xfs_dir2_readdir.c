static unsigned char\r\nxfs_dir3_get_dtype(\r\nstruct xfs_mount *mp,\r\nuint8_t filetype)\r\n{\r\nif (!xfs_sb_version_hasftype(&mp->m_sb))\r\nreturn DT_UNKNOWN;\r\nif (filetype >= XFS_DIR3_FT_MAX)\r\nreturn DT_UNKNOWN;\r\nreturn xfs_dir3_filetype_table[filetype];\r\n}\r\nSTATIC int\r\nxfs_dir2_sf_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx)\r\n{\r\nint i;\r\nstruct xfs_inode *dp = args->dp;\r\nxfs_dir2_dataptr_t off;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nxfs_dir2_dataptr_t dot_offset;\r\nxfs_dir2_dataptr_t dotdot_offset;\r\nxfs_ino_t ino;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\r\nreturn 0;\r\ndot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\ndp->d_ops->data_dot_offset);\r\ndotdot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\ndp->d_ops->data_dotdot_offset);\r\nif (ctx->pos <= dot_offset) {\r\nctx->pos = dot_offset & 0x7fffffff;\r\nif (!dir_emit(ctx, ".", 1, dp->i_ino, DT_DIR))\r\nreturn 0;\r\n}\r\nif (ctx->pos <= dotdot_offset) {\r\nino = dp->d_ops->sf_get_parent_ino(sfp);\r\nctx->pos = dotdot_offset & 0x7fffffff;\r\nif (!dir_emit(ctx, "..", 2, ino, DT_DIR))\r\nreturn 0;\r\n}\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nfor (i = 0; i < sfp->count; i++) {\r\nuint8_t filetype;\r\noff = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\nxfs_dir2_sf_get_offset(sfep));\r\nif (ctx->pos > off) {\r\nsfep = dp->d_ops->sf_nextentry(sfp, sfep);\r\ncontinue;\r\n}\r\nino = dp->d_ops->sf_get_ino(sfp, sfep);\r\nfiletype = dp->d_ops->sf_get_ftype(sfep);\r\nctx->pos = off & 0x7fffffff;\r\nif (!dir_emit(ctx, (char *)sfep->name, sfep->namelen, ino,\r\nxfs_dir3_get_dtype(dp->i_mount, filetype)))\r\nreturn 0;\r\nsfep = dp->d_ops->sf_nextentry(sfp, sfep);\r\n}\r\nctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\r\n0x7fffffff;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_dir2_block_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endptr;\r\nint error;\r\nchar *ptr;\r\nint wantoff;\r\nxfs_off_t cook;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nint lock_mode;\r\nif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\r\nreturn 0;\r\nlock_mode = xfs_ilock_data_map_shared(dp);\r\nerror = xfs_dir3_block_read(args->trans, dp, &bp);\r\nxfs_iunlock(dp, lock_mode);\r\nif (error)\r\nreturn error;\r\nwantoff = xfs_dir2_dataptr_to_off(geo, ctx->pos);\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nbtp = xfs_dir2_block_tail_p(geo, hdr);\r\nptr = (char *)dp->d_ops->data_entry_p(hdr);\r\nendptr = (char *)xfs_dir2_block_leaf_p(btp);\r\nwhile (ptr < endptr) {\r\nuint8_t filetype;\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nptr += be16_to_cpu(dup->length);\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nptr += dp->d_ops->data_entsize(dep->namelen);\r\nif ((char *)dep - (char *)hdr < wantoff)\r\ncontinue;\r\ncook = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\n(char *)dep - (char *)hdr);\r\nctx->pos = cook & 0x7fffffff;\r\nfiletype = dp->d_ops->data_get_ftype(dep);\r\nif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\r\nbe64_to_cpu(dep->inumber),\r\nxfs_dir3_get_dtype(dp->i_mount, filetype))) {\r\nxfs_trans_brelse(args->trans, bp);\r\nreturn 0;\r\n}\r\n}\r\nctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\r\n0x7fffffff;\r\nxfs_trans_brelse(args->trans, bp);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_dir2_leaf_readbuf(\r\nstruct xfs_da_args *args,\r\nsize_t bufsize,\r\nxfs_dir2_off_t *cur_off,\r\nxfs_dablk_t *ra_blk,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_buf *bp = NULL;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nstruct xfs_ifork *ifp = XFS_IFORK_PTR(dp, XFS_DATA_FORK);\r\nstruct xfs_bmbt_irec map;\r\nstruct blk_plug plug;\r\nxfs_dir2_off_t new_off;\r\nxfs_dablk_t next_ra;\r\nxfs_dablk_t map_off;\r\nxfs_dablk_t last_da;\r\nxfs_extnum_t idx;\r\nint ra_want;\r\nint error = 0;\r\nif (!(ifp->if_flags & XFS_IFEXTENTS)) {\r\nerror = xfs_iread_extents(args->trans, dp, XFS_DATA_FORK);\r\nif (error)\r\ngoto out;\r\n}\r\nlast_da = xfs_dir2_byte_to_da(geo, XFS_DIR2_LEAF_OFFSET);\r\nmap_off = xfs_dir2_db_to_da(geo, xfs_dir2_byte_to_db(geo, *cur_off));\r\nif (!xfs_iext_lookup_extent(dp, ifp, map_off, &idx, &map))\r\ngoto out;\r\nif (map.br_startoff >= last_da)\r\ngoto out;\r\nxfs_trim_extent(&map, map_off, last_da - map_off);\r\nnew_off = xfs_dir2_da_to_byte(geo, map.br_startoff);\r\nif (new_off > *cur_off)\r\n*cur_off = new_off;\r\nerror = xfs_dir3_data_read(args->trans, dp, map.br_startoff, -1, &bp);\r\nif (error)\r\ngoto out;\r\nra_want = howmany(bufsize + geo->blksize, (1 << geo->fsblog));\r\nif (*ra_blk >= last_da)\r\ngoto out;\r\nelse if (*ra_blk == 0)\r\n*ra_blk = map.br_startoff;\r\nnext_ra = map.br_startoff + geo->fsbcount;\r\nif (next_ra >= last_da)\r\ngoto out_no_ra;\r\nif (map.br_blockcount < geo->fsbcount &&\r\n!xfs_iext_get_extent(ifp, ++idx, &map))\r\ngoto out_no_ra;\r\nif (map.br_startoff >= last_da)\r\ngoto out_no_ra;\r\nxfs_trim_extent(&map, next_ra, last_da - next_ra);\r\nblk_start_plug(&plug);\r\nwhile (ra_want > 0) {\r\nnext_ra = roundup((xfs_dablk_t)map.br_startoff, geo->fsbcount);\r\nwhile (ra_want > 0 &&\r\nnext_ra < map.br_startoff + map.br_blockcount) {\r\nif (next_ra >= last_da) {\r\n*ra_blk = last_da;\r\nbreak;\r\n}\r\nif (next_ra > *ra_blk) {\r\nxfs_dir3_data_readahead(dp, next_ra, -2);\r\n*ra_blk = next_ra;\r\n}\r\nra_want -= geo->fsbcount;\r\nnext_ra += geo->fsbcount;\r\n}\r\nif (!xfs_iext_get_extent(ifp, ++idx, &map)) {\r\n*ra_blk = last_da;\r\nbreak;\r\n}\r\n}\r\nblk_finish_plug(&plug);\r\nout:\r\n*bpp = bp;\r\nreturn error;\r\nout_no_ra:\r\n*ra_blk = last_da;\r\ngoto out;\r\n}\r\nSTATIC int\r\nxfs_dir2_leaf_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx,\r\nsize_t bufsize)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_buf *bp = NULL;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *ptr = NULL;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nxfs_dablk_t rablk = 0;\r\nxfs_dir2_off_t curoff;\r\nint length;\r\nint byteoff;\r\nint lock_mode;\r\nint error = 0;\r\nif (ctx->pos >= XFS_DIR2_MAX_DATAPTR)\r\nreturn 0;\r\ncuroff = xfs_dir2_dataptr_to_byte(ctx->pos);\r\nwhile (curoff < XFS_DIR2_LEAF_OFFSET) {\r\nuint8_t filetype;\r\nif (!bp || ptr >= (char *)bp->b_addr + geo->blksize) {\r\nif (bp) {\r\nxfs_trans_brelse(args->trans, bp);\r\nbp = NULL;\r\n}\r\nlock_mode = xfs_ilock_data_map_shared(dp);\r\nerror = xfs_dir2_leaf_readbuf(args, bufsize, &curoff,\r\n&rablk, &bp);\r\nxfs_iunlock(dp, lock_mode);\r\nif (error || !bp)\r\nbreak;\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nptr = (char *)dp->d_ops->data_entry_p(hdr);\r\nbyteoff = xfs_dir2_byte_to_off(geo, curoff);\r\nif (byteoff == 0)\r\ncuroff += dp->d_ops->data_entry_offset;\r\nelse {\r\nwhile ((char *)ptr - (char *)hdr < byteoff) {\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag)\r\n== XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength =\r\ndp->d_ops->data_entsize(dep->namelen);\r\nptr += length;\r\n}\r\ncuroff =\r\nxfs_dir2_db_off_to_byte(geo,\r\nxfs_dir2_byte_to_db(geo, curoff),\r\n(char *)ptr - (char *)hdr);\r\nif (ptr >= (char *)hdr + geo->blksize) {\r\ncontinue;\r\n}\r\n}\r\n}\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncuroff += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength = dp->d_ops->data_entsize(dep->namelen);\r\nfiletype = dp->d_ops->data_get_ftype(dep);\r\nctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\r\nif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\r\nbe64_to_cpu(dep->inumber),\r\nxfs_dir3_get_dtype(dp->i_mount, filetype)))\r\nbreak;\r\nptr += length;\r\ncuroff += length;\r\nbufsize = bufsize > length ? bufsize - length : 0;\r\n}\r\nif (curoff > xfs_dir2_dataptr_to_byte(XFS_DIR2_MAX_DATAPTR))\r\nctx->pos = XFS_DIR2_MAX_DATAPTR & 0x7fffffff;\r\nelse\r\nctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\r\nif (bp)\r\nxfs_trans_brelse(args->trans, bp);\r\nreturn error;\r\n}\r\nint\r\nxfs_readdir(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nstruct dir_context *ctx,\r\nsize_t bufsize)\r\n{\r\nstruct xfs_da_args args = { NULL };\r\nint rval;\r\nint v;\r\ntrace_xfs_readdir(dp);\r\nif (XFS_FORCED_SHUTDOWN(dp->i_mount))\r\nreturn -EIO;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nXFS_STATS_INC(dp->i_mount, xs_dir_getdents);\r\nargs.dp = dp;\r\nargs.geo = dp->i_mount->m_dir_geo;\r\nargs.trans = tp;\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL)\r\nrval = xfs_dir2_sf_getdents(&args, ctx);\r\nelse if ((rval = xfs_dir2_isblock(&args, &v)))\r\n;\r\nelse if (v)\r\nrval = xfs_dir2_block_getdents(&args, ctx);\r\nelse\r\nrval = xfs_dir2_leaf_getdents(&args, ctx, bufsize);\r\nreturn rval;\r\n}

static inline __u16 fcs_compute10(unsigned char *sp, int len, __u16 fcs)\r\n{\r\nfor (; len-- > 0; fcs = CRC10_FCS(fcs, *sp++));\r\nreturn fcs;\r\n}\r\nstatic void safe_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nunsigned char *data = urb->transfer_buffer;\r\nunsigned char length = urb->actual_length;\r\nint actual_length;\r\n__u16 fcs;\r\nif (!length)\r\nreturn;\r\nif (!safe)\r\ngoto out;\r\nif (length < 2) {\r\ndev_err(&port->dev, "malformed packet\n");\r\nreturn;\r\n}\r\nfcs = fcs_compute10(data, length, CRC10_INITFCS);\r\nif (fcs) {\r\ndev_err(&port->dev, "%s - bad CRC %x\n", __func__, fcs);\r\nreturn;\r\n}\r\nactual_length = data[length - 2] >> 2;\r\nif (actual_length > (length - 2)) {\r\ndev_err(&port->dev, "%s - inconsistent lengths %d:%d\n",\r\n__func__, actual_length, length);\r\nreturn;\r\n}\r\ndev_info(&urb->dev->dev, "%s - actual: %d\n", __func__, actual_length);\r\nlength = actual_length;\r\nout:\r\ntty_insert_flip_string(&port->port, data, length);\r\ntty_flip_buffer_push(&port->port);\r\n}\r\nstatic int safe_prepare_write_buffer(struct usb_serial_port *port,\r\nvoid *dest, size_t size)\r\n{\r\nunsigned char *buf = dest;\r\nint count;\r\nint trailer_len;\r\nint pkt_len;\r\n__u16 fcs;\r\ntrailer_len = safe ? 2 : 0;\r\ncount = kfifo_out_locked(&port->write_fifo, buf, size - trailer_len,\r\n&port->lock);\r\nif (!safe)\r\nreturn count;\r\nif (padded) {\r\npkt_len = size;\r\nmemset(buf + count, '0', pkt_len - count - trailer_len);\r\n} else {\r\npkt_len = count + trailer_len;\r\n}\r\nbuf[pkt_len - 2] = count << 2;\r\nbuf[pkt_len - 1] = 0;\r\nfcs = fcs_compute10(buf, pkt_len, CRC10_INITFCS);\r\nbuf[pkt_len - 2] |= fcs >> 8;\r\nbuf[pkt_len - 1] |= fcs & 0xff;\r\nreturn pkt_len;\r\n}\r\nstatic int safe_startup(struct usb_serial *serial)\r\n{\r\nstruct usb_interface_descriptor *desc;\r\nif (serial->dev->descriptor.bDeviceClass != CDC_DEVICE_CLASS)\r\nreturn -ENODEV;\r\ndesc = &serial->interface->cur_altsetting->desc;\r\nif (desc->bInterfaceClass != LINEO_INTERFACE_CLASS)\r\nreturn -ENODEV;\r\nif (desc->bInterfaceSubClass != LINEO_INTERFACE_SUBCLASS_SAFESERIAL)\r\nreturn -ENODEV;\r\nswitch (desc->bInterfaceProtocol) {\r\ncase LINEO_SAFESERIAL_CRC:\r\nbreak;\r\ncase LINEO_SAFESERIAL_CRC_PADDED:\r\npadded = true;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

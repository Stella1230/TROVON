static void simtec_i2c_setsda(void *pw, int state)\r\n{\r\nstruct simtec_i2c_data *pd = pw;\r\nwriteb(CMD_SET_SDA | (state ? STATE_SDA : 0), pd->reg);\r\n}\r\nstatic void simtec_i2c_setscl(void *pw, int state)\r\n{\r\nstruct simtec_i2c_data *pd = pw;\r\nwriteb(CMD_SET_SCL | (state ? STATE_SCL : 0), pd->reg);\r\n}\r\nstatic int simtec_i2c_getsda(void *pw)\r\n{\r\nstruct simtec_i2c_data *pd = pw;\r\nreturn readb(pd->reg) & STATE_SDA ? 1 : 0;\r\n}\r\nstatic int simtec_i2c_getscl(void *pw)\r\n{\r\nstruct simtec_i2c_data *pd = pw;\r\nreturn readb(pd->reg) & STATE_SCL ? 1 : 0;\r\n}\r\nstatic int simtec_i2c_probe(struct platform_device *dev)\r\n{\r\nstruct simtec_i2c_data *pd;\r\nstruct resource *res;\r\nint size;\r\nint ret;\r\npd = kzalloc(sizeof(struct simtec_i2c_data), GFP_KERNEL);\r\nif (pd == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(dev, pd);\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(&dev->dev, "cannot find IO resource\n");\r\nret = -ENOENT;\r\ngoto err;\r\n}\r\nsize = resource_size(res);\r\npd->ioarea = request_mem_region(res->start, size, dev->name);\r\nif (pd->ioarea == NULL) {\r\ndev_err(&dev->dev, "cannot request IO\n");\r\nret = -ENXIO;\r\ngoto err;\r\n}\r\npd->reg = ioremap(res->start, size);\r\nif (pd->reg == NULL) {\r\ndev_err(&dev->dev, "cannot map IO\n");\r\nret = -ENXIO;\r\ngoto err_res;\r\n}\r\npd->adap.owner = THIS_MODULE;\r\npd->adap.algo_data = &pd->bit;\r\npd->adap.dev.parent = &dev->dev;\r\nstrlcpy(pd->adap.name, "Simtec I2C", sizeof(pd->adap.name));\r\npd->bit.data = pd;\r\npd->bit.setsda = simtec_i2c_setsda;\r\npd->bit.setscl = simtec_i2c_setscl;\r\npd->bit.getsda = simtec_i2c_getsda;\r\npd->bit.getscl = simtec_i2c_getscl;\r\npd->bit.timeout = HZ;\r\npd->bit.udelay = 20;\r\nret = i2c_bit_add_bus(&pd->adap);\r\nif (ret)\r\ngoto err_all;\r\nreturn 0;\r\nerr_all:\r\niounmap(pd->reg);\r\nerr_res:\r\nrelease_mem_region(pd->ioarea->start, size);\r\nerr:\r\nkfree(pd);\r\nreturn ret;\r\n}\r\nstatic int simtec_i2c_remove(struct platform_device *dev)\r\n{\r\nstruct simtec_i2c_data *pd = platform_get_drvdata(dev);\r\ni2c_del_adapter(&pd->adap);\r\niounmap(pd->reg);\r\nrelease_mem_region(pd->ioarea->start, resource_size(pd->ioarea));\r\nkfree(pd);\r\nreturn 0;\r\n}

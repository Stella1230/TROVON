void mctrl_gpio_set(struct mctrl_gpios *gpios, unsigned int mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nstruct gpio_desc *desc_array[UART_GPIO_MAX];\r\nint value_array[UART_GPIO_MAX];\r\nunsigned int count = 0;\r\nif (gpios == NULL)\r\nreturn;\r\nfor (i = 0; i < UART_GPIO_MAX; i++)\r\nif (gpios->gpio[i] && mctrl_gpios_desc[i].dir_out) {\r\ndesc_array[count] = gpios->gpio[i];\r\nvalue_array[count] = !!(mctrl & mctrl_gpios_desc[i].mctrl);\r\ncount++;\r\n}\r\ngpiod_set_array_value(count, desc_array, value_array);\r\n}\r\nstruct gpio_desc *mctrl_gpio_to_gpiod(struct mctrl_gpios *gpios,\r\nenum mctrl_gpio_idx gidx)\r\n{\r\nreturn gpios->gpio[gidx];\r\n}\r\nunsigned int mctrl_gpio_get(struct mctrl_gpios *gpios, unsigned int *mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (gpios == NULL)\r\nreturn *mctrl;\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nif (gpios->gpio[i] && !mctrl_gpios_desc[i].dir_out) {\r\nif (gpiod_get_value(gpios->gpio[i]))\r\n*mctrl |= mctrl_gpios_desc[i].mctrl;\r\nelse\r\n*mctrl &= ~mctrl_gpios_desc[i].mctrl;\r\n}\r\n}\r\nreturn *mctrl;\r\n}\r\nunsigned int\r\nmctrl_gpio_get_outputs(struct mctrl_gpios *gpios, unsigned int *mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (gpios == NULL)\r\nreturn *mctrl;\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nif (gpios->gpio[i] && mctrl_gpios_desc[i].dir_out) {\r\nif (gpiod_get_value(gpios->gpio[i]))\r\n*mctrl |= mctrl_gpios_desc[i].mctrl;\r\nelse\r\n*mctrl &= ~mctrl_gpios_desc[i].mctrl;\r\n}\r\n}\r\nreturn *mctrl;\r\n}\r\nstruct mctrl_gpios *mctrl_gpio_init_noauto(struct device *dev, unsigned int idx)\r\n{\r\nstruct mctrl_gpios *gpios;\r\nenum mctrl_gpio_idx i;\r\ngpios = devm_kzalloc(dev, sizeof(*gpios), GFP_KERNEL);\r\nif (!gpios)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nenum gpiod_flags flags;\r\nif (mctrl_gpios_desc[i].dir_out)\r\nflags = GPIOD_OUT_LOW;\r\nelse\r\nflags = GPIOD_IN;\r\ngpios->gpio[i] =\r\ndevm_gpiod_get_index_optional(dev,\r\nmctrl_gpios_desc[i].name,\r\nidx, flags);\r\nif (IS_ERR(gpios->gpio[i]))\r\nreturn ERR_CAST(gpios->gpio[i]);\r\n}\r\nreturn gpios;\r\n}\r\nstatic irqreturn_t mctrl_gpio_irq_handle(int irq, void *context)\r\n{\r\nstruct mctrl_gpios *gpios = context;\r\nstruct uart_port *port = gpios->port;\r\nu32 mctrl = gpios->mctrl_prev;\r\nu32 mctrl_diff;\r\nunsigned long flags;\r\nmctrl_gpio_get(gpios, &mctrl);\r\nspin_lock_irqsave(&port->lock, flags);\r\nmctrl_diff = mctrl ^ gpios->mctrl_prev;\r\ngpios->mctrl_prev = mctrl;\r\nif (mctrl_diff & MCTRL_ANY_DELTA && port->state != NULL) {\r\nif ((mctrl_diff & mctrl) & TIOCM_RI)\r\nport->icount.rng++;\r\nif ((mctrl_diff & mctrl) & TIOCM_DSR)\r\nport->icount.dsr++;\r\nif (mctrl_diff & TIOCM_CD)\r\nuart_handle_dcd_change(port, mctrl & TIOCM_CD);\r\nif (mctrl_diff & TIOCM_CTS)\r\nuart_handle_cts_change(port, mctrl & TIOCM_CTS);\r\nwake_up_interruptible(&port->state->port.delta_msr_wait);\r\n}\r\nspin_unlock_irqrestore(&port->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstruct mctrl_gpios *mctrl_gpio_init(struct uart_port *port, unsigned int idx)\r\n{\r\nstruct mctrl_gpios *gpios;\r\nenum mctrl_gpio_idx i;\r\ngpios = mctrl_gpio_init_noauto(port->dev, idx);\r\nif (IS_ERR(gpios))\r\nreturn gpios;\r\ngpios->port = port;\r\nfor (i = 0; i < UART_GPIO_MAX; ++i) {\r\nint ret;\r\nif (!gpios->gpio[i] || mctrl_gpios_desc[i].dir_out)\r\ncontinue;\r\nret = gpiod_to_irq(gpios->gpio[i]);\r\nif (ret <= 0) {\r\ndev_err(port->dev,\r\n"failed to find corresponding irq for %s (idx=%d, err=%d)\n",\r\nmctrl_gpios_desc[i].name, idx, ret);\r\nreturn ERR_PTR(ret);\r\n}\r\ngpios->irq[i] = ret;\r\nirq_set_status_flags(gpios->irq[i], IRQ_NOAUTOEN);\r\nret = devm_request_irq(port->dev, gpios->irq[i],\r\nmctrl_gpio_irq_handle,\r\nIRQ_TYPE_EDGE_BOTH, dev_name(port->dev),\r\ngpios);\r\nif (ret) {\r\ndev_err(port->dev,\r\n"failed to request irq for %s (idx=%d, err=%d)\n",\r\nmctrl_gpios_desc[i].name, idx, ret);\r\nreturn ERR_PTR(ret);\r\n}\r\n}\r\nreturn gpios;\r\n}\r\nvoid mctrl_gpio_free(struct device *dev, struct mctrl_gpios *gpios)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (gpios == NULL)\r\nreturn;\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nif (gpios->irq[i])\r\ndevm_free_irq(gpios->port->dev, gpios->irq[i], gpios);\r\nif (gpios->gpio[i])\r\ndevm_gpiod_put(dev, gpios->gpio[i]);\r\n}\r\ndevm_kfree(dev, gpios);\r\n}\r\nvoid mctrl_gpio_enable_ms(struct mctrl_gpios *gpios)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (gpios == NULL)\r\nreturn;\r\nif (gpios->mctrl_on)\r\nreturn;\r\ngpios->mctrl_on = true;\r\nmctrl_gpio_get(gpios, &gpios->mctrl_prev);\r\nfor (i = 0; i < UART_GPIO_MAX; ++i) {\r\nif (!gpios->irq[i])\r\ncontinue;\r\nenable_irq(gpios->irq[i]);\r\n}\r\n}\r\nvoid mctrl_gpio_disable_ms(struct mctrl_gpios *gpios)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (gpios == NULL)\r\nreturn;\r\nif (!gpios->mctrl_on)\r\nreturn;\r\ngpios->mctrl_on = false;\r\nfor (i = 0; i < UART_GPIO_MAX; ++i) {\r\nif (!gpios->irq[i])\r\ncontinue;\r\ndisable_irq(gpios->irq[i]);\r\n}\r\n}

static int vpd_decode_len(const s32 max_len, const u8 *in,\r\ns32 *length, s32 *decoded_len)\r\n{\r\nu8 more;\r\nint i = 0;\r\nif (!length || !decoded_len)\r\nreturn VPD_FAIL;\r\n*length = 0;\r\ndo {\r\nif (i >= max_len)\r\nreturn VPD_FAIL;\r\nmore = in[i] & 0x80;\r\n*length <<= 7;\r\n*length |= in[i] & 0x7f;\r\n++i;\r\n} while (more);\r\n*decoded_len = i;\r\nreturn VPD_OK;\r\n}\r\nint vpd_decode_string(const s32 max_len, const u8 *input_buf, s32 *consumed,\r\nvpd_decode_callback callback, void *callback_arg)\r\n{\r\nint type;\r\nint res;\r\ns32 key_len;\r\ns32 value_len;\r\ns32 decoded_len;\r\nconst u8 *key;\r\nconst u8 *value;\r\nif (*consumed >= max_len)\r\nreturn VPD_FAIL;\r\ntype = input_buf[*consumed];\r\nswitch (type) {\r\ncase VPD_TYPE_INFO:\r\ncase VPD_TYPE_STRING:\r\n(*consumed)++;\r\nres = vpd_decode_len(max_len - *consumed, &input_buf[*consumed],\r\n&key_len, &decoded_len);\r\nif (res != VPD_OK || *consumed + decoded_len >= max_len)\r\nreturn VPD_FAIL;\r\n*consumed += decoded_len;\r\nkey = &input_buf[*consumed];\r\n*consumed += key_len;\r\nres = vpd_decode_len(max_len - *consumed, &input_buf[*consumed],\r\n&value_len, &decoded_len);\r\nif (res != VPD_OK || *consumed + decoded_len > max_len)\r\nreturn VPD_FAIL;\r\n*consumed += decoded_len;\r\nvalue = &input_buf[*consumed];\r\n*consumed += value_len;\r\nif (type == VPD_TYPE_STRING)\r\nreturn callback(key, key_len, value, value_len,\r\ncallback_arg);\r\nbreak;\r\ndefault:\r\nreturn VPD_FAIL;\r\n}\r\nreturn VPD_OK;\r\n}

static void hdmi_core_ddc_init(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nconst unsigned long long iclk = 266000000;\r\nconst unsigned ss_scl_high = 4600;\r\nconst unsigned ss_scl_low = 5400;\r\nconst unsigned fs_scl_high = 600;\r\nconst unsigned fs_scl_low = 1300;\r\nconst unsigned sda_hold = 1000;\r\nconst unsigned sfr_div = 10;\r\nunsigned long long sfr;\r\nunsigned v;\r\nsfr = iclk / sfr_div;\r\nsfr /= 1000;\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SOFTRSTZ, 0, 0, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_I2CM_SOFTRSTZ,\r\n0, 0, 1) != 1)\r\nDSSERR("HDMI I2CM reset failed\n");\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_DIV, 0, 3, 3);\r\nv = DIV_ROUND_UP_ULL(ss_scl_high * sfr, 1000000);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SS_SCL_HCNT_1_ADDR,\r\n(v >> 8) & 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SS_SCL_HCNT_0_ADDR,\r\nv & 0xff, 7, 0);\r\nv = DIV_ROUND_UP_ULL(ss_scl_low * sfr, 1000000);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SS_SCL_LCNT_1_ADDR,\r\n(v >> 8) & 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SS_SCL_LCNT_0_ADDR,\r\nv & 0xff, 7, 0);\r\nv = DIV_ROUND_UP_ULL(fs_scl_high * sfr, 1000000);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_FS_SCL_HCNT_1_ADDR,\r\n(v >> 8) & 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_FS_SCL_HCNT_0_ADDR,\r\nv & 0xff, 7, 0);\r\nv = DIV_ROUND_UP_ULL(fs_scl_low * sfr, 1000000);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_FS_SCL_LCNT_1_ADDR,\r\n(v >> 8) & 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_FS_SCL_LCNT_0_ADDR,\r\nv & 0xff, 7, 0);\r\nv = DIV_ROUND_UP_ULL(sda_hold * sfr, 1000000);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SDA_HOLD_ADDR, v & 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SLAVE, 0x50, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SEGADDR, 0x30, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 7, 7);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x0, 6, 6);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 3, 3);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x0, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_INT, 0x1, 3, 3);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_INT, 0x0, 2, 2);\r\n}\r\nstatic void hdmi_core_ddc_uninit(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 6, 6);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_INT, 0x1, 2, 2);\r\n}\r\nstatic int hdmi_core_ddc_edid(struct hdmi_core_data *core, u8 *pedid, u8 ext)\r\n{\r\nvoid __iomem *base = core->base;\r\nu8 cur_addr;\r\nchar checksum = 0;\r\nconst int retries = 1000;\r\nu8 seg_ptr = ext / 2;\r\nu8 edidbase = ((ext % 2) * 0x80);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_SEGPTR, seg_ptr, 7, 0);\r\nfor (cur_addr = 0; cur_addr < 128; ++cur_addr) {\r\nint i;\r\nREG_FLD_MOD(base, HDMI_CORE_IH_I2CM_STAT0, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_ADDRESS,\r\nedidbase + cur_addr, 7, 0);\r\nif (seg_ptr)\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_OPERATION, 1, 1, 1);\r\nelse\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_OPERATION, 1, 0, 0);\r\nfor (i = 0; i < retries; ++i) {\r\nu32 stat;\r\nstat = REG_GET(base, HDMI_CORE_IH_I2CM_STAT0, 1, 0);\r\nif (stat & 1) {\r\nDSSERR("HDMI I2C Master Error\n");\r\nreturn -EIO;\r\n}\r\nif (stat & (1 << 1))\r\nbreak;\r\nusleep_range(250, 1000);\r\n}\r\nif (i == retries) {\r\nDSSERR("HDMI I2C timeout reading EDID\n");\r\nreturn -EIO;\r\n}\r\npedid[cur_addr] = REG_GET(base, HDMI_CORE_I2CM_DATAI, 7, 0);\r\nchecksum += pedid[cur_addr];\r\n}\r\nreturn 0;\r\n}\r\nint hdmi5_read_edid(struct hdmi_core_data *core, u8 *edid, int len)\r\n{\r\nint r, n, i;\r\nint max_ext_blocks = (len / 128) - 1;\r\nif (len < 128)\r\nreturn -EINVAL;\r\nhdmi_core_ddc_init(core);\r\nr = hdmi_core_ddc_edid(core, edid, 0);\r\nif (r)\r\ngoto out;\r\nn = edid[0x7e];\r\nif (n > max_ext_blocks)\r\nn = max_ext_blocks;\r\nfor (i = 1; i <= n; i++) {\r\nr = hdmi_core_ddc_edid(core, edid + i * EDID_LENGTH, i);\r\nif (r)\r\ngoto out;\r\n}\r\nout:\r\nhdmi_core_ddc_uninit(core);\r\nreturn r ? r : len;\r\n}\r\nvoid hdmi5_core_dump(struct hdmi_core_data *core, struct seq_file *s)\r\n{\r\n#define DUMPCORE(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(core->base, r))\r\nDUMPCORE(HDMI_CORE_FC_INVIDCONF);\r\nDUMPCORE(HDMI_CORE_FC_INHACTIV0);\r\nDUMPCORE(HDMI_CORE_FC_INHACTIV1);\r\nDUMPCORE(HDMI_CORE_FC_INHBLANK0);\r\nDUMPCORE(HDMI_CORE_FC_INHBLANK1);\r\nDUMPCORE(HDMI_CORE_FC_INVACTIV0);\r\nDUMPCORE(HDMI_CORE_FC_INVACTIV1);\r\nDUMPCORE(HDMI_CORE_FC_INVBLANK);\r\nDUMPCORE(HDMI_CORE_FC_HSYNCINDELAY0);\r\nDUMPCORE(HDMI_CORE_FC_HSYNCINDELAY1);\r\nDUMPCORE(HDMI_CORE_FC_HSYNCINWIDTH0);\r\nDUMPCORE(HDMI_CORE_FC_HSYNCINWIDTH1);\r\nDUMPCORE(HDMI_CORE_FC_VSYNCINDELAY);\r\nDUMPCORE(HDMI_CORE_FC_VSYNCINWIDTH);\r\nDUMPCORE(HDMI_CORE_FC_CTRLDUR);\r\nDUMPCORE(HDMI_CORE_FC_EXCTRLDUR);\r\nDUMPCORE(HDMI_CORE_FC_EXCTRLSPAC);\r\nDUMPCORE(HDMI_CORE_FC_CH0PREAM);\r\nDUMPCORE(HDMI_CORE_FC_CH1PREAM);\r\nDUMPCORE(HDMI_CORE_FC_CH2PREAM);\r\nDUMPCORE(HDMI_CORE_FC_AVICONF0);\r\nDUMPCORE(HDMI_CORE_FC_AVICONF1);\r\nDUMPCORE(HDMI_CORE_FC_AVICONF2);\r\nDUMPCORE(HDMI_CORE_FC_AVIVID);\r\nDUMPCORE(HDMI_CORE_FC_PRCONF);\r\nDUMPCORE(HDMI_CORE_MC_CLKDIS);\r\nDUMPCORE(HDMI_CORE_MC_SWRSTZREQ);\r\nDUMPCORE(HDMI_CORE_MC_FLOWCTRL);\r\nDUMPCORE(HDMI_CORE_MC_PHYRSTZ);\r\nDUMPCORE(HDMI_CORE_MC_LOCKONCLOCK);\r\nDUMPCORE(HDMI_CORE_I2CM_SLAVE);\r\nDUMPCORE(HDMI_CORE_I2CM_ADDRESS);\r\nDUMPCORE(HDMI_CORE_I2CM_DATAO);\r\nDUMPCORE(HDMI_CORE_I2CM_DATAI);\r\nDUMPCORE(HDMI_CORE_I2CM_OPERATION);\r\nDUMPCORE(HDMI_CORE_I2CM_INT);\r\nDUMPCORE(HDMI_CORE_I2CM_CTLINT);\r\nDUMPCORE(HDMI_CORE_I2CM_DIV);\r\nDUMPCORE(HDMI_CORE_I2CM_SEGADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_SOFTRSTZ);\r\nDUMPCORE(HDMI_CORE_I2CM_SEGPTR);\r\nDUMPCORE(HDMI_CORE_I2CM_SS_SCL_HCNT_1_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_SS_SCL_HCNT_0_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_SS_SCL_LCNT_1_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_SS_SCL_LCNT_0_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_FS_SCL_HCNT_1_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_FS_SCL_HCNT_0_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_FS_SCL_LCNT_1_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_FS_SCL_LCNT_0_ADDR);\r\nDUMPCORE(HDMI_CORE_I2CM_SDA_HOLD_ADDR);\r\n}\r\nstatic void hdmi_core_init(struct hdmi_core_vid_config *video_cfg,\r\nstruct hdmi_config *cfg)\r\n{\r\nDSSDBG("hdmi_core_init\n");\r\nvideo_cfg->v_fc_config.vm = cfg->vm;\r\nvideo_cfg->data_enable_pol = 1;\r\nvideo_cfg->hblank = cfg->vm.hfront_porch +\r\ncfg->vm.hback_porch + cfg->vm.hsync_len;\r\nvideo_cfg->vblank_osc = 0;\r\nvideo_cfg->vblank = cfg->vm.vsync_len + cfg->vm.vfront_porch +\r\ncfg->vm.vback_porch;\r\nvideo_cfg->v_fc_config.hdmi_dvi_mode = cfg->hdmi_dvi_mode;\r\nif (cfg->vm.flags & DISPLAY_FLAGS_INTERLACED) {\r\nif (video_cfg->vblank % 2 != 0)\r\nvideo_cfg->vblank_osc = 1;\r\nvideo_cfg->v_fc_config.vm.vactive /= 2;\r\nvideo_cfg->vblank /= 2;\r\nvideo_cfg->v_fc_config.vm.vfront_porch /= 2;\r\nvideo_cfg->v_fc_config.vm.vsync_len /= 2;\r\nvideo_cfg->v_fc_config.vm.vback_porch /= 2;\r\n}\r\nif (cfg->vm.flags & DISPLAY_FLAGS_DOUBLECLK) {\r\nvideo_cfg->v_fc_config.vm.hactive *= 2;\r\nvideo_cfg->hblank *= 2;\r\nvideo_cfg->v_fc_config.vm.hfront_porch *= 2;\r\nvideo_cfg->v_fc_config.vm.hsync_len *= 2;\r\nvideo_cfg->v_fc_config.vm.hback_porch *= 2;\r\n}\r\n}\r\nstatic void hdmi_core_video_config(struct hdmi_core_data *core,\r\nstruct hdmi_core_vid_config *cfg)\r\n{\r\nvoid __iomem *base = core->base;\r\nstruct videomode *vm = &cfg->v_fc_config.vm;\r\nunsigned char r = 0;\r\nbool vsync_pol, hsync_pol;\r\nvsync_pol = !!(vm->flags & DISPLAY_FLAGS_VSYNC_HIGH);\r\nhsync_pol = !!(vm->flags & DISPLAY_FLAGS_HSYNC_HIGH);\r\nr = hdmi_read_reg(base, HDMI_CORE_FC_INVIDCONF);\r\nr = FLD_MOD(r, vsync_pol, 6, 6);\r\nr = FLD_MOD(r, hsync_pol, 5, 5);\r\nr = FLD_MOD(r, cfg->data_enable_pol, 4, 4);\r\nr = FLD_MOD(r, cfg->vblank_osc, 1, 1);\r\nr = FLD_MOD(r, !!(vm->flags & DISPLAY_FLAGS_INTERLACED), 0, 0);\r\nhdmi_write_reg(base, HDMI_CORE_FC_INVIDCONF, r);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INHACTIV1, vm->hactive >> 8, 4, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INHACTIV0, vm->hactive & 0xFF, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INVACTIV1, vm->vactive >> 8, 4, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INVACTIV0, vm->vactive & 0xFF, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INHBLANK1, cfg->hblank >> 8, 4, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INHBLANK0, cfg->hblank & 0xFF, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INVBLANK, cfg->vblank, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_HSYNCINDELAY1, vm->hfront_porch >> 8,\r\n4, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_HSYNCINDELAY0, vm->hfront_porch & 0xFF,\r\n7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_VSYNCINDELAY, vm->vfront_porch, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_HSYNCINWIDTH1, (vm->hsync_len >> 8),\r\n1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_HSYNCINWIDTH0, vm->hsync_len & 0xFF,\r\n7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_VSYNCINWIDTH, vm->vsync_len, 5, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_INVIDCONF,\r\ncfg->v_fc_config.hdmi_dvi_mode, 3, 3);\r\nif (vm->flags & DISPLAY_FLAGS_DOUBLECLK)\r\nREG_FLD_MOD(base, HDMI_CORE_FC_PRCONF, 2, 7, 4);\r\nelse\r\nREG_FLD_MOD(base, HDMI_CORE_FC_PRCONF, 1, 7, 4);\r\n}\r\nstatic void hdmi_core_config_video_packetizer(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nint clr_depth = 0;\r\nREG_FLD_MOD(base, HDMI_CORE_VP_PR_CD, clr_depth, 7, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_CONF, clr_depth ? 0 : 1, 6, 6);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_CONF, clr_depth ? 1 : 0, 5, 5);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_CONF, 0, 3, 3);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_STUFF, clr_depth ? 1 : 0, 1, 1);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_STUFF, 1, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_CONF, clr_depth ? 0 : 2, 1, 0);\r\n}\r\nstatic void hdmi_core_config_csc(struct hdmi_core_data *core)\r\n{\r\nint clr_depth = 0;\r\nREG_FLD_MOD(core->base, HDMI_CORE_CSC_SCALE, clr_depth, 7, 4);\r\n}\r\nstatic void hdmi_core_config_video_sampler(struct hdmi_core_data *core)\r\n{\r\nint video_mapping = 1;\r\nREG_FLD_MOD(core->base, HDMI_CORE_TX_INVID0, video_mapping, 4, 0);\r\n}\r\nstatic void hdmi_core_write_avi_infoframe(struct hdmi_core_data *core,\r\nstruct hdmi_avi_infoframe *frame)\r\n{\r\nvoid __iomem *base = core->base;\r\nu8 data[HDMI_INFOFRAME_SIZE(AVI)];\r\nu8 *ptr;\r\nunsigned y, a, b, s;\r\nunsigned c, m, r;\r\nunsigned itc, ec, q, sc;\r\nunsigned vic;\r\nunsigned yq, cn, pr;\r\nhdmi_avi_infoframe_pack(frame, data, sizeof(data));\r\nprint_hex_dump_debug("AVI: ", DUMP_PREFIX_NONE, 16, 1, data,\r\nHDMI_INFOFRAME_SIZE(AVI), false);\r\nptr = data + HDMI_INFOFRAME_HEADER_SIZE;\r\ny = (ptr[0] >> 5) & 0x3;\r\na = (ptr[0] >> 4) & 0x1;\r\nb = (ptr[0] >> 2) & 0x3;\r\ns = (ptr[0] >> 0) & 0x3;\r\nc = (ptr[1] >> 6) & 0x3;\r\nm = (ptr[1] >> 4) & 0x3;\r\nr = (ptr[1] >> 0) & 0xf;\r\nitc = (ptr[2] >> 7) & 0x1;\r\nec = (ptr[2] >> 4) & 0x7;\r\nq = (ptr[2] >> 2) & 0x3;\r\nsc = (ptr[2] >> 0) & 0x3;\r\nvic = ptr[3];\r\nyq = (ptr[4] >> 6) & 0x3;\r\ncn = (ptr[4] >> 4) & 0x3;\r\npr = (ptr[4] >> 0) & 0xf;\r\nhdmi_write_reg(base, HDMI_CORE_FC_AVICONF0,\r\n(a << 6) | (s << 4) | (b << 2) | (y << 0));\r\nhdmi_write_reg(base, HDMI_CORE_FC_AVICONF1,\r\n(c << 6) | (m << 4) | (r << 0));\r\nhdmi_write_reg(base, HDMI_CORE_FC_AVICONF2,\r\n(itc << 7) | (ec << 4) | (q << 2) | (sc << 0));\r\nhdmi_write_reg(base, HDMI_CORE_FC_AVIVID, vic);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AVICONF3,\r\n(yq << 2) | (cn << 0));\r\nREG_FLD_MOD(base, HDMI_CORE_FC_PRCONF, pr, 3, 0);\r\n}\r\nstatic void hdmi_core_csc_config(struct hdmi_core_data *core,\r\nstruct csc_table csc_coeff)\r\n{\r\nvoid __iomem *base = core->base;\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A1_MSB, csc_coeff.a1 >> 8 , 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A1_LSB, csc_coeff.a1, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A2_MSB, csc_coeff.a2 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A2_LSB, csc_coeff.a2, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A3_MSB, csc_coeff.a3 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A3_LSB, csc_coeff.a3, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A4_MSB, csc_coeff.a4 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_A4_LSB, csc_coeff.a4, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B1_MSB, csc_coeff.b1 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B1_LSB, csc_coeff.b1, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B2_MSB, csc_coeff.b2 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B2_LSB, csc_coeff.b2, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B3_MSB, csc_coeff.b3 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B3_LSB, csc_coeff.b3, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B4_MSB, csc_coeff.b4 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_B4_LSB, csc_coeff.b4, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C1_MSB, csc_coeff.c1 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C1_LSB, csc_coeff.c1, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C2_MSB, csc_coeff.c2 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C2_LSB, csc_coeff.c2, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C3_MSB, csc_coeff.c3 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C3_LSB, csc_coeff.c3, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C4_MSB, csc_coeff.c4 >> 8, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CSC_COEF_C4_LSB, csc_coeff.c4, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_MC_FLOWCTRL, 0x1, 0, 0);\r\n}\r\nstatic void hdmi_core_configure_range(struct hdmi_core_data *core)\r\n{\r\nstruct csc_table csc_coeff = { 0 };\r\ncsc_coeff = csc_table_deepcolor[0];\r\nhdmi_core_csc_config(core, csc_coeff);\r\n}\r\nstatic void hdmi_core_enable_video_path(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nDSSDBG("hdmi_core_enable_video_path\n");\r\nREG_FLD_MOD(base, HDMI_CORE_FC_CTRLDUR, 0x0C, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_EXCTRLDUR, 0x20, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_EXCTRLSPAC, 0x01, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_CH0PREAM, 0x0B, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_CH1PREAM, 0x16, 5, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_CH2PREAM, 0x21, 5, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_MC_CLKDIS, 0x00, 0, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_MC_CLKDIS, 0x00, 1, 1);\r\n}\r\nstatic void hdmi_core_mask_interrupts(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nREG_FLD_MOD(base, HDMI_CORE_IH_MUTE, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_VP_MASK, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_MASK0, 0xe7, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_MASK1, 0xfb, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_MASK2, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_INT, 0x3, 3, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_MASK, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_CEC_MASK, 0x7f, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 6, 6);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_CTLINT, 0x1, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_I2CM_INT, 0x1, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_PHY_MASK0, 0xf3, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_PHY_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_VP_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT0, 0xe7, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT1, 0xfb, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT2, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_AS_STAT0, 0x7, 2, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_CEC_STAT0, 0x7f, 6, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_I2CM_STAT0, 0x3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_PHY_STAT0, 0xff, 7, 0);\r\n}\r\nstatic void hdmi_core_enable_interrupts(struct hdmi_core_data *core)\r\n{\r\nREG_FLD_MOD(core->base, HDMI_CORE_IH_MUTE, 0x0, 1, 0);\r\n}\r\nint hdmi5_core_handle_irqs(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT1, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_FC_STAT2, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_AS_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_PHY_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_I2CM_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_CEC_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_VP_STAT0, 0xff, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_IH_I2CMPHY_STAT0, 0xff, 7, 0);\r\nreturn 0;\r\n}\r\nvoid hdmi5_configure(struct hdmi_core_data *core, struct hdmi_wp_data *wp,\r\nstruct hdmi_config *cfg)\r\n{\r\nstruct videomode vm;\r\nstruct hdmi_video_format video_format;\r\nstruct hdmi_core_vid_config v_core_cfg;\r\nhdmi_core_mask_interrupts(core);\r\nhdmi_core_init(&v_core_cfg, cfg);\r\nhdmi_wp_init_vid_fmt_timings(&video_format, &vm, cfg);\r\nhdmi_wp_video_config_timing(wp, &vm);\r\nvideo_format.packing_mode = HDMI_PACK_24b_RGB_YUV444_YUV422;\r\nhdmi_wp_video_config_format(wp, &video_format);\r\nhdmi_wp_video_config_interface(wp, &vm);\r\nhdmi_core_configure_range(core);\r\ncfg->infoframe.quantization_range = HDMI_QUANTIZATION_RANGE_LIMITED;\r\nv_core_cfg.packet_mode = HDMI_PACKETMODE24BITPERPIXEL;\r\nhdmi_core_video_config(core, &v_core_cfg);\r\nhdmi_core_config_video_packetizer(core);\r\nhdmi_core_config_csc(core);\r\nhdmi_core_config_video_sampler(core);\r\nif (cfg->hdmi_dvi_mode == HDMI_HDMI)\r\nhdmi_core_write_avi_infoframe(core, &cfg->infoframe);\r\nhdmi_core_enable_video_path(core);\r\nhdmi_core_enable_interrupts(core);\r\n}\r\nstatic void hdmi5_core_audio_config(struct hdmi_core_data *core,\r\nstruct hdmi_core_audio_config *cfg)\r\n{\r\nvoid __iomem *base = core->base;\r\nu8 val;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCONF, 0xf, 7, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_N1, cfg->n, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_N2, cfg->n >> 8, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_N3, cfg->n >> 16, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CTS3, 1, 4, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CTS1, cfg->cts, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CTS2, cfg->cts >> 8, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CTS3, cfg->cts >> 16, 3, 0);\r\nif (cfg->layout == HDMI_AUDIO_LAYOUT_2CH)\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCONF, 0, 0, 0);\r\nelse\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCONF, 1, 0, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, 0, 0, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, 0, 4, 4);\r\nif (cfg->layout == HDMI_AUDIO_LAYOUT_2CH)\r\nval = 1;\r\nelse\r\nval = 0;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 1, 1);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 5, 5);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 2, 2);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 6, 6);\r\nif (cfg->layout == HDMI_AUDIO_LAYOUT_6CH)\r\nval = 1;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 3, 3);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSV, val, 7, 7);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSU, 0, 7, 0);\r\nval = cfg->iec60958_cfg->status[5] & IEC958_AES5_CON_CGMSA;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(0), val, 5, 4);\r\nval = (cfg->iec60958_cfg->status[0] &\r\nIEC958_AES0_CON_NOT_COPYRIGHT) >> 2;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(0), val, 0, 0);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDSCHNLS(1),\r\ncfg->iec60958_cfg->status[1]);\r\nval = (cfg->iec60958_cfg->status[0] & IEC958_AES0_CON_MODE) >> 6;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(2), val, 6, 4);\r\nval = cfg->iec60958_cfg->status[2] & IEC958_AES2_CON_SOURCE;\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(2), val, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(3), 2, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(3), 4, 7, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(4), 6, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(4), 8, 7, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(5), 1, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(5), 3, 7, 4);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(6), 5, 3, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCHNLS(6), 7, 7, 4);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDSCHNLS(7),\r\ncfg->iec60958_cfg->status[3]);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDSCHNLS(8),\r\ncfg->iec60958_cfg->status[4]);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_INT, 3, 3, 2);\r\nif (cfg->layout == HDMI_AUDIO_LAYOUT_2CH) {\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CONF0, 0, 5, 5);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_CONF1, 3, 7, 0);\r\n} else if (cfg->layout == HDMI_AUDIO_LAYOUT_6CH) {\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CONF0, 0, 5, 5);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_CONF1, 0x3F, 7, 0);\r\n} else {\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_CONF0, 0, 5, 5);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_CONF1, 0xFF, 7, 0);\r\n}\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_CONF2, 0, 0, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_CONF2, 1, 1, 1);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_MASK, 3, 1, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_AUD_GP_POL, 1, 0, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_FC_AUDSCONF, 0, 7, 4);\r\n}\r\nstatic void hdmi5_core_audio_infoframe_cfg(struct hdmi_core_data *core,\r\nstruct snd_cea_861_aud_if *info_aud)\r\n{\r\nvoid __iomem *base = core->base;\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDICONF0,\r\n(info_aud->db1_ct_cc & CEA861_AUDIO_INFOFRAME_DB1CC) << 4 |\r\n(info_aud->db1_ct_cc & CEA861_AUDIO_INFOFRAME_DB1CT) >> 4);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDICONF1, info_aud->db2_sf_ss);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDICONF2, info_aud->db4_ca);\r\nhdmi_write_reg(base, HDMI_CORE_FC_AUDICONF3,\r\n(info_aud->db5_dminh_lsv & CEA861_AUDIO_INFOFRAME_DB5_DM_INH) >> 3 |\r\n(info_aud->db5_dminh_lsv & CEA861_AUDIO_INFOFRAME_DB5_LSV));\r\n}\r\nint hdmi5_audio_config(struct hdmi_core_data *core, struct hdmi_wp_data *wp,\r\nstruct omap_dss_audio *audio, u32 pclk)\r\n{\r\nstruct hdmi_audio_format audio_format;\r\nstruct hdmi_audio_dma audio_dma;\r\nstruct hdmi_core_audio_config core_cfg;\r\nint err, n, cts, channel_count;\r\nunsigned int fs_nr;\r\nbool word_length_16b = false;\r\nif (!audio || !audio->iec || !audio->cea || !core)\r\nreturn -EINVAL;\r\ncore_cfg.iec60958_cfg = audio->iec;\r\nif (!(audio->iec->status[4] & IEC958_AES4_CON_MAX_WORDLEN_24) &&\r\n(audio->iec->status[4] & IEC958_AES4_CON_WORDLEN_20_16))\r\nword_length_16b = true;\r\nif (!word_length_16b)\r\nreturn -EINVAL;\r\nswitch (audio->iec->status[3] & IEC958_AES3_CON_FS) {\r\ncase IEC958_AES3_CON_FS_32000:\r\nfs_nr = 32000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_44100:\r\nfs_nr = 44100;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_48000:\r\nfs_nr = 48000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_88200:\r\nfs_nr = 88200;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_96000:\r\nfs_nr = 96000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_176400:\r\nfs_nr = 176400;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_192000:\r\nfs_nr = 192000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr = hdmi_compute_acr(pclk, fs_nr, &n, &cts);\r\ncore_cfg.n = n;\r\ncore_cfg.cts = cts;\r\nchannel_count = (audio->cea->db1_ct_cc & CEA861_AUDIO_INFOFRAME_DB1CC)\r\n+ 1;\r\nif (channel_count == 2)\r\ncore_cfg.layout = HDMI_AUDIO_LAYOUT_2CH;\r\nelse if (channel_count == 6)\r\ncore_cfg.layout = HDMI_AUDIO_LAYOUT_6CH;\r\nelse\r\ncore_cfg.layout = HDMI_AUDIO_LAYOUT_8CH;\r\nif (word_length_16b)\r\naudio_dma.transfer_size = 0x10;\r\nelse\r\naudio_dma.transfer_size = 0x20;\r\naudio_dma.block_size = 0xC0;\r\naudio_dma.mode = HDMI_AUDIO_TRANSF_DMA;\r\naudio_dma.fifo_threshold = 0x20;\r\naudio_format.samples_per_word = HDMI_AUDIO_ONEWORD_TWOSAMPLES;\r\naudio_format.sample_size = HDMI_AUDIO_SAMPLE_16BITS;\r\naudio_format.justification = HDMI_AUDIO_JUSTIFY_LEFT;\r\naudio_format.sample_order = HDMI_AUDIO_SAMPLE_LEFT_FIRST;\r\naudio_format.type = HDMI_AUDIO_TYPE_LPCM;\r\naudio_format.sample_order = HDMI_AUDIO_SAMPLE_LEFT_FIRST;\r\naudio_format.en_sig_blk_strt_end = HDMI_AUDIO_BLOCK_SIG_STARTEND_ON;\r\nhdmi_wp_audio_config_dma(wp, &audio_dma);\r\nhdmi_wp_audio_config_format(wp, &audio_format);\r\nhdmi5_core_audio_config(core, &core_cfg);\r\nhdmi5_core_audio_infoframe_cfg(core, audio->cea);\r\nreturn 0;\r\n}\r\nint hdmi5_core_init(struct platform_device *pdev, struct hdmi_core_data *core)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "core");\r\ncore->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(core->base))\r\nreturn PTR_ERR(core->base);\r\nreturn 0;\r\n}

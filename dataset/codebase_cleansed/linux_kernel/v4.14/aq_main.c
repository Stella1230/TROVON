static struct aq_hw_ops *aq_pci_probe_get_hw_ops_by_id(struct pci_dev *pdev)\r\n{\r\nstruct aq_hw_ops *ops = NULL;\r\nops = hw_atl_a0_get_ops_by_id(pdev);\r\nif (!ops)\r\nops = hw_atl_b0_get_ops_by_id(pdev);\r\nreturn ops;\r\n}\r\nstatic int aq_ndev_open(struct net_device *ndev)\r\n{\r\nstruct aq_nic_s *aq_nic = NULL;\r\nint err = 0;\r\naq_nic = aq_nic_alloc_hot(ndev);\r\nif (!aq_nic) {\r\nerr = -ENOMEM;\r\ngoto err_exit;\r\n}\r\nerr = aq_nic_init(aq_nic);\r\nif (err < 0)\r\ngoto err_exit;\r\nerr = aq_nic_start(aq_nic);\r\nif (err < 0)\r\ngoto err_exit;\r\nerr_exit:\r\nif (err < 0)\r\naq_nic_deinit(aq_nic);\r\nreturn err;\r\n}\r\nstatic int aq_ndev_close(struct net_device *ndev)\r\n{\r\nint err = 0;\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nerr = aq_nic_stop(aq_nic);\r\nif (err < 0)\r\ngoto err_exit;\r\naq_nic_deinit(aq_nic);\r\naq_nic_free_hot_resources(aq_nic);\r\nerr_exit:\r\nreturn err;\r\n}\r\nstatic int aq_ndev_start_xmit(struct sk_buff *skb, struct net_device *ndev)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nreturn aq_nic_xmit(aq_nic, skb);\r\n}\r\nstatic int aq_ndev_change_mtu(struct net_device *ndev, int new_mtu)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nint err = aq_nic_set_mtu(aq_nic, new_mtu + ETH_HLEN);\r\nif (err < 0)\r\ngoto err_exit;\r\nndev->mtu = new_mtu;\r\nerr_exit:\r\nreturn err;\r\n}\r\nstatic int aq_ndev_set_features(struct net_device *ndev,\r\nnetdev_features_t features)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *aq_cfg = aq_nic_get_cfg(aq_nic);\r\nbool is_lro = false;\r\nif (aq_cfg->hw_features & NETIF_F_LRO) {\r\nis_lro = features & NETIF_F_LRO;\r\nif (aq_cfg->is_lro != is_lro) {\r\naq_cfg->is_lro = is_lro;\r\nif (netif_running(ndev)) {\r\naq_ndev_close(ndev);\r\naq_ndev_open(ndev);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int aq_ndev_set_mac_address(struct net_device *ndev, void *addr)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nint err = 0;\r\nerr = eth_mac_addr(ndev, addr);\r\nif (err < 0)\r\ngoto err_exit;\r\nerr = aq_nic_set_mac(aq_nic, ndev);\r\nif (err < 0)\r\ngoto err_exit;\r\nerr_exit:\r\nreturn err;\r\n}\r\nstatic void aq_ndev_set_multicast_settings(struct net_device *ndev)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nint err = 0;\r\nerr = aq_nic_set_packet_filter(aq_nic, ndev->flags);\r\nif (err < 0)\r\ngoto err_exit;\r\nif (netdev_mc_count(ndev)) {\r\nerr = aq_nic_set_multicast_list(aq_nic, ndev);\r\nif (err < 0)\r\ngoto err_exit;\r\n}\r\nerr_exit:;\r\n}\r\nstatic int aq_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct aq_hw_ops *aq_hw_ops = NULL;\r\nstruct aq_pci_func_s *aq_pci_func = NULL;\r\nint err = 0;\r\nerr = pci_enable_device(pdev);\r\nif (err < 0)\r\ngoto err_exit;\r\naq_hw_ops = aq_pci_probe_get_hw_ops_by_id(pdev);\r\naq_pci_func = aq_pci_func_alloc(aq_hw_ops, pdev,\r\n&aq_ndev_ops, &aq_ethtool_ops);\r\nif (!aq_pci_func) {\r\nerr = -ENOMEM;\r\ngoto err_exit;\r\n}\r\nerr = aq_pci_func_init(aq_pci_func);\r\nif (err < 0)\r\ngoto err_exit;\r\nerr_exit:\r\nif (err < 0) {\r\nif (aq_pci_func)\r\naq_pci_func_free(aq_pci_func);\r\n}\r\nreturn err;\r\n}\r\nstatic void aq_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct aq_pci_func_s *aq_pci_func = pci_get_drvdata(pdev);\r\naq_pci_func_deinit(aq_pci_func);\r\naq_pci_func_free(aq_pci_func);\r\n}\r\nstatic int aq_pci_suspend(struct pci_dev *pdev, pm_message_t pm_msg)\r\n{\r\nstruct aq_pci_func_s *aq_pci_func = pci_get_drvdata(pdev);\r\nreturn aq_pci_func_change_pm_state(aq_pci_func, &pm_msg);\r\n}\r\nstatic int aq_pci_resume(struct pci_dev *pdev)\r\n{\r\nstruct aq_pci_func_s *aq_pci_func = pci_get_drvdata(pdev);\r\npm_message_t pm_msg = PMSG_RESTORE;\r\nreturn aq_pci_func_change_pm_state(aq_pci_func, &pm_msg);\r\n}

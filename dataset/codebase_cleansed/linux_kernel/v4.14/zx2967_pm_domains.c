static int zx2967_power_on(struct generic_pm_domain *domain)\r\n{\r\nstruct zx2967_pm_domain *zpd = (struct zx2967_pm_domain *)domain;\r\nunsigned long loop = 1000;\r\nu32 val;\r\nval = readl_relaxed(pcubase + PCU_DM_PWREN(zpd));\r\nif (zpd->polarity == PWREN)\r\nval |= BIT(zpd->bit);\r\nelse\r\nval &= ~BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_PWREN(zpd));\r\ndo {\r\nudelay(1);\r\nval = readl_relaxed(pcubase + PCU_DM_ACK_SYNC(zpd))\r\n& BIT(zpd->bit);\r\n} while (--loop && !val);\r\nif (!loop) {\r\npr_err("Error: %s %s fail\n", __func__, domain->name);\r\nreturn -EIO;\r\n}\r\nval = readl_relaxed(pcubase + PCU_DM_RSTEN(zpd));\r\nval |= BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_RSTEN(zpd));\r\nudelay(5);\r\nval = readl_relaxed(pcubase + PCU_DM_ISOEN(zpd));\r\nval &= ~BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_ISOEN(zpd));\r\nudelay(5);\r\nval = readl_relaxed(pcubase + PCU_DM_CLKEN(zpd));\r\nval |= BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_CLKEN(zpd));\r\nudelay(5);\r\npr_debug("poweron %s\n", domain->name);\r\nreturn 0;\r\n}\r\nstatic int zx2967_power_off(struct generic_pm_domain *domain)\r\n{\r\nstruct zx2967_pm_domain *zpd = (struct zx2967_pm_domain *)domain;\r\nunsigned long loop = 1000;\r\nu32 val;\r\nval = readl_relaxed(pcubase + PCU_DM_CLKEN(zpd));\r\nval &= ~BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_CLKEN(zpd));\r\nudelay(5);\r\nval = readl_relaxed(pcubase + PCU_DM_ISOEN(zpd));\r\nval |= BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_ISOEN(zpd));\r\nudelay(5);\r\nval = readl_relaxed(pcubase + PCU_DM_RSTEN(zpd));\r\nval &= ~BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_RSTEN(zpd));\r\nudelay(5);\r\nval = readl_relaxed(pcubase + PCU_DM_PWREN(zpd));\r\nif (zpd->polarity == PWREN)\r\nval &= ~BIT(zpd->bit);\r\nelse\r\nval |= BIT(zpd->bit);\r\nwritel_relaxed(val, pcubase + PCU_DM_PWREN(zpd));\r\ndo {\r\nudelay(1);\r\nval = readl_relaxed(pcubase + PCU_DM_ACK_SYNC(zpd))\r\n& BIT(zpd->bit);\r\n} while (--loop && val);\r\nif (!loop) {\r\npr_err("Error: %s %s fail\n", __func__, domain->name);\r\nreturn -EIO;\r\n}\r\npr_debug("poweroff %s\n", domain->name);\r\nreturn 0;\r\n}\r\nint zx2967_pd_probe(struct platform_device *pdev,\r\nstruct generic_pm_domain **zx_pm_domains,\r\nint domain_num)\r\n{\r\nstruct genpd_onecell_data *genpd_data;\r\nstruct resource *res;\r\nint i;\r\ngenpd_data = devm_kzalloc(&pdev->dev, sizeof(*genpd_data), GFP_KERNEL);\r\nif (!genpd_data)\r\nreturn -ENOMEM;\r\ngenpd_data->domains = zx_pm_domains;\r\ngenpd_data->num_domains = domain_num;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npcubase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pcubase))\r\nreturn PTR_ERR(pcubase);\r\nfor (i = 0; i < domain_num; ++i) {\r\nzx_pm_domains[i]->power_on = zx2967_power_on;\r\nzx_pm_domains[i]->power_off = zx2967_power_off;\r\npm_genpd_init(zx_pm_domains[i], NULL, false);\r\n}\r\nof_genpd_add_provider_onecell(pdev->dev.of_node, genpd_data);\r\ndev_info(&pdev->dev, "powerdomain init ok\n");\r\nreturn 0;\r\n}

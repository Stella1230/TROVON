static irqreturn_t max3355_id_irq(int irq, void *dev_id)\r\n{\r\nstruct max3355_data *data = dev_id;\r\nint id = gpiod_get_value_cansleep(data->id_gpiod);\r\nif (id) {\r\nextcon_set_state_sync(data->edev, EXTCON_USB_HOST, false);\r\nextcon_set_state_sync(data->edev, EXTCON_USB, true);\r\n} else {\r\nextcon_set_state_sync(data->edev, EXTCON_USB, false);\r\nextcon_set_state_sync(data->edev, EXTCON_USB_HOST, true);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int max3355_probe(struct platform_device *pdev)\r\n{\r\nstruct max3355_data *data;\r\nstruct gpio_desc *gpiod;\r\nint irq, err;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct max3355_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ngpiod = devm_gpiod_get(&pdev->dev, "id", GPIOD_IN);\r\nif (IS_ERR(gpiod)) {\r\ndev_err(&pdev->dev, "failed to get ID_OUT GPIO\n");\r\nreturn PTR_ERR(gpiod);\r\n}\r\ndata->id_gpiod = gpiod;\r\ngpiod = devm_gpiod_get(&pdev->dev, "maxim,shdn", GPIOD_OUT_HIGH);\r\nif (IS_ERR(gpiod)) {\r\ndev_err(&pdev->dev, "failed to get SHDN# GPIO\n");\r\nreturn PTR_ERR(gpiod);\r\n}\r\ndata->shdn_gpiod = gpiod;\r\ndata->edev = devm_extcon_dev_allocate(&pdev->dev, max3355_cable);\r\nif (IS_ERR(data->edev)) {\r\ndev_err(&pdev->dev, "failed to allocate extcon device\n");\r\nreturn PTR_ERR(data->edev);\r\n}\r\nerr = devm_extcon_dev_register(&pdev->dev, data->edev);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "failed to register extcon device\n");\r\nreturn err;\r\n}\r\nirq = gpiod_to_irq(data->id_gpiod);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "failed to translate ID_OUT GPIO to IRQ\n");\r\nreturn irq;\r\n}\r\nerr = devm_request_threaded_irq(&pdev->dev, irq, NULL, max3355_id_irq,\r\nIRQF_ONESHOT | IRQF_NO_SUSPEND |\r\nIRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING,\r\npdev->name, data);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "failed to request ID_OUT IRQ\n");\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, data);\r\nmax3355_id_irq(irq, data);\r\nreturn 0;\r\n}\r\nstatic int max3355_remove(struct platform_device *pdev)\r\n{\r\nstruct max3355_data *data = platform_get_drvdata(pdev);\r\ngpiod_set_value_cansleep(data->shdn_gpiod, 0);\r\nreturn 0;\r\n}

static void hdac_ext_writel(u32 value, u32 __iomem *addr)\r\n{\r\nwritel(value, addr);\r\n}\r\nstatic u32 hdac_ext_readl(u32 __iomem *addr)\r\n{\r\nreturn readl(addr);\r\n}\r\nstatic void hdac_ext_writew(u16 value, u16 __iomem *addr)\r\n{\r\nwritew(value, addr);\r\n}\r\nstatic u16 hdac_ext_readw(u16 __iomem *addr)\r\n{\r\nreturn readw(addr);\r\n}\r\nstatic void hdac_ext_writeb(u8 value, u8 __iomem *addr)\r\n{\r\nwriteb(value, addr);\r\n}\r\nstatic u8 hdac_ext_readb(u8 __iomem *addr)\r\n{\r\nreturn readb(addr);\r\n}\r\nstatic int hdac_ext_dma_alloc_pages(struct hdac_bus *bus, int type,\r\nsize_t size, struct snd_dma_buffer *buf)\r\n{\r\nreturn snd_dma_alloc_pages(type, bus->dev, size, buf);\r\n}\r\nstatic void hdac_ext_dma_free_pages(struct hdac_bus *bus, struct snd_dma_buffer *buf)\r\n{\r\nsnd_dma_free_pages(buf);\r\n}\r\nint snd_hdac_ext_bus_init(struct hdac_ext_bus *ebus, struct device *dev,\r\nconst struct hdac_bus_ops *ops,\r\nconst struct hdac_io_ops *io_ops)\r\n{\r\nint ret;\r\nstatic int idx;\r\nif (io_ops == NULL)\r\nio_ops = &hdac_ext_default_io;\r\nret = snd_hdac_bus_init(&ebus->bus, dev, ops, io_ops);\r\nif (ret < 0)\r\nreturn ret;\r\nINIT_LIST_HEAD(&ebus->hlink_list);\r\nebus->idx = idx++;\r\nmutex_init(&ebus->lock);\r\nebus->cmd_dma_state = true;\r\nreturn 0;\r\n}\r\nvoid snd_hdac_ext_bus_exit(struct hdac_ext_bus *ebus)\r\n{\r\nsnd_hdac_bus_exit(&ebus->bus);\r\nWARN_ON(!list_empty(&ebus->hlink_list));\r\n}\r\nstatic void default_release(struct device *dev)\r\n{\r\nsnd_hdac_ext_bus_device_exit(container_of(dev, struct hdac_device, dev));\r\n}\r\nint snd_hdac_ext_bus_device_init(struct hdac_ext_bus *ebus, int addr)\r\n{\r\nstruct hdac_ext_device *edev;\r\nstruct hdac_device *hdev = NULL;\r\nstruct hdac_bus *bus = ebus_to_hbus(ebus);\r\nchar name[15];\r\nint ret;\r\nedev = kzalloc(sizeof(*edev), GFP_KERNEL);\r\nif (!edev)\r\nreturn -ENOMEM;\r\nhdev = &edev->hdac;\r\nedev->ebus = ebus;\r\nsnprintf(name, sizeof(name), "ehdaudio%dD%d", ebus->idx, addr);\r\nret = snd_hdac_device_init(hdev, bus, name, addr);\r\nif (ret < 0) {\r\ndev_err(bus->dev, "device init failed for hdac device\n");\r\nreturn ret;\r\n}\r\nhdev->type = HDA_DEV_ASOC;\r\nhdev->dev.release = default_release;\r\nret = snd_hdac_device_register(hdev);\r\nif (ret) {\r\ndev_err(bus->dev, "failed to register hdac device\n");\r\nsnd_hdac_ext_bus_device_exit(hdev);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid snd_hdac_ext_bus_device_exit(struct hdac_device *hdev)\r\n{\r\nstruct hdac_ext_device *edev = to_ehdac_device(hdev);\r\nsnd_hdac_device_exit(hdev);\r\nkfree(edev);\r\n}\r\nvoid snd_hdac_ext_bus_device_remove(struct hdac_ext_bus *ebus)\r\n{\r\nstruct hdac_device *codec, *__codec;\r\nlist_for_each_entry_safe(codec, __codec, &ebus->bus.codec_list, list) {\r\nsnd_hdac_device_unregister(codec);\r\nput_device(&codec->dev);\r\n}\r\n}\r\nstatic inline struct hdac_ext_driver *get_edrv(struct device *dev)\r\n{\r\nstruct hdac_driver *hdrv = drv_to_hdac_driver(dev->driver);\r\nstruct hdac_ext_driver *edrv = to_ehdac_driver(hdrv);\r\nreturn edrv;\r\n}\r\nstatic inline struct hdac_ext_device *get_edev(struct device *dev)\r\n{\r\nstruct hdac_device *hdev = dev_to_hdac_dev(dev);\r\nstruct hdac_ext_device *edev = to_ehdac_device(hdev);\r\nreturn edev;\r\n}\r\nstatic int hda_ext_drv_probe(struct device *dev)\r\n{\r\nreturn (get_edrv(dev))->probe(get_edev(dev));\r\n}\r\nstatic int hdac_ext_drv_remove(struct device *dev)\r\n{\r\nreturn (get_edrv(dev))->remove(get_edev(dev));\r\n}\r\nstatic void hdac_ext_drv_shutdown(struct device *dev)\r\n{\r\nreturn (get_edrv(dev))->shutdown(get_edev(dev));\r\n}\r\nint snd_hda_ext_driver_register(struct hdac_ext_driver *drv)\r\n{\r\ndrv->hdac.type = HDA_DEV_ASOC;\r\ndrv->hdac.driver.bus = &snd_hda_bus_type;\r\nif (drv->probe)\r\ndrv->hdac.driver.probe = hda_ext_drv_probe;\r\nif (drv->remove)\r\ndrv->hdac.driver.remove = hdac_ext_drv_remove;\r\nif (drv->shutdown)\r\ndrv->hdac.driver.shutdown = hdac_ext_drv_shutdown;\r\nreturn driver_register(&drv->hdac.driver);\r\n}\r\nvoid snd_hda_ext_driver_unregister(struct hdac_ext_driver *drv)\r\n{\r\ndriver_unregister(&drv->hdac.driver);\r\n}

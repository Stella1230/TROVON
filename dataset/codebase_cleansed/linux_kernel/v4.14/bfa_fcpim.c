static void\r\nbfa_fcpim_meminfo(struct bfa_iocfc_cfg_s *cfg, u32 *km_len)\r\n{\r\nbfa_itnim_meminfo(cfg, km_len);\r\n*km_len += cfg->fwcfg.num_ioim_reqs *\r\n(sizeof(struct bfa_ioim_s) + sizeof(struct bfa_ioim_sp_s));\r\nif (cfg->fwcfg.num_tskim_reqs < BFA_TSKIM_MIN)\r\ncfg->fwcfg.num_tskim_reqs = BFA_TSKIM_MIN;\r\n*km_len += cfg->fwcfg.num_tskim_reqs * sizeof(struct bfa_tskim_s);\r\n}\r\nstatic void\r\nbfa_fcpim_attach(struct bfa_fcp_mod_s *fcp, void *bfad,\r\nstruct bfa_iocfc_cfg_s *cfg, struct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_fcpim_s *fcpim = &fcp->fcpim;\r\nstruct bfa_s *bfa = fcp->bfa;\r\nbfa_trc(bfa, cfg->drvcfg.path_tov);\r\nbfa_trc(bfa, cfg->fwcfg.num_rports);\r\nbfa_trc(bfa, cfg->fwcfg.num_ioim_reqs);\r\nbfa_trc(bfa, cfg->fwcfg.num_tskim_reqs);\r\nfcpim->fcp = fcp;\r\nfcpim->bfa = bfa;\r\nfcpim->num_itnims = cfg->fwcfg.num_rports;\r\nfcpim->num_tskim_reqs = cfg->fwcfg.num_tskim_reqs;\r\nfcpim->path_tov = cfg->drvcfg.path_tov;\r\nfcpim->delay_comp = cfg->drvcfg.delay_comp;\r\nfcpim->profile_comp = NULL;\r\nfcpim->profile_start = NULL;\r\nbfa_itnim_attach(fcpim);\r\nbfa_tskim_attach(fcpim);\r\nbfa_ioim_attach(fcpim);\r\n}\r\nvoid\r\nbfa_fcpim_iocdisable(struct bfa_fcp_mod_s *fcp)\r\n{\r\nstruct bfa_fcpim_s *fcpim = &fcp->fcpim;\r\nstruct bfa_itnim_s *itnim;\r\nstruct list_head *qe, *qen;\r\nlist_splice_tail_init(&fcpim->tskim_unused_q, &fcpim->tskim_free_q);\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nbfa_itnim_iocdisable(itnim);\r\n}\r\n}\r\nvoid\r\nbfa_fcpim_path_tov_set(struct bfa_s *bfa, u16 path_tov)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nfcpim->path_tov = path_tov * 1000;\r\nif (fcpim->path_tov > BFA_FCPIM_PATHTOV_MAX)\r\nfcpim->path_tov = BFA_FCPIM_PATHTOV_MAX;\r\n}\r\nu16\r\nbfa_fcpim_path_tov_get(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nreturn fcpim->path_tov / 1000;\r\n}\r\nvoid\r\nbfa_fcpim_add_stats(struct bfa_itnim_iostats_s *lstats,\r\nstruct bfa_itnim_iostats_s *rstats)\r\n{\r\nbfa_fcpim_add_iostats(lstats, rstats, total_ios);\r\nbfa_fcpim_add_iostats(lstats, rstats, qresumes);\r\nbfa_fcpim_add_iostats(lstats, rstats, no_iotags);\r\nbfa_fcpim_add_iostats(lstats, rstats, io_aborts);\r\nbfa_fcpim_add_iostats(lstats, rstats, no_tskims);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocomp_ok);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocomp_underrun);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocomp_overrun);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocomp_aborted);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocomp_timedout);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_nexus_abort);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_proto_err);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_dif_err);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_sqer_needed);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_res_free);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_hostabrts);\r\nbfa_fcpim_add_iostats(lstats, rstats, iocom_utags);\r\nbfa_fcpim_add_iostats(lstats, rstats, io_cleanups);\r\nbfa_fcpim_add_iostats(lstats, rstats, io_tmaborts);\r\nbfa_fcpim_add_iostats(lstats, rstats, onlines);\r\nbfa_fcpim_add_iostats(lstats, rstats, offlines);\r\nbfa_fcpim_add_iostats(lstats, rstats, creates);\r\nbfa_fcpim_add_iostats(lstats, rstats, deletes);\r\nbfa_fcpim_add_iostats(lstats, rstats, create_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, delete_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, sler_events);\r\nbfa_fcpim_add_iostats(lstats, rstats, fw_create);\r\nbfa_fcpim_add_iostats(lstats, rstats, fw_delete);\r\nbfa_fcpim_add_iostats(lstats, rstats, ioc_disabled);\r\nbfa_fcpim_add_iostats(lstats, rstats, cleanup_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_cmnds);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_fw_rsps);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_success);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_failures);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_io_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_qresumes);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_iocdowns);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_cleanups);\r\nbfa_fcpim_add_iostats(lstats, rstats, tm_cleanup_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, io_comps);\r\nbfa_fcpim_add_iostats(lstats, rstats, input_reqs);\r\nbfa_fcpim_add_iostats(lstats, rstats, output_reqs);\r\nbfa_fcpim_add_iostats(lstats, rstats, rd_throughput);\r\nbfa_fcpim_add_iostats(lstats, rstats, wr_throughput);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_port_iostats(struct bfa_s *bfa,\r\nstruct bfa_itnim_iostats_s *stats, u8 lp_tag)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct list_head *qe, *qen;\r\nstruct bfa_itnim_s *itnim;\r\nmemset(stats, 0, sizeof(struct bfa_itnim_iostats_s));\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nif (itnim->rport->rport_info.lp_tag != lp_tag)\r\ncontinue;\r\nbfa_fcpim_add_stats(stats, &(itnim->stats));\r\n}\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_ioim_profile_comp(struct bfa_ioim_s *ioim)\r\n{\r\nstruct bfa_itnim_latency_s *io_lat =\r\n&(ioim->itnim->ioprofile.io_latency);\r\nu32 val, idx;\r\nval = (u32)(jiffies - ioim->start_time);\r\nidx = bfa_ioim_get_index(scsi_bufflen((struct scsi_cmnd *)ioim->dio));\r\nbfa_itnim_ioprofile_update(ioim->itnim, idx);\r\nio_lat->count[idx]++;\r\nio_lat->min[idx] = (io_lat->min[idx] < val) ? io_lat->min[idx] : val;\r\nio_lat->max[idx] = (io_lat->max[idx] > val) ? io_lat->max[idx] : val;\r\nio_lat->avg[idx] += val;\r\n}\r\nvoid\r\nbfa_ioim_profile_start(struct bfa_ioim_s *ioim)\r\n{\r\nioim->start_time = jiffies;\r\n}\r\nbfa_status_t\r\nbfa_fcpim_profile_on(struct bfa_s *bfa, u32 time)\r\n{\r\nstruct bfa_itnim_s *itnim;\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nbfa_itnim_clear_stats(itnim);\r\n}\r\nfcpim->io_profile = BFA_TRUE;\r\nfcpim->io_profile_start_time = time;\r\nfcpim->profile_comp = bfa_ioim_profile_comp;\r\nfcpim->profile_start = bfa_ioim_profile_start;\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcpim_profile_off(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nfcpim->io_profile = BFA_FALSE;\r\nfcpim->io_profile_start_time = 0;\r\nfcpim->profile_comp = NULL;\r\nfcpim->profile_start = NULL;\r\nreturn BFA_STATUS_OK;\r\n}\r\nu16\r\nbfa_fcpim_qdepth_get(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nreturn fcpim->q_depth;\r\n}\r\nstatic void\r\nbfa_itnim_sm_uninit(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_CREATE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_created);\r\nitnim->is_online = BFA_FALSE;\r\nbfa_fcpim_additn(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_created(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_ONLINE:\r\nif (bfa_itnim_send_fwcreate(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_fwcreate(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_FWRSP:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_online);\r\nitnim->is_online = BFA_TRUE;\r\nbfa_itnim_iotov_online(itnim);\r\nbfa_itnim_online_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_delete_pending);\r\nbreak;\r\ncase BFA_ITNIM_SM_OFFLINE:\r\nif (bfa_itnim_send_fwdelete(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_fwcreate_qfull(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_QRESUME:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\r\nbfa_itnim_send_fwcreate(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_reqq_wcancel(&itnim->reqq_wait);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_offline);\r\nbfa_reqq_wcancel(&itnim->reqq_wait);\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_reqq_wcancel(&itnim->reqq_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_delete_pending(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_FWRSP:\r\nif (bfa_itnim_send_fwdelete(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_online(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_offline);\r\nitnim->is_online = BFA_FALSE;\r\nbfa_itnim_iotov_start(itnim);\r\nbfa_itnim_cleanup(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\r\nitnim->is_online = BFA_FALSE;\r\nbfa_itnim_cleanup(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_SLER:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_sler);\r\nitnim->is_online = BFA_FALSE;\r\nbfa_itnim_iotov_start(itnim);\r\nbfa_itnim_sler_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nitnim->is_online = BFA_FALSE;\r\nbfa_itnim_iotov_start(itnim);\r\nbfa_itnim_iocdisable_cleanup(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_sler(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_offline);\r\nbfa_itnim_cleanup(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\r\nbfa_itnim_cleanup(itnim);\r\nbfa_itnim_iotov_delete(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_itnim_iocdisable_cleanup(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_cleanup_offline(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_CLEANUP:\r\nif (bfa_itnim_send_fwdelete(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\r\nbfa_itnim_iotov_delete(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_itnim_iocdisable_cleanup(itnim);\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_SLER:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_cleanup_delete(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_CLEANUP:\r\nif (bfa_itnim_send_fwdelete(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_itnim_iocdisable_cleanup(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_fwdelete(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_FWRSP:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_offline);\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_fwdelete_qfull(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_QRESUME:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\r\nbfa_itnim_send_fwdelete(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbfa_reqq_wcancel(&itnim->reqq_wait);\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_offline(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_itnim_iotov_delete(itnim);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_ONLINE:\r\nif (bfa_itnim_send_fwcreate(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_iocdisable(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_itnim_iotov_delete(itnim);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_OFFLINE:\r\nbfa_itnim_offline_cb(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_ONLINE:\r\nif (bfa_itnim_send_fwcreate(itnim))\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_deleting(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_FWRSP:\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_sm_deleting_qfull(struct bfa_itnim_s *itnim,\r\nenum bfa_itnim_event event)\r\n{\r\nbfa_trc(itnim->bfa, itnim->rport->rport_tag);\r\nbfa_trc(itnim->bfa, event);\r\nswitch (event) {\r\ncase BFA_ITNIM_SM_QRESUME:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\r\nbfa_itnim_send_fwdelete(itnim);\r\nbreak;\r\ncase BFA_ITNIM_SM_HWFAIL:\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\nbfa_reqq_wcancel(&itnim->reqq_wait);\r\nbfa_fcpim_delitn(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iocdisable_cleanup(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfa_tskim_s *tskim;\r\nstruct bfa_ioim_s *ioim;\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &itnim->tsk_q) {\r\ntskim = (struct bfa_tskim_s *) qe;\r\nbfa_tskim_iocdisable(tskim);\r\n}\r\nlist_for_each_safe(qe, qen, &itnim->io_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nbfa_ioim_iocdisable(ioim);\r\n}\r\nlist_for_each_safe(qe, qen, &itnim->pending_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nbfa_ioim_tov(ioim);\r\n}\r\nlist_for_each_safe(qe, qen, &itnim->io_cleanup_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nbfa_ioim_iocdisable(ioim);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_cleanp_comp(void *itnim_cbarg)\r\n{\r\nstruct bfa_itnim_s *itnim = itnim_cbarg;\r\nbfa_stats(itnim, cleanup_comps);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_CLEANUP);\r\n}\r\nstatic void\r\nbfa_itnim_cleanup(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nstruct bfa_tskim_s *tskim;\r\nstruct list_head *qe, *qen;\r\nbfa_wc_init(&itnim->wc, bfa_itnim_cleanp_comp, itnim);\r\nlist_for_each_safe(qe, qen, &itnim->io_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &itnim->io_cleanup_q);\r\nbfa_wc_up(&itnim->wc);\r\nbfa_ioim_cleanup(ioim);\r\n}\r\nlist_for_each_safe(qe, qen, &itnim->tsk_q) {\r\ntskim = (struct bfa_tskim_s *) qe;\r\nbfa_wc_up(&itnim->wc);\r\nbfa_tskim_cleanup(tskim);\r\n}\r\nbfa_wc_wait(&itnim->wc);\r\n}\r\nstatic void\r\n__bfa_cb_itnim_online(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_itnim_s *itnim = cbarg;\r\nif (complete)\r\nbfa_cb_itnim_online(itnim->ditn);\r\n}\r\nstatic void\r\n__bfa_cb_itnim_offline(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_itnim_s *itnim = cbarg;\r\nif (complete)\r\nbfa_cb_itnim_offline(itnim->ditn);\r\n}\r\nstatic void\r\n__bfa_cb_itnim_sler(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_itnim_s *itnim = cbarg;\r\nif (complete)\r\nbfa_cb_itnim_sler(itnim->ditn);\r\n}\r\nstatic void\r\nbfa_itnim_qresume(void *cbarg)\r\n{\r\nstruct bfa_itnim_s *itnim = cbarg;\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_QRESUME);\r\n}\r\nvoid\r\nbfa_itnim_iodone(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_wc_down(&itnim->wc);\r\n}\r\nvoid\r\nbfa_itnim_tskdone(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_wc_down(&itnim->wc);\r\n}\r\nvoid\r\nbfa_itnim_meminfo(struct bfa_iocfc_cfg_s *cfg, u32 *km_len)\r\n{\r\n*km_len += cfg->fwcfg.num_rports * sizeof(struct bfa_itnim_s);\r\n}\r\nvoid\r\nbfa_itnim_attach(struct bfa_fcpim_s *fcpim)\r\n{\r\nstruct bfa_s *bfa = fcpim->bfa;\r\nstruct bfa_fcp_mod_s *fcp = fcpim->fcp;\r\nstruct bfa_itnim_s *itnim;\r\nint i, j;\r\nINIT_LIST_HEAD(&fcpim->itnim_q);\r\nitnim = (struct bfa_itnim_s *) bfa_mem_kva_curp(fcp);\r\nfcpim->itnim_arr = itnim;\r\nfor (i = 0; i < fcpim->num_itnims; i++, itnim++) {\r\nmemset(itnim, 0, sizeof(struct bfa_itnim_s));\r\nitnim->bfa = bfa;\r\nitnim->fcpim = fcpim;\r\nitnim->reqq = BFA_REQQ_QOS_LO;\r\nitnim->rport = BFA_RPORT_FROM_TAG(bfa, i);\r\nitnim->iotov_active = BFA_FALSE;\r\nbfa_reqq_winit(&itnim->reqq_wait, bfa_itnim_qresume, itnim);\r\nINIT_LIST_HEAD(&itnim->io_q);\r\nINIT_LIST_HEAD(&itnim->io_cleanup_q);\r\nINIT_LIST_HEAD(&itnim->pending_q);\r\nINIT_LIST_HEAD(&itnim->tsk_q);\r\nINIT_LIST_HEAD(&itnim->delay_comp_q);\r\nfor (j = 0; j < BFA_IOBUCKET_MAX; j++)\r\nitnim->ioprofile.io_latency.min[j] = ~0;\r\nbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\r\n}\r\nbfa_mem_kva_curp(fcp) = (u8 *) itnim;\r\n}\r\nvoid\r\nbfa_itnim_iocdisable(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_stats(itnim, ioc_disabled);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_HWFAIL);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_itnim_send_fwcreate(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfi_itn_create_req_s *m;\r\nitnim->msg_no++;\r\nm = bfa_reqq_next(itnim->bfa, itnim->reqq);\r\nif (!m) {\r\nbfa_reqq_wait(itnim->bfa, itnim->reqq, &itnim->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_ITN, BFI_ITN_H2I_CREATE_REQ,\r\nbfa_fn_lpu(itnim->bfa));\r\nm->fw_handle = itnim->rport->fw_handle;\r\nm->class = FC_CLASS_3;\r\nm->seq_rec = itnim->seq_rec;\r\nm->msg_no = itnim->msg_no;\r\nbfa_stats(itnim, fw_create);\r\nbfa_reqq_produce(itnim->bfa, itnim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_itnim_send_fwdelete(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfi_itn_delete_req_s *m;\r\nm = bfa_reqq_next(itnim->bfa, itnim->reqq);\r\nif (!m) {\r\nbfa_reqq_wait(itnim->bfa, itnim->reqq, &itnim->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_ITN, BFI_ITN_H2I_DELETE_REQ,\r\nbfa_fn_lpu(itnim->bfa));\r\nm->fw_handle = itnim->rport->fw_handle;\r\nbfa_stats(itnim, fw_delete);\r\nbfa_reqq_produce(itnim->bfa, itnim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_itnim_delayed_comp(struct bfa_itnim_s *itnim, bfa_boolean_t iotov)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &itnim->delay_comp_q) {\r\nioim = (struct bfa_ioim_s *)qe;\r\nbfa_ioim_delayed_comp(ioim, iotov);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iotov_online(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nbfa_itnim_iotov_stop(itnim);\r\nbfa_itnim_delayed_comp(itnim, BFA_FALSE);\r\nwhile (!list_empty(&itnim->pending_q)) {\r\nbfa_q_deq(&itnim->pending_q, &ioim);\r\nlist_add_tail(&ioim->qe, &itnim->io_q);\r\nbfa_ioim_start(ioim);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iotov_cleanup(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nbfa_itnim_delayed_comp(itnim, BFA_TRUE);\r\nwhile (!list_empty(&itnim->pending_q)) {\r\nbfa_q_deq(&itnim->pending_q, &ioim);\r\nlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\r\nbfa_ioim_tov(ioim);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iotov(void *itnim_arg)\r\n{\r\nstruct bfa_itnim_s *itnim = itnim_arg;\r\nitnim->iotov_active = BFA_FALSE;\r\nbfa_cb_itnim_tov_begin(itnim->ditn);\r\nbfa_itnim_iotov_cleanup(itnim);\r\nbfa_cb_itnim_tov(itnim->ditn);\r\n}\r\nstatic void\r\nbfa_itnim_iotov_start(struct bfa_itnim_s *itnim)\r\n{\r\nif (itnim->fcpim->path_tov > 0) {\r\nitnim->iotov_active = BFA_TRUE;\r\nWARN_ON(!bfa_itnim_hold_io(itnim));\r\nbfa_timer_start(itnim->bfa, &itnim->timer,\r\nbfa_itnim_iotov, itnim, itnim->fcpim->path_tov);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iotov_stop(struct bfa_itnim_s *itnim)\r\n{\r\nif (itnim->iotov_active) {\r\nitnim->iotov_active = BFA_FALSE;\r\nbfa_timer_stop(&itnim->timer);\r\n}\r\n}\r\nstatic void\r\nbfa_itnim_iotov_delete(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_boolean_t pathtov_active = BFA_FALSE;\r\nif (itnim->iotov_active)\r\npathtov_active = BFA_TRUE;\r\nbfa_itnim_iotov_stop(itnim);\r\nif (pathtov_active)\r\nbfa_cb_itnim_tov_begin(itnim->ditn);\r\nbfa_itnim_iotov_cleanup(itnim);\r\nif (pathtov_active)\r\nbfa_cb_itnim_tov(itnim->ditn);\r\n}\r\nstatic void\r\nbfa_itnim_update_del_itn_stats(struct bfa_itnim_s *itnim)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(itnim->bfa);\r\nfcpim->del_itn_stats.del_itn_iocomp_aborted +=\r\nitnim->stats.iocomp_aborted;\r\nfcpim->del_itn_stats.del_itn_iocomp_timedout +=\r\nitnim->stats.iocomp_timedout;\r\nfcpim->del_itn_stats.del_itn_iocom_sqer_needed +=\r\nitnim->stats.iocom_sqer_needed;\r\nfcpim->del_itn_stats.del_itn_iocom_res_free +=\r\nitnim->stats.iocom_res_free;\r\nfcpim->del_itn_stats.del_itn_iocom_hostabrts +=\r\nitnim->stats.iocom_hostabrts;\r\nfcpim->del_itn_stats.del_itn_total_ios += itnim->stats.total_ios;\r\nfcpim->del_itn_stats.del_io_iocdowns += itnim->stats.io_iocdowns;\r\nfcpim->del_itn_stats.del_tm_iocdowns += itnim->stats.tm_iocdowns;\r\n}\r\nvoid\r\nbfa_itnim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nunion bfi_itn_i2h_msg_u msg;\r\nstruct bfa_itnim_s *itnim;\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nmsg.msg = m;\r\nswitch (m->mhdr.msg_id) {\r\ncase BFI_ITN_I2H_CREATE_RSP:\r\nitnim = BFA_ITNIM_FROM_TAG(fcpim,\r\nmsg.create_rsp->bfa_handle);\r\nWARN_ON(msg.create_rsp->status != BFA_STATUS_OK);\r\nbfa_stats(itnim, create_comps);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_FWRSP);\r\nbreak;\r\ncase BFI_ITN_I2H_DELETE_RSP:\r\nitnim = BFA_ITNIM_FROM_TAG(fcpim,\r\nmsg.delete_rsp->bfa_handle);\r\nWARN_ON(msg.delete_rsp->status != BFA_STATUS_OK);\r\nbfa_stats(itnim, delete_comps);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_FWRSP);\r\nbreak;\r\ncase BFI_ITN_I2H_SLER_EVENT:\r\nitnim = BFA_ITNIM_FROM_TAG(fcpim,\r\nmsg.sler_event->bfa_handle);\r\nbfa_stats(itnim, sler_events);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_SLER);\r\nbreak;\r\ndefault:\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nstruct bfa_itnim_s *\r\nbfa_itnim_create(struct bfa_s *bfa, struct bfa_rport_s *rport, void *ditn)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfa_itnim_s *itnim;\r\nbfa_itn_create(bfa, rport, bfa_itnim_isr);\r\nitnim = BFA_ITNIM_FROM_TAG(fcpim, rport->rport_tag);\r\nWARN_ON(itnim->rport != rport);\r\nitnim->ditn = ditn;\r\nbfa_stats(itnim, creates);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_CREATE);\r\nreturn itnim;\r\n}\r\nvoid\r\nbfa_itnim_delete(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_stats(itnim, deletes);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_DELETE);\r\n}\r\nvoid\r\nbfa_itnim_online(struct bfa_itnim_s *itnim, bfa_boolean_t seq_rec)\r\n{\r\nitnim->seq_rec = seq_rec;\r\nbfa_stats(itnim, onlines);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_ONLINE);\r\n}\r\nvoid\r\nbfa_itnim_offline(struct bfa_itnim_s *itnim)\r\n{\r\nbfa_stats(itnim, offlines);\r\nbfa_sm_send_event(itnim, BFA_ITNIM_SM_OFFLINE);\r\n}\r\nbfa_boolean_t\r\nbfa_itnim_hold_io(struct bfa_itnim_s *itnim)\r\n{\r\nreturn itnim->fcpim->path_tov && itnim->iotov_active &&\r\n(bfa_sm_cmp_state(itnim, bfa_itnim_sm_fwcreate) ||\r\nbfa_sm_cmp_state(itnim, bfa_itnim_sm_sler) ||\r\nbfa_sm_cmp_state(itnim, bfa_itnim_sm_cleanup_offline) ||\r\nbfa_sm_cmp_state(itnim, bfa_itnim_sm_fwdelete) ||\r\nbfa_sm_cmp_state(itnim, bfa_itnim_sm_offline) ||\r\nbfa_sm_cmp_state(itnim, bfa_itnim_sm_iocdisable));\r\n}\r\nbfa_status_t\r\nbfa_itnim_get_ioprofile(struct bfa_itnim_s *itnim,\r\nstruct bfa_itnim_ioprofile_s *ioprofile)\r\n{\r\nstruct bfa_fcpim_s *fcpim;\r\nif (!itnim)\r\nreturn BFA_STATUS_NO_FCPIM_NEXUS;\r\nfcpim = BFA_FCPIM(itnim->bfa);\r\nif (!fcpim->io_profile)\r\nreturn BFA_STATUS_IOPROFILE_OFF;\r\nitnim->ioprofile.index = BFA_IOBUCKET_MAX;\r\nitnim->ioprofile.io_profile_start_time =\r\nbfa_io_profile_start_time(itnim->bfa);\r\nitnim->ioprofile.clock_res_mul = bfa_io_lat_clock_res_mul;\r\nitnim->ioprofile.clock_res_div = bfa_io_lat_clock_res_div;\r\n*ioprofile = itnim->ioprofile;\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_itnim_clear_stats(struct bfa_itnim_s *itnim)\r\n{\r\nint j;\r\nif (!itnim)\r\nreturn;\r\nmemset(&itnim->stats, 0, sizeof(itnim->stats));\r\nmemset(&itnim->ioprofile, 0, sizeof(itnim->ioprofile));\r\nfor (j = 0; j < BFA_IOBUCKET_MAX; j++)\r\nitnim->ioprofile.io_latency.min[j] = ~0;\r\n}\r\nstatic void\r\nbfa_ioim_sm_uninit(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nswitch (event) {\r\ncase BFA_IOIM_SM_START:\r\nif (!bfa_itnim_is_online(ioim->itnim)) {\r\nif (!bfa_itnim_hold_io(ioim->itnim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe,\r\n&ioim->fcpim->ioim_comp_q);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_pathtov, ioim);\r\n} else {\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe,\r\n&ioim->itnim->pending_q);\r\n}\r\nbreak;\r\n}\r\nif (ioim->nsges > BFI_SGE_INLINE) {\r\nif (!bfa_ioim_sgpg_alloc(ioim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_sgalloc);\r\nreturn;\r\n}\r\n}\r\nif (!bfa_ioim_send_ioreq(ioim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\r\nbreak;\r\n}\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_active);\r\nbreak;\r\ncase BFA_IOIM_SM_IOTOV:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_pathtov, ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nWARN_ON(!bfa_q_is_on_q(&ioim->itnim->pending_q, ioim));\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_abort, ioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_sgalloc(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_SGALLOCED:\r\nif (!bfa_ioim_send_ioreq(ioim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\r\nbreak;\r\n}\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_active);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_active(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nswitch (event) {\r\ncase BFA_IOIM_SM_COMP_GOOD:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_good_comp, ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_COMP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_comp,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_DONE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_comp,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nioim->iosp->abort_explicit = BFA_TRUE;\r\nioim->io_cbfn = __bfa_cb_ioim_abort;\r\nif (bfa_ioim_send_abort(ioim))\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_abort);\r\nelse {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_abort_qfull);\r\nbfa_stats(ioim->itnim, qwait);\r\nbfa_reqq_wait(ioim->bfa, ioim->reqq,\r\n&ioim->iosp->reqq_wait);\r\n}\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nioim->iosp->abort_explicit = BFA_FALSE;\r\nioim->io_cbfn = __bfa_cb_ioim_failed;\r\nif (bfa_ioim_send_abort(ioim))\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\r\nelse {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\r\nbfa_stats(ioim->itnim, qwait);\r\nbfa_reqq_wait(ioim->bfa, ioim->reqq,\r\n&ioim->iosp->reqq_wait);\r\n}\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_SQRETRY:\r\nif (bfa_ioim_maxretry_reached(ioim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_failed, ioim);\r\nbreak;\r\n}\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cmnd_retry);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_cmnd_retry(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nswitch (event) {\r\ncase BFA_IOIM_SM_FREE:\r\nbfa_ioim_update_iotag(ioim);\r\nif (!bfa_ioim_send_ioreq(ioim)) {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\r\nbreak;\r\n}\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_active);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nioim->iosp->abort_explicit = BFA_FALSE;\r\nioim->io_cbfn = __bfa_cb_ioim_failed;\r\nif (bfa_ioim_send_abort(ioim))\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\r\nelse {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\r\nbfa_stats(ioim->itnim, qwait);\r\nbfa_reqq_wait(ioim->bfa, ioim->reqq,\r\n&ioim->iosp->reqq_wait);\r\n}\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\r\n__bfa_cb_ioim_failed, ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_abort(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_COMP_GOOD:\r\ncase BFA_IOIM_SM_COMP:\r\ncase BFA_IOIM_SM_DONE:\r\ncase BFA_IOIM_SM_FREE:\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT_DONE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT_COMP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_COMP_UTAG:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nWARN_ON(ioim->iosp->abort_explicit != BFA_TRUE);\r\nioim->iosp->abort_explicit = BFA_FALSE;\r\nif (bfa_ioim_send_abort(ioim))\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\r\nelse {\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\r\nbfa_stats(ioim->itnim, qwait);\r\nbfa_reqq_wait(ioim->bfa, ioim->reqq,\r\n&ioim->iosp->reqq_wait);\r\n}\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_cleanup(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_COMP_GOOD:\r\ncase BFA_IOIM_SM_COMP:\r\ncase BFA_IOIM_SM_DONE:\r\ncase BFA_IOIM_SM_FREE:\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nioim->io_cbfn = __bfa_cb_ioim_abort;\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT_DONE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT_COMP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_COMP_UTAG:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_QRESUME:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_active);\r\nbfa_ioim_send_ioreq(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_abort_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_QRESUME:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_abort);\r\nbfa_ioim_send_abort(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nWARN_ON(ioim->iosp->abort_explicit != BFA_TRUE);\r\nioim->iosp->abort_explicit = BFA_FALSE;\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\r\nbreak;\r\ncase BFA_IOIM_SM_COMP_GOOD:\r\ncase BFA_IOIM_SM_COMP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_DONE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\r\nioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_cleanup_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_QRESUME:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\r\nbfa_ioim_send_abort(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_ABORT:\r\nioim->io_cbfn = __bfa_cb_ioim_abort;\r\nbreak;\r\ncase BFA_IOIM_SM_COMP_GOOD:\r\ncase BFA_IOIM_SM_COMP:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_DONE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\r\nbfa_ioim_move_to_comp_q(ioim);\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\r\nioim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_hcb(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nswitch (event) {\r\ncase BFA_IOIM_SM_HCB:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\r\nbfa_ioim_free(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_hcb_free(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_HCB:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_resfree);\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_resfree_q);\r\nbreak;\r\ncase BFA_IOIM_SM_FREE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_sm_resfree(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, event);\r\nswitch (event) {\r\ncase BFA_IOIM_SM_FREE:\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\r\nbfa_ioim_free(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_CLEANUP:\r\nbfa_ioim_notify_cleanup(ioim);\r\nbreak;\r\ncase BFA_IOIM_SM_HWFAIL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ioim->bfa, event);\r\n}\r\n}\r\nvoid\r\nbfa_ioim_lm_init(struct bfa_s *bfa)\r\n{\r\nstruct bfa_lun_mask_s *lunm_list;\r\nint i;\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn;\r\nlunm_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nlunm_list[i].ua = BFA_IOIM_LM_UA_RESET;\r\nlunm_list[i].lp_tag = BFA_LP_TAG_INVALID;\r\nlunm_list[i].rp_tag = BFA_RPORT_TAG_INVALID;\r\n}\r\n}\r\nstatic void\r\n__bfa_cb_ioim_good_comp(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nif (!complete) {\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_cb_ioim_good_comp(ioim->bfa->bfad, ioim->dio);\r\n}\r\nstatic void\r\n__bfa_cb_ioim_comp(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nstruct bfi_ioim_rsp_s *m;\r\nu8 *snsinfo = NULL;\r\nu8 sns_len = 0;\r\ns32 residue = 0;\r\nif (!complete) {\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\r\nreturn;\r\n}\r\nm = (struct bfi_ioim_rsp_s *) &ioim->iosp->comp_rspmsg;\r\nif (m->io_status == BFI_IOIM_STS_OK) {\r\nif ((m->scsi_status == SCSI_STATUS_CHECK_CONDITION) &&\r\nm->sns_len) {\r\nsns_len = m->sns_len;\r\nsnsinfo = BFA_SNSINFO_FROM_TAG(ioim->fcpim->fcp,\r\nioim->iotag);\r\n}\r\nif (m->resid_flags == FCP_RESID_UNDER) {\r\nresidue = be32_to_cpu(m->residue);\r\nbfa_stats(ioim->itnim, iocomp_underrun);\r\n}\r\nif (m->resid_flags == FCP_RESID_OVER) {\r\nresidue = be32_to_cpu(m->residue);\r\nresidue = -residue;\r\nbfa_stats(ioim->itnim, iocomp_overrun);\r\n}\r\n}\r\nbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, m->io_status,\r\nm->scsi_status, sns_len, snsinfo, residue);\r\n}\r\nvoid\r\nbfa_fcpim_lunmask_rp_update(struct bfa_s *bfa, wwn_t lp_wwn, wwn_t rp_wwn,\r\nu16 rp_tag, u8 lp_tag)\r\n{\r\nstruct bfa_lun_mask_s *lun_list;\r\nu8 i;\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn;\r\nlun_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif (lun_list[i].state == BFA_IOIM_LUN_MASK_ACTIVE) {\r\nif ((lun_list[i].lp_wwn == lp_wwn) &&\r\n(lun_list[i].rp_wwn == rp_wwn)) {\r\nlun_list[i].rp_tag = rp_tag;\r\nlun_list[i].lp_tag = lp_tag;\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nbfa_ioim_lm_set_ua(struct bfa_s *bfa)\r\n{\r\nstruct bfa_lun_mask_s *lunm_list;\r\nint i;\r\nlunm_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif (lunm_list[i].state != BFA_IOIM_LUN_MASK_ACTIVE)\r\ncontinue;\r\nlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\r\n}\r\n}\r\nbfa_status_t\r\nbfa_fcpim_lunmask_update(struct bfa_s *bfa, u32 update)\r\n{\r\nstruct bfa_lunmask_cfg_s *lun_mask;\r\nbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn BFA_STATUS_FAILED;\r\nif (bfa_get_lun_mask_status(bfa) == update)\r\nreturn BFA_STATUS_NO_CHANGE;\r\nlun_mask = bfa_get_lun_mask(bfa);\r\nlun_mask->status = update;\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_ENABLED)\r\nbfa_ioim_lm_set_ua(bfa);\r\nreturn bfa_dconf_update(bfa);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_lunmask_clear(struct bfa_s *bfa)\r\n{\r\nint i;\r\nstruct bfa_lun_mask_s *lunm_list;\r\nbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn BFA_STATUS_FAILED;\r\nlunm_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif (lunm_list[i].state == BFA_IOIM_LUN_MASK_ACTIVE) {\r\nif (lunm_list[i].rp_tag != BFA_RPORT_TAG_INVALID)\r\nbfa_rport_unset_lunmask(bfa,\r\nBFA_RPORT_FROM_TAG(bfa, lunm_list[i].rp_tag));\r\n}\r\n}\r\nmemset(lunm_list, 0, sizeof(struct bfa_lun_mask_s) * MAX_LUN_MASK_CFG);\r\nreturn bfa_dconf_update(bfa);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_lunmask_query(struct bfa_s *bfa, void *buf)\r\n{\r\nstruct bfa_lunmask_cfg_s *lun_mask;\r\nbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn BFA_STATUS_FAILED;\r\nlun_mask = bfa_get_lun_mask(bfa);\r\nmemcpy(buf, lun_mask, sizeof(struct bfa_lunmask_cfg_s));\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcpim_lunmask_add(struct bfa_s *bfa, u16 vf_id, wwn_t *pwwn,\r\nwwn_t rpwwn, struct scsi_lun lun)\r\n{\r\nstruct bfa_lun_mask_s *lunm_list;\r\nstruct bfa_rport_s *rp = NULL;\r\nint i, free_index = MAX_LUN_MASK_CFG + 1;\r\nstruct bfa_fcs_lport_s *port = NULL;\r\nstruct bfa_fcs_rport_s *rp_fcs;\r\nbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn BFA_STATUS_FAILED;\r\nport = bfa_fcs_lookup_port(&((struct bfad_s *)bfa->bfad)->bfa_fcs,\r\nvf_id, *pwwn);\r\nif (port) {\r\n*pwwn = port->port_cfg.pwwn;\r\nrp_fcs = bfa_fcs_lport_get_rport_by_pwwn(port, rpwwn);\r\nif (rp_fcs)\r\nrp = rp_fcs->bfa_rport;\r\n}\r\nlunm_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif (lunm_list[i].state != BFA_IOIM_LUN_MASK_ACTIVE)\r\nfree_index = i;\r\nif ((lunm_list[i].lp_wwn == *pwwn) &&\r\n(lunm_list[i].rp_wwn == rpwwn) &&\r\n(scsilun_to_int((struct scsi_lun *)&lunm_list[i].lun) ==\r\nscsilun_to_int((struct scsi_lun *)&lun)))\r\nreturn BFA_STATUS_ENTRY_EXISTS;\r\n}\r\nif (free_index > MAX_LUN_MASK_CFG)\r\nreturn BFA_STATUS_MAX_ENTRY_REACHED;\r\nif (rp) {\r\nlunm_list[free_index].lp_tag = bfa_lps_get_tag_from_pid(bfa,\r\nrp->rport_info.local_pid);\r\nlunm_list[free_index].rp_tag = rp->rport_tag;\r\n} else {\r\nlunm_list[free_index].lp_tag = BFA_LP_TAG_INVALID;\r\nlunm_list[free_index].rp_tag = BFA_RPORT_TAG_INVALID;\r\n}\r\nlunm_list[free_index].lp_wwn = *pwwn;\r\nlunm_list[free_index].rp_wwn = rpwwn;\r\nlunm_list[free_index].lun = lun;\r\nlunm_list[free_index].state = BFA_IOIM_LUN_MASK_ACTIVE;\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif ((lunm_list[i].lp_wwn == *pwwn) &&\r\n(lunm_list[i].rp_wwn == rpwwn))\r\nlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\r\n}\r\nreturn bfa_dconf_update(bfa);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_lunmask_delete(struct bfa_s *bfa, u16 vf_id, wwn_t *pwwn,\r\nwwn_t rpwwn, struct scsi_lun lun)\r\n{\r\nstruct bfa_lun_mask_s *lunm_list;\r\nstruct bfa_rport_s *rp = NULL;\r\nstruct bfa_fcs_lport_s *port = NULL;\r\nstruct bfa_fcs_rport_s *rp_fcs;\r\nint i;\r\nif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\r\nreturn BFA_STATUS_FAILED;\r\nbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\r\nbfa_trc(bfa, *pwwn);\r\nbfa_trc(bfa, rpwwn);\r\nbfa_trc(bfa, scsilun_to_int((struct scsi_lun *)&lun));\r\nif (*pwwn == 0) {\r\nport = bfa_fcs_lookup_port(\r\n&((struct bfad_s *)bfa->bfad)->bfa_fcs,\r\nvf_id, *pwwn);\r\nif (port) {\r\n*pwwn = port->port_cfg.pwwn;\r\nrp_fcs = bfa_fcs_lport_get_rport_by_pwwn(port, rpwwn);\r\nif (rp_fcs)\r\nrp = rp_fcs->bfa_rport;\r\n}\r\n}\r\nlunm_list = bfa_get_lun_mask_list(bfa);\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif ((lunm_list[i].lp_wwn == *pwwn) &&\r\n(lunm_list[i].rp_wwn == rpwwn) &&\r\n(scsilun_to_int((struct scsi_lun *)&lunm_list[i].lun) ==\r\nscsilun_to_int((struct scsi_lun *)&lun))) {\r\nlunm_list[i].lp_wwn = 0;\r\nlunm_list[i].rp_wwn = 0;\r\nint_to_scsilun(0, &lunm_list[i].lun);\r\nlunm_list[i].state = BFA_IOIM_LUN_MASK_INACTIVE;\r\nif (lunm_list[i].rp_tag != BFA_RPORT_TAG_INVALID) {\r\nlunm_list[i].rp_tag = BFA_RPORT_TAG_INVALID;\r\nlunm_list[i].lp_tag = BFA_LP_TAG_INVALID;\r\n}\r\nreturn bfa_dconf_update(bfa);\r\n}\r\n}\r\nfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\r\nif ((lunm_list[i].lp_wwn == *pwwn) &&\r\n(lunm_list[i].rp_wwn == rpwwn))\r\nlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\r\n}\r\nreturn BFA_STATUS_ENTRY_NOT_EXISTS;\r\n}\r\nstatic void\r\n__bfa_cb_ioim_failed(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nif (!complete) {\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, BFI_IOIM_STS_ABORTED,\r\n0, 0, NULL, 0);\r\n}\r\nstatic void\r\n__bfa_cb_ioim_pathtov(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nbfa_stats(ioim->itnim, path_tov_expired);\r\nif (!complete) {\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, BFI_IOIM_STS_PATHTOV,\r\n0, 0, NULL, 0);\r\n}\r\nstatic void\r\n__bfa_cb_ioim_abort(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nif (!complete) {\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_cb_ioim_abort(ioim->bfa->bfad, ioim->dio);\r\n}\r\nstatic void\r\nbfa_ioim_sgpg_alloced(void *cbarg)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nioim->nsgpgs = BFA_SGPG_NPAGE(ioim->nsges);\r\nlist_splice_tail_init(&ioim->iosp->sgpg_wqe.sgpg_q, &ioim->sgpg_q);\r\nioim->sgpg = bfa_q_first(&ioim->sgpg_q);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_SGALLOCED);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioim_send_ioreq(struct bfa_ioim_s *ioim)\r\n{\r\nstruct bfa_itnim_s *itnim = ioim->itnim;\r\nstruct bfi_ioim_req_s *m;\r\nstatic struct fcp_cmnd_s cmnd_z0 = { { { 0 } } };\r\nstruct bfi_sge_s *sge, *sgpge;\r\nu32 pgdlen = 0;\r\nu32 fcp_dl;\r\nu64 addr;\r\nstruct scatterlist *sg;\r\nstruct bfa_sgpg_s *sgpg;\r\nstruct scsi_cmnd *cmnd = (struct scsi_cmnd *) ioim->dio;\r\nu32 i, sge_id, pgcumsz;\r\nenum dma_data_direction dmadir;\r\nm = bfa_reqq_next(ioim->bfa, ioim->reqq);\r\nif (!m) {\r\nbfa_stats(ioim->itnim, qwait);\r\nbfa_reqq_wait(ioim->bfa, ioim->reqq,\r\n&ioim->iosp->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nm->io_tag = cpu_to_be16(ioim->iotag);\r\nm->rport_hdl = ioim->itnim->rport->fw_handle;\r\nm->io_timeout = 0;\r\nsge = &m->sges[0];\r\nsgpg = ioim->sgpg;\r\nsge_id = 0;\r\nsgpge = NULL;\r\npgcumsz = 0;\r\nscsi_for_each_sg(cmnd, sg, ioim->nsges, i) {\r\nif (i == 0) {\r\naddr = bfa_sgaddr_le(sg_dma_address(sg));\r\nsge->sga = *(union bfi_addr_u *) &addr;\r\npgdlen = sg_dma_len(sg);\r\nsge->sg_len = pgdlen;\r\nsge->flags = (ioim->nsges > BFI_SGE_INLINE) ?\r\nBFI_SGE_DATA_CPL : BFI_SGE_DATA_LAST;\r\nbfa_sge_to_be(sge);\r\nsge++;\r\n} else {\r\nif (sge_id == 0)\r\nsgpge = sgpg->sgpg->sges;\r\naddr = bfa_sgaddr_le(sg_dma_address(sg));\r\nsgpge->sga = *(union bfi_addr_u *) &addr;\r\nsgpge->sg_len = sg_dma_len(sg);\r\npgcumsz += sgpge->sg_len;\r\nif (i < (ioim->nsges - 1) &&\r\nsge_id < (BFI_SGPG_DATA_SGES - 1))\r\nsgpge->flags = BFI_SGE_DATA;\r\nelse if (i < (ioim->nsges - 1))\r\nsgpge->flags = BFI_SGE_DATA_CPL;\r\nelse\r\nsgpge->flags = BFI_SGE_DATA_LAST;\r\nbfa_sge_to_le(sgpge);\r\nsgpge++;\r\nif (i == (ioim->nsges - 1)) {\r\nsgpge->flags = BFI_SGE_PGDLEN;\r\nsgpge->sga.a32.addr_lo = 0;\r\nsgpge->sga.a32.addr_hi = 0;\r\nsgpge->sg_len = pgcumsz;\r\nbfa_sge_to_le(sgpge);\r\n} else if (++sge_id == BFI_SGPG_DATA_SGES) {\r\nsgpg = (struct bfa_sgpg_s *) bfa_q_next(sgpg);\r\nsgpge->flags = BFI_SGE_LINK;\r\nsgpge->sga = sgpg->sgpg_pa;\r\nsgpge->sg_len = pgcumsz;\r\nbfa_sge_to_le(sgpge);\r\nsge_id = 0;\r\npgcumsz = 0;\r\n}\r\n}\r\n}\r\nif (ioim->nsges > BFI_SGE_INLINE) {\r\nsge->sga = ioim->sgpg->sgpg_pa;\r\n} else {\r\nsge->sga.a32.addr_lo = 0;\r\nsge->sga.a32.addr_hi = 0;\r\n}\r\nsge->sg_len = pgdlen;\r\nsge->flags = BFI_SGE_PGDLEN;\r\nbfa_sge_to_be(sge);\r\nm->cmnd = cmnd_z0;\r\nint_to_scsilun(cmnd->device->lun, &m->cmnd.lun);\r\ndmadir = cmnd->sc_data_direction;\r\nif (dmadir == DMA_TO_DEVICE)\r\nm->cmnd.iodir = FCP_IODIR_WRITE;\r\nelse if (dmadir == DMA_FROM_DEVICE)\r\nm->cmnd.iodir = FCP_IODIR_READ;\r\nelse\r\nm->cmnd.iodir = FCP_IODIR_NONE;\r\nm->cmnd.cdb = *(struct scsi_cdb_s *) cmnd->cmnd;\r\nfcp_dl = scsi_bufflen(cmnd);\r\nm->cmnd.fcp_dl = cpu_to_be32(fcp_dl);\r\nswitch (m->cmnd.iodir) {\r\ncase FCP_IODIR_READ:\r\nbfi_h2i_set(m->mh, BFI_MC_IOIM_READ, 0, bfa_fn_lpu(ioim->bfa));\r\nbfa_stats(itnim, input_reqs);\r\nioim->itnim->stats.rd_throughput += fcp_dl;\r\nbreak;\r\ncase FCP_IODIR_WRITE:\r\nbfi_h2i_set(m->mh, BFI_MC_IOIM_WRITE, 0, bfa_fn_lpu(ioim->bfa));\r\nbfa_stats(itnim, output_reqs);\r\nioim->itnim->stats.wr_throughput += fcp_dl;\r\nbreak;\r\ncase FCP_IODIR_RW:\r\nbfa_stats(itnim, input_reqs);\r\nbfa_stats(itnim, output_reqs);\r\ndefault:\r\nbfi_h2i_set(m->mh, BFI_MC_IOIM_IO, 0, bfa_fn_lpu(ioim->bfa));\r\n}\r\nif (itnim->seq_rec ||\r\n(scsi_bufflen(cmnd) & (sizeof(u32) - 1)))\r\nbfi_h2i_set(m->mh, BFI_MC_IOIM_IO, 0, bfa_fn_lpu(ioim->bfa));\r\nbfa_reqq_produce(ioim->bfa, ioim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioim_sgpg_alloc(struct bfa_ioim_s *ioim)\r\n{\r\nu16 nsgpgs;\r\nWARN_ON(ioim->nsges <= BFI_SGE_INLINE);\r\nnsgpgs = BFA_SGPG_NPAGE(ioim->nsges);\r\nif (!nsgpgs)\r\nreturn BFA_TRUE;\r\nif (bfa_sgpg_malloc(ioim->bfa, &ioim->sgpg_q, nsgpgs)\r\n!= BFA_STATUS_OK) {\r\nbfa_sgpg_wait(ioim->bfa, &ioim->iosp->sgpg_wqe, nsgpgs);\r\nreturn BFA_FALSE;\r\n}\r\nioim->nsgpgs = nsgpgs;\r\nioim->sgpg = bfa_q_first(&ioim->sgpg_q);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioim_send_abort(struct bfa_ioim_s *ioim)\r\n{\r\nstruct bfi_ioim_abort_req_s *m;\r\nenum bfi_ioim_h2i msgop;\r\nm = bfa_reqq_next(ioim->bfa, ioim->reqq);\r\nif (!m)\r\nreturn BFA_FALSE;\r\nif (ioim->iosp->abort_explicit)\r\nmsgop = BFI_IOIM_H2I_IOABORT_REQ;\r\nelse\r\nmsgop = BFI_IOIM_H2I_IOCLEANUP_REQ;\r\nbfi_h2i_set(m->mh, BFI_MC_IOIM, msgop, bfa_fn_lpu(ioim->bfa));\r\nm->io_tag = cpu_to_be16(ioim->iotag);\r\nm->abort_tag = ++ioim->abort_tag;\r\nbfa_reqq_produce(ioim->bfa, ioim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_ioim_qresume(void *cbarg)\r\n{\r\nstruct bfa_ioim_s *ioim = cbarg;\r\nbfa_stats(ioim->itnim, qresumes);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_QRESUME);\r\n}\r\nstatic void\r\nbfa_ioim_notify_cleanup(struct bfa_ioim_s *ioim)\r\n{\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\r\nif (!ioim->iosp->tskim) {\r\nif (ioim->fcpim->delay_comp && ioim->itnim->iotov_active) {\r\nbfa_cb_dequeue(&ioim->hcb_qe);\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &ioim->itnim->delay_comp_q);\r\n}\r\nbfa_itnim_iodone(ioim->itnim);\r\n} else\r\nbfa_wc_down(&ioim->iosp->tskim->wc);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioim_is_abortable(struct bfa_ioim_s *ioim)\r\n{\r\nif ((bfa_sm_cmp_state(ioim, bfa_ioim_sm_uninit) &&\r\n(!bfa_q_is_on_q(&ioim->itnim->pending_q, ioim))) ||\r\n(bfa_sm_cmp_state(ioim, bfa_ioim_sm_abort)) ||\r\n(bfa_sm_cmp_state(ioim, bfa_ioim_sm_abort_qfull)) ||\r\n(bfa_sm_cmp_state(ioim, bfa_ioim_sm_hcb)) ||\r\n(bfa_sm_cmp_state(ioim, bfa_ioim_sm_hcb_free)) ||\r\n(bfa_sm_cmp_state(ioim, bfa_ioim_sm_resfree)))\r\nreturn BFA_FALSE;\r\nreturn BFA_TRUE;\r\n}\r\nvoid\r\nbfa_ioim_delayed_comp(struct bfa_ioim_s *ioim, bfa_boolean_t iotov)\r\n{\r\nif (iotov)\r\nioim->io_cbfn = __bfa_cb_ioim_pathtov;\r\nelse {\r\nioim->io_cbfn = __bfa_cb_ioim_failed;\r\nbfa_stats(ioim->itnim, iocom_nexus_abort);\r\n}\r\nbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\r\n}\r\nvoid\r\nbfa_ioim_attach(struct bfa_fcpim_s *fcpim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nstruct bfa_fcp_mod_s *fcp = fcpim->fcp;\r\nstruct bfa_ioim_sp_s *iosp;\r\nu16 i;\r\nioim = (struct bfa_ioim_s *) bfa_mem_kva_curp(fcp);\r\nfcpim->ioim_arr = ioim;\r\nbfa_mem_kva_curp(fcp) = (u8 *) (ioim + fcpim->fcp->num_ioim_reqs);\r\niosp = (struct bfa_ioim_sp_s *) bfa_mem_kva_curp(fcp);\r\nfcpim->ioim_sp_arr = iosp;\r\nbfa_mem_kva_curp(fcp) = (u8 *) (iosp + fcpim->fcp->num_ioim_reqs);\r\nINIT_LIST_HEAD(&fcpim->ioim_resfree_q);\r\nINIT_LIST_HEAD(&fcpim->ioim_comp_q);\r\nfor (i = 0; i < fcpim->fcp->num_ioim_reqs;\r\ni++, ioim++, iosp++) {\r\nmemset(ioim, 0, sizeof(struct bfa_ioim_s));\r\nioim->iotag = i;\r\nioim->bfa = fcpim->bfa;\r\nioim->fcpim = fcpim;\r\nioim->iosp = iosp;\r\nINIT_LIST_HEAD(&ioim->sgpg_q);\r\nbfa_reqq_winit(&ioim->iosp->reqq_wait,\r\nbfa_ioim_qresume, ioim);\r\nbfa_sgpg_winit(&ioim->iosp->sgpg_wqe,\r\nbfa_ioim_sgpg_alloced, ioim);\r\nbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\r\n}\r\n}\r\nvoid\r\nbfa_ioim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfi_ioim_rsp_s *rsp = (struct bfi_ioim_rsp_s *) m;\r\nstruct bfa_ioim_s *ioim;\r\nu16 iotag;\r\nenum bfa_ioim_event evt = BFA_IOIM_SM_COMP;\r\niotag = be16_to_cpu(rsp->io_tag);\r\nioim = BFA_IOIM_FROM_TAG(fcpim, iotag);\r\nWARN_ON(ioim->iotag != iotag);\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_trc(ioim->bfa, rsp->io_status);\r\nbfa_trc(ioim->bfa, rsp->reuse_io_tag);\r\nif (bfa_sm_cmp_state(ioim, bfa_ioim_sm_active))\r\nioim->iosp->comp_rspmsg = *m;\r\nswitch (rsp->io_status) {\r\ncase BFI_IOIM_STS_OK:\r\nbfa_stats(ioim->itnim, iocomp_ok);\r\nif (rsp->reuse_io_tag == 0)\r\nevt = BFA_IOIM_SM_DONE;\r\nelse\r\nevt = BFA_IOIM_SM_COMP;\r\nbreak;\r\ncase BFI_IOIM_STS_TIMEDOUT:\r\nbfa_stats(ioim->itnim, iocomp_timedout);\r\ncase BFI_IOIM_STS_ABORTED:\r\nrsp->io_status = BFI_IOIM_STS_ABORTED;\r\nbfa_stats(ioim->itnim, iocomp_aborted);\r\nif (rsp->reuse_io_tag == 0)\r\nevt = BFA_IOIM_SM_DONE;\r\nelse\r\nevt = BFA_IOIM_SM_COMP;\r\nbreak;\r\ncase BFI_IOIM_STS_PROTO_ERR:\r\nbfa_stats(ioim->itnim, iocom_proto_err);\r\nWARN_ON(!rsp->reuse_io_tag);\r\nevt = BFA_IOIM_SM_COMP;\r\nbreak;\r\ncase BFI_IOIM_STS_SQER_NEEDED:\r\nbfa_stats(ioim->itnim, iocom_sqer_needed);\r\nWARN_ON(rsp->reuse_io_tag != 0);\r\nevt = BFA_IOIM_SM_SQRETRY;\r\nbreak;\r\ncase BFI_IOIM_STS_RES_FREE:\r\nbfa_stats(ioim->itnim, iocom_res_free);\r\nevt = BFA_IOIM_SM_FREE;\r\nbreak;\r\ncase BFI_IOIM_STS_HOST_ABORTED:\r\nbfa_stats(ioim->itnim, iocom_hostabrts);\r\nif (rsp->abort_tag != ioim->abort_tag) {\r\nbfa_trc(ioim->bfa, rsp->abort_tag);\r\nbfa_trc(ioim->bfa, ioim->abort_tag);\r\nreturn;\r\n}\r\nif (rsp->reuse_io_tag)\r\nevt = BFA_IOIM_SM_ABORT_COMP;\r\nelse\r\nevt = BFA_IOIM_SM_ABORT_DONE;\r\nbreak;\r\ncase BFI_IOIM_STS_UTAG:\r\nbfa_stats(ioim->itnim, iocom_utags);\r\nevt = BFA_IOIM_SM_COMP_UTAG;\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nbfa_sm_send_event(ioim, evt);\r\n}\r\nvoid\r\nbfa_ioim_good_comp_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfi_ioim_rsp_s *rsp = (struct bfi_ioim_rsp_s *) m;\r\nstruct bfa_ioim_s *ioim;\r\nu16 iotag;\r\niotag = be16_to_cpu(rsp->io_tag);\r\nioim = BFA_IOIM_FROM_TAG(fcpim, iotag);\r\nWARN_ON(ioim->iotag != iotag);\r\nbfa_ioim_cb_profile_comp(fcpim, ioim);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_COMP_GOOD);\r\n}\r\nvoid\r\nbfa_ioim_cleanup(struct bfa_ioim_s *ioim)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_stats(ioim->itnim, io_cleanups);\r\nioim->iosp->tskim = NULL;\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_CLEANUP);\r\n}\r\nvoid\r\nbfa_ioim_cleanup_tm(struct bfa_ioim_s *ioim, struct bfa_tskim_s *tskim)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_stats(ioim->itnim, io_tmaborts);\r\nioim->iosp->tskim = tskim;\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_CLEANUP);\r\n}\r\nvoid\r\nbfa_ioim_iocdisable(struct bfa_ioim_s *ioim)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_stats(ioim->itnim, io_iocdowns);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_HWFAIL);\r\n}\r\nvoid\r\nbfa_ioim_tov(struct bfa_ioim_s *ioim)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_IOTOV);\r\n}\r\nstruct bfa_ioim_s *\r\nbfa_ioim_alloc(struct bfa_s *bfa, struct bfad_ioim_s *dio,\r\nstruct bfa_itnim_s *itnim, u16 nsges)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfa_ioim_s *ioim;\r\nstruct bfa_iotag_s *iotag = NULL;\r\nbfa_q_deq(&fcpim->fcp->iotag_ioim_free_q, &iotag);\r\nif (!iotag) {\r\nbfa_stats(itnim, no_iotags);\r\nreturn NULL;\r\n}\r\nioim = BFA_IOIM_FROM_TAG(fcpim, iotag->tag);\r\nioim->dio = dio;\r\nioim->itnim = itnim;\r\nioim->nsges = nsges;\r\nioim->nsgpgs = 0;\r\nbfa_stats(itnim, total_ios);\r\nfcpim->ios_active++;\r\nlist_add_tail(&ioim->qe, &itnim->io_q);\r\nreturn ioim;\r\n}\r\nvoid\r\nbfa_ioim_free(struct bfa_ioim_s *ioim)\r\n{\r\nstruct bfa_fcpim_s *fcpim = ioim->fcpim;\r\nstruct bfa_iotag_s *iotag;\r\nif (ioim->nsgpgs > 0)\r\nbfa_sgpg_mfree(ioim->bfa, &ioim->sgpg_q, ioim->nsgpgs);\r\nbfa_stats(ioim->itnim, io_comps);\r\nfcpim->ios_active--;\r\nioim->iotag &= BFA_IOIM_IOTAG_MASK;\r\nWARN_ON(!(ioim->iotag <\r\n(fcpim->fcp->num_ioim_reqs + fcpim->fcp->num_fwtio_reqs)));\r\niotag = BFA_IOTAG_FROM_TAG(fcpim->fcp, ioim->iotag);\r\nif (ioim->iotag < fcpim->fcp->num_ioim_reqs)\r\nlist_add_tail(&iotag->qe, &fcpim->fcp->iotag_ioim_free_q);\r\nelse\r\nlist_add_tail(&iotag->qe, &fcpim->fcp->iotag_tio_free_q);\r\nlist_del(&ioim->qe);\r\n}\r\nvoid\r\nbfa_ioim_start(struct bfa_ioim_s *ioim)\r\n{\r\nbfa_ioim_cb_profile_start(ioim->fcpim, ioim);\r\nioim->reqq = bfa_fcpim_ioredirect_enabled(ioim->bfa) ?\r\nBFA_FALSE : bfa_itnim_get_reqq(ioim);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_START);\r\n}\r\nbfa_status_t\r\nbfa_ioim_abort(struct bfa_ioim_s *ioim)\r\n{\r\nbfa_trc(ioim->bfa, ioim->iotag);\r\nif (!bfa_ioim_is_abortable(ioim))\r\nreturn BFA_STATUS_FAILED;\r\nbfa_stats(ioim->itnim, io_aborts);\r\nbfa_sm_send_event(ioim, BFA_IOIM_SM_ABORT);\r\nreturn BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_tskim_sm_uninit(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_START:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_active);\r\nbfa_tskim_gather_ios(tskim);\r\nif (!bfa_itnim_is_online(tskim->itnim)) {\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\r\ntskim->tsk_status = BFI_TSKIM_STS_OK;\r\nbfa_tskim_cleanup_ios(tskim);\r\nreturn;\r\n}\r\nif (!bfa_tskim_send(tskim)) {\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_qfull);\r\nbfa_stats(tskim->itnim, tm_qwait);\r\nbfa_reqq_wait(tskim->bfa, tskim->itnim->reqq,\r\n&tskim->reqq_wait);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_active(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_DONE:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\r\nbfa_tskim_cleanup_ios(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_CLEANUP:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup);\r\nif (!bfa_tskim_send_abort(tskim)) {\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup_qfull);\r\nbfa_stats(tskim->itnim, tm_qwait);\r\nbfa_reqq_wait(tskim->bfa, tskim->itnim->reqq,\r\n&tskim->reqq_wait);\r\n}\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_tskim_iocdisable_ios(tskim);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_cleanup(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_DONE:\r\nbreak;\r\ncase BFA_TSKIM_SM_UTAG:\r\ncase BFA_TSKIM_SM_CLEANUP_DONE:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\r\nbfa_tskim_cleanup_ios(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_tskim_iocdisable_ios(tskim);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_iocleanup(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_IOS_DONE:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_done);\r\nbreak;\r\ncase BFA_TSKIM_SM_CLEANUP:\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_tskim_iocdisable_ios(tskim);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_qfull(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_QRESUME:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_active);\r\nbfa_tskim_send(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_CLEANUP:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\r\nbfa_reqq_wcancel(&tskim->reqq_wait);\r\nbfa_tskim_cleanup_ios(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_reqq_wcancel(&tskim->reqq_wait);\r\nbfa_tskim_iocdisable_ios(tskim);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_cleanup_qfull(struct bfa_tskim_s *tskim,\r\nenum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_DONE:\r\nbfa_reqq_wcancel(&tskim->reqq_wait);\r\ncase BFA_TSKIM_SM_QRESUME:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup);\r\nbfa_tskim_send_abort(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\r\nbfa_reqq_wcancel(&tskim->reqq_wait);\r\nbfa_tskim_iocdisable_ios(tskim);\r\nbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_sm_hcb(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\r\n{\r\nbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\r\nswitch (event) {\r\ncase BFA_TSKIM_SM_HCB:\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_uninit);\r\nbfa_tskim_free(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_CLEANUP:\r\nbfa_tskim_notify_comp(tskim);\r\nbreak;\r\ncase BFA_TSKIM_SM_HWFAIL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(tskim->bfa, event);\r\n}\r\n}\r\nstatic void\r\n__bfa_cb_tskim_done(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_tskim_s *tskim = cbarg;\r\nif (!complete) {\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_stats(tskim->itnim, tm_success);\r\nbfa_cb_tskim_done(tskim->bfa->bfad, tskim->dtsk, tskim->tsk_status);\r\n}\r\nstatic void\r\n__bfa_cb_tskim_failed(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_tskim_s *tskim = cbarg;\r\nif (!complete) {\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_HCB);\r\nreturn;\r\n}\r\nbfa_stats(tskim->itnim, tm_failures);\r\nbfa_cb_tskim_done(tskim->bfa->bfad, tskim->dtsk,\r\nBFI_TSKIM_STS_FAILED);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_tskim_match_scope(struct bfa_tskim_s *tskim, struct scsi_lun lun)\r\n{\r\nswitch (tskim->tm_cmnd) {\r\ncase FCP_TM_TARGET_RESET:\r\nreturn BFA_TRUE;\r\ncase FCP_TM_ABORT_TASK_SET:\r\ncase FCP_TM_CLEAR_TASK_SET:\r\ncase FCP_TM_LUN_RESET:\r\ncase FCP_TM_CLEAR_ACA:\r\nreturn !memcmp(&tskim->lun, &lun, sizeof(lun));\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nreturn BFA_FALSE;\r\n}\r\nstatic void\r\nbfa_tskim_gather_ios(struct bfa_tskim_s *tskim)\r\n{\r\nstruct bfa_itnim_s *itnim = tskim->itnim;\r\nstruct bfa_ioim_s *ioim;\r\nstruct list_head *qe, *qen;\r\nstruct scsi_cmnd *cmnd;\r\nstruct scsi_lun scsilun;\r\nINIT_LIST_HEAD(&tskim->io_q);\r\nlist_for_each_safe(qe, qen, &itnim->io_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\ncmnd = (struct scsi_cmnd *) ioim->dio;\r\nint_to_scsilun(cmnd->device->lun, &scsilun);\r\nif (bfa_tskim_match_scope(tskim, scsilun)) {\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &tskim->io_q);\r\n}\r\n}\r\nlist_for_each_safe(qe, qen, &itnim->pending_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\ncmnd = (struct scsi_cmnd *) ioim->dio;\r\nint_to_scsilun(cmnd->device->lun, &scsilun);\r\nif (bfa_tskim_match_scope(tskim, scsilun)) {\r\nlist_del(&ioim->qe);\r\nlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\r\nbfa_ioim_tov(ioim);\r\n}\r\n}\r\n}\r\nstatic void\r\nbfa_tskim_cleanp_comp(void *tskim_cbarg)\r\n{\r\nstruct bfa_tskim_s *tskim = tskim_cbarg;\r\nbfa_stats(tskim->itnim, tm_io_comps);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_IOS_DONE);\r\n}\r\nstatic void\r\nbfa_tskim_cleanup_ios(struct bfa_tskim_s *tskim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nstruct list_head *qe, *qen;\r\nbfa_wc_init(&tskim->wc, bfa_tskim_cleanp_comp, tskim);\r\nlist_for_each_safe(qe, qen, &tskim->io_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nbfa_wc_up(&tskim->wc);\r\nbfa_ioim_cleanup_tm(ioim, tskim);\r\n}\r\nbfa_wc_wait(&tskim->wc);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_tskim_send(struct bfa_tskim_s *tskim)\r\n{\r\nstruct bfa_itnim_s *itnim = tskim->itnim;\r\nstruct bfi_tskim_req_s *m;\r\nm = bfa_reqq_next(tskim->bfa, itnim->reqq);\r\nif (!m)\r\nreturn BFA_FALSE;\r\nbfi_h2i_set(m->mh, BFI_MC_TSKIM, BFI_TSKIM_H2I_TM_REQ,\r\nbfa_fn_lpu(tskim->bfa));\r\nm->tsk_tag = cpu_to_be16(tskim->tsk_tag);\r\nm->itn_fhdl = tskim->itnim->rport->fw_handle;\r\nm->t_secs = tskim->tsecs;\r\nm->lun = tskim->lun;\r\nm->tm_flags = tskim->tm_cmnd;\r\nbfa_reqq_produce(tskim->bfa, itnim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_tskim_send_abort(struct bfa_tskim_s *tskim)\r\n{\r\nstruct bfa_itnim_s *itnim = tskim->itnim;\r\nstruct bfi_tskim_abortreq_s *m;\r\nm = bfa_reqq_next(tskim->bfa, itnim->reqq);\r\nif (!m)\r\nreturn BFA_FALSE;\r\nbfi_h2i_set(m->mh, BFI_MC_TSKIM, BFI_TSKIM_H2I_ABORT_REQ,\r\nbfa_fn_lpu(tskim->bfa));\r\nm->tsk_tag = cpu_to_be16(tskim->tsk_tag);\r\nbfa_reqq_produce(tskim->bfa, itnim->reqq, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_tskim_qresume(void *cbarg)\r\n{\r\nstruct bfa_tskim_s *tskim = cbarg;\r\nbfa_stats(tskim->itnim, tm_qresumes);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_QRESUME);\r\n}\r\nstatic void\r\nbfa_tskim_iocdisable_ios(struct bfa_tskim_s *tskim)\r\n{\r\nstruct bfa_ioim_s *ioim;\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &tskim->io_q) {\r\nioim = (struct bfa_ioim_s *) qe;\r\nbfa_ioim_iocdisable(ioim);\r\n}\r\n}\r\nvoid\r\nbfa_tskim_iodone(struct bfa_tskim_s *tskim)\r\n{\r\nbfa_wc_down(&tskim->wc);\r\n}\r\nvoid\r\nbfa_tskim_iocdisable(struct bfa_tskim_s *tskim)\r\n{\r\ntskim->notify = BFA_FALSE;\r\nbfa_stats(tskim->itnim, tm_iocdowns);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_HWFAIL);\r\n}\r\nvoid\r\nbfa_tskim_cleanup(struct bfa_tskim_s *tskim)\r\n{\r\ntskim->notify = BFA_TRUE;\r\nbfa_stats(tskim->itnim, tm_cleanups);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_CLEANUP);\r\n}\r\nvoid\r\nbfa_tskim_attach(struct bfa_fcpim_s *fcpim)\r\n{\r\nstruct bfa_tskim_s *tskim;\r\nstruct bfa_fcp_mod_s *fcp = fcpim->fcp;\r\nu16 i;\r\nINIT_LIST_HEAD(&fcpim->tskim_free_q);\r\nINIT_LIST_HEAD(&fcpim->tskim_unused_q);\r\ntskim = (struct bfa_tskim_s *) bfa_mem_kva_curp(fcp);\r\nfcpim->tskim_arr = tskim;\r\nfor (i = 0; i < fcpim->num_tskim_reqs; i++, tskim++) {\r\nmemset(tskim, 0, sizeof(struct bfa_tskim_s));\r\ntskim->tsk_tag = i;\r\ntskim->bfa = fcpim->bfa;\r\ntskim->fcpim = fcpim;\r\ntskim->notify = BFA_FALSE;\r\nbfa_reqq_winit(&tskim->reqq_wait, bfa_tskim_qresume,\r\ntskim);\r\nbfa_sm_set_state(tskim, bfa_tskim_sm_uninit);\r\nlist_add_tail(&tskim->qe, &fcpim->tskim_free_q);\r\n}\r\nbfa_mem_kva_curp(fcp) = (u8 *) tskim;\r\n}\r\nvoid\r\nbfa_tskim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfi_tskim_rsp_s *rsp = (struct bfi_tskim_rsp_s *) m;\r\nstruct bfa_tskim_s *tskim;\r\nu16 tsk_tag = be16_to_cpu(rsp->tsk_tag);\r\ntskim = BFA_TSKIM_FROM_TAG(fcpim, tsk_tag);\r\nWARN_ON(tskim->tsk_tag != tsk_tag);\r\ntskim->tsk_status = rsp->tsk_status;\r\nif (rsp->tsk_status == BFI_TSKIM_STS_ABORTED) {\r\nbfa_stats(tskim->itnim, tm_cleanup_comps);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_CLEANUP_DONE);\r\n} else if (rsp->tsk_status == BFI_TSKIM_STS_UTAG) {\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_UTAG);\r\n} else {\r\nbfa_stats(tskim->itnim, tm_fw_rsps);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_DONE);\r\n}\r\n}\r\nstruct bfa_tskim_s *\r\nbfa_tskim_alloc(struct bfa_s *bfa, struct bfad_tskim_s *dtsk)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfa_tskim_s *tskim;\r\nbfa_q_deq(&fcpim->tskim_free_q, &tskim);\r\nif (tskim)\r\ntskim->dtsk = dtsk;\r\nreturn tskim;\r\n}\r\nvoid\r\nbfa_tskim_free(struct bfa_tskim_s *tskim)\r\n{\r\nWARN_ON(!bfa_q_is_on_q_func(&tskim->itnim->tsk_q, &tskim->qe));\r\nlist_del(&tskim->qe);\r\nlist_add_tail(&tskim->qe, &tskim->fcpim->tskim_free_q);\r\n}\r\nvoid\r\nbfa_tskim_start(struct bfa_tskim_s *tskim, struct bfa_itnim_s *itnim,\r\nstruct scsi_lun lun,\r\nenum fcp_tm_cmnd tm_cmnd, u8 tsecs)\r\n{\r\ntskim->itnim = itnim;\r\ntskim->lun = lun;\r\ntskim->tm_cmnd = tm_cmnd;\r\ntskim->tsecs = tsecs;\r\ntskim->notify = BFA_FALSE;\r\nbfa_stats(itnim, tm_cmnds);\r\nlist_add_tail(&tskim->qe, &itnim->tsk_q);\r\nbfa_sm_send_event(tskim, BFA_TSKIM_SM_START);\r\n}\r\nvoid\r\nbfa_tskim_res_recfg(struct bfa_s *bfa, u16 num_tskim_fw)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct list_head *qe;\r\nint i;\r\nfor (i = 0; i < (fcpim->num_tskim_reqs - num_tskim_fw); i++) {\r\nbfa_q_deq_tail(&fcpim->tskim_free_q, &qe);\r\nlist_add_tail(qe, &fcpim->tskim_unused_q);\r\n}\r\n}\r\nvoid\r\nbfa_fcp_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nstruct bfa_mem_kva_s *fcp_kva = BFA_MEM_FCP_KVA(bfa);\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu16 nsegs, idx, per_seg_ios, num_io_req;\r\nu32 km_len = 0;\r\nif (cfg->fwcfg.num_ioim_reqs &&\r\ncfg->fwcfg.num_ioim_reqs < BFA_IOIM_MIN)\r\ncfg->fwcfg.num_ioim_reqs = BFA_IOIM_MIN;\r\nelse if (cfg->fwcfg.num_ioim_reqs > BFA_IOIM_MAX)\r\ncfg->fwcfg.num_ioim_reqs = BFA_IOIM_MAX;\r\nif (cfg->fwcfg.num_fwtio_reqs > BFA_FWTIO_MAX)\r\ncfg->fwcfg.num_fwtio_reqs = BFA_FWTIO_MAX;\r\nnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\r\nif (num_io_req > BFA_IO_MAX) {\r\nif (cfg->fwcfg.num_ioim_reqs && cfg->fwcfg.num_fwtio_reqs) {\r\ncfg->fwcfg.num_ioim_reqs = BFA_IO_MAX/2;\r\ncfg->fwcfg.num_fwtio_reqs = BFA_IO_MAX/2;\r\n} else if (cfg->fwcfg.num_fwtio_reqs)\r\ncfg->fwcfg.num_fwtio_reqs = BFA_FWTIO_MAX;\r\nelse\r\ncfg->fwcfg.num_ioim_reqs = BFA_IOIM_MAX;\r\n}\r\nbfa_fcpim_meminfo(cfg, &km_len);\r\nnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\r\nkm_len += num_io_req * sizeof(struct bfa_iotag_s);\r\nkm_len += cfg->fwcfg.num_rports * sizeof(struct bfa_itn_s);\r\nnsegs = BFI_MEM_DMA_NSEGS(num_io_req, BFI_IOIM_SNSLEN);\r\nper_seg_ios = BFI_MEM_NREQS_SEG(BFI_IOIM_SNSLEN);\r\nbfa_mem_dma_seg_iter(fcp, seg_ptr, nsegs, idx) {\r\nif (num_io_req >= per_seg_ios) {\r\nnum_io_req -= per_seg_ios;\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nper_seg_ios * BFI_IOIM_SNSLEN);\r\n} else\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nnum_io_req * BFI_IOIM_SNSLEN);\r\n}\r\nbfa_mem_kva_setup(minfo, fcp_kva, km_len);\r\n}\r\nvoid\r\nbfa_fcp_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu16 idx, nsegs, num_io_req;\r\nfcp->max_ioim_reqs = cfg->fwcfg.num_ioim_reqs;\r\nfcp->num_ioim_reqs = cfg->fwcfg.num_ioim_reqs;\r\nfcp->num_fwtio_reqs = cfg->fwcfg.num_fwtio_reqs;\r\nfcp->num_itns = cfg->fwcfg.num_rports;\r\nfcp->bfa = bfa;\r\nnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\r\nnsegs = BFI_MEM_DMA_NSEGS(num_io_req, BFI_IOIM_SNSLEN);\r\nbfa_mem_dma_seg_iter(fcp, seg_ptr, nsegs, idx) {\r\nif (!bfa_mem_dma_virt(seg_ptr))\r\nbreak;\r\nfcp->snsbase[idx].pa = bfa_mem_dma_phys(seg_ptr);\r\nfcp->snsbase[idx].kva = bfa_mem_dma_virt(seg_ptr);\r\nbfa_iocfc_set_snsbase(bfa, idx, fcp->snsbase[idx].pa);\r\n}\r\nfcp->throttle_update_required = 1;\r\nbfa_fcpim_attach(fcp, bfad, cfg, pcidev);\r\nbfa_iotag_attach(fcp);\r\nfcp->itn_arr = (struct bfa_itn_s *) bfa_mem_kva_curp(fcp);\r\nbfa_mem_kva_curp(fcp) = (u8 *)fcp->itn_arr +\r\n(fcp->num_itns * sizeof(struct bfa_itn_s));\r\nmemset(fcp->itn_arr, 0,\r\n(fcp->num_itns * sizeof(struct bfa_itn_s)));\r\n}\r\nvoid\r\nbfa_fcp_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nbfa_fcpim_iocdisable(fcp);\r\n}\r\nvoid\r\nbfa_fcp_res_recfg(struct bfa_s *bfa, u16 num_ioim_fw, u16 max_ioim_fw)\r\n{\r\nstruct bfa_fcp_mod_s *mod = BFA_FCP_MOD(bfa);\r\nstruct list_head *qe;\r\nint i;\r\nif (!mod->throttle_update_required)\r\nreturn;\r\nfor (i = 0; i < (mod->num_ioim_reqs - num_ioim_fw); i++) {\r\nbfa_q_deq_tail(&mod->iotag_ioim_free_q, &qe);\r\nlist_add_tail(qe, &mod->iotag_unused_q);\r\n}\r\nif (mod->num_ioim_reqs != num_ioim_fw) {\r\nbfa_trc(bfa, mod->num_ioim_reqs);\r\nbfa_trc(bfa, num_ioim_fw);\r\n}\r\nmod->max_ioim_reqs = max_ioim_fw;\r\nmod->num_ioim_reqs = num_ioim_fw;\r\nmod->throttle_update_required = 0;\r\n}\r\nvoid\r\nbfa_itn_create(struct bfa_s *bfa, struct bfa_rport_s *rport,\r\nvoid (*isr)(struct bfa_s *bfa, struct bfi_msg_s *m))\r\n{\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nstruct bfa_itn_s *itn;\r\nitn = BFA_ITN_FROM_TAG(fcp, rport->rport_tag);\r\nitn->isr = isr;\r\n}\r\nvoid\r\nbfa_itn_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nunion bfi_itn_i2h_msg_u msg;\r\nstruct bfa_itn_s *itn;\r\nmsg.msg = m;\r\nitn = BFA_ITN_FROM_TAG(fcp, msg.create_rsp->bfa_handle);\r\nif (itn->isr)\r\nitn->isr(bfa, m);\r\nelse\r\nWARN_ON(1);\r\n}\r\nvoid\r\nbfa_iotag_attach(struct bfa_fcp_mod_s *fcp)\r\n{\r\nstruct bfa_iotag_s *iotag;\r\nu16 num_io_req, i;\r\niotag = (struct bfa_iotag_s *) bfa_mem_kva_curp(fcp);\r\nfcp->iotag_arr = iotag;\r\nINIT_LIST_HEAD(&fcp->iotag_ioim_free_q);\r\nINIT_LIST_HEAD(&fcp->iotag_tio_free_q);\r\nINIT_LIST_HEAD(&fcp->iotag_unused_q);\r\nnum_io_req = fcp->num_ioim_reqs + fcp->num_fwtio_reqs;\r\nfor (i = 0; i < num_io_req; i++, iotag++) {\r\nmemset(iotag, 0, sizeof(struct bfa_iotag_s));\r\niotag->tag = i;\r\nif (i < fcp->num_ioim_reqs)\r\nlist_add_tail(&iotag->qe, &fcp->iotag_ioim_free_q);\r\nelse\r\nlist_add_tail(&iotag->qe, &fcp->iotag_tio_free_q);\r\n}\r\nbfa_mem_kva_curp(fcp) = (u8 *) iotag;\r\n}\r\nu16\r\nbfa_fcpim_get_throttle_cfg(struct bfa_s *bfa, u16 drv_cfg_param)\r\n{\r\nu16 tmp;\r\nstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\r\nif (!fcp->throttle_update_required)\r\nreturn (u16)fcp->num_ioim_reqs;\r\ntmp = bfa_dconf_read_data_valid(bfa) ? bfa_fcpim_read_throttle(bfa) : 0;\r\nif (!tmp || (tmp > drv_cfg_param))\r\ntmp = drv_cfg_param;\r\nreturn tmp;\r\n}\r\nbfa_status_t\r\nbfa_fcpim_write_throttle(struct bfa_s *bfa, u16 value)\r\n{\r\nif (!bfa_dconf_get_min_cfg(bfa)) {\r\nBFA_DCONF_MOD(bfa)->dconf->throttle_cfg.value = value;\r\nBFA_DCONF_MOD(bfa)->dconf->throttle_cfg.is_valid = 1;\r\nreturn BFA_STATUS_OK;\r\n}\r\nreturn BFA_STATUS_FAILED;\r\n}\r\nu16\r\nbfa_fcpim_read_throttle(struct bfa_s *bfa)\r\n{\r\nstruct bfa_throttle_cfg_s *throttle_cfg =\r\n&(BFA_DCONF_MOD(bfa)->dconf->throttle_cfg);\r\nreturn ((!bfa_dconf_get_min_cfg(bfa)) ?\r\n((throttle_cfg->is_valid == 1) ? (throttle_cfg->value) : 0) : 0);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_throttle_set(struct bfa_s *bfa, u16 value)\r\n{\r\nif ((bfa_dconf_get_min_cfg(bfa) == BFA_TRUE) ||\r\n(!bfa_dconf_read_data_valid(bfa)))\r\nreturn BFA_STATUS_FAILED;\r\nbfa_fcpim_write_throttle(bfa, value);\r\nreturn bfa_dconf_update(bfa);\r\n}\r\nbfa_status_t\r\nbfa_fcpim_throttle_get(struct bfa_s *bfa, void *buf)\r\n{\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\r\nstruct bfa_defs_fcpim_throttle_s throttle;\r\nif ((bfa_dconf_get_min_cfg(bfa) == BFA_TRUE) ||\r\n(!bfa_dconf_read_data_valid(bfa)))\r\nreturn BFA_STATUS_FAILED;\r\nmemset(&throttle, 0, sizeof(struct bfa_defs_fcpim_throttle_s));\r\nthrottle.cur_value = (u16)(fcpim->fcp->num_ioim_reqs);\r\nthrottle.cfg_value = bfa_fcpim_read_throttle(bfa);\r\nif (!throttle.cfg_value)\r\nthrottle.cfg_value = throttle.cur_value;\r\nthrottle.max_value = (u16)(fcpim->fcp->max_ioim_reqs);\r\nmemcpy(buf, &throttle, sizeof(struct bfa_defs_fcpim_throttle_s));\r\nreturn BFA_STATUS_OK;\r\n}

static int uclinux_point(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, void **virt, resource_size_t *phys)\r\n{\r\nstruct map_info *map = mtd->priv;\r\n*virt = map->virt + from;\r\nif (phys)\r\n*phys = map->phys + from;\r\n*retlen = len;\r\nreturn(0);\r\n}\r\nstatic int __init uclinux_mtd_init(void)\r\n{\r\nstruct mtd_info *mtd;\r\nstruct map_info *mapp;\r\nmapp = &uclinux_ram_map;\r\nif (physaddr == -1)\r\nmapp->phys = (resource_size_t)__bss_stop;\r\nelse\r\nmapp->phys = physaddr;\r\nif (!mapp->size)\r\nmapp->size = PAGE_ALIGN(ntohl(*((unsigned long *)(mapp->phys + 8))));\r\nmapp->bankwidth = 4;\r\nprintk("uclinux[mtd]: probe address=0x%x size=0x%x\n",\r\n(int) mapp->phys, (int) mapp->size);\r\nmapp->virt = phys_to_virt(mapp->phys);\r\nif (mapp->virt == 0) {\r\nprintk("uclinux[mtd]: no virtual mapping?\n");\r\nreturn(-EIO);\r\n}\r\nsimple_map_init(mapp);\r\nmtd = do_map_probe("map_" MAP_NAME, mapp);\r\nif (!mtd) {\r\nprintk("uclinux[mtd]: failed to find a mapping?\n");\r\nreturn(-ENXIO);\r\n}\r\nmtd->owner = THIS_MODULE;\r\nmtd->_point = uclinux_point;\r\nmtd->priv = mapp;\r\nuclinux_ram_mtdinfo = mtd;\r\nmtd_device_register(mtd, uclinux_romfs, NUM_PARTITIONS);\r\nreturn(0);\r\n}

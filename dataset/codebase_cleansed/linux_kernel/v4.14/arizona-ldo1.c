static int arizona_ldo1_hc_list_voltage(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nif (selector == rdev->desc->n_voltages - 1)\r\nreturn 1800000;\r\nelse\r\nreturn rdev->desc->min_uV + (rdev->desc->uV_step * selector);\r\n}\r\nstatic int arizona_ldo1_hc_map_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nint sel;\r\nsel = DIV_ROUND_UP(min_uV - rdev->desc->min_uV, rdev->desc->uV_step);\r\nif (sel >= rdev->desc->n_voltages)\r\nsel = rdev->desc->n_voltages - 1;\r\nreturn sel;\r\n}\r\nstatic int arizona_ldo1_hc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned sel)\r\n{\r\nstruct arizona_ldo1 *ldo = rdev_get_drvdata(rdev);\r\nstruct regmap *regmap = ldo->regmap;\r\nunsigned int val;\r\nint ret;\r\nif (sel == rdev->desc->n_voltages - 1)\r\nval = ARIZONA_LDO1_HI_PWR;\r\nelse\r\nval = 0;\r\nret = regmap_update_bits(regmap, ARIZONA_LDO1_CONTROL_2,\r\nARIZONA_LDO1_HI_PWR, val);\r\nif (ret != 0)\r\nreturn ret;\r\nif (val)\r\nreturn 0;\r\nval = sel << ARIZONA_LDO1_VSEL_SHIFT;\r\nreturn regmap_update_bits(regmap, ARIZONA_LDO1_CONTROL_1,\r\nARIZONA_LDO1_VSEL_MASK, val);\r\n}\r\nstatic int arizona_ldo1_hc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct arizona_ldo1 *ldo = rdev_get_drvdata(rdev);\r\nstruct regmap *regmap = ldo->regmap;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(regmap, ARIZONA_LDO1_CONTROL_2, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nif (val & ARIZONA_LDO1_HI_PWR)\r\nreturn rdev->desc->n_voltages - 1;\r\nret = regmap_read(regmap, ARIZONA_LDO1_CONTROL_1, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn (val & ARIZONA_LDO1_VSEL_MASK) >> ARIZONA_LDO1_VSEL_SHIFT;\r\n}\r\nstatic int arizona_ldo1_of_get_pdata(struct arizona_ldo1_pdata *pdata,\r\nstruct regulator_config *config,\r\nconst struct regulator_desc *desc,\r\nbool *external_dcvdd)\r\n{\r\nstruct arizona_ldo1 *ldo1 = config->driver_data;\r\nstruct device_node *np = config->dev->of_node;\r\nstruct device_node *init_node, *dcvdd_node;\r\nstruct regulator_init_data *init_data;\r\npdata->ldoena = of_get_named_gpio(np, "wlf,ldoena", 0);\r\nif (pdata->ldoena < 0) {\r\ndev_warn(config->dev,\r\n"LDOENA GPIO property missing/malformed: %d\n",\r\npdata->ldoena);\r\npdata->ldoena = 0;\r\n} else {\r\nconfig->ena_gpio_initialized = true;\r\n}\r\ninit_node = of_get_child_by_name(np, "ldo1");\r\ndcvdd_node = of_parse_phandle(np, "DCVDD-supply", 0);\r\nif (init_node) {\r\nconfig->of_node = init_node;\r\ninit_data = of_get_regulator_init_data(config->dev, init_node,\r\ndesc);\r\nif (init_data) {\r\ninit_data->consumer_supplies = &ldo1->supply;\r\ninit_data->num_consumer_supplies = 1;\r\nif (dcvdd_node && dcvdd_node != init_node)\r\n*external_dcvdd = true;\r\npdata->init_data = init_data;\r\n}\r\n} else if (dcvdd_node) {\r\n*external_dcvdd = true;\r\n}\r\nof_node_put(dcvdd_node);\r\nreturn 0;\r\n}\r\nstatic int arizona_ldo1_common_init(struct platform_device *pdev,\r\nstruct arizona_ldo1 *ldo1,\r\nconst struct regulator_desc *desc,\r\nstruct arizona_ldo1_pdata *pdata,\r\nbool *external_dcvdd)\r\n{\r\nstruct device *parent_dev = pdev->dev.parent;\r\nstruct regulator_config config = { };\r\nint ret;\r\n*external_dcvdd = false;\r\nldo1->supply.supply = "DCVDD";\r\nldo1->init_data.consumer_supplies = &ldo1->supply;\r\nldo1->supply.dev_name = dev_name(parent_dev);\r\nconfig.dev = parent_dev;\r\nconfig.driver_data = ldo1;\r\nconfig.regmap = ldo1->regmap;\r\nif (IS_ENABLED(CONFIG_OF)) {\r\nif (!dev_get_platdata(parent_dev)) {\r\nret = arizona_ldo1_of_get_pdata(pdata,\r\n&config, desc,\r\nexternal_dcvdd);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nconfig.ena_gpio = pdata->ldoena;\r\nif (pdata->init_data)\r\nconfig.init_data = pdata->init_data;\r\nelse\r\nconfig.init_data = &ldo1->init_data;\r\nif (config.init_data->num_consumer_supplies == 0)\r\n*external_dcvdd = true;\r\nldo1->regulator = devm_regulator_register(&pdev->dev, desc, &config);\r\nof_node_put(config.of_node);\r\nif (IS_ERR(ldo1->regulator)) {\r\nret = PTR_ERR(ldo1->regulator);\r\ndev_err(&pdev->dev, "Failed to register LDO1 supply: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, ldo1);\r\nreturn 0;\r\n}\r\nstatic int arizona_ldo1_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct arizona_ldo1 *ldo1;\r\nconst struct regulator_desc *desc;\r\nbool external_dcvdd;\r\nint ret;\r\nldo1 = devm_kzalloc(&pdev->dev, sizeof(*ldo1), GFP_KERNEL);\r\nif (!ldo1)\r\nreturn -ENOMEM;\r\nldo1->regmap = arizona->regmap;\r\nswitch (arizona->type) {\r\ncase WM5102:\r\ncase WM8997:\r\ncase WM8998:\r\ncase WM1814:\r\ndesc = &arizona_ldo1_hc;\r\nldo1->init_data = arizona_ldo1_dvfs;\r\nbreak;\r\ncase WM5110:\r\ncase WM8280:\r\ndesc = &arizona_ldo1;\r\nldo1->init_data = arizona_ldo1_wm5110;\r\nbreak;\r\ndefault:\r\ndesc = &arizona_ldo1;\r\nldo1->init_data = arizona_ldo1_default;\r\nbreak;\r\n}\r\nret = arizona_ldo1_common_init(pdev, ldo1, desc,\r\n&arizona->pdata.ldo1,\r\n&external_dcvdd);\r\nif (ret == 0)\r\narizona->external_dcvdd = external_dcvdd;\r\nreturn ret;\r\n}

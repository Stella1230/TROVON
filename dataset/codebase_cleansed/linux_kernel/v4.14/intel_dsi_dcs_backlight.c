static u32 dcs_get_backlight(struct intel_connector *connector)\r\n{\r\nstruct intel_encoder *encoder = connector->encoder;\r\nstruct intel_dsi *intel_dsi = enc_to_intel_dsi(&encoder->base);\r\nstruct mipi_dsi_device *dsi_device;\r\nu8 data = 0;\r\nenum port port;\r\nfor_each_dsi_port(port, intel_dsi->dcs_backlight_ports) {\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_read(dsi_device, MIPI_DCS_GET_DISPLAY_BRIGHTNESS,\r\n&data, sizeof(data));\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nstatic void dcs_set_backlight(const struct drm_connector_state *conn_state, u32 level)\r\n{\r\nstruct intel_dsi *intel_dsi = enc_to_intel_dsi(conn_state->best_encoder);\r\nstruct mipi_dsi_device *dsi_device;\r\nu8 data = level;\r\nenum port port;\r\nfor_each_dsi_port(port, intel_dsi->dcs_backlight_ports) {\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_write(dsi_device, MIPI_DCS_SET_DISPLAY_BRIGHTNESS,\r\n&data, sizeof(data));\r\n}\r\n}\r\nstatic void dcs_disable_backlight(const struct drm_connector_state *conn_state)\r\n{\r\nstruct intel_dsi *intel_dsi = enc_to_intel_dsi(conn_state->best_encoder);\r\nstruct mipi_dsi_device *dsi_device;\r\nenum port port;\r\ndcs_set_backlight(conn_state, 0);\r\nfor_each_dsi_port(port, intel_dsi->dcs_cabc_ports) {\r\nu8 cabc = POWER_SAVE_OFF;\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_write(dsi_device, MIPI_DCS_WRITE_POWER_SAVE,\r\n&cabc, sizeof(cabc));\r\n}\r\nfor_each_dsi_port(port, intel_dsi->dcs_backlight_ports) {\r\nu8 ctrl = 0;\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_read(dsi_device, MIPI_DCS_GET_CONTROL_DISPLAY,\r\n&ctrl, sizeof(ctrl));\r\nctrl &= ~CONTROL_DISPLAY_BL;\r\nctrl &= ~CONTROL_DISPLAY_DD;\r\nctrl &= ~CONTROL_DISPLAY_BCTRL;\r\nmipi_dsi_dcs_write(dsi_device, MIPI_DCS_WRITE_CONTROL_DISPLAY,\r\n&ctrl, sizeof(ctrl));\r\n}\r\n}\r\nstatic void dcs_enable_backlight(const struct intel_crtc_state *crtc_state,\r\nconst struct drm_connector_state *conn_state)\r\n{\r\nstruct intel_dsi *intel_dsi = enc_to_intel_dsi(conn_state->best_encoder);\r\nstruct intel_panel *panel = &to_intel_connector(conn_state->connector)->panel;\r\nstruct mipi_dsi_device *dsi_device;\r\nenum port port;\r\nfor_each_dsi_port(port, intel_dsi->dcs_backlight_ports) {\r\nu8 ctrl = 0;\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_read(dsi_device, MIPI_DCS_GET_CONTROL_DISPLAY,\r\n&ctrl, sizeof(ctrl));\r\nctrl |= CONTROL_DISPLAY_BL;\r\nctrl |= CONTROL_DISPLAY_DD;\r\nctrl |= CONTROL_DISPLAY_BCTRL;\r\nmipi_dsi_dcs_write(dsi_device, MIPI_DCS_WRITE_CONTROL_DISPLAY,\r\n&ctrl, sizeof(ctrl));\r\n}\r\nfor_each_dsi_port(port, intel_dsi->dcs_cabc_ports) {\r\nu8 cabc = POWER_SAVE_MEDIUM;\r\ndsi_device = intel_dsi->dsi_hosts[port]->device;\r\nmipi_dsi_dcs_write(dsi_device, MIPI_DCS_WRITE_POWER_SAVE,\r\n&cabc, sizeof(cabc));\r\n}\r\ndcs_set_backlight(conn_state, panel->backlight.level);\r\n}\r\nstatic int dcs_setup_backlight(struct intel_connector *connector,\r\nenum pipe unused)\r\n{\r\nstruct intel_panel *panel = &connector->panel;\r\npanel->backlight.max = PANEL_PWM_MAX_VALUE;\r\npanel->backlight.level = PANEL_PWM_MAX_VALUE;\r\nreturn 0;\r\n}\r\nint intel_dsi_dcs_init_backlight_funcs(struct intel_connector *intel_connector)\r\n{\r\nstruct drm_device *dev = intel_connector->base.dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nstruct intel_encoder *encoder = intel_connector->encoder;\r\nstruct intel_panel *panel = &intel_connector->panel;\r\nif (dev_priv->vbt.backlight.type != INTEL_BACKLIGHT_DSI_DCS)\r\nreturn -ENODEV;\r\nif (WARN_ON(encoder->type != INTEL_OUTPUT_DSI))\r\nreturn -EINVAL;\r\npanel->backlight.setup = dcs_setup_backlight;\r\npanel->backlight.enable = dcs_enable_backlight;\r\npanel->backlight.disable = dcs_disable_backlight;\r\npanel->backlight.set = dcs_set_backlight;\r\npanel->backlight.get = dcs_get_backlight;\r\nreturn 0;\r\n}

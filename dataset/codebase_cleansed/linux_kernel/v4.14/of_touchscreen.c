static bool touchscreen_get_prop_u32(struct device *dev,\r\nconst char *property,\r\nunsigned int default_value,\r\nunsigned int *value)\r\n{\r\nu32 val;\r\nint error;\r\nerror = device_property_read_u32(dev, property, &val);\r\nif (error) {\r\n*value = default_value;\r\nreturn false;\r\n}\r\n*value = val;\r\nreturn true;\r\n}\r\nstatic void touchscreen_set_params(struct input_dev *dev,\r\nunsigned long axis,\r\nint max, int fuzz)\r\n{\r\nstruct input_absinfo *absinfo;\r\nif (!test_bit(axis, dev->absbit)) {\r\ndev_warn(&dev->dev,\r\n"DT specifies parameters but the axis %lu is not set up\n",\r\naxis);\r\nreturn;\r\n}\r\nabsinfo = &dev->absinfo[axis];\r\nabsinfo->maximum = max;\r\nabsinfo->fuzz = fuzz;\r\n}\r\nvoid touchscreen_parse_properties(struct input_dev *input, bool multitouch,\r\nstruct touchscreen_properties *prop)\r\n{\r\nstruct device *dev = input->dev.parent;\r\nunsigned int axis;\r\nunsigned int maximum, fuzz;\r\nbool data_present;\r\ninput_alloc_absinfo(input);\r\nif (!input->absinfo)\r\nreturn;\r\naxis = multitouch ? ABS_MT_POSITION_X : ABS_X;\r\ndata_present = touchscreen_get_prop_u32(dev, "touchscreen-size-x",\r\ninput_abs_get_max(input,\r\naxis) + 1,\r\n&maximum) |\r\ntouchscreen_get_prop_u32(dev, "touchscreen-fuzz-x",\r\ninput_abs_get_fuzz(input, axis),\r\n&fuzz);\r\nif (data_present)\r\ntouchscreen_set_params(input, axis, maximum - 1, fuzz);\r\naxis = multitouch ? ABS_MT_POSITION_Y : ABS_Y;\r\ndata_present = touchscreen_get_prop_u32(dev, "touchscreen-size-y",\r\ninput_abs_get_max(input,\r\naxis) + 1,\r\n&maximum) |\r\ntouchscreen_get_prop_u32(dev, "touchscreen-fuzz-y",\r\ninput_abs_get_fuzz(input, axis),\r\n&fuzz);\r\nif (data_present)\r\ntouchscreen_set_params(input, axis, maximum - 1, fuzz);\r\naxis = multitouch ? ABS_MT_PRESSURE : ABS_PRESSURE;\r\ndata_present = touchscreen_get_prop_u32(dev,\r\n"touchscreen-max-pressure",\r\ninput_abs_get_max(input, axis),\r\n&maximum) |\r\ntouchscreen_get_prop_u32(dev,\r\n"touchscreen-fuzz-pressure",\r\ninput_abs_get_fuzz(input, axis),\r\n&fuzz);\r\nif (data_present)\r\ntouchscreen_set_params(input, axis, maximum, fuzz);\r\nif (!prop)\r\nreturn;\r\naxis = multitouch ? ABS_MT_POSITION_X : ABS_X;\r\nprop->max_x = input_abs_get_max(input, axis);\r\nprop->max_y = input_abs_get_max(input, axis + 1);\r\nprop->invert_x =\r\ndevice_property_read_bool(dev, "touchscreen-inverted-x");\r\nprop->invert_y =\r\ndevice_property_read_bool(dev, "touchscreen-inverted-y");\r\nprop->swap_x_y =\r\ndevice_property_read_bool(dev, "touchscreen-swapped-x-y");\r\nif (prop->swap_x_y)\r\nswap(input->absinfo[axis], input->absinfo[axis + 1]);\r\n}\r\nstatic void\r\ntouchscreen_apply_prop_to_x_y(const struct touchscreen_properties *prop,\r\nunsigned int *x, unsigned int *y)\r\n{\r\nif (prop->invert_x)\r\n*x = prop->max_x - *x;\r\nif (prop->invert_y)\r\n*y = prop->max_y - *y;\r\nif (prop->swap_x_y)\r\nswap(*x, *y);\r\n}\r\nvoid touchscreen_set_mt_pos(struct input_mt_pos *pos,\r\nconst struct touchscreen_properties *prop,\r\nunsigned int x, unsigned int y)\r\n{\r\ntouchscreen_apply_prop_to_x_y(prop, &x, &y);\r\npos->x = x;\r\npos->y = y;\r\n}\r\nvoid touchscreen_report_pos(struct input_dev *input,\r\nconst struct touchscreen_properties *prop,\r\nunsigned int x, unsigned int y,\r\nbool multitouch)\r\n{\r\ntouchscreen_apply_prop_to_x_y(prop, &x, &y);\r\ninput_report_abs(input, multitouch ? ABS_MT_POSITION_X : ABS_X, x);\r\ninput_report_abs(input, multitouch ? ABS_MT_POSITION_Y : ABS_Y, y);\r\n}

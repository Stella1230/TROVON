static void dc_mouse_callback(struct mapleq *mq)\r\n{\r\nint buttons, relx, rely, relz;\r\nstruct maple_device *mapledev = mq->dev;\r\nstruct dc_mouse *mse = maple_get_drvdata(mapledev);\r\nstruct input_dev *dev = mse->dev;\r\nunsigned char *res = mq->recvbuf->buf;\r\nbuttons = ~res[8];\r\nrelx = *(unsigned short *)(res + 12) - 512;\r\nrely = *(unsigned short *)(res + 14) - 512;\r\nrelz = *(unsigned short *)(res + 16) - 512;\r\ninput_report_key(dev, BTN_LEFT, buttons & 4);\r\ninput_report_key(dev, BTN_MIDDLE, buttons & 9);\r\ninput_report_key(dev, BTN_RIGHT, buttons & 2);\r\ninput_report_rel(dev, REL_X, relx);\r\ninput_report_rel(dev, REL_Y, rely);\r\ninput_report_rel(dev, REL_WHEEL, relz);\r\ninput_sync(dev);\r\n}\r\nstatic int dc_mouse_open(struct input_dev *dev)\r\n{\r\nstruct dc_mouse *mse = maple_get_drvdata(to_maple_dev(&dev->dev));\r\nmaple_getcond_callback(mse->mdev, dc_mouse_callback, HZ/50,\r\nMAPLE_FUNC_MOUSE);\r\nreturn 0;\r\n}\r\nstatic void dc_mouse_close(struct input_dev *dev)\r\n{\r\nstruct dc_mouse *mse = maple_get_drvdata(to_maple_dev(&dev->dev));\r\nmaple_getcond_callback(mse->mdev, dc_mouse_callback, 0,\r\nMAPLE_FUNC_MOUSE);\r\n}\r\nstatic int probe_maple_mouse(struct device *dev)\r\n{\r\nstruct maple_device *mdev = to_maple_dev(dev);\r\nstruct maple_driver *mdrv = to_maple_driver(dev->driver);\r\nint error;\r\nstruct input_dev *input_dev;\r\nstruct dc_mouse *mse;\r\nmse = kzalloc(sizeof(struct dc_mouse), GFP_KERNEL);\r\nif (!mse) {\r\nerror = -ENOMEM;\r\ngoto fail;\r\n}\r\ninput_dev = input_allocate_device();\r\nif (!input_dev) {\r\nerror = -ENOMEM;\r\ngoto fail_nomem;\r\n}\r\nmse->dev = input_dev;\r\nmse->mdev = mdev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\ninput_dev->keybit[BIT_WORD(BTN_MOUSE)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_RIGHT) | BIT_MASK(BTN_MIDDLE);\r\ninput_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y) |\r\nBIT_MASK(REL_WHEEL);\r\ninput_dev->open = dc_mouse_open;\r\ninput_dev->close = dc_mouse_close;\r\ninput_dev->name = mdev->product_name;\r\ninput_dev->id.bustype = BUS_HOST;\r\nerror = input_register_device(input_dev);\r\nif (error)\r\ngoto fail_register;\r\nmdev->driver = mdrv;\r\nmaple_set_drvdata(mdev, mse);\r\nreturn error;\r\nfail_register:\r\ninput_free_device(input_dev);\r\nfail_nomem:\r\nkfree(mse);\r\nfail:\r\nreturn error;\r\n}\r\nstatic int remove_maple_mouse(struct device *dev)\r\n{\r\nstruct maple_device *mdev = to_maple_dev(dev);\r\nstruct dc_mouse *mse = maple_get_drvdata(mdev);\r\nmdev->callback = NULL;\r\ninput_unregister_device(mse->dev);\r\nmaple_set_drvdata(mdev, NULL);\r\nkfree(mse);\r\nreturn 0;\r\n}\r\nstatic int __init dc_mouse_init(void)\r\n{\r\nreturn maple_driver_register(&dc_mouse_driver);\r\n}\r\nstatic void __exit dc_mouse_exit(void)\r\n{\r\nmaple_driver_unregister(&dc_mouse_driver);\r\n}

static size_t rpc_ntop6_noscopeid(const struct sockaddr *sap,\r\nchar *buf, const int buflen)\r\n{\r\nconst struct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)sap;\r\nconst struct in6_addr *addr = &sin6->sin6_addr;\r\nif (ipv6_addr_any(addr))\r\nreturn snprintf(buf, buflen, "::");\r\nif (ipv6_addr_loopback(addr))\r\nreturn snprintf(buf, buflen, "::1");\r\nif (ipv6_addr_v4mapped(addr))\r\nreturn snprintf(buf, buflen, "::ffff:%pI4",\r\n&addr->s6_addr32[3]);\r\nreturn snprintf(buf, buflen, "%pI6c", addr);\r\n}\r\nstatic size_t rpc_ntop6(const struct sockaddr *sap,\r\nchar *buf, const size_t buflen)\r\n{\r\nconst struct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)sap;\r\nchar scopebuf[IPV6_SCOPE_ID_LEN];\r\nsize_t len;\r\nint rc;\r\nlen = rpc_ntop6_noscopeid(sap, buf, buflen);\r\nif (unlikely(len == 0))\r\nreturn len;\r\nif (!(ipv6_addr_type(&sin6->sin6_addr) & IPV6_ADDR_LINKLOCAL))\r\nreturn len;\r\nif (sin6->sin6_scope_id == 0)\r\nreturn len;\r\nrc = snprintf(scopebuf, sizeof(scopebuf), "%c%u",\r\nIPV6_SCOPE_DELIMITER, sin6->sin6_scope_id);\r\nif (unlikely((size_t)rc > sizeof(scopebuf)))\r\nreturn 0;\r\nlen += rc;\r\nif (unlikely(len > buflen))\r\nreturn 0;\r\nstrcat(buf, scopebuf);\r\nreturn len;\r\n}\r\nstatic size_t rpc_ntop6_noscopeid(const struct sockaddr *sap,\r\nchar *buf, const int buflen)\r\n{\r\nreturn 0;\r\n}\r\nstatic size_t rpc_ntop6(const struct sockaddr *sap,\r\nchar *buf, const size_t buflen)\r\n{\r\nreturn 0;\r\n}\r\nstatic int rpc_ntop4(const struct sockaddr *sap,\r\nchar *buf, const size_t buflen)\r\n{\r\nconst struct sockaddr_in *sin = (struct sockaddr_in *)sap;\r\nreturn snprintf(buf, buflen, "%pI4", &sin->sin_addr);\r\n}\r\nsize_t rpc_ntop(const struct sockaddr *sap, char *buf, const size_t buflen)\r\n{\r\nswitch (sap->sa_family) {\r\ncase AF_INET:\r\nreturn rpc_ntop4(sap, buf, buflen);\r\ncase AF_INET6:\r\nreturn rpc_ntop6(sap, buf, buflen);\r\n}\r\nreturn 0;\r\n}\r\nstatic size_t rpc_pton4(const char *buf, const size_t buflen,\r\nstruct sockaddr *sap, const size_t salen)\r\n{\r\nstruct sockaddr_in *sin = (struct sockaddr_in *)sap;\r\nu8 *addr = (u8 *)&sin->sin_addr.s_addr;\r\nif (buflen > INET_ADDRSTRLEN || salen < sizeof(struct sockaddr_in))\r\nreturn 0;\r\nmemset(sap, 0, sizeof(struct sockaddr_in));\r\nif (in4_pton(buf, buflen, addr, '\0', NULL) == 0)\r\nreturn 0;\r\nsin->sin_family = AF_INET;\r\nreturn sizeof(struct sockaddr_in);\r\n}\r\nstatic int rpc_parse_scope_id(struct net *net, const char *buf,\r\nconst size_t buflen, const char *delim,\r\nstruct sockaddr_in6 *sin6)\r\n{\r\nchar *p;\r\nsize_t len;\r\nif ((buf + buflen) == delim)\r\nreturn 1;\r\nif (*delim != IPV6_SCOPE_DELIMITER)\r\nreturn 0;\r\nif (!(ipv6_addr_type(&sin6->sin6_addr) & IPV6_ADDR_LINKLOCAL))\r\nreturn 0;\r\nlen = (buf + buflen) - delim - 1;\r\np = kstrndup(delim + 1, len, GFP_KERNEL);\r\nif (p) {\r\nu32 scope_id = 0;\r\nstruct net_device *dev;\r\ndev = dev_get_by_name(net, p);\r\nif (dev != NULL) {\r\nscope_id = dev->ifindex;\r\ndev_put(dev);\r\n} else {\r\nif (kstrtou32(p, 10, &scope_id) == 0) {\r\nkfree(p);\r\nreturn 0;\r\n}\r\n}\r\nkfree(p);\r\nsin6->sin6_scope_id = scope_id;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic size_t rpc_pton6(struct net *net, const char *buf, const size_t buflen,\r\nstruct sockaddr *sap, const size_t salen)\r\n{\r\nstruct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)sap;\r\nu8 *addr = (u8 *)&sin6->sin6_addr.in6_u;\r\nconst char *delim;\r\nif (buflen > (INET6_ADDRSTRLEN + IPV6_SCOPE_ID_LEN) ||\r\nsalen < sizeof(struct sockaddr_in6))\r\nreturn 0;\r\nmemset(sap, 0, sizeof(struct sockaddr_in6));\r\nif (in6_pton(buf, buflen, addr, IPV6_SCOPE_DELIMITER, &delim) == 0)\r\nreturn 0;\r\nif (!rpc_parse_scope_id(net, buf, buflen, delim, sin6))\r\nreturn 0;\r\nsin6->sin6_family = AF_INET6;\r\nreturn sizeof(struct sockaddr_in6);\r\n}\r\nstatic size_t rpc_pton6(struct net *net, const char *buf, const size_t buflen,\r\nstruct sockaddr *sap, const size_t salen)\r\n{\r\nreturn 0;\r\n}\r\nsize_t rpc_pton(struct net *net, const char *buf, const size_t buflen,\r\nstruct sockaddr *sap, const size_t salen)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < buflen; i++)\r\nif (buf[i] == ':')\r\nreturn rpc_pton6(net, buf, buflen, sap, salen);\r\nreturn rpc_pton4(buf, buflen, sap, salen);\r\n}\r\nchar *rpc_sockaddr2uaddr(const struct sockaddr *sap, gfp_t gfp_flags)\r\n{\r\nchar portbuf[RPCBIND_MAXUADDRPLEN];\r\nchar addrbuf[RPCBIND_MAXUADDRLEN];\r\nunsigned short port;\r\nswitch (sap->sa_family) {\r\ncase AF_INET:\r\nif (rpc_ntop4(sap, addrbuf, sizeof(addrbuf)) == 0)\r\nreturn NULL;\r\nport = ntohs(((struct sockaddr_in *)sap)->sin_port);\r\nbreak;\r\ncase AF_INET6:\r\nif (rpc_ntop6_noscopeid(sap, addrbuf, sizeof(addrbuf)) == 0)\r\nreturn NULL;\r\nport = ntohs(((struct sockaddr_in6 *)sap)->sin6_port);\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\nif (snprintf(portbuf, sizeof(portbuf),\r\n".%u.%u", port >> 8, port & 0xff) > (int)sizeof(portbuf))\r\nreturn NULL;\r\nif (strlcat(addrbuf, portbuf, sizeof(addrbuf)) > sizeof(addrbuf))\r\nreturn NULL;\r\nreturn kstrdup(addrbuf, gfp_flags);\r\n}\r\nsize_t rpc_uaddr2sockaddr(struct net *net, const char *uaddr,\r\nconst size_t uaddr_len, struct sockaddr *sap,\r\nconst size_t salen)\r\n{\r\nchar *c, buf[RPCBIND_MAXUADDRLEN + sizeof('\0')];\r\nu8 portlo, porthi;\r\nunsigned short port;\r\nif (uaddr_len > RPCBIND_MAXUADDRLEN)\r\nreturn 0;\r\nmemcpy(buf, uaddr, uaddr_len);\r\nbuf[uaddr_len] = '\0';\r\nc = strrchr(buf, '.');\r\nif (unlikely(c == NULL))\r\nreturn 0;\r\nif (unlikely(kstrtou8(c + 1, 10, &portlo) != 0))\r\nreturn 0;\r\n*c = '\0';\r\nc = strrchr(buf, '.');\r\nif (unlikely(c == NULL))\r\nreturn 0;\r\nif (unlikely(kstrtou8(c + 1, 10, &porthi) != 0))\r\nreturn 0;\r\nport = (unsigned short)((porthi << 8) | portlo);\r\n*c = '\0';\r\nif (rpc_pton(net, buf, strlen(buf), sap, salen) == 0)\r\nreturn 0;\r\nswitch (sap->sa_family) {\r\ncase AF_INET:\r\n((struct sockaddr_in *)sap)->sin_port = htons(port);\r\nreturn sizeof(struct sockaddr_in);\r\ncase AF_INET6:\r\n((struct sockaddr_in6 *)sap)->sin6_port = htons(port);\r\nreturn sizeof(struct sockaddr_in6);\r\n}\r\nreturn 0;\r\n}

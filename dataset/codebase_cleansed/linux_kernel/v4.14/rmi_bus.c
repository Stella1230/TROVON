void rmi_dbg(int flags, struct device *dev, const char *fmt, ...)\r\n{\r\nstruct va_format vaf;\r\nva_list args;\r\nif (flags & debug_flags) {\r\nva_start(args, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &args;\r\ndev_printk(KERN_DEBUG, dev, "%pV", &vaf);\r\nva_end(args);\r\n}\r\n}\r\nstatic void rmi_release_device(struct device *dev)\r\n{\r\nstruct rmi_device *rmi_dev = to_rmi_device(dev);\r\nkfree(rmi_dev);\r\n}\r\nbool rmi_is_physical_device(struct device *dev)\r\n{\r\nreturn dev->type == &rmi_device_type;\r\n}\r\nint rmi_register_transport_device(struct rmi_transport_dev *xport)\r\n{\r\nstatic atomic_t transport_device_count = ATOMIC_INIT(0);\r\nstruct rmi_device *rmi_dev;\r\nint error;\r\nrmi_dev = kzalloc(sizeof(struct rmi_device), GFP_KERNEL);\r\nif (!rmi_dev)\r\nreturn -ENOMEM;\r\ndevice_initialize(&rmi_dev->dev);\r\nrmi_dev->xport = xport;\r\nrmi_dev->number = atomic_inc_return(&transport_device_count) - 1;\r\ndev_set_name(&rmi_dev->dev, "rmi4-%02d", rmi_dev->number);\r\nrmi_dev->dev.bus = &rmi_bus_type;\r\nrmi_dev->dev.type = &rmi_device_type;\r\nxport->rmi_dev = rmi_dev;\r\nerror = device_add(&rmi_dev->dev);\r\nif (error)\r\ngoto err_put_device;\r\nrmi_dbg(RMI_DEBUG_CORE, xport->dev,\r\n"%s: Registered %s as %s.\n", __func__,\r\ndev_name(rmi_dev->xport->dev), dev_name(&rmi_dev->dev));\r\nreturn 0;\r\nerr_put_device:\r\nput_device(&rmi_dev->dev);\r\nreturn error;\r\n}\r\nvoid rmi_unregister_transport_device(struct rmi_transport_dev *xport)\r\n{\r\nstruct rmi_device *rmi_dev = xport->rmi_dev;\r\ndevice_del(&rmi_dev->dev);\r\nput_device(&rmi_dev->dev);\r\n}\r\nstatic void rmi_release_function(struct device *dev)\r\n{\r\nstruct rmi_function *fn = to_rmi_function(dev);\r\nkfree(fn);\r\n}\r\nbool rmi_is_function_device(struct device *dev)\r\n{\r\nreturn dev->type == &rmi_function_type;\r\n}\r\nstatic int rmi_function_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct rmi_function_handler *handler = to_rmi_function_handler(drv);\r\nstruct rmi_function *fn = to_rmi_function(dev);\r\nreturn fn->fd.function_number == handler->func;\r\n}\r\nstatic void rmi_function_of_probe(struct rmi_function *fn)\r\n{\r\nchar of_name[9];\r\nstruct device_node *node = fn->rmi_dev->xport->dev->of_node;\r\nsnprintf(of_name, sizeof(of_name), "rmi4-f%02x",\r\nfn->fd.function_number);\r\nfn->dev.of_node = of_get_child_by_name(node, of_name);\r\n}\r\nstatic inline void rmi_function_of_probe(struct rmi_function *fn)\r\n{}\r\nstatic int rmi_function_probe(struct device *dev)\r\n{\r\nstruct rmi_function *fn = to_rmi_function(dev);\r\nstruct rmi_function_handler *handler =\r\nto_rmi_function_handler(dev->driver);\r\nint error;\r\nrmi_function_of_probe(fn);\r\nif (handler->probe) {\r\nerror = handler->probe(fn);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rmi_function_remove(struct device *dev)\r\n{\r\nstruct rmi_function *fn = to_rmi_function(dev);\r\nstruct rmi_function_handler *handler =\r\nto_rmi_function_handler(dev->driver);\r\nif (handler->remove)\r\nhandler->remove(fn);\r\nreturn 0;\r\n}\r\nint rmi_register_function(struct rmi_function *fn)\r\n{\r\nstruct rmi_device *rmi_dev = fn->rmi_dev;\r\nint error;\r\ndevice_initialize(&fn->dev);\r\ndev_set_name(&fn->dev, "%s.fn%02x",\r\ndev_name(&rmi_dev->dev), fn->fd.function_number);\r\nfn->dev.parent = &rmi_dev->dev;\r\nfn->dev.type = &rmi_function_type;\r\nfn->dev.bus = &rmi_bus_type;\r\nerror = device_add(&fn->dev);\r\nif (error) {\r\ndev_err(&rmi_dev->dev,\r\n"Failed device_register function device %s\n",\r\ndev_name(&fn->dev));\r\ngoto err_put_device;\r\n}\r\nrmi_dbg(RMI_DEBUG_CORE, &rmi_dev->dev, "Registered F%02X.\n",\r\nfn->fd.function_number);\r\nreturn 0;\r\nerr_put_device:\r\nput_device(&fn->dev);\r\nreturn error;\r\n}\r\nvoid rmi_unregister_function(struct rmi_function *fn)\r\n{\r\nrmi_dbg(RMI_DEBUG_CORE, &fn->dev, "Unregistering F%02X.\n",\r\nfn->fd.function_number);\r\ndevice_del(&fn->dev);\r\nof_node_put(fn->dev.of_node);\r\nput_device(&fn->dev);\r\n}\r\nint __rmi_register_function_handler(struct rmi_function_handler *handler,\r\nstruct module *owner,\r\nconst char *mod_name)\r\n{\r\nstruct device_driver *driver = &handler->driver;\r\nint error;\r\ndriver->bus = &rmi_bus_type;\r\ndriver->owner = owner;\r\ndriver->mod_name = mod_name;\r\ndriver->probe = rmi_function_probe;\r\ndriver->remove = rmi_function_remove;\r\nerror = driver_register(driver);\r\nif (error) {\r\npr_err("driver_register() failed for %s, error: %d\n",\r\ndriver->name, error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nvoid rmi_unregister_function_handler(struct rmi_function_handler *handler)\r\n{\r\ndriver_unregister(&handler->driver);\r\n}\r\nstatic int rmi_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nbool physical = rmi_is_physical_device(dev);\r\nif (physical != rmi_is_physical_driver(drv))\r\nreturn 0;\r\nreturn physical || rmi_function_match(dev, drv);\r\n}\r\nstatic void __rmi_unregister_function_handlers(int start_idx)\r\n{\r\nint i;\r\nfor (i = start_idx; i >= 0; i--)\r\nrmi_unregister_function_handler(fn_handlers[i]);\r\n}\r\nstatic void rmi_unregister_function_handlers(void)\r\n{\r\n__rmi_unregister_function_handlers(ARRAY_SIZE(fn_handlers) - 1);\r\n}\r\nstatic int rmi_register_function_handlers(void)\r\n{\r\nint ret;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(fn_handlers); i++) {\r\nret = rmi_register_function_handler(fn_handlers[i]);\r\nif (ret) {\r\npr_err("%s: error registering the RMI F%02x handler: %d\n",\r\n__func__, fn_handlers[i]->func, ret);\r\ngoto err_unregister_function_handlers;\r\n}\r\n}\r\nreturn 0;\r\nerr_unregister_function_handlers:\r\n__rmi_unregister_function_handlers(i - 1);\r\nreturn ret;\r\n}\r\nint rmi_of_property_read_u32(struct device *dev, u32 *result,\r\nconst char *prop, bool optional)\r\n{\r\nint retval;\r\nu32 val = 0;\r\nretval = of_property_read_u32(dev->of_node, prop, &val);\r\nif (retval && (!optional && retval == -EINVAL)) {\r\ndev_err(dev, "Failed to get %s value: %d\n",\r\nprop, retval);\r\nreturn retval;\r\n}\r\n*result = val;\r\nreturn 0;\r\n}\r\nstatic int __init rmi_bus_init(void)\r\n{\r\nint error;\r\nerror = bus_register(&rmi_bus_type);\r\nif (error) {\r\npr_err("%s: error registering the RMI bus: %d\n",\r\n__func__, error);\r\nreturn error;\r\n}\r\nerror = rmi_register_function_handlers();\r\nif (error)\r\ngoto err_unregister_bus;\r\nerror = rmi_register_physical_driver();\r\nif (error) {\r\npr_err("%s: error registering the RMI physical driver: %d\n",\r\n__func__, error);\r\ngoto err_unregister_bus;\r\n}\r\nreturn 0;\r\nerr_unregister_bus:\r\nbus_unregister(&rmi_bus_type);\r\nreturn error;\r\n}\r\nstatic void __exit rmi_bus_exit(void)\r\n{\r\nrmi_unregister_physical_driver();\r\nrmi_unregister_function_handlers();\r\nbus_unregister(&rmi_bus_type);\r\n}

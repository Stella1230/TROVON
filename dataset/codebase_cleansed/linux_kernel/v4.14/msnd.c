int msnd_register(multisound_dev_t *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < MSND_MAX_DEVS; ++i)\r\nif (devs[i] == NULL)\r\nbreak;\r\nif (i == MSND_MAX_DEVS)\r\nreturn -ENOMEM;\r\ndevs[i] = dev;\r\n++num_devs;\r\nreturn 0;\r\n}\r\nvoid msnd_unregister(multisound_dev_t *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < MSND_MAX_DEVS; ++i)\r\nif (devs[i] == dev)\r\nbreak;\r\nif (i == MSND_MAX_DEVS) {\r\nprintk(KERN_WARNING LOGNAME ": Unregistering unknown device\n");\r\nreturn;\r\n}\r\ndevs[i] = NULL;\r\n--num_devs;\r\n}\r\nvoid msnd_init_queue(void __iomem *base, int start, int size)\r\n{\r\nwritew(PCTODSP_BASED(start), base + JQS_wStart);\r\nwritew(PCTODSP_OFFSET(size) - 1, base + JQS_wSize);\r\nwritew(0, base + JQS_wHead);\r\nwritew(0, base + JQS_wTail);\r\n}\r\nvoid msnd_fifo_init(msnd_fifo *f)\r\n{\r\nf->data = NULL;\r\n}\r\nvoid msnd_fifo_free(msnd_fifo *f)\r\n{\r\nvfree(f->data);\r\nf->data = NULL;\r\n}\r\nint msnd_fifo_alloc(msnd_fifo *f, size_t n)\r\n{\r\nmsnd_fifo_free(f);\r\nf->data = vmalloc(n);\r\nf->n = n;\r\nf->tail = 0;\r\nf->head = 0;\r\nf->len = 0;\r\nif (!f->data)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid msnd_fifo_make_empty(msnd_fifo *f)\r\n{\r\nf->len = f->tail = f->head = 0;\r\n}\r\nint msnd_fifo_write_io(msnd_fifo *f, char __iomem *buf, size_t len)\r\n{\r\nint count = 0;\r\nwhile ((count < len) && (f->len != f->n)) {\r\nint nwritten;\r\nif (f->head <= f->tail) {\r\nnwritten = len - count;\r\nif (nwritten > f->n - f->tail)\r\nnwritten = f->n - f->tail;\r\n}\r\nelse {\r\nnwritten = f->head - f->tail;\r\nif (nwritten > len - count)\r\nnwritten = len - count;\r\n}\r\nmemcpy_fromio(f->data + f->tail, buf, nwritten);\r\ncount += nwritten;\r\nbuf += nwritten;\r\nf->len += nwritten;\r\nf->tail += nwritten;\r\nf->tail %= f->n;\r\n}\r\nreturn count;\r\n}\r\nint msnd_fifo_write(msnd_fifo *f, const char *buf, size_t len)\r\n{\r\nint count = 0;\r\nwhile ((count < len) && (f->len != f->n)) {\r\nint nwritten;\r\nif (f->head <= f->tail) {\r\nnwritten = len - count;\r\nif (nwritten > f->n - f->tail)\r\nnwritten = f->n - f->tail;\r\n}\r\nelse {\r\nnwritten = f->head - f->tail;\r\nif (nwritten > len - count)\r\nnwritten = len - count;\r\n}\r\nmemcpy(f->data + f->tail, buf, nwritten);\r\ncount += nwritten;\r\nbuf += nwritten;\r\nf->len += nwritten;\r\nf->tail += nwritten;\r\nf->tail %= f->n;\r\n}\r\nreturn count;\r\n}\r\nint msnd_fifo_read_io(msnd_fifo *f, char __iomem *buf, size_t len)\r\n{\r\nint count = 0;\r\nwhile ((count < len) && (f->len > 0)) {\r\nint nread;\r\nif (f->tail <= f->head) {\r\nnread = len - count;\r\nif (nread > f->n - f->head)\r\nnread = f->n - f->head;\r\n}\r\nelse {\r\nnread = f->tail - f->head;\r\nif (nread > len - count)\r\nnread = len - count;\r\n}\r\nmemcpy_toio(buf, f->data + f->head, nread);\r\ncount += nread;\r\nbuf += nread;\r\nf->len -= nread;\r\nf->head += nread;\r\nf->head %= f->n;\r\n}\r\nreturn count;\r\n}\r\nint msnd_fifo_read(msnd_fifo *f, char *buf, size_t len)\r\n{\r\nint count = 0;\r\nwhile ((count < len) && (f->len > 0)) {\r\nint nread;\r\nif (f->tail <= f->head) {\r\nnread = len - count;\r\nif (nread > f->n - f->head)\r\nnread = f->n - f->head;\r\n}\r\nelse {\r\nnread = f->tail - f->head;\r\nif (nread > len - count)\r\nnread = len - count;\r\n}\r\nmemcpy(buf, f->data + f->head, nread);\r\ncount += nread;\r\nbuf += nread;\r\nf->len -= nread;\r\nf->head += nread;\r\nf->head %= f->n;\r\n}\r\nreturn count;\r\n}\r\nstatic int msnd_wait_TXDE(multisound_dev_t *dev)\r\n{\r\nregister unsigned int io = dev->io;\r\nregister int timeout = 1000;\r\nwhile(timeout-- > 0)\r\nif (msnd_inb(io + HP_ISR) & HPISR_TXDE)\r\nreturn 0;\r\nreturn -EIO;\r\n}\r\nstatic int msnd_wait_HC0(multisound_dev_t *dev)\r\n{\r\nregister unsigned int io = dev->io;\r\nregister int timeout = 1000;\r\nwhile(timeout-- > 0)\r\nif (!(msnd_inb(io + HP_CVR) & HPCVR_HC))\r\nreturn 0;\r\nreturn -EIO;\r\n}\r\nint msnd_send_dsp_cmd(multisound_dev_t *dev, BYTE cmd)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nif (msnd_wait_HC0(dev) == 0) {\r\nmsnd_outb(cmd, dev->io + HP_CVR);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_DEBUG LOGNAME ": Send DSP command timeout\n");\r\nreturn -EIO;\r\n}\r\nint msnd_send_word(multisound_dev_t *dev, unsigned char high,\r\nunsigned char mid, unsigned char low)\r\n{\r\nregister unsigned int io = dev->io;\r\nif (msnd_wait_TXDE(dev) == 0) {\r\nmsnd_outb(high, io + HP_TXH);\r\nmsnd_outb(mid, io + HP_TXM);\r\nmsnd_outb(low, io + HP_TXL);\r\nreturn 0;\r\n}\r\nprintk(KERN_DEBUG LOGNAME ": Send host word timeout\n");\r\nreturn -EIO;\r\n}\r\nint msnd_upload_host(multisound_dev_t *dev, char *bin, int len)\r\n{\r\nint i;\r\nif (len % 3 != 0) {\r\nprintk(KERN_WARNING LOGNAME ": Upload host data not multiple of 3!\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < len; i += 3)\r\nif (msnd_send_word(dev, bin[i], bin[i + 1], bin[i + 2]) != 0)\r\nreturn -EIO;\r\nmsnd_inb(dev->io + HP_RXL);\r\nmsnd_inb(dev->io + HP_CVR);\r\nreturn 0;\r\n}\r\nint msnd_enable_irq(multisound_dev_t *dev)\r\n{\r\nunsigned long flags;\r\nif (dev->irq_ref++)\r\nreturn 0;\r\nprintk(KERN_DEBUG LOGNAME ": Enabling IRQ\n");\r\nspin_lock_irqsave(&dev->lock, flags);\r\nif (msnd_wait_TXDE(dev) == 0) {\r\nmsnd_outb(msnd_inb(dev->io + HP_ICR) | HPICR_TREQ, dev->io + HP_ICR);\r\nif (dev->type == msndClassic)\r\nmsnd_outb(dev->irqid, dev->io + HP_IRQM);\r\nmsnd_outb(msnd_inb(dev->io + HP_ICR) & ~HPICR_TREQ, dev->io + HP_ICR);\r\nmsnd_outb(msnd_inb(dev->io + HP_ICR) | HPICR_RREQ, dev->io + HP_ICR);\r\nenable_irq(dev->irq);\r\nmsnd_init_queue(dev->DSPQ, dev->dspq_data_buff, dev->dspq_buff_size);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_DEBUG LOGNAME ": Enable IRQ failed\n");\r\nreturn -EIO;\r\n}\r\nint msnd_disable_irq(multisound_dev_t *dev)\r\n{\r\nunsigned long flags;\r\nif (--dev->irq_ref > 0)\r\nreturn 0;\r\nif (dev->irq_ref < 0)\r\nprintk(KERN_DEBUG LOGNAME ": IRQ ref count is %d\n", dev->irq_ref);\r\nprintk(KERN_DEBUG LOGNAME ": Disabling IRQ\n");\r\nspin_lock_irqsave(&dev->lock, flags);\r\nif (msnd_wait_TXDE(dev) == 0) {\r\nmsnd_outb(msnd_inb(dev->io + HP_ICR) & ~HPICR_RREQ, dev->io + HP_ICR);\r\nif (dev->type == msndClassic)\r\nmsnd_outb(HPIRQ_NONE, dev->io + HP_IRQM);\r\ndisable_irq(dev->irq);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_DEBUG LOGNAME ": Disable IRQ failed\n");\r\nreturn -EIO;\r\n}\r\nint init_module(void)\r\n{\r\nreturn 0;\r\n}\r\nvoid cleanup_module(void)\r\n{\r\n}

static void read_buff_add(u_char ch)\r\n{\r\nlast_char = ch;\r\n}\r\nstatic inline bool synth_full(void)\r\n{\r\nreturn last_char == 0x13;\r\n}\r\nstatic void do_catch_up(struct spk_synth *synth)\r\n{\r\nu_char ch;\r\nstatic u_char last = '\0';\r\nunsigned long flags;\r\nunsigned long jiff_max;\r\nstruct var_t *jiffy_delta;\r\nstruct var_t *delay_time;\r\nint jiffy_delta_val = 0;\r\nint delay_time_val = 0;\r\njiffy_delta = spk_get_var(JIFFY);\r\ndelay_time = spk_get_var(DELAY);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\njiff_max = jiffies + jiffy_delta_val;\r\nwhile (!kthread_should_stop()) {\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nif (speakup_info.flushing) {\r\nspeakup_info.flushing = 0;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nsynth->flush(synth);\r\ncontinue;\r\n}\r\nsynth_buffer_skip_nonlatin1();\r\nif (synth_buffer_empty()) {\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nbreak;\r\n}\r\nch = synth_buffer_peek();\r\nset_current_state(TASK_INTERRUPTIBLE);\r\ndelay_time_val = delay_time->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '\n')\r\nch = 0x0D;\r\nif (synth_full() || !synth->io_ops->synth_out(synth, ch)) {\r\nschedule_timeout(msecs_to_jiffies(delay_time_val));\r\ncontinue;\r\n}\r\nset_current_state(TASK_RUNNING);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nsynth_buffer_getc();\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '[') {\r\nin_escape = 1;\r\n} else if (ch == ']') {\r\nin_escape = 0;\r\n} else if (ch <= SPACE) {\r\nif (!in_escape && strchr(",.!?;:", last))\r\nsynth->io_ops->synth_out(synth, PROCSPEECH);\r\nif (time_after_eq(jiffies, jiff_max)) {\r\nif (!in_escape)\r\nsynth->io_ops->synth_out(synth, PROCSPEECH);\r\nspin_lock_irqsave(&speakup_info.spinlock,\r\nflags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\ndelay_time_val = delay_time->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock,\r\nflags);\r\nschedule_timeout(msecs_to_jiffies\r\n(delay_time_val));\r\njiff_max = jiffies + jiffy_delta_val;\r\n}\r\n}\r\nlast = ch;\r\n}\r\nif (!in_escape)\r\nsynth->io_ops->synth_out(synth, PROCSPEECH);\r\n}\r\nstatic void synth_flush(struct spk_synth *synth)\r\n{\r\nin_escape = 0;\r\nsynth->io_ops->flush_buffer();\r\nsynth->synth_immediate(synth, "\033P;10z\033\\");\r\n}

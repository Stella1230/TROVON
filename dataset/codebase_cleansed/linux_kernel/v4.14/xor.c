void\r\nxor_blocks(unsigned int src_count, unsigned int bytes, void *dest, void **srcs)\r\n{\r\nunsigned long *p1, *p2, *p3, *p4;\r\np1 = (unsigned long *) srcs[0];\r\nif (src_count == 1) {\r\nactive_template->do_2(bytes, dest, p1);\r\nreturn;\r\n}\r\np2 = (unsigned long *) srcs[1];\r\nif (src_count == 2) {\r\nactive_template->do_3(bytes, dest, p1, p2);\r\nreturn;\r\n}\r\np3 = (unsigned long *) srcs[2];\r\nif (src_count == 3) {\r\nactive_template->do_4(bytes, dest, p1, p2, p3);\r\nreturn;\r\n}\r\np4 = (unsigned long *) srcs[3];\r\nactive_template->do_5(bytes, dest, p1, p2, p3, p4);\r\n}\r\nstatic void __init\r\ndo_xor_speed(struct xor_block_template *tmpl, void *b1, void *b2)\r\n{\r\nint speed;\r\nunsigned long now, j;\r\nint i, count, max;\r\ntmpl->next = template_list;\r\ntemplate_list = tmpl;\r\npreempt_disable();\r\nmax = 0;\r\nfor (i = 0; i < 5; i++) {\r\nj = jiffies;\r\ncount = 0;\r\nwhile ((now = jiffies) == j)\r\ncpu_relax();\r\nwhile (time_before(jiffies, now + 1)) {\r\nmb();\r\ntmpl->do_2(BENCH_SIZE, b1, b2);\r\nmb();\r\ncount++;\r\nmb();\r\n}\r\nif (count > max)\r\nmax = count;\r\n}\r\npreempt_enable();\r\nspeed = max * (HZ * BENCH_SIZE / 1024);\r\ntmpl->speed = speed;\r\nprintk(KERN_INFO " %-10s: %5d.%03d MB/sec\n", tmpl->name,\r\nspeed / 1000, speed % 1000);\r\n}\r\nstatic int __init\r\ncalibrate_xor_blocks(void)\r\n{\r\nvoid *b1, *b2;\r\nstruct xor_block_template *f, *fastest;\r\nfastest = XOR_SELECT_TEMPLATE(NULL);\r\nif (fastest) {\r\nprintk(KERN_INFO "xor: automatically using best "\r\n"checksumming function %-10s\n",\r\nfastest->name);\r\ngoto out;\r\n}\r\nb1 = (void *) __get_free_pages(GFP_KERNEL | __GFP_NOTRACK, 2);\r\nif (!b1) {\r\nprintk(KERN_WARNING "xor: Yikes! No memory available.\n");\r\nreturn -ENOMEM;\r\n}\r\nb2 = b1 + 2*PAGE_SIZE + BENCH_SIZE;\r\n#define xor_speed(templ) do_xor_speed((templ), b1, b2)\r\nprintk(KERN_INFO "xor: measuring software checksum speed\n");\r\nXOR_TRY_TEMPLATES;\r\nfastest = template_list;\r\nfor (f = fastest; f; f = f->next)\r\nif (f->speed > fastest->speed)\r\nfastest = f;\r\nprintk(KERN_INFO "xor: using function: %s (%d.%03d MB/sec)\n",\r\nfastest->name, fastest->speed / 1000, fastest->speed % 1000);\r\n#undef xor_speed\r\nfree_pages((unsigned long)b1, 2);\r\nout:\r\nactive_template = fastest;\r\nreturn 0;\r\n}\r\nstatic __exit void xor_exit(void) { }

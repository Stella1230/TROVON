static void adc_keys_poll(struct input_polled_dev *dev)\r\n{\r\nstruct adc_keys_state *st = dev->private;\r\nint i, value, ret;\r\nu32 diff, closest = 0xffffffff;\r\nint keycode = 0;\r\nret = iio_read_channel_processed(st->channel, &value);\r\nif (unlikely(ret < 0)) {\r\nvalue = st->keyup_voltage;\r\n} else {\r\nfor (i = 0; i < st->num_keys; i++) {\r\ndiff = abs(st->map[i].voltage - value);\r\nif (diff < closest) {\r\nclosest = diff;\r\nkeycode = st->map[i].keycode;\r\n}\r\n}\r\n}\r\nif (abs(st->keyup_voltage - value) < closest)\r\nkeycode = 0;\r\nif (st->last_key && st->last_key != keycode)\r\ninput_report_key(dev->input, st->last_key, 0);\r\nif (keycode)\r\ninput_report_key(dev->input, keycode, 1);\r\ninput_sync(dev->input);\r\nst->last_key = keycode;\r\n}\r\nstatic int adc_keys_load_keymap(struct device *dev, struct adc_keys_state *st)\r\n{\r\nstruct adc_keys_button *map;\r\nstruct fwnode_handle *child;\r\nint i;\r\nst->num_keys = device_get_child_node_count(dev);\r\nif (st->num_keys == 0) {\r\ndev_err(dev, "keymap is missing\n");\r\nreturn -EINVAL;\r\n}\r\nmap = devm_kmalloc_array(dev, st->num_keys, sizeof(*map), GFP_KERNEL);\r\nif (!map)\r\nreturn -ENOMEM;\r\ni = 0;\r\ndevice_for_each_child_node(dev, child) {\r\nif (fwnode_property_read_u32(child, "press-threshold-microvolt",\r\n&map[i].voltage)) {\r\ndev_err(dev, "Key with invalid or missing voltage\n");\r\nfwnode_handle_put(child);\r\nreturn -EINVAL;\r\n}\r\nmap[i].voltage /= 1000;\r\nif (fwnode_property_read_u32(child, "linux,code",\r\n&map[i].keycode)) {\r\ndev_err(dev, "Key with invalid or missing linux,code\n");\r\nfwnode_handle_put(child);\r\nreturn -EINVAL;\r\n}\r\ni++;\r\n}\r\nst->map = map;\r\nreturn 0;\r\n}\r\nstatic int adc_keys_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct adc_keys_state *st;\r\nstruct input_polled_dev *poll_dev;\r\nstruct input_dev *input;\r\nenum iio_chan_type type;\r\nint i, value;\r\nint error;\r\nst = devm_kzalloc(dev, sizeof(*st), GFP_KERNEL);\r\nif (!st)\r\nreturn -ENOMEM;\r\nst->channel = devm_iio_channel_get(dev, "buttons");\r\nif (IS_ERR(st->channel))\r\nreturn PTR_ERR(st->channel);\r\nif (!st->channel->indio_dev)\r\nreturn -ENXIO;\r\nerror = iio_get_channel_type(st->channel, &type);\r\nif (error < 0)\r\nreturn error;\r\nif (type != IIO_VOLTAGE) {\r\ndev_err(dev, "Incompatible channel type %d\n", type);\r\nreturn -EINVAL;\r\n}\r\nif (device_property_read_u32(dev, "keyup-threshold-microvolt",\r\n&st->keyup_voltage)) {\r\ndev_err(dev, "Invalid or missing keyup voltage\n");\r\nreturn -EINVAL;\r\n}\r\nst->keyup_voltage /= 1000;\r\nerror = adc_keys_load_keymap(dev, st);\r\nif (error)\r\nreturn error;\r\npoll_dev = devm_input_allocate_polled_device(dev);\r\nif (!poll_dev) {\r\ndev_err(dev, "failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\nif (!device_property_read_u32(dev, "poll-interval", &value))\r\npoll_dev->poll_interval = value;\r\npoll_dev->poll = adc_keys_poll;\r\npoll_dev->private = st;\r\ninput = poll_dev->input;\r\ninput->name = pdev->name;\r\ninput->phys = "adc-keys/input0";\r\ninput->id.bustype = BUS_HOST;\r\ninput->id.vendor = 0x0001;\r\ninput->id.product = 0x0001;\r\ninput->id.version = 0x0100;\r\n__set_bit(EV_KEY, input->evbit);\r\nfor (i = 0; i < st->num_keys; i++)\r\n__set_bit(st->map[i].keycode, input->keybit);\r\nif (device_property_read_bool(dev, "autorepeat"))\r\n__set_bit(EV_REP, input->evbit);\r\nerror = input_register_polled_device(poll_dev);\r\nif (error) {\r\ndev_err(dev, "Unable to register input device: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

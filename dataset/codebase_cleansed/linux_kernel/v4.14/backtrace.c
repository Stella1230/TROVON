static void user_backtrace_fp(unsigned long __user *fp, unsigned int depth)\r\n{\r\nwhile (depth-- && access_ok(VERIFY_READ, fp, 8)) {\r\nunsigned long addr;\r\nunsigned long __user *fpnew;\r\nif (__copy_from_user_inatomic(&addr, fp + 1, sizeof(addr)))\r\nbreak;\r\naddr -= 4;\r\noprofile_add_trace(addr);\r\nif (__copy_from_user_inatomic(&fpnew, fp + 0, sizeof(fpnew)))\r\nbreak;\r\nif (fpnew >= fp)\r\nbreak;\r\nfp = fpnew;\r\n}\r\n}\r\nstatic int kernel_backtrace_frame(struct stackframe *frame, void *data)\r\n{\r\nunsigned int *depth = data;\r\noprofile_add_trace(frame->pc);\r\nif ((*depth)-- == 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid metag_backtrace(struct pt_regs * const regs, unsigned int depth)\r\n{\r\nif (user_mode(regs)) {\r\nunsigned long *fp = (unsigned long *)regs->ctx.AX[1].U0;\r\nuser_backtrace_fp((unsigned long __user __force *)fp, depth);\r\n} else {\r\nstruct stackframe frame;\r\nframe.fp = regs->ctx.AX[1].U0;\r\nframe.sp = user_stack_pointer(regs);\r\nframe.lr = 0;\r\nframe.pc = regs->ctx.CurrPC;\r\nwalk_stackframe(&frame, &kernel_backtrace_frame, &depth);\r\n}\r\n}

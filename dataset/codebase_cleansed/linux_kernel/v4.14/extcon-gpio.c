static void gpio_extcon_work(struct work_struct *work)\r\n{\r\nint state;\r\nstruct gpio_extcon_data *data =\r\ncontainer_of(to_delayed_work(work), struct gpio_extcon_data,\r\nwork);\r\nstate = gpiod_get_value_cansleep(data->id_gpiod);\r\nif (data->pdata->gpio_active_low)\r\nstate = !state;\r\nextcon_set_state_sync(data->edev, data->pdata->extcon_id, state);\r\n}\r\nstatic irqreturn_t gpio_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct gpio_extcon_data *data = dev_id;\r\nqueue_delayed_work(system_power_efficient_wq, &data->work,\r\ndata->debounce_jiffies);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int gpio_extcon_init(struct device *dev, struct gpio_extcon_data *data)\r\n{\r\nstruct gpio_extcon_pdata *pdata = data->pdata;\r\nint ret;\r\nret = devm_gpio_request_one(dev, pdata->gpio, GPIOF_DIR_IN,\r\ndev_name(dev));\r\nif (ret < 0)\r\nreturn ret;\r\ndata->id_gpiod = gpio_to_desc(pdata->gpio);\r\nif (!data->id_gpiod)\r\nreturn -EINVAL;\r\nif (pdata->debounce) {\r\nret = gpiod_set_debounce(data->id_gpiod,\r\npdata->debounce * 1000);\r\nif (ret < 0)\r\ndata->debounce_jiffies =\r\nmsecs_to_jiffies(pdata->debounce);\r\n}\r\ndata->irq = gpiod_to_irq(data->id_gpiod);\r\nif (data->irq < 0)\r\nreturn data->irq;\r\nreturn 0;\r\n}\r\nstatic int gpio_extcon_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_extcon_pdata *pdata = dev_get_platdata(&pdev->dev);\r\nstruct gpio_extcon_data *data;\r\nint ret;\r\nif (!pdata)\r\nreturn -EBUSY;\r\nif (!pdata->irq_flags || pdata->extcon_id > EXTCON_NONE)\r\nreturn -EINVAL;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct gpio_extcon_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->pdata = pdata;\r\nret = gpio_extcon_init(&pdev->dev, data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->edev = devm_extcon_dev_allocate(&pdev->dev, &pdata->extcon_id);\r\nif (IS_ERR(data->edev)) {\r\ndev_err(&pdev->dev, "failed to allocate extcon device\n");\r\nreturn -ENOMEM;\r\n}\r\nret = devm_extcon_dev_register(&pdev->dev, data->edev);\r\nif (ret < 0)\r\nreturn ret;\r\nINIT_DELAYED_WORK(&data->work, gpio_extcon_work);\r\nret = devm_request_any_context_irq(&pdev->dev, data->irq,\r\ngpio_irq_handler, pdata->irq_flags,\r\npdev->name, data);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, data);\r\ngpio_extcon_work(&data->work.work);\r\nreturn 0;\r\n}\r\nstatic int gpio_extcon_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_extcon_data *data = platform_get_drvdata(pdev);\r\ncancel_delayed_work_sync(&data->work);\r\nreturn 0;\r\n}\r\nstatic int gpio_extcon_resume(struct device *dev)\r\n{\r\nstruct gpio_extcon_data *data;\r\ndata = dev_get_drvdata(dev);\r\nif (data->pdata->check_on_resume)\r\nqueue_delayed_work(system_power_efficient_wq,\r\n&data->work, data->debounce_jiffies);\r\nreturn 0;\r\n}

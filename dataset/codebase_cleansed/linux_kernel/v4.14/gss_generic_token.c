static int\r\nder_length_size( int length)\r\n{\r\nif (length < (1<<7))\r\nreturn 1;\r\nelse if (length < (1<<8))\r\nreturn 2;\r\n#if (SIZEOF_INT == 2)\r\nelse\r\nreturn 3;\r\n#else\r\nelse if (length < (1<<16))\r\nreturn 3;\r\nelse if (length < (1<<24))\r\nreturn 4;\r\nelse\r\nreturn 5;\r\n#endif\r\n}\r\nstatic void\r\nder_write_length(unsigned char **buf, int length)\r\n{\r\nif (length < (1<<7)) {\r\n*(*buf)++ = (unsigned char) length;\r\n} else {\r\n*(*buf)++ = (unsigned char) (der_length_size(length)+127);\r\n#if (SIZEOF_INT > 2)\r\nif (length >= (1<<24))\r\n*(*buf)++ = (unsigned char) (length>>24);\r\nif (length >= (1<<16))\r\n*(*buf)++ = (unsigned char) ((length>>16)&0xff);\r\n#endif\r\nif (length >= (1<<8))\r\n*(*buf)++ = (unsigned char) ((length>>8)&0xff);\r\n*(*buf)++ = (unsigned char) (length&0xff);\r\n}\r\n}\r\nstatic int\r\nder_read_length(unsigned char **buf, int *bufsize)\r\n{\r\nunsigned char sf;\r\nint ret;\r\nif (*bufsize < 1)\r\nreturn -1;\r\nsf = *(*buf)++;\r\n(*bufsize)--;\r\nif (sf & 0x80) {\r\nif ((sf &= 0x7f) > ((*bufsize)-1))\r\nreturn -1;\r\nif (sf > SIZEOF_INT)\r\nreturn -1;\r\nret = 0;\r\nfor (; sf; sf--) {\r\nret = (ret<<8) + (*(*buf)++);\r\n(*bufsize)--;\r\n}\r\n} else {\r\nret = sf;\r\n}\r\nreturn ret;\r\n}\r\nint\r\ng_token_size(struct xdr_netobj *mech, unsigned int body_size)\r\n{\r\nbody_size += 2 + (int) mech->len;\r\nreturn 1 + der_length_size(body_size) + body_size;\r\n}\r\nvoid\r\ng_make_token_header(struct xdr_netobj *mech, int body_size, unsigned char **buf)\r\n{\r\n*(*buf)++ = 0x60;\r\nder_write_length(buf, 2 + mech->len + body_size);\r\n*(*buf)++ = 0x06;\r\n*(*buf)++ = (unsigned char) mech->len;\r\nTWRITE_STR(*buf, mech->data, ((int) mech->len));\r\n}\r\nu32\r\ng_verify_token_header(struct xdr_netobj *mech, int *body_size,\r\nunsigned char **buf_in, int toksize)\r\n{\r\nunsigned char *buf = *buf_in;\r\nint seqsize;\r\nstruct xdr_netobj toid;\r\nint ret = 0;\r\nif ((toksize-=1) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\nif (*buf++ != 0x60)\r\nreturn G_BAD_TOK_HEADER;\r\nif ((seqsize = der_read_length(&buf, &toksize)) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\nif (seqsize != toksize)\r\nreturn G_BAD_TOK_HEADER;\r\nif ((toksize-=1) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\nif (*buf++ != 0x06)\r\nreturn G_BAD_TOK_HEADER;\r\nif ((toksize-=1) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\ntoid.len = *buf++;\r\nif ((toksize-=toid.len) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\ntoid.data = buf;\r\nbuf+=toid.len;\r\nif (! g_OID_equal(&toid, mech))\r\nret = G_WRONG_MECH;\r\nif ((toksize-=2) < 0)\r\nreturn G_BAD_TOK_HEADER;\r\nif (ret)\r\nreturn ret;\r\nif (!ret) {\r\n*buf_in = buf;\r\n*body_size = toksize;\r\n}\r\nreturn ret;\r\n}

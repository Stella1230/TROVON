static int ath9k_rng_data_read(struct ath_softc *sc, u32 *buf, u32 buf_size)\r\n{\r\nint i, j;\r\nu32 v1, v2, rng_last = sc->rng_last;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nath9k_ps_wakeup(sc);\r\nREG_RMW_FIELD(ah, AR_PHY_TEST, AR_PHY_TEST_BBB_OBS_SEL, 1);\r\nREG_CLR_BIT(ah, AR_PHY_TEST, AR_PHY_TEST_RX_OBS_SEL_BIT5);\r\nREG_RMW_FIELD(ah, AR_PHY_TEST_CTL_STATUS, AR_PHY_TEST_CTL_RX_OBS_SEL, 0);\r\nfor (i = 0, j = 0; i < buf_size; i++) {\r\nv1 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;\r\nv2 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;\r\nif (v1 && v2 && rng_last != v1 && v1 != v2 && v1 != 0xffff &&\r\nv2 != 0xffff)\r\nbuf[j++] = (v1 << 16) | v2;\r\nrng_last = v2;\r\n}\r\nath9k_ps_restore(sc);\r\nsc->rng_last = rng_last;\r\nreturn j << 2;\r\n}\r\nstatic u32 ath9k_rng_delay_get(u32 fail_stats)\r\n{\r\nu32 delay;\r\nif (fail_stats < 100)\r\ndelay = 10;\r\nelse if (fail_stats < 105)\r\ndelay = 1000;\r\nelse\r\ndelay = 10000;\r\nreturn delay;\r\n}\r\nstatic int ath9k_rng_kthread(void *data)\r\n{\r\nint bytes_read;\r\nstruct ath_softc *sc = data;\r\nu32 *rng_buf;\r\nu32 delay, fail_stats = 0;\r\nrng_buf = kmalloc_array(ATH9K_RNG_BUF_SIZE, sizeof(u32), GFP_KERNEL);\r\nif (!rng_buf)\r\ngoto out;\r\nwhile (!kthread_should_stop()) {\r\nbytes_read = ath9k_rng_data_read(sc, rng_buf,\r\nATH9K_RNG_BUF_SIZE);\r\nif (unlikely(!bytes_read)) {\r\ndelay = ath9k_rng_delay_get(++fail_stats);\r\nwait_event_interruptible_timeout(rng_queue,\r\nkthread_should_stop(),\r\nmsecs_to_jiffies(delay));\r\ncontinue;\r\n}\r\nfail_stats = 0;\r\nadd_hwgenerator_randomness((void *)rng_buf, bytes_read,\r\nATH9K_RNG_ENTROPY(bytes_read));\r\n}\r\nkfree(rng_buf);\r\nout:\r\nsc->rng_task = NULL;\r\nreturn 0;\r\n}\r\nvoid ath9k_rng_start(struct ath_softc *sc)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nif (sc->rng_task)\r\nreturn;\r\nif (!AR_SREV_9300_20_OR_LATER(ah))\r\nreturn;\r\nsc->rng_task = kthread_run(ath9k_rng_kthread, sc, "ath9k-hwrng");\r\nif (IS_ERR(sc->rng_task))\r\nsc->rng_task = NULL;\r\n}\r\nvoid ath9k_rng_stop(struct ath_softc *sc)\r\n{\r\nif (sc->rng_task) {\r\nkthread_stop(sc->rng_task);\r\nsc->rng_task = NULL;\r\n}\r\n}

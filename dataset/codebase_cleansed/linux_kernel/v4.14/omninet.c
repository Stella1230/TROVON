static int omninet_calc_num_ports(struct usb_serial *serial,\r\nstruct usb_serial_endpoints *epds)\r\n{\r\nepds->bulk_out[0] = epds->bulk_out[1];\r\nepds->num_bulk_out = 1;\r\nreturn 1;\r\n}\r\nstatic int omninet_port_probe(struct usb_serial_port *port)\r\n{\r\nstruct omninet_data *od;\r\nod = kzalloc(sizeof(*od), GFP_KERNEL);\r\nif (!od)\r\nreturn -ENOMEM;\r\nusb_set_serial_port_data(port, od);\r\nreturn 0;\r\n}\r\nstatic int omninet_port_remove(struct usb_serial_port *port)\r\n{\r\nstruct omninet_data *od;\r\nod = usb_get_serial_port_data(port);\r\nkfree(od);\r\nreturn 0;\r\n}\r\nstatic void omninet_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nconst struct omninet_header *hdr = urb->transfer_buffer;\r\nconst unsigned char *data;\r\nsize_t data_len;\r\nif (urb->actual_length <= OMNINET_HEADERLEN || !hdr->oh_len)\r\nreturn;\r\ndata = (char *)urb->transfer_buffer + OMNINET_HEADERLEN;\r\ndata_len = min_t(size_t, urb->actual_length - OMNINET_HEADERLEN,\r\nhdr->oh_len);\r\ntty_insert_flip_string(&port->port, data, data_len);\r\ntty_flip_buffer_push(&port->port);\r\n}\r\nstatic int omninet_prepare_write_buffer(struct usb_serial_port *port,\r\nvoid *buf, size_t count)\r\n{\r\nstruct omninet_data *od = usb_get_serial_port_data(port);\r\nstruct omninet_header *header = buf;\r\ncount = min_t(size_t, count, OMNINET_PAYLOADSIZE);\r\ncount = kfifo_out_locked(&port->write_fifo, buf + OMNINET_HEADERLEN,\r\ncount, &port->lock);\r\nheader->oh_seq = od->od_outseq++;\r\nheader->oh_len = count;\r\nheader->oh_xxx = 0x03;\r\nheader->oh_pad = 0x00;\r\nreturn OMNINET_BULKOUTSIZE;\r\n}

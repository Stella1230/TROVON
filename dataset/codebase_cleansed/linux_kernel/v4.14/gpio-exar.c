static void exar_update(struct gpio_chip *chip, unsigned int reg, int val,\r\nunsigned int offset)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nint temp;\r\nmutex_lock(&exar_gpio->lock);\r\ntemp = readb(exar_gpio->regs + reg);\r\ntemp &= ~BIT(offset);\r\nif (val)\r\ntemp |= BIT(offset);\r\nwriteb(temp, exar_gpio->regs + reg);\r\nmutex_unlock(&exar_gpio->lock);\r\n}\r\nstatic int exar_set_direction(struct gpio_chip *chip, int direction,\r\nunsigned int offset)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nunsigned int addr = (offset + exar_gpio->first_pin) / 8 ?\r\nEXAR_OFFSET_MPIOSEL_HI : EXAR_OFFSET_MPIOSEL_LO;\r\nunsigned int bit = (offset + exar_gpio->first_pin) % 8;\r\nexar_update(chip, addr, direction, bit);\r\nreturn 0;\r\n}\r\nstatic int exar_get(struct gpio_chip *chip, unsigned int reg)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nint value;\r\nmutex_lock(&exar_gpio->lock);\r\nvalue = readb(exar_gpio->regs + reg);\r\nmutex_unlock(&exar_gpio->lock);\r\nreturn value;\r\n}\r\nstatic int exar_get_direction(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nunsigned int addr = (offset + exar_gpio->first_pin) / 8 ?\r\nEXAR_OFFSET_MPIOSEL_HI : EXAR_OFFSET_MPIOSEL_LO;\r\nunsigned int bit = (offset + exar_gpio->first_pin) % 8;\r\nreturn !!(exar_get(chip, addr) & BIT(bit));\r\n}\r\nstatic int exar_get_value(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nunsigned int addr = (offset + exar_gpio->first_pin) / 8 ?\r\nEXAR_OFFSET_MPIOLVL_HI : EXAR_OFFSET_MPIOLVL_LO;\r\nunsigned int bit = (offset + exar_gpio->first_pin) % 8;\r\nreturn !!(exar_get(chip, addr) & BIT(bit));\r\n}\r\nstatic void exar_set_value(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = gpiochip_get_data(chip);\r\nunsigned int addr = (offset + exar_gpio->first_pin) / 8 ?\r\nEXAR_OFFSET_MPIOLVL_HI : EXAR_OFFSET_MPIOLVL_LO;\r\nunsigned int bit = (offset + exar_gpio->first_pin) % 8;\r\nexar_update(chip, addr, value, bit);\r\n}\r\nstatic int exar_direction_output(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nexar_set_value(chip, offset, value);\r\nreturn exar_set_direction(chip, 0, offset);\r\n}\r\nstatic int exar_direction_input(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nreturn exar_set_direction(chip, 1, offset);\r\n}\r\nstatic int gpio_exar_probe(struct platform_device *pdev)\r\n{\r\nstruct pci_dev *pcidev = to_pci_dev(pdev->dev.parent);\r\nstruct exar_gpio_chip *exar_gpio;\r\nu32 first_pin, ngpios;\r\nvoid __iomem *p;\r\nint index, ret;\r\np = pcim_iomap_table(pcidev)[0];\r\nif (!p)\r\nreturn -ENOMEM;\r\nret = device_property_read_u32(&pdev->dev, "exar,first-pin",\r\n&first_pin);\r\nif (ret)\r\nreturn ret;\r\nret = device_property_read_u32(&pdev->dev, "ngpios", &ngpios);\r\nif (ret)\r\nreturn ret;\r\nexar_gpio = devm_kzalloc(&pdev->dev, sizeof(*exar_gpio), GFP_KERNEL);\r\nif (!exar_gpio)\r\nreturn -ENOMEM;\r\nmutex_init(&exar_gpio->lock);\r\nindex = ida_simple_get(&ida_index, 0, 0, GFP_KERNEL);\r\nsprintf(exar_gpio->name, "exar_gpio%d", index);\r\nexar_gpio->gpio_chip.label = exar_gpio->name;\r\nexar_gpio->gpio_chip.parent = &pdev->dev;\r\nexar_gpio->gpio_chip.direction_output = exar_direction_output;\r\nexar_gpio->gpio_chip.direction_input = exar_direction_input;\r\nexar_gpio->gpio_chip.get_direction = exar_get_direction;\r\nexar_gpio->gpio_chip.get = exar_get_value;\r\nexar_gpio->gpio_chip.set = exar_set_value;\r\nexar_gpio->gpio_chip.base = -1;\r\nexar_gpio->gpio_chip.ngpio = ngpios;\r\nexar_gpio->regs = p;\r\nexar_gpio->index = index;\r\nexar_gpio->first_pin = first_pin;\r\nret = devm_gpiochip_add_data(&pdev->dev,\r\n&exar_gpio->gpio_chip, exar_gpio);\r\nif (ret)\r\ngoto err_destroy;\r\nplatform_set_drvdata(pdev, exar_gpio);\r\nreturn 0;\r\nerr_destroy:\r\nida_simple_remove(&ida_index, index);\r\nmutex_destroy(&exar_gpio->lock);\r\nreturn ret;\r\n}\r\nstatic int gpio_exar_remove(struct platform_device *pdev)\r\n{\r\nstruct exar_gpio_chip *exar_gpio = platform_get_drvdata(pdev);\r\nida_simple_remove(&ida_index, exar_gpio->index);\r\nmutex_destroy(&exar_gpio->lock);\r\nreturn 0;\r\n}

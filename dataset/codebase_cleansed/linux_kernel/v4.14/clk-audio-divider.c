static int _div_round(unsigned long parent_rate, unsigned long rate,\r\nunsigned long flags)\r\n{\r\nif (flags & CLK_DIVIDER_ROUND_CLOSEST)\r\nreturn DIV_ROUND_CLOSEST_ULL((u64)parent_rate, rate);\r\nreturn DIV_ROUND_UP_ULL((u64)parent_rate, rate);\r\n}\r\nstatic int _get_val(unsigned long parent_rate, unsigned long rate)\r\n{\r\nreturn DIV_ROUND_UP_ULL((u64)parent_rate, rate) - 1;\r\n}\r\nstatic int _valid_divider(struct clk_hw *hw, int divider)\r\n{\r\nstruct meson_clk_audio_divider *adiv =\r\nto_meson_clk_audio_divider(hw);\r\nint max_divider;\r\nu8 width;\r\nwidth = adiv->div.width;\r\nmax_divider = 1 << width;\r\nreturn clamp(divider, 1, max_divider);\r\n}\r\nstatic unsigned long audio_divider_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct meson_clk_audio_divider *adiv =\r\nto_meson_clk_audio_divider(hw);\r\nstruct parm *p;\r\nunsigned long reg, divider;\r\np = &adiv->div;\r\nreg = readl(adiv->base + p->reg_off);\r\ndivider = PARM_GET(p->width, p->shift, reg) + 1;\r\nreturn DIV_ROUND_UP_ULL((u64)parent_rate, divider);\r\n}\r\nstatic long audio_divider_round_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct meson_clk_audio_divider *adiv =\r\nto_meson_clk_audio_divider(hw);\r\nunsigned long max_prate;\r\nint divider;\r\nif (!(clk_hw_get_flags(hw) & CLK_SET_RATE_PARENT)) {\r\ndivider = _div_round(*parent_rate, rate, adiv->flags);\r\ndivider = _valid_divider(hw, divider);\r\nreturn DIV_ROUND_UP_ULL((u64)*parent_rate, divider);\r\n}\r\nmax_prate = clk_hw_round_rate(clk_hw_get_parent(hw), ULONG_MAX);\r\ndivider = max_prate / rate;\r\ndivider = _valid_divider(hw, divider);\r\n*parent_rate = clk_hw_round_rate(clk_hw_get_parent(hw),\r\ndivider * rate);\r\nreturn DIV_ROUND_UP_ULL((u64)*parent_rate, divider);\r\n}\r\nstatic int audio_divider_set_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct meson_clk_audio_divider *adiv =\r\nto_meson_clk_audio_divider(hw);\r\nstruct parm *p;\r\nunsigned long reg, flags = 0;\r\nint val;\r\nval = _get_val(parent_rate, rate);\r\nif (adiv->lock)\r\nspin_lock_irqsave(adiv->lock, flags);\r\nelse\r\n__acquire(adiv->lock);\r\np = &adiv->div;\r\nreg = readl(adiv->base + p->reg_off);\r\nreg = PARM_SET(p->width, p->shift, reg, val);\r\nwritel(reg, adiv->base + p->reg_off);\r\nif (adiv->lock)\r\nspin_unlock_irqrestore(adiv->lock, flags);\r\nelse\r\n__release(adiv->lock);\r\nreturn 0;\r\n}

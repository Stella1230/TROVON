void xen_hvm_init_shared_info(void)\r\n{\r\nstruct xen_add_to_physmap xatp;\r\nxatp.domid = DOMID_SELF;\r\nxatp.idx = 0;\r\nxatp.space = XENMAPSPACE_shared_info;\r\nxatp.gpfn = shared_info_pfn;\r\nif (HYPERVISOR_memory_op(XENMEM_add_to_physmap, &xatp))\r\nBUG();\r\n}\r\nstatic void __init reserve_shared_info(void)\r\n{\r\nu64 pa;\r\nfor (pa = PAGE_SIZE;\r\n!e820__mapped_all(pa, pa + PAGE_SIZE, E820_TYPE_RAM) ||\r\nmemblock_is_reserved(pa);\r\npa += PAGE_SIZE)\r\n;\r\nshared_info_pfn = PHYS_PFN(pa);\r\nmemblock_reserve(pa, PAGE_SIZE);\r\nHYPERVISOR_shared_info = early_memremap(pa, PAGE_SIZE);\r\n}\r\nstatic void __init xen_hvm_init_mem_mapping(void)\r\n{\r\nearly_memunmap(HYPERVISOR_shared_info, PAGE_SIZE);\r\nHYPERVISOR_shared_info = __va(PFN_PHYS(shared_info_pfn));\r\n}\r\nstatic void __init init_hvm_pv_info(void)\r\n{\r\nint major, minor;\r\nuint32_t eax, ebx, ecx, edx, base;\r\nbase = xen_cpuid_base();\r\neax = cpuid_eax(base + 1);\r\nmajor = eax >> 16;\r\nminor = eax & 0xffff;\r\nprintk(KERN_INFO "Xen version %d.%d.\n", major, minor);\r\nxen_domain_type = XEN_HVM_DOMAIN;\r\nif (xen_pvh_domain())\r\npv_info.name = "Xen PVH";\r\nelse {\r\nu64 pfn;\r\nuint32_t msr;\r\npv_info.name = "Xen HVM";\r\nmsr = cpuid_ebx(base + 2);\r\npfn = __pa(hypercall_page);\r\nwrmsr_safe(msr, (u32)pfn, (u32)(pfn >> 32));\r\n}\r\nxen_setup_features();\r\ncpuid(base + 4, &eax, &ebx, &ecx, &edx);\r\nif (eax & XEN_HVM_CPUID_VCPU_ID_PRESENT)\r\nthis_cpu_write(xen_vcpu_id, ebx);\r\nelse\r\nthis_cpu_write(xen_vcpu_id, smp_processor_id());\r\n}\r\nstatic void xen_hvm_shutdown(void)\r\n{\r\nnative_machine_shutdown();\r\nif (kexec_in_progress)\r\nxen_reboot(SHUTDOWN_soft_reset);\r\n}\r\nstatic void xen_hvm_crash_shutdown(struct pt_regs *regs)\r\n{\r\nnative_machine_crash_shutdown(regs);\r\nxen_reboot(SHUTDOWN_soft_reset);\r\n}\r\nstatic int xen_cpu_up_prepare_hvm(unsigned int cpu)\r\n{\r\nint rc = 0;\r\nif (cpu_report_state(cpu) == CPU_DEAD_FROZEN) {\r\nxen_smp_intr_free(cpu);\r\nxen_uninit_lock_cpu(cpu);\r\n}\r\nif (cpu_acpi_id(cpu) != U32_MAX)\r\nper_cpu(xen_vcpu_id, cpu) = cpu_acpi_id(cpu);\r\nelse\r\nper_cpu(xen_vcpu_id, cpu) = cpu;\r\nrc = xen_vcpu_setup(cpu);\r\nif (rc)\r\nreturn rc;\r\nif (xen_have_vector_callback && xen_feature(XENFEAT_hvm_safe_pvclock))\r\nxen_setup_timer(cpu);\r\nrc = xen_smp_intr_init(cpu);\r\nif (rc) {\r\nWARN(1, "xen_smp_intr_init() for CPU %d failed: %d\n",\r\ncpu, rc);\r\n}\r\nreturn rc;\r\n}\r\nstatic int xen_cpu_dead_hvm(unsigned int cpu)\r\n{\r\nxen_smp_intr_free(cpu);\r\nif (xen_have_vector_callback && xen_feature(XENFEAT_hvm_safe_pvclock))\r\nxen_teardown_timer(cpu);\r\nreturn 0;\r\n}\r\nstatic void __init xen_hvm_guest_init(void)\r\n{\r\nif (xen_pv_domain())\r\nreturn;\r\ninit_hvm_pv_info();\r\nreserve_shared_info();\r\nxen_hvm_init_shared_info();\r\nxen_vcpu_info_reset(0);\r\nxen_panic_handler_init();\r\nif (xen_feature(XENFEAT_hvm_callback_vector))\r\nxen_have_vector_callback = 1;\r\nxen_hvm_smp_init();\r\nWARN_ON(xen_cpuhp_setup(xen_cpu_up_prepare_hvm, xen_cpu_dead_hvm));\r\nxen_unplug_emulated_devices();\r\nx86_init.irqs.intr_init = xen_init_IRQ;\r\nxen_hvm_init_time_ops();\r\nxen_hvm_init_mmu_ops();\r\nif (xen_pvh_domain())\r\nmachine_ops.emergency_restart = xen_emergency_restart;\r\n#ifdef CONFIG_KEXEC_CORE\r\nmachine_ops.shutdown = xen_hvm_shutdown;\r\nmachine_ops.crash_shutdown = xen_hvm_crash_shutdown;\r\n#endif\r\n}\r\nstatic __init int xen_parse_nopv(char *arg)\r\n{\r\nxen_nopv = true;\r\nreturn 0;\r\n}\r\nbool xen_hvm_need_lapic(void)\r\n{\r\nif (xen_nopv)\r\nreturn false;\r\nif (xen_pv_domain())\r\nreturn false;\r\nif (!xen_hvm_domain())\r\nreturn false;\r\nif (xen_feature(XENFEAT_hvm_pirqs) && xen_have_vector_callback)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic uint32_t __init xen_platform_hvm(void)\r\n{\r\nif (xen_pv_domain() || xen_nopv)\r\nreturn 0;\r\nreturn xen_cpuid_base();\r\n}

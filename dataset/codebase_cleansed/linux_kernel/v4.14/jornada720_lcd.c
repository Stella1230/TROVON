static int jornada_lcd_get_power(struct lcd_device *ld)\r\n{\r\nreturn PPSR & PPC_LDD2 ? FB_BLANK_UNBLANK : FB_BLANK_POWERDOWN;\r\n}\r\nstatic int jornada_lcd_get_contrast(struct lcd_device *ld)\r\n{\r\nint ret;\r\nif (jornada_lcd_get_power(ld) != FB_BLANK_UNBLANK)\r\nreturn 0;\r\njornada_ssp_start();\r\nif (jornada_ssp_byte(GETCONTRAST) == TXDUMMY) {\r\nret = jornada_ssp_byte(TXDUMMY);\r\ngoto success;\r\n}\r\ndev_err(&ld->dev, "failed to set contrast\n");\r\nret = -ETIMEDOUT;\r\nsuccess:\r\njornada_ssp_end();\r\nreturn ret;\r\n}\r\nstatic int jornada_lcd_set_contrast(struct lcd_device *ld, int value)\r\n{\r\nint ret = 0;\r\njornada_ssp_start();\r\nif (jornada_ssp_byte(SETCONTRAST) == TXDUMMY) {\r\nif (jornada_ssp_byte(value) == TXDUMMY)\r\ngoto success;\r\n}\r\ndev_err(&ld->dev, "failed to set contrast\n");\r\nret = -ETIMEDOUT;\r\nsuccess:\r\njornada_ssp_end();\r\nreturn ret;\r\n}\r\nstatic int jornada_lcd_set_power(struct lcd_device *ld, int power)\r\n{\r\nif (power != FB_BLANK_UNBLANK) {\r\nPPSR &= ~PPC_LDD2;\r\nPPDR |= PPC_LDD2;\r\n} else {\r\nPPSR |= PPC_LDD2;\r\n}\r\nreturn 0;\r\n}\r\nstatic int jornada_lcd_probe(struct platform_device *pdev)\r\n{\r\nstruct lcd_device *lcd_device;\r\nint ret;\r\nlcd_device = devm_lcd_device_register(&pdev->dev, S1D_DEVICENAME,\r\n&pdev->dev, NULL, &jornada_lcd_props);\r\nif (IS_ERR(lcd_device)) {\r\nret = PTR_ERR(lcd_device);\r\ndev_err(&pdev->dev, "failed to register device\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, lcd_device);\r\njornada_lcd_set_contrast(lcd_device, LCD_DEF_CONTRAST);\r\njornada_lcd_set_power(lcd_device, FB_BLANK_UNBLANK);\r\nmsleep(100);\r\nreturn 0;\r\n}

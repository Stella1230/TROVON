static void iommu_release_device(struct device *dev)\r\n{\r\nkfree(dev);\r\n}\r\nstatic int __init iommu_dev_init(void)\r\n{\r\nreturn class_register(&iommu_class);\r\n}\r\nint iommu_device_sysfs_add(struct iommu_device *iommu,\r\nstruct device *parent,\r\nconst struct attribute_group **groups,\r\nconst char *fmt, ...)\r\n{\r\nva_list vargs;\r\nint ret;\r\niommu->dev = kzalloc(sizeof(*iommu->dev), GFP_KERNEL);\r\nif (!iommu->dev)\r\nreturn -ENOMEM;\r\ndevice_initialize(iommu->dev);\r\niommu->dev->class = &iommu_class;\r\niommu->dev->parent = parent;\r\niommu->dev->groups = groups;\r\nva_start(vargs, fmt);\r\nret = kobject_set_name_vargs(&iommu->dev->kobj, fmt, vargs);\r\nva_end(vargs);\r\nif (ret)\r\ngoto error;\r\nret = device_add(iommu->dev);\r\nif (ret)\r\ngoto error;\r\ndev_set_drvdata(iommu->dev, iommu);\r\nreturn 0;\r\nerror:\r\nput_device(iommu->dev);\r\nreturn ret;\r\n}\r\nvoid iommu_device_sysfs_remove(struct iommu_device *iommu)\r\n{\r\ndev_set_drvdata(iommu->dev, NULL);\r\ndevice_unregister(iommu->dev);\r\niommu->dev = NULL;\r\n}\r\nint iommu_device_link(struct iommu_device *iommu, struct device *link)\r\n{\r\nint ret;\r\nif (!iommu || IS_ERR(iommu))\r\nreturn -ENODEV;\r\nret = sysfs_add_link_to_group(&iommu->dev->kobj, "devices",\r\n&link->kobj, dev_name(link));\r\nif (ret)\r\nreturn ret;\r\nret = sysfs_create_link_nowarn(&link->kobj, &iommu->dev->kobj, "iommu");\r\nif (ret)\r\nsysfs_remove_link_from_group(&iommu->dev->kobj, "devices",\r\ndev_name(link));\r\nreturn ret;\r\n}\r\nvoid iommu_device_unlink(struct iommu_device *iommu, struct device *link)\r\n{\r\nif (!iommu || IS_ERR(iommu))\r\nreturn;\r\nsysfs_remove_link(&link->kobj, "iommu");\r\nsysfs_remove_link_from_group(&iommu->dev->kobj, "devices", dev_name(link));\r\n}

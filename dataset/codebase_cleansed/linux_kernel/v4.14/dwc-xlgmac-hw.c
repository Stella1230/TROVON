static int xlgmac_tx_complete(struct xlgmac_dma_desc *dma_desc)\r\n{\r\nreturn !XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nTX_NORMAL_DESC3_OWN_POS,\r\nTX_NORMAL_DESC3_OWN_LEN);\r\n}\r\nstatic int xlgmac_disable_rx_csum(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_IPC_POS,\r\nMAC_RCR_IPC_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_enable_rx_csum(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_IPC_POS,\r\nMAC_RCR_IPC_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_mac_address(struct xlgmac_pdata *pdata, u8 *addr)\r\n{\r\nunsigned int mac_addr_hi, mac_addr_lo;\r\nmac_addr_hi = (addr[5] << 8) | (addr[4] << 0);\r\nmac_addr_lo = (addr[3] << 24) | (addr[2] << 16) |\r\n(addr[1] << 8) | (addr[0] << 0);\r\nwritel(mac_addr_hi, pdata->mac_regs + MAC_MACA0HR);\r\nwritel(mac_addr_lo, pdata->mac_regs + MAC_MACA0LR);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_set_mac_reg(struct xlgmac_pdata *pdata,\r\nstruct netdev_hw_addr *ha,\r\nunsigned int *mac_reg)\r\n{\r\nunsigned int mac_addr_hi, mac_addr_lo;\r\nu8 *mac_addr;\r\nmac_addr_lo = 0;\r\nmac_addr_hi = 0;\r\nif (ha) {\r\nmac_addr = (u8 *)&mac_addr_lo;\r\nmac_addr[0] = ha->addr[0];\r\nmac_addr[1] = ha->addr[1];\r\nmac_addr[2] = ha->addr[2];\r\nmac_addr[3] = ha->addr[3];\r\nmac_addr = (u8 *)&mac_addr_hi;\r\nmac_addr[0] = ha->addr[4];\r\nmac_addr[1] = ha->addr[5];\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"adding mac address %pM at %#x\n",\r\nha->addr, *mac_reg);\r\nmac_addr_hi = XLGMAC_SET_REG_BITS(mac_addr_hi,\r\nMAC_MACA1HR_AE_POS,\r\nMAC_MACA1HR_AE_LEN,\r\n1);\r\n}\r\nwritel(mac_addr_hi, pdata->mac_regs + *mac_reg);\r\n*mac_reg += MAC_MACA_INC;\r\nwritel(mac_addr_lo, pdata->mac_regs + *mac_reg);\r\n*mac_reg += MAC_MACA_INC;\r\n}\r\nstatic int xlgmac_enable_rx_vlan_stripping(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_VLANTR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLRXS_POS,\r\nMAC_VLANTR_EVLRXS_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_DOVLTC_POS,\r\nMAC_VLANTR_DOVLTC_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ERSVLM_POS,\r\nMAC_VLANTR_ERSVLM_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ESVL_POS,\r\nMAC_VLANTR_ESVL_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLS_POS,\r\nMAC_VLANTR_EVLS_LEN, 0x3);\r\nwritel(regval, pdata->mac_regs + MAC_VLANTR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_disable_rx_vlan_stripping(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_VLANTR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLS_POS,\r\nMAC_VLANTR_EVLS_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_VLANTR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_enable_rx_vlan_filtering(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_PFR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_VTFE_POS,\r\nMAC_PFR_VTFE_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_PFR);\r\nregval = readl(pdata->mac_regs + MAC_VLANTR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VTHM_POS,\r\nMAC_VLANTR_VTHM_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VTIM_POS,\r\nMAC_VLANTR_VTIM_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ETV_POS,\r\nMAC_VLANTR_ETV_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VL_POS,\r\nMAC_VLANTR_VL_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_VLANTR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_disable_rx_vlan_filtering(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_PFR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_VTFE_POS,\r\nMAC_PFR_VTFE_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_PFR);\r\nreturn 0;\r\n}\r\nstatic u32 xlgmac_vid_crc32_le(__le16 vid_le)\r\n{\r\nunsigned char *data = (unsigned char *)&vid_le;\r\nunsigned char data_byte = 0;\r\nu32 poly = 0xedb88320;\r\nu32 crc = ~0;\r\nu32 temp = 0;\r\nint i, bits;\r\nbits = get_bitmask_order(VLAN_VID_MASK);\r\nfor (i = 0; i < bits; i++) {\r\nif ((i % 8) == 0)\r\ndata_byte = data[i / 8];\r\ntemp = ((crc & 1) ^ data_byte) & 1;\r\ncrc >>= 1;\r\ndata_byte >>= 1;\r\nif (temp)\r\ncrc ^= poly;\r\n}\r\nreturn crc;\r\n}\r\nstatic int xlgmac_update_vlan_hash_table(struct xlgmac_pdata *pdata)\r\n{\r\nu16 vlan_hash_table = 0;\r\n__le16 vid_le;\r\nu32 regval;\r\nu32 crc;\r\nu16 vid;\r\nfor_each_set_bit(vid, pdata->active_vlans, VLAN_N_VID) {\r\nvid_le = cpu_to_le16(vid);\r\ncrc = bitrev32(~xlgmac_vid_crc32_le(vid_le)) >> 28;\r\nvlan_hash_table |= (1 << crc);\r\n}\r\nregval = readl(pdata->mac_regs + MAC_VLANHTR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANHTR_VLHT_POS,\r\nMAC_VLANHTR_VLHT_LEN, vlan_hash_table);\r\nwritel(regval, pdata->mac_regs + MAC_VLANHTR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_promiscuous_mode(struct xlgmac_pdata *pdata,\r\nunsigned int enable)\r\n{\r\nunsigned int val = enable ? 1 : 0;\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_PFR),\r\nMAC_PFR_PR_POS, MAC_PFR_PR_LEN);\r\nif (regval == val)\r\nreturn 0;\r\nnetif_dbg(pdata, drv, pdata->netdev, "%s promiscuous mode\n",\r\nenable ? "entering" : "leaving");\r\nregval = readl(pdata->mac_regs + MAC_PFR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_PR_POS,\r\nMAC_PFR_PR_LEN, val);\r\nwritel(regval, pdata->mac_regs + MAC_PFR);\r\nif (enable) {\r\nxlgmac_disable_rx_vlan_filtering(pdata);\r\n} else {\r\nif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_FILTER)\r\nxlgmac_enable_rx_vlan_filtering(pdata);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_all_multicast_mode(struct xlgmac_pdata *pdata,\r\nunsigned int enable)\r\n{\r\nunsigned int val = enable ? 1 : 0;\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_PFR),\r\nMAC_PFR_PM_POS, MAC_PFR_PM_LEN);\r\nif (regval == val)\r\nreturn 0;\r\nnetif_dbg(pdata, drv, pdata->netdev, "%s allmulti mode\n",\r\nenable ? "entering" : "leaving");\r\nregval = readl(pdata->mac_regs + MAC_PFR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_PM_POS,\r\nMAC_PFR_PM_LEN, val);\r\nwritel(regval, pdata->mac_regs + MAC_PFR);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_set_mac_addn_addrs(struct xlgmac_pdata *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nstruct netdev_hw_addr *ha;\r\nunsigned int addn_macs;\r\nunsigned int mac_reg;\r\nmac_reg = MAC_MACA1HR;\r\naddn_macs = pdata->hw_feat.addn_mac;\r\nif (netdev_uc_count(netdev) > addn_macs) {\r\nxlgmac_set_promiscuous_mode(pdata, 1);\r\n} else {\r\nnetdev_for_each_uc_addr(ha, netdev) {\r\nxlgmac_set_mac_reg(pdata, ha, &mac_reg);\r\naddn_macs--;\r\n}\r\nif (netdev_mc_count(netdev) > addn_macs) {\r\nxlgmac_set_all_multicast_mode(pdata, 1);\r\n} else {\r\nnetdev_for_each_mc_addr(ha, netdev) {\r\nxlgmac_set_mac_reg(pdata, ha, &mac_reg);\r\naddn_macs--;\r\n}\r\n}\r\n}\r\nwhile (addn_macs--)\r\nxlgmac_set_mac_reg(pdata, NULL, &mac_reg);\r\n}\r\nstatic void xlgmac_set_mac_hash_table(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int hash_table_shift, hash_table_count;\r\nu32 hash_table[XLGMAC_MAC_HASH_TABLE_SIZE];\r\nstruct net_device *netdev = pdata->netdev;\r\nstruct netdev_hw_addr *ha;\r\nunsigned int hash_reg;\r\nunsigned int i;\r\nu32 crc;\r\nhash_table_shift = 26 - (pdata->hw_feat.hash_table_size >> 7);\r\nhash_table_count = pdata->hw_feat.hash_table_size / 32;\r\nmemset(hash_table, 0, sizeof(hash_table));\r\nnetdev_for_each_uc_addr(ha, netdev) {\r\ncrc = bitrev32(~crc32_le(~0, ha->addr, ETH_ALEN));\r\ncrc >>= hash_table_shift;\r\nhash_table[crc >> 5] |= (1 << (crc & 0x1f));\r\n}\r\nnetdev_for_each_mc_addr(ha, netdev) {\r\ncrc = bitrev32(~crc32_le(~0, ha->addr, ETH_ALEN));\r\ncrc >>= hash_table_shift;\r\nhash_table[crc >> 5] |= (1 << (crc & 0x1f));\r\n}\r\nhash_reg = MAC_HTR0;\r\nfor (i = 0; i < hash_table_count; i++) {\r\nwritel(hash_table[i], pdata->mac_regs + hash_reg);\r\nhash_reg += MAC_HTR_INC;\r\n}\r\n}\r\nstatic int xlgmac_add_mac_addresses(struct xlgmac_pdata *pdata)\r\n{\r\nif (pdata->hw_feat.hash_table_size)\r\nxlgmac_set_mac_hash_table(pdata);\r\nelse\r\nxlgmac_set_mac_addn_addrs(pdata);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_mac_address(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nxlgmac_set_mac_address(pdata, pdata->netdev->dev_addr);\r\nif (pdata->hw_feat.hash_table_size) {\r\nregval = readl(pdata->mac_regs + MAC_PFR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HPF_POS,\r\nMAC_PFR_HPF_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HUC_POS,\r\nMAC_PFR_HUC_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HMC_POS,\r\nMAC_PFR_HMC_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_PFR);\r\n}\r\n}\r\nstatic void xlgmac_config_jumbo_enable(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int val;\r\nu32 regval;\r\nval = (pdata->netdev->mtu > XLGMAC_STD_PACKET_MTU) ? 1 : 0;\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_JE_POS,\r\nMAC_RCR_JE_LEN, val);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\n}\r\nstatic void xlgmac_config_checksum_offload(struct xlgmac_pdata *pdata)\r\n{\r\nif (pdata->netdev->features & NETIF_F_RXCSUM)\r\nxlgmac_enable_rx_csum(pdata);\r\nelse\r\nxlgmac_disable_rx_csum(pdata);\r\n}\r\nstatic void xlgmac_config_vlan_support(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_VLANIR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANIR_CSVL_POS,\r\nMAC_VLANIR_CSVL_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANIR_VLTI_POS,\r\nMAC_VLANIR_VLTI_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_VLANIR);\r\nxlgmac_update_vlan_hash_table(pdata);\r\nif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_FILTER)\r\nxlgmac_enable_rx_vlan_filtering(pdata);\r\nelse\r\nxlgmac_disable_rx_vlan_filtering(pdata);\r\nif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_RX)\r\nxlgmac_enable_rx_vlan_stripping(pdata);\r\nelse\r\nxlgmac_disable_rx_vlan_stripping(pdata);\r\n}\r\nstatic int xlgmac_config_rx_mode(struct xlgmac_pdata *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nunsigned int pr_mode, am_mode;\r\npr_mode = ((netdev->flags & IFF_PROMISC) != 0);\r\nam_mode = ((netdev->flags & IFF_ALLMULTI) != 0);\r\nxlgmac_set_promiscuous_mode(pdata, pr_mode);\r\nxlgmac_set_all_multicast_mode(pdata, am_mode);\r\nxlgmac_add_mac_addresses(pdata);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_prepare_tx_stop(struct xlgmac_pdata *pdata,\r\nstruct xlgmac_channel *channel)\r\n{\r\nunsigned int tx_dsr, tx_pos, tx_qidx;\r\nunsigned long tx_timeout;\r\nunsigned int tx_status;\r\nif (channel->queue_index < DMA_DSRX_FIRST_QUEUE) {\r\ntx_dsr = DMA_DSR0;\r\ntx_pos = (channel->queue_index * DMA_DSR_Q_LEN) +\r\nDMA_DSR0_TPS_START;\r\n} else {\r\ntx_qidx = channel->queue_index - DMA_DSRX_FIRST_QUEUE;\r\ntx_dsr = DMA_DSR1 + ((tx_qidx / DMA_DSRX_QPR) * DMA_DSRX_INC);\r\ntx_pos = ((tx_qidx % DMA_DSRX_QPR) * DMA_DSR_Q_LEN) +\r\nDMA_DSRX_TPS_START;\r\n}\r\ntx_timeout = jiffies + (XLGMAC_DMA_STOP_TIMEOUT * HZ);\r\nwhile (time_before(jiffies, tx_timeout)) {\r\ntx_status = readl(pdata->mac_regs + tx_dsr);\r\ntx_status = XLGMAC_GET_REG_BITS(tx_status, tx_pos,\r\nDMA_DSR_TPS_LEN);\r\nif ((tx_status == DMA_TPS_STOPPED) ||\r\n(tx_status == DMA_TPS_SUSPENDED))\r\nbreak;\r\nusleep_range(500, 1000);\r\n}\r\nif (!time_before(jiffies, tx_timeout))\r\nnetdev_info(pdata->netdev,\r\n"timed out waiting for Tx DMA channel %u to stop\n",\r\nchannel->queue_index);\r\n}\r\nstatic void xlgmac_enable_tx(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_ST_POS,\r\nDMA_CH_TCR_ST_LEN, 1);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\n}\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TXQEN_POS,\r\nMTL_Q_TQOMR_TXQEN_LEN,\r\nMTL_Q_ENABLED);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_TE_POS,\r\nMAC_TCR_TE_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\n}\r\nstatic void xlgmac_disable_tx(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nxlgmac_prepare_tx_stop(pdata, channel);\r\n}\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_TE_POS,\r\nMAC_TCR_TE_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TXQEN_POS,\r\nMTL_Q_TQOMR_TXQEN_LEN, 0);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_ST_POS,\r\nDMA_CH_TCR_ST_LEN, 0);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\n}\r\n}\r\nstatic void xlgmac_prepare_rx_stop(struct xlgmac_pdata *pdata,\r\nunsigned int queue)\r\n{\r\nunsigned int rx_status, prxq, rxqsts;\r\nunsigned long rx_timeout;\r\nrx_timeout = jiffies + (XLGMAC_DMA_STOP_TIMEOUT * HZ);\r\nwhile (time_before(jiffies, rx_timeout)) {\r\nrx_status = readl(XLGMAC_MTL_REG(pdata, queue, MTL_Q_RQDR));\r\nprxq = XLGMAC_GET_REG_BITS(rx_status, MTL_Q_RQDR_PRXQ_POS,\r\nMTL_Q_RQDR_PRXQ_LEN);\r\nrxqsts = XLGMAC_GET_REG_BITS(rx_status, MTL_Q_RQDR_RXQSTS_POS,\r\nMTL_Q_RQDR_RXQSTS_LEN);\r\nif ((prxq == 0) && (rxqsts == 0))\r\nbreak;\r\nusleep_range(500, 1000);\r\n}\r\nif (!time_before(jiffies, rx_timeout))\r\nnetdev_info(pdata->netdev,\r\n"timed out waiting for Rx queue %u to empty\n",\r\nqueue);\r\n}\r\nstatic void xlgmac_enable_rx(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int regval, i;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_SR_POS,\r\nDMA_CH_RCR_SR_LEN, 1);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\n}\r\nregval = 0;\r\nfor (i = 0; i < pdata->rx_q_count; i++)\r\nregval |= (0x02 << (i << 1));\r\nwritel(regval, pdata->mac_regs + MAC_RQC0R);\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_DCRCC_POS,\r\nMAC_RCR_DCRCC_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_CST_POS,\r\nMAC_RCR_CST_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_ACS_POS,\r\nMAC_RCR_ACS_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_RE_POS,\r\nMAC_RCR_RE_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\n}\r\nstatic void xlgmac_disable_rx(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_DCRCC_POS,\r\nMAC_RCR_DCRCC_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_CST_POS,\r\nMAC_RCR_CST_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_ACS_POS,\r\nMAC_RCR_ACS_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_RE_POS,\r\nMAC_RCR_RE_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\nfor (i = 0; i < pdata->rx_q_count; i++)\r\nxlgmac_prepare_rx_stop(pdata, i);\r\nwritel(0, pdata->mac_regs + MAC_RQC0R);\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_SR_POS,\r\nDMA_CH_RCR_SR_LEN, 0);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\n}\r\n}\r\nstatic void xlgmac_tx_start_xmit(struct xlgmac_channel *channel,\r\nstruct xlgmac_ring *ring)\r\n{\r\nstruct xlgmac_pdata *pdata = channel->pdata;\r\nstruct xlgmac_desc_data *desc_data;\r\nwmb();\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, ring->cur);\r\nwritel(lower_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_TDTR_LO));\r\nif (pdata->tx_usecs && !channel->tx_timer_active) {\r\nchannel->tx_timer_active = 1;\r\nmod_timer(&channel->tx_timer,\r\njiffies + usecs_to_jiffies(pdata->tx_usecs));\r\n}\r\nring->tx.xmit_more = 0;\r\n}\r\nstatic void xlgmac_dev_xmit(struct xlgmac_channel *channel)\r\n{\r\nstruct xlgmac_pdata *pdata = channel->pdata;\r\nstruct xlgmac_ring *ring = channel->tx_ring;\r\nunsigned int tso_context, vlan_context;\r\nstruct xlgmac_desc_data *desc_data;\r\nstruct xlgmac_dma_desc *dma_desc;\r\nstruct xlgmac_pkt_info *pkt_info;\r\nunsigned int csum, tso, vlan;\r\nint start_index = ring->cur;\r\nint cur_index = ring->cur;\r\nunsigned int tx_set_ic;\r\nint i;\r\npkt_info = &ring->pkt_info;\r\ncsum = XLGMAC_GET_REG_BITS(pkt_info->attributes,\r\nTX_PACKET_ATTRIBUTES_CSUM_ENABLE_POS,\r\nTX_PACKET_ATTRIBUTES_CSUM_ENABLE_LEN);\r\ntso = XLGMAC_GET_REG_BITS(pkt_info->attributes,\r\nTX_PACKET_ATTRIBUTES_TSO_ENABLE_POS,\r\nTX_PACKET_ATTRIBUTES_TSO_ENABLE_LEN);\r\nvlan = XLGMAC_GET_REG_BITS(pkt_info->attributes,\r\nTX_PACKET_ATTRIBUTES_VLAN_CTAG_POS,\r\nTX_PACKET_ATTRIBUTES_VLAN_CTAG_LEN);\r\nif (tso && (pkt_info->mss != ring->tx.cur_mss))\r\ntso_context = 1;\r\nelse\r\ntso_context = 0;\r\nif (vlan && (pkt_info->vlan_ctag != ring->tx.cur_vlan_ctag))\r\nvlan_context = 1;\r\nelse\r\nvlan_context = 0;\r\nring->coalesce_count += pkt_info->tx_packets;\r\nif (!pdata->tx_frames)\r\ntx_set_ic = 0;\r\nelse if (pkt_info->tx_packets > pdata->tx_frames)\r\ntx_set_ic = 1;\r\nelse if ((ring->coalesce_count % pdata->tx_frames) <\r\npkt_info->tx_packets)\r\ntx_set_ic = 1;\r\nelse\r\ntx_set_ic = 0;\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\r\ndma_desc = desc_data->dma_desc;\r\nif (tso_context || vlan_context) {\r\nif (tso_context) {\r\nnetif_dbg(pdata, tx_queued, pdata->netdev,\r\n"TSO context descriptor, mss=%u\n",\r\npkt_info->mss);\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_CONTEXT_DESC2_MSS_POS,\r\nTX_CONTEXT_DESC2_MSS_LEN,\r\npkt_info->mss);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_CONTEXT_DESC3_CTXT_POS,\r\nTX_CONTEXT_DESC3_CTXT_LEN,\r\n1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_CONTEXT_DESC3_TCMSSV_POS,\r\nTX_CONTEXT_DESC3_TCMSSV_LEN,\r\n1);\r\nring->tx.cur_mss = pkt_info->mss;\r\n}\r\nif (vlan_context) {\r\nnetif_dbg(pdata, tx_queued, pdata->netdev,\r\n"VLAN context descriptor, ctag=%u\n",\r\npkt_info->vlan_ctag);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_CONTEXT_DESC3_CTXT_POS,\r\nTX_CONTEXT_DESC3_CTXT_LEN,\r\n1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_CONTEXT_DESC3_VT_POS,\r\nTX_CONTEXT_DESC3_VT_LEN,\r\npkt_info->vlan_ctag);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_CONTEXT_DESC3_VLTV_POS,\r\nTX_CONTEXT_DESC3_VLTV_LEN,\r\n1);\r\nring->tx.cur_vlan_ctag = pkt_info->vlan_ctag;\r\n}\r\ncur_index++;\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\r\ndma_desc = desc_data->dma_desc;\r\n}\r\ndma_desc->desc0 = cpu_to_le32(lower_32_bits(desc_data->skb_dma));\r\ndma_desc->desc1 = cpu_to_le32(upper_32_bits(desc_data->skb_dma));\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_NORMAL_DESC2_HL_B1L_POS,\r\nTX_NORMAL_DESC2_HL_B1L_LEN,\r\ndesc_data->skb_dma_len);\r\nif (vlan) {\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_NORMAL_DESC2_VTIR_POS,\r\nTX_NORMAL_DESC2_VTIR_LEN,\r\nTX_NORMAL_DESC2_VLAN_INSERT);\r\npdata->stats.tx_vlan_packets++;\r\n}\r\nif (XLGMAC_GET_REG_BITS(pkt_info->attributes,\r\nTX_PACKET_ATTRIBUTES_PTP_POS,\r\nTX_PACKET_ATTRIBUTES_PTP_LEN))\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_NORMAL_DESC2_TTSE_POS,\r\nTX_NORMAL_DESC2_TTSE_LEN,\r\n1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_FD_POS,\r\nTX_NORMAL_DESC3_FD_LEN,\r\n1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_CTXT_POS,\r\nTX_NORMAL_DESC3_CTXT_LEN,\r\n0);\r\nif (cur_index != start_index)\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_OWN_POS,\r\nTX_NORMAL_DESC3_OWN_LEN,\r\n1);\r\nif (tso) {\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_TSE_POS,\r\nTX_NORMAL_DESC3_TSE_LEN, 1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_TCPPL_POS,\r\nTX_NORMAL_DESC3_TCPPL_LEN,\r\npkt_info->tcp_payload_len);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_TCPHDRLEN_POS,\r\nTX_NORMAL_DESC3_TCPHDRLEN_LEN,\r\npkt_info->tcp_header_len / 4);\r\npdata->stats.tx_tso_packets++;\r\n} else {\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_CPC_POS,\r\nTX_NORMAL_DESC3_CPC_LEN, 0);\r\nif (csum)\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_CIC_POS,\r\nTX_NORMAL_DESC3_CIC_LEN,\r\n0x3);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_FL_POS,\r\nTX_NORMAL_DESC3_FL_LEN,\r\npkt_info->length);\r\n}\r\nfor (i = cur_index - start_index + 1; i < pkt_info->desc_count; i++) {\r\ncur_index++;\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\r\ndma_desc = desc_data->dma_desc;\r\ndma_desc->desc0 =\r\ncpu_to_le32(lower_32_bits(desc_data->skb_dma));\r\ndma_desc->desc1 =\r\ncpu_to_le32(upper_32_bits(desc_data->skb_dma));\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_NORMAL_DESC2_HL_B1L_POS,\r\nTX_NORMAL_DESC2_HL_B1L_LEN,\r\ndesc_data->skb_dma_len);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_OWN_POS,\r\nTX_NORMAL_DESC3_OWN_LEN, 1);\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_CTXT_POS,\r\nTX_NORMAL_DESC3_CTXT_LEN, 0);\r\nif (csum)\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_CIC_POS,\r\nTX_NORMAL_DESC3_CIC_LEN,\r\n0x3);\r\n}\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_LD_POS,\r\nTX_NORMAL_DESC3_LD_LEN, 1);\r\nif (tx_set_ic)\r\ndma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc2,\r\nTX_NORMAL_DESC2_IC_POS,\r\nTX_NORMAL_DESC2_IC_LEN, 1);\r\ndesc_data->tx.packets = pkt_info->tx_packets;\r\ndesc_data->tx.bytes = pkt_info->tx_bytes;\r\ndma_wmb();\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\r\ndma_desc = desc_data->dma_desc;\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nTX_NORMAL_DESC3_OWN_POS,\r\nTX_NORMAL_DESC3_OWN_LEN, 1);\r\nif (netif_msg_tx_queued(pdata))\r\nxlgmac_dump_tx_desc(pdata, ring, start_index,\r\npkt_info->desc_count, 1);\r\nsmp_wmb();\r\nring->cur = cur_index + 1;\r\nif (!pkt_info->skb->xmit_more ||\r\nnetif_xmit_stopped(netdev_get_tx_queue(pdata->netdev,\r\nchannel->queue_index)))\r\nxlgmac_tx_start_xmit(channel, ring);\r\nelse\r\nring->tx.xmit_more = 1;\r\nXLGMAC_PR("%s: descriptors %u to %u written\n",\r\nchannel->name, start_index & (ring->dma_desc_count - 1),\r\n(ring->cur - 1) & (ring->dma_desc_count - 1));\r\n}\r\nstatic void xlgmac_get_rx_tstamp(struct xlgmac_pkt_info *pkt_info,\r\nstruct xlgmac_dma_desc *dma_desc)\r\n{\r\nu32 tsa, tsd;\r\nu64 nsec;\r\ntsa = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_CONTEXT_DESC3_TSA_POS,\r\nRX_CONTEXT_DESC3_TSA_LEN);\r\ntsd = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_CONTEXT_DESC3_TSD_POS,\r\nRX_CONTEXT_DESC3_TSD_LEN);\r\nif (tsa && !tsd) {\r\nnsec = le32_to_cpu(dma_desc->desc1);\r\nnsec <<= 32;\r\nnsec |= le32_to_cpu(dma_desc->desc0);\r\nif (nsec != 0xffffffffffffffffULL) {\r\npkt_info->rx_tstamp = nsec;\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_RX_TSTAMP_POS,\r\nRX_PACKET_ATTRIBUTES_RX_TSTAMP_LEN,\r\n1);\r\n}\r\n}\r\n}\r\nstatic void xlgmac_tx_desc_reset(struct xlgmac_desc_data *desc_data)\r\n{\r\nstruct xlgmac_dma_desc *dma_desc = desc_data->dma_desc;\r\ndma_desc->desc0 = 0;\r\ndma_desc->desc1 = 0;\r\ndma_desc->desc2 = 0;\r\ndma_desc->desc3 = 0;\r\ndma_wmb();\r\n}\r\nstatic void xlgmac_tx_desc_init(struct xlgmac_channel *channel)\r\n{\r\nstruct xlgmac_ring *ring = channel->tx_ring;\r\nstruct xlgmac_desc_data *desc_data;\r\nint start_index = ring->cur;\r\nint i;\r\nfor (i = 0; i < ring->dma_desc_count; i++) {\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, i);\r\nxlgmac_tx_desc_reset(desc_data);\r\n}\r\nwritel(ring->dma_desc_count - 1, XLGMAC_DMA_REG(channel, DMA_CH_TDRLR));\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\r\nwritel(upper_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_TDLR_HI));\r\nwritel(lower_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_TDLR_LO));\r\n}\r\nstatic void xlgmac_rx_desc_reset(struct xlgmac_pdata *pdata,\r\nstruct xlgmac_desc_data *desc_data,\r\nunsigned int index)\r\n{\r\nstruct xlgmac_dma_desc *dma_desc = desc_data->dma_desc;\r\nunsigned int rx_frames = pdata->rx_frames;\r\nunsigned int rx_usecs = pdata->rx_usecs;\r\ndma_addr_t hdr_dma, buf_dma;\r\nunsigned int inte;\r\nif (!rx_usecs && !rx_frames) {\r\ninte = 1;\r\n} else {\r\nif (rx_frames && !((index + 1) % rx_frames))\r\ninte = 1;\r\nelse\r\ninte = 0;\r\n}\r\nhdr_dma = desc_data->rx.hdr.dma_base + desc_data->rx.hdr.dma_off;\r\nbuf_dma = desc_data->rx.buf.dma_base + desc_data->rx.buf.dma_off;\r\ndma_desc->desc0 = cpu_to_le32(lower_32_bits(hdr_dma));\r\ndma_desc->desc1 = cpu_to_le32(upper_32_bits(hdr_dma));\r\ndma_desc->desc2 = cpu_to_le32(lower_32_bits(buf_dma));\r\ndma_desc->desc3 = cpu_to_le32(upper_32_bits(buf_dma));\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nRX_NORMAL_DESC3_INTE_POS,\r\nRX_NORMAL_DESC3_INTE_LEN,\r\ninte);\r\ndma_wmb();\r\ndma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\r\ndma_desc->desc3,\r\nRX_NORMAL_DESC3_OWN_POS,\r\nRX_NORMAL_DESC3_OWN_LEN,\r\n1);\r\ndma_wmb();\r\n}\r\nstatic void xlgmac_rx_desc_init(struct xlgmac_channel *channel)\r\n{\r\nstruct xlgmac_pdata *pdata = channel->pdata;\r\nstruct xlgmac_ring *ring = channel->rx_ring;\r\nunsigned int start_index = ring->cur;\r\nstruct xlgmac_desc_data *desc_data;\r\nunsigned int i;\r\nfor (i = 0; i < ring->dma_desc_count; i++) {\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, i);\r\nxlgmac_rx_desc_reset(pdata, desc_data, i);\r\n}\r\nwritel(ring->dma_desc_count - 1, XLGMAC_DMA_REG(channel, DMA_CH_RDRLR));\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\r\nwritel(upper_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_RDLR_HI));\r\nwritel(lower_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_RDLR_LO));\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, start_index +\r\nring->dma_desc_count - 1);\r\nwritel(lower_32_bits(desc_data->dma_desc_addr),\r\nXLGMAC_DMA_REG(channel, DMA_CH_RDTR_LO));\r\n}\r\nstatic int xlgmac_is_context_desc(struct xlgmac_dma_desc *dma_desc)\r\n{\r\nreturn XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nTX_NORMAL_DESC3_CTXT_POS,\r\nTX_NORMAL_DESC3_CTXT_LEN);\r\n}\r\nstatic int xlgmac_is_last_desc(struct xlgmac_dma_desc *dma_desc)\r\n{\r\nreturn XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nTX_NORMAL_DESC3_LD_POS,\r\nTX_NORMAL_DESC3_LD_LEN);\r\n}\r\nstatic int xlgmac_disable_tx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int max_q_count, q_count;\r\nunsigned int reg, regval;\r\nunsigned int i;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_EHFC_POS,\r\nMTL_Q_RQOMR_EHFC_LEN, 0);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\nmax_q_count = XLGMAC_MAX_FLOW_CONTROL_QUEUES;\r\nq_count = min_t(unsigned int, pdata->tx_q_count, max_q_count);\r\nreg = MAC_Q0TFCR;\r\nfor (i = 0; i < q_count; i++) {\r\nregval = readl(pdata->mac_regs + reg);\r\nregval = XLGMAC_SET_REG_BITS(regval,\r\nMAC_Q0TFCR_TFE_POS,\r\nMAC_Q0TFCR_TFE_LEN,\r\n0);\r\nwritel(regval, pdata->mac_regs + reg);\r\nreg += MAC_QTFCR_INC;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_enable_tx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int max_q_count, q_count;\r\nunsigned int reg, regval;\r\nunsigned int i;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_EHFC_POS,\r\nMTL_Q_RQOMR_EHFC_LEN, 1);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\nmax_q_count = XLGMAC_MAX_FLOW_CONTROL_QUEUES;\r\nq_count = min_t(unsigned int, pdata->tx_q_count, max_q_count);\r\nreg = MAC_Q0TFCR;\r\nfor (i = 0; i < q_count; i++) {\r\nregval = readl(pdata->mac_regs + reg);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_Q0TFCR_TFE_POS,\r\nMAC_Q0TFCR_TFE_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_Q0TFCR_PT_POS,\r\nMAC_Q0TFCR_PT_LEN, 0xffff);\r\nwritel(regval, pdata->mac_regs + reg);\r\nreg += MAC_QTFCR_INC;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_disable_rx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_RFCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RFCR_RFE_POS,\r\nMAC_RFCR_RFE_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_RFCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_enable_rx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MAC_RFCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RFCR_RFE_POS,\r\nMAC_RFCR_RFE_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_RFCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_tx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nif (pdata->tx_pause)\r\nxlgmac_enable_tx_flow_control(pdata);\r\nelse\r\nxlgmac_disable_tx_flow_control(pdata);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_rx_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nif (pdata->rx_pause)\r\nxlgmac_enable_rx_flow_control(pdata);\r\nelse\r\nxlgmac_disable_rx_flow_control(pdata);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_rx_coalesce(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RIWT));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RIWT_RWT_POS,\r\nDMA_CH_RIWT_RWT_LEN,\r\npdata->rx_riwt);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RIWT));\r\n}\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_flow_control(struct xlgmac_pdata *pdata)\r\n{\r\nxlgmac_config_tx_flow_control(pdata);\r\nxlgmac_config_rx_flow_control(pdata);\r\n}\r\nstatic void xlgmac_config_rx_fep_enable(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_FEP_POS,\r\nMTL_Q_RQOMR_FEP_LEN, 1);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\n}\r\nstatic void xlgmac_config_rx_fup_enable(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_FUP_POS,\r\nMTL_Q_RQOMR_FUP_LEN, 1);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\n}\r\nstatic int xlgmac_config_tx_coalesce(struct xlgmac_pdata *pdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_rx_buffer_size(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_RBSZ_POS,\r\nDMA_CH_RCR_RBSZ_LEN,\r\npdata->rx_buf_size);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\n}\r\n}\r\nstatic void xlgmac_config_tso_mode(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nif (pdata->hw_feat.tso) {\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_TSE_POS,\r\nDMA_CH_TCR_TSE_LEN, 1);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\n}\r\n}\r\n}\r\nstatic void xlgmac_config_sph_mode(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_CR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_CR_SPH_POS,\r\nDMA_CH_CR_SPH_LEN, 1);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_CR));\r\n}\r\nregval = readl(pdata->mac_regs + MAC_RCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_HDSMS_POS,\r\nMAC_RCR_HDSMS_LEN,\r\nXLGMAC_SPH_HDSMS_SIZE);\r\nwritel(regval, pdata->mac_regs + MAC_RCR);\r\n}\r\nstatic unsigned int xlgmac_usec_to_riwt(struct xlgmac_pdata *pdata,\r\nunsigned int usec)\r\n{\r\nunsigned long rate;\r\nunsigned int ret;\r\nrate = pdata->sysclk_rate;\r\nret = (usec * (rate / 1000000)) / 256;\r\nreturn ret;\r\n}\r\nstatic unsigned int xlgmac_riwt_to_usec(struct xlgmac_pdata *pdata,\r\nunsigned int riwt)\r\n{\r\nunsigned long rate;\r\nunsigned int ret;\r\nrate = pdata->sysclk_rate;\r\nret = (riwt * 256) / (rate / 1000000);\r\nreturn ret;\r\n}\r\nstatic int xlgmac_config_rx_threshold(struct xlgmac_pdata *pdata,\r\nunsigned int val)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RTC_POS,\r\nMTL_Q_RQOMR_RTC_LEN, val);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_mtl_mode(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MTL_OMR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_OMR_ETSALG_POS,\r\nMTL_OMR_ETSALG_LEN, MTL_ETSALG_WRR);\r\nwritel(regval, pdata->mac_regs + MTL_OMR);\r\nfor (i = 0; i < pdata->hw_feat.tc_cnt; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_TC_ETSCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_TC_ETSCR_TSA_POS,\r\nMTL_TC_ETSCR_TSA_LEN, MTL_TSA_ETS);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_TC_ETSCR));\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_TC_QWR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_TC_QWR_QW_POS,\r\nMTL_TC_QWR_QW_LEN, 1);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_TC_QWR));\r\n}\r\nregval = readl(pdata->mac_regs + MTL_OMR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_OMR_RAA_POS,\r\nMTL_OMR_RAA_LEN, MTL_RAA_SP);\r\nwritel(regval, pdata->mac_regs + MTL_OMR);\r\n}\r\nstatic void xlgmac_config_queue_mapping(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int ppq, ppq_extra, prio, prio_queues;\r\nunsigned int qptc, qptc_extra, queue;\r\nunsigned int reg, regval;\r\nunsigned int mask;\r\nunsigned int i, j;\r\nqptc = pdata->tx_q_count / pdata->hw_feat.tc_cnt;\r\nqptc_extra = pdata->tx_q_count % pdata->hw_feat.tc_cnt;\r\nfor (i = 0, queue = 0; i < pdata->hw_feat.tc_cnt; i++) {\r\nfor (j = 0; j < qptc; j++) {\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"TXq%u mapped to TC%u\n", queue, i);\r\nregval = readl(XLGMAC_MTL_REG(pdata, queue,\r\nMTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval,\r\nMTL_Q_TQOMR_Q2TCMAP_POS,\r\nMTL_Q_TQOMR_Q2TCMAP_LEN,\r\ni);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, queue,\r\nMTL_Q_TQOMR));\r\nqueue++;\r\n}\r\nif (i < qptc_extra) {\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"TXq%u mapped to TC%u\n", queue, i);\r\nregval = readl(XLGMAC_MTL_REG(pdata, queue,\r\nMTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval,\r\nMTL_Q_TQOMR_Q2TCMAP_POS,\r\nMTL_Q_TQOMR_Q2TCMAP_LEN,\r\ni);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, queue,\r\nMTL_Q_TQOMR));\r\nqueue++;\r\n}\r\n}\r\nprio_queues = min_t(unsigned int, IEEE_8021QAZ_MAX_TCS,\r\npdata->rx_q_count);\r\nppq = IEEE_8021QAZ_MAX_TCS / prio_queues;\r\nppq_extra = IEEE_8021QAZ_MAX_TCS % prio_queues;\r\nreg = MAC_RQC2R;\r\nregval = 0;\r\nfor (i = 0, prio = 0; i < prio_queues;) {\r\nmask = 0;\r\nfor (j = 0; j < ppq; j++) {\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"PRIO%u mapped to RXq%u\n", prio, i);\r\nmask |= (1 << prio);\r\nprio++;\r\n}\r\nif (i < ppq_extra) {\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"PRIO%u mapped to RXq%u\n", prio, i);\r\nmask |= (1 << prio);\r\nprio++;\r\n}\r\nregval |= (mask << ((i++ % MAC_RQC2_Q_PER_REG) << 3));\r\nif ((i % MAC_RQC2_Q_PER_REG) && (i != prio_queues))\r\ncontinue;\r\nwritel(regval, pdata->mac_regs + reg);\r\nreg += MAC_RQC2_INC;\r\nregval = 0;\r\n}\r\nreg = MTL_RQDCM0R;\r\nregval = readl(pdata->mac_regs + reg);\r\nregval |= (MTL_RQDCM0R_Q0MDMACH | MTL_RQDCM0R_Q1MDMACH |\r\nMTL_RQDCM0R_Q2MDMACH | MTL_RQDCM0R_Q3MDMACH);\r\nwritel(regval, pdata->mac_regs + reg);\r\nreg += MTL_RQDCM_INC;\r\nregval = readl(pdata->mac_regs + reg);\r\nregval |= (MTL_RQDCM1R_Q4MDMACH | MTL_RQDCM1R_Q5MDMACH |\r\nMTL_RQDCM1R_Q6MDMACH | MTL_RQDCM1R_Q7MDMACH);\r\nwritel(regval, pdata->mac_regs + reg);\r\nreg += MTL_RQDCM_INC;\r\nregval = readl(pdata->mac_regs + reg);\r\nregval |= (MTL_RQDCM2R_Q8MDMACH | MTL_RQDCM2R_Q9MDMACH |\r\nMTL_RQDCM2R_Q10MDMACH | MTL_RQDCM2R_Q11MDMACH);\r\nwritel(regval, pdata->mac_regs + reg);\r\n}\r\nstatic unsigned int xlgmac_calculate_per_queue_fifo(\r\nunsigned int fifo_size,\r\nunsigned int queue_count)\r\n{\r\nunsigned int q_fifo_size;\r\nunsigned int p_fifo;\r\nq_fifo_size = 1 << (fifo_size + 7);\r\nq_fifo_size = min_t(unsigned int, XLGMAC_MAX_FIFO, q_fifo_size);\r\nq_fifo_size = q_fifo_size / queue_count;\r\np_fifo = q_fifo_size / 256;\r\nif (p_fifo)\r\np_fifo--;\r\nreturn p_fifo;\r\n}\r\nstatic void xlgmac_config_tx_fifo_size(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int fifo_size;\r\nunsigned int i;\r\nu32 regval;\r\nfifo_size = xlgmac_calculate_per_queue_fifo(\r\npdata->hw_feat.tx_fifo_size,\r\npdata->tx_q_count);\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TQS_POS,\r\nMTL_Q_TQOMR_TQS_LEN, fifo_size);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nnetif_info(pdata, drv, pdata->netdev,\r\n"%d Tx hardware queues, %d byte fifo per queue\n",\r\npdata->tx_q_count, ((fifo_size + 1) * 256));\r\n}\r\nstatic void xlgmac_config_rx_fifo_size(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int fifo_size;\r\nunsigned int i;\r\nu32 regval;\r\nfifo_size = xlgmac_calculate_per_queue_fifo(\r\npdata->hw_feat.rx_fifo_size,\r\npdata->rx_q_count);\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RQS_POS,\r\nMTL_Q_RQOMR_RQS_LEN, fifo_size);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\nnetif_info(pdata, drv, pdata->netdev,\r\n"%d Rx hardware queues, %d byte fifo per queue\n",\r\npdata->rx_q_count, ((fifo_size + 1) * 256));\r\n}\r\nstatic void xlgmac_config_flow_control_threshold(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQFCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQFCR_RFA_POS,\r\nMTL_Q_RQFCR_RFA_LEN, 2);\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQFCR_RFD_POS,\r\nMTL_Q_RQFCR_RFD_LEN, 4);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQFCR));\r\n}\r\n}\r\nstatic int xlgmac_config_tx_threshold(struct xlgmac_pdata *pdata,\r\nunsigned int val)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TTC_POS,\r\nMTL_Q_TQOMR_TTC_LEN, val);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_rsf_mode(struct xlgmac_pdata *pdata,\r\nunsigned int val)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->rx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RSF_POS,\r\nMTL_Q_RQOMR_RSF_LEN, val);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_tsf_mode(struct xlgmac_pdata *pdata,\r\nunsigned int val)\r\n{\r\nunsigned int i;\r\nu32 regval;\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TSF_POS,\r\nMTL_Q_TQOMR_TSF_LEN, val);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_osp_mode(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_OSP_POS,\r\nDMA_CH_TCR_OSP_LEN,\r\npdata->tx_osp_mode);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_config_pblx8(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_CR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_CR_PBLX8_POS,\r\nDMA_CH_CR_PBLX8_LEN,\r\npdata->pblx8);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_CR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_get_tx_pbl_val(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(XLGMAC_DMA_REG(pdata->channel_head, DMA_CH_TCR));\r\nregval = XLGMAC_GET_REG_BITS(regval, DMA_CH_TCR_PBL_POS,\r\nDMA_CH_TCR_PBL_LEN);\r\nreturn regval;\r\n}\r\nstatic int xlgmac_config_tx_pbl_val(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->tx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_PBL_POS,\r\nDMA_CH_TCR_PBL_LEN,\r\npdata->tx_pbl);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_get_rx_pbl_val(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(XLGMAC_DMA_REG(pdata->channel_head, DMA_CH_RCR));\r\nregval = XLGMAC_GET_REG_BITS(regval, DMA_CH_RCR_PBL_POS,\r\nDMA_CH_RCR_PBL_LEN);\r\nreturn regval;\r\n}\r\nstatic int xlgmac_config_rx_pbl_val(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nu32 regval;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\nif (!channel->rx_ring)\r\nbreak;\r\nregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_PBL_POS,\r\nDMA_CH_RCR_PBL_LEN,\r\npdata->rx_pbl);\r\nwritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\r\n}\r\nreturn 0;\r\n}\r\nstatic u64 xlgmac_mmc_read(struct xlgmac_pdata *pdata, unsigned int reg_lo)\r\n{\r\nbool read_hi;\r\nu64 val;\r\nswitch (reg_lo) {\r\ncase MMC_TXOCTETCOUNT_GB_LO:\r\ncase MMC_TXOCTETCOUNT_G_LO:\r\ncase MMC_RXOCTETCOUNT_GB_LO:\r\ncase MMC_RXOCTETCOUNT_G_LO:\r\nread_hi = true;\r\nbreak;\r\ndefault:\r\nread_hi = false;\r\n}\r\nval = (u64)readl(pdata->mac_regs + reg_lo);\r\nif (read_hi)\r\nval |= ((u64)readl(pdata->mac_regs + reg_lo + 4) << 32);\r\nreturn val;\r\n}\r\nstatic void xlgmac_tx_mmc_int(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int mmc_isr = readl(pdata->mac_regs + MMC_TISR);\r\nstruct xlgmac_stats *stats = &pdata->stats;\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXOCTETCOUNT_GB_POS,\r\nMMC_TISR_TXOCTETCOUNT_GB_LEN))\r\nstats->txoctetcount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXFRAMECOUNT_GB_POS,\r\nMMC_TISR_TXFRAMECOUNT_GB_LEN))\r\nstats->txframecount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXBROADCASTFRAMES_G_POS,\r\nMMC_TISR_TXBROADCASTFRAMES_G_LEN))\r\nstats->txbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXMULTICASTFRAMES_G_POS,\r\nMMC_TISR_TXMULTICASTFRAMES_G_LEN))\r\nstats->txmulticastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX64OCTETS_GB_POS,\r\nMMC_TISR_TX64OCTETS_GB_LEN))\r\nstats->tx64octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX64OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX65TO127OCTETS_GB_POS,\r\nMMC_TISR_TX65TO127OCTETS_GB_LEN))\r\nstats->tx65to127octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX65TO127OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX128TO255OCTETS_GB_POS,\r\nMMC_TISR_TX128TO255OCTETS_GB_LEN))\r\nstats->tx128to255octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX128TO255OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX256TO511OCTETS_GB_POS,\r\nMMC_TISR_TX256TO511OCTETS_GB_LEN))\r\nstats->tx256to511octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX256TO511OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX512TO1023OCTETS_GB_POS,\r\nMMC_TISR_TX512TO1023OCTETS_GB_LEN))\r\nstats->tx512to1023octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX512TO1023OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TX1024TOMAXOCTETS_GB_POS,\r\nMMC_TISR_TX1024TOMAXOCTETS_GB_LEN))\r\nstats->tx1024tomaxoctets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX1024TOMAXOCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXUNICASTFRAMES_GB_POS,\r\nMMC_TISR_TXUNICASTFRAMES_GB_LEN))\r\nstats->txunicastframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXUNICASTFRAMES_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXMULTICASTFRAMES_GB_POS,\r\nMMC_TISR_TXMULTICASTFRAMES_GB_LEN))\r\nstats->txmulticastframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXBROADCASTFRAMES_GB_POS,\r\nMMC_TISR_TXBROADCASTFRAMES_GB_LEN))\r\nstats->txbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXUNDERFLOWERROR_POS,\r\nMMC_TISR_TXUNDERFLOWERROR_LEN))\r\nstats->txunderflowerror +=\r\nxlgmac_mmc_read(pdata, MMC_TXUNDERFLOWERROR_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXOCTETCOUNT_G_POS,\r\nMMC_TISR_TXOCTETCOUNT_G_LEN))\r\nstats->txoctetcount_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXFRAMECOUNT_G_POS,\r\nMMC_TISR_TXFRAMECOUNT_G_LEN))\r\nstats->txframecount_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXPAUSEFRAMES_POS,\r\nMMC_TISR_TXPAUSEFRAMES_LEN))\r\nstats->txpauseframes +=\r\nxlgmac_mmc_read(pdata, MMC_TXPAUSEFRAMES_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_TISR_TXVLANFRAMES_G_POS,\r\nMMC_TISR_TXVLANFRAMES_G_LEN))\r\nstats->txvlanframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXVLANFRAMES_G_LO);\r\n}\r\nstatic void xlgmac_rx_mmc_int(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int mmc_isr = readl(pdata->mac_regs + MMC_RISR);\r\nstruct xlgmac_stats *stats = &pdata->stats;\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXFRAMECOUNT_GB_POS,\r\nMMC_RISR_RXFRAMECOUNT_GB_LEN))\r\nstats->rxframecount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXFRAMECOUNT_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXOCTETCOUNT_GB_POS,\r\nMMC_RISR_RXOCTETCOUNT_GB_LEN))\r\nstats->rxoctetcount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXOCTETCOUNT_G_POS,\r\nMMC_RISR_RXOCTETCOUNT_G_LEN))\r\nstats->rxoctetcount_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXBROADCASTFRAMES_G_POS,\r\nMMC_RISR_RXBROADCASTFRAMES_G_LEN))\r\nstats->rxbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXBROADCASTFRAMES_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXMULTICASTFRAMES_G_POS,\r\nMMC_RISR_RXMULTICASTFRAMES_G_LEN))\r\nstats->rxmulticastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXMULTICASTFRAMES_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXCRCERROR_POS,\r\nMMC_RISR_RXCRCERROR_LEN))\r\nstats->rxcrcerror +=\r\nxlgmac_mmc_read(pdata, MMC_RXCRCERROR_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXRUNTERROR_POS,\r\nMMC_RISR_RXRUNTERROR_LEN))\r\nstats->rxrunterror +=\r\nxlgmac_mmc_read(pdata, MMC_RXRUNTERROR);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXJABBERERROR_POS,\r\nMMC_RISR_RXJABBERERROR_LEN))\r\nstats->rxjabbererror +=\r\nxlgmac_mmc_read(pdata, MMC_RXJABBERERROR);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXUNDERSIZE_G_POS,\r\nMMC_RISR_RXUNDERSIZE_G_LEN))\r\nstats->rxundersize_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXUNDERSIZE_G);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXOVERSIZE_G_POS,\r\nMMC_RISR_RXOVERSIZE_G_LEN))\r\nstats->rxoversize_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXOVERSIZE_G);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX64OCTETS_GB_POS,\r\nMMC_RISR_RX64OCTETS_GB_LEN))\r\nstats->rx64octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX64OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX65TO127OCTETS_GB_POS,\r\nMMC_RISR_RX65TO127OCTETS_GB_LEN))\r\nstats->rx65to127octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX65TO127OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX128TO255OCTETS_GB_POS,\r\nMMC_RISR_RX128TO255OCTETS_GB_LEN))\r\nstats->rx128to255octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX128TO255OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX256TO511OCTETS_GB_POS,\r\nMMC_RISR_RX256TO511OCTETS_GB_LEN))\r\nstats->rx256to511octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX256TO511OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX512TO1023OCTETS_GB_POS,\r\nMMC_RISR_RX512TO1023OCTETS_GB_LEN))\r\nstats->rx512to1023octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX512TO1023OCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RX1024TOMAXOCTETS_GB_POS,\r\nMMC_RISR_RX1024TOMAXOCTETS_GB_LEN))\r\nstats->rx1024tomaxoctets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX1024TOMAXOCTETS_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXUNICASTFRAMES_G_POS,\r\nMMC_RISR_RXUNICASTFRAMES_G_LEN))\r\nstats->rxunicastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXUNICASTFRAMES_G_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXLENGTHERROR_POS,\r\nMMC_RISR_RXLENGTHERROR_LEN))\r\nstats->rxlengtherror +=\r\nxlgmac_mmc_read(pdata, MMC_RXLENGTHERROR_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXOUTOFRANGETYPE_POS,\r\nMMC_RISR_RXOUTOFRANGETYPE_LEN))\r\nstats->rxoutofrangetype +=\r\nxlgmac_mmc_read(pdata, MMC_RXOUTOFRANGETYPE_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXPAUSEFRAMES_POS,\r\nMMC_RISR_RXPAUSEFRAMES_LEN))\r\nstats->rxpauseframes +=\r\nxlgmac_mmc_read(pdata, MMC_RXPAUSEFRAMES_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXFIFOOVERFLOW_POS,\r\nMMC_RISR_RXFIFOOVERFLOW_LEN))\r\nstats->rxfifooverflow +=\r\nxlgmac_mmc_read(pdata, MMC_RXFIFOOVERFLOW_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXVLANFRAMES_GB_POS,\r\nMMC_RISR_RXVLANFRAMES_GB_LEN))\r\nstats->rxvlanframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXVLANFRAMES_GB_LO);\r\nif (XLGMAC_GET_REG_BITS(mmc_isr,\r\nMMC_RISR_RXWATCHDOGERROR_POS,\r\nMMC_RISR_RXWATCHDOGERROR_LEN))\r\nstats->rxwatchdogerror +=\r\nxlgmac_mmc_read(pdata, MMC_RXWATCHDOGERROR);\r\n}\r\nstatic void xlgmac_read_mmc_stats(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_stats *stats = &pdata->stats;\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MMC_CR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_MCF_POS,\r\nMMC_CR_MCF_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MMC_CR);\r\nstats->txoctetcount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_GB_LO);\r\nstats->txframecount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_GB_LO);\r\nstats->txbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_G_LO);\r\nstats->txmulticastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_G_LO);\r\nstats->tx64octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX64OCTETS_GB_LO);\r\nstats->tx65to127octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX65TO127OCTETS_GB_LO);\r\nstats->tx128to255octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX128TO255OCTETS_GB_LO);\r\nstats->tx256to511octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX256TO511OCTETS_GB_LO);\r\nstats->tx512to1023octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX512TO1023OCTETS_GB_LO);\r\nstats->tx1024tomaxoctets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TX1024TOMAXOCTETS_GB_LO);\r\nstats->txunicastframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXUNICASTFRAMES_GB_LO);\r\nstats->txmulticastframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_GB_LO);\r\nstats->txbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_GB_LO);\r\nstats->txunderflowerror +=\r\nxlgmac_mmc_read(pdata, MMC_TXUNDERFLOWERROR_LO);\r\nstats->txoctetcount_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_G_LO);\r\nstats->txframecount_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_G_LO);\r\nstats->txpauseframes +=\r\nxlgmac_mmc_read(pdata, MMC_TXPAUSEFRAMES_LO);\r\nstats->txvlanframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_TXVLANFRAMES_G_LO);\r\nstats->rxframecount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXFRAMECOUNT_GB_LO);\r\nstats->rxoctetcount_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_GB_LO);\r\nstats->rxoctetcount_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_G_LO);\r\nstats->rxbroadcastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXBROADCASTFRAMES_G_LO);\r\nstats->rxmulticastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXMULTICASTFRAMES_G_LO);\r\nstats->rxcrcerror +=\r\nxlgmac_mmc_read(pdata, MMC_RXCRCERROR_LO);\r\nstats->rxrunterror +=\r\nxlgmac_mmc_read(pdata, MMC_RXRUNTERROR);\r\nstats->rxjabbererror +=\r\nxlgmac_mmc_read(pdata, MMC_RXJABBERERROR);\r\nstats->rxundersize_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXUNDERSIZE_G);\r\nstats->rxoversize_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXOVERSIZE_G);\r\nstats->rx64octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX64OCTETS_GB_LO);\r\nstats->rx65to127octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX65TO127OCTETS_GB_LO);\r\nstats->rx128to255octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX128TO255OCTETS_GB_LO);\r\nstats->rx256to511octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX256TO511OCTETS_GB_LO);\r\nstats->rx512to1023octets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX512TO1023OCTETS_GB_LO);\r\nstats->rx1024tomaxoctets_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RX1024TOMAXOCTETS_GB_LO);\r\nstats->rxunicastframes_g +=\r\nxlgmac_mmc_read(pdata, MMC_RXUNICASTFRAMES_G_LO);\r\nstats->rxlengtherror +=\r\nxlgmac_mmc_read(pdata, MMC_RXLENGTHERROR_LO);\r\nstats->rxoutofrangetype +=\r\nxlgmac_mmc_read(pdata, MMC_RXOUTOFRANGETYPE_LO);\r\nstats->rxpauseframes +=\r\nxlgmac_mmc_read(pdata, MMC_RXPAUSEFRAMES_LO);\r\nstats->rxfifooverflow +=\r\nxlgmac_mmc_read(pdata, MMC_RXFIFOOVERFLOW_LO);\r\nstats->rxvlanframes_gb +=\r\nxlgmac_mmc_read(pdata, MMC_RXVLANFRAMES_GB_LO);\r\nstats->rxwatchdogerror +=\r\nxlgmac_mmc_read(pdata, MMC_RXWATCHDOGERROR);\r\nregval = readl(pdata->mac_regs + MMC_CR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_MCF_POS,\r\nMMC_CR_MCF_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MMC_CR);\r\n}\r\nstatic void xlgmac_config_mmc(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + MMC_CR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_ROR_POS,\r\nMMC_CR_ROR_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_CR_POS,\r\nMMC_CR_CR_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MMC_CR);\r\n}\r\nstatic int xlgmac_write_rss_reg(struct xlgmac_pdata *pdata, unsigned int type,\r\nunsigned int index, unsigned int val)\r\n{\r\nunsigned int wait;\r\nint ret = 0;\r\nu32 regval;\r\nmutex_lock(&pdata->rss_mutex);\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_RSSAR),\r\nMAC_RSSAR_OB_POS, MAC_RSSAR_OB_LEN);\r\nif (regval) {\r\nret = -EBUSY;\r\ngoto unlock;\r\n}\r\nwritel(val, pdata->mac_regs + MAC_RSSDR);\r\nregval = readl(pdata->mac_regs + MAC_RSSAR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_RSSIA_POS,\r\nMAC_RSSAR_RSSIA_LEN, index);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_ADDRT_POS,\r\nMAC_RSSAR_ADDRT_LEN, type);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_CT_POS,\r\nMAC_RSSAR_CT_LEN, 0);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_OB_POS,\r\nMAC_RSSAR_OB_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_RSSAR);\r\nwait = 1000;\r\nwhile (wait--) {\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_RSSAR),\r\nMAC_RSSAR_OB_POS,\r\nMAC_RSSAR_OB_LEN);\r\nif (!regval)\r\ngoto unlock;\r\nusleep_range(1000, 1500);\r\n}\r\nret = -EBUSY;\r\nunlock:\r\nmutex_unlock(&pdata->rss_mutex);\r\nreturn ret;\r\n}\r\nstatic int xlgmac_write_rss_hash_key(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int key_regs = sizeof(pdata->rss_key) / sizeof(u32);\r\nunsigned int *key = (unsigned int *)&pdata->rss_key;\r\nint ret;\r\nwhile (key_regs--) {\r\nret = xlgmac_write_rss_reg(pdata, XLGMAC_RSS_HASH_KEY_TYPE,\r\nkey_regs, *key++);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_write_rss_lookup_table(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i;\r\nint ret;\r\nfor (i = 0; i < ARRAY_SIZE(pdata->rss_table); i++) {\r\nret = xlgmac_write_rss_reg(pdata,\r\nXLGMAC_RSS_LOOKUP_TABLE_TYPE, i,\r\npdata->rss_table[i]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_rss_hash_key(struct xlgmac_pdata *pdata, const u8 *key)\r\n{\r\nmemcpy(pdata->rss_key, key, sizeof(pdata->rss_key));\r\nreturn xlgmac_write_rss_hash_key(pdata);\r\n}\r\nstatic int xlgmac_set_rss_lookup_table(struct xlgmac_pdata *pdata,\r\nconst u32 *table)\r\n{\r\nunsigned int i;\r\nu32 tval;\r\nfor (i = 0; i < ARRAY_SIZE(pdata->rss_table); i++) {\r\ntval = table[i];\r\npdata->rss_table[i] = XLGMAC_SET_REG_BITS(\r\npdata->rss_table[i],\r\nMAC_RSSDR_DMCH_POS,\r\nMAC_RSSDR_DMCH_LEN,\r\ntval);\r\n}\r\nreturn xlgmac_write_rss_lookup_table(pdata);\r\n}\r\nstatic int xlgmac_enable_rss(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nint ret;\r\nif (!pdata->hw_feat.rss)\r\nreturn -EOPNOTSUPP;\r\nret = xlgmac_write_rss_hash_key(pdata);\r\nif (ret)\r\nreturn ret;\r\nret = xlgmac_write_rss_lookup_table(pdata);\r\nif (ret)\r\nreturn ret;\r\nwritel(pdata->rss_options, pdata->mac_regs + MAC_RSSCR);\r\nregval = readl(pdata->mac_regs + MAC_RSSCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSCR_RSSE_POS,\r\nMAC_RSSCR_RSSE_LEN, 1);\r\nwritel(regval, pdata->mac_regs + MAC_RSSCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_disable_rss(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nif (!pdata->hw_feat.rss)\r\nreturn -EOPNOTSUPP;\r\nregval = readl(pdata->mac_regs + MAC_RSSCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSCR_RSSE_POS,\r\nMAC_RSSCR_RSSE_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_RSSCR);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_rss(struct xlgmac_pdata *pdata)\r\n{\r\nint ret;\r\nif (!pdata->hw_feat.rss)\r\nreturn;\r\nif (pdata->netdev->features & NETIF_F_RXHASH)\r\nret = xlgmac_enable_rss(pdata);\r\nelse\r\nret = xlgmac_disable_rss(pdata);\r\nif (ret)\r\nnetdev_err(pdata->netdev,\r\n"error configuring RSS, RSS disabled\n");\r\n}\r\nstatic void xlgmac_enable_dma_interrupts(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int dma_ch_isr, dma_ch_ier;\r\nstruct xlgmac_channel *channel;\r\nunsigned int i;\r\nchannel = pdata->channel_head;\r\nfor (i = 0; i < pdata->channel_count; i++, channel++) {\r\ndma_ch_isr = readl(XLGMAC_DMA_REG(channel, DMA_CH_SR));\r\nwritel(dma_ch_isr, XLGMAC_DMA_REG(channel, DMA_CH_SR));\r\ndma_ch_ier = 0;\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\r\nDMA_CH_IER_NIE_POS,\r\nDMA_CH_IER_NIE_LEN, 1);\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\r\nDMA_CH_IER_AIE_POS,\r\nDMA_CH_IER_AIE_LEN, 1);\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\r\nDMA_CH_IER_FBEE_POS,\r\nDMA_CH_IER_FBEE_LEN, 1);\r\nif (channel->tx_ring) {\r\nif (!pdata->per_channel_irq)\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier,\r\nDMA_CH_IER_TIE_POS,\r\nDMA_CH_IER_TIE_LEN,\r\n1);\r\n}\r\nif (channel->rx_ring) {\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier,\r\nDMA_CH_IER_RBUE_POS,\r\nDMA_CH_IER_RBUE_LEN,\r\n1);\r\nif (!pdata->per_channel_irq)\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier,\r\nDMA_CH_IER_RIE_POS,\r\nDMA_CH_IER_RIE_LEN,\r\n1);\r\n}\r\nwritel(dma_ch_isr, XLGMAC_DMA_REG(channel, DMA_CH_IER));\r\n}\r\n}\r\nstatic void xlgmac_enable_mtl_interrupts(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int q_count, i;\r\nunsigned int mtl_q_isr;\r\nq_count = max(pdata->hw_feat.tx_q_cnt, pdata->hw_feat.rx_q_cnt);\r\nfor (i = 0; i < q_count; i++) {\r\nmtl_q_isr = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_ISR));\r\nwritel(mtl_q_isr, XLGMAC_MTL_REG(pdata, i, MTL_Q_ISR));\r\nwritel(0, XLGMAC_MTL_REG(pdata, i, MTL_Q_IER));\r\n}\r\n}\r\nstatic void xlgmac_enable_mac_interrupts(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int mac_ier = 0;\r\nu32 regval;\r\nmac_ier = XLGMAC_SET_REG_BITS(mac_ier, MAC_IER_TSIE_POS,\r\nMAC_IER_TSIE_LEN, 1);\r\nwritel(mac_ier, pdata->mac_regs + MAC_IER);\r\nregval = readl(pdata->mac_regs + MMC_RIER);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_RIER_ALL_INTERRUPTS_POS,\r\nMMC_RIER_ALL_INTERRUPTS_LEN, 0xffffffff);\r\nwritel(regval, pdata->mac_regs + MMC_RIER);\r\nregval = readl(pdata->mac_regs + MMC_TIER);\r\nregval = XLGMAC_SET_REG_BITS(regval, MMC_TIER_ALL_INTERRUPTS_POS,\r\nMMC_TIER_ALL_INTERRUPTS_LEN, 0xffffffff);\r\nwritel(regval, pdata->mac_regs + MMC_TIER);\r\n}\r\nstatic int xlgmac_set_xlgmii_25000_speed(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\r\nMAC_TCR_SS_POS, MAC_TCR_SS_LEN);\r\nif (regval == 0x1)\r\nreturn 0;\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\r\nMAC_TCR_SS_LEN, 0x1);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_xlgmii_40000_speed(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\r\nMAC_TCR_SS_POS, MAC_TCR_SS_LEN);\r\nif (regval == 0)\r\nreturn 0;\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\r\nMAC_TCR_SS_LEN, 0);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_xlgmii_50000_speed(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\r\nMAC_TCR_SS_POS, MAC_TCR_SS_LEN);\r\nif (regval == 0x2)\r\nreturn 0;\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\r\nMAC_TCR_SS_LEN, 0x2);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_set_xlgmii_100000_speed(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\r\nMAC_TCR_SS_POS, MAC_TCR_SS_LEN);\r\nif (regval == 0x3)\r\nreturn 0;\r\nregval = readl(pdata->mac_regs + MAC_TCR);\r\nregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\r\nMAC_TCR_SS_LEN, 0x3);\r\nwritel(regval, pdata->mac_regs + MAC_TCR);\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_mac_speed(struct xlgmac_pdata *pdata)\r\n{\r\nswitch (pdata->phy_speed) {\r\ncase SPEED_100000:\r\nxlgmac_set_xlgmii_100000_speed(pdata);\r\nbreak;\r\ncase SPEED_50000:\r\nxlgmac_set_xlgmii_50000_speed(pdata);\r\nbreak;\r\ncase SPEED_40000:\r\nxlgmac_set_xlgmii_40000_speed(pdata);\r\nbreak;\r\ncase SPEED_25000:\r\nxlgmac_set_xlgmii_25000_speed(pdata);\r\nbreak;\r\n}\r\n}\r\nstatic int xlgmac_dev_read(struct xlgmac_channel *channel)\r\n{\r\nstruct xlgmac_pdata *pdata = channel->pdata;\r\nstruct xlgmac_ring *ring = channel->rx_ring;\r\nstruct net_device *netdev = pdata->netdev;\r\nstruct xlgmac_desc_data *desc_data;\r\nstruct xlgmac_dma_desc *dma_desc;\r\nstruct xlgmac_pkt_info *pkt_info;\r\nunsigned int err, etlt, l34t;\r\ndesc_data = XLGMAC_GET_DESC_DATA(ring, ring->cur);\r\ndma_desc = desc_data->dma_desc;\r\npkt_info = &ring->pkt_info;\r\nif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_OWN_POS,\r\nRX_NORMAL_DESC3_OWN_LEN))\r\nreturn 1;\r\ndma_rmb();\r\nif (netif_msg_rx_status(pdata))\r\nxlgmac_dump_rx_desc(pdata, ring, ring->cur);\r\nif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_CTXT_POS,\r\nRX_NORMAL_DESC3_CTXT_LEN)) {\r\nxlgmac_get_rx_tstamp(pkt_info, dma_desc);\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_POS,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_LEN,\r\n1);\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_POS,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_LEN,\r\n0);\r\nreturn 0;\r\n}\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_POS,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_LEN,\r\n0);\r\nif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_CDA_POS,\r\nRX_NORMAL_DESC3_CDA_LEN))\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_POS,\r\nRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_LEN,\r\n1);\r\nif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_FD_POS,\r\nRX_NORMAL_DESC3_FD_LEN)) {\r\ndesc_data->rx.hdr_len = XLGMAC_GET_REG_BITS_LE(dma_desc->desc2,\r\nRX_NORMAL_DESC2_HL_POS,\r\nRX_NORMAL_DESC2_HL_LEN);\r\nif (desc_data->rx.hdr_len)\r\npdata->stats.rx_split_header_packets++;\r\n}\r\nif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_RSV_POS,\r\nRX_NORMAL_DESC3_RSV_LEN)) {\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_RSS_HASH_POS,\r\nRX_PACKET_ATTRIBUTES_RSS_HASH_LEN,\r\n1);\r\npkt_info->rss_hash = le32_to_cpu(dma_desc->desc1);\r\nl34t = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_L34T_POS,\r\nRX_NORMAL_DESC3_L34T_LEN);\r\nswitch (l34t) {\r\ncase RX_DESC3_L34T_IPV4_TCP:\r\ncase RX_DESC3_L34T_IPV4_UDP:\r\ncase RX_DESC3_L34T_IPV6_TCP:\r\ncase RX_DESC3_L34T_IPV6_UDP:\r\npkt_info->rss_hash_type = PKT_HASH_TYPE_L4;\r\nbreak;\r\ndefault:\r\npkt_info->rss_hash_type = PKT_HASH_TYPE_L3;\r\n}\r\n}\r\ndesc_data->rx.len = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_PL_POS,\r\nRX_NORMAL_DESC3_PL_LEN);\r\nif (!XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_LD_POS,\r\nRX_NORMAL_DESC3_LD_LEN)) {\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_INCOMPLETE_POS,\r\nRX_PACKET_ATTRIBUTES_INCOMPLETE_LEN,\r\n1);\r\nreturn 0;\r\n}\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_INCOMPLETE_POS,\r\nRX_PACKET_ATTRIBUTES_INCOMPLETE_LEN,\r\n0);\r\nif (netdev->features & NETIF_F_RXCSUM)\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CSUM_DONE_POS,\r\nRX_PACKET_ATTRIBUTES_CSUM_DONE_LEN,\r\n1);\r\nerr = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_ES_POS,\r\nRX_NORMAL_DESC3_ES_LEN);\r\netlt = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\r\nRX_NORMAL_DESC3_ETLT_POS,\r\nRX_NORMAL_DESC3_ETLT_LEN);\r\nnetif_dbg(pdata, rx_status, netdev, "err=%u, etlt=%#x\n", err, etlt);\r\nif (!err || !etlt) {\r\nif ((etlt == 0x09) &&\r\n(netdev->features & NETIF_F_HW_VLAN_CTAG_RX)) {\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_VLAN_CTAG_POS,\r\nRX_PACKET_ATTRIBUTES_VLAN_CTAG_LEN,\r\n1);\r\npkt_info->vlan_ctag =\r\nXLGMAC_GET_REG_BITS_LE(dma_desc->desc0,\r\nRX_NORMAL_DESC0_OVT_POS,\r\nRX_NORMAL_DESC0_OVT_LEN);\r\nnetif_dbg(pdata, rx_status, netdev, "vlan-ctag=%#06x\n",\r\npkt_info->vlan_ctag);\r\n}\r\n} else {\r\nif ((etlt == 0x05) || (etlt == 0x06))\r\npkt_info->attributes = XLGMAC_SET_REG_BITS(\r\npkt_info->attributes,\r\nRX_PACKET_ATTRIBUTES_CSUM_DONE_POS,\r\nRX_PACKET_ATTRIBUTES_CSUM_DONE_LEN,\r\n0);\r\nelse\r\npkt_info->errors = XLGMAC_SET_REG_BITS(\r\npkt_info->errors,\r\nRX_PACKET_ERRORS_FRAME_POS,\r\nRX_PACKET_ERRORS_FRAME_LEN,\r\n1);\r\n}\r\nXLGMAC_PR("%s - descriptor=%u (cur=%d)\n", channel->name,\r\nring->cur & (ring->dma_desc_count - 1), ring->cur);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_enable_int(struct xlgmac_channel *channel,\r\nenum xlgmac_int int_id)\r\n{\r\nunsigned int dma_ch_ier;\r\ndma_ch_ier = readl(XLGMAC_DMA_REG(channel, DMA_CH_IER));\r\nswitch (int_id) {\r\ncase XLGMAC_INT_DMA_CH_SR_TI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TIE_POS,\r\nDMA_CH_IER_TIE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TPS:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TXSE_POS,\r\nDMA_CH_IER_TXSE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TBU:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TBUE_POS,\r\nDMA_CH_IER_TBUE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RIE_POS,\r\nDMA_CH_IER_RIE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RBU:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RBUE_POS,\r\nDMA_CH_IER_RBUE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RPS:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RSE_POS,\r\nDMA_CH_IER_RSE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TI_RI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TIE_POS,\r\nDMA_CH_IER_TIE_LEN, 1);\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RIE_POS,\r\nDMA_CH_IER_RIE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_FBE:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_FBEE_POS,\r\nDMA_CH_IER_FBEE_LEN, 1);\r\nbreak;\r\ncase XLGMAC_INT_DMA_ALL:\r\ndma_ch_ier |= channel->saved_ier;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nwritel(dma_ch_ier, XLGMAC_DMA_REG(channel, DMA_CH_IER));\r\nreturn 0;\r\n}\r\nstatic int xlgmac_disable_int(struct xlgmac_channel *channel,\r\nenum xlgmac_int int_id)\r\n{\r\nunsigned int dma_ch_ier;\r\ndma_ch_ier = readl(XLGMAC_DMA_REG(channel, DMA_CH_IER));\r\nswitch (int_id) {\r\ncase XLGMAC_INT_DMA_CH_SR_TI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TIE_POS,\r\nDMA_CH_IER_TIE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TPS:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TXSE_POS,\r\nDMA_CH_IER_TXSE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TBU:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TBUE_POS,\r\nDMA_CH_IER_TBUE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RIE_POS,\r\nDMA_CH_IER_RIE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RBU:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RBUE_POS,\r\nDMA_CH_IER_RBUE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_RPS:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RSE_POS,\r\nDMA_CH_IER_RSE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_TI_RI:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_TIE_POS,\r\nDMA_CH_IER_TIE_LEN, 0);\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_RIE_POS,\r\nDMA_CH_IER_RIE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_CH_SR_FBE:\r\ndma_ch_ier = XLGMAC_SET_REG_BITS(\r\ndma_ch_ier, DMA_CH_IER_FBEE_POS,\r\nDMA_CH_IER_FBEE_LEN, 0);\r\nbreak;\r\ncase XLGMAC_INT_DMA_ALL:\r\nchannel->saved_ier = dma_ch_ier & XLGMAC_DMA_INTERRUPT_MASK;\r\ndma_ch_ier &= ~XLGMAC_DMA_INTERRUPT_MASK;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nwritel(dma_ch_ier, XLGMAC_DMA_REG(channel, DMA_CH_IER));\r\nreturn 0;\r\n}\r\nstatic int xlgmac_flush_tx_queues(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int i, count;\r\nu32 regval;\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_FTQ_POS,\r\nMTL_Q_TQOMR_FTQ_LEN, 1);\r\nwritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\n}\r\nfor (i = 0; i < pdata->tx_q_count; i++) {\r\ncount = 2000;\r\nregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\r\nregval = XLGMAC_GET_REG_BITS(regval, MTL_Q_TQOMR_FTQ_POS,\r\nMTL_Q_TQOMR_FTQ_LEN);\r\nwhile (--count && regval)\r\nusleep_range(500, 600);\r\nif (!count)\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void xlgmac_config_dma_bus(struct xlgmac_pdata *pdata)\r\n{\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + DMA_SBMR);\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_EAME_POS,\r\nDMA_SBMR_EAME_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_UNDEF_POS,\r\nDMA_SBMR_UNDEF_LEN, 1);\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_BLEN_256_POS,\r\nDMA_SBMR_BLEN_256_LEN, 1);\r\nwritel(regval, pdata->mac_regs + DMA_SBMR);\r\n}\r\nstatic int xlgmac_hw_init(struct xlgmac_pdata *pdata)\r\n{\r\nstruct xlgmac_desc_ops *desc_ops = &pdata->desc_ops;\r\nint ret;\r\nret = xlgmac_flush_tx_queues(pdata);\r\nif (ret)\r\nreturn ret;\r\nxlgmac_config_dma_bus(pdata);\r\nxlgmac_config_osp_mode(pdata);\r\nxlgmac_config_pblx8(pdata);\r\nxlgmac_config_tx_pbl_val(pdata);\r\nxlgmac_config_rx_pbl_val(pdata);\r\nxlgmac_config_rx_coalesce(pdata);\r\nxlgmac_config_tx_coalesce(pdata);\r\nxlgmac_config_rx_buffer_size(pdata);\r\nxlgmac_config_tso_mode(pdata);\r\nxlgmac_config_sph_mode(pdata);\r\nxlgmac_config_rss(pdata);\r\ndesc_ops->tx_desc_init(pdata);\r\ndesc_ops->rx_desc_init(pdata);\r\nxlgmac_enable_dma_interrupts(pdata);\r\nxlgmac_config_mtl_mode(pdata);\r\nxlgmac_config_queue_mapping(pdata);\r\nxlgmac_config_tsf_mode(pdata, pdata->tx_sf_mode);\r\nxlgmac_config_rsf_mode(pdata, pdata->rx_sf_mode);\r\nxlgmac_config_tx_threshold(pdata, pdata->tx_threshold);\r\nxlgmac_config_rx_threshold(pdata, pdata->rx_threshold);\r\nxlgmac_config_tx_fifo_size(pdata);\r\nxlgmac_config_rx_fifo_size(pdata);\r\nxlgmac_config_flow_control_threshold(pdata);\r\nxlgmac_config_rx_fep_enable(pdata);\r\nxlgmac_config_rx_fup_enable(pdata);\r\nxlgmac_enable_mtl_interrupts(pdata);\r\nxlgmac_config_mac_address(pdata);\r\nxlgmac_config_rx_mode(pdata);\r\nxlgmac_config_jumbo_enable(pdata);\r\nxlgmac_config_flow_control(pdata);\r\nxlgmac_config_mac_speed(pdata);\r\nxlgmac_config_checksum_offload(pdata);\r\nxlgmac_config_vlan_support(pdata);\r\nxlgmac_config_mmc(pdata);\r\nxlgmac_enable_mac_interrupts(pdata);\r\nreturn 0;\r\n}\r\nstatic int xlgmac_hw_exit(struct xlgmac_pdata *pdata)\r\n{\r\nunsigned int count = 2000;\r\nu32 regval;\r\nregval = readl(pdata->mac_regs + DMA_MR);\r\nregval = XLGMAC_SET_REG_BITS(regval, DMA_MR_SWR_POS,\r\nDMA_MR_SWR_LEN, 1);\r\nwritel(regval, pdata->mac_regs + DMA_MR);\r\nusleep_range(10, 15);\r\nwhile (--count &&\r\nXLGMAC_GET_REG_BITS(readl(pdata->mac_regs + DMA_MR),\r\nDMA_MR_SWR_POS, DMA_MR_SWR_LEN))\r\nusleep_range(500, 600);\r\nif (!count)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nvoid xlgmac_init_hw_ops(struct xlgmac_hw_ops *hw_ops)\r\n{\r\nhw_ops->init = xlgmac_hw_init;\r\nhw_ops->exit = xlgmac_hw_exit;\r\nhw_ops->tx_complete = xlgmac_tx_complete;\r\nhw_ops->enable_tx = xlgmac_enable_tx;\r\nhw_ops->disable_tx = xlgmac_disable_tx;\r\nhw_ops->enable_rx = xlgmac_enable_rx;\r\nhw_ops->disable_rx = xlgmac_disable_rx;\r\nhw_ops->dev_xmit = xlgmac_dev_xmit;\r\nhw_ops->dev_read = xlgmac_dev_read;\r\nhw_ops->enable_int = xlgmac_enable_int;\r\nhw_ops->disable_int = xlgmac_disable_int;\r\nhw_ops->set_mac_address = xlgmac_set_mac_address;\r\nhw_ops->config_rx_mode = xlgmac_config_rx_mode;\r\nhw_ops->enable_rx_csum = xlgmac_enable_rx_csum;\r\nhw_ops->disable_rx_csum = xlgmac_disable_rx_csum;\r\nhw_ops->set_xlgmii_25000_speed = xlgmac_set_xlgmii_25000_speed;\r\nhw_ops->set_xlgmii_40000_speed = xlgmac_set_xlgmii_40000_speed;\r\nhw_ops->set_xlgmii_50000_speed = xlgmac_set_xlgmii_50000_speed;\r\nhw_ops->set_xlgmii_100000_speed = xlgmac_set_xlgmii_100000_speed;\r\nhw_ops->tx_desc_init = xlgmac_tx_desc_init;\r\nhw_ops->rx_desc_init = xlgmac_rx_desc_init;\r\nhw_ops->tx_desc_reset = xlgmac_tx_desc_reset;\r\nhw_ops->rx_desc_reset = xlgmac_rx_desc_reset;\r\nhw_ops->is_last_desc = xlgmac_is_last_desc;\r\nhw_ops->is_context_desc = xlgmac_is_context_desc;\r\nhw_ops->tx_start_xmit = xlgmac_tx_start_xmit;\r\nhw_ops->config_tx_flow_control = xlgmac_config_tx_flow_control;\r\nhw_ops->config_rx_flow_control = xlgmac_config_rx_flow_control;\r\nhw_ops->enable_rx_vlan_stripping = xlgmac_enable_rx_vlan_stripping;\r\nhw_ops->disable_rx_vlan_stripping = xlgmac_disable_rx_vlan_stripping;\r\nhw_ops->enable_rx_vlan_filtering = xlgmac_enable_rx_vlan_filtering;\r\nhw_ops->disable_rx_vlan_filtering = xlgmac_disable_rx_vlan_filtering;\r\nhw_ops->update_vlan_hash_table = xlgmac_update_vlan_hash_table;\r\nhw_ops->config_rx_coalesce = xlgmac_config_rx_coalesce;\r\nhw_ops->config_tx_coalesce = xlgmac_config_tx_coalesce;\r\nhw_ops->usec_to_riwt = xlgmac_usec_to_riwt;\r\nhw_ops->riwt_to_usec = xlgmac_riwt_to_usec;\r\nhw_ops->config_rx_threshold = xlgmac_config_rx_threshold;\r\nhw_ops->config_tx_threshold = xlgmac_config_tx_threshold;\r\nhw_ops->config_rsf_mode = xlgmac_config_rsf_mode;\r\nhw_ops->config_tsf_mode = xlgmac_config_tsf_mode;\r\nhw_ops->config_osp_mode = xlgmac_config_osp_mode;\r\nhw_ops->config_rx_pbl_val = xlgmac_config_rx_pbl_val;\r\nhw_ops->get_rx_pbl_val = xlgmac_get_rx_pbl_val;\r\nhw_ops->config_tx_pbl_val = xlgmac_config_tx_pbl_val;\r\nhw_ops->get_tx_pbl_val = xlgmac_get_tx_pbl_val;\r\nhw_ops->config_pblx8 = xlgmac_config_pblx8;\r\nhw_ops->tx_mmc_int = xlgmac_tx_mmc_int;\r\nhw_ops->rx_mmc_int = xlgmac_rx_mmc_int;\r\nhw_ops->read_mmc_stats = xlgmac_read_mmc_stats;\r\nhw_ops->enable_rss = xlgmac_enable_rss;\r\nhw_ops->disable_rss = xlgmac_disable_rss;\r\nhw_ops->set_rss_hash_key = xlgmac_set_rss_hash_key;\r\nhw_ops->set_rss_lookup_table = xlgmac_set_rss_lookup_table;\r\n}

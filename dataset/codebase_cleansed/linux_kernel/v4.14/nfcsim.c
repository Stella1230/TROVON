static struct nfcsim_link *nfcsim_link_new(void)\r\n{\r\nstruct nfcsim_link *link;\r\nlink = kzalloc(sizeof(struct nfcsim_link), GFP_KERNEL);\r\nif (!link)\r\nreturn NULL;\r\nmutex_init(&link->lock);\r\ninit_waitqueue_head(&link->recv_wait);\r\nreturn link;\r\n}\r\nstatic void nfcsim_link_free(struct nfcsim_link *link)\r\n{\r\ndev_kfree_skb(link->skb);\r\nkfree(link);\r\n}\r\nstatic void nfcsim_link_recv_wake(struct nfcsim_link *link)\r\n{\r\nlink->cond = 1;\r\nwake_up_interruptible(&link->recv_wait);\r\n}\r\nstatic void nfcsim_link_set_skb(struct nfcsim_link *link, struct sk_buff *skb,\r\nu8 rf_tech, u8 mode)\r\n{\r\nmutex_lock(&link->lock);\r\ndev_kfree_skb(link->skb);\r\nlink->skb = skb;\r\nlink->rf_tech = rf_tech;\r\nlink->mode = mode;\r\nmutex_unlock(&link->lock);\r\n}\r\nstatic void nfcsim_link_recv_cancel(struct nfcsim_link *link)\r\n{\r\nmutex_lock(&link->lock);\r\nlink->mode = NFCSIM_MODE_NONE;\r\nmutex_unlock(&link->lock);\r\nnfcsim_link_recv_wake(link);\r\n}\r\nstatic void nfcsim_link_shutdown(struct nfcsim_link *link)\r\n{\r\nmutex_lock(&link->lock);\r\nlink->shutdown = 1;\r\nlink->mode = NFCSIM_MODE_NONE;\r\nmutex_unlock(&link->lock);\r\nnfcsim_link_recv_wake(link);\r\n}\r\nstatic struct sk_buff *nfcsim_link_recv_skb(struct nfcsim_link *link,\r\nint timeout, u8 rf_tech, u8 mode)\r\n{\r\nint rc;\r\nstruct sk_buff *skb;\r\nrc = wait_event_interruptible_timeout(link->recv_wait,\r\nlink->cond,\r\nmsecs_to_jiffies(timeout));\r\nmutex_lock(&link->lock);\r\nskb = link->skb;\r\nlink->skb = NULL;\r\nif (!rc) {\r\nrc = -ETIMEDOUT;\r\ngoto done;\r\n}\r\nif (!skb || link->rf_tech != rf_tech || link->mode == mode) {\r\nrc = -EINVAL;\r\ngoto done;\r\n}\r\nif (link->shutdown) {\r\nrc = -ENODEV;\r\ngoto done;\r\n}\r\ndone:\r\nmutex_unlock(&link->lock);\r\nif (rc < 0) {\r\ndev_kfree_skb(skb);\r\nskb = ERR_PTR(rc);\r\n}\r\nlink->cond = 0;\r\nreturn skb;\r\n}\r\nstatic void nfcsim_send_wq(struct work_struct *work)\r\n{\r\nstruct nfcsim *dev = container_of(work, struct nfcsim, send_work.work);\r\nnfcsim_link_recv_wake(dev->link_out);\r\n}\r\nstatic void nfcsim_recv_wq(struct work_struct *work)\r\n{\r\nstruct nfcsim *dev = container_of(work, struct nfcsim, recv_work);\r\nstruct sk_buff *skb;\r\nskb = nfcsim_link_recv_skb(dev->link_in, dev->recv_timeout,\r\ndev->rf_tech, dev->mode);\r\nif (!dev->up) {\r\nNFCSIM_ERR(dev, "Device is down\n");\r\nif (!IS_ERR(skb))\r\ndev_kfree_skb(skb);\r\nskb = ERR_PTR(-ENODEV);\r\n}\r\ndev->cb(dev->nfc_digital_dev, dev->arg, skb);\r\n}\r\nstatic int nfcsim_send(struct nfc_digital_dev *ddev, struct sk_buff *skb,\r\nu16 timeout, nfc_digital_cmd_complete_t cb, void *arg)\r\n{\r\nstruct nfcsim *dev = nfc_digital_get_drvdata(ddev);\r\nu8 delay;\r\nif (!dev->up) {\r\nNFCSIM_ERR(dev, "Device is down\n");\r\nreturn -ENODEV;\r\n}\r\ndev->recv_timeout = timeout;\r\ndev->cb = cb;\r\ndev->arg = arg;\r\nschedule_work(&dev->recv_work);\r\nif (dev->dropframe) {\r\nNFCSIM_DBG(dev, "dropping frame (out of %d)\n", dev->dropframe);\r\ndev_kfree_skb(skb);\r\ndev->dropframe--;\r\nreturn 0;\r\n}\r\nif (skb) {\r\nnfcsim_link_set_skb(dev->link_out, skb, dev->rf_tech,\r\ndev->mode);\r\nget_random_bytes(&delay, 1);\r\ndelay = 3 + (delay & 0x07);\r\nschedule_delayed_work(&dev->send_work, msecs_to_jiffies(delay));\r\n}\r\nreturn 0;\r\n}\r\nstatic void nfcsim_abort_cmd(struct nfc_digital_dev *ddev)\r\n{\r\nstruct nfcsim *dev = nfc_digital_get_drvdata(ddev);\r\nnfcsim_link_recv_cancel(dev->link_in);\r\n}\r\nstatic int nfcsim_switch_rf(struct nfc_digital_dev *ddev, bool on)\r\n{\r\nstruct nfcsim *dev = nfc_digital_get_drvdata(ddev);\r\ndev->up = on;\r\nreturn 0;\r\n}\r\nstatic int nfcsim_in_configure_hw(struct nfc_digital_dev *ddev,\r\nint type, int param)\r\n{\r\nstruct nfcsim *dev = nfc_digital_get_drvdata(ddev);\r\nswitch (type) {\r\ncase NFC_DIGITAL_CONFIG_RF_TECH:\r\ndev->up = true;\r\ndev->mode = NFCSIM_MODE_INITIATOR;\r\ndev->rf_tech = param;\r\nbreak;\r\ncase NFC_DIGITAL_CONFIG_FRAMING:\r\nbreak;\r\ndefault:\r\nNFCSIM_ERR(dev, "Invalid configuration type: %d\n", type);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nfcsim_in_send_cmd(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb, u16 timeout,\r\nnfc_digital_cmd_complete_t cb, void *arg)\r\n{\r\nreturn nfcsim_send(ddev, skb, timeout, cb, arg);\r\n}\r\nstatic int nfcsim_tg_configure_hw(struct nfc_digital_dev *ddev,\r\nint type, int param)\r\n{\r\nstruct nfcsim *dev = nfc_digital_get_drvdata(ddev);\r\nswitch (type) {\r\ncase NFC_DIGITAL_CONFIG_RF_TECH:\r\ndev->up = true;\r\ndev->mode = NFCSIM_MODE_TARGET;\r\ndev->rf_tech = param;\r\nbreak;\r\ncase NFC_DIGITAL_CONFIG_FRAMING:\r\nbreak;\r\ndefault:\r\nNFCSIM_ERR(dev, "Invalid configuration type: %d\n", type);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nfcsim_tg_send_cmd(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb, u16 timeout,\r\nnfc_digital_cmd_complete_t cb, void *arg)\r\n{\r\nreturn nfcsim_send(ddev, skb, timeout, cb, arg);\r\n}\r\nstatic int nfcsim_tg_listen(struct nfc_digital_dev *ddev, u16 timeout,\r\nnfc_digital_cmd_complete_t cb, void *arg)\r\n{\r\nreturn nfcsim_send(ddev, NULL, timeout, cb, arg);\r\n}\r\nstatic void nfcsim_debugfs_init(void)\r\n{\r\nnfcsim_debugfs_root = debugfs_create_dir("nfcsim", NULL);\r\nif (!nfcsim_debugfs_root)\r\npr_err("Could not create debugfs entry\n");\r\n}\r\nstatic void nfcsim_debugfs_remove(void)\r\n{\r\ndebugfs_remove_recursive(nfcsim_debugfs_root);\r\n}\r\nstatic void nfcsim_debugfs_init_dev(struct nfcsim *dev)\r\n{\r\nstruct dentry *dev_dir;\r\nchar devname[5];\r\nu32 idx;\r\nint n;\r\nif (!nfcsim_debugfs_root) {\r\nNFCSIM_ERR(dev, "nfcsim debugfs not initialized\n");\r\nreturn;\r\n}\r\nidx = dev->nfc_digital_dev->nfc_dev->idx;\r\nn = snprintf(devname, sizeof(devname), "nfc%d", idx);\r\nif (n >= sizeof(devname)) {\r\nNFCSIM_ERR(dev, "Could not compute dev name for dev %d\n", idx);\r\nreturn;\r\n}\r\ndev_dir = debugfs_create_dir(devname, nfcsim_debugfs_root);\r\nif (!dev_dir) {\r\nNFCSIM_ERR(dev, "Could not create debugfs entries for nfc%d\n",\r\nidx);\r\nreturn;\r\n}\r\ndebugfs_create_u8("dropframe", 0664, dev_dir, &dev->dropframe);\r\n}\r\nstatic struct nfcsim *nfcsim_device_new(struct nfcsim_link *link_in,\r\nstruct nfcsim_link *link_out)\r\n{\r\nstruct nfcsim *dev;\r\nint rc;\r\ndev = kzalloc(sizeof(struct nfcsim), GFP_KERNEL);\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\nINIT_DELAYED_WORK(&dev->send_work, nfcsim_send_wq);\r\nINIT_WORK(&dev->recv_work, nfcsim_recv_wq);\r\ndev->nfc_digital_dev =\r\nnfc_digital_allocate_device(&nfcsim_digital_ops,\r\nNFC_PROTO_NFC_DEP_MASK,\r\nNFCSIM_CAPABILITIES,\r\n0, 0);\r\nif (!dev->nfc_digital_dev) {\r\nkfree(dev);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nnfc_digital_set_drvdata(dev->nfc_digital_dev, dev);\r\ndev->link_in = link_in;\r\ndev->link_out = link_out;\r\nrc = nfc_digital_register_device(dev->nfc_digital_dev);\r\nif (rc) {\r\npr_err("Could not register digital device (%d)\n", rc);\r\nnfc_digital_free_device(dev->nfc_digital_dev);\r\nkfree(dev);\r\nreturn ERR_PTR(rc);\r\n}\r\nnfcsim_debugfs_init_dev(dev);\r\nreturn dev;\r\n}\r\nstatic void nfcsim_device_free(struct nfcsim *dev)\r\n{\r\nnfc_digital_unregister_device(dev->nfc_digital_dev);\r\ndev->up = false;\r\nnfcsim_link_shutdown(dev->link_in);\r\ncancel_delayed_work_sync(&dev->send_work);\r\ncancel_work_sync(&dev->recv_work);\r\nnfc_digital_free_device(dev->nfc_digital_dev);\r\nkfree(dev);\r\n}\r\nstatic int __init nfcsim_init(void)\r\n{\r\nstruct nfcsim_link *link0, *link1;\r\nint rc;\r\nlink0 = nfcsim_link_new();\r\nlink1 = nfcsim_link_new();\r\nif (!link0 || !link1) {\r\nrc = -ENOMEM;\r\ngoto exit_err;\r\n}\r\nnfcsim_debugfs_init();\r\ndev0 = nfcsim_device_new(link0, link1);\r\nif (IS_ERR(dev0)) {\r\nrc = PTR_ERR(dev0);\r\ngoto exit_err;\r\n}\r\ndev1 = nfcsim_device_new(link1, link0);\r\nif (IS_ERR(dev1)) {\r\nnfcsim_device_free(dev0);\r\nrc = PTR_ERR(dev1);\r\ngoto exit_err;\r\n}\r\npr_info("nfcsim " NFCSIM_VERSION " initialized\n");\r\nreturn 0;\r\nexit_err:\r\npr_err("Failed to initialize nfcsim driver (%d)\n", rc);\r\nif (link0)\r\nnfcsim_link_free(link0);\r\nif (link1)\r\nnfcsim_link_free(link1);\r\nreturn rc;\r\n}\r\nstatic void __exit nfcsim_exit(void)\r\n{\r\nstruct nfcsim_link *link0, *link1;\r\nlink0 = dev0->link_in;\r\nlink1 = dev0->link_out;\r\nnfcsim_device_free(dev0);\r\nnfcsim_device_free(dev1);\r\nnfcsim_link_free(link0);\r\nnfcsim_link_free(link1);\r\nnfcsim_debugfs_remove();\r\n}

static int pata_of_platform_probe(struct platform_device *ofdev)\r\n{\r\nint ret;\r\nstruct device_node *dn = ofdev->dev.of_node;\r\nstruct resource io_res;\r\nstruct resource ctl_res;\r\nstruct resource *irq_res;\r\nunsigned int reg_shift = 0;\r\nint pio_mode = 0;\r\nint pio_mask;\r\nret = of_address_to_resource(dn, 0, &io_res);\r\nif (ret) {\r\ndev_err(&ofdev->dev, "can't get IO address from "\r\n"device tree\n");\r\nreturn -EINVAL;\r\n}\r\nret = of_address_to_resource(dn, 1, &ctl_res);\r\nif (ret) {\r\ndev_err(&ofdev->dev, "can't get CTL address from "\r\n"device tree\n");\r\nreturn -EINVAL;\r\n}\r\nirq_res = platform_get_resource(ofdev, IORESOURCE_IRQ, 0);\r\nof_property_read_u32(dn, "reg-shift", &reg_shift);\r\nif (!of_property_read_u32(dn, "pio-mode", &pio_mode)) {\r\nif (pio_mode > 6) {\r\ndev_err(&ofdev->dev, "invalid pio-mode\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\ndev_info(&ofdev->dev, "pio-mode unspecified, assuming PIO0\n");\r\n}\r\npio_mask = 1 << pio_mode;\r\npio_mask |= (1 << pio_mode) - 1;\r\nreturn __pata_platform_probe(&ofdev->dev, &io_res, &ctl_res, irq_res,\r\nreg_shift, pio_mask, &pata_platform_sht);\r\n}

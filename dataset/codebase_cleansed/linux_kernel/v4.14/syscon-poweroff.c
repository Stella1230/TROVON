static void syscon_poweroff(void)\r\n{\r\nregmap_update_bits(map, offset, mask, value);\r\nmdelay(1000);\r\npr_emerg("Unable to poweroff system\n");\r\n}\r\nstatic int syscon_poweroff_probe(struct platform_device *pdev)\r\n{\r\nchar symname[KSYM_NAME_LEN];\r\nint mask_err, value_err;\r\nmap = syscon_regmap_lookup_by_phandle(pdev->dev.of_node, "regmap");\r\nif (IS_ERR(map)) {\r\ndev_err(&pdev->dev, "unable to get syscon");\r\nreturn PTR_ERR(map);\r\n}\r\nif (of_property_read_u32(pdev->dev.of_node, "offset", &offset)) {\r\ndev_err(&pdev->dev, "unable to read 'offset'");\r\nreturn -EINVAL;\r\n}\r\nvalue_err = of_property_read_u32(pdev->dev.of_node, "value", &value);\r\nmask_err = of_property_read_u32(pdev->dev.of_node, "mask", &mask);\r\nif (value_err && mask_err) {\r\ndev_err(&pdev->dev, "unable to read 'value' and 'mask'");\r\nreturn -EINVAL;\r\n}\r\nif (value_err) {\r\nvalue = mask;\r\nmask = 0xFFFFFFFF;\r\n} else if (mask_err) {\r\nmask = 0xFFFFFFFF;\r\n}\r\nif (pm_power_off) {\r\nlookup_symbol_name((ulong)pm_power_off, symname);\r\ndev_err(&pdev->dev,\r\n"pm_power_off already claimed %p %s",\r\npm_power_off, symname);\r\nreturn -EBUSY;\r\n}\r\npm_power_off = syscon_poweroff;\r\nreturn 0;\r\n}\r\nstatic int syscon_poweroff_remove(struct platform_device *pdev)\r\n{\r\nif (pm_power_off == syscon_poweroff)\r\npm_power_off = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init syscon_poweroff_register(void)\r\n{\r\nreturn platform_driver_register(&syscon_poweroff_driver);\r\n}

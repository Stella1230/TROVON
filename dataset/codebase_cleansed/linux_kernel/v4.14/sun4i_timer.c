static void sun4i_clkevt_sync(void __iomem *base)\r\n{\r\nu32 old = readl(base + TIMER_CNTVAL_REG(1));\r\nwhile ((old - readl(base + TIMER_CNTVAL_REG(1))) < TIMER_SYNC_TICKS)\r\ncpu_relax();\r\n}\r\nstatic void sun4i_clkevt_time_stop(void __iomem *base, u8 timer)\r\n{\r\nu32 val = readl(base + TIMER_CTL_REG(timer));\r\nwritel(val & ~TIMER_CTL_ENABLE, base + TIMER_CTL_REG(timer));\r\nsun4i_clkevt_sync(base);\r\n}\r\nstatic void sun4i_clkevt_time_setup(void __iomem *base, u8 timer,\r\nunsigned long delay)\r\n{\r\nwritel(delay, base + TIMER_INTVAL_REG(timer));\r\n}\r\nstatic void sun4i_clkevt_time_start(void __iomem *base, u8 timer,\r\nbool periodic)\r\n{\r\nu32 val = readl(base + TIMER_CTL_REG(timer));\r\nif (periodic)\r\nval &= ~TIMER_CTL_ONESHOT;\r\nelse\r\nval |= TIMER_CTL_ONESHOT;\r\nwritel(val | TIMER_CTL_ENABLE | TIMER_CTL_RELOAD,\r\nbase + TIMER_CTL_REG(timer));\r\n}\r\nstatic int sun4i_clkevt_shutdown(struct clock_event_device *evt)\r\n{\r\nstruct timer_of *to = to_timer_of(evt);\r\nsun4i_clkevt_time_stop(timer_of_base(to), 0);\r\nreturn 0;\r\n}\r\nstatic int sun4i_clkevt_set_oneshot(struct clock_event_device *evt)\r\n{\r\nstruct timer_of *to = to_timer_of(evt);\r\nsun4i_clkevt_time_stop(timer_of_base(to), 0);\r\nsun4i_clkevt_time_start(timer_of_base(to), 0, false);\r\nreturn 0;\r\n}\r\nstatic int sun4i_clkevt_set_periodic(struct clock_event_device *evt)\r\n{\r\nstruct timer_of *to = to_timer_of(evt);\r\nsun4i_clkevt_time_stop(timer_of_base(to), 0);\r\nsun4i_clkevt_time_setup(timer_of_base(to), 0, timer_of_period(to));\r\nsun4i_clkevt_time_start(timer_of_base(to), 0, true);\r\nreturn 0;\r\n}\r\nstatic int sun4i_clkevt_next_event(unsigned long evt,\r\nstruct clock_event_device *clkevt)\r\n{\r\nstruct timer_of *to = to_timer_of(clkevt);\r\nsun4i_clkevt_time_stop(timer_of_base(to), 0);\r\nsun4i_clkevt_time_setup(timer_of_base(to), 0, evt - TIMER_SYNC_TICKS);\r\nsun4i_clkevt_time_start(timer_of_base(to), 0, false);\r\nreturn 0;\r\n}\r\nstatic void sun4i_timer_clear_interrupt(void __iomem *base)\r\n{\r\nwritel(TIMER_IRQ_EN(0), base + TIMER_IRQ_ST_REG);\r\n}\r\nstatic irqreturn_t sun4i_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\r\nstruct timer_of *to = to_timer_of(evt);\r\nsun4i_timer_clear_interrupt(timer_of_base(to));\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic u64 notrace sun4i_timer_sched_read(void)\r\n{\r\nreturn ~readl(timer_of_base(&to) + TIMER_CNTVAL_REG(1));\r\n}\r\nstatic int __init sun4i_timer_init(struct device_node *node)\r\n{\r\nint ret;\r\nu32 val;\r\nret = timer_of_init(node, &to);\r\nif (ret)\r\nreturn ret;\r\nwritel(~0, timer_of_base(&to) + TIMER_INTVAL_REG(1));\r\nwritel(TIMER_CTL_ENABLE | TIMER_CTL_RELOAD |\r\nTIMER_CTL_CLK_SRC(TIMER_CTL_CLK_SRC_OSC24M),\r\ntimer_of_base(&to) + TIMER_CTL_REG(1));\r\nif (of_machine_is_compatible("allwinner,sun4i-a10") ||\r\nof_machine_is_compatible("allwinner,sun5i-a13") ||\r\nof_machine_is_compatible("allwinner,sun5i-a10s"))\r\nsched_clock_register(sun4i_timer_sched_read, 32,\r\ntimer_of_rate(&to));\r\nret = clocksource_mmio_init(timer_of_base(&to) + TIMER_CNTVAL_REG(1),\r\nnode->name, timer_of_rate(&to), 350, 32,\r\nclocksource_mmio_readl_down);\r\nif (ret) {\r\npr_err("Failed to register clocksource\n");\r\nreturn ret;\r\n}\r\nwritel(TIMER_CTL_CLK_SRC(TIMER_CTL_CLK_SRC_OSC24M),\r\ntimer_of_base(&to) + TIMER_CTL_REG(0));\r\nsun4i_clkevt_time_stop(timer_of_base(&to), 0);\r\nsun4i_timer_clear_interrupt(timer_of_base(&to));\r\nclockevents_config_and_register(&to.clkevt, timer_of_rate(&to),\r\nTIMER_SYNC_TICKS, 0xffffffff);\r\nval = readl(timer_of_base(&to) + TIMER_IRQ_EN_REG);\r\nwritel(val | TIMER_IRQ_EN(0), timer_of_base(&to) + TIMER_IRQ_EN_REG);\r\nreturn ret;\r\n}

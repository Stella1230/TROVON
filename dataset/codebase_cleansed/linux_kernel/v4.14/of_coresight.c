static int of_dev_node_match(struct device *dev, void *data)\r\n{\r\nreturn dev->of_node == data;\r\n}\r\nstatic struct device *\r\nof_coresight_get_endpoint_device(struct device_node *endpoint)\r\n{\r\nstruct device *dev = NULL;\r\ndev = bus_find_device(&platform_bus_type, NULL,\r\nendpoint, of_dev_node_match);\r\nif (dev)\r\nreturn dev;\r\nreturn bus_find_device(&amba_bustype, NULL,\r\nendpoint, of_dev_node_match);\r\n}\r\nstatic void of_coresight_get_ports(const struct device_node *node,\r\nint *nr_inport, int *nr_outport)\r\n{\r\nstruct device_node *ep = NULL;\r\nint in = 0, out = 0;\r\ndo {\r\nep = of_graph_get_next_endpoint(node, ep);\r\nif (!ep)\r\nbreak;\r\nif (of_property_read_bool(ep, "slave-mode"))\r\nin++;\r\nelse\r\nout++;\r\n} while (ep);\r\n*nr_inport = in;\r\n*nr_outport = out;\r\n}\r\nstatic int of_coresight_alloc_memory(struct device *dev,\r\nstruct coresight_platform_data *pdata)\r\n{\r\npdata->outports = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->outports),\r\nGFP_KERNEL);\r\nif (!pdata->outports)\r\nreturn -ENOMEM;\r\npdata->child_names = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->child_names),\r\nGFP_KERNEL);\r\nif (!pdata->child_names)\r\nreturn -ENOMEM;\r\npdata->child_ports = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->child_ports),\r\nGFP_KERNEL);\r\nif (!pdata->child_ports)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nint of_coresight_get_cpu(const struct device_node *node)\r\n{\r\nint cpu;\r\nbool found;\r\nstruct device_node *dn, *np;\r\ndn = of_parse_phandle(node, "cpu", 0);\r\nif (!dn)\r\nreturn 0;\r\nfor_each_possible_cpu(cpu) {\r\nnp = of_cpu_device_node_get(cpu);\r\nfound = (dn == np);\r\nof_node_put(np);\r\nif (found)\r\nbreak;\r\n}\r\nof_node_put(dn);\r\nreturn found ? cpu : 0;\r\n}\r\nstruct coresight_platform_data *\r\nof_get_coresight_platform_data(struct device *dev,\r\nconst struct device_node *node)\r\n{\r\nint i = 0, ret = 0;\r\nstruct coresight_platform_data *pdata;\r\nstruct of_endpoint endpoint, rendpoint;\r\nstruct device *rdev;\r\nstruct device_node *ep = NULL;\r\nstruct device_node *rparent = NULL;\r\nstruct device_node *rport = NULL;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn ERR_PTR(-ENOMEM);\r\npdata->name = dev_name(dev);\r\nof_coresight_get_ports(node, &pdata->nr_inport, &pdata->nr_outport);\r\nif (pdata->nr_outport) {\r\nret = of_coresight_alloc_memory(dev, pdata);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\ndo {\r\nep = of_graph_get_next_endpoint(node, ep);\r\nif (!ep)\r\nbreak;\r\nif (of_find_property(ep, "slave-mode", NULL))\r\ncontinue;\r\nret = of_graph_parse_endpoint(ep, &endpoint);\r\nif (ret)\r\ncontinue;\r\npdata->outports[i] = endpoint.port;\r\nrparent = of_graph_get_remote_port_parent(ep);\r\nrport = of_graph_get_remote_port(ep);\r\nif (!rparent || !rport)\r\ncontinue;\r\nif (of_graph_parse_endpoint(rport, &rendpoint))\r\ncontinue;\r\nrdev = of_coresight_get_endpoint_device(rparent);\r\nif (!rdev)\r\nreturn ERR_PTR(-EPROBE_DEFER);\r\npdata->child_names[i] = dev_name(rdev);\r\npdata->child_ports[i] = rendpoint.id;\r\ni++;\r\n} while (ep);\r\n}\r\npdata->cpu = of_coresight_get_cpu(node);\r\nreturn pdata;\r\n}

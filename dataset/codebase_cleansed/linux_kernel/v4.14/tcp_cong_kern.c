int bpf_cong(struct bpf_sock_ops *skops)\r\n{\r\nchar cong[] = "dctcp";\r\nint rv = 0;\r\nint op;\r\nif (bpf_ntohl(skops->remote_port) != 55601 &&\r\nskops->local_port != 55601)\r\nreturn -1;\r\nop = (int) skops->op;\r\n#ifdef DEBUG\r\nbpf_printk("BPF command: %d\n", op);\r\n#endif\r\nif (skops->family == AF_INET6 &&\r\nskops->local_ip6[0] == skops->remote_ip6[0] &&\r\n(bpf_ntohl(skops->local_ip6[1]) & 0xfff00000) ==\r\n(bpf_ntohl(skops->remote_ip6[1]) & 0xfff00000)) {\r\nswitch (op) {\r\ncase BPF_SOCK_OPS_NEEDS_ECN:\r\nrv = 1;\r\nbreak;\r\ncase BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB:\r\nrv = bpf_setsockopt(skops, SOL_TCP, TCP_CONGESTION,\r\ncong, sizeof(cong));\r\nbreak;\r\ncase BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB:\r\nrv = bpf_setsockopt(skops, SOL_TCP, TCP_CONGESTION,\r\ncong, sizeof(cong));\r\nbreak;\r\ndefault:\r\nrv = -1;\r\n}\r\n} else {\r\nrv = -1;\r\n}\r\n#ifdef DEBUG\r\nbpf_printk("Returning %d\n", rv);\r\n#endif\r\nskops->reply = rv;\r\nreturn 1;\r\n}

static void print_tpte(struct c4iw_dev *dev, u32 stag)\r\n{\r\nint ret;\r\nstruct fw_ri_tpte tpte;\r\nret = cxgb4_read_tpte(dev->rdev.lldi.ports[0], stag,\r\n(__be32 *)&tpte);\r\nif (ret) {\r\ndev_err(&dev->rdev.lldi.pdev->dev,\r\n"%s cxgb4_read_tpte err %d\n", __func__, ret);\r\nreturn;\r\n}\r\npr_debug("stag idx 0x%x valid %d key 0x%x state %d pdid %d perm 0x%x ps %d len 0x%llx va 0x%llx\n",\r\nstag & 0xffffff00,\r\nFW_RI_TPTE_VALID_G(ntohl(tpte.valid_to_pdid)),\r\nFW_RI_TPTE_STAGKEY_G(ntohl(tpte.valid_to_pdid)),\r\nFW_RI_TPTE_STAGSTATE_G(ntohl(tpte.valid_to_pdid)),\r\nFW_RI_TPTE_PDID_G(ntohl(tpte.valid_to_pdid)),\r\nFW_RI_TPTE_PERM_G(ntohl(tpte.locread_to_qpid)),\r\nFW_RI_TPTE_PS_G(ntohl(tpte.locread_to_qpid)),\r\n((u64)ntohl(tpte.len_hi) << 32) | ntohl(tpte.len_lo),\r\n((u64)ntohl(tpte.va_hi) << 32) | ntohl(tpte.va_lo_fbo));\r\n}\r\nstatic void dump_err_cqe(struct c4iw_dev *dev, struct t4_cqe *err_cqe)\r\n{\r\n__be64 *p = (void *)err_cqe;\r\ndev_err(&dev->rdev.lldi.pdev->dev,\r\n"AE qpid %d opcode %d status 0x%x "\r\n"type %d len 0x%x wrid.hi 0x%x wrid.lo 0x%x\n",\r\nCQE_QPID(err_cqe), CQE_OPCODE(err_cqe),\r\nCQE_STATUS(err_cqe), CQE_TYPE(err_cqe), ntohl(err_cqe->len),\r\nCQE_WRID_HI(err_cqe), CQE_WRID_LOW(err_cqe));\r\npr_debug("%016llx %016llx %016llx %016llx\n",\r\nbe64_to_cpu(p[0]), be64_to_cpu(p[1]), be64_to_cpu(p[2]),\r\nbe64_to_cpu(p[3]));\r\nif (RQ_TYPE(err_cqe) && (CQE_OPCODE(err_cqe) == FW_RI_RDMA_WRITE ||\r\nCQE_OPCODE(err_cqe) == FW_RI_READ_RESP))\r\nprint_tpte(dev, CQE_WRID_STAG(err_cqe));\r\n}\r\nstatic void post_qp_event(struct c4iw_dev *dev, struct c4iw_cq *chp,\r\nstruct c4iw_qp *qhp,\r\nstruct t4_cqe *err_cqe,\r\nenum ib_event_type ib_event)\r\n{\r\nstruct ib_event event;\r\nstruct c4iw_qp_attributes attrs;\r\nunsigned long flag;\r\ndump_err_cqe(dev, err_cqe);\r\nif (qhp->attr.state == C4IW_QP_STATE_RTS) {\r\nattrs.next_state = C4IW_QP_STATE_TERMINATE;\r\nc4iw_modify_qp(qhp->rhp, qhp, C4IW_QP_ATTR_NEXT_STATE,\r\n&attrs, 0);\r\n}\r\nevent.event = ib_event;\r\nevent.device = chp->ibcq.device;\r\nif (ib_event == IB_EVENT_CQ_ERR)\r\nevent.element.cq = &chp->ibcq;\r\nelse\r\nevent.element.qp = &qhp->ibqp;\r\nif (qhp->ibqp.event_handler)\r\n(*qhp->ibqp.event_handler)(&event, qhp->ibqp.qp_context);\r\nspin_lock_irqsave(&chp->comp_handler_lock, flag);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nspin_unlock_irqrestore(&chp->comp_handler_lock, flag);\r\n}\r\nvoid c4iw_ev_dispatch(struct c4iw_dev *dev, struct t4_cqe *err_cqe)\r\n{\r\nstruct c4iw_cq *chp;\r\nstruct c4iw_qp *qhp;\r\nu32 cqid;\r\nspin_lock_irq(&dev->lock);\r\nqhp = get_qhp(dev, CQE_QPID(err_cqe));\r\nif (!qhp) {\r\npr_err("BAD AE qpid 0x%x opcode %d status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x\n",\r\nCQE_QPID(err_cqe),\r\nCQE_OPCODE(err_cqe), CQE_STATUS(err_cqe),\r\nCQE_TYPE(err_cqe), CQE_WRID_HI(err_cqe),\r\nCQE_WRID_LOW(err_cqe));\r\nspin_unlock_irq(&dev->lock);\r\ngoto out;\r\n}\r\nif (SQ_TYPE(err_cqe))\r\ncqid = qhp->attr.scq;\r\nelse\r\ncqid = qhp->attr.rcq;\r\nchp = get_chp(dev, cqid);\r\nif (!chp) {\r\npr_err("BAD AE cqid 0x%x qpid 0x%x opcode %d status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x\n",\r\ncqid, CQE_QPID(err_cqe),\r\nCQE_OPCODE(err_cqe), CQE_STATUS(err_cqe),\r\nCQE_TYPE(err_cqe), CQE_WRID_HI(err_cqe),\r\nCQE_WRID_LOW(err_cqe));\r\nspin_unlock_irq(&dev->lock);\r\ngoto out;\r\n}\r\nc4iw_qp_add_ref(&qhp->ibqp);\r\natomic_inc(&chp->refcnt);\r\nspin_unlock_irq(&dev->lock);\r\nif (RQ_TYPE(err_cqe) &&\r\n(CQE_OPCODE(err_cqe) == FW_RI_RDMA_WRITE)) {\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_REQ_ERR);\r\ngoto done;\r\n}\r\nswitch (CQE_STATUS(err_cqe)) {\r\ncase T4_ERR_SUCCESS:\r\npr_err("AE with status 0!\n");\r\nbreak;\r\ncase T4_ERR_STAG:\r\ncase T4_ERR_PDID:\r\ncase T4_ERR_QPID:\r\ncase T4_ERR_ACCESS:\r\ncase T4_ERR_WRAP:\r\ncase T4_ERR_BOUND:\r\ncase T4_ERR_INVALIDATE_SHARED_MR:\r\ncase T4_ERR_INVALIDATE_MR_WITH_MW_BOUND:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_ACCESS_ERR);\r\nbreak;\r\ncase T4_ERR_ECC:\r\ncase T4_ERR_ECC_PSTAG:\r\ncase T4_ERR_INTERNAL_ERR:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_DEVICE_FATAL);\r\nbreak;\r\ncase T4_ERR_OUT_OF_RQE:\r\ncase T4_ERR_PBL_ADDR_BOUND:\r\ncase T4_ERR_CRC:\r\ncase T4_ERR_MARKER:\r\ncase T4_ERR_PDU_LEN_ERR:\r\ncase T4_ERR_DDP_VERSION:\r\ncase T4_ERR_RDMA_VERSION:\r\ncase T4_ERR_OPCODE:\r\ncase T4_ERR_DDP_QUEUE_NUM:\r\ncase T4_ERR_MSN:\r\ncase T4_ERR_TBIT:\r\ncase T4_ERR_MO:\r\ncase T4_ERR_MSN_GAP:\r\ncase T4_ERR_MSN_RANGE:\r\ncase T4_ERR_RQE_ADDR_BOUND:\r\ncase T4_ERR_IRD_OVERFLOW:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_FATAL);\r\nbreak;\r\ndefault:\r\npr_err("Unknown T4 status 0x%x QPID 0x%x\n",\r\nCQE_STATUS(err_cqe), qhp->wq.sq.qid);\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_FATAL);\r\nbreak;\r\n}\r\ndone:\r\nif (atomic_dec_and_test(&chp->refcnt))\r\nwake_up(&chp->wait);\r\nc4iw_qp_rem_ref(&qhp->ibqp);\r\nout:\r\nreturn;\r\n}\r\nint c4iw_ev_handler(struct c4iw_dev *dev, u32 qid)\r\n{\r\nstruct c4iw_cq *chp;\r\nunsigned long flag;\r\nspin_lock_irqsave(&dev->lock, flag);\r\nchp = get_chp(dev, qid);\r\nif (chp) {\r\natomic_inc(&chp->refcnt);\r\nspin_unlock_irqrestore(&dev->lock, flag);\r\nt4_clear_cq_armed(&chp->cq);\r\nspin_lock_irqsave(&chp->comp_handler_lock, flag);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nspin_unlock_irqrestore(&chp->comp_handler_lock, flag);\r\nif (atomic_dec_and_test(&chp->refcnt))\r\nwake_up(&chp->wait);\r\n} else {\r\npr_debug("%s unknown cqid 0x%x\n", __func__, qid);\r\nspin_unlock_irqrestore(&dev->lock, flag);\r\n}\r\nreturn 0;\r\n}

int amdtp_tscm_set_parameters(struct amdtp_stream *s, unsigned int rate)\r\n{\r\nstruct amdtp_tscm *p = s->protocol;\r\nunsigned int data_channels;\r\nif (amdtp_stream_running(s))\r\nreturn -EBUSY;\r\ndata_channels = p->pcm_channels;\r\nif (s->direction == AMDTP_IN_STREAM)\r\ndata_channels += 2;\r\nreturn amdtp_stream_set_parameters(s, rate, data_channels);\r\n}\r\nstatic void write_pcm_s32(struct amdtp_stream *s,\r\nstruct snd_pcm_substream *pcm,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_tscm *p = s->protocol;\r\nstruct snd_pcm_runtime *runtime = pcm->runtime;\r\nunsigned int channels, remaining_frames, i, c;\r\nconst u32 *src;\r\nchannels = p->pcm_channels;\r\nsrc = (void *)runtime->dma_area +\r\nframes_to_bytes(runtime, s->pcm_buffer_pointer);\r\nremaining_frames = runtime->buffer_size - s->pcm_buffer_pointer;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c) {\r\nbuffer[c] = cpu_to_be32(*src);\r\nsrc++;\r\n}\r\nbuffer += s->data_block_quadlets;\r\nif (--remaining_frames == 0)\r\nsrc = (void *)runtime->dma_area;\r\n}\r\n}\r\nstatic void read_pcm_s32(struct amdtp_stream *s,\r\nstruct snd_pcm_substream *pcm,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_tscm *p = s->protocol;\r\nstruct snd_pcm_runtime *runtime = pcm->runtime;\r\nunsigned int channels, remaining_frames, i, c;\r\nu32 *dst;\r\nchannels = p->pcm_channels;\r\ndst = (void *)runtime->dma_area +\r\nframes_to_bytes(runtime, s->pcm_buffer_pointer);\r\nremaining_frames = runtime->buffer_size - s->pcm_buffer_pointer;\r\nbuffer += 1;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c) {\r\n*dst = be32_to_cpu(buffer[c]);\r\ndst++;\r\n}\r\nbuffer += s->data_block_quadlets;\r\nif (--remaining_frames == 0)\r\ndst = (void *)runtime->dma_area;\r\n}\r\n}\r\nstatic void write_pcm_silence(struct amdtp_stream *s, __be32 *buffer,\r\nunsigned int data_blocks)\r\n{\r\nstruct amdtp_tscm *p = s->protocol;\r\nunsigned int channels, i, c;\r\nchannels = p->pcm_channels;\r\nfor (i = 0; i < data_blocks; ++i) {\r\nfor (c = 0; c < channels; ++c)\r\nbuffer[c] = 0x00000000;\r\nbuffer += s->data_block_quadlets;\r\n}\r\n}\r\nint amdtp_tscm_add_pcm_hw_constraints(struct amdtp_stream *s,\r\nstruct snd_pcm_runtime *runtime)\r\n{\r\nint err;\r\nerr = snd_pcm_hw_constraint_msbits(runtime, 0, 32, 24);\r\nif (err < 0)\r\nreturn err;\r\nreturn amdtp_stream_add_pcm_hw_constraints(s, runtime);\r\n}\r\nstatic unsigned int process_tx_data_blocks(struct amdtp_stream *s,\r\n__be32 *buffer,\r\nunsigned int data_blocks,\r\nunsigned int *syt)\r\n{\r\nstruct snd_pcm_substream *pcm;\r\npcm = ACCESS_ONCE(s->pcm);\r\nif (data_blocks > 0 && pcm)\r\nread_pcm_s32(s, pcm, buffer, data_blocks);\r\nreturn data_blocks;\r\n}\r\nstatic unsigned int process_rx_data_blocks(struct amdtp_stream *s,\r\n__be32 *buffer,\r\nunsigned int data_blocks,\r\nunsigned int *syt)\r\n{\r\nstruct snd_pcm_substream *pcm;\r\n*syt = 0x0000;\r\npcm = ACCESS_ONCE(s->pcm);\r\nif (pcm)\r\nwrite_pcm_s32(s, pcm, buffer, data_blocks);\r\nelse\r\nwrite_pcm_silence(s, buffer, data_blocks);\r\nreturn data_blocks;\r\n}\r\nint amdtp_tscm_init(struct amdtp_stream *s, struct fw_unit *unit,\r\nenum amdtp_stream_direction dir, unsigned int pcm_channels)\r\n{\r\namdtp_stream_process_data_blocks_t process_data_blocks;\r\nstruct amdtp_tscm *p;\r\nunsigned int fmt;\r\nint err;\r\nif (dir == AMDTP_IN_STREAM) {\r\nfmt = AMDTP_FMT_TSCM_TX;\r\nprocess_data_blocks = process_tx_data_blocks;\r\n} else {\r\nfmt = AMDTP_FMT_TSCM_RX;\r\nprocess_data_blocks = process_rx_data_blocks;\r\n}\r\nerr = amdtp_stream_init(s, unit, dir,\r\nCIP_NONBLOCKING | CIP_SKIP_DBC_ZERO_CHECK, fmt,\r\nprocess_data_blocks, sizeof(struct amdtp_tscm));\r\nif (err < 0)\r\nreturn 0;\r\ns->fdf = 0x00;\r\np = s->protocol;\r\np->pcm_channels = pcm_channels;\r\nreturn 0;\r\n}

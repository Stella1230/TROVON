static int r200_get_vtx_size_0(uint32_t vtx_fmt_0)\r\n{\r\nint vtx_size, i;\r\nvtx_size = 2;\r\nif (vtx_fmt_0 & R200_VTX_Z0)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_W0)\r\nvtx_size++;\r\nif (vtx_fmt_0 & (0x7 << R200_VTX_WEIGHT_COUNT_SHIFT))\r\nvtx_size += (vtx_fmt_0 >> R200_VTX_WEIGHT_COUNT_SHIFT) & 0x7;\r\nif (vtx_fmt_0 & R200_VTX_PV_MATRIX_SEL)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_N0)\r\nvtx_size += 3;\r\nif (vtx_fmt_0 & R200_VTX_POINT_SIZE)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_DISCRETE_FOG)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_SHININESS_0)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_SHININESS_1)\r\nvtx_size++;\r\nfor (i = 0; i < 8; i++) {\r\nint color_size = (vtx_fmt_0 >> (11 + 2*i)) & 0x3;\r\nswitch (color_size) {\r\ncase 0: break;\r\ncase 1: vtx_size++; break;\r\ncase 2: vtx_size += 3; break;\r\ncase 3: vtx_size += 4; break;\r\n}\r\n}\r\nif (vtx_fmt_0 & R200_VTX_XY1)\r\nvtx_size += 2;\r\nif (vtx_fmt_0 & R200_VTX_Z1)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_W1)\r\nvtx_size++;\r\nif (vtx_fmt_0 & R200_VTX_N1)\r\nvtx_size += 3;\r\nreturn vtx_size;\r\n}\r\nstruct radeon_fence *r200_copy_dma(struct radeon_device *rdev,\r\nuint64_t src_offset,\r\nuint64_t dst_offset,\r\nunsigned num_gpu_pages,\r\nstruct reservation_object *resv)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nstruct radeon_fence *fence;\r\nuint32_t size;\r\nuint32_t cur_size;\r\nint i, num_loops;\r\nint r = 0;\r\nsize = num_gpu_pages << RADEON_GPU_PAGE_SHIFT;\r\nnum_loops = DIV_ROUND_UP(size, 0x1FFFFF);\r\nr = radeon_ring_lock(rdev, ring, num_loops * 4 + 64);\r\nif (r) {\r\nDRM_ERROR("radeon: moving bo (%d).\n", r);\r\nreturn ERR_PTR(r);\r\n}\r\nradeon_ring_write(ring, PACKET0(RADEON_WAIT_UNTIL, 0));\r\nradeon_ring_write(ring, (1 << 16));\r\nfor (i = 0; i < num_loops; i++) {\r\ncur_size = size;\r\nif (cur_size > 0x1FFFFF) {\r\ncur_size = 0x1FFFFF;\r\n}\r\nsize -= cur_size;\r\nradeon_ring_write(ring, PACKET0(0x720, 2));\r\nradeon_ring_write(ring, src_offset);\r\nradeon_ring_write(ring, dst_offset);\r\nradeon_ring_write(ring, cur_size | (1 << 31) | (1 << 30));\r\nsrc_offset += cur_size;\r\ndst_offset += cur_size;\r\n}\r\nradeon_ring_write(ring, PACKET0(RADEON_WAIT_UNTIL, 0));\r\nradeon_ring_write(ring, RADEON_WAIT_DMA_GUI_IDLE);\r\nr = radeon_fence_emit(rdev, &fence, RADEON_RING_TYPE_GFX_INDEX);\r\nif (r) {\r\nradeon_ring_unlock_undo(rdev, ring);\r\nreturn ERR_PTR(r);\r\n}\r\nradeon_ring_unlock_commit(rdev, ring, false);\r\nreturn fence;\r\n}\r\nstatic int r200_get_vtx_size_1(uint32_t vtx_fmt_1)\r\n{\r\nint vtx_size, i, tex_size;\r\nvtx_size = 0;\r\nfor (i = 0; i < 6; i++) {\r\ntex_size = (vtx_fmt_1 >> (i * 3)) & 0x7;\r\nif (tex_size > 4)\r\ncontinue;\r\nvtx_size += tex_size;\r\n}\r\nreturn vtx_size;\r\n}\r\nint r200_packet0_check(struct radeon_cs_parser *p,\r\nstruct radeon_cs_packet *pkt,\r\nunsigned idx, unsigned reg)\r\n{\r\nstruct radeon_bo_list *reloc;\r\nstruct r100_cs_track *track;\r\nvolatile uint32_t *ib;\r\nuint32_t tmp;\r\nint r;\r\nint i;\r\nint face;\r\nu32 tile_flags = 0;\r\nu32 idx_value;\r\nib = p->ib.ptr;\r\ntrack = (struct r100_cs_track *)p->track;\r\nidx_value = radeon_get_ib_value(p, idx);\r\nswitch (reg) {\r\ncase RADEON_CRTC_GUI_TRIG_VLINE:\r\nr = r100_cs_packet_parse_vline(p);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\nbreak;\r\ncase RADEON_DST_PITCH_OFFSET:\r\ncase RADEON_SRC_PITCH_OFFSET:\r\nr = r100_reloc_pitch_offset(p, pkt, idx, reg);\r\nif (r)\r\nreturn r;\r\nbreak;\r\ncase RADEON_RB3D_DEPTHOFFSET:\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\ntrack->zb.robj = reloc->robj;\r\ntrack->zb.offset = idx_value;\r\ntrack->zb_dirty = true;\r\nib[idx] = idx_value + ((u32)reloc->gpu_offset);\r\nbreak;\r\ncase RADEON_RB3D_COLOROFFSET:\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\ntrack->cb[0].robj = reloc->robj;\r\ntrack->cb[0].offset = idx_value;\r\ntrack->cb_dirty = true;\r\nib[idx] = idx_value + ((u32)reloc->gpu_offset);\r\nbreak;\r\ncase R200_PP_TXOFFSET_0:\r\ncase R200_PP_TXOFFSET_1:\r\ncase R200_PP_TXOFFSET_2:\r\ncase R200_PP_TXOFFSET_3:\r\ncase R200_PP_TXOFFSET_4:\r\ncase R200_PP_TXOFFSET_5:\r\ni = (reg - R200_PP_TXOFFSET_0) / 24;\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\nif (!(p->cs_flags & RADEON_CS_KEEP_TILING_FLAGS)) {\r\nif (reloc->tiling_flags & RADEON_TILING_MACRO)\r\ntile_flags |= R200_TXO_MACRO_TILE;\r\nif (reloc->tiling_flags & RADEON_TILING_MICRO)\r\ntile_flags |= R200_TXO_MICRO_TILE;\r\ntmp = idx_value & ~(0x7 << 2);\r\ntmp |= tile_flags;\r\nib[idx] = tmp + ((u32)reloc->gpu_offset);\r\n} else\r\nib[idx] = idx_value + ((u32)reloc->gpu_offset);\r\ntrack->textures[i].robj = reloc->robj;\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_CUBIC_OFFSET_F1_0:\r\ncase R200_PP_CUBIC_OFFSET_F2_0:\r\ncase R200_PP_CUBIC_OFFSET_F3_0:\r\ncase R200_PP_CUBIC_OFFSET_F4_0:\r\ncase R200_PP_CUBIC_OFFSET_F5_0:\r\ncase R200_PP_CUBIC_OFFSET_F1_1:\r\ncase R200_PP_CUBIC_OFFSET_F2_1:\r\ncase R200_PP_CUBIC_OFFSET_F3_1:\r\ncase R200_PP_CUBIC_OFFSET_F4_1:\r\ncase R200_PP_CUBIC_OFFSET_F5_1:\r\ncase R200_PP_CUBIC_OFFSET_F1_2:\r\ncase R200_PP_CUBIC_OFFSET_F2_2:\r\ncase R200_PP_CUBIC_OFFSET_F3_2:\r\ncase R200_PP_CUBIC_OFFSET_F4_2:\r\ncase R200_PP_CUBIC_OFFSET_F5_2:\r\ncase R200_PP_CUBIC_OFFSET_F1_3:\r\ncase R200_PP_CUBIC_OFFSET_F2_3:\r\ncase R200_PP_CUBIC_OFFSET_F3_3:\r\ncase R200_PP_CUBIC_OFFSET_F4_3:\r\ncase R200_PP_CUBIC_OFFSET_F5_3:\r\ncase R200_PP_CUBIC_OFFSET_F1_4:\r\ncase R200_PP_CUBIC_OFFSET_F2_4:\r\ncase R200_PP_CUBIC_OFFSET_F3_4:\r\ncase R200_PP_CUBIC_OFFSET_F4_4:\r\ncase R200_PP_CUBIC_OFFSET_F5_4:\r\ncase R200_PP_CUBIC_OFFSET_F1_5:\r\ncase R200_PP_CUBIC_OFFSET_F2_5:\r\ncase R200_PP_CUBIC_OFFSET_F3_5:\r\ncase R200_PP_CUBIC_OFFSET_F4_5:\r\ncase R200_PP_CUBIC_OFFSET_F5_5:\r\ni = (reg - R200_PP_TXOFFSET_0) / 24;\r\nface = (reg - ((i * 24) + R200_PP_TXOFFSET_0)) / 4;\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\ntrack->textures[i].cube_info[face - 1].offset = idx_value;\r\nib[idx] = idx_value + ((u32)reloc->gpu_offset);\r\ntrack->textures[i].cube_info[face - 1].robj = reloc->robj;\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase RADEON_RE_WIDTH_HEIGHT:\r\ntrack->maxy = ((idx_value >> 16) & 0x7FF);\r\ntrack->cb_dirty = true;\r\ntrack->zb_dirty = true;\r\nbreak;\r\ncase RADEON_RB3D_COLORPITCH:\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\nif (!(p->cs_flags & RADEON_CS_KEEP_TILING_FLAGS)) {\r\nif (reloc->tiling_flags & RADEON_TILING_MACRO)\r\ntile_flags |= RADEON_COLOR_TILE_ENABLE;\r\nif (reloc->tiling_flags & RADEON_TILING_MICRO)\r\ntile_flags |= RADEON_COLOR_MICROTILE_ENABLE;\r\ntmp = idx_value & ~(0x7 << 16);\r\ntmp |= tile_flags;\r\nib[idx] = tmp;\r\n} else\r\nib[idx] = idx_value;\r\ntrack->cb[0].pitch = idx_value & RADEON_COLORPITCH_MASK;\r\ntrack->cb_dirty = true;\r\nbreak;\r\ncase RADEON_RB3D_DEPTHPITCH:\r\ntrack->zb.pitch = idx_value & RADEON_DEPTHPITCH_MASK;\r\ntrack->zb_dirty = true;\r\nbreak;\r\ncase RADEON_RB3D_CNTL:\r\nswitch ((idx_value >> RADEON_RB3D_COLOR_FORMAT_SHIFT) & 0x1f) {\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ncase 11:\r\ncase 12:\r\ntrack->cb[0].cpp = 1;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 15:\r\ntrack->cb[0].cpp = 2;\r\nbreak;\r\ncase 6:\r\ntrack->cb[0].cpp = 4;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Invalid color buffer format (%d) !\n",\r\n((idx_value >> RADEON_RB3D_COLOR_FORMAT_SHIFT) & 0x1f));\r\nreturn -EINVAL;\r\n}\r\nif (idx_value & RADEON_DEPTHXY_OFFSET_ENABLE) {\r\nDRM_ERROR("No support for depth xy offset in kms\n");\r\nreturn -EINVAL;\r\n}\r\ntrack->z_enabled = !!(idx_value & RADEON_Z_ENABLE);\r\ntrack->cb_dirty = true;\r\ntrack->zb_dirty = true;\r\nbreak;\r\ncase RADEON_RB3D_ZSTENCILCNTL:\r\nswitch (idx_value & 0xf) {\r\ncase 0:\r\ntrack->zb.cpp = 2;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 9:\r\ncase 11:\r\ntrack->zb.cpp = 4;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ntrack->zb_dirty = true;\r\nbreak;\r\ncase RADEON_RB3D_ZPASS_ADDR:\r\nr = radeon_cs_packet_next_reloc(p, &reloc, 0);\r\nif (r) {\r\nDRM_ERROR("No reloc for ib[%d]=0x%04X\n",\r\nidx, reg);\r\nradeon_cs_dump_packet(p, pkt);\r\nreturn r;\r\n}\r\nib[idx] = idx_value + ((u32)reloc->gpu_offset);\r\nbreak;\r\ncase RADEON_PP_CNTL:\r\n{\r\nuint32_t temp = idx_value >> 4;\r\nfor (i = 0; i < track->num_texture; i++)\r\ntrack->textures[i].enabled = !!(temp & (1 << i));\r\ntrack->tex_dirty = true;\r\n}\r\nbreak;\r\ncase RADEON_SE_VF_CNTL:\r\ntrack->vap_vf_cntl = idx_value;\r\nbreak;\r\ncase 0x210c:\r\ntrack->max_indx = idx_value & 0x00FFFFFFUL;\r\nbreak;\r\ncase R200_SE_VTX_FMT_0:\r\ntrack->vtx_size = r200_get_vtx_size_0(idx_value);\r\nbreak;\r\ncase R200_SE_VTX_FMT_1:\r\ntrack->vtx_size += r200_get_vtx_size_1(idx_value);\r\nbreak;\r\ncase R200_PP_TXSIZE_0:\r\ncase R200_PP_TXSIZE_1:\r\ncase R200_PP_TXSIZE_2:\r\ncase R200_PP_TXSIZE_3:\r\ncase R200_PP_TXSIZE_4:\r\ncase R200_PP_TXSIZE_5:\r\ni = (reg - R200_PP_TXSIZE_0) / 32;\r\ntrack->textures[i].width = (idx_value & RADEON_TEX_USIZE_MASK) + 1;\r\ntrack->textures[i].height = ((idx_value & RADEON_TEX_VSIZE_MASK) >> RADEON_TEX_VSIZE_SHIFT) + 1;\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_TXPITCH_0:\r\ncase R200_PP_TXPITCH_1:\r\ncase R200_PP_TXPITCH_2:\r\ncase R200_PP_TXPITCH_3:\r\ncase R200_PP_TXPITCH_4:\r\ncase R200_PP_TXPITCH_5:\r\ni = (reg - R200_PP_TXPITCH_0) / 32;\r\ntrack->textures[i].pitch = idx_value + 32;\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_TXFILTER_0:\r\ncase R200_PP_TXFILTER_1:\r\ncase R200_PP_TXFILTER_2:\r\ncase R200_PP_TXFILTER_3:\r\ncase R200_PP_TXFILTER_4:\r\ncase R200_PP_TXFILTER_5:\r\ni = (reg - R200_PP_TXFILTER_0) / 32;\r\ntrack->textures[i].num_levels = ((idx_value & R200_MAX_MIP_LEVEL_MASK)\r\n>> R200_MAX_MIP_LEVEL_SHIFT);\r\ntmp = (idx_value >> 23) & 0x7;\r\nif (tmp == 2 || tmp == 6)\r\ntrack->textures[i].roundup_w = false;\r\ntmp = (idx_value >> 27) & 0x7;\r\nif (tmp == 2 || tmp == 6)\r\ntrack->textures[i].roundup_h = false;\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_TXMULTI_CTL_0:\r\ncase R200_PP_TXMULTI_CTL_1:\r\ncase R200_PP_TXMULTI_CTL_2:\r\ncase R200_PP_TXMULTI_CTL_3:\r\ncase R200_PP_TXMULTI_CTL_4:\r\ncase R200_PP_TXMULTI_CTL_5:\r\ni = (reg - R200_PP_TXMULTI_CTL_0) / 32;\r\nbreak;\r\ncase R200_PP_TXFORMAT_X_0:\r\ncase R200_PP_TXFORMAT_X_1:\r\ncase R200_PP_TXFORMAT_X_2:\r\ncase R200_PP_TXFORMAT_X_3:\r\ncase R200_PP_TXFORMAT_X_4:\r\ncase R200_PP_TXFORMAT_X_5:\r\ni = (reg - R200_PP_TXFORMAT_X_0) / 32;\r\ntrack->textures[i].txdepth = idx_value & 0x7;\r\ntmp = (idx_value >> 16) & 0x3;\r\nswitch (tmp) {\r\ncase 0:\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\ntrack->textures[i].tex_coord_type = 0;\r\nbreak;\r\ncase 1:\r\ntrack->textures[i].tex_coord_type = 2;\r\nbreak;\r\ncase 2:\r\ntrack->textures[i].tex_coord_type = 1;\r\nbreak;\r\n}\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_TXFORMAT_0:\r\ncase R200_PP_TXFORMAT_1:\r\ncase R200_PP_TXFORMAT_2:\r\ncase R200_PP_TXFORMAT_3:\r\ncase R200_PP_TXFORMAT_4:\r\ncase R200_PP_TXFORMAT_5:\r\ni = (reg - R200_PP_TXFORMAT_0) / 32;\r\nif (idx_value & R200_TXFORMAT_NON_POWER2) {\r\ntrack->textures[i].use_pitch = 1;\r\n} else {\r\ntrack->textures[i].use_pitch = 0;\r\ntrack->textures[i].width = 1 << ((idx_value >> RADEON_TXFORMAT_WIDTH_SHIFT) & RADEON_TXFORMAT_WIDTH_MASK);\r\ntrack->textures[i].height = 1 << ((idx_value >> RADEON_TXFORMAT_HEIGHT_SHIFT) & RADEON_TXFORMAT_HEIGHT_MASK);\r\n}\r\nif (idx_value & R200_TXFORMAT_LOOKUP_DISABLE)\r\ntrack->textures[i].lookup_disable = true;\r\nswitch ((idx_value & RADEON_TXFORMAT_FORMAT_MASK)) {\r\ncase R200_TXFORMAT_I8:\r\ncase R200_TXFORMAT_RGB332:\r\ncase R200_TXFORMAT_Y8:\r\ntrack->textures[i].cpp = 1;\r\ntrack->textures[i].compress_format = R100_TRACK_COMP_NONE;\r\nbreak;\r\ncase R200_TXFORMAT_AI88:\r\ncase R200_TXFORMAT_ARGB1555:\r\ncase R200_TXFORMAT_RGB565:\r\ncase R200_TXFORMAT_ARGB4444:\r\ncase R200_TXFORMAT_VYUY422:\r\ncase R200_TXFORMAT_YVYU422:\r\ncase R200_TXFORMAT_LDVDU655:\r\ncase R200_TXFORMAT_DVDU88:\r\ncase R200_TXFORMAT_AVYU4444:\r\ntrack->textures[i].cpp = 2;\r\ntrack->textures[i].compress_format = R100_TRACK_COMP_NONE;\r\nbreak;\r\ncase R200_TXFORMAT_ARGB8888:\r\ncase R200_TXFORMAT_RGBA8888:\r\ncase R200_TXFORMAT_ABGR8888:\r\ncase R200_TXFORMAT_BGR111110:\r\ncase R200_TXFORMAT_LDVDU8888:\r\ntrack->textures[i].cpp = 4;\r\ntrack->textures[i].compress_format = R100_TRACK_COMP_NONE;\r\nbreak;\r\ncase R200_TXFORMAT_DXT1:\r\ntrack->textures[i].cpp = 1;\r\ntrack->textures[i].compress_format = R100_TRACK_COMP_DXT1;\r\nbreak;\r\ncase R200_TXFORMAT_DXT23:\r\ncase R200_TXFORMAT_DXT45:\r\ntrack->textures[i].cpp = 1;\r\ntrack->textures[i].compress_format = R100_TRACK_COMP_DXT1;\r\nbreak;\r\n}\r\ntrack->textures[i].cube_info[4].width = 1 << ((idx_value >> 16) & 0xf);\r\ntrack->textures[i].cube_info[4].height = 1 << ((idx_value >> 20) & 0xf);\r\ntrack->tex_dirty = true;\r\nbreak;\r\ncase R200_PP_CUBIC_FACES_0:\r\ncase R200_PP_CUBIC_FACES_1:\r\ncase R200_PP_CUBIC_FACES_2:\r\ncase R200_PP_CUBIC_FACES_3:\r\ncase R200_PP_CUBIC_FACES_4:\r\ncase R200_PP_CUBIC_FACES_5:\r\ntmp = idx_value;\r\ni = (reg - R200_PP_CUBIC_FACES_0) / 32;\r\nfor (face = 0; face < 4; face++) {\r\ntrack->textures[i].cube_info[face].width = 1 << ((tmp >> (face * 8)) & 0xf);\r\ntrack->textures[i].cube_info[face].height = 1 << ((tmp >> ((face * 8) + 4)) & 0xf);\r\n}\r\ntrack->tex_dirty = true;\r\nbreak;\r\ndefault:\r\npr_err("Forbidden register 0x%04X in cs at %d\n", reg, idx);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nvoid r200_set_safe_registers(struct radeon_device *rdev)\r\n{\r\nrdev->config.r100.reg_safe_bm = r200_reg_safe_bm;\r\nrdev->config.r100.reg_safe_bm_size = ARRAY_SIZE(r200_reg_safe_bm);\r\n}

static int sa1100_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn readl_relaxed(sa1100_gpio_chip(chip)->membase + R_GPLR) &\r\nBIT(offset);\r\n}\r\nstatic void sa1100_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nint reg = value ? R_GPSR : R_GPCR;\r\nwritel_relaxed(BIT(offset), sa1100_gpio_chip(chip)->membase + reg);\r\n}\r\nstatic int sa1100_get_direction(struct gpio_chip *chip, unsigned offset)\r\n{\r\nvoid __iomem *gpdr = sa1100_gpio_chip(chip)->membase + R_GPDR;\r\nreturn !(readl_relaxed(gpdr) & BIT(offset));\r\n}\r\nstatic int sa1100_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nvoid __iomem *gpdr = sa1100_gpio_chip(chip)->membase + R_GPDR;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nwritel_relaxed(readl_relaxed(gpdr) & ~BIT(offset), gpdr);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int sa1100_direction_output(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nvoid __iomem *gpdr = sa1100_gpio_chip(chip)->membase + R_GPDR;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsa1100_gpio_set(chip, offset, value);\r\nwritel_relaxed(readl_relaxed(gpdr) | BIT(offset), gpdr);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int sa1100_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn sa1100_gpio_chip(chip)->irqbase + offset;\r\n}\r\nstatic void sa1100_update_edge_regs(struct sa1100_gpio_chip *sgc)\r\n{\r\nvoid *base = sgc->membase;\r\nu32 grer, gfer;\r\ngrer = sgc->irqrising & sgc->irqmask;\r\ngfer = sgc->irqfalling & sgc->irqmask;\r\nwritel_relaxed(grer, base + R_GRER);\r\nwritel_relaxed(gfer, base + R_GFER);\r\n}\r\nstatic int sa1100_gpio_type(struct irq_data *d, unsigned int type)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_data_get_irq_chip_data(d);\r\nunsigned int mask = BIT(d->hwirq);\r\nif (type == IRQ_TYPE_PROBE) {\r\nif ((sgc->irqrising | sgc->irqfalling) & mask)\r\nreturn 0;\r\ntype = IRQ_TYPE_EDGE_RISING | IRQ_TYPE_EDGE_FALLING;\r\n}\r\nif (type & IRQ_TYPE_EDGE_RISING)\r\nsgc->irqrising |= mask;\r\nelse\r\nsgc->irqrising &= ~mask;\r\nif (type & IRQ_TYPE_EDGE_FALLING)\r\nsgc->irqfalling |= mask;\r\nelse\r\nsgc->irqfalling &= ~mask;\r\nsa1100_update_edge_regs(sgc);\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_ack(struct irq_data *d)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_data_get_irq_chip_data(d);\r\nwritel_relaxed(BIT(d->hwirq), sgc->membase + R_GEDR);\r\n}\r\nstatic void sa1100_gpio_mask(struct irq_data *d)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_data_get_irq_chip_data(d);\r\nunsigned int mask = BIT(d->hwirq);\r\nsgc->irqmask &= ~mask;\r\nsa1100_update_edge_regs(sgc);\r\n}\r\nstatic void sa1100_gpio_unmask(struct irq_data *d)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_data_get_irq_chip_data(d);\r\nunsigned int mask = BIT(d->hwirq);\r\nsgc->irqmask |= mask;\r\nsa1100_update_edge_regs(sgc);\r\n}\r\nstatic int sa1100_gpio_wake(struct irq_data *d, unsigned int on)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_data_get_irq_chip_data(d);\r\nint ret = sa11x0_gpio_set_wake(d->hwirq, on);\r\nif (!ret) {\r\nif (on)\r\nsgc->irqwake |= BIT(d->hwirq);\r\nelse\r\nsgc->irqwake &= ~BIT(d->hwirq);\r\n}\r\nreturn ret;\r\n}\r\nstatic int sa1100_gpio_irqdomain_map(struct irq_domain *d,\r\nunsigned int irq, irq_hw_number_t hwirq)\r\n{\r\nstruct sa1100_gpio_chip *sgc = d->host_data;\r\nirq_set_chip_data(irq, sgc);\r\nirq_set_chip_and_handler(irq, &sa1100_gpio_irq_chip, handle_edge_irq);\r\nirq_set_probe(irq);\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_handler(struct irq_desc *desc)\r\n{\r\nstruct sa1100_gpio_chip *sgc = irq_desc_get_handler_data(desc);\r\nunsigned int irq, mask;\r\nvoid __iomem *gedr = sgc->membase + R_GEDR;\r\nmask = readl_relaxed(gedr);\r\ndo {\r\nwritel_relaxed(mask, gedr);\r\nirq = sgc->irqbase;\r\ndo {\r\nif (mask & 1)\r\ngeneric_handle_irq(irq);\r\nmask >>= 1;\r\nirq++;\r\n} while (mask);\r\nmask = readl_relaxed(gedr);\r\n} while (mask);\r\n}\r\nstatic int sa1100_gpio_suspend(void)\r\n{\r\nstruct sa1100_gpio_chip *sgc = &sa1100_gpio_chip;\r\nwritel_relaxed(sgc->irqwake & sgc->irqrising, sgc->membase + R_GRER);\r\nwritel_relaxed(sgc->irqwake & sgc->irqfalling, sgc->membase + R_GFER);\r\nwritel_relaxed(readl_relaxed(sgc->membase + R_GEDR),\r\nsgc->membase + R_GEDR);\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_resume(void)\r\n{\r\nsa1100_update_edge_regs(&sa1100_gpio_chip);\r\n}\r\nstatic int __init sa1100_gpio_init_devicefs(void)\r\n{\r\nregister_syscore_ops(&sa1100_gpio_syscore_ops);\r\nreturn 0;\r\n}\r\nvoid __init sa1100_init_gpio(void)\r\n{\r\nstruct sa1100_gpio_chip *sgc = &sa1100_gpio_chip;\r\nint i;\r\nwritel_relaxed(0, sgc->membase + R_GFER);\r\nwritel_relaxed(0, sgc->membase + R_GRER);\r\nwritel_relaxed(-1, sgc->membase + R_GEDR);\r\ngpiochip_add_data(&sa1100_gpio_chip.chip, NULL);\r\nsa1100_gpio_irqdomain = irq_domain_add_simple(NULL,\r\n28, IRQ_GPIO0,\r\n&sa1100_gpio_irqdomain_ops, sgc);\r\nfor (i = 0; i < ARRAY_SIZE(sa1100_gpio_irqs); i++)\r\nirq_set_chained_handler_and_data(sa1100_gpio_irqs[i],\r\nsa1100_gpio_handler, sgc);\r\n}

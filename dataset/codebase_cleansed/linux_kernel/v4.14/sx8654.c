static irqreturn_t sx8654_irq(int irq, void *handle)\r\n{\r\nstruct sx8654 *sx8654 = handle;\r\nint irqsrc;\r\nu8 data[4];\r\nunsigned int x, y;\r\nint retval;\r\nirqsrc = i2c_smbus_read_byte_data(sx8654->client,\r\nCMD_READ_REGISTER | I2C_REG_IRQSRC);\r\ndev_dbg(&sx8654->client->dev, "irqsrc = 0x%x", irqsrc);\r\nif (irqsrc < 0)\r\ngoto out;\r\nif (irqsrc & IRQ_PENRELEASE) {\r\ndev_dbg(&sx8654->client->dev, "pen release interrupt");\r\ninput_report_key(sx8654->input, BTN_TOUCH, 0);\r\ninput_sync(sx8654->input);\r\n}\r\nif (irqsrc & IRQ_PENTOUCH_TOUCHCONVDONE) {\r\ndev_dbg(&sx8654->client->dev, "pen touch interrupt");\r\nretval = i2c_master_recv(sx8654->client, data, sizeof(data));\r\nif (retval != sizeof(data))\r\ngoto out;\r\nif (unlikely(data[0] & 0x80 || data[2] & 0x80))\r\ngoto out;\r\nx = ((data[0] & 0xf) << 8) | (data[1]);\r\ny = ((data[2] & 0xf) << 8) | (data[3]);\r\ninput_report_abs(sx8654->input, ABS_X, x);\r\ninput_report_abs(sx8654->input, ABS_Y, y);\r\ninput_report_key(sx8654->input, BTN_TOUCH, 1);\r\ninput_sync(sx8654->input);\r\ndev_dbg(&sx8654->client->dev, "point(%4d,%4d)\n", x, y);\r\n}\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sx8654_open(struct input_dev *dev)\r\n{\r\nstruct sx8654 *sx8654 = input_get_drvdata(dev);\r\nstruct i2c_client *client = sx8654->client;\r\nint error;\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_TOUCH0,\r\nRATE_5000CPS | POWDLY_1_1MS);\r\nif (error) {\r\ndev_err(&client->dev, "writing to I2C_REG_TOUCH0 failed");\r\nreturn error;\r\n}\r\nerror = i2c_smbus_write_byte(client, CMD_PENTRG);\r\nif (error) {\r\ndev_err(&client->dev, "writing command CMD_PENTRG failed");\r\nreturn error;\r\n}\r\nenable_irq(client->irq);\r\nreturn 0;\r\n}\r\nstatic void sx8654_close(struct input_dev *dev)\r\n{\r\nstruct sx8654 *sx8654 = input_get_drvdata(dev);\r\nstruct i2c_client *client = sx8654->client;\r\nint error;\r\ndisable_irq(client->irq);\r\nerror = i2c_smbus_write_byte(client, CMD_MANUAL);\r\nif (error) {\r\ndev_err(&client->dev, "writing command CMD_MANUAL failed");\r\nreturn;\r\n}\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_TOUCH0, 0);\r\nif (error) {\r\ndev_err(&client->dev, "writing to I2C_REG_TOUCH0 failed");\r\nreturn;\r\n}\r\n}\r\nstatic int sx8654_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct sx8654 *sx8654;\r\nstruct input_dev *input;\r\nint error;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_WORD_DATA))\r\nreturn -ENXIO;\r\nsx8654 = devm_kzalloc(&client->dev, sizeof(*sx8654), GFP_KERNEL);\r\nif (!sx8654)\r\nreturn -ENOMEM;\r\ninput = devm_input_allocate_device(&client->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ninput->name = "SX8654 I2C Touchscreen";\r\ninput->id.bustype = BUS_I2C;\r\ninput->dev.parent = &client->dev;\r\ninput->open = sx8654_open;\r\ninput->close = sx8654_close;\r\n__set_bit(INPUT_PROP_DIRECT, input->propbit);\r\ninput_set_capability(input, EV_KEY, BTN_TOUCH);\r\ninput_set_abs_params(input, ABS_X, 0, MAX_12BIT, 0, 0);\r\ninput_set_abs_params(input, ABS_Y, 0, MAX_12BIT, 0, 0);\r\nsx8654->client = client;\r\nsx8654->input = input;\r\ninput_set_drvdata(sx8654->input, sx8654);\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_SOFTRESET,\r\nSOFTRESET_VALUE);\r\nif (error) {\r\ndev_err(&client->dev, "writing softreset value failed");\r\nreturn error;\r\n}\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_CHANMASK,\r\nCONV_X | CONV_Y);\r\nif (error) {\r\ndev_err(&client->dev, "writing to I2C_REG_CHANMASK failed");\r\nreturn error;\r\n}\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_IRQMASK,\r\nIRQ_PENTOUCH_TOUCHCONVDONE |\r\nIRQ_PENRELEASE);\r\nif (error) {\r\ndev_err(&client->dev, "writing to I2C_REG_IRQMASK failed");\r\nreturn error;\r\n}\r\nerror = i2c_smbus_write_byte_data(client, I2C_REG_TOUCH1,\r\nCONDIRQ | FILT_7SA);\r\nif (error) {\r\ndev_err(&client->dev, "writing to I2C_REG_TOUCH1 failed");\r\nreturn error;\r\n}\r\nerror = devm_request_threaded_irq(&client->dev, client->irq,\r\nNULL, sx8654_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\nclient->name, sx8654);\r\nif (error) {\r\ndev_err(&client->dev,\r\n"Failed to enable IRQ %d, error: %d\n",\r\nclient->irq, error);\r\nreturn error;\r\n}\r\ndisable_irq(client->irq);\r\nerror = input_register_device(sx8654->input);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}

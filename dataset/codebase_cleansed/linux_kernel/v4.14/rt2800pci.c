static bool rt2800pci_hwcrypt_disabled(struct rt2x00_dev *rt2x00dev)\r\n{\r\nreturn modparam_nohwcrypt;\r\n}\r\nstatic void rt2800pci_mcu_status(struct rt2x00_dev *rt2x00dev, const u8 token)\r\n{\r\nunsigned int i;\r\nu32 reg;\r\nif (rt2x00_is_soc(rt2x00dev))\r\nreturn;\r\nfor (i = 0; i < 200; i++) {\r\nreg = rt2x00mmio_register_read(rt2x00dev, H2M_MAILBOX_CID);\r\nif ((rt2x00_get_field32(reg, H2M_MAILBOX_CID_CMD0) == token) ||\r\n(rt2x00_get_field32(reg, H2M_MAILBOX_CID_CMD1) == token) ||\r\n(rt2x00_get_field32(reg, H2M_MAILBOX_CID_CMD2) == token) ||\r\n(rt2x00_get_field32(reg, H2M_MAILBOX_CID_CMD3) == token))\r\nbreak;\r\nudelay(REGISTER_BUSY_DELAY);\r\n}\r\nif (i == 200)\r\nrt2x00_err(rt2x00dev, "MCU request failed, no response from hardware\n");\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_STATUS, ~0);\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_CID, ~0);\r\n}\r\nstatic void rt2800pci_eepromregister_read(struct eeprom_93cx6 *eeprom)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = eeprom->data;\r\nu32 reg;\r\nreg = rt2x00mmio_register_read(rt2x00dev, E2PROM_CSR);\r\neeprom->reg_data_in = !!rt2x00_get_field32(reg, E2PROM_CSR_DATA_IN);\r\neeprom->reg_data_out = !!rt2x00_get_field32(reg, E2PROM_CSR_DATA_OUT);\r\neeprom->reg_data_clock =\r\n!!rt2x00_get_field32(reg, E2PROM_CSR_DATA_CLOCK);\r\neeprom->reg_chip_select =\r\n!!rt2x00_get_field32(reg, E2PROM_CSR_CHIP_SELECT);\r\n}\r\nstatic void rt2800pci_eepromregister_write(struct eeprom_93cx6 *eeprom)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = eeprom->data;\r\nu32 reg = 0;\r\nrt2x00_set_field32(&reg, E2PROM_CSR_DATA_IN, !!eeprom->reg_data_in);\r\nrt2x00_set_field32(&reg, E2PROM_CSR_DATA_OUT, !!eeprom->reg_data_out);\r\nrt2x00_set_field32(&reg, E2PROM_CSR_DATA_CLOCK,\r\n!!eeprom->reg_data_clock);\r\nrt2x00_set_field32(&reg, E2PROM_CSR_CHIP_SELECT,\r\n!!eeprom->reg_chip_select);\r\nrt2x00mmio_register_write(rt2x00dev, E2PROM_CSR, reg);\r\n}\r\nstatic int rt2800pci_read_eeprom_pci(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct eeprom_93cx6 eeprom;\r\nu32 reg;\r\nreg = rt2x00mmio_register_read(rt2x00dev, E2PROM_CSR);\r\neeprom.data = rt2x00dev;\r\neeprom.register_read = rt2800pci_eepromregister_read;\r\neeprom.register_write = rt2800pci_eepromregister_write;\r\nswitch (rt2x00_get_field32(reg, E2PROM_CSR_TYPE))\r\n{\r\ncase 0:\r\neeprom.width = PCI_EEPROM_WIDTH_93C46;\r\nbreak;\r\ncase 1:\r\neeprom.width = PCI_EEPROM_WIDTH_93C66;\r\nbreak;\r\ndefault:\r\neeprom.width = PCI_EEPROM_WIDTH_93C86;\r\nbreak;\r\n}\r\neeprom.reg_data_in = 0;\r\neeprom.reg_data_out = 0;\r\neeprom.reg_data_clock = 0;\r\neeprom.reg_chip_select = 0;\r\neeprom_93cx6_multiread(&eeprom, EEPROM_BASE, rt2x00dev->eeprom,\r\nEEPROM_SIZE / sizeof(u16));\r\nreturn 0;\r\n}\r\nstatic int rt2800pci_efuse_detect(struct rt2x00_dev *rt2x00dev)\r\n{\r\nreturn rt2800_efuse_detect(rt2x00dev);\r\n}\r\nstatic inline int rt2800pci_read_eeprom_efuse(struct rt2x00_dev *rt2x00dev)\r\n{\r\nreturn rt2800_read_eeprom_efuse(rt2x00dev);\r\n}\r\nstatic char *rt2800pci_get_firmware_name(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (rt2x00_rt(rt2x00dev, RT3290))\r\nreturn FIRMWARE_RT3290;\r\nelse\r\nreturn FIRMWARE_RT2860;\r\n}\r\nstatic int rt2800pci_write_firmware(struct rt2x00_dev *rt2x00dev,\r\nconst u8 *data, const size_t len)\r\n{\r\nu32 reg;\r\nreg = 0;\r\nrt2x00_set_field32(&reg, PBF_SYS_CTRL_HOST_RAM_WRITE, 1);\r\nrt2x00mmio_register_write(rt2x00dev, PBF_SYS_CTRL, reg);\r\nrt2x00mmio_register_multiwrite(rt2x00dev, FIRMWARE_IMAGE_BASE,\r\ndata, len);\r\nrt2x00mmio_register_write(rt2x00dev, PBF_SYS_CTRL, 0x00000);\r\nrt2x00mmio_register_write(rt2x00dev, PBF_SYS_CTRL, 0x00001);\r\nrt2x00mmio_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\r\nreturn 0;\r\n}\r\nstatic int rt2800pci_enable_radio(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint retval;\r\nretval = rt2800mmio_enable_radio(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_STATUS, ~0);\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_CID, ~0);\r\nrt2800_mcu_request(rt2x00dev, MCU_SLEEP, TOKEN_RADIO_OFF, 0xff, 0x02);\r\nrt2800pci_mcu_status(rt2x00dev, TOKEN_RADIO_OFF);\r\nrt2800_mcu_request(rt2x00dev, MCU_WAKEUP, TOKEN_WAKEUP, 0, 0);\r\nrt2800pci_mcu_status(rt2x00dev, TOKEN_WAKEUP);\r\nreturn retval;\r\n}\r\nstatic int rt2800pci_set_state(struct rt2x00_dev *rt2x00dev,\r\nenum dev_state state)\r\n{\r\nif (state == STATE_AWAKE) {\r\nrt2800_mcu_request(rt2x00dev, MCU_WAKEUP, TOKEN_WAKEUP,\r\n0, 0x02);\r\nrt2800pci_mcu_status(rt2x00dev, TOKEN_WAKEUP);\r\n} else if (state == STATE_SLEEP) {\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_STATUS,\r\n0xffffffff);\r\nrt2x00mmio_register_write(rt2x00dev, H2M_MAILBOX_CID,\r\n0xffffffff);\r\nrt2800_mcu_request(rt2x00dev, MCU_SLEEP, TOKEN_SLEEP,\r\n0xff, 0x01);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt2800pci_set_device_state(struct rt2x00_dev *rt2x00dev,\r\nenum dev_state state)\r\n{\r\nint retval = 0;\r\nswitch (state) {\r\ncase STATE_RADIO_ON:\r\nretval = rt2800pci_enable_radio(rt2x00dev);\r\nbreak;\r\ncase STATE_RADIO_OFF:\r\nrt2800pci_set_state(rt2x00dev, STATE_SLEEP);\r\nbreak;\r\ncase STATE_RADIO_IRQ_ON:\r\ncase STATE_RADIO_IRQ_OFF:\r\nrt2800mmio_toggle_irq(rt2x00dev, state);\r\nbreak;\r\ncase STATE_DEEP_SLEEP:\r\ncase STATE_SLEEP:\r\ncase STATE_STANDBY:\r\ncase STATE_AWAKE:\r\nretval = rt2800pci_set_state(rt2x00dev, state);\r\nbreak;\r\ndefault:\r\nretval = -ENOTSUPP;\r\nbreak;\r\n}\r\nif (unlikely(retval))\r\nrt2x00_err(rt2x00dev, "Device failed to enter state %d (%d)\n",\r\nstate, retval);\r\nreturn retval;\r\n}\r\nstatic int rt2800pci_read_eeprom(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint retval;\r\nif (rt2800pci_efuse_detect(rt2x00dev))\r\nretval = rt2800pci_read_eeprom_efuse(rt2x00dev);\r\nelse\r\nretval = rt2800pci_read_eeprom_pci(rt2x00dev);\r\nreturn retval;\r\n}\r\nstatic int rt2800pci_probe(struct pci_dev *pci_dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn rt2x00pci_probe(pci_dev, &rt2800pci_ops);\r\n}

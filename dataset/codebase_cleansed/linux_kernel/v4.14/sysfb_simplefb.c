__init bool parse_mode(const struct screen_info *si,\r\nstruct simplefb_platform_data *mode)\r\n{\r\nconst struct simplefb_format *f;\r\n__u8 type;\r\nunsigned int i;\r\ntype = si->orig_video_isVGA;\r\nif (type != VIDEO_TYPE_VLFB && type != VIDEO_TYPE_EFI)\r\nreturn false;\r\nfor (i = 0; i < ARRAY_SIZE(formats); ++i) {\r\nf = &formats[i];\r\nif (si->lfb_depth == f->bits_per_pixel &&\r\nsi->red_size == f->red.length &&\r\nsi->red_pos == f->red.offset &&\r\nsi->green_size == f->green.length &&\r\nsi->green_pos == f->green.offset &&\r\nsi->blue_size == f->blue.length &&\r\nsi->blue_pos == f->blue.offset &&\r\nsi->rsvd_size == f->transp.length &&\r\nsi->rsvd_pos == f->transp.offset) {\r\nmode->format = f->name;\r\nmode->width = si->lfb_width;\r\nmode->height = si->lfb_height;\r\nmode->stride = si->lfb_linelength;\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\n__init int create_simplefb(const struct screen_info *si,\r\nconst struct simplefb_platform_data *mode)\r\n{\r\nstruct platform_device *pd;\r\nstruct resource res;\r\nu64 base, size;\r\nu32 length;\r\nbase = si->lfb_base;\r\nif (si->capabilities & VIDEO_CAPABILITY_64BIT_BASE)\r\nbase |= (u64)si->ext_lfb_base << 32;\r\nif (!base || (u64)(resource_size_t)base != base) {\r\nprintk(KERN_DEBUG "sysfb: inaccessible VRAM base\n");\r\nreturn -EINVAL;\r\n}\r\nsize = si->lfb_size;\r\nif (si->orig_video_isVGA == VIDEO_TYPE_VLFB)\r\nsize <<= 16;\r\nlength = mode->height * mode->stride;\r\nlength = PAGE_ALIGN(length);\r\nif (length > size) {\r\nprintk(KERN_WARNING "sysfb: VRAM smaller than advertised\n");\r\nreturn -EINVAL;\r\n}\r\nmemset(&res, 0, sizeof(res));\r\nres.flags = IORESOURCE_MEM | IORESOURCE_BUSY;\r\nres.name = simplefb_resname;\r\nres.start = base;\r\nres.end = res.start + length - 1;\r\nif (res.end <= res.start)\r\nreturn -EINVAL;\r\npd = platform_device_register_resndata(NULL, "simple-framebuffer", 0,\r\n&res, 1, mode, sizeof(*mode));\r\nreturn PTR_ERR_OR_ZERO(pd);\r\n}

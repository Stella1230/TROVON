void dm_disk_bitset_init(struct dm_transaction_manager *tm,\r\nstruct dm_disk_bitset *info)\r\n{\r\ndm_array_info_init(&info->array_info, tm, &bitset_bvt);\r\ninfo->current_index_set = false;\r\n}\r\nint dm_bitset_empty(struct dm_disk_bitset *info, dm_block_t *root)\r\n{\r\nreturn dm_array_empty(&info->array_info, root);\r\n}\r\nstatic int pack_bits(uint32_t index, void *value, void *context)\r\n{\r\nint r;\r\nstruct packer_context *p = context;\r\nunsigned bit, nr = min(64u, p->nr_bits - (index * 64));\r\nuint64_t word = 0;\r\nbool bv;\r\nfor (bit = 0; bit < nr; bit++) {\r\nr = p->fn(index * 64 + bit, &bv, p->context);\r\nif (r)\r\nreturn r;\r\nif (bv)\r\nset_bit(bit, (unsigned long *) &word);\r\nelse\r\nclear_bit(bit, (unsigned long *) &word);\r\n}\r\n*((__le64 *) value) = cpu_to_le64(word);\r\nreturn 0;\r\n}\r\nint dm_bitset_new(struct dm_disk_bitset *info, dm_block_t *root,\r\nuint32_t size, bit_value_fn fn, void *context)\r\n{\r\nstruct packer_context p;\r\np.fn = fn;\r\np.nr_bits = size;\r\np.context = context;\r\nreturn dm_array_new(&info->array_info, root, dm_div_up(size, 64), pack_bits, &p);\r\n}\r\nint dm_bitset_resize(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t old_nr_entries, uint32_t new_nr_entries,\r\nbool default_value, dm_block_t *new_root)\r\n{\r\nuint32_t old_blocks = dm_div_up(old_nr_entries, BITS_PER_ARRAY_ENTRY);\r\nuint32_t new_blocks = dm_div_up(new_nr_entries, BITS_PER_ARRAY_ENTRY);\r\n__le64 value = default_value ? cpu_to_le64(~0) : cpu_to_le64(0);\r\n__dm_bless_for_disk(&value);\r\nreturn dm_array_resize(&info->array_info, root, old_blocks, new_blocks,\r\n&value, new_root);\r\n}\r\nint dm_bitset_del(struct dm_disk_bitset *info, dm_block_t root)\r\n{\r\nreturn dm_array_del(&info->array_info, root);\r\n}\r\nint dm_bitset_flush(struct dm_disk_bitset *info, dm_block_t root,\r\ndm_block_t *new_root)\r\n{\r\nint r;\r\n__le64 value;\r\nif (!info->current_index_set || !info->dirty)\r\nreturn 0;\r\nvalue = cpu_to_le64(info->current_bits);\r\n__dm_bless_for_disk(&value);\r\nr = dm_array_set_value(&info->array_info, root, info->current_index,\r\n&value, new_root);\r\nif (r)\r\nreturn r;\r\ninfo->current_index_set = false;\r\ninfo->dirty = false;\r\nreturn 0;\r\n}\r\nstatic int read_bits(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t array_index)\r\n{\r\nint r;\r\n__le64 value;\r\nr = dm_array_get_value(&info->array_info, root, array_index, &value);\r\nif (r)\r\nreturn r;\r\ninfo->current_bits = le64_to_cpu(value);\r\ninfo->current_index_set = true;\r\ninfo->current_index = array_index;\r\ninfo->dirty = false;\r\nreturn 0;\r\n}\r\nstatic int get_array_entry(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned array_index = index / BITS_PER_ARRAY_ENTRY;\r\nif (info->current_index_set) {\r\nif (info->current_index == array_index)\r\nreturn 0;\r\nr = dm_bitset_flush(info, root, new_root);\r\nif (r)\r\nreturn r;\r\n}\r\nreturn read_bits(info, root, array_index);\r\n}\r\nint dm_bitset_set_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\nset_bit(b, (unsigned long *) &info->current_bits);\r\ninfo->dirty = true;\r\nreturn 0;\r\n}\r\nint dm_bitset_clear_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\nclear_bit(b, (unsigned long *) &info->current_bits);\r\ninfo->dirty = true;\r\nreturn 0;\r\n}\r\nint dm_bitset_test_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root, bool *result)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\n*result = test_bit(b, (unsigned long *) &info->current_bits);\r\nreturn 0;\r\n}\r\nstatic int cursor_next_array_entry(struct dm_bitset_cursor *c)\r\n{\r\nint r;\r\n__le64 *value;\r\nr = dm_array_cursor_next(&c->cursor);\r\nif (r)\r\nreturn r;\r\ndm_array_cursor_get_value(&c->cursor, (void **) &value);\r\nc->array_index++;\r\nc->bit_index = 0;\r\nc->current_bits = le64_to_cpu(*value);\r\nreturn 0;\r\n}\r\nint dm_bitset_cursor_begin(struct dm_disk_bitset *info,\r\ndm_block_t root, uint32_t nr_entries,\r\nstruct dm_bitset_cursor *c)\r\n{\r\nint r;\r\n__le64 *value;\r\nif (!nr_entries)\r\nreturn -ENODATA;\r\nc->info = info;\r\nc->entries_remaining = nr_entries;\r\nr = dm_array_cursor_begin(&info->array_info, root, &c->cursor);\r\nif (r)\r\nreturn r;\r\ndm_array_cursor_get_value(&c->cursor, (void **) &value);\r\nc->array_index = 0;\r\nc->bit_index = 0;\r\nc->current_bits = le64_to_cpu(*value);\r\nreturn r;\r\n}\r\nvoid dm_bitset_cursor_end(struct dm_bitset_cursor *c)\r\n{\r\nreturn dm_array_cursor_end(&c->cursor);\r\n}\r\nint dm_bitset_cursor_next(struct dm_bitset_cursor *c)\r\n{\r\nint r = 0;\r\nif (!c->entries_remaining)\r\nreturn -ENODATA;\r\nc->entries_remaining--;\r\nif (++c->bit_index > 63)\r\nr = cursor_next_array_entry(c);\r\nreturn r;\r\n}\r\nint dm_bitset_cursor_skip(struct dm_bitset_cursor *c, uint32_t count)\r\n{\r\nint r;\r\n__le64 *value;\r\nuint32_t nr_array_skip;\r\nuint32_t remaining_in_word = 64 - c->bit_index;\r\nif (c->entries_remaining < count)\r\nreturn -ENODATA;\r\nif (count < remaining_in_word) {\r\nc->bit_index += count;\r\nc->entries_remaining -= count;\r\nreturn 0;\r\n} else {\r\nc->entries_remaining -= remaining_in_word;\r\ncount -= remaining_in_word;\r\n}\r\nnr_array_skip = (count / 64) + 1;\r\nr = dm_array_cursor_skip(&c->cursor, nr_array_skip);\r\nif (r)\r\nreturn r;\r\ndm_array_cursor_get_value(&c->cursor, (void **) &value);\r\nc->entries_remaining -= count;\r\nc->array_index += nr_array_skip;\r\nc->bit_index = count & 63;\r\nc->current_bits = le64_to_cpu(*value);\r\nreturn 0;\r\n}\r\nbool dm_bitset_cursor_get_value(struct dm_bitset_cursor *c)\r\n{\r\nreturn test_bit(c->bit_index, (unsigned long *) &c->current_bits);\r\n}

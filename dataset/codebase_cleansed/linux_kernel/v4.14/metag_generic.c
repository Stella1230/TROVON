static int metag_timer_set_next_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\n__core_reg_set(TXTIMERI, -delta);\r\nreturn 0;\r\n}\r\nstatic u64 metag_clocksource_read(struct clocksource *cs)\r\n{\r\nreturn __core_reg_get(TXTIMER);\r\n}\r\nstatic irqreturn_t metag_timer_interrupt(int irq, void *dummy)\r\n{\r\nstruct clock_event_device *evt = this_cpu_ptr(&local_clockevent);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nunsigned long long sched_clock(void)\r\n{\r\nunsigned long long ticks = __core_reg_get(TXTIMER);\r\nreturn ticks << HARDWARE_TO_NS_SHIFT;\r\n}\r\nstatic int arch_timer_starting_cpu(unsigned int cpu)\r\n{\r\nunsigned int txdivtime;\r\nstruct clock_event_device *clk = &per_cpu(local_clockevent, cpu);\r\nchar *name = per_cpu(local_clockevent_name, cpu);\r\ntxdivtime = __core_reg_get(TXDIVTIME);\r\ntxdivtime &= ~TXDIVTIME_DIV_BITS;\r\ntxdivtime |= (HARDWARE_DIV & TXDIVTIME_DIV_BITS);\r\n__core_reg_set(TXDIVTIME, txdivtime);\r\nsprintf(name, "META %d", cpu);\r\nclk->name = name;\r\nclk->features = CLOCK_EVT_FEAT_ONESHOT,\r\nclk->rating = 200,\r\nclk->shift = 12,\r\nclk->irq = tbisig_map(TBID_SIGNUM_TRT),\r\nclk->set_next_event = metag_timer_set_next_event,\r\nclk->mult = div_sc(hwtimer_freq, NSEC_PER_SEC, clk->shift);\r\nclk->max_delta_ns = clockevent_delta2ns(0x7fffffff, clk);\r\nclk->max_delta_ticks = 0x7fffffff;\r\nclk->min_delta_ns = clockevent_delta2ns(0xf, clk);\r\nclk->min_delta_ticks = 0xf;\r\nclk->cpumask = cpumask_of(cpu);\r\nclockevents_register_device(clk);\r\nif (cpu) {\r\nunsigned int thread0 = cpu_2_hwthread_id[0];\r\nunsigned long val;\r\nval = core_reg_read(TXUCT_ID, TXTIMER_REGNUM, thread0);\r\n__core_reg_set(TXTIMER, val);\r\n}\r\nreturn 0;\r\n}\r\nint __init metag_generic_timer_init(void)\r\n{\r\n#ifdef CONFIG_METAG_META21\r\nhwtimer_freq = get_coreclock() / (metag_in32(EXPAND_TIMER_DIV) + 1);\r\n#endif\r\npr_info("Timer frequency: %u Hz\n", hwtimer_freq);\r\nclocksource_register_hz(&clocksource_metag, hwtimer_freq);\r\nsetup_irq(tbisig_map(TBID_SIGNUM_TRT), &metag_timer_irq);\r\nreturn cpuhp_setup_state(CPUHP_AP_METAG_TIMER_STARTING,\r\n"clockevents/metag:starting",\r\narch_timer_starting_cpu, NULL);\r\n}

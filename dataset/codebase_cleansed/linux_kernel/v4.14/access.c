unsigned long intc_phys_to_virt(struct intc_desc_int *d, unsigned long address)\r\n{\r\nstruct intc_window *window;\r\nint k;\r\nfor (k = 0; k < d->nr_windows; k++) {\r\nwindow = d->window + k;\r\nif (address < window->phys)\r\ncontinue;\r\nif (address >= (window->phys + window->size))\r\ncontinue;\r\naddress -= window->phys;\r\naddress += (unsigned long)window->virt;\r\nreturn address;\r\n}\r\nreturn address;\r\n}\r\nunsigned int intc_get_reg(struct intc_desc_int *d, unsigned long address)\r\n{\r\nunsigned int k;\r\naddress = intc_phys_to_virt(d, address);\r\nfor (k = 0; k < d->nr_reg; k++) {\r\nif (d->reg[k] == address)\r\nreturn k;\r\n}\r\nBUG();\r\nreturn 0;\r\n}\r\nunsigned int intc_set_field_from_handle(unsigned int value,\r\nunsigned int field_value,\r\nunsigned int handle)\r\n{\r\nunsigned int width = _INTC_WIDTH(handle);\r\nunsigned int shift = _INTC_SHIFT(handle);\r\nvalue &= ~(((1 << width) - 1) << shift);\r\nvalue |= field_value << shift;\r\nreturn value;\r\n}\r\nunsigned long intc_get_field_from_handle(unsigned int value, unsigned int handle)\r\n{\r\nunsigned int width = _INTC_WIDTH(handle);\r\nunsigned int shift = _INTC_SHIFT(handle);\r\nunsigned int mask = ((1 << width) - 1) << shift;\r\nreturn (value & mask) >> shift;\r\n}\r\nstatic unsigned long test_8(unsigned long addr, unsigned long h,\r\nunsigned long ignore)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nreturn intc_get_field_from_handle(__raw_readb(ptr), h);\r\n}\r\nstatic unsigned long test_16(unsigned long addr, unsigned long h,\r\nunsigned long ignore)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nreturn intc_get_field_from_handle(__raw_readw(ptr), h);\r\n}\r\nstatic unsigned long test_32(unsigned long addr, unsigned long h,\r\nunsigned long ignore)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nreturn intc_get_field_from_handle(__raw_readl(ptr), h);\r\n}\r\nstatic unsigned long write_8(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\n__raw_writeb(intc_set_field_from_handle(0, data, h), ptr);\r\n(void)__raw_readb(ptr);\r\nreturn 0;\r\n}\r\nstatic unsigned long write_16(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\n__raw_writew(intc_set_field_from_handle(0, data, h), ptr);\r\n(void)__raw_readw(ptr);\r\nreturn 0;\r\n}\r\nstatic unsigned long write_32(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\n__raw_writel(intc_set_field_from_handle(0, data, h), ptr);\r\n(void)__raw_readl(ptr);\r\nreturn 0;\r\n}\r\nstatic unsigned long modify_8(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nunsigned long flags;\r\nunsigned int value;\r\nlocal_irq_save(flags);\r\nvalue = intc_set_field_from_handle(__raw_readb(ptr), data, h);\r\n__raw_writeb(value, ptr);\r\n(void)__raw_readb(ptr);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic unsigned long modify_16(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nunsigned long flags;\r\nunsigned int value;\r\nlocal_irq_save(flags);\r\nvalue = intc_set_field_from_handle(__raw_readw(ptr), data, h);\r\n__raw_writew(value, ptr);\r\n(void)__raw_readw(ptr);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic unsigned long modify_32(unsigned long addr, unsigned long h,\r\nunsigned long data)\r\n{\r\nvoid __iomem *ptr = (void __iomem *)addr;\r\nunsigned long flags;\r\nunsigned int value;\r\nlocal_irq_save(flags);\r\nvalue = intc_set_field_from_handle(__raw_readl(ptr), data, h);\r\n__raw_writel(value, ptr);\r\n(void)__raw_readl(ptr);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}

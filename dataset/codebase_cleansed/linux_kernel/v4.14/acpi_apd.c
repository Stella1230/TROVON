static int acpi_apd_setup(struct apd_private_data *pdata)\r\n{\r\nconst struct apd_device_desc *dev_desc = pdata->dev_desc;\r\nstruct clk *clk = ERR_PTR(-ENODEV);\r\nif (dev_desc->fixed_clk_rate) {\r\nclk = clk_register_fixed_rate(&pdata->adev->dev,\r\ndev_name(&pdata->adev->dev),\r\nNULL, 0, dev_desc->fixed_clk_rate);\r\nclk_register_clkdev(clk, NULL, dev_name(&pdata->adev->dev));\r\npdata->clk = clk;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_apd_create_device(struct acpi_device *adev,\r\nconst struct acpi_device_id *id)\r\n{\r\nconst struct apd_device_desc *dev_desc = (void *)id->driver_data;\r\nstruct apd_private_data *pdata;\r\nstruct platform_device *pdev;\r\nint ret;\r\nif (!dev_desc) {\r\npdev = acpi_create_platform_device(adev, NULL);\r\nreturn IS_ERR_OR_NULL(pdev) ? PTR_ERR(pdev) : 1;\r\n}\r\npdata = kzalloc(sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\npdata->adev = adev;\r\npdata->dev_desc = dev_desc;\r\nif (dev_desc->setup) {\r\nret = dev_desc->setup(pdata);\r\nif (ret)\r\ngoto err_out;\r\n}\r\nadev->driver_data = pdata;\r\npdev = acpi_create_platform_device(adev, dev_desc->properties);\r\nif (!IS_ERR_OR_NULL(pdev))\r\nreturn 1;\r\nret = PTR_ERR(pdev);\r\nadev->driver_data = NULL;\r\nerr_out:\r\nkfree(pdata);\r\nreturn ret;\r\n}\r\nvoid __init acpi_apd_init(void)\r\n{\r\nacpi_scan_add_handler(&apd_handler);\r\n}

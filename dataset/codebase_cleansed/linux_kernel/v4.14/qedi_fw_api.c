static bool scsi_is_slow_sgl(u16 num_sges, bool small_mid_sge)\r\n{\r\nreturn (num_sges > SCSI_NUM_SGES_SLOW_SGL_THR && small_mid_sge);\r\n}\r\nstatic\r\nvoid init_scsi_sgl_context(struct scsi_sgl_params *ctx_sgl_params,\r\nstruct scsi_cached_sges *ctx_data_desc,\r\nstruct scsi_sgl_task_params *sgl_task_params)\r\n{\r\nu8 sge_index;\r\nu8 num_sges;\r\nu32 val;\r\nnum_sges = (sgl_task_params->num_sges > SCSI_NUM_SGES_IN_CACHE) ?\r\nSCSI_NUM_SGES_IN_CACHE : sgl_task_params->num_sges;\r\nval = cpu_to_le32(sgl_task_params->sgl_phys_addr.lo);\r\nctx_sgl_params->sgl_addr.lo = val;\r\nval = cpu_to_le32(sgl_task_params->sgl_phys_addr.hi);\r\nctx_sgl_params->sgl_addr.hi = val;\r\nval = cpu_to_le32(sgl_task_params->total_buffer_size);\r\nctx_sgl_params->sgl_total_length = val;\r\nctx_sgl_params->sgl_num_sges = cpu_to_le16(sgl_task_params->num_sges);\r\nfor (sge_index = 0; sge_index < num_sges; sge_index++) {\r\nval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_addr.lo);\r\nctx_data_desc->sge[sge_index].sge_addr.lo = val;\r\nval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_addr.hi);\r\nctx_data_desc->sge[sge_index].sge_addr.hi = val;\r\nval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_len);\r\nctx_data_desc->sge[sge_index].sge_len = val;\r\n}\r\n}\r\nstatic u32 calc_rw_task_size(struct iscsi_task_params *task_params,\r\nenum iscsi_task_type task_type,\r\nstruct scsi_sgl_task_params *sgl_task_params,\r\nstruct scsi_dif_task_params *dif_task_params)\r\n{\r\nu32 io_size;\r\nif (task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE ||\r\ntask_type == ISCSI_TASK_TYPE_TARGET_READ)\r\nio_size = task_params->tx_io_size;\r\nelse\r\nio_size = task_params->rx_io_size;\r\nif (!io_size)\r\nreturn 0;\r\nif (!dif_task_params)\r\nreturn io_size;\r\nreturn !dif_task_params->dif_on_network ?\r\nio_size : sgl_task_params->total_buffer_size;\r\n}\r\nstatic void\r\ninit_dif_context_flags(struct iscsi_dif_flags *ctx_dif_flags,\r\nstruct scsi_dif_task_params *dif_task_params)\r\n{\r\nif (!dif_task_params)\r\nreturn;\r\nSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_PROT_INTERVAL_SIZE_LOG,\r\ndif_task_params->dif_block_size_log);\r\nSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_DIF_TO_PEER,\r\ndif_task_params->dif_on_network ? 1 : 0);\r\nSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_HOST_INTERFACE,\r\ndif_task_params->dif_on_host ? 1 : 0);\r\n}\r\nstatic void init_sqe(struct iscsi_task_params *task_params,\r\nstruct scsi_sgl_task_params *sgl_task_params,\r\nstruct scsi_dif_task_params *dif_task_params,\r\nstruct iscsi_common_hdr *pdu_header,\r\nstruct scsi_initiator_cmd_params *cmd_params,\r\nenum iscsi_task_type task_type,\r\nbool is_cleanup)\r\n{\r\nif (!task_params->sqe)\r\nreturn;\r\nmemset(task_params->sqe, 0, sizeof(*task_params->sqe));\r\ntask_params->sqe->task_id = cpu_to_le16(task_params->itid);\r\nif (is_cleanup) {\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\r\nISCSI_WQE_TYPE_TASK_CLEANUP);\r\nreturn;\r\n}\r\nswitch (task_type) {\r\ncase ISCSI_TASK_TYPE_INITIATOR_WRITE:\r\n{\r\nu32 buf_size = 0;\r\nu32 num_sges = 0;\r\ninit_dif_context_flags(&task_params->sqe->prot_flags,\r\ndif_task_params);\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\r\nISCSI_WQE_TYPE_NORMAL);\r\nif (task_params->tx_io_size) {\r\nbuf_size = calc_rw_task_size(task_params, task_type,\r\nsgl_task_params,\r\ndif_task_params);\r\nif (scsi_is_slow_sgl(sgl_task_params->num_sges,\r\nsgl_task_params->small_mid_sge))\r\nnum_sges = ISCSI_WQE_NUM_SGES_SLOWIO;\r\nelse\r\nnum_sges = min(sgl_task_params->num_sges,\r\n(u16)SCSI_NUM_SGES_SLOW_SGL_THR);\r\n}\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES, num_sges);\r\nSET_FIELD(task_params->sqe->contlen_cdbsize, ISCSI_WQE_CONT_LEN,\r\nbuf_size);\r\nif (GET_FIELD(pdu_header->hdr_second_dword,\r\nISCSI_CMD_HDR_TOTAL_AHS_LEN))\r\nSET_FIELD(task_params->sqe->contlen_cdbsize, ISCSI_WQE_CDB_SIZE,\r\ncmd_params->extended_cdb_sge.sge_len);\r\n}\r\nbreak;\r\ncase ISCSI_TASK_TYPE_INITIATOR_READ:\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\r\nISCSI_WQE_TYPE_NORMAL);\r\nif (GET_FIELD(pdu_header->hdr_second_dword,\r\nISCSI_CMD_HDR_TOTAL_AHS_LEN))\r\nSET_FIELD(task_params->sqe->contlen_cdbsize,\r\nISCSI_WQE_CDB_SIZE,\r\ncmd_params->extended_cdb_sge.sge_len);\r\nbreak;\r\ncase ISCSI_TASK_TYPE_LOGIN_RESPONSE:\r\ncase ISCSI_TASK_TYPE_MIDPATH:\r\n{\r\nbool advance_statsn = true;\r\nif (task_type == ISCSI_TASK_TYPE_LOGIN_RESPONSE)\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\r\nISCSI_WQE_TYPE_LOGIN);\r\nelse\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\r\nISCSI_WQE_TYPE_MIDDLE_PATH);\r\nif (task_type == ISCSI_TASK_TYPE_MIDPATH) {\r\nu8 opcode = GET_FIELD(pdu_header->hdr_first_byte,\r\nISCSI_COMMON_HDR_OPCODE);\r\nif (opcode != ISCSI_OPCODE_TEXT_RESPONSE &&\r\n(opcode != ISCSI_OPCODE_NOP_IN ||\r\npdu_header->itt == ISCSI_TTT_ALL_ONES))\r\nadvance_statsn = false;\r\n}\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_RESPONSE,\r\nadvance_statsn ? 1 : 0);\r\nif (task_params->tx_io_size) {\r\nSET_FIELD(task_params->sqe->contlen_cdbsize,\r\nISCSI_WQE_CONT_LEN, task_params->tx_io_size);\r\nif (scsi_is_slow_sgl(sgl_task_params->num_sges,\r\nsgl_task_params->small_mid_sge))\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES,\r\nISCSI_WQE_NUM_SGES_SLOWIO);\r\nelse\r\nSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES,\r\nmin(sgl_task_params->num_sges,\r\n(u16)SCSI_NUM_SGES_SLOW_SGL_THR));\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void init_default_iscsi_task(struct iscsi_task_params *task_params,\r\nstruct data_hdr *pdu_header,\r\nenum iscsi_task_type task_type)\r\n{\r\nstruct iscsi_task_context *context;\r\nu16 index;\r\nu32 val;\r\ncontext = task_params->context;\r\nmemset(context, 0, sizeof(*context));\r\nfor (index = 0; index <\r\nARRAY_SIZE(context->ystorm_st_context.pdu_hdr.data.data);\r\nindex++) {\r\nval = cpu_to_le32(pdu_header->data[index]);\r\ncontext->ystorm_st_context.pdu_hdr.data.data[index] = val;\r\n}\r\ncontext->mstorm_st_context.task_type = task_type;\r\ncontext->mstorm_ag_context.task_cid =\r\ncpu_to_le16(task_params->conn_icid);\r\nSET_FIELD(context->ustorm_ag_context.flags1,\r\nUSTORM_ISCSI_TASK_AG_CTX_R2T2RECV, 1);\r\ncontext->ustorm_st_context.task_type = task_type;\r\ncontext->ustorm_st_context.cq_rss_number = task_params->cq_rss_number;\r\ncontext->ustorm_ag_context.icid = cpu_to_le16(task_params->conn_icid);\r\n}\r\nstatic\r\nvoid init_initiator_rw_cdb_ystorm_context(struct ystorm_iscsi_task_st_ctx *ystc,\r\nstruct scsi_initiator_cmd_params *cmd)\r\n{\r\nunion iscsi_task_hdr *ctx_pdu_hdr = &ystc->pdu_hdr;\r\nu32 val;\r\nif (!cmd->extended_cdb_sge.sge_len)\r\nreturn;\r\nSET_FIELD(ctx_pdu_hdr->ext_cdb_cmd.hdr_second_dword,\r\nISCSI_EXT_CDB_CMD_HDR_CDB_SIZE,\r\ncmd->extended_cdb_sge.sge_len);\r\nval = cpu_to_le32(cmd->extended_cdb_sge.sge_addr.lo);\r\nctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_addr.lo = val;\r\nval = cpu_to_le32(cmd->extended_cdb_sge.sge_addr.hi);\r\nctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_addr.hi = val;\r\nval = cpu_to_le32(cmd->extended_cdb_sge.sge_len);\r\nctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_len = val;\r\n}\r\nstatic\r\nvoid init_ustorm_task_contexts(struct ustorm_iscsi_task_st_ctx *ustorm_st_cxt,\r\nstruct ustorm_iscsi_task_ag_ctx *ustorm_ag_cxt,\r\nu32 remaining_recv_len,\r\nu32 expected_data_transfer_len,\r\nu8 num_sges, bool tx_dif_conn_err_en)\r\n{\r\nu32 val;\r\nustorm_st_cxt->rem_rcv_len = cpu_to_le32(remaining_recv_len);\r\nustorm_ag_cxt->exp_data_acked = cpu_to_le32(expected_data_transfer_len);\r\nval = cpu_to_le32(expected_data_transfer_len);\r\nustorm_st_cxt->exp_data_transfer_len = val;\r\nSET_FIELD(ustorm_st_cxt->reg1.reg1_map, ISCSI_REG1_NUM_SGES, num_sges);\r\nSET_FIELD(ustorm_ag_cxt->flags2,\r\nUSTORM_ISCSI_TASK_AG_CTX_DIF_ERROR_CF_EN,\r\ntx_dif_conn_err_en ? 1 : 0);\r\n}\r\nstatic\r\nvoid set_rw_exp_data_acked_and_cont_len(struct iscsi_task_context *context,\r\nstruct iscsi_conn_params *conn_params,\r\nenum iscsi_task_type task_type,\r\nu32 task_size,\r\nu32 exp_data_transfer_len,\r\nu8 total_ahs_length)\r\n{\r\nu32 max_unsolicited_data = 0, val;\r\nif (total_ahs_length &&\r\n(task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE ||\r\ntask_type == ISCSI_TASK_TYPE_INITIATOR_READ))\r\nSET_FIELD(context->ustorm_st_context.flags2,\r\nUSTORM_ISCSI_TASK_ST_CTX_AHS_EXIST, 1);\r\nswitch (task_type) {\r\ncase ISCSI_TASK_TYPE_INITIATOR_WRITE:\r\nif (!conn_params->initial_r2t)\r\nmax_unsolicited_data = conn_params->first_burst_length;\r\nelse if (conn_params->immediate_data)\r\nmax_unsolicited_data =\r\nmin(conn_params->first_burst_length,\r\nconn_params->max_send_pdu_length);\r\ncontext->ustorm_ag_context.exp_data_acked =\r\ncpu_to_le32(total_ahs_length == 0 ?\r\nmin(exp_data_transfer_len,\r\nmax_unsolicited_data) :\r\n((u32)(total_ahs_length +\r\nISCSI_AHS_CNTL_SIZE)));\r\nbreak;\r\ncase ISCSI_TASK_TYPE_TARGET_READ:\r\nval = cpu_to_le32(exp_data_transfer_len);\r\ncontext->ustorm_ag_context.exp_data_acked = val;\r\nbreak;\r\ncase ISCSI_TASK_TYPE_INITIATOR_READ:\r\ncontext->ustorm_ag_context.exp_data_acked =\r\ncpu_to_le32((total_ahs_length == 0 ? 0 :\r\ntotal_ahs_length +\r\nISCSI_AHS_CNTL_SIZE));\r\nbreak;\r\ncase ISCSI_TASK_TYPE_TARGET_WRITE:\r\nval = cpu_to_le32(task_size);\r\ncontext->ustorm_ag_context.exp_cont_len = val;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic\r\nvoid init_rtdif_task_context(struct rdif_task_context *rdif_context,\r\nstruct tdif_task_context *tdif_context,\r\nstruct scsi_dif_task_params *dif_task_params,\r\nenum iscsi_task_type task_type)\r\n{\r\nu32 val;\r\nif (!dif_task_params->dif_on_network || !dif_task_params->dif_on_host)\r\nreturn;\r\nif (task_type == ISCSI_TASK_TYPE_TARGET_WRITE ||\r\ntask_type == ISCSI_TASK_TYPE_INITIATOR_READ) {\r\nrdif_context->app_tag_value =\r\ncpu_to_le16(dif_task_params->application_tag);\r\nrdif_context->partial_crc_value = cpu_to_le16(0xffff);\r\nval = cpu_to_le32(dif_task_params->initial_ref_tag);\r\nrdif_context->initial_ref_tag = val;\r\nrdif_context->app_tag_mask =\r\ncpu_to_le16(dif_task_params->application_tag_mask);\r\nSET_FIELD(rdif_context->flags0, RDIF_TASK_CONTEXT_CRC_SEED,\r\ndif_task_params->crc_seed ? 1 : 0);\r\nSET_FIELD(rdif_context->flags0, RDIF_TASK_CONTEXT_HOSTGUARDTYPE,\r\ndif_task_params->host_guard_type);\r\nSET_FIELD(rdif_context->flags0,\r\nRDIF_TASK_CONTEXT_PROTECTIONTYPE,\r\ndif_task_params->protection_type);\r\nSET_FIELD(rdif_context->flags0,\r\nRDIF_TASK_CONTEXT_INITIALREFTAGVALID, 1);\r\nSET_FIELD(rdif_context->flags0,\r\nRDIF_TASK_CONTEXT_KEEPREFTAGCONST,\r\ndif_task_params->keep_ref_tag_const ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_VALIDATEAPPTAG,\r\n(dif_task_params->validate_app_tag &&\r\ndif_task_params->dif_on_network) ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_VALIDATEGUARD,\r\n(dif_task_params->validate_guard &&\r\ndif_task_params->dif_on_network) ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_VALIDATEREFTAG,\r\n(dif_task_params->validate_ref_tag &&\r\ndif_task_params->dif_on_network) ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_HOSTINTERFACE,\r\ndif_task_params->dif_on_host ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_NETWORKINTERFACE,\r\ndif_task_params->dif_on_network ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_FORWARDGUARD,\r\ndif_task_params->forward_guard ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_FORWARDAPPTAG,\r\ndif_task_params->forward_app_tag ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_FORWARDREFTAG,\r\ndif_task_params->forward_ref_tag ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_FORWARDAPPTAGWITHMASK,\r\ndif_task_params->forward_app_tag_with_mask ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_FORWARDREFTAGWITHMASK,\r\ndif_task_params->forward_ref_tag_with_mask ? 1 : 0);\r\nSET_FIELD(rdif_context->flags1,\r\nRDIF_TASK_CONTEXT_INTERVALSIZE,\r\ndif_task_params->dif_block_size_log - 9);\r\nSET_FIELD(rdif_context->state,\r\nRDIF_TASK_CONTEXT_REFTAGMASK,\r\ndif_task_params->ref_tag_mask);\r\nSET_FIELD(rdif_context->state, RDIF_TASK_CONTEXT_IGNOREAPPTAG,\r\ndif_task_params->ignore_app_tag);\r\n}\r\nif (task_type == ISCSI_TASK_TYPE_TARGET_READ ||\r\ntask_type == ISCSI_TASK_TYPE_INITIATOR_WRITE) {\r\ntdif_context->app_tag_value =\r\ncpu_to_le16(dif_task_params->application_tag);\r\ntdif_context->partial_crc_valueB =\r\ncpu_to_le16(dif_task_params->crc_seed ? 0xffff : 0x0000);\r\ntdif_context->partial_crc_value_a =\r\ncpu_to_le16(dif_task_params->crc_seed ? 0xffff : 0x0000);\r\nSET_FIELD(tdif_context->flags0, TDIF_TASK_CONTEXT_CRC_SEED,\r\ndif_task_params->crc_seed ? 1 : 0);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_SETERRORWITHEOP,\r\ndif_task_params->tx_dif_conn_err_en ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_FORWARDGUARD,\r\ndif_task_params->forward_guard ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_FORWARDAPPTAG,\r\ndif_task_params->forward_app_tag ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_FORWARDREFTAG,\r\ndif_task_params->forward_ref_tag ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_INTERVALSIZE,\r\ndif_task_params->dif_block_size_log - 9);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_HOSTINTERFACE,\r\ndif_task_params->dif_on_host ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_NETWORKINTERFACE,\r\ndif_task_params->dif_on_network ? 1 : 0);\r\nval = cpu_to_le32(dif_task_params->initial_ref_tag);\r\ntdif_context->initial_ref_tag = val;\r\ntdif_context->app_tag_mask =\r\ncpu_to_le16(dif_task_params->application_tag_mask);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_HOSTGUARDTYPE,\r\ndif_task_params->host_guard_type);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_PROTECTIONTYPE,\r\ndif_task_params->protection_type);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_INITIALREFTAGVALID,\r\ndif_task_params->initial_ref_tag_is_valid ? 1 : 0);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_KEEPREFTAGCONST,\r\ndif_task_params->keep_ref_tag_const ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_VALIDATEGUARD,\r\n(dif_task_params->validate_guard &&\r\ndif_task_params->dif_on_host) ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_VALIDATEAPPTAG,\r\n(dif_task_params->validate_app_tag &&\r\ndif_task_params->dif_on_host) ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_VALIDATEREFTAG,\r\n(dif_task_params->validate_ref_tag &&\r\ndif_task_params->dif_on_host) ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_FORWARDAPPTAGWITHMASK,\r\ndif_task_params->forward_app_tag_with_mask ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_FORWARDREFTAGWITHMASK,\r\ndif_task_params->forward_ref_tag_with_mask ? 1 : 0);\r\nSET_FIELD(tdif_context->flags1,\r\nTDIF_TASK_CONTEXT_REFTAGMASK,\r\ndif_task_params->ref_tag_mask);\r\nSET_FIELD(tdif_context->flags0,\r\nTDIF_TASK_CONTEXT_IGNOREAPPTAG,\r\ndif_task_params->ignore_app_tag ? 1 : 0);\r\n}\r\n}\r\nstatic void set_local_completion_context(struct iscsi_task_context *context)\r\n{\r\nSET_FIELD(context->ystorm_st_context.state.flags,\r\nYSTORM_ISCSI_TASK_STATE_LOCAL_COMP, 1);\r\nSET_FIELD(context->ustorm_st_context.flags,\r\nUSTORM_ISCSI_TASK_ST_CTX_LOCAL_COMP, 1);\r\n}\r\nstatic int init_rw_iscsi_task(struct iscsi_task_params *task_params,\r\nenum iscsi_task_type task_type,\r\nstruct iscsi_conn_params *conn_params,\r\nstruct iscsi_common_hdr *pdu_header,\r\nstruct scsi_sgl_task_params *sgl_task_params,\r\nstruct scsi_initiator_cmd_params *cmd_params,\r\nstruct scsi_dif_task_params *dif_task_params)\r\n{\r\nu32 exp_data_transfer_len = conn_params->max_burst_length;\r\nstruct iscsi_task_context *cxt;\r\nbool slow_io = false;\r\nu32 task_size, val;\r\nu8 num_sges = 0;\r\ntask_size = calc_rw_task_size(task_params, task_type, sgl_task_params,\r\ndif_task_params);\r\ninit_default_iscsi_task(task_params, (struct data_hdr *)pdu_header,\r\ntask_type);\r\ncxt = task_params->context;\r\nval = cpu_to_le32(task_size);\r\ncxt->ystorm_st_context.pdu_hdr.cmd.expected_transfer_length = val;\r\ninit_initiator_rw_cdb_ystorm_context(&cxt->ystorm_st_context,\r\ncmd_params);\r\nval = cpu_to_le32(cmd_params->sense_data_buffer_phys_addr.lo);\r\ncxt->mstorm_st_context.sense_db.lo = val;\r\nval = cpu_to_le32(cmd_params->sense_data_buffer_phys_addr.hi);\r\ncxt->mstorm_st_context.sense_db.hi = val;\r\nif (task_params->tx_io_size) {\r\ninit_dif_context_flags(&cxt->ystorm_st_context.state.dif_flags,\r\ndif_task_params);\r\ninit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\r\n&cxt->ystorm_st_context.state.data_desc,\r\nsgl_task_params);\r\nslow_io = scsi_is_slow_sgl(sgl_task_params->num_sges,\r\nsgl_task_params->small_mid_sge);\r\nnum_sges = !slow_io ? min_t(u16, sgl_task_params->num_sges,\r\n(u16)SCSI_NUM_SGES_SLOW_SGL_THR) :\r\nISCSI_WQE_NUM_SGES_SLOWIO;\r\nif (slow_io) {\r\nSET_FIELD(cxt->ystorm_st_context.state.flags,\r\nYSTORM_ISCSI_TASK_STATE_SLOW_IO, 1);\r\n}\r\n} else if (task_params->rx_io_size) {\r\ninit_dif_context_flags(&cxt->mstorm_st_context.dif_flags,\r\ndif_task_params);\r\ninit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\r\n&cxt->mstorm_st_context.data_desc,\r\nsgl_task_params);\r\nnum_sges = !scsi_is_slow_sgl(sgl_task_params->num_sges,\r\nsgl_task_params->small_mid_sge) ?\r\nmin_t(u16, sgl_task_params->num_sges,\r\n(u16)SCSI_NUM_SGES_SLOW_SGL_THR) :\r\nISCSI_WQE_NUM_SGES_SLOWIO;\r\ncxt->mstorm_st_context.rem_task_size = cpu_to_le32(task_size);\r\n}\r\nif (exp_data_transfer_len > task_size ||\r\ntask_type != ISCSI_TASK_TYPE_TARGET_WRITE)\r\nexp_data_transfer_len = task_size;\r\ninit_ustorm_task_contexts(&task_params->context->ustorm_st_context,\r\n&task_params->context->ustorm_ag_context,\r\ntask_size, exp_data_transfer_len, num_sges,\r\ndif_task_params ?\r\ndif_task_params->tx_dif_conn_err_en : false);\r\nset_rw_exp_data_acked_and_cont_len(task_params->context, conn_params,\r\ntask_type, task_size,\r\nexp_data_transfer_len,\r\nGET_FIELD(pdu_header->hdr_second_dword,\r\nISCSI_CMD_HDR_TOTAL_AHS_LEN));\r\nif (dif_task_params)\r\ninit_rtdif_task_context(&task_params->context->rdif_context,\r\n&task_params->context->tdif_context,\r\ndif_task_params, task_type);\r\ninit_sqe(task_params, sgl_task_params, dif_task_params, pdu_header,\r\ncmd_params, task_type, false);\r\nreturn 0;\r\n}\r\nint init_initiator_rw_iscsi_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_conn_params *conn_params,\r\nstruct scsi_initiator_cmd_params *cmd_params,\r\nstruct iscsi_cmd_hdr *cmd_header,\r\nstruct scsi_sgl_task_params *tx_sgl_params,\r\nstruct scsi_sgl_task_params *rx_sgl_params,\r\nstruct scsi_dif_task_params *dif_task_params)\r\n{\r\nif (GET_FIELD(cmd_header->flags_attr, ISCSI_CMD_HDR_WRITE))\r\nreturn init_rw_iscsi_task(task_params,\r\nISCSI_TASK_TYPE_INITIATOR_WRITE,\r\nconn_params,\r\n(struct iscsi_common_hdr *)cmd_header,\r\ntx_sgl_params, cmd_params,\r\ndif_task_params);\r\nelse if (GET_FIELD(cmd_header->flags_attr, ISCSI_CMD_HDR_READ) ||\r\n(task_params->rx_io_size == 0 && task_params->tx_io_size == 0))\r\nreturn init_rw_iscsi_task(task_params,\r\nISCSI_TASK_TYPE_INITIATOR_READ,\r\nconn_params,\r\n(struct iscsi_common_hdr *)cmd_header,\r\nrx_sgl_params, cmd_params,\r\ndif_task_params);\r\nelse\r\nreturn -1;\r\n}\r\nint init_initiator_login_request_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_login_req_hdr *login_header,\r\nstruct scsi_sgl_task_params *tx_params,\r\nstruct scsi_sgl_task_params *rx_params)\r\n{\r\nstruct iscsi_task_context *cxt;\r\ncxt = task_params->context;\r\ninit_default_iscsi_task(task_params,\r\n(struct data_hdr *)login_header,\r\nISCSI_TASK_TYPE_MIDPATH);\r\ninit_ustorm_task_contexts(&cxt->ustorm_st_context,\r\n&cxt->ustorm_ag_context,\r\ntask_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0,\r\ntask_params->tx_io_size ?\r\ntx_params->total_buffer_size : 0, 0,\r\n0);\r\nif (task_params->tx_io_size)\r\ninit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\r\n&cxt->ystorm_st_context.state.data_desc,\r\ntx_params);\r\nif (task_params->rx_io_size)\r\ninit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\r\n&cxt->mstorm_st_context.data_desc,\r\nrx_params);\r\ncxt->mstorm_st_context.rem_task_size =\r\ncpu_to_le32(task_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0);\r\ninit_sqe(task_params, tx_params, NULL,\r\n(struct iscsi_common_hdr *)login_header, NULL,\r\nISCSI_TASK_TYPE_MIDPATH, false);\r\nreturn 0;\r\n}\r\nint init_initiator_nop_out_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_nop_out_hdr *nop_out_pdu_header,\r\nstruct scsi_sgl_task_params *tx_sgl_task_params,\r\nstruct scsi_sgl_task_params *rx_sgl_task_params)\r\n{\r\nstruct iscsi_task_context *cxt;\r\ncxt = task_params->context;\r\ninit_default_iscsi_task(task_params,\r\n(struct data_hdr *)nop_out_pdu_header,\r\nISCSI_TASK_TYPE_MIDPATH);\r\nif (nop_out_pdu_header->itt == ISCSI_ITT_ALL_ONES)\r\nset_local_completion_context(task_params->context);\r\nif (task_params->tx_io_size)\r\ninit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\r\n&cxt->ystorm_st_context.state.data_desc,\r\ntx_sgl_task_params);\r\nif (task_params->rx_io_size)\r\ninit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\r\n&cxt->mstorm_st_context.data_desc,\r\nrx_sgl_task_params);\r\ninit_ustorm_task_contexts(&cxt->ustorm_st_context,\r\n&cxt->ustorm_ag_context,\r\ntask_params->rx_io_size ?\r\nrx_sgl_task_params->total_buffer_size : 0,\r\ntask_params->tx_io_size ?\r\ntx_sgl_task_params->total_buffer_size : 0,\r\n0, 0);\r\ncxt->mstorm_st_context.rem_task_size =\r\ncpu_to_le32(task_params->rx_io_size ?\r\nrx_sgl_task_params->total_buffer_size :\r\n0);\r\ninit_sqe(task_params, tx_sgl_task_params, NULL,\r\n(struct iscsi_common_hdr *)nop_out_pdu_header, NULL,\r\nISCSI_TASK_TYPE_MIDPATH, false);\r\nreturn 0;\r\n}\r\nint init_initiator_logout_request_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_logout_req_hdr *logout_hdr,\r\nstruct scsi_sgl_task_params *tx_params,\r\nstruct scsi_sgl_task_params *rx_params)\r\n{\r\nstruct iscsi_task_context *cxt;\r\ncxt = task_params->context;\r\ninit_default_iscsi_task(task_params,\r\n(struct data_hdr *)logout_hdr,\r\nISCSI_TASK_TYPE_MIDPATH);\r\nif (task_params->tx_io_size)\r\ninit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\r\n&cxt->ystorm_st_context.state.data_desc,\r\ntx_params);\r\nif (task_params->rx_io_size)\r\ninit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\r\n&cxt->mstorm_st_context.data_desc,\r\nrx_params);\r\ninit_ustorm_task_contexts(&cxt->ustorm_st_context,\r\n&cxt->ustorm_ag_context,\r\ntask_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0,\r\ntask_params->tx_io_size ?\r\ntx_params->total_buffer_size : 0,\r\n0, 0);\r\ncxt->mstorm_st_context.rem_task_size =\r\ncpu_to_le32(task_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0);\r\ninit_sqe(task_params, tx_params, NULL,\r\n(struct iscsi_common_hdr *)logout_hdr, NULL,\r\nISCSI_TASK_TYPE_MIDPATH, false);\r\nreturn 0;\r\n}\r\nint init_initiator_tmf_request_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_tmf_request_hdr *tmf_header)\r\n{\r\ninit_default_iscsi_task(task_params, (struct data_hdr *)tmf_header,\r\nISCSI_TASK_TYPE_MIDPATH);\r\ninit_sqe(task_params, NULL, NULL,\r\n(struct iscsi_common_hdr *)tmf_header, NULL,\r\nISCSI_TASK_TYPE_MIDPATH, false);\r\nreturn 0;\r\n}\r\nint init_initiator_text_request_task(struct iscsi_task_params *task_params,\r\nstruct iscsi_text_request_hdr *text_header,\r\nstruct scsi_sgl_task_params *tx_params,\r\nstruct scsi_sgl_task_params *rx_params)\r\n{\r\nstruct iscsi_task_context *cxt;\r\ncxt = task_params->context;\r\ninit_default_iscsi_task(task_params,\r\n(struct data_hdr *)text_header,\r\nISCSI_TASK_TYPE_MIDPATH);\r\nif (task_params->tx_io_size)\r\ninit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\r\n&cxt->ystorm_st_context.state.data_desc,\r\ntx_params);\r\nif (task_params->rx_io_size)\r\ninit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\r\n&cxt->mstorm_st_context.data_desc,\r\nrx_params);\r\ncxt->mstorm_st_context.rem_task_size =\r\ncpu_to_le32(task_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0);\r\ninit_ustorm_task_contexts(&cxt->ustorm_st_context,\r\n&cxt->ustorm_ag_context,\r\ntask_params->rx_io_size ?\r\nrx_params->total_buffer_size : 0,\r\ntask_params->tx_io_size ?\r\ntx_params->total_buffer_size : 0, 0, 0);\r\ninit_sqe(task_params, tx_params, NULL,\r\n(struct iscsi_common_hdr *)text_header, NULL,\r\nISCSI_TASK_TYPE_MIDPATH, false);\r\nreturn 0;\r\n}\r\nint init_cleanup_task(struct iscsi_task_params *task_params)\r\n{\r\ninit_sqe(task_params, NULL, NULL, NULL, NULL, ISCSI_TASK_TYPE_MIDPATH,\r\ntrue);\r\nreturn 0;\r\n}

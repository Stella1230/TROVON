static int rx6110_rtc_tm_to_data(struct rtc_time *tm, u8 *data)\r\n{\r\npr_debug("%s: date %ds %dm %dh %dmd %dm %dy\n", __func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year);\r\nif (tm->tm_year < 100 || tm->tm_year >= 200)\r\nreturn -EINVAL;\r\ndata[RTC_SEC] = bin2bcd(tm->tm_sec);\r\ndata[RTC_MIN] = bin2bcd(tm->tm_min);\r\ndata[RTC_HOUR] = bin2bcd(tm->tm_hour);\r\ndata[RTC_WDAY] = BIT(bin2bcd(tm->tm_wday));\r\ndata[RTC_MDAY] = bin2bcd(tm->tm_mday);\r\ndata[RTC_MONTH] = bin2bcd(tm->tm_mon + 1);\r\ndata[RTC_YEAR] = bin2bcd(tm->tm_year % 100);\r\nreturn 0;\r\n}\r\nstatic int rx6110_data_to_rtc_tm(u8 *data, struct rtc_time *tm)\r\n{\r\ntm->tm_sec = bcd2bin(data[RTC_SEC] & 0x7f);\r\ntm->tm_min = bcd2bin(data[RTC_MIN] & 0x7f);\r\ntm->tm_hour = bcd2bin(data[RTC_HOUR] & 0x3f);\r\ntm->tm_wday = ffs(data[RTC_WDAY] & 0x7f);\r\ntm->tm_mday = bcd2bin(data[RTC_MDAY] & 0x3f);\r\ntm->tm_mon = bcd2bin(data[RTC_MONTH] & 0x1f) - 1;\r\ntm->tm_year = bcd2bin(data[RTC_YEAR]) + 100;\r\npr_debug("%s: date %ds %dm %dh %dmd %dm %dy\n", __func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year);\r\nif (tm->tm_year < 100 || tm->tm_year >= 200)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int rx6110_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rx6110_data *rx6110 = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nret = rx6110_rtc_tm_to_data(tm, data);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(rx6110->regmap, RX6110_REG_CTRL,\r\nRX6110_BIT_CTRL_STOP, RX6110_BIT_CTRL_STOP);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_bulk_write(rx6110->regmap, RX6110_REG_SEC, data,\r\nRTC_NR_TIME);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_update_bits(rx6110->regmap, RX6110_REG_FLAG,\r\nRX6110_BIT_FLAG_VLF, 0);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_update_bits(rx6110->regmap, RX6110_REG_CTRL,\r\nRX6110_BIT_CTRL_STOP, 0);\r\nreturn ret;\r\n}\r\nstatic int rx6110_get_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rx6110_data *rx6110 = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint flags;\r\nint ret;\r\nret = regmap_read(rx6110->regmap, RX6110_REG_FLAG, &flags);\r\nif (ret)\r\nreturn -EINVAL;\r\nif ((flags & RX6110_BIT_FLAG_VLF)) {\r\ndev_warn(dev, "Voltage low, data is invalid.\n");\r\nreturn -EINVAL;\r\n}\r\nret = regmap_bulk_read(rx6110->regmap, RX6110_REG_SEC, data,\r\nRTC_NR_TIME);\r\nif (ret)\r\nreturn ret;\r\nret = rx6110_data_to_rtc_tm(data, tm);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(dev, "%s: date %ds %dm %dh %dmd %dm %dy\n", __func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int rx6110_init(struct rx6110_data *rx6110)\r\n{\r\nstruct rtc_device *rtc = rx6110->rtc;\r\nint flags;\r\nint ret;\r\nret = regmap_update_bits(rx6110->regmap, RX6110_REG_EXT,\r\nRX6110_BIT_EXT_TE, 0);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_register_patch(rx6110->regmap, rx6110_default_regs,\r\nARRAY_SIZE(rx6110_default_regs));\r\nif (ret)\r\nreturn ret;\r\nret = regmap_read(rx6110->regmap, RX6110_REG_FLAG, &flags);\r\nif (ret)\r\nreturn ret;\r\nif ((flags & RX6110_BIT_FLAG_VLF))\r\ndev_warn(&rtc->dev, "Voltage low, data loss detected.\n");\r\nif (flags & RX6110_BIT_FLAG_AF)\r\ndev_warn(&rtc->dev, "An alarm may have been missed.\n");\r\nif (flags & RX6110_BIT_FLAG_TF)\r\ndev_warn(&rtc->dev, "Periodic timer was detected\n");\r\nif (flags & RX6110_BIT_FLAG_UF)\r\ndev_warn(&rtc->dev, "Update timer was detected\n");\r\nret = regmap_update_bits(rx6110->regmap, RX6110_REG_FLAG,\r\nRX6110_BIT_FLAG_AF |\r\nRX6110_BIT_FLAG_UF |\r\nRX6110_BIT_FLAG_TF,\r\n0);\r\nreturn ret;\r\n}\r\nstatic int rx6110_probe(struct spi_device *spi)\r\n{\r\nstruct rx6110_data *rx6110;\r\nint err;\r\nif ((spi->bits_per_word && spi->bits_per_word != 8) ||\r\n(spi->max_speed_hz > 2000000) ||\r\n(spi->mode != (SPI_CS_HIGH | SPI_CPOL | SPI_CPHA))) {\r\ndev_warn(&spi->dev, "SPI settings: bits_per_word: %d, max_speed_hz: %d, mode: %xh\n",\r\nspi->bits_per_word, spi->max_speed_hz, spi->mode);\r\ndev_warn(&spi->dev, "driving device in an unsupported mode");\r\n}\r\nrx6110 = devm_kzalloc(&spi->dev, sizeof(*rx6110), GFP_KERNEL);\r\nif (!rx6110)\r\nreturn -ENOMEM;\r\nrx6110->regmap = devm_regmap_init_spi(spi, &regmap_spi_config);\r\nif (IS_ERR(rx6110->regmap)) {\r\ndev_err(&spi->dev, "regmap init failed for rtc rx6110\n");\r\nreturn PTR_ERR(rx6110->regmap);\r\n}\r\nspi_set_drvdata(spi, rx6110);\r\nrx6110->rtc = devm_rtc_device_register(&spi->dev,\r\nRX6110_DRIVER_NAME,\r\n&rx6110_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rx6110->rtc))\r\nreturn PTR_ERR(rx6110->rtc);\r\nerr = rx6110_init(rx6110);\r\nif (err)\r\nreturn err;\r\nrx6110->rtc->max_user_freq = 1;\r\nreturn 0;\r\n}\r\nstatic int rx6110_remove(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}

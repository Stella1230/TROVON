static unsigned int\r\nebt_mark_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ebt_mark_t_info *info = par->targinfo;\r\nint action = info->target & -16;\r\nif (action == MARK_SET_VALUE)\r\nskb->mark = info->mark;\r\nelse if (action == MARK_OR_VALUE)\r\nskb->mark |= info->mark;\r\nelse if (action == MARK_AND_VALUE)\r\nskb->mark &= info->mark;\r\nelse\r\nskb->mark ^= info->mark;\r\nreturn info->target | ~EBT_VERDICT_BITS;\r\n}\r\nstatic int ebt_mark_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ebt_mark_t_info *info = par->targinfo;\r\nint tmp;\r\ntmp = info->target | ~EBT_VERDICT_BITS;\r\nif (BASE_CHAIN && tmp == EBT_RETURN)\r\nreturn -EINVAL;\r\nif (ebt_invalid_target(tmp))\r\nreturn -EINVAL;\r\ntmp = info->target & ~EBT_VERDICT_BITS;\r\nif (tmp != MARK_SET_VALUE && tmp != MARK_OR_VALUE &&\r\ntmp != MARK_AND_VALUE && tmp != MARK_XOR_VALUE)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic void mark_tg_compat_from_user(void *dst, const void *src)\r\n{\r\nconst struct compat_ebt_mark_t_info *user = src;\r\nstruct ebt_mark_t_info *kern = dst;\r\nkern->mark = user->mark;\r\nkern->target = user->target;\r\n}\r\nstatic int mark_tg_compat_to_user(void __user *dst, const void *src)\r\n{\r\nstruct compat_ebt_mark_t_info __user *user = dst;\r\nconst struct ebt_mark_t_info *kern = src;\r\nif (put_user(kern->mark, &user->mark) ||\r\nput_user(kern->target, &user->target))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_mark_init(void)\r\n{\r\nreturn xt_register_target(&ebt_mark_tg_reg);\r\n}\r\nstatic void __exit ebt_mark_fini(void)\r\n{\r\nxt_unregister_target(&ebt_mark_tg_reg);\r\n}

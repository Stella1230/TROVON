int\r\nsnic_get_vnic_config(struct snic *snic)\r\n{\r\nstruct vnic_snic_config *c = &snic->config;\r\nint ret;\r\n#define GET_CONFIG(m) \\r\ndo { \\r\nret = svnic_dev_spec(snic->vdev, \\r\noffsetof(struct vnic_snic_config, m), \\r\nsizeof(c->m), \\r\n&c->m); \\r\nif (ret) { \\r\nSNIC_HOST_ERR(snic->shost, \\r\n"Error getting %s, %d\n", #m, ret); \\r\nreturn ret; \\r\n} \\r\n} while (0)\r\nGET_CONFIG(wq_enet_desc_count);\r\nGET_CONFIG(maxdatafieldsize);\r\nGET_CONFIG(intr_timer);\r\nGET_CONFIG(intr_timer_type);\r\nGET_CONFIG(flags);\r\nGET_CONFIG(io_throttle_count);\r\nGET_CONFIG(port_down_timeout);\r\nGET_CONFIG(port_down_io_retries);\r\nGET_CONFIG(luns_per_tgt);\r\nGET_CONFIG(xpt_type);\r\nGET_CONFIG(hid);\r\nc->wq_enet_desc_count = min_t(u32,\r\nVNIC_SNIC_WQ_DESCS_MAX,\r\nmax_t(u32,\r\nVNIC_SNIC_WQ_DESCS_MIN,\r\nc->wq_enet_desc_count));\r\nc->wq_enet_desc_count = ALIGN(c->wq_enet_desc_count, 16);\r\nc->maxdatafieldsize = min_t(u32,\r\nVNIC_SNIC_MAXDATAFIELDSIZE_MAX,\r\nmax_t(u32,\r\nVNIC_SNIC_MAXDATAFIELDSIZE_MIN,\r\nc->maxdatafieldsize));\r\nc->io_throttle_count = min_t(u32,\r\nVNIC_SNIC_IO_THROTTLE_COUNT_MAX,\r\nmax_t(u32,\r\nVNIC_SNIC_IO_THROTTLE_COUNT_MIN,\r\nc->io_throttle_count));\r\nc->port_down_timeout = min_t(u32,\r\nVNIC_SNIC_PORT_DOWN_TIMEOUT_MAX,\r\nc->port_down_timeout);\r\nc->port_down_io_retries = min_t(u32,\r\nVNIC_SNIC_PORT_DOWN_IO_RETRIES_MAX,\r\nc->port_down_io_retries);\r\nc->luns_per_tgt = min_t(u32,\r\nVNIC_SNIC_LUNS_PER_TARGET_MAX,\r\nmax_t(u32,\r\nVNIC_SNIC_LUNS_PER_TARGET_MIN,\r\nc->luns_per_tgt));\r\nc->intr_timer = min_t(u32, VNIC_INTR_TIMER_MAX, c->intr_timer);\r\nSNIC_INFO("vNIC resources wq %d\n", c->wq_enet_desc_count);\r\nSNIC_INFO("vNIC mtu %d intr timer %d\n",\r\nc->maxdatafieldsize,\r\nc->intr_timer);\r\nSNIC_INFO("vNIC flags 0x%x luns per tgt %d\n",\r\nc->flags,\r\nc->luns_per_tgt);\r\nSNIC_INFO("vNIC io throttle count %d\n", c->io_throttle_count);\r\nSNIC_INFO("vNIC port down timeout %d port down io retries %d\n",\r\nc->port_down_timeout,\r\nc->port_down_io_retries);\r\nSNIC_INFO("vNIC back end type = %d\n", c->xpt_type);\r\nSNIC_INFO("vNIC hid = %d\n", c->hid);\r\nreturn 0;\r\n}\r\nvoid\r\nsnic_get_res_counts(struct snic *snic)\r\n{\r\nsnic->wq_count = svnic_dev_get_res_count(snic->vdev, RES_TYPE_WQ);\r\nSNIC_BUG_ON(snic->wq_count == 0);\r\nsnic->cq_count = svnic_dev_get_res_count(snic->vdev, RES_TYPE_CQ);\r\nSNIC_BUG_ON(snic->cq_count == 0);\r\nsnic->intr_count = svnic_dev_get_res_count(snic->vdev,\r\nRES_TYPE_INTR_CTRL);\r\nSNIC_BUG_ON(snic->intr_count == 0);\r\n}\r\nvoid\r\nsnic_free_vnic_res(struct snic *snic)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < snic->wq_count; i++)\r\nsvnic_wq_free(&snic->wq[i]);\r\nfor (i = 0; i < snic->cq_count; i++)\r\nsvnic_cq_free(&snic->cq[i]);\r\nfor (i = 0; i < snic->intr_count; i++)\r\nsvnic_intr_free(&snic->intr[i]);\r\n}\r\nint\r\nsnic_alloc_vnic_res(struct snic *snic)\r\n{\r\nenum vnic_dev_intr_mode intr_mode;\r\nunsigned int mask_on_assertion;\r\nunsigned int intr_offset;\r\nunsigned int err_intr_enable;\r\nunsigned int err_intr_offset;\r\nunsigned int i;\r\nint ret;\r\nintr_mode = svnic_dev_get_intr_mode(snic->vdev);\r\nSNIC_INFO("vNIC interrupt mode: %s\n",\r\n((intr_mode == VNIC_DEV_INTR_MODE_INTX) ?\r\n"Legacy PCI INTx" :\r\n((intr_mode == VNIC_DEV_INTR_MODE_MSI) ?\r\n"MSI" :\r\n((intr_mode == VNIC_DEV_INTR_MODE_MSIX) ?\r\n"MSI-X" : "Unknown"))));\r\nSNIC_BUG_ON(intr_mode != VNIC_DEV_INTR_MODE_MSIX);\r\nSNIC_INFO("wq %d cq %d intr %d\n", snic->wq_count,\r\nsnic->cq_count,\r\nsnic->intr_count);\r\nfor (i = 0; i < snic->wq_count; i++) {\r\nret = svnic_wq_alloc(snic->vdev,\r\n&snic->wq[i],\r\ni,\r\nsnic->config.wq_enet_desc_count,\r\nsizeof(struct wq_enet_desc));\r\nif (ret)\r\ngoto error_cleanup;\r\n}\r\nfor (i = 0; i < snic->wq_count; i++) {\r\nret = svnic_cq_alloc(snic->vdev,\r\n&snic->cq[i],\r\ni,\r\nsnic->config.wq_enet_desc_count,\r\nsizeof(struct cq_enet_wq_desc));\r\nif (ret)\r\ngoto error_cleanup;\r\n}\r\nSNIC_BUG_ON(snic->cq_count != 2 * snic->wq_count);\r\nfor (i = snic->wq_count; i < snic->cq_count; i++) {\r\nret = svnic_cq_alloc(snic->vdev,\r\n&snic->cq[i],\r\ni,\r\n(snic->config.wq_enet_desc_count * 3),\r\nsizeof(struct snic_fw_req));\r\nif (ret)\r\ngoto error_cleanup;\r\n}\r\nfor (i = 0; i < snic->intr_count; i++) {\r\nret = svnic_intr_alloc(snic->vdev, &snic->intr[i], i);\r\nif (ret)\r\ngoto error_cleanup;\r\n}\r\nerr_intr_enable = 1;\r\nerr_intr_offset = snic->err_intr_offset;\r\nfor (i = 0; i < snic->wq_count; i++) {\r\nsvnic_wq_init(&snic->wq[i],\r\ni,\r\nerr_intr_enable,\r\nerr_intr_offset);\r\n}\r\nfor (i = 0; i < snic->cq_count; i++) {\r\nintr_offset = i;\r\nsvnic_cq_init(&snic->cq[i],\r\n0 ,\r\n1 ,\r\n0 ,\r\n0 ,\r\n1 ,\r\n1 ,\r\n1 ,\r\n0 ,\r\nintr_offset,\r\n0 );\r\n}\r\nSNIC_BUG_ON(intr_mode != VNIC_DEV_INTR_MODE_MSIX);\r\nmask_on_assertion = 1;\r\nfor (i = 0; i < snic->intr_count; i++) {\r\nsvnic_intr_init(&snic->intr[i],\r\nsnic->config.intr_timer,\r\nsnic->config.intr_timer_type,\r\nmask_on_assertion);\r\n}\r\nret = svnic_dev_stats_dump(snic->vdev, &snic->stats);\r\nif (ret) {\r\nSNIC_HOST_ERR(snic->shost,\r\n"svnic_dev_stats_dump failed - x%x\n",\r\nret);\r\ngoto error_cleanup;\r\n}\r\nsvnic_dev_stats_clear(snic->vdev);\r\nret = 0;\r\nreturn ret;\r\nerror_cleanup:\r\nsnic_free_vnic_res(snic);\r\nreturn ret;\r\n}\r\nvoid\r\nsnic_log_q_error(struct snic *snic)\r\n{\r\nunsigned int i;\r\nu32 err_status;\r\nfor (i = 0; i < snic->wq_count; i++) {\r\nerr_status = ioread32(&snic->wq[i].ctrl->error_status);\r\nif (err_status)\r\nSNIC_HOST_ERR(snic->shost,\r\n"WQ[%d] error status %d\n",\r\ni,\r\nerr_status);\r\n}\r\n}

static void dm_CheckStatistics(struct adapter *Adapter)\r\n{\r\n}\r\nstatic void Init_ODM_ComInfo_8723b(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nPDM_ODM_T pDM_Odm = &(pHalData->odmpriv);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nu8 cut_ver, fab_ver;\r\nmemset(pDM_Odm, 0, sizeof(*pDM_Odm));\r\npDM_Odm->Adapter = Adapter;\r\n#define ODM_CE 0x04\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PLATFORM, ODM_CE);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_INTERFACE, RTW_SDIO);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PACKAGE_TYPE, pHalData->PackageType);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_IC_TYPE, ODM_RTL8723B);\r\nfab_ver = ODM_TSMC;\r\ncut_ver = ODM_CUT_A;\r\nDBG_871X("%s(): fab_ver =%d cut_ver =%d\n", __func__, fab_ver, cut_ver);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_FAB_VER, fab_ver);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_CUT_VER, cut_ver);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_MP_TEST_CHIP, IS_NORMAL_CHIP(pHalData->VersionID));\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PATCH_ID, pHalData->CustomerID);\r\nODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_BWIFI_TEST, Adapter->registrypriv.wifi_spec);\r\nif (pHalData->rf_type == RF_1T1R) {\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_1T1R);\r\n} else if (pHalData->rf_type == RF_2T2R) {\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_2T2R);\r\n} else if (pHalData->rf_type == RF_1T2R) {\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_1T2R);\r\n}\r\npdmpriv->InitODMFlag = ODM_RF_CALIBRATION|ODM_RF_TX_PWR_TRACK;\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\r\n}\r\nstatic void Update_ODM_ComInfo_8723b(struct adapter *Adapter)\r\n{\r\nstruct mlme_ext_priv *pmlmeext = &Adapter->mlmeextpriv;\r\nstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\r\nstruct dvobj_priv *dvobj = adapter_to_dvobj(Adapter);\r\nstruct pwrctrl_priv *pwrctrlpriv = adapter_to_pwrctl(Adapter);\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nPDM_ODM_T pDM_Odm = &(pHalData->odmpriv);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nint i;\r\nu8 zero = 0;\r\npdmpriv->InitODMFlag = 0\r\n| ODM_BB_DIG\r\n| ODM_BB_RA_MASK\r\n| ODM_BB_DYNAMIC_TXPWR\r\n| ODM_BB_FA_CNT\r\n| ODM_BB_RSSI_MONITOR\r\n| ODM_BB_CCK_PD\r\n| ODM_BB_PWR_SAVE\r\n| ODM_BB_CFO_TRACKING\r\n| ODM_MAC_EDCA_TURBO\r\n| ODM_RF_TX_PWR_TRACK\r\n| ODM_RF_CALIBRATION\r\n#ifdef CONFIG_ODM_ADAPTIVITY\r\n| ODM_BB_ADAPTIVITY\r\n#endif\r\n;\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_TX_UNI, &(dvobj->traffic_stat.tx_bytes));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_RX_UNI, &(dvobj->traffic_stat.rx_bytes));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_WM_MODE, &(pmlmeext->cur_wireless_mode));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SEC_CHNL_OFFSET, &(pHalData->nCur40MhzPrimeSC));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SEC_MODE, &(Adapter->securitypriv.dot11PrivacyAlgrthm));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_BW, &(pHalData->CurrentChannelBW));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_CHNL, &(pHalData->CurrentChannel));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_NET_CLOSED, &(Adapter->net_closed));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_MP_MODE, &zero);\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_BAND, &(pHalData->CurrentBandType));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_FORCED_IGI_LB, &(pHalData->u1ForcedIgiLb));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_FORCED_RATE, &(pHalData->ForcedDataRate));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SCAN, &(pmlmepriv->bScanInProcess));\r\nODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_POWER_SAVING, &(pwrctrlpriv->bpower_saving));\r\nfor (i = 0; i < NUM_STA; i++)\r\nODM_CmnInfoPtrArrayHook(pDM_Odm, ODM_CMNINFO_STA_STATUS, i, NULL);\r\n}\r\nvoid rtl8723b_InitHalDm(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nPDM_ODM_T pDM_Odm = &(pHalData->odmpriv);\r\npdmpriv->DM_Type = DM_Type_ByDriver;\r\npdmpriv->DMFlag = DYNAMIC_FUNC_DISABLE;\r\npdmpriv->DMFlag |= DYNAMIC_FUNC_BT;\r\npdmpriv->InitDMFlag = pdmpriv->DMFlag;\r\nUpdate_ODM_ComInfo_8723b(Adapter);\r\nODM_DMInit(pDM_Odm);\r\n}\r\nvoid rtl8723b_HalDmWatchDog(struct adapter *Adapter)\r\n{\r\nbool bFwCurrentInPSMode = false;\r\nbool bFwPSAwake = true;\r\nu8 hw_init_completed = false;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nhw_init_completed = Adapter->hw_init_completed;\r\nif (hw_init_completed == false)\r\ngoto skip_dm;\r\nbFwCurrentInPSMode = adapter_to_pwrctl(Adapter)->bFwCurrentInPSMode;\r\nrtw_hal_get_hwreg(Adapter, HW_VAR_FWLPS_RF_ON, (u8 *)(&bFwPSAwake));\r\nif (\r\n(hw_init_completed == true) &&\r\n((!bFwCurrentInPSMode) && bFwPSAwake)\r\n) {\r\ndm_CheckStatistics(Adapter);\r\nrtw_hal_check_rxfifo_full(Adapter);\r\n}\r\nif (hw_init_completed == true) {\r\nu8 bLinked = false;\r\nu8 bsta_state = false;\r\nu8 bBtDisabled = true;\r\nif (rtw_linked_check(Adapter)) {\r\nbLinked = true;\r\nif (check_fwstate(&Adapter->mlmepriv, WIFI_STATION_STATE))\r\nbsta_state = true;\r\n}\r\nODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_LINK, bLinked);\r\nODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_STATION_STATE, bsta_state);\r\nbBtDisabled = rtw_btcoex_IsBtDisabled(Adapter);\r\nODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_BT_ENABLED, ((bBtDisabled == true)?false:true));\r\nODM_DMWatchdog(&pHalData->odmpriv);\r\n}\r\nskip_dm:\r\nreturn;\r\n}\r\nvoid rtl8723b_hal_dm_in_lps(struct adapter *padapter)\r\n{\r\nu32 PWDB_rssi = 0;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nstruct sta_priv *pstapriv = &padapter->stapriv;\r\nstruct sta_info *psta = NULL;\r\nDBG_871X("%s, RSSI_Min =%d\n", __func__, pDM_Odm->RSSI_Min);\r\nODM_Write_DIG(pDM_Odm, pDM_Odm->RSSI_Min);\r\npsta = rtw_get_stainfo(pstapriv, get_bssid(pmlmepriv));\r\nif (psta && (psta->rssi_stat.UndecoratedSmoothedPWDB > 0)) {\r\nPWDB_rssi = (psta->mac_id | (psta->rssi_stat.UndecoratedSmoothedPWDB<<16));\r\nrtl8723b_set_rssi_cmd(padapter, (u8 *)&PWDB_rssi);\r\n}\r\n}\r\nvoid rtl8723b_HalDmWatchDog_in_LPS(struct adapter *Adapter)\r\n{\r\nu8 bLinked = false;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nstruct sta_priv *pstapriv = &Adapter->stapriv;\r\nstruct sta_info *psta = NULL;\r\nif (Adapter->hw_init_completed == false)\r\ngoto skip_lps_dm;\r\nif (rtw_linked_check(Adapter))\r\nbLinked = true;\r\nODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_LINK, bLinked);\r\nif (bLinked == false)\r\ngoto skip_lps_dm;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_RSSI_MONITOR))\r\ngoto skip_lps_dm;\r\npsta = rtw_get_stainfo(pstapriv, get_bssid(pmlmepriv));\r\nif (psta == NULL)\r\ngoto skip_lps_dm;\r\npdmpriv->EntryMinUndecoratedSmoothedPWDB = psta->rssi_stat.UndecoratedSmoothedPWDB;\r\nDBG_871X("CurIGValue =%d, EntryMinUndecoratedSmoothedPWDB = %d\n", pDM_DigTable->CurIGValue, pdmpriv->EntryMinUndecoratedSmoothedPWDB);\r\nif (pdmpriv->EntryMinUndecoratedSmoothedPWDB <= 0)\r\ngoto skip_lps_dm;\r\npdmpriv->MinUndecoratedPWDBForDM = pdmpriv->EntryMinUndecoratedSmoothedPWDB;\r\npDM_Odm->RSSI_Min = pdmpriv->MinUndecoratedPWDBForDM;\r\nif (\r\n(pDM_DigTable->CurIGValue > pDM_Odm->RSSI_Min + 5) ||\r\n(pDM_DigTable->CurIGValue < pDM_Odm->RSSI_Min - 5)\r\n)\r\nrtw_dm_in_lps_wk_cmd(Adapter);\r\nskip_lps_dm:\r\nreturn;\r\n}\r\nvoid rtl8723b_init_dm_priv(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nmemset(pdmpriv, 0, sizeof(struct dm_priv));\r\nInit_ODM_ComInfo_8723b(Adapter);\r\n}

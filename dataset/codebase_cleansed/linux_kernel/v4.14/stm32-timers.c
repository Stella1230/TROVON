static void stm32_timers_get_arr_size(struct stm32_timers *ddata)\r\n{\r\nregmap_write(ddata->regmap, TIM_ARR, ~0L);\r\nregmap_read(ddata->regmap, TIM_ARR, &ddata->max_arr);\r\nregmap_write(ddata->regmap, TIM_ARR, 0x0);\r\n}\r\nstatic int stm32_timers_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct stm32_timers *ddata;\r\nstruct resource *res;\r\nvoid __iomem *mmio;\r\nddata = devm_kzalloc(dev, sizeof(*ddata), GFP_KERNEL);\r\nif (!ddata)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmmio = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(mmio))\r\nreturn PTR_ERR(mmio);\r\nddata->regmap = devm_regmap_init_mmio_clk(dev, "int", mmio,\r\n&stm32_timers_regmap_cfg);\r\nif (IS_ERR(ddata->regmap))\r\nreturn PTR_ERR(ddata->regmap);\r\nddata->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(ddata->clk))\r\nreturn PTR_ERR(ddata->clk);\r\nstm32_timers_get_arr_size(ddata);\r\nplatform_set_drvdata(pdev, ddata);\r\nreturn devm_of_platform_populate(&pdev->dev);\r\n}

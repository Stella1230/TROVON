static __be16 t10_pi_crc_fn(void *data, unsigned int len)\r\n{\r\nreturn cpu_to_be16(crc_t10dif(data, len));\r\n}\r\nstatic __be16 t10_pi_ip_fn(void *data, unsigned int len)\r\n{\r\nreturn (__force __be16)ip_compute_csum(data, len);\r\n}\r\nstatic blk_status_t t10_pi_generate(struct blk_integrity_iter *iter,\r\ncsum_fn *fn, unsigned int type)\r\n{\r\nunsigned int i;\r\nfor (i = 0 ; i < iter->data_size ; i += iter->interval) {\r\nstruct t10_pi_tuple *pi = iter->prot_buf;\r\npi->guard_tag = fn(iter->data_buf, iter->interval);\r\npi->app_tag = 0;\r\nif (type == 1)\r\npi->ref_tag = cpu_to_be32(lower_32_bits(iter->seed));\r\nelse\r\npi->ref_tag = 0;\r\niter->data_buf += iter->interval;\r\niter->prot_buf += sizeof(struct t10_pi_tuple);\r\niter->seed++;\r\n}\r\nreturn BLK_STS_OK;\r\n}\r\nstatic blk_status_t t10_pi_verify(struct blk_integrity_iter *iter,\r\ncsum_fn *fn, unsigned int type)\r\n{\r\nunsigned int i;\r\nfor (i = 0 ; i < iter->data_size ; i += iter->interval) {\r\nstruct t10_pi_tuple *pi = iter->prot_buf;\r\n__be16 csum;\r\nswitch (type) {\r\ncase 1:\r\ncase 2:\r\nif (pi->app_tag == T10_PI_APP_ESCAPE)\r\ngoto next;\r\nif (be32_to_cpu(pi->ref_tag) !=\r\nlower_32_bits(iter->seed)) {\r\npr_err("%s: ref tag error at location %llu " \\r\n"(rcvd %u)\n", iter->disk_name,\r\n(unsigned long long)\r\niter->seed, be32_to_cpu(pi->ref_tag));\r\nreturn BLK_STS_PROTECTION;\r\n}\r\nbreak;\r\ncase 3:\r\nif (pi->app_tag == T10_PI_APP_ESCAPE &&\r\npi->ref_tag == T10_PI_REF_ESCAPE)\r\ngoto next;\r\nbreak;\r\n}\r\ncsum = fn(iter->data_buf, iter->interval);\r\nif (pi->guard_tag != csum) {\r\npr_err("%s: guard tag error at sector %llu " \\r\n"(rcvd %04x, want %04x)\n", iter->disk_name,\r\n(unsigned long long)iter->seed,\r\nbe16_to_cpu(pi->guard_tag), be16_to_cpu(csum));\r\nreturn BLK_STS_PROTECTION;\r\n}\r\nnext:\r\niter->data_buf += iter->interval;\r\niter->prot_buf += sizeof(struct t10_pi_tuple);\r\niter->seed++;\r\n}\r\nreturn BLK_STS_OK;\r\n}\r\nstatic blk_status_t t10_pi_type1_generate_crc(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_generate(iter, t10_pi_crc_fn, 1);\r\n}\r\nstatic blk_status_t t10_pi_type1_generate_ip(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_generate(iter, t10_pi_ip_fn, 1);\r\n}\r\nstatic blk_status_t t10_pi_type1_verify_crc(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_verify(iter, t10_pi_crc_fn, 1);\r\n}\r\nstatic blk_status_t t10_pi_type1_verify_ip(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_verify(iter, t10_pi_ip_fn, 1);\r\n}\r\nstatic blk_status_t t10_pi_type3_generate_crc(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_generate(iter, t10_pi_crc_fn, 3);\r\n}\r\nstatic blk_status_t t10_pi_type3_generate_ip(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_generate(iter, t10_pi_ip_fn, 3);\r\n}\r\nstatic blk_status_t t10_pi_type3_verify_crc(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_verify(iter, t10_pi_crc_fn, 3);\r\n}\r\nstatic blk_status_t t10_pi_type3_verify_ip(struct blk_integrity_iter *iter)\r\n{\r\nreturn t10_pi_verify(iter, t10_pi_ip_fn, 3);\r\n}

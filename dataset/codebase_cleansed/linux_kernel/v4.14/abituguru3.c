static int abituguru3_wait_while_busy(struct abituguru3_data *data)\r\n{\r\nu8 x;\r\nint timeout = ABIT_UGURU3_WAIT_TIMEOUT;\r\nwhile ((x = inb_p(data->addr + ABIT_UGURU3_DATA)) &\r\nABIT_UGURU3_STATUS_BUSY) {\r\ntimeout--;\r\nif (timeout == 0)\r\nreturn x;\r\nif (timeout == 1)\r\nmsleep(1);\r\n}\r\nreturn ABIT_UGURU3_SUCCESS;\r\n}\r\nstatic int abituguru3_wait_for_read(struct abituguru3_data *data)\r\n{\r\nu8 x;\r\nint timeout = ABIT_UGURU3_WAIT_TIMEOUT;\r\nwhile (!((x = inb_p(data->addr + ABIT_UGURU3_DATA)) &\r\nABIT_UGURU3_STATUS_READY_FOR_READ)) {\r\ntimeout--;\r\nif (timeout == 0)\r\nreturn x;\r\nif (timeout == 1)\r\nmsleep(1);\r\n}\r\nreturn ABIT_UGURU3_SUCCESS;\r\n}\r\nstatic int abituguru3_synchronize(struct abituguru3_data *data)\r\n{\r\nint x, timeout = ABIT_UGURU3_SYNCHRONIZE_TIMEOUT;\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("synchronize timeout during initial busy "\r\n"wait, status: 0x%02x\n", x);\r\nreturn -EIO;\r\n}\r\noutb(0x20, data->addr + ABIT_UGURU3_DATA);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("synchronize timeout after sending 0x20, "\r\n"status: 0x%02x\n", x);\r\nreturn -EIO;\r\n}\r\noutb(0x10, data->addr + ABIT_UGURU3_CMD);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("synchronize timeout after sending 0x10, "\r\n"status: 0x%02x\n", x);\r\nreturn -EIO;\r\n}\r\noutb(0x00, data->addr + ABIT_UGURU3_CMD);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("synchronize timeout after sending 0x00, "\r\n"status: 0x%02x\n", x);\r\nreturn -EIO;\r\n}\r\nx = abituguru3_wait_for_read(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("synchronize timeout waiting for read, "\r\n"status: 0x%02x\n", x);\r\nreturn -EIO;\r\n}\r\nwhile ((x = inb(data->addr + ABIT_UGURU3_CMD)) != 0xAC) {\r\ntimeout--;\r\nif (timeout == 0) {\r\nABIT_UGURU3_DEBUG("synchronize timeout cmd does not "\r\n"hold 0xAC after synchronize, cmd: 0x%02x\n",\r\nx);\r\nreturn -EIO;\r\n}\r\nmsleep(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int abituguru3_read(struct abituguru3_data *data, u8 bank, u8 offset,\r\nu8 count, u8 *buf)\r\n{\r\nint i, x;\r\nx = abituguru3_synchronize(data);\r\nif (x)\r\nreturn x;\r\noutb(0x1A, data->addr + ABIT_UGURU3_DATA);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("read from 0x%02x:0x%02x timed out after "\r\n"sending 0x1A, status: 0x%02x\n", (unsigned int)bank,\r\n(unsigned int)offset, x);\r\nreturn -EIO;\r\n}\r\noutb(bank, data->addr + ABIT_UGURU3_CMD);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("read from 0x%02x:0x%02x timed out after "\r\n"sending the bank, status: 0x%02x\n",\r\n(unsigned int)bank, (unsigned int)offset, x);\r\nreturn -EIO;\r\n}\r\noutb(offset, data->addr + ABIT_UGURU3_CMD);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("read from 0x%02x:0x%02x timed out after "\r\n"sending the offset, status: 0x%02x\n",\r\n(unsigned int)bank, (unsigned int)offset, x);\r\nreturn -EIO;\r\n}\r\noutb(count, data->addr + ABIT_UGURU3_CMD);\r\nx = abituguru3_wait_while_busy(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("read from 0x%02x:0x%02x timed out after "\r\n"sending the count, status: 0x%02x\n",\r\n(unsigned int)bank, (unsigned int)offset, x);\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < count; i++) {\r\nx = abituguru3_wait_for_read(data);\r\nif (x != ABIT_UGURU3_SUCCESS) {\r\nABIT_UGURU3_DEBUG("timeout reading byte %d from "\r\n"0x%02x:0x%02x, status: 0x%02x\n", i,\r\n(unsigned int)bank, (unsigned int)offset, x);\r\nbreak;\r\n}\r\nbuf[i] = inb(data->addr + ABIT_UGURU3_CMD);\r\n}\r\nreturn i;\r\n}\r\nstatic int abituguru3_read_increment_offset(struct abituguru3_data *data,\r\nu8 bank, u8 offset, u8 count,\r\nu8 *buf, int offset_count)\r\n{\r\nint i, x;\r\nfor (i = 0; i < offset_count; i++) {\r\nx = abituguru3_read(data, bank, offset + i, count,\r\nbuf + i * count);\r\nif (x != count) {\r\nif (x < 0)\r\nreturn x;\r\nreturn i * count + x;\r\n}\r\n}\r\nreturn i * count;\r\n}\r\nstatic ssize_t show_value(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nint value;\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nstruct abituguru3_data *data = abituguru3_update_device(dev);\r\nconst struct abituguru3_sensor_info *sensor;\r\nif (!data)\r\nreturn -EIO;\r\nsensor = &data->sensors[attr->index];\r\nif (attr->nr)\r\nvalue = data->settings[sensor->port][attr->nr];\r\nelse\r\nvalue = data->value[sensor->port];\r\nvalue = (value * sensor->multiplier) / sensor->divisor +\r\nsensor->offset;\r\nif (sensor->type == ABIT_UGURU3_TEMP_SENSOR)\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nint port;\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nstruct abituguru3_data *data = abituguru3_update_device(dev);\r\nif (!data)\r\nreturn -EIO;\r\nport = data->sensors[attr->index].port;\r\nif ((data->alarms[port / 8] & (0x01 << (port % 8))) &&\r\n(!attr->nr || (data->settings[port][0] & attr->nr)))\r\nreturn sprintf(buf, "1\n");\r\nelse\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t show_mask(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nstruct abituguru3_data *data = dev_get_drvdata(dev);\r\nif (data->settings[data->sensors[attr->index].port][0] & attr->nr)\r\nreturn sprintf(buf, "1\n");\r\nelse\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t show_label(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nstruct abituguru3_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->sensors[attr->index].name);\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", ABIT_UGURU3_NAME);\r\n}\r\nstatic int abituguru3_probe(struct platform_device *pdev)\r\n{\r\nconst int no_sysfs_attr[3] = { 10, 8, 7 };\r\nint sensor_index[3] = { 0, 1, 1 };\r\nstruct abituguru3_data *data;\r\nint i, j, type, used, sysfs_names_free, sysfs_attr_i, res = -ENODEV;\r\nchar *sysfs_filename;\r\nu8 buf[2];\r\nu16 id;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct abituguru3_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->addr = platform_get_resource(pdev, IORESOURCE_IO, 0)->start;\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\ni = abituguru3_read(data, ABIT_UGURU3_MISC_BANK, ABIT_UGURU3_BOARD_ID,\r\n2, buf);\r\nif (i != 2)\r\ngoto abituguru3_probe_error;\r\nif (!abituguru3_update_device(&pdev->dev))\r\ngoto abituguru3_probe_error;\r\nid = ((u16)buf[0] << 8) | (u16)buf[1];\r\nfor (i = 0; abituguru3_motherboards[i].id; i++)\r\nif (abituguru3_motherboards[i].id == id)\r\nbreak;\r\nif (!abituguru3_motherboards[i].id) {\r\npr_err("error unknown motherboard ID: %04X. %s\n",\r\n(unsigned int)id, report_this);\r\ngoto abituguru3_probe_error;\r\n}\r\ndata->sensors = abituguru3_motherboards[i].sensors;\r\npr_info("found Abit uGuru3, motherboard ID: %04X\n", (unsigned int)id);\r\nsysfs_attr_i = 0;\r\nsysfs_filename = data->sysfs_names;\r\nsysfs_names_free = ABIT_UGURU3_SYSFS_NAMES_LENGTH;\r\nfor (i = 0; data->sensors[i].name; i++) {\r\nif (i >= ABIT_UGURU3_MAX_NO_SENSORS) {\r\npr_err("Fatal error motherboard has more sensors then ABIT_UGURU3_MAX_NO_SENSORS. %s %s\n",\r\nnever_happen, report_this);\r\nres = -ENAMETOOLONG;\r\ngoto abituguru3_probe_error;\r\n}\r\ntype = data->sensors[i].type;\r\nfor (j = 0; j < no_sysfs_attr[type]; j++) {\r\nused = snprintf(sysfs_filename, sysfs_names_free,\r\nabituguru3_sysfs_templ[type][j].dev_attr.attr.\r\nname, sensor_index[type]) + 1;\r\ndata->sysfs_attr[sysfs_attr_i] =\r\nabituguru3_sysfs_templ[type][j];\r\ndata->sysfs_attr[sysfs_attr_i].dev_attr.attr.name =\r\nsysfs_filename;\r\ndata->sysfs_attr[sysfs_attr_i].index = i;\r\nsysfs_filename += used;\r\nsysfs_names_free -= used;\r\nsysfs_attr_i++;\r\n}\r\nsensor_index[type]++;\r\n}\r\nif (sysfs_names_free < 0) {\r\npr_err("Fatal error ran out of space for sysfs attr names. %s %s\n",\r\nnever_happen, report_this);\r\nres = -ENAMETOOLONG;\r\ngoto abituguru3_probe_error;\r\n}\r\nfor (i = 0; i < sysfs_attr_i; i++)\r\nif (device_create_file(&pdev->dev,\r\n&data->sysfs_attr[i].dev_attr))\r\ngoto abituguru3_probe_error;\r\nfor (i = 0; i < ARRAY_SIZE(abituguru3_sysfs_attr); i++)\r\nif (device_create_file(&pdev->dev,\r\n&abituguru3_sysfs_attr[i].dev_attr))\r\ngoto abituguru3_probe_error;\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nres = PTR_ERR(data->hwmon_dev);\r\ngoto abituguru3_probe_error;\r\n}\r\nreturn 0;\r\nabituguru3_probe_error:\r\nfor (i = 0; data->sysfs_attr[i].dev_attr.attr.name; i++)\r\ndevice_remove_file(&pdev->dev, &data->sysfs_attr[i].dev_attr);\r\nfor (i = 0; i < ARRAY_SIZE(abituguru3_sysfs_attr); i++)\r\ndevice_remove_file(&pdev->dev,\r\n&abituguru3_sysfs_attr[i].dev_attr);\r\nreturn res;\r\n}\r\nstatic int abituguru3_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nstruct abituguru3_data *data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nfor (i = 0; data->sysfs_attr[i].dev_attr.attr.name; i++)\r\ndevice_remove_file(&pdev->dev, &data->sysfs_attr[i].dev_attr);\r\nfor (i = 0; i < ARRAY_SIZE(abituguru3_sysfs_attr); i++)\r\ndevice_remove_file(&pdev->dev,\r\n&abituguru3_sysfs_attr[i].dev_attr);\r\nreturn 0;\r\n}\r\nstatic struct abituguru3_data *abituguru3_update_device(struct device *dev)\r\n{\r\nint i;\r\nstruct abituguru3_data *data = dev_get_drvdata(dev);\r\nmutex_lock(&data->update_lock);\r\nif (!data->valid || time_after(jiffies, data->last_updated + HZ)) {\r\ndata->valid = 0;\r\nif (abituguru3_read_increment_offset(data,\r\nABIT_UGURU3_SETTINGS_BANK,\r\nABIT_UGURU3_ALARMS_START,\r\n1, data->alarms, 48/8) != (48/8))\r\ngoto LEAVE_UPDATE;\r\nfor (i = 0; i < 32; i++) {\r\nif (abituguru3_read(data, ABIT_UGURU3_SENSORS_BANK,\r\nABIT_UGURU3_VALUES_START + i,\r\n1, &data->value[i]) != 1)\r\ngoto LEAVE_UPDATE;\r\nif (abituguru3_read_increment_offset(data,\r\nABIT_UGURU3_SETTINGS_BANK,\r\nABIT_UGURU3_SETTINGS_START + i * 3,\r\n1,\r\ndata->settings[i], 3) != 3)\r\ngoto LEAVE_UPDATE;\r\n}\r\nfor (i = 0; i < 16; i++) {\r\nif (abituguru3_read(data, ABIT_UGURU3_SENSORS_BANK,\r\nABIT_UGURU3_VALUES_START + 32 + i,\r\n1, &data->value[32 + i]) != 1)\r\ngoto LEAVE_UPDATE;\r\nif (abituguru3_read_increment_offset(data,\r\nABIT_UGURU3_SETTINGS_BANK,\r\nABIT_UGURU3_SETTINGS_START + 32 * 3 +\r\ni * 2, 1,\r\ndata->settings[32 + i], 2) != 2)\r\ngoto LEAVE_UPDATE;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nLEAVE_UPDATE:\r\nmutex_unlock(&data->update_lock);\r\nif (data->valid)\r\nreturn data;\r\nelse\r\nreturn NULL;\r\n}\r\nstatic int abituguru3_suspend(struct device *dev)\r\n{\r\nstruct abituguru3_data *data = dev_get_drvdata(dev);\r\nmutex_lock(&data->update_lock);\r\nreturn 0;\r\n}\r\nstatic int abituguru3_resume(struct device *dev)\r\n{\r\nstruct abituguru3_data *data = dev_get_drvdata(dev);\r\nmutex_unlock(&data->update_lock);\r\nreturn 0;\r\n}\r\nstatic int __init abituguru3_dmi_detect(void)\r\n{\r\nconst char *board_vendor, *board_name;\r\nint i, err = (force) ? 1 : -ENODEV;\r\nconst char *const *dmi_name;\r\nsize_t sublen;\r\nboard_vendor = dmi_get_system_info(DMI_BOARD_VENDOR);\r\nif (!board_vendor || strcmp(board_vendor, "http://www.abit.com.tw/"))\r\nreturn err;\r\nboard_name = dmi_get_system_info(DMI_BOARD_NAME);\r\nif (!board_name)\r\nreturn err;\r\nsublen = strcspn(board_name, "(");\r\nwhile (sublen > 0 && board_name[sublen - 1] == ' ')\r\nsublen--;\r\nfor (i = 0; abituguru3_motherboards[i].id; i++) {\r\ndmi_name = abituguru3_motherboards[i].dmi_name;\r\nfor ( ; *dmi_name; dmi_name++) {\r\nif (strlen(*dmi_name) != sublen)\r\ncontinue;\r\nif (!strncasecmp(board_name, *dmi_name, sublen))\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic int __init abituguru3_detect(void)\r\n{\r\nu8 data_val = inb_p(ABIT_UGURU3_BASE + ABIT_UGURU3_DATA);\r\nu8 cmd_val = inb_p(ABIT_UGURU3_BASE + ABIT_UGURU3_CMD);\r\nif (((data_val == 0x00) || (data_val == 0x08)) &&\r\n((cmd_val == 0xAC) || (cmd_val == 0x05) ||\r\n(cmd_val == 0x55)))\r\nreturn 0;\r\nABIT_UGURU3_DEBUG("no Abit uGuru3 found, data = 0x%02X, cmd = "\r\n"0x%02X\n", (unsigned int)data_val, (unsigned int)cmd_val);\r\nif (force) {\r\npr_info("Assuming Abit uGuru3 is present because of \"force\" parameter\n");\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int __init abituguru3_init(void)\r\n{\r\nstruct resource res = { .flags = IORESOURCE_IO };\r\nint err;\r\nerr = abituguru3_dmi_detect();\r\nif (err < 0)\r\nreturn err;\r\nif (err > 0) {\r\nerr = abituguru3_detect();\r\nif (err)\r\nreturn err;\r\npr_warn("this motherboard was not detected using DMI. "\r\n"Please send the output of \"dmidecode\" to the abituguru3 maintainer (see MAINTAINERS)\n");\r\n}\r\nerr = platform_driver_register(&abituguru3_driver);\r\nif (err)\r\ngoto exit;\r\nabituguru3_pdev = platform_device_alloc(ABIT_UGURU3_NAME,\r\nABIT_UGURU3_BASE);\r\nif (!abituguru3_pdev) {\r\npr_err("Device allocation failed\n");\r\nerr = -ENOMEM;\r\ngoto exit_driver_unregister;\r\n}\r\nres.start = ABIT_UGURU3_BASE;\r\nres.end = ABIT_UGURU3_BASE + ABIT_UGURU3_REGION_LENGTH - 1;\r\nres.name = ABIT_UGURU3_NAME;\r\nerr = platform_device_add_resources(abituguru3_pdev, &res, 1);\r\nif (err) {\r\npr_err("Device resource addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(abituguru3_pdev);\r\nif (err) {\r\npr_err("Device addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(abituguru3_pdev);\r\nexit_driver_unregister:\r\nplatform_driver_unregister(&abituguru3_driver);\r\nexit:\r\nreturn err;\r\n}\r\nstatic void __exit abituguru3_exit(void)\r\n{\r\nplatform_device_unregister(abituguru3_pdev);\r\nplatform_driver_unregister(&abituguru3_driver);\r\n}

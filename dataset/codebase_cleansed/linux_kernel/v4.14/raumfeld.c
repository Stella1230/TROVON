static void set_max9485_clk(char clk)\r\n{\r\ni2c_master_send(max9486_client, &clk, 1);\r\n}\r\nstatic void raumfeld_enable_audio(bool en)\r\n{\r\nif (en) {\r\ngpio_set_value(GPIO_MCLK_RESET, 1);\r\nmsleep(100);\r\ngpio_set_value(GPIO_SPDIF_RESET, 1);\r\ngpio_set_value(GPIO_CODEC_RESET, 1);\r\n} else {\r\ngpio_set_value(GPIO_MCLK_RESET, 0);\r\ngpio_set_value(GPIO_SPDIF_RESET, 0);\r\ngpio_set_value(GPIO_CODEC_RESET, 0);\r\n}\r\n}\r\nstatic int raumfeld_cs4270_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nreturn snd_soc_dai_set_sysclk(codec_dai, 0, 0, 0);\r\n}\r\nstatic void raumfeld_cs4270_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nsnd_soc_dai_set_sysclk(codec_dai, 0, 0, 0);\r\n}\r\nstatic int raumfeld_cs4270_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned int clk = 0;\r\nint ret = 0;\r\nswitch (params_rate(params)) {\r\ncase 44100:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_112896);\r\nclk = 11289600;\r\nbreak;\r\ncase 48000:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_122880);\r\nclk = 12288000;\r\nbreak;\r\ncase 88200:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_225792);\r\nclk = 22579200;\r\nbreak;\r\ncase 96000:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_245760);\r\nclk = 24576000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, clk, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(cpu_dai, 0, 0, 0, clk);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, PXA_SSP_DIV_SCR, 4);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, PXA_SSP_CLK_EXT, clk, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int raumfeld_analog_suspend(struct snd_soc_card *card)\r\n{\r\nraumfeld_enable_audio(false);\r\nreturn 0;\r\n}\r\nstatic int raumfeld_analog_resume(struct snd_soc_card *card)\r\n{\r\nraumfeld_enable_audio(true);\r\nreturn 0;\r\n}\r\nstatic int raumfeld_ak4104_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret = 0, clk = 0;\r\nswitch (params_rate(params)) {\r\ncase 44100:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_112896);\r\nclk = 11289600;\r\nbreak;\r\ncase 48000:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_122880);\r\nclk = 12288000;\r\nbreak;\r\ncase 88200:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_225792);\r\nclk = 22579200;\r\nbreak;\r\ncase 96000:\r\nset_max9485_clk(MAX9485_MCLK_FREQ_245760);\r\nclk = 24576000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_pll(cpu_dai, 0, 0, 0, clk);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, PXA_SSP_DIV_SCR, 4);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, PXA_SSP_CLK_EXT, clk, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int __init raumfeld_audio_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_raumfeld_speaker() &&\r\n!machine_is_raumfeld_connector())\r\nreturn 0;\r\nmax9486_client = i2c_new_device(i2c_get_adapter(0),\r\n&max9486_hwmon_info);\r\nif (!max9486_client)\r\nreturn -ENOMEM;\r\nset_max9485_clk(MAX9485_MCLK_FREQ_122880);\r\nraumfeld_audio_device = platform_device_alloc("soc-audio", 0);\r\nif (!raumfeld_audio_device)\r\nreturn -ENOMEM;\r\nif (machine_is_raumfeld_speaker())\r\nplatform_set_drvdata(raumfeld_audio_device,\r\n&snd_soc_raumfeld_speaker);\r\nif (machine_is_raumfeld_connector())\r\nplatform_set_drvdata(raumfeld_audio_device,\r\n&snd_soc_raumfeld_connector);\r\nret = platform_device_add(raumfeld_audio_device);\r\nif (ret < 0) {\r\nplatform_device_put(raumfeld_audio_device);\r\nreturn ret;\r\n}\r\nraumfeld_enable_audio(true);\r\nreturn 0;\r\n}\r\nstatic void __exit raumfeld_audio_exit(void)\r\n{\r\nraumfeld_enable_audio(false);\r\nplatform_device_unregister(raumfeld_audio_device);\r\ni2c_unregister_device(max9486_client);\r\ngpio_free(GPIO_MCLK_RESET);\r\ngpio_free(GPIO_CODEC_RESET);\r\ngpio_free(GPIO_SPDIF_RESET);\r\n}

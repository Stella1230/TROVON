__u64 jent_rol64(__u64 word, unsigned int shift)\r\n{\r\nreturn rol64(word, shift);\r\n}\r\nvoid *jent_zalloc(unsigned int len)\r\n{\r\nreturn kzalloc(len, GFP_KERNEL);\r\n}\r\nvoid jent_zfree(void *ptr)\r\n{\r\nkzfree(ptr);\r\n}\r\nint jent_fips_enabled(void)\r\n{\r\nreturn fips_enabled;\r\n}\r\nvoid jent_panic(char *s)\r\n{\r\npanic("%s", s);\r\n}\r\nvoid jent_memcpy(void *dest, const void *src, unsigned int n)\r\n{\r\nmemcpy(dest, src, n);\r\n}\r\nvoid jent_get_nstime(__u64 *out)\r\n{\r\n__u64 tmp = 0;\r\ntmp = random_get_entropy();\r\nif (tmp == 0)\r\ntmp = ktime_get_ns();\r\n*out = tmp;\r\n}\r\nstatic int jent_kcapi_init(struct crypto_tfm *tfm)\r\n{\r\nstruct jitterentropy *rng = crypto_tfm_ctx(tfm);\r\nint ret = 0;\r\nrng->entropy_collector = jent_entropy_collector_alloc(1, 0);\r\nif (!rng->entropy_collector)\r\nret = -ENOMEM;\r\nspin_lock_init(&rng->jent_lock);\r\nreturn ret;\r\n}\r\nstatic void jent_kcapi_cleanup(struct crypto_tfm *tfm)\r\n{\r\nstruct jitterentropy *rng = crypto_tfm_ctx(tfm);\r\nspin_lock(&rng->jent_lock);\r\nif (rng->entropy_collector)\r\njent_entropy_collector_free(rng->entropy_collector);\r\nrng->entropy_collector = NULL;\r\nspin_unlock(&rng->jent_lock);\r\n}\r\nstatic int jent_kcapi_random(struct crypto_rng *tfm,\r\nconst u8 *src, unsigned int slen,\r\nu8 *rdata, unsigned int dlen)\r\n{\r\nstruct jitterentropy *rng = crypto_rng_ctx(tfm);\r\nint ret = 0;\r\nspin_lock(&rng->jent_lock);\r\nret = jent_read_entropy(rng->entropy_collector, rdata, dlen);\r\nspin_unlock(&rng->jent_lock);\r\nreturn ret;\r\n}\r\nstatic int jent_kcapi_reset(struct crypto_rng *tfm,\r\nconst u8 *seed, unsigned int slen)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init jent_mod_init(void)\r\n{\r\nint ret = 0;\r\nret = jent_entropy_init();\r\nif (ret) {\r\npr_info("jitterentropy: Initialization failed with host not compliant with requirements: %d\n", ret);\r\nreturn -EFAULT;\r\n}\r\nreturn crypto_register_rng(&jent_alg);\r\n}\r\nstatic void __exit jent_mod_exit(void)\r\n{\r\ncrypto_unregister_rng(&jent_alg);\r\n}

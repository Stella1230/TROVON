static void __init nsp_rng_init(void __iomem *base)\r\n{\r\nu32 val;\r\nval = readl(base + RNG_INT_MASK);\r\nval |= RNG_INT_OFF;\r\nwritel(val, base + RNG_INT_MASK);\r\n}\r\nstatic int bcm2835_rng_read(struct hwrng *rng, void *buf, size_t max,\r\nbool wait)\r\n{\r\nvoid __iomem *rng_base = (void __iomem *)rng->priv;\r\nu32 max_words = max / sizeof(u32);\r\nu32 num_words, count;\r\nwhile ((__raw_readl(rng_base + RNG_STATUS) >> 24) == 0) {\r\nif (!wait)\r\nreturn 0;\r\ncpu_relax();\r\n}\r\nnum_words = readl(rng_base + RNG_STATUS) >> 24;\r\nif (num_words > max_words)\r\nnum_words = max_words;\r\nfor (count = 0; count < num_words; count++)\r\n((u32 *)buf)[count] = readl(rng_base + RNG_DATA);\r\nreturn num_words * sizeof(u32);\r\n}\r\nstatic int bcm2835_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nvoid (*rng_setup)(void __iomem *base);\r\nconst struct of_device_id *rng_id;\r\nvoid __iomem *rng_base;\r\nint err;\r\nrng_base = of_iomap(np, 0);\r\nif (!rng_base) {\r\ndev_err(dev, "failed to remap rng regs");\r\nreturn -ENODEV;\r\n}\r\nbcm2835_rng_ops.priv = (unsigned long)rng_base;\r\nrng_id = of_match_node(bcm2835_rng_of_match, np);\r\nif (!rng_id) {\r\niounmap(rng_base);\r\nreturn -EINVAL;\r\n}\r\nrng_setup = rng_id->data;\r\nif (rng_setup)\r\nrng_setup(rng_base);\r\n__raw_writel(RNG_WARMUP_COUNT, rng_base + RNG_STATUS);\r\n__raw_writel(RNG_RBGEN, rng_base + RNG_CTRL);\r\nerr = hwrng_register(&bcm2835_rng_ops);\r\nif (err) {\r\ndev_err(dev, "hwrng registration failed\n");\r\niounmap(rng_base);\r\n} else\r\ndev_info(dev, "hwrng registered\n");\r\nreturn err;\r\n}\r\nstatic int bcm2835_rng_remove(struct platform_device *pdev)\r\n{\r\nvoid __iomem *rng_base = (void __iomem *)bcm2835_rng_ops.priv;\r\n__raw_writel(0, rng_base + RNG_CTRL);\r\nhwrng_unregister(&bcm2835_rng_ops);\r\niounmap(rng_base);\r\nreturn 0;\r\n}

static int copy_backup_region(void)\r\n{\r\nif (purgatory_backup_dest) {\r\nmemcpy((void *)purgatory_backup_dest,\r\n(void *)purgatory_backup_src, purgatory_backup_sz);\r\n}\r\nreturn 0;\r\n}\r\nstatic int verify_sha256_digest(void)\r\n{\r\nstruct kexec_sha_region *ptr, *end;\r\nu8 digest[SHA256_DIGEST_SIZE];\r\nstruct sha256_state sctx;\r\nsha256_init(&sctx);\r\nend = purgatory_sha_regions + ARRAY_SIZE(purgatory_sha_regions);\r\nfor (ptr = purgatory_sha_regions; ptr < end; ptr++)\r\nsha256_update(&sctx, (uint8_t *)(ptr->start), ptr->len);\r\nsha256_final(&sctx, digest);\r\nif (memcmp(digest, purgatory_sha256_digest, sizeof(digest)))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid purgatory(void)\r\n{\r\nint ret;\r\nret = verify_sha256_digest();\r\nif (ret) {\r\nfor (;;)\r\n;\r\n}\r\ncopy_backup_region();\r\n}

static int nfp_hwmon_sensor_id(enum hwmon_sensor_types type, int channel)\r\n{\r\nif (type == hwmon_temp)\r\nreturn NFP_SENSOR_CHIP_TEMPERATURE;\r\nif (type == hwmon_power)\r\nreturn NFP_SENSOR_ASSEMBLY_POWER + channel;\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nnfp_hwmon_read(struct device *dev, enum hwmon_sensor_types type, u32 attr,\r\nint channel, long *val)\r\n{\r\nstatic const struct {\r\nenum hwmon_sensor_types type;\r\nu32 attr;\r\nlong val;\r\n} const_vals[] = {\r\n{ hwmon_temp, hwmon_temp_max, NFP_TEMP_MAX },\r\n{ hwmon_temp, hwmon_temp_crit, NFP_TEMP_CRIT },\r\n{ hwmon_power, hwmon_power_max, NFP_POWER_MAX },\r\n};\r\nstruct nfp_pf *pf = dev_get_drvdata(dev);\r\nenum nfp_nsp_sensor_id id;\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(const_vals); i++)\r\nif (const_vals[i].type == type && const_vals[i].attr == attr) {\r\n*val = const_vals[i].val;\r\nreturn 0;\r\n}\r\nerr = nfp_hwmon_sensor_id(type, channel);\r\nif (err < 0)\r\nreturn err;\r\nid = err;\r\nif (!(pf->nspi->sensor_mask & BIT(id)))\r\nreturn -EOPNOTSUPP;\r\nif (type == hwmon_temp && attr == hwmon_temp_input)\r\nreturn nfp_hwmon_read_sensor(pf->cpp, id, val);\r\nif (type == hwmon_power && attr == hwmon_power_input)\r\nreturn nfp_hwmon_read_sensor(pf->cpp, id, val);\r\nreturn -EINVAL;\r\n}\r\nstatic umode_t\r\nnfp_hwmon_is_visible(const void *data, enum hwmon_sensor_types type, u32 attr,\r\nint channel)\r\n{\r\nif (type == hwmon_temp) {\r\nswitch (attr) {\r\ncase hwmon_temp_input:\r\ncase hwmon_temp_crit:\r\ncase hwmon_temp_max:\r\nreturn 0444;\r\n}\r\n} else if (type == hwmon_power) {\r\nswitch (attr) {\r\ncase hwmon_power_input:\r\ncase hwmon_power_max:\r\nreturn 0444;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint nfp_hwmon_register(struct nfp_pf *pf)\r\n{\r\nif (!IS_REACHABLE(CONFIG_HWMON))\r\nreturn 0;\r\nif (!pf->nspi) {\r\nnfp_warn(pf->cpp, "not registering HWMON (no NSP info)\n");\r\nreturn 0;\r\n}\r\nif (!pf->nspi->sensor_mask) {\r\nnfp_info(pf->cpp,\r\n"not registering HWMON (NSP doesn't report sensors)\n");\r\nreturn 0;\r\n}\r\npf->hwmon_dev = hwmon_device_register_with_info(&pf->pdev->dev, "nfp",\r\npf, &nfp_chip_info,\r\nNULL);\r\nreturn PTR_ERR_OR_ZERO(pf->hwmon_dev);\r\n}\r\nvoid nfp_hwmon_unregister(struct nfp_pf *pf)\r\n{\r\nif (!IS_REACHABLE(CONFIG_HWMON) || !pf->hwmon_dev)\r\nreturn;\r\nhwmon_device_unregister(pf->hwmon_dev);\r\n}

i40e_status i40e_get_dcbx_status(struct i40e_hw *hw, u16 *status)\r\n{\r\nu32 reg;\r\nif (!status)\r\nreturn I40E_ERR_PARAM;\r\nreg = rd32(hw, I40E_PRTDCB_GENS);\r\n*status = (u16)((reg & I40E_PRTDCB_GENS_DCBX_STATUS_MASK) >>\r\nI40E_PRTDCB_GENS_DCBX_STATUS_SHIFT);\r\nreturn 0;\r\n}\r\nstatic void i40e_parse_ieee_etscfg_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nstruct i40e_dcb_ets_config *etscfg;\r\nu8 *buf = tlv->tlvinfo;\r\nu16 offset = 0;\r\nu8 priority;\r\nint i;\r\netscfg = &dcbcfg->etscfg;\r\netscfg->willing = (u8)((buf[offset] & I40E_IEEE_ETS_WILLING_MASK) >>\r\nI40E_IEEE_ETS_WILLING_SHIFT);\r\netscfg->cbs = (u8)((buf[offset] & I40E_IEEE_ETS_CBS_MASK) >>\r\nI40E_IEEE_ETS_CBS_SHIFT);\r\netscfg->maxtcs = (u8)((buf[offset] & I40E_IEEE_ETS_MAXTC_MASK) >>\r\nI40E_IEEE_ETS_MAXTC_SHIFT);\r\noffset++;\r\nfor (i = 0; i < 4; i++) {\r\npriority = (u8)((buf[offset] & I40E_IEEE_ETS_PRIO_1_MASK) >>\r\nI40E_IEEE_ETS_PRIO_1_SHIFT);\r\netscfg->prioritytable[i * 2] = priority;\r\npriority = (u8)((buf[offset] & I40E_IEEE_ETS_PRIO_0_MASK) >>\r\nI40E_IEEE_ETS_PRIO_0_SHIFT);\r\netscfg->prioritytable[i * 2 + 1] = priority;\r\noffset++;\r\n}\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\netscfg->tcbwtable[i] = buf[offset++];\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\netscfg->tsatable[i] = buf[offset++];\r\n}\r\nstatic void i40e_parse_ieee_etsrec_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu8 *buf = tlv->tlvinfo;\r\nu16 offset = 0;\r\nu8 priority;\r\nint i;\r\noffset++;\r\nfor (i = 0; i < 4; i++) {\r\npriority = (u8)((buf[offset] & I40E_IEEE_ETS_PRIO_1_MASK) >>\r\nI40E_IEEE_ETS_PRIO_1_SHIFT);\r\ndcbcfg->etsrec.prioritytable[i*2] = priority;\r\npriority = (u8)((buf[offset] & I40E_IEEE_ETS_PRIO_0_MASK) >>\r\nI40E_IEEE_ETS_PRIO_0_SHIFT);\r\ndcbcfg->etsrec.prioritytable[i*2 + 1] = priority;\r\noffset++;\r\n}\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\ndcbcfg->etsrec.tcbwtable[i] = buf[offset++];\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\ndcbcfg->etsrec.tsatable[i] = buf[offset++];\r\n}\r\nstatic void i40e_parse_ieee_pfccfg_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu8 *buf = tlv->tlvinfo;\r\ndcbcfg->pfc.willing = (u8)((buf[0] & I40E_IEEE_PFC_WILLING_MASK) >>\r\nI40E_IEEE_PFC_WILLING_SHIFT);\r\ndcbcfg->pfc.mbc = (u8)((buf[0] & I40E_IEEE_PFC_MBC_MASK) >>\r\nI40E_IEEE_PFC_MBC_SHIFT);\r\ndcbcfg->pfc.pfccap = (u8)((buf[0] & I40E_IEEE_PFC_CAP_MASK) >>\r\nI40E_IEEE_PFC_CAP_SHIFT);\r\ndcbcfg->pfc.pfcenable = buf[1];\r\n}\r\nstatic void i40e_parse_ieee_app_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu16 typelength;\r\nu16 offset = 0;\r\nu16 length;\r\nint i = 0;\r\nu8 *buf;\r\ntypelength = ntohs(tlv->typelength);\r\nlength = (u16)((typelength & I40E_LLDP_TLV_LEN_MASK) >>\r\nI40E_LLDP_TLV_LEN_SHIFT);\r\nbuf = tlv->tlvinfo;\r\nlength -= (sizeof(tlv->ouisubtype) + 1);\r\noffset++;\r\nwhile (offset < length) {\r\ndcbcfg->app[i].priority = (u8)((buf[offset] &\r\nI40E_IEEE_APP_PRIO_MASK) >>\r\nI40E_IEEE_APP_PRIO_SHIFT);\r\ndcbcfg->app[i].selector = (u8)((buf[offset] &\r\nI40E_IEEE_APP_SEL_MASK) >>\r\nI40E_IEEE_APP_SEL_SHIFT);\r\ndcbcfg->app[i].protocolid = (buf[offset + 1] << 0x8) |\r\nbuf[offset + 2];\r\noffset += 3;\r\ni++;\r\nif (i >= I40E_DCBX_MAX_APPS)\r\nbreak;\r\n}\r\ndcbcfg->numapps = i;\r\n}\r\nstatic void i40e_parse_ieee_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu32 ouisubtype;\r\nu8 subtype;\r\nouisubtype = ntohl(tlv->ouisubtype);\r\nsubtype = (u8)((ouisubtype & I40E_LLDP_TLV_SUBTYPE_MASK) >>\r\nI40E_LLDP_TLV_SUBTYPE_SHIFT);\r\nswitch (subtype) {\r\ncase I40E_IEEE_SUBTYPE_ETS_CFG:\r\ni40e_parse_ieee_etscfg_tlv(tlv, dcbcfg);\r\nbreak;\r\ncase I40E_IEEE_SUBTYPE_ETS_REC:\r\ni40e_parse_ieee_etsrec_tlv(tlv, dcbcfg);\r\nbreak;\r\ncase I40E_IEEE_SUBTYPE_PFC_CFG:\r\ni40e_parse_ieee_pfccfg_tlv(tlv, dcbcfg);\r\nbreak;\r\ncase I40E_IEEE_SUBTYPE_APP_PRI:\r\ni40e_parse_ieee_app_tlv(tlv, dcbcfg);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void i40e_parse_cee_pgcfg_tlv(struct i40e_cee_feat_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nstruct i40e_dcb_ets_config *etscfg;\r\nu8 *buf = tlv->tlvinfo;\r\nu16 offset = 0;\r\nu8 priority;\r\nint i;\r\netscfg = &dcbcfg->etscfg;\r\nif (tlv->en_will_err & I40E_CEE_FEAT_TLV_WILLING_MASK)\r\netscfg->willing = 1;\r\netscfg->cbs = 0;\r\nfor (i = 0; i < 4; i++) {\r\npriority = (u8)((buf[offset] & I40E_CEE_PGID_PRIO_1_MASK) >>\r\nI40E_CEE_PGID_PRIO_1_SHIFT);\r\netscfg->prioritytable[i * 2] = priority;\r\npriority = (u8)((buf[offset] & I40E_CEE_PGID_PRIO_0_MASK) >>\r\nI40E_CEE_PGID_PRIO_0_SHIFT);\r\netscfg->prioritytable[i * 2 + 1] = priority;\r\noffset++;\r\n}\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\netscfg->tcbwtable[i] = buf[offset++];\r\netscfg->maxtcs = buf[offset];\r\n}\r\nstatic void i40e_parse_cee_pfccfg_tlv(struct i40e_cee_feat_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu8 *buf = tlv->tlvinfo;\r\nif (tlv->en_will_err & I40E_CEE_FEAT_TLV_WILLING_MASK)\r\ndcbcfg->pfc.willing = 1;\r\ndcbcfg->pfc.pfcenable = buf[0];\r\ndcbcfg->pfc.pfccap = buf[1];\r\n}\r\nstatic void i40e_parse_cee_app_tlv(struct i40e_cee_feat_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu16 length, typelength, offset = 0;\r\nstruct i40e_cee_app_prio *app;\r\nu8 i;\r\ntypelength = ntohs(tlv->hdr.typelen);\r\nlength = (u16)((typelength & I40E_LLDP_TLV_LEN_MASK) >>\r\nI40E_LLDP_TLV_LEN_SHIFT);\r\ndcbcfg->numapps = length / sizeof(*app);\r\nif (!dcbcfg->numapps)\r\nreturn;\r\nif (dcbcfg->numapps > I40E_DCBX_MAX_APPS)\r\ndcbcfg->numapps = I40E_DCBX_MAX_APPS;\r\nfor (i = 0; i < dcbcfg->numapps; i++) {\r\nu8 up, selector;\r\napp = (struct i40e_cee_app_prio *)(tlv->tlvinfo + offset);\r\nfor (up = 0; up < I40E_MAX_USER_PRIORITY; up++) {\r\nif (app->prio_map & BIT(up))\r\nbreak;\r\n}\r\ndcbcfg->app[i].priority = up;\r\nselector = (app->upper_oui_sel & I40E_CEE_APP_SELECTOR_MASK);\r\nswitch (selector) {\r\ncase I40E_CEE_APP_SEL_ETHTYPE:\r\ndcbcfg->app[i].selector = I40E_APP_SEL_ETHTYPE;\r\nbreak;\r\ncase I40E_CEE_APP_SEL_TCPIP:\r\ndcbcfg->app[i].selector = I40E_APP_SEL_TCPIP;\r\nbreak;\r\ndefault:\r\ndcbcfg->app[i].selector = selector;\r\n}\r\ndcbcfg->app[i].protocolid = ntohs(app->protocol);\r\noffset += sizeof(*app);\r\n}\r\n}\r\nstatic void i40e_parse_cee_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu16 len, tlvlen, sublen, typelength;\r\nstruct i40e_cee_feat_tlv *sub_tlv;\r\nu8 subtype, feat_tlv_count = 0;\r\nu32 ouisubtype;\r\nouisubtype = ntohl(tlv->ouisubtype);\r\nsubtype = (u8)((ouisubtype & I40E_LLDP_TLV_SUBTYPE_MASK) >>\r\nI40E_LLDP_TLV_SUBTYPE_SHIFT);\r\nif (subtype != I40E_CEE_DCBX_TYPE)\r\nreturn;\r\ntypelength = ntohs(tlv->typelength);\r\ntlvlen = (u16)((typelength & I40E_LLDP_TLV_LEN_MASK) >>\r\nI40E_LLDP_TLV_LEN_SHIFT);\r\nlen = sizeof(tlv->typelength) + sizeof(ouisubtype) +\r\nsizeof(struct i40e_cee_ctrl_tlv);\r\nif (tlvlen <= len)\r\nreturn;\r\nsub_tlv = (struct i40e_cee_feat_tlv *)((char *)tlv + len);\r\nwhile (feat_tlv_count < I40E_CEE_MAX_FEAT_TYPE) {\r\ntypelength = ntohs(sub_tlv->hdr.typelen);\r\nsublen = (u16)((typelength &\r\nI40E_LLDP_TLV_LEN_MASK) >>\r\nI40E_LLDP_TLV_LEN_SHIFT);\r\nsubtype = (u8)((typelength & I40E_LLDP_TLV_TYPE_MASK) >>\r\nI40E_LLDP_TLV_TYPE_SHIFT);\r\nswitch (subtype) {\r\ncase I40E_CEE_SUBTYPE_PG_CFG:\r\ni40e_parse_cee_pgcfg_tlv(sub_tlv, dcbcfg);\r\nbreak;\r\ncase I40E_CEE_SUBTYPE_PFC_CFG:\r\ni40e_parse_cee_pfccfg_tlv(sub_tlv, dcbcfg);\r\nbreak;\r\ncase I40E_CEE_SUBTYPE_APP_PRI:\r\ni40e_parse_cee_app_tlv(sub_tlv, dcbcfg);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nfeat_tlv_count++;\r\nsub_tlv = (struct i40e_cee_feat_tlv *)((char *)sub_tlv +\r\nsizeof(sub_tlv->hdr.typelen) +\r\nsublen);\r\n}\r\n}\r\nstatic void i40e_parse_org_tlv(struct i40e_lldp_org_tlv *tlv,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu32 ouisubtype;\r\nu32 oui;\r\nouisubtype = ntohl(tlv->ouisubtype);\r\noui = (u32)((ouisubtype & I40E_LLDP_TLV_OUI_MASK) >>\r\nI40E_LLDP_TLV_OUI_SHIFT);\r\nswitch (oui) {\r\ncase I40E_IEEE_8021QAZ_OUI:\r\ni40e_parse_ieee_tlv(tlv, dcbcfg);\r\nbreak;\r\ncase I40E_CEE_DCBX_OUI:\r\ni40e_parse_cee_tlv(tlv, dcbcfg);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ni40e_status i40e_lldp_to_dcb_config(u8 *lldpmib,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\ni40e_status ret = 0;\r\nstruct i40e_lldp_org_tlv *tlv;\r\nu16 type;\r\nu16 length;\r\nu16 typelength;\r\nu16 offset = 0;\r\nif (!lldpmib || !dcbcfg)\r\nreturn I40E_ERR_PARAM;\r\nlldpmib += ETH_HLEN;\r\ntlv = (struct i40e_lldp_org_tlv *)lldpmib;\r\nwhile (1) {\r\ntypelength = ntohs(tlv->typelength);\r\ntype = (u16)((typelength & I40E_LLDP_TLV_TYPE_MASK) >>\r\nI40E_LLDP_TLV_TYPE_SHIFT);\r\nlength = (u16)((typelength & I40E_LLDP_TLV_LEN_MASK) >>\r\nI40E_LLDP_TLV_LEN_SHIFT);\r\noffset += sizeof(typelength) + length;\r\nif ((type == I40E_TLV_TYPE_END) || (offset > I40E_LLDPDU_SIZE))\r\nbreak;\r\nswitch (type) {\r\ncase I40E_TLV_TYPE_ORG:\r\ni40e_parse_org_tlv(tlv, dcbcfg);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ntlv = (struct i40e_lldp_org_tlv *)((char *)tlv +\r\nsizeof(tlv->typelength) +\r\nlength);\r\n}\r\nreturn ret;\r\n}\r\ni40e_status i40e_aq_get_dcb_config(struct i40e_hw *hw, u8 mib_type,\r\nu8 bridgetype,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\ni40e_status ret = 0;\r\nstruct i40e_virt_mem mem;\r\nu8 *lldpmib;\r\nret = i40e_allocate_virt_mem(hw, &mem, I40E_LLDPDU_SIZE);\r\nif (ret)\r\nreturn ret;\r\nlldpmib = (u8 *)mem.va;\r\nret = i40e_aq_get_lldp_mib(hw, bridgetype, mib_type,\r\n(void *)lldpmib, I40E_LLDPDU_SIZE,\r\nNULL, NULL, NULL);\r\nif (ret)\r\ngoto free_mem;\r\nret = i40e_lldp_to_dcb_config(lldpmib, dcbcfg);\r\nfree_mem:\r\ni40e_free_virt_mem(hw, &mem);\r\nreturn ret;\r\n}\r\nstatic void i40e_cee_to_dcb_v1_config(\r\nstruct i40e_aqc_get_cee_dcb_cfg_v1_resp *cee_cfg,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu16 status, tlv_status = le16_to_cpu(cee_cfg->tlv_status);\r\nu16 app_prio = le16_to_cpu(cee_cfg->oper_app_prio);\r\nu8 i, tc, err;\r\ndcbcfg->etscfg.maxtcs = cee_cfg->oper_num_tc;\r\nfor (i = 0; i < 4; i++) {\r\ntc = (u8)((cee_cfg->oper_prio_tc[i] &\r\nI40E_CEE_PGID_PRIO_0_MASK) >>\r\nI40E_CEE_PGID_PRIO_0_SHIFT);\r\ndcbcfg->etscfg.prioritytable[i * 2] = tc;\r\ntc = (u8)((cee_cfg->oper_prio_tc[i] &\r\nI40E_CEE_PGID_PRIO_1_MASK) >>\r\nI40E_CEE_PGID_PRIO_1_SHIFT);\r\ndcbcfg->etscfg.prioritytable[i*2 + 1] = tc;\r\n}\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\ndcbcfg->etscfg.tcbwtable[i] = cee_cfg->oper_tc_bw[i];\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++) {\r\nif (dcbcfg->etscfg.prioritytable[i] == I40E_CEE_PGID_STRICT) {\r\ndcbcfg->etscfg.prioritytable[i] =\r\ncee_cfg->oper_num_tc - 1;\r\ndcbcfg->etscfg.tsatable[i] = I40E_IEEE_TSA_STRICT;\r\n} else {\r\ndcbcfg->etscfg.tsatable[i] = I40E_IEEE_TSA_ETS;\r\n}\r\n}\r\ndcbcfg->pfc.pfcenable = cee_cfg->oper_pfc_en;\r\ndcbcfg->pfc.pfccap = I40E_MAX_TRAFFIC_CLASS;\r\nstatus = (tlv_status & I40E_AQC_CEE_APP_STATUS_MASK) >>\r\nI40E_AQC_CEE_APP_STATUS_SHIFT;\r\nerr = (status & I40E_TLV_STATUS_ERR) ? 1 : 0;\r\nif (!err) {\r\ndcbcfg->numapps = I40E_CEE_OPER_MAX_APPS;\r\ndcbcfg->app[0].priority =\r\n(app_prio & I40E_AQC_CEE_APP_FCOE_MASK) >>\r\nI40E_AQC_CEE_APP_FCOE_SHIFT;\r\ndcbcfg->app[0].selector = I40E_APP_SEL_ETHTYPE;\r\ndcbcfg->app[0].protocolid = I40E_APP_PROTOID_FCOE;\r\ndcbcfg->app[1].priority =\r\n(app_prio & I40E_AQC_CEE_APP_ISCSI_MASK) >>\r\nI40E_AQC_CEE_APP_ISCSI_SHIFT;\r\ndcbcfg->app[1].selector = I40E_APP_SEL_TCPIP;\r\ndcbcfg->app[1].protocolid = I40E_APP_PROTOID_ISCSI;\r\ndcbcfg->app[2].priority =\r\n(app_prio & I40E_AQC_CEE_APP_FIP_MASK) >>\r\nI40E_AQC_CEE_APP_FIP_SHIFT;\r\ndcbcfg->app[2].selector = I40E_APP_SEL_ETHTYPE;\r\ndcbcfg->app[2].protocolid = I40E_APP_PROTOID_FIP;\r\n}\r\n}\r\nstatic void i40e_cee_to_dcb_config(\r\nstruct i40e_aqc_get_cee_dcb_cfg_resp *cee_cfg,\r\nstruct i40e_dcbx_config *dcbcfg)\r\n{\r\nu32 status, tlv_status = le32_to_cpu(cee_cfg->tlv_status);\r\nu16 app_prio = le16_to_cpu(cee_cfg->oper_app_prio);\r\nu8 i, tc, err, sync, oper;\r\ndcbcfg->etscfg.maxtcs = cee_cfg->oper_num_tc;\r\nfor (i = 0; i < 4; i++) {\r\ntc = (u8)((cee_cfg->oper_prio_tc[i] &\r\nI40E_CEE_PGID_PRIO_0_MASK) >>\r\nI40E_CEE_PGID_PRIO_0_SHIFT);\r\ndcbcfg->etscfg.prioritytable[i * 2] = tc;\r\ntc = (u8)((cee_cfg->oper_prio_tc[i] &\r\nI40E_CEE_PGID_PRIO_1_MASK) >>\r\nI40E_CEE_PGID_PRIO_1_SHIFT);\r\ndcbcfg->etscfg.prioritytable[i * 2 + 1] = tc;\r\n}\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++)\r\ndcbcfg->etscfg.tcbwtable[i] = cee_cfg->oper_tc_bw[i];\r\nfor (i = 0; i < I40E_MAX_TRAFFIC_CLASS; i++) {\r\nif (dcbcfg->etscfg.prioritytable[i] == I40E_CEE_PGID_STRICT) {\r\ndcbcfg->etscfg.prioritytable[i] =\r\ncee_cfg->oper_num_tc - 1;\r\ndcbcfg->etscfg.tsatable[i] = I40E_IEEE_TSA_STRICT;\r\n} else {\r\ndcbcfg->etscfg.tsatable[i] = I40E_IEEE_TSA_ETS;\r\n}\r\n}\r\ndcbcfg->pfc.pfcenable = cee_cfg->oper_pfc_en;\r\ndcbcfg->pfc.pfccap = I40E_MAX_TRAFFIC_CLASS;\r\ni = 0;\r\nstatus = (tlv_status & I40E_AQC_CEE_FCOE_STATUS_MASK) >>\r\nI40E_AQC_CEE_FCOE_STATUS_SHIFT;\r\nerr = (status & I40E_TLV_STATUS_ERR) ? 1 : 0;\r\nsync = (status & I40E_TLV_STATUS_SYNC) ? 1 : 0;\r\noper = (status & I40E_TLV_STATUS_OPER) ? 1 : 0;\r\nif (!err && sync && oper) {\r\ndcbcfg->app[i].priority =\r\n(app_prio & I40E_AQC_CEE_APP_FCOE_MASK) >>\r\nI40E_AQC_CEE_APP_FCOE_SHIFT;\r\ndcbcfg->app[i].selector = I40E_APP_SEL_ETHTYPE;\r\ndcbcfg->app[i].protocolid = I40E_APP_PROTOID_FCOE;\r\ni++;\r\n}\r\nstatus = (tlv_status & I40E_AQC_CEE_ISCSI_STATUS_MASK) >>\r\nI40E_AQC_CEE_ISCSI_STATUS_SHIFT;\r\nerr = (status & I40E_TLV_STATUS_ERR) ? 1 : 0;\r\nsync = (status & I40E_TLV_STATUS_SYNC) ? 1 : 0;\r\noper = (status & I40E_TLV_STATUS_OPER) ? 1 : 0;\r\nif (!err && sync && oper) {\r\ndcbcfg->app[i].priority =\r\n(app_prio & I40E_AQC_CEE_APP_ISCSI_MASK) >>\r\nI40E_AQC_CEE_APP_ISCSI_SHIFT;\r\ndcbcfg->app[i].selector = I40E_APP_SEL_TCPIP;\r\ndcbcfg->app[i].protocolid = I40E_APP_PROTOID_ISCSI;\r\ni++;\r\n}\r\nstatus = (tlv_status & I40E_AQC_CEE_FIP_STATUS_MASK) >>\r\nI40E_AQC_CEE_FIP_STATUS_SHIFT;\r\nerr = (status & I40E_TLV_STATUS_ERR) ? 1 : 0;\r\nsync = (status & I40E_TLV_STATUS_SYNC) ? 1 : 0;\r\noper = (status & I40E_TLV_STATUS_OPER) ? 1 : 0;\r\nif (!err && sync && oper) {\r\ndcbcfg->app[i].priority =\r\n(app_prio & I40E_AQC_CEE_APP_FIP_MASK) >>\r\nI40E_AQC_CEE_APP_FIP_SHIFT;\r\ndcbcfg->app[i].selector = I40E_APP_SEL_ETHTYPE;\r\ndcbcfg->app[i].protocolid = I40E_APP_PROTOID_FIP;\r\ni++;\r\n}\r\ndcbcfg->numapps = i;\r\n}\r\nstatic i40e_status i40e_get_ieee_dcb_config(struct i40e_hw *hw)\r\n{\r\ni40e_status ret = 0;\r\nhw->local_dcbx_config.dcbx_mode = I40E_DCBX_MODE_IEEE;\r\nret = i40e_aq_get_dcb_config(hw, I40E_AQ_LLDP_MIB_LOCAL, 0,\r\n&hw->local_dcbx_config);\r\nif (ret)\r\ngoto out;\r\nret = i40e_aq_get_dcb_config(hw, I40E_AQ_LLDP_MIB_REMOTE,\r\nI40E_AQ_LLDP_BRIDGE_TYPE_NEAREST_BRIDGE,\r\n&hw->remote_dcbx_config);\r\nif (hw->aq.asq_last_status == I40E_AQ_RC_ENOENT)\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\ni40e_status i40e_get_dcb_config(struct i40e_hw *hw)\r\n{\r\ni40e_status ret = 0;\r\nstruct i40e_aqc_get_cee_dcb_cfg_resp cee_cfg;\r\nstruct i40e_aqc_get_cee_dcb_cfg_v1_resp cee_v1_cfg;\r\nif ((hw->mac.type == I40E_MAC_XL710) &&\r\n(((hw->aq.fw_maj_ver == 4) && (hw->aq.fw_min_ver < 33)) ||\r\n(hw->aq.fw_maj_ver < 4)))\r\nreturn i40e_get_ieee_dcb_config(hw);\r\nif ((hw->mac.type == I40E_MAC_XL710) &&\r\n((hw->aq.fw_maj_ver == 4) && (hw->aq.fw_min_ver == 33))) {\r\nret = i40e_aq_get_cee_dcb_config(hw, &cee_v1_cfg,\r\nsizeof(cee_v1_cfg), NULL);\r\nif (!ret) {\r\nhw->local_dcbx_config.dcbx_mode = I40E_DCBX_MODE_CEE;\r\nhw->local_dcbx_config.tlv_status =\r\nle16_to_cpu(cee_v1_cfg.tlv_status);\r\ni40e_cee_to_dcb_v1_config(&cee_v1_cfg,\r\n&hw->local_dcbx_config);\r\n}\r\n} else {\r\nret = i40e_aq_get_cee_dcb_config(hw, &cee_cfg,\r\nsizeof(cee_cfg), NULL);\r\nif (!ret) {\r\nhw->local_dcbx_config.dcbx_mode = I40E_DCBX_MODE_CEE;\r\nhw->local_dcbx_config.tlv_status =\r\nle32_to_cpu(cee_cfg.tlv_status);\r\ni40e_cee_to_dcb_config(&cee_cfg,\r\n&hw->local_dcbx_config);\r\n}\r\n}\r\nif (hw->aq.asq_last_status == I40E_AQ_RC_ENOENT)\r\nreturn i40e_get_ieee_dcb_config(hw);\r\nif (ret)\r\ngoto out;\r\nret = i40e_aq_get_dcb_config(hw, I40E_AQ_LLDP_MIB_LOCAL, 0,\r\n&hw->desired_dcbx_config);\r\nif (ret)\r\ngoto out;\r\nret = i40e_aq_get_dcb_config(hw, I40E_AQ_LLDP_MIB_REMOTE,\r\nI40E_AQ_LLDP_BRIDGE_TYPE_NEAREST_BRIDGE,\r\n&hw->remote_dcbx_config);\r\nif (hw->aq.asq_last_status == I40E_AQ_RC_ENOENT)\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\ni40e_status i40e_init_dcb(struct i40e_hw *hw)\r\n{\r\ni40e_status ret = 0;\r\nstruct i40e_lldp_variables lldp_cfg;\r\nu8 adminstatus = 0;\r\nif (!hw->func_caps.dcb)\r\nreturn ret;\r\nret = i40e_read_lldp_cfg(hw, &lldp_cfg);\r\nif (ret)\r\nreturn ret;\r\nadminstatus = lldp_cfg.adminstatus >> (hw->port * 4);\r\nadminstatus &= 0xF;\r\nif (!adminstatus) {\r\nhw->dcbx_status = I40E_DCBX_STATUS_DISABLED;\r\nreturn ret;\r\n}\r\nret = i40e_get_dcbx_status(hw, &hw->dcbx_status);\r\nif (ret)\r\nreturn ret;\r\nswitch (hw->dcbx_status) {\r\ncase I40E_DCBX_STATUS_DONE:\r\ncase I40E_DCBX_STATUS_IN_PROGRESS:\r\nret = i40e_get_dcb_config(hw);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase I40E_DCBX_STATUS_DISABLED:\r\nreturn ret;\r\ncase I40E_DCBX_STATUS_NOT_STARTED:\r\ncase I40E_DCBX_STATUS_MULTIPLE_PEERS:\r\ndefault:\r\nbreak;\r\n}\r\nret = i40e_aq_cfg_lldp_mib_change_event(hw, true, NULL);\r\nif (ret)\r\nreturn ret;\r\nreturn ret;\r\n}\r\ni40e_status i40e_read_lldp_cfg(struct i40e_hw *hw,\r\nstruct i40e_lldp_variables *lldp_cfg)\r\n{\r\ni40e_status ret = 0;\r\nu32 offset = (2 * I40E_NVM_LLDP_CFG_PTR);\r\nif (!lldp_cfg)\r\nreturn I40E_ERR_PARAM;\r\nret = i40e_acquire_nvm(hw, I40E_RESOURCE_READ);\r\nif (ret)\r\ngoto err_lldp_cfg;\r\nret = i40e_aq_read_nvm(hw, I40E_SR_EMP_MODULE_PTR, offset,\r\nsizeof(struct i40e_lldp_variables),\r\n(u8 *)lldp_cfg,\r\ntrue, NULL);\r\ni40e_release_nvm(hw);\r\nerr_lldp_cfg:\r\nreturn ret;\r\n}

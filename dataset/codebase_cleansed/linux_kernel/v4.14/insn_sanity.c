static void usage(const char *err)\r\n{\r\nif (err)\r\nfprintf(stderr, "%s: Error: %s\n\n", prog, err);\r\nfprintf(stderr, "Usage: %s [-y|-n|-v] [-s seed[,no]] [-m max] [-i input]\n", prog);\r\nfprintf(stderr, "\t-y 64bit mode\n");\r\nfprintf(stderr, "\t-n 32bit mode\n");\r\nfprintf(stderr, "\t-v Verbosity(-vv dumps any decoded result)\n");\r\nfprintf(stderr, "\t-s Give a random seed (and iteration number)\n");\r\nfprintf(stderr, "\t-m Give a maximum iteration number\n");\r\nfprintf(stderr, "\t-i Give an input file with decoded binary\n");\r\nexit(1);\r\n}\r\nstatic void dump_field(FILE *fp, const char *name, const char *indent,\r\nstruct insn_field *field)\r\n{\r\nfprintf(fp, "%s.%s = {\n", indent, name);\r\nfprintf(fp, "%s\t.value = %d, bytes[] = {%x, %x, %x, %x},\n",\r\nindent, field->value, field->bytes[0], field->bytes[1],\r\nfield->bytes[2], field->bytes[3]);\r\nfprintf(fp, "%s\t.got = %d, .nbytes = %d},\n", indent,\r\nfield->got, field->nbytes);\r\n}\r\nstatic void dump_insn(FILE *fp, struct insn *insn)\r\n{\r\nfprintf(fp, "Instruction = {\n");\r\ndump_field(fp, "prefixes", "\t", &insn->prefixes);\r\ndump_field(fp, "rex_prefix", "\t", &insn->rex_prefix);\r\ndump_field(fp, "vex_prefix", "\t", &insn->vex_prefix);\r\ndump_field(fp, "opcode", "\t", &insn->opcode);\r\ndump_field(fp, "modrm", "\t", &insn->modrm);\r\ndump_field(fp, "sib", "\t", &insn->sib);\r\ndump_field(fp, "displacement", "\t", &insn->displacement);\r\ndump_field(fp, "immediate1", "\t", &insn->immediate1);\r\ndump_field(fp, "immediate2", "\t", &insn->immediate2);\r\nfprintf(fp, "\t.attr = %x, .opnd_bytes = %d, .addr_bytes = %d,\n",\r\ninsn->attr, insn->opnd_bytes, insn->addr_bytes);\r\nfprintf(fp, "\t.length = %d, .x86_64 = %d, .kaddr = %p}\n",\r\ninsn->length, insn->x86_64, insn->kaddr);\r\n}\r\nstatic void dump_stream(FILE *fp, const char *msg, unsigned long nr_iter,\r\nunsigned char *insn_buf, struct insn *insn)\r\n{\r\nint i;\r\nfprintf(fp, "%s:\n", msg);\r\ndump_insn(fp, insn);\r\nfprintf(fp, "You can reproduce this with below command(s);\n");\r\nfprintf(fp, " $ echo ");\r\nfor (i = 0; i < MAX_INSN_SIZE; i++)\r\nfprintf(fp, " %02x", insn_buf[i]);\r\nfprintf(fp, " | %s -i -\n", prog);\r\nif (!input_file) {\r\nfprintf(fp, "Or \n");\r\nfprintf(fp, " $ %s -s 0x%x,%lu\n", prog, seed, nr_iter);\r\n}\r\n}\r\nstatic void init_random_seed(void)\r\n{\r\nint fd;\r\nfd = open("/dev/urandom", O_RDONLY);\r\nif (fd < 0)\r\ngoto fail;\r\nif (read(fd, &seed, sizeof(seed)) != sizeof(seed))\r\ngoto fail;\r\nclose(fd);\r\nreturn;\r\nfail:\r\nusage("Failed to open /dev/urandom");\r\n}\r\nstatic int read_next_insn(unsigned char *insn_buf)\r\n{\r\nchar buf[256] = "", *tmp;\r\nint i;\r\ntmp = fgets(buf, ARRAY_SIZE(buf), input_file);\r\nif (tmp == NULL || feof(input_file))\r\nreturn 0;\r\nfor (i = 0; i < MAX_INSN_SIZE; i++) {\r\ninsn_buf[i] = (unsigned char)strtoul(tmp, &tmp, 16);\r\nif (*tmp != ' ')\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nstatic int generate_insn(unsigned char *insn_buf)\r\n{\r\nint i;\r\nif (input_file)\r\nreturn read_next_insn(insn_buf);\r\nfor (i = 0; i < MAX_INSN_SIZE - 1; i += 2)\r\n*(unsigned short *)(&insn_buf[i]) = random() & 0xffff;\r\nwhile (i < MAX_INSN_SIZE)\r\ninsn_buf[i++] = random() & 0xff;\r\nreturn i;\r\n}\r\nstatic void parse_args(int argc, char **argv)\r\n{\r\nint c;\r\nchar *tmp = NULL;\r\nint set_seed = 0;\r\nprog = argv[0];\r\nwhile ((c = getopt(argc, argv, "ynvs:m:i:")) != -1) {\r\nswitch (c) {\r\ncase 'y':\r\nx86_64 = 1;\r\nbreak;\r\ncase 'n':\r\nx86_64 = 0;\r\nbreak;\r\ncase 'v':\r\nverbose++;\r\nbreak;\r\ncase 'i':\r\nif (strcmp("-", optarg) == 0)\r\ninput_file = stdin;\r\nelse\r\ninput_file = fopen(optarg, "r");\r\nif (!input_file)\r\nusage("Failed to open input file");\r\nbreak;\r\ncase 's':\r\nseed = (unsigned int)strtoul(optarg, &tmp, 0);\r\nif (*tmp == ',') {\r\noptarg = tmp + 1;\r\niter_start = strtoul(optarg, &tmp, 0);\r\n}\r\nif (*tmp != '\0' || tmp == optarg)\r\nusage("Failed to parse seed");\r\nset_seed = 1;\r\nbreak;\r\ncase 'm':\r\niter_end = strtoul(optarg, &tmp, 0);\r\nif (*tmp != '\0' || tmp == optarg)\r\nusage("Failed to parse max_iter");\r\nbreak;\r\ndefault:\r\nusage(NULL);\r\n}\r\n}\r\nif (iter_end < iter_start)\r\nusage("Max iteration number must be bigger than iter-num");\r\nif (set_seed && input_file)\r\nusage("Don't use input file (-i) with random seed (-s)");\r\nif (!input_file) {\r\nif (!set_seed)\r\ninit_random_seed();\r\nsrand(seed);\r\n}\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nstruct insn insn;\r\nint insns = 0;\r\nint errors = 0;\r\nunsigned long i;\r\nunsigned char insn_buf[MAX_INSN_SIZE * 2];\r\nparse_args(argc, argv);\r\nmemset(insn_buf + MAX_INSN_SIZE, INSN_NOP, MAX_INSN_SIZE);\r\nfor (i = 0; i < iter_end; i++) {\r\nif (generate_insn(insn_buf) <= 0)\r\nbreak;\r\nif (i < iter_start)\r\ncontinue;\r\ninsn_init(&insn, insn_buf, sizeof(insn_buf), x86_64);\r\ninsn_get_length(&insn);\r\nif (insn.next_byte <= insn.kaddr ||\r\ninsn.kaddr + MAX_INSN_SIZE < insn.next_byte) {\r\ndump_stream(stderr, "Error: Found an access violation", i, insn_buf, &insn);\r\nerrors++;\r\n} else if (verbose && !insn_complete(&insn))\r\ndump_stream(stdout, "Info: Found an undecodable input", i, insn_buf, &insn);\r\nelse if (verbose >= 2)\r\ndump_insn(stdout, &insn);\r\ninsns++;\r\n}\r\nfprintf((errors) ? stderr : stdout,\r\n"%s: %s: decoded and checked %d %s instructions with %d errors (seed:0x%x)\n",\r\nprog,\r\n(errors) ? "Failure" : "Success",\r\ninsns,\r\n(input_file) ? "given" : "random",\r\nerrors,\r\nseed);\r\nreturn errors ? 1 : 0;\r\n}

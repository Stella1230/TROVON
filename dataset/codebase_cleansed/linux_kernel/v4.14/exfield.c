static u32\r\nacpi_ex_get_serial_access_length(u32 accessor_type, u32 access_length)\r\n{\r\nu32 length;\r\nswitch (accessor_type) {\r\ncase AML_FIELD_ATTRIB_QUICK:\r\nlength = 0;\r\nbreak;\r\ncase AML_FIELD_ATTRIB_SEND_RCV:\r\ncase AML_FIELD_ATTRIB_BYTE:\r\nlength = 1;\r\nbreak;\r\ncase AML_FIELD_ATTRIB_WORD:\r\ncase AML_FIELD_ATTRIB_WORD_CALL:\r\nlength = 2;\r\nbreak;\r\ncase AML_FIELD_ATTRIB_MULTIBYTE:\r\ncase AML_FIELD_ATTRIB_RAW_BYTES:\r\ncase AML_FIELD_ATTRIB_RAW_PROCESS:\r\nlength = access_length;\r\nbreak;\r\ncase AML_FIELD_ATTRIB_BLOCK:\r\ncase AML_FIELD_ATTRIB_BLOCK_CALL:\r\ndefault:\r\nlength = ACPI_GSBUS_BUFFER_SIZE - 2;\r\nbreak;\r\n}\r\nreturn (length);\r\n}\r\nacpi_status\r\nacpi_ex_read_data_from_field(struct acpi_walk_state *walk_state,\r\nunion acpi_operand_object *obj_desc,\r\nunion acpi_operand_object **ret_buffer_desc)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *buffer_desc;\r\nacpi_size length;\r\nvoid *buffer;\r\nu32 function;\r\nu16 accessor_type;\r\nACPI_FUNCTION_TRACE_PTR(ex_read_data_from_field, obj_desc);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nif (!ret_buffer_desc) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\r\nif (!(obj_desc->common.flags & AOPOBJ_DATA_VALID)) {\r\nstatus = acpi_ds_get_buffer_field_arguments(obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\r\n(obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_SMBUS\r\n|| obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GSBUS\r\n|| obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_IPMI)) {\r\nif (obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_SMBUS) {\r\nlength = ACPI_SMBUS_BUFFER_SIZE;\r\nfunction =\r\nACPI_READ | (obj_desc->field.attribute << 16);\r\n} else if (obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GSBUS) {\r\naccessor_type = obj_desc->field.attribute;\r\nlength =\r\nacpi_ex_get_serial_access_length(accessor_type,\r\nobj_desc->field.\r\naccess_length);\r\nlength += 2;\r\nfunction = ACPI_READ | (accessor_type << 16);\r\n} else {\r\nlength = ACPI_IPMI_BUFFER_SIZE;\r\nfunction = ACPI_READ;\r\n}\r\nbuffer_desc = acpi_ut_create_buffer_object(length);\r\nif (!buffer_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus = acpi_ex_access_region(obj_desc, 0,\r\nACPI_CAST_PTR(u64,\r\nbuffer_desc->\r\nbuffer.pointer),\r\nfunction);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\ngoto exit;\r\n}\r\nlength =\r\n(acpi_size)ACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->field.bit_length);\r\nif (length > acpi_gbl_integer_byte_width) {\r\nbuffer_desc = acpi_ut_create_buffer_object(length);\r\nif (!buffer_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nbuffer = buffer_desc->buffer.pointer;\r\n} else {\r\nbuffer_desc = acpi_ut_create_integer_object((u64) 0);\r\nif (!buffer_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nlength = acpi_gbl_integer_byte_width;\r\nbuffer = &buffer_desc->integer.value;\r\n}\r\nif ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\r\n(obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GPIO)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"GPIO FieldRead [FROM]: Pin %u Bits %u\n",\r\nobj_desc->field.pin_number_index,\r\nobj_desc->field.bit_length));\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus =\r\nacpi_ex_access_region(obj_desc, 0, (u64 *)buffer,\r\nACPI_READ);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_remove_reference(buffer_desc);\r\n} else {\r\n*ret_buffer_desc = buffer_desc;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"FieldRead [TO]: Obj %p, Type %X, Buf %p, ByteLen %X\n",\r\nobj_desc, obj_desc->common.type, buffer,\r\n(u32) length));\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"FieldRead [FROM]: BitLen %X, BitOff %X, ByteOff %X\n",\r\nobj_desc->common_field.bit_length,\r\nobj_desc->common_field.start_field_bit_offset,\r\nobj_desc->common_field.base_byte_offset));\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus = acpi_ex_extract_from_field(obj_desc, buffer, (u32) length);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\nexit:\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_remove_reference(buffer_desc);\r\n} else {\r\n*ret_buffer_desc = buffer_desc;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ex_write_data_to_field(union acpi_operand_object *source_desc,\r\nunion acpi_operand_object *obj_desc,\r\nunion acpi_operand_object **result_desc)\r\n{\r\nacpi_status status;\r\nu32 length;\r\nvoid *buffer;\r\nunion acpi_operand_object *buffer_desc;\r\nu32 function;\r\nu16 accessor_type;\r\nACPI_FUNCTION_TRACE_PTR(ex_write_data_to_field, obj_desc);\r\nif (!source_desc || !obj_desc) {\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\r\nif (!(obj_desc->common.flags & AOPOBJ_DATA_VALID)) {\r\nstatus = acpi_ds_get_buffer_field_arguments(obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\r\n(obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_SMBUS\r\n|| obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GSBUS\r\n|| obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_IPMI)) {\r\nif (source_desc->common.type != ACPI_TYPE_BUFFER) {\r\nACPI_ERROR((AE_INFO,\r\n"SMBus/IPMI/GenericSerialBus write requires "\r\n"Buffer, found type %s",\r\nacpi_ut_get_object_type_name(source_desc)));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nif (obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_SMBUS) {\r\nlength = ACPI_SMBUS_BUFFER_SIZE;\r\nfunction =\r\nACPI_WRITE | (obj_desc->field.attribute << 16);\r\n} else if (obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GSBUS) {\r\naccessor_type = obj_desc->field.attribute;\r\nlength =\r\nacpi_ex_get_serial_access_length(accessor_type,\r\nobj_desc->field.\r\naccess_length);\r\nlength += 2;\r\nfunction = ACPI_WRITE | (accessor_type << 16);\r\n} else {\r\nlength = ACPI_IPMI_BUFFER_SIZE;\r\nfunction = ACPI_WRITE;\r\n}\r\nif (source_desc->buffer.length < length) {\r\nACPI_ERROR((AE_INFO,\r\n"SMBus/IPMI/GenericSerialBus write requires "\r\n"Buffer of length %u, found length %u",\r\nlength, source_desc->buffer.length));\r\nreturn_ACPI_STATUS(AE_AML_BUFFER_LIMIT);\r\n}\r\nbuffer_desc = acpi_ut_create_buffer_object(length);\r\nif (!buffer_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nbuffer = buffer_desc->buffer.pointer;\r\nmemcpy(buffer, source_desc->buffer.pointer, length);\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus =\r\nacpi_ex_access_region(obj_desc, 0, (u64 *)buffer, function);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\n*result_desc = buffer_desc;\r\nreturn_ACPI_STATUS(status);\r\n} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\r\n(obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_GPIO)) {\r\nif (source_desc->common.type != ACPI_TYPE_INTEGER) {\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"GPIO FieldWrite [FROM]: (%s:%X), Val %.8X [TO]: Pin %u Bits %u\n",\r\nacpi_ut_get_type_name(source_desc->common.\r\ntype),\r\nsource_desc->common.type,\r\n(u32)source_desc->integer.value,\r\nobj_desc->field.pin_number_index,\r\nobj_desc->field.bit_length));\r\nbuffer = &source_desc->integer.value;\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus =\r\nacpi_ex_access_region(obj_desc, 0, (u64 *)buffer,\r\nACPI_WRITE);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nswitch (source_desc->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\nbuffer = &source_desc->integer.value;\r\nlength = sizeof(source_desc->integer.value);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nbuffer = source_desc->buffer.pointer;\r\nlength = source_desc->buffer.length;\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nbuffer = source_desc->string.pointer;\r\nlength = source_desc->string.length;\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"FieldWrite [FROM]: Obj %p (%s:%X), Buf %p, ByteLen %X\n",\r\nsource_desc,\r\nacpi_ut_get_type_name(source_desc->common.type),\r\nsource_desc->common.type, buffer, length));\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"FieldWrite [TO]: Obj %p (%s:%X), BitLen %X, BitOff %X, ByteOff %X\n",\r\nobj_desc,\r\nacpi_ut_get_type_name(obj_desc->common.type),\r\nobj_desc->common.type,\r\nobj_desc->common_field.bit_length,\r\nobj_desc->common_field.start_field_bit_offset,\r\nobj_desc->common_field.base_byte_offset));\r\nacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\r\nstatus = acpi_ex_insert_into_field(obj_desc, buffer, length);\r\nacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\r\nreturn_ACPI_STATUS(status);\r\n}

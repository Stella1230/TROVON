static int wm831x_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct wm831x *wm831x = driver_data->wm831x;\r\nint ret;\r\nmutex_lock(&driver_data->lock);\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_ENA, WM831X_WDOG_ENA);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nmutex_unlock(&driver_data->lock);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct wm831x *wm831x = driver_data->wm831x;\r\nint ret;\r\nmutex_lock(&driver_data->lock);\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_ENA, 0);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nmutex_unlock(&driver_data->lock);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct wm831x *wm831x = driver_data->wm831x;\r\nint ret;\r\nu16 reg;\r\nmutex_lock(&driver_data->lock);\r\nif (driver_data->update_gpio) {\r\ngpio_set_value_cansleep(driver_data->update_gpio,\r\ndriver_data->update_state);\r\ndriver_data->update_state = !driver_data->update_state;\r\nret = 0;\r\ngoto out;\r\n}\r\nreg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nif (!(reg & WM831X_WDOG_RST_SRC)) {\r\ndev_err(wm831x->dev, "Hardware watchdog update unsupported\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nreg |= WM831X_WDOG_RESET;\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nout:\r\nmutex_unlock(&driver_data->lock);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct wm831x *wm831x = driver_data->wm831x;\r\nint ret, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\r\nif (wm831x_wdt_cfgs[i].time == timeout)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm831x_wdt_cfgs))\r\nreturn -EINVAL;\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_TO_MASK,\r\nwm831x_wdt_cfgs[i].val);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nwdt_dev->timeout = timeout;\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *chip_pdata = dev_get_platdata(pdev->dev.parent);\r\nstruct wm831x_watchdog_pdata *pdata;\r\nstruct wm831x_wdt_drvdata *driver_data;\r\nstruct watchdog_device *wm831x_wdt;\r\nint reg, ret, i;\r\nret = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read watchdog status: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreg = ret;\r\nif (reg & WM831X_WDOG_DEBUG)\r\ndev_warn(wm831x->dev, "Watchdog is paused\n");\r\ndriver_data = devm_kzalloc(&pdev->dev, sizeof(*driver_data),\r\nGFP_KERNEL);\r\nif (!driver_data)\r\nreturn -ENOMEM;\r\nmutex_init(&driver_data->lock);\r\ndriver_data->wm831x = wm831x;\r\nwm831x_wdt = &driver_data->wdt;\r\nwm831x_wdt->info = &wm831x_wdt_info;\r\nwm831x_wdt->ops = &wm831x_wdt_ops;\r\nwm831x_wdt->parent = &pdev->dev;\r\nwatchdog_set_nowayout(wm831x_wdt, nowayout);\r\nwatchdog_set_drvdata(wm831x_wdt, driver_data);\r\nreg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nreg &= WM831X_WDOG_TO_MASK;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\r\nif (wm831x_wdt_cfgs[i].val == reg)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm831x_wdt_cfgs))\r\ndev_warn(wm831x->dev,\r\n"Unknown watchdog timeout: %x\n", reg);\r\nelse\r\nwm831x_wdt->timeout = wm831x_wdt_cfgs[i].time;\r\nif (chip_pdata)\r\npdata = chip_pdata->watchdog;\r\nelse\r\npdata = NULL;\r\nif (pdata) {\r\nreg &= ~(WM831X_WDOG_SECACT_MASK | WM831X_WDOG_PRIMACT_MASK |\r\nWM831X_WDOG_RST_SRC);\r\nreg |= pdata->primary << WM831X_WDOG_PRIMACT_SHIFT;\r\nreg |= pdata->secondary << WM831X_WDOG_SECACT_SHIFT;\r\nreg |= pdata->software << WM831X_WDOG_RST_SRC_SHIFT;\r\nif (pdata->update_gpio) {\r\nret = devm_gpio_request_one(&pdev->dev,\r\npdata->update_gpio,\r\nGPIOF_OUT_INIT_LOW,\r\n"Watchdog update");\r\nif (ret < 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to request update GPIO: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\ndriver_data->update_gpio = pdata->update_gpio;\r\nreg |= WM831X_WDOG_RST_SRC;\r\n}\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev,\r\n"Failed to unlock security key: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = devm_watchdog_register_device(&pdev->dev, &driver_data->wdt);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "watchdog_register_device() failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

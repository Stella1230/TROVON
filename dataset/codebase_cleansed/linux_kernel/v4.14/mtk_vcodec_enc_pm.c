int mtk_vcodec_init_enc_pm(struct mtk_vcodec_dev *mtkdev)\r\n{\r\nstruct device_node *node;\r\nstruct platform_device *pdev;\r\nstruct device *dev;\r\nstruct mtk_vcodec_pm *pm;\r\nint ret = 0;\r\npdev = mtkdev->plat_dev;\r\npm = &mtkdev->pm;\r\nmemset(pm, 0, sizeof(struct mtk_vcodec_pm));\r\npm->mtkdev = mtkdev;\r\npm->dev = &pdev->dev;\r\ndev = &pdev->dev;\r\nnode = of_parse_phandle(dev->of_node, "mediatek,larb", 0);\r\nif (!node) {\r\nmtk_v4l2_err("no mediatek,larb found");\r\nreturn -1;\r\n}\r\npdev = of_find_device_by_node(node);\r\nif (!pdev) {\r\nmtk_v4l2_err("no mediatek,larb device found");\r\nreturn -1;\r\n}\r\npm->larbvenc = &pdev->dev;\r\nnode = of_parse_phandle(dev->of_node, "mediatek,larb", 1);\r\nif (!node) {\r\nmtk_v4l2_err("no mediatek,larb found");\r\nreturn -1;\r\n}\r\npdev = of_find_device_by_node(node);\r\nif (!pdev) {\r\nmtk_v4l2_err("no mediatek,larb device found");\r\nreturn -1;\r\n}\r\npm->larbvenclt = &pdev->dev;\r\npdev = mtkdev->plat_dev;\r\npm->dev = &pdev->dev;\r\npm->vencpll_d2 = devm_clk_get(&pdev->dev, "venc_sel_src");\r\nif (IS_ERR(pm->vencpll_d2)) {\r\nmtk_v4l2_err("devm_clk_get vencpll_d2 fail");\r\nret = PTR_ERR(pm->vencpll_d2);\r\n}\r\npm->venc_sel = devm_clk_get(&pdev->dev, "venc_sel");\r\nif (IS_ERR(pm->venc_sel)) {\r\nmtk_v4l2_err("devm_clk_get venc_sel fail");\r\nret = PTR_ERR(pm->venc_sel);\r\n}\r\npm->univpll1_d2 = devm_clk_get(&pdev->dev, "venc_lt_sel_src");\r\nif (IS_ERR(pm->univpll1_d2)) {\r\nmtk_v4l2_err("devm_clk_get univpll1_d2 fail");\r\nret = PTR_ERR(pm->univpll1_d2);\r\n}\r\npm->venc_lt_sel = devm_clk_get(&pdev->dev, "venc_lt_sel");\r\nif (IS_ERR(pm->venc_lt_sel)) {\r\nmtk_v4l2_err("devm_clk_get venc_lt_sel fail");\r\nret = PTR_ERR(pm->venc_lt_sel);\r\n}\r\nreturn ret;\r\n}\r\nvoid mtk_vcodec_release_enc_pm(struct mtk_vcodec_dev *mtkdev)\r\n{\r\n}\r\nvoid mtk_vcodec_enc_clock_on(struct mtk_vcodec_pm *pm)\r\n{\r\nint ret;\r\nret = clk_prepare_enable(pm->venc_sel);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable fail %d", ret);\r\nret = clk_set_parent(pm->venc_sel, pm->vencpll_d2);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_parent fail %d", ret);\r\nret = clk_prepare_enable(pm->venc_lt_sel);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable fail %d", ret);\r\nret = clk_set_parent(pm->venc_lt_sel, pm->univpll1_d2);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_parent fail %d", ret);\r\nret = mtk_smi_larb_get(pm->larbvenc);\r\nif (ret)\r\nmtk_v4l2_err("mtk_smi_larb_get larb3 fail %d", ret);\r\nret = mtk_smi_larb_get(pm->larbvenclt);\r\nif (ret)\r\nmtk_v4l2_err("mtk_smi_larb_get larb4 fail %d", ret);\r\n}\r\nvoid mtk_vcodec_enc_clock_off(struct mtk_vcodec_pm *pm)\r\n{\r\nmtk_smi_larb_put(pm->larbvenc);\r\nmtk_smi_larb_put(pm->larbvenclt);\r\nclk_disable_unprepare(pm->venc_lt_sel);\r\nclk_disable_unprepare(pm->venc_sel);\r\n}

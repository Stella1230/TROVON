static u16 crct10dif_vpmsum(u16 crci, unsigned char const *p, size_t len)\r\n{\r\nunsigned int prealign;\r\nunsigned int tail;\r\nu32 crc = crci;\r\nif (len < (VECTOR_BREAKPOINT + VMX_ALIGN) || in_interrupt())\r\nreturn crc_t10dif_generic(crc, p, len);\r\nif ((unsigned long)p & VMX_ALIGN_MASK) {\r\nprealign = VMX_ALIGN - ((unsigned long)p & VMX_ALIGN_MASK);\r\ncrc = crc_t10dif_generic(crc, p, prealign);\r\nlen -= prealign;\r\np += prealign;\r\n}\r\nif (len & ~VMX_ALIGN_MASK) {\r\ncrc <<= 16;\r\npreempt_disable();\r\npagefault_disable();\r\nenable_kernel_altivec();\r\ncrc = __crct10dif_vpmsum(crc, p, len & ~VMX_ALIGN_MASK);\r\ndisable_kernel_altivec();\r\npagefault_enable();\r\npreempt_enable();\r\ncrc >>= 16;\r\n}\r\ntail = len & VMX_ALIGN_MASK;\r\nif (tail) {\r\np += len & ~VMX_ALIGN_MASK;\r\ncrc = crc_t10dif_generic(crc, p, tail);\r\n}\r\nreturn crc & 0xffff;\r\n}\r\nstatic int crct10dif_vpmsum_init(struct shash_desc *desc)\r\n{\r\nu16 *crc = shash_desc_ctx(desc);\r\n*crc = 0;\r\nreturn 0;\r\n}\r\nstatic int crct10dif_vpmsum_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int length)\r\n{\r\nu16 *crc = shash_desc_ctx(desc);\r\n*crc = crct10dif_vpmsum(*crc, data, length);\r\nreturn 0;\r\n}\r\nstatic int crct10dif_vpmsum_final(struct shash_desc *desc, u8 *out)\r\n{\r\nu16 *crcp = shash_desc_ctx(desc);\r\n*(u16 *)out = *crcp;\r\nreturn 0;\r\n}\r\nstatic int __init crct10dif_vpmsum_mod_init(void)\r\n{\r\nif (!cpu_has_feature(CPU_FTR_ARCH_207S))\r\nreturn -ENODEV;\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit crct10dif_vpmsum_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

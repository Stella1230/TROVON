long arch_prctl(struct task_struct *task, int option,\r\nunsigned long __user *arg2)\r\n{\r\nunsigned long *ptr = arg2, tmp;\r\nlong ret;\r\nint pid = task->mm->context.id.u.pid;\r\nswitch (option) {\r\ncase ARCH_SET_FS:\r\ncase ARCH_SET_GS:\r\nret = restore_registers(pid, &current->thread.regs.regs);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase ARCH_GET_FS:\r\ncase ARCH_GET_GS:\r\nptr = &tmp;\r\n}\r\nret = os_arch_prctl(pid, option, ptr);\r\nif (ret)\r\nreturn ret;\r\nswitch (option) {\r\ncase ARCH_SET_FS:\r\ncurrent->thread.arch.fs = (unsigned long) ptr;\r\nret = save_registers(pid, &current->thread.regs.regs);\r\nbreak;\r\ncase ARCH_SET_GS:\r\nret = save_registers(pid, &current->thread.regs.regs);\r\nbreak;\r\ncase ARCH_GET_FS:\r\nret = put_user(tmp, arg2);\r\nbreak;\r\ncase ARCH_GET_GS:\r\nret = put_user(tmp, arg2);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nvoid arch_switch_to(struct task_struct *to)\r\n{\r\nif ((to->thread.arch.fs == 0) || (to->mm == NULL))\r\nreturn;\r\narch_prctl(to, ARCH_SET_FS, (void __user *) to->thread.arch.fs);\r\n}

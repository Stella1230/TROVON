int gpiotools_request_linehandle(const char *device_name, unsigned int *lines,\r\nunsigned int nlines, unsigned int flag,\r\nstruct gpiohandle_data *data,\r\nconst char *consumer_label)\r\n{\r\nstruct gpiohandle_request req;\r\nchar *chrdev_name;\r\nint fd;\r\nint i;\r\nint ret;\r\nret = asprintf(&chrdev_name, "/dev/%s", device_name);\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\nfd = open(chrdev_name, 0);\r\nif (fd == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to open %s\n", chrdev_name);\r\ngoto exit_close_error;\r\n}\r\nfor (i = 0; i < nlines; i++)\r\nreq.lineoffsets[i] = lines[i];\r\nreq.flags = flag;\r\nstrcpy(req.consumer_label, consumer_label);\r\nreq.lines = nlines;\r\nif (flag & GPIOHANDLE_REQUEST_OUTPUT)\r\nmemcpy(req.default_values, data, sizeof(req.default_values));\r\nret = ioctl(fd, GPIO_GET_LINEHANDLE_IOCTL, &req);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue GET LINEHANDLE IOCTL (%d)\n",\r\nret);\r\n}\r\nexit_close_error:\r\nif (close(fd) == -1)\r\nperror("Failed to close GPIO character device file");\r\nfree(chrdev_name);\r\nreturn ret < 0 ? ret : req.fd;\r\n}\r\nint gpiotools_set_values(const int fd, struct gpiohandle_data *data)\r\n{\r\nint ret;\r\nret = ioctl(fd, GPIOHANDLE_SET_LINE_VALUES_IOCTL, data);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue %s (%d)\n",\r\n"GPIOHANDLE_SET_LINE_VALUES_IOCTL", ret);\r\n}\r\nreturn ret;\r\n}\r\nint gpiotools_get_values(const int fd, struct gpiohandle_data *data)\r\n{\r\nint ret;\r\nret = ioctl(fd, GPIOHANDLE_GET_LINE_VALUES_IOCTL, data);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue %s (%d)\n",\r\n"GPIOHANDLE_GET_LINE_VALUES_IOCTL", ret);\r\n}\r\nreturn ret;\r\n}\r\nint gpiotools_release_linehandle(const int fd)\r\n{\r\nint ret;\r\nret = close(fd);\r\nif (ret == -1) {\r\nperror("Failed to close GPIO LINEHANDLE device file");\r\nret = -errno;\r\n}\r\nreturn ret;\r\n}\r\nint gpiotools_get(const char *device_name, unsigned int line)\r\n{\r\nstruct gpiohandle_data data;\r\nunsigned int lines[] = {line};\r\ngpiotools_gets(device_name, lines, 1, &data);\r\nreturn data.values[0];\r\n}\r\nint gpiotools_gets(const char *device_name, unsigned int *lines,\r\nunsigned int nlines, struct gpiohandle_data *data)\r\n{\r\nint fd;\r\nint ret;\r\nint ret_close;\r\nret = gpiotools_request_linehandle(device_name, lines, nlines,\r\nGPIOHANDLE_REQUEST_INPUT, data,\r\nCOMSUMER);\r\nif (ret < 0)\r\nreturn ret;\r\nfd = ret;\r\nret = gpiotools_get_values(fd, data);\r\nret_close = gpiotools_release_linehandle(fd);\r\nreturn ret < 0 ? ret : ret_close;\r\n}\r\nint gpiotools_set(const char *device_name, unsigned int line,\r\nunsigned int value)\r\n{\r\nstruct gpiohandle_data data;\r\nunsigned int lines[] = {line};\r\ndata.values[0] = value;\r\nreturn gpiotools_sets(device_name, lines, 1, &data);\r\n}\r\nint gpiotools_sets(const char *device_name, unsigned int *lines,\r\nunsigned int nlines, struct gpiohandle_data *data)\r\n{\r\nint ret;\r\nret = gpiotools_request_linehandle(device_name, lines, nlines,\r\nGPIOHANDLE_REQUEST_OUTPUT, data,\r\nCOMSUMER);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn gpiotools_release_linehandle(ret);\r\n}

void sst_shim32_write(void __iomem *addr, u32 offset, u32 value)\r\n{\r\nwritel(value, addr + offset);\r\n}\r\nu32 sst_shim32_read(void __iomem *addr, u32 offset)\r\n{\r\nreturn readl(addr + offset);\r\n}\r\nvoid sst_shim32_write64(void __iomem *addr, u32 offset, u64 value)\r\n{\r\nmemcpy_toio(addr + offset, &value, sizeof(value));\r\n}\r\nu64 sst_shim32_read64(void __iomem *addr, u32 offset)\r\n{\r\nu64 val;\r\nmemcpy_fromio(&val, addr + offset, sizeof(val));\r\nreturn val;\r\n}\r\nstatic inline void _sst_memcpy_toio_32(volatile u32 __iomem *dest,\r\nu32 *src, size_t bytes)\r\n{\r\nint i, words = bytes >> 2;\r\nfor (i = 0; i < words; i++)\r\nwritel(src[i], dest + i);\r\n}\r\nstatic inline void _sst_memcpy_fromio_32(u32 *dest,\r\nconst volatile __iomem u32 *src, size_t bytes)\r\n{\r\nint i, words = bytes >> 2;\r\nfor (i = 0; i < words; i++)\r\ndest[i] = readl(src + i);\r\n}\r\nvoid sst_memcpy_toio_32(struct sst_dsp *sst,\r\nvoid __iomem *dest, void *src, size_t bytes)\r\n{\r\n_sst_memcpy_toio_32(dest, src, bytes);\r\n}\r\nvoid sst_memcpy_fromio_32(struct sst_dsp *sst, void *dest,\r\nvoid __iomem *src, size_t bytes)\r\n{\r\n_sst_memcpy_fromio_32(dest, src, bytes);\r\n}\r\nvoid sst_dsp_shim_write(struct sst_dsp *sst, u32 offset, u32 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nsst->ops->write(sst->addr.shim, offset, value);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\n}\r\nu32 sst_dsp_shim_read(struct sst_dsp *sst, u32 offset)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nval = sst->ops->read(sst->addr.shim, offset);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\nreturn val;\r\n}\r\nvoid sst_dsp_shim_write64(struct sst_dsp *sst, u32 offset, u64 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nsst->ops->write64(sst->addr.shim, offset, value);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\n}\r\nu64 sst_dsp_shim_read64(struct sst_dsp *sst, u32 offset)\r\n{\r\nunsigned long flags;\r\nu64 val;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nval = sst->ops->read64(sst->addr.shim, offset);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\nreturn val;\r\n}\r\nvoid sst_dsp_shim_write_unlocked(struct sst_dsp *sst, u32 offset, u32 value)\r\n{\r\nsst->ops->write(sst->addr.shim, offset, value);\r\n}\r\nu32 sst_dsp_shim_read_unlocked(struct sst_dsp *sst, u32 offset)\r\n{\r\nreturn sst->ops->read(sst->addr.shim, offset);\r\n}\r\nvoid sst_dsp_shim_write64_unlocked(struct sst_dsp *sst, u32 offset, u64 value)\r\n{\r\nsst->ops->write64(sst->addr.shim, offset, value);\r\n}\r\nu64 sst_dsp_shim_read64_unlocked(struct sst_dsp *sst, u32 offset)\r\n{\r\nreturn sst->ops->read64(sst->addr.shim, offset);\r\n}\r\nint sst_dsp_shim_update_bits_unlocked(struct sst_dsp *sst, u32 offset,\r\nu32 mask, u32 value)\r\n{\r\nbool change;\r\nunsigned int old, new;\r\nu32 ret;\r\nret = sst_dsp_shim_read_unlocked(sst, offset);\r\nold = ret;\r\nnew = (old & (~mask)) | (value & mask);\r\nchange = (old != new);\r\nif (change)\r\nsst_dsp_shim_write_unlocked(sst, offset, new);\r\nreturn change;\r\n}\r\nint sst_dsp_shim_update_bits64_unlocked(struct sst_dsp *sst, u32 offset,\r\nu64 mask, u64 value)\r\n{\r\nbool change;\r\nu64 old, new;\r\nold = sst_dsp_shim_read64_unlocked(sst, offset);\r\nnew = (old & (~mask)) | (value & mask);\r\nchange = (old != new);\r\nif (change)\r\nsst_dsp_shim_write64_unlocked(sst, offset, new);\r\nreturn change;\r\n}\r\nvoid sst_dsp_shim_update_bits_forced_unlocked(struct sst_dsp *sst, u32 offset,\r\nu32 mask, u32 value)\r\n{\r\nunsigned int old, new;\r\nu32 ret;\r\nret = sst_dsp_shim_read_unlocked(sst, offset);\r\nold = ret;\r\nnew = (old & (~mask)) | (value & mask);\r\nsst_dsp_shim_write_unlocked(sst, offset, new);\r\n}\r\nint sst_dsp_shim_update_bits(struct sst_dsp *sst, u32 offset,\r\nu32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nbool change;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nchange = sst_dsp_shim_update_bits_unlocked(sst, offset, mask, value);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\nreturn change;\r\n}\r\nint sst_dsp_shim_update_bits64(struct sst_dsp *sst, u32 offset,\r\nu64 mask, u64 value)\r\n{\r\nunsigned long flags;\r\nbool change;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nchange = sst_dsp_shim_update_bits64_unlocked(sst, offset, mask, value);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\nreturn change;\r\n}\r\nvoid sst_dsp_shim_update_bits_forced(struct sst_dsp *sst, u32 offset,\r\nu32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sst->spinlock, flags);\r\nsst_dsp_shim_update_bits_forced_unlocked(sst, offset, mask, value);\r\nspin_unlock_irqrestore(&sst->spinlock, flags);\r\n}\r\nint sst_dsp_register_poll(struct sst_dsp *ctx, u32 offset, u32 mask,\r\nu32 target, u32 time, char *operation)\r\n{\r\nu32 reg;\r\nunsigned long timeout;\r\nint k = 0, s = 500;\r\ntimeout = jiffies + msecs_to_jiffies(time);\r\nwhile (((sst_dsp_shim_read_unlocked(ctx, offset) & mask) != target)\r\n&& time_before(jiffies, timeout)) {\r\nk++;\r\nif (k > 10)\r\ns = 5000;\r\nusleep_range(s, 2*s);\r\n}\r\nreg = sst_dsp_shim_read_unlocked(ctx, offset);\r\nif ((reg & mask) == target) {\r\ndev_dbg(ctx->dev, "FW Poll Status: reg=%#x %s successful\n",\r\nreg, operation);\r\nreturn 0;\r\n}\r\ndev_dbg(ctx->dev, "FW Poll Status: reg=%#x %s timedout\n",\r\nreg, operation);\r\nreturn -ETIME;\r\n}\r\nvoid sst_dsp_dump(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->dump)\r\nsst->ops->dump(sst);\r\n}\r\nvoid sst_dsp_reset(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->reset)\r\nsst->ops->reset(sst);\r\n}\r\nint sst_dsp_boot(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->boot)\r\nsst->ops->boot(sst);\r\nreturn 0;\r\n}\r\nint sst_dsp_wake(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->wake)\r\nreturn sst->ops->wake(sst);\r\nreturn 0;\r\n}\r\nvoid sst_dsp_sleep(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->sleep)\r\nsst->ops->sleep(sst);\r\n}\r\nvoid sst_dsp_stall(struct sst_dsp *sst)\r\n{\r\nif (sst->ops->stall)\r\nsst->ops->stall(sst);\r\n}\r\nvoid sst_dsp_ipc_msg_tx(struct sst_dsp *dsp, u32 msg)\r\n{\r\nsst_dsp_shim_write_unlocked(dsp, SST_IPCX, msg | SST_IPCX_BUSY);\r\ntrace_sst_ipc_msg_tx(msg);\r\n}\r\nu32 sst_dsp_ipc_msg_rx(struct sst_dsp *dsp)\r\n{\r\nu32 msg;\r\nmsg = sst_dsp_shim_read_unlocked(dsp, SST_IPCX);\r\ntrace_sst_ipc_msg_rx(msg);\r\nreturn msg;\r\n}\r\nint sst_dsp_mailbox_init(struct sst_dsp *sst, u32 inbox_offset, size_t inbox_size,\r\nu32 outbox_offset, size_t outbox_size)\r\n{\r\nsst->mailbox.in_base = sst->addr.lpe + inbox_offset;\r\nsst->mailbox.out_base = sst->addr.lpe + outbox_offset;\r\nsst->mailbox.in_size = inbox_size;\r\nsst->mailbox.out_size = outbox_size;\r\nreturn 0;\r\n}\r\nvoid sst_dsp_outbox_write(struct sst_dsp *sst, void *message, size_t bytes)\r\n{\r\nu32 i;\r\ntrace_sst_ipc_outbox_write(bytes);\r\nmemcpy_toio(sst->mailbox.out_base, message, bytes);\r\nfor (i = 0; i < bytes; i += 4)\r\ntrace_sst_ipc_outbox_wdata(i, *(u32 *)(message + i));\r\n}\r\nvoid sst_dsp_outbox_read(struct sst_dsp *sst, void *message, size_t bytes)\r\n{\r\nu32 i;\r\ntrace_sst_ipc_outbox_read(bytes);\r\nmemcpy_fromio(message, sst->mailbox.out_base, bytes);\r\nfor (i = 0; i < bytes; i += 4)\r\ntrace_sst_ipc_outbox_rdata(i, *(u32 *)(message + i));\r\n}\r\nvoid sst_dsp_inbox_write(struct sst_dsp *sst, void *message, size_t bytes)\r\n{\r\nu32 i;\r\ntrace_sst_ipc_inbox_write(bytes);\r\nmemcpy_toio(sst->mailbox.in_base, message, bytes);\r\nfor (i = 0; i < bytes; i += 4)\r\ntrace_sst_ipc_inbox_wdata(i, *(u32 *)(message + i));\r\n}\r\nvoid sst_dsp_inbox_read(struct sst_dsp *sst, void *message, size_t bytes)\r\n{\r\nu32 i;\r\ntrace_sst_ipc_inbox_read(bytes);\r\nmemcpy_fromio(message, sst->mailbox.in_base, bytes);\r\nfor (i = 0; i < bytes; i += 4)\r\ntrace_sst_ipc_inbox_rdata(i, *(u32 *)(message + i));\r\n}

static struct sch5636_data *sch5636_update_device(struct device *dev)\r\n{\r\nstruct sch5636_data *data = dev_get_drvdata(dev);\r\nstruct sch5636_data *ret = data;\r\nint i, val;\r\nmutex_lock(&data->update_lock);\r\nif (data->valid && !time_after(jiffies, data->last_updated + HZ))\r\ngoto abort;\r\nfor (i = 0; i < SCH5636_NO_INS; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_IN_VAL[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->in[i] = val;\r\n}\r\nfor (i = 0; i < SCH5636_NO_TEMPS; i++) {\r\nif (data->temp_ctrl[i] & SCH5636_TEMP_DEACTIVATED)\r\ncontinue;\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_TEMP_VAL[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->temp_val[i] = val;\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_TEMP_CTRL(i));\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->temp_ctrl[i] = val;\r\nif (val & SCH5636_TEMP_ALARM) {\r\nsch56xx_write_virtual_reg(data->addr,\r\nSCH5636_REG_TEMP_CTRL(i), val);\r\n}\r\n}\r\nfor (i = 0; i < SCH5636_NO_FANS; i++) {\r\nif (data->fan_ctrl[i] & SCH5636_FAN_DEACTIVATED)\r\ncontinue;\r\nval = sch56xx_read_virtual_reg16(data->addr,\r\nSCH5636_REG_FAN_VAL[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->fan_val[i] = val;\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_FAN_CTRL(i));\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->fan_ctrl[i] = val;\r\nif (val & SCH5636_FAN_ALARM) {\r\nsch56xx_write_virtual_reg(data->addr,\r\nSCH5636_REG_FAN_CTRL(i), val);\r\n}\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int reg_to_rpm(u16 reg)\r\n{\r\nif (reg == 0)\r\nreturn -EIO;\r\nif (reg == 0xffff)\r\nreturn 0;\r\nreturn 5400540 / reg;\r\n}\r\nstatic ssize_t show_name(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", DEVNAME);\r\n}\r\nstatic ssize_t show_in_value(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = DIV_ROUND_CLOSEST(\r\ndata->in[attr->index] * SCH5636_REG_IN_FACTORS[attr->index],\r\n255);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_in_label(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n",\r\nSCH5636_IN_LABELS[attr->index]);\r\n}\r\nstatic ssize_t show_temp_value(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = (data->temp_val[attr->index] - 64) * 1000;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_temp_fault(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = (data->temp_ctrl[attr->index] & SCH5636_TEMP_WORKING) ? 0 : 1;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_temp_alarm(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = (data->temp_ctrl[attr->index] & SCH5636_TEMP_ALARM) ? 1 : 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_fan_value(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = reg_to_rpm(data->fan_val[attr->index]);\r\nif (val < 0)\r\nreturn val;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_fan_fault(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = (data->fan_ctrl[attr->index] & SCH5636_FAN_NOT_PRESENT) ? 1 : 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_fan_alarm(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5636_data *data = sch5636_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = (data->fan_ctrl[attr->index] & SCH5636_FAN_ALARM) ? 1 : 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic int sch5636_remove(struct platform_device *pdev)\r\n{\r\nstruct sch5636_data *data = platform_get_drvdata(pdev);\r\nint i;\r\nif (data->watchdog)\r\nsch56xx_watchdog_unregister(data->watchdog);\r\nif (data->hwmon_dev)\r\nhwmon_device_unregister(data->hwmon_dev);\r\nfor (i = 0; i < ARRAY_SIZE(sch5636_attr); i++)\r\ndevice_remove_file(&pdev->dev, &sch5636_attr[i].dev_attr);\r\nfor (i = 0; i < SCH5636_NO_TEMPS * 3; i++)\r\ndevice_remove_file(&pdev->dev,\r\n&sch5636_temp_attr[i].dev_attr);\r\nfor (i = 0; i < SCH5636_NO_FANS * 3; i++)\r\ndevice_remove_file(&pdev->dev,\r\n&sch5636_fan_attr[i].dev_attr);\r\nreturn 0;\r\n}\r\nstatic int sch5636_probe(struct platform_device *pdev)\r\n{\r\nstruct sch5636_data *data;\r\nint i, err, val, revision[2];\r\nchar id[4];\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct sch5636_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->addr = platform_get_resource(pdev, IORESOURCE_IO, 0)->start;\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\nfor (i = 0; i < 3; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_FUJITSU_ID + i);\r\nif (val < 0) {\r\npr_err("Could not read Fujitsu id byte at %#x\n",\r\nSCH5636_REG_FUJITSU_ID + i);\r\nerr = val;\r\ngoto error;\r\n}\r\nid[i] = val;\r\n}\r\nid[i] = '\0';\r\nif (strcmp(id, "THS")) {\r\npr_err("Unknown Fujitsu id: %02x%02x%02x\n",\r\nid[0], id[1], id[2]);\r\nerr = -ENODEV;\r\ngoto error;\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_FUJITSU_REV + i);\r\nif (val < 0) {\r\nerr = val;\r\ngoto error;\r\n}\r\nrevision[i] = val;\r\n}\r\npr_info("Found %s chip at %#hx, revision: %d.%02d\n", DEVNAME,\r\ndata->addr, revision[0], revision[1]);\r\nfor (i = 0; i < SCH5636_NO_TEMPS; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_TEMP_CTRL(i));\r\nif (unlikely(val < 0)) {\r\nerr = val;\r\ngoto error;\r\n}\r\ndata->temp_ctrl[i] = val;\r\n}\r\nfor (i = 0; i < SCH5636_NO_FANS; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5636_REG_FAN_CTRL(i));\r\nif (unlikely(val < 0)) {\r\nerr = val;\r\ngoto error;\r\n}\r\ndata->fan_ctrl[i] = val;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(sch5636_attr); i++) {\r\nerr = device_create_file(&pdev->dev,\r\n&sch5636_attr[i].dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\nfor (i = 0; i < (SCH5636_NO_TEMPS * 3); i++) {\r\nif (data->temp_ctrl[i/3] & SCH5636_TEMP_DEACTIVATED)\r\ncontinue;\r\nerr = device_create_file(&pdev->dev,\r\n&sch5636_temp_attr[i].dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\nfor (i = 0; i < (SCH5636_NO_FANS * 3); i++) {\r\nif (data->fan_ctrl[i/3] & SCH5636_FAN_DEACTIVATED)\r\ncontinue;\r\nerr = device_create_file(&pdev->dev,\r\n&sch5636_fan_attr[i].dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ndata->hwmon_dev = NULL;\r\ngoto error;\r\n}\r\ndata->watchdog = sch56xx_watchdog_register(&pdev->dev, data->addr,\r\n(revision[0] << 8) | revision[1],\r\n&data->update_lock, 0);\r\nreturn 0;\r\nerror:\r\nsch5636_remove(pdev);\r\nreturn err;\r\n}

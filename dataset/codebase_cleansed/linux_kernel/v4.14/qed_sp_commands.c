int qed_sp_init_request(struct qed_hwfn *p_hwfn,\r\nstruct qed_spq_entry **pp_ent,\r\nu8 cmd, u8 protocol, struct qed_sp_init_data *p_data)\r\n{\r\nu32 opaque_cid = p_data->opaque_fid << 16 | p_data->cid;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nint rc;\r\nif (!pp_ent)\r\nreturn -ENOMEM;\r\nrc = qed_spq_get_entry(p_hwfn, pp_ent);\r\nif (rc)\r\nreturn rc;\r\np_ent = *pp_ent;\r\np_ent->elem.hdr.cid = cpu_to_le32(opaque_cid);\r\np_ent->elem.hdr.cmd_id = cmd;\r\np_ent->elem.hdr.protocol_id = protocol;\r\np_ent->priority = QED_SPQ_PRIORITY_NORMAL;\r\np_ent->comp_mode = p_data->comp_mode;\r\np_ent->comp_done.done = 0;\r\nswitch (p_ent->comp_mode) {\r\ncase QED_SPQ_MODE_EBLOCK:\r\np_ent->comp_cb.cookie = &p_ent->comp_done;\r\nbreak;\r\ncase QED_SPQ_MODE_BLOCK:\r\nif (!p_data->p_comp_data)\r\nreturn -EINVAL;\r\np_ent->comp_cb.cookie = p_data->p_comp_data->cookie;\r\nbreak;\r\ncase QED_SPQ_MODE_CB:\r\nif (!p_data->p_comp_data)\r\np_ent->comp_cb.function = NULL;\r\nelse\r\np_ent->comp_cb = *p_data->p_comp_data;\r\nbreak;\r\ndefault:\r\nDP_NOTICE(p_hwfn, "Unknown SPQE completion mode %d\n",\r\np_ent->comp_mode);\r\nreturn -EINVAL;\r\n}\r\nDP_VERBOSE(p_hwfn, QED_MSG_SPQ,\r\n"Initialized: CID %08x cmd %02x protocol %02x data_addr %lu comp_mode [%s]\n",\r\nopaque_cid, cmd, protocol,\r\n(unsigned long)&p_ent->ramrod,\r\nD_TRINE(p_ent->comp_mode, QED_SPQ_MODE_EBLOCK,\r\nQED_SPQ_MODE_BLOCK, "MODE_EBLOCK", "MODE_BLOCK",\r\n"MODE_CB"));\r\nmemset(&p_ent->ramrod, 0, sizeof(p_ent->ramrod));\r\nreturn 0;\r\n}\r\nstatic enum tunnel_clss qed_tunn_clss_to_fw_clss(u8 type)\r\n{\r\nswitch (type) {\r\ncase QED_TUNN_CLSS_MAC_VLAN:\r\nreturn TUNNEL_CLSS_MAC_VLAN;\r\ncase QED_TUNN_CLSS_MAC_VNI:\r\nreturn TUNNEL_CLSS_MAC_VNI;\r\ncase QED_TUNN_CLSS_INNER_MAC_VLAN:\r\nreturn TUNNEL_CLSS_INNER_MAC_VLAN;\r\ncase QED_TUNN_CLSS_INNER_MAC_VNI:\r\nreturn TUNNEL_CLSS_INNER_MAC_VNI;\r\ncase QED_TUNN_CLSS_MAC_VLAN_DUAL_STAGE:\r\nreturn TUNNEL_CLSS_MAC_VLAN_DUAL_STAGE;\r\ndefault:\r\nreturn TUNNEL_CLSS_MAC_VLAN;\r\n}\r\n}\r\nstatic void\r\nqed_set_pf_update_tunn_mode(struct qed_tunnel_info *p_tun,\r\nstruct qed_tunnel_info *p_src, bool b_pf_start)\r\n{\r\nif (p_src->vxlan.b_update_mode || b_pf_start)\r\np_tun->vxlan.b_mode_enabled = p_src->vxlan.b_mode_enabled;\r\nif (p_src->l2_gre.b_update_mode || b_pf_start)\r\np_tun->l2_gre.b_mode_enabled = p_src->l2_gre.b_mode_enabled;\r\nif (p_src->ip_gre.b_update_mode || b_pf_start)\r\np_tun->ip_gre.b_mode_enabled = p_src->ip_gre.b_mode_enabled;\r\nif (p_src->l2_geneve.b_update_mode || b_pf_start)\r\np_tun->l2_geneve.b_mode_enabled =\r\np_src->l2_geneve.b_mode_enabled;\r\nif (p_src->ip_geneve.b_update_mode || b_pf_start)\r\np_tun->ip_geneve.b_mode_enabled =\r\np_src->ip_geneve.b_mode_enabled;\r\n}\r\nstatic void qed_set_tunn_cls_info(struct qed_tunnel_info *p_tun,\r\nstruct qed_tunnel_info *p_src)\r\n{\r\nenum tunnel_clss type;\r\np_tun->b_update_rx_cls = p_src->b_update_rx_cls;\r\np_tun->b_update_tx_cls = p_src->b_update_tx_cls;\r\ntype = qed_tunn_clss_to_fw_clss(p_src->vxlan.tun_cls);\r\np_tun->vxlan.tun_cls = type;\r\ntype = qed_tunn_clss_to_fw_clss(p_src->l2_gre.tun_cls);\r\np_tun->l2_gre.tun_cls = type;\r\ntype = qed_tunn_clss_to_fw_clss(p_src->ip_gre.tun_cls);\r\np_tun->ip_gre.tun_cls = type;\r\ntype = qed_tunn_clss_to_fw_clss(p_src->l2_geneve.tun_cls);\r\np_tun->l2_geneve.tun_cls = type;\r\ntype = qed_tunn_clss_to_fw_clss(p_src->ip_geneve.tun_cls);\r\np_tun->ip_geneve.tun_cls = type;\r\n}\r\nstatic void qed_set_tunn_ports(struct qed_tunnel_info *p_tun,\r\nstruct qed_tunnel_info *p_src)\r\n{\r\np_tun->geneve_port.b_update_port = p_src->geneve_port.b_update_port;\r\np_tun->vxlan_port.b_update_port = p_src->vxlan_port.b_update_port;\r\nif (p_src->geneve_port.b_update_port)\r\np_tun->geneve_port.port = p_src->geneve_port.port;\r\nif (p_src->vxlan_port.b_update_port)\r\np_tun->vxlan_port.port = p_src->vxlan_port.port;\r\n}\r\nstatic void\r\n__qed_set_ramrod_tunnel_param(u8 *p_tunn_cls,\r\nstruct qed_tunn_update_type *tun_type)\r\n{\r\n*p_tunn_cls = tun_type->tun_cls;\r\n}\r\nstatic void\r\nqed_set_ramrod_tunnel_param(u8 *p_tunn_cls,\r\nstruct qed_tunn_update_type *tun_type,\r\nu8 *p_update_port,\r\n__le16 *p_port,\r\nstruct qed_tunn_update_udp_port *p_udp_port)\r\n{\r\n__qed_set_ramrod_tunnel_param(p_tunn_cls, tun_type);\r\nif (p_udp_port->b_update_port) {\r\n*p_update_port = 1;\r\n*p_port = cpu_to_le16(p_udp_port->port);\r\n}\r\n}\r\nstatic void\r\nqed_tunn_set_pf_update_params(struct qed_hwfn *p_hwfn,\r\nstruct qed_tunnel_info *p_src,\r\nstruct pf_update_tunnel_config *p_tunn_cfg)\r\n{\r\nstruct qed_tunnel_info *p_tun = &p_hwfn->cdev->tunnel;\r\nqed_set_pf_update_tunn_mode(p_tun, p_src, false);\r\nqed_set_tunn_cls_info(p_tun, p_src);\r\nqed_set_tunn_ports(p_tun, p_src);\r\nqed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_vxlan,\r\n&p_tun->vxlan,\r\n&p_tunn_cfg->set_vxlan_udp_port_flg,\r\n&p_tunn_cfg->vxlan_udp_port,\r\n&p_tun->vxlan_port);\r\nqed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_l2geneve,\r\n&p_tun->l2_geneve,\r\n&p_tunn_cfg->set_geneve_udp_port_flg,\r\n&p_tunn_cfg->geneve_udp_port,\r\n&p_tun->geneve_port);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_ipgeneve,\r\n&p_tun->ip_geneve);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_l2gre,\r\n&p_tun->l2_gre);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_ipgre,\r\n&p_tun->ip_gre);\r\np_tunn_cfg->update_rx_pf_clss = p_tun->b_update_rx_cls;\r\n}\r\nstatic void qed_set_hw_tunn_mode(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_tunnel_info *p_tun)\r\n{\r\nqed_set_gre_enable(p_hwfn, p_ptt, p_tun->l2_gre.b_mode_enabled,\r\np_tun->ip_gre.b_mode_enabled);\r\nqed_set_vxlan_enable(p_hwfn, p_ptt, p_tun->vxlan.b_mode_enabled);\r\nqed_set_geneve_enable(p_hwfn, p_ptt, p_tun->l2_geneve.b_mode_enabled,\r\np_tun->ip_geneve.b_mode_enabled);\r\n}\r\nstatic void qed_set_hw_tunn_mode_port(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_tunnel_info *p_tunn)\r\n{\r\nif (p_tunn->vxlan_port.b_update_port)\r\nqed_set_vxlan_dest_port(p_hwfn, p_ptt,\r\np_tunn->vxlan_port.port);\r\nif (p_tunn->geneve_port.b_update_port)\r\nqed_set_geneve_dest_port(p_hwfn, p_ptt,\r\np_tunn->geneve_port.port);\r\nqed_set_hw_tunn_mode(p_hwfn, p_ptt, p_tunn);\r\n}\r\nstatic void\r\nqed_tunn_set_pf_start_params(struct qed_hwfn *p_hwfn,\r\nstruct qed_tunnel_info *p_src,\r\nstruct pf_start_tunnel_config *p_tunn_cfg)\r\n{\r\nstruct qed_tunnel_info *p_tun = &p_hwfn->cdev->tunnel;\r\nif (!p_src)\r\nreturn;\r\nqed_set_pf_update_tunn_mode(p_tun, p_src, true);\r\nqed_set_tunn_cls_info(p_tun, p_src);\r\nqed_set_tunn_ports(p_tun, p_src);\r\nqed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_vxlan,\r\n&p_tun->vxlan,\r\n&p_tunn_cfg->set_vxlan_udp_port_flg,\r\n&p_tunn_cfg->vxlan_udp_port,\r\n&p_tun->vxlan_port);\r\nqed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_l2geneve,\r\n&p_tun->l2_geneve,\r\n&p_tunn_cfg->set_geneve_udp_port_flg,\r\n&p_tunn_cfg->geneve_udp_port,\r\n&p_tun->geneve_port);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_ipgeneve,\r\n&p_tun->ip_geneve);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_l2gre,\r\n&p_tun->l2_gre);\r\n__qed_set_ramrod_tunnel_param(&p_tunn_cfg->tunnel_clss_ipgre,\r\n&p_tun->ip_gre);\r\n}\r\nint qed_sp_pf_start(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_tunnel_info *p_tunn,\r\nenum qed_mf_mode mode, bool allow_npar_tx_switch)\r\n{\r\nstruct pf_start_ramrod_data *p_ramrod = NULL;\r\nu16 sb = qed_int_get_sp_sb_id(p_hwfn);\r\nu8 sb_index = p_hwfn->p_eq->eq_sb_index;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nu8 page_cnt;\r\nqed_eq_prod_update(p_hwfn,\r\nqed_chain_get_prod_idx(&p_hwfn->p_eq->chain));\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = QED_SPQ_MODE_EBLOCK;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_PF_START,\r\nPROTOCOLID_COMMON, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.pf_start;\r\np_ramrod->event_ring_sb_id = cpu_to_le16(sb);\r\np_ramrod->event_ring_sb_index = sb_index;\r\np_ramrod->path_id = QED_PATH_ID(p_hwfn);\r\np_ramrod->dont_log_ramrods = 0;\r\np_ramrod->log_type_mask = cpu_to_le16(0xf);\r\nswitch (mode) {\r\ncase QED_MF_DEFAULT:\r\ncase QED_MF_NPAR:\r\np_ramrod->mf_mode = MF_NPAR;\r\nbreak;\r\ncase QED_MF_OVLAN:\r\np_ramrod->mf_mode = MF_OVLAN;\r\nbreak;\r\ndefault:\r\nDP_NOTICE(p_hwfn, "Unsupported MF mode, init as DEFAULT\n");\r\np_ramrod->mf_mode = MF_NPAR;\r\n}\r\np_ramrod->outer_tag = p_hwfn->hw_info.ovlan;\r\nDMA_REGPAIR_LE(p_ramrod->event_ring_pbl_addr,\r\np_hwfn->p_eq->chain.pbl_sp.p_phys_table);\r\npage_cnt = (u8)qed_chain_get_page_cnt(&p_hwfn->p_eq->chain);\r\np_ramrod->event_ring_num_pages = page_cnt;\r\nDMA_REGPAIR_LE(p_ramrod->consolid_q_pbl_addr,\r\np_hwfn->p_consq->chain.pbl_sp.p_phys_table);\r\nqed_tunn_set_pf_start_params(p_hwfn, p_tunn, &p_ramrod->tunnel_config);\r\nif (IS_MF_SI(p_hwfn))\r\np_ramrod->allow_npar_tx_switching = allow_npar_tx_switch;\r\nswitch (p_hwfn->hw_info.personality) {\r\ncase QED_PCI_ETH:\r\np_ramrod->personality = PERSONALITY_ETH;\r\nbreak;\r\ncase QED_PCI_FCOE:\r\np_ramrod->personality = PERSONALITY_FCOE;\r\nbreak;\r\ncase QED_PCI_ISCSI:\r\np_ramrod->personality = PERSONALITY_ISCSI;\r\nbreak;\r\ncase QED_PCI_ETH_ROCE:\r\np_ramrod->personality = PERSONALITY_RDMA_AND_ETH;\r\nbreak;\r\ndefault:\r\nDP_NOTICE(p_hwfn, "Unknown personality %d\n",\r\np_hwfn->hw_info.personality);\r\np_ramrod->personality = PERSONALITY_ETH;\r\n}\r\nif (p_hwfn->cdev->p_iov_info) {\r\nstruct qed_hw_sriov_info *p_iov = p_hwfn->cdev->p_iov_info;\r\np_ramrod->base_vf_id = (u8) p_iov->first_vf_in_pf;\r\np_ramrod->num_vfs = (u8) p_iov->total_vfs;\r\n}\r\np_ramrod->hsi_fp_ver.major_ver_arr[ETH_VER_KEY] = ETH_HSI_VER_MAJOR;\r\np_ramrod->hsi_fp_ver.minor_ver_arr[ETH_VER_KEY] = ETH_HSI_VER_MINOR;\r\nDP_VERBOSE(p_hwfn, QED_MSG_SPQ,\r\n"Setting event_ring_sb [id %04x index %02x], outer_tag [%d]\n",\r\nsb, sb_index, p_ramrod->outer_tag);\r\nrc = qed_spq_post(p_hwfn, p_ent, NULL);\r\nif (p_tunn)\r\nqed_set_hw_tunn_mode_port(p_hwfn, p_ptt,\r\n&p_hwfn->cdev->tunnel);\r\nreturn rc;\r\n}\r\nint qed_sp_pf_update(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = QED_SPQ_MODE_CB;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_PF_UPDATE, PROTOCOLID_COMMON,\r\n&init_data);\r\nif (rc)\r\nreturn rc;\r\nqed_dcbx_set_pf_update_params(&p_hwfn->p_dcbx_info->results,\r\n&p_ent->ramrod.pf_update);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nint qed_sp_pf_update_tunn_cfg(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_tunnel_info *p_tunn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_data)\r\n{\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nif (IS_VF(p_hwfn->cdev))\r\nreturn qed_vf_pf_tunnel_param_update(p_hwfn, p_tunn);\r\nif (!p_tunn)\r\nreturn -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_data;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_PF_UPDATE, PROTOCOLID_COMMON,\r\n&init_data);\r\nif (rc)\r\nreturn rc;\r\nqed_tunn_set_pf_update_params(p_hwfn, p_tunn,\r\n&p_ent->ramrod.pf_update.tunnel_config);\r\nrc = qed_spq_post(p_hwfn, p_ent, NULL);\r\nif (rc)\r\nreturn rc;\r\nqed_set_hw_tunn_mode_port(p_hwfn, p_ptt, &p_hwfn->cdev->tunnel);\r\nreturn rc;\r\n}\r\nint qed_sp_pf_stop(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = QED_SPQ_MODE_EBLOCK;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_PF_STOP, PROTOCOLID_COMMON,\r\n&init_data);\r\nif (rc)\r\nreturn rc;\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nint qed_sp_heartbeat_ramrod(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = QED_SPQ_MODE_EBLOCK;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_EMPTY, PROTOCOLID_COMMON,\r\n&init_data);\r\nif (rc)\r\nreturn rc;\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nint qed_sp_pf_update_stag(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = QED_SPQ_MODE_CB;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nCOMMON_RAMROD_PF_UPDATE, PROTOCOLID_COMMON,\r\n&init_data);\r\nif (rc)\r\nreturn rc;\r\np_ent->ramrod.pf_update.update_mf_vlan_flag = true;\r\np_ent->ramrod.pf_update.mf_vlan = cpu_to_le16(p_hwfn->hw_info.ovlan);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}

static int mv88e6xxx_g1_atu_fid_write(struct mv88e6xxx_chip *chip, u16 fid)\r\n{\r\nreturn mv88e6xxx_g1_write(chip, MV88E6352_G1_ATU_FID, fid & 0xfff);\r\n}\r\nint mv88e6xxx_g1_atu_set_learn2all(struct mv88e6xxx_chip *chip, bool learn2all)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_ATU_CTL, &val);\r\nif (err)\r\nreturn err;\r\nif (learn2all)\r\nval |= MV88E6XXX_G1_ATU_CTL_LEARN2ALL;\r\nelse\r\nval &= ~MV88E6XXX_G1_ATU_CTL_LEARN2ALL;\r\nreturn mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_CTL, val);\r\n}\r\nint mv88e6xxx_g1_atu_set_age_time(struct mv88e6xxx_chip *chip,\r\nunsigned int msecs)\r\n{\r\nconst unsigned int coeff = chip->info->age_time_coeff;\r\nconst unsigned int min = 0x01 * coeff;\r\nconst unsigned int max = 0xff * coeff;\r\nu8 age_time;\r\nu16 val;\r\nint err;\r\nif (msecs < min || msecs > max)\r\nreturn -ERANGE;\r\nage_time = (msecs + coeff / 2) / coeff;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_ATU_CTL, &val);\r\nif (err)\r\nreturn err;\r\nval &= ~0xff0;\r\nval |= age_time << 4;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_CTL, val);\r\nif (err)\r\nreturn err;\r\ndev_dbg(chip->dev, "AgeTime set to 0x%02x (%d ms)\n", age_time,\r\nage_time * coeff);\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_atu_op_wait(struct mv88e6xxx_chip *chip)\r\n{\r\nreturn mv88e6xxx_g1_wait(chip, MV88E6XXX_G1_ATU_OP,\r\nMV88E6XXX_G1_ATU_OP_BUSY);\r\n}\r\nstatic int mv88e6xxx_g1_atu_op(struct mv88e6xxx_chip *chip, u16 fid, u16 op)\r\n{\r\nu16 val;\r\nint err;\r\nif (mv88e6xxx_num_databases(chip) > 256) {\r\nerr = mv88e6xxx_g1_atu_fid_write(chip, fid);\r\nif (err)\r\nreturn err;\r\n} else {\r\nif (mv88e6xxx_num_databases(chip) > 16) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_ATU_CTL,\r\n&val);\r\nif (err)\r\nreturn err;\r\nval = (val & 0x0fff) | ((fid << 8) & 0xf000);\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_CTL,\r\nval);\r\nif (err)\r\nreturn err;\r\n}\r\nop |= fid & 0xf;\r\n}\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_OP,\r\nMV88E6XXX_G1_ATU_OP_BUSY | op);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_atu_op_wait(chip);\r\n}\r\nstatic int mv88e6xxx_g1_atu_data_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_ATU_DATA, &val);\r\nif (err)\r\nreturn err;\r\nentry->state = val & 0xf;\r\nif (entry->state != MV88E6XXX_G1_ATU_DATA_STATE_UNUSED) {\r\nentry->trunk = !!(val & MV88E6XXX_G1_ATU_DATA_TRUNK);\r\nentry->portvec = (val >> 4) & mv88e6xxx_port_mask(chip);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_atu_data_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nu16 data = entry->state & 0xf;\r\nif (entry->state != MV88E6XXX_G1_ATU_DATA_STATE_UNUSED) {\r\nif (entry->trunk)\r\ndata |= MV88E6XXX_G1_ATU_DATA_TRUNK;\r\ndata |= (entry->portvec & mv88e6xxx_port_mask(chip)) << 4;\r\n}\r\nreturn mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_DATA, data);\r\n}\r\nstatic int mv88e6xxx_g1_atu_mac_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nu16 val;\r\nint i, err;\r\nfor (i = 0; i < 3; i++) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_ATU_MAC01 + i, &val);\r\nif (err)\r\nreturn err;\r\nentry->mac[i * 2] = val >> 8;\r\nentry->mac[i * 2 + 1] = val & 0xff;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_atu_mac_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nu16 val;\r\nint i, err;\r\nfor (i = 0; i < 3; i++) {\r\nval = (entry->mac[i * 2] << 8) | entry->mac[i * 2 + 1];\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_ATU_MAC01 + i, val);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mv88e6xxx_g1_atu_getnext(struct mv88e6xxx_chip *chip, u16 fid,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_atu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nif (entry->state == MV88E6XXX_G1_ATU_DATA_STATE_UNUSED) {\r\nerr = mv88e6xxx_g1_atu_mac_write(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = mv88e6xxx_g1_atu_op(chip, fid, MV88E6XXX_G1_ATU_OP_GET_NEXT_DB);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_atu_data_read(chip, entry);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_atu_mac_read(chip, entry);\r\n}\r\nint mv88e6xxx_g1_atu_loadpurge(struct mv88e6xxx_chip *chip, u16 fid,\r\nstruct mv88e6xxx_atu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_atu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_atu_mac_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_atu_data_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_atu_op(chip, fid, MV88E6XXX_G1_ATU_OP_LOAD_DB);\r\n}\r\nstatic int mv88e6xxx_g1_atu_flushmove(struct mv88e6xxx_chip *chip, u16 fid,\r\nstruct mv88e6xxx_atu_entry *entry,\r\nbool all)\r\n{\r\nu16 op;\r\nint err;\r\nerr = mv88e6xxx_g1_atu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_atu_data_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (all && fid)\r\nop = MV88E6XXX_G1_ATU_OP_FLUSH_MOVE_ALL_DB;\r\nelse if (fid)\r\nop = MV88E6XXX_G1_ATU_OP_FLUSH_MOVE_NON_STATIC_DB;\r\nelse if (all)\r\nop = MV88E6XXX_G1_ATU_OP_FLUSH_MOVE_ALL;\r\nelse\r\nop = MV88E6XXX_G1_ATU_OP_FLUSH_MOVE_NON_STATIC;\r\nreturn mv88e6xxx_g1_atu_op(chip, fid, op);\r\n}\r\nint mv88e6xxx_g1_atu_flush(struct mv88e6xxx_chip *chip, u16 fid, bool all)\r\n{\r\nstruct mv88e6xxx_atu_entry entry = {\r\n.state = 0,\r\n};\r\nreturn mv88e6xxx_g1_atu_flushmove(chip, fid, &entry, all);\r\n}\r\nstatic int mv88e6xxx_g1_atu_move(struct mv88e6xxx_chip *chip, u16 fid,\r\nint from_port, int to_port, bool all)\r\n{\r\nstruct mv88e6xxx_atu_entry entry = { 0 };\r\nunsigned long mask;\r\nint shift;\r\nif (!chip->info->atu_move_port_mask)\r\nreturn -EOPNOTSUPP;\r\nmask = chip->info->atu_move_port_mask;\r\nshift = bitmap_weight(&mask, 16);\r\nentry.state = 0xf,\r\nentry.portvec = from_port & mask;\r\nentry.portvec |= (to_port & mask) << shift;\r\nreturn mv88e6xxx_g1_atu_flushmove(chip, fid, &entry, all);\r\n}\r\nint mv88e6xxx_g1_atu_remove(struct mv88e6xxx_chip *chip, u16 fid, int port,\r\nbool all)\r\n{\r\nint from_port = port;\r\nint to_port = chip->info->atu_move_port_mask;\r\nreturn mv88e6xxx_g1_atu_move(chip, fid, from_port, to_port, all);\r\n}

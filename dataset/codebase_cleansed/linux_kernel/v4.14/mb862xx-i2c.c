static int mb862xx_i2c_wait_event(struct i2c_adapter *adap)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\nu32 reg;\r\ndo {\r\nudelay(10);\r\nreg = inreg(i2c, GC_I2C_BCR);\r\nif (reg & (I2C_INT | I2C_BER))\r\nbreak;\r\n} while (1);\r\nreturn (reg & I2C_BER) ? 0 : 1;\r\n}\r\nstatic int mb862xx_i2c_do_address(struct i2c_adapter *adap, int addr)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\noutreg(i2c, GC_I2C_DAR, addr);\r\noutreg(i2c, GC_I2C_CCR, I2C_CLOCK_AND_ENABLE);\r\noutreg(i2c, GC_I2C_BCR, par->i2c_rs ? I2C_REPEATED_START : I2C_START);\r\nif (!mb862xx_i2c_wait_event(adap))\r\nreturn -EIO;\r\npar->i2c_rs = !(inreg(i2c, GC_I2C_BSR) & I2C_LRB);\r\nreturn par->i2c_rs;\r\n}\r\nstatic int mb862xx_i2c_write_byte(struct i2c_adapter *adap, u8 byte)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\noutreg(i2c, GC_I2C_DAR, byte);\r\noutreg(i2c, GC_I2C_BCR, I2C_START);\r\nif (!mb862xx_i2c_wait_event(adap))\r\nreturn -EIO;\r\nreturn !(inreg(i2c, GC_I2C_BSR) & I2C_LRB);\r\n}\r\nstatic int mb862xx_i2c_read_byte(struct i2c_adapter *adap, u8 *byte, int last)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\noutreg(i2c, GC_I2C_BCR, I2C_START | (last ? 0 : I2C_ACK));\r\nif (!mb862xx_i2c_wait_event(adap))\r\nreturn 0;\r\n*byte = inreg(i2c, GC_I2C_DAR);\r\nreturn 1;\r\n}\r\nstatic void mb862xx_i2c_stop(struct i2c_adapter *adap)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\noutreg(i2c, GC_I2C_BCR, I2C_STOP);\r\noutreg(i2c, GC_I2C_CCR, I2C_DISABLE);\r\npar->i2c_rs = 0;\r\n}\r\nstatic int mb862xx_i2c_read(struct i2c_adapter *adap, struct i2c_msg *m)\r\n{\r\nint i, ret = 0;\r\nint last = m->len - 1;\r\nfor (i = 0; i < m->len; i++) {\r\nif (!mb862xx_i2c_read_byte(adap, &m->buf[i], i == last)) {\r\nret = -EIO;\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int mb862xx_i2c_write(struct i2c_adapter *adap, struct i2c_msg *m)\r\n{\r\nint i, ret = 0;\r\nfor (i = 0; i < m->len; i++) {\r\nif (!mb862xx_i2c_write_byte(adap, m->buf[i])) {\r\nret = -EIO;\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int mb862xx_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct mb862xxfb_par *par = adap->algo_data;\r\nstruct i2c_msg *m;\r\nint addr;\r\nint i = 0, err = 0;\r\ndev_dbg(par->dev, "%s: %d msgs\n", __func__, num);\r\nfor (i = 0; i < num; i++) {\r\nm = &msgs[i];\r\nif (!m->len) {\r\ndev_dbg(par->dev, "%s: null msgs\n", __func__);\r\ncontinue;\r\n}\r\naddr = m->addr;\r\nif (m->flags & I2C_M_RD)\r\naddr |= 1;\r\nerr = mb862xx_i2c_do_address(adap, addr);\r\nif (err < 0)\r\nbreak;\r\nif (m->flags & I2C_M_RD)\r\nerr = mb862xx_i2c_read(adap, m);\r\nelse\r\nerr = mb862xx_i2c_write(adap, m);\r\n}\r\nif (i)\r\nmb862xx_i2c_stop(adap);\r\nreturn (err < 0) ? err : i;\r\n}\r\nstatic u32 mb862xx_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_SMBUS_BYTE_DATA;\r\n}\r\nint mb862xx_i2c_init(struct mb862xxfb_par *par)\r\n{\r\nmb862xx_i2c_adapter.algo_data = par;\r\npar->adap = &mb862xx_i2c_adapter;\r\nreturn i2c_add_adapter(par->adap);\r\n}\r\nvoid mb862xx_i2c_exit(struct mb862xxfb_par *par)\r\n{\r\nif (par->adap) {\r\ni2c_del_adapter(par->adap);\r\npar->adap = NULL;\r\n}\r\n}

static int tegra186_pmc_restart_notify(struct notifier_block *nb,\r\nunsigned long action,\r\nvoid *data)\r\n{\r\nstruct tegra_pmc *pmc = container_of(nb, struct tegra_pmc, restart);\r\nconst char *cmd = data;\r\nu32 value;\r\nvalue = readl(pmc->scratch + SCRATCH_SCRATCH0);\r\nvalue &= ~SCRATCH_SCRATCH0_MODE_MASK;\r\nif (cmd) {\r\nif (strcmp(cmd, "recovery") == 0)\r\nvalue |= SCRATCH_SCRATCH0_MODE_RECOVERY;\r\nif (strcmp(cmd, "bootloader") == 0)\r\nvalue |= SCRATCH_SCRATCH0_MODE_BOOTLOADER;\r\nif (strcmp(cmd, "forced-recovery") == 0)\r\nvalue |= SCRATCH_SCRATCH0_MODE_RCM;\r\n}\r\nwritel(value, pmc->scratch + SCRATCH_SCRATCH0);\r\nif (pmc->system_restart) {\r\npmc->system_restart(reboot_mode, cmd);\r\nreturn NOTIFY_DONE;\r\n}\r\nvalue = readl(pmc->regs + PMC_CNTRL);\r\nvalue |= PMC_CNTRL_MAIN_RST;\r\nwritel(value, pmc->regs + PMC_CNTRL);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int tegra186_pmc_setup(struct tegra_pmc *pmc)\r\n{\r\nstruct device_node *np = pmc->dev->of_node;\r\nbool invert;\r\nu32 value;\r\ninvert = of_property_read_bool(np, "nvidia,invert-interrupt");\r\nvalue = readl(pmc->wake + WAKE_AOWAKE_CTRL);\r\nif (invert)\r\nvalue |= WAKE_AOWAKE_CTRL_INTR_POLARITY;\r\nelse\r\nvalue &= ~WAKE_AOWAKE_CTRL_INTR_POLARITY;\r\nwritel(value, pmc->wake + WAKE_AOWAKE_CTRL);\r\npmc->system_restart = arm_pm_restart;\r\narm_pm_restart = NULL;\r\npmc->restart.notifier_call = tegra186_pmc_restart_notify;\r\npmc->restart.priority = 128;\r\nreturn register_restart_handler(&pmc->restart);\r\n}\r\nstatic int tegra186_pmc_probe(struct platform_device *pdev)\r\n{\r\nstruct tegra_pmc *pmc;\r\nstruct resource *res;\r\npmc = devm_kzalloc(&pdev->dev, sizeof(*pmc), GFP_KERNEL);\r\nif (!pmc)\r\nreturn -ENOMEM;\r\npmc->dev = &pdev->dev;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "pmc");\r\npmc->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pmc->regs))\r\nreturn PTR_ERR(pmc->regs);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "wake");\r\npmc->wake = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pmc->wake))\r\nreturn PTR_ERR(pmc->wake);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "aotag");\r\npmc->aotag = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pmc->aotag))\r\nreturn PTR_ERR(pmc->aotag);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "scratch");\r\npmc->scratch = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pmc->scratch))\r\nreturn PTR_ERR(pmc->scratch);\r\nreturn tegra186_pmc_setup(pmc);\r\n}

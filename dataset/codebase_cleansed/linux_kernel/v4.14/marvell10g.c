static int mv3310_modify(struct phy_device *phydev, int devad, u16 reg,\r\nu16 mask, u16 bits)\r\n{\r\nint old, val, ret;\r\nold = phy_read_mmd(phydev, devad, reg);\r\nif (old < 0)\r\nreturn old;\r\nval = (old & ~mask) | (bits & mask);\r\nif (val == old)\r\nreturn 0;\r\nret = phy_write_mmd(phydev, devad, reg, val);\r\nreturn ret < 0 ? ret : 1;\r\n}\r\nstatic int mv3310_probe(struct phy_device *phydev)\r\n{\r\nu32 mmd_mask = MDIO_DEVS_PMAPMD | MDIO_DEVS_AN;\r\nif (!phydev->is_c45 ||\r\n(phydev->c45_ids.devices_in_package & mmd_mask) != mmd_mask)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int mv3310_soft_reset(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int mv3310_config_init(struct phy_device *phydev)\r\n{\r\n__ETHTOOL_DECLARE_LINK_MODE_MASK(supported) = { 0, };\r\nu32 mask;\r\nint val;\r\nif (phydev->interface != PHY_INTERFACE_MODE_SGMII &&\r\nphydev->interface != PHY_INTERFACE_MODE_XGMII &&\r\nphydev->interface != PHY_INTERFACE_MODE_XAUI &&\r\nphydev->interface != PHY_INTERFACE_MODE_RXAUI &&\r\nphydev->interface != PHY_INTERFACE_MODE_10GKR)\r\nreturn -ENODEV;\r\n__set_bit(ETHTOOL_LINK_MODE_Pause_BIT, supported);\r\n__set_bit(ETHTOOL_LINK_MODE_Asym_Pause_BIT, supported);\r\nif (phydev->c45_ids.devices_in_package & MDIO_DEVS_AN) {\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_STAT1);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MDIO_AN_STAT1_ABLE)\r\n__set_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, supported);\r\n}\r\nval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_STAT2);\r\nif (val < 0)\r\nreturn val;\r\nif (val & (MDIO_PMA_STAT2_10GBSR | MDIO_PMA_STAT2_10GBLR |\r\nMDIO_PMA_STAT2_10GBER | MDIO_PMA_STAT2_10GBLX4 |\r\nMDIO_PMA_STAT2_10GBSW | MDIO_PMA_STAT2_10GBLW |\r\nMDIO_PMA_STAT2_10GBEW))\r\n__set_bit(ETHTOOL_LINK_MODE_FIBRE_BIT, supported);\r\nif (val & MDIO_PMA_STAT2_10GBSR)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseSR_Full_BIT, supported);\r\nif (val & MDIO_PMA_STAT2_10GBLR)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseLR_Full_BIT, supported);\r\nif (val & MDIO_PMA_STAT2_10GBER)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseER_Full_BIT, supported);\r\nif (val & MDIO_PMA_STAT2_EXTABLE) {\r\nval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_EXTABLE);\r\nif (val < 0)\r\nreturn val;\r\nif (val & (MDIO_PMA_EXTABLE_10GBT | MDIO_PMA_EXTABLE_1000BT |\r\nMDIO_PMA_EXTABLE_100BTX | MDIO_PMA_EXTABLE_10BT))\r\n__set_bit(ETHTOOL_LINK_MODE_TP_BIT, supported);\r\nif (val & MDIO_PMA_EXTABLE_10GBLRM)\r\n__set_bit(ETHTOOL_LINK_MODE_FIBRE_BIT, supported);\r\nif (val & (MDIO_PMA_EXTABLE_10GBKX4 | MDIO_PMA_EXTABLE_10GBKR |\r\nMDIO_PMA_EXTABLE_1000BKX))\r\n__set_bit(ETHTOOL_LINK_MODE_Backplane_BIT, supported);\r\nif (val & MDIO_PMA_EXTABLE_10GBLRM)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseLRM_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_10GBT)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseT_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_10GBKX4)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseKX4_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_10GBKR)\r\n__set_bit(ETHTOOL_LINK_MODE_10000baseKR_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_1000BT)\r\n__set_bit(ETHTOOL_LINK_MODE_1000baseT_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_1000BKX)\r\n__set_bit(ETHTOOL_LINK_MODE_1000baseKX_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_100BTX)\r\n__set_bit(ETHTOOL_LINK_MODE_100baseT_Full_BIT,\r\nsupported);\r\nif (val & MDIO_PMA_EXTABLE_10BT)\r\n__set_bit(ETHTOOL_LINK_MODE_10baseT_Full_BIT,\r\nsupported);\r\n}\r\nif (!ethtool_convert_link_mode_to_legacy_u32(&mask, supported))\r\ndev_warn(&phydev->mdio.dev,\r\n"PHY supports (%*pb) more modes than phylib supports, some modes not supported.\n",\r\n__ETHTOOL_LINK_MODE_MASK_NBITS, supported);\r\nphydev->supported &= mask;\r\nphydev->advertising &= phydev->supported;\r\nreturn 0;\r\n}\r\nstatic int mv3310_config_aneg(struct phy_device *phydev)\r\n{\r\nbool changed = false;\r\nu32 advertising;\r\nint ret;\r\nif (phydev->autoneg == AUTONEG_DISABLE) {\r\nret = genphy_c45_pma_setup_forced(phydev);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn genphy_c45_an_disable_aneg(phydev);\r\n}\r\nphydev->advertising &= phydev->supported;\r\nadvertising = phydev->advertising;\r\nret = mv3310_modify(phydev, MDIO_MMD_AN, MDIO_AN_ADVERTISE,\r\nADVERTISE_ALL | ADVERTISE_100BASE4 |\r\nADVERTISE_PAUSE_CAP | ADVERTISE_PAUSE_ASYM,\r\nethtool_adv_to_mii_adv_t(advertising));\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret > 0)\r\nchanged = true;\r\nret = mv3310_modify(phydev, MDIO_MMD_AN, MV_AN_CTRL1000,\r\nADVERTISE_1000FULL | ADVERTISE_1000HALF,\r\nethtool_adv_to_mii_ctrl1000_t(advertising));\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret > 0)\r\nchanged = true;\r\nret = mv3310_modify(phydev, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\r\nMDIO_AN_10GBT_CTRL_ADV10G,\r\nadvertising & ADVERTISED_10000baseT_Full ?\r\nMDIO_AN_10GBT_CTRL_ADV10G : 0);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret > 0)\r\nchanged = true;\r\nif (changed)\r\nret = genphy_c45_restart_aneg(phydev);\r\nreturn ret;\r\n}\r\nstatic int mv3310_aneg_done(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_PCS, MV_PCS_BASE_R + MDIO_STAT1);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MDIO_STAT1_LSTATUS)\r\nreturn 1;\r\nreturn genphy_c45_aneg_done(phydev);\r\n}\r\nstatic int mv3310_read_10gbr_status(struct phy_device *phydev)\r\n{\r\nphydev->link = 1;\r\nphydev->speed = SPEED_10000;\r\nphydev->duplex = DUPLEX_FULL;\r\nif (phydev->interface == PHY_INTERFACE_MODE_SGMII)\r\nphydev->interface = PHY_INTERFACE_MODE_10GKR;\r\nreturn 0;\r\n}\r\nstatic int mv3310_read_status(struct phy_device *phydev)\r\n{\r\nu32 mmd_mask = phydev->c45_ids.devices_in_package;\r\nint val;\r\nmmd_mask &= ~(BIT(MDIO_MMD_VEND1) | BIT(MDIO_MMD_VEND2) |\r\nBIT(MDIO_MMD_PHYXS));\r\nphydev->speed = SPEED_UNKNOWN;\r\nphydev->duplex = DUPLEX_UNKNOWN;\r\nphydev->lp_advertising = 0;\r\nphydev->link = 0;\r\nphydev->pause = 0;\r\nphydev->asym_pause = 0;\r\nval = phy_read_mmd(phydev, MDIO_MMD_PCS, MV_PCS_BASE_R + MDIO_STAT1);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MDIO_STAT1_LSTATUS)\r\nreturn mv3310_read_10gbr_status(phydev);\r\nval = genphy_c45_read_link(phydev, mmd_mask);\r\nif (val < 0)\r\nreturn val;\r\nphydev->link = val > 0 ? 1 : 0;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_STAT1);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MDIO_AN_STAT1_COMPLETE) {\r\nval = genphy_c45_read_lpa(phydev);\r\nif (val < 0)\r\nreturn val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MV_AN_STAT1000);\r\nif (val < 0)\r\nreturn val;\r\nphydev->lp_advertising |= mii_stat1000_to_ethtool_lpa_t(val);\r\nif (phydev->autoneg == AUTONEG_ENABLE) {\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MV_AN_RESULT);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MV_AN_RESULT_SPD_10000)\r\nphydev->speed = SPEED_10000;\r\nelse if (val & MV_AN_RESULT_SPD_1000)\r\nphydev->speed = SPEED_1000;\r\nelse if (val & MV_AN_RESULT_SPD_100)\r\nphydev->speed = SPEED_100;\r\nelse if (val & MV_AN_RESULT_SPD_10)\r\nphydev->speed = SPEED_10;\r\nphydev->duplex = DUPLEX_FULL;\r\n}\r\n}\r\nif (phydev->autoneg != AUTONEG_ENABLE) {\r\nval = genphy_c45_read_pma(phydev);\r\nif (val < 0)\r\nreturn val;\r\n}\r\nif ((phydev->interface == PHY_INTERFACE_MODE_SGMII ||\r\nphydev->interface == PHY_INTERFACE_MODE_10GKR) && phydev->link) {\r\nif (phydev->speed == SPEED_10000)\r\nphydev->interface = PHY_INTERFACE_MODE_10GKR;\r\nelse if (phydev->speed >= SPEED_10 &&\r\nphydev->speed < SPEED_10000)\r\nphydev->interface = PHY_INTERFACE_MODE_SGMII;\r\n}\r\nreturn 0;\r\n}

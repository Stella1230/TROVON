int bpf_prog1(struct pt_regs *ctx)\r\n{\r\nint cpu = bpf_get_smp_processor_id();\r\nu64 *ts = bpf_map_lookup_elem(&my_map, &cpu);\r\nif (ts)\r\n*ts = bpf_ktime_get_ns();\r\nreturn 0;\r\n}\r\nstatic unsigned int log2(unsigned int v)\r\n{\r\nunsigned int r;\r\nunsigned int shift;\r\nr = (v > 0xFFFF) << 4; v >>= r;\r\nshift = (v > 0xFF) << 3; v >>= shift; r |= shift;\r\nshift = (v > 0xF) << 2; v >>= shift; r |= shift;\r\nshift = (v > 0x3) << 1; v >>= shift; r |= shift;\r\nr |= (v >> 1);\r\nreturn r;\r\n}\r\nstatic unsigned int log2l(unsigned long v)\r\n{\r\nunsigned int hi = v >> 32;\r\nif (hi)\r\nreturn log2(hi) + 32;\r\nelse\r\nreturn log2(v);\r\n}\r\nint bpf_prog2(struct pt_regs *ctx)\r\n{\r\nu64 *ts, cur_ts, delta;\r\nint key, cpu;\r\nlong *val;\r\ncpu = bpf_get_smp_processor_id();\r\nts = bpf_map_lookup_elem(&my_map, &cpu);\r\nif (!ts)\r\nreturn 0;\r\ncur_ts = bpf_ktime_get_ns();\r\ndelta = log2l(cur_ts - *ts);\r\nif (delta > MAX_ENTRIES - 1)\r\ndelta = MAX_ENTRIES - 1;\r\nkey = cpu * MAX_ENTRIES + delta;\r\nval = bpf_map_lookup_elem(&my_lat, &key);\r\nif (val)\r\n__sync_fetch_and_add((long *)val, 1);\r\nreturn 0;\r\n}

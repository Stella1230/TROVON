static void *\r\nls_ucode_img_build(const struct firmware *bl, const struct firmware *code,\r\nconst struct firmware *data, struct ls_ucode_img_desc *desc)\r\n{\r\nstruct fw_bin_header *bin_hdr = (void *)bl->data;\r\nstruct fw_bl_desc *bl_desc = (void *)bl->data + bin_hdr->header_offset;\r\nvoid *bl_data = (void *)bl->data + bin_hdr->data_offset;\r\nu32 pos = 0;\r\nvoid *image;\r\ndesc->bootloader_start_offset = pos;\r\ndesc->bootloader_size = ALIGN(bl_desc->code_size, sizeof(u32));\r\ndesc->bootloader_imem_offset = bl_desc->start_tag * 256;\r\ndesc->bootloader_entry_point = bl_desc->start_tag * 256;\r\npos = ALIGN(pos + desc->bootloader_size, BL_DESC_BLK_SIZE);\r\ndesc->app_start_offset = pos;\r\ndesc->app_size = ALIGN(code->size, BL_DESC_BLK_SIZE) +\r\nALIGN(data->size, BL_DESC_BLK_SIZE);\r\ndesc->app_imem_offset = 0;\r\ndesc->app_imem_entry = 0;\r\ndesc->app_dmem_offset = 0;\r\ndesc->app_resident_code_offset = 0;\r\ndesc->app_resident_code_size = ALIGN(code->size, BL_DESC_BLK_SIZE);\r\npos = ALIGN(pos + desc->app_resident_code_size, BL_DESC_BLK_SIZE);\r\ndesc->app_resident_data_offset = pos - desc->app_start_offset;\r\ndesc->app_resident_data_size = ALIGN(data->size, BL_DESC_BLK_SIZE);\r\ndesc->image_size = ALIGN(bl_desc->code_size, BL_DESC_BLK_SIZE) +\r\ndesc->app_size;\r\nimage = kzalloc(desc->image_size, GFP_KERNEL);\r\nif (!image)\r\nreturn ERR_PTR(-ENOMEM);\r\nmemcpy(image + desc->bootloader_start_offset, bl_data,\r\nbl_desc->code_size);\r\nmemcpy(image + desc->app_start_offset, code->data, code->size);\r\nmemcpy(image + desc->app_start_offset + desc->app_resident_data_offset,\r\ndata->data, data->size);\r\nreturn image;\r\n}\r\nstatic int\r\nls_ucode_img_load_gr(const struct nvkm_subdev *subdev, struct ls_ucode_img *img,\r\nconst char *falcon_name)\r\n{\r\nconst struct firmware *bl, *code, *data, *sig;\r\nchar f[64];\r\nint ret;\r\nsnprintf(f, sizeof(f), "gr/%s_bl", falcon_name);\r\nret = nvkm_firmware_get(subdev->device, f, &bl);\r\nif (ret)\r\ngoto error;\r\nsnprintf(f, sizeof(f), "gr/%s_inst", falcon_name);\r\nret = nvkm_firmware_get(subdev->device, f, &code);\r\nif (ret)\r\ngoto free_bl;\r\nsnprintf(f, sizeof(f), "gr/%s_data", falcon_name);\r\nret = nvkm_firmware_get(subdev->device, f, &data);\r\nif (ret)\r\ngoto free_inst;\r\nsnprintf(f, sizeof(f), "gr/%s_sig", falcon_name);\r\nret = nvkm_firmware_get(subdev->device, f, &sig);\r\nif (ret)\r\ngoto free_data;\r\nimg->sig = kmemdup(sig->data, sig->size, GFP_KERNEL);\r\nif (!img->sig) {\r\nret = -ENOMEM;\r\ngoto free_sig;\r\n}\r\nimg->sig_size = sig->size;\r\nimg->ucode_data = ls_ucode_img_build(bl, code, data,\r\n&img->ucode_desc);\r\nif (IS_ERR(img->ucode_data)) {\r\nkfree(img->sig);\r\nret = PTR_ERR(img->ucode_data);\r\ngoto free_sig;\r\n}\r\nimg->ucode_size = img->ucode_desc.image_size;\r\nfree_sig:\r\nnvkm_firmware_put(sig);\r\nfree_data:\r\nnvkm_firmware_put(data);\r\nfree_inst:\r\nnvkm_firmware_put(code);\r\nfree_bl:\r\nnvkm_firmware_put(bl);\r\nerror:\r\nreturn ret;\r\n}\r\nint\r\nacr_ls_ucode_load_fecs(const struct nvkm_secboot *sb, struct ls_ucode_img *img)\r\n{\r\nreturn ls_ucode_img_load_gr(&sb->subdev, img, "fecs");\r\n}\r\nint\r\nacr_ls_ucode_load_gpccs(const struct nvkm_secboot *sb, struct ls_ucode_img *img)\r\n{\r\nreturn ls_ucode_img_load_gr(&sb->subdev, img, "gpccs");\r\n}

struct ia_css_host_data *\r\nia_css_params_alloc_convert_sctbl(\r\nconst struct ia_css_pipeline_stage *stage,\r\nconst struct ia_css_shading_table *shading_table)\r\n{\r\nconst struct ia_css_binary *binary = stage->binary;\r\nstruct ia_css_host_data *sctbl;\r\nunsigned int i, j, aligned_width, row_padding;\r\nunsigned int sctbl_size;\r\nshort int *ptr;\r\nassert(binary != NULL);\r\nassert(shading_table != NULL);\r\nIA_CSS_ENTER_PRIVATE("");\r\nif (shading_table == NULL) {\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn NULL;\r\n}\r\naligned_width = binary->sctbl_aligned_width_per_color;\r\nrow_padding = aligned_width - shading_table->width;\r\nsctbl_size = shading_table->height * IA_CSS_SC_NUM_COLORS * aligned_width * sizeof(short);\r\nsctbl = ia_css_host_data_allocate((size_t)sctbl_size);\r\nif (!sctbl)\r\nreturn NULL;\r\nptr = (short int*)sctbl->address;\r\nmemset(ptr,\r\n0,\r\nsctbl_size);\r\nfor (i = 0; i < shading_table->height; i++) {\r\nfor (j = 0; j < IA_CSS_SC_NUM_COLORS; j++) {\r\nmemcpy(ptr,\r\n&shading_table->data[j]\r\n[i*shading_table->width],\r\nshading_table->width * sizeof(short));\r\nptr += aligned_width;\r\n}\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn sctbl;\r\n}\r\nenum ia_css_err ia_css_params_store_sctbl(\r\nconst struct ia_css_pipeline_stage *stage,\r\nhrt_vaddress sc_tbl,\r\nconst struct ia_css_shading_table *sc_config)\r\n{\r\nstruct ia_css_host_data *isp_sc_tbl;\r\nIA_CSS_ENTER_PRIVATE("");\r\nif (sc_config == NULL) {\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nisp_sc_tbl = ia_css_params_alloc_convert_sctbl(stage, sc_config);\r\nif (!isp_sc_tbl) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nia_css_params_store_ia_css_host_data(sc_tbl, isp_sc_tbl);\r\nia_css_host_data_free(isp_sc_tbl);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void\r\nsh_css_enable_pipeline(const struct ia_css_binary *binary)\r\n{\r\nif (!binary)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("");\r\nia_css_isp_param_enable_pipeline(&binary->mem_params);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic enum ia_css_err\r\nia_css_process_zoom_and_motion(\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_pipeline_stage *first_stage)\r\n{\r\nconst struct ia_css_pipeline_stage *stage;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nstruct ia_css_resolution pipe_in_res;\r\npipe_in_res.width = 0;\r\npipe_in_res.height = 0;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("");\r\nfor (stage = first_stage; stage; stage = stage->next) {\r\nstruct ia_css_binary *binary;\r\nstatic struct ia_css_binary tmp_binary;\r\nconst struct ia_css_binary_xinfo *info = NULL;\r\nbinary = stage->binary;\r\nif (binary) {\r\ninfo = binary->info;\r\n} else {\r\nconst struct sh_css_binary_args *args = &stage->args;\r\nconst struct ia_css_frame_info *out_infos[IA_CSS_BINARY_MAX_OUTPUT_PORTS] = {NULL};\r\nif (args->out_frame[0])\r\nout_infos[0] = &args->out_frame[0]->info;\r\ninfo = &stage->firmware->info.isp;\r\nia_css_binary_fill_info(info, false, false,\r\nIA_CSS_STREAM_FORMAT_RAW_10,\r\nargs->in_frame ? &args->in_frame->info : NULL,\r\nNULL,\r\nout_infos,\r\nargs->out_vf_frame ? &args->out_vf_frame->info\r\n: NULL,\r\n&tmp_binary,\r\nNULL,\r\n-1, true);\r\nbinary = &tmp_binary;\r\nbinary->info = info;\r\n}\r\nif (stage == first_stage) {\r\npipe_in_res = binary->effective_in_frame_res;\r\n}\r\nassert(stage->stage_num < SH_CSS_MAX_STAGES);\r\nif (params->dz_config.zoom_region.resolution.width == 0 &&\r\nparams->dz_config.zoom_region.resolution.height == 0) {\r\nsh_css_update_uds_and_crop_info(\r\n&info->sp,\r\n&binary->in_frame_info,\r\n&binary->out_frame_info[0],\r\n&binary->dvs_envelope,\r\n&params->dz_config,\r\n&params->motion_config,\r\n&params->uds[stage->stage_num].uds,\r\n&params->uds[stage->stage_num].crop_pos,\r\nstage->enable_zoom);\r\n} else {\r\nerr = sh_css_update_uds_and_crop_info_based_on_zoom_region(\r\n&info->sp,\r\n&binary->in_frame_info,\r\n&binary->out_frame_info[0],\r\n&binary->dvs_envelope,\r\n&params->dz_config,\r\n&params->motion_config,\r\n&params->uds[stage->stage_num].uds,\r\n&params->uds[stage->stage_num].crop_pos,\r\npipe_in_res,\r\nstage->enable_zoom);\r\nif (err != IA_CSS_SUCCESS)\r\nreturn err;\r\n}\r\n}\r\nparams->isp_params_changed = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn err;\r\n}\r\nstatic void\r\nsh_css_set_gamma_table(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_gamma_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\nparams->gc_table = *table;\r\nparams->config_changed[IA_CSS_GC_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_gamma_table(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_gamma_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\n*table = params->gc_table;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_ctc_table(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_ctc_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\nparams->ctc_table = *table;\r\nparams->config_changed[IA_CSS_CTC_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_ctc_table(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_ctc_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\n*table = params->ctc_table;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_macc_table(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_macc_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\nparams->macc_table = *table;\r\nparams->config_changed[IA_CSS_MACC_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_macc_table(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_macc_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\n*table = params->macc_table;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid ia_css_morph_table_free(\r\nstruct ia_css_morph_table *me)\r\n{\r\nunsigned int i;\r\nif (me == NULL)\r\nreturn;\r\nIA_CSS_ENTER("");\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nif (me->coordinates_x[i]) {\r\nsh_css_free(me->coordinates_x[i]);\r\nme->coordinates_x[i] = NULL;\r\n}\r\nif (me->coordinates_y[i]) {\r\nsh_css_free(me->coordinates_y[i]);\r\nme->coordinates_y[i] = NULL;\r\n}\r\n}\r\nsh_css_free(me);\r\nIA_CSS_LEAVE("void");\r\n}\r\nstruct ia_css_morph_table *ia_css_morph_table_allocate(\r\nunsigned int width,\r\nunsigned int height)\r\n{\r\nunsigned int i;\r\nstruct ia_css_morph_table *me;\r\nIA_CSS_ENTER("");\r\nme = sh_css_malloc(sizeof(*me));\r\nif (me == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nreturn me;\r\n}\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nme->coordinates_x[i] = NULL;\r\nme->coordinates_y[i] = NULL;\r\n}\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nme->coordinates_x[i] =\r\nsh_css_malloc(height * width *\r\nsizeof(*me->coordinates_x[i]));\r\nme->coordinates_y[i] =\r\nsh_css_malloc(height * width *\r\nsizeof(*me->coordinates_y[i]));\r\nif ((me->coordinates_x[i] == NULL) ||\r\n(me->coordinates_y[i] == NULL)) {\r\nia_css_morph_table_free(me);\r\nme = NULL;\r\nreturn me;\r\n}\r\n}\r\nme->width = width;\r\nme->height = height;\r\nIA_CSS_LEAVE("");\r\nreturn me;\r\n}\r\nstatic enum ia_css_err sh_css_params_default_morph_table(\r\nstruct ia_css_morph_table **table,\r\nconst struct ia_css_binary *binary)\r\n{\r\nunsigned int i, j, k, step, width, height;\r\nshort start_x[IA_CSS_MORPH_TABLE_NUM_PLANES] = { -8, 0, -8, 0, 0, -8 },\r\nstart_y[IA_CSS_MORPH_TABLE_NUM_PLANES] = { 0, 0, -8, -8, -8, 0 };\r\nstruct ia_css_morph_table *tab;\r\nassert(table != NULL);\r\nassert(binary != NULL);\r\nIA_CSS_ENTER_PRIVATE("");\r\nstep = (ISP_VEC_NELEMS / 16) * 128,\r\nwidth = binary->morph_tbl_width,\r\nheight = binary->morph_tbl_height;\r\ntab = ia_css_morph_table_allocate(width, height);\r\nif (tab == NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nshort val_y = start_y[i];\r\nfor (j = 0; j < height; j++) {\r\nshort val_x = start_x[i];\r\nunsigned short *x_ptr, *y_ptr;\r\nx_ptr = &tab->coordinates_x[i][j * width];\r\ny_ptr = &tab->coordinates_y[i][j * width];\r\nfor (k = 0; k < width;\r\nk++, x_ptr++, y_ptr++, val_x += (short)step) {\r\nif (k == 0)\r\n*x_ptr = 0;\r\nelse if (k == width - 1)\r\n*x_ptr = val_x + 2 * start_x[i];\r\nelse\r\n*x_ptr = val_x;\r\nif (j == 0)\r\n*y_ptr = 0;\r\nelse\r\n*y_ptr = val_y;\r\n}\r\nval_y += (short)step;\r\n}\r\n}\r\n*table = tab;\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_SUCCESS);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void\r\nsh_css_set_morph_table(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_morph_table *table)\r\n{\r\nif (table == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("table=%p", table);\r\nassert(params != NULL);\r\nif (table->enable == false)\r\ntable = NULL;\r\nparams->morph_table = table;\r\nparams->morph_table_changed = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid\r\nia_css_translate_3a_statistics(\r\nstruct ia_css_3a_statistics *host_stats,\r\nconst struct ia_css_isp_3a_statistics_map *isp_stats)\r\n{\r\nIA_CSS_ENTER("");\r\nif (host_stats->grid.use_dmem) {\r\nIA_CSS_LOG("3A: DMEM");\r\nia_css_s3a_dmem_decode(host_stats, isp_stats->dmem_stats);\r\n} else {\r\nIA_CSS_LOG("3A: VMEM");\r\nia_css_s3a_vmem_decode(host_stats, isp_stats->vmem_stats_hi,\r\nisp_stats->vmem_stats_lo);\r\n}\r\n#if !defined(HAS_NO_HMEM)\r\nIA_CSS_LOG("3A: HMEM");\r\nia_css_s3a_hmem_decode(host_stats, isp_stats->hmem_stats);\r\n#endif\r\nIA_CSS_LEAVE("void");\r\n}\r\nvoid\r\nia_css_isp_3a_statistics_map_free(struct ia_css_isp_3a_statistics_map *me)\r\n{\r\nif (me) {\r\nif (me->data_allocated) {\r\nsh_css_free(me->data_ptr);\r\nme->data_ptr = NULL;\r\nme->data_allocated = false;\r\n}\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_isp_3a_statistics_map *\r\nia_css_isp_3a_statistics_map_allocate(\r\nconst struct ia_css_isp_3a_statistics *isp_stats,\r\nvoid *data_ptr)\r\n{\r\nstruct ia_css_isp_3a_statistics_map *me;\r\nchar *base_ptr;\r\nme = sh_css_malloc(sizeof(*me));\r\nif (!me) {\r\nIA_CSS_LEAVE("cannot allocate memory");\r\ngoto err;\r\n}\r\nme->data_ptr = data_ptr;\r\nme->data_allocated = data_ptr == NULL;\r\nif (!data_ptr) {\r\nme->data_ptr = sh_css_malloc(isp_stats->size);\r\nif (!me->data_ptr) {\r\nIA_CSS_LEAVE("cannot allocate memory");\r\ngoto err;\r\n}\r\n}\r\nbase_ptr = me->data_ptr;\r\nme->size = isp_stats->size;\r\nme->dmem_stats = (void *)base_ptr;\r\nme->vmem_stats_hi = (void *)(base_ptr + isp_stats->dmem_size);\r\nme->vmem_stats_lo = (void *)(base_ptr + isp_stats->dmem_size +\r\nisp_stats->vmem_size);\r\nme->hmem_stats = (void *)(base_ptr + isp_stats->dmem_size +\r\n2 * isp_stats->vmem_size);\r\nIA_CSS_LEAVE("map=%p", me);\r\nreturn me;\r\nerr:\r\nif (me)\r\nsh_css_free(me);\r\nreturn NULL;\r\n}\r\nenum ia_css_err\r\nia_css_get_3a_statistics(struct ia_css_3a_statistics *host_stats,\r\nconst struct ia_css_isp_3a_statistics *isp_stats)\r\n{\r\nstruct ia_css_isp_3a_statistics_map *map;\r\nenum ia_css_err ret = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER("host_stats=%p, isp_stats=%p", host_stats, isp_stats);\r\nassert(host_stats != NULL);\r\nassert(isp_stats != NULL);\r\nmap = ia_css_isp_3a_statistics_map_allocate(isp_stats, NULL);\r\nif (map) {\r\nmmgr_load(isp_stats->data_ptr, map->data_ptr, isp_stats->size);\r\nia_css_translate_3a_statistics(host_stats, map);\r\nia_css_isp_3a_statistics_map_free(map);\r\n} else {\r\nIA_CSS_ERROR("out of memory");\r\nret = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nIA_CSS_LEAVE_ERR(ret);\r\nreturn ret;\r\n}\r\nstatic void\r\nia_css_set_param_exceptions(const struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_parameters *params)\r\n{\r\nassert(params != NULL);\r\nparams->dp_config.gr = params->wb_config.gr;\r\nparams->dp_config.r = params->wb_config.r;\r\nparams->dp_config.b = params->wb_config.b;\r\nparams->dp_config.gb = params->wb_config.gb;\r\n#ifdef ISP2401\r\nassert(pipe != NULL);\r\nassert(pipe->mode < IA_CSS_PIPE_ID_NUM);\r\nif (pipe->mode < IA_CSS_PIPE_ID_NUM) {\r\nparams->pipe_dp_config[pipe->mode].gr = params->wb_config.gr;\r\nparams->pipe_dp_config[pipe->mode].r = params->wb_config.r;\r\nparams->pipe_dp_config[pipe->mode].b = params->wb_config.b;\r\nparams->pipe_dp_config[pipe->mode].gb = params->wb_config.gb;\r\n}\r\n#endif\r\n}\r\nstatic void\r\nsh_css_set_dp_config(const struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_dp_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nassert(pipe != NULL);\r\nassert(pipe->mode < IA_CSS_PIPE_ID_NUM);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\nia_css_dp_debug_dtrace(config, IA_CSS_DEBUG_TRACE_PRIVATE);\r\nif (pipe->mode < IA_CSS_PIPE_ID_NUM) {\r\nparams->pipe_dp_config[pipe->mode] = *config;\r\nparams->pipe_dpc_config_changed[pipe->mode] = true;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_dp_config(const struct ia_css_pipe *pipe,\r\nconst struct ia_css_isp_parameters *params,\r\nstruct ia_css_dp_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nassert(pipe != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\n*config = params->pipe_dp_config[pipe->mode];\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_nr_config(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_nr_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\nia_css_nr_debug_dtrace(config, IA_CSS_DEBUG_TRACE_PRIVATE);\r\nparams->nr_config = *config;\r\nparams->yee_config.nr = *config;\r\nparams->config_changed[IA_CSS_NR_ID] = true;\r\nparams->config_changed[IA_CSS_YEE_ID] = true;\r\nparams->config_changed[IA_CSS_BNR_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_ee_config(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_ee_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\nia_css_ee_debug_dtrace(config, IA_CSS_DEBUG_TRACE_PRIVATE);\r\nparams->ee_config = *config;\r\nparams->yee_config.ee = *config;\r\nparams->config_changed[IA_CSS_YEE_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_ee_config(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_ee_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\nassert(params != NULL);\r\n*config = params->ee_config;\r\nia_css_ee_debug_dtrace(config, IA_CSS_DEBUG_TRACE_PRIVATE);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_pipe_dvs_6axis_config(const struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_dvs_6axis_config *dvs_config)\r\n{\r\nif (dvs_config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nassert(pipe != NULL);\r\nassert(dvs_config->height_y == dvs_config->height_uv);\r\nassert((dvs_config->width_y - 1) == 2 * (dvs_config->width_uv - 1));\r\nassert(pipe->mode < IA_CSS_PIPE_ID_NUM);\r\nIA_CSS_ENTER_PRIVATE("dvs_config=%p", dvs_config);\r\ncopy_dvs_6axis_table(params->pipe_dvs_6axis_config[pipe->mode], dvs_config);\r\n#if !defined(HAS_NO_DVS_6AXIS_CONFIG_UPDATE)\r\nparams->pipe_dvs_6axis_config_changed[pipe->mode] = true;\r\n#endif\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_pipe_dvs_6axis_config(const struct ia_css_pipe *pipe,\r\nconst struct ia_css_isp_parameters *params,\r\nstruct ia_css_dvs_6axis_config *dvs_config)\r\n{\r\nif (dvs_config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nassert(pipe != NULL);\r\nassert(dvs_config->height_y == dvs_config->height_uv);\r\nassert((dvs_config->width_y - 1) == 2 * dvs_config->width_uv - 1);\r\nIA_CSS_ENTER_PRIVATE("dvs_config=%p", dvs_config);\r\nif ((pipe->mode < IA_CSS_PIPE_ID_NUM) &&\r\n(dvs_config->width_y == params->pipe_dvs_6axis_config[pipe->mode]->width_y) &&\r\n(dvs_config->height_y == params->pipe_dvs_6axis_config[pipe->mode]->height_y) &&\r\n(dvs_config->width_uv == params->pipe_dvs_6axis_config[pipe->mode]->width_uv) &&\r\n(dvs_config->height_uv == params->pipe_dvs_6axis_config[pipe->mode]->height_uv) &&\r\ndvs_config->xcoords_y &&\r\ndvs_config->ycoords_y &&\r\ndvs_config->xcoords_uv &&\r\ndvs_config->ycoords_uv)\r\n{\r\ncopy_dvs_6axis_table(dvs_config, params->pipe_dvs_6axis_config[pipe->mode]);\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_baa_config(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_aa_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\nparams->bds_config = *config;\r\nparams->config_changed[IA_CSS_BDS_ID] = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_baa_config(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_aa_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\n*config = params->bds_config;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_set_dz_config(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_dz_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("dx=%d, dy=%d", config->dx, config->dy);\r\nassert(config->dx <= HRT_GDC_N);\r\nassert(config->dy <= HRT_GDC_N);\r\nparams->dz_config = *config;\r\nparams->dz_config_changed = true;\r\nparams->isp_params_changed = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_dz_config(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_dz_config *config)\r\n{\r\nif (config == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("config=%p", config);\r\n*config = params->dz_config;\r\nIA_CSS_LEAVE_PRIVATE("dx=%d, dy=%d", config->dx, config->dy);\r\n}\r\nstatic void\r\nsh_css_set_motion_vector(struct ia_css_isp_parameters *params,\r\nconst struct ia_css_vector *motion)\r\n{\r\nif (motion == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("x=%d, y=%d", motion->x, motion->y);\r\nparams->motion_config = *motion;\r\nparams->motion_config_changed = true;\r\nparams->isp_params_changed = true;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nsh_css_get_motion_vector(const struct ia_css_isp_parameters *params,\r\nstruct ia_css_vector *motion)\r\n{\r\nif (motion == NULL)\r\nreturn;\r\nassert(params != NULL);\r\nIA_CSS_ENTER_PRIVATE("motion=%p", motion);\r\n*motion = params->motion_config;\r\nIA_CSS_LEAVE_PRIVATE("x=%d, y=%d", motion->x, motion->y);\r\n}\r\nstruct ia_css_isp_config *\r\nsh_css_pipe_isp_config_get(struct ia_css_pipe *pipe)\r\n{\r\nif (pipe == NULL)\r\n{\r\nIA_CSS_ERROR("pipe=%p", NULL);\r\nreturn NULL;\r\n}\r\nreturn pipe->config.p_isp_config;\r\n}\r\nenum ia_css_err\r\nia_css_stream_set_isp_config(\r\nstruct ia_css_stream *stream,\r\nconst struct ia_css_isp_config *config)\r\n{\r\nreturn ia_css_stream_set_isp_config_on_pipe(stream, config, NULL);\r\n}\r\nenum ia_css_err\r\nia_css_stream_set_isp_config_on_pipe(\r\nstruct ia_css_stream *stream,\r\nconst struct ia_css_isp_config *config,\r\nstruct ia_css_pipe *pipe)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nif ((stream == NULL) || (config == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nIA_CSS_ENTER("stream=%p, config=%p, pipe=%p", stream, config, pipe);\r\n#if defined(SH_CSS_ENABLE_PER_FRAME_PARAMS)\r\nif (config->output_frame)\r\nerr = sh_css_set_per_frame_isp_config_on_pipe(stream, config, pipe);\r\nelse\r\n#endif\r\nerr = sh_css_set_global_isp_config_on_pipe(stream->pipes[0], config, pipe);\r\nIA_CSS_LEAVE_ERR(err);\r\nreturn err;\r\n}\r\nenum ia_css_err\r\nia_css_pipe_set_isp_config(struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_config *config)\r\n{\r\nstruct ia_css_pipe *pipe_in = pipe;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER("pipe=%p", pipe);\r\nif ((pipe == NULL) || (pipe->stream == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "config=%p\n", config);\r\n#if defined(SH_CSS_ENABLE_PER_FRAME_PARAMS)\r\nif (config->output_frame)\r\nerr = sh_css_set_per_frame_isp_config_on_pipe(pipe->stream, config, pipe);\r\nelse\r\n#endif\r\nerr = sh_css_set_global_isp_config_on_pipe(pipe, config, pipe_in);\r\nIA_CSS_LEAVE_ERR(err);\r\nreturn err;\r\n}\r\nstatic enum ia_css_err\r\nsh_css_set_global_isp_config_on_pipe(\r\nstruct ia_css_pipe *curr_pipe,\r\nconst struct ia_css_isp_config *config,\r\nstruct ia_css_pipe *pipe)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nenum ia_css_err err1 = IA_CSS_SUCCESS;\r\nenum ia_css_err err2 = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER_PRIVATE("stream=%p, config=%p, pipe=%p", curr_pipe, config, pipe);\r\nerr1 = sh_css_init_isp_params_from_config(curr_pipe, curr_pipe->stream->isp_params_configs, config, pipe);\r\nerr2 = sh_css_param_update_isp_params(curr_pipe, curr_pipe->stream->isp_params_configs, sh_css_sp_is_running(), pipe);\r\nerr = (err1 != IA_CSS_SUCCESS ) ? err1 : ((err2 != IA_CSS_SUCCESS) ? err2 : err);\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic enum ia_css_err\r\nsh_css_set_per_frame_isp_config_on_pipe(\r\nstruct ia_css_stream *stream,\r\nconst struct ia_css_isp_config *config,\r\nstruct ia_css_pipe *pipe)\r\n{\r\nunsigned i;\r\nbool per_frame_config_created = false;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nenum ia_css_err err1 = IA_CSS_SUCCESS;\r\nenum ia_css_err err2 = IA_CSS_SUCCESS;\r\nenum ia_css_err err3 = IA_CSS_SUCCESS;\r\nstruct sh_css_ddr_address_map *ddr_ptrs;\r\nstruct sh_css_ddr_address_map_size *ddr_ptrs_size;\r\nstruct ia_css_isp_parameters *params;\r\nIA_CSS_ENTER_PRIVATE("stream=%p, config=%p, pipe=%p", stream, config, pipe);\r\nif (!pipe) {\r\nerr = IA_CSS_ERR_INVALID_ARGUMENTS;\r\ngoto exit;\r\n}\r\nif (!stream->per_frame_isp_params_configs)\r\n{\r\nerr = sh_css_create_isp_params(stream,\r\n&stream->per_frame_isp_params_configs);\r\nif(err != IA_CSS_SUCCESS)\r\ngoto exit;\r\nper_frame_config_created = true;\r\n}\r\nparams = stream->per_frame_isp_params_configs;\r\nif (!sh_css_init_isp_params_from_global(stream, params, false, pipe)) {\r\nerr1 = IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nerr2 = sh_css_init_isp_params_from_config(stream->pipes[0], params, config, pipe);\r\nif (per_frame_config_created)\r\n{\r\nddr_ptrs = &params->ddr_ptrs;\r\nddr_ptrs_size = &params->ddr_ptrs_size;\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nref_sh_css_ddr_address_map(ddr_ptrs, &params->pipe_ddr_ptrs[i]);\r\nparams->pipe_ddr_ptrs_size[i] = *ddr_ptrs_size;\r\n}\r\n}\r\nerr3 = sh_css_param_update_isp_params(stream->pipes[0], params, sh_css_sp_is_running(), pipe);\r\nerr = (err1 != IA_CSS_SUCCESS) ? err1 :\r\n(err2 != IA_CSS_SUCCESS) ? err2 :\r\n(err3 != IA_CSS_SUCCESS) ? err3 : err;\r\nexit:\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic enum ia_css_err\r\nsh_css_init_isp_params_from_config(struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_isp_config *config,\r\nstruct ia_css_pipe *pipe_in)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nbool is_dp_10bpp = true;\r\nassert(pipe != NULL);\r\nIA_CSS_ENTER_PRIVATE("pipe=%p, config=%p, params=%p", pipe, config, params);\r\nia_css_set_configs(params, config);\r\nsh_css_set_nr_config(params, config->nr_config);\r\nsh_css_set_ee_config(params, config->ee_config);\r\nsh_css_set_baa_config(params, config->baa_config);\r\nif ((pipe->mode < IA_CSS_PIPE_ID_NUM) &&\r\n(params->pipe_dvs_6axis_config[pipe->mode]))\r\nsh_css_set_pipe_dvs_6axis_config(pipe, params, config->dvs_6axis_config);\r\nsh_css_set_dz_config(params, config->dz_config);\r\nsh_css_set_motion_vector(params, config->motion_vector);\r\nsh_css_update_shading_table_status(pipe_in, params);\r\nsh_css_set_shading_table(pipe->stream, params, config->shading_table);\r\nsh_css_set_morph_table(params, config->morph_table);\r\nsh_css_set_macc_table(params, config->macc_table);\r\nsh_css_set_gamma_table(params, config->gamma_table);\r\nsh_css_set_ctc_table(params, config->ctc_table);\r\nsh_css_set_shading_settings(params, config->shading_settings);\r\nparams->dis_coef_table_changed = (config->dvs_coefs != NULL);\r\nparams->dvs2_coef_table_changed = (config->dvs2_coefs != NULL);\r\nparams->output_frame = config->output_frame;\r\nparams->isp_parameters_id = config->isp_config_id;\r\n#ifdef ISP2401\r\nsh_css_set_dp_config(pipe, params, config->dp_config);\r\nia_css_set_param_exceptions(pipe, params);\r\n#endif\r\nif (IA_CSS_SUCCESS ==\r\nsh_css_select_dp_10bpp_config(pipe, &is_dp_10bpp)) {\r\nif(is_dp_10bpp) {\r\nerr = IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\n} else {\r\nerr = IA_CSS_ERR_INTERNAL_ERROR;\r\ngoto exit;\r\n}\r\n#ifndef ISP2401\r\nia_css_set_param_exceptions(pipe, params);\r\n#endif\r\nexit:\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nvoid\r\nia_css_stream_get_isp_config(\r\nconst struct ia_css_stream *stream,\r\nstruct ia_css_isp_config *config)\r\n{\r\nIA_CSS_ENTER("void");\r\nia_css_pipe_get_isp_config(stream->pipes[0], config);\r\nIA_CSS_LEAVE("void");\r\n}\r\nvoid\r\nia_css_pipe_get_isp_config(struct ia_css_pipe *pipe,\r\nstruct ia_css_isp_config *config)\r\n{\r\nstruct ia_css_isp_parameters *params = NULL;\r\nassert(config != NULL);\r\nIA_CSS_ENTER("config=%p", config);\r\nparams = pipe->stream->isp_params_configs;\r\nassert(params != NULL);\r\nia_css_get_configs(params, config);\r\nsh_css_get_ee_config(params, config->ee_config);\r\nsh_css_get_baa_config(params, config->baa_config);\r\nsh_css_get_pipe_dvs_6axis_config(pipe, params, config->dvs_6axis_config);\r\nsh_css_get_dp_config(pipe, params, config->dp_config);\r\nsh_css_get_macc_table(params, config->macc_table);\r\nsh_css_get_gamma_table(params, config->gamma_table);\r\nsh_css_get_ctc_table(params, config->ctc_table);\r\nsh_css_get_dz_config(params, config->dz_config);\r\nsh_css_get_motion_vector(params, config->motion_vector);\r\nsh_css_get_shading_settings(params, config->shading_settings);\r\nconfig->output_frame = params->output_frame;\r\nconfig->isp_config_id = params->isp_parameters_id;\r\nIA_CSS_LEAVE("void");\r\n}\r\nstatic bool realloc_isp_css_mm_buf(\r\nhrt_vaddress *curr_buf,\r\nsize_t *curr_size,\r\nsize_t needed_size,\r\nbool force,\r\nenum ia_css_err *err,\r\nuint16_t mmgr_attribute)\r\n{\r\nint32_t id;\r\n*err = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (!force && *curr_size >= needed_size) {\r\nIA_CSS_LEAVE_PRIVATE("false");\r\nreturn false;\r\n}\r\nif (*curr_size == needed_size && ia_css_refcount_is_single(*curr_buf)) {\r\nIA_CSS_LEAVE_PRIVATE("false");\r\nreturn false;\r\n}\r\nid = IA_CSS_REFCOUNT_PARAM_BUFFER;\r\nia_css_refcount_decrement(id, *curr_buf);\r\n*curr_buf = ia_css_refcount_increment(id, mmgr_alloc_attr(needed_size,\r\nmmgr_attribute));\r\nif (!*curr_buf) {\r\n*err = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n*curr_size = 0;\r\n} else {\r\n*curr_size = needed_size;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("true");\r\nreturn true;\r\n}\r\nstatic bool reallocate_buffer(\r\nhrt_vaddress *curr_buf,\r\nsize_t *curr_size,\r\nsize_t needed_size,\r\nbool force,\r\nenum ia_css_err *err)\r\n{\r\nbool ret;\r\nuint16_t mmgr_attribute = MMGR_ATTRIBUTE_DEFAULT;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nret = realloc_isp_css_mm_buf(curr_buf,\r\ncurr_size, needed_size, force, err, mmgr_attribute);\r\nIA_CSS_LEAVE_PRIVATE("ret=%d", ret);\r\nreturn ret;\r\n}\r\nstruct ia_css_isp_3a_statistics *\r\nia_css_isp_3a_statistics_allocate(const struct ia_css_3a_grid_info *grid)\r\n{\r\nstruct ia_css_isp_3a_statistics *me;\r\nIA_CSS_ENTER("grid=%p", grid);\r\nassert(grid != NULL);\r\nif (!grid->enable)\r\nreturn NULL;\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nif (grid->use_dmem) {\r\nme->dmem_size = sizeof(struct ia_css_3a_output) *\r\ngrid->aligned_width *\r\ngrid->aligned_height;\r\n} else {\r\nme->vmem_size = ISP_S3ATBL_HI_LO_STRIDE_BYTES *\r\ngrid->aligned_height;\r\n}\r\n#if !defined(HAS_NO_HMEM)\r\nme->hmem_size = sizeof_hmem(HMEM0_ID);\r\n#endif\r\nme->dmem_size = CEIL_MUL(me->dmem_size, HIVE_ISP_DDR_WORD_BYTES);\r\nme->vmem_size = CEIL_MUL(me->vmem_size, HIVE_ISP_DDR_WORD_BYTES);\r\nme->hmem_size = CEIL_MUL(me->hmem_size, HIVE_ISP_DDR_WORD_BYTES);\r\nme->size = me->dmem_size + me->vmem_size * 2 + me->hmem_size;\r\nme->data_ptr = mmgr_malloc(me->size);\r\nif (me->data_ptr == mmgr_NULL) {\r\nsh_css_free(me);\r\nme = NULL;\r\ngoto err;\r\n}\r\nif (me->dmem_size)\r\nme->data.dmem.s3a_tbl = me->data_ptr;\r\nif (me->vmem_size) {\r\nme->data.vmem.s3a_tbl_hi = me->data_ptr + me->dmem_size;\r\nme->data.vmem.s3a_tbl_lo = me->data_ptr + me->dmem_size + me->vmem_size;\r\n}\r\nif (me->hmem_size)\r\nme->data_hmem.rgby_tbl = me->data_ptr + me->dmem_size + 2 * me->vmem_size;\r\nerr:\r\nIA_CSS_LEAVE("return=%p", me);\r\nreturn me;\r\n}\r\nvoid\r\nia_css_isp_3a_statistics_free(struct ia_css_isp_3a_statistics *me)\r\n{\r\nif (me != NULL) {\r\nhmm_free(me->data_ptr);\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_isp_skc_dvs_statistics *ia_css_skc_dvs_statistics_allocate(void)\r\n{\r\nreturn NULL;\r\n}\r\nstruct ia_css_metadata *\r\nia_css_metadata_allocate(const struct ia_css_metadata_info *metadata_info)\r\n{\r\nstruct ia_css_metadata *md = NULL;\r\nIA_CSS_ENTER("");\r\nif (metadata_info->size == 0)\r\nreturn NULL;\r\nmd = sh_css_malloc(sizeof(*md));\r\nif (md == NULL)\r\ngoto error;\r\nmd->info = *metadata_info;\r\nmd->exp_id = 0;\r\nmd->address = mmgr_malloc(metadata_info->size);\r\nif (md->address == mmgr_NULL)\r\ngoto error;\r\nIA_CSS_LEAVE("return=%p", md);\r\nreturn md;\r\nerror:\r\nia_css_metadata_free(md);\r\nIA_CSS_LEAVE("return=%p", NULL);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_metadata_free(struct ia_css_metadata *me)\r\n{\r\nif (me != NULL) {\r\nIA_CSS_ENTER("me=%p", me);\r\nhmm_free(me->address);\r\nsh_css_free(me);\r\nIA_CSS_LEAVE("void");\r\n}\r\n}\r\nvoid\r\nia_css_metadata_free_multiple(unsigned int num_bufs, struct ia_css_metadata **bufs)\r\n{\r\nunsigned int i;\r\nif (bufs != NULL) {\r\nfor (i = 0; i < num_bufs; i++)\r\nia_css_metadata_free(bufs[i]);\r\n}\r\n}\r\nenum ia_css_err\r\nia_css_stream_isp_parameters_init(struct ia_css_stream *stream)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nunsigned i;\r\nstruct sh_css_ddr_address_map *ddr_ptrs;\r\nstruct sh_css_ddr_address_map_size *ddr_ptrs_size;\r\nstruct ia_css_isp_parameters *params;\r\nassert(stream != NULL);\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (stream == NULL) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_INVALID_ARGUMENTS);\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\ng_param_buffer_dequeue_count = 0;\r\ng_param_buffer_enqueue_count = 0;\r\nstream->per_frame_isp_params_configs = NULL;\r\nerr = sh_css_create_isp_params(stream,\r\n&stream->isp_params_configs);\r\nif(err != IA_CSS_SUCCESS)\r\ngoto ERR;\r\nparams = stream->isp_params_configs;\r\nif (!sh_css_init_isp_params_from_global(stream, params, true, NULL)) {\r\nerr = IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nddr_ptrs = &params->ddr_ptrs;\r\nddr_ptrs_size = &params->ddr_ptrs_size;\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nref_sh_css_ddr_address_map(ddr_ptrs, &params->pipe_ddr_ptrs[i]);\r\nparams->pipe_ddr_ptrs_size[i] = *ddr_ptrs_size;\r\n}\r\nERR:\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic void\r\nia_css_set_sdis_config(\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_dvs_coefficients *dvs_coefs)\r\n{\r\nia_css_set_sdis_horicoef_config(params, dvs_coefs);\r\nia_css_set_sdis_vertcoef_config(params, dvs_coefs);\r\nia_css_set_sdis_horiproj_config(params, dvs_coefs);\r\nia_css_set_sdis_vertproj_config(params, dvs_coefs);\r\n}\r\nstatic void\r\nia_css_set_sdis2_config(\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_dvs2_coefficients *dvs2_coefs)\r\n{\r\nia_css_set_sdis2_horicoef_config(params, dvs2_coefs);\r\nia_css_set_sdis2_vertcoef_config(params, dvs2_coefs);\r\nia_css_set_sdis2_horiproj_config(params, dvs2_coefs);\r\nia_css_set_sdis2_vertproj_config(params, dvs2_coefs);\r\n}\r\nstatic enum ia_css_err\r\nsh_css_create_isp_params(struct ia_css_stream *stream,\r\nstruct ia_css_isp_parameters **isp_params_out)\r\n{\r\nbool succ = true;\r\nunsigned i;\r\nstruct sh_css_ddr_address_map *ddr_ptrs;\r\nstruct sh_css_ddr_address_map_size *ddr_ptrs_size;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nsize_t params_size;\r\nstruct ia_css_isp_parameters *params =\r\nsh_css_malloc(sizeof(struct ia_css_isp_parameters));\r\nif (!params)\r\n{\r\n*isp_params_out = NULL;\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nIA_CSS_ERROR("%s:%d error: cannot allocate memory", __FILE__, __LINE__);\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n} else {\r\nmemset(params, 0, sizeof(struct ia_css_isp_parameters));\r\n}\r\nddr_ptrs = &params->ddr_ptrs;\r\nddr_ptrs_size = &params->ddr_ptrs_size;\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nmemset(&params->pipe_ddr_ptrs[i], 0,\r\nsizeof(params->pipe_ddr_ptrs[i]));\r\nmemset(&params->pipe_ddr_ptrs_size[i], 0,\r\nsizeof(params->pipe_ddr_ptrs_size[i]));\r\n}\r\nmemset(ddr_ptrs, 0, sizeof(*ddr_ptrs));\r\nmemset(ddr_ptrs_size, 0, sizeof(*ddr_ptrs_size));\r\nparams_size = sizeof(params->uds);\r\nddr_ptrs_size->isp_param = params_size;\r\nddr_ptrs->isp_param =\r\nia_css_refcount_increment(IA_CSS_REFCOUNT_PARAM_BUFFER,\r\nmmgr_malloc(params_size));\r\nsucc &= (ddr_ptrs->isp_param != mmgr_NULL);\r\nddr_ptrs_size->macc_tbl = sizeof(struct ia_css_macc_table);\r\nddr_ptrs->macc_tbl =\r\nia_css_refcount_increment(IA_CSS_REFCOUNT_PARAM_BUFFER,\r\nmmgr_malloc(sizeof(struct ia_css_macc_table)));\r\nsucc &= (ddr_ptrs->macc_tbl != mmgr_NULL);\r\n*isp_params_out = params;\r\nreturn err;\r\n}\r\nstatic bool\r\nsh_css_init_isp_params_from_global(struct ia_css_stream *stream,\r\nstruct ia_css_isp_parameters *params,\r\nbool use_default_config,\r\nstruct ia_css_pipe *pipe_in)\r\n{\r\nbool retval = true;\r\nint i = 0;\r\nbool is_dp_10bpp = true;\r\nunsigned isp_pipe_version = ia_css_pipe_get_isp_pipe_version(stream->pipes[0]);\r\nstruct ia_css_isp_parameters *stream_params = stream->isp_params_configs;\r\nif (!use_default_config && !stream_params) {\r\nretval = false;\r\ngoto exit;\r\n}\r\nparams->output_frame = NULL;\r\nparams->isp_parameters_id = 0;\r\nif (use_default_config)\r\n{\r\nia_css_set_xnr3_config(params, &default_xnr3_config);\r\nsh_css_set_nr_config(params, &default_nr_config);\r\nsh_css_set_ee_config(params, &default_ee_config);\r\nif (isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_1)\r\nsh_css_set_macc_table(params, &default_macc_table);\r\nelse if (isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_2_2)\r\nsh_css_set_macc_table(params, &default_macc2_table);\r\nsh_css_set_gamma_table(params, &default_gamma_table);\r\nsh_css_set_ctc_table(params, &default_ctc_table);\r\nsh_css_set_baa_config(params, &default_baa_config);\r\nsh_css_set_dz_config(params, &default_dz_config);\r\nsh_css_set_shading_settings(params, &default_shading_settings);\r\nia_css_set_s3a_config(params, &default_3a_config);\r\nia_css_set_wb_config(params, &default_wb_config);\r\nia_css_set_csc_config(params, &default_cc_config);\r\nia_css_set_tnr_config(params, &default_tnr_config);\r\nia_css_set_ob_config(params, &default_ob_config);\r\nia_css_set_dp_config(params, &default_dp_config);\r\n#ifndef ISP2401\r\nia_css_set_param_exceptions(pipe_in, params);\r\n#else\r\nfor (i = 0; i < stream->num_pipes; i++) {\r\nif (IA_CSS_SUCCESS == sh_css_select_dp_10bpp_config(stream->pipes[i], &is_dp_10bpp)) {\r\nif(is_dp_10bpp) {\r\nsh_css_set_dp_config(stream->pipes[i], params, &default_dp_10bpp_config);\r\n} else {\r\nsh_css_set_dp_config(stream->pipes[i], params, &default_dp_config);\r\n}\r\n} else {\r\nretval = false;\r\ngoto exit;\r\n}\r\nia_css_set_param_exceptions(stream->pipes[i], params);\r\n}\r\n#endif\r\nia_css_set_de_config(params, &default_de_config);\r\nia_css_set_gc_config(params, &default_gc_config);\r\nia_css_set_anr_config(params, &default_anr_config);\r\nia_css_set_anr2_config(params, &default_anr_thres);\r\nia_css_set_ce_config(params, &default_ce_config);\r\nia_css_set_xnr_table_config(params, &default_xnr_table);\r\nia_css_set_ecd_config(params, &default_ecd_config);\r\nia_css_set_ynr_config(params, &default_ynr_config);\r\nia_css_set_fc_config(params, &default_fc_config);\r\nia_css_set_cnr_config(params, &default_cnr_config);\r\nia_css_set_macc_config(params, &default_macc_config);\r\nia_css_set_ctc_config(params, &default_ctc_config);\r\nia_css_set_aa_config(params, &default_aa_config);\r\nia_css_set_r_gamma_config(params, &default_r_gamma_table);\r\nia_css_set_g_gamma_config(params, &default_g_gamma_table);\r\nia_css_set_b_gamma_config(params, &default_b_gamma_table);\r\nia_css_set_yuv2rgb_config(params, &default_yuv2rgb_cc_config);\r\nia_css_set_rgb2yuv_config(params, &default_rgb2yuv_cc_config);\r\nia_css_set_xnr_config(params, &default_xnr_config);\r\nia_css_set_sdis_config(params, &default_sdis_config);\r\nia_css_set_sdis2_config(params, &default_sdis2_config);\r\nia_css_set_formats_config(params, &default_formats_config);\r\nparams->fpn_config.data = NULL;\r\nparams->config_changed[IA_CSS_FPN_ID] = true;\r\nparams->fpn_config.enabled = 0;\r\nparams->motion_config = default_motion_config;\r\nparams->motion_config_changed = true;\r\nparams->morph_table = NULL;\r\nparams->morph_table_changed = true;\r\nparams->sc_table = NULL;\r\nparams->sc_table_changed = true;\r\nparams->sc_table_dirty = false;\r\nparams->sc_table_last_pipe_num = 0;\r\nia_css_sdis2_clear_coefficients(&params->dvs2_coefs);\r\nparams->dvs2_coef_table_changed = true;\r\nia_css_sdis_clear_coefficients(&params->dvs_coefs);\r\nparams->dis_coef_table_changed = true;\r\n#ifdef ISP2401\r\nia_css_tnr3_set_default_config(&params->tnr3_config);\r\n#endif\r\n}\r\nelse\r\n{\r\nia_css_set_xnr3_config(params, &stream_params->xnr3_config);\r\nsh_css_set_nr_config(params, &stream_params->nr_config);\r\nsh_css_set_ee_config(params, &stream_params->ee_config);\r\nif (isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_1)\r\nsh_css_set_macc_table(params, &stream_params->macc_table);\r\nelse if (isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_2_2)\r\nsh_css_set_macc_table(params, &stream_params->macc_table);\r\nsh_css_set_gamma_table(params, &stream_params->gc_table);\r\nsh_css_set_ctc_table(params, &stream_params->ctc_table);\r\nsh_css_set_baa_config(params, &stream_params->bds_config);\r\nsh_css_set_dz_config(params, &stream_params->dz_config);\r\nsh_css_set_shading_settings(params, &stream_params->shading_settings);\r\nia_css_set_s3a_config(params, &stream_params->s3a_config);\r\nia_css_set_wb_config(params, &stream_params->wb_config);\r\nia_css_set_csc_config(params, &stream_params->cc_config);\r\nia_css_set_tnr_config(params, &stream_params->tnr_config);\r\nia_css_set_ob_config(params, &stream_params->ob_config);\r\nia_css_set_dp_config(params, &stream_params->dp_config);\r\nia_css_set_de_config(params, &stream_params->de_config);\r\nia_css_set_gc_config(params, &stream_params->gc_config);\r\nia_css_set_anr_config(params, &stream_params->anr_config);\r\nia_css_set_anr2_config(params, &stream_params->anr_thres);\r\nia_css_set_ce_config(params, &stream_params->ce_config);\r\nia_css_set_xnr_table_config(params, &stream_params->xnr_table);\r\nia_css_set_ecd_config(params, &stream_params->ecd_config);\r\nia_css_set_ynr_config(params, &stream_params->ynr_config);\r\nia_css_set_fc_config(params, &stream_params->fc_config);\r\nia_css_set_cnr_config(params, &stream_params->cnr_config);\r\nia_css_set_macc_config(params, &stream_params->macc_config);\r\nia_css_set_ctc_config(params, &stream_params->ctc_config);\r\nia_css_set_aa_config(params, &stream_params->aa_config);\r\nia_css_set_r_gamma_config(params, &stream_params->r_gamma_table);\r\nia_css_set_g_gamma_config(params, &stream_params->g_gamma_table);\r\nia_css_set_b_gamma_config(params, &stream_params->b_gamma_table);\r\nia_css_set_yuv2rgb_config(params, &stream_params->yuv2rgb_cc_config);\r\nia_css_set_rgb2yuv_config(params, &stream_params->rgb2yuv_cc_config);\r\nia_css_set_xnr_config(params, &stream_params->xnr_config);\r\nia_css_set_formats_config(params, &stream_params->formats_config);\r\nfor (i = 0; i < stream->num_pipes; i++) {\r\nif (IA_CSS_SUCCESS ==\r\nsh_css_select_dp_10bpp_config(stream->pipes[i], &is_dp_10bpp)) {\r\n#ifndef ISP2401\r\nretval = !is_dp_10bpp;\r\n#else\r\nif (is_dp_10bpp) {\r\nretval = false;\r\n}\r\n} else {\r\nretval = false;\r\ngoto exit;\r\n}\r\nif (stream->pipes[i]->mode < IA_CSS_PIPE_ID_NUM) {\r\nsh_css_set_dp_config(stream->pipes[i], params,\r\n&stream_params->pipe_dp_config[stream->pipes[i]->mode]);\r\nia_css_set_param_exceptions(stream->pipes[i], params);\r\n#endif\r\n} else {\r\nretval = false;\r\ngoto exit;\r\n}\r\n}\r\n#ifndef ISP2401\r\nia_css_set_param_exceptions(pipe_in, params);\r\n#endif\r\nparams->fpn_config.data = stream_params->fpn_config.data;\r\nparams->config_changed[IA_CSS_FPN_ID] = stream_params->config_changed[IA_CSS_FPN_ID];\r\nparams->fpn_config.enabled = stream_params->fpn_config.enabled;\r\nsh_css_set_motion_vector(params, &stream_params->motion_config);\r\nsh_css_set_morph_table(params, stream_params->morph_table);\r\nif (stream_params->sc_table) {\r\nsh_css_update_shading_table_status(pipe_in, params);\r\nsh_css_set_shading_table(stream, params, stream_params->sc_table);\r\n}\r\nelse {\r\nparams->sc_table = NULL;\r\nparams->sc_table_changed = true;\r\nparams->sc_table_dirty = false;\r\nparams->sc_table_last_pipe_num = 0;\r\n}\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nif (stream_params->pipe_dvs_6axis_config[i]) {\r\nif (params->pipe_dvs_6axis_config[i]) {\r\ncopy_dvs_6axis_table(params->pipe_dvs_6axis_config[i],\r\nstream_params->pipe_dvs_6axis_config[i]);\r\n} else {\r\nparams->pipe_dvs_6axis_config[i] =\r\ngenerate_dvs_6axis_table_from_config(stream_params->pipe_dvs_6axis_config[i]);\r\n}\r\n}\r\n}\r\nia_css_set_sdis_config(params, &stream_params->dvs_coefs);\r\nparams->dis_coef_table_changed = stream_params->dis_coef_table_changed;\r\nia_css_set_sdis2_config(params, &stream_params->dvs2_coefs);\r\nparams->dvs2_coef_table_changed = stream_params->dvs2_coef_table_changed;\r\nparams->sensor_binning = stream_params->sensor_binning;\r\n}\r\nexit:\r\nreturn retval;\r\n}\r\nenum ia_css_err\r\nsh_css_params_init(void)\r\n{\r\nint i, p;\r\nIA_CSS_ENTER_PRIVATE("void");\r\ng_param_buffer_dequeue_count = 0;\r\ng_param_buffer_enqueue_count = 0;\r\nfor (p = 0; p < IA_CSS_PIPE_ID_NUM; p++) {\r\nfor (i = 0; i < SH_CSS_MAX_STAGES; i++) {\r\nxmem_sp_stage_ptrs[p][i] =\r\nia_css_refcount_increment(-1,\r\nmmgr_calloc(1,\r\nsizeof(struct sh_css_sp_stage)));\r\nxmem_isp_stage_ptrs[p][i] =\r\nia_css_refcount_increment(-1,\r\nmmgr_calloc(1,\r\nsizeof(struct sh_css_isp_stage)));\r\nif ((xmem_sp_stage_ptrs[p][i] == mmgr_NULL) ||\r\n(xmem_isp_stage_ptrs[p][i] == mmgr_NULL)) {\r\nsh_css_params_uninit();\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\n}\r\n}\r\nia_css_config_gamma_table();\r\nia_css_config_ctc_table();\r\nia_css_config_rgb_gamma_tables();\r\nia_css_config_xnr_table();\r\nsp_ddr_ptrs = ia_css_refcount_increment(-1, mmgr_calloc(1,\r\nCEIL_MUL(sizeof(struct sh_css_ddr_address_map),\r\nHIVE_ISP_DDR_WORD_BYTES)));\r\nxmem_sp_group_ptrs = ia_css_refcount_increment(-1, mmgr_calloc(1,\r\nsizeof(struct sh_css_sp_group)));\r\nif ((sp_ddr_ptrs == mmgr_NULL) ||\r\n(xmem_sp_group_ptrs == mmgr_NULL)) {\r\nia_css_uninit();\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_SUCCESS);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void host_lut_store(const void *lut)\r\n{\r\nunsigned i;\r\nfor (i = 0; i < N_GDC_ID; i++)\r\ngdc_lut_store((gdc_ID_t)i, (const int (*)[HRT_GDC_N]) lut);\r\n}\r\ninline hrt_vaddress sh_css_params_alloc_gdc_lut(void)\r\n{\r\nreturn mmgr_malloc(sizeof(zoom_table));\r\n}\r\ninline void sh_css_params_free_gdc_lut(hrt_vaddress addr)\r\n{\r\nif (addr != mmgr_NULL)\r\nhmm_free(addr);\r\n}\r\nhrt_vaddress sh_css_pipe_get_pp_gdc_lut(const struct ia_css_pipe *pipe)\r\n{\r\nassert(pipe != NULL);\r\nif (pipe->scaler_pp_lut != mmgr_NULL)\r\nreturn pipe->scaler_pp_lut;\r\nelse\r\nreturn sh_css_params_get_default_gdc_lut();\r\n}\r\nenum ia_css_err sh_css_params_map_and_store_default_gdc_lut(void)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (default_gdc_lut != mmgr_NULL)\r\nreturn err;\r\nhost_lut_store((void *)zoom_table);\r\n#ifndef ISP2401\r\ndefault_gdc_lut = mmgr_malloc(sizeof(zoom_table));\r\n#else\r\ndefault_gdc_lut = sh_css_params_alloc_gdc_lut();\r\n#endif\r\nif (default_gdc_lut == mmgr_NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngdc_lut_convert_to_isp_format((const int(*)[HRT_GDC_N])zoom_table,\r\ninterleaved_lut_temp);\r\nmmgr_store(default_gdc_lut, (int *)interleaved_lut_temp,\r\nsizeof(zoom_table));\r\nIA_CSS_LEAVE_PRIVATE("lut(%u) err=%d", default_gdc_lut, err);\r\nreturn err;\r\n}\r\nvoid sh_css_params_free_default_gdc_lut(void)\r\n{\r\nIA_CSS_ENTER_PRIVATE("void");\r\nsh_css_params_free_gdc_lut(default_gdc_lut);\r\ndefault_gdc_lut = mmgr_NULL;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nhrt_vaddress sh_css_params_get_default_gdc_lut(void)\r\n{\r\nreturn default_gdc_lut;\r\n}\r\nstatic void free_param_set_callback(\r\nhrt_vaddress ptr)\r\n{\r\nIA_CSS_ENTER_PRIVATE("void");\r\nfree_ia_css_isp_parameter_set_info(ptr);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void free_buffer_callback(\r\nhrt_vaddress ptr)\r\n{\r\nIA_CSS_ENTER_PRIVATE("void");\r\nhmm_free(ptr);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid\r\nsh_css_param_clear_param_sets(void)\r\n{\r\nIA_CSS_ENTER_PRIVATE("void");\r\nia_css_refcount_clear(IA_CSS_REFCOUNT_PARAM_SET_POOL, &free_param_set_callback);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void free_map(struct sh_css_ddr_address_map *map)\r\n{\r\nunsigned int i;\r\nhrt_vaddress *addrs = (hrt_vaddress *)map;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nfor (i = 0; i < (sizeof(struct sh_css_ddr_address_map_size)/\r\nsizeof(size_t)); i++) {\r\nif (addrs[i] == mmgr_NULL)\r\ncontinue;\r\nsafe_free(IA_CSS_REFCOUNT_PARAM_BUFFER, addrs[i]);\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid\r\nia_css_stream_isp_parameters_uninit(struct ia_css_stream *stream)\r\n{\r\nint i;\r\nstruct ia_css_isp_parameters *params = stream->isp_params_configs;\r\nstruct ia_css_isp_parameters *per_frame_params =\r\nstream->per_frame_isp_params_configs;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (params == NULL) {\r\nIA_CSS_LEAVE_PRIVATE("isp_param_configs is NULL");\r\nreturn;\r\n}\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++)\r\n{\r\nfree_map(&params->pipe_ddr_ptrs[i]);\r\nif (per_frame_params)\r\nfree_map(&per_frame_params->pipe_ddr_ptrs[i]);\r\nif (params->pipe_dvs_6axis_config[i])\r\nfree_dvs_6axis_table(&(params->pipe_dvs_6axis_config[i]));\r\nif (per_frame_params && per_frame_params->pipe_dvs_6axis_config[i])\r\nfree_dvs_6axis_table(&(per_frame_params->pipe_dvs_6axis_config[i]));\r\n}\r\nfree_map(&params->ddr_ptrs);\r\nif (per_frame_params)\r\nfree_map(&per_frame_params->ddr_ptrs);\r\nif (params->fpn_config.data) {\r\nsh_css_free(params->fpn_config.data);\r\nparams->fpn_config.data = NULL;\r\n}\r\nif (params->sc_config) {\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\nif (per_frame_params) {\r\nif (per_frame_params->sc_config) {\r\nia_css_shading_table_free(per_frame_params->sc_config);\r\nper_frame_params->sc_config = NULL;\r\n}\r\n}\r\nsh_css_free(params);\r\nif (per_frame_params)\r\nsh_css_free(per_frame_params);\r\nstream->isp_params_configs = NULL;\r\nstream->per_frame_isp_params_configs = NULL;\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid\r\nsh_css_params_uninit(void)\r\n{\r\nunsigned p, i;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nia_css_refcount_decrement(-1, sp_ddr_ptrs);\r\nsp_ddr_ptrs = mmgr_NULL;\r\nia_css_refcount_decrement(-1, xmem_sp_group_ptrs);\r\nxmem_sp_group_ptrs = mmgr_NULL;\r\nfor (p = 0; p < IA_CSS_PIPE_ID_NUM; p++)\r\nfor (i = 0; i < SH_CSS_MAX_STAGES; i++) {\r\nia_css_refcount_decrement(-1, xmem_sp_stage_ptrs[p][i]);\r\nxmem_sp_stage_ptrs[p][i] = mmgr_NULL;\r\nia_css_refcount_decrement(-1, xmem_isp_stage_ptrs[p][i]);\r\nxmem_isp_stage_ptrs[p][i] = mmgr_NULL;\r\n}\r\nia_css_refcount_clear(IA_CSS_REFCOUNT_PARAM_SET_POOL, &free_param_set_callback);\r\nia_css_refcount_clear(IA_CSS_REFCOUNT_PARAM_BUFFER, &free_buffer_callback);\r\nia_css_refcount_clear(-1, &free_buffer_callback);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic struct ia_css_host_data *\r\nconvert_allocate_morph_plane(\r\nunsigned short *data,\r\nunsigned int width,\r\nunsigned int height,\r\nunsigned int aligned_width)\r\n{\r\nunsigned int i, j, padding, w;\r\nstruct ia_css_host_data *me;\r\nunsigned int isp_data_size;\r\nuint16_t *isp_data_ptr;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (width > aligned_width) {\r\npadding = 0;\r\nw = aligned_width;\r\n} else {\r\npadding = aligned_width - width;\r\nw = width;\r\n}\r\nisp_data_size = height * (w + padding) * sizeof(uint16_t);\r\nme = ia_css_host_data_allocate((size_t) isp_data_size);\r\nif (!me) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn NULL;\r\n}\r\nisp_data_ptr = (uint16_t *)me->address;\r\nmemset(isp_data_ptr, 0, (size_t)isp_data_size);\r\nfor (i = 0; i < height; i++) {\r\nfor (j = 0; j < w; j++)\r\n*isp_data_ptr++ = (uint16_t)data[j];\r\nisp_data_ptr += padding;\r\ndata += width;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn me;\r\n}\r\nstatic enum ia_css_err\r\nstore_morph_plane(\r\nunsigned short *data,\r\nunsigned int width,\r\nunsigned int height,\r\nhrt_vaddress dest,\r\nunsigned int aligned_width)\r\n{\r\nstruct ia_css_host_data *isp_data;\r\nassert(dest != mmgr_NULL);\r\nisp_data = convert_allocate_morph_plane(data, width, height, aligned_width);\r\nif (!isp_data) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nia_css_params_store_ia_css_host_data(dest, isp_data);\r\nia_css_host_data_free(isp_data);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void sh_css_update_isp_params_to_ddr(\r\nstruct ia_css_isp_parameters *params,\r\nhrt_vaddress ddr_ptr)\r\n{\r\nsize_t size = sizeof(params->uds);\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(params != NULL);\r\nmmgr_store(ddr_ptr, &(params->uds), size);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void sh_css_update_isp_mem_params_to_ddr(\r\nconst struct ia_css_binary *binary,\r\nhrt_vaddress ddr_mem_ptr,\r\nsize_t size,\r\nenum ia_css_isp_memories mem)\r\n{\r\nconst struct ia_css_host_data *params;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nparams = ia_css_isp_param_get_mem_init(&binary->mem_params, IA_CSS_PARAM_CLASS_PARAM, mem);\r\nmmgr_store(ddr_mem_ptr, params->address, size);\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid ia_css_dequeue_param_buffers( void)\r\n{\r\nunsigned int i;\r\nhrt_vaddress cpy;\r\nenum sh_css_queue_id param_queue_ids[3] = { IA_CSS_PARAMETER_SET_QUEUE_ID,\r\nIA_CSS_PER_FRAME_PARAMETER_SET_QUEUE_ID,\r\nSH_CSS_INVALID_QUEUE_ID};\r\nIA_CSS_ENTER_PRIVATE("void");\r\nif (!sh_css_sp_is_running()) {\r\nIA_CSS_LEAVE_PRIVATE("sp is not running");\r\nreturn;\r\n}\r\nfor (i = 0; SH_CSS_INVALID_QUEUE_ID != param_queue_ids[i]; i++) {\r\ncpy = (hrt_vaddress)0;\r\nwhile (IA_CSS_SUCCESS == ia_css_bufq_dequeue_buffer(param_queue_ids[i], (uint32_t *)&cpy)) {\r\ng_param_buffer_dequeue_count++;\r\nia_css_bufq_enqueue_psys_event(\r\nIA_CSS_PSYS_SW_EVENT_BUFFER_DEQUEUED,\r\n0,\r\nparam_queue_ids[i],\r\n0);\r\nIA_CSS_LOG("dequeued param set %x from %d, release ref", cpy, 0);\r\nfree_ia_css_isp_parameter_set_info(cpy);\r\ncpy = (hrt_vaddress)0;\r\n}\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic void\r\nprocess_kernel_parameters(unsigned int pipe_id,\r\nstruct ia_css_pipeline_stage *stage,\r\nstruct ia_css_isp_parameters *params,\r\nunsigned int isp_pipe_version,\r\nunsigned int raw_bit_depth)\r\n{\r\nunsigned param_id;\r\n(void)isp_pipe_version;\r\n(void)raw_bit_depth;\r\nsh_css_enable_pipeline(stage->binary);\r\nif (params->config_changed[IA_CSS_OB_ID]) {\r\nia_css_ob_configure(&params->stream_configs.ob,\r\nisp_pipe_version, raw_bit_depth);\r\n}\r\nif (params->config_changed[IA_CSS_S3A_ID]) {\r\nia_css_s3a_configure(raw_bit_depth);\r\n}\r\nparams->crop_config.crop_pos = params->uds[stage->stage_num].crop_pos;\r\nparams->uds_config.crop_pos = params->uds[stage->stage_num].crop_pos;\r\nparams->uds_config.uds = params->uds[stage->stage_num].uds;\r\nfor (param_id = 0; param_id < IA_CSS_NUM_PARAMETER_IDS; param_id++) {\r\nif (param_id == IA_CSS_SC_ID) continue;\r\nif (params->config_changed[param_id])\r\nia_css_kernel_process_param[param_id](pipe_id, stage, params);\r\n}\r\n}\r\nenum ia_css_err\r\nsh_css_param_update_isp_params(struct ia_css_pipe *curr_pipe,\r\nstruct ia_css_isp_parameters *params,\r\nbool commit,\r\nstruct ia_css_pipe *pipe_in)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nhrt_vaddress cpy;\r\nint i;\r\nunsigned int raw_bit_depth = 10;\r\nunsigned int isp_pipe_version = SH_CSS_ISP_PIPE_VERSION_1;\r\nbool acc_cluster_params_changed = false;\r\nunsigned int thread_id, pipe_num;\r\n(void)acc_cluster_params_changed;\r\nassert(curr_pipe != NULL);\r\nIA_CSS_ENTER_PRIVATE("pipe=%p, isp_parameters_id=%d", pipe_in, params->isp_parameters_id);\r\nraw_bit_depth = ia_css_stream_input_format_bits_per_pixel(curr_pipe->stream);\r\nif (!commit) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nfor (i = 0; i < curr_pipe->stream->num_pipes; i++) {\r\nstruct ia_css_pipe *pipe;\r\nstruct sh_css_ddr_address_map *cur_map;\r\nstruct sh_css_ddr_address_map_size *cur_map_size;\r\nstruct ia_css_isp_parameter_set_info isp_params_info;\r\nstruct ia_css_pipeline *pipeline;\r\nstruct ia_css_pipeline_stage *stage;\r\nenum sh_css_queue_id queue_id;\r\n(void)stage;\r\npipe = curr_pipe->stream->pipes[i];\r\npipeline = ia_css_pipe_get_pipeline(pipe);\r\npipe_num = ia_css_pipe_get_pipe_num(pipe);\r\nisp_pipe_version = ia_css_pipe_get_isp_pipe_version(pipe);\r\nia_css_pipeline_get_sp_thread_id(pipe_num, &thread_id);\r\n#if defined(SH_CSS_ENABLE_PER_FRAME_PARAMS)\r\nia_css_query_internal_queue_id(params->output_frame\r\n? IA_CSS_BUFFER_TYPE_PER_FRAME_PARAMETER_SET\r\n: IA_CSS_BUFFER_TYPE_PARAMETER_SET,\r\nthread_id, &queue_id);\r\n#else\r\nia_css_query_internal_queue_id(IA_CSS_BUFFER_TYPE_PARAMETER_SET, thread_id, &queue_id);\r\n#endif\r\nif (!sh_css_sp_is_running()) {\r\nerr = IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\nbreak;\r\n}\r\ncur_map = &params->pipe_ddr_ptrs[pipeline->pipe_id];\r\ncur_map_size = &params->pipe_ddr_ptrs_size[pipeline->pipe_id];\r\n{\r\nerr = ia_css_process_zoom_and_motion(params,\r\npipeline->stages);\r\nif (err != IA_CSS_SUCCESS)\r\nreturn err;\r\n}\r\nif (pipe_in && (pipe != pipe_in)) {\r\nIA_CSS_LOG("skipping pipe %p", pipe);\r\ncontinue;\r\n}\r\nfor (stage = pipeline->stages; stage; stage = stage->next) {\r\nunsigned mem;\r\nif (!stage || !stage->binary)\r\ncontinue;\r\nprocess_kernel_parameters(pipeline->pipe_id,\r\nstage, params,\r\nisp_pipe_version, raw_bit_depth);\r\nerr = sh_css_params_write_to_ddr_internal(\r\npipe,\r\npipeline->pipe_id,\r\nparams,\r\nstage,\r\ncur_map,\r\ncur_map_size);\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\r\nparams->isp_mem_params_changed\r\n[pipeline->pipe_id][stage->stage_num][mem] = false;\r\n}\r\n}\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nif (params->isp_params_changed) {\r\nreallocate_buffer(&cur_map->isp_param,\r\n&cur_map_size->isp_param,\r\ncur_map_size->isp_param,\r\ntrue,\r\n&err);\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nsh_css_update_isp_params_to_ddr(params, cur_map->isp_param);\r\n}\r\nerr = ref_sh_css_ddr_address_map(\r\ncur_map,\r\n&isp_params_info.mem_map);\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nisp_params_info.isp_parameters_id = params->isp_parameters_id;\r\nisp_params_info.output_frame_ptr =\r\n(params->output_frame) ? params->output_frame->data : mmgr_NULL;\r\nerr = write_ia_css_isp_parameter_set_info_to_ddr(&isp_params_info, &cpy);\r\nif (err != IA_CSS_SUCCESS)\r\nbreak;\r\nIA_CSS_LOG("queue param set %x to %d", cpy, thread_id);\r\nerr = ia_css_bufq_enqueue_buffer(thread_id, queue_id, (uint32_t)cpy);\r\nif (IA_CSS_SUCCESS != err) {\r\nfree_ia_css_isp_parameter_set_info(cpy);\r\n#if defined(SH_CSS_ENABLE_PER_FRAME_PARAMS)\r\nIA_CSS_LOG("pfp: FAILED to add config id %d for OF %d to q %d on thread %d",\r\nisp_params_info.isp_parameters_id,\r\nisp_params_info.output_frame_ptr,\r\nqueue_id, thread_id);\r\n#endif\r\nbreak;\r\n}\r\nelse {\r\ng_param_buffer_enqueue_count++;\r\nassert(g_param_buffer_enqueue_count < g_param_buffer_dequeue_count+50);\r\n#ifdef ISP2401\r\nia_css_save_latest_paramset_ptr(pipe, cpy);\r\n#endif\r\nif (!sh_css_sp_is_running()) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_RESOURCE_NOT_AVAILABLE);\r\nreturn IA_CSS_ERR_RESOURCE_NOT_AVAILABLE;\r\n}\r\nia_css_bufq_enqueue_psys_event(\r\nIA_CSS_PSYS_SW_EVENT_BUFFER_ENQUEUED,\r\n(uint8_t)thread_id,\r\n(uint8_t)queue_id,\r\n0);\r\n#if defined(SH_CSS_ENABLE_PER_FRAME_PARAMS)\r\nIA_CSS_LOG("pfp: added config id %d for OF %d to q %d on thread %d",\r\nisp_params_info.isp_parameters_id,\r\nisp_params_info.output_frame_ptr,\r\nqueue_id, thread_id);\r\n#endif\r\n}\r\nia_css_dequeue_param_buffers();\r\nparams->pipe_dvs_6axis_config_changed[pipeline->pipe_id] = false;\r\n}\r\nparams->isp_params_changed = false;\r\nparams->sc_table_changed = false;\r\nparams->dis_coef_table_changed = false;\r\nparams->dvs2_coef_table_changed = false;\r\nparams->morph_table_changed = false;\r\nparams->dz_config_changed = false;\r\nparams->motion_config_changed = false;\r\nparams->shading_settings_changed = false;\r\nmemset(&params->config_changed[0], 0, sizeof(params->config_changed));\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic enum ia_css_err\r\nsh_css_params_write_to_ddr_internal(\r\nstruct ia_css_pipe *pipe,\r\nunsigned pipe_id,\r\nstruct ia_css_isp_parameters *params,\r\nconst struct ia_css_pipeline_stage *stage,\r\nstruct sh_css_ddr_address_map *ddr_map,\r\nstruct sh_css_ddr_address_map_size *ddr_map_size)\r\n{\r\nenum ia_css_err err;\r\nconst struct ia_css_binary *binary;\r\nunsigned stage_num;\r\nunsigned mem;\r\nbool buff_realloced;\r\nstatic struct ia_css_macc_table converted_macc_table;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(params != NULL);\r\nassert(ddr_map != NULL);\r\nassert(ddr_map_size != NULL);\r\nassert(stage != NULL);\r\nbinary = stage->binary;\r\nassert(binary != NULL);\r\nstage_num = stage->stage_num;\r\nif (binary->info->sp.enable.fpnr) {\r\nbuff_realloced = reallocate_buffer(&ddr_map->fpn_tbl,\r\n&ddr_map_size->fpn_tbl,\r\n(size_t)(FPNTBL_BYTES(binary)),\r\nparams->config_changed[IA_CSS_FPN_ID],\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nif (params->config_changed[IA_CSS_FPN_ID] || buff_realloced) {\r\nif (params->fpn_config.enabled) {\r\nerr = store_fpntbl(params, ddr_map->fpn_tbl);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\n}\r\n}\r\n}\r\nif (binary->info->sp.enable.sc) {\r\nuint32_t enable_conv = params->\r\nshading_settings.enable_shading_table_conversion;\r\nbuff_realloced = reallocate_buffer(&ddr_map->sc_tbl,\r\n&ddr_map_size->sc_tbl,\r\n(size_t)(SCTBL_BYTES(binary)),\r\nparams->sc_table_changed,\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nif (params->shading_settings_changed ||\r\nparams->sc_table_changed || buff_realloced) {\r\nif (enable_conv == 0) {\r\nif (params->sc_table) {\r\nerr = ia_css_params_store_sctbl(stage, ddr_map->sc_tbl, params->sc_table);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nparams->sc_config = (struct ia_css_shading_table *)params->sc_table;\r\nia_css_kernel_process_param[IA_CSS_SC_ID](pipe_id, stage, params);\r\nparams->sc_config = NULL;\r\n} else {\r\nif (params->sc_config) {\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\n#ifndef ISP2401\r\nsh_css_params_shading_id_table_generate(&params->sc_config, binary);\r\n#else\r\nsh_css_params_shading_id_table_generate(&params->sc_config,\r\nbinary->sctbl_width_per_color, binary->sctbl_height);\r\n#endif\r\nif (params->sc_config == NULL) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nerr = ia_css_params_store_sctbl(stage, ddr_map->sc_tbl, params->sc_config);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nia_css_kernel_process_param[IA_CSS_SC_ID](pipe_id, stage, params);\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\n} else {\r\nif (params->sc_config) {\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\nprepare_shading_table(\r\n(const struct ia_css_shading_table *)params->sc_table,\r\nparams->sensor_binning,\r\n&params->sc_config,\r\nbinary, pipe->required_bds_factor);\r\nif (params->sc_config == NULL) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nerr = ia_css_params_store_sctbl(stage, ddr_map->sc_tbl, params->sc_config);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nia_css_kernel_process_param[IA_CSS_SC_ID](pipe_id, stage, params);\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\n}\r\n}\r\n#ifdef ISP2401\r\nif (params->pipe_dpc_config_changed[pipe_id] && binary->info->sp.enable.dpc) {\r\nunsigned size = stage->binary->info->mem_offsets.offsets.param->dmem.dp.size;\r\nunsigned offset = stage->binary->info->mem_offsets.offsets.param->dmem.dp.offset;\r\nif (size) {\r\nia_css_dp_encode((struct sh_css_isp_dp_params *)\r\n&binary->mem_params.params[IA_CSS_PARAM_CLASS_PARAM][IA_CSS_ISP_DMEM].address[offset],\r\n&params->pipe_dp_config[pipe_id], size);\r\n#endif\r\n#ifdef ISP2401\r\nparams->isp_params_changed = true;\r\nparams->isp_mem_params_changed[pipe_id][stage->stage_num][IA_CSS_ISP_DMEM] = true;\r\n}\r\n}\r\n#endif\r\nif (params->config_changed[IA_CSS_MACC_ID] && binary->info->sp.enable.macc) {\r\nunsigned int i, j, idx;\r\nunsigned int idx_map[] = {\r\n0, 1, 3, 2, 6, 7, 5, 4, 12, 13, 15, 14, 10, 11, 9, 8};\r\nfor (i = 0; i < IA_CSS_MACC_NUM_AXES; i++) {\r\nidx = 4*idx_map[i];\r\nj = 4*i;\r\nif (binary->info->sp.pipeline.isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_1) {\r\nconverted_macc_table.data[idx] =\r\n(int16_t)sDIGIT_FITTING(params->macc_table.data[j],\r\n13, SH_CSS_MACC_COEF_SHIFT);\r\nconverted_macc_table.data[idx+1] =\r\n(int16_t)sDIGIT_FITTING(params->macc_table.data[j+1],\r\n13, SH_CSS_MACC_COEF_SHIFT);\r\nconverted_macc_table.data[idx+2] =\r\n(int16_t)sDIGIT_FITTING(params->macc_table.data[j+2],\r\n13, SH_CSS_MACC_COEF_SHIFT);\r\nconverted_macc_table.data[idx+3] =\r\n(int16_t)sDIGIT_FITTING(params->macc_table.data[j+3],\r\n13, SH_CSS_MACC_COEF_SHIFT);\r\n} else if (binary->info->sp.pipeline.isp_pipe_version == SH_CSS_ISP_PIPE_VERSION_2_2) {\r\nconverted_macc_table.data[idx] =\r\nparams->macc_table.data[j];\r\nconverted_macc_table.data[idx+1] =\r\nparams->macc_table.data[j+1];\r\nconverted_macc_table.data[idx+2] =\r\nparams->macc_table.data[j+2];\r\nconverted_macc_table.data[idx+3] =\r\nparams->macc_table.data[j+3];\r\n}\r\n}\r\nreallocate_buffer(&ddr_map->macc_tbl,\r\n&ddr_map_size->macc_tbl,\r\nddr_map_size->macc_tbl,\r\ntrue,\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nmmgr_store(ddr_map->macc_tbl,\r\nconverted_macc_table.data,\r\nsizeof(converted_macc_table.data));\r\n}\r\nif (binary->info->sp.enable.dvs_6axis) {\r\nbuff_realloced = reallocate_buffer(\r\n&ddr_map->dvs_6axis_params_y,\r\n&ddr_map_size->dvs_6axis_params_y,\r\n(size_t)((DVS_6AXIS_BYTES(binary) / 2) * 3),\r\nparams->pipe_dvs_6axis_config_changed[pipe_id],\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nif (params->pipe_dvs_6axis_config_changed[pipe_id] || buff_realloced) {\r\nconst struct ia_css_frame_info *dvs_in_frame_info;\r\nif ( stage->args.delay_frames[0] ) {\r\ndvs_in_frame_info = &stage->args.delay_frames[0]->info;\r\n} else {\r\ndvs_in_frame_info = &stage->args.in_frame->info;\r\n}\r\nif (params->pipe_dvs_6axis_config[pipe_id] == NULL) {\r\n#ifndef ISP2401\r\nstruct ia_css_resolution dvs_offset;\r\ndvs_offset.width =\r\n#else\r\nstruct ia_css_resolution dvs_offset = {0, 0};\r\nif (binary->dvs_envelope.width || binary->dvs_envelope.height) {\r\ndvs_offset.width =\r\n#endif\r\n(PIX_SHIFT_FILTER_RUN_IN_X + binary->dvs_envelope.width) / 2;\r\n#ifndef ISP2401\r\ndvs_offset.height =\r\n#else\r\ndvs_offset.height =\r\n#endif\r\n(PIX_SHIFT_FILTER_RUN_IN_Y + binary->dvs_envelope.height) / 2;\r\n#ifdef ISP2401\r\n}\r\n#endif\r\nparams->pipe_dvs_6axis_config[pipe_id] =\r\ngenerate_dvs_6axis_table(&binary->out_frame_info[0].res, &dvs_offset);\r\nif (params->pipe_dvs_6axis_config[pipe_id] == NULL) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY);\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nparams->pipe_dvs_6axis_config_changed[pipe_id] = true;\r\n}\r\nstore_dvs_6axis_config(params->pipe_dvs_6axis_config[pipe_id],\r\nbinary,\r\ndvs_in_frame_info,\r\nddr_map->dvs_6axis_params_y);\r\nparams->isp_params_changed = true;\r\n}\r\n}\r\nif (binary->info->sp.enable.ca_gdc) {\r\nunsigned int i;\r\nhrt_vaddress *virt_addr_tetra_x[\r\nIA_CSS_MORPH_TABLE_NUM_PLANES];\r\nsize_t *virt_size_tetra_x[\r\nIA_CSS_MORPH_TABLE_NUM_PLANES];\r\nhrt_vaddress *virt_addr_tetra_y[\r\nIA_CSS_MORPH_TABLE_NUM_PLANES];\r\nsize_t *virt_size_tetra_y[\r\nIA_CSS_MORPH_TABLE_NUM_PLANES];\r\nvirt_addr_tetra_x[0] = &ddr_map->tetra_r_x;\r\nvirt_addr_tetra_x[1] = &ddr_map->tetra_gr_x;\r\nvirt_addr_tetra_x[2] = &ddr_map->tetra_gb_x;\r\nvirt_addr_tetra_x[3] = &ddr_map->tetra_b_x;\r\nvirt_addr_tetra_x[4] = &ddr_map->tetra_ratb_x;\r\nvirt_addr_tetra_x[5] = &ddr_map->tetra_batr_x;\r\nvirt_size_tetra_x[0] = &ddr_map_size->tetra_r_x;\r\nvirt_size_tetra_x[1] = &ddr_map_size->tetra_gr_x;\r\nvirt_size_tetra_x[2] = &ddr_map_size->tetra_gb_x;\r\nvirt_size_tetra_x[3] = &ddr_map_size->tetra_b_x;\r\nvirt_size_tetra_x[4] = &ddr_map_size->tetra_ratb_x;\r\nvirt_size_tetra_x[5] = &ddr_map_size->tetra_batr_x;\r\nvirt_addr_tetra_y[0] = &ddr_map->tetra_r_y;\r\nvirt_addr_tetra_y[1] = &ddr_map->tetra_gr_y;\r\nvirt_addr_tetra_y[2] = &ddr_map->tetra_gb_y;\r\nvirt_addr_tetra_y[3] = &ddr_map->tetra_b_y;\r\nvirt_addr_tetra_y[4] = &ddr_map->tetra_ratb_y;\r\nvirt_addr_tetra_y[5] = &ddr_map->tetra_batr_y;\r\nvirt_size_tetra_y[0] = &ddr_map_size->tetra_r_y;\r\nvirt_size_tetra_y[1] = &ddr_map_size->tetra_gr_y;\r\nvirt_size_tetra_y[2] = &ddr_map_size->tetra_gb_y;\r\nvirt_size_tetra_y[3] = &ddr_map_size->tetra_b_y;\r\nvirt_size_tetra_y[4] = &ddr_map_size->tetra_ratb_y;\r\nvirt_size_tetra_y[5] = &ddr_map_size->tetra_batr_y;\r\nbuff_realloced = false;\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nbuff_realloced |=\r\nreallocate_buffer(virt_addr_tetra_x[i],\r\nvirt_size_tetra_x[i],\r\n(size_t)\r\n(MORPH_PLANE_BYTES(binary)),\r\nparams->morph_table_changed,\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nbuff_realloced |=\r\nreallocate_buffer(virt_addr_tetra_y[i],\r\nvirt_size_tetra_y[i],\r\n(size_t)\r\n(MORPH_PLANE_BYTES(binary)),\r\nparams->morph_table_changed,\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\n}\r\nif (params->morph_table_changed || buff_realloced) {\r\nconst struct ia_css_morph_table *table = params->morph_table;\r\nstruct ia_css_morph_table *id_table = NULL;\r\nif ((table != NULL) &&\r\n(table->width < binary->morph_tbl_width ||\r\ntable->height < binary->morph_tbl_height)) {\r\ntable = NULL;\r\n}\r\nif (table == NULL) {\r\nerr = sh_css_params_default_morph_table(&id_table,\r\nbinary);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\ntable = id_table;\r\n}\r\nfor (i = 0; i < IA_CSS_MORPH_TABLE_NUM_PLANES; i++) {\r\nstore_morph_plane(table->coordinates_x[i],\r\ntable->width,\r\ntable->height,\r\n*virt_addr_tetra_x[i],\r\nbinary->morph_tbl_aligned_width);\r\nstore_morph_plane(table->coordinates_y[i],\r\ntable->width,\r\ntable->height,\r\n*virt_addr_tetra_y[i],\r\nbinary->morph_tbl_aligned_width);\r\n}\r\nif (id_table != NULL)\r\nia_css_morph_table_free(id_table);\r\n}\r\n}\r\nfor (mem = 0; mem < N_IA_CSS_MEMORIES; mem++) {\r\nconst struct ia_css_isp_data *isp_data =\r\nia_css_isp_param_get_isp_mem_init(&binary->info->sp.mem_initializers, IA_CSS_PARAM_CLASS_PARAM, mem);\r\nsize_t size = isp_data->size;\r\nif (!size) continue;\r\nbuff_realloced = reallocate_buffer(&ddr_map->isp_mem_param[stage_num][mem],\r\n&ddr_map_size->isp_mem_param[stage_num][mem],\r\nsize,\r\nparams->isp_mem_params_changed[pipe_id][stage_num][mem],\r\n&err);\r\nif (err != IA_CSS_SUCCESS) {\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nif (params->isp_mem_params_changed[pipe_id][stage_num][mem] || buff_realloced) {\r\nsh_css_update_isp_mem_params_to_ddr(binary,\r\nddr_map->isp_mem_param[stage_num][mem],\r\nddr_map_size->isp_mem_param[stage_num][mem], mem);\r\n}\r\n}\r\nIA_CSS_LEAVE_ERR_PRIVATE(IA_CSS_SUCCESS);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nconst struct ia_css_fpn_table *ia_css_get_fpn_table(struct ia_css_stream *stream)\r\n{\r\nstruct ia_css_isp_parameters *params;\r\nIA_CSS_ENTER_LEAVE("void");\r\nassert(stream != NULL);\r\nparams = stream->isp_params_configs;\r\nreturn &(params->fpn_config);\r\n}\r\nstruct ia_css_shading_table *ia_css_get_shading_table(struct ia_css_stream *stream)\r\n{\r\nstruct ia_css_shading_table *table = NULL;\r\nstruct ia_css_isp_parameters *params;\r\nIA_CSS_ENTER("void");\r\nassert(stream != NULL);\r\nparams = stream->isp_params_configs;\r\nif (!params)\r\nreturn NULL;\r\nif (params->shading_settings.enable_shading_table_conversion == 0) {\r\nif (params->sc_table) {\r\ntable = (struct ia_css_shading_table *)params->sc_table;\r\n} else {\r\nconst struct ia_css_binary *binary\r\n= ia_css_stream_get_shading_correction_binary(stream);\r\nif (binary) {\r\nif (params->sc_config) {\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\n#ifndef ISP2401\r\nsh_css_params_shading_id_table_generate(&params->sc_config, binary);\r\n#else\r\nsh_css_params_shading_id_table_generate(&params->sc_config,\r\nbinary->sctbl_width_per_color, binary->sctbl_height);\r\n#endif\r\ntable = params->sc_config;\r\n}\r\n}\r\n} else {\r\nconst struct ia_css_binary *binary\r\n= ia_css_stream_get_shading_correction_binary(stream);\r\nstruct ia_css_pipe *pipe;\r\npipe = stream->pipes[0];\r\nif (stream->num_pipes == 2) {\r\nassert(stream->pipes[1] != NULL);\r\nif (stream->pipes[1]->config.mode == IA_CSS_PIPE_MODE_VIDEO ||\r\nstream->pipes[1]->config.mode == IA_CSS_PIPE_MODE_PREVIEW)\r\npipe = stream->pipes[1];\r\n}\r\nif (binary) {\r\nif (params->sc_config) {\r\nia_css_shading_table_free(params->sc_config);\r\nparams->sc_config = NULL;\r\n}\r\nprepare_shading_table(\r\n(const struct ia_css_shading_table *)params->sc_table,\r\nparams->sensor_binning,\r\n&params->sc_config,\r\nbinary, pipe->required_bds_factor);\r\ntable = params->sc_config;\r\n}\r\n}\r\nIA_CSS_LEAVE("table=%p", table);\r\nreturn table;\r\n}\r\nhrt_vaddress sh_css_store_sp_group_to_ddr(void)\r\n{\r\nIA_CSS_ENTER_LEAVE_PRIVATE("void");\r\nmmgr_store(xmem_sp_group_ptrs,\r\n&sh_css_sp_group,\r\nsizeof(struct sh_css_sp_group));\r\nreturn xmem_sp_group_ptrs;\r\n}\r\nhrt_vaddress sh_css_store_sp_stage_to_ddr(\r\nunsigned pipe,\r\nunsigned stage)\r\n{\r\nIA_CSS_ENTER_LEAVE_PRIVATE("void");\r\nmmgr_store(xmem_sp_stage_ptrs[pipe][stage],\r\n&sh_css_sp_stage,\r\nsizeof(struct sh_css_sp_stage));\r\nreturn xmem_sp_stage_ptrs[pipe][stage];\r\n}\r\nhrt_vaddress sh_css_store_isp_stage_to_ddr(\r\nunsigned pipe,\r\nunsigned stage)\r\n{\r\nIA_CSS_ENTER_LEAVE_PRIVATE("void");\r\nmmgr_store(xmem_isp_stage_ptrs[pipe][stage],\r\n&sh_css_isp_stage,\r\nsizeof(struct sh_css_isp_stage));\r\nreturn xmem_isp_stage_ptrs[pipe][stage];\r\n}\r\nstatic enum ia_css_err ref_sh_css_ddr_address_map(\r\nstruct sh_css_ddr_address_map *map,\r\nstruct sh_css_ddr_address_map *out)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nunsigned int i;\r\nunion {\r\nstruct sh_css_ddr_address_map *map;\r\nhrt_vaddress *addrs;\r\n} in_addrs, to_addrs;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(map != NULL);\r\nassert(out != NULL);\r\nin_addrs.map = map;\r\nto_addrs.map = out;\r\nassert(sizeof(struct sh_css_ddr_address_map_size)/sizeof(size_t) ==\r\nsizeof(struct sh_css_ddr_address_map)/sizeof(hrt_vaddress));\r\nfor (i = 0; i < (sizeof(struct sh_css_ddr_address_map_size)/\r\nsizeof(size_t)); i++) {\r\nif (in_addrs.addrs[i] == mmgr_NULL)\r\nto_addrs.addrs[i] = mmgr_NULL;\r\nelse\r\nto_addrs.addrs[i] = ia_css_refcount_increment(IA_CSS_REFCOUNT_PARAM_BUFFER, in_addrs.addrs[i]);\r\n}\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nstatic enum ia_css_err write_ia_css_isp_parameter_set_info_to_ddr(\r\nstruct ia_css_isp_parameter_set_info *me,\r\nhrt_vaddress *out)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nbool succ;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(me != NULL);\r\nassert(out != NULL);\r\n*out = ia_css_refcount_increment(IA_CSS_REFCOUNT_PARAM_SET_POOL, mmgr_malloc(\r\nsizeof(struct ia_css_isp_parameter_set_info)));\r\nsucc = (*out != mmgr_NULL);\r\nif (succ)\r\nmmgr_store(*out,\r\nme, sizeof(struct ia_css_isp_parameter_set_info));\r\nelse\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nIA_CSS_LEAVE_ERR_PRIVATE(err);\r\nreturn err;\r\n}\r\nvoid\r\nsh_css_invalidate_params(struct ia_css_stream *stream)\r\n{\r\nstruct ia_css_isp_parameters *params;\r\nunsigned i, j, mem;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(stream != NULL);\r\nparams = stream->isp_params_configs;\r\nparams->isp_params_changed = true;\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nfor (j = 0; j < SH_CSS_MAX_STAGES; j++) {\r\nfor (mem = 0; mem < N_IA_CSS_MEMORIES; mem++) {\r\nparams->isp_mem_params_changed[i][j][mem] = true;\r\n}\r\n}\r\n}\r\nmemset(&params->config_changed[0], 1, sizeof(params->config_changed));\r\nparams->dis_coef_table_changed = true;\r\nparams->dvs2_coef_table_changed = true;\r\nparams->morph_table_changed = true;\r\nparams->sc_table_changed = true;\r\nparams->dz_config_changed = true;\r\nparams->motion_config_changed = true;\r\nfor (i = 0; i < IA_CSS_PIPE_ID_NUM; i++) {\r\nif (params->pipe_dvs_6axis_config[i]) {\r\nfree_dvs_6axis_table(&(params->pipe_dvs_6axis_config[i]));\r\nparams->pipe_dvs_6axis_config_changed[i] = true;\r\n}\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nvoid\r\nsh_css_update_uds_and_crop_info(\r\nconst struct ia_css_binary_info *info,\r\nconst struct ia_css_frame_info *in_frame_info,\r\nconst struct ia_css_frame_info *out_frame_info,\r\nconst struct ia_css_resolution *dvs_env,\r\nconst struct ia_css_dz_config *zoom,\r\nconst struct ia_css_vector *motion_vector,\r\nstruct sh_css_uds_info *uds,\r\nstruct sh_css_crop_pos *sp_out_crop_pos,\r\nbool enable_zoom)\r\n{\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(info != NULL);\r\nassert(in_frame_info != NULL);\r\nassert(out_frame_info != NULL);\r\nassert(dvs_env != NULL);\r\nassert(zoom != NULL);\r\nassert(motion_vector != NULL);\r\nassert(uds != NULL);\r\nassert(sp_out_crop_pos != NULL);\r\nuds->curr_dx = enable_zoom ? (uint16_t)zoom->dx : HRT_GDC_N;\r\nuds->curr_dy = enable_zoom ? (uint16_t)zoom->dy : HRT_GDC_N;\r\nif (info->enable.dvs_envelope) {\r\nunsigned int crop_x = 0,\r\ncrop_y = 0,\r\nuds_xc = 0,\r\nuds_yc = 0,\r\nenv_width, env_height;\r\nint half_env_x, half_env_y;\r\nint motion_x = motion_vector->x;\r\nint motion_y = motion_vector->y;\r\nbool upscale_x = in_frame_info->res.width < out_frame_info->res.width;\r\nbool upscale_y = in_frame_info->res.height < out_frame_info->res.height;\r\nif (info->enable.uds && !info->enable.ds) {\r\nenv_width = dvs_env->width -\r\nSH_CSS_MIN_DVS_ENVELOPE;\r\nenv_height = dvs_env->height -\r\nSH_CSS_MIN_DVS_ENVELOPE;\r\nhalf_env_x = env_width / 2;\r\nhalf_env_y = env_height / 2;\r\nif (upscale_x) {\r\nuds_xc = (in_frame_info->res.width\r\n+ env_width\r\n+ SH_CSS_MIN_DVS_ENVELOPE) / 2;\r\n} else {\r\nuds_xc = (out_frame_info->res.width\r\n+ env_width) / 2\r\n+ SH_CSS_MIN_DVS_ENVELOPE;\r\n}\r\nif (upscale_y) {\r\nuds_yc = (in_frame_info->res.height\r\n+ env_height\r\n+ SH_CSS_MIN_DVS_ENVELOPE) / 2;\r\n} else {\r\nuds_yc = (out_frame_info->res.height\r\n+ env_height) / 2\r\n+ SH_CSS_MIN_DVS_ENVELOPE;\r\n}\r\nmotion_x = clamp(motion_x, -half_env_x, half_env_x);\r\nmotion_y = clamp(motion_y, -half_env_y, half_env_y);\r\nuds_xc += motion_x;\r\nuds_yc += motion_y;\r\ncrop_y = 2;\r\n} else if (info->enable.ds) {\r\nenv_width = dvs_env->width;\r\nenv_height = dvs_env->height;\r\nhalf_env_x = env_width / 2;\r\nhalf_env_y = env_height / 2;\r\nmotion_x = clamp(motion_x, -half_env_x, half_env_x);\r\nmotion_y = clamp(motion_y, -half_env_y, half_env_y);\r\nuds_xc = in_frame_info->res.width/2 + motion_x;\r\nuds_yc = in_frame_info->res.height/2 + motion_y;\r\ncrop_x = info->pipeline.left_cropping;\r\nif (info->enable.ds & 1)\r\ncrop_y = info->pipeline.top_cropping;\r\nelse\r\ncrop_y = 2;\r\n} else {\r\nenv_width = dvs_env->width -\r\nSH_CSS_MIN_DVS_ENVELOPE;\r\nenv_height = dvs_env->height -\r\nSH_CSS_MIN_DVS_ENVELOPE;\r\nhalf_env_x = env_width / 2;\r\nhalf_env_y = env_height / 2;\r\nmotion_x = clamp(motion_x, -half_env_x, half_env_x);\r\nmotion_y = clamp(motion_y, -half_env_y, half_env_y);\r\ncrop_x = SH_CSS_MIN_DVS_ENVELOPE\r\n+ half_env_x + motion_x;\r\ncrop_y = SH_CSS_MIN_DVS_ENVELOPE\r\n+ half_env_y + motion_y;\r\n}\r\ncrop_x = EVEN_FLOOR(crop_x);\r\ncrop_y = EVEN_FLOOR(crop_y);\r\nuds_xc = EVEN_FLOOR(uds_xc);\r\nuds_yc = EVEN_FLOOR(uds_yc);\r\nuds->xc = (uint16_t)uds_xc;\r\nuds->yc = (uint16_t)uds_yc;\r\nsp_out_crop_pos->x = (uint16_t)crop_x;\r\nsp_out_crop_pos->y = (uint16_t)crop_y;\r\n}\r\nelse {\r\nuds->xc = (uint16_t)in_frame_info->res.width / 2;\r\nuds->yc = (uint16_t)in_frame_info->res.height / 2;\r\nsp_out_crop_pos->x = (uint16_t)info->pipeline.left_cropping;\r\nsp_out_crop_pos->y = (uint16_t)info->pipeline.top_cropping;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nstatic enum ia_css_err\r\nsh_css_update_uds_and_crop_info_based_on_zoom_region(\r\nconst struct ia_css_binary_info *info,\r\nconst struct ia_css_frame_info *in_frame_info,\r\nconst struct ia_css_frame_info *out_frame_info,\r\nconst struct ia_css_resolution *dvs_env,\r\nconst struct ia_css_dz_config *zoom,\r\nconst struct ia_css_vector *motion_vector,\r\nstruct sh_css_uds_info *uds,\r\nstruct sh_css_crop_pos *sp_out_crop_pos,\r\nstruct ia_css_resolution pipe_in_res,\r\nbool enable_zoom)\r\n{\r\nunsigned int x0 = 0, y0 = 0, x1 = 0, y1 = 0;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nunsigned int filter_envelope = 0;\r\nIA_CSS_ENTER_PRIVATE("void");\r\nassert(info != NULL);\r\nassert(in_frame_info != NULL);\r\nassert(out_frame_info != NULL);\r\nassert(dvs_env != NULL);\r\nassert(zoom != NULL);\r\nassert(motion_vector != NULL);\r\nassert(uds != NULL);\r\nassert(sp_out_crop_pos != NULL);\r\nx0 = zoom->zoom_region.origin.x;\r\ny0 = zoom->zoom_region.origin.y;\r\nx1 = zoom->zoom_region.resolution.width + x0;\r\ny1 = zoom->zoom_region.resolution.height + y0;\r\nif ((x0 > x1) || (y0 > y1) || (x1 > pipe_in_res.width) || (y1 > pipe_in_res.height))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nif (!enable_zoom) {\r\nuds->curr_dx = HRT_GDC_N;\r\nuds->curr_dy = HRT_GDC_N;\r\n}\r\nif (info->enable.dvs_envelope) {\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n} else {\r\nif (enable_zoom) {\r\nif (in_frame_info->res.width != pipe_in_res.width ||\r\nin_frame_info->res.height != pipe_in_res.height) {\r\nx0 = (x0 * in_frame_info->res.width) / (pipe_in_res.width);\r\ny0 = (y0 * in_frame_info->res.height) / (pipe_in_res.height);\r\nx1 = (x1 * in_frame_info->res.width) / (pipe_in_res.width);\r\ny1 = (y1 * in_frame_info->res.height) / (pipe_in_res.height);\r\n}\r\nuds->curr_dx =\r\n((x1 - x0 - filter_envelope) * HRT_GDC_N) / in_frame_info->res.width;\r\nuds->curr_dy =\r\n((y1 - y0 - filter_envelope) * HRT_GDC_N) / in_frame_info->res.height;\r\nuds->xc = (uint16_t) x0 + (((x1)-(x0)) / 2);\r\nuds->yc = (uint16_t) y0 + (((y1)-(y0)) / 2);\r\n} else {\r\nuds->xc = (uint16_t)in_frame_info->res.width / 2;\r\nuds->yc = (uint16_t)in_frame_info->res.height / 2;\r\n}\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "uds->curr_dx=%d, uds->xc=%d, uds->yc=%d\n",\r\nuds->curr_dx, uds->xc, uds->yc);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "x0=%d, y0=%d, x1=%d, y1=%d\n",\r\nx0, y0, x1, y1);\r\nsp_out_crop_pos->x = (uint16_t)info->pipeline.left_cropping;\r\nsp_out_crop_pos->y = (uint16_t)info->pipeline.top_cropping;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\nreturn err;\r\n}\r\nstruct ia_css_3a_statistics *\r\nia_css_3a_statistics_allocate(const struct ia_css_3a_grid_info *grid)\r\n{\r\nstruct ia_css_3a_statistics *me;\r\nint grid_size;\r\nIA_CSS_ENTER("grid=%p", grid);\r\nassert(grid != NULL);\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nme->grid = *grid;\r\ngrid_size = grid->width * grid->height;\r\nme->data = sh_css_malloc(grid_size * sizeof(*me->data));\r\nif (!me->data)\r\ngoto err;\r\n#if !defined(HAS_NO_HMEM)\r\nme->rgby_data = (struct ia_css_3a_rgby_output *)sh_css_malloc(sizeof_hmem(HMEM0_ID));\r\n#else\r\nme->rgby_data = NULL;\r\n#endif\r\nIA_CSS_LEAVE("return=%p", me);\r\nreturn me;\r\nerr:\r\nia_css_3a_statistics_free(me);\r\nIA_CSS_LEAVE("return=%p", NULL);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_3a_statistics_free(struct ia_css_3a_statistics *me)\r\n{\r\nif (me) {\r\nsh_css_free(me->rgby_data);\r\nsh_css_free(me->data);\r\nmemset(me, 0, sizeof(struct ia_css_3a_statistics));\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_dvs_statistics *\r\nia_css_dvs_statistics_allocate(const struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_dvs_statistics *me;\r\nassert(grid != NULL);\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nme->grid = *grid;\r\nme->hor_proj = sh_css_malloc(grid->height * IA_CSS_DVS_NUM_COEF_TYPES *\r\nsizeof(*me->hor_proj));\r\nif (!me->hor_proj)\r\ngoto err;\r\nme->ver_proj = sh_css_malloc(grid->width * IA_CSS_DVS_NUM_COEF_TYPES *\r\nsizeof(*me->ver_proj));\r\nif (!me->ver_proj)\r\ngoto err;\r\nreturn me;\r\nerr:\r\nia_css_dvs_statistics_free(me);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_dvs_statistics_free(struct ia_css_dvs_statistics *me)\r\n{\r\nif (me) {\r\nsh_css_free(me->hor_proj);\r\nsh_css_free(me->ver_proj);\r\nmemset(me, 0, sizeof(struct ia_css_dvs_statistics));\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_dvs_coefficients *\r\nia_css_dvs_coefficients_allocate(const struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_dvs_coefficients *me;\r\nassert(grid != NULL);\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nme->grid = *grid;\r\nme->hor_coefs = sh_css_malloc(grid->num_hor_coefs *\r\nIA_CSS_DVS_NUM_COEF_TYPES *\r\nsizeof(*me->hor_coefs));\r\nif (!me->hor_coefs)\r\ngoto err;\r\nme->ver_coefs = sh_css_malloc(grid->num_ver_coefs *\r\nIA_CSS_DVS_NUM_COEF_TYPES *\r\nsizeof(*me->ver_coefs));\r\nif (!me->ver_coefs)\r\ngoto err;\r\nreturn me;\r\nerr:\r\nia_css_dvs_coefficients_free(me);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_dvs_coefficients_free(struct ia_css_dvs_coefficients *me)\r\n{\r\nif (me) {\r\nsh_css_free(me->hor_coefs);\r\nsh_css_free(me->ver_coefs);\r\nmemset(me, 0, sizeof(struct ia_css_dvs_coefficients));\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_dvs2_statistics *\r\nia_css_dvs2_statistics_allocate(const struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_dvs2_statistics *me;\r\nassert(grid != NULL);\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nme->grid = *grid;\r\nme->hor_prod.odd_real = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->hor_prod.odd_real));\r\nif (!me->hor_prod.odd_real)\r\ngoto err;\r\nme->hor_prod.odd_imag = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->hor_prod.odd_imag));\r\nif (!me->hor_prod.odd_imag)\r\ngoto err;\r\nme->hor_prod.even_real = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->hor_prod.even_real));\r\nif (!me->hor_prod.even_real)\r\ngoto err;\r\nme->hor_prod.even_imag = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->hor_prod.even_imag));\r\nif (!me->hor_prod.even_imag)\r\ngoto err;\r\nme->ver_prod.odd_real = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->ver_prod.odd_real));\r\nif (!me->ver_prod.odd_real)\r\ngoto err;\r\nme->ver_prod.odd_imag = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->ver_prod.odd_imag));\r\nif (!me->ver_prod.odd_imag)\r\ngoto err;\r\nme->ver_prod.even_real = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->ver_prod.even_real));\r\nif (!me->ver_prod.even_real)\r\ngoto err;\r\nme->ver_prod.even_imag = sh_css_malloc(grid->aligned_width *\r\ngrid->aligned_height * sizeof(*me->ver_prod.even_imag));\r\nif (!me->ver_prod.even_imag)\r\ngoto err;\r\nreturn me;\r\nerr:\r\nia_css_dvs2_statistics_free(me);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_dvs2_statistics_free(struct ia_css_dvs2_statistics *me)\r\n{\r\nif (me) {\r\nsh_css_free(me->hor_prod.odd_real);\r\nsh_css_free(me->hor_prod.odd_imag);\r\nsh_css_free(me->hor_prod.even_real);\r\nsh_css_free(me->hor_prod.even_imag);\r\nsh_css_free(me->ver_prod.odd_real);\r\nsh_css_free(me->ver_prod.odd_imag);\r\nsh_css_free(me->ver_prod.even_real);\r\nsh_css_free(me->ver_prod.even_imag);\r\nmemset(me, 0, sizeof(struct ia_css_dvs2_statistics));\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_dvs2_coefficients *\r\nia_css_dvs2_coefficients_allocate(const struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_dvs2_coefficients *me;\r\nassert(grid != NULL);\r\nme = sh_css_calloc(1, sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nme->grid = *grid;\r\nme->hor_coefs.odd_real = sh_css_malloc(grid->num_hor_coefs *\r\nsizeof(*me->hor_coefs.odd_real));\r\nif (!me->hor_coefs.odd_real)\r\ngoto err;\r\nme->hor_coefs.odd_imag = sh_css_malloc(grid->num_hor_coefs *\r\nsizeof(*me->hor_coefs.odd_imag));\r\nif (!me->hor_coefs.odd_imag)\r\ngoto err;\r\nme->hor_coefs.even_real = sh_css_malloc(grid->num_hor_coefs *\r\nsizeof(*me->hor_coefs.even_real));\r\nif (!me->hor_coefs.even_real)\r\ngoto err;\r\nme->hor_coefs.even_imag = sh_css_malloc(grid->num_hor_coefs *\r\nsizeof(*me->hor_coefs.even_imag));\r\nif (!me->hor_coefs.even_imag)\r\ngoto err;\r\nme->ver_coefs.odd_real = sh_css_malloc(grid->num_ver_coefs *\r\nsizeof(*me->ver_coefs.odd_real));\r\nif (!me->ver_coefs.odd_real)\r\ngoto err;\r\nme->ver_coefs.odd_imag = sh_css_malloc(grid->num_ver_coefs *\r\nsizeof(*me->ver_coefs.odd_imag));\r\nif (!me->ver_coefs.odd_imag)\r\ngoto err;\r\nme->ver_coefs.even_real = sh_css_malloc(grid->num_ver_coefs *\r\nsizeof(*me->ver_coefs.even_real));\r\nif (!me->ver_coefs.even_real)\r\ngoto err;\r\nme->ver_coefs.even_imag = sh_css_malloc(grid->num_ver_coefs *\r\nsizeof(*me->ver_coefs.even_imag));\r\nif (!me->ver_coefs.even_imag)\r\ngoto err;\r\nreturn me;\r\nerr:\r\nia_css_dvs2_coefficients_free(me);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_dvs2_coefficients_free(struct ia_css_dvs2_coefficients *me)\r\n{\r\nif (me) {\r\nsh_css_free(me->hor_coefs.odd_real);\r\nsh_css_free(me->hor_coefs.odd_imag);\r\nsh_css_free(me->hor_coefs.even_real);\r\nsh_css_free(me->hor_coefs.even_imag);\r\nsh_css_free(me->ver_coefs.odd_real);\r\nsh_css_free(me->ver_coefs.odd_imag);\r\nsh_css_free(me->ver_coefs.even_real);\r\nsh_css_free(me->ver_coefs.even_imag);\r\nmemset(me, 0, sizeof(struct ia_css_dvs2_coefficients));\r\nsh_css_free(me);\r\n}\r\n}\r\nstruct ia_css_dvs_6axis_config *\r\nia_css_dvs2_6axis_config_allocate(const struct ia_css_stream *stream)\r\n{\r\nstruct ia_css_dvs_6axis_config *dvs_config = NULL;\r\nstruct ia_css_isp_parameters *params = NULL;\r\nunsigned int width_y;\r\nunsigned int height_y;\r\nunsigned int width_uv;\r\nunsigned int height_uv;\r\nassert(stream != NULL);\r\nparams = stream->isp_params_configs;\r\nif (!params || (params && !params->pipe_dvs_6axis_config[IA_CSS_PIPE_ID_VIDEO])) {\r\ngoto err;\r\n}\r\ndvs_config = (struct ia_css_dvs_6axis_config *)sh_css_calloc(1, sizeof(struct ia_css_dvs_6axis_config));\r\nif (!dvs_config)\r\ngoto err;\r\ndvs_config->width_y = width_y = params->pipe_dvs_6axis_config[IA_CSS_PIPE_ID_VIDEO]->width_y;\r\ndvs_config->height_y = height_y = params->pipe_dvs_6axis_config[IA_CSS_PIPE_ID_VIDEO]->height_y;\r\ndvs_config->width_uv = width_uv = params->pipe_dvs_6axis_config[IA_CSS_PIPE_ID_VIDEO]->width_uv;\r\ndvs_config->height_uv = height_uv = params->pipe_dvs_6axis_config[IA_CSS_PIPE_ID_VIDEO]->height_uv;\r\nIA_CSS_LOG("table Y: W %d H %d", width_y, height_y);\r\nIA_CSS_LOG("table UV: W %d H %d", width_uv, height_uv);\r\ndvs_config->xcoords_y = (uint32_t *)sh_css_malloc(width_y * height_y * sizeof(uint32_t));\r\nif (!dvs_config->xcoords_y)\r\ngoto err;\r\ndvs_config->ycoords_y = (uint32_t *)sh_css_malloc(width_y * height_y * sizeof(uint32_t));\r\nif (!dvs_config->ycoords_y)\r\ngoto err;\r\ndvs_config->xcoords_uv = (uint32_t *)sh_css_malloc(width_uv * height_uv * sizeof(uint32_t));\r\nif (!dvs_config->xcoords_uv)\r\ngoto err;\r\ndvs_config->ycoords_uv = (uint32_t *)sh_css_malloc(width_uv * height_uv * sizeof(uint32_t));\r\nif (!dvs_config->ycoords_uv)\r\ngoto err;\r\nreturn dvs_config;\r\nerr:\r\nia_css_dvs2_6axis_config_free(dvs_config);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_dvs2_6axis_config_free(struct ia_css_dvs_6axis_config *dvs_6axis_config)\r\n{\r\nif (dvs_6axis_config) {\r\nsh_css_free(dvs_6axis_config->xcoords_y);\r\nsh_css_free(dvs_6axis_config->ycoords_y);\r\nsh_css_free(dvs_6axis_config->xcoords_uv);\r\nsh_css_free(dvs_6axis_config->ycoords_uv);\r\nmemset(dvs_6axis_config, 0, sizeof(struct ia_css_dvs_6axis_config));\r\nsh_css_free(dvs_6axis_config);\r\n}\r\n}\r\nvoid\r\nia_css_en_dz_capt_pipe(struct ia_css_stream *stream, bool enable)\r\n{\r\nstruct ia_css_pipe *pipe;\r\nstruct ia_css_pipeline *pipeline;\r\nstruct ia_css_pipeline_stage *stage;\r\nenum ia_css_pipe_id pipe_id;\r\nenum ia_css_err err;\r\nint i;\r\nif (stream == NULL)\r\nreturn;\r\nfor (i = 0; i < stream->num_pipes; i++) {\r\npipe = stream->pipes[i];\r\npipeline = ia_css_pipe_get_pipeline(pipe);\r\npipe_id = pipeline->pipe_id;\r\nif (pipe_id == IA_CSS_PIPE_ID_CAPTURE) {\r\nerr = ia_css_pipeline_get_stage(pipeline, IA_CSS_BINARY_MODE_CAPTURE_PP, &stage);\r\nif (err == IA_CSS_SUCCESS)\r\nstage->enable_zoom = enable;\r\nbreak;\r\n}\r\n}\r\n}

u32\r\nnvbios_cstepTe(struct nvkm_bios *bios,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len, u8 *xnr, u8 *xsz)\r\n{\r\nstruct bit_entry bit_P;\r\nu32 cstep = 0;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2 && bit_P.length >= 0x38)\r\ncstep = nvbios_rd32(bios, bit_P.offset + 0x34);\r\nif (cstep) {\r\n*ver = nvbios_rd08(bios, cstep + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\n*hdr = nvbios_rd08(bios, cstep + 1);\r\n*cnt = nvbios_rd08(bios, cstep + 3);\r\n*len = nvbios_rd08(bios, cstep + 2);\r\n*xnr = nvbios_rd08(bios, cstep + 5);\r\n*xsz = nvbios_rd08(bios, cstep + 4);\r\nreturn cstep;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_cstepEe(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr)\r\n{\r\nu8 cnt, len, xnr, xsz;\r\nu32 data = nvbios_cstepTe(bios, ver, hdr, &cnt, &len, &xnr, &xsz);\r\nif (data && idx < cnt) {\r\ndata = data + *hdr + (idx * len);\r\n*hdr = len;\r\nreturn data;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_cstepEp(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr,\r\nstruct nvbios_cstepE *info)\r\n{\r\nu32 data = nvbios_cstepEe(bios, idx, ver, hdr);\r\nmemset(info, 0x00, sizeof(*info));\r\nif (data) {\r\ninfo->pstate = (nvbios_rd16(bios, data + 0x00) & 0x01e0) >> 5;\r\ninfo->index = nvbios_rd08(bios, data + 0x03);\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_cstepEm(struct nvkm_bios *bios, u8 pstate, u8 *ver, u8 *hdr,\r\nstruct nvbios_cstepE *info)\r\n{\r\nu32 data, idx = 0;\r\nwhile ((data = nvbios_cstepEp(bios, idx++, ver, hdr, info))) {\r\nif (info->pstate == pstate)\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_cstepXe(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr)\r\n{\r\nu8 cnt, len, xnr, xsz;\r\nu32 data = nvbios_cstepTe(bios, ver, hdr, &cnt, &len, &xnr, &xsz);\r\nif (data && idx < xnr) {\r\ndata = data + *hdr + (cnt * len) + (idx * xsz);\r\n*hdr = xsz;\r\nreturn data;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_cstepXp(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr,\r\nstruct nvbios_cstepX *info)\r\n{\r\nu32 data = nvbios_cstepXe(bios, idx, ver, hdr);\r\nmemset(info, 0x00, sizeof(*info));\r\nif (data) {\r\ninfo->freq = nvbios_rd16(bios, data + 0x00) * 1000;\r\ninfo->unkn[0] = nvbios_rd08(bios, data + 0x02);\r\ninfo->unkn[1] = nvbios_rd08(bios, data + 0x03);\r\ninfo->voltage = nvbios_rd08(bios, data + 0x04);\r\n}\r\nreturn data;\r\n}

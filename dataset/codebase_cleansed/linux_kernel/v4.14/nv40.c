static enum nv40_sensor_style\r\nnv40_sensor_style(struct nvkm_therm *therm)\r\n{\r\nswitch (therm->subdev.device->chipset) {\r\ncase 0x43:\r\ncase 0x44:\r\ncase 0x4a:\r\ncase 0x47:\r\nreturn OLD_STYLE;\r\ncase 0x46:\r\ncase 0x49:\r\ncase 0x4b:\r\ncase 0x4e:\r\ncase 0x4c:\r\ncase 0x67:\r\ncase 0x68:\r\ncase 0x63:\r\nreturn NEW_STYLE;\r\ndefault:\r\nreturn INVALID_STYLE;\r\n}\r\n}\r\nstatic int\r\nnv40_sensor_setup(struct nvkm_therm *therm)\r\n{\r\nstruct nvkm_device *device = therm->subdev.device;\r\nenum nv40_sensor_style style = nv40_sensor_style(therm);\r\nif (style == NEW_STYLE) {\r\nnvkm_mask(device, 0x15b8, 0x80000000, 0);\r\nnvkm_wr32(device, 0x15b0, 0x80003fff);\r\nmdelay(20);\r\nreturn nvkm_rd32(device, 0x15b4) & 0x3fff;\r\n} else if (style == OLD_STYLE) {\r\nnvkm_wr32(device, 0x15b0, 0xff);\r\nmdelay(20);\r\nreturn nvkm_rd32(device, 0x15b4) & 0xff;\r\n} else\r\nreturn -ENODEV;\r\n}\r\nstatic int\r\nnv40_temp_get(struct nvkm_therm *therm)\r\n{\r\nstruct nvkm_device *device = therm->subdev.device;\r\nstruct nvbios_therm_sensor *sensor = &therm->bios_sensor;\r\nenum nv40_sensor_style style = nv40_sensor_style(therm);\r\nint core_temp;\r\nif (style == NEW_STYLE) {\r\nnvkm_wr32(device, 0x15b0, 0x80003fff);\r\ncore_temp = nvkm_rd32(device, 0x15b4) & 0x3fff;\r\n} else if (style == OLD_STYLE) {\r\nnvkm_wr32(device, 0x15b0, 0xff);\r\ncore_temp = nvkm_rd32(device, 0x15b4) & 0xff;\r\n} else\r\nreturn -ENODEV;\r\nif (!sensor->slope_div || !sensor->slope_mult ||\r\n!sensor->offset_num || !sensor->offset_den)\r\nreturn -ENODEV;\r\ncore_temp = core_temp * sensor->slope_mult / sensor->slope_div;\r\ncore_temp = core_temp + sensor->offset_num / sensor->offset_den;\r\ncore_temp = core_temp + sensor->offset_constant - 8;\r\nif (core_temp < 0)\r\ncore_temp = 0;\r\nreturn core_temp;\r\n}\r\nstatic int\r\nnv40_fan_pwm_ctrl(struct nvkm_therm *therm, int line, bool enable)\r\n{\r\nstruct nvkm_subdev *subdev = &therm->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nu32 mask = enable ? 0x80000000 : 0x00000000;\r\nif (line == 2) nvkm_mask(device, 0x0010f0, 0x80000000, mask);\r\nelse if (line == 9) nvkm_mask(device, 0x0015f4, 0x80000000, mask);\r\nelse {\r\nnvkm_error(subdev, "unknown pwm ctrl for gpio %d\n", line);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnv40_fan_pwm_get(struct nvkm_therm *therm, int line, u32 *divs, u32 *duty)\r\n{\r\nstruct nvkm_subdev *subdev = &therm->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nif (line == 2) {\r\nu32 reg = nvkm_rd32(device, 0x0010f0);\r\nif (reg & 0x80000000) {\r\n*duty = (reg & 0x7fff0000) >> 16;\r\n*divs = (reg & 0x00007fff);\r\nreturn 0;\r\n}\r\n} else\r\nif (line == 9) {\r\nu32 reg = nvkm_rd32(device, 0x0015f4);\r\nif (reg & 0x80000000) {\r\n*divs = nvkm_rd32(device, 0x0015f8);\r\n*duty = (reg & 0x7fffffff);\r\nreturn 0;\r\n}\r\n} else {\r\nnvkm_error(subdev, "unknown pwm ctrl for gpio %d\n", line);\r\nreturn -ENODEV;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nnv40_fan_pwm_set(struct nvkm_therm *therm, int line, u32 divs, u32 duty)\r\n{\r\nstruct nvkm_subdev *subdev = &therm->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nif (line == 2) {\r\nnvkm_mask(device, 0x0010f0, 0x7fff7fff, (duty << 16) | divs);\r\n} else\r\nif (line == 9) {\r\nnvkm_wr32(device, 0x0015f8, divs);\r\nnvkm_mask(device, 0x0015f4, 0x7fffffff, duty);\r\n} else {\r\nnvkm_error(subdev, "unknown pwm ctrl for gpio %d\n", line);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nnv40_therm_intr(struct nvkm_therm *therm)\r\n{\r\nstruct nvkm_subdev *subdev = &therm->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nuint32_t stat = nvkm_rd32(device, 0x1100);\r\nnvkm_wr32(device, 0x1100, 0x70000);\r\nnvkm_error(subdev, "THERM received an IRQ: stat = %x\n", stat);\r\n}\r\nstatic void\r\nnv40_therm_init(struct nvkm_therm *therm)\r\n{\r\nnv40_sensor_setup(therm);\r\n}\r\nint\r\nnv40_therm_new(struct nvkm_device *device, int index,\r\nstruct nvkm_therm **ptherm)\r\n{\r\nreturn nvkm_therm_new_(&nv40_therm, device, index, ptherm);\r\n}

static int rk3399_dmcfreq_target(struct device *dev, unsigned long *freq,\r\nu32 flags)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_get_drvdata(dev);\r\nstruct dev_pm_opp *opp;\r\nunsigned long old_clk_rate = dmcfreq->rate;\r\nunsigned long target_volt, target_rate;\r\nint err;\r\nopp = devfreq_recommended_opp(dev, freq, flags);\r\nif (IS_ERR(opp))\r\nreturn PTR_ERR(opp);\r\ntarget_rate = dev_pm_opp_get_freq(opp);\r\ntarget_volt = dev_pm_opp_get_voltage(opp);\r\ndev_pm_opp_put(opp);\r\nif (dmcfreq->rate == target_rate)\r\nreturn 0;\r\nmutex_lock(&dmcfreq->lock);\r\nif (old_clk_rate < target_rate) {\r\nerr = regulator_set_voltage(dmcfreq->vdd_center, target_volt,\r\ntarget_volt);\r\nif (err) {\r\ndev_err(dev, "Cannot to set voltage %lu uV\n",\r\ntarget_volt);\r\ngoto out;\r\n}\r\n}\r\ndmcfreq->wait_dcf_flag = 1;\r\nerr = clk_set_rate(dmcfreq->dmc_clk, target_rate);\r\nif (err) {\r\ndev_err(dev, "Cannot to set frequency %lu (%d)\n",\r\ntarget_rate, err);\r\nregulator_set_voltage(dmcfreq->vdd_center, dmcfreq->volt,\r\ndmcfreq->volt);\r\ngoto out;\r\n}\r\nif (!wait_event_timeout(dmcfreq->wait_dcf_queue,\r\n!dmcfreq->wait_dcf_flag, HZ / 10))\r\ndev_warn(dev, "Timeout waiting for dcf interrupt\n");\r\ndmcfreq->rate = clk_get_rate(dmcfreq->dmc_clk);\r\nif (dmcfreq->rate != target_rate) {\r\ndev_err(dev, "Get wrong ddr frequency, Request frequency %lu,\\r\nCurrent frequency %lu\n", target_rate, dmcfreq->rate);\r\nregulator_set_voltage(dmcfreq->vdd_center, dmcfreq->volt,\r\ndmcfreq->volt);\r\ngoto out;\r\n} else if (old_clk_rate > target_rate)\r\nerr = regulator_set_voltage(dmcfreq->vdd_center, target_volt,\r\ntarget_volt);\r\nif (err)\r\ndev_err(dev, "Cannot to set vol %lu uV\n", target_volt);\r\ndmcfreq->rate = target_rate;\r\ndmcfreq->volt = target_volt;\r\nout:\r\nmutex_unlock(&dmcfreq->lock);\r\nreturn err;\r\n}\r\nstatic int rk3399_dmcfreq_get_dev_status(struct device *dev,\r\nstruct devfreq_dev_status *stat)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_get_drvdata(dev);\r\nstruct devfreq_event_data edata;\r\nint ret = 0;\r\nret = devfreq_event_get_event(dmcfreq->edev, &edata);\r\nif (ret < 0)\r\nreturn ret;\r\nstat->current_frequency = dmcfreq->rate;\r\nstat->busy_time = edata.load_count;\r\nstat->total_time = edata.total_count;\r\nreturn ret;\r\n}\r\nstatic int rk3399_dmcfreq_get_cur_freq(struct device *dev, unsigned long *freq)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_get_drvdata(dev);\r\n*freq = dmcfreq->rate;\r\nreturn 0;\r\n}\r\nstatic __maybe_unused int rk3399_dmcfreq_suspend(struct device *dev)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_get_drvdata(dev);\r\nint ret = 0;\r\nret = devfreq_event_disable_edev(dmcfreq->edev);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to disable the devfreq-event devices\n");\r\nreturn ret;\r\n}\r\nret = devfreq_suspend_device(dmcfreq->devfreq);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to suspend the devfreq devices\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic __maybe_unused int rk3399_dmcfreq_resume(struct device *dev)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_get_drvdata(dev);\r\nint ret = 0;\r\nret = devfreq_event_enable_edev(dmcfreq->edev);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to enable the devfreq-event devices\n");\r\nreturn ret;\r\n}\r\nret = devfreq_resume_device(dmcfreq->devfreq);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to resume the devfreq devices\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t rk3399_dmc_irq(int irq, void *dev_id)\r\n{\r\nstruct rk3399_dmcfreq *dmcfreq = dev_id;\r\nstruct arm_smccc_res res;\r\ndmcfreq->wait_dcf_flag = 0;\r\nwake_up(&dmcfreq->wait_dcf_queue);\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, 0, 0,\r\nROCKCHIP_SIP_CONFIG_DRAM_CLR_IRQ,\r\n0, 0, 0, 0, &res);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int of_get_ddr_timings(struct dram_timing *timing,\r\nstruct device_node *np)\r\n{\r\nint ret = 0;\r\nret = of_property_read_u32(np, "rockchip,ddr3_speed_bin",\r\n&timing->ddr3_speed_bin);\r\nret |= of_property_read_u32(np, "rockchip,pd_idle",\r\n&timing->pd_idle);\r\nret |= of_property_read_u32(np, "rockchip,sr_idle",\r\n&timing->sr_idle);\r\nret |= of_property_read_u32(np, "rockchip,sr_mc_gate_idle",\r\n&timing->sr_mc_gate_idle);\r\nret |= of_property_read_u32(np, "rockchip,srpd_lite_idle",\r\n&timing->srpd_lite_idle);\r\nret |= of_property_read_u32(np, "rockchip,standby_idle",\r\n&timing->standby_idle);\r\nret |= of_property_read_u32(np, "rockchip,auto_pd_dis_freq",\r\n&timing->auto_pd_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,dram_dll_dis_freq",\r\n&timing->dram_dll_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,phy_dll_dis_freq",\r\n&timing->phy_dll_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,ddr3_odt_dis_freq",\r\n&timing->ddr3_odt_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,ddr3_drv",\r\n&timing->ddr3_drv);\r\nret |= of_property_read_u32(np, "rockchip,ddr3_odt",\r\n&timing->ddr3_odt);\r\nret |= of_property_read_u32(np, "rockchip,phy_ddr3_ca_drv",\r\n&timing->phy_ddr3_ca_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_ddr3_dq_drv",\r\n&timing->phy_ddr3_dq_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_ddr3_odt",\r\n&timing->phy_ddr3_odt);\r\nret |= of_property_read_u32(np, "rockchip,lpddr3_odt_dis_freq",\r\n&timing->lpddr3_odt_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,lpddr3_drv",\r\n&timing->lpddr3_drv);\r\nret |= of_property_read_u32(np, "rockchip,lpddr3_odt",\r\n&timing->lpddr3_odt);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr3_ca_drv",\r\n&timing->phy_lpddr3_ca_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr3_dq_drv",\r\n&timing->phy_lpddr3_dq_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr3_odt",\r\n&timing->phy_lpddr3_odt);\r\nret |= of_property_read_u32(np, "rockchip,lpddr4_odt_dis_freq",\r\n&timing->lpddr4_odt_dis_freq);\r\nret |= of_property_read_u32(np, "rockchip,lpddr4_drv",\r\n&timing->lpddr4_drv);\r\nret |= of_property_read_u32(np, "rockchip,lpddr4_dq_odt",\r\n&timing->lpddr4_dq_odt);\r\nret |= of_property_read_u32(np, "rockchip,lpddr4_ca_odt",\r\n&timing->lpddr4_ca_odt);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr4_ca_drv",\r\n&timing->phy_lpddr4_ca_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr4_ck_cs_drv",\r\n&timing->phy_lpddr4_ck_cs_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr4_dq_drv",\r\n&timing->phy_lpddr4_dq_drv);\r\nret |= of_property_read_u32(np, "rockchip,phy_lpddr4_odt",\r\n&timing->phy_lpddr4_odt);\r\nreturn ret;\r\n}\r\nstatic int rk3399_dmcfreq_probe(struct platform_device *pdev)\r\n{\r\nstruct arm_smccc_res res;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct rk3399_dmcfreq *data;\r\nint ret, irq, index, size;\r\nuint32_t *timing;\r\nstruct dev_pm_opp *opp;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev,\r\n"Cannot get the dmc interrupt resource: %d\n", irq);\r\nreturn irq;\r\n}\r\ndata = devm_kzalloc(dev, sizeof(struct rk3399_dmcfreq), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nmutex_init(&data->lock);\r\ndata->vdd_center = devm_regulator_get(dev, "center");\r\nif (IS_ERR(data->vdd_center)) {\r\ndev_err(dev, "Cannot get the regulator \"center\"\n");\r\nreturn PTR_ERR(data->vdd_center);\r\n}\r\ndata->dmc_clk = devm_clk_get(dev, "dmc_clk");\r\nif (IS_ERR(data->dmc_clk)) {\r\ndev_err(dev, "Cannot get the clk dmc_clk\n");\r\nreturn PTR_ERR(data->dmc_clk);\r\n};\r\ndata->irq = irq;\r\nret = devm_request_irq(dev, irq, rk3399_dmc_irq, 0,\r\ndev_name(dev), data);\r\nif (ret) {\r\ndev_err(dev, "Failed to request dmc irq: %d\n", ret);\r\nreturn ret;\r\n}\r\ninit_waitqueue_head(&data->wait_dcf_queue);\r\ndata->wait_dcf_flag = 0;\r\ndata->edev = devfreq_event_get_edev_by_phandle(dev, 0);\r\nif (IS_ERR(data->edev))\r\nreturn -EPROBE_DEFER;\r\nret = devfreq_event_enable_edev(data->edev);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to enable devfreq-event devices\n");\r\nreturn ret;\r\n}\r\nif (!of_get_ddr_timings(&data->timing, np)) {\r\ntiming = &data->timing.ddr3_speed_bin;\r\nsize = sizeof(struct dram_timing) / 4;\r\nfor (index = 0; index < size; index++) {\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, *timing++, index,\r\nROCKCHIP_SIP_CONFIG_DRAM_SET_PARAM,\r\n0, 0, 0, 0, &res);\r\nif (res.a0) {\r\ndev_err(dev, "Failed to set dram param: %ld\n",\r\nres.a0);\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, 0, 0,\r\nROCKCHIP_SIP_CONFIG_DRAM_INIT,\r\n0, 0, 0, 0, &res);\r\nif (dev_pm_opp_of_add_table(dev)) {\r\ndev_err(dev, "Invalid operating-points in device tree.\n");\r\nreturn -EINVAL;\r\n}\r\nof_property_read_u32(np, "upthreshold",\r\n&data->ondemand_data.upthreshold);\r\nof_property_read_u32(np, "downdifferential",\r\n&data->ondemand_data.downdifferential);\r\ndata->rate = clk_get_rate(data->dmc_clk);\r\nopp = devfreq_recommended_opp(dev, &data->rate, 0);\r\nif (IS_ERR(opp))\r\nreturn PTR_ERR(opp);\r\ndata->rate = dev_pm_opp_get_freq(opp);\r\ndata->volt = dev_pm_opp_get_voltage(opp);\r\ndev_pm_opp_put(opp);\r\nrk3399_devfreq_dmc_profile.initial_freq = data->rate;\r\ndata->devfreq = devm_devfreq_add_device(dev,\r\n&rk3399_devfreq_dmc_profile,\r\n"simple_ondemand",\r\n&data->ondemand_data);\r\nif (IS_ERR(data->devfreq))\r\nreturn PTR_ERR(data->devfreq);\r\ndevm_devfreq_register_opp_notifier(dev, data->devfreq);\r\ndata->dev = dev;\r\nplatform_set_drvdata(pdev, data);\r\nreturn 0;\r\n}

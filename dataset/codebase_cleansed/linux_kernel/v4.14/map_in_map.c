struct bpf_map *bpf_map_meta_alloc(int inner_map_ufd)\r\n{\r\nstruct bpf_map *inner_map, *inner_map_meta;\r\nstruct fd f;\r\nf = fdget(inner_map_ufd);\r\ninner_map = __bpf_map_get(f);\r\nif (IS_ERR(inner_map))\r\nreturn inner_map;\r\nif (inner_map->map_type == BPF_MAP_TYPE_PROG_ARRAY) {\r\nfdput(f);\r\nreturn ERR_PTR(-ENOTSUPP);\r\n}\r\nif (inner_map->inner_map_meta) {\r\nfdput(f);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ninner_map_meta = kzalloc(sizeof(*inner_map_meta), GFP_USER);\r\nif (!inner_map_meta) {\r\nfdput(f);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninner_map_meta->map_type = inner_map->map_type;\r\ninner_map_meta->key_size = inner_map->key_size;\r\ninner_map_meta->value_size = inner_map->value_size;\r\ninner_map_meta->map_flags = inner_map->map_flags;\r\ninner_map_meta->ops = inner_map->ops;\r\ninner_map_meta->max_entries = inner_map->max_entries;\r\nfdput(f);\r\nreturn inner_map_meta;\r\n}\r\nvoid bpf_map_meta_free(struct bpf_map *map_meta)\r\n{\r\nkfree(map_meta);\r\n}\r\nbool bpf_map_meta_equal(const struct bpf_map *meta0,\r\nconst struct bpf_map *meta1)\r\n{\r\nreturn meta0->map_type == meta1->map_type &&\r\nmeta0->key_size == meta1->key_size &&\r\nmeta0->value_size == meta1->value_size &&\r\nmeta0->map_flags == meta1->map_flags &&\r\nmeta0->max_entries == meta1->max_entries;\r\n}\r\nvoid *bpf_map_fd_get_ptr(struct bpf_map *map,\r\nstruct file *map_file ,\r\nint ufd)\r\n{\r\nstruct bpf_map *inner_map;\r\nstruct fd f;\r\nf = fdget(ufd);\r\ninner_map = __bpf_map_get(f);\r\nif (IS_ERR(inner_map))\r\nreturn inner_map;\r\nif (bpf_map_meta_equal(map->inner_map_meta, inner_map))\r\ninner_map = bpf_map_inc(inner_map, false);\r\nelse\r\ninner_map = ERR_PTR(-EINVAL);\r\nfdput(f);\r\nreturn inner_map;\r\n}\r\nvoid bpf_map_fd_put_ptr(void *ptr)\r\n{\r\nbpf_map_put(ptr);\r\n}\r\nu32 bpf_map_fd_sys_lookup_elem(void *ptr)\r\n{\r\nreturn ((struct bpf_map *)ptr)->id;\r\n}

static int uartlite_open(void)\r\n{\r\nout_be32(reg_base + ULITE_CONTROL, ULITE_CONTROL_RST_RX);\r\nreturn 0;\r\n}\r\nstatic void uartlite_putc(unsigned char c)\r\n{\r\nu32 reg = ULITE_STATUS_TXFULL;\r\nwhile (reg & ULITE_STATUS_TXFULL)\r\nreg = in_be32(reg_base + ULITE_STATUS);\r\nout_be32(reg_base + ULITE_TX, c);\r\n}\r\nstatic unsigned char uartlite_getc(void)\r\n{\r\nu32 reg = 0;\r\nwhile (!(reg & ULITE_STATUS_RXVALID))\r\nreg = in_be32(reg_base + ULITE_STATUS);\r\nreturn in_be32(reg_base + ULITE_RX);\r\n}\r\nstatic u8 uartlite_tstc(void)\r\n{\r\nu32 reg = in_be32(reg_base + ULITE_STATUS);\r\nreturn reg & ULITE_STATUS_RXVALID;\r\n}\r\nint uartlite_console_init(void *devp, struct serial_console_data *scdp)\r\n{\r\nint n;\r\nunsigned long reg_phys;\r\nn = getprop(devp, "virtual-reg", &reg_base, sizeof(reg_base));\r\nif (n != sizeof(reg_base)) {\r\nif (!dt_xlate_reg(devp, 0, &reg_phys, NULL))\r\nreturn -1;\r\nreg_base = (void *)reg_phys;\r\n}\r\nscdp->open = uartlite_open;\r\nscdp->putc = uartlite_putc;\r\nscdp->getc = uartlite_getc;\r\nscdp->tstc = uartlite_tstc;\r\nscdp->close = NULL;\r\nreturn 0;\r\n}

static int tfa9879_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct tfa9879_priv *tfa9879 = snd_soc_codec_get_drvdata(codec);\r\nint fs;\r\nint i2s_set = 0;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\nfs = TFA9879_I2S_FS_8000;\r\nbreak;\r\ncase 11025:\r\nfs = TFA9879_I2S_FS_11025;\r\nbreak;\r\ncase 12000:\r\nfs = TFA9879_I2S_FS_12000;\r\nbreak;\r\ncase 16000:\r\nfs = TFA9879_I2S_FS_16000;\r\nbreak;\r\ncase 22050:\r\nfs = TFA9879_I2S_FS_22050;\r\nbreak;\r\ncase 24000:\r\nfs = TFA9879_I2S_FS_24000;\r\nbreak;\r\ncase 32000:\r\nfs = TFA9879_I2S_FS_32000;\r\nbreak;\r\ncase 44100:\r\nfs = TFA9879_I2S_FS_44100;\r\nbreak;\r\ncase 48000:\r\nfs = TFA9879_I2S_FS_48000;\r\nbreak;\r\ncase 64000:\r\nfs = TFA9879_I2S_FS_64000;\r\nbreak;\r\ncase 88200:\r\nfs = TFA9879_I2S_FS_88200;\r\nbreak;\r\ncase 96000:\r\nfs = TFA9879_I2S_FS_96000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (params_width(params)) {\r\ncase 16:\r\ni2s_set = TFA9879_I2S_SET_LSB_J_16;\r\nbreak;\r\ncase 24:\r\ni2s_set = TFA9879_I2S_SET_LSB_J_24;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (tfa9879->lsb_justified)\r\nsnd_soc_update_bits(codec, TFA9879_SERIAL_INTERFACE_1,\r\nTFA9879_I2S_SET_MASK,\r\ni2s_set << TFA9879_I2S_SET_SHIFT);\r\nsnd_soc_update_bits(codec, TFA9879_SERIAL_INTERFACE_1,\r\nTFA9879_I2S_FS_MASK,\r\nfs << TFA9879_I2S_FS_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int tfa9879_digital_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nsnd_soc_update_bits(codec, TFA9879_MISC_CONTROL,\r\nTFA9879_S_MUTE_MASK,\r\n!!mute << TFA9879_S_MUTE_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int tfa9879_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct tfa9879_priv *tfa9879 = snd_soc_codec_get_drvdata(codec);\r\nint i2s_set;\r\nint sck_pol;\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nsck_pol = TFA9879_SCK_POL_NORMAL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nsck_pol = TFA9879_SCK_POL_INVERSE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\ntfa9879->lsb_justified = 0;\r\ni2s_set = TFA9879_I2S_SET_I2S_24;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\ntfa9879->lsb_justified = 0;\r\ni2s_set = TFA9879_I2S_SET_MSB_J_24;\r\nbreak;\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\ntfa9879->lsb_justified = 1;\r\ni2s_set = TFA9879_I2S_SET_LSB_J_24;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, TFA9879_SERIAL_INTERFACE_1,\r\nTFA9879_SCK_POL_MASK,\r\nsck_pol << TFA9879_SCK_POL_SHIFT);\r\nsnd_soc_update_bits(codec, TFA9879_SERIAL_INTERFACE_1,\r\nTFA9879_I2S_SET_MASK,\r\ni2s_set << TFA9879_I2S_SET_SHIFT);\r\nreturn 0;\r\n}\r\nstatic bool tfa9879_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg == TFA9879_MISC_STATUS;\r\n}\r\nstatic int tfa9879_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tfa9879_priv *tfa9879;\r\nint i;\r\ntfa9879 = devm_kzalloc(&i2c->dev, sizeof(*tfa9879), GFP_KERNEL);\r\nif (!tfa9879)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, tfa9879);\r\ntfa9879->regmap = devm_regmap_init_i2c(i2c, &tfa9879_regmap);\r\nif (IS_ERR(tfa9879->regmap))\r\nreturn PTR_ERR(tfa9879->regmap);\r\nfor (i = 0; i < ARRAY_SIZE(tfa9879_regs); i++)\r\nregmap_write(tfa9879->regmap,\r\ntfa9879_regs[i].reg, tfa9879_regs[i].def);\r\nreturn snd_soc_register_codec(&i2c->dev, &tfa9879_codec,\r\n&tfa9879_dai, 1);\r\n}\r\nstatic int tfa9879_i2c_remove(struct i2c_client *client)\r\n{\r\nsnd_soc_unregister_codec(&client->dev);\r\nreturn 0;\r\n}

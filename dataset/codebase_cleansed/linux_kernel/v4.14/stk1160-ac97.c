static int stk1160_ac97_wait_transfer_complete(struct stk1160 *dev)\r\n{\r\nunsigned long timeout = jiffies + msecs_to_jiffies(STK1160_AC97_TIMEOUT);\r\nu8 value;\r\nwhile (time_is_after_jiffies(timeout)) {\r\nstk1160_read_reg(dev, STK1160_AC97CTL_0, &value);\r\nif (!(value & (STK1160_AC97CTL_0_CR | STK1160_AC97CTL_0_CW)))\r\nreturn 0;\r\nusleep_range(50, 100);\r\n}\r\nstk1160_err("AC97 transfer took too long, this should never happen!");\r\nreturn -EBUSY;\r\n}\r\nstatic void stk1160_write_ac97(struct stk1160 *dev, u16 reg, u16 value)\r\n{\r\nstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\r\nstk1160_write_reg(dev, STK1160_AC97_CMD, value & 0xff);\r\nstk1160_write_reg(dev, STK1160_AC97_CMD + 1, (value & 0xff00) >> 8);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8c);\r\nstk1160_ac97_wait_transfer_complete(dev);\r\n}\r\nstatic u16 stk1160_read_ac97(struct stk1160 *dev, u16 reg)\r\n{\r\nu8 vall = 0;\r\nu8 valh = 0;\r\nstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8b);\r\nif (stk1160_ac97_wait_transfer_complete(dev) < 0)\r\nreturn 0;\r\nstk1160_read_reg(dev, STK1160_AC97_CMD, &vall);\r\nstk1160_read_reg(dev, STK1160_AC97_CMD + 1, &valh);\r\nreturn (valh << 8) | vall;\r\n}\r\nvoid stk1160_ac97_dump_regs(struct stk1160 *dev)\r\n{\r\nu16 value;\r\nvalue = stk1160_read_ac97(dev, 0x12);\r\nstk1160_dbg("0x12 == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x10);\r\nstk1160_dbg("0x10 == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x0e);\r\nstk1160_dbg("0x0e == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x16);\r\nstk1160_dbg("0x16 == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x1a);\r\nstk1160_dbg("0x1a == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x02);\r\nstk1160_dbg("0x02 == 0x%04x", value);\r\nvalue = stk1160_read_ac97(dev, 0x1c);\r\nstk1160_dbg("0x1c == 0x%04x", value);\r\n}\r\nstatic int stk1160_has_audio(struct stk1160 *dev)\r\n{\r\nu8 value;\r\nstk1160_read_reg(dev, STK1160_POSV_L, &value);\r\nreturn !(value & STK1160_POSV_L_ACDOUT);\r\n}\r\nstatic int stk1160_has_ac97(struct stk1160 *dev)\r\n{\r\nu8 value;\r\nstk1160_read_reg(dev, STK1160_POSV_L, &value);\r\nreturn !(value & STK1160_POSV_L_ACSYNC);\r\n}\r\nvoid stk1160_ac97_setup(struct stk1160 *dev)\r\n{\r\nif (!stk1160_has_audio(dev)) {\r\nstk1160_info("Device doesn't support audio, skipping AC97 setup.");\r\nreturn;\r\n}\r\nif (!stk1160_has_ac97(dev)) {\r\nstk1160_info("Device uses internal 8-bit ADC, skipping AC97 setup.");\r\nreturn;\r\n}\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x94);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8c);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_1 + 2, 0x01);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_1 + 3, 0x00);\r\nstk1160_write_ac97(dev, 0x12, 0x8808);\r\nstk1160_write_ac97(dev, 0x10, 0x0808);\r\nstk1160_write_ac97(dev, 0x0e, 0x0008);\r\nstk1160_write_ac97(dev, 0x16, 0x0808);\r\nstk1160_write_ac97(dev, 0x1a, 0x0404);\r\nstk1160_write_ac97(dev, 0x02, 0x0000);\r\nstk1160_write_ac97(dev, 0x1c, 0x0808);\r\n#ifdef DEBUG\r\nstk1160_ac97_dump_regs(dev);\r\n#endif\r\n}

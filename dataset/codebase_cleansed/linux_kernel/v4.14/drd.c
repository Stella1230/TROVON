static void dwc3_drd_update(struct dwc3 *dwc)\r\n{\r\nint id;\r\nid = extcon_get_state(dwc->edev, EXTCON_USB_HOST);\r\nif (id < 0)\r\nid = 0;\r\ndwc3_set_mode(dwc, id ?\r\nDWC3_GCTL_PRTCAP_HOST :\r\nDWC3_GCTL_PRTCAP_DEVICE);\r\n}\r\nstatic int dwc3_drd_notifier(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct dwc3 *dwc = container_of(nb, struct dwc3, edev_nb);\r\ndwc3_set_mode(dwc, event ?\r\nDWC3_GCTL_PRTCAP_HOST :\r\nDWC3_GCTL_PRTCAP_DEVICE);\r\nreturn NOTIFY_DONE;\r\n}\r\nint dwc3_drd_init(struct dwc3 *dwc)\r\n{\r\nint ret;\r\nif (dwc->dev->of_node) {\r\nif (of_property_read_bool(dwc->dev->of_node, "extcon"))\r\ndwc->edev = extcon_get_edev_by_phandle(dwc->dev, 0);\r\nif (IS_ERR(dwc->edev))\r\nreturn PTR_ERR(dwc->edev);\r\ndwc->edev_nb.notifier_call = dwc3_drd_notifier;\r\nret = extcon_register_notifier(dwc->edev, EXTCON_USB_HOST,\r\n&dwc->edev_nb);\r\nif (ret < 0) {\r\ndev_err(dwc->dev, "couldn't register cable notifier\n");\r\nreturn ret;\r\n}\r\n}\r\ndwc3_drd_update(dwc);\r\nreturn 0;\r\n}\r\nvoid dwc3_drd_exit(struct dwc3 *dwc)\r\n{\r\nextcon_unregister_notifier(dwc->edev, EXTCON_USB_HOST,\r\n&dwc->edev_nb);\r\ndwc3_set_mode(dwc, DWC3_GCTL_PRTCAP_DEVICE);\r\nflush_work(&dwc->drd_work);\r\ndwc3_gadget_exit(dwc);\r\n}

static int dwc3_mode_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3 *dwc = s->private;\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nreg = dwc3_readl(dwc->regs, DWC3_GCTL);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nswitch (DWC3_GCTL_PRTCAP(reg)) {\r\ncase DWC3_GCTL_PRTCAP_HOST:\r\nseq_printf(s, "host\n");\r\nbreak;\r\ncase DWC3_GCTL_PRTCAP_DEVICE:\r\nseq_printf(s, "device\n");\r\nbreak;\r\ncase DWC3_GCTL_PRTCAP_OTG:\r\nseq_printf(s, "otg\n");\r\nbreak;\r\ndefault:\r\nseq_printf(s, "UNKNOWN %08x\n", DWC3_GCTL_PRTCAP(reg));\r\n}\r\nreturn 0;\r\n}\r\nstatic int dwc3_mode_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, dwc3_mode_show, inode->i_private);\r\n}\r\nstatic ssize_t dwc3_mode_write(struct file *file,\r\nconst char __user *ubuf, size_t count, loff_t *ppos)\r\n{\r\nstruct seq_file *s = file->private_data;\r\nstruct dwc3 *dwc = s->private;\r\nu32 mode = 0;\r\nchar buf[32];\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nif (!strncmp(buf, "host", 4))\r\nmode = DWC3_GCTL_PRTCAP_HOST;\r\nif (!strncmp(buf, "device", 6))\r\nmode = DWC3_GCTL_PRTCAP_DEVICE;\r\nif (!strncmp(buf, "otg", 3))\r\nmode = DWC3_GCTL_PRTCAP_OTG;\r\ndwc3_set_mode(dwc, mode);\r\nreturn count;\r\n}\r\nstatic int dwc3_testmode_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3 *dwc = s->private;\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nreg = dwc3_readl(dwc->regs, DWC3_DCTL);\r\nreg &= DWC3_DCTL_TSTCTRL_MASK;\r\nreg >>= 1;\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nswitch (reg) {\r\ncase 0:\r\nseq_printf(s, "no test\n");\r\nbreak;\r\ncase TEST_J:\r\nseq_printf(s, "test_j\n");\r\nbreak;\r\ncase TEST_K:\r\nseq_printf(s, "test_k\n");\r\nbreak;\r\ncase TEST_SE0_NAK:\r\nseq_printf(s, "test_se0_nak\n");\r\nbreak;\r\ncase TEST_PACKET:\r\nseq_printf(s, "test_packet\n");\r\nbreak;\r\ncase TEST_FORCE_EN:\r\nseq_printf(s, "test_force_enable\n");\r\nbreak;\r\ndefault:\r\nseq_printf(s, "UNKNOWN %d\n", reg);\r\n}\r\nreturn 0;\r\n}\r\nstatic int dwc3_testmode_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, dwc3_testmode_show, inode->i_private);\r\n}\r\nstatic ssize_t dwc3_testmode_write(struct file *file,\r\nconst char __user *ubuf, size_t count, loff_t *ppos)\r\n{\r\nstruct seq_file *s = file->private_data;\r\nstruct dwc3 *dwc = s->private;\r\nunsigned long flags;\r\nu32 testmode = 0;\r\nchar buf[32];\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nif (!strncmp(buf, "test_j", 6))\r\ntestmode = TEST_J;\r\nelse if (!strncmp(buf, "test_k", 6))\r\ntestmode = TEST_K;\r\nelse if (!strncmp(buf, "test_se0_nak", 12))\r\ntestmode = TEST_SE0_NAK;\r\nelse if (!strncmp(buf, "test_packet", 11))\r\ntestmode = TEST_PACKET;\r\nelse if (!strncmp(buf, "test_force_enable", 17))\r\ntestmode = TEST_FORCE_EN;\r\nelse\r\ntestmode = 0;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\ndwc3_gadget_set_test_mode(dwc, testmode);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn count;\r\n}\r\nstatic int dwc3_link_state_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3 *dwc = s->private;\r\nunsigned long flags;\r\nenum dwc3_link_state state;\r\nu32 reg;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nreg = dwc3_readl(dwc->regs, DWC3_DSTS);\r\nstate = DWC3_DSTS_USBLNKST(reg);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nseq_printf(s, "%s\n", dwc3_gadget_link_string(state));\r\nreturn 0;\r\n}\r\nstatic int dwc3_link_state_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, dwc3_link_state_show, inode->i_private);\r\n}\r\nstatic ssize_t dwc3_link_state_write(struct file *file,\r\nconst char __user *ubuf, size_t count, loff_t *ppos)\r\n{\r\nstruct seq_file *s = file->private_data;\r\nstruct dwc3 *dwc = s->private;\r\nunsigned long flags;\r\nenum dwc3_link_state state = 0;\r\nchar buf[32];\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nif (!strncmp(buf, "SS.Disabled", 11))\r\nstate = DWC3_LINK_STATE_SS_DIS;\r\nelse if (!strncmp(buf, "Rx.Detect", 9))\r\nstate = DWC3_LINK_STATE_RX_DET;\r\nelse if (!strncmp(buf, "SS.Inactive", 11))\r\nstate = DWC3_LINK_STATE_SS_INACT;\r\nelse if (!strncmp(buf, "Recovery", 8))\r\nstate = DWC3_LINK_STATE_RECOV;\r\nelse if (!strncmp(buf, "Compliance", 10))\r\nstate = DWC3_LINK_STATE_CMPLY;\r\nelse if (!strncmp(buf, "Loopback", 8))\r\nstate = DWC3_LINK_STATE_LPBK;\r\nelse\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\ndwc3_gadget_set_link_state(dwc, state);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn count;\r\n}\r\nstatic int dwc3_tx_fifo_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_TXFIFOQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_rx_fifo_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_RXFIFOQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_tx_request_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_TXREQQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_rx_request_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_RXREQQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_rx_info_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_RXINFOQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_descriptor_fetch_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_DESCFETCHQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_event_queue_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nval = dwc3_core_fifo_space(dep, DWC3_EVENTQ);\r\nseq_printf(s, "%u\n", val);\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_ep_transfer_type_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nif (!(dep->flags & DWC3_EP_ENABLED) ||\r\n!dep->endpoint.desc) {\r\nseq_printf(s, "--\n");\r\ngoto out;\r\n}\r\nswitch (usb_endpoint_type(dep->endpoint.desc)) {\r\ncase USB_ENDPOINT_XFER_CONTROL:\r\nseq_printf(s, "control\n");\r\nbreak;\r\ncase USB_ENDPOINT_XFER_ISOC:\r\nseq_printf(s, "isochronous\n");\r\nbreak;\r\ncase USB_ENDPOINT_XFER_BULK:\r\nseq_printf(s, "bulk\n");\r\nbreak;\r\ncase USB_ENDPOINT_XFER_INT:\r\nseq_printf(s, "interrupt\n");\r\nbreak;\r\ndefault:\r\nseq_printf(s, "--\n");\r\n}\r\nout:\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_ep_trb_ring_show(struct seq_file *s, void *unused)\r\n{\r\nstruct dwc3_ep *dep = s->private;\r\nstruct dwc3 *dwc = dep->dwc;\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&dwc->lock, flags);\r\nif (dep->number <= 1) {\r\nseq_printf(s, "--\n");\r\ngoto out;\r\n}\r\nseq_printf(s, "buffer_addr,size,type,ioc,isp_imi,csp,chn,lst,hwo\n");\r\nfor (i = 0; i < DWC3_TRB_NUM; i++) {\r\nstruct dwc3_trb *trb = &dep->trb_pool[i];\r\nunsigned int type = DWC3_TRBCTL_TYPE(trb->ctrl);\r\nseq_printf(s, "%08x%08x,%d,%s,%d,%d,%d,%d,%d,%d %c%c\n",\r\ntrb->bph, trb->bpl, trb->size,\r\ndwc3_trb_type_string(type),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_IOC),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_ISP_IMI),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_CSP),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_CHN),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_LST),\r\n!!(trb->ctrl & DWC3_TRB_CTRL_HWO),\r\ndep->trb_enqueue == i ? 'E' : ' ',\r\ndep->trb_dequeue == i ? 'D' : ' ');\r\n}\r\nout:\r\nspin_unlock_irqrestore(&dwc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dwc3_endpoint_open(struct inode *inode, struct file *file)\r\n{\r\nconst char *file_name = file_dentry(file)->d_iname;\r\nstruct dwc3_ep_file_map *f_map;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(map); i++) {\r\nf_map = &map[i];\r\nif (strcmp(f_map->name, file_name) == 0)\r\nbreak;\r\n}\r\nreturn single_open(file, f_map->show, inode->i_private);\r\n}\r\nstatic void dwc3_debugfs_create_endpoint_file(struct dwc3_ep *dep,\r\nstruct dentry *parent, int type)\r\n{\r\nstruct dentry *file;\r\nstruct dwc3_ep_file_map *ep_file = &map[type];\r\nfile = debugfs_create_file(ep_file->name, S_IRUGO, parent, dep,\r\n&dwc3_endpoint_fops);\r\n}\r\nstatic void dwc3_debugfs_create_endpoint_files(struct dwc3_ep *dep,\r\nstruct dentry *parent)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(map); i++)\r\ndwc3_debugfs_create_endpoint_file(dep, parent, i);\r\n}\r\nstatic void dwc3_debugfs_create_endpoint_dir(struct dwc3_ep *dep,\r\nstruct dentry *parent)\r\n{\r\nstruct dentry *dir;\r\ndir = debugfs_create_dir(dep->name, parent);\r\nif (IS_ERR_OR_NULL(dir))\r\nreturn;\r\ndwc3_debugfs_create_endpoint_files(dep, dir);\r\n}\r\nstatic void dwc3_debugfs_create_endpoint_dirs(struct dwc3 *dwc,\r\nstruct dentry *parent)\r\n{\r\nint i;\r\nfor (i = 0; i < dwc->num_eps; i++) {\r\nstruct dwc3_ep *dep = dwc->eps[i];\r\nif (!dep)\r\ncontinue;\r\ndwc3_debugfs_create_endpoint_dir(dep, parent);\r\n}\r\n}\r\nvoid dwc3_debugfs_init(struct dwc3 *dwc)\r\n{\r\nstruct dentry *root;\r\nstruct dentry *file;\r\nroot = debugfs_create_dir(dev_name(dwc->dev), NULL);\r\nif (IS_ERR_OR_NULL(root)) {\r\nif (!root)\r\ndev_err(dwc->dev, "Can't create debugfs root\n");\r\nreturn;\r\n}\r\ndwc->root = root;\r\ndwc->regset = kzalloc(sizeof(*dwc->regset), GFP_KERNEL);\r\nif (!dwc->regset) {\r\ndebugfs_remove_recursive(root);\r\nreturn;\r\n}\r\ndwc->regset->regs = dwc3_regs;\r\ndwc->regset->nregs = ARRAY_SIZE(dwc3_regs);\r\ndwc->regset->base = dwc->regs - DWC3_GLOBALS_REGS_START;\r\nfile = debugfs_create_regset32("regdump", S_IRUGO, root, dwc->regset);\r\nif (!file)\r\ndev_dbg(dwc->dev, "Can't create debugfs regdump\n");\r\nif (IS_ENABLED(CONFIG_USB_DWC3_DUAL_ROLE)) {\r\nfile = debugfs_create_file("mode", S_IRUGO | S_IWUSR, root,\r\ndwc, &dwc3_mode_fops);\r\nif (!file)\r\ndev_dbg(dwc->dev, "Can't create debugfs mode\n");\r\n}\r\nif (IS_ENABLED(CONFIG_USB_DWC3_DUAL_ROLE) ||\r\nIS_ENABLED(CONFIG_USB_DWC3_GADGET)) {\r\nfile = debugfs_create_file("testmode", S_IRUGO | S_IWUSR, root,\r\ndwc, &dwc3_testmode_fops);\r\nif (!file)\r\ndev_dbg(dwc->dev, "Can't create debugfs testmode\n");\r\nfile = debugfs_create_file("link_state", S_IRUGO | S_IWUSR,\r\nroot, dwc, &dwc3_link_state_fops);\r\nif (!file)\r\ndev_dbg(dwc->dev, "Can't create debugfs link_state\n");\r\ndwc3_debugfs_create_endpoint_dirs(dwc, root);\r\n}\r\n}\r\nvoid dwc3_debugfs_exit(struct dwc3 *dwc)\r\n{\r\ndebugfs_remove_recursive(dwc->root);\r\nkfree(dwc->regset);\r\n}

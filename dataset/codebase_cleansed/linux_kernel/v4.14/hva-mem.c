int hva_mem_alloc(struct hva_ctx *ctx, u32 size, const char *name,\r\nstruct hva_buffer **buf)\r\n{\r\nstruct device *dev = ctx_to_dev(ctx);\r\nstruct hva_buffer *b;\r\ndma_addr_t paddr;\r\nvoid *base;\r\nb = devm_kzalloc(dev, sizeof(*b), GFP_KERNEL);\r\nif (!b) {\r\nctx->sys_errors++;\r\nreturn -ENOMEM;\r\n}\r\nbase = dma_alloc_attrs(dev, size, &paddr, GFP_KERNEL | GFP_DMA,\r\nDMA_ATTR_WRITE_COMBINE);\r\nif (!base) {\r\ndev_err(dev, "%s %s : dma_alloc_attrs failed for %s (size=%d)\n",\r\nctx->name, __func__, name, size);\r\nctx->sys_errors++;\r\ndevm_kfree(dev, b);\r\nreturn -ENOMEM;\r\n}\r\nb->size = size;\r\nb->paddr = paddr;\r\nb->vaddr = base;\r\nb->name = name;\r\ndev_dbg(dev,\r\n"%s allocate %d bytes of HW memory @(virt=%p, phy=%pad): %s\n",\r\nctx->name, size, b->vaddr, &b->paddr, b->name);\r\n*buf = b;\r\nreturn 0;\r\n}\r\nvoid hva_mem_free(struct hva_ctx *ctx, struct hva_buffer *buf)\r\n{\r\nstruct device *dev = ctx_to_dev(ctx);\r\ndev_dbg(dev,\r\n"%s free %d bytes of HW memory @(virt=%p, phy=%pad): %s\n",\r\nctx->name, buf->size, buf->vaddr, &buf->paddr, buf->name);\r\ndma_free_attrs(dev, buf->size, buf->vaddr, buf->paddr,\r\nDMA_ATTR_WRITE_COMBINE);\r\ndevm_kfree(dev, buf);\r\n}

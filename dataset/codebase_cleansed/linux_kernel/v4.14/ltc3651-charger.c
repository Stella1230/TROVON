static irqreturn_t ltc3651_charger_irq(int irq, void *devid)\r\n{\r\nstruct power_supply *charger = devid;\r\npower_supply_changed(charger);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic inline struct ltc3651_charger *psy_to_ltc3651_charger(\r\nstruct power_supply *psy)\r\n{\r\nreturn power_supply_get_drvdata(psy);\r\n}\r\nstatic int ltc3651_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp, union power_supply_propval *val)\r\n{\r\nstruct ltc3651_charger *ltc3651_charger = psy_to_ltc3651_charger(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (!ltc3651_charger->chrg_gpio) {\r\nval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\r\nbreak;\r\n}\r\nif (gpiod_get_value(ltc3651_charger->chrg_gpio))\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = gpiod_get_value(ltc3651_charger->acpr_gpio);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nif (!ltc3651_charger->fault_gpio) {\r\nval->intval = POWER_SUPPLY_HEALTH_UNKNOWN;\r\nbreak;\r\n}\r\nif (!gpiod_get_value(ltc3651_charger->fault_gpio)) {\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\n}\r\nif (!ltc3651_charger->chrg_gpio) {\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\n}\r\nval->intval = gpiod_get_value(ltc3651_charger->chrg_gpio) ?\r\nPOWER_SUPPLY_HEALTH_OVERHEAT :\r\nPOWER_SUPPLY_HEALTH_DEAD;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ltc3651_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct power_supply_config psy_cfg = {};\r\nstruct ltc3651_charger *ltc3651_charger;\r\nstruct power_supply_desc *charger_desc;\r\nint ret;\r\nltc3651_charger = devm_kzalloc(&pdev->dev, sizeof(*ltc3651_charger),\r\nGFP_KERNEL);\r\nif (!ltc3651_charger)\r\nreturn -ENOMEM;\r\nltc3651_charger->acpr_gpio = devm_gpiod_get(&pdev->dev,\r\n"lltc,acpr", GPIOD_IN);\r\nif (IS_ERR(ltc3651_charger->acpr_gpio)) {\r\nret = PTR_ERR(ltc3651_charger->acpr_gpio);\r\ndev_err(&pdev->dev, "Failed to acquire acpr GPIO: %d\n", ret);\r\nreturn ret;\r\n}\r\nltc3651_charger->fault_gpio = devm_gpiod_get_optional(&pdev->dev,\r\n"lltc,fault", GPIOD_IN);\r\nif (IS_ERR(ltc3651_charger->fault_gpio)) {\r\nret = PTR_ERR(ltc3651_charger->fault_gpio);\r\ndev_err(&pdev->dev, "Failed to acquire fault GPIO: %d\n", ret);\r\nreturn ret;\r\n}\r\nltc3651_charger->chrg_gpio = devm_gpiod_get_optional(&pdev->dev,\r\n"lltc,chrg", GPIOD_IN);\r\nif (IS_ERR(ltc3651_charger->chrg_gpio)) {\r\nret = PTR_ERR(ltc3651_charger->chrg_gpio);\r\ndev_err(&pdev->dev, "Failed to acquire chrg GPIO: %d\n", ret);\r\nreturn ret;\r\n}\r\ncharger_desc = &ltc3651_charger->charger_desc;\r\ncharger_desc->name = pdev->dev.of_node->name;\r\ncharger_desc->type = POWER_SUPPLY_TYPE_MAINS;\r\ncharger_desc->properties = ltc3651_charger_properties;\r\ncharger_desc->num_properties = ARRAY_SIZE(ltc3651_charger_properties);\r\ncharger_desc->get_property = ltc3651_charger_get_property;\r\npsy_cfg.of_node = pdev->dev.of_node;\r\npsy_cfg.drv_data = ltc3651_charger;\r\nltc3651_charger->charger = devm_power_supply_register(&pdev->dev,\r\ncharger_desc, &psy_cfg);\r\nif (IS_ERR(ltc3651_charger->charger)) {\r\nret = PTR_ERR(ltc3651_charger->charger);\r\ndev_err(&pdev->dev, "Failed to register power supply: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (ltc3651_charger->acpr_gpio) {\r\nret = gpiod_to_irq(ltc3651_charger->acpr_gpio);\r\nif (ret >= 0)\r\nret = devm_request_any_context_irq(&pdev->dev, ret,\r\nltc3651_charger_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\ndev_name(&pdev->dev), ltc3651_charger->charger);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "Failed to request acpr irq\n");\r\n}\r\nif (ltc3651_charger->fault_gpio) {\r\nret = gpiod_to_irq(ltc3651_charger->fault_gpio);\r\nif (ret >= 0)\r\nret = devm_request_any_context_irq(&pdev->dev, ret,\r\nltc3651_charger_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\ndev_name(&pdev->dev), ltc3651_charger->charger);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "Failed to request fault irq\n");\r\n}\r\nif (ltc3651_charger->chrg_gpio) {\r\nret = gpiod_to_irq(ltc3651_charger->chrg_gpio);\r\nif (ret >= 0)\r\nret = devm_request_any_context_irq(&pdev->dev, ret,\r\nltc3651_charger_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\ndev_name(&pdev->dev), ltc3651_charger->charger);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "Failed to request chrg irq\n");\r\n}\r\nplatform_set_drvdata(pdev, ltc3651_charger);\r\nreturn 0;\r\n}

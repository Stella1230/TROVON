int fdtv_register_rc(struct firedtv *fdtv, struct device *dev)\r\n{\r\nstruct input_dev *idev;\r\nint i, err;\r\nidev = input_allocate_device();\r\nif (!idev)\r\nreturn -ENOMEM;\r\nfdtv->remote_ctrl_dev = idev;\r\nidev->name = "FireDTV remote control";\r\nidev->dev.parent = dev;\r\nidev->evbit[0] = BIT_MASK(EV_KEY);\r\nidev->keycode = kmemdup(keytable, sizeof(keytable), GFP_KERNEL);\r\nif (!idev->keycode) {\r\nerr = -ENOMEM;\r\ngoto fail;\r\n}\r\nidev->keycodesize = sizeof(keytable[0]);\r\nidev->keycodemax = ARRAY_SIZE(keytable);\r\nfor (i = 0; i < ARRAY_SIZE(keytable); i++)\r\nset_bit(keytable[i], idev->keybit);\r\nerr = input_register_device(idev);\r\nif (err)\r\ngoto fail_free_keymap;\r\nreturn 0;\r\nfail_free_keymap:\r\nkfree(idev->keycode);\r\nfail:\r\ninput_free_device(idev);\r\nreturn err;\r\n}\r\nvoid fdtv_unregister_rc(struct firedtv *fdtv)\r\n{\r\ncancel_work_sync(&fdtv->remote_ctrl_work);\r\nkfree(fdtv->remote_ctrl_dev->keycode);\r\ninput_unregister_device(fdtv->remote_ctrl_dev);\r\n}\r\nvoid fdtv_handle_rc(struct firedtv *fdtv, unsigned int code)\r\n{\r\nstruct input_dev *idev = fdtv->remote_ctrl_dev;\r\nu16 *keycode = idev->keycode;\r\nif (code >= 0x0300 && code <= 0x031f)\r\ncode = keycode[code - 0x0300];\r\nelse if (code >= 0x0340 && code <= 0x0354)\r\ncode = keycode[code - 0x0320];\r\nelse if (code >= 0x4501 && code <= 0x451f)\r\ncode = oldtable[code - 0x4501];\r\nelse if (code >= 0x4540 && code <= 0x4542)\r\ncode = oldtable[code - 0x4521];\r\nelse {\r\ndev_dbg(fdtv->device,\r\n"invalid key code 0x%04x from remote control\n",\r\ncode);\r\nreturn;\r\n}\r\ninput_report_key(idev, code, 1);\r\ninput_sync(idev);\r\ninput_report_key(idev, code, 0);\r\ninput_sync(idev);\r\n}

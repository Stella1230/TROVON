ia_css_isys_error_t ia_css_isys_stream_create(\r\nia_css_isys_descr_t *isys_stream_descr,\r\nia_css_isys_stream_h isys_stream,\r\nuint32_t isys_stream_id)\r\n{\r\nia_css_isys_error_t rc;\r\nif (isys_stream_descr == NULL || isys_stream == NULL ||\r\nisys_stream_id >= SH_CSS_MAX_ISYS_CHANNEL_NODES)\r\nreturn false;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\r\n"ia_css_isys_stream_create() enter:\n");\r\nmemset(isys_stream, 0, sizeof(*isys_stream));\r\nisys_stream->enable_metadata = isys_stream_descr->metadata.enable;\r\nisys_stream->id = isys_stream_id;\r\nisys_stream->linked_isys_stream_id = isys_stream_descr->linked_isys_stream_id;\r\nrc = create_input_system_input_port(isys_stream_descr, &(isys_stream->input_port));\r\nif (rc == false)\r\nreturn false;\r\nrc = create_input_system_channel(isys_stream_descr, false, &(isys_stream->channel));\r\nif (rc == false) {\r\ndestroy_input_system_input_port(&isys_stream->input_port);\r\nreturn false;\r\n}\r\n#ifdef ISP2401\r\nisys_stream->polling_mode = isys_stream_descr->polling_mode;\r\n#endif\r\nif (isys_stream_descr->metadata.enable) {\r\nrc = create_input_system_channel(isys_stream_descr, true, &isys_stream->md_channel);\r\nif (rc == false) {\r\ndestroy_input_system_input_port(&isys_stream->input_port);\r\ndestroy_input_system_channel(&isys_stream->channel);\r\nreturn false;\r\n}\r\n}\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\r\n"ia_css_isys_stream_create() leave:\n");\r\nreturn true;\r\n}\r\nvoid ia_css_isys_stream_destroy(\r\nia_css_isys_stream_h isys_stream)\r\n{\r\ndestroy_input_system_input_port(&isys_stream->input_port);\r\ndestroy_input_system_channel(&(isys_stream->channel));\r\nif (isys_stream->enable_metadata) {\r\ndestroy_input_system_channel(&isys_stream->md_channel);\r\n}\r\n}\r\nia_css_isys_error_t ia_css_isys_stream_calculate_cfg(\r\nia_css_isys_stream_h isys_stream,\r\nia_css_isys_descr_t *isys_stream_descr,\r\nia_css_isys_stream_cfg_t *isys_stream_cfg)\r\n{\r\nia_css_isys_error_t rc;\r\nif (isys_stream_cfg == NULL ||\r\nisys_stream_descr == NULL ||\r\nisys_stream == NULL)\r\nreturn false;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\r\n"ia_css_isys_stream_calculate_cfg() enter:\n");\r\nrc = calculate_input_system_channel_cfg(\r\n&(isys_stream->channel),\r\n&(isys_stream->input_port),\r\nisys_stream_descr,\r\n&(isys_stream_cfg->channel_cfg),\r\nfalse);\r\nif (rc == false)\r\nreturn false;\r\nif (isys_stream_descr->metadata.enable) {\r\nisys_stream_cfg->enable_metadata = true;\r\nrc = calculate_input_system_channel_cfg(\r\n&isys_stream->md_channel,\r\n&isys_stream->input_port,\r\nisys_stream_descr,\r\n&isys_stream_cfg->md_channel_cfg,\r\ntrue);\r\nif (rc == false)\r\nreturn false;\r\n}\r\nrc = calculate_input_system_input_port_cfg(\r\n&(isys_stream->channel),\r\n&(isys_stream->input_port),\r\nisys_stream_descr,\r\n&(isys_stream_cfg->input_port_cfg));\r\nif (rc == false)\r\nreturn false;\r\nisys_stream->valid = 1;\r\nisys_stream_cfg->valid = 1;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\r\n"ia_css_isys_stream_calculate_cfg() leave:\n");\r\nreturn rc;\r\n}\r\nstatic bool create_input_system_channel(\r\ninput_system_cfg_t *cfg,\r\nbool metadata,\r\ninput_system_channel_t *me)\r\n{\r\nbool rc = true;\r\nme->dma_id = ISYS2401_DMA0_ID;\r\nswitch (cfg->input_port_id) {\r\ncase INPUT_SYSTEM_CSI_PORT0_ID:\r\ncase INPUT_SYSTEM_PIXELGEN_PORT0_ID:\r\nme->stream2mmio_id = STREAM2MMIO0_ID;\r\nme->ibuf_ctrl_id = IBUF_CTRL0_ID;\r\nbreak;\r\ncase INPUT_SYSTEM_CSI_PORT1_ID:\r\ncase INPUT_SYSTEM_PIXELGEN_PORT1_ID:\r\nme->stream2mmio_id = STREAM2MMIO1_ID;\r\nme->ibuf_ctrl_id = IBUF_CTRL1_ID;\r\nbreak;\r\ncase INPUT_SYSTEM_CSI_PORT2_ID:\r\ncase INPUT_SYSTEM_PIXELGEN_PORT2_ID:\r\nme->stream2mmio_id = STREAM2MMIO2_ID;\r\nme->ibuf_ctrl_id = IBUF_CTRL2_ID;\r\nbreak;\r\ndefault:\r\nrc = false;\r\nbreak;\r\n}\r\nif (rc == false)\r\nreturn false;\r\nif (!acquire_sid(me->stream2mmio_id, &(me->stream2mmio_sid_id))) {\r\nreturn false;\r\n}\r\nif (!acquire_ib_buffer(\r\nmetadata ? cfg->metadata.bits_per_pixel : cfg->input_port_resolution.bits_per_pixel,\r\nmetadata ? cfg->metadata.pixels_per_line : cfg->input_port_resolution.pixels_per_line,\r\nmetadata ? cfg->metadata.lines_per_frame : cfg->input_port_resolution.lines_per_frame,\r\nmetadata ? cfg->metadata.align_req_in_bytes : cfg->input_port_resolution.align_req_in_bytes,\r\ncfg->online,\r\n&(me->ib_buffer))) {\r\nrelease_sid(me->stream2mmio_id, &(me->stream2mmio_sid_id));\r\nreturn false;\r\n}\r\nif (!acquire_dma_channel(me->dma_id, &(me->dma_channel))) {\r\nrelease_sid(me->stream2mmio_id, &(me->stream2mmio_sid_id));\r\nrelease_ib_buffer(&(me->ib_buffer));\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void destroy_input_system_channel(\r\ninput_system_channel_t *me)\r\n{\r\nrelease_sid(me->stream2mmio_id,\r\n&(me->stream2mmio_sid_id));\r\nrelease_ib_buffer(&(me->ib_buffer));\r\nrelease_dma_channel(me->dma_id, &(me->dma_channel));\r\n}\r\nstatic bool create_input_system_input_port(\r\ninput_system_cfg_t *cfg,\r\ninput_system_input_port_t *me)\r\n{\r\ncsi_mipi_packet_type_t packet_type;\r\nbool rc = true;\r\nswitch (cfg->input_port_id) {\r\ncase INPUT_SYSTEM_CSI_PORT0_ID:\r\nme->csi_rx.frontend_id = CSI_RX_FRONTEND0_ID;\r\nme->csi_rx.backend_id = CSI_RX_BACKEND0_ID;\r\npacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\r\nme->csi_rx.packet_type = packet_type;\r\nrc = acquire_be_lut_entry(\r\nme->csi_rx.backend_id,\r\npacket_type,\r\n&(me->csi_rx.backend_lut_entry));\r\nbreak;\r\ncase INPUT_SYSTEM_PIXELGEN_PORT0_ID:\r\nme->pixelgen.pixelgen_id = PIXELGEN0_ID;\r\nbreak;\r\ncase INPUT_SYSTEM_CSI_PORT1_ID:\r\nme->csi_rx.frontend_id = CSI_RX_FRONTEND1_ID;\r\nme->csi_rx.backend_id = CSI_RX_BACKEND1_ID;\r\npacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\r\nme->csi_rx.packet_type = packet_type;\r\nrc = acquire_be_lut_entry(\r\nme->csi_rx.backend_id,\r\npacket_type,\r\n&(me->csi_rx.backend_lut_entry));\r\nbreak;\r\ncase INPUT_SYSTEM_PIXELGEN_PORT1_ID:\r\nme->pixelgen.pixelgen_id = PIXELGEN1_ID;\r\nbreak;\r\ncase INPUT_SYSTEM_CSI_PORT2_ID:\r\nme->csi_rx.frontend_id = CSI_RX_FRONTEND2_ID;\r\nme->csi_rx.backend_id = CSI_RX_BACKEND2_ID;\r\npacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\r\nme->csi_rx.packet_type = packet_type;\r\nrc = acquire_be_lut_entry(\r\nme->csi_rx.backend_id,\r\npacket_type,\r\n&(me->csi_rx.backend_lut_entry));\r\nbreak;\r\ncase INPUT_SYSTEM_PIXELGEN_PORT2_ID:\r\nme->pixelgen.pixelgen_id = PIXELGEN2_ID;\r\nbreak;\r\ndefault:\r\nrc = false;\r\nbreak;\r\n}\r\nme->source_type = cfg->mode;\r\nme->metadata.packet_type = CSI_MIPI_PACKET_TYPE_UNDEFINED;\r\nif (rc && cfg->metadata.enable) {\r\nme->metadata.packet_type = get_csi_mipi_packet_type(\r\ncfg->metadata.fmt_type);\r\nrc = acquire_be_lut_entry(\r\nme->csi_rx.backend_id,\r\nme->metadata.packet_type,\r\n&me->metadata.backend_lut_entry);\r\n}\r\nreturn rc;\r\n}\r\nstatic void destroy_input_system_input_port(\r\ninput_system_input_port_t *me)\r\n{\r\nif (me->source_type == INPUT_SYSTEM_SOURCE_TYPE_SENSOR) {\r\nrelease_be_lut_entry(\r\nme->csi_rx.backend_id,\r\nme->csi_rx.packet_type,\r\n&me->csi_rx.backend_lut_entry);\r\n}\r\nif (me->metadata.packet_type != CSI_MIPI_PACKET_TYPE_UNDEFINED) {\r\nrelease_be_lut_entry(\r\nme->csi_rx.backend_id,\r\nme->metadata.packet_type,\r\n&me->metadata.backend_lut_entry);\r\n}\r\n}\r\nstatic bool calculate_input_system_channel_cfg(\r\ninput_system_channel_t *channel,\r\ninput_system_input_port_t *input_port,\r\ninput_system_cfg_t *isys_cfg,\r\ninput_system_channel_cfg_t *channel_cfg,\r\nbool metadata)\r\n{\r\nbool rc;\r\nrc = calculate_stream2mmio_cfg(isys_cfg, metadata,\r\n&(channel_cfg->stream2mmio_cfg));\r\nif (rc == false)\r\nreturn false;\r\nrc = calculate_ibuf_ctrl_cfg(\r\nchannel,\r\ninput_port,\r\nisys_cfg,\r\n&(channel_cfg->ibuf_ctrl_cfg));\r\nif (rc == false)\r\nreturn false;\r\nif (metadata)\r\nchannel_cfg->ibuf_ctrl_cfg.stores_per_frame = isys_cfg->metadata.lines_per_frame;\r\nrc = calculate_isys2401_dma_cfg(\r\nchannel,\r\nisys_cfg,\r\n&(channel_cfg->dma_cfg));\r\nif (rc == false)\r\nreturn false;\r\nrc = calculate_isys2401_dma_port_cfg(\r\nisys_cfg,\r\nfalse,\r\nmetadata,\r\n&(channel_cfg->dma_src_port_cfg));\r\nif (rc == false)\r\nreturn false;\r\nrc = calculate_isys2401_dma_port_cfg(\r\nisys_cfg,\r\nisys_cfg->raw_packed,\r\nmetadata,\r\n&(channel_cfg->dma_dest_port_cfg));\r\nif (rc == false)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool calculate_input_system_input_port_cfg(\r\ninput_system_channel_t *channel,\r\ninput_system_input_port_t *input_port,\r\ninput_system_cfg_t *isys_cfg,\r\ninput_system_input_port_cfg_t *input_port_cfg)\r\n{\r\nbool rc;\r\nswitch (input_port->source_type) {\r\ncase INPUT_SYSTEM_SOURCE_TYPE_SENSOR:\r\nrc = calculate_fe_cfg(\r\nisys_cfg,\r\n&(input_port_cfg->csi_rx_cfg.frontend_cfg));\r\nrc &= calculate_be_cfg(\r\ninput_port,\r\nisys_cfg,\r\nfalse,\r\n&(input_port_cfg->csi_rx_cfg.backend_cfg));\r\nif (rc && isys_cfg->metadata.enable)\r\nrc &= calculate_be_cfg(input_port, isys_cfg, true,\r\n&input_port_cfg->csi_rx_cfg.md_backend_cfg);\r\nbreak;\r\ncase INPUT_SYSTEM_SOURCE_TYPE_TPG:\r\nrc = calculate_tpg_cfg(\r\nchannel,\r\ninput_port,\r\nisys_cfg,\r\n&(input_port_cfg->pixelgen_cfg.tpg_cfg));\r\nbreak;\r\ncase INPUT_SYSTEM_SOURCE_TYPE_PRBS:\r\nrc = calculate_prbs_cfg(\r\nchannel,\r\ninput_port,\r\nisys_cfg,\r\n&(input_port_cfg->pixelgen_cfg.prbs_cfg));\r\nbreak;\r\ndefault:\r\nrc = false;\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nstatic bool acquire_sid(\r\nstream2mmio_ID_t stream2mmio,\r\nstream2mmio_sid_ID_t *sid)\r\n{\r\nreturn ia_css_isys_stream2mmio_sid_rmgr_acquire(stream2mmio, sid);\r\n}\r\nstatic void release_sid(\r\nstream2mmio_ID_t stream2mmio,\r\nstream2mmio_sid_ID_t *sid)\r\n{\r\nia_css_isys_stream2mmio_sid_rmgr_release(stream2mmio, sid);\r\n}\r\nstatic int32_t calculate_stride(\r\nint32_t bits_per_pixel,\r\nint32_t pixels_per_line,\r\nbool raw_packed,\r\nint32_t align_in_bytes)\r\n{\r\nint32_t bytes_per_line;\r\nint32_t pixels_per_word;\r\nint32_t words_per_line;\r\nint32_t pixels_per_line_padded;\r\npixels_per_line_padded = CEIL_MUL(pixels_per_line, align_in_bytes);\r\nif (!raw_packed)\r\nbits_per_pixel = CEIL_MUL(bits_per_pixel, 8);\r\npixels_per_word = HIVE_ISP_DDR_WORD_BITS / bits_per_pixel;\r\nwords_per_line = ceil_div(pixels_per_line_padded, pixels_per_word);\r\nbytes_per_line = HIVE_ISP_DDR_WORD_BYTES * words_per_line;\r\nreturn bytes_per_line;\r\n}\r\nstatic bool acquire_ib_buffer(\r\nint32_t bits_per_pixel,\r\nint32_t pixels_per_line,\r\nint32_t lines_per_frame,\r\nint32_t align_in_bytes,\r\nbool online,\r\nib_buffer_t *buf)\r\n{\r\nbuf->stride = calculate_stride(bits_per_pixel, pixels_per_line, false, align_in_bytes);\r\nif (online)\r\nbuf->lines = 4;\r\nelse\r\nbuf->lines = 2;\r\n(void)(lines_per_frame);\r\nreturn ia_css_isys_ibuf_rmgr_acquire(buf->stride * buf->lines, &buf->start_addr);\r\n}\r\nstatic void release_ib_buffer(\r\nib_buffer_t *buf)\r\n{\r\nia_css_isys_ibuf_rmgr_release(&buf->start_addr);\r\n}\r\nstatic bool acquire_dma_channel(\r\nisys2401_dma_ID_t dma_id,\r\nisys2401_dma_channel *channel)\r\n{\r\nreturn ia_css_isys_dma_channel_rmgr_acquire(dma_id, channel);\r\n}\r\nstatic void release_dma_channel(\r\nisys2401_dma_ID_t dma_id,\r\nisys2401_dma_channel *channel)\r\n{\r\nia_css_isys_dma_channel_rmgr_release(dma_id, channel);\r\n}\r\nstatic bool acquire_be_lut_entry(\r\ncsi_rx_backend_ID_t backend,\r\ncsi_mipi_packet_type_t packet_type,\r\ncsi_rx_backend_lut_entry_t *entry)\r\n{\r\nreturn ia_css_isys_csi_rx_lut_rmgr_acquire(backend, packet_type, entry);\r\n}\r\nstatic void release_be_lut_entry(\r\ncsi_rx_backend_ID_t backend,\r\ncsi_mipi_packet_type_t packet_type,\r\ncsi_rx_backend_lut_entry_t *entry)\r\n{\r\nia_css_isys_csi_rx_lut_rmgr_release(backend, packet_type, entry);\r\n}\r\nstatic bool calculate_tpg_cfg(\r\ninput_system_channel_t *channel,\r\ninput_system_input_port_t *input_port,\r\ninput_system_cfg_t *isys_cfg,\r\npixelgen_tpg_cfg_t *cfg)\r\n{\r\n(void)channel;\r\n(void)input_port;\r\nmemcpy_s(\r\n(void *)cfg,\r\nsizeof(pixelgen_tpg_cfg_t),\r\n(void *)(&(isys_cfg->tpg_port_attr)),\r\nsizeof(pixelgen_tpg_cfg_t));\r\nreturn true;\r\n}\r\nstatic bool calculate_prbs_cfg(\r\ninput_system_channel_t *channel,\r\ninput_system_input_port_t *input_port,\r\ninput_system_cfg_t *isys_cfg,\r\npixelgen_prbs_cfg_t *cfg)\r\n{\r\n(void)channel;\r\n(void)input_port;\r\nmemcpy_s(\r\n(void *)cfg,\r\nsizeof(pixelgen_prbs_cfg_t),\r\n(void *)(&(isys_cfg->prbs_port_attr)),\r\nsizeof(pixelgen_prbs_cfg_t));\r\nreturn true;\r\n}\r\nstatic bool calculate_fe_cfg(\r\nconst input_system_cfg_t *isys_cfg,\r\ncsi_rx_frontend_cfg_t *cfg)\r\n{\r\ncfg->active_lanes = isys_cfg->csi_port_attr.active_lanes;\r\nreturn true;\r\n}\r\nstatic bool calculate_be_cfg(\r\nconst input_system_input_port_t *input_port,\r\nconst input_system_cfg_t *isys_cfg,\r\nbool metadata,\r\ncsi_rx_backend_cfg_t *cfg)\r\n{\r\nmemcpy_s(\r\n(void *)(&cfg->lut_entry),\r\nsizeof(csi_rx_backend_lut_entry_t),\r\nmetadata ? (void *)(&input_port->metadata.backend_lut_entry) :\r\n(void *)(&input_port->csi_rx.backend_lut_entry),\r\nsizeof(csi_rx_backend_lut_entry_t));\r\ncfg->csi_mipi_cfg.virtual_channel = isys_cfg->csi_port_attr.ch_id;\r\nif (metadata) {\r\ncfg->csi_mipi_packet_type = get_csi_mipi_packet_type(isys_cfg->metadata.fmt_type);\r\ncfg->csi_mipi_cfg.comp_enable = false;\r\ncfg->csi_mipi_cfg.data_type = isys_cfg->metadata.fmt_type;\r\n}\r\nelse {\r\ncfg->csi_mipi_packet_type = get_csi_mipi_packet_type(isys_cfg->csi_port_attr.fmt_type);\r\ncfg->csi_mipi_cfg.data_type = isys_cfg->csi_port_attr.fmt_type;\r\ncfg->csi_mipi_cfg.comp_enable = isys_cfg->csi_port_attr.comp_enable;\r\ncfg->csi_mipi_cfg.comp_scheme = isys_cfg->csi_port_attr.comp_scheme;\r\ncfg->csi_mipi_cfg.comp_predictor = isys_cfg->csi_port_attr.comp_predictor;\r\ncfg->csi_mipi_cfg.comp_bit_idx = cfg->csi_mipi_cfg.data_type - MIPI_FORMAT_CUSTOM0;\r\n}\r\nreturn true;\r\n}\r\nstatic bool calculate_stream2mmio_cfg(\r\nconst input_system_cfg_t *isys_cfg,\r\nbool metadata,\r\nstream2mmio_cfg_t *cfg\r\n)\r\n{\r\ncfg->bits_per_pixel = metadata ? isys_cfg->metadata.bits_per_pixel :\r\nisys_cfg->input_port_resolution.bits_per_pixel;\r\ncfg->enable_blocking =\r\n((isys_cfg->mode == INPUT_SYSTEM_SOURCE_TYPE_TPG) ||\r\n(isys_cfg->mode == INPUT_SYSTEM_SOURCE_TYPE_PRBS));\r\nreturn true;\r\n}\r\nstatic bool calculate_ibuf_ctrl_cfg(\r\nconst input_system_channel_t *channel,\r\nconst input_system_input_port_t *input_port,\r\nconst input_system_cfg_t *isys_cfg,\r\nibuf_ctrl_cfg_t *cfg)\r\n{\r\nconst int32_t bits_per_byte = 8;\r\nint32_t bits_per_pixel;\r\nint32_t bytes_per_pixel;\r\nint32_t left_padding;\r\n(void)input_port;\r\nbits_per_pixel = isys_cfg->input_port_resolution.bits_per_pixel;\r\nbytes_per_pixel = ceil_div(bits_per_pixel, bits_per_byte);\r\nleft_padding = CEIL_MUL(isys_cfg->output_port_attr.left_padding, ISP_VEC_NELEMS)\r\n* bytes_per_pixel;\r\ncfg->online = isys_cfg->online;\r\ncfg->dma_cfg.channel = channel->dma_channel;\r\ncfg->dma_cfg.cmd = _DMA_V2_MOVE_A2B_NO_SYNC_CHK_COMMAND;\r\ncfg->dma_cfg.shift_returned_items = 0;\r\ncfg->dma_cfg.elems_per_word_in_ibuf = 0;\r\ncfg->dma_cfg.elems_per_word_in_dest = 0;\r\ncfg->ib_buffer.start_addr = channel->ib_buffer.start_addr;\r\ncfg->ib_buffer.stride = channel->ib_buffer.stride;\r\ncfg->ib_buffer.lines = channel->ib_buffer.lines;\r\nif (cfg->online) {\r\ncfg->dest_buf_cfg.start_addr = ISP_INPUT_BUF_START_ADDR + left_padding;\r\ncfg->dest_buf_cfg.stride = bytes_per_pixel\r\n* isys_cfg->output_port_attr.max_isp_input_width;\r\ncfg->dest_buf_cfg.lines = LINES_OF_ISP_INPUT_BUF;\r\n} else if (isys_cfg->raw_packed) {\r\ncfg->dest_buf_cfg.stride = calculate_stride(bits_per_pixel,\r\nisys_cfg->input_port_resolution.pixels_per_line,\r\nisys_cfg->raw_packed,\r\nisys_cfg->input_port_resolution.align_req_in_bytes);\r\n} else {\r\ncfg->dest_buf_cfg.stride = channel->ib_buffer.stride;\r\n}\r\ncfg->items_per_store = 1;\r\ncfg->stores_per_frame = isys_cfg->input_port_resolution.lines_per_frame;\r\ncfg->stream2mmio_cfg.sync_cmd = _STREAM2MMIO_CMD_TOKEN_SYNC_FRAME;\r\ncfg->stream2mmio_cfg.store_cmd = _STREAM2MMIO_CMD_TOKEN_STORE_PACKETS;\r\nreturn true;\r\n}\r\nstatic bool calculate_isys2401_dma_cfg(\r\nconst input_system_channel_t *channel,\r\nconst input_system_cfg_t *isys_cfg,\r\nisys2401_dma_cfg_t *cfg)\r\n{\r\ncfg->channel = channel->dma_channel;\r\nif (isys_cfg->online)\r\ncfg->connection = isys2401_dma_ibuf_to_vmem_connection;\r\nelse\r\ncfg->connection = isys2401_dma_ibuf_to_ddr_connection;\r\ncfg->extension = isys2401_dma_zero_extension;\r\ncfg->height = 1;\r\nreturn true;\r\n}\r\nstatic bool calculate_isys2401_dma_port_cfg(\r\nconst input_system_cfg_t *isys_cfg,\r\nbool raw_packed,\r\nbool metadata,\r\nisys2401_dma_port_cfg_t *cfg)\r\n{\r\nint32_t bits_per_pixel;\r\nint32_t pixels_per_line;\r\nint32_t align_req_in_bytes;\r\nif (metadata) {\r\nbits_per_pixel = isys_cfg->metadata.bits_per_pixel;\r\npixels_per_line = isys_cfg->metadata.pixels_per_line;\r\nalign_req_in_bytes = isys_cfg->metadata.align_req_in_bytes;\r\n} else {\r\nbits_per_pixel = isys_cfg->input_port_resolution.bits_per_pixel;\r\npixels_per_line = isys_cfg->input_port_resolution.pixels_per_line;\r\nalign_req_in_bytes = isys_cfg->input_port_resolution.align_req_in_bytes;\r\n}\r\ncfg->stride = calculate_stride(bits_per_pixel, pixels_per_line, raw_packed, align_req_in_bytes);\r\nif (!raw_packed)\r\nbits_per_pixel = CEIL_MUL(bits_per_pixel, 8);\r\ncfg->elements = HIVE_ISP_DDR_WORD_BITS / bits_per_pixel;\r\ncfg->cropping = 0;\r\ncfg->width = CEIL_DIV(cfg->stride, HIVE_ISP_DDR_WORD_BYTES);\r\nreturn true;\r\n}\r\nstatic csi_mipi_packet_type_t get_csi_mipi_packet_type(\r\nint32_t data_type)\r\n{\r\ncsi_mipi_packet_type_t packet_type;\r\npacket_type = CSI_MIPI_PACKET_TYPE_RESERVED;\r\nif (data_type >= 0 && data_type <= MIPI_FORMAT_SHORT8)\r\npacket_type = CSI_MIPI_PACKET_TYPE_SHORT;\r\nif (data_type > MIPI_FORMAT_SHORT8 && data_type <= N_MIPI_FORMAT)\r\npacket_type = CSI_MIPI_PACKET_TYPE_LONG;\r\nreturn packet_type;\r\n}

static void adf_cleanup_pci_dev(struct adf_accel_dev *accel_dev)\r\n{\r\npci_release_regions(accel_dev->accel_pci_dev.pci_dev);\r\npci_disable_device(accel_dev->accel_pci_dev.pci_dev);\r\n}\r\nstatic void adf_cleanup_accel(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_accel_pci *accel_pci_dev = &accel_dev->accel_pci_dev;\r\nint i;\r\nfor (i = 0; i < ADF_PCI_MAX_BARS; i++) {\r\nstruct adf_bar *bar = &accel_pci_dev->pci_bars[i];\r\nif (bar->virt_addr)\r\npci_iounmap(accel_pci_dev->pci_dev, bar->virt_addr);\r\n}\r\nif (accel_dev->hw_device) {\r\nswitch (accel_pci_dev->pci_dev->device) {\r\ncase ADF_C62X_PCI_DEVICE_ID:\r\nadf_clean_hw_data_c62x(accel_dev->hw_device);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nkfree(accel_dev->hw_device);\r\naccel_dev->hw_device = NULL;\r\n}\r\nadf_cfg_dev_remove(accel_dev);\r\ndebugfs_remove(accel_dev->debugfs_dir);\r\nadf_devmgr_rm_dev(accel_dev, NULL);\r\n}\r\nstatic int adf_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct adf_accel_dev *accel_dev;\r\nstruct adf_accel_pci *accel_pci_dev;\r\nstruct adf_hw_device_data *hw_data;\r\nchar name[ADF_DEVICE_NAME_LENGTH];\r\nunsigned int i, bar_nr;\r\nint ret, bar_mask;\r\nswitch (ent->device) {\r\ncase ADF_C62X_PCI_DEVICE_ID:\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Invalid device 0x%x.\n", ent->device);\r\nreturn -ENODEV;\r\n}\r\nif (num_possible_nodes() > 1 && dev_to_node(&pdev->dev) < 0) {\r\ndev_err(&pdev->dev, "Invalid NUMA configuration.\n");\r\nreturn -EINVAL;\r\n}\r\naccel_dev = kzalloc_node(sizeof(*accel_dev), GFP_KERNEL,\r\ndev_to_node(&pdev->dev));\r\nif (!accel_dev)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&accel_dev->crypto_list);\r\naccel_pci_dev = &accel_dev->accel_pci_dev;\r\naccel_pci_dev->pci_dev = pdev;\r\nif (adf_devmgr_add_dev(accel_dev, NULL)) {\r\ndev_err(&pdev->dev, "Failed to add new accelerator device.\n");\r\nkfree(accel_dev);\r\nreturn -EFAULT;\r\n}\r\naccel_dev->owner = THIS_MODULE;\r\nhw_data = kzalloc_node(sizeof(*hw_data), GFP_KERNEL,\r\ndev_to_node(&pdev->dev));\r\nif (!hw_data) {\r\nret = -ENOMEM;\r\ngoto out_err;\r\n}\r\naccel_dev->hw_device = hw_data;\r\nadf_init_hw_data_c62x(accel_dev->hw_device);\r\npci_read_config_byte(pdev, PCI_REVISION_ID, &accel_pci_dev->revid);\r\npci_read_config_dword(pdev, ADF_DEVICE_FUSECTL_OFFSET,\r\n&hw_data->fuses);\r\nhw_data->accel_mask = hw_data->get_accel_mask(hw_data->fuses);\r\nhw_data->ae_mask = hw_data->get_ae_mask(hw_data->fuses);\r\naccel_pci_dev->sku = hw_data->get_sku(hw_data);\r\nif (!hw_data->accel_mask || !hw_data->ae_mask ||\r\n((~hw_data->ae_mask) & 0x01)) {\r\ndev_err(&pdev->dev, "No acceleration units found");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nsnprintf(name, sizeof(name), "%s%s_%02x:%02d.%d",\r\nADF_DEVICE_NAME_PREFIX, hw_data->dev_class->name,\r\npdev->bus->number, PCI_SLOT(pdev->devfn),\r\nPCI_FUNC(pdev->devfn));\r\naccel_dev->debugfs_dir = debugfs_create_dir(name, NULL);\r\nif (!accel_dev->debugfs_dir) {\r\ndev_err(&pdev->dev, "Could not create debugfs dir %s\n", name);\r\nret = -EINVAL;\r\ngoto out_err;\r\n}\r\nret = adf_cfg_dev_add(accel_dev);\r\nif (ret)\r\ngoto out_err;\r\nif (pci_enable_device(pdev)) {\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (pci_set_dma_mask(pdev, DMA_BIT_MASK(64))) {\r\nif ((pci_set_dma_mask(pdev, DMA_BIT_MASK(32)))) {\r\ndev_err(&pdev->dev, "No usable DMA configuration\n");\r\nret = -EFAULT;\r\ngoto out_err_disable;\r\n} else {\r\npci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(32));\r\n}\r\n} else {\r\npci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(64));\r\n}\r\nif (pci_request_regions(pdev, ADF_C62X_DEVICE_NAME)) {\r\nret = -EFAULT;\r\ngoto out_err_disable;\r\n}\r\npci_read_config_dword(pdev, ADF_DEVICE_LEGFUSE_OFFSET,\r\n&hw_data->accel_capabilities_mask);\r\ni = (hw_data->fuses & ADF_DEVICE_FUSECTL_MASK) ? 1 : 0;\r\nbar_mask = pci_select_bars(pdev, IORESOURCE_MEM);\r\nfor_each_set_bit(bar_nr, (const unsigned long *)&bar_mask,\r\nADF_PCI_MAX_BARS * 2) {\r\nstruct adf_bar *bar = &accel_pci_dev->pci_bars[i++];\r\nbar->base_addr = pci_resource_start(pdev, bar_nr);\r\nif (!bar->base_addr)\r\nbreak;\r\nbar->size = pci_resource_len(pdev, bar_nr);\r\nbar->virt_addr = pci_iomap(accel_pci_dev->pci_dev, bar_nr, 0);\r\nif (!bar->virt_addr) {\r\ndev_err(&pdev->dev, "Failed to map BAR %d\n", bar_nr);\r\nret = -EFAULT;\r\ngoto out_err_free_reg;\r\n}\r\n}\r\npci_set_master(pdev);\r\nif (adf_enable_aer(accel_dev, &adf_driver)) {\r\ndev_err(&pdev->dev, "Failed to enable aer\n");\r\nret = -EFAULT;\r\ngoto out_err_free_reg;\r\n}\r\nif (pci_save_state(pdev)) {\r\ndev_err(&pdev->dev, "Failed to save pci state\n");\r\nret = -ENOMEM;\r\ngoto out_err_free_reg;\r\n}\r\nret = qat_crypto_dev_config(accel_dev);\r\nif (ret)\r\ngoto out_err_free_reg;\r\nret = adf_dev_init(accel_dev);\r\nif (ret)\r\ngoto out_err_dev_shutdown;\r\nret = adf_dev_start(accel_dev);\r\nif (ret)\r\ngoto out_err_dev_stop;\r\nreturn ret;\r\nout_err_dev_stop:\r\nadf_dev_stop(accel_dev);\r\nout_err_dev_shutdown:\r\nadf_dev_shutdown(accel_dev);\r\nout_err_free_reg:\r\npci_release_regions(accel_pci_dev->pci_dev);\r\nout_err_disable:\r\npci_disable_device(accel_pci_dev->pci_dev);\r\nout_err:\r\nadf_cleanup_accel(accel_dev);\r\nkfree(accel_dev);\r\nreturn ret;\r\n}\r\nstatic void adf_remove(struct pci_dev *pdev)\r\n{\r\nstruct adf_accel_dev *accel_dev = adf_devmgr_pci_to_accel_dev(pdev);\r\nif (!accel_dev) {\r\npr_err("QAT: Driver removal failed\n");\r\nreturn;\r\n}\r\nadf_dev_stop(accel_dev);\r\nadf_dev_shutdown(accel_dev);\r\nadf_disable_aer(accel_dev);\r\nadf_cleanup_accel(accel_dev);\r\nadf_cleanup_pci_dev(accel_dev);\r\nkfree(accel_dev);\r\n}\r\nstatic int __init adfdrv_init(void)\r\n{\r\nrequest_module("intel_qat");\r\nif (pci_register_driver(&adf_driver)) {\r\npr_err("QAT: Driver initialization failed\n");\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit adfdrv_release(void)\r\n{\r\npci_unregister_driver(&adf_driver);\r\n}

static int __init set_permissions(pte_t *ptep, pgtable_t token,\r\nunsigned long addr, void *data)\r\n{\r\nefi_memory_desc_t *md = data;\r\npte_t pte = *ptep;\r\nif (md->attribute & EFI_MEMORY_RO)\r\npte = set_pte_bit(pte, __pgprot(L_PTE_RDONLY));\r\nif (md->attribute & EFI_MEMORY_XP)\r\npte = set_pte_bit(pte, __pgprot(L_PTE_XN));\r\nset_pte_ext(ptep, pte, PTE_EXT_NG);\r\nreturn 0;\r\n}\r\nint __init efi_set_mapping_permissions(struct mm_struct *mm,\r\nefi_memory_desc_t *md)\r\n{\r\nunsigned long base, size;\r\nbase = md->virt_addr;\r\nsize = md->num_pages << EFI_PAGE_SHIFT;\r\nif (round_down(base + size, SECTION_SIZE) <\r\nround_up(base, SECTION_SIZE) + SECTION_SIZE)\r\nreturn apply_to_page_range(mm, base, size, set_permissions, md);\r\nreturn 0;\r\n}\r\nint __init efi_create_mapping(struct mm_struct *mm, efi_memory_desc_t *md)\r\n{\r\nstruct map_desc desc = {\r\n.virtual = md->virt_addr,\r\n.pfn = __phys_to_pfn(md->phys_addr),\r\n.length = md->num_pages * EFI_PAGE_SIZE,\r\n};\r\nif (md->attribute & EFI_MEMORY_WB)\r\ndesc.type = MT_MEMORY_RWX;\r\nelse if (md->attribute & EFI_MEMORY_WT)\r\ndesc.type = MT_MEMORY_RWX_NONCACHED;\r\nelse if (md->attribute & EFI_MEMORY_WC)\r\ndesc.type = MT_DEVICE_WC;\r\nelse\r\ndesc.type = MT_DEVICE;\r\ncreate_mapping_late(mm, &desc, true);\r\nif (md->attribute & (EFI_MEMORY_RO | EFI_MEMORY_XP))\r\nreturn efi_set_mapping_permissions(mm, md);\r\nreturn 0;\r\n}

static void psc_debug_dump(void)\r\n{\r\nint i;\r\nif (!psc)\r\nreturn;\r\nfor (i = 0x30 ; i < 0x70 ; i += 0x10) {\r\nprintk("PSC #%d: IFR = 0x%02X IER = 0x%02X\n",\r\ni >> 4,\r\n(int) psc_read_byte(pIFRbase + i),\r\n(int) psc_read_byte(pIERbase + i));\r\n}\r\n}\r\nstatic __init void psc_dma_die_die_die(void)\r\n{\r\nint i;\r\nprintk("Killing all PSC DMA channels...");\r\nfor (i = 0 ; i < 9 ; i++) {\r\npsc_write_word(PSC_CTL_BASE + (i << 4), 0x8800);\r\npsc_write_word(PSC_CTL_BASE + (i << 4), 0x1000);\r\npsc_write_word(PSC_CMD_BASE + (i << 5), 0x1100);\r\npsc_write_word(PSC_CMD_BASE + (i << 5) + 0x10, 0x1100);\r\n}\r\nprintk("done!\n");\r\n}\r\nvoid __init psc_init(void)\r\n{\r\nint i;\r\nif (macintosh_config->ident != MAC_MODEL_C660\r\n&& macintosh_config->ident != MAC_MODEL_Q840)\r\n{\r\npsc = NULL;\r\nreturn;\r\n}\r\npsc = (void *) PSC_BASE;\r\nprintk("PSC detected at %p\n", psc);\r\npsc_dma_die_die_die();\r\n#ifdef DEBUG_PSC\r\npsc_debug_dump();\r\n#endif\r\nfor (i = 0x30 ; i < 0x70 ; i += 0x10) {\r\npsc_write_byte(pIERbase + i, 0x0F);\r\npsc_write_byte(pIFRbase + i, 0x0F);\r\n}\r\n}\r\nstatic void psc_irq(struct irq_desc *desc)\r\n{\r\nunsigned int offset = (unsigned int)irq_desc_get_handler_data(desc);\r\nunsigned int irq = irq_desc_get_irq(desc);\r\nint pIFR = pIFRbase + offset;\r\nint pIER = pIERbase + offset;\r\nint irq_num;\r\nunsigned char irq_bit, events;\r\nevents = psc_read_byte(pIFR) & psc_read_byte(pIER) & 0xF;\r\nif (!events)\r\nreturn;\r\nirq_num = irq << 3;\r\nirq_bit = 1;\r\ndo {\r\nif (events & irq_bit) {\r\npsc_write_byte(pIFR, irq_bit);\r\ngeneric_handle_irq(irq_num);\r\n}\r\nirq_num++;\r\nirq_bit <<= 1;\r\n} while (events >= irq_bit);\r\n}\r\nvoid __init psc_register_interrupts(void)\r\n{\r\nirq_set_chained_handler_and_data(IRQ_AUTO_3, psc_irq, (void *)0x30);\r\nirq_set_chained_handler_and_data(IRQ_AUTO_4, psc_irq, (void *)0x40);\r\nirq_set_chained_handler_and_data(IRQ_AUTO_5, psc_irq, (void *)0x50);\r\nirq_set_chained_handler_and_data(IRQ_AUTO_6, psc_irq, (void *)0x60);\r\n}\r\nvoid psc_irq_enable(int irq) {\r\nint irq_src = IRQ_SRC(irq);\r\nint irq_idx = IRQ_IDX(irq);\r\nint pIER = pIERbase + (irq_src << 4);\r\npsc_write_byte(pIER, (1 << irq_idx) | 0x80);\r\n}\r\nvoid psc_irq_disable(int irq) {\r\nint irq_src = IRQ_SRC(irq);\r\nint irq_idx = IRQ_IDX(irq);\r\nint pIER = pIERbase + (irq_src << 4);\r\npsc_write_byte(pIER, 1 << irq_idx);\r\n}

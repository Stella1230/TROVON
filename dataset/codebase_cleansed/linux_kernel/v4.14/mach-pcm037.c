static int __init pcm037_variant_setup(char *str)\r\n{\r\nif (!strcmp("eet", str))\r\npcm037_instance = PCM037_EET;\r\nelse if (strcmp("pcm970", str))\r\npr_warn("Unknown pcm037 baseboard variant %s\n", str);\r\nreturn 1;\r\n}\r\nenum pcm037_board_variant pcm037_variant(void)\r\n{\r\nreturn pcm037_instance;\r\n}\r\nstatic int pcm970_sdhc1_get_ro(struct device *dev)\r\n{\r\nreturn gpio_get_value(IOMUX_TO_GPIO(MX31_PIN_SFS6));\r\n}\r\nstatic int pcm970_sdhc1_init(struct device *dev, irq_handler_t detect_irq,\r\nvoid *data)\r\n{\r\nint ret;\r\nret = gpio_request(SDHC1_GPIO_DET, "sdhc-detect");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_input(SDHC1_GPIO_DET);\r\n#ifdef PCM970_SDHC_RW_SWITCH\r\nret = gpio_request(SDHC1_GPIO_WP, "sdhc-wp");\r\nif (ret)\r\ngoto err_gpio_free;\r\ngpio_direction_input(SDHC1_GPIO_WP);\r\n#endif\r\nret = request_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_SCK6)), detect_irq,\r\nIRQF_TRIGGER_FALLING, "sdhc-detect", data);\r\nif (ret)\r\ngoto err_gpio_free_2;\r\nreturn 0;\r\nerr_gpio_free_2:\r\n#ifdef PCM970_SDHC_RW_SWITCH\r\ngpio_free(SDHC1_GPIO_WP);\r\nerr_gpio_free:\r\n#endif\r\ngpio_free(SDHC1_GPIO_DET);\r\nreturn ret;\r\n}\r\nstatic void pcm970_sdhc1_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_SCK6)), data);\r\ngpio_free(SDHC1_GPIO_DET);\r\ngpio_free(SDHC1_GPIO_WP);\r\n}\r\nstatic int pcm037_otg_init(struct platform_device *pdev)\r\n{\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_INTERFACE_DIFF_UNI);\r\n}\r\nstatic int pcm037_usbh2_init(struct platform_device *pdev)\r\n{\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_INTERFACE_DIFF_UNI);\r\n}\r\nstatic int __init pcm037_otg_mode(char *options)\r\n{\r\nif (!strcmp(options, "host"))\r\notg_mode_host = true;\r\nelse if (!strcmp(options, "device"))\r\notg_mode_host = false;\r\nelse\r\npr_info("otg_mode neither \"host\" nor \"device\". "\r\n"Defaulting to device\n");\r\nreturn 1;\r\n}\r\nstatic void __init pcm037_init(void)\r\n{\r\nimx31_soc_init();\r\nregulator_register_fixed(0, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\nmxc_iomux_set_gpr(MUX_PGP_UH2, 1);\r\nmxc_iomux_setup_multiple_pins(pcm037_pins, ARRAY_SIZE(pcm037_pins),\r\n"pcm037");\r\n#define H2_PAD_CFG (PAD_CTL_DRV_MAX | PAD_CTL_SRE_FAST | PAD_CTL_HYS_CMOS \\r\n| PAD_CTL_ODE_CMOS | PAD_CTL_100K_PU)\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_CLK, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DIR, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_NXT, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_STP, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA0, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA1, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD6, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_STXD6, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SFS3, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SCK3, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD3, H2_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_STXD3, H2_PAD_CFG);\r\nif (pcm037_variant() == PCM037_EET)\r\nmxc_iomux_setup_multiple_pins(pcm037_uart1_pins,\r\nARRAY_SIZE(pcm037_uart1_pins), "pcm037_uart1");\r\nelse\r\nmxc_iomux_setup_multiple_pins(pcm037_uart1_handshake_pins,\r\nARRAY_SIZE(pcm037_uart1_handshake_pins),\r\n"pcm037_uart1");\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nimx31_add_imx2_wdt();\r\nimx31_add_imx_uart0(&uart_pdata);\r\nimx31_add_imx_uart1(&uart_pdata);\r\nimx31_add_imx_uart2(&uart_pdata);\r\nimx31_add_mxc_w1();\r\ni2c_register_board_info(1, pcm037_i2c_devices,\r\nARRAY_SIZE(pcm037_i2c_devices));\r\nimx31_add_imx_i2c1(&pcm037_i2c1_data);\r\nimx31_add_imx_i2c2(&pcm037_i2c2_data);\r\nimx31_add_mxc_nand(&pcm037_nand_board_info);\r\nimx31_add_ipu_core();\r\nimx31_add_mx3_sdc_fb(&mx3fb_pdata);\r\nif (otg_mode_host) {\r\notg_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (otg_pdata.otg)\r\nimx31_add_mxc_ehci_otg(&otg_pdata);\r\n}\r\nusbh2_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (usbh2_pdata.otg)\r\nimx31_add_mxc_ehci_hs(2, &usbh2_pdata);\r\nif (!otg_mode_host)\r\nimx31_add_fsl_usb2_udc(&otg_device_pdata);\r\n}\r\nstatic void __init pcm037_timer_init(void)\r\n{\r\nmx31_clocks_init(26000000);\r\n}\r\nstatic void __init pcm037_init_late(void)\r\n{\r\nint ret;\r\nret = gpio_request(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1), "lan9217-irq");\r\nif (!ret) {\r\ngpio_direction_input(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1));\r\nsmsc911x_resources[1].start =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1));\r\nsmsc911x_resources[1].end =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1));\r\nplatform_device_register(&pcm037_eth);\r\n} else {\r\npr_warn("could not get LAN irq gpio\n");\r\n}\r\nimx31_add_mxc_mmc(0, &sdhc_pdata);\r\npcm970_sja1000_resources[1].start =\r\ngpio_to_irq(IOMUX_TO_GPIO(IOMUX_PIN(48, 105)));\r\npcm970_sja1000_resources[1].end =\r\ngpio_to_irq(IOMUX_TO_GPIO(IOMUX_PIN(48, 105)));\r\nplatform_device_register(&pcm970_sja1000);\r\npcm037_eet_init_devices();\r\n}

static int midi_capture_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_playback_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ff *ff = substream->rmidi->private_data;\r\nff->running_status[substream->number] = 0;\r\nff->rx_midi_error[substream->number] = false;\r\nACCESS_ONCE(ff->rx_midi_substreams[substream->number]) = substream;\r\nreturn 0;\r\n}\r\nstatic int midi_capture_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_playback_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ff *ff = substream->rmidi->private_data;\r\ncancel_work_sync(&ff->rx_midi_work[substream->number]);\r\nACCESS_ONCE(ff->rx_midi_substreams[substream->number]) = NULL;\r\nreturn 0;\r\n}\r\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_ff *ff = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ff->lock, flags);\r\nif (up)\r\nACCESS_ONCE(ff->tx_midi_substreams[substream->number]) =\r\nsubstream;\r\nelse\r\nACCESS_ONCE(ff->tx_midi_substreams[substream->number]) = NULL;\r\nspin_unlock_irqrestore(&ff->lock, flags);\r\n}\r\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_ff *ff = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ff->lock, flags);\r\nif (up || !ff->rx_midi_error[substream->number])\r\nschedule_work(&ff->rx_midi_work[substream->number]);\r\nspin_unlock_irqrestore(&ff->lock, flags);\r\n}\r\nstatic void set_midi_substream_names(struct snd_rawmidi_str *stream,\r\nconst char *const name)\r\n{\r\nstruct snd_rawmidi_substream *substream;\r\nlist_for_each_entry(substream, &stream->substreams, list) {\r\nsnprintf(substream->name, sizeof(substream->name),\r\n"%s MIDI %d", name, substream->number + 1);\r\n}\r\n}\r\nint snd_ff_create_midi_devices(struct snd_ff *ff)\r\n{\r\nstatic const struct snd_rawmidi_ops midi_capture_ops = {\r\n.open = midi_capture_open,\r\n.close = midi_capture_close,\r\n.trigger = midi_capture_trigger,\r\n};\r\nstatic const struct snd_rawmidi_ops midi_playback_ops = {\r\n.open = midi_playback_open,\r\n.close = midi_playback_close,\r\n.trigger = midi_playback_trigger,\r\n};\r\nstruct snd_rawmidi *rmidi;\r\nstruct snd_rawmidi_str *stream;\r\nint err;\r\nerr = snd_rawmidi_new(ff->card, ff->card->driver, 0,\r\nff->spec->midi_out_ports, ff->spec->midi_in_ports,\r\n&rmidi);\r\nif (err < 0)\r\nreturn err;\r\nsnprintf(rmidi->name, sizeof(rmidi->name),\r\n"%s MIDI", ff->card->shortname);\r\nrmidi->private_data = ff;\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&midi_capture_ops);\r\nstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT];\r\nset_midi_substream_names(stream, ff->card->shortname);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&midi_playback_ops);\r\nstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\r\nset_midi_substream_names(stream, ff->card->shortname);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\r\nreturn 0;\r\n}

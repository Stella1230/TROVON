static int sas_get_pr_transport_id(\r\nstruct se_node_acl *nacl,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nint ret;\r\nret = hex2bin(&buf[4], &nacl->initiatorname[4], 8);\r\nif (ret) {\r\npr_debug("%s: invalid hex string\n", __func__);\r\nreturn ret;\r\n}\r\nreturn 24;\r\n}\r\nstatic int fc_get_pr_transport_id(\r\nstruct se_node_acl *se_nacl,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nunsigned char *ptr;\r\nint i, ret;\r\nu32 off = 8;\r\nptr = &se_nacl->initiatorname[0];\r\nfor (i = 0; i < 24; ) {\r\nif (!strncmp(&ptr[i], ":", 1)) {\r\ni++;\r\ncontinue;\r\n}\r\nret = hex2bin(&buf[off++], &ptr[i], 1);\r\nif (ret < 0) {\r\npr_debug("%s: invalid hex string\n", __func__);\r\nreturn ret;\r\n}\r\ni += 2;\r\n}\r\nreturn 24;\r\n}\r\nstatic int sbp_get_pr_transport_id(\r\nstruct se_node_acl *nacl,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nint ret;\r\nret = hex2bin(&buf[8], nacl->initiatorname, 8);\r\nif (ret) {\r\npr_debug("%s: invalid hex string\n", __func__);\r\nreturn ret;\r\n}\r\nreturn 24;\r\n}\r\nstatic int srp_get_pr_transport_id(\r\nstruct se_node_acl *nacl,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nconst char *p;\r\nunsigned len, count, leading_zero_bytes;\r\nint rc;\r\np = nacl->initiatorname;\r\nif (strncasecmp(p, "0x", 2) == 0)\r\np += 2;\r\nlen = strlen(p);\r\nif (len % 2)\r\nreturn -EINVAL;\r\ncount = min(len / 2, 16U);\r\nleading_zero_bytes = 16 - count;\r\nmemset(buf + 8, 0, leading_zero_bytes);\r\nrc = hex2bin(buf + 8 + leading_zero_bytes, p, count);\r\nif (rc < 0) {\r\npr_debug("hex2bin failed for %s: %d\n", __func__, rc);\r\nreturn rc;\r\n}\r\nreturn 24;\r\n}\r\nstatic int iscsi_get_pr_transport_id(\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nu32 off = 4, padding = 0;\r\nu16 len = 0;\r\nspin_lock_irq(&se_nacl->nacl_sess_lock);\r\nlen = sprintf(&buf[off], "%s", se_nacl->initiatorname);\r\nlen++;\r\nif ((*format_code == 1) && (pr_reg->isid_present_at_reg)) {\r\nbuf[0] |= 0x40;\r\nbuf[off+len] = 0x2c; off++;\r\nbuf[off+len] = 0x69; off++;\r\nbuf[off+len] = 0x2c; off++;\r\nbuf[off+len] = 0x30; off++;\r\nbuf[off+len] = 0x78; off++;\r\nlen += 5;\r\nbuf[off+len] = pr_reg->pr_reg_isid[0]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[1]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[2]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[3]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[4]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[5]; off++;\r\nbuf[off+len] = '\0'; off++;\r\nlen += 7;\r\n}\r\nspin_unlock_irq(&se_nacl->nacl_sess_lock);\r\npadding = ((-len) & 3);\r\nif (padding != 0)\r\nlen += padding;\r\nput_unaligned_be16(len, &buf[2]);\r\nlen += 4;\r\nreturn len;\r\n}\r\nstatic int iscsi_get_pr_transport_id_len(\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code)\r\n{\r\nu32 len = 0, padding = 0;\r\nspin_lock_irq(&se_nacl->nacl_sess_lock);\r\nlen = strlen(se_nacl->initiatorname);\r\nlen++;\r\nif (pr_reg->isid_present_at_reg) {\r\nlen += 5;\r\nlen += 7;\r\n*format_code = 1;\r\n} else\r\n*format_code = 0;\r\nspin_unlock_irq(&se_nacl->nacl_sess_lock);\r\npadding = ((-len) & 3);\r\nif (padding != 0)\r\nlen += padding;\r\nlen += 4;\r\nreturn len;\r\n}\r\nstatic char *iscsi_parse_pr_out_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nconst char *buf,\r\nu32 *out_tid_len,\r\nchar **port_nexus_ptr)\r\n{\r\nchar *p;\r\nu32 tid_len, padding;\r\nint i;\r\nu16 add_len;\r\nu8 format_code = (buf[0] & 0xc0);\r\nif ((format_code != 0x00) && (format_code != 0x40)) {\r\npr_err("Illegal format code: 0x%02x for iSCSI"\r\n" Initiator Transport ID\n", format_code);\r\nreturn NULL;\r\n}\r\nif (out_tid_len) {\r\nadd_len = get_unaligned_be16(&buf[2]);\r\ntid_len = strlen(&buf[4]);\r\ntid_len += 4;\r\ntid_len += 1;\r\npadding = ((-tid_len) & 3);\r\nif (padding != 0)\r\ntid_len += padding;\r\nif ((add_len + 4) != tid_len) {\r\npr_debug("LIO-Target Extracted add_len: %hu "\r\n"does not match calculated tid_len: %u,"\r\n" using tid_len instead\n", add_len+4, tid_len);\r\n*out_tid_len = tid_len;\r\n} else\r\n*out_tid_len = (add_len + 4);\r\n}\r\nif (format_code == 0x40) {\r\np = strstr(&buf[4], ",i,0x");\r\nif (!p) {\r\npr_err("Unable to locate \",i,0x\" separator"\r\n" for Initiator port identifier: %s\n",\r\n&buf[4]);\r\nreturn NULL;\r\n}\r\n*p = '\0';\r\np += 5;\r\n*port_nexus_ptr = p;\r\nfor (i = 0; i < 12; i++) {\r\nif (isdigit(*p)) {\r\np++;\r\ncontinue;\r\n}\r\n*p = tolower(*p);\r\np++;\r\n}\r\n}\r\nreturn (char *)&buf[4];\r\n}\r\nint target_get_pr_transport_id_len(struct se_node_acl *nacl,\r\nstruct t10_pr_registration *pr_reg, int *format_code)\r\n{\r\nswitch (nacl->se_tpg->proto_id) {\r\ncase SCSI_PROTOCOL_FCP:\r\ncase SCSI_PROTOCOL_SBP:\r\ncase SCSI_PROTOCOL_SRP:\r\ncase SCSI_PROTOCOL_SAS:\r\nbreak;\r\ncase SCSI_PROTOCOL_ISCSI:\r\nreturn iscsi_get_pr_transport_id_len(nacl, pr_reg, format_code);\r\ndefault:\r\npr_err("Unknown proto_id: 0x%02x\n", nacl->se_tpg->proto_id);\r\nreturn -EINVAL;\r\n}\r\n*format_code = 0;\r\nreturn 24;\r\n}\r\nint target_get_pr_transport_id(struct se_node_acl *nacl,\r\nstruct t10_pr_registration *pr_reg, int *format_code,\r\nunsigned char *buf)\r\n{\r\nswitch (nacl->se_tpg->proto_id) {\r\ncase SCSI_PROTOCOL_SAS:\r\nreturn sas_get_pr_transport_id(nacl, format_code, buf);\r\ncase SCSI_PROTOCOL_SBP:\r\nreturn sbp_get_pr_transport_id(nacl, format_code, buf);\r\ncase SCSI_PROTOCOL_SRP:\r\nreturn srp_get_pr_transport_id(nacl, format_code, buf);\r\ncase SCSI_PROTOCOL_FCP:\r\nreturn fc_get_pr_transport_id(nacl, format_code, buf);\r\ncase SCSI_PROTOCOL_ISCSI:\r\nreturn iscsi_get_pr_transport_id(nacl, pr_reg, format_code,\r\nbuf);\r\ndefault:\r\npr_err("Unknown proto_id: 0x%02x\n", nacl->se_tpg->proto_id);\r\nreturn -EINVAL;\r\n}\r\n}\r\nconst char *target_parse_pr_out_transport_id(struct se_portal_group *tpg,\r\nconst char *buf, u32 *out_tid_len, char **port_nexus_ptr)\r\n{\r\nu32 offset;\r\nswitch (tpg->proto_id) {\r\ncase SCSI_PROTOCOL_SAS:\r\noffset = 4;\r\nbreak;\r\ncase SCSI_PROTOCOL_SBP:\r\ncase SCSI_PROTOCOL_SRP:\r\ncase SCSI_PROTOCOL_FCP:\r\noffset = 8;\r\nbreak;\r\ncase SCSI_PROTOCOL_ISCSI:\r\nreturn iscsi_parse_pr_out_transport_id(tpg, buf, out_tid_len,\r\nport_nexus_ptr);\r\ndefault:\r\npr_err("Unknown proto_id: 0x%02x\n", tpg->proto_id);\r\nreturn NULL;\r\n}\r\n*port_nexus_ptr = NULL;\r\n*out_tid_len = 24;\r\nreturn buf + offset;\r\n}

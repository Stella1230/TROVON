struct timespec *\r\nudf_disk_stamp_to_time(struct timespec *dest, struct timestamp src)\r\n{\r\nu16 typeAndTimezone = le16_to_cpu(src.typeAndTimezone);\r\nu16 year = le16_to_cpu(src.year);\r\nuint8_t type = typeAndTimezone >> 12;\r\nint16_t offset;\r\nif (type == 1) {\r\noffset = typeAndTimezone << 4;\r\noffset = (offset >> 4);\r\nif (offset == -2047)\r\noffset = 0;\r\n} else\r\noffset = 0;\r\ndest->tv_sec = mktime64(year, src.month, src.day, src.hour, src.minute,\r\nsrc.second);\r\ndest->tv_sec -= offset * 60;\r\ndest->tv_nsec = 1000 * (src.centiseconds * 10000 +\r\nsrc.hundredsOfMicroseconds * 100 + src.microseconds);\r\nreturn dest;\r\n}\r\nstruct timestamp *\r\nudf_time_to_disk_stamp(struct timestamp *dest, struct timespec ts)\r\n{\r\nlong seconds;\r\nint16_t offset;\r\nstruct tm tm;\r\noffset = -sys_tz.tz_minuteswest;\r\nif (!dest)\r\nreturn NULL;\r\ndest->typeAndTimezone = cpu_to_le16(0x1000 | (offset & 0x0FFF));\r\nseconds = ts.tv_sec + offset * 60;\r\ntime64_to_tm(seconds, 0, &tm);\r\ndest->year = cpu_to_le16(tm.tm_year + 1900);\r\ndest->month = tm.tm_mon + 1;\r\ndest->day = tm.tm_mday;\r\ndest->hour = tm.tm_hour;\r\ndest->minute = tm.tm_min;\r\ndest->second = tm.tm_sec;\r\ndest->centiseconds = ts.tv_nsec / 10000000;\r\ndest->hundredsOfMicroseconds = (ts.tv_nsec / 1000 -\r\ndest->centiseconds * 10000) / 100;\r\ndest->microseconds = (ts.tv_nsec / 1000 - dest->centiseconds * 10000 -\r\ndest->hundredsOfMicroseconds * 100);\r\nreturn dest;\r\n}

static void cros_ec_lpc_mec_emi_write_address(u16 addr,\r\nenum cros_ec_lpc_mec_emi_access_mode access_type)\r\n{\r\naddr -= MEC_EMI_RANGE_START;\r\noutb((addr & 0xfc) | access_type, MEC_EMI_EC_ADDRESS_B0);\r\noutb((addr >> 8) & 0x7f, MEC_EMI_EC_ADDRESS_B1);\r\n}\r\nu8 cros_ec_lpc_io_bytes_mec(enum cros_ec_lpc_mec_io_type io_type,\r\nunsigned int offset, unsigned int length,\r\nu8 *buf)\r\n{\r\nint i = 0;\r\nint io_addr;\r\nu8 sum = 0;\r\nenum cros_ec_lpc_mec_emi_access_mode access, new_access;\r\nif (offset & 0x3 || length < 4)\r\naccess = ACCESS_TYPE_BYTE;\r\nelse\r\naccess = ACCESS_TYPE_LONG_AUTO_INCREMENT;\r\nmutex_lock(&io_mutex);\r\ncros_ec_lpc_mec_emi_write_address(offset, access);\r\nio_addr = MEC_EMI_EC_DATA_B0 + (offset & 0x3);\r\nwhile (i < length) {\r\nwhile (io_addr <= MEC_EMI_EC_DATA_B3) {\r\nif (io_type == MEC_IO_READ)\r\nbuf[i] = inb(io_addr++);\r\nelse\r\noutb(buf[i], io_addr++);\r\nsum += buf[i++];\r\noffset++;\r\nif (i == length)\r\ngoto done;\r\n}\r\nif (length - i < 4 && io_type == MEC_IO_WRITE)\r\nnew_access = ACCESS_TYPE_BYTE;\r\nelse\r\nnew_access = ACCESS_TYPE_LONG_AUTO_INCREMENT;\r\nif (new_access != access ||\r\naccess != ACCESS_TYPE_LONG_AUTO_INCREMENT) {\r\naccess = new_access;\r\ncros_ec_lpc_mec_emi_write_address(offset, access);\r\n}\r\nio_addr = MEC_EMI_EC_DATA_B0;\r\n}\r\ndone:\r\nmutex_unlock(&io_mutex);\r\nreturn sum;\r\n}\r\nvoid cros_ec_lpc_mec_init(void)\r\n{\r\nmutex_init(&io_mutex);\r\n}\r\nvoid cros_ec_lpc_mec_destroy(void)\r\n{\r\nmutex_destroy(&io_mutex);\r\n}

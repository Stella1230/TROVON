void orinoco_wiphy_init(struct wiphy *wiphy)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nwiphy->privid = orinoco_wiphy_privid;\r\nset_wiphy_dev(wiphy, priv->dev);\r\n}\r\nint orinoco_wiphy_register(struct wiphy *wiphy)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nint i, channels = 0;\r\nif (priv->firmware_type == FIRMWARE_TYPE_AGERE)\r\nwiphy->max_scan_ssids = 1;\r\nelse\r\nwiphy->max_scan_ssids = 0;\r\nwiphy->interface_modes = BIT(NL80211_IFTYPE_STATION);\r\nif (priv->has_ibss)\r\nwiphy->interface_modes |= BIT(NL80211_IFTYPE_ADHOC);\r\nif (!priv->broken_monitor || force_monitor)\r\nwiphy->interface_modes |= BIT(NL80211_IFTYPE_MONITOR);\r\npriv->band.bitrates = orinoco_rates;\r\npriv->band.n_bitrates = ARRAY_SIZE(orinoco_rates);\r\nfor (i = 0; i < NUM_CHANNELS; i++) {\r\nif (priv->channel_mask & (1 << i)) {\r\npriv->channels[i].center_freq =\r\nieee80211_channel_to_frequency(i + 1,\r\nNL80211_BAND_2GHZ);\r\nchannels++;\r\n}\r\n}\r\npriv->band.channels = priv->channels;\r\npriv->band.n_channels = channels;\r\nwiphy->bands[NL80211_BAND_2GHZ] = &priv->band;\r\nwiphy->signal_type = CFG80211_SIGNAL_TYPE_MBM;\r\ni = 0;\r\nif (priv->has_wep) {\r\npriv->cipher_suites[i] = WLAN_CIPHER_SUITE_WEP40;\r\ni++;\r\nif (priv->has_big_wep) {\r\npriv->cipher_suites[i] = WLAN_CIPHER_SUITE_WEP104;\r\ni++;\r\n}\r\n}\r\nif (priv->has_wpa) {\r\npriv->cipher_suites[i] = WLAN_CIPHER_SUITE_TKIP;\r\ni++;\r\n}\r\nwiphy->cipher_suites = priv->cipher_suites;\r\nwiphy->n_cipher_suites = i;\r\nwiphy->rts_threshold = priv->rts_thresh;\r\nif (!priv->has_mwo)\r\nwiphy->frag_threshold = priv->frag_thresh + 1;\r\nwiphy->retry_short = priv->short_retry_limit;\r\nwiphy->retry_long = priv->long_retry_limit;\r\nreturn wiphy_register(wiphy);\r\n}\r\nstatic int orinoco_change_vif(struct wiphy *wiphy, struct net_device *dev,\r\nenum nl80211_iftype type,\r\nstruct vif_params *params)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nint err = 0;\r\nunsigned long lock;\r\nif (orinoco_lock(priv, &lock) != 0)\r\nreturn -EBUSY;\r\nswitch (type) {\r\ncase NL80211_IFTYPE_ADHOC:\r\nif (!priv->has_ibss && !priv->has_port3)\r\nerr = -EINVAL;\r\nbreak;\r\ncase NL80211_IFTYPE_STATION:\r\nbreak;\r\ncase NL80211_IFTYPE_MONITOR:\r\nif (priv->broken_monitor && !force_monitor) {\r\nwiphy_warn(wiphy,\r\n"Monitor mode support is buggy in this firmware, not enabling\n");\r\nerr = -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nif (!err) {\r\npriv->iw_mode = type;\r\nset_port_type(priv);\r\nerr = orinoco_commit(priv);\r\n}\r\norinoco_unlock(priv, &lock);\r\nreturn err;\r\n}\r\nstatic int orinoco_scan(struct wiphy *wiphy,\r\nstruct cfg80211_scan_request *request)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nint err;\r\nif (!request)\r\nreturn -EINVAL;\r\nif (priv->scan_request && priv->scan_request != request)\r\nreturn -EBUSY;\r\npriv->scan_request = request;\r\nerr = orinoco_hw_trigger_scan(priv, request->ssids);\r\nif (err)\r\npriv->scan_request = NULL;\r\nreturn err;\r\n}\r\nstatic int orinoco_set_monitor_channel(struct wiphy *wiphy,\r\nstruct cfg80211_chan_def *chandef)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nint err = 0;\r\nunsigned long flags;\r\nint channel;\r\nif (!chandef->chan)\r\nreturn -EINVAL;\r\nif (cfg80211_get_chandef_type(chandef) != NL80211_CHAN_NO_HT)\r\nreturn -EINVAL;\r\nif (chandef->chan->band != NL80211_BAND_2GHZ)\r\nreturn -EINVAL;\r\nchannel = ieee80211_frequency_to_channel(chandef->chan->center_freq);\r\nif ((channel < 1) || (channel > NUM_CHANNELS) ||\r\n!(priv->channel_mask & (1 << (channel - 1))))\r\nreturn -EINVAL;\r\nif (orinoco_lock(priv, &flags) != 0)\r\nreturn -EBUSY;\r\npriv->channel = channel;\r\nif (priv->iw_mode == NL80211_IFTYPE_MONITOR) {\r\nstruct hermes *hw = &priv->hw;\r\nerr = hw->ops->cmd_wait(hw, HERMES_CMD_TEST |\r\nHERMES_TEST_SET_CHANNEL,\r\nchannel, NULL);\r\n}\r\norinoco_unlock(priv, &flags);\r\nreturn err;\r\n}\r\nstatic int orinoco_set_wiphy_params(struct wiphy *wiphy, u32 changed)\r\n{\r\nstruct orinoco_private *priv = wiphy_priv(wiphy);\r\nint frag_value = -1;\r\nint rts_value = -1;\r\nint err = 0;\r\nif (changed & WIPHY_PARAM_RETRY_SHORT) {\r\nerr = -EINVAL;\r\n}\r\nif (changed & WIPHY_PARAM_RETRY_LONG) {\r\nerr = -EINVAL;\r\n}\r\nif (changed & WIPHY_PARAM_FRAG_THRESHOLD) {\r\nif (priv->has_mwo) {\r\nif (wiphy->frag_threshold == -1)\r\nfrag_value = 0;\r\nelse {\r\nprintk(KERN_WARNING "%s: Fixed fragmentation "\r\n"is not supported on this firmware. "\r\n"Using MWO robust instead.\n",\r\npriv->ndev->name);\r\nfrag_value = 1;\r\n}\r\n} else {\r\nif (wiphy->frag_threshold == -1)\r\nfrag_value = 2346;\r\nelse if ((wiphy->frag_threshold < 257) ||\r\n(wiphy->frag_threshold > 2347))\r\nerr = -EINVAL;\r\nelse\r\nfrag_value = wiphy->frag_threshold & ~0x1;\r\n}\r\n}\r\nif (changed & WIPHY_PARAM_RTS_THRESHOLD) {\r\nif (wiphy->rts_threshold == -1)\r\nrts_value = 2347;\r\nelse if (wiphy->rts_threshold > 2347)\r\nerr = -EINVAL;\r\nelse\r\nrts_value = wiphy->rts_threshold;\r\n}\r\nif (!err) {\r\nunsigned long flags;\r\nif (orinoco_lock(priv, &flags) != 0)\r\nreturn -EBUSY;\r\nif (frag_value >= 0) {\r\nif (priv->has_mwo)\r\npriv->mwo_robust = frag_value;\r\nelse\r\npriv->frag_thresh = frag_value;\r\n}\r\nif (rts_value >= 0)\r\npriv->rts_thresh = rts_value;\r\nerr = orinoco_commit(priv);\r\norinoco_unlock(priv, &flags);\r\n}\r\nreturn err;\r\n}

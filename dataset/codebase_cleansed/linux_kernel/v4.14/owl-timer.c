static inline void owl_timer_reset(void __iomem *base)\r\n{\r\nwritel(0, base + OWL_Tx_CTL);\r\nwritel(0, base + OWL_Tx_VAL);\r\nwritel(0, base + OWL_Tx_CMP);\r\n}\r\nstatic inline void owl_timer_set_enabled(void __iomem *base, bool enabled)\r\n{\r\nu32 ctl = readl(base + OWL_Tx_CTL);\r\nctl &= ~OWL_Tx_CTL_PD;\r\nif (enabled)\r\nctl |= OWL_Tx_CTL_EN;\r\nelse\r\nctl &= ~OWL_Tx_CTL_EN;\r\nwritel(ctl, base + OWL_Tx_CTL);\r\n}\r\nstatic u64 notrace owl_timer_sched_read(void)\r\n{\r\nreturn (u64)readl(owl_clksrc_base + OWL_Tx_VAL);\r\n}\r\nstatic int owl_timer_set_state_shutdown(struct clock_event_device *evt)\r\n{\r\nowl_timer_set_enabled(owl_clkevt_base, false);\r\nreturn 0;\r\n}\r\nstatic int owl_timer_set_state_oneshot(struct clock_event_device *evt)\r\n{\r\nowl_timer_reset(owl_clkevt_base);\r\nreturn 0;\r\n}\r\nstatic int owl_timer_tick_resume(struct clock_event_device *evt)\r\n{\r\nreturn 0;\r\n}\r\nstatic int owl_timer_set_next_event(unsigned long evt,\r\nstruct clock_event_device *ev)\r\n{\r\nvoid __iomem *base = owl_clkevt_base;\r\nowl_timer_set_enabled(base, false);\r\nwritel(OWL_Tx_CTL_INTEN, base + OWL_Tx_CTL);\r\nwritel(0, base + OWL_Tx_VAL);\r\nwritel(evt, base + OWL_Tx_CMP);\r\nowl_timer_set_enabled(base, true);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t owl_timer1_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\r\nwritel(OWL_Tx_CTL_PD, owl_clkevt_base + OWL_Tx_CTL);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init owl_timer_init(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nunsigned long rate;\r\nint timer1_irq, ret;\r\nowl_timer_base = of_io_request_and_map(node, 0, "owl-timer");\r\nif (IS_ERR(owl_timer_base)) {\r\npr_err("Can't map timer registers");\r\nreturn PTR_ERR(owl_timer_base);\r\n}\r\nowl_clksrc_base = owl_timer_base + 0x08;\r\nowl_clkevt_base = owl_timer_base + 0x14;\r\ntimer1_irq = of_irq_get_byname(node, "timer1");\r\nif (timer1_irq <= 0) {\r\npr_err("Can't parse timer1 IRQ");\r\nreturn -EINVAL;\r\n}\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nrate = clk_get_rate(clk);\r\nowl_timer_reset(owl_clksrc_base);\r\nowl_timer_set_enabled(owl_clksrc_base, true);\r\nsched_clock_register(owl_timer_sched_read, 32, rate);\r\nclocksource_mmio_init(owl_clksrc_base + OWL_Tx_VAL, node->name,\r\nrate, 200, 32, clocksource_mmio_readl_up);\r\nowl_timer_reset(owl_clkevt_base);\r\nret = request_irq(timer1_irq, owl_timer1_interrupt, IRQF_TIMER,\r\n"owl-timer", &owl_clockevent);\r\nif (ret) {\r\npr_err("failed to request irq %d\n", timer1_irq);\r\nreturn ret;\r\n}\r\nowl_clockevent.cpumask = cpumask_of(0);\r\nowl_clockevent.irq = timer1_irq;\r\nclockevents_config_and_register(&owl_clockevent, rate,\r\n0xf, 0xffffffff);\r\nreturn 0;\r\n}

static signed int to_signed(unsigned int a)\r\n{\r\nif (a <= 7)\r\nreturn a;\r\nelse\r\nreturn a - 16;\r\n}\r\nstatic unsigned long modulo(unsigned long a, unsigned long b)\r\n{\r\nif (a >= b)\r\nreturn a - b;\r\nelse\r\nreturn a;\r\n}\r\nbool meson_venc_hdmi_supported_vic(int vic)\r\n{\r\nstruct meson_hdmi_venc_vic_mode *vmode = meson_hdmi_venc_vic_modes;\r\nwhile (vmode->vic && vmode->mode) {\r\nif (vmode->vic == vic)\r\nreturn true;\r\nvmode++;\r\n}\r\nreturn false;\r\n}\r\nstatic union meson_hdmi_venc_mode *meson_venc_hdmi_get_vic_vmode(int vic)\r\n{\r\nstruct meson_hdmi_venc_vic_mode *vmode = meson_hdmi_venc_vic_modes;\r\nwhile (vmode->vic && vmode->mode) {\r\nif (vmode->vic == vic)\r\nreturn vmode->mode;\r\nvmode++;\r\n}\r\nreturn NULL;\r\n}\r\nbool meson_venc_hdmi_venc_repeat(int vic)\r\n{\r\nif (vic == 6 || vic == 7 ||\r\nvic == 21 || vic == 22 ||\r\nvic == 17 || vic == 18 ||\r\nvic == 2 || vic == 3 ||\r\nvic == 4 ||\r\nvic == 19 ||\r\nvic == 5 ||\r\nvic == 20)\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid meson_venc_hdmi_mode_set(struct meson_drm *priv, int vic,\r\nstruct drm_display_mode *mode)\r\n{\r\nunion meson_hdmi_venc_mode *vmode = NULL;\r\nbool use_enci = false;\r\nbool venc_repeat = false;\r\nbool hdmi_repeat = false;\r\nunsigned int venc_hdmi_latency = 2;\r\nunsigned long total_pixels_venc = 0;\r\nunsigned long active_pixels_venc = 0;\r\nunsigned long front_porch_venc = 0;\r\nunsigned long hsync_pixels_venc = 0;\r\nunsigned long de_h_begin = 0;\r\nunsigned long de_h_end = 0;\r\nunsigned long de_v_begin_even = 0;\r\nunsigned long de_v_end_even = 0;\r\nunsigned long de_v_begin_odd = 0;\r\nunsigned long de_v_end_odd = 0;\r\nunsigned long hs_begin = 0;\r\nunsigned long hs_end = 0;\r\nunsigned long vs_adjust = 0;\r\nunsigned long vs_bline_evn = 0;\r\nunsigned long vs_eline_evn = 0;\r\nunsigned long vs_bline_odd = 0;\r\nunsigned long vs_eline_odd = 0;\r\nunsigned long vso_begin_evn = 0;\r\nunsigned long vso_begin_odd = 0;\r\nunsigned int eof_lines;\r\nunsigned int sof_lines;\r\nunsigned int vsync_lines;\r\nvmode = meson_venc_hdmi_get_vic_vmode(vic);\r\nif (!vmode) {\r\ndev_err(priv->dev, "%s: Fatal Error, unsupported vic %d\n",\r\n__func__, vic);\r\nreturn;\r\n}\r\nif (mode->flags & DRM_MODE_FLAG_DBLCLK) {\r\nhdmi_repeat = true;\r\nuse_enci = true;\r\nvenc_hdmi_latency = 1;\r\n}\r\nif (meson_venc_hdmi_venc_repeat(vic))\r\nvenc_repeat = true;\r\neof_lines = mode->vsync_start - mode->vdisplay;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\neof_lines /= 2;\r\nsof_lines = mode->vtotal - mode->vsync_end;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\nsof_lines /= 2;\r\nvsync_lines = mode->vsync_end - mode->vsync_start;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\nvsync_lines /= 2;\r\ntotal_pixels_venc = mode->htotal;\r\nif (hdmi_repeat)\r\ntotal_pixels_venc /= 2;\r\nif (venc_repeat)\r\ntotal_pixels_venc *= 2;\r\nactive_pixels_venc = mode->hdisplay;\r\nif (hdmi_repeat)\r\nactive_pixels_venc /= 2;\r\nif (venc_repeat)\r\nactive_pixels_venc *= 2;\r\nfront_porch_venc = (mode->hsync_start - mode->hdisplay);\r\nif (hdmi_repeat)\r\nfront_porch_venc /= 2;\r\nif (venc_repeat)\r\nfront_porch_venc *= 2;\r\nhsync_pixels_venc = (mode->hsync_end - mode->hsync_start);\r\nif (hdmi_repeat)\r\nhsync_pixels_venc /= 2;\r\nif (venc_repeat)\r\nhsync_pixels_venc *= 2;\r\nwritel_bits_relaxed(0x1f, 0x1f,\r\npriv->io_base + _REG(VENC_VDAC_SETTING));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_EN));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCP_VIDEO_EN));\r\nif (use_enci) {\r\nunsigned int lines_f0;\r\nunsigned int lines_f1;\r\nwritel_relaxed(0x12, priv->io_base + _REG(ENCI_CFILT_CTRL));\r\nwritel_relaxed(0x12, priv->io_base + _REG(ENCI_CFILT_CTRL2));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_DVI_SETTING));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\r\nwritel_relaxed(vmode->enci.hso_begin,\r\npriv->io_base + _REG(ENCI_SYNC_HSO_BEGIN));\r\nwritel_relaxed(vmode->enci.hso_end,\r\npriv->io_base + _REG(ENCI_SYNC_HSO_END));\r\nwritel_relaxed(vmode->enci.vso_even,\r\npriv->io_base + _REG(ENCI_SYNC_VSO_EVNLN));\r\nwritel_relaxed(vmode->enci.vso_odd,\r\npriv->io_base + _REG(ENCI_SYNC_VSO_ODDLN));\r\nwritel_relaxed(vmode->enci.macv_max_amp,\r\npriv->io_base + _REG(ENCI_MACV_MAX_AMP));\r\nwritel_relaxed(vmode->enci.video_prog_mode,\r\npriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\r\nwritel_relaxed(vmode->enci.video_mode,\r\npriv->io_base + _REG(ENCI_VIDEO_MODE));\r\nwritel_relaxed(0x26, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\r\nwritel(vmode->enci.sch_adjust,\r\npriv->io_base + _REG(ENCI_VIDEO_SCH));\r\nwritel_relaxed(0x07, priv->io_base + _REG(ENCI_SYNC_MODE));\r\nif (vmode->enci.yc_delay)\r\nwritel_relaxed(vmode->enci.yc_delay,\r\npriv->io_base + _REG(ENCI_YC_DELAY));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_DBG_PX_RST));\r\nwritel_relaxed(0x4e01, priv->io_base + _REG(ENCI_VFIFO2VD_CTL));\r\nwritel_relaxed(vmode->enci.pixel_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_START));\r\nwritel_relaxed(vmode->enci.pixel_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_END));\r\nwritel_relaxed(vmode->enci.top_field_line_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_START));\r\nwritel_relaxed(vmode->enci.top_field_line_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_END));\r\nwritel_relaxed(vmode->enci.bottom_field_line_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_START));\r\nwritel_relaxed(vmode->enci.bottom_field_line_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_END));\r\nmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCI);\r\nwritel_relaxed(1, priv->io_base + _REG(ENCI_VIDEO_EN));\r\nlines_f0 = mode->vtotal >> 1;\r\nlines_f1 = lines_f0 + 1;\r\nde_h_begin = modulo(readl_relaxed(priv->io_base +\r\n_REG(ENCI_VFIFO2VD_PIXEL_START))\r\n+ venc_hdmi_latency,\r\ntotal_pixels_venc);\r\nde_h_end = modulo(de_h_begin + active_pixels_venc,\r\ntotal_pixels_venc);\r\nwritel_relaxed(de_h_begin,\r\npriv->io_base + _REG(ENCI_DE_H_BEGIN));\r\nwritel_relaxed(de_h_end,\r\npriv->io_base + _REG(ENCI_DE_H_END));\r\nde_v_begin_even = readl_relaxed(priv->io_base +\r\n_REG(ENCI_VFIFO2VD_LINE_TOP_START));\r\nde_v_end_even = de_v_begin_even + mode->vdisplay;\r\nde_v_begin_odd = readl_relaxed(priv->io_base +\r\n_REG(ENCI_VFIFO2VD_LINE_BOT_START));\r\nde_v_end_odd = de_v_begin_odd + mode->vdisplay;\r\nwritel_relaxed(de_v_begin_even,\r\npriv->io_base + _REG(ENCI_DE_V_BEGIN_EVEN));\r\nwritel_relaxed(de_v_end_even,\r\npriv->io_base + _REG(ENCI_DE_V_END_EVEN));\r\nwritel_relaxed(de_v_begin_odd,\r\npriv->io_base + _REG(ENCI_DE_V_BEGIN_ODD));\r\nwritel_relaxed(de_v_end_odd,\r\npriv->io_base + _REG(ENCI_DE_V_END_ODD));\r\nhs_begin = de_h_end + front_porch_venc;\r\nif (de_h_end + front_porch_venc >= total_pixels_venc) {\r\nhs_begin -= total_pixels_venc;\r\nvs_adjust = 1;\r\n} else {\r\nhs_begin = de_h_end + front_porch_venc;\r\nvs_adjust = 0;\r\n}\r\nhs_end = modulo(hs_begin + hsync_pixels_venc,\r\ntotal_pixels_venc);\r\nwritel_relaxed(hs_begin,\r\npriv->io_base + _REG(ENCI_DVI_HSO_BEGIN));\r\nwritel_relaxed(hs_end,\r\npriv->io_base + _REG(ENCI_DVI_HSO_END));\r\nif (((de_v_end_odd - 1) + eof_lines + vs_adjust) >= lines_f1) {\r\nvs_bline_evn = (de_v_end_odd - 1)\r\n+ eof_lines\r\n+ vs_adjust\r\n- lines_f1;\r\nvs_eline_evn = vs_bline_evn + vsync_lines;\r\nwritel_relaxed(vs_bline_evn,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BLINE_EVN));\r\nwritel_relaxed(vs_eline_evn,\r\npriv->io_base + _REG(ENCI_DVI_VSO_ELINE_EVN));\r\nwritel_relaxed(hs_begin,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_EVN));\r\nwritel_relaxed(hs_begin,\r\npriv->io_base + _REG(ENCI_DVI_VSO_END_EVN));\r\n} else {\r\nvs_bline_odd = (de_v_end_odd - 1)\r\n+ eof_lines\r\n+ vs_adjust;\r\nwritel_relaxed(vs_bline_odd,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BLINE_ODD));\r\nwritel_relaxed(hs_begin,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_ODD));\r\nif ((vs_bline_odd + vsync_lines) >= lines_f1) {\r\nvs_eline_evn = vs_bline_odd\r\n+ vsync_lines\r\n- lines_f1;\r\nwritel_relaxed(vs_eline_evn, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_ELINE_EVN));\r\nwritel_relaxed(hs_begin, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_END_EVN));\r\n} else {\r\nvs_eline_odd = vs_bline_odd\r\n+ vsync_lines;\r\nwritel_relaxed(vs_eline_odd, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_ELINE_ODD));\r\nwritel_relaxed(hs_begin, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_END_ODD));\r\n}\r\n}\r\nif (((de_v_end_even - 1) + (eof_lines + 1)) >= lines_f0) {\r\nvs_bline_odd = (de_v_end_even - 1)\r\n+ (eof_lines + 1)\r\n- lines_f0;\r\nvs_eline_odd = vs_bline_odd + vsync_lines;\r\nwritel_relaxed(vs_bline_odd,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BLINE_ODD));\r\nwritel_relaxed(vs_eline_odd,\r\npriv->io_base + _REG(ENCI_DVI_VSO_ELINE_ODD));\r\nvso_begin_odd = modulo(hs_begin\r\n+ (total_pixels_venc >> 1),\r\ntotal_pixels_venc);\r\nwritel_relaxed(vso_begin_odd,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BEGIN_ODD));\r\nwritel_relaxed(vso_begin_odd,\r\npriv->io_base + _REG(ENCI_DVI_VSO_END_ODD));\r\n} else {\r\nvs_bline_evn = (de_v_end_even - 1)\r\n+ (eof_lines + 1);\r\nwritel_relaxed(vs_bline_evn,\r\npriv->io_base + _REG(ENCI_DVI_VSO_BLINE_EVN));\r\nvso_begin_evn = modulo(hs_begin\r\n+ (total_pixels_venc >> 1),\r\ntotal_pixels_venc);\r\nwritel_relaxed(vso_begin_evn, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_BEGIN_EVN));\r\nif (vs_bline_evn + vsync_lines >= lines_f0) {\r\nvs_eline_odd = vs_bline_evn\r\n+ vsync_lines\r\n- lines_f0;\r\nwritel_relaxed(vs_eline_odd, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_ELINE_ODD));\r\nwritel_relaxed(vso_begin_evn, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_END_ODD));\r\n} else {\r\nvs_eline_evn = vs_bline_evn + vsync_lines;\r\nwritel_relaxed(vs_eline_evn, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_ELINE_EVN));\r\nwritel_relaxed(vso_begin_evn, priv->io_base\r\n+ _REG(ENCI_DVI_VSO_END_EVN));\r\n}\r\n}\r\n} else {\r\nwritel_relaxed(vmode->encp.dvi_settings,\r\npriv->io_base + _REG(VENC_DVI_SETTING));\r\nwritel_relaxed(vmode->encp.video_mode,\r\npriv->io_base + _REG(ENCP_VIDEO_MODE));\r\nwritel_relaxed(vmode->encp.video_mode_adv,\r\npriv->io_base + _REG(ENCP_VIDEO_MODE_ADV));\r\nif (vmode->encp.video_prog_mode_present)\r\nwritel_relaxed(vmode->encp.video_prog_mode,\r\npriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\r\nif (vmode->encp.video_sync_mode_present)\r\nwritel_relaxed(vmode->encp.video_sync_mode,\r\npriv->io_base + _REG(ENCP_VIDEO_SYNC_MODE));\r\nif (vmode->encp.video_yc_dly_present)\r\nwritel_relaxed(vmode->encp.video_yc_dly,\r\npriv->io_base + _REG(ENCP_VIDEO_YC_DLY));\r\nif (vmode->encp.video_rgb_ctrl_present)\r\nwritel_relaxed(vmode->encp.video_rgb_ctrl,\r\npriv->io_base + _REG(ENCP_VIDEO_RGB_CTRL));\r\nif (vmode->encp.video_filt_ctrl_present)\r\nwritel_relaxed(vmode->encp.video_filt_ctrl,\r\npriv->io_base + _REG(ENCP_VIDEO_FILT_CTRL));\r\nif (vmode->encp.video_ofld_voav_ofst_present)\r\nwritel_relaxed(vmode->encp.video_ofld_voav_ofst,\r\npriv->io_base\r\n+ _REG(ENCP_VIDEO_OFLD_VOAV_OFST));\r\nwritel_relaxed(vmode->encp.yfp1_htime,\r\npriv->io_base + _REG(ENCP_VIDEO_YFP1_HTIME));\r\nwritel_relaxed(vmode->encp.yfp2_htime,\r\npriv->io_base + _REG(ENCP_VIDEO_YFP2_HTIME));\r\nwritel_relaxed(vmode->encp.max_pxcnt,\r\npriv->io_base + _REG(ENCP_VIDEO_MAX_PXCNT));\r\nwritel_relaxed(vmode->encp.hspuls_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_HSPULS_BEGIN));\r\nwritel_relaxed(vmode->encp.hspuls_end,\r\npriv->io_base + _REG(ENCP_VIDEO_HSPULS_END));\r\nwritel_relaxed(vmode->encp.hspuls_switch,\r\npriv->io_base + _REG(ENCP_VIDEO_HSPULS_SWITCH));\r\nwritel_relaxed(vmode->encp.vspuls_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_VSPULS_BEGIN));\r\nwritel_relaxed(vmode->encp.vspuls_end,\r\npriv->io_base + _REG(ENCP_VIDEO_VSPULS_END));\r\nwritel_relaxed(vmode->encp.vspuls_bline,\r\npriv->io_base + _REG(ENCP_VIDEO_VSPULS_BLINE));\r\nwritel_relaxed(vmode->encp.vspuls_eline,\r\npriv->io_base + _REG(ENCP_VIDEO_VSPULS_ELINE));\r\nif (vmode->encp.eqpuls_begin_present)\r\nwritel_relaxed(vmode->encp.eqpuls_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_EQPULS_BEGIN));\r\nif (vmode->encp.eqpuls_end_present)\r\nwritel_relaxed(vmode->encp.eqpuls_end,\r\npriv->io_base + _REG(ENCP_VIDEO_EQPULS_END));\r\nif (vmode->encp.eqpuls_bline_present)\r\nwritel_relaxed(vmode->encp.eqpuls_bline,\r\npriv->io_base + _REG(ENCP_VIDEO_EQPULS_BLINE));\r\nif (vmode->encp.eqpuls_eline_present)\r\nwritel_relaxed(vmode->encp.eqpuls_eline,\r\npriv->io_base + _REG(ENCP_VIDEO_EQPULS_ELINE));\r\nwritel_relaxed(vmode->encp.havon_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_HAVON_BEGIN));\r\nwritel_relaxed(vmode->encp.havon_end,\r\npriv->io_base + _REG(ENCP_VIDEO_HAVON_END));\r\nwritel_relaxed(vmode->encp.vavon_bline,\r\npriv->io_base + _REG(ENCP_VIDEO_VAVON_BLINE));\r\nwritel_relaxed(vmode->encp.vavon_eline,\r\npriv->io_base + _REG(ENCP_VIDEO_VAVON_ELINE));\r\nwritel_relaxed(vmode->encp.hso_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_HSO_BEGIN));\r\nwritel_relaxed(vmode->encp.hso_end,\r\npriv->io_base + _REG(ENCP_VIDEO_HSO_END));\r\nwritel_relaxed(vmode->encp.vso_begin,\r\npriv->io_base + _REG(ENCP_VIDEO_VSO_BEGIN));\r\nwritel_relaxed(vmode->encp.vso_end,\r\npriv->io_base + _REG(ENCP_VIDEO_VSO_END));\r\nwritel_relaxed(vmode->encp.vso_bline,\r\npriv->io_base + _REG(ENCP_VIDEO_VSO_BLINE));\r\nif (vmode->encp.vso_eline_present)\r\nwritel_relaxed(vmode->encp.vso_eline,\r\npriv->io_base + _REG(ENCP_VIDEO_VSO_ELINE));\r\nif (vmode->encp.sy_val_present)\r\nwritel_relaxed(vmode->encp.sy_val,\r\npriv->io_base + _REG(ENCP_VIDEO_SY_VAL));\r\nif (vmode->encp.sy2_val_present)\r\nwritel_relaxed(vmode->encp.sy2_val,\r\npriv->io_base + _REG(ENCP_VIDEO_SY2_VAL));\r\nwritel_relaxed(vmode->encp.max_lncnt,\r\npriv->io_base + _REG(ENCP_VIDEO_MAX_LNCNT));\r\nwritel_relaxed(1, priv->io_base + _REG(ENCP_VIDEO_EN));\r\nwritel_bits_relaxed(BIT(14), BIT(14),\r\npriv->io_base + _REG(ENCP_VIDEO_MODE));\r\nde_h_begin = modulo(readl_relaxed(priv->io_base +\r\n_REG(ENCP_VIDEO_HAVON_BEGIN))\r\n+ venc_hdmi_latency,\r\ntotal_pixels_venc);\r\nde_h_end = modulo(de_h_begin + active_pixels_venc,\r\ntotal_pixels_venc);\r\nwritel_relaxed(de_h_begin,\r\npriv->io_base + _REG(ENCP_DE_H_BEGIN));\r\nwritel_relaxed(de_h_end,\r\npriv->io_base + _REG(ENCP_DE_H_END));\r\nde_v_begin_even = readl_relaxed(priv->io_base\r\n+ _REG(ENCP_VIDEO_VAVON_BLINE));\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\nde_v_end_even = de_v_begin_even +\r\n(mode->vdisplay / 2);\r\nelse\r\nde_v_end_even = de_v_begin_even + mode->vdisplay;\r\nwritel_relaxed(de_v_begin_even,\r\npriv->io_base + _REG(ENCP_DE_V_BEGIN_EVEN));\r\nwritel_relaxed(de_v_end_even,\r\npriv->io_base + _REG(ENCP_DE_V_END_EVEN));\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\r\nunsigned int ofld_voav_ofst =\r\nreadl_relaxed(priv->io_base +\r\n_REG(ENCP_VIDEO_OFLD_VOAV_OFST));\r\nde_v_begin_odd = to_signed((ofld_voav_ofst & 0xf0) >> 4)\r\n+ de_v_begin_even\r\n+ ((mode->vtotal - 1) / 2);\r\nde_v_end_odd = de_v_begin_odd + (mode->vdisplay / 2);\r\nwritel_relaxed(de_v_begin_odd,\r\npriv->io_base + _REG(ENCP_DE_V_BEGIN_ODD));\r\nwritel_relaxed(de_v_end_odd,\r\npriv->io_base + _REG(ENCP_DE_V_END_ODD));\r\n}\r\nif ((de_h_end + front_porch_venc) >= total_pixels_venc) {\r\nhs_begin = de_h_end\r\n+ front_porch_venc\r\n- total_pixels_venc;\r\nvs_adjust = 1;\r\n} else {\r\nhs_begin = de_h_end\r\n+ front_porch_venc;\r\nvs_adjust = 0;\r\n}\r\nhs_end = modulo(hs_begin + hsync_pixels_venc,\r\ntotal_pixels_venc);\r\nwritel_relaxed(hs_begin,\r\npriv->io_base + _REG(ENCP_DVI_HSO_BEGIN));\r\nwritel_relaxed(hs_end,\r\npriv->io_base + _REG(ENCP_DVI_HSO_END));\r\nif (de_v_begin_even >=\r\n(sof_lines + vsync_lines + (1 - vs_adjust)))\r\nvs_bline_evn = de_v_begin_even\r\n- sof_lines\r\n- vsync_lines\r\n- (1 - vs_adjust);\r\nelse\r\nvs_bline_evn = mode->vtotal\r\n+ de_v_begin_even\r\n- sof_lines\r\n- vsync_lines\r\n- (1 - vs_adjust);\r\nvs_eline_evn = modulo(vs_bline_evn + vsync_lines,\r\nmode->vtotal);\r\nwritel_relaxed(vs_bline_evn,\r\npriv->io_base + _REG(ENCP_DVI_VSO_BLINE_EVN));\r\nwritel_relaxed(vs_eline_evn,\r\npriv->io_base + _REG(ENCP_DVI_VSO_ELINE_EVN));\r\nvso_begin_evn = hs_begin;\r\nwritel_relaxed(vso_begin_evn,\r\npriv->io_base + _REG(ENCP_DVI_VSO_BEGIN_EVN));\r\nwritel_relaxed(vso_begin_evn,\r\npriv->io_base + _REG(ENCP_DVI_VSO_END_EVN));\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\r\nvs_bline_odd = (de_v_begin_odd - 1)\r\n- sof_lines\r\n- vsync_lines;\r\nvs_eline_odd = (de_v_begin_odd - 1)\r\n- vsync_lines;\r\nvso_begin_odd = modulo(hs_begin\r\n+ (total_pixels_venc >> 1),\r\ntotal_pixels_venc);\r\nwritel_relaxed(vs_bline_odd,\r\npriv->io_base + _REG(ENCP_DVI_VSO_BLINE_ODD));\r\nwritel_relaxed(vs_eline_odd,\r\npriv->io_base + _REG(ENCP_DVI_VSO_ELINE_ODD));\r\nwritel_relaxed(vso_begin_odd,\r\npriv->io_base + _REG(ENCP_DVI_VSO_BEGIN_ODD));\r\nwritel_relaxed(vso_begin_odd,\r\npriv->io_base + _REG(ENCP_DVI_VSO_END_ODD));\r\n}\r\nmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCP);\r\n}\r\nwritel_relaxed((use_enci ? 1 : 2) |\r\n(mode->flags & DRM_MODE_FLAG_PHSYNC ? 1 << 2 : 0) |\r\n(mode->flags & DRM_MODE_FLAG_PVSYNC ? 1 << 3 : 0) |\r\n4 << 5 |\r\n(venc_repeat ? 1 << 8 : 0) |\r\n(hdmi_repeat ? 1 << 12 : 0),\r\npriv->io_base + _REG(VPU_HDMI_SETTING));\r\npriv->venc.hdmi_repeat = hdmi_repeat;\r\npriv->venc.venc_repeat = venc_repeat;\r\npriv->venc.hdmi_use_enci = use_enci;\r\npriv->venc.current_mode = MESON_VENC_MODE_HDMI;\r\n}\r\nvoid meson_venci_cvbs_mode_set(struct meson_drm *priv,\r\nstruct meson_cvbs_enci_mode *mode)\r\n{\r\nif (mode->mode_tag == priv->venc.current_mode)\r\nreturn;\r\nwritel_relaxed(0x12, priv->io_base + _REG(ENCI_CFILT_CTRL));\r\nwritel_relaxed(0x12, priv->io_base + _REG(ENCI_CFILT_CTRL2));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_DVI_SETTING));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\r\nwritel_relaxed(mode->hso_begin,\r\npriv->io_base + _REG(ENCI_SYNC_HSO_BEGIN));\r\nwritel_relaxed(mode->hso_end,\r\npriv->io_base + _REG(ENCI_SYNC_HSO_END));\r\nwritel_relaxed(mode->vso_even,\r\npriv->io_base + _REG(ENCI_SYNC_VSO_EVNLN));\r\nwritel_relaxed(mode->vso_odd,\r\npriv->io_base + _REG(ENCI_SYNC_VSO_ODDLN));\r\nwritel_relaxed(0x8100 + mode->macv_max_amp,\r\npriv->io_base + _REG(ENCI_MACV_MAX_AMP));\r\nwritel_relaxed(mode->video_prog_mode,\r\npriv->io_base + _REG(VENC_VIDEO_PROG_MODE));\r\nwritel_relaxed(mode->video_mode,\r\npriv->io_base + _REG(ENCI_VIDEO_MODE));\r\nwritel_relaxed(0x26, priv->io_base + _REG(ENCI_VIDEO_MODE_ADV));\r\nwritel(mode->sch_adjust, priv->io_base + _REG(ENCI_VIDEO_SCH));\r\nwritel_relaxed(0x07, priv->io_base + _REG(ENCI_SYNC_MODE));\r\nwritel_relaxed(mode->yc_delay, priv->io_base + _REG(ENCI_YC_DELAY));\r\nwritel_relaxed(mode->pixel_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_START));\r\nwritel_relaxed(mode->pixel_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_PIXEL_END));\r\nwritel_relaxed(mode->top_field_line_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_START));\r\nwritel_relaxed(mode->top_field_line_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_TOP_END));\r\nwritel_relaxed(mode->bottom_field_line_start,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_START));\r\nwritel_relaxed(mode->bottom_field_line_end,\r\npriv->io_base + _REG(ENCI_VFIFO2VD_LINE_BOT_END));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_SYNC_ROUTE));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_DBG_PX_RST));\r\nwritel_relaxed(0x4e01, priv->io_base + _REG(ENCI_VFIFO2VD_CTL));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_SETTING));\r\nwritel_relaxed(0x0061, priv->io_base + _REG(VENC_UPSAMPLE_CTRL0));\r\nwritel_relaxed(0x4061, priv->io_base + _REG(VENC_UPSAMPLE_CTRL1));\r\nwritel_relaxed(0x5061, priv->io_base + _REG(VENC_UPSAMPLE_CTRL2));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL0));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL1));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL2));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL3));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL4));\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_VDAC_DACSEL5));\r\nmeson_vpp_setup_mux(priv, MESON_VIU_VPP_MUX_ENCI);\r\nwritel_relaxed(0x2000, priv->io_base + _REG(VENC_VDAC_FIFO_CTRL));\r\nwritel_relaxed(0x11, priv->io_base + _REG(ENCI_DACSEL_0));\r\nwritel_relaxed(0x11, priv->io_base + _REG(ENCI_DACSEL_1));\r\nwritel_relaxed(1, priv->io_base + _REG(ENCI_VIDEO_EN));\r\nwritel_relaxed(mode->video_saturation,\r\npriv->io_base + _REG(ENCI_VIDEO_SAT));\r\nwritel_relaxed(mode->video_contrast,\r\npriv->io_base + _REG(ENCI_VIDEO_CONT));\r\nwritel_relaxed(mode->video_brightness,\r\npriv->io_base + _REG(ENCI_VIDEO_BRIGHT));\r\nwritel_relaxed(mode->video_hue,\r\npriv->io_base + _REG(ENCI_VIDEO_HUE));\r\nwritel_relaxed(0x1, priv->io_base + _REG(VENC_VDAC_DAC0_FILT_CTRL0));\r\nwritel_relaxed(0xfc48, priv->io_base + _REG(VENC_VDAC_DAC0_FILT_CTRL1));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_MACV_N0));\r\nwritel_relaxed(mode->analog_sync_adj,\r\npriv->io_base + _REG(ENCI_SYNC_ADJ));\r\npriv->venc.current_mode = mode->mode_tag;\r\n}\r\nunsigned int meson_venci_get_field(struct meson_drm *priv)\r\n{\r\nreturn readl_relaxed(priv->io_base + _REG(ENCI_INFO_READ)) & BIT(29);\r\n}\r\nvoid meson_venc_enable_vsync(struct meson_drm *priv)\r\n{\r\nwritel_relaxed(2, priv->io_base + _REG(VENC_INTCTRL));\r\n}\r\nvoid meson_venc_disable_vsync(struct meson_drm *priv)\r\n{\r\nwritel_relaxed(0, priv->io_base + _REG(VENC_INTCTRL));\r\n}\r\nvoid meson_venc_init(struct meson_drm *priv)\r\n{\r\nregmap_write(priv->hhi, HHI_VDAC_CNTL0, 0);\r\nregmap_write(priv->hhi, HHI_VDAC_CNTL1, 8);\r\nwritel_relaxed(0xff, priv->io_base + _REG(VENC_VDAC_SETTING));\r\nregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL0, 0);\r\nwritel_bits_relaxed(0x3, 0,\r\npriv->io_base + _REG(VPU_HDMI_SETTING));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCI_VIDEO_EN));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCP_VIDEO_EN));\r\nwritel_relaxed(0, priv->io_base + _REG(ENCL_VIDEO_EN));\r\nmeson_venc_disable_vsync(priv);\r\npriv->venc.current_mode = MESON_VENC_MODE_NONE;\r\n}

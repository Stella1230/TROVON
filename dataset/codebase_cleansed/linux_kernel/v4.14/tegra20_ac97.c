static void tegra20_ac97_codec_reset(struct snd_ac97 *ac97)\r\n{\r\nu32 readback;\r\nunsigned long timeout;\r\ngpio_set_value(workdata->reset_gpio, 0);\r\nudelay(2);\r\ngpio_set_value(workdata->reset_gpio, 1);\r\nudelay(2);\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\ndo {\r\nregmap_read(workdata->regmap, TEGRA20_AC97_STATUS1, &readback);\r\nif (readback & TEGRA20_AC97_STATUS1_CODEC1_RDY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n} while (!time_after(jiffies, timeout));\r\n}\r\nstatic void tegra20_ac97_codec_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nu32 readback;\r\nunsigned long timeout;\r\ngpio_request(workdata->sync_gpio, "codec-sync");\r\ngpio_direction_output(workdata->sync_gpio, 1);\r\nudelay(2);\r\ngpio_set_value(workdata->sync_gpio, 0);\r\nudelay(2);\r\ngpio_free(workdata->sync_gpio);\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\ndo {\r\nregmap_read(workdata->regmap, TEGRA20_AC97_STATUS1, &readback);\r\nif (readback & TEGRA20_AC97_STATUS1_CODEC1_RDY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n} while (!time_after(jiffies, timeout));\r\n}\r\nstatic unsigned short tegra20_ac97_codec_read(struct snd_ac97 *ac97_snd,\r\nunsigned short reg)\r\n{\r\nu32 readback;\r\nunsigned long timeout;\r\nregmap_write(workdata->regmap, TEGRA20_AC97_CMD,\r\n(((reg | 0x80) << TEGRA20_AC97_CMD_CMD_ADDR_SHIFT) &\r\nTEGRA20_AC97_CMD_CMD_ADDR_MASK) |\r\nTEGRA20_AC97_CMD_BUSY);\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\ndo {\r\nregmap_read(workdata->regmap, TEGRA20_AC97_STATUS1, &readback);\r\nif (readback & TEGRA20_AC97_STATUS1_STA_VALID1)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n} while (!time_after(jiffies, timeout));\r\nreturn ((readback & TEGRA20_AC97_STATUS1_STA_DATA1_MASK) >>\r\nTEGRA20_AC97_STATUS1_STA_DATA1_SHIFT);\r\n}\r\nstatic void tegra20_ac97_codec_write(struct snd_ac97 *ac97_snd,\r\nunsigned short reg, unsigned short val)\r\n{\r\nu32 readback;\r\nunsigned long timeout;\r\nregmap_write(workdata->regmap, TEGRA20_AC97_CMD,\r\n((reg << TEGRA20_AC97_CMD_CMD_ADDR_SHIFT) &\r\nTEGRA20_AC97_CMD_CMD_ADDR_MASK) |\r\n((val << TEGRA20_AC97_CMD_CMD_DATA_SHIFT) &\r\nTEGRA20_AC97_CMD_CMD_DATA_MASK) |\r\nTEGRA20_AC97_CMD_BUSY);\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\ndo {\r\nregmap_read(workdata->regmap, TEGRA20_AC97_CMD, &readback);\r\nif (!(readback & TEGRA20_AC97_CMD_BUSY))\r\nbreak;\r\nusleep_range(1000, 2000);\r\n} while (!time_after(jiffies, timeout));\r\n}\r\nstatic inline void tegra20_ac97_start_playback(struct tegra20_ac97 *ac97)\r\n{\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_FIFO1_SCR,\r\nTEGRA20_AC97_FIFO_SCR_PB_QRT_MT_EN,\r\nTEGRA20_AC97_FIFO_SCR_PB_QRT_MT_EN);\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_CTRL,\r\nTEGRA20_AC97_CTRL_PCM_DAC_EN |\r\nTEGRA20_AC97_CTRL_STM_EN,\r\nTEGRA20_AC97_CTRL_PCM_DAC_EN |\r\nTEGRA20_AC97_CTRL_STM_EN);\r\n}\r\nstatic inline void tegra20_ac97_stop_playback(struct tegra20_ac97 *ac97)\r\n{\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_FIFO1_SCR,\r\nTEGRA20_AC97_FIFO_SCR_PB_QRT_MT_EN, 0);\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_CTRL,\r\nTEGRA20_AC97_CTRL_PCM_DAC_EN, 0);\r\n}\r\nstatic inline void tegra20_ac97_start_capture(struct tegra20_ac97 *ac97)\r\n{\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_FIFO1_SCR,\r\nTEGRA20_AC97_FIFO_SCR_REC_FULL_EN,\r\nTEGRA20_AC97_FIFO_SCR_REC_FULL_EN);\r\n}\r\nstatic inline void tegra20_ac97_stop_capture(struct tegra20_ac97 *ac97)\r\n{\r\nregmap_update_bits(ac97->regmap, TEGRA20_AC97_FIFO1_SCR,\r\nTEGRA20_AC97_FIFO_SCR_REC_FULL_EN, 0);\r\n}\r\nstatic int tegra20_ac97_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct tegra20_ac97 *ac97 = snd_soc_dai_get_drvdata(dai);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ntegra20_ac97_start_playback(ac97);\r\nelse\r\ntegra20_ac97_start_capture(ac97);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ntegra20_ac97_stop_playback(ac97);\r\nelse\r\ntegra20_ac97_stop_capture(ac97);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tegra20_ac97_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct tegra20_ac97 *ac97 = snd_soc_dai_get_drvdata(dai);\r\ndai->capture_dma_data = &ac97->capture_dma_data;\r\ndai->playback_dma_data = &ac97->playback_dma_data;\r\nreturn 0;\r\n}\r\nstatic bool tegra20_ac97_wr_rd_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TEGRA20_AC97_CTRL:\r\ncase TEGRA20_AC97_CMD:\r\ncase TEGRA20_AC97_STATUS1:\r\ncase TEGRA20_AC97_FIFO1_SCR:\r\ncase TEGRA20_AC97_FIFO_TX1:\r\ncase TEGRA20_AC97_FIFO_RX1:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic bool tegra20_ac97_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TEGRA20_AC97_STATUS1:\r\ncase TEGRA20_AC97_FIFO1_SCR:\r\ncase TEGRA20_AC97_FIFO_TX1:\r\ncase TEGRA20_AC97_FIFO_RX1:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic bool tegra20_ac97_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TEGRA20_AC97_FIFO_TX1:\r\ncase TEGRA20_AC97_FIFO_RX1:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic int tegra20_ac97_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct tegra20_ac97 *ac97;\r\nstruct resource *mem;\r\nvoid __iomem *regs;\r\nint ret = 0;\r\nac97 = devm_kzalloc(&pdev->dev, sizeof(struct tegra20_ac97),\r\nGFP_KERNEL);\r\nif (!ac97) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ndev_set_drvdata(&pdev->dev, ac97);\r\nac97->clk_ac97 = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(ac97->clk_ac97)) {\r\ndev_err(&pdev->dev, "Can't retrieve ac97 clock\n");\r\nret = PTR_ERR(ac97->clk_ac97);\r\ngoto err;\r\n}\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nregs = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(regs)) {\r\nret = PTR_ERR(regs);\r\ngoto err_clk_put;\r\n}\r\nac97->regmap = devm_regmap_init_mmio(&pdev->dev, regs,\r\n&tegra20_ac97_regmap_config);\r\nif (IS_ERR(ac97->regmap)) {\r\ndev_err(&pdev->dev, "regmap init failed\n");\r\nret = PTR_ERR(ac97->regmap);\r\ngoto err_clk_put;\r\n}\r\nac97->reset_gpio = of_get_named_gpio(pdev->dev.of_node,\r\n"nvidia,codec-reset-gpio", 0);\r\nif (gpio_is_valid(ac97->reset_gpio)) {\r\nret = devm_gpio_request_one(&pdev->dev, ac97->reset_gpio,\r\nGPIOF_OUT_INIT_HIGH, "codec-reset");\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not get codec-reset GPIO\n");\r\ngoto err_clk_put;\r\n}\r\n} else {\r\ndev_err(&pdev->dev, "no codec-reset GPIO supplied\n");\r\ngoto err_clk_put;\r\n}\r\nac97->sync_gpio = of_get_named_gpio(pdev->dev.of_node,\r\n"nvidia,codec-sync-gpio", 0);\r\nif (!gpio_is_valid(ac97->sync_gpio)) {\r\ndev_err(&pdev->dev, "no codec-sync GPIO supplied\n");\r\ngoto err_clk_put;\r\n}\r\nac97->capture_dma_data.addr = mem->start + TEGRA20_AC97_FIFO_RX1;\r\nac97->capture_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES;\r\nac97->capture_dma_data.maxburst = 4;\r\nac97->playback_dma_data.addr = mem->start + TEGRA20_AC97_FIFO_TX1;\r\nac97->playback_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES;\r\nac97->playback_dma_data.maxburst = 4;\r\nret = clk_prepare_enable(ac97->clk_ac97);\r\nif (ret) {\r\ndev_err(&pdev->dev, "clk_enable failed: %d\n", ret);\r\ngoto err;\r\n}\r\nret = snd_soc_set_ac97_ops(&tegra20_ac97_ops);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to set AC'97 ops: %d\n", ret);\r\ngoto err_clk_disable_unprepare;\r\n}\r\nret = snd_soc_register_component(&pdev->dev, &tegra20_ac97_component,\r\n&tegra20_ac97_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not register DAI: %d\n", ret);\r\nret = -ENOMEM;\r\ngoto err_clk_disable_unprepare;\r\n}\r\nret = tegra_pcm_platform_register(&pdev->dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not register PCM: %d\n", ret);\r\ngoto err_unregister_component;\r\n}\r\nworkdata = ac97;\r\nreturn 0;\r\nerr_unregister_component:\r\nsnd_soc_unregister_component(&pdev->dev);\r\nerr_clk_disable_unprepare:\r\nclk_disable_unprepare(ac97->clk_ac97);\r\nerr_clk_put:\r\nerr:\r\nsnd_soc_set_ac97_ops(NULL);\r\nreturn ret;\r\n}\r\nstatic int tegra20_ac97_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct tegra20_ac97 *ac97 = dev_get_drvdata(&pdev->dev);\r\ntegra_pcm_platform_unregister(&pdev->dev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nclk_disable_unprepare(ac97->clk_ac97);\r\nsnd_soc_set_ac97_ops(NULL);\r\nreturn 0;\r\n}

static struct aspeed_lpc_ctrl *file_aspeed_lpc_ctrl(struct file *file)\r\n{\r\nreturn container_of(file->private_data, struct aspeed_lpc_ctrl,\r\nmiscdev);\r\n}\r\nstatic int aspeed_lpc_ctrl_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nstruct aspeed_lpc_ctrl *lpc_ctrl = file_aspeed_lpc_ctrl(file);\r\nunsigned long vsize = vma->vm_end - vma->vm_start;\r\npgprot_t prot = vma->vm_page_prot;\r\nif (vma->vm_pgoff + vsize > lpc_ctrl->mem_base + lpc_ctrl->mem_size)\r\nreturn -EINVAL;\r\nprot = pgprot_noncached(prot);\r\nif (remap_pfn_range(vma, vma->vm_start,\r\n(lpc_ctrl->mem_base >> PAGE_SHIFT) + vma->vm_pgoff,\r\nvsize, prot))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic long aspeed_lpc_ctrl_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long param)\r\n{\r\nstruct aspeed_lpc_ctrl *lpc_ctrl = file_aspeed_lpc_ctrl(file);\r\nvoid __user *p = (void __user *)param;\r\nstruct aspeed_lpc_ctrl_mapping map;\r\nu32 addr;\r\nu32 size;\r\nlong rc;\r\nif (copy_from_user(&map, p, sizeof(map)))\r\nreturn -EFAULT;\r\nif (map.flags != 0)\r\nreturn -EINVAL;\r\nswitch (cmd) {\r\ncase ASPEED_LPC_CTRL_IOCTL_GET_SIZE:\r\nif (map.window_type != ASPEED_LPC_CTRL_WINDOW_MEMORY)\r\nreturn -EINVAL;\r\nif (map.window_id != 0)\r\nreturn -EINVAL;\r\nmap.size = lpc_ctrl->mem_size;\r\nreturn copy_to_user(p, &map, sizeof(map)) ? -EFAULT : 0;\r\ncase ASPEED_LPC_CTRL_IOCTL_MAP:\r\nif ((map.size & 0x0000ffff) || (map.offset & 0x0000ffff))\r\nreturn -EINVAL;\r\nif (map.offset & (map.size - 1))\r\nreturn -EINVAL;\r\nif (map.window_type == ASPEED_LPC_CTRL_WINDOW_FLASH) {\r\naddr = lpc_ctrl->pnor_base;\r\nsize = lpc_ctrl->pnor_size;\r\n} else if (map.window_type == ASPEED_LPC_CTRL_WINDOW_MEMORY) {\r\naddr = lpc_ctrl->mem_base;\r\nsize = lpc_ctrl->mem_size;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nif (map.offset + map.size < map.offset ||\r\nmap.offset + map.size > size)\r\nreturn -EINVAL;\r\nif (map.size == 0 || map.size > size)\r\nreturn -EINVAL;\r\naddr += map.offset;\r\nrc = regmap_write(lpc_ctrl->regmap, HICR7,\r\n(addr | (map.addr >> 16)));\r\nif (rc)\r\nreturn rc;\r\nreturn regmap_write(lpc_ctrl->regmap, HICR8,\r\n(~(map.size - 1)) | ((map.size >> 16) - 1));\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int aspeed_lpc_ctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct aspeed_lpc_ctrl *lpc_ctrl;\r\nstruct device_node *node;\r\nstruct resource resm;\r\nstruct device *dev;\r\nint rc;\r\ndev = &pdev->dev;\r\nlpc_ctrl = devm_kzalloc(dev, sizeof(*lpc_ctrl), GFP_KERNEL);\r\nif (!lpc_ctrl)\r\nreturn -ENOMEM;\r\nnode = of_parse_phandle(dev->of_node, "flash", 0);\r\nif (!node) {\r\ndev_err(dev, "Didn't find host pnor flash node\n");\r\nreturn -ENODEV;\r\n}\r\nrc = of_address_to_resource(node, 1, &resm);\r\nof_node_put(node);\r\nif (rc) {\r\ndev_err(dev, "Couldn't address to resource for flash\n");\r\nreturn rc;\r\n}\r\nlpc_ctrl->pnor_size = resource_size(&resm);\r\nlpc_ctrl->pnor_base = resm.start;\r\ndev_set_drvdata(&pdev->dev, lpc_ctrl);\r\nnode = of_parse_phandle(dev->of_node, "memory-region", 0);\r\nif (!node) {\r\ndev_err(dev, "Didn't find reserved memory\n");\r\nreturn -EINVAL;\r\n}\r\nrc = of_address_to_resource(node, 0, &resm);\r\nof_node_put(node);\r\nif (rc) {\r\ndev_err(dev, "Couldn't address to resource for reserved memory\n");\r\nreturn -ENOMEM;\r\n}\r\nlpc_ctrl->mem_size = resource_size(&resm);\r\nlpc_ctrl->mem_base = resm.start;\r\nlpc_ctrl->regmap = syscon_node_to_regmap(\r\npdev->dev.parent->of_node);\r\nif (IS_ERR(lpc_ctrl->regmap)) {\r\ndev_err(dev, "Couldn't get regmap\n");\r\nreturn -ENODEV;\r\n}\r\nlpc_ctrl->miscdev.minor = MISC_DYNAMIC_MINOR;\r\nlpc_ctrl->miscdev.name = DEVICE_NAME;\r\nlpc_ctrl->miscdev.fops = &aspeed_lpc_ctrl_fops;\r\nlpc_ctrl->miscdev.parent = dev;\r\nrc = misc_register(&lpc_ctrl->miscdev);\r\nif (rc)\r\ndev_err(dev, "Unable to register device\n");\r\nelse\r\ndev_info(dev, "Loaded at %pr\n", &resm);\r\nreturn rc;\r\n}\r\nstatic int aspeed_lpc_ctrl_remove(struct platform_device *pdev)\r\n{\r\nstruct aspeed_lpc_ctrl *lpc_ctrl = dev_get_drvdata(&pdev->dev);\r\nmisc_deregister(&lpc_ctrl->miscdev);\r\nreturn 0;\r\n}

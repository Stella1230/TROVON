static int get_right_pair_idx(struct mdp5_kms *mdp5_kms, int lm)\r\n{\r\nint i;\r\nint pair_lm;\r\npair_lm = lm_right_pair[lm];\r\nif (pair_lm < 0)\r\nreturn -EINVAL;\r\nfor (i = 0; i < mdp5_kms->num_hwmixers; i++) {\r\nstruct mdp5_hw_mixer *mixer = mdp5_kms->hwmixers[i];\r\nif (mixer->lm == pair_lm)\r\nreturn mixer->idx;\r\n}\r\nreturn -1;\r\n}\r\nint mdp5_mixer_assign(struct drm_atomic_state *s, struct drm_crtc *crtc,\r\nuint32_t caps, struct mdp5_hw_mixer **mixer,\r\nstruct mdp5_hw_mixer **r_mixer)\r\n{\r\nstruct msm_drm_private *priv = s->dev->dev_private;\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(priv->kms));\r\nstruct mdp5_state *state = mdp5_get_state(s);\r\nstruct mdp5_hw_mixer_state *new_state;\r\nint i;\r\nif (IS_ERR(state))\r\nreturn PTR_ERR(state);\r\nnew_state = &state->hwmixer;\r\nfor (i = 0; i < mdp5_kms->num_hwmixers; i++) {\r\nstruct mdp5_hw_mixer *cur = mdp5_kms->hwmixers[i];\r\nif (new_state->hwmixer_to_crtc[cur->idx] &&\r\nnew_state->hwmixer_to_crtc[cur->idx] != crtc)\r\ncontinue;\r\nif (caps & ~cur->caps)\r\ncontinue;\r\nif (r_mixer) {\r\nint pair_idx;\r\npair_idx = get_right_pair_idx(mdp5_kms, cur->lm);\r\nif (pair_idx < 0)\r\nreturn -EINVAL;\r\nif (new_state->hwmixer_to_crtc[pair_idx])\r\ncontinue;\r\n*r_mixer = mdp5_kms->hwmixers[pair_idx];\r\n}\r\nif (!(*mixer) || cur->caps & MDP_LM_CAP_PAIR)\r\n*mixer = cur;\r\n}\r\nif (!(*mixer))\r\nreturn -ENOMEM;\r\nif (r_mixer && !(*r_mixer))\r\nreturn -ENOMEM;\r\nDBG("assigning Layer Mixer %d to crtc %s", (*mixer)->lm, crtc->name);\r\nnew_state->hwmixer_to_crtc[(*mixer)->idx] = crtc;\r\nif (r_mixer) {\r\nDBG("assigning Right Layer Mixer %d to crtc %s", (*r_mixer)->lm,\r\ncrtc->name);\r\nnew_state->hwmixer_to_crtc[(*r_mixer)->idx] = crtc;\r\n}\r\nreturn 0;\r\n}\r\nvoid mdp5_mixer_release(struct drm_atomic_state *s, struct mdp5_hw_mixer *mixer)\r\n{\r\nstruct mdp5_state *state = mdp5_get_state(s);\r\nstruct mdp5_hw_mixer_state *new_state = &state->hwmixer;\r\nif (!mixer)\r\nreturn;\r\nif (WARN_ON(!new_state->hwmixer_to_crtc[mixer->idx]))\r\nreturn;\r\nDBG("%s: release from crtc %s", mixer->name,\r\nnew_state->hwmixer_to_crtc[mixer->idx]->name);\r\nnew_state->hwmixer_to_crtc[mixer->idx] = NULL;\r\n}\r\nvoid mdp5_mixer_destroy(struct mdp5_hw_mixer *mixer)\r\n{\r\nkfree(mixer);\r\n}\r\nstruct mdp5_hw_mixer *mdp5_mixer_init(const struct mdp5_lm_instance *lm)\r\n{\r\nstruct mdp5_hw_mixer *mixer;\r\nmixer = kzalloc(sizeof(*mixer), GFP_KERNEL);\r\nif (!mixer)\r\nreturn ERR_PTR(-ENOMEM);\r\nmixer->name = mixer_names[lm->id];\r\nmixer->lm = lm->id;\r\nmixer->caps = lm->caps;\r\nmixer->pp = lm->pp;\r\nmixer->dspp = lm->dspp;\r\nmixer->flush_mask = mdp_ctl_flush_mask_lm(lm->id);\r\nreturn mixer;\r\n}

static inline unsigned char\r\nFlipBits(unsigned char c, int keylen)\r\n{\r\nunsigned char b = c;\r\nunsigned char bit = 128;\r\nint i;\r\nint j;\r\nint hunks = (8 / keylen);\r\nc = 0;\r\nfor (i = 0; i < hunks; i++) {\r\nfor (j = 0; j < keylen; j++) {\r\nif (b & (bit >> j))\r\nc |= bit >> (keylen - j - 1);\r\n}\r\nbit >>= keylen;\r\n}\r\nreturn c;\r\n}\r\nstatic isdn_v110_stream *\r\nisdn_v110_open(unsigned char key, int hdrlen, int maxsize)\r\n{\r\nint i;\r\nisdn_v110_stream *v;\r\nif ((v = kzalloc(sizeof(isdn_v110_stream), GFP_ATOMIC)) == NULL)\r\nreturn NULL;\r\nv->key = key;\r\nv->nbits = 0;\r\nfor (i = 0; key & (1 << i); i++)\r\nv->nbits++;\r\nv->nbytes = 8 / v->nbits;\r\nv->decodelen = 0;\r\nswitch (key) {\r\ncase V110_38400:\r\nv->OnlineFrame = V110_OnMatrix_38400;\r\nv->OfflineFrame = V110_OffMatrix_38400;\r\nbreak;\r\ncase V110_19200:\r\nv->OnlineFrame = V110_OnMatrix_19200;\r\nv->OfflineFrame = V110_OffMatrix_19200;\r\nbreak;\r\ndefault:\r\nv->OnlineFrame = V110_OnMatrix_9600;\r\nv->OfflineFrame = V110_OffMatrix_9600;\r\nbreak;\r\n}\r\nv->framelen = v->nbytes * 10;\r\nv->SyncInit = 5;\r\nv->introducer = 0;\r\nv->dbit = 1;\r\nv->b = 0;\r\nv->skbres = hdrlen;\r\nv->maxsize = maxsize - hdrlen;\r\nif ((v->encodebuf = kmalloc(maxsize, GFP_ATOMIC)) == NULL) {\r\nkfree(v);\r\nreturn NULL;\r\n}\r\nreturn v;\r\n}\r\nvoid\r\nisdn_v110_close(isdn_v110_stream *v)\r\n{\r\nif (v == NULL)\r\nreturn;\r\n#ifdef ISDN_V110_DEBUG\r\nprintk(KERN_DEBUG "v110 close\n");\r\n#endif\r\nkfree(v->encodebuf);\r\nkfree(v);\r\n}\r\nstatic int\r\nValidHeaderBytes(isdn_v110_stream *v)\r\n{\r\nint i;\r\nfor (i = 0; (i < v->decodelen) && (i < v->nbytes); i++)\r\nif ((v->decodebuf[i] & v->key) != 0)\r\nbreak;\r\nreturn i;\r\n}\r\nstatic void\r\nSyncHeader(isdn_v110_stream *v)\r\n{\r\nunsigned char *rbuf = v->decodebuf;\r\nint len = v->decodelen;\r\nif (len == 0)\r\nreturn;\r\nfor (rbuf++, len--; len > 0; len--, rbuf++)\r\nif ((*rbuf & v->key) == 0)\r\nbreak;\r\nif (len)\r\nmemcpy(v->decodebuf, rbuf, len);\r\nv->decodelen = len;\r\n#ifdef ISDN_V110_DEBUG\r\nprintk(KERN_DEBUG "isdn_v110: Header resync\n");\r\n#endif\r\n}\r\nstatic int\r\nDecodeMatrix(isdn_v110_stream *v, unsigned char *m, int len, unsigned char *buf)\r\n{\r\nint line = 0;\r\nint buflen = 0;\r\nint mbit = 64;\r\nint introducer = v->introducer;\r\nint dbit = v->dbit;\r\nunsigned char b = v->b;\r\nwhile (line < len) {\r\nif ((line % 10) == 0) {\r\nif (m[line] != 0x00) {\r\n#ifdef ISDN_V110_DEBUG\r\nprintk(KERN_DEBUG "isdn_v110: DecodeMatrix, V110 Bad Header\n");\r\n#endif\r\n}\r\nline++;\r\ncontinue;\r\n} else if ((line % 10) == 5) {\r\nif ((m[line] & 0x70) != 0x30) {\r\n#ifdef ISDN_V110_DEBUG\r\nprintk(KERN_DEBUG "isdn_v110: DecodeMatrix, V110 Bad 5th line\n");\r\n#endif\r\n}\r\nline++;\r\ncontinue;\r\n} else if (!introducer) {\r\nintroducer = (m[line] & mbit) ? 0 : 1;\r\nnext_byte:\r\nif (mbit > 2) {\r\nmbit >>= 1;\r\ncontinue;\r\n}\r\nmbit = 64;\r\nline++;\r\ncontinue;\r\n} else {\r\nif (m[line] & mbit)\r\nb |= dbit;\r\nelse\r\nb &= dbit - 1;\r\nif (dbit < 128)\r\ndbit <<= 1;\r\nelse {\r\nbuf[buflen++] = b;\r\nintroducer = b = 0;\r\ndbit = 1;\r\n}\r\ngoto next_byte;\r\n}\r\n}\r\nv->introducer = introducer;\r\nv->dbit = dbit;\r\nv->b = b;\r\nreturn buflen;\r\n}\r\nstruct sk_buff *\r\nisdn_v110_decode(isdn_v110_stream *v, struct sk_buff *skb)\r\n{\r\nint i;\r\nint j;\r\nint len;\r\nunsigned char *v110_buf;\r\nunsigned char *rbuf;\r\nif (!skb) {\r\nprintk(KERN_WARNING "isdn_v110_decode called with NULL skb!\n");\r\nreturn NULL;\r\n}\r\nrbuf = skb->data;\r\nlen = skb->len;\r\nif (v == NULL) {\r\nprintk(KERN_WARNING "isdn_v110_decode called with NULL stream!\n");\r\ndev_kfree_skb(skb);\r\nreturn NULL;\r\n}\r\nif (v->decodelen == 0)\r\nfor (; len > 0; len--, rbuf++)\r\nif ((*rbuf & v->key) == 0)\r\nbreak;\r\nif (len == 0) {\r\ndev_kfree_skb(skb);\r\nreturn NULL;\r\n}\r\nmemcpy(&(v->decodebuf[v->decodelen]), rbuf, len);\r\nv->decodelen += len;\r\nReSync:\r\nif (v->decodelen < v->nbytes) {\r\ndev_kfree_skb(skb);\r\nreturn NULL;\r\n}\r\nif (ValidHeaderBytes(v) != v->nbytes) {\r\nSyncHeader(v);\r\ngoto ReSync;\r\n}\r\nlen = (v->decodelen - (v->decodelen % (10 * v->nbytes))) / v->nbytes;\r\nif ((v110_buf = kmalloc(len, GFP_ATOMIC)) == NULL) {\r\nprintk(KERN_WARNING "isdn_v110_decode: Couldn't allocate v110_buf\n");\r\ndev_kfree_skb(skb);\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < len; i++) {\r\nv110_buf[i] = 0;\r\nfor (j = 0; j < v->nbytes; j++)\r\nv110_buf[i] |= (v->decodebuf[(i * v->nbytes) + j] & v->key) << (8 - ((j + 1) * v->nbits));\r\nv110_buf[i] = FlipBits(v110_buf[i], v->nbits);\r\n}\r\nv->decodelen = (v->decodelen % (10 * v->nbytes));\r\nmemcpy(v->decodebuf, &(v->decodebuf[len * v->nbytes]), v->decodelen);\r\nskb_trim(skb, DecodeMatrix(v, v110_buf, len, skb->data));\r\nkfree(v110_buf);\r\nif (skb->len)\r\nreturn skb;\r\nelse {\r\nkfree_skb(skb);\r\nreturn NULL;\r\n}\r\n}\r\nstatic int\r\nEncodeMatrix(unsigned char *buf, int len, unsigned char *m, int mlen)\r\n{\r\nint line = 0;\r\nint i = 0;\r\nint mbit = 128;\r\nint dbit = 1;\r\nint introducer = 3;\r\nint ibit[] = {0, 1, 1};\r\nwhile ((i < len) && (line < mlen)) {\r\nswitch (line % 10) {\r\ncase 0:\r\nm[line++] = 0x00;\r\nmbit = 128;\r\nbreak;\r\ncase 5:\r\nm[line++] = 0xbf;\r\nmbit = 128;\r\nbreak;\r\n}\r\nif (line >= mlen) {\r\nprintk(KERN_WARNING "isdn_v110 (EncodeMatrix): buffer full!\n");\r\nreturn line;\r\n}\r\nnext_bit:\r\nswitch (mbit) {\r\ncase 1:\r\nline++;\r\nif (line >= mlen) {\r\nprintk(KERN_WARNING "isdn_v110 (EncodeMatrix): buffer full!\n");\r\nreturn line;\r\n}\r\ncase 128:\r\nm[line] = 128;\r\nmbit = 64;\r\ncontinue;\r\n}\r\nif (introducer) {\r\nintroducer--;\r\nm[line] |= ibit[introducer] ? mbit : 0;\r\nmbit >>= 1;\r\ngoto next_bit;\r\n}\r\nm[line] |= (buf[i] & dbit) ? mbit : 0;\r\nif (dbit == 128) {\r\ndbit = 1;\r\ni++;\r\nif (i < len)\r\nintroducer = 3;\r\nelse {\r\nm[line] |= (mbit - 1) & 0xfe;\r\nbreak;\r\n}\r\n} else\r\ndbit <<= 1;\r\nmbit >>= 1;\r\ngoto next_bit;\r\n}\r\nif ((line) && ((line + 10) < mlen))\r\nswitch (++line % 10) {\r\ncase 1:\r\nm[line++] = 0xfe;\r\ncase 2:\r\nm[line++] = 0xfe;\r\ncase 3:\r\nm[line++] = 0xfe;\r\ncase 4:\r\nm[line++] = 0xfe;\r\ncase 5:\r\nm[line++] = 0xbf;\r\ncase 6:\r\nm[line++] = 0xfe;\r\ncase 7:\r\nm[line++] = 0xfe;\r\ncase 8:\r\nm[line++] = 0xfe;\r\ncase 9:\r\nm[line++] = 0xfe;\r\n}\r\nreturn line;\r\n}\r\nstatic struct sk_buff *\r\nisdn_v110_sync(isdn_v110_stream *v)\r\n{\r\nstruct sk_buff *skb;\r\nif (v == NULL) {\r\nprintk(KERN_WARNING "isdn_v110_sync called with NULL stream!\n");\r\nreturn NULL;\r\n}\r\nif ((skb = dev_alloc_skb(v->framelen + v->skbres))) {\r\nskb_reserve(skb, v->skbres);\r\nskb_put_data(skb, v->OfflineFrame, v->framelen);\r\n}\r\nreturn skb;\r\n}\r\nstatic struct sk_buff *\r\nisdn_v110_idle(isdn_v110_stream *v)\r\n{\r\nstruct sk_buff *skb;\r\nif (v == NULL) {\r\nprintk(KERN_WARNING "isdn_v110_sync called with NULL stream!\n");\r\nreturn NULL;\r\n}\r\nif ((skb = dev_alloc_skb(v->framelen + v->skbres))) {\r\nskb_reserve(skb, v->skbres);\r\nskb_put_data(skb, v->OnlineFrame, v->framelen);\r\n}\r\nreturn skb;\r\n}\r\nstruct sk_buff *\r\nisdn_v110_encode(isdn_v110_stream *v, struct sk_buff *skb)\r\n{\r\nint i;\r\nint j;\r\nint rlen;\r\nint mlen;\r\nint olen;\r\nint size;\r\nint sval1;\r\nint sval2;\r\nint nframes;\r\nunsigned char *v110buf;\r\nunsigned char *rbuf;\r\nstruct sk_buff *nskb;\r\nif (v == NULL) {\r\nprintk(KERN_WARNING "isdn_v110_encode called with NULL stream!\n");\r\nreturn NULL;\r\n}\r\nif (!skb) {\r\nprintk(KERN_WARNING "isdn_v110_encode called with NULL skb!\n");\r\nreturn NULL;\r\n}\r\nrlen = skb->len;\r\nnframes = (rlen + 3) / 4;\r\nv110buf = v->encodebuf;\r\nif ((nframes * 40) > v->maxsize) {\r\nsize = v->maxsize;\r\nrlen = v->maxsize / 40;\r\n} else\r\nsize = nframes * 40;\r\nif (!(nskb = dev_alloc_skb(size + v->skbres + sizeof(int)))) {\r\nprintk(KERN_WARNING "isdn_v110_encode: Couldn't alloc skb\n");\r\nreturn NULL;\r\n}\r\nskb_reserve(nskb, v->skbres + sizeof(int));\r\nif (skb->len == 0) {\r\nskb_put_data(nskb, v->OnlineFrame, v->framelen);\r\n*((int *)skb_push(nskb, sizeof(int))) = 0;\r\nreturn nskb;\r\n}\r\nmlen = EncodeMatrix(skb->data, rlen, v110buf, size);\r\nrbuf = skb_put(nskb, size);\r\nolen = 0;\r\nsval1 = 8 - v->nbits;\r\nsval2 = v->key << sval1;\r\nfor (i = 0; i < mlen; i++) {\r\nv110buf[i] = FlipBits(v110buf[i], v->nbits);\r\nfor (j = 0; j < v->nbytes; j++) {\r\nif (size--)\r\n*rbuf++ = ~v->key | (((v110buf[i] << (j * v->nbits)) & sval2) >> sval1);\r\nelse {\r\nprintk(KERN_WARNING "isdn_v110_encode: buffers full!\n");\r\ngoto buffer_full;\r\n}\r\nolen++;\r\n}\r\n}\r\nbuffer_full:\r\nskb_trim(nskb, olen);\r\n*((int *)skb_push(nskb, sizeof(int))) = rlen;\r\nreturn nskb;\r\n}\r\nint\r\nisdn_v110_stat_callback(int idx, isdn_ctrl *c)\r\n{\r\nisdn_v110_stream *v = NULL;\r\nint i;\r\nint ret = 0;\r\nif (idx < 0)\r\nreturn 0;\r\nswitch (c->command) {\r\ncase ISDN_STAT_BSENT:\r\nif (!(v = dev->v110[idx]))\r\nreturn 0;\r\natomic_inc(&dev->v110use[idx]);\r\nfor (i = 0; i * v->framelen < c->parm.length; i++) {\r\nif (v->skbidle > 0) {\r\nv->skbidle--;\r\nret = 1;\r\n} else {\r\nif (v->skbuser > 0)\r\nv->skbuser--;\r\nret = 0;\r\n}\r\n}\r\nfor (i = v->skbuser + v->skbidle; i < 2; i++) {\r\nstruct sk_buff *skb;\r\nif (v->SyncInit > 0)\r\nskb = isdn_v110_sync(v);\r\nelse\r\nskb = isdn_v110_idle(v);\r\nif (skb) {\r\nif (dev->drv[c->driver]->interface->writebuf_skb(c->driver, c->arg, 1, skb) <= 0) {\r\ndev_kfree_skb(skb);\r\nbreak;\r\n} else {\r\nif (v->SyncInit)\r\nv->SyncInit--;\r\nv->skbidle++;\r\n}\r\n} else\r\nbreak;\r\n}\r\natomic_dec(&dev->v110use[idx]);\r\nreturn ret;\r\ncase ISDN_STAT_DHUP:\r\ncase ISDN_STAT_BHUP:\r\nwhile (1) {\r\natomic_inc(&dev->v110use[idx]);\r\nif (atomic_dec_and_test(&dev->v110use[idx])) {\r\nisdn_v110_close(dev->v110[idx]);\r\ndev->v110[idx] = NULL;\r\nbreak;\r\n}\r\nmdelay(1);\r\n}\r\nbreak;\r\ncase ISDN_STAT_BCONN:\r\nif (dev->v110emu[idx] && (dev->v110[idx] == NULL)) {\r\nint hdrlen = dev->drv[c->driver]->interface->hl_hdrlen;\r\nint maxsize = dev->drv[c->driver]->interface->maxbufsize;\r\natomic_inc(&dev->v110use[idx]);\r\nswitch (dev->v110emu[idx]) {\r\ncase ISDN_PROTO_L2_V11096:\r\ndev->v110[idx] = isdn_v110_open(V110_9600, hdrlen, maxsize);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11019:\r\ndev->v110[idx] = isdn_v110_open(V110_19200, hdrlen, maxsize);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11038:\r\ndev->v110[idx] = isdn_v110_open(V110_38400, hdrlen, maxsize);\r\nbreak;\r\ndefault:;\r\n}\r\nif ((v = dev->v110[idx])) {\r\nwhile (v->SyncInit) {\r\nstruct sk_buff *skb = isdn_v110_sync(v);\r\nif (dev->drv[c->driver]->interface->writebuf_skb(c->driver, c->arg, 1, skb) <= 0) {\r\ndev_kfree_skb(skb);\r\nbreak;\r\n}\r\nv->SyncInit--;\r\nv->skbidle++;\r\n}\r\n} else\r\nprintk(KERN_WARNING "isdn_v110: Couldn't open stream for chan %d\n", idx);\r\natomic_dec(&dev->v110use[idx]);\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}

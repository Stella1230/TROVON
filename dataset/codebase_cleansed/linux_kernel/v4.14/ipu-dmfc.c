int ipu_dmfc_enable_channel(struct dmfc_channel *dmfc)\r\n{\r\nstruct ipu_dmfc_priv *priv = dmfc->priv;\r\nmutex_lock(&priv->mutex);\r\nif (!priv->use_count)\r\nipu_module_enable(priv->ipu, IPU_CONF_DMFC_EN);\r\npriv->use_count++;\r\nmutex_unlock(&priv->mutex);\r\nreturn 0;\r\n}\r\nvoid ipu_dmfc_disable_channel(struct dmfc_channel *dmfc)\r\n{\r\nstruct ipu_dmfc_priv *priv = dmfc->priv;\r\nmutex_lock(&priv->mutex);\r\npriv->use_count--;\r\nif (!priv->use_count)\r\nipu_module_disable(priv->ipu, IPU_CONF_DMFC_EN);\r\nif (priv->use_count < 0)\r\npriv->use_count = 0;\r\nmutex_unlock(&priv->mutex);\r\n}\r\nvoid ipu_dmfc_config_wait4eot(struct dmfc_channel *dmfc, int width)\r\n{\r\nstruct ipu_dmfc_priv *priv = dmfc->priv;\r\nu32 dmfc_gen1;\r\nmutex_lock(&priv->mutex);\r\ndmfc_gen1 = readl(priv->base + DMFC_GENERAL1);\r\nif ((dmfc->slots * 64 * 4) / width > dmfc->data->max_fifo_lines)\r\ndmfc_gen1 |= 1 << dmfc->data->eot_shift;\r\nelse\r\ndmfc_gen1 &= ~(1 << dmfc->data->eot_shift);\r\nwritel(dmfc_gen1, priv->base + DMFC_GENERAL1);\r\nmutex_unlock(&priv->mutex);\r\n}\r\nstruct dmfc_channel *ipu_dmfc_get(struct ipu_soc *ipu, int ipu_channel)\r\n{\r\nstruct ipu_dmfc_priv *priv = ipu->dmfc_priv;\r\nint i;\r\nfor (i = 0; i < DMFC_NUM_CHANNELS; i++)\r\nif (dmfcdata[i].ipu_channel == ipu_channel)\r\nreturn &priv->channels[i];\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nvoid ipu_dmfc_put(struct dmfc_channel *dmfc)\r\n{\r\n}\r\nint ipu_dmfc_init(struct ipu_soc *ipu, struct device *dev, unsigned long base,\r\nstruct clk *ipu_clk)\r\n{\r\nstruct ipu_dmfc_priv *priv;\r\nint i;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->base = devm_ioremap(dev, base, PAGE_SIZE);\r\nif (!priv->base)\r\nreturn -ENOMEM;\r\npriv->dev = dev;\r\npriv->ipu = ipu;\r\nmutex_init(&priv->mutex);\r\nipu->dmfc_priv = priv;\r\nfor (i = 0; i < DMFC_NUM_CHANNELS; i++) {\r\npriv->channels[i].priv = priv;\r\npriv->channels[i].ipu = ipu;\r\npriv->channels[i].data = &dmfcdata[i];\r\nif (dmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_BG_SYNC ||\r\ndmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_FG_SYNC ||\r\ndmfcdata[i].ipu_channel == IPUV3_CHANNEL_MEM_DC_SYNC)\r\npriv->channels[i].slots = 2;\r\n}\r\nwritel(0x00000050, priv->base + DMFC_WR_CHAN);\r\nwritel(0x00005654, priv->base + DMFC_DP_CHAN);\r\nwritel(0x202020f6, priv->base + DMFC_WR_CHAN_DEF);\r\nwritel(0x2020f6f6, priv->base + DMFC_DP_CHAN_DEF);\r\nwritel(0x00000003, priv->base + DMFC_GENERAL1);\r\nreturn 0;\r\n}\r\nvoid ipu_dmfc_exit(struct ipu_soc *ipu)\r\n{\r\n}

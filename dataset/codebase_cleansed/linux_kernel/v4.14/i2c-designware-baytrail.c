static u32 get_sem_addr(struct dw_i2c_dev *dev)\r\n{\r\nif (dev->flags & MODEL_CHERRYTRAIL)\r\nreturn PUNIT_SEMAPHORE_CHT;\r\nelse\r\nreturn PUNIT_SEMAPHORE;\r\n}\r\nstatic int get_sem(struct dw_i2c_dev *dev, u32 *sem)\r\n{\r\nu32 addr = get_sem_addr(dev);\r\nu32 data;\r\nint ret;\r\nret = iosf_mbi_read(BT_MBI_UNIT_PMC, MBI_REG_READ, addr, &data);\r\nif (ret) {\r\ndev_err(dev->dev, "iosf failed to read punit semaphore\n");\r\nreturn ret;\r\n}\r\n*sem = data & PUNIT_SEMAPHORE_BIT;\r\nreturn 0;\r\n}\r\nstatic void reset_semaphore(struct dw_i2c_dev *dev)\r\n{\r\nif (iosf_mbi_modify(BT_MBI_UNIT_PMC, MBI_REG_READ, get_sem_addr(dev),\r\n0, PUNIT_SEMAPHORE_BIT))\r\ndev_err(dev->dev, "iosf failed to reset punit semaphore during write\n");\r\npm_qos_update_request(&dev->pm_qos, PM_QOS_DEFAULT_VALUE);\r\niosf_mbi_call_pmic_bus_access_notifier_chain(MBI_PMIC_BUS_ACCESS_END,\r\nNULL);\r\niosf_mbi_punit_release();\r\n}\r\nstatic int baytrail_i2c_acquire(struct dw_i2c_dev *dev)\r\n{\r\nu32 addr;\r\nu32 sem = PUNIT_SEMAPHORE_ACQUIRE;\r\nint ret;\r\nunsigned long start, end;\r\nmight_sleep();\r\nif (!dev || !dev->dev)\r\nreturn -ENODEV;\r\nif (!dev->release_lock)\r\nreturn 0;\r\niosf_mbi_punit_acquire();\r\niosf_mbi_call_pmic_bus_access_notifier_chain(MBI_PMIC_BUS_ACCESS_BEGIN,\r\nNULL);\r\npm_qos_update_request(&dev->pm_qos, 0);\r\naddr = get_sem_addr(dev);\r\nret = iosf_mbi_write(BT_MBI_UNIT_PMC, MBI_REG_WRITE, addr, sem);\r\nif (ret) {\r\ndev_err(dev->dev, "iosf punit semaphore request failed\n");\r\ngoto out;\r\n}\r\nstart = jiffies;\r\nend = start + msecs_to_jiffies(SEMAPHORE_TIMEOUT);\r\ndo {\r\nret = get_sem(dev, &sem);\r\nif (!ret && sem) {\r\nacquired = jiffies;\r\ndev_dbg(dev->dev, "punit semaphore acquired after %ums\n",\r\njiffies_to_msecs(jiffies - start));\r\nreturn 0;\r\n}\r\nusleep_range(1000, 2000);\r\n} while (time_before(jiffies, end));\r\ndev_err(dev->dev, "punit semaphore timed out, resetting\n");\r\nout:\r\nreset_semaphore(dev);\r\nret = iosf_mbi_read(BT_MBI_UNIT_PMC, MBI_REG_READ, addr, &sem);\r\nif (ret)\r\ndev_err(dev->dev, "iosf failed to read punit semaphore\n");\r\nelse\r\ndev_err(dev->dev, "PUNIT SEM: %d\n", sem);\r\nWARN_ON(1);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void baytrail_i2c_release(struct dw_i2c_dev *dev)\r\n{\r\nif (!dev || !dev->dev)\r\nreturn;\r\nif (!dev->acquire_lock)\r\nreturn;\r\nreset_semaphore(dev);\r\ndev_dbg(dev->dev, "punit semaphore held for %ums\n",\r\njiffies_to_msecs(jiffies - acquired));\r\n}\r\nint i2c_dw_probe_lock_support(struct dw_i2c_dev *dev)\r\n{\r\nacpi_status status;\r\nunsigned long long shared_host = 0;\r\nacpi_handle handle;\r\nif (!dev || !dev->dev)\r\nreturn 0;\r\nhandle = ACPI_HANDLE(dev->dev);\r\nif (!handle)\r\nreturn 0;\r\nstatus = acpi_evaluate_integer(handle, "_SEM", NULL, &shared_host);\r\nif (ACPI_FAILURE(status))\r\nreturn 0;\r\nif (!shared_host)\r\nreturn 0;\r\nif (!iosf_mbi_available())\r\nreturn -EPROBE_DEFER;\r\ndev_info(dev->dev, "I2C bus managed by PUNIT\n");\r\ndev->acquire_lock = baytrail_i2c_acquire;\r\ndev->release_lock = baytrail_i2c_release;\r\ndev->pm_disabled = true;\r\npm_qos_add_request(&dev->pm_qos, PM_QOS_CPU_DMA_LATENCY,\r\nPM_QOS_DEFAULT_VALUE);\r\nreturn 0;\r\n}\r\nvoid i2c_dw_remove_lock_support(struct dw_i2c_dev *dev)\r\n{\r\nif (dev->acquire_lock)\r\npm_qos_remove_request(&dev->pm_qos);\r\n}

static irqreturn_t powerbutton_irq(int irq, void *_button)\r\n{\r\nstruct cpcap_power_button *button = _button;\r\nint val;\r\nval = cpcap_sense_virq(button->regmap, irq);\r\nif (val < 0) {\r\ndev_err(button->dev, "irq read failed: %d", val);\r\nreturn IRQ_HANDLED;\r\n}\r\npm_wakeup_event(button->dev, 0);\r\ninput_report_key(button->idev, KEY_POWER, val);\r\ninput_sync(button->idev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int cpcap_power_button_probe(struct platform_device *pdev)\r\n{\r\nstruct cpcap_power_button *button;\r\nint irq = platform_get_irq(pdev, 0);\r\nint err;\r\nbutton = devm_kmalloc(&pdev->dev, sizeof(*button), GFP_KERNEL);\r\nif (!button)\r\nreturn -ENOMEM;\r\nbutton->idev = devm_input_allocate_device(&pdev->dev);\r\nif (!button->idev)\r\nreturn -ENOMEM;\r\nbutton->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!button->regmap)\r\nreturn -ENODEV;\r\nbutton->dev = &pdev->dev;\r\nbutton->idev->name = "cpcap-pwrbutton";\r\nbutton->idev->phys = "cpcap-pwrbutton/input0";\r\nbutton->idev->dev.parent = button->dev;\r\ninput_set_capability(button->idev, EV_KEY, KEY_POWER);\r\nerr = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\npowerbutton_irq, IRQF_ONESHOT, "cpcap_pwrbutton", button);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "IRQ request failed: %d\n", err);\r\nreturn err;\r\n}\r\nerr = input_register_device(button->idev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Input register failed: %d\n", err);\r\nreturn err;\r\n}\r\ndevice_init_wakeup(&pdev->dev, true);\r\nreturn 0;\r\n}

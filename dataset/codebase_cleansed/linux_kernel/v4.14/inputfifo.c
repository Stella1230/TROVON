static unsigned inputfifo_wrap_marker(\r\nunsigned marker)\r\n{\r\nreturn marker |\r\n(inputfifo_curr_ch_id << HIVE_STR_TO_MIPI_CH_ID_LSB) |\r\n(inputfifo_curr_fmt_type << _HIVE_STR_TO_MIPI_FMT_TYPE_LSB);\r\n}\r\nSTORAGE_CLASS_INLINE void\r\n_sh_css_fifo_snd(unsigned token)\r\n{\r\nwhile (!can_event_send_token(STR2MIPI_EVENT_ID))\r\nhrt_sleep();\r\nevent_send_token(STR2MIPI_EVENT_ID, token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_data_a(\r\nunsigned int data)\r\n{\r\nunsigned int token = (1 << HIVE_STR_TO_MIPI_VALID_A_BIT) |\r\n(data << HIVE_STR_TO_MIPI_DATA_A_LSB);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_data_b(\r\nunsigned int data)\r\n{\r\nunsigned int token = (1 << HIVE_STR_TO_MIPI_VALID_B_BIT) |\r\n(data << _HIVE_STR_TO_MIPI_DATA_B_LSB);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_data(\r\nunsigned int a,\r\nunsigned int b)\r\n{\r\nunsigned int token = ((1 << HIVE_STR_TO_MIPI_VALID_A_BIT) |\r\n(1 << HIVE_STR_TO_MIPI_VALID_B_BIT) |\r\n(a << HIVE_STR_TO_MIPI_DATA_A_LSB) |\r\n(b << _HIVE_STR_TO_MIPI_DATA_B_LSB));\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_sol(void)\r\n{\r\nhrt_data token = inputfifo_wrap_marker(\r\n1 << HIVE_STR_TO_MIPI_SOL_BIT);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_eol(void)\r\n{\r\nhrt_data token = inputfifo_wrap_marker(\r\n1 << HIVE_STR_TO_MIPI_EOL_BIT);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_sof(void)\r\n{\r\nhrt_data token = inputfifo_wrap_marker(\r\n1 << HIVE_STR_TO_MIPI_SOF_BIT);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_eof(void)\r\n{\r\nhrt_data token = inputfifo_wrap_marker(\r\n1 << HIVE_STR_TO_MIPI_EOF_BIT);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_ch_id(\r\nunsigned int ch_id)\r\n{\r\nhrt_data token;\r\ninputfifo_curr_ch_id = ch_id & _HIVE_ISP_CH_ID_MASK;\r\ntoken = inputfifo_wrap_marker(0);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_fmt_type(\r\nunsigned int fmt_type)\r\n{\r\nhrt_data token;\r\ninputfifo_curr_fmt_type = fmt_type & _HIVE_ISP_FMT_TYPE_MASK;\r\ntoken = inputfifo_wrap_marker(0);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_ch_id_and_fmt_type(\r\nunsigned int ch_id,\r\nunsigned int fmt_type)\r\n{\r\nhrt_data token;\r\ninputfifo_curr_ch_id = ch_id & _HIVE_ISP_CH_ID_MASK;\r\ninputfifo_curr_fmt_type = fmt_type & _HIVE_ISP_FMT_TYPE_MASK;\r\ntoken = inputfifo_wrap_marker(0);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_send_empty_token(void)\r\n{\r\nhrt_data token = inputfifo_wrap_marker(0);\r\n_sh_css_fifo_snd(token);\r\nreturn;\r\n}\r\nstatic void inputfifo_start_frame(\r\nunsigned int ch_id,\r\nunsigned int fmt_type)\r\n{\r\ninputfifo_send_ch_id_and_fmt_type(ch_id, fmt_type);\r\ninputfifo_send_sof();\r\nreturn;\r\n}\r\nstatic void inputfifo_end_frame(\r\nunsigned int marker_cycles)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < marker_cycles; i++)\r\ninputfifo_send_empty_token();\r\ninputfifo_send_eof();\r\nreturn;\r\n}\r\nstatic void inputfifo_send_line2(\r\nconst unsigned short *data,\r\nunsigned int width,\r\nconst unsigned short *data2,\r\nunsigned int width2,\r\nunsigned int hblank_cycles,\r\nunsigned int marker_cycles,\r\nunsigned int two_ppc,\r\nenum inputfifo_mipi_data_type type)\r\n{\r\nunsigned int i, is_rgb = 0, is_legacy = 0;\r\nassert(data != NULL);\r\nassert((data2 != NULL) || (width2 == 0));\r\nif (type == inputfifo_mipi_data_type_rgb)\r\nis_rgb = 1;\r\nif (type == inputfifo_mipi_data_type_yuv420_legacy)\r\nis_legacy = 1;\r\nfor (i = 0; i < hblank_cycles; i++)\r\ninputfifo_send_empty_token();\r\ninputfifo_send_sol();\r\nfor (i = 0; i < marker_cycles; i++)\r\ninputfifo_send_empty_token();\r\nfor (i = 0; i < width; i++, data++) {\r\nunsigned int send_two_pixels = two_ppc;\r\nif ((is_rgb || is_legacy) && (i % 3 == 2))\r\nsend_two_pixels = 0;\r\nif (send_two_pixels) {\r\nif (i + 1 == width) {\r\ninputfifo_send_data(\r\ndata[0], 0);\r\n} else {\r\ninputfifo_send_data(\r\ndata[0], data[1]);\r\n}\r\ndata++;\r\ni++;\r\n} else if (two_ppc && is_legacy) {\r\ninputfifo_send_data_b(data[0]);\r\n} else {\r\ninputfifo_send_data_a(data[0]);\r\n}\r\n}\r\nfor (i = 0; i < width2; i++, data2++) {\r\nunsigned int send_two_pixels = two_ppc;\r\nif ((is_rgb || is_legacy) && (i % 3 == 2))\r\nsend_two_pixels = 0;\r\nif (send_two_pixels) {\r\nif (i + 1 == width2) {\r\ninputfifo_send_data(\r\ndata2[0], 0);\r\n} else {\r\ninputfifo_send_data(\r\ndata2[0], data2[1]);\r\n}\r\ndata2++;\r\ni++;\r\n} else if (two_ppc && is_legacy) {\r\ninputfifo_send_data_b(data2[0]);\r\n} else {\r\ninputfifo_send_data_a(data2[0]);\r\n}\r\n}\r\nfor (i = 0; i < hblank_cycles; i++)\r\ninputfifo_send_empty_token();\r\ninputfifo_send_eol();\r\nreturn;\r\n}\r\nstatic void\r\ninputfifo_send_line(const unsigned short *data,\r\nunsigned int width,\r\nunsigned int hblank_cycles,\r\nunsigned int marker_cycles,\r\nunsigned int two_ppc,\r\nenum inputfifo_mipi_data_type type)\r\n{\r\nassert(data != NULL);\r\ninputfifo_send_line2(data, width, NULL, 0,\r\nhblank_cycles,\r\nmarker_cycles,\r\ntwo_ppc,\r\ntype);\r\n}\r\nstatic void inputfifo_send_frame(\r\nconst unsigned short *data,\r\nunsigned int width,\r\nunsigned int height,\r\nunsigned int ch_id,\r\nunsigned int fmt_type,\r\nunsigned int hblank_cycles,\r\nunsigned int marker_cycles,\r\nunsigned int two_ppc,\r\nenum inputfifo_mipi_data_type type)\r\n{\r\nunsigned int i;\r\nassert(data != NULL);\r\ninputfifo_start_frame(ch_id, fmt_type);\r\nfor (i = 0; i < height; i++) {\r\nif ((type == inputfifo_mipi_data_type_yuv420) &&\r\n(i & 1) == 1) {\r\ninputfifo_send_line(data, 2 * width,\r\nhblank_cycles,\r\nmarker_cycles,\r\ntwo_ppc, type);\r\ndata += 2 * width;\r\n} else {\r\ninputfifo_send_line(data, width,\r\nhblank_cycles,\r\nmarker_cycles,\r\ntwo_ppc, type);\r\ndata += width;\r\n}\r\n}\r\ninputfifo_end_frame(marker_cycles);\r\nreturn;\r\n}\r\nstatic enum inputfifo_mipi_data_type inputfifo_determine_type(\r\nenum ia_css_stream_format input_format)\r\n{\r\nenum inputfifo_mipi_data_type type;\r\ntype = inputfifo_mipi_data_type_regular;\r\nif (input_format == IA_CSS_STREAM_FORMAT_YUV420_8_LEGACY) {\r\ntype =\r\ninputfifo_mipi_data_type_yuv420_legacy;\r\n} else if (input_format == IA_CSS_STREAM_FORMAT_YUV420_8 ||\r\ninput_format == IA_CSS_STREAM_FORMAT_YUV420_10 ||\r\ninput_format == IA_CSS_STREAM_FORMAT_YUV420_16) {\r\ntype =\r\ninputfifo_mipi_data_type_yuv420;\r\n} else if (input_format >= IA_CSS_STREAM_FORMAT_RGB_444 &&\r\ninput_format <= IA_CSS_STREAM_FORMAT_RGB_888) {\r\ntype =\r\ninputfifo_mipi_data_type_rgb;\r\n}\r\nreturn type;\r\n}\r\nstatic struct inputfifo_instance *inputfifo_get_inst(\r\nunsigned int ch_id)\r\n{\r\nreturn &inputfifo_inst_admin[ch_id];\r\n}\r\nvoid ia_css_inputfifo_send_input_frame(\r\nconst unsigned short *data,\r\nunsigned int width,\r\nunsigned int height,\r\nunsigned int ch_id,\r\nenum ia_css_stream_format input_format,\r\nbool two_ppc)\r\n{\r\nunsigned int fmt_type, hblank_cycles, marker_cycles;\r\nenum inputfifo_mipi_data_type type;\r\nassert(data != NULL);\r\nhblank_cycles = HBLANK_CYCLES;\r\nmarker_cycles = MARKER_CYCLES;\r\nia_css_isys_convert_stream_format_to_mipi_format(input_format,\r\nMIPI_PREDICTOR_NONE,\r\n&fmt_type);\r\ntype = inputfifo_determine_type(input_format);\r\ninputfifo_send_frame(data, width, height,\r\nch_id, fmt_type, hblank_cycles, marker_cycles,\r\ntwo_ppc, type);\r\n}\r\nvoid ia_css_inputfifo_start_frame(\r\nunsigned int ch_id,\r\nenum ia_css_stream_format input_format,\r\nbool two_ppc)\r\n{\r\nstruct inputfifo_instance *s2mi;\r\ns2mi = inputfifo_get_inst(ch_id);\r\ns2mi->ch_id = ch_id;\r\nia_css_isys_convert_stream_format_to_mipi_format(input_format,\r\nMIPI_PREDICTOR_NONE,\r\n&s2mi->fmt_type);\r\ns2mi->two_ppc = two_ppc;\r\ns2mi->type = inputfifo_determine_type(input_format);\r\ns2mi->hblank_cycles = HBLANK_CYCLES;\r\ns2mi->marker_cycles = MARKER_CYCLES;\r\ns2mi->streaming = true;\r\ninputfifo_start_frame(ch_id, s2mi->fmt_type);\r\nreturn;\r\n}\r\nvoid ia_css_inputfifo_send_line(\r\nunsigned int ch_id,\r\nconst unsigned short *data,\r\nunsigned int width,\r\nconst unsigned short *data2,\r\nunsigned int width2)\r\n{\r\nstruct inputfifo_instance *s2mi;\r\nassert(data != NULL);\r\nassert((data2 != NULL) || (width2 == 0));\r\ns2mi = inputfifo_get_inst(ch_id);\r\ninputfifo_curr_ch_id = (s2mi->ch_id) & _HIVE_ISP_CH_ID_MASK;\r\ninputfifo_curr_fmt_type = (s2mi->fmt_type) & _HIVE_ISP_FMT_TYPE_MASK;\r\ninputfifo_send_line2(data, width, data2, width2,\r\ns2mi->hblank_cycles,\r\ns2mi->marker_cycles,\r\ns2mi->two_ppc,\r\ns2mi->type);\r\n}\r\nvoid ia_css_inputfifo_send_embedded_line(\r\nunsigned int ch_id,\r\nenum ia_css_stream_format data_type,\r\nconst unsigned short *data,\r\nunsigned int width)\r\n{\r\nstruct inputfifo_instance *s2mi;\r\nunsigned int fmt_type;\r\nassert(data != NULL);\r\ns2mi = inputfifo_get_inst(ch_id);\r\nia_css_isys_convert_stream_format_to_mipi_format(data_type,\r\nMIPI_PREDICTOR_NONE, &fmt_type);\r\ninputfifo_curr_fmt_type = fmt_type & _HIVE_ISP_FMT_TYPE_MASK;\r\ninputfifo_send_line(data, width, s2mi->hblank_cycles, s2mi->marker_cycles,\r\ns2mi->two_ppc, inputfifo_mipi_data_type_regular);\r\n}\r\nvoid ia_css_inputfifo_end_frame(\r\nunsigned int ch_id)\r\n{\r\nstruct inputfifo_instance *s2mi;\r\ns2mi = inputfifo_get_inst(ch_id);\r\ninputfifo_curr_ch_id = (s2mi->ch_id) & _HIVE_ISP_CH_ID_MASK;\r\ninputfifo_curr_fmt_type = (s2mi->fmt_type) & _HIVE_ISP_FMT_TYPE_MASK;\r\ninputfifo_end_frame(s2mi->marker_cycles);\r\ns2mi->streaming = false;\r\nreturn;\r\n}

static u8 rt5677_spi_select_cmd(bool read, u32 align, u32 remain, u32 *len)\r\n{\r\nu8 cmd;\r\nif (align == 2 || align == 6 || remain == 2) {\r\ncmd = RT5677_SPI_READ_16;\r\n*len = 2;\r\n} else if (align == 4 || remain <= 6) {\r\ncmd = RT5677_SPI_READ_32;\r\n*len = 4;\r\n} else {\r\ncmd = RT5677_SPI_READ_BURST;\r\n*len = min_t(u32, remain & ~7, RT5677_SPI_BURST_LEN);\r\n}\r\nreturn read ? cmd : cmd + 1;\r\n}\r\nstatic void rt5677_spi_reverse(u8 *dst, u32 dstlen, const u8 *src, u32 srclen)\r\n{\r\nu32 w, i, si;\r\nu32 word_size = min_t(u32, dstlen, 8);\r\nfor (w = 0; w < dstlen; w += word_size) {\r\nfor (i = 0; i < word_size; i++) {\r\nsi = w + word_size - i - 1;\r\ndst[w + i] = si < srclen ? src[si] : 0;\r\n}\r\n}\r\n}\r\nint rt5677_spi_read(u32 addr, void *rxbuf, size_t len)\r\n{\r\nu32 offset;\r\nint status = 0;\r\nstruct spi_transfer t[2];\r\nstruct spi_message m;\r\nu8 header[RT5677_SPI_HEADER + 4];\r\nu8 body[RT5677_SPI_BURST_LEN];\r\nu8 spi_cmd;\r\nu8 *cb = rxbuf;\r\nif (!g_spi)\r\nreturn -ENODEV;\r\nif ((addr & 1) || (len & 1)) {\r\ndev_err(&g_spi->dev, "Bad read align 0x%x(%zu)\n", addr, len);\r\nreturn -EACCES;\r\n}\r\nmemset(t, 0, sizeof(t));\r\nt[0].tx_buf = header;\r\nt[0].len = sizeof(header);\r\nt[0].speed_hz = RT5677_SPI_FREQ;\r\nt[1].rx_buf = body;\r\nt[1].speed_hz = RT5677_SPI_FREQ;\r\nspi_message_init_with_transfers(&m, t, ARRAY_SIZE(t));\r\nfor (offset = 0; offset < len; offset += t[1].len) {\r\nspi_cmd = rt5677_spi_select_cmd(true, (addr + offset) & 7,\r\nlen - offset, &t[1].len);\r\nheader[0] = spi_cmd;\r\nheader[1] = ((addr + offset) & 0xff000000) >> 24;\r\nheader[2] = ((addr + offset) & 0x00ff0000) >> 16;\r\nheader[3] = ((addr + offset) & 0x0000ff00) >> 8;\r\nheader[4] = ((addr + offset) & 0x000000ff) >> 0;\r\nmutex_lock(&spi_mutex);\r\nstatus |= spi_sync(g_spi, &m);\r\nmutex_unlock(&spi_mutex);\r\nrt5677_spi_reverse(cb + offset, t[1].len, body, t[1].len);\r\n}\r\nreturn status;\r\n}\r\nint rt5677_spi_write(u32 addr, const void *txbuf, size_t len)\r\n{\r\nu32 offset, len_with_pad = len;\r\nint status = 0;\r\nstruct spi_transfer t;\r\nstruct spi_message m;\r\nu8 buf[RT5677_SPI_HEADER + RT5677_SPI_BURST_LEN + 1];\r\nu8 *body = buf + RT5677_SPI_HEADER;\r\nu8 spi_cmd;\r\nconst u8 *cb = txbuf;\r\nif (!g_spi)\r\nreturn -ENODEV;\r\nif (addr & 1) {\r\ndev_err(&g_spi->dev, "Bad write align 0x%x(%zu)\n", addr, len);\r\nreturn -EACCES;\r\n}\r\nif (len & 1)\r\nlen_with_pad = len + 1;\r\nmemset(&t, 0, sizeof(t));\r\nt.tx_buf = buf;\r\nt.speed_hz = RT5677_SPI_FREQ;\r\nspi_message_init_with_transfers(&m, &t, 1);\r\nfor (offset = 0; offset < len_with_pad;) {\r\nspi_cmd = rt5677_spi_select_cmd(false, (addr + offset) & 7,\r\nlen_with_pad - offset, &t.len);\r\nbuf[0] = spi_cmd;\r\nbuf[1] = ((addr + offset) & 0xff000000) >> 24;\r\nbuf[2] = ((addr + offset) & 0x00ff0000) >> 16;\r\nbuf[3] = ((addr + offset) & 0x0000ff00) >> 8;\r\nbuf[4] = ((addr + offset) & 0x000000ff) >> 0;\r\nrt5677_spi_reverse(body, t.len, cb + offset, len - offset);\r\noffset += t.len;\r\nt.len += RT5677_SPI_HEADER + 1;\r\nmutex_lock(&spi_mutex);\r\nstatus |= spi_sync(g_spi, &m);\r\nmutex_unlock(&spi_mutex);\r\n}\r\nreturn status;\r\n}\r\nint rt5677_spi_write_firmware(u32 addr, const struct firmware *fw)\r\n{\r\nreturn rt5677_spi_write(addr, fw->data, fw->size);\r\n}\r\nstatic int rt5677_spi_probe(struct spi_device *spi)\r\n{\r\ng_spi = spi;\r\nreturn 0;\r\n}

static inline void init_common_sqe(struct fcoe_task_params *task_params,\r\nenum fcoe_sqe_request_type request_type)\r\n{\r\nmemset(task_params->sqe, 0, sizeof(*(task_params->sqe)));\r\nSET_FIELD(task_params->sqe->flags, FCOE_WQE_REQ_TYPE,\r\nrequest_type);\r\ntask_params->sqe->task_id = task_params->itid;\r\n}\r\nint init_initiator_rw_fcoe_task(struct fcoe_task_params *task_params,\r\nstruct scsi_sgl_task_params *sgl_task_params,\r\nstruct regpair sense_data_buffer_phys_addr,\r\nu32 task_retry_id,\r\nu8 fcp_cmd_payload[32])\r\n{\r\nstruct fcoe_task_context *ctx = task_params->context;\r\nstruct ystorm_fcoe_task_st_ctx *y_st_ctx;\r\nstruct tstorm_fcoe_task_st_ctx *t_st_ctx;\r\nstruct ustorm_fcoe_task_ag_ctx *u_ag_ctx;\r\nstruct mstorm_fcoe_task_st_ctx *m_st_ctx;\r\nu32 io_size, val;\r\nbool slow_sgl;\r\nmemset(ctx, 0, sizeof(*(ctx)));\r\nslow_sgl = scsi_is_slow_sgl(sgl_task_params->num_sges,\r\nsgl_task_params->small_mid_sge);\r\nio_size = (task_params->task_type == FCOE_TASK_TYPE_WRITE_INITIATOR ?\r\ntask_params->tx_io_size : task_params->rx_io_size);\r\ny_st_ctx = &ctx->ystorm_st_context;\r\ny_st_ctx->data_2_trns_rem = cpu_to_le32(io_size);\r\ny_st_ctx->task_rety_identifier = cpu_to_le32(task_retry_id);\r\ny_st_ctx->task_type = task_params->task_type;\r\nmemcpy(&y_st_ctx->tx_info_union.fcp_cmd_payload,\r\nfcp_cmd_payload, sizeof(struct fcoe_fcp_cmd_payload));\r\nt_st_ctx = &ctx->tstorm_st_context;\r\nt_st_ctx->read_only.dev_type = (task_params->is_tape_device == 1 ?\r\nFCOE_TASK_DEV_TYPE_TAPE :\r\nFCOE_TASK_DEV_TYPE_DISK);\r\nt_st_ctx->read_only.cid = cpu_to_le32(task_params->conn_cid);\r\nval = cpu_to_le32(task_params->cq_rss_number);\r\nt_st_ctx->read_only.glbl_q_num = val;\r\nt_st_ctx->read_only.fcp_cmd_trns_size = cpu_to_le32(io_size);\r\nt_st_ctx->read_only.task_type = task_params->task_type;\r\nSET_FIELD(t_st_ctx->read_write.flags,\r\nFCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_EXP_FIRST_FRAME, 1);\r\nt_st_ctx->read_write.rx_id = cpu_to_le16(FCOE_RX_ID);\r\nu_ag_ctx = &ctx->ustorm_ag_context;\r\nu_ag_ctx->global_cq_num = cpu_to_le32(task_params->cq_rss_number);\r\nm_st_ctx = &ctx->mstorm_st_context;\r\nval = cpu_to_le32(sense_data_buffer_phys_addr.hi);\r\nm_st_ctx->rsp_buf_addr.hi = val;\r\nval = cpu_to_le32(sense_data_buffer_phys_addr.lo);\r\nm_st_ctx->rsp_buf_addr.lo = val;\r\nif (task_params->task_type == FCOE_TASK_TYPE_WRITE_INITIATOR) {\r\ny_st_ctx->expect_first_xfer = 1;\r\nSET_FIELD(y_st_ctx->sgl_mode,\r\nYSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE,\r\n(slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\r\ninit_scsi_sgl_context(&y_st_ctx->sgl_params,\r\n&y_st_ctx->data_desc,\r\nsgl_task_params);\r\nSET_FIELD(m_st_ctx->flags,\r\nMSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE,\r\n(slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\r\n} else {\r\nSET_FIELD(t_st_ctx->read_write.flags,\r\nFCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_RX_SGL_MODE,\r\n(slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\r\nm_st_ctx->data_2_trns_rem = cpu_to_le32(io_size);\r\ninit_scsi_sgl_context(&m_st_ctx->sgl_params,\r\n&m_st_ctx->data_desc,\r\nsgl_task_params);\r\n}\r\ninit_common_sqe(task_params, SEND_FCOE_CMD);\r\nreturn 0;\r\n}\r\nint init_initiator_midpath_unsolicited_fcoe_task(\r\nstruct fcoe_task_params *task_params,\r\nstruct fcoe_tx_mid_path_params *mid_path_fc_header,\r\nstruct scsi_sgl_task_params *tx_sgl_task_params,\r\nstruct scsi_sgl_task_params *rx_sgl_task_params,\r\nu8 fw_to_place_fc_header)\r\n{\r\nstruct fcoe_task_context *ctx = task_params->context;\r\nstruct ystorm_fcoe_task_st_ctx *y_st_ctx;\r\nstruct tstorm_fcoe_task_st_ctx *t_st_ctx;\r\nstruct ustorm_fcoe_task_ag_ctx *u_ag_ctx;\r\nstruct mstorm_fcoe_task_st_ctx *m_st_ctx;\r\nu32 val;\r\nmemset(ctx, 0, sizeof(*(ctx)));\r\ny_st_ctx = &ctx->ystorm_st_context;\r\ninit_scsi_sgl_context(&y_st_ctx->sgl_params,\r\n&y_st_ctx->data_desc,\r\ntx_sgl_task_params);\r\nSET_FIELD(y_st_ctx->sgl_mode,\r\nYSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE, SCSI_FAST_SGL);\r\ny_st_ctx->data_2_trns_rem = cpu_to_le32(task_params->tx_io_size);\r\ny_st_ctx->task_type = task_params->task_type;\r\nmemcpy(&y_st_ctx->tx_info_union.tx_params.mid_path,\r\nmid_path_fc_header, sizeof(struct fcoe_tx_mid_path_params));\r\nm_st_ctx = &ctx->mstorm_st_context;\r\ninit_scsi_sgl_context(&m_st_ctx->sgl_params,\r\n&m_st_ctx->data_desc,\r\nrx_sgl_task_params);\r\nSET_FIELD(m_st_ctx->flags,\r\nMSTORM_FCOE_TASK_ST_CTX_MP_INCLUDE_FC_HEADER,\r\nfw_to_place_fc_header);\r\nm_st_ctx->data_2_trns_rem = cpu_to_le32(task_params->rx_io_size);\r\nt_st_ctx = &ctx->tstorm_st_context;\r\nt_st_ctx->read_only.cid = cpu_to_le32(task_params->conn_cid);\r\nval = cpu_to_le32(task_params->cq_rss_number);\r\nt_st_ctx->read_only.glbl_q_num = val;\r\nt_st_ctx->read_only.task_type = task_params->task_type;\r\nSET_FIELD(t_st_ctx->read_write.flags,\r\nFCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_EXP_FIRST_FRAME, 1);\r\nt_st_ctx->read_write.rx_id = cpu_to_le16(FCOE_RX_ID);\r\nu_ag_ctx = &ctx->ustorm_ag_context;\r\nu_ag_ctx->global_cq_num = cpu_to_le32(task_params->cq_rss_number);\r\ninit_common_sqe(task_params, SEND_FCOE_MIDPATH);\r\ntask_params->sqe->additional_info_union.burst_length =\r\ntx_sgl_task_params->total_buffer_size;\r\nSET_FIELD(task_params->sqe->flags,\r\nFCOE_WQE_NUM_SGES, tx_sgl_task_params->num_sges);\r\nSET_FIELD(task_params->sqe->flags, FCOE_WQE_SGL_MODE,\r\nSCSI_FAST_SGL);\r\nreturn 0;\r\n}\r\nint init_initiator_abort_fcoe_task(struct fcoe_task_params *task_params)\r\n{\r\ninit_common_sqe(task_params, SEND_FCOE_ABTS_REQUEST);\r\nreturn 0;\r\n}\r\nint init_initiator_cleanup_fcoe_task(struct fcoe_task_params *task_params)\r\n{\r\ninit_common_sqe(task_params, FCOE_EXCHANGE_CLEANUP);\r\nreturn 0;\r\n}\r\nint init_initiator_sequence_recovery_fcoe_task(\r\nstruct fcoe_task_params *task_params, u32 off)\r\n{\r\ninit_common_sqe(task_params, FCOE_SEQUENCE_RECOVERY);\r\ntask_params->sqe->additional_info_union.seq_rec_updated_offset = off;\r\nreturn 0;\r\n}

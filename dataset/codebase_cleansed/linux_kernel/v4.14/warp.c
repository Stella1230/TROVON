static int __init warp_device_probe(void)\r\n{\r\nof_platform_bus_probe(NULL, warp_of_bus, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init warp_probe(void)\r\n{\r\nif (!of_machine_is_compatible("pika,warp"))\r\nreturn 0;\r\nISA_DMA_THRESHOLD = ~0L;\r\nreturn 1;\r\n}\r\nstatic int __init warp_post_info(void)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *fpga;\r\nu32 post1, post2;\r\nnp = of_find_compatible_node(NULL, NULL, "pika,fpga-sd");\r\nif (np == NULL)\r\nreturn -ENOENT;\r\nfpga = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (fpga == NULL)\r\nreturn -ENOENT;\r\npost1 = in_be32(fpga + 0x40);\r\npost2 = in_be32(fpga + 0x44);\r\niounmap(fpga);\r\nif (post1 || post2)\r\nprintk(KERN_INFO "Warp POST %08x %08x\n", post1, post2);\r\nelse\r\nprintk(KERN_INFO "Warp POST OK\n");\r\nreturn 0;\r\n}\r\nint pika_dtm_register_shutdown(void (*func)(void *arg), void *arg)\r\n{\r\nstruct dtm_shutdown *shutdown;\r\nshutdown = kmalloc(sizeof(struct dtm_shutdown), GFP_KERNEL);\r\nif (shutdown == NULL)\r\nreturn -ENOMEM;\r\nshutdown->func = func;\r\nshutdown->arg = arg;\r\nlist_add(&shutdown->list, &dtm_shutdown_list);\r\nreturn 0;\r\n}\r\nint pika_dtm_unregister_shutdown(void (*func)(void *arg), void *arg)\r\n{\r\nstruct dtm_shutdown *shutdown;\r\nlist_for_each_entry(shutdown, &dtm_shutdown_list, list)\r\nif (shutdown->func == func && shutdown->arg == arg) {\r\nlist_del(&shutdown->list);\r\nkfree(shutdown);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t temp_isr(int irq, void *context)\r\n{\r\nstruct dtm_shutdown *shutdown;\r\nint value = 1;\r\nlocal_irq_disable();\r\ngpio_set_value(green_led, 0);\r\nlist_for_each_entry(shutdown, &dtm_shutdown_list, list)\r\nshutdown->func(shutdown->arg);\r\nprintk(KERN_EMERG "\n\nCritical Temperature Shutdown\n\n");\r\nwhile (1) {\r\nif (dtm_fpga) {\r\nunsigned reset = in_be32(dtm_fpga + 0x14);\r\nout_be32(dtm_fpga + 0x14, reset);\r\n}\r\ngpio_set_value(red_led, value);\r\nvalue ^= 1;\r\nmdelay(500);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pika_setup_leds(void)\r\n{\r\nstruct device_node *np, *child;\r\nnp = of_find_compatible_node(NULL, NULL, "gpio-leds");\r\nif (!np) {\r\nprintk(KERN_ERR __FILE__ ": Unable to find leds\n");\r\nreturn -ENOENT;\r\n}\r\nfor_each_child_of_node(np, child)\r\nif (strcmp(child->name, "green") == 0)\r\ngreen_led = of_get_gpio(child, 0);\r\nelse if (strcmp(child->name, "red") == 0)\r\nred_led = of_get_gpio(child, 0);\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nstatic void pika_setup_critical_temp(struct device_node *np,\r\nstruct i2c_client *client)\r\n{\r\nint irq, rc;\r\npika_setup_leds();\r\ni2c_smbus_write_byte_data(client, 2, 65);\r\ni2c_smbus_write_byte_data(client, 3, 0);\r\nirq = irq_of_parse_and_map(np, 0);\r\nif (!irq) {\r\nprintk(KERN_ERR __FILE__ ": Unable to get ad7414 irq\n");\r\nreturn;\r\n}\r\nrc = request_irq(irq, temp_isr, 0, "ad7414", NULL);\r\nif (rc) {\r\nprintk(KERN_ERR __FILE__\r\n": Unable to request ad7414 irq %d = %d\n", irq, rc);\r\nreturn;\r\n}\r\n}\r\nstatic inline void pika_dtm_check_fan(void __iomem *fpga)\r\n{\r\nstatic int fan_state;\r\nu32 fan = in_be32(fpga + 0x34) & (1 << 14);\r\nif (fan_state != fan) {\r\nfan_state = fan;\r\nif (fan)\r\nprintk(KERN_WARNING "Fan rotation error detected."\r\n" Please check hardware.\n");\r\n}\r\n}\r\nstatic int pika_dtm_thread(void __iomem *fpga)\r\n{\r\nstruct device_node *np;\r\nstruct i2c_client *client;\r\nnp = of_find_compatible_node(NULL, NULL, "adi,ad7414");\r\nif (np == NULL)\r\nreturn -ENOENT;\r\nclient = of_find_i2c_device_by_node(np);\r\nif (client == NULL) {\r\nof_node_put(np);\r\nreturn -ENOENT;\r\n}\r\npika_setup_critical_temp(np, client);\r\nof_node_put(np);\r\nprintk(KERN_INFO "Warp DTM thread running.\n");\r\nwhile (!kthread_should_stop()) {\r\nint val;\r\nval = i2c_smbus_read_word_data(client, 0);\r\nif (val < 0)\r\ndev_dbg(&client->dev, "DTM read temp failed.\n");\r\nelse {\r\ns16 temp = swab16(val);\r\nout_be32(fpga + 0x20, temp);\r\n}\r\npika_dtm_check_fan(fpga);\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nschedule_timeout(HZ);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init pika_dtm_start(void)\r\n{\r\nstruct task_struct *dtm_thread;\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "pika,fpga");\r\nif (np == NULL)\r\nreturn -ENOENT;\r\ndtm_fpga = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (dtm_fpga == NULL)\r\nreturn -ENOENT;\r\nwarp_post_info();\r\ndtm_thread = kthread_run(pika_dtm_thread, dtm_fpga, "pika-dtm");\r\nif (IS_ERR(dtm_thread)) {\r\niounmap(dtm_fpga);\r\nreturn PTR_ERR(dtm_thread);\r\n}\r\nreturn 0;\r\n}\r\nint pika_dtm_register_shutdown(void (*func)(void *arg), void *arg)\r\n{\r\nreturn 0;\r\n}\r\nint pika_dtm_unregister_shutdown(void (*func)(void *arg), void *arg)\r\n{\r\nreturn 0;\r\n}

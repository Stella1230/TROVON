int bpf_bufs(struct bpf_sock_ops *skops)\r\n{\r\nint bufsize = 1500000;\r\nint rwnd_init = 40;\r\nint rv = 0;\r\nint op;\r\nif (bpf_ntohl(skops->remote_port) != 55601 &&\r\nskops->local_port != 55601)\r\nreturn -1;\r\nop = (int) skops->op;\r\n#ifdef DEBUG\r\nbpf_printk("Returning %d\n", rv);\r\n#endif\r\nswitch (op) {\r\ncase BPF_SOCK_OPS_RWND_INIT:\r\nrv = rwnd_init;\r\nbreak;\r\ncase BPF_SOCK_OPS_TCP_CONNECT_CB:\r\nrv = bpf_setsockopt(skops, SOL_SOCKET, SO_SNDBUF, &bufsize,\r\nsizeof(bufsize));\r\nrv = rv*100 + bpf_setsockopt(skops, SOL_SOCKET, SO_RCVBUF,\r\n&bufsize, sizeof(bufsize));\r\nbreak;\r\ncase BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB:\r\nbreak;\r\ncase BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB:\r\nrv = bpf_setsockopt(skops, SOL_SOCKET, SO_SNDBUF, &bufsize,\r\nsizeof(bufsize));\r\nrv = rv*100 + bpf_setsockopt(skops, SOL_SOCKET, SO_RCVBUF,\r\n&bufsize, sizeof(bufsize));\r\nbreak;\r\ndefault:\r\nrv = -1;\r\n}\r\n#ifdef DEBUG\r\nbpf_printk("Returning %d\n", rv);\r\n#endif\r\nskops->reply = rv;\r\nreturn 1;\r\n}

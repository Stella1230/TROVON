int udp_sock_create6(struct net *net, struct udp_port_cfg *cfg,\r\nstruct socket **sockp)\r\n{\r\nstruct sockaddr_in6 udp6_addr;\r\nint err;\r\nstruct socket *sock = NULL;\r\nerr = sock_create_kern(net, AF_INET6, SOCK_DGRAM, 0, &sock);\r\nif (err < 0)\r\ngoto error;\r\nif (cfg->ipv6_v6only) {\r\nint val = 1;\r\nerr = kernel_setsockopt(sock, IPPROTO_IPV6, IPV6_V6ONLY,\r\n(char *) &val, sizeof(val));\r\nif (err < 0)\r\ngoto error;\r\n}\r\nudp6_addr.sin6_family = AF_INET6;\r\nmemcpy(&udp6_addr.sin6_addr, &cfg->local_ip6,\r\nsizeof(udp6_addr.sin6_addr));\r\nudp6_addr.sin6_port = cfg->local_udp_port;\r\nerr = kernel_bind(sock, (struct sockaddr *)&udp6_addr,\r\nsizeof(udp6_addr));\r\nif (err < 0)\r\ngoto error;\r\nif (cfg->peer_udp_port) {\r\nudp6_addr.sin6_family = AF_INET6;\r\nmemcpy(&udp6_addr.sin6_addr, &cfg->peer_ip6,\r\nsizeof(udp6_addr.sin6_addr));\r\nudp6_addr.sin6_port = cfg->peer_udp_port;\r\nerr = kernel_connect(sock,\r\n(struct sockaddr *)&udp6_addr,\r\nsizeof(udp6_addr), 0);\r\n}\r\nif (err < 0)\r\ngoto error;\r\nudp_set_no_check6_tx(sock->sk, !cfg->use_udp6_tx_checksums);\r\nudp_set_no_check6_rx(sock->sk, !cfg->use_udp6_rx_checksums);\r\n*sockp = sock;\r\nreturn 0;\r\nerror:\r\nif (sock) {\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsock_release(sock);\r\n}\r\n*sockp = NULL;\r\nreturn err;\r\n}\r\nint udp_tunnel6_xmit_skb(struct dst_entry *dst, struct sock *sk,\r\nstruct sk_buff *skb,\r\nstruct net_device *dev, struct in6_addr *saddr,\r\nstruct in6_addr *daddr,\r\n__u8 prio, __u8 ttl, __be32 label,\r\n__be16 src_port, __be16 dst_port, bool nocheck)\r\n{\r\nstruct udphdr *uh;\r\nstruct ipv6hdr *ip6h;\r\n__skb_push(skb, sizeof(*uh));\r\nskb_reset_transport_header(skb);\r\nuh = udp_hdr(skb);\r\nuh->dest = dst_port;\r\nuh->source = src_port;\r\nuh->len = htons(skb->len);\r\nskb_dst_set(skb, dst);\r\nudp6_set_csum(nocheck, skb, saddr, daddr, skb->len);\r\n__skb_push(skb, sizeof(*ip6h));\r\nskb_reset_network_header(skb);\r\nip6h = ipv6_hdr(skb);\r\nip6_flow_hdr(ip6h, prio, label);\r\nip6h->payload_len = htons(skb->len);\r\nip6h->nexthdr = IPPROTO_UDP;\r\nip6h->hop_limit = ttl;\r\nip6h->daddr = *daddr;\r\nip6h->saddr = *saddr;\r\nip6tunnel_xmit(sk, skb, dev);\r\nreturn 0;\r\n}

static struct intel_dp *lspcon_to_intel_dp(struct intel_lspcon *lspcon)\r\n{\r\nstruct intel_digital_port *dig_port =\r\ncontainer_of(lspcon, struct intel_digital_port, lspcon);\r\nreturn &dig_port->dp;\r\n}\r\nstatic const char *lspcon_mode_name(enum drm_lspcon_mode mode)\r\n{\r\nswitch (mode) {\r\ncase DRM_LSPCON_MODE_PCON:\r\nreturn "PCON";\r\ncase DRM_LSPCON_MODE_LS:\r\nreturn "LS";\r\ncase DRM_LSPCON_MODE_INVALID:\r\nreturn "INVALID";\r\ndefault:\r\nMISSING_CASE(mode);\r\nreturn "INVALID";\r\n}\r\n}\r\nstatic enum drm_lspcon_mode lspcon_get_current_mode(struct intel_lspcon *lspcon)\r\n{\r\nenum drm_lspcon_mode current_mode;\r\nstruct i2c_adapter *adapter = &lspcon_to_intel_dp(lspcon)->aux.ddc;\r\nif (drm_lspcon_get_mode(adapter, &current_mode)) {\r\nDRM_ERROR("Error reading LSPCON mode\n");\r\nreturn DRM_LSPCON_MODE_INVALID;\r\n}\r\nreturn current_mode;\r\n}\r\nstatic enum drm_lspcon_mode lspcon_wait_mode(struct intel_lspcon *lspcon,\r\nenum drm_lspcon_mode mode)\r\n{\r\nenum drm_lspcon_mode current_mode;\r\ncurrent_mode = lspcon_get_current_mode(lspcon);\r\nif (current_mode == mode || current_mode == DRM_LSPCON_MODE_INVALID)\r\ngoto out;\r\nDRM_DEBUG_KMS("Waiting for LSPCON mode %s to settle\n",\r\nlspcon_mode_name(mode));\r\nwait_for((current_mode = lspcon_get_current_mode(lspcon)) == mode ||\r\ncurrent_mode == DRM_LSPCON_MODE_INVALID, 100);\r\nif (current_mode != mode)\r\nDRM_DEBUG_KMS("LSPCON mode hasn't settled\n");\r\nout:\r\nDRM_DEBUG_KMS("Current LSPCON mode %s\n",\r\nlspcon_mode_name(current_mode));\r\nreturn current_mode;\r\n}\r\nstatic int lspcon_change_mode(struct intel_lspcon *lspcon,\r\nenum drm_lspcon_mode mode)\r\n{\r\nint err;\r\nenum drm_lspcon_mode current_mode;\r\nstruct i2c_adapter *adapter = &lspcon_to_intel_dp(lspcon)->aux.ddc;\r\nerr = drm_lspcon_get_mode(adapter, &current_mode);\r\nif (err) {\r\nDRM_ERROR("Error reading LSPCON mode\n");\r\nreturn err;\r\n}\r\nif (current_mode == mode) {\r\nDRM_DEBUG_KMS("Current mode = desired LSPCON mode\n");\r\nreturn 0;\r\n}\r\nerr = drm_lspcon_set_mode(adapter, mode);\r\nif (err < 0) {\r\nDRM_ERROR("LSPCON mode change failed\n");\r\nreturn err;\r\n}\r\nlspcon->mode = mode;\r\nDRM_DEBUG_KMS("LSPCON mode changed done\n");\r\nreturn 0;\r\n}\r\nstatic bool lspcon_wake_native_aux_ch(struct intel_lspcon *lspcon)\r\n{\r\nuint8_t rev;\r\nif (drm_dp_dpcd_readb(&lspcon_to_intel_dp(lspcon)->aux, DP_DPCD_REV,\r\n&rev) != 1) {\r\nDRM_DEBUG_KMS("Native AUX CH down\n");\r\nreturn false;\r\n}\r\nDRM_DEBUG_KMS("Native AUX CH up, DPCD version: %d.%d\n",\r\nrev >> 4, rev & 0xf);\r\nreturn true;\r\n}\r\nstatic bool lspcon_probe(struct intel_lspcon *lspcon)\r\n{\r\nenum drm_dp_dual_mode_type adaptor_type;\r\nstruct i2c_adapter *adapter = &lspcon_to_intel_dp(lspcon)->aux.ddc;\r\nenum drm_lspcon_mode expected_mode;\r\nexpected_mode = lspcon_wake_native_aux_ch(lspcon) ?\r\nDRM_LSPCON_MODE_PCON : DRM_LSPCON_MODE_LS;\r\nadaptor_type = drm_dp_dual_mode_detect(adapter);\r\nif (adaptor_type != DRM_DP_DUAL_MODE_LSPCON) {\r\nDRM_DEBUG_KMS("No LSPCON detected, found %s\n",\r\ndrm_dp_get_dual_mode_type_name(adaptor_type));\r\nreturn false;\r\n}\r\nDRM_DEBUG_KMS("LSPCON detected\n");\r\nlspcon->mode = lspcon_wait_mode(lspcon, expected_mode);\r\nlspcon->active = true;\r\nreturn true;\r\n}\r\nstatic void lspcon_resume_in_pcon_wa(struct intel_lspcon *lspcon)\r\n{\r\nstruct intel_dp *intel_dp = lspcon_to_intel_dp(lspcon);\r\nstruct intel_digital_port *dig_port = dp_to_dig_port(intel_dp);\r\nstruct drm_i915_private *dev_priv = to_i915(dig_port->base.base.dev);\r\nunsigned long start = jiffies;\r\nwhile (1) {\r\nif (intel_digital_port_connected(dev_priv, dig_port)) {\r\nDRM_DEBUG_KMS("LSPCON recovering in PCON mode after %u ms\n",\r\njiffies_to_msecs(jiffies - start));\r\nreturn;\r\n}\r\nif (time_after(jiffies, start + msecs_to_jiffies(1000)))\r\nbreak;\r\nusleep_range(10000, 15000);\r\n}\r\nDRM_DEBUG_KMS("LSPCON DP descriptor mismatch after resume\n");\r\n}\r\nvoid lspcon_resume(struct intel_lspcon *lspcon)\r\n{\r\nenum drm_lspcon_mode expected_mode;\r\nif (lspcon_wake_native_aux_ch(lspcon)) {\r\nexpected_mode = DRM_LSPCON_MODE_PCON;\r\nlspcon_resume_in_pcon_wa(lspcon);\r\n} else {\r\nexpected_mode = DRM_LSPCON_MODE_LS;\r\n}\r\nif (lspcon_wait_mode(lspcon, expected_mode) == DRM_LSPCON_MODE_PCON)\r\nreturn;\r\nif (lspcon_change_mode(lspcon, DRM_LSPCON_MODE_PCON))\r\nDRM_ERROR("LSPCON resume failed\n");\r\nelse\r\nDRM_DEBUG_KMS("LSPCON resume success\n");\r\n}\r\nvoid lspcon_wait_pcon_mode(struct intel_lspcon *lspcon)\r\n{\r\nlspcon_wait_mode(lspcon, DRM_LSPCON_MODE_PCON);\r\n}\r\nbool lspcon_init(struct intel_digital_port *intel_dig_port)\r\n{\r\nstruct intel_dp *dp = &intel_dig_port->dp;\r\nstruct intel_lspcon *lspcon = &intel_dig_port->lspcon;\r\nstruct drm_device *dev = intel_dig_port->base.base.dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nif (!HAS_LSPCON(dev_priv)) {\r\nDRM_ERROR("LSPCON is not supported on this platform\n");\r\nreturn false;\r\n}\r\nlspcon->active = false;\r\nlspcon->mode = DRM_LSPCON_MODE_INVALID;\r\nif (!lspcon_probe(lspcon)) {\r\nDRM_ERROR("Failed to probe lspcon\n");\r\nreturn false;\r\n}\r\nif (lspcon->active && lspcon->mode != DRM_LSPCON_MODE_PCON) {\r\nif (lspcon_change_mode(lspcon, DRM_LSPCON_MODE_PCON) < 0) {\r\nDRM_ERROR("LSPCON mode change to PCON failed\n");\r\nreturn false;\r\n}\r\n}\r\nif (!intel_dp_read_dpcd(dp)) {\r\nDRM_ERROR("LSPCON DPCD read failed\n");\r\nreturn false;\r\n}\r\ndrm_dp_read_desc(&dp->aux, &dp->desc, drm_dp_is_branch(dp->dpcd));\r\nDRM_DEBUG_KMS("Success: LSPCON init\n");\r\nreturn true;\r\n}

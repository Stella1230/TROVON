static inline struct xfs_dq_logitem *DQUOT_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_dq_logitem, qli_item);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_size(\r\nstruct xfs_log_item *lip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\n*nvecs += 2;\r\n*nbytes += sizeof(struct xfs_dq_logformat) +\r\nsizeof(struct xfs_disk_dquot);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_vec *lv)\r\n{\r\nstruct xfs_dq_logitem *qlip = DQUOT_ITEM(lip);\r\nstruct xfs_log_iovec *vecp = NULL;\r\nstruct xfs_dq_logformat *qlf;\r\nqlf = xlog_prepare_iovec(lv, &vecp, XLOG_REG_TYPE_QFORMAT);\r\nqlf->qlf_type = XFS_LI_DQUOT;\r\nqlf->qlf_size = 2;\r\nqlf->qlf_id = be32_to_cpu(qlip->qli_dquot->q_core.d_id);\r\nqlf->qlf_blkno = qlip->qli_dquot->q_blkno;\r\nqlf->qlf_len = 1;\r\nqlf->qlf_boffset = qlip->qli_dquot->q_bufoffset;\r\nxlog_finish_iovec(lv, vecp, sizeof(struct xfs_dq_logformat));\r\nxlog_copy_iovec(lv, &vecp, XLOG_REG_TYPE_DQUOT,\r\n&qlip->qli_dquot->q_core,\r\nsizeof(struct xfs_disk_dquot));\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\natomic_inc(&dqp->q_pincount);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(atomic_read(&dqp->q_pincount) > 0);\r\nif (atomic_dec_and_test(&dqp->q_pincount))\r\nwake_up(&dqp->q_pinwait);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_dquot_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nreturn lsn;\r\n}\r\nvoid\r\nxfs_qm_dqunpin_wait(\r\nstruct xfs_dquot *dqp)\r\n{\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\nif (atomic_read(&dqp->q_pincount) == 0)\r\nreturn;\r\nxfs_log_force(dqp->q_mount, 0);\r\nwait_event(dqp->q_pinwait, (atomic_read(&dqp->q_pincount) == 0));\r\n}\r\nSTATIC uint\r\nxfs_qm_dquot_logitem_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list) __releases(&lip->li_ailp->xa_lock\r\nSTATIC void\r\nxfs_qm_dquot_logitem_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\ndqp->q_transp = NULL;\r\nxfs_dqunlock(dqp);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\n}\r\nvoid\r\nxfs_qm_dquot_logitem_init(\r\nstruct xfs_dquot *dqp)\r\n{\r\nstruct xfs_dq_logitem *lp = &dqp->q_logitem;\r\nxfs_log_item_init(dqp->q_mount, &lp->qli_item, XFS_LI_DQUOT,\r\n&xfs_dquot_item_ops);\r\nlp->qli_dquot = dqp;\r\n}\r\nstatic inline struct xfs_qoff_logitem *QOFF_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_qoff_logitem, qql_item);\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_size(\r\nstruct xfs_log_item *lip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\n*nvecs += 1;\r\n*nbytes += sizeof(struct xfs_qoff_logitem);\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_vec *lv)\r\n{\r\nstruct xfs_qoff_logitem *qflip = QOFF_ITEM(lip);\r\nstruct xfs_log_iovec *vecp = NULL;\r\nstruct xfs_qoff_logformat *qlf;\r\nqlf = xlog_prepare_iovec(lv, &vecp, XLOG_REG_TYPE_QUOTAOFF);\r\nqlf->qf_type = XFS_LI_QUOTAOFF;\r\nqlf->qf_size = 1;\r\nqlf->qf_flags = qflip->qql_flags;\r\nxlog_finish_iovec(lv, vecp, sizeof(struct xfs_qoff_logitem));\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\n}\r\nSTATIC uint\r\nxfs_qm_qoff_logitem_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nreturn XFS_ITEM_LOCKED;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_qoff_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nreturn lsn;\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_qoffend_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_qoff_logitem *qfe = QOFF_ITEM(lip);\r\nstruct xfs_qoff_logitem *qfs = qfe->qql_start_lip;\r\nstruct xfs_ail *ailp = qfs->qql_item.li_ailp;\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, &qfs->qql_item, SHUTDOWN_LOG_IO_ERROR);\r\nkmem_free(qfs->qql_item.li_lv_shadow);\r\nkmem_free(lip->li_lv_shadow);\r\nkmem_free(qfs);\r\nkmem_free(qfe);\r\nreturn (xfs_lsn_t)-1;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t commit_lsn)\r\n{\r\n}\r\nstruct xfs_qoff_logitem *\r\nxfs_qm_qoff_logitem_init(\r\nstruct xfs_mount *mp,\r\nstruct xfs_qoff_logitem *start,\r\nuint flags)\r\n{\r\nstruct xfs_qoff_logitem *qf;\r\nqf = kmem_zalloc(sizeof(struct xfs_qoff_logitem), KM_SLEEP);\r\nxfs_log_item_init(mp, &qf->qql_item, XFS_LI_QUOTAOFF, start ?\r\n&xfs_qm_qoffend_logitem_ops : &xfs_qm_qoff_logitem_ops);\r\nqf->qql_item.li_mountp = mp;\r\nqf->qql_start_lip = start;\r\nqf->qql_flags = flags;\r\nreturn qf;\r\n}

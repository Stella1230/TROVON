static struct ib_ah *create_ib_ah(struct mlx5_ib_dev *dev,\r\nstruct mlx5_ib_ah *ah,\r\nstruct rdma_ah_attr *ah_attr)\r\n{\r\nif (rdma_ah_get_ah_flags(ah_attr) & IB_AH_GRH) {\r\nconst struct ib_global_route *grh = rdma_ah_read_grh(ah_attr);\r\nmemcpy(ah->av.rgid, &grh->dgid, 16);\r\nah->av.grh_gid_fl = cpu_to_be32(grh->flow_label |\r\n(1 << 30) |\r\ngrh->sgid_index << 20);\r\nah->av.hop_limit = grh->hop_limit;\r\nah->av.tclass = grh->traffic_class;\r\n}\r\nah->av.stat_rate_sl = (rdma_ah_get_static_rate(ah_attr) << 4);\r\nif (ah_attr->type == RDMA_AH_ATTR_TYPE_ROCE) {\r\nmemcpy(ah->av.rmac, ah_attr->roce.dmac,\r\nsizeof(ah_attr->roce.dmac));\r\nah->av.udp_sport =\r\nmlx5_get_roce_udp_sport(dev,\r\nrdma_ah_get_port_num(ah_attr),\r\nrdma_ah_read_grh(ah_attr)->sgid_index);\r\nah->av.stat_rate_sl |= (rdma_ah_get_sl(ah_attr) & 0x7) << 1;\r\n} else {\r\nah->av.rlid = cpu_to_be16(rdma_ah_get_dlid(ah_attr));\r\nah->av.fl_mlid = rdma_ah_get_path_bits(ah_attr) & 0x7f;\r\nah->av.stat_rate_sl |= (rdma_ah_get_sl(ah_attr) & 0xf);\r\n}\r\nreturn &ah->ibah;\r\n}\r\nstruct ib_ah *mlx5_ib_create_ah(struct ib_pd *pd, struct rdma_ah_attr *ah_attr,\r\nstruct ib_udata *udata)\r\n{\r\nstruct mlx5_ib_ah *ah;\r\nstruct mlx5_ib_dev *dev = to_mdev(pd->device);\r\nenum rdma_ah_attr_type ah_type = ah_attr->type;\r\nif ((ah_type == RDMA_AH_ATTR_TYPE_ROCE) &&\r\n!(rdma_ah_get_ah_flags(ah_attr) & IB_AH_GRH))\r\nreturn ERR_PTR(-EINVAL);\r\nif (ah_type == RDMA_AH_ATTR_TYPE_ROCE && udata) {\r\nint err;\r\nstruct mlx5_ib_create_ah_resp resp = {};\r\nu32 min_resp_len = offsetof(typeof(resp), dmac) +\r\nsizeof(resp.dmac);\r\nif (udata->outlen < min_resp_len)\r\nreturn ERR_PTR(-EINVAL);\r\nresp.response_length = min_resp_len;\r\nerr = ib_resolve_eth_dmac(pd->device, ah_attr);\r\nif (err)\r\nreturn ERR_PTR(err);\r\nmemcpy(resp.dmac, ah_attr->roce.dmac, ETH_ALEN);\r\nerr = ib_copy_to_udata(udata, &resp, resp.response_length);\r\nif (err)\r\nreturn ERR_PTR(err);\r\n}\r\nah = kzalloc(sizeof(*ah), GFP_ATOMIC);\r\nif (!ah)\r\nreturn ERR_PTR(-ENOMEM);\r\nreturn create_ib_ah(dev, ah, ah_attr);\r\n}\r\nint mlx5_ib_query_ah(struct ib_ah *ibah, struct rdma_ah_attr *ah_attr)\r\n{\r\nstruct mlx5_ib_ah *ah = to_mah(ibah);\r\nu32 tmp;\r\nmemset(ah_attr, 0, sizeof(*ah_attr));\r\nah_attr->type = ibah->type;\r\ntmp = be32_to_cpu(ah->av.grh_gid_fl);\r\nif (tmp & (1 << 30)) {\r\nrdma_ah_set_grh(ah_attr, NULL,\r\ntmp & 0xfffff,\r\n(tmp >> 20) & 0xff,\r\nah->av.hop_limit,\r\nah->av.tclass);\r\nrdma_ah_set_dgid_raw(ah_attr, ah->av.rgid);\r\n}\r\nrdma_ah_set_dlid(ah_attr, be16_to_cpu(ah->av.rlid));\r\nrdma_ah_set_static_rate(ah_attr, ah->av.stat_rate_sl >> 4);\r\nrdma_ah_set_sl(ah_attr, ah->av.stat_rate_sl & 0xf);\r\nreturn 0;\r\n}\r\nint mlx5_ib_destroy_ah(struct ib_ah *ah)\r\n{\r\nkfree(to_mah(ah));\r\nreturn 0;\r\n}

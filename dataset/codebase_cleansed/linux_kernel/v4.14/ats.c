void pci_ats_init(struct pci_dev *dev)\r\n{\r\nint pos;\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ATS);\r\nif (!pos)\r\nreturn;\r\ndev->ats_cap = pos;\r\n}\r\nint pci_enable_ats(struct pci_dev *dev, int ps)\r\n{\r\nu16 ctrl;\r\nstruct pci_dev *pdev;\r\nif (!dev->ats_cap)\r\nreturn -EINVAL;\r\nif (WARN_ON(dev->ats_enabled))\r\nreturn -EBUSY;\r\nif (ps < PCI_ATS_MIN_STU)\r\nreturn -EINVAL;\r\nctrl = PCI_ATS_CTRL_ENABLE;\r\nif (dev->is_virtfn) {\r\npdev = pci_physfn(dev);\r\nif (pdev->ats_stu != ps)\r\nreturn -EINVAL;\r\natomic_inc(&pdev->ats_ref_cnt);\r\n} else {\r\ndev->ats_stu = ps;\r\nctrl |= PCI_ATS_CTRL_STU(dev->ats_stu - PCI_ATS_MIN_STU);\r\n}\r\npci_write_config_word(dev, dev->ats_cap + PCI_ATS_CTRL, ctrl);\r\ndev->ats_enabled = 1;\r\nreturn 0;\r\n}\r\nvoid pci_disable_ats(struct pci_dev *dev)\r\n{\r\nstruct pci_dev *pdev;\r\nu16 ctrl;\r\nif (WARN_ON(!dev->ats_enabled))\r\nreturn;\r\nif (atomic_read(&dev->ats_ref_cnt))\r\nreturn;\r\nif (dev->is_virtfn) {\r\npdev = pci_physfn(dev);\r\natomic_dec(&pdev->ats_ref_cnt);\r\n}\r\npci_read_config_word(dev, dev->ats_cap + PCI_ATS_CTRL, &ctrl);\r\nctrl &= ~PCI_ATS_CTRL_ENABLE;\r\npci_write_config_word(dev, dev->ats_cap + PCI_ATS_CTRL, ctrl);\r\ndev->ats_enabled = 0;\r\n}\r\nvoid pci_restore_ats_state(struct pci_dev *dev)\r\n{\r\nu16 ctrl;\r\nif (!dev->ats_enabled)\r\nreturn;\r\nctrl = PCI_ATS_CTRL_ENABLE;\r\nif (!dev->is_virtfn)\r\nctrl |= PCI_ATS_CTRL_STU(dev->ats_stu - PCI_ATS_MIN_STU);\r\npci_write_config_word(dev, dev->ats_cap + PCI_ATS_CTRL, ctrl);\r\n}\r\nint pci_ats_queue_depth(struct pci_dev *dev)\r\n{\r\nu16 cap;\r\nif (!dev->ats_cap)\r\nreturn -EINVAL;\r\nif (dev->is_virtfn)\r\nreturn 0;\r\npci_read_config_word(dev, dev->ats_cap + PCI_ATS_CAP, &cap);\r\nreturn PCI_ATS_CAP_QDEP(cap) ? PCI_ATS_CAP_QDEP(cap) : PCI_ATS_MAX_QDEP;\r\n}\r\nint pci_enable_pri(struct pci_dev *pdev, u32 reqs)\r\n{\r\nu16 control, status;\r\nu32 max_requests;\r\nint pos;\r\nif (WARN_ON(pdev->pri_enabled))\r\nreturn -EBUSY;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PRI_STATUS, &status);\r\nif (!(status & PCI_PRI_STATUS_STOPPED))\r\nreturn -EBUSY;\r\npci_read_config_dword(pdev, pos + PCI_PRI_MAX_REQ, &max_requests);\r\nreqs = min(max_requests, reqs);\r\npdev->pri_reqs_alloc = reqs;\r\npci_write_config_dword(pdev, pos + PCI_PRI_ALLOC_REQ, reqs);\r\ncontrol = PCI_PRI_CTRL_ENABLE;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\npdev->pri_enabled = 1;\r\nreturn 0;\r\n}\r\nvoid pci_disable_pri(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\nif (WARN_ON(!pdev->pri_enabled))\r\nreturn;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\ncontrol &= ~PCI_PRI_CTRL_ENABLE;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\npdev->pri_enabled = 0;\r\n}\r\nvoid pci_restore_pri_state(struct pci_dev *pdev)\r\n{\r\nu16 control = PCI_PRI_CTRL_ENABLE;\r\nu32 reqs = pdev->pri_reqs_alloc;\r\nint pos;\r\nif (!pdev->pri_enabled)\r\nreturn;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn;\r\npci_write_config_dword(pdev, pos + PCI_PRI_ALLOC_REQ, reqs);\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\n}\r\nint pci_reset_pri(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\nif (WARN_ON(pdev->pri_enabled))\r\nreturn -EBUSY;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn -EINVAL;\r\ncontrol = PCI_PRI_CTRL_RESET;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\nreturn 0;\r\n}\r\nint pci_enable_pasid(struct pci_dev *pdev, int features)\r\n{\r\nu16 control, supported;\r\nint pos;\r\nif (WARN_ON(pdev->pasid_enabled))\r\nreturn -EBUSY;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nsupported &= PCI_PASID_CAP_EXEC | PCI_PASID_CAP_PRIV;\r\nif ((supported & features) != features)\r\nreturn -EINVAL;\r\ncontrol = PCI_PASID_CTRL_ENABLE | features;\r\npdev->pasid_features = features;\r\npci_write_config_word(pdev, pos + PCI_PASID_CTRL, control);\r\npdev->pasid_enabled = 1;\r\nreturn 0;\r\n}\r\nvoid pci_disable_pasid(struct pci_dev *pdev)\r\n{\r\nu16 control = 0;\r\nint pos;\r\nif (WARN_ON(!pdev->pasid_enabled))\r\nreturn;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn;\r\npci_write_config_word(pdev, pos + PCI_PASID_CTRL, control);\r\npdev->pasid_enabled = 0;\r\n}\r\nvoid pci_restore_pasid_state(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\nif (!pdev->pasid_enabled)\r\nreturn;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn;\r\ncontrol = PCI_PASID_CTRL_ENABLE | pdev->pasid_features;\r\npci_write_config_word(pdev, pos + PCI_PASID_CTRL, control);\r\n}\r\nint pci_pasid_features(struct pci_dev *pdev)\r\n{\r\nu16 supported;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nsupported &= PCI_PASID_CAP_EXEC | PCI_PASID_CAP_PRIV;\r\nreturn supported;\r\n}\r\nint pci_max_pasids(struct pci_dev *pdev)\r\n{\r\nu16 supported;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nsupported = (supported & PASID_NUMBER_MASK) >> PASID_NUMBER_SHIFT;\r\nreturn (1 << supported);\r\n}

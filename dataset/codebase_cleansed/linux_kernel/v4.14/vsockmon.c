static int vsockmon_dev_init(struct net_device *dev)\r\n{\r\ndev->lstats = netdev_alloc_pcpu_stats(struct pcpu_lstats);\r\nif (!dev->lstats)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void vsockmon_dev_uninit(struct net_device *dev)\r\n{\r\nfree_percpu(dev->lstats);\r\n}\r\nstatic int vsockmon_open(struct net_device *dev)\r\n{\r\nstruct vsockmon *vsockmon = netdev_priv(dev);\r\nvsockmon->vt.dev = dev;\r\nvsockmon->vt.module = THIS_MODULE;\r\nreturn vsock_add_tap(&vsockmon->vt);\r\n}\r\nstatic int vsockmon_close(struct net_device *dev)\r\n{\r\nstruct vsockmon *vsockmon = netdev_priv(dev);\r\nreturn vsock_remove_tap(&vsockmon->vt);\r\n}\r\nstatic netdev_tx_t vsockmon_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nint len = skb->len;\r\nstruct pcpu_lstats *stats = this_cpu_ptr(dev->lstats);\r\nu64_stats_update_begin(&stats->syncp);\r\nstats->rx_bytes += len;\r\nstats->rx_packets++;\r\nu64_stats_update_end(&stats->syncp);\r\ndev_kfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic void\r\nvsockmon_get_stats64(struct net_device *dev, struct rtnl_link_stats64 *stats)\r\n{\r\nint i;\r\nu64 bytes = 0, packets = 0;\r\nfor_each_possible_cpu(i) {\r\nconst struct pcpu_lstats *vstats;\r\nu64 tbytes, tpackets;\r\nunsigned int start;\r\nvstats = per_cpu_ptr(dev->lstats, i);\r\ndo {\r\nstart = u64_stats_fetch_begin_irq(&vstats->syncp);\r\ntbytes = vstats->rx_bytes;\r\ntpackets = vstats->rx_packets;\r\n} while (u64_stats_fetch_retry_irq(&vstats->syncp, start));\r\npackets += tpackets;\r\nbytes += tbytes;\r\n}\r\nstats->rx_packets = packets;\r\nstats->tx_packets = 0;\r\nstats->rx_bytes = bytes;\r\nstats->tx_bytes = 0;\r\n}\r\nstatic int vsockmon_is_valid_mtu(int new_mtu)\r\n{\r\nreturn new_mtu >= (int)sizeof(struct af_vsockmon_hdr);\r\n}\r\nstatic int vsockmon_change_mtu(struct net_device *dev, int new_mtu)\r\n{\r\nif (!vsockmon_is_valid_mtu(new_mtu))\r\nreturn -EINVAL;\r\ndev->mtu = new_mtu;\r\nreturn 0;\r\n}\r\nstatic u32 always_on(struct net_device *dev)\r\n{\r\nreturn 1;\r\n}\r\nstatic void vsockmon_setup(struct net_device *dev)\r\n{\r\ndev->type = ARPHRD_VSOCKMON;\r\ndev->priv_flags |= IFF_NO_QUEUE;\r\ndev->netdev_ops = &vsockmon_ops;\r\ndev->ethtool_ops = &vsockmon_ethtool_ops;\r\ndev->needs_free_netdev = true;\r\ndev->features = NETIF_F_SG | NETIF_F_FRAGLIST |\r\nNETIF_F_HIGHDMA | NETIF_F_LLTX;\r\ndev->flags = IFF_NOARP;\r\ndev->mtu = DEFAULT_MTU;\r\n}\r\nstatic __init int vsockmon_register(void)\r\n{\r\nreturn rtnl_link_register(&vsockmon_link_ops);\r\n}\r\nstatic __exit void vsockmon_unregister(void)\r\n{\r\nrtnl_link_unregister(&vsockmon_link_ops);\r\n}

static enum hrtimer_restart softdog_fire(struct hrtimer *timer)\r\n{\r\nmodule_put(THIS_MODULE);\r\nif (soft_noboot) {\r\npr_crit("Triggered - Reboot ignored\n");\r\n} else if (soft_panic) {\r\npr_crit("Initiating panic\n");\r\npanic("Software Watchdog Timer expired");\r\n} else {\r\npr_crit("Initiating system reboot\n");\r\nemergency_restart();\r\npr_crit("Reboot didn't ?????\n");\r\n}\r\nreturn HRTIMER_NORESTART;\r\n}\r\nstatic enum hrtimer_restart softdog_pretimeout(struct hrtimer *timer)\r\n{\r\nwatchdog_notify_pretimeout(&softdog_dev);\r\nreturn HRTIMER_NORESTART;\r\n}\r\nstatic int softdog_ping(struct watchdog_device *w)\r\n{\r\nif (!hrtimer_active(&softdog_ticktock))\r\n__module_get(THIS_MODULE);\r\nhrtimer_start(&softdog_ticktock, ktime_set(w->timeout, 0),\r\nHRTIMER_MODE_REL);\r\nif (IS_ENABLED(CONFIG_SOFT_WATCHDOG_PRETIMEOUT)) {\r\nif (w->pretimeout)\r\nhrtimer_start(&softdog_preticktock,\r\nktime_set(w->timeout - w->pretimeout, 0),\r\nHRTIMER_MODE_REL);\r\nelse\r\nhrtimer_cancel(&softdog_preticktock);\r\n}\r\nreturn 0;\r\n}\r\nstatic int softdog_stop(struct watchdog_device *w)\r\n{\r\nif (hrtimer_cancel(&softdog_ticktock))\r\nmodule_put(THIS_MODULE);\r\nif (IS_ENABLED(CONFIG_SOFT_WATCHDOG_PRETIMEOUT))\r\nhrtimer_cancel(&softdog_preticktock);\r\nreturn 0;\r\n}\r\nstatic int __init softdog_init(void)\r\n{\r\nint ret;\r\nwatchdog_init_timeout(&softdog_dev, soft_margin, NULL);\r\nwatchdog_set_nowayout(&softdog_dev, nowayout);\r\nwatchdog_stop_on_reboot(&softdog_dev);\r\nhrtimer_init(&softdog_ticktock, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\nsoftdog_ticktock.function = softdog_fire;\r\nif (IS_ENABLED(CONFIG_SOFT_WATCHDOG_PRETIMEOUT)) {\r\nsoftdog_info.options |= WDIOF_PRETIMEOUT;\r\nhrtimer_init(&softdog_preticktock, CLOCK_MONOTONIC,\r\nHRTIMER_MODE_REL);\r\nsoftdog_preticktock.function = softdog_pretimeout;\r\n}\r\nret = watchdog_register_device(&softdog_dev);\r\nif (ret)\r\nreturn ret;\r\npr_info("initialized. soft_noboot=%d soft_margin=%d sec soft_panic=%d (nowayout=%d)\n",\r\nsoft_noboot, softdog_dev.timeout, soft_panic, nowayout);\r\nreturn 0;\r\n}\r\nstatic void __exit softdog_exit(void)\r\n{\r\nwatchdog_unregister_device(&softdog_dev);\r\n}

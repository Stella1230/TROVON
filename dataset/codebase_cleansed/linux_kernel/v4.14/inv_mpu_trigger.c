static void inv_scan_query(struct iio_dev *indio_dev)\r\n{\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nst->chip_config.gyro_fifo_enable =\r\ntest_bit(INV_MPU6050_SCAN_GYRO_X,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_GYRO_Y,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_GYRO_Z,\r\nindio_dev->active_scan_mask);\r\nst->chip_config.accl_fifo_enable =\r\ntest_bit(INV_MPU6050_SCAN_ACCL_X,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_ACCL_Y,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_ACCL_Z,\r\nindio_dev->active_scan_mask);\r\n}\r\nstatic int inv_mpu6050_set_enable(struct iio_dev *indio_dev, bool enable)\r\n{\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nint result;\r\nif (enable) {\r\nresult = inv_mpu6050_set_power_itg(st, true);\r\nif (result)\r\nreturn result;\r\ninv_scan_query(indio_dev);\r\nif (st->chip_config.gyro_fifo_enable) {\r\nresult = inv_mpu6050_switch_engine(st, true,\r\nINV_MPU6050_BIT_PWR_GYRO_STBY);\r\nif (result)\r\nreturn result;\r\n}\r\nif (st->chip_config.accl_fifo_enable) {\r\nresult = inv_mpu6050_switch_engine(st, true,\r\nINV_MPU6050_BIT_PWR_ACCL_STBY);\r\nif (result)\r\nreturn result;\r\n}\r\nresult = inv_reset_fifo(indio_dev);\r\nif (result)\r\nreturn result;\r\n} else {\r\nresult = regmap_write(st->map, st->reg->fifo_en, 0);\r\nif (result)\r\nreturn result;\r\nresult = regmap_write(st->map, st->reg->int_enable, 0);\r\nif (result)\r\nreturn result;\r\nresult = regmap_write(st->map, st->reg->user_ctrl, 0);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_switch_engine(st, false,\r\nINV_MPU6050_BIT_PWR_GYRO_STBY);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_switch_engine(st, false,\r\nINV_MPU6050_BIT_PWR_ACCL_STBY);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_set_power_itg(st, false);\r\nif (result)\r\nreturn result;\r\n}\r\nreturn 0;\r\n}\r\nstatic int inv_mpu_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nstruct iio_dev *indio_dev = iio_trigger_get_drvdata(trig);\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nint result;\r\nmutex_lock(&st->lock);\r\nresult = inv_mpu6050_set_enable(indio_dev, state);\r\nmutex_unlock(&st->lock);\r\nreturn result;\r\n}\r\nint inv_mpu6050_probe_trigger(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nst->trig = devm_iio_trigger_alloc(&indio_dev->dev,\r\n"%s-dev%d",\r\nindio_dev->name,\r\nindio_dev->id);\r\nif (!st->trig)\r\nreturn -ENOMEM;\r\nret = devm_request_irq(&indio_dev->dev, st->irq,\r\n&iio_trigger_generic_data_rdy_poll,\r\nIRQF_TRIGGER_RISING,\r\n"inv_mpu",\r\nst->trig);\r\nif (ret)\r\nreturn ret;\r\nst->trig->dev.parent = regmap_get_device(st->map);\r\nst->trig->ops = &inv_mpu_trigger_ops;\r\niio_trigger_set_drvdata(st->trig, indio_dev);\r\nret = iio_trigger_register(st->trig);\r\nif (ret)\r\nreturn ret;\r\nindio_dev->trig = iio_trigger_get(st->trig);\r\nreturn 0;\r\n}\r\nvoid inv_mpu6050_remove_trigger(struct inv_mpu6050_state *st)\r\n{\r\niio_trigger_unregister(st->trig);\r\n}

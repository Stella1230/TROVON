static ssize_t mmio_nvram_read(char *buf, size_t count, loff_t *index)\r\n{\r\nunsigned long flags;\r\nif (*index >= mmio_nvram_len)\r\nreturn 0;\r\nif (*index + count > mmio_nvram_len)\r\ncount = mmio_nvram_len - *index;\r\nspin_lock_irqsave(&mmio_nvram_lock, flags);\r\nmemcpy_fromio(buf, mmio_nvram_start + *index, count);\r\nspin_unlock_irqrestore(&mmio_nvram_lock, flags);\r\n*index += count;\r\nreturn count;\r\n}\r\nstatic unsigned char mmio_nvram_read_val(int addr)\r\n{\r\nunsigned long flags;\r\nunsigned char val;\r\nif (addr >= mmio_nvram_len)\r\nreturn 0xff;\r\nspin_lock_irqsave(&mmio_nvram_lock, flags);\r\nval = ioread8(mmio_nvram_start + addr);\r\nspin_unlock_irqrestore(&mmio_nvram_lock, flags);\r\nreturn val;\r\n}\r\nstatic ssize_t mmio_nvram_write(char *buf, size_t count, loff_t *index)\r\n{\r\nunsigned long flags;\r\nif (*index >= mmio_nvram_len)\r\nreturn 0;\r\nif (*index + count > mmio_nvram_len)\r\ncount = mmio_nvram_len - *index;\r\nspin_lock_irqsave(&mmio_nvram_lock, flags);\r\nmemcpy_toio(mmio_nvram_start + *index, buf, count);\r\nspin_unlock_irqrestore(&mmio_nvram_lock, flags);\r\n*index += count;\r\nreturn count;\r\n}\r\nstatic void mmio_nvram_write_val(int addr, unsigned char val)\r\n{\r\nunsigned long flags;\r\nif (addr < mmio_nvram_len) {\r\nspin_lock_irqsave(&mmio_nvram_lock, flags);\r\niowrite8(val, mmio_nvram_start + addr);\r\nspin_unlock_irqrestore(&mmio_nvram_lock, flags);\r\n}\r\n}\r\nstatic ssize_t mmio_nvram_get_size(void)\r\n{\r\nreturn mmio_nvram_len;\r\n}\r\nint __init mmio_nvram_init(void)\r\n{\r\nstruct device_node *nvram_node;\r\nunsigned long nvram_addr;\r\nstruct resource r;\r\nint ret;\r\nnvram_node = of_find_node_by_type(NULL, "nvram");\r\nif (!nvram_node)\r\nnvram_node = of_find_compatible_node(NULL, NULL, "nvram");\r\nif (!nvram_node) {\r\nprintk(KERN_WARNING "nvram: no node found in device-tree\n");\r\nreturn -ENODEV;\r\n}\r\nret = of_address_to_resource(nvram_node, 0, &r);\r\nif (ret) {\r\nprintk(KERN_WARNING "nvram: failed to get address (err %d)\n",\r\nret);\r\ngoto out;\r\n}\r\nnvram_addr = r.start;\r\nmmio_nvram_len = resource_size(&r);\r\nif ( (!mmio_nvram_len) || (!nvram_addr) ) {\r\nprintk(KERN_WARNING "nvram: address or length is 0\n");\r\nret = -EIO;\r\ngoto out;\r\n}\r\nmmio_nvram_start = ioremap(nvram_addr, mmio_nvram_len);\r\nif (!mmio_nvram_start) {\r\nprintk(KERN_WARNING "nvram: failed to ioremap\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nprintk(KERN_INFO "mmio NVRAM, %luk at 0x%lx mapped to %p\n",\r\nmmio_nvram_len >> 10, nvram_addr, mmio_nvram_start);\r\nppc_md.nvram_read_val = mmio_nvram_read_val;\r\nppc_md.nvram_write_val = mmio_nvram_write_val;\r\nppc_md.nvram_read = mmio_nvram_read;\r\nppc_md.nvram_write = mmio_nvram_write;\r\nppc_md.nvram_size = mmio_nvram_get_size;\r\nout:\r\nof_node_put(nvram_node);\r\nreturn ret;\r\n}

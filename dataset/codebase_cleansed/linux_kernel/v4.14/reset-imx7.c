static struct imx7_src *to_imx7_src(struct reset_controller_dev *rcdev)\r\n{\r\nreturn container_of(rcdev, struct imx7_src, rcdev);\r\n}\r\nstatic int imx7_reset_set(struct reset_controller_dev *rcdev,\r\nunsigned long id, bool assert)\r\n{\r\nstruct imx7_src *imx7src = to_imx7_src(rcdev);\r\nconst struct imx7_src_signal *signal = &imx7_src_signals[id];\r\nunsigned int value = 0;\r\nswitch (id) {\r\ncase IMX7_RESET_PCIEPHY:\r\nif (!assert)\r\nudelay(10);\r\nbreak;\r\ncase IMX7_RESET_PCIE_CTRL_APPS_EN:\r\nvalue = (assert) ? 0 : signal->bit;\r\nbreak;\r\n}\r\nreturn regmap_update_bits(imx7src->regmap,\r\nsignal->offset, signal->bit, value);\r\n}\r\nstatic int imx7_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nreturn imx7_reset_set(rcdev, id, true);\r\n}\r\nstatic int imx7_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nreturn imx7_reset_set(rcdev, id, false);\r\n}\r\nstatic int imx7_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct imx7_src *imx7src;\r\nstruct device *dev = &pdev->dev;\r\nstruct regmap_config config = { .name = "src" };\r\nimx7src = devm_kzalloc(dev, sizeof(*imx7src), GFP_KERNEL);\r\nif (!imx7src)\r\nreturn -ENOMEM;\r\nimx7src->regmap = syscon_node_to_regmap(dev->of_node);\r\nif (IS_ERR(imx7src->regmap)) {\r\ndev_err(dev, "Unable to get imx7-src regmap");\r\nreturn PTR_ERR(imx7src->regmap);\r\n}\r\nregmap_attach_dev(dev, imx7src->regmap, &config);\r\nimx7src->rcdev.owner = THIS_MODULE;\r\nimx7src->rcdev.nr_resets = IMX7_RESET_NUM;\r\nimx7src->rcdev.ops = &imx7_reset_ops;\r\nimx7src->rcdev.of_node = dev->of_node;\r\nreturn devm_reset_controller_register(dev, &imx7src->rcdev);\r\n}

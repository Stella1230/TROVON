void\r\nip_vs_update_conntrack(struct sk_buff *skb, struct ip_vs_conn *cp, int outin)\r\n{\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct = nf_ct_get(skb, &ctinfo);\r\nstruct nf_conntrack_tuple new_tuple;\r\nif (ct == NULL || nf_ct_is_confirmed(ct) ||\r\nnf_ct_is_dying(ct))\r\nreturn;\r\nif (IP_VS_FWD_METHOD(cp) != IP_VS_CONN_F_MASQ)\r\nreturn;\r\nif (cp->flags & IP_VS_CONN_F_ONE_PACKET)\r\nreturn;\r\nif (CTINFO2DIR(ctinfo) != IP_CT_DIR_ORIGINAL)\r\nreturn;\r\nif (cp->app && nf_ct_protonum(ct) == IPPROTO_TCP &&\r\n!nfct_seqadj(ct) && !nfct_seqadj_ext_add(ct))\r\nreturn;\r\nnew_tuple = ct->tuplehash[IP_CT_DIR_REPLY].tuple;\r\nif (outin) {\r\nnew_tuple.src.u3 = cp->daddr;\r\nif (new_tuple.dst.protonum != IPPROTO_ICMP &&\r\nnew_tuple.dst.protonum != IPPROTO_ICMPV6)\r\nnew_tuple.src.u.tcp.port = cp->dport;\r\n} else {\r\nnew_tuple.dst.u3 = cp->vaddr;\r\nif (new_tuple.dst.protonum != IPPROTO_ICMP &&\r\nnew_tuple.dst.protonum != IPPROTO_ICMPV6)\r\nnew_tuple.dst.u.tcp.port = cp->vport;\r\n}\r\nIP_VS_DBG(7, "%s: Updating conntrack ct=%p, status=0x%lX, "\r\n"ctinfo=%d, old reply=" FMT_TUPLE\r\n", new reply=" FMT_TUPLE ", cp=" FMT_CONN "\n",\r\n__func__, ct, ct->status, ctinfo,\r\nARG_TUPLE(&ct->tuplehash[IP_CT_DIR_REPLY].tuple),\r\nARG_TUPLE(&new_tuple), ARG_CONN(cp));\r\nnf_conntrack_alter_reply(ct, &new_tuple);\r\n}\r\nint ip_vs_confirm_conntrack(struct sk_buff *skb)\r\n{\r\nreturn nf_conntrack_confirm(skb);\r\n}\r\nstatic void ip_vs_nfct_expect_callback(struct nf_conn *ct,\r\nstruct nf_conntrack_expect *exp)\r\n{\r\nstruct nf_conntrack_tuple *orig, new_reply;\r\nstruct ip_vs_conn *cp;\r\nstruct ip_vs_conn_param p;\r\nstruct net *net = nf_ct_net(ct);\r\nif (exp->tuple.src.l3num != PF_INET)\r\nreturn;\r\norig = &ct->tuplehash[IP_CT_DIR_ORIGINAL].tuple;\r\nip_vs_conn_fill_param(net_ipvs(net), exp->tuple.src.l3num, orig->dst.protonum,\r\n&orig->src.u3, orig->src.u.tcp.port,\r\n&orig->dst.u3, orig->dst.u.tcp.port, &p);\r\ncp = ip_vs_conn_out_get(&p);\r\nif (cp) {\r\nnew_reply = ct->tuplehash[IP_CT_DIR_REPLY].tuple;\r\nIP_VS_DBG(7, "%s: ct=%p, status=0x%lX, tuples=" FMT_TUPLE ", "\r\nFMT_TUPLE ", found inout cp=" FMT_CONN "\n",\r\n__func__, ct, ct->status,\r\nARG_TUPLE(orig), ARG_TUPLE(&new_reply),\r\nARG_CONN(cp));\r\nnew_reply.dst.u3 = cp->vaddr;\r\nnew_reply.dst.u.tcp.port = cp->vport;\r\nIP_VS_DBG(7, "%s: ct=%p, new tuples=" FMT_TUPLE ", " FMT_TUPLE\r\n", inout cp=" FMT_CONN "\n",\r\n__func__, ct,\r\nARG_TUPLE(orig), ARG_TUPLE(&new_reply),\r\nARG_CONN(cp));\r\ngoto alter;\r\n}\r\ncp = ip_vs_conn_in_get(&p);\r\nif (cp) {\r\nnew_reply = ct->tuplehash[IP_CT_DIR_REPLY].tuple;\r\nIP_VS_DBG(7, "%s: ct=%p, status=0x%lX, tuples=" FMT_TUPLE ", "\r\nFMT_TUPLE ", found outin cp=" FMT_CONN "\n",\r\n__func__, ct, ct->status,\r\nARG_TUPLE(orig), ARG_TUPLE(&new_reply),\r\nARG_CONN(cp));\r\nnew_reply.src.u3 = cp->daddr;\r\nnew_reply.src.u.tcp.port = cp->dport;\r\nIP_VS_DBG(7, "%s: ct=%p, new tuples=" FMT_TUPLE ", "\r\nFMT_TUPLE ", outin cp=" FMT_CONN "\n",\r\n__func__, ct,\r\nARG_TUPLE(orig), ARG_TUPLE(&new_reply),\r\nARG_CONN(cp));\r\ngoto alter;\r\n}\r\nIP_VS_DBG(7, "%s: ct=%p, status=0x%lX, tuple=" FMT_TUPLE\r\n" - unknown expect\n",\r\n__func__, ct, ct->status, ARG_TUPLE(orig));\r\nreturn;\r\nalter:\r\nif (IP_VS_FWD_METHOD(cp) == IP_VS_CONN_F_MASQ)\r\nnf_conntrack_alter_reply(ct, &new_reply);\r\nip_vs_conn_put(cp);\r\nreturn;\r\n}\r\nvoid ip_vs_nfct_expect_related(struct sk_buff *skb, struct nf_conn *ct,\r\nstruct ip_vs_conn *cp, u_int8_t proto,\r\nconst __be16 port, int from_rs)\r\n{\r\nstruct nf_conntrack_expect *exp;\r\nif (ct == NULL)\r\nreturn;\r\nexp = nf_ct_expect_alloc(ct);\r\nif (!exp)\r\nreturn;\r\nnf_ct_expect_init(exp, NF_CT_EXPECT_CLASS_DEFAULT, nf_ct_l3num(ct),\r\nfrom_rs ? &cp->daddr : &cp->caddr,\r\nfrom_rs ? &cp->caddr : &cp->vaddr,\r\nproto, port ? &port : NULL,\r\nfrom_rs ? &cp->cport : &cp->vport);\r\nexp->expectfn = ip_vs_nfct_expect_callback;\r\nIP_VS_DBG(7, "%s: ct=%p, expect tuple=" FMT_TUPLE "\n",\r\n__func__, ct, ARG_TUPLE(&exp->tuple));\r\nnf_ct_expect_related(exp);\r\nnf_ct_expect_put(exp);\r\n}\r\nvoid ip_vs_conn_drop_conntrack(struct ip_vs_conn *cp)\r\n{\r\nstruct nf_conntrack_tuple_hash *h;\r\nstruct nf_conn *ct;\r\nstruct nf_conntrack_tuple tuple;\r\nif (!cp->cport)\r\nreturn;\r\ntuple = (struct nf_conntrack_tuple) {\r\n.dst = { .protonum = cp->protocol, .dir = IP_CT_DIR_ORIGINAL } };\r\ntuple.src.u3 = cp->caddr;\r\ntuple.src.u.all = cp->cport;\r\ntuple.src.l3num = cp->af;\r\ntuple.dst.u3 = cp->vaddr;\r\ntuple.dst.u.all = cp->vport;\r\nIP_VS_DBG(7, "%s: dropping conntrack with tuple=" FMT_TUPLE\r\n" for conn " FMT_CONN "\n",\r\n__func__, ARG_TUPLE(&tuple), ARG_CONN(cp));\r\nh = nf_conntrack_find_get(cp->ipvs->net, &nf_ct_zone_dflt, &tuple);\r\nif (h) {\r\nct = nf_ct_tuplehash_to_ctrack(h);\r\nif (nf_ct_kill(ct)) {\r\nIP_VS_DBG(7, "%s: ct=%p, deleted conntrack for tuple="\r\nFMT_TUPLE "\n",\r\n__func__, ct, ARG_TUPLE(&tuple));\r\n} else {\r\nIP_VS_DBG(7, "%s: ct=%p, no conntrack timer for tuple="\r\nFMT_TUPLE "\n",\r\n__func__, ct, ARG_TUPLE(&tuple));\r\n}\r\nnf_ct_put(ct);\r\n} else {\r\nIP_VS_DBG(7, "%s: no conntrack for tuple=" FMT_TUPLE "\n",\r\n__func__, ARG_TUPLE(&tuple));\r\n}\r\n}

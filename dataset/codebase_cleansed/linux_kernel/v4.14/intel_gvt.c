static bool is_supported_device(struct drm_i915_private *dev_priv)\r\n{\r\nif (IS_BROADWELL(dev_priv))\r\nreturn true;\r\nif (IS_SKYLAKE(dev_priv))\r\nreturn true;\r\nif (IS_KABYLAKE(dev_priv))\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid intel_gvt_sanitize_options(struct drm_i915_private *dev_priv)\r\n{\r\nif (!i915.enable_gvt)\r\nreturn;\r\nif (intel_vgpu_active(dev_priv)) {\r\nDRM_INFO("GVT-g is disabled for guest\n");\r\ngoto bail;\r\n}\r\nif (!is_supported_device(dev_priv)) {\r\nDRM_INFO("Unsupported device. GVT-g is disabled\n");\r\ngoto bail;\r\n}\r\nreturn;\r\nbail:\r\ni915.enable_gvt = 0;\r\n}\r\nint intel_gvt_init(struct drm_i915_private *dev_priv)\r\n{\r\nint ret;\r\nif (!i915.enable_gvt) {\r\nDRM_DEBUG_DRIVER("GVT-g is disabled by kernel params\n");\r\nreturn 0;\r\n}\r\nif (!i915.enable_execlists) {\r\nDRM_ERROR("i915 GVT-g loading failed due to disabled execlists mode\n");\r\nreturn -EIO;\r\n}\r\nif (i915.enable_guc_submission) {\r\nDRM_ERROR("i915 GVT-g loading failed due to Graphics virtualization is not yet supported with GuC submission\n");\r\nreturn -EIO;\r\n}\r\nret = intel_gvt_init_host();\r\nif (ret) {\r\nDRM_DEBUG_DRIVER("Not in host or MPT modules not found\n");\r\ngoto bail;\r\n}\r\nret = intel_gvt_init_device(dev_priv);\r\nif (ret) {\r\nDRM_DEBUG_DRIVER("Fail to init GVT device\n");\r\ngoto bail;\r\n}\r\nreturn 0;\r\nbail:\r\ni915.enable_gvt = 0;\r\nreturn 0;\r\n}\r\nvoid intel_gvt_cleanup(struct drm_i915_private *dev_priv)\r\n{\r\nif (!intel_gvt_active(dev_priv))\r\nreturn;\r\nintel_gvt_clean_device(dev_priv);\r\n}

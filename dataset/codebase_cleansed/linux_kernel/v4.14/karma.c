static int rio_karma_send_command(char cmd, struct us_data *us)\r\n{\r\nint result;\r\nunsigned long timeout;\r\nstatic unsigned char seq = 1;\r\nstruct karma_data *data = (struct karma_data *) us->extra;\r\nusb_stor_dbg(us, "sending command %04x\n", cmd);\r\nmemset(us->iobuf, 0, RIO_SEND_LEN);\r\nmemcpy(us->iobuf, RIO_PREFIX, RIO_PREFIX_LEN);\r\nus->iobuf[5] = cmd;\r\nus->iobuf[6] = seq;\r\ntimeout = jiffies + msecs_to_jiffies(6000);\r\nfor (;;) {\r\nresult = usb_stor_bulk_transfer_buf(us, us->send_bulk_pipe,\r\nus->iobuf, RIO_SEND_LEN, NULL);\r\nif (result != USB_STOR_XFER_GOOD)\r\ngoto err;\r\nresult = usb_stor_bulk_transfer_buf(us, us->recv_bulk_pipe,\r\ndata->recv, RIO_RECV_LEN, NULL);\r\nif (result != USB_STOR_XFER_GOOD)\r\ngoto err;\r\nif (data->recv[5] == seq)\r\nbreak;\r\nif (time_after(jiffies, timeout))\r\ngoto err;\r\nus->iobuf[4] = 0x80;\r\nus->iobuf[5] = 0;\r\nmsleep(50);\r\n}\r\nseq++;\r\nif (seq == 0)\r\nseq = 1;\r\nusb_stor_dbg(us, "sent command %04x\n", cmd);\r\nreturn 0;\r\nerr:\r\nusb_stor_dbg(us, "command %04x failed\n", cmd);\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nstatic int rio_karma_transport(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nint ret;\r\nstruct karma_data *data = (struct karma_data *) us->extra;\r\nif (srb->cmnd[0] == READ_10 && !data->in_storage) {\r\nret = rio_karma_send_command(RIO_ENTER_STORAGE, us);\r\nif (ret)\r\nreturn ret;\r\ndata->in_storage = 1;\r\nreturn usb_stor_Bulk_transport(srb, us);\r\n} else if (srb->cmnd[0] == START_STOP) {\r\nret = rio_karma_send_command(RIO_LEAVE_STORAGE, us);\r\nif (ret)\r\nreturn ret;\r\ndata->in_storage = 0;\r\nreturn rio_karma_send_command(RIO_RESET, us);\r\n}\r\nreturn usb_stor_Bulk_transport(srb, us);\r\n}\r\nstatic void rio_karma_destructor(void *extra)\r\n{\r\nstruct karma_data *data = (struct karma_data *) extra;\r\nkfree(data->recv);\r\n}\r\nstatic int rio_karma_init(struct us_data *us)\r\n{\r\nint ret = 0;\r\nstruct karma_data *data = kzalloc(sizeof(struct karma_data), GFP_NOIO);\r\nif (!data)\r\ngoto out;\r\ndata->recv = kmalloc(RIO_RECV_LEN, GFP_NOIO);\r\nif (!data->recv) {\r\nkfree(data);\r\ngoto out;\r\n}\r\nus->extra = data;\r\nus->extra_destructor = rio_karma_destructor;\r\nret = rio_karma_send_command(RIO_ENTER_STORAGE, us);\r\ndata->in_storage = (ret == 0);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int karma_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct us_data *us;\r\nint result;\r\nresult = usb_stor_probe1(&us, intf, id,\r\n(id - karma_usb_ids) + karma_unusual_dev_list,\r\n&karma_host_template);\r\nif (result)\r\nreturn result;\r\nus->transport_name = "Rio Karma/Bulk";\r\nus->transport = rio_karma_transport;\r\nus->transport_reset = usb_stor_Bulk_reset;\r\nresult = usb_stor_probe2(us);\r\nreturn result;\r\n}

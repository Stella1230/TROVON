static int men_z127_debounce(struct gpio_chip *gc, unsigned gpio,\r\nunsigned debounce)\r\n{\r\nstruct men_z127_gpio *priv = gpiochip_get_data(gc);\r\nstruct device *dev = gc->parent;\r\nunsigned int rnd;\r\nu32 db_en, db_cnt;\r\nif (!MEN_Z127_DB_IN_RANGE(debounce)) {\r\ndev_err(dev, "debounce value %u out of range", debounce);\r\nreturn -EINVAL;\r\n}\r\nif (debounce > 0) {\r\nrnd = fls(debounce) - 1;\r\nif (rnd && (debounce & BIT(rnd - 1)))\r\ndebounce = round_up(debounce, MEN_Z127_DB_MIN_US);\r\nelse\r\ndebounce = round_down(debounce, MEN_Z127_DB_MIN_US);\r\nif (debounce > MEN_Z127_DB_MAX_US)\r\ndebounce = MEN_Z127_DB_MAX_US;\r\ndebounce /= 50;\r\n}\r\nspin_lock(&gc->bgpio_lock);\r\ndb_en = readl(priv->reg_base + MEN_Z127_DBER);\r\nif (debounce == 0) {\r\ndb_en &= ~BIT(gpio);\r\ndb_cnt = 0;\r\n} else {\r\ndb_en |= BIT(gpio);\r\ndb_cnt = debounce;\r\n}\r\nwritel(db_en, priv->reg_base + MEN_Z127_DBER);\r\nwritel(db_cnt, priv->reg_base + GPIO_TO_DBCNT_REG(gpio));\r\nspin_unlock(&gc->bgpio_lock);\r\nreturn 0;\r\n}\r\nstatic int men_z127_set_single_ended(struct gpio_chip *gc,\r\nunsigned offset,\r\nenum pin_config_param param)\r\n{\r\nstruct men_z127_gpio *priv = gpiochip_get_data(gc);\r\nu32 od_en;\r\nspin_lock(&gc->bgpio_lock);\r\nod_en = readl(priv->reg_base + MEN_Z127_ODER);\r\nif (param == PIN_CONFIG_DRIVE_OPEN_DRAIN)\r\nod_en |= BIT(offset);\r\nelse\r\nod_en &= ~BIT(offset);\r\nwritel(od_en, priv->reg_base + MEN_Z127_ODER);\r\nspin_unlock(&gc->bgpio_lock);\r\nreturn 0;\r\n}\r\nstatic int men_z127_set_config(struct gpio_chip *gc, unsigned offset,\r\nunsigned long config)\r\n{\r\nenum pin_config_param param = pinconf_to_config_param(config);\r\nswitch (param) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nreturn men_z127_set_single_ended(gc, offset, param);\r\ncase PIN_CONFIG_INPUT_DEBOUNCE:\r\nreturn men_z127_debounce(gc, offset,\r\npinconf_to_config_argument(config));\r\ndefault:\r\nbreak;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int men_z127_probe(struct mcb_device *mdev,\r\nconst struct mcb_device_id *id)\r\n{\r\nstruct men_z127_gpio *men_z127_gpio;\r\nstruct device *dev = &mdev->dev;\r\nint ret;\r\nmen_z127_gpio = devm_kzalloc(dev, sizeof(struct men_z127_gpio),\r\nGFP_KERNEL);\r\nif (!men_z127_gpio)\r\nreturn -ENOMEM;\r\nmen_z127_gpio->mem = mcb_request_mem(mdev, dev_name(dev));\r\nif (IS_ERR(men_z127_gpio->mem)) {\r\ndev_err(dev, "failed to request device memory");\r\nreturn PTR_ERR(men_z127_gpio->mem);\r\n}\r\nmen_z127_gpio->reg_base = ioremap(men_z127_gpio->mem->start,\r\nresource_size(men_z127_gpio->mem));\r\nif (men_z127_gpio->reg_base == NULL) {\r\nret = -ENXIO;\r\ngoto err_release;\r\n}\r\nmcb_set_drvdata(mdev, men_z127_gpio);\r\nret = bgpio_init(&men_z127_gpio->gc, &mdev->dev, 4,\r\nmen_z127_gpio->reg_base + MEN_Z127_PSR,\r\nmen_z127_gpio->reg_base + MEN_Z127_CTRL,\r\nNULL,\r\nmen_z127_gpio->reg_base + MEN_Z127_GPIODR,\r\nNULL, 0);\r\nif (ret)\r\ngoto err_unmap;\r\nmen_z127_gpio->gc.set_config = men_z127_set_config;\r\nret = gpiochip_add_data(&men_z127_gpio->gc, men_z127_gpio);\r\nif (ret) {\r\ndev_err(dev, "failed to register MEN 16Z127 GPIO controller");\r\ngoto err_unmap;\r\n}\r\ndev_info(dev, "MEN 16Z127 GPIO driver registered");\r\nreturn 0;\r\nerr_unmap:\r\niounmap(men_z127_gpio->reg_base);\r\nerr_release:\r\nmcb_release_mem(men_z127_gpio->mem);\r\nreturn ret;\r\n}\r\nstatic void men_z127_remove(struct mcb_device *mdev)\r\n{\r\nstruct men_z127_gpio *men_z127_gpio = mcb_get_drvdata(mdev);\r\ngpiochip_remove(&men_z127_gpio->gc);\r\niounmap(men_z127_gpio->reg_base);\r\nmcb_release_mem(men_z127_gpio->mem);\r\n}

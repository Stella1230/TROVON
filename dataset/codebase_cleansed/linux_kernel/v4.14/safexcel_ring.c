int safexcel_init_ring_descriptors(struct safexcel_crypto_priv *priv,\r\nstruct safexcel_ring *cdr,\r\nstruct safexcel_ring *rdr)\r\n{\r\ncdr->offset = sizeof(u32) * priv->config.cd_offset;\r\ncdr->base = dmam_alloc_coherent(priv->dev,\r\ncdr->offset * EIP197_DEFAULT_RING_SIZE,\r\n&cdr->base_dma, GFP_KERNEL);\r\nif (!cdr->base)\r\nreturn -ENOMEM;\r\ncdr->write = cdr->base;\r\ncdr->base_end = cdr->base + cdr->offset * EIP197_DEFAULT_RING_SIZE;\r\ncdr->read = cdr->base;\r\nrdr->offset = sizeof(u32) * priv->config.rd_offset;\r\nrdr->base = dmam_alloc_coherent(priv->dev,\r\nrdr->offset * EIP197_DEFAULT_RING_SIZE,\r\n&rdr->base_dma, GFP_KERNEL);\r\nif (!rdr->base)\r\nreturn -ENOMEM;\r\nrdr->write = rdr->base;\r\nrdr->base_end = rdr->base + rdr->offset * EIP197_DEFAULT_RING_SIZE;\r\nrdr->read = rdr->base;\r\nreturn 0;\r\n}\r\ninline int safexcel_select_ring(struct safexcel_crypto_priv *priv)\r\n{\r\nreturn (atomic_inc_return(&priv->ring_used) % priv->config.rings);\r\n}\r\nstatic void *safexcel_ring_next_wptr(struct safexcel_crypto_priv *priv,\r\nstruct safexcel_ring *ring)\r\n{\r\nvoid *ptr = ring->write;\r\nif (ring->nr == EIP197_DEFAULT_RING_SIZE - 1)\r\nreturn ERR_PTR(-ENOMEM);\r\nring->write += ring->offset;\r\nif (ring->write == ring->base_end)\r\nring->write = ring->base;\r\nring->nr++;\r\nreturn ptr;\r\n}\r\nvoid *safexcel_ring_next_rptr(struct safexcel_crypto_priv *priv,\r\nstruct safexcel_ring *ring)\r\n{\r\nvoid *ptr = ring->read;\r\nif (!ring->nr)\r\nreturn ERR_PTR(-ENOENT);\r\nring->read += ring->offset;\r\nif (ring->read == ring->base_end)\r\nring->read = ring->base;\r\nring->nr--;\r\nreturn ptr;\r\n}\r\nvoid safexcel_ring_rollback_wptr(struct safexcel_crypto_priv *priv,\r\nstruct safexcel_ring *ring)\r\n{\r\nif (!ring->nr)\r\nreturn;\r\nif (ring->write == ring->base)\r\nring->write = ring->base_end - ring->offset;\r\nelse\r\nring->write -= ring->offset;\r\nring->nr--;\r\n}\r\nstruct safexcel_command_desc *safexcel_add_cdesc(struct safexcel_crypto_priv *priv,\r\nint ring_id,\r\nbool first, bool last,\r\ndma_addr_t data, u32 data_len,\r\nu32 full_data_len,\r\ndma_addr_t context) {\r\nstruct safexcel_command_desc *cdesc;\r\nint i;\r\ncdesc = safexcel_ring_next_wptr(priv, &priv->ring[ring_id].cdr);\r\nif (IS_ERR(cdesc))\r\nreturn cdesc;\r\nmemset(cdesc, 0, sizeof(struct safexcel_command_desc));\r\ncdesc->first_seg = first;\r\ncdesc->last_seg = last;\r\ncdesc->particle_size = data_len;\r\ncdesc->data_lo = lower_32_bits(data);\r\ncdesc->data_hi = upper_32_bits(data);\r\nif (first && context) {\r\nstruct safexcel_token *token =\r\n(struct safexcel_token *)cdesc->control_data.token;\r\ncdesc->control_data.packet_length = full_data_len;\r\ncdesc->control_data.options = EIP197_OPTION_MAGIC_VALUE |\r\nEIP197_OPTION_64BIT_CTX |\r\nEIP197_OPTION_CTX_CTRL_IN_CMD;\r\ncdesc->control_data.context_lo =\r\n(lower_32_bits(context) & GENMASK(31, 2)) >> 2;\r\ncdesc->control_data.context_hi = upper_32_bits(context);\r\ncdesc->control_data.refresh = 2;\r\nfor (i = 0; i < EIP197_MAX_TOKENS; i++)\r\neip197_noop_token(&token[i]);\r\n}\r\nreturn cdesc;\r\n}\r\nstruct safexcel_result_desc *safexcel_add_rdesc(struct safexcel_crypto_priv *priv,\r\nint ring_id,\r\nbool first, bool last,\r\ndma_addr_t data, u32 len)\r\n{\r\nstruct safexcel_result_desc *rdesc;\r\nrdesc = safexcel_ring_next_wptr(priv, &priv->ring[ring_id].rdr);\r\nif (IS_ERR(rdesc))\r\nreturn rdesc;\r\nmemset(rdesc, 0, sizeof(struct safexcel_result_desc));\r\nrdesc->first_seg = first;\r\nrdesc->last_seg = last;\r\nrdesc->particle_size = len;\r\nrdesc->data_lo = lower_32_bits(data);\r\nrdesc->data_hi = upper_32_bits(data);\r\nreturn rdesc;\r\n}

static unsigned int debugifc_count_whitespace(const char *buf,\r\nunsigned int count)\r\n{\r\nunsigned int scnt;\r\nchar ch;\r\nfor (scnt = 0; scnt < count; scnt++) {\r\nch = buf[scnt];\r\nif (ch == ' ') continue;\r\nif (ch == '\t') continue;\r\nif (ch == '\n') continue;\r\nbreak;\r\n}\r\nreturn scnt;\r\n}\r\nstatic unsigned int debugifc_count_nonwhitespace(const char *buf,\r\nunsigned int count)\r\n{\r\nunsigned int scnt;\r\nchar ch;\r\nfor (scnt = 0; scnt < count; scnt++) {\r\nch = buf[scnt];\r\nif (ch == ' ') break;\r\nif (ch == '\t') break;\r\nif (ch == '\n') break;\r\n}\r\nreturn scnt;\r\n}\r\nstatic unsigned int debugifc_isolate_word(const char *buf,unsigned int count,\r\nconst char **wstrPtr,\r\nunsigned int *wlenPtr)\r\n{\r\nconst char *wptr;\r\nunsigned int consume_cnt = 0;\r\nunsigned int wlen;\r\nunsigned int scnt;\r\nwptr = NULL;\r\nwlen = 0;\r\nscnt = debugifc_count_whitespace(buf,count);\r\nconsume_cnt += scnt; count -= scnt; buf += scnt;\r\nif (!count) goto done;\r\nscnt = debugifc_count_nonwhitespace(buf,count);\r\nif (!scnt) goto done;\r\nwptr = buf;\r\nwlen = scnt;\r\nconsume_cnt += scnt; count -= scnt; buf += scnt;\r\ndone:\r\n*wstrPtr = wptr;\r\n*wlenPtr = wlen;\r\nreturn consume_cnt;\r\n}\r\nstatic int debugifc_parse_unsigned_number(const char *buf,unsigned int count,\r\nu32 *num_ptr)\r\n{\r\nu32 result = 0;\r\nint radix = 10;\r\nif ((count >= 2) && (buf[0] == '0') &&\r\n((buf[1] == 'x') || (buf[1] == 'X'))) {\r\nradix = 16;\r\ncount -= 2;\r\nbuf += 2;\r\n} else if ((count >= 1) && (buf[0] == '0')) {\r\nradix = 8;\r\n}\r\nwhile (count--) {\r\nint val = hex_to_bin(*buf++);\r\nif (val < 0 || val >= radix)\r\nreturn -EINVAL;\r\nresult *= radix;\r\nresult += val;\r\n}\r\n*num_ptr = result;\r\nreturn 0;\r\n}\r\nstatic int debugifc_match_keyword(const char *buf,unsigned int count,\r\nconst char *keyword)\r\n{\r\nunsigned int kl;\r\nif (!keyword) return 0;\r\nkl = strlen(keyword);\r\nif (kl != count) return 0;\r\nreturn !memcmp(buf,keyword,kl);\r\n}\r\nint pvr2_debugifc_print_info(struct pvr2_hdw *hdw,char *buf,unsigned int acnt)\r\n{\r\nint bcnt = 0;\r\nint ccnt;\r\nccnt = scnprintf(buf, acnt, "Driver hardware description: %s\n",\r\npvr2_hdw_get_desc(hdw));\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\nccnt = scnprintf(buf,acnt,"Driver state info:\n");\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\nccnt = pvr2_hdw_state_report(hdw,buf,acnt);\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\nreturn bcnt;\r\n}\r\nint pvr2_debugifc_print_status(struct pvr2_hdw *hdw,\r\nchar *buf,unsigned int acnt)\r\n{\r\nint bcnt = 0;\r\nint ccnt;\r\nint ret;\r\nu32 gpio_dir,gpio_in,gpio_out;\r\nstruct pvr2_stream_stats stats;\r\nstruct pvr2_stream *sp;\r\nret = pvr2_hdw_is_hsm(hdw);\r\nccnt = scnprintf(buf,acnt,"USB link speed: %s\n",\r\n(ret < 0 ? "FAIL" : (ret ? "high" : "full")));\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\ngpio_dir = 0; gpio_in = 0; gpio_out = 0;\r\npvr2_hdw_gpio_get_dir(hdw,&gpio_dir);\r\npvr2_hdw_gpio_get_out(hdw,&gpio_out);\r\npvr2_hdw_gpio_get_in(hdw,&gpio_in);\r\nccnt = scnprintf(buf,acnt,"GPIO state: dir=0x%x in=0x%x out=0x%x\n",\r\ngpio_dir,gpio_in,gpio_out);\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\nccnt = scnprintf(buf,acnt,"Streaming is %s\n",\r\npvr2_hdw_get_streaming(hdw) ? "on" : "off");\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\nsp = pvr2_hdw_get_video_stream(hdw);\r\nif (sp) {\r\npvr2_stream_get_stats(sp, &stats, 0);\r\nccnt = scnprintf(\r\nbuf,acnt,\r\n"Bytes streamed=%u URBs: queued=%u idle=%u ready=%u processed=%u failed=%u\n",\r\nstats.bytes_processed,\r\nstats.buffers_in_queue,\r\nstats.buffers_in_idle,\r\nstats.buffers_in_ready,\r\nstats.buffers_processed,\r\nstats.buffers_failed);\r\nbcnt += ccnt; acnt -= ccnt; buf += ccnt;\r\n}\r\nreturn bcnt;\r\n}\r\nstatic int pvr2_debugifc_do1cmd(struct pvr2_hdw *hdw,const char *buf,\r\nunsigned int count)\r\n{\r\nconst char *wptr;\r\nunsigned int wlen;\r\nunsigned int scnt;\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (!scnt) return 0;\r\ncount -= scnt; buf += scnt;\r\nif (!wptr) return 0;\r\npvr2_trace(PVR2_TRACE_DEBUGIFC,"debugifc cmd: \"%.*s\"",wlen,wptr);\r\nif (debugifc_match_keyword(wptr,wlen,"reset")) {\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (!scnt) return -EINVAL;\r\ncount -= scnt; buf += scnt;\r\nif (!wptr) return -EINVAL;\r\nif (debugifc_match_keyword(wptr,wlen,"cpu")) {\r\npvr2_hdw_cpureset_assert(hdw,!0);\r\npvr2_hdw_cpureset_assert(hdw,0);\r\nreturn 0;\r\n} else if (debugifc_match_keyword(wptr,wlen,"bus")) {\r\npvr2_hdw_device_reset(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"soft")) {\r\nreturn pvr2_hdw_cmd_powerup(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"deep")) {\r\nreturn pvr2_hdw_cmd_deep_reset(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"firmware")) {\r\nreturn pvr2_upload_firmware2(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"decoder")) {\r\nreturn pvr2_hdw_cmd_decoder_reset(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"worker")) {\r\nreturn pvr2_hdw_untrip(hdw);\r\n} else if (debugifc_match_keyword(wptr,wlen,"usbstats")) {\r\npvr2_stream_get_stats(pvr2_hdw_get_video_stream(hdw),\r\nNULL, !0);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n} else if (debugifc_match_keyword(wptr,wlen,"cpufw")) {\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (!scnt) return -EINVAL;\r\ncount -= scnt; buf += scnt;\r\nif (!wptr) return -EINVAL;\r\nif (debugifc_match_keyword(wptr,wlen,"fetch")) {\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (scnt && wptr) {\r\ncount -= scnt; buf += scnt;\r\nif (debugifc_match_keyword(wptr, wlen,\r\n"prom")) {\r\npvr2_hdw_cpufw_set_enabled(hdw, 2, !0);\r\n} else if (debugifc_match_keyword(wptr, wlen,\r\n"ram8k")) {\r\npvr2_hdw_cpufw_set_enabled(hdw, 0, !0);\r\n} else if (debugifc_match_keyword(wptr, wlen,\r\n"ram16k")) {\r\npvr2_hdw_cpufw_set_enabled(hdw, 1, !0);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\npvr2_hdw_cpufw_set_enabled(hdw,0,!0);\r\nreturn 0;\r\n} else if (debugifc_match_keyword(wptr,wlen,"done")) {\r\npvr2_hdw_cpufw_set_enabled(hdw,0,0);\r\nreturn 0;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n} else if (debugifc_match_keyword(wptr,wlen,"gpio")) {\r\nint dir_fl = 0;\r\nint ret;\r\nu32 msk,val;\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (!scnt) return -EINVAL;\r\ncount -= scnt; buf += scnt;\r\nif (!wptr) return -EINVAL;\r\nif (debugifc_match_keyword(wptr,wlen,"dir")) {\r\ndir_fl = !0;\r\n} else if (!debugifc_match_keyword(wptr,wlen,"out")) {\r\nreturn -EINVAL;\r\n}\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (!scnt) return -EINVAL;\r\ncount -= scnt; buf += scnt;\r\nif (!wptr) return -EINVAL;\r\nret = debugifc_parse_unsigned_number(wptr,wlen,&msk);\r\nif (ret) return ret;\r\nscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\r\nif (wptr) {\r\nret = debugifc_parse_unsigned_number(wptr,wlen,&val);\r\nif (ret) return ret;\r\n} else {\r\nval = msk;\r\nmsk = 0xffffffff;\r\n}\r\nif (dir_fl) {\r\nret = pvr2_hdw_gpio_chg_dir(hdw,msk,val);\r\n} else {\r\nret = pvr2_hdw_gpio_chg_out(hdw,msk,val);\r\n}\r\nreturn ret;\r\n}\r\npvr2_trace(PVR2_TRACE_DEBUGIFC,\r\n"debugifc failed to recognize cmd: \"%.*s\"",wlen,wptr);\r\nreturn -EINVAL;\r\n}\r\nint pvr2_debugifc_docmd(struct pvr2_hdw *hdw,const char *buf,\r\nunsigned int count)\r\n{\r\nunsigned int bcnt = 0;\r\nint ret;\r\nwhile (count) {\r\nfor (bcnt = 0; bcnt < count; bcnt++) {\r\nif (buf[bcnt] == '\n') break;\r\n}\r\nret = pvr2_debugifc_do1cmd(hdw,buf,bcnt);\r\nif (ret < 0) return ret;\r\nif (bcnt < count) bcnt++;\r\nbuf += bcnt;\r\ncount -= bcnt;\r\n}\r\nreturn 0;\r\n}

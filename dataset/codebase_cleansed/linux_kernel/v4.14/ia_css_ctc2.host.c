static int ctc2_slope(int y1, int y0, int x1, int x0)\r\n{\r\nconst int shift_val = 8;\r\nconst int max_slope = (1 << IA_CSS_CTC_COEF_SHIFT) - 1;\r\nint dy = y1 - y0;\r\nint dx = x1 - x0;\r\nint rounding = (dx + 1) >> 1;\r\nint dy_shift = dy << shift_val;\r\nint slope, dydx;\r\nassert(y0 >= 0 && y0 <= max_slope);\r\nassert(y1 >= 0 && y1 <= max_slope);\r\nassert(x0 >= 0 && x0 <= max_slope);\r\nassert(x1 > 0 && x1 <= max_slope);\r\nassert(dx > 0);\r\nif (dy < 0)\r\nrounding = -rounding;\r\nslope = (int) (dy_shift + rounding) / dx;\r\nif (slope <= -max_slope-1) {\r\ndydx = -max_slope-1;\r\n} else if (slope >= max_slope) {\r\ndydx = max_slope;\r\n} else {\r\ndydx = slope;\r\n}\r\nreturn dydx;\r\n}\r\nvoid ia_css_ctc2_vmem_encode(struct ia_css_isp_ctc2_vmem_params *to,\r\nconst struct ia_css_ctc2_config *from,\r\nsize_t size)\r\n{\r\nunsigned i, j;\r\nconst unsigned shffl_blck = 4;\r\nconst unsigned lenght_zeros = 11;\r\nshort dydx0, dydx1, dydx2, dydx3, dydx4;\r\n(void)size;\r\ndydx0 = ctc2_slope(from->y_y1, from->y_y0,\r\nfrom->y_x1, 0);\r\ndydx1 = ctc2_slope(from->y_y2, from->y_y1,\r\nfrom->y_x2, from->y_x1);\r\ndydx2 = ctc2_slope(from->y_y3, from->y_y2,\r\nfrom->y_x3, from->y_x2);\r\ndydx3 = ctc2_slope(from->y_y4, from->y_y3,\r\nfrom->y_x4, from->y_x3);\r\ndydx4 = ctc2_slope(from->y_y5, from->y_y4,\r\nSH_CSS_BAYER_MAXVAL, from->y_x4);\r\nfor (i = 0; i < shffl_blck; i++) {\r\nto->y_x[0][(i << shffl_blck)] = 0;\r\nto->y_x[0][(i << shffl_blck) + 1] = from->y_x1;\r\nto->y_x[0][(i << shffl_blck) + 2] = from->y_x2;\r\nto->y_x[0][(i << shffl_blck) + 3] = from->y_x3;\r\nto->y_x[0][(i << shffl_blck) + 4] = from->y_x4;\r\nto->y_y[0][(i << shffl_blck)] = from->y_y0;\r\nto->y_y[0][(i << shffl_blck) + 1] = from->y_y1;\r\nto->y_y[0][(i << shffl_blck) + 2] = from->y_y2;\r\nto->y_y[0][(i << shffl_blck) + 3] = from->y_y3;\r\nto->y_y[0][(i << shffl_blck) + 4] = from->y_y4;\r\nto->e_y_slope[0][(i << shffl_blck)] = dydx0;\r\nto->e_y_slope[0][(i << shffl_blck) + 1] = dydx1;\r\nto->e_y_slope[0][(i << shffl_blck) + 2] = dydx2;\r\nto->e_y_slope[0][(i << shffl_blck) + 3] = dydx3;\r\nto->e_y_slope[0][(i << shffl_blck) + 4] = dydx4;\r\nfor (j = 0; j < lenght_zeros; j++) {\r\nto->y_x[0][(i << shffl_blck) + 5 + j] = 0;\r\nto->y_y[0][(i << shffl_blck) + 5 + j] = 0;\r\nto->e_y_slope[0][(i << shffl_blck)+ 5 + j] = 0;\r\n}\r\n}\r\n}\r\nvoid ia_css_ctc2_encode(struct ia_css_isp_ctc2_dmem_params *to,\r\nstruct ia_css_ctc2_config *from,\r\nsize_t size)\r\n{\r\n(void)size;\r\nto->uv_y0 = from->uv_y0;\r\nto->uv_y1 = from->uv_y1;\r\nto->uv_x0 = from->uv_x0;\r\nto->uv_x1 = from->uv_x1;\r\nto->uv_dydx = ctc2_slope(from->uv_y1, from->uv_y0,\r\nfrom->uv_x1, from->uv_x0);\r\n}

static void usage(char *pname)\r\n{\r\nprintf("USAGE:\n %s [-l] <cg-path> <prog filename>\n", pname);\r\nprintf("\tLoad and attach a sock_ops program to the specified "\r\n"cgroup\n");\r\nprintf("\tIf \"-l\" is used, the program will continue to run\n");\r\nprintf("\tprinting the BPF log buffer\n");\r\nprintf("\tIf the specified filename does not end in \".o\", it\n");\r\nprintf("\tappends \"_kern.o\" to the name\n");\r\nprintf("\n");\r\nprintf(" %s -r <cg-path>\n", pname);\r\nprintf("\tDetaches the currently attached sock_ops program\n");\r\nprintf("\tfrom the specified cgroup\n");\r\nprintf("\n");\r\nexit(1);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint logFlag = 0;\r\nint error = 0;\r\nchar *cg_path;\r\nchar fn[500];\r\nchar *prog;\r\nint cg_fd;\r\nif (argc < 3)\r\nusage(argv[0]);\r\nif (!strcmp(argv[1], "-r")) {\r\ncg_path = argv[2];\r\ncg_fd = open(cg_path, O_DIRECTORY, O_RDONLY);\r\nerror = bpf_prog_detach(cg_fd, BPF_CGROUP_SOCK_OPS);\r\nif (error) {\r\nprintf("ERROR: bpf_prog_detach: %d (%s)\n",\r\nerror, strerror(errno));\r\nreturn 2;\r\n}\r\nreturn 0;\r\n} else if (!strcmp(argv[1], "-h")) {\r\nusage(argv[0]);\r\n} else if (!strcmp(argv[1], "-l")) {\r\nlogFlag = 1;\r\nif (argc < 4)\r\nusage(argv[0]);\r\n}\r\nprog = argv[argc - 1];\r\ncg_path = argv[argc - 2];\r\nif (strlen(prog) > 480) {\r\nfprintf(stderr, "ERROR: program name too long (> 480 chars)\n");\r\nreturn 3;\r\n}\r\ncg_fd = open(cg_path, O_DIRECTORY, O_RDONLY);\r\nif (!strcmp(prog + strlen(prog)-2, ".o"))\r\nstrcpy(fn, prog);\r\nelse\r\nsprintf(fn, "%s_kern.o", prog);\r\nif (logFlag)\r\nprintf("loading bpf file:%s\n", fn);\r\nif (load_bpf_file(fn)) {\r\nprintf("ERROR: load_bpf_file failed for: %s\n", fn);\r\nprintf("%s", bpf_log_buf);\r\nreturn 4;\r\n}\r\nif (logFlag)\r\nprintf("TCP BPF Loaded %s\n", fn);\r\nerror = bpf_prog_attach(prog_fd[0], cg_fd, BPF_CGROUP_SOCK_OPS, 0);\r\nif (error) {\r\nprintf("ERROR: bpf_prog_attach: %d (%s)\n",\r\nerror, strerror(errno));\r\nreturn 5;\r\n} else if (logFlag) {\r\nread_trace_pipe();\r\n}\r\nreturn error;\r\n}

static void sdhci_probe_config_dt(struct device_node *np,\r\nstruct spear_sdhci *host)\r\n{\r\nint cd_gpio;\r\ncd_gpio = of_get_named_gpio(np, "cd-gpios", 0);\r\nif (!gpio_is_valid(cd_gpio))\r\ncd_gpio = -1;\r\nhost->card_int_gpio = cd_gpio;\r\n}\r\nstatic int sdhci_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct resource *iomem;\r\nstruct spear_sdhci *sdhci;\r\nstruct device *dev;\r\nint ret;\r\ndev = pdev->dev.parent ? pdev->dev.parent : &pdev->dev;\r\nhost = sdhci_alloc_host(dev, sizeof(*sdhci));\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ndev_dbg(&pdev->dev, "cannot allocate memory for sdhci\n");\r\ngoto err;\r\n}\r\niomem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhost->ioaddr = devm_ioremap_resource(&pdev->dev, iomem);\r\nif (IS_ERR(host->ioaddr)) {\r\nret = PTR_ERR(host->ioaddr);\r\ndev_dbg(&pdev->dev, "unable to map iomem: %d\n", ret);\r\ngoto err_host;\r\n}\r\nhost->hw_name = "sdhci";\r\nhost->ops = &sdhci_pltfm_ops;\r\nhost->irq = platform_get_irq(pdev, 0);\r\nhost->quirks = SDHCI_QUIRK_BROKEN_ADMA;\r\nsdhci = sdhci_priv(host);\r\nsdhci->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sdhci->clk)) {\r\nret = PTR_ERR(sdhci->clk);\r\ndev_dbg(&pdev->dev, "Error getting clock\n");\r\ngoto err_host;\r\n}\r\nret = clk_prepare_enable(sdhci->clk);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "Error enabling clock\n");\r\ngoto err_host;\r\n}\r\nret = clk_set_rate(sdhci->clk, 50000000);\r\nif (ret)\r\ndev_dbg(&pdev->dev, "Error setting desired clk, clk=%lu\n",\r\nclk_get_rate(sdhci->clk));\r\nsdhci_probe_config_dt(pdev->dev.of_node, sdhci);\r\nif (sdhci->card_int_gpio >= 0) {\r\nret = mmc_gpio_request_cd(host->mmc, sdhci->card_int_gpio, 0);\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev,\r\n"failed to request card-detect gpio%d\n",\r\nsdhci->card_int_gpio);\r\ngoto disable_clk;\r\n}\r\n}\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "error adding host\n");\r\ngoto disable_clk;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nreturn 0;\r\ndisable_clk:\r\nclk_disable_unprepare(sdhci->clk);\r\nerr_host:\r\nsdhci_free_host(host);\r\nerr:\r\ndev_err(&pdev->dev, "spear-sdhci probe failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int sdhci_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct spear_sdhci *sdhci = sdhci_priv(host);\r\nint dead = 0;\r\nu32 scratch;\r\nscratch = readl(host->ioaddr + SDHCI_INT_STATUS);\r\nif (scratch == (u32)-1)\r\ndead = 1;\r\nsdhci_remove_host(host, dead);\r\nclk_disable_unprepare(sdhci->clk);\r\nsdhci_free_host(host);\r\nreturn 0;\r\n}\r\nstatic int sdhci_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct spear_sdhci *sdhci = sdhci_priv(host);\r\nint ret;\r\nif (host->tuning_mode != SDHCI_TUNING_MODE_3)\r\nmmc_retune_needed(host->mmc);\r\nret = sdhci_suspend_host(host);\r\nif (!ret)\r\nclk_disable(sdhci->clk);\r\nreturn ret;\r\n}\r\nstatic int sdhci_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct spear_sdhci *sdhci = sdhci_priv(host);\r\nint ret;\r\nret = clk_enable(sdhci->clk);\r\nif (ret) {\r\ndev_dbg(dev, "Resume: Error enabling clock\n");\r\nreturn ret;\r\n}\r\nreturn sdhci_resume_host(host);\r\n}

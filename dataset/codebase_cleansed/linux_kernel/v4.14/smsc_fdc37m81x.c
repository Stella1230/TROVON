static inline unsigned char smsc_fdc37m81x_rd(unsigned char index)\r\n{\r\noutb(index, g_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_INDEX);\r\nreturn inb(g_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_DATA);\r\n}\r\nstatic inline void smsc_dc37m81x_wr(unsigned char index, unsigned char data)\r\n{\r\noutb(index, g_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_INDEX);\r\noutb(data, g_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_DATA);\r\n}\r\nvoid smsc_fdc37m81x_config_beg(void)\r\n{\r\nif (g_smsc_fdc37m81x_base) {\r\noutb(SMSC_FDC37M81X_CONFIG_ENTER,\r\ng_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_INDEX);\r\n}\r\n}\r\nvoid smsc_fdc37m81x_config_end(void)\r\n{\r\nif (g_smsc_fdc37m81x_base)\r\noutb(SMSC_FDC37M81X_CONFIG_EXIT,\r\ng_smsc_fdc37m81x_base + SMSC_FDC37M81X_CONFIG_INDEX);\r\n}\r\nu8 smsc_fdc37m81x_config_get(u8 reg)\r\n{\r\nu8 val = 0;\r\nif (g_smsc_fdc37m81x_base)\r\nval = smsc_fdc37m81x_rd(reg);\r\nreturn val;\r\n}\r\nvoid smsc_fdc37m81x_config_set(u8 reg, u8 val)\r\n{\r\nif (g_smsc_fdc37m81x_base)\r\nsmsc_dc37m81x_wr(reg, val);\r\n}\r\nunsigned long __init smsc_fdc37m81x_init(unsigned long port)\r\n{\r\nconst int field = sizeof(unsigned long) * 2;\r\nu8 chip_id;\r\nif (g_smsc_fdc37m81x_base)\r\npr_warn("%s: stepping on old base=0x%0*lx\n", __func__, field,\r\ng_smsc_fdc37m81x_base);\r\ng_smsc_fdc37m81x_base = port;\r\nsmsc_fdc37m81x_config_beg();\r\nchip_id = smsc_fdc37m81x_rd(SMSC_FDC37M81X_DID);\r\nif (chip_id == SMSC_FDC37M81X_CHIP_ID)\r\nsmsc_fdc37m81x_config_end();\r\nelse {\r\npr_warn("%s: unknown chip id 0x%02x\n", __func__, chip_id);\r\ng_smsc_fdc37m81x_base = 0;\r\n}\r\nreturn g_smsc_fdc37m81x_base;\r\n}\r\nstatic void smsc_fdc37m81x_config_dump_one(const char *key, u8 dev, u8 reg)\r\n{\r\npr_info("%s: dev=0x%02x reg=0x%02x val=0x%02x\n", key, dev, reg,\r\nsmsc_fdc37m81x_rd(reg));\r\n}\r\nvoid smsc_fdc37m81x_config_dump(void)\r\n{\r\nu8 orig;\r\nconst char *fname = __func__;\r\nsmsc_fdc37m81x_config_beg();\r\norig = smsc_fdc37m81x_rd(SMSC_FDC37M81X_DNUM);\r\npr_info("%s: common\n", fname);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_NONE,\r\nSMSC_FDC37M81X_DNUM);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_NONE,\r\nSMSC_FDC37M81X_DID);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_NONE,\r\nSMSC_FDC37M81X_DREV);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_NONE,\r\nSMSC_FDC37M81X_PCNT);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_NONE,\r\nSMSC_FDC37M81X_PMGT);\r\npr_info("%s: keyboard\n", fname);\r\nsmsc_dc37m81x_wr(SMSC_FDC37M81X_DNUM, SMSC_FDC37M81X_KBD);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_KBD,\r\nSMSC_FDC37M81X_ACTIVE);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_KBD,\r\nSMSC_FDC37M81X_INT);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_KBD,\r\nSMSC_FDC37M81X_INT2);\r\nsmsc_fdc37m81x_config_dump_one(fname, SMSC_FDC37M81X_KBD,\r\nSMSC_FDC37M81X_LDCR_F0);\r\nsmsc_dc37m81x_wr(SMSC_FDC37M81X_DNUM, orig);\r\nsmsc_fdc37m81x_config_end();\r\n}

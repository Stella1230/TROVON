void\r\nia_css_s3a_configure(unsigned int raw_bit_depth)\r\n{\r\ns3a_raw_bit_depth = raw_bit_depth;\r\n}\r\nstatic void\r\nia_css_ae_encode(\r\nstruct sh_css_isp_ae_params *to,\r\nconst struct ia_css_3a_config *from,\r\nunsigned size)\r\n{\r\n(void)size;\r\nto->y_coef_r =\r\nuDIGIT_FITTING(from->ae_y_coef_r, 16, SH_CSS_AE_YCOEF_SHIFT);\r\nto->y_coef_g =\r\nuDIGIT_FITTING(from->ae_y_coef_g, 16, SH_CSS_AE_YCOEF_SHIFT);\r\nto->y_coef_b =\r\nuDIGIT_FITTING(from->ae_y_coef_b, 16, SH_CSS_AE_YCOEF_SHIFT);\r\n}\r\nstatic void\r\nia_css_awb_encode(\r\nstruct sh_css_isp_awb_params *to,\r\nconst struct ia_css_3a_config *from,\r\nunsigned size)\r\n{\r\n(void)size;\r\nto->lg_high_raw =\r\nuDIGIT_FITTING(from->awb_lg_high_raw, 16, s3a_raw_bit_depth);\r\nto->lg_low =\r\nuDIGIT_FITTING(from->awb_lg_low, 16, SH_CSS_BAYER_BITS);\r\nto->lg_high =\r\nuDIGIT_FITTING(from->awb_lg_high, 16, SH_CSS_BAYER_BITS);\r\n}\r\nstatic void\r\nia_css_af_encode(\r\nstruct sh_css_isp_af_params *to,\r\nconst struct ia_css_3a_config *from,\r\nunsigned size)\r\n{\r\nunsigned int i;\r\n(void)size;\r\nfor (i = 0; i < 7; ++i) {\r\nto->fir1[i] =\r\nsDIGIT_FITTING(from->af_fir1_coef[i], 15,\r\nSH_CSS_AF_FIR_SHIFT);\r\nto->fir2[i] =\r\nsDIGIT_FITTING(from->af_fir2_coef[i], 15,\r\nSH_CSS_AF_FIR_SHIFT);\r\n}\r\n}\r\nvoid\r\nia_css_s3a_encode(\r\nstruct sh_css_isp_s3a_params *to,\r\nconst struct ia_css_3a_config *from,\r\nunsigned size)\r\n{\r\n(void)size;\r\nia_css_ae_encode(&to->ae, from, sizeof(to->ae));\r\nia_css_awb_encode(&to->awb, from, sizeof(to->awb));\r\nia_css_af_encode(&to->af, from, sizeof(to->af));\r\n}\r\nvoid\r\nia_css_ae_dump(\r\nconst struct sh_css_isp_ae_params *ae,\r\nunsigned level)\r\n{\r\nif (!ae) return;\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ae_y_coef_r", ae->y_coef_r);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ae_y_coef_g", ae->y_coef_g);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ae_y_coef_b", ae->y_coef_b);\r\n}\r\nvoid\r\nia_css_awb_dump(\r\nconst struct sh_css_isp_awb_params *awb,\r\nunsigned level)\r\n{\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"awb_lg_high_raw", awb->lg_high_raw);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"awb_lg_low", awb->lg_low);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"awb_lg_high", awb->lg_high);\r\n}\r\nvoid\r\nia_css_af_dump(\r\nconst struct sh_css_isp_af_params *af,\r\nunsigned level)\r\n{\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[0]", af->fir1[0]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[1]", af->fir1[1]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[2]", af->fir1[2]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[3]", af->fir1[3]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[4]", af->fir1[4]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[5]", af->fir1[5]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir1[6]", af->fir1[6]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[0]", af->fir2[0]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[1]", af->fir2[1]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[2]", af->fir2[2]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[3]", af->fir2[3]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[4]", af->fir2[4]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[5]", af->fir2[5]);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"af_fir2[6]", af->fir2[6]);\r\n}\r\nvoid\r\nia_css_s3a_dump(\r\nconst struct sh_css_isp_s3a_params *s3a,\r\nunsigned level)\r\n{\r\nia_css_debug_dtrace(level, "S3A Support:\n");\r\nia_css_ae_dump (&s3a->ae, level);\r\nia_css_awb_dump (&s3a->awb, level);\r\nia_css_af_dump (&s3a->af, level);\r\n}\r\nvoid\r\nia_css_s3a_debug_dtrace(\r\nconst struct ia_css_3a_config *config,\r\nunsigned level)\r\n{\r\nia_css_debug_dtrace(level,\r\n"config.ae_y_coef_r=%d, config.ae_y_coef_g=%d, "\r\n"config.ae_y_coef_b=%d, config.awb_lg_high_raw=%d, "\r\n"config.awb_lg_low=%d, config.awb_lg_high=%d\n",\r\nconfig->ae_y_coef_r, config->ae_y_coef_g,\r\nconfig->ae_y_coef_b, config->awb_lg_high_raw,\r\nconfig->awb_lg_low, config->awb_lg_high);\r\n}\r\nvoid\r\nia_css_s3a_hmem_decode(\r\nstruct ia_css_3a_statistics *host_stats,\r\nconst struct ia_css_bh_table *hmem_buf)\r\n{\r\n#if defined(HAS_NO_HMEM)\r\n(void)host_stats;\r\n(void)hmem_buf;\r\n#else\r\nstruct ia_css_3a_rgby_output *out_ptr;\r\nint i;\r\nint count_for_3a;\r\nint sum_r, diff;\r\nassert(host_stats != NULL);\r\nassert(host_stats->rgby_data != NULL);\r\nassert(hmem_buf != NULL);\r\ncount_for_3a = host_stats->grid.width * host_stats->grid.height\r\n* host_stats->grid.bqs_per_grid_cell\r\n* host_stats->grid.bqs_per_grid_cell;\r\nout_ptr = host_stats->rgby_data;\r\nia_css_bh_hmem_decode(out_ptr, hmem_buf);\r\nsum_r = 0;\r\nfor (i = 0; i < HMEM_UNIT_SIZE; i++) {\r\nsum_r += out_ptr[i].r;\r\n}\r\nif (sum_r < count_for_3a) {\r\nreturn;\r\n}\r\n#if 0\r\n{\r\nint sum_g = 0;\r\nint sum_b = 0;\r\nint sum_y = 0;\r\nfor (i = 0; i < HMEM_UNIT_SIZE; i++) {\r\nsum_g += out_ptr[i].g;\r\nsum_b += out_ptr[i].b;\r\nsum_y += out_ptr[i].y;\r\n}\r\nif (sum_g != sum_r || sum_b != sum_r || sum_y != sum_r) {\r\nreturn;\r\n}\r\n}\r\n#endif\r\ndiff = sum_r - count_for_3a;\r\nout_ptr[0].r -= diff;\r\nout_ptr[0].g -= diff;\r\nout_ptr[0].b -= diff;\r\nout_ptr[0].y -= diff;\r\n#endif\r\n}\r\nvoid\r\nia_css_s3a_dmem_decode(\r\nstruct ia_css_3a_statistics *host_stats,\r\nconst struct ia_css_3a_output *isp_stats)\r\n{\r\nint isp_width, host_width, height, i;\r\nstruct ia_css_3a_output *host_ptr;\r\nassert(host_stats != NULL);\r\nassert(host_stats->data != NULL);\r\nassert(isp_stats != NULL);\r\nisp_width = host_stats->grid.aligned_width;\r\nhost_width = host_stats->grid.width;\r\nheight = host_stats->grid.height;\r\nhost_ptr = host_stats->data;\r\nfor (i = 0; i < height; i++) {\r\nmemcpy(host_ptr, isp_stats, host_width * sizeof(*host_ptr));\r\nisp_stats += isp_width;\r\nhost_ptr += host_width;\r\n}\r\n}\r\nSTORAGE_CLASS_INLINE int\r\nmerge_hi_lo_14(unsigned short hi, unsigned short lo)\r\n{\r\nint val = (int) ((((unsigned int) hi << 14) & 0xfffc000) |\r\n((unsigned int) lo & 0x3fff));\r\nreturn val;\r\n}\r\nvoid\r\nia_css_s3a_vmem_decode(\r\nstruct ia_css_3a_statistics *host_stats,\r\nconst uint16_t *isp_stats_hi,\r\nconst uint16_t *isp_stats_lo)\r\n{\r\nint out_width, out_height, chunk, rest, kmax, y, x, k, elm_start, elm, ofs;\r\nconst uint16_t *hi, *lo;\r\nstruct ia_css_3a_output *output;\r\nassert(host_stats!= NULL);\r\nassert(host_stats->data != NULL);\r\nassert(isp_stats_hi != NULL);\r\nassert(isp_stats_lo != NULL);\r\noutput = host_stats->data;\r\nout_width = host_stats->grid.width;\r\nout_height = host_stats->grid.height;\r\nhi = isp_stats_hi;\r\nlo = isp_stats_lo;\r\nchunk = ISP_VEC_NELEMS >> host_stats->grid.deci_factor_log2;\r\nchunk = max(chunk, 1);\r\nfor (y = 0; y < out_height; y++) {\r\nelm_start = y * ISP_S3ATBL_HI_LO_STRIDE;\r\nrest = out_width;\r\nx = 0;\r\nwhile (x < out_width) {\r\nkmax = (rest > chunk) ? chunk : rest;\r\nofs = y * out_width + x;\r\nelm = elm_start + x * sizeof(*output) / sizeof(int32_t);\r\nfor (k = 0; k < kmax; k++, elm++) {\r\noutput[ofs + k].ae_y = merge_hi_lo_14(\r\nhi[elm + chunk * 0], lo[elm + chunk * 0]);\r\noutput[ofs + k].awb_cnt = merge_hi_lo_14(\r\nhi[elm + chunk * 1], lo[elm + chunk * 1]);\r\noutput[ofs + k].awb_gr = merge_hi_lo_14(\r\nhi[elm + chunk * 2], lo[elm + chunk * 2]);\r\noutput[ofs + k].awb_r = merge_hi_lo_14(\r\nhi[elm + chunk * 3], lo[elm + chunk * 3]);\r\noutput[ofs + k].awb_b = merge_hi_lo_14(\r\nhi[elm + chunk * 4], lo[elm + chunk * 4]);\r\noutput[ofs + k].awb_gb = merge_hi_lo_14(\r\nhi[elm + chunk * 5], lo[elm + chunk * 5]);\r\noutput[ofs + k].af_hpf1 = merge_hi_lo_14(\r\nhi[elm + chunk * 6], lo[elm + chunk * 6]);\r\noutput[ofs + k].af_hpf2 = merge_hi_lo_14(\r\nhi[elm + chunk * 7], lo[elm + chunk * 7]);\r\n}\r\nx += chunk;\r\nrest -= chunk;\r\n}\r\n}\r\n}

static uint loadparam(struct adapter *padapter, _nic_hdl pnetdev)\r\n{\r\nuint status = _SUCCESS;\r\nstruct registry_priv *registry_par = &padapter->registrypriv;\r\nregistry_par->chip_version = (u8)rtw_chip_version;\r\nregistry_par->rfintfs = (u8)rtw_rfintfs;\r\nregistry_par->lbkmode = (u8)rtw_lbkmode;\r\nregistry_par->network_mode = (u8)rtw_network_mode;\r\nmemcpy(registry_par->ssid.Ssid, "ANY", 3);\r\nregistry_par->ssid.SsidLength = 3;\r\nregistry_par->channel = (u8)rtw_channel;\r\nregistry_par->wireless_mode = (u8)rtw_wireless_mode;\r\nif (registry_par->channel > 14)\r\nregistry_par->channel = 1;\r\nregistry_par->vrtl_carrier_sense = (u8)rtw_vrtl_carrier_sense ;\r\nregistry_par->vcs_type = (u8)rtw_vcs_type;\r\nregistry_par->rts_thresh =(u16)rtw_rts_thresh;\r\nregistry_par->frag_thresh =(u16)rtw_frag_thresh;\r\nregistry_par->preamble = (u8)rtw_preamble;\r\nregistry_par->scan_mode = (u8)rtw_scan_mode;\r\nregistry_par->adhoc_tx_pwr = (u8)rtw_adhoc_tx_pwr;\r\nregistry_par->soft_ap = (u8)rtw_soft_ap;\r\nregistry_par->smart_ps = (u8)rtw_smart_ps;\r\nregistry_par->check_fw_ps = (u8)rtw_check_fw_ps;\r\nregistry_par->power_mgnt = (u8)rtw_power_mgnt;\r\nregistry_par->ips_mode = (u8)rtw_ips_mode;\r\nregistry_par->radio_enable = (u8)rtw_radio_enable;\r\nregistry_par->long_retry_lmt = (u8)rtw_long_retry_lmt;\r\nregistry_par->short_retry_lmt = (u8)rtw_short_retry_lmt;\r\nregistry_par->busy_thresh = (u16)rtw_busy_thresh;\r\nregistry_par->ack_policy = (u8)rtw_ack_policy;\r\nregistry_par->software_encrypt = (u8)rtw_software_encrypt;\r\nregistry_par->software_decrypt = (u8)rtw_software_decrypt;\r\nregistry_par->acm_method = (u8)rtw_acm_method;\r\nregistry_par->usb_rxagg_mode = (u8)rtw_usb_rxagg_mode;\r\nregistry_par->wmm_enable = (u8)rtw_wmm_enable;\r\nregistry_par->uapsd_enable = (u8)rtw_uapsd_enable;\r\nregistry_par->uapsd_max_sp = (u8)rtw_uapsd_max_sp;\r\nregistry_par->uapsd_acbk_en = (u8)rtw_uapsd_acbk_en;\r\nregistry_par->uapsd_acbe_en = (u8)rtw_uapsd_acbe_en;\r\nregistry_par->uapsd_acvi_en = (u8)rtw_uapsd_acvi_en;\r\nregistry_par->uapsd_acvo_en = (u8)rtw_uapsd_acvo_en;\r\nregistry_par->ht_enable = (u8)rtw_ht_enable;\r\nregistry_par->bw_mode = (u8)rtw_bw_mode;\r\nregistry_par->ampdu_enable = (u8)rtw_ampdu_enable;\r\nregistry_par->rx_stbc = (u8)rtw_rx_stbc;\r\nregistry_par->ampdu_amsdu = (u8)rtw_ampdu_amsdu;\r\nregistry_par->short_gi = (u8)rtw_short_gi;\r\nregistry_par->ldpc_cap = (u8)rtw_ldpc_cap;\r\nregistry_par->stbc_cap = (u8)rtw_stbc_cap;\r\nregistry_par->beamform_cap = (u8)rtw_beamform_cap;\r\nregistry_par->lowrate_two_xmit = (u8)rtw_lowrate_two_xmit;\r\nregistry_par->rf_config = (u8)rtw_rf_config;\r\nregistry_par->low_power = (u8)rtw_low_power;\r\nregistry_par->wifi_spec = (u8)rtw_wifi_spec;\r\nregistry_par->channel_plan = (u8)rtw_channel_plan;\r\nregistry_par->btcoex = (u8)rtw_btcoex_enable;\r\nregistry_par->bt_iso = (u8)rtw_bt_iso;\r\nregistry_par->bt_sco = (u8)rtw_bt_sco;\r\nregistry_par->bt_ampdu = (u8)rtw_bt_ampdu;\r\nregistry_par->ant_num = (s8)rtw_ant_num;\r\nregistry_par->bAcceptAddbaReq = (u8)rtw_AcceptAddbaReq;\r\nregistry_par->antdiv_cfg = (u8)rtw_antdiv_cfg;\r\nregistry_par->antdiv_type = (u8)rtw_antdiv_type;\r\nregistry_par->hw_wps_pbc = (u8)rtw_hw_wps_pbc;\r\nregistry_par->max_roaming_times = (u8)rtw_max_roaming_times;\r\n#ifdef CONFIG_INTEL_WIDI\r\nregistry_par->max_roaming_times = (u8)rtw_max_roaming_times + 2;\r\n#endif\r\nregistry_par->enable80211d = (u8)rtw_80211d;\r\nsnprintf(registry_par->ifname, 16, "%s", ifname);\r\nregistry_par->notch_filter = (u8)rtw_notch_filter;\r\nregistry_par->RegEnableTxPowerLimit = (u8)rtw_tx_pwr_lmt_enable;\r\nregistry_par->RegEnableTxPowerByRate = (u8)rtw_tx_pwr_by_rate;\r\nregistry_par->RegPowerBase = 14;\r\nregistry_par->TxBBSwing_2G = 0xFF;\r\nregistry_par->TxBBSwing_5G = 0xFF;\r\nregistry_par->bEn_RFE = 1;\r\nregistry_par->RFE_Type = 64;\r\nregistry_par->load_phy_file = (u8)rtw_load_phy_file;\r\nregistry_par->RegDecryptCustomFile = (u8)rtw_decrypt_phy_file;\r\nregistry_par->qos_opt_enable = (u8)rtw_qos_opt_enable;\r\nregistry_par->hiq_filter = (u8)rtw_hiq_filter;\r\nreturn status;\r\n}\r\nstatic int rtw_net_set_mac_address(struct net_device *pnetdev, void *p)\r\n{\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nstruct sockaddr *addr = p;\r\nif (padapter->bup == false)\r\n{\r\nmemcpy(padapter->eeprompriv.mac_addr, addr->sa_data, ETH_ALEN);\r\n}\r\nreturn 0;\r\n}\r\nstatic struct net_device_stats *rtw_net_get_stats(struct net_device *pnetdev)\r\n{\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nstruct xmit_priv *pxmitpriv = &(padapter->xmitpriv);\r\nstruct recv_priv *precvpriv = &(padapter->recvpriv);\r\npadapter->stats.tx_packets = pxmitpriv->tx_pkts;\r\npadapter->stats.rx_packets = precvpriv->rx_pkts;\r\npadapter->stats.tx_dropped = pxmitpriv->tx_drop;\r\npadapter->stats.rx_dropped = precvpriv->rx_drop;\r\npadapter->stats.tx_bytes = pxmitpriv->tx_bytes;\r\npadapter->stats.rx_bytes = precvpriv->rx_bytes;\r\nreturn &padapter->stats;\r\n}\r\nstatic unsigned int rtw_classify8021d(struct sk_buff *skb)\r\n{\r\nunsigned int dscp;\r\nif (skb->priority >= 256 && skb->priority <= 263)\r\nreturn skb->priority - 256;\r\nswitch (skb->protocol) {\r\ncase htons(ETH_P_IP):\r\ndscp = ip_hdr(skb)->tos & 0xfc;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn dscp >> 5;\r\n}\r\nstatic u16 rtw_select_queue(struct net_device *dev, struct sk_buff *skb\r\n, void *accel_priv\r\n, select_queue_fallback_t fallback\r\n)\r\n{\r\nstruct adapter *padapter = rtw_netdev_priv(dev);\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nskb->priority = rtw_classify8021d(skb);\r\nif (pmlmepriv->acm_mask != 0)\r\n{\r\nskb->priority = qos_acm(pmlmepriv->acm_mask, skb->priority);\r\n}\r\nreturn rtw_1d_to_queue[skb->priority];\r\n}\r\nu16 rtw_recv_select_queue(struct sk_buff *skb)\r\n{\r\nstruct iphdr *piphdr;\r\nunsigned int dscp;\r\n__be16 eth_type;\r\nu32 priority;\r\nu8 *pdata = skb->data;\r\nmemcpy(&eth_type, pdata+(ETH_ALEN<<1), 2);\r\nswitch (be16_to_cpu(eth_type)) {\r\ncase ETH_P_IP:\r\npiphdr = (struct iphdr *)(pdata+ETH_HLEN);\r\ndscp = piphdr->tos & 0xfc;\r\npriority = dscp >> 5;\r\nbreak;\r\ndefault:\r\npriority = 0;\r\n}\r\nreturn rtw_1d_to_queue[priority];\r\n}\r\nstatic int rtw_ndev_notifier_call(struct notifier_block * nb, unsigned long state, void *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nif (dev->netdev_ops->ndo_do_ioctl != rtw_ioctl)\r\nreturn NOTIFY_DONE;\r\nDBG_871X_LEVEL(_drv_info_, FUNC_NDEV_FMT" state:%lu\n", FUNC_NDEV_ARG(dev), state);\r\nswitch (state) {\r\ncase NETDEV_CHANGENAME:\r\nrtw_adapter_proc_replace(dev);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nint rtw_ndev_notifier_register(void)\r\n{\r\nreturn register_netdevice_notifier(&rtw_ndev_notifier);\r\n}\r\nvoid rtw_ndev_notifier_unregister(void)\r\n{\r\nunregister_netdevice_notifier(&rtw_ndev_notifier);\r\n}\r\nstatic int rtw_ndev_init(struct net_device *dev)\r\n{\r\nstruct adapter *adapter = rtw_netdev_priv(dev);\r\nDBG_871X_LEVEL(_drv_always_, FUNC_ADPT_FMT"\n", FUNC_ADPT_ARG(adapter));\r\nstrncpy(adapter->old_ifname, dev->name, IFNAMSIZ);\r\nrtw_adapter_proc_init(dev);\r\nreturn 0;\r\n}\r\nstatic void rtw_ndev_uninit(struct net_device *dev)\r\n{\r\nstruct adapter *adapter = rtw_netdev_priv(dev);\r\nDBG_871X_LEVEL(_drv_always_, FUNC_ADPT_FMT"\n", FUNC_ADPT_ARG(adapter));\r\nrtw_adapter_proc_deinit(dev);\r\n}\r\nint rtw_init_netdev_name(struct net_device *pnetdev, const char *ifname)\r\n{\r\nif (dev_alloc_name(pnetdev, ifname) < 0) {\r\npr_err("dev_alloc_name, fail for %s\n", ifname);\r\nreturn 1;\r\n}\r\nnetif_carrier_off(pnetdev);\r\nreturn 0;\r\n}\r\nstruct net_device *rtw_init_netdev(struct adapter *old_padapter)\r\n{\r\nstruct adapter *padapter;\r\nstruct net_device *pnetdev;\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+init_net_dev\n"));\r\nif (old_padapter != NULL)\r\npnetdev = rtw_alloc_etherdev_with_old_priv(sizeof(struct adapter), (void *)old_padapter);\r\nelse\r\npnetdev = rtw_alloc_etherdev(sizeof(struct adapter));\r\npr_info("pnetdev = %p\n", pnetdev);\r\nif (!pnetdev)\r\nreturn NULL;\r\npadapter = rtw_netdev_priv(pnetdev);\r\npadapter->pnetdev = pnetdev;\r\nDBG_871X("register rtw_netdev_ops to netdev_ops\n");\r\npnetdev->netdev_ops = &rtw_netdev_ops;\r\npnetdev->watchdog_timeo = HZ*3;\r\npnetdev->wireless_handlers = (struct iw_handler_def *)&rtw_handlers_def;\r\nloadparam(padapter, pnetdev);\r\nreturn pnetdev;\r\n}\r\nvoid rtw_unregister_netdevs(struct dvobj_priv *dvobj)\r\n{\r\nstruct adapter *padapter = NULL;\r\nstruct net_device *pnetdev = NULL;\r\npadapter = dvobj->padapters;\r\nif (padapter == NULL)\r\nreturn;\r\npnetdev = padapter->pnetdev;\r\nif ((padapter->DriverState != DRIVER_DISAPPEAR) && pnetdev)\r\nunregister_netdev(pnetdev);\r\nrtw_wdev_unregister(padapter->rtw_wdev);\r\n}\r\nu32 rtw_start_drv_threads(struct adapter *padapter)\r\n{\r\nu32 _status = _SUCCESS;\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+rtw_start_drv_threads\n"));\r\npadapter->xmitThread = kthread_run(rtw_xmit_thread, padapter, "RTW_XMIT_THREAD");\r\nif (IS_ERR(padapter->xmitThread))\r\n_status = _FAIL;\r\npadapter->cmdThread = kthread_run(rtw_cmd_thread, padapter, "RTW_CMD_THREAD");\r\nif (IS_ERR(padapter->cmdThread))\r\n_status = _FAIL;\r\nelse\r\ndown(&padapter->cmdpriv.terminate_cmdthread_sema);\r\nrtw_hal_start_thread(padapter);\r\nreturn _status;\r\n}\r\nvoid rtw_stop_drv_threads (struct adapter *padapter)\r\n{\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+rtw_stop_drv_threads\n"));\r\nrtw_stop_cmd_thread(padapter);\r\nup(&padapter->xmitpriv.xmit_sema);\r\ndown(&padapter->xmitpriv.terminate_xmitthread_sema);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("\n drv_halt: rtw_xmit_thread can be terminated !\n"));\r\nrtw_hal_stop_thread(padapter);\r\n}\r\nstatic u8 rtw_init_default_value(struct adapter *padapter)\r\n{\r\nu8 ret = _SUCCESS;\r\nstruct registry_priv* pregistrypriv = &padapter->registrypriv;\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\npxmitpriv->vcs_setting = pregistrypriv->vrtl_carrier_sense;\r\npxmitpriv->vcs = pregistrypriv->vcs_type;\r\npxmitpriv->vcs_type = pregistrypriv->vcs_type;\r\npxmitpriv->frag_len = pregistrypriv->frag_thresh;\r\npmlmepriv->scan_mode = SCAN_ACTIVE;\r\npmlmepriv->htpriv.ampdu_enable = false;\r\npsecuritypriv->binstallGrpkey = _FAIL;\r\n#ifdef CONFIG_GTK_OL\r\npsecuritypriv->binstallKCK_KEK = _FAIL;\r\n#endif\r\npsecuritypriv->sw_encrypt =pregistrypriv->software_encrypt;\r\npsecuritypriv->sw_decrypt =pregistrypriv->software_decrypt;\r\npsecuritypriv->dot11AuthAlgrthm = dot11AuthAlgrthm_Open;\r\npsecuritypriv->dot11PrivacyAlgrthm = _NO_PRIVACY_;\r\npsecuritypriv->dot11PrivacyKeyIndex = 0;\r\npsecuritypriv->dot118021XGrpPrivacy = _NO_PRIVACY_;\r\npsecuritypriv->dot118021XGrpKeyid = 1;\r\npsecuritypriv->ndisauthtype = Ndis802_11AuthModeOpen;\r\npsecuritypriv->ndisencryptstatus = Ndis802_11WEPDisabled;\r\nrtw_init_registrypriv_dev_network(padapter);\r\nrtw_update_registrypriv_dev_network(padapter);\r\nrtw_hal_def_value_init(padapter);\r\nRTW_ENABLE_FUNC(padapter, DF_RX_BIT);\r\nRTW_ENABLE_FUNC(padapter, DF_TX_BIT);\r\npadapter->bLinkInfoDump = 0;\r\npadapter->bNotifyChannelChange = 0;\r\npadapter->fix_rate = 0xFF;\r\npadapter->driver_ampdu_spacing = 0xFF;\r\npadapter->driver_rx_ampdu_factor = 0xFF;\r\nreturn ret;\r\n}\r\nstruct dvobj_priv *devobj_init(void)\r\n{\r\nstruct dvobj_priv *pdvobj = NULL;\r\nif ((pdvobj = (struct dvobj_priv*)rtw_zmalloc(sizeof(*pdvobj))) == NULL)\r\nreturn NULL;\r\nmutex_init(&pdvobj->hw_init_mutex);\r\nmutex_init(&pdvobj->h2c_fwcmd_mutex);\r\nmutex_init(&pdvobj->setch_mutex);\r\nmutex_init(&pdvobj->setbw_mutex);\r\nspin_lock_init(&pdvobj->lock);\r\npdvobj->macid[1] = true;\r\npdvobj->processing_dev_remove = false;\r\natomic_set(&pdvobj->disable_func, 0);\r\nspin_lock_init(&pdvobj->cam_ctl.lock);\r\nreturn pdvobj;\r\n}\r\nvoid devobj_deinit(struct dvobj_priv *pdvobj)\r\n{\r\nif (!pdvobj)\r\nreturn;\r\nmutex_destroy(&pdvobj->hw_init_mutex);\r\nmutex_destroy(&pdvobj->h2c_fwcmd_mutex);\r\nmutex_destroy(&pdvobj->setch_mutex);\r\nmutex_destroy(&pdvobj->setbw_mutex);\r\nkfree((u8 *)pdvobj);\r\n}\r\nu8 rtw_reset_drv_sw(struct adapter *padapter)\r\n{\r\nu8 ret8 = _SUCCESS;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct pwrctrl_priv *pwrctrlpriv = adapter_to_pwrctl(padapter);\r\nif (is_primary_adapter(padapter))\r\nrtw_hal_def_value_init(padapter);\r\nRTW_ENABLE_FUNC(padapter, DF_RX_BIT);\r\nRTW_ENABLE_FUNC(padapter, DF_TX_BIT);\r\npadapter->bLinkInfoDump = 0;\r\npadapter->xmitpriv.tx_pkts = 0;\r\npadapter->recvpriv.rx_pkts = 0;\r\npmlmepriv->LinkDetectInfo.bBusyTraffic = false;\r\npmlmepriv->LinkDetectInfo.TrafficTransitionCount = 0;\r\npmlmepriv->LinkDetectInfo.LowPowerTransitionCount = 0;\r\n_clr_fwstate_(pmlmepriv, _FW_UNDER_SURVEY |_FW_UNDER_LINKING);\r\npwrctrlpriv->pwr_state_check_cnts = 0;\r\npadapter->mlmeextpriv.sitesurvey_res.state = SCAN_DISABLE;\r\nrtw_set_signal_stat_timer(&padapter->recvpriv);\r\nreturn ret8;\r\n}\r\nu8 rtw_init_drv_sw(struct adapter *padapter)\r\n{\r\nu8 ret8 = _SUCCESS;\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+rtw_init_drv_sw\n"));\r\nret8 = rtw_init_default_value(padapter);\r\nrtw_init_hal_com_default_value(padapter);\r\nif ((rtw_init_cmd_priv(&padapter->cmdpriv)) == _FAIL) {\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("\n Can't init cmd_priv\n"));\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\npadapter->cmdpriv.padapter =padapter;\r\nif ((rtw_init_evt_priv(&padapter->evtpriv)) == _FAIL) {\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("\n Can't init evt_priv\n"));\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\nif (rtw_init_mlme_priv(padapter) == _FAIL) {\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("\n Can't init mlme_priv\n"));\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\nif (init_mlme_ext_priv(padapter) == _FAIL) {\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("\n Can't init mlme_ext_priv\n"));\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\nif (_rtw_init_xmit_priv(&padapter->xmitpriv, padapter) == _FAIL) {\r\nDBG_871X("Can't _rtw_init_xmit_priv\n");\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\nif (_rtw_init_recv_priv(&padapter->recvpriv, padapter) == _FAIL) {\r\nDBG_871X("Can't _rtw_init_recv_priv\n");\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\nspin_lock_init(&padapter->security_key_mutex);\r\nif (_rtw_init_sta_priv(&padapter->stapriv) == _FAIL) {\r\nDBG_871X("Can't _rtw_init_sta_priv\n");\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\npadapter->stapriv.padapter = padapter;\r\npadapter->setband = GHZ24_50;\r\npadapter->fix_rate = 0xFF;\r\nrtw_init_bcmc_stainfo(padapter);\r\nrtw_init_pwrctrl_priv(padapter);\r\nrtw_hal_dm_init(padapter);\r\n#ifdef CONFIG_INTEL_WIDI\r\nif (rtw_init_intel_widi(padapter) == _FAIL) {\r\nDBG_871X("Can't rtw_init_intel_widi\n");\r\nret8 = _FAIL;\r\ngoto exit;\r\n}\r\n#endif\r\nexit:\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("-rtw_init_drv_sw\n"));\r\nreturn ret8;\r\n}\r\nvoid rtw_cancel_all_timer(struct adapter *padapter)\r\n{\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+rtw_cancel_all_timer\n"));\r\ndel_timer_sync(&padapter->mlmepriv.assoc_timer);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("rtw_cancel_all_timer:cancel association timer complete!\n"));\r\ndel_timer_sync(&padapter->mlmepriv.scan_to_timer);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("rtw_cancel_all_timer:cancel scan_to_timer!\n"));\r\ndel_timer_sync(&padapter->mlmepriv.dynamic_chk_timer);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("rtw_cancel_all_timer:cancel dynamic_chk_timer!\n"));\r\ndel_timer_sync(&(adapter_to_pwrctl(padapter)->pwr_state_check_timer));\r\ndel_timer_sync(&padapter->mlmepriv.set_scan_deny_timer);\r\nrtw_clear_scan_deny(padapter);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("rtw_cancel_all_timer:cancel set_scan_deny_timer!\n"));\r\ndel_timer_sync(&padapter->recvpriv.signal_stat_timer);\r\nrtw_hal_dm_deinit(padapter);\r\n}\r\nu8 rtw_free_drv_sw(struct adapter *padapter)\r\n{\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("==>rtw_free_drv_sw"));\r\n#ifdef CONFIG_INTEL_WIDI\r\nrtw_free_intel_widi(padapter);\r\n#endif\r\nfree_mlme_ext_priv(&padapter->mlmeextpriv);\r\nrtw_free_cmd_priv(&padapter->cmdpriv);\r\nrtw_free_evt_priv(&padapter->evtpriv);\r\nrtw_free_mlme_priv(&padapter->mlmepriv);\r\n_rtw_free_xmit_priv(&padapter->xmitpriv);\r\n_rtw_free_sta_priv(&padapter->stapriv);\r\n_rtw_free_recv_priv(&padapter->recvpriv);\r\nrtw_free_pwrctrl_priv(padapter);\r\nrtw_hal_free_data(padapter);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("<==rtw_free_drv_sw\n"));\r\nif (padapter->rereg_nd_name_priv.old_pnetdev) {\r\nfree_netdev(padapter->rereg_nd_name_priv.old_pnetdev);\r\npadapter->rereg_nd_name_priv.old_pnetdev = NULL;\r\n}\r\nif (padapter->pbuddy_adapter != NULL)\r\npadapter->pbuddy_adapter->pbuddy_adapter = NULL;\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("-rtw_free_drv_sw\n"));\r\nreturn _SUCCESS;\r\n}\r\nstatic int _rtw_drv_register_netdev(struct adapter *padapter, char *name)\r\n{\r\nint ret = _SUCCESS;\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nif (rtw_init_netdev_name(pnetdev, name))\r\nreturn _FAIL;\r\nmemcpy(pnetdev->dev_addr, padapter->eeprompriv.mac_addr, ETH_ALEN);\r\nif (register_netdev(pnetdev) != 0) {\r\nDBG_871X(FUNC_NDEV_FMT "Failed!\n", FUNC_NDEV_ARG(pnetdev));\r\nret = _FAIL;\r\ngoto error_register_netdev;\r\n}\r\nDBG_871X("%s, MAC Address (if%d) = " MAC_FMT "\n", __func__, (padapter->iface_id+1), MAC_ARG(pnetdev->dev_addr));\r\nreturn ret;\r\nerror_register_netdev:\r\nrtw_free_drv_sw(padapter);\r\nrtw_free_netdev(pnetdev);\r\nreturn ret;\r\n}\r\nint rtw_drv_register_netdev(struct adapter *if1)\r\n{\r\nstruct dvobj_priv *dvobj = if1->dvobj;\r\nstruct adapter *padapter = dvobj->padapters;\r\nchar *name = if1->registrypriv.ifname;\r\nreturn _rtw_drv_register_netdev(padapter, name);\r\n}\r\nint _netdev_open(struct net_device *pnetdev)\r\n{\r\nuint status;\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nstruct pwrctrl_priv *pwrctrlpriv = adapter_to_pwrctl(padapter);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+871x_drv - dev_open\n"));\r\nDBG_871X("+871x_drv - drv_open, bup =%d\n", padapter->bup);\r\npadapter->netif_up = true;\r\nif (pwrctrlpriv->ps_flag == true) {\r\npadapter->net_closed = false;\r\ngoto netdev_open_normal_process;\r\n}\r\nif (padapter->bup == false) {\r\npadapter->bDriverStopped = false;\r\npadapter->bSurpriseRemoved = false;\r\npadapter->bCardDisableWOHSM = false;\r\nstatus = rtw_hal_init(padapter);\r\nif (status == _FAIL) {\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("rtl871x_hal_init(): Can't init h/w!\n"));\r\ngoto netdev_open_error;\r\n}\r\nDBG_871X("MAC Address = "MAC_FMT"\n", MAC_ARG(pnetdev->dev_addr));\r\nstatus =rtw_start_drv_threads(padapter);\r\nif (status == _FAIL) {\r\nDBG_871X("Initialize driver software resource Failed!\n");\r\ngoto netdev_open_error;\r\n}\r\nif (padapter->intf_start)\r\npadapter->intf_start(padapter);\r\nrtw_cfg80211_init_wiphy(padapter);\r\npadapter->bup = true;\r\npwrctrlpriv->bips_processing = false;\r\n}\r\npadapter->net_closed = false;\r\n_set_timer(&padapter->mlmepriv.dynamic_chk_timer, 2000);\r\nif (!rtw_netif_queue_stopped(pnetdev))\r\nrtw_netif_start_queue(pnetdev);\r\nelse\r\nrtw_netif_wake_queue(pnetdev);\r\nnetdev_open_normal_process:\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("-871x_drv - dev_open\n"));\r\nDBG_871X("-871x_drv - drv_open, bup =%d\n", padapter->bup);\r\nreturn 0;\r\nnetdev_open_error:\r\npadapter->bup = false;\r\nnetif_carrier_off(pnetdev);\r\nrtw_netif_stop_queue(pnetdev);\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("-871x_drv - dev_open, fail!\n"));\r\nDBG_871X("-871x_drv - drv_open fail, bup =%d\n", padapter->bup);\r\nreturn (-1);\r\n}\r\nint netdev_open(struct net_device *pnetdev)\r\n{\r\nint ret;\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nstruct pwrctrl_priv *pwrctrlpriv = adapter_to_pwrctl(padapter);\r\nif (pwrctrlpriv->bInSuspend == true)\r\n{\r\nDBG_871X("+871x_drv - drv_open, bInSuspend =%d\n", pwrctrlpriv->bInSuspend);\r\nreturn 0;\r\n}\r\nif (mutex_lock_interruptible(&(adapter_to_dvobj(padapter)->hw_init_mutex)))\r\nreturn -1;\r\nret = _netdev_open(pnetdev);\r\nmutex_unlock(&(adapter_to_dvobj(padapter)->hw_init_mutex));\r\nreturn ret;\r\n}\r\nstatic int ips_netdrv_open(struct adapter *padapter)\r\n{\r\nint status = _SUCCESS;\r\npadapter->net_closed = false;\r\nDBG_871X("===> %s.........\n", __func__);\r\npadapter->bDriverStopped = false;\r\npadapter->bCardDisableWOHSM = false;\r\nstatus = rtw_hal_init(padapter);\r\nif (status == _FAIL)\r\n{\r\nRT_TRACE(_module_os_intfs_c_, _drv_err_, ("ips_netdrv_open(): Can't init h/w!\n"));\r\ngoto netdev_open_error;\r\n}\r\nif (padapter->intf_start)\r\n{\r\npadapter->intf_start(padapter);\r\n}\r\n_set_timer(&padapter->mlmepriv.dynamic_chk_timer, 2000);\r\nreturn _SUCCESS;\r\nnetdev_open_error:\r\nDBG_871X("-ips_netdrv_open - drv_open failure, bup =%d\n", padapter->bup);\r\nreturn _FAIL;\r\n}\r\nint rtw_ips_pwr_up(struct adapter *padapter)\r\n{\r\nint result;\r\nDBG_871X("===> rtw_ips_pwr_up..............\n");\r\nresult = ips_netdrv_open(padapter);\r\nDBG_871X("<=== rtw_ips_pwr_up..............\n");\r\nreturn result;\r\n}\r\nvoid rtw_ips_pwr_down(struct adapter *padapter)\r\n{\r\nDBG_871X("===> rtw_ips_pwr_down...................\n");\r\npadapter->bCardDisableWOHSM = true;\r\npadapter->net_closed = true;\r\nrtw_ips_dev_unload(padapter);\r\npadapter->bCardDisableWOHSM = false;\r\nDBG_871X("<=== rtw_ips_pwr_down.....................\n");\r\n}\r\nvoid rtw_ips_dev_unload(struct adapter *padapter)\r\n{\r\nDBG_871X("====> %s...\n", __func__);\r\nif (padapter->bSurpriseRemoved == false)\r\n{\r\nrtw_hal_deinit(padapter);\r\n}\r\n}\r\nstatic int pm_netdev_open(struct net_device *pnetdev, u8 bnormal)\r\n{\r\nint status = -1;\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nif (true == bnormal)\r\n{\r\nif (mutex_lock_interruptible(&(adapter_to_dvobj(padapter)->hw_init_mutex)) == 0) {\r\nstatus = _netdev_open(pnetdev);\r\nmutex_unlock(&(adapter_to_dvobj(padapter)->hw_init_mutex));\r\n}\r\n}\r\nelse\r\nstatus = (_SUCCESS == ips_netdrv_open(padapter))?(0):(-1);\r\nreturn status;\r\n}\r\nstatic int netdev_close(struct net_device *pnetdev)\r\n{\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(pnetdev);\r\nstruct pwrctrl_priv *pwrctl = adapter_to_pwrctl(padapter);\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("+871x_drv - drv_close\n"));\r\nif (pwrctl->bInternalAutoSuspend == true)\r\n{\r\nif (pwrctl->rf_pwrstate == rf_off)\r\npwrctl->ps_flag = true;\r\n}\r\npadapter->net_closed = true;\r\npadapter->netif_up = false;\r\nif (pwrctl->rf_pwrstate == rf_on) {\r\nDBG_871X("(2)871x_drv - drv_close, bup =%d, hw_init_completed =%d\n", padapter->bup, padapter->hw_init_completed);\r\nif (pnetdev)\r\n{\r\nif (!rtw_netif_queue_stopped(pnetdev))\r\nrtw_netif_stop_queue(pnetdev);\r\n}\r\nLeaveAllPowerSaveMode(padapter);\r\nrtw_disassoc_cmd(padapter, 500, false);\r\nrtw_indicate_disconnect(padapter);\r\nrtw_free_assoc_resources(padapter, 1);\r\nrtw_free_network_queue(padapter, true);\r\n}\r\nrtw_scan_abort(padapter);\r\nadapter_wdev_data(padapter)->bandroid_scan = false;\r\nRT_TRACE(_module_os_intfs_c_, _drv_info_, ("-871x_drv - drv_close\n"));\r\nDBG_871X("-871x_drv - drv_close, bup =%d\n", padapter->bup);\r\nreturn 0;\r\n}\r\nvoid rtw_ndev_destructor(struct net_device *ndev)\r\n{\r\nDBG_871X(FUNC_NDEV_FMT"\n", FUNC_NDEV_ARG(ndev));\r\nif (ndev->ieee80211_ptr)\r\nkfree((u8 *)ndev->ieee80211_ptr);\r\n}\r\nvoid rtw_dev_unload(struct adapter *padapter)\r\n{\r\nstruct pwrctrl_priv *pwrctl = adapter_to_pwrctl(padapter);\r\nstruct dvobj_priv *pobjpriv = padapter->dvobj;\r\nstruct debug_priv *pdbgpriv = &pobjpriv->drv_dbg;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nu8 cnt = 0;\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_, ("+%s\n", __func__));\r\nif (padapter->bup == true)\r\n{\r\nDBG_871X("===> %s\n", __func__);\r\npadapter->bDriverStopped = true;\r\nif (padapter->xmitpriv.ack_tx)\r\nrtw_ack_tx_done(&padapter->xmitpriv, RTW_SCTX_DONE_DRV_STOP);\r\nif (padapter->intf_stop)\r\npadapter->intf_stop(padapter);\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_, ("@ rtw_dev_unload: stop intf complete!\n"));\r\nif (!pwrctl->bInternalAutoSuspend)\r\nrtw_stop_drv_threads(padapter);\r\nwhile (atomic_read(&(pcmdpriv->cmdthd_running)) == true) {\r\nif (cnt > 5) {\r\nDBG_871X("stop cmdthd timeout\n");\r\nbreak;\r\n} else {\r\ncnt ++;\r\nDBG_871X("cmdthd is running(%d)\n", cnt);\r\nmsleep(10);\r\n}\r\n}\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_, ("@ %s: stop thread complete!\n", __func__));\r\nif (rtw_hal_check_ips_status(padapter) == true || pwrctl->rf_pwrstate == rf_off) {\r\nDBG_871X_LEVEL(_drv_always_, "%s: driver in IPS-FWLPS\n", __func__);\r\npdbgpriv->dbg_dev_unload_inIPS_cnt++;\r\nLeaveAllPowerSaveMode(padapter);\r\n} else {\r\nDBG_871X_LEVEL(_drv_always_, "%s: driver not in IPS\n", __func__);\r\n}\r\nif (padapter->bSurpriseRemoved == false)\r\n{\r\nrtw_btcoex_IpsNotify(padapter, pwrctl->ips_mode_req);\r\n#ifdef CONFIG_WOWLAN\r\nif (pwrctl->bSupportRemoteWakeup == true &&\r\npwrctl->wowlan_mode ==true) {\r\nDBG_871X_LEVEL(_drv_always_, "%s bSupportRemoteWakeup ==true do not run rtw_hal_deinit()\n", __func__);\r\n}\r\nelse\r\n#endif\r\n{\r\nrtw_hal_deinit(padapter);\r\n}\r\npadapter->bSurpriseRemoved = true;\r\n}\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_,\r\n("@ %s: deinit hal complete!\n", __func__));\r\npadapter->bup = false;\r\nDBG_871X("<=== %s\n", __func__);\r\n}\r\nelse {\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_, ("%s: bup ==false\n", __func__));\r\nDBG_871X("%s: bup ==false\n", __func__);\r\n}\r\nRT_TRACE(_module_hci_intfs_c_, _drv_notice_, ("-%s\n", __func__));\r\n}\r\nstatic int rtw_suspend_free_assoc_resource(struct adapter *padapter)\r\n{\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nif (rtw_chk_roam_flags(padapter, RTW_ROAM_ON_RESUME)) {\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE)\r\n&& check_fwstate(pmlmepriv, _FW_LINKED))\r\n{\r\nDBG_871X("%s %s(" MAC_FMT "), length:%d assoc_ssid.length:%d\n", __func__,\r\npmlmepriv->cur_network.network.Ssid.Ssid,\r\nMAC_ARG(pmlmepriv->cur_network.network.MacAddress),\r\npmlmepriv->cur_network.network.Ssid.SsidLength,\r\npmlmepriv->assoc_ssid.SsidLength);\r\nrtw_set_to_roam(padapter, 1);\r\n}\r\n}\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE) && check_fwstate(pmlmepriv, _FW_LINKED))\r\n{\r\nrtw_disassoc_cmd(padapter, 0, false);\r\nrtw_indicate_disconnect(padapter);\r\n}\r\nelse if (check_fwstate(pmlmepriv, WIFI_AP_STATE))\r\n{\r\nrtw_sta_flush(padapter);\r\n}\r\nrtw_free_assoc_resources(padapter, 1);\r\nrtw_free_network_queue(padapter, true);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY))\r\nrtw_indicate_scan_done(padapter, 1);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_LINKING) == true)\r\n{\r\nDBG_871X_LEVEL(_drv_always_, "%s: fw_under_linking\n", __func__);\r\nrtw_indicate_disconnect(padapter);\r\n}\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn _SUCCESS;\r\n}\r\nint rtw_suspend_wow(struct adapter *padapter)\r\n{\r\nu8 ch, bw, offset;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nstruct pwrctrl_priv *pwrpriv = adapter_to_pwrctl(padapter);\r\nstruct wowlan_ioctl_param poidparam;\r\nint ret = _SUCCESS;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nDBG_871X("wowlan_mode: %d\n", pwrpriv->wowlan_mode);\r\nDBG_871X("wowlan_pno_enable: %d\n", pwrpriv->wowlan_pno_enable);\r\nif (pwrpriv->wowlan_mode == true) {\r\nif (pnetdev)\r\nrtw_netif_stop_queue(pnetdev);\r\npadapter->bDriverStopped = true;\r\nrtw_stop_drv_threads(padapter);\r\npadapter->bDriverStopped = false;\r\nif (padapter->intf_stop) {\r\npadapter->intf_stop(padapter);\r\n}\r\nif (padapter->HalFunc.clear_interrupt)\r\npadapter->HalFunc.clear_interrupt(padapter);\r\nif (padapter->intf_free_irq)\r\npadapter->intf_free_irq(adapter_to_dvobj(padapter));\r\npoidparam.subcode = WOWLAN_ENABLE;\r\npadapter->HalFunc.SetHwRegHandler(padapter, HW_VAR_WOWLAN, (u8 *)&poidparam);\r\nif (rtw_chk_roam_flags(padapter, RTW_ROAM_ON_RESUME)) {\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE)\r\n&& check_fwstate(pmlmepriv, _FW_LINKED))\r\n{\r\nDBG_871X("%s %s(" MAC_FMT "), length:%d assoc_ssid.length:%d\n", __func__,\r\npmlmepriv->cur_network.network.Ssid.Ssid,\r\nMAC_ARG(pmlmepriv->cur_network.network.MacAddress),\r\npmlmepriv->cur_network.network.Ssid.SsidLength,\r\npmlmepriv->assoc_ssid.SsidLength);\r\nrtw_set_to_roam(padapter, 0);\r\n}\r\n}\r\nDBG_871X_LEVEL(_drv_always_, "%s: wowmode suspending\n", __func__);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY) == true)\r\n{\r\nDBG_871X_LEVEL(_drv_always_, "%s: fw_under_survey\n", __func__);\r\nrtw_indicate_scan_done(padapter, 1);\r\nclr_fwstate(pmlmepriv, _FW_UNDER_SURVEY);\r\n}\r\nif (rtw_get_ch_setting_union(padapter, &ch, &bw, &offset) != 0) {\r\nDBG_871X(FUNC_ADPT_FMT" back to linked/linking union - ch:%u, bw:%u, offset:%u\n",\r\nFUNC_ADPT_ARG(padapter), ch, bw, offset);\r\nset_channel_bwmode(padapter, ch, offset, bw);\r\n}\r\nif (pwrpriv->wowlan_pno_enable)\r\nDBG_871X_LEVEL(_drv_always_, "%s: pno: %d\n", __func__, pwrpriv->wowlan_pno_enable);\r\nelse\r\nrtw_set_ps_mode(padapter, PS_MODE_DTIM, 0, 0, "WOWLAN");\r\n}\r\nelse\r\n{\r\nDBG_871X_LEVEL(_drv_always_, "%s: ### ERROR ### wowlan_mode =%d\n", __func__, pwrpriv->wowlan_mode);\r\n}\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn ret;\r\n}\r\nint rtw_suspend_ap_wow(struct adapter *padapter)\r\n{\r\nu8 ch, bw, offset;\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nstruct pwrctrl_priv *pwrpriv = adapter_to_pwrctl(padapter);\r\nstruct wowlan_ioctl_param poidparam;\r\nint ret = _SUCCESS;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\npwrpriv->wowlan_ap_mode = true;\r\nDBG_871X("wowlan_ap_mode: %d\n", pwrpriv->wowlan_ap_mode);\r\nif (pnetdev)\r\nrtw_netif_stop_queue(pnetdev);\r\npadapter->bDriverStopped = true;\r\nrtw_stop_drv_threads(padapter);\r\npadapter->bDriverStopped = false;\r\nrtw_hal_disable_interrupt(padapter);\r\nif (padapter->HalFunc.clear_interrupt)\r\npadapter->HalFunc.clear_interrupt(padapter);\r\nif (padapter->intf_free_irq)\r\npadapter->intf_free_irq(adapter_to_dvobj(padapter));\r\npoidparam.subcode = WOWLAN_AP_ENABLE;\r\npadapter->HalFunc.SetHwRegHandler(padapter,\r\nHW_VAR_AP_WOWLAN, (u8 *)&poidparam);\r\nDBG_871X_LEVEL(_drv_always_, "%s: wowmode suspending\n", __func__);\r\nif (rtw_get_ch_setting_union(padapter, &ch, &bw, &offset) != 0) {\r\nDBG_871X(FUNC_ADPT_FMT" back to linked/linking union - ch:%u, bw:%u, offset:%u\n",\r\nFUNC_ADPT_ARG(padapter), ch, bw, offset);\r\nset_channel_bwmode(padapter, ch, offset, bw);\r\n}\r\nrtw_set_ps_mode(padapter, PS_MODE_MIN, 0, 0, "AP-WOWLAN");\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn ret;\r\n}\r\nstatic int rtw_suspend_normal(struct adapter *padapter)\r\n{\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nint ret = _SUCCESS;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nif (pnetdev) {\r\nnetif_carrier_off(pnetdev);\r\nrtw_netif_stop_queue(pnetdev);\r\n}\r\nrtw_suspend_free_assoc_resource(padapter);\r\nif ((rtw_hal_check_ips_status(padapter) == true)\r\n|| (adapter_to_pwrctl(padapter)->rf_pwrstate == rf_off))\r\n{\r\nDBG_871X_LEVEL(_drv_always_, "%s: ### ERROR #### driver in IPS ####ERROR###!!!\n", __func__);\r\n}\r\nrtw_dev_unload(padapter);\r\nif (padapter->intf_deinit)\r\npadapter->intf_deinit(adapter_to_dvobj(padapter));\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn ret;\r\n}\r\nint rtw_suspend_common(struct adapter *padapter)\r\n{\r\nstruct dvobj_priv *psdpriv = padapter->dvobj;\r\nstruct debug_priv *pdbgpriv = &psdpriv->drv_dbg;\r\nstruct pwrctrl_priv *pwrpriv = dvobj_to_pwrctl(psdpriv);\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nint ret = 0;\r\nunsigned long start_time = jiffies;\r\nDBG_871X_LEVEL(_drv_always_, " suspend start\n");\r\nDBG_871X("==> %s (%s:%d)\n", __func__, current->comm, current->pid);\r\npdbgpriv->dbg_suspend_cnt++;\r\npwrpriv->bInSuspend = true;\r\nwhile (pwrpriv->bips_processing == true)\r\nmsleep(1);\r\nif ((!padapter->bup) || (padapter->bDriverStopped)||(padapter->bSurpriseRemoved))\r\n{\r\nDBG_871X("%s bup =%d bDriverStopped =%d bSurpriseRemoved = %d\n", __func__\r\n, padapter->bup, padapter->bDriverStopped, padapter->bSurpriseRemoved);\r\npdbgpriv->dbg_suspend_error_cnt++;\r\ngoto exit;\r\n}\r\nrtw_ps_deny(padapter, PS_DENY_SUSPEND);\r\nrtw_cancel_all_timer(padapter);\r\nLeaveAllPowerSaveModeDirect(padapter);\r\nrtw_stop_cmd_thread(padapter);\r\nif (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true) {\r\nrtw_btcoex_SuspendNotify(padapter, 0);\r\nDBG_871X("WIFI_AP_STATE\n");\r\n} else if (check_fwstate(pmlmepriv, WIFI_STATION_STATE) == true) {\r\nrtw_btcoex_SuspendNotify(padapter, 1);\r\nDBG_871X("STATION\n");\r\n}\r\nrtw_ps_deny_cancel(padapter, PS_DENY_SUSPEND);\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE) == true) {\r\n#ifdef CONFIG_WOWLAN\r\nif (check_fwstate(pmlmepriv, _FW_LINKED)) {\r\npwrpriv->wowlan_mode = true;\r\n} else if (pwrpriv->wowlan_pno_enable == true) {\r\npwrpriv->wowlan_mode |= pwrpriv->wowlan_pno_enable;\r\n}\r\nif (pwrpriv->wowlan_mode == true)\r\nrtw_suspend_wow(padapter);\r\nelse\r\nrtw_suspend_normal(padapter);\r\n#else\r\nrtw_suspend_normal(padapter);\r\n#endif\r\n} else if (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true) {\r\n#ifdef CONFIG_AP_WOWLAN\r\nrtw_suspend_ap_wow(padapter);\r\n#else\r\nrtw_suspend_normal(padapter);\r\n#endif\r\n} else {\r\nrtw_suspend_normal(padapter);\r\n}\r\nDBG_871X_LEVEL(_drv_always_, "rtw suspend success in %d ms\n",\r\njiffies_to_msecs(jiffies - start_time));\r\nexit:\r\nDBG_871X("<=== %s return %d.............. in %dms\n", __func__\r\n, ret, jiffies_to_msecs(jiffies - start_time));\r\nreturn ret;\r\n}\r\nint rtw_resume_process_wow(struct adapter *padapter)\r\n{\r\nstruct mlme_ext_priv *pmlmeext = &padapter->mlmeextpriv;\r\nstruct mlme_ext_info *pmlmeinfo = &(pmlmeext->mlmext_info);\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nstruct pwrctrl_priv *pwrpriv = adapter_to_pwrctl(padapter);\r\nstruct dvobj_priv *psdpriv = padapter->dvobj;\r\nstruct debug_priv *pdbgpriv = &psdpriv->drv_dbg;\r\nstruct wowlan_ioctl_param poidparam;\r\nstruct sta_info *psta = NULL;\r\nint ret = _SUCCESS;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nif (padapter) {\r\npnetdev = padapter->pnetdev;\r\npwrpriv = adapter_to_pwrctl(padapter);\r\n} else {\r\npdbgpriv->dbg_resume_error_cnt++;\r\nret = -1;\r\ngoto exit;\r\n}\r\nif (padapter->bDriverStopped || padapter->bSurpriseRemoved) {\r\nDBG_871X("%s pdapter %p bDriverStopped %d bSurpriseRemoved %d\n",\r\n__func__, padapter, padapter->bDriverStopped,\r\npadapter->bSurpriseRemoved);\r\ngoto exit;\r\n}\r\n#ifdef CONFIG_PNO_SUPPORT\r\npwrpriv->pno_in_resume = true;\r\n#endif\r\nif (pwrpriv->wowlan_mode == true) {\r\nrtw_set_ps_mode(padapter, PS_MODE_ACTIVE, 0, 0, "WOWLAN");\r\npwrpriv->bFwCurrentInPSMode = false;\r\nif (padapter->intf_stop) {\r\npadapter->intf_stop(padapter);\r\n}\r\nif (padapter->HalFunc.clear_interrupt)\r\npadapter->HalFunc.clear_interrupt(padapter);\r\nif ((padapter->intf_alloc_irq) && (padapter->intf_alloc_irq(adapter_to_dvobj(padapter)) != _SUCCESS)) {\r\nret = -1;\r\nRT_TRACE(_module_hci_intfs_c_, _drv_err_, ("%s: sdio_alloc_irq Failed!!\n", __func__));\r\ngoto exit;\r\n}\r\npoidparam.subcode =WOWLAN_DISABLE;\r\npadapter->HalFunc.SetHwRegHandler(padapter, HW_VAR_WOWLAN, (u8 *)&poidparam);\r\npsta = rtw_get_stainfo(&padapter->stapriv, get_bssid(&padapter->mlmepriv));\r\nif (psta) {\r\nset_sta_rate(padapter, psta);\r\n}\r\npadapter->bDriverStopped = false;\r\nDBG_871X("%s: wowmode resuming, DriverStopped:%d\n", __func__, padapter->bDriverStopped);\r\nrtw_start_drv_threads(padapter);\r\nif (padapter->intf_start) {\r\npadapter->intf_start(padapter);\r\n}\r\nif (pnetdev) {\r\nif (!rtw_netif_queue_stopped(pnetdev))\r\nrtw_netif_start_queue(pnetdev);\r\nelse\r\nrtw_netif_wake_queue(pnetdev);\r\n}\r\n}\r\nelse {\r\nDBG_871X_LEVEL(_drv_always_, "%s: ### ERROR ### wowlan_mode =%d\n", __func__, pwrpriv->wowlan_mode);\r\n}\r\nif (padapter->pid[1]!= 0) {\r\nDBG_871X("pid[1]:%d\n", padapter->pid[1]);\r\nrtw_signal_process(padapter->pid[1], SIGUSR2);\r\n}\r\nif (rtw_chk_roam_flags(padapter, RTW_ROAM_ON_RESUME)) {\r\nif (pwrpriv->wowlan_wake_reason == FWDecisionDisconnect ||\r\npwrpriv->wowlan_wake_reason == Rx_DisAssoc ||\r\npwrpriv->wowlan_wake_reason == Rx_DeAuth) {\r\nDBG_871X("%s: disconnect reason: %02x\n", __func__,\r\npwrpriv->wowlan_wake_reason);\r\nrtw_indicate_disconnect(padapter);\r\nrtw_sta_media_status_rpt(padapter,\r\nrtw_get_stainfo(&padapter->stapriv,\r\nget_bssid(&padapter->mlmepriv)), 0);\r\nrtw_free_assoc_resources(padapter, 1);\r\npmlmeinfo->state = WIFI_FW_NULL_STATE;\r\n} else {\r\nDBG_871X("%s: do roaming\n", __func__);\r\nrtw_roaming(padapter, NULL);\r\n}\r\n}\r\nif (pwrpriv->wowlan_mode == true) {\r\npwrpriv->bips_processing = false;\r\n_set_timer(&padapter->mlmepriv.dynamic_chk_timer, 2000);\r\n} else {\r\nDBG_871X_LEVEL(_drv_always_, "do not reset timer\n");\r\n}\r\npwrpriv->wowlan_mode =false;\r\npwrpriv->wowlan_wake_reason = 0;\r\nexit:\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn ret;\r\n}\r\nint rtw_resume_process_ap_wow(struct adapter *padapter)\r\n{\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nstruct pwrctrl_priv *pwrpriv = adapter_to_pwrctl(padapter);\r\nstruct dvobj_priv *psdpriv = padapter->dvobj;\r\nstruct debug_priv *pdbgpriv = &psdpriv->drv_dbg;\r\nstruct wowlan_ioctl_param poidparam;\r\nint ret = _SUCCESS;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nif (padapter) {\r\npnetdev = padapter->pnetdev;\r\npwrpriv = adapter_to_pwrctl(padapter);\r\n} else {\r\npdbgpriv->dbg_resume_error_cnt++;\r\nret = -1;\r\ngoto exit;\r\n}\r\nrtw_set_ps_mode(padapter, PS_MODE_ACTIVE, 0, 0, "AP-WOWLAN");\r\npwrpriv->bFwCurrentInPSMode = false;\r\nrtw_hal_disable_interrupt(padapter);\r\nif (padapter->HalFunc.clear_interrupt)\r\npadapter->HalFunc.clear_interrupt(padapter);\r\nif ((padapter->intf_alloc_irq) && (padapter->intf_alloc_irq(adapter_to_dvobj(padapter)) != _SUCCESS)) {\r\nret = -1;\r\nRT_TRACE(_module_hci_intfs_c_, _drv_err_, ("%s: sdio_alloc_irq Failed!!\n", __func__));\r\ngoto exit;\r\n}\r\npoidparam.subcode = WOWLAN_AP_DISABLE;\r\npadapter->HalFunc.SetHwRegHandler(padapter,\r\nHW_VAR_AP_WOWLAN, (u8 *)&poidparam);\r\npwrpriv->wowlan_ap_mode = false;\r\npadapter->bDriverStopped = false;\r\nDBG_871X("%s: wowmode resuming, DriverStopped:%d\n", __func__, padapter->bDriverStopped);\r\nrtw_start_drv_threads(padapter);\r\nif (padapter->intf_start) {\r\npadapter->intf_start(padapter);\r\n}\r\nif (pnetdev) {\r\nif (!rtw_netif_queue_stopped(pnetdev))\r\nrtw_netif_start_queue(pnetdev);\r\nelse\r\nrtw_netif_wake_queue(pnetdev);\r\n}\r\nif (padapter->pid[1]!= 0) {\r\nDBG_871X("pid[1]:%d\n", padapter->pid[1]);\r\nrtw_signal_process(padapter->pid[1], SIGUSR2);\r\n}\r\npwrpriv->bips_processing = false;\r\n_set_timer(&padapter->mlmepriv.dynamic_chk_timer, 2000);\r\npwrpriv->wowlan_wake_reason = 0;\r\nexit:\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nreturn ret;\r\n}\r\nstatic int rtw_resume_process_normal(struct adapter *padapter)\r\n{\r\nstruct net_device *pnetdev;\r\nstruct pwrctrl_priv *pwrpriv;\r\nstruct mlme_priv *pmlmepriv;\r\nstruct dvobj_priv *psdpriv;\r\nstruct debug_priv *pdbgpriv;\r\nint ret = _SUCCESS;\r\nif (!padapter) {\r\nret = -1;\r\ngoto exit;\r\n}\r\npnetdev = padapter->pnetdev;\r\npwrpriv = adapter_to_pwrctl(padapter);\r\npmlmepriv = &padapter->mlmepriv;\r\npsdpriv = padapter->dvobj;\r\npdbgpriv = &psdpriv->drv_dbg;\r\nDBG_871X("==> "FUNC_ADPT_FMT" entry....\n", FUNC_ADPT_ARG(padapter));\r\nif ((padapter->intf_init) && (padapter->intf_init(adapter_to_dvobj(padapter)) != _SUCCESS))\r\n{\r\nret = -1;\r\nRT_TRACE(_module_hci_intfs_c_, _drv_err_, ("%s: initialize SDIO Failed!!\n", __func__));\r\ngoto exit;\r\n}\r\nrtw_hal_disable_interrupt(padapter);\r\nif ((padapter->intf_alloc_irq) && (padapter->intf_alloc_irq(adapter_to_dvobj(padapter)) != _SUCCESS))\r\n{\r\nret = -1;\r\nRT_TRACE(_module_hci_intfs_c_, _drv_err_, ("%s: sdio_alloc_irq Failed!!\n", __func__));\r\ngoto exit;\r\n}\r\nrtw_reset_drv_sw(padapter);\r\npwrpriv->bkeepfwalive = false;\r\nDBG_871X("bkeepfwalive(%x)\n", pwrpriv->bkeepfwalive);\r\nif (pm_netdev_open(pnetdev, true) != 0) {\r\nret = -1;\r\npdbgpriv->dbg_resume_error_cnt++;\r\ngoto exit;\r\n}\r\nnetif_device_attach(pnetdev);\r\nnetif_carrier_on(pnetdev);\r\nif (padapter->pid[1]!= 0) {\r\nDBG_871X("pid[1]:%d\n", padapter->pid[1]);\r\nrtw_signal_process(padapter->pid[1], SIGUSR2);\r\n}\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE)) {\r\nDBG_871X(FUNC_ADPT_FMT" fwstate:0x%08x - WIFI_STATION_STATE\n", FUNC_ADPT_ARG(padapter), get_fwstate(pmlmepriv));\r\nif (rtw_chk_roam_flags(padapter, RTW_ROAM_ON_RESUME))\r\nrtw_roaming(padapter, NULL);\r\n} else if (check_fwstate(pmlmepriv, WIFI_AP_STATE)) {\r\nDBG_871X(FUNC_ADPT_FMT" fwstate:0x%08x - WIFI_AP_STATE\n", FUNC_ADPT_ARG(padapter), get_fwstate(pmlmepriv));\r\nrtw_ap_restore_network(padapter);\r\n} else if (check_fwstate(pmlmepriv, WIFI_ADHOC_STATE)) {\r\nDBG_871X(FUNC_ADPT_FMT" fwstate:0x%08x - WIFI_ADHOC_STATE\n", FUNC_ADPT_ARG(padapter), get_fwstate(pmlmepriv));\r\n} else {\r\nDBG_871X(FUNC_ADPT_FMT" fwstate:0x%08x - ???\n", FUNC_ADPT_ARG(padapter), get_fwstate(pmlmepriv));\r\n}\r\nDBG_871X("<== "FUNC_ADPT_FMT" exit....\n", FUNC_ADPT_ARG(padapter));\r\nexit:\r\nreturn ret;\r\n}\r\nint rtw_resume_common(struct adapter *padapter)\r\n{\r\nint ret = 0;\r\nunsigned long start_time = jiffies;\r\nstruct pwrctrl_priv *pwrpriv = adapter_to_pwrctl(padapter);\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nDBG_871X_LEVEL(_drv_always_, "resume start\n");\r\nDBG_871X("==> %s (%s:%d)\n", __func__, current->comm, current->pid);\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE) == true) {\r\n#ifdef CONFIG_WOWLAN\r\nif (pwrpriv->wowlan_mode == true)\r\nrtw_resume_process_wow(padapter);\r\nelse\r\nrtw_resume_process_normal(padapter);\r\n#else\r\nrtw_resume_process_normal(padapter);\r\n#endif\r\n} else if (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true) {\r\n#ifdef CONFIG_AP_WOWLAN\r\nrtw_resume_process_ap_wow(padapter);\r\n#else\r\nrtw_resume_process_normal(padapter);\r\n#endif\r\n} else {\r\nrtw_resume_process_normal(padapter);\r\n}\r\nrtw_btcoex_SuspendNotify(padapter, 0);\r\nif (pwrpriv) {\r\npwrpriv->bInSuspend = false;\r\n#ifdef CONFIG_PNO_SUPPORT\r\npwrpriv->pno_in_resume = false;\r\n#endif\r\n}\r\nDBG_871X_LEVEL(_drv_always_, "%s:%d in %d ms\n", __func__ , ret,\r\njiffies_to_msecs(jiffies - start_time));\r\nreturn ret;\r\n}

int smu7_fan_ctrl_get_fan_speed_info(struct pp_hwmgr *hwmgr,\r\nstruct phm_fan_speed_info *fan_speed_info)\r\n{\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn -ENODEV;\r\nfan_speed_info->supports_percent_read = true;\r\nfan_speed_info->supports_percent_write = true;\r\nfan_speed_info->min_percent = 0;\r\nfan_speed_info->max_percent = 100;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_FanSpeedInTableIsRPM) &&\r\nhwmgr->thermal_controller.fanInfo.ucTachometerPulsesPerRevolution) {\r\nfan_speed_info->supports_rpm_read = true;\r\nfan_speed_info->supports_rpm_write = true;\r\nfan_speed_info->min_rpm = hwmgr->thermal_controller.fanInfo.ulMinRPM;\r\nfan_speed_info->max_rpm = hwmgr->thermal_controller.fanInfo.ulMaxRPM;\r\n} else {\r\nfan_speed_info->min_rpm = 0;\r\nfan_speed_info->max_rpm = 0;\r\n}\r\nreturn 0;\r\n}\r\nint smu7_fan_ctrl_get_fan_speed_percent(struct pp_hwmgr *hwmgr,\r\nuint32_t *speed)\r\n{\r\nuint32_t duty100;\r\nuint32_t duty;\r\nuint64_t tmp64;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn -ENODEV;\r\nduty100 = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL1, FMAX_DUTY100);\r\nduty = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_STATUS, FDO_PWM_DUTY);\r\nif (duty100 == 0)\r\nreturn -EINVAL;\r\ntmp64 = (uint64_t)duty * 100;\r\ndo_div(tmp64, duty100);\r\n*speed = (uint32_t)tmp64;\r\nif (*speed > 100)\r\n*speed = 100;\r\nreturn 0;\r\n}\r\nint smu7_fan_ctrl_get_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t *speed)\r\n{\r\nuint32_t tach_period;\r\nuint32_t crystal_clock_freq;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan ||\r\n(hwmgr->thermal_controller.fanInfo.\r\nucTachometerPulsesPerRevolution == 0))\r\nreturn -ENODEV;\r\ntach_period = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_TACH_STATUS, TACH_PERIOD);\r\nif (tach_period == 0)\r\nreturn -EINVAL;\r\ncrystal_clock_freq = smu7_get_xclk(hwmgr);\r\n*speed = 60 * crystal_clock_freq * 10000 / tach_period;\r\nreturn 0;\r\n}\r\nint smu7_fan_ctrl_set_static_mode(struct pp_hwmgr *hwmgr, uint32_t mode)\r\n{\r\nif (hwmgr->fan_ctrl_is_in_default_mode) {\r\nhwmgr->fan_ctrl_default_mode =\r\nPHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, FDO_PWM_MODE);\r\nhwmgr->tmin =\r\nPHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, TMIN);\r\nhwmgr->fan_ctrl_is_in_default_mode = false;\r\n}\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, TMIN, 0);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, FDO_PWM_MODE, mode);\r\nreturn 0;\r\n}\r\nint smu7_fan_ctrl_set_default_mode(struct pp_hwmgr *hwmgr)\r\n{\r\nif (!hwmgr->fan_ctrl_is_in_default_mode) {\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, FDO_PWM_MODE, hwmgr->fan_ctrl_default_mode);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, TMIN, hwmgr->tmin);\r\nhwmgr->fan_ctrl_is_in_default_mode = true;\r\n}\r\nreturn 0;\r\n}\r\nint smu7_fan_ctrl_start_smc_fan_control(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_ODFuzzyFanControlSupport)) {\r\ncgs_write_register(hwmgr->device, mmSMC_MSG_ARG_0, FAN_CONTROL_FUZZY);\r\nresult = smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StartFanControl);\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_FanSpeedInTableIsRPM))\r\nhwmgr->hwmgr_func->set_max_fan_rpm_output(hwmgr,\r\nhwmgr->thermal_controller.\r\nadvanceFanControlParameters.usMaxFanRPM);\r\nelse\r\nhwmgr->hwmgr_func->set_max_fan_pwm_output(hwmgr,\r\nhwmgr->thermal_controller.\r\nadvanceFanControlParameters.usMaxFanPWM);\r\n} else {\r\ncgs_write_register(hwmgr->device, mmSMC_MSG_ARG_0, FAN_CONTROL_TABLE);\r\nresult = smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StartFanControl);\r\n}\r\nif (!result && hwmgr->thermal_controller.\r\nadvanceFanControlParameters.ucTargetTemperature)\r\nresult = smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_SetFanTemperatureTarget,\r\nhwmgr->thermal_controller.\r\nadvanceFanControlParameters.ucTargetTemperature);\r\nhwmgr->fan_ctrl_enabled = true;\r\nreturn result;\r\n}\r\nint smu7_fan_ctrl_stop_smc_fan_control(struct pp_hwmgr *hwmgr)\r\n{\r\nhwmgr->fan_ctrl_enabled = false;\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StopFanControl);\r\n}\r\nint smu7_fan_ctrl_set_fan_speed_percent(struct pp_hwmgr *hwmgr,\r\nuint32_t speed)\r\n{\r\nuint32_t duty100;\r\nuint32_t duty;\r\nuint64_t tmp64;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn 0;\r\nif (speed > 100)\r\nspeed = 100;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_MicrocodeFanControl))\r\nsmu7_fan_ctrl_stop_smc_fan_control(hwmgr);\r\nduty100 = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL1, FMAX_DUTY100);\r\nif (duty100 == 0)\r\nreturn -EINVAL;\r\ntmp64 = (uint64_t)speed * duty100;\r\ndo_div(tmp64, 100);\r\nduty = (uint32_t)tmp64;\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL0, FDO_STATIC_DUTY, duty);\r\nreturn smu7_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\n}\r\nint smu7_fan_ctrl_reset_fan_speed_to_default(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_MicrocodeFanControl)) {\r\nresult = smu7_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\nif (!result)\r\nresult = smu7_fan_ctrl_start_smc_fan_control(hwmgr);\r\n} else\r\nresult = smu7_fan_ctrl_set_default_mode(hwmgr);\r\nreturn result;\r\n}\r\nint smu7_fan_ctrl_set_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t speed)\r\n{\r\nuint32_t tach_period;\r\nuint32_t crystal_clock_freq;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan ||\r\n(hwmgr->thermal_controller.fanInfo.\r\nucTachometerPulsesPerRevolution == 0) ||\r\n(speed < hwmgr->thermal_controller.fanInfo.ulMinRPM) ||\r\n(speed > hwmgr->thermal_controller.fanInfo.ulMaxRPM))\r\nreturn 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_MicrocodeFanControl))\r\nsmu7_fan_ctrl_stop_smc_fan_control(hwmgr);\r\ncrystal_clock_freq = smu7_get_xclk(hwmgr);\r\ntach_period = 60 * crystal_clock_freq * 10000 / (8 * speed);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_TACH_STATUS, TACH_PERIOD, tach_period);\r\nreturn smu7_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC_RPM);\r\n}\r\nint smu7_thermal_get_temperature(struct pp_hwmgr *hwmgr)\r\n{\r\nint temp;\r\ntemp = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_MULT_THERMAL_STATUS, CTF_TEMP);\r\nif (temp & 0x200)\r\ntemp = SMU7_THERMAL_MAXIMUM_TEMP_READING;\r\nelse\r\ntemp = temp & 0x1ff;\r\ntemp *= PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nreturn temp;\r\n}\r\nstatic int smu7_thermal_set_temperature_range(struct pp_hwmgr *hwmgr,\r\nuint32_t low_temp, uint32_t high_temp)\r\n{\r\nuint32_t low = SMU7_THERMAL_MINIMUM_ALERT_TEMP *\r\nPP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nuint32_t high = SMU7_THERMAL_MAXIMUM_ALERT_TEMP *\r\nPP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nif (low < low_temp)\r\nlow = low_temp;\r\nif (high > high_temp)\r\nhigh = high_temp;\r\nif (low > high)\r\nreturn -EINVAL;\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, DIG_THERM_INTH,\r\n(high / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, DIG_THERM_INTL,\r\n(low / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_CTRL, DIG_THERM_DPM,\r\n(high / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nreturn 0;\r\n}\r\nstatic int smu7_thermal_initialize(struct pp_hwmgr *hwmgr)\r\n{\r\nif (hwmgr->thermal_controller.fanInfo.ucTachometerPulsesPerRevolution)\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_TACH_CTRL, EDGE_PER_REV,\r\nhwmgr->thermal_controller.fanInfo.\r\nucTachometerPulsesPerRevolution - 1);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_FDO_CTRL2, TACH_PWM_RESP_RATE, 0x28);\r\nreturn 0;\r\n}\r\nint smu7_thermal_enable_alert(struct pp_hwmgr *hwmgr)\r\n{\r\nuint32_t alert;\r\nalert = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, THERM_INT_MASK);\r\nalert &= ~(SMU7_THERMAL_HIGH_ALERT_MASK | SMU7_THERMAL_LOW_ALERT_MASK);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, THERM_INT_MASK, alert);\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_MSG_Thermal_Cntl_Enable);\r\n}\r\nint smu7_thermal_disable_alert(struct pp_hwmgr *hwmgr)\r\n{\r\nuint32_t alert;\r\nalert = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, THERM_INT_MASK);\r\nalert |= (SMU7_THERMAL_HIGH_ALERT_MASK | SMU7_THERMAL_LOW_ALERT_MASK);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_THERMAL_INT, THERM_INT_MASK, alert);\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_MSG_Thermal_Cntl_Disable);\r\n}\r\nint smu7_thermal_stop_thermal_controller(struct pp_hwmgr *hwmgr)\r\n{\r\nint result = smu7_thermal_disable_alert(hwmgr);\r\nif (!hwmgr->thermal_controller.fanInfo.bNoFan)\r\nsmu7_fan_ctrl_set_default_mode(hwmgr);\r\nreturn result;\r\n}\r\nstatic int tf_smu7_thermal_start_smc_fan_control(struct pp_hwmgr *hwmgr,\r\nvoid *input, void *output, void *storage, int result)\r\n{\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_MicrocodeFanControl)) {\r\nsmu7_fan_ctrl_start_smc_fan_control(hwmgr);\r\nsmu7_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tf_smu7_thermal_set_temperature_range(struct pp_hwmgr *hwmgr,\r\nvoid *input, void *output, void *storage, int result)\r\n{\r\nstruct PP_TemperatureRange *range = (struct PP_TemperatureRange *)input;\r\nif (range == NULL)\r\nreturn -EINVAL;\r\nreturn smu7_thermal_set_temperature_range(hwmgr, range->min, range->max);\r\n}\r\nstatic int tf_smu7_thermal_initialize(struct pp_hwmgr *hwmgr,\r\nvoid *input, void *output, void *storage, int result)\r\n{\r\nreturn smu7_thermal_initialize(hwmgr);\r\n}\r\nstatic int tf_smu7_thermal_enable_alert(struct pp_hwmgr *hwmgr,\r\nvoid *input, void *output, void *storage, int result)\r\n{\r\nreturn smu7_thermal_enable_alert(hwmgr);\r\n}\r\nstatic int tf_smu7_thermal_disable_alert(struct pp_hwmgr *hwmgr,\r\nvoid *input, void *output, void *storage, int result)\r\n{\r\nreturn smu7_thermal_disable_alert(hwmgr);\r\n}\r\nint smu7_thermal_ctrl_uninitialize_thermal_controller(struct pp_hwmgr *hwmgr)\r\n{\r\nif (!hwmgr->thermal_controller.fanInfo.bNoFan)\r\nsmu7_fan_ctrl_set_default_mode(hwmgr);\r\nreturn 0;\r\n}\r\nint pp_smu7_thermal_initialize(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nresult = phm_construct_table(hwmgr,\r\n&phm_thermal_set_temperature_range_master,\r\n&(hwmgr->set_temperature_range));\r\nif (!result) {\r\nresult = phm_construct_table(hwmgr,\r\n&phm_thermal_start_thermal_controller_master,\r\n&(hwmgr->start_thermal_controller));\r\nif (result)\r\nphm_destroy_table(hwmgr, &(hwmgr->set_temperature_range));\r\n}\r\nif (!result)\r\nhwmgr->fan_ctrl_is_in_default_mode = true;\r\nreturn result;\r\n}\r\nvoid pp_smu7_thermal_fini(struct pp_hwmgr *hwmgr)\r\n{\r\nphm_destroy_table(hwmgr, &(hwmgr->set_temperature_range));\r\nphm_destroy_table(hwmgr, &(hwmgr->start_thermal_controller));\r\nreturn;\r\n}

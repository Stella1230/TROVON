static ssize_t out0_output_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pcf8591_data *data = i2c_get_clientdata(to_i2c_client(dev));\r\nreturn sprintf(buf, "%d\n", data->aout * 10);\r\n}\r\nstatic ssize_t out0_output_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned long val;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct pcf8591_data *data = i2c_get_clientdata(client);\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nval /= 10;\r\nif (val > 255)\r\nreturn -EINVAL;\r\ndata->aout = val;\r\ni2c_smbus_write_byte_data(client, data->control, data->aout);\r\nreturn count;\r\n}\r\nstatic ssize_t out0_enable_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pcf8591_data *data = i2c_get_clientdata(to_i2c_client(dev));\r\nreturn sprintf(buf, "%u\n", !(!(data->control & PCF8591_CONTROL_AOEF)));\r\n}\r\nstatic ssize_t out0_enable_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct pcf8591_data *data = i2c_get_clientdata(client);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nif (val)\r\ndata->control |= PCF8591_CONTROL_AOEF;\r\nelse\r\ndata->control &= ~PCF8591_CONTROL_AOEF;\r\ni2c_smbus_write_byte(client, data->control);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic int pcf8591_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pcf8591_data *data;\r\nint err;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct pcf8591_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\npcf8591_init_client(client);\r\nerr = sysfs_create_group(&client->dev.kobj, &pcf8591_attr_group);\r\nif (err)\r\nreturn err;\r\nif (input_mode != 3) {\r\nerr = device_create_file(&client->dev, &dev_attr_in2_input);\r\nif (err)\r\ngoto exit_sysfs_remove;\r\n}\r\nif (input_mode == 0) {\r\nerr = device_create_file(&client->dev, &dev_attr_in3_input);\r\nif (err)\r\ngoto exit_sysfs_remove;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_sysfs_remove;\r\n}\r\nreturn 0;\r\nexit_sysfs_remove:\r\nsysfs_remove_group(&client->dev.kobj, &pcf8591_attr_group_opt);\r\nsysfs_remove_group(&client->dev.kobj, &pcf8591_attr_group);\r\nreturn err;\r\n}\r\nstatic int pcf8591_remove(struct i2c_client *client)\r\n{\r\nstruct pcf8591_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &pcf8591_attr_group_opt);\r\nsysfs_remove_group(&client->dev.kobj, &pcf8591_attr_group);\r\nreturn 0;\r\n}\r\nstatic void pcf8591_init_client(struct i2c_client *client)\r\n{\r\nstruct pcf8591_data *data = i2c_get_clientdata(client);\r\ndata->control = PCF8591_INIT_CONTROL;\r\ndata->aout = PCF8591_INIT_AOUT;\r\ni2c_smbus_write_byte_data(client, data->control, data->aout);\r\ni2c_smbus_read_byte(client);\r\n}\r\nstatic int pcf8591_read_channel(struct device *dev, int channel)\r\n{\r\nu8 value;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct pcf8591_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->update_lock);\r\nif ((data->control & PCF8591_CONTROL_AICH_MASK) != channel) {\r\ndata->control = (data->control & ~PCF8591_CONTROL_AICH_MASK)\r\n| channel;\r\ni2c_smbus_write_byte(client, data->control);\r\ni2c_smbus_read_byte(client);\r\n}\r\nvalue = i2c_smbus_read_byte(client);\r\nmutex_unlock(&data->update_lock);\r\nif ((channel == 2 && input_mode == 2) ||\r\n(channel != 3 && (input_mode == 1 || input_mode == 3)))\r\nreturn 10 * REG_TO_SIGNED(value);\r\nelse\r\nreturn 10 * value;\r\n}\r\nstatic int __init pcf8591_init(void)\r\n{\r\nif (input_mode < 0 || input_mode > 3) {\r\npr_warn("invalid input_mode (%d)\n", input_mode);\r\ninput_mode = 0;\r\n}\r\nreturn i2c_add_driver(&pcf8591_driver);\r\n}\r\nstatic void __exit pcf8591_exit(void)\r\n{\r\ni2c_del_driver(&pcf8591_driver);\r\n}

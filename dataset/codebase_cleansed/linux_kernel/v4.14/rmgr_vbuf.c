static void rmgr_refcount_init_vbuf(void)\r\n{\r\nmemset(&handle_table, 0, sizeof(handle_table));\r\n}\r\nvoid ia_css_rmgr_refcount_retain_vbuf(struct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nint i;\r\nstruct ia_css_rmgr_vbuf_handle *h;\r\nif ((handle == NULL) || (*handle == NULL)) {\r\nIA_CSS_LOG("Invalid inputs");\r\nreturn;\r\n}\r\nif ((*handle)->count == 0) {\r\nh = *handle;\r\n*handle = NULL;\r\nfor (i = 0; i < NUM_HANDLES; i++) {\r\nif (handle_table[i].count == 0) {\r\n*handle = &handle_table[i];\r\nbreak;\r\n}\r\n}\r\nif (*handle == NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_ERROR,\r\n"ia_css_i_host_refcount_retain_vbuf() failed to find empty slot!\n");\r\nreturn;\r\n}\r\n(*handle)->vptr = h->vptr;\r\n(*handle)->size = h->size;\r\n}\r\n(*handle)->count++;\r\n}\r\nvoid ia_css_rmgr_refcount_release_vbuf(struct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nif ((handle == NULL) || ((*handle) == NULL) || (((*handle)->count) == 0)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_ERROR,\r\n"ia_css_rmgr_refcount_release_vbuf() invalid arguments!\n");\r\nreturn;\r\n}\r\n(*handle)->count--;\r\nif ((*handle)->count == 0) {\r\n(*handle)->vptr = 0x0;\r\n(*handle)->size = 0;\r\n*handle = NULL;\r\n}\r\n}\r\nenum ia_css_err ia_css_rmgr_init_vbuf(struct ia_css_rmgr_vbuf_pool *pool)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nsize_t bytes_needed;\r\nrmgr_refcount_init_vbuf();\r\nassert(pool != NULL);\r\nif (pool == NULL)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nif (pool->recycle && pool->size) {\r\nbytes_needed =\r\nsizeof(void *) *\r\npool->size;\r\npool->handles = sh_css_malloc(bytes_needed);\r\nif (pool->handles != NULL)\r\nmemset(pool->handles, 0, bytes_needed);\r\nelse\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n} else {\r\npool->size = 0;\r\npool->handles = NULL;\r\n}\r\nreturn err;\r\n}\r\nvoid ia_css_rmgr_uninit_vbuf(struct ia_css_rmgr_vbuf_pool *pool)\r\n{\r\nuint32_t i;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "ia_css_rmgr_uninit_vbuf()\n");\r\nif (pool == NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_ERROR, "ia_css_rmgr_uninit_vbuf(): NULL argument\n");\r\nreturn;\r\n}\r\nif (pool->handles != NULL) {\r\nfor (i = 0; i < pool->size; i++) {\r\nif (pool->handles[i] != NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n" freeing/releasing %x (count=%d)\n",\r\npool->handles[i]->vptr,\r\npool->handles[i]->count);\r\nhmm_free(pool->handles[i]->vptr);\r\nia_css_rmgr_refcount_release_vbuf(\r\n&pool->handles[i]);\r\n}\r\n}\r\nsh_css_free(pool->handles);\r\npool->handles = NULL;\r\n}\r\n}\r\nstatic\r\nvoid rmgr_push_handle(struct ia_css_rmgr_vbuf_pool *pool,\r\nstruct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nuint32_t i;\r\nbool succes = false;\r\nassert(pool != NULL);\r\nassert(pool->recycle);\r\nassert(pool->handles != NULL);\r\nassert(handle != NULL);\r\nfor (i = 0; i < pool->size; i++) {\r\nif (pool->handles[i] == NULL) {\r\nia_css_rmgr_refcount_retain_vbuf(handle);\r\npool->handles[i] = *handle;\r\nsucces = true;\r\nbreak;\r\n}\r\n}\r\nassert(succes);\r\n}\r\nstatic\r\nvoid rmgr_pop_handle(struct ia_css_rmgr_vbuf_pool *pool,\r\nstruct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nuint32_t i;\r\nbool succes = false;\r\nassert(pool != NULL);\r\nassert(pool->recycle);\r\nassert(pool->handles != NULL);\r\nassert(handle != NULL);\r\nassert(*handle != NULL);\r\nfor (i = 0; i < pool->size; i++) {\r\nif ((pool->handles[i] != NULL) &&\r\n(pool->handles[i]->size == (*handle)->size)) {\r\n*handle = pool->handles[i];\r\npool->handles[i] = NULL;\r\nsucces = true;\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid ia_css_rmgr_acq_vbuf(struct ia_css_rmgr_vbuf_pool *pool,\r\nstruct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nstruct ia_css_rmgr_vbuf_handle h;\r\nif ((pool == NULL) || (handle == NULL) || (*handle == NULL)) {\r\nIA_CSS_LOG("Invalid inputs");\r\nreturn;\r\n}\r\nif (pool->copy_on_write) {\r\nif ((*handle)->count == 1)\r\nreturn;\r\nif ((*handle)->count > 1) {\r\nh.vptr = 0x0;\r\nh.size = (*handle)->size;\r\nia_css_rmgr_refcount_release_vbuf(handle);\r\n*handle = &h;\r\n}\r\nif ((*handle)->vptr == 0x0) {\r\nif (pool->recycle) {\r\nrmgr_pop_handle(pool, handle);\r\n}\r\nif ((*handle)->vptr == 0x0) {\r\n(*handle)->vptr = mmgr_malloc((*handle)->size);\r\n} else {\r\nreturn;\r\n}\r\n}\r\n}\r\nia_css_rmgr_refcount_retain_vbuf(handle);\r\n}\r\nvoid ia_css_rmgr_rel_vbuf(struct ia_css_rmgr_vbuf_pool *pool,\r\nstruct ia_css_rmgr_vbuf_handle **handle)\r\n{\r\nif ((pool == NULL) || (handle == NULL) || (*handle == NULL)) {\r\nIA_CSS_LOG("Invalid inputs");\r\nreturn;\r\n}\r\nif ((*handle)->count == 1) {\r\nif (!pool->recycle) {\r\nhmm_free((*handle)->vptr);\r\n} else {\r\nrmgr_push_handle(pool, handle);\r\n}\r\n}\r\nia_css_rmgr_refcount_release_vbuf(handle);\r\n*handle = NULL;\r\n}

static void odm_SetCrystalCap(void *pDM_VOID, u8 CrystalCap)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\nbool bEEPROMCheck;\r\nstruct adapter *Adapter = pDM_Odm->Adapter;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nbEEPROMCheck = (pHalData->EEPROMVersion >= 0x01) ? true : false;\r\nif (pCfoTrack->CrystalCap == CrystalCap)\r\nreturn;\r\npCfoTrack->CrystalCap = CrystalCap;\r\nCrystalCap = CrystalCap & 0x3F;\r\nPHY_SetBBReg(\r\npDM_Odm->Adapter,\r\nREG_MAC_PHY_CTRL,\r\n0x00FFF000,\r\n(CrystalCap | (CrystalCap << 6))\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_SetCrystalCap(): CrystalCap = 0x%x\n",\r\nCrystalCap\r\n)\r\n);\r\n}\r\nstatic u8 odm_GetDefaultCrytaltalCap(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nu8 CrystalCap = 0x20;\r\nstruct adapter *Adapter = pDM_Odm->Adapter;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nCrystalCap = pHalData->CrystalCap;\r\nCrystalCap = CrystalCap & 0x3f;\r\nreturn CrystalCap;\r\n}\r\nstatic void odm_SetATCStatus(void *pDM_VOID, bool ATCStatus)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\nif (pCfoTrack->bATCStatus == ATCStatus)\r\nreturn;\r\nPHY_SetBBReg(\r\npDM_Odm->Adapter,\r\nODM_REG(BB_ATC, pDM_Odm),\r\nODM_BIT(BB_ATC, pDM_Odm),\r\nATCStatus\r\n);\r\npCfoTrack->bATCStatus = ATCStatus;\r\n}\r\nstatic bool odm_GetATCStatus(void *pDM_VOID)\r\n{\r\nbool ATCStatus;\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nATCStatus = (bool)PHY_QueryBBReg(\r\npDM_Odm->Adapter,\r\nODM_REG(BB_ATC, pDM_Odm),\r\nODM_BIT(BB_ATC, pDM_Odm)\r\n);\r\nreturn ATCStatus;\r\n}\r\nvoid ODM_CfoTrackingReset(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\npCfoTrack->DefXCap = odm_GetDefaultCrytaltalCap(pDM_Odm);\r\npCfoTrack->bAdjust = true;\r\nodm_SetCrystalCap(pDM_Odm, pCfoTrack->DefXCap);\r\nodm_SetATCStatus(pDM_Odm, true);\r\n}\r\nvoid ODM_CfoTrackingInit(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\npCfoTrack->DefXCap =\r\npCfoTrack->CrystalCap = odm_GetDefaultCrytaltalCap(pDM_Odm);\r\npCfoTrack->bATCStatus = odm_GetATCStatus(pDM_Odm);\r\npCfoTrack->bAdjust = true;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking_init() =========>\n")\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking_init(): bATCStatus = %d, CrystalCap = 0x%x\n",\r\npCfoTrack->bATCStatus,\r\npCfoTrack->DefXCap\r\n)\r\n);\r\n}\r\nvoid ODM_CfoTracking(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\nint CFO_kHz_A, CFO_kHz_B, CFO_ave = 0;\r\nint CFO_ave_diff;\r\nint CrystalCap = (int)pCfoTrack->CrystalCap;\r\nu8 Adjust_Xtal = 1;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_CFO_TRACKING)) {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking(): Return: SupportAbility ODM_BB_CFO_TRACKING is disabled\n")\r\n);\r\nreturn;\r\n}\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking() =========>\n")\r\n);\r\nif (!pDM_Odm->bLinked || !pDM_Odm->bOneEntryOnly) {\r\nODM_CfoTrackingReset(pDM_Odm);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking(): Reset: bLinked = %d, bOneEntryOnly = %d\n",\r\npDM_Odm->bLinked,\r\npDM_Odm->bOneEntryOnly\r\n)\r\n);\r\n} else {\r\nif (pCfoTrack->packetCount == pCfoTrack->packetCount_pre) {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking(): packet counter doesn't change\n"\r\n)\r\n);\r\nreturn;\r\n}\r\npCfoTrack->packetCount_pre = pCfoTrack->packetCount;\r\nCFO_kHz_A = (int)(pCfoTrack->CFO_tail[0] * 3125) / 1280;\r\nCFO_kHz_B = (int)(pCfoTrack->CFO_tail[1] * 3125) / 1280;\r\nif (pDM_Odm->RFType < ODM_2T2R)\r\nCFO_ave = CFO_kHz_A;\r\nelse\r\nCFO_ave = (int)(CFO_kHz_A + CFO_kHz_B) >> 1;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking(): CFO_kHz_A = %dkHz, CFO_kHz_B = %dkHz, CFO_ave = %dkHz\n",\r\nCFO_kHz_A,\r\nCFO_kHz_B,\r\nCFO_ave\r\n)\r\n);\r\nCFO_ave_diff =\r\n(pCfoTrack->CFO_ave_pre >= CFO_ave) ?\r\n(pCfoTrack->CFO_ave_pre-CFO_ave) :\r\n(CFO_ave-pCfoTrack->CFO_ave_pre);\r\nif (\r\nCFO_ave_diff > 20 &&\r\npCfoTrack->largeCFOHit == 0 &&\r\n!pCfoTrack->bAdjust\r\n) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CFO_TRACKING, ODM_DBG_LOUD, ("ODM_CfoTracking(): first large CFO hit\n"));\r\npCfoTrack->largeCFOHit = 1;\r\nreturn;\r\n} else\r\npCfoTrack->largeCFOHit = 0;\r\npCfoTrack->CFO_ave_pre = CFO_ave;\r\nif (pCfoTrack->bAdjust == false) {\r\nif (CFO_ave > CFO_TH_XTAL_HIGH || CFO_ave < (-CFO_TH_XTAL_HIGH))\r\npCfoTrack->bAdjust = true;\r\n} else {\r\nif (CFO_ave < CFO_TH_XTAL_LOW && CFO_ave > (-CFO_TH_XTAL_LOW))\r\npCfoTrack->bAdjust = false;\r\n}\r\nif (pDM_Odm->bBtEnabled) {\r\npCfoTrack->bAdjust = false;\r\nodm_SetCrystalCap(pDM_Odm, pCfoTrack->DefXCap);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking(): Disable CFO tracking for BT!!\n")\r\n);\r\n}\r\nif (pCfoTrack->bAdjust) {\r\nif (CFO_ave > CFO_TH_XTAL_LOW)\r\nAdjust_Xtal = Adjust_Xtal+((CFO_ave-CFO_TH_XTAL_LOW)>>2);\r\nelse if (CFO_ave < (-CFO_TH_XTAL_LOW))\r\nAdjust_Xtal = Adjust_Xtal+((CFO_TH_XTAL_LOW-CFO_ave)>>2);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking(): Crystal cap offset = %d\n",\r\nAdjust_Xtal\r\n)\r\n);\r\n}\r\nif (pCfoTrack->bAdjust) {\r\nif (CFO_ave > CFO_TH_XTAL_LOW)\r\nCrystalCap = CrystalCap + Adjust_Xtal;\r\nelse if (CFO_ave < (-CFO_TH_XTAL_LOW))\r\nCrystalCap = CrystalCap - Adjust_Xtal;\r\nif (CrystalCap > 0x3f)\r\nCrystalCap = 0x3f;\r\nelse if (CrystalCap < 0)\r\nCrystalCap = 0;\r\nodm_SetCrystalCap(pDM_Odm, (u8)CrystalCap);\r\n}\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n(\r\n"ODM_CfoTracking(): Crystal cap = 0x%x, Default Crystal cap = 0x%x\n",\r\npCfoTrack->CrystalCap,\r\npCfoTrack->DefXCap\r\n)\r\n);\r\nif (CFO_ave < CFO_TH_ATC && CFO_ave > -CFO_TH_ATC) {\r\nodm_SetATCStatus(pDM_Odm, false);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking(): Disable ATC!!\n")\r\n);\r\n} else {\r\nodm_SetATCStatus(pDM_Odm, true);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CFO_TRACKING,\r\nODM_DBG_LOUD,\r\n("ODM_CfoTracking(): Enable ATC!!\n")\r\n);\r\n}\r\n}\r\n}\r\nvoid ODM_ParsingCFO(void *pDM_VOID, void *pPktinfo_VOID, s8 *pcfotail)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPODM_PACKET_INFO_T pPktinfo = (PODM_PACKET_INFO_T)pPktinfo_VOID;\r\nPCFO_TRACKING pCfoTrack = &pDM_Odm->DM_CfoTrack;\r\nu8 i;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_CFO_TRACKING))\r\nreturn;\r\nif (pPktinfo->StationID != 0) {\r\nfor (i = ODM_RF_PATH_A; i <= ODM_RF_PATH_B; i++)\r\npCfoTrack->CFO_tail[i] = (int)pcfotail[i];\r\nif (pCfoTrack->packetCount == 0xffffffff)\r\npCfoTrack->packetCount = 0;\r\nelse\r\npCfoTrack->packetCount++;\r\n}\r\n}

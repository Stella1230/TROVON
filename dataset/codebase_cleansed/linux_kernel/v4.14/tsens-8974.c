static int calibrate_8974(struct tsens_device *tmdev)\r\n{\r\nint base1 = 0, base2 = 0, i;\r\nu32 p1[11], p2[11];\r\nint mode = 0;\r\nu32 *calib, *bkp;\r\nu32 calib_redun_sel;\r\ncalib = (u32 *)qfprom_read(tmdev->dev, "calib");\r\nif (IS_ERR(calib))\r\nreturn PTR_ERR(calib);\r\nbkp = (u32 *)qfprom_read(tmdev->dev, "calib_backup");\r\nif (IS_ERR(bkp))\r\nreturn PTR_ERR(bkp);\r\ncalib_redun_sel = bkp[1] & BKP_REDUN_SEL;\r\ncalib_redun_sel >>= BKP_REDUN_SHIFT;\r\nif (calib_redun_sel == BKP_SEL) {\r\nmode = (calib[4] & CAL_SEL_0_1) >> CAL_SEL_SHIFT;\r\nmode |= (calib[5] & CAL_SEL_2) >> CAL_SEL_SHIFT_2;\r\nswitch (mode) {\r\ncase TWO_PT_CALIB:\r\nbase2 = (bkp[2] & BASE2_BKP_MASK) >> BASE2_BKP_SHIFT;\r\np2[0] = (bkp[2] & S0_P2_BKP_MASK) >> S0_P2_BKP_SHIFT;\r\np2[1] = (bkp[3] & S1_P2_BKP_MASK);\r\np2[2] = (bkp[3] & S2_P2_BKP_MASK) >> S2_P2_BKP_SHIFT;\r\np2[3] = (bkp[3] & S3_P2_BKP_MASK) >> S3_P2_BKP_SHIFT;\r\np2[4] = (bkp[3] & S4_P2_BKP_MASK) >> S4_P2_BKP_SHIFT;\r\np2[5] = (calib[4] & S5_P2_BKP_MASK) >> S5_P2_BKP_SHIFT;\r\np2[6] = (calib[5] & S6_P2_BKP_MASK);\r\np2[7] = (calib[5] & S7_P2_BKP_MASK) >> S7_P2_BKP_SHIFT;\r\np2[8] = (calib[5] & S8_P2_BKP_MASK) >> S8_P2_BKP_SHIFT;\r\np2[9] = (calib[5] & S9_P2_BKP_MASK) >> S9_P2_BKP_SHIFT;\r\np2[10] = (calib[5] & S10_P2_BKP_MASK) >> S10_P2_BKP_SHIFT;\r\ncase ONE_PT_CALIB:\r\ncase ONE_PT_CALIB2:\r\nbase1 = bkp[0] & BASE1_MASK;\r\np1[0] = (bkp[0] & S0_P1_MASK) >> S0_P1_SHIFT;\r\np1[1] = (bkp[0] & S1_P1_MASK) >> S1_P1_SHIFT;\r\np1[2] = (bkp[0] & S2_P1_MASK) >> S2_P1_SHIFT;\r\np1[3] = (bkp[0] & S3_P1_MASK) >> S3_P1_SHIFT;\r\np1[4] = (bkp[1] & S4_P1_MASK);\r\np1[5] = (bkp[1] & S5_P1_MASK) >> S5_P1_SHIFT;\r\np1[6] = (bkp[1] & S6_P1_MASK) >> S6_P1_SHIFT;\r\np1[7] = (bkp[1] & S7_P1_MASK) >> S7_P1_SHIFT;\r\np1[8] = (bkp[2] & S8_P1_MASK_BKP) >> S8_P1_SHIFT;\r\np1[9] = (bkp[2] & S9_P1_MASK_BKP) >> S9_P1_BKP_SHIFT;\r\np1[10] = (bkp[2] & S10_P1_MASK_BKP) >> S10_P1_BKP_SHIFT;\r\nbreak;\r\n}\r\n} else {\r\nmode = (calib[1] & CAL_SEL_0_1) >> CAL_SEL_SHIFT;\r\nmode |= (calib[3] & CAL_SEL_2) >> CAL_SEL_SHIFT_2;\r\nswitch (mode) {\r\ncase TWO_PT_CALIB:\r\nbase2 = (calib[2] & BASE2_MASK) >> BASE2_SHIFT;\r\np2[0] = (calib[2] & S0_P2_MASK) >> S0_P2_SHIFT;\r\np2[1] = (calib[2] & S1_P2_MASK) >> S1_P2_SHIFT;\r\np2[2] = (calib[3] & S2_P2_MASK);\r\np2[3] = (calib[3] & S3_P2_MASK) >> S3_P2_SHIFT;\r\np2[4] = (calib[3] & S4_P2_MASK) >> S4_P2_SHIFT;\r\np2[5] = (calib[3] & S5_P2_MASK) >> S5_P2_SHIFT;\r\np2[6] = (calib[3] & S6_P2_MASK) >> S6_P2_SHIFT;\r\np2[7] = (calib[4] & S7_P2_MASK);\r\np2[8] = (calib[4] & S8_P2_MASK) >> S8_P2_SHIFT;\r\np2[9] = (calib[4] & S9_P2_MASK) >> S9_P2_SHIFT;\r\np2[10] = (calib[4] & S10_P2_MASK) >> S10_P2_SHIFT;\r\ncase ONE_PT_CALIB:\r\ncase ONE_PT_CALIB2:\r\nbase1 = calib[0] & BASE1_MASK;\r\np1[0] = (calib[0] & S0_P1_MASK) >> S0_P1_SHIFT;\r\np1[1] = (calib[0] & S1_P1_MASK) >> S1_P1_SHIFT;\r\np1[2] = (calib[0] & S2_P1_MASK) >> S2_P1_SHIFT;\r\np1[3] = (calib[0] & S3_P1_MASK) >> S3_P1_SHIFT;\r\np1[4] = (calib[1] & S4_P1_MASK);\r\np1[5] = (calib[1] & S5_P1_MASK) >> S5_P1_SHIFT;\r\np1[6] = (calib[1] & S6_P1_MASK) >> S6_P1_SHIFT;\r\np1[7] = (calib[1] & S7_P1_MASK) >> S7_P1_SHIFT;\r\np1[8] = (calib[1] & S8_P1_MASK) >> S8_P1_SHIFT;\r\np1[9] = (calib[2] & S9_P1_MASK);\r\np1[10] = (calib[2] & S10_P1_MASK) >> S10_P1_SHIFT;\r\nbreak;\r\n}\r\n}\r\nswitch (mode) {\r\ncase ONE_PT_CALIB:\r\nfor (i = 0; i < tmdev->num_sensors; i++)\r\np1[i] += (base1 << 2) | BIT_APPEND;\r\nbreak;\r\ncase TWO_PT_CALIB:\r\nfor (i = 0; i < tmdev->num_sensors; i++) {\r\np2[i] += base2;\r\np2[i] <<= 2;\r\np2[i] |= BIT_APPEND;\r\n}\r\ncase ONE_PT_CALIB2:\r\nfor (i = 0; i < tmdev->num_sensors; i++) {\r\np1[i] += base1;\r\np1[i] <<= 2;\r\np1[i] |= BIT_APPEND;\r\n}\r\nbreak;\r\ndefault:\r\nfor (i = 0; i < tmdev->num_sensors; i++)\r\np2[i] = 780;\r\np1[0] = 502;\r\np1[1] = 509;\r\np1[2] = 503;\r\np1[3] = 509;\r\np1[4] = 505;\r\np1[5] = 509;\r\np1[6] = 507;\r\np1[7] = 510;\r\np1[8] = 508;\r\np1[9] = 509;\r\np1[10] = 508;\r\nbreak;\r\n}\r\ncompute_intercept_slope(tmdev, p1, p2, mode);\r\nreturn 0;\r\n}

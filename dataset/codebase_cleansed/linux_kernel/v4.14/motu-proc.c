static void proc_read_clock(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_motu *motu = entry->private_data;\r\nconst struct snd_motu_protocol *const protocol = motu->spec->protocol;\r\nunsigned int rate;\r\nenum snd_motu_clock_source source;\r\nif (protocol->get_clock_rate(motu, &rate) < 0)\r\nreturn;\r\nif (protocol->get_clock_source(motu, &source) < 0)\r\nreturn;\r\nsnd_iprintf(buffer, "Rate:\t%d\n", rate);\r\nsnd_iprintf(buffer, "Source:\t%s\n", clock_names[source]);\r\n}\r\nstatic void proc_read_format(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_motu *motu = entry->private_data;\r\nconst struct snd_motu_protocol *const protocol = motu->spec->protocol;\r\nunsigned int mode;\r\nstruct snd_motu_packet_format *formats;\r\nint i;\r\nif (protocol->cache_packet_formats(motu) < 0)\r\nreturn;\r\nsnd_iprintf(buffer, "tx:\tmsg\tfixed\tdiffered\n");\r\nfor (i = 0; i < SND_MOTU_CLOCK_RATE_COUNT; ++i) {\r\nmode = i >> 1;\r\nformats = &motu->tx_packet_formats;\r\nsnd_iprintf(buffer,\r\n"%u:\t%u\t%u\t%u\n",\r\nsnd_motu_clock_rates[i],\r\nformats->msg_chunks,\r\nformats->fixed_part_pcm_chunks[mode],\r\nformats->differed_part_pcm_chunks[mode]);\r\n}\r\nsnd_iprintf(buffer, "rx:\tmsg\tfixed\tdiffered\n");\r\nfor (i = 0; i < SND_MOTU_CLOCK_RATE_COUNT; ++i) {\r\nmode = i >> 1;\r\nformats = &motu->rx_packet_formats;\r\nsnd_iprintf(buffer,\r\n"%u:\t%u\t%u\t%u\n",\r\nsnd_motu_clock_rates[i],\r\nformats->msg_chunks,\r\nformats->fixed_part_pcm_chunks[mode],\r\nformats->differed_part_pcm_chunks[mode]);\r\n}\r\n}\r\nstatic void add_node(struct snd_motu *motu, struct snd_info_entry *root,\r\nconst char *name,\r\nvoid (*op)(struct snd_info_entry *e,\r\nstruct snd_info_buffer *b))\r\n{\r\nstruct snd_info_entry *entry;\r\nentry = snd_info_create_card_entry(motu->card, name, root);\r\nif (entry == NULL)\r\nreturn;\r\nsnd_info_set_text_ops(entry, motu, op);\r\nif (snd_info_register(entry) < 0)\r\nsnd_info_free_entry(entry);\r\n}\r\nvoid snd_motu_proc_init(struct snd_motu *motu)\r\n{\r\nstruct snd_info_entry *root;\r\nroot = snd_info_create_card_entry(motu->card, "firewire",\r\nmotu->card->proc_root);\r\nif (root == NULL)\r\nreturn;\r\nroot->mode = S_IFDIR | S_IRUGO | S_IXUGO;\r\nif (snd_info_register(root) < 0) {\r\nsnd_info_free_entry(root);\r\nreturn;\r\n}\r\nadd_node(motu, root, "clock", proc_read_clock);\r\nadd_node(motu, root, "format", proc_read_format);\r\n}

void\r\nia_css_ob_configure(\r\nstruct sh_css_isp_ob_stream_config *config,\r\nunsigned int isp_pipe_version,\r\nunsigned int raw_bit_depth)\r\n{\r\nconfig->isp_pipe_version = isp_pipe_version;\r\nconfig->raw_bit_depth = raw_bit_depth;\r\n}\r\nvoid\r\nia_css_ob_encode(\r\nstruct sh_css_isp_ob_params *to,\r\nconst struct ia_css_ob_config *from,\r\nconst struct sh_css_isp_ob_stream_config *config,\r\nunsigned size)\r\n{\r\nunsigned int ob_bit_depth\r\n= config->isp_pipe_version == 2 ? SH_CSS_BAYER_BITS : config->raw_bit_depth;\r\nunsigned int scale = 16 - ob_bit_depth;\r\n(void)size;\r\nswitch (from->mode) {\r\ncase IA_CSS_OB_MODE_FIXED:\r\nto->blacklevel_gr = from->level_gr >> scale;\r\nto->blacklevel_r = from->level_r >> scale;\r\nto->blacklevel_b = from->level_b >> scale;\r\nto->blacklevel_gb = from->level_gb >> scale;\r\nto->area_start_bq = 0;\r\nto->area_length_bq = 0;\r\nto->area_length_bq_inverse = 0;\r\nbreak;\r\ncase IA_CSS_OB_MODE_RASTER:\r\nto->blacklevel_gr = 0;\r\nto->blacklevel_r = 0;\r\nto->blacklevel_b = 0;\r\nto->blacklevel_gb = 0;\r\nto->area_start_bq = from->start_position;\r\nto->area_length_bq =\r\n(from->end_position - from->start_position) + 1;\r\nto->area_length_bq_inverse = AREA_LENGTH_UNIT / to->area_length_bq;\r\nbreak;\r\ndefault:\r\nto->blacklevel_gr = 0;\r\nto->blacklevel_r = 0;\r\nto->blacklevel_b = 0;\r\nto->blacklevel_gb = 0;\r\nto->area_start_bq = 0;\r\nto->area_length_bq = 0;\r\nto->area_length_bq_inverse = 0;\r\nbreak;\r\n}\r\n}\r\nvoid\r\nia_css_ob_vmem_encode(\r\nstruct sh_css_isp_ob_vmem_params *to,\r\nconst struct ia_css_ob_config *from,\r\nconst struct sh_css_isp_ob_stream_config *config,\r\nunsigned size)\r\n{\r\nstruct sh_css_isp_ob_params tmp;\r\nstruct sh_css_isp_ob_params *ob = &tmp;\r\n(void)size;\r\nia_css_ob_encode(&tmp, from, config, sizeof(tmp));\r\n{\r\nunsigned i;\r\nunsigned sp_obarea_start_bq = ob->area_start_bq;\r\nunsigned sp_obarea_length_bq = ob->area_length_bq;\r\nunsigned low = sp_obarea_start_bq;\r\nunsigned high = low + sp_obarea_length_bq;\r\nuint16_t all_ones = ~0;\r\nfor (i = 0; i < OBAREA_MASK_SIZE; i++) {\r\nif (i >= low && i < high)\r\nto->vmask[i/ISP_VEC_NELEMS][i%ISP_VEC_NELEMS] = all_ones;\r\nelse\r\nto->vmask[i/ISP_VEC_NELEMS][i%ISP_VEC_NELEMS] = 0;\r\n}\r\n}\r\n}\r\nvoid\r\nia_css_ob_dump(\r\nconst struct sh_css_isp_ob_params *ob,\r\nunsigned level)\r\n{\r\nif (!ob) return;\r\nia_css_debug_dtrace(level, "Optical Black:\n");\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ob_blacklevel_gr", ob->blacklevel_gr);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ob_blacklevel_r", ob->blacklevel_r);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ob_blacklevel_b", ob->blacklevel_b);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"ob_blacklevel_gb", ob->blacklevel_gb);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"obarea_start_bq", ob->area_start_bq);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"obarea_length_bq", ob->area_length_bq);\r\nia_css_debug_dtrace(level, "\t%-32s = %d\n",\r\n"obarea_length_bq_inverse",\r\nob->area_length_bq_inverse);\r\n}\r\nvoid\r\nia_css_ob_debug_dtrace(\r\nconst struct ia_css_ob_config *config,\r\nunsigned level)\r\n{\r\nia_css_debug_dtrace(level,\r\n"config.mode=%d, "\r\n"config.level_gr=%d, config.level_r=%d, "\r\n"config.level_b=%d, config.level_gb=%d, "\r\n"config.start_position=%d, config.end_position=%d\n",\r\nconfig->mode,\r\nconfig->level_gr, config->level_r,\r\nconfig->level_b, config->level_gb,\r\nconfig->start_position, config->end_position);\r\n}

int __ntb_register_client(struct ntb_client *client, struct module *mod,\r\nconst char *mod_name)\r\n{\r\nif (!client)\r\nreturn -EINVAL;\r\nif (!ntb_client_ops_is_valid(&client->ops))\r\nreturn -EINVAL;\r\nmemset(&client->drv, 0, sizeof(client->drv));\r\nclient->drv.bus = &ntb_bus;\r\nclient->drv.name = mod_name;\r\nclient->drv.owner = mod;\r\nreturn driver_register(&client->drv);\r\n}\r\nvoid ntb_unregister_client(struct ntb_client *client)\r\n{\r\ndriver_unregister(&client->drv);\r\n}\r\nint ntb_register_device(struct ntb_dev *ntb)\r\n{\r\nif (!ntb)\r\nreturn -EINVAL;\r\nif (!ntb->pdev)\r\nreturn -EINVAL;\r\nif (!ntb->ops)\r\nreturn -EINVAL;\r\nif (!ntb_dev_ops_is_valid(ntb->ops))\r\nreturn -EINVAL;\r\ninit_completion(&ntb->released);\r\nmemset(&ntb->dev, 0, sizeof(ntb->dev));\r\nntb->dev.bus = &ntb_bus;\r\nntb->dev.parent = &ntb->pdev->dev;\r\nntb->dev.release = ntb_dev_release;\r\ndev_set_name(&ntb->dev, "%s", pci_name(ntb->pdev));\r\nntb->ctx = NULL;\r\nntb->ctx_ops = NULL;\r\nspin_lock_init(&ntb->ctx_lock);\r\nreturn device_register(&ntb->dev);\r\n}\r\nvoid ntb_unregister_device(struct ntb_dev *ntb)\r\n{\r\ndevice_unregister(&ntb->dev);\r\nwait_for_completion(&ntb->released);\r\n}\r\nint ntb_set_ctx(struct ntb_dev *ntb, void *ctx,\r\nconst struct ntb_ctx_ops *ctx_ops)\r\n{\r\nunsigned long irqflags;\r\nif (!ntb_ctx_ops_is_valid(ctx_ops))\r\nreturn -EINVAL;\r\nif (ntb->ctx_ops)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&ntb->ctx_lock, irqflags);\r\n{\r\nntb->ctx = ctx;\r\nntb->ctx_ops = ctx_ops;\r\n}\r\nspin_unlock_irqrestore(&ntb->ctx_lock, irqflags);\r\nreturn 0;\r\n}\r\nvoid ntb_clear_ctx(struct ntb_dev *ntb)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&ntb->ctx_lock, irqflags);\r\n{\r\nntb->ctx_ops = NULL;\r\nntb->ctx = NULL;\r\n}\r\nspin_unlock_irqrestore(&ntb->ctx_lock, irqflags);\r\n}\r\nvoid ntb_link_event(struct ntb_dev *ntb)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&ntb->ctx_lock, irqflags);\r\n{\r\nif (ntb->ctx_ops && ntb->ctx_ops->link_event)\r\nntb->ctx_ops->link_event(ntb->ctx);\r\n}\r\nspin_unlock_irqrestore(&ntb->ctx_lock, irqflags);\r\n}\r\nvoid ntb_db_event(struct ntb_dev *ntb, int vector)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&ntb->ctx_lock, irqflags);\r\n{\r\nif (ntb->ctx_ops && ntb->ctx_ops->db_event)\r\nntb->ctx_ops->db_event(ntb->ctx, vector);\r\n}\r\nspin_unlock_irqrestore(&ntb->ctx_lock, irqflags);\r\n}\r\nvoid ntb_msg_event(struct ntb_dev *ntb)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&ntb->ctx_lock, irqflags);\r\n{\r\nif (ntb->ctx_ops && ntb->ctx_ops->msg_event)\r\nntb->ctx_ops->msg_event(ntb->ctx);\r\n}\r\nspin_unlock_irqrestore(&ntb->ctx_lock, irqflags);\r\n}\r\nint ntb_default_port_number(struct ntb_dev *ntb)\r\n{\r\nswitch (ntb->topo) {\r\ncase NTB_TOPO_PRI:\r\ncase NTB_TOPO_B2B_USD:\r\nreturn NTB_PORT_PRI_USD;\r\ncase NTB_TOPO_SEC:\r\ncase NTB_TOPO_B2B_DSD:\r\nreturn NTB_PORT_SEC_DSD;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint ntb_default_peer_port_count(struct ntb_dev *ntb)\r\n{\r\nreturn NTB_DEF_PEER_CNT;\r\n}\r\nint ntb_default_peer_port_number(struct ntb_dev *ntb, int pidx)\r\n{\r\nif (pidx != NTB_DEF_PEER_IDX)\r\nreturn -EINVAL;\r\nswitch (ntb->topo) {\r\ncase NTB_TOPO_PRI:\r\ncase NTB_TOPO_B2B_USD:\r\nreturn NTB_PORT_SEC_DSD;\r\ncase NTB_TOPO_SEC:\r\ncase NTB_TOPO_B2B_DSD:\r\nreturn NTB_PORT_PRI_USD;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint ntb_default_peer_port_idx(struct ntb_dev *ntb, int port)\r\n{\r\nint peer_port = ntb_default_peer_port_number(ntb, NTB_DEF_PEER_IDX);\r\nif (peer_port == -EINVAL || port != peer_port)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int ntb_probe(struct device *dev)\r\n{\r\nstruct ntb_dev *ntb;\r\nstruct ntb_client *client;\r\nint rc;\r\nget_device(dev);\r\nntb = dev_ntb(dev);\r\nclient = drv_ntb_client(dev->driver);\r\nrc = client->ops.probe(client, ntb);\r\nif (rc)\r\nput_device(dev);\r\nreturn rc;\r\n}\r\nstatic int ntb_remove(struct device *dev)\r\n{\r\nstruct ntb_dev *ntb;\r\nstruct ntb_client *client;\r\nif (dev->driver) {\r\nntb = dev_ntb(dev);\r\nclient = drv_ntb_client(dev->driver);\r\nclient->ops.remove(client, ntb);\r\nput_device(dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ntb_dev_release(struct device *dev)\r\n{\r\nstruct ntb_dev *ntb = dev_ntb(dev);\r\ncomplete(&ntb->released);\r\n}\r\nstatic int __init ntb_driver_init(void)\r\n{\r\nreturn bus_register(&ntb_bus);\r\n}\r\nstatic void __exit ntb_driver_exit(void)\r\n{\r\nbus_unregister(&ntb_bus);\r\n}

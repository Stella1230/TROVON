static void st_rtc_set_hw_alarm(struct st_rtc *rtc,\r\nunsigned long msb, unsigned long lsb)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc->lock, flags);\r\nwritel_relaxed(1, rtc->ioaddr + LPC_WDT_OFF);\r\nwritel_relaxed(msb, rtc->ioaddr + LPC_LPA_MSB_OFF);\r\nwritel_relaxed(lsb, rtc->ioaddr + LPC_LPA_LSB_OFF);\r\nwritel_relaxed(1, rtc->ioaddr + LPC_LPA_START_OFF);\r\nwritel_relaxed(0, rtc->ioaddr + LPC_WDT_OFF);\r\nspin_unlock_irqrestore(&rtc->lock, flags);\r\n}\r\nstatic irqreturn_t st_rtc_handler(int this_irq, void *data)\r\n{\r\nstruct st_rtc *rtc = (struct st_rtc *)data;\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int st_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long lpt_lsb, lpt_msb;\r\nunsigned long long lpt;\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc->lock, flags);\r\ndo {\r\nlpt_msb = readl_relaxed(rtc->ioaddr + LPC_LPT_MSB_OFF);\r\nlpt_lsb = readl_relaxed(rtc->ioaddr + LPC_LPT_LSB_OFF);\r\n} while (readl_relaxed(rtc->ioaddr + LPC_LPT_MSB_OFF) != lpt_msb);\r\nspin_unlock_irqrestore(&rtc->lock, flags);\r\nlpt = ((unsigned long long)lpt_msb << 32) | lpt_lsb;\r\ndo_div(lpt, rtc->clkrate);\r\nrtc_time64_to_tm(lpt, tm);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long long lpt, secs;\r\nunsigned long flags;\r\nsecs = rtc_tm_to_time64(tm);\r\nlpt = (unsigned long long)secs * rtc->clkrate;\r\nspin_lock_irqsave(&rtc->lock, flags);\r\nwritel_relaxed(lpt >> 32, rtc->ioaddr + LPC_LPT_MSB_OFF);\r\nwritel_relaxed(lpt, rtc->ioaddr + LPC_LPT_LSB_OFF);\r\nwritel_relaxed(1, rtc->ioaddr + LPC_LPT_START_OFF);\r\nspin_unlock_irqrestore(&rtc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *wkalrm)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc->lock, flags);\r\nmemcpy(wkalrm, &rtc->alarm, sizeof(struct rtc_wkalrm));\r\nspin_unlock_irqrestore(&rtc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nif (enabled && !rtc->irq_enabled) {\r\nenable_irq(rtc->irq);\r\nrtc->irq_enabled = true;\r\n} else if (!enabled && rtc->irq_enabled) {\r\ndisable_irq(rtc->irq);\r\nrtc->irq_enabled = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *t)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nstruct rtc_time now;\r\nunsigned long long now_secs;\r\nunsigned long long alarm_secs;\r\nunsigned long long lpa;\r\nst_rtc_read_time(dev, &now);\r\nnow_secs = rtc_tm_to_time64(&now);\r\nalarm_secs = rtc_tm_to_time64(&t->time);\r\nif (now_secs > alarm_secs)\r\nreturn -EINVAL;\r\nmemcpy(&rtc->alarm, t, sizeof(struct rtc_wkalrm));\r\nalarm_secs -= now_secs;\r\nlpa = (unsigned long long)alarm_secs * rtc->clkrate;\r\nst_rtc_set_hw_alarm(rtc, lpa >> 32, lpa);\r\nst_rtc_alarm_irq_enable(dev, t->enabled);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct st_rtc *rtc;\r\nstruct resource *res;\r\nstruct rtc_time tm_check;\r\nuint32_t mode;\r\nint ret = 0;\r\nret = of_property_read_u32(np, "st,lpc-mode", &mode);\r\nif (ret) {\r\ndev_err(&pdev->dev, "An LPC mode must be provided\n");\r\nreturn -EINVAL;\r\n}\r\nif (mode != ST_LPC_MODE_RTC)\r\nreturn -ENODEV;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(struct st_rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nspin_lock_init(&rtc->lock);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrtc->ioaddr = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(rtc->ioaddr))\r\nreturn PTR_ERR(rtc->ioaddr);\r\nrtc->irq = irq_of_parse_and_map(np, 0);\r\nif (!rtc->irq) {\r\ndev_err(&pdev->dev, "IRQ missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_request_irq(&pdev->dev, rtc->irq, st_rtc_handler, 0,\r\npdev->name, rtc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request irq %i\n", rtc->irq);\r\nreturn ret;\r\n}\r\nenable_irq_wake(rtc->irq);\r\ndisable_irq(rtc->irq);\r\nrtc->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(rtc->clk)) {\r\ndev_err(&pdev->dev, "Unable to request clock\n");\r\nreturn PTR_ERR(rtc->clk);\r\n}\r\nclk_prepare_enable(rtc->clk);\r\nrtc->clkrate = clk_get_rate(rtc->clk);\r\nif (!rtc->clkrate) {\r\ndev_err(&pdev->dev, "Unable to fetch clock rate\n");\r\nreturn -EINVAL;\r\n}\r\ndevice_set_wakeup_capable(&pdev->dev, 1);\r\nplatform_set_drvdata(pdev, rtc);\r\nst_rtc_read_time(&pdev->dev, &tm_check);\r\nif (tm_check.tm_year >= (2038 - 1900)) {\r\nmemset(&tm_check, 0, sizeof(tm_check));\r\ntm_check.tm_year = 100;\r\ntm_check.tm_mday = 1;\r\nst_rtc_set_time(&pdev->dev, &tm_check);\r\n}\r\nrtc->rtc_dev = rtc_device_register("st-lpc-rtc", &pdev->dev,\r\n&st_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev)) {\r\nclk_disable_unprepare(rtc->clk);\r\nreturn PTR_ERR(rtc->rtc_dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct st_rtc *rtc = platform_get_drvdata(pdev);\r\nif (likely(rtc->rtc_dev))\r\nrtc_device_unregister(rtc->rtc_dev);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_suspend(struct device *dev)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nreturn 0;\r\nwritel_relaxed(1, rtc->ioaddr + LPC_WDT_OFF);\r\nwritel_relaxed(0, rtc->ioaddr + LPC_LPA_START_OFF);\r\nwritel_relaxed(0, rtc->ioaddr + LPC_WDT_OFF);\r\nreturn 0;\r\n}\r\nstatic int st_rtc_resume(struct device *dev)\r\n{\r\nstruct st_rtc *rtc = dev_get_drvdata(dev);\r\nrtc_alarm_irq_enable(rtc->rtc_dev, 0);\r\nmemset(&rtc->alarm, 0, sizeof(struct rtc_wkalrm));\r\nwritel_relaxed(0, rtc->ioaddr + LPC_LPA_MSB_OFF);\r\nwritel_relaxed(0, rtc->ioaddr + LPC_LPA_LSB_OFF);\r\nwritel_relaxed(1, rtc->ioaddr + LPC_WDT_OFF);\r\nwritel_relaxed(1, rtc->ioaddr + LPC_LPA_START_OFF);\r\nwritel_relaxed(0, rtc->ioaddr + LPC_WDT_OFF);\r\nreturn 0;\r\n}

u16\r\nqcafrm_create_header(u8 *buf, u16 length)\r\n{\r\n__le16 len;\r\nif (!buf)\r\nreturn 0;\r\nlen = cpu_to_le16(length);\r\nbuf[0] = 0xAA;\r\nbuf[1] = 0xAA;\r\nbuf[2] = 0xAA;\r\nbuf[3] = 0xAA;\r\nbuf[4] = len & 0xff;\r\nbuf[5] = (len >> 8) & 0xff;\r\nbuf[6] = 0;\r\nbuf[7] = 0;\r\nreturn QCAFRM_HEADER_LEN;\r\n}\r\nu16\r\nqcafrm_create_footer(u8 *buf)\r\n{\r\nif (!buf)\r\nreturn 0;\r\nbuf[0] = 0x55;\r\nbuf[1] = 0x55;\r\nreturn QCAFRM_FOOTER_LEN;\r\n}\r\ns32\r\nqcafrm_fsm_decode(struct qcafrm_handle *handle, u8 *buf, u16 buf_len, u8 recv_byte)\r\n{\r\ns32 ret = QCAFRM_GATHER;\r\nu16 len;\r\nswitch (handle->state) {\r\ncase QCAFRM_HW_LEN0:\r\ncase QCAFRM_HW_LEN1:\r\nhandle->state--;\r\nif (recv_byte != 0x00) {\r\nhandle->state = handle->init;\r\n}\r\nbreak;\r\ncase QCAFRM_HW_LEN2:\r\ncase QCAFRM_HW_LEN3:\r\nhandle->state--;\r\nbreak;\r\ncase QCAFRM_WAIT_AA1:\r\ncase QCAFRM_WAIT_AA2:\r\ncase QCAFRM_WAIT_AA3:\r\ncase QCAFRM_WAIT_AA4:\r\nif (recv_byte != 0xAA) {\r\nret = QCAFRM_NOHEAD;\r\nhandle->state = handle->init;\r\n} else {\r\nhandle->state--;\r\n}\r\nbreak;\r\ncase QCAFRM_WAIT_LEN_BYTE0:\r\nhandle->offset = recv_byte;\r\nhandle->state = QCAFRM_WAIT_LEN_BYTE1;\r\nbreak;\r\ncase QCAFRM_WAIT_LEN_BYTE1:\r\nhandle->offset = handle->offset | (recv_byte << 8);\r\nhandle->state = QCAFRM_WAIT_RSVD_BYTE1;\r\nbreak;\r\ncase QCAFRM_WAIT_RSVD_BYTE1:\r\nhandle->state = QCAFRM_WAIT_RSVD_BYTE2;\r\nbreak;\r\ncase QCAFRM_WAIT_RSVD_BYTE2:\r\nlen = handle->offset;\r\nif (len > buf_len || len < QCAFRM_MIN_LEN) {\r\nret = QCAFRM_INVLEN;\r\nhandle->state = handle->init;\r\n} else {\r\nhandle->state = (enum qcafrm_state)(len + 1);\r\nhandle->offset = 0;\r\n}\r\nbreak;\r\ndefault:\r\nbuf[handle->offset] = recv_byte;\r\nhandle->offset++;\r\nhandle->state--;\r\nbreak;\r\ncase QCAFRM_WAIT_551:\r\nif (recv_byte != 0x55) {\r\nret = QCAFRM_NOTAIL;\r\nhandle->state = handle->init;\r\n} else {\r\nhandle->state = QCAFRM_WAIT_552;\r\n}\r\nbreak;\r\ncase QCAFRM_WAIT_552:\r\nif (recv_byte != 0x55) {\r\nret = QCAFRM_NOTAIL;\r\nhandle->state = handle->init;\r\n} else {\r\nret = handle->offset;\r\nhandle->state = handle->init;\r\n}\r\nbreak;\r\n}\r\nreturn ret;\r\n}

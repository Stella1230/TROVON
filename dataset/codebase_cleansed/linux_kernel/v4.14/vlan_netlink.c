static inline int vlan_validate_qos_map(struct nlattr *attr)\r\n{\r\nif (!attr)\r\nreturn 0;\r\nreturn nla_validate_nested(attr, IFLA_VLAN_QOS_MAX, vlan_map_policy,\r\nNULL);\r\n}\r\nstatic int vlan_validate(struct nlattr *tb[], struct nlattr *data[],\r\nstruct netlink_ext_ack *extack)\r\n{\r\nstruct ifla_vlan_flags *flags;\r\nu16 id;\r\nint err;\r\nif (tb[IFLA_ADDRESS]) {\r\nif (nla_len(tb[IFLA_ADDRESS]) != ETH_ALEN)\r\nreturn -EINVAL;\r\nif (!is_valid_ether_addr(nla_data(tb[IFLA_ADDRESS])))\r\nreturn -EADDRNOTAVAIL;\r\n}\r\nif (!data)\r\nreturn -EINVAL;\r\nif (data[IFLA_VLAN_PROTOCOL]) {\r\nswitch (nla_get_be16(data[IFLA_VLAN_PROTOCOL])) {\r\ncase htons(ETH_P_8021Q):\r\ncase htons(ETH_P_8021AD):\r\nbreak;\r\ndefault:\r\nreturn -EPROTONOSUPPORT;\r\n}\r\n}\r\nif (data[IFLA_VLAN_ID]) {\r\nid = nla_get_u16(data[IFLA_VLAN_ID]);\r\nif (id >= VLAN_VID_MASK)\r\nreturn -ERANGE;\r\n}\r\nif (data[IFLA_VLAN_FLAGS]) {\r\nflags = nla_data(data[IFLA_VLAN_FLAGS]);\r\nif ((flags->flags & flags->mask) &\r\n~(VLAN_FLAG_REORDER_HDR | VLAN_FLAG_GVRP |\r\nVLAN_FLAG_LOOSE_BINDING | VLAN_FLAG_MVRP))\r\nreturn -EINVAL;\r\n}\r\nerr = vlan_validate_qos_map(data[IFLA_VLAN_INGRESS_QOS]);\r\nif (err < 0)\r\nreturn err;\r\nerr = vlan_validate_qos_map(data[IFLA_VLAN_EGRESS_QOS]);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int vlan_changelink(struct net_device *dev, struct nlattr *tb[],\r\nstruct nlattr *data[],\r\nstruct netlink_ext_ack *extack)\r\n{\r\nstruct ifla_vlan_flags *flags;\r\nstruct ifla_vlan_qos_mapping *m;\r\nstruct nlattr *attr;\r\nint rem;\r\nif (data[IFLA_VLAN_FLAGS]) {\r\nflags = nla_data(data[IFLA_VLAN_FLAGS]);\r\nvlan_dev_change_flags(dev, flags->flags, flags->mask);\r\n}\r\nif (data[IFLA_VLAN_INGRESS_QOS]) {\r\nnla_for_each_nested(attr, data[IFLA_VLAN_INGRESS_QOS], rem) {\r\nm = nla_data(attr);\r\nvlan_dev_set_ingress_priority(dev, m->to, m->from);\r\n}\r\n}\r\nif (data[IFLA_VLAN_EGRESS_QOS]) {\r\nnla_for_each_nested(attr, data[IFLA_VLAN_EGRESS_QOS], rem) {\r\nm = nla_data(attr);\r\nvlan_dev_set_egress_priority(dev, m->from, m->to);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int vlan_newlink(struct net *src_net, struct net_device *dev,\r\nstruct nlattr *tb[], struct nlattr *data[],\r\nstruct netlink_ext_ack *extack)\r\n{\r\nstruct vlan_dev_priv *vlan = vlan_dev_priv(dev);\r\nstruct net_device *real_dev;\r\nunsigned int max_mtu;\r\n__be16 proto;\r\nint err;\r\nif (!data[IFLA_VLAN_ID])\r\nreturn -EINVAL;\r\nif (!tb[IFLA_LINK])\r\nreturn -EINVAL;\r\nreal_dev = __dev_get_by_index(src_net, nla_get_u32(tb[IFLA_LINK]));\r\nif (!real_dev)\r\nreturn -ENODEV;\r\nif (data[IFLA_VLAN_PROTOCOL])\r\nproto = nla_get_be16(data[IFLA_VLAN_PROTOCOL]);\r\nelse\r\nproto = htons(ETH_P_8021Q);\r\nvlan->vlan_proto = proto;\r\nvlan->vlan_id = nla_get_u16(data[IFLA_VLAN_ID]);\r\nvlan->real_dev = real_dev;\r\nvlan->flags = VLAN_FLAG_REORDER_HDR;\r\nerr = vlan_check_real_dev(real_dev, vlan->vlan_proto, vlan->vlan_id);\r\nif (err < 0)\r\nreturn err;\r\nmax_mtu = netif_reduces_vlan_mtu(real_dev) ? real_dev->mtu - VLAN_HLEN :\r\nreal_dev->mtu;\r\nif (!tb[IFLA_MTU])\r\ndev->mtu = max_mtu;\r\nelse if (dev->mtu > max_mtu)\r\nreturn -EINVAL;\r\nerr = vlan_changelink(dev, tb, data, extack);\r\nif (err < 0)\r\nreturn err;\r\nreturn register_vlan_dev(dev);\r\n}\r\nstatic inline size_t vlan_qos_map_size(unsigned int n)\r\n{\r\nif (n == 0)\r\nreturn 0;\r\nreturn nla_total_size(sizeof(struct nlattr)) +\r\nnla_total_size(sizeof(struct ifla_vlan_qos_mapping)) * n;\r\n}\r\nstatic size_t vlan_get_size(const struct net_device *dev)\r\n{\r\nstruct vlan_dev_priv *vlan = vlan_dev_priv(dev);\r\nreturn nla_total_size(2) +\r\nnla_total_size(2) +\r\nnla_total_size(sizeof(struct ifla_vlan_flags)) +\r\nvlan_qos_map_size(vlan->nr_ingress_mappings) +\r\nvlan_qos_map_size(vlan->nr_egress_mappings);\r\n}\r\nstatic int vlan_fill_info(struct sk_buff *skb, const struct net_device *dev)\r\n{\r\nstruct vlan_dev_priv *vlan = vlan_dev_priv(dev);\r\nstruct vlan_priority_tci_mapping *pm;\r\nstruct ifla_vlan_flags f;\r\nstruct ifla_vlan_qos_mapping m;\r\nstruct nlattr *nest;\r\nunsigned int i;\r\nif (nla_put_be16(skb, IFLA_VLAN_PROTOCOL, vlan->vlan_proto) ||\r\nnla_put_u16(skb, IFLA_VLAN_ID, vlan->vlan_id))\r\ngoto nla_put_failure;\r\nif (vlan->flags) {\r\nf.flags = vlan->flags;\r\nf.mask = ~0;\r\nif (nla_put(skb, IFLA_VLAN_FLAGS, sizeof(f), &f))\r\ngoto nla_put_failure;\r\n}\r\nif (vlan->nr_ingress_mappings) {\r\nnest = nla_nest_start(skb, IFLA_VLAN_INGRESS_QOS);\r\nif (nest == NULL)\r\ngoto nla_put_failure;\r\nfor (i = 0; i < ARRAY_SIZE(vlan->ingress_priority_map); i++) {\r\nif (!vlan->ingress_priority_map[i])\r\ncontinue;\r\nm.from = i;\r\nm.to = vlan->ingress_priority_map[i];\r\nif (nla_put(skb, IFLA_VLAN_QOS_MAPPING,\r\nsizeof(m), &m))\r\ngoto nla_put_failure;\r\n}\r\nnla_nest_end(skb, nest);\r\n}\r\nif (vlan->nr_egress_mappings) {\r\nnest = nla_nest_start(skb, IFLA_VLAN_EGRESS_QOS);\r\nif (nest == NULL)\r\ngoto nla_put_failure;\r\nfor (i = 0; i < ARRAY_SIZE(vlan->egress_priority_map); i++) {\r\nfor (pm = vlan->egress_priority_map[i]; pm;\r\npm = pm->next) {\r\nif (!pm->vlan_qos)\r\ncontinue;\r\nm.from = pm->priority;\r\nm.to = (pm->vlan_qos >> 13) & 0x7;\r\nif (nla_put(skb, IFLA_VLAN_QOS_MAPPING,\r\nsizeof(m), &m))\r\ngoto nla_put_failure;\r\n}\r\n}\r\nnla_nest_end(skb, nest);\r\n}\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic struct net *vlan_get_link_net(const struct net_device *dev)\r\n{\r\nstruct net_device *real_dev = vlan_dev_priv(dev)->real_dev;\r\nreturn dev_net(real_dev);\r\n}\r\nint __init vlan_netlink_init(void)\r\n{\r\nreturn rtnl_link_register(&vlan_link_ops);\r\n}\r\nvoid __exit vlan_netlink_fini(void)\r\n{\r\nrtnl_link_unregister(&vlan_link_ops);\r\n}

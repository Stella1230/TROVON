static void mf624_disable_interrupt(enum mf624_interrupt_source source,\r\nstruct uio_info *info)\r\n{\r\nvoid __iomem *INTCSR_reg = info->mem[0].internal_addr + INTCSR;\r\nswitch (source) {\r\ncase ADC:\r\niowrite32(ioread32(INTCSR_reg)\r\n& ~(INTCSR_ADINT_ENABLE | INTCSR_PCIINT_ENABLE),\r\nINTCSR_reg);\r\nbreak;\r\ncase CTR4:\r\niowrite32(ioread32(INTCSR_reg)\r\n& ~(INTCSR_CTR4INT_ENABLE | INTCSR_PCIINT_ENABLE),\r\nINTCSR_reg);\r\nbreak;\r\ncase ALL:\r\ndefault:\r\niowrite32(ioread32(INTCSR_reg)\r\n& ~(INTCSR_ADINT_ENABLE | INTCSR_CTR4INT_ENABLE\r\n| INTCSR_PCIINT_ENABLE),\r\nINTCSR_reg);\r\nbreak;\r\n}\r\n}\r\nstatic void mf624_enable_interrupt(enum mf624_interrupt_source source,\r\nstruct uio_info *info)\r\n{\r\nvoid __iomem *INTCSR_reg = info->mem[0].internal_addr + INTCSR;\r\nswitch (source) {\r\ncase ADC:\r\niowrite32(ioread32(INTCSR_reg)\r\n| INTCSR_ADINT_ENABLE | INTCSR_PCIINT_ENABLE,\r\nINTCSR_reg);\r\nbreak;\r\ncase CTR4:\r\niowrite32(ioread32(INTCSR_reg)\r\n| INTCSR_CTR4INT_ENABLE | INTCSR_PCIINT_ENABLE,\r\nINTCSR_reg);\r\nbreak;\r\ncase ALL:\r\ndefault:\r\niowrite32(ioread32(INTCSR_reg)\r\n| INTCSR_ADINT_ENABLE | INTCSR_CTR4INT_ENABLE\r\n| INTCSR_PCIINT_ENABLE,\r\nINTCSR_reg);\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t mf624_irq_handler(int irq, struct uio_info *info)\r\n{\r\nvoid __iomem *INTCSR_reg = info->mem[0].internal_addr + INTCSR;\r\nif ((ioread32(INTCSR_reg) & INTCSR_ADINT_ENABLE)\r\n&& (ioread32(INTCSR_reg) & INTCSR_ADINT_STATUS)) {\r\nmf624_disable_interrupt(ADC, info);\r\nreturn IRQ_HANDLED;\r\n}\r\nif ((ioread32(INTCSR_reg) & INTCSR_CTR4INT_ENABLE)\r\n&& (ioread32(INTCSR_reg) & INTCSR_CTR4INT_STATUS)) {\r\nmf624_disable_interrupt(CTR4, info);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int mf624_irqcontrol(struct uio_info *info, s32 irq_on)\r\n{\r\nif (irq_on == 0)\r\nmf624_disable_interrupt(ALL, info);\r\nelse if (irq_on == 1)\r\nmf624_enable_interrupt(ALL, info);\r\nreturn 0;\r\n}\r\nstatic int mf624_setup_mem(struct pci_dev *dev, int bar, struct uio_mem *mem, const char *name)\r\n{\r\nresource_size_t start = pci_resource_start(dev, bar);\r\nresource_size_t len = pci_resource_len(dev, bar);\r\nmem->name = name;\r\nmem->addr = start & PAGE_MASK;\r\nmem->offs = start & ~PAGE_MASK;\r\nif (!mem->addr)\r\nreturn -ENODEV;\r\nmem->size = ((start & ~PAGE_MASK) + len + PAGE_SIZE - 1) & PAGE_MASK;\r\nmem->memtype = UIO_MEM_PHYS;\r\nmem->internal_addr = pci_ioremap_bar(dev, bar);\r\nif (!mem->internal_addr)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int mf624_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct uio_info *info;\r\ninfo = kzalloc(sizeof(struct uio_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nif (pci_enable_device(dev))\r\ngoto out_free;\r\nif (pci_request_regions(dev, "mf624"))\r\ngoto out_disable;\r\ninfo->name = "mf624";\r\ninfo->version = "0.0.1";\r\nif (mf624_setup_mem(dev, 0, &info->mem[0], "PCI chipset, interrupts, status "\r\n"bits, special functions"))\r\ngoto out_release;\r\nif (mf624_setup_mem(dev, 2, &info->mem[1], "ADC, DAC, DIO"))\r\ngoto out_unmap0;\r\nif (mf624_setup_mem(dev, 4, &info->mem[2], "Counter/timer chip"))\r\ngoto out_unmap1;\r\ninfo->irq = dev->irq;\r\ninfo->irq_flags = IRQF_SHARED;\r\ninfo->handler = mf624_irq_handler;\r\ninfo->irqcontrol = mf624_irqcontrol;\r\nif (uio_register_device(&dev->dev, info))\r\ngoto out_unmap2;\r\npci_set_drvdata(dev, info);\r\nreturn 0;\r\nout_unmap2:\r\niounmap(info->mem[2].internal_addr);\r\nout_unmap1:\r\niounmap(info->mem[1].internal_addr);\r\nout_unmap0:\r\niounmap(info->mem[0].internal_addr);\r\nout_release:\r\npci_release_regions(dev);\r\nout_disable:\r\npci_disable_device(dev);\r\nout_free:\r\nkfree(info);\r\nreturn -ENODEV;\r\n}\r\nstatic void mf624_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct uio_info *info = pci_get_drvdata(dev);\r\nmf624_disable_interrupt(ALL, info);\r\nuio_unregister_device(info);\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\niounmap(info->mem[0].internal_addr);\r\niounmap(info->mem[1].internal_addr);\r\niounmap(info->mem[2].internal_addr);\r\nkfree(info);\r\n}

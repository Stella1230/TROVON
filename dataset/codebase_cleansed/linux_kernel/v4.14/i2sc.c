static inline unsigned long RD(struct au1xpsc_audio_data *ctx, int reg)\r\n{\r\nreturn __raw_readl(ctx->mmio + reg);\r\n}\r\nstatic inline void WR(struct au1xpsc_audio_data *ctx, int reg, unsigned long v)\r\n{\r\n__raw_writel(v, ctx->mmio + reg);\r\nwmb();\r\n}\r\nstatic int au1xi2s_set_fmt(struct snd_soc_dai *cpu_dai, unsigned int fmt)\r\n{\r\nstruct au1xpsc_audio_data *ctx = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long c;\r\nint ret;\r\nret = -EINVAL;\r\nc = ctx->cfg;\r\nc &= ~CFG_FM_MASK;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nc |= CFG_FM_I2S;\r\nbreak;\r\ncase SND_SOC_DAIFMT_MSB:\r\nc |= CFG_FM_RJ;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LSB:\r\nc |= CFG_FM_LJ;\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nc &= ~(CFG_IC | CFG_ICK);\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nc |= CFG_IC | CFG_ICK;\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\nc |= CFG_IC;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nc |= CFG_ICK;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nret = 0;\r\nctx->cfg = c;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int au1xi2s_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *ctx = snd_soc_dai_get_drvdata(dai);\r\nint stype = SUBSTREAM_TYPE(substream);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nWR(ctx, I2S_ENABLE, EN_D | EN_CE);\r\nWR(ctx, I2S_ENABLE, EN_CE);\r\nctx->cfg |= (stype == PCM_TX) ? CFG_TN : CFG_RN;\r\nWR(ctx, I2S_CFG, ctx->cfg);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nctx->cfg &= ~((stype == PCM_TX) ? CFG_TN : CFG_RN);\r\nWR(ctx, I2S_CFG, ctx->cfg);\r\nWR(ctx, I2S_ENABLE, EN_D);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned long msbits_to_reg(int msbits)\r\n{\r\nswitch (msbits) {\r\ncase 8:\r\nreturn CFG_SZ_8;\r\ncase 16:\r\nreturn CFG_SZ_16;\r\ncase 18:\r\nreturn CFG_SZ_18;\r\ncase 20:\r\nreturn CFG_SZ_20;\r\ncase 24:\r\nreturn CFG_SZ_24;\r\n}\r\nreturn 0;\r\n}\r\nstatic int au1xi2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *ctx = snd_soc_dai_get_drvdata(dai);\r\nunsigned long v;\r\nv = msbits_to_reg(params->msbits);\r\nif (!v)\r\nreturn -EINVAL;\r\nctx->cfg &= ~CFG_SZ_MASK;\r\nctx->cfg |= v;\r\nreturn 0;\r\n}\r\nstatic int au1xi2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *ctx = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, &ctx->dmaids[0]);\r\nreturn 0;\r\n}\r\nstatic int au1xi2s_drvprobe(struct platform_device *pdev)\r\n{\r\nstruct resource *iores, *dmares;\r\nstruct au1xpsc_audio_data *ctx;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\niores = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iores)\r\nreturn -ENODEV;\r\nif (!devm_request_mem_region(&pdev->dev, iores->start,\r\nresource_size(iores),\r\npdev->name))\r\nreturn -EBUSY;\r\nctx->mmio = devm_ioremap_nocache(&pdev->dev, iores->start,\r\nresource_size(iores));\r\nif (!ctx->mmio)\r\nreturn -EBUSY;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nctx->dmaids[SNDRV_PCM_STREAM_PLAYBACK] = dmares->start;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nctx->dmaids[SNDRV_PCM_STREAM_CAPTURE] = dmares->start;\r\nplatform_set_drvdata(pdev, ctx);\r\nreturn snd_soc_register_component(&pdev->dev, &au1xi2s_component,\r\n&au1xi2s_dai_driver, 1);\r\n}\r\nstatic int au1xi2s_drvremove(struct platform_device *pdev)\r\n{\r\nstruct au1xpsc_audio_data *ctx = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nWR(ctx, I2S_ENABLE, EN_D);\r\nreturn 0;\r\n}\r\nstatic int au1xi2s_drvsuspend(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *ctx = dev_get_drvdata(dev);\r\nWR(ctx, I2S_ENABLE, EN_D);\r\nreturn 0;\r\n}\r\nstatic int au1xi2s_drvresume(struct device *dev)\r\n{\r\nreturn 0;\r\n}

static int rza_wdt_start(struct watchdog_device *wdev)\r\n{\r\nstruct rza_wdt *priv = watchdog_get_drvdata(wdev);\r\nwritew(WTCSR_MAGIC | 0, priv->base + WTCSR);\r\nreadb(priv->base + WRCSR);\r\nwritew(WRCSR_CLEAR_WOVF, priv->base + WRCSR);\r\nwritew(WRCSR_MAGIC | WRCSR_RSTE, priv->base + WRCSR);\r\nwritew(WTCNT_MAGIC | 0, priv->base + WTCNT);\r\nwritew(WTCSR_MAGIC | WTSCR_WT | WTSCR_TME | WTSCR_CKS(7),\r\npriv->base + WTCSR);\r\nreturn 0;\r\n}\r\nstatic int rza_wdt_stop(struct watchdog_device *wdev)\r\n{\r\nstruct rza_wdt *priv = watchdog_get_drvdata(wdev);\r\nwritew(WTCSR_MAGIC | 0, priv->base + WTCSR);\r\nreturn 0;\r\n}\r\nstatic int rza_wdt_ping(struct watchdog_device *wdev)\r\n{\r\nstruct rza_wdt *priv = watchdog_get_drvdata(wdev);\r\nwritew(WTCNT_MAGIC | 0, priv->base + WTCNT);\r\nreturn 0;\r\n}\r\nstatic int rza_wdt_restart(struct watchdog_device *wdev, unsigned long action,\r\nvoid *data)\r\n{\r\nstruct rza_wdt *priv = watchdog_get_drvdata(wdev);\r\nwritew(WTCSR_MAGIC | 0, priv->base + WTCSR);\r\nreadb(priv->base + WRCSR);\r\nwritew(WRCSR_CLEAR_WOVF, priv->base + WRCSR);\r\nwritew(WRCSR_MAGIC | WRCSR_RSTE, priv->base + WRCSR);\r\nwritew(WTCNT_MAGIC | 255, priv->base + WTCNT);\r\nwritew(WTCSR_MAGIC | WTSCR_WT | WTSCR_TME, priv->base + WTCSR);\r\nwmb();\r\nudelay(20);\r\nreturn 0;\r\n}\r\nstatic int rza_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct rza_wdt *priv;\r\nstruct resource *res;\r\nunsigned long rate;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->base))\r\nreturn PTR_ERR(priv->base);\r\npriv->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(priv->clk))\r\nreturn PTR_ERR(priv->clk);\r\nrate = clk_get_rate(priv->clk);\r\nif (rate < 16384) {\r\ndev_err(&pdev->dev, "invalid clock rate (%ld)\n", rate);\r\nreturn -ENOENT;\r\n}\r\nrate /= 16384;\r\npriv->wdev.info = &rza_wdt_ident,\r\npriv->wdev.ops = &rza_wdt_ops,\r\npriv->wdev.parent = &pdev->dev;\r\npriv->wdev.max_hw_heartbeat_ms = (1000 * U8_MAX) / rate;\r\ndev_dbg(&pdev->dev, "max hw timeout of %dms\n",\r\npriv->wdev.max_hw_heartbeat_ms);\r\npriv->wdev.min_timeout = 1;\r\npriv->wdev.timeout = DEFAULT_TIMEOUT;\r\nwatchdog_init_timeout(&priv->wdev, 0, &pdev->dev);\r\nwatchdog_set_drvdata(&priv->wdev, priv);\r\nret = devm_watchdog_register_device(&pdev->dev, &priv->wdev);\r\nif (ret)\r\ndev_err(&pdev->dev, "Cannot register watchdog device\n");\r\nreturn ret;\r\n}

acpi_status\r\nacpi_ex_store(union acpi_operand_object *source_desc,\r\nunion acpi_operand_object *dest_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *ref_desc = dest_desc;\r\nACPI_FUNCTION_TRACE_PTR(ex_store, dest_desc);\r\nif (!source_desc || !dest_desc) {\r\nACPI_ERROR((AE_INFO, "Null parameter"));\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(dest_desc) == ACPI_DESC_TYPE_NAMED) {\r\nstatus = acpi_ex_store_object_to_node(source_desc,\r\n(struct\r\nacpi_namespace_node *)\r\ndest_desc, walk_state,\r\nACPI_IMPLICIT_CONVERSION);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nswitch (dest_desc->common.type) {\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\nif (dest_desc->common.flags & AOPOBJ_AML_CONSTANT) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Target is not a Reference or Constant object - [%s] %p",\r\nacpi_ut_get_object_type_name(dest_desc),\r\ndest_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nswitch (ref_desc->reference.class) {\r\ncase ACPI_REFCLASS_REFOF:\r\nstatus = acpi_ex_store_object_to_node(source_desc,\r\nref_desc->reference.\r\nobject, walk_state,\r\nACPI_IMPLICIT_CONVERSION);\r\nbreak;\r\ncase ACPI_REFCLASS_INDEX:\r\nstatus =\r\nacpi_ex_store_object_to_index(source_desc, ref_desc,\r\nwalk_state);\r\nbreak;\r\ncase ACPI_REFCLASS_LOCAL:\r\ncase ACPI_REFCLASS_ARG:\r\nstatus =\r\nacpi_ds_store_object_to_local(ref_desc->reference.class,\r\nref_desc->reference.value,\r\nsource_desc, walk_state);\r\nbreak;\r\ncase ACPI_REFCLASS_DEBUG:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"**** Write to Debug Object: Object %p [%s] ****:\n\n",\r\nsource_desc,\r\nacpi_ut_get_object_type_name(source_desc)));\r\nACPI_DEBUG_OBJECT(source_desc, 0, 0);\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Unknown Reference Class 0x%2.2X",\r\nref_desc->reference.class));\r\nACPI_DUMP_ENTRY(ref_desc, ACPI_LV_INFO);\r\nstatus = AE_AML_INTERNAL;\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ex_store_object_to_index(union acpi_operand_object *source_desc,\r\nunion acpi_operand_object *index_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *new_desc;\r\nu8 value = 0;\r\nu32 i;\r\nACPI_FUNCTION_TRACE(ex_store_object_to_index);\r\nswitch (index_desc->reference.target_type) {\r\ncase ACPI_TYPE_PACKAGE:\r\nobj_desc = *(index_desc->reference.where);\r\nif (source_desc->common.type == ACPI_TYPE_LOCAL_REFERENCE &&\r\nsource_desc->reference.class == ACPI_REFCLASS_TABLE) {\r\nacpi_ut_add_reference(source_desc);\r\nnew_desc = source_desc;\r\n} else {\r\nstatus =\r\nacpi_ut_copy_iobject_to_iobject(source_desc,\r\n&new_desc,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nif (obj_desc) {\r\nfor (i = 0; i < ((union acpi_operand_object *)\r\nindex_desc->reference.object)->common.\r\nreference_count; i++) {\r\nacpi_ut_remove_reference(obj_desc);\r\n}\r\n}\r\n*(index_desc->reference.where) = new_desc;\r\nfor (i = 1; i < ((union acpi_operand_object *)\r\nindex_desc->reference.object)->common.\r\nreference_count; i++) {\r\nacpi_ut_add_reference(new_desc);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\nobj_desc = index_desc->reference.object;\r\nif ((obj_desc->common.type != ACPI_TYPE_BUFFER) &&\r\n(obj_desc->common.type != ACPI_TYPE_STRING)) {\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nswitch (source_desc->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\nvalue = (u8) (source_desc->integer.value);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_STRING:\r\nvalue = source_desc->buffer.pointer[0];\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Source must be type [Integer/Buffer/String], found [%s]",\r\nacpi_ut_get_object_type_name(source_desc)));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nobj_desc->buffer.pointer[index_desc->reference.value] = value;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Target is not of type [Package/BufferField]"));\r\nstatus = AE_AML_TARGET_TYPE;\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ex_store_object_to_node(union acpi_operand_object *source_desc,\r\nstruct acpi_namespace_node *node,\r\nstruct acpi_walk_state *walk_state,\r\nu8 implicit_conversion)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *target_desc;\r\nunion acpi_operand_object *new_desc;\r\nacpi_object_type target_type;\r\nACPI_FUNCTION_TRACE_PTR(ex_store_object_to_node, source_desc);\r\ntarget_type = acpi_ns_get_type(node);\r\ntarget_desc = acpi_ns_get_attached_object(node);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Storing %p [%s] to node %p [%s]\n",\r\nsource_desc,\r\nacpi_ut_get_object_type_name(source_desc), node,\r\nacpi_ut_get_type_name(target_type)));\r\nif (walk_state->opcode != AML_COPY_OBJECT_OP) {\r\nswitch (target_type) {\r\ncase ACPI_TYPE_PACKAGE:\r\nif (walk_state->opcode == AML_STORE_OP) {\r\nif (source_desc->common.type !=\r\nACPI_TYPE_PACKAGE) {\r\nACPI_ERROR((AE_INFO,\r\n"Cannot assign type [%s] to [Package] "\r\n"(source must be type Pkg)",\r\nacpi_ut_get_object_type_name\r\n(source_desc)));\r\nreturn_ACPI_STATUS(AE_AML_TARGET_TYPE);\r\n}\r\nbreak;\r\n}\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_EVENT:\r\ncase ACPI_TYPE_MUTEX:\r\ncase ACPI_TYPE_REGION:\r\ncase ACPI_TYPE_POWER:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_THERMAL:\r\nACPI_ERROR((AE_INFO,\r\n"Target must be [Buffer/Integer/String/Reference]"\r\n", found [%s] (%4.4s)",\r\nacpi_ut_get_type_name(node->type),\r\nnode->name.ascii));\r\nreturn_ACPI_STATUS(AE_AML_TARGET_TYPE);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatus = acpi_ex_resolve_object(&source_desc, target_type, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nswitch (target_type) {\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nif ((walk_state->opcode == AML_COPY_OBJECT_OP) ||\r\n!implicit_conversion) {\r\nstatus =\r\nacpi_ex_store_direct_to_node(source_desc, node,\r\nwalk_state);\r\nbreak;\r\n}\r\nstatus =\r\nacpi_ex_store_object_to_object(source_desc, target_desc,\r\n&new_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (new_desc != target_desc) {\r\nstatus =\r\nacpi_ns_attach_object(node, new_desc,\r\nnew_desc->common.type);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Store type [%s] into [%s] via Convert/Attach\n",\r\nacpi_ut_get_object_type_name\r\n(source_desc),\r\nacpi_ut_get_object_type_name\r\n(new_desc)));\r\n}\r\nbreak;\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\nstatus = acpi_ex_write_data_to_field(source_desc, target_desc,\r\n&walk_state->result_obj);\r\nbreak;\r\ndefault:\r\nstatus =\r\nacpi_ex_store_direct_to_node(source_desc, node, walk_state);\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ex_store_direct_to_node(union acpi_operand_object *source_desc,\r\nstruct acpi_namespace_node *node,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *new_desc;\r\nACPI_FUNCTION_TRACE(ex_store_direct_to_node);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Storing [%s] (%p) directly into node [%s] (%p)"\r\n" with no implicit conversion\n",\r\nacpi_ut_get_object_type_name(source_desc),\r\nsource_desc, acpi_ut_get_type_name(node->type),\r\nnode));\r\nstatus =\r\nacpi_ut_copy_iobject_to_iobject(source_desc, &new_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ns_attach_object(node, new_desc, new_desc->common.type);\r\nacpi_ut_remove_reference(new_desc);\r\nreturn_ACPI_STATUS(status);\r\n}

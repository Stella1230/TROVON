void meson_viu_set_osd_matrix(struct meson_drm *priv,\r\nenum viu_matrix_sel_e m_select,\r\nint *m, bool csc_on)\r\n{\r\nif (m_select == VIU_MATRIX_OSD) {\r\nwritel(((m[0] & 0xfff) << 16) | (m[1] & 0xfff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_PRE_OFFSET0_1));\r\nwritel(m[2] & 0xfff,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_PRE_OFFSET2));\r\nwritel(((m[3] & 0x1fff) << 16) | (m[4] & 0x1fff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COEF00_01));\r\nwritel(((m[5] & 0x1fff) << 16) | (m[6] & 0x1fff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COEF02_10));\r\nwritel(((m[7] & 0x1fff) << 16) | (m[8] & 0x1fff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COEF11_12));\r\nwritel(((m[9] & 0x1fff) << 16) | (m[10] & 0x1fff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COEF20_21));\r\nif (m[21]) {\r\nwritel(((m[11] & 0x1fff) << 16) | (m[12] & 0x1fff),\r\npriv->io_base +\r\n_REG(VIU_OSD1_MATRIX_COEF22_30));\r\nwritel(((m[13] & 0x1fff) << 16) | (m[14] & 0x1fff),\r\npriv->io_base +\r\n_REG(VIU_OSD1_MATRIX_COEF31_32));\r\nwritel(((m[15] & 0x1fff) << 16) | (m[16] & 0x1fff),\r\npriv->io_base +\r\n_REG(VIU_OSD1_MATRIX_COEF40_41));\r\nwritel(m[17] & 0x1fff, priv->io_base +\r\n_REG(VIU_OSD1_MATRIX_COLMOD_COEF42));\r\n} else\r\nwritel((m[11] & 0x1fff) << 16, priv->io_base +\r\n_REG(VIU_OSD1_MATRIX_COEF22_30));\r\nwritel(((m[18] & 0xfff) << 16) | (m[19] & 0xfff),\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_OFFSET0_1));\r\nwritel(m[20] & 0xfff,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_OFFSET2));\r\nwritel_bits_relaxed(3 << 30, m[21] << 30,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COLMOD_COEF42));\r\nwritel_bits_relaxed(7 << 16, m[22] << 16,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_COLMOD_COEF42));\r\nwritel_bits_relaxed(BIT(0), csc_on ? BIT(0) : 0,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_CTRL));\r\nwritel_bits_relaxed(BIT(1), 0,\r\npriv->io_base + _REG(VIU_OSD1_MATRIX_CTRL));\r\n} else if (m_select == VIU_MATRIX_OSD_EOTF) {\r\nint i;\r\nfor (i = 0; i < 5; i++)\r\nwritel(((m[i * 2] & 0x1fff) << 16) |\r\n(m[i * 2 + 1] & 0x1fff), priv->io_base +\r\n_REG(VIU_OSD1_EOTF_CTL + i + 1));\r\nwritel_bits_relaxed(BIT(30), csc_on ? BIT(30) : 0,\r\npriv->io_base + _REG(VIU_OSD1_EOTF_CTL));\r\nwritel_bits_relaxed(BIT(31), csc_on ? BIT(31) : 0,\r\npriv->io_base + _REG(VIU_OSD1_EOTF_CTL));\r\n}\r\n}\r\nvoid meson_viu_set_osd_lut(struct meson_drm *priv, enum viu_lut_sel_e lut_sel,\r\nunsigned int *r_map, unsigned int *g_map,\r\nunsigned int *b_map,\r\nbool csc_on)\r\n{\r\nunsigned int addr_port;\r\nunsigned int data_port;\r\nunsigned int ctrl_port;\r\nint i;\r\nif (lut_sel == VIU_LUT_OSD_EOTF) {\r\naddr_port = VIU_OSD1_EOTF_LUT_ADDR_PORT;\r\ndata_port = VIU_OSD1_EOTF_LUT_DATA_PORT;\r\nctrl_port = VIU_OSD1_EOTF_CTL;\r\n} else if (lut_sel == VIU_LUT_OSD_OETF) {\r\naddr_port = VIU_OSD1_OETF_LUT_ADDR_PORT;\r\ndata_port = VIU_OSD1_OETF_LUT_DATA_PORT;\r\nctrl_port = VIU_OSD1_OETF_CTL;\r\n} else\r\nreturn;\r\nif (lut_sel == VIU_LUT_OSD_OETF) {\r\nwritel(0, priv->io_base + _REG(addr_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(r_map[i * 2] | (r_map[i * 2 + 1] << 16),\r\npriv->io_base + _REG(data_port));\r\nwritel(r_map[OSD_OETF_LUT_SIZE - 1] | (g_map[0] << 16),\r\npriv->io_base + _REG(data_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(g_map[i * 2 + 1] | (g_map[i * 2 + 2] << 16),\r\npriv->io_base + _REG(data_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(b_map[i * 2] | (b_map[i * 2 + 1] << 16),\r\npriv->io_base + _REG(data_port));\r\nwritel(b_map[OSD_OETF_LUT_SIZE - 1],\r\npriv->io_base + _REG(data_port));\r\nif (csc_on)\r\nwritel_bits_relaxed(0x7 << 29, 7 << 29,\r\npriv->io_base + _REG(ctrl_port));\r\nelse\r\nwritel_bits_relaxed(0x7 << 29, 0,\r\npriv->io_base + _REG(ctrl_port));\r\n} else if (lut_sel == VIU_LUT_OSD_EOTF) {\r\nwritel(0, priv->io_base + _REG(addr_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(r_map[i * 2] | (r_map[i * 2 + 1] << 16),\r\npriv->io_base + _REG(data_port));\r\nwritel(r_map[OSD_EOTF_LUT_SIZE - 1] | (g_map[0] << 16),\r\npriv->io_base + _REG(data_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(g_map[i * 2 + 1] | (g_map[i * 2 + 2] << 16),\r\npriv->io_base + _REG(data_port));\r\nfor (i = 0; i < 20; i++)\r\nwritel(b_map[i * 2] | (b_map[i * 2 + 1] << 16),\r\npriv->io_base + _REG(data_port));\r\nwritel(b_map[OSD_EOTF_LUT_SIZE - 1],\r\npriv->io_base + _REG(data_port));\r\nif (csc_on)\r\nwritel_bits_relaxed(7 << 27, 7 << 27,\r\npriv->io_base + _REG(ctrl_port));\r\nelse\r\nwritel_bits_relaxed(7 << 27, 0,\r\npriv->io_base + _REG(ctrl_port));\r\nwritel_bits_relaxed(BIT(31), BIT(31),\r\npriv->io_base + _REG(ctrl_port));\r\n}\r\n}\r\nstatic void meson_viu_load_matrix(struct meson_drm *priv)\r\n{\r\nmeson_viu_set_osd_lut(priv, VIU_LUT_OSD_EOTF,\r\neotf_33_linear_mapping,\r\neotf_33_linear_mapping,\r\neotf_33_linear_mapping,\r\nfalse);\r\nmeson_viu_set_osd_matrix(priv, VIU_MATRIX_OSD_EOTF,\r\neotf_bypass_coeff,\r\nfalse);\r\nmeson_viu_set_osd_lut(priv, VIU_LUT_OSD_OETF,\r\noetf_41_linear_mapping,\r\noetf_41_linear_mapping,\r\noetf_41_linear_mapping,\r\nfalse);\r\nmeson_viu_set_osd_matrix(priv, VIU_MATRIX_OSD,\r\nRGB709_to_YUV709l_coeff,\r\ntrue);\r\n}\r\nvoid meson_viu_init(struct meson_drm *priv)\r\n{\r\nuint32_t reg;\r\nwritel_bits_relaxed(BIT(0) | BIT(21), 0,\r\npriv->io_base + _REG(VIU_OSD1_CTRL_STAT));\r\nwritel_bits_relaxed(BIT(0) | BIT(21), 0,\r\npriv->io_base + _REG(VIU_OSD2_CTRL_STAT));\r\nif (meson_vpu_is_compatible(priv, "amlogic,meson-gxm-vpu") ||\r\nmeson_vpu_is_compatible(priv, "amlogic,meson-gxl-vpu"))\r\nmeson_viu_load_matrix(priv);\r\nreg = BIT(0) |\r\n(4 << 5) |\r\n(3 << 10) |\r\n(32 << 12) |\r\n(2 << 22) |\r\n(2 << 24);\r\nwritel_relaxed(reg, priv->io_base + _REG(VIU_OSD1_FIFO_CTRL_STAT));\r\nwritel_relaxed(reg, priv->io_base + _REG(VIU_OSD2_FIFO_CTRL_STAT));\r\nwritel_bits_relaxed(0xff << OSD_REPLACE_SHIFT,\r\n0xff << OSD_REPLACE_SHIFT,\r\npriv->io_base + _REG(VIU_OSD1_CTRL_STAT2));\r\nwritel_bits_relaxed(0xff << OSD_REPLACE_SHIFT,\r\n0xff << OSD_REPLACE_SHIFT,\r\npriv->io_base + _REG(VIU_OSD2_CTRL_STAT2));\r\npriv->viu.osd1_enabled = false;\r\npriv->viu.osd1_commit = false;\r\npriv->viu.osd1_interlace = false;\r\n}

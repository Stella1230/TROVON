static inline struct w5100_mmio_priv *w5100_mmio_priv(struct net_device *dev)\r\n{\r\nreturn w5100_ops_priv(dev);\r\n}\r\nstatic inline void __iomem *w5100_mmio(struct net_device *ndev)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nreturn mmio_priv->base;\r\n}\r\nstatic inline int w5100_read_direct(struct net_device *ndev, u32 addr)\r\n{\r\nreturn ioread8(w5100_mmio(ndev) + (addr << CONFIG_WIZNET_BUS_SHIFT));\r\n}\r\nstatic inline int __w5100_write_direct(struct net_device *ndev, u32 addr,\r\nu8 data)\r\n{\r\niowrite8(data, w5100_mmio(ndev) + (addr << CONFIG_WIZNET_BUS_SHIFT));\r\nreturn 0;\r\n}\r\nstatic inline int w5100_write_direct(struct net_device *ndev, u32 addr, u8 data)\r\n{\r\n__w5100_write_direct(ndev, addr, data);\r\nmmiowb();\r\nreturn 0;\r\n}\r\nstatic int w5100_read16_direct(struct net_device *ndev, u32 addr)\r\n{\r\nu16 data;\r\ndata = w5100_read_direct(ndev, addr) << 8;\r\ndata |= w5100_read_direct(ndev, addr + 1);\r\nreturn data;\r\n}\r\nstatic int w5100_write16_direct(struct net_device *ndev, u32 addr, u16 data)\r\n{\r\n__w5100_write_direct(ndev, addr, data >> 8);\r\n__w5100_write_direct(ndev, addr + 1, data);\r\nmmiowb();\r\nreturn 0;\r\n}\r\nstatic int w5100_readbulk_direct(struct net_device *ndev, u32 addr, u8 *buf,\r\nint len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++, addr++)\r\n*buf++ = w5100_read_direct(ndev, addr);\r\nreturn 0;\r\n}\r\nstatic int w5100_writebulk_direct(struct net_device *ndev, u32 addr,\r\nconst u8 *buf, int len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++, addr++)\r\n__w5100_write_direct(ndev, addr, *buf++);\r\nmmiowb();\r\nreturn 0;\r\n}\r\nstatic int w5100_mmio_init(struct net_device *ndev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(ndev->dev.parent);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nstruct resource *mem;\r\nspin_lock_init(&mmio_priv->reg_lock);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmmio_priv->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(mmio_priv->base))\r\nreturn PTR_ERR(mmio_priv->base);\r\nnetdev_info(ndev, "at 0x%llx irq %d\n", (u64)mem->start, priv->irq);\r\nreturn 0;\r\n}\r\nstatic int w5100_read_indirect(struct net_device *ndev, u32 addr)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nu8 data;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\ndata = w5100_read_direct(ndev, W5100_IDM_DR);\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn data;\r\n}\r\nstatic int w5100_write_indirect(struct net_device *ndev, u32 addr, u8 data)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\nw5100_write_direct(ndev, W5100_IDM_DR, data);\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int w5100_read16_indirect(struct net_device *ndev, u32 addr)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nu16 data;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\ndata = w5100_read_direct(ndev, W5100_IDM_DR) << 8;\r\ndata |= w5100_read_direct(ndev, W5100_IDM_DR);\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn data;\r\n}\r\nstatic int w5100_write16_indirect(struct net_device *ndev, u32 addr, u16 data)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\n__w5100_write_direct(ndev, W5100_IDM_DR, data >> 8);\r\nw5100_write_direct(ndev, W5100_IDM_DR, data);\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int w5100_readbulk_indirect(struct net_device *ndev, u32 addr, u8 *buf,\r\nint len)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\nfor (i = 0; i < len; i++)\r\n*buf++ = w5100_read_direct(ndev, W5100_IDM_DR);\r\nmmiowb();\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int w5100_writebulk_indirect(struct net_device *ndev, u32 addr,\r\nconst u8 *buf, int len)\r\n{\r\nstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&mmio_priv->reg_lock, flags);\r\nw5100_write16_direct(ndev, W5100_IDM_AR, addr);\r\nfor (i = 0; i < len; i++)\r\n__w5100_write_direct(ndev, W5100_IDM_DR, *buf++);\r\nmmiowb();\r\nspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int w5100_reset_indirect(struct net_device *ndev)\r\n{\r\nw5100_write_direct(ndev, W5100_MR, MR_RST);\r\nmdelay(5);\r\nw5100_write_direct(ndev, W5100_MR, MR_PB | MR_AI | MR_IND);\r\nreturn 0;\r\n}\r\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn w5100_read_direct(priv->ndev, addr);\r\n}\r\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\r\n{\r\nreturn w5100_write_direct(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn w5100_read16_direct(priv->ndev, addr);\r\n}\r\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\r\n{\r\nreturn w5100_write16_direct(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\r\n{\r\nreturn w5100_readbulk_direct(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nreturn w5100_writebulk_direct(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn w5100_read_indirect(priv->ndev, addr);\r\n}\r\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\r\n{\r\nreturn w5100_write_indirect(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn w5100_read16_indirect(priv->ndev, addr);\r\n}\r\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\r\n{\r\nreturn w5100_write16_indirect(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\r\n{\r\nreturn w5100_readbulk_indirect(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nreturn w5100_writebulk_indirect(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn priv->ops->read(priv->ndev, addr);\r\n}\r\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\r\n{\r\nreturn priv->ops->write(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\r\n{\r\nreturn priv->ops->read16(priv->ndev, addr);\r\n}\r\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\r\n{\r\nreturn priv->ops->write16(priv->ndev, addr, data);\r\n}\r\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\r\n{\r\nreturn priv->ops->readbulk(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nreturn priv->ops->writebulk(priv->ndev, addr, buf, len);\r\n}\r\nstatic int w5100_readbuf(struct w5100_priv *priv, u16 offset, u8 *buf, int len)\r\n{\r\nu32 addr;\r\nint remain = 0;\r\nint ret;\r\nconst u32 mem_start = priv->s0_rx_buf;\r\nconst u16 mem_size = priv->s0_rx_buf_size;\r\noffset %= mem_size;\r\naddr = mem_start + offset;\r\nif (offset + len > mem_size) {\r\nremain = (offset + len) % mem_size;\r\nlen = mem_size - offset;\r\n}\r\nret = w5100_readbulk(priv, addr, buf, len);\r\nif (ret || !remain)\r\nreturn ret;\r\nreturn w5100_readbulk(priv, mem_start, buf + len, remain);\r\n}\r\nstatic int w5100_writebuf(struct w5100_priv *priv, u16 offset, const u8 *buf,\r\nint len)\r\n{\r\nu32 addr;\r\nint ret;\r\nint remain = 0;\r\nconst u32 mem_start = priv->s0_tx_buf;\r\nconst u16 mem_size = priv->s0_tx_buf_size;\r\noffset %= mem_size;\r\naddr = mem_start + offset;\r\nif (offset + len > mem_size) {\r\nremain = (offset + len) % mem_size;\r\nlen = mem_size - offset;\r\n}\r\nret = w5100_writebulk(priv, addr, buf, len);\r\nif (ret || !remain)\r\nreturn ret;\r\nreturn w5100_writebulk(priv, mem_start, buf + len, remain);\r\n}\r\nstatic int w5100_reset(struct w5100_priv *priv)\r\n{\r\nif (priv->ops->reset)\r\nreturn priv->ops->reset(priv->ndev);\r\nw5100_write(priv, W5100_MR, MR_RST);\r\nmdelay(5);\r\nw5100_write(priv, W5100_MR, MR_PB);\r\nreturn 0;\r\n}\r\nstatic int w5100_command(struct w5100_priv *priv, u16 cmd)\r\n{\r\nunsigned long timeout;\r\nw5100_write(priv, W5100_S0_CR(priv), cmd);\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\nwhile (w5100_read(priv, W5100_S0_CR(priv)) != 0) {\r\nif (time_after(jiffies, timeout))\r\nreturn -EIO;\r\ncpu_relax();\r\n}\r\nreturn 0;\r\n}\r\nstatic void w5100_write_macaddr(struct w5100_priv *priv)\r\n{\r\nstruct net_device *ndev = priv->ndev;\r\nw5100_writebulk(priv, W5100_SHAR, ndev->dev_addr, ETH_ALEN);\r\n}\r\nstatic void w5100_socket_intr_mask(struct w5100_priv *priv, u8 mask)\r\n{\r\nu32 imr;\r\nif (priv->ops->chip_id == W5500)\r\nimr = W5500_SIMR;\r\nelse\r\nimr = W5100_IMR;\r\nw5100_write(priv, imr, mask);\r\n}\r\nstatic void w5100_enable_intr(struct w5100_priv *priv)\r\n{\r\nw5100_socket_intr_mask(priv, IR_S0);\r\n}\r\nstatic void w5100_disable_intr(struct w5100_priv *priv)\r\n{\r\nw5100_socket_intr_mask(priv, 0);\r\n}\r\nstatic void w5100_memory_configure(struct w5100_priv *priv)\r\n{\r\nw5100_write(priv, W5100_RMSR, 0x03);\r\nw5100_write(priv, W5100_TMSR, 0x03);\r\n}\r\nstatic void w5200_memory_configure(struct w5100_priv *priv)\r\n{\r\nint i;\r\nw5100_write(priv, W5200_Sn_RXMEM_SIZE(0), 0x10);\r\nw5100_write(priv, W5200_Sn_TXMEM_SIZE(0), 0x10);\r\nfor (i = 1; i < 8; i++) {\r\nw5100_write(priv, W5200_Sn_RXMEM_SIZE(i), 0);\r\nw5100_write(priv, W5200_Sn_TXMEM_SIZE(i), 0);\r\n}\r\n}\r\nstatic void w5500_memory_configure(struct w5100_priv *priv)\r\n{\r\nint i;\r\nw5100_write(priv, W5500_Sn_RXMEM_SIZE(0), 0x10);\r\nw5100_write(priv, W5500_Sn_TXMEM_SIZE(0), 0x10);\r\nfor (i = 1; i < 8; i++) {\r\nw5100_write(priv, W5500_Sn_RXMEM_SIZE(i), 0);\r\nw5100_write(priv, W5500_Sn_TXMEM_SIZE(i), 0);\r\n}\r\n}\r\nstatic int w5100_hw_reset(struct w5100_priv *priv)\r\n{\r\nu32 rtr;\r\nw5100_reset(priv);\r\nw5100_disable_intr(priv);\r\nw5100_write_macaddr(priv);\r\nswitch (priv->ops->chip_id) {\r\ncase W5100:\r\nw5100_memory_configure(priv);\r\nrtr = W5100_RTR;\r\nbreak;\r\ncase W5200:\r\nw5200_memory_configure(priv);\r\nrtr = W5100_RTR;\r\nbreak;\r\ncase W5500:\r\nw5500_memory_configure(priv);\r\nrtr = W5500_RTR;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (w5100_read16(priv, rtr) != RTR_DEFAULT)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void w5100_hw_start(struct w5100_priv *priv)\r\n{\r\nu8 mode = S0_MR_MACRAW;\r\nif (!priv->promisc) {\r\nif (priv->ops->chip_id == W5500)\r\nmode |= W5500_S0_MR_MF;\r\nelse\r\nmode |= S0_MR_MF;\r\n}\r\nw5100_write(priv, W5100_S0_MR(priv), mode);\r\nw5100_command(priv, S0_CR_OPEN);\r\nw5100_enable_intr(priv);\r\n}\r\nstatic void w5100_hw_close(struct w5100_priv *priv)\r\n{\r\nw5100_disable_intr(priv);\r\nw5100_command(priv, S0_CR_CLOSE);\r\n}\r\nstatic void w5100_get_drvinfo(struct net_device *ndev,\r\nstruct ethtool_drvinfo *info)\r\n{\r\nstrlcpy(info->driver, DRV_NAME, sizeof(info->driver));\r\nstrlcpy(info->version, DRV_VERSION, sizeof(info->version));\r\nstrlcpy(info->bus_info, dev_name(ndev->dev.parent),\r\nsizeof(info->bus_info));\r\n}\r\nstatic u32 w5100_get_link(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (gpio_is_valid(priv->link_gpio))\r\nreturn !!gpio_get_value(priv->link_gpio);\r\nreturn 1;\r\n}\r\nstatic u32 w5100_get_msglevel(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nreturn priv->msg_enable;\r\n}\r\nstatic void w5100_set_msglevel(struct net_device *ndev, u32 value)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\npriv->msg_enable = value;\r\n}\r\nstatic int w5100_get_regs_len(struct net_device *ndev)\r\n{\r\nreturn W5100_COMMON_REGS_LEN + W5100_S0_REGS_LEN;\r\n}\r\nstatic void w5100_get_regs(struct net_device *ndev,\r\nstruct ethtool_regs *regs, void *buf)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nregs->version = 1;\r\nw5100_readbulk(priv, W5100_COMMON_REGS, buf, W5100_COMMON_REGS_LEN);\r\nbuf += W5100_COMMON_REGS_LEN;\r\nw5100_readbulk(priv, S0_REGS(priv), buf, W5100_S0_REGS_LEN);\r\n}\r\nstatic void w5100_restart(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_stop_queue(ndev);\r\nw5100_hw_reset(priv);\r\nw5100_hw_start(priv);\r\nndev->stats.tx_errors++;\r\nnetif_trans_update(ndev);\r\nnetif_wake_queue(ndev);\r\n}\r\nstatic void w5100_restart_work(struct work_struct *work)\r\n{\r\nstruct w5100_priv *priv = container_of(work, struct w5100_priv,\r\nrestart_work);\r\nw5100_restart(priv->ndev);\r\n}\r\nstatic void w5100_tx_timeout(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (priv->ops->may_sleep)\r\nschedule_work(&priv->restart_work);\r\nelse\r\nw5100_restart(ndev);\r\n}\r\nstatic void w5100_tx_skb(struct net_device *ndev, struct sk_buff *skb)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nu16 offset;\r\noffset = w5100_read16(priv, W5100_S0_TX_WR(priv));\r\nw5100_writebuf(priv, offset, skb->data, skb->len);\r\nw5100_write16(priv, W5100_S0_TX_WR(priv), offset + skb->len);\r\nndev->stats.tx_bytes += skb->len;\r\nndev->stats.tx_packets++;\r\ndev_kfree_skb(skb);\r\nw5100_command(priv, S0_CR_SEND);\r\n}\r\nstatic void w5100_tx_work(struct work_struct *work)\r\n{\r\nstruct w5100_priv *priv = container_of(work, struct w5100_priv,\r\ntx_work);\r\nstruct sk_buff *skb = priv->tx_skb;\r\npriv->tx_skb = NULL;\r\nif (WARN_ON(!skb))\r\nreturn;\r\nw5100_tx_skb(priv->ndev, skb);\r\n}\r\nstatic int w5100_start_tx(struct sk_buff *skb, struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_stop_queue(ndev);\r\nif (priv->ops->may_sleep) {\r\nWARN_ON(priv->tx_skb);\r\npriv->tx_skb = skb;\r\nqueue_work(priv->xfer_wq, &priv->tx_work);\r\n} else {\r\nw5100_tx_skb(ndev, skb);\r\n}\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic struct sk_buff *w5100_rx_skb(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nstruct sk_buff *skb;\r\nu16 rx_len;\r\nu16 offset;\r\nu8 header[2];\r\nu16 rx_buf_len = w5100_read16(priv, W5100_S0_RX_RSR(priv));\r\nif (rx_buf_len == 0)\r\nreturn NULL;\r\noffset = w5100_read16(priv, W5100_S0_RX_RD(priv));\r\nw5100_readbuf(priv, offset, header, 2);\r\nrx_len = get_unaligned_be16(header) - 2;\r\nskb = netdev_alloc_skb_ip_align(ndev, rx_len);\r\nif (unlikely(!skb)) {\r\nw5100_write16(priv, W5100_S0_RX_RD(priv), offset + rx_buf_len);\r\nw5100_command(priv, S0_CR_RECV);\r\nndev->stats.rx_dropped++;\r\nreturn NULL;\r\n}\r\nskb_put(skb, rx_len);\r\nw5100_readbuf(priv, offset + 2, skb->data, rx_len);\r\nw5100_write16(priv, W5100_S0_RX_RD(priv), offset + 2 + rx_len);\r\nw5100_command(priv, S0_CR_RECV);\r\nskb->protocol = eth_type_trans(skb, ndev);\r\nndev->stats.rx_packets++;\r\nndev->stats.rx_bytes += rx_len;\r\nreturn skb;\r\n}\r\nstatic void w5100_rx_work(struct work_struct *work)\r\n{\r\nstruct w5100_priv *priv = container_of(work, struct w5100_priv,\r\nrx_work);\r\nstruct sk_buff *skb;\r\nwhile ((skb = w5100_rx_skb(priv->ndev)))\r\nnetif_rx_ni(skb);\r\nw5100_enable_intr(priv);\r\n}\r\nstatic int w5100_napi_poll(struct napi_struct *napi, int budget)\r\n{\r\nstruct w5100_priv *priv = container_of(napi, struct w5100_priv, napi);\r\nint rx_count;\r\nfor (rx_count = 0; rx_count < budget; rx_count++) {\r\nstruct sk_buff *skb = w5100_rx_skb(priv->ndev);\r\nif (skb)\r\nnetif_receive_skb(skb);\r\nelse\r\nbreak;\r\n}\r\nif (rx_count < budget) {\r\nnapi_complete_done(napi, rx_count);\r\nw5100_enable_intr(priv);\r\n}\r\nreturn rx_count;\r\n}\r\nstatic irqreturn_t w5100_interrupt(int irq, void *ndev_instance)\r\n{\r\nstruct net_device *ndev = ndev_instance;\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nint ir = w5100_read(priv, W5100_S0_IR(priv));\r\nif (!ir)\r\nreturn IRQ_NONE;\r\nw5100_write(priv, W5100_S0_IR(priv), ir);\r\nif (ir & S0_IR_SENDOK) {\r\nnetif_dbg(priv, tx_done, ndev, "tx done\n");\r\nnetif_wake_queue(ndev);\r\n}\r\nif (ir & S0_IR_RECV) {\r\nw5100_disable_intr(priv);\r\nif (priv->ops->may_sleep)\r\nqueue_work(priv->xfer_wq, &priv->rx_work);\r\nelse if (napi_schedule_prep(&priv->napi))\r\n__napi_schedule(&priv->napi);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t w5100_detect_link(int irq, void *ndev_instance)\r\n{\r\nstruct net_device *ndev = ndev_instance;\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nif (gpio_get_value(priv->link_gpio) != 0) {\r\nnetif_info(priv, link, ndev, "link is up\n");\r\nnetif_carrier_on(ndev);\r\n} else {\r\nnetif_info(priv, link, ndev, "link is down\n");\r\nnetif_carrier_off(ndev);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void w5100_setrx_work(struct work_struct *work)\r\n{\r\nstruct w5100_priv *priv = container_of(work, struct w5100_priv,\r\nsetrx_work);\r\nw5100_hw_start(priv);\r\n}\r\nstatic void w5100_set_rx_mode(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nbool set_promisc = (ndev->flags & IFF_PROMISC) != 0;\r\nif (priv->promisc != set_promisc) {\r\npriv->promisc = set_promisc;\r\nif (priv->ops->may_sleep)\r\nschedule_work(&priv->setrx_work);\r\nelse\r\nw5100_hw_start(priv);\r\n}\r\n}\r\nstatic int w5100_set_macaddr(struct net_device *ndev, void *addr)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nstruct sockaddr *sock_addr = addr;\r\nif (!is_valid_ether_addr(sock_addr->sa_data))\r\nreturn -EADDRNOTAVAIL;\r\nmemcpy(ndev->dev_addr, sock_addr->sa_data, ETH_ALEN);\r\nw5100_write_macaddr(priv);\r\nreturn 0;\r\n}\r\nstatic int w5100_open(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_info(priv, ifup, ndev, "enabling\n");\r\nw5100_hw_start(priv);\r\nnapi_enable(&priv->napi);\r\nnetif_start_queue(ndev);\r\nif (!gpio_is_valid(priv->link_gpio) ||\r\ngpio_get_value(priv->link_gpio) != 0)\r\nnetif_carrier_on(ndev);\r\nreturn 0;\r\n}\r\nstatic int w5100_stop(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_info(priv, ifdown, ndev, "shutting down\n");\r\nw5100_hw_close(priv);\r\nnetif_carrier_off(ndev);\r\nnetif_stop_queue(ndev);\r\nnapi_disable(&priv->napi);\r\nreturn 0;\r\n}\r\nstatic int w5100_mmio_probe(struct platform_device *pdev)\r\n{\r\nstruct wiznet_platform_data *data = dev_get_platdata(&pdev->dev);\r\nconst void *mac_addr = NULL;\r\nstruct resource *mem;\r\nconst struct w5100_ops *ops;\r\nint irq;\r\nif (data && is_valid_ether_addr(data->mac_addr))\r\nmac_addr = data->mac_addr;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (resource_size(mem) < W5100_BUS_DIRECT_SIZE)\r\nops = &w5100_mmio_indirect_ops;\r\nelse\r\nops = &w5100_mmio_direct_ops;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\nreturn w5100_probe(&pdev->dev, ops, sizeof(struct w5100_mmio_priv),\r\nmac_addr, irq, data ? data->link_gpio : -EINVAL);\r\n}\r\nstatic int w5100_mmio_remove(struct platform_device *pdev)\r\n{\r\nreturn w5100_remove(&pdev->dev);\r\n}\r\nvoid *w5100_ops_priv(const struct net_device *ndev)\r\n{\r\nreturn netdev_priv(ndev) +\r\nALIGN(sizeof(struct w5100_priv), NETDEV_ALIGN);\r\n}\r\nint w5100_probe(struct device *dev, const struct w5100_ops *ops,\r\nint sizeof_ops_priv, const void *mac_addr, int irq,\r\nint link_gpio)\r\n{\r\nstruct w5100_priv *priv;\r\nstruct net_device *ndev;\r\nint err;\r\nsize_t alloc_size;\r\nalloc_size = sizeof(*priv);\r\nif (sizeof_ops_priv) {\r\nalloc_size = ALIGN(alloc_size, NETDEV_ALIGN);\r\nalloc_size += sizeof_ops_priv;\r\n}\r\nalloc_size += NETDEV_ALIGN - 1;\r\nndev = alloc_etherdev(alloc_size);\r\nif (!ndev)\r\nreturn -ENOMEM;\r\nSET_NETDEV_DEV(ndev, dev);\r\ndev_set_drvdata(dev, ndev);\r\npriv = netdev_priv(ndev);\r\nswitch (ops->chip_id) {\r\ncase W5100:\r\npriv->s0_regs = W5100_S0_REGS;\r\npriv->s0_tx_buf = W5100_TX_MEM_START;\r\npriv->s0_tx_buf_size = W5100_TX_MEM_SIZE;\r\npriv->s0_rx_buf = W5100_RX_MEM_START;\r\npriv->s0_rx_buf_size = W5100_RX_MEM_SIZE;\r\nbreak;\r\ncase W5200:\r\npriv->s0_regs = W5200_S0_REGS;\r\npriv->s0_tx_buf = W5200_TX_MEM_START;\r\npriv->s0_tx_buf_size = W5200_TX_MEM_SIZE;\r\npriv->s0_rx_buf = W5200_RX_MEM_START;\r\npriv->s0_rx_buf_size = W5200_RX_MEM_SIZE;\r\nbreak;\r\ncase W5500:\r\npriv->s0_regs = W5500_S0_REGS;\r\npriv->s0_tx_buf = W5500_TX_MEM_START;\r\npriv->s0_tx_buf_size = W5500_TX_MEM_SIZE;\r\npriv->s0_rx_buf = W5500_RX_MEM_START;\r\npriv->s0_rx_buf_size = W5500_RX_MEM_SIZE;\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\ngoto err_register;\r\n}\r\npriv->ndev = ndev;\r\npriv->ops = ops;\r\npriv->irq = irq;\r\npriv->link_gpio = link_gpio;\r\nndev->netdev_ops = &w5100_netdev_ops;\r\nndev->ethtool_ops = &w5100_ethtool_ops;\r\nnetif_napi_add(ndev, &priv->napi, w5100_napi_poll, 16);\r\nndev->features |= NETIF_F_VLAN_CHALLENGED;\r\nerr = register_netdev(ndev);\r\nif (err < 0)\r\ngoto err_register;\r\npriv->xfer_wq = alloc_workqueue("%s", WQ_MEM_RECLAIM, 0,\r\nnetdev_name(ndev));\r\nif (!priv->xfer_wq) {\r\nerr = -ENOMEM;\r\ngoto err_wq;\r\n}\r\nINIT_WORK(&priv->rx_work, w5100_rx_work);\r\nINIT_WORK(&priv->tx_work, w5100_tx_work);\r\nINIT_WORK(&priv->setrx_work, w5100_setrx_work);\r\nINIT_WORK(&priv->restart_work, w5100_restart_work);\r\nif (mac_addr)\r\nmemcpy(ndev->dev_addr, mac_addr, ETH_ALEN);\r\nelse\r\neth_hw_addr_random(ndev);\r\nif (priv->ops->init) {\r\nerr = priv->ops->init(priv->ndev);\r\nif (err)\r\ngoto err_hw;\r\n}\r\nerr = w5100_hw_reset(priv);\r\nif (err)\r\ngoto err_hw;\r\nif (ops->may_sleep) {\r\nerr = request_threaded_irq(priv->irq, NULL, w5100_interrupt,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\nnetdev_name(ndev), ndev);\r\n} else {\r\nerr = request_irq(priv->irq, w5100_interrupt,\r\nIRQF_TRIGGER_LOW, netdev_name(ndev), ndev);\r\n}\r\nif (err)\r\ngoto err_hw;\r\nif (gpio_is_valid(priv->link_gpio)) {\r\nchar *link_name = devm_kzalloc(dev, 16, GFP_KERNEL);\r\nif (!link_name) {\r\nerr = -ENOMEM;\r\ngoto err_gpio;\r\n}\r\nsnprintf(link_name, 16, "%s-link", netdev_name(ndev));\r\npriv->link_irq = gpio_to_irq(priv->link_gpio);\r\nif (request_any_context_irq(priv->link_irq, w5100_detect_link,\r\nIRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING,\r\nlink_name, priv->ndev) < 0)\r\npriv->link_gpio = -EINVAL;\r\n}\r\nreturn 0;\r\nerr_gpio:\r\nfree_irq(priv->irq, ndev);\r\nerr_hw:\r\ndestroy_workqueue(priv->xfer_wq);\r\nerr_wq:\r\nunregister_netdev(ndev);\r\nerr_register:\r\nfree_netdev(ndev);\r\nreturn err;\r\n}\r\nint w5100_remove(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nw5100_hw_reset(priv);\r\nfree_irq(priv->irq, ndev);\r\nif (gpio_is_valid(priv->link_gpio))\r\nfree_irq(priv->link_irq, ndev);\r\nflush_work(&priv->setrx_work);\r\nflush_work(&priv->restart_work);\r\ndestroy_workqueue(priv->xfer_wq);\r\nunregister_netdev(ndev);\r\nfree_netdev(ndev);\r\nreturn 0;\r\n}\r\nstatic int w5100_suspend(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nnetif_carrier_off(ndev);\r\nnetif_device_detach(ndev);\r\nw5100_hw_close(priv);\r\n}\r\nreturn 0;\r\n}\r\nstatic int w5100_resume(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nw5100_hw_reset(priv);\r\nw5100_hw_start(priv);\r\nnetif_device_attach(ndev);\r\nif (!gpio_is_valid(priv->link_gpio) ||\r\ngpio_get_value(priv->link_gpio) != 0)\r\nnetif_carrier_on(ndev);\r\n}\r\nreturn 0;\r\n}

static int bfin_cf_reset(void)\r\n{\r\noutw(0, CF_ATASEL_ENA);\r\nmdelay(200);\r\noutw(0, CF_ATASEL_DIS);\r\nreturn 0;\r\n}\r\nstatic int bfin_cf_ss_init(struct pcmcia_socket *s)\r\n{\r\nreturn 0;\r\n}\r\nstatic void bfin_cf_timer(unsigned long _cf)\r\n{\r\nstruct bfin_cf_socket *cf = (void *)_cf;\r\nunsigned short present = bfin_cf_present(cf->cd_pfx);\r\nif (present != cf->present) {\r\ncf->present = present;\r\ndev_dbg(&cf->pdev->dev, ": card %s\n",\r\npresent ? "present" : "gone");\r\npcmcia_parse_events(&cf->socket, SS_DETECT);\r\n}\r\nif (cf->active)\r\nmod_timer(&cf->timer, jiffies + POLL_INTERVAL);\r\n}\r\nstatic int bfin_cf_get_status(struct pcmcia_socket *s, u_int *sp)\r\n{\r\nstruct bfin_cf_socket *cf;\r\nif (!sp)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct bfin_cf_socket, socket);\r\nif (bfin_cf_present(cf->cd_pfx)) {\r\n*sp = SS_READY | SS_DETECT | SS_POWERON | SS_3VCARD;\r\ns->pcmcia_irq = 0;\r\ns->pci_irq = cf->irq;\r\n} else\r\n*sp = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfin_cf_set_socket(struct pcmcia_socket *sock, struct socket_state_t *s)\r\n{\r\nstruct bfin_cf_socket *cf;\r\ncf = container_of(sock, struct bfin_cf_socket, socket);\r\nswitch (s->Vcc) {\r\ncase 0:\r\ncase 33:\r\nbreak;\r\ncase 50:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (s->flags & SS_RESET) {\r\ndisable_irq(cf->irq);\r\nbfin_cf_reset();\r\nenable_irq(cf->irq);\r\n}\r\ndev_dbg(&cf->pdev->dev, ": Vcc %d, io_irq %d, flags %04x csc %04x\n",\r\ns->Vcc, s->io_irq, s->flags, s->csc_mask);\r\nreturn 0;\r\n}\r\nstatic int bfin_cf_ss_suspend(struct pcmcia_socket *s)\r\n{\r\nreturn bfin_cf_set_socket(s, &dead_socket);\r\n}\r\nstatic int bfin_cf_set_io_map(struct pcmcia_socket *s, struct pccard_io_map *io)\r\n{\r\nstruct bfin_cf_socket *cf;\r\ncf = container_of(s, struct bfin_cf_socket, socket);\r\nio->flags &= MAP_ACTIVE | MAP_ATTRIB | MAP_16BIT;\r\nio->start = cf->phys_cf_io;\r\nio->stop = io->start + SZ_2K - 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfin_cf_set_mem_map(struct pcmcia_socket *s, struct pccard_mem_map *map)\r\n{\r\nstruct bfin_cf_socket *cf;\r\nif (map->card_start)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct bfin_cf_socket, socket);\r\nmap->static_start = cf->phys_cf_io;\r\nmap->flags &= MAP_ACTIVE | MAP_ATTRIB | MAP_16BIT;\r\nif (map->flags & MAP_ATTRIB)\r\nmap->static_start = cf->phys_cf_attr;\r\nreturn 0;\r\n}\r\nstatic int bfin_cf_probe(struct platform_device *pdev)\r\n{\r\nstruct bfin_cf_socket *cf;\r\nstruct resource *io_mem, *attr_mem;\r\nint irq;\r\nunsigned short cd_pfx;\r\nint status = 0;\r\ndev_info(&pdev->dev, "Blackfin CompactFlash/PCMCIA Socket Driver\n");\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0)\r\nreturn -EINVAL;\r\ncd_pfx = platform_get_irq(pdev, 1);\r\nif (gpio_request(cd_pfx, "pcmcia: CD")) {\r\ndev_err(&pdev->dev,\r\n"Failed ro request Card Detect GPIO_%d\n",\r\ncd_pfx);\r\nreturn -EBUSY;\r\n}\r\ngpio_direction_input(cd_pfx);\r\ncf = kzalloc(sizeof *cf, GFP_KERNEL);\r\nif (!cf) {\r\ngpio_free(cd_pfx);\r\nreturn -ENOMEM;\r\n}\r\ncf->cd_pfx = cd_pfx;\r\nsetup_timer(&cf->timer, bfin_cf_timer, (unsigned long)cf);\r\ncf->pdev = pdev;\r\nplatform_set_drvdata(pdev, cf);\r\ncf->irq = irq;\r\ncf->socket.pci_irq = irq;\r\nirq_set_irq_type(irq, IRQF_TRIGGER_LOW);\r\nio_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nattr_mem = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!io_mem || !attr_mem)\r\ngoto fail0;\r\ncf->phys_cf_io = io_mem->start;\r\ncf->phys_cf_attr = attr_mem->start;\r\ncf->socket.io_offset = (unsigned long)\r\nioremap(cf->phys_cf_io, SZ_2K);\r\nif (!cf->socket.io_offset)\r\ngoto fail0;\r\ndev_err(&pdev->dev, ": on irq %d\n", irq);\r\ndev_dbg(&pdev->dev, ": %s\n",\r\nbfin_cf_present(cf->cd_pfx) ? "present" : "(not present)");\r\ncf->socket.owner = THIS_MODULE;\r\ncf->socket.dev.parent = &pdev->dev;\r\ncf->socket.ops = &bfin_cf_ops;\r\ncf->socket.resource_ops = &pccard_static_ops;\r\ncf->socket.features = SS_CAP_PCCARD | SS_CAP_STATIC_MAP\r\n| SS_CAP_MEM_ALIGN;\r\ncf->socket.map_size = SZ_2K;\r\nstatus = pcmcia_register_socket(&cf->socket);\r\nif (status < 0)\r\ngoto fail2;\r\ncf->active = 1;\r\nmod_timer(&cf->timer, jiffies + POLL_INTERVAL);\r\nreturn 0;\r\nfail2:\r\niounmap((void __iomem *)cf->socket.io_offset);\r\nrelease_mem_region(cf->phys_cf_io, SZ_8K);\r\nfail0:\r\ngpio_free(cf->cd_pfx);\r\nkfree(cf);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn status;\r\n}\r\nstatic int bfin_cf_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_cf_socket *cf = platform_get_drvdata(pdev);\r\ngpio_free(cf->cd_pfx);\r\ncf->active = 0;\r\npcmcia_unregister_socket(&cf->socket);\r\ndel_timer_sync(&cf->timer);\r\niounmap((void __iomem *)cf->socket.io_offset);\r\nrelease_mem_region(cf->phys_cf_io, SZ_8K);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(cf);\r\nreturn 0;\r\n}

static int tpm_open(struct inode *inode, struct file *file)\r\n{\r\nstruct tpm_chip *chip;\r\nstruct file_priv *priv;\r\nchip = container_of(inode->i_cdev, struct tpm_chip, cdev);\r\nif (test_and_set_bit(0, &chip->is_open)) {\r\ndev_dbg(&chip->dev, "Another process owns this TPM\n");\r\nreturn -EBUSY;\r\n}\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (priv == NULL)\r\ngoto out;\r\ntpm_common_open(file, chip, priv);\r\nreturn 0;\r\nout:\r\nclear_bit(0, &chip->is_open);\r\nreturn -ENOMEM;\r\n}\r\nstatic ssize_t tpm_write(struct file *file, const char __user *buf,\r\nsize_t size, loff_t *off)\r\n{\r\nreturn tpm_common_write(file, buf, size, off, NULL);\r\n}\r\nstatic int tpm_release(struct inode *inode, struct file *file)\r\n{\r\nstruct file_priv *priv = file->private_data;\r\ntpm_common_release(file, priv);\r\nclear_bit(0, &priv->chip->is_open);\r\nkfree(priv);\r\nreturn 0;\r\n}

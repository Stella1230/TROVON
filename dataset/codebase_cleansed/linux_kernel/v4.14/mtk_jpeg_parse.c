static int read_byte(struct mtk_jpeg_stream *stream)\r\n{\r\nif (stream->curr >= stream->size)\r\nreturn -1;\r\nreturn stream->addr[stream->curr++];\r\n}\r\nstatic int read_word_be(struct mtk_jpeg_stream *stream, u32 *word)\r\n{\r\nu32 temp;\r\nint byte;\r\nbyte = read_byte(stream);\r\nif (byte == -1)\r\nreturn -1;\r\ntemp = byte << 8;\r\nbyte = read_byte(stream);\r\nif (byte == -1)\r\nreturn -1;\r\n*word = (u32)byte | temp;\r\nreturn 0;\r\n}\r\nstatic void read_skip(struct mtk_jpeg_stream *stream, long len)\r\n{\r\nif (len <= 0)\r\nreturn;\r\nwhile (len--)\r\nread_byte(stream);\r\n}\r\nstatic bool mtk_jpeg_do_parse(struct mtk_jpeg_dec_param *param, u8 *src_addr_va,\r\nu32 src_size)\r\n{\r\nbool notfound = true;\r\nstruct mtk_jpeg_stream stream;\r\nstream.addr = src_addr_va;\r\nstream.size = src_size;\r\nstream.curr = 0;\r\nwhile (notfound) {\r\nint i, length, byte;\r\nu32 word;\r\nbyte = read_byte(&stream);\r\nif (byte == -1)\r\nreturn false;\r\nif (byte != 0xff)\r\ncontinue;\r\ndo\r\nbyte = read_byte(&stream);\r\nwhile (byte == 0xff);\r\nif (byte == -1)\r\nreturn false;\r\nif (byte == 0)\r\ncontinue;\r\nlength = 0;\r\nswitch (byte) {\r\ncase SOF0:\r\nif (read_word_be(&stream, &word))\r\nbreak;\r\nif (read_byte(&stream) == -1)\r\nbreak;\r\nif (read_word_be(&stream, &word))\r\nbreak;\r\nparam->pic_h = word;\r\nif (read_word_be(&stream, &word))\r\nbreak;\r\nparam->pic_w = word;\r\nparam->comp_num = read_byte(&stream);\r\nif (param->comp_num != 1 && param->comp_num != 3)\r\nbreak;\r\nfor (i = 0; i < param->comp_num; i++) {\r\nparam->comp_id[i] = read_byte(&stream);\r\nif (param->comp_id[i] == -1)\r\nbreak;\r\nbyte = read_byte(&stream);\r\nif (byte == -1)\r\nbreak;\r\nparam->sampling_w[i] = (byte >> 4) & 0x0F;\r\nparam->sampling_h[i] = byte & 0x0F;\r\nparam->qtbl_num[i] = read_byte(&stream);\r\nif (param->qtbl_num[i] == -1)\r\nbreak;\r\n}\r\nnotfound = !(i == param->comp_num);\r\nbreak;\r\ncase RST ... RST + 7:\r\ncase SOI:\r\ncase EOI:\r\ncase TEM:\r\nbreak;\r\ndefault:\r\nif (read_word_be(&stream, &word))\r\nbreak;\r\nlength = (long)word - 2;\r\nread_skip(&stream, length);\r\nbreak;\r\n}\r\n}\r\nreturn !notfound;\r\n}\r\nbool mtk_jpeg_parse(struct mtk_jpeg_dec_param *param, u8 *src_addr_va,\r\nu32 src_size)\r\n{\r\nif (!mtk_jpeg_do_parse(param, src_addr_va, src_size))\r\nreturn false;\r\nif (mtk_jpeg_dec_fill_param(param))\r\nreturn false;\r\nreturn true;\r\n}

int aa_getprocattr(struct aa_label *label, char **string)\r\n{\r\nstruct aa_ns *ns = labels_ns(label);\r\nstruct aa_ns *current_ns = aa_get_current_ns();\r\nint len;\r\nif (!aa_ns_visible(current_ns, ns, true)) {\r\naa_put_ns(current_ns);\r\nreturn -EACCES;\r\n}\r\nlen = aa_label_snxprint(NULL, 0, current_ns, label,\r\nFLAG_SHOW_MODE | FLAG_VIEW_SUBNS |\r\nFLAG_HIDDEN_UNCONFINED);\r\nAA_BUG(len < 0);\r\n*string = kmalloc(len + 2, GFP_KERNEL);\r\nif (!*string) {\r\naa_put_ns(current_ns);\r\nreturn -ENOMEM;\r\n}\r\nlen = aa_label_snxprint(*string, len + 2, current_ns, label,\r\nFLAG_SHOW_MODE | FLAG_VIEW_SUBNS |\r\nFLAG_HIDDEN_UNCONFINED);\r\nif (len < 0) {\r\naa_put_ns(current_ns);\r\nreturn len;\r\n}\r\n(*string)[len] = '\n';\r\n(*string)[len + 1] = 0;\r\naa_put_ns(current_ns);\r\nreturn len + 1;\r\n}\r\nstatic char *split_token_from_name(const char *op, char *args, u64 *token)\r\n{\r\nchar *name;\r\n*token = simple_strtoull(args, &name, 16);\r\nif ((name == args) || *name != '^') {\r\nAA_ERROR("%s: Invalid input '%s'", op, args);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nname++;\r\nif (!*name)\r\nname = NULL;\r\nreturn name;\r\n}\r\nint aa_setprocattr_changehat(char *args, size_t size, int flags)\r\n{\r\nchar *hat;\r\nu64 token;\r\nconst char *hats[16];\r\nint count = 0;\r\nhat = split_token_from_name(OP_CHANGE_HAT, args, &token);\r\nif (IS_ERR(hat))\r\nreturn PTR_ERR(hat);\r\nif (!hat && !token) {\r\nAA_ERROR("change_hat: Invalid input, NULL hat and NULL magic");\r\nreturn -EINVAL;\r\n}\r\nif (hat) {\r\nchar *end = args + size;\r\nfor (count = 0; (hat < end) && count < 16; ++count) {\r\nchar *next = hat + strlen(hat) + 1;\r\nhats[count] = hat;\r\nAA_DEBUG("%s: (pid %d) Magic 0x%llx count %d hat '%s'\n"\r\n, __func__, current->pid, token, count, hat);\r\nhat = next;\r\n}\r\n} else\r\nAA_DEBUG("%s: (pid %d) Magic 0x%llx count %d Hat '%s'\n",\r\n__func__, current->pid, token, count, "<NULL>");\r\nreturn aa_change_hat(hats, count, token, flags);\r\n}

static inline void twofish_enc_blk_3way(struct twofish_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\n__twofish_enc_blk_3way(ctx, dst, src, false);\r\n}\r\nstatic inline void twofish_enc_blk_xor_3way(struct twofish_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\n__twofish_enc_blk_3way(ctx, dst, src, true);\r\n}\r\nvoid twofish_dec_blk_cbc_3way(void *ctx, u128 *dst, const u128 *src)\r\n{\r\nu128 ivs[2];\r\nivs[0] = src[0];\r\nivs[1] = src[1];\r\ntwofish_dec_blk_3way(ctx, (u8 *)dst, (u8 *)src);\r\nu128_xor(&dst[1], &dst[1], &ivs[0]);\r\nu128_xor(&dst[2], &dst[2], &ivs[1]);\r\n}\r\nvoid twofish_enc_blk_ctr(void *ctx, u128 *dst, const u128 *src, le128 *iv)\r\n{\r\nbe128 ctrblk;\r\nif (dst != src)\r\n*dst = *src;\r\nle128_to_be128(&ctrblk, iv);\r\nle128_inc(iv);\r\ntwofish_enc_blk(ctx, (u8 *)&ctrblk, (u8 *)&ctrblk);\r\nu128_xor(dst, dst, (u128 *)&ctrblk);\r\n}\r\nvoid twofish_enc_blk_ctr_3way(void *ctx, u128 *dst, const u128 *src,\r\nle128 *iv)\r\n{\r\nbe128 ctrblks[3];\r\nif (dst != src) {\r\ndst[0] = src[0];\r\ndst[1] = src[1];\r\ndst[2] = src[2];\r\n}\r\nle128_to_be128(&ctrblks[0], iv);\r\nle128_inc(iv);\r\nle128_to_be128(&ctrblks[1], iv);\r\nle128_inc(iv);\r\nle128_to_be128(&ctrblks[2], iv);\r\nle128_inc(iv);\r\ntwofish_enc_blk_xor_3way(ctx, (u8 *)dst, (u8 *)ctrblks);\r\n}\r\nstatic int ecb_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nreturn glue_ecb_crypt_128bit(&twofish_enc, desc, dst, src, nbytes);\r\n}\r\nstatic int ecb_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nreturn glue_ecb_crypt_128bit(&twofish_dec, desc, dst, src, nbytes);\r\n}\r\nstatic int cbc_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nreturn glue_cbc_encrypt_128bit(GLUE_FUNC_CAST(twofish_enc_blk), desc,\r\ndst, src, nbytes);\r\n}\r\nstatic int cbc_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nreturn glue_cbc_decrypt_128bit(&twofish_dec_cbc, desc, dst, src,\r\nnbytes);\r\n}\r\nstatic int ctr_crypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nreturn glue_ctr_crypt_128bit(&twofish_ctr, desc, dst, src, nbytes);\r\n}\r\nstatic void encrypt_callback(void *priv, u8 *srcdst, unsigned int nbytes)\r\n{\r\nconst unsigned int bsize = TF_BLOCK_SIZE;\r\nstruct twofish_ctx *ctx = priv;\r\nint i;\r\nif (nbytes == 3 * bsize) {\r\ntwofish_enc_blk_3way(ctx, srcdst, srcdst);\r\nreturn;\r\n}\r\nfor (i = 0; i < nbytes / bsize; i++, srcdst += bsize)\r\ntwofish_enc_blk(ctx, srcdst, srcdst);\r\n}\r\nstatic void decrypt_callback(void *priv, u8 *srcdst, unsigned int nbytes)\r\n{\r\nconst unsigned int bsize = TF_BLOCK_SIZE;\r\nstruct twofish_ctx *ctx = priv;\r\nint i;\r\nif (nbytes == 3 * bsize) {\r\ntwofish_dec_blk_3way(ctx, srcdst, srcdst);\r\nreturn;\r\n}\r\nfor (i = 0; i < nbytes / bsize; i++, srcdst += bsize)\r\ntwofish_dec_blk(ctx, srcdst, srcdst);\r\n}\r\nint lrw_twofish_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct twofish_lrw_ctx *ctx = crypto_tfm_ctx(tfm);\r\nint err;\r\nerr = __twofish_setkey(&ctx->twofish_ctx, key, keylen - TF_BLOCK_SIZE,\r\n&tfm->crt_flags);\r\nif (err)\r\nreturn err;\r\nreturn lrw_init_table(&ctx->lrw_table, key + keylen - TF_BLOCK_SIZE);\r\n}\r\nstatic int lrw_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct twofish_lrw_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nbe128 buf[3];\r\nstruct lrw_crypt_req req = {\r\n.tbuf = buf,\r\n.tbuflen = sizeof(buf),\r\n.table_ctx = &ctx->lrw_table,\r\n.crypt_ctx = &ctx->twofish_ctx,\r\n.crypt_fn = encrypt_callback,\r\n};\r\nreturn lrw_crypt(desc, dst, src, nbytes, &req);\r\n}\r\nstatic int lrw_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct twofish_lrw_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nbe128 buf[3];\r\nstruct lrw_crypt_req req = {\r\n.tbuf = buf,\r\n.tbuflen = sizeof(buf),\r\n.table_ctx = &ctx->lrw_table,\r\n.crypt_ctx = &ctx->twofish_ctx,\r\n.crypt_fn = decrypt_callback,\r\n};\r\nreturn lrw_crypt(desc, dst, src, nbytes, &req);\r\n}\r\nvoid lrw_twofish_exit_tfm(struct crypto_tfm *tfm)\r\n{\r\nstruct twofish_lrw_ctx *ctx = crypto_tfm_ctx(tfm);\r\nlrw_free_table(&ctx->lrw_table);\r\n}\r\nint xts_twofish_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct twofish_xts_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nint err;\r\nerr = xts_check_key(tfm, key, keylen);\r\nif (err)\r\nreturn err;\r\nerr = __twofish_setkey(&ctx->crypt_ctx, key, keylen / 2, flags);\r\nif (err)\r\nreturn err;\r\nreturn __twofish_setkey(&ctx->tweak_ctx, key + keylen / 2, keylen / 2,\r\nflags);\r\n}\r\nstatic int xts_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct twofish_xts_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nle128 buf[3];\r\nstruct xts_crypt_req req = {\r\n.tbuf = buf,\r\n.tbuflen = sizeof(buf),\r\n.tweak_ctx = &ctx->tweak_ctx,\r\n.tweak_fn = XTS_TWEAK_CAST(twofish_enc_blk),\r\n.crypt_ctx = &ctx->crypt_ctx,\r\n.crypt_fn = encrypt_callback,\r\n};\r\nreturn xts_crypt(desc, dst, src, nbytes, &req);\r\n}\r\nstatic int xts_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct twofish_xts_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nle128 buf[3];\r\nstruct xts_crypt_req req = {\r\n.tbuf = buf,\r\n.tbuflen = sizeof(buf),\r\n.tweak_ctx = &ctx->tweak_ctx,\r\n.tweak_fn = XTS_TWEAK_CAST(twofish_enc_blk),\r\n.crypt_ctx = &ctx->crypt_ctx,\r\n.crypt_fn = decrypt_callback,\r\n};\r\nreturn xts_crypt(desc, dst, src, nbytes, &req);\r\n}\r\nstatic bool is_blacklisted_cpu(void)\r\n{\r\nif (boot_cpu_data.x86_vendor != X86_VENDOR_INTEL)\r\nreturn false;\r\nif (boot_cpu_data.x86 == 0x06 &&\r\n(boot_cpu_data.x86_model == 0x1c ||\r\nboot_cpu_data.x86_model == 0x26 ||\r\nboot_cpu_data.x86_model == 0x36)) {\r\nreturn true;\r\n}\r\nif (boot_cpu_data.x86 == 0x0f) {\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int __init init(void)\r\n{\r\nif (!force && is_blacklisted_cpu()) {\r\nprintk(KERN_INFO\r\n"twofish-x86_64-3way: performance on this CPU "\r\n"would be suboptimal: disabling "\r\n"twofish-x86_64-3way.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn crypto_register_algs(tf_algs, ARRAY_SIZE(tf_algs));\r\n}\r\nstatic void __exit fini(void)\r\n{\r\ncrypto_unregister_algs(tf_algs, ARRAY_SIZE(tf_algs));\r\n}

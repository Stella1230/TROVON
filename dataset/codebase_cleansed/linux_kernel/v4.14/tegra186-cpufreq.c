static int tegra186_cpufreq_init(struct cpufreq_policy *policy)\r\n{\r\nstruct tegra186_cpufreq_data *data = cpufreq_get_driver_data();\r\nunsigned int i;\r\nfor (i = 0; i < data->num_clusters; i++) {\r\nstruct tegra186_cpufreq_cluster *cluster = &data->clusters[i];\r\nconst struct tegra186_cpufreq_cluster_info *info =\r\ncluster->info;\r\nint core;\r\nfor (core = 0; core < ARRAY_SIZE(info->cpus); core++) {\r\nif (info->cpus[core] == policy->cpu)\r\nbreak;\r\n}\r\nif (core == ARRAY_SIZE(info->cpus))\r\ncontinue;\r\npolicy->driver_data =\r\ndata->regs + info->offset + EDVD_CORE_VOLT_FREQ(core);\r\ncpufreq_table_validate_and_show(policy, cluster->table);\r\n}\r\npolicy->cpuinfo.transition_latency = 300 * 1000;\r\nreturn 0;\r\n}\r\nstatic int tegra186_cpufreq_set_target(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nstruct cpufreq_frequency_table *tbl = policy->freq_table + index;\r\nvoid __iomem *edvd_reg = policy->driver_data;\r\nu32 edvd_val = tbl->driver_data;\r\nwritel(edvd_val, edvd_reg);\r\nreturn 0;\r\n}\r\nstatic struct cpufreq_frequency_table *init_vhint_table(\r\nstruct platform_device *pdev, struct tegra_bpmp *bpmp,\r\nunsigned int cluster_id)\r\n{\r\nstruct cpufreq_frequency_table *table;\r\nstruct mrq_cpu_vhint_request req;\r\nstruct tegra_bpmp_message msg;\r\nstruct cpu_vhint_data *data;\r\nint err, i, j, num_rates = 0;\r\ndma_addr_t phys;\r\nvoid *virt;\r\nvirt = dma_alloc_coherent(bpmp->dev, sizeof(*data), &phys,\r\nGFP_KERNEL | GFP_DMA32);\r\nif (!virt)\r\nreturn ERR_PTR(-ENOMEM);\r\ndata = (struct cpu_vhint_data *)virt;\r\nmemset(&req, 0, sizeof(req));\r\nreq.addr = phys;\r\nreq.cluster_id = cluster_id;\r\nmemset(&msg, 0, sizeof(msg));\r\nmsg.mrq = MRQ_CPU_VHINT;\r\nmsg.tx.data = &req;\r\nmsg.tx.size = sizeof(req);\r\nerr = tegra_bpmp_transfer(bpmp, &msg);\r\nif (err) {\r\ntable = ERR_PTR(err);\r\ngoto free;\r\n}\r\nfor (i = data->vfloor; i <= data->vceil; i++) {\r\nu16 ndiv = data->ndiv[i];\r\nif (ndiv < data->ndiv_min || ndiv > data->ndiv_max)\r\ncontinue;\r\nif (i > 0 && ndiv == data->ndiv[i - 1])\r\ncontinue;\r\nnum_rates++;\r\n}\r\ntable = devm_kcalloc(&pdev->dev, num_rates + 1, sizeof(*table),\r\nGFP_KERNEL);\r\nif (!table) {\r\ntable = ERR_PTR(-ENOMEM);\r\ngoto free;\r\n}\r\nfor (i = data->vfloor, j = 0; i <= data->vceil; i++) {\r\nstruct cpufreq_frequency_table *point;\r\nu16 ndiv = data->ndiv[i];\r\nu32 edvd_val = 0;\r\nif (ndiv < data->ndiv_min || ndiv > data->ndiv_max)\r\ncontinue;\r\nif (i > 0 && ndiv == data->ndiv[i - 1])\r\ncontinue;\r\nedvd_val |= i << EDVD_CORE_VOLT_FREQ_V_SHIFT;\r\nedvd_val |= ndiv << EDVD_CORE_VOLT_FREQ_F_SHIFT;\r\npoint = &table[j++];\r\npoint->driver_data = edvd_val;\r\npoint->frequency = data->ref_clk_hz * ndiv / data->pdiv /\r\ndata->mdiv / 1000;\r\n}\r\ntable[j].frequency = CPUFREQ_TABLE_END;\r\nfree:\r\ndma_free_coherent(bpmp->dev, sizeof(*data), virt, phys);\r\nreturn table;\r\n}\r\nstatic int tegra186_cpufreq_probe(struct platform_device *pdev)\r\n{\r\nstruct tegra186_cpufreq_data *data;\r\nstruct tegra_bpmp *bpmp;\r\nstruct resource *res;\r\nunsigned int i = 0, err;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->clusters = devm_kcalloc(&pdev->dev, ARRAY_SIZE(tegra186_clusters),\r\nsizeof(*data->clusters), GFP_KERNEL);\r\nif (!data->clusters)\r\nreturn -ENOMEM;\r\ndata->num_clusters = ARRAY_SIZE(tegra186_clusters);\r\nbpmp = tegra_bpmp_get(&pdev->dev);\r\nif (IS_ERR(bpmp))\r\nreturn PTR_ERR(bpmp);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->regs)) {\r\nerr = PTR_ERR(data->regs);\r\ngoto put_bpmp;\r\n}\r\nfor (i = 0; i < data->num_clusters; i++) {\r\nstruct tegra186_cpufreq_cluster *cluster = &data->clusters[i];\r\ncluster->info = &tegra186_clusters[i];\r\ncluster->table = init_vhint_table(\r\npdev, bpmp, cluster->info->bpmp_cluster_id);\r\nif (IS_ERR(cluster->table)) {\r\nerr = PTR_ERR(cluster->table);\r\ngoto put_bpmp;\r\n}\r\n}\r\ntegra_bpmp_put(bpmp);\r\ntegra186_cpufreq_driver.driver_data = data;\r\nerr = cpufreq_register_driver(&tegra186_cpufreq_driver);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\nput_bpmp:\r\ntegra_bpmp_put(bpmp);\r\nreturn err;\r\n}\r\nstatic int tegra186_cpufreq_remove(struct platform_device *pdev)\r\n{\r\ncpufreq_unregister_driver(&tegra186_cpufreq_driver);\r\nreturn 0;\r\n}

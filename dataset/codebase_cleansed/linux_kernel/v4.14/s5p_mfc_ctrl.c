int s5p_mfc_alloc_firmware(struct s5p_mfc_dev *dev)\r\n{\r\nstruct s5p_mfc_priv_buf *fw_buf = &dev->fw_buf;\r\nint err;\r\nfw_buf->size = dev->variant->buf_size->fw;\r\nif (fw_buf->virt) {\r\nmfc_err("Attempting to allocate firmware when it seems that it is already loaded\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = s5p_mfc_alloc_priv_buf(dev, BANK_L_CTX, &dev->fw_buf);\r\nif (err) {\r\nmfc_err("Allocating bitprocessor buffer failed\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint s5p_mfc_load_firmware(struct s5p_mfc_dev *dev)\r\n{\r\nstruct firmware *fw_blob;\r\nint i, err = -EINVAL;\r\nmfc_debug_enter();\r\nfor (i = MFC_FW_MAX_VERSIONS - 1; i >= 0; i--) {\r\nif (!dev->variant->fw_name[i])\r\ncontinue;\r\nerr = request_firmware((const struct firmware **)&fw_blob,\r\ndev->variant->fw_name[i], dev->v4l2_dev.dev);\r\nif (!err) {\r\ndev->fw_ver = (enum s5p_mfc_fw_ver) i;\r\nbreak;\r\n}\r\n}\r\nif (err != 0) {\r\nmfc_err("Firmware is not present in the /lib/firmware directory nor compiled in kernel\n");\r\nreturn -EINVAL;\r\n}\r\nif (fw_blob->size > dev->fw_buf.size) {\r\nmfc_err("MFC firmware is too big to be loaded\n");\r\nrelease_firmware(fw_blob);\r\nreturn -ENOMEM;\r\n}\r\nif (!dev->fw_buf.virt) {\r\nmfc_err("MFC firmware is not allocated\n");\r\nrelease_firmware(fw_blob);\r\nreturn -EINVAL;\r\n}\r\nmemcpy(dev->fw_buf.virt, fw_blob->data, fw_blob->size);\r\nwmb();\r\nrelease_firmware(fw_blob);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_release_firmware(struct s5p_mfc_dev *dev)\r\n{\r\ns5p_mfc_release_priv_buf(dev, &dev->fw_buf);\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_bus_reset(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned int status;\r\nunsigned long timeout;\r\nmfc_write(dev, 0x1, S5P_FIMV_MFC_BUS_RESET_CTRL);\r\ntimeout = jiffies + msecs_to_jiffies(MFC_BW_TIMEOUT);\r\ndo {\r\nif (time_after(jiffies, timeout)) {\r\nmfc_err("Timeout while resetting MFC.\n");\r\nreturn -EIO;\r\n}\r\nstatus = mfc_read(dev, S5P_FIMV_MFC_BUS_RESET_CTRL);\r\n} while ((status & 0x2) == 0);\r\nreturn 0;\r\n}\r\nint s5p_mfc_reset(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned int mc_status;\r\nunsigned long timeout;\r\nint i;\r\nmfc_debug_enter();\r\nif (IS_MFCV6_PLUS(dev)) {\r\nmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD_V6);\r\nmfc_write(dev, 0, S5P_FIMV_HOST2RISC_CMD_V6);\r\nmfc_write(dev, 0, S5P_FIMV_FW_VERSION_V6);\r\nfor (i = 0; i < S5P_FIMV_REG_CLEAR_COUNT_V6; i++)\r\nmfc_write(dev, 0, S5P_FIMV_REG_CLEAR_BEGIN_V6 + (i*4));\r\nif (dev->risc_on)\r\nif (s5p_mfc_bus_reset(dev))\r\nreturn -EIO;\r\nif ((!dev->risc_on) || (!IS_MFCV7_PLUS(dev)))\r\nmfc_write(dev, 0, S5P_FIMV_RISC_ON_V6);\r\nmfc_write(dev, 0x1FFF, S5P_FIMV_MFC_RESET_V6);\r\nmfc_write(dev, 0, S5P_FIMV_MFC_RESET_V6);\r\n} else {\r\nmfc_write(dev, 0x3f6, S5P_FIMV_SW_RESET);\r\nmfc_write(dev, 0x3e2, S5P_FIMV_SW_RESET);\r\nmdelay(10);\r\ntimeout = jiffies + msecs_to_jiffies(MFC_BW_TIMEOUT);\r\ndo {\r\nif (time_after(jiffies, timeout)) {\r\nmfc_err("Timeout while resetting MFC\n");\r\nreturn -EIO;\r\n}\r\nmc_status = mfc_read(dev, S5P_FIMV_MC_STATUS);\r\n} while (mc_status & 0x3);\r\nmfc_write(dev, 0x0, S5P_FIMV_SW_RESET);\r\nmfc_write(dev, 0x3fe, S5P_FIMV_SW_RESET);\r\n}\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic inline void s5p_mfc_init_memctrl(struct s5p_mfc_dev *dev)\r\n{\r\nif (IS_MFCV6_PLUS(dev)) {\r\nmfc_write(dev, dev->dma_base[BANK_L_CTX],\r\nS5P_FIMV_RISC_BASE_ADDRESS_V6);\r\nmfc_debug(2, "Base Address : %pad\n",\r\n&dev->dma_base[BANK_L_CTX]);\r\n} else {\r\nmfc_write(dev, dev->dma_base[BANK_L_CTX],\r\nS5P_FIMV_MC_DRAMBASE_ADR_A);\r\nmfc_write(dev, dev->dma_base[BANK_R_CTX],\r\nS5P_FIMV_MC_DRAMBASE_ADR_B);\r\nmfc_debug(2, "Bank1: %pad, Bank2: %pad\n",\r\n&dev->dma_base[BANK_L_CTX],\r\n&dev->dma_base[BANK_R_CTX]);\r\n}\r\n}\r\nstatic inline void s5p_mfc_clear_cmds(struct s5p_mfc_dev *dev)\r\n{\r\nif (IS_MFCV6_PLUS(dev)) {\r\n} else {\r\nmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH0_INST_ID);\r\nmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH1_INST_ID);\r\nmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD);\r\nmfc_write(dev, 0, S5P_FIMV_HOST2RISC_CMD);\r\n}\r\n}\r\nint s5p_mfc_init_hw(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned int ver;\r\nint ret;\r\nmfc_debug_enter();\r\nif (!dev->fw_buf.virt) {\r\nmfc_err("Firmware memory is not allocated.\n");\r\nreturn -EINVAL;\r\n}\r\nmfc_debug(2, "MFC reset..\n");\r\ns5p_mfc_clock_on();\r\ndev->risc_on = 0;\r\nret = s5p_mfc_reset(dev);\r\nif (ret) {\r\nmfc_err("Failed to reset MFC - timeout\n");\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Done MFC reset..\n");\r\ns5p_mfc_init_memctrl(dev);\r\ns5p_mfc_clear_cmds(dev);\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nif (IS_MFCV6_PLUS(dev)) {\r\ndev->risc_on = 1;\r\nmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\r\n}\r\nelse\r\nmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\r\nmfc_debug(2, "Will now wait for completion of firmware transfer\n");\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_FW_STATUS_RET)) {\r\nmfc_err("Failed to load firmware\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, sys_init_cmd, dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Ok, now will wait for completion of hardware init\n");\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_SYS_INIT_RET)) {\r\nmfc_err("Failed to init hardware\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_MFC_R2H_CMD_SYS_INIT_RET) {\r\nmfc_err("Failed to init firmware - error: %d int: %d\n",\r\ndev->int_err, dev->int_type);\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\nif (IS_MFCV6_PLUS(dev))\r\nver = mfc_read(dev, S5P_FIMV_FW_VERSION_V6);\r\nelse\r\nver = mfc_read(dev, S5P_FIMV_FW_VERSION);\r\nmfc_debug(2, "MFC F/W version : %02xyy, %02xmm, %02xdd\n",\r\n(ver >> 16) & 0xFF, (ver >> 8) & 0xFF, ver & 0xFF);\r\ns5p_mfc_clock_off();\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_deinit_hw(struct s5p_mfc_dev *dev)\r\n{\r\ns5p_mfc_clock_on();\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_hw_call(dev->mfc_ops, release_dev_context_buffer, dev);\r\ns5p_mfc_clock_off();\r\n}\r\nint s5p_mfc_sleep(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\nmfc_debug_enter();\r\ns5p_mfc_clock_on();\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, sleep_cmd, dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\nreturn ret;\r\n}\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_SLEEP_RET)) {\r\nmfc_err("Failed to sleep\n");\r\nreturn -EIO;\r\n}\r\ns5p_mfc_clock_off();\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_MFC_R2H_CMD_SLEEP_RET) {\r\nmfc_err("Failed to sleep - error: %d int: %d\n", dev->int_err,\r\ndev->int_type);\r\nreturn -EIO;\r\n}\r\nmfc_debug_leave();\r\nreturn ret;\r\n}\r\nstatic int s5p_mfc_v8_wait_wakeup(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\ndev->risc_on = 1;\r\nmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_FW_STATUS_RET)) {\r\nmfc_err("Failed to reset MFCV8\n");\r\nreturn -EIO;\r\n}\r\nmfc_debug(2, "Write command to wakeup MFCV8\n");\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, wakeup_cmd, dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFCV8 - timeout\n");\r\nreturn ret;\r\n}\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_WAKEUP_RET)) {\r\nmfc_err("Failed to wakeup MFC\n");\r\nreturn -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int s5p_mfc_wait_wakeup(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, wakeup_cmd, dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\nreturn ret;\r\n}\r\nif (IS_MFCV6_PLUS(dev)) {\r\ndev->risc_on = 1;\r\nmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\r\n} else {\r\nmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\r\n}\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_WAKEUP_RET)) {\r\nmfc_err("Failed to wakeup MFC\n");\r\nreturn -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint s5p_mfc_wakeup(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\nmfc_debug_enter();\r\nmfc_debug(2, "MFC reset..\n");\r\ns5p_mfc_clock_on();\r\ndev->risc_on = 0;\r\nret = s5p_mfc_reset(dev);\r\nif (ret) {\r\nmfc_err("Failed to reset MFC - timeout\n");\r\ns5p_mfc_clock_off();\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Done MFC reset..\n");\r\ns5p_mfc_init_memctrl(dev);\r\ns5p_mfc_clear_cmds(dev);\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nif (IS_MFCV8(dev))\r\nret = s5p_mfc_v8_wait_wakeup(dev);\r\nelse\r\nret = s5p_mfc_wait_wakeup(dev);\r\ns5p_mfc_clock_off();\r\nif (ret)\r\nreturn ret;\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_MFC_R2H_CMD_WAKEUP_RET) {\r\nmfc_err("Failed to wakeup - error: %d int: %d\n", dev->int_err,\r\ndev->int_type);\r\nreturn -EIO;\r\n}\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_open_mfc_inst(struct s5p_mfc_dev *dev, struct s5p_mfc_ctx *ctx)\r\n{\r\nint ret = 0;\r\nret = s5p_mfc_hw_call(dev->mfc_ops, alloc_instance_buffer, ctx);\r\nif (ret) {\r\nmfc_err("Failed allocating instance buffer\n");\r\ngoto err;\r\n}\r\nif (ctx->type == MFCINST_DECODER) {\r\nret = s5p_mfc_hw_call(dev->mfc_ops,\r\nalloc_dec_temp_buffers, ctx);\r\nif (ret) {\r\nmfc_err("Failed allocating temporary buffers\n");\r\ngoto err_free_inst_buf;\r\n}\r\n}\r\nset_work_bit_irqsave(ctx);\r\ns5p_mfc_hw_call(dev->mfc_ops, try_run, dev);\r\nif (s5p_mfc_wait_for_done_ctx(ctx,\r\nS5P_MFC_R2H_CMD_OPEN_INSTANCE_RET, 0)) {\r\nmfc_err("Error getting instance from hardware\n");\r\nret = -EIO;\r\ngoto err_free_desc_buf;\r\n}\r\nmfc_debug(2, "Got instance number: %d\n", ctx->inst_no);\r\nreturn ret;\r\nerr_free_desc_buf:\r\nif (ctx->type == MFCINST_DECODER)\r\ns5p_mfc_hw_call(dev->mfc_ops, release_dec_desc_buffer, ctx);\r\nerr_free_inst_buf:\r\ns5p_mfc_hw_call(dev->mfc_ops, release_instance_buffer, ctx);\r\nerr:\r\nreturn ret;\r\n}\r\nvoid s5p_mfc_close_mfc_inst(struct s5p_mfc_dev *dev, struct s5p_mfc_ctx *ctx)\r\n{\r\nctx->state = MFCINST_RETURN_INST;\r\nset_work_bit_irqsave(ctx);\r\ns5p_mfc_hw_call(dev->mfc_ops, try_run, dev);\r\nif (s5p_mfc_wait_for_done_ctx(ctx,\r\nS5P_MFC_R2H_CMD_CLOSE_INSTANCE_RET, 0))\r\nmfc_err("Err returning instance\n");\r\ns5p_mfc_hw_call(dev->mfc_ops, release_codec_buffers, ctx);\r\ns5p_mfc_hw_call(dev->mfc_ops, release_instance_buffer, ctx);\r\nif (ctx->type == MFCINST_DECODER)\r\ns5p_mfc_hw_call(dev->mfc_ops, release_dec_desc_buffer, ctx);\r\nctx->inst_no = MFC_NO_INSTANCE_SET;\r\nctx->state = MFCINST_FREE;\r\n}

static void arizona_micsupp_check_cp(struct work_struct *work)\r\n{\r\nstruct arizona_micsupp *micsupp =\r\ncontainer_of(work, struct arizona_micsupp, check_cp_work);\r\nstruct snd_soc_dapm_context *dapm = *micsupp->dapm;\r\nstruct snd_soc_component *component;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(micsupp->regmap, micsupp->enable_reg, &val);\r\nif (ret != 0) {\r\ndev_err(micsupp->dev,\r\n"Failed to read CP state: %d\n", ret);\r\nreturn;\r\n}\r\nif (dapm) {\r\ncomponent = snd_soc_dapm_to_component(dapm);\r\nif ((val & (ARIZONA_CPMIC_ENA | ARIZONA_CPMIC_BYPASS)) ==\r\nARIZONA_CPMIC_ENA)\r\nsnd_soc_component_force_enable_pin(component,\r\n"MICSUPP");\r\nelse\r\nsnd_soc_component_disable_pin(component, "MICSUPP");\r\nsnd_soc_dapm_sync(dapm);\r\n}\r\n}\r\nstatic int arizona_micsupp_enable(struct regulator_dev *rdev)\r\n{\r\nstruct arizona_micsupp *micsupp = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = regulator_enable_regmap(rdev);\r\nif (ret == 0)\r\nschedule_work(&micsupp->check_cp_work);\r\nreturn ret;\r\n}\r\nstatic int arizona_micsupp_disable(struct regulator_dev *rdev)\r\n{\r\nstruct arizona_micsupp *micsupp = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = regulator_disable_regmap(rdev);\r\nif (ret == 0)\r\nschedule_work(&micsupp->check_cp_work);\r\nreturn ret;\r\n}\r\nstatic int arizona_micsupp_set_bypass(struct regulator_dev *rdev, bool ena)\r\n{\r\nstruct arizona_micsupp *micsupp = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = regulator_set_bypass_regmap(rdev, ena);\r\nif (ret == 0)\r\nschedule_work(&micsupp->check_cp_work);\r\nreturn ret;\r\n}\r\nstatic int arizona_micsupp_of_get_pdata(struct arizona_micsupp_pdata *pdata,\r\nstruct regulator_config *config,\r\nconst struct regulator_desc *desc)\r\n{\r\nstruct arizona_micsupp *micsupp = config->driver_data;\r\nstruct device_node *np;\r\nstruct regulator_init_data *init_data;\r\nnp = of_get_child_by_name(config->dev->of_node, "micvdd");\r\nif (np) {\r\nconfig->of_node = np;\r\ninit_data = of_get_regulator_init_data(config->dev, np, desc);\r\nif (init_data) {\r\ninit_data->consumer_supplies = &micsupp->supply;\r\ninit_data->num_consumer_supplies = 1;\r\npdata->init_data = init_data;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int arizona_micsupp_common_init(struct platform_device *pdev,\r\nstruct arizona_micsupp *micsupp,\r\nconst struct regulator_desc *desc,\r\nstruct arizona_micsupp_pdata *pdata)\r\n{\r\nstruct regulator_config config = { };\r\nint ret;\r\nINIT_WORK(&micsupp->check_cp_work, arizona_micsupp_check_cp);\r\nmicsupp->init_data.consumer_supplies = &micsupp->supply;\r\nmicsupp->supply.supply = "MICVDD";\r\nmicsupp->supply.dev_name = dev_name(micsupp->dev);\r\nmicsupp->enable_reg = desc->enable_reg;\r\nconfig.dev = micsupp->dev;\r\nconfig.driver_data = micsupp;\r\nconfig.regmap = micsupp->regmap;\r\nif (IS_ENABLED(CONFIG_OF)) {\r\nif (!dev_get_platdata(micsupp->dev)) {\r\nret = arizona_micsupp_of_get_pdata(pdata, &config,\r\ndesc);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nif (pdata->init_data)\r\nconfig.init_data = pdata->init_data;\r\nelse\r\nconfig.init_data = &micsupp->init_data;\r\nregmap_update_bits(micsupp->regmap, micsupp->enable_reg,\r\nARIZONA_CPMIC_BYPASS, 0);\r\nmicsupp->regulator = devm_regulator_register(&pdev->dev,\r\ndesc,\r\n&config);\r\nof_node_put(config.of_node);\r\nif (IS_ERR(micsupp->regulator)) {\r\nret = PTR_ERR(micsupp->regulator);\r\ndev_err(micsupp->dev, "Failed to register mic supply: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, micsupp);\r\nreturn 0;\r\n}\r\nstatic int arizona_micsupp_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nconst struct regulator_desc *desc;\r\nstruct arizona_micsupp *micsupp;\r\nmicsupp = devm_kzalloc(&pdev->dev, sizeof(*micsupp), GFP_KERNEL);\r\nif (!micsupp)\r\nreturn -ENOMEM;\r\nmicsupp->regmap = arizona->regmap;\r\nmicsupp->dapm = &arizona->dapm;\r\nmicsupp->dev = arizona->dev;\r\nswitch (arizona->type) {\r\ncase WM5110:\r\ncase WM8280:\r\ndesc = &arizona_micsupp_ext;\r\nmicsupp->init_data = arizona_micsupp_ext_default;\r\nbreak;\r\ndefault:\r\ndesc = &arizona_micsupp;\r\nmicsupp->init_data = arizona_micsupp_default;\r\nbreak;\r\n}\r\nreturn arizona_micsupp_common_init(pdev, micsupp, desc,\r\n&arizona->pdata.micvdd);\r\n}

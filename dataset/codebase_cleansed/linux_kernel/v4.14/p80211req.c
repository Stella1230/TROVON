static void p80211req_handle_action(struct wlandevice *wlandev, u32 *data,\r\nint isget, u32 flag)\r\n{\r\nif (isget) {\r\nif (wlandev->hostwep & flag)\r\n*data = P80211ENUM_truth_true;\r\nelse\r\n*data = P80211ENUM_truth_false;\r\n} else {\r\nwlandev->hostwep &= ~flag;\r\nif (*data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= flag;\r\n}\r\n}\r\nint p80211req_dorequest(struct wlandevice *wlandev, u8 *msgbuf)\r\n{\r\nstruct p80211msg *msg = (struct p80211msg *)msgbuf;\r\nif (!((wlandev->msdstate == WLAN_MSD_HWPRESENT &&\r\nmsg->msgcode == DIDmsg_lnxreq_ifstate) ||\r\nwlandev->msdstate == WLAN_MSD_RUNNING ||\r\nwlandev->msdstate == WLAN_MSD_FWLOAD)) {\r\nreturn -ENODEV;\r\n}\r\nif (!capable(CAP_NET_ADMIN) &&\r\n(msg->msgcode != DIDmsg_dot11req_mibget)) {\r\nnetdev_err(wlandev->netdev,\r\n"%s: only dot11req_mibget allowed for non-root.\n",\r\nwlandev->name);\r\nreturn -EPERM;\r\n}\r\nif (test_and_set_bit(1, &wlandev->request_pending))\r\nreturn -EBUSY;\r\np80211req_handlemsg(wlandev, msg);\r\nif (wlandev->mlmerequest)\r\nwlandev->mlmerequest(wlandev, msg);\r\nclear_bit(1, &wlandev->request_pending);\r\nreturn 0;\r\n}\r\nstatic void p80211req_handlemsg(struct wlandevice *wlandev,\r\nstruct p80211msg *msg)\r\n{\r\nswitch (msg->msgcode) {\r\ncase DIDmsg_lnxreq_hostwep:{\r\nstruct p80211msg_lnxreq_hostwep *req =\r\n(struct p80211msg_lnxreq_hostwep *)msg;\r\nwlandev->hostwep &=\r\n~(HOSTWEP_DECRYPT | HOSTWEP_ENCRYPT);\r\nif (req->decrypt.data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_DECRYPT;\r\nif (req->encrypt.data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_ENCRYPT;\r\nbreak;\r\n}\r\ncase DIDmsg_dot11req_mibget:\r\ncase DIDmsg_dot11req_mibset:{\r\nint isget = (msg->msgcode == DIDmsg_dot11req_mibget);\r\nstruct p80211msg_dot11req_mibget *mib_msg =\r\n(struct p80211msg_dot11req_mibget *)msg;\r\np80211req_mibset_mibget(wlandev, mib_msg, isget);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void p80211req_mibset_mibget(struct wlandevice *wlandev,\r\nstruct p80211msg_dot11req_mibget *mib_msg,\r\nint isget)\r\n{\r\nstruct p80211itemd *mibitem =\r\n(struct p80211itemd *)mib_msg->mibattribute.data;\r\nstruct p80211pstrd *pstr = (struct p80211pstrd *)mibitem->data;\r\nu8 *key = mibitem->data + sizeof(struct p80211pstrd);\r\nswitch (mibitem->did) {\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_key(1):\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_key(2):\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_key(3):\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_key(4):\r\nif (!isget)\r\nwep_change_key(wlandev,\r\nP80211DID_ITEM(mibitem->did) - 1,\r\nkey, pstr->len);\r\nbreak;\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11WEPDefaultKeyID:{\r\nu32 *data = (u32 *)mibitem->data;\r\nif (isget) {\r\n*data = wlandev->hostwep & HOSTWEP_DEFAULTKEY_MASK;\r\n} else {\r\nwlandev->hostwep &= ~(HOSTWEP_DEFAULTKEY_MASK);\r\nwlandev->hostwep |= (*data & HOSTWEP_DEFAULTKEY_MASK);\r\n}\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11PrivacyInvoked:{\r\nu32 *data = (u32 *)mibitem->data;\r\np80211req_handle_action(wlandev, data, isget,\r\nHOSTWEP_PRIVACYINVOKED);\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11ExcludeUnencrypted:{\r\nu32 *data = (u32 *)mibitem->data;\r\np80211req_handle_action(wlandev, data, isget,\r\nHOSTWEP_EXCLUDEUNENCRYPTED);\r\nbreak;\r\n}\r\n}\r\n}

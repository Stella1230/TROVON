static void sw_i2c_wait(void)\r\n{\r\nint i, tmp;\r\nfor (i = 0; i < 600; i++) {\r\ntmp = i;\r\ntmp += i;\r\n}\r\n}\r\nstatic void sw_i2c_scl(unsigned char value)\r\n{\r\nunsigned long gpio_data;\r\nunsigned long gpio_dir;\r\ngpio_dir = peek32(sw_i2c_clk_gpio_data_dir_reg);\r\nif (value) {\r\ngpio_dir &= ~(1 << sw_i2c_clk_gpio);\r\npoke32(sw_i2c_clk_gpio_data_dir_reg, gpio_dir);\r\n} else {\r\ngpio_data = peek32(sw_i2c_clk_gpio_data_reg);\r\ngpio_data &= ~(1 << sw_i2c_clk_gpio);\r\npoke32(sw_i2c_clk_gpio_data_reg, gpio_data);\r\ngpio_dir |= (1 << sw_i2c_clk_gpio);\r\npoke32(sw_i2c_clk_gpio_data_dir_reg, gpio_dir);\r\n}\r\n}\r\nstatic void sw_i2c_sda(unsigned char value)\r\n{\r\nunsigned long gpio_data;\r\nunsigned long gpio_dir;\r\ngpio_dir = peek32(sw_i2c_data_gpio_data_dir_reg);\r\nif (value) {\r\ngpio_dir &= ~(1 << sw_i2c_data_gpio);\r\npoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\r\n} else {\r\ngpio_data = peek32(sw_i2c_data_gpio_data_reg);\r\ngpio_data &= ~(1 << sw_i2c_data_gpio);\r\npoke32(sw_i2c_data_gpio_data_reg, gpio_data);\r\ngpio_dir |= (1 << sw_i2c_data_gpio);\r\npoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\r\n}\r\n}\r\nstatic unsigned char sw_i2c_read_sda(void)\r\n{\r\nunsigned long gpio_dir;\r\nunsigned long gpio_data;\r\nunsigned long dir_mask = 1 << sw_i2c_data_gpio;\r\ngpio_dir = peek32(sw_i2c_data_gpio_data_dir_reg);\r\nif ((gpio_dir & dir_mask) != ~dir_mask) {\r\ngpio_dir &= ~(1 << sw_i2c_data_gpio);\r\npoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\r\n}\r\ngpio_data = peek32(sw_i2c_data_gpio_data_reg);\r\nif (gpio_data & (1 << sw_i2c_data_gpio))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void sw_i2c_ack(void)\r\n{\r\nreturn;\r\n}\r\nstatic void sw_i2c_start(void)\r\n{\r\nsw_i2c_sda(1);\r\nsw_i2c_scl(1);\r\nsw_i2c_sda(0);\r\n}\r\nstatic void sw_i2c_stop(void)\r\n{\r\nsw_i2c_scl(1);\r\nsw_i2c_sda(0);\r\nsw_i2c_sda(1);\r\n}\r\nstatic long sw_i2c_write_byte(unsigned char data)\r\n{\r\nunsigned char value = data;\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nsw_i2c_scl(0);\r\nif ((value & 0x80) != 0)\r\nsw_i2c_sda(1);\r\nelse\r\nsw_i2c_sda(0);\r\nsw_i2c_wait();\r\nsw_i2c_scl(1);\r\nsw_i2c_wait();\r\nvalue = value << 1;\r\n}\r\nsw_i2c_scl(0);\r\nsw_i2c_sda(1);\r\nsw_i2c_wait();\r\nsw_i2c_scl(1);\r\nsw_i2c_wait();\r\nfor (i = 0; i < 0xff; i++) {\r\nif (!sw_i2c_read_sda())\r\nbreak;\r\nsw_i2c_scl(0);\r\nsw_i2c_wait();\r\nsw_i2c_scl(1);\r\nsw_i2c_wait();\r\n}\r\nsw_i2c_scl(0);\r\nsw_i2c_sda(1);\r\nif (i < 0xff)\r\nreturn 0;\r\nelse\r\nreturn -1;\r\n}\r\nstatic unsigned char sw_i2c_read_byte(unsigned char ack)\r\n{\r\nint i;\r\nunsigned char data = 0;\r\nfor (i = 7; i >= 0; i--) {\r\nsw_i2c_scl(0);\r\nsw_i2c_sda(1);\r\nsw_i2c_wait();\r\nsw_i2c_scl(1);\r\nsw_i2c_wait();\r\ndata |= (sw_i2c_read_sda() << i);\r\n}\r\nif (ack)\r\nsw_i2c_ack();\r\nsw_i2c_scl(0);\r\nsw_i2c_sda(1);\r\nreturn data;\r\n}\r\nstatic long sm750le_i2c_init(unsigned char clk_gpio, unsigned char data_gpio)\r\n{\r\nint i;\r\nsw_i2c_clk_gpio_data_reg = GPIO_DATA_SM750LE;\r\nsw_i2c_clk_gpio_data_dir_reg = GPIO_DATA_DIRECTION_SM750LE;\r\nsw_i2c_clk_gpio = clk_gpio;\r\nsw_i2c_data_gpio_data_reg = GPIO_DATA_SM750LE;\r\nsw_i2c_data_gpio_data_dir_reg = GPIO_DATA_DIRECTION_SM750LE;\r\nsw_i2c_data_gpio = data_gpio;\r\nfor (i = 0; i < 9; i++)\r\nsw_i2c_stop();\r\nreturn 0;\r\n}\r\nlong sm750_sw_i2c_init(unsigned char clk_gpio, unsigned char data_gpio)\r\n{\r\nint i;\r\nif ((clk_gpio > 31) || (data_gpio > 31))\r\nreturn -1;\r\nif (sm750_get_chip_type() == SM750LE)\r\nreturn sm750le_i2c_init(clk_gpio, data_gpio);\r\nsw_i2c_clk_gpio_mux_reg = GPIO_MUX;\r\nsw_i2c_clk_gpio_data_reg = GPIO_DATA;\r\nsw_i2c_clk_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\r\nsw_i2c_clk_gpio = clk_gpio;\r\nsw_i2c_data_gpio_mux_reg = GPIO_MUX;\r\nsw_i2c_data_gpio_data_reg = GPIO_DATA;\r\nsw_i2c_data_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\r\nsw_i2c_data_gpio = data_gpio;\r\npoke32(sw_i2c_clk_gpio_mux_reg,\r\npeek32(sw_i2c_clk_gpio_mux_reg) & ~(1 << sw_i2c_clk_gpio));\r\npoke32(sw_i2c_data_gpio_mux_reg,\r\npeek32(sw_i2c_data_gpio_mux_reg) & ~(1 << sw_i2c_data_gpio));\r\nsm750_enable_gpio(1);\r\nfor (i = 0; i < 9; i++)\r\nsw_i2c_stop();\r\nreturn 0;\r\n}\r\nunsigned char sm750_sw_i2c_read_reg(unsigned char addr, unsigned char reg)\r\n{\r\nunsigned char data;\r\nsw_i2c_start();\r\nsw_i2c_write_byte(addr);\r\nsw_i2c_write_byte(reg);\r\nsw_i2c_start();\r\nsw_i2c_write_byte(addr + 1);\r\ndata = sw_i2c_read_byte(1);\r\nsw_i2c_stop();\r\nreturn data;\r\n}\r\nlong sm750_sw_i2c_write_reg(unsigned char addr,\r\nunsigned char reg,\r\nunsigned char data)\r\n{\r\nlong ret = 0;\r\nsw_i2c_start();\r\nif ((sw_i2c_write_byte(addr) != 0) ||\r\n(sw_i2c_write_byte(reg) != 0) ||\r\n(sw_i2c_write_byte(data) != 0)) {\r\nret = -1;\r\n}\r\nsw_i2c_stop();\r\nreturn ret;\r\n}

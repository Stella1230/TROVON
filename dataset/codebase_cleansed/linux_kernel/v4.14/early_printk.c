static inline void prom_putchar_wait(void __iomem *reg, u32 mask, u32 val)\r\n{\r\nu32 t;\r\ndo {\r\nt = __raw_readl(reg);\r\nif ((t & mask) == val)\r\nbreak;\r\n} while (1);\r\n}\r\nstatic void prom_putchar_ar71xx(unsigned char ch)\r\n{\r\nvoid __iomem *base = (void __iomem *)(KSEG1ADDR(AR71XX_UART_BASE));\r\nprom_putchar_wait(base + UART_LSR * 4, BOTH_EMPTY, BOTH_EMPTY);\r\n__raw_writel(ch, base + UART_TX * 4);\r\nprom_putchar_wait(base + UART_LSR * 4, BOTH_EMPTY, BOTH_EMPTY);\r\n}\r\nstatic void prom_putchar_ar933x(unsigned char ch)\r\n{\r\nvoid __iomem *base = (void __iomem *)(KSEG1ADDR(AR933X_UART_BASE));\r\nprom_putchar_wait(base + AR933X_UART_DATA_REG, AR933X_UART_DATA_TX_CSR,\r\nAR933X_UART_DATA_TX_CSR);\r\n__raw_writel(AR933X_UART_DATA_TX_CSR | ch, base + AR933X_UART_DATA_REG);\r\nprom_putchar_wait(base + AR933X_UART_DATA_REG, AR933X_UART_DATA_TX_CSR,\r\nAR933X_UART_DATA_TX_CSR);\r\n}\r\nstatic void prom_putchar_dummy(unsigned char ch)\r\n{\r\n}\r\nstatic void prom_putchar_init(void)\r\n{\r\nvoid __iomem *base;\r\nu32 id;\r\nbase = (void __iomem *)(KSEG1ADDR(AR71XX_RESET_BASE));\r\nid = __raw_readl(base + AR71XX_RESET_REG_REV_ID);\r\nid &= REV_ID_MAJOR_MASK;\r\nswitch (id) {\r\ncase REV_ID_MAJOR_AR71XX:\r\ncase REV_ID_MAJOR_AR7240:\r\ncase REV_ID_MAJOR_AR7241:\r\ncase REV_ID_MAJOR_AR7242:\r\ncase REV_ID_MAJOR_AR913X:\r\ncase REV_ID_MAJOR_AR9341:\r\ncase REV_ID_MAJOR_AR9342:\r\ncase REV_ID_MAJOR_AR9344:\r\ncase REV_ID_MAJOR_QCA9556:\r\ncase REV_ID_MAJOR_QCA9558:\r\n_prom_putchar = prom_putchar_ar71xx;\r\nbreak;\r\ncase REV_ID_MAJOR_AR9330:\r\ncase REV_ID_MAJOR_AR9331:\r\n_prom_putchar = prom_putchar_ar933x;\r\nbreak;\r\ndefault:\r\n_prom_putchar = prom_putchar_dummy;\r\nbreak;\r\n}\r\n}\r\nvoid prom_putchar(unsigned char ch)\r\n{\r\nif (!_prom_putchar)\r\nprom_putchar_init();\r\n_prom_putchar(ch);\r\n}

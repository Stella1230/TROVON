static int uniphier_watchdog_ping(struct watchdog_device *w)\r\n{\r\nstruct uniphier_wdt_dev *wdev = watchdog_get_drvdata(w);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_write_bits(wdev->regmap, WDTCTRL,\r\nWDTCTRL_CLEAR, WDTCTRL_CLEAR);\r\nif (!ret)\r\nret = regmap_read_poll_timeout(wdev->regmap, WDTCTRL, val,\r\n(val & WDTCTRL_STATUS),\r\n0, WDTST_TIMEOUT);\r\nreturn ret;\r\n}\r\nstatic int __uniphier_watchdog_start(struct regmap *regmap, unsigned int sec)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read_poll_timeout(regmap, WDTCTRL, val,\r\n!(val & WDTCTRL_STATUS),\r\n0, WDTST_TIMEOUT);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(regmap, WDTTIMSET,\r\nSEC_TO_WDTTIMSET_PRD(sec));\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(regmap, WDTCTRL, WDTCTRL_ENABLE | WDTCTRL_CLEAR);\r\nif (!ret)\r\nret = regmap_read_poll_timeout(regmap, WDTCTRL, val,\r\n(val & WDTCTRL_STATUS),\r\n0, WDTST_TIMEOUT);\r\nreturn ret;\r\n}\r\nstatic int __uniphier_watchdog_stop(struct regmap *regmap)\r\n{\r\nreturn regmap_write_bits(regmap, WDTCTRL, WDTCTRL_ENABLE, 0);\r\n}\r\nstatic int __uniphier_watchdog_restart(struct regmap *regmap, unsigned int sec)\r\n{\r\nint ret;\r\nret = __uniphier_watchdog_stop(regmap);\r\nif (ret)\r\nreturn ret;\r\nreturn __uniphier_watchdog_start(regmap, sec);\r\n}\r\nstatic int uniphier_watchdog_start(struct watchdog_device *w)\r\n{\r\nstruct uniphier_wdt_dev *wdev = watchdog_get_drvdata(w);\r\nunsigned int tmp_timeout;\r\ntmp_timeout = roundup_pow_of_two(w->timeout);\r\nreturn __uniphier_watchdog_start(wdev->regmap, tmp_timeout);\r\n}\r\nstatic int uniphier_watchdog_stop(struct watchdog_device *w)\r\n{\r\nstruct uniphier_wdt_dev *wdev = watchdog_get_drvdata(w);\r\nreturn __uniphier_watchdog_stop(wdev->regmap);\r\n}\r\nstatic int uniphier_watchdog_set_timeout(struct watchdog_device *w,\r\nunsigned int t)\r\n{\r\nstruct uniphier_wdt_dev *wdev = watchdog_get_drvdata(w);\r\nunsigned int tmp_timeout;\r\nint ret;\r\ntmp_timeout = roundup_pow_of_two(t);\r\nif (tmp_timeout == w->timeout)\r\nreturn 0;\r\nif (watchdog_active(w)) {\r\nret = __uniphier_watchdog_restart(wdev->regmap, tmp_timeout);\r\nif (ret)\r\nreturn ret;\r\n}\r\nw->timeout = tmp_timeout;\r\nreturn 0;\r\n}\r\nstatic int uniphier_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct uniphier_wdt_dev *wdev;\r\nstruct regmap *regmap;\r\nstruct device_node *parent;\r\nint ret;\r\nwdev = devm_kzalloc(dev, sizeof(*wdev), GFP_KERNEL);\r\nif (!wdev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wdev);\r\nparent = of_get_parent(dev->of_node);\r\nregmap = syscon_node_to_regmap(parent);\r\nof_node_put(parent);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nwdev->regmap = regmap;\r\nwdev->wdt_dev.info = &uniphier_wdt_info;\r\nwdev->wdt_dev.ops = &uniphier_wdt_ops;\r\nwdev->wdt_dev.max_timeout = WDT_PERIOD_MAX;\r\nwdev->wdt_dev.min_timeout = WDT_PERIOD_MIN;\r\nwdev->wdt_dev.parent = dev;\r\nif (watchdog_init_timeout(&wdev->wdt_dev, timeout, dev) < 0) {\r\nwdev->wdt_dev.timeout = WDT_DEFAULT_TIMEOUT;\r\n}\r\nwatchdog_set_nowayout(&wdev->wdt_dev, nowayout);\r\nwatchdog_stop_on_reboot(&wdev->wdt_dev);\r\nwatchdog_set_drvdata(&wdev->wdt_dev, wdev);\r\nuniphier_watchdog_stop(&wdev->wdt_dev);\r\nret = regmap_write(wdev->regmap, WDTRSTSEL, WDTRSTSEL_RSTSEL_BOTH);\r\nif (ret)\r\nreturn ret;\r\nret = devm_watchdog_register_device(dev, &wdev->wdt_dev);\r\nif (ret)\r\nreturn ret;\r\ndev_info(dev, "watchdog driver (timeout=%d sec, nowayout=%d)\n",\r\nwdev->wdt_dev.timeout, nowayout);\r\nreturn 0;\r\n}

static int venc_op_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct venus_inst *inst = ctrl_to_inst(ctrl);\r\nstruct venc_controls *ctr = &inst->controls.enc;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\r\nctr->bitrate_mode = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE:\r\nctr->bitrate = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\r\nctr->bitrate_peak = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE:\r\nctr->h264_entropy_mode = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE:\r\nctr->profile.mpeg4 = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_PROFILE:\r\nctr->profile.h264 = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_VPX_PROFILE:\r\nctr->profile.vpx = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL:\r\nctr->level.mpeg4 = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_LEVEL:\r\nctr->level.h264 = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_I_FRAME_QP:\r\nctr->h264_i_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_P_FRAME_QP:\r\nctr->h264_p_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_B_FRAME_QP:\r\nctr->h264_b_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_MIN_QP:\r\nctr->h264_min_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_MAX_QP:\r\nctr->h264_max_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE:\r\nctr->multi_slice_mode = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_BYTES:\r\nctr->multi_slice_max_bytes = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_MB:\r\nctr->multi_slice_max_mb = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_ALPHA:\r\nctr->h264_loop_filter_alpha = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_BETA:\r\nctr->h264_loop_filter_beta = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE:\r\nctr->h264_loop_filter_mode = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_HEADER_MODE:\r\nctr->header_mode = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_CYCLIC_INTRA_REFRESH_MB:\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_GOP_SIZE:\r\nctr->gop_size = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_H264_I_PERIOD:\r\nctr->h264_i_period = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_VPX_MIN_QP:\r\nctr->vp8_min_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_VPX_MAX_QP:\r\nctr->vp8_max_qp = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES:\r\nctr->num_b_frames = ctrl->val;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint venc_ctrl_init(struct venus_inst *inst)\r\n{\r\nint ret;\r\nret = v4l2_ctrl_handler_init(&inst->ctrl_handler, 27);\r\nif (ret)\r\nreturn ret;\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_BITRATE_MODE,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR,\r\n~((1 << V4L2_MPEG_VIDEO_BITRATE_MODE_VBR) |\r\n(1 << V4L2_MPEG_VIDEO_BITRATE_MODE_CBR)),\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_VBR);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE,\r\nV4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CABAC,\r\n0, V4L2_MPEG_VIDEO_H264_ENTROPY_MODE_CAVLC);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_MPEG4_PROFILE,\r\nV4L2_MPEG_VIDEO_MPEG4_PROFILE_ADVANCED_CODING_EFFICIENCY,\r\n~((1 << V4L2_MPEG_VIDEO_MPEG4_PROFILE_SIMPLE) |\r\n(1 << V4L2_MPEG_VIDEO_MPEG4_PROFILE_ADVANCED_SIMPLE)),\r\nV4L2_MPEG_VIDEO_MPEG4_PROFILE_SIMPLE);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_MPEG4_LEVEL,\r\nV4L2_MPEG_VIDEO_MPEG4_LEVEL_5,\r\n0, V4L2_MPEG_VIDEO_MPEG4_LEVEL_0);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_PROFILE,\r\nV4L2_MPEG_VIDEO_H264_PROFILE_MULTIVIEW_HIGH,\r\n~((1 << V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE) |\r\n(1 << V4L2_MPEG_VIDEO_H264_PROFILE_CONSTRAINED_BASELINE) |\r\n(1 << V4L2_MPEG_VIDEO_H264_PROFILE_MAIN) |\r\n(1 << V4L2_MPEG_VIDEO_H264_PROFILE_HIGH) |\r\n(1 << V4L2_MPEG_VIDEO_H264_PROFILE_STEREO_HIGH) |\r\n(1 << V4L2_MPEG_VIDEO_H264_PROFILE_MULTIVIEW_HIGH)),\r\nV4L2_MPEG_VIDEO_H264_PROFILE_HIGH);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_LEVEL,\r\nV4L2_MPEG_VIDEO_H264_LEVEL_5_1,\r\n0, V4L2_MPEG_VIDEO_H264_LEVEL_1_0);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE,\r\nAT_SLICE_BOUNDARY,\r\n0, V4L2_MPEG_VIDEO_H264_LOOP_FILTER_MODE_DISABLED);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_HEADER_MODE,\r\nV4L2_MPEG_VIDEO_HEADER_MODE_JOINED_WITH_1ST_FRAME,\r\n1 << V4L2_MPEG_VIDEO_HEADER_MODE_JOINED_WITH_1ST_FRAME,\r\nV4L2_MPEG_VIDEO_HEADER_MODE_SEPARATE);\r\nv4l2_ctrl_new_std_menu(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE,\r\nV4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_BYTES,\r\n0, V4L2_MPEG_VIDEO_MULTI_SLICE_MODE_SINGLE);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_BITRATE, BITRATE_MIN, BITRATE_MAX,\r\nBITRATE_STEP, BITRATE_DEFAULT);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_BITRATE_PEAK, BITRATE_MIN, BITRATE_MAX,\r\nBITRATE_STEP, BITRATE_DEFAULT_PEAK);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_VPX_PROFILE, 0, 3, 1, 0);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_I_FRAME_QP, 1, 51, 1, 26);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_P_FRAME_QP, 1, 51, 1, 28);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_B_FRAME_QP, 1, 51, 1, 30);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_MIN_QP, 1, 51, 1, 1);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_MAX_QP, 1, 51, 1, 51);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_BYTES, SLICE_BYTE_SIZE_MIN,\r\nSLICE_BYTE_SIZE_MAX, 1, SLICE_BYTE_SIZE_MIN);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_MB, 1,\r\nSLICE_MB_SIZE_MAX, 1, 1);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_ALPHA, -6, 6, 1, 0);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_BETA, -6, 6, 1, 0);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_CYCLIC_INTRA_REFRESH_MB,\r\n0, INTRA_REFRESH_MBS_MAX, 1, 0);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_GOP_SIZE, 0, (1 << 16) - 1, 1, 12);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_VPX_MIN_QP, 1, 128, 1, 1);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_VPX_MAX_QP, 1, 128, 1, 128);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_B_FRAMES, 0, 4, 1, 0);\r\nv4l2_ctrl_new_std(&inst->ctrl_handler, &venc_ctrl_ops,\r\nV4L2_CID_MPEG_VIDEO_H264_I_PERIOD, 0, (1 << 16) - 1, 1, 0);\r\nret = inst->ctrl_handler.error;\r\nif (ret)\r\ngoto err;\r\nret = v4l2_ctrl_handler_setup(&inst->ctrl_handler);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nv4l2_ctrl_handler_free(&inst->ctrl_handler);\r\nreturn ret;\r\n}\r\nvoid venc_ctrl_deinit(struct venus_inst *inst)\r\n{\r\nv4l2_ctrl_handler_free(&inst->ctrl_handler);\r\n}

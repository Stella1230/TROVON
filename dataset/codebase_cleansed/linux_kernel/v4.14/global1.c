int mv88e6xxx_g1_read(struct mv88e6xxx_chip *chip, int reg, u16 *val)\r\n{\r\nint addr = chip->info->global1_addr;\r\nreturn mv88e6xxx_read(chip, addr, reg, val);\r\n}\r\nint mv88e6xxx_g1_write(struct mv88e6xxx_chip *chip, int reg, u16 val)\r\n{\r\nint addr = chip->info->global1_addr;\r\nreturn mv88e6xxx_write(chip, addr, reg, val);\r\n}\r\nint mv88e6xxx_g1_wait(struct mv88e6xxx_chip *chip, int reg, u16 mask)\r\n{\r\nreturn mv88e6xxx_wait(chip, chip->info->global1_addr, reg, mask);\r\n}\r\nstatic int mv88e6185_g1_wait_ppu_disabled(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; i++) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STS, &state);\r\nif (err)\r\nreturn err;\r\nstate &= MV88E6185_G1_STS_PPU_STATE_MASK;\r\nif (state != MV88E6185_G1_STS_PPU_STATE_POLLING)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6185_g1_wait_ppu_polling(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; ++i) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STS, &state);\r\nif (err)\r\nreturn err;\r\nstate &= MV88E6185_G1_STS_PPU_STATE_MASK;\r\nif (state == MV88E6185_G1_STS_PPU_STATE_POLLING)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6352_g1_wait_ppu_polling(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; ++i) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STS, &state);\r\nif (err)\r\nreturn err;\r\nif (state & MV88E6352_G1_STS_PPU_STATE)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6xxx_g1_wait_init_ready(struct mv88e6xxx_chip *chip)\r\n{\r\nconst unsigned long timeout = jiffies + 1 * HZ;\r\nu16 val;\r\nint err;\r\nwhile (time_before(jiffies, timeout)) {\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STS, &val);\r\nif (err)\r\nreturn err;\r\nif (val & MV88E6XXX_G1_STS_INIT_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nint mv88e6xxx_g1_set_switch_mac(struct mv88e6xxx_chip *chip, u8 *addr)\r\n{\r\nu16 reg;\r\nint err;\r\nreg = (addr[0] << 8) | addr[1];\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_MAC_01, reg);\r\nif (err)\r\nreturn err;\r\nreg = (addr[2] << 8) | addr[3];\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_MAC_23, reg);\r\nif (err)\r\nreturn err;\r\nreg = (addr[4] << 8) | addr[5];\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_MAC_45, reg);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nint mv88e6185_g1_reset(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_CTL1, &val);\r\nif (err)\r\nreturn err;\r\nval |= MV88E6XXX_G1_CTL1_SW_RESET;\r\nval |= MV88E6XXX_G1_CTL1_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_CTL1, val);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_wait_init_ready(chip);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6352_g1_reset(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_CTL1, &val);\r\nif (err)\r\nreturn err;\r\nval |= MV88E6XXX_G1_CTL1_SW_RESET;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_CTL1, val);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_wait_init_ready(chip);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6352_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6185_g1_ppu_enable(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_CTL1, &val);\r\nif (err)\r\nreturn err;\r\nval |= MV88E6XXX_G1_CTL1_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_CTL1, val);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6185_g1_ppu_disable(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_CTL1, &val);\r\nif (err)\r\nreturn err;\r\nval &= ~MV88E6XXX_G1_CTL1_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_CTL1, val);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_disabled(chip);\r\n}\r\nint mv88e6095_g1_set_egress_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 reg;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6185_G1_MONITOR_CTL, &reg);\r\nif (err)\r\nreturn err;\r\nreg &= ~(MV88E6185_G1_MONITOR_CTL_INGRESS_DEST_MASK |\r\nMV88E6185_G1_MONITOR_CTL_EGRESS_DEST_MASK);\r\nreg |= port << __bf_shf(MV88E6185_G1_MONITOR_CTL_INGRESS_DEST_MASK) |\r\nport << __bf_shf(MV88E6185_G1_MONITOR_CTL_EGRESS_DEST_MASK);\r\nreturn mv88e6xxx_g1_write(chip, MV88E6185_G1_MONITOR_CTL, reg);\r\n}\r\nint mv88e6095_g1_set_cpu_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 reg;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6185_G1_MONITOR_CTL, &reg);\r\nif (err)\r\nreturn err;\r\nreg &= ~MV88E6185_G1_MONITOR_CTL_ARP_DEST_MASK;\r\nreg |= port << __bf_shf(MV88E6185_G1_MONITOR_CTL_ARP_DEST_MASK);\r\nreturn mv88e6xxx_g1_write(chip, MV88E6185_G1_MONITOR_CTL, reg);\r\n}\r\nstatic int mv88e6390_g1_monitor_write(struct mv88e6xxx_chip *chip,\r\nu16 pointer, u8 data)\r\n{\r\nu16 reg;\r\nreg = MV88E6390_G1_MONITOR_MGMT_CTL_UPDATE | pointer | data;\r\nreturn mv88e6xxx_g1_write(chip, MV88E6390_G1_MONITOR_MGMT_CTL, reg);\r\n}\r\nint mv88e6390_g1_set_egress_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 ptr;\r\nint err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_INGRESS_DEST;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, port);\r\nif (err)\r\nreturn err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_EGRESS_DEST;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, port);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nint mv88e6390_g1_set_cpu_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 ptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_CPU_DEST;\r\nreturn mv88e6390_g1_monitor_write(chip, ptr, port);\r\n}\r\nint mv88e6390_g1_mgmt_rsvd2cpu(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 ptr;\r\nint err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_0180C280000000XLO;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, 0xff);\r\nif (err)\r\nreturn err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_0180C280000000XHI;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, 0xff);\r\nif (err)\r\nreturn err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_0180C280000002XLO;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, 0xff);\r\nif (err)\r\nreturn err;\r\nptr = MV88E6390_G1_MONITOR_MGMT_CTL_PTR_0180C280000002XHI;\r\nerr = mv88e6390_g1_monitor_write(chip, ptr, 0xff);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nint mv88e6390_g1_stats_set_histogram(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_CTL2, &val);\r\nif (err)\r\nreturn err;\r\nval |= MV88E6XXX_G1_CTL2_HIST_RX_TX;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_CTL2, val);\r\nreturn err;\r\n}\r\nint mv88e6xxx_g1_stats_wait(struct mv88e6xxx_chip *chip)\r\n{\r\nreturn mv88e6xxx_g1_wait(chip, MV88E6XXX_G1_STATS_OP,\r\nMV88E6XXX_G1_STATS_OP_BUSY);\r\n}\r\nint mv88e6xxx_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_STATS_OP,\r\nMV88E6XXX_G1_STATS_OP_BUSY |\r\nMV88E6XXX_G1_STATS_OP_CAPTURE_PORT |\r\nMV88E6XXX_G1_STATS_OP_HIST_RX_TX | port);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_stats_wait(chip);\r\n}\r\nint mv88e6320_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nport = (port + 1) << 5;\r\nreturn mv88e6xxx_g1_stats_snapshot(chip, port);\r\n}\r\nint mv88e6390_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nint err;\r\nport = (port + 1) << 5;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_STATS_OP,\r\nMV88E6XXX_G1_STATS_OP_BUSY |\r\nMV88E6XXX_G1_STATS_OP_CAPTURE_PORT | port);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_stats_wait(chip);\r\n}\r\nvoid mv88e6xxx_g1_stats_read(struct mv88e6xxx_chip *chip, int stat, u32 *val)\r\n{\r\nu32 value;\r\nu16 reg;\r\nint err;\r\n*val = 0;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_STATS_OP,\r\nMV88E6XXX_G1_STATS_OP_BUSY |\r\nMV88E6XXX_G1_STATS_OP_READ_CAPTURED | stat);\r\nif (err)\r\nreturn;\r\nerr = mv88e6xxx_g1_stats_wait(chip);\r\nif (err)\r\nreturn;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STATS_COUNTER_32, &reg);\r\nif (err)\r\nreturn;\r\nvalue = reg << 16;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_STATS_COUNTER_01, &reg);\r\nif (err)\r\nreturn;\r\n*val = value | reg;\r\n}

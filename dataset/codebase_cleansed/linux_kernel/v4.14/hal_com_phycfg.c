u8 PHY_GetTxPowerByRateBase(struct adapter *Adapter, u8 Band, u8 RfPath,\r\nu8 TxNum, enum RATE_SECTION RateSection)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 value = 0;\r\nif (RfPath > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid Rf Path %d in PHY_GetTxPowerByRateBase()\n", RfPath);\r\nreturn 0;\r\n}\r\nif (Band == BAND_ON_2_4G) {\r\nswitch (RateSection) {\r\ncase CCK:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][0];\r\nbreak;\r\ncase OFDM:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][1];\r\nbreak;\r\ncase HT_MCS0_MCS7:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][2];\r\nbreak;\r\ncase HT_MCS8_MCS15:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][3];\r\nbreak;\r\ncase HT_MCS16_MCS23:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][4];\r\nbreak;\r\ncase HT_MCS24_MCS31:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][5];\r\nbreak;\r\ncase VHT_1SSMCS0_1SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][6];\r\nbreak;\r\ncase VHT_2SSMCS0_2SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][7];\r\nbreak;\r\ncase VHT_3SSMCS0_3SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][8];\r\nbreak;\r\ncase VHT_4SSMCS0_4SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase2_4G[RfPath][TxNum][9];\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RateSection %d in Band 2.4G, Rf Path %d, %dTx in PHY_GetTxPowerByRateBase()\n",\r\nRateSection, RfPath, TxNum);\r\nbreak;\r\n};\r\n} else if (Band == BAND_ON_5G) {\r\nswitch (RateSection) {\r\ncase OFDM:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][0];\r\nbreak;\r\ncase HT_MCS0_MCS7:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][1];\r\nbreak;\r\ncase HT_MCS8_MCS15:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][2];\r\nbreak;\r\ncase HT_MCS16_MCS23:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][3];\r\nbreak;\r\ncase HT_MCS24_MCS31:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][4];\r\nbreak;\r\ncase VHT_1SSMCS0_1SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][5];\r\nbreak;\r\ncase VHT_2SSMCS0_2SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][6];\r\nbreak;\r\ncase VHT_3SSMCS0_3SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][7];\r\nbreak;\r\ncase VHT_4SSMCS0_4SSMCS9:\r\nvalue = pHalData->TxPwrByRateBase5G[RfPath][TxNum][8];\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RateSection %d in Band 5G, Rf Path %d, %dTx in PHY_GetTxPowerByRateBase()\n",\r\nRateSection, RfPath, TxNum);\r\nbreak;\r\n};\r\n} else\r\nDBG_871X("Invalid Band %d in PHY_GetTxPowerByRateBase()\n", Band);\r\nreturn value;\r\n}\r\nstatic void\r\nphy_SetTxPowerByRateBase(\r\nstruct adapter *Adapter,\r\nu8 Band,\r\nu8 RfPath,\r\nenum RATE_SECTION RateSection,\r\nu8 TxNum,\r\nu8 Value\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nif (RfPath > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid Rf Path %d in phy_SetTxPowerByRatBase()\n", RfPath);\r\nreturn;\r\n}\r\nif (Band == BAND_ON_2_4G) {\r\nswitch (RateSection) {\r\ncase CCK:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][0] = Value;\r\nbreak;\r\ncase OFDM:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][1] = Value;\r\nbreak;\r\ncase HT_MCS0_MCS7:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][2] = Value;\r\nbreak;\r\ncase HT_MCS8_MCS15:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][3] = Value;\r\nbreak;\r\ncase HT_MCS16_MCS23:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][4] = Value;\r\nbreak;\r\ncase HT_MCS24_MCS31:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][5] = Value;\r\nbreak;\r\ncase VHT_1SSMCS0_1SSMCS9:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][6] = Value;\r\nbreak;\r\ncase VHT_2SSMCS0_2SSMCS9:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][7] = Value;\r\nbreak;\r\ncase VHT_3SSMCS0_3SSMCS9:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][8] = Value;\r\nbreak;\r\ncase VHT_4SSMCS0_4SSMCS9:\r\npHalData->TxPwrByRateBase2_4G[RfPath][TxNum][9] = Value;\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RateSection %d in Band 2.4G, Rf Path %d, %dTx in phy_SetTxPowerByRateBase()\n",\r\nRateSection, RfPath, TxNum);\r\nbreak;\r\n};\r\n} else if (Band == BAND_ON_5G) {\r\nswitch (RateSection) {\r\ncase OFDM:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][0] = Value;\r\nbreak;\r\ncase HT_MCS0_MCS7:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][1] = Value;\r\nbreak;\r\ncase HT_MCS8_MCS15:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][2] = Value;\r\nbreak;\r\ncase HT_MCS16_MCS23:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][3] = Value;\r\nbreak;\r\ncase HT_MCS24_MCS31:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][4] = Value;\r\nbreak;\r\ncase VHT_1SSMCS0_1SSMCS9:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][5] = Value;\r\nbreak;\r\ncase VHT_2SSMCS0_2SSMCS9:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][6] = Value;\r\nbreak;\r\ncase VHT_3SSMCS0_3SSMCS9:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][7] = Value;\r\nbreak;\r\ncase VHT_4SSMCS0_4SSMCS9:\r\npHalData->TxPwrByRateBase5G[RfPath][TxNum][8] = Value;\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RateSection %d in Band 5G, Rf Path %d, %dTx in phy_SetTxPowerByRateBase()\n",\r\nRateSection, RfPath, TxNum);\r\nbreak;\r\n};\r\n} else\r\nDBG_871X("Invalid Band %d in phy_SetTxPowerByRateBase()\n", Band);\r\n}\r\nstatic void\r\nphy_StoreTxPowerByRateBase(\r\nstruct adapter *padapter\r\n)\r\n{\r\nu8 path, base;\r\nfor (path = ODM_RF_PATH_A; path <= ODM_RF_PATH_B; ++path) {\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_1TX, MGN_11M);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, CCK, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_1TX, MGN_54M);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, OFDM, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_1TX, MGN_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, HT_MCS0_MCS7, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_2TX, MGN_MCS15);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, HT_MCS8_MCS15, RF_2TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_3TX, MGN_MCS23);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, HT_MCS16_MCS23, RF_3TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_1TX, MGN_VHT1SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, VHT_1SSMCS0_1SSMCS9, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_2TX, MGN_VHT2SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, VHT_2SSMCS0_2SSMCS9, RF_2TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, path, RF_3TX, MGN_VHT3SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_2_4G, path, VHT_3SSMCS0_3SSMCS9, RF_3TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_1TX, MGN_54M);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, OFDM, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_1TX, MGN_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, HT_MCS0_MCS7, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_2TX, MGN_MCS15);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, HT_MCS8_MCS15, RF_2TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_3TX, MGN_MCS23);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, HT_MCS16_MCS23, RF_3TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_1TX, MGN_VHT1SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, VHT_1SSMCS0_1SSMCS9, RF_1TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_2TX, MGN_VHT2SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, VHT_2SSMCS0_2SSMCS9, RF_2TX, base);\r\nbase = PHY_GetTxPowerByRate(padapter, BAND_ON_5G, path, RF_3TX, MGN_VHT2SS_MCS7);\r\nphy_SetTxPowerByRateBase(padapter, BAND_ON_5G, path, VHT_3SSMCS0_3SSMCS9, RF_3TX, base);\r\n}\r\n}\r\nu8 PHY_GetRateSectionIndexOfTxPowerByRate(\r\nstruct adapter *padapter, u32 RegAddr, u32 BitMask\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nu8 index = 0;\r\nif (pDM_Odm->PhyRegPgVersion == 0) {\r\nswitch (RegAddr) {\r\ncase rTxAGC_A_Rate18_06:\r\nindex = 0;\r\nbreak;\r\ncase rTxAGC_A_Rate54_24:\r\nindex = 1;\r\nbreak;\r\ncase rTxAGC_A_CCK1_Mcs32:\r\nindex = 6;\r\nbreak;\r\ncase rTxAGC_B_CCK11_A_CCK2_11:\r\nif (BitMask == bMaskH3Bytes)\r\nindex = 7;\r\nelse if (BitMask == 0x000000ff)\r\nindex = 15;\r\nbreak;\r\ncase rTxAGC_A_Mcs03_Mcs00:\r\nindex = 2;\r\nbreak;\r\ncase rTxAGC_A_Mcs07_Mcs04:\r\nindex = 3;\r\nbreak;\r\ncase rTxAGC_A_Mcs11_Mcs08:\r\nindex = 4;\r\nbreak;\r\ncase rTxAGC_A_Mcs15_Mcs12:\r\nindex = 5;\r\nbreak;\r\ncase rTxAGC_B_Rate18_06:\r\nindex = 8;\r\nbreak;\r\ncase rTxAGC_B_Rate54_24:\r\nindex = 9;\r\nbreak;\r\ncase rTxAGC_B_CCK1_55_Mcs32:\r\nindex = 14;\r\nbreak;\r\ncase rTxAGC_B_Mcs03_Mcs00:\r\nindex = 10;\r\nbreak;\r\ncase rTxAGC_B_Mcs07_Mcs04:\r\nindex = 11;\r\nbreak;\r\ncase rTxAGC_B_Mcs11_Mcs08:\r\nindex = 12;\r\nbreak;\r\ncase rTxAGC_B_Mcs15_Mcs12:\r\nindex = 13;\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RegAddr 0x3%x in PHY_GetRateSectionIndexOfTxPowerByRate()", RegAddr);\r\nbreak;\r\n};\r\n}\r\nreturn index;\r\n}\r\nvoid\r\nPHY_GetRateValuesOfTxPowerByRate(\r\nstruct adapter *padapter,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Value,\r\nu8 *RateIndex,\r\ns8 *PwrByRateVal,\r\nu8 *RateNum\r\n)\r\n{\r\nu8 i = 0;\r\nswitch (RegAddr) {\r\ncase rTxAGC_A_Rate18_06:\r\ncase rTxAGC_B_Rate18_06:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_6M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_9M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_12M);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_18M);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_A_Rate54_24:\r\ncase rTxAGC_B_Rate54_24:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_24M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_36M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_48M);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_54M);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_A_CCK1_Mcs32:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_1M);\r\nPwrByRateVal[0] = (s8) ((((Value >> (8 + 4)) & 0xF)) * 10 +\r\n((Value >> 8) & 0xF));\r\n*RateNum = 1;\r\nbreak;\r\ncase rTxAGC_B_CCK11_A_CCK2_11:\r\nif (BitMask == 0xffffff00) {\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_2M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_5_5M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_11M);\r\nfor (i = 1; i < 4; ++i) {\r\nPwrByRateVal[i - 1] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 3;\r\n} else if (BitMask == 0x000000ff) {\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_11M);\r\nPwrByRateVal[0] = (s8) ((((Value >> 4) & 0xF)) * 10 + (Value & 0xF));\r\n*RateNum = 1;\r\n}\r\nbreak;\r\ncase rTxAGC_A_Mcs03_Mcs00:\r\ncase rTxAGC_B_Mcs03_Mcs00:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS0);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS1);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS2);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS3);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_A_Mcs07_Mcs04:\r\ncase rTxAGC_B_Mcs07_Mcs04:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS4);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS5);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS6);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS7);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_A_Mcs11_Mcs08:\r\ncase rTxAGC_B_Mcs11_Mcs08:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS8);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS9);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS10);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS11);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_A_Mcs15_Mcs12:\r\ncase rTxAGC_B_Mcs15_Mcs12:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS12);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS13);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS14);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS15);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase rTxAGC_B_CCK1_55_Mcs32:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_1M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_2M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_5_5M);\r\nfor (i = 1; i < 4; ++i) {\r\nPwrByRateVal[i - 1] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 3;\r\nbreak;\r\ncase 0xC20:\r\ncase 0xE20:\r\ncase 0x1820:\r\ncase 0x1a20:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_1M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_2M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_5_5M);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_11M);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC24:\r\ncase 0xE24:\r\ncase 0x1824:\r\ncase 0x1a24:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_6M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_9M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_12M);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_18M);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC28:\r\ncase 0xE28:\r\ncase 0x1828:\r\ncase 0x1a28:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_24M);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_36M);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_48M);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_54M);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC2C:\r\ncase 0xE2C:\r\ncase 0x182C:\r\ncase 0x1a2C:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS0);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS1);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS2);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS3);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC30:\r\ncase 0xE30:\r\ncase 0x1830:\r\ncase 0x1a30:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS4);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS5);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS6);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS7);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC34:\r\ncase 0xE34:\r\ncase 0x1834:\r\ncase 0x1a34:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS8);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS9);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS10);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS11);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC38:\r\ncase 0xE38:\r\ncase 0x1838:\r\ncase 0x1a38:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS12);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS13);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS14);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS15);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC3C:\r\ncase 0xE3C:\r\ncase 0x183C:\r\ncase 0x1a3C:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS0);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS1);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS2);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS3);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC40:\r\ncase 0xE40:\r\ncase 0x1840:\r\ncase 0x1a40:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS4);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS5);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS6);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS7);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC44:\r\ncase 0xE44:\r\ncase 0x1844:\r\ncase 0x1a44:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS8);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT1SS_MCS9);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS0);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS1);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC48:\r\ncase 0xE48:\r\ncase 0x1848:\r\ncase 0x1a48:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS2);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS3);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS4);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS5);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xC4C:\r\ncase 0xE4C:\r\ncase 0x184C:\r\ncase 0x1a4C:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS6);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS7);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS8);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS9);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xCD8:\r\ncase 0xED8:\r\ncase 0x18D8:\r\ncase 0x1aD8:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS16);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS17);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS18);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS19);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xCDC:\r\ncase 0xEDC:\r\ncase 0x18DC:\r\ncase 0x1aDC:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS20);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS21);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS22);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_MCS23);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xCE0:\r\ncase 0xEE0:\r\ncase 0x18E0:\r\ncase 0x1aE0:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS0);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS1);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS2);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS3);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xCE4:\r\ncase 0xEE4:\r\ncase 0x18E4:\r\ncase 0x1aE4:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS4);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS5);\r\nRateIndex[2] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS6);\r\nRateIndex[3] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS7);\r\nfor (i = 0; i < 4; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ncase 0xCE8:\r\ncase 0xEE8:\r\ncase 0x18E8:\r\ncase 0x1aE8:\r\nRateIndex[0] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS8);\r\nRateIndex[1] = PHY_GetRateIndexOfTxPowerByRate(MGN_VHT3SS_MCS9);\r\nfor (i = 0; i < 2; ++i) {\r\nPwrByRateVal[i] = (s8) ((((Value >> (i * 8 + 4)) & 0xF)) * 10 +\r\n((Value >> (i * 8)) & 0xF));\r\n}\r\n*RateNum = 4;\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid RegAddr 0x%x in %s()\n", RegAddr, __func__);\r\nbreak;\r\n};\r\n}\r\nstatic void PHY_StoreTxPowerByRateNew(\r\nstruct adapter *padapter,\r\nu32 Band,\r\nu32 RfPath,\r\nu32 TxNum,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Data\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 i = 0, rateIndex[4] = {0}, rateNum = 0;\r\ns8 PwrByRateVal[4] = {0};\r\nPHY_GetRateValuesOfTxPowerByRate(padapter, RegAddr, BitMask, Data, rateIndex, PwrByRateVal, &rateNum);\r\nif (Band != BAND_ON_2_4G && Band != BAND_ON_5G) {\r\nDBG_871X("Invalid Band %d\n", Band);\r\nreturn;\r\n}\r\nif (RfPath > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid RfPath %d\n", RfPath);\r\nreturn;\r\n}\r\nif (TxNum > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid TxNum %d\n", TxNum);\r\nreturn;\r\n}\r\nfor (i = 0; i < rateNum; ++i) {\r\nif (rateIndex[i] == PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS0) ||\r\nrateIndex[i] == PHY_GetRateIndexOfTxPowerByRate(MGN_VHT2SS_MCS1))\r\nTxNum = RF_2TX;\r\npHalData->TxPwrByRateOffset[Band][RfPath][TxNum][rateIndex[i]] = PwrByRateVal[i];\r\n}\r\n}\r\nstatic void PHY_StoreTxPowerByRateOld(\r\nstruct adapter *padapter, u32 RegAddr, u32 BitMask, u32 Data\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 index = PHY_GetRateSectionIndexOfTxPowerByRate(padapter, RegAddr, BitMask);\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][index] = Data;\r\n}\r\nvoid PHY_InitTxPowerByRate(struct adapter *padapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 band, rfPath, TxNum, rate;\r\nfor (band = BAND_ON_2_4G; band <= BAND_ON_5G; ++band)\r\nfor (rfPath = 0; rfPath < TX_PWR_BY_RATE_NUM_RF; ++rfPath)\r\nfor (TxNum = 0; TxNum < TX_PWR_BY_RATE_NUM_RF; ++TxNum)\r\nfor (rate = 0; rate < TX_PWR_BY_RATE_NUM_RATE; ++rate)\r\npHalData->TxPwrByRateOffset[band][rfPath][TxNum][rate] = 0;\r\n}\r\nvoid PHY_StoreTxPowerByRate(\r\nstruct adapter *padapter,\r\nu32 Band,\r\nu32 RfPath,\r\nu32 TxNum,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Data\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nif (pDM_Odm->PhyRegPgVersion > 0)\r\nPHY_StoreTxPowerByRateNew(padapter, Band, RfPath, TxNum, RegAddr, BitMask, Data);\r\nelse if (pDM_Odm->PhyRegPgVersion == 0) {\r\nPHY_StoreTxPowerByRateOld(padapter, RegAddr, BitMask, Data);\r\nif (RegAddr == rTxAGC_A_Mcs15_Mcs12 && pHalData->rf_type == RF_1T1R)\r\npHalData->pwrGroupCnt++;\r\nelse if (RegAddr == rTxAGC_B_Mcs15_Mcs12 && pHalData->rf_type != RF_1T1R)\r\npHalData->pwrGroupCnt++;\r\n} else\r\nDBG_871X("Invalid PHY_REG_PG.txt version %d\n", pDM_Odm->PhyRegPgVersion);\r\n}\r\nstatic void\r\nphy_ConvertTxPowerByRateInDbmToRelativeValues(\r\nstruct adapter *padapter\r\n)\r\n{\r\nu8 base = 0, i = 0, value = 0, band = 0, path = 0, txNum = 0;\r\nu8 cckRates[4] = {\r\nMGN_1M, MGN_2M, MGN_5_5M, MGN_11M\r\n};\r\nu8 ofdmRates[8] = {\r\nMGN_6M, MGN_9M, MGN_12M, MGN_18M, MGN_24M, MGN_36M, MGN_48M, MGN_54M\r\n};\r\nu8 mcs0_7Rates[8] = {\r\nMGN_MCS0, MGN_MCS1, MGN_MCS2, MGN_MCS3, MGN_MCS4, MGN_MCS5, MGN_MCS6, MGN_MCS7\r\n};\r\nu8 mcs8_15Rates[8] = {\r\nMGN_MCS8, MGN_MCS9, MGN_MCS10, MGN_MCS11, MGN_MCS12, MGN_MCS13, MGN_MCS14, MGN_MCS15\r\n};\r\nu8 mcs16_23Rates[8] = {\r\nMGN_MCS16, MGN_MCS17, MGN_MCS18, MGN_MCS19, MGN_MCS20, MGN_MCS21, MGN_MCS22, MGN_MCS23\r\n};\r\nu8 vht1ssRates[10] = {\r\nMGN_VHT1SS_MCS0, MGN_VHT1SS_MCS1, MGN_VHT1SS_MCS2, MGN_VHT1SS_MCS3, MGN_VHT1SS_MCS4,\r\nMGN_VHT1SS_MCS5, MGN_VHT1SS_MCS6, MGN_VHT1SS_MCS7, MGN_VHT1SS_MCS8, MGN_VHT1SS_MCS9\r\n};\r\nu8 vht2ssRates[10] = {\r\nMGN_VHT2SS_MCS0, MGN_VHT2SS_MCS1, MGN_VHT2SS_MCS2, MGN_VHT2SS_MCS3, MGN_VHT2SS_MCS4,\r\nMGN_VHT2SS_MCS5, MGN_VHT2SS_MCS6, MGN_VHT2SS_MCS7, MGN_VHT2SS_MCS8, MGN_VHT2SS_MCS9\r\n};\r\nu8 vht3ssRates[10] = {\r\nMGN_VHT3SS_MCS0, MGN_VHT3SS_MCS1, MGN_VHT3SS_MCS2, MGN_VHT3SS_MCS3, MGN_VHT3SS_MCS4,\r\nMGN_VHT3SS_MCS5, MGN_VHT3SS_MCS6, MGN_VHT3SS_MCS7, MGN_VHT3SS_MCS8, MGN_VHT3SS_MCS9\r\n};\r\nfor (band = BAND_ON_2_4G; band <= BAND_ON_5G; ++band) {\r\nfor (path = ODM_RF_PATH_A; path <= ODM_RF_PATH_D; ++path) {\r\nfor (txNum = RF_1TX; txNum < RF_MAX_TX_NUM; ++txNum) {\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_11M);\r\nfor (i = 0; i < sizeof(cckRates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, cckRates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, cckRates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_54M);\r\nfor (i = 0; i < sizeof(ofdmRates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, ofdmRates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, ofdmRates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_MCS7);\r\nfor (i = 0; i < sizeof(mcs0_7Rates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, mcs0_7Rates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, mcs0_7Rates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_MCS15);\r\nfor (i = 0; i < sizeof(mcs8_15Rates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, mcs8_15Rates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, mcs8_15Rates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_MCS23);\r\nfor (i = 0; i < sizeof(mcs16_23Rates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, mcs16_23Rates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, mcs16_23Rates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_VHT1SS_MCS7);\r\nfor (i = 0; i < sizeof(vht1ssRates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, vht1ssRates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, vht1ssRates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_VHT2SS_MCS7);\r\nfor (i = 0; i < sizeof(vht2ssRates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, vht2ssRates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, vht2ssRates[i], value - base);\r\n}\r\nbase = PHY_GetTxPowerByRate(padapter, band, path, txNum, MGN_VHT3SS_MCS7);\r\nfor (i = 0; i < sizeof(vht3ssRates); ++i) {\r\nvalue = PHY_GetTxPowerByRate(padapter, band, path, txNum, vht3ssRates[i]);\r\nPHY_SetTxPowerByRate(padapter, band, path, txNum, vht3ssRates[i], value - base);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid PHY_TxPowerByRateConfiguration(struct adapter *padapter)\r\n{\r\nphy_StoreTxPowerByRateBase(padapter);\r\nphy_ConvertTxPowerByRateInDbmToRelativeValues(padapter);\r\n}\r\nvoid PHY_SetTxPowerIndexByRateSection(\r\nstruct adapter *padapter, u8 RFPath, u8 Channel, u8 RateSection\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nif (RateSection == CCK) {\r\nu8 cckRates[] = {MGN_1M, MGN_2M, MGN_5_5M, MGN_11M};\r\nif (pHalData->CurrentBandType == BAND_ON_2_4G)\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\ncckRates, sizeof(cckRates)/sizeof(u8));\r\n} else if (RateSection == OFDM) {\r\nu8 ofdmRates[] = {MGN_6M, MGN_9M, MGN_12M, MGN_18M, MGN_24M, MGN_36M, MGN_48M, MGN_54M};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nofdmRates, sizeof(ofdmRates)/sizeof(u8));\r\n} else if (RateSection == HT_MCS0_MCS7) {\r\nu8 htRates1T[] = {MGN_MCS0, MGN_MCS1, MGN_MCS2, MGN_MCS3, MGN_MCS4, MGN_MCS5, MGN_MCS6, MGN_MCS7};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nhtRates1T, sizeof(htRates1T)/sizeof(u8));\r\n} else if (RateSection == HT_MCS8_MCS15) {\r\nu8 htRates2T[] = {MGN_MCS8, MGN_MCS9, MGN_MCS10, MGN_MCS11, MGN_MCS12, MGN_MCS13, MGN_MCS14, MGN_MCS15};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nhtRates2T, sizeof(htRates2T)/sizeof(u8));\r\n} else if (RateSection == HT_MCS16_MCS23) {\r\nu8 htRates3T[] = {MGN_MCS16, MGN_MCS17, MGN_MCS18, MGN_MCS19, MGN_MCS20, MGN_MCS21, MGN_MCS22, MGN_MCS23};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nhtRates3T, sizeof(htRates3T)/sizeof(u8));\r\n} else if (RateSection == HT_MCS24_MCS31) {\r\nu8 htRates4T[] = {MGN_MCS24, MGN_MCS25, MGN_MCS26, MGN_MCS27, MGN_MCS28, MGN_MCS29, MGN_MCS30, MGN_MCS31};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nhtRates4T, sizeof(htRates4T)/sizeof(u8));\r\n} else if (RateSection == VHT_1SSMCS0_1SSMCS9) {\r\nu8 vhtRates1T[] = {MGN_VHT1SS_MCS0, MGN_VHT1SS_MCS1, MGN_VHT1SS_MCS2, MGN_VHT1SS_MCS3, MGN_VHT1SS_MCS4,\r\nMGN_VHT1SS_MCS5, MGN_VHT1SS_MCS6, MGN_VHT1SS_MCS7, MGN_VHT1SS_MCS8, MGN_VHT1SS_MCS9};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nvhtRates1T, sizeof(vhtRates1T)/sizeof(u8));\r\n} else if (RateSection == VHT_2SSMCS0_2SSMCS9) {\r\nu8 vhtRates2T[] = {MGN_VHT2SS_MCS0, MGN_VHT2SS_MCS1, MGN_VHT2SS_MCS2, MGN_VHT2SS_MCS3, MGN_VHT2SS_MCS4,\r\nMGN_VHT2SS_MCS5, MGN_VHT2SS_MCS6, MGN_VHT2SS_MCS7, MGN_VHT2SS_MCS8, MGN_VHT2SS_MCS9};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nvhtRates2T, sizeof(vhtRates2T)/sizeof(u8));\r\n} else if (RateSection == VHT_3SSMCS0_3SSMCS9) {\r\nu8 vhtRates3T[] = {MGN_VHT3SS_MCS0, MGN_VHT3SS_MCS1, MGN_VHT3SS_MCS2, MGN_VHT3SS_MCS3, MGN_VHT3SS_MCS4,\r\nMGN_VHT3SS_MCS5, MGN_VHT3SS_MCS6, MGN_VHT3SS_MCS7, MGN_VHT3SS_MCS8, MGN_VHT3SS_MCS9};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nvhtRates3T, sizeof(vhtRates3T)/sizeof(u8));\r\n} else if (RateSection == VHT_4SSMCS0_4SSMCS9) {\r\nu8 vhtRates4T[] = {MGN_VHT4SS_MCS0, MGN_VHT4SS_MCS1, MGN_VHT4SS_MCS2, MGN_VHT4SS_MCS3, MGN_VHT4SS_MCS4,\r\nMGN_VHT4SS_MCS5, MGN_VHT4SS_MCS6, MGN_VHT4SS_MCS7, MGN_VHT4SS_MCS8, MGN_VHT4SS_MCS9};\r\nPHY_SetTxPowerIndexByRateArray(padapter, RFPath, pHalData->CurrentChannelBW, Channel,\r\nvhtRates4T, sizeof(vhtRates4T)/sizeof(u8));\r\n} else\r\nDBG_871X("Invalid RateSection %d in %s", RateSection, __func__);\r\n}\r\nstatic bool phy_GetChnlIndex(u8 Channel, u8 *ChannelIdx)\r\n{\r\nu8 channel5G[CHANNEL_MAX_NUMBER_5G] = {\r\n36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 100, 102,\r\n104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130,\r\n132, 134, 136, 138, 140, 142, 144, 149, 151, 153, 155, 157, 159, 161,\r\n163, 165, 167, 168, 169, 171, 173, 175, 177\r\n};\r\nu8 i = 0;\r\nbool bIn24G = true;\r\nif (Channel <= 14) {\r\nbIn24G = true;\r\n*ChannelIdx = Channel-1;\r\n} else {\r\nbIn24G = false;\r\nfor (i = 0; i < sizeof(channel5G)/sizeof(u8); ++i) {\r\nif (channel5G[i] == Channel) {\r\n*ChannelIdx = i;\r\nreturn bIn24G;\r\n}\r\n}\r\n}\r\nreturn bIn24G;\r\n}\r\nu8 PHY_GetTxPowerIndexBase(\r\nstruct adapter *padapter,\r\nu8 RFPath,\r\nu8 Rate,\r\nenum CHANNEL_WIDTH BandWidth,\r\nu8 Channel,\r\nbool *bIn24G\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 i = 0;\r\nu8 txPower = 0;\r\nu8 chnlIdx = (Channel-1);\r\nif (HAL_IsLegalChannel(padapter, Channel) == false) {\r\nchnlIdx = 0;\r\nDBG_871X("Illegal channel!!\n");\r\n}\r\n*bIn24G = phy_GetChnlIndex(Channel, &chnlIdx);\r\nif (*bIn24G) {\r\nif (IS_CCK_RATE(Rate))\r\ntxPower = pHalData->Index24G_CCK_Base[RFPath][chnlIdx];\r\nelse if (MGN_6M <= Rate)\r\ntxPower = pHalData->Index24G_BW40_Base[RFPath][chnlIdx];\r\nelse\r\nDBG_871X("PHY_GetTxPowerIndexBase: INVALID Rate.\n");\r\nif ((MGN_6M <= Rate && Rate <= MGN_54M) && !IS_CCK_RATE(Rate)) {\r\ntxPower += pHalData->OFDM_24G_Diff[RFPath][TX_1S];\r\n}\r\nif (BandWidth == CHANNEL_WIDTH_20) {\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_24G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_24G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_24G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS24 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_24G_Diff[RFPath][TX_4S];\r\n} else if (BandWidth == CHANNEL_WIDTH_40) {\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS24 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_4S];\r\n}\r\nelse if (BandWidth == CHANNEL_WIDTH_80) {\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS24 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_24G_Diff[RFPath][TX_4S];\r\n}\r\n} else {\r\nif (MGN_6M <= Rate)\r\ntxPower = pHalData->Index5G_BW40_Base[RFPath][chnlIdx];\r\nelse\r\nDBG_871X("===> mpt_ProQueryCalTxPower_Jaguar: INVALID Rate.\n");\r\nif ((MGN_6M <= Rate && Rate <= MGN_54M) && !IS_CCK_RATE(Rate)) {\r\ntxPower += pHalData->OFDM_5G_Diff[RFPath][TX_1S];\r\n}\r\nif (BandWidth == CHANNEL_WIDTH_20) {\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_5G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_5G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_5G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS24 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW20_5G_Diff[RFPath][TX_4S];\r\n} else if (BandWidth == CHANNEL_WIDTH_40) {\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_5G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_5G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_5G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS24 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW40_5G_Diff[RFPath][TX_4S];\r\n} else if (BandWidth == CHANNEL_WIDTH_80) {\r\nu8 channel5G_80M[CHANNEL_MAX_NUMBER_5G_80M] = {42, 58, 106, 122, 138, 155, 171};\r\nfor (i = 0; i < sizeof(channel5G_80M)/sizeof(u8); ++i)\r\nif (channel5G_80M[i] == Channel)\r\nchnlIdx = i;\r\ntxPower = pHalData->Index5G_BW80_Base[RFPath][chnlIdx];\r\nif ((MGN_MCS0 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT1SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += + pHalData->BW80_5G_Diff[RFPath][TX_1S];\r\nif ((MGN_MCS8 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT2SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW80_5G_Diff[RFPath][TX_2S];\r\nif ((MGN_MCS16 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT3SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW80_5G_Diff[RFPath][TX_3S];\r\nif ((MGN_MCS23 <= Rate && Rate <= MGN_MCS31) || (MGN_VHT4SS_MCS0 <= Rate && Rate <= MGN_VHT4SS_MCS9))\r\ntxPower += pHalData->BW80_5G_Diff[RFPath][TX_4S];\r\n}\r\n}\r\nreturn txPower;\r\n}\r\ns8 PHY_GetTxPowerTrackingOffset(struct adapter *padapter, u8 RFPath, u8 Rate)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\ns8 offset = 0;\r\nif (pDM_Odm->RFCalibrateInfo.TxPowerTrackControl == false)\r\nreturn offset;\r\nif ((Rate == MGN_1M) || (Rate == MGN_2M) || (Rate == MGN_5_5M) || (Rate == MGN_11M)) {\r\noffset = pDM_Odm->Remnant_CCKSwingIdx;\r\n} else {\r\noffset = pDM_Odm->Remnant_OFDMSwingIdx[RFPath];\r\n}\r\nreturn offset;\r\n}\r\nu8 PHY_GetRateIndexOfTxPowerByRate(u8 Rate)\r\n{\r\nu8 index = 0;\r\nswitch (Rate) {\r\ncase MGN_1M:\r\nindex = 0;\r\nbreak;\r\ncase MGN_2M:\r\nindex = 1;\r\nbreak;\r\ncase MGN_5_5M:\r\nindex = 2;\r\nbreak;\r\ncase MGN_11M:\r\nindex = 3;\r\nbreak;\r\ncase MGN_6M:\r\nindex = 4;\r\nbreak;\r\ncase MGN_9M:\r\nindex = 5;\r\nbreak;\r\ncase MGN_12M:\r\nindex = 6;\r\nbreak;\r\ncase MGN_18M:\r\nindex = 7;\r\nbreak;\r\ncase MGN_24M:\r\nindex = 8;\r\nbreak;\r\ncase MGN_36M:\r\nindex = 9;\r\nbreak;\r\ncase MGN_48M:\r\nindex = 10;\r\nbreak;\r\ncase MGN_54M:\r\nindex = 11;\r\nbreak;\r\ncase MGN_MCS0:\r\nindex = 12;\r\nbreak;\r\ncase MGN_MCS1:\r\nindex = 13;\r\nbreak;\r\ncase MGN_MCS2:\r\nindex = 14;\r\nbreak;\r\ncase MGN_MCS3:\r\nindex = 15;\r\nbreak;\r\ncase MGN_MCS4:\r\nindex = 16;\r\nbreak;\r\ncase MGN_MCS5:\r\nindex = 17;\r\nbreak;\r\ncase MGN_MCS6:\r\nindex = 18;\r\nbreak;\r\ncase MGN_MCS7:\r\nindex = 19;\r\nbreak;\r\ncase MGN_MCS8:\r\nindex = 20;\r\nbreak;\r\ncase MGN_MCS9:\r\nindex = 21;\r\nbreak;\r\ncase MGN_MCS10:\r\nindex = 22;\r\nbreak;\r\ncase MGN_MCS11:\r\nindex = 23;\r\nbreak;\r\ncase MGN_MCS12:\r\nindex = 24;\r\nbreak;\r\ncase MGN_MCS13:\r\nindex = 25;\r\nbreak;\r\ncase MGN_MCS14:\r\nindex = 26;\r\nbreak;\r\ncase MGN_MCS15:\r\nindex = 27;\r\nbreak;\r\ncase MGN_MCS16:\r\nindex = 28;\r\nbreak;\r\ncase MGN_MCS17:\r\nindex = 29;\r\nbreak;\r\ncase MGN_MCS18:\r\nindex = 30;\r\nbreak;\r\ncase MGN_MCS19:\r\nindex = 31;\r\nbreak;\r\ncase MGN_MCS20:\r\nindex = 32;\r\nbreak;\r\ncase MGN_MCS21:\r\nindex = 33;\r\nbreak;\r\ncase MGN_MCS22:\r\nindex = 34;\r\nbreak;\r\ncase MGN_MCS23:\r\nindex = 35;\r\nbreak;\r\ncase MGN_MCS24:\r\nindex = 36;\r\nbreak;\r\ncase MGN_MCS25:\r\nindex = 37;\r\nbreak;\r\ncase MGN_MCS26:\r\nindex = 38;\r\nbreak;\r\ncase MGN_MCS27:\r\nindex = 39;\r\nbreak;\r\ncase MGN_MCS28:\r\nindex = 40;\r\nbreak;\r\ncase MGN_MCS29:\r\nindex = 41;\r\nbreak;\r\ncase MGN_MCS30:\r\nindex = 42;\r\nbreak;\r\ncase MGN_MCS31:\r\nindex = 43;\r\nbreak;\r\ncase MGN_VHT1SS_MCS0:\r\nindex = 44;\r\nbreak;\r\ncase MGN_VHT1SS_MCS1:\r\nindex = 45;\r\nbreak;\r\ncase MGN_VHT1SS_MCS2:\r\nindex = 46;\r\nbreak;\r\ncase MGN_VHT1SS_MCS3:\r\nindex = 47;\r\nbreak;\r\ncase MGN_VHT1SS_MCS4:\r\nindex = 48;\r\nbreak;\r\ncase MGN_VHT1SS_MCS5:\r\nindex = 49;\r\nbreak;\r\ncase MGN_VHT1SS_MCS6:\r\nindex = 50;\r\nbreak;\r\ncase MGN_VHT1SS_MCS7:\r\nindex = 51;\r\nbreak;\r\ncase MGN_VHT1SS_MCS8:\r\nindex = 52;\r\nbreak;\r\ncase MGN_VHT1SS_MCS9:\r\nindex = 53;\r\nbreak;\r\ncase MGN_VHT2SS_MCS0:\r\nindex = 54;\r\nbreak;\r\ncase MGN_VHT2SS_MCS1:\r\nindex = 55;\r\nbreak;\r\ncase MGN_VHT2SS_MCS2:\r\nindex = 56;\r\nbreak;\r\ncase MGN_VHT2SS_MCS3:\r\nindex = 57;\r\nbreak;\r\ncase MGN_VHT2SS_MCS4:\r\nindex = 58;\r\nbreak;\r\ncase MGN_VHT2SS_MCS5:\r\nindex = 59;\r\nbreak;\r\ncase MGN_VHT2SS_MCS6:\r\nindex = 60;\r\nbreak;\r\ncase MGN_VHT2SS_MCS7:\r\nindex = 61;\r\nbreak;\r\ncase MGN_VHT2SS_MCS8:\r\nindex = 62;\r\nbreak;\r\ncase MGN_VHT2SS_MCS9:\r\nindex = 63;\r\nbreak;\r\ncase MGN_VHT3SS_MCS0:\r\nindex = 64;\r\nbreak;\r\ncase MGN_VHT3SS_MCS1:\r\nindex = 65;\r\nbreak;\r\ncase MGN_VHT3SS_MCS2:\r\nindex = 66;\r\nbreak;\r\ncase MGN_VHT3SS_MCS3:\r\nindex = 67;\r\nbreak;\r\ncase MGN_VHT3SS_MCS4:\r\nindex = 68;\r\nbreak;\r\ncase MGN_VHT3SS_MCS5:\r\nindex = 69;\r\nbreak;\r\ncase MGN_VHT3SS_MCS6:\r\nindex = 70;\r\nbreak;\r\ncase MGN_VHT3SS_MCS7:\r\nindex = 71;\r\nbreak;\r\ncase MGN_VHT3SS_MCS8:\r\nindex = 72;\r\nbreak;\r\ncase MGN_VHT3SS_MCS9:\r\nindex = 73;\r\nbreak;\r\ncase MGN_VHT4SS_MCS0:\r\nindex = 74;\r\nbreak;\r\ncase MGN_VHT4SS_MCS1:\r\nindex = 75;\r\nbreak;\r\ncase MGN_VHT4SS_MCS2:\r\nindex = 76;\r\nbreak;\r\ncase MGN_VHT4SS_MCS3:\r\nindex = 77;\r\nbreak;\r\ncase MGN_VHT4SS_MCS4:\r\nindex = 78;\r\nbreak;\r\ncase MGN_VHT4SS_MCS5:\r\nindex = 79;\r\nbreak;\r\ncase MGN_VHT4SS_MCS6:\r\nindex = 80;\r\nbreak;\r\ncase MGN_VHT4SS_MCS7:\r\nindex = 81;\r\nbreak;\r\ncase MGN_VHT4SS_MCS8:\r\nindex = 82;\r\nbreak;\r\ncase MGN_VHT4SS_MCS9:\r\nindex = 83;\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid rate 0x%x in %s\n", Rate, __func__);\r\nbreak;\r\n};\r\nreturn index;\r\n}\r\ns8 PHY_GetTxPowerByRate(\r\nstruct adapter *padapter, u8 Band, u8 RFPath, u8 TxNum, u8 Rate\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\ns8 value = 0;\r\nu8 rateIndex = PHY_GetRateIndexOfTxPowerByRate(Rate);\r\nif ((padapter->registrypriv.RegEnableTxPowerByRate == 2 && pHalData->EEPROMRegulatory == 2) ||\r\npadapter->registrypriv.RegEnableTxPowerByRate == 0)\r\nreturn 0;\r\nif (Band != BAND_ON_2_4G && Band != BAND_ON_5G) {\r\nDBG_871X("Invalid band %d in %s\n", Band, __func__);\r\nreturn value;\r\n}\r\nif (RFPath > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid RfPath %d in %s\n", RFPath, __func__);\r\nreturn value;\r\n}\r\nif (TxNum >= RF_MAX_TX_NUM) {\r\nDBG_871X("Invalid TxNum %d in %s\n", TxNum, __func__);\r\nreturn value;\r\n}\r\nif (rateIndex >= TX_PWR_BY_RATE_NUM_RATE) {\r\nDBG_871X("Invalid RateIndex %d in %s\n", rateIndex, __func__);\r\nreturn value;\r\n}\r\nvalue = pHalData->TxPwrByRateOffset[Band][RFPath][TxNum][rateIndex];\r\nreturn value;\r\n}\r\nvoid PHY_SetTxPowerByRate(\r\nstruct adapter *padapter,\r\nu8 Band,\r\nu8 RFPath,\r\nu8 TxNum,\r\nu8 Rate,\r\ns8 Value\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 rateIndex = PHY_GetRateIndexOfTxPowerByRate(Rate);\r\nif (Band != BAND_ON_2_4G && Band != BAND_ON_5G) {\r\nDBG_871X("Invalid band %d in %s\n", Band, __func__);\r\nreturn;\r\n}\r\nif (RFPath > ODM_RF_PATH_D) {\r\nDBG_871X("Invalid RfPath %d in %s\n", RFPath, __func__);\r\nreturn;\r\n}\r\nif (TxNum >= RF_MAX_TX_NUM) {\r\nDBG_871X("Invalid TxNum %d in %s\n", TxNum, __func__);\r\nreturn;\r\n}\r\nif (rateIndex >= TX_PWR_BY_RATE_NUM_RATE) {\r\nDBG_871X("Invalid RateIndex %d in %s\n", rateIndex, __func__);\r\nreturn;\r\n}\r\npHalData->TxPwrByRateOffset[Band][RFPath][TxNum][rateIndex] = Value;\r\n}\r\nvoid PHY_SetTxPowerLevelByPath(struct adapter *Adapter, u8 channel, u8 path)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nbool bIsIn24G = (pHalData->CurrentBandType == BAND_ON_2_4G);\r\n{\r\nif (bIsIn24G)\r\nPHY_SetTxPowerIndexByRateSection(Adapter, path, channel, CCK);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, path, channel, OFDM);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, path, channel, HT_MCS0_MCS7);\r\nif (pHalData->NumTotalRFPath >= 2)\r\nPHY_SetTxPowerIndexByRateSection(Adapter, path, channel, HT_MCS8_MCS15);\r\n}\r\n}\r\nvoid PHY_SetTxPowerIndexByRateArray(\r\nstruct adapter *padapter,\r\nu8 RFPath,\r\nenum CHANNEL_WIDTH BandWidth,\r\nu8 Channel,\r\nu8 *Rates,\r\nu8 RateArraySize\r\n)\r\n{\r\nu32 powerIndex = 0;\r\nint i = 0;\r\nfor (i = 0; i < RateArraySize; ++i) {\r\npowerIndex = PHY_GetTxPowerIndex(padapter, RFPath, Rates[i], BandWidth, Channel);\r\nPHY_SetTxPowerIndex(padapter, powerIndex, RFPath, Rates[i]);\r\n}\r\n}\r\nstatic s8 phy_GetWorldWideLimit(s8 *LimitTable)\r\n{\r\ns8 min = LimitTable[0];\r\nu8 i = 0;\r\nfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\r\nif (LimitTable[i] < min)\r\nmin = LimitTable[i];\r\n}\r\nreturn min;\r\n}\r\nstatic s8 phy_GetChannelIndexOfTxPowerLimit(u8 Band, u8 Channel)\r\n{\r\ns8 channelIndex = -1;\r\nu8 channel5G[CHANNEL_MAX_NUMBER_5G] = {\r\n36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 100, 102,\r\n104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130,\r\n132, 134, 136, 138, 140, 142, 144, 149, 151, 153, 155, 157, 159, 161,\r\n163, 165, 167, 168, 169, 171, 173, 175, 177\r\n};\r\nu8 i = 0;\r\nif (Band == BAND_ON_2_4G)\r\nchannelIndex = Channel - 1;\r\nelse if (Band == BAND_ON_5G) {\r\nfor (i = 0; i < sizeof(channel5G)/sizeof(u8); ++i) {\r\nif (channel5G[i] == Channel)\r\nchannelIndex = i;\r\n}\r\n} else\r\nDBG_871X("Invalid Band %d in %s", Band, __func__);\r\nif (channelIndex == -1)\r\nDBG_871X("Invalid Channel %d of Band %d in %s", Channel, Band, __func__);\r\nreturn channelIndex;\r\n}\r\ns8 PHY_GetTxPowerLimit(\r\nstruct adapter *Adapter,\r\nu32 RegPwrTblSel,\r\nenum BAND_TYPE Band,\r\nenum CHANNEL_WIDTH Bandwidth,\r\nu8 RfPath,\r\nu8 DataRate,\r\nu8 Channel\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\ns16 band = -1, regulation = -1, bandwidth = -1, rateSection = -1, channel = -1;\r\ns8 powerLimit = MAX_POWER_INDEX;\r\nif ((Adapter->registrypriv.RegEnableTxPowerLimit == 2 && pHalData->EEPROMRegulatory != 1) ||\r\nAdapter->registrypriv.RegEnableTxPowerLimit == 0)\r\nreturn MAX_POWER_INDEX;\r\nswitch (Adapter->registrypriv.RegPwrTblSel) {\r\ncase 1:\r\nregulation = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase 2:\r\nregulation = TXPWR_LMT_MKK;\r\nbreak;\r\ncase 3:\r\nregulation = TXPWR_LMT_FCC;\r\nbreak;\r\ncase 4:\r\nregulation = TXPWR_LMT_WW;\r\nbreak;\r\ndefault:\r\nregulation = (Band == BAND_ON_2_4G) ? pHalData->Regulation2_4G : pHalData->Regulation5G;\r\nbreak;\r\n}\r\nif (Band == BAND_ON_2_4G)\r\nband = 0;\r\nelse if (Band == BAND_ON_5G)\r\nband = 1;\r\nif (Bandwidth == CHANNEL_WIDTH_20)\r\nbandwidth = 0;\r\nelse if (Bandwidth == CHANNEL_WIDTH_40)\r\nbandwidth = 1;\r\nelse if (Bandwidth == CHANNEL_WIDTH_80)\r\nbandwidth = 2;\r\nelse if (Bandwidth == CHANNEL_WIDTH_160)\r\nbandwidth = 3;\r\nswitch (DataRate) {\r\ncase MGN_1M: case MGN_2M: case MGN_5_5M: case MGN_11M:\r\nrateSection = 0;\r\nbreak;\r\ncase MGN_6M: case MGN_9M: case MGN_12M: case MGN_18M:\r\ncase MGN_24M: case MGN_36M: case MGN_48M: case MGN_54M:\r\nrateSection = 1;\r\nbreak;\r\ncase MGN_MCS0: case MGN_MCS1: case MGN_MCS2: case MGN_MCS3:\r\ncase MGN_MCS4: case MGN_MCS5: case MGN_MCS6: case MGN_MCS7:\r\nrateSection = 2;\r\nbreak;\r\ncase MGN_MCS8: case MGN_MCS9: case MGN_MCS10: case MGN_MCS11:\r\ncase MGN_MCS12: case MGN_MCS13: case MGN_MCS14: case MGN_MCS15:\r\nrateSection = 3;\r\nbreak;\r\ncase MGN_MCS16: case MGN_MCS17: case MGN_MCS18: case MGN_MCS19:\r\ncase MGN_MCS20: case MGN_MCS21: case MGN_MCS22: case MGN_MCS23:\r\nrateSection = 4;\r\nbreak;\r\ncase MGN_MCS24: case MGN_MCS25: case MGN_MCS26: case MGN_MCS27:\r\ncase MGN_MCS28: case MGN_MCS29: case MGN_MCS30: case MGN_MCS31:\r\nrateSection = 5;\r\nbreak;\r\ncase MGN_VHT1SS_MCS0: case MGN_VHT1SS_MCS1: case MGN_VHT1SS_MCS2:\r\ncase MGN_VHT1SS_MCS3: case MGN_VHT1SS_MCS4: case MGN_VHT1SS_MCS5:\r\ncase MGN_VHT1SS_MCS6: case MGN_VHT1SS_MCS7: case MGN_VHT1SS_MCS8:\r\ncase MGN_VHT1SS_MCS9:\r\nrateSection = 6;\r\nbreak;\r\ncase MGN_VHT2SS_MCS0: case MGN_VHT2SS_MCS1: case MGN_VHT2SS_MCS2:\r\ncase MGN_VHT2SS_MCS3: case MGN_VHT2SS_MCS4: case MGN_VHT2SS_MCS5:\r\ncase MGN_VHT2SS_MCS6: case MGN_VHT2SS_MCS7: case MGN_VHT2SS_MCS8:\r\ncase MGN_VHT2SS_MCS9:\r\nrateSection = 7;\r\nbreak;\r\ncase MGN_VHT3SS_MCS0: case MGN_VHT3SS_MCS1: case MGN_VHT3SS_MCS2:\r\ncase MGN_VHT3SS_MCS3: case MGN_VHT3SS_MCS4: case MGN_VHT3SS_MCS5:\r\ncase MGN_VHT3SS_MCS6: case MGN_VHT3SS_MCS7: case MGN_VHT3SS_MCS8:\r\ncase MGN_VHT3SS_MCS9:\r\nrateSection = 8;\r\nbreak;\r\ncase MGN_VHT4SS_MCS0: case MGN_VHT4SS_MCS1: case MGN_VHT4SS_MCS2:\r\ncase MGN_VHT4SS_MCS3: case MGN_VHT4SS_MCS4: case MGN_VHT4SS_MCS5:\r\ncase MGN_VHT4SS_MCS6: case MGN_VHT4SS_MCS7: case MGN_VHT4SS_MCS8:\r\ncase MGN_VHT4SS_MCS9:\r\nrateSection = 9;\r\nbreak;\r\ndefault:\r\nDBG_871X("Wrong rate 0x%x\n", DataRate);\r\nbreak;\r\n}\r\nif (Band == BAND_ON_5G && rateSection == 0)\r\nDBG_871X("Wrong rate 0x%x: No CCK in 5G Band\n", DataRate);\r\nif (rateSection == 1)\r\nbandwidth = 0;\r\nif (rateSection == 0)\r\nbandwidth = 0;\r\nif ((rateSection == 2 || rateSection == 3) && Band == BAND_ON_5G && bandwidth == 2) {\r\nbandwidth = 1;\r\n}\r\nif (Band == BAND_ON_2_4G)\r\nchannel = phy_GetChannelIndexOfTxPowerLimit(BAND_ON_2_4G, Channel);\r\nelse if (Band == BAND_ON_5G)\r\nchannel = phy_GetChannelIndexOfTxPowerLimit(BAND_ON_5G, Channel);\r\nelse if (Band == BAND_ON_BOTH) {\r\n}\r\nif (band == -1 || regulation == -1 || bandwidth == -1 ||\r\nrateSection == -1 || channel == -1) {\r\nreturn MAX_POWER_INDEX;\r\n}\r\nif (Band == BAND_ON_2_4G) {\r\ns8 limits[10] = {0}; u8 i = 0;\r\nfor (i = 0; i < MAX_REGULATION_NUM; i++)\r\nlimits[i] = pHalData->TxPwrLimit_2_4G[i][bandwidth][rateSection][channel][RfPath];\r\npowerLimit = (regulation == TXPWR_LMT_WW) ? phy_GetWorldWideLimit(limits) :\r\npHalData->TxPwrLimit_2_4G[regulation][bandwidth][rateSection][channel][RfPath];\r\n} else if (Band == BAND_ON_5G) {\r\ns8 limits[10] = {0}; u8 i = 0;\r\nfor (i = 0; i < MAX_REGULATION_NUM; ++i)\r\nlimits[i] = pHalData->TxPwrLimit_5G[i][bandwidth][rateSection][channel][RfPath];\r\npowerLimit = (regulation == TXPWR_LMT_WW) ? phy_GetWorldWideLimit(limits) :\r\npHalData->TxPwrLimit_5G[regulation][bandwidth][rateSection][channel][RfPath];\r\n} else\r\nDBG_871X("No power limit table of the specified band\n");\r\nreturn powerLimit;\r\n}\r\nstatic void phy_CrossReferenceHTAndVHTTxPowerLimit(struct adapter *padapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 regulation, bw, channel, rateSection;\r\ns8 tempPwrLmt = 0;\r\nfor (regulation = 0; regulation < MAX_REGULATION_NUM; ++regulation) {\r\nfor (bw = 0; bw < MAX_5G_BANDWITH_NUM; ++bw) {\r\nfor (channel = 0; channel < CHANNEL_MAX_NUMBER_5G; ++channel) {\r\nfor (rateSection = 0; rateSection < MAX_RATE_SECTION_NUM; ++rateSection) {\r\ntempPwrLmt = pHalData->TxPwrLimit_5G[regulation][bw][rateSection][channel][ODM_RF_PATH_A];\r\nif (tempPwrLmt == MAX_POWER_INDEX) {\r\nu8 baseSection = 2, refSection = 6;\r\nif (bw == 0 || bw == 1) {\r\nif (rateSection >= 2 && rateSection <= 9) {\r\nif (rateSection == 2) {\r\nbaseSection = 2;\r\nrefSection = 6;\r\n} else if (rateSection == 3) {\r\nbaseSection = 3;\r\nrefSection = 7;\r\n} else if (rateSection == 4) {\r\nbaseSection = 4;\r\nrefSection = 8;\r\n} else if (rateSection == 5) {\r\nbaseSection = 5;\r\nrefSection = 9;\r\n} else if (rateSection == 6) {\r\nbaseSection = 6;\r\nrefSection = 2;\r\n} else if (rateSection == 7) {\r\nbaseSection = 7;\r\nrefSection = 3;\r\n} else if (rateSection == 8) {\r\nbaseSection = 8;\r\nrefSection = 4;\r\n} else if (rateSection == 9) {\r\nbaseSection = 9;\r\nrefSection = 5;\r\n}\r\npHalData->TxPwrLimit_5G[regulation][bw][baseSection][channel][ODM_RF_PATH_A] =\r\npHalData->TxPwrLimit_5G[regulation][bw][refSection][channel][ODM_RF_PATH_A];\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid PHY_ConvertTxPowerLimitToPowerIndex(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 BW40PwrBasedBm2_4G = 0x2E;\r\nu8 regulation, bw, channel, rateSection;\r\ns8 tempValue = 0, tempPwrLmt = 0;\r\nu8 rfPath = 0;\r\nphy_CrossReferenceHTAndVHTTxPowerLimit(Adapter);\r\nfor (regulation = 0; regulation < MAX_REGULATION_NUM; ++regulation) {\r\nfor (bw = 0; bw < MAX_2_4G_BANDWITH_NUM; ++bw) {\r\nfor (channel = 0; channel < CHANNEL_MAX_NUMBER_2G; ++channel) {\r\nfor (rateSection = 0; rateSection < MAX_RATE_SECTION_NUM; ++rateSection) {\r\ntempPwrLmt = pHalData->TxPwrLimit_2_4G[regulation][bw][rateSection][channel][ODM_RF_PATH_A];\r\nfor (rfPath = ODM_RF_PATH_A; rfPath < MAX_RF_PATH_NUM; ++rfPath) {\r\nif (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_EXACT_VALUE) {\r\nif (rateSection == 5)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_4TX, HT_MCS24_MCS31);\r\nelse if (rateSection == 4)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_3TX, HT_MCS16_MCS23);\r\nelse if (rateSection == 3)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_2TX, HT_MCS8_MCS15);\r\nelse if (rateSection == 2)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_1TX, HT_MCS0_MCS7);\r\nelse if (rateSection == 1)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_1TX, OFDM);\r\nelse if (rateSection == 0)\r\nBW40PwrBasedBm2_4G = PHY_GetTxPowerByRateBase(Adapter, BAND_ON_2_4G, rfPath, RF_1TX, CCK);\r\n} else\r\nBW40PwrBasedBm2_4G = Adapter->registrypriv.RegPowerBase * 2;\r\nif (tempPwrLmt != MAX_POWER_INDEX) {\r\ntempValue = tempPwrLmt - BW40PwrBasedBm2_4G;\r\npHalData->TxPwrLimit_2_4G[regulation][bw][rateSection][channel][rfPath] = tempValue;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid PHY_InitTxPowerLimit(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 i, j, k, l, m;\r\nfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\r\nfor (j = 0; j < MAX_2_4G_BANDWITH_NUM; ++j)\r\nfor (k = 0; k < MAX_RATE_SECTION_NUM; ++k)\r\nfor (m = 0; m < CHANNEL_MAX_NUMBER_2G; ++m)\r\nfor (l = 0; l < MAX_RF_PATH_NUM; ++l)\r\npHalData->TxPwrLimit_2_4G[i][j][k][m][l] = MAX_POWER_INDEX;\r\n}\r\nfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\r\nfor (j = 0; j < MAX_5G_BANDWITH_NUM; ++j)\r\nfor (k = 0; k < MAX_RATE_SECTION_NUM; ++k)\r\nfor (m = 0; m < CHANNEL_MAX_NUMBER_5G; ++m)\r\nfor (l = 0; l < MAX_RF_PATH_NUM; ++l)\r\npHalData->TxPwrLimit_5G[i][j][k][m][l] = MAX_POWER_INDEX;\r\n}\r\n}\r\nvoid PHY_SetTxPowerLimit(\r\nstruct adapter *Adapter,\r\nu8 *Regulation,\r\nu8 *Band,\r\nu8 *Bandwidth,\r\nu8 *RateSection,\r\nu8 *RfPath,\r\nu8 *Channel,\r\nu8 *PowerLimit\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 regulation = 0, bandwidth = 0, rateSection = 0, channel;\r\ns8 powerLimit = 0, prevPowerLimit, channelIndex;\r\nif (!GetU1ByteIntegerFromStringInDecimal((s8 *)Channel, &channel) ||\r\n!GetU1ByteIntegerFromStringInDecimal((s8 *)PowerLimit, &powerLimit))\r\nDBG_871X("Illegal index of power limit table [chnl %s][val %s]\n", Channel, PowerLimit);\r\npowerLimit = powerLimit > MAX_POWER_INDEX ? MAX_POWER_INDEX : powerLimit;\r\nif (eqNByte(Regulation, (u8 *)("FCC"), 3))\r\nregulation = 0;\r\nelse if (eqNByte(Regulation, (u8 *)("MKK"), 3))\r\nregulation = 1;\r\nelse if (eqNByte(Regulation, (u8 *)("ETSI"), 4))\r\nregulation = 2;\r\nelse if (eqNByte(Regulation, (u8 *)("WW13"), 4))\r\nregulation = 3;\r\nif (eqNByte(RateSection, (u8 *)("CCK"), 3) && eqNByte(RfPath, (u8 *)("1T"), 2))\r\nrateSection = 0;\r\nelse if (eqNByte(RateSection, (u8 *)("OFDM"), 4) && eqNByte(RfPath, (u8 *)("1T"), 2))\r\nrateSection = 1;\r\nelse if (eqNByte(RateSection, (u8 *)("HT"), 2) && eqNByte(RfPath, (u8 *)("1T"), 2))\r\nrateSection = 2;\r\nelse if (eqNByte(RateSection, (u8 *)("HT"), 2) && eqNByte(RfPath, (u8 *)("2T"), 2))\r\nrateSection = 3;\r\nelse if (eqNByte(RateSection, (u8 *)("HT"), 2) && eqNByte(RfPath, (u8 *)("3T"), 2))\r\nrateSection = 4;\r\nelse if (eqNByte(RateSection, (u8 *)("HT"), 2) && eqNByte(RfPath, (u8 *)("4T"), 2))\r\nrateSection = 5;\r\nelse if (eqNByte(RateSection, (u8 *)("VHT"), 3) && eqNByte(RfPath, (u8 *)("1T"), 2))\r\nrateSection = 6;\r\nelse if (eqNByte(RateSection, (u8 *)("VHT"), 3) && eqNByte(RfPath, (u8 *)("2T"), 2))\r\nrateSection = 7;\r\nelse if (eqNByte(RateSection, (u8 *)("VHT"), 3) && eqNByte(RfPath, (u8 *)("3T"), 2))\r\nrateSection = 8;\r\nelse if (eqNByte(RateSection, (u8 *)("VHT"), 3) && eqNByte(RfPath, (u8 *)("4T"), 2))\r\nrateSection = 9;\r\nelse {\r\nDBG_871X("Wrong rate section!\n");\r\nreturn;\r\n}\r\nif (eqNByte(Bandwidth, (u8 *)("20M"), 3))\r\nbandwidth = 0;\r\nelse if (eqNByte(Bandwidth, (u8 *)("40M"), 3))\r\nbandwidth = 1;\r\nelse if (eqNByte(Bandwidth, (u8 *)("80M"), 3))\r\nbandwidth = 2;\r\nelse if (eqNByte(Bandwidth, (u8 *)("160M"), 4))\r\nbandwidth = 3;\r\nif (eqNByte(Band, (u8 *)("2.4G"), 4)) {\r\nchannelIndex = phy_GetChannelIndexOfTxPowerLimit(BAND_ON_2_4G, channel);\r\nif (channelIndex == -1)\r\nreturn;\r\nprevPowerLimit = pHalData->TxPwrLimit_2_4G[regulation][bandwidth][rateSection][channelIndex][ODM_RF_PATH_A];\r\nif (powerLimit < prevPowerLimit)\r\npHalData->TxPwrLimit_2_4G[regulation][bandwidth][rateSection][channelIndex][ODM_RF_PATH_A] = powerLimit;\r\n} else if (eqNByte(Band, (u8 *)("5G"), 2)) {\r\nchannelIndex = phy_GetChannelIndexOfTxPowerLimit(BAND_ON_5G, channel);\r\nif (channelIndex == -1)\r\nreturn;\r\nprevPowerLimit = pHalData->TxPwrLimit_5G[regulation][bandwidth][rateSection][channelIndex][ODM_RF_PATH_A];\r\nif (powerLimit < prevPowerLimit)\r\npHalData->TxPwrLimit_5G[regulation][bandwidth][rateSection][channelIndex][ODM_RF_PATH_A] = powerLimit;\r\n} else {\r\nDBG_871X("Cannot recognize the band info in %s\n", Band);\r\nreturn;\r\n}\r\n}\r\nu8 PHY_GetTxPowerIndex(\r\nstruct adapter *padapter,\r\nu8 RFPath,\r\nu8 Rate,\r\nenum CHANNEL_WIDTH BandWidth,\r\nu8 Channel\r\n)\r\n{\r\nreturn PHY_GetTxPowerIndex_8723B(padapter, RFPath, Rate, BandWidth, Channel);\r\n}\r\nvoid PHY_SetTxPowerIndex(\r\nstruct adapter *padapter, u32 PowerIndex, u8 RFPath, u8 Rate\r\n)\r\n{\r\nPHY_SetTxPowerIndex_8723B(padapter, PowerIndex, RFPath, Rate);\r\n}\r\nvoid Hal_ChannelPlanToRegulation(struct adapter *Adapter, u16 ChannelPlan)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\npHalData->Regulation2_4G = TXPWR_LMT_WW;\r\npHalData->Regulation5G = TXPWR_LMT_WW;\r\nswitch (ChannelPlan) {\r\ncase RT_CHANNEL_DOMAIN_WORLD_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_WW;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_ETSI1_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_MKK1_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_MKK;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_ETSI2_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC1:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI1:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_MKK1_MKK1:\r\npHalData->Regulation2_4G = TXPWR_LMT_MKK;\r\npHalData->Regulation5G = TXPWR_LMT_MKK;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_KCC1:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_MKK;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_FCC2:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_FCC3:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_FCC4:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_FCC5:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_FCC6:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC7:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI2:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI3:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_MKK1_MKK2:\r\npHalData->Regulation2_4G = TXPWR_LMT_MKK;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_MKK1_MKK3:\r\npHalData->Regulation2_4G = TXPWR_LMT_MKK;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_NCC1:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_NCC2:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_GLOBAL_NULL:\r\npHalData->Regulation2_4G = TXPWR_LMT_WW;\r\npHalData->Regulation5G = TXPWR_LMT_WW;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_ETSI1_ETSI4:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC2:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_NCC3:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI5:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC8:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI6:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI7:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI8:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI9:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI10:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI11:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_NCC4:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI12:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC9:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_WORLD_ETSI13:\r\npHalData->Regulation2_4G = TXPWR_LMT_ETSI;\r\npHalData->Regulation5G = TXPWR_LMT_ETSI;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_FCC1_FCC10:\r\npHalData->Regulation2_4G = TXPWR_LMT_FCC;\r\npHalData->Regulation5G = TXPWR_LMT_FCC;\r\nbreak;\r\ncase RT_CHANNEL_DOMAIN_REALTEK_DEFINE:\r\npHalData->Regulation2_4G = TXPWR_LMT_WW;\r\npHalData->Regulation5G = TXPWR_LMT_WW;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint phy_ConfigMACWithParaFile(struct adapter *Adapter, char *pFileName)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nchar *szLine, *ptmp;\r\nu32 u4bRegOffset, u4bRegValue, u4bMove;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_MAC_PARA_FILE))\r\nreturn rtStatus;\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pHalData->mac_reg_len == 0) && (pHalData->mac_reg == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npHalData->mac_reg = vzalloc(rlen);\r\nif (pHalData->mac_reg) {\r\nmemcpy(pHalData->mac_reg, pHalData->para_file_buf, rlen);\r\npHalData->mac_reg_len = rlen;\r\n} else\r\nDBG_871X("%s mac_reg alloc fail !\n", __func__);\r\n}\r\n}\r\n} else {\r\nif ((pHalData->mac_reg_len != 0) && (pHalData->mac_reg != NULL)) {\r\nmemcpy(pHalData->para_file_buf, pHalData->mac_reg, pHalData->mac_reg_len);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nptmp = pHalData->para_file_buf;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (!IsCommentString(szLine)) {\r\nif (GetHexValueFromString(szLine, &u4bRegOffset, &u4bMove)) {\r\nif (u4bRegOffset == 0xffff)\r\nbreak;\r\nszLine += u4bMove;\r\nif (GetHexValueFromString(szLine, &u4bRegValue, &u4bMove))\r\nrtw_write8(Adapter, u4bRegOffset, (u8)u4bRegValue);\r\n}\r\n}\r\n}\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nint phy_ConfigBBWithParaFile(\r\nstruct adapter *Adapter, char *pFileName, u32 ConfigType\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nchar *szLine, *ptmp;\r\nu32 u4bRegOffset, u4bRegValue, u4bMove;\r\nchar *pBuf = NULL;\r\nu32 *pBufLen = NULL;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_BB_PARA_FILE))\r\nreturn rtStatus;\r\nswitch (ConfigType) {\r\ncase CONFIG_BB_PHY_REG:\r\npBuf = pHalData->bb_phy_reg;\r\npBufLen = &pHalData->bb_phy_reg_len;\r\nbreak;\r\ncase CONFIG_BB_AGC_TAB:\r\npBuf = pHalData->bb_agc_tab;\r\npBufLen = &pHalData->bb_agc_tab_len;\r\nbreak;\r\ndefault:\r\nDBG_871X("Unknown ConfigType!! %d\r\n", ConfigType);\r\nbreak;\r\n}\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pBufLen != NULL) && (*pBufLen == 0) && (pBuf == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npBuf = vzalloc(rlen);\r\nif (pBuf) {\r\nmemcpy(pBuf, pHalData->para_file_buf, rlen);\r\n*pBufLen = rlen;\r\nswitch (ConfigType) {\r\ncase CONFIG_BB_PHY_REG:\r\npHalData->bb_phy_reg = pBuf;\r\nbreak;\r\ncase CONFIG_BB_AGC_TAB:\r\npHalData->bb_agc_tab = pBuf;\r\nbreak;\r\n}\r\n} else\r\nDBG_871X("%s(): ConfigType %d alloc fail !\n", __func__, ConfigType);\r\n}\r\n}\r\n} else {\r\nif ((pBufLen != NULL) && (*pBufLen == 0) && (pBuf == NULL)) {\r\nmemcpy(pHalData->para_file_buf, pBuf, *pBufLen);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nptmp = pHalData->para_file_buf;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (!IsCommentString(szLine)) {\r\nif (GetHexValueFromString(szLine, &u4bRegOffset, &u4bMove)) {\r\nif (u4bRegOffset == 0xffff)\r\nbreak;\r\nelse if (u4bRegOffset == 0xfe || u4bRegOffset == 0xffe)\r\nmsleep(50);\r\nelse if (u4bRegOffset == 0xfd)\r\nmdelay(5);\r\nelse if (u4bRegOffset == 0xfc)\r\nmdelay(1);\r\nelse if (u4bRegOffset == 0xfb)\r\nudelay(50);\r\nelse if (u4bRegOffset == 0xfa)\r\nudelay(5);\r\nelse if (u4bRegOffset == 0xf9)\r\nudelay(1);\r\nszLine += u4bMove;\r\nif (GetHexValueFromString(szLine, &u4bRegValue, &u4bMove)) {\r\nPHY_SetBBReg(Adapter, u4bRegOffset, bMaskDWord, u4bRegValue);\r\nif (u4bRegOffset == 0xa24)\r\npHalData->odmpriv.RFCalibrateInfo.RegA24 = u4bRegValue;\r\nudelay(1);\r\n}\r\n}\r\n}\r\n}\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nstatic void phy_DecryptBBPgParaFile(struct adapter *Adapter, char *buffer)\r\n{\r\nu32 i = 0, j = 0;\r\nu8 map[95] = {0};\r\nu8 currentChar;\r\nchar *BufOfLines, *ptmp;\r\nfor (i = 0; i < 95; ++i)\r\nmap[i] = (u8) (94 - i);\r\nptmp = buffer;\r\ni = 0;\r\nfor (BufOfLines = GetLineFromBuffer(ptmp); BufOfLines != NULL; BufOfLines = GetLineFromBuffer(ptmp)) {\r\nfor (j = 0; j < strlen(BufOfLines); ++j) {\r\ncurrentChar = BufOfLines[j];\r\nif (currentChar == '\0')\r\nbreak;\r\ncurrentChar -= (u8) ((((i + j) * 3) % 128));\r\nBufOfLines[j] = map[currentChar - 32] + 32;\r\n}\r\nif (strlen(BufOfLines) != 0)\r\ni++;\r\nBufOfLines[strlen(BufOfLines)] = '\n';\r\n}\r\n}\r\nstatic int phy_ParseBBPgParaFile(struct adapter *Adapter, char *buffer)\r\n{\r\nint rtStatus = _SUCCESS;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nchar *szLine, *ptmp;\r\nu32 u4bRegOffset, u4bRegMask, u4bRegValue;\r\nu32 u4bMove;\r\nbool firstLine = true;\r\nu8 tx_num = 0;\r\nu8 band = 0, rf_path = 0;\r\nif (Adapter->registrypriv.RegDecryptCustomFile == 1)\r\nphy_DecryptBBPgParaFile(Adapter, buffer);\r\nptmp = buffer;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (!IsCommentString(szLine)) {\r\nif (isAllSpaceOrTab(szLine, sizeof(*szLine)))\r\ncontinue;\r\nif (firstLine) {\r\nif (eqNByte(szLine, (u8 *)("#[v1]"), 5)) {\r\npHalData->odmpriv.PhyRegPgVersion = szLine[3] - '0';\r\n} else if (eqNByte(szLine, (u8 *)("#[v0]"), 5)) {\r\npHalData->odmpriv.PhyRegPgVersion = szLine[3] - '0';\r\n} else {\r\nDBG_871X("The format in PHY_REG_PG are invalid %s\n", szLine);\r\nreturn _FAIL;\r\n}\r\nif (eqNByte(szLine + 5, (u8 *)("[Exact]#"), 8)) {\r\npHalData->odmpriv.PhyRegPgValueType = PHY_REG_PG_EXACT_VALUE;\r\nfirstLine = false;\r\ncontinue;\r\n} else if (eqNByte(szLine + 5, (u8 *)("[Relative]#"), 11)) {\r\npHalData->odmpriv.PhyRegPgValueType = PHY_REG_PG_RELATIVE_VALUE;\r\nfirstLine = false;\r\ncontinue;\r\n} else {\r\nDBG_871X("The values in PHY_REG_PG are invalid %s\n", szLine);\r\nreturn _FAIL;\r\n}\r\n}\r\nif (pHalData->odmpriv.PhyRegPgVersion == 0) {\r\nif (GetHexValueFromString(szLine, &u4bRegOffset, &u4bMove)) {\r\nszLine += u4bMove;\r\nif (u4bRegOffset == 0xffff)\r\nbreak;\r\nif (GetHexValueFromString(szLine, &u4bRegMask, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\nif (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_RELATIVE_VALUE) {\r\nif (GetHexValueFromString(szLine, &u4bRegValue, &u4bMove)) {\r\nPHY_StoreTxPowerByRate(Adapter, 0, 0, 1, u4bRegOffset, u4bRegMask, u4bRegValue);\r\n} else\r\nreturn _FAIL;\r\n} else if (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_EXACT_VALUE) {\r\nu32 combineValue = 0;\r\nu8 integer = 0, fraction = 0;\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nPHY_StoreTxPowerByRate(Adapter, 0, 0, 1, u4bRegOffset, u4bRegMask, combineValue);\r\n}\r\n}\r\n} else if (pHalData->odmpriv.PhyRegPgVersion > 0) {\r\nu32 index = 0;\r\nif (eqNByte(szLine, "0xffff", 6))\r\nbreak;\r\nif (!eqNByte("#[END]#", szLine, 7)) {\r\nif (szLine[0] == '#') {\r\nindex = 0;\r\nif (eqNByte(szLine, "#[2.4G]", 7)) {\r\nband = BAND_ON_2_4G;\r\nindex += 8;\r\n} else if (eqNByte(szLine, "#[5G]", 5)) {\r\nband = BAND_ON_5G;\r\nindex += 6;\r\n} else {\r\nDBG_871X("Invalid band %s in PHY_REG_PG.txt\n", szLine);\r\nreturn _FAIL;\r\n}\r\nrf_path = szLine[index] - 'A';\r\n} else {\r\nif (szLine[1] == '1')\r\ntx_num = RF_1TX;\r\nelse if (szLine[1] == '2')\r\ntx_num = RF_2TX;\r\nelse if (szLine[1] == '3')\r\ntx_num = RF_3TX;\r\nelse if (szLine[1] == '4')\r\ntx_num = RF_4TX;\r\nelse {\r\nDBG_871X("Invalid row in PHY_REG_PG.txt %c\n", szLine[1]);\r\nreturn _FAIL;\r\n}\r\nwhile (szLine[index] != ']')\r\n++index;\r\n++index;\r\nszLine += index;\r\nif (GetHexValueFromString(szLine, &u4bRegOffset, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\nif (GetHexValueFromString(szLine, &u4bRegMask, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\nif (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_RELATIVE_VALUE) {\r\nif (GetHexValueFromString(szLine, &u4bRegValue, &u4bMove)) {\r\nPHY_StoreTxPowerByRate(Adapter, band, rf_path, tx_num, u4bRegOffset, u4bRegMask, u4bRegValue);\r\n} else\r\nreturn _FAIL;\r\n} else if (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_EXACT_VALUE) {\r\nu32 combineValue = 0;\r\nu8 integer = 0, fraction = 0;\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nif (GetFractionValueFromString(szLine, &integer, &fraction, &u4bMove))\r\nszLine += u4bMove;\r\nelse\r\nreturn _FAIL;\r\ninteger *= 2;\r\nif (fraction == 5)\r\ninteger += 1;\r\ncombineValue <<= 8;\r\ncombineValue |= (((integer / 10) << 4) + (integer % 10));\r\nPHY_StoreTxPowerByRate(Adapter, band, rf_path, tx_num, u4bRegOffset, u4bRegMask, combineValue);\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nreturn rtStatus;\r\n}\r\nint phy_ConfigBBWithPgParaFile(struct adapter *Adapter, char *pFileName)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_BB_PG_PARA_FILE))\r\nreturn rtStatus;\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pHalData->bb_phy_reg_pg_len == 0) && (pHalData->bb_phy_reg_pg == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npHalData->bb_phy_reg_pg = vzalloc(rlen);\r\nif (pHalData->bb_phy_reg_pg) {\r\nmemcpy(pHalData->bb_phy_reg_pg, pHalData->para_file_buf, rlen);\r\npHalData->bb_phy_reg_pg_len = rlen;\r\n} else\r\nDBG_871X("%s bb_phy_reg_pg alloc fail !\n", __func__);\r\n}\r\n}\r\n} else {\r\nif ((pHalData->bb_phy_reg_pg_len != 0) && (pHalData->bb_phy_reg_pg != NULL)) {\r\nmemcpy(pHalData->para_file_buf, pHalData->bb_phy_reg_pg, pHalData->bb_phy_reg_pg_len);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nphy_ParseBBPgParaFile(Adapter, pHalData->para_file_buf);\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nint PHY_ConfigRFWithParaFile(\r\nstruct adapter *Adapter, char *pFileName, u8 eRFPath\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nchar *szLine, *ptmp;\r\nu32 u4bRegOffset, u4bRegValue, u4bMove;\r\nu16 i;\r\nchar *pBuf = NULL;\r\nu32 *pBufLen = NULL;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_RF_PARA_FILE))\r\nreturn rtStatus;\r\nswitch (eRFPath) {\r\ncase ODM_RF_PATH_A:\r\npBuf = pHalData->rf_radio_a;\r\npBufLen = &pHalData->rf_radio_a_len;\r\nbreak;\r\ncase ODM_RF_PATH_B:\r\npBuf = pHalData->rf_radio_b;\r\npBufLen = &pHalData->rf_radio_b_len;\r\nbreak;\r\ndefault:\r\nDBG_871X("Unknown RF path!! %d\r\n", eRFPath);\r\nbreak;\r\n}\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pBufLen != NULL) && (*pBufLen == 0) && (pBuf == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npBuf = vzalloc(rlen);\r\nif (pBuf) {\r\nmemcpy(pBuf, pHalData->para_file_buf, rlen);\r\n*pBufLen = rlen;\r\nswitch (eRFPath) {\r\ncase ODM_RF_PATH_A:\r\npHalData->rf_radio_a = pBuf;\r\nbreak;\r\ncase ODM_RF_PATH_B:\r\npHalData->rf_radio_b = pBuf;\r\nbreak;\r\n}\r\n} else\r\nDBG_871X("%s(): eRFPath =%d alloc fail !\n", __func__, eRFPath);\r\n}\r\n}\r\n} else {\r\nif ((pBufLen != NULL) && (*pBufLen == 0) && (pBuf == NULL)) {\r\nmemcpy(pHalData->para_file_buf, pBuf, *pBufLen);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nptmp = pHalData->para_file_buf;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (!IsCommentString(szLine)) {\r\nif (GetHexValueFromString(szLine, &u4bRegOffset, &u4bMove)) {\r\nif (u4bRegOffset == 0xfe || u4bRegOffset == 0xffe)\r\nmsleep(50);\r\nelse if (u4bRegOffset == 0xfd) {\r\nfor (i = 0; i < 100; i++)\r\nudelay(MAX_STALL_TIME);\r\n} else if (u4bRegOffset == 0xfc) {\r\nfor (i = 0; i < 20; i++)\r\nudelay(MAX_STALL_TIME);\r\n} else if (u4bRegOffset == 0xfb)\r\nudelay(50);\r\nelse if (u4bRegOffset == 0xfa)\r\nudelay(5);\r\nelse if (u4bRegOffset == 0xf9)\r\nudelay(1);\r\nelse if (u4bRegOffset == 0xffff)\r\nbreak;\r\nszLine += u4bMove;\r\nif (GetHexValueFromString(szLine, &u4bRegValue, &u4bMove)) {\r\nPHY_SetRFReg(Adapter, eRFPath, u4bRegOffset, bRFRegOffsetMask, u4bRegValue);\r\nudelay(1);\r\n}\r\n}\r\n}\r\n}\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nstatic void initDeltaSwingIndexTables(\r\nstruct adapter *Adapter,\r\nchar *Band,\r\nchar *Path,\r\nchar *Sign,\r\nchar *Channel,\r\nchar *Rate,\r\nchar *Data\r\n)\r\n{\r\n#define STR_EQUAL_5G(_band, _path, _sign, _rate, _chnl) \\r\n((strcmp(Band, _band) == 0) && (strcmp(Path, _path) == 0) && (strcmp(Sign, _sign) == 0) &&\\r\n(strcmp(Rate, _rate) == 0) && (strcmp(Channel, _chnl) == 0)\\r\n)\r\n#define STR_EQUAL_2G(_band, _path, _sign, _rate) \\r\n((strcmp(Band, _band) == 0) && (strcmp(Path, _path) == 0) && (strcmp(Sign, _sign) == 0) &&\\r\n(strcmp(Rate, _rate) == 0)\\r\n)\r\n#define STORE_SWING_TABLE(_array, _iteratedIdx) \\r\nfor (token = strsep(&Data, delim); token != NULL; token = strsep(&Data, delim)) {\\r\nsscanf(token, "%d", &idx);\\r\n_array[_iteratedIdx++] = (u8)idx;\\r\n} \\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\nu32 j = 0;\r\nchar *token;\r\nchar delim[] = ",";\r\nu32 idx = 0;\r\nif (STR_EQUAL_2G("2G", "A", "+", "CCK")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKA_P, j);\r\n} else if (STR_EQUAL_2G("2G", "A", "-", "CCK")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKA_N, j);\r\n} else if (STR_EQUAL_2G("2G", "B", "+", "CCK")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKB_P, j);\r\n} else if (STR_EQUAL_2G("2G", "B", "-", "CCK")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKB_N, j);\r\n} else if (STR_EQUAL_2G("2G", "A", "+", "ALL")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GA_P, j);\r\n} else if (STR_EQUAL_2G("2G", "A", "-", "ALL")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GA_N, j);\r\n} else if (STR_EQUAL_2G("2G", "B", "+", "ALL")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GB_P, j);\r\n} else if (STR_EQUAL_2G("2G", "B", "-", "ALL")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_2GB_N, j);\r\n} else if (STR_EQUAL_5G("5G", "A", "+", "ALL", "0")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_P[0], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "-", "ALL", "0")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_N[0], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "+", "ALL", "0")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_P[0], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "-", "ALL", "0")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_N[0], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "+", "ALL", "1")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_P[1], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "-", "ALL", "1")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_N[1], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "+", "ALL", "1")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_P[1], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "-", "ALL", "1")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_N[1], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "+", "ALL", "2")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_P[2], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "-", "ALL", "2")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_N[2], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "+", "ALL", "2")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_P[2], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "-", "ALL", "2")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_N[2], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "+", "ALL", "3")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_P[3], j);\r\n} else if (STR_EQUAL_5G("5G", "A", "-", "ALL", "3")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GA_N[3], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "+", "ALL", "3")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_P[3], j);\r\n} else if (STR_EQUAL_5G("5G", "B", "-", "ALL", "3")) {\r\nSTORE_SWING_TABLE(pRFCalibrateInfo->DeltaSwingTableIdx_5GB_N[3], j);\r\n} else\r\nDBG_871X("===>initDeltaSwingIndexTables(): The input is invalid!!\n");\r\n}\r\nint PHY_ConfigRFWithTxPwrTrackParaFile(struct adapter *Adapter, char *pFileName)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nchar *szLine, *ptmp;\r\nu32 i = 0;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_RF_TXPWR_TRACK_PARA_FILE))\r\nreturn rtStatus;\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pHalData->rf_tx_pwr_track_len == 0) && (pHalData->rf_tx_pwr_track == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npHalData->rf_tx_pwr_track = vzalloc(rlen);\r\nif (pHalData->rf_tx_pwr_track) {\r\nmemcpy(pHalData->rf_tx_pwr_track, pHalData->para_file_buf, rlen);\r\npHalData->rf_tx_pwr_track_len = rlen;\r\n} else\r\nDBG_871X("%s rf_tx_pwr_track alloc fail !\n", __func__);\r\n}\r\n}\r\n} else {\r\nif ((pHalData->rf_tx_pwr_track_len != 0) && (pHalData->rf_tx_pwr_track != NULL)) {\r\nmemcpy(pHalData->para_file_buf, pHalData->rf_tx_pwr_track, pHalData->rf_tx_pwr_track_len);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nptmp = pHalData->para_file_buf;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (!IsCommentString(szLine)) {\r\nchar band[5] = "", path[5] = "", sign[5] = "";\r\nchar chnl[5] = "", rate[10] = "";\r\nchar data[300] = "";\r\nif (strlen(szLine) < 10 || szLine[0] != '[')\r\ncontinue;\r\nstrncpy(band, szLine+1, 2);\r\nstrncpy(path, szLine+5, 1);\r\nstrncpy(sign, szLine+8, 1);\r\ni = 10;\r\nif (!ParseQualifiedString(szLine, &i, rate, '[', ']')) {\r\n}\r\nif (!ParseQualifiedString(szLine, &i, chnl, '[', ']')) {\r\n}\r\nwhile (szLine[i] != '{' && i < strlen(szLine))\r\ni++;\r\nif (!ParseQualifiedString(szLine, &i, data, '{', '}')) {\r\n}\r\ninitDeltaSwingIndexTables(Adapter, band, path, sign, chnl, rate, data);\r\n}\r\n}\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nstatic int phy_ParsePowerLimitTableFile(struct adapter *Adapter, char *buffer)\r\n{\r\nu32 i = 0, forCnt = 0;\r\nu8 loadingStage = 0, limitValue = 0, fraction = 0;\r\nchar *szLine, *ptmp;\r\nint rtStatus = _SUCCESS;\r\nchar band[10], bandwidth[10], rateSection[10],\r\nregulation[TXPWR_LMT_MAX_REGULATION_NUM][10], rfPath[10], colNumBuf[10];\r\nu8 colNum = 0;\r\nDBG_871X("===>phy_ParsePowerLimitTableFile()\n");\r\nif (Adapter->registrypriv.RegDecryptCustomFile == 1)\r\nphy_DecryptBBPgParaFile(Adapter, buffer);\r\nptmp = buffer;\r\nfor (szLine = GetLineFromBuffer(ptmp); szLine != NULL; szLine = GetLineFromBuffer(ptmp)) {\r\nif (IsCommentString(szLine)) {\r\ncontinue;\r\n}\r\nif (loadingStage == 0) {\r\nfor (forCnt = 0; forCnt < TXPWR_LMT_MAX_REGULATION_NUM; ++forCnt)\r\nmemset((void *) regulation[forCnt], 0, 10);\r\nmemset((void *) band, 0, 10);\r\nmemset((void *) bandwidth, 0, 10);\r\nmemset((void *) rateSection, 0, 10);\r\nmemset((void *) rfPath, 0, 10);\r\nmemset((void *) colNumBuf, 0, 10);\r\nif (szLine[0] != '#' || szLine[1] != '#')\r\ncontinue;\r\ni = 2;\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\nszLine[--i] = ' ';\r\nif (!ParseQualifiedString(szLine, &i, band, ' ', ',')) {\r\nDBG_871X("Fail to parse band!\n");\r\nreturn _FAIL;\r\n}\r\nif (!ParseQualifiedString(szLine, &i, bandwidth, ' ', ',')) {\r\nDBG_871X("Fail to parse bandwidth!\n");\r\nreturn _FAIL;\r\n}\r\nif (!ParseQualifiedString(szLine, &i, rfPath, ' ', ',')) {\r\nDBG_871X("Fail to parse rf path!\n");\r\nreturn _FAIL;\r\n}\r\nif (!ParseQualifiedString(szLine, &i, rateSection, ' ', ',')) {\r\nDBG_871X("Fail to parse rate!\n");\r\nreturn _FAIL;\r\n}\r\nloadingStage = 1;\r\n} else if (loadingStage == 1) {\r\nif (szLine[0] != '#' || szLine[1] != '#')\r\ncontinue;\r\ni = 2;\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\nif (!eqNByte((u8 *)(szLine + i), (u8 *)("START"), 5)) {\r\nDBG_871X("Lost \"## START\" label\n");\r\nreturn _FAIL;\r\n}\r\nloadingStage = 2;\r\n} else if (loadingStage == 2) {\r\nif (szLine[0] != '#' || szLine[1] != '#')\r\ncontinue;\r\ni = 2;\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\nif (!ParseQualifiedString(szLine, &i, colNumBuf, '#', '#')) {\r\nDBG_871X("Fail to parse column number!\n");\r\nreturn _FAIL;\r\n}\r\nif (!GetU1ByteIntegerFromStringInDecimal(colNumBuf, &colNum))\r\nreturn _FAIL;\r\nif (colNum > TXPWR_LMT_MAX_REGULATION_NUM) {\r\nDBG_871X(\r\n"unvalid col number %d (greater than max %d)\n",\r\ncolNum, TXPWR_LMT_MAX_REGULATION_NUM\r\n);\r\nreturn _FAIL;\r\n}\r\nfor (forCnt = 0; forCnt < colNum; ++forCnt) {\r\nu8 regulation_name_cnt = 0;\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\nwhile (szLine[i] != ' ' && szLine[i] != '\t' && szLine[i] != '\0')\r\nregulation[forCnt][regulation_name_cnt++] = szLine[i++];\r\nif (regulation_name_cnt == 0) {\r\nDBG_871X("unvalid number of regulation!\n");\r\nreturn _FAIL;\r\n}\r\n}\r\nloadingStage = 3;\r\n} else if (loadingStage == 3) {\r\nchar channel[10] = {0}, powerLimit[10] = {0};\r\nu8 cnt = 0;\r\nif (szLine[0] == '#' && szLine[1] == '#') {\r\ni = 2;\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\nif (eqNByte((u8 *)(szLine + i), (u8 *)("END"), 3)) {\r\nloadingStage = 0;\r\ncontinue;\r\n} else {\r\nDBG_871X("Wrong format\n");\r\nDBG_871X("<===== phy_ParsePowerLimitTableFile()\n");\r\nreturn _FAIL;\r\n}\r\n}\r\nif ((szLine[0] != 'c' && szLine[0] != 'C') ||\r\n(szLine[1] != 'h' && szLine[1] != 'H')) {\r\nDBG_871X("Meet wrong channel => power limt pair\n");\r\ncontinue;\r\n}\r\ni = 2;\r\ncnt = 0;\r\nwhile (szLine[i] >= '0' && szLine[i] <= '9') {\r\nchannel[cnt] = szLine[i];\r\n++cnt;\r\n++i;\r\n}\r\nfor (forCnt = 0; forCnt < colNum; ++forCnt) {\r\nwhile (szLine[i] == ' ' || szLine[i] == '\t')\r\n++i;\r\ncnt = 0;\r\nfraction = 0;\r\nmemset((void *) powerLimit, 0, 10);\r\nwhile ((szLine[i] >= '0' && szLine[i] <= '9') || szLine[i] == '.') {\r\nif (szLine[i] == '.') {\r\nif ((szLine[i+1] >= '0' && szLine[i+1] <= '9')) {\r\nfraction = szLine[i+1];\r\ni += 2;\r\n} else {\r\nDBG_871X("Wrong fraction in TXPWR_LMT.txt\n");\r\nreturn _FAIL;\r\n}\r\nbreak;\r\n}\r\npowerLimit[cnt] = szLine[i];\r\n++cnt;\r\n++i;\r\n}\r\nif (powerLimit[0] == '\0') {\r\npowerLimit[0] = '6';\r\npowerLimit[1] = '3';\r\ni += 2;\r\n} else {\r\nif (!GetU1ByteIntegerFromStringInDecimal(powerLimit, &limitValue))\r\nreturn _FAIL;\r\nlimitValue *= 2;\r\ncnt = 0;\r\nif (fraction == '5')\r\n++limitValue;\r\nif (limitValue >= 100) {\r\npowerLimit[cnt++] = limitValue/100 + '0';\r\nlimitValue %= 100;\r\nif (limitValue >= 10) {\r\npowerLimit[cnt++] = limitValue/10 + '0';\r\nlimitValue %= 10;\r\n} else\r\npowerLimit[cnt++] = '0';\r\npowerLimit[cnt++] = limitValue + '0';\r\n} else if (limitValue >= 10) {\r\npowerLimit[cnt++] = limitValue/10 + '0';\r\nlimitValue %= 10;\r\npowerLimit[cnt++] = limitValue + '0';\r\n}\r\nelse\r\npowerLimit[cnt++] = limitValue + '0';\r\npowerLimit[cnt] = '\0';\r\n}\r\nPHY_SetTxPowerLimit(Adapter, (u8 *)regulation[forCnt], (u8 *)band,\r\n(u8 *)bandwidth, (u8 *)rateSection, (u8 *)rfPath, (u8 *)channel, (u8 *)powerLimit);\r\n}\r\n} else {\r\nDBG_871X("Abnormal loading stage in phy_ParsePowerLimitTableFile()!\n");\r\nrtStatus = _FAIL;\r\nbreak;\r\n}\r\n}\r\nDBG_871X("<===phy_ParsePowerLimitTableFile()\n");\r\nreturn rtStatus;\r\n}\r\nint PHY_ConfigRFWithPowerLimitTableParaFile(\r\nstruct adapter *Adapter, char *pFileName\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rlen = 0, rtStatus = _FAIL;\r\nif (!(Adapter->registrypriv.load_phy_file & LOAD_RF_TXPWR_LMT_PARA_FILE))\r\nreturn rtStatus;\r\nmemset(pHalData->para_file_buf, 0, MAX_PARA_FILE_BUF_LEN);\r\nif ((pHalData->rf_tx_pwr_lmt_len == 0) && (pHalData->rf_tx_pwr_lmt == NULL)) {\r\nrtw_merge_string(file_path_bs, PATH_MAX, rtw_phy_file_path, pFileName);\r\nif (rtw_is_file_readable(file_path_bs) == true) {\r\nrlen = rtw_retrive_from_file(file_path_bs, pHalData->para_file_buf, MAX_PARA_FILE_BUF_LEN);\r\nif (rlen > 0) {\r\nrtStatus = _SUCCESS;\r\npHalData->rf_tx_pwr_lmt = vzalloc(rlen);\r\nif (pHalData->rf_tx_pwr_lmt) {\r\nmemcpy(pHalData->rf_tx_pwr_lmt, pHalData->para_file_buf, rlen);\r\npHalData->rf_tx_pwr_lmt_len = rlen;\r\n} else\r\nDBG_871X("%s rf_tx_pwr_lmt alloc fail !\n", __func__);\r\n}\r\n}\r\n} else {\r\nif ((pHalData->rf_tx_pwr_lmt_len != 0) && (pHalData->rf_tx_pwr_lmt != NULL)) {\r\nmemcpy(pHalData->para_file_buf, pHalData->rf_tx_pwr_lmt, pHalData->rf_tx_pwr_lmt_len);\r\nrtStatus = _SUCCESS;\r\n} else\r\nDBG_871X("%s(): Critical Error !!!\n", __func__);\r\n}\r\nif (rtStatus == _SUCCESS) {\r\nrtStatus = phy_ParsePowerLimitTableFile(Adapter, pHalData->para_file_buf);\r\n} else\r\nDBG_871X("%s(): No File %s, Load from HWImg Array!\n", __func__, pFileName);\r\nreturn rtStatus;\r\n}\r\nvoid phy_free_filebuf(struct adapter *padapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nif (pHalData->mac_reg)\r\nvfree(pHalData->mac_reg);\r\nif (pHalData->bb_phy_reg)\r\nvfree(pHalData->bb_phy_reg);\r\nif (pHalData->bb_agc_tab)\r\nvfree(pHalData->bb_agc_tab);\r\nif (pHalData->bb_phy_reg_pg)\r\nvfree(pHalData->bb_phy_reg_pg);\r\nif (pHalData->bb_phy_reg_mp)\r\nvfree(pHalData->bb_phy_reg_mp);\r\nif (pHalData->rf_radio_a)\r\nvfree(pHalData->rf_radio_a);\r\nif (pHalData->rf_radio_b)\r\nvfree(pHalData->rf_radio_b);\r\nif (pHalData->rf_tx_pwr_track)\r\nvfree(pHalData->rf_tx_pwr_track);\r\nif (pHalData->rf_tx_pwr_lmt)\r\nvfree(pHalData->rf_tx_pwr_lmt);\r\n}

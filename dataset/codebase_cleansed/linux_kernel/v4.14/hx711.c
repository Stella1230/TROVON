static int hx711_get_gain_to_pulse(int gain)\r\n{\r\nint i;\r\nfor (i = 0; i < HX711_GAIN_MAX; i++)\r\nif (hx711_gain_to_scale[i].gain == gain)\r\nreturn hx711_gain_to_scale[i].gain_pulse;\r\nreturn 1;\r\n}\r\nstatic int hx711_get_gain_to_scale(int gain)\r\n{\r\nint i;\r\nfor (i = 0; i < HX711_GAIN_MAX; i++)\r\nif (hx711_gain_to_scale[i].gain == gain)\r\nreturn hx711_gain_to_scale[i].scale;\r\nreturn 0;\r\n}\r\nstatic int hx711_get_scale_to_gain(int scale)\r\n{\r\nint i;\r\nfor (i = 0; i < HX711_GAIN_MAX; i++)\r\nif (hx711_gain_to_scale[i].scale == scale)\r\nreturn hx711_gain_to_scale[i].gain;\r\nreturn -EINVAL;\r\n}\r\nstatic int hx711_cycle(struct hx711_data *hx711_data)\r\n{\r\nint val;\r\npreempt_disable();\r\ngpiod_set_value(hx711_data->gpiod_pd_sck, 1);\r\nval = gpiod_get_value(hx711_data->gpiod_dout);\r\ngpiod_set_value(hx711_data->gpiod_pd_sck, 0);\r\npreempt_enable();\r\nreturn val;\r\n}\r\nstatic int hx711_read(struct hx711_data *hx711_data)\r\n{\r\nint i, ret;\r\nint value = 0;\r\nint val = gpiod_get_value(hx711_data->gpiod_dout);\r\nif (val)\r\nreturn -EIO;\r\nfor (i = 0; i < 24; i++) {\r\nvalue <<= 1;\r\nret = hx711_cycle(hx711_data);\r\nif (ret)\r\nvalue++;\r\n}\r\nvalue ^= 0x800000;\r\nfor (i = 0; i < hx711_get_gain_to_pulse(hx711_data->gain_set); i++)\r\nhx711_cycle(hx711_data);\r\nreturn value;\r\n}\r\nstatic int hx711_wait_for_ready(struct hx711_data *hx711_data)\r\n{\r\nint i, val;\r\nfor (i = 0; i < 100; i++) {\r\nval = gpiod_get_value(hx711_data->gpiod_dout);\r\nif (!val)\r\nbreak;\r\nmsleep(1);\r\n}\r\nif (val)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int hx711_reset(struct hx711_data *hx711_data)\r\n{\r\nint ret;\r\nint val = gpiod_get_value(hx711_data->gpiod_dout);\r\nif (val) {\r\ngpiod_set_value(hx711_data->gpiod_pd_sck, 1);\r\nmsleep(10);\r\ngpiod_set_value(hx711_data->gpiod_pd_sck, 0);\r\nret = hx711_wait_for_ready(hx711_data);\r\nif (ret)\r\nreturn ret;\r\nret = hx711_read(hx711_data);\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx711_wait_for_ready(hx711_data);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn val;\r\n}\r\nstatic int hx711_set_gain_for_channel(struct hx711_data *hx711_data, int chan)\r\n{\r\nint ret;\r\nif (chan == 0) {\r\nif (hx711_data->gain_set == 32) {\r\nhx711_data->gain_set = hx711_data->gain_chan_a;\r\nret = hx711_read(hx711_data);\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx711_wait_for_ready(hx711_data);\r\nif (ret)\r\nreturn ret;\r\n}\r\n} else {\r\nif (hx711_data->gain_set != 32) {\r\nhx711_data->gain_set = 32;\r\nret = hx711_read(hx711_data);\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx711_wait_for_ready(hx711_data);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int hx711_read_raw(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct hx711_data *hx711_data = iio_priv(indio_dev);\r\nint ret;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&hx711_data->lock);\r\nif (hx711_reset(hx711_data)) {\r\nmutex_unlock(&hx711_data->lock);\r\ndev_err(hx711_data->dev, "reset failed!");\r\nreturn -EIO;\r\n}\r\nret = hx711_set_gain_for_channel(hx711_data, chan->channel);\r\nif (ret < 0) {\r\nmutex_unlock(&hx711_data->lock);\r\nreturn ret;\r\n}\r\n*val = hx711_read(hx711_data);\r\nmutex_unlock(&hx711_data->lock);\r\nif (*val < 0)\r\nreturn *val;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 0;\r\nmutex_lock(&hx711_data->lock);\r\n*val2 = hx711_get_gain_to_scale(hx711_data->gain_set);\r\nmutex_unlock(&hx711_data->lock);\r\nreturn IIO_VAL_INT_PLUS_NANO;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int hx711_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct hx711_data *hx711_data = iio_priv(indio_dev);\r\nint ret;\r\nint gain;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_SCALE:\r\nif (val != 0)\r\nreturn -EINVAL;\r\nmutex_lock(&hx711_data->lock);\r\ngain = hx711_get_scale_to_gain(val2);\r\nif (gain < 0) {\r\nmutex_unlock(&hx711_data->lock);\r\nreturn gain;\r\n}\r\nif (gain != hx711_data->gain_set) {\r\nhx711_data->gain_set = gain;\r\nif (gain != 32)\r\nhx711_data->gain_chan_a = gain;\r\nret = hx711_read(hx711_data);\r\nif (ret < 0) {\r\nmutex_unlock(&hx711_data->lock);\r\nreturn ret;\r\n}\r\n}\r\nmutex_unlock(&hx711_data->lock);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hx711_write_raw_get_fmt(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nlong mask)\r\n{\r\nreturn IIO_VAL_INT_PLUS_NANO;\r\n}\r\nstatic ssize_t hx711_scale_available_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev_attr *iio_attr = to_iio_dev_attr(attr);\r\nint channel = iio_attr->address;\r\nint i, len = 0;\r\nfor (i = 0; i < HX711_GAIN_MAX; i++)\r\nif (hx711_gain_to_scale[i].channel == channel)\r\nlen += sprintf(buf + len, "0.%09d ",\r\nhx711_gain_to_scale[i].scale);\r\nlen += sprintf(buf + len, "\n");\r\nreturn len;\r\n}\r\nstatic int hx711_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct hx711_data *hx711_data;\r\nstruct iio_dev *indio_dev;\r\nint ret;\r\nint i;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(struct hx711_data));\r\nif (!indio_dev) {\r\ndev_err(dev, "failed to allocate IIO device\n");\r\nreturn -ENOMEM;\r\n}\r\nhx711_data = iio_priv(indio_dev);\r\nhx711_data->dev = dev;\r\nmutex_init(&hx711_data->lock);\r\nhx711_data->gpiod_pd_sck = devm_gpiod_get(dev, "sck", GPIOD_OUT_LOW);\r\nif (IS_ERR(hx711_data->gpiod_pd_sck)) {\r\ndev_err(dev, "failed to get sck-gpiod: err=%ld\n",\r\nPTR_ERR(hx711_data->gpiod_pd_sck));\r\nreturn PTR_ERR(hx711_data->gpiod_pd_sck);\r\n}\r\nhx711_data->gpiod_dout = devm_gpiod_get(dev, "dout", GPIOD_IN);\r\nif (IS_ERR(hx711_data->gpiod_dout)) {\r\ndev_err(dev, "failed to get dout-gpiod: err=%ld\n",\r\nPTR_ERR(hx711_data->gpiod_dout));\r\nreturn PTR_ERR(hx711_data->gpiod_dout);\r\n}\r\nhx711_data->reg_avdd = devm_regulator_get(dev, "avdd");\r\nif (IS_ERR(hx711_data->reg_avdd))\r\nreturn PTR_ERR(hx711_data->reg_avdd);\r\nret = regulator_enable(hx711_data->reg_avdd);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regulator_get_voltage(hx711_data->reg_avdd);\r\nif (ret < 0) {\r\nregulator_disable(hx711_data->reg_avdd);\r\nreturn ret;\r\n}\r\nret *= 100;\r\nfor (i = 0; i < HX711_GAIN_MAX; i++)\r\nhx711_gain_to_scale[i].scale =\r\nret / hx711_gain_to_scale[i].gain / 1678;\r\nhx711_data->gain_set = 128;\r\nhx711_data->gain_chan_a = 128;\r\nplatform_set_drvdata(pdev, indio_dev);\r\nindio_dev->name = "hx711";\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->info = &hx711_iio_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = hx711_chan_spec;\r\nindio_dev->num_channels = ARRAY_SIZE(hx711_chan_spec);\r\nret = iio_device_register(indio_dev);\r\nif (ret < 0) {\r\ndev_err(dev, "Couldn't register the device\n");\r\nregulator_disable(hx711_data->reg_avdd);\r\n}\r\nreturn ret;\r\n}\r\nstatic int hx711_remove(struct platform_device *pdev)\r\n{\r\nstruct hx711_data *hx711_data;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = platform_get_drvdata(pdev);\r\nhx711_data = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nregulator_disable(hx711_data->reg_avdd);\r\nreturn 0;\r\n}

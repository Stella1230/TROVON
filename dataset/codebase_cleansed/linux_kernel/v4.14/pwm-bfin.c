static int bfin_pwm_request(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct bfin_pwm *priv;\r\nint ret;\r\nif (pwm->hwpwm >= ARRAY_SIZE(pwm_to_gptimer_per))\r\nreturn -EINVAL;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->pin = pwm_to_gptimer_per[pwm->hwpwm];\r\nret = peripheral_request(priv->pin, NULL);\r\nif (ret) {\r\nkfree(priv);\r\nreturn ret;\r\n}\r\npwm_set_chip_data(pwm, priv);\r\nreturn 0;\r\n}\r\nstatic void bfin_pwm_free(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct bfin_pwm *priv = pwm_get_chip_data(pwm);\r\nif (priv) {\r\nperipheral_free(priv->pin);\r\nkfree(priv);\r\n}\r\n}\r\nstatic int bfin_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nstruct bfin_pwm *priv = pwm_get_chip_data(pwm);\r\nunsigned long period, duty;\r\nunsigned long long val;\r\nval = (unsigned long long)get_sclk() * period_ns;\r\ndo_div(val, NSEC_PER_SEC);\r\nperiod = val;\r\nval = (unsigned long long)period * duty_ns;\r\ndo_div(val, period_ns);\r\nduty = period - val;\r\nif (duty >= period)\r\nduty = period - 1;\r\nset_gptimer_config(priv->pin, TIMER_MODE_PWM | TIMER_PERIOD_CNT);\r\nset_gptimer_pwidth(priv->pin, duty);\r\nset_gptimer_period(priv->pin, period);\r\nreturn 0;\r\n}\r\nstatic int bfin_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct bfin_pwm *priv = pwm_get_chip_data(pwm);\r\nenable_gptimer(priv->pin);\r\nreturn 0;\r\n}\r\nstatic void bfin_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct bfin_pwm *priv = pwm_get_chip_data(pwm);\r\ndisable_gptimer(priv->pin);\r\n}\r\nstatic int bfin_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct bfin_pwm_chip *pwm;\r\nint ret;\r\npwm = devm_kzalloc(&pdev->dev, sizeof(*pwm), GFP_KERNEL);\r\nif (!pwm)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, pwm);\r\npwm->chip.dev = &pdev->dev;\r\npwm->chip.ops = &bfin_pwm_ops;\r\npwm->chip.base = -1;\r\npwm->chip.npwm = 12;\r\nret = pwmchip_add(&pwm->chip);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "pwmchip_add() failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bfin_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_pwm_chip *pwm = platform_get_drvdata(pdev);\r\nreturn pwmchip_remove(&pwm->chip);\r\n}

static int smsc_phy_config_intr(struct phy_device *phydev)\r\n{\r\nint rc = phy_write (phydev, MII_LAN83C185_IM,\r\n((PHY_INTERRUPT_ENABLED == phydev->interrupts)\r\n? MII_LAN83C185_ISF_INT_PHYLIB_EVENTS\r\n: 0));\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int smsc_phy_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint rc = phy_read (phydev, MII_LAN83C185_ISF);\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int smsc_phy_config_init(struct phy_device *phydev)\r\n{\r\nstruct smsc_phy_priv *priv = phydev->priv;\r\nint rc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nif (priv->energy_enable) {\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc | MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\n}\r\nreturn smsc_phy_ack_interrupt(phydev);\r\n}\r\nstatic int smsc_phy_reset(struct phy_device *phydev)\r\n{\r\nint rc = phy_read(phydev, MII_LAN83C185_SPECIAL_MODES);\r\nif (rc < 0)\r\nreturn rc;\r\nif ((rc & MII_LAN83C185_MODE_MASK) == MII_LAN83C185_MODE_POWERDOWN) {\r\nrc |= MII_LAN83C185_MODE_ALL;\r\nphy_write(phydev, MII_LAN83C185_SPECIAL_MODES, rc);\r\n}\r\nreturn genphy_soft_reset(phydev);\r\n}\r\nstatic int lan911x_config_init(struct phy_device *phydev)\r\n{\r\nreturn smsc_phy_ack_interrupt(phydev);\r\n}\r\nstatic int lan87xx_read_status(struct phy_device *phydev)\r\n{\r\nstruct smsc_phy_priv *priv = phydev->priv;\r\nint err = genphy_read_status(phydev);\r\nif (!phydev->link && priv->energy_enable) {\r\nint i;\r\nint rc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc & ~MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\nfor (i = 0; i < 64; i++) {\r\nmsleep(10);\r\nrc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nif (rc & MII_LAN83C185_ENERGYON)\r\nbreak;\r\n}\r\nrc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc | MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\n}\r\nreturn err;\r\n}\r\nstatic int smsc_get_sset_count(struct phy_device *phydev)\r\n{\r\nreturn ARRAY_SIZE(smsc_hw_stats);\r\n}\r\nstatic void smsc_get_strings(struct phy_device *phydev, u8 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(smsc_hw_stats); i++) {\r\nstrncpy(data + i * ETH_GSTRING_LEN,\r\nsmsc_hw_stats[i].string, ETH_GSTRING_LEN);\r\n}\r\n}\r\nstatic u64 smsc_get_stat(struct phy_device *phydev, int i)\r\n{\r\nstruct smsc_hw_stat stat = smsc_hw_stats[i];\r\nint val;\r\nu64 ret;\r\nval = phy_read(phydev, stat.reg);\r\nif (val < 0)\r\nret = UINT64_MAX;\r\nelse\r\nret = val;\r\nreturn ret;\r\n}\r\nstatic void smsc_get_stats(struct phy_device *phydev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(smsc_hw_stats); i++)\r\ndata[i] = smsc_get_stat(phydev, i);\r\n}\r\nstatic int smsc_phy_probe(struct phy_device *phydev)\r\n{\r\nstruct device *dev = &phydev->mdio.dev;\r\nstruct device_node *of_node = dev->of_node;\r\nstruct smsc_phy_priv *priv;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->energy_enable = true;\r\nif (of_property_read_bool(of_node, "smsc,disable-energy-detect"))\r\npriv->energy_enable = false;\r\nphydev->priv = priv;\r\nreturn 0;\r\n}

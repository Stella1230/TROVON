const char *sti_plane_to_str(struct sti_plane *plane)\r\n{\r\nswitch (plane->desc) {\r\ncase STI_GDP_0:\r\nreturn "GDP0";\r\ncase STI_GDP_1:\r\nreturn "GDP1";\r\ncase STI_GDP_2:\r\nreturn "GDP2";\r\ncase STI_GDP_3:\r\nreturn "GDP3";\r\ncase STI_HQVDP_0:\r\nreturn "HQVDP0";\r\ncase STI_CURSOR:\r\nreturn "CURSOR";\r\ndefault:\r\nreturn "<UNKNOWN PLANE>";\r\n}\r\n}\r\nvoid sti_plane_update_fps(struct sti_plane *plane,\r\nbool new_frame,\r\nbool new_field)\r\n{\r\nktime_t now;\r\nstruct sti_fps_info *fps;\r\nint fpks, fipks, ms_since_last, num_frames, num_fields;\r\nnow = ktime_get();\r\nfps = &plane->fps_info;\r\nif (new_field)\r\nfps->curr_field_counter++;\r\nif (!new_frame)\r\nreturn;\r\nfps->curr_frame_counter++;\r\nms_since_last = ktime_to_ms(ktime_sub(now, fps->last_timestamp));\r\nnum_frames = fps->curr_frame_counter - fps->last_frame_counter;\r\nif (num_frames <= 0 || ms_since_last < STI_FPS_INTERVAL_MS)\r\nreturn;\r\nfps->last_timestamp = now;\r\nfps->last_frame_counter = fps->curr_frame_counter;\r\nif (plane->drm_plane.fb) {\r\nfpks = (num_frames * 1000000) / ms_since_last;\r\nsnprintf(plane->fps_info.fps_str, FPS_LENGTH,\r\n"%-8s %4dx%-4d %.4s @ %3d.%-3.3d fps (%s)",\r\nplane->drm_plane.name,\r\nplane->drm_plane.fb->width,\r\nplane->drm_plane.fb->height,\r\n(char *)&plane->drm_plane.fb->format->format,\r\nfpks / 1000, fpks % 1000,\r\nsti_plane_to_str(plane));\r\n}\r\nif (fps->curr_field_counter) {\r\nnum_fields = fps->curr_field_counter - fps->last_field_counter;\r\nfps->last_field_counter = fps->curr_field_counter;\r\nfipks = (num_fields * 1000000) / ms_since_last;\r\nsnprintf(plane->fps_info.fips_str,\r\nFPS_LENGTH, " - %3d.%-3.3d field/sec",\r\nfipks / 1000, fipks % 1000);\r\n} else {\r\nplane->fps_info.fips_str[0] = '\0';\r\n}\r\nif (fps->output)\r\nDRM_INFO("%s%s\n",\r\nplane->fps_info.fps_str,\r\nplane->fps_info.fips_str);\r\n}\r\nstatic int sti_plane_get_default_zpos(enum drm_plane_type type)\r\n{\r\nswitch (type) {\r\ncase DRM_PLANE_TYPE_PRIMARY:\r\nreturn 0;\r\ncase DRM_PLANE_TYPE_OVERLAY:\r\nreturn 1;\r\ncase DRM_PLANE_TYPE_CURSOR:\r\nreturn 7;\r\n}\r\nreturn 0;\r\n}\r\nvoid sti_plane_reset(struct drm_plane *plane)\r\n{\r\ndrm_atomic_helper_plane_reset(plane);\r\nplane->state->zpos = sti_plane_get_default_zpos(plane->type);\r\n}\r\nstatic void sti_plane_attach_zorder_property(struct drm_plane *drm_plane,\r\nenum drm_plane_type type)\r\n{\r\nint zpos = sti_plane_get_default_zpos(type);\r\nswitch (type) {\r\ncase DRM_PLANE_TYPE_PRIMARY:\r\ncase DRM_PLANE_TYPE_OVERLAY:\r\ndrm_plane_create_zpos_property(drm_plane, zpos, 0, 6);\r\nbreak;\r\ncase DRM_PLANE_TYPE_CURSOR:\r\ndrm_plane_create_zpos_immutable_property(drm_plane, zpos);\r\nbreak;\r\n}\r\n}\r\nvoid sti_plane_init_property(struct sti_plane *plane,\r\nenum drm_plane_type type)\r\n{\r\nsti_plane_attach_zorder_property(&plane->drm_plane, type);\r\nDRM_DEBUG_DRIVER("drm plane:%d mapped to %s\n",\r\nplane->drm_plane.base.id, sti_plane_to_str(plane));\r\n}

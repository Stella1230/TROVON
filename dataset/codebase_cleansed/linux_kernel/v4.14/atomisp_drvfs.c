static inline int iunit_dump_dbgopt(struct atomisp_device *isp,\r\nunsigned int opt)\r\n{\r\nint ret = 0;\r\nif (opt & OPTION_VALID) {\r\nif (opt & OPTION_BIN_LIST) {\r\nret = atomisp_css_dump_blob_infor();\r\nif (ret) {\r\ndev_err(atomisp_dev, "%s dump blob infor err[ret:%d]\n",\r\n__func__, ret);\r\ngoto opt_err;\r\n}\r\n}\r\nif (opt & OPTION_BIN_RUN) {\r\nif (atomisp_streaming_count(isp)) {\r\natomisp_css_dump_sp_raw_copy_linecount(true);\r\natomisp_css_debug_dump_isp_binary();\r\n} else {\r\nret = -EPERM;\r\ndev_err(atomisp_dev, "%s dump running bin err[ret:%d]\n",\r\n__func__, ret);\r\ngoto opt_err;\r\n}\r\n}\r\nif (opt & OPTION_MEM_STAT)\r\nhmm_show_mem_stat(__func__, __LINE__);\r\n} else {\r\nret = -EINVAL;\r\ndev_err(atomisp_dev, "%s dump nothing[ret=%d]\n", __func__,\r\nret);\r\n}\r\nopt_err:\r\nreturn ret;\r\n}\r\nstatic ssize_t iunit_dbglvl_show(struct device_driver *drv, char *buf)\r\n{\r\niunit_debug.dbglvl = atomisp_css_debug_get_dtrace_level();\r\nreturn sprintf(buf, "dtrace level:%u\n", iunit_debug.dbglvl);\r\n}\r\nstatic ssize_t iunit_dbglvl_store(struct device_driver *drv, const char *buf,\r\nsize_t size)\r\n{\r\nif (kstrtouint(buf, 10, &iunit_debug.dbglvl)\r\n|| iunit_debug.dbglvl < 1\r\n|| iunit_debug.dbglvl > 9) {\r\nreturn -ERANGE;\r\n}\r\natomisp_css_debug_set_dtrace_level(iunit_debug.dbglvl);\r\nreturn size;\r\n}\r\nstatic ssize_t iunit_dbgfun_show(struct device_driver *drv, char *buf)\r\n{\r\niunit_debug.dbgfun = atomisp_get_css_dbgfunc();\r\nreturn sprintf(buf, "dbgfun opt:%u\n", iunit_debug.dbgfun);\r\n}\r\nstatic ssize_t iunit_dbgfun_store(struct device_driver *drv, const char *buf,\r\nsize_t size)\r\n{\r\nunsigned int opt;\r\nint ret;\r\nret = kstrtouint(buf, 10, &opt);\r\nif (ret)\r\nreturn ret;\r\nret = atomisp_set_css_dbgfunc(iunit_debug.isp, opt);\r\nif (ret)\r\nreturn ret;\r\niunit_debug.dbgfun = opt;\r\nreturn size;\r\n}\r\nstatic ssize_t iunit_dbgopt_show(struct device_driver *drv, char *buf)\r\n{\r\nreturn sprintf(buf, "option:0x%x\n", iunit_debug.dbgopt);\r\n}\r\nstatic ssize_t iunit_dbgopt_store(struct device_driver *drv, const char *buf,\r\nsize_t size)\r\n{\r\nunsigned int opt;\r\nint ret;\r\nret = kstrtouint(buf, 10, &opt);\r\nif (ret)\r\nreturn ret;\r\niunit_debug.dbgopt = opt;\r\nret = iunit_dump_dbgopt(iunit_debug.isp, iunit_debug.dbgopt);\r\nif (ret)\r\nreturn ret;\r\nreturn size;\r\n}\r\nstatic int iunit_drvfs_create_files(struct pci_driver *drv)\r\n{\r\nint i, ret = 0;\r\nfor (i = 0; i < ARRAY_SIZE(iunit_drvfs_attrs); i++)\r\nret |= driver_create_file(&(drv->driver),\r\n&iunit_drvfs_attrs[i]);\r\nreturn ret;\r\n}\r\nstatic void iunit_drvfs_remove_files(struct pci_driver *drv)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(iunit_drvfs_attrs); i++)\r\ndriver_remove_file(&(drv->driver), &iunit_drvfs_attrs[i]);\r\n}\r\nint atomisp_drvfs_init(struct pci_driver *drv, struct atomisp_device *isp)\r\n{\r\nint ret;\r\niunit_debug.isp = isp;\r\niunit_debug.drv = drv;\r\nret = iunit_drvfs_create_files(iunit_debug.drv);\r\nif (ret) {\r\ndev_err(atomisp_dev, "drvfs_create_files error: %d\n", ret);\r\niunit_drvfs_remove_files(drv);\r\n}\r\nreturn ret;\r\n}\r\nvoid atomisp_drvfs_exit(void)\r\n{\r\niunit_drvfs_remove_files(iunit_debug.drv);\r\n}

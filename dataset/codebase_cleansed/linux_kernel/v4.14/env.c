void __init prom_init_env(void)\r\n{\r\nunsigned int processor_id;\r\n#ifndef CONFIG_LEFI_FIRMWARE_INTERFACE\r\nint *_prom_envp;\r\nlong l;\r\n_prom_envp = (int *)fw_arg2;\r\nl = (long)*_prom_envp;\r\nwhile (l != 0) {\r\nparse_even_earlier(cpu_clock_freq, "cpuclock", l);\r\nparse_even_earlier(memsize, "memsize", l);\r\nparse_even_earlier(highmemsize, "highmemsize", l);\r\n_prom_envp++;\r\nl = (long)*_prom_envp;\r\n}\r\nif (memsize == 0)\r\nmemsize = 256;\r\nloongson_sysconf.nr_uarts = 1;\r\npr_info("memsize=%u, highmemsize=%u\n", memsize, highmemsize);\r\n#else\r\nstruct boot_params *boot_p;\r\nstruct loongson_params *loongson_p;\r\nstruct system_loongson *esys;\r\nstruct efi_cpuinfo_loongson *ecpu;\r\nstruct irq_source_routing_table *eirq_source;\r\nboot_p = (struct boot_params *)fw_arg2;\r\nloongson_p = &(boot_p->efi.smbios.lp);\r\nesys = (struct system_loongson *)\r\n((u64)loongson_p + loongson_p->system_offset);\r\necpu = (struct efi_cpuinfo_loongson *)\r\n((u64)loongson_p + loongson_p->cpu_offset);\r\neirq_source = (struct irq_source_routing_table *)\r\n((u64)loongson_p + loongson_p->irq_offset);\r\nloongson_memmap = (struct efi_memory_map_loongson *)\r\n((u64)loongson_p + loongson_p->memory_offset);\r\ncpu_clock_freq = ecpu->cpu_clock_freq;\r\nloongson_sysconf.cputype = ecpu->cputype;\r\nswitch (ecpu->cputype) {\r\ncase Legacy_3A:\r\ncase Loongson_3A:\r\nloongson_sysconf.cores_per_node = 4;\r\nloongson_sysconf.cores_per_package = 4;\r\nsmp_group[0] = 0x900000003ff01000;\r\nsmp_group[1] = 0x900010003ff01000;\r\nsmp_group[2] = 0x900020003ff01000;\r\nsmp_group[3] = 0x900030003ff01000;\r\nloongson_chipcfg[0] = 0x900000001fe00180;\r\nloongson_chipcfg[1] = 0x900010001fe00180;\r\nloongson_chipcfg[2] = 0x900020001fe00180;\r\nloongson_chipcfg[3] = 0x900030001fe00180;\r\nloongson_chiptemp[0] = 0x900000001fe0019c;\r\nloongson_chiptemp[1] = 0x900010001fe0019c;\r\nloongson_chiptemp[2] = 0x900020001fe0019c;\r\nloongson_chiptemp[3] = 0x900030001fe0019c;\r\nloongson_freqctrl[0] = 0x900000001fe001d0;\r\nloongson_freqctrl[1] = 0x900010001fe001d0;\r\nloongson_freqctrl[2] = 0x900020001fe001d0;\r\nloongson_freqctrl[3] = 0x900030001fe001d0;\r\nloongson_sysconf.ht_control_base = 0x90000EFDFB000000;\r\nloongson_sysconf.workarounds = WORKAROUND_CPUFREQ;\r\nbreak;\r\ncase Legacy_3B:\r\ncase Loongson_3B:\r\nloongson_sysconf.cores_per_node = 4;\r\nloongson_sysconf.cores_per_package = 8;\r\nsmp_group[0] = 0x900000003ff01000;\r\nsmp_group[1] = 0x900010003ff05000;\r\nsmp_group[2] = 0x900020003ff09000;\r\nsmp_group[3] = 0x900030003ff0d000;\r\nloongson_chipcfg[0] = 0x900000001fe00180;\r\nloongson_chipcfg[1] = 0x900020001fe00180;\r\nloongson_chipcfg[2] = 0x900040001fe00180;\r\nloongson_chipcfg[3] = 0x900060001fe00180;\r\nloongson_chiptemp[0] = 0x900000001fe0019c;\r\nloongson_chiptemp[1] = 0x900020001fe0019c;\r\nloongson_chiptemp[2] = 0x900040001fe0019c;\r\nloongson_chiptemp[3] = 0x900060001fe0019c;\r\nloongson_freqctrl[0] = 0x900000001fe001d0;\r\nloongson_freqctrl[1] = 0x900020001fe001d0;\r\nloongson_freqctrl[2] = 0x900040001fe001d0;\r\nloongson_freqctrl[3] = 0x900060001fe001d0;\r\nloongson_sysconf.ht_control_base = 0x90001EFDFB000000;\r\nloongson_sysconf.workarounds = WORKAROUND_CPUHOTPLUG;\r\nbreak;\r\ndefault:\r\nloongson_sysconf.cores_per_node = 1;\r\nloongson_sysconf.cores_per_package = 1;\r\nloongson_chipcfg[0] = 0x900000001fe00180;\r\n}\r\nloongson_sysconf.nr_cpus = ecpu->nr_cpus;\r\nloongson_sysconf.boot_cpu_id = ecpu->cpu_startup_core_id;\r\nloongson_sysconf.reserved_cpus_mask = ecpu->reserved_cores_mask;\r\nif (ecpu->nr_cpus > NR_CPUS || ecpu->nr_cpus == 0)\r\nloongson_sysconf.nr_cpus = NR_CPUS;\r\nloongson_sysconf.nr_nodes = (loongson_sysconf.nr_cpus +\r\nloongson_sysconf.cores_per_node - 1) /\r\nloongson_sysconf.cores_per_node;\r\nloongson_sysconf.pci_mem_start_addr = eirq_source->pci_mem_start_addr;\r\nloongson_sysconf.pci_mem_end_addr = eirq_source->pci_mem_end_addr;\r\nloongson_sysconf.pci_io_base = eirq_source->pci_io_start_addr;\r\nloongson_sysconf.dma_mask_bits = eirq_source->dma_mask_bits;\r\nif (loongson_sysconf.dma_mask_bits < 32 ||\r\nloongson_sysconf.dma_mask_bits > 64)\r\nloongson_sysconf.dma_mask_bits = 32;\r\nloongson_sysconf.restart_addr = boot_p->reset_system.ResetWarm;\r\nloongson_sysconf.poweroff_addr = boot_p->reset_system.Shutdown;\r\nloongson_sysconf.suspend_addr = boot_p->reset_system.DoSuspend;\r\nloongson_sysconf.vgabios_addr = boot_p->efi.smbios.vga_bios;\r\npr_debug("Shutdown Addr: %llx, Restart Addr: %llx, VBIOS Addr: %llx\n",\r\nloongson_sysconf.poweroff_addr, loongson_sysconf.restart_addr,\r\nloongson_sysconf.vgabios_addr);\r\nmemset(loongson_sysconf.ecname, 0, 32);\r\nif (esys->has_ec)\r\nmemcpy(loongson_sysconf.ecname, esys->ec_name, 32);\r\nloongson_sysconf.workarounds |= esys->workarounds;\r\nloongson_sysconf.nr_uarts = esys->nr_uarts;\r\nif (esys->nr_uarts < 1 || esys->nr_uarts > MAX_UARTS)\r\nloongson_sysconf.nr_uarts = 1;\r\nmemcpy(loongson_sysconf.uarts, esys->uarts,\r\nsizeof(struct uart_device) * loongson_sysconf.nr_uarts);\r\nloongson_sysconf.nr_sensors = esys->nr_sensors;\r\nif (loongson_sysconf.nr_sensors > MAX_SENSORS)\r\nloongson_sysconf.nr_sensors = 0;\r\nif (loongson_sysconf.nr_sensors)\r\nmemcpy(loongson_sysconf.sensors, esys->sensors,\r\nsizeof(struct sensor_device) * loongson_sysconf.nr_sensors);\r\n#endif\r\nif (cpu_clock_freq == 0) {\r\nprocessor_id = (&current_cpu_data)->processor_id;\r\nswitch (processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON2E:\r\ncpu_clock_freq = 533080000;\r\nbreak;\r\ncase PRID_REV_LOONGSON2F:\r\ncpu_clock_freq = 797000000;\r\nbreak;\r\ncase PRID_REV_LOONGSON3A_R1:\r\ncase PRID_REV_LOONGSON3A_R2:\r\ncase PRID_REV_LOONGSON3A_R3:\r\ncpu_clock_freq = 900000000;\r\nbreak;\r\ncase PRID_REV_LOONGSON3B_R1:\r\ncase PRID_REV_LOONGSON3B_R2:\r\ncpu_clock_freq = 1000000000;\r\nbreak;\r\ndefault:\r\ncpu_clock_freq = 100000000;\r\nbreak;\r\n}\r\n}\r\npr_info("CpuClock = %u\n", cpu_clock_freq);\r\n}

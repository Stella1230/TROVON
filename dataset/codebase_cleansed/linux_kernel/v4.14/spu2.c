static char *spu2_ciph_type_name(enum spu2_cipher_type cipher_type)\r\n{\r\nif (cipher_type >= SPU2_CIPHER_TYPE_LAST)\r\nreturn "Reserved";\r\nreturn spu2_cipher_type_names[cipher_type];\r\n}\r\nstatic char *spu2_ciph_mode_name(enum spu2_cipher_mode cipher_mode)\r\n{\r\nif (cipher_mode >= SPU2_CIPHER_MODE_LAST)\r\nreturn "Reserved";\r\nreturn spu2_cipher_mode_names[cipher_mode];\r\n}\r\nstatic char *spu2_hash_type_name(enum spu2_hash_type hash_type)\r\n{\r\nif (hash_type >= SPU2_HASH_TYPE_LAST)\r\nreturn "Reserved";\r\nreturn spu2_hash_type_names[hash_type];\r\n}\r\nstatic char *spu2_hash_mode_name(enum spu2_hash_mode hash_mode)\r\n{\r\nif (hash_mode >= SPU2_HASH_MODE_LAST)\r\nreturn "Reserved";\r\nreturn spu2_hash_mode_names[hash_mode];\r\n}\r\nstatic int spu2_cipher_mode_xlate(enum spu_cipher_mode cipher_mode,\r\nenum spu2_cipher_mode *spu2_mode)\r\n{\r\nswitch (cipher_mode) {\r\ncase CIPHER_MODE_ECB:\r\n*spu2_mode = SPU2_CIPHER_MODE_ECB;\r\nbreak;\r\ncase CIPHER_MODE_CBC:\r\n*spu2_mode = SPU2_CIPHER_MODE_CBC;\r\nbreak;\r\ncase CIPHER_MODE_OFB:\r\n*spu2_mode = SPU2_CIPHER_MODE_OFB;\r\nbreak;\r\ncase CIPHER_MODE_CFB:\r\n*spu2_mode = SPU2_CIPHER_MODE_CFB;\r\nbreak;\r\ncase CIPHER_MODE_CTR:\r\n*spu2_mode = SPU2_CIPHER_MODE_CTR;\r\nbreak;\r\ncase CIPHER_MODE_CCM:\r\n*spu2_mode = SPU2_CIPHER_MODE_CCM;\r\nbreak;\r\ncase CIPHER_MODE_GCM:\r\n*spu2_mode = SPU2_CIPHER_MODE_GCM;\r\nbreak;\r\ncase CIPHER_MODE_XTS:\r\n*spu2_mode = SPU2_CIPHER_MODE_XTS;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int spu2_cipher_xlate(enum spu_cipher_alg cipher_alg,\r\nenum spu_cipher_mode cipher_mode,\r\nenum spu_cipher_type cipher_type,\r\nenum spu2_cipher_type *spu2_type,\r\nenum spu2_cipher_mode *spu2_mode)\r\n{\r\nint err;\r\nerr = spu2_cipher_mode_xlate(cipher_mode, spu2_mode);\r\nif (err) {\r\nflow_log("Invalid cipher mode %d\n", cipher_mode);\r\nreturn err;\r\n}\r\nswitch (cipher_alg) {\r\ncase CIPHER_ALG_NONE:\r\n*spu2_type = SPU2_CIPHER_TYPE_NONE;\r\nbreak;\r\ncase CIPHER_ALG_RC4:\r\nerr = -EINVAL;\r\n*spu2_type = SPU2_CIPHER_TYPE_NONE;\r\nbreak;\r\ncase CIPHER_ALG_DES:\r\n*spu2_type = SPU2_CIPHER_TYPE_DES;\r\nbreak;\r\ncase CIPHER_ALG_3DES:\r\n*spu2_type = SPU2_CIPHER_TYPE_3DES;\r\nbreak;\r\ncase CIPHER_ALG_AES:\r\nswitch (cipher_type) {\r\ncase CIPHER_TYPE_AES128:\r\n*spu2_type = SPU2_CIPHER_TYPE_AES128;\r\nbreak;\r\ncase CIPHER_TYPE_AES192:\r\n*spu2_type = SPU2_CIPHER_TYPE_AES192;\r\nbreak;\r\ncase CIPHER_TYPE_AES256:\r\n*spu2_type = SPU2_CIPHER_TYPE_AES256;\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nbreak;\r\ncase CIPHER_ALG_LAST:\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nif (err)\r\nflow_log("Invalid cipher alg %d or type %d\n",\r\ncipher_alg, cipher_type);\r\nreturn err;\r\n}\r\nstatic int spu2_hash_mode_xlate(enum hash_mode hash_mode,\r\nenum spu2_hash_mode *spu2_mode)\r\n{\r\nswitch (hash_mode) {\r\ncase HASH_MODE_XCBC:\r\n*spu2_mode = SPU2_HASH_MODE_XCBC_MAC;\r\nbreak;\r\ncase HASH_MODE_CMAC:\r\n*spu2_mode = SPU2_HASH_MODE_CMAC;\r\nbreak;\r\ncase HASH_MODE_HMAC:\r\n*spu2_mode = SPU2_HASH_MODE_HMAC;\r\nbreak;\r\ncase HASH_MODE_CCM:\r\n*spu2_mode = SPU2_HASH_MODE_CCM;\r\nbreak;\r\ncase HASH_MODE_GCM:\r\n*spu2_mode = SPU2_HASH_MODE_GCM;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nspu2_hash_xlate(enum hash_alg hash_alg, enum hash_mode hash_mode,\r\nenum hash_type hash_type, enum spu_cipher_type ciph_type,\r\nenum spu2_hash_type *spu2_type, enum spu2_hash_mode *spu2_mode)\r\n{\r\nint err;\r\nerr = spu2_hash_mode_xlate(hash_mode, spu2_mode);\r\nif (err) {\r\nflow_log("Invalid hash mode %d\n", hash_mode);\r\nreturn err;\r\n}\r\nswitch (hash_alg) {\r\ncase HASH_ALG_NONE:\r\n*spu2_type = SPU2_HASH_TYPE_NONE;\r\nbreak;\r\ncase HASH_ALG_MD5:\r\n*spu2_type = SPU2_HASH_TYPE_MD5;\r\nbreak;\r\ncase HASH_ALG_SHA1:\r\n*spu2_type = SPU2_HASH_TYPE_SHA1;\r\nbreak;\r\ncase HASH_ALG_SHA224:\r\n*spu2_type = SPU2_HASH_TYPE_SHA224;\r\nbreak;\r\ncase HASH_ALG_SHA256:\r\n*spu2_type = SPU2_HASH_TYPE_SHA256;\r\nbreak;\r\ncase HASH_ALG_SHA384:\r\n*spu2_type = SPU2_HASH_TYPE_SHA384;\r\nbreak;\r\ncase HASH_ALG_SHA512:\r\n*spu2_type = SPU2_HASH_TYPE_SHA512;\r\nbreak;\r\ncase HASH_ALG_AES:\r\nswitch (ciph_type) {\r\ncase CIPHER_TYPE_AES128:\r\n*spu2_type = SPU2_HASH_TYPE_AES128;\r\nbreak;\r\ncase CIPHER_TYPE_AES192:\r\n*spu2_type = SPU2_HASH_TYPE_AES192;\r\nbreak;\r\ncase CIPHER_TYPE_AES256:\r\n*spu2_type = SPU2_HASH_TYPE_AES256;\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nbreak;\r\ncase HASH_ALG_SHA3_224:\r\n*spu2_type = SPU2_HASH_TYPE_SHA3_224;\r\nbreak;\r\ncase HASH_ALG_SHA3_256:\r\n*spu2_type = SPU2_HASH_TYPE_SHA3_256;\r\nbreak;\r\ncase HASH_ALG_SHA3_384:\r\n*spu2_type = SPU2_HASH_TYPE_SHA3_384;\r\nbreak;\r\ncase HASH_ALG_SHA3_512:\r\n*spu2_type = SPU2_HASH_TYPE_SHA3_512;\r\nbreak;\r\ncase HASH_ALG_LAST:\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nif (err)\r\nflow_log("Invalid hash alg %d or type %d\n",\r\nhash_alg, hash_type);\r\nreturn err;\r\n}\r\nstatic void spu2_dump_fmd_ctrl0(u64 ctrl0)\r\n{\r\nenum spu2_cipher_type ciph_type;\r\nenum spu2_cipher_mode ciph_mode;\r\nenum spu2_hash_type hash_type;\r\nenum spu2_hash_mode hash_mode;\r\nchar *ciph_name;\r\nchar *ciph_mode_name;\r\nchar *hash_name;\r\nchar *hash_mode_name;\r\nu8 cfb;\r\nu8 proto;\r\npacket_log(" FMD CTRL0 %#16llx\n", ctrl0);\r\nif (ctrl0 & SPU2_CIPH_ENCRYPT_EN)\r\npacket_log(" encrypt\n");\r\nelse\r\npacket_log(" decrypt\n");\r\nciph_type = (ctrl0 & SPU2_CIPH_TYPE) >> SPU2_CIPH_TYPE_SHIFT;\r\nciph_name = spu2_ciph_type_name(ciph_type);\r\npacket_log(" Cipher type: %s\n", ciph_name);\r\nif (ciph_type != SPU2_CIPHER_TYPE_NONE) {\r\nciph_mode = (ctrl0 & SPU2_CIPH_MODE) >> SPU2_CIPH_MODE_SHIFT;\r\nciph_mode_name = spu2_ciph_mode_name(ciph_mode);\r\npacket_log(" Cipher mode: %s\n", ciph_mode_name);\r\n}\r\ncfb = (ctrl0 & SPU2_CFB_MASK) >> SPU2_CFB_MASK_SHIFT;\r\npacket_log(" CFB %#x\n", cfb);\r\nproto = (ctrl0 & SPU2_PROTO_SEL) >> SPU2_PROTO_SEL_SHIFT;\r\npacket_log(" protocol %#x\n", proto);\r\nif (ctrl0 & SPU2_HASH_FIRST)\r\npacket_log(" hash first\n");\r\nelse\r\npacket_log(" cipher first\n");\r\nif (ctrl0 & SPU2_CHK_TAG)\r\npacket_log(" check tag\n");\r\nhash_type = (ctrl0 & SPU2_HASH_TYPE) >> SPU2_HASH_TYPE_SHIFT;\r\nhash_name = spu2_hash_type_name(hash_type);\r\npacket_log(" Hash type: %s\n", hash_name);\r\nif (hash_type != SPU2_HASH_TYPE_NONE) {\r\nhash_mode = (ctrl0 & SPU2_HASH_MODE) >> SPU2_HASH_MODE_SHIFT;\r\nhash_mode_name = spu2_hash_mode_name(hash_mode);\r\npacket_log(" Hash mode: %s\n", hash_mode_name);\r\n}\r\nif (ctrl0 & SPU2_CIPH_PAD_EN) {\r\npacket_log(" Cipher pad: %#2llx\n",\r\n(ctrl0 & SPU2_CIPH_PAD) >> SPU2_CIPH_PAD_SHIFT);\r\n}\r\n}\r\nstatic void spu2_dump_fmd_ctrl1(u64 ctrl1)\r\n{\r\nu8 hash_key_len;\r\nu8 ciph_key_len;\r\nu8 ret_iv_len;\r\nu8 iv_offset;\r\nu8 iv_len;\r\nu8 hash_tag_len;\r\nu8 ret_md;\r\npacket_log(" FMD CTRL1 %#16llx\n", ctrl1);\r\nif (ctrl1 & SPU2_TAG_LOC)\r\npacket_log(" Tag after payload\n");\r\npacket_log(" Msg includes ");\r\nif (ctrl1 & SPU2_HAS_FR_DATA)\r\npacket_log("FD ");\r\nif (ctrl1 & SPU2_HAS_AAD1)\r\npacket_log("AAD1 ");\r\nif (ctrl1 & SPU2_HAS_NAAD)\r\npacket_log("NAAD ");\r\nif (ctrl1 & SPU2_HAS_AAD2)\r\npacket_log("AAD2 ");\r\nif (ctrl1 & SPU2_HAS_ESN)\r\npacket_log("ESN ");\r\npacket_log("\n");\r\nhash_key_len = (ctrl1 & SPU2_HASH_KEY_LEN) >> SPU2_HASH_KEY_LEN_SHIFT;\r\npacket_log(" Hash key len %u\n", hash_key_len);\r\nciph_key_len = (ctrl1 & SPU2_CIPH_KEY_LEN) >> SPU2_CIPH_KEY_LEN_SHIFT;\r\npacket_log(" Cipher key len %u\n", ciph_key_len);\r\nif (ctrl1 & SPU2_GENIV)\r\npacket_log(" Generate IV\n");\r\nif (ctrl1 & SPU2_HASH_IV)\r\npacket_log(" IV included in hash\n");\r\nif (ctrl1 & SPU2_RET_IV)\r\npacket_log(" Return IV in output before payload\n");\r\nret_iv_len = (ctrl1 & SPU2_RET_IV_LEN) >> SPU2_RET_IV_LEN_SHIFT;\r\npacket_log(" Length of returned IV %u bytes\n",\r\nret_iv_len ? ret_iv_len : 16);\r\niv_offset = (ctrl1 & SPU2_IV_OFFSET) >> SPU2_IV_OFFSET_SHIFT;\r\npacket_log(" IV offset %u\n", iv_offset);\r\niv_len = (ctrl1 & SPU2_IV_LEN) >> SPU2_IV_LEN_SHIFT;\r\npacket_log(" Input IV len %u bytes\n", iv_len);\r\nhash_tag_len = (ctrl1 & SPU2_HASH_TAG_LEN) >> SPU2_HASH_TAG_LEN_SHIFT;\r\npacket_log(" Hash tag length %u bytes\n", hash_tag_len);\r\npacket_log(" Return ");\r\nret_md = (ctrl1 & SPU2_RETURN_MD) >> SPU2_RETURN_MD_SHIFT;\r\nif (ret_md)\r\npacket_log("FMD ");\r\nif (ret_md == SPU2_RET_FMD_OMD)\r\npacket_log("OMD ");\r\nelse if (ret_md == SPU2_RET_FMD_OMD_IV)\r\npacket_log("OMD IV ");\r\nif (ctrl1 & SPU2_RETURN_FD)\r\npacket_log("FD ");\r\nif (ctrl1 & SPU2_RETURN_AAD1)\r\npacket_log("AAD1 ");\r\nif (ctrl1 & SPU2_RETURN_NAAD)\r\npacket_log("NAAD ");\r\nif (ctrl1 & SPU2_RETURN_AAD2)\r\npacket_log("AAD2 ");\r\nif (ctrl1 & SPU2_RETURN_PAY)\r\npacket_log("Payload");\r\npacket_log("\n");\r\n}\r\nstatic void spu2_dump_fmd_ctrl2(u64 ctrl2)\r\n{\r\npacket_log(" FMD CTRL2 %#16llx\n", ctrl2);\r\npacket_log(" AAD1 offset %llu length %llu bytes\n",\r\nctrl2 & SPU2_AAD1_OFFSET,\r\n(ctrl2 & SPU2_AAD1_LEN) >> SPU2_AAD1_LEN_SHIFT);\r\npacket_log(" AAD2 offset %llu\n",\r\n(ctrl2 & SPU2_AAD2_OFFSET) >> SPU2_AAD2_OFFSET_SHIFT);\r\npacket_log(" Payload offset %llu\n",\r\n(ctrl2 & SPU2_PL_OFFSET) >> SPU2_PL_OFFSET_SHIFT);\r\n}\r\nstatic void spu2_dump_fmd_ctrl3(u64 ctrl3)\r\n{\r\npacket_log(" FMD CTRL3 %#16llx\n", ctrl3);\r\npacket_log(" Payload length %llu bytes\n", ctrl3 & SPU2_PL_LEN);\r\npacket_log(" TLS length %llu bytes\n",\r\n(ctrl3 & SPU2_TLS_LEN) >> SPU2_TLS_LEN_SHIFT);\r\n}\r\nstatic void spu2_dump_fmd(struct SPU2_FMD *fmd)\r\n{\r\nspu2_dump_fmd_ctrl0(le64_to_cpu(fmd->ctrl0));\r\nspu2_dump_fmd_ctrl1(le64_to_cpu(fmd->ctrl1));\r\nspu2_dump_fmd_ctrl2(le64_to_cpu(fmd->ctrl2));\r\nspu2_dump_fmd_ctrl3(le64_to_cpu(fmd->ctrl3));\r\n}\r\nstatic void spu2_dump_omd(u8 *omd, u16 hash_key_len, u16 ciph_key_len,\r\nu16 hash_iv_len, u16 ciph_iv_len)\r\n{\r\nu8 *ptr = omd;\r\npacket_log(" OMD:\n");\r\nif (hash_key_len) {\r\npacket_log(" Hash Key Length %u bytes\n", hash_key_len);\r\npacket_dump(" KEY: ", ptr, hash_key_len);\r\nptr += hash_key_len;\r\n}\r\nif (ciph_key_len) {\r\npacket_log(" Cipher Key Length %u bytes\n", ciph_key_len);\r\npacket_dump(" KEY: ", ptr, ciph_key_len);\r\nptr += ciph_key_len;\r\n}\r\nif (hash_iv_len) {\r\npacket_log(" Hash IV Length %u bytes\n", hash_iv_len);\r\npacket_dump(" hash IV: ", ptr, hash_iv_len);\r\nptr += ciph_key_len;\r\n}\r\nif (ciph_iv_len) {\r\npacket_log(" Cipher IV Length %u bytes\n", ciph_iv_len);\r\npacket_dump(" cipher IV: ", ptr, ciph_iv_len);\r\n}\r\n}\r\nvoid spu2_dump_msg_hdr(u8 *buf, unsigned int buf_len)\r\n{\r\nstruct SPU2_FMD *fmd = (struct SPU2_FMD *)buf;\r\nu8 *omd;\r\nu64 ctrl1;\r\nu16 hash_key_len;\r\nu16 ciph_key_len;\r\nu16 hash_iv_len;\r\nu16 ciph_iv_len;\r\nu16 omd_len;\r\npacket_log("\n");\r\npacket_log("SPU2 message header %p len: %u\n", buf, buf_len);\r\nspu2_dump_fmd(fmd);\r\nomd = (u8 *)(fmd + 1);\r\nctrl1 = le64_to_cpu(fmd->ctrl1);\r\nhash_key_len = (ctrl1 & SPU2_HASH_KEY_LEN) >> SPU2_HASH_KEY_LEN_SHIFT;\r\nciph_key_len = (ctrl1 & SPU2_CIPH_KEY_LEN) >> SPU2_CIPH_KEY_LEN_SHIFT;\r\nhash_iv_len = 0;\r\nciph_iv_len = (ctrl1 & SPU2_IV_LEN) >> SPU2_IV_LEN_SHIFT;\r\nspu2_dump_omd(omd, hash_key_len, ciph_key_len, hash_iv_len,\r\nciph_iv_len);\r\nomd_len = hash_key_len + ciph_key_len + hash_iv_len + ciph_iv_len;\r\nif (FMD_SIZE + omd_len != buf_len) {\r\npacket_log\r\n(" Packet parsed incorrectly. buf_len %u, sum of MD %zu\n",\r\nbuf_len, FMD_SIZE + omd_len);\r\n}\r\npacket_log("\n");\r\n}\r\nstatic int spu2_fmd_init(struct SPU2_FMD *fmd,\r\nenum spu2_cipher_type spu2_type,\r\nenum spu2_cipher_mode spu2_mode,\r\nu32 cipher_key_len, u32 cipher_iv_len)\r\n{\r\nu64 ctrl0;\r\nu64 ctrl1;\r\nu64 ctrl2;\r\nu64 ctrl3;\r\nu32 aad1_offset;\r\nu32 aad2_offset;\r\nu16 aad1_len = 0;\r\nu64 payload_offset;\r\nctrl0 = (spu2_type << SPU2_CIPH_TYPE_SHIFT) |\r\n(spu2_mode << SPU2_CIPH_MODE_SHIFT);\r\nctrl1 = (cipher_key_len << SPU2_CIPH_KEY_LEN_SHIFT) |\r\n((u64)cipher_iv_len << SPU2_IV_LEN_SHIFT) |\r\n((u64)SPU2_RET_FMD_ONLY << SPU2_RETURN_MD_SHIFT) | SPU2_RETURN_PAY;\r\naad1_offset = 0;\r\naad2_offset = aad1_offset;\r\npayload_offset = 0;\r\nctrl2 = aad1_offset |\r\n(aad1_len << SPU2_AAD1_LEN_SHIFT) |\r\n(aad2_offset << SPU2_AAD2_OFFSET_SHIFT) |\r\n(payload_offset << SPU2_PL_OFFSET_SHIFT);\r\nctrl3 = 0;\r\nfmd->ctrl0 = cpu_to_le64(ctrl0);\r\nfmd->ctrl1 = cpu_to_le64(ctrl1);\r\nfmd->ctrl2 = cpu_to_le64(ctrl2);\r\nfmd->ctrl3 = cpu_to_le64(ctrl3);\r\nreturn 0;\r\n}\r\nstatic void spu2_fmd_ctrl0_write(struct SPU2_FMD *fmd,\r\nbool is_inbound, bool auth_first,\r\nenum spu2_proto_sel protocol,\r\nenum spu2_cipher_type cipher_type,\r\nenum spu2_cipher_mode cipher_mode,\r\nenum spu2_hash_type auth_type,\r\nenum spu2_hash_mode auth_mode)\r\n{\r\nu64 ctrl0 = 0;\r\nif ((cipher_type != SPU2_CIPHER_TYPE_NONE) && !is_inbound)\r\nctrl0 |= SPU2_CIPH_ENCRYPT_EN;\r\nctrl0 |= ((u64)cipher_type << SPU2_CIPH_TYPE_SHIFT) |\r\n((u64)cipher_mode << SPU2_CIPH_MODE_SHIFT);\r\nif (protocol)\r\nctrl0 |= (u64)protocol << SPU2_PROTO_SEL_SHIFT;\r\nif (auth_first)\r\nctrl0 |= SPU2_HASH_FIRST;\r\nif (is_inbound && (auth_type != SPU2_HASH_TYPE_NONE))\r\nctrl0 |= SPU2_CHK_TAG;\r\nctrl0 |= (((u64)auth_type << SPU2_HASH_TYPE_SHIFT) |\r\n((u64)auth_mode << SPU2_HASH_MODE_SHIFT));\r\nfmd->ctrl0 = cpu_to_le64(ctrl0);\r\n}\r\nstatic void spu2_fmd_ctrl1_write(struct SPU2_FMD *fmd, bool is_inbound,\r\nu64 assoc_size,\r\nu64 auth_key_len, u64 cipher_key_len,\r\nbool gen_iv, bool hash_iv, bool return_iv,\r\nu64 ret_iv_len, u64 ret_iv_offset,\r\nu64 cipher_iv_len, u64 digest_size,\r\nbool return_payload, bool return_md)\r\n{\r\nu64 ctrl1 = 0;\r\nif (is_inbound && digest_size)\r\nctrl1 |= SPU2_TAG_LOC;\r\nif (assoc_size) {\r\nctrl1 |= SPU2_HAS_AAD2;\r\nctrl1 |= SPU2_RETURN_AAD2;\r\n}\r\nif (auth_key_len)\r\nctrl1 |= ((auth_key_len << SPU2_HASH_KEY_LEN_SHIFT) &\r\nSPU2_HASH_KEY_LEN);\r\nif (cipher_key_len)\r\nctrl1 |= ((cipher_key_len << SPU2_CIPH_KEY_LEN_SHIFT) &\r\nSPU2_CIPH_KEY_LEN);\r\nif (gen_iv)\r\nctrl1 |= SPU2_GENIV;\r\nif (hash_iv)\r\nctrl1 |= SPU2_HASH_IV;\r\nif (return_iv) {\r\nctrl1 |= SPU2_RET_IV;\r\nctrl1 |= ret_iv_len << SPU2_RET_IV_LEN_SHIFT;\r\nctrl1 |= ret_iv_offset << SPU2_IV_OFFSET_SHIFT;\r\n}\r\nctrl1 |= ((cipher_iv_len << SPU2_IV_LEN_SHIFT) & SPU2_IV_LEN);\r\nif (digest_size)\r\nctrl1 |= ((digest_size << SPU2_HASH_TAG_LEN_SHIFT) &\r\nSPU2_HASH_TAG_LEN);\r\nif (return_md)\r\nctrl1 |= ((u64)SPU2_RET_FMD_ONLY << SPU2_RETURN_MD_SHIFT);\r\nelse\r\nctrl1 |= ((u64)SPU2_RET_NO_MD << SPU2_RETURN_MD_SHIFT);\r\nif (return_payload)\r\nctrl1 |= SPU2_RETURN_PAY;\r\nfmd->ctrl1 = cpu_to_le64(ctrl1);\r\n}\r\nstatic void spu2_fmd_ctrl2_write(struct SPU2_FMD *fmd, u64 cipher_offset,\r\nu64 auth_key_len, u64 auth_iv_len,\r\nu64 cipher_key_len, u64 cipher_iv_len)\r\n{\r\nu64 ctrl2;\r\nu64 aad1_offset;\r\nu64 aad2_offset;\r\nu16 aad1_len = 0;\r\nu64 payload_offset;\r\naad1_offset = 0;\r\naad2_offset = aad1_offset;\r\npayload_offset = cipher_offset;\r\nctrl2 = aad1_offset |\r\n(aad1_len << SPU2_AAD1_LEN_SHIFT) |\r\n(aad2_offset << SPU2_AAD2_OFFSET_SHIFT) |\r\n(payload_offset << SPU2_PL_OFFSET_SHIFT);\r\nfmd->ctrl2 = cpu_to_le64(ctrl2);\r\n}\r\nstatic void spu2_fmd_ctrl3_write(struct SPU2_FMD *fmd, u64 payload_len)\r\n{\r\nu64 ctrl3;\r\nctrl3 = payload_len & SPU2_PL_LEN;\r\nfmd->ctrl3 = cpu_to_le64(ctrl3);\r\n}\r\nu32 spu2_ctx_max_payload(enum spu_cipher_alg cipher_alg,\r\nenum spu_cipher_mode cipher_mode,\r\nunsigned int blocksize)\r\n{\r\nif ((cipher_alg == CIPHER_ALG_AES) &&\r\n(cipher_mode == CIPHER_MODE_CCM)) {\r\nu32 excess = SPU2_MAX_PAYLOAD % blocksize;\r\nreturn SPU2_MAX_PAYLOAD - excess;\r\n} else {\r\nreturn SPU_MAX_PAYLOAD_INF;\r\n}\r\n}\r\nu32 spu2_payload_length(u8 *spu_hdr)\r\n{\r\nstruct SPU2_FMD *fmd = (struct SPU2_FMD *)spu_hdr;\r\nu32 pl_len;\r\nu64 ctrl3;\r\nctrl3 = le64_to_cpu(fmd->ctrl3);\r\npl_len = ctrl3 & SPU2_PL_LEN;\r\nreturn pl_len;\r\n}\r\nu16 spu2_response_hdr_len(u16 auth_key_len, u16 enc_key_len, bool is_hash)\r\n{\r\nreturn FMD_SIZE;\r\n}\r\nu16 spu2_hash_pad_len(enum hash_alg hash_alg, enum hash_mode hash_mode,\r\nu32 chunksize, u16 hash_block_size)\r\n{\r\nreturn 0;\r\n}\r\nu32 spu2_gcm_ccm_pad_len(enum spu_cipher_mode cipher_mode,\r\nunsigned int data_size)\r\n{\r\nreturn 0;\r\n}\r\nu32 spu2_assoc_resp_len(enum spu_cipher_mode cipher_mode,\r\nunsigned int assoc_len, unsigned int iv_len,\r\nbool is_encrypt)\r\n{\r\nu32 resp_len = assoc_len;\r\nif (is_encrypt)\r\nresp_len += iv_len;\r\nreturn resp_len;\r\n}\r\nu8 spu2_aead_ivlen(enum spu_cipher_mode cipher_mode, u16 iv_len)\r\n{\r\nreturn 0;\r\n}\r\nenum hash_type spu2_hash_type(u32 src_sent)\r\n{\r\nreturn HASH_TYPE_FULL;\r\n}\r\nu32 spu2_digest_size(u32 alg_digest_size, enum hash_alg alg,\r\nenum hash_type htype)\r\n{\r\nreturn alg_digest_size;\r\n}\r\nu32 spu2_create_request(u8 *spu_hdr,\r\nstruct spu_request_opts *req_opts,\r\nstruct spu_cipher_parms *cipher_parms,\r\nstruct spu_hash_parms *hash_parms,\r\nstruct spu_aead_parms *aead_parms,\r\nunsigned int data_size)\r\n{\r\nstruct SPU2_FMD *fmd;\r\nu8 *ptr;\r\nunsigned int buf_len;\r\nint err;\r\nenum spu2_cipher_type spu2_ciph_type = SPU2_CIPHER_TYPE_NONE;\r\nenum spu2_cipher_mode spu2_ciph_mode;\r\nenum spu2_hash_type spu2_auth_type = SPU2_HASH_TYPE_NONE;\r\nenum spu2_hash_mode spu2_auth_mode;\r\nbool return_md = true;\r\nenum spu2_proto_sel proto = SPU2_PROTO_RESV;\r\nunsigned int payload_len =\r\nhash_parms->prebuf_len + data_size + hash_parms->pad_len -\r\n((req_opts->is_aead && req_opts->is_inbound) ?\r\nhash_parms->digestsize : 0);\r\nunsigned int cipher_offset = aead_parms->assoc_size +\r\naead_parms->aad_pad_len + aead_parms->iv_len;\r\n#ifdef DEBUG\r\nunsigned int real_db_size = spu_real_db_size(aead_parms->assoc_size,\r\naead_parms->iv_len,\r\nhash_parms->prebuf_len,\r\ndata_size,\r\naead_parms->aad_pad_len,\r\naead_parms->data_pad_len,\r\nhash_parms->pad_len);\r\n#endif\r\nunsigned int assoc_size = aead_parms->assoc_size;\r\nif (req_opts->is_aead &&\r\n(cipher_parms->alg == CIPHER_ALG_AES) &&\r\n(cipher_parms->mode == CIPHER_MODE_GCM))\r\nreq_opts->auth_first = req_opts->is_inbound;\r\nif (req_opts->is_aead &&\r\n(cipher_parms->alg == CIPHER_ALG_AES) &&\r\n(cipher_parms->mode == CIPHER_MODE_CCM))\r\nreq_opts->auth_first = !req_opts->is_inbound;\r\nflow_log("%s()\n", __func__);\r\nflow_log(" in:%u authFirst:%u\n",\r\nreq_opts->is_inbound, req_opts->auth_first);\r\nflow_log(" cipher alg:%u mode:%u type %u\n", cipher_parms->alg,\r\ncipher_parms->mode, cipher_parms->type);\r\nflow_log(" is_esp: %s\n", req_opts->is_esp ? "yes" : "no");\r\nflow_log(" key: %d\n", cipher_parms->key_len);\r\nflow_dump(" key: ", cipher_parms->key_buf, cipher_parms->key_len);\r\nflow_log(" iv: %d\n", cipher_parms->iv_len);\r\nflow_dump(" iv: ", cipher_parms->iv_buf, cipher_parms->iv_len);\r\nflow_log(" auth alg:%u mode:%u type %u\n",\r\nhash_parms->alg, hash_parms->mode, hash_parms->type);\r\nflow_log(" digestsize: %u\n", hash_parms->digestsize);\r\nflow_log(" authkey: %d\n", hash_parms->key_len);\r\nflow_dump(" authkey: ", hash_parms->key_buf, hash_parms->key_len);\r\nflow_log(" assoc_size:%u\n", assoc_size);\r\nflow_log(" prebuf_len:%u\n", hash_parms->prebuf_len);\r\nflow_log(" data_size:%u\n", data_size);\r\nflow_log(" hash_pad_len:%u\n", hash_parms->pad_len);\r\nflow_log(" real_db_size:%u\n", real_db_size);\r\nflow_log(" cipher_offset:%u payload_len:%u\n",\r\ncipher_offset, payload_len);\r\nflow_log(" aead_iv: %u\n", aead_parms->iv_len);\r\nerr = spu2_cipher_xlate(cipher_parms->alg, cipher_parms->mode,\r\ncipher_parms->type,\r\n&spu2_ciph_type, &spu2_ciph_mode);\r\nif ((req_opts->is_rfc4543) ||\r\n((spu2_ciph_mode == SPU2_CIPHER_MODE_GCM) &&\r\n(payload_len == 0))) {\r\nspu2_ciph_type = SPU2_CIPHER_TYPE_NONE;\r\nhash_parms->key_len = cipher_parms->key_len;\r\nmemcpy(hash_parms->key_buf, cipher_parms->key_buf,\r\ncipher_parms->key_len);\r\ncipher_parms->key_len = 0;\r\nif (req_opts->is_rfc4543)\r\npayload_len += assoc_size;\r\nelse\r\npayload_len = assoc_size;\r\ncipher_offset = 0;\r\nassoc_size = 0;\r\n}\r\nif (err)\r\nreturn 0;\r\nflow_log("spu2 cipher type %s, cipher mode %s\n",\r\nspu2_ciph_type_name(spu2_ciph_type),\r\nspu2_ciph_mode_name(spu2_ciph_mode));\r\nerr = spu2_hash_xlate(hash_parms->alg, hash_parms->mode,\r\nhash_parms->type,\r\ncipher_parms->type,\r\n&spu2_auth_type, &spu2_auth_mode);\r\nif (err)\r\nreturn 0;\r\nflow_log("spu2 hash type %s, hash mode %s\n",\r\nspu2_hash_type_name(spu2_auth_type),\r\nspu2_hash_mode_name(spu2_auth_mode));\r\nfmd = (struct SPU2_FMD *)spu_hdr;\r\nspu2_fmd_ctrl0_write(fmd, req_opts->is_inbound, req_opts->auth_first,\r\nproto, spu2_ciph_type, spu2_ciph_mode,\r\nspu2_auth_type, spu2_auth_mode);\r\nspu2_fmd_ctrl1_write(fmd, req_opts->is_inbound, assoc_size,\r\nhash_parms->key_len, cipher_parms->key_len,\r\nfalse, false,\r\naead_parms->return_iv, aead_parms->ret_iv_len,\r\naead_parms->ret_iv_off,\r\ncipher_parms->iv_len, hash_parms->digestsize,\r\n!req_opts->bd_suppress, return_md);\r\nspu2_fmd_ctrl2_write(fmd, cipher_offset, hash_parms->key_len, 0,\r\ncipher_parms->key_len, cipher_parms->iv_len);\r\nspu2_fmd_ctrl3_write(fmd, payload_len);\r\nptr = (u8 *)(fmd + 1);\r\nbuf_len = sizeof(struct SPU2_FMD);\r\nif (hash_parms->key_len) {\r\nmemcpy(ptr, hash_parms->key_buf, hash_parms->key_len);\r\nptr += hash_parms->key_len;\r\nbuf_len += hash_parms->key_len;\r\n}\r\nif (cipher_parms->key_len) {\r\nmemcpy(ptr, cipher_parms->key_buf, cipher_parms->key_len);\r\nptr += cipher_parms->key_len;\r\nbuf_len += cipher_parms->key_len;\r\n}\r\nif (cipher_parms->iv_len) {\r\nmemcpy(ptr, cipher_parms->iv_buf, cipher_parms->iv_len);\r\nptr += cipher_parms->iv_len;\r\nbuf_len += cipher_parms->iv_len;\r\n}\r\npacket_dump(" SPU request header: ", spu_hdr, buf_len);\r\nreturn buf_len;\r\n}\r\nu16 spu2_cipher_req_init(u8 *spu_hdr, struct spu_cipher_parms *cipher_parms)\r\n{\r\nstruct SPU2_FMD *fmd;\r\nu8 *omd;\r\nenum spu2_cipher_type spu2_type = SPU2_CIPHER_TYPE_NONE;\r\nenum spu2_cipher_mode spu2_mode;\r\nint err;\r\nflow_log("%s()\n", __func__);\r\nflow_log(" cipher alg:%u mode:%u type %u\n", cipher_parms->alg,\r\ncipher_parms->mode, cipher_parms->type);\r\nflow_log(" cipher_iv_len: %u\n", cipher_parms->iv_len);\r\nflow_log(" key: %d\n", cipher_parms->key_len);\r\nflow_dump(" key: ", cipher_parms->key_buf, cipher_parms->key_len);\r\nerr = spu2_cipher_xlate(cipher_parms->alg, cipher_parms->mode,\r\ncipher_parms->type, &spu2_type, &spu2_mode);\r\nif (err)\r\nreturn 0;\r\nflow_log("spu2 cipher type %s, cipher mode %s\n",\r\nspu2_ciph_type_name(spu2_type),\r\nspu2_ciph_mode_name(spu2_mode));\r\nfmd = (struct SPU2_FMD *)spu_hdr;\r\nerr = spu2_fmd_init(fmd, spu2_type, spu2_mode, cipher_parms->key_len,\r\ncipher_parms->iv_len);\r\nif (err)\r\nreturn 0;\r\nomd = (u8 *)(fmd + 1);\r\nif (cipher_parms->key_buf && cipher_parms->key_len)\r\nmemcpy(omd, cipher_parms->key_buf, cipher_parms->key_len);\r\npacket_dump(" SPU request header: ", spu_hdr,\r\nFMD_SIZE + cipher_parms->key_len + cipher_parms->iv_len);\r\nreturn FMD_SIZE + cipher_parms->key_len + cipher_parms->iv_len;\r\n}\r\nvoid spu2_cipher_req_finish(u8 *spu_hdr,\r\nu16 spu_req_hdr_len,\r\nunsigned int is_inbound,\r\nstruct spu_cipher_parms *cipher_parms,\r\nbool update_key,\r\nunsigned int data_size)\r\n{\r\nstruct SPU2_FMD *fmd;\r\nu8 *omd;\r\nu64 ctrl0;\r\nu64 ctrl3;\r\nflow_log("%s()\n", __func__);\r\nflow_log(" in: %u\n", is_inbound);\r\nflow_log(" cipher alg: %u, cipher_type: %u\n", cipher_parms->alg,\r\ncipher_parms->type);\r\nif (update_key) {\r\nflow_log(" cipher key len: %u\n", cipher_parms->key_len);\r\nflow_dump(" key: ", cipher_parms->key_buf,\r\ncipher_parms->key_len);\r\n}\r\nflow_log(" iv len: %d\n", cipher_parms->iv_len);\r\nflow_dump(" iv: ", cipher_parms->iv_buf, cipher_parms->iv_len);\r\nflow_log(" data_size: %u\n", data_size);\r\nfmd = (struct SPU2_FMD *)spu_hdr;\r\nomd = (u8 *)(fmd + 1);\r\nctrl0 = le64_to_cpu(fmd->ctrl0);\r\nif (is_inbound)\r\nctrl0 &= ~SPU2_CIPH_ENCRYPT_EN;\r\nelse\r\nctrl0 |= SPU2_CIPH_ENCRYPT_EN;\r\nfmd->ctrl0 = cpu_to_le64(ctrl0);\r\nif (cipher_parms->alg && cipher_parms->iv_buf && cipher_parms->iv_len) {\r\nmemcpy(omd + cipher_parms->key_len, cipher_parms->iv_buf,\r\ncipher_parms->iv_len);\r\n}\r\nctrl3 = le64_to_cpu(fmd->ctrl3);\r\ndata_size &= SPU2_PL_LEN;\r\nctrl3 |= data_size;\r\nfmd->ctrl3 = cpu_to_le64(ctrl3);\r\npacket_dump(" SPU request header: ", spu_hdr, spu_req_hdr_len);\r\n}\r\nvoid spu2_request_pad(u8 *pad_start, u32 gcm_padding, u32 hash_pad_len,\r\nenum hash_alg auth_alg, enum hash_mode auth_mode,\r\nunsigned int total_sent, u32 status_padding)\r\n{\r\nu8 *ptr = pad_start;\r\nif (gcm_padding > 0) {\r\nflow_log(" GCM: padding to 16 byte alignment: %u bytes\n",\r\ngcm_padding);\r\nmemset(ptr, 0, gcm_padding);\r\nptr += gcm_padding;\r\n}\r\nif (hash_pad_len > 0) {\r\nmemset(ptr, 0, hash_pad_len);\r\n*ptr = 0x80;\r\nptr += (hash_pad_len - sizeof(u64));\r\nif (auth_alg == HASH_ALG_MD5)\r\n*(u64 *)ptr = cpu_to_le64((u64)total_sent * 8);\r\nelse\r\n*(u64 *)ptr = cpu_to_be64((u64)total_sent * 8);\r\nptr += sizeof(u64);\r\n}\r\nif (status_padding > 0) {\r\nflow_log(" STAT: padding to 4 byte alignment: %u bytes\n",\r\nstatus_padding);\r\nmemset(ptr, 0, status_padding);\r\nptr += status_padding;\r\n}\r\n}\r\nu8 spu2_xts_tweak_in_payload(void)\r\n{\r\nreturn 0;\r\n}\r\nu8 spu2_tx_status_len(void)\r\n{\r\nreturn SPU2_TX_STATUS_LEN;\r\n}\r\nu8 spu2_rx_status_len(void)\r\n{\r\nreturn SPU2_RX_STATUS_LEN;\r\n}\r\nint spu2_status_process(u8 *statp)\r\n{\r\nu16 status = le16_to_cpu(*(__le16 *)statp);\r\nif (status == 0)\r\nreturn 0;\r\nflow_log("rx status is %#x\n", status);\r\nif (status == SPU2_INVALID_ICV)\r\nreturn SPU_INVALID_ICV;\r\nreturn -EBADMSG;\r\n}\r\nvoid spu2_ccm_update_iv(unsigned int digestsize,\r\nstruct spu_cipher_parms *cipher_parms,\r\nunsigned int assoclen, unsigned int chunksize,\r\nbool is_encrypt, bool is_esp)\r\n{\r\nint L;\r\nif (is_esp)\r\nL = CCM_ESP_L_VALUE;\r\nelse\r\nL = ((cipher_parms->iv_buf[0] & CCM_B0_L_PRIME) >>\r\nCCM_B0_L_PRIME_SHIFT) + 1;\r\ncipher_parms->iv_len -= (1 + L);\r\nmemmove(cipher_parms->iv_buf, &cipher_parms->iv_buf[1],\r\ncipher_parms->iv_len);\r\n}\r\nu32 spu2_wordalign_padlen(u32 data_size)\r\n{\r\nreturn 0;\r\n}

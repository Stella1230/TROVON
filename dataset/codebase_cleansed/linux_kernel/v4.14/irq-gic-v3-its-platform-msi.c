static int of_pmsi_get_dev_id(struct irq_domain *domain, struct device *dev,\r\nu32 *dev_id)\r\n{\r\nint ret, index = 0;\r\ndo {\r\nstruct of_phandle_args args;\r\nret = of_parse_phandle_with_args(dev->of_node,\r\n"msi-parent", "#msi-cells",\r\nindex, &args);\r\nif (args.np == irq_domain_get_of_node(domain)) {\r\nif (WARN_ON(args.args_count != 1))\r\nreturn -EINVAL;\r\n*dev_id = args.args[0];\r\nbreak;\r\n}\r\nindex++;\r\n} while (!ret);\r\nreturn ret;\r\n}\r\nint __weak iort_pmsi_get_dev_id(struct device *dev, u32 *dev_id)\r\n{\r\nreturn -1;\r\n}\r\nstatic int its_pmsi_prepare(struct irq_domain *domain, struct device *dev,\r\nint nvec, msi_alloc_info_t *info)\r\n{\r\nstruct msi_domain_info *msi_info;\r\nu32 dev_id;\r\nint ret;\r\nmsi_info = msi_get_domain_info(domain->parent);\r\nif (dev->of_node)\r\nret = of_pmsi_get_dev_id(domain, dev, &dev_id);\r\nelse\r\nret = iort_pmsi_get_dev_id(dev, &dev_id);\r\nif (ret)\r\nreturn ret;\r\ninfo->scratchpad[0].ul = dev_id;\r\nreturn msi_info->ops->msi_prepare(domain->parent,\r\ndev, nvec, info);\r\n}\r\nstatic int __init its_pmsi_init_one(struct fwnode_handle *fwnode,\r\nconst char *name)\r\n{\r\nstruct irq_domain *parent;\r\nparent = irq_find_matching_fwnode(fwnode, DOMAIN_BUS_NEXUS);\r\nif (!parent || !msi_get_domain_info(parent)) {\r\npr_err("%s: unable to locate ITS domain\n", name);\r\nreturn -ENXIO;\r\n}\r\nif (!platform_msi_create_irq_domain(fwnode, &its_pmsi_domain_info,\r\nparent)) {\r\npr_err("%s: unable to create platform domain\n", name);\r\nreturn -ENXIO;\r\n}\r\npr_info("Platform MSI: %s domain created\n", name);\r\nreturn 0;\r\n}\r\nstatic int __init\r\nits_pmsi_parse_madt(struct acpi_subtable_header *header,\r\nconst unsigned long end)\r\n{\r\nstruct acpi_madt_generic_translator *its_entry;\r\nstruct fwnode_handle *domain_handle;\r\nconst char *node_name;\r\nint err = -ENXIO;\r\nits_entry = (struct acpi_madt_generic_translator *)header;\r\nnode_name = kasprintf(GFP_KERNEL, "ITS@0x%lx",\r\n(long)its_entry->base_address);\r\ndomain_handle = iort_find_domain_token(its_entry->translation_id);\r\nif (!domain_handle) {\r\npr_err("%s: Unable to locate ITS domain handle\n", node_name);\r\ngoto out;\r\n}\r\nerr = its_pmsi_init_one(domain_handle, node_name);\r\nout:\r\nkfree(node_name);\r\nreturn err;\r\n}\r\nstatic void __init its_pmsi_acpi_init(void)\r\n{\r\nacpi_table_parse_madt(ACPI_MADT_TYPE_GENERIC_TRANSLATOR,\r\nits_pmsi_parse_madt, 0);\r\n}\r\nstatic inline void its_pmsi_acpi_init(void) { }\r\nstatic void __init its_pmsi_of_init(void)\r\n{\r\nstruct device_node *np;\r\nfor (np = of_find_matching_node(NULL, its_device_id); np;\r\nnp = of_find_matching_node(np, its_device_id)) {\r\nif (!of_property_read_bool(np, "msi-controller"))\r\ncontinue;\r\nits_pmsi_init_one(of_node_to_fwnode(np), np->full_name);\r\n}\r\n}\r\nstatic int __init its_pmsi_init(void)\r\n{\r\nits_pmsi_of_init();\r\nits_pmsi_acpi_init();\r\nreturn 0;\r\n}

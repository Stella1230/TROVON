void up_clk(_adapter *padapter, u16 *x)\r\n{\r\n_func_enter_;\r\n*x = *x | _EESK;\r\nrtw_write8(padapter, EE_9346CR, (u8)*x);\r\nudelay(CLOCK_RATE);\r\n_func_exit_;\r\n}\r\nvoid down_clk(_adapter *padapter, u16 *x)\r\n{\r\n_func_enter_;\r\n*x = *x & ~_EESK;\r\nrtw_write8(padapter, EE_9346CR, (u8)*x);\r\nudelay(CLOCK_RATE);\r\n_func_exit_;\r\n}\r\nvoid shift_out_bits(_adapter *padapter, u16 data, u16 count)\r\n{\r\nu16 x, mask;\r\n_func_enter_;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nmask = 0x01 << (count - 1);\r\nx = rtw_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDO | _EEDI);\r\ndo {\r\nx &= ~_EEDI;\r\nif (data & mask)\r\nx |= _EEDI;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nrtw_write8(padapter, EE_9346CR, (u8)x);\r\nudelay(CLOCK_RATE);\r\nup_clk(padapter, &x);\r\ndown_clk(padapter, &x);\r\nmask = mask >> 1;\r\n} while (mask);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx &= ~_EEDI;\r\nrtw_write8(padapter, EE_9346CR, (u8)x);\r\nout:\r\n_func_exit_;\r\n}\r\nu16 shift_in_bits(_adapter *padapter)\r\n{\r\nu16 x, d = 0, i;\r\n_func_enter_;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx = rtw_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDO | _EEDI);\r\nd = 0;\r\nfor (i = 0; i < 16; i++) {\r\nd = d << 1;\r\nup_clk(padapter, &x);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx = rtw_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDI);\r\nif (x & _EEDO)\r\nd |= 1;\r\ndown_clk(padapter, &x);\r\n}\r\nout:\r\n_func_exit_;\r\nreturn d;\r\n}\r\nvoid standby(_adapter *padapter)\r\n{\r\nu8 x;\r\n_func_enter_;\r\nx = rtw_read8(padapter, EE_9346CR);\r\nx &= ~(_EECS | _EESK);\r\nrtw_write8(padapter, EE_9346CR, x);\r\nudelay(CLOCK_RATE);\r\nx |= _EECS;\r\nrtw_write8(padapter, EE_9346CR, x);\r\nudelay(CLOCK_RATE);\r\n_func_exit_;\r\n}\r\nu16 wait_eeprom_cmd_done(_adapter *padapter)\r\n{\r\nu8 x;\r\nu16 i, res = false;\r\n_func_enter_;\r\nstandby(padapter);\r\nfor (i = 0; i < 200; i++) {\r\nx = rtw_read8(padapter, EE_9346CR);\r\nif (x & _EEDO) {\r\nres = true;\r\ngoto exit;\r\n}\r\nudelay(CLOCK_RATE);\r\n}\r\nexit:\r\n_func_exit_;\r\nreturn res;\r\n}\r\nvoid eeprom_clean(_adapter *padapter)\r\n{\r\nu16 x;\r\n_func_enter_;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx = rtw_read8(padapter, EE_9346CR);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx &= ~(_EECS | _EEDI);\r\nrtw_write8(padapter, EE_9346CR, (u8)x);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nup_clk(padapter, &x);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\ndown_clk(padapter, &x);\r\nout:\r\n_func_exit_;\r\n}\r\nvoid eeprom_write16(_adapter *padapter, u16 reg, u16 data)\r\n{\r\nu8 x;\r\n_func_enter_;\r\nx = rtw_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\r\nx |= _EEM1 | _EECS;\r\nrtw_write8(padapter, EE_9346CR, x);\r\nshift_out_bits(padapter, EEPROM_EWEN_OPCODE, 5);\r\nif (padapter->EepromAddressSize == 8)\r\nshift_out_bits(padapter, 0, 6);\r\nelse\r\nshift_out_bits(padapter, 0, 4);\r\nstandby(padapter);\r\nstandby(padapter);\r\nshift_out_bits(padapter, EEPROM_WRITE_OPCODE, 3);\r\nshift_out_bits(padapter, reg, padapter->EepromAddressSize);\r\nshift_out_bits(padapter, data, 16);\r\nif (wait_eeprom_cmd_done(padapter) == false) {\r\ngoto exit;\r\n}\r\nstandby(padapter);\r\nshift_out_bits(padapter, EEPROM_EWDS_OPCODE, 5);\r\nshift_out_bits(padapter, reg, 4);\r\neeprom_clean(padapter);\r\nexit:\r\n_func_exit_;\r\nreturn;\r\n}\r\nu16 eeprom_read16(_adapter *padapter, u16 reg)\r\n{\r\nu16 x;\r\nu16 data = 0;\r\n_func_enter_;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx = rtw_read8(padapter, EE_9346CR);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\r\nx |= _EEM1 | _EECS;\r\nrtw_write8(padapter, EE_9346CR, (unsigned char)x);\r\nshift_out_bits(padapter, EEPROM_READ_OPCODE, 3);\r\nshift_out_bits(padapter, reg, padapter->EepromAddressSize);\r\ndata = shift_in_bits(padapter);\r\neeprom_clean(padapter);\r\nout:\r\n_func_exit_;\r\nreturn data;\r\n}\r\nvoid eeprom_read_sz(_adapter *padapter, u16 reg, u8 *data, u32 sz)\r\n{\r\nu16 x, data16;\r\nu32 i;\r\n_func_enter_;\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx = rtw_read8(padapter, EE_9346CR);\r\nif (padapter->bSurpriseRemoved == true) {\r\nRT_TRACE(_module_rtl871x_eeprom_c_, _drv_err_, ("padapter->bSurpriseRemoved==true"));\r\ngoto out;\r\n}\r\nx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\r\nx |= _EEM1 | _EECS;\r\nrtw_write8(padapter, EE_9346CR, (unsigned char)x);\r\nshift_out_bits(padapter, EEPROM_READ_OPCODE, 3);\r\nshift_out_bits(padapter, reg, padapter->EepromAddressSize);\r\nfor (i = 0; i < sz; i += 2) {\r\ndata16 = shift_in_bits(padapter);\r\ndata[i] = data16 & 0xff;\r\ndata[i+1] = data16 >> 8;\r\n}\r\neeprom_clean(padapter);\r\nout:\r\n_func_exit_;\r\n}\r\nu8 eeprom_read(_adapter *padapter, u32 addr_off, u8 sz, u8 *rbuf)\r\n{\r\nu8 quotient, remainder, addr_2align_odd;\r\nu16 reg, stmp, i = 0, idx = 0;\r\n_func_enter_;\r\nreg = (u16)(addr_off >> 1);\r\naddr_2align_odd = (u8)(addr_off & 0x1);\r\nif (addr_2align_odd) {\r\nstmp = eeprom_read16(padapter, reg);\r\nrbuf[idx++] = (u8) ((stmp>>8)&0xff);\r\nreg++; sz--;\r\n}\r\nquotient = sz >> 1;\r\nremainder = sz & 0x1;\r\nfor (i = 0; i < quotient; i++) {\r\nstmp = eeprom_read16(padapter, reg+i);\r\nrbuf[idx++] = (u8) (stmp&0xff);\r\nrbuf[idx++] = (u8) ((stmp>>8)&0xff);\r\n}\r\nreg = reg+i;\r\nif (remainder) {\r\nstmp = eeprom_read16(padapter, reg);\r\nrbuf[idx] = (u8)(stmp & 0xff);\r\n}\r\n_func_exit_;\r\nreturn true;\r\n}\r\nvoid read_eeprom_content(_adapter *padapter)\r\n{\r\n_func_enter_;\r\n_func_exit_;\r\n}

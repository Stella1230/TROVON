static int nfit_handle_mce(struct notifier_block *nb, unsigned long val,\r\nvoid *data)\r\n{\r\nstruct mce *mce = (struct mce *)data;\r\nstruct acpi_nfit_desc *acpi_desc;\r\nstruct nfit_spa *nfit_spa;\r\nif (!mce_is_memory_error(mce))\r\nreturn NOTIFY_DONE;\r\nmutex_lock(&acpi_desc_lock);\r\nlist_for_each_entry(acpi_desc, &acpi_descs, list) {\r\nstruct device *dev = acpi_desc->dev;\r\nint found_match = 0;\r\nmutex_lock(&acpi_desc->init_mutex);\r\nlist_for_each_entry(nfit_spa, &acpi_desc->spas, list) {\r\nstruct acpi_nfit_system_address *spa = nfit_spa->spa;\r\nif (nfit_spa_type(spa) != NFIT_SPA_PM)\r\ncontinue;\r\nif (spa->address > mce->addr)\r\ncontinue;\r\nif ((spa->address + spa->length - 1) < mce->addr)\r\ncontinue;\r\nfound_match = 1;\r\ndev_dbg(dev, "%s: addr in SPA %d (0x%llx, 0x%llx)\n",\r\n__func__, spa->range_index, spa->address,\r\nspa->length);\r\nbreak;\r\n}\r\nmutex_unlock(&acpi_desc->init_mutex);\r\nif (!found_match)\r\ncontinue;\r\nnvdimm_bus_add_poison(acpi_desc->nvdimm_bus,\r\nALIGN(mce->addr, L1_CACHE_BYTES),\r\nL1_CACHE_BYTES);\r\nnvdimm_region_notify(nfit_spa->nd_region,\r\nNVDIMM_REVALIDATE_POISON);\r\nif (acpi_desc->scrub_mode == HW_ERROR_SCRUB_ON) {\r\nacpi_nfit_ars_rescan(acpi_desc, 0);\r\n}\r\nbreak;\r\n}\r\nmutex_unlock(&acpi_desc_lock);\r\nreturn NOTIFY_DONE;\r\n}\r\nvoid nfit_mce_register(void)\r\n{\r\nmce_register_decode_chain(&nfit_mce_dec);\r\n}\r\nvoid nfit_mce_unregister(void)\r\n{\r\nmce_unregister_decode_chain(&nfit_mce_dec);\r\n}

speed_t tty_termios_baud_rate(struct ktermios *termios)\r\n{\r\nunsigned int cbaud;\r\ncbaud = termios->c_cflag & CBAUD;\r\n#ifdef BOTHER\r\nif (cbaud == BOTHER)\r\nreturn termios->c_ospeed;\r\n#endif\r\nif (cbaud & CBAUDEX) {\r\ncbaud &= ~CBAUDEX;\r\nif (cbaud < 1 || cbaud + 15 > n_baud_table)\r\ntermios->c_cflag &= ~CBAUDEX;\r\nelse\r\ncbaud += 15;\r\n}\r\nreturn baud_table[cbaud];\r\n}\r\nspeed_t tty_termios_input_baud_rate(struct ktermios *termios)\r\n{\r\n#ifdef IBSHIFT\r\nunsigned int cbaud = (termios->c_cflag >> IBSHIFT) & CBAUD;\r\nif (cbaud == B0)\r\nreturn tty_termios_baud_rate(termios);\r\nif (cbaud == BOTHER)\r\nreturn termios->c_ispeed;\r\nif (cbaud & CBAUDEX) {\r\ncbaud &= ~CBAUDEX;\r\nif (cbaud < 1 || cbaud + 15 > n_baud_table)\r\ntermios->c_cflag &= ~(CBAUDEX << IBSHIFT);\r\nelse\r\ncbaud += 15;\r\n}\r\nreturn baud_table[cbaud];\r\n#else\r\nreturn tty_termios_baud_rate(termios);\r\n#endif\r\n}\r\nvoid tty_termios_encode_baud_rate(struct ktermios *termios,\r\nspeed_t ibaud, speed_t obaud)\r\n{\r\nint i = 0;\r\nint ifound = -1, ofound = -1;\r\nint iclose = ibaud/50, oclose = obaud/50;\r\nint ibinput = 0;\r\nif (obaud == 0)\r\nibaud = 0;\r\ntermios->c_ispeed = ibaud;\r\ntermios->c_ospeed = obaud;\r\n#ifdef BOTHER\r\nif ((termios->c_cflag & CBAUD) == BOTHER)\r\noclose = 0;\r\nif (((termios->c_cflag >> IBSHIFT) & CBAUD) == BOTHER)\r\niclose = 0;\r\nif ((termios->c_cflag >> IBSHIFT) & CBAUD)\r\nibinput = 1;\r\n#endif\r\ntermios->c_cflag &= ~CBAUD;\r\ndo {\r\nif (obaud - oclose <= baud_table[i] &&\r\nobaud + oclose >= baud_table[i]) {\r\ntermios->c_cflag |= baud_bits[i];\r\nofound = i;\r\n}\r\nif (ibaud - iclose <= baud_table[i] &&\r\nibaud + iclose >= baud_table[i]) {\r\nif (ofound == i && !ibinput)\r\nifound = i;\r\n#ifdef IBSHIFT\r\nelse {\r\nifound = i;\r\ntermios->c_cflag |= (baud_bits[i] << IBSHIFT);\r\n}\r\n#endif\r\n}\r\n} while (++i < n_baud_table);\r\n#ifdef BOTHER\r\nif (ofound == -1)\r\ntermios->c_cflag |= BOTHER;\r\nif (ifound == -1 && (ibaud != obaud || ibinput))\r\ntermios->c_cflag |= (BOTHER << IBSHIFT);\r\n#else\r\nif (ifound == -1 || ofound == -1)\r\npr_warn_once("tty: Unable to return correct speed data as your architecture needs updating.\n");\r\n#endif\r\n}\r\nvoid tty_encode_baud_rate(struct tty_struct *tty, speed_t ibaud, speed_t obaud)\r\n{\r\ntty_termios_encode_baud_rate(&tty->termios, ibaud, obaud);\r\n}

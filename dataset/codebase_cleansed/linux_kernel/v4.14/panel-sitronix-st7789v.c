static inline struct st7789v *panel_to_st7789v(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct st7789v, panel);\r\n}\r\nstatic int st7789v_spi_write(struct st7789v *ctx, enum st7789v_prefix prefix,\r\nu8 data)\r\n{\r\nstruct spi_transfer xfer = { };\r\nstruct spi_message msg;\r\nu16 txbuf = ((prefix & 1) << 8) | data;\r\nspi_message_init(&msg);\r\nxfer.tx_buf = &txbuf;\r\nxfer.bits_per_word = 9;\r\nxfer.len = sizeof(txbuf);\r\nspi_message_add_tail(&xfer, &msg);\r\nreturn spi_sync(ctx->spi, &msg);\r\n}\r\nstatic int st7789v_write_command(struct st7789v *ctx, u8 cmd)\r\n{\r\nreturn st7789v_spi_write(ctx, ST7789V_COMMAND, cmd);\r\n}\r\nstatic int st7789v_write_data(struct st7789v *ctx, u8 cmd)\r\n{\r\nreturn st7789v_spi_write(ctx, ST7789V_DATA, cmd);\r\n}\r\nstatic int st7789v_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_connector *connector = panel->connector;\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(panel->drm->dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\nmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\r\ndrm_mode_probed_add(connector, mode);\r\npanel->connector->display_info.width_mm = 61;\r\npanel->connector->display_info.height_mm = 103;\r\nreturn 1;\r\n}\r\nstatic int st7789v_prepare(struct drm_panel *panel)\r\n{\r\nstruct st7789v *ctx = panel_to_st7789v(panel);\r\nint ret;\r\nret = regulator_enable(ctx->power);\r\nif (ret)\r\nreturn ret;\r\ngpiod_set_value(ctx->reset, 1);\r\nmsleep(30);\r\ngpiod_set_value(ctx->reset, 0);\r\nmsleep(120);\r\nST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_EXIT_SLEEP_MODE));\r\nmsleep(120);\r\nST7789V_TEST(ret, st7789v_write_command(ctx,\r\nMIPI_DCS_SET_ADDRESS_MODE));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0));\r\nST7789V_TEST(ret, st7789v_write_command(ctx,\r\nMIPI_DCS_SET_PIXEL_FORMAT));\r\nST7789V_TEST(ret, st7789v_write_data(ctx,\r\n(MIPI_DCS_PIXEL_FMT_18BIT << 4) |\r\n(MIPI_DCS_PIXEL_FMT_18BIT)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PORCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0xc));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0xc));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PORCTRL_IDLE_BP(3) |\r\nST7789V_PORCTRL_IDLE_FP(3)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx,\r\nST7789V_PORCTRL_PARTIAL_BP(3) |\r\nST7789V_PORCTRL_PARTIAL_FP(3)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_GCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_GCTRL_VGLS(5) |\r\nST7789V_GCTRL_VGHS(3)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VCOMS_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0x2b));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_LCMCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_LCMCTRL_XMH |\r\nST7789V_LCMCTRL_XMX |\r\nST7789V_LCMCTRL_XBGR));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VDVVRHEN_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_VDVVRHEN_CMDEN));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VRHS_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0xf));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VDVS_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0x20));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_FRCTRL2_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, 0xf));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PWCTRL1_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PWCTRL1_MAGIC));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PWCTRL1_AVDD(2) |\r\nST7789V_PWCTRL1_AVCL(2) |\r\nST7789V_PWCTRL1_VDS(1)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PVGAMCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP63(0xd)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP1(0xca)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP2(0xe)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP4(8)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP6(9)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP13(7)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP20(0x2d)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP27(0xb) |\r\nST7789V_PVGAMCTRL_VP36(3)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP43(0x3d)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_JP1(3) |\r\nST7789V_PVGAMCTRL_VP50(4)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP57(0xa)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP59(0xa)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP61(0x1b)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP62(0x28)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_NVGAMCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN63(0xd)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN1(0xca)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN2(0xf)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN4(8)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN6(8)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN13(7)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN20(0x2e)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN27(0xc) |\r\nST7789V_NVGAMCTRL_VN36(5)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN43(0x40)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_JN1(3) |\r\nST7789V_NVGAMCTRL_VN50(4)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN57(9)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN59(0xb)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN61(0x1b)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN62(0x28)));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_ENTER_INVERT_MODE));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_RAMCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RAMCTRL_DM_RGB |\r\nST7789V_RAMCTRL_RM_RGB));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RAMCTRL_EPF(3) |\r\nST7789V_RAMCTRL_MAGIC));\r\nST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_RGBCTRL_CMD));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RGBCTRL_WO |\r\nST7789V_RGBCTRL_RCM(2) |\r\nST7789V_RGBCTRL_VSYNC_HIGH |\r\nST7789V_RGBCTRL_HSYNC_HIGH |\r\nST7789V_RGBCTRL_PCLK_HIGH));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RGBCTRL_VBP(8)));\r\nST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RGBCTRL_HBP(20)));\r\nreturn 0;\r\n}\r\nstatic int st7789v_enable(struct drm_panel *panel)\r\n{\r\nstruct st7789v *ctx = panel_to_st7789v(panel);\r\nif (ctx->backlight) {\r\nctx->backlight->props.state &= ~BL_CORE_FBBLANK;\r\nctx->backlight->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(ctx->backlight);\r\n}\r\nreturn st7789v_write_command(ctx, MIPI_DCS_SET_DISPLAY_ON);\r\n}\r\nstatic int st7789v_disable(struct drm_panel *panel)\r\n{\r\nstruct st7789v *ctx = panel_to_st7789v(panel);\r\nint ret;\r\nST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_SET_DISPLAY_OFF));\r\nif (ctx->backlight) {\r\nctx->backlight->props.power = FB_BLANK_POWERDOWN;\r\nctx->backlight->props.state |= BL_CORE_FBBLANK;\r\nbacklight_update_status(ctx->backlight);\r\n}\r\nreturn 0;\r\n}\r\nstatic int st7789v_unprepare(struct drm_panel *panel)\r\n{\r\nstruct st7789v *ctx = panel_to_st7789v(panel);\r\nint ret;\r\nST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_ENTER_SLEEP_MODE));\r\nregulator_disable(ctx->power);\r\nreturn 0;\r\n}\r\nstatic int st7789v_probe(struct spi_device *spi)\r\n{\r\nstruct device_node *backlight;\r\nstruct st7789v *ctx;\r\nint ret;\r\nctx = devm_kzalloc(&spi->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, ctx);\r\nctx->spi = spi;\r\nctx->panel.dev = &spi->dev;\r\nctx->panel.funcs = &st7789v_drm_funcs;\r\nctx->power = devm_regulator_get(&spi->dev, "power");\r\nif (IS_ERR(ctx->power))\r\nreturn PTR_ERR(ctx->power);\r\nctx->reset = devm_gpiod_get(&spi->dev, "reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(ctx->reset)) {\r\ndev_err(&spi->dev, "Couldn't get our reset line\n");\r\nreturn PTR_ERR(ctx->reset);\r\n}\r\nbacklight = of_parse_phandle(spi->dev.of_node, "backlight", 0);\r\nif (backlight) {\r\nctx->backlight = of_find_backlight_by_node(backlight);\r\nof_node_put(backlight);\r\nif (!ctx->backlight)\r\nreturn -EPROBE_DEFER;\r\n}\r\nret = drm_panel_add(&ctx->panel);\r\nif (ret < 0)\r\ngoto err_free_backlight;\r\nreturn 0;\r\nerr_free_backlight:\r\nif (ctx->backlight)\r\nput_device(&ctx->backlight->dev);\r\nreturn ret;\r\n}\r\nstatic int st7789v_remove(struct spi_device *spi)\r\n{\r\nstruct st7789v *ctx = spi_get_drvdata(spi);\r\ndrm_panel_detach(&ctx->panel);\r\ndrm_panel_remove(&ctx->panel);\r\nif (ctx->backlight)\r\nput_device(&ctx->backlight->dev);\r\nreturn 0;\r\n}

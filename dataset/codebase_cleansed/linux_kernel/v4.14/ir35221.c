static long ir35221_reg2data(int data, enum pmbus_sensor_classes class)\r\n{\r\ns16 exponent;\r\ns32 mantissa;\r\nlong val;\r\nexponent = ((s16)data) >> 11;\r\nmantissa = ((s16)((data & 0x7ff) << 5)) >> 5;\r\nval = mantissa * 1000L;\r\nif (class == PSC_POWER)\r\nval = val * 1000L;\r\nif (exponent >= 0)\r\nval <<= exponent;\r\nelse\r\nval >>= -exponent;\r\nreturn val;\r\n}\r\nstatic u16 ir35221_data2reg(long val, enum pmbus_sensor_classes class)\r\n{\r\ns16 exponent = 0, mantissa;\r\nbool negative = false;\r\nif (val == 0)\r\nreturn 0;\r\nif (val < 0) {\r\nnegative = true;\r\nval = -val;\r\n}\r\nif (class == PSC_POWER)\r\nval = DIV_ROUND_CLOSEST(val, 1000L);\r\nwhile (val >= MAX_MANTISSA && exponent < 15) {\r\nexponent++;\r\nval >>= 1;\r\n}\r\nwhile (val < MIN_MANTISSA && exponent > -15) {\r\nexponent--;\r\nval <<= 1;\r\n}\r\nmantissa = DIV_ROUND_CLOSEST(val, 1000);\r\nif (mantissa > 0x3ff)\r\nmantissa = 0x3ff;\r\nif (negative)\r\nmantissa = -mantissa;\r\nreturn (mantissa & 0x7ff) | ((exponent << 11) & 0xf800);\r\n}\r\nstatic u16 ir35221_scale_result(s16 data, int shift,\r\nenum pmbus_sensor_classes class)\r\n{\r\nlong val;\r\nval = ir35221_reg2data(data, class);\r\nif (shift < 0)\r\nval >>= -shift;\r\nelse\r\nval <<= shift;\r\nreturn ir35221_data2reg(val, class);\r\n}\r\nstatic int ir35221_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nint ret;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\ncase PMBUS_IOUT_OC_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, page, reg);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, 1, PSC_CURRENT_OUT);\r\nbreak;\r\ncase PMBUS_VIN_OV_FAULT_LIMIT:\r\ncase PMBUS_VIN_OV_WARN_LIMIT:\r\ncase PMBUS_VIN_UV_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, page, reg);\r\nret = ir35221_scale_result(ret, -4, PSC_VOLTAGE_IN);\r\nbreak;\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, page, reg);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -1, PSC_CURRENT_IN);\r\nbreak;\r\ncase PMBUS_READ_VIN:\r\nret = pmbus_read_word_data(client, page, PMBUS_READ_VIN);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -5, PSC_VOLTAGE_IN);\r\nbreak;\r\ncase PMBUS_READ_IIN:\r\nret = pmbus_read_word_data(client, page, PMBUS_READ_IIN);\r\nif (ret < 0)\r\nbreak;\r\nif (page == 0)\r\nret = ir35221_scale_result(ret, -4, PSC_CURRENT_IN);\r\nelse\r\nret = ir35221_scale_result(ret, -5, PSC_CURRENT_IN);\r\nbreak;\r\ncase PMBUS_READ_POUT:\r\nret = pmbus_read_word_data(client, page, PMBUS_READ_POUT);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -1, PSC_POWER);\r\nbreak;\r\ncase PMBUS_READ_PIN:\r\nret = pmbus_read_word_data(client, page, PMBUS_READ_PIN);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -1, PSC_POWER);\r\nbreak;\r\ncase PMBUS_READ_IOUT:\r\nret = pmbus_read_word_data(client, page, PMBUS_READ_IOUT);\r\nif (ret < 0)\r\nbreak;\r\nif (page == 0)\r\nret = ir35221_scale_result(ret, -1, PSC_CURRENT_OUT);\r\nelse\r\nret = ir35221_scale_result(ret, -2, PSC_CURRENT_OUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_MAX:\r\nret = pmbus_read_word_data(client, page, IR35221_MFR_VIN_PEAK);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -5, PSC_VOLTAGE_IN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_MAX:\r\nret = pmbus_read_word_data(client, page, IR35221_MFR_VOUT_PEAK);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IOUT_MAX:\r\nret = pmbus_read_word_data(client, page, IR35221_MFR_IOUT_PEAK);\r\nif (ret < 0)\r\nbreak;\r\nif (page == 0)\r\nret = ir35221_scale_result(ret, -1, PSC_CURRENT_IN);\r\nelse\r\nret = ir35221_scale_result(ret, -2, PSC_CURRENT_IN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_TEMP_MAX:\r\nret = pmbus_read_word_data(client, page, IR35221_MFR_TEMP_PEAK);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_MIN:\r\nret = pmbus_read_word_data(client, page,\r\nIR35221_MFR_VIN_VALLEY);\r\nif (ret < 0)\r\nbreak;\r\nret = ir35221_scale_result(ret, -5, PSC_VOLTAGE_IN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_MIN:\r\nret = pmbus_read_word_data(client, page,\r\nIR35221_MFR_VOUT_VALLEY);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IOUT_MIN:\r\nret = pmbus_read_word_data(client, page,\r\nIR35221_MFR_IOUT_VALLEY);\r\nif (ret < 0)\r\nbreak;\r\nif (page == 0)\r\nret = ir35221_scale_result(ret, -1, PSC_CURRENT_IN);\r\nelse\r\nret = ir35221_scale_result(ret, -2, PSC_CURRENT_IN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_TEMP_MIN:\r\nret = pmbus_read_word_data(client, page,\r\nIR35221_MFR_TEMP_VALLEY);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ir35221_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nint ret;\r\nu16 val;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\ncase PMBUS_IOUT_OC_WARN_LIMIT:\r\nval = ir35221_scale_result(word, -1, PSC_CURRENT_OUT);\r\nret = pmbus_write_word_data(client, page, reg, val);\r\nbreak;\r\ncase PMBUS_VIN_OV_FAULT_LIMIT:\r\ncase PMBUS_VIN_OV_WARN_LIMIT:\r\ncase PMBUS_VIN_UV_WARN_LIMIT:\r\nval = ir35221_scale_result(word, 4, PSC_VOLTAGE_IN);\r\nret = pmbus_write_word_data(client, page, reg, val);\r\nbreak;\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nval = ir35221_scale_result(word, 1, PSC_CURRENT_IN);\r\nret = pmbus_write_word_data(client, page, reg, val);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ir35221_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pmbus_driver_info *info;\r\nu8 buf[I2C_SMBUS_BLOCK_MAX];\r\nint ret;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_BYTE_DATA\r\n| I2C_FUNC_SMBUS_READ_WORD_DATA\r\n| I2C_FUNC_SMBUS_READ_BLOCK_DATA))\r\nreturn -ENODEV;\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_ID, buf);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read PMBUS_MFR_ID\n");\r\nreturn ret;\r\n}\r\nif (ret != 2 || strncmp(buf, "RI", strlen("RI"))) {\r\ndev_err(&client->dev, "MFR_ID unrecognised\n");\r\nreturn -ENODEV;\r\n}\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_MODEL, buf);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read PMBUS_MFR_MODEL\n");\r\nreturn ret;\r\n}\r\nif (ret != 2 || !(buf[0] == 0x6c && buf[1] == 0x00)) {\r\ndev_err(&client->dev, "MFR_MODEL unrecognised\n");\r\nreturn -ENODEV;\r\n}\r\ninfo = devm_kzalloc(&client->dev, sizeof(struct pmbus_driver_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->write_word_data = ir35221_write_word_data;\r\ninfo->read_word_data = ir35221_read_word_data;\r\ninfo->pages = 2;\r\ninfo->format[PSC_VOLTAGE_IN] = linear;\r\ninfo->format[PSC_VOLTAGE_OUT] = linear;\r\ninfo->format[PSC_CURRENT_IN] = linear;\r\ninfo->format[PSC_CURRENT_OUT] = linear;\r\ninfo->format[PSC_POWER] = linear;\r\ninfo->format[PSC_TEMPERATURE] = linear;\r\ninfo->func[0] = PMBUS_HAVE_VIN\r\n| PMBUS_HAVE_VOUT | PMBUS_HAVE_IIN\r\n| PMBUS_HAVE_IOUT | PMBUS_HAVE_PIN\r\n| PMBUS_HAVE_POUT | PMBUS_HAVE_TEMP\r\n| PMBUS_HAVE_STATUS_VOUT | PMBUS_HAVE_STATUS_IOUT\r\n| PMBUS_HAVE_STATUS_INPUT | PMBUS_HAVE_STATUS_TEMP;\r\ninfo->func[1] = info->func[0];\r\nreturn pmbus_do_probe(client, id, info);\r\n}

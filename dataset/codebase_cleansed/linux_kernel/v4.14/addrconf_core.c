static inline unsigned int ipv6_addr_scope2type(unsigned int scope)\r\n{\r\nswitch (scope) {\r\ncase IPV6_ADDR_SCOPE_NODELOCAL:\r\nreturn (IPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_NODELOCAL) |\r\nIPV6_ADDR_LOOPBACK);\r\ncase IPV6_ADDR_SCOPE_LINKLOCAL:\r\nreturn (IPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_LINKLOCAL) |\r\nIPV6_ADDR_LINKLOCAL);\r\ncase IPV6_ADDR_SCOPE_SITELOCAL:\r\nreturn (IPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_SITELOCAL) |\r\nIPV6_ADDR_SITELOCAL);\r\n}\r\nreturn IPV6_ADDR_SCOPE_TYPE(scope);\r\n}\r\nint __ipv6_addr_type(const struct in6_addr *addr)\r\n{\r\n__be32 st;\r\nst = addr->s6_addr32[0];\r\nif ((st & htonl(0xE0000000)) != htonl(0x00000000) &&\r\n(st & htonl(0xE0000000)) != htonl(0xE0000000))\r\nreturn (IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_GLOBAL));\r\nif ((st & htonl(0xFF000000)) == htonl(0xFF000000)) {\r\nreturn (IPV6_ADDR_MULTICAST |\r\nipv6_addr_scope2type(IPV6_ADDR_MC_SCOPE(addr)));\r\n}\r\nif ((st & htonl(0xFFC00000)) == htonl(0xFE800000))\r\nreturn (IPV6_ADDR_LINKLOCAL | IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_LINKLOCAL));\r\nif ((st & htonl(0xFFC00000)) == htonl(0xFEC00000))\r\nreturn (IPV6_ADDR_SITELOCAL | IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_SITELOCAL));\r\nif ((st & htonl(0xFE000000)) == htonl(0xFC000000))\r\nreturn (IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_GLOBAL));\r\nif ((addr->s6_addr32[0] | addr->s6_addr32[1]) == 0) {\r\nif (addr->s6_addr32[2] == 0) {\r\nif (addr->s6_addr32[3] == 0)\r\nreturn IPV6_ADDR_ANY;\r\nif (addr->s6_addr32[3] == htonl(0x00000001))\r\nreturn (IPV6_ADDR_LOOPBACK | IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_LINKLOCAL));\r\nreturn (IPV6_ADDR_COMPATv4 | IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_GLOBAL));\r\n}\r\nif (addr->s6_addr32[2] == htonl(0x0000ffff))\r\nreturn (IPV6_ADDR_MAPPED |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_GLOBAL));\r\n}\r\nreturn (IPV6_ADDR_UNICAST |\r\nIPV6_ADDR_SCOPE_TYPE(IPV6_ADDR_SCOPE_GLOBAL));\r\n}\r\nint register_inet6addr_notifier(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_register(&inet6addr_chain, nb);\r\n}\r\nint unregister_inet6addr_notifier(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_unregister(&inet6addr_chain, nb);\r\n}\r\nint inet6addr_notifier_call_chain(unsigned long val, void *v)\r\n{\r\nreturn atomic_notifier_call_chain(&inet6addr_chain, val, v);\r\n}\r\nint register_inet6addr_validator_notifier(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_register(&inet6addr_validator_chain, nb);\r\n}\r\nint unregister_inet6addr_validator_notifier(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_unregister(&inet6addr_validator_chain, nb);\r\n}\r\nint inet6addr_validator_notifier_call_chain(unsigned long val, void *v)\r\n{\r\nreturn atomic_notifier_call_chain(&inet6addr_validator_chain, val, v);\r\n}\r\nstatic int eafnosupport_ipv6_dst_lookup(struct net *net, struct sock *u1,\r\nstruct dst_entry **u2,\r\nstruct flowi6 *u3)\r\n{\r\nreturn -EAFNOSUPPORT;\r\n}\r\nstatic void snmp6_free_dev(struct inet6_dev *idev)\r\n{\r\nkfree(idev->stats.icmpv6msgdev);\r\nkfree(idev->stats.icmpv6dev);\r\nfree_percpu(idev->stats.ipv6);\r\n}\r\nstatic void in6_dev_finish_destroy_rcu(struct rcu_head *head)\r\n{\r\nstruct inet6_dev *idev = container_of(head, struct inet6_dev, rcu);\r\nsnmp6_free_dev(idev);\r\nkfree(idev);\r\n}\r\nvoid in6_dev_finish_destroy(struct inet6_dev *idev)\r\n{\r\nstruct net_device *dev = idev->dev;\r\nWARN_ON(!list_empty(&idev->addr_list));\r\nWARN_ON(idev->mc_list);\r\nWARN_ON(timer_pending(&idev->rs_timer));\r\n#ifdef NET_REFCNT_DEBUG\r\npr_debug("%s: %s\n", __func__, dev ? dev->name : "NIL");\r\n#endif\r\ndev_put(dev);\r\nif (!idev->dead) {\r\npr_warn("Freeing alive inet6 device %p\n", idev);\r\nreturn;\r\n}\r\ncall_rcu(&idev->rcu, in6_dev_finish_destroy_rcu);\r\n}

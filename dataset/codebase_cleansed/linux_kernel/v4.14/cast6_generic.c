static inline void W(u32 *key, unsigned int i)\r\n{\r\nu32 I;\r\nkey[6] ^= F1(key[7], Tr[i % 4][0], Tm[i][0]);\r\nkey[5] ^= F2(key[6], Tr[i % 4][1], Tm[i][1]);\r\nkey[4] ^= F3(key[5], Tr[i % 4][2], Tm[i][2]);\r\nkey[3] ^= F1(key[4], Tr[i % 4][3], Tm[i][3]);\r\nkey[2] ^= F2(key[3], Tr[i % 4][4], Tm[i][4]);\r\nkey[1] ^= F3(key[2], Tr[i % 4][5], Tm[i][5]);\r\nkey[0] ^= F1(key[1], Tr[i % 4][6], Tm[i][6]);\r\nkey[7] ^= F2(key[0], Tr[i % 4][7], Tm[i][7]);\r\n}\r\nint __cast6_setkey(struct cast6_ctx *c, const u8 *in_key,\r\nunsigned key_len, u32 *flags)\r\n{\r\nint i;\r\nu32 key[8];\r\n__be32 p_key[8];\r\nif (key_len % 4 != 0) {\r\n*flags |= CRYPTO_TFM_RES_BAD_KEY_LEN;\r\nreturn -EINVAL;\r\n}\r\nmemset(p_key, 0, 32);\r\nmemcpy(p_key, in_key, key_len);\r\nkey[0] = be32_to_cpu(p_key[0]);\r\nkey[1] = be32_to_cpu(p_key[1]);\r\nkey[2] = be32_to_cpu(p_key[2]);\r\nkey[3] = be32_to_cpu(p_key[3]);\r\nkey[4] = be32_to_cpu(p_key[4]);\r\nkey[5] = be32_to_cpu(p_key[5]);\r\nkey[6] = be32_to_cpu(p_key[6]);\r\nkey[7] = be32_to_cpu(p_key[7]);\r\nfor (i = 0; i < 12; i++) {\r\nW(key, 2 * i);\r\nW(key, 2 * i + 1);\r\nc->Kr[i][0] = key[0] & 0x1f;\r\nc->Kr[i][1] = key[2] & 0x1f;\r\nc->Kr[i][2] = key[4] & 0x1f;\r\nc->Kr[i][3] = key[6] & 0x1f;\r\nc->Km[i][0] = key[7];\r\nc->Km[i][1] = key[5];\r\nc->Km[i][2] = key[3];\r\nc->Km[i][3] = key[1];\r\n}\r\nreturn 0;\r\n}\r\nint cast6_setkey(struct crypto_tfm *tfm, const u8 *key, unsigned int keylen)\r\n{\r\nreturn __cast6_setkey(crypto_tfm_ctx(tfm), key, keylen,\r\n&tfm->crt_flags);\r\n}\r\nstatic inline void Q(u32 *block, u8 *Kr, u32 *Km)\r\n{\r\nu32 I;\r\nblock[2] ^= F1(block[3], Kr[0], Km[0]);\r\nblock[1] ^= F2(block[2], Kr[1], Km[1]);\r\nblock[0] ^= F3(block[1], Kr[2], Km[2]);\r\nblock[3] ^= F1(block[0], Kr[3], Km[3]);\r\n}\r\nstatic inline void QBAR(u32 *block, u8 *Kr, u32 *Km)\r\n{\r\nu32 I;\r\nblock[3] ^= F1(block[0], Kr[3], Km[3]);\r\nblock[0] ^= F3(block[1], Kr[2], Km[2]);\r\nblock[1] ^= F2(block[2], Kr[1], Km[1]);\r\nblock[2] ^= F1(block[3], Kr[0], Km[0]);\r\n}\r\nvoid __cast6_encrypt(struct cast6_ctx *c, u8 *outbuf, const u8 *inbuf)\r\n{\r\nconst __be32 *src = (const __be32 *)inbuf;\r\n__be32 *dst = (__be32 *)outbuf;\r\nu32 block[4];\r\nu32 *Km;\r\nu8 *Kr;\r\nblock[0] = be32_to_cpu(src[0]);\r\nblock[1] = be32_to_cpu(src[1]);\r\nblock[2] = be32_to_cpu(src[2]);\r\nblock[3] = be32_to_cpu(src[3]);\r\nKm = c->Km[0]; Kr = c->Kr[0]; Q(block, Kr, Km);\r\nKm = c->Km[1]; Kr = c->Kr[1]; Q(block, Kr, Km);\r\nKm = c->Km[2]; Kr = c->Kr[2]; Q(block, Kr, Km);\r\nKm = c->Km[3]; Kr = c->Kr[3]; Q(block, Kr, Km);\r\nKm = c->Km[4]; Kr = c->Kr[4]; Q(block, Kr, Km);\r\nKm = c->Km[5]; Kr = c->Kr[5]; Q(block, Kr, Km);\r\nKm = c->Km[6]; Kr = c->Kr[6]; QBAR(block, Kr, Km);\r\nKm = c->Km[7]; Kr = c->Kr[7]; QBAR(block, Kr, Km);\r\nKm = c->Km[8]; Kr = c->Kr[8]; QBAR(block, Kr, Km);\r\nKm = c->Km[9]; Kr = c->Kr[9]; QBAR(block, Kr, Km);\r\nKm = c->Km[10]; Kr = c->Kr[10]; QBAR(block, Kr, Km);\r\nKm = c->Km[11]; Kr = c->Kr[11]; QBAR(block, Kr, Km);\r\ndst[0] = cpu_to_be32(block[0]);\r\ndst[1] = cpu_to_be32(block[1]);\r\ndst[2] = cpu_to_be32(block[2]);\r\ndst[3] = cpu_to_be32(block[3]);\r\n}\r\nstatic void cast6_encrypt(struct crypto_tfm *tfm, u8 *outbuf, const u8 *inbuf)\r\n{\r\n__cast6_encrypt(crypto_tfm_ctx(tfm), outbuf, inbuf);\r\n}\r\nvoid __cast6_decrypt(struct cast6_ctx *c, u8 *outbuf, const u8 *inbuf)\r\n{\r\nconst __be32 *src = (const __be32 *)inbuf;\r\n__be32 *dst = (__be32 *)outbuf;\r\nu32 block[4];\r\nu32 *Km;\r\nu8 *Kr;\r\nblock[0] = be32_to_cpu(src[0]);\r\nblock[1] = be32_to_cpu(src[1]);\r\nblock[2] = be32_to_cpu(src[2]);\r\nblock[3] = be32_to_cpu(src[3]);\r\nKm = c->Km[11]; Kr = c->Kr[11]; Q(block, Kr, Km);\r\nKm = c->Km[10]; Kr = c->Kr[10]; Q(block, Kr, Km);\r\nKm = c->Km[9]; Kr = c->Kr[9]; Q(block, Kr, Km);\r\nKm = c->Km[8]; Kr = c->Kr[8]; Q(block, Kr, Km);\r\nKm = c->Km[7]; Kr = c->Kr[7]; Q(block, Kr, Km);\r\nKm = c->Km[6]; Kr = c->Kr[6]; Q(block, Kr, Km);\r\nKm = c->Km[5]; Kr = c->Kr[5]; QBAR(block, Kr, Km);\r\nKm = c->Km[4]; Kr = c->Kr[4]; QBAR(block, Kr, Km);\r\nKm = c->Km[3]; Kr = c->Kr[3]; QBAR(block, Kr, Km);\r\nKm = c->Km[2]; Kr = c->Kr[2]; QBAR(block, Kr, Km);\r\nKm = c->Km[1]; Kr = c->Kr[1]; QBAR(block, Kr, Km);\r\nKm = c->Km[0]; Kr = c->Kr[0]; QBAR(block, Kr, Km);\r\ndst[0] = cpu_to_be32(block[0]);\r\ndst[1] = cpu_to_be32(block[1]);\r\ndst[2] = cpu_to_be32(block[2]);\r\ndst[3] = cpu_to_be32(block[3]);\r\n}\r\nstatic void cast6_decrypt(struct crypto_tfm *tfm, u8 *outbuf, const u8 *inbuf)\r\n{\r\n__cast6_decrypt(crypto_tfm_ctx(tfm), outbuf, inbuf);\r\n}\r\nstatic int __init cast6_mod_init(void)\r\n{\r\nreturn crypto_register_alg(&alg);\r\n}\r\nstatic void __exit cast6_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\n}

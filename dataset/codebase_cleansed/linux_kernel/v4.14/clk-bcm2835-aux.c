static int bcm2835_aux_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct clk_hw_onecell_data *onecell;\r\nconst char *parent;\r\nstruct clk *parent_clk;\r\nstruct resource *res;\r\nvoid __iomem *reg, *gate;\r\nparent_clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(parent_clk))\r\nreturn PTR_ERR(parent_clk);\r\nparent = __clk_get_name(parent_clk);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nreg = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(reg))\r\nreturn PTR_ERR(reg);\r\nonecell = devm_kmalloc(dev, sizeof(*onecell) + sizeof(*onecell->hws) *\r\nBCM2835_AUX_CLOCK_COUNT, GFP_KERNEL);\r\nif (!onecell)\r\nreturn -ENOMEM;\r\nonecell->num = BCM2835_AUX_CLOCK_COUNT;\r\ngate = reg + BCM2835_AUXENB;\r\nonecell->hws[BCM2835_AUX_CLOCK_UART] =\r\nclk_hw_register_gate(dev, "aux_uart", parent, 0, gate, 0, 0, NULL);\r\nonecell->hws[BCM2835_AUX_CLOCK_SPI1] =\r\nclk_hw_register_gate(dev, "aux_spi1", parent, 0, gate, 1, 0, NULL);\r\nonecell->hws[BCM2835_AUX_CLOCK_SPI2] =\r\nclk_hw_register_gate(dev, "aux_spi2", parent, 0, gate, 2, 0, NULL);\r\nreturn of_clk_add_hw_provider(pdev->dev.of_node, of_clk_hw_onecell_get,\r\nonecell);\r\n}

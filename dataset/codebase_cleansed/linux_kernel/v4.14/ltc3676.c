static int ltc3676_set_suspend_voltage(struct regulator_dev *rdev, int uV)\r\n{\r\nstruct ltc3676 *ltc3676 = rdev_get_drvdata(rdev);\r\nstruct device *dev = ltc3676->dev;\r\nint dcdc = rdev_get_id(rdev);\r\nint sel;\r\ndev_dbg(dev, "%s id=%d uV=%d\n", __func__, dcdc, uV);\r\nsel = regulator_map_voltage_linear(rdev, uV, uV);\r\nif (sel < 0)\r\nreturn sel;\r\nreturn regmap_update_bits(ltc3676->regmap, rdev->desc->vsel_reg + 1,\r\nrdev->desc->vsel_mask, sel);\r\n}\r\nstatic int ltc3676_set_suspend_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nstruct ltc3676 *ltc3676= rdev_get_drvdata(rdev);\r\nstruct device *dev = ltc3676->dev;\r\nint mask, val;\r\nint dcdc = rdev_get_id(rdev);\r\ndev_dbg(dev, "%s id=%d mode=%d\n", __func__, dcdc, mode);\r\nmask = LTC3676_DVBxA_REF_SELECT;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_STANDBY:\r\nval = 0;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\nval = LTC3676_DVBxA_REF_SELECT;\r\nbreak;\r\ndefault:\r\ndev_warn(&rdev->dev, "%s: regulator mode: 0x%x not supported\n",\r\nrdev->desc->name, mode);\r\nreturn -EINVAL;\r\n}\r\nreturn regmap_update_bits(ltc3676->regmap, rdev->desc->vsel_reg,\r\nmask, val);\r\n}\r\nstatic inline unsigned int ltc3676_scale(unsigned int uV, u32 r1, u32 r2)\r\n{\r\nuint64_t tmp;\r\nif (uV == 0)\r\nreturn 0;\r\ntmp = (uint64_t)uV * r1;\r\ndo_div(tmp, r2);\r\nreturn uV + (unsigned int)tmp;\r\n}\r\nstatic int ltc3676_of_parse_cb(struct device_node *np,\r\nconst struct regulator_desc *desc,\r\nstruct regulator_config *config)\r\n{\r\nstruct ltc3676 *ltc3676 = config->driver_data;\r\nstruct regulator_desc *rdesc = &ltc3676->regulator_descs[desc->id];\r\nu32 r[2];\r\nint ret;\r\nif (desc->id == LTC3676_LDO3)\r\nreturn 0;\r\nret = of_property_read_u32_array(np, "lltc,fb-voltage-divider", r, 2);\r\nif (ret) {\r\ndev_err(ltc3676->dev, "Failed to parse voltage divider: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nrdesc->min_uV = ltc3676_scale(desc->min_uV, r[0], r[1]);\r\nrdesc->uV_step = ltc3676_scale(desc->uV_step, r[0], r[1]);\r\nrdesc->fixed_uV = ltc3676_scale(desc->fixed_uV, r[0], r[1]);\r\nreturn 0;\r\n}\r\nstatic bool ltc3676_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase LTC3676_IRQSTAT:\r\ncase LTC3676_BUCK1:\r\ncase LTC3676_BUCK2:\r\ncase LTC3676_BUCK3:\r\ncase LTC3676_BUCK4:\r\ncase LTC3676_LDOA:\r\ncase LTC3676_LDOB:\r\ncase LTC3676_SQD1:\r\ncase LTC3676_SQD2:\r\ncase LTC3676_CNTRL:\r\ncase LTC3676_DVB1A:\r\ncase LTC3676_DVB1B:\r\ncase LTC3676_DVB2A:\r\ncase LTC3676_DVB2B:\r\ncase LTC3676_DVB3A:\r\ncase LTC3676_DVB3B:\r\ncase LTC3676_DVB4A:\r\ncase LTC3676_DVB4B:\r\ncase LTC3676_MSKIRQ:\r\ncase LTC3676_MSKPG:\r\ncase LTC3676_USER:\r\ncase LTC3676_HRST:\r\ncase LTC3676_CLIRQ:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool ltc3676_readable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase LTC3676_IRQSTAT:\r\ncase LTC3676_BUCK1:\r\ncase LTC3676_BUCK2:\r\ncase LTC3676_BUCK3:\r\ncase LTC3676_BUCK4:\r\ncase LTC3676_LDOA:\r\ncase LTC3676_LDOB:\r\ncase LTC3676_SQD1:\r\ncase LTC3676_SQD2:\r\ncase LTC3676_CNTRL:\r\ncase LTC3676_DVB1A:\r\ncase LTC3676_DVB1B:\r\ncase LTC3676_DVB2A:\r\ncase LTC3676_DVB2B:\r\ncase LTC3676_DVB3A:\r\ncase LTC3676_DVB3B:\r\ncase LTC3676_DVB4A:\r\ncase LTC3676_DVB4B:\r\ncase LTC3676_MSKIRQ:\r\ncase LTC3676_MSKPG:\r\ncase LTC3676_USER:\r\ncase LTC3676_HRST:\r\ncase LTC3676_CLIRQ:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool ltc3676_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase LTC3676_IRQSTAT:\r\ncase LTC3676_PGSTATL:\r\ncase LTC3676_PGSTATRT:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic irqreturn_t ltc3676_isr(int irq, void *dev_id)\r\n{\r\nstruct ltc3676 *ltc3676 = dev_id;\r\nstruct device *dev = ltc3676->dev;\r\nunsigned int i, irqstat, event;\r\nregmap_read(ltc3676->regmap, LTC3676_IRQSTAT, &irqstat);\r\ndev_dbg(dev, "irq%d irqstat=0x%02x\n", irq, irqstat);\r\nif (irqstat & LTC3676_IRQSTAT_THERMAL_WARN) {\r\ndev_warn(dev, "Over-temperature Warning\n");\r\nevent = REGULATOR_EVENT_OVER_TEMP;\r\nfor (i = 0; i < LTC3676_NUM_REGULATORS; i++)\r\nregulator_notifier_call_chain(ltc3676->regulators[i],\r\nevent, NULL);\r\n}\r\nif (irqstat & LTC3676_IRQSTAT_UNDERVOLT_WARN) {\r\ndev_info(dev, "Undervoltage Warning\n");\r\nevent = REGULATOR_EVENT_UNDER_VOLTAGE;\r\nfor (i = 0; i < LTC3676_NUM_REGULATORS; i++)\r\nregulator_notifier_call_chain(ltc3676->regulators[i],\r\nevent, NULL);\r\n}\r\nregmap_write(ltc3676->regmap, LTC3676_CLIRQ, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ltc3676_regulator_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct regulator_init_data *init_data = dev_get_platdata(dev);\r\nstruct regulator_desc *descs;\r\nstruct ltc3676 *ltc3676;\r\nint i, ret;\r\nltc3676 = devm_kzalloc(dev, sizeof(*ltc3676), GFP_KERNEL);\r\nif (!ltc3676)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, ltc3676);\r\nltc3676->dev = dev;\r\ndescs = ltc3676->regulator_descs;\r\nmemcpy(descs, ltc3676_regulators, sizeof(ltc3676_regulators));\r\ndescs[LTC3676_LDO3].fixed_uV = 1800000;\r\nltc3676->regmap = devm_regmap_init_i2c(client, &ltc3676_regmap_config);\r\nif (IS_ERR(ltc3676->regmap)) {\r\nret = PTR_ERR(ltc3676->regmap);\r\ndev_err(dev, "failed to initialize regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < LTC3676_NUM_REGULATORS; i++) {\r\nstruct regulator_desc *desc = &ltc3676->regulator_descs[i];\r\nstruct regulator_config config = { };\r\nif (init_data)\r\nconfig.init_data = &init_data[i];\r\nconfig.dev = dev;\r\nconfig.driver_data = ltc3676;\r\nltc3676->regulators[i] = devm_regulator_register(dev, desc,\r\n&config);\r\nif (IS_ERR(ltc3676->regulators[i])) {\r\nret = PTR_ERR(ltc3676->regulators[i]);\r\ndev_err(dev, "failed to register regulator %s: %d\n",\r\ndesc->name, ret);\r\nreturn ret;\r\n}\r\n}\r\nregmap_write(ltc3676->regmap, LTC3676_CLIRQ, 0);\r\nif (client->irq) {\r\nret = devm_request_threaded_irq(dev, client->irq, NULL,\r\nltc3676_isr,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\nclient->name, ltc3676);\r\nif (ret) {\r\ndev_err(dev, "Failed to request IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

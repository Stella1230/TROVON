int focaltech_detect(struct psmouse *psmouse, bool set_properties)\r\n{\r\nif (!psmouse_matches_pnp_id(psmouse, focaltech_pnp_ids))\r\nreturn -ENODEV;\r\nif (set_properties) {\r\npsmouse->vendor = "FocalTech";\r\npsmouse->name = "Touchpad";\r\n}\r\nreturn 0;\r\n}\r\nstatic void focaltech_report_state(struct psmouse *psmouse)\r\n{\r\nstruct focaltech_data *priv = psmouse->private;\r\nstruct focaltech_hw_state *state = &priv->state;\r\nstruct input_dev *dev = psmouse->dev;\r\nint i;\r\nfor (i = 0; i < FOC_MAX_FINGERS; i++) {\r\nstruct focaltech_finger_state *finger = &state->fingers[i];\r\nbool active = finger->active && finger->valid;\r\ninput_mt_slot(dev, i);\r\ninput_mt_report_slot_state(dev, MT_TOOL_FINGER, active);\r\nif (active) {\r\nunsigned int clamped_x, clamped_y;\r\nclamped_x = clamp(finger->x, 0U, priv->x_max);\r\nclamped_y = clamp(finger->y, 0U, priv->y_max);\r\ninput_report_abs(dev, ABS_MT_POSITION_X, clamped_x);\r\ninput_report_abs(dev, ABS_MT_POSITION_Y,\r\npriv->y_max - clamped_y);\r\ninput_report_abs(dev, ABS_TOOL_WIDTH, state->width);\r\n}\r\n}\r\ninput_mt_report_pointer_emulation(dev, true);\r\ninput_report_key(dev, BTN_LEFT, state->pressed);\r\ninput_sync(dev);\r\n}\r\nstatic void focaltech_process_touch_packet(struct psmouse *psmouse,\r\nunsigned char *packet)\r\n{\r\nstruct focaltech_data *priv = psmouse->private;\r\nstruct focaltech_hw_state *state = &priv->state;\r\nunsigned char fingers = packet[1];\r\nint i;\r\nstate->pressed = (packet[0] >> 4) & 1;\r\nfor (i = 0; i < FOC_MAX_FINGERS; i++) {\r\nstate->fingers[i].active = fingers & 0x1;\r\nif (!state->fingers[i].active) {\r\nstate->fingers[i].valid = false;\r\n}\r\nfingers >>= 1;\r\n}\r\n}\r\nstatic void focaltech_process_abs_packet(struct psmouse *psmouse,\r\nunsigned char *packet)\r\n{\r\nstruct focaltech_data *priv = psmouse->private;\r\nstruct focaltech_hw_state *state = &priv->state;\r\nunsigned int finger;\r\nfinger = (packet[1] >> 4) - 1;\r\nif (finger >= FOC_MAX_FINGERS) {\r\npsmouse_err(psmouse, "Invalid finger in abs packet: %d\n",\r\nfinger);\r\nreturn;\r\n}\r\nstate->pressed = (packet[0] >> 4) & 1;\r\nstate->fingers[finger].x = ((packet[1] & 0xf) << 8) | packet[2];\r\nstate->fingers[finger].y = (packet[3] << 8) | packet[4];\r\nstate->width = packet[5] >> 4;\r\nstate->fingers[finger].valid = true;\r\n}\r\nstatic void focaltech_process_rel_packet(struct psmouse *psmouse,\r\nunsigned char *packet)\r\n{\r\nstruct focaltech_data *priv = psmouse->private;\r\nstruct focaltech_hw_state *state = &priv->state;\r\nint finger1, finger2;\r\nstate->pressed = packet[0] >> 7;\r\nfinger1 = ((packet[0] >> 4) & 0x7) - 1;\r\nif (finger1 < FOC_MAX_FINGERS) {\r\nstate->fingers[finger1].x += (char)packet[1];\r\nstate->fingers[finger1].y += (char)packet[2];\r\n} else {\r\npsmouse_err(psmouse, "First finger in rel packet invalid: %d\n",\r\nfinger1);\r\n}\r\nfinger2 = ((packet[3] >> 4) & 0x7) - 1;\r\nif (finger2 < FOC_MAX_FINGERS) {\r\nstate->fingers[finger2].x += (char)packet[4];\r\nstate->fingers[finger2].y += (char)packet[5];\r\n}\r\n}\r\nstatic void focaltech_process_packet(struct psmouse *psmouse)\r\n{\r\nunsigned char *packet = psmouse->packet;\r\nswitch (packet[0] & 0xf) {\r\ncase FOC_TOUCH:\r\nfocaltech_process_touch_packet(psmouse, packet);\r\nbreak;\r\ncase FOC_ABS:\r\nfocaltech_process_abs_packet(psmouse, packet);\r\nbreak;\r\ncase FOC_REL:\r\nfocaltech_process_rel_packet(psmouse, packet);\r\nbreak;\r\ndefault:\r\npsmouse_err(psmouse, "Unknown packet type: %02x\n", packet[0]);\r\nbreak;\r\n}\r\nfocaltech_report_state(psmouse);\r\n}\r\nstatic psmouse_ret_t focaltech_process_byte(struct psmouse *psmouse)\r\n{\r\nif (psmouse->pktcnt >= 6) {\r\nfocaltech_process_packet(psmouse);\r\nreturn PSMOUSE_FULL_PACKET;\r\n}\r\nreturn PSMOUSE_GOOD_DATA;\r\n}\r\nstatic int focaltech_switch_protocol(struct psmouse *psmouse)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param[3];\r\nparam[0] = 0;\r\nif (ps2_command(ps2dev, param, 0x10f8))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, 0x10f8))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, 0x10f8))\r\nreturn -EIO;\r\nparam[0] = 1;\r\nif (ps2_command(ps2dev, param, 0x10f8))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETSCALE11))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_ENABLE))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void focaltech_reset(struct psmouse *psmouse)\r\n{\r\nps2_command(&psmouse->ps2dev, NULL, PSMOUSE_CMD_RESET_DIS);\r\npsmouse_reset(psmouse);\r\n}\r\nstatic void focaltech_disconnect(struct psmouse *psmouse)\r\n{\r\nfocaltech_reset(psmouse);\r\nkfree(psmouse->private);\r\npsmouse->private = NULL;\r\n}\r\nstatic int focaltech_reconnect(struct psmouse *psmouse)\r\n{\r\nint error;\r\nfocaltech_reset(psmouse);\r\nerror = focaltech_switch_protocol(psmouse);\r\nif (error) {\r\npsmouse_err(psmouse, "Unable to initialize the device\n");\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic void focaltech_set_input_params(struct psmouse *psmouse)\r\n{\r\nstruct input_dev *dev = psmouse->dev;\r\nstruct focaltech_data *priv = psmouse->private;\r\n__clear_bit(EV_REL, dev->evbit);\r\n__clear_bit(REL_X, dev->relbit);\r\n__clear_bit(REL_Y, dev->relbit);\r\n__clear_bit(BTN_RIGHT, dev->keybit);\r\n__clear_bit(BTN_MIDDLE, dev->keybit);\r\n__set_bit(EV_ABS, dev->evbit);\r\ninput_set_abs_params(dev, ABS_MT_POSITION_X, 0, priv->x_max, 0, 0);\r\ninput_set_abs_params(dev, ABS_MT_POSITION_Y, 0, priv->y_max, 0, 0);\r\ninput_set_abs_params(dev, ABS_TOOL_WIDTH, 0, 15, 0, 0);\r\ninput_mt_init_slots(dev, 5, INPUT_MT_POINTER);\r\n__set_bit(INPUT_PROP_BUTTONPAD, dev->propbit);\r\n}\r\nstatic int focaltech_read_register(struct ps2dev *ps2dev, int reg,\r\nunsigned char *param)\r\n{\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETSCALE11))\r\nreturn -EIO;\r\nparam[0] = 0;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\r\nreturn -EIO;\r\nparam[0] = reg;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_SETRES))\r\nreturn -EIO;\r\nif (ps2_command(ps2dev, param, PSMOUSE_CMD_GETINFO))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int focaltech_read_size(struct psmouse *psmouse)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nstruct focaltech_data *priv = psmouse->private;\r\nchar param[3];\r\nif (focaltech_read_register(ps2dev, 2, param))\r\nreturn -EIO;\r\npriv->x_max = (unsigned char)param[1] * 128;\r\npriv->y_max = (unsigned char)param[2] * 128;\r\nreturn 0;\r\n}\r\nstatic void focaltech_set_resolution(struct psmouse *psmouse,\r\nunsigned int resolution)\r\n{\r\n}\r\nstatic void focaltech_set_rate(struct psmouse *psmouse, unsigned int rate)\r\n{\r\n}\r\nstatic void focaltech_set_scale(struct psmouse *psmouse,\r\nenum psmouse_scale scale)\r\n{\r\n}\r\nint focaltech_init(struct psmouse *psmouse)\r\n{\r\nstruct focaltech_data *priv;\r\nint error;\r\npsmouse->private = priv = kzalloc(sizeof(struct focaltech_data),\r\nGFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nfocaltech_reset(psmouse);\r\nerror = focaltech_read_size(psmouse);\r\nif (error) {\r\npsmouse_err(psmouse,\r\n"Unable to read the size of the touchpad\n");\r\ngoto fail;\r\n}\r\nerror = focaltech_switch_protocol(psmouse);\r\nif (error) {\r\npsmouse_err(psmouse, "Unable to initialize the device\n");\r\ngoto fail;\r\n}\r\nfocaltech_set_input_params(psmouse);\r\npsmouse->protocol_handler = focaltech_process_byte;\r\npsmouse->pktsize = 6;\r\npsmouse->disconnect = focaltech_disconnect;\r\npsmouse->reconnect = focaltech_reconnect;\r\npsmouse->cleanup = focaltech_reset;\r\npsmouse->resync_time = 0;\r\npsmouse->set_resolution = focaltech_set_resolution;\r\npsmouse->set_rate = focaltech_set_rate;\r\npsmouse->set_scale = focaltech_set_scale;\r\nreturn 0;\r\nfail:\r\nfocaltech_reset(psmouse);\r\nkfree(priv);\r\nreturn error;\r\n}

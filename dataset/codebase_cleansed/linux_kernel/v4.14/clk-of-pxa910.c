static void pxa910_pll_init(struct pxa910_clk_unit *pxa_unit)\r\n{\r\nstruct clk *clk;\r\nstruct mmp_clk_unit *unit = &pxa_unit->unit;\r\nmmp_register_fixed_rate_clks(unit, fixed_rate_clks,\r\nARRAY_SIZE(fixed_rate_clks));\r\nmmp_register_fixed_factor_clks(unit, fixed_factor_clks,\r\nARRAY_SIZE(fixed_factor_clks));\r\nclk = mmp_clk_register_factor("uart_pll", "pll1_4",\r\nCLK_SET_RATE_PARENT,\r\npxa_unit->mpmu_base + MPMU_UART_PLL,\r\n&uart_factor_masks, uart_factor_tbl,\r\nARRAY_SIZE(uart_factor_tbl), NULL);\r\nmmp_clk_add(unit, PXA910_CLK_UART_PLL, clk);\r\n}\r\nstatic void pxa910_apb_periph_clk_init(struct pxa910_clk_unit *pxa_unit)\r\n{\r\nstruct mmp_clk_unit *unit = &pxa_unit->unit;\r\nmmp_register_mux_clks(unit, apbc_mux_clks, pxa_unit->apbc_base,\r\nARRAY_SIZE(apbc_mux_clks));\r\nmmp_register_mux_clks(unit, apbcp_mux_clks, pxa_unit->apbcp_base,\r\nARRAY_SIZE(apbcp_mux_clks));\r\nmmp_register_gate_clks(unit, apbc_gate_clks, pxa_unit->apbc_base,\r\nARRAY_SIZE(apbc_gate_clks));\r\nmmp_register_gate_clks(unit, apbcp_gate_clks, pxa_unit->apbcp_base,\r\nARRAY_SIZE(apbcp_gate_clks));\r\n}\r\nstatic void pxa910_axi_periph_clk_init(struct pxa910_clk_unit *pxa_unit)\r\n{\r\nstruct mmp_clk_unit *unit = &pxa_unit->unit;\r\nmmp_register_mux_clks(unit, apmu_mux_clks, pxa_unit->apmu_base,\r\nARRAY_SIZE(apmu_mux_clks));\r\nmmp_register_div_clks(unit, apmu_div_clks, pxa_unit->apmu_base,\r\nARRAY_SIZE(apmu_div_clks));\r\nmmp_register_gate_clks(unit, apmu_gate_clks, pxa_unit->apmu_base,\r\nARRAY_SIZE(apmu_gate_clks));\r\n}\r\nstatic void pxa910_clk_reset_init(struct device_node *np,\r\nstruct pxa910_clk_unit *pxa_unit)\r\n{\r\nstruct mmp_clk_reset_cell *cells;\r\nint i, base, nr_resets_apbc, nr_resets_apbcp, nr_resets;\r\nnr_resets_apbc = ARRAY_SIZE(apbc_gate_clks);\r\nnr_resets_apbcp = ARRAY_SIZE(apbcp_gate_clks);\r\nnr_resets = nr_resets_apbc + nr_resets_apbcp;\r\ncells = kcalloc(nr_resets, sizeof(*cells), GFP_KERNEL);\r\nif (!cells)\r\nreturn;\r\nbase = 0;\r\nfor (i = 0; i < nr_resets_apbc; i++) {\r\ncells[base + i].clk_id = apbc_gate_clks[i].id;\r\ncells[base + i].reg =\r\npxa_unit->apbc_base + apbc_gate_clks[i].offset;\r\ncells[base + i].flags = 0;\r\ncells[base + i].lock = apbc_gate_clks[i].lock;\r\ncells[base + i].bits = 0x4;\r\n}\r\nbase = nr_resets_apbc;\r\nfor (i = 0; i < nr_resets_apbcp; i++) {\r\ncells[base + i].clk_id = apbcp_gate_clks[i].id;\r\ncells[base + i].reg =\r\npxa_unit->apbc_base + apbc_gate_clks[i].offset;\r\ncells[base + i].flags = 0;\r\ncells[base + i].lock = apbc_gate_clks[i].lock;\r\ncells[base + i].bits = 0x4;\r\n}\r\nmmp_clk_reset_register(np, cells, nr_resets);\r\n}\r\nstatic void __init pxa910_clk_init(struct device_node *np)\r\n{\r\nstruct pxa910_clk_unit *pxa_unit;\r\npxa_unit = kzalloc(sizeof(*pxa_unit), GFP_KERNEL);\r\nif (!pxa_unit)\r\nreturn;\r\npxa_unit->mpmu_base = of_iomap(np, 0);\r\nif (!pxa_unit->mpmu_base) {\r\npr_err("failed to map mpmu registers\n");\r\ngoto free_memory;\r\n}\r\npxa_unit->apmu_base = of_iomap(np, 1);\r\nif (!pxa_unit->apmu_base) {\r\npr_err("failed to map apmu registers\n");\r\ngoto unmap_mpmu_region;\r\n}\r\npxa_unit->apbc_base = of_iomap(np, 2);\r\nif (!pxa_unit->apbc_base) {\r\npr_err("failed to map apbc registers\n");\r\ngoto unmap_apmu_region;\r\n}\r\npxa_unit->apbcp_base = of_iomap(np, 3);\r\nif (!pxa_unit->apbcp_base) {\r\npr_err("failed to map apbcp registers\n");\r\ngoto unmap_apbc_region;\r\n}\r\nmmp_clk_init(np, &pxa_unit->unit, PXA910_NR_CLKS);\r\npxa910_pll_init(pxa_unit);\r\npxa910_apb_periph_clk_init(pxa_unit);\r\npxa910_axi_periph_clk_init(pxa_unit);\r\npxa910_clk_reset_init(np, pxa_unit);\r\nreturn;\r\nunmap_apbc_region:\r\niounmap(pxa_unit->apbc_base);\r\nunmap_apmu_region:\r\niounmap(pxa_unit->apmu_base);\r\nunmap_mpmu_region:\r\niounmap(pxa_unit->mpmu_base);\r\nfree_memory:\r\nkfree(pxa_unit);\r\n}

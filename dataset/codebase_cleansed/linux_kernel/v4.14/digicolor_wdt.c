static void dc_wdt_set(struct dc_wdt *wdt, u32 ticks)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&wdt->lock, flags);\r\nwritel_relaxed(0, wdt->base + TIMER_A_CONTROL);\r\nwritel_relaxed(ticks, wdt->base + TIMER_A_COUNT);\r\nwritel_relaxed(TIMER_A_ENABLE_COUNT | TIMER_A_ENABLE_WATCHDOG,\r\nwdt->base + TIMER_A_CONTROL);\r\nspin_unlock_irqrestore(&wdt->lock, flags);\r\n}\r\nstatic int dc_wdt_restart(struct watchdog_device *wdog, unsigned long action,\r\nvoid *data)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\ndc_wdt_set(wdt, 1);\r\nmdelay(500);\r\nreturn 0;\r\n}\r\nstatic int dc_wdt_start(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\ndc_wdt_set(wdt, wdog->timeout * clk_get_rate(wdt->clk));\r\nreturn 0;\r\n}\r\nstatic int dc_wdt_stop(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\nwritel_relaxed(0, wdt->base + TIMER_A_CONTROL);\r\nreturn 0;\r\n}\r\nstatic int dc_wdt_set_timeout(struct watchdog_device *wdog, unsigned int t)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\ndc_wdt_set(wdt, t * clk_get_rate(wdt->clk));\r\nwdog->timeout = t;\r\nreturn 0;\r\n}\r\nstatic unsigned int dc_wdt_get_timeleft(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\nuint32_t count = readl_relaxed(wdt->base + TIMER_A_COUNT);\r\nreturn count / clk_get_rate(wdt->clk);\r\n}\r\nstatic int dc_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nstruct dc_wdt *wdt;\r\nint ret;\r\nwdt = devm_kzalloc(dev, sizeof(struct dc_wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nwdt->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(wdt->base))\r\nreturn PTR_ERR(wdt->base);\r\nwdt->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(wdt->clk))\r\nreturn PTR_ERR(wdt->clk);\r\ndc_wdt_wdd.max_timeout = U32_MAX / clk_get_rate(wdt->clk);\r\ndc_wdt_wdd.timeout = dc_wdt_wdd.max_timeout;\r\ndc_wdt_wdd.parent = dev;\r\nspin_lock_init(&wdt->lock);\r\nwatchdog_set_drvdata(&dc_wdt_wdd, wdt);\r\nwatchdog_set_restart_priority(&dc_wdt_wdd, 128);\r\nwatchdog_init_timeout(&dc_wdt_wdd, timeout, dev);\r\nwatchdog_stop_on_reboot(&dc_wdt_wdd);\r\nret = devm_watchdog_register_device(dev, &dc_wdt_wdd);\r\nif (ret) {\r\ndev_err(dev, "Failed to register watchdog device");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

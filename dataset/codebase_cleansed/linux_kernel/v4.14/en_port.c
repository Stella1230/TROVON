int mlx4_SET_VLAN_FLTR(struct mlx4_dev *dev, struct mlx4_en_priv *priv)\r\n{\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_set_vlan_fltr_mbox *filter;\r\nint i;\r\nint j;\r\nint index = 0;\r\nu32 entry;\r\nint err = 0;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nfilter = mailbox->buf;\r\nfor (i = VLAN_FLTR_SIZE - 1; i >= 0; i--) {\r\nentry = 0;\r\nfor (j = 0; j < 32; j++)\r\nif (test_bit(index++, priv->active_vlans))\r\nentry |= 1 << j;\r\nfilter->entry[i] = cpu_to_be32(entry);\r\n}\r\nerr = mlx4_cmd(dev, mailbox->dma, priv->port, 0, MLX4_CMD_SET_VLAN_FLTR,\r\nMLX4_CMD_TIME_CLASS_B, MLX4_CMD_WRAPPED);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_en_QUERY_PORT(struct mlx4_en_dev *mdev, u8 port)\r\n{\r\nstruct mlx4_en_query_port_context *qport_context;\r\nstruct mlx4_en_priv *priv = netdev_priv(mdev->pndev[port]);\r\nstruct mlx4_en_port_state *state = &priv->port_state;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nint err;\r\nmailbox = mlx4_alloc_cmd_mailbox(mdev->dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nerr = mlx4_cmd_box(mdev->dev, 0, mailbox->dma, port, 0,\r\nMLX4_CMD_QUERY_PORT, MLX4_CMD_TIME_CLASS_B,\r\nMLX4_CMD_WRAPPED);\r\nif (err)\r\ngoto out;\r\nqport_context = mailbox->buf;\r\nstate->link_state = !!(qport_context->link_up & MLX4_EN_LINK_UP_MASK);\r\nswitch (qport_context->link_speed & MLX4_EN_SPEED_MASK) {\r\ncase MLX4_EN_100M_SPEED:\r\nstate->link_speed = SPEED_100;\r\nbreak;\r\ncase MLX4_EN_1G_SPEED:\r\nstate->link_speed = SPEED_1000;\r\nbreak;\r\ncase MLX4_EN_10G_SPEED_XAUI:\r\ncase MLX4_EN_10G_SPEED_XFI:\r\nstate->link_speed = SPEED_10000;\r\nbreak;\r\ncase MLX4_EN_20G_SPEED:\r\nstate->link_speed = SPEED_20000;\r\nbreak;\r\ncase MLX4_EN_40G_SPEED:\r\nstate->link_speed = SPEED_40000;\r\nbreak;\r\ncase MLX4_EN_56G_SPEED:\r\nstate->link_speed = SPEED_56000;\r\nbreak;\r\ndefault:\r\nstate->link_speed = -1;\r\nbreak;\r\n}\r\nstate->transceiver = qport_context->transceiver;\r\nstate->flags = 0;\r\nstate->flags |= (qport_context->link_up & MLX4_EN_ANC_MASK) ?\r\nMLX4_EN_PORT_ANC : 0;\r\nstate->flags |= (qport_context->autoneg & MLX4_EN_AUTONEG_MASK) ?\r\nMLX4_EN_PORT_ANE : 0;\r\nout:\r\nmlx4_free_cmd_mailbox(mdev->dev, mailbox);\r\nreturn err;\r\n}\r\nstatic unsigned long en_stats_adder(__be64 *start, __be64 *next, int num)\r\n{\r\n__be64 *curr = start;\r\nunsigned long ret = 0;\r\nint i;\r\nint offset = next - start;\r\nfor (i = 0; i < num; i++) {\r\nret += be64_to_cpu(*curr);\r\ncurr += offset;\r\n}\r\nreturn ret;\r\n}\r\nvoid mlx4_en_fold_software_stats(struct net_device *dev)\r\n{\r\nstruct mlx4_en_priv *priv = netdev_priv(dev);\r\nstruct mlx4_en_dev *mdev = priv->mdev;\r\nunsigned long packets, bytes;\r\nint i;\r\nif (!priv->port_up || mlx4_is_master(mdev->dev))\r\nreturn;\r\npackets = 0;\r\nbytes = 0;\r\nfor (i = 0; i < priv->rx_ring_num; i++) {\r\nconst struct mlx4_en_rx_ring *ring = priv->rx_ring[i];\r\npackets += READ_ONCE(ring->packets);\r\nbytes += READ_ONCE(ring->bytes);\r\n}\r\ndev->stats.rx_packets = packets;\r\ndev->stats.rx_bytes = bytes;\r\npackets = 0;\r\nbytes = 0;\r\nfor (i = 0; i < priv->tx_ring_num[TX]; i++) {\r\nconst struct mlx4_en_tx_ring *ring = priv->tx_ring[TX][i];\r\npackets += READ_ONCE(ring->packets);\r\nbytes += READ_ONCE(ring->bytes);\r\n}\r\ndev->stats.tx_packets = packets;\r\ndev->stats.tx_bytes = bytes;\r\n}\r\nint mlx4_en_DUMP_ETH_STATS(struct mlx4_en_dev *mdev, u8 port, u8 reset)\r\n{\r\nstruct mlx4_counter tmp_counter_stats;\r\nstruct mlx4_en_stat_out_mbox *mlx4_en_stats;\r\nstruct mlx4_en_stat_out_flow_control_mbox *flowstats;\r\nstruct net_device *dev = mdev->pndev[port];\r\nstruct mlx4_en_priv *priv = netdev_priv(dev);\r\nstruct net_device_stats *stats = &dev->stats;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nu64 in_mod = reset << 8 | port;\r\nint err;\r\nint i, counter_index;\r\nunsigned long sw_tx_dropped = 0;\r\nunsigned long sw_rx_dropped = 0;\r\nmailbox = mlx4_alloc_cmd_mailbox(mdev->dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nerr = mlx4_cmd_box(mdev->dev, 0, mailbox->dma, in_mod, 0,\r\nMLX4_CMD_DUMP_ETH_STATS, MLX4_CMD_TIME_CLASS_B,\r\nMLX4_CMD_NATIVE);\r\nif (err)\r\ngoto out;\r\nmlx4_en_stats = mailbox->buf;\r\nspin_lock_bh(&priv->stats_lock);\r\nmlx4_en_fold_software_stats(dev);\r\npriv->port_stats.rx_chksum_good = 0;\r\npriv->port_stats.rx_chksum_none = 0;\r\npriv->port_stats.rx_chksum_complete = 0;\r\npriv->port_stats.rx_alloc_pages = 0;\r\npriv->xdp_stats.rx_xdp_drop = 0;\r\npriv->xdp_stats.rx_xdp_tx = 0;\r\npriv->xdp_stats.rx_xdp_tx_full = 0;\r\nfor (i = 0; i < priv->rx_ring_num; i++) {\r\nconst struct mlx4_en_rx_ring *ring = priv->rx_ring[i];\r\nsw_rx_dropped += READ_ONCE(ring->dropped);\r\npriv->port_stats.rx_chksum_good += READ_ONCE(ring->csum_ok);\r\npriv->port_stats.rx_chksum_none += READ_ONCE(ring->csum_none);\r\npriv->port_stats.rx_chksum_complete += READ_ONCE(ring->csum_complete);\r\npriv->port_stats.rx_alloc_pages += READ_ONCE(ring->rx_alloc_pages);\r\npriv->xdp_stats.rx_xdp_drop += READ_ONCE(ring->xdp_drop);\r\npriv->xdp_stats.rx_xdp_tx += READ_ONCE(ring->xdp_tx);\r\npriv->xdp_stats.rx_xdp_tx_full += READ_ONCE(ring->xdp_tx_full);\r\n}\r\npriv->port_stats.tx_chksum_offload = 0;\r\npriv->port_stats.queue_stopped = 0;\r\npriv->port_stats.wake_queue = 0;\r\npriv->port_stats.tso_packets = 0;\r\npriv->port_stats.xmit_more = 0;\r\nfor (i = 0; i < priv->tx_ring_num[TX]; i++) {\r\nconst struct mlx4_en_tx_ring *ring = priv->tx_ring[TX][i];\r\nsw_tx_dropped += READ_ONCE(ring->tx_dropped);\r\npriv->port_stats.tx_chksum_offload += READ_ONCE(ring->tx_csum);\r\npriv->port_stats.queue_stopped += READ_ONCE(ring->queue_stopped);\r\npriv->port_stats.wake_queue += READ_ONCE(ring->wake_queue);\r\npriv->port_stats.tso_packets += READ_ONCE(ring->tso_packets);\r\npriv->port_stats.xmit_more += READ_ONCE(ring->xmit_more);\r\n}\r\nif (mlx4_is_master(mdev->dev)) {\r\nstats->rx_packets = en_stats_adder(&mlx4_en_stats->RTOT_prio_0,\r\n&mlx4_en_stats->RTOT_prio_1,\r\nNUM_PRIORITIES);\r\nstats->tx_packets = en_stats_adder(&mlx4_en_stats->TTOT_prio_0,\r\n&mlx4_en_stats->TTOT_prio_1,\r\nNUM_PRIORITIES);\r\nstats->rx_bytes = en_stats_adder(&mlx4_en_stats->ROCT_prio_0,\r\n&mlx4_en_stats->ROCT_prio_1,\r\nNUM_PRIORITIES);\r\nstats->tx_bytes = en_stats_adder(&mlx4_en_stats->TOCT_prio_0,\r\n&mlx4_en_stats->TOCT_prio_1,\r\nNUM_PRIORITIES);\r\n}\r\nstats->rx_errors = be64_to_cpu(mlx4_en_stats->PCS) +\r\nbe32_to_cpu(mlx4_en_stats->RJBBR) +\r\nbe32_to_cpu(mlx4_en_stats->RCRC) +\r\nbe32_to_cpu(mlx4_en_stats->RRUNT) +\r\nbe64_to_cpu(mlx4_en_stats->RInRangeLengthErr) +\r\nbe64_to_cpu(mlx4_en_stats->ROutRangeLengthErr) +\r\nbe32_to_cpu(mlx4_en_stats->RSHORT) +\r\nen_stats_adder(&mlx4_en_stats->RGIANT_prio_0,\r\n&mlx4_en_stats->RGIANT_prio_1,\r\nNUM_PRIORITIES);\r\nstats->tx_errors = en_stats_adder(&mlx4_en_stats->TGIANT_prio_0,\r\n&mlx4_en_stats->TGIANT_prio_1,\r\nNUM_PRIORITIES);\r\nstats->multicast = en_stats_adder(&mlx4_en_stats->MCAST_prio_0,\r\n&mlx4_en_stats->MCAST_prio_1,\r\nNUM_PRIORITIES);\r\nstats->rx_dropped = be32_to_cpu(mlx4_en_stats->RDROP) +\r\nsw_rx_dropped;\r\nstats->rx_length_errors = be32_to_cpu(mlx4_en_stats->RdropLength);\r\nstats->rx_crc_errors = be32_to_cpu(mlx4_en_stats->RCRC);\r\nstats->rx_fifo_errors = be32_to_cpu(mlx4_en_stats->RdropOvflw);\r\nstats->tx_dropped = be32_to_cpu(mlx4_en_stats->TDROP) +\r\nsw_tx_dropped;\r\npriv->pkstats.rx_multicast_packets = stats->multicast;\r\npriv->pkstats.rx_broadcast_packets =\r\nen_stats_adder(&mlx4_en_stats->RBCAST_prio_0,\r\n&mlx4_en_stats->RBCAST_prio_1,\r\nNUM_PRIORITIES);\r\npriv->pkstats.rx_jabbers = be32_to_cpu(mlx4_en_stats->RJBBR);\r\npriv->pkstats.rx_in_range_length_error =\r\nbe64_to_cpu(mlx4_en_stats->RInRangeLengthErr);\r\npriv->pkstats.rx_out_range_length_error =\r\nbe64_to_cpu(mlx4_en_stats->ROutRangeLengthErr);\r\npriv->pkstats.tx_multicast_packets =\r\nen_stats_adder(&mlx4_en_stats->TMCAST_prio_0,\r\n&mlx4_en_stats->TMCAST_prio_1,\r\nNUM_PRIORITIES);\r\npriv->pkstats.tx_broadcast_packets =\r\nen_stats_adder(&mlx4_en_stats->TBCAST_prio_0,\r\n&mlx4_en_stats->TBCAST_prio_1,\r\nNUM_PRIORITIES);\r\npriv->pkstats.rx_prio[0][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_0);\r\npriv->pkstats.rx_prio[0][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_0);\r\npriv->pkstats.rx_prio[1][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_1);\r\npriv->pkstats.rx_prio[1][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_1);\r\npriv->pkstats.rx_prio[2][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_2);\r\npriv->pkstats.rx_prio[2][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_2);\r\npriv->pkstats.rx_prio[3][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_3);\r\npriv->pkstats.rx_prio[3][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_3);\r\npriv->pkstats.rx_prio[4][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_4);\r\npriv->pkstats.rx_prio[4][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_4);\r\npriv->pkstats.rx_prio[5][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_5);\r\npriv->pkstats.rx_prio[5][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_5);\r\npriv->pkstats.rx_prio[6][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_6);\r\npriv->pkstats.rx_prio[6][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_6);\r\npriv->pkstats.rx_prio[7][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_7);\r\npriv->pkstats.rx_prio[7][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_7);\r\npriv->pkstats.rx_prio[8][0] = be64_to_cpu(mlx4_en_stats->RTOT_novlan);\r\npriv->pkstats.rx_prio[8][1] = be64_to_cpu(mlx4_en_stats->ROCT_novlan);\r\npriv->pkstats.tx_prio[0][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_0);\r\npriv->pkstats.tx_prio[0][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_0);\r\npriv->pkstats.tx_prio[1][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_1);\r\npriv->pkstats.tx_prio[1][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_1);\r\npriv->pkstats.tx_prio[2][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_2);\r\npriv->pkstats.tx_prio[2][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_2);\r\npriv->pkstats.tx_prio[3][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_3);\r\npriv->pkstats.tx_prio[3][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_3);\r\npriv->pkstats.tx_prio[4][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_4);\r\npriv->pkstats.tx_prio[4][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_4);\r\npriv->pkstats.tx_prio[5][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_5);\r\npriv->pkstats.tx_prio[5][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_5);\r\npriv->pkstats.tx_prio[6][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_6);\r\npriv->pkstats.tx_prio[6][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_6);\r\npriv->pkstats.tx_prio[7][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_7);\r\npriv->pkstats.tx_prio[7][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_7);\r\npriv->pkstats.tx_prio[8][0] = be64_to_cpu(mlx4_en_stats->TTOT_novlan);\r\npriv->pkstats.tx_prio[8][1] = be64_to_cpu(mlx4_en_stats->TOCT_novlan);\r\nspin_unlock_bh(&priv->stats_lock);\r\nmemset(&tmp_counter_stats, 0, sizeof(tmp_counter_stats));\r\ncounter_index = mlx4_get_default_counter_index(mdev->dev, port);\r\nerr = mlx4_get_counter_stats(mdev->dev, counter_index,\r\n&tmp_counter_stats, reset);\r\nmemset(mailbox->buf, 0xff, sizeof(*flowstats) * MLX4_NUM_PRIORITIES);\r\nif (mdev->dev->caps.flags2 & MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN) {\r\nmemset(mailbox->buf, 0,\r\nsizeof(*flowstats) * MLX4_NUM_PRIORITIES);\r\nerr = mlx4_cmd_box(mdev->dev, 0, mailbox->dma,\r\nin_mod | MLX4_DUMP_ETH_STATS_FLOW_CONTROL,\r\n0, MLX4_CMD_DUMP_ETH_STATS,\r\nMLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\r\nif (err)\r\ngoto out;\r\n}\r\nflowstats = mailbox->buf;\r\nspin_lock_bh(&priv->stats_lock);\r\nif (tmp_counter_stats.counter_mode == 0) {\r\npriv->pf_stats.rx_bytes = be64_to_cpu(tmp_counter_stats.rx_bytes);\r\npriv->pf_stats.tx_bytes = be64_to_cpu(tmp_counter_stats.tx_bytes);\r\npriv->pf_stats.rx_packets = be64_to_cpu(tmp_counter_stats.rx_frames);\r\npriv->pf_stats.tx_packets = be64_to_cpu(tmp_counter_stats.tx_frames);\r\n}\r\nfor (i = 0; i < MLX4_NUM_PRIORITIES; i++) {\r\npriv->rx_priority_flowstats[i].rx_pause =\r\nbe64_to_cpu(flowstats[i].rx_pause);\r\npriv->rx_priority_flowstats[i].rx_pause_duration =\r\nbe64_to_cpu(flowstats[i].rx_pause_duration);\r\npriv->rx_priority_flowstats[i].rx_pause_transition =\r\nbe64_to_cpu(flowstats[i].rx_pause_transition);\r\npriv->tx_priority_flowstats[i].tx_pause =\r\nbe64_to_cpu(flowstats[i].tx_pause);\r\npriv->tx_priority_flowstats[i].tx_pause_duration =\r\nbe64_to_cpu(flowstats[i].tx_pause_duration);\r\npriv->tx_priority_flowstats[i].tx_pause_transition =\r\nbe64_to_cpu(flowstats[i].tx_pause_transition);\r\n}\r\npriv->rx_flowstats.rx_pause =\r\nbe64_to_cpu(flowstats[0].rx_pause);\r\npriv->rx_flowstats.rx_pause_duration =\r\nbe64_to_cpu(flowstats[0].rx_pause_duration);\r\npriv->rx_flowstats.rx_pause_transition =\r\nbe64_to_cpu(flowstats[0].rx_pause_transition);\r\npriv->tx_flowstats.tx_pause =\r\nbe64_to_cpu(flowstats[0].tx_pause);\r\npriv->tx_flowstats.tx_pause_duration =\r\nbe64_to_cpu(flowstats[0].tx_pause_duration);\r\npriv->tx_flowstats.tx_pause_transition =\r\nbe64_to_cpu(flowstats[0].tx_pause_transition);\r\nspin_unlock_bh(&priv->stats_lock);\r\nout:\r\nmlx4_free_cmd_mailbox(mdev->dev, mailbox);\r\nreturn err;\r\n}

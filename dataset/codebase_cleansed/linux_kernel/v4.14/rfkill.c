bool b43legacy_is_hw_radio_enabled(struct b43legacy_wldev *dev)\r\n{\r\nif (dev->dev->id.revision >= 3) {\r\nif (!(b43legacy_read32(dev, B43legacy_MMIO_RADIO_HWENABLED_HI)\r\n& B43legacy_MMIO_RADIO_HWENABLED_HI_MASK))\r\nreturn true;\r\n} else {\r\nif (b43legacy_status(dev) < B43legacy_STAT_STARTED)\r\nreturn true;\r\nif (b43legacy_read16(dev, B43legacy_MMIO_RADIO_HWENABLED_LO)\r\n& B43legacy_MMIO_RADIO_HWENABLED_LO_MASK)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid b43legacy_rfkill_poll(struct ieee80211_hw *hw)\r\n{\r\nstruct b43legacy_wl *wl = hw_to_b43legacy_wl(hw);\r\nstruct b43legacy_wldev *dev = wl->current_dev;\r\nstruct ssb_bus *bus = dev->dev->bus;\r\nbool enabled;\r\nbool brought_up = false;\r\nmutex_lock(&wl->mutex);\r\nif (unlikely(b43legacy_status(dev) < B43legacy_STAT_INITIALIZED)) {\r\nif (ssb_bus_powerup(bus, 0)) {\r\nmutex_unlock(&wl->mutex);\r\nreturn;\r\n}\r\nssb_device_enable(dev->dev, 0);\r\nbrought_up = true;\r\n}\r\nenabled = b43legacy_is_hw_radio_enabled(dev);\r\nif (unlikely(enabled != dev->radio_hw_enable)) {\r\ndev->radio_hw_enable = enabled;\r\nb43legacyinfo(wl, "Radio hardware status changed to %s\n",\r\nenabled ? "ENABLED" : "DISABLED");\r\nwiphy_rfkill_set_hw_state(hw->wiphy, !enabled);\r\nif (enabled != dev->phy.radio_on) {\r\nif (enabled)\r\nb43legacy_radio_turn_on(dev);\r\nelse\r\nb43legacy_radio_turn_off(dev, 0);\r\n}\r\n}\r\nif (brought_up) {\r\nssb_device_disable(dev->dev, 0);\r\nssb_bus_may_powerdown(bus);\r\n}\r\nmutex_unlock(&wl->mutex);\r\n}

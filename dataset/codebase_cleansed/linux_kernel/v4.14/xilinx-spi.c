static enum fpga_mgr_states xilinx_spi_state(struct fpga_manager *mgr)\r\n{\r\nstruct xilinx_spi_conf *conf = mgr->priv;\r\nif (!gpiod_get_value(conf->done))\r\nreturn FPGA_MGR_STATE_RESET;\r\nreturn FPGA_MGR_STATE_UNKNOWN;\r\n}\r\nstatic int xilinx_spi_write_init(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info,\r\nconst char *buf, size_t count)\r\n{\r\nstruct xilinx_spi_conf *conf = mgr->priv;\r\nconst size_t prog_latency_7500us = 7500;\r\nconst size_t prog_pulse_1us = 1;\r\nif (info->flags & FPGA_MGR_PARTIAL_RECONFIG) {\r\ndev_err(&mgr->dev, "Partial reconfiguration not supported.\n");\r\nreturn -EINVAL;\r\n}\r\ngpiod_set_value(conf->prog_b, 1);\r\nudelay(prog_pulse_1us);\r\ngpiod_set_value(conf->prog_b, 0);\r\nif (gpiod_get_value(conf->done)) {\r\ndev_err(&mgr->dev, "Unexpected DONE pin state...\n");\r\nreturn -EIO;\r\n}\r\nusleep_range(prog_latency_7500us, prog_latency_7500us + 100);\r\nreturn 0;\r\n}\r\nstatic int xilinx_spi_write(struct fpga_manager *mgr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct xilinx_spi_conf *conf = mgr->priv;\r\nconst char *fw_data = buf;\r\nconst char *fw_data_end = fw_data + count;\r\nwhile (fw_data < fw_data_end) {\r\nsize_t remaining, stride;\r\nint ret;\r\nremaining = fw_data_end - fw_data;\r\nstride = min_t(size_t, remaining, SZ_4K);\r\nret = spi_write(conf->spi, fw_data, stride);\r\nif (ret) {\r\ndev_err(&mgr->dev, "SPI error in firmware write: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nfw_data += stride;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xilinx_spi_apply_cclk_cycles(struct xilinx_spi_conf *conf)\r\n{\r\nstruct spi_device *spi = conf->spi;\r\nconst u8 din_data[1] = { 0xff };\r\nint ret;\r\nret = spi_write(conf->spi, din_data, sizeof(din_data));\r\nif (ret)\r\ndev_err(&spi->dev, "applying CCLK cycles failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int xilinx_spi_write_complete(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info)\r\n{\r\nstruct xilinx_spi_conf *conf = mgr->priv;\r\nunsigned long timeout;\r\nint ret;\r\nif (gpiod_get_value(conf->done))\r\nreturn xilinx_spi_apply_cclk_cycles(conf);\r\ntimeout = jiffies + usecs_to_jiffies(info->config_complete_timeout_us);\r\nwhile (time_before(jiffies, timeout)) {\r\nret = xilinx_spi_apply_cclk_cycles(conf);\r\nif (ret)\r\nreturn ret;\r\nif (gpiod_get_value(conf->done))\r\nreturn xilinx_spi_apply_cclk_cycles(conf);\r\n}\r\ndev_err(&mgr->dev, "Timeout after config data transfer.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int xilinx_spi_probe(struct spi_device *spi)\r\n{\r\nstruct xilinx_spi_conf *conf;\r\nconf = devm_kzalloc(&spi->dev, sizeof(*conf), GFP_KERNEL);\r\nif (!conf)\r\nreturn -ENOMEM;\r\nconf->spi = spi;\r\nconf->prog_b = devm_gpiod_get(&spi->dev, "prog_b", GPIOD_OUT_LOW);\r\nif (IS_ERR(conf->prog_b)) {\r\ndev_err(&spi->dev, "Failed to get PROGRAM_B gpio: %ld\n",\r\nPTR_ERR(conf->prog_b));\r\nreturn PTR_ERR(conf->prog_b);\r\n}\r\nconf->done = devm_gpiod_get(&spi->dev, "done", GPIOD_IN);\r\nif (IS_ERR(conf->done)) {\r\ndev_err(&spi->dev, "Failed to get DONE gpio: %ld\n",\r\nPTR_ERR(conf->done));\r\nreturn PTR_ERR(conf->done);\r\n}\r\nreturn fpga_mgr_register(&spi->dev, "Xilinx Slave Serial FPGA Manager",\r\n&xilinx_spi_ops, conf);\r\n}\r\nstatic int xilinx_spi_remove(struct spi_device *spi)\r\n{\r\nfpga_mgr_unregister(&spi->dev);\r\nreturn 0;\r\n}

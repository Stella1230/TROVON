static int btqcomsmd_recv(struct hci_dev *hdev, unsigned int type,\r\nconst void *data, size_t count)\r\n{\r\nstruct sk_buff *skb;\r\nskb = bt_skb_alloc(count, GFP_ATOMIC);\r\nif (!skb) {\r\nhdev->stat.err_rx++;\r\nreturn -ENOMEM;\r\n}\r\nhci_skb_pkt_type(skb) = type;\r\nskb_put_data(skb, data, count);\r\nreturn hci_recv_frame(hdev, skb);\r\n}\r\nstatic int btqcomsmd_acl_callback(struct rpmsg_device *rpdev, void *data,\r\nint count, void *priv, u32 addr)\r\n{\r\nstruct btqcomsmd *btq = priv;\r\nbtq->hdev->stat.byte_rx += count;\r\nreturn btqcomsmd_recv(btq->hdev, HCI_ACLDATA_PKT, data, count);\r\n}\r\nstatic int btqcomsmd_cmd_callback(struct rpmsg_device *rpdev, void *data,\r\nint count, void *priv, u32 addr)\r\n{\r\nstruct btqcomsmd *btq = priv;\r\nreturn btqcomsmd_recv(btq->hdev, HCI_EVENT_PKT, data, count);\r\n}\r\nstatic int btqcomsmd_send(struct hci_dev *hdev, struct sk_buff *skb)\r\n{\r\nstruct btqcomsmd *btq = hci_get_drvdata(hdev);\r\nint ret;\r\nswitch (hci_skb_pkt_type(skb)) {\r\ncase HCI_ACLDATA_PKT:\r\nret = rpmsg_send(btq->acl_channel, skb->data, skb->len);\r\nhdev->stat.acl_tx++;\r\nhdev->stat.byte_tx += skb->len;\r\nbreak;\r\ncase HCI_COMMAND_PKT:\r\nret = rpmsg_send(btq->cmd_channel, skb->data, skb->len);\r\nhdev->stat.cmd_tx++;\r\nbreak;\r\ndefault:\r\nret = -EILSEQ;\r\nbreak;\r\n}\r\nkfree_skb(skb);\r\nreturn ret;\r\n}\r\nstatic int btqcomsmd_open(struct hci_dev *hdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int btqcomsmd_close(struct hci_dev *hdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int btqcomsmd_probe(struct platform_device *pdev)\r\n{\r\nstruct btqcomsmd *btq;\r\nstruct hci_dev *hdev;\r\nvoid *wcnss;\r\nint ret;\r\nbtq = devm_kzalloc(&pdev->dev, sizeof(*btq), GFP_KERNEL);\r\nif (!btq)\r\nreturn -ENOMEM;\r\nwcnss = dev_get_drvdata(pdev->dev.parent);\r\nbtq->acl_channel = qcom_wcnss_open_channel(wcnss, "APPS_RIVA_BT_ACL",\r\nbtqcomsmd_acl_callback, btq);\r\nif (IS_ERR(btq->acl_channel))\r\nreturn PTR_ERR(btq->acl_channel);\r\nbtq->cmd_channel = qcom_wcnss_open_channel(wcnss, "APPS_RIVA_BT_CMD",\r\nbtqcomsmd_cmd_callback, btq);\r\nif (IS_ERR(btq->cmd_channel))\r\nreturn PTR_ERR(btq->cmd_channel);\r\nhdev = hci_alloc_dev();\r\nif (!hdev)\r\nreturn -ENOMEM;\r\nhci_set_drvdata(hdev, btq);\r\nbtq->hdev = hdev;\r\nSET_HCIDEV_DEV(hdev, &pdev->dev);\r\nhdev->bus = HCI_SMD;\r\nhdev->open = btqcomsmd_open;\r\nhdev->close = btqcomsmd_close;\r\nhdev->send = btqcomsmd_send;\r\nhdev->set_bdaddr = qca_set_bdaddr_rome;\r\nret = hci_register_dev(hdev);\r\nif (ret < 0) {\r\nhci_free_dev(hdev);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, btq);\r\nreturn 0;\r\n}\r\nstatic int btqcomsmd_remove(struct platform_device *pdev)\r\n{\r\nstruct btqcomsmd *btq = platform_get_drvdata(pdev);\r\nhci_unregister_dev(btq->hdev);\r\nhci_free_dev(btq->hdev);\r\nrpmsg_destroy_ept(btq->cmd_channel);\r\nrpmsg_destroy_ept(btq->acl_channel);\r\nreturn 0;\r\n}

static int max77620_regulator_get_fps_src(struct max77620_regulator *pmic,\r\nint id)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(pmic->rmap, rinfo->fps_addr, &val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x read failed %d\n",\r\nrinfo->fps_addr, ret);\r\nreturn ret;\r\n}\r\nreturn (val & MAX77620_FPS_SRC_MASK) >> MAX77620_FPS_SRC_SHIFT;\r\n}\r\nstatic int max77620_regulator_set_fps_src(struct max77620_regulator *pmic,\r\nint fps_src, int id)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int val;\r\nint ret;\r\nif (!rinfo)\r\nreturn 0;\r\nswitch (fps_src) {\r\ncase MAX77620_FPS_SRC_0:\r\ncase MAX77620_FPS_SRC_1:\r\ncase MAX77620_FPS_SRC_2:\r\ncase MAX77620_FPS_SRC_NONE:\r\nbreak;\r\ncase MAX77620_FPS_SRC_DEF:\r\nret = regmap_read(pmic->rmap, rinfo->fps_addr, &val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x read failed %d\n",\r\nrinfo->fps_addr, ret);\r\nreturn ret;\r\n}\r\nret = (val & MAX77620_FPS_SRC_MASK) >> MAX77620_FPS_SRC_SHIFT;\r\npmic->active_fps_src[id] = ret;\r\nreturn 0;\r\ndefault:\r\ndev_err(pmic->dev, "Invalid FPS %d for regulator %d\n",\r\nfps_src, id);\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(pmic->rmap, rinfo->fps_addr,\r\nMAX77620_FPS_SRC_MASK,\r\nfps_src << MAX77620_FPS_SRC_SHIFT);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x update failed %d\n",\r\nrinfo->fps_addr, ret);\r\nreturn ret;\r\n}\r\npmic->active_fps_src[id] = fps_src;\r\nreturn 0;\r\n}\r\nstatic int max77620_regulator_set_fps_slots(struct max77620_regulator *pmic,\r\nint id, bool is_suspend)\r\n{\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int val = 0;\r\nunsigned int mask = 0;\r\nint pu = rpdata->active_fps_pu_slot;\r\nint pd = rpdata->active_fps_pd_slot;\r\nint ret = 0;\r\nif (!rinfo)\r\nreturn 0;\r\nif (is_suspend) {\r\npu = rpdata->suspend_fps_pu_slot;\r\npd = rpdata->suspend_fps_pd_slot;\r\n}\r\nif (pu >= 0) {\r\nval |= (pu << MAX77620_FPS_PU_PERIOD_SHIFT);\r\nmask |= MAX77620_FPS_PU_PERIOD_MASK;\r\n}\r\nif (pd >= 0) {\r\nval |= (pd << MAX77620_FPS_PD_PERIOD_SHIFT);\r\nmask |= MAX77620_FPS_PD_PERIOD_MASK;\r\n}\r\nif (mask) {\r\nret = regmap_update_bits(pmic->rmap, rinfo->fps_addr,\r\nmask, val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x update failed: %d\n",\r\nrinfo->fps_addr, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int max77620_regulator_set_power_mode(struct max77620_regulator *pmic,\r\nint power_mode, int id)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nu8 mask = rinfo->power_mode_mask;\r\nu8 shift = rinfo->power_mode_shift;\r\nu8 addr;\r\nint ret;\r\nswitch (rinfo->type) {\r\ncase MAX77620_REGULATOR_TYPE_SD:\r\naddr = rinfo->cfg_addr;\r\nbreak;\r\ndefault:\r\naddr = rinfo->volt_addr;\r\nbreak;\r\n}\r\nret = regmap_update_bits(pmic->rmap, addr, mask, power_mode << shift);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Regulator %d mode set failed: %d\n",\r\nid, ret);\r\nreturn ret;\r\n}\r\npmic->current_power_mode[id] = power_mode;\r\nreturn ret;\r\n}\r\nstatic int max77620_regulator_get_power_mode(struct max77620_regulator *pmic,\r\nint id)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int val, addr;\r\nu8 mask = rinfo->power_mode_mask;\r\nu8 shift = rinfo->power_mode_shift;\r\nint ret;\r\nswitch (rinfo->type) {\r\ncase MAX77620_REGULATOR_TYPE_SD:\r\naddr = rinfo->cfg_addr;\r\nbreak;\r\ndefault:\r\naddr = rinfo->volt_addr;\r\nbreak;\r\n}\r\nret = regmap_read(pmic->rmap, addr, &val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Regulator %d: Reg 0x%02x read failed: %d\n",\r\nid, addr, ret);\r\nreturn ret;\r\n}\r\nreturn (val & mask) >> shift;\r\n}\r\nstatic int max77620_read_slew_rate(struct max77620_regulator *pmic, int id)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int rval;\r\nint slew_rate;\r\nint ret;\r\nret = regmap_read(pmic->rmap, rinfo->cfg_addr, &rval);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Register 0x%02x read failed: %d\n",\r\nrinfo->cfg_addr, ret);\r\nreturn ret;\r\n}\r\nswitch (rinfo->type) {\r\ncase MAX77620_REGULATOR_TYPE_SD:\r\nslew_rate = (rval >> MAX77620_SD_SR_SHIFT) & 0x3;\r\nswitch (slew_rate) {\r\ncase 0:\r\nslew_rate = 13750;\r\nbreak;\r\ncase 1:\r\nslew_rate = 27500;\r\nbreak;\r\ncase 2:\r\nslew_rate = 55000;\r\nbreak;\r\ncase 3:\r\nslew_rate = 100000;\r\nbreak;\r\n}\r\nrinfo->desc.ramp_delay = slew_rate;\r\nbreak;\r\ndefault:\r\nslew_rate = rval & 0x1;\r\nswitch (slew_rate) {\r\ncase 0:\r\nslew_rate = 100000;\r\nbreak;\r\ncase 1:\r\nslew_rate = 5000;\r\nbreak;\r\n}\r\nrinfo->desc.ramp_delay = slew_rate;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_set_slew_rate(struct max77620_regulator *pmic, int id,\r\nint slew_rate)\r\n{\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nunsigned int val;\r\nint ret;\r\nu8 mask;\r\nif (rinfo->type == MAX77620_REGULATOR_TYPE_SD) {\r\nif (slew_rate <= 13750)\r\nval = 0;\r\nelse if (slew_rate <= 27500)\r\nval = 1;\r\nelse if (slew_rate <= 55000)\r\nval = 2;\r\nelse\r\nval = 3;\r\nval <<= MAX77620_SD_SR_SHIFT;\r\nmask = MAX77620_SD_SR_MASK;\r\n} else {\r\nif (slew_rate <= 5000)\r\nval = 1;\r\nelse\r\nval = 0;\r\nmask = MAX77620_LDO_SLEW_RATE_MASK;\r\n}\r\nret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr, mask, val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Regulator %d slew rate set failed: %d\n",\r\nid, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_config_power_ok(struct max77620_regulator *pmic, int id)\r\n{\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nstruct max77620_chip *chip = dev_get_drvdata(pmic->dev->parent);\r\nu8 val, mask;\r\nint ret;\r\nswitch (chip->chip_id) {\r\ncase MAX20024:\r\nif (rpdata->power_ok >= 0) {\r\nif (rinfo->type == MAX77620_REGULATOR_TYPE_SD)\r\nmask = MAX20024_SD_CFG1_MPOK_MASK;\r\nelse\r\nmask = MAX20024_LDO_CFG2_MPOK_MASK;\r\nval = rpdata->power_ok ? mask : 0;\r\nret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr,\r\nmask, val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x update failed %d\n",\r\nrinfo->cfg_addr, ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_init_pmic(struct max77620_regulator *pmic, int id)\r\n{\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\r\nint ret;\r\nmax77620_config_power_ok(pmic, id);\r\nret = max77620_regulator_get_power_mode(pmic, id);\r\nif (ret < 0)\r\nreturn ret;\r\npmic->current_power_mode[id] = ret;\r\npmic->enable_power_mode[id] = MAX77620_POWER_MODE_NORMAL;\r\nif (rpdata->active_fps_src == MAX77620_FPS_SRC_DEF) {\r\nret = max77620_regulator_get_fps_src(pmic, id);\r\nif (ret < 0)\r\nreturn ret;\r\nrpdata->active_fps_src = ret;\r\n}\r\nif (rpdata->active_fps_src == MAX77620_FPS_SRC_NONE) {\r\nret = max77620_regulator_set_power_mode(pmic,\r\npmic->enable_power_mode[id], id);\r\nif (ret < 0)\r\nreturn ret;\r\n} else {\r\nif (pmic->current_power_mode[id] !=\r\npmic->enable_power_mode[id]) {\r\nret = max77620_regulator_set_power_mode(pmic,\r\npmic->enable_power_mode[id], id);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nret = max77620_regulator_set_fps_src(pmic, rpdata->active_fps_src, id);\r\nif (ret < 0)\r\nreturn ret;\r\nret = max77620_regulator_set_fps_slots(pmic, id, false);\r\nif (ret < 0)\r\nreturn ret;\r\nif (rpdata->ramp_rate_setting) {\r\nret = max77620_set_slew_rate(pmic, id,\r\nrpdata->ramp_rate_setting);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\r\nreturn 0;\r\nreturn max77620_regulator_set_power_mode(pmic,\r\npmic->enable_power_mode[id], id);\r\n}\r\nstatic int max77620_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\r\nreturn 0;\r\nreturn max77620_regulator_set_power_mode(pmic,\r\nMAX77620_POWER_MODE_DISABLE, id);\r\n}\r\nstatic int max77620_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nint ret = 1;\r\nif (pmic->active_fps_src[id] != MAX77620_FPS_SRC_NONE)\r\nreturn 1;\r\nret = max77620_regulator_get_power_mode(pmic, id);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != MAX77620_POWER_MODE_DISABLE)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int max77620_regulator_set_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\r\nbool fpwm = false;\r\nint power_mode;\r\nint ret;\r\nu8 val;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\nfpwm = true;\r\npower_mode = MAX77620_POWER_MODE_NORMAL;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\npower_mode = MAX77620_POWER_MODE_NORMAL;\r\nbreak;\r\ncase REGULATOR_MODE_IDLE:\r\npower_mode = MAX77620_POWER_MODE_LPM;\r\nbreak;\r\ndefault:\r\ndev_err(pmic->dev, "Regulator %d mode %d is invalid\n",\r\nid, mode);\r\nreturn -EINVAL;\r\n}\r\nif (rinfo->type != MAX77620_REGULATOR_TYPE_SD)\r\ngoto skip_fpwm;\r\nval = (fpwm) ? MAX77620_SD_FPWM_MASK : 0;\r\nret = regmap_update_bits(pmic->rmap, rinfo->cfg_addr,\r\nMAX77620_SD_FPWM_MASK, val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x update failed: %d\n",\r\nrinfo->cfg_addr, ret);\r\nreturn ret;\r\n}\r\nrpdata->current_mode = mode;\r\nskip_fpwm:\r\nret = max77620_regulator_set_power_mode(pmic, power_mode, id);\r\nif (ret < 0)\r\nreturn ret;\r\npmic->enable_power_mode[id] = power_mode;\r\nreturn 0;\r\n}\r\nstatic unsigned int max77620_regulator_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nstruct max77620_regulator_info *rinfo = pmic->rinfo[id];\r\nint fpwm = 0;\r\nint ret;\r\nint pm_mode, reg_mode;\r\nunsigned int val;\r\nret = max77620_regulator_get_power_mode(pmic, id);\r\nif (ret < 0)\r\nreturn 0;\r\npm_mode = ret;\r\nif (rinfo->type == MAX77620_REGULATOR_TYPE_SD) {\r\nret = regmap_read(pmic->rmap, rinfo->cfg_addr, &val);\r\nif (ret < 0) {\r\ndev_err(pmic->dev, "Reg 0x%02x read failed: %d\n",\r\nrinfo->cfg_addr, ret);\r\nreturn ret;\r\n}\r\nfpwm = !!(val & MAX77620_SD_FPWM_MASK);\r\n}\r\nswitch (pm_mode) {\r\ncase MAX77620_POWER_MODE_NORMAL:\r\ncase MAX77620_POWER_MODE_DISABLE:\r\nif (fpwm)\r\nreg_mode = REGULATOR_MODE_FAST;\r\nelse\r\nreg_mode = REGULATOR_MODE_NORMAL;\r\nbreak;\r\ncase MAX77620_POWER_MODE_LPM:\r\ncase MAX77620_POWER_MODE_GLPM:\r\nreg_mode = REGULATOR_MODE_IDLE;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn reg_mode;\r\n}\r\nstatic int max77620_regulator_set_ramp_delay(struct regulator_dev *rdev,\r\nint ramp_delay)\r\n{\r\nstruct max77620_regulator *pmic = rdev_get_drvdata(rdev);\r\nint id = rdev_get_id(rdev);\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[id];\r\nif (rpdata->ramp_rate_setting)\r\nreturn 0;\r\nreturn max77620_set_slew_rate(pmic, id, ramp_delay);\r\n}\r\nstatic int max77620_of_parse_cb(struct device_node *np,\r\nconst struct regulator_desc *desc,\r\nstruct regulator_config *config)\r\n{\r\nstruct max77620_regulator *pmic = config->driver_data;\r\nstruct max77620_regulator_pdata *rpdata = &pmic->reg_pdata[desc->id];\r\nu32 pval;\r\nint ret;\r\nret = of_property_read_u32(np, "maxim,active-fps-source", &pval);\r\nrpdata->active_fps_src = (!ret) ? pval : MAX77620_FPS_SRC_DEF;\r\nret = of_property_read_u32(np, "maxim,active-fps-power-up-slot", &pval);\r\nrpdata->active_fps_pu_slot = (!ret) ? pval : -1;\r\nret = of_property_read_u32(\r\nnp, "maxim,active-fps-power-down-slot", &pval);\r\nrpdata->active_fps_pd_slot = (!ret) ? pval : -1;\r\nret = of_property_read_u32(np, "maxim,suspend-fps-source", &pval);\r\nrpdata->suspend_fps_src = (!ret) ? pval : -1;\r\nret = of_property_read_u32(\r\nnp, "maxim,suspend-fps-power-up-slot", &pval);\r\nrpdata->suspend_fps_pu_slot = (!ret) ? pval : -1;\r\nret = of_property_read_u32(\r\nnp, "maxim,suspend-fps-power-down-slot", &pval);\r\nrpdata->suspend_fps_pd_slot = (!ret) ? pval : -1;\r\nret = of_property_read_u32(np, "maxim,power-ok-control", &pval);\r\nif (!ret)\r\nrpdata->power_ok = pval;\r\nelse\r\nrpdata->power_ok = -1;\r\nret = of_property_read_u32(np, "maxim,ramp-rate-setting", &pval);\r\nrpdata->ramp_rate_setting = (!ret) ? pval : 0;\r\nreturn max77620_init_pmic(pmic, desc->id);\r\n}\r\nstatic int max77620_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct max77620_chip *max77620_chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77620_regulator_info *rinfo;\r\nstruct device *dev = &pdev->dev;\r\nstruct regulator_config config = { };\r\nstruct max77620_regulator *pmic;\r\nint ret = 0;\r\nint id;\r\npmic = devm_kzalloc(dev, sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, pmic);\r\npmic->dev = dev;\r\npmic->rmap = max77620_chip->rmap;\r\nif (!dev->of_node)\r\ndev->of_node = pdev->dev.parent->of_node;\r\nswitch (max77620_chip->chip_id) {\r\ncase MAX77620:\r\nrinfo = max77620_regs_info;\r\nbreak;\r\ndefault:\r\nrinfo = max20024_regs_info;\r\nbreak;\r\n}\r\nconfig.regmap = pmic->rmap;\r\nconfig.dev = dev;\r\nconfig.driver_data = pmic;\r\nfor (id = 0; id < MAX77620_NUM_REGS; id++) {\r\nstruct regulator_dev *rdev;\r\nstruct regulator_desc *rdesc;\r\nif ((max77620_chip->chip_id == MAX77620) &&\r\n(id == MAX77620_REGULATOR_ID_SD4))\r\ncontinue;\r\nrdesc = &rinfo[id].desc;\r\npmic->rinfo[id] = &max77620_regs_info[id];\r\npmic->enable_power_mode[id] = MAX77620_POWER_MODE_NORMAL;\r\nret = max77620_read_slew_rate(pmic, id);\r\nif (ret < 0)\r\nreturn ret;\r\nrdev = devm_regulator_register(dev, rdesc, &config);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(dev, "Regulator registration %s failed: %d\n",\r\nrdesc->name, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_regulator_suspend(struct device *dev)\r\n{\r\nstruct max77620_regulator *pmic = dev_get_drvdata(dev);\r\nstruct max77620_regulator_pdata *reg_pdata;\r\nint id;\r\nfor (id = 0; id < MAX77620_NUM_REGS; id++) {\r\nreg_pdata = &pmic->reg_pdata[id];\r\nmax77620_regulator_set_fps_slots(pmic, id, true);\r\nif (reg_pdata->suspend_fps_src < 0)\r\ncontinue;\r\nmax77620_regulator_set_fps_src(pmic, reg_pdata->suspend_fps_src,\r\nid);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_regulator_resume(struct device *dev)\r\n{\r\nstruct max77620_regulator *pmic = dev_get_drvdata(dev);\r\nstruct max77620_regulator_pdata *reg_pdata;\r\nint id;\r\nfor (id = 0; id < MAX77620_NUM_REGS; id++) {\r\nreg_pdata = &pmic->reg_pdata[id];\r\nmax77620_config_power_ok(pmic, id);\r\nmax77620_regulator_set_fps_slots(pmic, id, false);\r\nif (reg_pdata->active_fps_src < 0)\r\ncontinue;\r\nmax77620_regulator_set_fps_src(pmic, reg_pdata->active_fps_src,\r\nid);\r\n}\r\nreturn 0;\r\n}

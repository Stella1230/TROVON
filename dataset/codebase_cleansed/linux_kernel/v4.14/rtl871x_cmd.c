static sint _init_cmd_priv(struct cmd_priv *pcmdpriv)\r\n{\r\ninit_completion(&pcmdpriv->cmd_queue_comp);\r\ninit_completion(&pcmdpriv->terminate_cmdthread_comp);\r\n_init_queue(&(pcmdpriv->cmd_queue));\r\npcmdpriv->cmd_seq = 1;\r\npcmdpriv->cmd_allocated_buf = kmalloc(MAX_CMDSZ + CMDBUFF_ALIGN_SZ,\r\nGFP_ATOMIC);\r\nif (!pcmdpriv->cmd_allocated_buf)\r\nreturn _FAIL;\r\npcmdpriv->cmd_buf = pcmdpriv->cmd_allocated_buf + CMDBUFF_ALIGN_SZ -\r\n((addr_t)(pcmdpriv->cmd_allocated_buf) &\r\n(CMDBUFF_ALIGN_SZ - 1));\r\npcmdpriv->rsp_allocated_buf = kmalloc(MAX_RSPSZ + 4, GFP_ATOMIC);\r\nif (!pcmdpriv->rsp_allocated_buf) {\r\nkfree(pcmdpriv->cmd_allocated_buf);\r\npcmdpriv->cmd_allocated_buf = NULL;\r\nreturn _FAIL;\r\n}\r\npcmdpriv->rsp_buf = pcmdpriv->rsp_allocated_buf + 4 -\r\n((addr_t)(pcmdpriv->rsp_allocated_buf) & 3);\r\npcmdpriv->cmd_issued_cnt = 0;\r\npcmdpriv->cmd_done_cnt = 0;\r\npcmdpriv->rsp_cnt = 0;\r\nreturn _SUCCESS;\r\n}\r\nstatic sint _init_evt_priv(struct evt_priv *pevtpriv)\r\n{\r\npevtpriv->event_seq = 0;\r\npevtpriv->evt_allocated_buf = kmalloc(MAX_EVTSZ + 4, GFP_ATOMIC);\r\nif (!pevtpriv->evt_allocated_buf)\r\nreturn _FAIL;\r\npevtpriv->evt_buf = pevtpriv->evt_allocated_buf + 4 -\r\n((addr_t)(pevtpriv->evt_allocated_buf) & 3);\r\npevtpriv->evt_done_cnt = 0;\r\nreturn _SUCCESS;\r\n}\r\nstatic void _free_evt_priv(struct evt_priv *pevtpriv)\r\n{\r\nkfree(pevtpriv->evt_allocated_buf);\r\n}\r\nstatic void _free_cmd_priv(struct cmd_priv *pcmdpriv)\r\n{\r\nif (pcmdpriv) {\r\nkfree(pcmdpriv->cmd_allocated_buf);\r\nkfree(pcmdpriv->rsp_allocated_buf);\r\n}\r\n}\r\nstatic sint _enqueue_cmd(struct __queue *queue, struct cmd_obj *obj)\r\n{\r\nunsigned long irqL;\r\nif (!obj)\r\nreturn _SUCCESS;\r\nspin_lock_irqsave(&queue->lock, irqL);\r\nlist_add_tail(&obj->list, &queue->queue);\r\nspin_unlock_irqrestore(&queue->lock, irqL);\r\nreturn _SUCCESS;\r\n}\r\nstatic struct cmd_obj *_dequeue_cmd(struct __queue *queue)\r\n{\r\nunsigned long irqL;\r\nstruct cmd_obj *obj;\r\nspin_lock_irqsave(&queue->lock, irqL);\r\nobj = list_first_entry_or_null(&queue->queue,\r\nstruct cmd_obj, list);\r\nif (obj)\r\nlist_del_init(&obj->list);\r\nspin_unlock_irqrestore(&queue->lock, irqL);\r\nreturn obj;\r\n}\r\nu32 r8712_init_cmd_priv(struct cmd_priv *pcmdpriv)\r\n{\r\nreturn _init_cmd_priv(pcmdpriv);\r\n}\r\nu32 r8712_init_evt_priv(struct evt_priv *pevtpriv)\r\n{\r\nreturn _init_evt_priv(pevtpriv);\r\n}\r\nvoid r8712_free_evt_priv(struct evt_priv *pevtpriv)\r\n{\r\n_free_evt_priv(pevtpriv);\r\n}\r\nvoid r8712_free_cmd_priv(struct cmd_priv *pcmdpriv)\r\n{\r\n_free_cmd_priv(pcmdpriv);\r\n}\r\nu32 r8712_enqueue_cmd(struct cmd_priv *pcmdpriv, struct cmd_obj *obj)\r\n{\r\nint res;\r\nif (pcmdpriv->padapter->eeprompriv.bautoload_fail_flag)\r\nreturn _FAIL;\r\nres = _enqueue_cmd(&pcmdpriv->cmd_queue, obj);\r\ncomplete(&pcmdpriv->cmd_queue_comp);\r\nreturn res;\r\n}\r\nu32 r8712_enqueue_cmd_ex(struct cmd_priv *pcmdpriv, struct cmd_obj *obj)\r\n{\r\nunsigned long irqL;\r\nstruct __queue *queue;\r\nif (!obj)\r\nreturn _SUCCESS;\r\nif (pcmdpriv->padapter->eeprompriv.bautoload_fail_flag)\r\nreturn _FAIL;\r\nqueue = &pcmdpriv->cmd_queue;\r\nspin_lock_irqsave(&queue->lock, irqL);\r\nlist_add_tail(&obj->list, &queue->queue);\r\nspin_unlock_irqrestore(&queue->lock, irqL);\r\ncomplete(&pcmdpriv->cmd_queue_comp);\r\nreturn _SUCCESS;\r\n}\r\nstruct cmd_obj *r8712_dequeue_cmd(struct __queue *queue)\r\n{\r\nreturn _dequeue_cmd(queue);\r\n}\r\nvoid r8712_free_cmd_obj(struct cmd_obj *pcmd)\r\n{\r\nif ((pcmd->cmdcode != _JoinBss_CMD_) &&\r\n(pcmd->cmdcode != _CreateBss_CMD_))\r\nkfree(pcmd->parmbuf);\r\nif (pcmd->rsp != NULL) {\r\nif (pcmd->rspsz != 0)\r\nkfree(pcmd->rsp);\r\n}\r\nkfree(pcmd);\r\n}\r\nu8 r8712_sitesurvey_cmd(struct _adapter *padapter,\r\nstruct ndis_802_11_ssid *pssid)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct sitesurvey_parm *psurveyPara;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsurveyPara = kmalloc(sizeof(*psurveyPara), GFP_ATOMIC);\r\nif (!psurveyPara) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psurveyPara,\r\nGEN_CMD_CODE(_SiteSurvey));\r\npsurveyPara->bsslimit = cpu_to_le32(48);\r\npsurveyPara->passive_mode = cpu_to_le32(pmlmepriv->passive_mode);\r\npsurveyPara->ss_ssidlen = 0;\r\nmemset(psurveyPara->ss_ssid, 0, IW_ESSID_MAX_SIZE + 1);\r\nif ((pssid != NULL) && (pssid->SsidLength)) {\r\nmemcpy(psurveyPara->ss_ssid, pssid->Ssid, pssid->SsidLength);\r\npsurveyPara->ss_ssidlen = cpu_to_le32(pssid->SsidLength);\r\n}\r\nset_fwstate(pmlmepriv, _FW_UNDER_SURVEY);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nmod_timer(&pmlmepriv->scan_to_timer,\r\njiffies + msecs_to_jiffies(SCANNING_TIMEOUT));\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_SITE_SURVEY);\r\npadapter->blnEnableRxFF0Filter = 0;\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setdatarate_cmd(struct _adapter *padapter, u8 *rateset)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct setdatarate_parm *pbsetdataratepara;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npbsetdataratepara = kmalloc(sizeof(*pbsetdataratepara), GFP_ATOMIC);\r\nif (!pbsetdataratepara) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pbsetdataratepara,\r\nGEN_CMD_CODE(_SetDataRate));\r\npbsetdataratepara->mac_id = 5;\r\nmemcpy(pbsetdataratepara->datarates, rateset, NumRates);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_set_chplan_cmd(struct _adapter *padapter, int chplan)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct SetChannelPlan_param *psetchplanpara;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetchplanpara = kmalloc(sizeof(*psetchplanpara), GFP_ATOMIC);\r\nif (!psetchplanpara) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetchplanpara,\r\nGEN_CMD_CODE(_SetChannelPlan));\r\npsetchplanpara->ChannelPlan = chplan;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setbasicrate_cmd(struct _adapter *padapter, u8 *rateset)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct setbasicrate_parm *pssetbasicratepara;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npssetbasicratepara = kmalloc(sizeof(*pssetbasicratepara), GFP_ATOMIC);\r\nif (!pssetbasicratepara) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pssetbasicratepara,\r\n_SetBasicRate_CMD_);\r\nmemcpy(pssetbasicratepara->basicrates, rateset, NumRates);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setfwdig_cmd(struct _adapter *padapter, u8 type)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct writePTM_parm *pwriteptmparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npwriteptmparm = kmalloc(sizeof(*pwriteptmparm), GFP_ATOMIC);\r\nif (!pwriteptmparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pwriteptmparm, GEN_CMD_CODE(_SetDIG));\r\npwriteptmparm->type = type;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setfwra_cmd(struct _adapter *padapter, u8 type)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct writePTM_parm *pwriteptmparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npwriteptmparm = kmalloc(sizeof(*pwriteptmparm), GFP_ATOMIC);\r\nif (!pwriteptmparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pwriteptmparm, GEN_CMD_CODE(_SetRA));\r\npwriteptmparm->type = type;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setrfreg_cmd(struct _adapter *padapter, u8 offset, u32 val)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct writeRF_parm *pwriterfparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npwriterfparm = kmalloc(sizeof(*pwriterfparm), GFP_ATOMIC);\r\nif (!pwriterfparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pwriterfparm, GEN_CMD_CODE(_SetRFReg));\r\npwriterfparm->offset = offset;\r\npwriterfparm->value = val;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_getrfreg_cmd(struct _adapter *padapter, u8 offset, u8 *pval)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct readRF_parm *prdrfparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\nprdrfparm = kmalloc(sizeof(*prdrfparm), GFP_ATOMIC);\r\nif (!prdrfparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\nINIT_LIST_HEAD(&ph2c->list);\r\nph2c->cmdcode = GEN_CMD_CODE(_GetRFReg);\r\nph2c->parmbuf = (unsigned char *)prdrfparm;\r\nph2c->cmdsz = sizeof(struct readRF_parm);\r\nph2c->rsp = pval;\r\nph2c->rspsz = sizeof(struct readRF_rsp);\r\nprdrfparm->offset = offset;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nvoid r8712_getbbrfreg_cmdrsp_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nkfree(pcmd->parmbuf);\r\nkfree(pcmd);\r\npadapter->mppriv.workparam.bcompleted = true;\r\n}\r\nvoid r8712_readtssi_cmdrsp_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nkfree(pcmd->parmbuf);\r\nkfree(pcmd);\r\npadapter->mppriv.workparam.bcompleted = true;\r\n}\r\nu8 r8712_createbss_cmd(struct _adapter *padapter)\r\n{\r\nstruct cmd_obj *pcmd;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct wlan_bssid_ex *pdev_network =\r\n&padapter->registrypriv.dev_network;\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_START_TO_LINK);\r\npcmd = kmalloc(sizeof(*pcmd), GFP_ATOMIC);\r\nif (!pcmd)\r\nreturn _FAIL;\r\nINIT_LIST_HEAD(&pcmd->list);\r\npcmd->cmdcode = _CreateBss_CMD_;\r\npcmd->parmbuf = (unsigned char *)pdev_network;\r\npcmd->cmdsz = r8712_get_wlan_bssid_ex_sz(pdev_network);\r\npcmd->rsp = NULL;\r\npcmd->rspsz = 0;\r\npdev_network->Length = pcmd->cmdsz;\r\npdev_network->IELength = pdev_network->IELength;\r\npdev_network->Ssid.SsidLength = pdev_network->Ssid.SsidLength;\r\nr8712_enqueue_cmd(pcmdpriv, pcmd);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_joinbss_cmd(struct _adapter *padapter, struct wlan_network *pnetwork)\r\n{\r\nstruct wlan_bssid_ex *psecnetwork;\r\nstruct cmd_obj *pcmd;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct qos_priv *pqospriv = &pmlmepriv->qospriv;\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\nstruct registry_priv *pregistrypriv = &padapter->registrypriv;\r\nenum NDIS_802_11_NETWORK_INFRASTRUCTURE ndis_network_mode = pnetwork->\r\nnetwork.InfrastructureMode;\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_START_TO_LINK);\r\npcmd = kmalloc(sizeof(*pcmd), GFP_ATOMIC);\r\nif (!pcmd)\r\nreturn _FAIL;\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE | WIFI_ADHOC_STATE) !=\r\ntrue) {\r\nswitch (ndis_network_mode) {\r\ncase Ndis802_11IBSS:\r\npmlmepriv->fw_state |= WIFI_ADHOC_STATE;\r\nbreak;\r\ncase Ndis802_11Infrastructure:\r\npmlmepriv->fw_state |= WIFI_STATION_STATE;\r\nbreak;\r\ncase Ndis802_11APMode:\r\ncase Ndis802_11AutoUnknown:\r\ncase Ndis802_11InfrastructureMax:\r\nbreak;\r\n}\r\n}\r\npsecnetwork = &psecuritypriv->sec_bss;\r\nif (!psecnetwork) {\r\nkfree(pcmd);\r\nreturn _FAIL;\r\n}\r\nmemcpy(psecnetwork, &pnetwork->network, sizeof(*psecnetwork));\r\npsecuritypriv->authenticator_ie[0] = (unsigned char)\r\npsecnetwork->IELength;\r\nif ((psecnetwork->IELength - 12) < (256 - 1))\r\nmemcpy(&psecuritypriv->authenticator_ie[1],\r\n&psecnetwork->IEs[12], psecnetwork->IELength - 12);\r\nelse\r\nmemcpy(&psecuritypriv->authenticator_ie[1],\r\n&psecnetwork->IEs[12], (256 - 1));\r\npsecnetwork->IELength = 0;\r\nif (!pmlmepriv->assoc_by_bssid)\r\nether_addr_copy(&pmlmepriv->assoc_bssid[0],\r\n&pnetwork->network.MacAddress[0]);\r\npsecnetwork->IELength = r8712_restruct_sec_ie(padapter,\r\n&pnetwork->network.IEs[0],\r\n&psecnetwork->IEs[0],\r\npnetwork->network.IELength);\r\npqospriv->qos_option = 0;\r\nif (pregistrypriv->wmm_enable) {\r\nu32 tmp_len;\r\ntmp_len = r8712_restruct_wmm_ie(padapter,\r\n&pnetwork->network.IEs[0],\r\n&psecnetwork->IEs[0],\r\npnetwork->network.IELength,\r\npsecnetwork->IELength);\r\nif (psecnetwork->IELength != tmp_len) {\r\npsecnetwork->IELength = tmp_len;\r\npqospriv->qos_option = 1;\r\n} else {\r\npqospriv->qos_option = 0;\r\n}\r\n}\r\nif (pregistrypriv->ht_enable) {\r\nif ((padapter->securitypriv.PrivacyAlgrthm != _WEP40_) &&\r\n(padapter->securitypriv.PrivacyAlgrthm != _WEP104_)) {\r\nr8712_restructure_ht_ie(padapter,\r\n&pnetwork->network.IEs[0],\r\n&psecnetwork->IEs[0],\r\npnetwork->network.IELength,\r\n&psecnetwork->IELength);\r\n}\r\n}\r\npsecuritypriv->supplicant_ie[0] = (u8)psecnetwork->IELength;\r\nif (psecnetwork->IELength < 255)\r\nmemcpy(&psecuritypriv->supplicant_ie[1], &psecnetwork->IEs[0],\r\npsecnetwork->IELength);\r\nelse\r\nmemcpy(&psecuritypriv->supplicant_ie[1], &psecnetwork->IEs[0],\r\n255);\r\npcmd->cmdsz = r8712_get_wlan_bssid_ex_sz(psecnetwork);\r\n#ifdef __BIG_ENDIAN\r\npsecnetwork->Length = cpu_to_le32(psecnetwork->Length);\r\npsecnetwork->Ssid.SsidLength = cpu_to_le32(\r\npsecnetwork->Ssid.SsidLength);\r\npsecnetwork->Privacy = cpu_to_le32(psecnetwork->Privacy);\r\npsecnetwork->Rssi = cpu_to_le32(psecnetwork->Rssi);\r\npsecnetwork->NetworkTypeInUse = cpu_to_le32(\r\npsecnetwork->NetworkTypeInUse);\r\npsecnetwork->Configuration.ATIMWindow = cpu_to_le32(\r\npsecnetwork->Configuration.ATIMWindow);\r\npsecnetwork->Configuration.BeaconPeriod = cpu_to_le32(\r\npsecnetwork->Configuration.BeaconPeriod);\r\npsecnetwork->Configuration.DSConfig = cpu_to_le32(\r\npsecnetwork->Configuration.DSConfig);\r\npsecnetwork->Configuration.FHConfig.DwellTime = cpu_to_le32(\r\npsecnetwork->Configuration.FHConfig.DwellTime);\r\npsecnetwork->Configuration.FHConfig.HopPattern = cpu_to_le32(\r\npsecnetwork->Configuration.FHConfig.HopPattern);\r\npsecnetwork->Configuration.FHConfig.HopSet = cpu_to_le32(\r\npsecnetwork->Configuration.FHConfig.HopSet);\r\npsecnetwork->Configuration.FHConfig.Length = cpu_to_le32(\r\npsecnetwork->Configuration.FHConfig.Length);\r\npsecnetwork->Configuration.Length = cpu_to_le32(\r\npsecnetwork->Configuration.Length);\r\npsecnetwork->InfrastructureMode = cpu_to_le32(\r\npsecnetwork->InfrastructureMode);\r\npsecnetwork->IELength = cpu_to_le32(psecnetwork->IELength);\r\n#endif\r\nINIT_LIST_HEAD(&pcmd->list);\r\npcmd->cmdcode = _JoinBss_CMD_;\r\npcmd->parmbuf = (unsigned char *)psecnetwork;\r\npcmd->rsp = NULL;\r\npcmd->rspsz = 0;\r\nr8712_enqueue_cmd(pcmdpriv, pcmd);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_disassoc_cmd(struct _adapter *padapter)\r\n{\r\nstruct cmd_obj *pdisconnect_cmd;\r\nstruct disconnect_parm *pdisconnect;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\npdisconnect_cmd = kmalloc(sizeof(*pdisconnect_cmd), GFP_ATOMIC);\r\nif (!pdisconnect_cmd)\r\nreturn _FAIL;\r\npdisconnect = kmalloc(sizeof(*pdisconnect), GFP_ATOMIC);\r\nif (!pdisconnect) {\r\nkfree(pdisconnect_cmd);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(pdisconnect_cmd, pdisconnect,\r\n_DisConnect_CMD_);\r\nr8712_enqueue_cmd(pcmdpriv, pdisconnect_cmd);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setopmode_cmd(struct _adapter *padapter,\r\nenum NDIS_802_11_NETWORK_INFRASTRUCTURE networktype)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct setopmode_parm *psetop;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetop = kmalloc(sizeof(*psetop), GFP_ATOMIC);\r\nif (!psetop) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetop, _SetOpMode_CMD_);\r\npsetop->mode = (u8)networktype;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setstakey_cmd(struct _adapter *padapter, u8 *psta, u8 unicast_key)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct set_stakey_parm *psetstakey_para;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct set_stakey_rsp *psetstakey_rsp = NULL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\nstruct sta_info *sta = (struct sta_info *)psta;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetstakey_para = kmalloc(sizeof(*psetstakey_para), GFP_ATOMIC);\r\nif (!psetstakey_para) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\npsetstakey_rsp = kmalloc(sizeof(*psetstakey_rsp), GFP_ATOMIC);\r\nif (!psetstakey_rsp) {\r\nkfree(ph2c);\r\nkfree(psetstakey_para);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetstakey_para, _SetStaKey_CMD_);\r\nph2c->rsp = (u8 *) psetstakey_rsp;\r\nph2c->rspsz = sizeof(struct set_stakey_rsp);\r\nether_addr_copy(psetstakey_para->addr, sta->hwaddr);\r\nif (check_fwstate(pmlmepriv, WIFI_STATION_STATE))\r\npsetstakey_para->algorithm = (unsigned char)\r\npsecuritypriv->PrivacyAlgrthm;\r\nelse\r\nGET_ENCRY_ALGO(psecuritypriv, sta,\r\npsetstakey_para->algorithm, false);\r\nif (unicast_key)\r\nmemcpy(&psetstakey_para->key, &sta->x_UncstKey, 16);\r\nelse\r\nmemcpy(&psetstakey_para->key,\r\n&psecuritypriv->XGrpKey[\r\npsecuritypriv->XGrpKeyid - 1]. skey, 16);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setrfintfs_cmd(struct _adapter *padapter, u8 mode)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct setrfintfs_parm *psetrfintfsparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetrfintfsparm = kmalloc(sizeof(*psetrfintfsparm), GFP_ATOMIC);\r\nif (!psetrfintfsparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetrfintfsparm,\r\nGEN_CMD_CODE(_SetRFIntFs));\r\npsetrfintfsparm->rfintfs = mode;\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setrttbl_cmd(struct _adapter *padapter,\r\nstruct setratable_parm *prate_table)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct setratable_parm *psetrttblparm;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetrttblparm = kmalloc(sizeof(*psetrttblparm), GFP_ATOMIC);\r\nif (!psetrttblparm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetrttblparm,\r\nGEN_CMD_CODE(_SetRaTable));\r\nmemcpy(psetrttblparm, prate_table, sizeof(struct setratable_parm));\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setMacAddr_cmd(struct _adapter *padapter, u8 *mac_addr)\r\n{\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct cmd_obj *ph2c;\r\nstruct SetMacAddr_param *psetMacAddr_para;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetMacAddr_para = kmalloc(sizeof(*psetMacAddr_para), GFP_ATOMIC);\r\nif (!psetMacAddr_para) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetMacAddr_para,\r\n_SetMacAddress_CMD_);\r\nether_addr_copy(psetMacAddr_para->MacAddr, mac_addr);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_setassocsta_cmd(struct _adapter *padapter, u8 *mac_addr)\r\n{\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct cmd_obj *ph2c;\r\nstruct set_assocsta_parm *psetassocsta_para;\r\nstruct set_assocsta_rsp *psetassocsta_rsp = NULL;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npsetassocsta_para = kmalloc(sizeof(*psetassocsta_para), GFP_ATOMIC);\r\nif (!psetassocsta_para) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\npsetassocsta_rsp = kmalloc(sizeof(*psetassocsta_rsp), GFP_ATOMIC);\r\nif (!psetassocsta_rsp) {\r\nkfree(ph2c);\r\nkfree(psetassocsta_para);\r\nreturn _FAIL;\r\n}\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, psetassocsta_para, _SetAssocSta_CMD_);\r\nph2c->rsp = (u8 *) psetassocsta_rsp;\r\nph2c->rspsz = sizeof(struct set_assocsta_rsp);\r\nether_addr_copy(psetassocsta_para->addr, mac_addr);\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_addbareq_cmd(struct _adapter *padapter, u8 tid)\r\n{\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nstruct cmd_obj *ph2c;\r\nstruct addBaReq_parm *paddbareq_parm;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npaddbareq_parm = kmalloc(sizeof(*paddbareq_parm), GFP_ATOMIC);\r\nif (!paddbareq_parm) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\npaddbareq_parm->tid = tid;\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, paddbareq_parm,\r\nGEN_CMD_CODE(_AddBAReq));\r\nr8712_enqueue_cmd_ex(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_wdg_wk_cmd(struct _adapter *padapter)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct drvint_cmd_parm *pdrvintcmd_param;\r\nstruct cmd_priv *pcmdpriv = &padapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\npdrvintcmd_param = kmalloc(sizeof(*pdrvintcmd_param), GFP_ATOMIC);\r\nif (!pdrvintcmd_param) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\npdrvintcmd_param->i_cid = WDG_WK_CID;\r\npdrvintcmd_param->sz = 0;\r\npdrvintcmd_param->pbuf = NULL;\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, pdrvintcmd_param, _DRV_INT_CMD_);\r\nr8712_enqueue_cmd_ex(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}\r\nvoid r8712_survey_cmd_callback(struct _adapter *padapter, struct cmd_obj *pcmd)\r\n{\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nif (pcmd->res != H2C_SUCCESS)\r\nclr_fwstate(pmlmepriv, _FW_UNDER_SURVEY);\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nvoid r8712_disassoc_cmd_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nunsigned long irqL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nif (pcmd->res != H2C_SUCCESS) {\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nset_fwstate(pmlmepriv, _FW_LINKED);\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nreturn;\r\n}\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nvoid r8712_joinbss_cmd_callback(struct _adapter *padapter, struct cmd_obj *pcmd)\r\n{\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nif (pcmd->res != H2C_SUCCESS)\r\nmod_timer(&pmlmepriv->assoc_timer,\r\njiffies + msecs_to_jiffies(1));\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nvoid r8712_createbss_cmd_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nunsigned long irqL;\r\nstruct sta_info *psta = NULL;\r\nstruct wlan_network *pwlan = NULL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct wlan_bssid_ex *pnetwork = (struct wlan_bssid_ex *)pcmd->parmbuf;\r\nstruct wlan_network *tgt_network = &(pmlmepriv->cur_network);\r\nif (pcmd->res != H2C_SUCCESS)\r\nmod_timer(&pmlmepriv->assoc_timer,\r\njiffies + msecs_to_jiffies(1));\r\ndel_timer(&pmlmepriv->assoc_timer);\r\n#ifdef __BIG_ENDIAN\r\npnetwork->Length = le32_to_cpu(pnetwork->Length);\r\npnetwork->Ssid.SsidLength = le32_to_cpu(pnetwork->Ssid.SsidLength);\r\npnetwork->Privacy = le32_to_cpu(pnetwork->Privacy);\r\npnetwork->Rssi = le32_to_cpu(pnetwork->Rssi);\r\npnetwork->NetworkTypeInUse = le32_to_cpu(pnetwork->NetworkTypeInUse);\r\npnetwork->Configuration.ATIMWindow = le32_to_cpu(pnetwork->\r\nConfiguration.ATIMWindow);\r\npnetwork->Configuration.DSConfig = le32_to_cpu(pnetwork->\r\nConfiguration.DSConfig);\r\npnetwork->Configuration.FHConfig.DwellTime = le32_to_cpu(pnetwork->\r\nConfiguration.FHConfig.DwellTime);\r\npnetwork->Configuration.FHConfig.HopPattern = le32_to_cpu(pnetwork->\r\nConfiguration.FHConfig.HopPattern);\r\npnetwork->Configuration.FHConfig.HopSet = le32_to_cpu(pnetwork->\r\nConfiguration.FHConfig.HopSet);\r\npnetwork->Configuration.FHConfig.Length = le32_to_cpu(pnetwork->\r\nConfiguration.FHConfig.Length);\r\npnetwork->Configuration.Length = le32_to_cpu(pnetwork->\r\nConfiguration.Length);\r\npnetwork->InfrastructureMode = le32_to_cpu(pnetwork->\r\nInfrastructureMode);\r\npnetwork->IELength = le32_to_cpu(pnetwork->IELength);\r\n#endif\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif ((pmlmepriv->fw_state) & WIFI_AP_STATE) {\r\npsta = r8712_get_stainfo(&padapter->stapriv,\r\npnetwork->MacAddress);\r\nif (!psta) {\r\npsta = r8712_alloc_stainfo(&padapter->stapriv,\r\npnetwork->MacAddress);\r\nif (!psta)\r\ngoto createbss_cmd_fail;\r\n}\r\nr8712_indicate_connect(padapter);\r\n} else {\r\npwlan = _r8712_alloc_network(pmlmepriv);\r\nif (!pwlan) {\r\npwlan = r8712_get_oldest_wlan_network(\r\n&pmlmepriv->scanned_queue);\r\nif (!pwlan)\r\ngoto createbss_cmd_fail;\r\npwlan->last_scanned = jiffies;\r\n} else\r\nlist_add_tail(&(pwlan->list),\r\n&pmlmepriv->scanned_queue.queue);\r\npnetwork->Length = r8712_get_wlan_bssid_ex_sz(pnetwork);\r\nmemcpy(&(pwlan->network), pnetwork, pnetwork->Length);\r\npwlan->fixed = true;\r\nmemcpy(&tgt_network->network, pnetwork,\r\n(r8712_get_wlan_bssid_ex_sz(pnetwork)));\r\nif (pmlmepriv->fw_state & _FW_UNDER_LINKING)\r\npmlmepriv->fw_state ^= _FW_UNDER_LINKING;\r\n}\r\ncreatebss_cmd_fail:\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nvoid r8712_setstaKey_cmdrsp_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nstruct sta_priv *pstapriv = &padapter->stapriv;\r\nstruct set_stakey_rsp *psetstakey_rsp = (struct set_stakey_rsp *)\r\n(pcmd->rsp);\r\nstruct sta_info *psta = r8712_get_stainfo(pstapriv,\r\npsetstakey_rsp->addr);\r\nif (!psta)\r\ngoto exit;\r\npsta->aid = psta->mac_id = psetstakey_rsp->keyid;\r\nexit:\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nvoid r8712_setassocsta_cmdrsp_callback(struct _adapter *padapter,\r\nstruct cmd_obj *pcmd)\r\n{\r\nunsigned long irqL;\r\nstruct sta_priv *pstapriv = &padapter->stapriv;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct set_assocsta_parm *passocsta_parm =\r\n(struct set_assocsta_parm *)(pcmd->parmbuf);\r\nstruct set_assocsta_rsp *passocsta_rsp =\r\n(struct set_assocsta_rsp *) (pcmd->rsp);\r\nstruct sta_info *psta = r8712_get_stainfo(pstapriv,\r\npassocsta_parm->addr);\r\nif (!psta)\r\nreturn;\r\npsta->aid = psta->mac_id = passocsta_rsp->cam_id;\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif ((check_fwstate(pmlmepriv, WIFI_MP_STATE)) &&\r\n(check_fwstate(pmlmepriv, _FW_UNDER_LINKING)))\r\npmlmepriv->fw_state ^= _FW_UNDER_LINKING;\r\nset_fwstate(pmlmepriv, _FW_LINKED);\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nr8712_free_cmd_obj(pcmd);\r\n}\r\nu8 r8712_disconnectCtrlEx_cmd(struct _adapter *adapter, u32 enableDrvCtrl,\r\nu32 tryPktCnt, u32 tryPktInterval, u32 firstStageTO)\r\n{\r\nstruct cmd_obj *ph2c;\r\nstruct DisconnectCtrlEx_param *param;\r\nstruct cmd_priv *pcmdpriv = &adapter->cmdpriv;\r\nph2c = kmalloc(sizeof(*ph2c), GFP_ATOMIC);\r\nif (!ph2c)\r\nreturn _FAIL;\r\nparam = kzalloc(sizeof(*param), GFP_ATOMIC);\r\nif (!param) {\r\nkfree(ph2c);\r\nreturn _FAIL;\r\n}\r\nparam->EnableDrvCtrl = (unsigned char)enableDrvCtrl;\r\nparam->TryPktCnt = (unsigned char)tryPktCnt;\r\nparam->TryPktInterval = (unsigned char)tryPktInterval;\r\nparam->FirstStageTO = (unsigned int)firstStageTO;\r\ninit_h2fwcmd_w_parm_no_rsp(ph2c, param,\r\nGEN_CMD_CODE(_DisconnectCtrlEx));\r\nr8712_enqueue_cmd(pcmdpriv, ph2c);\r\nreturn _SUCCESS;\r\n}

struct nfp_nsp_identify *__nfp_nsp_identify(struct nfp_nsp *nsp)\r\n{\r\nstruct nfp_nsp_identify *nspi = NULL;\r\nstruct nsp_identify *ni;\r\nint ret;\r\nif (nfp_nsp_get_abi_ver_minor(nsp) < 15)\r\nreturn NULL;\r\nni = kzalloc(sizeof(*ni), GFP_KERNEL);\r\nif (!ni)\r\nreturn NULL;\r\nret = nfp_nsp_read_identify(nsp, ni, sizeof(*ni));\r\nif (ret < 0) {\r\nnfp_err(nfp_nsp_cpp(nsp), "reading bsp version failed %d\n",\r\nret);\r\ngoto exit_free;\r\n}\r\nnspi = kzalloc(sizeof(*nspi), GFP_KERNEL);\r\nif (!nspi)\r\ngoto exit_free;\r\nmemcpy(nspi->version, ni->version, sizeof(nspi->version));\r\nnspi->version[sizeof(nspi->version) - 1] = '\0';\r\nnspi->flags = ni->flags;\r\nnspi->br_primary = ni->br_primary;\r\nnspi->br_secondary = ni->br_secondary;\r\nnspi->br_nsp = ni->br_nsp;\r\nnspi->primary = le16_to_cpu(ni->primary);\r\nnspi->secondary = le16_to_cpu(ni->secondary);\r\nnspi->nsp = le16_to_cpu(ni->nsp);\r\nnspi->sensor_mask = le64_to_cpu(ni->sensor_mask);\r\nexit_free:\r\nkfree(ni);\r\nreturn nspi;\r\n}\r\nint nfp_hwmon_read_sensor(struct nfp_cpp *cpp, enum nfp_nsp_sensor_id id,\r\nlong *val)\r\n{\r\nstruct nfp_sensors s;\r\nstruct nfp_nsp *nsp;\r\nint ret;\r\nnsp = nfp_nsp_open(cpp);\r\nif (IS_ERR(nsp))\r\nreturn PTR_ERR(nsp);\r\nret = nfp_nsp_read_sensors(nsp, BIT(id), &s, sizeof(s));\r\nnfp_nsp_close(nsp);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (id) {\r\ncase NFP_SENSOR_CHIP_TEMPERATURE:\r\n*val = le32_to_cpu(s.chip_temp);\r\nbreak;\r\ncase NFP_SENSOR_ASSEMBLY_POWER:\r\n*val = le32_to_cpu(s.assembly_power);\r\nbreak;\r\ncase NFP_SENSOR_ASSEMBLY_12V_POWER:\r\n*val = le32_to_cpu(s.assembly_12v_power);\r\nbreak;\r\ncase NFP_SENSOR_ASSEMBLY_3V3_POWER:\r\n*val = le32_to_cpu(s.assembly_3v3_power);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

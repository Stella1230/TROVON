static __le16 vnt_time_stamp_off(struct vnt_private *priv, u16 rate)\r\n{\r\nreturn cpu_to_le16(wTimeStampOff[priv->byPreambleType % 2]\r\n[rate % MAX_RATE]);\r\n}\r\nstatic\r\nunsigned int\r\ns_uGetTxRsvTime(\r\nstruct vnt_private *pDevice,\r\nunsigned char byPktType,\r\nunsigned int cbFrameLength,\r\nunsigned short wRate,\r\nbool bNeedAck\r\n)\r\n{\r\nunsigned int uDataTime, uAckTime;\r\nuDataTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, cbFrameLength, wRate);\r\nif (byPktType == PK_TYPE_11B)\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, (unsigned short)pDevice->byTopCCKBasicRate);\r\nelse\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, (unsigned short)pDevice->byTopOFDMBasicRate);\r\nif (bNeedAck)\r\nreturn uDataTime + pDevice->uSIFS + uAckTime;\r\nelse\r\nreturn uDataTime;\r\n}\r\nstatic __le16 vnt_rxtx_rsvtime_le16(struct vnt_private *priv, u8 pkt_type,\r\nu32 frame_length, u16 rate, bool need_ack)\r\n{\r\nreturn cpu_to_le16((u16)s_uGetTxRsvTime(priv, pkt_type,\r\nframe_length, rate, need_ack));\r\n}\r\nstatic\r\n__le16\r\ns_uGetRTSCTSRsvTime(\r\nstruct vnt_private *pDevice,\r\nunsigned char byRTSRsvType,\r\nunsigned char byPktType,\r\nunsigned int cbFrameLength,\r\nunsigned short wCurrentRate\r\n)\r\n{\r\nunsigned int uRrvTime, uRTSTime, uCTSTime, uAckTime, uDataTime;\r\nuRrvTime = uRTSTime = uCTSTime = uAckTime = uDataTime = 0;\r\nuDataTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, cbFrameLength, wCurrentRate);\r\nif (byRTSRsvType == 0) {\r\nuRTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 20, pDevice->byTopCCKBasicRate);\r\nuCTSTime = uAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\n} else if (byRTSRsvType == 1) {\r\nuRTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 20, pDevice->byTopCCKBasicRate);\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\n} else if (byRTSRsvType == 2) {\r\nuRTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 20, pDevice->byTopOFDMBasicRate);\r\nuCTSTime = uAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\n} else if (byRTSRsvType == 3) {\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nuRrvTime = uCTSTime + uAckTime + uDataTime + 2*pDevice->uSIFS;\r\nreturn cpu_to_le16((u16)uRrvTime);\r\n}\r\nuRrvTime = uRTSTime + uCTSTime + uAckTime + uDataTime + 3*pDevice->uSIFS;\r\nreturn cpu_to_le16((u16)uRrvTime);\r\n}\r\nstatic\r\nunsigned int\r\ns_uGetDataDuration(\r\nstruct vnt_private *pDevice,\r\nunsigned char byDurType,\r\nunsigned int cbFrameLength,\r\nunsigned char byPktType,\r\nunsigned short wRate,\r\nbool bNeedAck,\r\nunsigned int uFragIdx,\r\nunsigned int cbLastFragmentSize,\r\nunsigned int uMACfragNum,\r\nunsigned char byFBOption\r\n)\r\n{\r\nbool bLastFrag = false;\r\nunsigned int uAckTime = 0, uNextPktTime = 0;\r\nif (uFragIdx == (uMACfragNum-1))\r\nbLastFrag = true;\r\nswitch (byDurType) {\r\ncase DATADUR_B:\r\nif (((uMACfragNum == 1)) || bLastFrag) {\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nreturn pDevice->uSIFS + uAckTime;\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wRate, bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nreturn pDevice->uSIFS + uAckTime + uNextPktTime;\r\n} else {\r\nreturn pDevice->uSIFS + uNextPktTime;\r\n}\r\n}\r\nbreak;\r\ncase DATADUR_A:\r\nif (((uMACfragNum == 1)) || bLastFrag) {\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime;\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wRate, bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime + uNextPktTime;\r\n} else {\r\nreturn pDevice->uSIFS + uNextPktTime;\r\n}\r\n}\r\nbreak;\r\ncase DATADUR_A_F0:\r\nif (((uMACfragNum == 1)) || bLastFrag) {\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime;\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\nif (byFBOption == AUTO_FB_0) {\r\nif (wRate < RATE_18M)\r\nwRate = RATE_18M;\r\nelse if (wRate > RATE_54M)\r\nwRate = RATE_54M;\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wFB_Opt0[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\n} else {\r\nif (wRate < RATE_18M)\r\nwRate = RATE_18M;\r\nelse if (wRate > RATE_54M)\r\nwRate = RATE_54M;\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wFB_Opt1[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\n}\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime + uNextPktTime;\r\n} else {\r\nreturn pDevice->uSIFS + uNextPktTime;\r\n}\r\n}\r\nbreak;\r\ncase DATADUR_A_F1:\r\nif (((uMACfragNum == 1)) || bLastFrag) {\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime;\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\nif (byFBOption == AUTO_FB_0) {\r\nif (wRate < RATE_18M)\r\nwRate = RATE_18M;\r\nelse if (wRate > RATE_54M)\r\nwRate = RATE_54M;\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wFB_Opt0[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\n} else {\r\nif (wRate < RATE_18M)\r\nwRate = RATE_18M;\r\nelse if (wRate > RATE_54M)\r\nwRate = RATE_54M;\r\nif (uFragIdx == (uMACfragNum-2))\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbLastFragmentSize, wFB_Opt1[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nelse\r\nuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\n}\r\nif (bNeedAck) {\r\nuAckTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nreturn pDevice->uSIFS + uAckTime + uNextPktTime;\r\n} else {\r\nreturn pDevice->uSIFS + uNextPktTime;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic\r\n__le16\r\ns_uGetRTSCTSDuration(\r\nstruct vnt_private *pDevice,\r\nunsigned char byDurType,\r\nunsigned int cbFrameLength,\r\nunsigned char byPktType,\r\nunsigned short wRate,\r\nbool bNeedAck,\r\nunsigned char byFBOption\r\n)\r\n{\r\nunsigned int uCTSTime = 0, uDurTime = 0;\r\nswitch (byDurType) {\r\ncase RTSDUR_BB:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nbreak;\r\ncase RTSDUR_BA:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nbreak;\r\ncase RTSDUR_AA:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nbreak;\r\ncase CTSDUR_BA:\r\nuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\r\nbreak;\r\ncase RTSDUR_BA_F0:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ncase RTSDUR_AA_F0:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ncase RTSDUR_BA_F1:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopCCKBasicRate);\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ncase RTSDUR_AA_F1:\r\nuCTSTime = BBuGetFrameTime(pDevice->byPreambleType, byPktType, 14, pDevice->byTopOFDMBasicRate);\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = uCTSTime + 2*pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ncase CTSDUR_BA_F0:\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE0][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ncase CTSDUR_BA_F1:\r\nif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt0[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nelse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\r\nuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wFB_Opt1[FB_RATE1][wRate-RATE_18M], bNeedAck);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn cpu_to_le16((u16)uDurTime);\r\n}\r\nstatic\r\n__le16\r\ns_uFillDataHead(\r\nstruct vnt_private *pDevice,\r\nunsigned char byPktType,\r\nvoid *pTxDataHead,\r\nunsigned int cbFrameLength,\r\nunsigned int uDMAIdx,\r\nbool bNeedAck,\r\nunsigned int uFragIdx,\r\nunsigned int cbLastFragmentSize,\r\nunsigned int uMACfragNum,\r\nunsigned char byFBOption,\r\nunsigned short wCurrentRate,\r\nbool is_pspoll\r\n)\r\n{\r\nif (!pTxDataHead)\r\nreturn 0;\r\nif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\r\nif (byFBOption == AUTO_FB_NONE) {\r\nstruct vnt_tx_datahead_g *buf = pTxDataHead;\r\nvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\r\nbyPktType, &buf->a);\r\nvnt_get_phy_field(pDevice, cbFrameLength,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nif (is_pspoll) {\r\n__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\r\nbuf->duration_a = dur;\r\nbuf->duration_b = dur;\r\n} else {\r\nbuf->duration_a =\r\ncpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength,\r\nbyPktType, wCurrentRate, bNeedAck, uFragIdx,\r\ncbLastFragmentSize, uMACfragNum,\r\nbyFBOption));\r\nbuf->duration_b =\r\ncpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength,\r\nPK_TYPE_11B, pDevice->byTopCCKBasicRate,\r\nbNeedAck, uFragIdx, cbLastFragmentSize,\r\nuMACfragNum, byFBOption));\r\n}\r\nbuf->time_stamp_off_a = vnt_time_stamp_off(pDevice, wCurrentRate);\r\nbuf->time_stamp_off_b = vnt_time_stamp_off(pDevice, pDevice->byTopCCKBasicRate);\r\nreturn buf->duration_a;\r\n} else {\r\nstruct vnt_tx_datahead_g_fb *buf = pTxDataHead;\r\nvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\r\nbyPktType, &buf->a);\r\nvnt_get_phy_field(pDevice, cbFrameLength,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_a = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->duration_b = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength, PK_TYPE_11B,\r\npDevice->byTopCCKBasicRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->duration_a_f0 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F0, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->duration_a_f1 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F1, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->time_stamp_off_a = vnt_time_stamp_off(pDevice, wCurrentRate);\r\nbuf->time_stamp_off_b = vnt_time_stamp_off(pDevice, pDevice->byTopCCKBasicRate);\r\nreturn buf->duration_a;\r\n}\r\n} else if (byPktType == PK_TYPE_11A) {\r\nif (byFBOption != AUTO_FB_NONE) {\r\nstruct vnt_tx_datahead_a_fb *buf = pTxDataHead;\r\nvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\r\nbyPktType, &buf->a);\r\nbuf->duration = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->duration_f0 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F0, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->duration_f1 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F1, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\r\nbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\r\nreturn buf->duration;\r\n} else {\r\nstruct vnt_tx_datahead_ab *buf = pTxDataHead;\r\nvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\r\nbyPktType, &buf->ab);\r\nif (is_pspoll) {\r\n__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\r\nbuf->duration = dur;\r\n} else {\r\nbuf->duration =\r\ncpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx,\r\ncbLastFragmentSize, uMACfragNum,\r\nbyFBOption));\r\n}\r\nbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\r\nreturn buf->duration;\r\n}\r\n} else {\r\nstruct vnt_tx_datahead_ab *buf = pTxDataHead;\r\nvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\r\nbyPktType, &buf->ab);\r\nif (is_pspoll) {\r\n__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\r\nbuf->duration = dur;\r\n} else {\r\nbuf->duration =\r\ncpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck, uFragIdx,\r\ncbLastFragmentSize, uMACfragNum,\r\nbyFBOption));\r\n}\r\nbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\r\nreturn buf->duration;\r\n}\r\nreturn 0;\r\n}\r\nstatic\r\nvoid\r\ns_vFillRTSHead(\r\nstruct vnt_private *pDevice,\r\nunsigned char byPktType,\r\nvoid *pvRTS,\r\nunsigned int cbFrameLength,\r\nbool bNeedAck,\r\nbool bDisCRC,\r\nstruct ieee80211_hdr *hdr,\r\nunsigned short wCurrentRate,\r\nunsigned char byFBOption\r\n)\r\n{\r\nunsigned int uRTSFrameLen = 20;\r\nif (!pvRTS)\r\nreturn;\r\nif (bDisCRC) {\r\nuRTSFrameLen -= 4;\r\n}\r\nif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\r\nif (byFBOption == AUTO_FB_NONE) {\r\nstruct vnt_rts_g *buf = pvRTS;\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopOFDMBasicRate,\r\nbyPktType, &buf->a);\r\nbuf->duration_bb =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BB,\r\ncbFrameLength, PK_TYPE_11B,\r\npDevice->byTopCCKBasicRate,\r\nbNeedAck, byFBOption);\r\nbuf->duration_aa =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->duration_ba =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration_aa;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_RTS);\r\nether_addr_copy(buf->data.ra, hdr->addr1);\r\nether_addr_copy(buf->data.ta, hdr->addr2);\r\n} else {\r\nstruct vnt_rts_g_fb *buf = pvRTS;\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopOFDMBasicRate,\r\nbyPktType, &buf->a);\r\nbuf->duration_bb =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BB,\r\ncbFrameLength, PK_TYPE_11B,\r\npDevice->byTopCCKBasicRate,\r\nbNeedAck, byFBOption);\r\nbuf->duration_aa =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->duration_ba =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_ba_f0 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BA_F0,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_aa_f0 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F0,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_ba_f1 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BA_F1,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_aa_f1 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F1,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration_aa;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_RTS);\r\nether_addr_copy(buf->data.ra, hdr->addr1);\r\nether_addr_copy(buf->data.ta, hdr->addr2);\r\n}\r\n} else if (byPktType == PK_TYPE_11A) {\r\nif (byFBOption == AUTO_FB_NONE) {\r\nstruct vnt_rts_ab *buf = pvRTS;\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopOFDMBasicRate,\r\nbyPktType, &buf->ab);\r\nbuf->duration =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_RTS);\r\nether_addr_copy(buf->data.ra, hdr->addr1);\r\nether_addr_copy(buf->data.ta, hdr->addr2);\r\n} else {\r\nstruct vnt_rts_a_fb *buf = pvRTS;\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopOFDMBasicRate,\r\nbyPktType, &buf->a);\r\nbuf->duration =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_f0 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F0,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->rts_duration_f1 =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F1,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_RTS);\r\nether_addr_copy(buf->data.ra, hdr->addr1);\r\nether_addr_copy(buf->data.ta, hdr->addr2);\r\n}\r\n} else if (byPktType == PK_TYPE_11B) {\r\nstruct vnt_rts_ab *buf = pvRTS;\r\nvnt_get_phy_field(pDevice, uRTSFrameLen,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->ab);\r\nbuf->duration =\r\ns_uGetRTSCTSDuration(pDevice, RTSDUR_BB, cbFrameLength,\r\nbyPktType, wCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_RTS);\r\nether_addr_copy(buf->data.ra, hdr->addr1);\r\nether_addr_copy(buf->data.ta, hdr->addr2);\r\n}\r\n}\r\nstatic\r\nvoid\r\ns_vFillCTSHead(\r\nstruct vnt_private *pDevice,\r\nunsigned int uDMAIdx,\r\nunsigned char byPktType,\r\nvoid *pvCTS,\r\nunsigned int cbFrameLength,\r\nbool bNeedAck,\r\nbool bDisCRC,\r\nunsigned short wCurrentRate,\r\nunsigned char byFBOption\r\n)\r\n{\r\nunsigned int uCTSFrameLen = 14;\r\nif (!pvCTS)\r\nreturn;\r\nif (bDisCRC) {\r\nuCTSFrameLen -= 4;\r\n}\r\nif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\r\nif (byFBOption != AUTO_FB_NONE && uDMAIdx != TYPE_ATIMDMA && uDMAIdx != TYPE_BEACONDMA) {\r\nstruct vnt_cts_fb *buf = pvCTS;\r\nvnt_get_phy_field(pDevice, uCTSFrameLen,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_ba =\r\ns_uGetRTSCTSDuration(pDevice, CTSDUR_BA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->cts_duration_ba_f0 =\r\ns_uGetRTSCTSDuration(pDevice, CTSDUR_BA_F0,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->cts_duration_ba_f1 =\r\ns_uGetRTSCTSDuration(pDevice, CTSDUR_BA_F1,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration_ba;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_CTS);\r\nbuf->reserved2 = 0x0;\r\nether_addr_copy(buf->data.ra,\r\npDevice->abyCurrentNetAddr);\r\n} else {\r\nstruct vnt_cts *buf = pvCTS;\r\nvnt_get_phy_field(pDevice, uCTSFrameLen,\r\npDevice->byTopCCKBasicRate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_ba =\r\ns_uGetRTSCTSDuration(pDevice, CTSDUR_BA,\r\ncbFrameLength, byPktType,\r\nwCurrentRate, bNeedAck,\r\nbyFBOption);\r\nbuf->data.duration = buf->duration_ba;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL |\r\nIEEE80211_STYPE_CTS);\r\nbuf->reserved2 = 0x0;\r\nether_addr_copy(buf->data.ra,\r\npDevice->abyCurrentNetAddr);\r\n}\r\n}\r\n}\r\nstatic\r\nvoid\r\ns_vGenerateTxParameter(\r\nstruct vnt_private *pDevice,\r\nunsigned char byPktType,\r\nstruct vnt_tx_fifo_head *tx_buffer_head,\r\nvoid *pvRrvTime,\r\nvoid *pvRTS,\r\nvoid *pvCTS,\r\nunsigned int cbFrameSize,\r\nbool bNeedACK,\r\nunsigned int uDMAIdx,\r\nvoid *psEthHeader,\r\nunsigned short wCurrentRate\r\n)\r\n{\r\nu16 fifo_ctl = le16_to_cpu(tx_buffer_head->fifo_ctl);\r\nbool bDisCRC = false;\r\nunsigned char byFBOption = AUTO_FB_NONE;\r\ntx_buffer_head->current_rate = cpu_to_le16(wCurrentRate);\r\nif (fifo_ctl & FIFOCTL_CRCDIS)\r\nbDisCRC = true;\r\nif (fifo_ctl & FIFOCTL_AUTO_FB_0)\r\nbyFBOption = AUTO_FB_0;\r\nelse if (fifo_ctl & FIFOCTL_AUTO_FB_1)\r\nbyFBOption = AUTO_FB_1;\r\nif (!pvRrvTime)\r\nreturn;\r\nif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\r\nif (pvRTS != NULL) {\r\nstruct vnt_rrv_time_rts *buf = pvRrvTime;\r\nbuf->rts_rrv_time_aa = s_uGetRTSCTSRsvTime(pDevice, 2, byPktType, cbFrameSize, wCurrentRate);\r\nbuf->rts_rrv_time_ba = s_uGetRTSCTSRsvTime(pDevice, 1, byPktType, cbFrameSize, wCurrentRate);\r\nbuf->rts_rrv_time_bb = s_uGetRTSCTSRsvTime(pDevice, 0, byPktType, cbFrameSize, wCurrentRate);\r\nbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\r\nbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, pDevice->byTopCCKBasicRate, bNeedACK);\r\ns_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\r\n} else {\r\nstruct vnt_rrv_time_cts *buf = pvRrvTime;\r\nbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\r\nbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, pDevice->byTopCCKBasicRate, bNeedACK);\r\nbuf->cts_rrv_time_ba = s_uGetRTSCTSRsvTime(pDevice, 3, byPktType, cbFrameSize, wCurrentRate);\r\ns_vFillCTSHead(pDevice, uDMAIdx, byPktType, pvCTS, cbFrameSize, bNeedACK, bDisCRC, wCurrentRate, byFBOption);\r\n}\r\n} else if (byPktType == PK_TYPE_11A) {\r\nif (pvRTS != NULL) {\r\nstruct vnt_rrv_time_ab *buf = pvRrvTime;\r\nbuf->rts_rrv_time = s_uGetRTSCTSRsvTime(pDevice, 2, byPktType, cbFrameSize, wCurrentRate);\r\nbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\r\ns_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\r\n} else if (!pvRTS) {\r\nstruct vnt_rrv_time_ab *buf = pvRrvTime;\r\nbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11A, cbFrameSize, wCurrentRate, bNeedACK);\r\n}\r\n} else if (byPktType == PK_TYPE_11B) {\r\nif (pvRTS != NULL) {\r\nstruct vnt_rrv_time_ab *buf = pvRrvTime;\r\nbuf->rts_rrv_time = s_uGetRTSCTSRsvTime(pDevice, 0, byPktType, cbFrameSize, wCurrentRate);\r\nbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, wCurrentRate, bNeedACK);\r\ns_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\r\n} else {\r\nstruct vnt_rrv_time_ab *buf = pvRrvTime;\r\nbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, wCurrentRate, bNeedACK);\r\n}\r\n}\r\n}\r\nstatic unsigned int\r\ns_cbFillTxBufHead(struct vnt_private *pDevice, unsigned char byPktType,\r\nunsigned char *pbyTxBufferAddr,\r\nunsigned int uDMAIdx, struct vnt_tx_desc *pHeadTD,\r\nunsigned int is_pspoll)\r\n{\r\nstruct vnt_td_info *td_info = pHeadTD->td_info;\r\nstruct sk_buff *skb = td_info->skb;\r\nstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\r\nstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\r\nstruct vnt_tx_fifo_head *tx_buffer_head =\r\n(struct vnt_tx_fifo_head *)td_info->buf;\r\nu16 fifo_ctl = le16_to_cpu(tx_buffer_head->fifo_ctl);\r\nunsigned int cbFrameSize;\r\n__le16 uDuration;\r\nunsigned char *pbyBuffer;\r\nunsigned int uLength = 0;\r\nunsigned int cbMICHDR = 0;\r\nunsigned int uMACfragNum = 1;\r\nunsigned int uPadding = 0;\r\nunsigned int cbReqCount = 0;\r\nbool bNeedACK = (bool)(fifo_ctl & FIFOCTL_NEEDACK);\r\nbool bRTS = (bool)(fifo_ctl & FIFOCTL_RTS);\r\nstruct vnt_tx_desc *ptdCurr;\r\nunsigned int cbHeaderLength = 0;\r\nvoid *pvRrvTime;\r\nstruct vnt_mic_hdr *pMICHDR;\r\nvoid *pvRTS;\r\nvoid *pvCTS;\r\nvoid *pvTxDataHd;\r\nunsigned short wTxBufSize;\r\nunsigned char byFBOption = AUTO_FB_NONE;\r\npvRrvTime = pMICHDR = pvRTS = pvCTS = pvTxDataHd = NULL;\r\ncbFrameSize = skb->len + 4;\r\nif (info->control.hw_key) {\r\nswitch (info->control.hw_key->cipher) {\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ncbMICHDR = sizeof(struct vnt_mic_hdr);\r\ndefault:\r\nbreak;\r\n}\r\ncbFrameSize += info->control.hw_key->icv_len;\r\nif (pDevice->byLocalID > REV_ID_VT3253_A1) {\r\nuPadding = 4 - (ieee80211_get_hdrlen_from_skb(skb) % 4);\r\nuPadding %= 4;\r\n}\r\n}\r\nif (fifo_ctl & FIFOCTL_AUTO_FB_0)\r\nbyFBOption = AUTO_FB_0;\r\nelse if (fifo_ctl & FIFOCTL_AUTO_FB_1)\r\nbyFBOption = AUTO_FB_1;\r\nwTxBufSize = sizeof(struct vnt_tx_fifo_head);\r\nif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\r\nif (byFBOption == AUTO_FB_NONE) {\r\nif (bRTS) {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts));\r\npvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) + cbMICHDR);\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\r\ncbMICHDR + sizeof(struct vnt_rts_g));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\r\ncbMICHDR + sizeof(struct vnt_rts_g) +\r\nsizeof(struct vnt_tx_datahead_g);\r\n} else {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts));\r\npvRTS = NULL;\r\npvCTS = (void *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) + cbMICHDR);\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\r\nsizeof(struct vnt_rrv_time_cts) + cbMICHDR + sizeof(struct vnt_cts));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\r\ncbMICHDR + sizeof(struct vnt_cts) + sizeof(struct vnt_tx_datahead_g);\r\n}\r\n} else {\r\nif (bRTS) {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts));\r\npvRTS = (void *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) + cbMICHDR);\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\r\ncbMICHDR + sizeof(struct vnt_rts_g_fb));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\r\ncbMICHDR + sizeof(struct vnt_rts_g_fb) + sizeof(struct vnt_tx_datahead_g_fb);\r\n} else {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts));\r\npvRTS = NULL;\r\npvCTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) + cbMICHDR);\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\r\ncbMICHDR + sizeof(struct vnt_cts_fb));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\r\ncbMICHDR + sizeof(struct vnt_cts_fb) + sizeof(struct vnt_tx_datahead_g_fb);\r\n}\r\n}\r\n} else {\r\nif (byFBOption == AUTO_FB_NONE) {\r\nif (bRTS) {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\r\npvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\r\nsizeof(struct vnt_rrv_time_ab) + cbMICHDR + sizeof(struct vnt_rts_ab));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\r\ncbMICHDR + sizeof(struct vnt_rts_ab) + sizeof(struct vnt_tx_datahead_ab);\r\n} else {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\r\npvRTS = NULL;\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\r\ncbMICHDR + sizeof(struct vnt_tx_datahead_ab);\r\n}\r\n} else {\r\nif (bRTS) {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\r\npvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\r\nsizeof(struct vnt_rrv_time_ab) + cbMICHDR + sizeof(struct vnt_rts_a_fb));\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\r\ncbMICHDR + sizeof(struct vnt_rts_a_fb) + sizeof(struct vnt_tx_datahead_a_fb);\r\n} else {\r\npvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\r\npMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\r\npvRTS = NULL;\r\npvCTS = NULL;\r\npvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\r\ncbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\r\ncbMICHDR + sizeof(struct vnt_tx_datahead_a_fb);\r\n}\r\n}\r\n}\r\ntd_info->mic_hdr = pMICHDR;\r\nmemset((void *)(pbyTxBufferAddr + wTxBufSize), 0, (cbHeaderLength - wTxBufSize));\r\ns_vGenerateTxParameter(pDevice, byPktType, tx_buffer_head, pvRrvTime, pvRTS, pvCTS,\r\ncbFrameSize, bNeedACK, uDMAIdx, hdr, pDevice->wCurrentRate);\r\nuDuration = s_uFillDataHead(pDevice, byPktType, pvTxDataHd, cbFrameSize, uDMAIdx, bNeedACK,\r\n0, 0, uMACfragNum, byFBOption, pDevice->wCurrentRate, is_pspoll);\r\nhdr->duration_id = uDuration;\r\ncbReqCount = cbHeaderLength + uPadding + skb->len;\r\npbyBuffer = (unsigned char *)pHeadTD->td_info->buf;\r\nuLength = cbHeaderLength + uPadding;\r\nmemcpy((pbyBuffer + uLength), skb->data, skb->len);\r\nptdCurr = pHeadTD;\r\nptdCurr->td_info->req_count = (u16)cbReqCount;\r\nreturn cbHeaderLength;\r\n}\r\nstatic void vnt_fill_txkey(struct ieee80211_hdr *hdr, u8 *key_buffer,\r\nstruct ieee80211_key_conf *tx_key,\r\nstruct sk_buff *skb, u16 payload_len,\r\nstruct vnt_mic_hdr *mic_hdr)\r\n{\r\nu64 pn64;\r\nu8 *iv = ((u8 *)hdr + ieee80211_get_hdrlen_from_skb(skb));\r\npayload_len -= ieee80211_get_hdrlen_from_skb(skb);\r\npayload_len -= tx_key->icv_len;\r\nswitch (tx_key->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nmemcpy(key_buffer, iv, 3);\r\nmemcpy(key_buffer + 3, tx_key->key, tx_key->keylen);\r\nif (tx_key->keylen == WLAN_KEY_LEN_WEP40) {\r\nmemcpy(key_buffer + 8, iv, 3);\r\nmemcpy(key_buffer + 11,\r\ntx_key->key, WLAN_KEY_LEN_WEP40);\r\n}\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nieee80211_get_tkip_p2k(tx_key, skb, key_buffer);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\nif (!mic_hdr)\r\nreturn;\r\nmic_hdr->id = 0x59;\r\nmic_hdr->payload_len = cpu_to_be16(payload_len);\r\nether_addr_copy(mic_hdr->mic_addr2, hdr->addr2);\r\npn64 = atomic64_read(&tx_key->tx_pn);\r\nmic_hdr->ccmp_pn[5] = pn64;\r\nmic_hdr->ccmp_pn[4] = pn64 >> 8;\r\nmic_hdr->ccmp_pn[3] = pn64 >> 16;\r\nmic_hdr->ccmp_pn[2] = pn64 >> 24;\r\nmic_hdr->ccmp_pn[1] = pn64 >> 32;\r\nmic_hdr->ccmp_pn[0] = pn64 >> 40;\r\nif (ieee80211_has_a4(hdr->frame_control))\r\nmic_hdr->hlen = cpu_to_be16(28);\r\nelse\r\nmic_hdr->hlen = cpu_to_be16(22);\r\nether_addr_copy(mic_hdr->addr1, hdr->addr1);\r\nether_addr_copy(mic_hdr->addr2, hdr->addr2);\r\nether_addr_copy(mic_hdr->addr3, hdr->addr3);\r\nmic_hdr->frame_control = cpu_to_le16(\r\nle16_to_cpu(hdr->frame_control) & 0xc78f);\r\nmic_hdr->seq_ctrl = cpu_to_le16(\r\nle16_to_cpu(hdr->seq_ctrl) & 0xf);\r\nif (ieee80211_has_a4(hdr->frame_control))\r\nether_addr_copy(mic_hdr->addr4, hdr->addr4);\r\nmemcpy(key_buffer, tx_key->key, WLAN_KEY_LEN_CCMP);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint vnt_generate_fifo_header(struct vnt_private *priv, u32 dma_idx,\r\nstruct vnt_tx_desc *head_td, struct sk_buff *skb)\r\n{\r\nstruct vnt_td_info *td_info = head_td->td_info;\r\nstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\r\nstruct ieee80211_tx_rate *tx_rate = &info->control.rates[0];\r\nstruct ieee80211_rate *rate;\r\nstruct ieee80211_key_conf *tx_key;\r\nstruct ieee80211_hdr *hdr;\r\nstruct vnt_tx_fifo_head *tx_buffer_head =\r\n(struct vnt_tx_fifo_head *)td_info->buf;\r\nu16 tx_body_size = skb->len, current_rate;\r\nu8 pkt_type;\r\nbool is_pspoll = false;\r\nmemset(tx_buffer_head, 0, sizeof(*tx_buffer_head));\r\nhdr = (struct ieee80211_hdr *)(skb->data);\r\nrate = ieee80211_get_tx_rate(priv->hw, info);\r\ncurrent_rate = rate->hw_value;\r\nif (priv->wCurrentRate != current_rate &&\r\n!(priv->hw->conf.flags & IEEE80211_CONF_OFFCHANNEL)) {\r\npriv->wCurrentRate = current_rate;\r\nRFbSetPower(priv, priv->wCurrentRate,\r\npriv->hw->conf.chandef.chan->hw_value);\r\n}\r\nif (current_rate > RATE_11M) {\r\nif (info->band == NL80211_BAND_5GHZ) {\r\npkt_type = PK_TYPE_11A;\r\n} else {\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_CTS_PROTECT)\r\npkt_type = PK_TYPE_11GB;\r\nelse\r\npkt_type = PK_TYPE_11GA;\r\n}\r\n} else {\r\npkt_type = PK_TYPE_11B;\r\n}\r\nif (pkt_type == PK_TYPE_11A)\r\ntx_buffer_head->fifo_ctl = 0;\r\nelse if (pkt_type == PK_TYPE_11B)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11B);\r\nelse if (pkt_type == PK_TYPE_11GB)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GB);\r\nelse if (pkt_type == PK_TYPE_11GA)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GA);\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_GENINT);\r\nif (!ieee80211_is_data(hdr->frame_control)) {\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_TMOEN);\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_ISDMA0);\r\ntx_buffer_head->time_stamp =\r\ncpu_to_le16(DEFAULT_MGN_LIFETIME_RES_64us);\r\n} else {\r\ntx_buffer_head->time_stamp =\r\ncpu_to_le16(DEFAULT_MSDU_LIFETIME_RES_64us);\r\n}\r\nif (!(info->flags & IEEE80211_TX_CTL_NO_ACK))\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_NEEDACK);\r\nif (ieee80211_has_retry(hdr->frame_control))\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LRETRY);\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_SHORT_PREAMBLE)\r\npriv->byPreambleType = PREAMBLE_SHORT;\r\nelse\r\npriv->byPreambleType = PREAMBLE_LONG;\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_RTS_CTS)\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_RTS);\r\nif (ieee80211_has_a4(hdr->frame_control)) {\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LHEAD);\r\npriv->bLongHeader = true;\r\n}\r\nif (info->flags & IEEE80211_TX_CTL_NO_PS_BUFFER)\r\nis_pspoll = true;\r\ntx_buffer_head->frag_ctl =\r\ncpu_to_le16(ieee80211_get_hdrlen_from_skb(skb) << 10);\r\nif (info->control.hw_key) {\r\ntx_key = info->control.hw_key;\r\nswitch (info->control.hw_key->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_LEGACY);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_TKIP);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_AES);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ntx_buffer_head->current_rate = cpu_to_le16(current_rate);\r\nif (current_rate >= RATE_18M && ieee80211_is_data(hdr->frame_control)) {\r\nif (priv->byAutoFBCtrl == AUTO_FB_0)\r\ntx_buffer_head->fifo_ctl |=\r\ncpu_to_le16(FIFOCTL_AUTO_FB_0);\r\nelse if (priv->byAutoFBCtrl == AUTO_FB_1)\r\ntx_buffer_head->fifo_ctl |=\r\ncpu_to_le16(FIFOCTL_AUTO_FB_1);\r\n}\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_NONFRAG);\r\ns_cbFillTxBufHead(priv, pkt_type, (u8 *)tx_buffer_head,\r\ndma_idx, head_td, is_pspoll);\r\nif (info->control.hw_key) {\r\ntx_key = info->control.hw_key;\r\nif (tx_key->keylen > 0)\r\nvnt_fill_txkey(hdr, tx_buffer_head->tx_key,\r\ntx_key, skb, tx_body_size, td_info->mic_hdr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int vnt_beacon_xmit(struct vnt_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct vnt_tx_short_buf_head *short_head =\r\n(struct vnt_tx_short_buf_head *)priv->tx_beacon_bufs;\r\nstruct ieee80211_mgmt *mgmt_hdr = (struct ieee80211_mgmt *)\r\n(priv->tx_beacon_bufs + sizeof(*short_head));\r\nstruct ieee80211_tx_info *info;\r\nu32 frame_size = skb->len + 4;\r\nu16 current_rate;\r\nmemset(priv->tx_beacon_bufs, 0, sizeof(*short_head));\r\nif (priv->byBBType == BB_TYPE_11A) {\r\ncurrent_rate = RATE_6M;\r\nvnt_get_phy_field(priv, frame_size, current_rate,\r\nPK_TYPE_11A, &short_head->ab);\r\nshort_head->duration =\r\ncpu_to_le16((u16)s_uGetDataDuration(priv, DATADUR_B,\r\nframe_size, PK_TYPE_11A, current_rate,\r\nfalse, 0, 0, 1, AUTO_FB_NONE));\r\nshort_head->time_stamp_off =\r\nvnt_time_stamp_off(priv, current_rate);\r\n} else {\r\ncurrent_rate = RATE_1M;\r\nshort_head->fifo_ctl |= cpu_to_le16(FIFOCTL_11B);\r\nvnt_get_phy_field(priv, frame_size, current_rate,\r\nPK_TYPE_11B, &short_head->ab);\r\nshort_head->duration =\r\ncpu_to_le16((u16)s_uGetDataDuration(priv, DATADUR_B,\r\nframe_size, PK_TYPE_11B, current_rate,\r\nfalse, 0, 0, 1, AUTO_FB_NONE));\r\nshort_head->time_stamp_off =\r\nvnt_time_stamp_off(priv, current_rate);\r\n}\r\nshort_head->fifo_ctl |= cpu_to_le16(FIFOCTL_GENINT);\r\nmemcpy(mgmt_hdr, skb->data, skb->len);\r\nmgmt_hdr->u.beacon.timestamp = 0;\r\ninfo = IEEE80211_SKB_CB(skb);\r\nif (info->flags & IEEE80211_TX_CTL_ASSIGN_SEQ) {\r\nstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)mgmt_hdr;\r\nhdr->duration_id = 0;\r\nhdr->seq_ctrl = cpu_to_le16(priv->wSeqCounter << 4);\r\n}\r\npriv->wSeqCounter++;\r\nif (priv->wSeqCounter > 0x0fff)\r\npriv->wSeqCounter = 0;\r\npriv->wBCNBufLen = sizeof(*short_head) + skb->len;\r\nMACvSetCurrBCNTxDescAddr(priv->PortOffset, priv->tx_beacon_dma);\r\nMACvSetCurrBCNLength(priv->PortOffset, priv->wBCNBufLen);\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_TCR, TCR_AUTOBCNTX);\r\nMACvTransmitBCN(priv->PortOffset);\r\nreturn 0;\r\n}\r\nint vnt_beacon_make(struct vnt_private *priv, struct ieee80211_vif *vif)\r\n{\r\nstruct sk_buff *beacon;\r\nbeacon = ieee80211_beacon_get(priv->hw, vif);\r\nif (!beacon)\r\nreturn -ENOMEM;\r\nif (vnt_beacon_xmit(priv, beacon)) {\r\nieee80211_free_txskb(priv->hw, beacon);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nint vnt_beacon_enable(struct vnt_private *priv, struct ieee80211_vif *vif,\r\nstruct ieee80211_bss_conf *conf)\r\n{\r\nVNSvOutPortB(priv->PortOffset + MAC_REG_TFTCTL, TFTCTL_TSFCNTRST);\r\nVNSvOutPortB(priv->PortOffset + MAC_REG_TFTCTL, TFTCTL_TSFCNTREN);\r\nCARDvSetFirstNextTBTT(priv, conf->beacon_int);\r\nCARDbSetBeaconPeriod(priv, conf->beacon_int);\r\nreturn vnt_beacon_make(priv, vif);\r\n}

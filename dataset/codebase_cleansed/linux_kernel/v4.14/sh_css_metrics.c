void\r\nsh_css_metrics_start_frame(void)\r\n{\r\nsh_css_metrics.frame_metrics.num_frames++;\r\n}\r\nstatic void\r\nclear_histogram(struct sh_css_pc_histogram *histogram)\r\n{\r\nunsigned i;\r\nassert(histogram != NULL);\r\nfor (i = 0; i < histogram->length; i++) {\r\nhistogram->run[i] = 0;\r\nhistogram->stall[i] = 0;\r\nhistogram->msink[i] = 0xFFFF;\r\n}\r\n}\r\nvoid\r\nsh_css_metrics_enable_pc_histogram(bool enable)\r\n{\r\npc_histogram_enabled = enable;\r\n}\r\nstatic void\r\nmake_histogram(struct sh_css_pc_histogram *histogram, unsigned length)\r\n{\r\nassert(histogram != NULL);\r\nif (histogram->length)\r\nreturn;\r\nif (histogram->run)\r\nreturn;\r\nhistogram->run = sh_css_malloc(length * sizeof(*histogram->run));\r\nif (!histogram->run)\r\nreturn;\r\nhistogram->stall = sh_css_malloc(length * sizeof(*histogram->stall));\r\nif (!histogram->stall)\r\nreturn;\r\nhistogram->msink = sh_css_malloc(length * sizeof(*histogram->msink));\r\nif (!histogram->msink)\r\nreturn;\r\nhistogram->length = length;\r\nclear_histogram(histogram);\r\n}\r\nstatic void\r\ninsert_binary_metrics(struct sh_css_binary_metrics **l,\r\nstruct sh_css_binary_metrics *metrics)\r\n{\r\nassert(l != NULL);\r\nassert(*l != NULL);\r\nassert(metrics != NULL);\r\nfor (; *l; l = &(*l)->next)\r\nif (*l == metrics)\r\nreturn;\r\n*l = metrics;\r\nmetrics->next = NULL;\r\n}\r\nvoid\r\nsh_css_metrics_start_binary(struct sh_css_binary_metrics *metrics)\r\n{\r\nassert(metrics != NULL);\r\nif (!pc_histogram_enabled)\r\nreturn;\r\nisp_histogram = &metrics->isp_histogram;\r\nsp_histogram = &metrics->sp_histogram;\r\nmake_histogram(isp_histogram, ISP_PMEM_DEPTH);\r\nmake_histogram(sp_histogram, SP_PMEM_DEPTH);\r\ninsert_binary_metrics(&sh_css_metrics.binary_metrics, metrics);\r\n}\r\nvoid\r\nsh_css_metrics_sample_pcs(void)\r\n{\r\nbool stall;\r\nunsigned int pc;\r\nunsigned int msink;\r\n#if SUSPEND\r\nunsigned int sc = 0;\r\nunsigned int stopped_sc = 0;\r\nunsigned int resume_sc = 0;\r\n#endif\r\n#if MULTIPLE_PCS\r\nint i;\r\nunsigned int pc_tab[NOF_PCS];\r\nfor (i = 0; i < NOF_PCS; i++)\r\npc_tab[i] = 0;\r\n#endif\r\nif (!pc_histogram_enabled)\r\nreturn;\r\nif (isp_histogram) {\r\n#if SUSPEND\r\nisp_ctrl_store(ISP0_ID, ISP_SC_REG, STOP_MASK);\r\n#endif\r\nmsink = isp_ctrl_load(ISP0_ID, ISP_CTRL_SINK_REG);\r\n#if MULTIPLE_PCS\r\nfor (i = 0; i < NOF_PCS; i++)\r\npc_tab[i] = isp_ctrl_load(ISP0_ID, ISP_PC_REG);\r\n#else\r\npc = isp_ctrl_load(ISP0_ID, ISP_PC_REG);\r\n#endif\r\n#if SUSPEND\r\nisp_ctrl_store(ISP0_ID, ISP_SC_REG, RESUME_MASK);\r\n#endif\r\nisp_histogram->msink[pc] &= msink;\r\nstall = (msink != 0x7FF);\r\nif (stall)\r\nisp_histogram->stall[pc]++;\r\nelse\r\nisp_histogram->run[pc]++;\r\n}\r\nif (sp_histogram && 0) {\r\nmsink = sp_ctrl_load(SP0_ID, SP_CTRL_SINK_REG);\r\npc = sp_ctrl_load(SP0_ID, SP_PC_REG);\r\nsp_histogram->msink[pc] &= msink;\r\nstall = (msink != 0x7FF);\r\nif (stall)\r\nsp_histogram->stall[pc]++;\r\nelse\r\nsp_histogram->run[pc]++;\r\n}\r\n}

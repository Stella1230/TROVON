static int set_msr_configuration(struct i2c_client *client, uint8_t *bufptr,\r\nunsigned int size)\r\n{\r\nuint8_t *ptr = bufptr;\r\nwhile (ptr < bufptr + size) {\r\nstruct i2c_msg msg = {\r\n.addr = client->addr,\r\n.flags = 0,\r\n};\r\nint ret;\r\nmsg.len = *ptr++;\r\nmsg.buf = ptr;\r\nptr += msg.len;\r\nif (ptr > bufptr + size)\r\nreturn -EINVAL;\r\nret = i2c_transfer(client->adapter, &msg, 1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "i2c write error: %d", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int parse_and_apply(struct i2c_client *client, uint8_t *buffer,\r\nunsigned int size)\r\n{\r\nuint8_t *endptr8 = buffer + size;\r\nstruct tbd_data_record_header *header =\r\n(struct tbd_data_record_header *)buffer;\r\nunsigned int dataset = 0;\r\ndo {\r\nif ((uint8_t *)header + sizeof(*header) > endptr8)\r\nreturn -EINVAL;\r\nif ((uint8_t *)header + header->data_offset +\r\nheader->data_size > endptr8)\r\nreturn -EINVAL;\r\ndataset++;\r\nif (header->data_size && (header->flags & 1)) {\r\nint ret;\r\ndev_info(&client->dev,\r\n"New MSR data for sensor driver (dataset %02d) size:%d\n",\r\ndataset, header->data_size);\r\nret = set_msr_configuration(client,\r\nbuffer + header->data_offset,\r\nheader->data_size);\r\nif (ret)\r\nreturn ret;\r\n}\r\nheader = (struct tbd_data_record_header *)(buffer +\r\nheader->next_offset);\r\n} while (header->next_offset);\r\nreturn 0;\r\n}\r\nint apply_msr_data(struct i2c_client *client, const struct firmware *fw)\r\n{\r\nstruct tbd_header *header;\r\nstruct tbd_record_header *record;\r\nif (!fw) {\r\ndev_warn(&client->dev, "Drv data is not loaded.\n");\r\nreturn -EINVAL;\r\n}\r\nif (sizeof(*header) > fw->size)\r\nreturn -EINVAL;\r\nheader = (struct tbd_header *)fw->data;\r\nif (memcmp(&header->tag, "DRVB", 4))\r\nreturn -EINVAL;\r\nif (header->size != fw->size)\r\nreturn -EINVAL;\r\nif (sizeof(*header) + sizeof(*record) > fw->size)\r\nreturn -EINVAL;\r\nrecord = (struct tbd_record_header *)(header + 1);\r\nif (record->class_id != TBD_CLASS_DRV_ID)\r\nreturn -EINVAL;\r\nif (!record->size)\r\nreturn 0;\r\nreturn parse_and_apply(client, (uint8_t *)(record + 1), record->size);\r\n}\r\nint load_msr_list(struct i2c_client *client, char *name,\r\nconst struct firmware **fw)\r\n{\r\nint ret = request_firmware(fw, name, &client->dev);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"Error %d while requesting firmware %s\n",\r\nret, name);\r\nreturn ret;\r\n}\r\ndev_info(&client->dev, "Received %lu bytes drv data\n",\r\n(unsigned long)(*fw)->size);\r\nreturn 0;\r\n}\r\nvoid release_msr_list(struct i2c_client *client, const struct firmware *fw)\r\n{\r\nrelease_firmware(fw);\r\n}\r\nstatic int init_msrlisthelper(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void exit_msrlisthelper(void)\r\n{\r\n}

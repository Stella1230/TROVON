static int init_display(struct fbtft_par *par)\r\n{\r\nif (par->pdata &&\r\npar->pdata->display.backlight == FBTFT_ONBOARD_BACKLIGHT) {\r\npar->fbtftops.register_backlight = register_onboard_backlight;\r\n}\r\npar->fbtftops.reset(par);\r\nwrite_reg(par, 0xfd, 0x12);\r\nwrite_reg(par, 0xfd, 0xb1);\r\nwrite_reg(par, 0xae);\r\nwrite_reg(par, 0xb3, 0xf1);\r\nwrite_reg(par, 0xca, 0x7f);\r\nwrite_reg(par, 0x15, 0x00, 0x7f);\r\nwrite_reg(par, 0x75, 0x00, 0x7f);\r\nwrite_reg(par, 0xa1, 0x00);\r\nwrite_reg(par, 0xa2, 0x00);\r\nwrite_reg(par, 0xb5, 0x00);\r\nwrite_reg(par, 0xab, 0x01);\r\nwrite_reg(par, 0xb1, 0x32);\r\nwrite_reg(par, 0xb4, 0xa0, 0xb5, 0x55);\r\nwrite_reg(par, 0xbb, 0x17);\r\nwrite_reg(par, 0xbe, 0x05);\r\nwrite_reg(par, 0xc1, 0xc8, 0x80, 0xc8);\r\nwrite_reg(par, 0xc7, 0x0f);\r\nwrite_reg(par, 0xb6, 0x01);\r\nwrite_reg(par, 0xa6);\r\nwrite_reg(par, 0xaf);\r\nreturn 0;\r\n}\r\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\r\n{\r\nwrite_reg(par, 0x15, xs, xe);\r\nwrite_reg(par, 0x75, ys, ye);\r\nwrite_reg(par, 0x5c);\r\n}\r\nstatic int set_var(struct fbtft_par *par)\r\n{\r\nunsigned int remap;\r\nif (par->fbtftops.init_display != init_display) {\r\nfbtft_par_dbg(DEBUG_INIT_DISPLAY, par,\r\n"%s: skipping since custom init_display() is used\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nremap = 0x60 | (par->bgr << 2);\r\nswitch (par->info->var.rotate) {\r\ncase 0:\r\nwrite_reg(par, 0xA0, remap | 0x00 | 1 << 4);\r\nbreak;\r\ncase 270:\r\nwrite_reg(par, 0xA0, remap | 0x03 | 1 << 4);\r\nbreak;\r\ncase 180:\r\nwrite_reg(par, 0xA0, remap | 0x02);\r\nbreak;\r\ncase 90:\r\nwrite_reg(par, 0xA0, remap | 0x01);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\r\n{\r\nunsigned long tmp[GAMMA_NUM * GAMMA_LEN];\r\nint i, acc = 0;\r\nfor (i = 0; i < 63; i++) {\r\nif (i > 0 && curves[i] < 2) {\r\ndev_err(par->info->device,\r\n"Illegal value in Grayscale Lookup Table at index %d. " \\r\n"Must be greater than 1\n", i);\r\nreturn -EINVAL;\r\n}\r\nacc += curves[i];\r\ntmp[i] = acc;\r\nif (acc > 180) {\r\ndev_err(par->info->device,\r\n"Illegal value(s) in Grayscale Lookup Table. " \\r\n"At index=%d, the accumulated value has exceeded 180\n", i);\r\nreturn -EINVAL;\r\n}\r\n}\r\nwrite_reg(par, 0xB8,\r\ntmp[0], tmp[1], tmp[2], tmp[3], tmp[4], tmp[5], tmp[6], tmp[7],\r\ntmp[8], tmp[9], tmp[10], tmp[11], tmp[12], tmp[13], tmp[14], tmp[15],\r\ntmp[16], tmp[17], tmp[18], tmp[19], tmp[20], tmp[21], tmp[22], tmp[23],\r\ntmp[24], tmp[25], tmp[26], tmp[27], tmp[28], tmp[29], tmp[30], tmp[31],\r\ntmp[32], tmp[33], tmp[34], tmp[35], tmp[36], tmp[37], tmp[38], tmp[39],\r\ntmp[40], tmp[41], tmp[42], tmp[43], tmp[44], tmp[45], tmp[46], tmp[47],\r\ntmp[48], tmp[49], tmp[50], tmp[51], tmp[52], tmp[53], tmp[54], tmp[55],\r\ntmp[56], tmp[57], tmp[58], tmp[59], tmp[60], tmp[61], tmp[62]);\r\nreturn 0;\r\n}\r\nstatic int blank(struct fbtft_par *par, bool on)\r\n{\r\nfbtft_par_dbg(DEBUG_BLANK, par, "%s(blank=%s)\n",\r\n__func__, on ? "true" : "false");\r\nif (on)\r\nwrite_reg(par, 0xAE);\r\nelse\r\nwrite_reg(par, 0xAF);\r\nreturn 0;\r\n}\r\nstatic int update_onboard_backlight(struct backlight_device *bd)\r\n{\r\nstruct fbtft_par *par = bl_get_data(bd);\r\nbool on;\r\nfbtft_par_dbg(DEBUG_BACKLIGHT, par,\r\n"%s: power=%d, fb_blank=%d\n",\r\n__func__, bd->props.power, bd->props.fb_blank);\r\non = (bd->props.power == FB_BLANK_UNBLANK) &&\r\n(bd->props.fb_blank == FB_BLANK_UNBLANK);\r\nwrite_reg(par, 0xB5, on ? 0x03 : 0x02);\r\nreturn 0;\r\n}\r\nstatic void register_onboard_backlight(struct fbtft_par *par)\r\n{\r\nstruct backlight_device *bd;\r\nstruct backlight_properties bl_props = { 0, };\r\nbl_props.type = BACKLIGHT_RAW;\r\nbl_props.power = FB_BLANK_POWERDOWN;\r\nbd = backlight_device_register(dev_driver_string(par->info->device),\r\npar->info->device, par, &bl_ops, &bl_props);\r\nif (IS_ERR(bd)) {\r\ndev_err(par->info->device,\r\n"cannot register backlight device (%ld)\n",\r\nPTR_ERR(bd));\r\nreturn;\r\n}\r\npar->info->bl_dev = bd;\r\nif (!par->fbtftops.unregister_backlight)\r\npar->fbtftops.unregister_backlight = fbtft_unregister_backlight;\r\n}\r\nstatic void register_onboard_backlight(struct fbtft_par *par) { }

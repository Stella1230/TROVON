static unsigned int xmdio_read(void *ioaddr, unsigned int mmd,\r\nunsigned int reg)\r\n{\r\nunsigned int mmd_address, value;\r\nmmd_address = (mmd << 16) | ((reg) & 0xffff);\r\niowrite32(mmd_address >> 8, ioaddr + (PCS_MMD_SELECT << 2));\r\nvalue = ioread32(ioaddr + ((mmd_address & 0xff) << 2));\r\nreturn value;\r\n}\r\nstatic void xmdio_write(void *ioaddr, unsigned int mmd,\r\nunsigned int reg, unsigned int value)\r\n{\r\nunsigned int mmd_address;\r\nmmd_address = (mmd << 16) | ((reg) & 0xffff);\r\niowrite32(mmd_address >> 8, ioaddr + (PCS_MMD_SELECT << 2));\r\niowrite32(value, ioaddr + ((mmd_address & 0xff) << 2));\r\n}\r\nstatic int vfio_platform_amdxgbe_reset(struct vfio_platform_device *vdev)\r\n{\r\nstruct vfio_platform_region *xgmac_regs = &vdev->regions[0];\r\nstruct vfio_platform_region *xpcs_regs = &vdev->regions[1];\r\nu32 dma_mr_value, pcs_value, value;\r\nunsigned int count;\r\nif (!xgmac_regs->ioaddr) {\r\nxgmac_regs->ioaddr =\r\nioremap_nocache(xgmac_regs->addr, xgmac_regs->size);\r\nif (!xgmac_regs->ioaddr)\r\nreturn -ENOMEM;\r\n}\r\nif (!xpcs_regs->ioaddr) {\r\nxpcs_regs->ioaddr =\r\nioremap_nocache(xpcs_regs->addr, xpcs_regs->size);\r\nif (!xpcs_regs->ioaddr)\r\nreturn -ENOMEM;\r\n}\r\npcs_value = xmdio_read(xpcs_regs->ioaddr, MDIO_MMD_PCS, MDIO_CTRL1);\r\npcs_value |= MDIO_CTRL1_RESET;\r\nxmdio_write(xpcs_regs->ioaddr, MDIO_MMD_PCS, MDIO_CTRL1, pcs_value);\r\ncount = 50;\r\ndo {\r\nmsleep(20);\r\npcs_value = xmdio_read(xpcs_regs->ioaddr, MDIO_MMD_PCS,\r\nMDIO_CTRL1);\r\n} while ((pcs_value & MDIO_CTRL1_RESET) && --count);\r\nif (pcs_value & MDIO_CTRL1_RESET)\r\npr_warn("%s XGBE PHY reset timeout\n", __func__);\r\nvalue = xmdio_read(xpcs_regs->ioaddr, MDIO_MMD_AN, MDIO_CTRL1);\r\nvalue &= ~MDIO_AN_CTRL1_ENABLE;\r\nxmdio_write(xpcs_regs->ioaddr, MDIO_MMD_AN, MDIO_CTRL1, value);\r\nxmdio_write(xpcs_regs->ioaddr, MDIO_MMD_AN, MDIO_AN_INTMASK, 0);\r\nxmdio_write(xpcs_regs->ioaddr, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\ndma_mr_value = ioread32(xgmac_regs->ioaddr + DMA_MR);\r\ndma_mr_value |= 0x1;\r\niowrite32(dma_mr_value, xgmac_regs->ioaddr + DMA_MR);\r\nusleep_range(10, 15);\r\ncount = 2000;\r\nwhile (--count && (ioread32(xgmac_regs->ioaddr + DMA_MR) & 1))\r\nusleep_range(500, 600);\r\nif (!count)\r\npr_warn("%s MAC SW reset failed\n", __func__);\r\nreturn 0;\r\n}

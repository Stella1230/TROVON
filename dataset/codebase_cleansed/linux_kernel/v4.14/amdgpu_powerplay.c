static int amdgpu_create_pp_handle(struct amdgpu_device *adev)\r\n{\r\nstruct amd_pp_init pp_init;\r\nstruct amd_powerplay *amd_pp;\r\nint ret;\r\namd_pp = &(adev->powerplay);\r\npp_init.chip_family = adev->family;\r\npp_init.chip_id = adev->asic_type;\r\npp_init.pm_en = (amdgpu_dpm != 0 && !amdgpu_sriov_vf(adev)) ? true : false;\r\npp_init.feature_mask = amdgpu_pp_feature_mask;\r\npp_init.device = amdgpu_cgs_create_device(adev);\r\nret = amd_powerplay_create(&pp_init, &(amd_pp->pp_handle));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int amdgpu_pp_early_init(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nstruct amd_powerplay *amd_pp;\r\nint ret = 0;\r\namd_pp = &(adev->powerplay);\r\nadev->pp_enabled = false;\r\namd_pp->pp_handle = (void *)adev;\r\nswitch (adev->asic_type) {\r\ncase CHIP_POLARIS11:\r\ncase CHIP_POLARIS10:\r\ncase CHIP_POLARIS12:\r\ncase CHIP_TONGA:\r\ncase CHIP_FIJI:\r\ncase CHIP_TOPAZ:\r\ncase CHIP_CARRIZO:\r\ncase CHIP_STONEY:\r\ncase CHIP_VEGA10:\r\ncase CHIP_RAVEN:\r\nadev->pp_enabled = true;\r\nif (amdgpu_create_pp_handle(adev))\r\nreturn -EINVAL;\r\namd_pp->ip_funcs = &pp_ip_funcs;\r\namd_pp->pp_funcs = &pp_dpm_funcs;\r\nbreak;\r\n#ifdef CONFIG_DRM_AMDGPU_SI\r\ncase CHIP_TAHITI:\r\ncase CHIP_PITCAIRN:\r\ncase CHIP_VERDE:\r\ncase CHIP_OLAND:\r\ncase CHIP_HAINAN:\r\namd_pp->ip_funcs = &si_dpm_ip_funcs;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_DRM_AMDGPU_CIK\r\ncase CHIP_BONAIRE:\r\ncase CHIP_HAWAII:\r\namd_pp->ip_funcs = &ci_dpm_ip_funcs;\r\nbreak;\r\ncase CHIP_KABINI:\r\ncase CHIP_MULLINS:\r\ncase CHIP_KAVERI:\r\namd_pp->ip_funcs = &kv_dpm_ip_funcs;\r\nbreak;\r\n#endif\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (adev->powerplay.ip_funcs->early_init)\r\nret = adev->powerplay.ip_funcs->early_init(\r\nadev->powerplay.pp_handle);\r\nif (ret == PP_DPM_DISABLED) {\r\nadev->pm.dpm_enabled = false;\r\nreturn 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_late_init(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->late_init)\r\nret = adev->powerplay.ip_funcs->late_init(\r\nadev->powerplay.pp_handle);\r\nif (adev->pp_enabled && adev->pm.dpm_enabled) {\r\namdgpu_pm_sysfs_init(adev);\r\namdgpu_dpm_dispatch_task(adev, AMD_PP_EVENT_COMPLETE_INIT, NULL, NULL);\r\n}\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_sw_init(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->sw_init)\r\nret = adev->powerplay.ip_funcs->sw_init(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_sw_fini(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->sw_fini)\r\nret = adev->powerplay.ip_funcs->sw_fini(\r\nadev->powerplay.pp_handle);\r\nif (ret)\r\nreturn ret;\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_hw_init(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->pp_enabled && adev->firmware.load_type == AMDGPU_FW_LOAD_SMU)\r\namdgpu_ucode_init_bo(adev);\r\nif (adev->powerplay.ip_funcs->hw_init)\r\nret = adev->powerplay.ip_funcs->hw_init(\r\nadev->powerplay.pp_handle);\r\nif (ret == PP_DPM_DISABLED) {\r\nadev->pm.dpm_enabled = false;\r\nreturn 0;\r\n}\r\nif ((amdgpu_dpm != 0) && !amdgpu_sriov_vf(adev))\r\nadev->pm.dpm_enabled = true;\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_hw_fini(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->pp_enabled && adev->pm.dpm_enabled)\r\namdgpu_pm_sysfs_fini(adev);\r\nif (adev->powerplay.ip_funcs->hw_fini)\r\nret = adev->powerplay.ip_funcs->hw_fini(\r\nadev->powerplay.pp_handle);\r\nif (adev->pp_enabled && adev->firmware.load_type == AMDGPU_FW_LOAD_SMU)\r\namdgpu_ucode_fini_bo(adev);\r\nreturn ret;\r\n}\r\nstatic void amdgpu_pp_late_fini(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->late_fini)\r\nadev->powerplay.ip_funcs->late_fini(\r\nadev->powerplay.pp_handle);\r\nif (adev->pp_enabled)\r\namd_powerplay_destroy(adev->powerplay.pp_handle);\r\n}\r\nstatic int amdgpu_pp_suspend(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->suspend)\r\nret = adev->powerplay.ip_funcs->suspend(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_resume(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->resume)\r\nret = adev->powerplay.ip_funcs->resume(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_set_clockgating_state(void *handle,\r\nenum amd_clockgating_state state)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->set_clockgating_state)\r\nret = adev->powerplay.ip_funcs->set_clockgating_state(\r\nadev->powerplay.pp_handle, state);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_set_powergating_state(void *handle,\r\nenum amd_powergating_state state)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->set_powergating_state)\r\nret = adev->powerplay.ip_funcs->set_powergating_state(\r\nadev->powerplay.pp_handle, state);\r\nreturn ret;\r\n}\r\nstatic bool amdgpu_pp_is_idle(void *handle)\r\n{\r\nbool ret = true;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->is_idle)\r\nret = adev->powerplay.ip_funcs->is_idle(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_wait_for_idle(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->wait_for_idle)\r\nret = adev->powerplay.ip_funcs->wait_for_idle(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}\r\nstatic int amdgpu_pp_soft_reset(void *handle)\r\n{\r\nint ret = 0;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nif (adev->powerplay.ip_funcs->soft_reset)\r\nret = adev->powerplay.ip_funcs->soft_reset(\r\nadev->powerplay.pp_handle);\r\nreturn ret;\r\n}

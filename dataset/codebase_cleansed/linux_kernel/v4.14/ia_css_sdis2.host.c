static void\r\nfill_row(short *private, const short *public, unsigned width, unsigned padding)\r\n{\r\nmemcpy (private, public, width*sizeof(short));\r\nmemset (&private[width], 0, padding*sizeof(short));\r\n}\r\nvoid ia_css_sdis2_horicoef_vmem_encode (\r\nstruct sh_css_isp_sdis_hori_coef_tbl *to,\r\nconst struct ia_css_dvs2_coefficients *from,\r\nunsigned size)\r\n{\r\nunsigned aligned_width = from->grid.aligned_width * from->grid.bqs_per_grid_cell;\r\nunsigned width = from->grid.num_hor_coefs;\r\nint padding = aligned_width-width;\r\nunsigned stride = size/IA_CSS_DVS2_NUM_COEF_TYPES/sizeof(short);\r\nunsigned total_bytes = aligned_width*IA_CSS_DVS2_NUM_COEF_TYPES*sizeof(short);\r\nshort *private = (short*)to;\r\nassert(padding >= 0);\r\nassert(total_bytes <= size);\r\nassert(size % (IA_CSS_DVS2_NUM_COEF_TYPES*ISP_VEC_NELEMS*sizeof(short)) == 0);\r\nfill_row(&private[0*stride], from->hor_coefs.odd_real, width, padding);\r\nfill_row(&private[1*stride], from->hor_coefs.odd_imag, width, padding);\r\nfill_row(&private[2*stride], from->hor_coefs.even_real, width, padding);\r\nfill_row(&private[3*stride], from->hor_coefs.even_imag, width, padding);\r\n}\r\nvoid ia_css_sdis2_vertcoef_vmem_encode (\r\nstruct sh_css_isp_sdis_vert_coef_tbl *to,\r\nconst struct ia_css_dvs2_coefficients *from,\r\nunsigned size)\r\n{\r\nunsigned aligned_height = from->grid.aligned_height * from->grid.bqs_per_grid_cell;\r\nunsigned height = from->grid.num_ver_coefs;\r\nint padding = aligned_height-height;\r\nunsigned stride = size/IA_CSS_DVS2_NUM_COEF_TYPES/sizeof(short);\r\nunsigned total_bytes = aligned_height*IA_CSS_DVS2_NUM_COEF_TYPES*sizeof(short);\r\nshort *private = (short*)to;\r\nassert(padding >= 0);\r\nassert(total_bytes <= size);\r\nassert(size % (IA_CSS_DVS2_NUM_COEF_TYPES*ISP_VEC_NELEMS*sizeof(short)) == 0);\r\nfill_row(&private[0*stride], from->ver_coefs.odd_real, height, padding);\r\nfill_row(&private[1*stride], from->ver_coefs.odd_imag, height, padding);\r\nfill_row(&private[2*stride], from->ver_coefs.even_real, height, padding);\r\nfill_row(&private[3*stride], from->ver_coefs.even_imag, height, padding);\r\n}\r\nvoid ia_css_sdis2_horiproj_encode (\r\nstruct sh_css_isp_sdis_hori_proj_tbl *to,\r\nconst struct ia_css_dvs2_coefficients *from,\r\nunsigned size)\r\n{\r\n(void)to;\r\n(void)from;\r\n(void)size;\r\n}\r\nvoid ia_css_sdis2_vertproj_encode (\r\nstruct sh_css_isp_sdis_vert_proj_tbl *to,\r\nconst struct ia_css_dvs2_coefficients *from,\r\nunsigned size)\r\n{\r\n(void)to;\r\n(void)from;\r\n(void)size;\r\n}\r\nvoid ia_css_get_isp_dvs2_coefficients(\r\nstruct ia_css_stream *stream,\r\nshort *hor_coefs_odd_real,\r\nshort *hor_coefs_odd_imag,\r\nshort *hor_coefs_even_real,\r\nshort *hor_coefs_even_imag,\r\nshort *ver_coefs_odd_real,\r\nshort *ver_coefs_odd_imag,\r\nshort *ver_coefs_even_real,\r\nshort *ver_coefs_even_imag)\r\n{\r\nstruct ia_css_isp_parameters *params;\r\nunsigned int hor_num_3a, ver_num_3a;\r\nunsigned int hor_num_isp, ver_num_isp;\r\nstruct ia_css_binary *dvs_binary;\r\nIA_CSS_ENTER("void");\r\nassert(stream != NULL);\r\nassert(hor_coefs_odd_real != NULL);\r\nassert(hor_coefs_odd_imag != NULL);\r\nassert(hor_coefs_even_real != NULL);\r\nassert(hor_coefs_even_imag != NULL);\r\nassert(ver_coefs_odd_real != NULL);\r\nassert(ver_coefs_odd_imag != NULL);\r\nassert(ver_coefs_even_real != NULL);\r\nassert(ver_coefs_even_imag != NULL);\r\nparams = stream->isp_params_configs;\r\ndvs_binary = ia_css_stream_get_dvs_binary(stream);\r\nif (!dvs_binary)\r\nreturn;\r\nhor_num_3a = dvs_binary->dis.coef.dim.width;\r\nver_num_3a = dvs_binary->dis.coef.dim.height;\r\nhor_num_isp = dvs_binary->dis.coef.pad.width;\r\nver_num_isp = dvs_binary->dis.coef.pad.height;\r\nmemcpy (hor_coefs_odd_real, params->dvs2_coefs.hor_coefs.odd_real, hor_num_3a * sizeof(short));\r\nmemcpy (hor_coefs_odd_imag, params->dvs2_coefs.hor_coefs.odd_imag, hor_num_3a * sizeof(short));\r\nmemcpy (hor_coefs_even_real, params->dvs2_coefs.hor_coefs.even_real, hor_num_3a * sizeof(short));\r\nmemcpy (hor_coefs_even_imag, params->dvs2_coefs.hor_coefs.even_imag, hor_num_3a * sizeof(short));\r\nmemcpy (ver_coefs_odd_real, params->dvs2_coefs.ver_coefs.odd_real, ver_num_3a * sizeof(short));\r\nmemcpy (ver_coefs_odd_imag, params->dvs2_coefs.ver_coefs.odd_imag, ver_num_3a * sizeof(short));\r\nmemcpy (ver_coefs_even_real, params->dvs2_coefs.ver_coefs.even_real, ver_num_3a * sizeof(short));\r\nmemcpy (ver_coefs_even_imag, params->dvs2_coefs.ver_coefs.even_imag, ver_num_3a * sizeof(short));\r\nIA_CSS_LEAVE("void");\r\n}\r\nvoid ia_css_sdis2_clear_coefficients(\r\nstruct ia_css_dvs2_coefficients *dvs2_coefs)\r\n{\r\ndvs2_coefs->hor_coefs.odd_real = NULL;\r\ndvs2_coefs->hor_coefs.odd_imag = NULL;\r\ndvs2_coefs->hor_coefs.even_real = NULL;\r\ndvs2_coefs->hor_coefs.even_imag = NULL;\r\ndvs2_coefs->ver_coefs.odd_real = NULL;\r\ndvs2_coefs->ver_coefs.odd_imag = NULL;\r\ndvs2_coefs->ver_coefs.even_real = NULL;\r\ndvs2_coefs->ver_coefs.even_imag = NULL;\r\n}\r\nenum ia_css_err\r\nia_css_get_dvs2_statistics(\r\nstruct ia_css_dvs2_statistics *host_stats,\r\nconst struct ia_css_isp_dvs_statistics *isp_stats)\r\n{\r\nstruct ia_css_isp_dvs_statistics_map *map;\r\nenum ia_css_err ret = IA_CSS_SUCCESS;\r\nIA_CSS_ENTER("host_stats=%p, isp_stats=%p", host_stats, isp_stats);\r\nassert(host_stats != NULL);\r\nassert(isp_stats != NULL);\r\nmap = ia_css_isp_dvs_statistics_map_allocate(isp_stats, NULL);\r\nif (map) {\r\nmmgr_load(isp_stats->data_ptr, map->data_ptr, isp_stats->size);\r\nia_css_translate_dvs2_statistics(host_stats, map);\r\nia_css_isp_dvs_statistics_map_free(map);\r\n} else {\r\nIA_CSS_ERROR("out of memory");\r\nret = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nIA_CSS_LEAVE_ERR(ret);\r\nreturn ret;\r\n}\r\nvoid\r\nia_css_translate_dvs2_statistics(\r\nstruct ia_css_dvs2_statistics *host_stats,\r\nconst struct ia_css_isp_dvs_statistics_map *isp_stats)\r\n{\r\nunsigned int size_bytes, table_width, table_size, height;\r\nunsigned int src_offset = 0, dst_offset = 0;\r\nint32_t *htemp_ptr, *vtemp_ptr;\r\nassert(host_stats != NULL);\r\nassert(host_stats->hor_prod.odd_real != NULL);\r\nassert(host_stats->hor_prod.odd_imag != NULL);\r\nassert(host_stats->hor_prod.even_real != NULL);\r\nassert(host_stats->hor_prod.even_imag != NULL);\r\nassert(host_stats->ver_prod.odd_real != NULL);\r\nassert(host_stats->ver_prod.odd_imag != NULL);\r\nassert(host_stats->ver_prod.even_real != NULL);\r\nassert(host_stats->ver_prod.even_imag != NULL);\r\nassert(isp_stats != NULL);\r\nassert(isp_stats->hor_proj != NULL);\r\nassert(isp_stats->ver_proj != NULL);\r\nIA_CSS_ENTER("hor_coefs.odd_real=%p, hor_coefs.odd_imag=%p, "\r\n"hor_coefs.even_real=%p, hor_coefs.even_imag=%p, "\r\n"ver_coefs.odd_real=%p, ver_coefs.odd_imag=%p, "\r\n"ver_coefs.even_real=%p, ver_coefs.even_imag=%p, "\r\n"haddr=%p, vaddr=%p",\r\nhost_stats->hor_prod.odd_real, host_stats->hor_prod.odd_imag,\r\nhost_stats->hor_prod.even_real, host_stats->hor_prod.even_imag,\r\nhost_stats->ver_prod.odd_real, host_stats->ver_prod.odd_imag,\r\nhost_stats->ver_prod.even_real, host_stats->ver_prod.even_imag,\r\nisp_stats->hor_proj, isp_stats->ver_proj);\r\nsize_bytes = host_stats->grid.aligned_width * sizeof(*htemp_ptr);\r\ntable_width = CEIL_MUL(size_bytes, HIVE_ISP_DDR_WORD_BYTES) / sizeof(*htemp_ptr);\r\ntable_size = table_width * host_stats->grid.aligned_height;\r\nhtemp_ptr = isp_stats->hor_proj;\r\nvtemp_ptr = isp_stats->ver_proj;\r\nfor (height = 0; height < host_stats->grid.aligned_height; height++) {\r\nmemcpy(host_stats->hor_prod.odd_real + dst_offset,\r\n&htemp_ptr[0*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->hor_prod.odd_imag + dst_offset,\r\n&htemp_ptr[1*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->hor_prod.even_real + dst_offset,\r\n&htemp_ptr[2*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->hor_prod.even_imag + dst_offset,\r\n&htemp_ptr[3*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->ver_prod.odd_real + dst_offset,\r\n&vtemp_ptr[0*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->ver_prod.odd_imag + dst_offset,\r\n&vtemp_ptr[1*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->ver_prod.even_real + dst_offset,\r\n&vtemp_ptr[2*table_size+src_offset], size_bytes);\r\nmemcpy(host_stats->ver_prod.even_imag + dst_offset,\r\n&vtemp_ptr[3*table_size+src_offset], size_bytes);\r\nsrc_offset += table_width;\r\ndst_offset += host_stats->grid.aligned_width;\r\n}\r\nIA_CSS_LEAVE("void");\r\n}\r\nstruct ia_css_isp_dvs_statistics *\r\nia_css_isp_dvs2_statistics_allocate(\r\nconst struct ia_css_dvs_grid_info *grid)\r\n{\r\nstruct ia_css_isp_dvs_statistics *me;\r\nint size;\r\nassert(grid != NULL);\r\nIA_CSS_ENTER("grid=%p", grid);\r\nif (!grid->enable)\r\nreturn NULL;\r\nme = sh_css_calloc(1,sizeof(*me));\r\nif (!me)\r\ngoto err;\r\nsize = CEIL_MUL(sizeof(int) * grid->aligned_width, HIVE_ISP_DDR_WORD_BYTES)\r\n* grid->aligned_height * IA_CSS_DVS2_NUM_COEF_TYPES;\r\nme->size = 2*size;\r\nme->data_ptr = mmgr_malloc(me->size);\r\nif (me->data_ptr == mmgr_NULL)\r\ngoto err;\r\nme->hor_proj = me->data_ptr;\r\nme->hor_size = size;\r\nme->ver_proj = me->data_ptr + size;\r\nme->ver_size = size;\r\nIA_CSS_LEAVE("return=%p", me);\r\nreturn me;\r\nerr:\r\nia_css_isp_dvs2_statistics_free(me);\r\nIA_CSS_LEAVE("return=%p", NULL);\r\nreturn NULL;\r\n}\r\nvoid\r\nia_css_isp_dvs2_statistics_free(struct ia_css_isp_dvs_statistics *me)\r\n{\r\nif (me != NULL) {\r\nhmm_free(me->data_ptr);\r\nsh_css_free(me);\r\n}\r\n}\r\nvoid ia_css_sdis2_horicoef_debug_dtrace(\r\nconst struct ia_css_dvs2_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis2_vertcoef_debug_dtrace(\r\nconst struct ia_css_dvs2_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis2_horiproj_debug_dtrace(\r\nconst struct ia_css_dvs2_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}\r\nvoid ia_css_sdis2_vertproj_debug_dtrace(\r\nconst struct ia_css_dvs2_coefficients *config, unsigned level)\r\n{\r\n(void)config;\r\n(void)level;\r\n}

static void\r\nnv50_dac_clock(struct nvkm_ior *dac)\r\n{\r\nstruct nvkm_device *device = dac->disp->engine.subdev.device;\r\nconst u32 doff = nv50_ior_base(dac);\r\nnvkm_mask(device, 0x614280 + doff, 0x07070707, 0x00000000);\r\n}\r\nint\r\nnv50_dac_sense(struct nvkm_ior *dac, u32 loadval)\r\n{\r\nstruct nvkm_device *device = dac->disp->engine.subdev.device;\r\nconst u32 doff = nv50_ior_base(dac);\r\ndac->func->power(dac, false, true, false, false, false);\r\nnvkm_wr32(device, 0x61a00c + doff, 0x00100000 | loadval);\r\nmdelay(9);\r\nudelay(500);\r\nloadval = nvkm_mask(device, 0x61a00c + doff, 0xffffffff, 0x00000000);\r\ndac->func->power(dac, false, false, false, false, false);\r\nif (!(loadval & 0x80000000))\r\nreturn -ETIMEDOUT;\r\nreturn (loadval & 0x38000000) >> 27;\r\n}\r\nstatic void\r\nnv50_dac_power_wait(struct nvkm_device *device, const u32 doff)\r\n{\r\nnvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x61a004 + doff) & 0x80000000))\r\nbreak;\r\n);\r\n}\r\nvoid\r\nnv50_dac_power(struct nvkm_ior *dac, bool normal, bool pu,\r\nbool data, bool vsync, bool hsync)\r\n{\r\nstruct nvkm_device *device = dac->disp->engine.subdev.device;\r\nconst u32 doff = nv50_ior_base(dac);\r\nconst u32 shift = normal ? 0 : 16;\r\nconst u32 state = 0x80000000 | (0x00000040 * ! pu |\r\n0x00000010 * ! data |\r\n0x00000004 * ! vsync |\r\n0x00000001 * ! hsync) << shift;\r\nconst u32 field = 0xc0000000 | (0x00000055 << shift);\r\nnv50_dac_power_wait(device, doff);\r\nnvkm_mask(device, 0x61a004 + doff, field, state);\r\nnv50_dac_power_wait(device, doff);\r\n}\r\nstatic void\r\nnv50_dac_state(struct nvkm_ior *dac, struct nvkm_ior_state *state)\r\n{\r\nstruct nvkm_device *device = dac->disp->engine.subdev.device;\r\nconst u32 coff = dac->id * 8 + (state == &dac->arm) * 4;\r\nu32 ctrl = nvkm_rd32(device, 0x610b58 + coff);\r\nstate->proto_evo = (ctrl & 0x00000f00) >> 8;\r\nswitch (state->proto_evo) {\r\ncase 0: state->proto = CRT; break;\r\ndefault:\r\nstate->proto = UNKNOWN;\r\nbreak;\r\n}\r\nstate->head = ctrl & 0x00000003;\r\n}\r\nint\r\nnv50_dac_new(struct nvkm_disp *disp, int id)\r\n{\r\nstruct nvkm_device *device = disp->engine.subdev.device;\r\nif (!(nvkm_rd32(device, 0x610184) & (0x00100000 << id)))\r\nreturn 0;\r\nreturn nvkm_ior_new_(&nv50_dac, disp, DAC, id);\r\n}

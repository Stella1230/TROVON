static int bmp280_regmap_spi_write(void *context, const void *data,\r\nsize_t count)\r\n{\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 buf[2];\r\nmemcpy(buf, data, 2);\r\nbuf[0] &= ~0x80;\r\nreturn spi_write_then_read(spi, buf, 2, NULL, 0);\r\n}\r\nstatic int bmp280_regmap_spi_read(void *context, const void *reg,\r\nsize_t reg_size, void *val, size_t val_size)\r\n{\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nreturn spi_write_then_read(spi, reg, reg_size, val, val_size);\r\n}\r\nstatic int bmp280_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nstruct regmap *regmap;\r\nconst struct regmap_config *regmap_config;\r\nint ret;\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "spi_setup failed!\n");\r\nreturn ret;\r\n}\r\nswitch (id->driver_data) {\r\ncase BMP180_CHIP_ID:\r\nregmap_config = &bmp180_regmap_config;\r\nbreak;\r\ncase BMP280_CHIP_ID:\r\ncase BME280_CHIP_ID:\r\nregmap_config = &bmp280_regmap_config;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap = devm_regmap_init(&spi->dev,\r\n&bmp280_regmap_bus,\r\n&spi->dev,\r\nregmap_config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&spi->dev, "failed to allocate register map\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nreturn bmp280_common_probe(&spi->dev,\r\nregmap,\r\nid->driver_data,\r\nid->name,\r\nspi->irq);\r\n}\r\nstatic int bmp280_spi_remove(struct spi_device *spi)\r\n{\r\nreturn bmp280_common_remove(&spi->dev);\r\n}

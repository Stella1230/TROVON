static int ucsi_acpi_dsm(struct ucsi_acpi *ua, int func)\r\n{\r\nunion acpi_object *obj;\r\nobj = acpi_evaluate_dsm(ACPI_HANDLE(ua->dev), &ua->guid, 1, func,\r\nNULL);\r\nif (!obj) {\r\ndev_err(ua->dev, "%s: failed to evaluate _DSM %d\n",\r\n__func__, func);\r\nreturn -EIO;\r\n}\r\nACPI_FREE(obj);\r\nreturn 0;\r\n}\r\nstatic int ucsi_acpi_cmd(struct ucsi_ppm *ppm, struct ucsi_control *ctrl)\r\n{\r\nstruct ucsi_acpi *ua = container_of(ppm, struct ucsi_acpi, ppm);\r\nppm->data->ctrl.raw_cmd = ctrl->raw_cmd;\r\nreturn ucsi_acpi_dsm(ua, UCSI_DSM_FUNC_WRITE);\r\n}\r\nstatic int ucsi_acpi_sync(struct ucsi_ppm *ppm)\r\n{\r\nstruct ucsi_acpi *ua = container_of(ppm, struct ucsi_acpi, ppm);\r\nreturn ucsi_acpi_dsm(ua, UCSI_DSM_FUNC_READ);\r\n}\r\nstatic void ucsi_acpi_notify(acpi_handle handle, u32 event, void *data)\r\n{\r\nstruct ucsi_acpi *ua = data;\r\nucsi_notify(ua->ucsi);\r\n}\r\nstatic int ucsi_acpi_probe(struct platform_device *pdev)\r\n{\r\nstruct ucsi_acpi *ua;\r\nstruct resource *res;\r\nacpi_status status;\r\nint ret;\r\nua = devm_kzalloc(&pdev->dev, sizeof(*ua), GFP_KERNEL);\r\nif (!ua)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "missing memory resource\n");\r\nreturn -ENODEV;\r\n}\r\nua->ppm.data = devm_ioremap(&pdev->dev, res->start, resource_size(res));\r\nif (!ua->ppm.data)\r\nreturn -ENOMEM;\r\nif (!ua->ppm.data->version)\r\nreturn -ENODEV;\r\nret = guid_parse(UCSI_DSM_UUID, &ua->guid);\r\nif (ret)\r\nreturn ret;\r\nua->ppm.cmd = ucsi_acpi_cmd;\r\nua->ppm.sync = ucsi_acpi_sync;\r\nua->dev = &pdev->dev;\r\nstatus = acpi_install_notify_handler(ACPI_HANDLE(&pdev->dev),\r\nACPI_DEVICE_NOTIFY,\r\nucsi_acpi_notify, ua);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(&pdev->dev, "failed to install notify handler\n");\r\nreturn -ENODEV;\r\n}\r\nua->ucsi = ucsi_register_ppm(&pdev->dev, &ua->ppm);\r\nif (IS_ERR(ua->ucsi)) {\r\nacpi_remove_notify_handler(ACPI_HANDLE(&pdev->dev),\r\nACPI_DEVICE_NOTIFY,\r\nucsi_acpi_notify);\r\nreturn PTR_ERR(ua->ucsi);\r\n}\r\nplatform_set_drvdata(pdev, ua);\r\nreturn 0;\r\n}\r\nstatic int ucsi_acpi_remove(struct platform_device *pdev)\r\n{\r\nstruct ucsi_acpi *ua = platform_get_drvdata(pdev);\r\nucsi_unregister_ppm(ua->ucsi);\r\nacpi_remove_notify_handler(ACPI_HANDLE(&pdev->dev), ACPI_DEVICE_NOTIFY,\r\nucsi_acpi_notify);\r\nreturn 0;\r\n}

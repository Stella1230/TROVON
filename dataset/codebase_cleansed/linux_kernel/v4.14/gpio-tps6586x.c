static int tps6586x_gpio_get(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct tps6586x_gpio *tps6586x_gpio = gpiochip_get_data(gc);\r\nuint8_t val;\r\nint ret;\r\nret = tps6586x_read(tps6586x_gpio->parent, TPS6586X_GPIOSET2, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(val & (1 << offset));\r\n}\r\nstatic void tps6586x_gpio_set(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nstruct tps6586x_gpio *tps6586x_gpio = gpiochip_get_data(gc);\r\ntps6586x_update(tps6586x_gpio->parent, TPS6586X_GPIOSET2,\r\nvalue << offset, 1 << offset);\r\n}\r\nstatic int tps6586x_gpio_output(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nstruct tps6586x_gpio *tps6586x_gpio = gpiochip_get_data(gc);\r\nuint8_t val, mask;\r\ntps6586x_gpio_set(gc, offset, value);\r\nval = 0x1 << (offset * 2);\r\nmask = 0x3 << (offset * 2);\r\nreturn tps6586x_update(tps6586x_gpio->parent, TPS6586X_GPIOSET1,\r\nval, mask);\r\n}\r\nstatic int tps6586x_gpio_to_irq(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct tps6586x_gpio *tps6586x_gpio = gpiochip_get_data(gc);\r\nreturn tps6586x_irq_get_virq(tps6586x_gpio->parent,\r\nTPS6586X_INT_PLDO_0 + offset);\r\n}\r\nstatic int tps6586x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct tps6586x_platform_data *pdata;\r\nstruct tps6586x_gpio *tps6586x_gpio;\r\nint ret;\r\npdata = dev_get_platdata(pdev->dev.parent);\r\ntps6586x_gpio = devm_kzalloc(&pdev->dev,\r\nsizeof(*tps6586x_gpio), GFP_KERNEL);\r\nif (!tps6586x_gpio)\r\nreturn -ENOMEM;\r\ntps6586x_gpio->parent = pdev->dev.parent;\r\ntps6586x_gpio->gpio_chip.owner = THIS_MODULE;\r\ntps6586x_gpio->gpio_chip.label = pdev->name;\r\ntps6586x_gpio->gpio_chip.parent = &pdev->dev;\r\ntps6586x_gpio->gpio_chip.ngpio = 4;\r\ntps6586x_gpio->gpio_chip.can_sleep = true;\r\ntps6586x_gpio->gpio_chip.direction_output = tps6586x_gpio_output;\r\ntps6586x_gpio->gpio_chip.set = tps6586x_gpio_set;\r\ntps6586x_gpio->gpio_chip.get = tps6586x_gpio_get;\r\ntps6586x_gpio->gpio_chip.to_irq = tps6586x_gpio_to_irq;\r\n#ifdef CONFIG_OF_GPIO\r\ntps6586x_gpio->gpio_chip.of_node = pdev->dev.parent->of_node;\r\n#endif\r\nif (pdata && pdata->gpio_base)\r\ntps6586x_gpio->gpio_chip.base = pdata->gpio_base;\r\nelse\r\ntps6586x_gpio->gpio_chip.base = -1;\r\nret = devm_gpiochip_add_data(&pdev->dev, &tps6586x_gpio->gpio_chip,\r\ntps6586x_gpio);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, tps6586x_gpio);\r\nreturn ret;\r\n}\r\nstatic int __init tps6586x_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&tps6586x_gpio_driver);\r\n}

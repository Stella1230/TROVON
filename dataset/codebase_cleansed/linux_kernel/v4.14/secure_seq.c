static __always_inline void net_secret_init(void)\r\n{\r\nnet_get_random_once(&net_secret, sizeof(net_secret));\r\n}\r\nstatic __always_inline void ts_secret_init(void)\r\n{\r\nnet_get_random_once(&ts_secret, sizeof(ts_secret));\r\n}\r\nstatic u32 seq_scale(u32 seq)\r\n{\r\nreturn seq + (ktime_get_real_ns() >> 6);\r\n}\r\nu32 secure_tcpv6_ts_off(const struct net *net,\r\nconst __be32 *saddr, const __be32 *daddr)\r\n{\r\nconst struct {\r\nstruct in6_addr saddr;\r\nstruct in6_addr daddr;\r\n} __aligned(SIPHASH_ALIGNMENT) combined = {\r\n.saddr = *(struct in6_addr *)saddr,\r\n.daddr = *(struct in6_addr *)daddr,\r\n};\r\nif (net->ipv4.sysctl_tcp_timestamps != 1)\r\nreturn 0;\r\nts_secret_init();\r\nreturn siphash(&combined, offsetofend(typeof(combined), daddr),\r\n&ts_secret);\r\n}\r\nu32 secure_tcpv6_seq(const __be32 *saddr, const __be32 *daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nconst struct {\r\nstruct in6_addr saddr;\r\nstruct in6_addr daddr;\r\n__be16 sport;\r\n__be16 dport;\r\n} __aligned(SIPHASH_ALIGNMENT) combined = {\r\n.saddr = *(struct in6_addr *)saddr,\r\n.daddr = *(struct in6_addr *)daddr,\r\n.sport = sport,\r\n.dport = dport\r\n};\r\nu32 hash;\r\nnet_secret_init();\r\nhash = siphash(&combined, offsetofend(typeof(combined), dport),\r\n&net_secret);\r\nreturn seq_scale(hash);\r\n}\r\nu32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,\r\n__be16 dport)\r\n{\r\nconst struct {\r\nstruct in6_addr saddr;\r\nstruct in6_addr daddr;\r\n__be16 dport;\r\n} __aligned(SIPHASH_ALIGNMENT) combined = {\r\n.saddr = *(struct in6_addr *)saddr,\r\n.daddr = *(struct in6_addr *)daddr,\r\n.dport = dport\r\n};\r\nnet_secret_init();\r\nreturn siphash(&combined, offsetofend(typeof(combined), dport),\r\n&net_secret);\r\n}\r\nu32 secure_tcp_ts_off(const struct net *net, __be32 saddr, __be32 daddr)\r\n{\r\nif (net->ipv4.sysctl_tcp_timestamps != 1)\r\nreturn 0;\r\nts_secret_init();\r\nreturn siphash_2u32((__force u32)saddr, (__force u32)daddr,\r\n&ts_secret);\r\n}\r\nu32 secure_tcp_seq(__be32 saddr, __be32 daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu32 hash;\r\nnet_secret_init();\r\nhash = siphash_3u32((__force u32)saddr, (__force u32)daddr,\r\n(__force u32)sport << 16 | (__force u32)dport,\r\n&net_secret);\r\nreturn seq_scale(hash);\r\n}\r\nu32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)\r\n{\r\nnet_secret_init();\r\nreturn siphash_3u32((__force u32)saddr, (__force u32)daddr,\r\n(__force u16)dport, &net_secret);\r\n}\r\nu64 secure_dccp_sequence_number(__be32 saddr, __be32 daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu64 seq;\r\nnet_secret_init();\r\nseq = siphash_3u32((__force u32)saddr, (__force u32)daddr,\r\n(__force u32)sport << 16 | (__force u32)dport,\r\n&net_secret);\r\nseq += ktime_get_real_ns();\r\nseq &= (1ull << 48) - 1;\r\nreturn seq;\r\n}\r\nu64 secure_dccpv6_sequence_number(__be32 *saddr, __be32 *daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nconst struct {\r\nstruct in6_addr saddr;\r\nstruct in6_addr daddr;\r\n__be16 sport;\r\n__be16 dport;\r\n} __aligned(SIPHASH_ALIGNMENT) combined = {\r\n.saddr = *(struct in6_addr *)saddr,\r\n.daddr = *(struct in6_addr *)daddr,\r\n.sport = sport,\r\n.dport = dport\r\n};\r\nu64 seq;\r\nnet_secret_init();\r\nseq = siphash(&combined, offsetofend(typeof(combined), dport),\r\n&net_secret);\r\nseq += ktime_get_real_ns();\r\nseq &= (1ull << 48) - 1;\r\nreturn seq;\r\n}

static void mmc_pwrseq_simple_set_gpios_value(struct mmc_pwrseq_simple *pwrseq,\r\nint value)\r\n{\r\nstruct gpio_descs *reset_gpios = pwrseq->reset_gpios;\r\nif (!IS_ERR(reset_gpios)) {\r\nint i;\r\nint values[reset_gpios->ndescs];\r\nfor (i = 0; i < reset_gpios->ndescs; i++)\r\nvalues[i] = value;\r\ngpiod_set_array_value_cansleep(\r\nreset_gpios->ndescs, reset_gpios->desc, values);\r\n}\r\n}\r\nstatic void mmc_pwrseq_simple_pre_power_on(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = to_pwrseq_simple(host->pwrseq);\r\nif (!IS_ERR(pwrseq->ext_clk) && !pwrseq->clk_enabled) {\r\nclk_prepare_enable(pwrseq->ext_clk);\r\npwrseq->clk_enabled = true;\r\n}\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 1);\r\n}\r\nstatic void mmc_pwrseq_simple_post_power_on(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = to_pwrseq_simple(host->pwrseq);\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 0);\r\nif (pwrseq->post_power_on_delay_ms)\r\nmsleep(pwrseq->post_power_on_delay_ms);\r\n}\r\nstatic void mmc_pwrseq_simple_power_off(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = to_pwrseq_simple(host->pwrseq);\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 1);\r\nif (pwrseq->power_off_delay_us)\r\nusleep_range(pwrseq->power_off_delay_us,\r\n2 * pwrseq->power_off_delay_us);\r\nif (!IS_ERR(pwrseq->ext_clk) && pwrseq->clk_enabled) {\r\nclk_disable_unprepare(pwrseq->ext_clk);\r\npwrseq->clk_enabled = false;\r\n}\r\n}\r\nstatic int mmc_pwrseq_simple_probe(struct platform_device *pdev)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq;\r\nstruct device *dev = &pdev->dev;\r\npwrseq = devm_kzalloc(dev, sizeof(*pwrseq), GFP_KERNEL);\r\nif (!pwrseq)\r\nreturn -ENOMEM;\r\npwrseq->ext_clk = devm_clk_get(dev, "ext_clock");\r\nif (IS_ERR(pwrseq->ext_clk) && PTR_ERR(pwrseq->ext_clk) != -ENOENT)\r\nreturn PTR_ERR(pwrseq->ext_clk);\r\npwrseq->reset_gpios = devm_gpiod_get_array(dev, "reset",\r\nGPIOD_OUT_HIGH);\r\nif (IS_ERR(pwrseq->reset_gpios) &&\r\nPTR_ERR(pwrseq->reset_gpios) != -ENOENT &&\r\nPTR_ERR(pwrseq->reset_gpios) != -ENOSYS) {\r\nreturn PTR_ERR(pwrseq->reset_gpios);\r\n}\r\ndevice_property_read_u32(dev, "post-power-on-delay-ms",\r\n&pwrseq->post_power_on_delay_ms);\r\ndevice_property_read_u32(dev, "power-off-delay-us",\r\n&pwrseq->power_off_delay_us);\r\npwrseq->pwrseq.dev = dev;\r\npwrseq->pwrseq.ops = &mmc_pwrseq_simple_ops;\r\npwrseq->pwrseq.owner = THIS_MODULE;\r\nplatform_set_drvdata(pdev, pwrseq);\r\nreturn mmc_pwrseq_register(&pwrseq->pwrseq);\r\n}\r\nstatic int mmc_pwrseq_simple_remove(struct platform_device *pdev)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = platform_get_drvdata(pdev);\r\nmmc_pwrseq_unregister(&pwrseq->pwrseq);\r\nreturn 0;\r\n}

static loff_t nvram_llseek(struct file *file, loff_t offset, int origin)\r\n{\r\nreturn generic_file_llseek_size(file, offset, origin,\r\nMAX_LFS_FILESIZE, nvram_len);\r\n}\r\nstatic ssize_t read_nvram(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nunsigned int i;\r\nchar __user *p = buf;\r\nif (!access_ok(VERIFY_WRITE, buf, count))\r\nreturn -EFAULT;\r\nif (*ppos >= nvram_len)\r\nreturn 0;\r\nfor (i = *ppos; count > 0 && i < nvram_len; ++i, ++p, --count)\r\nif (__put_user(nvram_read_byte(i), p))\r\nreturn -EFAULT;\r\n*ppos = i;\r\nreturn p - buf;\r\n}\r\nstatic ssize_t write_nvram(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nunsigned int i;\r\nconst char __user *p = buf;\r\nchar c;\r\nif (!access_ok(VERIFY_READ, buf, count))\r\nreturn -EFAULT;\r\nif (*ppos >= nvram_len)\r\nreturn 0;\r\nfor (i = *ppos; count > 0 && i < nvram_len; ++i, ++p, --count) {\r\nif (__get_user(c, p))\r\nreturn -EFAULT;\r\nnvram_write_byte(c, i);\r\n}\r\n*ppos = i;\r\nreturn p - buf;\r\n}\r\nstatic int nvram_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nswitch(cmd) {\r\n#ifdef CONFIG_PPC_PMAC\r\ncase OBSOLETE_PMAC_NVRAM_GET_OFFSET:\r\nprintk(KERN_WARNING "nvram: Using obsolete PMAC_NVRAM_GET_OFFSET ioctl\n");\r\ncase IOC_NVRAM_GET_OFFSET: {\r\nint part, offset;\r\nif (!machine_is(powermac))\r\nreturn -EINVAL;\r\nif (copy_from_user(&part, (void __user*)arg, sizeof(part)) != 0)\r\nreturn -EFAULT;\r\nif (part < pmac_nvram_OF || part > pmac_nvram_NR)\r\nreturn -EINVAL;\r\noffset = pmac_get_partition(part);\r\nif (copy_to_user((void __user*)arg, &offset, sizeof(offset)) != 0)\r\nreturn -EFAULT;\r\nbreak;\r\n}\r\n#endif\r\ncase IOC_NVRAM_SYNC:\r\nnvram_sync();\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic long nvram_unlocked_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint ret;\r\nmutex_lock(&nvram_mutex);\r\nret = nvram_ioctl(file, cmd, arg);\r\nmutex_unlock(&nvram_mutex);\r\nreturn ret;\r\n}\r\nint __init nvram_init(void)\r\n{\r\nint ret = 0;\r\nprintk(KERN_INFO "Generic non-volatile memory driver v%s\n",\r\nNVRAM_VERSION);\r\nret = misc_register(&nvram_dev);\r\nif (ret != 0)\r\ngoto out;\r\nnvram_len = nvram_get_size();\r\nif (nvram_len < 0)\r\nnvram_len = NVRAM_SIZE;\r\nout:\r\nreturn ret;\r\n}\r\nvoid __exit nvram_cleanup(void)\r\n{\r\nmisc_deregister( &nvram_dev );\r\n}

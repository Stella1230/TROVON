static int ghash_init(struct shash_desc *desc)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nstruct ghash_ctx *ctx = crypto_shash_ctx(desc->tfm);\r\nmemset(dctx, 0, sizeof(*dctx));\r\nmemcpy(dctx->key, ctx->key, GHASH_BLOCK_SIZE);\r\nreturn 0;\r\n}\r\nstatic int ghash_setkey(struct crypto_shash *tfm,\r\nconst u8 *key, unsigned int keylen)\r\n{\r\nstruct ghash_ctx *ctx = crypto_shash_ctx(tfm);\r\nif (keylen != GHASH_BLOCK_SIZE) {\r\ncrypto_shash_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, GHASH_BLOCK_SIZE);\r\nreturn 0;\r\n}\r\nstatic int ghash_update(struct shash_desc *desc,\r\nconst u8 *src, unsigned int srclen)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nunsigned int n;\r\nu8 *buf = dctx->buffer;\r\nif (dctx->bytes) {\r\nu8 *pos = buf + (GHASH_BLOCK_SIZE - dctx->bytes);\r\nn = min(srclen, dctx->bytes);\r\ndctx->bytes -= n;\r\nsrclen -= n;\r\nmemcpy(pos, src, n);\r\nsrc += n;\r\nif (!dctx->bytes) {\r\ncpacf_kimd(CPACF_KIMD_GHASH, dctx, buf,\r\nGHASH_BLOCK_SIZE);\r\n}\r\n}\r\nn = srclen & ~(GHASH_BLOCK_SIZE - 1);\r\nif (n) {\r\ncpacf_kimd(CPACF_KIMD_GHASH, dctx, src, n);\r\nsrc += n;\r\nsrclen -= n;\r\n}\r\nif (srclen) {\r\ndctx->bytes = GHASH_BLOCK_SIZE - srclen;\r\nmemcpy(buf, src, srclen);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ghash_flush(struct ghash_desc_ctx *dctx)\r\n{\r\nu8 *buf = dctx->buffer;\r\nif (dctx->bytes) {\r\nu8 *pos = buf + (GHASH_BLOCK_SIZE - dctx->bytes);\r\nmemset(pos, 0, dctx->bytes);\r\ncpacf_kimd(CPACF_KIMD_GHASH, dctx, buf, GHASH_BLOCK_SIZE);\r\ndctx->bytes = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ghash_final(struct shash_desc *desc, u8 *dst)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nint ret;\r\nret = ghash_flush(dctx);\r\nif (!ret)\r\nmemcpy(dst, dctx->icv, GHASH_BLOCK_SIZE);\r\nreturn ret;\r\n}\r\nstatic int __init ghash_mod_init(void)\r\n{\r\nif (!cpacf_query_func(CPACF_KIMD, CPACF_KIMD_GHASH))\r\nreturn -EOPNOTSUPP;\r\nreturn crypto_register_shash(&ghash_alg);\r\n}\r\nstatic void __exit ghash_mod_exit(void)\r\n{\r\ncrypto_unregister_shash(&ghash_alg);\r\n}

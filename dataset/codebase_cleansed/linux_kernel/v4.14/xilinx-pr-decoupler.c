static inline void xlnx_pr_decoupler_write(struct xlnx_pr_decoupler_data *d,\r\nu32 offset, u32 val)\r\n{\r\nwritel(val, d->io_base + offset);\r\n}\r\nstatic inline u32 xlnx_pr_decouple_read(const struct xlnx_pr_decoupler_data *d,\r\nu32 offset)\r\n{\r\nreturn readl(d->io_base + offset);\r\n}\r\nstatic int xlnx_pr_decoupler_enable_set(struct fpga_bridge *bridge, bool enable)\r\n{\r\nint err;\r\nstruct xlnx_pr_decoupler_data *priv = bridge->priv;\r\nerr = clk_enable(priv->clk);\r\nif (err)\r\nreturn err;\r\nif (enable)\r\nxlnx_pr_decoupler_write(priv, CTRL_OFFSET, CTRL_CMD_COUPLE);\r\nelse\r\nxlnx_pr_decoupler_write(priv, CTRL_OFFSET, CTRL_CMD_DECOUPLE);\r\nclk_disable(priv->clk);\r\nreturn 0;\r\n}\r\nstatic int xlnx_pr_decoupler_enable_show(struct fpga_bridge *bridge)\r\n{\r\nconst struct xlnx_pr_decoupler_data *priv = bridge->priv;\r\nu32 status;\r\nint err;\r\nerr = clk_enable(priv->clk);\r\nif (err)\r\nreturn err;\r\nstatus = readl(priv->io_base);\r\nclk_disable(priv->clk);\r\nreturn !status;\r\n}\r\nstatic int xlnx_pr_decoupler_probe(struct platform_device *pdev)\r\n{\r\nstruct xlnx_pr_decoupler_data *priv;\r\nint err;\r\nstruct resource *res;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->io_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->io_base))\r\nreturn PTR_ERR(priv->io_base);\r\npriv->clk = devm_clk_get(&pdev->dev, "aclk");\r\nif (IS_ERR(priv->clk)) {\r\ndev_err(&pdev->dev, "input clock not found\n");\r\nreturn PTR_ERR(priv->clk);\r\n}\r\nerr = clk_prepare_enable(priv->clk);\r\nif (err) {\r\ndev_err(&pdev->dev, "unable to enable clock\n");\r\nreturn err;\r\n}\r\nclk_disable(priv->clk);\r\nerr = fpga_bridge_register(&pdev->dev, "Xilinx PR Decoupler",\r\n&xlnx_pr_decoupler_br_ops, priv);\r\nif (err) {\r\ndev_err(&pdev->dev, "unable to register Xilinx PR Decoupler");\r\nclk_unprepare(priv->clk);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlnx_pr_decoupler_remove(struct platform_device *pdev)\r\n{\r\nstruct fpga_bridge *bridge = platform_get_drvdata(pdev);\r\nstruct xlnx_pr_decoupler_data *p = bridge->priv;\r\nfpga_bridge_unregister(&pdev->dev);\r\nclk_unprepare(p->clk);\r\nreturn 0;\r\n}

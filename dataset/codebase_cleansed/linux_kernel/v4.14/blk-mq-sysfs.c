static void blk_mq_sysfs_release(struct kobject *kobj)\r\n{\r\n}\r\nstatic void blk_mq_hw_sysfs_release(struct kobject *kobj)\r\n{\r\nstruct blk_mq_hw_ctx *hctx = container_of(kobj, struct blk_mq_hw_ctx,\r\nkobj);\r\nfree_cpumask_var(hctx->cpumask);\r\nkfree(hctx->ctxs);\r\nkfree(hctx);\r\n}\r\nstatic ssize_t blk_mq_sysfs_show(struct kobject *kobj, struct attribute *attr,\r\nchar *page)\r\n{\r\nstruct blk_mq_ctx_sysfs_entry *entry;\r\nstruct blk_mq_ctx *ctx;\r\nstruct request_queue *q;\r\nssize_t res;\r\nentry = container_of(attr, struct blk_mq_ctx_sysfs_entry, attr);\r\nctx = container_of(kobj, struct blk_mq_ctx, kobj);\r\nq = ctx->queue;\r\nif (!entry->show)\r\nreturn -EIO;\r\nres = -ENOENT;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!blk_queue_dying(q))\r\nres = entry->show(ctx, page);\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn res;\r\n}\r\nstatic ssize_t blk_mq_sysfs_store(struct kobject *kobj, struct attribute *attr,\r\nconst char *page, size_t length)\r\n{\r\nstruct blk_mq_ctx_sysfs_entry *entry;\r\nstruct blk_mq_ctx *ctx;\r\nstruct request_queue *q;\r\nssize_t res;\r\nentry = container_of(attr, struct blk_mq_ctx_sysfs_entry, attr);\r\nctx = container_of(kobj, struct blk_mq_ctx, kobj);\r\nq = ctx->queue;\r\nif (!entry->store)\r\nreturn -EIO;\r\nres = -ENOENT;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!blk_queue_dying(q))\r\nres = entry->store(ctx, page, length);\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn res;\r\n}\r\nstatic ssize_t blk_mq_hw_sysfs_show(struct kobject *kobj,\r\nstruct attribute *attr, char *page)\r\n{\r\nstruct blk_mq_hw_ctx_sysfs_entry *entry;\r\nstruct blk_mq_hw_ctx *hctx;\r\nstruct request_queue *q;\r\nssize_t res;\r\nentry = container_of(attr, struct blk_mq_hw_ctx_sysfs_entry, attr);\r\nhctx = container_of(kobj, struct blk_mq_hw_ctx, kobj);\r\nq = hctx->queue;\r\nif (!entry->show)\r\nreturn -EIO;\r\nres = -ENOENT;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!blk_queue_dying(q))\r\nres = entry->show(hctx, page);\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn res;\r\n}\r\nstatic ssize_t blk_mq_hw_sysfs_store(struct kobject *kobj,\r\nstruct attribute *attr, const char *page,\r\nsize_t length)\r\n{\r\nstruct blk_mq_hw_ctx_sysfs_entry *entry;\r\nstruct blk_mq_hw_ctx *hctx;\r\nstruct request_queue *q;\r\nssize_t res;\r\nentry = container_of(attr, struct blk_mq_hw_ctx_sysfs_entry, attr);\r\nhctx = container_of(kobj, struct blk_mq_hw_ctx, kobj);\r\nq = hctx->queue;\r\nif (!entry->store)\r\nreturn -EIO;\r\nres = -ENOENT;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!blk_queue_dying(q))\r\nres = entry->store(hctx, page, length);\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn res;\r\n}\r\nstatic ssize_t blk_mq_hw_sysfs_nr_tags_show(struct blk_mq_hw_ctx *hctx,\r\nchar *page)\r\n{\r\nreturn sprintf(page, "%u\n", hctx->tags->nr_tags);\r\n}\r\nstatic ssize_t blk_mq_hw_sysfs_nr_reserved_tags_show(struct blk_mq_hw_ctx *hctx,\r\nchar *page)\r\n{\r\nreturn sprintf(page, "%u\n", hctx->tags->nr_reserved_tags);\r\n}\r\nstatic ssize_t blk_mq_hw_sysfs_cpus_show(struct blk_mq_hw_ctx *hctx, char *page)\r\n{\r\nunsigned int i, first = 1;\r\nssize_t ret = 0;\r\nfor_each_cpu(i, hctx->cpumask) {\r\nif (first)\r\nret += sprintf(ret + page, "%u", i);\r\nelse\r\nret += sprintf(ret + page, ", %u", i);\r\nfirst = 0;\r\n}\r\nret += sprintf(ret + page, "\n");\r\nreturn ret;\r\n}\r\nstatic void blk_mq_unregister_hctx(struct blk_mq_hw_ctx *hctx)\r\n{\r\nstruct blk_mq_ctx *ctx;\r\nint i;\r\nif (!hctx->nr_ctx)\r\nreturn;\r\nhctx_for_each_ctx(hctx, ctx, i)\r\nkobject_del(&ctx->kobj);\r\nkobject_del(&hctx->kobj);\r\n}\r\nstatic int blk_mq_register_hctx(struct blk_mq_hw_ctx *hctx)\r\n{\r\nstruct request_queue *q = hctx->queue;\r\nstruct blk_mq_ctx *ctx;\r\nint i, ret;\r\nif (!hctx->nr_ctx)\r\nreturn 0;\r\nret = kobject_add(&hctx->kobj, &q->mq_kobj, "%u", hctx->queue_num);\r\nif (ret)\r\nreturn ret;\r\nhctx_for_each_ctx(hctx, ctx, i) {\r\nret = kobject_add(&ctx->kobj, &hctx->kobj, "cpu%u", ctx->cpu);\r\nif (ret)\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __blk_mq_unregister_dev(struct device *dev, struct request_queue *q)\r\n{\r\nstruct blk_mq_hw_ctx *hctx;\r\nint i;\r\nlockdep_assert_held(&q->sysfs_lock);\r\nqueue_for_each_hw_ctx(q, hctx, i)\r\nblk_mq_unregister_hctx(hctx);\r\nkobject_uevent(&q->mq_kobj, KOBJ_REMOVE);\r\nkobject_del(&q->mq_kobj);\r\nkobject_put(&dev->kobj);\r\nq->mq_sysfs_init_done = false;\r\n}\r\nvoid blk_mq_unregister_dev(struct device *dev, struct request_queue *q)\r\n{\r\nmutex_lock(&q->sysfs_lock);\r\n__blk_mq_unregister_dev(dev, q);\r\nmutex_unlock(&q->sysfs_lock);\r\n}\r\nvoid blk_mq_hctx_kobj_init(struct blk_mq_hw_ctx *hctx)\r\n{\r\nkobject_init(&hctx->kobj, &blk_mq_hw_ktype);\r\n}\r\nvoid blk_mq_sysfs_deinit(struct request_queue *q)\r\n{\r\nstruct blk_mq_ctx *ctx;\r\nint cpu;\r\nfor_each_possible_cpu(cpu) {\r\nctx = per_cpu_ptr(q->queue_ctx, cpu);\r\nkobject_put(&ctx->kobj);\r\n}\r\nkobject_put(&q->mq_kobj);\r\n}\r\nvoid blk_mq_sysfs_init(struct request_queue *q)\r\n{\r\nstruct blk_mq_ctx *ctx;\r\nint cpu;\r\nkobject_init(&q->mq_kobj, &blk_mq_ktype);\r\nfor_each_possible_cpu(cpu) {\r\nctx = per_cpu_ptr(q->queue_ctx, cpu);\r\nkobject_init(&ctx->kobj, &blk_mq_ctx_ktype);\r\n}\r\n}\r\nint __blk_mq_register_dev(struct device *dev, struct request_queue *q)\r\n{\r\nstruct blk_mq_hw_ctx *hctx;\r\nint ret, i;\r\nWARN_ON_ONCE(!q->kobj.parent);\r\nlockdep_assert_held(&q->sysfs_lock);\r\nret = kobject_add(&q->mq_kobj, kobject_get(&dev->kobj), "%s", "mq");\r\nif (ret < 0)\r\ngoto out;\r\nkobject_uevent(&q->mq_kobj, KOBJ_ADD);\r\nqueue_for_each_hw_ctx(q, hctx, i) {\r\nret = blk_mq_register_hctx(hctx);\r\nif (ret)\r\ngoto unreg;\r\n}\r\nq->mq_sysfs_init_done = true;\r\nout:\r\nreturn ret;\r\nunreg:\r\nwhile (--i >= 0)\r\nblk_mq_unregister_hctx(q->queue_hw_ctx[i]);\r\nkobject_uevent(&q->mq_kobj, KOBJ_REMOVE);\r\nkobject_del(&q->mq_kobj);\r\nkobject_put(&dev->kobj);\r\nreturn ret;\r\n}\r\nint blk_mq_register_dev(struct device *dev, struct request_queue *q)\r\n{\r\nint ret;\r\nmutex_lock(&q->sysfs_lock);\r\nret = __blk_mq_register_dev(dev, q);\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn ret;\r\n}\r\nvoid blk_mq_sysfs_unregister(struct request_queue *q)\r\n{\r\nstruct blk_mq_hw_ctx *hctx;\r\nint i;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!q->mq_sysfs_init_done)\r\ngoto unlock;\r\nqueue_for_each_hw_ctx(q, hctx, i)\r\nblk_mq_unregister_hctx(hctx);\r\nunlock:\r\nmutex_unlock(&q->sysfs_lock);\r\n}\r\nint blk_mq_sysfs_register(struct request_queue *q)\r\n{\r\nstruct blk_mq_hw_ctx *hctx;\r\nint i, ret = 0;\r\nmutex_lock(&q->sysfs_lock);\r\nif (!q->mq_sysfs_init_done)\r\ngoto unlock;\r\nqueue_for_each_hw_ctx(q, hctx, i) {\r\nret = blk_mq_register_hctx(hctx);\r\nif (ret)\r\nbreak;\r\n}\r\nunlock:\r\nmutex_unlock(&q->sysfs_lock);\r\nreturn ret;\r\n}

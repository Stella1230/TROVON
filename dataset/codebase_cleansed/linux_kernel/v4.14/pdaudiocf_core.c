static unsigned char pdacf_ak4117_read(void *private_data, unsigned char reg)\r\n{\r\nstruct snd_pdacf *chip = private_data;\r\nunsigned long timeout;\r\nunsigned long flags;\r\nunsigned char res;\r\nspin_lock_irqsave(&chip->ak4117_lock, flags);\r\ntimeout = 1000;\r\nwhile (pdacf_reg_read(chip, PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\r\nudelay(5);\r\nif (--timeout == 0) {\r\nspin_unlock_irqrestore(&chip->ak4117_lock, flags);\r\nsnd_printk(KERN_ERR "AK4117 ready timeout (read)\n");\r\nreturn 0;\r\n}\r\n}\r\npdacf_reg_write(chip, PDAUDIOCF_REG_AK_IFR, (u16)reg << 8);\r\ntimeout = 1000;\r\nwhile (pdacf_reg_read(chip, PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\r\nudelay(5);\r\nif (--timeout == 0) {\r\nspin_unlock_irqrestore(&chip->ak4117_lock, flags);\r\nsnd_printk(KERN_ERR "AK4117 read timeout (read2)\n");\r\nreturn 0;\r\n}\r\n}\r\nres = (unsigned char)pdacf_reg_read(chip, PDAUDIOCF_REG_AK_IFR);\r\nspin_unlock_irqrestore(&chip->ak4117_lock, flags);\r\nreturn res;\r\n}\r\nstatic void pdacf_ak4117_write(void *private_data, unsigned char reg, unsigned char val)\r\n{\r\nstruct snd_pdacf *chip = private_data;\r\nunsigned long timeout;\r\nunsigned long flags;\r\nspin_lock_irqsave(&chip->ak4117_lock, flags);\r\ntimeout = 1000;\r\nwhile (inw(chip->port + PDAUDIOCF_REG_SCR) & PDAUDIOCF_AK_SBP) {\r\nudelay(5);\r\nif (--timeout == 0) {\r\nspin_unlock_irqrestore(&chip->ak4117_lock, flags);\r\nsnd_printk(KERN_ERR "AK4117 ready timeout (write)\n");\r\nreturn;\r\n}\r\n}\r\noutw((u16)reg << 8 | val | (1<<13), chip->port + PDAUDIOCF_REG_AK_IFR);\r\nspin_unlock_irqrestore(&chip->ak4117_lock, flags);\r\n}\r\nstatic int pdacf_reset(struct snd_pdacf *chip, int powerdown)\r\n{\r\nu16 val;\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nval |= PDAUDIOCF_PDN;\r\nval &= ~PDAUDIOCF_RECORD;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nudelay(5);\r\nval |= PDAUDIOCF_RST;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nudelay(200);\r\nval &= ~PDAUDIOCF_RST;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nudelay(5);\r\nif (!powerdown) {\r\nval &= ~PDAUDIOCF_PDN;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nudelay(200);\r\n}\r\nreturn 0;\r\n}\r\nvoid pdacf_reinit(struct snd_pdacf *chip, int resume)\r\n{\r\npdacf_reset(chip, 0);\r\nif (resume)\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, chip->suspend_reg_scr);\r\nsnd_ak4117_reinit(chip->ak4117);\r\npdacf_reg_write(chip, PDAUDIOCF_REG_TCR, chip->regmap[PDAUDIOCF_REG_TCR>>1]);\r\npdacf_reg_write(chip, PDAUDIOCF_REG_IER, chip->regmap[PDAUDIOCF_REG_IER>>1]);\r\n}\r\nstatic void pdacf_proc_read(struct snd_info_entry * entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_pdacf *chip = entry->private_data;\r\nu16 tmp;\r\nsnd_iprintf(buffer, "PDAudioCF\n\n");\r\ntmp = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nsnd_iprintf(buffer, "FPGA revision : 0x%x\n", PDAUDIOCF_FPGAREV(tmp));\r\n}\r\nstatic void pdacf_proc_init(struct snd_pdacf *chip)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(chip->card, "pdaudiocf", &entry))\r\nsnd_info_set_text_ops(entry, chip, pdacf_proc_read);\r\n}\r\nstruct snd_pdacf *snd_pdacf_create(struct snd_card *card)\r\n{\r\nstruct snd_pdacf *chip;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn NULL;\r\nchip->card = card;\r\nmutex_init(&chip->reg_lock);\r\nspin_lock_init(&chip->ak4117_lock);\r\ncard->private_data = chip;\r\npdacf_proc_init(chip);\r\nreturn chip;\r\n}\r\nstatic void snd_pdacf_ak4117_change(struct ak4117 *ak4117, unsigned char c0, unsigned char c1)\r\n{\r\nstruct snd_pdacf *chip = ak4117->change_callback_private;\r\nu16 val;\r\nif (!(c0 & AK4117_UNLCK))\r\nreturn;\r\nmutex_lock(&chip->reg_lock);\r\nval = chip->regmap[PDAUDIOCF_REG_SCR>>1];\r\nif (ak4117->rcs0 & AK4117_UNLCK)\r\nval |= PDAUDIOCF_BLUE_LED_OFF;\r\nelse\r\nval &= ~PDAUDIOCF_BLUE_LED_OFF;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nmutex_unlock(&chip->reg_lock);\r\n}\r\nint snd_pdacf_ak4117_create(struct snd_pdacf *chip)\r\n{\r\nint err;\r\nu16 val;\r\nstatic unsigned char pgm[5] = {\r\nAK4117_XTL_24_576M | AK4117_EXCT,\r\nAK4117_CM_PLL_XTAL | AK4117_PKCS_128fs | AK4117_XCKS_128fs,\r\nAK4117_EFH_1024LRCLK | AK4117_DIF_24R | AK4117_IPS,\r\n0xff,\r\nAK4117_MAUTO | AK4117_MAUD | AK4117_MULK | AK4117_MPAR | AK4117_MV,\r\n};\r\nerr = pdacf_reset(chip, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ak4117_create(chip->card, pdacf_ak4117_read, pdacf_ak4117_write, pgm, chip, &chip->ak4117);\r\nif (err < 0)\r\nreturn err;\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_TCR);\r\n#if 1\r\nval &= ~(PDAUDIOCF_ELIMAKMBIT|PDAUDIOCF_TESTDATASEL);\r\n#else\r\nval |= PDAUDIOCF_ELIMAKMBIT;\r\nval &= ~PDAUDIOCF_TESTDATASEL;\r\n#endif\r\npdacf_reg_write(chip, PDAUDIOCF_REG_TCR, val);\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nval &= ~(PDAUDIOCF_CLKDIV0 | PDAUDIOCF_CLKDIV1);\r\nval &= ~(PDAUDIOCF_RED_LED_OFF|PDAUDIOCF_BLUE_LED_OFF);\r\nval |= PDAUDIOCF_DATAFMT0 | PDAUDIOCF_DATAFMT1;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_IER);\r\nval &= ~(PDAUDIOCF_IRQLVLEN0 | PDAUDIOCF_IRQLVLEN1);\r\nval &= ~(PDAUDIOCF_BLUEDUTY0 | PDAUDIOCF_REDDUTY0 | PDAUDIOCF_REDDUTY1);\r\nval |= PDAUDIOCF_BLUEDUTY1 | PDAUDIOCF_HALFRATE;\r\nval |= PDAUDIOCF_IRQOVREN | PDAUDIOCF_IRQAKMEN;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_IER, val);\r\nchip->ak4117->change_callback_private = chip;\r\nchip->ak4117->change_callback = snd_pdacf_ak4117_change;\r\nsnd_pdacf_ak4117_change(chip->ak4117, AK4117_UNLCK, 0);\r\nreturn 0;\r\n}\r\nvoid snd_pdacf_powerdown(struct snd_pdacf *chip)\r\n{\r\nu16 val;\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nchip->suspend_reg_scr = val;\r\nval |= PDAUDIOCF_RED_LED_OFF | PDAUDIOCF_BLUE_LED_OFF;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, val);\r\nval = inw(chip->port + PDAUDIOCF_REG_IER);\r\nval &= ~(PDAUDIOCF_IRQOVREN|PDAUDIOCF_IRQAKMEN|PDAUDIOCF_IRQLVLEN0|PDAUDIOCF_IRQLVLEN1);\r\noutw(val, chip->port + PDAUDIOCF_REG_IER);\r\npdacf_reset(chip, 1);\r\n}\r\nint snd_pdacf_suspend(struct snd_pdacf *chip)\r\n{\r\nu16 val;\r\nsnd_power_change_state(chip->card, SNDRV_CTL_POWER_D3hot);\r\nsnd_pcm_suspend_all(chip->pcm);\r\nval = inw(chip->port + PDAUDIOCF_REG_IER);\r\nval &= ~(PDAUDIOCF_IRQOVREN|PDAUDIOCF_IRQAKMEN|PDAUDIOCF_IRQLVLEN0|PDAUDIOCF_IRQLVLEN1);\r\noutw(val, chip->port + PDAUDIOCF_REG_IER);\r\nchip->chip_status |= PDAUDIOCF_STAT_IS_SUSPENDED;\r\nsnd_pdacf_powerdown(chip);\r\nreturn 0;\r\n}\r\nstatic inline int check_signal(struct snd_pdacf *chip)\r\n{\r\nreturn (chip->ak4117->rcs0 & AK4117_UNLCK) == 0;\r\n}\r\nint snd_pdacf_resume(struct snd_pdacf *chip)\r\n{\r\nint timeout = 40;\r\npdacf_reinit(chip, 1);\r\nwhile (timeout-- > 0 &&\r\n(snd_ak4117_external_rate(chip->ak4117) <= 0 || !check_signal(chip)))\r\nmdelay(1);\r\nchip->chip_status &= ~PDAUDIOCF_STAT_IS_SUSPENDED;\r\nsnd_power_change_state(chip->card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}

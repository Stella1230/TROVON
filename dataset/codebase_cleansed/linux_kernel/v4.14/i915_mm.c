static int remap_pfn(pte_t *pte, pgtable_t token,\r\nunsigned long addr, void *data)\r\n{\r\nstruct remap_pfn *r = data;\r\nset_pte_at(r->mm, addr, pte, pte_mkspecial(pfn_pte(r->pfn, r->prot)));\r\nr->pfn++;\r\nreturn 0;\r\n}\r\nint remap_io_mapping(struct vm_area_struct *vma,\r\nunsigned long addr, unsigned long pfn, unsigned long size,\r\nstruct io_mapping *iomap)\r\n{\r\nstruct remap_pfn r;\r\nint err;\r\nGEM_BUG_ON((vma->vm_flags &\r\n(VM_IO | VM_PFNMAP | VM_DONTEXPAND | VM_DONTDUMP)) !=\r\n(VM_IO | VM_PFNMAP | VM_DONTEXPAND | VM_DONTDUMP));\r\nr.mm = vma->vm_mm;\r\nr.pfn = pfn;\r\nr.prot = __pgprot((pgprot_val(iomap->prot) & _PAGE_CACHE_MASK) |\r\n(pgprot_val(vma->vm_page_prot) & ~_PAGE_CACHE_MASK));\r\nerr = apply_to_page_range(r.mm, addr, size, remap_pfn, &r);\r\nif (unlikely(err)) {\r\nzap_vma_ptes(vma, addr, (r.pfn - pfn) << PAGE_SHIFT);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

static inline bool nps_enet_is_tx_pending(struct nps_enet_priv *priv)\r\n{\r\nu32 tx_ctrl_value = nps_enet_reg_get(priv, NPS_ENET_REG_TX_CTL);\r\nu32 tx_ctrl_ct = (tx_ctrl_value & TX_CTL_CT_MASK) >> TX_CTL_CT_SHIFT;\r\nreturn (!tx_ctrl_ct && priv->tx_skb);\r\n}\r\nstatic void nps_enet_clean_rx_fifo(struct net_device *ndev, u32 frame_len)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 i, len = DIV_ROUND_UP(frame_len, sizeof(u32));\r\nfor (i = 0; i < len; i++)\r\nnps_enet_reg_get(priv, NPS_ENET_REG_RX_BUF);\r\n}\r\nstatic void nps_enet_read_rx_fifo(struct net_device *ndev,\r\nunsigned char *dst, u32 length)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\ns32 i, last = length & (sizeof(u32) - 1);\r\nu32 *reg = (u32 *)dst, len = length / sizeof(u32);\r\nbool dst_is_aligned = IS_ALIGNED((unsigned long)dst, sizeof(u32));\r\nif (dst_is_aligned) {\r\nioread32_rep(priv->regs_base + NPS_ENET_REG_RX_BUF, reg, len);\r\nreg += len;\r\n} else {\r\nfor (i = 0; i < len; i++, reg++) {\r\nu32 buf = nps_enet_reg_get(priv, NPS_ENET_REG_RX_BUF);\r\nput_unaligned_be32(buf, reg);\r\n}\r\n}\r\nif (last) {\r\nu32 buf;\r\nioread32_rep(priv->regs_base + NPS_ENET_REG_RX_BUF, &buf, 1);\r\nmemcpy((u8 *)reg, &buf, last);\r\n}\r\n}\r\nstatic u32 nps_enet_rx_handler(struct net_device *ndev)\r\n{\r\nu32 frame_len, err = 0;\r\nu32 work_done = 0;\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nstruct sk_buff *skb;\r\nu32 rx_ctrl_value = nps_enet_reg_get(priv, NPS_ENET_REG_RX_CTL);\r\nu32 rx_ctrl_cr = (rx_ctrl_value & RX_CTL_CR_MASK) >> RX_CTL_CR_SHIFT;\r\nu32 rx_ctrl_er = (rx_ctrl_value & RX_CTL_ER_MASK) >> RX_CTL_ER_SHIFT;\r\nu32 rx_ctrl_crc = (rx_ctrl_value & RX_CTL_CRC_MASK) >> RX_CTL_CRC_SHIFT;\r\nframe_len = (rx_ctrl_value & RX_CTL_NR_MASK) >> RX_CTL_NR_SHIFT;\r\nif (!rx_ctrl_cr)\r\nreturn work_done;\r\nwork_done++;\r\nif (rx_ctrl_er) {\r\nndev->stats.rx_errors++;\r\nerr = 1;\r\n}\r\nif (rx_ctrl_crc) {\r\nndev->stats.rx_crc_errors++;\r\nndev->stats.rx_dropped++;\r\nerr = 1;\r\n}\r\nif (unlikely(frame_len < ETH_ZLEN)) {\r\nndev->stats.rx_length_errors++;\r\nndev->stats.rx_dropped++;\r\nerr = 1;\r\n}\r\nif (err)\r\ngoto rx_irq_clean;\r\nskb = netdev_alloc_skb_ip_align(ndev, frame_len);\r\nif (unlikely(!skb)) {\r\nndev->stats.rx_errors++;\r\nndev->stats.rx_dropped++;\r\ngoto rx_irq_clean;\r\n}\r\nnps_enet_read_rx_fifo(ndev, skb->data, frame_len);\r\nskb_put(skb, frame_len);\r\nskb->protocol = eth_type_trans(skb, ndev);\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nndev->stats.rx_packets++;\r\nndev->stats.rx_bytes += frame_len;\r\nnetif_receive_skb(skb);\r\ngoto rx_irq_frame_done;\r\nrx_irq_clean:\r\nnps_enet_clean_rx_fifo(ndev, frame_len);\r\nrx_irq_frame_done:\r\nnps_enet_reg_set(priv, NPS_ENET_REG_RX_CTL, 0);\r\nreturn work_done;\r\n}\r\nstatic void nps_enet_tx_handler(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 tx_ctrl_value = nps_enet_reg_get(priv, NPS_ENET_REG_TX_CTL);\r\nu32 tx_ctrl_et = (tx_ctrl_value & TX_CTL_ET_MASK) >> TX_CTL_ET_SHIFT;\r\nu32 tx_ctrl_nt = (tx_ctrl_value & TX_CTL_NT_MASK) >> TX_CTL_NT_SHIFT;\r\nif (!nps_enet_is_tx_pending(priv))\r\nreturn;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_TX_CTL, 0);\r\nif (unlikely(tx_ctrl_et)) {\r\nndev->stats.tx_errors++;\r\n} else {\r\nndev->stats.tx_packets++;\r\nndev->stats.tx_bytes += tx_ctrl_nt;\r\n}\r\ndev_kfree_skb(priv->tx_skb);\r\npriv->tx_skb = NULL;\r\nif (netif_queue_stopped(ndev))\r\nnetif_wake_queue(ndev);\r\n}\r\nstatic int nps_enet_poll(struct napi_struct *napi, int budget)\r\n{\r\nstruct net_device *ndev = napi->dev;\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 work_done;\r\nnps_enet_tx_handler(ndev);\r\nwork_done = nps_enet_rx_handler(ndev);\r\nif ((work_done < budget) && napi_complete_done(napi, work_done)) {\r\nu32 buf_int_enable_value = 0;\r\nbuf_int_enable_value |= NPS_ENET_ENABLE << RX_RDY_SHIFT;\r\nbuf_int_enable_value |= NPS_ENET_ENABLE << TX_DONE_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_BUF_INT_ENABLE,\r\nbuf_int_enable_value);\r\nif (nps_enet_is_tx_pending(priv)) {\r\nnps_enet_reg_set(priv, NPS_ENET_REG_BUF_INT_ENABLE, 0);\r\nnapi_reschedule(napi);\r\n}\r\n}\r\nreturn work_done;\r\n}\r\nstatic irqreturn_t nps_enet_irq_handler(s32 irq, void *dev_instance)\r\n{\r\nstruct net_device *ndev = dev_instance;\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 rx_ctrl_value = nps_enet_reg_get(priv, NPS_ENET_REG_RX_CTL);\r\nu32 rx_ctrl_cr = (rx_ctrl_value & RX_CTL_CR_MASK) >> RX_CTL_CR_SHIFT;\r\nif (nps_enet_is_tx_pending(priv) || rx_ctrl_cr)\r\nif (likely(napi_schedule_prep(&priv->napi))) {\r\nnps_enet_reg_set(priv, NPS_ENET_REG_BUF_INT_ENABLE, 0);\r\n__napi_schedule(&priv->napi);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void nps_enet_set_hw_mac_address(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 ge_mac_cfg_1_value = 0;\r\nu32 *ge_mac_cfg_2_value = &priv->ge_mac_cfg_2_value;\r\nge_mac_cfg_1_value |= ndev->dev_addr[0] << CFG_1_OCTET_0_SHIFT;\r\nge_mac_cfg_1_value |= ndev->dev_addr[1] << CFG_1_OCTET_1_SHIFT;\r\nge_mac_cfg_1_value |= ndev->dev_addr[2] << CFG_1_OCTET_2_SHIFT;\r\nge_mac_cfg_1_value |= ndev->dev_addr[3] << CFG_1_OCTET_3_SHIFT;\r\n*ge_mac_cfg_2_value = (*ge_mac_cfg_2_value & ~CFG_2_OCTET_4_MASK)\r\n| ndev->dev_addr[4] << CFG_2_OCTET_4_SHIFT;\r\n*ge_mac_cfg_2_value = (*ge_mac_cfg_2_value & ~CFG_2_OCTET_5_MASK)\r\n| ndev->dev_addr[5] << CFG_2_OCTET_5_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_1,\r\nge_mac_cfg_1_value);\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_2,\r\n*ge_mac_cfg_2_value);\r\n}\r\nstatic void nps_enet_hw_reset(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 ge_rst_value = 0, phase_fifo_ctl_value = 0;\r\nge_rst_value |= NPS_ENET_ENABLE << RST_GMAC_0_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_RST, ge_rst_value);\r\nusleep_range(10, 20);\r\nge_rst_value = 0;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_RST, ge_rst_value);\r\nphase_fifo_ctl_value |= NPS_ENET_ENABLE << PHASE_FIFO_CTL_RST_SHIFT;\r\nphase_fifo_ctl_value |= NPS_ENET_ENABLE << PHASE_FIFO_CTL_INIT_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_PHASE_FIFO_CTL,\r\nphase_fifo_ctl_value);\r\nusleep_range(10, 20);\r\nphase_fifo_ctl_value = 0;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_PHASE_FIFO_CTL,\r\nphase_fifo_ctl_value);\r\n}\r\nstatic void nps_enet_hw_enable_control(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 ge_mac_cfg_0_value = 0, buf_int_enable_value = 0;\r\nu32 *ge_mac_cfg_2_value = &priv->ge_mac_cfg_2_value;\r\nu32 *ge_mac_cfg_3_value = &priv->ge_mac_cfg_3_value;\r\ns32 max_frame_length;\r\n*ge_mac_cfg_2_value = (*ge_mac_cfg_2_value & ~CFG_2_STAT_EN_MASK)\r\n| NPS_ENET_GE_MAC_CFG_2_STAT_EN << CFG_2_STAT_EN_SHIFT;\r\n*ge_mac_cfg_2_value = (*ge_mac_cfg_2_value & ~CFG_2_DISK_DA_MASK)\r\n| NPS_ENET_ENABLE << CFG_2_DISK_DA_SHIFT;\r\n*ge_mac_cfg_2_value = (*ge_mac_cfg_2_value & ~CFG_2_DISK_MC_MASK)\r\n| NPS_ENET_ENABLE << CFG_2_DISK_MC_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_2,\r\n*ge_mac_cfg_2_value);\r\nmax_frame_length = ETH_HLEN + ndev->mtu + ETH_FCS_LEN;\r\nif (max_frame_length <= NPS_ENET_MAX_FRAME_LENGTH) {\r\n*ge_mac_cfg_3_value =\r\n(*ge_mac_cfg_3_value & ~CFG_3_MAX_LEN_MASK)\r\n| max_frame_length << CFG_3_MAX_LEN_SHIFT;\r\n}\r\nbuf_int_enable_value |= NPS_ENET_ENABLE << RX_RDY_SHIFT;\r\nbuf_int_enable_value |= NPS_ENET_ENABLE << TX_DONE_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_BUF_INT_ENABLE,\r\nbuf_int_enable_value);\r\nnps_enet_set_hw_mac_address(ndev);\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_TX_PAD_EN_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_TX_CRC_EN_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_RX_CRC_STRIP_SHIFT;\r\nge_mac_cfg_0_value |=\r\nNPS_ENET_GE_MAC_CFG_0_RX_IFG << CFG_0_RX_IFG_SHIFT;\r\nge_mac_cfg_0_value |=\r\nNPS_ENET_GE_MAC_CFG_0_TX_IFG << CFG_0_TX_IFG_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_RX_PR_CHECK_EN_SHIFT;\r\nge_mac_cfg_0_value |=\r\nNPS_ENET_GE_MAC_CFG_0_TX_PR_LEN << CFG_0_TX_PR_LEN_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_TX_FC_EN_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_RX_FC_EN_SHIFT;\r\nge_mac_cfg_0_value |=\r\nNPS_ENET_GE_MAC_CFG_0_TX_FC_RETR << CFG_0_TX_FC_RETR_SHIFT;\r\n*ge_mac_cfg_3_value = (*ge_mac_cfg_3_value & ~CFG_3_CF_DROP_MASK)\r\n| NPS_ENET_ENABLE << CFG_3_CF_DROP_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_RX_EN_SHIFT;\r\nge_mac_cfg_0_value |= NPS_ENET_ENABLE << CFG_0_TX_EN_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_3,\r\n*ge_mac_cfg_3_value);\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_0,\r\nge_mac_cfg_0_value);\r\n}\r\nstatic void nps_enet_hw_disable_control(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nnps_enet_reg_set(priv, NPS_ENET_REG_BUF_INT_ENABLE, 0);\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_0, 0);\r\n}\r\nstatic void nps_enet_send_frame(struct net_device *ndev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 tx_ctrl_value = 0;\r\nshort length = skb->len;\r\nu32 i, len = DIV_ROUND_UP(length, sizeof(u32));\r\nu32 *src = (void *)skb->data;\r\nbool src_is_aligned = IS_ALIGNED((unsigned long)src, sizeof(u32));\r\nif (src_is_aligned)\r\niowrite32_rep(priv->regs_base + NPS_ENET_REG_TX_BUF, src, len);\r\nelse\r\nfor (i = 0; i < len; i++, src++)\r\nnps_enet_reg_set(priv, NPS_ENET_REG_TX_BUF,\r\nget_unaligned_be32(src));\r\ntx_ctrl_value |= length << TX_CTL_NT_SHIFT;\r\ntx_ctrl_value |= NPS_ENET_ENABLE << TX_CTL_CT_SHIFT;\r\nnps_enet_reg_set(priv, NPS_ENET_REG_TX_CTL, tx_ctrl_value);\r\n}\r\nstatic s32 nps_enet_set_mac_address(struct net_device *ndev, void *p)\r\n{\r\nstruct sockaddr *addr = p;\r\ns32 res;\r\nif (netif_running(ndev))\r\nreturn -EBUSY;\r\nres = eth_mac_addr(ndev, p);\r\nif (!res) {\r\nether_addr_copy(ndev->dev_addr, addr->sa_data);\r\nnps_enet_set_hw_mac_address(ndev);\r\n}\r\nreturn res;\r\n}\r\nstatic void nps_enet_set_rx_mode(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nu32 ge_mac_cfg_2_value = priv->ge_mac_cfg_2_value;\r\nif (ndev->flags & IFF_PROMISC) {\r\nge_mac_cfg_2_value = (ge_mac_cfg_2_value & ~CFG_2_DISK_DA_MASK)\r\n| NPS_ENET_DISABLE << CFG_2_DISK_DA_SHIFT;\r\nge_mac_cfg_2_value = (ge_mac_cfg_2_value & ~CFG_2_DISK_MC_MASK)\r\n| NPS_ENET_DISABLE << CFG_2_DISK_MC_SHIFT;\r\n} else {\r\nge_mac_cfg_2_value = (ge_mac_cfg_2_value & ~CFG_2_DISK_DA_MASK)\r\n| NPS_ENET_ENABLE << CFG_2_DISK_DA_SHIFT;\r\nge_mac_cfg_2_value = (ge_mac_cfg_2_value & ~CFG_2_DISK_MC_MASK)\r\n| NPS_ENET_ENABLE << CFG_2_DISK_MC_SHIFT;\r\n}\r\nnps_enet_reg_set(priv, NPS_ENET_REG_GE_MAC_CFG_2, ge_mac_cfg_2_value);\r\n}\r\nstatic s32 nps_enet_open(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\ns32 err;\r\npriv->tx_skb = NULL;\r\npriv->ge_mac_cfg_2_value = 0;\r\npriv->ge_mac_cfg_3_value = 0;\r\npriv->ge_mac_cfg_3_value |=\r\nNPS_ENET_GE_MAC_CFG_3_RX_IFG_TH << CFG_3_RX_IFG_TH_SHIFT;\r\npriv->ge_mac_cfg_3_value |=\r\nNPS_ENET_GE_MAC_CFG_3_MAX_LEN << CFG_3_MAX_LEN_SHIFT;\r\nnps_enet_hw_disable_control(ndev);\r\nerr = request_irq(priv->irq, nps_enet_irq_handler,\r\n0, "enet-rx-tx", ndev);\r\nif (err)\r\nreturn err;\r\nnapi_enable(&priv->napi);\r\nnps_enet_hw_reset(ndev);\r\nnps_enet_hw_enable_control(ndev);\r\nnetif_start_queue(ndev);\r\nreturn 0;\r\n}\r\nstatic s32 nps_enet_stop(struct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nnapi_disable(&priv->napi);\r\nnetif_stop_queue(ndev);\r\nnps_enet_hw_disable_control(ndev);\r\nfree_irq(priv->irq, ndev);\r\nreturn 0;\r\n}\r\nstatic netdev_tx_t nps_enet_start_xmit(struct sk_buff *skb,\r\nstruct net_device *ndev)\r\n{\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nnetif_stop_queue(ndev);\r\npriv->tx_skb = skb;\r\nwmb();\r\nnps_enet_send_frame(ndev, skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic void nps_enet_poll_controller(struct net_device *ndev)\r\n{\r\ndisable_irq(ndev->irq);\r\nnps_enet_irq_handler(ndev->irq, ndev);\r\nenable_irq(ndev->irq);\r\n}\r\nstatic s32 nps_enet_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct net_device *ndev;\r\nstruct nps_enet_priv *priv;\r\ns32 err = 0;\r\nconst char *mac_addr;\r\nstruct resource *res_regs;\r\nif (!dev->of_node)\r\nreturn -ENODEV;\r\nndev = alloc_etherdev(sizeof(struct nps_enet_priv));\r\nif (!ndev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, ndev);\r\nSET_NETDEV_DEV(ndev, dev);\r\npriv = netdev_priv(ndev);\r\nndev->netdev_ops = &nps_netdev_ops;\r\nndev->watchdog_timeo = (400 * HZ / 1000);\r\nndev->flags &= ~IFF_MULTICAST;\r\nres_regs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->regs_base = devm_ioremap_resource(dev, res_regs);\r\nif (IS_ERR(priv->regs_base)) {\r\nerr = PTR_ERR(priv->regs_base);\r\ngoto out_netdev;\r\n}\r\ndev_dbg(dev, "Registers base address is 0x%p\n", priv->regs_base);\r\nmac_addr = of_get_mac_address(dev->of_node);\r\nif (mac_addr)\r\nether_addr_copy(ndev->dev_addr, mac_addr);\r\nelse\r\neth_hw_addr_random(ndev);\r\npriv->irq = platform_get_irq(pdev, 0);\r\nif (!priv->irq) {\r\ndev_err(dev, "failed to retrieve <irq Rx-Tx> value from device tree\n");\r\nerr = -ENODEV;\r\ngoto out_netdev;\r\n}\r\nnetif_napi_add(ndev, &priv->napi, nps_enet_poll,\r\nNPS_ENET_NAPI_POLL_WEIGHT);\r\nerr = register_netdev(ndev);\r\nif (err) {\r\ndev_err(dev, "Failed to register ndev for %s, err = 0x%08x\n",\r\nndev->name, (s32)err);\r\ngoto out_netif_api;\r\n}\r\ndev_info(dev, "(rx/tx=%d)\n", priv->irq);\r\nreturn 0;\r\nout_netif_api:\r\nnetif_napi_del(&priv->napi);\r\nout_netdev:\r\nif (err)\r\nfree_netdev(ndev);\r\nreturn err;\r\n}\r\nstatic s32 nps_enet_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct nps_enet_priv *priv = netdev_priv(ndev);\r\nunregister_netdev(ndev);\r\nfree_netdev(ndev);\r\nnetif_napi_del(&priv->napi);\r\nreturn 0;\r\n}

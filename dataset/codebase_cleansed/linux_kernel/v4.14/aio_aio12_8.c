static int aio_aio12_8_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + AIO12_8_STATUS_REG);\r\nif (status & AIO12_8_STATUS_ADC_EOC)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int aio_aio12_8_ai_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int val;\r\nunsigned char control;\r\nint ret;\r\nint i;\r\ncontrol = AIO12_8_ADC_MODE_NORMAL | AIO12_8_ADC_ACQ_3USEC |\r\nAIO12_8_ADC_RANGE(range) | AIO12_8_ADC_CHAN(chan);\r\ninb(dev->iobase + AIO12_8_STATUS_REG);\r\nfor (i = 0; i < insn->n; i++) {\r\noutb(control, dev->iobase + AIO12_8_ADC_REG);\r\nret = comedi_timeout(dev, s, insn, aio_aio12_8_ai_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\nval = inw(dev->iobase + AIO12_8_ADC_REG) & s->maxdata;\r\nif (comedi_range_is_bipolar(s, range))\r\nval = comedi_offset_munge(s, val);\r\ndata[i] = val;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int val = s->readback[chan];\r\nint i;\r\noutb(AIO12_8_DAC_ENABLE_REF_ENA, dev->iobase + AIO12_8_DAC_ENABLE_REG);\r\nfor (i = 0; i < insn->n; i++) {\r\nval = data[i];\r\noutw(val, dev->iobase + AIO12_8_DAC_REG(chan));\r\n}\r\ns->readback[chan] = val;\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_counter_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_GET_CLOCK_SRC:\r\ndata[0] = 0;\r\ndata[1] = (chan == 1) ? I8254_OSC_BASE_1MHZ : 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct aio12_8_boardtype *board = dev->board_ptr;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], 32);\r\nif (ret)\r\nreturn ret;\r\ndev->pacer = comedi_8254_init(dev->iobase + AIO12_8_8254_BASE_REG,\r\n0, I8254_IO8, 0);\r\nif (!dev->pacer)\r\nreturn -ENOMEM;\r\nret = comedi_alloc_subdevices(dev, 4);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\nif (board->has_ai) {\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = 8;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &aio_aio12_8_range;\r\ns->insn_read = aio_aio12_8_ai_read;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[1];\r\nif (board->has_ao) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND;\r\ns->n_chan = 4;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &aio_aio12_8_range;\r\ns->insn_write = aio_aio12_8_ao_insn_write;\r\nret = comedi_alloc_subdev_readback(s);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[2];\r\nret = subdev_8255_init(dev, s, NULL, AIO12_8_8255_BASE_REG);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[3];\r\ncomedi_8254_subdevice_init(s, dev->pacer);\r\ndev->pacer->insn_config = aio_aio12_8_counter_insn_config;\r\nreturn 0;\r\n}

static void cpcap2rtc_time(struct rtc_time *rtc, struct cpcap_time *cpcap)\r\n{\r\nunsigned long int tod;\r\nunsigned long int time;\r\ntod = (cpcap->tod1 & TOD1_MASK) | ((cpcap->tod2 & TOD2_MASK) << 8);\r\ntime = tod + ((cpcap->day & DAY_MASK) * SECS_PER_DAY);\r\nrtc_time_to_tm(time, rtc);\r\n}\r\nstatic void rtc2cpcap_time(struct cpcap_time *cpcap, struct rtc_time *rtc)\r\n{\r\nunsigned long time;\r\nrtc_tm_to_time(rtc, &time);\r\ncpcap->day = time / SECS_PER_DAY;\r\ntime %= SECS_PER_DAY;\r\ncpcap->tod2 = (time >> 8) & TOD2_MASK;\r\ncpcap->tod1 = time & TOD1_MASK;\r\n}\r\nstatic int cpcap_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct cpcap_rtc *rtc = dev_get_drvdata(dev);\r\nif (rtc->alarm_enabled == enabled)\r\nreturn 0;\r\nif (enabled)\r\nenable_irq(rtc->alarm_irq);\r\nelse\r\ndisable_irq(rtc->alarm_irq);\r\nrtc->alarm_enabled = !!enabled;\r\nreturn 0;\r\n}\r\nstatic int cpcap_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct cpcap_rtc *rtc;\r\nstruct cpcap_time cpcap_tm;\r\nint temp_tod2;\r\nint ret;\r\nrtc = dev_get_drvdata(dev);\r\nret = regmap_read(rtc->regmap, CPCAP_REG_TOD2, &temp_tod2);\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_DAY, &cpcap_tm.day);\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_TOD1, &cpcap_tm.tod1);\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_TOD2, &cpcap_tm.tod2);\r\nif (temp_tod2 > cpcap_tm.tod2)\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_DAY, &cpcap_tm.day);\r\nif (ret) {\r\ndev_err(dev, "Failed to read time\n");\r\nreturn -EIO;\r\n}\r\ncpcap2rtc_time(tm, &cpcap_tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int cpcap_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct cpcap_rtc *rtc;\r\nstruct cpcap_time cpcap_tm;\r\nint ret = 0;\r\nrtc = dev_get_drvdata(dev);\r\nrtc2cpcap_time(&cpcap_tm, tm);\r\nif (rtc->alarm_enabled)\r\ndisable_irq(rtc->alarm_irq);\r\nif (rtc->update_enabled)\r\ndisable_irq(rtc->update_irq);\r\nif (rtc->vendor == CPCAP_VENDOR_ST) {\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TOD1,\r\nTOD1_MASK, cpcap_tm.tod1);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TOD2,\r\nTOD2_MASK, cpcap_tm.tod2);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_DAY,\r\nDAY_MASK, cpcap_tm.day);\r\n} else {\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TOD1,\r\nTOD1_MASK, 0);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_DAY,\r\nDAY_MASK, cpcap_tm.day);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TOD2,\r\nTOD2_MASK, cpcap_tm.tod2);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TOD1,\r\nTOD1_MASK, cpcap_tm.tod1);\r\n}\r\nif (rtc->update_enabled)\r\nenable_irq(rtc->update_irq);\r\nif (rtc->alarm_enabled)\r\nenable_irq(rtc->alarm_irq);\r\nreturn ret;\r\n}\r\nstatic int cpcap_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct cpcap_rtc *rtc;\r\nstruct cpcap_time cpcap_tm;\r\nint ret;\r\nrtc = dev_get_drvdata(dev);\r\nalrm->enabled = rtc->alarm_enabled;\r\nret = regmap_read(rtc->regmap, CPCAP_REG_DAYA, &cpcap_tm.day);\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_TODA2, &cpcap_tm.tod2);\r\nret |= regmap_read(rtc->regmap, CPCAP_REG_TODA1, &cpcap_tm.tod1);\r\nif (ret) {\r\ndev_err(dev, "Failed to read time\n");\r\nreturn -EIO;\r\n}\r\ncpcap2rtc_time(&alrm->time, &cpcap_tm);\r\nreturn rtc_valid_tm(&alrm->time);\r\n}\r\nstatic int cpcap_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct cpcap_rtc *rtc;\r\nstruct cpcap_time cpcap_tm;\r\nint ret;\r\nrtc = dev_get_drvdata(dev);\r\nrtc2cpcap_time(&cpcap_tm, &alrm->time);\r\nif (rtc->alarm_enabled)\r\ndisable_irq(rtc->alarm_irq);\r\nret = regmap_update_bits(rtc->regmap, CPCAP_REG_DAYA, DAY_MASK,\r\ncpcap_tm.day);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TODA2, TOD2_MASK,\r\ncpcap_tm.tod2);\r\nret |= regmap_update_bits(rtc->regmap, CPCAP_REG_TODA1, TOD1_MASK,\r\ncpcap_tm.tod1);\r\nif (!ret) {\r\nenable_irq(rtc->alarm_irq);\r\nrtc->alarm_enabled = true;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t cpcap_rtc_alarm_irq(int irq, void *data)\r\n{\r\nstruct cpcap_rtc *rtc = data;\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_AF | RTC_IRQF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t cpcap_rtc_update_irq(int irq, void *data)\r\n{\r\nstruct cpcap_rtc *rtc = data;\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_UF | RTC_IRQF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int cpcap_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct cpcap_rtc *rtc;\r\nint err;\r\nrtc = devm_kzalloc(dev, sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->regmap = dev_get_regmap(dev->parent, NULL);\r\nif (!rtc->regmap)\r\nreturn -ENODEV;\r\nplatform_set_drvdata(pdev, rtc);\r\nrtc->rtc_dev = devm_rtc_device_register(dev, "cpcap_rtc",\r\n&cpcap_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev))\r\nreturn PTR_ERR(rtc->rtc_dev);\r\nerr = cpcap_get_vendor(dev, rtc->regmap, &rtc->vendor);\r\nif (err)\r\nreturn err;\r\nrtc->alarm_irq = platform_get_irq(pdev, 0);\r\nerr = devm_request_threaded_irq(dev, rtc->alarm_irq, NULL,\r\ncpcap_rtc_alarm_irq, IRQF_TRIGGER_NONE,\r\n"rtc_alarm", rtc);\r\nif (err) {\r\ndev_err(dev, "Could not request alarm irq: %d\n", err);\r\nreturn err;\r\n}\r\ndisable_irq(rtc->alarm_irq);\r\nrtc->update_irq = platform_get_irq(pdev, 1);\r\nerr = devm_request_threaded_irq(dev, rtc->update_irq, NULL,\r\ncpcap_rtc_update_irq, IRQF_TRIGGER_NONE,\r\n"rtc_1hz", rtc);\r\nif (err) {\r\ndev_err(dev, "Could not request update irq: %d\n", err);\r\nreturn err;\r\n}\r\ndisable_irq(rtc->update_irq);\r\nerr = device_init_wakeup(dev, 1);\r\nif (err) {\r\ndev_err(dev, "wakeup initialization failed (%d)\n", err);\r\n}\r\nreturn 0;\r\n}

static irqreturn_t pm80x_onkey_handler(int irq, void *data)\r\n{\r\nstruct pm80x_onkey_info *info = data;\r\nint ret = 0;\r\nunsigned int val;\r\nret = regmap_read(info->map, PM800_STATUS_1, &val);\r\nif (ret < 0) {\r\ndev_err(info->idev->dev.parent, "failed to read status: %d\n", ret);\r\nreturn IRQ_NONE;\r\n}\r\nval &= PM800_ONKEY_STS1;\r\ninput_report_key(info->idev, KEY_POWER, val);\r\ninput_sync(info->idev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pm80x_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct pm80x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm80x_onkey_info *info;\r\nint err;\r\ninfo = kzalloc(sizeof(struct pm80x_onkey_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->pm80x = chip;\r\ninfo->irq = platform_get_irq(pdev, 0);\r\nif (info->irq < 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\ninfo->map = info->pm80x->regmap;\r\nif (!info->map) {\r\ndev_err(&pdev->dev, "no regmap!\n");\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\ninfo->idev = input_allocate_device();\r\nif (!info->idev) {\r\ndev_err(&pdev->dev, "Failed to allocate input dev\n");\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\ninfo->idev->name = "88pm80x_on";\r\ninfo->idev->phys = "88pm80x_on/input0";\r\ninfo->idev->id.bustype = BUS_I2C;\r\ninfo->idev->dev.parent = &pdev->dev;\r\ninfo->idev->evbit[0] = BIT_MASK(EV_KEY);\r\n__set_bit(KEY_POWER, info->idev->keybit);\r\nerr = pm80x_request_irq(info->pm80x, info->irq, pm80x_onkey_handler,\r\nIRQF_ONESHOT, "onkey", info);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "Failed to request IRQ: #%d: %d\n",\r\ninfo->irq, err);\r\ngoto out_reg;\r\n}\r\nerr = input_register_device(info->idev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Can't register input device: %d\n", err);\r\ngoto out_irq;\r\n}\r\nplatform_set_drvdata(pdev, info);\r\nregmap_update_bits(info->map, PM800_RTC_MISC4, PM800_LONG_ONKEY_EN,\r\nPM800_LONG_ONKEY_EN);\r\nregmap_update_bits(info->map, PM800_RTC_MISC3,\r\nPM800_LONKEY_PRESS_TIME_MASK,\r\nPM800_LONKEY_PRESS_TIME);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nout_irq:\r\npm80x_free_irq(info->pm80x, info->irq, info);\r\nout_reg:\r\ninput_free_device(info->idev);\r\nout:\r\nkfree(info);\r\nreturn err;\r\n}\r\nstatic int pm80x_onkey_remove(struct platform_device *pdev)\r\n{\r\nstruct pm80x_onkey_info *info = platform_get_drvdata(pdev);\r\npm80x_free_irq(info->pm80x, info->irq, info);\r\ninput_unregister_device(info->idev);\r\nkfree(info);\r\nreturn 0;\r\n}

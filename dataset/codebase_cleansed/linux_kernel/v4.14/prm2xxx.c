static u32 omap2xxx_prm_read_reset_sources(void)\r\n{\r\nstruct prm_reset_src_map *p;\r\nu32 r = 0;\r\nu32 v;\r\nv = omap2_prm_read_mod_reg(WKUP_MOD, OMAP2_RM_RSTST);\r\np = omap2xxx_prm_reset_src_map;\r\nwhile (p->reg_shift >= 0 && p->std_shift >= 0) {\r\nif (v & (1 << p->reg_shift))\r\nr |= 1 << p->std_shift;\r\np++;\r\n}\r\nreturn r;\r\n}\r\nstatic int omap2xxx_pwrst_to_common_pwrst(u8 omap2xxx_pwrst)\r\n{\r\nu8 pwrst;\r\nswitch (omap2xxx_pwrst) {\r\ncase OMAP24XX_PWRDM_POWER_OFF:\r\npwrst = PWRDM_POWER_OFF;\r\nbreak;\r\ncase OMAP24XX_PWRDM_POWER_RET:\r\npwrst = PWRDM_POWER_RET;\r\nbreak;\r\ncase OMAP24XX_PWRDM_POWER_ON:\r\npwrst = PWRDM_POWER_ON;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn pwrst;\r\n}\r\nstatic void omap2xxx_prm_dpll_reset(void)\r\n{\r\nomap2_prm_set_mod_reg_bits(OMAP_RST_DPLL3_MASK, WKUP_MOD,\r\nOMAP2_RM_RSTCTRL);\r\nomap2_prm_read_mod_reg(WKUP_MOD, OMAP2_RM_RSTCTRL);\r\n}\r\nstatic int omap2xxx_prm_clear_mod_irqs(s16 module, u8 regs, u32 wkst_mask)\r\n{\r\nu32 wkst;\r\nwkst = omap2_prm_read_mod_reg(module, regs);\r\nwkst &= wkst_mask;\r\nomap2_prm_write_mod_reg(wkst, module, regs);\r\nreturn 0;\r\n}\r\nint omap2xxx_clkdm_sleep(struct clockdomain *clkdm)\r\n{\r\nomap2_prm_set_mod_reg_bits(OMAP24XX_FORCESTATE_MASK,\r\nclkdm->pwrdm.ptr->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nint omap2xxx_clkdm_wakeup(struct clockdomain *clkdm)\r\n{\r\nomap2_prm_clear_mod_reg_bits(OMAP24XX_FORCESTATE_MASK,\r\nclkdm->pwrdm.ptr->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2xxx_pwrdm_set_next_pwrst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nu8 omap24xx_pwrst;\r\nswitch (pwrst) {\r\ncase PWRDM_POWER_OFF:\r\nomap24xx_pwrst = OMAP24XX_PWRDM_POWER_OFF;\r\nbreak;\r\ncase PWRDM_POWER_RET:\r\nomap24xx_pwrst = OMAP24XX_PWRDM_POWER_RET;\r\nbreak;\r\ncase PWRDM_POWER_ON:\r\nomap24xx_pwrst = OMAP24XX_PWRDM_POWER_ON;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nomap2_prm_rmw_mod_reg_bits(OMAP_POWERSTATE_MASK,\r\n(omap24xx_pwrst << OMAP_POWERSTATE_SHIFT),\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2xxx_pwrdm_read_next_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu8 omap2xxx_pwrst;\r\nomap2xxx_pwrst = omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL,\r\nOMAP_POWERSTATE_MASK);\r\nreturn omap2xxx_pwrst_to_common_pwrst(omap2xxx_pwrst);\r\n}\r\nstatic int omap2xxx_pwrdm_read_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu8 omap2xxx_pwrst;\r\nomap2xxx_pwrst = omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTST,\r\nOMAP_POWERSTATEST_MASK);\r\nreturn omap2xxx_pwrst_to_common_pwrst(omap2xxx_pwrst);\r\n}\r\nint __init omap2xxx_prm_init(const struct omap_prcm_init_data *data)\r\n{\r\nreturn prm_register(&omap2xxx_prm_ll_data);\r\n}\r\nstatic void __exit omap2xxx_prm_exit(void)\r\n{\r\nprm_unregister(&omap2xxx_prm_ll_data);\r\n}

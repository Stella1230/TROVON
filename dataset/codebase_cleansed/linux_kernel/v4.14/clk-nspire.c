static void nspire_clkinfo_cx(u32 val, struct nspire_clk_info *clk)\r\n{\r\nif (EXTRACT(val, FIXED_BASE))\r\nclk->base_clock = 48 * MHZ;\r\nelse\r\nclk->base_clock = 6 * EXTRACT(val, CX_BASE) * MHZ;\r\nclk->base_cpu_ratio = EXTRACT(val, BASE_CPU) * EXTRACT(val, CX_UNKNOWN);\r\nclk->base_ahb_ratio = clk->base_cpu_ratio * (EXTRACT(val, CPU_AHB) + 1);\r\n}\r\nstatic void nspire_clkinfo_classic(u32 val, struct nspire_clk_info *clk)\r\n{\r\nif (EXTRACT(val, FIXED_BASE))\r\nclk->base_clock = 27 * MHZ;\r\nelse\r\nclk->base_clock = (300 - 6 * EXTRACT(val, CLASSIC_BASE)) * MHZ;\r\nclk->base_cpu_ratio = EXTRACT(val, BASE_CPU) * 2;\r\nclk->base_ahb_ratio = clk->base_cpu_ratio * (EXTRACT(val, CPU_AHB) + 1);\r\n}\r\nstatic void __init nspire_ahbdiv_setup(struct device_node *node,\r\nvoid (*get_clkinfo)(u32, struct nspire_clk_info *))\r\n{\r\nu32 val;\r\nvoid __iomem *io;\r\nstruct clk_hw *hw;\r\nconst char *clk_name = node->name;\r\nconst char *parent_name;\r\nstruct nspire_clk_info info;\r\nio = of_iomap(node, 0);\r\nif (!io)\r\nreturn;\r\nval = readl(io);\r\niounmap(io);\r\nget_clkinfo(val, &info);\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nparent_name = of_clk_get_parent_name(node, 0);\r\nhw = clk_hw_register_fixed_factor(NULL, clk_name, parent_name, 0,\r\n1, info.base_ahb_ratio);\r\nif (!IS_ERR(hw))\r\nof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\r\n}\r\nstatic void __init nspire_ahbdiv_setup_cx(struct device_node *node)\r\n{\r\nnspire_ahbdiv_setup(node, nspire_clkinfo_cx);\r\n}\r\nstatic void __init nspire_ahbdiv_setup_classic(struct device_node *node)\r\n{\r\nnspire_ahbdiv_setup(node, nspire_clkinfo_classic);\r\n}\r\nstatic void __init nspire_clk_setup(struct device_node *node,\r\nvoid (*get_clkinfo)(u32, struct nspire_clk_info *))\r\n{\r\nu32 val;\r\nvoid __iomem *io;\r\nstruct clk_hw *hw;\r\nconst char *clk_name = node->name;\r\nstruct nspire_clk_info info;\r\nio = of_iomap(node, 0);\r\nif (!io)\r\nreturn;\r\nval = readl(io);\r\niounmap(io);\r\nget_clkinfo(val, &info);\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nhw = clk_hw_register_fixed_rate(NULL, clk_name, NULL, 0,\r\ninfo.base_clock);\r\nif (!IS_ERR(hw))\r\nof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\r\nelse\r\nreturn;\r\npr_info("TI-NSPIRE Base: %uMHz CPU: %uMHz AHB: %uMHz\n",\r\ninfo.base_clock / MHZ,\r\ninfo.base_clock / info.base_cpu_ratio / MHZ,\r\ninfo.base_clock / info.base_ahb_ratio / MHZ);\r\n}\r\nstatic void __init nspire_clk_setup_cx(struct device_node *node)\r\n{\r\nnspire_clk_setup(node, nspire_clkinfo_cx);\r\n}\r\nstatic void __init nspire_clk_setup_classic(struct device_node *node)\r\n{\r\nnspire_clk_setup(node, nspire_clkinfo_classic);\r\n}

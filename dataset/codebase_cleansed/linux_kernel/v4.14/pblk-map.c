static void pblk_map_page_data(struct pblk *pblk, unsigned int sentry,\r\nstruct ppa_addr *ppa_list,\r\nunsigned long *lun_bitmap,\r\nstruct pblk_sec_meta *meta_list,\r\nunsigned int valid_secs)\r\n{\r\nstruct pblk_line *line = pblk_line_get_data(pblk);\r\nstruct pblk_emeta *emeta = line->emeta;\r\nstruct pblk_w_ctx *w_ctx;\r\n__le64 *lba_list = emeta_to_lbas(pblk, emeta->buf);\r\nu64 paddr;\r\nint nr_secs = pblk->min_write_pgs;\r\nint i;\r\npaddr = pblk_alloc_page(pblk, line, nr_secs);\r\nfor (i = 0; i < nr_secs; i++, paddr++) {\r\nppa_list[i] = addr_to_gen_ppa(pblk, paddr, line->id);\r\nif (i < valid_secs) {\r\nkref_get(&line->ref);\r\nw_ctx = pblk_rb_w_ctx(&pblk->rwb, sentry + i);\r\nw_ctx->ppa = ppa_list[i];\r\nmeta_list[i].lba = cpu_to_le64(w_ctx->lba);\r\nlba_list[paddr] = cpu_to_le64(w_ctx->lba);\r\nline->nr_valid_lbas++;\r\n} else {\r\n__le64 addr_empty = cpu_to_le64(ADDR_EMPTY);\r\nlba_list[paddr] = meta_list[i].lba = addr_empty;\r\n__pblk_map_invalidate(pblk, line, paddr);\r\n}\r\n}\r\nif (pblk_line_is_full(line)) {\r\nstruct pblk_line *prev_line = line;\r\npblk_line_replace_data(pblk);\r\npblk_line_close_meta(pblk, prev_line);\r\n}\r\npblk_down_rq(pblk, ppa_list, nr_secs, lun_bitmap);\r\n}\r\nvoid pblk_map_rq(struct pblk *pblk, struct nvm_rq *rqd, unsigned int sentry,\r\nunsigned long *lun_bitmap, unsigned int valid_secs,\r\nunsigned int off)\r\n{\r\nstruct pblk_sec_meta *meta_list = rqd->meta_list;\r\nunsigned int map_secs;\r\nint min = pblk->min_write_pgs;\r\nint i;\r\nfor (i = off; i < rqd->nr_ppas; i += min) {\r\nmap_secs = (i + min > valid_secs) ? (valid_secs % min) : min;\r\npblk_map_page_data(pblk, sentry + i, &rqd->ppa_list[i],\r\nlun_bitmap, &meta_list[i], map_secs);\r\n}\r\n}\r\nvoid pblk_map_erase_rq(struct pblk *pblk, struct nvm_rq *rqd,\r\nunsigned int sentry, unsigned long *lun_bitmap,\r\nunsigned int valid_secs, struct ppa_addr *erase_ppa)\r\n{\r\nstruct nvm_tgt_dev *dev = pblk->dev;\r\nstruct nvm_geo *geo = &dev->geo;\r\nstruct pblk_line_meta *lm = &pblk->lm;\r\nstruct pblk_sec_meta *meta_list = rqd->meta_list;\r\nstruct pblk_line *e_line, *d_line;\r\nunsigned int map_secs;\r\nint min = pblk->min_write_pgs;\r\nint i, erase_lun;\r\nfor (i = 0; i < rqd->nr_ppas; i += min) {\r\nmap_secs = (i + min > valid_secs) ? (valid_secs % min) : min;\r\npblk_map_page_data(pblk, sentry + i, &rqd->ppa_list[i],\r\nlun_bitmap, &meta_list[i], map_secs);\r\nerase_lun = pblk_ppa_to_pos(geo, rqd->ppa_list[i]);\r\ne_line = pblk_line_get_erase(pblk);\r\nif (!e_line)\r\nreturn pblk_map_rq(pblk, rqd, sentry, lun_bitmap,\r\nvalid_secs, i + min);\r\nspin_lock(&e_line->lock);\r\nif (!test_bit(erase_lun, e_line->erase_bitmap)) {\r\nset_bit(erase_lun, e_line->erase_bitmap);\r\natomic_dec(&e_line->left_eblks);\r\n*erase_ppa = rqd->ppa_list[i];\r\nerase_ppa->g.blk = e_line->id;\r\nspin_unlock(&e_line->lock);\r\nreturn pblk_map_rq(pblk, rqd, sentry, lun_bitmap,\r\nvalid_secs, i + min);\r\n}\r\nspin_unlock(&e_line->lock);\r\n}\r\nd_line = pblk_line_get_data(pblk);\r\ne_line = pblk_line_get_erase(pblk);\r\nif (!e_line)\r\nreturn;\r\nif (unlikely(ppa_empty(*erase_ppa)) &&\r\nbitmap_weight(d_line->blk_bitmap, lm->blk_per_line)) {\r\nint bit = -1;\r\nretry:\r\nbit = find_next_bit(d_line->blk_bitmap,\r\nlm->blk_per_line, bit + 1);\r\nif (bit >= lm->blk_per_line)\r\nreturn;\r\nspin_lock(&e_line->lock);\r\nif (test_bit(bit, e_line->erase_bitmap)) {\r\nspin_unlock(&e_line->lock);\r\ngoto retry;\r\n}\r\nspin_unlock(&e_line->lock);\r\nset_bit(bit, e_line->erase_bitmap);\r\natomic_dec(&e_line->left_eblks);\r\n*erase_ppa = pblk->luns[bit].bppa;\r\nerase_ppa->g.blk = e_line->id;\r\n}\r\n}

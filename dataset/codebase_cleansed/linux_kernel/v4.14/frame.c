void ia_css_frame_zero(struct ia_css_frame *frame)\r\n{\r\nassert(frame != NULL);\r\nmmgr_clear(frame->data, frame->data_bytes);\r\n}\r\nenum ia_css_err ia_css_frame_allocate_from_info(struct ia_css_frame **frame,\r\nconst struct ia_css_frame_info *info)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nif (frame == NULL || info == NULL)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_allocate_from_info() enter:\n");\r\nerr =\r\nia_css_frame_allocate(frame, info->res.width, info->res.height,\r\ninfo->format, info->padded_width,\r\ninfo->raw_bit_depth);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_allocate_from_info() leave:\n");\r\nreturn err;\r\n}\r\nenum ia_css_err ia_css_frame_allocate(struct ia_css_frame **frame,\r\nunsigned int width,\r\nunsigned int height,\r\nenum ia_css_frame_format format,\r\nunsigned int padded_width,\r\nunsigned int raw_bit_depth)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nif (frame == NULL || width == 0 || height == 0)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n#ifndef ISP2401\r\n"ia_css_frame_allocate() enter: width=%d, height=%d, format=%d\n",\r\nwidth, height, format);\r\n#else\r\n"ia_css_frame_allocate() enter: width=%d, height=%d, format=%d, padded_width=%d, raw_bit_depth=%d\n",\r\nwidth, height, format, padded_width, raw_bit_depth);\r\nia_css_err ia_css_frame_map(struct ia_css_frame **frame,\r\nconst struct ia_css_frame_info *info,\r\nconst void *data,\r\nuint16_t attribute,\r\nvoid *context)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nstruct ia_css_frame *me;\r\nassert(frame != NULL);\r\nerr = ia_css_frame_create_from_info(&me, info);\r\nif (err != IA_CSS_SUCCESS)\r\nreturn err;\r\nif (err == IA_CSS_SUCCESS) {\r\nme->data = (ia_css_ptr) mmgr_mmap(data,\r\nme->data_bytes,\r\nattribute, context);\r\nif (me->data == mmgr_NULL)\r\nerr = IA_CSS_ERR_INVALID_ARGUMENTS;\r\n};\r\nif (err != IA_CSS_SUCCESS) {\r\nsh_css_free(me);\r\n#ifndef ISP2401\r\nreturn err;\r\n#else\r\nme = NULL;\r\n#endif\r\n}\r\n*frame = me;\r\nreturn err;\r\n}\r\nenum ia_css_err ia_css_frame_create_from_info(struct ia_css_frame **frame,\r\nconst struct ia_css_frame_info *info)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nstruct ia_css_frame *me;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_create_from_info() enter:\n");\r\nif (frame == NULL || info == NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_create_from_info() leave:"\r\n" invalid arguments\n");\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nme = frame_create(info->res.width,\r\ninfo->res.height,\r\ninfo->format,\r\ninfo->padded_width,\r\ninfo->raw_bit_depth,\r\nfalse,\r\nfalse);\r\nif (me == NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_create_from_info() leave:"\r\n" frame create failed\n");\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nerr = ia_css_frame_init_planes(me);\r\n#ifndef ISP2401\r\nif (err == IA_CSS_SUCCESS)\r\n*frame = me;\r\nelse\r\n#else\r\nif (err != IA_CSS_SUCCESS) {\r\n#endif\r\nsh_css_free(me);\r\n#ifdef ISP2401\r\nme = NULL;\r\n}\r\n*frame = me;\r\n#endif\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "ia_css_frame_create_from_info() leave:\n");\r\nreturn err;\r\n}\r\nenum ia_css_err ia_css_frame_set_data(struct ia_css_frame *frame,\r\nconst ia_css_ptr mapped_data,\r\nsize_t data_bytes)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_set_data() enter:\n");\r\nif (frame == NULL) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_set_data() leave: NULL frame\n");\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nif ((mapped_data != mmgr_NULL) && (frame->data_bytes > data_bytes)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_set_data() leave: invalid arguments\n");\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nframe->data = mapped_data;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, "ia_css_frame_set_data() leave:\n");\r\nreturn err;\r\n}\r\nenum ia_css_err ia_css_frame_allocate_contiguous(struct ia_css_frame **frame,\r\nunsigned int width,\r\nunsigned int height,\r\nenum ia_css_frame_format format,\r\nunsigned int padded_width,\r\nunsigned int raw_bit_depth)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_allocate_contiguous() "\r\n#ifndef ISP2401\r\n"enter: width=%d, height=%d, format=%d\n",\r\nwidth, height, format);\r\n#else\r\n"enter: width=%d, height=%d, format=%d, padded_width=%d, raw_bit_depth=%d\n",\r\nwidth, height, format, padded_width, raw_bit_depth);\r\nia_css_err ia_css_frame_allocate_contiguous_from_info(\r\nstruct ia_css_frame **frame,\r\nconst struct ia_css_frame_info *info)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nassert(frame != NULL);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_allocate_contiguous_from_info() enter:\n");\r\nerr = ia_css_frame_allocate_contiguous(frame,\r\ninfo->res.width,\r\ninfo->res.height,\r\ninfo->format,\r\ninfo->padded_width,\r\ninfo->raw_bit_depth);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_allocate_contiguous_from_info() leave:\n");\r\nreturn err;\r\n}\r\nvoid ia_css_frame_free(struct ia_css_frame *frame)\r\n{\r\nIA_CSS_ENTER_PRIVATE("frame = %p", frame);\r\nif (frame != NULL) {\r\nhmm_free(frame->data);\r\nsh_css_free(frame);\r\n}\r\nIA_CSS_LEAVE_PRIVATE("void");\r\n}\r\nenum ia_css_err ia_css_frame_check_info(const struct ia_css_frame_info *info)\r\n{\r\nassert(info != NULL);\r\nif (info->res.width == 0 || info->res.height == 0)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nenum ia_css_err ia_css_frame_init_planes(struct ia_css_frame *frame)\r\n{\r\nassert(frame != NULL);\r\nswitch (frame->info.format) {\r\ncase IA_CSS_FRAME_FORMAT_MIPI:\r\nframe_init_mipi_plane(frame, &frame->planes.raw,\r\nframe->info.res.height,\r\nframe->info.padded_width,\r\nframe->info.raw_bit_depth <= 8 ? 1 : 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_RAW_PACKED:\r\nframe_init_raw_single_plane(frame, &frame->planes.raw,\r\nframe->info.res.height,\r\nframe->info.padded_width,\r\nframe->info.raw_bit_depth);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_RAW:\r\nframe_init_single_plane(frame, &frame->planes.raw,\r\nframe->info.res.height,\r\nframe->info.padded_width,\r\nframe->info.raw_bit_depth <= 8 ? 1 : 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_RGB565:\r\nframe_init_single_plane(frame, &frame->planes.rgb,\r\nframe->info.res.height,\r\nframe->info.padded_width, 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_RGBA888:\r\nframe_init_single_plane(frame, &frame->planes.rgb,\r\nframe->info.res.height,\r\nframe->info.padded_width * 4, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_PLANAR_RGB888:\r\nframe_init_rgb_planes(frame, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUYV:\r\ncase IA_CSS_FRAME_FORMAT_UYVY:\r\ncase IA_CSS_FRAME_FORMAT_CSI_MIPI_YUV420_8:\r\ncase IA_CSS_FRAME_FORMAT_CSI_MIPI_LEGACY_YUV420_8:\r\nframe_init_single_plane(frame, &frame->planes.yuyv,\r\nframe->info.res.height,\r\nframe->info.padded_width * 2, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV_LINE:\r\nframe_init_single_plane(frame, &frame->planes.yuyv,\r\nframe->info.res.height * 3 / 2 + 3,\r\nframe->info.padded_width, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_NV11:\r\nframe_init_nv_planes(frame, 4, 1, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_NV12:\r\ncase IA_CSS_FRAME_FORMAT_NV21:\r\ncase IA_CSS_FRAME_FORMAT_NV12_TILEY:\r\nframe_init_nv_planes(frame, 2, 2, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_NV12_16:\r\nframe_init_nv_planes(frame, 2, 2, 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_NV16:\r\ncase IA_CSS_FRAME_FORMAT_NV61:\r\nframe_init_nv_planes(frame, 2, 1, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV420:\r\nframe_init_yuv_planes(frame, 2, 2, false, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV422:\r\nframe_init_yuv_planes(frame, 2, 1, false, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV444:\r\nframe_init_yuv_planes(frame, 1, 1, false, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV420_16:\r\nframe_init_yuv_planes(frame, 2, 2, false, 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YUV422_16:\r\nframe_init_yuv_planes(frame, 2, 1, false, 2);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YV12:\r\nframe_init_yuv_planes(frame, 2, 2, true, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_YV16:\r\nframe_init_yuv_planes(frame, 2, 1, true, 1);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_QPLANE6:\r\nframe_init_qplane6_planes(frame);\r\nbreak;\r\ncase IA_CSS_FRAME_FORMAT_BINARY_8:\r\nframe_init_single_plane(frame, &frame->planes.binary.data,\r\nframe->info.res.height,\r\nframe->info.padded_width, 1);\r\nframe->planes.binary.size = 0;\r\nbreak;\r\ndefault:\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n}\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nvoid ia_css_frame_info_set_width(struct ia_css_frame_info *info,\r\nunsigned int width,\r\nunsigned int min_padded_width)\r\n{\r\nunsigned int align;\r\nIA_CSS_ENTER_PRIVATE("info = %p,width = %d, minimum padded width = %d",\r\ninfo, width, min_padded_width);\r\nif (info == NULL) {\r\nIA_CSS_ERROR("NULL input parameter");\r\nIA_CSS_LEAVE_PRIVATE("");\r\nreturn;\r\n}\r\nif (min_padded_width > width)\r\nalign = min_padded_width;\r\nelse\r\nalign = width;\r\ninfo->res.width = width;\r\nif (info->format == IA_CSS_FRAME_FORMAT_YUV420 ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_YV12 ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_NV12 ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_NV21 ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_BINARY_8 ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_YUV_LINE)\r\ninfo->padded_width =\r\nCEIL_MUL(align, 2 * HIVE_ISP_DDR_WORD_BYTES);\r\nelse if (info->format == IA_CSS_FRAME_FORMAT_NV12_TILEY)\r\ninfo->padded_width = CEIL_MUL(align, NV12_TILEY_TILE_WIDTH);\r\nelse if (info->format == IA_CSS_FRAME_FORMAT_RAW ||\r\ninfo->format == IA_CSS_FRAME_FORMAT_RAW_PACKED)\r\ninfo->padded_width = CEIL_MUL(align, 2 * ISP_VEC_NELEMS);\r\nelse {\r\ninfo->padded_width = CEIL_MUL(align, HIVE_ISP_DDR_WORD_BYTES);\r\n}\r\nIA_CSS_LEAVE_PRIVATE("");\r\n}\r\nvoid ia_css_frame_info_set_format(struct ia_css_frame_info *info,\r\nenum ia_css_frame_format format)\r\n{\r\nassert(info != NULL);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_info_set_format() enter:\n");\r\ninfo->format = format;\r\n}\r\nvoid ia_css_frame_info_init(struct ia_css_frame_info *info,\r\nunsigned int width,\r\nunsigned int height,\r\nenum ia_css_frame_format format,\r\nunsigned int aligned)\r\n{\r\nIA_CSS_ENTER_PRIVATE("info = %p, width = %d, height = %d, format = %d, aligned = %d",\r\ninfo, width, height, format, aligned);\r\nif (info == NULL) {\r\nIA_CSS_ERROR("NULL input parameter");\r\nIA_CSS_LEAVE_PRIVATE("");\r\nreturn;\r\n}\r\ninfo->res.height = height;\r\ninfo->format = format;\r\nia_css_frame_info_set_width(info, width, aligned);\r\nIA_CSS_LEAVE_PRIVATE("");\r\n}\r\nvoid ia_css_frame_free_multiple(unsigned int num_frames,\r\nstruct ia_css_frame **frames_array)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < num_frames; i++) {\r\nif (frames_array[i]) {\r\nia_css_frame_free(frames_array[i]);\r\nframes_array[i] = NULL;\r\n}\r\n}\r\n}\r\nenum ia_css_err ia_css_frame_allocate_with_buffer_size(\r\nstruct ia_css_frame **frame,\r\nconst unsigned int buffer_size_bytes,\r\nconst bool contiguous)\r\n{\r\nenum ia_css_err err;\r\nstruct ia_css_frame *me = frame_create(0, 0,\r\nIA_CSS_FRAME_FORMAT_NUM,\r\n0, 0, contiguous, false);\r\nif (me == NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nme->data_bytes = buffer_size_bytes;\r\nerr = frame_allocate_buffer_data(me);\r\nif (err != IA_CSS_SUCCESS) {\r\nsh_css_free(me);\r\n#ifndef ISP2401\r\nreturn err;\r\n#else\r\nme = NULL;\r\n#endif\r\n}\r\n*frame = me;\r\nreturn err;\r\n}\r\nbool ia_css_frame_info_is_same_resolution(\r\nconst struct ia_css_frame_info *info_a,\r\nconst struct ia_css_frame_info *info_b)\r\n{\r\nif (!info_a || !info_b)\r\nreturn false;\r\nreturn (info_a->res.width == info_b->res.width) &&\r\n(info_a->res.height == info_b->res.height);\r\n}\r\nbool ia_css_frame_is_same_type(const struct ia_css_frame *frame_a,\r\nconst struct ia_css_frame *frame_b)\r\n{\r\nbool is_equal = false;\r\nconst struct ia_css_frame_info *info_a = &frame_a->info,\r\n*info_b = &frame_b->info;\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_is_same_type() enter:\n");\r\nif (!info_a || !info_b)\r\nreturn false;\r\nif (info_a->format != info_b->format)\r\nreturn false;\r\nif (info_a->padded_width != info_b->padded_width)\r\nreturn false;\r\nis_equal = ia_css_frame_info_is_same_resolution(info_a, info_b);\r\nia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\r\n"ia_css_frame_is_same_type() leave:\n");\r\nreturn is_equal;\r\n}\r\nvoid\r\nia_css_dma_configure_from_info(\r\nstruct dma_port_config *config,\r\nconst struct ia_css_frame_info *info)\r\n{\r\nunsigned is_raw_packed = info->format == IA_CSS_FRAME_FORMAT_RAW_PACKED;\r\nunsigned bits_per_pixel = is_raw_packed ? info->raw_bit_depth : ia_css_elems_bytes_from_info(info)*8;\r\nunsigned pix_per_ddrword = HIVE_ISP_DDR_WORD_BITS / bits_per_pixel;\r\nunsigned words_per_line = CEIL_DIV(info->padded_width, pix_per_ddrword);\r\nunsigned elems_b = pix_per_ddrword;\r\nconfig->stride = HIVE_ISP_DDR_WORD_BYTES * words_per_line;\r\nconfig->elems = (uint8_t)elems_b;\r\nconfig->width = (uint16_t)info->res.width;\r\nconfig->crop = 0;\r\nassert(config->width <= info->padded_width);\r\n}\r\nstatic void frame_init_plane(struct ia_css_frame_plane *plane,\r\nunsigned int width,\r\nunsigned int stride,\r\nunsigned int height,\r\nunsigned int offset)\r\n{\r\nplane->height = height;\r\nplane->width = width;\r\nplane->stride = stride;\r\nplane->offset = offset;\r\n}\r\nstatic void frame_init_single_plane(struct ia_css_frame *frame,\r\nstruct ia_css_frame_plane *plane,\r\nunsigned int height,\r\nunsigned int subpixels_per_line,\r\nunsigned int bytes_per_pixel)\r\n{\r\nunsigned int stride;\r\nstride = subpixels_per_line * bytes_per_pixel;\r\nframe->data_bytes = stride * CEIL_MUL2(height, 2);\r\nframe_init_plane(plane, subpixels_per_line, stride, height, 0);\r\nreturn;\r\n}\r\nstatic void frame_init_raw_single_plane(\r\nstruct ia_css_frame *frame,\r\nstruct ia_css_frame_plane *plane,\r\nunsigned int height,\r\nunsigned int subpixels_per_line,\r\nunsigned int bits_per_pixel)\r\n{\r\nunsigned int stride;\r\nassert(frame != NULL);\r\nstride = HIVE_ISP_DDR_WORD_BYTES *\r\nCEIL_DIV(subpixels_per_line,\r\nHIVE_ISP_DDR_WORD_BITS / bits_per_pixel);\r\nframe->data_bytes = stride * height;\r\nframe_init_plane(plane, subpixels_per_line, stride, height, 0);\r\nreturn;\r\n}\r\nstatic void frame_init_mipi_plane(struct ia_css_frame *frame,\r\nstruct ia_css_frame_plane *plane,\r\nunsigned int height,\r\nunsigned int subpixels_per_line,\r\nunsigned int bytes_per_pixel)\r\n{\r\nunsigned int stride;\r\nstride = subpixels_per_line * bytes_per_pixel;\r\nframe->data_bytes = 8388608;\r\nframe->valid = false;\r\nframe->contiguous = true;\r\nframe_init_plane(plane, subpixels_per_line, stride, height, 0);\r\nreturn;\r\n}\r\nstatic void frame_init_nv_planes(struct ia_css_frame *frame,\r\nunsigned int horizontal_decimation,\r\nunsigned int vertical_decimation,\r\nunsigned int bytes_per_element)\r\n{\r\nunsigned int y_width = frame->info.padded_width;\r\nunsigned int y_height = frame->info.res.height;\r\nunsigned int uv_width;\r\nunsigned int uv_height;\r\nunsigned int y_bytes;\r\nunsigned int uv_bytes;\r\nunsigned int y_stride;\r\nunsigned int uv_stride;\r\nassert(horizontal_decimation != 0 && vertical_decimation != 0);\r\nuv_width = 2 * (y_width / horizontal_decimation);\r\nuv_height = y_height / vertical_decimation;\r\nif (IA_CSS_FRAME_FORMAT_NV12_TILEY == frame->info.format) {\r\ny_width = CEIL_MUL(y_width, NV12_TILEY_TILE_WIDTH);\r\nuv_width = CEIL_MUL(uv_width, NV12_TILEY_TILE_WIDTH);\r\ny_height = CEIL_MUL(y_height, NV12_TILEY_TILE_HEIGHT);\r\nuv_height = CEIL_MUL(uv_height, NV12_TILEY_TILE_HEIGHT);\r\n}\r\ny_stride = y_width * bytes_per_element;\r\nuv_stride = uv_width * bytes_per_element;\r\ny_bytes = y_stride * y_height;\r\nuv_bytes = uv_stride * uv_height;\r\nframe->data_bytes = y_bytes + uv_bytes;\r\nframe_init_plane(&frame->planes.nv.y, y_width, y_stride, y_height, 0);\r\nframe_init_plane(&frame->planes.nv.uv, uv_width,\r\nuv_stride, uv_height, y_bytes);\r\nreturn;\r\n}\r\nstatic void frame_init_yuv_planes(struct ia_css_frame *frame,\r\nunsigned int horizontal_decimation,\r\nunsigned int vertical_decimation,\r\nbool swap_uv,\r\nunsigned int bytes_per_element)\r\n{\r\nunsigned int y_width = frame->info.padded_width,\r\ny_height = frame->info.res.height,\r\nuv_width = y_width / horizontal_decimation,\r\nuv_height = y_height / vertical_decimation,\r\ny_stride, y_bytes, uv_bytes, uv_stride;\r\ny_stride = y_width * bytes_per_element;\r\nuv_stride = uv_width * bytes_per_element;\r\ny_bytes = y_stride * y_height;\r\nuv_bytes = uv_stride * uv_height;\r\nframe->data_bytes = y_bytes + 2 * uv_bytes;\r\nframe_init_plane(&frame->planes.yuv.y, y_width, y_stride, y_height, 0);\r\nif (swap_uv) {\r\nframe_init_plane(&frame->planes.yuv.v, uv_width, uv_stride,\r\nuv_height, y_bytes);\r\nframe_init_plane(&frame->planes.yuv.u, uv_width, uv_stride,\r\nuv_height, y_bytes + uv_bytes);\r\n} else {\r\nframe_init_plane(&frame->planes.yuv.u, uv_width, uv_stride,\r\nuv_height, y_bytes);\r\nframe_init_plane(&frame->planes.yuv.v, uv_width, uv_stride,\r\nuv_height, y_bytes + uv_bytes);\r\n}\r\nreturn;\r\n}\r\nstatic void frame_init_rgb_planes(struct ia_css_frame *frame,\r\nunsigned int bytes_per_element)\r\n{\r\nunsigned int width = frame->info.res.width,\r\nheight = frame->info.res.height, stride, bytes;\r\nstride = width * bytes_per_element;\r\nbytes = stride * height;\r\nframe->data_bytes = 3 * bytes;\r\nframe_init_plane(&frame->planes.planar_rgb.r, width, stride, height, 0);\r\nframe_init_plane(&frame->planes.planar_rgb.g,\r\nwidth, stride, height, 1 * bytes);\r\nframe_init_plane(&frame->planes.planar_rgb.b,\r\nwidth, stride, height, 2 * bytes);\r\nreturn;\r\n}\r\nstatic void frame_init_qplane6_planes(struct ia_css_frame *frame)\r\n{\r\nunsigned int width = frame->info.padded_width / 2,\r\nheight = frame->info.res.height / 2, bytes, stride;\r\nstride = width * 2;\r\nbytes = stride * height;\r\nframe->data_bytes = 6 * bytes;\r\nframe_init_plane(&frame->planes.plane6.r,\r\nwidth, stride, height, 0 * bytes);\r\nframe_init_plane(&frame->planes.plane6.r_at_b,\r\nwidth, stride, height, 1 * bytes);\r\nframe_init_plane(&frame->planes.plane6.gr,\r\nwidth, stride, height, 2 * bytes);\r\nframe_init_plane(&frame->planes.plane6.gb,\r\nwidth, stride, height, 3 * bytes);\r\nframe_init_plane(&frame->planes.plane6.b,\r\nwidth, stride, height, 4 * bytes);\r\nframe_init_plane(&frame->planes.plane6.b_at_r,\r\nwidth, stride, height, 5 * bytes);\r\nreturn;\r\n}\r\nstatic enum ia_css_err frame_allocate_buffer_data(struct ia_css_frame *frame)\r\n{\r\n#ifdef ISP2401\r\nIA_CSS_ENTER_LEAVE_PRIVATE("frame->data_bytes=%d\n", frame->data_bytes);\r\n#endif\r\nframe->data = mmgr_alloc_attr(frame->data_bytes,\r\nframe->contiguous ?\r\nMMGR_ATTRIBUTE_CONTIGUOUS :\r\nMMGR_ATTRIBUTE_DEFAULT);\r\nif (frame->data == mmgr_NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic enum ia_css_err frame_allocate_with_data(struct ia_css_frame **frame,\r\nunsigned int width,\r\nunsigned int height,\r\nenum ia_css_frame_format format,\r\nunsigned int padded_width,\r\nunsigned int raw_bit_depth,\r\nbool contiguous)\r\n{\r\nenum ia_css_err err;\r\nstruct ia_css_frame *me = frame_create(width,\r\nheight,\r\nformat,\r\npadded_width,\r\nraw_bit_depth,\r\ncontiguous,\r\ntrue);\r\nif (me == NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nerr = ia_css_frame_init_planes(me);\r\nif (err == IA_CSS_SUCCESS)\r\nerr = frame_allocate_buffer_data(me);\r\nif (err != IA_CSS_SUCCESS) {\r\nsh_css_free(me);\r\n#ifndef ISP2401\r\nreturn err;\r\n#else\r\nme = NULL;\r\n#endif\r\n}\r\n*frame = me;\r\nreturn err;\r\n}\r\nstatic struct ia_css_frame *frame_create(unsigned int width,\r\nunsigned int height,\r\nenum ia_css_frame_format format,\r\nunsigned int padded_width,\r\nunsigned int raw_bit_depth,\r\nbool contiguous,\r\nbool valid)\r\n{\r\nstruct ia_css_frame *me = sh_css_malloc(sizeof(*me));\r\nif (me == NULL)\r\nreturn NULL;\r\nmemset(me, 0, sizeof(*me));\r\nme->info.res.width = width;\r\nme->info.res.height = height;\r\nme->info.format = format;\r\nme->info.padded_width = padded_width;\r\nme->info.raw_bit_depth = raw_bit_depth;\r\nme->contiguous = contiguous;\r\nme->valid = valid;\r\nme->data_bytes = 0;\r\nme->data = mmgr_NULL;\r\nme->dynamic_queue_id = (int)SH_CSS_INVALID_QUEUE_ID;\r\nme->buf_type = IA_CSS_BUFFER_TYPE_INVALID;\r\nreturn me;\r\n}\r\nstatic unsigned\r\nia_css_elems_bytes_from_info(const struct ia_css_frame_info *info)\r\n{\r\nif (info->format == IA_CSS_FRAME_FORMAT_RGB565)\r\nreturn 2;\r\nif (info->format == IA_CSS_FRAME_FORMAT_YUV420_16)\r\nreturn 2;\r\nif (info->format == IA_CSS_FRAME_FORMAT_YUV422_16)\r\nreturn 2;\r\nif (info->format == IA_CSS_FRAME_FORMAT_NV12_16)\r\nreturn 1;\r\nif (info->format == IA_CSS_FRAME_FORMAT_RAW\r\n|| (info->format == IA_CSS_FRAME_FORMAT_RAW_PACKED)) {\r\nif (info->raw_bit_depth)\r\nreturn CEIL_DIV(info->raw_bit_depth,8);\r\nelse\r\nreturn 2;\r\n}\r\nif (info->format == IA_CSS_FRAME_FORMAT_PLANAR_RGB888)\r\nreturn 3;\r\nif (info->format == IA_CSS_FRAME_FORMAT_RGBA888)\r\nreturn 4;\r\nif (info->format == IA_CSS_FRAME_FORMAT_QPLANE6)\r\nreturn 2;\r\nreturn 1;\r\n}\r\nvoid ia_css_frame_info_to_frame_sp_info(\r\nstruct ia_css_frame_sp_info *to,\r\nconst struct ia_css_frame_info *from)\r\n{\r\nia_css_resolution_to_sp_resolution(&to->res, &from->res);\r\nto->padded_width = (uint16_t)from->padded_width;\r\nto->format = (uint8_t)from->format;\r\nto->raw_bit_depth = (uint8_t)from->raw_bit_depth;\r\nto->raw_bayer_order = from->raw_bayer_order;\r\n}\r\nvoid ia_css_resolution_to_sp_resolution(\r\nstruct ia_css_sp_resolution *to,\r\nconst struct ia_css_resolution *from)\r\n{\r\nto->width = (uint16_t)from->width;\r\nto->height = (uint16_t)from->height;\r\n}\r\nenum ia_css_err\r\nia_css_frame_find_crop_resolution(const struct ia_css_resolution *in_res,\r\nconst struct ia_css_resolution *out_res,\r\nstruct ia_css_resolution *crop_res)\r\n{\r\nuint32_t wd_even_ceil, ht_even_ceil;\r\nuint32_t in_ratio, out_ratio;\r\nif ((in_res == NULL) || (out_res == NULL) || (crop_res == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nIA_CSS_ENTER_PRIVATE("in(%ux%u) -> out(%ux%u)", in_res->width,\r\nin_res->height, out_res->width, out_res->height);\r\nif ((in_res->width == 0)\r\n|| (in_res->height == 0)\r\n|| (out_res->width == 0)\r\n|| (out_res->height == 0))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nif ((out_res->width > in_res->width) ||\r\n(out_res->height > in_res->height))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nin_ratio = in_res->width * out_res->height;\r\nout_ratio = out_res->width * in_res->height;\r\nif (in_ratio == out_ratio) {\r\ncrop_res->width = in_res->width;\r\ncrop_res->height = in_res->height;\r\n} else if (out_ratio > in_ratio) {\r\ncrop_res->width = in_res->width;\r\ncrop_res->height = ROUND_DIV(out_res->height * crop_res->width,\r\nout_res->width);\r\n} else {\r\ncrop_res->height = in_res->height;\r\ncrop_res->width = ROUND_DIV(out_res->width * crop_res->height,\r\nout_res->height);\r\n}\r\nwd_even_ceil = EVEN_CEIL(crop_res->width);\r\nht_even_ceil = EVEN_CEIL(crop_res->height);\r\nif ((wd_even_ceil > in_res->width) || (ht_even_ceil > in_res->height)) {\r\ncrop_res->width = EVEN_FLOOR(crop_res->width);\r\ncrop_res->height = EVEN_FLOOR(crop_res->height);\r\n} else {\r\ncrop_res->width = wd_even_ceil;\r\ncrop_res->height = ht_even_ceil;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("in(%ux%u) -> out(%ux%u)", crop_res->width,\r\ncrop_res->height, out_res->width, out_res->height);\r\nreturn IA_CSS_SUCCESS;\r\n}

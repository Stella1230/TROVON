static void rs5c313_init_port(void)\r\n{\r\n__raw_writeb(__raw_readb(SCSMR1) & ~SCSMR1_CA, SCSMR1);\r\n__raw_writeb(__raw_readb(SCSCR1) & ~SCSCR1_CKE, SCSCR1);\r\nscsptr1_data = __raw_readb(SCSPTR1) | SCL;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\nscsptr1_data = __raw_readb(SCSPTR1) | SCL_OEN;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\nRS5C313_CEDISABLE;\r\n}\r\nstatic void rs5c313_write_data(unsigned char data)\r\n{\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nscsptr1_data = (scsptr1_data & ~SDA) |\r\n((((0x80 >> i) & data) >> (7 - i)) << 2);\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\nif (i == 0) {\r\nscsptr1_data |= SDA_OEN;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\n}\r\nndelay(700);\r\nscsptr1_data &= ~SCL;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\nndelay(700);\r\nscsptr1_data |= SCL;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\n}\r\nscsptr1_data &= ~SDA_OEN;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\n}\r\nstatic unsigned char rs5c313_read_data(void)\r\n{\r\nint i;\r\nunsigned char data = 0;\r\nfor (i = 0; i < 8; i++) {\r\nndelay(700);\r\ndata |= ((__raw_readb(SCSPTR1) & SDA) >> 2) << (7 - i);\r\nscsptr1_data &= ~SCL;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\nndelay(700);\r\nscsptr1_data |= SCL;\r\n__raw_writeb(scsptr1_data, SCSPTR1);\r\n}\r\nreturn data & 0x0F;\r\n}\r\nstatic unsigned char rs5c313_read_reg(unsigned char addr)\r\n{\r\nrs5c313_write_data(addr | RS5C313_CNTBIT_READ | RS5C313_CNTBIT_AD);\r\nreturn rs5c313_read_data();\r\n}\r\nstatic void rs5c313_write_reg(unsigned char addr, unsigned char data)\r\n{\r\ndata &= 0x0f;\r\nrs5c313_write_data(addr | RS5C313_CNTBIT_AD);\r\nrs5c313_write_data(data | RS5C313_CNTBIT_DT);\r\nreturn;\r\n}\r\nstatic inline unsigned char rs5c313_read_cntreg(void)\r\n{\r\nreturn rs5c313_read_reg(RS5C313_ADDR_CNTREG);\r\n}\r\nstatic inline void rs5c313_write_cntreg(unsigned char data)\r\n{\r\nrs5c313_write_reg(RS5C313_ADDR_CNTREG, data);\r\n}\r\nstatic inline void rs5c313_write_intintvreg(unsigned char data)\r\n{\r\nrs5c313_write_reg(RS5C313_ADDR_INTINTVREG, data);\r\n}\r\nstatic int rs5c313_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nint data;\r\nint cnt;\r\ncnt = 0;\r\nwhile (1) {\r\nRS5C313_CEENABLE;\r\nrs5c313_write_cntreg(0x04);\r\nif (!(rs5c313_read_cntreg() & RS5C313_CNTREG_ADJ_BSY))\r\nbreak;\r\nRS5C313_CEDISABLE;\r\nndelay(700);\r\nif (cnt++ > 100) {\r\ndev_err(dev, "%s: timeout error\n", __func__);\r\nreturn -EIO;\r\n}\r\n}\r\ndata = rs5c313_read_reg(RS5C313_ADDR_SEC);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_SEC10) << 4);\r\ntm->tm_sec = bcd2bin(data);\r\ndata = rs5c313_read_reg(RS5C313_ADDR_MIN);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_MIN10) << 4);\r\ntm->tm_min = bcd2bin(data);\r\ndata = rs5c313_read_reg(RS5C313_ADDR_HOUR);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_HOUR10) << 4);\r\ntm->tm_hour = bcd2bin(data);\r\ndata = rs5c313_read_reg(RS5C313_ADDR_DAY);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_DAY10) << 4);\r\ntm->tm_mday = bcd2bin(data);\r\ndata = rs5c313_read_reg(RS5C313_ADDR_MON);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_MON10) << 4);\r\ntm->tm_mon = bcd2bin(data) - 1;\r\ndata = rs5c313_read_reg(RS5C313_ADDR_YEAR);\r\ndata |= (rs5c313_read_reg(RS5C313_ADDR_YEAR10) << 4);\r\ntm->tm_year = bcd2bin(data);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndata = rs5c313_read_reg(RS5C313_ADDR_WEEK);\r\ntm->tm_wday = bcd2bin(data);\r\nRS5C313_CEDISABLE;\r\nndelay(700);\r\nreturn 0;\r\n}\r\nstatic int rs5c313_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nint data;\r\nint cnt;\r\ncnt = 0;\r\nwhile (1) {\r\nRS5C313_CEENABLE;\r\nrs5c313_write_cntreg(0x04);\r\nif (!(rs5c313_read_cntreg() & RS5C313_CNTREG_ADJ_BSY))\r\nbreak;\r\nRS5C313_MISCOP;\r\nRS5C313_CEDISABLE;\r\nndelay(700);\r\nif (cnt++ > 100) {\r\ndev_err(dev, "%s: timeout error\n", __func__);\r\nreturn -EIO;\r\n}\r\n}\r\ndata = bin2bcd(tm->tm_sec);\r\nrs5c313_write_reg(RS5C313_ADDR_SEC, data);\r\nrs5c313_write_reg(RS5C313_ADDR_SEC10, (data >> 4));\r\ndata = bin2bcd(tm->tm_min);\r\nrs5c313_write_reg(RS5C313_ADDR_MIN, data);\r\nrs5c313_write_reg(RS5C313_ADDR_MIN10, (data >> 4));\r\ndata = bin2bcd(tm->tm_hour);\r\nrs5c313_write_reg(RS5C313_ADDR_HOUR, data);\r\nrs5c313_write_reg(RS5C313_ADDR_HOUR10, (data >> 4));\r\ndata = bin2bcd(tm->tm_mday);\r\nrs5c313_write_reg(RS5C313_ADDR_DAY, data);\r\nrs5c313_write_reg(RS5C313_ADDR_DAY10, (data >> 4));\r\ndata = bin2bcd(tm->tm_mon + 1);\r\nrs5c313_write_reg(RS5C313_ADDR_MON, data);\r\nrs5c313_write_reg(RS5C313_ADDR_MON10, (data >> 4));\r\ndata = bin2bcd(tm->tm_year % 100);\r\nrs5c313_write_reg(RS5C313_ADDR_YEAR, data);\r\nrs5c313_write_reg(RS5C313_ADDR_YEAR10, (data >> 4));\r\ndata = bin2bcd(tm->tm_wday);\r\nrs5c313_write_reg(RS5C313_ADDR_WEEK, data);\r\nRS5C313_CEDISABLE;\r\nndelay(700);\r\nreturn 0;\r\n}\r\nstatic void rs5c313_check_xstp_bit(void)\r\n{\r\nstruct rtc_time tm;\r\nint cnt;\r\nRS5C313_CEENABLE;\r\nif (rs5c313_read_cntreg() & RS5C313_CNTREG_WTEN_XSTP) {\r\nrs5c313_write_intintvreg(0x00);\r\nrs5c313_write_cntreg(0x07);\r\nfor (cnt = 0; cnt < 100; cnt++) {\r\nif (!(rs5c313_read_cntreg() & RS5C313_CNTREG_ADJ_BSY))\r\nbreak;\r\nRS5C313_MISCOP;\r\n}\r\nmemset(&tm, 0, sizeof(struct rtc_time));\r\ntm.tm_mday = 1;\r\ntm.tm_mon = 1 - 1;\r\ntm.tm_year = 2000 - 1900;\r\nrs5c313_rtc_set_time(NULL, &tm);\r\npr_err("invalid value, resetting to 1 Jan 2000\n");\r\n}\r\nRS5C313_CEDISABLE;\r\nndelay(700);\r\n}\r\nstatic int rs5c313_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc = devm_rtc_device_register(&pdev->dev, "rs5c313",\r\n&rs5c313_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\n}\r\nstatic int __init rs5c313_rtc_init(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&rs5c313_rtc_platform_driver);\r\nif (err)\r\nreturn err;\r\nrs5c313_init_port();\r\nrs5c313_check_xstp_bit();\r\nreturn 0;\r\n}\r\nstatic void __exit rs5c313_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&rs5c313_rtc_platform_driver);\r\n}

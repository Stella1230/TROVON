static ssize_t foo_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct foo_attribute *attribute;\r\nstruct foo_obj *foo;\r\nattribute = to_foo_attr(attr);\r\nfoo = to_foo_obj(kobj);\r\nif (!attribute->show)\r\nreturn -EIO;\r\nreturn attribute->show(foo, attribute, buf);\r\n}\r\nstatic ssize_t foo_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct foo_attribute *attribute;\r\nstruct foo_obj *foo;\r\nattribute = to_foo_attr(attr);\r\nfoo = to_foo_obj(kobj);\r\nif (!attribute->store)\r\nreturn -EIO;\r\nreturn attribute->store(foo, attribute, buf, len);\r\n}\r\nstatic void foo_release(struct kobject *kobj)\r\n{\r\nstruct foo_obj *foo;\r\nfoo = to_foo_obj(kobj);\r\nkfree(foo);\r\n}\r\nstatic ssize_t foo_show(struct foo_obj *foo_obj, struct foo_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", foo_obj->foo);\r\n}\r\nstatic ssize_t foo_store(struct foo_obj *foo_obj, struct foo_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint ret;\r\nret = kstrtoint(buf, 10, &foo_obj->foo);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t b_show(struct foo_obj *foo_obj, struct foo_attribute *attr,\r\nchar *buf)\r\n{\r\nint var;\r\nif (strcmp(attr->attr.name, "baz") == 0)\r\nvar = foo_obj->baz;\r\nelse\r\nvar = foo_obj->bar;\r\nreturn sprintf(buf, "%d\n", var);\r\n}\r\nstatic ssize_t b_store(struct foo_obj *foo_obj, struct foo_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint var, ret;\r\nret = kstrtoint(buf, 10, &var);\r\nif (ret < 0)\r\nreturn ret;\r\nif (strcmp(attr->attr.name, "baz") == 0)\r\nfoo_obj->baz = var;\r\nelse\r\nfoo_obj->bar = var;\r\nreturn count;\r\n}\r\nstatic struct foo_obj *create_foo_obj(const char *name)\r\n{\r\nstruct foo_obj *foo;\r\nint retval;\r\nfoo = kzalloc(sizeof(*foo), GFP_KERNEL);\r\nif (!foo)\r\nreturn NULL;\r\nfoo->kobj.kset = example_kset;\r\nretval = kobject_init_and_add(&foo->kobj, &foo_ktype, NULL, "%s", name);\r\nif (retval) {\r\nkobject_put(&foo->kobj);\r\nreturn NULL;\r\n}\r\nkobject_uevent(&foo->kobj, KOBJ_ADD);\r\nreturn foo;\r\n}\r\nstatic void destroy_foo_obj(struct foo_obj *foo)\r\n{\r\nkobject_put(&foo->kobj);\r\n}\r\nstatic int __init example_init(void)\r\n{\r\nexample_kset = kset_create_and_add("kset_example", NULL, kernel_kobj);\r\nif (!example_kset)\r\nreturn -ENOMEM;\r\nfoo_obj = create_foo_obj("foo");\r\nif (!foo_obj)\r\ngoto foo_error;\r\nbar_obj = create_foo_obj("bar");\r\nif (!bar_obj)\r\ngoto bar_error;\r\nbaz_obj = create_foo_obj("baz");\r\nif (!baz_obj)\r\ngoto baz_error;\r\nreturn 0;\r\nbaz_error:\r\ndestroy_foo_obj(bar_obj);\r\nbar_error:\r\ndestroy_foo_obj(foo_obj);\r\nfoo_error:\r\nkset_unregister(example_kset);\r\nreturn -EINVAL;\r\n}\r\nstatic void __exit example_exit(void)\r\n{\r\ndestroy_foo_obj(baz_obj);\r\ndestroy_foo_obj(bar_obj);\r\ndestroy_foo_obj(foo_obj);\r\nkset_unregister(example_kset);\r\n}

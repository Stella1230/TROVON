static u32 gpio_ingenic_read_reg(struct ingenic_gpio_chip *jzgc, u8 reg)\r\n{\r\nunsigned int val;\r\nregmap_read(jzgc->map, jzgc->reg_base + reg, &val);\r\nreturn (u32) val;\r\n}\r\nstatic void gpio_ingenic_set_bit(struct ingenic_gpio_chip *jzgc,\r\nu8 reg, u8 offset, bool set)\r\n{\r\nif (set)\r\nreg = REG_SET(reg);\r\nelse\r\nreg = REG_CLEAR(reg);\r\nregmap_write(jzgc->map, jzgc->reg_base + reg, BIT(offset));\r\n}\r\nstatic inline bool gpio_get_value(struct ingenic_gpio_chip *jzgc, u8 offset)\r\n{\r\nunsigned int val = gpio_ingenic_read_reg(jzgc, GPIO_PIN);\r\nreturn !!(val & BIT(offset));\r\n}\r\nstatic void gpio_set_value(struct ingenic_gpio_chip *jzgc, u8 offset, int value)\r\n{\r\nif (jzgc->version >= ID_JZ4770)\r\ngpio_ingenic_set_bit(jzgc, JZ4770_GPIO_PAT0, offset, !!value);\r\nelse\r\ngpio_ingenic_set_bit(jzgc, JZ4740_GPIO_DATA, offset, !!value);\r\n}\r\nstatic void irq_set_type(struct ingenic_gpio_chip *jzgc,\r\nu8 offset, unsigned int type)\r\n{\r\nu8 reg1, reg2;\r\nif (jzgc->version >= ID_JZ4770) {\r\nreg1 = JZ4770_GPIO_PAT1;\r\nreg2 = JZ4770_GPIO_PAT0;\r\n} else {\r\nreg1 = JZ4740_GPIO_TRIG;\r\nreg2 = JZ4740_GPIO_DIR;\r\n}\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\ngpio_ingenic_set_bit(jzgc, reg2, offset, true);\r\ngpio_ingenic_set_bit(jzgc, reg1, offset, true);\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\ngpio_ingenic_set_bit(jzgc, reg2, offset, false);\r\ngpio_ingenic_set_bit(jzgc, reg1, offset, true);\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\ngpio_ingenic_set_bit(jzgc, reg2, offset, true);\r\ngpio_ingenic_set_bit(jzgc, reg1, offset, false);\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\ndefault:\r\ngpio_ingenic_set_bit(jzgc, reg2, offset, false);\r\ngpio_ingenic_set_bit(jzgc, reg1, offset, false);\r\nbreak;\r\n}\r\n}\r\nstatic void ingenic_gpio_irq_mask(struct irq_data *irqd)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\ngpio_ingenic_set_bit(jzgc, GPIO_MSK, irqd->hwirq, true);\r\n}\r\nstatic void ingenic_gpio_irq_unmask(struct irq_data *irqd)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\ngpio_ingenic_set_bit(jzgc, GPIO_MSK, irqd->hwirq, false);\r\n}\r\nstatic void ingenic_gpio_irq_enable(struct irq_data *irqd)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nint irq = irqd->hwirq;\r\nif (jzgc->version >= ID_JZ4770)\r\ngpio_ingenic_set_bit(jzgc, JZ4770_GPIO_INT, irq, true);\r\nelse\r\ngpio_ingenic_set_bit(jzgc, JZ4740_GPIO_SELECT, irq, true);\r\ningenic_gpio_irq_unmask(irqd);\r\n}\r\nstatic void ingenic_gpio_irq_disable(struct irq_data *irqd)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nint irq = irqd->hwirq;\r\ningenic_gpio_irq_mask(irqd);\r\nif (jzgc->version >= ID_JZ4770)\r\ngpio_ingenic_set_bit(jzgc, JZ4770_GPIO_INT, irq, false);\r\nelse\r\ngpio_ingenic_set_bit(jzgc, JZ4740_GPIO_SELECT, irq, false);\r\n}\r\nstatic void ingenic_gpio_irq_ack(struct irq_data *irqd)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nint irq = irqd->hwirq;\r\nbool high;\r\nif (irqd_get_trigger_type(irqd) == IRQ_TYPE_EDGE_BOTH) {\r\nhigh = gpio_get_value(jzgc, irq);\r\nif (high)\r\nirq_set_type(jzgc, irq, IRQ_TYPE_EDGE_FALLING);\r\nelse\r\nirq_set_type(jzgc, irq, IRQ_TYPE_EDGE_RISING);\r\n}\r\nif (jzgc->version >= ID_JZ4770)\r\ngpio_ingenic_set_bit(jzgc, JZ4770_GPIO_FLAG, irq, false);\r\nelse\r\ngpio_ingenic_set_bit(jzgc, JZ4740_GPIO_DATA, irq, true);\r\n}\r\nstatic int ingenic_gpio_irq_set_type(struct irq_data *irqd, unsigned int type)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_BOTH:\r\ncase IRQ_TYPE_EDGE_RISING:\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nirq_set_handler_locked(irqd, handle_edge_irq);\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nirq_set_handler_locked(irqd, handle_level_irq);\r\nbreak;\r\ndefault:\r\nirq_set_handler_locked(irqd, handle_bad_irq);\r\n}\r\nif (type == IRQ_TYPE_EDGE_BOTH) {\r\nbool high = gpio_get_value(jzgc, irqd->hwirq);\r\ntype = high ? IRQ_TYPE_EDGE_FALLING : IRQ_TYPE_EDGE_RISING;\r\n}\r\nirq_set_type(jzgc, irqd->hwirq, type);\r\nreturn 0;\r\n}\r\nstatic int ingenic_gpio_irq_set_wake(struct irq_data *irqd, unsigned int on)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nreturn irq_set_irq_wake(jzgc->irq, on);\r\n}\r\nstatic void ingenic_gpio_irq_handler(struct irq_desc *desc)\r\n{\r\nstruct gpio_chip *gc = irq_desc_get_handler_data(desc);\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nstruct irq_chip *irq_chip = irq_data_get_irq_chip(&desc->irq_data);\r\nunsigned long flag, i;\r\nchained_irq_enter(irq_chip, desc);\r\nif (jzgc->version >= ID_JZ4770)\r\nflag = gpio_ingenic_read_reg(jzgc, JZ4770_GPIO_FLAG);\r\nelse\r\nflag = gpio_ingenic_read_reg(jzgc, JZ4740_GPIO_FLAG);\r\nfor_each_set_bit(i, &flag, 32)\r\ngeneric_handle_irq(irq_linear_revmap(gc->irqdomain, i));\r\nchained_irq_exit(irq_chip, desc);\r\n}\r\nstatic void ingenic_gpio_set(struct gpio_chip *gc,\r\nunsigned int offset, int value)\r\n{\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\ngpio_set_value(jzgc, offset, value);\r\n}\r\nstatic int ingenic_gpio_get(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct ingenic_gpio_chip *jzgc = gpiochip_get_data(gc);\r\nreturn (int) gpio_get_value(jzgc, offset);\r\n}\r\nstatic int ingenic_gpio_direction_input(struct gpio_chip *gc,\r\nunsigned int offset)\r\n{\r\nreturn pinctrl_gpio_direction_input(gc->base + offset);\r\n}\r\nstatic int ingenic_gpio_direction_output(struct gpio_chip *gc,\r\nunsigned int offset, int value)\r\n{\r\ningenic_gpio_set(gc, offset, value);\r\nreturn pinctrl_gpio_direction_output(gc->base + offset);\r\n}\r\nstatic int ingenic_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nconst struct of_device_id *of_id = of_match_device(\r\ningenic_gpio_of_match, dev);\r\nstruct ingenic_gpio_chip *jzgc;\r\nu32 bank;\r\nint err;\r\njzgc = devm_kzalloc(dev, sizeof(*jzgc), GFP_KERNEL);\r\nif (!jzgc)\r\nreturn -ENOMEM;\r\njzgc->map = dev_get_drvdata(dev->parent);\r\nif (!jzgc->map) {\r\ndev_err(dev, "Cannot get parent regmap\n");\r\nreturn -ENXIO;\r\n}\r\nerr = of_property_read_u32(dev->of_node, "reg", &bank);\r\nif (err) {\r\ndev_err(dev, "Cannot read \"reg\" property: %i\n", err);\r\nreturn err;\r\n}\r\njzgc->reg_base = bank * 0x100;\r\njzgc->gc.label = devm_kasprintf(dev, GFP_KERNEL, "GPIO%c", 'A' + bank);\r\nif (!jzgc->gc.label)\r\nreturn -ENOMEM;\r\njzgc->gc.base = bank * 32;\r\njzgc->gc.ngpio = 32;\r\njzgc->gc.parent = dev;\r\njzgc->gc.of_node = dev->of_node;\r\njzgc->gc.owner = THIS_MODULE;\r\njzgc->version = (enum jz_version)of_id->data;\r\njzgc->gc.set = ingenic_gpio_set;\r\njzgc->gc.get = ingenic_gpio_get;\r\njzgc->gc.direction_input = ingenic_gpio_direction_input;\r\njzgc->gc.direction_output = ingenic_gpio_direction_output;\r\nif (of_property_read_bool(dev->of_node, "gpio-ranges")) {\r\njzgc->gc.request = gpiochip_generic_request;\r\njzgc->gc.free = gpiochip_generic_free;\r\n}\r\nerr = devm_gpiochip_add_data(dev, &jzgc->gc, jzgc);\r\nif (err)\r\nreturn err;\r\njzgc->irq = irq_of_parse_and_map(dev->of_node, 0);\r\nif (!jzgc->irq)\r\nreturn -EINVAL;\r\njzgc->irq_chip.name = jzgc->gc.label;\r\njzgc->irq_chip.irq_enable = ingenic_gpio_irq_enable;\r\njzgc->irq_chip.irq_disable = ingenic_gpio_irq_disable;\r\njzgc->irq_chip.irq_unmask = ingenic_gpio_irq_unmask;\r\njzgc->irq_chip.irq_mask = ingenic_gpio_irq_mask;\r\njzgc->irq_chip.irq_ack = ingenic_gpio_irq_ack;\r\njzgc->irq_chip.irq_set_type = ingenic_gpio_irq_set_type;\r\njzgc->irq_chip.irq_set_wake = ingenic_gpio_irq_set_wake;\r\njzgc->irq_chip.flags = IRQCHIP_MASK_ON_SUSPEND;\r\nerr = gpiochip_irqchip_add(&jzgc->gc, &jzgc->irq_chip, 0,\r\nhandle_level_irq, IRQ_TYPE_NONE);\r\nif (err)\r\nreturn err;\r\ngpiochip_set_chained_irqchip(&jzgc->gc, &jzgc->irq_chip,\r\njzgc->irq, ingenic_gpio_irq_handler);\r\nreturn 0;\r\n}\r\nstatic int ingenic_gpio_remove(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init ingenic_gpio_drv_register(void)\r\n{\r\nreturn platform_driver_register(&ingenic_gpio_driver);\r\n}\r\nstatic void __exit ingenic_gpio_drv_unregister(void)\r\n{\r\nplatform_driver_unregister(&ingenic_gpio_driver);\r\n}

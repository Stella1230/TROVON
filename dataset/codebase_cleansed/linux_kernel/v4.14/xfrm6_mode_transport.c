static int xfrm6_transport_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *iph;\r\nu8 *prevhdr;\r\nint hdr_len;\r\niph = ipv6_hdr(skb);\r\nskb_set_inner_transport_header(skb, skb_transport_offset(skb));\r\nhdr_len = x->type->hdr_offset(x, skb, &prevhdr);\r\nif (hdr_len < 0)\r\nreturn hdr_len;\r\nskb_set_mac_header(skb, (prevhdr - x->props.header_len) - skb->data);\r\nskb_set_network_header(skb, -x->props.header_len);\r\nskb->transport_header = skb->network_header + hdr_len;\r\n__skb_pull(skb, hdr_len);\r\nmemmove(ipv6_hdr(skb), iph, hdr_len);\r\nreturn 0;\r\n}\r\nstatic int xfrm6_transport_input(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint ihl = skb->data - skb_transport_header(skb);\r\nstruct xfrm_offload *xo = xfrm_offload(skb);\r\nif (skb->transport_header != skb->network_header) {\r\nmemmove(skb_transport_header(skb),\r\nskb_network_header(skb), ihl);\r\nskb->network_header = skb->transport_header;\r\n}\r\nipv6_hdr(skb)->payload_len = htons(skb->len + ihl -\r\nsizeof(struct ipv6hdr));\r\nif (!xo || !(xo->flags & XFRM_GRO))\r\nskb_reset_transport_header(skb);\r\nreturn 0;\r\n}\r\nstatic struct sk_buff *xfrm4_transport_gso_segment(struct xfrm_state *x,\r\nstruct sk_buff *skb,\r\nnetdev_features_t features)\r\n{\r\nconst struct net_offload *ops;\r\nstruct sk_buff *segs = ERR_PTR(-EINVAL);\r\nstruct xfrm_offload *xo = xfrm_offload(skb);\r\nskb->transport_header += x->props.header_len;\r\nops = rcu_dereference(inet6_offloads[xo->proto]);\r\nif (likely(ops && ops->callbacks.gso_segment))\r\nsegs = ops->callbacks.gso_segment(skb, features);\r\nreturn segs;\r\n}\r\nstatic void xfrm6_transport_xmit(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct xfrm_offload *xo = xfrm_offload(skb);\r\nskb_reset_mac_len(skb);\r\npskb_pull(skb, skb->mac_len + sizeof(struct ipv6hdr) + x->props.header_len);\r\nif (xo->flags & XFRM_GSO_SEGMENT) {\r\nskb_reset_transport_header(skb);\r\nskb->transport_header -= x->props.header_len;\r\n}\r\n}\r\nstatic int __init xfrm6_transport_init(void)\r\n{\r\nreturn xfrm_register_mode(&xfrm6_transport_mode, AF_INET6);\r\n}\r\nstatic void __exit xfrm6_transport_exit(void)\r\n{\r\nint err;\r\nerr = xfrm_unregister_mode(&xfrm6_transport_mode, AF_INET6);\r\nBUG_ON(err);\r\n}

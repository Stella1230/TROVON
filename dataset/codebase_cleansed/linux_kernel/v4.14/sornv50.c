void\r\nnv50_sor_clock(struct nvkm_ior *sor)\r\n{\r\nstruct nvkm_device *device = sor->disp->engine.subdev.device;\r\nconst int div = sor->asy.link == 3;\r\nconst u32 soff = nv50_ior_base(sor);\r\nnvkm_mask(device, 0x614300 + soff, 0x00000707, (div << 8) | div);\r\n}\r\nstatic void\r\nnv50_sor_power_wait(struct nvkm_device *device, u32 soff)\r\n{\r\nnvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x61c004 + soff) & 0x80000000))\r\nbreak;\r\n);\r\n}\r\nvoid\r\nnv50_sor_power(struct nvkm_ior *sor, bool normal, bool pu,\r\nbool data, bool vsync, bool hsync)\r\n{\r\nstruct nvkm_device *device = sor->disp->engine.subdev.device;\r\nconst u32 soff = nv50_ior_base(sor);\r\nconst u32 shift = normal ? 0 : 16;\r\nconst u32 state = 0x80000000 | (0x00000001 * !!pu) << shift;\r\nconst u32 field = 0x80000000 | (0x00000001 << shift);\r\nnv50_sor_power_wait(device, soff);\r\nnvkm_mask(device, 0x61c004 + soff, field, state);\r\nnv50_sor_power_wait(device, soff);\r\nnvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x61c030 + soff) & 0x10000000))\r\nbreak;\r\n);\r\n}\r\nvoid\r\nnv50_sor_state(struct nvkm_ior *sor, struct nvkm_ior_state *state)\r\n{\r\nstruct nvkm_device *device = sor->disp->engine.subdev.device;\r\nconst u32 coff = sor->id * 8 + (state == &sor->arm) * 4;\r\nu32 ctrl = nvkm_rd32(device, 0x610b70 + coff);\r\nstate->proto_evo = (ctrl & 0x00000f00) >> 8;\r\nswitch (state->proto_evo) {\r\ncase 0: state->proto = LVDS; state->link = 1; break;\r\ncase 1: state->proto = TMDS; state->link = 1; break;\r\ncase 2: state->proto = TMDS; state->link = 2; break;\r\ncase 5: state->proto = TMDS; state->link = 3; break;\r\ndefault:\r\nstate->proto = UNKNOWN;\r\nbreak;\r\n}\r\nstate->head = ctrl & 0x00000003;\r\n}\r\nint\r\nnv50_sor_new_(const struct nvkm_ior_func *func, struct nvkm_disp *disp, int id)\r\n{\r\nstruct nvkm_device *device = disp->engine.subdev.device;\r\nif (!(nvkm_rd32(device, 0x610184) & (0x01000000 << id)))\r\nreturn 0;\r\nreturn nvkm_ior_new_(func, disp, SOR, id);\r\n}\r\nint\r\nnv50_sor_new(struct nvkm_disp *disp, int id)\r\n{\r\nreturn nv50_sor_new_(&nv50_sor, disp, id);\r\n}

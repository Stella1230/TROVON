static int owl_sps_set_power(struct owl_sps_domain *pd, bool enable)\r\n{\r\nu32 pwr_mask, ack_mask;\r\nack_mask = BIT(pd->info->ack_bit);\r\npwr_mask = BIT(pd->info->pwr_bit);\r\nreturn owl_sps_set_pg(pd->sps->base, pwr_mask, ack_mask, enable);\r\n}\r\nstatic int owl_sps_power_on(struct generic_pm_domain *domain)\r\n{\r\nstruct owl_sps_domain *pd = to_owl_pd(domain);\r\ndev_dbg(pd->sps->dev, "%s power on", pd->info->name);\r\nreturn owl_sps_set_power(pd, true);\r\n}\r\nstatic int owl_sps_power_off(struct generic_pm_domain *domain)\r\n{\r\nstruct owl_sps_domain *pd = to_owl_pd(domain);\r\ndev_dbg(pd->sps->dev, "%s power off", pd->info->name);\r\nreturn owl_sps_set_power(pd, false);\r\n}\r\nstatic int owl_sps_init_domain(struct owl_sps *sps, int index)\r\n{\r\nstruct owl_sps_domain *pd;\r\npd = devm_kzalloc(sps->dev, sizeof(*pd), GFP_KERNEL);\r\nif (!pd)\r\nreturn -ENOMEM;\r\npd->info = &sps->info->domains[index];\r\npd->sps = sps;\r\npd->genpd.name = pd->info->name;\r\npd->genpd.power_on = owl_sps_power_on;\r\npd->genpd.power_off = owl_sps_power_off;\r\npd->genpd.flags = pd->info->genpd_flags;\r\npm_genpd_init(&pd->genpd, NULL, false);\r\nsps->genpd_data.domains[index] = &pd->genpd;\r\nreturn 0;\r\n}\r\nstatic int owl_sps_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match;\r\nconst struct owl_sps_info *sps_info;\r\nstruct owl_sps *sps;\r\nint i, ret;\r\nif (!pdev->dev.of_node) {\r\ndev_err(&pdev->dev, "no device node\n");\r\nreturn -ENODEV;\r\n}\r\nmatch = of_match_device(pdev->dev.driver->of_match_table, &pdev->dev);\r\nif (!match || !match->data) {\r\ndev_err(&pdev->dev, "unknown compatible or missing data\n");\r\nreturn -EINVAL;\r\n}\r\nsps_info = match->data;\r\nsps = devm_kzalloc(&pdev->dev, sizeof(*sps) +\r\nsps_info->num_domains * sizeof(sps->domains[0]),\r\nGFP_KERNEL);\r\nif (!sps)\r\nreturn -ENOMEM;\r\nsps->base = of_io_request_and_map(pdev->dev.of_node, 0, "owl-sps");\r\nif (IS_ERR(sps->base)) {\r\ndev_err(&pdev->dev, "failed to map sps registers\n");\r\nreturn PTR_ERR(sps->base);\r\n}\r\nsps->dev = &pdev->dev;\r\nsps->info = sps_info;\r\nsps->genpd_data.domains = sps->domains;\r\nsps->genpd_data.num_domains = sps_info->num_domains;\r\nfor (i = 0; i < sps_info->num_domains; i++) {\r\nret = owl_sps_init_domain(sps, i);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = of_genpd_add_provider_onecell(pdev->dev.of_node, &sps->genpd_data);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add provider (%d)", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init owl_sps_init(void)\r\n{\r\nreturn platform_driver_register(&owl_sps_platform_driver);\r\n}

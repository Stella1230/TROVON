static char printable_char(int c)\r\n{\r\nreturn isascii(c) && isprint(c) ? c : '?';\r\n}\r\nuint32_t drm_mode_legacy_fb_format(uint32_t bpp, uint32_t depth)\r\n{\r\nuint32_t fmt;\r\nswitch (bpp) {\r\ncase 8:\r\nfmt = DRM_FORMAT_C8;\r\nbreak;\r\ncase 16:\r\nif (depth == 15)\r\nfmt = DRM_FORMAT_XRGB1555;\r\nelse\r\nfmt = DRM_FORMAT_RGB565;\r\nbreak;\r\ncase 24:\r\nfmt = DRM_FORMAT_RGB888;\r\nbreak;\r\ncase 32:\r\nif (depth == 24)\r\nfmt = DRM_FORMAT_XRGB8888;\r\nelse if (depth == 30)\r\nfmt = DRM_FORMAT_XRGB2101010;\r\nelse\r\nfmt = DRM_FORMAT_ARGB8888;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("bad bpp, assuming x8r8g8b8 pixel format\n");\r\nfmt = DRM_FORMAT_XRGB8888;\r\nbreak;\r\n}\r\nreturn fmt;\r\n}\r\nconst char *drm_get_format_name(uint32_t format, struct drm_format_name_buf *buf)\r\n{\r\nsnprintf(buf->str, sizeof(buf->str),\r\n"%c%c%c%c %s-endian (0x%08x)",\r\nprintable_char(format & 0xff),\r\nprintable_char((format >> 8) & 0xff),\r\nprintable_char((format >> 16) & 0xff),\r\nprintable_char((format >> 24) & 0x7f),\r\nformat & DRM_FORMAT_BIG_ENDIAN ? "big" : "little",\r\nformat);\r\nreturn buf->str;\r\n}\r\nconst struct drm_format_info *__drm_format_info(u32 format)\r\n{\r\nstatic const struct drm_format_info formats[] = {\r\n{ .format = DRM_FORMAT_C8, .depth = 8, .num_planes = 1, .cpp = { 1, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGB332, .depth = 8, .num_planes = 1, .cpp = { 1, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGR233, .depth = 8, .num_planes = 1, .cpp = { 1, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XRGB4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XBGR4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBX4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRX4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ARGB4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ABGR4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBA4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRA4444, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XRGB1555, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XBGR1555, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBX5551, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRX5551, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ARGB1555, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ABGR1555, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBA5551, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRA5551, .depth = 15, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGB565, .depth = 16, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGR565, .depth = 16, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGB888, .depth = 24, .num_planes = 1, .cpp = { 3, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGR888, .depth = 24, .num_planes = 1, .cpp = { 3, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XRGB8888, .depth = 24, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XBGR8888, .depth = 24, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBX8888, .depth = 24, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRX8888, .depth = 24, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGB565_A8, .depth = 24, .num_planes = 2, .cpp = { 2, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGR565_A8, .depth = 24, .num_planes = 2, .cpp = { 2, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XRGB2101010, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XBGR2101010, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBX1010102, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRX1010102, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ARGB2101010, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ABGR2101010, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBA1010102, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRA1010102, .depth = 30, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ARGB8888, .depth = 32, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_ABGR8888, .depth = 32, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBA8888, .depth = 32, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRA8888, .depth = 32, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGB888_A8, .depth = 32, .num_planes = 2, .cpp = { 3, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGR888_A8, .depth = 32, .num_planes = 2, .cpp = { 3, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XRGB8888_A8, .depth = 32, .num_planes = 2, .cpp = { 4, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_XBGR8888_A8, .depth = 32, .num_planes = 2, .cpp = { 4, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_RGBX8888_A8, .depth = 32, .num_planes = 2, .cpp = { 4, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_BGRX8888_A8, .depth = 32, .num_planes = 2, .cpp = { 4, 1, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YUV410, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 4, .vsub = 4 },\r\n{ .format = DRM_FORMAT_YVU410, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 4, .vsub = 4 },\r\n{ .format = DRM_FORMAT_YUV411, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 4, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YVU411, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 4, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YUV420, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 2, .vsub = 2 },\r\n{ .format = DRM_FORMAT_YVU420, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 2, .vsub = 2 },\r\n{ .format = DRM_FORMAT_YUV422, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YVU422, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YUV444, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YVU444, .depth = 0, .num_planes = 3, .cpp = { 1, 1, 1 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_NV12, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 2, .vsub = 2 },\r\n{ .format = DRM_FORMAT_NV21, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 2, .vsub = 2 },\r\n{ .format = DRM_FORMAT_NV16, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_NV61, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_NV24, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_NV42, .depth = 0, .num_planes = 2, .cpp = { 1, 2, 0 }, .hsub = 1, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YUYV, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_YVYU, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_UYVY, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_VYUY, .depth = 0, .num_planes = 1, .cpp = { 2, 0, 0 }, .hsub = 2, .vsub = 1 },\r\n{ .format = DRM_FORMAT_AYUV, .depth = 0, .num_planes = 1, .cpp = { 4, 0, 0 }, .hsub = 1, .vsub = 1 },\r\n};\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(formats); ++i) {\r\nif (formats[i].format == format)\r\nreturn &formats[i];\r\n}\r\nreturn NULL;\r\n}\r\nconst struct drm_format_info *drm_format_info(u32 format)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = __drm_format_info(format);\r\nWARN_ON(!info);\r\nreturn info;\r\n}\r\nconst struct drm_format_info *\r\ndrm_get_format_info(struct drm_device *dev,\r\nconst struct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nconst struct drm_format_info *info = NULL;\r\nif (dev->mode_config.funcs->get_format_info)\r\ninfo = dev->mode_config.funcs->get_format_info(mode_cmd);\r\nif (!info)\r\ninfo = drm_format_info(mode_cmd->pixel_format);\r\nreturn info;\r\n}\r\nint drm_format_num_planes(uint32_t format)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nreturn info ? info->num_planes : 1;\r\n}\r\nint drm_format_plane_cpp(uint32_t format, int plane)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nif (!info || plane >= info->num_planes)\r\nreturn 0;\r\nreturn info->cpp[plane];\r\n}\r\nint drm_format_horz_chroma_subsampling(uint32_t format)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nreturn info ? info->hsub : 1;\r\n}\r\nint drm_format_vert_chroma_subsampling(uint32_t format)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nreturn info ? info->vsub : 1;\r\n}\r\nint drm_format_plane_width(int width, uint32_t format, int plane)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nif (!info || plane >= info->num_planes)\r\nreturn 0;\r\nif (plane == 0)\r\nreturn width;\r\nreturn width / info->hsub;\r\n}\r\nint drm_format_plane_height(int height, uint32_t format, int plane)\r\n{\r\nconst struct drm_format_info *info;\r\ninfo = drm_format_info(format);\r\nif (!info || plane >= info->num_planes)\r\nreturn 0;\r\nif (plane == 0)\r\nreturn height;\r\nreturn height / info->vsub;\r\n}

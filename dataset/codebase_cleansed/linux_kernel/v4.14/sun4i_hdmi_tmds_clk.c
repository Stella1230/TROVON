static inline struct sun4i_tmds *hw_to_tmds(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct sun4i_tmds, hw);\r\n}\r\nstatic unsigned long sun4i_tmds_calc_divider(unsigned long rate,\r\nunsigned long parent_rate,\r\nu8 *div,\r\nbool *half)\r\n{\r\nunsigned long best_rate = 0;\r\nu8 best_m = 0, m;\r\nbool is_double;\r\nfor (m = 1; m < 16; m++) {\r\nu8 d;\r\nfor (d = 1; d < 3; d++) {\r\nunsigned long tmp_rate;\r\ntmp_rate = parent_rate / m / d;\r\nif (tmp_rate > rate)\r\ncontinue;\r\nif (!best_rate ||\r\n(rate - tmp_rate) < (rate - best_rate)) {\r\nbest_rate = tmp_rate;\r\nbest_m = m;\r\nis_double = d;\r\n}\r\n}\r\n}\r\nif (div && half) {\r\n*div = best_m;\r\n*half = is_double;\r\n}\r\nreturn best_rate;\r\n}\r\nstatic int sun4i_tmds_determine_rate(struct clk_hw *hw,\r\nstruct clk_rate_request *req)\r\n{\r\nstruct clk_hw *parent;\r\nunsigned long best_parent = 0;\r\nunsigned long rate = req->rate;\r\nint best_div = 1, best_half = 1;\r\nint i, j;\r\nparent = clk_hw_get_parent_by_index(hw, 0);\r\nif (!parent)\r\nreturn -EINVAL;\r\nfor (i = 1; i < 3; i++) {\r\nfor (j = 1; j < 16; j++) {\r\nunsigned long ideal = rate * i * j;\r\nunsigned long rounded;\r\nrounded = clk_hw_round_rate(parent, ideal);\r\nif (rounded == ideal) {\r\nbest_parent = rounded;\r\nbest_half = i;\r\nbest_div = j;\r\ngoto out;\r\n}\r\nif (abs(rate - rounded / i) <\r\nabs(rate - best_parent / best_div)) {\r\nbest_parent = rounded;\r\nbest_div = i;\r\n}\r\n}\r\n}\r\nout:\r\nreq->rate = best_parent / best_half / best_div;\r\nreq->best_parent_rate = best_parent;\r\nreq->best_parent_hw = parent;\r\nreturn 0;\r\n}\r\nstatic unsigned long sun4i_tmds_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun4i_tmds *tmds = hw_to_tmds(hw);\r\nu32 reg;\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PAD_CTRL1_REG);\r\nif (reg & SUN4I_HDMI_PAD_CTRL1_HALVE_CLK)\r\nparent_rate /= 2;\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PLL_CTRL_REG);\r\nreg = (reg >> 4) & 0xf;\r\nif (!reg)\r\nreg = 1;\r\nreturn parent_rate / reg;\r\n}\r\nstatic int sun4i_tmds_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun4i_tmds *tmds = hw_to_tmds(hw);\r\nbool half;\r\nu32 reg;\r\nu8 div;\r\nsun4i_tmds_calc_divider(rate, parent_rate, &div, &half);\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PAD_CTRL1_REG);\r\nreg &= ~SUN4I_HDMI_PAD_CTRL1_HALVE_CLK;\r\nif (half)\r\nreg |= SUN4I_HDMI_PAD_CTRL1_HALVE_CLK;\r\nwritel(reg, tmds->hdmi->base + SUN4I_HDMI_PAD_CTRL1_REG);\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PLL_CTRL_REG);\r\nreg &= ~SUN4I_HDMI_PLL_CTRL_DIV_MASK;\r\nwritel(reg | SUN4I_HDMI_PLL_CTRL_DIV(div),\r\ntmds->hdmi->base + SUN4I_HDMI_PLL_CTRL_REG);\r\nreturn 0;\r\n}\r\nstatic u8 sun4i_tmds_get_parent(struct clk_hw *hw)\r\n{\r\nstruct sun4i_tmds *tmds = hw_to_tmds(hw);\r\nu32 reg;\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PLL_DBG0_REG);\r\nreturn ((reg & SUN4I_HDMI_PLL_DBG0_TMDS_PARENT_MASK) >>\r\nSUN4I_HDMI_PLL_DBG0_TMDS_PARENT_SHIFT);\r\n}\r\nstatic int sun4i_tmds_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct sun4i_tmds *tmds = hw_to_tmds(hw);\r\nu32 reg;\r\nif (index > 1)\r\nreturn -EINVAL;\r\nreg = readl(tmds->hdmi->base + SUN4I_HDMI_PLL_DBG0_REG);\r\nreg &= ~SUN4I_HDMI_PLL_DBG0_TMDS_PARENT_MASK;\r\nwritel(reg | SUN4I_HDMI_PLL_DBG0_TMDS_PARENT(index),\r\ntmds->hdmi->base + SUN4I_HDMI_PLL_DBG0_REG);\r\nreturn 0;\r\n}\r\nint sun4i_tmds_create(struct sun4i_hdmi *hdmi)\r\n{\r\nstruct clk_init_data init;\r\nstruct sun4i_tmds *tmds;\r\nconst char *parents[2];\r\nparents[0] = __clk_get_name(hdmi->pll0_clk);\r\nif (!parents[0])\r\nreturn -ENODEV;\r\nparents[1] = __clk_get_name(hdmi->pll1_clk);\r\nif (!parents[1])\r\nreturn -ENODEV;\r\ntmds = devm_kzalloc(hdmi->dev, sizeof(*tmds), GFP_KERNEL);\r\nif (!tmds)\r\nreturn -ENOMEM;\r\ninit.name = "hdmi-tmds";\r\ninit.ops = &sun4i_tmds_ops;\r\ninit.parent_names = parents;\r\ninit.num_parents = 2;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\ntmds->hdmi = hdmi;\r\ntmds->hw.init = &init;\r\nhdmi->tmds_clk = devm_clk_register(hdmi->dev, &tmds->hw);\r\nif (IS_ERR(hdmi->tmds_clk))\r\nreturn PTR_ERR(hdmi->tmds_clk);\r\nreturn 0;\r\n}

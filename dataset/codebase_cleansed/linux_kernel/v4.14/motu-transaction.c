int snd_motu_transaction_read(struct snd_motu *motu, u32 offset, __be32 *reg,\r\nsize_t size)\r\n{\r\nint tcode;\r\nif (size % sizeof(__be32) > 0 || size <= 0)\r\nreturn -EINVAL;\r\nif (size == sizeof(__be32))\r\ntcode = TCODE_READ_QUADLET_REQUEST;\r\nelse\r\ntcode = TCODE_READ_BLOCK_REQUEST;\r\nreturn snd_fw_transaction(motu->unit, tcode,\r\nSND_MOTU_ADDR_BASE + offset, reg, size, 0);\r\n}\r\nint snd_motu_transaction_write(struct snd_motu *motu, u32 offset, __be32 *reg,\r\nsize_t size)\r\n{\r\nint tcode;\r\nif (size % sizeof(__be32) > 0 || size <= 0)\r\nreturn -EINVAL;\r\nif (size == sizeof(__be32))\r\ntcode = TCODE_WRITE_QUADLET_REQUEST;\r\nelse\r\ntcode = TCODE_WRITE_BLOCK_REQUEST;\r\nreturn snd_fw_transaction(motu->unit, tcode,\r\nSND_MOTU_ADDR_BASE + offset, reg, size, 0);\r\n}\r\nstatic void handle_message(struct fw_card *card, struct fw_request *request,\r\nint tcode, int destination, int source,\r\nint generation, unsigned long long offset,\r\nvoid *data, size_t length, void *callback_data)\r\n{\r\nstruct snd_motu *motu = callback_data;\r\n__be32 *buf = (__be32 *)data;\r\nunsigned long flags;\r\nif (tcode != TCODE_WRITE_QUADLET_REQUEST) {\r\nfw_send_response(card, request, RCODE_COMPLETE);\r\nreturn;\r\n}\r\nif (offset != motu->async_handler.offset || length != 4) {\r\nfw_send_response(card, request, RCODE_ADDRESS_ERROR);\r\nreturn;\r\n}\r\nspin_lock_irqsave(&motu->lock, flags);\r\nmotu->msg = be32_to_cpu(*buf);\r\nspin_unlock_irqrestore(&motu->lock, flags);\r\nfw_send_response(card, request, RCODE_COMPLETE);\r\nwake_up(&motu->hwdep_wait);\r\n}\r\nint snd_motu_transaction_reregister(struct snd_motu *motu)\r\n{\r\nstruct fw_device *device = fw_parent_device(motu->unit);\r\n__be32 data;\r\nint err;\r\nif (motu->async_handler.callback_data == NULL)\r\nreturn -EINVAL;\r\ndata = cpu_to_be32((device->card->node_id << 16) |\r\n(motu->async_handler.offset >> 32));\r\nerr = snd_motu_transaction_write(motu, ASYNC_ADDR_HI, &data,\r\nsizeof(data));\r\nif (err < 0)\r\nreturn err;\r\ndata = cpu_to_be32(motu->async_handler.offset);\r\nreturn snd_motu_transaction_write(motu, ASYNC_ADDR_LO, &data,\r\nsizeof(data));\r\n}\r\nint snd_motu_transaction_register(struct snd_motu *motu)\r\n{\r\nstatic const struct fw_address_region resp_register_region = {\r\n.start = 0xffffe0000000ull,\r\n.end = 0xffffe000ffffull,\r\n};\r\nint err;\r\nmotu->async_handler.length = 4;\r\nmotu->async_handler.address_callback = handle_message;\r\nmotu->async_handler.callback_data = motu;\r\nerr = fw_core_add_address_handler(&motu->async_handler,\r\n&resp_register_region);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_motu_transaction_reregister(motu);\r\nif (err < 0) {\r\nfw_core_remove_address_handler(&motu->async_handler);\r\nmotu->async_handler.address_callback = NULL;\r\n}\r\nreturn err;\r\n}\r\nvoid snd_motu_transaction_unregister(struct snd_motu *motu)\r\n{\r\n__be32 data;\r\nif (motu->async_handler.address_callback != NULL)\r\nfw_core_remove_address_handler(&motu->async_handler);\r\nmotu->async_handler.address_callback = NULL;\r\ndata = cpu_to_be32(0x00000000);\r\nsnd_motu_transaction_write(motu, ASYNC_ADDR_HI, &data, sizeof(data));\r\nsnd_motu_transaction_write(motu, ASYNC_ADDR_LO, &data, sizeof(data));\r\n}

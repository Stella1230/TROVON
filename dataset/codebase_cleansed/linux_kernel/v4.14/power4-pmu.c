static int p4_marked_instr_event(u64 event)\r\n{\r\nint pmc, psel, unit, byte, bit;\r\nunsigned int mask;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\npsel = event & PM_PMCSEL_MSK;\r\nif (pmc) {\r\nif (direct_marked_event[pmc - 1] & (1 << psel))\r\nreturn 1;\r\nif (psel == 0)\r\nbit = (pmc <= 4)? pmc - 1: 8 - pmc;\r\nelse if (psel == 6)\r\nbit = 4;\r\nelse\r\nreturn 0;\r\n} else\r\nbit = psel;\r\nbyte = (event >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nmask = 0;\r\nswitch (unit) {\r\ncase PM_LSU1:\r\nif (event & PM_LOWER_MSKS)\r\nmask = 1 << 28;\r\nelse\r\nmask = 6 << 24;\r\nbreak;\r\ncase PM_LSU0:\r\nmask = 0x083dff00;\r\n}\r\nreturn (mask >> (byte * 8 + bit)) & 1;\r\n}\r\nstatic int p4_get_constraint(u64 event, unsigned long *maskp,\r\nunsigned long *valp)\r\n{\r\nint pmc, byte, unit, lower, sh;\r\nunsigned long mask = 0, value = 0;\r\nint grp = -1;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc > 8)\r\nreturn -1;\r\nsh = (pmc - 1) * 2;\r\nmask |= 2 << sh;\r\nvalue |= 1 << sh;\r\ngrp = ((pmc - 1) >> 1) & 1;\r\n}\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nbyte = (event >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nif (unit) {\r\nlower = (event >> PM_LOWER_SH) & PM_LOWER_MSK;\r\nif (!pmc)\r\ngrp = byte & 1;\r\nif (!p4_unitinfo[unit].unit)\r\nreturn -1;\r\nmask |= p4_unitinfo[unit].mask;\r\nvalue |= p4_unitinfo[unit].value;\r\nsh = p4_unitinfo[unit].lowerbit;\r\nif (sh > 1)\r\nvalue |= (unsigned long)lower << sh;\r\nelse if (lower != sh)\r\nreturn -1;\r\nunit = p4_unitinfo[unit].unit;\r\nmask |= 0xfULL << (28 - 4 * byte);\r\nvalue |= (unsigned long)unit << (28 - 4 * byte);\r\n}\r\nif (grp == 0) {\r\nmask |= 0x8000000000ull;\r\nvalue |= 0x1000000000ull;\r\n} else {\r\nmask |= 0x800000000ull;\r\nvalue |= 0x100000000ull;\r\n}\r\nif (p4_marked_instr_event(event)) {\r\nmask |= 1ull << 56;\r\nvalue |= 1ull << 56;\r\n}\r\nif (pmc && (event & PM_PMCSEL_MSK) == 6 && byte == 2)\r\nmask |= 1ull << 56;\r\n*maskp = mask;\r\n*valp = value;\r\nreturn 0;\r\n}\r\nstatic int p4_get_alternatives(u64 event, unsigned int flags, u64 alt[])\r\n{\r\nint i, j, na;\r\nalt[0] = event;\r\nna = 1;\r\nif (event == 0x8003 || event == 0x0224) {\r\nalt[1] = event ^ (0x8003 ^ 0x0224);\r\nreturn 2;\r\n}\r\nif (event == 0x0c13 || event == 0x0c23) {\r\nalt[1] = event ^ (0x0c13 ^ 0x0c23);\r\nreturn 2;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(ppc_inst_cmpl); ++i) {\r\nif (event == ppc_inst_cmpl[i]) {\r\nfor (j = 0; j < ARRAY_SIZE(ppc_inst_cmpl); ++j)\r\nif (j != i)\r\nalt[na++] = ppc_inst_cmpl[j];\r\nbreak;\r\n}\r\n}\r\nreturn na;\r\n}\r\nstatic int p4_compute_mmcr(u64 event[], int n_ev,\r\nunsigned int hwc[], unsigned long mmcr[], struct perf_event *pevents[])\r\n{\r\nunsigned long mmcr0 = 0, mmcr1 = 0, mmcra = 0;\r\nunsigned int pmc, unit, byte, psel, lower;\r\nunsigned int ttm, grp;\r\nunsigned int pmc_inuse = 0;\r\nunsigned int pmc_grp_use[2];\r\nunsigned char busbyte[4];\r\nunsigned char unituse[16];\r\nunsigned int unitlower = 0;\r\nint i;\r\nif (n_ev > 8)\r\nreturn -1;\r\npmc_grp_use[0] = pmc_grp_use[1] = 0;\r\nmemset(busbyte, 0, sizeof(busbyte));\r\nmemset(unituse, 0, sizeof(unituse));\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc_inuse & (1 << (pmc - 1)))\r\nreturn -1;\r\npmc_inuse |= 1 << (pmc - 1);\r\n++pmc_grp_use[((pmc - 1) >> 1) & 1];\r\n}\r\nunit = (event[i] >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nbyte = (event[i] >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nlower = (event[i] >> PM_LOWER_SH) & PM_LOWER_MSK;\r\nif (unit) {\r\nif (!pmc)\r\n++pmc_grp_use[byte & 1];\r\nif (unit == 6 || unit == 8)\r\nunit = (unit >> 1) - 1;\r\nif (busbyte[byte] && busbyte[byte] != unit)\r\nreturn -1;\r\nbusbyte[byte] = unit;\r\nlower <<= unit;\r\nif (unituse[unit] && lower != (unitlower & lower))\r\nreturn -1;\r\nunituse[unit] = 1;\r\nunitlower |= lower;\r\n}\r\n}\r\nif (pmc_grp_use[0] > 4 || pmc_grp_use[1] > 4)\r\nreturn -1;\r\nif (unituse[2] & (unituse[1] | (unituse[3] & unituse[9]))) {\r\nunituse[6] = 1;\r\nunituse[2] = 0;\r\n}\r\nif (unituse[3] & (unituse[1] | unituse[2])) {\r\nunituse[8] = 1;\r\nunituse[3] = 0;\r\nunitlower = (unitlower & ~8) | ((unitlower & 8) << 5);\r\n}\r\nif (unituse[1] + unituse[2] + unituse[3] > 1 ||\r\nunituse[4] + unituse[6] + unituse[7] > 1 ||\r\nunituse[8] + unituse[9] > 1 ||\r\n(unituse[5] | unituse[10] | unituse[11] |\r\nunituse[13] | unituse[14]))\r\nreturn -1;\r\nmmcr1 |= (unsigned long)(unituse[3] * 2 + unituse[2])\r\n<< MMCR1_TTM0SEL_SH;\r\nmmcr1 |= (unsigned long)(unituse[7] * 3 + unituse[6] * 2)\r\n<< MMCR1_TTM1SEL_SH;\r\nmmcr1 |= (unsigned long)unituse[9] << MMCR1_TTM2SEL_SH;\r\nif (unitlower & 0xe)\r\nmmcr1 |= 1ull << MMCR1_TTC0SEL_SH;\r\nif (unitlower & 0xf0)\r\nmmcr1 |= 1ull << MMCR1_TTC1SEL_SH;\r\nif (unitlower & 0xf00)\r\nmmcr1 |= 1ull << MMCR1_TTC2SEL_SH;\r\nif (unitlower & 0x7000)\r\nmmcr1 |= 1ull << MMCR1_TTC3SEL_SH;\r\nfor (byte = 0; byte < 4; ++byte) {\r\nunit = busbyte[byte];\r\nif (!unit)\r\ncontinue;\r\nif (unit == 0xf) {\r\nmmcr1 |= 1ull << (MMCR1_DEBUG0SEL_SH - byte);\r\n} else {\r\nif (!unituse[unit])\r\nttm = unit - 1;\r\nelse\r\nttm = unit >> 2;\r\nmmcr1 |= (unsigned long)ttm\r\n<< (MMCR1_TD_CP_DBG0SEL_SH - 2 * byte);\r\n}\r\n}\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nunit = (event[i] >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nbyte = (event[i] >> PM_BYTE_SH) & PM_BYTE_MSK;\r\npsel = event[i] & PM_PMCSEL_MSK;\r\nif (!pmc) {\r\nif (unit)\r\npsel |= 0x10 | ((byte & 2) << 2);\r\nfor (pmc = 0; pmc < 8; ++pmc) {\r\nif (pmc_inuse & (1 << pmc))\r\ncontinue;\r\ngrp = (pmc >> 1) & 1;\r\nif (unit) {\r\nif (grp == (byte & 1))\r\nbreak;\r\n} else if (pmc_grp_use[grp] < 4) {\r\n++pmc_grp_use[grp];\r\nbreak;\r\n}\r\n}\r\npmc_inuse |= 1 << pmc;\r\n} else {\r\n--pmc;\r\nif (psel == 0 && (byte & 2))\r\nmmcr1 |= 1ull << mmcr1_adder_bits[pmc];\r\nelse if (psel == 6 && byte == 3)\r\nmmcra |= MMCRA_SAMPLE_ENABLE;\r\npsel |= 8;\r\n}\r\nif (pmc <= 1)\r\nmmcr0 |= psel << (MMCR0_PMC1SEL_SH - 7 * pmc);\r\nelse\r\nmmcr1 |= psel << (MMCR1_PMC3SEL_SH - 5 * (pmc - 2));\r\nif (pmc == 7)\r\nmmcra |= (psel & 1) << MMCRA_PMC8SEL0_SH;\r\nhwc[i] = pmc;\r\nif (p4_marked_instr_event(event[i]))\r\nmmcra |= MMCRA_SAMPLE_ENABLE;\r\n}\r\nif (pmc_inuse & 1)\r\nmmcr0 |= MMCR0_PMC1CE;\r\nif (pmc_inuse & 0xfe)\r\nmmcr0 |= MMCR0_PMCjCE;\r\nmmcra |= 0x2000;\r\nmmcr[0] = mmcr0;\r\nmmcr[1] = mmcr1;\r\nmmcr[2] = mmcra;\r\nreturn 0;\r\n}\r\nstatic void p4_disable_pmc(unsigned int pmc, unsigned long mmcr[])\r\n{\r\nif (pmc <= 1) {\r\nmmcr[0] &= ~(0x1fUL << (MMCR0_PMC1SEL_SH - 7 * pmc));\r\n} else {\r\nmmcr[1] &= ~(0x1fUL << (MMCR1_PMC3SEL_SH - 5 * (pmc - 2)));\r\nif (pmc == 7)\r\nmmcr[2] &= ~(1UL << MMCRA_PMC8SEL0_SH);\r\n}\r\n}\r\nstatic int __init init_power4_pmu(void)\r\n{\r\nif (!cur_cpu_spec->oprofile_cpu_type ||\r\nstrcmp(cur_cpu_spec->oprofile_cpu_type, "ppc64/power4"))\r\nreturn -ENODEV;\r\nreturn register_power_pmu(&power4_pmu);\r\n}

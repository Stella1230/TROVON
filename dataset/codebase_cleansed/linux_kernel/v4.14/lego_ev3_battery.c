static int lego_ev3_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\r\nint val2;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = batt->technology;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\niio_read_channel_processed(batt->iio_v, &val->intval);\r\nval->intval *= 2000;\r\nval->intval += 200000;\r\niio_read_channel_processed(batt->iio_i, &val2);\r\nval2 *= 1000;\r\nval2 /= 15;\r\nval->intval += val2;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nval->intval = batt->v_max;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nval->intval = batt->v_min;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\niio_read_channel_processed(batt->iio_i, &val->intval);\r\nval->intval *= 20000;\r\nval->intval /= 15;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_SCOPE:\r\nval->intval = POWER_SUPPLY_SCOPE_SYSTEM;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lego_ev3_battery_set_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nif (batt->technology != POWER_SUPPLY_TECHNOLOGY_UNKNOWN)\r\nreturn -EINVAL;\r\nswitch (val->intval) {\r\ncase POWER_SUPPLY_TECHNOLOGY_NiMH:\r\nbatt->technology = POWER_SUPPLY_TECHNOLOGY_NiMH;\r\nbatt->v_max = 7800000;\r\nbatt->v_min = 5400000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lego_ev3_battery_property_is_writeable(struct power_supply *psy,\r\nenum power_supply_property psp)\r\n{\r\nstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\r\nreturn psp == POWER_SUPPLY_PROP_TECHNOLOGY &&\r\nbatt->technology == POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\n}\r\nstatic int lego_ev3_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct lego_ev3_battery *batt;\r\nstruct power_supply_config psy_cfg = {};\r\nint err;\r\nbatt = devm_kzalloc(dev, sizeof(*batt), GFP_KERNEL);\r\nif (!batt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, batt);\r\nbatt->iio_v = devm_iio_channel_get(dev, "voltage");\r\nerr = PTR_ERR_OR_ZERO(batt->iio_v);\r\nif (err) {\r\nif (err != -EPROBE_DEFER)\r\ndev_err(dev, "Failed to get voltage iio channel\n");\r\nreturn err;\r\n}\r\nbatt->iio_i = devm_iio_channel_get(dev, "current");\r\nerr = PTR_ERR_OR_ZERO(batt->iio_i);\r\nif (err) {\r\nif (err != -EPROBE_DEFER)\r\ndev_err(dev, "Failed to get current iio channel\n");\r\nreturn err;\r\n}\r\nbatt->rechargeable_gpio = devm_gpiod_get(dev, "rechargeable", GPIOD_IN);\r\nerr = PTR_ERR_OR_ZERO(batt->rechargeable_gpio);\r\nif (err) {\r\nif (err != -EPROBE_DEFER)\r\ndev_err(dev, "Failed to get rechargeable gpio\n");\r\nreturn err;\r\n}\r\nif (gpiod_get_value(batt->rechargeable_gpio)) {\r\nbatt->technology = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbatt->v_max = 84000000;\r\nbatt->v_min = 60000000;\r\n} else {\r\nbatt->technology = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\nbatt->v_max = 90000000;\r\nbatt->v_min = 48000000;\r\n}\r\npsy_cfg.of_node = pdev->dev.of_node;\r\npsy_cfg.drv_data = batt;\r\nbatt->psy = devm_power_supply_register(dev, &lego_ev3_battery_desc,\r\n&psy_cfg);\r\nerr = PTR_ERR_OR_ZERO(batt->psy);\r\nif (err) {\r\ndev_err(dev, "failed to register power supply\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

static inline struct tpm_tis_spi_phy *to_tpm_tis_spi_phy(struct tpm_tis_data *data)\r\n{\r\nreturn container_of(data, struct tpm_tis_spi_phy, priv);\r\n}\r\nstatic int tpm_tis_spi_transfer(struct tpm_tis_data *data, u32 addr, u16 len,\r\nu8 *buffer, u8 direction)\r\n{\r\nstruct tpm_tis_spi_phy *phy = to_tpm_tis_spi_phy(data);\r\nint ret = 0;\r\nint i;\r\nstruct spi_message m;\r\nstruct spi_transfer spi_xfer;\r\nu8 transfer_len;\r\nspi_bus_lock(phy->spi_device->master);\r\nwhile (len) {\r\ntransfer_len = min_t(u16, len, MAX_SPI_FRAMESIZE);\r\nphy->tx_buf[0] = direction | (transfer_len - 1);\r\nphy->tx_buf[1] = 0xd4;\r\nphy->tx_buf[2] = addr >> 8;\r\nphy->tx_buf[3] = addr;\r\nmemset(&spi_xfer, 0, sizeof(spi_xfer));\r\nspi_xfer.tx_buf = phy->tx_buf;\r\nspi_xfer.rx_buf = phy->rx_buf;\r\nspi_xfer.len = 4;\r\nspi_xfer.cs_change = 1;\r\nspi_message_init(&m);\r\nspi_message_add_tail(&spi_xfer, &m);\r\nret = spi_sync_locked(phy->spi_device, &m);\r\nif (ret < 0)\r\ngoto exit;\r\nif ((phy->rx_buf[3] & 0x01) == 0) {\r\nphy->tx_buf[0] = 0;\r\nfor (i = 0; i < TPM_RETRY; i++) {\r\nspi_xfer.len = 1;\r\nspi_message_init(&m);\r\nspi_message_add_tail(&spi_xfer, &m);\r\nret = spi_sync_locked(phy->spi_device, &m);\r\nif (ret < 0)\r\ngoto exit;\r\nif (phy->rx_buf[0] & 0x01)\r\nbreak;\r\n}\r\nif (i == TPM_RETRY) {\r\nret = -ETIMEDOUT;\r\ngoto exit;\r\n}\r\n}\r\nspi_xfer.cs_change = 0;\r\nspi_xfer.len = transfer_len;\r\nspi_xfer.delay_usecs = 5;\r\nif (direction) {\r\nspi_xfer.tx_buf = NULL;\r\nspi_xfer.rx_buf = buffer;\r\n} else {\r\nspi_xfer.tx_buf = buffer;\r\nspi_xfer.rx_buf = NULL;\r\n}\r\nspi_message_init(&m);\r\nspi_message_add_tail(&spi_xfer, &m);\r\nret = spi_sync_locked(phy->spi_device, &m);\r\nif (ret < 0)\r\ngoto exit;\r\nlen -= transfer_len;\r\nbuffer += transfer_len;\r\n}\r\nexit:\r\nspi_bus_unlock(phy->spi_device->master);\r\nreturn ret;\r\n}\r\nstatic int tpm_tis_spi_read_bytes(struct tpm_tis_data *data, u32 addr,\r\nu16 len, u8 *result)\r\n{\r\nreturn tpm_tis_spi_transfer(data, addr, len, result, 0x80);\r\n}\r\nstatic int tpm_tis_spi_write_bytes(struct tpm_tis_data *data, u32 addr,\r\nu16 len, u8 *value)\r\n{\r\nreturn tpm_tis_spi_transfer(data, addr, len, value, 0);\r\n}\r\nstatic int tpm_tis_spi_read16(struct tpm_tis_data *data, u32 addr, u16 *result)\r\n{\r\nint rc;\r\nrc = data->phy_ops->read_bytes(data, addr, sizeof(u16), (u8 *)result);\r\nif (!rc)\r\n*result = le16_to_cpu(*result);\r\nreturn rc;\r\n}\r\nstatic int tpm_tis_spi_read32(struct tpm_tis_data *data, u32 addr, u32 *result)\r\n{\r\nint rc;\r\nrc = data->phy_ops->read_bytes(data, addr, sizeof(u32), (u8 *)result);\r\nif (!rc)\r\n*result = le32_to_cpu(*result);\r\nreturn rc;\r\n}\r\nstatic int tpm_tis_spi_write32(struct tpm_tis_data *data, u32 addr, u32 value)\r\n{\r\nvalue = cpu_to_le32(value);\r\nreturn data->phy_ops->write_bytes(data, addr, sizeof(u32),\r\n(u8 *)&value);\r\n}\r\nstatic int tpm_tis_spi_probe(struct spi_device *dev)\r\n{\r\nstruct tpm_tis_spi_phy *phy;\r\nphy = devm_kzalloc(&dev->dev, sizeof(struct tpm_tis_spi_phy),\r\nGFP_KERNEL);\r\nif (!phy)\r\nreturn -ENOMEM;\r\nphy->spi_device = dev;\r\nreturn tpm_tis_core_init(&dev->dev, &phy->priv, -1, &tpm_spi_phy_ops,\r\nNULL);\r\n}\r\nstatic int tpm_tis_spi_remove(struct spi_device *dev)\r\n{\r\nstruct tpm_chip *chip = spi_get_drvdata(dev);\r\ntpm_chip_unregister(chip);\r\ntpm_tis_remove(chip);\r\nreturn 0;\r\n}

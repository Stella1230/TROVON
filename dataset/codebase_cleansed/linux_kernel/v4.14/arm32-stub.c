efi_status_t check_platform_features(efi_system_table_t *sys_table_arg)\r\n{\r\nint block;\r\nif (!IS_ENABLED(CONFIG_ARM_LPAE))\r\nreturn EFI_SUCCESS;\r\nblock = cpuid_feature_extract(CPUID_EXT_MMFR0, 0);\r\nif (block < 5) {\r\npr_efi_err(sys_table_arg, "This LPAE kernel is not supported by your CPU\n");\r\nreturn EFI_UNSUPPORTED;\r\n}\r\nreturn EFI_SUCCESS;\r\n}\r\nstruct screen_info *alloc_screen_info(efi_system_table_t *sys_table_arg)\r\n{\r\nstruct screen_info *si;\r\nefi_status_t status;\r\nstatus = efi_call_early(allocate_pool, EFI_RUNTIME_SERVICES_DATA,\r\nsizeof(*si), (void **)&si);\r\nif (status != EFI_SUCCESS)\r\nreturn NULL;\r\nstatus = efi_call_early(install_configuration_table,\r\n&screen_info_guid, si);\r\nif (status == EFI_SUCCESS)\r\nreturn si;\r\nefi_call_early(free_pool, si);\r\nreturn NULL;\r\n}\r\nvoid free_screen_info(efi_system_table_t *sys_table_arg, struct screen_info *si)\r\n{\r\nif (!si)\r\nreturn;\r\nefi_call_early(install_configuration_table, &screen_info_guid, NULL);\r\nefi_call_early(free_pool, si);\r\n}\r\nstatic efi_status_t reserve_kernel_base(efi_system_table_t *sys_table_arg,\r\nunsigned long dram_base,\r\nunsigned long *reserve_addr,\r\nunsigned long *reserve_size)\r\n{\r\nefi_physical_addr_t alloc_addr;\r\nefi_memory_desc_t *memory_map;\r\nunsigned long nr_pages, map_size, desc_size, buff_size;\r\nefi_status_t status;\r\nunsigned long l;\r\nstruct efi_boot_memmap map = {\r\n.map = &memory_map,\r\n.map_size = &map_size,\r\n.desc_size = &desc_size,\r\n.desc_ver = NULL,\r\n.key_ptr = NULL,\r\n.buff_size = &buff_size,\r\n};\r\nalloc_addr = dram_base + MAX_UNCOMP_KERNEL_SIZE;\r\nnr_pages = MAX_UNCOMP_KERNEL_SIZE / EFI_PAGE_SIZE;\r\nstatus = efi_call_early(allocate_pages, EFI_ALLOCATE_MAX_ADDRESS,\r\nEFI_BOOT_SERVICES_DATA, nr_pages, &alloc_addr);\r\nif (status == EFI_SUCCESS) {\r\nif (alloc_addr == dram_base) {\r\n*reserve_addr = alloc_addr;\r\n*reserve_size = MAX_UNCOMP_KERNEL_SIZE;\r\nreturn EFI_SUCCESS;\r\n}\r\n}\r\nstatus = efi_get_memory_map(sys_table_arg, &map);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table_arg,\r\n"reserve_kernel_base(): Unable to retrieve memory map.\n");\r\nreturn status;\r\n}\r\nfor (l = 0; l < map_size; l += desc_size) {\r\nefi_memory_desc_t *desc;\r\nu64 start, end;\r\ndesc = (void *)memory_map + l;\r\nstart = desc->phys_addr;\r\nend = start + desc->num_pages * EFI_PAGE_SIZE;\r\nif (start >= dram_base + MAX_UNCOMP_KERNEL_SIZE ||\r\nend <= dram_base)\r\ncontinue;\r\nswitch (desc->type) {\r\ncase EFI_BOOT_SERVICES_CODE:\r\ncase EFI_BOOT_SERVICES_DATA:\r\ncontinue;\r\ncase EFI_CONVENTIONAL_MEMORY:\r\nstart = max(start, (u64)dram_base);\r\nend = min(end, (u64)dram_base + MAX_UNCOMP_KERNEL_SIZE);\r\nstatus = efi_call_early(allocate_pages,\r\nEFI_ALLOCATE_ADDRESS,\r\nEFI_LOADER_DATA,\r\n(end - start) / EFI_PAGE_SIZE,\r\n&start);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table_arg,\r\n"reserve_kernel_base(): alloc failed.\n");\r\ngoto out;\r\n}\r\nbreak;\r\ncase EFI_LOADER_CODE:\r\ncase EFI_LOADER_DATA:\r\ndefault:\r\nstatus = EFI_OUT_OF_RESOURCES;\r\ngoto out;\r\n}\r\n}\r\nstatus = EFI_SUCCESS;\r\nout:\r\nefi_call_early(free_pool, memory_map);\r\nreturn status;\r\n}\r\nefi_status_t handle_kernel_image(efi_system_table_t *sys_table,\r\nunsigned long *image_addr,\r\nunsigned long *image_size,\r\nunsigned long *reserve_addr,\r\nunsigned long *reserve_size,\r\nunsigned long dram_base,\r\nefi_loaded_image_t *image)\r\n{\r\nefi_status_t status;\r\ndram_base = round_up(dram_base, SZ_128M);\r\nstatus = reserve_kernel_base(sys_table, dram_base, reserve_addr,\r\nreserve_size);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table, "Unable to allocate memory for uncompressed kernel.\n");\r\nreturn status;\r\n}\r\n*image_size = image->image_size;\r\nstatus = efi_relocate_kernel(sys_table, image_addr, *image_size,\r\n*image_size,\r\ndram_base + MAX_UNCOMP_KERNEL_SIZE, 0);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table, "Failed to relocate kernel.\n");\r\nefi_free(sys_table, *reserve_size, *reserve_addr);\r\n*reserve_size = 0;\r\nreturn status;\r\n}\r\nif (*image_addr + *image_size > dram_base + ZIMAGE_OFFSET_LIMIT) {\r\npr_efi_err(sys_table, "Failed to relocate kernel, no low memory available.\n");\r\nefi_free(sys_table, *reserve_size, *reserve_addr);\r\n*reserve_size = 0;\r\nefi_free(sys_table, *image_size, *image_addr);\r\n*image_size = 0;\r\nreturn EFI_LOAD_ERROR;\r\n}\r\nreturn EFI_SUCCESS;\r\n}

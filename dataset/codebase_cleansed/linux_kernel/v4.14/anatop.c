static void imx_anatop_enable_weak2p5(bool enable)\r\n{\r\nu32 reg, val;\r\nregmap_read(anatop, ANADIG_ANA_MISC0, &val);\r\nreg = ANADIG_REG_2P5;\r\nreg += (enable && (val & BM_ANADIG_ANA_MISC0_STOP_MODE_CONFIG) == 0) ?\r\nREG_SET : REG_CLR;\r\nregmap_write(anatop, reg, BM_ANADIG_REG_2P5_ENABLE_WEAK_LINREG);\r\n}\r\nstatic void imx_anatop_enable_fet_odrive(bool enable)\r\n{\r\nregmap_write(anatop, ANADIG_REG_CORE + (enable ? REG_SET : REG_CLR),\r\nBM_ANADIG_REG_CORE_FET_ODRIVE);\r\n}\r\nstatic inline void imx_anatop_enable_2p5_pulldown(bool enable)\r\n{\r\nregmap_write(anatop, ANADIG_REG_2P5 + (enable ? REG_SET : REG_CLR),\r\nBM_ANADIG_REG_2P5_ENABLE_PULLDOWN);\r\n}\r\nstatic inline void imx_anatop_disconnect_high_snvs(bool enable)\r\n{\r\nregmap_write(anatop, ANADIG_ANA_MISC0 + (enable ? REG_SET : REG_CLR),\r\nBM_ANADIG_ANA_MISC0_DISCON_HIGH_SNVS);\r\n}\r\nvoid imx_anatop_pre_suspend(void)\r\n{\r\nif (imx_mmdc_get_ddr_type() == IMX_DDR_TYPE_LPDDR2)\r\nimx_anatop_enable_2p5_pulldown(true);\r\nelse\r\nimx_anatop_enable_weak2p5(true);\r\nimx_anatop_enable_fet_odrive(true);\r\nif (cpu_is_imx6sl())\r\nimx_anatop_disconnect_high_snvs(true);\r\n}\r\nvoid imx_anatop_post_resume(void)\r\n{\r\nif (imx_mmdc_get_ddr_type() == IMX_DDR_TYPE_LPDDR2)\r\nimx_anatop_enable_2p5_pulldown(false);\r\nelse\r\nimx_anatop_enable_weak2p5(false);\r\nimx_anatop_enable_fet_odrive(false);\r\nif (cpu_is_imx6sl())\r\nimx_anatop_disconnect_high_snvs(false);\r\n}\r\nstatic void imx_anatop_usb_chrg_detect_disable(void)\r\n{\r\nregmap_write(anatop, ANADIG_USB1_CHRG_DETECT,\r\nBM_ANADIG_USB_CHRG_DETECT_EN_B\r\n| BM_ANADIG_USB_CHRG_DETECT_CHK_CHRG_B);\r\nregmap_write(anatop, ANADIG_USB2_CHRG_DETECT,\r\nBM_ANADIG_USB_CHRG_DETECT_EN_B |\r\nBM_ANADIG_USB_CHRG_DETECT_CHK_CHRG_B);\r\n}\r\nvoid __init imx_init_revision_from_anatop(void)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *anatop_base;\r\nunsigned int revision;\r\nu32 digprog;\r\nu16 offset = ANADIG_DIGPROG;\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,imx6q-anatop");\r\nanatop_base = of_iomap(np, 0);\r\nWARN_ON(!anatop_base);\r\nif (of_device_is_compatible(np, "fsl,imx6sl-anatop"))\r\noffset = ANADIG_DIGPROG_IMX6SL;\r\nif (of_device_is_compatible(np, "fsl,imx7d-anatop"))\r\noffset = ANADIG_DIGPROG_IMX7D;\r\ndigprog = readl_relaxed(anatop_base + offset);\r\niounmap(anatop_base);\r\nswitch (digprog & 0xff) {\r\ncase 0:\r\nif (digprog >> 8 & 0x01)\r\nrevision = IMX_CHIP_REVISION_2_0;\r\nelse\r\nrevision = IMX_CHIP_REVISION_1_0;\r\nbreak;\r\ncase 1:\r\nrevision = IMX_CHIP_REVISION_1_1;\r\nbreak;\r\ncase 2:\r\nrevision = IMX_CHIP_REVISION_1_2;\r\nbreak;\r\ncase 3:\r\nrevision = IMX_CHIP_REVISION_1_3;\r\nbreak;\r\ncase 4:\r\nrevision = IMX_CHIP_REVISION_1_4;\r\nbreak;\r\ncase 5:\r\nrevision = IMX_CHIP_REVISION_1_5;\r\nbreak;\r\ndefault:\r\nrevision = digprog & 0xff;\r\n}\r\nmxc_set_cpu_type(digprog >> 16 & 0xff);\r\nimx_set_soc_revision(revision);\r\n}\r\nvoid __init imx_anatop_init(void)\r\n{\r\nanatop = syscon_regmap_lookup_by_compatible("fsl,imx6q-anatop");\r\nif (IS_ERR(anatop)) {\r\npr_err("%s: failed to find imx6q-anatop regmap!\n", __func__);\r\nreturn;\r\n}\r\nimx_anatop_usb_chrg_detect_disable();\r\n}

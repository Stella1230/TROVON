void emergency_restart(void)\r\n{\r\nkmsg_dump(KMSG_DUMP_EMERG);\r\nmachine_emergency_restart();\r\n}\r\nvoid kernel_restart_prepare(char *cmd)\r\n{\r\nblocking_notifier_call_chain(&reboot_notifier_list, SYS_RESTART, cmd);\r\nsystem_state = SYSTEM_RESTART;\r\nusermodehelper_disable();\r\ndevice_shutdown();\r\n}\r\nint register_reboot_notifier(struct notifier_block *nb)\r\n{\r\nreturn blocking_notifier_chain_register(&reboot_notifier_list, nb);\r\n}\r\nint unregister_reboot_notifier(struct notifier_block *nb)\r\n{\r\nreturn blocking_notifier_chain_unregister(&reboot_notifier_list, nb);\r\n}\r\nint register_restart_handler(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_register(&restart_handler_list, nb);\r\n}\r\nint unregister_restart_handler(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_unregister(&restart_handler_list, nb);\r\n}\r\nvoid do_kernel_restart(char *cmd)\r\n{\r\natomic_notifier_call_chain(&restart_handler_list, reboot_mode, cmd);\r\n}\r\nvoid migrate_to_reboot_cpu(void)\r\n{\r\nint cpu = reboot_cpu;\r\ncpu_hotplug_disable();\r\nif (!cpu_online(cpu))\r\ncpu = cpumask_first(cpu_online_mask);\r\ncurrent->flags |= PF_NO_SETAFFINITY;\r\nset_cpus_allowed_ptr(current, cpumask_of(cpu));\r\n}\r\nvoid kernel_restart(char *cmd)\r\n{\r\nkernel_restart_prepare(cmd);\r\nmigrate_to_reboot_cpu();\r\nsyscore_shutdown();\r\nif (!cmd)\r\npr_emerg("Restarting system\n");\r\nelse\r\npr_emerg("Restarting system with command '%s'\n", cmd);\r\nkmsg_dump(KMSG_DUMP_RESTART);\r\nmachine_restart(cmd);\r\n}\r\nstatic void kernel_shutdown_prepare(enum system_states state)\r\n{\r\nblocking_notifier_call_chain(&reboot_notifier_list,\r\n(state == SYSTEM_HALT) ? SYS_HALT : SYS_POWER_OFF, NULL);\r\nsystem_state = state;\r\nusermodehelper_disable();\r\ndevice_shutdown();\r\n}\r\nvoid kernel_halt(void)\r\n{\r\nkernel_shutdown_prepare(SYSTEM_HALT);\r\nmigrate_to_reboot_cpu();\r\nsyscore_shutdown();\r\npr_emerg("System halted\n");\r\nkmsg_dump(KMSG_DUMP_HALT);\r\nmachine_halt();\r\n}\r\nvoid kernel_power_off(void)\r\n{\r\nkernel_shutdown_prepare(SYSTEM_POWER_OFF);\r\nif (pm_power_off_prepare)\r\npm_power_off_prepare();\r\nmigrate_to_reboot_cpu();\r\nsyscore_shutdown();\r\npr_emerg("Power down\n");\r\nkmsg_dump(KMSG_DUMP_POWEROFF);\r\nmachine_power_off();\r\n}\r\nstatic void deferred_cad(struct work_struct *dummy)\r\n{\r\nkernel_restart(NULL);\r\n}\r\nvoid ctrl_alt_del(void)\r\n{\r\nstatic DECLARE_WORK(cad_work, deferred_cad);\r\nif (C_A_D)\r\nschedule_work(&cad_work);\r\nelse\r\nkill_cad_pid(SIGINT, 1);\r\n}\r\nstatic int run_cmd(const char *cmd)\r\n{\r\nchar **argv;\r\nstatic char *envp[] = {\r\n"HOME=/",\r\n"PATH=/sbin:/bin:/usr/sbin:/usr/bin",\r\nNULL\r\n};\r\nint ret;\r\nargv = argv_split(GFP_KERNEL, cmd, NULL);\r\nif (argv) {\r\nret = call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);\r\nargv_free(argv);\r\n} else {\r\nret = -ENOMEM;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __orderly_reboot(void)\r\n{\r\nint ret;\r\nret = run_cmd(reboot_cmd);\r\nif (ret) {\r\npr_warn("Failed to start orderly reboot: forcing the issue\n");\r\nemergency_sync();\r\nkernel_restart(NULL);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __orderly_poweroff(bool force)\r\n{\r\nint ret;\r\nret = run_cmd(poweroff_cmd);\r\nif (ret && force) {\r\npr_warn("Failed to start orderly shutdown: forcing the issue\n");\r\nemergency_sync();\r\nkernel_power_off();\r\n}\r\nreturn ret;\r\n}\r\nstatic void poweroff_work_func(struct work_struct *work)\r\n{\r\n__orderly_poweroff(poweroff_force);\r\n}\r\nvoid orderly_poweroff(bool force)\r\n{\r\nif (force)\r\npoweroff_force = true;\r\nschedule_work(&poweroff_work);\r\n}\r\nstatic void reboot_work_func(struct work_struct *work)\r\n{\r\n__orderly_reboot();\r\n}\r\nvoid orderly_reboot(void)\r\n{\r\nschedule_work(&reboot_work);\r\n}\r\nstatic int __init reboot_setup(char *str)\r\n{\r\nfor (;;) {\r\nreboot_default = 0;\r\nswitch (*str) {\r\ncase 'w':\r\nreboot_mode = REBOOT_WARM;\r\nbreak;\r\ncase 'c':\r\nreboot_mode = REBOOT_COLD;\r\nbreak;\r\ncase 'h':\r\nreboot_mode = REBOOT_HARD;\r\nbreak;\r\ncase 's':\r\n{\r\nint rc;\r\nif (isdigit(*(str+1))) {\r\nrc = kstrtoint(str+1, 0, &reboot_cpu);\r\nif (rc)\r\nreturn rc;\r\n} else if (str[1] == 'm' && str[2] == 'p' &&\r\nisdigit(*(str+3))) {\r\nrc = kstrtoint(str+3, 0, &reboot_cpu);\r\nif (rc)\r\nreturn rc;\r\n} else\r\nreboot_mode = REBOOT_SOFT;\r\nbreak;\r\n}\r\ncase 'g':\r\nreboot_mode = REBOOT_GPIO;\r\nbreak;\r\ncase 'b':\r\ncase 'a':\r\ncase 'k':\r\ncase 't':\r\ncase 'e':\r\ncase 'p':\r\nreboot_type = *str;\r\nbreak;\r\ncase 'f':\r\nreboot_force = 1;\r\nbreak;\r\n}\r\nstr = strchr(str, ',');\r\nif (str)\r\nstr++;\r\nelse\r\nbreak;\r\n}\r\nreturn 1;\r\n}

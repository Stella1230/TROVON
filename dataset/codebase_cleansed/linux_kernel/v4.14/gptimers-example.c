static irqreturn_t gptimer_example_irq(int irq, void *dev_id)\r\n{\r\nstruct gptimer_data *data = dev_id;\r\nif (!get_gptimer_intr(TIMER5_id))\r\nreturn IRQ_NONE;\r\ndata->width = get_gptimer_pwidth(TIMER5_id);\r\ndata->period = get_gptimer_period(TIMER5_id);\r\nclear_gptimer_intr(TIMER5_id);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init gptimer_example_init(void)\r\n{\r\nint ret;\r\nret = peripheral_request(P_TMR5, DRIVER_NAME);\r\nif (ret) {\r\nprintk(KERN_NOTICE DRIVER_NAME ": peripheral request failed\n");\r\nreturn ret;\r\n}\r\nret = request_irq(SAMPLE_IRQ_TIMER, gptimer_example_irq,\r\nIRQF_SHARED, DRIVER_NAME, &data);\r\nif (ret) {\r\nprintk(KERN_NOTICE DRIVER_NAME ": IRQ request failed\n");\r\nperipheral_free(P_TMR5);\r\nreturn ret;\r\n}\r\nset_gptimer_config(TIMER5_id,\r\nWDTH_CAP | PULSE_HI | PERIOD_CNT | IRQ_ENA);\r\nenable_gptimers(TIMER5bit);\r\nreturn 0;\r\n}\r\nstatic void __exit gptimer_example_exit(void)\r\n{\r\ndisable_gptimers(TIMER5bit);\r\nfree_irq(SAMPLE_IRQ_TIMER, &data);\r\nperipheral_free(P_TMR5);\r\n}

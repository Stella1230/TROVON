static int uni2char(const wchar_t uni,\r\nunsigned char *out, int boundlen)\r\n{\r\nconst unsigned char *uni2charset;\r\nunsigned char cl = uni&0xFF;\r\nunsigned char ch = (uni>>8)&0xFF;\r\nunsigned char out0,out1;\r\nif (boundlen <= 0)\r\nreturn -ENAMETOOLONG;\r\nif (uni == 0x20ac) {\r\nout[0] = 0x80;\r\nreturn 1;\r\n}\r\nif (ch == 0) {\r\nout0 = u2c_00[cl*2];\r\nout1 = u2c_00[cl*2+1];\r\nif (out0 == 0x00 && out1 == 0x00) {\r\nif (cl<0x80) {\r\nout[0] = cl;\r\nreturn 1;\r\n}\r\nreturn -EINVAL;\r\n} else {\r\nif (boundlen <= 1)\r\nreturn -ENAMETOOLONG;\r\nout[0] = out0;\r\nout[1] = out1;\r\nreturn 2;\r\n}\r\n}\r\nuni2charset = page_uni2charset[ch];\r\nif (uni2charset) {\r\nif (boundlen <= 1)\r\nreturn -ENAMETOOLONG;\r\nout[0] = uni2charset[cl*2];\r\nout[1] = uni2charset[cl*2+1];\r\nif (out[0] == 0x00 && out[1] == 0x00)\r\nreturn -EINVAL;\r\nreturn 2;\r\n}\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int char2uni(const unsigned char *rawstring, int boundlen,\r\nwchar_t *uni)\r\n{\r\nunsigned char ch, cl;\r\nconst wchar_t *charset2uni;\r\nint n;\r\nif (boundlen <= 0)\r\nreturn -ENAMETOOLONG;\r\nif (boundlen == 1) {\r\nif (rawstring[0]==0x80) {\r\n*uni = 0x20ac;\r\n} else {\r\n*uni = rawstring[0];\r\n}\r\nreturn 1;\r\n}\r\nch = rawstring[0];\r\ncl = rawstring[1];\r\ncharset2uni = page_charset2uni[ch];\r\nif (charset2uni && cl) {\r\n*uni = charset2uni[cl];\r\nif (*uni == 0x0000)\r\nreturn -EINVAL;\r\nn = 2;\r\n} else{\r\nif (ch==0x80) {\r\n*uni = 0x20ac;\r\n} else {\r\n*uni = ch;\r\n}\r\nn = 1;\r\n}\r\nreturn n;\r\n}\r\nstatic int __init init_nls_cp936(void)\r\n{\r\nreturn register_nls(&table);\r\n}\r\nstatic void __exit exit_nls_cp936(void)\r\n{\r\nunregister_nls(&table);\r\n}

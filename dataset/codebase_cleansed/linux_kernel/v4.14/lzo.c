static void *lzo_alloc_ctx(struct crypto_scomp *tfm)\r\n{\r\nvoid *ctx;\r\nctx = kvmalloc(LZO1X_MEM_COMPRESS, GFP_KERNEL);\r\nif (!ctx)\r\nreturn ERR_PTR(-ENOMEM);\r\nreturn ctx;\r\n}\r\nstatic int lzo_init(struct crypto_tfm *tfm)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nctx->lzo_comp_mem = lzo_alloc_ctx(NULL);\r\nif (IS_ERR(ctx->lzo_comp_mem))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void lzo_free_ctx(struct crypto_scomp *tfm, void *ctx)\r\n{\r\nkvfree(ctx);\r\n}\r\nstatic void lzo_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nlzo_free_ctx(NULL, ctx->lzo_comp_mem);\r\n}\r\nstatic int __lzo_compress(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen, void *ctx)\r\n{\r\nsize_t tmp_len = *dlen;\r\nint err;\r\nerr = lzo1x_1_compress(src, slen, dst, &tmp_len, ctx);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn 0;\r\n}\r\nstatic int lzo_compress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nreturn __lzo_compress(src, slen, dst, dlen, ctx->lzo_comp_mem);\r\n}\r\nstatic int lzo_scompress(struct crypto_scomp *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen,\r\nvoid *ctx)\r\n{\r\nreturn __lzo_compress(src, slen, dst, dlen, ctx);\r\n}\r\nstatic int __lzo_decompress(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen)\r\n{\r\nint err;\r\nsize_t tmp_len = *dlen;\r\nerr = lzo1x_decompress_safe(src, slen, dst, &tmp_len);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn 0;\r\n}\r\nstatic int lzo_decompress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nreturn __lzo_decompress(src, slen, dst, dlen);\r\n}\r\nstatic int lzo_sdecompress(struct crypto_scomp *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen,\r\nvoid *ctx)\r\n{\r\nreturn __lzo_decompress(src, slen, dst, dlen);\r\n}\r\nstatic int __init lzo_mod_init(void)\r\n{\r\nint ret;\r\nret = crypto_register_alg(&alg);\r\nif (ret)\r\nreturn ret;\r\nret = crypto_register_scomp(&scomp);\r\nif (ret) {\r\ncrypto_unregister_alg(&alg);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit lzo_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\ncrypto_unregister_scomp(&scomp);\r\n}

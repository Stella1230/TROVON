void hrt_isp_css_mm_set_user_ptr(void *userptr,\r\nunsigned int num_pages,\r\nenum hrt_userptr_type type)\r\n{\r\nmy_userptr = userptr;\r\nmy_num_pages = num_pages;\r\nmy_usr_type = type;\r\n}\r\nstatic ia_css_ptr __hrt_isp_css_mm_alloc(size_t bytes, void *userptr,\r\nunsigned int num_pages,\r\nenum hrt_userptr_type type,\r\nbool cached)\r\n{\r\n#ifdef CONFIG_ION\r\nif (type == HRT_USR_ION)\r\nreturn hmm_alloc(bytes, HMM_BO_ION, 0,\r\nuserptr, cached);\r\n#endif\r\nif (type == HRT_USR_PTR) {\r\nif (userptr == NULL)\r\nreturn hmm_alloc(bytes, HMM_BO_PRIVATE, 0,\r\nNULL, cached);\r\nelse {\r\nif (num_pages < ((__page_align(bytes)) >> PAGE_SHIFT))\r\ndev_err(atomisp_dev,\r\n"user space memory size is less"\r\n" than the expected size..\n");\r\nelse if (num_pages > ((__page_align(bytes))\r\n>> PAGE_SHIFT))\r\ndev_err(atomisp_dev,\r\n"user space memory size is"\r\n" large than the expected size..\n");\r\nreturn hmm_alloc(bytes, HMM_BO_USER, 0,\r\nuserptr, cached);\r\n}\r\n} else {\r\ndev_err(atomisp_dev, "user ptr type is incorrect.\n");\r\nreturn 0;\r\n}\r\n}\r\nia_css_ptr hrt_isp_css_mm_alloc(size_t bytes)\r\n{\r\nreturn __hrt_isp_css_mm_alloc(bytes, my_userptr,\r\nmy_num_pages, my_usr_type, false);\r\n}\r\nia_css_ptr hrt_isp_css_mm_alloc_user_ptr(size_t bytes, void *userptr,\r\nunsigned int num_pages,\r\nenum hrt_userptr_type type,\r\nbool cached)\r\n{\r\nreturn __hrt_isp_css_mm_alloc(bytes, userptr, num_pages,\r\ntype, cached);\r\n}\r\nia_css_ptr hrt_isp_css_mm_alloc_cached(size_t bytes)\r\n{\r\nif (my_userptr == NULL)\r\nreturn hmm_alloc(bytes, HMM_BO_PRIVATE, 0, NULL,\r\nHMM_CACHED);\r\nelse {\r\nif (my_num_pages < ((__page_align(bytes)) >> PAGE_SHIFT))\r\ndev_err(atomisp_dev,\r\n"user space memory size is less"\r\n" than the expected size..\n");\r\nelse if (my_num_pages > ((__page_align(bytes)) >> PAGE_SHIFT))\r\ndev_err(atomisp_dev,\r\n"user space memory size is"\r\n" large than the expected size..\n");\r\nreturn hmm_alloc(bytes, HMM_BO_USER, 0,\r\nmy_userptr, HMM_CACHED);\r\n}\r\n}\r\nia_css_ptr hrt_isp_css_mm_calloc(size_t bytes)\r\n{\r\nia_css_ptr ptr = hrt_isp_css_mm_alloc(bytes);\r\nif (ptr)\r\nhmm_set(ptr, 0, bytes);\r\nreturn ptr;\r\n}\r\nia_css_ptr hrt_isp_css_mm_calloc_cached(size_t bytes)\r\n{\r\nia_css_ptr ptr = hrt_isp_css_mm_alloc_cached(bytes);\r\nif (ptr)\r\nhmm_set(ptr, 0, bytes);\r\nreturn ptr;\r\n}

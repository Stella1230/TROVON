static bool vnt_rx_data(struct vnt_private *priv, struct sk_buff *skb,\r\nu16 bytes_received)\r\n{\r\nstruct ieee80211_hw *hw = priv->hw;\r\nstruct ieee80211_supported_band *sband;\r\nstruct ieee80211_rx_status rx_status = { 0 };\r\nstruct ieee80211_hdr *hdr;\r\n__le16 fc;\r\nu8 *rsr, *new_rsr, *rssi;\r\n__le64 *tsf_time;\r\nu16 frame_size;\r\nint ii, r;\r\nu8 *rx_sts, *rx_rate, *sq;\r\nu8 *skb_data;\r\nu8 rate_idx = 0;\r\nu8 rate[MAX_RATE] = {2, 4, 11, 22, 12, 18, 24, 36, 48, 72, 96, 108};\r\nlong rx_dbm;\r\nframe_size = le16_to_cpu(*((__le16 *)(skb->data + 2)));\r\nif (frame_size > 2346 || frame_size < 14) {\r\ndev_dbg(&priv->pcid->dev, "------- WRONG Length 1\n");\r\nreturn false;\r\n}\r\nskb_data = (u8 *)skb->data;\r\nrx_sts = skb_data;\r\nrx_rate = skb_data + 1;\r\nsband = hw->wiphy->bands[hw->conf.chandef.chan->band];\r\nfor (r = RATE_1M; r < MAX_RATE; r++) {\r\nif (*rx_rate == rate[r])\r\nbreak;\r\n}\r\npriv->rx_rate = r;\r\nfor (ii = 0; ii < sband->n_bitrates; ii++) {\r\nif (sband->bitrates[ii].hw_value == r) {\r\nrate_idx = ii;\r\nbreak;\r\n}\r\n}\r\nif (ii == sband->n_bitrates) {\r\ndev_dbg(&priv->pcid->dev, "Wrong RxRate %x\n", *rx_rate);\r\nreturn false;\r\n}\r\ntsf_time = (__le64 *)(skb_data + bytes_received - 12);\r\nsq = skb_data + bytes_received - 4;\r\nnew_rsr = skb_data + bytes_received - 3;\r\nrssi = skb_data + bytes_received - 2;\r\nrsr = skb_data + bytes_received - 1;\r\nif (*rsr & (RSR_IVLDTYP | RSR_IVLDLEN))\r\nreturn false;\r\nRFvRSSITodBm(priv, *rssi, &rx_dbm);\r\npriv->byBBPreEDRSSI = (u8)rx_dbm + 1;\r\npriv->uCurrRSSI = *rssi;\r\nskb_pull(skb, 4);\r\nskb_trim(skb, frame_size);\r\nrx_status.mactime = le64_to_cpu(*tsf_time);\r\nrx_status.band = hw->conf.chandef.chan->band;\r\nrx_status.signal = rx_dbm;\r\nrx_status.flag = 0;\r\nrx_status.freq = hw->conf.chandef.chan->center_freq;\r\nif (!(*rsr & RSR_CRCOK))\r\nrx_status.flag |= RX_FLAG_FAILED_FCS_CRC;\r\nhdr = (struct ieee80211_hdr *)(skb->data);\r\nfc = hdr->frame_control;\r\nrx_status.rate_idx = rate_idx;\r\nif (ieee80211_has_protected(fc)) {\r\nif (priv->byLocalID > REV_ID_VT3253_A1)\r\nrx_status.flag |= RX_FLAG_DECRYPTED;\r\nif (!(*new_rsr & NEWRSR_DECRYPTOK))\r\nreturn false;\r\n}\r\nmemcpy(IEEE80211_SKB_RXCB(skb), &rx_status, sizeof(rx_status));\r\nieee80211_rx_irqsafe(priv->hw, skb);\r\nreturn true;\r\n}\r\nbool vnt_receive_frame(struct vnt_private *priv, struct vnt_rx_desc *curr_rd)\r\n{\r\nstruct vnt_rd_info *rd_info = curr_rd->rd_info;\r\nstruct sk_buff *skb;\r\nu16 frame_size;\r\nskb = rd_info->skb;\r\ndma_unmap_single(&priv->pcid->dev, rd_info->skb_dma,\r\npriv->rx_buf_sz, DMA_FROM_DEVICE);\r\nframe_size = le16_to_cpu(curr_rd->rd1.req_count)\r\n- le16_to_cpu(curr_rd->rd0.res_count);\r\nif ((frame_size > 2364) || (frame_size < 33)) {\r\ndev_dbg(&priv->pcid->dev, "Wrong frame size %d\n", frame_size);\r\ndev_kfree_skb_irq(skb);\r\nreturn true;\r\n}\r\nif (vnt_rx_data(priv, skb, frame_size))\r\nreturn true;\r\ndev_kfree_skb_irq(skb);\r\nreturn true;\r\n}

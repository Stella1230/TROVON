bool current_is_single_threaded(void)\r\n{\r\nstruct task_struct *task = current;\r\nstruct mm_struct *mm = task->mm;\r\nstruct task_struct *p, *t;\r\nbool ret;\r\nif (atomic_read(&task->signal->live) != 1)\r\nreturn false;\r\nif (atomic_read(&mm->mm_users) == 1)\r\nreturn true;\r\nret = false;\r\nrcu_read_lock();\r\nfor_each_process(p) {\r\nif (unlikely(p->flags & PF_KTHREAD))\r\ncontinue;\r\nif (unlikely(p == task->group_leader))\r\ncontinue;\r\nfor_each_thread(p, t) {\r\nif (unlikely(t->mm == mm))\r\ngoto found;\r\nif (likely(t->mm))\r\nbreak;\r\nsmp_rmb();\r\n}\r\n}\r\nret = true;\r\nfound:\r\nrcu_read_unlock();\r\nreturn ret;\r\n}

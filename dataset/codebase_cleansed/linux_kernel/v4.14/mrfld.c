static unsigned long __init tangier_calibrate_tsc(void)\r\n{\r\nunsigned long fast_calibrate;\r\nu32 lo, hi, ratio, fsb, bus_freq;\r\nrdmsr(MSR_PLATFORM_INFO, lo, hi);\r\npr_debug("IA32 PLATFORM_INFO is 0x%x : %x\n", hi, lo);\r\nratio = (lo >> 8) & 0xFF;\r\npr_debug("ratio is %d\n", ratio);\r\nif (!ratio) {\r\npr_err("Read a zero ratio, force tsc ratio to 4 ...\n");\r\nratio = 4;\r\n}\r\nrdmsr(MSR_FSB_FREQ, lo, hi);\r\npr_debug("Actual FSB frequency detected by SOC 0x%x : %x\n",\r\nhi, lo);\r\nbus_freq = lo & 0x7;\r\npr_debug("bus_freq = 0x%x\n", bus_freq);\r\nif (bus_freq == 0)\r\nfsb = FSB_FREQ_100SKU;\r\nelse if (bus_freq == 1)\r\nfsb = FSB_FREQ_100SKU;\r\nelse if (bus_freq == 2)\r\nfsb = FSB_FREQ_133SKU;\r\nelse if (bus_freq == 3)\r\nfsb = FSB_FREQ_167SKU;\r\nelse if (bus_freq == 4)\r\nfsb = FSB_FREQ_83SKU;\r\nelse if (bus_freq == 5)\r\nfsb = FSB_FREQ_400SKU;\r\nelse if (bus_freq == 6)\r\nfsb = FSB_FREQ_267SKU;\r\nelse if (bus_freq == 7)\r\nfsb = FSB_FREQ_333SKU;\r\nelse {\r\nBUG();\r\npr_err("Invalid bus_freq! Setting to minimal value!\n");\r\nfsb = FSB_FREQ_100SKU;\r\n}\r\nfast_calibrate = ratio * fsb;\r\npr_debug("calculate tangier tsc %lu KHz\n", fast_calibrate);\r\nlapic_timer_frequency = (fsb * 1000) / HZ;\r\npr_debug("Setting lapic_timer_frequency = %d\n",\r\nlapic_timer_frequency);\r\nsetup_force_cpu_cap(X86_FEATURE_TSC_KNOWN_FREQ);\r\nsetup_force_cpu_cap(X86_FEATURE_TSC_RELIABLE);\r\nreturn fast_calibrate;\r\n}\r\nstatic void __init tangier_arch_setup(void)\r\n{\r\nx86_platform.calibrate_tsc = tangier_calibrate_tsc;\r\nx86_platform.legacy.rtc = 1;\r\n}\r\nvoid *get_tangier_ops(void)\r\n{\r\nreturn &tangier_ops;\r\n}

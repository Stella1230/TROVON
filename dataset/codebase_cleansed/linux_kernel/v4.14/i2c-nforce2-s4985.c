static s32 nforce2_access_virt0(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nint error;\r\nif ((addr & 0xfc) == 0x50 || (addr & 0xfc) == 0x30\r\n|| addr == 0x18)\r\nreturn -ENXIO;\r\nmutex_lock(&nforce2_lock);\r\nerror = nforce2_smbus->algo->smbus_xfer(adap, addr, flags, read_write,\r\ncommand, size, data);\r\nmutex_unlock(&nforce2_lock);\r\nreturn error;\r\n}\r\nstatic inline s32 nforce2_access_channel(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data,\r\nu8 channels)\r\n{\r\nint error;\r\nif ((addr & 0xfc) != 0x50 && (addr & 0xfc) != 0x30)\r\nreturn -ENXIO;\r\nmutex_lock(&nforce2_lock);\r\nif (last_channels != channels) {\r\nunion i2c_smbus_data mplxdata;\r\nmplxdata.byte = channels;\r\nerror = nforce2_smbus->algo->smbus_xfer(adap, 0x18, 0,\r\nI2C_SMBUS_WRITE, 0x01,\r\nI2C_SMBUS_BYTE_DATA,\r\n&mplxdata);\r\nif (error)\r\ngoto UNLOCK;\r\nlast_channels = channels;\r\n}\r\nerror = nforce2_smbus->algo->smbus_xfer(adap, addr, flags, read_write,\r\ncommand, size, data);\r\nUNLOCK:\r\nmutex_unlock(&nforce2_lock);\r\nreturn error;\r\n}\r\nstatic s32 nforce2_access_virt1(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nreturn nforce2_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x02);\r\n}\r\nstatic s32 nforce2_access_virt2(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nreturn nforce2_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x04);\r\n}\r\nstatic s32 nforce2_access_virt3(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nreturn nforce2_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x08);\r\n}\r\nstatic s32 nforce2_access_virt4(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nreturn nforce2_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x10);\r\n}\r\nstatic int __init nforce2_s4985_init(void)\r\n{\r\nint i, error;\r\nunion i2c_smbus_data ioconfig;\r\nif (!nforce2_smbus)\r\nreturn -ENODEV;\r\nioconfig.byte = 0x00;\r\nerror = i2c_smbus_xfer(nforce2_smbus, 0x18, 0, I2C_SMBUS_WRITE, 0x03,\r\nI2C_SMBUS_BYTE_DATA, &ioconfig);\r\nif (error) {\r\ndev_err(&nforce2_smbus->dev, "PCA9556 configuration failed\n");\r\nerror = -EIO;\r\ngoto ERROR0;\r\n}\r\ni2c_del_adapter(nforce2_smbus);\r\nprintk(KERN_INFO "Enabling SMBus multiplexing for Tyan S4985\n");\r\ns4985_adapter = kzalloc(5 * sizeof(struct i2c_adapter), GFP_KERNEL);\r\nif (!s4985_adapter) {\r\nerror = -ENOMEM;\r\ngoto ERROR1;\r\n}\r\ns4985_algo = kzalloc(5 * sizeof(struct i2c_algorithm), GFP_KERNEL);\r\nif (!s4985_algo) {\r\nerror = -ENOMEM;\r\ngoto ERROR2;\r\n}\r\ns4985_algo[0] = *(nforce2_smbus->algo);\r\ns4985_algo[0].smbus_xfer = nforce2_access_virt0;\r\ns4985_adapter[0] = *nforce2_smbus;\r\ns4985_adapter[0].algo = s4985_algo;\r\ns4985_adapter[0].dev.parent = nforce2_smbus->dev.parent;\r\nfor (i = 1; i < 5; i++) {\r\ns4985_algo[i] = *(nforce2_smbus->algo);\r\ns4985_adapter[i] = *nforce2_smbus;\r\nsnprintf(s4985_adapter[i].name, sizeof(s4985_adapter[i].name),\r\n"SMBus nForce2 adapter (CPU%d)", i - 1);\r\ns4985_adapter[i].algo = s4985_algo + i;\r\ns4985_adapter[i].dev.parent = nforce2_smbus->dev.parent;\r\n}\r\ns4985_algo[1].smbus_xfer = nforce2_access_virt1;\r\ns4985_algo[2].smbus_xfer = nforce2_access_virt2;\r\ns4985_algo[3].smbus_xfer = nforce2_access_virt3;\r\ns4985_algo[4].smbus_xfer = nforce2_access_virt4;\r\nfor (i = 0; i < 5; i++) {\r\nerror = i2c_add_adapter(s4985_adapter + i);\r\nif (error) {\r\nprintk(KERN_ERR "i2c-nforce2-s4985: "\r\n"Virtual adapter %d registration "\r\n"failed, module not inserted\n", i);\r\nfor (i--; i >= 0; i--)\r\ni2c_del_adapter(s4985_adapter + i);\r\ngoto ERROR3;\r\n}\r\n}\r\nreturn 0;\r\nERROR3:\r\nkfree(s4985_algo);\r\ns4985_algo = NULL;\r\nERROR2:\r\nkfree(s4985_adapter);\r\ns4985_adapter = NULL;\r\nERROR1:\r\ni2c_add_adapter(nforce2_smbus);\r\nERROR0:\r\nreturn error;\r\n}\r\nstatic void __exit nforce2_s4985_exit(void)\r\n{\r\nif (s4985_adapter) {\r\nint i;\r\nfor (i = 0; i < 5; i++)\r\ni2c_del_adapter(s4985_adapter+i);\r\nkfree(s4985_adapter);\r\ns4985_adapter = NULL;\r\n}\r\nkfree(s4985_algo);\r\ns4985_algo = NULL;\r\nif (i2c_add_adapter(nforce2_smbus))\r\nprintk(KERN_ERR "i2c-nforce2-s4985: "\r\n"Physical bus restoration failed\n");\r\n}

static bool event_is_known(struct iio_event_data *event)\r\n{\r\nenum iio_chan_type type = IIO_EVENT_CODE_EXTRACT_CHAN_TYPE(event->id);\r\nenum iio_modifier mod = IIO_EVENT_CODE_EXTRACT_MODIFIER(event->id);\r\nenum iio_event_type ev_type = IIO_EVENT_CODE_EXTRACT_TYPE(event->id);\r\nenum iio_event_direction dir = IIO_EVENT_CODE_EXTRACT_DIR(event->id);\r\nswitch (type) {\r\ncase IIO_VOLTAGE:\r\ncase IIO_CURRENT:\r\ncase IIO_POWER:\r\ncase IIO_ACCEL:\r\ncase IIO_ANGL_VEL:\r\ncase IIO_MAGN:\r\ncase IIO_LIGHT:\r\ncase IIO_INTENSITY:\r\ncase IIO_PROXIMITY:\r\ncase IIO_TEMP:\r\ncase IIO_INCLI:\r\ncase IIO_ROT:\r\ncase IIO_ANGL:\r\ncase IIO_TIMESTAMP:\r\ncase IIO_CAPACITANCE:\r\ncase IIO_ALTVOLTAGE:\r\ncase IIO_CCT:\r\ncase IIO_PRESSURE:\r\ncase IIO_HUMIDITYRELATIVE:\r\ncase IIO_ACTIVITY:\r\ncase IIO_STEPS:\r\ncase IIO_ENERGY:\r\ncase IIO_DISTANCE:\r\ncase IIO_VELOCITY:\r\ncase IIO_CONCENTRATION:\r\ncase IIO_RESISTANCE:\r\ncase IIO_PH:\r\ncase IIO_UVINDEX:\r\ncase IIO_GRAVITY:\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nswitch (mod) {\r\ncase IIO_NO_MOD:\r\ncase IIO_MOD_X:\r\ncase IIO_MOD_Y:\r\ncase IIO_MOD_Z:\r\ncase IIO_MOD_X_AND_Y:\r\ncase IIO_MOD_X_AND_Z:\r\ncase IIO_MOD_Y_AND_Z:\r\ncase IIO_MOD_X_AND_Y_AND_Z:\r\ncase IIO_MOD_X_OR_Y:\r\ncase IIO_MOD_X_OR_Z:\r\ncase IIO_MOD_Y_OR_Z:\r\ncase IIO_MOD_X_OR_Y_OR_Z:\r\ncase IIO_MOD_LIGHT_BOTH:\r\ncase IIO_MOD_LIGHT_IR:\r\ncase IIO_MOD_ROOT_SUM_SQUARED_X_Y:\r\ncase IIO_MOD_SUM_SQUARED_X_Y_Z:\r\ncase IIO_MOD_LIGHT_CLEAR:\r\ncase IIO_MOD_LIGHT_RED:\r\ncase IIO_MOD_LIGHT_GREEN:\r\ncase IIO_MOD_LIGHT_BLUE:\r\ncase IIO_MOD_LIGHT_UV:\r\ncase IIO_MOD_QUATERNION:\r\ncase IIO_MOD_TEMP_AMBIENT:\r\ncase IIO_MOD_TEMP_OBJECT:\r\ncase IIO_MOD_NORTH_MAGN:\r\ncase IIO_MOD_NORTH_TRUE:\r\ncase IIO_MOD_NORTH_MAGN_TILT_COMP:\r\ncase IIO_MOD_NORTH_TRUE_TILT_COMP:\r\ncase IIO_MOD_RUNNING:\r\ncase IIO_MOD_JOGGING:\r\ncase IIO_MOD_WALKING:\r\ncase IIO_MOD_STILL:\r\ncase IIO_MOD_ROOT_SUM_SQUARED_X_Y_Z:\r\ncase IIO_MOD_I:\r\ncase IIO_MOD_Q:\r\ncase IIO_MOD_CO2:\r\ncase IIO_MOD_VOC:\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nswitch (ev_type) {\r\ncase IIO_EV_TYPE_THRESH:\r\ncase IIO_EV_TYPE_MAG:\r\ncase IIO_EV_TYPE_ROC:\r\ncase IIO_EV_TYPE_THRESH_ADAPTIVE:\r\ncase IIO_EV_TYPE_MAG_ADAPTIVE:\r\ncase IIO_EV_TYPE_CHANGE:\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nswitch (dir) {\r\ncase IIO_EV_DIR_EITHER:\r\ncase IIO_EV_DIR_RISING:\r\ncase IIO_EV_DIR_FALLING:\r\ncase IIO_EV_DIR_NONE:\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void print_event(struct iio_event_data *event)\r\n{\r\nenum iio_chan_type type = IIO_EVENT_CODE_EXTRACT_CHAN_TYPE(event->id);\r\nenum iio_modifier mod = IIO_EVENT_CODE_EXTRACT_MODIFIER(event->id);\r\nenum iio_event_type ev_type = IIO_EVENT_CODE_EXTRACT_TYPE(event->id);\r\nenum iio_event_direction dir = IIO_EVENT_CODE_EXTRACT_DIR(event->id);\r\nint chan = IIO_EVENT_CODE_EXTRACT_CHAN(event->id);\r\nint chan2 = IIO_EVENT_CODE_EXTRACT_CHAN2(event->id);\r\nbool diff = IIO_EVENT_CODE_EXTRACT_DIFF(event->id);\r\nif (!event_is_known(event)) {\r\nfprintf(stderr, "Unknown event: time: %lld, id: %llx\n",\r\nevent->timestamp, event->id);\r\nreturn;\r\n}\r\nprintf("Event: time: %lld, type: %s", event->timestamp,\r\niio_chan_type_name_spec[type]);\r\nif (mod != IIO_NO_MOD)\r\nprintf("(%s)", iio_modifier_names[mod]);\r\nif (chan >= 0) {\r\nprintf(", channel: %d", chan);\r\nif (diff && chan2 >= 0)\r\nprintf("-%d", chan2);\r\n}\r\nprintf(", evtype: %s", iio_ev_type_text[ev_type]);\r\nif (dir != IIO_EV_DIR_NONE)\r\nprintf(", direction: %s", iio_ev_dir_text[dir]);\r\nprintf("\n");\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nstruct iio_event_data event;\r\nconst char *device_name;\r\nchar *chrdev_name;\r\nint ret;\r\nint dev_num;\r\nint fd, event_fd;\r\nif (argc <= 1) {\r\nfprintf(stderr, "Usage: %s <device_name>\n", argv[0]);\r\nreturn -1;\r\n}\r\ndevice_name = argv[1];\r\ndev_num = find_type_by_name(device_name, "iio:device");\r\nif (dev_num >= 0) {\r\nprintf("Found IIO device with name %s with device number %d\n",\r\ndevice_name, dev_num);\r\nret = asprintf(&chrdev_name, "/dev/iio:device%d", dev_num);\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\n} else {\r\nchrdev_name = strdup(device_name);\r\nif (!chrdev_name)\r\nreturn -ENOMEM;\r\n}\r\nfd = open(chrdev_name, 0);\r\nif (fd == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to open %s\n", chrdev_name);\r\ngoto error_free_chrdev_name;\r\n}\r\nret = ioctl(fd, IIO_GET_EVENT_FD_IOCTL, &event_fd);\r\nif (ret == -1 || event_fd == -1) {\r\nret = -errno;\r\nif (ret == -ENODEV)\r\nfprintf(stderr,\r\n"This device does not support events\n");\r\nelse\r\nfprintf(stderr, "Failed to retrieve event fd\n");\r\nif (close(fd) == -1)\r\nperror("Failed to close character device file");\r\ngoto error_free_chrdev_name;\r\n}\r\nif (close(fd) == -1) {\r\nret = -errno;\r\ngoto error_free_chrdev_name;\r\n}\r\nwhile (true) {\r\nret = read(event_fd, &event, sizeof(event));\r\nif (ret == -1) {\r\nif (errno == EAGAIN) {\r\nfprintf(stderr, "nothing available\n");\r\ncontinue;\r\n} else {\r\nret = -errno;\r\nperror("Failed to read event from device");\r\nbreak;\r\n}\r\n}\r\nif (ret != sizeof(event)) {\r\nfprintf(stderr, "Reading event failed!\n");\r\nret = -EIO;\r\nbreak;\r\n}\r\nprint_event(&event);\r\n}\r\nif (close(event_fd) == -1)\r\nperror("Failed to close event file");\r\nerror_free_chrdev_name:\r\nfree(chrdev_name);\r\nreturn ret;\r\n}

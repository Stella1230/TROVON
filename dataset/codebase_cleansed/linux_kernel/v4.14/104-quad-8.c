static int quad8_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int *val, int *val2, long mask)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel;\r\nunsigned int flags;\r\nunsigned int borrow;\r\nunsigned int carry;\r\nint i;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (chan->type == IIO_INDEX) {\r\n*val = !!(inb(priv->base + 0x16) & BIT(chan->channel));\r\nreturn IIO_VAL_INT;\r\n}\r\nflags = inb(base_offset + 1);\r\nborrow = flags & BIT(0);\r\ncarry = !!(flags & BIT(1));\r\n*val = (borrow ^ carry) << 24;\r\noutb(0x11, base_offset + 1);\r\nfor (i = 0; i < 3; i++)\r\n*val |= (unsigned int)inb(base_offset) << (8 * i);\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_ENABLE:\r\n*val = priv->ab_enable[chan->channel];\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 1;\r\n*val2 = priv->quadrature_scale[chan->channel];\r\nreturn IIO_VAL_FRACTIONAL_LOG2;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int quad8_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int val, int val2, long mask)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel;\r\nint i;\r\nunsigned int ior_cfg;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (chan->type == IIO_INDEX)\r\nreturn -EINVAL;\r\nif ((unsigned int)val > 0xFFFFFF)\r\nreturn -EINVAL;\r\noutb(0x01, base_offset + 1);\r\nfor (i = 0; i < 3; i++)\r\noutb(val >> (8 * i), base_offset);\r\noutb(0x08, base_offset + 1);\r\noutb(0x01, base_offset + 1);\r\nval = priv->preset[chan->channel];\r\nfor (i = 0; i < 3; i++)\r\noutb(val >> (8 * i), base_offset);\r\noutb(0x02, base_offset + 1);\r\noutb(0x06, base_offset + 1);\r\nreturn 0;\r\ncase IIO_CHAN_INFO_ENABLE:\r\nif (val < 0 || val > 1)\r\nreturn -EINVAL;\r\npriv->ab_enable[chan->channel] = val;\r\nior_cfg = val | priv->preset_enable[chan->channel] << 1;\r\noutb(0x40 | ior_cfg, base_offset + 1);\r\nreturn 0;\r\ncase IIO_CHAN_INFO_SCALE:\r\nif (!priv->quadrature_mode[chan->channel] && (val2 || val != 1))\r\nreturn -EINVAL;\r\nif (val == 1 && !val2)\r\npriv->quadrature_scale[chan->channel] = 0;\r\nelse if (!val)\r\nswitch (val2) {\r\ncase 500000:\r\npriv->quadrature_scale[chan->channel] = 1;\r\nbreak;\r\ncase 250000:\r\npriv->quadrature_scale[chan->channel] = 2;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t quad8_read_preset(struct iio_dev *indio_dev, uintptr_t private,\r\nconst struct iio_chan_spec *chan, char *buf)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", priv->preset[chan->channel]);\r\n}\r\nstatic ssize_t quad8_write_preset(struct iio_dev *indio_dev, uintptr_t private,\r\nconst struct iio_chan_spec *chan, const char *buf, size_t len)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel;\r\nunsigned int preset;\r\nint ret;\r\nint i;\r\nret = kstrtouint(buf, 0, &preset);\r\nif (ret)\r\nreturn ret;\r\nif (preset > 0xFFFFFF)\r\nreturn -EINVAL;\r\npriv->preset[chan->channel] = preset;\r\noutb(0x01, base_offset + 1);\r\nfor (i = 0; i < 3; i++)\r\noutb(preset >> (8 * i), base_offset);\r\nreturn len;\r\n}\r\nstatic ssize_t quad8_read_set_to_preset_on_index(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, char *buf)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n",\r\n!priv->preset_enable[chan->channel]);\r\n}\r\nstatic ssize_t quad8_write_set_to_preset_on_index(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, const char *buf,\r\nsize_t len)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\nbool preset_enable;\r\nint ret;\r\nunsigned int ior_cfg;\r\nret = kstrtobool(buf, &preset_enable);\r\nif (ret)\r\nreturn ret;\r\npreset_enable = !preset_enable;\r\npriv->preset_enable[chan->channel] = preset_enable;\r\nior_cfg = priv->ab_enable[chan->channel] |\r\n(unsigned int)preset_enable << 1;\r\noutb(0x40 | ior_cfg, base_offset);\r\nreturn len;\r\n}\r\nstatic int quad8_get_noise_error(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\nreturn !!(inb(base_offset) & BIT(4));\r\n}\r\nstatic int quad8_get_count_direction(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\nreturn !!(inb(base_offset) & BIT(5));\r\n}\r\nstatic int quad8_set_count_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int count_mode)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nunsigned int mode_cfg = count_mode << 1;\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\npriv->count_mode[chan->channel] = count_mode;\r\nif (priv->quadrature_mode[chan->channel])\r\nmode_cfg |= (priv->quadrature_scale[chan->channel] + 1) << 3;\r\noutb(0x20 | mode_cfg, base_offset);\r\nreturn 0;\r\n}\r\nstatic int quad8_get_count_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn priv->count_mode[chan->channel];\r\n}\r\nstatic int quad8_set_synchronous_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int synchronous_mode)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst unsigned int idr_cfg = synchronous_mode |\r\npriv->index_polarity[chan->channel] << 1;\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\nif (synchronous_mode && !priv->quadrature_mode[chan->channel])\r\nreturn -EINVAL;\r\npriv->synchronous_mode[chan->channel] = synchronous_mode;\r\noutb(0x60 | idr_cfg, base_offset);\r\nreturn 0;\r\n}\r\nstatic int quad8_get_synchronous_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn priv->synchronous_mode[chan->channel];\r\n}\r\nstatic int quad8_set_quadrature_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int quadrature_mode)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nunsigned int mode_cfg = priv->count_mode[chan->channel] << 1;\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\nif (quadrature_mode)\r\nmode_cfg |= (priv->quadrature_scale[chan->channel] + 1) << 3;\r\nelse {\r\npriv->quadrature_scale[chan->channel] = 0;\r\nif (priv->synchronous_mode[chan->channel])\r\nquad8_set_synchronous_mode(indio_dev, chan, 0);\r\n}\r\npriv->quadrature_mode[chan->channel] = quadrature_mode;\r\noutb(0x20 | mode_cfg, base_offset);\r\nreturn 0;\r\n}\r\nstatic int quad8_get_quadrature_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn priv->quadrature_mode[chan->channel];\r\n}\r\nstatic int quad8_set_index_polarity(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int index_polarity)\r\n{\r\nstruct quad8_iio *const priv = iio_priv(indio_dev);\r\nconst unsigned int idr_cfg = priv->synchronous_mode[chan->channel] |\r\nindex_polarity << 1;\r\nconst int base_offset = priv->base + 2 * chan->channel + 1;\r\npriv->index_polarity[chan->channel] = index_polarity;\r\noutb(0x60 | idr_cfg, base_offset);\r\nreturn 0;\r\n}\r\nstatic int quad8_get_index_polarity(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nconst struct quad8_iio *const priv = iio_priv(indio_dev);\r\nreturn priv->index_polarity[chan->channel];\r\n}\r\nstatic int quad8_probe(struct device *dev, unsigned int id)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct quad8_iio *priv;\r\nint i, j;\r\nunsigned int base_offset;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(*priv));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nif (!devm_request_region(dev, base[id], QUAD8_EXTENT,\r\ndev_name(dev))) {\r\ndev_err(dev, "Unable to lock port addresses (0x%X-0x%X)\n",\r\nbase[id], base[id] + QUAD8_EXTENT);\r\nreturn -EBUSY;\r\n}\r\nindio_dev->info = &quad8_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->num_channels = ARRAY_SIZE(quad8_channels);\r\nindio_dev->channels = quad8_channels;\r\nindio_dev->name = dev_name(dev);\r\nindio_dev->dev.parent = dev;\r\npriv = iio_priv(indio_dev);\r\npriv->base = base[id];\r\noutb(0x01, base[id] + 0x11);\r\nfor (i = 0; i < QUAD8_NUM_COUNTERS; i++) {\r\nbase_offset = base[id] + 2 * i;\r\noutb(0x01, base_offset + 1);\r\nfor (j = 0; j < 3; j++)\r\noutb(0x00, base_offset);\r\noutb(0x04, base_offset + 1);\r\noutb(0x06, base_offset + 1);\r\noutb(0x20, base_offset + 1);\r\noutb(0x40, base_offset + 1);\r\noutb(0x60, base_offset + 1);\r\n}\r\noutb(0x00, base[id] + 0x11);\r\nreturn devm_iio_device_register(dev, indio_dev);\r\n}

unsigned int calculate_timespace(long load, struct config *config)\r\n{\r\nint i;\r\nlong long now, then;\r\nunsigned int estimated = GAUGECOUNT;\r\nunsigned int rounds = 0;\r\nunsigned int timed = 0;\r\nif (config->verbose)\r\nprintf("calibrating load of %lius, please wait...\n", load);\r\nnow = get_time();\r\nROUNDS(estimated);\r\nthen = get_time();\r\ntimed = (unsigned int)(then - now);\r\nfor (i = 0; i < 4; i++) {\r\nrounds = (unsigned int)(load * estimated / timed);\r\ndprintf("calibrating with %u rounds\n", rounds);\r\nnow = get_time();\r\nROUNDS(rounds);\r\nthen = get_time();\r\ntimed = (unsigned int)(then - now);\r\nestimated = rounds;\r\n}\r\nif (config->verbose)\r\nprintf("calibration done\n");\r\nreturn estimated;\r\n}\r\nvoid start_benchmark(struct config *config)\r\n{\r\nunsigned int _round, cycle;\r\nlong long now, then;\r\nlong sleep_time = 0, load_time = 0;\r\nlong performance_time = 0, powersave_time = 0;\r\nunsigned int calculations;\r\nunsigned long total_time = 0, progress_time = 0;\r\nsleep_time = config->sleep;\r\nload_time = config->load;\r\nfor (_round = 1; _round <= config->rounds; _round++)\r\ntotal_time += _round * (config->sleep + config->load);\r\ntotal_time *= 2;\r\nfor (_round = 0; _round < config->rounds; _round++) {\r\nperformance_time = 0LL;\r\npowersave_time = 0LL;\r\nshow_progress(total_time, progress_time);\r\nif (set_cpufreq_governor("performance", config->cpu) != 0)\r\nreturn;\r\ncalculations = calculate_timespace(load_time, config);\r\nif (config->verbose)\r\nprintf("_round %i: doing %u cycles with %u calculations"\r\n" for %lius\n", _round + 1, config->cycles,\r\ncalculations, load_time);\r\nfprintf(config->output, "%u %li %li ",\r\n_round, load_time, sleep_time);\r\nif (config->verbose)\r\nprintf("average: %lius, rps:%li\n",\r\nload_time / calculations,\r\n1000000 * calculations / load_time);\r\nfor (cycle = 0; cycle < config->cycles; cycle++) {\r\nnow = get_time();\r\nusleep(sleep_time);\r\nROUNDS(calculations);\r\nthen = get_time();\r\nperformance_time += then - now - sleep_time;\r\nif (config->verbose)\r\nprintf("performance cycle took %lius, "\r\n"sleep: %lius, "\r\n"load: %lius, rounds: %u\n",\r\n(long)(then - now), sleep_time,\r\nload_time, calculations);\r\n}\r\nfprintf(config->output, "%li ",\r\nperformance_time / config->cycles);\r\nprogress_time += sleep_time + load_time;\r\nshow_progress(total_time, progress_time);\r\nif (set_cpufreq_governor(config->governor, config->cpu) != 0)\r\nreturn;\r\nfor (cycle = 0; cycle < config->cycles; cycle++) {\r\nnow = get_time();\r\nusleep(sleep_time);\r\nROUNDS(calculations);\r\nthen = get_time();\r\npowersave_time += then - now - sleep_time;\r\nif (config->verbose)\r\nprintf("powersave cycle took %lius, "\r\n"sleep: %lius, "\r\n"load: %lius, rounds: %u\n",\r\n(long)(then - now), sleep_time,\r\nload_time, calculations);\r\n}\r\nprogress_time += sleep_time + load_time;\r\nfprintf(config->output, "%li ",\r\npowersave_time / config->cycles);\r\nfprintf(config->output, "%.3f\n",\r\nperformance_time * 100.0 / powersave_time);\r\nfflush(config->output);\r\nif (config->verbose)\r\nprintf("performance is at %.2f%%\n",\r\nperformance_time * 100.0 / powersave_time);\r\nsleep_time += config->sleep_step;\r\nload_time += config->load_step;\r\n}\r\n}

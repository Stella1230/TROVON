void generate_random_uuid(unsigned char uuid[16])\r\n{\r\nget_random_bytes(uuid, 16);\r\nuuid[6] = (uuid[6] & 0x0F) | 0x40;\r\nuuid[8] = (uuid[8] & 0x3F) | 0x80;\r\n}\r\nstatic void __uuid_gen_common(__u8 b[16])\r\n{\r\nprandom_bytes(b, 16);\r\nb[8] = (b[8] & 0x3F) | 0x80;\r\n}\r\nvoid guid_gen(guid_t *lu)\r\n{\r\n__uuid_gen_common(lu->b);\r\nlu->b[7] = (lu->b[7] & 0x0F) | 0x40;\r\n}\r\nvoid uuid_gen(uuid_t *bu)\r\n{\r\n__uuid_gen_common(bu->b);\r\nbu->b[6] = (bu->b[6] & 0x0F) | 0x40;\r\n}\r\nbool uuid_is_valid(const char *uuid)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < UUID_STRING_LEN; i++) {\r\nif (i == 8 || i == 13 || i == 18 || i == 23) {\r\nif (uuid[i] != '-')\r\nreturn false;\r\n} else if (!isxdigit(uuid[i])) {\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic int __uuid_parse(const char *uuid, __u8 b[16], const u8 ei[16])\r\n{\r\nstatic const u8 si[16] = {0,2,4,6,9,11,14,16,19,21,24,26,28,30,32,34};\r\nunsigned int i;\r\nif (!uuid_is_valid(uuid))\r\nreturn -EINVAL;\r\nfor (i = 0; i < 16; i++) {\r\nint hi = hex_to_bin(uuid[si[i] + 0]);\r\nint lo = hex_to_bin(uuid[si[i] + 1]);\r\nb[ei[i]] = (hi << 4) | lo;\r\n}\r\nreturn 0;\r\n}\r\nint guid_parse(const char *uuid, guid_t *u)\r\n{\r\nreturn __uuid_parse(uuid, u->b, guid_index);\r\n}\r\nint uuid_parse(const char *uuid, uuid_t *u)\r\n{\r\nreturn __uuid_parse(uuid, u->b, uuid_index);\r\n}

int fw_iso_resources_init(struct fw_iso_resources *r, struct fw_unit *unit)\r\n{\r\nr->channels_mask = ~0uLL;\r\nr->unit = unit;\r\nmutex_init(&r->mutex);\r\nr->allocated = false;\r\nreturn 0;\r\n}\r\nvoid fw_iso_resources_destroy(struct fw_iso_resources *r)\r\n{\r\nWARN_ON(r->allocated);\r\nmutex_destroy(&r->mutex);\r\n}\r\nstatic unsigned int packet_bandwidth(unsigned int max_payload_bytes, int speed)\r\n{\r\nunsigned int bytes, s400_bytes;\r\nbytes = 3 * 4 + ALIGN(max_payload_bytes, 4);\r\nif (speed <= SCODE_400)\r\ns400_bytes = bytes * (1 << (SCODE_400 - speed));\r\nelse\r\ns400_bytes = DIV_ROUND_UP(bytes, 1 << (speed - SCODE_400));\r\nreturn s400_bytes;\r\n}\r\nstatic int current_bandwidth_overhead(struct fw_card *card)\r\n{\r\nreturn card->gap_count < 63 ? card->gap_count * 97 / 10 + 89 : 512;\r\n}\r\nstatic int wait_isoch_resource_delay_after_bus_reset(struct fw_card *card)\r\n{\r\nfor (;;) {\r\ns64 delay = (card->reset_jiffies + HZ) - get_jiffies_64();\r\nif (delay <= 0)\r\nreturn 0;\r\nif (schedule_timeout_interruptible(delay) > 0)\r\nreturn -ERESTARTSYS;\r\n}\r\n}\r\nint fw_iso_resources_allocate(struct fw_iso_resources *r,\r\nunsigned int max_payload_bytes, int speed)\r\n{\r\nstruct fw_card *card = fw_parent_device(r->unit)->card;\r\nint bandwidth, channel, err;\r\nif (WARN_ON(r->allocated))\r\nreturn -EBADFD;\r\nr->bandwidth = packet_bandwidth(max_payload_bytes, speed);\r\nretry_after_bus_reset:\r\nspin_lock_irq(&card->lock);\r\nr->generation = card->generation;\r\nr->bandwidth_overhead = current_bandwidth_overhead(card);\r\nspin_unlock_irq(&card->lock);\r\nerr = wait_isoch_resource_delay_after_bus_reset(card);\r\nif (err < 0)\r\nreturn err;\r\nmutex_lock(&r->mutex);\r\nbandwidth = r->bandwidth + r->bandwidth_overhead;\r\nfw_iso_resource_manage(card, r->generation, r->channels_mask,\r\n&channel, &bandwidth, true);\r\nif (channel == -EAGAIN) {\r\nmutex_unlock(&r->mutex);\r\ngoto retry_after_bus_reset;\r\n}\r\nif (channel >= 0) {\r\nr->channel = channel;\r\nr->allocated = true;\r\n} else {\r\nif (channel == -EBUSY)\r\ndev_err(&r->unit->device,\r\n"isochronous resources exhausted\n");\r\nelse\r\ndev_err(&r->unit->device,\r\n"isochronous resource allocation failed\n");\r\n}\r\nmutex_unlock(&r->mutex);\r\nreturn channel;\r\n}\r\nint fw_iso_resources_update(struct fw_iso_resources *r)\r\n{\r\nstruct fw_card *card = fw_parent_device(r->unit)->card;\r\nint bandwidth, channel;\r\nmutex_lock(&r->mutex);\r\nif (!r->allocated) {\r\nmutex_unlock(&r->mutex);\r\nreturn 0;\r\n}\r\nspin_lock_irq(&card->lock);\r\nr->generation = card->generation;\r\nr->bandwidth_overhead = current_bandwidth_overhead(card);\r\nspin_unlock_irq(&card->lock);\r\nbandwidth = r->bandwidth + r->bandwidth_overhead;\r\nfw_iso_resource_manage(card, r->generation, 1uLL << r->channel,\r\n&channel, &bandwidth, true);\r\nif (channel < 0 && channel != -EAGAIN) {\r\nr->allocated = false;\r\nif (channel == -EBUSY)\r\ndev_err(&r->unit->device,\r\n"isochronous resources exhausted\n");\r\nelse\r\ndev_err(&r->unit->device,\r\n"isochronous resource allocation failed\n");\r\n}\r\nmutex_unlock(&r->mutex);\r\nreturn channel;\r\n}\r\nvoid fw_iso_resources_free(struct fw_iso_resources *r)\r\n{\r\nstruct fw_card *card;\r\nint bandwidth, channel;\r\nif (r->unit == NULL)\r\nreturn;\r\ncard = fw_parent_device(r->unit)->card;\r\nmutex_lock(&r->mutex);\r\nif (r->allocated) {\r\nbandwidth = r->bandwidth + r->bandwidth_overhead;\r\nfw_iso_resource_manage(card, r->generation, 1uLL << r->channel,\r\n&channel, &bandwidth, false);\r\nif (channel < 0)\r\ndev_err(&r->unit->device,\r\n"isochronous resource deallocation failed\n");\r\nr->allocated = false;\r\n}\r\nmutex_unlock(&r->mutex);\r\n}

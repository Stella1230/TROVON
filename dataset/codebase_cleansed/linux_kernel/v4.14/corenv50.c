int\r\nnv50_disp_core_new(const struct nv50_disp_dmac_func *func,\r\nconst struct nv50_disp_chan_mthd *mthd,\r\nstruct nv50_disp_root *root, int chid,\r\nconst struct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nunion {\r\nstruct nv50_disp_core_channel_dma_v0 v0;\r\n} *args = data;\r\nstruct nvkm_object *parent = oclass->parent;\r\nu64 push;\r\nint ret = -ENOSYS;\r\nnvif_ioctl(parent, "create disp core channel dma size %d\n", size);\r\nif (!(ret = nvif_unpack(ret, &data, &size, args->v0, 0, 0, false))) {\r\nnvif_ioctl(parent, "create disp core channel dma vers %d "\r\n"pushbuf %016llx\n",\r\nargs->v0.version, args->v0.pushbuf);\r\npush = args->v0.pushbuf;\r\n} else\r\nreturn ret;\r\nreturn nv50_disp_dmac_new_(func, mthd, root, chid, 0,\r\npush, oclass, pobject);\r\n}\r\nstatic void\r\nnv50_disp_core_fini(struct nv50_disp_dmac *chan)\r\n{\r\nstruct nv50_disp *disp = chan->base.root->disp;\r\nstruct nvkm_subdev *subdev = &disp->base.engine.subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nnvkm_mask(device, 0x610200, 0x00000010, 0x00000000);\r\nnvkm_mask(device, 0x610200, 0x00000003, 0x00000000);\r\nif (nvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x610200) & 0x001e0000))\r\nbreak;\r\n) < 0) {\r\nnvkm_error(subdev, "core fini: %08x\n",\r\nnvkm_rd32(device, 0x610200));\r\n}\r\nnvkm_mask(device, 0x610028, 0x00010001, 0x00000000);\r\n}\r\nstatic int\r\nnv50_disp_core_init(struct nv50_disp_dmac *chan)\r\n{\r\nstruct nv50_disp *disp = chan->base.root->disp;\r\nstruct nvkm_subdev *subdev = &disp->base.engine.subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nnvkm_mask(device, 0x610028, 0x00010000, 0x00010000);\r\nif ((nvkm_rd32(device, 0x610200) & 0x009f0000) == 0x00020000)\r\nnvkm_mask(device, 0x610200, 0x00800000, 0x00800000);\r\nif ((nvkm_rd32(device, 0x610200) & 0x003f0000) == 0x00030000)\r\nnvkm_mask(device, 0x610200, 0x00600000, 0x00600000);\r\nnvkm_wr32(device, 0x610204, chan->push);\r\nnvkm_wr32(device, 0x610208, 0x00010000);\r\nnvkm_wr32(device, 0x61020c, 0x00000000);\r\nnvkm_mask(device, 0x610200, 0x00000010, 0x00000010);\r\nnvkm_wr32(device, 0x640000, 0x00000000);\r\nnvkm_wr32(device, 0x610200, 0x01000013);\r\nif (nvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x610200) & 0x80000000))\r\nbreak;\r\n) < 0) {\r\nnvkm_error(subdev, "core init: %08x\n",\r\nnvkm_rd32(device, 0x610200));\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}

static int oxnas_reset_reset(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct oxnas_reset *data =\r\ncontainer_of(rcdev, struct oxnas_reset, rcdev);\r\nregmap_write(data->regmap, RST_SET_REGOFFSET, BIT(id));\r\nmsleep(50);\r\nregmap_write(data->regmap, RST_CLR_REGOFFSET, BIT(id));\r\nreturn 0;\r\n}\r\nstatic int oxnas_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct oxnas_reset *data =\r\ncontainer_of(rcdev, struct oxnas_reset, rcdev);\r\nregmap_write(data->regmap, RST_SET_REGOFFSET, BIT(id));\r\nreturn 0;\r\n}\r\nstatic int oxnas_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct oxnas_reset *data =\r\ncontainer_of(rcdev, struct oxnas_reset, rcdev);\r\nregmap_write(data->regmap, RST_CLR_REGOFFSET, BIT(id));\r\nreturn 0;\r\n}\r\nstatic int oxnas_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct oxnas_reset *data;\r\nstruct device *parent;\r\nparent = pdev->dev.parent;\r\nif (!parent) {\r\ndev_err(&pdev->dev, "no parent\n");\r\nreturn -ENODEV;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->regmap = syscon_node_to_regmap(parent->of_node);\r\nif (IS_ERR(data->regmap)) {\r\ndev_err(&pdev->dev, "failed to get parent regmap\n");\r\nreturn PTR_ERR(data->regmap);\r\n}\r\nplatform_set_drvdata(pdev, data);\r\ndata->rcdev.owner = THIS_MODULE;\r\ndata->rcdev.nr_resets = 32;\r\ndata->rcdev.ops = &oxnas_reset_ops;\r\ndata->rcdev.of_node = pdev->dev.of_node;\r\nreturn devm_reset_controller_register(&pdev->dev, &data->rcdev);\r\n}

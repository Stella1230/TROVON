static void reset_counters(void *arg)\r\n{\r\nwrite_c0_perfhi1(0);\r\nwrite_c0_perfhi2(0);\r\nwrite_c0_perflo1(0xc0000000);\r\nwrite_c0_perflo2(0x40000000);\r\n}\r\nstatic void loongson3_reg_setup(struct op_counter_config *ctr)\r\n{\r\nunsigned int control1 = 0;\r\nunsigned int control2 = 0;\r\nreg.reset_counter1 = 0;\r\nreg.reset_counter2 = 0;\r\nif (ctr[0].enabled) {\r\ncontrol1 |= LOONGSON3_PERFCTRL_EVENT(0, ctr[0].event) |\r\nLOONGSON3_PERFCTRL_ENABLE;\r\nif (ctr[0].kernel)\r\ncontrol1 |= LOONGSON3_PERFCTRL_KERNEL;\r\nif (ctr[0].user)\r\ncontrol1 |= LOONGSON3_PERFCTRL_USER;\r\nreg.reset_counter1 = 0x8000000000000000ULL - ctr[0].count;\r\n}\r\nif (ctr[1].enabled) {\r\ncontrol2 |= LOONGSON3_PERFCTRL_EVENT(1, ctr[1].event) |\r\nLOONGSON3_PERFCTRL_ENABLE;\r\nif (ctr[1].kernel)\r\ncontrol2 |= LOONGSON3_PERFCTRL_KERNEL;\r\nif (ctr[1].user)\r\ncontrol2 |= LOONGSON3_PERFCTRL_USER;\r\nreg.reset_counter2 = 0x8000000000000000ULL - ctr[1].count;\r\n}\r\nif (ctr[0].enabled)\r\ncontrol1 |= LOONGSON3_PERFCTRL_EXL;\r\nif (ctr[1].enabled)\r\ncontrol2 |= LOONGSON3_PERFCTRL_EXL;\r\nreg.control1 = control1;\r\nreg.control2 = control2;\r\nreg.ctr1_enable = ctr[0].enabled;\r\nreg.ctr2_enable = ctr[1].enabled;\r\n}\r\nstatic void loongson3_cpu_setup(void *args)\r\n{\r\nuint64_t perfcount1, perfcount2;\r\nperfcount1 = reg.reset_counter1;\r\nperfcount2 = reg.reset_counter2;\r\nwrite_c0_perfhi1(perfcount1);\r\nwrite_c0_perfhi2(perfcount2);\r\n}\r\nstatic void loongson3_cpu_start(void *args)\r\n{\r\nreg.control1 |= (LOONGSON3_PERFCTRL_W|LOONGSON3_PERFCTRL_M);\r\nreg.control2 |= (LOONGSON3_PERFCTRL_W|LOONGSON3_PERFCTRL_M);\r\nif (reg.ctr1_enable)\r\nwrite_c0_perflo1(reg.control1);\r\nif (reg.ctr2_enable)\r\nwrite_c0_perflo2(reg.control2);\r\n}\r\nstatic void loongson3_cpu_stop(void *args)\r\n{\r\nwrite_c0_perflo1(0xc0000000);\r\nwrite_c0_perflo2(0x40000000);\r\nmemset(&reg, 0, sizeof(reg));\r\n}\r\nstatic int loongson3_perfcount_handler(void)\r\n{\r\nunsigned long flags;\r\nuint64_t counter1, counter2;\r\nuint32_t cause, handled = IRQ_NONE;\r\nstruct pt_regs *regs = get_irq_regs();\r\ncause = read_c0_cause();\r\nif (!(cause & CAUSEF_PCI))\r\nreturn handled;\r\ncounter1 = read_c0_perfhi1();\r\ncounter2 = read_c0_perfhi2();\r\nlocal_irq_save(flags);\r\nif (counter1 & LOONGSON3_PERFCNT_OVERFLOW) {\r\nif (reg.ctr1_enable)\r\noprofile_add_sample(regs, 0);\r\ncounter1 = reg.reset_counter1;\r\n}\r\nif (counter2 & LOONGSON3_PERFCNT_OVERFLOW) {\r\nif (reg.ctr2_enable)\r\noprofile_add_sample(regs, 1);\r\ncounter2 = reg.reset_counter2;\r\n}\r\nlocal_irq_restore(flags);\r\nwrite_c0_perfhi1(counter1);\r\nwrite_c0_perfhi2(counter2);\r\nif (!(cause & CAUSEF_TI))\r\nhandled = IRQ_HANDLED;\r\nreturn handled;\r\n}\r\nstatic int loongson3_starting_cpu(unsigned int cpu)\r\n{\r\nwrite_c0_perflo1(reg.control1);\r\nwrite_c0_perflo2(reg.control2);\r\nreturn 0;\r\n}\r\nstatic int loongson3_dying_cpu(unsigned int cpu)\r\n{\r\nwrite_c0_perflo1(0xc0000000);\r\nwrite_c0_perflo2(0x40000000);\r\nreturn 0;\r\n}\r\nstatic int __init loongson3_init(void)\r\n{\r\non_each_cpu(reset_counters, NULL, 1);\r\ncpuhp_setup_state_nocalls(CPUHP_AP_MIPS_OP_LOONGSON3_STARTING,\r\n"mips/oprofile/loongson3:starting",\r\nloongson3_starting_cpu, loongson3_dying_cpu);\r\nsave_perf_irq = perf_irq;\r\nperf_irq = loongson3_perfcount_handler;\r\nreturn 0;\r\n}\r\nstatic void loongson3_exit(void)\r\n{\r\non_each_cpu(reset_counters, NULL, 1);\r\ncpuhp_remove_state_nocalls(CPUHP_AP_MIPS_OP_LOONGSON3_STARTING);\r\nperf_irq = save_perf_irq;\r\n}

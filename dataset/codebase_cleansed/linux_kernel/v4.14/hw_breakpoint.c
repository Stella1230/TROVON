static inline unsigned long\r\n__encode_dr7(int drnum, unsigned int len, unsigned int type)\r\n{\r\nunsigned long bp_info;\r\nbp_info = (len | type) & 0xf;\r\nbp_info <<= (DR_CONTROL_SHIFT + drnum * DR_CONTROL_SIZE);\r\nbp_info |= (DR_GLOBAL_ENABLE << (drnum * DR_ENABLE_SIZE));\r\nreturn bp_info;\r\n}\r\nunsigned long encode_dr7(int drnum, unsigned int len, unsigned int type)\r\n{\r\nreturn __encode_dr7(drnum, len, type) | DR_GLOBAL_SLOWDOWN;\r\n}\r\nint decode_dr7(unsigned long dr7, int bpnum, unsigned *len, unsigned *type)\r\n{\r\nint bp_info = dr7 >> (DR_CONTROL_SHIFT + bpnum * DR_CONTROL_SIZE);\r\n*len = (bp_info & 0xc) | 0x40;\r\n*type = (bp_info & 0x3) | 0x80;\r\nreturn (dr7 >> (bpnum * DR_ENABLE_SIZE)) & 0x3;\r\n}\r\nint arch_install_hw_breakpoint(struct perf_event *bp)\r\n{\r\nstruct arch_hw_breakpoint *info = counter_arch_bp(bp);\r\nunsigned long *dr7;\r\nint i;\r\nfor (i = 0; i < HBP_NUM; i++) {\r\nstruct perf_event **slot = this_cpu_ptr(&bp_per_reg[i]);\r\nif (!*slot) {\r\n*slot = bp;\r\nbreak;\r\n}\r\n}\r\nif (WARN_ONCE(i == HBP_NUM, "Can't find any breakpoint slot"))\r\nreturn -EBUSY;\r\nset_debugreg(info->address, i);\r\n__this_cpu_write(cpu_debugreg[i], info->address);\r\ndr7 = this_cpu_ptr(&cpu_dr7);\r\n*dr7 |= encode_dr7(i, info->len, info->type);\r\nset_debugreg(*dr7, 7);\r\nif (info->mask)\r\nset_dr_addr_mask(info->mask, i);\r\nreturn 0;\r\n}\r\nvoid arch_uninstall_hw_breakpoint(struct perf_event *bp)\r\n{\r\nstruct arch_hw_breakpoint *info = counter_arch_bp(bp);\r\nunsigned long *dr7;\r\nint i;\r\nfor (i = 0; i < HBP_NUM; i++) {\r\nstruct perf_event **slot = this_cpu_ptr(&bp_per_reg[i]);\r\nif (*slot == bp) {\r\n*slot = NULL;\r\nbreak;\r\n}\r\n}\r\nif (WARN_ONCE(i == HBP_NUM, "Can't find any breakpoint slot"))\r\nreturn;\r\ndr7 = this_cpu_ptr(&cpu_dr7);\r\n*dr7 &= ~__encode_dr7(i, info->len, info->type);\r\nset_debugreg(*dr7, 7);\r\nif (info->mask)\r\nset_dr_addr_mask(0, i);\r\n}\r\nint arch_check_bp_in_kernelspace(struct perf_event *bp)\r\n{\r\nunsigned int len;\r\nunsigned long va;\r\nstruct arch_hw_breakpoint *info = counter_arch_bp(bp);\r\nva = info->address;\r\nlen = bp->attr.bp_len;\r\nreturn (va >= TASK_SIZE_MAX) || ((va + len - 1) >= TASK_SIZE_MAX);\r\n}\r\nint arch_bp_generic_fields(int x86_len, int x86_type,\r\nint *gen_len, int *gen_type)\r\n{\r\nswitch (x86_type) {\r\ncase X86_BREAKPOINT_EXECUTE:\r\nif (x86_len != X86_BREAKPOINT_LEN_X)\r\nreturn -EINVAL;\r\n*gen_type = HW_BREAKPOINT_X;\r\n*gen_len = sizeof(long);\r\nreturn 0;\r\ncase X86_BREAKPOINT_WRITE:\r\n*gen_type = HW_BREAKPOINT_W;\r\nbreak;\r\ncase X86_BREAKPOINT_RW:\r\n*gen_type = HW_BREAKPOINT_W | HW_BREAKPOINT_R;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (x86_len) {\r\ncase X86_BREAKPOINT_LEN_1:\r\n*gen_len = HW_BREAKPOINT_LEN_1;\r\nbreak;\r\ncase X86_BREAKPOINT_LEN_2:\r\n*gen_len = HW_BREAKPOINT_LEN_2;\r\nbreak;\r\ncase X86_BREAKPOINT_LEN_4:\r\n*gen_len = HW_BREAKPOINT_LEN_4;\r\nbreak;\r\n#ifdef CONFIG_X86_64\r\ncase X86_BREAKPOINT_LEN_8:\r\n*gen_len = HW_BREAKPOINT_LEN_8;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int arch_build_bp_info(struct perf_event *bp)\r\n{\r\nstruct arch_hw_breakpoint *info = counter_arch_bp(bp);\r\ninfo->address = bp->attr.bp_addr;\r\nswitch (bp->attr.bp_type) {\r\ncase HW_BREAKPOINT_W:\r\ninfo->type = X86_BREAKPOINT_WRITE;\r\nbreak;\r\ncase HW_BREAKPOINT_W | HW_BREAKPOINT_R:\r\ninfo->type = X86_BREAKPOINT_RW;\r\nbreak;\r\ncase HW_BREAKPOINT_X:\r\nif (bp->attr.bp_addr >= TASK_SIZE_MAX) {\r\n#ifdef CONFIG_KPROBES\r\nif (within_kprobe_blacklist(bp->attr.bp_addr))\r\nreturn -EINVAL;\r\n#else\r\nreturn -EINVAL;\r\n#endif\r\n}\r\ninfo->type = X86_BREAKPOINT_EXECUTE;\r\nif (bp->attr.bp_len == sizeof(long)) {\r\ninfo->len = X86_BREAKPOINT_LEN_X;\r\nreturn 0;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ninfo->mask = 0;\r\nswitch (bp->attr.bp_len) {\r\ncase HW_BREAKPOINT_LEN_1:\r\ninfo->len = X86_BREAKPOINT_LEN_1;\r\nbreak;\r\ncase HW_BREAKPOINT_LEN_2:\r\ninfo->len = X86_BREAKPOINT_LEN_2;\r\nbreak;\r\ncase HW_BREAKPOINT_LEN_4:\r\ninfo->len = X86_BREAKPOINT_LEN_4;\r\nbreak;\r\n#ifdef CONFIG_X86_64\r\ncase HW_BREAKPOINT_LEN_8:\r\ninfo->len = X86_BREAKPOINT_LEN_8;\r\nbreak;\r\n#endif\r\ndefault:\r\nif (!is_power_of_2(bp->attr.bp_len))\r\nreturn -EINVAL;\r\nif (bp->attr.bp_addr & (bp->attr.bp_len - 1))\r\nreturn -EINVAL;\r\nif (!boot_cpu_has(X86_FEATURE_BPEXT))\r\nreturn -EOPNOTSUPP;\r\ninfo->mask = bp->attr.bp_len - 1;\r\ninfo->len = X86_BREAKPOINT_LEN_1;\r\n}\r\nreturn 0;\r\n}\r\nint arch_validate_hwbkpt_settings(struct perf_event *bp)\r\n{\r\nstruct arch_hw_breakpoint *info = counter_arch_bp(bp);\r\nunsigned int align;\r\nint ret;\r\nret = arch_build_bp_info(bp);\r\nif (ret)\r\nreturn ret;\r\nswitch (info->len) {\r\ncase X86_BREAKPOINT_LEN_1:\r\nalign = 0;\r\nif (info->mask)\r\nalign = info->mask;\r\nbreak;\r\ncase X86_BREAKPOINT_LEN_2:\r\nalign = 1;\r\nbreak;\r\ncase X86_BREAKPOINT_LEN_4:\r\nalign = 3;\r\nbreak;\r\n#ifdef CONFIG_X86_64\r\ncase X86_BREAKPOINT_LEN_8:\r\nalign = 7;\r\nbreak;\r\n#endif\r\ndefault:\r\nWARN_ON_ONCE(1);\r\n}\r\nif (info->address & align)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nvoid aout_dump_debugregs(struct user *dump)\r\n{\r\nint i;\r\nint dr7 = 0;\r\nstruct perf_event *bp;\r\nstruct arch_hw_breakpoint *info;\r\nstruct thread_struct *thread = &current->thread;\r\nfor (i = 0; i < HBP_NUM; i++) {\r\nbp = thread->ptrace_bps[i];\r\nif (bp && !bp->attr.disabled) {\r\ndump->u_debugreg[i] = bp->attr.bp_addr;\r\ninfo = counter_arch_bp(bp);\r\ndr7 |= encode_dr7(i, info->len, info->type);\r\n} else {\r\ndump->u_debugreg[i] = 0;\r\n}\r\n}\r\ndump->u_debugreg[4] = 0;\r\ndump->u_debugreg[5] = 0;\r\ndump->u_debugreg[6] = current->thread.debugreg6;\r\ndump->u_debugreg[7] = dr7;\r\n}\r\nvoid flush_ptrace_hw_breakpoint(struct task_struct *tsk)\r\n{\r\nint i;\r\nstruct thread_struct *t = &tsk->thread;\r\nfor (i = 0; i < HBP_NUM; i++) {\r\nunregister_hw_breakpoint(t->ptrace_bps[i]);\r\nt->ptrace_bps[i] = NULL;\r\n}\r\nt->debugreg6 = 0;\r\nt->ptrace_dr7 = 0;\r\n}\r\nvoid hw_breakpoint_restore(void)\r\n{\r\nset_debugreg(__this_cpu_read(cpu_debugreg[0]), 0);\r\nset_debugreg(__this_cpu_read(cpu_debugreg[1]), 1);\r\nset_debugreg(__this_cpu_read(cpu_debugreg[2]), 2);\r\nset_debugreg(__this_cpu_read(cpu_debugreg[3]), 3);\r\nset_debugreg(current->thread.debugreg6, 6);\r\nset_debugreg(__this_cpu_read(cpu_dr7), 7);\r\n}\r\nstatic int hw_breakpoint_handler(struct die_args *args)\r\n{\r\nint i, cpu, rc = NOTIFY_STOP;\r\nstruct perf_event *bp;\r\nunsigned long dr7, dr6;\r\nunsigned long *dr6_p;\r\ndr6_p = (unsigned long *)ERR_PTR(args->err);\r\ndr6 = *dr6_p;\r\nif (dr6 & DR_STEP)\r\nreturn NOTIFY_DONE;\r\nif ((dr6 & DR_TRAP_BITS) == 0)\r\nreturn NOTIFY_DONE;\r\nget_debugreg(dr7, 7);\r\nset_debugreg(0UL, 7);\r\ncurrent->thread.debugreg6 &= ~DR_TRAP_BITS;\r\ncpu = get_cpu();\r\nfor (i = 0; i < HBP_NUM; ++i) {\r\nif (likely(!(dr6 & (DR_TRAP0 << i))))\r\ncontinue;\r\nrcu_read_lock();\r\nbp = per_cpu(bp_per_reg[i], cpu);\r\n(*dr6_p) &= ~(DR_TRAP0 << i);\r\nif (!bp) {\r\nrcu_read_unlock();\r\nbreak;\r\n}\r\nperf_bp_event(bp, args->regs);\r\nif (bp->hw.info.type == X86_BREAKPOINT_EXECUTE)\r\nargs->regs->flags |= X86_EFLAGS_RF;\r\nrcu_read_unlock();\r\n}\r\nif ((current->thread.debugreg6 & DR_TRAP_BITS) ||\r\n(dr6 & (~DR_TRAP_BITS)))\r\nrc = NOTIFY_DONE;\r\nset_debugreg(dr7, 7);\r\nput_cpu();\r\nreturn rc;\r\n}\r\nint hw_breakpoint_exceptions_notify(\r\nstruct notifier_block *unused, unsigned long val, void *data)\r\n{\r\nif (val != DIE_DEBUG)\r\nreturn NOTIFY_DONE;\r\nreturn hw_breakpoint_handler(data);\r\n}\r\nvoid hw_breakpoint_pmu_read(struct perf_event *bp)\r\n{\r\n}

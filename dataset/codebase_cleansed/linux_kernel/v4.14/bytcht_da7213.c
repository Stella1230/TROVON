static int codec_fixup(struct snd_soc_pcm_runtime *rtd,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nint ret;\r\nstruct snd_interval *rate = hw_param_interval(params,\r\nSNDRV_PCM_HW_PARAM_RATE);\r\nstruct snd_interval *channels = hw_param_interval(params,\r\nSNDRV_PCM_HW_PARAM_CHANNELS);\r\nrate->min = rate->max = 48000;\r\nchannels->min = channels->max = 2;\r\nparams_set_format(params, SNDRV_PCM_FORMAT_S24_LE);\r\nret = snd_soc_dai_set_fmt(rtd->cpu_dai,\r\nSND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0) {\r\ndev_err(rtd->dev, "can't set format to I2S, err %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_tdm_slot(rtd->cpu_dai, 0x3, 0x3, 2, 24);\r\nif (ret < 0) {\r\ndev_err(rtd->dev, "can't set I2S config, err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int aif1_startup(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_pcm_hw_constraint_single(substream->runtime,\r\nSNDRV_PCM_HW_PARAM_RATE, 48000);\r\n}\r\nstatic int aif1_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, DA7213_CLKSRC_MCLK,\r\n19200000, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\ndev_err(codec_dai->dev, "can't set codec sysclk configuration\n");\r\nret = snd_soc_dai_set_pll(codec_dai, 0,\r\nDA7213_SYSCLK_PLL_SRM, 0, DA7213_PLL_FREQ_OUT_98304000);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "failed to start PLL: %d\n", ret);\r\nreturn -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int aif1_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_pll(codec_dai, 0,\r\nDA7213_SYSCLK_MCLK, 0, 0);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "failed to stop PLL: %d\n", ret);\r\nreturn -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bytcht_da7213_probe(struct platform_device *pdev)\r\n{\r\nint ret_val = 0;\r\nint i;\r\nstruct snd_soc_card *card;\r\nstruct sst_acpi_mach *mach;\r\nconst char *i2c_name = NULL;\r\nint dai_index = 0;\r\nmach = (&pdev->dev)->platform_data;\r\ncard = &bytcht_da7213_card;\r\ncard->dev = &pdev->dev;\r\ndai_index = MERR_DPCM_COMPR + 1;\r\nfor (i = 0; i < ARRAY_SIZE(dailink); i++) {\r\nif (!strcmp(dailink[i].codec_name, "i2c-DLGS7213:00")) {\r\ndai_index = i;\r\nbreak;\r\n}\r\n}\r\ni2c_name = sst_acpi_find_name_from_hid(mach->id);\r\nif (i2c_name != NULL) {\r\nsnprintf(codec_name, sizeof(codec_name),\r\n"%s%s", "i2c-", i2c_name);\r\ndailink[dai_index].codec_name = codec_name;\r\n}\r\nret_val = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret_val) {\r\ndev_err(&pdev->dev,\r\n"snd_soc_register_card failed %d\n", ret_val);\r\nreturn ret_val;\r\n}\r\nplatform_set_drvdata(pdev, card);\r\nreturn ret_val;\r\n}

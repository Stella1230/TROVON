static int get_alt_entry(struct elf *elf, struct special_entry *entry,\r\nstruct section *sec, int idx,\r\nstruct special_alt *alt)\r\n{\r\nstruct rela *orig_rela, *new_rela;\r\nunsigned long offset;\r\noffset = idx * entry->size;\r\nalt->group = entry->group;\r\nalt->jump_or_nop = entry->jump_or_nop;\r\nif (alt->group) {\r\nalt->orig_len = *(unsigned char *)(sec->data->d_buf + offset +\r\nentry->orig_len);\r\nalt->new_len = *(unsigned char *)(sec->data->d_buf + offset +\r\nentry->new_len);\r\n}\r\nif (entry->feature) {\r\nunsigned short feature;\r\nfeature = *(unsigned short *)(sec->data->d_buf + offset +\r\nentry->feature);\r\nif (feature == X86_FEATURE_POPCNT)\r\nalt->skip_orig = true;\r\n}\r\norig_rela = find_rela_by_dest(sec, offset + entry->orig);\r\nif (!orig_rela) {\r\nWARN_FUNC("can't find orig rela", sec, offset + entry->orig);\r\nreturn -1;\r\n}\r\nif (orig_rela->sym->type != STT_SECTION) {\r\nWARN_FUNC("don't know how to handle non-section rela symbol %s",\r\nsec, offset + entry->orig, orig_rela->sym->name);\r\nreturn -1;\r\n}\r\nalt->orig_sec = orig_rela->sym->sec;\r\nalt->orig_off = orig_rela->addend;\r\nif (!entry->group || alt->new_len) {\r\nnew_rela = find_rela_by_dest(sec, offset + entry->new);\r\nif (!new_rela) {\r\nWARN_FUNC("can't find new rela",\r\nsec, offset + entry->new);\r\nreturn -1;\r\n}\r\nalt->new_sec = new_rela->sym->sec;\r\nalt->new_off = (unsigned int)new_rela->addend;\r\nif (alt->new_off >= 0x7ffffff0)\r\nalt->new_off -= 0x7ffffff0;\r\n}\r\nreturn 0;\r\n}\r\nint special_get_alts(struct elf *elf, struct list_head *alts)\r\n{\r\nstruct special_entry *entry;\r\nstruct section *sec;\r\nunsigned int nr_entries;\r\nstruct special_alt *alt;\r\nint idx, ret;\r\nINIT_LIST_HEAD(alts);\r\nfor (entry = entries; entry->sec; entry++) {\r\nsec = find_section_by_name(elf, entry->sec);\r\nif (!sec)\r\ncontinue;\r\nif (sec->len % entry->size != 0) {\r\nWARN("%s size not a multiple of %d",\r\nsec->name, entry->size);\r\nreturn -1;\r\n}\r\nnr_entries = sec->len / entry->size;\r\nfor (idx = 0; idx < nr_entries; idx++) {\r\nalt = malloc(sizeof(*alt));\r\nif (!alt) {\r\nWARN("malloc failed");\r\nreturn -1;\r\n}\r\nmemset(alt, 0, sizeof(*alt));\r\nret = get_alt_entry(elf, entry, sec, idx, alt);\r\nif (ret)\r\nreturn ret;\r\nlist_add_tail(&alt->list, alts);\r\n}\r\n}\r\nreturn 0;\r\n}

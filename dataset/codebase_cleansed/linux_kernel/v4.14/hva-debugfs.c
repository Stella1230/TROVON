static void format_ctx(struct seq_file *s, struct hva_ctx *ctx)\r\n{\r\nstruct hva_streaminfo *stream = &ctx->streaminfo;\r\nstruct hva_frameinfo *frame = &ctx->frameinfo;\r\nstruct hva_controls *ctrls = &ctx->ctrls;\r\nstruct hva_ctx_dbg *dbg = &ctx->dbg;\r\nu32 bitrate_mode, aspect, entropy, vui_sar, sei_fp;\r\nseq_printf(s, "|-%s\n |\n", ctx->name);\r\nseq_printf(s, " |-[%sframe info]\n",\r\nctx->flags & HVA_FLAG_FRAMEINFO ? "" : "default ");\r\nseq_printf(s, " | |- pixel format=%4.4s\n"\r\n" | |- wxh=%dx%d\n"\r\n" | |- wxh (w/ encoder alignment constraint)=%dx%d\n"\r\n" |\n",\r\n(char *)&frame->pixelformat,\r\nframe->width, frame->height,\r\nframe->aligned_width, frame->aligned_height);\r\nseq_printf(s, " |-[%sstream info]\n",\r\nctx->flags & HVA_FLAG_STREAMINFO ? "" : "default ");\r\nseq_printf(s, " | |- stream format=%4.4s\n"\r\n" | |- wxh=%dx%d\n"\r\n" | |- %s\n"\r\n" | |- %s\n"\r\n" |\n",\r\n(char *)&stream->streamformat,\r\nstream->width, stream->height,\r\nstream->profile, stream->level);\r\nbitrate_mode = V4L2_CID_MPEG_VIDEO_BITRATE_MODE;\r\naspect = V4L2_CID_MPEG_VIDEO_ASPECT;\r\nseq_puts(s, " |-[parameters]\n");\r\nseq_printf(s, " | |- %s\n"\r\n" | |- bitrate=%d bps\n"\r\n" | |- GOP size=%d\n"\r\n" | |- video aspect=%s\n"\r\n" | |- framerate=%d/%d\n",\r\nv4l2_ctrl_get_menu(bitrate_mode)[ctrls->bitrate_mode],\r\nctrls->bitrate,\r\nctrls->gop_size,\r\nv4l2_ctrl_get_menu(aspect)[ctrls->aspect],\r\nctrls->time_per_frame.denominator,\r\nctrls->time_per_frame.numerator);\r\nentropy = V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE;\r\nvui_sar = V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC;\r\nsei_fp = V4L2_CID_MPEG_VIDEO_H264_SEI_FP_ARRANGEMENT_TYPE;\r\nif (stream->streamformat == V4L2_PIX_FMT_H264) {\r\nseq_printf(s, " | |- %s entropy mode\n"\r\n" | |- CPB size=%d kB\n"\r\n" | |- DCT8x8 enable=%s\n"\r\n" | |- qpmin=%d\n"\r\n" | |- qpmax=%d\n"\r\n" | |- PAR enable=%s\n"\r\n" | |- PAR id=%s\n"\r\n" | |- SEI frame packing enable=%s\n"\r\n" | |- SEI frame packing type=%s\n",\r\nv4l2_ctrl_get_menu(entropy)[ctrls->entropy_mode],\r\nctrls->cpb_size,\r\nctrls->dct8x8 ? "true" : "false",\r\nctrls->qpmin,\r\nctrls->qpmax,\r\nctrls->vui_sar ? "true" : "false",\r\nv4l2_ctrl_get_menu(vui_sar)[ctrls->vui_sar_idc],\r\nctrls->sei_fp ? "true" : "false",\r\nv4l2_ctrl_get_menu(sei_fp)[ctrls->sei_fp_type]);\r\n}\r\nif (ctx->sys_errors || ctx->encode_errors || ctx->frame_errors) {\r\nseq_puts(s, " |\n |-[errors]\n");\r\nseq_printf(s, " | |- system=%d\n"\r\n" | |- encoding=%d\n"\r\n" | |- frame=%d\n",\r\nctx->sys_errors,\r\nctx->encode_errors,\r\nctx->frame_errors);\r\n}\r\nseq_puts(s, " |\n |-[performances]\n");\r\nseq_printf(s, " | |- frames encoded=%d\n"\r\n" | |- avg HW processing duration (0.1ms)=%d [min=%d, max=%d]\n"\r\n" | |- avg encoding period (0.1ms)=%d [min=%d, max=%d]\n"\r\n" | |- avg fps (0.1Hz)=%d\n"\r\n" | |- max reachable fps (0.1Hz)=%d\n"\r\n" | |- avg bitrate (kbps)=%d [min=%d, max=%d]\n"\r\n" | |- last bitrate (kbps)=%d\n",\r\ndbg->cnt_duration,\r\ndbg->avg_duration,\r\ndbg->min_duration,\r\ndbg->max_duration,\r\ndbg->avg_period,\r\ndbg->min_period,\r\ndbg->max_period,\r\ndbg->avg_fps,\r\ndbg->max_fps,\r\ndbg->avg_bitrate,\r\ndbg->min_bitrate,\r\ndbg->max_bitrate,\r\ndbg->last_bitrate);\r\n}\r\nvoid hva_dbg_perf_begin(struct hva_ctx *ctx)\r\n{\r\nu64 div;\r\nu32 period;\r\nu32 bitrate;\r\nstruct hva_ctx_dbg *dbg = &ctx->dbg;\r\nktime_t prev = dbg->begin;\r\ndbg->begin = ktime_get();\r\nif (dbg->is_valid_period) {\r\ndiv = (u64)ktime_us_delta(dbg->begin, prev);\r\ndo_div(div, 100);\r\nperiod = (u32)div;\r\ndbg->min_period = min(period, dbg->min_period);\r\ndbg->max_period = max(period, dbg->max_period);\r\ndbg->total_period += period;\r\ndbg->cnt_period++;\r\ndbg->window_duration += period;\r\ndbg->cnt_window++;\r\nif (dbg->cnt_window >= 32) {\r\nif (dbg->window_duration > 0) {\r\ndiv = (u64)dbg->window_stream_size * 80;\r\ndo_div(div, dbg->window_duration);\r\nbitrate = (u32)div;\r\ndbg->last_bitrate = bitrate;\r\ndbg->min_bitrate = min(bitrate,\r\ndbg->min_bitrate);\r\ndbg->max_bitrate = max(bitrate,\r\ndbg->max_bitrate);\r\n}\r\ndbg->window_stream_size = 0;\r\ndbg->window_duration = 0;\r\ndbg->cnt_window = 0;\r\n}\r\n}\r\ndbg->is_valid_period = false;\r\n}\r\nvoid hva_dbg_perf_end(struct hva_ctx *ctx, struct hva_stream *stream)\r\n{\r\nstruct device *dev = ctx_to_dev(ctx);\r\nu64 div;\r\nu32 duration;\r\nu32 bytesused;\r\nu32 timestamp;\r\nstruct hva_ctx_dbg *dbg = &ctx->dbg;\r\nktime_t end = ktime_get();\r\nbytesused = vb2_get_plane_payload(&stream->vbuf.vb2_buf, 0);\r\ndiv = stream->vbuf.vb2_buf.timestamp;\r\ndo_div(div, 1000);\r\ntimestamp = (u32)div;\r\ndiv = (u64)ktime_us_delta(end, dbg->begin);\r\ndev_dbg(dev,\r\n"%s perf stream[%d] dts=%d encoded using %d bytes in %d us",\r\nctx->name,\r\nstream->vbuf.sequence,\r\ntimestamp,\r\nbytesused, (u32)div);\r\ndo_div(div, 100);\r\nduration = (u32)div;\r\ndbg->min_duration = min(duration, dbg->min_duration);\r\ndbg->max_duration = max(duration, dbg->max_duration);\r\ndbg->total_duration += duration;\r\ndbg->cnt_duration++;\r\ndbg->total_stream_size += bytesused;\r\ndbg->window_stream_size += bytesused;\r\ndbg->is_valid_period = true;\r\n}\r\nstatic void hva_dbg_perf_compute(struct hva_ctx *ctx)\r\n{\r\nu64 div;\r\nstruct hva_ctx_dbg *dbg = &ctx->dbg;\r\nif (dbg->cnt_duration > 0) {\r\ndiv = (u64)dbg->total_duration;\r\ndo_div(div, dbg->cnt_duration);\r\ndbg->avg_duration = (u32)div;\r\n} else {\r\ndbg->avg_duration = 0;\r\n}\r\nif (dbg->total_duration > 0) {\r\ndiv = (u64)dbg->cnt_duration * 100000;\r\ndo_div(div, dbg->total_duration);\r\ndbg->max_fps = (u32)div;\r\n} else {\r\ndbg->max_fps = 0;\r\n}\r\nif (dbg->cnt_period > 0) {\r\ndiv = (u64)dbg->total_period;\r\ndo_div(div, dbg->cnt_period);\r\ndbg->avg_period = (u32)div;\r\n} else {\r\ndbg->avg_period = 0;\r\n}\r\nif (dbg->total_period > 0) {\r\ndiv = (u64)dbg->cnt_period * 100000;\r\ndo_div(div, dbg->total_period);\r\ndbg->avg_fps = (u32)div;\r\n} else {\r\ndbg->avg_fps = 0;\r\n}\r\nif (dbg->total_period > 0) {\r\ndiv = (u64)dbg->total_stream_size * 80;\r\ndo_div(div, dbg->total_period);\r\ndbg->avg_bitrate = (u32)div;\r\n} else {\r\ndbg->avg_bitrate = 0;\r\n}\r\n}\r\nstatic int hva_dbg_device(struct seq_file *s, void *data)\r\n{\r\nstruct hva_dev *hva = s->private;\r\nseq_printf(s, "[%s]\n", hva->v4l2_dev.name);\r\nseq_printf(s, "registered as /dev/video%d\n", hva->vdev->num);\r\nreturn 0;\r\n}\r\nstatic int hva_dbg_encoders(struct seq_file *s, void *data)\r\n{\r\nstruct hva_dev *hva = s->private;\r\nunsigned int i = 0;\r\nseq_printf(s, "[encoders]\n|- %d registered encoders:\n",\r\nhva->nb_of_encoders);\r\nwhile (hva->encoders[i]) {\r\nseq_printf(s, "|- %s: %4.4s => %4.4s\n", hva->encoders[i]->name,\r\n(char *)&hva->encoders[i]->pixelformat,\r\n(char *)&hva->encoders[i]->streamformat);\r\ni++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hva_dbg_last(struct seq_file *s, void *data)\r\n{\r\nstruct hva_dev *hva = s->private;\r\nstruct hva_ctx *last_ctx = &hva->dbg.last_ctx;\r\nif (last_ctx->flags & HVA_FLAG_STREAMINFO) {\r\nseq_puts(s, "[last encoding]\n");\r\nhva_dbg_perf_compute(last_ctx);\r\nformat_ctx(s, last_ctx);\r\n} else {\r\nseq_puts(s, "[no information recorded about last encoding]\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int hva_dbg_regs(struct seq_file *s, void *data)\r\n{\r\nstruct hva_dev *hva = s->private;\r\nhva_hw_dump_regs(hva, s);\r\nreturn 0;\r\n}\r\nvoid hva_debugfs_create(struct hva_dev *hva)\r\n{\r\nhva->dbg.debugfs_entry = debugfs_create_dir(HVA_NAME, NULL);\r\nif (!hva->dbg.debugfs_entry)\r\ngoto err;\r\nif (!hva_dbg_create_entry(device))\r\ngoto err;\r\nif (!hva_dbg_create_entry(encoders))\r\ngoto err;\r\nif (!hva_dbg_create_entry(last))\r\ngoto err;\r\nif (!hva_dbg_create_entry(regs))\r\ngoto err;\r\nreturn;\r\nerr:\r\nhva_debugfs_remove(hva);\r\n}\r\nvoid hva_debugfs_remove(struct hva_dev *hva)\r\n{\r\ndebugfs_remove_recursive(hva->dbg.debugfs_entry);\r\nhva->dbg.debugfs_entry = NULL;\r\n}\r\nstatic int hva_dbg_ctx(struct seq_file *s, void *data)\r\n{\r\nstruct hva_ctx *ctx = s->private;\r\nseq_printf(s, "[running encoding %d]\n", ctx->id);\r\nhva_dbg_perf_compute(ctx);\r\nformat_ctx(s, ctx);\r\nreturn 0;\r\n}\r\nvoid hva_dbg_ctx_create(struct hva_ctx *ctx)\r\n{\r\nstruct hva_dev *hva = ctx->hva_dev;\r\nchar name[4] = "";\r\nctx->dbg.min_duration = UINT_MAX;\r\nctx->dbg.min_period = UINT_MAX;\r\nctx->dbg.min_bitrate = UINT_MAX;\r\nsnprintf(name, sizeof(name), "%d", hva->instance_id);\r\nctx->dbg.debugfs_entry = debugfs_create_file(name, 0444,\r\nhva->dbg.debugfs_entry,\r\nctx, &hva_dbg_ctx_fops);\r\n}\r\nvoid hva_dbg_ctx_remove(struct hva_ctx *ctx)\r\n{\r\nstruct hva_dev *hva = ctx->hva_dev;\r\nif (ctx->flags & HVA_FLAG_STREAMINFO)\r\nmemcpy(&hva->dbg.last_ctx, ctx, sizeof(*ctx));\r\ndebugfs_remove(ctx->dbg.debugfs_entry);\r\n}

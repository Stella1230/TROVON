static struct gb_audio_manager_module *gb_audio_manager_get_locked(int id)\r\n{\r\nstruct gb_audio_manager_module *module;\r\nif (id < 0)\r\nreturn NULL;\r\nlist_for_each_entry(module, &modules_list, list) {\r\nif (module->id == id)\r\nreturn module;\r\n}\r\nreturn NULL;\r\n}\r\nint gb_audio_manager_add(struct gb_audio_manager_module_descriptor *desc)\r\n{\r\nstruct gb_audio_manager_module *module;\r\nint id;\r\nint err;\r\nid = ida_simple_get(&module_id, 0, 0, GFP_KERNEL);\r\nerr = gb_audio_manager_module_create(&module, manager_kset,\r\nid, desc);\r\nif (err) {\r\nida_simple_remove(&module_id, id);\r\nreturn err;\r\n}\r\ndown_write(&modules_rwsem);\r\nlist_add_tail(&module->list, &modules_list);\r\nup_write(&modules_rwsem);\r\nreturn module->id;\r\n}\r\nint gb_audio_manager_remove(int id)\r\n{\r\nstruct gb_audio_manager_module *module;\r\ndown_write(&modules_rwsem);\r\nmodule = gb_audio_manager_get_locked(id);\r\nif (!module) {\r\nup_write(&modules_rwsem);\r\nreturn -EINVAL;\r\n}\r\nlist_del(&module->list);\r\nkobject_put(&module->kobj);\r\nup_write(&modules_rwsem);\r\nida_simple_remove(&module_id, id);\r\nreturn 0;\r\n}\r\nvoid gb_audio_manager_remove_all(void)\r\n{\r\nstruct gb_audio_manager_module *module, *next;\r\nint is_empty = 1;\r\ndown_write(&modules_rwsem);\r\nlist_for_each_entry_safe(module, next, &modules_list, list) {\r\nlist_del(&module->list);\r\nkobject_put(&module->kobj);\r\nida_simple_remove(&module_id, module->id);\r\n}\r\nis_empty = list_empty(&modules_list);\r\nup_write(&modules_rwsem);\r\nif (!is_empty)\r\npr_warn("Not all nodes were deleted\n");\r\n}\r\nstruct gb_audio_manager_module *gb_audio_manager_get_module(int id)\r\n{\r\nstruct gb_audio_manager_module *module;\r\ndown_read(&modules_rwsem);\r\nmodule = gb_audio_manager_get_locked(id);\r\nkobject_get(&module->kobj);\r\nup_read(&modules_rwsem);\r\nreturn module;\r\n}\r\nvoid gb_audio_manager_put_module(struct gb_audio_manager_module *module)\r\n{\r\nkobject_put(&module->kobj);\r\n}\r\nint gb_audio_manager_dump_module(int id)\r\n{\r\nstruct gb_audio_manager_module *module;\r\ndown_read(&modules_rwsem);\r\nmodule = gb_audio_manager_get_locked(id);\r\nup_read(&modules_rwsem);\r\nif (!module)\r\nreturn -EINVAL;\r\ngb_audio_manager_module_dump(module);\r\nreturn 0;\r\n}\r\nvoid gb_audio_manager_dump_all(void)\r\n{\r\nstruct gb_audio_manager_module *module;\r\nint count = 0;\r\ndown_read(&modules_rwsem);\r\nlist_for_each_entry(module, &modules_list, list) {\r\ngb_audio_manager_module_dump(module);\r\ncount++;\r\n}\r\nup_read(&modules_rwsem);\r\npr_info("Number of connected modules: %d\n", count);\r\n}\r\nstatic int __init manager_init(void)\r\n{\r\nmanager_kset = kset_create_and_add(GB_AUDIO_MANAGER_NAME, NULL,\r\nkernel_kobj);\r\nif (!manager_kset)\r\nreturn -ENOMEM;\r\n#ifdef GB_AUDIO_MANAGER_SYSFS\r\ngb_audio_manager_sysfs_init(&manager_kset->kobj);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit manager_exit(void)\r\n{\r\ngb_audio_manager_remove_all();\r\nkset_unregister(manager_kset);\r\nida_destroy(&module_id);\r\n}

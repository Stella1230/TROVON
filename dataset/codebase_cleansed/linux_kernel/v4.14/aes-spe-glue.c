static void spe_begin(void)\r\n{\r\npreempt_disable();\r\nenable_kernel_spe();\r\n}\r\nstatic void spe_end(void)\r\n{\r\ndisable_kernel_spe();\r\npreempt_enable();\r\n}\r\nstatic int ppc_aes_setkey(struct crypto_tfm *tfm, const u8 *in_key,\r\nunsigned int key_len)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (key_len != AES_KEYSIZE_128 &&\r\nkey_len != AES_KEYSIZE_192 &&\r\nkey_len != AES_KEYSIZE_256) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_BAD_KEY_LEN;\r\nreturn -EINVAL;\r\n}\r\nswitch (key_len) {\r\ncase AES_KEYSIZE_128:\r\nctx->rounds = 4;\r\nppc_expand_key_128(ctx->key_enc, in_key);\r\nbreak;\r\ncase AES_KEYSIZE_192:\r\nctx->rounds = 5;\r\nppc_expand_key_192(ctx->key_enc, in_key);\r\nbreak;\r\ncase AES_KEYSIZE_256:\r\nctx->rounds = 6;\r\nppc_expand_key_256(ctx->key_enc, in_key);\r\nbreak;\r\n}\r\nppc_generate_decrypt_key(ctx->key_dec, ctx->key_enc, key_len);\r\nreturn 0;\r\n}\r\nstatic int ppc_xts_setkey(struct crypto_tfm *tfm, const u8 *in_key,\r\nunsigned int key_len)\r\n{\r\nstruct ppc_xts_ctx *ctx = crypto_tfm_ctx(tfm);\r\nint err;\r\nerr = xts_check_key(tfm, in_key, key_len);\r\nif (err)\r\nreturn err;\r\nkey_len >>= 1;\r\nif (key_len != AES_KEYSIZE_128 &&\r\nkey_len != AES_KEYSIZE_192 &&\r\nkey_len != AES_KEYSIZE_256) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_BAD_KEY_LEN;\r\nreturn -EINVAL;\r\n}\r\nswitch (key_len) {\r\ncase AES_KEYSIZE_128:\r\nctx->rounds = 4;\r\nppc_expand_key_128(ctx->key_enc, in_key);\r\nppc_expand_key_128(ctx->key_twk, in_key + AES_KEYSIZE_128);\r\nbreak;\r\ncase AES_KEYSIZE_192:\r\nctx->rounds = 5;\r\nppc_expand_key_192(ctx->key_enc, in_key);\r\nppc_expand_key_192(ctx->key_twk, in_key + AES_KEYSIZE_192);\r\nbreak;\r\ncase AES_KEYSIZE_256:\r\nctx->rounds = 6;\r\nppc_expand_key_256(ctx->key_enc, in_key);\r\nppc_expand_key_256(ctx->key_twk, in_key + AES_KEYSIZE_256);\r\nbreak;\r\n}\r\nppc_generate_decrypt_key(ctx->key_dec, ctx->key_enc, key_len);\r\nreturn 0;\r\n}\r\nstatic void ppc_aes_encrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nspe_begin();\r\nppc_encrypt_aes(out, in, ctx->key_enc, ctx->rounds);\r\nspe_end();\r\n}\r\nstatic void ppc_aes_decrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nspe_begin();\r\nppc_decrypt_aes(out, in, ctx->key_dec, ctx->rounds);\r\nspe_end();\r\n}\r\nstatic int ppc_ecb_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_encrypt_ecb(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_enc, ctx->rounds, nbytes);\r\nspe_end();\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_ecb_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_decrypt_ecb(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_dec, ctx->rounds, nbytes);\r\nspe_end();\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_cbc_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_encrypt_cbc(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_enc, ctx->rounds, nbytes, walk.iv);\r\nspe_end();\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_cbc_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_decrypt_cbc(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_dec, ctx->rounds, nbytes, walk.iv);\r\nspe_end();\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_ctr_crypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_aes_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int pbytes, ubytes;\r\nint err;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt_block(desc, &walk, AES_BLOCK_SIZE);\r\nwhile ((pbytes = walk.nbytes)) {\r\npbytes = pbytes > MAX_BYTES ? MAX_BYTES : pbytes;\r\npbytes = pbytes == nbytes ?\r\nnbytes : pbytes & ~(AES_BLOCK_SIZE - 1);\r\nubytes = walk.nbytes - pbytes;\r\nspe_begin();\r\nppc_crypt_ctr(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_enc, ctx->rounds, pbytes , walk.iv);\r\nspe_end();\r\nnbytes -= pbytes;\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_xts_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_xts_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\nu32 *twk;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\ntwk = ctx->key_twk;\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_encrypt_xts(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_enc, ctx->rounds, nbytes, walk.iv, twk);\r\nspe_end();\r\ntwk = NULL;\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ppc_xts_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct ppc_xts_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nunsigned int ubytes;\r\nint err;\r\nu32 *twk;\r\ndesc->flags &= ~CRYPTO_TFM_REQ_MAY_SLEEP;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\ntwk = ctx->key_twk;\r\nwhile ((nbytes = walk.nbytes)) {\r\nubytes = nbytes > MAX_BYTES ?\r\nnbytes - MAX_BYTES : nbytes & (AES_BLOCK_SIZE - 1);\r\nnbytes -= ubytes;\r\nspe_begin();\r\nppc_decrypt_xts(walk.dst.virt.addr, walk.src.virt.addr,\r\nctx->key_dec, ctx->rounds, nbytes, walk.iv, twk);\r\nspe_end();\r\ntwk = NULL;\r\nerr = blkcipher_walk_done(desc, &walk, ubytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int __init ppc_aes_mod_init(void)\r\n{\r\nreturn crypto_register_algs(aes_algs, ARRAY_SIZE(aes_algs));\r\n}\r\nstatic void __exit ppc_aes_mod_fini(void)\r\n{\r\ncrypto_unregister_algs(aes_algs, ARRAY_SIZE(aes_algs));\r\n}

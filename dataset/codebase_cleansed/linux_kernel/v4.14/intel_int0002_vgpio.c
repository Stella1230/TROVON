static int int0002_gpio_get(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nreturn 0;\r\n}\r\nstatic void int0002_gpio_set(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\n}\r\nstatic int int0002_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned int offset, int value)\r\n{\r\nreturn 0;\r\n}\r\nstatic void int0002_irq_ack(struct irq_data *data)\r\n{\r\noutl(GPE0A_PME_B0_STS_BIT, GPE0A_STS_PORT);\r\n}\r\nstatic void int0002_irq_unmask(struct irq_data *data)\r\n{\r\nu32 gpe_en_reg;\r\ngpe_en_reg = inl(GPE0A_EN_PORT);\r\ngpe_en_reg |= GPE0A_PME_B0_EN_BIT;\r\noutl(gpe_en_reg, GPE0A_EN_PORT);\r\n}\r\nstatic void int0002_irq_mask(struct irq_data *data)\r\n{\r\nu32 gpe_en_reg;\r\ngpe_en_reg = inl(GPE0A_EN_PORT);\r\ngpe_en_reg &= ~GPE0A_PME_B0_EN_BIT;\r\noutl(gpe_en_reg, GPE0A_EN_PORT);\r\n}\r\nstatic irqreturn_t int0002_irq(int irq, void *data)\r\n{\r\nstruct gpio_chip *chip = data;\r\nu32 gpe_sts_reg;\r\ngpe_sts_reg = inl(GPE0A_STS_PORT);\r\nif (!(gpe_sts_reg & GPE0A_PME_B0_STS_BIT))\r\nreturn IRQ_NONE;\r\ngeneric_handle_irq(irq_find_mapping(chip->irqdomain,\r\nGPE0A_PME_B0_VIRT_GPIO_PIN));\r\npm_system_wakeup();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int int0002_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nconst struct x86_cpu_id *cpu_id;\r\nstruct gpio_chip *chip;\r\nint irq, ret;\r\ncpu_id = x86_match_cpu(int0002_cpu_ids);\r\nif (!cpu_id)\r\nreturn -ENODEV;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "Error getting IRQ: %d\n", irq);\r\nreturn irq;\r\n}\r\nchip = devm_kzalloc(dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nchip->label = DRV_NAME;\r\nchip->parent = dev;\r\nchip->owner = THIS_MODULE;\r\nchip->get = int0002_gpio_get;\r\nchip->set = int0002_gpio_set;\r\nchip->direction_input = int0002_gpio_get;\r\nchip->direction_output = int0002_gpio_direction_output;\r\nchip->base = -1;\r\nchip->ngpio = GPE0A_PME_B0_VIRT_GPIO_PIN + 1;\r\nchip->irq_need_valid_mask = true;\r\nret = devm_gpiochip_add_data(&pdev->dev, chip, NULL);\r\nif (ret) {\r\ndev_err(dev, "Error adding gpio chip: %d\n", ret);\r\nreturn ret;\r\n}\r\nbitmap_clear(chip->irq_valid_mask, 0, GPE0A_PME_B0_VIRT_GPIO_PIN);\r\nret = devm_request_irq(dev, irq, int0002_irq,\r\nIRQF_SHARED | IRQF_NO_THREAD, "INT0002", chip);\r\nif (ret) {\r\ndev_err(dev, "Error requesting IRQ %d: %d\n", irq, ret);\r\nreturn ret;\r\n}\r\nret = gpiochip_irqchip_add(chip, &int0002_irqchip, 0, handle_edge_irq,\r\nIRQ_TYPE_NONE);\r\nif (ret) {\r\ndev_err(dev, "Error adding irqchip: %d\n", ret);\r\nreturn ret;\r\n}\r\ngpiochip_set_chained_irqchip(chip, &int0002_irqchip, irq, NULL);\r\nreturn 0;\r\n}

static int vcn_v1_0_early_init(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nadev->vcn.num_enc_rings = 2;\r\nvcn_v1_0_set_dec_ring_funcs(adev);\r\nvcn_v1_0_set_enc_ring_funcs(adev);\r\nvcn_v1_0_set_irq_funcs(adev);\r\nreturn 0;\r\n}\r\nstatic int vcn_v1_0_sw_init(void *handle)\r\n{\r\nstruct amdgpu_ring *ring;\r\nint i, r;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nr = amdgpu_irq_add_id(adev, AMDGPU_IH_CLIENTID_VCN, 124, &adev->vcn.irq);\r\nif (r)\r\nreturn r;\r\nfor (i = 0; i < adev->vcn.num_enc_rings; ++i) {\r\nr = amdgpu_irq_add_id(adev, AMDGPU_IH_CLIENTID_VCN, i + 119,\r\n&adev->vcn.irq);\r\nif (r)\r\nreturn r;\r\n}\r\nr = amdgpu_vcn_sw_init(adev);\r\nif (r)\r\nreturn r;\r\nr = amdgpu_vcn_resume(adev);\r\nif (r)\r\nreturn r;\r\nring = &adev->vcn.ring_dec;\r\nsprintf(ring->name, "vcn_dec");\r\nr = amdgpu_ring_init(adev, ring, 512, &adev->vcn.irq, 0);\r\nif (r)\r\nreturn r;\r\nfor (i = 0; i < adev->vcn.num_enc_rings; ++i) {\r\nring = &adev->vcn.ring_enc[i];\r\nsprintf(ring->name, "vcn_enc%d", i);\r\nr = amdgpu_ring_init(adev, ring, 512, &adev->vcn.irq, 0);\r\nif (r)\r\nreturn r;\r\n}\r\nreturn r;\r\n}\r\nstatic int vcn_v1_0_sw_fini(void *handle)\r\n{\r\nint r;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nr = amdgpu_vcn_suspend(adev);\r\nif (r)\r\nreturn r;\r\nr = amdgpu_vcn_sw_fini(adev);\r\nreturn r;\r\n}\r\nstatic int vcn_v1_0_hw_init(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nstruct amdgpu_ring *ring = &adev->vcn.ring_dec;\r\nint i, r;\r\nr = vcn_v1_0_start(adev);\r\nif (r)\r\ngoto done;\r\nring->ready = true;\r\nr = amdgpu_ring_test_ring(ring);\r\nif (r) {\r\nring->ready = false;\r\ngoto done;\r\n}\r\nfor (i = 0; i < adev->vcn.num_enc_rings; ++i) {\r\nring = &adev->vcn.ring_enc[i];\r\nring->ready = true;\r\nr = amdgpu_ring_test_ring(ring);\r\nif (r) {\r\nring->ready = false;\r\ngoto done;\r\n}\r\n}\r\ndone:\r\nif (!r)\r\nDRM_INFO("VCN decode and encode initialized successfully.\n");\r\nreturn r;\r\n}\r\nstatic int vcn_v1_0_hw_fini(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nstruct amdgpu_ring *ring = &adev->vcn.ring_dec;\r\nint r;\r\nr = vcn_v1_0_stop(adev);\r\nif (r)\r\nreturn r;\r\nring->ready = false;\r\nreturn 0;\r\n}\r\nstatic int vcn_v1_0_suspend(void *handle)\r\n{\r\nint r;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nr = vcn_v1_0_hw_fini(adev);\r\nif (r)\r\nreturn r;\r\nr = amdgpu_vcn_suspend(adev);\r\nreturn r;\r\n}\r\nstatic int vcn_v1_0_resume(void *handle)\r\n{\r\nint r;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nr = amdgpu_vcn_resume(adev);\r\nif (r)\r\nreturn r;\r\nr = vcn_v1_0_hw_init(adev);\r\nreturn r;\r\n}\r\nstatic void vcn_v1_0_mc_resume(struct amdgpu_device *adev)\r\n{\r\nuint32_t size = AMDGPU_GPU_PAGE_ALIGN(adev->vcn.fw->size + 4);\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE_64BIT_BAR_LOW,\r\nlower_32_bits(adev->vcn.gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE_64BIT_BAR_HIGH,\r\nupper_32_bits(adev->vcn.gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_OFFSET0,\r\nAMDGPU_UVD_FIRMWARE_OFFSET >> 3);\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_SIZE0, size);\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE1_64BIT_BAR_LOW,\r\nlower_32_bits(adev->vcn.gpu_addr + size));\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE1_64BIT_BAR_HIGH,\r\nupper_32_bits(adev->vcn.gpu_addr + size));\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_OFFSET1, 0);\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_SIZE1, AMDGPU_VCN_HEAP_SIZE);\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE2_64BIT_BAR_LOW,\r\nlower_32_bits(adev->vcn.gpu_addr + size + AMDGPU_VCN_HEAP_SIZE));\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_VCPU_CACHE2_64BIT_BAR_HIGH,\r\nupper_32_bits(adev->vcn.gpu_addr + size + AMDGPU_VCN_HEAP_SIZE));\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_OFFSET2, 0);\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CACHE_SIZE2,\r\nAMDGPU_VCN_STACK_SIZE + (AMDGPU_VCN_SESSION_SIZE * 40));\r\nWREG32_SOC15(UVD, 0, mmUVD_UDEC_ADDR_CONFIG,\r\nadev->gfx.config.gb_addr_config);\r\nWREG32_SOC15(UVD, 0, mmUVD_UDEC_DB_ADDR_CONFIG,\r\nadev->gfx.config.gb_addr_config);\r\nWREG32_SOC15(UVD, 0, mmUVD_UDEC_DBW_ADDR_CONFIG,\r\nadev->gfx.config.gb_addr_config);\r\n}\r\nstatic void vcn_v1_0_disable_clock_gating(struct amdgpu_device *adev, bool sw)\r\n{\r\nuint32_t data;\r\ndata = RREG32_SOC15(VCN, 0, mmJPEG_CGC_CTRL);\r\nif (sw)\r\ndata |= 1 << JPEG_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\nelse\r\ndata &= ~JPEG_CGC_CTRL__DYN_CLOCK_MODE_MASK;\r\ndata |= 1 << JPEG_CGC_CTRL__CLK_GATE_DLY_TIMER__SHIFT;\r\ndata |= 4 << JPEG_CGC_CTRL__CLK_OFF_DELAY__SHIFT;\r\nWREG32_SOC15(VCN, 0, mmJPEG_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmJPEG_CGC_GATE);\r\ndata &= ~(JPEG_CGC_GATE__JPEG_MASK | JPEG_CGC_GATE__JPEG2_MASK);\r\nWREG32_SOC15(VCN, 0, mmJPEG_CGC_GATE, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL);\r\nif (sw)\r\ndata |= 1 << UVD_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\nelse\r\ndata &= ~ UVD_CGC_CTRL__DYN_CLOCK_MODE_MASK;\r\ndata |= 1 << UVD_CGC_CTRL__CLK_GATE_DLY_TIMER__SHIFT;\r\ndata |= 4 << UVD_CGC_CTRL__CLK_OFF_DELAY__SHIFT;\r\nWREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_CGC_GATE);\r\ndata &= ~(UVD_CGC_GATE__SYS_MASK\r\n| UVD_CGC_GATE__UDEC_MASK\r\n| UVD_CGC_GATE__MPEG2_MASK\r\n| UVD_CGC_GATE__REGS_MASK\r\n| UVD_CGC_GATE__RBC_MASK\r\n| UVD_CGC_GATE__LMI_MC_MASK\r\n| UVD_CGC_GATE__LMI_UMC_MASK\r\n| UVD_CGC_GATE__IDCT_MASK\r\n| UVD_CGC_GATE__MPRD_MASK\r\n| UVD_CGC_GATE__MPC_MASK\r\n| UVD_CGC_GATE__LBSI_MASK\r\n| UVD_CGC_GATE__LRBBM_MASK\r\n| UVD_CGC_GATE__UDEC_RE_MASK\r\n| UVD_CGC_GATE__UDEC_CM_MASK\r\n| UVD_CGC_GATE__UDEC_IT_MASK\r\n| UVD_CGC_GATE__UDEC_DB_MASK\r\n| UVD_CGC_GATE__UDEC_MP_MASK\r\n| UVD_CGC_GATE__WCB_MASK\r\n| UVD_CGC_GATE__VCPU_MASK\r\n| UVD_CGC_GATE__SCPU_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_CGC_GATE, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL);\r\ndata &= ~(UVD_CGC_CTRL__UDEC_RE_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_CM_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_IT_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_DB_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_MP_MODE_MASK\r\n| UVD_CGC_CTRL__SYS_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_MODE_MASK\r\n| UVD_CGC_CTRL__MPEG2_MODE_MASK\r\n| UVD_CGC_CTRL__REGS_MODE_MASK\r\n| UVD_CGC_CTRL__RBC_MODE_MASK\r\n| UVD_CGC_CTRL__LMI_MC_MODE_MASK\r\n| UVD_CGC_CTRL__LMI_UMC_MODE_MASK\r\n| UVD_CGC_CTRL__IDCT_MODE_MASK\r\n| UVD_CGC_CTRL__MPRD_MODE_MASK\r\n| UVD_CGC_CTRL__MPC_MODE_MASK\r\n| UVD_CGC_CTRL__LBSI_MODE_MASK\r\n| UVD_CGC_CTRL__LRBBM_MODE_MASK\r\n| UVD_CGC_CTRL__WCB_MODE_MASK\r\n| UVD_CGC_CTRL__VCPU_MODE_MASK\r\n| UVD_CGC_CTRL__SCPU_MODE_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_GATE);\r\ndata |= (UVD_SUVD_CGC_GATE__SRE_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_MASK\r\n| UVD_SUVD_CGC_GATE__SMP_MASK\r\n| UVD_SUVD_CGC_GATE__SCM_MASK\r\n| UVD_SUVD_CGC_GATE__SDB_MASK\r\n| UVD_SUVD_CGC_GATE__SRE_H264_MASK\r\n| UVD_SUVD_CGC_GATE__SRE_HEVC_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_H264_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_HEVC_MASK\r\n| UVD_SUVD_CGC_GATE__SCM_H264_MASK\r\n| UVD_SUVD_CGC_GATE__SCM_HEVC_MASK\r\n| UVD_SUVD_CGC_GATE__SDB_H264_MASK\r\n| UVD_SUVD_CGC_GATE__SDB_HEVC_MASK\r\n| UVD_SUVD_CGC_GATE__SCLR_MASK\r\n| UVD_SUVD_CGC_GATE__UVD_SC_MASK\r\n| UVD_SUVD_CGC_GATE__ENT_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_HEVC_DEC_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_HEVC_ENC_MASK\r\n| UVD_SUVD_CGC_GATE__SITE_MASK\r\n| UVD_SUVD_CGC_GATE__SRE_VP9_MASK\r\n| UVD_SUVD_CGC_GATE__SCM_VP9_MASK\r\n| UVD_SUVD_CGC_GATE__SIT_VP9_DEC_MASK\r\n| UVD_SUVD_CGC_GATE__SDB_VP9_MASK\r\n| UVD_SUVD_CGC_GATE__IME_HEVC_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_GATE, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_CTRL);\r\ndata &= ~(UVD_SUVD_CGC_CTRL__SRE_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SIT_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SMP_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SCM_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SDB_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SCLR_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__UVD_SC_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__ENT_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__IME_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SITE_MODE_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_CTRL, data);\r\n}\r\nstatic void vcn_v1_0_enable_clock_gating(struct amdgpu_device *adev, bool sw)\r\n{\r\nuint32_t data = 0;\r\ndata = RREG32_SOC15(VCN, 0, mmJPEG_CGC_CTRL);\r\nif (sw)\r\ndata |= 1 << JPEG_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\nelse\r\ndata |= 0 << JPEG_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\ndata |= 1 << JPEG_CGC_CTRL__CLK_GATE_DLY_TIMER__SHIFT;\r\ndata |= 4 << JPEG_CGC_CTRL__CLK_OFF_DELAY__SHIFT;\r\nWREG32_SOC15(VCN, 0, mmJPEG_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmJPEG_CGC_GATE);\r\ndata |= (JPEG_CGC_GATE__JPEG_MASK | JPEG_CGC_GATE__JPEG2_MASK);\r\nWREG32_SOC15(VCN, 0, mmJPEG_CGC_GATE, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL);\r\nif (sw)\r\ndata |= 1 << UVD_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\nelse\r\ndata |= 0 << UVD_CGC_CTRL__DYN_CLOCK_MODE__SHIFT;\r\ndata |= 1 << UVD_CGC_CTRL__CLK_GATE_DLY_TIMER__SHIFT;\r\ndata |= 4 << UVD_CGC_CTRL__CLK_OFF_DELAY__SHIFT;\r\nWREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL);\r\ndata |= (UVD_CGC_CTRL__UDEC_RE_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_CM_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_IT_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_DB_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_MP_MODE_MASK\r\n| UVD_CGC_CTRL__SYS_MODE_MASK\r\n| UVD_CGC_CTRL__UDEC_MODE_MASK\r\n| UVD_CGC_CTRL__MPEG2_MODE_MASK\r\n| UVD_CGC_CTRL__REGS_MODE_MASK\r\n| UVD_CGC_CTRL__RBC_MODE_MASK\r\n| UVD_CGC_CTRL__LMI_MC_MODE_MASK\r\n| UVD_CGC_CTRL__LMI_UMC_MODE_MASK\r\n| UVD_CGC_CTRL__IDCT_MODE_MASK\r\n| UVD_CGC_CTRL__MPRD_MODE_MASK\r\n| UVD_CGC_CTRL__MPC_MODE_MASK\r\n| UVD_CGC_CTRL__LBSI_MODE_MASK\r\n| UVD_CGC_CTRL__LRBBM_MODE_MASK\r\n| UVD_CGC_CTRL__WCB_MODE_MASK\r\n| UVD_CGC_CTRL__VCPU_MODE_MASK\r\n| UVD_CGC_CTRL__SCPU_MODE_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_CGC_CTRL, data);\r\ndata = RREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_CTRL);\r\ndata |= (UVD_SUVD_CGC_CTRL__SRE_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SIT_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SMP_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SCM_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SDB_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SCLR_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__UVD_SC_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__ENT_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__IME_MODE_MASK\r\n| UVD_SUVD_CGC_CTRL__SITE_MODE_MASK);\r\nWREG32_SOC15(VCN, 0, mmUVD_SUVD_CGC_CTRL, data);\r\n}\r\nstatic int vcn_v1_0_start(struct amdgpu_device *adev)\r\n{\r\nstruct amdgpu_ring *ring = &adev->vcn.ring_dec;\r\nuint32_t rb_bufsz, tmp;\r\nuint32_t lmi_swap_cntl;\r\nint i, j, r;\r\nlmi_swap_cntl = 0;\r\nvcn_v1_0_mc_resume(adev);\r\nvcn_v1_0_disable_clock_gating(adev, true);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_MASTINT_EN), 0,\r\n~UVD_MASTINT_EN__VCPU_EN_MASK);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_CTRL2),\r\nUVD_LMI_CTRL2__STALL_ARB_UMC_MASK,\r\n~UVD_LMI_CTRL2__STALL_ARB_UMC_MASK);\r\nmdelay(1);\r\nWREG32_SOC15(UVD, 0, mmUVD_SOFT_RESET,\r\nUVD_SOFT_RESET__LMI_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__VCPU_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__LBSI_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__RBC_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__CSM_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__CXW_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__TAP_SOFT_RESET_MASK |\r\nUVD_SOFT_RESET__LMI_UMC_SOFT_RESET_MASK);\r\nmdelay(5);\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_CTRL,\r\n(0x40 << UVD_LMI_CTRL__WRITE_CLEAN_TIMER__SHIFT) |\r\nUVD_LMI_CTRL__WRITE_CLEAN_TIMER_EN_MASK |\r\nUVD_LMI_CTRL__DATA_COHERENCY_EN_MASK |\r\nUVD_LMI_CTRL__VCPU_DATA_COHERENCY_EN_MASK |\r\nUVD_LMI_CTRL__REQ_MODE_MASK |\r\n0x00100000L);\r\n#ifdef __BIG_ENDIAN\r\nlmi_swap_cntl = 0xa;\r\n#endif\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_SWAP_CNTL, lmi_swap_cntl);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_MUXA0, 0x40c2040);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_MUXA1, 0x0);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_MUXB0, 0x40c2040);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_MUXB1, 0x0);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_ALU, 0);\r\nWREG32_SOC15(UVD, 0, mmUVD_MPC_SET_MUX, 0x88);\r\nWREG32_SOC15(UVD, 0, mmUVD_SOFT_RESET,\r\nUVD_SOFT_RESET__VCPU_SOFT_RESET_MASK);\r\nmdelay(5);\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CNTL,\r\nUVD_VCPU_CNTL__CLK_EN_MASK);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_CTRL2), 0,\r\n~UVD_LMI_CTRL2__STALL_ARB_UMC_MASK);\r\nWREG32_SOC15(UVD, 0, mmUVD_SOFT_RESET, 0);\r\nmdelay(10);\r\nfor (i = 0; i < 10; ++i) {\r\nuint32_t status;\r\nfor (j = 0; j < 100; ++j) {\r\nstatus = RREG32_SOC15(UVD, 0, mmUVD_STATUS);\r\nif (status & 2)\r\nbreak;\r\nmdelay(10);\r\n}\r\nr = 0;\r\nif (status & 2)\r\nbreak;\r\nDRM_ERROR("VCN decode not responding, trying to reset the VCPU!!!\n");\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_SOFT_RESET),\r\nUVD_SOFT_RESET__VCPU_SOFT_RESET_MASK,\r\n~UVD_SOFT_RESET__VCPU_SOFT_RESET_MASK);\r\nmdelay(10);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_SOFT_RESET), 0,\r\n~UVD_SOFT_RESET__VCPU_SOFT_RESET_MASK);\r\nmdelay(10);\r\nr = -1;\r\n}\r\nif (r) {\r\nDRM_ERROR("VCN decode not responding, giving up!!!\n");\r\nreturn r;\r\n}\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_MASTINT_EN),\r\n(UVD_MASTINT_EN__VCPU_EN_MASK|UVD_MASTINT_EN__SYS_EN_MASK),\r\n~(UVD_MASTINT_EN__VCPU_EN_MASK|UVD_MASTINT_EN__SYS_EN_MASK));\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_STATUS), 0,\r\n~(2 << UVD_STATUS__VCPU_REPORT__SHIFT));\r\nrb_bufsz = order_base_2(ring->ring_size);\r\ntmp = REG_SET_FIELD(0, UVD_RBC_RB_CNTL, RB_BUFSZ, rb_bufsz);\r\ntmp = REG_SET_FIELD(tmp, UVD_RBC_RB_CNTL, RB_BLKSZ, 1);\r\ntmp = REG_SET_FIELD(tmp, UVD_RBC_RB_CNTL, RB_NO_FETCH, 1);\r\ntmp = REG_SET_FIELD(tmp, UVD_RBC_RB_CNTL, RB_WPTR_POLL_EN, 0);\r\ntmp = REG_SET_FIELD(tmp, UVD_RBC_RB_CNTL, RB_NO_UPDATE, 1);\r\ntmp = REG_SET_FIELD(tmp, UVD_RBC_RB_CNTL, RB_RPTR_WR_EN, 1);\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_CNTL, tmp);\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_WPTR_CNTL, 0);\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_RPTR_ADDR,\r\n(upper_32_bits(ring->gpu_addr) >> 2));\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_RBC_RB_64BIT_BAR_LOW,\r\nlower_32_bits(ring->gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_LMI_RBC_RB_64BIT_BAR_HIGH,\r\nupper_32_bits(ring->gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_RPTR, 0);\r\nring->wptr = RREG32_SOC15(UVD, 0, mmUVD_RBC_RB_RPTR);\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_WPTR,\r\nlower_32_bits(ring->wptr));\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_RBC_RB_CNTL), 0,\r\n~UVD_RBC_RB_CNTL__RB_NO_FETCH_MASK);\r\nring = &adev->vcn.ring_enc[0];\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_RPTR, lower_32_bits(ring->wptr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_WPTR, lower_32_bits(ring->wptr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_BASE_LO, ring->gpu_addr);\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_BASE_HI, upper_32_bits(ring->gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_SIZE, ring->ring_size / 4);\r\nring = &adev->vcn.ring_enc[1];\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_RPTR2, lower_32_bits(ring->wptr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_WPTR2, lower_32_bits(ring->wptr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_BASE_LO2, ring->gpu_addr);\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_BASE_HI2, upper_32_bits(ring->gpu_addr));\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_SIZE2, ring->ring_size / 4);\r\nreturn 0;\r\n}\r\nstatic int vcn_v1_0_stop(struct amdgpu_device *adev)\r\n{\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_CNTL, 0x11010101);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_CTRL2),\r\nUVD_LMI_CTRL2__STALL_ARB_UMC_MASK,\r\n~UVD_LMI_CTRL2__STALL_ARB_UMC_MASK);\r\nmdelay(1);\r\nWREG32_SOC15(UVD, 0, mmUVD_SOFT_RESET,\r\nUVD_SOFT_RESET__VCPU_SOFT_RESET_MASK);\r\nmdelay(5);\r\nWREG32_SOC15(UVD, 0, mmUVD_VCPU_CNTL, 0x0);\r\nWREG32_P(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_CTRL2), 0,\r\n~UVD_LMI_CTRL2__STALL_ARB_UMC_MASK);\r\nvcn_v1_0_enable_clock_gating(adev, true);\r\nreturn 0;\r\n}\r\nstatic int vcn_v1_0_set_clockgating_state(void *handle,\r\nenum amd_clockgating_state state)\r\n{\r\nreturn 0;\r\n}\r\nstatic uint64_t vcn_v1_0_dec_ring_get_rptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RBC_RB_RPTR);\r\n}\r\nstatic uint64_t vcn_v1_0_dec_ring_get_wptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RBC_RB_WPTR);\r\n}\r\nstatic void vcn_v1_0_dec_ring_set_wptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nWREG32_SOC15(UVD, 0, mmUVD_RBC_RB_WPTR, lower_32_bits(ring->wptr));\r\n}\r\nstatic void vcn_v1_0_dec_ring_insert_start(struct amdgpu_ring *ring)\r\n{\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA0), 0));\r\namdgpu_ring_write(ring, 0);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_PACKET_START << 1);\r\n}\r\nstatic void vcn_v1_0_dec_ring_insert_end(struct amdgpu_ring *ring)\r\n{\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_PACKET_END << 1);\r\n}\r\nstatic void vcn_v1_0_dec_ring_emit_fence(struct amdgpu_ring *ring, u64 addr, u64 seq,\r\nunsigned flags)\r\n{\r\nWARN_ON(flags & AMDGPU_FENCE_FLAG_64BIT);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_CONTEXT_ID), 0));\r\namdgpu_ring_write(ring, seq);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA0), 0));\r\namdgpu_ring_write(ring, addr & 0xffffffff);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA1), 0));\r\namdgpu_ring_write(ring, upper_32_bits(addr) & 0xff);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_FENCE << 1);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA0), 0));\r\namdgpu_ring_write(ring, 0);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA1), 0));\r\namdgpu_ring_write(ring, 0);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_TRAP << 1);\r\n}\r\nstatic void vcn_v1_0_dec_ring_emit_hdp_invalidate(struct amdgpu_ring *ring)\r\n{\r\namdgpu_ring_write(ring, PACKET0(SOC15_REG_OFFSET(HDP, 0, mmHDP_DEBUG0), 0));\r\namdgpu_ring_write(ring, 1);\r\n}\r\nstatic void vcn_v1_0_dec_ring_emit_ib(struct amdgpu_ring *ring,\r\nstruct amdgpu_ib *ib,\r\nunsigned vm_id, bool ctx_switch)\r\n{\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_RBC_IB_VMID), 0));\r\namdgpu_ring_write(ring, vm_id);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_RBC_IB_64BIT_BAR_LOW), 0));\r\namdgpu_ring_write(ring, lower_32_bits(ib->gpu_addr));\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_LMI_RBC_IB_64BIT_BAR_HIGH), 0));\r\namdgpu_ring_write(ring, upper_32_bits(ib->gpu_addr));\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_RBC_IB_SIZE), 0));\r\namdgpu_ring_write(ring, ib->length_dw);\r\n}\r\nstatic void vcn_v1_0_dec_vm_reg_write(struct amdgpu_ring *ring,\r\nuint32_t data0, uint32_t data1)\r\n{\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA0), 0));\r\namdgpu_ring_write(ring, data0);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA1), 0));\r\namdgpu_ring_write(ring, data1);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_WRITE_REG << 1);\r\n}\r\nstatic void vcn_v1_0_dec_vm_reg_wait(struct amdgpu_ring *ring,\r\nuint32_t data0, uint32_t data1, uint32_t mask)\r\n{\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA0), 0));\r\namdgpu_ring_write(ring, data0);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_DATA1), 0));\r\namdgpu_ring_write(ring, data1);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GP_SCRATCH8), 0));\r\namdgpu_ring_write(ring, mask);\r\namdgpu_ring_write(ring,\r\nPACKET0(SOC15_REG_OFFSET(UVD, 0, mmUVD_GPCOM_VCPU_CMD), 0));\r\namdgpu_ring_write(ring, VCN_DEC_CMD_REG_READ_COND_WAIT << 1);\r\n}\r\nstatic void vcn_v1_0_dec_ring_emit_vm_flush(struct amdgpu_ring *ring,\r\nunsigned vm_id, uint64_t pd_addr)\r\n{\r\nstruct amdgpu_vmhub *hub = &ring->adev->vmhub[ring->funcs->vmhub];\r\nuint32_t req = ring->adev->gart.gart_funcs->get_invalidate_req(vm_id);\r\nuint32_t data0, data1, mask;\r\nunsigned eng = ring->vm_inv_eng;\r\npd_addr = amdgpu_gart_get_vm_pde(ring->adev, pd_addr);\r\npd_addr |= AMDGPU_PTE_VALID;\r\ndata0 = (hub->ctx0_ptb_addr_hi32 + vm_id * 2) << 2;\r\ndata1 = upper_32_bits(pd_addr);\r\nvcn_v1_0_dec_vm_reg_write(ring, data0, data1);\r\ndata0 = (hub->ctx0_ptb_addr_lo32 + vm_id * 2) << 2;\r\ndata1 = lower_32_bits(pd_addr);\r\nvcn_v1_0_dec_vm_reg_write(ring, data0, data1);\r\ndata0 = (hub->ctx0_ptb_addr_lo32 + vm_id * 2) << 2;\r\ndata1 = lower_32_bits(pd_addr);\r\nmask = 0xffffffff;\r\nvcn_v1_0_dec_vm_reg_wait(ring, data0, data1, mask);\r\ndata0 = (hub->vm_inv_eng0_req + eng) << 2;\r\ndata1 = req;\r\nvcn_v1_0_dec_vm_reg_write(ring, data0, data1);\r\ndata0 = (hub->vm_inv_eng0_ack + eng) << 2;\r\ndata1 = 1 << vm_id;\r\nmask = 1 << vm_id;\r\nvcn_v1_0_dec_vm_reg_wait(ring, data0, data1, mask);\r\n}\r\nstatic uint64_t vcn_v1_0_enc_ring_get_rptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nif (ring == &adev->vcn.ring_enc[0])\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RB_RPTR);\r\nelse\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RB_RPTR2);\r\n}\r\nstatic uint64_t vcn_v1_0_enc_ring_get_wptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nif (ring == &adev->vcn.ring_enc[0])\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RB_WPTR);\r\nelse\r\nreturn RREG32_SOC15(UVD, 0, mmUVD_RB_WPTR2);\r\n}\r\nstatic void vcn_v1_0_enc_ring_set_wptr(struct amdgpu_ring *ring)\r\n{\r\nstruct amdgpu_device *adev = ring->adev;\r\nif (ring == &adev->vcn.ring_enc[0])\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_WPTR,\r\nlower_32_bits(ring->wptr));\r\nelse\r\nWREG32_SOC15(UVD, 0, mmUVD_RB_WPTR2,\r\nlower_32_bits(ring->wptr));\r\n}\r\nstatic void vcn_v1_0_enc_ring_emit_fence(struct amdgpu_ring *ring, u64 addr,\r\nu64 seq, unsigned flags)\r\n{\r\nWARN_ON(flags & AMDGPU_FENCE_FLAG_64BIT);\r\namdgpu_ring_write(ring, VCN_ENC_CMD_FENCE);\r\namdgpu_ring_write(ring, addr);\r\namdgpu_ring_write(ring, upper_32_bits(addr));\r\namdgpu_ring_write(ring, seq);\r\namdgpu_ring_write(ring, VCN_ENC_CMD_TRAP);\r\n}\r\nstatic void vcn_v1_0_enc_ring_insert_end(struct amdgpu_ring *ring)\r\n{\r\namdgpu_ring_write(ring, VCN_ENC_CMD_END);\r\n}\r\nstatic void vcn_v1_0_enc_ring_emit_ib(struct amdgpu_ring *ring,\r\nstruct amdgpu_ib *ib, unsigned int vm_id, bool ctx_switch)\r\n{\r\namdgpu_ring_write(ring, VCN_ENC_CMD_IB);\r\namdgpu_ring_write(ring, vm_id);\r\namdgpu_ring_write(ring, lower_32_bits(ib->gpu_addr));\r\namdgpu_ring_write(ring, upper_32_bits(ib->gpu_addr));\r\namdgpu_ring_write(ring, ib->length_dw);\r\n}\r\nstatic void vcn_v1_0_enc_ring_emit_vm_flush(struct amdgpu_ring *ring,\r\nunsigned int vm_id, uint64_t pd_addr)\r\n{\r\nstruct amdgpu_vmhub *hub = &ring->adev->vmhub[ring->funcs->vmhub];\r\nuint32_t req = ring->adev->gart.gart_funcs->get_invalidate_req(vm_id);\r\nunsigned eng = ring->vm_inv_eng;\r\npd_addr = amdgpu_gart_get_vm_pde(ring->adev, pd_addr);\r\npd_addr |= AMDGPU_PTE_VALID;\r\namdgpu_ring_write(ring, VCN_ENC_CMD_REG_WRITE);\r\namdgpu_ring_write(ring,\r\n(hub->ctx0_ptb_addr_hi32 + vm_id * 2) << 2);\r\namdgpu_ring_write(ring, upper_32_bits(pd_addr));\r\namdgpu_ring_write(ring, VCN_ENC_CMD_REG_WRITE);\r\namdgpu_ring_write(ring,\r\n(hub->ctx0_ptb_addr_lo32 + vm_id * 2) << 2);\r\namdgpu_ring_write(ring, lower_32_bits(pd_addr));\r\namdgpu_ring_write(ring, VCN_ENC_CMD_REG_WAIT);\r\namdgpu_ring_write(ring,\r\n(hub->ctx0_ptb_addr_lo32 + vm_id * 2) << 2);\r\namdgpu_ring_write(ring, 0xffffffff);\r\namdgpu_ring_write(ring, lower_32_bits(pd_addr));\r\namdgpu_ring_write(ring, VCN_ENC_CMD_REG_WRITE);\r\namdgpu_ring_write(ring, (hub->vm_inv_eng0_req + eng) << 2);\r\namdgpu_ring_write(ring, req);\r\namdgpu_ring_write(ring, VCN_ENC_CMD_REG_WAIT);\r\namdgpu_ring_write(ring, (hub->vm_inv_eng0_ack + eng) << 2);\r\namdgpu_ring_write(ring, 1 << vm_id);\r\namdgpu_ring_write(ring, 1 << vm_id);\r\n}\r\nstatic int vcn_v1_0_set_interrupt_state(struct amdgpu_device *adev,\r\nstruct amdgpu_irq_src *source,\r\nunsigned type,\r\nenum amdgpu_interrupt_state state)\r\n{\r\nreturn 0;\r\n}\r\nstatic int vcn_v1_0_process_interrupt(struct amdgpu_device *adev,\r\nstruct amdgpu_irq_src *source,\r\nstruct amdgpu_iv_entry *entry)\r\n{\r\nDRM_DEBUG("IH: VCN TRAP\n");\r\nswitch (entry->src_id) {\r\ncase 124:\r\namdgpu_fence_process(&adev->vcn.ring_dec);\r\nbreak;\r\ncase 119:\r\namdgpu_fence_process(&adev->vcn.ring_enc[0]);\r\nbreak;\r\ncase 120:\r\namdgpu_fence_process(&adev->vcn.ring_enc[1]);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unhandled interrupt: %d %d\n",\r\nentry->src_id, entry->src_data[0]);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void vcn_v1_0_set_dec_ring_funcs(struct amdgpu_device *adev)\r\n{\r\nadev->vcn.ring_dec.funcs = &vcn_v1_0_dec_ring_vm_funcs;\r\nDRM_INFO("VCN decode is enabled in VM mode\n");\r\n}\r\nstatic void vcn_v1_0_set_enc_ring_funcs(struct amdgpu_device *adev)\r\n{\r\nint i;\r\nfor (i = 0; i < adev->vcn.num_enc_rings; ++i)\r\nadev->vcn.ring_enc[i].funcs = &vcn_v1_0_enc_ring_vm_funcs;\r\nDRM_INFO("VCN encode is enabled in VM mode\n");\r\n}\r\nstatic void vcn_v1_0_set_irq_funcs(struct amdgpu_device *adev)\r\n{\r\nadev->uvd.irq.num_types = adev->vcn.num_enc_rings + 1;\r\nadev->vcn.irq.funcs = &vcn_v1_0_irq_funcs;\r\n}

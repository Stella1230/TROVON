static\r\nstruct iio_sw_device_type *__iio_find_sw_device_type(const char *name,\r\nunsigned len)\r\n{\r\nstruct iio_sw_device_type *d = NULL, *iter;\r\nlist_for_each_entry(iter, &iio_device_types_list, list)\r\nif (!strcmp(iter->name, name)) {\r\nd = iter;\r\nbreak;\r\n}\r\nreturn d;\r\n}\r\nint iio_register_sw_device_type(struct iio_sw_device_type *d)\r\n{\r\nstruct iio_sw_device_type *iter;\r\nint ret = 0;\r\nmutex_lock(&iio_device_types_lock);\r\niter = __iio_find_sw_device_type(d->name, strlen(d->name));\r\nif (iter)\r\nret = -EBUSY;\r\nelse\r\nlist_add_tail(&d->list, &iio_device_types_list);\r\nmutex_unlock(&iio_device_types_lock);\r\nif (ret)\r\nreturn ret;\r\nd->group = configfs_register_default_group(iio_devices_group, d->name,\r\n&iio_device_type_group_type);\r\nif (IS_ERR(d->group))\r\nret = PTR_ERR(d->group);\r\nreturn ret;\r\n}\r\nvoid iio_unregister_sw_device_type(struct iio_sw_device_type *dt)\r\n{\r\nstruct iio_sw_device_type *iter;\r\nmutex_lock(&iio_device_types_lock);\r\niter = __iio_find_sw_device_type(dt->name, strlen(dt->name));\r\nif (iter)\r\nlist_del(&dt->list);\r\nmutex_unlock(&iio_device_types_lock);\r\nconfigfs_unregister_default_group(dt->group);\r\n}\r\nstatic\r\nstruct iio_sw_device_type *iio_get_sw_device_type(const char *name)\r\n{\r\nstruct iio_sw_device_type *dt;\r\nmutex_lock(&iio_device_types_lock);\r\ndt = __iio_find_sw_device_type(name, strlen(name));\r\nif (dt && !try_module_get(dt->owner))\r\ndt = NULL;\r\nmutex_unlock(&iio_device_types_lock);\r\nreturn dt;\r\n}\r\nstruct iio_sw_device *iio_sw_device_create(const char *type, const char *name)\r\n{\r\nstruct iio_sw_device *d;\r\nstruct iio_sw_device_type *dt;\r\ndt = iio_get_sw_device_type(type);\r\nif (!dt) {\r\npr_err("Invalid device type: %s\n", type);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nd = dt->ops->probe(name);\r\nif (IS_ERR(d))\r\ngoto out_module_put;\r\nd->device_type = dt;\r\nreturn d;\r\nout_module_put:\r\nmodule_put(dt->owner);\r\nreturn d;\r\n}\r\nvoid iio_sw_device_destroy(struct iio_sw_device *d)\r\n{\r\nstruct iio_sw_device_type *dt = d->device_type;\r\ndt->ops->remove(d);\r\nmodule_put(dt->owner);\r\n}\r\nstatic struct config_group *device_make_group(struct config_group *group,\r\nconst char *name)\r\n{\r\nstruct iio_sw_device *d;\r\nd = iio_sw_device_create(group->cg_item.ci_name, name);\r\nif (IS_ERR(d))\r\nreturn ERR_CAST(d);\r\nconfig_item_set_name(&d->group.cg_item, "%s", name);\r\nreturn &d->group;\r\n}\r\nstatic void device_drop_group(struct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct iio_sw_device *d = to_iio_sw_device(item);\r\niio_sw_device_destroy(d);\r\nconfig_item_put(item);\r\n}\r\nstatic int __init iio_sw_device_init(void)\r\n{\r\niio_devices_group =\r\nconfigfs_register_default_group(&iio_configfs_subsys.su_group,\r\n"devices",\r\n&iio_devices_group_type);\r\nreturn PTR_ERR_OR_ZERO(iio_devices_group);\r\n}\r\nstatic void __exit iio_sw_device_exit(void)\r\n{\r\nconfigfs_unregister_default_group(iio_devices_group);\r\n}

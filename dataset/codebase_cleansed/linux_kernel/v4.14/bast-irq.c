static void\r\nbast_pc104_mask(struct irq_data *data)\r\n{\r\nunsigned long temp;\r\ntemp = __raw_readb(BAST_VA_PC104_IRQMASK);\r\ntemp &= ~bast_pc104_irqmasks[data->irq];\r\n__raw_writeb(temp, BAST_VA_PC104_IRQMASK);\r\n}\r\nstatic void\r\nbast_pc104_maskack(struct irq_data *data)\r\n{\r\nstruct irq_desc *desc = irq_desc + BAST_IRQ_ISA;\r\nbast_pc104_mask(data);\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\n}\r\nstatic void\r\nbast_pc104_unmask(struct irq_data *data)\r\n{\r\nunsigned long temp;\r\ntemp = __raw_readb(BAST_VA_PC104_IRQMASK);\r\ntemp |= bast_pc104_irqmasks[data->irq];\r\n__raw_writeb(temp, BAST_VA_PC104_IRQMASK);\r\n}\r\nstatic void bast_irq_pc104_demux(struct irq_desc *desc)\r\n{\r\nunsigned int stat;\r\nunsigned int irqno;\r\nint i;\r\nstat = __raw_readb(BAST_VA_PC104_IRQREQ) & 0xf;\r\nif (unlikely(stat == 0)) {\r\ndesc = irq_desc + BAST_IRQ_ISA;\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\n} else {\r\nfor (i = 0; stat != 0; i++, stat >>= 1) {\r\nif (stat & 1) {\r\nirqno = bast_pc104_irqs[i];\r\ngeneric_handle_irq(irqno);\r\n}\r\n}\r\n}\r\n}\r\nstatic __init int bast_irq_init(void)\r\n{\r\nunsigned int i;\r\nif (machine_is_bast()) {\r\nprintk(KERN_INFO "BAST PC104 IRQ routing, Copyright 2005 Simtec Electronics\n");\r\n__raw_writeb(0x0, BAST_VA_PC104_IRQMASK);\r\nirq_set_chained_handler(BAST_IRQ_ISA, bast_irq_pc104_demux);\r\nfor (i = 0; i < 4; i++) {\r\nunsigned int irqno = bast_pc104_irqs[i];\r\nirq_set_chip_and_handler(irqno, &bast_pc104_chip,\r\nhandle_level_irq);\r\nirq_clear_status_flags(irqno, IRQ_NOREQUEST);\r\n}\r\n}\r\nreturn 0;\r\n}

static unsigned int hi6421v530_regulator_ldo_get_mode(\r\nstruct regulator_dev *rdev)\r\n{\r\nstruct hi6421v530_regulator_info *info;\r\nunsigned int reg_val;\r\ninfo = rdev_get_drvdata(rdev);\r\nregmap_read(rdev->regmap, rdev->desc->enable_reg, &reg_val);\r\nif (reg_val & (info->mode_mask))\r\nreturn REGULATOR_MODE_IDLE;\r\nreturn REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int hi6421v530_regulator_ldo_set_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nstruct hi6421v530_regulator_info *info;\r\nunsigned int new_mode;\r\ninfo = rdev_get_drvdata(rdev);\r\nswitch (mode) {\r\ncase REGULATOR_MODE_NORMAL:\r\nnew_mode = 0;\r\nbreak;\r\ncase REGULATOR_MODE_IDLE:\r\nnew_mode = info->mode_mask;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(rdev->regmap, rdev->desc->enable_reg,\r\ninfo->mode_mask, new_mode);\r\nreturn 0;\r\n}\r\nstatic int hi6421v530_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct hi6421_pmic *pmic;\r\nstruct regulator_dev *rdev;\r\nstruct regulator_config config = { };\r\nunsigned int i;\r\npmic = dev_get_drvdata(pdev->dev.parent);\r\nif (!pmic) {\r\ndev_err(&pdev->dev, "no pmic in the regulator parent node\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(hi6421v530_regulator_info); i++) {\r\nconfig.dev = pdev->dev.parent;\r\nconfig.regmap = pmic->regmap;\r\nconfig.driver_data = &hi6421v530_regulator_info[i];\r\nrdev = devm_regulator_register(&pdev->dev,\r\n&hi6421v530_regulator_info[i].rdesc,\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nhi6421v530_regulator_info[i].rdesc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}

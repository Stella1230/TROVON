static int\r\ncsio_t5_set_mem_win(struct csio_hw *hw, uint32_t win)\r\n{\r\nu32 mem_win_base;\r\nmem_win_base = MEMWIN_BASE;\r\ncsio_wr_reg32(hw, mem_win_base | BIR_V(0) |\r\nWINDOW_V(ilog2(MEMWIN_APERTURE) - 10),\r\nPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\r\ncsio_rd_reg32(hw,\r\nPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\r\nreturn 0;\r\n}\r\nstatic void\r\ncsio_t5_pcie_intr_handler(struct csio_hw *hw)\r\n{\r\nstatic struct intr_info pcie_intr_info[] = {\r\n{ MSTGRPPERR_F, "Master Response Read Queue parity error",\r\n-1, 1 },\r\n{ MSTTIMEOUTPERR_F, "Master Timeout FIFO parity error", -1, 1 },\r\n{ MSIXSTIPERR_F, "MSI-X STI SRAM parity error", -1, 1 },\r\n{ MSIXADDRLPERR_F, "MSI-X AddrL parity error", -1, 1 },\r\n{ MSIXADDRHPERR_F, "MSI-X AddrH parity error", -1, 1 },\r\n{ MSIXDATAPERR_F, "MSI-X data parity error", -1, 1 },\r\n{ MSIXDIPERR_F, "MSI-X DI parity error", -1, 1 },\r\n{ PIOCPLGRPPERR_F, "PCI PIO completion Group FIFO parity error",\r\n-1, 1 },\r\n{ PIOREQGRPPERR_F, "PCI PIO request Group FIFO parity error",\r\n-1, 1 },\r\n{ TARTAGPERR_F, "PCI PCI target tag FIFO parity error", -1, 1 },\r\n{ MSTTAGQPERR_F, "PCI master tag queue parity error", -1, 1 },\r\n{ CREQPERR_F, "PCI CMD channel request parity error", -1, 1 },\r\n{ CRSPPERR_F, "PCI CMD channel response parity error", -1, 1 },\r\n{ DREQWRPERR_F, "PCI DMA channel write request parity error",\r\n-1, 1 },\r\n{ DREQPERR_F, "PCI DMA channel request parity error", -1, 1 },\r\n{ DRSPPERR_F, "PCI DMA channel response parity error", -1, 1 },\r\n{ HREQWRPERR_F, "PCI HMA channel count parity error", -1, 1 },\r\n{ HREQPERR_F, "PCI HMA channel request parity error", -1, 1 },\r\n{ HRSPPERR_F, "PCI HMA channel response parity error", -1, 1 },\r\n{ CFGSNPPERR_F, "PCI config snoop FIFO parity error", -1, 1 },\r\n{ FIDPERR_F, "PCI FID parity error", -1, 1 },\r\n{ VFIDPERR_F, "PCI INTx clear parity error", -1, 1 },\r\n{ MAGRPPERR_F, "PCI MA group FIFO parity error", -1, 1 },\r\n{ PIOTAGPERR_F, "PCI PIO tag parity error", -1, 1 },\r\n{ IPRXHDRGRPPERR_F, "PCI IP Rx header group parity error",\r\n-1, 1 },\r\n{ IPRXDATAGRPPERR_F, "PCI IP Rx data group parity error",\r\n-1, 1 },\r\n{ RPLPERR_F, "PCI IP replay buffer parity error", -1, 1 },\r\n{ IPSOTPERR_F, "PCI IP SOT buffer parity error", -1, 1 },\r\n{ TRGT1GRPPERR_F, "PCI TRGT1 group FIFOs parity error", -1, 1 },\r\n{ READRSPERR_F, "Outbound read error", -1, 0 },\r\n{ 0, NULL, 0, 0 }\r\n};\r\nint fat;\r\nfat = csio_handle_intr_status(hw, PCIE_INT_CAUSE_A, pcie_intr_info);\r\nif (fat)\r\ncsio_hw_fatal_err(hw);\r\n}\r\nstatic unsigned int\r\ncsio_t5_flash_cfg_addr(struct csio_hw *hw)\r\n{\r\nreturn FLASH_CFG_START;\r\n}\r\nstatic int\r\ncsio_t5_mc_read(struct csio_hw *hw, int idx, uint32_t addr, __be32 *data,\r\nuint64_t *ecc)\r\n{\r\nint i;\r\nuint32_t mc_bist_cmd_reg, mc_bist_cmd_addr_reg, mc_bist_cmd_len_reg;\r\nuint32_t mc_bist_status_rdata_reg, mc_bist_data_pattern_reg;\r\nmc_bist_cmd_reg = MC_REG(MC_P_BIST_CMD_A, idx);\r\nmc_bist_cmd_addr_reg = MC_REG(MC_P_BIST_CMD_ADDR_A, idx);\r\nmc_bist_cmd_len_reg = MC_REG(MC_P_BIST_CMD_LEN_A, idx);\r\nmc_bist_status_rdata_reg = MC_REG(MC_P_BIST_STATUS_RDATA_A, idx);\r\nmc_bist_data_pattern_reg = MC_REG(MC_P_BIST_DATA_PATTERN_A, idx);\r\nif (csio_rd_reg32(hw, mc_bist_cmd_reg) & START_BIST_F)\r\nreturn -EBUSY;\r\ncsio_wr_reg32(hw, addr & ~0x3fU, mc_bist_cmd_addr_reg);\r\ncsio_wr_reg32(hw, 64, mc_bist_cmd_len_reg);\r\ncsio_wr_reg32(hw, 0xc, mc_bist_data_pattern_reg);\r\ncsio_wr_reg32(hw, BIST_OPCODE_V(1) | START_BIST_F | BIST_CMD_GAP_V(1),\r\nmc_bist_cmd_reg);\r\ni = csio_hw_wait_op_done_val(hw, mc_bist_cmd_reg, START_BIST_F,\r\n0, 10, 1, NULL);\r\nif (i)\r\nreturn i;\r\n#define MC_DATA(i) MC_BIST_STATUS_REG(MC_BIST_STATUS_RDATA_A, i)\r\nfor (i = 15; i >= 0; i--)\r\n*data++ = htonl(csio_rd_reg32(hw, MC_DATA(i)));\r\nif (ecc)\r\n*ecc = csio_rd_reg64(hw, MC_DATA(16));\r\n#undef MC_DATA\r\nreturn 0;\r\n}\r\nstatic int\r\ncsio_t5_edc_read(struct csio_hw *hw, int idx, uint32_t addr, __be32 *data,\r\nuint64_t *ecc)\r\n{\r\nint i;\r\nuint32_t edc_bist_cmd_reg, edc_bist_cmd_addr_reg, edc_bist_cmd_len_reg;\r\nuint32_t edc_bist_cmd_data_pattern, edc_bist_status_rdata_reg;\r\n#define EDC_STRIDE_T5 (EDC_T51_BASE_ADDR - EDC_T50_BASE_ADDR)\r\n#define EDC_REG_T5(reg, idx) (reg + EDC_STRIDE_T5 * idx)\r\nedc_bist_cmd_reg = EDC_REG_T5(EDC_H_BIST_CMD_A, idx);\r\nedc_bist_cmd_addr_reg = EDC_REG_T5(EDC_H_BIST_CMD_ADDR_A, idx);\r\nedc_bist_cmd_len_reg = EDC_REG_T5(EDC_H_BIST_CMD_LEN_A, idx);\r\nedc_bist_cmd_data_pattern = EDC_REG_T5(EDC_H_BIST_DATA_PATTERN_A, idx);\r\nedc_bist_status_rdata_reg = EDC_REG_T5(EDC_H_BIST_STATUS_RDATA_A, idx);\r\n#undef EDC_REG_T5\r\n#undef EDC_STRIDE_T5\r\nif (csio_rd_reg32(hw, edc_bist_cmd_reg) & START_BIST_F)\r\nreturn -EBUSY;\r\ncsio_wr_reg32(hw, addr & ~0x3fU, edc_bist_cmd_addr_reg);\r\ncsio_wr_reg32(hw, 64, edc_bist_cmd_len_reg);\r\ncsio_wr_reg32(hw, 0xc, edc_bist_cmd_data_pattern);\r\ncsio_wr_reg32(hw, BIST_OPCODE_V(1) | START_BIST_F | BIST_CMD_GAP_V(1),\r\nedc_bist_cmd_reg);\r\ni = csio_hw_wait_op_done_val(hw, edc_bist_cmd_reg, START_BIST_F,\r\n0, 10, 1, NULL);\r\nif (i)\r\nreturn i;\r\n#define EDC_DATA(i) (EDC_BIST_STATUS_REG(EDC_BIST_STATUS_RDATA_A, i) + idx)\r\nfor (i = 15; i >= 0; i--)\r\n*data++ = htonl(csio_rd_reg32(hw, EDC_DATA(i)));\r\nif (ecc)\r\n*ecc = csio_rd_reg64(hw, EDC_DATA(16));\r\n#undef EDC_DATA\r\nreturn 0;\r\n}\r\nstatic int\r\ncsio_t5_memory_rw(struct csio_hw *hw, u32 win, int mtype, u32 addr,\r\nu32 len, uint32_t *buf, int dir)\r\n{\r\nu32 pos, start, offset, memoffset;\r\nu32 edc_size, mc_size, win_pf, mem_reg, mem_aperture, mem_base;\r\nif ((addr & 0x3) || (len & 0x3))\r\nreturn -EINVAL;\r\nedc_size = EDRAM0_SIZE_G(csio_rd_reg32(hw, MA_EDRAM0_BAR_A));\r\nif (mtype != MEM_MC1)\r\nmemoffset = (mtype * (edc_size * 1024 * 1024));\r\nelse {\r\nmc_size = EXT_MEM_SIZE_G(csio_rd_reg32(hw,\r\nMA_EXT_MEMORY_BAR_A));\r\nmemoffset = (MEM_MC0 * edc_size + mc_size) * 1024 * 1024;\r\n}\r\naddr = addr + memoffset;\r\nmem_reg = csio_rd_reg32(hw,\r\nPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\r\nmem_aperture = 1 << (WINDOW_V(mem_reg) + 10);\r\nmem_base = PCIEOFST_G(mem_reg) << 10;\r\nstart = addr & ~(mem_aperture-1);\r\noffset = addr - start;\r\nwin_pf = PFNUM_V(hw->pfn);\r\ncsio_dbg(hw, "csio_t5_memory_rw: mem_reg: 0x%x, mem_aperture: 0x%x\n",\r\nmem_reg, mem_aperture);\r\ncsio_dbg(hw, "csio_t5_memory_rw: mem_base: 0x%x, mem_offset: 0x%x\n",\r\nmem_base, memoffset);\r\ncsio_dbg(hw, "csio_t5_memory_rw: start:0x%x, offset:0x%x, win_pf:%d\n",\r\nstart, offset, win_pf);\r\ncsio_dbg(hw, "csio_t5_memory_rw: mtype: %d, addr: 0x%x, len: %d\n",\r\nmtype, addr, len);\r\nfor (pos = start; len > 0; pos += mem_aperture, offset = 0) {\r\ncsio_wr_reg32(hw, pos | win_pf,\r\nPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_OFFSET_A, win));\r\ncsio_rd_reg32(hw,\r\nPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_OFFSET_A, win));\r\nwhile (offset < mem_aperture && len > 0) {\r\nif (dir)\r\n*buf++ = csio_rd_reg32(hw, mem_base + offset);\r\nelse\r\ncsio_wr_reg32(hw, *buf++, mem_base + offset);\r\noffset += sizeof(__be32);\r\nlen -= sizeof(__be32);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\ncsio_t5_dfs_create_ext_mem(struct csio_hw *hw)\r\n{\r\nu32 size;\r\nint i = csio_rd_reg32(hw, MA_TARGET_MEM_ENABLE_A);\r\nif (i & EXT_MEM_ENABLE_F) {\r\nsize = csio_rd_reg32(hw, MA_EXT_MEMORY_BAR_A);\r\ncsio_add_debugfs_mem(hw, "mc0", MEM_MC0,\r\nEXT_MEM_SIZE_G(size));\r\n}\r\nif (i & EXT_MEM1_ENABLE_F) {\r\nsize = csio_rd_reg32(hw, MA_EXT_MEMORY1_BAR_A);\r\ncsio_add_debugfs_mem(hw, "mc1", MEM_MC1,\r\nEXT_MEM_SIZE_G(size));\r\n}\r\n}

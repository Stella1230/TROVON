static int pcimio_ai_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nint ret;\r\nret = mite_buf_change(devpriv->ai_mite_ring, s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcimio_ao_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nint ret;\r\nret = mite_buf_change(devpriv->ao_mite_ring, s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcimio_gpct0_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nint ret;\r\nret = mite_buf_change(devpriv->gpct_mite_ring[0], s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcimio_gpct1_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nint ret;\r\nret = mite_buf_change(devpriv->gpct_mite_ring[1], s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcimio_dio_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nint ret;\r\nret = mite_buf_change(devpriv->cdo_mite_ring, s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void m_series_init_eeprom_buffer(struct comedi_device *dev)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nstruct mite *mite = devpriv->mite;\r\nresource_size_t daq_phys_addr;\r\nstatic const int Start_Cal_EEPROM = 0x400;\r\nstatic const unsigned int window_size = 10;\r\nunsigned int old_iodwbsr_bits;\r\nunsigned int old_iodwbsr1_bits;\r\nunsigned int old_iodwcr1_bits;\r\nint i;\r\ndaq_phys_addr = pci_resource_start(mite->pcidev, 1);\r\nold_iodwbsr_bits = readl(mite->mmio + MITE_IODWBSR);\r\nold_iodwbsr1_bits = readl(mite->mmio + MITE_IODWBSR_1);\r\nold_iodwcr1_bits = readl(mite->mmio + MITE_IODWCR_1);\r\nwritel(0x0, mite->mmio + MITE_IODWBSR);\r\nwritel(((0x80 | window_size) | daq_phys_addr),\r\nmite->mmio + MITE_IODWBSR_1);\r\nwritel(0x1 | old_iodwcr1_bits, mite->mmio + MITE_IODWCR_1);\r\nwritel(0xf, mite->mmio + 0x30);\r\nfor (i = 0; i < M_SERIES_EEPROM_SIZE; ++i)\r\ndevpriv->eeprom_buffer[i] = ni_readb(dev, Start_Cal_EEPROM + i);\r\nwritel(old_iodwbsr1_bits, mite->mmio + MITE_IODWBSR_1);\r\nwritel(old_iodwbsr_bits, mite->mmio + MITE_IODWBSR);\r\nwritel(old_iodwcr1_bits, mite->mmio + MITE_IODWCR_1);\r\nwritel(0x0, mite->mmio + 0x30);\r\n}\r\nstatic void init_6143(struct comedi_device *dev)\r\n{\r\nconst struct ni_board_struct *board = dev->board_ptr;\r\nstruct ni_private *devpriv = dev->private;\r\nni_stc_writew(dev, 0, NISTC_INT_CTRL_REG);\r\nni_writeb(dev, 0x00, NI6143_MAGIC_REG);\r\nni_writeb(dev, 0x80, NI6143_PIPELINE_DELAY_REG);\r\nni_writeb(dev, 0x00, NI6143_EOC_SET_REG);\r\nni_writel(dev, board->ai_fifo_depth / 2, NI6143_AI_FIFO_FLAG_REG);\r\ndevpriv->ai_calib_source_enabled = 0;\r\nni_writew(dev, devpriv->ai_calib_source | NI6143_CALIB_CHAN_RELAY_OFF,\r\nNI6143_CALIB_CHAN_REG);\r\nni_writew(dev, devpriv->ai_calib_source, NI6143_CALIB_CHAN_REG);\r\n}\r\nstatic void pcimio_detach(struct comedi_device *dev)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nmio_common_detach(dev);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (devpriv) {\r\nmite_free_ring(devpriv->ai_mite_ring);\r\nmite_free_ring(devpriv->ao_mite_ring);\r\nmite_free_ring(devpriv->cdo_mite_ring);\r\nmite_free_ring(devpriv->gpct_mite_ring[0]);\r\nmite_free_ring(devpriv->gpct_mite_ring[1]);\r\nmite_detach(devpriv->mite);\r\n}\r\nif (dev->mmio)\r\niounmap(dev->mmio);\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int pcimio_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct ni_board_struct *board = NULL;\r\nstruct ni_private *devpriv;\r\nunsigned int irq;\r\nint ret;\r\nif (context < ARRAY_SIZE(ni_boards))\r\nboard = &ni_boards[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nret = ni_alloc_private(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = dev->private;\r\ndevpriv->mite = mite_attach(dev, false);\r\nif (!devpriv->mite)\r\nreturn -ENOMEM;\r\nif (board->reg_type & ni_reg_m_series_mask)\r\ndevpriv->is_m_series = 1;\r\nif (board->reg_type & ni_reg_6xxx_mask)\r\ndevpriv->is_6xxx = 1;\r\nif (board->reg_type == ni_reg_611x)\r\ndevpriv->is_611x = 1;\r\nif (board->reg_type == ni_reg_6143)\r\ndevpriv->is_6143 = 1;\r\nif (board->reg_type == ni_reg_622x)\r\ndevpriv->is_622x = 1;\r\nif (board->reg_type == ni_reg_625x)\r\ndevpriv->is_625x = 1;\r\nif (board->reg_type == ni_reg_628x)\r\ndevpriv->is_628x = 1;\r\nif (board->reg_type & ni_reg_67xx_mask)\r\ndevpriv->is_67xx = 1;\r\nif (board->reg_type == ni_reg_6711)\r\ndevpriv->is_6711 = 1;\r\nif (board->reg_type == ni_reg_6713)\r\ndevpriv->is_6713 = 1;\r\ndevpriv->ai_mite_ring = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->ai_mite_ring)\r\nreturn -ENOMEM;\r\ndevpriv->ao_mite_ring = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->ao_mite_ring)\r\nreturn -ENOMEM;\r\ndevpriv->cdo_mite_ring = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->cdo_mite_ring)\r\nreturn -ENOMEM;\r\ndevpriv->gpct_mite_ring[0] = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->gpct_mite_ring[0])\r\nreturn -ENOMEM;\r\ndevpriv->gpct_mite_ring[1] = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->gpct_mite_ring[1])\r\nreturn -ENOMEM;\r\nif (devpriv->is_m_series)\r\nm_series_init_eeprom_buffer(dev);\r\nif (devpriv->is_6143)\r\ninit_6143(dev);\r\nirq = pcidev->irq;\r\nif (irq) {\r\nret = request_irq(irq, ni_E_interrupt, IRQF_SHARED,\r\ndev->board_name, dev);\r\nif (ret == 0)\r\ndev->irq = irq;\r\n}\r\nret = ni_E_init(dev, 0, 1);\r\nif (ret < 0)\r\nreturn ret;\r\ndev->subdevices[NI_AI_SUBDEV].buf_change = &pcimio_ai_change;\r\ndev->subdevices[NI_AO_SUBDEV].buf_change = &pcimio_ao_change;\r\ndev->subdevices[NI_GPCT_SUBDEV(0)].buf_change = &pcimio_gpct0_change;\r\ndev->subdevices[NI_GPCT_SUBDEV(1)].buf_change = &pcimio_gpct1_change;\r\ndev->subdevices[NI_DIO_SUBDEV].buf_change = &pcimio_dio_change;\r\nreturn 0;\r\n}\r\nstatic int ni_pcimio_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &ni_pcimio_driver, id->driver_data);\r\n}

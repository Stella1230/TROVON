static void handle_jcore_irq(struct irq_desc *desc)\r\n{\r\nif (irqd_is_per_cpu(irq_desc_get_irq_data(desc)))\r\nhandle_percpu_irq(desc);\r\nelse\r\nhandle_simple_irq(desc);\r\n}\r\nstatic int jcore_aic_irqdomain_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hwirq)\r\n{\r\nstruct irq_chip *aic = d->host_data;\r\nirq_set_chip_and_handler(irq, aic, handle_jcore_irq);\r\nreturn 0;\r\n}\r\nstatic void noop(struct irq_data *data)\r\n{\r\n}\r\nstatic int __init aic_irq_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nunsigned min_irq = JCORE_AIC2_MIN_HWIRQ;\r\nunsigned dom_sz = JCORE_AIC_MAX_HWIRQ+1;\r\nstruct irq_domain *domain;\r\npr_info("Initializing J-Core AIC\n");\r\nif (of_device_is_compatible(node, "jcore,aic1")) {\r\nunsigned cpu;\r\nfor_each_present_cpu(cpu) {\r\nvoid __iomem *base = of_iomap(node, cpu);\r\nif (!base) {\r\npr_err("Unable to map AIC for cpu %u\n", cpu);\r\nreturn -ENOMEM;\r\n}\r\n__raw_writel(0xffffffff, base + JCORE_AIC1_INTPRI_REG);\r\niounmap(base);\r\n}\r\nmin_irq = JCORE_AIC1_MIN_HWIRQ;\r\n}\r\njcore_aic.irq_mask = noop;\r\njcore_aic.irq_unmask = noop;\r\njcore_aic.name = "AIC";\r\ndomain = irq_domain_add_linear(node, dom_sz, &jcore_aic_irqdomain_ops,\r\n&jcore_aic);\r\nif (!domain)\r\nreturn -ENOMEM;\r\nirq_create_strict_mappings(domain, min_irq, min_irq, dom_sz - min_irq);\r\nreturn 0;\r\n}

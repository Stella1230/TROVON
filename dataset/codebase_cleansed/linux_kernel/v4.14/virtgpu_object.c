static void virtio_gpu_ttm_bo_destroy(struct ttm_buffer_object *tbo)\r\n{\r\nstruct virtio_gpu_object *bo;\r\nstruct virtio_gpu_device *vgdev;\r\nbo = container_of(tbo, struct virtio_gpu_object, tbo);\r\nvgdev = (struct virtio_gpu_device *)bo->gem_base.dev->dev_private;\r\nif (bo->hw_res_handle)\r\nvirtio_gpu_cmd_unref_resource(vgdev, bo->hw_res_handle);\r\nif (bo->pages)\r\nvirtio_gpu_object_free_sg_table(bo);\r\ndrm_gem_object_release(&bo->gem_base);\r\nkfree(bo);\r\n}\r\nstatic void virtio_gpu_init_ttm_placement(struct virtio_gpu_object *vgbo,\r\nbool pinned)\r\n{\r\nu32 c = 1;\r\nu32 pflag = pinned ? TTM_PL_FLAG_NO_EVICT : 0;\r\nvgbo->placement.placement = &vgbo->placement_code;\r\nvgbo->placement.busy_placement = &vgbo->placement_code;\r\nvgbo->placement_code.fpfn = 0;\r\nvgbo->placement_code.lpfn = 0;\r\nvgbo->placement_code.flags =\r\nTTM_PL_MASK_CACHING | TTM_PL_FLAG_TT | pflag;\r\nvgbo->placement.num_placement = c;\r\nvgbo->placement.num_busy_placement = c;\r\n}\r\nint virtio_gpu_object_create(struct virtio_gpu_device *vgdev,\r\nunsigned long size, bool kernel, bool pinned,\r\nstruct virtio_gpu_object **bo_ptr)\r\n{\r\nstruct virtio_gpu_object *bo;\r\nenum ttm_bo_type type;\r\nsize_t acc_size;\r\nint ret;\r\nif (kernel)\r\ntype = ttm_bo_type_kernel;\r\nelse\r\ntype = ttm_bo_type_device;\r\n*bo_ptr = NULL;\r\nacc_size = ttm_bo_dma_acc_size(&vgdev->mman.bdev, size,\r\nsizeof(struct virtio_gpu_object));\r\nbo = kzalloc(sizeof(struct virtio_gpu_object), GFP_KERNEL);\r\nif (bo == NULL)\r\nreturn -ENOMEM;\r\nsize = roundup(size, PAGE_SIZE);\r\nret = drm_gem_object_init(vgdev->ddev, &bo->gem_base, size);\r\nif (ret != 0) {\r\nkfree(bo);\r\nreturn ret;\r\n}\r\nbo->dumb = false;\r\nvirtio_gpu_init_ttm_placement(bo, pinned);\r\nret = ttm_bo_init(&vgdev->mman.bdev, &bo->tbo, size, type,\r\n&bo->placement, 0, !kernel, NULL, acc_size,\r\nNULL, NULL, &virtio_gpu_ttm_bo_destroy);\r\nif (ret != 0)\r\nreturn ret;\r\n*bo_ptr = bo;\r\nreturn 0;\r\n}\r\nint virtio_gpu_object_kmap(struct virtio_gpu_object *bo, void **ptr)\r\n{\r\nbool is_iomem;\r\nint r;\r\nif (bo->vmap) {\r\nif (ptr)\r\n*ptr = bo->vmap;\r\nreturn 0;\r\n}\r\nr = ttm_bo_kmap(&bo->tbo, 0, bo->tbo.num_pages, &bo->kmap);\r\nif (r)\r\nreturn r;\r\nbo->vmap = ttm_kmap_obj_virtual(&bo->kmap, &is_iomem);\r\nif (ptr)\r\n*ptr = bo->vmap;\r\nreturn 0;\r\n}\r\nint virtio_gpu_object_get_sg_table(struct virtio_gpu_device *qdev,\r\nstruct virtio_gpu_object *bo)\r\n{\r\nint ret;\r\nstruct page **pages = bo->tbo.ttm->pages;\r\nint nr_pages = bo->tbo.num_pages;\r\nif (bo->pages)\r\nreturn 0;\r\nif (bo->tbo.ttm->state == tt_unpopulated)\r\nbo->tbo.ttm->bdev->driver->ttm_tt_populate(bo->tbo.ttm);\r\nbo->pages = kmalloc(sizeof(struct sg_table), GFP_KERNEL);\r\nif (!bo->pages)\r\ngoto out;\r\nret = sg_alloc_table_from_pages(bo->pages, pages, nr_pages, 0,\r\nnr_pages << PAGE_SHIFT, GFP_KERNEL);\r\nif (ret)\r\ngoto out;\r\nreturn 0;\r\nout:\r\nkfree(bo->pages);\r\nbo->pages = NULL;\r\nreturn -ENOMEM;\r\n}\r\nvoid virtio_gpu_object_free_sg_table(struct virtio_gpu_object *bo)\r\n{\r\nsg_free_table(bo->pages);\r\nkfree(bo->pages);\r\nbo->pages = NULL;\r\n}\r\nint virtio_gpu_object_wait(struct virtio_gpu_object *bo, bool no_wait)\r\n{\r\nint r;\r\nr = ttm_bo_reserve(&bo->tbo, true, no_wait, NULL);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = ttm_bo_wait(&bo->tbo, true, no_wait);\r\nttm_bo_unreserve(&bo->tbo);\r\nreturn r;\r\n}

static void ab8500_power_off(void)\r\n{\r\nsigset_t old;\r\nsigset_t all;\r\nstatic const char * const pss[] = {"ab8500_ac", "pm2301", "ab8500_usb"};\r\nint i;\r\nbool charger_present = false;\r\nunion power_supply_propval val;\r\nstruct power_supply *psy;\r\nint ret;\r\nif (sysctrl_dev == NULL) {\r\npr_err("%s: sysctrl not initialized\n", __func__);\r\nreturn;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pss); i++) {\r\npsy = power_supply_get_by_name(pss[i]);\r\nif (!psy)\r\ncontinue;\r\nret = power_supply_get_property(psy, POWER_SUPPLY_PROP_ONLINE,\r\n&val);\r\npower_supply_put(psy);\r\nif (!ret && val.intval) {\r\ncharger_present = true;\r\nbreak;\r\n}\r\n}\r\nif (!charger_present)\r\ngoto shutdown;\r\npsy = power_supply_get_by_name("ab8500_btemp");\r\nif (psy) {\r\nret = power_supply_get_property(psy,\r\nPOWER_SUPPLY_PROP_TECHNOLOGY, &val);\r\nif (!ret && val.intval != POWER_SUPPLY_TECHNOLOGY_UNKNOWN) {\r\npr_info("Charger '%s' is connected with known battery",\r\npss[i]);\r\npr_info(" - Rebooting.\n");\r\nmachine_restart("charging");\r\n}\r\npower_supply_put(psy);\r\n}\r\nshutdown:\r\nsigfillset(&all);\r\nif (!sigprocmask(SIG_BLOCK, &all, &old)) {\r\n(void)ab8500_sysctrl_set(AB8500_STW4500CTRL1,\r\nAB8500_STW4500CTRL1_SWOFF |\r\nAB8500_STW4500CTRL1_SWRESET4500N);\r\n(void)sigprocmask(SIG_SETMASK, &old, NULL);\r\n}\r\n}\r\nstatic inline bool valid_bank(u8 bank)\r\n{\r\nreturn ((bank == AB8500_SYS_CTRL1_BLOCK) ||\r\n(bank == AB8500_SYS_CTRL2_BLOCK));\r\n}\r\nint ab8500_sysctrl_read(u16 reg, u8 *value)\r\n{\r\nu8 bank;\r\nif (sysctrl_dev == NULL)\r\nreturn -EPROBE_DEFER;\r\nbank = (reg >> 8);\r\nif (!valid_bank(bank))\r\nreturn -EINVAL;\r\nreturn abx500_get_register_interruptible(sysctrl_dev, bank,\r\n(u8)(reg & 0xFF), value);\r\n}\r\nint ab8500_sysctrl_write(u16 reg, u8 mask, u8 value)\r\n{\r\nu8 bank;\r\nif (sysctrl_dev == NULL)\r\nreturn -EPROBE_DEFER;\r\nbank = (reg >> 8);\r\nif (!valid_bank(bank)) {\r\npr_err("invalid bank\n");\r\nreturn -EINVAL;\r\n}\r\nreturn abx500_mask_and_set_register_interruptible(sysctrl_dev, bank,\r\n(u8)(reg & 0xFF), mask, value);\r\n}\r\nstatic int ab8500_sysctrl_probe(struct platform_device *pdev)\r\n{\r\nsysctrl_dev = &pdev->dev;\r\nif (!pm_power_off)\r\npm_power_off = ab8500_power_off;\r\nreturn 0;\r\n}\r\nstatic int ab8500_sysctrl_remove(struct platform_device *pdev)\r\n{\r\nsysctrl_dev = NULL;\r\nif (pm_power_off == ab8500_power_off)\r\npm_power_off = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_sysctrl_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_sysctrl_driver);\r\n}

static inline void mdio_lo(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs+0x10, 1 << MDIO_PIN(bus));\r\n}\r\nstatic inline void mdio_hi(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs, 1 << MDIO_PIN(bus));\r\n}\r\nstatic inline void mdc_lo(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs+0x10, 1 << MDC_PIN(bus));\r\n}\r\nstatic inline void mdc_hi(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs, 1 << MDC_PIN(bus));\r\n}\r\nstatic inline void mdio_active(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs+0x20, (1 << MDC_PIN(bus)) | (1 << MDIO_PIN(bus)));\r\n}\r\nstatic inline void mdio_tristate(struct mii_bus *bus)\r\n{\r\nout_le32(gpio_regs+0x30, (1 << MDIO_PIN(bus)));\r\n}\r\nstatic inline int mdio_read(struct mii_bus *bus)\r\n{\r\nreturn !!(in_le32(gpio_regs+0x40) & (1 << MDIO_PIN(bus)));\r\n}\r\nstatic void clock_out(struct mii_bus *bus, int bit)\r\n{\r\nif (bit)\r\nmdio_hi(bus);\r\nelse\r\nmdio_lo(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nmdc_lo(bus);\r\n}\r\nstatic void bitbang_pre(struct mii_bus *bus, int read, u8 addr, u8 reg)\r\n{\r\nint i;\r\nmdio_active(bus);\r\nfor (i = 0; i < 40; i++) {\r\nclock_out(bus, 1);\r\n}\r\nclock_out(bus, 0);\r\nclock_out(bus, 1);\r\nclock_out(bus, read);\r\nclock_out(bus, !read);\r\nfor (i = 0; i < 5; i++) {\r\nclock_out(bus, (addr & 0x10) != 0);\r\naddr <<= 1;\r\n}\r\nfor (i = 0; i < 5; i++) {\r\nclock_out(bus, (reg & 0x10) != 0);\r\nreg <<= 1;\r\n}\r\n}\r\nstatic int gpio_mdio_read(struct mii_bus *bus, int phy_id, int location)\r\n{\r\nu16 rdreg;\r\nint ret, i;\r\nu8 addr = phy_id & 0xff;\r\nu8 reg = location & 0xff;\r\nbitbang_pre(bus, 1, addr, reg);\r\nmdio_tristate(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nmdc_lo(bus);\r\nrdreg = 0;\r\nfor (i = 0; i < 16; i++) {\r\nmdc_lo(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nmdc_lo(bus);\r\nudelay(DELAY);\r\nrdreg <<= 1;\r\nrdreg |= mdio_read(bus);\r\n}\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nmdc_lo(bus);\r\nudelay(DELAY);\r\nret = rdreg;\r\nreturn ret;\r\n}\r\nstatic int gpio_mdio_write(struct mii_bus *bus, int phy_id, int location, u16 val)\r\n{\r\nint i;\r\nu8 addr = phy_id & 0xff;\r\nu8 reg = location & 0xff;\r\nu16 value = val & 0xffff;\r\nbitbang_pre(bus, 0, addr, reg);\r\nmdc_lo(bus);\r\nmdio_hi(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nmdc_lo(bus);\r\nmdio_lo(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nfor (i = 0; i < 16; i++) {\r\nmdc_lo(bus);\r\nif (value & 0x8000)\r\nmdio_hi(bus);\r\nelse\r\nmdio_lo(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nvalue <<= 1;\r\n}\r\nmdio_tristate(bus);\r\nmdc_lo(bus);\r\nudelay(DELAY);\r\nmdc_hi(bus);\r\nudelay(DELAY);\r\nreturn 0;\r\n}\r\nstatic int gpio_mdio_reset(struct mii_bus *bus)\r\n{\r\nreturn 0;\r\n}\r\nstatic int gpio_mdio_probe(struct platform_device *ofdev)\r\n{\r\nstruct device *dev = &ofdev->dev;\r\nstruct device_node *np = ofdev->dev.of_node;\r\nstruct mii_bus *new_bus;\r\nstruct gpio_priv *priv;\r\nconst unsigned int *prop;\r\nint err;\r\nerr = -ENOMEM;\r\npriv = kzalloc(sizeof(struct gpio_priv), GFP_KERNEL);\r\nif (!priv)\r\ngoto out;\r\nnew_bus = mdiobus_alloc();\r\nif (!new_bus)\r\ngoto out_free_priv;\r\nnew_bus->name = "pasemi gpio mdio bus";\r\nnew_bus->read = &gpio_mdio_read;\r\nnew_bus->write = &gpio_mdio_write;\r\nnew_bus->reset = &gpio_mdio_reset;\r\nprop = of_get_property(np, "reg", NULL);\r\nsnprintf(new_bus->id, MII_BUS_ID_SIZE, "%x", *prop);\r\nnew_bus->priv = priv;\r\nprop = of_get_property(np, "mdc-pin", NULL);\r\npriv->mdc_pin = *prop;\r\nprop = of_get_property(np, "mdio-pin", NULL);\r\npriv->mdio_pin = *prop;\r\nnew_bus->parent = dev;\r\ndev_set_drvdata(dev, new_bus);\r\nerr = of_mdiobus_register(new_bus, np);\r\nif (err != 0) {\r\nprintk(KERN_ERR "%s: Cannot register as MDIO bus, err %d\n",\r\nnew_bus->name, err);\r\ngoto out_free_irq;\r\n}\r\nreturn 0;\r\nout_free_irq:\r\nkfree(new_bus);\r\nout_free_priv:\r\nkfree(priv);\r\nout:\r\nreturn err;\r\n}\r\nstatic int gpio_mdio_remove(struct platform_device *dev)\r\n{\r\nstruct mii_bus *bus = dev_get_drvdata(&dev->dev);\r\nmdiobus_unregister(bus);\r\ndev_set_drvdata(&dev->dev, NULL);\r\nkfree(bus->priv);\r\nbus->priv = NULL;\r\nmdiobus_free(bus);\r\nreturn 0;\r\n}\r\nstatic int gpio_mdio_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "1682m-gpio");\r\nif (!np)\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"pasemi,pwrficient-gpio");\r\nif (!np)\r\nreturn -ENODEV;\r\ngpio_regs = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!gpio_regs)\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&gpio_mdio_driver);\r\n}\r\nstatic void gpio_mdio_exit(void)\r\n{\r\nplatform_driver_unregister(&gpio_mdio_driver);\r\nif (gpio_regs)\r\niounmap(gpio_regs);\r\n}

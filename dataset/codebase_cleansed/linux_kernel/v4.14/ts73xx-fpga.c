static enum fpga_mgr_states ts73xx_fpga_state(struct fpga_manager *mgr)\r\n{\r\nreturn FPGA_MGR_STATE_UNKNOWN;\r\n}\r\nstatic int ts73xx_fpga_write_init(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ts73xx_fpga_priv *priv = mgr->priv;\r\nwriteb(0, priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nudelay(TS73XX_FPGA_RESET_LOW_DELAY);\r\nwriteb(TS73XX_FPGA_RESET, priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nudelay(TS73XX_FPGA_RESET_HIGH_DELAY);\r\nreturn 0;\r\n}\r\nstatic int ts73xx_fpga_write(struct fpga_manager *mgr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct ts73xx_fpga_priv *priv = mgr->priv;\r\nsize_t i = 0;\r\nint ret;\r\nu8 reg;\r\nwhile (count--) {\r\nret = readb_poll_timeout(priv->io_base + TS73XX_FPGA_CONFIG_REG,\r\nreg, !(reg & TS73XX_FPGA_WRITE_DONE),\r\n1, TS73XX_FPGA_WRITE_DONE_TIMEOUT);\r\nif (ret < 0)\r\nreturn ret;\r\nwriteb(buf[i], priv->io_base + TS73XX_FPGA_DATA_REG);\r\ni++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ts73xx_fpga_write_complete(struct fpga_manager *mgr,\r\nstruct fpga_image_info *info)\r\n{\r\nstruct ts73xx_fpga_priv *priv = mgr->priv;\r\nu8 reg;\r\nusleep_range(1000, 2000);\r\nreg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nreg |= TS73XX_FPGA_CONFIG_LOAD;\r\nwriteb(reg, priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nusleep_range(1000, 2000);\r\nreg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nreg &= ~TS73XX_FPGA_CONFIG_LOAD;\r\nwriteb(reg, priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nreg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\r\nif ((reg & TS73XX_FPGA_LOAD_OK) != TS73XX_FPGA_LOAD_OK)\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nstatic int ts73xx_fpga_probe(struct platform_device *pdev)\r\n{\r\nstruct device *kdev = &pdev->dev;\r\nstruct ts73xx_fpga_priv *priv;\r\nstruct resource *res;\r\npriv = devm_kzalloc(kdev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->dev = kdev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->io_base = devm_ioremap_resource(kdev, res);\r\nif (IS_ERR(priv->io_base)) {\r\ndev_err(kdev, "unable to remap registers\n");\r\nreturn PTR_ERR(priv->io_base);\r\n}\r\nreturn fpga_mgr_register(kdev, "TS-73xx FPGA Manager",\r\n&ts73xx_fpga_ops, priv);\r\n}\r\nstatic int ts73xx_fpga_remove(struct platform_device *pdev)\r\n{\r\nfpga_mgr_unregister(&pdev->dev);\r\nreturn 0;\r\n}

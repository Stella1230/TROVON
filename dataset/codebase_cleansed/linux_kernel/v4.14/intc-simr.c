static inline unsigned int irq2ebit(unsigned int irq)\r\n{\r\nreturn irqebitmap[irq - EINT0];\r\n}\r\nstatic inline unsigned int irq2ebit(unsigned int irq)\r\n{\r\nreturn irq - EINT0;\r\n}\r\nstatic void intc_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - MCFINT_VECBASE;\r\nif (MCFINTC2_SIMR && (irq > 128))\r\n__raw_writeb(irq - 128, MCFINTC2_SIMR);\r\nelse if (MCFINTC1_SIMR && (irq > 64))\r\n__raw_writeb(irq - 64, MCFINTC1_SIMR);\r\nelse\r\n__raw_writeb(irq, MCFINTC0_SIMR);\r\n}\r\nstatic void intc_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - MCFINT_VECBASE;\r\nif (MCFINTC2_CIMR && (irq > 128))\r\n__raw_writeb(irq - 128, MCFINTC2_CIMR);\r\nelse if (MCFINTC1_CIMR && (irq > 64))\r\n__raw_writeb(irq - 64, MCFINTC1_CIMR);\r\nelse\r\n__raw_writeb(irq, MCFINTC0_CIMR);\r\n}\r\nstatic void intc_irq_ack(struct irq_data *d)\r\n{\r\nunsigned int ebit = irq2ebit(d->irq);\r\n__raw_writeb(0x1 << ebit, MCFEPORT_EPFR);\r\n}\r\nstatic unsigned int intc_irq_startup(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif ((irq >= EINT1) && (irq <= EINT7)) {\r\nunsigned int ebit = irq2ebit(irq);\r\nu8 v;\r\n#if defined(MCFEPORT_EPDDR)\r\nv = __raw_readb(MCFEPORT_EPDDR);\r\n__raw_writeb(v & ~(0x1 << ebit), MCFEPORT_EPDDR);\r\n#endif\r\nv = __raw_readb(MCFEPORT_EPIER);\r\n__raw_writeb(v | (0x1 << ebit), MCFEPORT_EPIER);\r\n}\r\nirq -= MCFINT_VECBASE;\r\nif (MCFINTC2_ICR0 && (irq > 128))\r\n__raw_writeb(5, MCFINTC2_ICR0 + irq - 128);\r\nelse if (MCFINTC1_ICR0 && (irq > 64))\r\n__raw_writeb(5, MCFINTC1_ICR0 + irq - 64);\r\nelse\r\n__raw_writeb(5, MCFINTC0_ICR0 + irq);\r\nintc_irq_unmask(d);\r\nreturn 0;\r\n}\r\nstatic int intc_irq_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nunsigned int ebit, irq = d->irq;\r\nu16 pa, tb;\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\ntb = 0x1;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\ntb = 0x2;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\ntb = 0x3;\r\nbreak;\r\ndefault:\r\ntb = 0;\r\nbreak;\r\n}\r\nif (tb)\r\nirq_set_handler(irq, handle_edge_irq);\r\nebit = irq2ebit(irq) * 2;\r\npa = __raw_readw(MCFEPORT_EPPAR);\r\npa = (pa & ~(0x3 << ebit)) | (tb << ebit);\r\n__raw_writew(pa, MCFEPORT_EPPAR);\r\nreturn 0;\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint irq, eirq;\r\n__raw_writeb(0xff, MCFINTC0_SIMR);\r\nif (MCFINTC1_SIMR)\r\n__raw_writeb(0xff, MCFINTC1_SIMR);\r\nif (MCFINTC2_SIMR)\r\n__raw_writeb(0xff, MCFINTC2_SIMR);\r\neirq = MCFINT_VECBASE + 64 + (MCFINTC1_ICR0 ? 64 : 0) +\r\n(MCFINTC2_ICR0 ? 64 : 0);\r\nfor (irq = MCFINT_VECBASE; (irq < eirq); irq++) {\r\nif ((irq >= EINT1) && (irq <= EINT7))\r\nirq_set_chip(irq, &intc_irq_chip_edge_port);\r\nelse\r\nirq_set_chip(irq, &intc_irq_chip);\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_handler(irq, handle_level_irq);\r\n}\r\n}

static int __led_set_brightness(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nif (!led_cdev->brightness_set)\r\nreturn -ENOTSUPP;\r\nled_cdev->brightness_set(led_cdev, value);\r\nreturn 0;\r\n}\r\nstatic int __led_set_brightness_blocking(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nif (!led_cdev->brightness_set_blocking)\r\nreturn -ENOTSUPP;\r\nreturn led_cdev->brightness_set_blocking(led_cdev, value);\r\n}\r\nstatic void led_timer_function(unsigned long data)\r\n{\r\nstruct led_classdev *led_cdev = (void *)data;\r\nunsigned long brightness;\r\nunsigned long delay;\r\nif (!led_cdev->blink_delay_on || !led_cdev->blink_delay_off) {\r\nled_set_brightness_nosleep(led_cdev, LED_OFF);\r\nclear_bit(LED_BLINK_SW, &led_cdev->work_flags);\r\nreturn;\r\n}\r\nif (test_and_clear_bit(LED_BLINK_ONESHOT_STOP,\r\n&led_cdev->work_flags)) {\r\nclear_bit(LED_BLINK_SW, &led_cdev->work_flags);\r\nreturn;\r\n}\r\nbrightness = led_get_brightness(led_cdev);\r\nif (!brightness) {\r\nif (test_and_clear_bit(LED_BLINK_BRIGHTNESS_CHANGE,\r\n&led_cdev->work_flags))\r\nbrightness = led_cdev->new_blink_brightness;\r\nelse\r\nbrightness = led_cdev->blink_brightness;\r\ndelay = led_cdev->blink_delay_on;\r\n} else {\r\nled_cdev->blink_brightness = brightness;\r\nbrightness = LED_OFF;\r\ndelay = led_cdev->blink_delay_off;\r\n}\r\nled_set_brightness_nosleep(led_cdev, brightness);\r\nif (test_bit(LED_BLINK_ONESHOT, &led_cdev->work_flags)) {\r\nif (test_bit(LED_BLINK_INVERT, &led_cdev->work_flags)) {\r\nif (brightness)\r\nset_bit(LED_BLINK_ONESHOT_STOP,\r\n&led_cdev->work_flags);\r\n} else {\r\nif (!brightness)\r\nset_bit(LED_BLINK_ONESHOT_STOP,\r\n&led_cdev->work_flags);\r\n}\r\n}\r\nmod_timer(&led_cdev->blink_timer, jiffies + msecs_to_jiffies(delay));\r\n}\r\nstatic void set_brightness_delayed(struct work_struct *ws)\r\n{\r\nstruct led_classdev *led_cdev =\r\ncontainer_of(ws, struct led_classdev, set_brightness_work);\r\nint ret = 0;\r\nif (test_and_clear_bit(LED_BLINK_DISABLE, &led_cdev->work_flags)) {\r\nled_cdev->delayed_set_value = LED_OFF;\r\nled_stop_software_blink(led_cdev);\r\n}\r\nret = __led_set_brightness(led_cdev, led_cdev->delayed_set_value);\r\nif (ret == -ENOTSUPP)\r\nret = __led_set_brightness_blocking(led_cdev,\r\nled_cdev->delayed_set_value);\r\nif (ret < 0 &&\r\n!(ret == -ENODEV && (led_cdev->flags & LED_UNREGISTERING) &&\r\n(led_cdev->flags & LED_HW_PLUGGABLE)))\r\ndev_err(led_cdev->dev,\r\n"Setting an LED's brightness failed (%d)\n", ret);\r\n}\r\nstatic void led_set_software_blink(struct led_classdev *led_cdev,\r\nunsigned long delay_on,\r\nunsigned long delay_off)\r\n{\r\nint current_brightness;\r\ncurrent_brightness = led_get_brightness(led_cdev);\r\nif (current_brightness)\r\nled_cdev->blink_brightness = current_brightness;\r\nif (!led_cdev->blink_brightness)\r\nled_cdev->blink_brightness = led_cdev->max_brightness;\r\nled_cdev->blink_delay_on = delay_on;\r\nled_cdev->blink_delay_off = delay_off;\r\nif (!delay_on) {\r\nled_set_brightness_nosleep(led_cdev, LED_OFF);\r\nreturn;\r\n}\r\nif (!delay_off) {\r\nled_set_brightness_nosleep(led_cdev,\r\nled_cdev->blink_brightness);\r\nreturn;\r\n}\r\nset_bit(LED_BLINK_SW, &led_cdev->work_flags);\r\nmod_timer(&led_cdev->blink_timer, jiffies + 1);\r\n}\r\nstatic void led_blink_setup(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nif (!test_bit(LED_BLINK_ONESHOT, &led_cdev->work_flags) &&\r\nled_cdev->blink_set &&\r\n!led_cdev->blink_set(led_cdev, delay_on, delay_off))\r\nreturn;\r\nif (!*delay_on && !*delay_off)\r\n*delay_on = *delay_off = 500;\r\nled_set_software_blink(led_cdev, *delay_on, *delay_off);\r\n}\r\nvoid led_init_core(struct led_classdev *led_cdev)\r\n{\r\nINIT_WORK(&led_cdev->set_brightness_work, set_brightness_delayed);\r\nsetup_timer(&led_cdev->blink_timer, led_timer_function,\r\n(unsigned long)led_cdev);\r\n}\r\nvoid led_blink_set(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\ndel_timer_sync(&led_cdev->blink_timer);\r\nclear_bit(LED_BLINK_ONESHOT, &led_cdev->work_flags);\r\nclear_bit(LED_BLINK_ONESHOT_STOP, &led_cdev->work_flags);\r\nled_blink_setup(led_cdev, delay_on, delay_off);\r\n}\r\nvoid led_blink_set_oneshot(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off,\r\nint invert)\r\n{\r\nif (test_bit(LED_BLINK_ONESHOT, &led_cdev->work_flags) &&\r\ntimer_pending(&led_cdev->blink_timer))\r\nreturn;\r\nset_bit(LED_BLINK_ONESHOT, &led_cdev->work_flags);\r\nclear_bit(LED_BLINK_ONESHOT_STOP, &led_cdev->work_flags);\r\nif (invert)\r\nset_bit(LED_BLINK_INVERT, &led_cdev->work_flags);\r\nelse\r\nclear_bit(LED_BLINK_INVERT, &led_cdev->work_flags);\r\nled_blink_setup(led_cdev, delay_on, delay_off);\r\n}\r\nvoid led_stop_software_blink(struct led_classdev *led_cdev)\r\n{\r\ndel_timer_sync(&led_cdev->blink_timer);\r\nled_cdev->blink_delay_on = 0;\r\nled_cdev->blink_delay_off = 0;\r\nclear_bit(LED_BLINK_SW, &led_cdev->work_flags);\r\n}\r\nvoid led_set_brightness(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nif (test_bit(LED_BLINK_SW, &led_cdev->work_flags)) {\r\nif (brightness == LED_OFF) {\r\nset_bit(LED_BLINK_DISABLE, &led_cdev->work_flags);\r\nschedule_work(&led_cdev->set_brightness_work);\r\n} else {\r\nset_bit(LED_BLINK_BRIGHTNESS_CHANGE,\r\n&led_cdev->work_flags);\r\nled_cdev->new_blink_brightness = brightness;\r\n}\r\nreturn;\r\n}\r\nled_set_brightness_nosleep(led_cdev, brightness);\r\n}\r\nvoid led_set_brightness_nopm(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nif (!__led_set_brightness(led_cdev, value))\r\nreturn;\r\nled_cdev->delayed_set_value = value;\r\nschedule_work(&led_cdev->set_brightness_work);\r\n}\r\nvoid led_set_brightness_nosleep(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nled_cdev->brightness = min(value, led_cdev->max_brightness);\r\nif (led_cdev->flags & LED_SUSPENDED)\r\nreturn;\r\nled_set_brightness_nopm(led_cdev, led_cdev->brightness);\r\n}\r\nint led_set_brightness_sync(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nif (led_cdev->blink_delay_on || led_cdev->blink_delay_off)\r\nreturn -EBUSY;\r\nled_cdev->brightness = min(value, led_cdev->max_brightness);\r\nif (led_cdev->flags & LED_SUSPENDED)\r\nreturn 0;\r\nreturn __led_set_brightness_blocking(led_cdev, led_cdev->brightness);\r\n}\r\nint led_update_brightness(struct led_classdev *led_cdev)\r\n{\r\nint ret = 0;\r\nif (led_cdev->brightness_get) {\r\nret = led_cdev->brightness_get(led_cdev);\r\nif (ret >= 0) {\r\nled_cdev->brightness = ret;\r\nreturn 0;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nvoid led_sysfs_disable(struct led_classdev *led_cdev)\r\n{\r\nlockdep_assert_held(&led_cdev->led_access);\r\nled_cdev->flags |= LED_SYSFS_DISABLE;\r\n}\r\nvoid led_sysfs_enable(struct led_classdev *led_cdev)\r\n{\r\nlockdep_assert_held(&led_cdev->led_access);\r\nled_cdev->flags &= ~LED_SYSFS_DISABLE;\r\n}

static int tenxpress_init(struct ef4_nic *efx)\r\n{\r\nef4_mdio_write(efx, MDIO_MMD_PCS, PCS_TEST_SELECT_REG,\r\n1 << CLK312_EN_LBN);\r\nef4_mdio_set_flag(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_CTRL_REG,\r\n1 << PMA_PMA_LED_ACTIVITY_LBN, true);\r\nef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_OVERR_REG,\r\nSFX7101_PMA_PMD_LED_DEFAULT);\r\nreturn 0;\r\n}\r\nstatic int tenxpress_phy_probe(struct ef4_nic *efx)\r\n{\r\nstruct tenxpress_phy_data *phy_data;\r\nphy_data = kzalloc(sizeof(*phy_data), GFP_KERNEL);\r\nif (!phy_data)\r\nreturn -ENOMEM;\r\nefx->phy_data = phy_data;\r\nphy_data->phy_mode = efx->phy_mode;\r\nefx->mdio.mmds = TENXPRESS_REQUIRED_DEVS;\r\nefx->mdio.mode_support = MDIO_SUPPORTS_C45;\r\nefx->loopback_modes = SFX7101_LOOPBACKS | FALCON_XMAC_LOOPBACKS;\r\nefx->link_advertising = (ADVERTISED_TP | ADVERTISED_Autoneg |\r\nADVERTISED_10000baseT_Full);\r\nreturn 0;\r\n}\r\nstatic int tenxpress_phy_init(struct ef4_nic *efx)\r\n{\r\nint rc;\r\nfalcon_board(efx)->type->init_phy(efx);\r\nif (!(efx->phy_mode & PHY_MODE_SPECIAL)) {\r\nrc = ef4_mdio_wait_reset_mmds(efx, TENXPRESS_REQUIRED_DEVS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = ef4_mdio_check_mmds(efx, TENXPRESS_REQUIRED_DEVS);\r\nif (rc < 0)\r\nreturn rc;\r\n}\r\nrc = tenxpress_init(efx);\r\nif (rc < 0)\r\nreturn rc;\r\nef4_link_set_wanted_fc(efx, efx->wanted_fc);\r\nef4_mdio_an_reconfigure(efx);\r\nschedule_timeout_uninterruptible(HZ / 5);\r\nfalcon_reset_xaui(efx);\r\nreturn 0;\r\n}\r\nstatic int tenxpress_special_reset(struct ef4_nic *efx)\r\n{\r\nint rc, reg;\r\nfalcon_stop_nic_stats(efx);\r\nreg = ef4_mdio_read(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG);\r\nreg |= (1 << PMA_PMD_EXT_SSR_LBN);\r\nef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG, reg);\r\nmdelay(200);\r\nrc = ef4_mdio_wait_reset_mmds(efx, TENXPRESS_REQUIRED_DEVS);\r\nif (rc < 0)\r\ngoto out;\r\nrc = tenxpress_init(efx);\r\nif (rc < 0)\r\ngoto out;\r\nmdelay(10);\r\nout:\r\nfalcon_start_nic_stats(efx);\r\nreturn rc;\r\n}\r\nstatic void sfx7101_check_bad_lp(struct ef4_nic *efx, bool link_ok)\r\n{\r\nstruct tenxpress_phy_data *pd = efx->phy_data;\r\nbool bad_lp;\r\nint reg;\r\nif (link_ok) {\r\nbad_lp = false;\r\n} else {\r\nreg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_STAT1);\r\nif (!(reg & MDIO_AN_STAT1_LPABLE))\r\nreturn;\r\nbad_lp = !(reg & MDIO_AN_STAT1_COMPLETE);\r\nif (bad_lp)\r\npd->bad_lp_tries++;\r\n}\r\nif (!pd->bad_lp_tries)\r\nreturn;\r\nif (!bad_lp || pd->bad_lp_tries == MAX_BAD_LP_TRIES) {\r\nreg = ef4_mdio_read(efx, MDIO_MMD_PMAPMD,\r\nPMA_PMD_LED_OVERR_REG);\r\nreg &= ~(PMA_PMD_LED_MASK << PMA_PMD_LED_RX_LBN);\r\nif (!bad_lp) {\r\nreg |= PMA_PMD_LED_OFF << PMA_PMD_LED_RX_LBN;\r\n} else {\r\nreg |= PMA_PMD_LED_FLASH << PMA_PMD_LED_RX_LBN;\r\nnetif_err(efx, link, efx->net_dev,\r\n"appears to be plugged into a port"\r\n" that is not 10GBASE-T capable. The PHY"\r\n" supports 10GBASE-T ONLY, so no link can"\r\n" be established\n");\r\n}\r\nef4_mdio_write(efx, MDIO_MMD_PMAPMD,\r\nPMA_PMD_LED_OVERR_REG, reg);\r\npd->bad_lp_tries = bad_lp;\r\n}\r\n}\r\nstatic bool sfx7101_link_ok(struct ef4_nic *efx)\r\n{\r\nreturn ef4_mdio_links_ok(efx,\r\nMDIO_DEVS_PMAPMD |\r\nMDIO_DEVS_PCS |\r\nMDIO_DEVS_PHYXS);\r\n}\r\nstatic void tenxpress_ext_loopback(struct ef4_nic *efx)\r\n{\r\nef4_mdio_set_flag(efx, MDIO_MMD_PHYXS, PHYXS_TEST1,\r\n1 << LOOPBACK_NEAR_LBN,\r\nefx->loopback_mode == LOOPBACK_PHYXS);\r\n}\r\nstatic void tenxpress_low_power(struct ef4_nic *efx)\r\n{\r\nef4_mdio_set_mmds_lpower(\r\nefx, !!(efx->phy_mode & PHY_MODE_LOW_POWER),\r\nTENXPRESS_REQUIRED_DEVS);\r\n}\r\nstatic int tenxpress_phy_reconfigure(struct ef4_nic *efx)\r\n{\r\nstruct tenxpress_phy_data *phy_data = efx->phy_data;\r\nbool phy_mode_change, loop_reset;\r\nif (efx->phy_mode & (PHY_MODE_OFF | PHY_MODE_SPECIAL)) {\r\nphy_data->phy_mode = efx->phy_mode;\r\nreturn 0;\r\n}\r\nphy_mode_change = (efx->phy_mode == PHY_MODE_NORMAL &&\r\nphy_data->phy_mode != PHY_MODE_NORMAL);\r\nloop_reset = (LOOPBACK_OUT_OF(phy_data, efx, LOOPBACKS_EXTERNAL(efx)) ||\r\nLOOPBACK_CHANGED(phy_data, efx, 1 << LOOPBACK_GPHY));\r\nif (loop_reset || phy_mode_change) {\r\ntenxpress_special_reset(efx);\r\nfalcon_reset_xaui(efx);\r\n}\r\ntenxpress_low_power(efx);\r\nef4_mdio_transmit_disable(efx);\r\nef4_mdio_phy_reconfigure(efx);\r\ntenxpress_ext_loopback(efx);\r\nef4_mdio_an_reconfigure(efx);\r\nphy_data->loopback_mode = efx->loopback_mode;\r\nphy_data->phy_mode = efx->phy_mode;\r\nreturn 0;\r\n}\r\nstatic bool tenxpress_phy_poll(struct ef4_nic *efx)\r\n{\r\nstruct ef4_link_state old_state = efx->link_state;\r\nefx->link_state.up = sfx7101_link_ok(efx);\r\nefx->link_state.speed = 10000;\r\nefx->link_state.fd = true;\r\nefx->link_state.fc = ef4_mdio_get_pause(efx);\r\nsfx7101_check_bad_lp(efx, efx->link_state.up);\r\nreturn !ef4_link_state_equal(&efx->link_state, &old_state);\r\n}\r\nstatic void sfx7101_phy_fini(struct ef4_nic *efx)\r\n{\r\nint reg;\r\nreg = (1 << PMA_PMD_LNPGA_POWERDOWN_LBN);\r\nef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG, reg);\r\nschedule_timeout_uninterruptible(LNPGA_PDOWN_WAIT);\r\n}\r\nstatic void tenxpress_phy_remove(struct ef4_nic *efx)\r\n{\r\nkfree(efx->phy_data);\r\nefx->phy_data = NULL;\r\n}\r\nvoid tenxpress_set_id_led(struct ef4_nic *efx, enum ef4_led_mode mode)\r\n{\r\nint reg;\r\nswitch (mode) {\r\ncase EF4_LED_OFF:\r\nreg = (PMA_PMD_LED_OFF << PMA_PMD_LED_TX_LBN) |\r\n(PMA_PMD_LED_OFF << PMA_PMD_LED_RX_LBN) |\r\n(PMA_PMD_LED_OFF << PMA_PMD_LED_LINK_LBN);\r\nbreak;\r\ncase EF4_LED_ON:\r\nreg = (PMA_PMD_LED_ON << PMA_PMD_LED_TX_LBN) |\r\n(PMA_PMD_LED_ON << PMA_PMD_LED_RX_LBN) |\r\n(PMA_PMD_LED_ON << PMA_PMD_LED_LINK_LBN);\r\nbreak;\r\ndefault:\r\nreg = SFX7101_PMA_PMD_LED_DEFAULT;\r\nbreak;\r\n}\r\nef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_OVERR_REG, reg);\r\n}\r\nstatic const char *sfx7101_test_name(struct ef4_nic *efx, unsigned int index)\r\n{\r\nif (index < ARRAY_SIZE(sfx7101_test_names))\r\nreturn sfx7101_test_names[index];\r\nreturn NULL;\r\n}\r\nstatic int\r\nsfx7101_run_tests(struct ef4_nic *efx, int *results, unsigned flags)\r\n{\r\nint rc;\r\nif (!(flags & ETH_TEST_FL_OFFLINE))\r\nreturn 0;\r\nrc = tenxpress_special_reset(efx);\r\nresults[0] = rc ? -1 : 1;\r\nef4_mdio_an_reconfigure(efx);\r\nreturn rc;\r\n}\r\nstatic void\r\ntenxpress_get_link_ksettings(struct ef4_nic *efx,\r\nstruct ethtool_link_ksettings *cmd)\r\n{\r\nu32 adv = 0, lpa = 0;\r\nint reg;\r\nreg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL);\r\nif (reg & MDIO_AN_10GBT_CTRL_ADV10G)\r\nadv |= ADVERTISED_10000baseT_Full;\r\nreg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_AN_10GBT_STAT);\r\nif (reg & MDIO_AN_10GBT_STAT_LP10G)\r\nlpa |= ADVERTISED_10000baseT_Full;\r\nmdio45_ethtool_ksettings_get_npage(&efx->mdio, cmd, adv, lpa);\r\nif (LOOPBACK_EXTERNAL(efx))\r\ncmd->base.speed = SPEED_10000;\r\n}\r\nstatic int\r\ntenxpress_set_link_ksettings(struct ef4_nic *efx,\r\nconst struct ethtool_link_ksettings *cmd)\r\n{\r\nif (!cmd->base.autoneg)\r\nreturn -EINVAL;\r\nreturn ef4_mdio_set_link_ksettings(efx, cmd);\r\n}\r\nstatic void sfx7101_set_npage_adv(struct ef4_nic *efx, u32 advertising)\r\n{\r\nef4_mdio_set_flag(efx, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\r\nMDIO_AN_10GBT_CTRL_ADV10G,\r\nadvertising & ADVERTISED_10000baseT_Full);\r\n}

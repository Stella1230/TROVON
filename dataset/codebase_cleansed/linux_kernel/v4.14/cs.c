static int is_valid_cs(unsigned int cs)\r\n{\r\nif (cs > 6)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint bcm63xx_set_cs_base(unsigned int cs, u32 base, unsigned int size)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (!is_valid_cs(cs))\r\nreturn -EINVAL;\r\nif (size != roundup_pow_of_two(size))\r\nreturn -EINVAL;\r\nif (size < 8 * 1024 || size > 256 * 1024 * 1024)\r\nreturn -EINVAL;\r\nval = (base & MPI_CSBASE_BASE_MASK);\r\nval |= (ilog2(size) - ilog2(8 * 1024)) << MPI_CSBASE_SIZE_SHIFT;\r\nspin_lock_irqsave(&bcm63xx_cs_lock, flags);\r\nbcm_mpi_writel(val, MPI_CSBASE_REG(cs));\r\nspin_unlock_irqrestore(&bcm63xx_cs_lock, flags);\r\nreturn 0;\r\n}\r\nint bcm63xx_set_cs_timing(unsigned int cs, unsigned int wait,\r\nunsigned int setup, unsigned int hold)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (!is_valid_cs(cs))\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&bcm63xx_cs_lock, flags);\r\nval = bcm_mpi_readl(MPI_CSCTL_REG(cs));\r\nval &= ~(MPI_CSCTL_WAIT_MASK);\r\nval &= ~(MPI_CSCTL_SETUP_MASK);\r\nval &= ~(MPI_CSCTL_HOLD_MASK);\r\nval |= wait << MPI_CSCTL_WAIT_SHIFT;\r\nval |= setup << MPI_CSCTL_SETUP_SHIFT;\r\nval |= hold << MPI_CSCTL_HOLD_SHIFT;\r\nbcm_mpi_writel(val, MPI_CSCTL_REG(cs));\r\nspin_unlock_irqrestore(&bcm63xx_cs_lock, flags);\r\nreturn 0;\r\n}\r\nint bcm63xx_set_cs_param(unsigned int cs, u32 params)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (!is_valid_cs(cs))\r\nreturn -EINVAL;\r\nif (cs == MPI_CS_PCMCIA_COMMON ||\r\ncs == MPI_CS_PCMCIA_ATTR ||\r\ncs == MPI_CS_PCMCIA_IO)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&bcm63xx_cs_lock, flags);\r\nval = bcm_mpi_readl(MPI_CSCTL_REG(cs));\r\nval &= ~(MPI_CSCTL_DATA16_MASK);\r\nval &= ~(MPI_CSCTL_SYNCMODE_MASK);\r\nval &= ~(MPI_CSCTL_TSIZE_MASK);\r\nval &= ~(MPI_CSCTL_ENDIANSWAP_MASK);\r\nval |= params;\r\nbcm_mpi_writel(val, MPI_CSCTL_REG(cs));\r\nspin_unlock_irqrestore(&bcm63xx_cs_lock, flags);\r\nreturn 0;\r\n}\r\nint bcm63xx_set_cs_status(unsigned int cs, int enable)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (!is_valid_cs(cs))\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&bcm63xx_cs_lock, flags);\r\nval = bcm_mpi_readl(MPI_CSCTL_REG(cs));\r\nif (enable)\r\nval |= MPI_CSCTL_ENABLE_MASK;\r\nelse\r\nval &= ~MPI_CSCTL_ENABLE_MASK;\r\nbcm_mpi_writel(val, MPI_CSCTL_REG(cs));\r\nspin_unlock_irqrestore(&bcm63xx_cs_lock, flags);\r\nreturn 0;\r\n}

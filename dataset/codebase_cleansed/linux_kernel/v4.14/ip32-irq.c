static inline void flush_crime_bus(void)\r\n{\r\ncrime->control;\r\n}\r\nstatic inline void flush_mace_bus(void)\r\n{\r\nmace->perif.ctrl.misc;\r\n}\r\nstatic inline void crime_enable_irq(struct irq_data *d)\r\n{\r\nunsigned int bit = d->irq - CRIME_IRQ_BASE;\r\ncrime_mask |= 1 << bit;\r\ncrime->imask = crime_mask;\r\n}\r\nstatic inline void crime_disable_irq(struct irq_data *d)\r\n{\r\nunsigned int bit = d->irq - CRIME_IRQ_BASE;\r\ncrime_mask &= ~(1 << bit);\r\ncrime->imask = crime_mask;\r\nflush_crime_bus();\r\n}\r\nstatic void crime_edge_mask_and_ack_irq(struct irq_data *d)\r\n{\r\nunsigned int bit = d->irq - CRIME_IRQ_BASE;\r\nuint64_t crime_int;\r\ncrime_int = crime->hard_int;\r\ncrime_int &= ~(1 << bit);\r\ncrime->hard_int = crime_int;\r\ncrime_disable_irq(d);\r\n}\r\nstatic void enable_macepci_irq(struct irq_data *d)\r\n{\r\nmacepci_mask |= MACEPCI_CONTROL_INT(d->irq - MACEPCI_SCSI0_IRQ);\r\nmace->pci.control = macepci_mask;\r\ncrime_mask |= 1 << (d->irq - CRIME_IRQ_BASE);\r\ncrime->imask = crime_mask;\r\n}\r\nstatic void disable_macepci_irq(struct irq_data *d)\r\n{\r\ncrime_mask &= ~(1 << (d->irq - CRIME_IRQ_BASE));\r\ncrime->imask = crime_mask;\r\nflush_crime_bus();\r\nmacepci_mask &= ~MACEPCI_CONTROL_INT(d->irq - MACEPCI_SCSI0_IRQ);\r\nmace->pci.control = macepci_mask;\r\nflush_mace_bus();\r\n}\r\nstatic void enable_maceisa_irq(struct irq_data *d)\r\n{\r\nunsigned int crime_int = 0;\r\npr_debug("maceisa enable: %u\n", d->irq);\r\nswitch (d->irq) {\r\ncase MACEISA_AUDIO_SW_IRQ ... MACEISA_AUDIO3_MERR_IRQ:\r\ncrime_int = MACE_AUDIO_INT;\r\nbreak;\r\ncase MACEISA_RTC_IRQ ... MACEISA_TIMER2_IRQ:\r\ncrime_int = MACE_MISC_INT;\r\nbreak;\r\ncase MACEISA_PARALLEL_IRQ ... MACEISA_SERIAL2_RDMAOR_IRQ:\r\ncrime_int = MACE_SUPERIO_INT;\r\nbreak;\r\n}\r\npr_debug("crime_int %08x enabled\n", crime_int);\r\ncrime_mask |= crime_int;\r\ncrime->imask = crime_mask;\r\nmaceisa_mask |= 1 << (d->irq - MACEISA_AUDIO_SW_IRQ);\r\nmace->perif.ctrl.imask = maceisa_mask;\r\n}\r\nstatic void disable_maceisa_irq(struct irq_data *d)\r\n{\r\nunsigned int crime_int = 0;\r\nmaceisa_mask &= ~(1 << (d->irq - MACEISA_AUDIO_SW_IRQ));\r\nif (!(maceisa_mask & MACEISA_AUDIO_INT))\r\ncrime_int |= MACE_AUDIO_INT;\r\nif (!(maceisa_mask & MACEISA_MISC_INT))\r\ncrime_int |= MACE_MISC_INT;\r\nif (!(maceisa_mask & MACEISA_SUPERIO_INT))\r\ncrime_int |= MACE_SUPERIO_INT;\r\ncrime_mask &= ~crime_int;\r\ncrime->imask = crime_mask;\r\nflush_crime_bus();\r\nmace->perif.ctrl.imask = maceisa_mask;\r\nflush_mace_bus();\r\n}\r\nstatic void mask_and_ack_maceisa_irq(struct irq_data *d)\r\n{\r\nunsigned long mace_int;\r\nmace_int = mace->perif.ctrl.istat;\r\nmace_int &= ~(1 << (d->irq - MACEISA_AUDIO_SW_IRQ));\r\nmace->perif.ctrl.istat = mace_int;\r\ndisable_maceisa_irq(d);\r\n}\r\nstatic void enable_mace_irq(struct irq_data *d)\r\n{\r\nunsigned int bit = d->irq - CRIME_IRQ_BASE;\r\ncrime_mask |= (1 << bit);\r\ncrime->imask = crime_mask;\r\n}\r\nstatic void disable_mace_irq(struct irq_data *d)\r\n{\r\nunsigned int bit = d->irq - CRIME_IRQ_BASE;\r\ncrime_mask &= ~(1 << bit);\r\ncrime->imask = crime_mask;\r\nflush_crime_bus();\r\n}\r\nstatic void ip32_unknown_interrupt(void)\r\n{\r\nprintk("Unknown interrupt occurred!\n");\r\nprintk("cp0_status: %08x\n", read_c0_status());\r\nprintk("cp0_cause: %08x\n", read_c0_cause());\r\nprintk("CRIME intr mask: %016lx\n", crime->imask);\r\nprintk("CRIME intr status: %016lx\n", crime->istat);\r\nprintk("CRIME hardware intr register: %016lx\n", crime->hard_int);\r\nprintk("MACE ISA intr mask: %08lx\n", mace->perif.ctrl.imask);\r\nprintk("MACE ISA intr status: %08lx\n", mace->perif.ctrl.istat);\r\nprintk("MACE PCI control register: %08x\n", mace->pci.control);\r\nprintk("Register dump:\n");\r\nshow_regs(get_irq_regs());\r\nprintk("Please mail this report to linux-mips@linux-mips.org\n");\r\nprintk("Spinning...");\r\nwhile(1) ;\r\n}\r\nstatic void ip32_irq0(void)\r\n{\r\nuint64_t crime_int;\r\nint irq = 0;\r\nBUILD_BUG_ON(CRIME_VICE_IRQ - MACE_VID_IN1_IRQ != 31);\r\nBUILD_BUG_ON(MACEISA_SERIAL2_RDMAOR_IRQ - MACEISA_AUDIO_SW_IRQ != 31);\r\ncrime_int = crime->istat & crime_mask;\r\nif (unlikely(crime_int == 0))\r\nreturn;\r\nirq = MACE_VID_IN1_IRQ + __ffs(crime_int);\r\nif (crime_int & CRIME_MACEISA_INT_MASK) {\r\nunsigned long mace_int = mace->perif.ctrl.istat;\r\nirq = __ffs(mace_int & maceisa_mask) + MACEISA_AUDIO_SW_IRQ;\r\n}\r\npr_debug("*irq %u*\n", irq);\r\ndo_IRQ(irq);\r\n}\r\nstatic void ip32_irq1(void)\r\n{\r\nip32_unknown_interrupt();\r\n}\r\nstatic void ip32_irq2(void)\r\n{\r\nip32_unknown_interrupt();\r\n}\r\nstatic void ip32_irq3(void)\r\n{\r\nip32_unknown_interrupt();\r\n}\r\nstatic void ip32_irq4(void)\r\n{\r\nip32_unknown_interrupt();\r\n}\r\nstatic void ip32_irq5(void)\r\n{\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 7);\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned int pending = read_c0_status() & read_c0_cause();\r\nif (likely(pending & IE_IRQ0))\r\nip32_irq0();\r\nelse if (unlikely(pending & IE_IRQ1))\r\nip32_irq1();\r\nelse if (unlikely(pending & IE_IRQ2))\r\nip32_irq2();\r\nelse if (unlikely(pending & IE_IRQ3))\r\nip32_irq3();\r\nelse if (unlikely(pending & IE_IRQ4))\r\nip32_irq4();\r\nelse if (likely(pending & IE_IRQ5))\r\nip32_irq5();\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nunsigned int irq;\r\ncrime->imask = 0;\r\ncrime->hard_int = 0;\r\ncrime->soft_int = 0;\r\nmace->perif.ctrl.istat = 0;\r\nmace->perif.ctrl.imask = 0;\r\nmips_cpu_irq_init();\r\nfor (irq = CRIME_IRQ_BASE; irq <= IP32_IRQ_MAX; irq++) {\r\nswitch (irq) {\r\ncase MACE_VID_IN1_IRQ ... MACE_PCI_BRIDGE_IRQ:\r\nirq_set_chip_and_handler_name(irq,\r\n&ip32_mace_interrupt,\r\nhandle_level_irq,\r\n"level");\r\nbreak;\r\ncase MACEPCI_SCSI0_IRQ ... MACEPCI_SHARED2_IRQ:\r\nirq_set_chip_and_handler_name(irq,\r\n&ip32_macepci_interrupt,\r\nhandle_level_irq,\r\n"level");\r\nbreak;\r\ncase CRIME_CPUERR_IRQ:\r\ncase CRIME_MEMERR_IRQ:\r\nirq_set_chip_and_handler_name(irq,\r\n&crime_level_interrupt,\r\nhandle_level_irq,\r\n"level");\r\nbreak;\r\ncase CRIME_GBE0_IRQ ... CRIME_GBE3_IRQ:\r\ncase CRIME_RE_EMPTY_E_IRQ ... CRIME_RE_IDLE_E_IRQ:\r\ncase CRIME_SOFT0_IRQ ... CRIME_SOFT2_IRQ:\r\ncase CRIME_VICE_IRQ:\r\nirq_set_chip_and_handler_name(irq,\r\n&crime_edge_interrupt,\r\nhandle_edge_irq,\r\n"edge");\r\nbreak;\r\ncase MACEISA_PARALLEL_IRQ:\r\ncase MACEISA_SERIAL1_TDMAPR_IRQ:\r\ncase MACEISA_SERIAL2_TDMAPR_IRQ:\r\nirq_set_chip_and_handler_name(irq,\r\n&ip32_maceisa_edge_interrupt,\r\nhandle_edge_irq,\r\n"edge");\r\nbreak;\r\ndefault:\r\nirq_set_chip_and_handler_name(irq,\r\n&ip32_maceisa_level_interrupt,\r\nhandle_level_irq,\r\n"level");\r\nbreak;\r\n}\r\n}\r\nsetup_irq(CRIME_MEMERR_IRQ, &memerr_irq);\r\nsetup_irq(CRIME_CPUERR_IRQ, &cpuerr_irq);\r\n#define ALLINTS (IE_IRQ0 | IE_IRQ1 | IE_IRQ2 | IE_IRQ3 | IE_IRQ4 | IE_IRQ5)\r\nchange_c0_status(ST0_IM, ALLINTS);\r\n}

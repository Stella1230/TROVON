static ssize_t scanlog_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nunsigned int *data = scanlog_buffer;\r\nint status;\r\nunsigned long len, off;\r\nunsigned int wait_time;\r\nif (count > RTAS_DATA_BUF_SIZE)\r\ncount = RTAS_DATA_BUF_SIZE;\r\nif (count < 1024) {\r\nprintk(KERN_ERR "scanlog: cannot perform a small read (%ld)\n", count);\r\nreturn -EINVAL;\r\n}\r\nif (!access_ok(VERIFY_WRITE, buf, count))\r\nreturn -EFAULT;\r\nfor (;;) {\r\nwait_time = 500;\r\nspin_lock(&rtas_data_buf_lock);\r\nmemcpy(rtas_data_buf, data, RTAS_DATA_BUF_SIZE);\r\nstatus = rtas_call(ibm_scan_log_dump, 2, 1, NULL,\r\n(u32) __pa(rtas_data_buf), (u32) count);\r\nmemcpy(data, rtas_data_buf, RTAS_DATA_BUF_SIZE);\r\nspin_unlock(&rtas_data_buf_lock);\r\npr_debug("scanlog: status=%d, data[0]=%x, data[1]=%x, " \\r\n"data[2]=%x\n", status, data[0], data[1], data[2]);\r\nswitch (status) {\r\ncase SCANLOG_COMPLETE:\r\npr_debug("scanlog: hit eof\n");\r\nreturn 0;\r\ncase SCANLOG_HWERROR:\r\npr_debug("scanlog: hardware error reading data\n");\r\nreturn -EIO;\r\ncase SCANLOG_CONTINUE:\r\nlen = data[1];\r\noff = data[2];\r\nif (len > 0) {\r\nif (copy_to_user(buf, ((char *)data)+off, len))\r\nreturn -EFAULT;\r\nreturn len;\r\n}\r\nbreak;\r\ndefault:\r\nwait_time = rtas_busy_delay_time(status);\r\nif (!wait_time) {\r\nprintk(KERN_ERR "scanlog: unknown error " \\r\n"from rtas: %d\n", status);\r\nreturn -EIO;\r\n}\r\n}\r\nmsleep_interruptible(wait_time);\r\n}\r\n}\r\nstatic ssize_t scanlog_write(struct file * file, const char __user * buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar stkbuf[20];\r\nint status;\r\nif (count > 19) count = 19;\r\nif (copy_from_user (stkbuf, buf, count)) {\r\nreturn -EFAULT;\r\n}\r\nstkbuf[count] = 0;\r\nif (buf) {\r\nif (strncmp(stkbuf, "reset", 5) == 0) {\r\npr_debug("scanlog: reset scanlog\n");\r\nstatus = rtas_call(ibm_scan_log_dump, 2, 1, NULL, 0, 0);\r\npr_debug("scanlog: rtas returns %d\n", status);\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic int scanlog_open(struct inode * inode, struct file * file)\r\n{\r\nunsigned int *data = scanlog_buffer;\r\nif (data[0] != 0) {\r\nreturn -EBUSY;\r\n}\r\ndata[0] = 0;\r\nreturn 0;\r\n}\r\nstatic int scanlog_release(struct inode * inode, struct file * file)\r\n{\r\nunsigned int *data = scanlog_buffer;\r\ndata[0] = 0;\r\nreturn 0;\r\n}\r\nstatic int __init scanlog_init(void)\r\n{\r\nstruct proc_dir_entry *ent;\r\nint err = -ENOMEM;\r\nibm_scan_log_dump = rtas_token("ibm,scan-log-dump");\r\nif (ibm_scan_log_dump == RTAS_UNKNOWN_SERVICE)\r\nreturn -ENODEV;\r\nscanlog_buffer = kzalloc(RTAS_DATA_BUF_SIZE, GFP_KERNEL);\r\nif (!scanlog_buffer)\r\ngoto err;\r\nent = proc_create("powerpc/rtas/scan-log-dump", S_IRUSR, NULL,\r\n&scanlog_fops);\r\nif (!ent)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nkfree(scanlog_buffer);\r\nreturn err;\r\n}\r\nstatic void __exit scanlog_cleanup(void)\r\n{\r\nremove_proc_entry("powerpc/rtas/scan-log-dump", NULL);\r\nkfree(scanlog_buffer);\r\n}

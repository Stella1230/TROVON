static int st_sensors_get_buffer_element(struct iio_dev *indio_dev, u8 *buf)\r\n{\r\nint i;\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\nunsigned int num_data_channels = sdata->num_data_channels;\r\nfor_each_set_bit(i, indio_dev->active_scan_mask, num_data_channels) {\r\nconst struct iio_chan_spec *channel = &indio_dev->channels[i];\r\nunsigned int bytes_to_read =\r\nDIV_ROUND_UP(channel->scan_type.realbits +\r\nchannel->scan_type.shift, 8);\r\nunsigned int storage_bytes =\r\nchannel->scan_type.storagebits >> 3;\r\nbuf = PTR_ALIGN(buf, storage_bytes);\r\nif (sdata->tf->read_multiple_byte(&sdata->tb, sdata->dev,\r\nchannel->address,\r\nbytes_to_read, buf,\r\nsdata->multiread_bit) <\r\nbytes_to_read)\r\nreturn -EIO;\r\nbuf += storage_bytes;\r\n}\r\nreturn 0;\r\n}\r\nirqreturn_t st_sensors_trigger_handler(int irq, void *p)\r\n{\r\nint len;\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\ns64 timestamp;\r\nif (iio_trigger_using_own(indio_dev))\r\ntimestamp = sdata->hw_timestamp;\r\nelse\r\ntimestamp = iio_get_time_ns(indio_dev);\r\nlen = st_sensors_get_buffer_element(indio_dev, sdata->buffer_data);\r\nif (len < 0)\r\ngoto st_sensors_get_buffer_element_error;\r\niio_push_to_buffers_with_timestamp(indio_dev, sdata->buffer_data,\r\ntimestamp);\r\nst_sensors_get_buffer_element_error:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}

static int\r\nqed_iscsi_async_event(struct qed_hwfn *p_hwfn,\r\nu8 fw_event_code,\r\nu16 echo, union event_ring_data *data, u8 fw_return_code)\r\n{\r\nif (p_hwfn->p_iscsi_info->event_cb) {\r\nstruct qed_iscsi_info *p_iscsi = p_hwfn->p_iscsi_info;\r\nreturn p_iscsi->event_cb(p_iscsi->event_context,\r\nfw_event_code, data);\r\n} else {\r\nDP_NOTICE(p_hwfn, "iSCSI async completion is not set\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int\r\nqed_sp_iscsi_func_start(struct qed_hwfn *p_hwfn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr,\r\nvoid *event_context, iscsi_event_cb_t async_event_cb)\r\n{\r\nstruct iscsi_init_ramrod_params *p_ramrod = NULL;\r\nstruct scsi_init_func_queues *p_queue = NULL;\r\nstruct qed_iscsi_pf_params *p_params = NULL;\r\nstruct iscsi_spe_func_init *p_init = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = 0;\r\nu32 dval;\r\nu16 val;\r\nu8 i;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_INIT_FUNC,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_init;\r\np_init = &p_ramrod->iscsi_init_spe;\r\np_params = &p_hwfn->pf_params.iscsi_pf_params;\r\np_queue = &p_init->q_params;\r\nif (p_params->num_queues > p_hwfn->hw_info.feat_num[QED_ISCSI_CQ]) {\r\nDP_ERR(p_hwfn,\r\n"Cannot satisfy CQ amount. Queues requested %d, CQs available %d. Aborting function start\n",\r\np_params->num_queues,\r\np_hwfn->hw_info.feat_num[QED_ISCSI_CQ]);\r\nreturn -EINVAL;\r\n}\r\nSET_FIELD(p_init->hdr.flags,\r\nISCSI_SLOW_PATH_HDR_LAYER_CODE, ISCSI_SLOW_PATH_LAYER_CODE);\r\np_init->hdr.op_code = ISCSI_RAMROD_CMD_ID_INIT_FUNC;\r\nval = p_params->half_way_close_timeout;\r\np_init->half_way_close_timeout = cpu_to_le16(val);\r\np_init->num_sq_pages_in_ring = p_params->num_sq_pages_in_ring;\r\np_init->num_r2tq_pages_in_ring = p_params->num_r2tq_pages_in_ring;\r\np_init->num_uhq_pages_in_ring = p_params->num_uhq_pages_in_ring;\r\np_init->ooo_enable = p_params->ooo_enable;\r\np_init->ll2_rx_queue_id = p_hwfn->hw_info.resc_start[QED_LL2_QUEUE] +\r\np_params->ll2_ooo_queue_id;\r\np_init->func_params.log_page_size = p_params->log_page_size;\r\nval = p_params->num_tasks;\r\np_init->func_params.num_tasks = cpu_to_le16(val);\r\np_init->debug_mode.flags = p_params->debug_mode;\r\nDMA_REGPAIR_LE(p_queue->glbl_q_params_addr,\r\np_params->glbl_q_params_addr);\r\nval = p_params->cq_num_entries;\r\np_queue->cq_num_entries = cpu_to_le16(val);\r\nval = p_params->cmdq_num_entries;\r\np_queue->cmdq_num_entries = cpu_to_le16(val);\r\np_queue->num_queues = p_params->num_queues;\r\ndval = (u8)p_hwfn->hw_info.resc_start[QED_CMDQS_CQS];\r\np_queue->queue_relative_offset = (u8)dval;\r\np_queue->cq_sb_pi = p_params->gl_rq_pi;\r\np_queue->cmdq_sb_pi = p_params->gl_cmd_pi;\r\nfor (i = 0; i < p_params->num_queues; i++) {\r\nval = qed_get_igu_sb_id(p_hwfn, i);\r\np_queue->cq_cmdq_sb_num_arr[i] = cpu_to_le16(val);\r\n}\r\np_queue->bdq_resource_id = (u8)RESC_START(p_hwfn, QED_BDQ);\r\nDMA_REGPAIR_LE(p_queue->bdq_pbl_base_address[BDQ_ID_RQ],\r\np_params->bdq_pbl_base_addr[BDQ_ID_RQ]);\r\np_queue->bdq_pbl_num_entries[BDQ_ID_RQ] =\r\np_params->bdq_pbl_num_entries[BDQ_ID_RQ];\r\nval = p_params->bdq_xoff_threshold[BDQ_ID_RQ];\r\np_queue->bdq_xoff_threshold[BDQ_ID_RQ] = cpu_to_le16(val);\r\nval = p_params->bdq_xon_threshold[BDQ_ID_RQ];\r\np_queue->bdq_xon_threshold[BDQ_ID_RQ] = cpu_to_le16(val);\r\nDMA_REGPAIR_LE(p_queue->bdq_pbl_base_address[BDQ_ID_IMM_DATA],\r\np_params->bdq_pbl_base_addr[BDQ_ID_IMM_DATA]);\r\np_queue->bdq_pbl_num_entries[BDQ_ID_IMM_DATA] =\r\np_params->bdq_pbl_num_entries[BDQ_ID_IMM_DATA];\r\nval = p_params->bdq_xoff_threshold[BDQ_ID_IMM_DATA];\r\np_queue->bdq_xoff_threshold[BDQ_ID_IMM_DATA] = cpu_to_le16(val);\r\nval = p_params->bdq_xon_threshold[BDQ_ID_IMM_DATA];\r\np_queue->bdq_xon_threshold[BDQ_ID_IMM_DATA] = cpu_to_le16(val);\r\nval = p_params->rq_buffer_size;\r\np_queue->rq_buffer_size = cpu_to_le16(val);\r\nif (p_params->is_target) {\r\nSET_FIELD(p_queue->q_validity,\r\nSCSI_INIT_FUNC_QUEUES_RQ_VALID, 1);\r\nif (p_queue->bdq_pbl_num_entries[BDQ_ID_IMM_DATA])\r\nSET_FIELD(p_queue->q_validity,\r\nSCSI_INIT_FUNC_QUEUES_IMM_DATA_VALID, 1);\r\nSET_FIELD(p_queue->q_validity,\r\nSCSI_INIT_FUNC_QUEUES_CMD_VALID, 1);\r\n} else {\r\nSET_FIELD(p_queue->q_validity,\r\nSCSI_INIT_FUNC_QUEUES_RQ_VALID, 1);\r\n}\r\np_ramrod->tcp_init.two_msl_timer = cpu_to_le32(p_params->two_msl_timer);\r\nval = p_params->tx_sws_timer;\r\np_ramrod->tcp_init.tx_sws_timer = cpu_to_le16(val);\r\np_ramrod->tcp_init.maxfinrt = p_params->max_fin_rt;\r\np_hwfn->p_iscsi_info->event_context = event_context;\r\np_hwfn->p_iscsi_info->event_cb = async_event_cb;\r\nqed_spq_register_async_cb(p_hwfn, PROTOCOLID_ISCSI,\r\nqed_iscsi_async_event);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int qed_sp_iscsi_conn_offload(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_spe_conn_offload *p_ramrod = NULL;\r\nstruct tcp_offload_params_opt2 *p_tcp2 = NULL;\r\nstruct tcp_offload_params *p_tcp = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\ndma_addr_t r2tq_pbl_addr;\r\ndma_addr_t xhq_pbl_addr;\r\ndma_addr_t uhq_pbl_addr;\r\nu16 physical_q;\r\nint rc = 0;\r\nu32 dval;\r\nu16 wval;\r\nu8 i;\r\nu16 *p;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = p_conn->icid;\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_OFFLOAD_CONN,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_conn_offload;\r\nphysical_q = qed_get_cm_pq_idx(p_hwfn, PQ_FLAGS_OFLD);\r\np_conn->physical_q0 = cpu_to_le16(physical_q);\r\np_ramrod->iscsi.physical_q0 = cpu_to_le16(physical_q);\r\nphysical_q = qed_get_cm_pq_idx(p_hwfn, PQ_FLAGS_ACK);\r\np_conn->physical_q1 = cpu_to_le16(physical_q);\r\np_ramrod->iscsi.physical_q1 = cpu_to_le16(physical_q);\r\np_ramrod->hdr.op_code = ISCSI_RAMROD_CMD_ID_OFFLOAD_CONN;\r\nSET_FIELD(p_ramrod->hdr.flags, ISCSI_SLOW_PATH_HDR_LAYER_CODE,\r\np_conn->layer_code);\r\np_ramrod->conn_id = cpu_to_le16(p_conn->conn_id);\r\np_ramrod->fw_cid = cpu_to_le32(p_conn->icid);\r\nDMA_REGPAIR_LE(p_ramrod->iscsi.sq_pbl_addr, p_conn->sq_pbl_addr);\r\nr2tq_pbl_addr = qed_chain_get_pbl_phys(&p_conn->r2tq);\r\nDMA_REGPAIR_LE(p_ramrod->iscsi.r2tq_pbl_addr, r2tq_pbl_addr);\r\nxhq_pbl_addr = qed_chain_get_pbl_phys(&p_conn->xhq);\r\nDMA_REGPAIR_LE(p_ramrod->iscsi.xhq_pbl_addr, xhq_pbl_addr);\r\nuhq_pbl_addr = qed_chain_get_pbl_phys(&p_conn->uhq);\r\nDMA_REGPAIR_LE(p_ramrod->iscsi.uhq_pbl_addr, uhq_pbl_addr);\r\np_ramrod->iscsi.initial_ack = cpu_to_le32(p_conn->initial_ack);\r\np_ramrod->iscsi.flags = p_conn->offl_flags;\r\np_ramrod->iscsi.default_cq = p_conn->default_cq;\r\np_ramrod->iscsi.stat_sn = cpu_to_le32(p_conn->stat_sn);\r\nif (!GET_FIELD(p_ramrod->iscsi.flags,\r\nISCSI_CONN_OFFLOAD_PARAMS_TCP_ON_CHIP_1B)) {\r\np_tcp = &p_ramrod->tcp;\r\np = (u16 *)p_conn->local_mac;\r\np_tcp->local_mac_addr_hi = swab16(get_unaligned(p));\r\np_tcp->local_mac_addr_mid = swab16(get_unaligned(p + 1));\r\np_tcp->local_mac_addr_lo = swab16(get_unaligned(p + 2));\r\np = (u16 *)p_conn->remote_mac;\r\np_tcp->remote_mac_addr_hi = swab16(get_unaligned(p));\r\np_tcp->remote_mac_addr_mid = swab16(get_unaligned(p + 1));\r\np_tcp->remote_mac_addr_lo = swab16(get_unaligned(p + 2));\r\np_tcp->vlan_id = cpu_to_le16(p_conn->vlan_id);\r\np_tcp->flags = p_conn->tcp_flags;\r\np_tcp->ip_version = p_conn->ip_version;\r\nfor (i = 0; i < 4; i++) {\r\ndval = p_conn->remote_ip[i];\r\np_tcp->remote_ip[i] = cpu_to_le32(dval);\r\ndval = p_conn->local_ip[i];\r\np_tcp->local_ip[i] = cpu_to_le32(dval);\r\n}\r\np_tcp->ka_max_probe_cnt = p_conn->ka_max_probe_cnt;\r\np_tcp->dup_ack_theshold = p_conn->dup_ack_theshold;\r\np_tcp->rcv_next = cpu_to_le32(p_conn->rcv_next);\r\np_tcp->snd_una = cpu_to_le32(p_conn->snd_una);\r\np_tcp->snd_next = cpu_to_le32(p_conn->snd_next);\r\np_tcp->snd_max = cpu_to_le32(p_conn->snd_max);\r\np_tcp->snd_wnd = cpu_to_le32(p_conn->snd_wnd);\r\np_tcp->rcv_wnd = cpu_to_le32(p_conn->rcv_wnd);\r\np_tcp->snd_wl1 = cpu_to_le32(p_conn->snd_wl1);\r\np_tcp->cwnd = cpu_to_le32(p_conn->cwnd);\r\np_tcp->ss_thresh = cpu_to_le32(p_conn->ss_thresh);\r\np_tcp->srtt = cpu_to_le16(p_conn->srtt);\r\np_tcp->rtt_var = cpu_to_le16(p_conn->rtt_var);\r\np_tcp->ts_recent = cpu_to_le32(p_conn->ts_recent);\r\np_tcp->ts_recent_age = cpu_to_le32(p_conn->ts_recent_age);\r\np_tcp->total_rt = cpu_to_le32(p_conn->total_rt);\r\ndval = p_conn->ka_timeout_delta;\r\np_tcp->ka_timeout_delta = cpu_to_le32(dval);\r\ndval = p_conn->rt_timeout_delta;\r\np_tcp->rt_timeout_delta = cpu_to_le32(dval);\r\np_tcp->dup_ack_cnt = p_conn->dup_ack_cnt;\r\np_tcp->snd_wnd_probe_cnt = p_conn->snd_wnd_probe_cnt;\r\np_tcp->ka_probe_cnt = p_conn->ka_probe_cnt;\r\np_tcp->rt_cnt = p_conn->rt_cnt;\r\np_tcp->flow_label = cpu_to_le32(p_conn->flow_label);\r\np_tcp->ka_timeout = cpu_to_le32(p_conn->ka_timeout);\r\np_tcp->ka_interval = cpu_to_le32(p_conn->ka_interval);\r\np_tcp->max_rt_time = cpu_to_le32(p_conn->max_rt_time);\r\ndval = p_conn->initial_rcv_wnd;\r\np_tcp->initial_rcv_wnd = cpu_to_le32(dval);\r\np_tcp->ttl = p_conn->ttl;\r\np_tcp->tos_or_tc = p_conn->tos_or_tc;\r\np_tcp->remote_port = cpu_to_le16(p_conn->remote_port);\r\np_tcp->local_port = cpu_to_le16(p_conn->local_port);\r\np_tcp->mss = cpu_to_le16(p_conn->mss);\r\np_tcp->snd_wnd_scale = p_conn->snd_wnd_scale;\r\np_tcp->rcv_wnd_scale = p_conn->rcv_wnd_scale;\r\nwval = p_conn->da_timeout_value;\r\np_tcp->da_timeout_value = cpu_to_le16(wval);\r\np_tcp->ack_frequency = p_conn->ack_frequency;\r\np_tcp->connect_mode = p_conn->connect_mode;\r\n} else {\r\np_tcp2 =\r\n&((struct iscsi_spe_conn_offload_option2 *)p_ramrod)->tcp;\r\np = (u16 *)p_conn->local_mac;\r\np_tcp2->local_mac_addr_hi = swab16(get_unaligned(p));\r\np_tcp2->local_mac_addr_mid = swab16(get_unaligned(p + 1));\r\np_tcp2->local_mac_addr_lo = swab16(get_unaligned(p + 2));\r\np = (u16 *)p_conn->remote_mac;\r\np_tcp2->remote_mac_addr_hi = swab16(get_unaligned(p));\r\np_tcp2->remote_mac_addr_mid = swab16(get_unaligned(p + 1));\r\np_tcp2->remote_mac_addr_lo = swab16(get_unaligned(p + 2));\r\np_tcp2->vlan_id = cpu_to_le16(p_conn->vlan_id);\r\np_tcp2->flags = p_conn->tcp_flags;\r\np_tcp2->ip_version = p_conn->ip_version;\r\nfor (i = 0; i < 4; i++) {\r\ndval = p_conn->remote_ip[i];\r\np_tcp2->remote_ip[i] = cpu_to_le32(dval);\r\ndval = p_conn->local_ip[i];\r\np_tcp2->local_ip[i] = cpu_to_le32(dval);\r\n}\r\np_tcp2->flow_label = cpu_to_le32(p_conn->flow_label);\r\np_tcp2->ttl = p_conn->ttl;\r\np_tcp2->tos_or_tc = p_conn->tos_or_tc;\r\np_tcp2->remote_port = cpu_to_le16(p_conn->remote_port);\r\np_tcp2->local_port = cpu_to_le16(p_conn->local_port);\r\np_tcp2->mss = cpu_to_le16(p_conn->mss);\r\np_tcp2->rcv_wnd_scale = p_conn->rcv_wnd_scale;\r\np_tcp2->connect_mode = p_conn->connect_mode;\r\nwval = p_conn->syn_ip_payload_length;\r\np_tcp2->syn_ip_payload_length = cpu_to_le16(wval);\r\np_tcp2->syn_phy_addr_lo = DMA_LO_LE(p_conn->syn_phy_addr);\r\np_tcp2->syn_phy_addr_hi = DMA_HI_LE(p_conn->syn_phy_addr);\r\n}\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int qed_sp_iscsi_conn_update(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_conn_update_ramrod_params *p_ramrod = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nu32 dval;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = p_conn->icid;\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_UPDATE_CONN,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_conn_update;\r\np_ramrod->hdr.op_code = ISCSI_RAMROD_CMD_ID_UPDATE_CONN;\r\nSET_FIELD(p_ramrod->hdr.flags,\r\nISCSI_SLOW_PATH_HDR_LAYER_CODE, p_conn->layer_code);\r\np_ramrod->conn_id = cpu_to_le16(p_conn->conn_id);\r\np_ramrod->fw_cid = cpu_to_le32(p_conn->icid);\r\np_ramrod->flags = p_conn->update_flag;\r\np_ramrod->max_seq_size = cpu_to_le32(p_conn->max_seq_size);\r\ndval = p_conn->max_recv_pdu_length;\r\np_ramrod->max_recv_pdu_length = cpu_to_le32(dval);\r\ndval = p_conn->max_send_pdu_length;\r\np_ramrod->max_send_pdu_length = cpu_to_le32(dval);\r\ndval = p_conn->first_seq_length;\r\np_ramrod->first_seq_length = cpu_to_le32(dval);\r\np_ramrod->exp_stat_sn = cpu_to_le32(p_conn->exp_stat_sn);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int\r\nqed_sp_iscsi_mac_update(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_spe_conn_mac_update *p_ramrod = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nu8 ucval;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = p_conn->icid;\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_MAC_UPDATE,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_conn_mac_update;\r\np_ramrod->hdr.op_code = ISCSI_RAMROD_CMD_ID_MAC_UPDATE;\r\nSET_FIELD(p_ramrod->hdr.flags,\r\nISCSI_SLOW_PATH_HDR_LAYER_CODE, p_conn->layer_code);\r\np_ramrod->conn_id = cpu_to_le16(p_conn->conn_id);\r\np_ramrod->fw_cid = cpu_to_le32(p_conn->icid);\r\nucval = p_conn->remote_mac[1];\r\n((u8 *)(&p_ramrod->remote_mac_addr_hi))[0] = ucval;\r\nucval = p_conn->remote_mac[0];\r\n((u8 *)(&p_ramrod->remote_mac_addr_hi))[1] = ucval;\r\nucval = p_conn->remote_mac[3];\r\n((u8 *)(&p_ramrod->remote_mac_addr_mid))[0] = ucval;\r\nucval = p_conn->remote_mac[2];\r\n((u8 *)(&p_ramrod->remote_mac_addr_mid))[1] = ucval;\r\nucval = p_conn->remote_mac[5];\r\n((u8 *)(&p_ramrod->remote_mac_addr_lo))[0] = ucval;\r\nucval = p_conn->remote_mac[4];\r\n((u8 *)(&p_ramrod->remote_mac_addr_lo))[1] = ucval;\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int qed_sp_iscsi_conn_terminate(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_spe_conn_termination *p_ramrod = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = p_conn->icid;\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_TERMINATION_CONN,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_conn_terminate;\r\np_ramrod->hdr.op_code = ISCSI_RAMROD_CMD_ID_TERMINATION_CONN;\r\nSET_FIELD(p_ramrod->hdr.flags,\r\nISCSI_SLOW_PATH_HDR_LAYER_CODE, p_conn->layer_code);\r\np_ramrod->conn_id = cpu_to_le16(p_conn->conn_id);\r\np_ramrod->fw_cid = cpu_to_le32(p_conn->icid);\r\np_ramrod->abortive = p_conn->abortive_dsconnect;\r\nDMA_REGPAIR_LE(p_ramrod->query_params_addr,\r\np_conn->tcp_upload_params_phys_addr);\r\nDMA_REGPAIR_LE(p_ramrod->queue_cnts_addr, p_conn->queue_cnts_phys_addr);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int qed_sp_iscsi_conn_clear_sq(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_slow_path_hdr *p_ramrod = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = -EINVAL;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = p_conn->icid;\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_CLEAR_SQ,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_empty;\r\np_ramrod->op_code = ISCSI_RAMROD_CMD_ID_CLEAR_SQ;\r\nSET_FIELD(p_ramrod->flags,\r\nISCSI_SLOW_PATH_HDR_LAYER_CODE, p_conn->layer_code);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nstatic int qed_sp_iscsi_func_stop(struct qed_hwfn *p_hwfn,\r\nenum spq_mode comp_mode,\r\nstruct qed_spq_comp_cb *p_comp_addr)\r\n{\r\nstruct iscsi_spe_func_dstry *p_ramrod = NULL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nstruct qed_sp_init_data init_data;\r\nint rc = 0;\r\nmemset(&init_data, 0, sizeof(init_data));\r\ninit_data.cid = qed_spq_get_cid(p_hwfn);\r\ninit_data.opaque_fid = p_hwfn->hw_info.opaque_fid;\r\ninit_data.comp_mode = comp_mode;\r\ninit_data.p_comp_data = p_comp_addr;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent,\r\nISCSI_RAMROD_CMD_ID_DESTROY_FUNC,\r\nPROTOCOLID_ISCSI, &init_data);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.iscsi_destroy;\r\np_ramrod->hdr.op_code = ISCSI_RAMROD_CMD_ID_DESTROY_FUNC;\r\nrc = qed_spq_post(p_hwfn, p_ent, NULL);\r\nqed_spq_unregister_async_cb(p_hwfn, PROTOCOLID_ISCSI);\r\nreturn rc;\r\n}\r\nstatic void __iomem *qed_iscsi_get_db_addr(struct qed_hwfn *p_hwfn, u32 cid)\r\n{\r\nreturn (u8 __iomem *)p_hwfn->doorbells +\r\nqed_db_addr(cid, DQ_DEMS_LEGACY);\r\n}\r\nstatic void __iomem *qed_iscsi_get_primary_bdq_prod(struct qed_hwfn *p_hwfn,\r\nu8 bdq_id)\r\n{\r\nif (RESC_NUM(p_hwfn, QED_BDQ)) {\r\nreturn (u8 __iomem *)p_hwfn->regview +\r\nGTT_BAR0_MAP_REG_MSDM_RAM +\r\nMSTORM_SCSI_BDQ_EXT_PROD_OFFSET(RESC_START(p_hwfn,\r\nQED_BDQ),\r\nbdq_id);\r\n} else {\r\nDP_NOTICE(p_hwfn, "BDQ is not allocated!\n");\r\nreturn NULL;\r\n}\r\n}\r\nstatic void __iomem *qed_iscsi_get_secondary_bdq_prod(struct qed_hwfn *p_hwfn,\r\nu8 bdq_id)\r\n{\r\nif (RESC_NUM(p_hwfn, QED_BDQ)) {\r\nreturn (u8 __iomem *)p_hwfn->regview +\r\nGTT_BAR0_MAP_REG_TSDM_RAM +\r\nTSTORM_SCSI_BDQ_EXT_PROD_OFFSET(RESC_START(p_hwfn,\r\nQED_BDQ),\r\nbdq_id);\r\n} else {\r\nDP_NOTICE(p_hwfn, "BDQ is not allocated!\n");\r\nreturn NULL;\r\n}\r\n}\r\nstatic int qed_iscsi_setup_connection(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn)\r\n{\r\nif (!p_conn->queue_cnts_virt_addr)\r\ngoto nomem;\r\nmemset(p_conn->queue_cnts_virt_addr, 0,\r\nsizeof(*p_conn->queue_cnts_virt_addr));\r\nif (!p_conn->tcp_upload_params_virt_addr)\r\ngoto nomem;\r\nmemset(p_conn->tcp_upload_params_virt_addr, 0,\r\nsizeof(*p_conn->tcp_upload_params_virt_addr));\r\nif (!p_conn->r2tq.p_virt_addr)\r\ngoto nomem;\r\nqed_chain_pbl_zero_mem(&p_conn->r2tq);\r\nif (!p_conn->uhq.p_virt_addr)\r\ngoto nomem;\r\nqed_chain_pbl_zero_mem(&p_conn->uhq);\r\nif (!p_conn->xhq.p_virt_addr)\r\ngoto nomem;\r\nqed_chain_pbl_zero_mem(&p_conn->xhq);\r\nreturn 0;\r\nnomem:\r\nreturn -ENOMEM;\r\n}\r\nstatic int qed_iscsi_allocate_connection(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn **p_out_conn)\r\n{\r\nu16 uhq_num_elements = 0, xhq_num_elements = 0, r2tq_num_elements = 0;\r\nstruct scsi_terminate_extra_params *p_q_cnts = NULL;\r\nstruct qed_iscsi_pf_params *p_params = NULL;\r\nstruct tcp_upload_params *p_tcp = NULL;\r\nstruct qed_iscsi_conn *p_conn = NULL;\r\nint rc = 0;\r\nspin_lock_bh(&p_hwfn->p_iscsi_info->lock);\r\nif (!list_empty(&p_hwfn->p_iscsi_info->free_list))\r\np_conn = list_first_entry(&p_hwfn->p_iscsi_info->free_list,\r\nstruct qed_iscsi_conn, list_entry);\r\nif (p_conn) {\r\nlist_del(&p_conn->list_entry);\r\nspin_unlock_bh(&p_hwfn->p_iscsi_info->lock);\r\n*p_out_conn = p_conn;\r\nreturn 0;\r\n}\r\nspin_unlock_bh(&p_hwfn->p_iscsi_info->lock);\r\np_params = &p_hwfn->pf_params.iscsi_pf_params;\r\np_conn = kzalloc(sizeof(*p_conn), GFP_KERNEL);\r\nif (!p_conn)\r\nreturn -ENOMEM;\r\np_q_cnts = dma_alloc_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(*p_q_cnts),\r\n&p_conn->queue_cnts_phys_addr,\r\nGFP_KERNEL);\r\nif (!p_q_cnts)\r\ngoto nomem_queue_cnts_param;\r\np_conn->queue_cnts_virt_addr = p_q_cnts;\r\np_tcp = dma_alloc_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(*p_tcp),\r\n&p_conn->tcp_upload_params_phys_addr,\r\nGFP_KERNEL);\r\nif (!p_tcp)\r\ngoto nomem_upload_param;\r\np_conn->tcp_upload_params_virt_addr = p_tcp;\r\nr2tq_num_elements = p_params->num_r2tq_pages_in_ring *\r\nQED_CHAIN_PAGE_SIZE / 0x80;\r\nrc = qed_chain_alloc(p_hwfn->cdev,\r\nQED_CHAIN_USE_TO_CONSUME_PRODUCE,\r\nQED_CHAIN_MODE_PBL,\r\nQED_CHAIN_CNT_TYPE_U16,\r\nr2tq_num_elements, 0x80, &p_conn->r2tq, NULL);\r\nif (rc)\r\ngoto nomem_r2tq;\r\nuhq_num_elements = p_params->num_uhq_pages_in_ring *\r\nQED_CHAIN_PAGE_SIZE / sizeof(struct iscsi_uhqe);\r\nrc = qed_chain_alloc(p_hwfn->cdev,\r\nQED_CHAIN_USE_TO_CONSUME_PRODUCE,\r\nQED_CHAIN_MODE_PBL,\r\nQED_CHAIN_CNT_TYPE_U16,\r\nuhq_num_elements,\r\nsizeof(struct iscsi_uhqe), &p_conn->uhq, NULL);\r\nif (rc)\r\ngoto nomem_uhq;\r\nxhq_num_elements = uhq_num_elements;\r\nrc = qed_chain_alloc(p_hwfn->cdev,\r\nQED_CHAIN_USE_TO_CONSUME_PRODUCE,\r\nQED_CHAIN_MODE_PBL,\r\nQED_CHAIN_CNT_TYPE_U16,\r\nxhq_num_elements,\r\nsizeof(struct iscsi_xhqe), &p_conn->xhq, NULL);\r\nif (rc)\r\ngoto nomem;\r\np_conn->free_on_delete = true;\r\n*p_out_conn = p_conn;\r\nreturn 0;\r\nnomem:\r\nqed_chain_free(p_hwfn->cdev, &p_conn->uhq);\r\nnomem_uhq:\r\nqed_chain_free(p_hwfn->cdev, &p_conn->r2tq);\r\nnomem_r2tq:\r\ndma_free_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(struct tcp_upload_params),\r\np_conn->tcp_upload_params_virt_addr,\r\np_conn->tcp_upload_params_phys_addr);\r\nnomem_upload_param:\r\ndma_free_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(struct scsi_terminate_extra_params),\r\np_conn->queue_cnts_virt_addr,\r\np_conn->queue_cnts_phys_addr);\r\nnomem_queue_cnts_param:\r\nkfree(p_conn);\r\nreturn -ENOMEM;\r\n}\r\nstatic int qed_iscsi_acquire_connection(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_in_conn,\r\nstruct qed_iscsi_conn **p_out_conn)\r\n{\r\nstruct qed_iscsi_conn *p_conn = NULL;\r\nint rc = 0;\r\nu32 icid;\r\nspin_lock_bh(&p_hwfn->p_iscsi_info->lock);\r\nrc = qed_cxt_acquire_cid(p_hwfn, PROTOCOLID_ISCSI, &icid);\r\nspin_unlock_bh(&p_hwfn->p_iscsi_info->lock);\r\nif (rc)\r\nreturn rc;\r\nif (p_in_conn)\r\np_conn = p_in_conn;\r\nelse\r\nrc = qed_iscsi_allocate_connection(p_hwfn, &p_conn);\r\nif (!rc)\r\nrc = qed_iscsi_setup_connection(p_hwfn, p_conn);\r\nif (rc) {\r\nspin_lock_bh(&p_hwfn->p_iscsi_info->lock);\r\nqed_cxt_release_cid(p_hwfn, icid);\r\nspin_unlock_bh(&p_hwfn->p_iscsi_info->lock);\r\nreturn rc;\r\n}\r\np_conn->icid = icid;\r\np_conn->conn_id = (u16)icid;\r\np_conn->fw_cid = (p_hwfn->hw_info.opaque_fid << 16) | icid;\r\n*p_out_conn = p_conn;\r\nreturn rc;\r\n}\r\nstatic void qed_iscsi_release_connection(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn)\r\n{\r\nspin_lock_bh(&p_hwfn->p_iscsi_info->lock);\r\nlist_add_tail(&p_conn->list_entry, &p_hwfn->p_iscsi_info->free_list);\r\nqed_cxt_release_cid(p_hwfn, p_conn->icid);\r\nspin_unlock_bh(&p_hwfn->p_iscsi_info->lock);\r\n}\r\nvoid qed_iscsi_free_connection(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_conn *p_conn)\r\n{\r\nqed_chain_free(p_hwfn->cdev, &p_conn->xhq);\r\nqed_chain_free(p_hwfn->cdev, &p_conn->uhq);\r\nqed_chain_free(p_hwfn->cdev, &p_conn->r2tq);\r\ndma_free_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(struct tcp_upload_params),\r\np_conn->tcp_upload_params_virt_addr,\r\np_conn->tcp_upload_params_phys_addr);\r\ndma_free_coherent(&p_hwfn->cdev->pdev->dev,\r\nsizeof(struct scsi_terminate_extra_params),\r\np_conn->queue_cnts_virt_addr,\r\np_conn->queue_cnts_phys_addr);\r\nkfree(p_conn);\r\n}\r\nint qed_iscsi_alloc(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_iscsi_info *p_iscsi_info;\r\np_iscsi_info = kzalloc(sizeof(*p_iscsi_info), GFP_KERNEL);\r\nif (!p_iscsi_info)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&p_iscsi_info->free_list);\r\np_hwfn->p_iscsi_info = p_iscsi_info;\r\nreturn 0;\r\n}\r\nvoid qed_iscsi_setup(struct qed_hwfn *p_hwfn)\r\n{\r\nspin_lock_init(&p_hwfn->p_iscsi_info->lock);\r\n}\r\nvoid qed_iscsi_free(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_iscsi_conn *p_conn = NULL;\r\nif (!p_hwfn->p_iscsi_info)\r\nreturn;\r\nwhile (!list_empty(&p_hwfn->p_iscsi_info->free_list)) {\r\np_conn = list_first_entry(&p_hwfn->p_iscsi_info->free_list,\r\nstruct qed_iscsi_conn, list_entry);\r\nif (p_conn) {\r\nlist_del(&p_conn->list_entry);\r\nqed_iscsi_free_connection(p_hwfn, p_conn);\r\n}\r\n}\r\nkfree(p_hwfn->p_iscsi_info);\r\np_hwfn->p_iscsi_info = NULL;\r\n}\r\nstatic void _qed_iscsi_get_tstats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct tstorm_iscsi_stats_drv tstats;\r\nu32 tstats_addr;\r\nmemset(&tstats, 0, sizeof(tstats));\r\ntstats_addr = BAR0_MAP_REG_TSDM_RAM +\r\nTSTORM_ISCSI_RX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &tstats, tstats_addr, sizeof(tstats));\r\np_stats->iscsi_rx_bytes_cnt =\r\nHILO_64_REGPAIR(tstats.iscsi_rx_bytes_cnt);\r\np_stats->iscsi_rx_packet_cnt =\r\nHILO_64_REGPAIR(tstats.iscsi_rx_packet_cnt);\r\np_stats->iscsi_rx_new_ooo_isle_events_cnt =\r\nHILO_64_REGPAIR(tstats.iscsi_rx_new_ooo_isle_events_cnt);\r\np_stats->iscsi_cmdq_threshold_cnt =\r\nle32_to_cpu(tstats.iscsi_cmdq_threshold_cnt);\r\np_stats->iscsi_rq_threshold_cnt =\r\nle32_to_cpu(tstats.iscsi_rq_threshold_cnt);\r\np_stats->iscsi_immq_threshold_cnt =\r\nle32_to_cpu(tstats.iscsi_immq_threshold_cnt);\r\n}\r\nstatic void _qed_iscsi_get_mstats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct mstorm_iscsi_stats_drv mstats;\r\nu32 mstats_addr;\r\nmemset(&mstats, 0, sizeof(mstats));\r\nmstats_addr = BAR0_MAP_REG_MSDM_RAM +\r\nMSTORM_ISCSI_RX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &mstats, mstats_addr, sizeof(mstats));\r\np_stats->iscsi_rx_dropped_pdus_task_not_valid =\r\nHILO_64_REGPAIR(mstats.iscsi_rx_dropped_pdus_task_not_valid);\r\n}\r\nstatic void _qed_iscsi_get_ustats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct ustorm_iscsi_stats_drv ustats;\r\nu32 ustats_addr;\r\nmemset(&ustats, 0, sizeof(ustats));\r\nustats_addr = BAR0_MAP_REG_USDM_RAM +\r\nUSTORM_ISCSI_RX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &ustats, ustats_addr, sizeof(ustats));\r\np_stats->iscsi_rx_data_pdu_cnt =\r\nHILO_64_REGPAIR(ustats.iscsi_rx_data_pdu_cnt);\r\np_stats->iscsi_rx_r2t_pdu_cnt =\r\nHILO_64_REGPAIR(ustats.iscsi_rx_r2t_pdu_cnt);\r\np_stats->iscsi_rx_total_pdu_cnt =\r\nHILO_64_REGPAIR(ustats.iscsi_rx_total_pdu_cnt);\r\n}\r\nstatic void _qed_iscsi_get_xstats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct xstorm_iscsi_stats_drv xstats;\r\nu32 xstats_addr;\r\nmemset(&xstats, 0, sizeof(xstats));\r\nxstats_addr = BAR0_MAP_REG_XSDM_RAM +\r\nXSTORM_ISCSI_TX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &xstats, xstats_addr, sizeof(xstats));\r\np_stats->iscsi_tx_go_to_slow_start_event_cnt =\r\nHILO_64_REGPAIR(xstats.iscsi_tx_go_to_slow_start_event_cnt);\r\np_stats->iscsi_tx_fast_retransmit_event_cnt =\r\nHILO_64_REGPAIR(xstats.iscsi_tx_fast_retransmit_event_cnt);\r\n}\r\nstatic void _qed_iscsi_get_ystats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct ystorm_iscsi_stats_drv ystats;\r\nu32 ystats_addr;\r\nmemset(&ystats, 0, sizeof(ystats));\r\nystats_addr = BAR0_MAP_REG_YSDM_RAM +\r\nYSTORM_ISCSI_TX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &ystats, ystats_addr, sizeof(ystats));\r\np_stats->iscsi_tx_data_pdu_cnt =\r\nHILO_64_REGPAIR(ystats.iscsi_tx_data_pdu_cnt);\r\np_stats->iscsi_tx_r2t_pdu_cnt =\r\nHILO_64_REGPAIR(ystats.iscsi_tx_r2t_pdu_cnt);\r\np_stats->iscsi_tx_total_pdu_cnt =\r\nHILO_64_REGPAIR(ystats.iscsi_tx_total_pdu_cnt);\r\n}\r\nstatic void _qed_iscsi_get_pstats(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_iscsi_stats *p_stats)\r\n{\r\nstruct pstorm_iscsi_stats_drv pstats;\r\nu32 pstats_addr;\r\nmemset(&pstats, 0, sizeof(pstats));\r\npstats_addr = BAR0_MAP_REG_PSDM_RAM +\r\nPSTORM_ISCSI_TX_STATS_OFFSET(p_hwfn->rel_pf_id);\r\nqed_memcpy_from(p_hwfn, p_ptt, &pstats, pstats_addr, sizeof(pstats));\r\np_stats->iscsi_tx_bytes_cnt =\r\nHILO_64_REGPAIR(pstats.iscsi_tx_bytes_cnt);\r\np_stats->iscsi_tx_packet_cnt =\r\nHILO_64_REGPAIR(pstats.iscsi_tx_packet_cnt);\r\n}\r\nstatic int qed_iscsi_get_stats(struct qed_hwfn *p_hwfn,\r\nstruct qed_iscsi_stats *stats)\r\n{\r\nstruct qed_ptt *p_ptt;\r\nmemset(stats, 0, sizeof(*stats));\r\np_ptt = qed_ptt_acquire(p_hwfn);\r\nif (!p_ptt) {\r\nDP_ERR(p_hwfn, "Failed to acquire ptt\n");\r\nreturn -EAGAIN;\r\n}\r\n_qed_iscsi_get_tstats(p_hwfn, p_ptt, stats);\r\n_qed_iscsi_get_mstats(p_hwfn, p_ptt, stats);\r\n_qed_iscsi_get_ustats(p_hwfn, p_ptt, stats);\r\n_qed_iscsi_get_xstats(p_hwfn, p_ptt, stats);\r\n_qed_iscsi_get_ystats(p_hwfn, p_ptt, stats);\r\n_qed_iscsi_get_pstats(p_hwfn, p_ptt, stats);\r\nqed_ptt_release(p_hwfn, p_ptt);\r\nreturn 0;\r\n}\r\nstatic int qed_fill_iscsi_dev_info(struct qed_dev *cdev,\r\nstruct qed_dev_iscsi_info *info)\r\n{\r\nstruct qed_hwfn *hwfn = QED_LEADING_HWFN(cdev);\r\nint rc;\r\nmemset(info, 0, sizeof(*info));\r\nrc = qed_fill_dev_info(cdev, &info->common);\r\ninfo->primary_dbq_rq_addr =\r\nqed_iscsi_get_primary_bdq_prod(hwfn, BDQ_ID_RQ);\r\ninfo->secondary_bdq_rq_addr =\r\nqed_iscsi_get_secondary_bdq_prod(hwfn, BDQ_ID_RQ);\r\ninfo->num_cqs = FEAT_NUM(hwfn, QED_ISCSI_CQ);\r\nreturn rc;\r\n}\r\nstatic void qed_register_iscsi_ops(struct qed_dev *cdev,\r\nstruct qed_iscsi_cb_ops *ops, void *cookie)\r\n{\r\ncdev->protocol_ops.iscsi = ops;\r\ncdev->ops_cookie = cookie;\r\n}\r\nstatic struct qed_hash_iscsi_con *qed_iscsi_get_hash(struct qed_dev *cdev,\r\nu32 handle)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con = NULL;\r\nif (!(cdev->flags & QED_FLAG_STORAGE_STARTED))\r\nreturn NULL;\r\nhash_for_each_possible(cdev->connections, hash_con, node, handle) {\r\nif (hash_con->con->icid == handle)\r\nbreak;\r\n}\r\nif (!hash_con || (hash_con->con->icid != handle))\r\nreturn NULL;\r\nreturn hash_con;\r\n}\r\nstatic int qed_iscsi_stop(struct qed_dev *cdev)\r\n{\r\nint rc;\r\nif (!(cdev->flags & QED_FLAG_STORAGE_STARTED)) {\r\nDP_NOTICE(cdev, "iscsi already stopped\n");\r\nreturn 0;\r\n}\r\nif (!hash_empty(cdev->connections)) {\r\nDP_NOTICE(cdev,\r\n"Can't stop iscsi - not all connections were returned\n");\r\nreturn -EINVAL;\r\n}\r\nrc = qed_sp_iscsi_func_stop(QED_LEADING_HWFN(cdev),\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\ncdev->flags &= ~QED_FLAG_STORAGE_STARTED;\r\nreturn rc;\r\n}\r\nstatic int qed_iscsi_start(struct qed_dev *cdev,\r\nstruct qed_iscsi_tid *tasks,\r\nvoid *event_context,\r\niscsi_event_cb_t async_event_cb)\r\n{\r\nint rc;\r\nstruct qed_tid_mem *tid_info;\r\nif (cdev->flags & QED_FLAG_STORAGE_STARTED) {\r\nDP_NOTICE(cdev, "iscsi already started;\n");\r\nreturn 0;\r\n}\r\nrc = qed_sp_iscsi_func_start(QED_LEADING_HWFN(cdev),\r\nQED_SPQ_MODE_EBLOCK, NULL, event_context,\r\nasync_event_cb);\r\nif (rc) {\r\nDP_NOTICE(cdev, "Failed to start iscsi\n");\r\nreturn rc;\r\n}\r\ncdev->flags |= QED_FLAG_STORAGE_STARTED;\r\nhash_init(cdev->connections);\r\nif (!tasks)\r\nreturn 0;\r\ntid_info = kzalloc(sizeof(*tid_info), GFP_KERNEL);\r\nif (!tid_info) {\r\nqed_iscsi_stop(cdev);\r\nreturn -ENOMEM;\r\n}\r\nrc = qed_cxt_get_tid_mem_info(QED_LEADING_HWFN(cdev),\r\ntid_info);\r\nif (rc) {\r\nDP_NOTICE(cdev, "Failed to gather task information\n");\r\nqed_iscsi_stop(cdev);\r\nkfree(tid_info);\r\nreturn rc;\r\n}\r\ntasks->size = tid_info->tid_size;\r\ntasks->num_tids_per_block = tid_info->num_tids_per_block;\r\nmemcpy(tasks->blocks, tid_info->blocks,\r\nMAX_TID_BLOCKS_ISCSI * sizeof(u8 *));\r\nkfree(tid_info);\r\nreturn 0;\r\n}\r\nstatic int qed_iscsi_acquire_conn(struct qed_dev *cdev,\r\nu32 *handle,\r\nu32 *fw_cid, void __iomem **p_doorbell)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nint rc;\r\nhash_con = kzalloc(sizeof(*hash_con), GFP_ATOMIC);\r\nif (!hash_con)\r\nreturn -ENOMEM;\r\nrc = qed_iscsi_acquire_connection(QED_LEADING_HWFN(cdev), NULL,\r\n&hash_con->con);\r\nif (rc) {\r\nDP_NOTICE(cdev, "Failed to acquire Connection\n");\r\nkfree(hash_con);\r\nreturn rc;\r\n}\r\n*handle = hash_con->con->icid;\r\n*fw_cid = hash_con->con->fw_cid;\r\nhash_add(cdev->connections, &hash_con->node, *handle);\r\nif (p_doorbell)\r\n*p_doorbell = qed_iscsi_get_db_addr(QED_LEADING_HWFN(cdev),\r\n*handle);\r\nreturn 0;\r\n}\r\nstatic int qed_iscsi_release_conn(struct qed_dev *cdev, u32 handle)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\nhlist_del(&hash_con->node);\r\nqed_iscsi_release_connection(QED_LEADING_HWFN(cdev), hash_con->con);\r\nkfree(hash_con);\r\nreturn 0;\r\n}\r\nstatic int qed_iscsi_offload_conn(struct qed_dev *cdev,\r\nu32 handle,\r\nstruct qed_iscsi_params_offload *conn_info)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nstruct qed_iscsi_conn *con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\ncon = hash_con->con;\r\nether_addr_copy(con->local_mac, conn_info->src.mac);\r\nether_addr_copy(con->remote_mac, conn_info->dst.mac);\r\nmemcpy(con->local_ip, conn_info->src.ip, sizeof(con->local_ip));\r\nmemcpy(con->remote_ip, conn_info->dst.ip, sizeof(con->remote_ip));\r\ncon->local_port = conn_info->src.port;\r\ncon->remote_port = conn_info->dst.port;\r\ncon->layer_code = conn_info->layer_code;\r\ncon->sq_pbl_addr = conn_info->sq_pbl_addr;\r\ncon->initial_ack = conn_info->initial_ack;\r\ncon->vlan_id = conn_info->vlan_id;\r\ncon->tcp_flags = conn_info->tcp_flags;\r\ncon->ip_version = conn_info->ip_version;\r\ncon->default_cq = conn_info->default_cq;\r\ncon->ka_max_probe_cnt = conn_info->ka_max_probe_cnt;\r\ncon->dup_ack_theshold = conn_info->dup_ack_theshold;\r\ncon->rcv_next = conn_info->rcv_next;\r\ncon->snd_una = conn_info->snd_una;\r\ncon->snd_next = conn_info->snd_next;\r\ncon->snd_max = conn_info->snd_max;\r\ncon->snd_wnd = conn_info->snd_wnd;\r\ncon->rcv_wnd = conn_info->rcv_wnd;\r\ncon->snd_wl1 = conn_info->snd_wl1;\r\ncon->cwnd = conn_info->cwnd;\r\ncon->ss_thresh = conn_info->ss_thresh;\r\ncon->srtt = conn_info->srtt;\r\ncon->rtt_var = conn_info->rtt_var;\r\ncon->ts_time = conn_info->ts_time;\r\ncon->ts_recent = conn_info->ts_recent;\r\ncon->ts_recent_age = conn_info->ts_recent_age;\r\ncon->total_rt = conn_info->total_rt;\r\ncon->ka_timeout_delta = conn_info->ka_timeout_delta;\r\ncon->rt_timeout_delta = conn_info->rt_timeout_delta;\r\ncon->dup_ack_cnt = conn_info->dup_ack_cnt;\r\ncon->snd_wnd_probe_cnt = conn_info->snd_wnd_probe_cnt;\r\ncon->ka_probe_cnt = conn_info->ka_probe_cnt;\r\ncon->rt_cnt = conn_info->rt_cnt;\r\ncon->flow_label = conn_info->flow_label;\r\ncon->ka_timeout = conn_info->ka_timeout;\r\ncon->ka_interval = conn_info->ka_interval;\r\ncon->max_rt_time = conn_info->max_rt_time;\r\ncon->initial_rcv_wnd = conn_info->initial_rcv_wnd;\r\ncon->ttl = conn_info->ttl;\r\ncon->tos_or_tc = conn_info->tos_or_tc;\r\ncon->remote_port = conn_info->remote_port;\r\ncon->local_port = conn_info->local_port;\r\ncon->mss = conn_info->mss;\r\ncon->snd_wnd_scale = conn_info->snd_wnd_scale;\r\ncon->rcv_wnd_scale = conn_info->rcv_wnd_scale;\r\ncon->ts_ticks_per_second = conn_info->ts_ticks_per_second;\r\ncon->da_timeout_value = conn_info->da_timeout_value;\r\ncon->ack_frequency = conn_info->ack_frequency;\r\ncon->offl_flags = 0x1;\r\nreturn qed_sp_iscsi_conn_offload(QED_LEADING_HWFN(cdev), con,\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\n}\r\nstatic int qed_iscsi_update_conn(struct qed_dev *cdev,\r\nu32 handle,\r\nstruct qed_iscsi_params_update *conn_info)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nstruct qed_iscsi_conn *con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\ncon = hash_con->con;\r\ncon->update_flag = conn_info->update_flag;\r\ncon->max_seq_size = conn_info->max_seq_size;\r\ncon->max_recv_pdu_length = conn_info->max_recv_pdu_length;\r\ncon->max_send_pdu_length = conn_info->max_send_pdu_length;\r\ncon->first_seq_length = conn_info->first_seq_length;\r\ncon->exp_stat_sn = conn_info->exp_stat_sn;\r\nreturn qed_sp_iscsi_conn_update(QED_LEADING_HWFN(cdev), con,\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\n}\r\nstatic int qed_iscsi_clear_conn_sq(struct qed_dev *cdev, u32 handle)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\nreturn qed_sp_iscsi_conn_clear_sq(QED_LEADING_HWFN(cdev),\r\nhash_con->con,\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\n}\r\nstatic int qed_iscsi_destroy_conn(struct qed_dev *cdev,\r\nu32 handle, u8 abrt_conn)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\nhash_con->con->abortive_dsconnect = abrt_conn;\r\nreturn qed_sp_iscsi_conn_terminate(QED_LEADING_HWFN(cdev),\r\nhash_con->con,\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\n}\r\nstatic int qed_iscsi_stats(struct qed_dev *cdev, struct qed_iscsi_stats *stats)\r\n{\r\nreturn qed_iscsi_get_stats(QED_LEADING_HWFN(cdev), stats);\r\n}\r\nstatic int qed_iscsi_change_mac(struct qed_dev *cdev,\r\nu32 handle, const u8 *mac)\r\n{\r\nstruct qed_hash_iscsi_con *hash_con;\r\nhash_con = qed_iscsi_get_hash(cdev, handle);\r\nif (!hash_con) {\r\nDP_NOTICE(cdev, "Failed to find connection for handle %d\n",\r\nhandle);\r\nreturn -EINVAL;\r\n}\r\nreturn qed_sp_iscsi_mac_update(QED_LEADING_HWFN(cdev),\r\nhash_con->con,\r\nQED_SPQ_MODE_EBLOCK, NULL);\r\n}\r\nvoid qed_get_protocol_stats_iscsi(struct qed_dev *cdev,\r\nstruct qed_mcp_iscsi_stats *stats)\r\n{\r\nstruct qed_iscsi_stats proto_stats;\r\nmemset(&proto_stats, 0, sizeof(proto_stats));\r\nif (qed_iscsi_stats(cdev, &proto_stats)) {\r\nDP_VERBOSE(cdev, QED_MSG_STORAGE,\r\n"Failed to collect ISCSI statistics\n");\r\nreturn;\r\n}\r\nstats->rx_pdus = proto_stats.iscsi_rx_total_pdu_cnt;\r\nstats->tx_pdus = proto_stats.iscsi_tx_total_pdu_cnt;\r\nstats->rx_bytes = proto_stats.iscsi_rx_bytes_cnt;\r\nstats->tx_bytes = proto_stats.iscsi_tx_bytes_cnt;\r\n}\r\nconst struct qed_iscsi_ops *qed_get_iscsi_ops(void)\r\n{\r\nreturn &qed_iscsi_ops_pass;\r\n}\r\nvoid qed_put_iscsi_ops(void)\r\n{\r\n}

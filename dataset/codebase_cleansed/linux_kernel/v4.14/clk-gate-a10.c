static unsigned long socfpga_gate_clk_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct socfpga_gate_clk *socfpgaclk = to_socfpga_gate_clk(hwclk);\r\nu32 div = 1, val;\r\nif (socfpgaclk->fixed_div)\r\ndiv = socfpgaclk->fixed_div;\r\nelse if (socfpgaclk->div_reg) {\r\nval = readl(socfpgaclk->div_reg) >> socfpgaclk->shift;\r\nval &= GENMASK(socfpgaclk->width - 1, 0);\r\ndiv = (1 << val);\r\n}\r\nreturn parent_rate / div;\r\n}\r\nstatic int socfpga_clk_prepare(struct clk_hw *hwclk)\r\n{\r\nstruct socfpga_gate_clk *socfpgaclk = to_socfpga_gate_clk(hwclk);\r\nint i;\r\nu32 hs_timing;\r\nu32 clk_phase[2];\r\nif (socfpgaclk->clk_phase[0] || socfpgaclk->clk_phase[1]) {\r\nfor (i = 0; i < ARRAY_SIZE(clk_phase); i++) {\r\nswitch (socfpgaclk->clk_phase[i]) {\r\ncase 0:\r\nclk_phase[i] = 0;\r\nbreak;\r\ncase 45:\r\nclk_phase[i] = 1;\r\nbreak;\r\ncase 90:\r\nclk_phase[i] = 2;\r\nbreak;\r\ncase 135:\r\nclk_phase[i] = 3;\r\nbreak;\r\ncase 180:\r\nclk_phase[i] = 4;\r\nbreak;\r\ncase 225:\r\nclk_phase[i] = 5;\r\nbreak;\r\ncase 270:\r\nclk_phase[i] = 6;\r\nbreak;\r\ncase 315:\r\nclk_phase[i] = 7;\r\nbreak;\r\ndefault:\r\nclk_phase[i] = 0;\r\nbreak;\r\n}\r\n}\r\nhs_timing = SYSMGR_SDMMC_CTRL_SET_AS10(clk_phase[0], clk_phase[1]);\r\nif (!IS_ERR(socfpgaclk->sys_mgr_base_addr))\r\nregmap_write(socfpgaclk->sys_mgr_base_addr,\r\nSYSMGR_SDMMCGRP_CTRL_OFFSET, hs_timing);\r\nelse\r\npr_err("%s: cannot set clk_phase because sys_mgr_base_addr is not available!\n",\r\n__func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init __socfpga_gate_init(struct device_node *node,\r\nconst struct clk_ops *ops)\r\n{\r\nu32 clk_gate[2];\r\nu32 div_reg[3];\r\nu32 clk_phase[2];\r\nu32 fixed_div;\r\nstruct clk *clk;\r\nstruct socfpga_gate_clk *socfpga_clk;\r\nconst char *clk_name = node->name;\r\nconst char *parent_name[SOCFPGA_MAX_PARENTS];\r\nstruct clk_init_data init;\r\nint rc;\r\nsocfpga_clk = kzalloc(sizeof(*socfpga_clk), GFP_KERNEL);\r\nif (WARN_ON(!socfpga_clk))\r\nreturn;\r\nrc = of_property_read_u32_array(node, "clk-gate", clk_gate, 2);\r\nif (rc)\r\nclk_gate[0] = 0;\r\nif (clk_gate[0]) {\r\nsocfpga_clk->hw.reg = clk_mgr_a10_base_addr + clk_gate[0];\r\nsocfpga_clk->hw.bit_idx = clk_gate[1];\r\ngateclk_ops.enable = clk_gate_ops.enable;\r\ngateclk_ops.disable = clk_gate_ops.disable;\r\n}\r\nrc = of_property_read_u32(node, "fixed-divider", &fixed_div);\r\nif (rc)\r\nsocfpga_clk->fixed_div = 0;\r\nelse\r\nsocfpga_clk->fixed_div = fixed_div;\r\nrc = of_property_read_u32_array(node, "div-reg", div_reg, 3);\r\nif (!rc) {\r\nsocfpga_clk->div_reg = clk_mgr_a10_base_addr + div_reg[0];\r\nsocfpga_clk->shift = div_reg[1];\r\nsocfpga_clk->width = div_reg[2];\r\n} else {\r\nsocfpga_clk->div_reg = NULL;\r\n}\r\nrc = of_property_read_u32_array(node, "clk-phase", clk_phase, 2);\r\nif (!rc) {\r\nsocfpga_clk->clk_phase[0] = clk_phase[0];\r\nsocfpga_clk->clk_phase[1] = clk_phase[1];\r\nsocfpga_clk->sys_mgr_base_addr =\r\nsyscon_regmap_lookup_by_compatible("altr,sys-mgr");\r\nif (IS_ERR(socfpga_clk->sys_mgr_base_addr)) {\r\npr_err("%s: failed to find altr,sys-mgr regmap!\n",\r\n__func__);\r\nreturn;\r\n}\r\n}\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\ninit.name = clk_name;\r\ninit.ops = ops;\r\ninit.flags = 0;\r\ninit.num_parents = of_clk_parent_fill(node, parent_name, SOCFPGA_MAX_PARENTS);\r\ninit.parent_names = parent_name;\r\nsocfpga_clk->hw.hw.init = &init;\r\nclk = clk_register(NULL, &socfpga_clk->hw.hw);\r\nif (WARN_ON(IS_ERR(clk))) {\r\nkfree(socfpga_clk);\r\nreturn;\r\n}\r\nrc = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nif (WARN_ON(rc))\r\nreturn;\r\n}\r\nvoid __init socfpga_a10_gate_init(struct device_node *node)\r\n{\r\n__socfpga_gate_init(node, &gateclk_ops);\r\n}

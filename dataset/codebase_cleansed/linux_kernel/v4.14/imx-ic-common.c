static int imx_ic_probe(struct platform_device *pdev)\r\n{\r\nstruct imx_media_internal_sd_platformdata *pdata;\r\nstruct imx_ic_priv *priv;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, &priv->sd);\r\npriv->dev = &pdev->dev;\r\npdata = priv->dev->platform_data;\r\npriv->ipu_id = pdata->ipu_id;\r\nswitch (pdata->grp_id) {\r\ncase IMX_MEDIA_GRP_ID_IC_PRP:\r\npriv->task_id = IC_TASK_PRP;\r\nbreak;\r\ncase IMX_MEDIA_GRP_ID_IC_PRPENC:\r\npriv->task_id = IC_TASK_ENCODER;\r\nbreak;\r\ncase IMX_MEDIA_GRP_ID_IC_PRPVF:\r\npriv->task_id = IC_TASK_VIEWFINDER;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nv4l2_subdev_init(&priv->sd, ic_ops[priv->task_id]->subdev_ops);\r\nv4l2_set_subdevdata(&priv->sd, priv);\r\npriv->sd.internal_ops = ic_ops[priv->task_id]->internal_ops;\r\npriv->sd.entity.ops = ic_ops[priv->task_id]->entity_ops;\r\npriv->sd.entity.function = MEDIA_ENT_F_PROC_VIDEO_SCALER;\r\npriv->sd.dev = &pdev->dev;\r\npriv->sd.owner = THIS_MODULE;\r\npriv->sd.flags = V4L2_SUBDEV_FL_HAS_DEVNODE | V4L2_SUBDEV_FL_HAS_EVENTS;\r\npriv->sd.grp_id = pdata->grp_id;\r\nstrncpy(priv->sd.name, pdata->sd_name, sizeof(priv->sd.name));\r\nret = ic_ops[priv->task_id]->init(priv);\r\nif (ret)\r\nreturn ret;\r\nret = v4l2_async_register_subdev(&priv->sd);\r\nif (ret)\r\nic_ops[priv->task_id]->remove(priv);\r\nreturn ret;\r\n}\r\nstatic int imx_ic_remove(struct platform_device *pdev)\r\n{\r\nstruct v4l2_subdev *sd = platform_get_drvdata(pdev);\r\nstruct imx_ic_priv *priv = container_of(sd, struct imx_ic_priv, sd);\r\nv4l2_info(sd, "Removing\n");\r\nic_ops[priv->task_id]->remove(priv);\r\nv4l2_async_unregister_subdev(sd);\r\nmedia_entity_cleanup(&sd->entity);\r\nreturn 0;\r\n}

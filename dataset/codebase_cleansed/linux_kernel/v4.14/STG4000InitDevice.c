static u32 InitSDRAMRegisters(volatile STG4000REG __iomem *pSTGReg,\r\nu32 dwSubSysID, u32 dwRevID)\r\n{\r\nu32 adwSDRAMArgCfg0[] = { 0xa0, 0x80, 0xa0, 0xa0, 0xa0 };\r\nu32 adwSDRAMCfg1[] = { 0x8732, 0x8732, 0xa732, 0xa732, 0x8732 };\r\nu32 adwSDRAMCfg2[] = { 0x87d2, 0x87d2, 0xa7d2, 0x87d2, 0xa7d2 };\r\nu32 adwSDRAMRsh[] = { 36, 39, 40 };\r\nu32 adwChipSpeed[] = { 110, 120, 125 };\r\nu32 dwMemTypeIdx;\r\nu32 dwChipSpeedIdx;\r\ndwMemTypeIdx = (dwSubSysID & 0x70) >> 4;\r\ndwChipSpeedIdx = (dwSubSysID & 0x180) >> 7;\r\nif (dwMemTypeIdx > 4 || dwChipSpeedIdx > 2)\r\nreturn 0;\r\nSTG_WRITE_REG(SDRAMArbiterConf, adwSDRAMArgCfg0[dwMemTypeIdx]);\r\nif (dwRevID < 5) {\r\nSTG_WRITE_REG(SDRAMConf0, 0x49A1);\r\nSTG_WRITE_REG(SDRAMConf1, adwSDRAMCfg1[dwMemTypeIdx]);\r\n} else {\r\nSTG_WRITE_REG(SDRAMConf0, 0x4DF1);\r\nSTG_WRITE_REG(SDRAMConf1, adwSDRAMCfg2[dwMemTypeIdx]);\r\n}\r\nSTG_WRITE_REG(SDRAMConf2, 0x31);\r\nSTG_WRITE_REG(SDRAMRefresh, adwSDRAMRsh[dwChipSpeedIdx]);\r\nreturn adwChipSpeed[dwChipSpeedIdx] * 10000;\r\n}\r\nu32 ProgramClock(u32 refClock,\r\nu32 coreClock,\r\nu32 * FOut, u32 * ROut, u32 * POut)\r\n{\r\nu32 R = 0, F = 0, OD = 0, ODIndex = 0;\r\nu32 ulBestR = 0, ulBestF = 0, ulBestOD = 0;\r\nu32 ulBestVCO = 0, ulBestClk = 0, ulBestScore = 0;\r\nu32 ulScore, ulPhaseScore, ulVcoScore;\r\nu32 ulTmp = 0, ulVCO;\r\nu32 ulScaleClockReq, ulMinClock, ulMaxClock;\r\nu32 ODValues[] = { 1, 2, 0 };\r\ncoreClock *= 100;\r\nrefClock *= 1000;\r\nulMinClock = coreClock - (coreClock >> 8);\r\nulMaxClock = coreClock + (coreClock >> 8);\r\nulScaleClockReq = coreClock >> STG4K3_PLL_SCALER;\r\nfor (ODIndex = 0; ODIndex < 3; ODIndex++) {\r\nOD = ODValues[ODIndex];\r\nR = STG4K3_PLL_MIN_R;\r\nwhile (R <= STG4K3_PLL_MAX_R) {\r\nulTmp = R * (ulScaleClockReq << OD);\r\nF = (u32)(ulTmp / (refClock >> STG4K3_PLL_SCALER));\r\nif (F > STG4K3_PLL_MIN_F)\r\nF--;\r\nwhile ((F >= STG4K3_PLL_MIN_F) &&\r\n(F <= STG4K3_PLL_MAX_F)) {\r\nulVCO = refClock / R;\r\nulVCO = F * ulVCO;\r\nif ((ulVCO >= STG4K3_PLL_MINR_VCO) &&\r\n((ulVCO <= STG4K3_PLL_MAXR_VCO) ||\r\n((coreClock > STG4K3_PLL_MAXR_VCO)\r\n&& (ulVCO <= STG4K3_PLL_MAX_VCO)))) {\r\nulTmp = (ulVCO >> OD);\r\nif ((ulTmp >= ulMinClock)\r\n&& (ulTmp <= ulMaxClock)) {\r\nulPhaseScore = (((refClock / R) - (refClock / STG4K3_PLL_MAX_R))) / ((refClock - (refClock / STG4K3_PLL_MAX_R)) >> 10);\r\nulVcoScore = ((ulVCO - STG4K3_PLL_MINR_VCO)) / ((STG4K3_PLL_MAXR_VCO - STG4K3_PLL_MINR_VCO) >> 10);\r\nulScore = ulPhaseScore + ulVcoScore;\r\nif (!ulBestScore) {\r\nulBestVCO = ulVCO;\r\nulBestOD = OD;\r\nulBestF = F;\r\nulBestR = R;\r\nulBestClk = ulTmp;\r\nulBestScore =\r\nulScore;\r\n}\r\nif ((ulScore >= ulBestScore) && (OD > 0)) {\r\nulBestVCO = ulVCO;\r\nulBestOD = OD;\r\nulBestF = F;\r\nulBestR = R;\r\nulBestClk = ulTmp;\r\nulBestScore =\r\nulScore;\r\n}\r\n}\r\n}\r\nF++;\r\n}\r\nR++;\r\n}\r\n}\r\nif (ulBestScore) {\r\n*ROut = ulBestR;\r\n*FOut = ulBestF;\r\nif ((ulBestOD == 2) || (ulBestOD == 3)) {\r\n*POut = 3;\r\n} else\r\n*POut = ulBestOD;\r\n}\r\nreturn (ulBestClk);\r\n}\r\nint SetCoreClockPLL(volatile STG4000REG __iomem *pSTGReg, struct pci_dev *pDev)\r\n{\r\nu32 F, R, P;\r\nu16 core_pll = 0, sub;\r\nu32 ulCoreClock;\r\nu32 tmp;\r\nu32 ulChipSpeed;\r\nSTG_WRITE_REG(IntMask, 0xFFFF);\r\ntmp = STG_READ_REG(Thread0Enable);\r\nCLEAR_BIT(0);\r\nSTG_WRITE_REG(Thread0Enable, tmp);\r\ntmp = STG_READ_REG(Thread1Enable);\r\nCLEAR_BIT(0);\r\nSTG_WRITE_REG(Thread1Enable, tmp);\r\nSTG_WRITE_REG(SoftwareReset,\r\nPMX2_SOFTRESET_REG_RST | PMX2_SOFTRESET_ROM_RST);\r\nSTG_WRITE_REG(SoftwareReset,\r\nPMX2_SOFTRESET_REG_RST | PMX2_SOFTRESET_TA_RST |\r\nPMX2_SOFTRESET_ROM_RST);\r\nSTG_WRITE_REG(TAConfiguration, 0);\r\nSTG_WRITE_REG(SoftwareReset,\r\nPMX2_SOFTRESET_REG_RST | PMX2_SOFTRESET_ROM_RST);\r\nSTG_WRITE_REG(SoftwareReset,\r\nPMX2_SOFTRESET_REG_RST | PMX2_SOFTRESET_TA_RST |\r\nPMX2_SOFTRESET_ROM_RST);\r\npci_read_config_word(pDev, PCI_CONFIG_SUBSYS_ID, &sub);\r\nulChipSpeed = InitSDRAMRegisters(pSTGReg, (u32)sub,\r\n(u32)pDev->revision);\r\nif (ulChipSpeed == 0)\r\nreturn -EINVAL;\r\nulCoreClock = ProgramClock(REF_FREQ, CORE_PLL_FREQ, &F, &R, &P);\r\ncore_pll |= ((P) | ((F - 2) << 2) | ((R - 2) << 11));\r\ntmp = ((CORE_PLL_MODE_REG_0_7 << 8) | (core_pll & 0x00FF));\r\npci_write_config_word(pDev, CorePllControl, tmp);\r\nOS_DELAY(1000000);\r\ntmp |= SET_BIT(14);\r\npci_write_config_word(pDev, CorePllControl, tmp);\r\nOS_DELAY(1000000);\r\ntmp =\r\n((CORE_PLL_MODE_REG_8_15 << 8) | ((core_pll & 0xFF00) >> 8));\r\npci_write_config_word(pDev, CorePllControl, tmp);\r\nOS_DELAY(1000000);\r\ntmp |= SET_BIT(14);\r\npci_write_config_word(pDev, CorePllControl, tmp);\r\nOS_DELAY(1000000);\r\nSTG_WRITE_REG(SoftwareReset, PMX2_SOFTRESET_ALL);\r\n#if 0\r\ntmp = ((STG_READ_REG(Thread0Enable)) | SET_BIT(0));\r\nSTG_WRITE_REG(Thread0Enable, tmp);\r\ntmp = ((STG_READ_REG(Thread1Enable)) | SET_BIT(0));\r\nSTG_WRITE_REG(Thread1Enable, tmp);\r\n#endif\r\nreturn 0;\r\n}

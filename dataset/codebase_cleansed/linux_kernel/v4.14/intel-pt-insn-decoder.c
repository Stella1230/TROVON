static void intel_pt_insn_decoder(struct insn *insn,\r\nstruct intel_pt_insn *intel_pt_insn)\r\n{\r\nenum intel_pt_insn_op op = INTEL_PT_OP_OTHER;\r\nenum intel_pt_insn_branch branch = INTEL_PT_BR_NO_BRANCH;\r\nint ext;\r\nintel_pt_insn->rel = 0;\r\nif (insn_is_avx(insn)) {\r\nintel_pt_insn->op = INTEL_PT_OP_OTHER;\r\nintel_pt_insn->branch = INTEL_PT_BR_NO_BRANCH;\r\nintel_pt_insn->length = insn->length;\r\nreturn;\r\n}\r\nswitch (insn->opcode.bytes[0]) {\r\ncase 0xf:\r\nswitch (insn->opcode.bytes[1]) {\r\ncase 0x05:\r\ncase 0x34:\r\nop = INTEL_PT_OP_SYSCALL;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0x07:\r\ncase 0x35:\r\nop = INTEL_PT_OP_SYSRET;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0x80 ... 0x8f:\r\nop = INTEL_PT_OP_JCC;\r\nbranch = INTEL_PT_BR_CONDITIONAL;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x70 ... 0x7f:\r\nop = INTEL_PT_OP_JCC;\r\nbranch = INTEL_PT_BR_CONDITIONAL;\r\nbreak;\r\ncase 0xc2:\r\ncase 0xc3:\r\ncase 0xca:\r\ncase 0xcb:\r\nop = INTEL_PT_OP_RET;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0xcf:\r\nop = INTEL_PT_OP_IRET;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0xcc ... 0xce:\r\nop = INTEL_PT_OP_INT;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0xe8:\r\nop = INTEL_PT_OP_CALL;\r\nbranch = INTEL_PT_BR_UNCONDITIONAL;\r\nbreak;\r\ncase 0x9a:\r\nop = INTEL_PT_OP_CALL;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0xe0 ... 0xe2:\r\nop = INTEL_PT_OP_LOOP;\r\nbranch = INTEL_PT_BR_CONDITIONAL;\r\nbreak;\r\ncase 0xe3:\r\nop = INTEL_PT_OP_JCC;\r\nbranch = INTEL_PT_BR_CONDITIONAL;\r\nbreak;\r\ncase 0xe9:\r\ncase 0xeb:\r\nop = INTEL_PT_OP_JMP;\r\nbranch = INTEL_PT_BR_UNCONDITIONAL;\r\nbreak;\r\ncase 0xea:\r\nop = INTEL_PT_OP_JMP;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 0xff:\r\next = (insn->modrm.bytes[0] >> 3) & 0x7;\r\nswitch (ext) {\r\ncase 2:\r\ncase 3:\r\nop = INTEL_PT_OP_CALL;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\nop = INTEL_PT_OP_JMP;\r\nbranch = INTEL_PT_BR_INDIRECT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nintel_pt_insn->op = op;\r\nintel_pt_insn->branch = branch;\r\nintel_pt_insn->length = insn->length;\r\nif (branch == INTEL_PT_BR_CONDITIONAL ||\r\nbranch == INTEL_PT_BR_UNCONDITIONAL) {\r\n#if __BYTE_ORDER == __BIG_ENDIAN\r\nswitch (insn->immediate.nbytes) {\r\ncase 1:\r\nintel_pt_insn->rel = insn->immediate.value;\r\nbreak;\r\ncase 2:\r\nintel_pt_insn->rel =\r\nbswap_16((short)insn->immediate.value);\r\nbreak;\r\ncase 4:\r\nintel_pt_insn->rel = bswap_32(insn->immediate.value);\r\nbreak;\r\ndefault:\r\nintel_pt_insn->rel = 0;\r\nbreak;\r\n}\r\n#else\r\nintel_pt_insn->rel = insn->immediate.value;\r\n#endif\r\n}\r\n}\r\nint intel_pt_get_insn(const unsigned char *buf, size_t len, int x86_64,\r\nstruct intel_pt_insn *intel_pt_insn)\r\n{\r\nstruct insn insn;\r\ninsn_init(&insn, buf, len, x86_64);\r\ninsn_get_length(&insn);\r\nif (!insn_complete(&insn) || insn.length > len)\r\nreturn -1;\r\nintel_pt_insn_decoder(&insn, intel_pt_insn);\r\nif (insn.length < INTEL_PT_INSN_BUF_SZ)\r\nmemcpy(intel_pt_insn->buf, buf, insn.length);\r\nelse\r\nmemcpy(intel_pt_insn->buf, buf, INTEL_PT_INSN_BUF_SZ);\r\nreturn 0;\r\n}\r\nconst char *dump_insn(struct perf_insn *x, uint64_t ip __maybe_unused,\r\nu8 *inbuf, int inlen, int *lenp)\r\n{\r\nstruct insn insn;\r\nint n, i;\r\nint left;\r\ninsn_init(&insn, inbuf, inlen, x->is64bit);\r\ninsn_get_length(&insn);\r\nif (!insn_complete(&insn) || insn.length > inlen)\r\nreturn "<bad>";\r\nif (lenp)\r\n*lenp = insn.length;\r\nleft = sizeof(x->out);\r\nn = snprintf(x->out, left, "insn: ");\r\nleft -= n;\r\nfor (i = 0; i < insn.length; i++) {\r\nn += snprintf(x->out + n, left, "%02x ", inbuf[i]);\r\nleft -= n;\r\n}\r\nreturn x->out;\r\n}\r\nconst char *intel_pt_insn_name(enum intel_pt_insn_op op)\r\n{\r\nreturn branch_name[op];\r\n}\r\nint intel_pt_insn_desc(const struct intel_pt_insn *intel_pt_insn, char *buf,\r\nsize_t buf_len)\r\n{\r\nswitch (intel_pt_insn->branch) {\r\ncase INTEL_PT_BR_CONDITIONAL:\r\ncase INTEL_PT_BR_UNCONDITIONAL:\r\nreturn snprintf(buf, buf_len, "%s %s%d",\r\nintel_pt_insn_name(intel_pt_insn->op),\r\nintel_pt_insn->rel > 0 ? "+" : "",\r\nintel_pt_insn->rel);\r\ncase INTEL_PT_BR_NO_BRANCH:\r\ncase INTEL_PT_BR_INDIRECT:\r\nreturn snprintf(buf, buf_len, "%s",\r\nintel_pt_insn_name(intel_pt_insn->op));\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint intel_pt_insn_type(enum intel_pt_insn_op op)\r\n{\r\nswitch (op) {\r\ncase INTEL_PT_OP_OTHER:\r\nreturn 0;\r\ncase INTEL_PT_OP_CALL:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_CALL;\r\ncase INTEL_PT_OP_RET:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_RETURN;\r\ncase INTEL_PT_OP_JCC:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_CONDITIONAL;\r\ncase INTEL_PT_OP_JMP:\r\nreturn PERF_IP_FLAG_BRANCH;\r\ncase INTEL_PT_OP_LOOP:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_CONDITIONAL;\r\ncase INTEL_PT_OP_IRET:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_RETURN |\r\nPERF_IP_FLAG_INTERRUPT;\r\ncase INTEL_PT_OP_INT:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_CALL |\r\nPERF_IP_FLAG_INTERRUPT;\r\ncase INTEL_PT_OP_SYSCALL:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_CALL |\r\nPERF_IP_FLAG_SYSCALLRET;\r\ncase INTEL_PT_OP_SYSRET:\r\nreturn PERF_IP_FLAG_BRANCH | PERF_IP_FLAG_RETURN |\r\nPERF_IP_FLAG_SYSCALLRET;\r\ndefault:\r\nreturn 0;\r\n}\r\n}

static u32 cros_ec_gpe_handler(acpi_handle gpe_device, u32 gpe_number,\r\nvoid *data)\r\n{\r\nreturn ACPI_INTERRUPT_HANDLED | ACPI_REENABLE_GPE;\r\n}\r\nstatic int cros_ec_get_ec_wake_gpe(struct device *dev)\r\n{\r\nstruct acpi_device *cros_acpi_dev;\r\nstruct acpi_device *adev;\r\nacpi_handle handle;\r\nacpi_status status;\r\nint ret;\r\ncros_acpi_dev = ACPI_COMPANION(dev);\r\nif (!cros_acpi_dev || !cros_acpi_dev->parent ||\r\n!cros_acpi_dev->parent->handle)\r\nreturn -EINVAL;\r\nstatus = acpi_get_handle(cros_acpi_dev->parent->handle, ACPI_LID_DEVICE,\r\n&handle);\r\nif (ACPI_FAILURE(status))\r\nreturn -EINVAL;\r\nret = acpi_bus_get_device(handle, &adev);\r\nif (ret)\r\nreturn ret;\r\nreturn adev->wakeup.gpe_number;\r\n}\r\nint cros_ec_acpi_install_gpe_handler(struct device *dev)\r\n{\r\nacpi_status status;\r\nec_wake_gpe = cros_ec_get_ec_wake_gpe(dev);\r\nif (ec_wake_gpe < 0)\r\nreturn ec_wake_gpe;\r\nstatus = acpi_install_gpe_handler(NULL, ec_wake_gpe,\r\nACPI_GPE_EDGE_TRIGGERED,\r\n&cros_ec_gpe_handler, NULL);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\ndev_info(dev, "Initialized, GPE = 0x%x\n", ec_wake_gpe);\r\nreturn 0;\r\n}\r\nvoid cros_ec_acpi_remove_gpe_handler(void)\r\n{\r\nacpi_status status;\r\nif (ec_wake_gpe < 0)\r\nreturn;\r\nstatus = acpi_remove_gpe_handler(NULL, ec_wake_gpe,\r\n&cros_ec_gpe_handler);\r\nif (ACPI_FAILURE(status))\r\npr_err("failed to remove gpe handler\n");\r\n}\r\nvoid cros_ec_acpi_clear_gpe(void)\r\n{\r\nif (ec_wake_gpe < 0)\r\nreturn;\r\nacpi_clear_gpe(NULL, ec_wake_gpe);\r\n}

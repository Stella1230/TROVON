static int gpio_reg_get_direction(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nreturn r->direction & BIT(offset) ? 1 : 0;\r\n}\r\nstatic int gpio_reg_direction_output(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nif (r->direction & BIT(offset))\r\nreturn -ENOTSUPP;\r\ngc->set(gc, offset, value);\r\nreturn 0;\r\n}\r\nstatic int gpio_reg_direction_input(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nreturn r->direction & BIT(offset) ? 0 : -ENOTSUPP;\r\n}\r\nstatic void gpio_reg_set(struct gpio_chip *gc, unsigned offset, int value)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nunsigned long flags;\r\nu32 val, mask = BIT(offset);\r\nspin_lock_irqsave(&r->lock, flags);\r\nval = r->out;\r\nif (value)\r\nval |= mask;\r\nelse\r\nval &= ~mask;\r\nr->out = val;\r\nwritel_relaxed(val, r->reg);\r\nspin_unlock_irqrestore(&r->lock, flags);\r\n}\r\nstatic int gpio_reg_get(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nu32 val, mask = BIT(offset);\r\nif (r->direction & mask) {\r\nreadl_relaxed(r->reg);\r\nval = readl_relaxed(r->reg);\r\n} else {\r\nval = r->out;\r\n}\r\nreturn !!(val & mask);\r\n}\r\nstatic void gpio_reg_set_multiple(struct gpio_chip *gc, unsigned long *mask,\r\nunsigned long *bits)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&r->lock, flags);\r\nr->out = (r->out & ~*mask) | (*bits & *mask);\r\nwritel_relaxed(r->out, r->reg);\r\nspin_unlock_irqrestore(&r->lock, flags);\r\n}\r\nstatic int gpio_reg_to_irq(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nint irq = r->irqs[offset];\r\nif (irq >= 0 && r->irqdomain)\r\nirq = irq_find_mapping(r->irqdomain, irq);\r\nreturn irq;\r\n}\r\nstruct gpio_chip *gpio_reg_init(struct device *dev, void __iomem *reg,\r\nint base, int num, const char *label, u32 direction, u32 def_out,\r\nconst char *const *names, struct irq_domain *irqdom, const int *irqs)\r\n{\r\nstruct gpio_reg *r;\r\nint ret;\r\nif (dev)\r\nr = devm_kzalloc(dev, sizeof(*r), GFP_KERNEL);\r\nelse\r\nr = kzalloc(sizeof(*r), GFP_KERNEL);\r\nif (!r)\r\nreturn ERR_PTR(-ENOMEM);\r\nspin_lock_init(&r->lock);\r\nr->gc.label = label;\r\nr->gc.get_direction = gpio_reg_get_direction;\r\nr->gc.direction_input = gpio_reg_direction_input;\r\nr->gc.direction_output = gpio_reg_direction_output;\r\nr->gc.set = gpio_reg_set;\r\nr->gc.get = gpio_reg_get;\r\nr->gc.set_multiple = gpio_reg_set_multiple;\r\nif (irqs)\r\nr->gc.to_irq = gpio_reg_to_irq;\r\nr->gc.base = base;\r\nr->gc.ngpio = num;\r\nr->gc.names = names;\r\nr->direction = direction;\r\nr->out = def_out;\r\nr->reg = reg;\r\nr->irqs = irqs;\r\nif (dev)\r\nret = devm_gpiochip_add_data(dev, &r->gc, r);\r\nelse\r\nret = gpiochip_add_data(&r->gc, r);\r\nreturn ret ? ERR_PTR(ret) : &r->gc;\r\n}\r\nint gpio_reg_resume(struct gpio_chip *gc)\r\n{\r\nstruct gpio_reg *r = to_gpio_reg(gc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&r->lock, flags);\r\nwritel_relaxed(r->out, r->reg);\r\nspin_unlock_irqrestore(&r->lock, flags);\r\nreturn 0;\r\n}

static void qed_enable_pf_rl(struct qed_hwfn *p_hwfn, bool pf_rl_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFENABLE_RT_OFFSET, pf_rl_en ? 1 : 0);\r\nif (pf_rl_en) {\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFVOQENABLE_RT_OFFSET,\r\n(1 << MAX_NUM_VOQS) - 1);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLPFPERIOD_RT_OFFSET, QM_RL_PERIOD_CLK_25M);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLPFPERIODTIMER_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nif (QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRPFRL_RT_OFFSET,\r\nQM_RL_UPPER_BOUND);\r\n}\r\n}\r\nstatic void qed_enable_pf_wfq(struct qed_hwfn *p_hwfn, bool pf_wfq_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQPFENABLE_RT_OFFSET, pf_wfq_en ? 1 : 0);\r\nif (pf_wfq_en && QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRPFWFQ_RT_OFFSET,\r\nQM_WFQ_UPPER_BOUND);\r\n}\r\nstatic void qed_enable_vport_rl(struct qed_hwfn *p_hwfn, bool vport_rl_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLGLBLENABLE_RT_OFFSET,\r\nvport_rl_en ? 1 : 0);\r\nif (vport_rl_en) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLPERIOD_0_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLPERIODTIMER_0_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nif (QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRGLBLRL_RT_OFFSET,\r\nQM_RL_UPPER_BOUND);\r\n}\r\n}\r\nstatic void qed_enable_vport_wfq(struct qed_hwfn *p_hwfn, bool vport_wfq_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQVPENABLE_RT_OFFSET,\r\nvport_wfq_en ? 1 : 0);\r\nif (vport_wfq_en && QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRVPWFQ_RT_OFFSET,\r\nQM_WFQ_UPPER_BOUND);\r\n}\r\nstatic void qed_cmdq_lines_voq_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 voq, u16 cmdq_lines)\r\n{\r\nu32 qm_line_crd;\r\nqm_line_crd = QM_VOQ_LINE_CRD(cmdq_lines);\r\nOVERWRITE_RT_REG(p_hwfn, PBF_CMDQ_LINES_RT_OFFSET(voq),\r\n(u32)cmdq_lines);\r\nSTORE_RT_REG(p_hwfn, QM_REG_VOQCRDLINE_RT_OFFSET + voq, qm_line_crd);\r\nSTORE_RT_REG(p_hwfn, QM_REG_VOQINITCRDLINE_RT_OFFSET + voq,\r\nqm_line_crd);\r\n}\r\nstatic void qed_cmdq_lines_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nu8 max_ports_per_engine,\r\nu8 max_phys_tcs_per_port,\r\nstruct init_qm_port_params port_params[MAX_NUM_PORTS])\r\n{\r\nu8 tc, voq, port_id, num_tcs_in_port;\r\nfor (voq = 0; voq < MAX_NUM_VOQS; voq++)\r\nSTORE_RT_REG(p_hwfn, PBF_CMDQ_LINES_RT_OFFSET(voq), 0);\r\nfor (port_id = 0; port_id < max_ports_per_engine; port_id++) {\r\nif (port_params[port_id].active) {\r\nu16 phys_lines, phys_lines_per_tc;\r\nphys_lines = port_params[port_id].num_pbf_cmd_lines -\r\nPBF_CMDQ_PURE_LB_LINES;\r\nnum_tcs_in_port = 0;\r\nfor (tc = 0; tc < NUM_OF_PHYS_TCS; tc++) {\r\nif (((port_params[port_id].active_phys_tcs >>\r\ntc) & 0x1) == 1)\r\nnum_tcs_in_port++;\r\n}\r\nphys_lines_per_tc = phys_lines / num_tcs_in_port;\r\nfor (tc = 0; tc < NUM_OF_PHYS_TCS; tc++) {\r\nif (((port_params[port_id].active_phys_tcs >>\r\ntc) & 0x1) != 1)\r\ncontinue;\r\nvoq = PHYS_VOQ(port_id, tc,\r\nmax_phys_tcs_per_port);\r\nqed_cmdq_lines_voq_rt_init(p_hwfn, voq,\r\nphys_lines_per_tc);\r\n}\r\nqed_cmdq_lines_voq_rt_init(p_hwfn, LB_VOQ(port_id),\r\nPBF_CMDQ_PURE_LB_LINES);\r\n}\r\n}\r\n}\r\nstatic void qed_btb_blocks_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nu8 max_ports_per_engine,\r\nu8 max_phys_tcs_per_port,\r\nstruct init_qm_port_params port_params[MAX_NUM_PORTS])\r\n{\r\nu32 usable_blocks, pure_lb_blocks, phys_blocks;\r\nu8 tc, voq, port_id, num_tcs_in_port;\r\nfor (port_id = 0; port_id < max_ports_per_engine; port_id++) {\r\nu32 temp;\r\nif (!port_params[port_id].active)\r\ncontinue;\r\nusable_blocks = port_params[port_id].num_btb_blocks -\r\nBTB_HEADROOM_BLOCKS;\r\nnum_tcs_in_port = 0;\r\nfor (tc = 0; tc < NUM_OF_PHYS_TCS; tc++) {\r\nif (((port_params[port_id].active_phys_tcs >>\r\ntc) & 0x1) == 1)\r\nnum_tcs_in_port++;\r\n}\r\npure_lb_blocks = (usable_blocks * BTB_PURE_LB_FACTOR) /\r\n(num_tcs_in_port * BTB_PURE_LB_FACTOR +\r\nBTB_PURE_LB_RATIO);\r\npure_lb_blocks = max_t(u32, BTB_JUMBO_PKT_BLOCKS,\r\npure_lb_blocks / BTB_PURE_LB_FACTOR);\r\nphys_blocks = (usable_blocks - pure_lb_blocks) /\r\nnum_tcs_in_port;\r\nfor (tc = 0; tc < NUM_OF_PHYS_TCS; tc++) {\r\nif (((port_params[port_id].active_phys_tcs >>\r\ntc) & 0x1) != 1)\r\ncontinue;\r\nvoq = PHYS_VOQ(port_id, tc,\r\nmax_phys_tcs_per_port);\r\nSTORE_RT_REG(p_hwfn, PBF_BTB_GUARANTEED_RT_OFFSET(voq),\r\nphys_blocks);\r\n}\r\ntemp = LB_VOQ(port_id);\r\nSTORE_RT_REG(p_hwfn, PBF_BTB_GUARANTEED_RT_OFFSET(temp),\r\npure_lb_blocks);\r\n}\r\n}\r\nstatic void qed_tx_pq_map_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_qm_pf_rt_init_params *p_params,\r\nu32 base_mem_addr_4kb)\r\n{\r\nstruct init_qm_vport_params *vport_params = p_params->vport_params;\r\nu16 num_pqs = p_params->num_pf_pqs + p_params->num_vf_pqs;\r\nu16 first_pq_group = p_params->start_pq / QM_PF_QUEUE_GROUP_SIZE;\r\nu16 last_pq_group = (p_params->start_pq + num_pqs - 1) /\r\nQM_PF_QUEUE_GROUP_SIZE;\r\nu16 i, pq_id, pq_group;\r\nu32 tx_pq_vf_mask[MAX_QM_TX_QUEUES / QM_PF_QUEUE_GROUP_SIZE] = { 0 };\r\nu32 num_tx_pq_vf_masks = MAX_QM_TX_QUEUES / QM_PF_QUEUE_GROUP_SIZE;\r\nu32 pq_mem_4kb = QM_PQ_MEM_4KB(p_params->num_pf_cids);\r\nu32 vport_pq_mem_4kb = QM_PQ_MEM_4KB(p_params->num_vf_cids);\r\nu32 mem_addr_4kb = base_mem_addr_4kb;\r\nfor (pq_group = first_pq_group; pq_group <= last_pq_group; pq_group++)\r\nSTORE_RT_REG(p_hwfn, QM_REG_PQTX2PF_0_RT_OFFSET + pq_group,\r\n(u32)(p_params->pf_id));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_0_RT_OFFSET,\r\nQM_PQ_SIZE_256B(p_params->num_pf_cids));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_1_RT_OFFSET,\r\nQM_PQ_SIZE_256B(p_params->num_vf_cids));\r\nfor (i = 0, pq_id = p_params->start_pq; i < num_pqs; i++, pq_id++) {\r\nu8 voq = VOQ(p_params->port_id, p_params->pq_params[i].tc_id,\r\np_params->max_phys_tcs_per_port);\r\nbool is_vf_pq = (i >= p_params->num_pf_pqs);\r\nstruct qm_rf_pq_map tx_pq_map;\r\nbool rl_valid = p_params->pq_params[i].rl_valid &&\r\n(p_params->pq_params[i].vport_id <\r\nMAX_QM_GLOBAL_RLS);\r\nu8 vport_id_in_pf = p_params->pq_params[i].vport_id -\r\np_params->start_vport;\r\nu16 *pq_ids = &vport_params[vport_id_in_pf].first_tx_pq_id[0];\r\nu16 first_tx_pq_id = pq_ids[p_params->pq_params[i].tc_id];\r\nif (first_tx_pq_id == QM_INVALID_PQ_ID) {\r\npq_ids[p_params->pq_params[i].tc_id] = pq_id;\r\nfirst_tx_pq_id = pq_id;\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPMAP_RT_OFFSET +\r\nfirst_tx_pq_id,\r\n(voq << QM_WFQ_VP_PQ_VOQ_SHIFT) |\r\n(p_params->pf_id <<\r\nQM_WFQ_VP_PQ_PF_SHIFT));\r\n}\r\nif (p_params->pq_params[i].rl_valid && !rl_valid)\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT ID for rate limiter configuration");\r\nmemset(&tx_pq_map, 0, sizeof(tx_pq_map));\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_PQ_VALID, 1);\r\nSET_FIELD(tx_pq_map.reg,\r\nQM_RF_PQ_MAP_RL_VALID, rl_valid ? 1 : 0);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_VP_PQ_ID, first_tx_pq_id);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_RL_ID,\r\nrl_valid ?\r\np_params->pq_params[i].vport_id : 0);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_VOQ, voq);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_WRR_WEIGHT_GROUP,\r\np_params->pq_params[i].wrr_group);\r\nSTORE_RT_REG(p_hwfn, QM_REG_TXPQMAP_RT_OFFSET + pq_id,\r\n*((u32 *)&tx_pq_map));\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_BASEADDRTXPQ_RT_OFFSET + pq_id,\r\nmem_addr_4kb);\r\nif (is_vf_pq) {\r\ntx_pq_vf_mask[pq_id /\r\nQM_PF_QUEUE_GROUP_SIZE] |=\r\nBIT((pq_id % QM_PF_QUEUE_GROUP_SIZE));\r\nmem_addr_4kb += vport_pq_mem_4kb;\r\n} else {\r\nmem_addr_4kb += pq_mem_4kb;\r\n}\r\n}\r\nfor (i = 0; i < num_tx_pq_vf_masks; i++)\r\nif (tx_pq_vf_mask[i])\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_MAXPQSIZETXSEL_0_RT_OFFSET + i,\r\ntx_pq_vf_mask[i]);\r\n}\r\nstatic void qed_other_pq_map_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 port_id,\r\nu8 pf_id,\r\nu32 num_pf_cids,\r\nu32 num_tids, u32 base_mem_addr_4kb)\r\n{\r\nu32 pq_size, pq_mem_4kb, mem_addr_4kb;\r\nu16 i, pq_id, pq_group;\r\npq_group = pf_id;\r\npq_size = num_pf_cids + num_tids;\r\npq_mem_4kb = QM_PQ_MEM_4KB(pq_size);\r\nmem_addr_4kb = base_mem_addr_4kb;\r\nSTORE_RT_REG(p_hwfn, QM_REG_PQOTHER2PF_0_RT_OFFSET + pq_group,\r\n(u32)(pf_id));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_2_RT_OFFSET,\r\nQM_PQ_SIZE_256B(pq_size));\r\nfor (i = 0, pq_id = pf_id * QM_PF_QUEUE_GROUP_SIZE;\r\ni < QM_OTHER_PQS_PER_PF; i++, pq_id++) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_BASEADDROTHERPQ_RT_OFFSET + pq_id,\r\nmem_addr_4kb);\r\nmem_addr_4kb += pq_mem_4kb;\r\n}\r\n}\r\nstatic int qed_pf_wfq_rt_init(struct qed_hwfn *p_hwfn,\r\nstruct qed_qm_pf_rt_init_params *p_params)\r\n{\r\nu16 num_tx_pqs = p_params->num_pf_pqs + p_params->num_vf_pqs;\r\nu32 crd_reg_offset;\r\nu32 inc_val;\r\nu16 i;\r\nif (p_params->pf_id < MAX_NUM_PFS_BB)\r\ncrd_reg_offset = QM_REG_WFQPFCRD_RT_OFFSET;\r\nelse\r\ncrd_reg_offset = QM_REG_WFQPFCRD_MSB_RT_OFFSET;\r\ncrd_reg_offset += p_params->pf_id % MAX_NUM_PFS_BB;\r\ninc_val = QM_WFQ_INC_VAL(p_params->pf_wfq);\r\nif (!inc_val || inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF WFQ weight configuration\n");\r\nreturn -1;\r\n}\r\nfor (i = 0; i < num_tx_pqs; i++) {\r\nu8 voq = VOQ(p_params->port_id, p_params->pq_params[i].tc_id,\r\np_params->max_phys_tcs_per_port);\r\nOVERWRITE_RT_REG(p_hwfn,\r\ncrd_reg_offset + voq * MAX_NUM_PFS_BB,\r\nQM_WFQ_CRD_REG_SIGN_BIT);\r\n}\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQPFUPPERBOUND_RT_OFFSET + p_params->pf_id,\r\nQM_WFQ_UPPER_BOUND | QM_WFQ_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQPFWEIGHT_RT_OFFSET + p_params->pf_id,\r\ninc_val);\r\nreturn 0;\r\n}\r\nstatic int qed_pf_rl_rt_init(struct qed_hwfn *p_hwfn, u8 pf_id, u32 pf_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(pf_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF rate limit configuration\n");\r\nreturn -1;\r\n}\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFCRD_RT_OFFSET + pf_id,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFUPPERBOUND_RT_OFFSET + pf_id,\r\nQM_RL_UPPER_BOUND | QM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFINCVAL_RT_OFFSET + pf_id, inc_val);\r\nreturn 0;\r\n}\r\nstatic int qed_vp_wfq_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 num_vports,\r\nstruct init_qm_vport_params *vport_params)\r\n{\r\nu32 inc_val;\r\nu8 tc, i;\r\nfor (i = 0; i < num_vports; i++) {\r\nif (!vport_params[i].vport_wfq)\r\ncontinue;\r\ninc_val = QM_WFQ_INC_VAL(vport_params[i].vport_wfq);\r\nif (inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT WFQ weight configuration\n");\r\nreturn -1;\r\n}\r\nfor (tc = 0; tc < NUM_OF_TCS; tc++) {\r\nu16 vport_pq_id = vport_params[i].first_tx_pq_id[tc];\r\nif (vport_pq_id != QM_INVALID_PQ_ID) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPCRD_RT_OFFSET +\r\nvport_pq_id,\r\nQM_WFQ_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPWEIGHT_RT_OFFSET +\r\nvport_pq_id, inc_val);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int qed_vport_rl_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 start_vport,\r\nu8 num_vports,\r\nstruct init_qm_vport_params *vport_params)\r\n{\r\nu8 i, vport_id;\r\nif (start_vport + num_vports >= MAX_QM_GLOBAL_RLS) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT ID for rate limiter configuration\n");\r\nreturn -1;\r\n}\r\nfor (i = 0, vport_id = start_vport; i < num_vports; i++, vport_id++) {\r\nu32 inc_val = QM_RL_INC_VAL(vport_params[i].vport_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT rate-limit configuration\n");\r\nreturn -1;\r\n}\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLCRD_RT_OFFSET + vport_id,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLUPPERBOUND_RT_OFFSET + vport_id,\r\nQM_RL_UPPER_BOUND | QM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLINCVAL_RT_OFFSET + vport_id,\r\ninc_val);\r\n}\r\nreturn 0;\r\n}\r\nstatic bool qed_poll_on_qm_cmd_ready(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt)\r\n{\r\nu32 reg_val, i;\r\nfor (i = 0, reg_val = 0; i < QM_STOP_CMD_MAX_POLL_COUNT && reg_val == 0;\r\ni++) {\r\nudelay(QM_STOP_CMD_POLL_PERIOD_US);\r\nreg_val = qed_rd(p_hwfn, p_ptt, QM_REG_SDMCMDREADY);\r\n}\r\nif (i == QM_STOP_CMD_MAX_POLL_COUNT) {\r\nDP_VERBOSE(p_hwfn, NETIF_MSG_HW,\r\n"Timeout when waiting for QM SDM command ready signal\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool qed_send_qm_cmd(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nu32 cmd_addr, u32 cmd_data_lsb, u32 cmd_data_msb)\r\n{\r\nif (!qed_poll_on_qm_cmd_ready(p_hwfn, p_ptt))\r\nreturn false;\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDADDR, cmd_addr);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDDATALSB, cmd_data_lsb);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDDATAMSB, cmd_data_msb);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDGO, 1);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDGO, 0);\r\nreturn qed_poll_on_qm_cmd_ready(p_hwfn, p_ptt);\r\n}\r\nu32 qed_qm_pf_mem_size(u8 pf_id,\r\nu32 num_pf_cids,\r\nu32 num_vf_cids,\r\nu32 num_tids, u16 num_pf_pqs, u16 num_vf_pqs)\r\n{\r\nreturn QM_PQ_MEM_4KB(num_pf_cids) * num_pf_pqs +\r\nQM_PQ_MEM_4KB(num_vf_cids) * num_vf_pqs +\r\nQM_PQ_MEM_4KB(num_pf_cids + num_tids) * QM_OTHER_PQS_PER_PF;\r\n}\r\nint qed_qm_common_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nstruct qed_qm_common_rt_init_params *p_params)\r\n{\r\nu32 mask = (QM_OPPOR_LINE_VOQ_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_LINEVOQ_SHIFT) |\r\n(QM_BYTE_CRD_EN << QM_RF_OPPORTUNISTIC_MASK_BYTEVOQ_SHIFT) |\r\n(p_params->pf_wfq_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_PFWFQ_SHIFT) |\r\n(p_params->vport_wfq_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_VPWFQ_SHIFT) |\r\n(p_params->pf_rl_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_PFRL_SHIFT) |\r\n(p_params->vport_rl_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_VPQCNRL_SHIFT) |\r\n(QM_OPPOR_FW_STOP_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_FWPAUSE_SHIFT) |\r\n(QM_OPPOR_PQ_EMPTY_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_QUEUEEMPTY_SHIFT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_AFULLOPRTNSTCCRDMASK_RT_OFFSET, mask);\r\nqed_enable_pf_rl(p_hwfn, p_params->pf_rl_en);\r\nqed_enable_pf_wfq(p_hwfn, p_params->pf_wfq_en);\r\nqed_enable_vport_rl(p_hwfn, p_params->vport_rl_en);\r\nqed_enable_vport_wfq(p_hwfn, p_params->vport_wfq_en);\r\nqed_cmdq_lines_rt_init(p_hwfn,\r\np_params->max_ports_per_engine,\r\np_params->max_phys_tcs_per_port,\r\np_params->port_params);\r\nqed_btb_blocks_rt_init(p_hwfn,\r\np_params->max_ports_per_engine,\r\np_params->max_phys_tcs_per_port,\r\np_params->port_params);\r\nreturn 0;\r\n}\r\nint qed_qm_pf_rt_init(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_qm_pf_rt_init_params *p_params)\r\n{\r\nstruct init_qm_vport_params *vport_params = p_params->vport_params;\r\nu32 other_mem_size_4kb = QM_PQ_MEM_4KB(p_params->num_pf_cids +\r\np_params->num_tids) *\r\nQM_OTHER_PQS_PER_PF;\r\nu8 tc, i;\r\nfor (i = 0; i < p_params->num_vports; i++)\r\nfor (tc = 0; tc < NUM_OF_TCS; tc++)\r\nvport_params[i].first_tx_pq_id[tc] = QM_INVALID_PQ_ID;\r\nqed_other_pq_map_rt_init(p_hwfn, p_params->port_id, p_params->pf_id,\r\np_params->num_pf_cids, p_params->num_tids, 0);\r\nqed_tx_pq_map_rt_init(p_hwfn, p_ptt, p_params, other_mem_size_4kb);\r\nif (p_params->pf_wfq)\r\nif (qed_pf_wfq_rt_init(p_hwfn, p_params))\r\nreturn -1;\r\nif (qed_pf_rl_rt_init(p_hwfn, p_params->pf_id, p_params->pf_rl))\r\nreturn -1;\r\nif (qed_vp_wfq_rt_init(p_hwfn, p_params->num_vports, vport_params))\r\nreturn -1;\r\nif (qed_vport_rl_rt_init(p_hwfn, p_params->start_vport,\r\np_params->num_vports, vport_params))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nint qed_init_pf_wfq(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u8 pf_id, u16 pf_wfq)\r\n{\r\nu32 inc_val = QM_WFQ_INC_VAL(pf_wfq);\r\nif (!inc_val || inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF WFQ weight configuration\n");\r\nreturn -1;\r\n}\r\nqed_wr(p_hwfn, p_ptt, QM_REG_WFQPFWEIGHT + pf_id * 4, inc_val);\r\nreturn 0;\r\n}\r\nint qed_init_pf_rl(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u8 pf_id, u32 pf_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(pf_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF rate limit configuration\n");\r\nreturn -1;\r\n}\r\nqed_wr(p_hwfn, p_ptt,\r\nQM_REG_RLPFCRD + pf_id * 4,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_RLPFINCVAL + pf_id * 4, inc_val);\r\nreturn 0;\r\n}\r\nint qed_init_vport_wfq(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nu16 first_tx_pq_id[NUM_OF_TCS], u16 vport_wfq)\r\n{\r\nu16 vport_pq_id;\r\nu32 inc_val;\r\nu8 tc;\r\ninc_val = QM_WFQ_INC_VAL(vport_wfq);\r\nif (!inc_val || inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid VPORT WFQ weight configuration\n");\r\nreturn -1;\r\n}\r\nfor (tc = 0; tc < NUM_OF_TCS; tc++) {\r\nvport_pq_id = first_tx_pq_id[tc];\r\nif (vport_pq_id != QM_INVALID_PQ_ID)\r\nqed_wr(p_hwfn, p_ptt,\r\nQM_REG_WFQVPWEIGHT + vport_pq_id * 4,\r\ninc_val);\r\n}\r\nreturn 0;\r\n}\r\nint qed_init_vport_rl(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u8 vport_id, u32 vport_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(vport_rl);\r\nif (vport_id >= MAX_QM_GLOBAL_RLS) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT ID for rate limiter configuration\n");\r\nreturn -1;\r\n}\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid VPORT rate-limit configuration\n");\r\nreturn -1;\r\n}\r\nqed_wr(p_hwfn, p_ptt,\r\nQM_REG_RLGLBLCRD + vport_id * 4,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_RLGLBLINCVAL + vport_id * 4, inc_val);\r\nreturn 0;\r\n}\r\nbool qed_send_qm_stop_cmd(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nbool is_release_cmd,\r\nbool is_tx_pq, u16 start_pq, u16 num_pqs)\r\n{\r\nu32 cmd_arr[QM_CMD_STRUCT_SIZE(QM_STOP_CMD)] = { 0 };\r\nu32 pq_mask = 0, last_pq = start_pq + num_pqs - 1, pq_id;\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD, PQ_TYPE, is_tx_pq ? 0 : 1);\r\nfor (pq_id = start_pq; pq_id <= last_pq; pq_id++) {\r\nif (!is_release_cmd)\r\npq_mask |= (1 << (pq_id % QM_STOP_PQ_MASK_WIDTH));\r\nif ((pq_id == last_pq) ||\r\n(pq_id % QM_STOP_PQ_MASK_WIDTH ==\r\n(QM_STOP_PQ_MASK_WIDTH - 1))) {\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD,\r\nPAUSE_MASK, pq_mask);\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD,\r\nGROUP_ID,\r\npq_id / QM_STOP_PQ_MASK_WIDTH);\r\nif (!qed_send_qm_cmd(p_hwfn, p_ptt, QM_STOP_CMD_ADDR,\r\ncmd_arr[0], cmd_arr[1]))\r\nreturn false;\r\npq_mask = 0;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic void\r\nqed_set_tunnel_type_enable_bit(unsigned long *var, int bit, bool enable)\r\n{\r\nif (enable)\r\nset_bit(bit, var);\r\nelse\r\nclear_bit(bit, var);\r\n}\r\nvoid qed_set_vxlan_dest_port(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u16 dest_port)\r\n{\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_VXLAN_PORT, dest_port);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_VXLAN_CTRL, dest_port);\r\nqed_wr(p_hwfn, p_ptt, PBF_REG_VXLAN_PORT, dest_port);\r\n}\r\nvoid qed_set_vxlan_enable(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, bool vxlan_enable)\r\n{\r\nunsigned long reg_val = 0;\r\nu8 shift;\r\nreg_val = qed_rd(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN);\r\nshift = PRS_REG_ENCAPSULATION_TYPE_EN_VXLAN_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, vxlan_enable);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN, reg_val);\r\nif (reg_val)\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_OUTPUT_FORMAT_4_0,\r\nPRS_ETH_TUNN_FIC_FORMAT);\r\nreg_val = qed_rd(p_hwfn, p_ptt, NIG_REG_ENC_TYPE_ENABLE);\r\nshift = NIG_REG_ENC_TYPE_ENABLE_VXLAN_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, vxlan_enable);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_ENC_TYPE_ENABLE, reg_val);\r\nqed_wr(p_hwfn, p_ptt, DORQ_REG_L2_EDPM_TUNNEL_VXLAN_EN,\r\nvxlan_enable ? 1 : 0);\r\n}\r\nvoid qed_set_gre_enable(struct qed_hwfn *p_hwfn, struct qed_ptt *p_ptt,\r\nbool eth_gre_enable, bool ip_gre_enable)\r\n{\r\nunsigned long reg_val = 0;\r\nu8 shift;\r\nreg_val = qed_rd(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN);\r\nshift = PRS_REG_ENCAPSULATION_TYPE_EN_ETH_OVER_GRE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, eth_gre_enable);\r\nshift = PRS_REG_ENCAPSULATION_TYPE_EN_IP_OVER_GRE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, ip_gre_enable);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN, reg_val);\r\nif (reg_val)\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_OUTPUT_FORMAT_4_0,\r\nPRS_ETH_TUNN_FIC_FORMAT);\r\nreg_val = qed_rd(p_hwfn, p_ptt, NIG_REG_ENC_TYPE_ENABLE);\r\nshift = NIG_REG_ENC_TYPE_ENABLE_ETH_OVER_GRE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, eth_gre_enable);\r\nshift = NIG_REG_ENC_TYPE_ENABLE_IP_OVER_GRE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, ip_gre_enable);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_ENC_TYPE_ENABLE, reg_val);\r\nqed_wr(p_hwfn, p_ptt, DORQ_REG_L2_EDPM_TUNNEL_GRE_ETH_EN,\r\neth_gre_enable ? 1 : 0);\r\nqed_wr(p_hwfn, p_ptt, DORQ_REG_L2_EDPM_TUNNEL_GRE_IP_EN,\r\nip_gre_enable ? 1 : 0);\r\n}\r\nvoid qed_set_geneve_dest_port(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u16 dest_port)\r\n{\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_NGE_PORT, dest_port);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_NGE_PORT, dest_port);\r\nqed_wr(p_hwfn, p_ptt, PBF_REG_NGE_PORT, dest_port);\r\n}\r\nvoid qed_set_geneve_enable(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nbool eth_geneve_enable, bool ip_geneve_enable)\r\n{\r\nunsigned long reg_val = 0;\r\nu8 shift;\r\nreg_val = qed_rd(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN);\r\nshift = PRS_REG_ENCAPSULATION_TYPE_EN_ETH_OVER_GENEVE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, eth_geneve_enable);\r\nshift = PRS_REG_ENCAPSULATION_TYPE_EN_IP_OVER_GENEVE_ENABLE_SHIFT;\r\nqed_set_tunnel_type_enable_bit(&reg_val, shift, ip_geneve_enable);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_ENCAPSULATION_TYPE_EN, reg_val);\r\nif (reg_val)\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_OUTPUT_FORMAT_4_0,\r\nPRS_ETH_TUNN_FIC_FORMAT);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_NGE_ETH_ENABLE,\r\neth_geneve_enable ? 1 : 0);\r\nqed_wr(p_hwfn, p_ptt, NIG_REG_NGE_IP_ENABLE, ip_geneve_enable ? 1 : 0);\r\nif (QED_IS_BB_B0(p_hwfn->cdev))\r\nreturn;\r\nqed_wr(p_hwfn, p_ptt, DORQ_REG_L2_EDPM_TUNNEL_NGE_ETH_EN,\r\neth_geneve_enable ? 1 : 0);\r\nqed_wr(p_hwfn, p_ptt, DORQ_REG_L2_EDPM_TUNNEL_NGE_IP_EN,\r\nip_geneve_enable ? 1 : 0);\r\n}\r\nvoid qed_set_rfs_mode_disable(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt, u16 pf_id)\r\n{\r\nu32 hw_addr = PRS_REG_GFT_PROFILE_MASK_RAM +\r\npf_id * RAM_LINE_SIZE;\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_SEARCH_GFT, 0);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_CM_HDR_GFT, 0x0);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_GFT_CAM + CAM_LINE_SIZE * pf_id, 0);\r\nqed_wr(p_hwfn, p_ptt, hw_addr, 0);\r\nqed_wr(p_hwfn, p_ptt, hw_addr + 4, 0);\r\n}\r\nvoid qed_set_rfs_mode_enable(struct qed_hwfn *p_hwfn, struct qed_ptt *p_ptt,\r\nu16 pf_id, bool tcp, bool udp,\r\nbool ipv4, bool ipv6)\r\n{\r\nunion gft_cam_line_union camline;\r\nstruct gft_ram_line ramline;\r\nu32 rfs_cm_hdr_event_id;\r\nrfs_cm_hdr_event_id = qed_rd(p_hwfn, p_ptt, PRS_REG_CM_HDR_GFT);\r\nif (!ipv6 && !ipv4)\r\nDP_NOTICE(p_hwfn,\r\n"set_rfs_mode_enable: must accept at least on of - ipv4 or ipv6");\r\nif (!tcp && !udp)\r\nDP_NOTICE(p_hwfn,\r\n"set_rfs_mode_enable: must accept at least on of - udp or tcp");\r\nrfs_cm_hdr_event_id |= T_ETH_PACKET_MATCH_RFS_EVENTID <<\r\nPRS_REG_CM_HDR_GFT_EVENT_ID_SHIFT;\r\nrfs_cm_hdr_event_id |= PARSER_ETH_CONN_CM_HDR <<\r\nPRS_REG_CM_HDR_GFT_CM_HDR_SHIFT;\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_CM_HDR_GFT, rfs_cm_hdr_event_id);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_SEARCH_GFT, 1);\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_LOAD_L2_FILTER, 0);\r\ncamline.cam_line_mapped.camline = 0;\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_VALID, 1);\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_PF_ID_MASK,\r\nGFT_CAM_LINE_MAPPED_PF_ID_MASK_MASK);\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_PF_ID, pf_id);\r\nif (!(tcp && udp)) {\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_UPPER_PROTOCOL_TYPE_MASK,\r\nGFT_CAM_LINE_MAPPED_UPPER_PROTOCOL_TYPE_MASK_MASK);\r\nif (tcp)\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_UPPER_PROTOCOL_TYPE,\r\nGFT_PROFILE_TCP_PROTOCOL);\r\nelse\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_UPPER_PROTOCOL_TYPE,\r\nGFT_PROFILE_UDP_PROTOCOL);\r\n}\r\nif (!(ipv4 && ipv6)) {\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_IP_VERSION_MASK, 1);\r\nif (ipv4)\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_IP_VERSION,\r\nGFT_PROFILE_IPV4);\r\nelse\r\nSET_FIELD(camline.cam_line_mapped.camline,\r\nGFT_CAM_LINE_MAPPED_IP_VERSION,\r\nGFT_PROFILE_IPV6);\r\n}\r\nqed_wr(p_hwfn, p_ptt, PRS_REG_GFT_CAM + CAM_LINE_SIZE * pf_id,\r\ncamline.cam_line_mapped.camline);\r\ncamline.cam_line_mapped.camline = qed_rd(p_hwfn, p_ptt,\r\nPRS_REG_GFT_CAM +\r\nCAM_LINE_SIZE * pf_id);\r\nramline.lo = 0;\r\nramline.hi = 0;\r\nSET_FIELD(ramline.hi, GFT_RAM_LINE_DST_IP, 1);\r\nSET_FIELD(ramline.hi, GFT_RAM_LINE_SRC_IP, 1);\r\nSET_FIELD(ramline.hi, GFT_RAM_LINE_OVER_IP_PROTOCOL, 1);\r\nSET_FIELD(ramline.lo, GFT_RAM_LINE_ETHERTYPE, 1);\r\nSET_FIELD(ramline.lo, GFT_RAM_LINE_SRC_PORT, 1);\r\nSET_FIELD(ramline.lo, GFT_RAM_LINE_DST_PORT, 1);\r\nqed_wr(p_hwfn, p_ptt,\r\nPRS_REG_GFT_PROFILE_MASK_RAM + RAM_LINE_SIZE * pf_id,\r\nramline.lo);\r\nqed_wr(p_hwfn, p_ptt,\r\nPRS_REG_GFT_PROFILE_MASK_RAM + RAM_LINE_SIZE * pf_id + 4,\r\nramline.hi);\r\nqed_wr(p_hwfn, p_ptt,\r\nPRS_REG_GFT_PROFILE_MASK_RAM +\r\nRAM_LINE_SIZE * PRS_GFT_CAM_LINES_NO_MATCH,\r\nramline.lo);\r\nqed_wr(p_hwfn, p_ptt,\r\nPRS_REG_GFT_PROFILE_MASK_RAM +\r\nRAM_LINE_SIZE * PRS_GFT_CAM_LINES_NO_MATCH + 4,\r\nramline.hi);\r\n}

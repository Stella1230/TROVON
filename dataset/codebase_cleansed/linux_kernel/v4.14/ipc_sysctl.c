static void *get_ipc(struct ctl_table *table)\r\n{\r\nchar *which = table->data;\r\nstruct ipc_namespace *ipc_ns = current->nsproxy->ipc_ns;\r\nwhich = (which - (char *)&init_ipc_ns) + (char *)ipc_ns;\r\nreturn which;\r\n}\r\nstatic int proc_ipc_dointvec(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct ctl_table ipc_table;\r\nmemcpy(&ipc_table, table, sizeof(ipc_table));\r\nipc_table.data = get_ipc(table);\r\nreturn proc_dointvec(&ipc_table, write, buffer, lenp, ppos);\r\n}\r\nstatic int proc_ipc_dointvec_minmax(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct ctl_table ipc_table;\r\nmemcpy(&ipc_table, table, sizeof(ipc_table));\r\nipc_table.data = get_ipc(table);\r\nreturn proc_dointvec_minmax(&ipc_table, write, buffer, lenp, ppos);\r\n}\r\nstatic int proc_ipc_dointvec_minmax_orphans(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct ipc_namespace *ns = current->nsproxy->ipc_ns;\r\nint err = proc_ipc_dointvec_minmax(table, write, buffer, lenp, ppos);\r\nif (err < 0)\r\nreturn err;\r\nif (ns->shm_rmid_forced)\r\nshm_destroy_orphaned(ns);\r\nreturn err;\r\n}\r\nstatic int proc_ipc_doulongvec_minmax(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct ctl_table ipc_table;\r\nmemcpy(&ipc_table, table, sizeof(ipc_table));\r\nipc_table.data = get_ipc(table);\r\nreturn proc_doulongvec_minmax(&ipc_table, write, buffer,\r\nlenp, ppos);\r\n}\r\nstatic int proc_ipc_auto_msgmni(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct ctl_table ipc_table;\r\nint dummy = 0;\r\nmemcpy(&ipc_table, table, sizeof(ipc_table));\r\nipc_table.data = &dummy;\r\nif (write)\r\npr_info_once("writing to auto_msgmni has no effect");\r\nreturn proc_dointvec_minmax(&ipc_table, write, buffer, lenp, ppos);\r\n}\r\nstatic int __init ipc_sysctl_init(void)\r\n{\r\nregister_sysctl_table(ipc_root_table);\r\nreturn 0;\r\n}

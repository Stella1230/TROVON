static int __patch_instruction(unsigned int *addr, unsigned int instr)\r\n{\r\nint err;\r\n__put_user_size(instr, addr, 4, err);\r\nif (err)\r\nreturn err;\r\nasm ("dcbst 0, %0; sync; icbi 0,%0; sync; isync" :: "r" (addr));\r\nreturn 0;\r\n}\r\nstatic int text_area_cpu_up(unsigned int cpu)\r\n{\r\nstruct vm_struct *area;\r\narea = get_vm_area(PAGE_SIZE, VM_ALLOC);\r\nif (!area) {\r\nWARN_ONCE(1, "Failed to create text area for cpu %d\n",\r\ncpu);\r\nreturn -1;\r\n}\r\nthis_cpu_write(text_poke_area, area);\r\nreturn 0;\r\n}\r\nstatic int text_area_cpu_down(unsigned int cpu)\r\n{\r\nfree_vm_area(this_cpu_read(text_poke_area));\r\nreturn 0;\r\n}\r\nstatic int __init setup_text_poke_area(void)\r\n{\r\nBUG_ON(!cpuhp_setup_state(CPUHP_AP_ONLINE_DYN,\r\n"powerpc/text_poke:online", text_area_cpu_up,\r\ntext_area_cpu_down));\r\nreturn 0;\r\n}\r\nstatic int map_patch_area(void *addr, unsigned long text_poke_addr)\r\n{\r\nunsigned long pfn;\r\nint err;\r\nif (is_vmalloc_addr(addr))\r\npfn = vmalloc_to_pfn(addr);\r\nelse\r\npfn = __pa_symbol(addr) >> PAGE_SHIFT;\r\nerr = map_kernel_page(text_poke_addr, (pfn << PAGE_SHIFT),\r\npgprot_val(PAGE_KERNEL));\r\npr_devel("Mapped addr %lx with pfn %lx:%d\n", text_poke_addr, pfn, err);\r\nif (err)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic inline int unmap_patch_area(unsigned long addr)\r\n{\r\npte_t *ptep;\r\npmd_t *pmdp;\r\npud_t *pudp;\r\npgd_t *pgdp;\r\npgdp = pgd_offset_k(addr);\r\nif (unlikely(!pgdp))\r\nreturn -EINVAL;\r\npudp = pud_offset(pgdp, addr);\r\nif (unlikely(!pudp))\r\nreturn -EINVAL;\r\npmdp = pmd_offset(pudp, addr);\r\nif (unlikely(!pmdp))\r\nreturn -EINVAL;\r\nptep = pte_offset_kernel(pmdp, addr);\r\nif (unlikely(!ptep))\r\nreturn -EINVAL;\r\npr_devel("clearing mm %p, pte %p, addr %lx\n", &init_mm, ptep, addr);\r\npte_clear(&init_mm, addr, ptep);\r\nflush_tlb_kernel_range(addr, addr + PAGE_SIZE);\r\nreturn 0;\r\n}\r\nint patch_instruction(unsigned int *addr, unsigned int instr)\r\n{\r\nint err;\r\nunsigned int *dest = NULL;\r\nunsigned long flags;\r\nunsigned long text_poke_addr;\r\nunsigned long kaddr = (unsigned long)addr;\r\nif (!slab_is_available() || !this_cpu_read(text_poke_area))\r\nreturn __patch_instruction(addr, instr);\r\nlocal_irq_save(flags);\r\ntext_poke_addr = (unsigned long)__this_cpu_read(text_poke_area)->addr;\r\nif (map_patch_area(addr, text_poke_addr)) {\r\nerr = -1;\r\ngoto out;\r\n}\r\ndest = (unsigned int *)(text_poke_addr) +\r\n((kaddr & ~PAGE_MASK) / sizeof(unsigned int));\r\n__put_user_size(instr, dest, 4, err);\r\nif (!err)\r\nasm ("dcbst 0, %0; sync; icbi 0,%0; icbi 0,%1; sync; isync"\r\n::"r" (dest), "r"(addr));\r\nerr = unmap_patch_area(text_poke_addr);\r\nif (err)\r\npr_warn("failed to unmap %lx\n", text_poke_addr);\r\nout:\r\nlocal_irq_restore(flags);\r\nreturn err;\r\n}\r\nint patch_instruction(unsigned int *addr, unsigned int instr)\r\n{\r\nreturn __patch_instruction(addr, instr);\r\n}\r\nint patch_branch(unsigned int *addr, unsigned long target, int flags)\r\n{\r\nreturn patch_instruction(addr, create_branch(addr, target, flags));\r\n}\r\nbool is_offset_in_branch_range(long offset)\r\n{\r\nreturn (offset >= -0x2000000 && offset <= 0x1fffffc && !(offset & 0x3));\r\n}\r\nbool is_conditional_branch(unsigned int instr)\r\n{\r\nunsigned int opcode = instr >> 26;\r\nif (opcode == 16)\r\nreturn true;\r\nif (opcode == 19) {\r\nswitch ((instr >> 1) & 0x3ff) {\r\ncase 16:\r\ncase 528:\r\ncase 560:\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nunsigned int create_branch(const unsigned int *addr,\r\nunsigned long target, int flags)\r\n{\r\nunsigned int instruction;\r\nlong offset;\r\noffset = target;\r\nif (! (flags & BRANCH_ABSOLUTE))\r\noffset = offset - (unsigned long)addr;\r\nif (!is_offset_in_branch_range(offset))\r\nreturn 0;\r\ninstruction = 0x48000000 | (flags & 0x3) | (offset & 0x03FFFFFC);\r\nreturn instruction;\r\n}\r\nunsigned int create_cond_branch(const unsigned int *addr,\r\nunsigned long target, int flags)\r\n{\r\nunsigned int instruction;\r\nlong offset;\r\noffset = target;\r\nif (! (flags & BRANCH_ABSOLUTE))\r\noffset = offset - (unsigned long)addr;\r\nif (offset < -0x8000 || offset > 0x7FFF || offset & 0x3)\r\nreturn 0;\r\ninstruction = 0x40000000 | (flags & 0x3FF0003) | (offset & 0xFFFC);\r\nreturn instruction;\r\n}\r\nstatic unsigned int branch_opcode(unsigned int instr)\r\n{\r\nreturn (instr >> 26) & 0x3F;\r\n}\r\nstatic int instr_is_branch_iform(unsigned int instr)\r\n{\r\nreturn branch_opcode(instr) == 18;\r\n}\r\nstatic int instr_is_branch_bform(unsigned int instr)\r\n{\r\nreturn branch_opcode(instr) == 16;\r\n}\r\nint instr_is_relative_branch(unsigned int instr)\r\n{\r\nif (instr & BRANCH_ABSOLUTE)\r\nreturn 0;\r\nreturn instr_is_branch_iform(instr) || instr_is_branch_bform(instr);\r\n}\r\nstatic unsigned long branch_iform_target(const unsigned int *instr)\r\n{\r\nsigned long imm;\r\nimm = *instr & 0x3FFFFFC;\r\nif (imm & 0x2000000)\r\nimm -= 0x4000000;\r\nif ((*instr & BRANCH_ABSOLUTE) == 0)\r\nimm += (unsigned long)instr;\r\nreturn (unsigned long)imm;\r\n}\r\nstatic unsigned long branch_bform_target(const unsigned int *instr)\r\n{\r\nsigned long imm;\r\nimm = *instr & 0xFFFC;\r\nif (imm & 0x8000)\r\nimm -= 0x10000;\r\nif ((*instr & BRANCH_ABSOLUTE) == 0)\r\nimm += (unsigned long)instr;\r\nreturn (unsigned long)imm;\r\n}\r\nunsigned long branch_target(const unsigned int *instr)\r\n{\r\nif (instr_is_branch_iform(*instr))\r\nreturn branch_iform_target(instr);\r\nelse if (instr_is_branch_bform(*instr))\r\nreturn branch_bform_target(instr);\r\nreturn 0;\r\n}\r\nint instr_is_branch_to_addr(const unsigned int *instr, unsigned long addr)\r\n{\r\nif (instr_is_branch_iform(*instr) || instr_is_branch_bform(*instr))\r\nreturn branch_target(instr) == addr;\r\nreturn 0;\r\n}\r\nunsigned int translate_branch(const unsigned int *dest, const unsigned int *src)\r\n{\r\nunsigned long target;\r\ntarget = branch_target(src);\r\nif (instr_is_branch_iform(*src))\r\nreturn create_branch(dest, target, *src);\r\nelse if (instr_is_branch_bform(*src))\r\nreturn create_cond_branch(dest, target, *src);\r\nreturn 0;\r\n}\r\nvoid __patch_exception(int exc, unsigned long addr)\r\n{\r\nextern unsigned int interrupt_base_book3e;\r\nunsigned int *ibase = &interrupt_base_book3e;\r\npatch_branch(ibase + (exc / 4) + 1, addr, 0);\r\n}\r\nstatic void __init test_trampoline(void)\r\n{\r\nasm ("nop;\n");\r\n}\r\nstatic void __init test_branch_iform(void)\r\n{\r\nunsigned int instr;\r\nunsigned long addr;\r\naddr = (unsigned long)&instr;\r\ncheck(instr_is_branch_iform(0x48000000));\r\ncheck(instr_is_branch_iform(0x4bffffff));\r\ncheck(!instr_is_branch_iform(0xcbffffff));\r\ncheck(!instr_is_branch_iform(0x7bffffff));\r\ncheck(instr_is_branch_iform(0x48000001));\r\ncheck(instr_is_branch_iform(0x4bfffffd));\r\ncheck(instr_is_branch_iform(0x4bff00fd));\r\ncheck(!instr_is_branch_iform(0x7bfffffd));\r\ninstr = 0x48000103;\r\ncheck(instr_is_branch_to_addr(&instr, 0x100));\r\ninstr = 0x480420ff;\r\ncheck(instr_is_branch_to_addr(&instr, 0x420fc));\r\ninstr = 0x49fffffc;\r\ncheck(instr_is_branch_to_addr(&instr, addr + 0x1FFFFFC));\r\ninstr = 0x4bfffffc;\r\ncheck(instr_is_branch_to_addr(&instr, addr - 4));\r\ninstr = 0x4a000000;\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x2000000));\r\ninstr = create_branch(&instr, addr, BRANCH_SET_LINK);\r\ncheck(instr_is_branch_to_addr(&instr, addr));\r\ninstr = create_branch(&instr, addr - 0x100, BRANCH_SET_LINK);\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x100));\r\ninstr = create_branch(&instr, addr + 0x100, 0);\r\ncheck(instr_is_branch_to_addr(&instr, addr + 0x100));\r\ninstr = create_branch(&instr, addr - 0x2000000, BRANCH_SET_LINK);\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x2000000));\r\ninstr = create_branch(&instr, addr - 0x2000004, BRANCH_SET_LINK);\r\ncheck(instr == 0);\r\ninstr = create_branch(&instr, addr + 0x2000000, BRANCH_SET_LINK);\r\ncheck(instr == 0);\r\ninstr = create_branch(&instr, addr + 3, BRANCH_SET_LINK);\r\ncheck(instr == 0);\r\ninstr = create_branch(&instr, addr, 0xFFFFFFFC);\r\ncheck(instr_is_branch_to_addr(&instr, addr));\r\ncheck(instr == 0x48000000);\r\n}\r\nstatic void __init test_create_function_call(void)\r\n{\r\nunsigned int *iptr;\r\nunsigned long dest;\r\niptr = (unsigned int *)ppc_function_entry(test_trampoline);\r\ndest = ppc_function_entry(test_create_function_call);\r\npatch_instruction(iptr, create_branch(iptr, dest, BRANCH_SET_LINK));\r\ncheck(instr_is_branch_to_addr(iptr, dest));\r\n}\r\nstatic void __init test_branch_bform(void)\r\n{\r\nunsigned long addr;\r\nunsigned int *iptr, instr, flags;\r\niptr = &instr;\r\naddr = (unsigned long)iptr;\r\ncheck(instr_is_branch_bform(0x40000000));\r\ncheck(instr_is_branch_bform(0x43ffffff));\r\ncheck(!instr_is_branch_bform(0xc3ffffff));\r\ncheck(!instr_is_branch_bform(0x7bffffff));\r\ninstr = 0x43ff0103;\r\ncheck(instr_is_branch_to_addr(&instr, 0x100));\r\ninstr = 0x43ff20ff;\r\ncheck(instr_is_branch_to_addr(&instr, 0x20fc));\r\ninstr = 0x43ff7ffc;\r\ncheck(instr_is_branch_to_addr(&instr, addr + 0x7FFC));\r\ninstr = 0x43fffffc;\r\ncheck(instr_is_branch_to_addr(&instr, addr - 4));\r\ninstr = 0x43ff8000;\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x8000));\r\nflags = 0x3ff000 | BRANCH_SET_LINK;\r\ninstr = create_cond_branch(iptr, addr, flags);\r\ncheck(instr_is_branch_to_addr(&instr, addr));\r\ninstr = create_cond_branch(iptr, addr - 0x100, flags);\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x100));\r\ninstr = create_cond_branch(iptr, addr + 0x100, flags);\r\ncheck(instr_is_branch_to_addr(&instr, addr + 0x100));\r\ninstr = create_cond_branch(iptr, addr - 0x8000, flags);\r\ncheck(instr_is_branch_to_addr(&instr, addr - 0x8000));\r\ninstr = create_cond_branch(iptr, addr - 0x8004, flags);\r\ncheck(instr == 0);\r\ninstr = create_cond_branch(iptr, addr + 0x8000, flags);\r\ncheck(instr == 0);\r\ninstr = create_cond_branch(iptr, addr + 3, flags);\r\ncheck(instr == 0);\r\ninstr = create_cond_branch(iptr, addr, 0xFFFFFFFC);\r\ncheck(instr_is_branch_to_addr(&instr, addr));\r\ncheck(instr == 0x43FF0000);\r\n}\r\nstatic void __init test_translate_branch(void)\r\n{\r\nunsigned long addr;\r\nunsigned int *p, *q;\r\nvoid *buf;\r\nbuf = vmalloc(PAGE_ALIGN(0x2000000 + 1));\r\ncheck(buf);\r\nif (!buf)\r\nreturn;\r\np = buf;\r\naddr = (unsigned long)p;\r\npatch_branch(p, addr, 0);\r\ncheck(instr_is_branch_to_addr(p, addr));\r\nq = p + 1;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\np = buf;\r\naddr = (unsigned long)p;\r\npatch_branch(p, addr, 0);\r\nq = buf + 0x2000000;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\ncheck(*q == 0x4a000000);\r\np = buf + 0x2000000;\r\naddr = (unsigned long)p;\r\npatch_branch(p, addr, 0);\r\nq = buf + 4;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\ncheck(*q == 0x49fffffc);\r\np = buf;\r\naddr = 0x1000000 + (unsigned long)buf;\r\npatch_branch(p, addr, BRANCH_SET_LINK);\r\nq = buf + 0x1400000;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\np = buf + 0x1000000;\r\naddr = 0x2000000 + (unsigned long)buf;\r\npatch_branch(p, addr, 0);\r\nq = buf + 4;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\np = buf;\r\naddr = (unsigned long)p;\r\npatch_instruction(p, create_cond_branch(p, addr, 0));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\nq = p + 1;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\np = buf;\r\naddr = (unsigned long)p;\r\npatch_instruction(p, create_cond_branch(p, addr, 0xFFFFFFFC));\r\nq = buf + 0x8000;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\ncheck(*q == 0x43ff8000);\r\np = buf + 0x8000;\r\naddr = (unsigned long)p;\r\npatch_instruction(p, create_cond_branch(p, addr, 0xFFFFFFFC));\r\nq = buf + 4;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\ncheck(*q == 0x43ff7ffc);\r\np = buf;\r\naddr = 0x3000 + (unsigned long)buf;\r\npatch_instruction(p, create_cond_branch(p, addr, BRANCH_SET_LINK));\r\nq = buf + 0x5000;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\np = buf + 0x2000;\r\naddr = 0x4000 + (unsigned long)buf;\r\npatch_instruction(p, create_cond_branch(p, addr, 0));\r\nq = buf + 4;\r\npatch_instruction(q, translate_branch(q, p));\r\ncheck(instr_is_branch_to_addr(p, addr));\r\ncheck(instr_is_branch_to_addr(q, addr));\r\nvfree(buf);\r\n}\r\nstatic int __init test_code_patching(void)\r\n{\r\nprintk(KERN_DEBUG "Running code patching self-tests ...\n");\r\ntest_branch_iform();\r\ntest_branch_bform();\r\ntest_create_function_call();\r\ntest_translate_branch();\r\nreturn 0;\r\n}

static ssize_t\r\nrtc_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct rtc_device *rtc = attr->private;\r\ndev_warn_once(kobj_to_dev(kobj), nvram_warning);\r\nreturn nvmem_device_read(rtc->nvmem, off, count, buf);\r\n}\r\nstatic ssize_t\r\nrtc_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct rtc_device *rtc = attr->private;\r\ndev_warn_once(kobj_to_dev(kobj), nvram_warning);\r\nreturn nvmem_device_write(rtc->nvmem, off, count, buf);\r\n}\r\nstatic int rtc_nvram_register(struct rtc_device *rtc)\r\n{\r\nint err;\r\nrtc->nvram = devm_kzalloc(rtc->dev.parent,\r\nsizeof(struct bin_attribute),\r\nGFP_KERNEL);\r\nif (!rtc->nvram)\r\nreturn -ENOMEM;\r\nrtc->nvram->attr.name = "nvram";\r\nrtc->nvram->attr.mode = 0644;\r\nrtc->nvram->private = rtc;\r\nsysfs_bin_attr_init(rtc->nvram);\r\nrtc->nvram->read = rtc_nvram_read;\r\nrtc->nvram->write = rtc_nvram_write;\r\nrtc->nvram->size = rtc->nvmem_config->size;\r\nerr = sysfs_create_bin_file(&rtc->dev.parent->kobj,\r\nrtc->nvram);\r\nif (err) {\r\ndevm_kfree(rtc->dev.parent, rtc->nvram);\r\nrtc->nvram = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic void rtc_nvram_unregister(struct rtc_device *rtc)\r\n{\r\nsysfs_remove_bin_file(&rtc->dev.parent->kobj, rtc->nvram);\r\n}\r\nvoid rtc_nvmem_register(struct rtc_device *rtc)\r\n{\r\nif (!rtc->nvmem_config)\r\nreturn;\r\nrtc->nvmem_config->dev = &rtc->dev;\r\nrtc->nvmem_config->owner = rtc->owner;\r\nrtc->nvmem = nvmem_register(rtc->nvmem_config);\r\nif (IS_ERR_OR_NULL(rtc->nvmem))\r\nreturn;\r\nif (rtc->nvram_old_abi)\r\nrtc_nvram_register(rtc);\r\n}\r\nvoid rtc_nvmem_unregister(struct rtc_device *rtc)\r\n{\r\nif (IS_ERR_OR_NULL(rtc->nvmem))\r\nreturn;\r\nif (rtc->nvram)\r\nrtc_nvram_unregister(rtc);\r\nnvmem_unregister(rtc->nvmem);\r\n}

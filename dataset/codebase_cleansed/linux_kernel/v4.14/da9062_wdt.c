static void da9062_set_window_start(struct da9062_watchdog *wdt)\r\n{\r\nwdt->j_time_stamp = jiffies;\r\n}\r\nstatic void da9062_apply_window_protection(struct da9062_watchdog *wdt)\r\n{\r\nunsigned long delay = msecs_to_jiffies(DA9062_RESET_PROTECTION_MS);\r\nunsigned long timeout = wdt->j_time_stamp + delay;\r\nunsigned long now = jiffies;\r\nunsigned int diff_ms;\r\nif (time_before(now, timeout)) {\r\ndiff_ms = jiffies_to_msecs(timeout-now);\r\ndev_dbg(wdt->hw->dev,\r\n"Kicked too quickly. Delaying %u msecs\n", diff_ms);\r\nmsleep(diff_ms);\r\n}\r\n}\r\nstatic unsigned int da9062_wdt_timeout_to_sel(unsigned int secs)\r\n{\r\nunsigned int i;\r\nfor (i = DA9062_TWDSCALE_MIN; i <= DA9062_TWDSCALE_MAX; i++) {\r\nif (wdt_timeout[i] >= secs)\r\nreturn i;\r\n}\r\nreturn DA9062_TWDSCALE_MAX;\r\n}\r\nstatic int da9062_reset_watchdog_timer(struct da9062_watchdog *wdt)\r\n{\r\nint ret;\r\nda9062_apply_window_protection(wdt);\r\nret = regmap_update_bits(wdt->hw->regmap,\r\nDA9062AA_CONTROL_F,\r\nDA9062AA_WATCHDOG_MASK,\r\nDA9062AA_WATCHDOG_MASK);\r\nda9062_set_window_start(wdt);\r\nreturn ret;\r\n}\r\nstatic int da9062_wdt_update_timeout_register(struct da9062_watchdog *wdt,\r\nunsigned int regval)\r\n{\r\nstruct da9062 *chip = wdt->hw;\r\nint ret;\r\nret = da9062_reset_watchdog_timer(wdt);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_update_bits(chip->regmap,\r\nDA9062AA_CONTROL_D,\r\nDA9062AA_TWDSCALE_MASK,\r\nregval);\r\n}\r\nstatic int da9062_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct da9062_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nunsigned int selector;\r\nint ret;\r\nselector = da9062_wdt_timeout_to_sel(wdt->wdtdev.timeout);\r\nret = da9062_wdt_update_timeout_register(wdt, selector);\r\nif (ret)\r\ndev_err(wdt->hw->dev, "Watchdog failed to start (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9062_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct da9062_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nint ret;\r\nret = da9062_reset_watchdog_timer(wdt);\r\nif (ret) {\r\ndev_err(wdt->hw->dev, "Failed to ping the watchdog (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(wdt->hw->regmap,\r\nDA9062AA_CONTROL_D,\r\nDA9062AA_TWDSCALE_MASK,\r\nDA9062_TWDSCALE_DISABLE);\r\nif (ret)\r\ndev_err(wdt->hw->dev, "Watchdog failed to stop (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9062_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct da9062_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nint ret;\r\nret = da9062_reset_watchdog_timer(wdt);\r\nif (ret)\r\ndev_err(wdt->hw->dev, "Failed to ping the watchdog (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9062_wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int timeout)\r\n{\r\nstruct da9062_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nunsigned int selector;\r\nint ret;\r\nselector = da9062_wdt_timeout_to_sel(timeout);\r\nret = da9062_wdt_update_timeout_register(wdt, selector);\r\nif (ret)\r\ndev_err(wdt->hw->dev, "Failed to set watchdog timeout (err = %d)\n",\r\nret);\r\nelse\r\nwdd->timeout = wdt_timeout[selector];\r\nreturn ret;\r\n}\r\nstatic int da9062_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct da9062 *chip;\r\nstruct da9062_watchdog *wdt;\r\nchip = dev_get_drvdata(pdev->dev.parent);\r\nif (!chip)\r\nreturn -EINVAL;\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nwdt->hw = chip;\r\nwdt->wdtdev.info = &da9062_watchdog_info;\r\nwdt->wdtdev.ops = &da9062_watchdog_ops;\r\nwdt->wdtdev.min_timeout = DA9062_WDT_MIN_TIMEOUT;\r\nwdt->wdtdev.max_timeout = DA9062_WDT_MAX_TIMEOUT;\r\nwdt->wdtdev.timeout = DA9062_WDG_DEFAULT_TIMEOUT;\r\nwdt->wdtdev.status = WATCHDOG_NOWAYOUT_INIT_STATUS;\r\nwdt->wdtdev.parent = &pdev->dev;\r\nwatchdog_set_drvdata(&wdt->wdtdev, wdt);\r\nret = devm_watchdog_register_device(&pdev->dev, &wdt->wdtdev);\r\nif (ret < 0) {\r\ndev_err(wdt->hw->dev,\r\n"watchdog registration failed (%d)\n", ret);\r\nreturn ret;\r\n}\r\nda9062_set_window_start(wdt);\r\nreturn da9062_wdt_ping(&wdt->wdtdev);\r\n}

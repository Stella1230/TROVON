static int apci1564_reset(struct comedi_device *dev)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\noutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\r\ninl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\r\noutl(0x0, dev->iobase + APCI1564_DO_REG);\r\noutl(0x0, dev->iobase + APCI1564_DO_INT_CTRL_REG);\r\naddi_watchdog_reset(dev->iobase + APCI1564_WDOG_IOBASE);\r\noutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\r\noutl(0x0, devpriv->timer + ADDI_TCW_RELOAD_REG);\r\nif (devpriv->counters) {\r\nunsigned long iobase = devpriv->counters + ADDI_TCW_CTRL_REG;\r\noutl(0x0, iobase + APCI1564_COUNTER(0));\r\noutl(0x0, iobase + APCI1564_COUNTER(1));\r\noutl(0x0, iobase + APCI1564_COUNTER(2));\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t apci1564_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct apci1564_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s = dev->read_subdev;\r\nunsigned int status;\r\nunsigned int ctrl;\r\nunsigned int chan;\r\ns->state &= ~APCI1564_EVENT_MASK;\r\nstatus = inl(dev->iobase + APCI1564_DI_IRQ_REG);\r\nif (status & APCI1564_DI_IRQ_ENA) {\r\ns->state = inl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\r\ns->state &= APCI1564_DI_INT_MODE_MASK;\r\ns->state |= APCI1564_EVENT_COS;\r\noutl(status & ~APCI1564_DI_IRQ_ENA,\r\ndev->iobase + APCI1564_DI_IRQ_REG);\r\noutl(status, dev->iobase + APCI1564_DI_IRQ_REG);\r\n}\r\nstatus = inl(devpriv->timer + ADDI_TCW_IRQ_REG);\r\nif (status & ADDI_TCW_IRQ) {\r\ns->state |= APCI1564_EVENT_TIMER;\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\noutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\n}\r\nif (devpriv->counters) {\r\nfor (chan = 0; chan < 3; chan++) {\r\nunsigned long iobase;\r\niobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nstatus = inl(iobase + ADDI_TCW_IRQ_REG);\r\nif (status & ADDI_TCW_IRQ) {\r\ns->state |= APCI1564_EVENT_COUNTER(chan);\r\nctrl = inl(iobase + ADDI_TCW_CTRL_REG);\r\noutl(0x0, iobase + ADDI_TCW_CTRL_REG);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\n}\r\n}\r\n}\r\nif (s->state & APCI1564_EVENT_MASK) {\r\ncomedi_buf_write_samples(s, &s->state, 1);\r\ncomedi_handle_events(dev, s);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int apci1564_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = inl(dev->iobase + APCI1564_DI_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ns->state = inl(dev->iobase + APCI1564_DO_REG);\r\nif (comedi_dio_update_state(s, data))\r\noutl(s->state, dev->iobase + APCI1564_DO_REG);\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_diag_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = inl(dev->iobase + APCI1564_DO_INT_STATUS_REG) & 3;\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_cos_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int shift, oldmask;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIGITAL_TRIG:\r\nif (data[1] != 0)\r\nreturn -EINVAL;\r\nshift = data[3];\r\noldmask = (1U << shift) - 1;\r\nswitch (data[2]) {\r\ncase COMEDI_DIGITAL_TRIG_DISABLE:\r\ndevpriv->ctrl = 0;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\noutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\r\ninl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\r\nbreak;\r\ncase COMEDI_DIGITAL_TRIG_ENABLE_EDGES:\r\nif (devpriv->ctrl != APCI1564_DI_IRQ_ENA) {\r\ndevpriv->ctrl = APCI1564_DI_IRQ_ENA;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\n} else {\r\ndevpriv->mode1 &= oldmask;\r\ndevpriv->mode2 &= oldmask;\r\n}\r\ndevpriv->mode1 |= data[4] << shift;\r\ndevpriv->mode2 |= data[5] << shift;\r\nbreak;\r\ncase COMEDI_DIGITAL_TRIG_ENABLE_LEVELS:\r\nif (devpriv->ctrl != (APCI1564_DI_IRQ_ENA |\r\nAPCI1564_DI_IRQ_MODE)) {\r\ndevpriv->ctrl = APCI1564_DI_IRQ_ENA |\r\nAPCI1564_DI_IRQ_MODE;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\n} else {\r\ndevpriv->mode1 &= oldmask;\r\ndevpriv->mode2 &= oldmask;\r\n}\r\ndevpriv->mode1 |= data[4] << shift;\r\ndevpriv->mode2 |= data[5] << shift;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndevpriv->mode1 &= APCI1564_DI_INT_MODE_MASK;\r\ndevpriv->mode2 &= APCI1564_DI_INT_MODE_MASK;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_cos_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = s->state;\r\nreturn 0;\r\n}\r\nstatic int apci1564_cos_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nerr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\r\nerr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\r\nerr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\r\nerr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\r\nerr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\r\nif (err)\r\nreturn 1;\r\nerr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\r\nerr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\r\nerr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\r\nerr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\r\ncmd->chanlist_len);\r\nerr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\r\nif (err)\r\nreturn 3;\r\nreturn 0;\r\n}\r\nstatic int apci1564_cos_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nif (!devpriv->ctrl && !(devpriv->mode1 || devpriv->mode2)) {\r\ndev_warn(dev->class_dev,\r\n"Interrupts disabled due to mode configuration!\n");\r\nreturn -EINVAL;\r\n}\r\noutl(devpriv->mode1, dev->iobase + APCI1564_DI_INT_MODE1_REG);\r\noutl(devpriv->mode2, dev->iobase + APCI1564_DI_INT_MODE2_REG);\r\noutl(devpriv->ctrl, dev->iobase + APCI1564_DI_IRQ_REG);\r\nreturn 0;\r\n}\r\nstatic int apci1564_cos_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\noutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\r\ninl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\r\nreturn 0;\r\n}\r\nstatic int apci1564_timer_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int val;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_ARM:\r\nif (data[1] > s->maxdata)\r\nreturn -EINVAL;\r\noutl(data[1], devpriv->timer + ADDI_TCW_RELOAD_REG);\r\noutl(ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_TIMER_ENA,\r\ndevpriv->timer + ADDI_TCW_CTRL_REG);\r\nbreak;\r\ncase INSN_CONFIG_DISARM:\r\noutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nbreak;\r\ncase INSN_CONFIG_GET_COUNTER_STATUS:\r\ndata[1] = 0;\r\nval = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nif (val & ADDI_TCW_CTRL_IRQ_ENA)\r\ndata[1] |= COMEDI_COUNTER_ARMED;\r\nif (val & ADDI_TCW_CTRL_TIMER_ENA)\r\ndata[1] |= COMEDI_COUNTER_COUNTING;\r\nval = inl(devpriv->timer + ADDI_TCW_STATUS_REG);\r\nif (val & ADDI_TCW_STATUS_OVERFLOW)\r\ndata[1] |= COMEDI_COUNTER_TERMINAL_COUNT;\r\ndata[2] = COMEDI_COUNTER_ARMED | COMEDI_COUNTER_COUNTING |\r\nCOMEDI_COUNTER_TERMINAL_COUNT;\r\nbreak;\r\ncase INSN_CONFIG_SET_CLOCK_SRC:\r\nif (data[2] > s->maxdata)\r\nreturn -EINVAL;\r\noutl(data[1], devpriv->timer + ADDI_TCW_TIMEBASE_REG);\r\noutl(data[2], devpriv->timer + ADDI_TCW_RELOAD_REG);\r\nbreak;\r\ncase INSN_CONFIG_GET_CLOCK_SRC:\r\ndata[1] = inl(devpriv->timer + ADDI_TCW_TIMEBASE_REG);\r\ndata[2] = inl(devpriv->timer + ADDI_TCW_RELOAD_REG);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nif (insn->n) {\r\nunsigned int val = data[insn->n - 1];\r\noutl(val, devpriv->timer + ADDI_TCW_RELOAD_REG);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = inl(devpriv->timer + ADDI_TCW_VAL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int val;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_ARM:\r\nval = inl(iobase + ADDI_TCW_CTRL_REG);\r\nval |= ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_CNTR_ENA;\r\noutl(data[1], iobase + ADDI_TCW_RELOAD_REG);\r\noutl(val, iobase + ADDI_TCW_CTRL_REG);\r\nbreak;\r\ncase INSN_CONFIG_DISARM:\r\nval = inl(iobase + ADDI_TCW_CTRL_REG);\r\nval &= ~(ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_CNTR_ENA);\r\noutl(val, iobase + ADDI_TCW_CTRL_REG);\r\nbreak;\r\ncase INSN_CONFIG_SET_COUNTER_MODE:\r\noutl(data[1], iobase + ADDI_TCW_CTRL_REG);\r\nbreak;\r\ncase INSN_CONFIG_GET_COUNTER_STATUS:\r\ndata[1] = 0;\r\nval = inl(iobase + ADDI_TCW_CTRL_REG);\r\nif (val & ADDI_TCW_CTRL_IRQ_ENA)\r\ndata[1] |= COMEDI_COUNTER_ARMED;\r\nif (val & ADDI_TCW_CTRL_CNTR_ENA)\r\ndata[1] |= COMEDI_COUNTER_COUNTING;\r\nval = inl(iobase + ADDI_TCW_STATUS_REG);\r\nif (val & ADDI_TCW_STATUS_OVERFLOW)\r\ndata[1] |= COMEDI_COUNTER_TERMINAL_COUNT;\r\ndata[2] = COMEDI_COUNTER_ARMED | COMEDI_COUNTER_COUNTING |\r\nCOMEDI_COUNTER_TERMINAL_COUNT;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nif (insn->n) {\r\nunsigned int val = data[insn->n - 1];\r\noutl(val, iobase + ADDI_TCW_RELOAD_REG);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = inl(iobase + ADDI_TCW_VAL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct apci1564_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nunsigned int val;\r\nint ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv->eeprom = pci_resource_start(pcidev, 0);\r\nval = inl(devpriv->eeprom + APCI1564_EEPROM_REG);\r\nif (APCI1564_EEPROM_TO_REV(val) == 0) {\r\ndev->iobase = pci_resource_start(pcidev, 1) +\r\nAPCI1564_REV1_MAIN_IOBASE;\r\ndevpriv->timer = devpriv->eeprom + APCI1564_REV1_TIMER_IOBASE;\r\n} else {\r\ndev->iobase = devpriv->eeprom + APCI1564_REV2_MAIN_IOBASE;\r\ndevpriv->timer = devpriv->eeprom + APCI1564_REV2_TIMER_IOBASE;\r\ndevpriv->counters = pci_resource_start(pcidev, 1);\r\n}\r\napci1564_reset(dev);\r\nif (pcidev->irq > 0) {\r\nret = request_irq(pcidev->irq, apci1564_interrupt, IRQF_SHARED,\r\ndev->board_name, dev);\r\nif (ret == 0)\r\ndev->irq = pcidev->irq;\r\n}\r\nret = comedi_alloc_subdevices(dev, 7);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 32;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = apci1564_di_insn_bits;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 32;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = apci1564_do_insn_bits;\r\ns = &dev->subdevices[2];\r\nif (dev->irq) {\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_CMD_READ | SDF_LSAMPL;\r\ns->n_chan = 1;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->len_chanlist = 1;\r\ns->insn_config = apci1564_cos_insn_config;\r\ns->insn_bits = apci1564_cos_insn_bits;\r\ns->do_cmdtest = apci1564_cos_cmdtest;\r\ns->do_cmd = apci1564_cos_cmd;\r\ns->cancel = apci1564_cos_cancel;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_TIMER;\r\ns->subdev_flags = SDF_WRITABLE | SDF_READABLE;\r\ns->n_chan = 1;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &range_digital;\r\ns->insn_config = apci1564_timer_insn_config;\r\ns->insn_write = apci1564_timer_insn_write;\r\ns->insn_read = apci1564_timer_insn_read;\r\ns = &dev->subdevices[4];\r\nif (devpriv->counters) {\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_WRITABLE | SDF_READABLE | SDF_LSAMPL;\r\ns->n_chan = 3;\r\ns->maxdata = 0xffffffff;\r\ns->range_table = &range_digital;\r\ns->insn_config = apci1564_counter_insn_config;\r\ns->insn_write = apci1564_counter_insn_write;\r\ns->insn_read = apci1564_counter_insn_read;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[5];\r\nret = addi_watchdog_init(s, dev->iobase + APCI1564_WDOG_IOBASE);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[6];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = apci1564_diag_insn_bits;\r\nreturn 0;\r\n}\r\nstatic void apci1564_detach(struct comedi_device *dev)\r\n{\r\nif (dev->iobase)\r\napci1564_reset(dev);\r\ncomedi_pci_detach(dev);\r\n}\r\nstatic int apci1564_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &apci1564_driver, id->driver_data);\r\n}

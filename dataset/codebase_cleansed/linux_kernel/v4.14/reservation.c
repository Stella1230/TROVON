static int wusbhc_bwa_set(struct wusbhc *wusbhc, u8 stream,\r\nconst struct uwb_mas_bm *mas)\r\n{\r\nif (mas == NULL)\r\nmas = &uwb_mas_bm_zero;\r\nreturn wusbhc->bwa_set(wusbhc, stream, mas);\r\n}\r\nstatic void wusbhc_rsv_complete_cb(struct uwb_rsv *rsv)\r\n{\r\nstruct wusbhc *wusbhc = rsv->pal_priv;\r\nstruct device *dev = wusbhc->dev;\r\nstruct uwb_mas_bm mas;\r\ndev_dbg(dev, "%s: state = %d\n", __func__, rsv->state);\r\nswitch (rsv->state) {\r\ncase UWB_RSV_STATE_O_ESTABLISHED:\r\nuwb_rsv_get_usable_mas(rsv, &mas);\r\ndev_dbg(dev, "established reservation: %*pb\n",\r\nUWB_NUM_MAS, mas.bm);\r\nwusbhc_bwa_set(wusbhc, rsv->stream, &mas);\r\nbreak;\r\ncase UWB_RSV_STATE_NONE:\r\ndev_dbg(dev, "removed reservation\n");\r\nwusbhc_bwa_set(wusbhc, 0, NULL);\r\nbreak;\r\ndefault:\r\ndev_dbg(dev, "unexpected reservation state: %d\n", rsv->state);\r\nbreak;\r\n}\r\n}\r\nint wusbhc_rsv_establish(struct wusbhc *wusbhc)\r\n{\r\nstruct uwb_rc *rc = wusbhc->uwb_rc;\r\nstruct uwb_rsv *rsv;\r\nstruct uwb_dev_addr bcid;\r\nint ret;\r\nif (rc == NULL)\r\nreturn -ENODEV;\r\nrsv = uwb_rsv_create(rc, wusbhc_rsv_complete_cb, wusbhc);\r\nif (rsv == NULL)\r\nreturn -ENOMEM;\r\nbcid.data[0] = wusbhc->cluster_id;\r\nbcid.data[1] = 0;\r\nrsv->target.type = UWB_RSV_TARGET_DEVADDR;\r\nrsv->target.devaddr = bcid;\r\nrsv->type = UWB_DRP_TYPE_PRIVATE;\r\nrsv->max_mas = 256;\r\nrsv->min_mas = 15;\r\nrsv->max_interval = 1;\r\nrsv->is_multicast = true;\r\nret = uwb_rsv_establish(rsv);\r\nif (ret == 0)\r\nwusbhc->rsv = rsv;\r\nelse\r\nuwb_rsv_destroy(rsv);\r\nreturn ret;\r\n}\r\nvoid wusbhc_rsv_terminate(struct wusbhc *wusbhc)\r\n{\r\nif (wusbhc->rsv) {\r\nuwb_rsv_terminate(wusbhc->rsv);\r\nuwb_rsv_destroy(wusbhc->rsv);\r\nwusbhc->rsv = NULL;\r\n}\r\n}

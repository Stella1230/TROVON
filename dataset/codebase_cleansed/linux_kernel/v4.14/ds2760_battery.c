static int battery_interpolate(int array[], int temp)\r\n{\r\nint index, dt;\r\nif (temp <= 0)\r\nreturn array[0];\r\nif (temp >= 40)\r\nreturn array[4];\r\nindex = temp / 10;\r\ndt = temp % 10;\r\nreturn array[index] + (((array[index + 1] - array[index]) * dt) / 10);\r\n}\r\nstatic int ds2760_battery_read_status(struct ds2760_device_info *di)\r\n{\r\nint ret, i, start, count, scale[5];\r\nif (di->update_time && time_before(jiffies, di->update_time +\r\nmsecs_to_jiffies(cache_time)))\r\nreturn 0;\r\nif (di->update_time == 0) {\r\nstart = 0;\r\ncount = DS2760_DATA_SIZE;\r\n} else {\r\nstart = DS2760_VOLTAGE_MSB;\r\ncount = DS2760_TEMP_LSB - start + 1;\r\n}\r\nret = w1_ds2760_read(di->w1_dev, di->raw + start, start, count);\r\nif (ret != count) {\r\ndev_warn(di->dev, "call to w1_ds2760_read failed (0x%p)\n",\r\ndi->w1_dev);\r\nreturn 1;\r\n}\r\ndi->update_time = jiffies;\r\ndi->voltage_raw = (di->raw[DS2760_VOLTAGE_MSB] << 3) |\r\n(di->raw[DS2760_VOLTAGE_LSB] >> 5);\r\ndi->voltage_uV = di->voltage_raw * 4880;\r\ndi->current_raw =\r\n(((signed char)di->raw[DS2760_CURRENT_MSB]) << 5) |\r\n(di->raw[DS2760_CURRENT_LSB] >> 3);\r\ndi->current_uA = di->current_raw * 625;\r\ndi->accum_current_raw =\r\n(((signed char)di->raw[DS2760_CURRENT_ACCUM_MSB]) << 8) |\r\ndi->raw[DS2760_CURRENT_ACCUM_LSB];\r\ndi->accum_current_uAh = di->accum_current_raw * 250;\r\ndi->temp_raw = (((signed char)di->raw[DS2760_TEMP_MSB]) << 3) |\r\n(di->raw[DS2760_TEMP_LSB] >> 5);\r\ndi->temp_C = di->temp_raw + (di->temp_raw / 4);\r\nif (di->raw[DS2760_RATED_CAPACITY] < ARRAY_SIZE(rated_capacities))\r\ndi->rated_capacity = rated_capacities[\r\n(unsigned int)di->raw[DS2760_RATED_CAPACITY]];\r\nelse\r\ndi->rated_capacity = di->raw[DS2760_RATED_CAPACITY] * 10;\r\ndi->rated_capacity *= 1000;\r\ndi->full_active_uAh = di->raw[DS2760_ACTIVE_FULL] << 8 |\r\ndi->raw[DS2760_ACTIVE_FULL + 1];\r\nif (di->full_active_uAh == 0)\r\ndi->full_active_uAh = di->rated_capacity / 1000L;\r\nscale[0] = di->full_active_uAh;\r\nfor (i = 1; i < 5; i++)\r\nscale[i] = scale[i - 1] + di->raw[DS2760_ACTIVE_FULL + 1 + i];\r\ndi->full_active_uAh = battery_interpolate(scale, di->temp_C / 10);\r\ndi->full_active_uAh *= 1000;\r\nscale[4] = di->raw[DS2760_ACTIVE_EMPTY + 4];\r\nfor (i = 3; i >= 0; i--)\r\nscale[i] = scale[i + 1] + di->raw[DS2760_ACTIVE_EMPTY + i];\r\ndi->empty_uAh = battery_interpolate(scale, di->temp_C / 10);\r\ndi->empty_uAh *= 1000;\r\nif (di->full_active_uAh == di->empty_uAh)\r\ndi->rem_capacity = 0;\r\nelse\r\ndi->rem_capacity = ((di->accum_current_uAh - di->empty_uAh) * 100L) /\r\n(di->full_active_uAh - di->empty_uAh);\r\nif (di->rem_capacity < 0)\r\ndi->rem_capacity = 0;\r\nif (di->rem_capacity > 100)\r\ndi->rem_capacity = 100;\r\nif (di->current_uA < -100L)\r\ndi->life_sec = -((di->accum_current_uAh - di->empty_uAh) * 36L)\r\n/ (di->current_uA / 100L);\r\nelse\r\ndi->life_sec = 0;\r\nreturn 0;\r\n}\r\nstatic void ds2760_battery_set_current_accum(struct ds2760_device_info *di,\r\nunsigned int acr_val)\r\n{\r\nunsigned char acr[2];\r\nacr_val *= 4L;\r\nacr_val /= 1000;\r\nacr[0] = acr_val >> 8;\r\nacr[1] = acr_val & 0xff;\r\nif (w1_ds2760_write(di->w1_dev, acr, DS2760_CURRENT_ACCUM_MSB, 2) < 2)\r\ndev_warn(di->dev, "ACR write failed\n");\r\n}\r\nstatic void ds2760_battery_update_status(struct ds2760_device_info *di)\r\n{\r\nint old_charge_status = di->charge_status;\r\nds2760_battery_read_status(di);\r\nif (di->charge_status == POWER_SUPPLY_STATUS_UNKNOWN)\r\ndi->full_counter = 0;\r\nif (power_supply_am_i_supplied(di->bat)) {\r\nif (di->current_uA > 10000) {\r\ndi->charge_status = POWER_SUPPLY_STATUS_CHARGING;\r\ndi->full_counter = 0;\r\n} else if (di->current_uA < -5000) {\r\nif (di->charge_status != POWER_SUPPLY_STATUS_NOT_CHARGING)\r\ndev_notice(di->dev, "not enough power to "\r\n"charge\n");\r\ndi->charge_status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\ndi->full_counter = 0;\r\n} else if (di->current_uA < 10000 &&\r\ndi->charge_status != POWER_SUPPLY_STATUS_FULL) {\r\ndi->full_counter++;\r\nif (di->full_counter < 2) {\r\ndi->charge_status = POWER_SUPPLY_STATUS_CHARGING;\r\n} else {\r\ndi->charge_status = POWER_SUPPLY_STATUS_FULL;\r\nds2760_battery_set_current_accum(di,\r\ndi->full_active_uAh);\r\n}\r\n}\r\n} else {\r\ndi->charge_status = POWER_SUPPLY_STATUS_DISCHARGING;\r\ndi->full_counter = 0;\r\n}\r\nif (di->charge_status != old_charge_status)\r\npower_supply_changed(di->bat);\r\n}\r\nstatic void ds2760_battery_write_status(struct ds2760_device_info *di,\r\nchar status)\r\n{\r\nif (status == di->raw[DS2760_STATUS_REG])\r\nreturn;\r\nw1_ds2760_write(di->w1_dev, &status, DS2760_STATUS_WRITE_REG, 1);\r\nw1_ds2760_store_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\nw1_ds2760_recall_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\n}\r\nstatic void ds2760_battery_write_rated_capacity(struct ds2760_device_info *di,\r\nunsigned char rated_capacity)\r\n{\r\nif (rated_capacity == di->raw[DS2760_RATED_CAPACITY])\r\nreturn;\r\nw1_ds2760_write(di->w1_dev, &rated_capacity, DS2760_RATED_CAPACITY, 1);\r\nw1_ds2760_store_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\nw1_ds2760_recall_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\n}\r\nstatic void ds2760_battery_write_active_full(struct ds2760_device_info *di,\r\nint active_full)\r\n{\r\nunsigned char tmp[2] = {\r\nactive_full >> 8,\r\nactive_full & 0xff\r\n};\r\nif (tmp[0] == di->raw[DS2760_ACTIVE_FULL] &&\r\ntmp[1] == di->raw[DS2760_ACTIVE_FULL + 1])\r\nreturn;\r\nw1_ds2760_write(di->w1_dev, tmp, DS2760_ACTIVE_FULL, sizeof(tmp));\r\nw1_ds2760_store_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK0);\r\nw1_ds2760_recall_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK0);\r\ndi->raw[DS2760_ACTIVE_FULL] = tmp[0];\r\ndi->raw[DS2760_ACTIVE_FULL + 1] = tmp[1];\r\n}\r\nstatic void ds2760_battery_work(struct work_struct *work)\r\n{\r\nstruct ds2760_device_info *di = container_of(work,\r\nstruct ds2760_device_info, monitor_work.work);\r\nconst int interval = HZ * 60;\r\ndev_dbg(di->dev, "%s\n", __func__);\r\nds2760_battery_update_status(di);\r\nqueue_delayed_work(di->monitor_wqueue, &di->monitor_work, interval);\r\n}\r\nstatic void ds2760_battery_external_power_changed(struct power_supply *psy)\r\n{\r\nstruct ds2760_device_info *di = power_supply_get_drvdata(psy);\r\ndev_dbg(di->dev, "%s\n", __func__);\r\nmod_delayed_work(di->monitor_wqueue, &di->monitor_work, HZ/10);\r\n}\r\nstatic void ds2760_battery_set_charged_work(struct work_struct *work)\r\n{\r\nchar bias;\r\nstruct ds2760_device_info *di = container_of(work,\r\nstruct ds2760_device_info, set_charged_work.work);\r\ndev_dbg(di->dev, "%s\n", __func__);\r\nds2760_battery_read_status(di);\r\nif (!power_supply_am_i_supplied(di->bat))\r\nreturn;\r\nbias = (signed char) di->current_raw +\r\n(signed char) di->raw[DS2760_CURRENT_OFFSET_BIAS];\r\ndev_dbg(di->dev, "%s: bias = %d\n", __func__, bias);\r\nw1_ds2760_write(di->w1_dev, &bias, DS2760_CURRENT_OFFSET_BIAS, 1);\r\nw1_ds2760_store_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\nw1_ds2760_recall_eeprom(di->w1_dev, DS2760_EEPROM_BLOCK1);\r\ndi->raw[DS2760_CURRENT_OFFSET_BIAS] = bias;\r\n}\r\nstatic void ds2760_battery_set_charged(struct power_supply *psy)\r\n{\r\nstruct ds2760_device_info *di = power_supply_get_drvdata(psy);\r\nmod_delayed_work(di->monitor_wqueue, &di->set_charged_work, HZ * 20);\r\n}\r\nstatic int ds2760_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct ds2760_device_info *di = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = di->charge_status;\r\nreturn 0;\r\ndefault:\r\nbreak;\r\n}\r\nds2760_battery_read_status(di);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = di->voltage_uV;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nval->intval = di->current_uA;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\r\nval->intval = di->rated_capacity;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nval->intval = di->full_active_uAh;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_EMPTY:\r\nval->intval = di->empty_uAh;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nval->intval = di->accum_current_uAh;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = di->temp_C;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW:\r\nval->intval = di->life_sec;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = di->rem_capacity;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds2760_battery_set_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct ds2760_device_info *di = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nds2760_battery_write_active_full(di, val->intval / 1000L);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nds2760_battery_set_current_accum(di, val->intval);\r\nbreak;\r\ndefault:\r\nreturn -EPERM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds2760_battery_property_is_writeable(struct power_supply *psy,\r\nenum power_supply_property psp)\r\n{\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nreturn 1;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds2760_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct power_supply_config psy_cfg = {};\r\nchar status;\r\nint retval = 0;\r\nstruct ds2760_device_info *di;\r\ndi = devm_kzalloc(&pdev->dev, sizeof(*di), GFP_KERNEL);\r\nif (!di) {\r\nretval = -ENOMEM;\r\ngoto di_alloc_failed;\r\n}\r\nplatform_set_drvdata(pdev, di);\r\ndi->dev = &pdev->dev;\r\ndi->w1_dev = pdev->dev.parent;\r\ndi->bat_desc.name = dev_name(&pdev->dev);\r\ndi->bat_desc.type = POWER_SUPPLY_TYPE_BATTERY;\r\ndi->bat_desc.properties = ds2760_battery_props;\r\ndi->bat_desc.num_properties = ARRAY_SIZE(ds2760_battery_props);\r\ndi->bat_desc.get_property = ds2760_battery_get_property;\r\ndi->bat_desc.set_property = ds2760_battery_set_property;\r\ndi->bat_desc.property_is_writeable =\r\nds2760_battery_property_is_writeable;\r\ndi->bat_desc.set_charged = ds2760_battery_set_charged;\r\ndi->bat_desc.external_power_changed =\r\nds2760_battery_external_power_changed;\r\npsy_cfg.drv_data = di;\r\ndi->charge_status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nds2760_battery_read_status(di);\r\nstatus = di->raw[DS2760_STATUS_REG];\r\nif (pmod_enabled)\r\nstatus |= DS2760_STATUS_PMOD;\r\nelse\r\nstatus &= ~DS2760_STATUS_PMOD;\r\nds2760_battery_write_status(di, status);\r\nif (rated_capacity)\r\nds2760_battery_write_rated_capacity(di, rated_capacity);\r\nif (current_accum)\r\nds2760_battery_set_current_accum(di, current_accum);\r\ndi->bat = power_supply_register(&pdev->dev, &di->bat_desc, &psy_cfg);\r\nif (IS_ERR(di->bat)) {\r\ndev_err(di->dev, "failed to register battery\n");\r\nretval = PTR_ERR(di->bat);\r\ngoto batt_failed;\r\n}\r\nINIT_DELAYED_WORK(&di->monitor_work, ds2760_battery_work);\r\nINIT_DELAYED_WORK(&di->set_charged_work,\r\nds2760_battery_set_charged_work);\r\ndi->monitor_wqueue = alloc_ordered_workqueue(dev_name(&pdev->dev),\r\nWQ_MEM_RECLAIM);\r\nif (!di->monitor_wqueue) {\r\nretval = -ESRCH;\r\ngoto workqueue_failed;\r\n}\r\nqueue_delayed_work(di->monitor_wqueue, &di->monitor_work, HZ * 1);\r\ngoto success;\r\nworkqueue_failed:\r\npower_supply_unregister(di->bat);\r\nbatt_failed:\r\ndi_alloc_failed:\r\nsuccess:\r\nreturn retval;\r\n}\r\nstatic int ds2760_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct ds2760_device_info *di = platform_get_drvdata(pdev);\r\ncancel_delayed_work_sync(&di->monitor_work);\r\ncancel_delayed_work_sync(&di->set_charged_work);\r\ndestroy_workqueue(di->monitor_wqueue);\r\npower_supply_unregister(di->bat);\r\nreturn 0;\r\n}\r\nstatic int ds2760_battery_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nstruct ds2760_device_info *di = platform_get_drvdata(pdev);\r\ndi->charge_status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nreturn 0;\r\n}\r\nstatic int ds2760_battery_resume(struct platform_device *pdev)\r\n{\r\nstruct ds2760_device_info *di = platform_get_drvdata(pdev);\r\ndi->charge_status = POWER_SUPPLY_STATUS_UNKNOWN;\r\npower_supply_changed(di->bat);\r\nmod_delayed_work(di->monitor_wqueue, &di->monitor_work, HZ);\r\nreturn 0;\r\n}

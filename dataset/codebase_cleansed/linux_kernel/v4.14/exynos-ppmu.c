static int exynos_ppmu_find_ppmu_id(struct devfreq_event_dev *edev)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ppmu_events); i++)\r\nif (!strcmp(edev->desc->name, ppmu_events[i].name))\r\nreturn ppmu_events[i].id;\r\nreturn -EINVAL;\r\n}\r\nstatic int exynos_ppmu_disable(struct devfreq_event_dev *edev)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nint ret;\r\nu32 pmnc;\r\nret = regmap_write(info->regmap, PPMU_CNTENC,\r\nPPMU_CCNT_MASK |\r\nPPMU_PMCNT0_MASK |\r\nPPMU_PMCNT1_MASK |\r\nPPMU_PMCNT2_MASK |\r\nPPMU_PMCNT3_MASK);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~PPMU_PMNC_ENABLE_MASK;\r\nret = regmap_write(info->regmap, PPMU_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_set_event(struct devfreq_event_dev *edev)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nint id = exynos_ppmu_find_ppmu_id(edev);\r\nint ret;\r\nu32 pmnc, cntens;\r\nif (id < 0)\r\nreturn id;\r\nret = regmap_read(info->regmap, PPMU_CNTENS, &cntens);\r\nif (ret < 0)\r\nreturn ret;\r\ncntens |= (PPMU_CCNT_MASK | (PPMU_ENABLE << id));\r\nret = regmap_write(info->regmap, PPMU_CNTENS, cntens);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_BEVTxSEL(id),\r\nPPMU_RO_DATA_CNT | PPMU_WO_DATA_CNT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~(PPMU_PMNC_ENABLE_MASK\r\n| PPMU_PMNC_COUNTER_RESET_MASK\r\n| PPMU_PMNC_CC_RESET_MASK);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_ENABLE_SHIFT);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_COUNTER_RESET_SHIFT);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_CC_RESET_SHIFT);\r\nret = regmap_write(info->regmap, PPMU_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_get_event(struct devfreq_event_dev *edev,\r\nstruct devfreq_event_data *edata)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nint id = exynos_ppmu_find_ppmu_id(edev);\r\nunsigned int total_count, load_count;\r\nunsigned int pmcnt3_high, pmcnt3_low;\r\nunsigned int pmnc, cntenc;\r\nint ret;\r\nif (id < 0)\r\nreturn -EINVAL;\r\nret = regmap_read(info->regmap, PPMU_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~PPMU_PMNC_ENABLE_MASK;\r\nret = regmap_write(info->regmap, PPMU_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_CCNT, &total_count);\r\nif (ret < 0)\r\nreturn ret;\r\nedata->total_count = total_count;\r\nswitch (id) {\r\ncase PPMU_PMNCNT0:\r\ncase PPMU_PMNCNT1:\r\ncase PPMU_PMNCNT2:\r\nret = regmap_read(info->regmap, PPMU_PMNCT(id), &load_count);\r\nif (ret < 0)\r\nreturn ret;\r\nedata->load_count = load_count;\r\nbreak;\r\ncase PPMU_PMNCNT3:\r\nret = regmap_read(info->regmap, PPMU_PMCNT3_HIGH, &pmcnt3_high);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_PMCNT3_LOW, &pmcnt3_low);\r\nif (ret < 0)\r\nreturn ret;\r\nedata->load_count = ((pmcnt3_high << 8) | pmcnt3_low);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = regmap_read(info->regmap, PPMU_CNTENC, &cntenc);\r\nif (ret < 0)\r\nreturn ret;\r\ncntenc |= (PPMU_CCNT_MASK | (PPMU_ENABLE << id));\r\nret = regmap_write(info->regmap, PPMU_CNTENC, cntenc);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(&edev->dev, "%s (event: %ld/%ld)\n", edev->desc->name,\r\nedata->load_count, edata->total_count);\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_v2_disable(struct devfreq_event_dev *edev)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nint ret;\r\nu32 pmnc, clear;\r\nclear = (PPMU_CCNT_MASK | PPMU_PMCNT0_MASK | PPMU_PMCNT1_MASK\r\n| PPMU_PMCNT2_MASK | PPMU_PMCNT3_MASK);\r\nret = regmap_write(info->regmap, PPMU_V2_FLAG, clear);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_INTENC, clear);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CNTENC, clear);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CNT_RESET, clear);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CIG_CFG0, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CIG_CFG1, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CIG_CFG2, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CIG_RESULT, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CNT_AUTO, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EV0_TYPE, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EV1_TYPE, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EV2_TYPE, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EV3_TYPE, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_SM_ID_V, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_SM_ID_A, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_SM_OTHERS_V, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_SM_OTHERS_A, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(info->regmap, PPMU_V2_INTERRUPT_RESET, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_V2_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~PPMU_PMNC_ENABLE_MASK;\r\nret = regmap_write(info->regmap, PPMU_V2_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_v2_set_event(struct devfreq_event_dev *edev)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nunsigned int pmnc, cntens;\r\nint id = exynos_ppmu_find_ppmu_id(edev);\r\nint ret;\r\nret = regmap_read(info->regmap, PPMU_V2_CNTENS, &cntens);\r\nif (ret < 0)\r\nreturn ret;\r\ncntens |= (PPMU_CCNT_MASK | (PPMU_ENABLE << id));\r\nret = regmap_write(info->regmap, PPMU_V2_CNTENS, cntens);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (id) {\r\ncase PPMU_PMNCNT0:\r\ncase PPMU_PMNCNT1:\r\ncase PPMU_PMNCNT2:\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EVx_TYPE(id),\r\nPPMU_V2_RO_DATA_CNT | PPMU_V2_WO_DATA_CNT);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase PPMU_PMNCNT3:\r\nret = regmap_write(info->regmap, PPMU_V2_CH_EVx_TYPE(id),\r\nPPMU_V2_EVT3_RW_DATA_CNT);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\n}\r\nret = regmap_read(info->regmap, PPMU_V2_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~(PPMU_PMNC_ENABLE_MASK\r\n| PPMU_PMNC_COUNTER_RESET_MASK\r\n| PPMU_PMNC_CC_RESET_MASK\r\n| PPMU_PMNC_CC_DIVIDER_MASK\r\n| PPMU_V2_PMNC_START_MODE_MASK);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_ENABLE_SHIFT);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_COUNTER_RESET_SHIFT);\r\npmnc |= (PPMU_ENABLE << PPMU_PMNC_CC_RESET_SHIFT);\r\npmnc |= (PPMU_V2_MODE_MANUAL << PPMU_V2_PMNC_START_MODE_SHIFT);\r\nret = regmap_write(info->regmap, PPMU_V2_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_v2_get_event(struct devfreq_event_dev *edev,\r\nstruct devfreq_event_data *edata)\r\n{\r\nstruct exynos_ppmu *info = devfreq_event_get_drvdata(edev);\r\nint id = exynos_ppmu_find_ppmu_id(edev);\r\nint ret;\r\nunsigned int pmnc, cntenc;\r\nunsigned int pmcnt_high, pmcnt_low;\r\nunsigned int total_count, count;\r\nunsigned long load_count = 0;\r\nret = regmap_read(info->regmap, PPMU_V2_PMNC, &pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\npmnc &= ~PPMU_PMNC_ENABLE_MASK;\r\nret = regmap_write(info->regmap, PPMU_V2_PMNC, pmnc);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_V2_CCNT, &total_count);\r\nif (ret < 0)\r\nreturn ret;\r\nedata->total_count = total_count;\r\nswitch (id) {\r\ncase PPMU_PMNCNT0:\r\ncase PPMU_PMNCNT1:\r\ncase PPMU_PMNCNT2:\r\nret = regmap_read(info->regmap, PPMU_V2_PMNCT(id), &count);\r\nif (ret < 0)\r\nreturn ret;\r\nload_count = count;\r\nbreak;\r\ncase PPMU_PMNCNT3:\r\nret = regmap_read(info->regmap, PPMU_V2_PMCNT3_HIGH,\r\n&pmcnt_high);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(info->regmap, PPMU_V2_PMCNT3_LOW, &pmcnt_low);\r\nif (ret < 0)\r\nreturn ret;\r\nload_count = ((u64)((pmcnt_high & 0xff)) << 32)+ (u64)pmcnt_low;\r\nbreak;\r\n}\r\nedata->load_count = load_count;\r\nret = regmap_read(info->regmap, PPMU_V2_CNTENC, &cntenc);\r\nif (ret < 0)\r\nreturn 0;\r\ncntenc |= (PPMU_CCNT_MASK | (PPMU_ENABLE << id));\r\nret = regmap_write(info->regmap, PPMU_V2_CNTENC, cntenc);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(&edev->dev, "%25s (load: %ld / %ld)\n", edev->desc->name,\r\nedata->load_count, edata->total_count);\r\nreturn 0;\r\n}\r\nstatic struct devfreq_event_ops *exynos_bus_get_ops(struct device_node *np)\r\n{\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(exynos_ppmu_id_match, np);\r\nreturn (struct devfreq_event_ops *)match->data;\r\n}\r\nstatic int of_get_devfreq_events(struct device_node *np,\r\nstruct exynos_ppmu *info)\r\n{\r\nstruct devfreq_event_desc *desc;\r\nstruct devfreq_event_ops *event_ops;\r\nstruct device *dev = info->dev;\r\nstruct device_node *events_np, *node;\r\nint i, j, count;\r\nevents_np = of_get_child_by_name(np, "events");\r\nif (!events_np) {\r\ndev_err(dev,\r\n"failed to get child node of devfreq-event devices\n");\r\nreturn -EINVAL;\r\n}\r\nevent_ops = exynos_bus_get_ops(np);\r\ncount = of_get_child_count(events_np);\r\ndesc = devm_kzalloc(dev, sizeof(*desc) * count, GFP_KERNEL);\r\nif (!desc)\r\nreturn -ENOMEM;\r\ninfo->num_events = count;\r\nj = 0;\r\nfor_each_child_of_node(events_np, node) {\r\nfor (i = 0; i < ARRAY_SIZE(ppmu_events); i++) {\r\nif (!ppmu_events[i].name)\r\ncontinue;\r\nif (!of_node_cmp(node->name, ppmu_events[i].name))\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(ppmu_events)) {\r\ndev_warn(dev,\r\n"don't know how to configure events : %s\n",\r\nnode->name);\r\ncontinue;\r\n}\r\ndesc[j].ops = event_ops;\r\ndesc[j].driver_data = info;\r\nof_property_read_string(node, "event-name", &desc[j].name);\r\nj++;\r\n}\r\ninfo->desc = desc;\r\nof_node_put(events_np);\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_parse_dt(struct platform_device *pdev,\r\nstruct exynos_ppmu *info)\r\n{\r\nstruct device *dev = info->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nint ret = 0;\r\nif (!np) {\r\ndev_err(dev, "failed to find devicetree node\n");\r\nreturn -EINVAL;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nexynos_ppmu_regmap_config.max_register = resource_size(res) - 4;\r\ninfo->regmap = devm_regmap_init_mmio(dev, base,\r\n&exynos_ppmu_regmap_config);\r\nif (IS_ERR(info->regmap)) {\r\ndev_err(dev, "failed to initialize regmap\n");\r\nreturn PTR_ERR(info->regmap);\r\n}\r\ninfo->ppmu.clk = devm_clk_get(dev, "ppmu");\r\nif (IS_ERR(info->ppmu.clk)) {\r\ninfo->ppmu.clk = NULL;\r\ndev_warn(dev, "cannot get PPMU clock\n");\r\n}\r\nret = of_get_devfreq_events(np, info);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to parse exynos ppmu dt node\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_probe(struct platform_device *pdev)\r\n{\r\nstruct exynos_ppmu *info;\r\nstruct devfreq_event_dev **edev;\r\nstruct devfreq_event_desc *desc;\r\nint i, ret = 0, size;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->dev = &pdev->dev;\r\nret = exynos_ppmu_parse_dt(pdev, info);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"failed to parse devicetree for resource\n");\r\nreturn ret;\r\n}\r\ndesc = info->desc;\r\nsize = sizeof(struct devfreq_event_dev *) * info->num_events;\r\ninfo->edev = devm_kzalloc(&pdev->dev, size, GFP_KERNEL);\r\nif (!info->edev) {\r\ndev_err(&pdev->dev,\r\n"failed to allocate memory devfreq-event devices\n");\r\nreturn -ENOMEM;\r\n}\r\nedev = info->edev;\r\nplatform_set_drvdata(pdev, info);\r\nfor (i = 0; i < info->num_events; i++) {\r\nedev[i] = devm_devfreq_event_add_edev(&pdev->dev, &desc[i]);\r\nif (IS_ERR(edev[i])) {\r\nret = PTR_ERR(edev[i]);\r\ndev_err(&pdev->dev,\r\n"failed to add devfreq-event device\n");\r\nreturn PTR_ERR(edev[i]);\r\n}\r\npr_info("exynos-ppmu: new PPMU device registered %s (%s)\n",\r\ndev_name(&pdev->dev), desc[i].name);\r\n}\r\nret = clk_prepare_enable(info->ppmu.clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to prepare ppmu clock\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos_ppmu_remove(struct platform_device *pdev)\r\n{\r\nstruct exynos_ppmu *info = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(info->ppmu.clk);\r\nreturn 0;\r\n}

static int mv88e6xxx_g1_vtu_fid_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6352_G1_VTU_FID, &val);\r\nif (err)\r\nreturn err;\r\nentry->fid = val & MV88E6352_G1_VTU_FID_MASK;\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_vtu_fid_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val = entry->fid & MV88E6352_G1_VTU_FID_MASK;\r\nreturn mv88e6xxx_g1_write(chip, MV88E6352_G1_VTU_FID, val);\r\n}\r\nstatic int mv88e6xxx_g1_vtu_sid_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6352_G1_VTU_SID, &val);\r\nif (err)\r\nreturn err;\r\nentry->sid = val & MV88E6352_G1_VTU_SID_MASK;\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_vtu_sid_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val = entry->sid & MV88E6352_G1_VTU_SID_MASK;\r\nreturn mv88e6xxx_g1_write(chip, MV88E6352_G1_VTU_SID, val);\r\n}\r\nstatic int mv88e6xxx_g1_vtu_op_wait(struct mv88e6xxx_chip *chip)\r\n{\r\nreturn mv88e6xxx_g1_wait(chip, MV88E6XXX_G1_VTU_OP,\r\nMV88E6XXX_G1_VTU_OP_BUSY);\r\n}\r\nstatic int mv88e6xxx_g1_vtu_op(struct mv88e6xxx_chip *chip, u16 op)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_OP,\r\nMV88E6XXX_G1_VTU_OP_BUSY | op);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_vtu_op_wait(chip);\r\n}\r\nstatic int mv88e6xxx_g1_vtu_vid_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_VID, &val);\r\nif (err)\r\nreturn err;\r\nentry->vid = val & 0xfff;\r\nif (val & MV88E6390_G1_VTU_VID_PAGE)\r\nentry->vid |= 0x1000;\r\nentry->valid = !!(val & MV88E6XXX_G1_VTU_VID_VALID);\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_vtu_vid_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val = entry->vid & 0xfff;\r\nif (entry->vid & 0x1000)\r\nval |= MV88E6390_G1_VTU_VID_PAGE;\r\nif (entry->valid)\r\nval |= MV88E6XXX_G1_VTU_VID_VALID;\r\nreturn mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_VID, val);\r\n}\r\nstatic int mv88e6185_g1_vtu_data_read(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 regs[3];\r\nint i;\r\nfor (i = 0; i < 3; ++i) {\r\nu16 *reg = &regs[i];\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\r\nif (err)\r\nreturn err;\r\n}\r\nfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\r\nunsigned int member_offset = (i % 4) * 4;\r\nunsigned int state_offset = member_offset + 2;\r\nentry->member[i] = (regs[i / 4] >> member_offset) & 0x3;\r\nentry->state[i] = (regs[i / 4] >> state_offset) & 0x3;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6185_g1_vtu_data_write(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 regs[3] = { 0 };\r\nint i;\r\nfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\r\nunsigned int member_offset = (i % 4) * 4;\r\nunsigned int state_offset = member_offset + 2;\r\nregs[i / 4] |= (entry->member[i] & 0x3) << member_offset;\r\nregs[i / 4] |= (entry->state[i] & 0x3) << state_offset;\r\n}\r\nfor (i = 0; i < 3; ++i) {\r\nu16 reg = regs[i];\r\nint err;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6390_g1_vtu_data_read(struct mv88e6xxx_chip *chip, u8 *data)\r\n{\r\nu16 regs[2];\r\nint i;\r\nfor (i = 0; i < 2; ++i) {\r\nu16 *reg = &regs[i];\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\r\nif (err)\r\nreturn err;\r\n}\r\nfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\r\nunsigned int offset = (i % 8) * 2;\r\ndata[i] = (regs[i / 8] >> offset) & 0x3;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6390_g1_vtu_data_write(struct mv88e6xxx_chip *chip, u8 *data)\r\n{\r\nu16 regs[2] = { 0 };\r\nint i;\r\nfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\r\nunsigned int offset = (i % 8) * 2;\r\nregs[i / 8] |= (data[i] & 0x3) << offset;\r\n}\r\nfor (i = 0; i < 2; ++i) {\r\nu16 reg = regs[i];\r\nint err;\r\nerr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_vtu_stu_getnext(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_sid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_STU_GET_NEXT);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_sid_read(chip, entry);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_vtu_vid_read(chip, entry);\r\n}\r\nstatic int mv88e6xxx_g1_vtu_stu_get(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *vtu)\r\n{\r\nstruct mv88e6xxx_vtu_entry stu;\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_sid_read(chip, vtu);\r\nif (err)\r\nreturn err;\r\nstu.sid = vtu->sid - 1;\r\nerr = mv88e6xxx_g1_vtu_stu_getnext(chip, &stu);\r\nif (err)\r\nreturn err;\r\nif (stu.sid != vtu->sid || !stu.valid)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int mv88e6xxx_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nif (!entry->valid) {\r\nerr = mv88e6xxx_g1_vtu_vid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_GET_NEXT);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_vtu_vid_read(chip, entry);\r\n}\r\nint mv88e6185_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_getnext(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6185_g1_vtu_data_read(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_OP, &val);\r\nif (err)\r\nreturn err;\r\nentry->fid = val & 0x000f;\r\nentry->fid |= (val & 0x0f00) >> 4;\r\n}\r\nreturn 0;\r\n}\r\nint mv88e6352_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_getnext(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6xxx_g1_vtu_stu_get(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6185_g1_vtu_data_read(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_fid_read(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mv88e6390_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_getnext(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6390_g1_vtu_data_read(chip, entry->member);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_stu_get(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6390_g1_vtu_data_read(chip, entry->state);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_fid_read(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mv88e6185_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nu16 op = MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE;\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_vid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6185_g1_vtu_data_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nop |= entry->fid & 0x000f;\r\nop |= (entry->fid & 0x00f0) << 8;\r\n}\r\nreturn mv88e6xxx_g1_vtu_op(chip, op);\r\n}\r\nint mv88e6352_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_vid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6185_g1_vtu_data_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_sid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_op(chip,\r\nMV88E6XXX_G1_VTU_OP_STU_LOAD_PURGE);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_fid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE);\r\n}\r\nint mv88e6390_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\r\nstruct mv88e6xxx_vtu_entry *entry)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_vid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nif (entry->valid) {\r\nerr = mv88e6390_g1_vtu_data_write(chip, entry->state);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_sid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_op(chip,\r\nMV88E6XXX_G1_VTU_OP_STU_LOAD_PURGE);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6390_g1_vtu_data_write(chip, entry->member);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_vtu_fid_write(chip, entry);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE);\r\n}\r\nint mv88e6xxx_g1_vtu_flush(struct mv88e6xxx_chip *chip)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_vtu_op_wait(chip);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_FLUSH_ALL);\r\n}

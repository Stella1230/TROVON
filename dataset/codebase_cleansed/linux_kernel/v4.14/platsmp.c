static int s500_wakeup_secondary(unsigned int cpu)\r\n{\r\nint ret;\r\nif (cpu > 3)\r\nreturn -EINVAL;\r\nswitch (cpu) {\r\ncase 2:\r\nret = owl_sps_set_pg(sps_base_addr,\r\nOWL_SPS_PG_CTL_PWR_CPU2,\r\nOWL_SPS_PG_CTL_ACK_CPU2, true);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase 3:\r\nret = owl_sps_set_pg(sps_base_addr,\r\nOWL_SPS_PG_CTL_PWR_CPU3,\r\nOWL_SPS_PG_CTL_ACK_CPU3, true);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\n}\r\nudelay(200);\r\nwritel(virt_to_phys(owl_secondary_startup),\r\ntimer_base_addr + OWL_CPU1_ADDR + (cpu - 1) * 4);\r\nwritel(OWL_CPUx_FLAG_BOOT,\r\ntimer_base_addr + OWL_CPU1_FLAG + (cpu - 1) * 4);\r\ndsb_sev();\r\nmb();\r\nreturn 0;\r\n}\r\nstatic int s500_smp_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\nunsigned long timeout;\r\nint ret;\r\nret = s500_wakeup_secondary(cpu);\r\nif (ret)\r\nreturn ret;\r\nudelay(10);\r\nspin_lock(&boot_lock);\r\nsmp_send_reschedule(cpu);\r\ntimeout = jiffies + (1 * HZ);\r\nwhile (time_before(jiffies, timeout)) {\r\nif (pen_release == -1)\r\nbreak;\r\n}\r\nwritel(0, timer_base_addr + OWL_CPU1_ADDR + (cpu - 1) * 4);\r\nwritel(0, timer_base_addr + OWL_CPU1_FLAG + (cpu - 1) * 4);\r\nspin_unlock(&boot_lock);\r\nreturn 0;\r\n}\r\nstatic void __init s500_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nstruct device_node *node;\r\nnode = of_find_compatible_node(NULL, NULL, "actions,s500-timer");\r\nif (!node) {\r\npr_err("%s: missing timer\n", __func__);\r\nreturn;\r\n}\r\ntimer_base_addr = of_iomap(node, 0);\r\nif (!timer_base_addr) {\r\npr_err("%s: could not map timer registers\n", __func__);\r\nreturn;\r\n}\r\nnode = of_find_compatible_node(NULL, NULL, "actions,s500-sps");\r\nif (!node) {\r\npr_err("%s: missing sps\n", __func__);\r\nreturn;\r\n}\r\nsps_base_addr = of_iomap(node, 0);\r\nif (!sps_base_addr) {\r\npr_err("%s: could not map sps registers\n", __func__);\r\nreturn;\r\n}\r\nif (read_cpuid_part() == ARM_CPU_PART_CORTEX_A9) {\r\nnode = of_find_compatible_node(NULL, NULL, "arm,cortex-a9-scu");\r\nif (!node) {\r\npr_err("%s: missing scu\n", __func__);\r\nreturn;\r\n}\r\nscu_base_addr = of_iomap(node, 0);\r\nif (!scu_base_addr) {\r\npr_err("%s: could not map scu registers\n", __func__);\r\nreturn;\r\n}\r\nncores = scu_get_core_count(scu_base_addr);\r\npr_debug("%s: ncores %d\n", __func__, ncores);\r\nscu_enable(scu_base_addr);\r\n}\r\n}

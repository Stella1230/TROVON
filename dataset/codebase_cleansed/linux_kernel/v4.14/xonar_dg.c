int cs4245_write_spi(struct oxygen *chip, u8 reg)\r\n{\r\nstruct dg *data = chip->model_data;\r\nunsigned int packet;\r\npacket = reg << 8;\r\npacket |= (CS4245_SPI_ADDRESS | CS4245_SPI_WRITE) << 16;\r\npacket |= data->cs4245_shadow[reg];\r\nreturn oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\r\nOXYGEN_SPI_DATA_LENGTH_3 |\r\nOXYGEN_SPI_CLOCK_1280 |\r\n(0 << OXYGEN_SPI_CODEC_SHIFT) |\r\nOXYGEN_SPI_CEN_LATCH_CLOCK_HI,\r\npacket);\r\n}\r\nint cs4245_read_spi(struct oxygen *chip, u8 addr)\r\n{\r\nstruct dg *data = chip->model_data;\r\nint ret;\r\nret = oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\r\nOXYGEN_SPI_DATA_LENGTH_2 |\r\nOXYGEN_SPI_CEN_LATCH_CLOCK_HI |\r\nOXYGEN_SPI_CLOCK_1280 | (0 << OXYGEN_SPI_CODEC_SHIFT),\r\n((CS4245_SPI_ADDRESS | CS4245_SPI_WRITE) << 8) | addr);\r\nif (ret < 0)\r\nreturn ret;\r\nret = oxygen_write_spi(chip, OXYGEN_SPI_TRIGGER |\r\nOXYGEN_SPI_DATA_LENGTH_2 |\r\nOXYGEN_SPI_CEN_LATCH_CLOCK_HI |\r\nOXYGEN_SPI_CLOCK_1280 | (0 << OXYGEN_SPI_CODEC_SHIFT),\r\n(CS4245_SPI_ADDRESS | CS4245_SPI_READ) << 8);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->cs4245_shadow[addr] = oxygen_read8(chip, OXYGEN_SPI_DATA1);\r\nreturn 0;\r\n}\r\nint cs4245_shadow_control(struct oxygen *chip, enum cs4245_shadow_operation op)\r\n{\r\nstruct dg *data = chip->model_data;\r\nunsigned char addr;\r\nint ret;\r\nfor (addr = 1; addr < ARRAY_SIZE(data->cs4245_shadow); addr++) {\r\nret = (op == CS4245_SAVE_TO_SHADOW ?\r\ncs4245_read_spi(chip, addr) :\r\ncs4245_write_spi(chip, addr));\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void cs4245_init(struct oxygen *chip)\r\n{\r\nstruct dg *data = chip->model_data;\r\ncs4245_shadow_control(chip, CS4245_SAVE_TO_SHADOW);\r\ndata->cs4245_shadow[CS4245_POWER_CTRL] = 0;\r\ndata->cs4245_shadow[CS4245_SIGNAL_SEL] =\r\nCS4245_A_OUT_SEL_DAC | CS4245_ASYNCH;\r\ndata->cs4245_shadow[CS4245_DAC_CTRL_1] =\r\nCS4245_DAC_FM_SINGLE | CS4245_DAC_DIF_LJUST;\r\ndata->cs4245_shadow[CS4245_DAC_CTRL_2] =\r\nCS4245_DAC_SOFT | CS4245_DAC_ZERO | CS4245_INVERT_DAC;\r\ndata->cs4245_shadow[CS4245_ADC_CTRL] =\r\nCS4245_ADC_FM_SINGLE | CS4245_ADC_DIF_LJUST;\r\ndata->cs4245_shadow[CS4245_ANALOG_IN] =\r\nCS4245_PGA_SOFT | CS4245_PGA_ZERO;\r\ndata->cs4245_shadow[CS4245_PGA_B_CTRL] = 0;\r\ndata->cs4245_shadow[CS4245_PGA_A_CTRL] = 0;\r\ndata->cs4245_shadow[CS4245_DAC_A_CTRL] = 8;\r\ndata->cs4245_shadow[CS4245_DAC_B_CTRL] = 8;\r\ncs4245_shadow_control(chip, CS4245_LOAD_FROM_SHADOW);\r\nsnd_component_add(chip->card, "CS4245");\r\n}\r\nvoid dg_init(struct oxygen *chip)\r\n{\r\nstruct dg *data = chip->model_data;\r\ndata->output_sel = PLAYBACK_DST_HP_FP;\r\ndata->input_sel = CAPTURE_SRC_MIC;\r\ncs4245_init(chip);\r\noxygen_write16(chip, OXYGEN_GPIO_CONTROL,\r\nGPIO_OUTPUT_ENABLE | GPIO_HP_REAR | GPIO_INPUT_ROUTE);\r\nmsleep(2500);\r\noxygen_write16(chip, OXYGEN_GPIO_DATA,\r\nGPIO_OUTPUT_ENABLE | GPIO_INPUT_ROUTE);\r\n}\r\nvoid dg_cleanup(struct oxygen *chip)\r\n{\r\noxygen_clear_bits16(chip, OXYGEN_GPIO_DATA, GPIO_OUTPUT_ENABLE);\r\n}\r\nvoid dg_suspend(struct oxygen *chip)\r\n{\r\ndg_cleanup(chip);\r\n}\r\nvoid dg_resume(struct oxygen *chip)\r\n{\r\ncs4245_shadow_control(chip, CS4245_LOAD_FROM_SHADOW);\r\nmsleep(2500);\r\noxygen_set_bits16(chip, OXYGEN_GPIO_DATA, GPIO_OUTPUT_ENABLE);\r\n}\r\nvoid set_cs4245_dac_params(struct oxygen *chip,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct dg *data = chip->model_data;\r\nunsigned char dac_ctrl;\r\nunsigned char mclk_freq;\r\ndac_ctrl = data->cs4245_shadow[CS4245_DAC_CTRL_1] & ~CS4245_DAC_FM_MASK;\r\nmclk_freq = data->cs4245_shadow[CS4245_MCLK_FREQ] & ~CS4245_MCLK1_MASK;\r\nif (params_rate(params) <= 50000) {\r\ndac_ctrl |= CS4245_DAC_FM_SINGLE;\r\nmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK1_SHIFT;\r\n} else if (params_rate(params) <= 100000) {\r\ndac_ctrl |= CS4245_DAC_FM_DOUBLE;\r\nmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK1_SHIFT;\r\n} else {\r\ndac_ctrl |= CS4245_DAC_FM_QUAD;\r\nmclk_freq |= CS4245_MCLK_2 << CS4245_MCLK1_SHIFT;\r\n}\r\ndata->cs4245_shadow[CS4245_DAC_CTRL_1] = dac_ctrl;\r\ndata->cs4245_shadow[CS4245_MCLK_FREQ] = mclk_freq;\r\ncs4245_write_spi(chip, CS4245_DAC_CTRL_1);\r\ncs4245_write_spi(chip, CS4245_MCLK_FREQ);\r\n}\r\nvoid set_cs4245_adc_params(struct oxygen *chip,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct dg *data = chip->model_data;\r\nunsigned char adc_ctrl;\r\nunsigned char mclk_freq;\r\nadc_ctrl = data->cs4245_shadow[CS4245_ADC_CTRL] & ~CS4245_ADC_FM_MASK;\r\nmclk_freq = data->cs4245_shadow[CS4245_MCLK_FREQ] & ~CS4245_MCLK2_MASK;\r\nif (params_rate(params) <= 50000) {\r\nadc_ctrl |= CS4245_ADC_FM_SINGLE;\r\nmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK2_SHIFT;\r\n} else if (params_rate(params) <= 100000) {\r\nadc_ctrl |= CS4245_ADC_FM_DOUBLE;\r\nmclk_freq |= CS4245_MCLK_1 << CS4245_MCLK2_SHIFT;\r\n} else {\r\nadc_ctrl |= CS4245_ADC_FM_QUAD;\r\nmclk_freq |= CS4245_MCLK_2 << CS4245_MCLK2_SHIFT;\r\n}\r\ndata->cs4245_shadow[CS4245_ADC_CTRL] = adc_ctrl;\r\ndata->cs4245_shadow[CS4245_MCLK_FREQ] = mclk_freq;\r\ncs4245_write_spi(chip, CS4245_ADC_CTRL);\r\ncs4245_write_spi(chip, CS4245_MCLK_FREQ);\r\n}\r\nstatic inline unsigned int shift_bits(unsigned int value,\r\nunsigned int shift_from,\r\nunsigned int shift_to,\r\nunsigned int mask)\r\n{\r\nif (shift_from < shift_to)\r\nreturn (value << (shift_to - shift_from)) & mask;\r\nelse\r\nreturn (value >> (shift_from - shift_to)) & mask;\r\n}\r\nunsigned int adjust_dg_dac_routing(struct oxygen *chip,\r\nunsigned int play_routing)\r\n{\r\nstruct dg *data = chip->model_data;\r\nswitch (data->output_sel) {\r\ncase PLAYBACK_DST_HP:\r\ncase PLAYBACK_DST_HP_FP:\r\noxygen_write8_masked(chip, OXYGEN_PLAY_ROUTING,\r\nOXYGEN_PLAY_MUTE23 | OXYGEN_PLAY_MUTE45 |\r\nOXYGEN_PLAY_MUTE67, OXYGEN_PLAY_MUTE_MASK);\r\nbreak;\r\ncase PLAYBACK_DST_MULTICH:\r\noxygen_write8_masked(chip, OXYGEN_PLAY_ROUTING,\r\nOXYGEN_PLAY_MUTE01, OXYGEN_PLAY_MUTE_MASK);\r\nbreak;\r\n}\r\nreturn (play_routing & OXYGEN_PLAY_DAC0_SOURCE_MASK) |\r\nshift_bits(play_routing,\r\nOXYGEN_PLAY_DAC2_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC1_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC1_SOURCE_MASK) |\r\nshift_bits(play_routing,\r\nOXYGEN_PLAY_DAC1_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC2_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC2_SOURCE_MASK) |\r\nshift_bits(play_routing,\r\nOXYGEN_PLAY_DAC0_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC3_SOURCE_SHIFT,\r\nOXYGEN_PLAY_DAC3_SOURCE_MASK);\r\n}\r\nvoid dump_cs4245_registers(struct oxygen *chip,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct dg *data = chip->model_data;\r\nunsigned int addr;\r\nsnd_iprintf(buffer, "\nCS4245:");\r\ncs4245_read_spi(chip, CS4245_INT_STATUS);\r\nfor (addr = 1; addr < ARRAY_SIZE(data->cs4245_shadow); addr++)\r\nsnd_iprintf(buffer, " %02x", data->cs4245_shadow[addr]);\r\nsnd_iprintf(buffer, "\n");\r\n}

static struct platform_device *\r\nlpe_audio_platdev_create(struct drm_i915_private *dev_priv)\r\n{\r\nint ret;\r\nstruct drm_device *dev = &dev_priv->drm;\r\nstruct platform_device_info pinfo = {};\r\nstruct resource *rsc;\r\nstruct platform_device *platdev;\r\nstruct intel_hdmi_lpe_audio_pdata *pdata;\r\npdata = kzalloc(sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn ERR_PTR(-ENOMEM);\r\nrsc = kcalloc(2, sizeof(*rsc), GFP_KERNEL);\r\nif (!rsc) {\r\nkfree(pdata);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nrsc[0].start = rsc[0].end = dev_priv->lpe_audio.irq;\r\nrsc[0].flags = IORESOURCE_IRQ;\r\nrsc[0].name = "hdmi-lpe-audio-irq";\r\nrsc[1].start = pci_resource_start(dev->pdev, 0) +\r\nI915_HDMI_LPE_AUDIO_BASE;\r\nrsc[1].end = pci_resource_start(dev->pdev, 0) +\r\nI915_HDMI_LPE_AUDIO_BASE + I915_HDMI_LPE_AUDIO_SIZE - 1;\r\nrsc[1].flags = IORESOURCE_MEM;\r\nrsc[1].name = "hdmi-lpe-audio-mmio";\r\npinfo.parent = dev->dev;\r\npinfo.name = "hdmi-lpe-audio";\r\npinfo.id = -1;\r\npinfo.res = rsc;\r\npinfo.num_res = 2;\r\npinfo.data = pdata;\r\npinfo.size_data = sizeof(*pdata);\r\npinfo.dma_mask = DMA_BIT_MASK(32);\r\npdata->num_pipes = INTEL_INFO(dev_priv)->num_pipes;\r\npdata->num_ports = IS_CHERRYVIEW(dev_priv) ? 3 : 2;\r\npdata->port[0].pipe = -1;\r\npdata->port[1].pipe = -1;\r\npdata->port[2].pipe = -1;\r\nspin_lock_init(&pdata->lpe_audio_slock);\r\nplatdev = platform_device_register_full(&pinfo);\r\nif (IS_ERR(platdev)) {\r\nret = PTR_ERR(platdev);\r\nDRM_ERROR("Failed to allocate LPE audio platform device\n");\r\ngoto err;\r\n}\r\nkfree(rsc);\r\npm_runtime_forbid(&platdev->dev);\r\npm_runtime_set_active(&platdev->dev);\r\npm_runtime_enable(&platdev->dev);\r\nreturn platdev;\r\nerr:\r\nkfree(rsc);\r\nkfree(pdata);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void lpe_audio_platdev_destroy(struct drm_i915_private *dev_priv)\r\n{\r\nplatform_device_unregister(dev_priv->lpe_audio.platdev);\r\n}\r\nstatic void lpe_audio_irq_unmask(struct irq_data *d)\r\n{\r\n}\r\nstatic void lpe_audio_irq_mask(struct irq_data *d)\r\n{\r\n}\r\nstatic int lpe_audio_irq_init(struct drm_i915_private *dev_priv)\r\n{\r\nint irq = dev_priv->lpe_audio.irq;\r\nWARN_ON(!intel_irqs_enabled(dev_priv));\r\nirq_set_chip_and_handler_name(irq,\r\n&lpe_audio_irqchip,\r\nhandle_simple_irq,\r\n"hdmi_lpe_audio_irq_handler");\r\nreturn irq_set_chip_data(irq, dev_priv);\r\n}\r\nstatic bool lpe_audio_detect(struct drm_i915_private *dev_priv)\r\n{\r\nint lpe_present = false;\r\nif (IS_VALLEYVIEW(dev_priv) || IS_CHERRYVIEW(dev_priv)) {\r\nstatic const struct pci_device_id atom_hdaudio_ids[] = {\r\n{PCI_DEVICE(PCI_VENDOR_ID_INTEL, 0x0f04)},\r\n{PCI_DEVICE(PCI_VENDOR_ID_INTEL, 0x2284)},\r\n{}\r\n};\r\nif (!pci_dev_present(atom_hdaudio_ids)) {\r\nDRM_INFO("%s\n", "HDaudio controller not detected, using LPE audio instead\n");\r\nlpe_present = true;\r\n}\r\n}\r\nreturn lpe_present;\r\n}\r\nstatic int lpe_audio_setup(struct drm_i915_private *dev_priv)\r\n{\r\nint ret;\r\ndev_priv->lpe_audio.irq = irq_alloc_desc(0);\r\nif (dev_priv->lpe_audio.irq < 0) {\r\nDRM_ERROR("Failed to allocate IRQ desc: %d\n",\r\ndev_priv->lpe_audio.irq);\r\nret = dev_priv->lpe_audio.irq;\r\ngoto err;\r\n}\r\nDRM_DEBUG("irq = %d\n", dev_priv->lpe_audio.irq);\r\nret = lpe_audio_irq_init(dev_priv);\r\nif (ret) {\r\nDRM_ERROR("Failed to initialize irqchip for lpe audio: %d\n",\r\nret);\r\ngoto err_free_irq;\r\n}\r\ndev_priv->lpe_audio.platdev = lpe_audio_platdev_create(dev_priv);\r\nif (IS_ERR(dev_priv->lpe_audio.platdev)) {\r\nret = PTR_ERR(dev_priv->lpe_audio.platdev);\r\nDRM_ERROR("Failed to create lpe audio platform device: %d\n",\r\nret);\r\ngoto err_free_irq;\r\n}\r\nI915_WRITE(VLV_AUD_CHICKEN_BIT_REG, VLV_CHICKEN_BIT_DBG_ENABLE);\r\nreturn 0;\r\nerr_free_irq:\r\nirq_free_desc(dev_priv->lpe_audio.irq);\r\nerr:\r\ndev_priv->lpe_audio.irq = -1;\r\ndev_priv->lpe_audio.platdev = NULL;\r\nreturn ret;\r\n}\r\nvoid intel_lpe_audio_irq_handler(struct drm_i915_private *dev_priv)\r\n{\r\nint ret;\r\nif (!HAS_LPE_AUDIO(dev_priv))\r\nreturn;\r\nret = generic_handle_irq(dev_priv->lpe_audio.irq);\r\nif (ret)\r\nDRM_ERROR_RATELIMITED("error handling LPE audio irq: %d\n",\r\nret);\r\n}\r\nint intel_lpe_audio_init(struct drm_i915_private *dev_priv)\r\n{\r\nint ret = -ENODEV;\r\nif (lpe_audio_detect(dev_priv)) {\r\nret = lpe_audio_setup(dev_priv);\r\nif (ret < 0)\r\nDRM_ERROR("failed to setup LPE Audio bridge\n");\r\n}\r\nreturn ret;\r\n}\r\nvoid intel_lpe_audio_teardown(struct drm_i915_private *dev_priv)\r\n{\r\nstruct irq_desc *desc;\r\nif (!HAS_LPE_AUDIO(dev_priv))\r\nreturn;\r\ndesc = irq_to_desc(dev_priv->lpe_audio.irq);\r\nlpe_audio_platdev_destroy(dev_priv);\r\nirq_free_desc(dev_priv->lpe_audio.irq);\r\n}\r\nvoid intel_lpe_audio_notify(struct drm_i915_private *dev_priv,\r\nenum pipe pipe, enum port port,\r\nconst void *eld, int ls_clock, bool dp_output)\r\n{\r\nunsigned long irqflags;\r\nstruct intel_hdmi_lpe_audio_pdata *pdata;\r\nstruct intel_hdmi_lpe_audio_port_pdata *ppdata;\r\nu32 audio_enable;\r\nif (!HAS_LPE_AUDIO(dev_priv))\r\nreturn;\r\npdata = dev_get_platdata(&dev_priv->lpe_audio.platdev->dev);\r\nppdata = &pdata->port[port - PORT_B];\r\nspin_lock_irqsave(&pdata->lpe_audio_slock, irqflags);\r\naudio_enable = I915_READ(VLV_AUD_PORT_EN_DBG(port));\r\nif (eld != NULL) {\r\nmemcpy(ppdata->eld, eld, HDMI_MAX_ELD_BYTES);\r\nppdata->pipe = pipe;\r\nppdata->ls_clock = ls_clock;\r\nppdata->dp_output = dp_output;\r\nI915_WRITE(VLV_AUD_PORT_EN_DBG(port),\r\naudio_enable & ~VLV_AMP_MUTE);\r\n} else {\r\nmemset(ppdata->eld, 0, HDMI_MAX_ELD_BYTES);\r\nppdata->pipe = -1;\r\nppdata->ls_clock = 0;\r\nppdata->dp_output = false;\r\nI915_WRITE(VLV_AUD_PORT_EN_DBG(port),\r\naudio_enable | VLV_AMP_MUTE);\r\n}\r\nif (pdata->notify_audio_lpe)\r\npdata->notify_audio_lpe(dev_priv->lpe_audio.platdev, port - PORT_B);\r\nspin_unlock_irqrestore(&pdata->lpe_audio_slock, irqflags);\r\n}

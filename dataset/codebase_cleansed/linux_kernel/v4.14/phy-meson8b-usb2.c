static u32 phy_meson8b_usb2_read(struct phy_meson8b_usb2_priv *phy_priv,\r\nu32 reg)\r\n{\r\nreturn readl(phy_priv->regs + reg);\r\n}\r\nstatic void phy_meson8b_usb2_mask_bits(struct phy_meson8b_usb2_priv *phy_priv,\r\nu32 reg, u32 mask, u32 value)\r\n{\r\nu32 data;\r\ndata = phy_meson8b_usb2_read(phy_priv, reg);\r\ndata &= ~mask;\r\ndata |= (value & mask);\r\nwritel(data, phy_priv->regs + reg);\r\n}\r\nstatic int phy_meson8b_usb2_power_on(struct phy *phy)\r\n{\r\nstruct phy_meson8b_usb2_priv *priv = phy_get_drvdata(phy);\r\nint ret;\r\nif (!IS_ERR_OR_NULL(priv->reset)) {\r\nret = reset_control_reset(priv->reset);\r\nif (ret) {\r\ndev_err(&phy->dev, "Failed to trigger USB reset\n");\r\nreturn ret;\r\n}\r\n}\r\nret = clk_prepare_enable(priv->clk_usb_general);\r\nif (ret) {\r\ndev_err(&phy->dev, "Failed to enable USB general clock\n");\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(priv->clk_usb);\r\nif (ret) {\r\ndev_err(&phy->dev, "Failed to enable USB DDR clock\n");\r\nclk_disable_unprepare(priv->clk_usb_general);\r\nreturn ret;\r\n}\r\nphy_meson8b_usb2_mask_bits(priv, REG_CONFIG, REG_CONFIG_CLK_32k_ALTSEL,\r\nREG_CONFIG_CLK_32k_ALTSEL);\r\nphy_meson8b_usb2_mask_bits(priv, REG_CTRL, REG_CTRL_REF_CLK_SEL_MASK,\r\n0x2 << REG_CTRL_REF_CLK_SEL_SHIFT);\r\nphy_meson8b_usb2_mask_bits(priv, REG_CTRL, REG_CTRL_FSEL_MASK,\r\n0x5 << REG_CTRL_FSEL_SHIFT);\r\nphy_meson8b_usb2_mask_bits(priv, REG_CTRL, REG_CTRL_POWER_ON_RESET,\r\nREG_CTRL_POWER_ON_RESET);\r\nudelay(RESET_COMPLETE_TIME);\r\nphy_meson8b_usb2_mask_bits(priv, REG_CTRL, REG_CTRL_POWER_ON_RESET, 0);\r\nudelay(RESET_COMPLETE_TIME);\r\nphy_meson8b_usb2_mask_bits(priv, REG_CTRL, REG_CTRL_SOF_TOGGLE_OUT,\r\nREG_CTRL_SOF_TOGGLE_OUT);\r\nif (priv->dr_mode == USB_DR_MODE_HOST) {\r\nphy_meson8b_usb2_mask_bits(priv, REG_ADP_BC,\r\nREG_ADP_BC_ACA_ENABLE,\r\nREG_ADP_BC_ACA_ENABLE);\r\nudelay(ACA_ENABLE_COMPLETE_TIME);\r\nif (phy_meson8b_usb2_read(priv, REG_ADP_BC) &\r\nREG_ADP_BC_ACA_PIN_FLOAT) {\r\ndev_warn(&phy->dev, "USB ID detect failed!\n");\r\nclk_disable_unprepare(priv->clk_usb);\r\nclk_disable_unprepare(priv->clk_usb_general);\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int phy_meson8b_usb2_power_off(struct phy *phy)\r\n{\r\nstruct phy_meson8b_usb2_priv *priv = phy_get_drvdata(phy);\r\nclk_disable_unprepare(priv->clk_usb);\r\nclk_disable_unprepare(priv->clk_usb_general);\r\nreturn 0;\r\n}\r\nstatic int phy_meson8b_usb2_probe(struct platform_device *pdev)\r\n{\r\nstruct phy_meson8b_usb2_priv *priv;\r\nstruct resource *res;\r\nstruct phy *phy;\r\nstruct phy_provider *phy_provider;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->regs))\r\nreturn PTR_ERR(priv->regs);\r\npriv->clk_usb_general = devm_clk_get(&pdev->dev, "usb_general");\r\nif (IS_ERR(priv->clk_usb_general))\r\nreturn PTR_ERR(priv->clk_usb_general);\r\npriv->clk_usb = devm_clk_get(&pdev->dev, "usb");\r\nif (IS_ERR(priv->clk_usb))\r\nreturn PTR_ERR(priv->clk_usb);\r\npriv->reset = devm_reset_control_get_optional_shared(&pdev->dev, NULL);\r\nif (PTR_ERR(priv->reset) == -EPROBE_DEFER)\r\nreturn PTR_ERR(priv->reset);\r\npriv->dr_mode = of_usb_get_dr_mode_by_phy(pdev->dev.of_node, -1);\r\nif (priv->dr_mode == USB_DR_MODE_UNKNOWN) {\r\ndev_err(&pdev->dev,\r\n"missing dual role configuration of the controller\n");\r\nreturn -EINVAL;\r\n}\r\nphy = devm_phy_create(&pdev->dev, NULL, &phy_meson8b_usb2_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(&pdev->dev, "failed to create PHY\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nphy_set_drvdata(phy, priv);\r\nphy_provider =\r\ndevm_of_phy_provider_register(&pdev->dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

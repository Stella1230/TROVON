static void fou6_build_udp(struct sk_buff *skb, struct ip_tunnel_encap *e,\r\nstruct flowi6 *fl6, u8 *protocol, __be16 sport)\r\n{\r\nstruct udphdr *uh;\r\nskb_push(skb, sizeof(struct udphdr));\r\nskb_reset_transport_header(skb);\r\nuh = udp_hdr(skb);\r\nuh->dest = e->dport;\r\nuh->source = sport;\r\nuh->len = htons(skb->len);\r\nudp6_set_csum(!(e->flags & TUNNEL_ENCAP_FLAG_CSUM6), skb,\r\n&fl6->saddr, &fl6->daddr, skb->len);\r\n*protocol = IPPROTO_UDP;\r\n}\r\nstatic int fou6_build_header(struct sk_buff *skb, struct ip_tunnel_encap *e,\r\nu8 *protocol, struct flowi6 *fl6)\r\n{\r\n__be16 sport;\r\nint err;\r\nint type = e->flags & TUNNEL_ENCAP_FLAG_CSUM6 ?\r\nSKB_GSO_UDP_TUNNEL_CSUM : SKB_GSO_UDP_TUNNEL;\r\nerr = __fou_build_header(skb, e, protocol, &sport, type);\r\nif (err)\r\nreturn err;\r\nfou6_build_udp(skb, e, fl6, protocol, sport);\r\nreturn 0;\r\n}\r\nstatic int gue6_build_header(struct sk_buff *skb, struct ip_tunnel_encap *e,\r\nu8 *protocol, struct flowi6 *fl6)\r\n{\r\n__be16 sport;\r\nint err;\r\nint type = e->flags & TUNNEL_ENCAP_FLAG_CSUM6 ?\r\nSKB_GSO_UDP_TUNNEL_CSUM : SKB_GSO_UDP_TUNNEL;\r\nerr = __gue_build_header(skb, e, protocol, &sport, type);\r\nif (err)\r\nreturn err;\r\nfou6_build_udp(skb, e, fl6, protocol, sport);\r\nreturn 0;\r\n}\r\nstatic int ip6_tnl_encap_add_fou_ops(void)\r\n{\r\nint ret;\r\nret = ip6_tnl_encap_add_ops(&fou_ip6tun_ops, TUNNEL_ENCAP_FOU);\r\nif (ret < 0) {\r\npr_err("can't add fou6 ops\n");\r\nreturn ret;\r\n}\r\nret = ip6_tnl_encap_add_ops(&gue_ip6tun_ops, TUNNEL_ENCAP_GUE);\r\nif (ret < 0) {\r\npr_err("can't add gue6 ops\n");\r\nip6_tnl_encap_del_ops(&fou_ip6tun_ops, TUNNEL_ENCAP_FOU);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ip6_tnl_encap_del_fou_ops(void)\r\n{\r\nip6_tnl_encap_del_ops(&fou_ip6tun_ops, TUNNEL_ENCAP_FOU);\r\nip6_tnl_encap_del_ops(&gue_ip6tun_ops, TUNNEL_ENCAP_GUE);\r\n}\r\nstatic int ip6_tnl_encap_add_fou_ops(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void ip6_tnl_encap_del_fou_ops(void)\r\n{\r\n}\r\nstatic int __init fou6_init(void)\r\n{\r\nint ret;\r\nret = ip6_tnl_encap_add_fou_ops();\r\nreturn ret;\r\n}\r\nstatic void __exit fou6_fini(void)\r\n{\r\nip6_tnl_encap_del_fou_ops();\r\n}

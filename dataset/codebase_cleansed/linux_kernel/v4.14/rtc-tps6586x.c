static inline struct device *to_tps6586x_dev(struct device *dev)\r\n{\r\nreturn dev->parent;\r\n}\r\nstatic int tps6586x_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nstruct device *tps_dev = to_tps6586x_dev(dev);\r\nunsigned long long ticks = 0;\r\nunsigned long seconds;\r\nu8 buff[6];\r\nint ret;\r\nint i;\r\nret = tps6586x_reads(tps_dev, RTC_COUNT4_DUMMYREAD, sizeof(buff), buff);\r\nif (ret < 0) {\r\ndev_err(dev, "read counter failed with err %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 1; i < sizeof(buff); i++) {\r\nticks <<= 8;\r\nticks |= buff[i];\r\n}\r\nseconds = ticks >> 10;\r\nseconds += rtc->epoch_start;\r\nrtc_time_to_tm(seconds, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int tps6586x_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nstruct device *tps_dev = to_tps6586x_dev(dev);\r\nunsigned long long ticks;\r\nunsigned long seconds;\r\nu8 buff[5];\r\nint ret;\r\nrtc_tm_to_time(tm, &seconds);\r\nif (seconds < rtc->epoch_start) {\r\ndev_err(dev, "requested time unsupported\n");\r\nreturn -EINVAL;\r\n}\r\nseconds -= rtc->epoch_start;\r\nticks = (unsigned long long)seconds << 10;\r\nbuff[0] = (ticks >> 32) & 0xff;\r\nbuff[1] = (ticks >> 24) & 0xff;\r\nbuff[2] = (ticks >> 16) & 0xff;\r\nbuff[3] = (ticks >> 8) & 0xff;\r\nbuff[4] = ticks & 0xff;\r\nret = tps6586x_clr_bits(tps_dev, RTC_CTRL, RTC_ENABLE);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to clear RTC_ENABLE\n");\r\nreturn ret;\r\n}\r\nret = tps6586x_writes(tps_dev, RTC_COUNT4, sizeof(buff), buff);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to program new time\n");\r\nreturn ret;\r\n}\r\nret = tps6586x_set_bits(tps_dev, RTC_CTRL, RTC_ENABLE);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set RTC_ENABLE\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps6586x_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nif (enabled && !rtc->irq_en) {\r\nenable_irq(rtc->irq);\r\nrtc->irq_en = true;\r\n} else if (!enabled && rtc->irq_en) {\r\ndisable_irq(rtc->irq);\r\nrtc->irq_en = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps6586x_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nstruct device *tps_dev = to_tps6586x_dev(dev);\r\nunsigned long seconds;\r\nunsigned long ticks;\r\nunsigned long rtc_current_time;\r\nunsigned long long rticks = 0;\r\nu8 buff[3];\r\nu8 rbuff[6];\r\nint ret;\r\nint i;\r\nrtc_tm_to_time(&alrm->time, &seconds);\r\nif (alrm->enabled && (seconds < rtc->epoch_start)) {\r\ndev_err(dev, "can't set alarm to requested time\n");\r\nreturn -EINVAL;\r\n}\r\nret = tps6586x_rtc_alarm_irq_enable(dev, alrm->enabled);\r\nif (ret < 0) {\r\ndev_err(dev, "can't set alarm irq, err %d\n", ret);\r\nreturn ret;\r\n}\r\nseconds -= rtc->epoch_start;\r\nret = tps6586x_reads(tps_dev, RTC_COUNT4_DUMMYREAD,\r\nsizeof(rbuff), rbuff);\r\nif (ret < 0) {\r\ndev_err(dev, "read counter failed with err %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 1; i < sizeof(rbuff); i++) {\r\nrticks <<= 8;\r\nrticks |= rbuff[i];\r\n}\r\nrtc_current_time = rticks >> 10;\r\nif ((seconds - rtc_current_time) > ALM1_VALID_RANGE_IN_SEC)\r\nseconds = rtc_current_time - 1;\r\nticks = (unsigned long long)seconds << 10;\r\nbuff[0] = (ticks >> 16) & 0xff;\r\nbuff[1] = (ticks >> 8) & 0xff;\r\nbuff[2] = ticks & 0xff;\r\nret = tps6586x_writes(tps_dev, RTC_ALARM1_HI, sizeof(buff), buff);\r\nif (ret)\r\ndev_err(dev, "programming alarm failed with err %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int tps6586x_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nstruct device *tps_dev = to_tps6586x_dev(dev);\r\nunsigned long ticks;\r\nunsigned long seconds;\r\nu8 buff[3];\r\nint ret;\r\nret = tps6586x_reads(tps_dev, RTC_ALARM1_HI, sizeof(buff), buff);\r\nif (ret) {\r\ndev_err(dev, "read RTC_ALARM1_HI failed with err %d\n", ret);\r\nreturn ret;\r\n}\r\nticks = (buff[0] << 16) | (buff[1] << 8) | buff[2];\r\nseconds = ticks >> 10;\r\nseconds += rtc->epoch_start;\r\nrtc_time_to_tm(seconds, &alrm->time);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t tps6586x_rtc_irq(int irq, void *data)\r\n{\r\nstruct tps6586x_rtc *rtc = data;\r\nrtc_update_irq(rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tps6586x_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *tps_dev = to_tps6586x_dev(&pdev->dev);\r\nstruct tps6586x_rtc *rtc;\r\nint ret;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->dev = &pdev->dev;\r\nrtc->irq = platform_get_irq(pdev, 0);\r\nrtc->epoch_start = mktime(2009, 1, 1, 0, 0, 0);\r\nret = tps6586x_update(tps_dev, RTC_CTRL,\r\nRTC_ENABLE | OSC_SRC_SEL |\r\n((TPS6586X_RTC_CL_SEL_1_5PF << CL_SEL_POS) & CL_SEL_MASK),\r\nRTC_ENABLE | OSC_SRC_SEL | PRE_BYPASS | CL_SEL_MASK);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "unable to start counter\n");\r\nreturn ret;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nplatform_set_drvdata(pdev, rtc);\r\nrtc->rtc = devm_rtc_device_register(&pdev->dev, dev_name(&pdev->dev),\r\n&tps6586x_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc)) {\r\nret = PTR_ERR(rtc->rtc);\r\ndev_err(&pdev->dev, "RTC device register: ret %d\n", ret);\r\ngoto fail_rtc_register;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, rtc->irq, NULL,\r\ntps6586x_rtc_irq,\r\nIRQF_ONESHOT,\r\ndev_name(&pdev->dev), rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "request IRQ(%d) failed with ret %d\n",\r\nrtc->irq, ret);\r\ngoto fail_rtc_register;\r\n}\r\ndisable_irq(rtc->irq);\r\nreturn 0;\r\nfail_rtc_register:\r\ntps6586x_update(tps_dev, RTC_CTRL, 0,\r\nRTC_ENABLE | OSC_SRC_SEL | PRE_BYPASS | CL_SEL_MASK);\r\nreturn ret;\r\n}\r\nstatic int tps6586x_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct device *tps_dev = to_tps6586x_dev(&pdev->dev);\r\ntps6586x_update(tps_dev, RTC_CTRL, 0,\r\nRTC_ENABLE | OSC_SRC_SEL | PRE_BYPASS | CL_SEL_MASK);\r\nreturn 0;\r\n}\r\nstatic int tps6586x_rtc_suspend(struct device *dev)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int tps6586x_rtc_resume(struct device *dev)\r\n{\r\nstruct tps6586x_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}

static ssize_t\r\nnouveau_hwmon_show_temp1_auto_point1_pwm(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", 100);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_temp1_auto_point1_temp(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NVKM_THERM_ATTR_THRS_FAN_BOOST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_temp1_auto_point1_temp(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NVKM_THERM_ATTR_THRS_FAN_BOOST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_temp1_auto_point1_temp_hyst(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NVKM_THERM_ATTR_THRS_FAN_BOOST_HYST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_temp1_auto_point1_temp_hyst(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NVKM_THERM_ATTR_THRS_FAN_BOOST_HYST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1_max(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nint ret;\r\nret = therm->attr_get(therm, NVKM_THERM_ATTR_FAN_MAX_DUTY);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1_min(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nint ret;\r\nret = therm->attr_get(therm, NVKM_THERM_ATTR_FAN_MIN_DUTY);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1_min(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nlong value;\r\nint ret;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn -EINVAL;\r\nret = therm->attr_set(therm, NVKM_THERM_ATTR_FAN_MIN_DUTY, value);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1_max(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nlong value;\r\nint ret;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn -EINVAL;\r\nret = therm->attr_set(therm, NVKM_THERM_ATTR_FAN_MAX_DUTY, value);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic umode_t\r\nnouveau_chip_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nswitch (attr) {\r\ncase hwmon_chip_update_interval:\r\nreturn 0444;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_power_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm((struct drm_device *)data);\r\nstruct nvkm_iccsense *iccsense = nvxx_iccsense(&drm->client.device);\r\nif (!iccsense || !iccsense->data_valid || list_empty(&iccsense->rails))\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_power_input:\r\nreturn 0444;\r\ncase hwmon_power_max:\r\nif (iccsense->power_w_max)\r\nreturn 0444;\r\nreturn 0;\r\ncase hwmon_power_crit:\r\nif (iccsense->power_w_crit)\r\nreturn 0444;\r\nreturn 0;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_temp_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm((struct drm_device *)data);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (therm && therm->attr_get && nvkm_therm_temp_get(therm) < 0)\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_temp_input:\r\nreturn 0444;\r\ncase hwmon_temp_max:\r\ncase hwmon_temp_max_hyst:\r\ncase hwmon_temp_crit:\r\ncase hwmon_temp_crit_hyst:\r\ncase hwmon_temp_emergency:\r\ncase hwmon_temp_emergency_hyst:\r\nreturn 0644;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_pwm_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm((struct drm_device *)data);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (therm && therm->attr_get && therm->fan_get &&\r\ntherm->fan_get(therm) < 0)\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_pwm_enable:\r\ncase hwmon_pwm_input:\r\nreturn 0644;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_input_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm((struct drm_device *)data);\r\nstruct nvkm_volt *volt = nvxx_volt(&drm->client.device);\r\nif (!volt || nvkm_volt_get(volt) < 0)\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_in_input:\r\ncase hwmon_in_label:\r\ncase hwmon_in_min:\r\ncase hwmon_in_max:\r\nreturn 0444;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_fan_is_visible(const void *data, u32 attr, int channel)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm((struct drm_device *)data);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (!therm || !therm->attr_get || nvkm_therm_fan_sense(therm) < 0)\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_fan_input:\r\nreturn 0444;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\nnouveau_chip_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nswitch (attr) {\r\ncase hwmon_chip_update_interval:\r\n*val = 1000;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_temp_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nint ret;\r\nif (!therm || !therm->attr_get)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_temp_input:\r\nret = nvkm_therm_temp_get(therm);\r\n*val = ret < 0 ? ret : (ret * 1000);\r\nbreak;\r\ncase hwmon_temp_max:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_DOWN_CLK)\r\n* 1000;\r\nbreak;\r\ncase hwmon_temp_max_hyst:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_DOWN_CLK_HYST)\r\n* 1000;\r\nbreak;\r\ncase hwmon_temp_crit:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_CRITICAL)\r\n* 1000;\r\nbreak;\r\ncase hwmon_temp_crit_hyst:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_CRITICAL_HYST)\r\n* 1000;\r\nbreak;\r\ncase hwmon_temp_emergency:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_SHUTDOWN)\r\n* 1000;\r\nbreak;\r\ncase hwmon_temp_emergency_hyst:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_THRS_SHUTDOWN_HYST)\r\n* 1000;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_fan_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (!therm)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_fan_input:\r\n*val = nvkm_therm_fan_sense(therm);\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_in_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_volt *volt = nvxx_volt(&drm->client.device);\r\nint ret;\r\nif (!volt)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_in_input:\r\nret = nvkm_volt_get(volt);\r\n*val = ret < 0 ? ret : (ret / 1000);\r\nbreak;\r\ncase hwmon_in_min:\r\n*val = volt->min_uv > 0 ? (volt->min_uv / 1000) : -ENODEV;\r\nbreak;\r\ncase hwmon_in_max:\r\n*val = volt->max_uv > 0 ? (volt->max_uv / 1000) : -ENODEV;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_pwm_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (!therm || !therm->attr_get || !therm->fan_get)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_pwm_enable:\r\n*val = therm->attr_get(therm, NVKM_THERM_ATTR_FAN_MODE);\r\nbreak;\r\ncase hwmon_pwm_input:\r\n*val = therm->fan_get(therm);\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_power_read(struct device *dev, u32 attr, int channel, long *val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_iccsense *iccsense = nvxx_iccsense(&drm->client.device);\r\nif (!iccsense)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_power_input:\r\n*val = nvkm_iccsense_read_all(iccsense);\r\nbreak;\r\ncase hwmon_power_max:\r\n*val = iccsense->power_w_max;\r\nbreak;\r\ncase hwmon_power_crit:\r\n*val = iccsense->power_w_crit;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_temp_write(struct device *dev, u32 attr, int channel, long val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (!therm || !therm->attr_set)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_temp_max:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_DOWN_CLK,\r\nval / 1000);\r\ncase hwmon_temp_max_hyst:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_DOWN_CLK_HYST,\r\nval / 1000);\r\ncase hwmon_temp_crit:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_CRITICAL,\r\nval / 1000);\r\ncase hwmon_temp_crit_hyst:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_CRITICAL_HYST,\r\nval / 1000);\r\ncase hwmon_temp_emergency:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_SHUTDOWN,\r\nval / 1000);\r\ncase hwmon_temp_emergency_hyst:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_THRS_SHUTDOWN_HYST,\r\nval / 1000);\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic int\r\nnouveau_pwm_write(struct device *dev, u32 attr, int channel, long val)\r\n{\r\nstruct drm_device *drm_dev = dev_get_drvdata(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nif (!therm || !therm->attr_set)\r\nreturn -EOPNOTSUPP;\r\nswitch (attr) {\r\ncase hwmon_pwm_input:\r\nreturn therm->fan_set(therm, val);\r\ncase hwmon_pwm_enable:\r\nreturn therm->attr_set(therm, NVKM_THERM_ATTR_FAN_MODE, val);\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic umode_t\r\nnouveau_is_visible(const void *data, enum hwmon_sensor_types type, u32 attr,\r\nint channel)\r\n{\r\nswitch (type) {\r\ncase hwmon_chip:\r\nreturn nouveau_chip_is_visible(data, attr, channel);\r\ncase hwmon_temp:\r\nreturn nouveau_temp_is_visible(data, attr, channel);\r\ncase hwmon_fan:\r\nreturn nouveau_fan_is_visible(data, attr, channel);\r\ncase hwmon_in:\r\nreturn nouveau_input_is_visible(data, attr, channel);\r\ncase hwmon_pwm:\r\nreturn nouveau_pwm_is_visible(data, attr, channel);\r\ncase hwmon_power:\r\nreturn nouveau_power_is_visible(data, attr, channel);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\nnouveau_read_string(struct device *dev, enum hwmon_sensor_types type, u32 attr,\r\nint channel, const char **buf)\r\n{\r\nif (type == hwmon_in && attr == hwmon_in_label) {\r\n*buf = input_label;\r\nreturn 0;\r\n}\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic int\r\nnouveau_read(struct device *dev, enum hwmon_sensor_types type, u32 attr,\r\nint channel, long *val)\r\n{\r\nswitch (type) {\r\ncase hwmon_chip:\r\nreturn nouveau_chip_read(dev, attr, channel, val);\r\ncase hwmon_temp:\r\nreturn nouveau_temp_read(dev, attr, channel, val);\r\ncase hwmon_fan:\r\nreturn nouveau_fan_read(dev, attr, channel, val);\r\ncase hwmon_in:\r\nreturn nouveau_in_read(dev, attr, channel, val);\r\ncase hwmon_pwm:\r\nreturn nouveau_pwm_read(dev, attr, channel, val);\r\ncase hwmon_power:\r\nreturn nouveau_power_read(dev, attr, channel, val);\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic int\r\nnouveau_write(struct device *dev, enum hwmon_sensor_types type, u32 attr,\r\nint channel, long val)\r\n{\r\nswitch (type) {\r\ncase hwmon_temp:\r\nreturn nouveau_temp_write(dev, attr, channel, val);\r\ncase hwmon_pwm:\r\nreturn nouveau_pwm_write(dev, attr, channel, val);\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nint\r\nnouveau_hwmon_init(struct drm_device *dev)\r\n{\r\n#if defined(CONFIG_HWMON) || (defined(MODULE) && defined(CONFIG_HWMON_MODULE))\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_therm *therm = nvxx_therm(&drm->client.device);\r\nconst struct attribute_group *special_groups[N_ATTR_GROUPS];\r\nstruct nouveau_hwmon *hwmon;\r\nstruct device *hwmon_dev;\r\nint ret = 0;\r\nint i = 0;\r\nhwmon = drm->hwmon = kzalloc(sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nhwmon->dev = dev;\r\nif (therm && therm->attr_get && therm->attr_set) {\r\nif (nvkm_therm_temp_get(therm) >= 0)\r\nspecial_groups[i++] = &temp1_auto_point_sensor_group;\r\nif (therm->fan_get && therm->fan_get(therm) >= 0)\r\nspecial_groups[i++] = &pwm_fan_sensor_group;\r\n}\r\nspecial_groups[i] = 0;\r\nhwmon_dev = hwmon_device_register_with_info(dev->dev, "nouveau", dev,\r\n&nouveau_chip_info,\r\nspecial_groups);\r\nif (IS_ERR(hwmon_dev)) {\r\nret = PTR_ERR(hwmon_dev);\r\nNV_ERROR(drm, "Unable to register hwmon device: %d\n", ret);\r\nreturn ret;\r\n}\r\nhwmon->hwmon = hwmon_dev;\r\nreturn 0;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nvoid\r\nnouveau_hwmon_fini(struct drm_device *dev)\r\n{\r\n#if defined(CONFIG_HWMON) || (defined(MODULE) && defined(CONFIG_HWMON_MODULE))\r\nstruct nouveau_hwmon *hwmon = nouveau_hwmon(dev);\r\nif (hwmon->hwmon)\r\nhwmon_device_unregister(hwmon->hwmon);\r\nnouveau_drm(dev)->hwmon = NULL;\r\nkfree(hwmon);\r\n#endif\r\n}

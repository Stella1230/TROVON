static int zd1301_ctrl_msg(struct dvb_usb_device *d, const u8 *wbuf,\r\nunsigned int wlen, u8 *rbuf, unsigned int rlen)\r\n{\r\nstruct zd1301_dev *dev = d_to_priv(d);\r\nstruct usb_interface *intf = d->intf;\r\nint ret, actual_length;\r\nmutex_lock(&d->usb_mutex);\r\nmemcpy(&dev->buf, wbuf, wlen);\r\ndev_dbg(&intf->dev, ">>> %*ph\n", wlen, dev->buf);\r\nret = usb_bulk_msg(d->udev, usb_sndbulkpipe(d->udev, 0x04), dev->buf,\r\nwlen, &actual_length, 1000);\r\nif (ret) {\r\ndev_err(&intf->dev, "1st usb_bulk_msg() failed %d\n", ret);\r\ngoto err_mutex_unlock;\r\n}\r\nif (rlen) {\r\nret = usb_bulk_msg(d->udev, usb_rcvbulkpipe(d->udev, 0x83),\r\ndev->buf, rlen, &actual_length, 1000);\r\nif (ret) {\r\ndev_err(&intf->dev,\r\n"2nd usb_bulk_msg() failed %d\n", ret);\r\ngoto err_mutex_unlock;\r\n}\r\ndev_dbg(&intf->dev, "<<< %*ph\n", actual_length, dev->buf);\r\nif (actual_length != rlen) {\r\ndev_dbg(&intf->dev, "repeating reply message\n");\r\nret = usb_bulk_msg(d->udev,\r\nusb_rcvbulkpipe(d->udev, 0x83),\r\ndev->buf, rlen, &actual_length,\r\n1000);\r\nif (ret) {\r\ndev_err(&intf->dev,\r\n"3rd usb_bulk_msg() failed %d\n", ret);\r\ngoto err_mutex_unlock;\r\n}\r\ndev_dbg(&intf->dev,\r\n"<<< %*ph\n", actual_length, dev->buf);\r\n}\r\nmemcpy(rbuf, dev->buf, rlen);\r\n}\r\nerr_mutex_unlock:\r\nmutex_unlock(&d->usb_mutex);\r\nreturn ret;\r\n}\r\nstatic int zd1301_demod_wreg(void *reg_priv, u16 reg, u8 val)\r\n{\r\nstruct dvb_usb_device *d = reg_priv;\r\nstruct usb_interface *intf = d->intf;\r\nint ret;\r\nu8 buf[7] = {0x07, 0x00, 0x03, 0x01,\r\n(reg >> 0) & 0xff, (reg >> 8) & 0xff, val};\r\nret = zd1301_ctrl_msg(d, buf, 7, NULL, 0);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev_dbg(&intf->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int zd1301_demod_rreg(void *reg_priv, u16 reg, u8 *val)\r\n{\r\nstruct dvb_usb_device *d = reg_priv;\r\nstruct usb_interface *intf = d->intf;\r\nint ret;\r\nu8 buf[7] = {0x07, 0x00, 0x04, 0x01,\r\n(reg >> 0) & 0xff, (reg >> 8) & 0xff, 0};\r\nret = zd1301_ctrl_msg(d, buf, 7, buf, 7);\r\nif (ret)\r\ngoto err;\r\n*val = buf[6];\r\nreturn 0;\r\nerr:\r\ndev_dbg(&intf->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int zd1301_frontend_attach(struct dvb_usb_adapter *adap)\r\n{\r\nstruct dvb_usb_device *d = adap_to_d(adap);\r\nstruct zd1301_dev *dev = adap_to_priv(adap);\r\nstruct usb_interface *intf = d->intf;\r\nstruct platform_device *pdev;\r\nstruct i2c_client *client;\r\nstruct i2c_board_info board_info;\r\nstruct i2c_adapter *adapter;\r\nstruct dvb_frontend *frontend;\r\nint ret;\r\ndev_dbg(&intf->dev, "\n");\r\ndev->demod_pdata.reg_priv = d;\r\ndev->demod_pdata.reg_read = zd1301_demod_rreg;\r\ndev->demod_pdata.reg_write = zd1301_demod_wreg;\r\nrequest_module("%s", "zd1301_demod");\r\npdev = platform_device_register_data(&intf->dev,\r\n"zd1301_demod",\r\nPLATFORM_DEVID_AUTO,\r\n&dev->demod_pdata,\r\nsizeof(dev->demod_pdata));\r\nif (IS_ERR(pdev)) {\r\nret = PTR_ERR(pdev);\r\ngoto err;\r\n}\r\nif (!pdev->dev.driver) {\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\nif (!try_module_get(pdev->dev.driver->owner)) {\r\nret = -ENODEV;\r\ngoto err_platform_device_unregister;\r\n}\r\nadapter = zd1301_demod_get_i2c_adapter(pdev);\r\nfrontend = zd1301_demod_get_dvb_frontend(pdev);\r\nif (!adapter || !frontend) {\r\nret = -ENODEV;\r\ngoto err_module_put_demod;\r\n}\r\ndev->mt2060_pdata.i2c_write_max = 9;\r\ndev->mt2060_pdata.dvb_frontend = frontend;\r\nmemset(&board_info, 0, sizeof(board_info));\r\nstrlcpy(board_info.type, "mt2060", I2C_NAME_SIZE);\r\nboard_info.addr = 0x60;\r\nboard_info.platform_data = &dev->mt2060_pdata;\r\nrequest_module("%s", "mt2060");\r\nclient = i2c_new_device(adapter, &board_info);\r\nif (!client || !client->dev.driver) {\r\nret = -ENODEV;\r\ngoto err_module_put_demod;\r\n}\r\nif (!try_module_get(client->dev.driver->owner)) {\r\nret = -ENODEV;\r\ngoto err_i2c_unregister_device;\r\n}\r\ndev->platform_device_demod = pdev;\r\ndev->i2c_client_tuner = client;\r\nadap->fe[0] = frontend;\r\nreturn 0;\r\nerr_i2c_unregister_device:\r\ni2c_unregister_device(client);\r\nerr_module_put_demod:\r\nmodule_put(pdev->dev.driver->owner);\r\nerr_platform_device_unregister:\r\nplatform_device_unregister(pdev);\r\nerr:\r\ndev_dbg(&intf->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int zd1301_frontend_detach(struct dvb_usb_adapter *adap)\r\n{\r\nstruct dvb_usb_device *d = adap_to_d(adap);\r\nstruct zd1301_dev *dev = d_to_priv(d);\r\nstruct usb_interface *intf = d->intf;\r\nstruct platform_device *pdev;\r\nstruct i2c_client *client;\r\ndev_dbg(&intf->dev, "\n");\r\nclient = dev->i2c_client_tuner;\r\npdev = dev->platform_device_demod;\r\nif (client) {\r\nmodule_put(client->dev.driver->owner);\r\ni2c_unregister_device(client);\r\n}\r\nif (pdev) {\r\nmodule_put(pdev->dev.driver->owner);\r\nplatform_device_unregister(pdev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int zd1301_streaming_ctrl(struct dvb_frontend *fe, int onoff)\r\n{\r\nstruct dvb_usb_device *d = fe_to_d(fe);\r\nstruct usb_interface *intf = d->intf;\r\nint ret;\r\nu8 buf[3] = {0x03, 0x00, onoff ? 0x07 : 0x08};\r\ndev_dbg(&intf->dev, "onoff=%d\n", onoff);\r\nret = zd1301_ctrl_msg(d, buf, 3, NULL, 0);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev_dbg(&intf->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}

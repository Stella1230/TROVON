static int mpc52xx_wkup_gpio_get(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\r\nunsigned int ret;\r\nret = (in_8(&regs->wkup_ival) >> (7 - gpio)) & 1;\r\npr_debug("%s: gpio: %d ret: %d\n", __func__, gpio, ret);\r\nreturn ret;\r\n}\r\nstatic inline void\r\n__mpc52xx_wkup_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\r\nif (val)\r\nchip->shadow_dvo |= 1 << (7 - gpio);\r\nelse\r\nchip->shadow_dvo &= ~(1 << (7 - gpio));\r\nout_8(&regs->wkup_dvo, chip->shadow_dvo);\r\n}\r\nstatic void\r\nmpc52xx_wkup_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\n__mpc52xx_wkup_gpio_set(gc, gpio, val);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\npr_debug("%s: gpio: %d val: %d\n", __func__, gpio, val);\r\n}\r\nstatic int mpc52xx_wkup_gpio_dir_in(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\nchip->shadow_ddr &= ~(1 << (7 - gpio));\r\nout_8(&regs->wkup_ddr, chip->shadow_ddr);\r\nchip->shadow_gpioe |= 1 << (7 - gpio);\r\nout_8(&regs->wkup_gpioe, chip->shadow_gpioe);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nmpc52xx_wkup_gpio_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\n__mpc52xx_wkup_gpio_set(gc, gpio, val);\r\nchip->shadow_ddr |= 1 << (7 - gpio);\r\nout_8(&regs->wkup_ddr, chip->shadow_ddr);\r\nchip->shadow_gpioe |= 1 << (7 - gpio);\r\nout_8(&regs->wkup_gpioe, chip->shadow_gpioe);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\npr_debug("%s: gpio: %d val: %d\n", __func__, gpio, val);\r\nreturn 0;\r\n}\r\nstatic int mpc52xx_wkup_gpiochip_probe(struct platform_device *ofdev)\r\n{\r\nstruct mpc52xx_gpiochip *chip;\r\nstruct mpc52xx_gpio_wkup __iomem *regs;\r\nstruct gpio_chip *gc;\r\nint ret;\r\nchip = devm_kzalloc(&ofdev->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(ofdev, chip);\r\ngc = &chip->mmchip.gc;\r\ngc->ngpio = 8;\r\ngc->direction_input = mpc52xx_wkup_gpio_dir_in;\r\ngc->direction_output = mpc52xx_wkup_gpio_dir_out;\r\ngc->get = mpc52xx_wkup_gpio_get;\r\ngc->set = mpc52xx_wkup_gpio_set;\r\nret = of_mm_gpiochip_add_data(ofdev->dev.of_node, &chip->mmchip, chip);\r\nif (ret)\r\nreturn ret;\r\nregs = chip->mmchip.regs;\r\nchip->shadow_gpioe = in_8(&regs->wkup_gpioe);\r\nchip->shadow_ddr = in_8(&regs->wkup_ddr);\r\nchip->shadow_dvo = in_8(&regs->wkup_dvo);\r\nreturn 0;\r\n}\r\nstatic int mpc52xx_gpiochip_remove(struct platform_device *ofdev)\r\n{\r\nstruct mpc52xx_gpiochip *chip = platform_get_drvdata(ofdev);\r\nof_mm_gpiochip_remove(&chip->mmchip);\r\nreturn 0;\r\n}\r\nstatic int mpc52xx_simple_gpio_get(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\r\nunsigned int ret;\r\nret = (in_be32(&regs->simple_ival) >> (31 - gpio)) & 1;\r\nreturn ret;\r\n}\r\nstatic inline void\r\n__mpc52xx_simple_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\r\nif (val)\r\nchip->shadow_dvo |= 1 << (31 - gpio);\r\nelse\r\nchip->shadow_dvo &= ~(1 << (31 - gpio));\r\nout_be32(&regs->simple_dvo, chip->shadow_dvo);\r\n}\r\nstatic void\r\nmpc52xx_simple_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\n__mpc52xx_simple_gpio_set(gc, gpio, val);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\npr_debug("%s: gpio: %d val: %d\n", __func__, gpio, val);\r\n}\r\nstatic int mpc52xx_simple_gpio_dir_in(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\nchip->shadow_ddr &= ~(1 << (31 - gpio));\r\nout_be32(&regs->simple_ddr, chip->shadow_ddr);\r\nchip->shadow_gpioe |= 1 << (31 - gpio);\r\nout_be32(&regs->simple_gpioe, chip->shadow_gpioe);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nmpc52xx_simple_gpio_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\r\nstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\r\nunsigned long flags;\r\nspin_lock_irqsave(&gpio_lock, flags);\r\n__mpc52xx_simple_gpio_set(gc, gpio, val);\r\nchip->shadow_ddr |= 1 << (31 - gpio);\r\nout_be32(&regs->simple_ddr, chip->shadow_ddr);\r\nchip->shadow_gpioe |= 1 << (31 - gpio);\r\nout_be32(&regs->simple_gpioe, chip->shadow_gpioe);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\npr_debug("%s: gpio: %d val: %d\n", __func__, gpio, val);\r\nreturn 0;\r\n}\r\nstatic int mpc52xx_simple_gpiochip_probe(struct platform_device *ofdev)\r\n{\r\nstruct mpc52xx_gpiochip *chip;\r\nstruct gpio_chip *gc;\r\nstruct mpc52xx_gpio __iomem *regs;\r\nint ret;\r\nchip = devm_kzalloc(&ofdev->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(ofdev, chip);\r\ngc = &chip->mmchip.gc;\r\ngc->ngpio = 32;\r\ngc->direction_input = mpc52xx_simple_gpio_dir_in;\r\ngc->direction_output = mpc52xx_simple_gpio_dir_out;\r\ngc->get = mpc52xx_simple_gpio_get;\r\ngc->set = mpc52xx_simple_gpio_set;\r\nret = of_mm_gpiochip_add_data(ofdev->dev.of_node, &chip->mmchip, chip);\r\nif (ret)\r\nreturn ret;\r\nregs = chip->mmchip.regs;\r\nchip->shadow_gpioe = in_be32(&regs->simple_gpioe);\r\nchip->shadow_ddr = in_be32(&regs->simple_ddr);\r\nchip->shadow_dvo = in_be32(&regs->simple_dvo);\r\nreturn 0;\r\n}\r\nstatic int __init mpc52xx_gpio_init(void)\r\n{\r\nreturn platform_register_drivers(drivers, ARRAY_SIZE(drivers));\r\n}\r\nstatic void __exit mpc52xx_gpio_exit(void)\r\n{\r\nplatform_unregister_drivers(drivers, ARRAY_SIZE(drivers));\r\n}

static struct hisi_clock_data *hi3519_clk_register(struct platform_device *pdev)\r\n{\r\nstruct hisi_clock_data *clk_data;\r\nint ret;\r\nclk_data = hisi_clk_alloc(pdev, HI3519_NR_CLKS);\r\nif (!clk_data)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = hisi_clk_register_fixed_rate(hi3519_fixed_rate_clks,\r\nARRAY_SIZE(hi3519_fixed_rate_clks),\r\nclk_data);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nret = hisi_clk_register_mux(hi3519_mux_clks,\r\nARRAY_SIZE(hi3519_mux_clks),\r\nclk_data);\r\nif (ret)\r\ngoto unregister_fixed_rate;\r\nret = hisi_clk_register_gate(hi3519_gate_clks,\r\nARRAY_SIZE(hi3519_gate_clks),\r\nclk_data);\r\nif (ret)\r\ngoto unregister_mux;\r\nret = of_clk_add_provider(pdev->dev.of_node,\r\nof_clk_src_onecell_get, &clk_data->clk_data);\r\nif (ret)\r\ngoto unregister_gate;\r\nreturn clk_data;\r\nunregister_fixed_rate:\r\nhisi_clk_unregister_fixed_rate(hi3519_fixed_rate_clks,\r\nARRAY_SIZE(hi3519_fixed_rate_clks),\r\nclk_data);\r\nunregister_mux:\r\nhisi_clk_unregister_mux(hi3519_mux_clks,\r\nARRAY_SIZE(hi3519_mux_clks),\r\nclk_data);\r\nunregister_gate:\r\nhisi_clk_unregister_gate(hi3519_gate_clks,\r\nARRAY_SIZE(hi3519_gate_clks),\r\nclk_data);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void hi3519_clk_unregister(struct platform_device *pdev)\r\n{\r\nstruct hi3519_crg_data *crg = platform_get_drvdata(pdev);\r\nof_clk_del_provider(pdev->dev.of_node);\r\nhisi_clk_unregister_gate(hi3519_gate_clks,\r\nARRAY_SIZE(hi3519_mux_clks),\r\ncrg->clk_data);\r\nhisi_clk_unregister_mux(hi3519_mux_clks,\r\nARRAY_SIZE(hi3519_mux_clks),\r\ncrg->clk_data);\r\nhisi_clk_unregister_fixed_rate(hi3519_fixed_rate_clks,\r\nARRAY_SIZE(hi3519_fixed_rate_clks),\r\ncrg->clk_data);\r\n}\r\nstatic int hi3519_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct hi3519_crg_data *crg;\r\ncrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\r\nif (!crg)\r\nreturn -ENOMEM;\r\ncrg->rstc = hisi_reset_init(pdev);\r\nif (!crg->rstc)\r\nreturn -ENOMEM;\r\ncrg->clk_data = hi3519_clk_register(pdev);\r\nif (IS_ERR(crg->clk_data)) {\r\nhisi_reset_exit(crg->rstc);\r\nreturn PTR_ERR(crg->clk_data);\r\n}\r\nplatform_set_drvdata(pdev, crg);\r\nreturn 0;\r\n}\r\nstatic int hi3519_clk_remove(struct platform_device *pdev)\r\n{\r\nstruct hi3519_crg_data *crg = platform_get_drvdata(pdev);\r\nhisi_reset_exit(crg->rstc);\r\nhi3519_clk_unregister(pdev);\r\nreturn 0;\r\n}\r\nstatic int __init hi3519_clk_init(void)\r\n{\r\nreturn platform_driver_register(&hi3519_clk_driver);\r\n}\r\nstatic void __exit hi3519_clk_exit(void)\r\n{\r\nplatform_driver_unregister(&hi3519_clk_driver);\r\n}

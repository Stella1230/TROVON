static const char *\r\nscsi_trace_rw6(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\nsector_t lba = 0, txlen = 0;\r\nlba |= ((cdb[1] & 0x1F) << 16);\r\nlba |= (cdb[2] << 8);\r\nlba |= cdb[3];\r\ntxlen = cdb[4];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu",\r\n(unsigned long long)lba, (unsigned long long)txlen);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw10(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\nsector_t lba = 0, txlen = 0;\r\nlba |= (cdb[2] << 24);\r\nlba |= (cdb[3] << 16);\r\nlba |= (cdb[4] << 8);\r\nlba |= cdb[5];\r\ntxlen |= (cdb[7] << 8);\r\ntxlen |= cdb[8];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\nif (cdb[0] == WRITE_SAME)\r\ntrace_seq_printf(p, " unmap=%u", cdb[1] >> 3 & 1);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw12(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\nsector_t lba = 0, txlen = 0;\r\nlba |= (cdb[2] << 24);\r\nlba |= (cdb[3] << 16);\r\nlba |= (cdb[4] << 8);\r\nlba |= cdb[5];\r\ntxlen |= (cdb[6] << 24);\r\ntxlen |= (cdb[7] << 16);\r\ntxlen |= (cdb[8] << 8);\r\ntxlen |= cdb[9];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw16(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\nsector_t lba = 0, txlen = 0;\r\nlba |= ((u64)cdb[2] << 56);\r\nlba |= ((u64)cdb[3] << 48);\r\nlba |= ((u64)cdb[4] << 40);\r\nlba |= ((u64)cdb[5] << 32);\r\nlba |= (cdb[6] << 24);\r\nlba |= (cdb[7] << 16);\r\nlba |= (cdb[8] << 8);\r\nlba |= cdb[9];\r\ntxlen |= (cdb[10] << 24);\r\ntxlen |= (cdb[11] << 16);\r\ntxlen |= (cdb[12] << 8);\r\ntxlen |= cdb[13];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\nif (cdb[0] == WRITE_SAME_16)\r\ntrace_seq_printf(p, " unmap=%u", cdb[1] >> 3 & 1);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw32(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nsector_t lba = 0, txlen = 0;\r\nu32 ei_lbrt = 0;\r\nswitch (SERVICE_ACTION32(cdb)) {\r\ncase READ_32:\r\ncmd = "READ";\r\nbreak;\r\ncase VERIFY_32:\r\ncmd = "VERIFY";\r\nbreak;\r\ncase WRITE_32:\r\ncmd = "WRITE";\r\nbreak;\r\ncase WRITE_SAME_32:\r\ncmd = "WRITE_SAME";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nlba |= ((u64)cdb[12] << 56);\r\nlba |= ((u64)cdb[13] << 48);\r\nlba |= ((u64)cdb[14] << 40);\r\nlba |= ((u64)cdb[15] << 32);\r\nlba |= (cdb[16] << 24);\r\nlba |= (cdb[17] << 16);\r\nlba |= (cdb[18] << 8);\r\nlba |= cdb[19];\r\nei_lbrt |= (cdb[20] << 24);\r\nei_lbrt |= (cdb[21] << 16);\r\nei_lbrt |= (cdb[22] << 8);\r\nei_lbrt |= cdb[23];\r\ntxlen |= (cdb[28] << 24);\r\ntxlen |= (cdb[29] << 16);\r\ntxlen |= (cdb[30] << 8);\r\ntxlen |= cdb[31];\r\ntrace_seq_printf(p, "%s_32 lba=%llu txlen=%llu protect=%u ei_lbrt=%u",\r\ncmd, (unsigned long long)lba,\r\n(unsigned long long)txlen, cdb[10] >> 5, ei_lbrt);\r\nif (SERVICE_ACTION32(cdb) == WRITE_SAME_32)\r\ntrace_seq_printf(p, " unmap=%u", cdb[10] >> 3 & 1);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_unmap(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\nunsigned int regions = cdb[7] << 8 | cdb[8];\r\ntrace_seq_printf(p, "regions=%u", (regions - 8) / 16);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_service_action_in(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nsector_t lba = 0;\r\nu32 alloc_len = 0;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase SAI_READ_CAPACITY_16:\r\ncmd = "READ_CAPACITY_16";\r\nbreak;\r\ncase SAI_GET_LBA_STATUS:\r\ncmd = "GET_LBA_STATUS";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nlba |= ((u64)cdb[2] << 56);\r\nlba |= ((u64)cdb[3] << 48);\r\nlba |= ((u64)cdb[4] << 40);\r\nlba |= ((u64)cdb[5] << 32);\r\nlba |= (cdb[6] << 24);\r\nlba |= (cdb[7] << 16);\r\nlba |= (cdb[8] << 8);\r\nlba |= cdb[9];\r\nalloc_len |= (cdb[10] << 24);\r\nalloc_len |= (cdb[11] << 16);\r\nalloc_len |= (cdb[12] << 8);\r\nalloc_len |= cdb[13];\r\ntrace_seq_printf(p, "%s lba=%llu alloc_len=%u", cmd,\r\n(unsigned long long)lba, alloc_len);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_maintenance_in(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nu32 alloc_len;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase MI_REPORT_IDENTIFYING_INFORMATION:\r\ncmd = "REPORT_IDENTIFYING_INFORMATION";\r\nbreak;\r\ncase MI_REPORT_TARGET_PGS:\r\ncmd = "REPORT_TARGET_PORT_GROUPS";\r\nbreak;\r\ncase MI_REPORT_ALIASES:\r\ncmd = "REPORT_ALIASES";\r\nbreak;\r\ncase MI_REPORT_SUPPORTED_OPERATION_CODES:\r\ncmd = "REPORT_SUPPORTED_OPERATION_CODES";\r\nbreak;\r\ncase MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS:\r\ncmd = "REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS";\r\nbreak;\r\ncase MI_REPORT_PRIORITY:\r\ncmd = "REPORT_PRIORITY";\r\nbreak;\r\ncase MI_REPORT_TIMESTAMP:\r\ncmd = "REPORT_TIMESTAMP";\r\nbreak;\r\ncase MI_MANAGEMENT_PROTOCOL_IN:\r\ncmd = "MANAGEMENT_PROTOCOL_IN";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nalloc_len = get_unaligned_be32(&cdb[6]);\r\ntrace_seq_printf(p, "%s alloc_len=%u", cmd, alloc_len);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_maintenance_out(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nu32 alloc_len;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase MO_SET_IDENTIFYING_INFORMATION:\r\ncmd = "SET_IDENTIFYING_INFORMATION";\r\nbreak;\r\ncase MO_SET_TARGET_PGS:\r\ncmd = "SET_TARGET_PORT_GROUPS";\r\nbreak;\r\ncase MO_CHANGE_ALIASES:\r\ncmd = "CHANGE_ALIASES";\r\nbreak;\r\ncase MO_SET_PRIORITY:\r\ncmd = "SET_PRIORITY";\r\nbreak;\r\ncase MO_SET_TIMESTAMP:\r\ncmd = "SET_TIMESTAMP";\r\nbreak;\r\ncase MO_MANAGEMENT_PROTOCOL_OUT:\r\ncmd = "MANAGEMENT_PROTOCOL_OUT";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nalloc_len = get_unaligned_be32(&cdb[6]);\r\ntrace_seq_printf(p, "%s alloc_len=%u", cmd, alloc_len);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_zbc_in(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nu64 zone_id;\r\nu32 alloc_len;\r\nu8 options;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase ZI_REPORT_ZONES:\r\ncmd = "REPORT_ZONES";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nzone_id = get_unaligned_be64(&cdb[2]);\r\nalloc_len = get_unaligned_be32(&cdb[10]);\r\noptions = cdb[14] & 0x3f;\r\ntrace_seq_printf(p, "%s zone=%llu alloc_len=%u options=%u partial=%u",\r\ncmd, (unsigned long long)zone_id, alloc_len,\r\noptions, (cdb[14] >> 7) & 1);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_zbc_out(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p), *cmd;\r\nu64 zone_id;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase ZO_CLOSE_ZONE:\r\ncmd = "CLOSE_ZONE";\r\nbreak;\r\ncase ZO_FINISH_ZONE:\r\ncmd = "FINISH_ZONE";\r\nbreak;\r\ncase ZO_OPEN_ZONE:\r\ncmd = "OPEN_ZONE";\r\nbreak;\r\ncase ZO_RESET_WRITE_POINTER:\r\ncmd = "RESET_WRITE_POINTER";\r\nbreak;\r\ndefault:\r\ntrace_seq_puts(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nzone_id = get_unaligned_be64(&cdb[2]);\r\ntrace_seq_printf(p, "%s zone=%llu all=%u", cmd,\r\n(unsigned long long)zone_id, cdb[14] & 1);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_varlen(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nswitch (SERVICE_ACTION32(cdb)) {\r\ncase READ_32:\r\ncase VERIFY_32:\r\ncase WRITE_32:\r\ncase WRITE_SAME_32:\r\nreturn scsi_trace_rw32(p, cdb, len);\r\ndefault:\r\nreturn scsi_trace_misc(p, cdb, len);\r\n}\r\n}\r\nstatic const char *\r\nscsi_trace_misc(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = trace_seq_buffer_ptr(p);\r\ntrace_seq_putc(p, '-');\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nconst char *\r\nscsi_trace_parse_cdb(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nswitch (cdb[0]) {\r\ncase READ_6:\r\ncase WRITE_6:\r\nreturn scsi_trace_rw6(p, cdb, len);\r\ncase READ_10:\r\ncase VERIFY:\r\ncase WRITE_10:\r\ncase WRITE_SAME:\r\nreturn scsi_trace_rw10(p, cdb, len);\r\ncase READ_12:\r\ncase VERIFY_12:\r\ncase WRITE_12:\r\nreturn scsi_trace_rw12(p, cdb, len);\r\ncase READ_16:\r\ncase VERIFY_16:\r\ncase WRITE_16:\r\ncase WRITE_SAME_16:\r\nreturn scsi_trace_rw16(p, cdb, len);\r\ncase UNMAP:\r\nreturn scsi_trace_unmap(p, cdb, len);\r\ncase SERVICE_ACTION_IN_16:\r\nreturn scsi_trace_service_action_in(p, cdb, len);\r\ncase VARIABLE_LENGTH_CMD:\r\nreturn scsi_trace_varlen(p, cdb, len);\r\ncase MAINTENANCE_IN:\r\nreturn scsi_trace_maintenance_in(p, cdb, len);\r\ncase MAINTENANCE_OUT:\r\nreturn scsi_trace_maintenance_out(p, cdb, len);\r\ncase ZBC_IN:\r\nreturn scsi_trace_zbc_in(p, cdb, len);\r\ncase ZBC_OUT:\r\nreturn scsi_trace_zbc_out(p, cdb, len);\r\ndefault:\r\nreturn scsi_trace_misc(p, cdb, len);\r\n}\r\n}

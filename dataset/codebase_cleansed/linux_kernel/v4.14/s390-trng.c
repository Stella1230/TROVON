static int trng_open(struct inode *inode, struct file *file)\r\n{\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t trng_read(struct file *file, char __user *ubuf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nu8 buf[32];\r\nu8 *p = buf;\r\nunsigned int n;\r\nssize_t ret = 0;\r\nif (nbytes > sizeof(buf)) {\r\np = (u8 *) __get_free_page(GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\n}\r\nwhile (nbytes) {\r\nif (need_resched()) {\r\nif (signal_pending(current)) {\r\nif (ret == 0)\r\nret = -ERESTARTSYS;\r\nbreak;\r\n}\r\nschedule();\r\n}\r\nn = nbytes > PAGE_SIZE ? PAGE_SIZE : nbytes;\r\ncpacf_trng(NULL, 0, p, n);\r\natomic64_add(n, &trng_dev_counter);\r\nif (copy_to_user(ubuf, p, n)) {\r\nret = -EFAULT;\r\nbreak;\r\n}\r\nnbytes -= n;\r\nubuf += n;\r\nret += n;\r\n}\r\nif (p != buf)\r\nfree_page((unsigned long) p);\r\nDEBUG_DBG("trng_read()=%zd\n", ret);\r\nreturn ret;\r\n}\r\nstatic ssize_t trng_counter_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu64 dev_counter = atomic64_read(&trng_dev_counter);\r\nu64 hwrng_counter = atomic64_read(&trng_hwrng_counter);\r\n#if IS_ENABLED(CONFIG_ARCH_RANDOM)\r\nu64 arch_counter = atomic64_read(&s390_arch_random_counter);\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"trng: %llu\n"\r\n"hwrng: %llu\n"\r\n"arch: %llu\n"\r\n"total: %llu\n",\r\ndev_counter, hwrng_counter, arch_counter,\r\ndev_counter + hwrng_counter + arch_counter);\r\n#else\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"trng: %llu\n"\r\n"hwrng: %llu\n"\r\n"total: %llu\n",\r\ndev_counter, hwrng_counter,\r\ndev_counter + hwrng_counter);\r\n#endif\r\n}\r\nstatic inline void _trng_hwrng_read(u8 *buf, size_t len)\r\n{\r\ncpacf_trng(NULL, 0, buf, len);\r\natomic64_add(len, &trng_hwrng_counter);\r\n}\r\nstatic int trng_hwrng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nsize_t len = sizeof(*data);\r\n_trng_hwrng_read((u8 *) data, len);\r\nDEBUG_DBG("trng_hwrng_data_read()=%zu\n", len);\r\nreturn len;\r\n}\r\nstatic int trng_hwrng_read(struct hwrng *rng, void *data, size_t max, bool wait)\r\n{\r\nsize_t len = max <= PAGE_SIZE ? max : PAGE_SIZE;\r\n_trng_hwrng_read((u8 *) data, len);\r\nDEBUG_DBG("trng_hwrng_read()=%zu\n", len);\r\nreturn len;\r\n}\r\nstatic void __init trng_debug_init(void)\r\n{\r\ndebug_info = debug_register("trng", 1, 1, 4 * sizeof(long));\r\ndebug_register_view(debug_info, &debug_sprintf_view);\r\ndebug_set_level(debug_info, 3);\r\n}\r\nstatic void trng_debug_exit(void)\r\n{\r\ndebug_unregister(debug_info);\r\n}\r\nstatic int __init trng_init(void)\r\n{\r\nint ret;\r\ntrng_debug_init();\r\nif (!cpacf_query_func(CPACF_PRNO, CPACF_PRNO_TRNG)) {\r\nDEBUG_INFO("trng_init CPACF_PRNO_TRNG not available\n");\r\nret = -ENODEV;\r\ngoto out_dbg;\r\n}\r\nret = misc_register(&trng_dev);\r\nif (ret) {\r\nDEBUG_WARN("trng_init misc_register() failed rc=%d\n", ret);\r\ngoto out_dbg;\r\n}\r\nret = hwrng_register(&trng_hwrng_dev);\r\nif (ret) {\r\nDEBUG_WARN("trng_init hwrng_register() failed rc=%d\n", ret);\r\ngoto out_misc;\r\n}\r\nDEBUG_DBG("trng_init successful\n");\r\nreturn 0;\r\nout_misc:\r\nmisc_deregister(&trng_dev);\r\nout_dbg:\r\ntrng_debug_exit();\r\nreturn ret;\r\n}\r\nstatic void __exit trng_exit(void)\r\n{\r\nhwrng_unregister(&trng_hwrng_dev);\r\nmisc_deregister(&trng_dev);\r\ntrng_debug_exit();\r\n}

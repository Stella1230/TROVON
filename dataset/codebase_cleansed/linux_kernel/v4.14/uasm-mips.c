static inline u32 build_bimm(s32 arg)\r\n{\r\nWARN(arg > 0x1ffff || arg < -0x20000,\r\nKERN_WARNING "Micro-assembler field overflow\n");\r\nWARN(arg & 0x3, KERN_WARNING "Invalid micro-assembler branch target\n");\r\nreturn ((arg < 0) ? (1 << 15) : 0) | ((arg >> 2) & 0x7fff);\r\n}\r\nstatic inline u32 build_jimm(u32 arg)\r\n{\r\nWARN(arg & ~(JIMM_MASK << 2),\r\nKERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg >> 2) & JIMM_MASK;\r\n}\r\nstatic void build_insn(u32 **buf, enum opcode opc, ...)\r\n{\r\nconst struct insn *ip;\r\nva_list ap;\r\nu32 op;\r\nif (opc < 0 || opc >= insn_invalid ||\r\n(opc == insn_daddiu && r4k_daddiu_bug()) ||\r\n(insn_table[opc].match == 0 && insn_table[opc].fields == 0))\r\npanic("Unsupported Micro-assembler instruction %d", opc);\r\nip = &insn_table[opc];\r\nop = ip->match;\r\nva_start(ap, opc);\r\nif (ip->fields & RS)\r\nop |= build_rs(va_arg(ap, u32));\r\nif (ip->fields & RT)\r\nop |= build_rt(va_arg(ap, u32));\r\nif (ip->fields & RD)\r\nop |= build_rd(va_arg(ap, u32));\r\nif (ip->fields & RE)\r\nop |= build_re(va_arg(ap, u32));\r\nif (ip->fields & SIMM)\r\nop |= build_simm(va_arg(ap, s32));\r\nif (ip->fields & UIMM)\r\nop |= build_uimm(va_arg(ap, u32));\r\nif (ip->fields & BIMM)\r\nop |= build_bimm(va_arg(ap, s32));\r\nif (ip->fields & JIMM)\r\nop |= build_jimm(va_arg(ap, u32));\r\nif (ip->fields & FUNC)\r\nop |= build_func(va_arg(ap, u32));\r\nif (ip->fields & SET)\r\nop |= build_set(va_arg(ap, u32));\r\nif (ip->fields & SCIMM)\r\nop |= build_scimm(va_arg(ap, u32));\r\nif (ip->fields & SIMM9)\r\nop |= build_scimm9(va_arg(ap, u32));\r\nva_end(ap);\r\n**buf = op;\r\n(*buf)++;\r\n}\r\nstatic inline void\r\n__resolve_relocs(struct uasm_reloc *rel, struct uasm_label *lab)\r\n{\r\nlong laddr = (long)lab->addr;\r\nlong raddr = (long)rel->addr;\r\nswitch (rel->type) {\r\ncase R_MIPS_PC16:\r\n*rel->addr |= build_bimm(laddr - (raddr + 4));\r\nbreak;\r\ndefault:\r\npanic("Unsupported Micro-assembler relocation %d",\r\nrel->type);\r\n}\r\n}

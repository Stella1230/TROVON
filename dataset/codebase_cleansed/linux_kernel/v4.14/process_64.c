void show_regs(struct pt_regs *regs)\r\n{\r\nunsigned long long ah, al, bh, bl, ch, cl;\r\nprintk("\n");\r\nshow_regs_print_info(KERN_DEFAULT);\r\nah = (regs->pc) >> 32;\r\nal = (regs->pc) & 0xffffffff;\r\nbh = (regs->regs[18]) >> 32;\r\nbl = (regs->regs[18]) & 0xffffffff;\r\nch = (regs->regs[15]) >> 32;\r\ncl = (regs->regs[15]) & 0xffffffff;\r\nprintk("PC : %08Lx%08Lx LINK: %08Lx%08Lx SP : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->sr) >> 32;\r\nal = (regs->sr) & 0xffffffff;\r\nasm volatile ("getcon " __TEA ", %0" : "=r" (bh));\r\nasm volatile ("getcon " __TEA ", %0" : "=r" (bl));\r\nbh = (bh) >> 32;\r\nbl = (bl) & 0xffffffff;\r\nasm volatile ("getcon " __KCR0 ", %0" : "=r" (ch));\r\nasm volatile ("getcon " __KCR0 ", %0" : "=r" (cl));\r\nch = (ch) >> 32;\r\ncl = (cl) & 0xffffffff;\r\nprintk("SR : %08Lx%08Lx TEA : %08Lx%08Lx KCR0: %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[0]) >> 32;\r\nal = (regs->regs[0]) & 0xffffffff;\r\nbh = (regs->regs[1]) >> 32;\r\nbl = (regs->regs[1]) & 0xffffffff;\r\nch = (regs->regs[2]) >> 32;\r\ncl = (regs->regs[2]) & 0xffffffff;\r\nprintk("R0 : %08Lx%08Lx R1 : %08Lx%08Lx R2 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[3]) >> 32;\r\nal = (regs->regs[3]) & 0xffffffff;\r\nbh = (regs->regs[4]) >> 32;\r\nbl = (regs->regs[4]) & 0xffffffff;\r\nch = (regs->regs[5]) >> 32;\r\ncl = (regs->regs[5]) & 0xffffffff;\r\nprintk("R3 : %08Lx%08Lx R4 : %08Lx%08Lx R5 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[6]) >> 32;\r\nal = (regs->regs[6]) & 0xffffffff;\r\nbh = (regs->regs[7]) >> 32;\r\nbl = (regs->regs[7]) & 0xffffffff;\r\nch = (regs->regs[8]) >> 32;\r\ncl = (regs->regs[8]) & 0xffffffff;\r\nprintk("R6 : %08Lx%08Lx R7 : %08Lx%08Lx R8 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[9]) >> 32;\r\nal = (regs->regs[9]) & 0xffffffff;\r\nbh = (regs->regs[10]) >> 32;\r\nbl = (regs->regs[10]) & 0xffffffff;\r\nch = (regs->regs[11]) >> 32;\r\ncl = (regs->regs[11]) & 0xffffffff;\r\nprintk("R9 : %08Lx%08Lx R10 : %08Lx%08Lx R11 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[12]) >> 32;\r\nal = (regs->regs[12]) & 0xffffffff;\r\nbh = (regs->regs[13]) >> 32;\r\nbl = (regs->regs[13]) & 0xffffffff;\r\nch = (regs->regs[14]) >> 32;\r\ncl = (regs->regs[14]) & 0xffffffff;\r\nprintk("R12 : %08Lx%08Lx R13 : %08Lx%08Lx R14 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[16]) >> 32;\r\nal = (regs->regs[16]) & 0xffffffff;\r\nbh = (regs->regs[17]) >> 32;\r\nbl = (regs->regs[17]) & 0xffffffff;\r\nch = (regs->regs[19]) >> 32;\r\ncl = (regs->regs[19]) & 0xffffffff;\r\nprintk("R16 : %08Lx%08Lx R17 : %08Lx%08Lx R19 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[20]) >> 32;\r\nal = (regs->regs[20]) & 0xffffffff;\r\nbh = (regs->regs[21]) >> 32;\r\nbl = (regs->regs[21]) & 0xffffffff;\r\nch = (regs->regs[22]) >> 32;\r\ncl = (regs->regs[22]) & 0xffffffff;\r\nprintk("R20 : %08Lx%08Lx R21 : %08Lx%08Lx R22 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[23]) >> 32;\r\nal = (regs->regs[23]) & 0xffffffff;\r\nbh = (regs->regs[24]) >> 32;\r\nbl = (regs->regs[24]) & 0xffffffff;\r\nch = (regs->regs[25]) >> 32;\r\ncl = (regs->regs[25]) & 0xffffffff;\r\nprintk("R23 : %08Lx%08Lx R24 : %08Lx%08Lx R25 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[26]) >> 32;\r\nal = (regs->regs[26]) & 0xffffffff;\r\nbh = (regs->regs[27]) >> 32;\r\nbl = (regs->regs[27]) & 0xffffffff;\r\nch = (regs->regs[28]) >> 32;\r\ncl = (regs->regs[28]) & 0xffffffff;\r\nprintk("R26 : %08Lx%08Lx R27 : %08Lx%08Lx R28 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[29]) >> 32;\r\nal = (regs->regs[29]) & 0xffffffff;\r\nbh = (regs->regs[30]) >> 32;\r\nbl = (regs->regs[30]) & 0xffffffff;\r\nch = (regs->regs[31]) >> 32;\r\ncl = (regs->regs[31]) & 0xffffffff;\r\nprintk("R29 : %08Lx%08Lx R30 : %08Lx%08Lx R31 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[32]) >> 32;\r\nal = (regs->regs[32]) & 0xffffffff;\r\nbh = (regs->regs[33]) >> 32;\r\nbl = (regs->regs[33]) & 0xffffffff;\r\nch = (regs->regs[34]) >> 32;\r\ncl = (regs->regs[34]) & 0xffffffff;\r\nprintk("R32 : %08Lx%08Lx R33 : %08Lx%08Lx R34 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[35]) >> 32;\r\nal = (regs->regs[35]) & 0xffffffff;\r\nbh = (regs->regs[36]) >> 32;\r\nbl = (regs->regs[36]) & 0xffffffff;\r\nch = (regs->regs[37]) >> 32;\r\ncl = (regs->regs[37]) & 0xffffffff;\r\nprintk("R35 : %08Lx%08Lx R36 : %08Lx%08Lx R37 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[38]) >> 32;\r\nal = (regs->regs[38]) & 0xffffffff;\r\nbh = (regs->regs[39]) >> 32;\r\nbl = (regs->regs[39]) & 0xffffffff;\r\nch = (regs->regs[40]) >> 32;\r\ncl = (regs->regs[40]) & 0xffffffff;\r\nprintk("R38 : %08Lx%08Lx R39 : %08Lx%08Lx R40 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[41]) >> 32;\r\nal = (regs->regs[41]) & 0xffffffff;\r\nbh = (regs->regs[42]) >> 32;\r\nbl = (regs->regs[42]) & 0xffffffff;\r\nch = (regs->regs[43]) >> 32;\r\ncl = (regs->regs[43]) & 0xffffffff;\r\nprintk("R41 : %08Lx%08Lx R42 : %08Lx%08Lx R43 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[44]) >> 32;\r\nal = (regs->regs[44]) & 0xffffffff;\r\nbh = (regs->regs[45]) >> 32;\r\nbl = (regs->regs[45]) & 0xffffffff;\r\nch = (regs->regs[46]) >> 32;\r\ncl = (regs->regs[46]) & 0xffffffff;\r\nprintk("R44 : %08Lx%08Lx R45 : %08Lx%08Lx R46 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[47]) >> 32;\r\nal = (regs->regs[47]) & 0xffffffff;\r\nbh = (regs->regs[48]) >> 32;\r\nbl = (regs->regs[48]) & 0xffffffff;\r\nch = (regs->regs[49]) >> 32;\r\ncl = (regs->regs[49]) & 0xffffffff;\r\nprintk("R47 : %08Lx%08Lx R48 : %08Lx%08Lx R49 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[50]) >> 32;\r\nal = (regs->regs[50]) & 0xffffffff;\r\nbh = (regs->regs[51]) >> 32;\r\nbl = (regs->regs[51]) & 0xffffffff;\r\nch = (regs->regs[52]) >> 32;\r\ncl = (regs->regs[52]) & 0xffffffff;\r\nprintk("R50 : %08Lx%08Lx R51 : %08Lx%08Lx R52 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[53]) >> 32;\r\nal = (regs->regs[53]) & 0xffffffff;\r\nbh = (regs->regs[54]) >> 32;\r\nbl = (regs->regs[54]) & 0xffffffff;\r\nch = (regs->regs[55]) >> 32;\r\ncl = (regs->regs[55]) & 0xffffffff;\r\nprintk("R53 : %08Lx%08Lx R54 : %08Lx%08Lx R55 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[56]) >> 32;\r\nal = (regs->regs[56]) & 0xffffffff;\r\nbh = (regs->regs[57]) >> 32;\r\nbl = (regs->regs[57]) & 0xffffffff;\r\nch = (regs->regs[58]) >> 32;\r\ncl = (regs->regs[58]) & 0xffffffff;\r\nprintk("R56 : %08Lx%08Lx R57 : %08Lx%08Lx R58 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[59]) >> 32;\r\nal = (regs->regs[59]) & 0xffffffff;\r\nbh = (regs->regs[60]) >> 32;\r\nbl = (regs->regs[60]) & 0xffffffff;\r\nch = (regs->regs[61]) >> 32;\r\ncl = (regs->regs[61]) & 0xffffffff;\r\nprintk("R59 : %08Lx%08Lx R60 : %08Lx%08Lx R61 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->regs[62]) >> 32;\r\nal = (regs->regs[62]) & 0xffffffff;\r\nbh = (regs->tregs[0]) >> 32;\r\nbl = (regs->tregs[0]) & 0xffffffff;\r\nch = (regs->tregs[1]) >> 32;\r\ncl = (regs->tregs[1]) & 0xffffffff;\r\nprintk("R62 : %08Lx%08Lx T0 : %08Lx%08Lx T1 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->tregs[2]) >> 32;\r\nal = (regs->tregs[2]) & 0xffffffff;\r\nbh = (regs->tregs[3]) >> 32;\r\nbl = (regs->tregs[3]) & 0xffffffff;\r\nch = (regs->tregs[4]) >> 32;\r\ncl = (regs->tregs[4]) & 0xffffffff;\r\nprintk("T2 : %08Lx%08Lx T3 : %08Lx%08Lx T4 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nah = (regs->tregs[5]) >> 32;\r\nal = (regs->tregs[5]) & 0xffffffff;\r\nbh = (regs->tregs[6]) >> 32;\r\nbl = (regs->tregs[6]) & 0xffffffff;\r\nch = (regs->tregs[7]) >> 32;\r\ncl = (regs->tregs[7]) & 0xffffffff;\r\nprintk("T5 : %08Lx%08Lx T6 : %08Lx%08Lx T7 : %08Lx%08Lx\n",\r\nah, al, bh, bl, ch, cl);\r\nif (!user_mode(regs)) {\r\nvoid show_stack(struct task_struct *tsk, unsigned long *sp);\r\nunsigned long sp = regs->regs[15] & 0xffffffff;\r\nstruct task_struct *tsk = get_current();\r\ntsk->thread.kregs = regs;\r\nshow_stack(tsk, (unsigned long *)sp);\r\n}\r\n}\r\nvoid exit_thread(struct task_struct *tsk)\r\n{\r\n#ifdef CONFIG_SH_FPU\r\nif (last_task_used_math == tsk)\r\nlast_task_used_math = NULL;\r\n#endif\r\n}\r\nvoid flush_thread(void)\r\n{\r\n#ifdef CONFIG_SH_FPU\r\nif (last_task_used_math == current) {\r\nlast_task_used_math = NULL;\r\n}\r\nclear_used_math();\r\n#endif\r\nif(current->thread.kregs==&fake_swapper_regs) {\r\ncurrent->thread.kregs =\r\n((struct pt_regs *)(THREAD_SIZE + (unsigned long) current) - 1);\r\ncurrent->thread.uregs = current->thread.kregs;\r\n}\r\n}\r\nvoid release_thread(struct task_struct *dead_task)\r\n{\r\n}\r\nint dump_fpu(struct pt_regs *regs, elf_fpregset_t *fpu)\r\n{\r\n#ifdef CONFIG_SH_FPU\r\nint fpvalid;\r\nstruct task_struct *tsk = current;\r\nfpvalid = !!tsk_used_math(tsk);\r\nif (fpvalid) {\r\nif (current == last_task_used_math) {\r\nenable_fpu();\r\nsave_fpu(tsk);\r\ndisable_fpu();\r\nlast_task_used_math = 0;\r\nregs->sr |= SR_FD;\r\n}\r\nmemcpy(fpu, &tsk->thread.xstate->hardfpu, sizeof(*fpu));\r\n}\r\nreturn fpvalid;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nint copy_thread(unsigned long clone_flags, unsigned long usp,\r\nunsigned long arg, struct task_struct *p)\r\n{\r\nstruct pt_regs *childregs;\r\n#ifdef CONFIG_SH_FPU\r\nif (last_task_used_math == current) {\r\nenable_fpu();\r\nsave_fpu(current);\r\ndisable_fpu();\r\nlast_task_used_math = NULL;\r\ncurrent_pt_regs()->sr |= SR_FD;\r\n}\r\n#endif\r\nchildregs = (struct pt_regs *)(THREAD_SIZE + task_stack_page(p)) - 1;\r\np->thread.sp = (unsigned long) childregs;\r\nif (unlikely(p->flags & PF_KTHREAD)) {\r\nmemset(childregs, 0, sizeof(struct pt_regs));\r\nchildregs->regs[2] = (unsigned long)arg;\r\nchildregs->regs[3] = (unsigned long)usp;\r\nchildregs->sr = (1 << 30);\r\nchildregs->sr |= SR_FD;\r\np->thread.pc = (unsigned long) ret_from_kernel_thread;\r\nreturn 0;\r\n}\r\n*childregs = *current_pt_regs();\r\nif (usp)\r\nchildregs->regs[15] = neff_sign_extend(usp);\r\np->thread.uregs = childregs;\r\nchildregs->regs[9] = 0;\r\nchildregs->sr |= SR_FD;\r\np->thread.pc = (unsigned long) ret_from_fork;\r\nreturn 0;\r\n}\r\nstatic int in_sh64_switch_to(unsigned long pc)\r\n{\r\nextern char __sh64_switch_to_end;\r\nreturn (pc >= (unsigned long) sh64_switch_to) &&\r\n(pc < (unsigned long) &__sh64_switch_to_end);\r\n}\r\nunsigned long get_wchan(struct task_struct *p)\r\n{\r\nunsigned long pc;\r\nif (!p || p == current || p->state == TASK_RUNNING)\r\nreturn 0;\r\npc = thread_saved_pc(p);\r\n#ifdef CONFIG_FRAME_POINTER\r\nif (in_sh64_switch_to(pc)) {\r\nunsigned long schedule_fp;\r\nunsigned long sh64_switch_to_fp;\r\nunsigned long schedule_caller_pc;\r\nsh64_switch_to_fp = (long) p->thread.sp;\r\nschedule_fp = *(unsigned long *) (long)(sh64_switch_to_fp + 4);\r\nschedule_caller_pc = *(unsigned long *) (long)(schedule_fp + 24);\r\nreturn schedule_caller_pc;\r\n}\r\n#endif\r\nreturn pc;\r\n}

static int mcp795_rtcc_read(struct device *dev, u8 addr, u8 *buf, u8 count)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\nu8 tx[2];\r\ntx[0] = MCP795_READ;\r\ntx[1] = addr;\r\nret = spi_write_then_read(spi, tx, sizeof(tx), buf, count);\r\nif (ret)\r\ndev_err(dev, "Failed reading %d bytes from address %x.\n",\r\ncount, addr);\r\nreturn ret;\r\n}\r\nstatic int mcp795_rtcc_write(struct device *dev, u8 addr, u8 *data, u8 count)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\nu8 tx[2 + count];\r\ntx[0] = MCP795_WRITE;\r\ntx[1] = addr;\r\nmemcpy(&tx[2], data, count);\r\nret = spi_write(spi, tx, 2 + count);\r\nif (ret)\r\ndev_err(dev, "Failed to write %d bytes to address %x.\n",\r\ncount, addr);\r\nreturn ret;\r\n}\r\nstatic int mcp795_rtcc_set_bits(struct device *dev, u8 addr, u8 mask, u8 state)\r\n{\r\nint ret;\r\nu8 tmp;\r\nret = mcp795_rtcc_read(dev, addr, &tmp, 1);\r\nif (ret)\r\nreturn ret;\r\nif ((tmp & mask) != state) {\r\ntmp = (tmp & ~mask) | state;\r\nret = mcp795_rtcc_write(dev, addr, &tmp, 1);\r\n}\r\nreturn ret;\r\n}\r\nstatic int mcp795_stop_oscillator(struct device *dev, bool *extosc)\r\n{\r\nint retries = 5;\r\nint ret;\r\nu8 data;\r\nret = mcp795_rtcc_set_bits(dev, MCP795_REG_SECONDS, MCP795_ST_BIT, 0);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_rtcc_read(dev, MCP795_REG_CONTROL, &data, 1);\r\nif (ret)\r\nreturn ret;\r\n*extosc = !!(data & MCP795_EXTOSC_BIT);\r\nret = mcp795_rtcc_set_bits(\r\ndev, MCP795_REG_CONTROL, MCP795_EXTOSC_BIT, 0);\r\nif (ret)\r\nreturn ret;\r\ndo {\r\nusleep_range(700, 800);\r\nret = mcp795_rtcc_read(dev, MCP795_REG_DAY, &data, 1);\r\nif (ret)\r\nbreak;\r\nif (!(data & MCP795_OSCON_BIT))\r\nbreak;\r\n} while (--retries);\r\nreturn !retries ? -EIO : ret;\r\n}\r\nstatic int mcp795_start_oscillator(struct device *dev, bool *extosc)\r\n{\r\nif (extosc) {\r\nu8 data = *extosc ? MCP795_EXTOSC_BIT : 0;\r\nint ret;\r\nret = mcp795_rtcc_set_bits(\r\ndev, MCP795_REG_CONTROL, MCP795_EXTOSC_BIT, data);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn mcp795_rtcc_set_bits(\r\ndev, MCP795_REG_SECONDS, MCP795_ST_BIT, MCP795_ST_BIT);\r\n}\r\nstatic int mcp795_update_alarm(struct device *dev, bool enable)\r\n{\r\nint ret;\r\ndev_dbg(dev, "%s alarm\n", enable ? "Enable" : "Disable");\r\nif (enable) {\r\nret = mcp795_rtcc_set_bits(dev, MCP795_REG_ALM0_DAY,\r\nMCP795_ALM0IF_BIT, 0);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_rtcc_set_bits(dev, MCP795_REG_CONTROL,\r\nMCP795_ALM0_BIT, MCP795_ALM0_BIT);\r\n} else {\r\nret = mcp795_rtcc_set_bits(dev, MCP795_REG_CONTROL,\r\nMCP795_ALM0_BIT | MCP795_ALM1_BIT, 0);\r\n}\r\nreturn ret;\r\n}\r\nstatic int mcp795_set_time(struct device *dev, struct rtc_time *tim)\r\n{\r\nint ret;\r\nu8 data[7];\r\nbool extosc;\r\nret = mcp795_stop_oscillator(dev, &extosc);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_rtcc_read(dev, MCP795_REG_SECONDS, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\ndata[0] = (data[0] & 0x80) | bin2bcd(tim->tm_sec);\r\ndata[1] = (data[1] & 0x80) | bin2bcd(tim->tm_min);\r\ndata[2] = bin2bcd(tim->tm_hour);\r\ndata[3] = (data[3] & 0xF8) | bin2bcd(tim->tm_wday + 1);\r\ndata[4] = bin2bcd(tim->tm_mday);\r\ndata[5] = (data[5] & MCP795_LP_BIT) | bin2bcd(tim->tm_mon + 1);\r\nif (tim->tm_year > 100)\r\ntim->tm_year -= 100;\r\ndata[6] = bin2bcd(tim->tm_year);\r\nret = mcp795_rtcc_write(dev, MCP795_REG_SECONDS, data, 5);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_rtcc_write(dev, MCP795_REG_MONTH, &data[5], 2);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_start_oscillator(dev, extosc ? &extosc : NULL);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(dev, "Set mcp795: %04d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\ntim->tm_year + 1900, tim->tm_mon, tim->tm_mday,\r\ntim->tm_wday, tim->tm_hour, tim->tm_min, tim->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int mcp795_read_time(struct device *dev, struct rtc_time *tim)\r\n{\r\nint ret;\r\nu8 data[7];\r\nret = mcp795_rtcc_read(dev, MCP795_REG_SECONDS, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\ntim->tm_sec = bcd2bin(data[0] & 0x7F);\r\ntim->tm_min = bcd2bin(data[1] & 0x7F);\r\ntim->tm_hour = bcd2bin(data[2] & 0x3F);\r\ntim->tm_wday = bcd2bin(data[3] & 0x07) - 1;\r\ntim->tm_mday = bcd2bin(data[4] & 0x3F);\r\ntim->tm_mon = bcd2bin(data[5] & 0x1F) - 1;\r\ntim->tm_year = bcd2bin(data[6]) + 100;\r\ndev_dbg(dev, "Read from mcp795: %04d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\ntim->tm_year + 1900, tim->tm_mon, tim->tm_mday,\r\ntim->tm_wday, tim->tm_hour, tim->tm_min, tim->tm_sec);\r\nreturn rtc_valid_tm(tim);\r\n}\r\nstatic int mcp795_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct rtc_time now_tm;\r\ntime64_t now;\r\ntime64_t later;\r\nu8 tmp[6];\r\nint ret;\r\nret = mcp795_read_time(dev, &now_tm);\r\nif (ret)\r\nreturn ret;\r\nnow = rtc_tm_to_time64(&now_tm);\r\nlater = rtc_tm_to_time64(&alm->time);\r\nif (later <= now)\r\nreturn -EINVAL;\r\nif ((later - now) >=\r\n(SEC_PER_DAY * (365 + is_leap_year(alm->time.tm_year))))\r\nreturn -EDOM;\r\nret = mcp795_update_alarm(dev, false);\r\nif (ret)\r\nreturn ret;\r\nret = mcp795_rtcc_read(dev, MCP795_REG_ALM0_SECONDS, tmp, sizeof(tmp));\r\nif (ret)\r\nreturn ret;\r\nalm->time.tm_year = -1;\r\nalm->time.tm_isdst = -1;\r\nalm->time.tm_yday = -1;\r\ntmp[0] = (tmp[0] & 0x80) | bin2bcd(alm->time.tm_sec);\r\ntmp[1] = (tmp[1] & 0x80) | bin2bcd(alm->time.tm_min);\r\ntmp[2] = (tmp[2] & 0xE0) | bin2bcd(alm->time.tm_hour);\r\ntmp[3] = (tmp[3] & 0x80) | bin2bcd(alm->time.tm_wday + 1);\r\ntmp[3] |= (MCP795_ALM0C2_BIT | MCP795_ALM0C1_BIT | MCP795_ALM0C0_BIT);\r\ntmp[4] = (tmp[4] & 0xC0) | bin2bcd(alm->time.tm_mday);\r\ntmp[5] = (tmp[5] & 0xE0) | bin2bcd(alm->time.tm_mon + 1);\r\nret = mcp795_rtcc_write(dev, MCP795_REG_ALM0_SECONDS, tmp, sizeof(tmp));\r\nif (ret)\r\nreturn ret;\r\nif (alm->enabled) {\r\nret = mcp795_update_alarm(dev, true);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(dev, "Alarm IRQ armed\n");\r\n}\r\ndev_dbg(dev, "Set alarm: %02d-%02d(%d) %02d:%02d:%02d\n",\r\nalm->time.tm_mon, alm->time.tm_mday, alm->time.tm_wday,\r\nalm->time.tm_hour, alm->time.tm_min, alm->time.tm_sec);\r\nreturn 0;\r\n}\r\nstatic int mcp795_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nu8 data[6];\r\nint ret;\r\nret = mcp795_rtcc_read(\r\ndev, MCP795_REG_ALM0_SECONDS, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\nalm->time.tm_sec = bcd2bin(data[0] & 0x7F);\r\nalm->time.tm_min = bcd2bin(data[1] & 0x7F);\r\nalm->time.tm_hour = bcd2bin(data[2] & 0x1F);\r\nalm->time.tm_wday = bcd2bin(data[3] & 0x07) - 1;\r\nalm->time.tm_mday = bcd2bin(data[4] & 0x3F);\r\nalm->time.tm_mon = bcd2bin(data[5] & 0x1F) - 1;\r\nalm->time.tm_year = -1;\r\nalm->time.tm_isdst = -1;\r\nalm->time.tm_yday = -1;\r\ndev_dbg(dev, "Read alarm: %02d-%02d(%d) %02d:%02d:%02d\n",\r\nalm->time.tm_mon, alm->time.tm_mday, alm->time.tm_wday,\r\nalm->time.tm_hour, alm->time.tm_min, alm->time.tm_sec);\r\nreturn 0;\r\n}\r\nstatic int mcp795_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nreturn mcp795_update_alarm(dev, !!enabled);\r\n}\r\nstatic irqreturn_t mcp795_irq(int irq, void *data)\r\n{\r\nstruct spi_device *spi = data;\r\nstruct rtc_device *rtc = spi_get_drvdata(spi);\r\nstruct mutex *lock = &rtc->ops_lock;\r\nint ret;\r\nmutex_lock(lock);\r\nret = mcp795_update_alarm(&spi->dev, false);\r\nif (ret)\r\ndev_err(&spi->dev,\r\n"Failed to disable alarm in IRQ (ret=%d)\n", ret);\r\nrtc_update_irq(rtc, 1, RTC_AF | RTC_IRQF);\r\nmutex_unlock(lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mcp795_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nint ret;\r\nspi->mode = SPI_MODE_0;\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret) {\r\ndev_err(&spi->dev, "Unable to setup SPI\n");\r\nreturn ret;\r\n}\r\nmcp795_start_oscillator(&spi->dev, NULL);\r\nmcp795_rtcc_set_bits(&spi->dev, 0x03, MCP795_24_BIT, 0);\r\nrtc = devm_rtc_device_register(&spi->dev, "rtc-mcp795",\r\n&mcp795_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nspi_set_drvdata(spi, rtc);\r\nif (spi->irq > 0) {\r\ndev_dbg(&spi->dev, "Alarm support enabled\n");\r\nmcp795_rtcc_set_bits(&spi->dev, MCP795_REG_ALM0_DAY,\r\nMCP795_ALM0IF_BIT, 0);\r\nret = devm_request_threaded_irq(&spi->dev, spi->irq, NULL,\r\nmcp795_irq, IRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\ndev_name(&rtc->dev), spi);\r\nif (ret)\r\ndev_err(&spi->dev, "Failed to request IRQ: %d: %d\n",\r\nspi->irq, ret);\r\nelse\r\ndevice_init_wakeup(&spi->dev, true);\r\n}\r\nreturn 0;\r\n}

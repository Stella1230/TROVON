static int dp83867_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err = phy_read(phydev, MII_DP83867_ISR);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int dp83867_config_intr(struct phy_device *phydev)\r\n{\r\nint micr_status;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\r\nmicr_status = phy_read(phydev, MII_DP83867_MICR);\r\nif (micr_status < 0)\r\nreturn micr_status;\r\nmicr_status |=\r\n(MII_DP83867_MICR_AN_ERR_INT_EN |\r\nMII_DP83867_MICR_SPEED_CHNG_INT_EN |\r\nMII_DP83867_MICR_AUTONEG_COMP_INT_EN |\r\nMII_DP83867_MICR_LINK_STS_CHNG_INT_EN |\r\nMII_DP83867_MICR_DUP_MODE_CHNG_INT_EN |\r\nMII_DP83867_MICR_SLEEP_MODE_CHNG_INT_EN);\r\nreturn phy_write(phydev, MII_DP83867_MICR, micr_status);\r\n}\r\nmicr_status = 0x0;\r\nreturn phy_write(phydev, MII_DP83867_MICR, micr_status);\r\n}\r\nstatic int dp83867_config_port_mirroring(struct phy_device *phydev)\r\n{\r\nstruct dp83867_private *dp83867 =\r\n(struct dp83867_private *)phydev->priv;\r\nu16 val;\r\nval = phy_read_mmd(phydev, DP83867_DEVADDR, DP83867_CFG4);\r\nif (dp83867->port_mirroring == DP83867_PORT_MIRROING_EN)\r\nval |= DP83867_CFG4_PORT_MIRROR_EN;\r\nelse\r\nval &= ~DP83867_CFG4_PORT_MIRROR_EN;\r\nphy_write_mmd(phydev, DP83867_DEVADDR, DP83867_CFG4, val);\r\nreturn 0;\r\n}\r\nstatic int dp83867_of_init(struct phy_device *phydev)\r\n{\r\nstruct dp83867_private *dp83867 = phydev->priv;\r\nstruct device *dev = &phydev->mdio.dev;\r\nstruct device_node *of_node = dev->of_node;\r\nint ret;\r\nif (!of_node)\r\nreturn -ENODEV;\r\ndp83867->io_impedance = -EINVAL;\r\nif (of_property_read_bool(of_node, "ti,max-output-impedance"))\r\ndp83867->io_impedance = DP83867_IO_MUX_CFG_IO_IMPEDANCE_MAX;\r\nelse if (of_property_read_bool(of_node, "ti,min-output-impedance"))\r\ndp83867->io_impedance = DP83867_IO_MUX_CFG_IO_IMPEDANCE_MIN;\r\ndp83867->rxctrl_strap_quirk = of_property_read_bool(of_node,\r\n"ti,dp83867-rxctrl-strap-quirk");\r\nret = of_property_read_u32(of_node, "ti,rx-internal-delay",\r\n&dp83867->rx_id_delay);\r\nif (ret &&\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_ID ||\r\nphydev->interface == PHY_INTERFACE_MODE_RGMII_RXID))\r\nreturn ret;\r\nret = of_property_read_u32(of_node, "ti,tx-internal-delay",\r\n&dp83867->tx_id_delay);\r\nif (ret &&\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_ID ||\r\nphydev->interface == PHY_INTERFACE_MODE_RGMII_TXID))\r\nreturn ret;\r\nif (of_property_read_bool(of_node, "enet-phy-lane-swap"))\r\ndp83867->port_mirroring = DP83867_PORT_MIRROING_EN;\r\nif (of_property_read_bool(of_node, "enet-phy-lane-no-swap"))\r\ndp83867->port_mirroring = DP83867_PORT_MIRROING_DIS;\r\nreturn of_property_read_u32(of_node, "ti,fifo-depth",\r\n&dp83867->fifo_depth);\r\n}\r\nstatic int dp83867_of_init(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int dp83867_config_init(struct phy_device *phydev)\r\n{\r\nstruct dp83867_private *dp83867;\r\nint ret, val, bs;\r\nu16 delay;\r\nif (!phydev->priv) {\r\ndp83867 = devm_kzalloc(&phydev->mdio.dev, sizeof(*dp83867),\r\nGFP_KERNEL);\r\nif (!dp83867)\r\nreturn -ENOMEM;\r\nphydev->priv = dp83867;\r\nret = dp83867_of_init(phydev);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\ndp83867 = (struct dp83867_private *)phydev->priv;\r\n}\r\nif (dp83867->rxctrl_strap_quirk) {\r\nval = phy_read_mmd(phydev, DP83867_DEVADDR, DP83867_CFG4);\r\nval &= ~BIT(7);\r\nphy_write_mmd(phydev, DP83867_DEVADDR, DP83867_CFG4, val);\r\n}\r\nif (phy_interface_is_rgmii(phydev)) {\r\nval = phy_read(phydev, MII_DP83867_PHYCTRL);\r\nif (val < 0)\r\nreturn val;\r\nval &= ~DP83867_PHYCR_FIFO_DEPTH_MASK;\r\nval |= (dp83867->fifo_depth << DP83867_PHYCR_FIFO_DEPTH_SHIFT);\r\nbs = phy_read_mmd(phydev, DP83867_DEVADDR, DP83867_STRAP_STS1);\r\nif (bs & DP83867_STRAP_STS1_RESERVED)\r\nval &= ~DP83867_PHYCR_RESERVED_MASK;\r\nret = phy_write(phydev, MII_DP83867_PHYCTRL, val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((phydev->interface >= PHY_INTERFACE_MODE_RGMII_ID) &&\r\n(phydev->interface <= PHY_INTERFACE_MODE_RGMII_RXID)) {\r\nval = phy_read_mmd(phydev, DP83867_DEVADDR, DP83867_RGMIICTL);\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\r\nval |= (DP83867_RGMII_TX_CLK_DELAY_EN | DP83867_RGMII_RX_CLK_DELAY_EN);\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)\r\nval |= DP83867_RGMII_TX_CLK_DELAY_EN;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID)\r\nval |= DP83867_RGMII_RX_CLK_DELAY_EN;\r\nphy_write_mmd(phydev, DP83867_DEVADDR, DP83867_RGMIICTL, val);\r\ndelay = (dp83867->rx_id_delay |\r\n(dp83867->tx_id_delay << DP83867_RGMII_TX_CLK_DELAY_SHIFT));\r\nphy_write_mmd(phydev, DP83867_DEVADDR, DP83867_RGMIIDCTL,\r\ndelay);\r\nif (dp83867->io_impedance >= 0) {\r\nval = phy_read_mmd(phydev, DP83867_DEVADDR,\r\nDP83867_IO_MUX_CFG);\r\nval &= ~DP83867_IO_MUX_CFG_IO_IMPEDANCE_CTRL;\r\nval |= dp83867->io_impedance &\r\nDP83867_IO_MUX_CFG_IO_IMPEDANCE_CTRL;\r\nphy_write_mmd(phydev, DP83867_DEVADDR,\r\nDP83867_IO_MUX_CFG, val);\r\n}\r\n}\r\nif (phy_interrupt_is_valid(phydev)) {\r\nval = phy_read(phydev, DP83867_CFG3);\r\nval |= BIT(7);\r\nphy_write(phydev, DP83867_CFG3, val);\r\n}\r\nif (dp83867->port_mirroring != DP83867_PORT_MIRROING_KEEP)\r\ndp83867_config_port_mirroring(phydev);\r\nreturn 0;\r\n}\r\nstatic int dp83867_phy_reset(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, DP83867_CTRL, DP83867_SW_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreturn dp83867_config_init(phydev);\r\n}

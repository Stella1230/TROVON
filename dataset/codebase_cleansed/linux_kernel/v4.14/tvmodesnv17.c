static void tv_setup_filter(struct drm_encoder *encoder)\r\n{\r\nstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\r\nstruct nv17_tv_norm_params *tv_norm = get_tv_norm(encoder);\r\nstruct drm_display_mode *mode = &encoder->crtc->mode;\r\nuint32_t (*filters[])[4][7] = {&tv_enc->state.hfilter,\r\n&tv_enc->state.vfilter};\r\nint i, j, k;\r\nint32_t overscan = calc_overscan(tv_enc->overscan);\r\nint64_t flicker = (tv_enc->flicker - 50) * (id3 / 100);\r\nuint64_t rs[] = {mode->hdisplay * id3,\r\nmode->vdisplay * id3};\r\ndo_div(rs[0], overscan * tv_norm->tv_enc_mode.hdisplay);\r\ndo_div(rs[1], overscan * tv_norm->tv_enc_mode.vdisplay);\r\nfor (k = 0; k < 2; k++) {\r\nrs[k] = max((int64_t)rs[k], id2);\r\nfor (j = 0; j < 4; j++) {\r\nstruct filter_params *p = &fparams[k][j];\r\nfor (i = 0; i < 7; i++) {\r\nint64_t c = (p->k1 + p->ki*i + p->ki2*i*i +\r\np->ki3*i*i*i)\r\n+ (p->kr + p->kir*i + p->ki2r*i*i +\r\np->ki3r*i*i*i) * rs[k]\r\n+ (p->kf + p->kif*i + p->ki2f*i*i +\r\np->ki3f*i*i*i) * flicker\r\n+ (p->krf + p->kirf*i + p->ki2rf*i*i +\r\np->ki3rf*i*i*i) * flicker * rs[k];\r\n(*filters[k])[j][i] = (c + id5/2) >> 39\r\n& (0x1 << 31 | 0x7f << 9);\r\n}\r\n}\r\n}\r\n}\r\nstatic void tv_save_filter(struct drm_device *dev, uint32_t base,\r\nuint32_t regs[4][7])\r\n{\r\nint i, j;\r\nuint32_t offsets[] = { base, base + 0x1c, base + 0x40, base + 0x5c };\r\nfor (i = 0; i < 4; i++) {\r\nfor (j = 0; j < 7; j++)\r\nregs[i][j] = nv_read_ptv(dev, offsets[i]+4*j);\r\n}\r\n}\r\nstatic void tv_load_filter(struct drm_device *dev, uint32_t base,\r\nuint32_t regs[4][7])\r\n{\r\nint i, j;\r\nuint32_t offsets[] = { base, base + 0x1c, base + 0x40, base + 0x5c };\r\nfor (i = 0; i < 4; i++) {\r\nfor (j = 0; j < 7; j++)\r\nnv_write_ptv(dev, offsets[i]+4*j, regs[i][j]);\r\n}\r\n}\r\nvoid nv17_tv_state_save(struct drm_device *dev, struct nv17_tv_state *state)\r\n{\r\nint i;\r\nfor (i = 0; i < 0x40; i++)\r\nstate->tv_enc[i] = nv_read_tv_enc(dev, i);\r\ntv_save_filter(dev, NV_PTV_HFILTER, state->hfilter);\r\ntv_save_filter(dev, NV_PTV_HFILTER2, state->hfilter2);\r\ntv_save_filter(dev, NV_PTV_VFILTER, state->vfilter);\r\nnv_save_ptv(dev, state, 200);\r\nnv_save_ptv(dev, state, 204);\r\nnv_save_ptv(dev, state, 208);\r\nnv_save_ptv(dev, state, 20c);\r\nnv_save_ptv(dev, state, 304);\r\nnv_save_ptv(dev, state, 500);\r\nnv_save_ptv(dev, state, 504);\r\nnv_save_ptv(dev, state, 508);\r\nnv_save_ptv(dev, state, 600);\r\nnv_save_ptv(dev, state, 604);\r\nnv_save_ptv(dev, state, 608);\r\nnv_save_ptv(dev, state, 60c);\r\nnv_save_ptv(dev, state, 610);\r\nnv_save_ptv(dev, state, 614);\r\n}\r\nvoid nv17_tv_state_load(struct drm_device *dev, struct nv17_tv_state *state)\r\n{\r\nint i;\r\nfor (i = 0; i < 0x40; i++)\r\nnv_write_tv_enc(dev, i, state->tv_enc[i]);\r\ntv_load_filter(dev, NV_PTV_HFILTER, state->hfilter);\r\ntv_load_filter(dev, NV_PTV_HFILTER2, state->hfilter2);\r\ntv_load_filter(dev, NV_PTV_VFILTER, state->vfilter);\r\nnv_load_ptv(dev, state, 200);\r\nnv_load_ptv(dev, state, 204);\r\nnv_load_ptv(dev, state, 208);\r\nnv_load_ptv(dev, state, 20c);\r\nnv_load_ptv(dev, state, 304);\r\nnv_load_ptv(dev, state, 500);\r\nnv_load_ptv(dev, state, 504);\r\nnv_load_ptv(dev, state, 508);\r\nnv_load_ptv(dev, state, 600);\r\nnv_load_ptv(dev, state, 604);\r\nnv_load_ptv(dev, state, 608);\r\nnv_load_ptv(dev, state, 60c);\r\nnv_load_ptv(dev, state, 610);\r\nnv_load_ptv(dev, state, 614);\r\nnv_write_tv_enc(dev, 0x3e, 1);\r\nnv_write_tv_enc(dev, 0x3e, 0);\r\n}\r\nvoid nv17_tv_update_properties(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\r\nstruct nv17_tv_state *regs = &tv_enc->state;\r\nstruct nv17_tv_norm_params *tv_norm = get_tv_norm(encoder);\r\nint subconnector = tv_enc->select_subconnector ?\r\ntv_enc->select_subconnector :\r\ntv_enc->subconnector;\r\nswitch (subconnector) {\r\ncase DRM_MODE_SUBCONNECTOR_Composite:\r\n{\r\nregs->ptv_204 = 0x2;\r\nif (tv_enc->pin_mask & 0x4)\r\nregs->ptv_204 |= 0x010000;\r\nelse if (tv_enc->pin_mask & 0x2)\r\nregs->ptv_204 |= 0x100000;\r\nelse\r\nregs->ptv_204 |= 0x110000;\r\nregs->tv_enc[0x7] = 0x10;\r\nbreak;\r\n}\r\ncase DRM_MODE_SUBCONNECTOR_SVIDEO:\r\nregs->ptv_204 = 0x11012;\r\nregs->tv_enc[0x7] = 0x18;\r\nbreak;\r\ncase DRM_MODE_SUBCONNECTOR_Component:\r\nregs->ptv_204 = 0x111333;\r\nregs->tv_enc[0x7] = 0x14;\r\nbreak;\r\ncase DRM_MODE_SUBCONNECTOR_SCART:\r\nregs->ptv_204 = 0x111012;\r\nregs->tv_enc[0x7] = 0x18;\r\nbreak;\r\n}\r\nregs->tv_enc[0x20] = interpolate(0, tv_norm->tv_enc_mode.tv_enc[0x20],\r\n255, tv_enc->saturation);\r\nregs->tv_enc[0x22] = interpolate(0, tv_norm->tv_enc_mode.tv_enc[0x22],\r\n255, tv_enc->saturation);\r\nregs->tv_enc[0x25] = tv_enc->hue * 255 / 100;\r\nnv_load_ptv(dev, regs, 204);\r\nnv_load_tv_enc(dev, regs, 7);\r\nnv_load_tv_enc(dev, regs, 20);\r\nnv_load_tv_enc(dev, regs, 22);\r\nnv_load_tv_enc(dev, regs, 25);\r\n}\r\nvoid nv17_tv_update_rescaler(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\r\nstruct nv17_tv_state *regs = &tv_enc->state;\r\nregs->ptv_208 = 0x40 | (calc_overscan(tv_enc->overscan) << 8);\r\ntv_setup_filter(encoder);\r\nnv_load_ptv(dev, regs, 208);\r\ntv_load_filter(dev, NV_PTV_HFILTER, regs->hfilter);\r\ntv_load_filter(dev, NV_PTV_HFILTER2, regs->hfilter2);\r\ntv_load_filter(dev, NV_PTV_VFILTER, regs->vfilter);\r\n}\r\nvoid nv17_ctv_update_rescaler(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\r\nint head = nouveau_crtc(encoder->crtc)->index;\r\nstruct nv04_crtc_reg *regs = &nv04_display(dev)->mode_reg.crtc_reg[head];\r\nstruct drm_display_mode *crtc_mode = &encoder->crtc->mode;\r\nstruct drm_display_mode *output_mode =\r\n&get_tv_norm(encoder)->ctv_enc_mode.mode;\r\nint overscan, hmargin, vmargin, hratio, vratio;\r\nif (output_mode->flags & DRM_MODE_FLAG_INTERLACE)\r\noverscan = 100;\r\nelse\r\noverscan = tv_enc->overscan;\r\nhmargin = (output_mode->hdisplay - crtc_mode->hdisplay) / 2;\r\nvmargin = (output_mode->vdisplay - crtc_mode->vdisplay) / 2;\r\nhmargin = interpolate(0, min(hmargin, output_mode->hdisplay/20),\r\nhmargin, overscan);\r\nvmargin = interpolate(0, min(vmargin, output_mode->vdisplay/20),\r\nvmargin, overscan);\r\nhratio = crtc_mode->hdisplay * 0x800 /\r\n(output_mode->hdisplay - 2*hmargin);\r\nvratio = crtc_mode->vdisplay * 0x800 /\r\n(output_mode->vdisplay - 2*vmargin) & ~3;\r\nregs->fp_horiz_regs[FP_VALID_START] = hmargin;\r\nregs->fp_horiz_regs[FP_VALID_END] = output_mode->hdisplay - hmargin - 1;\r\nregs->fp_vert_regs[FP_VALID_START] = vmargin;\r\nregs->fp_vert_regs[FP_VALID_END] = output_mode->vdisplay - vmargin - 1;\r\nregs->fp_debug_1 = NV_PRAMDAC_FP_DEBUG_1_YSCALE_TESTMODE_ENABLE |\r\nXLATE(vratio, 0, NV_PRAMDAC_FP_DEBUG_1_YSCALE_VALUE) |\r\nNV_PRAMDAC_FP_DEBUG_1_XSCALE_TESTMODE_ENABLE |\r\nXLATE(hratio, 0, NV_PRAMDAC_FP_DEBUG_1_XSCALE_VALUE);\r\nNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_HVALID_START,\r\nregs->fp_horiz_regs[FP_VALID_START]);\r\nNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_HVALID_END,\r\nregs->fp_horiz_regs[FP_VALID_END]);\r\nNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_VVALID_START,\r\nregs->fp_vert_regs[FP_VALID_START]);\r\nNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_VVALID_END,\r\nregs->fp_vert_regs[FP_VALID_END]);\r\nNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_DEBUG_1, regs->fp_debug_1);\r\n}

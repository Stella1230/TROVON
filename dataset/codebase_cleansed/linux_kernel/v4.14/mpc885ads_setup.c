static void __init init_ioports(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mpc885ads_pins); i++) {\r\nstruct cpm_pin *pin = &mpc885ads_pins[i];\r\ncpm1_set_pin(pin->port, pin->pin, pin->flags);\r\n}\r\ncpm1_clk_setup(CPM_CLK_SMC1, CPM_BRG1, CPM_CLK_RTX);\r\ncpm1_clk_setup(CPM_CLK_SMC2, CPM_BRG2, CPM_CLK_RTX);\r\ncpm1_clk_setup(CPM_CLK_SCC3, CPM_CLK5, CPM_CLK_TX);\r\ncpm1_clk_setup(CPM_CLK_SCC3, CPM_CLK6, CPM_CLK_RX);\r\nclrbits32(&mpc8xx_immr->im_cpm.cp_cptr, 0x00000180);\r\n}\r\nstatic void __init mpc885ads_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\ncpm_reset();\r\ninit_ioports();\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,mpc885ads-bcsr");\r\nif (!np) {\r\nprintk(KERN_CRIT "Could not find fsl,mpc885ads-bcsr node\n");\r\nreturn;\r\n}\r\nbcsr = of_iomap(np, 0);\r\nbcsr5 = of_iomap(np, 1);\r\nof_node_put(np);\r\nif (!bcsr || !bcsr5) {\r\nprintk(KERN_CRIT "Could not remap BCSR\n");\r\nreturn;\r\n}\r\nclrbits32(&bcsr[1], BCSR1_RS232EN_1);\r\n#ifdef CONFIG_MPC8xx_SECOND_ETH_FEC2\r\nsetbits32(&bcsr[1], BCSR1_RS232EN_2);\r\n#else\r\nclrbits32(&bcsr[1], BCSR1_RS232EN_2);\r\n#endif\r\nclrbits32(bcsr5, BCSR5_MII1_EN);\r\nsetbits32(bcsr5, BCSR5_MII1_RST);\r\nudelay(1000);\r\nclrbits32(bcsr5, BCSR5_MII1_RST);\r\n#ifdef CONFIG_MPC8xx_SECOND_ETH_FEC2\r\nclrbits32(bcsr5, BCSR5_MII2_EN);\r\nsetbits32(bcsr5, BCSR5_MII2_RST);\r\nudelay(1000);\r\nclrbits32(bcsr5, BCSR5_MII2_RST);\r\n#else\r\nsetbits32(bcsr5, BCSR5_MII2_EN);\r\n#endif\r\n#ifdef CONFIG_MPC8xx_SECOND_ETH_SCC3\r\nclrbits32(&bcsr[4], BCSR4_ETH10_RST);\r\nudelay(1000);\r\nsetbits32(&bcsr[4], BCSR4_ETH10_RST);\r\nsetbits32(&bcsr[1], BCSR1_ETHEN);\r\nnp = of_find_node_by_path("/soc@ff000000/cpm@9c0/serial@a80");\r\n#else\r\nnp = of_find_node_by_path("/soc@ff000000/cpm@9c0/ethernet@a40");\r\n#endif\r\nif (np) {\r\nof_detach_node(np);\r\nof_node_put(np);\r\n}\r\n}\r\nstatic int __init mpc885ads_probe(void)\r\n{\r\nreturn of_machine_is_compatible("fsl,mpc885ads");\r\n}\r\nstatic int __init declare_of_platform_devices(void)\r\n{\r\nof_platform_bus_probe(NULL, of_bus_ids, NULL);\r\nreturn 0;\r\n}

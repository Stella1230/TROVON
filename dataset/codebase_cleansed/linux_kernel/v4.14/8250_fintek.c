static u8 sio_read_reg(struct fintek_8250 *pdata, u8 reg)\r\n{\r\noutb(reg, pdata->base_port + ADDR_PORT);\r\nreturn inb(pdata->base_port + DATA_PORT);\r\n}\r\nstatic void sio_write_reg(struct fintek_8250 *pdata, u8 reg, u8 data)\r\n{\r\noutb(reg, pdata->base_port + ADDR_PORT);\r\noutb(data, pdata->base_port + DATA_PORT);\r\n}\r\nstatic void sio_write_mask_reg(struct fintek_8250 *pdata, u8 reg, u8 mask,\r\nu8 data)\r\n{\r\nu8 tmp;\r\ntmp = (sio_read_reg(pdata, reg) & ~mask) | (mask & data);\r\nsio_write_reg(pdata, reg, tmp);\r\n}\r\nstatic int fintek_8250_enter_key(u16 base_port, u8 key)\r\n{\r\nif (!request_muxed_region(base_port, 2, "8250_fintek"))\r\nreturn -EBUSY;\r\noutb(key, base_port + ADDR_PORT);\r\noutb(key, base_port + ADDR_PORT);\r\nreturn 0;\r\n}\r\nstatic void fintek_8250_exit_key(u16 base_port)\r\n{\r\noutb(EXIT_KEY, base_port + ADDR_PORT);\r\nrelease_region(base_port + ADDR_PORT, 2);\r\n}\r\nstatic int fintek_8250_check_id(struct fintek_8250 *pdata)\r\n{\r\nu16 chip;\r\nif (sio_read_reg(pdata, VENDOR_ID1) != VENDOR_ID1_VAL)\r\nreturn -ENODEV;\r\nif (sio_read_reg(pdata, VENDOR_ID2) != VENDOR_ID2_VAL)\r\nreturn -ENODEV;\r\nchip = sio_read_reg(pdata, CHIP_ID1);\r\nchip |= sio_read_reg(pdata, CHIP_ID2) << 8;\r\nswitch (chip) {\r\ncase CHIP_ID_F81865:\r\ncase CHIP_ID_F81866:\r\ncase CHIP_ID_F81216AD:\r\ncase CHIP_ID_F81216H:\r\ncase CHIP_ID_F81216:\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\npdata->pid = chip;\r\nreturn 0;\r\n}\r\nstatic int fintek_8250_get_ldn_range(struct fintek_8250 *pdata, int *min,\r\nint *max)\r\n{\r\nswitch (pdata->pid) {\r\ncase CHIP_ID_F81865:\r\ncase CHIP_ID_F81866:\r\n*min = F81866_LDN_LOW;\r\n*max = F81866_LDN_HIGH;\r\nreturn 0;\r\ncase CHIP_ID_F81216AD:\r\ncase CHIP_ID_F81216H:\r\ncase CHIP_ID_F81216:\r\n*min = F81216_LDN_LOW;\r\n*max = F81216_LDN_HIGH;\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int fintek_8250_rs485_config(struct uart_port *port,\r\nstruct serial_rs485 *rs485)\r\n{\r\nuint8_t config = 0;\r\nstruct fintek_8250 *pdata = port->private_data;\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (rs485->flags & SER_RS485_ENABLED)\r\nmemset(rs485->padding, 0, sizeof(rs485->padding));\r\nelse\r\nmemset(rs485, 0, sizeof(*rs485));\r\nrs485->flags &= SER_RS485_ENABLED | SER_RS485_RTS_ON_SEND |\r\nSER_RS485_RTS_AFTER_SEND;\r\nif (rs485->delay_rts_before_send) {\r\nrs485->delay_rts_before_send = 1;\r\nconfig |= TXW4C_IRA;\r\n}\r\nif (rs485->delay_rts_after_send) {\r\nrs485->delay_rts_after_send = 1;\r\nconfig |= RXW4C_IRA;\r\n}\r\nif ((!!(rs485->flags & SER_RS485_RTS_ON_SEND)) ==\r\n(!!(rs485->flags & SER_RS485_RTS_AFTER_SEND)))\r\nrs485->flags &= SER_RS485_ENABLED;\r\nelse\r\nconfig |= RS485_URA;\r\nif (rs485->flags & SER_RS485_RTS_ON_SEND)\r\nconfig |= RTS_INVERT;\r\nif (fintek_8250_enter_key(pdata->base_port, pdata->key))\r\nreturn -EBUSY;\r\nsio_write_reg(pdata, LDN, pdata->index);\r\nsio_write_reg(pdata, RS485, config);\r\nfintek_8250_exit_key(pdata->base_port);\r\nport->rs485 = *rs485;\r\nreturn 0;\r\n}\r\nstatic void fintek_8250_set_irq_mode(struct fintek_8250 *pdata, bool is_level)\r\n{\r\nsio_write_reg(pdata, LDN, pdata->index);\r\nswitch (pdata->pid) {\r\ncase CHIP_ID_F81866:\r\nsio_write_mask_reg(pdata, F81866_FIFO_CTRL, F81866_IRQ_MODE1,\r\n0);\r\ncase CHIP_ID_F81865:\r\nsio_write_mask_reg(pdata, F81866_IRQ_MODE, F81866_IRQ_SHARE,\r\nF81866_IRQ_SHARE);\r\nsio_write_mask_reg(pdata, F81866_IRQ_MODE, F81866_IRQ_MODE0,\r\nis_level ? 0 : F81866_IRQ_MODE0);\r\nbreak;\r\ncase CHIP_ID_F81216AD:\r\ncase CHIP_ID_F81216H:\r\ncase CHIP_ID_F81216:\r\nsio_write_mask_reg(pdata, FINTEK_IRQ_MODE, IRQ_SHARE,\r\nIRQ_SHARE);\r\nsio_write_mask_reg(pdata, FINTEK_IRQ_MODE, IRQ_MODE_MASK,\r\nis_level ? IRQ_LEVEL_LOW : IRQ_EDGE_HIGH);\r\nbreak;\r\n}\r\n}\r\nstatic void fintek_8250_set_max_fifo(struct fintek_8250 *pdata)\r\n{\r\nswitch (pdata->pid) {\r\ncase CHIP_ID_F81216H:\r\ncase CHIP_ID_F81866:\r\nsio_write_mask_reg(pdata, FIFO_CTRL,\r\nFIFO_MODE_MASK | RXFTHR_MODE_MASK,\r\nFIFO_MODE_128 | RXFTHR_MODE_4X);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void fintek_8250_goto_highspeed(struct uart_8250_port *uart,\r\nstruct fintek_8250 *pdata)\r\n{\r\nsio_write_reg(pdata, LDN, pdata->index);\r\nswitch (pdata->pid) {\r\ncase CHIP_ID_F81866:\r\nsio_write_mask_reg(pdata, F81866_UART_CLK,\r\nF81866_UART_CLK_MASK,\r\nF81866_UART_CLK_14_769MHZ);\r\nuart->port.uartclk = 921600 * 16;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int probe_setup_port(struct fintek_8250 *pdata,\r\nstruct uart_8250_port *uart)\r\n{\r\nstatic const u16 addr[] = {0x4e, 0x2e};\r\nstatic const u8 keys[] = {0x77, 0xa0, 0x87, 0x67};\r\nstruct irq_data *irq_data;\r\nbool level_mode = false;\r\nint i, j, k, min, max;\r\nfor (i = 0; i < ARRAY_SIZE(addr); i++) {\r\nfor (j = 0; j < ARRAY_SIZE(keys); j++) {\r\npdata->base_port = addr[i];\r\npdata->key = keys[j];\r\nif (fintek_8250_enter_key(addr[i], keys[j]))\r\ncontinue;\r\nif (fintek_8250_check_id(pdata) ||\r\nfintek_8250_get_ldn_range(pdata, &min, &max)) {\r\nfintek_8250_exit_key(addr[i]);\r\ncontinue;\r\n}\r\nfor (k = min; k < max; k++) {\r\nu16 aux;\r\nsio_write_reg(pdata, LDN, k);\r\naux = sio_read_reg(pdata, IO_ADDR1);\r\naux |= sio_read_reg(pdata, IO_ADDR2) << 8;\r\nif (aux != uart->port.iobase)\r\ncontinue;\r\npdata->index = k;\r\nirq_data = irq_get_irq_data(uart->port.irq);\r\nif (irq_data)\r\nlevel_mode =\r\nirqd_is_level_type(irq_data);\r\nfintek_8250_set_irq_mode(pdata, level_mode);\r\nfintek_8250_set_max_fifo(pdata);\r\nfintek_8250_goto_highspeed(uart, pdata);\r\nfintek_8250_exit_key(addr[i]);\r\nreturn 0;\r\n}\r\nfintek_8250_exit_key(addr[i]);\r\n}\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic void fintek_8250_set_rs485_handler(struct uart_8250_port *uart)\r\n{\r\nstruct fintek_8250 *pdata = uart->port.private_data;\r\nswitch (pdata->pid) {\r\ncase CHIP_ID_F81216AD:\r\ncase CHIP_ID_F81216H:\r\ncase CHIP_ID_F81866:\r\ncase CHIP_ID_F81865:\r\nuart->port.rs485_config = fintek_8250_rs485_config;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint fintek_8250_probe(struct uart_8250_port *uart)\r\n{\r\nstruct fintek_8250 *pdata;\r\nstruct fintek_8250 probe_data;\r\nif (probe_setup_port(&probe_data, uart))\r\nreturn -ENODEV;\r\npdata = devm_kzalloc(uart->port.dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nmemcpy(pdata, &probe_data, sizeof(probe_data));\r\nuart->port.private_data = pdata;\r\nfintek_8250_set_rs485_handler(uart);\r\nreturn 0;\r\n}

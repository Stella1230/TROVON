static inline int pistachio_reset_shift(unsigned long id)\r\n{\r\nswitch (id) {\r\ncase PISTACHIO_RESET_I2C0:\r\ncase PISTACHIO_RESET_I2C1:\r\ncase PISTACHIO_RESET_I2C2:\r\ncase PISTACHIO_RESET_I2C3:\r\ncase PISTACHIO_RESET_I2S_IN:\r\ncase PISTACHIO_RESET_PRL_OUT:\r\ncase PISTACHIO_RESET_SPDIF_OUT:\r\ncase PISTACHIO_RESET_SPI:\r\ncase PISTACHIO_RESET_PWM_PDM:\r\ncase PISTACHIO_RESET_UART0:\r\ncase PISTACHIO_RESET_UART1:\r\ncase PISTACHIO_RESET_QSPI:\r\ncase PISTACHIO_RESET_MDC:\r\ncase PISTACHIO_RESET_SDHOST:\r\ncase PISTACHIO_RESET_ETHERNET:\r\ncase PISTACHIO_RESET_IR:\r\ncase PISTACHIO_RESET_HASH:\r\ncase PISTACHIO_RESET_TIMER:\r\nreturn id;\r\ncase PISTACHIO_RESET_I2S_OUT:\r\ncase PISTACHIO_RESET_SPDIF_IN:\r\ncase PISTACHIO_RESET_EVT:\r\nreturn id + 6;\r\ncase PISTACHIO_RESET_USB_H:\r\ncase PISTACHIO_RESET_USB_PR:\r\ncase PISTACHIO_RESET_USB_PHY_PR:\r\ncase PISTACHIO_RESET_USB_PHY_PON:\r\nreturn id + 7;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int pistachio_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct pistachio_reset_data *rd;\r\nu32 mask;\r\nint shift;\r\nrd = container_of(rcdev, struct pistachio_reset_data, rcdev);\r\nshift = pistachio_reset_shift(id);\r\nif (shift < 0)\r\nreturn shift;\r\nmask = BIT(shift);\r\nreturn regmap_update_bits(rd->periph_regs, PISTACHIO_SOFT_RESET,\r\nmask, mask);\r\n}\r\nstatic int pistachio_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct pistachio_reset_data *rd;\r\nu32 mask;\r\nint shift;\r\nrd = container_of(rcdev, struct pistachio_reset_data, rcdev);\r\nshift = pistachio_reset_shift(id);\r\nif (shift < 0)\r\nreturn shift;\r\nmask = BIT(shift);\r\nreturn regmap_update_bits(rd->periph_regs, PISTACHIO_SOFT_RESET,\r\nmask, 0);\r\n}\r\nstatic int pistachio_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct pistachio_reset_data *rd;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = pdev->dev.of_node;\r\nrd = devm_kzalloc(dev, sizeof(*rd), GFP_KERNEL);\r\nif (!rd)\r\nreturn -ENOMEM;\r\nrd->periph_regs = syscon_node_to_regmap(np->parent);\r\nif (IS_ERR(rd->periph_regs))\r\nreturn PTR_ERR(rd->periph_regs);\r\nrd->rcdev.owner = THIS_MODULE;\r\nrd->rcdev.nr_resets = PISTACHIO_RESET_MAX + 1;\r\nrd->rcdev.ops = &pistachio_reset_ops;\r\nrd->rcdev.of_node = np;\r\nreturn devm_reset_controller_register(dev, &rd->rcdev);\r\n}

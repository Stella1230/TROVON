static u8 rockchip_muxgrf_get_parent(struct clk_hw *hw)\r\n{\r\nstruct rockchip_muxgrf_clock *mux = to_muxgrf_clock(hw);\r\nunsigned int mask = GENMASK(mux->width - 1, 0);\r\nunsigned int val;\r\nregmap_read(mux->regmap, mux->reg, &val);\r\nval >>= mux->shift;\r\nval &= mask;\r\nreturn val;\r\n}\r\nstatic int rockchip_muxgrf_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct rockchip_muxgrf_clock *mux = to_muxgrf_clock(hw);\r\nunsigned int mask = GENMASK(mux->width + mux->shift - 1, mux->shift);\r\nunsigned int val;\r\nval = index;\r\nval <<= mux->shift;\r\nif (mux->flags & CLK_MUX_HIWORD_MASK)\r\nreturn regmap_write(mux->regmap, mux->reg, val | (mask << 16));\r\nelse\r\nreturn regmap_update_bits(mux->regmap, mux->reg, mask, val);\r\n}\r\nstruct clk *rockchip_clk_register_muxgrf(const char *name,\r\nconst char *const *parent_names, u8 num_parents,\r\nint flags, struct regmap *regmap, int reg,\r\nint shift, int width, int mux_flags)\r\n{\r\nstruct rockchip_muxgrf_clock *muxgrf_clock;\r\nstruct clk_init_data init;\r\nstruct clk *clk;\r\nif (IS_ERR(regmap)) {\r\npr_err("%s: regmap not available\n", __func__);\r\nreturn ERR_PTR(-ENOTSUPP);\r\n}\r\nmuxgrf_clock = kmalloc(sizeof(*muxgrf_clock), GFP_KERNEL);\r\nif (!muxgrf_clock)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.flags = flags;\r\ninit.num_parents = num_parents;\r\ninit.parent_names = parent_names;\r\ninit.ops = &rockchip_muxgrf_clk_ops;\r\nmuxgrf_clock->hw.init = &init;\r\nmuxgrf_clock->regmap = regmap;\r\nmuxgrf_clock->reg = reg;\r\nmuxgrf_clock->shift = shift;\r\nmuxgrf_clock->width = width;\r\nmuxgrf_clock->flags = mux_flags;\r\nclk = clk_register(NULL, &muxgrf_clock->hw);\r\nif (IS_ERR(clk))\r\nkfree(muxgrf_clock);\r\nreturn clk;\r\n}

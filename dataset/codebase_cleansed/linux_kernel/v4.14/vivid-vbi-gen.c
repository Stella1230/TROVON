static void wss_insert(u8 *wss, u32 val, unsigned size)\r\n{\r\nwhile (size--)\r\n*wss++ = (val & (1 << size)) ? 0xc0 : 0x10;\r\n}\r\nstatic void vivid_vbi_gen_wss_raw(const struct v4l2_sliced_vbi_data *data,\r\nu8 *buf, unsigned sampling_rate)\r\n{\r\nconst unsigned rate = 5000000;\r\nu8 wss[29 + 24 + 24 + 24 + 18 + 18] = { 0 };\r\nconst unsigned zero = 0x07;\r\nconst unsigned one = 0x38;\r\nunsigned bit = 0;\r\nu16 wss_data;\r\nint i;\r\nwss_insert(wss + bit, 0x1f1c71c7, 29); bit += 29;\r\nwss_insert(wss + bit, 0x1e3c1f, 24); bit += 24;\r\nwss_data = (data->data[1] << 8) | data->data[0];\r\nfor (i = 0; i <= 13; i++, bit += 6)\r\nwss_insert(wss + bit, (wss_data & (1 << i)) ? one : zero, 6);\r\nfor (i = 0, bit = 0; bit < sizeof(wss); bit++) {\r\nunsigned n = ((bit + 1) * sampling_rate) / rate;\r\nwhile (i < n)\r\nbuf[i++] = wss[bit];\r\n}\r\n}\r\nstatic void vivid_vbi_gen_teletext_raw(const struct v4l2_sliced_vbi_data *data,\r\nu8 *buf, unsigned sampling_rate)\r\n{\r\nconst unsigned rate = 6937500 / 10;\r\nu8 teletext[45] = { 0x55, 0x55, 0x27 };\r\nunsigned bit = 0;\r\nint i;\r\nmemcpy(teletext + 3, data->data, sizeof(teletext) - 3);\r\nsampling_rate /= 10;\r\nfor (i = 0, bit = 0; bit < sizeof(teletext) * 8; bit++) {\r\nunsigned n = ((bit + 1) * sampling_rate) / rate;\r\nu8 val = (teletext[bit / 8] & (1 << (bit & 7))) ? 0xc0 : 0x10;\r\nwhile (i < n)\r\nbuf[i++] = val;\r\n}\r\n}\r\nstatic void cc_insert(u8 *cc, u8 ch)\r\n{\r\nunsigned tot = 0;\r\nunsigned i;\r\nfor (i = 0; i < 7; i++) {\r\ncc[2 * i] = cc[2 * i + 1] = (ch & (1 << i)) ? 1 : 0;\r\ntot += cc[2 * i];\r\n}\r\ncc[14] = cc[15] = !(tot & 1);\r\n}\r\nstatic void vivid_vbi_gen_cc_raw(const struct v4l2_sliced_vbi_data *data,\r\nu8 *buf, unsigned sampling_rate)\r\n{\r\nconst unsigned rate = 1000000;\r\nu8 cc[CC_PREAMBLE_BITS + 2 * 16] = {\r\n0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,\r\n0, 0, 0, 0,\r\n1, 1\r\n};\r\nunsigned bit, i;\r\ncc_insert(cc + CC_PREAMBLE_BITS, data->data[0]);\r\ncc_insert(cc + CC_PREAMBLE_BITS + 16, data->data[1]);\r\nfor (i = 0, bit = 0; bit < sizeof(cc); bit++) {\r\nunsigned n = ((bit + 1) * sampling_rate) / rate;\r\nwhile (i < n)\r\nbuf[i++] = cc[bit] ? 0xc0 : 0x10;\r\n}\r\n}\r\nvoid vivid_vbi_gen_raw(const struct vivid_vbi_gen_data *vbi,\r\nconst struct v4l2_vbi_format *vbi_fmt, u8 *buf)\r\n{\r\nunsigned idx;\r\nfor (idx = 0; idx < 25; idx++) {\r\nconst struct v4l2_sliced_vbi_data *data = vbi->data + idx;\r\nunsigned start_2nd_field;\r\nunsigned line = data->line;\r\nu8 *linebuf = buf;\r\nstart_2nd_field = (data->id & V4L2_SLICED_VBI_525) ? 263 : 313;\r\nif (data->field)\r\nline += start_2nd_field;\r\nline -= vbi_fmt->start[data->field];\r\nif (vbi_fmt->flags & V4L2_VBI_INTERLACED)\r\nlinebuf += (line * 2 + data->field) *\r\nvbi_fmt->samples_per_line;\r\nelse\r\nlinebuf += (line + data->field * vbi_fmt->count[0]) *\r\nvbi_fmt->samples_per_line;\r\nif (data->id == V4L2_SLICED_CAPTION_525)\r\nvivid_vbi_gen_cc_raw(data, linebuf, vbi_fmt->sampling_rate);\r\nelse if (data->id == V4L2_SLICED_WSS_625)\r\nvivid_vbi_gen_wss_raw(data, linebuf, vbi_fmt->sampling_rate);\r\nelse if (data->id == V4L2_SLICED_TELETEXT_B)\r\nvivid_vbi_gen_teletext_raw(data, linebuf, vbi_fmt->sampling_rate);\r\n}\r\n}\r\nstatic u8 calc_parity(u8 val)\r\n{\r\nunsigned i;\r\nunsigned tot = 0;\r\nfor (i = 0; i < 7; i++)\r\ntot += (val & (1 << i)) ? 1 : 0;\r\nreturn val | ((tot & 1) ? 0 : 0x80);\r\n}\r\nstatic void vivid_vbi_gen_set_time_of_day(u8 *packet)\r\n{\r\nstruct tm tm;\r\nu8 checksum, i;\r\ntime_to_tm(get_seconds(), 0, &tm);\r\npacket[0] = calc_parity(0x07);\r\npacket[1] = calc_parity(0x01);\r\npacket[2] = calc_parity(0x40 | tm.tm_min);\r\npacket[3] = calc_parity(0x40 | tm.tm_hour);\r\npacket[4] = calc_parity(0x40 | tm.tm_mday);\r\nif (tm.tm_mday == 1 && tm.tm_mon == 2 &&\r\nsys_tz.tz_minuteswest > tm.tm_min + tm.tm_hour * 60)\r\npacket[4] = calc_parity(0x60 | tm.tm_mday);\r\npacket[5] = calc_parity(0x40 | (1 + tm.tm_mon));\r\npacket[6] = calc_parity(0x40 | (1 + tm.tm_wday));\r\npacket[7] = calc_parity(0x40 | ((tm.tm_year - 90) & 0x3f));\r\npacket[8] = calc_parity(0x0f);\r\nfor (checksum = i = 0; i <= 8; i++)\r\nchecksum += packet[i] & 0x7f;\r\npacket[9] = calc_parity(0x100 - checksum);\r\nchecksum = 0;\r\npacket[10] = calc_parity(0x07);\r\npacket[11] = calc_parity(0x04);\r\nif (sys_tz.tz_minuteswest >= 0)\r\npacket[12] = calc_parity(0x40 | ((sys_tz.tz_minuteswest / 60) & 0x1f));\r\nelse\r\npacket[12] = calc_parity(0x40 | ((24 + sys_tz.tz_minuteswest / 60) & 0x1f));\r\npacket[13] = calc_parity(0);\r\npacket[14] = calc_parity(0x0f);\r\nfor (checksum = 0, i = 10; i <= 14; i++)\r\nchecksum += packet[i] & 0x7f;\r\npacket[15] = calc_parity(0x100 - checksum);\r\n}\r\nstatic void vivid_vbi_gen_teletext(u8 *packet, unsigned line, unsigned frame)\r\n{\r\nunsigned offset = 2;\r\nunsigned i;\r\npacket[0] = hamming[1 + ((line & 1) << 3)];\r\npacket[1] = hamming[line >> 1];\r\nmemset(packet + 2, 0x20, 40);\r\nif (line == 0) {\r\npacket[2] = hamming[frame % 10];\r\npacket[3] = hamming[frame / 10];\r\npacket[4] = hamming[0];\r\npacket[5] = hamming[0];\r\npacket[6] = hamming[0];\r\npacket[7] = hamming[0];\r\npacket[8] = hamming[0];\r\npacket[9] = hamming[1];\r\noffset = 10;\r\n}\r\npacket += offset;\r\nmemcpy(packet, "Page: 100 Row: 10", 17);\r\npacket[7] = '0' + frame / 10;\r\npacket[8] = '0' + frame % 10;\r\npacket[15] = '0' + line / 10;\r\npacket[16] = '0' + line % 10;\r\nfor (i = 0; i < 42 - offset; i++)\r\npacket[i] = calc_parity(packet[i]);\r\n}\r\nvoid vivid_vbi_gen_sliced(struct vivid_vbi_gen_data *vbi,\r\nbool is_60hz, unsigned seqnr)\r\n{\r\nstruct v4l2_sliced_vbi_data *data0 = vbi->data;\r\nstruct v4l2_sliced_vbi_data *data1 = vbi->data + 1;\r\nunsigned frame = seqnr % 60;\r\nmemset(vbi->data, 0, sizeof(vbi->data));\r\nif (!is_60hz) {\r\nunsigned i;\r\nfor (i = 0; i <= 11; i++) {\r\ndata0->id = V4L2_SLICED_TELETEXT_B;\r\ndata0->line = 7 + i;\r\nvivid_vbi_gen_teletext(data0->data, i, frame);\r\ndata0++;\r\n}\r\ndata0->id = V4L2_SLICED_WSS_625;\r\ndata0->line = 23;\r\ndata0->data[0] = 0x08;\r\ndata0++;\r\nfor (i = 0; i <= 11; i++) {\r\ndata0->id = V4L2_SLICED_TELETEXT_B;\r\ndata0->field = 1;\r\ndata0->line = 7 + i;\r\nvivid_vbi_gen_teletext(data0->data, 12 + i, frame);\r\ndata0++;\r\n}\r\nreturn;\r\n}\r\ndata0->id = V4L2_SLICED_CAPTION_525;\r\ndata0->line = 21;\r\ndata1->id = V4L2_SLICED_CAPTION_525;\r\ndata1->field = 1;\r\ndata1->line = 21;\r\nif (frame < 15) {\r\ndata0->data[0] = calc_parity(vivid_cc_sequence1[2 * frame]);\r\ndata0->data[1] = calc_parity(vivid_cc_sequence1[2 * frame + 1]);\r\n} else if (frame >= 30 && frame < 45) {\r\nframe -= 30;\r\ndata0->data[0] = calc_parity(vivid_cc_sequence2[2 * frame]);\r\ndata0->data[1] = calc_parity(vivid_cc_sequence2[2 * frame + 1]);\r\n} else {\r\ndata0->data[0] = calc_parity(0);\r\ndata0->data[1] = calc_parity(0);\r\n}\r\nframe = seqnr % (30 * 60);\r\nswitch (frame) {\r\ncase 0:\r\nvivid_vbi_gen_set_time_of_day(vbi->time_of_day_packet);\r\ncase 1 ... 7:\r\ndata1->data[0] = vbi->time_of_day_packet[frame * 2];\r\ndata1->data[1] = vbi->time_of_day_packet[frame * 2 + 1];\r\nbreak;\r\ndefault:\r\ndata1->data[0] = calc_parity(0);\r\ndata1->data[1] = calc_parity(0);\r\nbreak;\r\n}\r\n}

static int arizona_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct arizona_gpio *arizona_gpio = gpiochip_get_data(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nbool persistent = gpiochip_line_is_persistent(chip, offset);\r\nbool change;\r\nint ret;\r\nret = regmap_update_bits_check(arizona->regmap,\r\nARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_DIR, ARIZONA_GPN_DIR,\r\n&change);\r\nif (ret < 0)\r\nreturn ret;\r\nif (change && persistent) {\r\npm_runtime_mark_last_busy(chip->parent);\r\npm_runtime_put_autosuspend(chip->parent);\r\n}\r\nreturn 0;\r\n}\r\nstatic int arizona_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct arizona_gpio *arizona_gpio = gpiochip_get_data(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nunsigned int reg, val;\r\nint ret;\r\nreg = ARIZONA_GPIO1_CTRL + offset;\r\nret = regmap_read(arizona->regmap, reg, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val & ARIZONA_GPN_DIR) {\r\nret = pm_runtime_get_sync(chip->parent);\r\nif (ret < 0) {\r\ndev_err(chip->parent, "Failed to resume: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regcache_drop_region(arizona->regmap, reg, reg);\r\nif (ret < 0) {\r\ndev_err(chip->parent, "Failed to drop cache: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = regmap_read(arizona->regmap, reg, &val);\r\nif (ret < 0)\r\nreturn ret;\r\npm_runtime_mark_last_busy(chip->parent);\r\npm_runtime_put_autosuspend(chip->parent);\r\n}\r\nif (val & ARIZONA_GPN_LVL)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int arizona_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct arizona_gpio *arizona_gpio = gpiochip_get_data(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nbool persistent = gpiochip_line_is_persistent(chip, offset);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(arizona->regmap, ARIZONA_GPIO1_CTRL + offset, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif ((val & ARIZONA_GPN_DIR) && persistent) {\r\nret = pm_runtime_get_sync(chip->parent);\r\nif (ret < 0) {\r\ndev_err(chip->parent, "Failed to resume: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nif (value)\r\nvalue = ARIZONA_GPN_LVL;\r\nreturn regmap_update_bits(arizona->regmap, ARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_DIR | ARIZONA_GPN_LVL, value);\r\n}\r\nstatic void arizona_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct arizona_gpio *arizona_gpio = gpiochip_get_data(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nif (value)\r\nvalue = ARIZONA_GPN_LVL;\r\nregmap_update_bits(arizona->regmap, ARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_LVL, value);\r\n}\r\nstatic int arizona_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct arizona_pdata *pdata = dev_get_platdata(arizona->dev);\r\nstruct arizona_gpio *arizona_gpio;\r\nint ret;\r\narizona_gpio = devm_kzalloc(&pdev->dev, sizeof(*arizona_gpio),\r\nGFP_KERNEL);\r\nif (!arizona_gpio)\r\nreturn -ENOMEM;\r\narizona_gpio->arizona = arizona;\r\narizona_gpio->gpio_chip = template_chip;\r\narizona_gpio->gpio_chip.parent = &pdev->dev;\r\n#ifdef CONFIG_OF_GPIO\r\narizona_gpio->gpio_chip.of_node = arizona->dev->of_node;\r\n#endif\r\nswitch (arizona->type) {\r\ncase WM5102:\r\ncase WM5110:\r\ncase WM8280:\r\ncase WM8997:\r\ncase WM8998:\r\ncase WM1814:\r\narizona_gpio->gpio_chip.ngpio = 5;\r\nbreak;\r\ncase WM1831:\r\ncase CS47L24:\r\narizona_gpio->gpio_chip.ngpio = 2;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Unknown chip variant %d\n",\r\narizona->type);\r\nreturn -EINVAL;\r\n}\r\nif (pdata && pdata->gpio_base)\r\narizona_gpio->gpio_chip.base = pdata->gpio_base;\r\nelse\r\narizona_gpio->gpio_chip.base = -1;\r\npm_runtime_enable(&pdev->dev);\r\nret = devm_gpiochip_add_data(&pdev->dev, &arizona_gpio->gpio_chip,\r\narizona_gpio);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

static void\r\nproc_read_hw_info(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_bebob *bebob = entry->private_data;\r\nstruct hw_info *info;\r\ninfo = kzalloc(sizeof(struct hw_info), GFP_KERNEL);\r\nif (info == NULL)\r\nreturn;\r\nif (snd_bebob_read_block(bebob->unit, 0,\r\ninfo, sizeof(struct hw_info)) < 0)\r\ngoto end;\r\nsnd_iprintf(buffer, "Manufacturer:\t%.8s\n",\r\n(char *)&info->manufacturer);\r\nsnd_iprintf(buffer, "Protocol Ver:\t%d\n", info->protocol_ver);\r\nsnd_iprintf(buffer, "Build Ver:\t%d\n", info->bld_ver);\r\nsnd_iprintf(buffer, "GUID:\t\t0x%.8X%.8X\n",\r\ninfo->guid[0], info->guid[1]);\r\nsnd_iprintf(buffer, "Model ID:\t0x%02X\n", info->model_id);\r\nsnd_iprintf(buffer, "Model Rev:\t%d\n", info->model_rev);\r\nsnd_iprintf(buffer, "Firmware Date:\t%.8s\n", (char *)&info->fw_date);\r\nsnd_iprintf(buffer, "Firmware Time:\t%.8s\n", (char *)&info->fw_time);\r\nsnd_iprintf(buffer, "Firmware ID:\t0x%X\n", info->fw_id);\r\nsnd_iprintf(buffer, "Firmware Ver:\t%d\n", info->fw_ver);\r\nsnd_iprintf(buffer, "Base Addr:\t0x%X\n", info->base_addr);\r\nsnd_iprintf(buffer, "Max Size:\t%d\n", info->max_size);\r\nsnd_iprintf(buffer, "Loader Date:\t%.8s\n", (char *)&info->bld_date);\r\nsnd_iprintf(buffer, "Loader Time:\t%.8s\n", (char *)&info->bld_time);\r\nend:\r\nkfree(info);\r\n}\r\nstatic void\r\nproc_read_meters(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_bebob *bebob = entry->private_data;\r\nconst struct snd_bebob_meter_spec *spec = bebob->spec->meter;\r\nu32 *buf;\r\nunsigned int i, c, channels, size;\r\nif (spec == NULL)\r\nreturn;\r\nchannels = spec->num * 2;\r\nsize = channels * sizeof(u32);\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn;\r\nif (spec->get(bebob, buf, size) < 0)\r\ngoto end;\r\nfor (i = 0, c = 1; i < channels; i++) {\r\nsnd_iprintf(buffer, "%s %d:\t%d\n",\r\nspec->labels[i / 2], c++, buf[i]);\r\nif ((i + 1 < channels - 1) &&\r\n(strcmp(spec->labels[i / 2],\r\nspec->labels[(i + 1) / 2]) != 0))\r\nc = 1;\r\n}\r\nend:\r\nkfree(buf);\r\n}\r\nstatic void\r\nproc_read_formation(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_bebob *bebob = entry->private_data;\r\nstruct snd_bebob_stream_formation *formation;\r\nunsigned int i;\r\nsnd_iprintf(buffer, "Output Stream from device:\n");\r\nsnd_iprintf(buffer, "\tRate\tPCM\tMIDI\n");\r\nformation = bebob->tx_stream_formations;\r\nfor (i = 0; i < SND_BEBOB_STRM_FMT_ENTRIES; i++) {\r\nsnd_iprintf(buffer,\r\n"\t%d\t%d\t%d\n", snd_bebob_rate_table[i],\r\nformation[i].pcm, formation[i].midi);\r\n}\r\nsnd_iprintf(buffer, "Input Stream to device:\n");\r\nsnd_iprintf(buffer, "\tRate\tPCM\tMIDI\n");\r\nformation = bebob->rx_stream_formations;\r\nfor (i = 0; i < SND_BEBOB_STRM_FMT_ENTRIES; i++) {\r\nsnd_iprintf(buffer,\r\n"\t%d\t%d\t%d\n", snd_bebob_rate_table[i],\r\nformation[i].pcm, formation[i].midi);\r\n}\r\n}\r\nstatic void\r\nproc_read_clock(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstatic const char *const clk_labels[] = {\r\n"Internal",\r\n"External",\r\n"SYT-Match",\r\n};\r\nstruct snd_bebob *bebob = entry->private_data;\r\nconst struct snd_bebob_rate_spec *rate_spec = bebob->spec->rate;\r\nconst struct snd_bebob_clock_spec *clk_spec = bebob->spec->clock;\r\nenum snd_bebob_clock_type src;\r\nunsigned int rate;\r\nif (rate_spec->get(bebob, &rate) >= 0)\r\nsnd_iprintf(buffer, "Sampling rate: %d\n", rate);\r\nif (snd_bebob_stream_get_clock_src(bebob, &src) >= 0) {\r\nif (clk_spec)\r\nsnd_iprintf(buffer, "Clock Source: %s\n",\r\nclk_labels[src]);\r\nelse\r\nsnd_iprintf(buffer, "Clock Source: %s (MSU-dest: %d)\n",\r\nclk_labels[src], bebob->sync_input_plug);\r\n}\r\n}\r\nstatic void\r\nadd_node(struct snd_bebob *bebob, struct snd_info_entry *root, const char *name,\r\nvoid (*op)(struct snd_info_entry *e, struct snd_info_buffer *b))\r\n{\r\nstruct snd_info_entry *entry;\r\nentry = snd_info_create_card_entry(bebob->card, name, root);\r\nif (entry == NULL)\r\nreturn;\r\nsnd_info_set_text_ops(entry, bebob, op);\r\nif (snd_info_register(entry) < 0)\r\nsnd_info_free_entry(entry);\r\n}\r\nvoid snd_bebob_proc_init(struct snd_bebob *bebob)\r\n{\r\nstruct snd_info_entry *root;\r\nroot = snd_info_create_card_entry(bebob->card, "firewire",\r\nbebob->card->proc_root);\r\nif (root == NULL)\r\nreturn;\r\nroot->mode = S_IFDIR | S_IRUGO | S_IXUGO;\r\nif (snd_info_register(root) < 0) {\r\nsnd_info_free_entry(root);\r\nreturn;\r\n}\r\nadd_node(bebob, root, "clock", proc_read_clock);\r\nadd_node(bebob, root, "firmware", proc_read_hw_info);\r\nadd_node(bebob, root, "formation", proc_read_formation);\r\nif (bebob->spec->meter != NULL)\r\nadd_node(bebob, root, "meter", proc_read_meters);\r\n}

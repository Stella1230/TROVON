static struct ia_css_dvs_6axis_config *\r\nalloc_dvs_6axis_table(const struct ia_css_resolution *frame_res, struct ia_css_dvs_6axis_config *dvs_config_src)\r\n{\r\nunsigned int width_y = 0;\r\nunsigned int height_y = 0;\r\nunsigned int width_uv = 0;\r\nunsigned int height_uv = 0;\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nstruct ia_css_dvs_6axis_config *dvs_config = NULL;\r\ndvs_config = (struct ia_css_dvs_6axis_config *)sh_css_malloc(sizeof(struct ia_css_dvs_6axis_config));\r\nif (dvs_config == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nelse\r\n{\r\nif (NULL != dvs_config_src) {\r\ndvs_config->width_y = width_y = dvs_config_src->width_y;\r\ndvs_config->height_y = height_y = dvs_config_src->height_y;\r\ndvs_config->width_uv = width_uv = dvs_config_src->width_uv;\r\ndvs_config->height_uv = height_uv = dvs_config_src->height_uv;\r\nIA_CSS_LOG("alloc_dvs_6axis_table Y: W %d H %d", width_y, height_y);\r\n}\r\nelse if (NULL != frame_res) {\r\ndvs_config->width_y = width_y = DVS_TABLE_IN_BLOCKDIM_X_LUMA(frame_res->width);\r\ndvs_config->height_y = height_y = DVS_TABLE_IN_BLOCKDIM_Y_LUMA(frame_res->height);\r\ndvs_config->width_uv = width_uv = DVS_TABLE_IN_BLOCKDIM_X_CHROMA(frame_res->width / 2);\r\ndvs_config->height_uv = height_uv = DVS_TABLE_IN_BLOCKDIM_Y_CHROMA(frame_res->height / 2);\r\nIA_CSS_LOG("alloc_dvs_6axis_table Y: W %d H %d", width_y, height_y);\r\n}\r\ndvs_config->xcoords_y = (uint32_t *)sh_css_malloc(width_y * height_y * sizeof(uint32_t));\r\nif (dvs_config->xcoords_y == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngoto exit;\r\n}\r\ndvs_config->ycoords_y = (uint32_t *)sh_css_malloc(width_y * height_y * sizeof(uint32_t));\r\nif (dvs_config->ycoords_y == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngoto exit;\r\n}\r\nIA_CSS_LOG("UV W %d H %d", width_uv, height_uv);\r\ndvs_config->xcoords_uv = (uint32_t *)sh_css_malloc(width_uv * height_uv * sizeof(uint32_t));\r\nif (dvs_config->xcoords_uv == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngoto exit;\r\n}\r\ndvs_config->ycoords_uv = (uint32_t *)sh_css_malloc(width_uv * height_uv * sizeof(uint32_t));\r\nif (dvs_config->ycoords_uv == NULL) {\r\nIA_CSS_ERROR("out of memory");\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\n}\r\nexit:\r\nif (err != IA_CSS_SUCCESS) {\r\nfree_dvs_6axis_table(&dvs_config);\r\ndvs_config = NULL;\r\n}\r\n}\r\nIA_CSS_LEAVE("dvs_config=%p", dvs_config);\r\nreturn dvs_config;\r\n}\r\nstatic void\r\ninit_dvs_6axis_table_from_default(struct ia_css_dvs_6axis_config *dvs_config, const struct ia_css_resolution *dvs_offset)\r\n{\r\nunsigned int x, y;\r\nunsigned int width_y = dvs_config->width_y;\r\nunsigned int height_y = dvs_config->height_y;\r\nunsigned int width_uv = dvs_config->width_uv;\r\nunsigned int height_uv = dvs_config->height_uv;\r\nIA_CSS_LOG("Env_X=%d, Env_Y=%d, width_y=%d, height_y=%d",\r\ndvs_offset->width, dvs_offset->height, width_y, height_y);\r\nfor (y = 0; y < height_y; y++) {\r\nfor (x = 0; x < width_y; x++) {\r\ndvs_config->xcoords_y[y*width_y + x] = (dvs_offset->width + x*DVS_BLOCKDIM_X) << DVS_COORD_FRAC_BITS;\r\n}\r\n}\r\nfor (y = 0; y < height_y; y++) {\r\nfor (x = 0; x < width_y; x++) {\r\ndvs_config->ycoords_y[y*width_y + x] = (dvs_offset->height + y*DVS_BLOCKDIM_Y_LUMA) << DVS_COORD_FRAC_BITS;\r\n}\r\n}\r\nfor (y = 0; y < height_uv; y++) {\r\nfor (x = 0; x < width_uv; x++) {\r\ndvs_config->xcoords_uv[y*width_uv + x] = ((dvs_offset->width / 2) + x*DVS_BLOCKDIM_X) << DVS_COORD_FRAC_BITS;\r\n}\r\n}\r\nfor (y = 0; y < height_uv; y++) {\r\nfor (x = 0; x < width_uv; x++) {\r\ndvs_config->ycoords_uv[y*width_uv + x] = ((dvs_offset->height / 2) + y*DVS_BLOCKDIM_Y_CHROMA) << DVS_COORD_FRAC_BITS;\r\n}\r\n}\r\n}\r\nstatic void\r\ninit_dvs_6axis_table_from_config(struct ia_css_dvs_6axis_config *dvs_config, struct ia_css_dvs_6axis_config *dvs_config_src)\r\n{\r\nunsigned int width_y = dvs_config->width_y;\r\nunsigned int height_y = dvs_config->height_y;\r\nunsigned int width_uv = dvs_config->width_uv;\r\nunsigned int height_uv = dvs_config->height_uv;\r\nmemcpy(dvs_config->xcoords_y, dvs_config_src->xcoords_y, (width_y * height_y * sizeof(uint32_t)));\r\nmemcpy(dvs_config->ycoords_y, dvs_config_src->ycoords_y, (width_y * height_y * sizeof(uint32_t)));\r\nmemcpy(dvs_config->xcoords_uv, dvs_config_src->xcoords_uv, (width_uv * height_uv * sizeof(uint32_t)));\r\nmemcpy(dvs_config->ycoords_uv, dvs_config_src->ycoords_uv, (width_uv * height_uv * sizeof(uint32_t)));\r\n}\r\nstruct ia_css_dvs_6axis_config *\r\ngenerate_dvs_6axis_table(const struct ia_css_resolution *frame_res, const struct ia_css_resolution *dvs_offset)\r\n{\r\nstruct ia_css_dvs_6axis_config *dvs_6axis_table;\r\nassert(frame_res != NULL);\r\nassert(dvs_offset != NULL);\r\ndvs_6axis_table = alloc_dvs_6axis_table(frame_res, NULL);\r\nif (dvs_6axis_table) {\r\ninit_dvs_6axis_table_from_default(dvs_6axis_table, dvs_offset);\r\nreturn dvs_6axis_table;\r\n}\r\nreturn NULL;\r\n}\r\nstruct ia_css_dvs_6axis_config *\r\ngenerate_dvs_6axis_table_from_config(struct ia_css_dvs_6axis_config *dvs_config_src)\r\n{\r\nstruct ia_css_dvs_6axis_config *dvs_6axis_table;\r\nassert(NULL != dvs_config_src);\r\ndvs_6axis_table = alloc_dvs_6axis_table(NULL, dvs_config_src);\r\nif (dvs_6axis_table) {\r\ninit_dvs_6axis_table_from_config(dvs_6axis_table, dvs_config_src);\r\nreturn dvs_6axis_table;\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\nfree_dvs_6axis_table(struct ia_css_dvs_6axis_config **dvs_6axis_config)\r\n{\r\nassert(dvs_6axis_config != NULL);\r\nassert(*dvs_6axis_config != NULL);\r\nif ((dvs_6axis_config != NULL) && (*dvs_6axis_config != NULL))\r\n{\r\nIA_CSS_ENTER_PRIVATE("dvs_6axis_config %p", (*dvs_6axis_config));\r\nif ((*dvs_6axis_config)->xcoords_y != NULL)\r\n{\r\nsh_css_free((*dvs_6axis_config)->xcoords_y);\r\n(*dvs_6axis_config)->xcoords_y = NULL;\r\n}\r\nif ((*dvs_6axis_config)->ycoords_y != NULL)\r\n{\r\nsh_css_free((*dvs_6axis_config)->ycoords_y);\r\n(*dvs_6axis_config)->ycoords_y = NULL;\r\n}\r\nif ((*dvs_6axis_config)->xcoords_uv != NULL)\r\n{\r\nsh_css_free((*dvs_6axis_config)->xcoords_uv);\r\n(*dvs_6axis_config)->xcoords_uv = NULL;\r\n}\r\nif ((*dvs_6axis_config)->ycoords_uv != NULL)\r\n{\r\nsh_css_free((*dvs_6axis_config)->ycoords_uv);\r\n(*dvs_6axis_config)->ycoords_uv = NULL;\r\n}\r\nIA_CSS_LEAVE_PRIVATE("dvs_6axis_config %p", (*dvs_6axis_config));\r\nsh_css_free(*dvs_6axis_config);\r\n*dvs_6axis_config = NULL;\r\n}\r\n}\r\nvoid copy_dvs_6axis_table(struct ia_css_dvs_6axis_config *dvs_config_dst,\r\nconst struct ia_css_dvs_6axis_config *dvs_config_src)\r\n{\r\nunsigned int width_y;\r\nunsigned int height_y;\r\nunsigned int width_uv;\r\nunsigned int height_uv;\r\nassert(dvs_config_src != NULL);\r\nassert(dvs_config_dst != NULL);\r\nassert(dvs_config_src->xcoords_y != NULL);\r\nassert(dvs_config_src->xcoords_uv != NULL);\r\nassert(dvs_config_src->ycoords_y != NULL);\r\nassert(dvs_config_src->ycoords_uv != NULL);\r\nassert(dvs_config_src->width_y == dvs_config_dst->width_y);\r\nassert(dvs_config_src->width_uv == dvs_config_dst->width_uv);\r\nassert(dvs_config_src->height_y == dvs_config_dst->height_y);\r\nassert(dvs_config_src->height_uv == dvs_config_dst->height_uv);\r\nwidth_y = dvs_config_src->width_y;\r\nheight_y = dvs_config_src->height_y;\r\nwidth_uv = dvs_config_src->width_uv;\r\nheight_uv = dvs_config_src->height_uv;\r\nmemcpy(dvs_config_dst->xcoords_y, dvs_config_src->xcoords_y, (width_y * height_y * sizeof(uint32_t)));\r\nmemcpy(dvs_config_dst->ycoords_y, dvs_config_src->ycoords_y, (width_y * height_y * sizeof(uint32_t)));\r\nmemcpy(dvs_config_dst->xcoords_uv, dvs_config_src->xcoords_uv, (width_uv * height_uv * sizeof(uint32_t)));\r\nmemcpy(dvs_config_dst->ycoords_uv, dvs_config_src->ycoords_uv, (width_uv * height_uv * sizeof(uint32_t)));\r\n}\r\nvoid\r\nia_css_dvs_statistics_get(enum dvs_statistics_type type,\r\nunion ia_css_dvs_statistics_host *host_stats,\r\nconst union ia_css_dvs_statistics_isp *isp_stats)\r\n{\r\nif (DVS_STATISTICS == type)\r\n{\r\nia_css_get_dvs_statistics(host_stats->p_dvs_statistics_host,\r\nisp_stats->p_dvs_statistics_isp);\r\n} else if (DVS2_STATISTICS == type)\r\n{\r\nia_css_get_dvs2_statistics(host_stats->p_dvs2_statistics_host,\r\nisp_stats->p_dvs_statistics_isp);\r\n}\r\nreturn;\r\n}

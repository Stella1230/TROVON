static int calc_tpm2_event_size(struct tcg_pcr_event2 *event,\r\nstruct tcg_pcr_event *event_header)\r\n{\r\nstruct tcg_efi_specid_event *efispecid;\r\nstruct tcg_event_field *event_field;\r\nvoid *marker;\r\nvoid *marker_start;\r\nu32 halg_size;\r\nsize_t size;\r\nu16 halg;\r\nint i;\r\nint j;\r\nmarker = event;\r\nmarker_start = marker;\r\nmarker = marker + sizeof(event->pcr_idx) + sizeof(event->event_type)\r\n+ sizeof(event->count);\r\nefispecid = (struct tcg_efi_specid_event *)event_header->event;\r\nif (event->count > efispecid->num_algs)\r\nreturn 0;\r\nfor (i = 0; i < event->count; i++) {\r\nhalg_size = sizeof(event->digests[i].alg_id);\r\nmemcpy(&halg, marker, halg_size);\r\nmarker = marker + halg_size;\r\nfor (j = 0; j < efispecid->num_algs; j++) {\r\nif (halg == efispecid->digest_sizes[j].alg_id) {\r\nmarker +=\r\nefispecid->digest_sizes[j].digest_size;\r\nbreak;\r\n}\r\n}\r\nif (j == efispecid->num_algs)\r\nreturn 0;\r\n}\r\nevent_field = (struct tcg_event_field *)marker;\r\nmarker = marker + sizeof(event_field->event_size)\r\n+ event_field->event_size;\r\nsize = marker - marker_start;\r\nif ((event->event_type == 0) && (event_field->event_size == 0))\r\nreturn 0;\r\nreturn size;\r\n}\r\nstatic void *tpm2_bios_measurements_start(struct seq_file *m, loff_t *pos)\r\n{\r\nstruct tpm_chip *chip = m->private;\r\nstruct tpm_bios_log *log = &chip->log;\r\nvoid *addr = log->bios_event_log;\r\nvoid *limit = log->bios_event_log_end;\r\nstruct tcg_pcr_event *event_header;\r\nstruct tcg_pcr_event2 *event;\r\nsize_t size;\r\nint i;\r\nevent_header = addr;\r\nsize = sizeof(struct tcg_pcr_event) - sizeof(event_header->event)\r\n+ event_header->event_size;\r\nif (*pos == 0) {\r\nif (addr + size < limit) {\r\nif ((event_header->event_type == 0) &&\r\n(event_header->event_size == 0))\r\nreturn NULL;\r\nreturn SEQ_START_TOKEN;\r\n}\r\n}\r\nif (*pos > 0) {\r\naddr += size;\r\nevent = addr;\r\nsize = calc_tpm2_event_size(event, event_header);\r\nif ((addr + size >= limit) || (size == 0))\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < (*pos - 1); i++) {\r\nevent = addr;\r\nsize = calc_tpm2_event_size(event, event_header);\r\nif ((addr + size >= limit) || (size == 0))\r\nreturn NULL;\r\naddr += size;\r\n}\r\nreturn addr;\r\n}\r\nstatic void *tpm2_bios_measurements_next(struct seq_file *m, void *v,\r\nloff_t *pos)\r\n{\r\nstruct tcg_pcr_event *event_header;\r\nstruct tcg_pcr_event2 *event;\r\nstruct tpm_chip *chip = m->private;\r\nstruct tpm_bios_log *log = &chip->log;\r\nvoid *limit = log->bios_event_log_end;\r\nsize_t event_size;\r\nvoid *marker;\r\nevent_header = log->bios_event_log;\r\nif (v == SEQ_START_TOKEN) {\r\nevent_size = sizeof(struct tcg_pcr_event) -\r\nsizeof(event_header->event) + event_header->event_size;\r\nmarker = event_header;\r\n} else {\r\nevent = v;\r\nevent_size = calc_tpm2_event_size(event, event_header);\r\nif (event_size == 0)\r\nreturn NULL;\r\nmarker = event;\r\n}\r\nmarker = marker + event_size;\r\nif (marker >= limit)\r\nreturn NULL;\r\nv = marker;\r\nevent = v;\r\nevent_size = calc_tpm2_event_size(event, event_header);\r\nif (((v + event_size) >= limit) || (event_size == 0))\r\nreturn NULL;\r\n(*pos)++;\r\nreturn v;\r\n}\r\nstatic void tpm2_bios_measurements_stop(struct seq_file *m, void *v)\r\n{\r\n}\r\nstatic int tpm2_binary_bios_measurements_show(struct seq_file *m, void *v)\r\n{\r\nstruct tpm_chip *chip = m->private;\r\nstruct tpm_bios_log *log = &chip->log;\r\nstruct tcg_pcr_event *event_header = log->bios_event_log;\r\nstruct tcg_pcr_event2 *event = v;\r\nvoid *temp_ptr;\r\nsize_t size;\r\nif (v == SEQ_START_TOKEN) {\r\nsize = sizeof(struct tcg_pcr_event) -\r\nsizeof(event_header->event) + event_header->event_size;\r\ntemp_ptr = event_header;\r\nif (size > 0)\r\nseq_write(m, temp_ptr, size);\r\n} else {\r\nsize = calc_tpm2_event_size(event, event_header);\r\ntemp_ptr = event;\r\nif (size > 0)\r\nseq_write(m, temp_ptr, size);\r\n}\r\nreturn 0;\r\n}

static bool audit_ip4(struct audit_buffer *ab, struct sk_buff *skb)\r\n{\r\nstruct iphdr _iph;\r\nconst struct iphdr *ih;\r\nih = skb_header_pointer(skb, skb_network_offset(skb), sizeof(_iph), &_iph);\r\nif (!ih)\r\nreturn false;\r\naudit_log_format(ab, " saddr=%pI4 daddr=%pI4 proto=%hhu",\r\n&ih->saddr, &ih->daddr, ih->protocol);\r\nreturn true;\r\n}\r\nstatic bool audit_ip6(struct audit_buffer *ab, struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr _ip6h;\r\nconst struct ipv6hdr *ih;\r\nu8 nexthdr;\r\n__be16 frag_off;\r\nih = skb_header_pointer(skb, skb_network_offset(skb), sizeof(_ip6h), &_ip6h);\r\nif (!ih)\r\nreturn false;\r\nnexthdr = ih->nexthdr;\r\nipv6_skip_exthdr(skb, skb_network_offset(skb) + sizeof(_ip6h), &nexthdr, &frag_off);\r\naudit_log_format(ab, " saddr=%pI6c daddr=%pI6c proto=%hhu",\r\n&ih->saddr, &ih->daddr, nexthdr);\r\nreturn true;\r\n}\r\nstatic unsigned int\r\naudit_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nstruct audit_buffer *ab;\r\nint fam = -1;\r\nif (audit_enabled == 0)\r\ngoto errout;\r\nab = audit_log_start(NULL, GFP_ATOMIC, AUDIT_NETFILTER_PKT);\r\nif (ab == NULL)\r\ngoto errout;\r\naudit_log_format(ab, "mark=%#x", skb->mark);\r\nswitch (xt_family(par)) {\r\ncase NFPROTO_BRIDGE:\r\nswitch (eth_hdr(skb)->h_proto) {\r\ncase htons(ETH_P_IP):\r\nfam = audit_ip4(ab, skb) ? NFPROTO_IPV4 : -1;\r\nbreak;\r\ncase htons(ETH_P_IPV6):\r\nfam = audit_ip6(ab, skb) ? NFPROTO_IPV6 : -1;\r\nbreak;\r\n}\r\nbreak;\r\ncase NFPROTO_IPV4:\r\nfam = audit_ip4(ab, skb) ? NFPROTO_IPV4 : -1;\r\nbreak;\r\ncase NFPROTO_IPV6:\r\nfam = audit_ip6(ab, skb) ? NFPROTO_IPV6 : -1;\r\nbreak;\r\n}\r\nif (fam == -1)\r\naudit_log_format(ab, " saddr=? daddr=? proto=-1");\r\naudit_log_end(ab);\r\nerrout:\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\naudit_tg_ebt(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\naudit_tg(skb, par);\r\nreturn EBT_CONTINUE;\r\n}\r\nstatic int audit_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct xt_audit_info *info = par->targinfo;\r\nif (info->type > XT_AUDIT_TYPE_MAX) {\r\npr_info("Audit type out of range (valid range: 0..%hhu)\n",\r\nXT_AUDIT_TYPE_MAX);\r\nreturn -ERANGE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init audit_tg_init(void)\r\n{\r\nreturn xt_register_targets(audit_tg_reg, ARRAY_SIZE(audit_tg_reg));\r\n}\r\nstatic void __exit audit_tg_exit(void)\r\n{\r\nxt_unregister_targets(audit_tg_reg, ARRAY_SIZE(audit_tg_reg));\r\n}

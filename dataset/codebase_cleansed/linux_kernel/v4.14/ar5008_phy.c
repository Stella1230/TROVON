static void ar5008_write_bank6(struct ath_hw *ah, unsigned int *writecnt)\r\n{\r\nstruct ar5416IniArray *array = &ah->iniBank6;\r\nu32 *data = ah->analogBank6Data;\r\nint r;\r\nENABLE_REGWRITE_BUFFER(ah);\r\nfor (r = 0; r < array->ia_rows; r++) {\r\nREG_WRITE(ah, INI_RA(array, r, 0), data[r]);\r\nDO_DELAY(*writecnt);\r\n}\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nstatic void ar5008_hw_phy_modify_rx_buffer(u32 *rfBuf, u32 reg32,\r\nu32 numBits, u32 firstBit,\r\nu32 column)\r\n{\r\nu32 tmp32, mask, arrayEntry, lastBit;\r\nint32_t bitPosition, bitsLeft;\r\ntmp32 = ath9k_hw_reverse_bits(reg32, numBits);\r\narrayEntry = (firstBit - 1) / 8;\r\nbitPosition = (firstBit - 1) % 8;\r\nbitsLeft = numBits;\r\nwhile (bitsLeft > 0) {\r\nlastBit = (bitPosition + bitsLeft > 8) ?\r\n8 : bitPosition + bitsLeft;\r\nmask = (((1 << lastBit) - 1) ^ ((1 << bitPosition) - 1)) <<\r\n(column * 8);\r\nrfBuf[arrayEntry] &= ~mask;\r\nrfBuf[arrayEntry] |= ((tmp32 << bitPosition) <<\r\n(column * 8)) & mask;\r\nbitsLeft -= 8 - bitPosition;\r\ntmp32 = tmp32 >> (8 - bitPosition);\r\nbitPosition = 0;\r\narrayEntry++;\r\n}\r\n}\r\nstatic void ar5008_hw_force_bias(struct ath_hw *ah, u16 synth_freq)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 tmp_reg;\r\nint reg_writes = 0;\r\nu32 new_bias = 0;\r\nif (!AR_SREV_5416(ah) || synth_freq >= 3000)\r\nreturn;\r\nBUG_ON(AR_SREV_9280_20_OR_LATER(ah));\r\nif (synth_freq < 2412)\r\nnew_bias = 0;\r\nelse if (synth_freq < 2422)\r\nnew_bias = 1;\r\nelse\r\nnew_bias = 2;\r\ntmp_reg = ath9k_hw_reverse_bits(new_bias, 3);\r\nath_dbg(common, CONFIG, "Force rf_pwd_icsyndiv to %1d on %4d\n",\r\nnew_bias, synth_freq);\r\nar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data, tmp_reg, 3, 181, 3);\r\nar5008_write_bank6(ah, &reg_writes);\r\n}\r\nstatic int ar5008_hw_set_channel(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 channelSel = 0;\r\nu32 bModeSynth = 0;\r\nu32 aModeRefSel = 0;\r\nu32 reg32 = 0;\r\nu16 freq;\r\nstruct chan_centers centers;\r\nath9k_hw_get_channel_centers(ah, chan, &centers);\r\nfreq = centers.synth_center;\r\nif (freq < 4800) {\r\nu32 txctl;\r\nif (((freq - 2192) % 5) == 0) {\r\nchannelSel = ((freq - 672) * 2 - 3040) / 10;\r\nbModeSynth = 0;\r\n} else if (((freq - 2224) % 5) == 0) {\r\nchannelSel = ((freq - 704) * 2 - 3040) / 10;\r\nbModeSynth = 1;\r\n} else {\r\nath_err(common, "Invalid channel %u MHz\n", freq);\r\nreturn -EINVAL;\r\n}\r\nchannelSel = (channelSel << 2) & 0xff;\r\nchannelSel = ath9k_hw_reverse_bits(channelSel, 8);\r\ntxctl = REG_READ(ah, AR_PHY_CCK_TX_CTRL);\r\nif (freq == 2484) {\r\nREG_WRITE(ah, AR_PHY_CCK_TX_CTRL,\r\ntxctl | AR_PHY_CCK_TX_CTRL_JAPAN);\r\n} else {\r\nREG_WRITE(ah, AR_PHY_CCK_TX_CTRL,\r\ntxctl & ~AR_PHY_CCK_TX_CTRL_JAPAN);\r\n}\r\n} else if ((freq % 20) == 0 && freq >= 5120) {\r\nchannelSel =\r\nath9k_hw_reverse_bits(((freq - 4800) / 20 << 2), 8);\r\naModeRefSel = ath9k_hw_reverse_bits(1, 2);\r\n} else if ((freq % 10) == 0) {\r\nchannelSel =\r\nath9k_hw_reverse_bits(((freq - 4800) / 10 << 1), 8);\r\nif (AR_SREV_9100(ah) || AR_SREV_9160_10_OR_LATER(ah))\r\naModeRefSel = ath9k_hw_reverse_bits(2, 2);\r\nelse\r\naModeRefSel = ath9k_hw_reverse_bits(1, 2);\r\n} else if ((freq % 5) == 0) {\r\nchannelSel = ath9k_hw_reverse_bits((freq - 4800) / 5, 8);\r\naModeRefSel = ath9k_hw_reverse_bits(1, 2);\r\n} else {\r\nath_err(common, "Invalid channel %u MHz\n", freq);\r\nreturn -EINVAL;\r\n}\r\nar5008_hw_force_bias(ah, freq);\r\nreg32 =\r\n(channelSel << 8) | (aModeRefSel << 2) | (bModeSynth << 1) |\r\n(1 << 5) | 0x1;\r\nREG_WRITE(ah, AR_PHY(0x37), reg32);\r\nah->curchan = chan;\r\nreturn 0;\r\n}\r\nvoid ar5008_hw_cmn_spur_mitigate(struct ath_hw *ah,\r\nstruct ath9k_channel *chan, int bin)\r\n{\r\nint cur_bin;\r\nint upper, lower, cur_vit_mask;\r\nint i;\r\nint8_t mask_m[123] = {0};\r\nint8_t mask_p[123] = {0};\r\nint8_t mask_amt;\r\nint tmp_mask;\r\nstatic const int pilot_mask_reg[4] = {\r\nAR_PHY_TIMING7, AR_PHY_TIMING8,\r\nAR_PHY_PILOT_MASK_01_30, AR_PHY_PILOT_MASK_31_60\r\n};\r\nstatic const int chan_mask_reg[4] = {\r\nAR_PHY_TIMING9, AR_PHY_TIMING10,\r\nAR_PHY_CHANNEL_MASK_01_30, AR_PHY_CHANNEL_MASK_31_60\r\n};\r\nstatic const int inc[4] = { 0, 100, 0, 0 };\r\ncur_bin = -6000;\r\nupper = bin + 100;\r\nlower = bin - 100;\r\nfor (i = 0; i < 4; i++) {\r\nint pilot_mask = 0;\r\nint chan_mask = 0;\r\nint bp = 0;\r\nfor (bp = 0; bp < 30; bp++) {\r\nif ((cur_bin > lower) && (cur_bin < upper)) {\r\npilot_mask = pilot_mask | 0x1 << bp;\r\nchan_mask = chan_mask | 0x1 << bp;\r\n}\r\ncur_bin += 100;\r\n}\r\ncur_bin += inc[i];\r\nREG_WRITE(ah, pilot_mask_reg[i], pilot_mask);\r\nREG_WRITE(ah, chan_mask_reg[i], chan_mask);\r\n}\r\ncur_vit_mask = 6100;\r\nupper = bin + 120;\r\nlower = bin - 120;\r\nfor (i = 0; i < ARRAY_SIZE(mask_m); i++) {\r\nif ((cur_vit_mask > lower) && (cur_vit_mask < upper)) {\r\nvolatile int tmp_v = abs(cur_vit_mask - bin);\r\nif (tmp_v < 75)\r\nmask_amt = 1;\r\nelse\r\nmask_amt = 0;\r\nif (cur_vit_mask < 0)\r\nmask_m[abs(cur_vit_mask / 100)] = mask_amt;\r\nelse\r\nmask_p[cur_vit_mask / 100] = mask_amt;\r\n}\r\ncur_vit_mask -= 100;\r\n}\r\ntmp_mask = (mask_m[46] << 30) | (mask_m[47] << 28)\r\n| (mask_m[48] << 26) | (mask_m[49] << 24)\r\n| (mask_m[50] << 22) | (mask_m[51] << 20)\r\n| (mask_m[52] << 18) | (mask_m[53] << 16)\r\n| (mask_m[54] << 14) | (mask_m[55] << 12)\r\n| (mask_m[56] << 10) | (mask_m[57] << 8)\r\n| (mask_m[58] << 6) | (mask_m[59] << 4)\r\n| (mask_m[60] << 2) | (mask_m[61] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK_1, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_VIT_MASK2_M_46_61, tmp_mask);\r\ntmp_mask = (mask_m[31] << 28)\r\n| (mask_m[32] << 26) | (mask_m[33] << 24)\r\n| (mask_m[34] << 22) | (mask_m[35] << 20)\r\n| (mask_m[36] << 18) | (mask_m[37] << 16)\r\n| (mask_m[48] << 14) | (mask_m[39] << 12)\r\n| (mask_m[40] << 10) | (mask_m[41] << 8)\r\n| (mask_m[42] << 6) | (mask_m[43] << 4)\r\n| (mask_m[44] << 2) | (mask_m[45] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK_2, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_M_31_45, tmp_mask);\r\ntmp_mask = (mask_m[16] << 30) | (mask_m[16] << 28)\r\n| (mask_m[18] << 26) | (mask_m[18] << 24)\r\n| (mask_m[20] << 22) | (mask_m[20] << 20)\r\n| (mask_m[22] << 18) | (mask_m[22] << 16)\r\n| (mask_m[24] << 14) | (mask_m[24] << 12)\r\n| (mask_m[25] << 10) | (mask_m[26] << 8)\r\n| (mask_m[27] << 6) | (mask_m[28] << 4)\r\n| (mask_m[29] << 2) | (mask_m[30] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK_3, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_M_16_30, tmp_mask);\r\ntmp_mask = (mask_m[0] << 30) | (mask_m[1] << 28)\r\n| (mask_m[2] << 26) | (mask_m[3] << 24)\r\n| (mask_m[4] << 22) | (mask_m[5] << 20)\r\n| (mask_m[6] << 18) | (mask_m[7] << 16)\r\n| (mask_m[8] << 14) | (mask_m[9] << 12)\r\n| (mask_m[10] << 10) | (mask_m[11] << 8)\r\n| (mask_m[12] << 6) | (mask_m[13] << 4)\r\n| (mask_m[14] << 2) | (mask_m[15] << 0);\r\nREG_WRITE(ah, AR_PHY_MASK_CTL, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_M_00_15, tmp_mask);\r\ntmp_mask = (mask_p[15] << 28)\r\n| (mask_p[14] << 26) | (mask_p[13] << 24)\r\n| (mask_p[12] << 22) | (mask_p[11] << 20)\r\n| (mask_p[10] << 18) | (mask_p[9] << 16)\r\n| (mask_p[8] << 14) | (mask_p[7] << 12)\r\n| (mask_p[6] << 10) | (mask_p[5] << 8)\r\n| (mask_p[4] << 6) | (mask_p[3] << 4)\r\n| (mask_p[2] << 2) | (mask_p[1] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK2_1, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_P_15_01, tmp_mask);\r\ntmp_mask = (mask_p[30] << 28)\r\n| (mask_p[29] << 26) | (mask_p[28] << 24)\r\n| (mask_p[27] << 22) | (mask_p[26] << 20)\r\n| (mask_p[25] << 18) | (mask_p[24] << 16)\r\n| (mask_p[23] << 14) | (mask_p[22] << 12)\r\n| (mask_p[21] << 10) | (mask_p[20] << 8)\r\n| (mask_p[19] << 6) | (mask_p[18] << 4)\r\n| (mask_p[17] << 2) | (mask_p[16] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK2_2, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_P_30_16, tmp_mask);\r\ntmp_mask = (mask_p[45] << 28)\r\n| (mask_p[44] << 26) | (mask_p[43] << 24)\r\n| (mask_p[42] << 22) | (mask_p[41] << 20)\r\n| (mask_p[40] << 18) | (mask_p[39] << 16)\r\n| (mask_p[38] << 14) | (mask_p[37] << 12)\r\n| (mask_p[36] << 10) | (mask_p[35] << 8)\r\n| (mask_p[34] << 6) | (mask_p[33] << 4)\r\n| (mask_p[32] << 2) | (mask_p[31] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK2_3, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_P_45_31, tmp_mask);\r\ntmp_mask = (mask_p[61] << 30) | (mask_p[60] << 28)\r\n| (mask_p[59] << 26) | (mask_p[58] << 24)\r\n| (mask_p[57] << 22) | (mask_p[56] << 20)\r\n| (mask_p[55] << 18) | (mask_p[54] << 16)\r\n| (mask_p[53] << 14) | (mask_p[52] << 12)\r\n| (mask_p[51] << 10) | (mask_p[50] << 8)\r\n| (mask_p[49] << 6) | (mask_p[48] << 4)\r\n| (mask_p[47] << 2) | (mask_p[46] << 0);\r\nREG_WRITE(ah, AR_PHY_BIN_MASK2_4, tmp_mask);\r\nREG_WRITE(ah, AR_PHY_MASK2_P_61_45, tmp_mask);\r\n}\r\nstatic void ar5008_hw_spur_mitigate(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nint bb_spur = AR_NO_SPUR;\r\nint bin;\r\nint spur_freq_sd;\r\nint spur_delta_phase;\r\nint denominator;\r\nint tmp, new;\r\nint i;\r\nint cur_bb_spur;\r\nbool is2GHz = IS_CHAN_2GHZ(chan);\r\nfor (i = 0; i < AR_EEPROM_MODAL_SPURS; i++) {\r\ncur_bb_spur = ah->eep_ops->get_spur_channel(ah, i, is2GHz);\r\nif (AR_NO_SPUR == cur_bb_spur)\r\nbreak;\r\ncur_bb_spur = cur_bb_spur - (chan->channel * 10);\r\nif ((cur_bb_spur > -95) && (cur_bb_spur < 95)) {\r\nbb_spur = cur_bb_spur;\r\nbreak;\r\n}\r\n}\r\nif (AR_NO_SPUR == bb_spur)\r\nreturn;\r\nbin = bb_spur * 32;\r\ntmp = REG_READ(ah, AR_PHY_TIMING_CTRL4(0));\r\nnew = tmp | (AR_PHY_TIMING_CTRL4_ENABLE_SPUR_RSSI |\r\nAR_PHY_TIMING_CTRL4_ENABLE_SPUR_FILTER |\r\nAR_PHY_TIMING_CTRL4_ENABLE_CHAN_MASK |\r\nAR_PHY_TIMING_CTRL4_ENABLE_PILOT_MASK);\r\nREG_WRITE(ah, AR_PHY_TIMING_CTRL4(0), new);\r\nnew = (AR_PHY_SPUR_REG_MASK_RATE_CNTL |\r\nAR_PHY_SPUR_REG_ENABLE_MASK_PPM |\r\nAR_PHY_SPUR_REG_MASK_RATE_SELECT |\r\nAR_PHY_SPUR_REG_ENABLE_VIT_SPUR_RSSI |\r\nSM(SPUR_RSSI_THRESH, AR_PHY_SPUR_REG_SPUR_RSSI_THRESH));\r\nREG_WRITE(ah, AR_PHY_SPUR_REG, new);\r\nspur_delta_phase = ((bb_spur * 524288) / 100) &\r\nAR_PHY_TIMING11_SPUR_DELTA_PHASE;\r\ndenominator = IS_CHAN_2GHZ(chan) ? 440 : 400;\r\nspur_freq_sd = ((bb_spur * 2048) / denominator) & 0x3ff;\r\nnew = (AR_PHY_TIMING11_USE_SPUR_IN_AGC |\r\nSM(spur_freq_sd, AR_PHY_TIMING11_SPUR_FREQ_SD) |\r\nSM(spur_delta_phase, AR_PHY_TIMING11_SPUR_DELTA_PHASE));\r\nREG_WRITE(ah, AR_PHY_TIMING11, new);\r\nar5008_hw_cmn_spur_mitigate(ah, chan, bin);\r\n}\r\nstatic int ar5008_hw_rf_alloc_ext_banks(struct ath_hw *ah)\r\n{\r\nint size = ah->iniBank6.ia_rows * sizeof(u32);\r\nif (AR_SREV_9280_20_OR_LATER(ah))\r\nreturn 0;\r\nah->analogBank6Data = devm_kzalloc(ah->dev, size, GFP_KERNEL);\r\nif (!ah->analogBank6Data)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic bool ar5008_hw_set_rf_regs(struct ath_hw *ah,\r\nstruct ath9k_channel *chan,\r\nu16 modesIndex)\r\n{\r\nu32 eepMinorRev;\r\nu32 ob5GHz = 0, db5GHz = 0;\r\nu32 ob2GHz = 0, db2GHz = 0;\r\nint regWrites = 0;\r\nint i;\r\nif (AR_SREV_9280_20_OR_LATER(ah))\r\nreturn true;\r\neepMinorRev = ah->eep_ops->get_eeprom_rev(ah);\r\nfor (i = 0; i < ah->iniBank6.ia_rows; i++)\r\nah->analogBank6Data[i] = INI_RA(&ah->iniBank6, i, modesIndex);\r\nif (eepMinorRev >= 2) {\r\nif (IS_CHAN_2GHZ(chan)) {\r\nob2GHz = ah->eep_ops->get_eeprom(ah, EEP_OB_2);\r\ndb2GHz = ah->eep_ops->get_eeprom(ah, EEP_DB_2);\r\nar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\r\nob2GHz, 3, 197, 0);\r\nar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\r\ndb2GHz, 3, 194, 0);\r\n} else {\r\nob5GHz = ah->eep_ops->get_eeprom(ah, EEP_OB_5);\r\ndb5GHz = ah->eep_ops->get_eeprom(ah, EEP_DB_5);\r\nar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\r\nob5GHz, 3, 203, 0);\r\nar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\r\ndb5GHz, 3, 200, 0);\r\n}\r\n}\r\nREG_WRITE_ARRAY(&bank0, 1, regWrites);\r\nREG_WRITE_ARRAY(&bank1, 1, regWrites);\r\nREG_WRITE_ARRAY(&bank2, 1, regWrites);\r\nREG_WRITE_ARRAY(&bank3, modesIndex, regWrites);\r\nar5008_write_bank6(ah, &regWrites);\r\nREG_WRITE_ARRAY(&bank7, 1, regWrites);\r\nreturn true;\r\n}\r\nstatic void ar5008_hw_init_bb(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 synthDelay;\r\nsynthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\r\nath9k_hw_synth_delay(ah, chan, synthDelay);\r\n}\r\nstatic void ar5008_hw_init_chain_masks(struct ath_hw *ah)\r\n{\r\nint rx_chainmask, tx_chainmask;\r\nrx_chainmask = ah->rxchainmask;\r\ntx_chainmask = ah->txchainmask;\r\nswitch (rx_chainmask) {\r\ncase 0x5:\r\nREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\r\nAR_PHY_SWAP_ALT_CHAIN);\r\ncase 0x3:\r\nif (ah->hw_version.macVersion == AR_SREV_REVISION_5416_10) {\r\nREG_WRITE(ah, AR_PHY_RX_CHAINMASK, 0x7);\r\nREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, 0x7);\r\nbreak;\r\n}\r\ncase 0x1:\r\ncase 0x2:\r\ncase 0x7:\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx_chainmask);\r\nREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx_chainmask);\r\nbreak;\r\ndefault:\r\nENABLE_REGWRITE_BUFFER(ah);\r\nbreak;\r\n}\r\nREG_WRITE(ah, AR_SELFGEN_MASK, tx_chainmask);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\nif (tx_chainmask == 0x5) {\r\nREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\r\nAR_PHY_SWAP_ALT_CHAIN);\r\n}\r\nif (AR_SREV_9100(ah))\r\nREG_WRITE(ah, AR_PHY_ANALOG_SWAP,\r\nREG_READ(ah, AR_PHY_ANALOG_SWAP) | 0x00000001);\r\n}\r\nstatic void ar5008_hw_override_ini(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 val;\r\nREG_SET_BIT(ah, AR_DIAG_SW, (AR_DIAG_RX_DIS | AR_DIAG_RX_ABORT));\r\nif (AR_SREV_9280_20_OR_LATER(ah)) {\r\nval = REG_READ(ah, AR_PCU_MISC_MODE2) &\r\n(~AR_ADHOC_MCAST_KEYID_ENABLE);\r\nif (!AR_SREV_9271(ah))\r\nval &= ~AR_PCU_MISC_MODE2_HWWAR1;\r\nif (AR_SREV_9287_11_OR_LATER(ah))\r\nval = val & (~AR_PCU_MISC_MODE2_HWWAR2);\r\nval |= AR_PCU_MISC_MODE2_CFP_IGNORE;\r\nREG_WRITE(ah, AR_PCU_MISC_MODE2, val);\r\n}\r\nif (AR_SREV_9280_20_OR_LATER(ah))\r\nreturn;\r\nREG_WRITE(ah, 0x9800 + (651 << 2), 0x11);\r\nif (AR_SREV_9100(ah) || AR_SREV_9160(ah)) {\r\nval = REG_READ(ah, AR_PHY_HEAVY_CLIP_FACTOR_RIFS);\r\nval &= ~AR_PHY_RIFS_INIT_DELAY;\r\nREG_WRITE(ah, AR_PHY_HEAVY_CLIP_FACTOR_RIFS, val);\r\n}\r\n}\r\nstatic void ar5008_hw_set_channel_regs(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 phymode;\r\nu32 enableDacFifo = 0;\r\nif (AR_SREV_9285_12_OR_LATER(ah))\r\nenableDacFifo = (REG_READ(ah, AR_PHY_TURBO) &\r\nAR_PHY_FC_ENABLE_DAC_FIFO);\r\nphymode = AR_PHY_FC_HT_EN | AR_PHY_FC_SHORT_GI_40\r\n| AR_PHY_FC_SINGLE_HT_LTF1 | AR_PHY_FC_WALSH | enableDacFifo;\r\nif (IS_CHAN_HT40(chan)) {\r\nphymode |= AR_PHY_FC_DYN2040_EN;\r\nif (IS_CHAN_HT40PLUS(chan))\r\nphymode |= AR_PHY_FC_DYN2040_PRI_CH;\r\n}\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY_TURBO, phymode);\r\nath9k_hw_set11nmac2040(ah, chan);\r\nREG_WRITE(ah, AR_GTXTO, 25 << AR_GTXTO_TIMEOUT_LIMIT_S);\r\nREG_WRITE(ah, AR_CST, 0xF << AR_CST_TIMEOUT_LIMIT_S);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nstatic int ar5008_hw_process_ini(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nint i, regWrites = 0;\r\nu32 modesIndex, freqIndex;\r\nif (IS_CHAN_5GHZ(chan)) {\r\nfreqIndex = 1;\r\nmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\r\n} else {\r\nfreqIndex = 2;\r\nmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\r\n}\r\nREG_WRITE(ah, AR_PHY(0), 0x00000007);\r\nREG_WRITE(ah, AR_PHY_ADC_SERIAL_CTL, AR_PHY_SEL_EXTERNAL_RADIO);\r\nif (ah->eep_ops->set_addac)\r\nah->eep_ops->set_addac(ah, chan);\r\nREG_WRITE_ARRAY(&ah->iniAddac, 1, regWrites);\r\nREG_WRITE(ah, AR_PHY_ADC_SERIAL_CTL, AR_PHY_SEL_INTERNAL_ADDAC);\r\nENABLE_REGWRITE_BUFFER(ah);\r\nfor (i = 0; i < ah->iniModes.ia_rows; i++) {\r\nu32 reg = INI_RA(&ah->iniModes, i, 0);\r\nu32 val = INI_RA(&ah->iniModes, i, modesIndex);\r\nif (reg == AR_AN_TOP2 && ah->need_an_top2_fixup)\r\nval &= ~AR_AN_TOP2_PWDCLKIND;\r\nREG_WRITE(ah, reg, val);\r\nif (reg >= 0x7800 && reg < 0x78a0\r\n&& ah->config.analog_shiftreg\r\n&& (common->bus_ops->ath_bus_type != ATH_USB)) {\r\nudelay(100);\r\n}\r\nDO_DELAY(regWrites);\r\n}\r\nREGWRITE_BUFFER_FLUSH(ah);\r\nif (AR_SREV_9280(ah) || AR_SREV_9287_11_OR_LATER(ah))\r\nREG_WRITE_ARRAY(&ah->iniModesRxGain, modesIndex, regWrites);\r\nif (AR_SREV_9280(ah) || AR_SREV_9285_12_OR_LATER(ah) ||\r\nAR_SREV_9287_11_OR_LATER(ah))\r\nREG_WRITE_ARRAY(&ah->iniModesTxGain, modesIndex, regWrites);\r\nif (AR_SREV_9271_10(ah)) {\r\nREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN, AR_PHY_SPECTRAL_SCAN_ENA);\r\nREG_RMW_FIELD(ah, AR_PHY_RF_CTL3, AR_PHY_TX_END_TO_ADC_ON, 0xa);\r\n}\r\nENABLE_REGWRITE_BUFFER(ah);\r\nfor (i = 0; i < ah->iniCommon.ia_rows; i++) {\r\nu32 reg = INI_RA(&ah->iniCommon, i, 0);\r\nu32 val = INI_RA(&ah->iniCommon, i, 1);\r\nREG_WRITE(ah, reg, val);\r\nif (reg >= 0x7800 && reg < 0x78a0\r\n&& ah->config.analog_shiftreg\r\n&& (common->bus_ops->ath_bus_type != ATH_USB)) {\r\nudelay(100);\r\n}\r\nDO_DELAY(regWrites);\r\n}\r\nREGWRITE_BUFFER_FLUSH(ah);\r\nREG_WRITE_ARRAY(&ah->iniBB_RfGain, freqIndex, regWrites);\r\nif (IS_CHAN_A_FAST_CLOCK(ah, chan))\r\nREG_WRITE_ARRAY(&ah->iniModesFastClock, modesIndex,\r\nregWrites);\r\nar5008_hw_override_ini(ah, chan);\r\nar5008_hw_set_channel_regs(ah, chan);\r\nar5008_hw_init_chain_masks(ah);\r\nath9k_olc_init(ah);\r\nath9k_hw_apply_txpower(ah, chan, false);\r\nif (!ath9k_hw_set_rf_regs(ah, chan, freqIndex)) {\r\nath_err(ath9k_hw_common(ah), "ar5416SetRfRegs failed\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ar5008_hw_set_rfmode(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nu32 rfMode = 0;\r\nif (chan == NULL)\r\nreturn;\r\nif (IS_CHAN_2GHZ(chan))\r\nrfMode |= AR_PHY_MODE_DYNAMIC;\r\nelse\r\nrfMode |= AR_PHY_MODE_OFDM;\r\nif (!AR_SREV_9280_20_OR_LATER(ah))\r\nrfMode |= (IS_CHAN_5GHZ(chan)) ?\r\nAR_PHY_MODE_RF5GHZ : AR_PHY_MODE_RF2GHZ;\r\nif (IS_CHAN_A_FAST_CLOCK(ah, chan))\r\nrfMode |= (AR_PHY_MODE_DYNAMIC | AR_PHY_MODE_DYN_CCK_DISABLE);\r\nREG_WRITE(ah, AR_PHY_MODE, rfMode);\r\n}\r\nstatic void ar5008_hw_mark_phy_inactive(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\r\n}\r\nstatic void ar5008_hw_set_delta_slope(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 coef_scaled, ds_coef_exp, ds_coef_man;\r\nu32 clockMhzScaled = 0x64000000;\r\nstruct chan_centers centers;\r\nif (IS_CHAN_HALF_RATE(chan))\r\nclockMhzScaled = clockMhzScaled >> 1;\r\nelse if (IS_CHAN_QUARTER_RATE(chan))\r\nclockMhzScaled = clockMhzScaled >> 2;\r\nath9k_hw_get_channel_centers(ah, chan, &centers);\r\ncoef_scaled = clockMhzScaled / centers.synth_center;\r\nath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\r\n&ds_coef_exp);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING3,\r\nAR_PHY_TIMING3_DSC_MAN, ds_coef_man);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING3,\r\nAR_PHY_TIMING3_DSC_EXP, ds_coef_exp);\r\ncoef_scaled = (9 * coef_scaled) / 10;\r\nath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\r\n&ds_coef_exp);\r\nREG_RMW_FIELD(ah, AR_PHY_HALFGI,\r\nAR_PHY_HALFGI_DSC_MAN, ds_coef_man);\r\nREG_RMW_FIELD(ah, AR_PHY_HALFGI,\r\nAR_PHY_HALFGI_DSC_EXP, ds_coef_exp);\r\n}\r\nstatic bool ar5008_hw_rfbus_req(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_RFBUS_REQ, AR_PHY_RFBUS_REQ_EN);\r\nreturn ath9k_hw_wait(ah, AR_PHY_RFBUS_GRANT, AR_PHY_RFBUS_GRANT_EN,\r\nAR_PHY_RFBUS_GRANT_EN, AH_WAIT_TIMEOUT);\r\n}\r\nstatic void ar5008_hw_rfbus_done(struct ath_hw *ah)\r\n{\r\nu32 synthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\r\nath9k_hw_synth_delay(ah, ah->curchan, synthDelay);\r\nREG_WRITE(ah, AR_PHY_RFBUS_REQ, 0);\r\n}\r\nstatic void ar5008_restore_chainmask(struct ath_hw *ah)\r\n{\r\nint rx_chainmask = ah->rxchainmask;\r\nif ((rx_chainmask == 0x5) || (rx_chainmask == 0x3)) {\r\nREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx_chainmask);\r\nREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx_chainmask);\r\n}\r\n}\r\nstatic u32 ar9160_hw_compute_pll_control(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 pll;\r\npll = SM(0x5, AR_RTC_9160_PLL_REFDIV);\r\nif (chan && IS_CHAN_HALF_RATE(chan))\r\npll |= SM(0x1, AR_RTC_9160_PLL_CLKSEL);\r\nelse if (chan && IS_CHAN_QUARTER_RATE(chan))\r\npll |= SM(0x2, AR_RTC_9160_PLL_CLKSEL);\r\nif (chan && IS_CHAN_5GHZ(chan))\r\npll |= SM(0x50, AR_RTC_9160_PLL_DIV);\r\nelse\r\npll |= SM(0x58, AR_RTC_9160_PLL_DIV);\r\nreturn pll;\r\n}\r\nstatic u32 ar5008_hw_compute_pll_control(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 pll;\r\npll = AR_RTC_PLL_REFDIV_5 | AR_RTC_PLL_DIV2;\r\nif (chan && IS_CHAN_HALF_RATE(chan))\r\npll |= SM(0x1, AR_RTC_PLL_CLKSEL);\r\nelse if (chan && IS_CHAN_QUARTER_RATE(chan))\r\npll |= SM(0x2, AR_RTC_PLL_CLKSEL);\r\nif (chan && IS_CHAN_5GHZ(chan))\r\npll |= SM(0xa, AR_RTC_PLL_DIV);\r\nelse\r\npll |= SM(0xb, AR_RTC_PLL_DIV);\r\nreturn pll;\r\n}\r\nstatic bool ar5008_hw_ani_control_new(struct ath_hw *ah,\r\nenum ath9k_ani_cmd cmd,\r\nint param)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ar5416AniState *aniState = &ah->ani;\r\ns32 value;\r\nswitch (cmd & ah->ani_function) {\r\ncase ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION:{\r\nu32 on = param ? 1 : 0;\r\nint m1ThreshLow = on ?\r\naniState->iniDef.m1ThreshLow : m1ThreshLow_off;\r\nint m2ThreshLow = on ?\r\naniState->iniDef.m2ThreshLow : m2ThreshLow_off;\r\nint m1Thresh = on ?\r\naniState->iniDef.m1Thresh : m1Thresh_off;\r\nint m2Thresh = on ?\r\naniState->iniDef.m2Thresh : m2Thresh_off;\r\nint m2CountThr = on ?\r\naniState->iniDef.m2CountThr : m2CountThr_off;\r\nint m2CountThrLow = on ?\r\naniState->iniDef.m2CountThrLow : m2CountThrLow_off;\r\nint m1ThreshLowExt = on ?\r\naniState->iniDef.m1ThreshLowExt : m1ThreshLowExt_off;\r\nint m2ThreshLowExt = on ?\r\naniState->iniDef.m2ThreshLowExt : m2ThreshLowExt_off;\r\nint m1ThreshExt = on ?\r\naniState->iniDef.m1ThreshExt : m1ThreshExt_off;\r\nint m2ThreshExt = on ?\r\naniState->iniDef.m2ThreshExt : m2ThreshExt_off;\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M1_THRESH_LOW,\r\nm1ThreshLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M2_THRESH_LOW,\r\nm2ThreshLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M1_THRESH, m1Thresh);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M2_THRESH, m2Thresh);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M2COUNT_THR, m2CountThr);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M2COUNT_THR_LOW,\r\nm2CountThrLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M1_THRESH_LOW, m1ThreshLowExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M2_THRESH_LOW, m2ThreshLowExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M1_THRESH, m1ThreshExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M2_THRESH, m2ThreshExt);\r\nif (on)\r\nREG_SET_BIT(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\r\nif (on != aniState->ofdmWeakSigDetect) {\r\nath_dbg(common, ANI,\r\n"** ch %d: ofdm weak signal: %s=>%s\n",\r\nchan->channel,\r\naniState->ofdmWeakSigDetect ?\r\n"on" : "off",\r\non ? "on" : "off");\r\nif (on)\r\nah->stats.ast_ani_ofdmon++;\r\nelse\r\nah->stats.ast_ani_ofdmoff++;\r\naniState->ofdmWeakSigDetect = on;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_FIRSTEP_LEVEL:{\r\nu32 level = param;\r\nvalue = level * 2;\r\nREG_RMW_FIELD(ah, AR_PHY_FIND_SIG,\r\nAR_PHY_FIND_SIG_FIRSTEP, value);\r\nREG_RMW_FIELD(ah, AR_PHY_FIND_SIG_LOW,\r\nAR_PHY_FIND_SIG_FIRSTEP_LOW, value);\r\nif (level != aniState->firstepLevel) {\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] firstep[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->firstepLevel,\r\nlevel,\r\nATH9K_ANI_FIRSTEP_LVL,\r\nvalue,\r\naniState->iniDef.firstep);\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] firstep_low[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->firstepLevel,\r\nlevel,\r\nATH9K_ANI_FIRSTEP_LVL,\r\nvalue,\r\naniState->iniDef.firstepLow);\r\nif (level > aniState->firstepLevel)\r\nah->stats.ast_ani_stepup++;\r\nelse if (level < aniState->firstepLevel)\r\nah->stats.ast_ani_stepdown++;\r\naniState->firstepLevel = level;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_SPUR_IMMUNITY_LEVEL:{\r\nu32 level = param;\r\nvalue = (level + 1) * 2;\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING5,\r\nAR_PHY_TIMING5_CYCPWR_THR1, value);\r\nREG_RMW_FIELD(ah, AR_PHY_EXT_CCA,\r\nAR_PHY_EXT_TIMING5_CYCPWR_THR1, value - 1);\r\nif (level != aniState->spurImmunityLevel) {\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] cycpwrThr1[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->spurImmunityLevel,\r\nlevel,\r\nATH9K_ANI_SPUR_IMMUNE_LVL,\r\nvalue,\r\naniState->iniDef.cycpwrThr1);\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->spurImmunityLevel,\r\nlevel,\r\nATH9K_ANI_SPUR_IMMUNE_LVL,\r\nvalue,\r\naniState->iniDef.cycpwrThr1Ext);\r\nif (level > aniState->spurImmunityLevel)\r\nah->stats.ast_ani_spurup++;\r\nelse if (level < aniState->spurImmunityLevel)\r\nah->stats.ast_ani_spurdown++;\r\naniState->spurImmunityLevel = level;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_MRC_CCK:\r\nWARN_ON(1);\r\nbreak;\r\ndefault:\r\nath_dbg(common, ANI, "invalid cmd %u\n", cmd);\r\nreturn false;\r\n}\r\nath_dbg(common, ANI,\r\n"ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d\n",\r\naniState->spurImmunityLevel,\r\naniState->ofdmWeakSigDetect ? "on" : "off",\r\naniState->firstepLevel,\r\naniState->mrcCCK ? "on" : "off",\r\naniState->listenTime,\r\naniState->ofdmPhyErrCount,\r\naniState->cckPhyErrCount);\r\nreturn true;\r\n}\r\nstatic void ar5008_hw_do_getnf(struct ath_hw *ah,\r\nint16_t nfarray[NUM_NF_READINGS])\r\n{\r\nint16_t nf;\r\nnf = MS(REG_READ(ah, AR_PHY_CCA), AR_PHY_MINCCA_PWR);\r\nnfarray[0] = sign_extend32(nf, 8);\r\nnf = MS(REG_READ(ah, AR_PHY_CH1_CCA), AR_PHY_CH1_MINCCA_PWR);\r\nnfarray[1] = sign_extend32(nf, 8);\r\nnf = MS(REG_READ(ah, AR_PHY_CH2_CCA), AR_PHY_CH2_MINCCA_PWR);\r\nnfarray[2] = sign_extend32(nf, 8);\r\nif (!IS_CHAN_HT40(ah->curchan))\r\nreturn;\r\nnf = MS(REG_READ(ah, AR_PHY_EXT_CCA), AR_PHY_EXT_MINCCA_PWR);\r\nnfarray[3] = sign_extend32(nf, 8);\r\nnf = MS(REG_READ(ah, AR_PHY_CH1_EXT_CCA), AR_PHY_CH1_EXT_MINCCA_PWR);\r\nnfarray[4] = sign_extend32(nf, 8);\r\nnf = MS(REG_READ(ah, AR_PHY_CH2_EXT_CCA), AR_PHY_CH2_EXT_MINCCA_PWR);\r\nnfarray[5] = sign_extend32(nf, 8);\r\n}\r\nstatic void ar5008_hw_ani_cache_ini_regs(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ar5416AniState *aniState = &ah->ani;\r\nstruct ath9k_ani_default *iniDef;\r\nu32 val;\r\niniDef = &aniState->iniDef;\r\nath_dbg(common, ANI, "ver %d.%d opmode %u chan %d Mhz\n",\r\nah->hw_version.macVersion,\r\nah->hw_version.macRev,\r\nah->opmode,\r\nchan->channel);\r\nval = REG_READ(ah, AR_PHY_SFCORR);\r\niniDef->m1Thresh = MS(val, AR_PHY_SFCORR_M1_THRESH);\r\niniDef->m2Thresh = MS(val, AR_PHY_SFCORR_M2_THRESH);\r\niniDef->m2CountThr = MS(val, AR_PHY_SFCORR_M2COUNT_THR);\r\nval = REG_READ(ah, AR_PHY_SFCORR_LOW);\r\niniDef->m1ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M1_THRESH_LOW);\r\niniDef->m2ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M2_THRESH_LOW);\r\niniDef->m2CountThrLow = MS(val, AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW);\r\nval = REG_READ(ah, AR_PHY_SFCORR_EXT);\r\niniDef->m1ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH);\r\niniDef->m2ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH);\r\niniDef->m1ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH_LOW);\r\niniDef->m2ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH_LOW);\r\niniDef->firstep = REG_READ_FIELD(ah,\r\nAR_PHY_FIND_SIG,\r\nAR_PHY_FIND_SIG_FIRSTEP);\r\niniDef->firstepLow = REG_READ_FIELD(ah,\r\nAR_PHY_FIND_SIG_LOW,\r\nAR_PHY_FIND_SIG_FIRSTEP_LOW);\r\niniDef->cycpwrThr1 = REG_READ_FIELD(ah,\r\nAR_PHY_TIMING5,\r\nAR_PHY_TIMING5_CYCPWR_THR1);\r\niniDef->cycpwrThr1Ext = REG_READ_FIELD(ah,\r\nAR_PHY_EXT_CCA,\r\nAR_PHY_EXT_TIMING5_CYCPWR_THR1);\r\naniState->spurImmunityLevel = ATH9K_ANI_SPUR_IMMUNE_LVL;\r\naniState->firstepLevel = ATH9K_ANI_FIRSTEP_LVL;\r\naniState->ofdmWeakSigDetect = true;\r\naniState->mrcCCK = false;\r\n}\r\nstatic void ar5008_hw_set_nf_limits(struct ath_hw *ah)\r\n{\r\nah->nf_2g.max = AR_PHY_CCA_MAX_GOOD_VAL_5416_2GHZ;\r\nah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_5416_2GHZ;\r\nah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_5416_2GHZ;\r\nah->nf_5g.max = AR_PHY_CCA_MAX_GOOD_VAL_5416_5GHZ;\r\nah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_5416_5GHZ;\r\nah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_5416_5GHZ;\r\n}\r\nstatic void ar5008_hw_set_radar_params(struct ath_hw *ah,\r\nstruct ath_hw_radar_conf *conf)\r\n{\r\nu32 radar_0 = 0, radar_1;\r\nif (!conf) {\r\nREG_CLR_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_ENA);\r\nreturn;\r\n}\r\nradar_0 |= AR_PHY_RADAR_0_ENA | AR_PHY_RADAR_0_FFT_ENA;\r\nradar_0 |= SM(conf->fir_power, AR_PHY_RADAR_0_FIRPWR);\r\nradar_0 |= SM(conf->radar_rssi, AR_PHY_RADAR_0_RRSSI);\r\nradar_0 |= SM(conf->pulse_height, AR_PHY_RADAR_0_HEIGHT);\r\nradar_0 |= SM(conf->pulse_rssi, AR_PHY_RADAR_0_PRSSI);\r\nradar_0 |= SM(conf->pulse_inband, AR_PHY_RADAR_0_INBAND);\r\nradar_1 = REG_READ(ah, AR_PHY_RADAR_1);\r\nradar_1 &= ~(AR_PHY_RADAR_1_MAXLEN | AR_PHY_RADAR_1_RELSTEP_THRESH |\r\nAR_PHY_RADAR_1_RELPWR_THRESH);\r\nradar_1 |= AR_PHY_RADAR_1_MAX_RRSSI;\r\nradar_1 |= AR_PHY_RADAR_1_BLOCK_CHECK;\r\nradar_1 |= SM(conf->pulse_maxlen, AR_PHY_RADAR_1_MAXLEN);\r\nradar_1 |= SM(conf->pulse_inband_step, AR_PHY_RADAR_1_RELSTEP_THRESH);\r\nradar_1 |= SM(conf->radar_inband, AR_PHY_RADAR_1_RELPWR_THRESH);\r\nREG_WRITE(ah, AR_PHY_RADAR_0, radar_0);\r\nREG_WRITE(ah, AR_PHY_RADAR_1, radar_1);\r\nif (conf->ext_channel)\r\nREG_SET_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\r\n}\r\nstatic void ar5008_hw_set_radar_conf(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_radar_conf *conf = &ah->radar_conf;\r\nconf->fir_power = -33;\r\nconf->radar_rssi = 20;\r\nconf->pulse_height = 10;\r\nconf->pulse_rssi = 15;\r\nconf->pulse_inband = 15;\r\nconf->pulse_maxlen = 255;\r\nconf->pulse_inband_step = 12;\r\nconf->radar_inband = 8;\r\n}\r\nstatic void ar5008_hw_init_txpower_cck(struct ath_hw *ah, int16_t *rate_array)\r\n{\r\n#define CCK_DELTA(x) ((OLC_FOR_AR9280_20_LATER) ? max((x) - 2, 0) : (x))\r\nah->tx_power[0] = CCK_DELTA(rate_array[rate1l]);\r\nah->tx_power[1] = CCK_DELTA(min(rate_array[rate2l],\r\nrate_array[rate2s]));\r\nah->tx_power[2] = CCK_DELTA(min(rate_array[rate5_5l],\r\nrate_array[rate5_5s]));\r\nah->tx_power[3] = CCK_DELTA(min(rate_array[rate11l],\r\nrate_array[rate11s]));\r\n#undef CCK_DELTA\r\n}\r\nstatic void ar5008_hw_init_txpower_ofdm(struct ath_hw *ah, int16_t *rate_array,\r\nint offset)\r\n{\r\nint i, idx = 0;\r\nfor (i = offset; i < offset + AR5008_OFDM_RATES; i++) {\r\nah->tx_power[i] = rate_array[idx];\r\nidx++;\r\n}\r\n}\r\nstatic void ar5008_hw_init_txpower_ht(struct ath_hw *ah, int16_t *rate_array,\r\nint ss_offset, int ds_offset,\r\nbool is_40, int ht40_delta)\r\n{\r\nint i, mcs_idx = (is_40) ? AR5008_HT40_SHIFT : AR5008_HT20_SHIFT;\r\nfor (i = ss_offset; i < ss_offset + AR5008_HT_SS_RATES; i++) {\r\nah->tx_power[i] = rate_array[mcs_idx] + ht40_delta;\r\nmcs_idx++;\r\n}\r\nmemcpy(&ah->tx_power[ds_offset], &ah->tx_power[ss_offset],\r\nAR5008_HT_SS_RATES);\r\n}\r\nvoid ar5008_hw_init_rate_txpower(struct ath_hw *ah, int16_t *rate_array,\r\nstruct ath9k_channel *chan, int ht40_delta)\r\n{\r\nif (IS_CHAN_5GHZ(chan)) {\r\nar5008_hw_init_txpower_ofdm(ah, rate_array,\r\nAR5008_11NA_OFDM_SHIFT);\r\nif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\r\nar5008_hw_init_txpower_ht(ah, rate_array,\r\nAR5008_11NA_HT_SS_SHIFT,\r\nAR5008_11NA_HT_DS_SHIFT,\r\nIS_CHAN_HT40(chan),\r\nht40_delta);\r\n}\r\n} else {\r\nar5008_hw_init_txpower_cck(ah, rate_array);\r\nar5008_hw_init_txpower_ofdm(ah, rate_array,\r\nAR5008_11NG_OFDM_SHIFT);\r\nif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\r\nar5008_hw_init_txpower_ht(ah, rate_array,\r\nAR5008_11NG_HT_SS_SHIFT,\r\nAR5008_11NG_HT_DS_SHIFT,\r\nIS_CHAN_HT40(chan),\r\nht40_delta);\r\n}\r\n}\r\n}\r\nint ar5008_hw_attach_phy_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\r\nstatic const u32 ar5416_cca_regs[6] = {\r\nAR_PHY_CCA,\r\nAR_PHY_CH1_CCA,\r\nAR_PHY_CH2_CCA,\r\nAR_PHY_EXT_CCA,\r\nAR_PHY_CH1_EXT_CCA,\r\nAR_PHY_CH2_EXT_CCA\r\n};\r\nint ret;\r\nret = ar5008_hw_rf_alloc_ext_banks(ah);\r\nif (ret)\r\nreturn ret;\r\npriv_ops->rf_set_freq = ar5008_hw_set_channel;\r\npriv_ops->spur_mitigate_freq = ar5008_hw_spur_mitigate;\r\npriv_ops->set_rf_regs = ar5008_hw_set_rf_regs;\r\npriv_ops->set_channel_regs = ar5008_hw_set_channel_regs;\r\npriv_ops->init_bb = ar5008_hw_init_bb;\r\npriv_ops->process_ini = ar5008_hw_process_ini;\r\npriv_ops->set_rfmode = ar5008_hw_set_rfmode;\r\npriv_ops->mark_phy_inactive = ar5008_hw_mark_phy_inactive;\r\npriv_ops->set_delta_slope = ar5008_hw_set_delta_slope;\r\npriv_ops->rfbus_req = ar5008_hw_rfbus_req;\r\npriv_ops->rfbus_done = ar5008_hw_rfbus_done;\r\npriv_ops->restore_chainmask = ar5008_restore_chainmask;\r\npriv_ops->do_getnf = ar5008_hw_do_getnf;\r\npriv_ops->set_radar_params = ar5008_hw_set_radar_params;\r\npriv_ops->ani_control = ar5008_hw_ani_control_new;\r\npriv_ops->ani_cache_ini_regs = ar5008_hw_ani_cache_ini_regs;\r\nif (AR_SREV_9100(ah) || AR_SREV_9160_10_OR_LATER(ah))\r\npriv_ops->compute_pll_control = ar9160_hw_compute_pll_control;\r\nelse\r\npriv_ops->compute_pll_control = ar5008_hw_compute_pll_control;\r\nar5008_hw_set_nf_limits(ah);\r\nar5008_hw_set_radar_conf(ah);\r\nmemcpy(ah->nf_regs, ar5416_cca_regs, sizeof(ah->nf_regs));\r\nreturn 0;\r\n}

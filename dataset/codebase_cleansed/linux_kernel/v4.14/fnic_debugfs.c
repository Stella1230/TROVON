int fnic_debugfs_init(void)\r\n{\r\nint rc = -1;\r\nfnic_trace_debugfs_root = debugfs_create_dir("fnic", NULL);\r\nif (!fnic_trace_debugfs_root) {\r\nprintk(KERN_DEBUG "Cannot create debugfs root\n");\r\nreturn rc;\r\n}\r\nif (!fnic_trace_debugfs_root) {\r\nprintk(KERN_DEBUG\r\n"fnic root directory doesn't exist in debugfs\n");\r\nreturn rc;\r\n}\r\nfnic_stats_debugfs_root = debugfs_create_dir("statistics",\r\nfnic_trace_debugfs_root);\r\nif (!fnic_stats_debugfs_root) {\r\nprintk(KERN_DEBUG "Cannot create Statistics directory\n");\r\nreturn rc;\r\n}\r\nfc_trc_flag = (struct fc_trace_flag_type *)\r\nvmalloc(sizeof(struct fc_trace_flag_type));\r\nif (fc_trc_flag) {\r\nfc_trc_flag->fc_row_file = 0;\r\nfc_trc_flag->fc_normal_file = 1;\r\nfc_trc_flag->fnic_trace = 2;\r\nfc_trc_flag->fc_trace = 3;\r\nfc_trc_flag->fc_clear = 4;\r\n}\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid fnic_debugfs_terminate(void)\r\n{\r\ndebugfs_remove(fnic_stats_debugfs_root);\r\nfnic_stats_debugfs_root = NULL;\r\ndebugfs_remove(fnic_trace_debugfs_root);\r\nfnic_trace_debugfs_root = NULL;\r\nif (fc_trc_flag)\r\nvfree(fc_trc_flag);\r\n}\r\nstatic int fnic_trace_ctrl_open(struct inode *inode, struct file *filp)\r\n{\r\nfilp->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic ssize_t fnic_trace_ctrl_read(struct file *filp,\r\nchar __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nchar buf[64];\r\nint len;\r\nu8 *trace_type;\r\nlen = 0;\r\ntrace_type = (u8 *)filp->private_data;\r\nif (*trace_type == fc_trc_flag->fnic_trace)\r\nlen = sprintf(buf, "%u\n", fnic_tracing_enabled);\r\nelse if (*trace_type == fc_trc_flag->fc_trace)\r\nlen = sprintf(buf, "%u\n", fnic_fc_tracing_enabled);\r\nelse if (*trace_type == fc_trc_flag->fc_clear)\r\nlen = sprintf(buf, "%u\n", fnic_fc_trace_cleared);\r\nelse\r\npr_err("fnic: Cannot read to any debugfs file\n");\r\nreturn simple_read_from_buffer(ubuf, cnt, ppos, buf, len);\r\n}\r\nstatic ssize_t fnic_trace_ctrl_write(struct file *filp,\r\nconst char __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nchar buf[64];\r\nunsigned long val;\r\nint ret;\r\nu8 *trace_type;\r\ntrace_type = (u8 *)filp->private_data;\r\nif (cnt >= sizeof(buf))\r\nreturn -EINVAL;\r\nif (copy_from_user(&buf, ubuf, cnt))\r\nreturn -EFAULT;\r\nbuf[cnt] = 0;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (*trace_type == fc_trc_flag->fnic_trace)\r\nfnic_tracing_enabled = val;\r\nelse if (*trace_type == fc_trc_flag->fc_trace)\r\nfnic_fc_tracing_enabled = val;\r\nelse if (*trace_type == fc_trc_flag->fc_clear)\r\nfnic_fc_trace_cleared = val;\r\nelse\r\npr_err("fnic: cannot write to any debugfs file\n");\r\n(*ppos)++;\r\nreturn cnt;\r\n}\r\nstatic int fnic_trace_debugfs_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt;\r\nu8 *rdata_ptr;\r\nrdata_ptr = (u8 *)inode->i_private;\r\nfnic_dbg_prt = kzalloc(sizeof(fnic_dbgfs_t), GFP_KERNEL);\r\nif (!fnic_dbg_prt)\r\nreturn -ENOMEM;\r\nif (*rdata_ptr == fc_trc_flag->fnic_trace) {\r\nfnic_dbg_prt->buffer = vmalloc(3 *\r\n(trace_max_pages * PAGE_SIZE));\r\nif (!fnic_dbg_prt->buffer) {\r\nkfree(fnic_dbg_prt);\r\nreturn -ENOMEM;\r\n}\r\nmemset((void *)fnic_dbg_prt->buffer, 0,\r\n3 * (trace_max_pages * PAGE_SIZE));\r\nfnic_dbg_prt->buffer_len = fnic_get_trace_data(fnic_dbg_prt);\r\n} else {\r\nfnic_dbg_prt->buffer =\r\nvmalloc(3 * (fnic_fc_trace_max_pages * PAGE_SIZE));\r\nif (!fnic_dbg_prt->buffer) {\r\nkfree(fnic_dbg_prt);\r\nreturn -ENOMEM;\r\n}\r\nmemset((void *)fnic_dbg_prt->buffer, 0,\r\n3 * (fnic_fc_trace_max_pages * PAGE_SIZE));\r\nfnic_dbg_prt->buffer_len =\r\nfnic_fc_trace_get_data(fnic_dbg_prt, *rdata_ptr);\r\n}\r\nfile->private_data = fnic_dbg_prt;\r\nreturn 0;\r\n}\r\nstatic loff_t fnic_trace_debugfs_lseek(struct file *file,\r\nloff_t offset,\r\nint howto)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nreturn fixed_size_llseek(file, offset, howto,\r\nfnic_dbg_prt->buffer_len);\r\n}\r\nstatic ssize_t fnic_trace_debugfs_read(struct file *file,\r\nchar __user *ubuf,\r\nsize_t nbytes,\r\nloff_t *pos)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nint rc = 0;\r\nrc = simple_read_from_buffer(ubuf, nbytes, pos,\r\nfnic_dbg_prt->buffer,\r\nfnic_dbg_prt->buffer_len);\r\nreturn rc;\r\n}\r\nstatic int fnic_trace_debugfs_release(struct inode *inode,\r\nstruct file *file)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nvfree(fnic_dbg_prt->buffer);\r\nkfree(fnic_dbg_prt);\r\nreturn 0;\r\n}\r\nint fnic_trace_debugfs_init(void)\r\n{\r\nint rc = -1;\r\nif (!fnic_trace_debugfs_root) {\r\nprintk(KERN_DEBUG\r\n"FNIC Debugfs root directory doesn't exist\n");\r\nreturn rc;\r\n}\r\nfnic_trace_enable = debugfs_create_file("tracing_enable",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fnic_trace),\r\n&fnic_trace_ctrl_fops);\r\nif (!fnic_trace_enable) {\r\nprintk(KERN_DEBUG\r\n"Cannot create trace_enable file under debugfs\n");\r\nreturn rc;\r\n}\r\nfnic_trace_debugfs_file = debugfs_create_file("trace",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fnic_trace),\r\n&fnic_trace_debugfs_fops);\r\nif (!fnic_trace_debugfs_file) {\r\nprintk(KERN_DEBUG\r\n"Cannot create trace file under debugfs\n");\r\nreturn rc;\r\n}\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid fnic_trace_debugfs_terminate(void)\r\n{\r\ndebugfs_remove(fnic_trace_debugfs_file);\r\nfnic_trace_debugfs_file = NULL;\r\ndebugfs_remove(fnic_trace_enable);\r\nfnic_trace_enable = NULL;\r\n}\r\nint fnic_fc_trace_debugfs_init(void)\r\n{\r\nint rc = -1;\r\nif (!fnic_trace_debugfs_root) {\r\npr_err("fnic:Debugfs root directory doesn't exist\n");\r\nreturn rc;\r\n}\r\nfnic_fc_trace_enable = debugfs_create_file("fc_trace_enable",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fc_trace),\r\n&fnic_trace_ctrl_fops);\r\nif (!fnic_fc_trace_enable) {\r\npr_err("fnic: Failed create fc_trace_enable file\n");\r\nreturn rc;\r\n}\r\nfnic_fc_trace_clear = debugfs_create_file("fc_trace_clear",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fc_clear),\r\n&fnic_trace_ctrl_fops);\r\nif (!fnic_fc_trace_clear) {\r\npr_err("fnic: Failed to create fc_trace_enable file\n");\r\nreturn rc;\r\n}\r\nfnic_fc_rdata_trace_debugfs_file =\r\ndebugfs_create_file("fc_trace_rdata",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fc_normal_file),\r\n&fnic_trace_debugfs_fops);\r\nif (!fnic_fc_rdata_trace_debugfs_file) {\r\npr_err("fnic: Failed create fc_rdata_trace file\n");\r\nreturn rc;\r\n}\r\nfnic_fc_trace_debugfs_file =\r\ndebugfs_create_file("fc_trace",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\n&(fc_trc_flag->fc_row_file),\r\n&fnic_trace_debugfs_fops);\r\nif (!fnic_fc_trace_debugfs_file) {\r\npr_err("fnic: Failed to create fc_trace file\n");\r\nreturn rc;\r\n}\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid fnic_fc_trace_debugfs_terminate(void)\r\n{\r\ndebugfs_remove(fnic_fc_trace_debugfs_file);\r\nfnic_fc_trace_debugfs_file = NULL;\r\ndebugfs_remove(fnic_fc_rdata_trace_debugfs_file);\r\nfnic_fc_rdata_trace_debugfs_file = NULL;\r\ndebugfs_remove(fnic_fc_trace_enable);\r\nfnic_fc_trace_enable = NULL;\r\ndebugfs_remove(fnic_fc_trace_clear);\r\nfnic_fc_trace_clear = NULL;\r\n}\r\nstatic int fnic_reset_stats_open(struct inode *inode, struct file *file)\r\n{\r\nstruct stats_debug_info *debug;\r\ndebug = kzalloc(sizeof(struct stats_debug_info), GFP_KERNEL);\r\nif (!debug)\r\nreturn -ENOMEM;\r\ndebug->i_private = inode->i_private;\r\nfile->private_data = debug;\r\nreturn 0;\r\n}\r\nstatic ssize_t fnic_reset_stats_read(struct file *file,\r\nchar __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nstruct stats_debug_info *debug = file->private_data;\r\nstruct fnic *fnic = (struct fnic *)debug->i_private;\r\nchar buf[64];\r\nint len;\r\nlen = sprintf(buf, "%u\n", fnic->reset_stats);\r\nreturn simple_read_from_buffer(ubuf, cnt, ppos, buf, len);\r\n}\r\nstatic ssize_t fnic_reset_stats_write(struct file *file,\r\nconst char __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nstruct stats_debug_info *debug = file->private_data;\r\nstruct fnic *fnic = (struct fnic *)debug->i_private;\r\nstruct fnic_stats *stats = &fnic->fnic_stats;\r\nu64 *io_stats_p = (u64 *)&stats->io_stats;\r\nu64 *fw_stats_p = (u64 *)&stats->fw_stats;\r\nchar buf[64];\r\nunsigned long val;\r\nint ret;\r\nif (cnt >= sizeof(buf))\r\nreturn -EINVAL;\r\nif (copy_from_user(&buf, ubuf, cnt))\r\nreturn -EFAULT;\r\nbuf[cnt] = 0;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nfnic->reset_stats = val;\r\nif (fnic->reset_stats) {\r\natomic64_set(&fnic->io_cmpl_skip,\r\natomic64_read(&stats->io_stats.active_ios));\r\nmemset(&stats->abts_stats, 0, sizeof(struct abort_stats));\r\nmemset(&stats->term_stats, 0,\r\nsizeof(struct terminate_stats));\r\nmemset(&stats->reset_stats, 0, sizeof(struct reset_stats));\r\nmemset(&stats->misc_stats, 0, sizeof(struct misc_stats));\r\nmemset(&stats->vlan_stats, 0, sizeof(struct vlan_stats));\r\nmemset(io_stats_p+1, 0,\r\nsizeof(struct io_path_stats) - sizeof(u64));\r\nmemset(fw_stats_p+1, 0,\r\nsizeof(struct fw_stats) - sizeof(u64));\r\ngetnstimeofday(&stats->stats_timestamps.last_reset_time);\r\n}\r\n(*ppos)++;\r\nreturn cnt;\r\n}\r\nstatic int fnic_reset_stats_release(struct inode *inode,\r\nstruct file *file)\r\n{\r\nstruct stats_debug_info *debug = file->private_data;\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nstatic int fnic_stats_debugfs_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nstruct fnic *fnic = inode->i_private;\r\nstruct fnic_stats *fnic_stats = &fnic->fnic_stats;\r\nstruct stats_debug_info *debug;\r\nint buf_size = 2 * PAGE_SIZE;\r\ndebug = kzalloc(sizeof(struct stats_debug_info), GFP_KERNEL);\r\nif (!debug)\r\nreturn -ENOMEM;\r\ndebug->debug_buffer = vmalloc(buf_size);\r\nif (!debug->debug_buffer) {\r\nkfree(debug);\r\nreturn -ENOMEM;\r\n}\r\ndebug->buf_size = buf_size;\r\nmemset((void *)debug->debug_buffer, 0, buf_size);\r\ndebug->buffer_len = fnic_get_stats_data(debug, fnic_stats);\r\nfile->private_data = debug;\r\nreturn 0;\r\n}\r\nstatic ssize_t fnic_stats_debugfs_read(struct file *file,\r\nchar __user *ubuf,\r\nsize_t nbytes,\r\nloff_t *pos)\r\n{\r\nstruct stats_debug_info *debug = file->private_data;\r\nint rc = 0;\r\nrc = simple_read_from_buffer(ubuf, nbytes, pos,\r\ndebug->debug_buffer,\r\ndebug->buffer_len);\r\nreturn rc;\r\n}\r\nstatic int fnic_stats_debugfs_release(struct inode *inode,\r\nstruct file *file)\r\n{\r\nstruct stats_debug_info *debug = file->private_data;\r\nvfree(debug->debug_buffer);\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nint fnic_stats_debugfs_init(struct fnic *fnic)\r\n{\r\nint rc = -1;\r\nchar name[16];\r\nsnprintf(name, sizeof(name), "host%d", fnic->lport->host->host_no);\r\nif (!fnic_stats_debugfs_root) {\r\nprintk(KERN_DEBUG "fnic_stats root doesn't exist\n");\r\nreturn rc;\r\n}\r\nfnic->fnic_stats_debugfs_host = debugfs_create_dir(name,\r\nfnic_stats_debugfs_root);\r\nif (!fnic->fnic_stats_debugfs_host) {\r\nprintk(KERN_DEBUG "Cannot create host directory\n");\r\nreturn rc;\r\n}\r\nfnic->fnic_stats_debugfs_file = debugfs_create_file("stats",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic->fnic_stats_debugfs_host,\r\nfnic,\r\n&fnic_stats_debugfs_fops);\r\nif (!fnic->fnic_stats_debugfs_file) {\r\nprintk(KERN_DEBUG "Cannot create host stats file\n");\r\nreturn rc;\r\n}\r\nfnic->fnic_reset_debugfs_file = debugfs_create_file("reset_stats",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic->fnic_stats_debugfs_host,\r\nfnic,\r\n&fnic_reset_debugfs_fops);\r\nif (!fnic->fnic_reset_debugfs_file) {\r\nprintk(KERN_DEBUG "Cannot create host stats file\n");\r\nreturn rc;\r\n}\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid fnic_stats_debugfs_remove(struct fnic *fnic)\r\n{\r\nif (!fnic)\r\nreturn;\r\ndebugfs_remove(fnic->fnic_stats_debugfs_file);\r\nfnic->fnic_stats_debugfs_file = NULL;\r\ndebugfs_remove(fnic->fnic_reset_debugfs_file);\r\nfnic->fnic_reset_debugfs_file = NULL;\r\ndebugfs_remove(fnic->fnic_stats_debugfs_host);\r\nfnic->fnic_stats_debugfs_host = NULL;\r\n}

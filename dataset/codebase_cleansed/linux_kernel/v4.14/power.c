void\r\nPSvEnablePowerSaving(\r\nstruct vnt_private *priv,\r\nunsigned short wListenInterval\r\n)\r\n{\r\nu16 wAID = priv->current_aid | BIT(14) | BIT(15);\r\nVNSvOutPortW(priv->PortOffset + MAC_REG_PWBT, C_PWBT);\r\nif (priv->op_mode != NL80211_IFTYPE_ADHOC) {\r\nVNSvOutPortW(priv->PortOffset + MAC_REG_AIDATIM, wAID);\r\n} else {\r\n#if 0\r\nMACvWriteATIMW(priv->PortOffset, pMgmt->wCurrATIMWindow);\r\n#endif\r\n}\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_PSCFG, PSCFG_AUTOSLEEP);\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_TFTCTL, TFTCTL_HWUTSF);\r\nif (wListenInterval >= 2) {\r\nMACvRegBitsOff(priv->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_PSCTL, PSCTL_LNBCN);\r\n} else {\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\n}\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_PSCTL, PSCTL_PSEN);\r\npriv->bEnablePSMode = true;\r\npriv->bPWBitOn = true;\r\npr_debug("PS:Power Saving Mode Enable...\n");\r\n}\r\nvoid\r\nPSvDisablePowerSaving(\r\nstruct vnt_private *priv\r\n)\r\n{\r\nMACbPSWakeup(priv);\r\nMACvRegBitsOff(priv->PortOffset, MAC_REG_PSCFG, PSCFG_AUTOSLEEP);\r\nMACvRegBitsOff(priv->PortOffset, MAC_REG_TFTCTL, TFTCTL_HWUTSF);\r\nMACvRegBitsOn(priv->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\npriv->bEnablePSMode = false;\r\npriv->bPWBitOn = false;\r\n}\r\nbool\r\nPSbIsNextTBTTWakeUp(\r\nstruct vnt_private *priv\r\n)\r\n{\r\nstruct ieee80211_hw *hw = priv->hw;\r\nstruct ieee80211_conf *conf = &hw->conf;\r\nbool wake_up = false;\r\nif (conf->listen_interval > 1) {\r\nif (!priv->wake_up_count)\r\npriv->wake_up_count = conf->listen_interval;\r\n--priv->wake_up_count;\r\nif (priv->wake_up_count == 1) {\r\nMACvRegBitsOn(priv->PortOffset,\r\nMAC_REG_PSCTL, PSCTL_LNBCN);\r\nwake_up = true;\r\n}\r\n}\r\nreturn wake_up;\r\n}

static u32 __init r2p2(u32 num)\r\n{\r\nint i = 31;\r\nu32 tmp = num;\r\nif (num == 0)\r\nreturn 0;\r\ndo {\r\nif (tmp & (1 << 31))\r\nbreak;\r\ni--;\r\ntmp <<= 1;\r\n} while (i >= 0);\r\ntmp = 1 << i;\r\nif (tmp != num)\r\ntmp <<= 1;\r\nreturn tmp;\r\n}\r\nstatic irqreturn_t pcish5_err_irq(int irq, void *dev_id)\r\n{\r\nstruct pt_regs *regs = get_irq_regs();\r\nunsigned pci_int, pci_air, pci_cir, pci_aint;\r\npci_int = SH5PCI_READ(INT);\r\npci_cir = SH5PCI_READ(CIR);\r\npci_air = SH5PCI_READ(AIR);\r\nif (pci_int) {\r\nprintk("PCI INTERRUPT (at %08llx)!\n", regs->pc);\r\nprintk("PCI INT -> 0x%x\n", pci_int & 0xffff);\r\nprintk("PCI AIR -> 0x%x\n", pci_air);\r\nprintk("PCI CIR -> 0x%x\n", pci_cir);\r\nSH5PCI_WRITE(INT, ~0);\r\n}\r\npci_aint = SH5PCI_READ(AINT);\r\nif (pci_aint) {\r\nprintk("PCI ARB INTERRUPT!\n");\r\nprintk("PCI AINT -> 0x%x\n", pci_aint);\r\nprintk("PCI AIR -> 0x%x\n", pci_air);\r\nprintk("PCI CIR -> 0x%x\n", pci_cir);\r\nSH5PCI_WRITE(AINT, ~0);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t pcish5_serr_irq(int irq, void *dev_id)\r\n{\r\nprintk("SERR IRQ\n");\r\nreturn IRQ_NONE;\r\n}\r\nstatic int __init sh5pci_init(void)\r\n{\r\nunsigned long memStart = __pa(memory_start);\r\nunsigned long memSize = __pa(memory_end) - memStart;\r\nu32 lsr0;\r\nu32 uval;\r\nif (request_irq(IRQ_ERR, pcish5_err_irq,\r\n0, "PCI Error",NULL) < 0) {\r\nprintk(KERN_ERR "PCISH5: Cannot hook PCI_PERR interrupt\n");\r\nreturn -EINVAL;\r\n}\r\nif (request_irq(IRQ_SERR, pcish5_serr_irq,\r\n0, "PCI SERR interrupt", NULL) < 0) {\r\nprintk(KERN_ERR "PCISH5: Cannot hook PCI_SERR interrupt\n");\r\nreturn -EINVAL;\r\n}\r\npcicr_virt = (unsigned long)ioremap_nocache(SH5PCI_ICR_BASE, 1024);\r\nif (!pcicr_virt) {\r\npanic("Unable to remap PCICR\n");\r\n}\r\nPCI_IO_AREA = (unsigned long)ioremap_nocache(SH5PCI_IO_BASE, 0x10000);\r\nif (!PCI_IO_AREA) {\r\npanic("Unable to remap PCIIO\n");\r\n}\r\nSH5PCI_WRITE(CSCR0, 0);\r\nSH5PCI_WRITE(CSCR1, 0);\r\nSH5PCI_WRITE(INTM, 0);\r\nSH5PCI_WRITE(AINTM, 0);\r\nSH5PCI_WRITE(PINTM, 0);\r\nuval = SH5PCI_READ(CR);\r\nSH5PCI_WRITE(CR, uval | CR_LOCK_MASK | CR_CFINT| CR_FTO | CR_PFE |\r\nCR_PFCS | CR_BMAM);\r\nuval=SH5PCI_READ(CR);\r\nSH5PCI_WRITE_SHORT(CSR_CMD,\r\nPCI_COMMAND_MEMORY | PCI_COMMAND_MASTER |\r\nPCI_COMMAND_WAIT);\r\nSH5PCI_WRITE(MBR,0x40000000);\r\nSH5PCI_WRITE(MBMR, PCISH5_MEM_SIZCONV(512*1024*1024));\r\nSH5PCI_WRITE(IOBR,0x0);\r\nSH5PCI_WRITE(IOBMR,0);\r\nSH5PCI_WRITE(CSR_IBAR0,~0);\r\nmemSize = memory_end - memory_start;\r\nif (memSize < (1024 * 1024)) {\r\nprintk(KERN_ERR "PCISH5: Ridiculous memory size of 0x%lx?\n",\r\nmemSize);\r\nreturn -EINVAL;\r\n}\r\nlsr0 = (memSize > (512 * 1024 * 1024)) ? 0x1ff00001 :\r\n((r2p2(memSize) - 0x100000) | 0x1);\r\nSH5PCI_WRITE(LSR0, lsr0);\r\nSH5PCI_WRITE(CSR_MBAR0, memory_start);\r\nSH5PCI_WRITE(LAR0, memory_start);\r\nSH5PCI_WRITE(CSR_MBAR1,0);\r\nSH5PCI_WRITE(LAR1,0);\r\nSH5PCI_WRITE(LSR1,0);\r\nSH5PCI_WRITE(INTM, ~0);\r\nSH5PCI_WRITE(AINTM, ~0);\r\nSH5PCI_WRITE(PINTM, ~0);\r\nsh5_pci_resources[0].start = PCI_IO_AREA;\r\nsh5_pci_resources[0].end = PCI_IO_AREA + 0x10000;\r\nsh5_pci_resources[1].start = memStart;\r\nsh5_pci_resources[1].end = memStart + memSize;\r\nreturn register_pci_controller(&sh5pci_controller);\r\n}

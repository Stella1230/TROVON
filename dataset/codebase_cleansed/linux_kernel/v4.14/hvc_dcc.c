static int hvc_dcc_put_chars(uint32_t vt, const char *buf, int count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; i++) {\r\nwhile (__dcc_getstatus() & DCC_STATUS_TX)\r\ncpu_relax();\r\n__dcc_putchar(buf[i]);\r\n}\r\nreturn count;\r\n}\r\nstatic int hvc_dcc_get_chars(uint32_t vt, char *buf, int count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; ++i)\r\nif (__dcc_getstatus() & DCC_STATUS_RX)\r\nbuf[i] = __dcc_getchar();\r\nelse\r\nbreak;\r\nreturn i;\r\n}\r\nstatic bool hvc_dcc_check(void)\r\n{\r\nunsigned long time = jiffies + (HZ / 10);\r\n__dcc_putchar('\n');\r\nwhile (time_is_after_jiffies(time)) {\r\nif (!(__dcc_getstatus() & DCC_STATUS_TX))\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int __init hvc_dcc_console_init(void)\r\n{\r\nint ret;\r\nif (!hvc_dcc_check())\r\nreturn -ENODEV;\r\nret = hvc_instantiate(0, 0, &hvc_dcc_get_put_ops);\r\nreturn ret < 0 ? -ENODEV : 0;\r\n}\r\nstatic int __init hvc_dcc_init(void)\r\n{\r\nstruct hvc_struct *p;\r\nif (!hvc_dcc_check())\r\nreturn -ENODEV;\r\np = hvc_alloc(0, 0, &hvc_dcc_get_put_ops, 128);\r\nreturn PTR_ERR_OR_ZERO(p);\r\n}

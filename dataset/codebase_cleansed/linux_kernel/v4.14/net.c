int tipc_net_start(struct net *net, u32 addr)\r\n{\r\nstruct tipc_net *tn = net_generic(net, tipc_net_id);\r\nchar addr_string[16];\r\ntn->own_addr = addr;\r\nsmp_mb();\r\ntipc_named_reinit(net);\r\ntipc_sk_reinit(net);\r\ntipc_nametbl_publish(net, TIPC_CFG_SRV, tn->own_addr, tn->own_addr,\r\nTIPC_ZONE_SCOPE, 0, tn->own_addr);\r\npr_info("Started in network mode\n");\r\npr_info("Own node address %s, network identity %u\n",\r\ntipc_addr_string_fill(addr_string, tn->own_addr),\r\ntn->net_id);\r\nreturn 0;\r\n}\r\nvoid tipc_net_stop(struct net *net)\r\n{\r\nstruct tipc_net *tn = net_generic(net, tipc_net_id);\r\nif (!tn->own_addr)\r\nreturn;\r\ntipc_nametbl_withdraw(net, TIPC_CFG_SRV, tn->own_addr, 0,\r\ntn->own_addr);\r\nrtnl_lock();\r\ntipc_bearer_stop(net);\r\ntipc_node_stop(net);\r\nrtnl_unlock();\r\npr_info("Left network mode\n");\r\n}\r\nstatic int __tipc_nl_add_net(struct net *net, struct tipc_nl_msg *msg)\r\n{\r\nstruct tipc_net *tn = net_generic(net, tipc_net_id);\r\nvoid *hdr;\r\nstruct nlattr *attrs;\r\nhdr = genlmsg_put(msg->skb, msg->portid, msg->seq, &tipc_genl_family,\r\nNLM_F_MULTI, TIPC_NL_NET_GET);\r\nif (!hdr)\r\nreturn -EMSGSIZE;\r\nattrs = nla_nest_start(msg->skb, TIPC_NLA_NET);\r\nif (!attrs)\r\ngoto msg_full;\r\nif (nla_put_u32(msg->skb, TIPC_NLA_NET_ID, tn->net_id))\r\ngoto attr_msg_full;\r\nnla_nest_end(msg->skb, attrs);\r\ngenlmsg_end(msg->skb, hdr);\r\nreturn 0;\r\nattr_msg_full:\r\nnla_nest_cancel(msg->skb, attrs);\r\nmsg_full:\r\ngenlmsg_cancel(msg->skb, hdr);\r\nreturn -EMSGSIZE;\r\n}\r\nint tipc_nl_net_dump(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nint err;\r\nint done = cb->args[0];\r\nstruct tipc_nl_msg msg;\r\nif (done)\r\nreturn 0;\r\nmsg.skb = skb;\r\nmsg.portid = NETLINK_CB(cb->skb).portid;\r\nmsg.seq = cb->nlh->nlmsg_seq;\r\nerr = __tipc_nl_add_net(net, &msg);\r\nif (err)\r\ngoto out;\r\ndone = 1;\r\nout:\r\ncb->args[0] = done;\r\nreturn skb->len;\r\n}\r\nint tipc_nl_net_set(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct tipc_net *tn = net_generic(net, tipc_net_id);\r\nstruct nlattr *attrs[TIPC_NLA_NET_MAX + 1];\r\nint err;\r\nif (!info->attrs[TIPC_NLA_NET])\r\nreturn -EINVAL;\r\nerr = nla_parse_nested(attrs, TIPC_NLA_NET_MAX,\r\ninfo->attrs[TIPC_NLA_NET], tipc_nl_net_policy,\r\ninfo->extack);\r\nif (err)\r\nreturn err;\r\nif (attrs[TIPC_NLA_NET_ID]) {\r\nu32 val;\r\nif (tn->own_addr)\r\nreturn -EPERM;\r\nval = nla_get_u32(attrs[TIPC_NLA_NET_ID]);\r\nif (val < 1 || val > 9999)\r\nreturn -EINVAL;\r\ntn->net_id = val;\r\n}\r\nif (attrs[TIPC_NLA_NET_ADDR]) {\r\nu32 addr;\r\nif (tn->own_addr)\r\nreturn -EPERM;\r\naddr = nla_get_u32(attrs[TIPC_NLA_NET_ADDR]);\r\nif (!tipc_addr_node_valid(addr))\r\nreturn -EINVAL;\r\nrtnl_lock();\r\ntipc_net_start(net, addr);\r\nrtnl_unlock();\r\n}\r\nreturn 0;\r\n}

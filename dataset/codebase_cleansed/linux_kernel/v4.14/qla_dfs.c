static int\r\nqla2x00_dfs_tgt_sess_show(struct seq_file *s, void *unused)\r\n{\r\nscsi_qla_host_t *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nunsigned long flags;\r\nstruct fc_port *sess = NULL;\r\nstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\r\nseq_printf(s, "%s\n", vha->host_str);\r\nif (tgt) {\r\nseq_puts(s, "Port ID Port Name Handle\n");\r\nspin_lock_irqsave(&ha->tgt.sess_lock, flags);\r\nlist_for_each_entry(sess, &vha->vp_fcports, list)\r\nseq_printf(s, "%02x:%02x:%02x %8phC %d\n",\r\nsess->d_id.b.domain, sess->d_id.b.area,\r\nsess->d_id.b.al_pa, sess->port_name,\r\nsess->loop_id);\r\nspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nqla2x00_dfs_tgt_sess_open(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nreturn single_open(file, qla2x00_dfs_tgt_sess_show, vha);\r\n}\r\nstatic int\r\nqla2x00_dfs_tgt_port_database_show(struct seq_file *s, void *unused)\r\n{\r\nscsi_qla_host_t *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct gid_list_info *gid_list;\r\ndma_addr_t gid_list_dma;\r\nfc_port_t fc_port;\r\nchar *id_iter;\r\nint rc, i;\r\nuint16_t entries, loop_id;\r\nstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\r\nseq_printf(s, "%s\n", vha->host_str);\r\nif (tgt) {\r\ngid_list = dma_alloc_coherent(&ha->pdev->dev,\r\nqla2x00_gid_list_size(ha),\r\n&gid_list_dma, GFP_KERNEL);\r\nif (!gid_list) {\r\nql_dbg(ql_dbg_user, vha, 0x7018,\r\n"DMA allocation failed for %u\n",\r\nqla2x00_gid_list_size(ha));\r\nreturn 0;\r\n}\r\nrc = qla24xx_gidlist_wait(vha, gid_list, gid_list_dma,\r\n&entries);\r\nif (rc != QLA_SUCCESS)\r\ngoto out_free_id_list;\r\nid_iter = (char *)gid_list;\r\nseq_puts(s, "Port Name Port ID Loop ID\n");\r\nfor (i = 0; i < entries; i++) {\r\nstruct gid_list_info *gid =\r\n(struct gid_list_info *)id_iter;\r\nloop_id = le16_to_cpu(gid->loop_id);\r\nmemset(&fc_port, 0, sizeof(fc_port_t));\r\nfc_port.loop_id = loop_id;\r\nrc = qla24xx_gpdb_wait(vha, &fc_port, 0);\r\nseq_printf(s, "%8phC %02x%02x%02x %d\n",\r\nfc_port.port_name, fc_port.d_id.b.domain,\r\nfc_port.d_id.b.area, fc_port.d_id.b.al_pa,\r\nfc_port.loop_id);\r\nid_iter += ha->gid_list_info_size;\r\n}\r\nout_free_id_list:\r\ndma_free_coherent(&ha->pdev->dev, qla2x00_gid_list_size(ha),\r\ngid_list, gid_list_dma);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nqla2x00_dfs_tgt_port_database_open(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nreturn single_open(file, qla2x00_dfs_tgt_port_database_show, vha);\r\n}\r\nstatic int\r\nqla_dfs_fw_resource_cnt_show(struct seq_file *s, void *unused)\r\n{\r\nstruct scsi_qla_host *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nseq_puts(s, "FW Resource count\n\n");\r\nseq_printf(s, "Original TGT exchg count[%d]\n",\r\nha->orig_fw_tgt_xcb_count);\r\nseq_printf(s, "current TGT exchg count[%d]\n",\r\nha->cur_fw_tgt_xcb_count);\r\nseq_printf(s, "original Initiator Exchange count[%d]\n",\r\nha->orig_fw_xcb_count);\r\nseq_printf(s, "Current Initiator Exchange count[%d]\n",\r\nha->cur_fw_xcb_count);\r\nseq_printf(s, "Original IOCB count[%d]\n", ha->orig_fw_iocb_count);\r\nseq_printf(s, "Current IOCB count[%d]\n", ha->cur_fw_iocb_count);\r\nseq_printf(s, "MAX VP count[%d]\n", ha->max_npiv_vports);\r\nseq_printf(s, "MAX FCF count[%d]\n", ha->fw_max_fcf_count);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla_dfs_fw_resource_cnt_open(struct inode *inode, struct file *file)\r\n{\r\nstruct scsi_qla_host *vha = inode->i_private;\r\nreturn single_open(file, qla_dfs_fw_resource_cnt_show, vha);\r\n}\r\nstatic int\r\nqla_dfs_tgt_counters_show(struct seq_file *s, void *unused)\r\n{\r\nstruct scsi_qla_host *vha = s->private;\r\nstruct qla_qpair *qpair = vha->hw->base_qpair;\r\nuint64_t qla_core_sbt_cmd, core_qla_que_buf, qla_core_ret_ctio,\r\ncore_qla_snd_status, qla_core_ret_sta_ctio, core_qla_free_cmd,\r\nnum_q_full_sent, num_alloc_iocb_failed, num_term_xchg_sent;\r\nu16 i;\r\nqla_core_sbt_cmd = qpair->tgt_counters.qla_core_sbt_cmd;\r\ncore_qla_que_buf = qpair->tgt_counters.core_qla_que_buf;\r\nqla_core_ret_ctio = qpair->tgt_counters.qla_core_ret_ctio;\r\ncore_qla_snd_status = qpair->tgt_counters.core_qla_snd_status;\r\nqla_core_ret_sta_ctio = qpair->tgt_counters.qla_core_ret_sta_ctio;\r\ncore_qla_free_cmd = qpair->tgt_counters.core_qla_free_cmd;\r\nnum_q_full_sent = qpair->tgt_counters.num_q_full_sent;\r\nnum_alloc_iocb_failed = qpair->tgt_counters.num_alloc_iocb_failed;\r\nnum_term_xchg_sent = qpair->tgt_counters.num_term_xchg_sent;\r\nfor (i = 0; i < vha->hw->max_qpairs; i++) {\r\nqpair = vha->hw->queue_pair_map[i];\r\nqla_core_sbt_cmd += qpair->tgt_counters.qla_core_sbt_cmd;\r\ncore_qla_que_buf += qpair->tgt_counters.core_qla_que_buf;\r\nqla_core_ret_ctio += qpair->tgt_counters.qla_core_ret_ctio;\r\ncore_qla_snd_status += qpair->tgt_counters.core_qla_snd_status;\r\nqla_core_ret_sta_ctio +=\r\nqpair->tgt_counters.qla_core_ret_sta_ctio;\r\ncore_qla_free_cmd += qpair->tgt_counters.core_qla_free_cmd;\r\nnum_q_full_sent += qpair->tgt_counters.num_q_full_sent;\r\nnum_alloc_iocb_failed +=\r\nqpair->tgt_counters.num_alloc_iocb_failed;\r\nnum_term_xchg_sent += qpair->tgt_counters.num_term_xchg_sent;\r\n}\r\nseq_puts(s, "Target Counters\n");\r\nseq_printf(s, "qla_core_sbt_cmd = %lld\n",\r\nqla_core_sbt_cmd);\r\nseq_printf(s, "qla_core_ret_sta_ctio = %lld\n",\r\nqla_core_ret_sta_ctio);\r\nseq_printf(s, "qla_core_ret_ctio = %lld\n",\r\nqla_core_ret_ctio);\r\nseq_printf(s, "core_qla_que_buf = %lld\n",\r\ncore_qla_que_buf);\r\nseq_printf(s, "core_qla_snd_status = %lld\n",\r\ncore_qla_snd_status);\r\nseq_printf(s, "core_qla_free_cmd = %lld\n",\r\ncore_qla_free_cmd);\r\nseq_printf(s, "num alloc iocb failed = %lld\n",\r\nnum_alloc_iocb_failed);\r\nseq_printf(s, "num term exchange sent = %lld\n",\r\nnum_term_xchg_sent);\r\nseq_printf(s, "num Q full sent = %lld\n",\r\nnum_q_full_sent);\r\nseq_printf(s, "DIF Inp Bytes = %lld\n",\r\nvha->qla_stats.qla_dif_stats.dif_input_bytes);\r\nseq_printf(s, "DIF Outp Bytes = %lld\n",\r\nvha->qla_stats.qla_dif_stats.dif_output_bytes);\r\nseq_printf(s, "DIF Inp Req = %lld\n",\r\nvha->qla_stats.qla_dif_stats.dif_input_requests);\r\nseq_printf(s, "DIF Outp Req = %lld\n",\r\nvha->qla_stats.qla_dif_stats.dif_output_requests);\r\nseq_printf(s, "DIF Guard err = %d\n",\r\nvha->qla_stats.qla_dif_stats.dif_guard_err);\r\nseq_printf(s, "DIF Ref tag err = %d\n",\r\nvha->qla_stats.qla_dif_stats.dif_ref_tag_err);\r\nseq_printf(s, "DIF App tag err = %d\n",\r\nvha->qla_stats.qla_dif_stats.dif_app_tag_err);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla_dfs_tgt_counters_open(struct inode *inode, struct file *file)\r\n{\r\nstruct scsi_qla_host *vha = inode->i_private;\r\nreturn single_open(file, qla_dfs_tgt_counters_show, vha);\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_show(struct seq_file *s, void *unused)\r\n{\r\nscsi_qla_host_t *vha = s->private;\r\nuint32_t cnt;\r\nuint32_t *fce;\r\nuint64_t fce_start;\r\nstruct qla_hw_data *ha = vha->hw;\r\nmutex_lock(&ha->fce_mutex);\r\nseq_puts(s, "FCE Trace Buffer\n");\r\nseq_printf(s, "In Pointer = %llx\n\n", (unsigned long long)ha->fce_wr);\r\nseq_printf(s, "Base = %llx\n\n", (unsigned long long) ha->fce_dma);\r\nseq_puts(s, "FCE Enable Registers\n");\r\nseq_printf(s, "%08x %08x %08x %08x %08x %08x\n",\r\nha->fce_mb[0], ha->fce_mb[2], ha->fce_mb[3], ha->fce_mb[4],\r\nha->fce_mb[5], ha->fce_mb[6]);\r\nfce = (uint32_t *) ha->fce;\r\nfce_start = (unsigned long long) ha->fce_dma;\r\nfor (cnt = 0; cnt < fce_calc_size(ha->fce_bufs) / 4; cnt++) {\r\nif (cnt % 8 == 0)\r\nseq_printf(s, "\n%llx: ",\r\n(unsigned long long)((cnt * 4) + fce_start));\r\nelse\r\nseq_putc(s, ' ');\r\nseq_printf(s, "%08x", *fce++);\r\n}\r\nseq_puts(s, "\nEnd\n");\r\nmutex_unlock(&ha->fce_mutex);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_open(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nint rval;\r\nif (!ha->flags.fce_enabled)\r\ngoto out;\r\nmutex_lock(&ha->fce_mutex);\r\nrval = qla2x00_disable_fce_trace(vha, &ha->fce_wr, &ha->fce_rd);\r\nif (rval)\r\nql_dbg(ql_dbg_user, vha, 0x705c,\r\n"DebugFS: Unable to disable FCE (%d).\n", rval);\r\nha->flags.fce_enabled = 0;\r\nmutex_unlock(&ha->fce_mutex);\r\nout:\r\nreturn single_open(file, qla2x00_dfs_fce_show, vha);\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_release(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nint rval;\r\nif (ha->flags.fce_enabled)\r\ngoto out;\r\nmutex_lock(&ha->fce_mutex);\r\nha->flags.fce_enabled = 1;\r\nmemset(ha->fce, 0, fce_calc_size(ha->fce_bufs));\r\nrval = qla2x00_enable_fce_trace(vha, ha->fce_dma, ha->fce_bufs,\r\nha->fce_mb, &ha->fce_bufs);\r\nif (rval) {\r\nql_dbg(ql_dbg_user, vha, 0x700d,\r\n"DebugFS: Unable to reinitialize FCE (%d).\n", rval);\r\nha->flags.fce_enabled = 0;\r\n}\r\nmutex_unlock(&ha->fce_mutex);\r\nout:\r\nreturn single_release(inode, file);\r\n}\r\nstatic int\r\nqla_dfs_naqp_show(struct seq_file *s, void *unused)\r\n{\r\nstruct scsi_qla_host *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nseq_printf(s, "%d\n", ha->tgt.num_act_qpairs);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla_dfs_naqp_open(struct inode *inode, struct file *file)\r\n{\r\nstruct scsi_qla_host *vha = inode->i_private;\r\nreturn single_open(file, qla_dfs_naqp_show, vha);\r\n}\r\nstatic ssize_t\r\nqla_dfs_naqp_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\nstruct seq_file *s = file->private_data;\r\nstruct scsi_qla_host *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nchar *buf;\r\nint rc = 0;\r\nunsigned long num_act_qp;\r\nif (!(IS_QLA27XX(ha) || IS_QLA83XX(ha))) {\r\npr_err("host%ld: this adapter does not support Multi Q.",\r\nvha->host_no);\r\nreturn -EINVAL;\r\n}\r\nif (!vha->flags.qpairs_available) {\r\npr_err("host%ld: Driver is not setup with Multi Q.",\r\nvha->host_no);\r\nreturn -EINVAL;\r\n}\r\nbuf = memdup_user_nul(buffer, count);\r\nif (IS_ERR(buf)) {\r\npr_err("host%ld: fail to copy user buffer.",\r\nvha->host_no);\r\nreturn PTR_ERR(buf);\r\n}\r\nnum_act_qp = simple_strtoul(buf, NULL, 0);\r\nif (num_act_qp >= vha->hw->max_qpairs) {\r\npr_err("User set invalid number of qpairs %lu. Max = %d",\r\nnum_act_qp, vha->hw->max_qpairs);\r\nrc = -EINVAL;\r\ngoto out_free;\r\n}\r\nif (num_act_qp != ha->tgt.num_act_qpairs) {\r\nha->tgt.num_act_qpairs = num_act_qp;\r\nqlt_clr_qp_table(vha);\r\n}\r\nrc = count;\r\nout_free:\r\nkfree(buf);\r\nreturn rc;\r\n}\r\nint\r\nqla2x00_dfs_setup(scsi_qla_host_t *vha)\r\n{\r\nstruct qla_hw_data *ha = vha->hw;\r\nif (!IS_QLA25XX(ha) && !IS_QLA81XX(ha) && !IS_QLA83XX(ha) &&\r\n!IS_QLA27XX(ha))\r\ngoto out;\r\nif (!ha->fce)\r\ngoto out;\r\nif (qla2x00_dfs_root)\r\ngoto create_dir;\r\natomic_set(&qla2x00_dfs_root_count, 0);\r\nqla2x00_dfs_root = debugfs_create_dir(QLA2XXX_DRIVER_NAME, NULL);\r\nif (!qla2x00_dfs_root) {\r\nql_log(ql_log_warn, vha, 0x00f7,\r\n"Unable to create debugfs root directory.\n");\r\ngoto out;\r\n}\r\ncreate_dir:\r\nif (ha->dfs_dir)\r\ngoto create_nodes;\r\nmutex_init(&ha->fce_mutex);\r\nha->dfs_dir = debugfs_create_dir(vha->host_str, qla2x00_dfs_root);\r\nif (!ha->dfs_dir) {\r\nql_log(ql_log_warn, vha, 0x00f8,\r\n"Unable to create debugfs ha directory.\n");\r\ngoto out;\r\n}\r\natomic_inc(&qla2x00_dfs_root_count);\r\ncreate_nodes:\r\nha->dfs_fw_resource_cnt = debugfs_create_file("fw_resource_count",\r\nS_IRUSR, ha->dfs_dir, vha, &dfs_fw_resource_cnt_ops);\r\nif (!ha->dfs_fw_resource_cnt) {\r\nql_log(ql_log_warn, vha, 0x00fd,\r\n"Unable to create debugFS fw_resource_count node.\n");\r\ngoto out;\r\n}\r\nha->dfs_tgt_counters = debugfs_create_file("tgt_counters", S_IRUSR,\r\nha->dfs_dir, vha, &dfs_tgt_counters_ops);\r\nif (!ha->dfs_tgt_counters) {\r\nql_log(ql_log_warn, vha, 0xd301,\r\n"Unable to create debugFS tgt_counters node.\n");\r\ngoto out;\r\n}\r\nha->tgt.dfs_tgt_port_database = debugfs_create_file("tgt_port_database",\r\nS_IRUSR, ha->dfs_dir, vha, &dfs_tgt_port_database_ops);\r\nif (!ha->tgt.dfs_tgt_port_database) {\r\nql_log(ql_log_warn, vha, 0xd03f,\r\n"Unable to create debugFS tgt_port_database node.\n");\r\ngoto out;\r\n}\r\nha->dfs_fce = debugfs_create_file("fce", S_IRUSR, ha->dfs_dir, vha,\r\n&dfs_fce_ops);\r\nif (!ha->dfs_fce) {\r\nql_log(ql_log_warn, vha, 0x00f9,\r\n"Unable to create debugfs fce node.\n");\r\ngoto out;\r\n}\r\nha->tgt.dfs_tgt_sess = debugfs_create_file("tgt_sess",\r\nS_IRUSR, ha->dfs_dir, vha, &dfs_tgt_sess_ops);\r\nif (!ha->tgt.dfs_tgt_sess) {\r\nql_log(ql_log_warn, vha, 0xd040,\r\n"Unable to create debugFS tgt_sess node.\n");\r\ngoto out;\r\n}\r\nif (IS_QLA27XX(ha) || IS_QLA83XX(ha)) {\r\nha->tgt.dfs_naqp = debugfs_create_file("naqp",\r\n0400, ha->dfs_dir, vha, &dfs_naqp_ops);\r\nif (!ha->tgt.dfs_naqp) {\r\nql_log(ql_log_warn, vha, 0xd011,\r\n"Unable to create debugFS naqp node.\n");\r\ngoto out;\r\n}\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nqla2x00_dfs_remove(scsi_qla_host_t *vha)\r\n{\r\nstruct qla_hw_data *ha = vha->hw;\r\nif (ha->tgt.dfs_naqp) {\r\ndebugfs_remove(ha->tgt.dfs_naqp);\r\nha->tgt.dfs_naqp = NULL;\r\n}\r\nif (ha->tgt.dfs_tgt_sess) {\r\ndebugfs_remove(ha->tgt.dfs_tgt_sess);\r\nha->tgt.dfs_tgt_sess = NULL;\r\n}\r\nif (ha->tgt.dfs_tgt_port_database) {\r\ndebugfs_remove(ha->tgt.dfs_tgt_port_database);\r\nha->tgt.dfs_tgt_port_database = NULL;\r\n}\r\nif (ha->dfs_fw_resource_cnt) {\r\ndebugfs_remove(ha->dfs_fw_resource_cnt);\r\nha->dfs_fw_resource_cnt = NULL;\r\n}\r\nif (ha->dfs_tgt_counters) {\r\ndebugfs_remove(ha->dfs_tgt_counters);\r\nha->dfs_tgt_counters = NULL;\r\n}\r\nif (ha->dfs_fce) {\r\ndebugfs_remove(ha->dfs_fce);\r\nha->dfs_fce = NULL;\r\n}\r\nif (ha->dfs_dir) {\r\ndebugfs_remove(ha->dfs_dir);\r\nha->dfs_dir = NULL;\r\natomic_dec(&qla2x00_dfs_root_count);\r\n}\r\nif (atomic_read(&qla2x00_dfs_root_count) == 0 &&\r\nqla2x00_dfs_root) {\r\ndebugfs_remove(qla2x00_dfs_root);\r\nqla2x00_dfs_root = NULL;\r\n}\r\nreturn 0;\r\n}

void\r\nqedi_dbg_host_init(struct qedi_dbg_ctx *qedi,\r\nstruct qedi_debugfs_ops *dops,\r\nconst struct file_operations *fops)\r\n{\r\nchar host_dirname[32];\r\nstruct dentry *file_dentry = NULL;\r\nsprintf(host_dirname, "host%u", qedi->host_no);\r\nqedi->bdf_dentry = debugfs_create_dir(host_dirname, qedi_dbg_root);\r\nif (!qedi->bdf_dentry)\r\nreturn;\r\nwhile (dops) {\r\nif (!(dops->name))\r\nbreak;\r\nfile_dentry = debugfs_create_file(dops->name, 0600,\r\nqedi->bdf_dentry, qedi,\r\nfops);\r\nif (!file_dentry) {\r\nQEDI_INFO(qedi, QEDI_LOG_DEBUGFS,\r\n"Debugfs entry %s creation failed\n",\r\ndops->name);\r\ndebugfs_remove_recursive(qedi->bdf_dentry);\r\nreturn;\r\n}\r\ndops++;\r\nfops++;\r\n}\r\n}\r\nvoid\r\nqedi_dbg_host_exit(struct qedi_dbg_ctx *qedi)\r\n{\r\ndebugfs_remove_recursive(qedi->bdf_dentry);\r\nqedi->bdf_dentry = NULL;\r\n}\r\nvoid\r\nqedi_dbg_init(char *drv_name)\r\n{\r\nqedi_dbg_root = debugfs_create_dir(drv_name, NULL);\r\nif (!qedi_dbg_root)\r\nQEDI_INFO(NULL, QEDI_LOG_DEBUGFS, "Init of debugfs failed\n");\r\n}\r\nvoid\r\nqedi_dbg_exit(void)\r\n{\r\ndebugfs_remove_recursive(qedi_dbg_root);\r\nqedi_dbg_root = NULL;\r\n}\r\nstatic ssize_t\r\nqedi_dbg_do_not_recover_enable(struct qedi_dbg_ctx *qedi_dbg)\r\n{\r\nif (!qedi_do_not_recover)\r\nqedi_do_not_recover = 1;\r\nQEDI_INFO(qedi_dbg, QEDI_LOG_DEBUGFS, "do_not_recover=%d\n",\r\nqedi_do_not_recover);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nqedi_dbg_do_not_recover_disable(struct qedi_dbg_ctx *qedi_dbg)\r\n{\r\nif (qedi_do_not_recover)\r\nqedi_do_not_recover = 0;\r\nQEDI_INFO(qedi_dbg, QEDI_LOG_DEBUGFS, "do_not_recover=%d\n",\r\nqedi_do_not_recover);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nqedi_dbg_do_not_recover_cmd_write(struct file *filp, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nsize_t cnt = 0;\r\nstruct qedi_dbg_ctx *qedi_dbg =\r\n(struct qedi_dbg_ctx *)filp->private_data;\r\nstruct qedi_list_of_funcs *lof = qedi_dbg_do_not_recover_ops;\r\nif (*ppos)\r\nreturn 0;\r\nwhile (lof) {\r\nif (!(lof->oper_str))\r\nbreak;\r\nif (!strncmp(lof->oper_str, buffer, strlen(lof->oper_str))) {\r\ncnt = lof->oper_func(qedi_dbg);\r\nbreak;\r\n}\r\nlof++;\r\n}\r\nreturn (count - cnt);\r\n}\r\nstatic ssize_t\r\nqedi_dbg_do_not_recover_cmd_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nsize_t cnt = 0;\r\nif (*ppos)\r\nreturn 0;\r\ncnt = sprintf(buffer, "do_not_recover=%d\n", qedi_do_not_recover);\r\ncnt = min_t(int, count, cnt - *ppos);\r\n*ppos += cnt;\r\nreturn cnt;\r\n}\r\nstatic int\r\nqedi_gbl_ctx_show(struct seq_file *s, void *unused)\r\n{\r\nstruct qedi_fastpath *fp = NULL;\r\nstruct qed_sb_info *sb_info = NULL;\r\nstruct status_block *sb = NULL;\r\nstruct global_queue *que = NULL;\r\nint id;\r\nu16 prod_idx;\r\nstruct qedi_ctx *qedi = s->private;\r\nunsigned long flags;\r\nseq_puts(s, " DUMP CQ CONTEXT:\n");\r\nfor (id = 0; id < MIN_NUM_CPUS_MSIX(qedi); id++) {\r\nspin_lock_irqsave(&qedi->hba_lock, flags);\r\nseq_printf(s, "=========FAST CQ PATH [%d] ==========\n", id);\r\nfp = &qedi->fp_array[id];\r\nsb_info = fp->sb_info;\r\nsb = sb_info->sb_virt;\r\nprod_idx = (sb->pi_array[QEDI_PROTO_CQ_PROD_IDX] &\r\nSTATUS_BLOCK_PROD_INDEX_MASK);\r\nseq_printf(s, "SB PROD IDX: %d\n", prod_idx);\r\nque = qedi->global_queues[fp->sb_id];\r\nseq_printf(s, "DRV CONS IDX: %d\n", que->cq_cons_idx);\r\nseq_printf(s, "CQ complete host memory: %d\n", fp->sb_id);\r\nseq_puts(s, "=========== END ==================\n\n\n");\r\nspin_unlock_irqrestore(&qedi->hba_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nqedi_dbg_gbl_ctx_open(struct inode *inode, struct file *file)\r\n{\r\nstruct qedi_dbg_ctx *qedi_dbg = inode->i_private;\r\nstruct qedi_ctx *qedi = container_of(qedi_dbg, struct qedi_ctx,\r\ndbg_ctx);\r\nreturn single_open(file, qedi_gbl_ctx_show, qedi);\r\n}\r\nstatic int\r\nqedi_io_trace_show(struct seq_file *s, void *unused)\r\n{\r\nint id, idx = 0;\r\nstruct qedi_ctx *qedi = s->private;\r\nstruct qedi_io_log *io_log;\r\nunsigned long flags;\r\nseq_puts(s, " DUMP IO LOGS:\n");\r\nspin_lock_irqsave(&qedi->io_trace_lock, flags);\r\nidx = qedi->io_trace_idx;\r\nfor (id = 0; id < QEDI_IO_TRACE_SIZE; id++) {\r\nio_log = &qedi->io_trace_buf[idx];\r\nseq_printf(s, "iodir-%d:", io_log->direction);\r\nseq_printf(s, "tid-0x%x:", io_log->task_id);\r\nseq_printf(s, "cid-0x%x:", io_log->cid);\r\nseq_printf(s, "lun-%d:", io_log->lun);\r\nseq_printf(s, "op-0x%02x:", io_log->op);\r\nseq_printf(s, "0x%02x%02x%02x%02x:", io_log->lba[0],\r\nio_log->lba[1], io_log->lba[2], io_log->lba[3]);\r\nseq_printf(s, "buflen-%d:", io_log->bufflen);\r\nseq_printf(s, "sgcnt-%d:", io_log->sg_count);\r\nseq_printf(s, "res-0x%08x:", io_log->result);\r\nseq_printf(s, "jif-%lu:", io_log->jiffies);\r\nseq_printf(s, "blk_req_cpu-%d:", io_log->blk_req_cpu);\r\nseq_printf(s, "req_cpu-%d:", io_log->req_cpu);\r\nseq_printf(s, "intr_cpu-%d:", io_log->intr_cpu);\r\nseq_printf(s, "blk_rsp_cpu-%d\n", io_log->blk_rsp_cpu);\r\nidx++;\r\nif (idx == QEDI_IO_TRACE_SIZE)\r\nidx = 0;\r\n}\r\nspin_unlock_irqrestore(&qedi->io_trace_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nqedi_dbg_io_trace_open(struct inode *inode, struct file *file)\r\n{\r\nstruct qedi_dbg_ctx *qedi_dbg = inode->i_private;\r\nstruct qedi_ctx *qedi = container_of(qedi_dbg, struct qedi_ctx,\r\ndbg_ctx);\r\nreturn single_open(file, qedi_io_trace_show, qedi);\r\n}

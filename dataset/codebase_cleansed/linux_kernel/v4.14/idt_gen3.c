static int\r\nidtg3_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 route_port)\r\n{\r\nu32 rval;\r\nu32 entry = route_port;\r\nint err = 0;\r\npr_debug("RIO: %s t=0x%x did_%x to p_%x\n",\r\n__func__, table, route_destid, entry);\r\nif (route_destid > 0xFF)\r\nreturn -EINVAL;\r\nif (route_port == RIO_INVALID_ROUTE)\r\nentry = RIO_RT_ENTRY_DROP_PKT;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nerr = rio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_BC_L2_Gn_ENTRYx_CSR(0, route_destid),\r\nentry);\r\nreturn err;\r\n}\r\nerr = rio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_SWP_INFO_CAR, &rval);\r\nif (err)\r\nreturn err;\r\nif (table >= RIO_GET_TOTAL_PORTS(rval))\r\nreturn -EINVAL;\r\nerr = rio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_SPx_L2_Gn_ENTRYy_CSR(table, 0, route_destid),\r\nentry);\r\nreturn err;\r\n}\r\nstatic int\r\nidtg3_route_get_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 *route_port)\r\n{\r\nu32 rval;\r\nint err;\r\nif (route_destid > 0xFF)\r\nreturn -EINVAL;\r\nerr = rio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_SWP_INFO_CAR, &rval);\r\nif (err)\r\nreturn err;\r\nif (table == RIO_GLOBAL_TABLE)\r\ntable = RIO_GET_PORT_NUM(rval);\r\nelse if (table >= RIO_GET_TOTAL_PORTS(rval))\r\nreturn -EINVAL;\r\nerr = rio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_SPx_L2_Gn_ENTRYy_CSR(table, 0, route_destid),\r\n&rval);\r\nif (err)\r\nreturn err;\r\nif (rval == RIO_RT_ENTRY_DROP_PKT)\r\n*route_port = RIO_INVALID_ROUTE;\r\nelse\r\n*route_port = (u8)rval;\r\nreturn 0;\r\n}\r\nstatic int\r\nidtg3_route_clr_table(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table)\r\n{\r\nu32 i;\r\nu32 rval;\r\nint err;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nfor (i = 0; i <= 0xff; i++) {\r\nerr = rio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_BC_L2_Gn_ENTRYx_CSR(0, i),\r\nRIO_RT_ENTRY_DROP_PKT);\r\nif (err)\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nerr = rio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_SWP_INFO_CAR, &rval);\r\nif (err)\r\nreturn err;\r\nif (table >= RIO_GET_TOTAL_PORTS(rval))\r\nreturn -EINVAL;\r\nfor (i = 0; i <= 0xff; i++) {\r\nerr = rio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_SPx_L2_Gn_ENTRYy_CSR(table, 0, i),\r\nRIO_RT_ENTRY_DROP_PKT);\r\nif (err)\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int\r\nidtg3_em_init(struct rio_dev *rdev)\r\n{\r\nint i, tmp;\r\nu32 rval;\r\npr_debug("RIO: %s [%d:%d]\n", __func__, rdev->destid, rdev->hopcount);\r\nrio_write_config_32(rdev, RIO_EM_DEV_INT_EN, 0);\r\nrio_write_config_32(rdev, rdev->em_efptr + RIO_EM_PW_TX_CTRL,\r\nRIO_EM_PW_TX_CTRL_PW_DIS);\r\ntmp = RIO_GET_TOTAL_PORTS(rdev->swpinfo);\r\nfor (i = 0; i < tmp; i++) {\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_ERR_STS_CSR(rdev, i),\r\n&rval);\r\nif (rval & RIO_PORT_N_ERR_STS_PORT_UA)\r\ncontinue;\r\nrio_write_config_32(rdev,\r\nrdev->em_efptr + RIO_EM_PN_ERR_DETECT(i), 0);\r\nrio_write_config_32(rdev,\r\nrdev->em_efptr + RIO_EM_PN_ERRRATE_EN(i),\r\nRIO_EM_PN_ERRRATE_EN_OK2U | RIO_EM_PN_ERRRATE_EN_U2OK);\r\nrio_write_config_32(rdev, RIO_PLM_SPx_PW_EN(i),\r\nRIO_PLM_SPx_PW_EN_OK2U | RIO_PLM_SPx_PW_EN_LINIT);\r\n}\r\ntmp = RIO_GET_PORT_NUM(rdev->swpinfo);\r\nrio_write_config_32(rdev, RIO_PW_ROUTE, 1 << tmp);\r\nrio_write_config_32(rdev, rdev->em_efptr + RIO_EM_PW_TX_CTRL, 0);\r\nrio_write_config_32(rdev,\r\nrdev->phys_efptr + RIO_PORT_LINKTO_CTL_CSR, 0x8e << 8);\r\nreturn 0;\r\n}\r\nstatic int\r\nidtg3_em_handler(struct rio_dev *rdev, u8 pnum)\r\n{\r\nu32 err_status;\r\nu32 rval;\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_ERR_STS_CSR(rdev, pnum),\r\n&err_status);\r\nif (err_status & RIO_PORT_N_ERR_STS_PORT_UNINIT)\r\nreturn 0;\r\nif (err_status & (RIO_PORT_N_ERR_STS_OUT_ES |\r\nRIO_PORT_N_ERR_STS_INP_ES)) {\r\nrio_read_config_32(rdev, RIO_PLM_SPx_IMP_SPEC_CTL(pnum), &rval);\r\nrio_write_config_32(rdev, RIO_PLM_SPx_IMP_SPEC_CTL(pnum),\r\nrval | RIO_PLM_SPx_IMP_SPEC_CTL_SOFT_RST);\r\nudelay(10);\r\nrio_write_config_32(rdev, RIO_PLM_SPx_IMP_SPEC_CTL(pnum), rval);\r\nmsleep(500);\r\n}\r\nreturn 0;\r\n}\r\nstatic int idtg3_probe(struct rio_dev *rdev, const struct rio_device_id *id)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nspin_lock(&rdev->rswitch->lock);\r\nif (rdev->rswitch->ops) {\r\nspin_unlock(&rdev->rswitch->lock);\r\nreturn -EINVAL;\r\n}\r\nrdev->rswitch->ops = &idtg3_switch_ops;\r\nif (rdev->do_enum) {\r\nrio_write_config_32(rdev, 0x5000 + RIO_BC_RT_CTL_CSR, 0);\r\n}\r\nspin_unlock(&rdev->rswitch->lock);\r\nreturn 0;\r\n}\r\nstatic void idtg3_remove(struct rio_dev *rdev)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nspin_lock(&rdev->rswitch->lock);\r\nif (rdev->rswitch->ops == &idtg3_switch_ops)\r\nrdev->rswitch->ops = NULL;\r\nspin_unlock(&rdev->rswitch->lock);\r\n}\r\nstatic void idtg3_shutdown(struct rio_dev *rdev)\r\n{\r\nint i;\r\nu32 rval;\r\nu16 destid;\r\nif (!rdev->do_enum)\r\nreturn;\r\npr_debug("RIO: %s(%s)\n", __func__, rio_name(rdev));\r\nrio_read_config_32(rdev, RIO_PW_ROUTE, &rval);\r\ni = RIO_GET_PORT_NUM(rdev->swpinfo);\r\nif (!((1 << i) & rval))\r\nreturn;\r\nrio_read_config_32(rdev, rdev->em_efptr + RIO_EM_PW_TGT_DEVID, &rval);\r\nif (rval & RIO_EM_PW_TGT_DEVID_DEV16)\r\ndestid = rval >> 16;\r\nelse\r\ndestid = ((rval & RIO_EM_PW_TGT_DEVID_D8) >> 16);\r\nif (rdev->net->hport->host_deviceid == destid) {\r\nrio_write_config_32(rdev,\r\nrdev->em_efptr + RIO_EM_PW_TX_CTRL, 0);\r\npr_debug("RIO: %s(%s) PW transmission disabled\n",\r\n__func__, rio_name(rdev));\r\n}\r\n}\r\nstatic int __init idtg3_init(void)\r\n{\r\nreturn rio_register_driver(&idtg3_driver);\r\n}\r\nstatic void __exit idtg3_exit(void)\r\n{\r\npr_debug("RIO: %s\n", __func__);\r\nrio_unregister_driver(&idtg3_driver);\r\npr_debug("RIO: %s done\n", __func__);\r\n}

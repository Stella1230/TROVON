void\r\nia_css_circbuf_create(ia_css_circbuf_t *cb,\r\nia_css_circbuf_elem_t *elems,\r\nia_css_circbuf_desc_t *desc)\r\n{\r\nuint32_t i;\r\nOP___assert(desc);\r\ncb->desc = desc;\r\ncb->desc->start = 0;\r\ncb->desc->end = 0;\r\ncb->desc->step = 0;\r\nfor (i = 0; i < cb->desc->size; i++)\r\nia_css_circbuf_elem_init(&elems[i]);\r\ncb->elems = elems;\r\n}\r\nvoid ia_css_circbuf_destroy(ia_css_circbuf_t *cb)\r\n{\r\ncb->desc = NULL;\r\ncb->elems = NULL;\r\n}\r\nuint32_t ia_css_circbuf_pop(ia_css_circbuf_t *cb)\r\n{\r\nuint32_t ret;\r\nia_css_circbuf_elem_t elem;\r\nassert(!ia_css_circbuf_is_empty(cb));\r\nelem = ia_css_circbuf_read(cb);\r\nret = ia_css_circbuf_elem_get_val(&elem);\r\nreturn ret;\r\n}\r\nuint32_t ia_css_circbuf_extract(ia_css_circbuf_t *cb, int offset)\r\n{\r\nint max_offset;\r\nuint32_t val;\r\nuint32_t pos;\r\nuint32_t src_pos;\r\nuint32_t dest_pos;\r\nmax_offset = ia_css_circbuf_get_offset(cb, cb->desc->start, cb->desc->end);\r\nmax_offset--;\r\nif (offset == 0) {\r\nval = ia_css_circbuf_pop(cb);\r\nreturn val;\r\n}\r\nif (offset > max_offset) {\r\nval = 0;\r\nreturn val;\r\n}\r\npos = ia_css_circbuf_get_pos_at_offset(cb, cb->desc->start, offset);\r\nval = ia_css_circbuf_elem_get_val(&cb->elems[pos]);\r\nsrc_pos = ia_css_circbuf_get_pos_at_offset(cb, pos, -1);\r\ndest_pos = pos;\r\nia_css_circbuf_shift_chunk(cb, src_pos, dest_pos);\r\nreturn val;\r\n}\r\nuint32_t ia_css_circbuf_peek(ia_css_circbuf_t *cb, int offset)\r\n{\r\nint pos;\r\npos = ia_css_circbuf_get_pos_at_offset(cb, cb->desc->end, offset);\r\nreturn cb->elems[pos].val;\r\n}\r\nuint32_t ia_css_circbuf_peek_from_start(ia_css_circbuf_t *cb, int offset)\r\n{\r\nint pos;\r\npos = ia_css_circbuf_get_pos_at_offset(cb, cb->desc->start, offset);\r\nreturn cb->elems[pos].val;\r\n}\r\nbool ia_css_circbuf_increase_size(\r\nia_css_circbuf_t *cb,\r\nunsigned int sz_delta,\r\nia_css_circbuf_elem_t *elems)\r\n{\r\nuint8_t curr_size;\r\nuint8_t curr_end;\r\nunsigned int i = 0;\r\nif (!cb || sz_delta == 0)\r\nreturn false;\r\ncurr_size = cb->desc->size;\r\ncurr_end = cb->desc->end;\r\nif (((uint8_t)(cb->desc->size + (uint8_t)sz_delta) > cb->desc->size) && ((uint8_t)sz_delta == sz_delta))\r\ncb->desc->size += (uint8_t)sz_delta;\r\nelse\r\nreturn false;\r\nif (elems) {\r\nfor (i = curr_size; i < cb->desc->size; i++)\r\ncb->elems[i] = elems[i - curr_size];\r\n}\r\nif (curr_end < cb->desc->start) {\r\nif (curr_end == 0) {\r\ncb->desc->end = curr_size;\r\n} else {\r\nia_css_circbuf_shift_chunk(cb,\r\ncurr_size - 1,\r\ncurr_size + sz_delta - 1);\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic inline uint32_t\r\nia_css_circbuf_elem_get_val(ia_css_circbuf_elem_t *elem)\r\n{\r\nreturn elem->val;\r\n}\r\nstatic inline ia_css_circbuf_elem_t\r\nia_css_circbuf_read(ia_css_circbuf_t *cb)\r\n{\r\nia_css_circbuf_elem_t elem;\r\nelem = cb->elems[cb->desc->start];\r\nia_css_circbuf_elem_init(&cb->elems[cb->desc->start]);\r\ncb->desc->start = ia_css_circbuf_get_pos_at_offset(cb, cb->desc->start, 1);\r\nreturn elem;\r\n}\r\nstatic inline void\r\nia_css_circbuf_shift_chunk(ia_css_circbuf_t *cb,\r\nuint32_t chunk_src, uint32_t chunk_dest)\r\n{\r\nint chunk_offset;\r\nint chunk_sz;\r\nint i;\r\nchunk_offset = ia_css_circbuf_get_offset(cb,\r\nchunk_src, chunk_dest);\r\nchunk_sz = ia_css_circbuf_get_offset(cb, cb->desc->start, chunk_src) + 1;\r\nfor (i = 0; i < chunk_sz; i++) {\r\nia_css_circbuf_elem_cpy(&cb->elems[chunk_src],\r\n&cb->elems[chunk_dest]);\r\nia_css_circbuf_elem_init(&cb->elems[chunk_src]);\r\nchunk_src = ia_css_circbuf_get_pos_at_offset(cb, chunk_src, -1);\r\nchunk_dest = ia_css_circbuf_get_pos_at_offset(cb, chunk_dest, -1);\r\n}\r\ncb->desc->start = ia_css_circbuf_get_pos_at_offset(cb, cb->desc->start, chunk_offset);\r\n}

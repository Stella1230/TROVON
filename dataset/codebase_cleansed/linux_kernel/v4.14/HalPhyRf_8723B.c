static void setIqkMatrix_8723B(\r\nPDM_ODM_T pDM_Odm,\r\nu8 OFDM_index,\r\nu8 RFPath,\r\ns32 IqkResult_X,\r\ns32 IqkResult_Y\r\n)\r\n{\r\ns32 ele_A = 0, ele_D, ele_C = 0, value32;\r\nif (OFDM_index >= OFDM_TABLE_SIZE)\r\nOFDM_index = OFDM_TABLE_SIZE-1;\r\nele_D = (OFDMSwingTable_New[OFDM_index] & 0xFFC00000)>>22;\r\nif ((IqkResult_X != 0) && (*(pDM_Odm->pBandType) == ODM_BAND_2_4G)) {\r\nif ((IqkResult_X & 0x00000200) != 0)\r\nIqkResult_X = IqkResult_X | 0xFFFFFC00;\r\nele_A = ((IqkResult_X * ele_D)>>8)&0x000003FF;\r\nif ((IqkResult_Y & 0x00000200) != 0)\r\nIqkResult_Y = IqkResult_Y | 0xFFFFFC00;\r\nele_C = ((IqkResult_Y * ele_D)>>8)&0x000003FF;\r\nswitch (RFPath) {\r\ncase ODM_RF_PATH_A:\r\nvalue32 = (ele_D<<22)|((ele_C&0x3F)<<16)|ele_A;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, bMaskDWord, value32);\r\nvalue32 = (ele_C&0x000003C0)>>6;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XCTxAFE, bMaskH4Bits, value32);\r\nvalue32 = ((IqkResult_X * ele_D)>>7)&0x01;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT24, value32);\r\nbreak;\r\ncase ODM_RF_PATH_B:\r\nvalue32 = (ele_D<<22)|((ele_C&0x3F)<<16)|ele_A;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, bMaskDWord, value32);\r\nvalue32 = (ele_C&0x000003C0)>>6;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XDTxAFE, bMaskH4Bits, value32);\r\nvalue32 = ((IqkResult_X * ele_D)>>7)&0x01;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT28, value32);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nswitch (RFPath) {\r\ncase ODM_RF_PATH_A:\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, bMaskDWord, OFDMSwingTable_New[OFDM_index]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XCTxAFE, bMaskH4Bits, 0x00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT24, 0x00);\r\nbreak;\r\ncase ODM_RF_PATH_B:\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, bMaskDWord, OFDMSwingTable_New[OFDM_index]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XDTxAFE, bMaskH4Bits, 0x00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT28, 0x00);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD, ("TxPwrTracking path B: X = 0x%x, Y = 0x%x ele_A = 0x%x ele_C = 0x%x ele_D = 0x%x 0xeb4 = 0x%x 0xebc = 0x%x\n",\r\n(u32)IqkResult_X, (u32)IqkResult_Y, (u32)ele_A, (u32)ele_C, (u32)ele_D, (u32)IqkResult_X, (u32)IqkResult_Y));\r\n}\r\nstatic void setCCKFilterCoefficient(PDM_ODM_T pDM_Odm, u8 CCKSwingIndex)\r\n{\r\nif (!pDM_Odm->RFCalibrateInfo.bCCKinCH14) {\r\nrtw_write8(pDM_Odm->Adapter, 0xa22, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][0]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa23, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][1]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa24, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][2]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa25, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][3]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa26, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][4]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa27, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][5]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa28, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][6]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa29, CCKSwingTable_Ch1_Ch13_New[CCKSwingIndex][7]);\r\n} else {\r\nrtw_write8(pDM_Odm->Adapter, 0xa22, CCKSwingTable_Ch14_New[CCKSwingIndex][0]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa23, CCKSwingTable_Ch14_New[CCKSwingIndex][1]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa24, CCKSwingTable_Ch14_New[CCKSwingIndex][2]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa25, CCKSwingTable_Ch14_New[CCKSwingIndex][3]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa26, CCKSwingTable_Ch14_New[CCKSwingIndex][4]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa27, CCKSwingTable_Ch14_New[CCKSwingIndex][5]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa28, CCKSwingTable_Ch14_New[CCKSwingIndex][6]);\r\nrtw_write8(pDM_Odm->Adapter, 0xa29, CCKSwingTable_Ch14_New[CCKSwingIndex][7]);\r\n}\r\n}\r\nvoid DoIQK_8723B(\r\nPDM_ODM_T pDM_Odm,\r\nu8 DeltaThermalIndex,\r\nu8 ThermalValue,\r\nu8 Threshold\r\n)\r\n{\r\n}\r\nvoid ODM_TxPwrTrackSetPwr_8723B(\r\nPDM_ODM_T pDM_Odm,\r\nPWRTRACK_METHOD Method,\r\nu8 RFPath,\r\nu8 ChannelMappedIndex\r\n)\r\n{\r\nstruct adapter *Adapter = pDM_Odm->Adapter;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 PwrTrackingLimit_OFDM = 34;\r\nu8 PwrTrackingLimit_CCK = 28;\r\nu8 TxRate = 0xFF;\r\nu8 Final_OFDM_Swing_Index = 0;\r\nu8 Final_CCK_Swing_Index = 0;\r\n{\r\nu16 rate = *(pDM_Odm->pForcedDataRate);\r\nif (!rate) {\r\nif (pDM_Odm->TxRate != 0xFF)\r\nTxRate = HwRateToMRate(pDM_Odm->TxRate);\r\n} else\r\nTxRate = (u8)rate;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD, ("===>ODM_TxPwrTrackSetPwr8723B\n"));\r\nif (TxRate != 0xFF) {\r\nif ((TxRate >= MGN_1M) && (TxRate <= MGN_11M))\r\nPwrTrackingLimit_CCK = 28;\r\nelse if ((TxRate >= MGN_6M) && (TxRate <= MGN_48M))\r\nPwrTrackingLimit_OFDM = 36;\r\nelse if (TxRate == MGN_54M)\r\nPwrTrackingLimit_OFDM = 34;\r\nelse if ((TxRate >= MGN_MCS0) && (TxRate <= MGN_MCS2))\r\nPwrTrackingLimit_OFDM = 38;\r\nelse if ((TxRate >= MGN_MCS3) && (TxRate <= MGN_MCS4))\r\nPwrTrackingLimit_OFDM = 36;\r\nelse if ((TxRate >= MGN_MCS5) && (TxRate <= MGN_MCS7))\r\nPwrTrackingLimit_OFDM = 34;\r\nelse\r\nPwrTrackingLimit_OFDM = pDM_Odm->DefaultOfdmIndex;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD, ("TxRate = 0x%x, PwrTrackingLimit =%d\n", TxRate, PwrTrackingLimit_OFDM));\r\nif (Method == TXAGC) {\r\nstruct adapter *Adapter = pDM_Odm->Adapter;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD, ("odm_TxPwrTrackSetPwr8723B CH =%d\n", *(pDM_Odm->pChannel)));\r\npDM_Odm->Remnant_OFDMSwingIdx[RFPath] = pDM_Odm->Absolute_OFDMSwingIdx[RFPath];\r\npDM_Odm->Modify_TxAGC_Flag_PathA = true;\r\npDM_Odm->Modify_TxAGC_Flag_PathA_CCK = true;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, CCK);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, OFDM);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, HT_MCS0_MCS7);\r\n} else if (Method == BBSWING) {\r\nFinal_OFDM_Swing_Index = pDM_Odm->DefaultOfdmIndex + pDM_Odm->Absolute_OFDMSwingIdx[RFPath];\r\nFinal_CCK_Swing_Index = pDM_Odm->DefaultCckIndex + pDM_Odm->Absolute_OFDMSwingIdx[RFPath];\r\nif (Final_OFDM_Swing_Index >= PwrTrackingLimit_OFDM)\r\nFinal_OFDM_Swing_Index = PwrTrackingLimit_OFDM;\r\nelse if (Final_OFDM_Swing_Index <= 0)\r\nFinal_OFDM_Swing_Index = 0;\r\nif (Final_CCK_Swing_Index >= CCK_TABLE_SIZE)\r\nFinal_CCK_Swing_Index = CCK_TABLE_SIZE-1;\r\nelse if (pDM_Odm->BbSwingIdxCck <= 0)\r\nFinal_CCK_Swing_Index = 0;\r\nsetIqkMatrix_8723B(pDM_Odm, Final_OFDM_Swing_Index, RFPath,\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][0],\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][1]);\r\nsetCCKFilterCoefficient(pDM_Odm, Final_CCK_Swing_Index);\r\n} else if (Method == MIX_MODE) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("pDM_Odm->DefaultOfdmIndex =%d, pDM_Odm->DefaultCCKIndex =%d, pDM_Odm->Absolute_OFDMSwingIdx[RFPath]=%d, RF_Path = %d\n",\r\npDM_Odm->DefaultOfdmIndex, pDM_Odm->DefaultCckIndex, pDM_Odm->Absolute_OFDMSwingIdx[RFPath], RFPath));\r\nFinal_OFDM_Swing_Index = pDM_Odm->DefaultOfdmIndex + pDM_Odm->Absolute_OFDMSwingIdx[RFPath];\r\nFinal_CCK_Swing_Index = pDM_Odm->DefaultCckIndex + pDM_Odm->Absolute_OFDMSwingIdx[RFPath];\r\nif (Final_OFDM_Swing_Index > PwrTrackingLimit_OFDM) {\r\npDM_Odm->Remnant_OFDMSwingIdx[RFPath] = Final_OFDM_Swing_Index - PwrTrackingLimit_OFDM;\r\nsetIqkMatrix_8723B(pDM_Odm, PwrTrackingLimit_OFDM, RFPath,\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][0],\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][1]);\r\npDM_Odm->Modify_TxAGC_Flag_PathA = true;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, OFDM);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, HT_MCS0_MCS7);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A Over BBSwing Limit , PwrTrackingLimit = %d , Remnant TxAGC Value = %d\n",\r\nPwrTrackingLimit_OFDM, pDM_Odm->Remnant_OFDMSwingIdx[RFPath]));\r\n} else if (Final_OFDM_Swing_Index <= 0) {\r\npDM_Odm->Remnant_OFDMSwingIdx[RFPath] = Final_OFDM_Swing_Index;\r\nsetIqkMatrix_8723B(pDM_Odm, 0, RFPath,\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][0],\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][1]);\r\npDM_Odm->Modify_TxAGC_Flag_PathA = true;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, OFDM);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, HT_MCS0_MCS7);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A Lower then BBSwing lower bound 0 , Remnant TxAGC Value = %d\n",\r\npDM_Odm->Remnant_OFDMSwingIdx[RFPath]));\r\n} else {\r\nsetIqkMatrix_8723B(pDM_Odm, Final_OFDM_Swing_Index, RFPath,\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][0],\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[ChannelMappedIndex].Value[0][1]);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A Compensate with BBSwing , Final_OFDM_Swing_Index = %d\n", Final_OFDM_Swing_Index));\r\nif (pDM_Odm->Modify_TxAGC_Flag_PathA) {\r\npDM_Odm->Remnant_OFDMSwingIdx[RFPath] = 0;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, OFDM);\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, HT_MCS0_MCS7);\r\npDM_Odm->Modify_TxAGC_Flag_PathA = false;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A pDM_Odm->Modify_TxAGC_Flag = false\n"));\r\n}\r\n}\r\nif (Final_CCK_Swing_Index > PwrTrackingLimit_CCK) {\r\npDM_Odm->Remnant_CCKSwingIdx = Final_CCK_Swing_Index - PwrTrackingLimit_CCK;\r\nsetCCKFilterCoefficient(pDM_Odm, PwrTrackingLimit_CCK);\r\npDM_Odm->Modify_TxAGC_Flag_PathA_CCK = true;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, CCK);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A CCK Over Limit , PwrTrackingLimit_CCK = %d , pDM_Odm->Remnant_CCKSwingIdx = %d\n", PwrTrackingLimit_CCK, pDM_Odm->Remnant_CCKSwingIdx));\r\n} else if (Final_CCK_Swing_Index <= 0) {\r\npDM_Odm->Remnant_CCKSwingIdx = Final_CCK_Swing_Index;\r\nsetCCKFilterCoefficient(pDM_Odm, 0);\r\npDM_Odm->Modify_TxAGC_Flag_PathA_CCK = true;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, CCK);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A CCK Under Limit , PwrTrackingLimit_CCK = %d , pDM_Odm->Remnant_CCKSwingIdx = %d\n", 0, pDM_Odm->Remnant_CCKSwingIdx));\r\n} else {\r\nsetCCKFilterCoefficient(pDM_Odm, Final_CCK_Swing_Index);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A CCK Compensate with BBSwing , Final_CCK_Swing_Index = %d\n", Final_CCK_Swing_Index));\r\nif (pDM_Odm->Modify_TxAGC_Flag_PathA_CCK) {\r\npDM_Odm->Remnant_CCKSwingIdx = 0;\r\nPHY_SetTxPowerIndexByRateSection(Adapter, RFPath, pHalData->CurrentChannel, CCK);\r\npDM_Odm->Modify_TxAGC_Flag_PathA_CCK = false;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_TX_PWR_TRACK, ODM_DBG_LOUD,\r\n("******Path_A pDM_Odm->Modify_TxAGC_Flag_CCK = false\n"));\r\n}\r\n}\r\n} else\r\nreturn;\r\n}\r\nstatic void GetDeltaSwingTable_8723B(\r\nPDM_ODM_T pDM_Odm,\r\nu8 **TemperatureUP_A,\r\nu8 **TemperatureDOWN_A,\r\nu8 **TemperatureUP_B,\r\nu8 **TemperatureDOWN_B\r\n)\r\n{\r\nstruct adapter *Adapter = pDM_Odm->Adapter;\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu16 rate = *(pDM_Odm->pForcedDataRate);\r\nu8 channel = pHalData->CurrentChannel;\r\nif (1 <= channel && channel <= 14) {\r\nif (IS_CCK_RATE(rate)) {\r\n*TemperatureUP_A = pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKA_P;\r\n*TemperatureDOWN_A = pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKA_N;\r\n*TemperatureUP_B = pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKB_P;\r\n*TemperatureDOWN_B = pRFCalibrateInfo->DeltaSwingTableIdx_2GCCKB_N;\r\n} else {\r\n*TemperatureUP_A = pRFCalibrateInfo->DeltaSwingTableIdx_2GA_P;\r\n*TemperatureDOWN_A = pRFCalibrateInfo->DeltaSwingTableIdx_2GA_N;\r\n*TemperatureUP_B = pRFCalibrateInfo->DeltaSwingTableIdx_2GB_P;\r\n*TemperatureDOWN_B = pRFCalibrateInfo->DeltaSwingTableIdx_2GB_N;\r\n}\r\n} else {\r\n*TemperatureUP_A = (u8 *)DeltaSwingTableIdx_2GA_P_8188E;\r\n*TemperatureDOWN_A = (u8 *)DeltaSwingTableIdx_2GA_N_8188E;\r\n*TemperatureUP_B = (u8 *)DeltaSwingTableIdx_2GA_P_8188E;\r\n*TemperatureDOWN_B = (u8 *)DeltaSwingTableIdx_2GA_N_8188E;\r\n}\r\nreturn;\r\n}\r\nvoid ConfigureTxpowerTrack_8723B(PTXPWRTRACK_CFG pConfig)\r\n{\r\npConfig->SwingTableSize_CCK = CCK_TABLE_SIZE;\r\npConfig->SwingTableSize_OFDM = OFDM_TABLE_SIZE;\r\npConfig->Threshold_IQK = IQK_THRESHOLD;\r\npConfig->AverageThermalNum = AVG_THERMAL_NUM_8723B;\r\npConfig->RfPathCount = MAX_PATH_NUM_8723B;\r\npConfig->ThermalRegAddr = RF_T_METER_8723B;\r\npConfig->ODM_TxPwrTrackSetPwr = ODM_TxPwrTrackSetPwr_8723B;\r\npConfig->DoIQK = DoIQK_8723B;\r\npConfig->PHY_LCCalibrate = PHY_LCCalibrate_8723B;\r\npConfig->GetDeltaSwingTable = GetDeltaSwingTable_8723B;\r\n}\r\nstatic u8 phy_PathA_IQK_8723B(\r\nstruct adapter *padapter, bool configPathB, u8 RF_Path\r\n)\r\n{\r\nu32 regEAC, regE94, regE9C, tmp, Path_SEL_BB ;\r\nu8 result = 0x00;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPath_SEL_BB = PHY_QueryBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A IQK!\n"));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0003f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xc7f87);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, 0x01007c00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x821303ea);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x00462911);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nif (configPathB || (RF_Path == 0))\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000000);\r\nelse\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregE94 = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord);\r\nregE9C = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe94 = 0x%x, 0xe9c = 0x%x\n", regE94, regE9C));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe90(before IQK) = 0x%x, 0xe98(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xe90, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xe98, bMaskDWord)));\r\ntmp = (regE9C & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT28) &&\r\n(((regE94 & 0x03FF0000)>>16) != 0x142) &&\r\n(((regE9C & 0x03FF0000)>>16) != 0x42) &&\r\n(((regE94 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regE94 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x01;\r\nelse\r\nreturn result;\r\nreturn result;\r\n}\r\nstatic u8 phy_PathA_RxIQK8723B(\r\nstruct adapter *padapter, bool configPathB, u8 RF_Path\r\n)\r\n{\r\nu32 regEAC, regE94, regE9C, regEA4, u4tmp, tmp, Path_SEL_BB;\r\nu8 result = 0x00;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPath_SEL_BB = PHY_QueryBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A RX IQK:Get TXIMR setting\n"));\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xf7fb7);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, 0x01007c00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x82130ff0);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x0046a911);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nif (configPathB || (RF_Path == 0))\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000000);\r\nelse\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregE94 = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord);\r\nregE9C = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe94 = 0x%x, 0xe9c = 0x%x\n", regE94, regE9C));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe90(before IQK) = 0x%x, 0xe98(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xe90, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xe98, bMaskDWord)));\r\ntmp = (regE9C & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT28) &&\r\n(((regE94 & 0x03FF0000)>>16) != 0x142) &&\r\n(((regE9C & 0x03FF0000)>>16) != 0x42) &&\r\n(((regE94 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regE94 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x01;\r\nelse\r\nreturn result;\r\nu4tmp = 0x80007C00 | (regE94&0x3FF0000) | ((regE9C&0x3FF0000) >> 16);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, u4tmp);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe40 = 0x%x u4tmp = 0x%x\n", PHY_QueryBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord), u4tmp));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A RX IQK\n"));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xf7d77);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xdf, bRFRegOffsetMask, 0xf80);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x55, bRFRegOffsetMask, 0x4021f);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x2813001f);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x0046a8d1);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nif (configPathB || (RF_Path == 0))\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000000);\r\nelse\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregEA4 = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_Before_IQK_A_2, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xea4 = 0x%x, 0xeac = 0x%x\n", regEA4, regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xea0(before IQK) = 0x%x, 0xea8(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xea0, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xea8, bMaskDWord)));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xdf, bRFRegOffsetMask, 0x780);\r\ntmp = (regEAC & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT27) &&\r\n(((regEA4 & 0x03FF0000)>>16) != 0x132) &&\r\n(((regEAC & 0x03FF0000)>>16) != 0x36) &&\r\n(((regEA4 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regEA4 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x02;\r\nelse\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A Rx IQK fail!!\n"));\r\nreturn result;\r\n}\r\nstatic u8 phy_PathB_IQK_8723B(struct adapter *padapter)\r\n{\r\nu32 regEAC, regE94, regE9C, tmp, Path_SEL_BB;\r\nu8 result = 0x00;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B IQK!\n"));\r\nPath_SEL_BB = PHY_QueryBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xed, 0x20, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x43, bRFRegOffsetMask, 0x30fc1);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, 0x01007c00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x821303ea);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x00462911);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregE94 = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord);\r\nregE9C = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe94 = 0x%x, 0xe9c = 0x%x\n", regE94, regE9C));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe90(before IQK) = 0x%x, 0xe98(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xe90, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xe98, bMaskDWord)));\r\ntmp = (regE9C & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT28) &&\r\n(((regE94 & 0x03FF0000)>>16) != 0x142) &&\r\n(((regE9C & 0x03FF0000)>>16) != 0x42) &&\r\n(((regE94 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regE94 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x01;\r\nreturn result;\r\n}\r\nstatic u8 phy_PathB_RxIQK8723B(struct adapter *padapter, bool configPathB)\r\n{\r\nu32 regE94, regE9C, regEA4, regEAC, u4tmp, tmp, Path_SEL_BB;\r\nu8 result = 0x00;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPath_SEL_BB = PHY_QueryBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B RX IQK:Get TXIMR setting!\n"));\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xf7fb7);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xed, 0x20, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x43, bRFRegOffsetMask, 0x30fcd);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, 0x01007c00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x82130ff0);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x0046a911);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregE94 = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord);\r\nregE9C = PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe94 = 0x%x, 0xe9c = 0x%x\n", regE94, regE9C));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe90(before IQK) = 0x%x, 0xe98(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xe90, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xe98, bMaskDWord)));\r\ntmp = (regE9C & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT28) &&\r\n(((regE94 & 0x03FF0000)>>16) != 0x142) &&\r\n(((regE9C & 0x03FF0000)>>16) != 0x42) &&\r\n(((regE94 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regE94 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x01;\r\nelse\r\nreturn result;\r\nu4tmp = 0x80007C00 | (regE94&0x3FF0000) | ((regE9C&0x3FF0000) >> 16);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord, u4tmp);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xe40 = 0x%x u4tmp = 0x%x\n", PHY_QueryBBReg(pDM_Odm->Adapter, rTx_IQK, bMaskDWord), u4tmp));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B RX IQK\n"));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xf7d77);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xed, 0x20, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x43, bRFRegOffsetMask, 0x30ebd);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK, bMaskDWord, 0x01004800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x18008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_B, bMaskDWord, 0x38008c1c);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_A, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_A, bMaskDWord, 0x2813001f);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_PI_B, bMaskDWord, 0x82110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_PI_B, bMaskDWord, 0x28110000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Rsp, bMaskDWord, 0x0046a8d1);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x808000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, 0x00000280);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00000800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf9000000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rIQK_AGC_Pts, bMaskDWord, 0xf8000000);\r\nmdelay(IQK_DELAY_TIME_8723B);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x948, bMaskDWord, Path_SEL_BB);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, 0x00001800);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nregEAC = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord);\r\nregEA4 = PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_Before_IQK_A_2, bMaskDWord);;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xeac = 0x%x\n", regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xea4 = 0x%x, 0xeac = 0x%x\n", regEA4, regEAC));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("0xea0(before IQK) = 0x%x, 0xea8(afer IQK) = 0x%x\n",\r\nPHY_QueryBBReg(pDM_Odm->Adapter, 0xea0, bMaskDWord), PHY_QueryBBReg(pDM_Odm->Adapter, 0xea8, bMaskDWord)));\r\ntmp = (regEAC & 0x03FF0000)>>16;\r\nif ((tmp & 0x200) > 0)\r\ntmp = 0x400 - tmp;\r\nif (\r\n!(regEAC & BIT27) &&\r\n(((regEA4 & 0x03FF0000)>>16) != 0x132) &&\r\n(((regEAC & 0x03FF0000)>>16) != 0x36) &&\r\n(((regEA4 & 0x03FF0000)>>16) < 0x110) &&\r\n(((regEA4 & 0x03FF0000)>>16) > 0xf0) &&\r\n(tmp < 0xf)\r\n)\r\nresult |= 0x02;\r\nelse\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B Rx IQK fail!!\n"));\r\nreturn result;\r\n}\r\nstatic void _PHY_PathAFillIQKMatrix8723B(\r\nstruct adapter *padapter,\r\nbool bIQKOK,\r\ns32 result[][8],\r\nu8 final_candidate,\r\nbool bTxOnly\r\n)\r\n{\r\nu32 Oldval_0, X, TX0_A, reg;\r\ns32 Y, TX0_C;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A IQ Calibration %s !\n", (bIQKOK)?"Success":"Failed"));\r\nif (final_candidate == 0xFF)\r\nreturn;\r\nelse if (bIQKOK) {\r\nOldval_0 = (PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, bMaskDWord) >> 22) & 0x3FF;\r\nX = result[final_candidate][0];\r\nif ((X & 0x00000200) != 0)\r\nX = X | 0xFFFFFC00;\r\nTX0_A = (X * Oldval_0) >> 8;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("X = 0x%x, TX0_A = 0x%x, Oldval_0 0x%x\n", X, TX0_A, Oldval_0));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, 0x3FF, TX0_A);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT(31), ((X*Oldval_0>>7) & 0x1));\r\nY = result[final_candidate][1];\r\nif ((Y & 0x00000200) != 0)\r\nY = Y | 0xFFFFFC00;\r\nTX0_C = (Y * Oldval_0) >> 8;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Y = 0x%x, TX = 0x%x\n", Y, TX0_C));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XCTxAFE, 0xF0000000, ((TX0_C&0x3C0)>>6));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC94][KEY] = rOFDM0_XCTxAFE;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC94][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XCTxAFE, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, 0x003F0000, (TX0_C&0x3F));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC80][KEY] = rOFDM0_XATxIQImbalance;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC80][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XATxIQImbalance, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT(29), ((Y*Oldval_0>>7) & 0x1));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC4C][KEY] = rOFDM0_ECCAThreshold;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC4C][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskDWord);\r\nif (bTxOnly) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("_PHY_PathAFillIQKMatrix8723B only Tx OK\n"));\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][KEY] = rOFDM0_RxIQExtAnta;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][VAL] = 0xfffffff & PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_RxIQExtAnta, bMaskDWord);\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][KEY] = rOFDM0_XARxIQImbalance;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][VAL] = 0x40000100;\r\nreturn;\r\n}\r\nreg = result[final_candidate][2];\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XARxIQImbalance, 0x3FF, reg);\r\nreg = result[final_candidate][3] & 0x3F;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XARxIQImbalance, 0xFC00, reg);\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][KEY] = rOFDM0_XARxIQImbalance;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XARxIQImbalance, bMaskDWord);\r\nreg = (result[final_candidate][3] >> 6) & 0xF;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_RxIQExtAnta, 0xF0000000, reg);\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][KEY] = rOFDM0_RxIQExtAnta;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_RxIQExtAnta, bMaskDWord);\r\n}\r\n}\r\nstatic void _PHY_PathBFillIQKMatrix8723B(\r\nstruct adapter *padapter,\r\nbool bIQKOK,\r\ns32 result[][8],\r\nu8 final_candidate,\r\nbool bTxOnly\r\n)\r\n{\r\nu32 Oldval_1, X, TX1_A, reg;\r\ns32 Y, TX1_C;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B IQ Calibration %s !\n", (bIQKOK)?"Success":"Failed"));\r\nif (final_candidate == 0xFF)\r\nreturn;\r\nelse if (bIQKOK) {\r\nOldval_1 = (PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, bMaskDWord) >> 22) & 0x3FF;\r\nX = result[final_candidate][4];\r\nif ((X & 0x00000200) != 0)\r\nX = X | 0xFFFFFC00;\r\nTX1_A = (X * Oldval_1) >> 8;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("X = 0x%x, TX1_A = 0x%x\n", X, TX1_A));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, 0x3FF, TX1_A);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT(27), ((X*Oldval_1>>7) & 0x1));\r\nY = result[final_candidate][5];\r\nif ((Y & 0x00000200) != 0)\r\nY = Y | 0xFFFFFC00;\r\nTX1_C = (Y * Oldval_1) >> 8;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Y = 0x%x, TX1_C = 0x%x\n", Y, TX1_C));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XDTxAFE, 0xF0000000, ((TX1_C&0x3C0)>>6));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC94][KEY] = rOFDM0_XCTxAFE;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC94][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XDTxAFE, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, 0x003F0000, (TX1_C&0x3F));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC80][KEY] = rOFDM0_XATxIQImbalance;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC80][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XBTxIQImbalance, bMaskDWord);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, BIT(25), ((Y*Oldval_1>>7) & 0x1));\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC4C][KEY] = rOFDM0_ECCAThreshold;\r\npRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC4C][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskDWord);\r\nif (bTxOnly) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("_PHY_PathBFillIQKMatrix8723B only Tx OK\n"));\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][KEY] = rOFDM0_XARxIQImbalance;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][VAL] = 0x40000100;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][KEY] = rOFDM0_RxIQExtAnta;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][VAL] = 0x0fffffff & PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_RxIQExtAnta, bMaskDWord);\r\nreturn;\r\n}\r\nreg = result[final_candidate][6];\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBRxIQImbalance, 0x3FF, reg);\r\nreg = result[final_candidate][7] & 0x3F;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_XBRxIQImbalance, 0xFC00, reg);\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][KEY] = rOFDM0_XARxIQImbalance;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][VAL] = PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_XBRxIQImbalance, bMaskDWord);\r\nreg = (result[final_candidate][7] >> 6) & 0xF;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][KEY] = rOFDM0_RxIQExtAnta;\r\npRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][VAL] = (reg << 28)|(PHY_QueryBBReg(pDM_Odm->Adapter, rOFDM0_RxIQExtAnta, bMaskDWord)&0x0fffffff);\r\n}\r\n}\r\nvoid ODM_SetIQCbyRFpath(PDM_ODM_T pDM_Odm, u32 RFpath)\r\n{\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\nif (\r\n(pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC80][VAL] != 0x0) &&\r\n(pRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][VAL] != 0x0) &&\r\n(pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC80][VAL] != 0x0) &&\r\n(pRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][VAL] != 0x0)\r\n) {\r\nif (RFpath) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC94][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC94][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC80][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC80][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC4C][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S0][IDX_0xC4C][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][KEY], bMaskDWord, pRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xC14][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][KEY], bMaskDWord, pRFCalibrateInfo->RxIQC_8723B[PATH_S0][IDX_0xCA0][VAL]);\r\n} else {\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC94][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC94][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC80][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC80][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC4C][KEY], bMaskDWord, pRFCalibrateInfo->TxIQC_8723B[PATH_S1][IDX_0xC4C][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][KEY], bMaskDWord, pRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xC14][VAL]);\r\nPHY_SetBBReg(pDM_Odm->Adapter, pRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][KEY], bMaskDWord, pRFCalibrateInfo->RxIQC_8723B[PATH_S1][IDX_0xCA0][VAL]);\r\n}\r\n}\r\n}\r\nstatic bool ODM_CheckPowerStatus(struct adapter *Adapter)\r\n{\r\nreturn true;\r\n}\r\nstatic void _PHY_SaveADDARegisters8723B(\r\nstruct adapter *padapter,\r\nu32 *ADDAReg,\r\nu32 *ADDABackup,\r\nu32 RegisterNum\r\n)\r\n{\r\nu32 i;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nif (ODM_CheckPowerStatus(padapter) == false)\r\nreturn;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Save ADDA parameters.\n"));\r\nfor (i = 0 ; i < RegisterNum ; i++) {\r\nADDABackup[i] = PHY_QueryBBReg(pDM_Odm->Adapter, ADDAReg[i], bMaskDWord);\r\n}\r\n}\r\nstatic void _PHY_SaveMACRegisters8723B(\r\nstruct adapter *padapter, u32 *MACReg, u32 *MACBackup\r\n)\r\n{\r\nu32 i;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Save MAC parameters.\n"));\r\nfor (i = 0 ; i < (IQK_MAC_REG_NUM - 1); i++) {\r\nMACBackup[i] = rtw_read8(pDM_Odm->Adapter, MACReg[i]);\r\n}\r\nMACBackup[i] = rtw_read32(pDM_Odm->Adapter, MACReg[i]);\r\n}\r\nstatic void _PHY_ReloadADDARegisters8723B(\r\nstruct adapter *padapter,\r\nu32 *ADDAReg,\r\nu32 *ADDABackup,\r\nu32 RegiesterNum\r\n)\r\n{\r\nu32 i;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Reload ADDA power saving parameters !\n"));\r\nfor (i = 0 ; i < RegiesterNum; i++) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, ADDAReg[i], bMaskDWord, ADDABackup[i]);\r\n}\r\n}\r\nstatic void _PHY_ReloadMACRegisters8723B(\r\nstruct adapter *padapter, u32 *MACReg, u32 *MACBackup\r\n)\r\n{\r\nu32 i;\r\nfor (i = 0 ; i < (IQK_MAC_REG_NUM - 1); i++) {\r\nrtw_write8(padapter, MACReg[i], (u8)MACBackup[i]);\r\n}\r\nrtw_write32(padapter, MACReg[i], MACBackup[i]);\r\n}\r\nstatic void _PHY_PathADDAOn8723B(\r\nstruct adapter *padapter,\r\nu32 *ADDAReg,\r\nbool isPathAOn,\r\nbool is2T\r\n)\r\n{\r\nu32 pathOn;\r\nu32 i;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("ADDA ON.\n"));\r\npathOn = isPathAOn ? 0x01c00014 : 0x01c00014;\r\nif (false == is2T) {\r\npathOn = 0x01c00014;\r\nPHY_SetBBReg(pDM_Odm->Adapter, ADDAReg[0], bMaskDWord, 0x01c00014);\r\n} else {\r\nPHY_SetBBReg(pDM_Odm->Adapter, ADDAReg[0], bMaskDWord, pathOn);\r\n}\r\nfor (i = 1 ; i < IQK_ADDA_REG_NUM ; i++) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, ADDAReg[i], bMaskDWord, pathOn);\r\n}\r\n}\r\nstatic void _PHY_MACSettingCalibration8723B(\r\nstruct adapter *padapter, u32 *MACReg, u32 *MACBackup\r\n)\r\n{\r\nu32 i = 0;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("MAC settings for Calibration.\n"));\r\nrtw_write8(pDM_Odm->Adapter, MACReg[i], 0x3F);\r\nfor (i = 1 ; i < (IQK_MAC_REG_NUM - 1); i++) {\r\nrtw_write8(pDM_Odm->Adapter, MACReg[i], (u8)(MACBackup[i]&(~BIT3)));\r\n}\r\nrtw_write8(pDM_Odm->Adapter, MACReg[i], (u8)(MACBackup[i]&(~BIT5)));\r\n}\r\nstatic bool phy_SimularityCompare_8723B(\r\nstruct adapter *padapter,\r\ns32 result[][8],\r\nu8 c1,\r\nu8 c2\r\n)\r\n{\r\nu32 i, j, diff, SimularityBitMap, bound = 0;\r\nu8 final_candidate[2] = {0xFF, 0xFF};\r\nbool bResult = true;\r\nbool is2T = true;\r\ns32 tmp1 = 0, tmp2 = 0;\r\nif (is2T)\r\nbound = 8;\r\nelse\r\nbound = 4;\r\nSimularityBitMap = 0;\r\nfor (i = 0; i < bound; i++) {\r\nif ((i == 1) || (i == 3) || (i == 5) || (i == 7)) {\r\nif ((result[c1][i] & 0x00000200) != 0)\r\ntmp1 = result[c1][i] | 0xFFFFFC00;\r\nelse\r\ntmp1 = result[c1][i];\r\nif ((result[c2][i] & 0x00000200) != 0)\r\ntmp2 = result[c2][i] | 0xFFFFFC00;\r\nelse\r\ntmp2 = result[c2][i];\r\n} else {\r\ntmp1 = result[c1][i];\r\ntmp2 = result[c2][i];\r\n}\r\ndiff = (tmp1 > tmp2) ? (tmp1 - tmp2) : (tmp2 - tmp1);\r\nif (diff > MAX_TOLERANCE) {\r\nif ((i == 2 || i == 6) && !SimularityBitMap) {\r\nif (result[c1][i]+result[c1][i+1] == 0)\r\nfinal_candidate[(i/4)] = c2;\r\nelse if (result[c2][i]+result[c2][i+1] == 0)\r\nfinal_candidate[(i/4)] = c1;\r\nelse\r\nSimularityBitMap = SimularityBitMap|(1<<i);\r\n} else\r\nSimularityBitMap = SimularityBitMap|(1<<i);\r\n}\r\n}\r\nif (SimularityBitMap == 0) {\r\nfor (i = 0; i < (bound/4); i++) {\r\nif (final_candidate[i] != 0xFF) {\r\nfor (j = i*4; j < (i+1)*4-2; j++)\r\nresult[3][j] = result[final_candidate[i]][j];\r\nbResult = false;\r\n}\r\n}\r\nreturn bResult;\r\n} else {\r\nif (!(SimularityBitMap & 0x03)) {\r\nfor (i = 0; i < 2; i++)\r\nresult[3][i] = result[c1][i];\r\n}\r\nif (!(SimularityBitMap & 0x0c)) {\r\nfor (i = 2; i < 4; i++)\r\nresult[3][i] = result[c1][i];\r\n}\r\nif (!(SimularityBitMap & 0x30)) {\r\nfor (i = 4; i < 6; i++)\r\nresult[3][i] = result[c1][i];\r\n}\r\nif (!(SimularityBitMap & 0xc0)) {\r\nfor (i = 6; i < 8; i++)\r\nresult[3][i] = result[c1][i];\r\n}\r\nreturn false;\r\n}\r\n}\r\nstatic void phy_IQCalibrate_8723B(\r\nstruct adapter *padapter,\r\ns32 result[][8],\r\nu8 t,\r\nbool is2T,\r\nu8 RF_Path\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\nu32 i;\r\nu8 PathAOK, PathBOK;\r\nu8 tmp0xc50 = (u8)PHY_QueryBBReg(pDM_Odm->Adapter, 0xC50, bMaskByte0);\r\nu8 tmp0xc58 = (u8)PHY_QueryBBReg(pDM_Odm->Adapter, 0xC58, bMaskByte0);\r\nu32 ADDA_REG[IQK_ADDA_REG_NUM] = {\r\nrFPGA0_XCD_SwitchControl,\r\nrBlue_Tooth,\r\nrRx_Wait_CCA,\r\nrTx_CCK_RFON,\r\nrTx_CCK_BBON,\r\nrTx_OFDM_RFON,\r\nrTx_OFDM_BBON,\r\nrTx_To_Rx,\r\nrTx_To_Tx,\r\nrRx_CCK,\r\nrRx_OFDM,\r\nrRx_Wait_RIFS,\r\nrRx_TO_Rx,\r\nrStandby,\r\nrSleep,\r\nrPMPD_ANAEN\r\n};\r\nu32 IQK_MAC_REG[IQK_MAC_REG_NUM] = {\r\nREG_TXPAUSE,\r\nREG_BCN_CTRL,\r\nREG_BCN_CTRL_1,\r\nREG_GPIO_MUXCFG\r\n};\r\nu32 IQK_BB_REG_92C[IQK_BB_REG_NUM] = {\r\nrOFDM0_TRxPathEnable,\r\nrOFDM0_TRMuxPar,\r\nrFPGA0_XCD_RFInterfaceSW,\r\nrConfig_AntA,\r\nrConfig_AntB,\r\nrFPGA0_XAB_RFInterfaceSW,\r\nrFPGA0_XA_RFInterfaceOE,\r\nrFPGA0_XB_RFInterfaceOE,\r\nrCCK0_AFESetting\r\n};\r\nconst u32 retryCount = 2;\r\nif (t == 0) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQ Calibration for %s for %d times\n", (is2T ? "2T2R" : "1T1R"), t));\r\n_PHY_SaveADDARegisters8723B(padapter, ADDA_REG, pDM_Odm->RFCalibrateInfo.ADDA_backup, IQK_ADDA_REG_NUM);\r\n_PHY_SaveMACRegisters8723B(padapter, IQK_MAC_REG, pDM_Odm->RFCalibrateInfo.IQK_MAC_backup);\r\n_PHY_SaveADDARegisters8723B(padapter, IQK_BB_REG_92C, pDM_Odm->RFCalibrateInfo.IQK_BB_backup, IQK_BB_REG_NUM);\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQ Calibration for %s for %d times\n", (is2T ? "2T2R" : "1T1R"), t));\r\n_PHY_PathADDAOn8723B(padapter, ADDA_REG, true, is2T);\r\n_PHY_MACSettingCalibration8723B(padapter, IQK_MAC_REG, pDM_Odm->RFCalibrateInfo.IQK_MAC_backup);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rCCK0_AFESetting, 0x0f000000, 0xf);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_TRxPathEnable, bMaskDWord, 0x03a05600);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_TRMuxPar, bMaskDWord, 0x000800e4);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_XCD_RFInterfaceSW, bMaskDWord, 0x22204000);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x30000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xf7fb7);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xed, 0x20, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x43, bRFRegOffsetMask, 0x60fbd);\r\nfor (i = 0 ; i < retryCount ; i++) {\r\nPathAOK = phy_PathA_IQK_8723B(padapter, is2T, RF_Path);\r\nif (PathAOK == 0x01) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\npDM_Odm->RFCalibrateInfo.TxLOK[ODM_RF_PATH_A] = PHY_QueryRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x8, bRFRegOffsetMask);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A Tx IQK Success!!\n"));\r\nresult[t][0] = (PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord)&0x3FF0000)>>16;\r\nresult[t][1] = (PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord)&0x3FF0000)>>16;\r\nbreak;\r\n}\r\n}\r\nfor (i = 0 ; i < retryCount ; i++) {\r\nPathAOK = phy_PathA_RxIQK8723B(padapter, is2T, RF_Path);\r\nif (PathAOK == 0x03) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A Rx IQK Success!!\n"));\r\nresult[t][2] = (PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_Before_IQK_A_2, bMaskDWord)&0x3FF0000)>>16;\r\nresult[t][3] = (PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord)&0x3FF0000)>>16;\r\nbreak;\r\n} else {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A Rx IQK Fail!!\n"));\r\n}\r\n}\r\nif (0x00 == PathAOK) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path A IQK failed!!\n"));\r\n}\r\nif (is2T) {\r\nfor (i = 0 ; i < retryCount ; i++) {\r\nPathBOK = phy_PathB_IQK_8723B(padapter);\r\nif (PathBOK == 0x01) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0x000000);\r\npDM_Odm->RFCalibrateInfo.TxLOK[ODM_RF_PATH_B] = PHY_QueryRFReg(pDM_Odm->Adapter, ODM_RF_PATH_B, 0x8, bRFRegOffsetMask);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B Tx IQK Success!!\n"));\r\nresult[t][4] = (PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_Before_IQK_A, bMaskDWord)&0x3FF0000)>>16;\r\nresult[t][5] = (PHY_QueryBBReg(pDM_Odm->Adapter, rTx_Power_After_IQK_A, bMaskDWord)&0x3FF0000)>>16;\r\nbreak;\r\n}\r\n}\r\nfor (i = 0 ; i < retryCount ; i++) {\r\nPathBOK = phy_PathB_RxIQK8723B(padapter, is2T);\r\nif (PathBOK == 0x03) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B Rx IQK Success!!\n"));\r\nresult[t][6] = (PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_Before_IQK_A_2, bMaskDWord)&0x3FF0000)>>16;\r\nresult[t][7] = (PHY_QueryBBReg(pDM_Odm->Adapter, rRx_Power_After_IQK_A_2, bMaskDWord)&0x3FF0000)>>16;\r\nbreak;\r\n} else {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B Rx IQK Fail!!\n"));\r\n}\r\n}\r\nif (0x00 == PathBOK) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("Path B IQK failed!!\n"));\r\n}\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK:Back to BB mode, load original value!\n"));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rFPGA0_IQK, bMaskH3Bytes, 0);\r\nif (t != 0) {\r\n_PHY_ReloadADDARegisters8723B(padapter, ADDA_REG, pDM_Odm->RFCalibrateInfo.ADDA_backup, IQK_ADDA_REG_NUM);\r\n_PHY_ReloadMACRegisters8723B(padapter, IQK_MAC_REG, pDM_Odm->RFCalibrateInfo.IQK_MAC_backup);\r\n_PHY_ReloadADDARegisters8723B(padapter, IQK_BB_REG_92C, pDM_Odm->RFCalibrateInfo.IQK_BB_backup, IQK_BB_REG_NUM);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0xc50, bMaskByte0, 0x50);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0xc50, bMaskByte0, tmp0xc50);\r\nif (is2T) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0xc58, bMaskByte0, 0x50);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0xc58, bMaskByte0, tmp0xc58);\r\n}\r\nPHY_SetBBReg(pDM_Odm->Adapter, rTx_IQK_Tone_A, bMaskDWord, 0x01008c00);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rRx_IQK_Tone_A, bMaskDWord, 0x01008c00);\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("phy_IQCalibrate_8723B() <==\n"));\r\n}\r\nstatic void phy_LCCalibrate_8723B(PDM_ODM_T pDM_Odm, bool is2T)\r\n{\r\nu8 tmpReg;\r\nu32 RF_Amode = 0, RF_Bmode = 0, LC_Cal;\r\nstruct adapter *padapter = pDM_Odm->Adapter;\r\ntmpReg = rtw_read8(pDM_Odm->Adapter, 0xd03);\r\nif ((tmpReg&0x70) != 0)\r\nrtw_write8(pDM_Odm->Adapter, 0xd03, tmpReg&0x8F);\r\nelse\r\nrtw_write8(pDM_Odm->Adapter, REG_TXPAUSE, 0xFF);\r\nif ((tmpReg&0x70) != 0) {\r\nRF_Amode = PHY_QueryRFReg(padapter, ODM_RF_PATH_A, RF_AC, bMask12Bits);\r\nif (is2T)\r\nRF_Bmode = PHY_QueryRFReg(padapter, ODM_RF_PATH_B, RF_AC, bMask12Bits);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_AC, bMask12Bits, (RF_Amode&0x8FFFF)|0x10000);\r\nif (is2T)\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_B, RF_AC, bMask12Bits, (RF_Bmode&0x8FFFF)|0x10000);\r\n}\r\nLC_Cal = PHY_QueryRFReg(padapter, ODM_RF_PATH_A, RF_CHNLBW, bMask12Bits);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xB0, bRFRegOffsetMask, 0xDFBE0);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_CHNLBW, bMask12Bits, LC_Cal|0x08000);\r\nmdelay(100);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xB0, bRFRegOffsetMask, 0xDFFE0);\r\nif (pDM_Odm->SupportInterface == ODM_ITRF_SDIO && pDM_Odm->PackageType >= 0x2) {\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_CHNLBW, bMask12Bits, LC_Cal);\r\n}\r\nif ((tmpReg&0x70) != 0) {\r\nrtw_write8(pDM_Odm->Adapter, 0xd03, tmpReg);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_AC, bMask12Bits, RF_Amode);\r\nif (is2T)\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_B, RF_AC, bMask12Bits, RF_Bmode);\r\n} else\r\nrtw_write8(pDM_Odm->Adapter, REG_TXPAUSE, 0x00);\r\n}\r\nvoid PHY_IQCalibrate_8723B(\r\nstruct adapter *padapter,\r\nbool bReCovery,\r\nbool bRestore,\r\nbool Is2ant,\r\nu8 RF_Path\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\ns32 result[4][8];\r\nu8 i, final_candidate, Indexforchannel;\r\nbool bPathAOK, bPathBOK;\r\ns32 RegE94, RegE9C, RegEA4, RegEAC, RegEB4, RegEBC, RegEC4, RegECC, RegTmp = 0;\r\nbool is12simular, is13simular, is23simular;\r\nbool bSingleTone = false, bCarrierSuppression = false;\r\nu32 IQK_BB_REG_92C[IQK_BB_REG_NUM] = {\r\nrOFDM0_XARxIQImbalance,\r\nrOFDM0_XBRxIQImbalance,\r\nrOFDM0_ECCAThreshold,\r\nrOFDM0_AGCRSSITable,\r\nrOFDM0_XATxIQImbalance,\r\nrOFDM0_XBTxIQImbalance,\r\nrOFDM0_XCTxAFE,\r\nrOFDM0_XDTxAFE,\r\nrOFDM0_RxIQExtAnta\r\n};\r\nu32 GNT_BT_default;\r\nu32 StartTime;\r\ns32 ProgressingTime;\r\nif (ODM_CheckPowerStatus(padapter) == false)\r\nreturn;\r\nif (!(pDM_Odm->SupportAbility & ODM_RF_CALIBRATION))\r\nreturn;\r\nif (bSingleTone || bCarrierSuppression)\r\nreturn;\r\n#if DISABLE_BB_RF\r\nreturn;\r\n#endif\r\nif (pDM_Odm->RFCalibrateInfo.bIQKInProgress)\r\nreturn;\r\npDM_Odm->RFCalibrateInfo.bIQKInProgress = true;\r\nif (bRestore) {\r\nu32 offset, data;\r\nu8 path, bResult = SUCCESS;\r\nPODM_RF_CAL_T pRFCalibrateInfo = &(pDM_Odm->RFCalibrateInfo);\r\npath = (PHY_QueryBBReg(pDM_Odm->Adapter, rS0S1_PathSwitch, bMaskByte0) == 0x00) ? ODM_RF_PATH_A : ODM_RF_PATH_B;\r\nfor (i = 0; i < 3; ++i) {\r\noffset = pRFCalibrateInfo->TxIQC_8723B[path][i][0];\r\ndata = pRFCalibrateInfo->TxIQC_8723B[path][i][1];\r\nif ((offset == 0) || (data == 0)) {\r\nDBG_871X(\r\n"%s =>path:%s Restore TX IQK result failed\n",\r\n__func__,\r\n(path == ODM_RF_PATH_A)?"A":"B"\r\n);\r\nbResult = FAIL;\r\nbreak;\r\n}\r\nPHY_SetBBReg(pDM_Odm->Adapter, offset, bMaskDWord, data);\r\n}\r\nfor (i = 0; i < 2; ++i) {\r\noffset = pRFCalibrateInfo->RxIQC_8723B[path][i][0];\r\ndata = pRFCalibrateInfo->RxIQC_8723B[path][i][1];\r\nif ((offset == 0) || (data == 0)) {\r\nDBG_871X(\r\n"%s =>path:%s Restore RX IQK result failed\n",\r\n__func__,\r\n(path == ODM_RF_PATH_A)?"A":"B"\r\n);\r\nbResult = FAIL;\r\nbreak;\r\n}\r\nPHY_SetBBReg(pDM_Odm->Adapter, offset, bMaskDWord, data);\r\n}\r\nif (pDM_Odm->RFCalibrateInfo.TxLOK[ODM_RF_PATH_A] == 0) {\r\nDBG_871X("%s => Restore Path-A TxLOK result failed\n", __func__);\r\nbResult = FAIL;\r\n} else {\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXM_IDAC, bRFRegOffsetMask, pDM_Odm->RFCalibrateInfo.TxLOK[ODM_RF_PATH_A]);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_B, RF_TXM_IDAC, bRFRegOffsetMask, pDM_Odm->RFCalibrateInfo.TxLOK[ODM_RF_PATH_B]);\r\n}\r\nif (bResult == SUCCESS)\r\nreturn;\r\n}\r\nif (bReCovery) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_INIT, ODM_DBG_LOUD, ("PHY_IQCalibrate_8723B: Return due to bReCovery!\n"));\r\n_PHY_ReloadADDARegisters8723B(padapter, IQK_BB_REG_92C, pDM_Odm->RFCalibrateInfo.IQK_BB_backup_recover, 9);\r\nreturn;\r\n}\r\nStartTime = jiffies;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK:Start!!!\n"));\r\nGNT_BT_default = PHY_QueryBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord);\r\nfor (i = 0; i < 8; i++) {\r\nresult[0][i] = 0;\r\nresult[1][i] = 0;\r\nresult[2][i] = 0;\r\nresult[3][i] = 0;\r\n}\r\nfinal_candidate = 0xff;\r\nbPathAOK = false;\r\nbPathBOK = false;\r\nis12simular = false;\r\nis23simular = false;\r\nis13simular = false;\r\nfor (i = 0; i < 3; i++) {\r\nphy_IQCalibrate_8723B(padapter, result, i, Is2ant, RF_Path);\r\nif (i == 1) {\r\nis12simular = phy_SimularityCompare_8723B(padapter, result, 0, 1);\r\nif (is12simular) {\r\nfinal_candidate = 0;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: is12simular final_candidate is %x\n", final_candidate));\r\nbreak;\r\n}\r\n}\r\nif (i == 2) {\r\nis13simular = phy_SimularityCompare_8723B(padapter, result, 0, 2);\r\nif (is13simular) {\r\nfinal_candidate = 0;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: is13simular final_candidate is %x\n", final_candidate));\r\nbreak;\r\n}\r\nis23simular = phy_SimularityCompare_8723B(padapter, result, 1, 2);\r\nif (is23simular) {\r\nfinal_candidate = 1;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: is23simular final_candidate is %x\n", final_candidate));\r\n} else {\r\nfor (i = 0; i < 8; i++)\r\nRegTmp += result[3][i];\r\nif (RegTmp != 0)\r\nfinal_candidate = 3;\r\nelse\r\nfinal_candidate = 0xFF;\r\n}\r\n}\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nRegE94 = result[i][0];\r\nRegE9C = result[i][1];\r\nRegEA4 = result[i][2];\r\nRegEAC = result[i][3];\r\nRegEB4 = result[i][4];\r\nRegEBC = result[i][5];\r\nRegEC4 = result[i][6];\r\nRegECC = result[i][7];\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: RegE94 =%x RegE9C =%x RegEA4 =%x RegEAC =%x RegEB4 =%x RegEBC =%x RegEC4 =%x RegECC =%x\n ", RegE94, RegE9C, RegEA4, RegEAC, RegEB4, RegEBC, RegEC4, RegECC));\r\n}\r\nif (final_candidate != 0xff) {\r\npDM_Odm->RFCalibrateInfo.RegE94 = RegE94 = result[final_candidate][0];\r\npDM_Odm->RFCalibrateInfo.RegE9C = RegE9C = result[final_candidate][1];\r\nRegEA4 = result[final_candidate][2];\r\nRegEAC = result[final_candidate][3];\r\npDM_Odm->RFCalibrateInfo.RegEB4 = RegEB4 = result[final_candidate][4];\r\npDM_Odm->RFCalibrateInfo.RegEBC = RegEBC = result[final_candidate][5];\r\nRegEC4 = result[final_candidate][6];\r\nRegECC = result[final_candidate][7];\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: final_candidate is %x\n", final_candidate));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: RegE94 =%x RegE9C =%x RegEA4 =%x RegEAC =%x RegEB4 =%x RegEBC =%x RegEC4 =%x RegECC =%x\n ", RegE94, RegE9C, RegEA4, RegEAC, RegEB4, RegEBC, RegEC4, RegECC));\r\nbPathAOK = bPathBOK = true;\r\n} else {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK: FAIL use default value\n"));\r\npDM_Odm->RFCalibrateInfo.RegE94 = pDM_Odm->RFCalibrateInfo.RegEB4 = 0x100;\r\npDM_Odm->RFCalibrateInfo.RegE9C = pDM_Odm->RFCalibrateInfo.RegEBC = 0x0;\r\n}\r\n{\r\nif (RegE94 != 0)\r\n_PHY_PathAFillIQKMatrix8723B(padapter, bPathAOK, result, final_candidate, (RegEA4 == 0));\r\n}\r\n{\r\nif (RegEB4 != 0)\r\n_PHY_PathBFillIQKMatrix8723B(padapter, bPathBOK, result, final_candidate, (RegEC4 == 0));\r\n}\r\nIndexforchannel = ODM_GetRightChnlPlaceforIQK(pHalData->CurrentChannel);\r\nif (final_candidate < 4) {\r\nfor (i = 0; i < IQK_Matrix_REG_NUM; i++)\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[Indexforchannel].Value[0][i] = result[final_candidate][i];\r\npDM_Odm->RFCalibrateInfo.IQKMatrixRegSetting[Indexforchannel].bIQKDone = true;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("\nIQK OK Indexforchannel %d.\n", Indexforchannel));\r\n_PHY_SaveADDARegisters8723B(padapter, IQK_BB_REG_92C, pDM_Odm->RFCalibrateInfo.IQK_BB_backup_recover, 9);\r\nPHY_SetBBReg(pDM_Odm->Adapter, 0x764, bMaskDWord, GNT_BT_default);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_WE_LUT, 0x80000, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_RCK_OS, bRFRegOffsetMask, 0x18000);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G1, bRFRegOffsetMask, 0x0001f);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, RF_TXPA_G2, bRFRegOffsetMask, 0xe6177);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0xed, 0x20, 0x1);\r\nPHY_SetRFReg(pDM_Odm->Adapter, ODM_RF_PATH_A, 0x43, bRFRegOffsetMask, 0x300bd);\r\nif (Is2ant) {\r\nif (RF_Path == 0x0)\r\nODM_SetIQCbyRFpath(pDM_Odm, 0);\r\nelse\r\nODM_SetIQCbyRFpath(pDM_Odm, 1);\r\n}\r\npDM_Odm->RFCalibrateInfo.bIQKInProgress = false;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK finished\n"));\r\nProgressingTime = jiffies_to_msecs(jiffies - StartTime);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("IQK ProgressingTime = %d\n", ProgressingTime));\r\n}\r\nvoid PHY_LCCalibrate_8723B(PDM_ODM_T pDM_Odm)\r\n{\r\nbool bSingleTone = false, bCarrierSuppression = false;\r\nu32 timeout = 2000, timecount = 0;\r\nu32 StartTime;\r\ns32 ProgressingTime;\r\n#if DISABLE_BB_RF\r\nreturn;\r\n#endif\r\nif (!(pDM_Odm->SupportAbility & ODM_RF_CALIBRATION))\r\nreturn;\r\nif (bSingleTone || bCarrierSuppression)\r\nreturn;\r\nStartTime = jiffies;\r\nwhile (*(pDM_Odm->pbScanInProcess) && timecount < timeout) {\r\nmdelay(50);\r\ntimecount += 50;\r\n}\r\npDM_Odm->RFCalibrateInfo.bLCKInProgress = true;\r\nphy_LCCalibrate_8723B(pDM_Odm, false);\r\npDM_Odm->RFCalibrateInfo.bLCKInProgress = false;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("LCK:Finish!!!interface %d\n", pDM_Odm->InterfaceIndex));\r\nProgressingTime = jiffies_to_msecs(jiffies - StartTime);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_CALIBRATION, ODM_DBG_LOUD, ("LCK ProgressingTime = %d\n", ProgressingTime));\r\n}

static int ccid2_hc_tx_alloc_seq(struct ccid2_hc_tx_sock *hc)\r\n{\r\nstruct ccid2_seq *seqp;\r\nint i;\r\nif (hc->tx_seqbufc >= (sizeof(hc->tx_seqbuf) /\r\nsizeof(struct ccid2_seq *)))\r\nreturn -ENOMEM;\r\nseqp = kmalloc(CCID2_SEQBUF_LEN * sizeof(struct ccid2_seq), gfp_any());\r\nif (seqp == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < (CCID2_SEQBUF_LEN - 1); i++) {\r\nseqp[i].ccid2s_next = &seqp[i + 1];\r\nseqp[i + 1].ccid2s_prev = &seqp[i];\r\n}\r\nseqp[CCID2_SEQBUF_LEN - 1].ccid2s_next = seqp;\r\nseqp->ccid2s_prev = &seqp[CCID2_SEQBUF_LEN - 1];\r\nif (hc->tx_seqbufc == 0)\r\nhc->tx_seqh = hc->tx_seqt = seqp;\r\nelse {\r\nhc->tx_seqh->ccid2s_next = seqp;\r\nseqp->ccid2s_prev = hc->tx_seqh;\r\nhc->tx_seqt->ccid2s_prev = &seqp[CCID2_SEQBUF_LEN - 1];\r\nseqp[CCID2_SEQBUF_LEN - 1].ccid2s_next = hc->tx_seqt;\r\n}\r\nhc->tx_seqbuf[hc->tx_seqbufc] = seqp;\r\nhc->tx_seqbufc++;\r\nreturn 0;\r\n}\r\nstatic int ccid2_hc_tx_send_packet(struct sock *sk, struct sk_buff *skb)\r\n{\r\nif (ccid2_cwnd_network_limited(ccid2_hc_tx_sk(sk)))\r\nreturn CCID_PACKET_WILL_DEQUEUE_LATER;\r\nreturn CCID_PACKET_SEND_AT_ONCE;\r\n}\r\nstatic void ccid2_change_l_ack_ratio(struct sock *sk, u32 val)\r\n{\r\nu32 max_ratio = DIV_ROUND_UP(ccid2_hc_tx_sk(sk)->tx_cwnd, 2);\r\nif (val == 0 || val > max_ratio) {\r\nDCCP_WARN("Limiting Ack Ratio (%u) to %u\n", val, max_ratio);\r\nval = max_ratio;\r\n}\r\ndccp_feat_signal_nn_change(sk, DCCPF_ACK_RATIO,\r\nmin_t(u32, val, DCCPF_ACK_RATIO_MAX));\r\n}\r\nstatic void ccid2_check_l_ack_ratio(struct sock *sk)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nif (dccp_feat_nn_get(sk, DCCPF_ACK_RATIO) > hc->tx_cwnd)\r\nccid2_change_l_ack_ratio(sk, hc->tx_cwnd/2 ? : 1U);\r\n}\r\nstatic void ccid2_change_l_seq_window(struct sock *sk, u64 val)\r\n{\r\ndccp_feat_signal_nn_change(sk, DCCPF_SEQUENCE_WINDOW,\r\nclamp_val(val, DCCPF_SEQ_WMIN,\r\nDCCPF_SEQ_WMAX));\r\n}\r\nstatic void ccid2_hc_tx_rto_expire(unsigned long data)\r\n{\r\nstruct sock *sk = (struct sock *)data;\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nconst bool sender_was_blocked = ccid2_cwnd_network_limited(hc);\r\nbh_lock_sock(sk);\r\nif (sock_owned_by_user(sk)) {\r\nsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + HZ / 5);\r\ngoto out;\r\n}\r\nccid2_pr_debug("RTO_EXPIRE\n");\r\nhc->tx_rto <<= 1;\r\nif (hc->tx_rto > DCCP_RTO_MAX)\r\nhc->tx_rto = DCCP_RTO_MAX;\r\nhc->tx_ssthresh = hc->tx_cwnd / 2;\r\nif (hc->tx_ssthresh < 2)\r\nhc->tx_ssthresh = 2;\r\nhc->tx_cwnd = 1;\r\nhc->tx_pipe = 0;\r\nhc->tx_seqt = hc->tx_seqh;\r\nhc->tx_packets_acked = 0;\r\nhc->tx_rpseq = 0;\r\nhc->tx_rpdupack = -1;\r\nccid2_change_l_ack_ratio(sk, 1);\r\nif (sender_was_blocked)\r\ntasklet_schedule(&dccp_sk(sk)->dccps_xmitlet);\r\nsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\r\nout:\r\nbh_unlock_sock(sk);\r\nsock_put(sk);\r\n}\r\nstatic void ccid2_update_used_window(struct ccid2_hc_tx_sock *hc, u32 new_wnd)\r\n{\r\nhc->tx_expected_wnd = (3 * hc->tx_expected_wnd + new_wnd) / 4;\r\n}\r\nstatic void ccid2_cwnd_application_limited(struct sock *sk, const u32 now)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nu32 init_win = rfc3390_bytes_to_packets(dccp_sk(sk)->dccps_mss_cache),\r\nwin_used = max(hc->tx_cwnd_used, init_win);\r\nif (win_used < hc->tx_cwnd) {\r\nhc->tx_ssthresh = max(hc->tx_ssthresh,\r\n(hc->tx_cwnd >> 1) + (hc->tx_cwnd >> 2));\r\nhc->tx_cwnd = (hc->tx_cwnd + win_used) >> 1;\r\n}\r\nhc->tx_cwnd_used = 0;\r\nhc->tx_cwnd_stamp = now;\r\nccid2_check_l_ack_ratio(sk);\r\n}\r\nstatic void ccid2_cwnd_restart(struct sock *sk, const u32 now)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nu32 cwnd = hc->tx_cwnd, restart_cwnd,\r\niwnd = rfc3390_bytes_to_packets(dccp_sk(sk)->dccps_mss_cache);\r\nhc->tx_ssthresh = max(hc->tx_ssthresh, (cwnd >> 1) + (cwnd >> 2));\r\nrestart_cwnd = min(cwnd, iwnd);\r\ncwnd >>= (now - hc->tx_lsndtime) / hc->tx_rto;\r\nhc->tx_cwnd = max(cwnd, restart_cwnd);\r\nhc->tx_cwnd_stamp = now;\r\nhc->tx_cwnd_used = 0;\r\nccid2_check_l_ack_ratio(sk);\r\n}\r\nstatic void ccid2_hc_tx_packet_sent(struct sock *sk, unsigned int len)\r\n{\r\nstruct dccp_sock *dp = dccp_sk(sk);\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nconst u32 now = ccid2_jiffies32;\r\nstruct ccid2_seq *next;\r\nif (ccid2_do_cwv && !hc->tx_pipe &&\r\n(s32)(now - hc->tx_lsndtime) >= hc->tx_rto)\r\nccid2_cwnd_restart(sk, now);\r\nhc->tx_lsndtime = now;\r\nhc->tx_pipe += 1;\r\nif (ccid2_cwnd_network_limited(hc)) {\r\nccid2_update_used_window(hc, hc->tx_cwnd);\r\nhc->tx_cwnd_used = 0;\r\nhc->tx_cwnd_stamp = now;\r\n} else {\r\nif (hc->tx_pipe > hc->tx_cwnd_used)\r\nhc->tx_cwnd_used = hc->tx_pipe;\r\nccid2_update_used_window(hc, hc->tx_cwnd_used);\r\nif (ccid2_do_cwv && (s32)(now - hc->tx_cwnd_stamp) >= hc->tx_rto)\r\nccid2_cwnd_application_limited(sk, now);\r\n}\r\nhc->tx_seqh->ccid2s_seq = dp->dccps_gss;\r\nhc->tx_seqh->ccid2s_acked = 0;\r\nhc->tx_seqh->ccid2s_sent = now;\r\nnext = hc->tx_seqh->ccid2s_next;\r\nif (next == hc->tx_seqt) {\r\nif (ccid2_hc_tx_alloc_seq(hc)) {\r\nDCCP_CRIT("packet history - out of memory!");\r\nreturn;\r\n}\r\nnext = hc->tx_seqh->ccid2s_next;\r\nBUG_ON(next == hc->tx_seqt);\r\n}\r\nhc->tx_seqh = next;\r\nccid2_pr_debug("cwnd=%d pipe=%d\n", hc->tx_cwnd, hc->tx_pipe);\r\n#if 0\r\nhc->tx_arsent++;\r\nif (hc->tx_ackloss) {\r\nif (hc->tx_arsent >= hc->tx_cwnd) {\r\nhc->tx_arsent = 0;\r\nhc->tx_ackloss = 0;\r\n}\r\n} else {\r\nif (dp->dccps_l_ack_ratio > 1) {\r\nint denom = dp->dccps_l_ack_ratio * dp->dccps_l_ack_ratio -\r\ndp->dccps_l_ack_ratio;\r\ndenom = hc->tx_cwnd * hc->tx_cwnd / denom;\r\nif (hc->tx_arsent >= denom) {\r\nccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio - 1);\r\nhc->tx_arsent = 0;\r\n}\r\n} else {\r\nhc->tx_arsent = 0;\r\n}\r\n}\r\n#endif\r\nsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\r\n#ifdef CONFIG_IP_DCCP_CCID2_DEBUG\r\ndo {\r\nstruct ccid2_seq *seqp = hc->tx_seqt;\r\nwhile (seqp != hc->tx_seqh) {\r\nccid2_pr_debug("out seq=%llu acked=%d time=%u\n",\r\n(unsigned long long)seqp->ccid2s_seq,\r\nseqp->ccid2s_acked, seqp->ccid2s_sent);\r\nseqp = seqp->ccid2s_next;\r\n}\r\n} while (0);\r\nccid2_pr_debug("=========\n");\r\n#endif\r\n}\r\nstatic void ccid2_rtt_estimator(struct sock *sk, const long mrtt)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nlong m = mrtt ? : 1;\r\nif (hc->tx_srtt == 0) {\r\nhc->tx_srtt = m << 3;\r\nhc->tx_mdev = m << 1;\r\nhc->tx_mdev_max = max(hc->tx_mdev, tcp_rto_min(sk));\r\nhc->tx_rttvar = hc->tx_mdev_max;\r\nhc->tx_rtt_seq = dccp_sk(sk)->dccps_gss;\r\n} else {\r\nm -= (hc->tx_srtt >> 3);\r\nhc->tx_srtt += m;\r\nif (m < 0) {\r\nm = -m;\r\nm -= (hc->tx_mdev >> 2);\r\nif (m > 0)\r\nm >>= 3;\r\n} else {\r\nm -= (hc->tx_mdev >> 2);\r\n}\r\nhc->tx_mdev += m;\r\nif (hc->tx_mdev > hc->tx_mdev_max) {\r\nhc->tx_mdev_max = hc->tx_mdev;\r\nif (hc->tx_mdev_max > hc->tx_rttvar)\r\nhc->tx_rttvar = hc->tx_mdev_max;\r\n}\r\nif (after48(dccp_sk(sk)->dccps_gar, hc->tx_rtt_seq)) {\r\nif (hc->tx_mdev_max < hc->tx_rttvar)\r\nhc->tx_rttvar -= (hc->tx_rttvar -\r\nhc->tx_mdev_max) >> 2;\r\nhc->tx_rtt_seq = dccp_sk(sk)->dccps_gss;\r\nhc->tx_mdev_max = tcp_rto_min(sk);\r\n}\r\n}\r\nhc->tx_rto = (hc->tx_srtt >> 3) + hc->tx_rttvar;\r\nif (hc->tx_rto > DCCP_RTO_MAX)\r\nhc->tx_rto = DCCP_RTO_MAX;\r\n}\r\nstatic void ccid2_new_ack(struct sock *sk, struct ccid2_seq *seqp,\r\nunsigned int *maxincr)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nstruct dccp_sock *dp = dccp_sk(sk);\r\nint r_seq_used = hc->tx_cwnd / dp->dccps_l_ack_ratio;\r\nif (hc->tx_cwnd < dp->dccps_l_seq_win &&\r\nr_seq_used < dp->dccps_r_seq_win) {\r\nif (hc->tx_cwnd < hc->tx_ssthresh) {\r\nif (*maxincr > 0 && ++hc->tx_packets_acked >= 2) {\r\nhc->tx_cwnd += 1;\r\n*maxincr -= 1;\r\nhc->tx_packets_acked = 0;\r\n}\r\n} else if (++hc->tx_packets_acked >= hc->tx_cwnd) {\r\nhc->tx_cwnd += 1;\r\nhc->tx_packets_acked = 0;\r\n}\r\n}\r\nif (r_seq_used * CCID2_WIN_CHANGE_FACTOR >= dp->dccps_r_seq_win)\r\nccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio * 2);\r\nelse if (r_seq_used * CCID2_WIN_CHANGE_FACTOR < dp->dccps_r_seq_win/2)\r\nccid2_change_l_ack_ratio(sk, dp->dccps_l_ack_ratio / 2 ? : 1U);\r\nif (hc->tx_cwnd * CCID2_WIN_CHANGE_FACTOR >= dp->dccps_l_seq_win)\r\nccid2_change_l_seq_window(sk, dp->dccps_l_seq_win * 2);\r\nelse if (hc->tx_cwnd * CCID2_WIN_CHANGE_FACTOR < dp->dccps_l_seq_win/2)\r\nccid2_change_l_seq_window(sk, dp->dccps_l_seq_win / 2);\r\nccid2_rtt_estimator(sk, ccid2_jiffies32 - seqp->ccid2s_sent);\r\n}\r\nstatic void ccid2_congestion_event(struct sock *sk, struct ccid2_seq *seqp)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nif ((s32)(seqp->ccid2s_sent - hc->tx_last_cong) < 0) {\r\nccid2_pr_debug("Multiple losses in an RTT---treating as one\n");\r\nreturn;\r\n}\r\nhc->tx_last_cong = ccid2_jiffies32;\r\nhc->tx_cwnd = hc->tx_cwnd / 2 ? : 1U;\r\nhc->tx_ssthresh = max(hc->tx_cwnd, 2U);\r\nccid2_check_l_ack_ratio(sk);\r\n}\r\nstatic int ccid2_hc_tx_parse_options(struct sock *sk, u8 packet_type,\r\nu8 option, u8 *optval, u8 optlen)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nswitch (option) {\r\ncase DCCPO_ACK_VECTOR_0:\r\ncase DCCPO_ACK_VECTOR_1:\r\nreturn dccp_ackvec_parsed_add(&hc->tx_av_chunks, optval, optlen,\r\noption - DCCPO_ACK_VECTOR_0);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ccid2_hc_tx_packet_recv(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct dccp_sock *dp = dccp_sk(sk);\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nconst bool sender_was_blocked = ccid2_cwnd_network_limited(hc);\r\nstruct dccp_ackvec_parsed *avp;\r\nu64 ackno, seqno;\r\nstruct ccid2_seq *seqp;\r\nint done = 0;\r\nunsigned int maxincr = 0;\r\nseqno = DCCP_SKB_CB(skb)->dccpd_seq;\r\nif (hc->tx_rpdupack == -1) {\r\nhc->tx_rpdupack = 0;\r\nhc->tx_rpseq = seqno;\r\n} else {\r\nif (dccp_delta_seqno(hc->tx_rpseq, seqno) == 1)\r\nhc->tx_rpseq = seqno;\r\nelse if (after48(seqno, hc->tx_rpseq)) {\r\nhc->tx_rpdupack++;\r\nif (hc->tx_rpdupack >= NUMDUPACK) {\r\nhc->tx_rpdupack = -1;\r\nhc->tx_rpseq = 0;\r\n#ifdef __CCID2_COPES_GRACEFULLY_WITH_ACK_CONGESTION_CONTROL__\r\nccid2_change_l_ack_ratio(sk, 2 * dp->dccps_l_ack_ratio);\r\n#endif\r\n}\r\n}\r\n}\r\nif (dccp_packet_without_ack(skb))\r\nreturn;\r\nif (hc->tx_seqh == hc->tx_seqt)\r\ngoto done;\r\nackno = DCCP_SKB_CB(skb)->dccpd_ack_seq;\r\nif (after48(ackno, hc->tx_high_ack))\r\nhc->tx_high_ack = ackno;\r\nseqp = hc->tx_seqt;\r\nwhile (before48(seqp->ccid2s_seq, ackno)) {\r\nseqp = seqp->ccid2s_next;\r\nif (seqp == hc->tx_seqh) {\r\nseqp = hc->tx_seqh->ccid2s_prev;\r\nbreak;\r\n}\r\n}\r\nif (hc->tx_cwnd < hc->tx_ssthresh)\r\nmaxincr = DIV_ROUND_UP(dp->dccps_l_ack_ratio, 2);\r\nlist_for_each_entry(avp, &hc->tx_av_chunks, node) {\r\nfor (; avp->len--; avp->vec++) {\r\nu64 ackno_end_rl = SUB48(ackno,\r\ndccp_ackvec_runlen(avp->vec));\r\nccid2_pr_debug("ackvec %llu |%u,%u|\n",\r\n(unsigned long long)ackno,\r\ndccp_ackvec_state(avp->vec) >> 6,\r\ndccp_ackvec_runlen(avp->vec));\r\nwhile (after48(seqp->ccid2s_seq, ackno)) {\r\nif (seqp == hc->tx_seqt) {\r\ndone = 1;\r\nbreak;\r\n}\r\nseqp = seqp->ccid2s_prev;\r\n}\r\nif (done)\r\nbreak;\r\nwhile (between48(seqp->ccid2s_seq,ackno_end_rl,ackno)) {\r\nconst u8 state = dccp_ackvec_state(avp->vec);\r\nif (state != DCCPAV_NOT_RECEIVED &&\r\n!seqp->ccid2s_acked) {\r\nif (state == DCCPAV_ECN_MARKED)\r\nccid2_congestion_event(sk,\r\nseqp);\r\nelse\r\nccid2_new_ack(sk, seqp,\r\n&maxincr);\r\nseqp->ccid2s_acked = 1;\r\nccid2_pr_debug("Got ack for %llu\n",\r\n(unsigned long long)seqp->ccid2s_seq);\r\nhc->tx_pipe--;\r\n}\r\nif (seqp == hc->tx_seqt) {\r\ndone = 1;\r\nbreak;\r\n}\r\nseqp = seqp->ccid2s_prev;\r\n}\r\nif (done)\r\nbreak;\r\nackno = SUB48(ackno_end_rl, 1);\r\n}\r\nif (done)\r\nbreak;\r\n}\r\nseqp = hc->tx_seqt;\r\nwhile (before48(seqp->ccid2s_seq, hc->tx_high_ack)) {\r\nseqp = seqp->ccid2s_next;\r\nif (seqp == hc->tx_seqh) {\r\nseqp = hc->tx_seqh->ccid2s_prev;\r\nbreak;\r\n}\r\n}\r\ndone = 0;\r\nwhile (1) {\r\nif (seqp->ccid2s_acked) {\r\ndone++;\r\nif (done == NUMDUPACK)\r\nbreak;\r\n}\r\nif (seqp == hc->tx_seqt)\r\nbreak;\r\nseqp = seqp->ccid2s_prev;\r\n}\r\nif (done == NUMDUPACK) {\r\nstruct ccid2_seq *last_acked = seqp;\r\nwhile (1) {\r\nif (!seqp->ccid2s_acked) {\r\nccid2_pr_debug("Packet lost: %llu\n",\r\n(unsigned long long)seqp->ccid2s_seq);\r\nccid2_congestion_event(sk, seqp);\r\nhc->tx_pipe--;\r\n}\r\nif (seqp == hc->tx_seqt)\r\nbreak;\r\nseqp = seqp->ccid2s_prev;\r\n}\r\nhc->tx_seqt = last_acked;\r\n}\r\nwhile (hc->tx_seqt != hc->tx_seqh) {\r\nif (!hc->tx_seqt->ccid2s_acked)\r\nbreak;\r\nhc->tx_seqt = hc->tx_seqt->ccid2s_next;\r\n}\r\nif (hc->tx_pipe == 0)\r\nsk_stop_timer(sk, &hc->tx_rtotimer);\r\nelse\r\nsk_reset_timer(sk, &hc->tx_rtotimer, jiffies + hc->tx_rto);\r\ndone:\r\nif (sender_was_blocked && !ccid2_cwnd_network_limited(hc))\r\ntasklet_schedule(&dccp_sk(sk)->dccps_xmitlet);\r\ndccp_ackvec_parsed_cleanup(&hc->tx_av_chunks);\r\n}\r\nstatic int ccid2_hc_tx_init(struct ccid *ccid, struct sock *sk)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid_priv(ccid);\r\nstruct dccp_sock *dp = dccp_sk(sk);\r\nu32 max_ratio;\r\nhc->tx_ssthresh = ~0U;\r\nhc->tx_cwnd = rfc3390_bytes_to_packets(dp->dccps_mss_cache);\r\nhc->tx_expected_wnd = hc->tx_cwnd;\r\nmax_ratio = DIV_ROUND_UP(hc->tx_cwnd, 2);\r\nif (dp->dccps_l_ack_ratio == 0 || dp->dccps_l_ack_ratio > max_ratio)\r\ndp->dccps_l_ack_ratio = max_ratio;\r\nif (ccid2_hc_tx_alloc_seq(hc))\r\nreturn -ENOMEM;\r\nhc->tx_rto = DCCP_TIMEOUT_INIT;\r\nhc->tx_rpdupack = -1;\r\nhc->tx_last_cong = hc->tx_lsndtime = hc->tx_cwnd_stamp = ccid2_jiffies32;\r\nhc->tx_cwnd_used = 0;\r\nsetup_timer(&hc->tx_rtotimer, ccid2_hc_tx_rto_expire,\r\n(unsigned long)sk);\r\nINIT_LIST_HEAD(&hc->tx_av_chunks);\r\nreturn 0;\r\n}\r\nstatic void ccid2_hc_tx_exit(struct sock *sk)\r\n{\r\nstruct ccid2_hc_tx_sock *hc = ccid2_hc_tx_sk(sk);\r\nint i;\r\nsk_stop_timer(sk, &hc->tx_rtotimer);\r\nfor (i = 0; i < hc->tx_seqbufc; i++)\r\nkfree(hc->tx_seqbuf[i]);\r\nhc->tx_seqbufc = 0;\r\ndccp_ackvec_parsed_cleanup(&hc->tx_av_chunks);\r\n}\r\nstatic void ccid2_hc_rx_packet_recv(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct ccid2_hc_rx_sock *hc = ccid2_hc_rx_sk(sk);\r\nif (!dccp_data_packet(skb))\r\nreturn;\r\nif (++hc->rx_num_data_pkts >= dccp_sk(sk)->dccps_r_ack_ratio) {\r\ndccp_send_ack(sk);\r\nhc->rx_num_data_pkts = 0;\r\n}\r\n}

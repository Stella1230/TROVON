static int pisosr_gpio_refresh(struct pisosr_gpio *gpio)\r\n{\r\nint ret;\r\nmutex_lock(&gpio->lock);\r\nif (gpio->load_gpio) {\r\ngpiod_set_value_cansleep(gpio->load_gpio, 1);\r\nudelay(1);\r\ngpiod_set_value_cansleep(gpio->load_gpio, 0);\r\nudelay(1);\r\n}\r\nret = spi_read(gpio->spi, gpio->buffer, gpio->buffer_size);\r\nmutex_unlock(&gpio->lock);\r\nreturn ret;\r\n}\r\nstatic int pisosr_gpio_get_direction(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nreturn 1;\r\n}\r\nstatic int pisosr_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pisosr_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int pisosr_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct pisosr_gpio *gpio = gpiochip_get_data(chip);\r\npisosr_gpio_refresh(gpio);\r\nreturn (gpio->buffer[offset / 8] >> (offset % 8)) & 0x1;\r\n}\r\nstatic int pisosr_gpio_probe(struct spi_device *spi)\r\n{\r\nstruct device *dev = &spi->dev;\r\nstruct pisosr_gpio *gpio;\r\nint ret;\r\ngpio = devm_kzalloc(dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, gpio);\r\ngpio->chip = template_chip;\r\ngpio->chip.parent = dev;\r\nof_property_read_u16(dev->of_node, "ngpios", &gpio->chip.ngpio);\r\ngpio->spi = spi;\r\ngpio->buffer_size = DIV_ROUND_UP(gpio->chip.ngpio, 8);\r\ngpio->buffer = devm_kzalloc(dev, gpio->buffer_size, GFP_KERNEL);\r\nif (!gpio->buffer)\r\nreturn -ENOMEM;\r\ngpio->load_gpio = devm_gpiod_get_optional(dev, "load", GPIOD_OUT_LOW);\r\nif (IS_ERR(gpio->load_gpio)) {\r\nret = PTR_ERR(gpio->load_gpio);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "Unable to allocate load GPIO\n");\r\nreturn ret;\r\n}\r\nmutex_init(&gpio->lock);\r\nret = gpiochip_add_data(&gpio->chip, gpio);\r\nif (ret < 0) {\r\ndev_err(dev, "Unable to register gpiochip\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pisosr_gpio_remove(struct spi_device *spi)\r\n{\r\nstruct pisosr_gpio *gpio = spi_get_drvdata(spi);\r\ngpiochip_remove(&gpio->chip);\r\nmutex_destroy(&gpio->lock);\r\nreturn 0;\r\n}

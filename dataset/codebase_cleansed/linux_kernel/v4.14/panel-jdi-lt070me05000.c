static inline struct jdi_panel *to_jdi_panel(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct jdi_panel, base);\r\n}\r\nstatic int jdi_panel_init(struct jdi_panel *jdi)\r\n{\r\nstruct mipi_dsi_device *dsi = jdi->dsi;\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_soft_reset(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 20000);\r\nret = mipi_dsi_dcs_set_pixel_format(dsi, MIPI_DCS_PIXEL_FMT_24BIT << 4);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set pixel format: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mipi_dsi_dcs_set_column_address(dsi, 0, jdi->mode->hdisplay - 1);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set column address: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mipi_dsi_dcs_set_page_address(dsi, 0, jdi->mode->vdisplay - 1);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set page address: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mipi_dsi_dcs_write(dsi, MIPI_DCS_WRITE_CONTROL_DISPLAY,\r\n(u8[]){ 0x24 }, 1);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to write control display: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mipi_dsi_dcs_write(dsi, MIPI_DCS_WRITE_POWER_SAVE,\r\n(u8[]){ 0x00 }, 1);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set cabc off: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mipi_dsi_dcs_exit_sleep_mode(dsi);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set exit sleep mode: %d\n", ret);\r\nreturn ret;\r\n}\r\nmsleep(120);\r\nret = mipi_dsi_generic_write(dsi, (u8[]){0xB0, 0x00}, 2);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set mcap: %d\n", ret);\r\nreturn ret;\r\n}\r\nmdelay(10);\r\nret = mipi_dsi_generic_write(dsi, (u8[])\r\n{0xB3, 0x26, 0x08, 0x00, 0x20, 0x00}, 6);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set display interface setting: %d\n"\r\n, ret);\r\nreturn ret;\r\n}\r\nmdelay(20);\r\nret = mipi_dsi_generic_write(dsi, (u8[]){0xB0, 0x03}, 2);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set default values for mcap: %d\n"\r\n, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int jdi_panel_on(struct jdi_panel *jdi)\r\n{\r\nstruct mipi_dsi_device *dsi = jdi->dsi;\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_set_display_on(dsi);\r\nif (ret < 0)\r\ndev_err(dev, "failed to set display on: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void jdi_panel_off(struct jdi_panel *jdi)\r\n{\r\nstruct mipi_dsi_device *dsi = jdi->dsi;\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\ndsi->mode_flags &= ~MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_set_display_off(dsi);\r\nif (ret < 0)\r\ndev_err(dev, "failed to set display off: %d\n", ret);\r\nret = mipi_dsi_dcs_enter_sleep_mode(dsi);\r\nif (ret < 0)\r\ndev_err(dev, "failed to enter sleep mode: %d\n", ret);\r\nmsleep(100);\r\n}\r\nstatic int jdi_panel_disable(struct drm_panel *panel)\r\n{\r\nstruct jdi_panel *jdi = to_jdi_panel(panel);\r\nif (!jdi->enabled)\r\nreturn 0;\r\njdi->backlight->props.power = FB_BLANK_POWERDOWN;\r\nbacklight_update_status(jdi->backlight);\r\njdi->enabled = false;\r\nreturn 0;\r\n}\r\nstatic int jdi_panel_unprepare(struct drm_panel *panel)\r\n{\r\nstruct jdi_panel *jdi = to_jdi_panel(panel);\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\nif (!jdi->prepared)\r\nreturn 0;\r\njdi_panel_off(jdi);\r\nret = regulator_bulk_disable(ARRAY_SIZE(jdi->supplies), jdi->supplies);\r\nif (ret < 0)\r\ndev_err(dev, "regulator disable failed, %d\n", ret);\r\ngpiod_set_value(jdi->enable_gpio, 0);\r\ngpiod_set_value(jdi->reset_gpio, 1);\r\ngpiod_set_value(jdi->dcdc_en_gpio, 0);\r\njdi->prepared = false;\r\nreturn 0;\r\n}\r\nstatic int jdi_panel_prepare(struct drm_panel *panel)\r\n{\r\nstruct jdi_panel *jdi = to_jdi_panel(panel);\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\nif (jdi->prepared)\r\nreturn 0;\r\nret = regulator_bulk_enable(ARRAY_SIZE(jdi->supplies), jdi->supplies);\r\nif (ret < 0) {\r\ndev_err(dev, "regulator enable failed, %d\n", ret);\r\nreturn ret;\r\n}\r\nmsleep(20);\r\ngpiod_set_value(jdi->dcdc_en_gpio, 1);\r\nusleep_range(10, 20);\r\ngpiod_set_value(jdi->reset_gpio, 0);\r\nusleep_range(10, 20);\r\ngpiod_set_value(jdi->enable_gpio, 1);\r\nusleep_range(10, 20);\r\nret = jdi_panel_init(jdi);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to init panel: %d\n", ret);\r\ngoto poweroff;\r\n}\r\nret = jdi_panel_on(jdi);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set panel on: %d\n", ret);\r\ngoto poweroff;\r\n}\r\njdi->prepared = true;\r\nreturn 0;\r\npoweroff:\r\nret = regulator_bulk_disable(ARRAY_SIZE(jdi->supplies), jdi->supplies);\r\nif (ret < 0)\r\ndev_err(dev, "regulator disable failed, %d\n", ret);\r\ngpiod_set_value(jdi->enable_gpio, 0);\r\ngpiod_set_value(jdi->reset_gpio, 1);\r\ngpiod_set_value(jdi->dcdc_en_gpio, 0);\r\nreturn ret;\r\n}\r\nstatic int jdi_panel_enable(struct drm_panel *panel)\r\n{\r\nstruct jdi_panel *jdi = to_jdi_panel(panel);\r\nif (jdi->enabled)\r\nreturn 0;\r\njdi->backlight->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(jdi->backlight);\r\njdi->enabled = true;\r\nreturn 0;\r\n}\r\nstatic int jdi_panel_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_display_mode *mode;\r\nstruct jdi_panel *jdi = to_jdi_panel(panel);\r\nstruct device *dev = &jdi->dsi->dev;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\ndrm_mode_probed_add(panel->connector, mode);\r\npanel->connector->display_info.width_mm = 95;\r\npanel->connector->display_info.height_mm = 151;\r\nreturn 1;\r\n}\r\nstatic int dsi_dcs_bl_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct mipi_dsi_device *dsi = bl_get_data(bl);\r\nint ret;\r\nu16 brightness = bl->props.brightness;\r\ndsi->mode_flags &= ~MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_get_display_brightness(dsi, &brightness);\r\nif (ret < 0)\r\nreturn ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nreturn brightness & 0xff;\r\n}\r\nstatic int dsi_dcs_bl_update_status(struct backlight_device *bl)\r\n{\r\nstruct mipi_dsi_device *dsi = bl_get_data(bl);\r\nint ret;\r\ndsi->mode_flags &= ~MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_set_display_brightness(dsi, bl->props.brightness);\r\nif (ret < 0)\r\nreturn ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nreturn 0;\r\n}\r\nstatic struct backlight_device *\r\ndrm_panel_create_dsi_backlight(struct mipi_dsi_device *dsi)\r\n{\r\nstruct device *dev = &dsi->dev;\r\nstruct backlight_properties props;\r\nmemset(&props, 0, sizeof(props));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.brightness = 255;\r\nprops.max_brightness = 255;\r\nreturn devm_backlight_device_register(dev, dev_name(dev), dev, dsi,\r\n&dsi_bl_ops, &props);\r\n}\r\nstatic int jdi_panel_add(struct jdi_panel *jdi)\r\n{\r\nstruct device *dev = &jdi->dsi->dev;\r\nint ret;\r\nunsigned int i;\r\njdi->mode = &default_mode;\r\nfor (i = 0; i < ARRAY_SIZE(jdi->supplies); i++)\r\njdi->supplies[i].supply = regulator_names[i];\r\nret = devm_regulator_bulk_get(dev, ARRAY_SIZE(jdi->supplies),\r\njdi->supplies);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to init regulator, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\njdi->enable_gpio = devm_gpiod_get(dev, "enable", GPIOD_OUT_LOW);\r\nif (IS_ERR(jdi->enable_gpio)) {\r\nret = PTR_ERR(jdi->enable_gpio);\r\ndev_err(dev, "cannot get enable-gpio %d\n", ret);\r\nreturn ret;\r\n}\r\njdi->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_HIGH);\r\nif (IS_ERR(jdi->reset_gpio)) {\r\nret = PTR_ERR(jdi->reset_gpio);\r\ndev_err(dev, "cannot get reset-gpios %d\n", ret);\r\nreturn ret;\r\n}\r\njdi->dcdc_en_gpio = devm_gpiod_get(dev, "dcdc-en", GPIOD_OUT_LOW);\r\nif (IS_ERR(jdi->dcdc_en_gpio)) {\r\nret = PTR_ERR(jdi->dcdc_en_gpio);\r\ndev_err(dev, "cannot get dcdc-en-gpio %d\n", ret);\r\nreturn ret;\r\n}\r\njdi->backlight = drm_panel_create_dsi_backlight(jdi->dsi);\r\nif (IS_ERR(jdi->backlight)) {\r\nret = PTR_ERR(jdi->backlight);\r\ndev_err(dev, "failed to register backlight %d\n", ret);\r\nreturn ret;\r\n}\r\ndrm_panel_init(&jdi->base);\r\njdi->base.funcs = &jdi_panel_funcs;\r\njdi->base.dev = &jdi->dsi->dev;\r\nret = drm_panel_add(&jdi->base);\r\nreturn ret;\r\n}\r\nstatic void jdi_panel_del(struct jdi_panel *jdi)\r\n{\r\nif (jdi->base.dev)\r\ndrm_panel_remove(&jdi->base);\r\n}\r\nstatic int jdi_panel_probe(struct mipi_dsi_device *dsi)\r\n{\r\nstruct jdi_panel *jdi;\r\nint ret;\r\ndsi->lanes = 4;\r\ndsi->format = MIPI_DSI_FMT_RGB888;\r\ndsi->mode_flags = MIPI_DSI_MODE_VIDEO_HSE | MIPI_DSI_MODE_VIDEO |\r\nMIPI_DSI_CLOCK_NON_CONTINUOUS;\r\njdi = devm_kzalloc(&dsi->dev, sizeof(*jdi), GFP_KERNEL);\r\nif (!jdi)\r\nreturn -ENOMEM;\r\nmipi_dsi_set_drvdata(dsi, jdi);\r\njdi->dsi = dsi;\r\nret = jdi_panel_add(jdi);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn mipi_dsi_attach(dsi);\r\n}\r\nstatic int jdi_panel_remove(struct mipi_dsi_device *dsi)\r\n{\r\nstruct jdi_panel *jdi = mipi_dsi_get_drvdata(dsi);\r\nint ret;\r\nret = jdi_panel_disable(&jdi->base);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to disable panel: %d\n", ret);\r\nret = mipi_dsi_detach(dsi);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to detach from DSI host: %d\n",\r\nret);\r\ndrm_panel_detach(&jdi->base);\r\njdi_panel_del(jdi);\r\nreturn 0;\r\n}\r\nstatic void jdi_panel_shutdown(struct mipi_dsi_device *dsi)\r\n{\r\nstruct jdi_panel *jdi = mipi_dsi_get_drvdata(dsi);\r\njdi_panel_disable(&jdi->base);\r\n}

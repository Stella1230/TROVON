static int iio_dummy_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong mask)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nint ret = -EINVAL;\r\nmutex_lock(&st->lock);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nswitch (chan->type) {\r\ncase IIO_VOLTAGE:\r\nif (chan->output) {\r\n*val = st->dac_val;\r\nret = IIO_VAL_INT;\r\n} else if (chan->differential) {\r\nif (chan->channel == 1)\r\n*val = st->differential_adc_val[0];\r\nelse\r\n*val = st->differential_adc_val[1];\r\nret = IIO_VAL_INT;\r\n} else {\r\n*val = st->single_ended_adc_val;\r\nret = IIO_VAL_INT;\r\n}\r\nbreak;\r\ncase IIO_ACCEL:\r\n*val = st->accel_val;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase IIO_CHAN_INFO_PROCESSED:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\n*val = st->steps;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ncase IIO_ACTIVITY:\r\nswitch (chan->channel2) {\r\ncase IIO_MOD_RUNNING:\r\n*val = st->activity_running;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ncase IIO_MOD_WALKING:\r\n*val = st->activity_walking;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase IIO_CHAN_INFO_OFFSET:\r\n*val = 7;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ncase IIO_CHAN_INFO_SCALE:\r\nswitch (chan->type) {\r\ncase IIO_VOLTAGE:\r\nswitch (chan->differential) {\r\ncase 0:\r\n*val = 0;\r\n*val2 = 1333;\r\nret = IIO_VAL_INT_PLUS_MICRO;\r\nbreak;\r\ncase 1:\r\n*val = 0;\r\n*val2 = 1344;\r\nret = IIO_VAL_INT_PLUS_NANO;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase IIO_CHAN_INFO_CALIBBIAS:\r\n*val = st->accel_calibbias;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\n*val = st->accel_calibscale->val;\r\n*val2 = st->accel_calibscale->val2;\r\nret = IIO_VAL_INT_PLUS_MICRO;\r\nbreak;\r\ncase IIO_CHAN_INFO_SAMP_FREQ:\r\n*val = 3;\r\n*val2 = 33;\r\nret = IIO_VAL_INT_PLUS_NANO;\r\nbreak;\r\ncase IIO_CHAN_INFO_ENABLE:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\n*val = st->steps_enabled;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase IIO_CHAN_INFO_CALIBHEIGHT:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\n*val = st->height;\r\nret = IIO_VAL_INT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nmutex_unlock(&st->lock);\r\nreturn ret;\r\n}\r\nstatic int iio_dummy_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nint i;\r\nint ret = 0;\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nswitch (chan->type) {\r\ncase IIO_VOLTAGE:\r\nif (chan->output == 0)\r\nreturn -EINVAL;\r\nmutex_lock(&st->lock);\r\nst->dac_val = val;\r\nmutex_unlock(&st->lock);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_PROCESSED:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\nmutex_lock(&st->lock);\r\nst->steps = val;\r\nmutex_unlock(&st->lock);\r\nreturn 0;\r\ncase IIO_ACTIVITY:\r\nif (val < 0)\r\nval = 0;\r\nif (val > 100)\r\nval = 100;\r\nswitch (chan->channel2) {\r\ncase IIO_MOD_RUNNING:\r\nst->activity_running = val;\r\nreturn 0;\r\ncase IIO_MOD_WALKING:\r\nst->activity_walking = val;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\nmutex_lock(&st->lock);\r\nfor (i = 0; i < ARRAY_SIZE(dummy_scales); i++)\r\nif (val == dummy_scales[i].val &&\r\nval2 == dummy_scales[i].val2)\r\nbreak;\r\nif (i == ARRAY_SIZE(dummy_scales))\r\nret = -EINVAL;\r\nelse\r\nst->accel_calibscale = &dummy_scales[i];\r\nmutex_unlock(&st->lock);\r\nreturn ret;\r\ncase IIO_CHAN_INFO_CALIBBIAS:\r\nmutex_lock(&st->lock);\r\nst->accel_calibbias = val;\r\nmutex_unlock(&st->lock);\r\nreturn 0;\r\ncase IIO_CHAN_INFO_ENABLE:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\nmutex_lock(&st->lock);\r\nst->steps_enabled = val;\r\nmutex_unlock(&st->lock);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_CALIBHEIGHT:\r\nswitch (chan->type) {\r\ncase IIO_STEPS:\r\nst->height = val;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int iio_dummy_init_device(struct iio_dev *indio_dev)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nst->dac_val = 0;\r\nst->single_ended_adc_val = 73;\r\nst->differential_adc_val[0] = 33;\r\nst->differential_adc_val[1] = -34;\r\nst->accel_val = 34;\r\nst->accel_calibbias = -7;\r\nst->accel_calibscale = &dummy_scales[0];\r\nst->steps = 47;\r\nst->activity_running = 98;\r\nst->activity_walking = 4;\r\nreturn 0;\r\n}\r\nstatic struct iio_sw_device *iio_dummy_probe(const char *name)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev;\r\nstruct iio_dummy_state *st;\r\nstruct iio_sw_device *swd;\r\nswd = kzalloc(sizeof(*swd), GFP_KERNEL);\r\nif (!swd) {\r\nret = -ENOMEM;\r\ngoto error_kzalloc;\r\n}\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (!indio_dev) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nst = iio_priv(indio_dev);\r\nmutex_init(&st->lock);\r\niio_dummy_init_device(indio_dev);\r\nswd->device = indio_dev;\r\nindio_dev->name = kstrdup(name, GFP_KERNEL);\r\nindio_dev->channels = iio_dummy_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(iio_dummy_channels);\r\nindio_dev->info = &iio_dummy_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = iio_simple_dummy_events_register(indio_dev);\r\nif (ret < 0)\r\ngoto error_free_device;\r\nret = iio_simple_dummy_configure_buffer(indio_dev);\r\nif (ret < 0)\r\ngoto error_unregister_events;\r\nret = iio_device_register(indio_dev);\r\nif (ret < 0)\r\ngoto error_unconfigure_buffer;\r\niio_swd_group_init_type_name(swd, name, &iio_dummy_type);\r\nreturn swd;\r\nerror_unconfigure_buffer:\r\niio_simple_dummy_unconfigure_buffer(indio_dev);\r\nerror_unregister_events:\r\niio_simple_dummy_events_unregister(indio_dev);\r\nerror_free_device:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nkfree(swd);\r\nerror_kzalloc:\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic int iio_dummy_remove(struct iio_sw_device *swd)\r\n{\r\nstruct iio_dev *indio_dev = swd->device;\r\niio_device_unregister(indio_dev);\r\niio_simple_dummy_unconfigure_buffer(indio_dev);\r\niio_simple_dummy_events_unregister(indio_dev);\r\nkfree(indio_dev->name);\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}

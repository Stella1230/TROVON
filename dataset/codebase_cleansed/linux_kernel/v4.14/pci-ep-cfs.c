static inline struct pci_epf_group *to_pci_epf_group(struct config_item *item)\r\n{\r\nreturn container_of(to_config_group(item), struct pci_epf_group, group);\r\n}\r\nstatic inline struct pci_epc_group *to_pci_epc_group(struct config_item *item)\r\n{\r\nreturn container_of(to_config_group(item), struct pci_epc_group, group);\r\n}\r\nstatic ssize_t pci_epc_start_store(struct config_item *item, const char *page,\r\nsize_t len)\r\n{\r\nint ret;\r\nbool start;\r\nstruct pci_epc *epc;\r\nstruct pci_epc_group *epc_group = to_pci_epc_group(item);\r\nepc = epc_group->epc;\r\nret = kstrtobool(page, &start);\r\nif (ret)\r\nreturn ret;\r\nif (!start) {\r\npci_epc_stop(epc);\r\nreturn len;\r\n}\r\nret = pci_epc_start(epc);\r\nif (ret) {\r\ndev_err(&epc->dev, "failed to start endpoint controller\n");\r\nreturn -EINVAL;\r\n}\r\nepc_group->start = start;\r\nreturn len;\r\n}\r\nstatic ssize_t pci_epc_start_show(struct config_item *item, char *page)\r\n{\r\nreturn sprintf(page, "%d\n",\r\nto_pci_epc_group(item)->start);\r\n}\r\nstatic int pci_epc_epf_link(struct config_item *epc_item,\r\nstruct config_item *epf_item)\r\n{\r\nint ret;\r\nu32 func_no = 0;\r\nstruct pci_epc *epc;\r\nstruct pci_epf *epf;\r\nstruct pci_epf_group *epf_group = to_pci_epf_group(epf_item);\r\nstruct pci_epc_group *epc_group = to_pci_epc_group(epc_item);\r\nepc = epc_group->epc;\r\nepf = epf_group->epf;\r\nret = pci_epc_add_epf(epc, epf);\r\nif (ret)\r\ngoto err_add_epf;\r\nfunc_no = find_first_zero_bit(&epc_group->function_num_map,\r\nsizeof(epc_group->function_num_map));\r\nset_bit(func_no, &epc_group->function_num_map);\r\nepf->func_no = func_no;\r\nret = pci_epf_bind(epf);\r\nif (ret)\r\ngoto err_epf_bind;\r\nreturn 0;\r\nerr_epf_bind:\r\npci_epc_remove_epf(epc, epf);\r\nerr_add_epf:\r\nclear_bit(func_no, &epc_group->function_num_map);\r\nreturn ret;\r\n}\r\nstatic void pci_epc_epf_unlink(struct config_item *epc_item,\r\nstruct config_item *epf_item)\r\n{\r\nstruct pci_epc *epc;\r\nstruct pci_epf *epf;\r\nstruct pci_epf_group *epf_group = to_pci_epf_group(epf_item);\r\nstruct pci_epc_group *epc_group = to_pci_epc_group(epc_item);\r\nWARN_ON_ONCE(epc_group->start);\r\nepc = epc_group->epc;\r\nepf = epf_group->epf;\r\nclear_bit(epf->func_no, &epc_group->function_num_map);\r\npci_epf_unbind(epf);\r\npci_epc_remove_epf(epc, epf);\r\n}\r\nstruct config_group *pci_ep_cfs_add_epc_group(const char *name)\r\n{\r\nint ret;\r\nstruct pci_epc *epc;\r\nstruct config_group *group;\r\nstruct pci_epc_group *epc_group;\r\nepc_group = kzalloc(sizeof(*epc_group), GFP_KERNEL);\r\nif (!epc_group) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ngroup = &epc_group->group;\r\nconfig_group_init_type_name(group, name, &pci_epc_type);\r\nret = configfs_register_group(controllers_group, group);\r\nif (ret) {\r\npr_err("failed to register configfs group for %s\n", name);\r\ngoto err_register_group;\r\n}\r\nepc = pci_epc_get(name);\r\nif (IS_ERR(epc)) {\r\nret = PTR_ERR(epc);\r\ngoto err_epc_get;\r\n}\r\nepc_group->epc = epc;\r\nreturn group;\r\nerr_epc_get:\r\nconfigfs_unregister_group(group);\r\nerr_register_group:\r\nkfree(epc_group);\r\nerr:\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid pci_ep_cfs_remove_epc_group(struct config_group *group)\r\n{\r\nstruct pci_epc_group *epc_group;\r\nif (!group)\r\nreturn;\r\nepc_group = container_of(group, struct pci_epc_group, group);\r\npci_epc_put(epc_group->epc);\r\nconfigfs_unregister_group(&epc_group->group);\r\nkfree(epc_group);\r\n}\r\nstatic ssize_t pci_epf_msi_interrupts_store(struct config_item *item,\r\nconst char *page, size_t len)\r\n{\r\nu8 val;\r\nint ret;\r\nret = kstrtou8(page, 0, &val);\r\nif (ret)\r\nreturn ret;\r\nto_pci_epf_group(item)->epf->msi_interrupts = val;\r\nreturn len;\r\n}\r\nstatic ssize_t pci_epf_msi_interrupts_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn sprintf(page, "%d\n",\r\nto_pci_epf_group(item)->epf->msi_interrupts);\r\n}\r\nstatic void pci_epf_release(struct config_item *item)\r\n{\r\nstruct pci_epf_group *epf_group = to_pci_epf_group(item);\r\npci_epf_destroy(epf_group->epf);\r\nkfree(epf_group);\r\n}\r\nstatic struct config_group *pci_epf_make(struct config_group *group,\r\nconst char *name)\r\n{\r\nstruct pci_epf_group *epf_group;\r\nstruct pci_epf *epf;\r\nepf_group = kzalloc(sizeof(*epf_group), GFP_KERNEL);\r\nif (!epf_group)\r\nreturn ERR_PTR(-ENOMEM);\r\nconfig_group_init_type_name(&epf_group->group, name, &pci_epf_type);\r\nepf = pci_epf_create(group->cg_item.ci_name);\r\nif (IS_ERR(epf)) {\r\npr_err("failed to create endpoint function device\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nepf_group->epf = epf;\r\nreturn &epf_group->group;\r\n}\r\nstatic void pci_epf_drop(struct config_group *group, struct config_item *item)\r\n{\r\nconfig_item_put(item);\r\n}\r\nstruct config_group *pci_ep_cfs_add_epf_group(const char *name)\r\n{\r\nstruct config_group *group;\r\ngroup = configfs_register_default_group(functions_group, name,\r\n&pci_epf_group_type);\r\nif (IS_ERR(group))\r\npr_err("failed to register configfs group for %s function\n",\r\nname);\r\nreturn group;\r\n}\r\nvoid pci_ep_cfs_remove_epf_group(struct config_group *group)\r\n{\r\nif (IS_ERR_OR_NULL(group))\r\nreturn;\r\nconfigfs_unregister_default_group(group);\r\n}\r\nstatic int __init pci_ep_cfs_init(void)\r\n{\r\nint ret;\r\nstruct config_group *root = &pci_ep_cfs_subsys.su_group;\r\nconfig_group_init(root);\r\nret = configfs_register_subsystem(&pci_ep_cfs_subsys);\r\nif (ret) {\r\npr_err("Error %d while registering subsystem %s\n",\r\nret, root->cg_item.ci_namebuf);\r\ngoto err;\r\n}\r\nfunctions_group = configfs_register_default_group(root, "functions",\r\n&pci_functions_type);\r\nif (IS_ERR(functions_group)) {\r\nret = PTR_ERR(functions_group);\r\npr_err("Error %d while registering functions group\n",\r\nret);\r\ngoto err_functions_group;\r\n}\r\ncontrollers_group =\r\nconfigfs_register_default_group(root, "controllers",\r\n&pci_controllers_type);\r\nif (IS_ERR(controllers_group)) {\r\nret = PTR_ERR(controllers_group);\r\npr_err("Error %d while registering controllers group\n",\r\nret);\r\ngoto err_controllers_group;\r\n}\r\nreturn 0;\r\nerr_controllers_group:\r\nconfigfs_unregister_default_group(functions_group);\r\nerr_functions_group:\r\nconfigfs_unregister_subsystem(&pci_ep_cfs_subsys);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic void __exit pci_ep_cfs_exit(void)\r\n{\r\nconfigfs_unregister_default_group(controllers_group);\r\nconfigfs_unregister_default_group(functions_group);\r\nconfigfs_unregister_subsystem(&pci_ep_cfs_subsys);\r\n}

static irqreturn_t bxt_wcove_tmu_irq_handler(int irq, void *data)\r\n{\r\nstruct wcove_tmu *wctmu = data;\r\nunsigned int tmu_irq;\r\nregmap_read(wctmu->regmap, BXTWC_TMUIRQ, &tmu_irq);\r\nif (tmu_irq & BXTWC_TMU_ALRM_IRQ) {\r\nregmap_write(wctmu->regmap, BXTWC_TMUIRQ, tmu_irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int bxt_wcove_tmu_probe(struct platform_device *pdev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(pdev->dev.parent);\r\nstruct regmap_irq_chip_data *regmap_irq_chip;\r\nstruct wcove_tmu *wctmu;\r\nint ret, virq, irq;\r\nwctmu = devm_kzalloc(&pdev->dev, sizeof(*wctmu), GFP_KERNEL);\r\nif (!wctmu)\r\nreturn -ENOMEM;\r\nwctmu->dev = &pdev->dev;\r\nwctmu->regmap = pmic->regmap;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "invalid irq %d\n", irq);\r\nreturn irq;\r\n}\r\nregmap_irq_chip = pmic->irq_chip_data_tmu;\r\nvirq = regmap_irq_get_virq(regmap_irq_chip, irq);\r\nif (virq < 0) {\r\ndev_err(&pdev->dev,\r\n"failed to get virtual interrupt=%d\n", irq);\r\nreturn virq;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, virq,\r\nNULL, bxt_wcove_tmu_irq_handler,\r\nIRQF_ONESHOT, "bxt_wcove_tmu", wctmu);\r\nif (ret) {\r\ndev_err(&pdev->dev, "request irq failed: %d,virq: %d\n",\r\nret, virq);\r\nreturn ret;\r\n}\r\nwctmu->irq = virq;\r\nregmap_update_bits(wctmu->regmap, BXTWC_MTMUIRQ_REG,\r\nBXTWC_TMU_ALRM_MASK, 0);\r\nplatform_set_drvdata(pdev, wctmu);\r\nreturn 0;\r\n}\r\nstatic int bxt_wcove_tmu_remove(struct platform_device *pdev)\r\n{\r\nstruct wcove_tmu *wctmu = platform_get_drvdata(pdev);\r\nunsigned int val;\r\nregmap_read(wctmu->regmap, BXTWC_MIRQLVL1, &val);\r\nregmap_write(wctmu->regmap, BXTWC_MIRQLVL1,\r\nval | BXTWC_MIRQLVL1_MTMU);\r\nregmap_read(wctmu->regmap, BXTWC_MTMUIRQ_REG, &val);\r\nregmap_write(wctmu->regmap, BXTWC_MTMUIRQ_REG,\r\nval | BXTWC_TMU_ALRM_MASK);\r\nreturn 0;\r\n}\r\nstatic int bxtwc_tmu_suspend(struct device *dev)\r\n{\r\nstruct wcove_tmu *wctmu = dev_get_drvdata(dev);\r\nenable_irq_wake(wctmu->irq);\r\nreturn 0;\r\n}\r\nstatic int bxtwc_tmu_resume(struct device *dev)\r\n{\r\nstruct wcove_tmu *wctmu = dev_get_drvdata(dev);\r\ndisable_irq_wake(wctmu->irq);\r\nreturn 0;\r\n}

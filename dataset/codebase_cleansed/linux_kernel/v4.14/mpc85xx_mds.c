static int mpc8568_fixup_125_clock(struct phy_device *phydev)\r\n{\r\nint scr;\r\nint err;\r\nscr = phy_read(phydev, MV88E1111_SCR);\r\nif (scr < 0)\r\nreturn scr;\r\nerr = phy_write(phydev, MV88E1111_SCR, scr & ~(MV88E1111_SCR_125CLK));\r\nif (err)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err)\r\nreturn err;\r\nscr = phy_read(phydev, MV88E1111_SCR);\r\nif (scr < 0)\r\nreturn scr;\r\nerr = phy_write(phydev, MV88E1111_SCR, scr | 0x0008);\r\nreturn err;\r\n}\r\nstatic int mpc8568_mds_phy_fixups(struct phy_device *phydev)\r\n{\r\nint temp;\r\nint err;\r\nerr = phy_write(phydev,29, 0x0006);\r\nif (err)\r\nreturn err;\r\ntemp = phy_read(phydev, 30);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp = (temp & (~0x8000)) | 0x4000;\r\nerr = phy_write(phydev,30, temp);\r\nif (err)\r\nreturn err;\r\nerr = phy_write(phydev,29, 0x000a);\r\nif (err)\r\nreturn err;\r\ntemp = phy_read(phydev, 30);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp = phy_read(phydev, 30);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~0x0020;\r\nerr = phy_write(phydev,30,temp);\r\nif (err)\r\nreturn err;\r\ntemp = phy_read(phydev, 16);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~0x0060;\r\nerr = phy_write(phydev,16,temp);\r\nreturn err;\r\n}\r\nstatic void __init mpc85xx_mds_reset_ucc_phys(void)\r\n{\r\nstruct device_node *np;\r\nstatic u8 __iomem *bcsr_regs;\r\nnp = of_find_node_by_name(NULL, "bcsr");\r\nif (!np)\r\nreturn;\r\nbcsr_regs = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!bcsr_regs)\r\nreturn;\r\nif (machine_is(mpc8568_mds)) {\r\n#define BCSR_UCC1_GETH_EN (0x1 << 7)\r\n#define BCSR_UCC2_GETH_EN (0x1 << 7)\r\n#define BCSR_UCC1_MODE_MSK (0x3 << 4)\r\n#define BCSR_UCC2_MODE_MSK (0x3 << 0)\r\nclrbits8(&bcsr_regs[8], BCSR_UCC1_GETH_EN);\r\nclrbits8(&bcsr_regs[9], BCSR_UCC2_GETH_EN);\r\nclrbits8(&bcsr_regs[11], BCSR_UCC1_MODE_MSK |\r\nBCSR_UCC2_MODE_MSK);\r\nsetbits8(&bcsr_regs[8], BCSR_UCC1_GETH_EN);\r\nsetbits8(&bcsr_regs[9], BCSR_UCC2_GETH_EN);\r\n} else if (machine_is(mpc8569_mds)) {\r\n#define BCSR7_UCC12_GETHnRST (0x1 << 2)\r\n#define BCSR8_UEM_MARVELL_RST (0x1 << 1)\r\n#define BCSR_UCC_RGMII (0x1 << 6)\r\n#define BCSR_UCC_RTBI (0x1 << 5)\r\nclrbits8(&bcsr_regs[7], BCSR7_UCC12_GETHnRST);\r\nsetbits8(&bcsr_regs[8], BCSR8_UEM_MARVELL_RST);\r\nsetbits8(&bcsr_regs[7], BCSR7_UCC12_GETHnRST);\r\nclrbits8(&bcsr_regs[8], BCSR8_UEM_MARVELL_RST);\r\nfor_each_compatible_node(np, "network", "ucc_geth") {\r\nconst unsigned int *prop;\r\nint ucc_num;\r\nprop = of_get_property(np, "cell-index", NULL);\r\nif (prop == NULL)\r\ncontinue;\r\nucc_num = *prop - 1;\r\nprop = of_get_property(np, "phy-connection-type", NULL);\r\nif (prop == NULL)\r\ncontinue;\r\nif (strcmp("rtbi", (const char *)prop) == 0)\r\nclrsetbits_8(&bcsr_regs[7 + ucc_num],\r\nBCSR_UCC_RGMII, BCSR_UCC_RTBI);\r\n}\r\n} else if (machine_is(p1021_mds)) {\r\n#define BCSR11_ENET_MICRST (0x1 << 5)\r\nclrbits8(&bcsr_regs[11], BCSR11_ENET_MICRST);\r\nsetbits8(&bcsr_regs[11], BCSR11_ENET_MICRST);\r\n}\r\niounmap(bcsr_regs);\r\n}\r\nstatic void __init mpc85xx_mds_qe_init(void)\r\n{\r\nstruct device_node *np;\r\nmpc85xx_qe_init();\r\nmpc85xx_qe_par_io_init();\r\nmpc85xx_mds_reset_ucc_phys();\r\nif (machine_is(p1021_mds)) {\r\nstruct ccsr_guts __iomem *guts;\r\nnp = of_find_node_by_name(NULL, "global-utilities");\r\nif (np) {\r\nguts = of_iomap(np, 0);\r\nif (!guts)\r\npr_err("mpc85xx-rdb: could not map global utilities register\n");\r\nelse{\r\nsetbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(0) |\r\nMPC85xx_PMUXCR_QE(3) |\r\nMPC85xx_PMUXCR_QE(9) |\r\nMPC85xx_PMUXCR_QE(12));\r\niounmap(guts);\r\n}\r\nof_node_put(np);\r\n}\r\n}\r\n}\r\nstatic void __init mpc85xx_mds_qeic_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,qe");\r\nif (!of_device_is_available(np)) {\r\nof_node_put(np);\r\nreturn;\r\n}\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,qe-ic");\r\nif (!np) {\r\nnp = of_find_node_by_type(NULL, "qeic");\r\nif (!np)\r\nreturn;\r\n}\r\nif (machine_is(p1021_mds))\r\nqe_ic_init(np, 0, qe_ic_cascade_low_mpic,\r\nqe_ic_cascade_high_mpic);\r\nelse\r\nqe_ic_init(np, 0, qe_ic_cascade_muxed_mpic, NULL);\r\nof_node_put(np);\r\n}\r\nstatic void __init mpc85xx_mds_qe_init(void) { }\r\nstatic void __init mpc85xx_mds_qeic_init(void) { }\r\nstatic void __init mpc85xx_mds_setup_arch(void)\r\n{\r\nif (ppc_md.progress)\r\nppc_md.progress("mpc85xx_mds_setup_arch()", 0);\r\nmpc85xx_smp_init();\r\nmpc85xx_mds_qe_init();\r\nfsl_pci_assign_primary();\r\nswiotlb_detect_4g();\r\n}\r\nstatic int __init board_fixups(void)\r\n{\r\nchar phy_id[20];\r\nchar *compstrs[2] = {"fsl,gianfar-mdio", "fsl,ucc-mdio"};\r\nstruct device_node *mdio;\r\nstruct resource res;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(compstrs); i++) {\r\nmdio = of_find_compatible_node(NULL, NULL, compstrs[i]);\r\nof_address_to_resource(mdio, 0, &res);\r\nsnprintf(phy_id, sizeof(phy_id), "%llx:%02x",\r\n(unsigned long long)res.start, 1);\r\nphy_register_fixup_for_id(phy_id, mpc8568_fixup_125_clock);\r\nphy_register_fixup_for_id(phy_id, mpc8568_mds_phy_fixups);\r\nsnprintf(phy_id, sizeof(phy_id), "%llx:%02x",\r\n(unsigned long long)res.start, 7);\r\nphy_register_fixup_for_id(phy_id, mpc8568_mds_phy_fixups);\r\nof_node_put(mdio);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init mpc85xx_publish_devices(void)\r\n{\r\nif (machine_is(mpc8568_mds))\r\nsimple_gpiochip_init("fsl,mpc8568mds-bcsr-gpio");\r\nif (machine_is(mpc8569_mds))\r\nsimple_gpiochip_init("fsl,mpc8569mds-bcsr-gpio");\r\nreturn mpc85xx_common_publish_devices();\r\n}\r\nstatic void __init mpc85xx_mds_pic_init(void)\r\n{\r\nstruct mpic *mpic = mpic_alloc(NULL, 0, MPIC_BIG_ENDIAN |\r\nMPIC_SINGLE_DEST_CPU,\r\n0, 256, " OpenPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_init(mpic);\r\nmpc85xx_mds_qeic_init();\r\n}\r\nstatic int __init mpc85xx_mds_probe(void)\r\n{\r\nreturn of_machine_is_compatible("MPC85xxMDS");\r\n}\r\nstatic int __init mpc8569_mds_probe(void)\r\n{\r\nreturn of_machine_is_compatible("fsl,MPC8569EMDS");\r\n}\r\nstatic int __init p1021_mds_probe(void)\r\n{\r\nreturn of_machine_is_compatible("fsl,P1021MDS");\r\n}

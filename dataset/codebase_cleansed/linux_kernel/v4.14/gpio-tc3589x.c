static int tc3589x_gpio_get(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODATA0 + (offset / 8) * 2;\r\nu8 mask = BIT(offset % 8);\r\nint ret;\r\nret = tc3589x_reg_read(tc3589x, reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !!(ret & mask);\r\n}\r\nstatic void tc3589x_gpio_set(struct gpio_chip *chip, unsigned int offset, int val)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODATA0 + (offset / 8) * 2;\r\nunsigned int pos = offset % 8;\r\nu8 data[] = {val ? BIT(pos) : 0, BIT(pos)};\r\ntc3589x_block_write(tc3589x, reg, ARRAY_SIZE(data), data);\r\n}\r\nstatic int tc3589x_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned int offset, int val)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODIR0 + offset / 8;\r\nunsigned int pos = offset % 8;\r\ntc3589x_gpio_set(chip, offset, val);\r\nreturn tc3589x_set_bits(tc3589x, reg, BIT(pos), BIT(pos));\r\n}\r\nstatic int tc3589x_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODIR0 + offset / 8;\r\nunsigned int pos = offset % 8;\r\nreturn tc3589x_set_bits(tc3589x, reg, BIT(pos), 0);\r\n}\r\nstatic int tc3589x_gpio_get_direction(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODIR0 + offset / 8;\r\nunsigned int pos = offset % 8;\r\nint ret;\r\nret = tc3589x_reg_read(tc3589x, reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !(ret & BIT(pos));\r\n}\r\nstatic int tc3589x_gpio_set_config(struct gpio_chip *chip, unsigned int offset,\r\nunsigned long config)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 odmreg = TC3589x_GPIOODM0 + (offset / 8) * 2;\r\nu8 odereg = TC3589x_GPIOODE0 + (offset / 8) * 2;\r\nunsigned int pos = offset % 8;\r\nint ret;\r\nswitch (pinconf_to_config_param(config)) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\nret = tc3589x_set_bits(tc3589x, odmreg, BIT(pos), 0);\r\nif (ret)\r\nreturn ret;\r\nreturn tc3589x_set_bits(tc3589x, odereg, BIT(pos), BIT(pos));\r\ncase PIN_CONFIG_DRIVE_OPEN_SOURCE:\r\nret = tc3589x_set_bits(tc3589x, odmreg, BIT(pos), BIT(pos));\r\nif (ret)\r\nreturn ret;\r\nreturn tc3589x_set_bits(tc3589x, odereg, BIT(pos), BIT(pos));\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nreturn tc3589x_set_bits(tc3589x, odereg, BIT(pos), 0);\r\ndefault:\r\nbreak;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int tc3589x_gpio_irq_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(gc);\r\nint offset = d->hwirq;\r\nint regoffset = offset / 8;\r\nint mask = BIT(offset % 8);\r\nif (type == IRQ_TYPE_EDGE_BOTH) {\r\ntc3589x_gpio->regs[REG_IBE][regoffset] |= mask;\r\nreturn 0;\r\n}\r\ntc3589x_gpio->regs[REG_IBE][regoffset] &= ~mask;\r\nif (type == IRQ_TYPE_LEVEL_LOW || type == IRQ_TYPE_LEVEL_HIGH)\r\ntc3589x_gpio->regs[REG_IS][regoffset] |= mask;\r\nelse\r\ntc3589x_gpio->regs[REG_IS][regoffset] &= ~mask;\r\nif (type == IRQ_TYPE_EDGE_RISING || type == IRQ_TYPE_LEVEL_HIGH)\r\ntc3589x_gpio->regs[REG_IEV][regoffset] |= mask;\r\nelse\r\ntc3589x_gpio->regs[REG_IEV][regoffset] &= ~mask;\r\nreturn 0;\r\n}\r\nstatic void tc3589x_gpio_irq_lock(struct irq_data *d)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(gc);\r\nmutex_lock(&tc3589x_gpio->irq_lock);\r\n}\r\nstatic void tc3589x_gpio_irq_sync_unlock(struct irq_data *d)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(gc);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nstatic const u8 regmap[] = {\r\n[REG_IBE] = TC3589x_GPIOIBE0,\r\n[REG_IEV] = TC3589x_GPIOIEV0,\r\n[REG_IS] = TC3589x_GPIOIS0,\r\n[REG_IE] = TC3589x_GPIOIE0,\r\n};\r\nint i, j;\r\nfor (i = 0; i < CACHE_NR_REGS; i++) {\r\nfor (j = 0; j < CACHE_NR_BANKS; j++) {\r\nu8 old = tc3589x_gpio->oldregs[i][j];\r\nu8 new = tc3589x_gpio->regs[i][j];\r\nif (new == old)\r\ncontinue;\r\ntc3589x_gpio->oldregs[i][j] = new;\r\ntc3589x_reg_write(tc3589x, regmap[i] + j * 8, new);\r\n}\r\n}\r\nmutex_unlock(&tc3589x_gpio->irq_lock);\r\n}\r\nstatic void tc3589x_gpio_irq_mask(struct irq_data *d)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(gc);\r\nint offset = d->hwirq;\r\nint regoffset = offset / 8;\r\nint mask = BIT(offset % 8);\r\ntc3589x_gpio->regs[REG_IE][regoffset] &= ~mask;\r\n}\r\nstatic void tc3589x_gpio_irq_unmask(struct irq_data *d)\r\n{\r\nstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x_gpio *tc3589x_gpio = gpiochip_get_data(gc);\r\nint offset = d->hwirq;\r\nint regoffset = offset / 8;\r\nint mask = BIT(offset % 8);\r\ntc3589x_gpio->regs[REG_IE][regoffset] |= mask;\r\n}\r\nstatic irqreturn_t tc3589x_gpio_irq(int irq, void *dev)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = dev;\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 status[CACHE_NR_BANKS];\r\nint ret;\r\nint i;\r\nret = tc3589x_block_read(tc3589x, TC3589x_GPIOMIS0,\r\nARRAY_SIZE(status), status);\r\nif (ret < 0)\r\nreturn IRQ_NONE;\r\nfor (i = 0; i < ARRAY_SIZE(status); i++) {\r\nunsigned int stat = status[i];\r\nif (!stat)\r\ncontinue;\r\nwhile (stat) {\r\nint bit = __ffs(stat);\r\nint line = i * 8 + bit;\r\nint irq = irq_find_mapping(tc3589x_gpio->chip.irqdomain,\r\nline);\r\nhandle_nested_irq(irq);\r\nstat &= ~(1 << bit);\r\n}\r\ntc3589x_reg_write(tc3589x, TC3589x_GPIOIC0 + i, status[i]);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tc3589x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct tc3589x *tc3589x = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct tc3589x_gpio *tc3589x_gpio;\r\nint ret;\r\nint irq;\r\nif (!np) {\r\ndev_err(&pdev->dev, "No Device Tree node found\n");\r\nreturn -EINVAL;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\ntc3589x_gpio = devm_kzalloc(&pdev->dev, sizeof(struct tc3589x_gpio),\r\nGFP_KERNEL);\r\nif (!tc3589x_gpio)\r\nreturn -ENOMEM;\r\nmutex_init(&tc3589x_gpio->irq_lock);\r\ntc3589x_gpio->dev = &pdev->dev;\r\ntc3589x_gpio->tc3589x = tc3589x;\r\ntc3589x_gpio->chip = template_chip;\r\ntc3589x_gpio->chip.ngpio = tc3589x->num_gpio;\r\ntc3589x_gpio->chip.parent = &pdev->dev;\r\ntc3589x_gpio->chip.base = -1;\r\ntc3589x_gpio->chip.of_node = np;\r\nret = tc3589x_set_bits(tc3589x, TC3589x_RSTCTRL,\r\nTC3589x_RSTCTRL_GPIRST, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = devm_request_threaded_irq(&pdev->dev,\r\nirq, NULL, tc3589x_gpio_irq,\r\nIRQF_ONESHOT, "tc3589x-gpio",\r\ntc3589x_gpio);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to get irq: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_gpiochip_add_data(&pdev->dev, &tc3589x_gpio->chip,\r\ntc3589x_gpio);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to add gpiochip: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = gpiochip_irqchip_add_nested(&tc3589x_gpio->chip,\r\n&tc3589x_gpio_irq_chip,\r\n0,\r\nhandle_simple_irq,\r\nIRQ_TYPE_NONE);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"could not connect irqchip to gpiochip\n");\r\nreturn ret;\r\n}\r\ngpiochip_set_nested_irqchip(&tc3589x_gpio->chip,\r\n&tc3589x_gpio_irq_chip,\r\nirq);\r\nplatform_set_drvdata(pdev, tc3589x_gpio);\r\nreturn 0;\r\n}\r\nstatic int __init tc3589x_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&tc3589x_gpio_driver);\r\n}

static int panic_happened(struct notifier_block *n, unsigned long val, void *v)\r\n{\r\nsuspend_heartbeats = 1;\r\nreturn 0;\r\n}\r\nvoid ibmasm_register_panic_notifier(void)\r\n{\r\natomic_notifier_chain_register(&panic_notifier_list, &panic_notifier);\r\n}\r\nvoid ibmasm_unregister_panic_notifier(void)\r\n{\r\natomic_notifier_chain_unregister(&panic_notifier_list,\r\n&panic_notifier);\r\n}\r\nint ibmasm_heartbeat_init(struct service_processor *sp)\r\n{\r\nsp->heartbeat = ibmasm_new_command(sp, HEARTBEAT_BUFFER_SIZE);\r\nif (sp->heartbeat == NULL)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid ibmasm_heartbeat_exit(struct service_processor *sp)\r\n{\r\nchar tsbuf[32];\r\ndbg("%s:%d at %s\n", __func__, __LINE__, get_timestamp(tsbuf));\r\nibmasm_wait_for_response(sp->heartbeat, IBMASM_CMD_TIMEOUT_NORMAL);\r\ndbg("%s:%d at %s\n", __func__, __LINE__, get_timestamp(tsbuf));\r\nsuspend_heartbeats = 1;\r\ncommand_put(sp->heartbeat);\r\n}\r\nvoid ibmasm_receive_heartbeat(struct service_processor *sp, void *message, size_t size)\r\n{\r\nstruct command *cmd = sp->heartbeat;\r\nstruct dot_command_header *header = (struct dot_command_header *)cmd->buffer;\r\nchar tsbuf[32];\r\ndbg("%s:%d at %s\n", __func__, __LINE__, get_timestamp(tsbuf));\r\nif (suspend_heartbeats)\r\nreturn;\r\ncmd->status = IBMASM_CMD_PENDING;\r\nsize = min(size, cmd->buffer_size);\r\nmemcpy_fromio(cmd->buffer, message, size);\r\nheader->type = sp_write;\r\nibmasm_exec_command(sp, cmd);\r\n}

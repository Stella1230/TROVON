static int hfs_parse_old_pmap(struct super_block *sb, struct old_pmap *pm,\r\nsector_t *part_start, sector_t *part_size)\r\n{\r\nstruct hfsplus_sb_info *sbi = HFSPLUS_SB(sb);\r\nint i;\r\nfor (i = 0; i < 42; i++) {\r\nstruct old_pmap_entry *p = &pm->pdEntry[i];\r\nif (p->pdStart && p->pdSize &&\r\np->pdFSID == cpu_to_be32(0x54465331) &&\r\n(sbi->part < 0 || sbi->part == i)) {\r\n*part_start += be32_to_cpu(p->pdStart);\r\n*part_size = be32_to_cpu(p->pdSize);\r\nreturn 0;\r\n}\r\n}\r\nreturn -ENOENT;\r\n}\r\nstatic int hfs_parse_new_pmap(struct super_block *sb, void *buf,\r\nstruct new_pmap *pm, sector_t *part_start, sector_t *part_size)\r\n{\r\nstruct hfsplus_sb_info *sbi = HFSPLUS_SB(sb);\r\nint size = be32_to_cpu(pm->pmMapBlkCnt);\r\nint buf_size = hfsplus_min_io_size(sb);\r\nint res;\r\nint i = 0;\r\ndo {\r\nif (!memcmp(pm->pmPartType, "Apple_HFS", 9) &&\r\n(sbi->part < 0 || sbi->part == i)) {\r\n*part_start += be32_to_cpu(pm->pmPyPartStart);\r\n*part_size = be32_to_cpu(pm->pmPartBlkCnt);\r\nreturn 0;\r\n}\r\nif (++i >= size)\r\nreturn -ENOENT;\r\npm = (struct new_pmap *)((u8 *)pm + HFSPLUS_SECTOR_SIZE);\r\nif ((u8 *)pm - (u8 *)buf >= buf_size) {\r\nres = hfsplus_submit_bio(sb,\r\n*part_start + HFS_PMAP_BLK + i,\r\nbuf, (void **)&pm, REQ_OP_READ,\r\n0);\r\nif (res)\r\nreturn res;\r\n}\r\n} while (pm->pmSig == cpu_to_be16(HFS_NEW_PMAP_MAGIC));\r\nreturn -ENOENT;\r\n}\r\nint hfs_part_find(struct super_block *sb,\r\nsector_t *part_start, sector_t *part_size)\r\n{\r\nvoid *buf, *data;\r\nint res;\r\nbuf = kmalloc(hfsplus_min_io_size(sb), GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nres = hfsplus_submit_bio(sb, *part_start + HFS_PMAP_BLK,\r\nbuf, &data, REQ_OP_READ, 0);\r\nif (res)\r\ngoto out;\r\nswitch (be16_to_cpu(*((__be16 *)data))) {\r\ncase HFS_OLD_PMAP_MAGIC:\r\nres = hfs_parse_old_pmap(sb, data, part_start, part_size);\r\nbreak;\r\ncase HFS_NEW_PMAP_MAGIC:\r\nres = hfs_parse_new_pmap(sb, buf, data, part_start, part_size);\r\nbreak;\r\ndefault:\r\nres = -ENOENT;\r\nbreak;\r\n}\r\nout:\r\nkfree(buf);\r\nreturn res;\r\n}

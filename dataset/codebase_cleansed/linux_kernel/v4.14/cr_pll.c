static int crvml_sys_restore(struct vml_sys *sys)\r\n{\r\nvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\r\niowrite32(saved_clock, clock_reg);\r\nioread32(clock_reg);\r\nreturn 0;\r\n}\r\nstatic int crvml_sys_save(struct vml_sys *sys)\r\n{\r\nvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\r\nsaved_clock = ioread32(clock_reg);\r\nreturn 0;\r\n}\r\nstatic int crvml_nearest_index(const struct vml_sys *sys, int clock)\r\n{\r\nint i;\r\nint cur_index = 0;\r\nint cur_diff;\r\nint diff;\r\ncur_diff = clock - crvml_clocks[0];\r\ncur_diff = (cur_diff < 0) ? -cur_diff : cur_diff;\r\nfor (i = 1; i < crvml_num_clocks; ++i) {\r\ndiff = clock - crvml_clocks[i];\r\ndiff = (diff < 0) ? -diff : diff;\r\nif (diff < cur_diff) {\r\ncur_index = i;\r\ncur_diff = diff;\r\n}\r\n}\r\nreturn cur_index;\r\n}\r\nstatic int crvml_nearest_clock(const struct vml_sys *sys, int clock)\r\n{\r\nreturn crvml_clocks[crvml_nearest_index(sys, clock)];\r\n}\r\nstatic int crvml_set_clock(struct vml_sys *sys, int clock)\r\n{\r\nvoid __iomem *clock_reg = mch_regs_base + CRVML_REG_CLOCK;\r\nint index;\r\nu32 clock_val;\r\nindex = crvml_nearest_index(sys, clock);\r\nif (crvml_clocks[index] != clock)\r\nreturn -EINVAL;\r\nclock_val = ioread32(clock_reg) & ~CRVML_CLOCK_MASK;\r\nclock_val = crvml_clock_bits[index] << CRVML_CLOCK_SHIFT;\r\niowrite32(clock_val, clock_reg);\r\nioread32(clock_reg);\r\nreturn 0;\r\n}\r\nstatic int __init cr_pll_init(void)\r\n{\r\nint err;\r\nu32 dev_en;\r\nmch_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nCRVML_DEVICE_MCH, NULL);\r\nif (!mch_dev) {\r\nprintk(KERN_ERR\r\n"Could not find Carillo Ranch MCH device.\n");\r\nreturn -ENODEV;\r\n}\r\npci_read_config_dword(mch_dev, CRVML_REG_MCHEN, &dev_en);\r\nif (!(dev_en & CRVML_MCHEN_BIT)) {\r\nprintk(KERN_ERR\r\n"Carillo Ranch MCH device was not enabled.\n");\r\npci_dev_put(mch_dev);\r\nreturn -ENODEV;\r\n}\r\npci_read_config_dword(mch_dev, CRVML_REG_MCHBAR,\r\n&mch_bar);\r\nmch_regs_base =\r\nioremap_nocache(mch_bar, CRVML_MCHMAP_SIZE);\r\nif (!mch_regs_base) {\r\nprintk(KERN_ERR\r\n"Carillo Ranch MCH device was not enabled.\n");\r\npci_dev_put(mch_dev);\r\nreturn -ENODEV;\r\n}\r\nerr = vmlfb_register_subsys(&cr_pll_ops);\r\nif (err) {\r\nprintk(KERN_ERR\r\n"Carillo Ranch failed to initialize vml_sys.\n");\r\niounmap(mch_regs_base);\r\npci_dev_put(mch_dev);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cr_pll_exit(void)\r\n{\r\nvmlfb_unregister_subsys(&cr_pll_ops);\r\niounmap(mch_regs_base);\r\npci_dev_put(mch_dev);\r\n}

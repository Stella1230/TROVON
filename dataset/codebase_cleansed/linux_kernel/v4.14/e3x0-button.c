static irqreturn_t e3x0_button_release_handler(int irq, void *data)\r\n{\r\nstruct input_dev *idev = data;\r\ninput_report_key(idev, KEY_POWER, 0);\r\ninput_sync(idev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t e3x0_button_press_handler(int irq, void *data)\r\n{\r\nstruct input_dev *idev = data;\r\ninput_report_key(idev, KEY_POWER, 1);\r\npm_wakeup_event(idev->dev.parent, 0);\r\ninput_sync(idev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __maybe_unused e3x0_button_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(platform_get_irq_byname(pdev, "press"));\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused e3x0_button_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(platform_get_irq_byname(pdev, "press"));\r\nreturn 0;\r\n}\r\nstatic int e3x0_button_probe(struct platform_device *pdev)\r\n{\r\nstruct input_dev *input;\r\nint irq_press, irq_release;\r\nint error;\r\nirq_press = platform_get_irq_byname(pdev, "press");\r\nif (irq_press < 0) {\r\ndev_err(&pdev->dev, "No IRQ for 'press', error=%d\n",\r\nirq_press);\r\nreturn irq_press;\r\n}\r\nirq_release = platform_get_irq_byname(pdev, "release");\r\nif (irq_release < 0) {\r\ndev_err(&pdev->dev, "No IRQ for 'release', error=%d\n",\r\nirq_release);\r\nreturn irq_release;\r\n}\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ninput->name = "NI Ettus Research USRP E3x0 Button Driver";\r\ninput->phys = "e3x0_button/input0";\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_capability(input, EV_KEY, KEY_POWER);\r\nerror = devm_request_irq(&pdev->dev, irq_press,\r\ne3x0_button_press_handler, 0,\r\n"e3x0-button", input);\r\nif (error) {\r\ndev_err(&pdev->dev, "Failed to request 'press' IRQ#%d: %d\n",\r\nirq_press, error);\r\nreturn error;\r\n}\r\nerror = devm_request_irq(&pdev->dev, irq_release,\r\ne3x0_button_release_handler, 0,\r\n"e3x0-button", input);\r\nif (error) {\r\ndev_err(&pdev->dev, "Failed to request 'release' IRQ#%d: %d\n",\r\nirq_release, error);\r\nreturn error;\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev, "Can't register input device: %d\n", error);\r\nreturn error;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\n}

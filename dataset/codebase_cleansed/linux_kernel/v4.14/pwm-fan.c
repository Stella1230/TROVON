static int __set_pwm(struct pwm_fan_ctx *ctx, unsigned long pwm)\r\n{\r\nunsigned long period;\r\nint ret = 0;\r\nstruct pwm_state state = { };\r\nmutex_lock(&ctx->lock);\r\nif (ctx->pwm_value == pwm)\r\ngoto exit_set_pwm_err;\r\npwm_init_state(ctx->pwm, &state);\r\nperiod = ctx->pwm->args.period;\r\nstate.duty_cycle = DIV_ROUND_UP(pwm * (period - 1), MAX_PWM);\r\nstate.enabled = pwm ? true : false;\r\nret = pwm_apply_state(ctx->pwm, &state);\r\nif (!ret)\r\nctx->pwm_value = pwm;\r\nexit_set_pwm_err:\r\nmutex_unlock(&ctx->lock);\r\nreturn ret;\r\n}\r\nstatic void pwm_fan_update_state(struct pwm_fan_ctx *ctx, unsigned long pwm)\r\n{\r\nint i;\r\nfor (i = 0; i < ctx->pwm_fan_max_state; ++i)\r\nif (pwm < ctx->pwm_fan_cooling_levels[i + 1])\r\nbreak;\r\nctx->pwm_fan_state = i;\r\n}\r\nstatic ssize_t set_pwm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nunsigned long pwm;\r\nint ret;\r\nif (kstrtoul(buf, 10, &pwm) || pwm > MAX_PWM)\r\nreturn -EINVAL;\r\nret = __set_pwm(ctx, pwm);\r\nif (ret)\r\nreturn ret;\r\npwm_fan_update_state(ctx, pwm);\r\nreturn count;\r\n}\r\nstatic ssize_t show_pwm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ctx->pwm_value);\r\n}\r\nstatic int pwm_fan_get_max_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct pwm_fan_ctx *ctx = cdev->devdata;\r\nif (!ctx)\r\nreturn -EINVAL;\r\n*state = ctx->pwm_fan_max_state;\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_get_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct pwm_fan_ctx *ctx = cdev->devdata;\r\nif (!ctx)\r\nreturn -EINVAL;\r\n*state = ctx->pwm_fan_state;\r\nreturn 0;\r\n}\r\nstatic int\r\npwm_fan_set_cur_state(struct thermal_cooling_device *cdev, unsigned long state)\r\n{\r\nstruct pwm_fan_ctx *ctx = cdev->devdata;\r\nint ret;\r\nif (!ctx || (state > ctx->pwm_fan_max_state))\r\nreturn -EINVAL;\r\nif (state == ctx->pwm_fan_state)\r\nreturn 0;\r\nret = __set_pwm(ctx, ctx->pwm_fan_cooling_levels[state]);\r\nif (ret) {\r\ndev_err(&cdev->device, "Cannot set pwm!\n");\r\nreturn ret;\r\n}\r\nctx->pwm_fan_state = state;\r\nreturn ret;\r\n}\r\nstatic int pwm_fan_of_get_cooling_data(struct device *dev,\r\nstruct pwm_fan_ctx *ctx)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nint num, i, ret;\r\nif (!of_find_property(np, "cooling-levels", NULL))\r\nreturn 0;\r\nret = of_property_count_u32_elems(np, "cooling-levels");\r\nif (ret <= 0) {\r\ndev_err(dev, "Wrong data!\n");\r\nreturn ret ? : -EINVAL;\r\n}\r\nnum = ret;\r\nctx->pwm_fan_cooling_levels = devm_kzalloc(dev, num * sizeof(u32),\r\nGFP_KERNEL);\r\nif (!ctx->pwm_fan_cooling_levels)\r\nreturn -ENOMEM;\r\nret = of_property_read_u32_array(np, "cooling-levels",\r\nctx->pwm_fan_cooling_levels, num);\r\nif (ret) {\r\ndev_err(dev, "Property 'cooling-levels' cannot be read!\n");\r\nreturn ret;\r\n}\r\nfor (i = 0; i < num; i++) {\r\nif (ctx->pwm_fan_cooling_levels[i] > MAX_PWM) {\r\ndev_err(dev, "PWM fan state[%d]:%d > %d\n", i,\r\nctx->pwm_fan_cooling_levels[i], MAX_PWM);\r\nreturn -EINVAL;\r\n}\r\n}\r\nctx->pwm_fan_max_state = num - 1;\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_probe(struct platform_device *pdev)\r\n{\r\nstruct thermal_cooling_device *cdev;\r\nstruct pwm_fan_ctx *ctx;\r\nstruct device *hwmon;\r\nint ret;\r\nstruct pwm_state state = { };\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nmutex_init(&ctx->lock);\r\nctx->pwm = devm_of_pwm_get(&pdev->dev, pdev->dev.of_node, NULL);\r\nif (IS_ERR(ctx->pwm)) {\r\ndev_err(&pdev->dev, "Could not get PWM\n");\r\nreturn PTR_ERR(ctx->pwm);\r\n}\r\nplatform_set_drvdata(pdev, ctx);\r\nctx->pwm_value = MAX_PWM;\r\npwm_init_state(ctx->pwm, &state);\r\nstate.duty_cycle = ctx->pwm->args.period - 1;\r\nstate.enabled = true;\r\nret = pwm_apply_state(ctx->pwm, &state);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to configure PWM\n");\r\nreturn ret;\r\n}\r\nhwmon = devm_hwmon_device_register_with_groups(&pdev->dev, "pwmfan",\r\nctx, pwm_fan_groups);\r\nif (IS_ERR(hwmon)) {\r\ndev_err(&pdev->dev, "Failed to register hwmon device\n");\r\nret = PTR_ERR(hwmon);\r\ngoto err_pwm_disable;\r\n}\r\nret = pwm_fan_of_get_cooling_data(&pdev->dev, ctx);\r\nif (ret)\r\nreturn ret;\r\nctx->pwm_fan_state = ctx->pwm_fan_max_state;\r\nif (IS_ENABLED(CONFIG_THERMAL)) {\r\ncdev = thermal_of_cooling_device_register(pdev->dev.of_node,\r\n"pwm-fan", ctx,\r\n&pwm_fan_cooling_ops);\r\nif (IS_ERR(cdev)) {\r\ndev_err(&pdev->dev,\r\n"Failed to register pwm-fan as cooling device");\r\nret = PTR_ERR(cdev);\r\ngoto err_pwm_disable;\r\n}\r\nctx->cdev = cdev;\r\nthermal_cdev_update(cdev);\r\n}\r\nreturn 0;\r\nerr_pwm_disable:\r\nstate.enabled = false;\r\npwm_apply_state(ctx->pwm, &state);\r\nreturn ret;\r\n}\r\nstatic int pwm_fan_remove(struct platform_device *pdev)\r\n{\r\nstruct pwm_fan_ctx *ctx = platform_get_drvdata(pdev);\r\nthermal_cooling_device_unregister(ctx->cdev);\r\nif (ctx->pwm_value)\r\npwm_disable(ctx->pwm);\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_suspend(struct device *dev)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nif (ctx->pwm_value)\r\npwm_disable(ctx->pwm);\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_resume(struct device *dev)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nstruct pwm_args pargs;\r\nunsigned long duty;\r\nint ret;\r\nif (ctx->pwm_value == 0)\r\nreturn 0;\r\npwm_get_args(ctx->pwm, &pargs);\r\nduty = DIV_ROUND_UP(ctx->pwm_value * (pargs.period - 1), MAX_PWM);\r\nret = pwm_config(ctx->pwm, duty, pargs.period);\r\nif (ret)\r\nreturn ret;\r\nreturn pwm_enable(ctx->pwm);\r\n}

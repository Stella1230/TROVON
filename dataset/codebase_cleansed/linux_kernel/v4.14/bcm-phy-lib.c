int bcm_phy_write_exp(struct phy_device *phydev, u16 reg, u16 val)\r\n{\r\nint rc;\r\nrc = phy_write(phydev, MII_BCM54XX_EXP_SEL, reg);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn phy_write(phydev, MII_BCM54XX_EXP_DATA, val);\r\n}\r\nint bcm_phy_read_exp(struct phy_device *phydev, u16 reg)\r\n{\r\nint val;\r\nval = phy_write(phydev, MII_BCM54XX_EXP_SEL, reg);\r\nif (val < 0)\r\nreturn val;\r\nval = phy_read(phydev, MII_BCM54XX_EXP_DATA);\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, 0);\r\nreturn val;\r\n}\r\nint bcm54xx_auxctl_read(struct phy_device *phydev, u16 regnum)\r\n{\r\nphy_write(phydev, MII_BCM54XX_AUX_CTL, regnum |\r\nregnum << MII_BCM54XX_AUXCTL_SHDWSEL_READ_SHIFT);\r\nreturn phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\n}\r\nint bcm54xx_auxctl_write(struct phy_device *phydev, u16 regnum, u16 val)\r\n{\r\nreturn phy_write(phydev, MII_BCM54XX_AUX_CTL, regnum | val);\r\n}\r\nint bcm_phy_write_misc(struct phy_device *phydev,\r\nu16 reg, u16 chl, u16 val)\r\n{\r\nint rc;\r\nint tmp;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\ntmp |= MII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL, tmp);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = (chl * MII_BCM_CHANNEL_WIDTH) | reg;\r\nrc = bcm_phy_write_exp(phydev, tmp, val);\r\nreturn rc;\r\n}\r\nint bcm_phy_read_misc(struct phy_device *phydev,\r\nu16 reg, u16 chl)\r\n{\r\nint rc;\r\nint tmp;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\ntmp |= MII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL, tmp);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = (chl * MII_BCM_CHANNEL_WIDTH) | reg;\r\nrc = bcm_phy_read_exp(phydev, tmp);\r\nreturn rc;\r\n}\r\nint bcm_phy_ack_intr(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BCM54XX_ISR);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn 0;\r\n}\r\nint bcm_phy_config_intr(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BCM54XX_ECR);\r\nif (reg < 0)\r\nreturn reg;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreg &= ~MII_BCM54XX_ECR_IM;\r\nelse\r\nreg |= MII_BCM54XX_ECR_IM;\r\nreturn phy_write(phydev, MII_BCM54XX_ECR, reg);\r\n}\r\nint bcm_phy_read_shadow(struct phy_device *phydev, u16 shadow)\r\n{\r\nphy_write(phydev, MII_BCM54XX_SHD, MII_BCM54XX_SHD_VAL(shadow));\r\nreturn MII_BCM54XX_SHD_DATA(phy_read(phydev, MII_BCM54XX_SHD));\r\n}\r\nint bcm_phy_write_shadow(struct phy_device *phydev, u16 shadow,\r\nu16 val)\r\n{\r\nreturn phy_write(phydev, MII_BCM54XX_SHD,\r\nMII_BCM54XX_SHD_WRITE |\r\nMII_BCM54XX_SHD_VAL(shadow) |\r\nMII_BCM54XX_SHD_DATA(val));\r\n}\r\nint bcm_phy_enable_apd(struct phy_device *phydev, bool dll_pwr_down)\r\n{\r\nint val;\r\nif (dll_pwr_down) {\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_SCR3);\r\nif (val < 0)\r\nreturn val;\r\nval |= BCM54XX_SHD_SCR3_DLLAPD_DIS;\r\nbcm_phy_write_shadow(phydev, BCM54XX_SHD_SCR3, val);\r\n}\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_APD);\r\nif (val < 0)\r\nreturn val;\r\nval &= BCM_APD_CLR_MASK;\r\nif (phydev->autoneg == AUTONEG_ENABLE)\r\nval |= BCM54XX_SHD_APD_EN;\r\nelse\r\nval |= BCM_NO_ANEG_APD_EN;\r\nval |= BCM_APD_SINGLELP_EN;\r\nreturn bcm_phy_write_shadow(phydev, BCM54XX_SHD_APD, val);\r\n}\r\nint bcm_phy_set_eee(struct phy_device *phydev, bool enable)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, BRCM_CL45VEN_EEE_CONTROL);\r\nif (val < 0)\r\nreturn val;\r\nif (enable)\r\nval |= LPI_FEATURE_EN | LPI_FEATURE_EN_DIG1000X;\r\nelse\r\nval &= ~(LPI_FEATURE_EN | LPI_FEATURE_EN_DIG1000X);\r\nphy_write_mmd(phydev, MDIO_MMD_AN, BRCM_CL45VEN_EEE_CONTROL, (u32)val);\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, BCM_CL45VEN_EEE_ADV);\r\nif (val < 0)\r\nreturn val;\r\nif (enable)\r\nval |= (MDIO_EEE_100TX | MDIO_EEE_1000T);\r\nelse\r\nval &= ~(MDIO_EEE_100TX | MDIO_EEE_1000T);\r\nphy_write_mmd(phydev, MDIO_MMD_AN, BCM_CL45VEN_EEE_ADV, (u32)val);\r\nreturn 0;\r\n}\r\nint bcm_phy_downshift_get(struct phy_device *phydev, u8 *count)\r\n{\r\nint val;\r\nval = bcm54xx_auxctl_read(phydev, MII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (val < 0)\r\nreturn val;\r\nif (!(val & MII_BCM54XX_AUXCTL_SHDWSEL_MISC_WIRESPEED_EN)) {\r\n*count = DOWNSHIFT_DEV_DISABLE;\r\nreturn 0;\r\n}\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_SCR2);\r\nif (val < 0)\r\nreturn val;\r\nif (val & BCM54XX_SHD_SCR2_WSPD_RTRY_DIS) {\r\n*count = 1;\r\n} else {\r\nval >>= BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_SHIFT;\r\nval &= BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_MASK;\r\n*count = val + BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_OFFSET;\r\n}\r\nreturn 0;\r\n}\r\nint bcm_phy_downshift_set(struct phy_device *phydev, u8 count)\r\n{\r\nint val = 0, ret = 0;\r\nif (count - BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_OFFSET >\r\nBCM54XX_SHD_SCR2_WSPD_RTRY_LMT_MASK &&\r\ncount != DOWNSHIFT_DEV_DEFAULT_COUNT) {\r\nreturn -ERANGE;\r\n}\r\nval = bcm54xx_auxctl_read(phydev, MII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (val < 0)\r\nreturn val;\r\nval |= MII_BCM54XX_AUXCTL_MISC_WREN;\r\nif (count == DOWNSHIFT_DEV_DISABLE) {\r\nval &= ~MII_BCM54XX_AUXCTL_SHDWSEL_MISC_WIRESPEED_EN;\r\nreturn bcm54xx_auxctl_write(phydev,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC,\r\nval);\r\n} else {\r\nval |= MII_BCM54XX_AUXCTL_SHDWSEL_MISC_WIRESPEED_EN;\r\nret = bcm54xx_auxctl_write(phydev,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC,\r\nval);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_SCR2);\r\nval &= ~(BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_MASK <<\r\nBCM54XX_SHD_SCR2_WSPD_RTRY_LMT_SHIFT |\r\nBCM54XX_SHD_SCR2_WSPD_RTRY_DIS);\r\nswitch (count) {\r\ncase 1:\r\nval |= BCM54XX_SHD_SCR2_WSPD_RTRY_DIS;\r\nbreak;\r\ncase DOWNSHIFT_DEV_DEFAULT_COUNT:\r\nval |= 1 << BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_SHIFT;\r\nbreak;\r\ndefault:\r\nval |= (count - BCM54XX_SHD_SCR2_WSPD_RTRY_LMT_OFFSET) <<\r\nBCM54XX_SHD_SCR2_WSPD_RTRY_LMT_SHIFT;\r\nbreak;\r\n}\r\nreturn bcm_phy_write_shadow(phydev, BCM54XX_SHD_SCR2, val);\r\n}\r\nint bcm_phy_get_sset_count(struct phy_device *phydev)\r\n{\r\nreturn ARRAY_SIZE(bcm_phy_hw_stats);\r\n}\r\nvoid bcm_phy_get_strings(struct phy_device *phydev, u8 *data)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(bcm_phy_hw_stats); i++)\r\nmemcpy(data + i * ETH_GSTRING_LEN,\r\nbcm_phy_hw_stats[i].string, ETH_GSTRING_LEN);\r\n}\r\nstatic u64 bcm_phy_get_stat(struct phy_device *phydev, u64 *shadow,\r\nunsigned int i)\r\n{\r\nstruct bcm_phy_hw_stat stat = bcm_phy_hw_stats[i];\r\nint val;\r\nu64 ret;\r\nval = phy_read(phydev, stat.reg);\r\nif (val < 0) {\r\nret = UINT64_MAX;\r\n} else {\r\nval >>= stat.shift;\r\nval = val & ((1 << stat.bits) - 1);\r\nshadow[i] += val;\r\nret = shadow[i];\r\n}\r\nreturn ret;\r\n}\r\nvoid bcm_phy_get_stats(struct phy_device *phydev, u64 *shadow,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(bcm_phy_hw_stats); i++)\r\ndata[i] = bcm_phy_get_stat(phydev, shadow, i);\r\n}

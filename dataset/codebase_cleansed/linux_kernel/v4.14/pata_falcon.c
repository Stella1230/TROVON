static unsigned int pata_falcon_data_xfer(struct ata_queued_cmd *qc,\r\nunsigned char *buf,\r\nunsigned int buflen, int rw)\r\n{\r\nstruct ata_device *dev = qc->dev;\r\nstruct ata_port *ap = dev->link->ap;\r\nvoid __iomem *data_addr = ap->ioaddr.data_addr;\r\nunsigned int words = buflen >> 1;\r\nstruct scsi_cmnd *cmd = qc->scsicmd;\r\nbool swap = 1;\r\nif (dev->class == ATA_DEV_ATA && cmd && cmd->request &&\r\n!blk_rq_is_passthrough(cmd->request))\r\nswap = 0;\r\nif (rw == READ) {\r\nif (swap)\r\nraw_insw_swapw((u16 *)data_addr, (u16 *)buf, words);\r\nelse\r\nraw_insw((u16 *)data_addr, (u16 *)buf, words);\r\n} else {\r\nif (swap)\r\nraw_outsw_swapw((u16 *)data_addr, (u16 *)buf, words);\r\nelse\r\nraw_outsw((u16 *)data_addr, (u16 *)buf, words);\r\n}\r\nif (unlikely(buflen & 0x01)) {\r\nunsigned char pad[2] = { };\r\nbuf += buflen - 1;\r\nif (rw == READ) {\r\nif (swap)\r\nraw_insw_swapw((u16 *)data_addr, (u16 *)pad, 1);\r\nelse\r\nraw_insw((u16 *)data_addr, (u16 *)pad, 1);\r\n*buf = pad[0];\r\n} else {\r\npad[0] = *buf;\r\nif (swap)\r\nraw_outsw_swapw((u16 *)data_addr, (u16 *)pad, 1);\r\nelse\r\nraw_outsw((u16 *)data_addr, (u16 *)pad, 1);\r\n}\r\nwords++;\r\n}\r\nreturn words << 1;\r\n}\r\nstatic int pata_falcon_set_mode(struct ata_link *link,\r\nstruct ata_device **unused)\r\n{\r\nstruct ata_device *dev;\r\nata_for_each_dev(dev, link, ENABLED) {\r\ndev->pio_mode = dev->xfer_mode = XFER_PIO_0;\r\ndev->xfer_shift = ATA_SHIFT_PIO;\r\ndev->flags |= ATA_DFLAG_PIO;\r\nata_dev_info(dev, "configured for PIO\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int pata_falcon_init_one(void)\r\n{\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nstruct platform_device *pdev;\r\nvoid __iomem *base;\r\nif (!MACH_IS_ATARI || !ATARIHW_PRESENT(IDE))\r\nreturn -ENODEV;\r\npr_info(DRV_NAME ": Atari Falcon PATA controller\n");\r\npdev = platform_device_register_simple(DRV_NAME, 0, NULL, 0);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\nif (!devm_request_mem_region(&pdev->dev, ATA_HD_BASE, 0x40, DRV_NAME)) {\r\npr_err(DRV_NAME ": resources busy\n");\r\nreturn -EBUSY;\r\n}\r\nhost = ata_host_alloc(&pdev->dev, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\nap = host->ports[0];\r\nap->ops = &pata_falcon_ops;\r\nap->pio_mask = ATA_PIO4;\r\nap->flags |= ATA_FLAG_SLAVE_POSS | ATA_FLAG_NO_IORDY;\r\nap->flags |= ATA_FLAG_PIO_POLLING;\r\nbase = (void __iomem *)ATA_HD_BASE;\r\nap->ioaddr.data_addr = base;\r\nap->ioaddr.error_addr = base + 1 + 1 * 4;\r\nap->ioaddr.feature_addr = base + 1 + 1 * 4;\r\nap->ioaddr.nsect_addr = base + 1 + 2 * 4;\r\nap->ioaddr.lbal_addr = base + 1 + 3 * 4;\r\nap->ioaddr.lbam_addr = base + 1 + 4 * 4;\r\nap->ioaddr.lbah_addr = base + 1 + 5 * 4;\r\nap->ioaddr.device_addr = base + 1 + 6 * 4;\r\nap->ioaddr.status_addr = base + 1 + 7 * 4;\r\nap->ioaddr.command_addr = base + 1 + 7 * 4;\r\nap->ioaddr.altstatus_addr = base + ATA_HD_CONTROL;\r\nap->ioaddr.ctl_addr = base + ATA_HD_CONTROL;\r\nata_port_desc(ap, "cmd 0x%lx ctl 0x%lx", (unsigned long)base,\r\n(unsigned long)base + ATA_HD_CONTROL);\r\nreturn ata_host_activate(host, 0, NULL, 0, &pata_falcon_sht);\r\n}

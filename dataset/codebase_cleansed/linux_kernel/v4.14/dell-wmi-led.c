static int dell_led_perform_fn(u8 length, u8 result_code, u8 device_id,\r\nu8 command, u8 on_time, u8 off_time)\r\n{\r\nstruct acpi_buffer output = { ACPI_ALLOCATE_BUFFER, NULL };\r\nstruct bios_args *bios_return;\r\nstruct acpi_buffer input;\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nu8 return_code;\r\nstruct bios_args args = {\r\n.length = length,\r\n.result_code = result_code,\r\n.device_id = device_id,\r\n.command = command,\r\n.on_time = on_time,\r\n.off_time = off_time\r\n};\r\ninput.length = sizeof(struct bios_args);\r\ninput.pointer = &args;\r\nstatus = wmi_evaluate_method(DELL_LED_BIOS_GUID, 0, 1, &input, &output);\r\nif (ACPI_FAILURE(status))\r\nreturn status;\r\nobj = output.pointer;\r\nif (!obj)\r\nreturn -EINVAL;\r\nif (obj->type != ACPI_TYPE_BUFFER) {\r\nkfree(obj);\r\nreturn -EINVAL;\r\n}\r\nbios_return = ((struct bios_args *)obj->buffer.pointer);\r\nreturn_code = bios_return->result_code;\r\nkfree(obj);\r\nreturn return_code;\r\n}\r\nstatic int led_on(void)\r\n{\r\nreturn dell_led_perform_fn(3,\r\nINTERFACE_ERROR,\r\nDEVICE_ID_PANEL_BACK,\r\nCMD_LED_ON,\r\n0,\r\n0);\r\n}\r\nstatic int led_off(void)\r\n{\r\nreturn dell_led_perform_fn(3,\r\nINTERFACE_ERROR,\r\nDEVICE_ID_PANEL_BACK,\r\nCMD_LED_OFF,\r\n0,\r\n0);\r\n}\r\nstatic int led_blink(unsigned char on_eighths, unsigned char off_eighths)\r\n{\r\nreturn dell_led_perform_fn(5,\r\nINTERFACE_ERROR,\r\nDEVICE_ID_PANEL_BACK,\r\nCMD_LED_BLINK,\r\non_eighths,\r\noff_eighths);\r\n}\r\nstatic void dell_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nif (value == LED_OFF)\r\nled_off();\r\nelse\r\nled_on();\r\n}\r\nstatic int dell_led_blink(struct led_classdev *led_cdev,\r\nunsigned long *delay_on, unsigned long *delay_off)\r\n{\r\nunsigned long on_eighths;\r\nunsigned long off_eighths;\r\non_eighths = DIV_ROUND_UP(*delay_on, 125);\r\non_eighths = clamp_t(unsigned long, on_eighths, 1, 255);\r\n*delay_on = on_eighths * 125;\r\noff_eighths = DIV_ROUND_UP(*delay_off, 125);\r\noff_eighths = clamp_t(unsigned long, off_eighths, 1, 255);\r\n*delay_off = off_eighths * 125;\r\nled_blink(on_eighths, off_eighths);\r\nreturn 0;\r\n}\r\nstatic int __init dell_led_init(void)\r\n{\r\nint error = 0;\r\nif (!wmi_has_guid(DELL_LED_BIOS_GUID))\r\nreturn -ENODEV;\r\nerror = led_off();\r\nif (error != 0)\r\nreturn -ENODEV;\r\nreturn led_classdev_register(NULL, &dell_led);\r\n}\r\nstatic void __exit dell_led_exit(void)\r\n{\r\nled_classdev_unregister(&dell_led);\r\nled_off();\r\n}

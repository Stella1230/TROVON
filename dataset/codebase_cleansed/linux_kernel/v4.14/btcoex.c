static s32 brcmf_btcoex_params_write(struct brcmf_if *ifp, u32 addr, u32 data)\r\n{\r\nstruct {\r\n__le32 addr;\r\n__le32 data;\r\n} reg_write;\r\nreg_write.addr = cpu_to_le32(addr);\r\nreg_write.data = cpu_to_le32(data);\r\nreturn brcmf_fil_iovar_data_set(ifp, "btc_params",\r\n&reg_write, sizeof(reg_write));\r\n}\r\nstatic s32 brcmf_btcoex_params_read(struct brcmf_if *ifp, u32 addr, u32 *data)\r\n{\r\n*data = addr;\r\nreturn brcmf_fil_iovar_int_get(ifp, "btc_params", data);\r\n}\r\nstatic void brcmf_btcoex_boost_wifi(struct brcmf_btcoex_info *btci,\r\nbool trump_sco)\r\n{\r\nstruct brcmf_if *ifp = brcmf_get_ifp(btci->cfg->pub, 0);\r\nif (trump_sco && !btci->saved_regs_part2) {\r\nbrcmf_dbg(INFO, "new SCO/eSCO coex algo {save & override}\n");\r\nbrcmf_btcoex_params_read(ifp, 50, &btci->reg50);\r\nbrcmf_btcoex_params_read(ifp, 51, &btci->reg51);\r\nbrcmf_btcoex_params_read(ifp, 64, &btci->reg64);\r\nbrcmf_btcoex_params_read(ifp, 65, &btci->reg65);\r\nbrcmf_btcoex_params_read(ifp, 71, &btci->reg71);\r\nbtci->saved_regs_part2 = true;\r\nbrcmf_dbg(INFO,\r\n"saved bt_params[50,51,64,65,71]: 0x%x 0x%x 0x%x 0x%x 0x%x\n",\r\nbtci->reg50, btci->reg51, btci->reg64,\r\nbtci->reg65, btci->reg71);\r\nbrcmf_btcoex_params_write(ifp, 50, BRCMF_BT_DHCP_REG50);\r\nbrcmf_btcoex_params_write(ifp, 51, BRCMF_BT_DHCP_REG51);\r\nbrcmf_btcoex_params_write(ifp, 64, BRCMF_BT_DHCP_REG64);\r\nbrcmf_btcoex_params_write(ifp, 65, BRCMF_BT_DHCP_REG65);\r\nbrcmf_btcoex_params_write(ifp, 71, BRCMF_BT_DHCP_REG71);\r\n} else if (btci->saved_regs_part2) {\r\nbrcmf_dbg(INFO, "Do new SCO/eSCO coex algo {restore}\n");\r\nbrcmf_btcoex_params_write(ifp, 50, btci->reg50);\r\nbrcmf_btcoex_params_write(ifp, 51, btci->reg51);\r\nbrcmf_btcoex_params_write(ifp, 64, btci->reg64);\r\nbrcmf_btcoex_params_write(ifp, 65, btci->reg65);\r\nbrcmf_btcoex_params_write(ifp, 71, btci->reg71);\r\nbrcmf_dbg(INFO,\r\n"restored bt_params[50,51,64,65,71]: 0x%x 0x%x 0x%x 0x%x 0x%x\n",\r\nbtci->reg50, btci->reg51, btci->reg64,\r\nbtci->reg65, btci->reg71);\r\nbtci->saved_regs_part2 = false;\r\n} else {\r\nbrcmf_dbg(INFO, "attempted to restore not saved BTCOEX params\n");\r\n}\r\n}\r\nstatic bool brcmf_btcoex_is_sco_active(struct brcmf_if *ifp)\r\n{\r\nint ioc_res = 0;\r\nbool res = false;\r\nint sco_id_cnt = 0;\r\nu32 param27;\r\nint i;\r\nfor (i = 0; i < BRCMF_BT_SCO_SAMPLES; i++) {\r\nioc_res = brcmf_btcoex_params_read(ifp, 27, &param27);\r\nif (ioc_res < 0) {\r\nbrcmf_err("ioc read btc params error\n");\r\nbreak;\r\n}\r\nbrcmf_dbg(INFO, "sample[%d], btc_params 27:%x\n", i, param27);\r\nif ((param27 & 0x6) == 2) {\r\nsco_id_cnt++;\r\n}\r\nif (sco_id_cnt > 2) {\r\nbrcmf_dbg(INFO,\r\n"sco/esco detected, pkt id_cnt:%d samples:%d\n",\r\nsco_id_cnt, i);\r\nres = true;\r\nbreak;\r\n}\r\n}\r\nbrcmf_dbg(TRACE, "exit: result=%d\n", res);\r\nreturn res;\r\n}\r\nstatic void btcmf_btcoex_save_part1(struct brcmf_btcoex_info *btci)\r\n{\r\nstruct brcmf_if *ifp = btci->vif->ifp;\r\nif (!btci->saved_regs_part1) {\r\nbrcmf_btcoex_params_read(ifp, 66, &btci->reg66);\r\nbrcmf_btcoex_params_read(ifp, 41, &btci->reg41);\r\nbrcmf_btcoex_params_read(ifp, 68, &btci->reg68);\r\nbtci->saved_regs_part1 = true;\r\nbrcmf_dbg(INFO,\r\n"saved btc_params regs (66,41,68) 0x%x 0x%x 0x%x\n",\r\nbtci->reg66, btci->reg41,\r\nbtci->reg68);\r\n}\r\n}\r\nstatic void brcmf_btcoex_restore_part1(struct brcmf_btcoex_info *btci)\r\n{\r\nstruct brcmf_if *ifp;\r\nif (btci->saved_regs_part1) {\r\nbtci->saved_regs_part1 = false;\r\nifp = btci->vif->ifp;\r\nbrcmf_btcoex_params_write(ifp, 66, btci->reg66);\r\nbrcmf_btcoex_params_write(ifp, 41, btci->reg41);\r\nbrcmf_btcoex_params_write(ifp, 68, btci->reg68);\r\nbrcmf_dbg(INFO,\r\n"restored btc_params regs {66,41,68} 0x%x 0x%x 0x%x\n",\r\nbtci->reg66, btci->reg41,\r\nbtci->reg68);\r\n}\r\n}\r\nstatic void brcmf_btcoex_timerfunc(ulong data)\r\n{\r\nstruct brcmf_btcoex_info *bt_local = (struct brcmf_btcoex_info *)data;\r\nbrcmf_dbg(TRACE, "enter\n");\r\nbt_local->timer_on = false;\r\nschedule_work(&bt_local->work);\r\n}\r\nstatic void brcmf_btcoex_handler(struct work_struct *work)\r\n{\r\nstruct brcmf_btcoex_info *btci;\r\nbtci = container_of(work, struct brcmf_btcoex_info, work);\r\nif (btci->timer_on) {\r\nbtci->timer_on = false;\r\ndel_timer_sync(&btci->timer);\r\n}\r\nswitch (btci->bt_state) {\r\ncase BRCMF_BT_DHCP_START:\r\nbrcmf_dbg(INFO, "DHCP started\n");\r\nbtci->bt_state = BRCMF_BT_DHCP_OPPR_WIN;\r\nif (btci->timeout < BRCMF_BTCOEX_OPPR_WIN_TIME) {\r\nmod_timer(&btci->timer, btci->timer.expires);\r\n} else {\r\nbtci->timeout -= BRCMF_BTCOEX_OPPR_WIN_TIME;\r\nmod_timer(&btci->timer,\r\njiffies + BRCMF_BTCOEX_OPPR_WIN_TIME);\r\n}\r\nbtci->timer_on = true;\r\nbreak;\r\ncase BRCMF_BT_DHCP_OPPR_WIN:\r\nif (btci->dhcp_done) {\r\nbrcmf_dbg(INFO, "DHCP done before T1 expiration\n");\r\ngoto idle;\r\n}\r\nbrcmf_dbg(INFO, "DHCP T1:%d expired\n",\r\njiffies_to_msecs(BRCMF_BTCOEX_OPPR_WIN_TIME));\r\nbrcmf_btcoex_boost_wifi(btci, true);\r\nbtci->bt_state = BRCMF_BT_DHCP_FLAG_FORCE_TIMEOUT;\r\nmod_timer(&btci->timer, jiffies + btci->timeout);\r\nbtci->timer_on = true;\r\nbreak;\r\ncase BRCMF_BT_DHCP_FLAG_FORCE_TIMEOUT:\r\nif (btci->dhcp_done)\r\nbrcmf_dbg(INFO, "DHCP done before T2 expiration\n");\r\nelse\r\nbrcmf_dbg(INFO, "DHCP T2:%d expired\n",\r\nBRCMF_BT_DHCP_FLAG_FORCE_TIMEOUT);\r\ngoto idle;\r\ndefault:\r\nbrcmf_err("invalid state=%d !!!\n", btci->bt_state);\r\ngoto idle;\r\n}\r\nreturn;\r\nidle:\r\nbtci->bt_state = BRCMF_BT_DHCP_IDLE;\r\nbtci->timer_on = false;\r\nbrcmf_btcoex_boost_wifi(btci, false);\r\ncfg80211_crit_proto_stopped(&btci->vif->wdev, GFP_KERNEL);\r\nbrcmf_btcoex_restore_part1(btci);\r\nbtci->vif = NULL;\r\n}\r\nint brcmf_btcoex_attach(struct brcmf_cfg80211_info *cfg)\r\n{\r\nstruct brcmf_btcoex_info *btci = NULL;\r\nbrcmf_dbg(TRACE, "enter\n");\r\nbtci = kmalloc(sizeof(struct brcmf_btcoex_info), GFP_KERNEL);\r\nif (!btci)\r\nreturn -ENOMEM;\r\nbtci->bt_state = BRCMF_BT_DHCP_IDLE;\r\nbtci->timer_on = false;\r\nbtci->timeout = BRCMF_BTCOEX_OPPR_WIN_TIME;\r\nsetup_timer(&btci->timer, brcmf_btcoex_timerfunc, (ulong)btci);\r\nbtci->cfg = cfg;\r\nbtci->saved_regs_part1 = false;\r\nbtci->saved_regs_part2 = false;\r\nINIT_WORK(&btci->work, brcmf_btcoex_handler);\r\ncfg->btcoex = btci;\r\nreturn 0;\r\n}\r\nvoid brcmf_btcoex_detach(struct brcmf_cfg80211_info *cfg)\r\n{\r\nbrcmf_dbg(TRACE, "enter\n");\r\nif (!cfg->btcoex)\r\nreturn;\r\nif (cfg->btcoex->timer_on) {\r\ncfg->btcoex->timer_on = false;\r\ndel_timer_sync(&cfg->btcoex->timer);\r\n}\r\ncancel_work_sync(&cfg->btcoex->work);\r\nbrcmf_btcoex_boost_wifi(cfg->btcoex, false);\r\nbrcmf_btcoex_restore_part1(cfg->btcoex);\r\nkfree(cfg->btcoex);\r\ncfg->btcoex = NULL;\r\n}\r\nstatic void brcmf_btcoex_dhcp_start(struct brcmf_btcoex_info *btci)\r\n{\r\nstruct brcmf_if *ifp = btci->vif->ifp;\r\nbtcmf_btcoex_save_part1(btci);\r\nbrcmf_btcoex_params_write(ifp, 66, BRCMF_BT_DHCP_REG66);\r\nbrcmf_btcoex_params_write(ifp, 41, BRCMF_BT_DHCP_REG41);\r\nbrcmf_btcoex_params_write(ifp, 68, BRCMF_BT_DHCP_REG68);\r\nbtci->dhcp_done = false;\r\nbtci->bt_state = BRCMF_BT_DHCP_START;\r\nschedule_work(&btci->work);\r\nbrcmf_dbg(TRACE, "enable BT DHCP Timer\n");\r\n}\r\nstatic void brcmf_btcoex_dhcp_end(struct brcmf_btcoex_info *btci)\r\n{\r\nbtci->dhcp_done = true;\r\nif (btci->timer_on) {\r\nbrcmf_dbg(INFO, "disable BT DHCP Timer\n");\r\nbtci->timer_on = false;\r\ndel_timer_sync(&btci->timer);\r\nif (btci->bt_state != BRCMF_BT_DHCP_IDLE) {\r\nbrcmf_dbg(INFO, "bt_state:%d\n",\r\nbtci->bt_state);\r\nschedule_work(&btci->work);\r\n}\r\n} else {\r\nbrcmf_btcoex_restore_part1(btci);\r\n}\r\n}\r\nint brcmf_btcoex_set_mode(struct brcmf_cfg80211_vif *vif,\r\nenum brcmf_btcoex_mode mode, u16 duration)\r\n{\r\nstruct brcmf_cfg80211_info *cfg = wiphy_priv(vif->wdev.wiphy);\r\nstruct brcmf_btcoex_info *btci = cfg->btcoex;\r\nstruct brcmf_if *ifp = brcmf_get_ifp(cfg->pub, 0);\r\nswitch (mode) {\r\ncase BRCMF_BTCOEX_DISABLED:\r\nbrcmf_dbg(INFO, "DHCP session starts\n");\r\nif (btci->bt_state != BRCMF_BT_DHCP_IDLE)\r\nreturn -EBUSY;\r\nif (brcmf_btcoex_is_sco_active(ifp)) {\r\nbtci->timeout = msecs_to_jiffies(duration);\r\nbtci->vif = vif;\r\nbrcmf_btcoex_dhcp_start(btci);\r\n}\r\nbreak;\r\ncase BRCMF_BTCOEX_ENABLED:\r\nbrcmf_dbg(INFO, "DHCP session ends\n");\r\nif (btci->bt_state != BRCMF_BT_DHCP_IDLE &&\r\nvif == btci->vif) {\r\nbrcmf_btcoex_dhcp_end(btci);\r\n}\r\nbreak;\r\ndefault:\r\nbrcmf_dbg(INFO, "Unknown mode, ignored\n");\r\n}\r\nreturn 0;\r\n}

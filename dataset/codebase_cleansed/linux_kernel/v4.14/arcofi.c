static void\r\nadd_arcofi_timer(struct IsdnCardState *cs) {\r\nif (test_and_set_bit(FLG_ARCOFI_TIMER, &cs->HW_Flags)) {\r\ndel_timer(&cs->dc.isac.arcofitimer);\r\n}\r\ninit_timer(&cs->dc.isac.arcofitimer);\r\ncs->dc.isac.arcofitimer.expires = jiffies + ((ARCOFI_TIMER_VALUE * HZ) / 1000);\r\nadd_timer(&cs->dc.isac.arcofitimer);\r\n}\r\nstatic void\r\nsend_arcofi(struct IsdnCardState *cs) {\r\nadd_arcofi_timer(cs);\r\ncs->dc.isac.mon_txp = 0;\r\ncs->dc.isac.mon_txc = cs->dc.isac.arcofi_list->len;\r\nmemcpy(cs->dc.isac.mon_tx, cs->dc.isac.arcofi_list->msg, cs->dc.isac.mon_txc);\r\nswitch (cs->dc.isac.arcofi_bc) {\r\ncase 0: break;\r\ncase 1: cs->dc.isac.mon_tx[1] |= 0x40;\r\nbreak;\r\ndefault: break;\r\n}\r\ncs->dc.isac.mocr &= 0x0f;\r\ncs->dc.isac.mocr |= 0xa0;\r\ncs->writeisac(cs, ISAC_MOCR, cs->dc.isac.mocr);\r\n(void) cs->readisac(cs, ISAC_MOSR);\r\ncs->writeisac(cs, ISAC_MOX1, cs->dc.isac.mon_tx[cs->dc.isac.mon_txp++]);\r\ncs->dc.isac.mocr |= 0x10;\r\ncs->writeisac(cs, ISAC_MOCR, cs->dc.isac.mocr);\r\n}\r\nint\r\narcofi_fsm(struct IsdnCardState *cs, int event, void *data) {\r\nif (cs->debug & L1_DEB_MONITOR) {\r\ndebugl1(cs, "arcofi state %d event %d", cs->dc.isac.arcofi_state, event);\r\n}\r\nif (event == ARCOFI_TIMEOUT) {\r\ncs->dc.isac.arcofi_state = ARCOFI_NOP;\r\ntest_and_set_bit(FLG_ARCOFI_ERROR, &cs->HW_Flags);\r\nwake_up(&cs->dc.isac.arcofi_wait);\r\nreturn (1);\r\n}\r\nswitch (cs->dc.isac.arcofi_state) {\r\ncase ARCOFI_NOP:\r\nif (event == ARCOFI_START) {\r\ncs->dc.isac.arcofi_list = data;\r\ncs->dc.isac.arcofi_state = ARCOFI_TRANSMIT;\r\nsend_arcofi(cs);\r\n}\r\nbreak;\r\ncase ARCOFI_TRANSMIT:\r\nif (event == ARCOFI_TX_END) {\r\nif (cs->dc.isac.arcofi_list->receive) {\r\nadd_arcofi_timer(cs);\r\ncs->dc.isac.arcofi_state = ARCOFI_RECEIVE;\r\n} else {\r\nif (cs->dc.isac.arcofi_list->next) {\r\ncs->dc.isac.arcofi_list =\r\ncs->dc.isac.arcofi_list->next;\r\nsend_arcofi(cs);\r\n} else {\r\nif (test_and_clear_bit(FLG_ARCOFI_TIMER, &cs->HW_Flags)) {\r\ndel_timer(&cs->dc.isac.arcofitimer);\r\n}\r\ncs->dc.isac.arcofi_state = ARCOFI_NOP;\r\nwake_up(&cs->dc.isac.arcofi_wait);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ARCOFI_RECEIVE:\r\nif (event == ARCOFI_RX_END) {\r\nif (cs->dc.isac.arcofi_list->next) {\r\ncs->dc.isac.arcofi_list =\r\ncs->dc.isac.arcofi_list->next;\r\ncs->dc.isac.arcofi_state = ARCOFI_TRANSMIT;\r\nsend_arcofi(cs);\r\n} else {\r\nif (test_and_clear_bit(FLG_ARCOFI_TIMER, &cs->HW_Flags)) {\r\ndel_timer(&cs->dc.isac.arcofitimer);\r\n}\r\ncs->dc.isac.arcofi_state = ARCOFI_NOP;\r\nwake_up(&cs->dc.isac.arcofi_wait);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\ndebugl1(cs, "Arcofi unknown state %x", cs->dc.isac.arcofi_state);\r\nreturn (2);\r\n}\r\nreturn (0);\r\n}\r\nstatic void\r\narcofi_timer(struct IsdnCardState *cs) {\r\narcofi_fsm(cs, ARCOFI_TIMEOUT, NULL);\r\n}\r\nvoid\r\nclear_arcofi(struct IsdnCardState *cs) {\r\nif (test_and_clear_bit(FLG_ARCOFI_TIMER, &cs->HW_Flags)) {\r\ndel_timer(&cs->dc.isac.arcofitimer);\r\n}\r\n}\r\nvoid\r\ninit_arcofi(struct IsdnCardState *cs) {\r\nsetup_timer(&cs->dc.isac.arcofitimer, (void *)arcofi_timer, (long)cs);\r\ninit_waitqueue_head(&cs->dc.isac.arcofi_wait);\r\ntest_and_set_bit(HW_ARCOFI, &cs->HW_Flags);\r\n}

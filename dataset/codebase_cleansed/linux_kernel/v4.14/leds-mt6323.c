static int mt6323_led_hw_brightness(struct led_classdev *cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nstruct regmap *regmap = leds->hw->regmap;\r\nu32 con2_mask = 0, con2_val = 0;\r\nint ret;\r\ncon2_mask |= MT6323_ISINK_CH_STEP_MASK |\r\nMT6323_ISINK_SFSTR0_TC_MASK |\r\nMT6323_ISINK_SFSTR0_EN_MASK;\r\ncon2_val |= MT6323_ISINK_CH_STEP(brightness - 1) |\r\nMT6323_ISINK_SFSTR0_TC(2) |\r\nMT6323_ISINK_SFSTR0_EN;\r\nret = regmap_update_bits(regmap, MT6323_ISINK_CON2(led->id),\r\ncon2_mask, con2_val);\r\nreturn ret;\r\n}\r\nstatic int mt6323_led_hw_off(struct led_classdev *cdev)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nstruct regmap *regmap = leds->hw->regmap;\r\nunsigned int status;\r\nint ret;\r\nstatus = MT6323_ISINK_CH_EN(led->id);\r\nret = regmap_update_bits(regmap, MT6323_ISINK_EN_CTRL,\r\nMT6323_ISINK_CH_EN_MASK(led->id), ~status);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(100, 300);\r\nret = regmap_update_bits(regmap, MT6323_TOP_CKPDN2,\r\nMT6323_RG_ISINK_CK_PDN_MASK(led->id),\r\nMT6323_RG_ISINK_CK_PDN(led->id));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic enum led_brightness\r\nmt6323_get_led_hw_brightness(struct led_classdev *cdev)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nstruct regmap *regmap = leds->hw->regmap;\r\nunsigned int status;\r\nint ret;\r\nret = regmap_read(regmap, MT6323_TOP_CKPDN2, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nif (status & MT6323_RG_ISINK_CK_PDN_MASK(led->id))\r\nreturn 0;\r\nret = regmap_read(regmap, MT6323_ISINK_EN_CTRL, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!(status & MT6323_ISINK_CH_EN(led->id)))\r\nreturn 0;\r\nret = regmap_read(regmap, MT6323_ISINK_CON2(led->id), &status);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ((status & MT6323_ISINK_CH_STEP_MASK)\r\n>> MT6323_ISINK_CH_STEP_SHIFT) + 1;\r\n}\r\nstatic int mt6323_led_hw_on(struct led_classdev *cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nstruct regmap *regmap = leds->hw->regmap;\r\nunsigned int status;\r\nint ret;\r\nret = regmap_update_bits(regmap, MT6323_TOP_CKCON1,\r\nMT6323_RG_ISINK_CK_SEL_MASK(led->id), 0);\r\nif (ret < 0)\r\nreturn ret;\r\nstatus = MT6323_RG_ISINK_CK_PDN(led->id);\r\nret = regmap_update_bits(regmap, MT6323_TOP_CKPDN2,\r\nMT6323_RG_ISINK_CK_PDN_MASK(led->id),\r\n~status);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(100, 300);\r\nret = regmap_update_bits(regmap, MT6323_ISINK_EN_CTRL,\r\nMT6323_ISINK_CH_EN_MASK(led->id),\r\nMT6323_ISINK_CH_EN(led->id));\r\nif (ret < 0)\r\nreturn ret;\r\nret = mt6323_led_hw_brightness(cdev, brightness);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(regmap, MT6323_ISINK_CON0(led->id),\r\nMT6323_ISINK_DIM_DUTY_MASK,\r\nMT6323_ISINK_DIM_DUTY(31));\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(regmap, MT6323_ISINK_CON1(led->id),\r\nMT6323_ISINK_DIM_FSEL_MASK,\r\nMT6323_ISINK_DIM_FSEL(1000));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int mt6323_led_set_blink(struct led_classdev *cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nstruct regmap *regmap = leds->hw->regmap;\r\nunsigned long period;\r\nu8 duty_hw;\r\nint ret;\r\nperiod = *delay_on + *delay_off;\r\nif (period > MT6323_MAX_PERIOD)\r\nreturn -EINVAL;\r\nif (!*delay_on && !*delay_off) {\r\n*delay_on = 500;\r\n*delay_off = 500;\r\n}\r\nduty_hw = MT6323_CAL_HW_DUTY(*delay_on, period);\r\nif (!duty_hw)\r\nreturn -EINVAL;\r\nmutex_lock(&leds->lock);\r\nif (!led->current_brightness) {\r\nret = mt6323_led_hw_on(cdev, cdev->max_brightness);\r\nif (ret < 0)\r\ngoto out;\r\nled->current_brightness = cdev->max_brightness;\r\n}\r\nret = regmap_update_bits(regmap, MT6323_ISINK_CON0(led->id),\r\nMT6323_ISINK_DIM_DUTY_MASK,\r\nMT6323_ISINK_DIM_DUTY(duty_hw - 1));\r\nif (ret < 0)\r\ngoto out;\r\nret = regmap_update_bits(regmap, MT6323_ISINK_CON1(led->id),\r\nMT6323_ISINK_DIM_FSEL_MASK,\r\nMT6323_ISINK_DIM_FSEL(period - 1));\r\nout:\r\nmutex_unlock(&leds->lock);\r\nreturn ret;\r\n}\r\nstatic int mt6323_led_set_brightness(struct led_classdev *cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nstruct mt6323_leds *leds = led->parent;\r\nint ret;\r\nmutex_lock(&leds->lock);\r\nif (!led->current_brightness && brightness) {\r\nret = mt6323_led_hw_on(cdev, brightness);\r\nif (ret < 0)\r\ngoto out;\r\n} else if (brightness) {\r\nret = mt6323_led_hw_brightness(cdev, brightness);\r\nif (ret < 0)\r\ngoto out;\r\n} else {\r\nret = mt6323_led_hw_off(cdev);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nled->current_brightness = brightness;\r\nout:\r\nmutex_unlock(&leds->lock);\r\nreturn ret;\r\n}\r\nstatic int mt6323_led_set_dt_default(struct led_classdev *cdev,\r\nstruct device_node *np)\r\n{\r\nstruct mt6323_led *led = container_of(cdev, struct mt6323_led, cdev);\r\nconst char *state;\r\nint ret = 0;\r\nled->cdev.name = of_get_property(np, "label", NULL) ? : np->name;\r\nled->cdev.default_trigger = of_get_property(np,\r\n"linux,default-trigger",\r\nNULL);\r\nstate = of_get_property(np, "default-state", NULL);\r\nif (state) {\r\nif (!strcmp(state, "keep")) {\r\nret = mt6323_get_led_hw_brightness(cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nled->current_brightness = ret;\r\nret = 0;\r\n} else if (!strcmp(state, "on")) {\r\nret =\r\nmt6323_led_set_brightness(cdev, cdev->max_brightness);\r\n} else {\r\nret = mt6323_led_set_brightness(cdev, LED_OFF);\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int mt6323_led_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *child;\r\nstruct mt6397_chip *hw = dev_get_drvdata(pdev->dev.parent);\r\nstruct mt6323_leds *leds;\r\nstruct mt6323_led *led;\r\nint ret;\r\nunsigned int status;\r\nu32 reg;\r\nleds = devm_kzalloc(dev, sizeof(*leds), GFP_KERNEL);\r\nif (!leds)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, leds);\r\nleds->dev = dev;\r\nleds->hw = hw;\r\nmutex_init(&leds->lock);\r\nstatus = MT6323_RG_DRV_32K_CK_PDN;\r\nret = regmap_update_bits(leds->hw->regmap, MT6323_TOP_CKPDN0,\r\nMT6323_RG_DRV_32K_CK_PDN_MASK, ~status);\r\nif (ret < 0) {\r\ndev_err(leds->dev,\r\n"Failed to update MT6323_TOP_CKPDN0 Register\n");\r\nreturn ret;\r\n}\r\nfor_each_available_child_of_node(np, child) {\r\nret = of_property_read_u32(child, "reg", &reg);\r\nif (ret) {\r\ndev_err(dev, "Failed to read led 'reg' property\n");\r\ngoto put_child_node;\r\n}\r\nif (reg >= MT6323_MAX_LEDS || leds->led[reg]) {\r\ndev_err(dev, "Invalid led reg %u\n", reg);\r\nret = -EINVAL;\r\ngoto put_child_node;\r\n}\r\nled = devm_kzalloc(dev, sizeof(*led), GFP_KERNEL);\r\nif (!led) {\r\nret = -ENOMEM;\r\ngoto put_child_node;\r\n}\r\nleds->led[reg] = led;\r\nleds->led[reg]->id = reg;\r\nleds->led[reg]->cdev.max_brightness = MT6323_MAX_BRIGHTNESS;\r\nleds->led[reg]->cdev.brightness_set_blocking =\r\nmt6323_led_set_brightness;\r\nleds->led[reg]->cdev.blink_set = mt6323_led_set_blink;\r\nleds->led[reg]->cdev.brightness_get =\r\nmt6323_get_led_hw_brightness;\r\nleds->led[reg]->parent = leds;\r\nret = mt6323_led_set_dt_default(&leds->led[reg]->cdev, child);\r\nif (ret < 0) {\r\ndev_err(leds->dev,\r\n"Failed to LED set default from devicetree\n");\r\ngoto put_child_node;\r\n}\r\nret = devm_led_classdev_register(dev, &leds->led[reg]->cdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register LED: %d\n",\r\nret);\r\ngoto put_child_node;\r\n}\r\nleds->led[reg]->cdev.dev->of_node = child;\r\n}\r\nreturn 0;\r\nput_child_node:\r\nof_node_put(child);\r\nreturn ret;\r\n}\r\nstatic int mt6323_led_remove(struct platform_device *pdev)\r\n{\r\nstruct mt6323_leds *leds = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0 ; leds->led[i] ; i++)\r\nmt6323_led_hw_off(&leds->led[i]->cdev);\r\nregmap_update_bits(leds->hw->regmap, MT6323_TOP_CKPDN0,\r\nMT6323_RG_DRV_32K_CK_PDN_MASK,\r\nMT6323_RG_DRV_32K_CK_PDN);\r\nmutex_destroy(&leds->lock);\r\nreturn 0;\r\n}

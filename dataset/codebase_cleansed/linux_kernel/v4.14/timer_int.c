static enum hrtimer_restart oprofile_hrtimer_notify(struct hrtimer *hrtimer)\r\n{\r\noprofile_add_sample(get_irq_regs(), 0);\r\nhrtimer_forward_now(hrtimer, ns_to_ktime(TICK_NSEC));\r\nreturn HRTIMER_RESTART;\r\n}\r\nstatic void __oprofile_hrtimer_start(void *unused)\r\n{\r\nstruct hrtimer *hrtimer = this_cpu_ptr(&oprofile_hrtimer);\r\nif (!ctr_running)\r\nreturn;\r\nhrtimer_init(hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\nhrtimer->function = oprofile_hrtimer_notify;\r\nhrtimer_start(hrtimer, ns_to_ktime(TICK_NSEC),\r\nHRTIMER_MODE_REL_PINNED);\r\n}\r\nstatic int oprofile_hrtimer_start(void)\r\n{\r\nget_online_cpus();\r\nctr_running = 1;\r\non_each_cpu(__oprofile_hrtimer_start, NULL, 1);\r\nput_online_cpus();\r\nreturn 0;\r\n}\r\nstatic void __oprofile_hrtimer_stop(int cpu)\r\n{\r\nstruct hrtimer *hrtimer = &per_cpu(oprofile_hrtimer, cpu);\r\nif (!ctr_running)\r\nreturn;\r\nhrtimer_cancel(hrtimer);\r\n}\r\nstatic void oprofile_hrtimer_stop(void)\r\n{\r\nint cpu;\r\nget_online_cpus();\r\nfor_each_online_cpu(cpu)\r\n__oprofile_hrtimer_stop(cpu);\r\nctr_running = 0;\r\nput_online_cpus();\r\n}\r\nstatic int oprofile_timer_online(unsigned int cpu)\r\n{\r\nlocal_irq_disable();\r\n__oprofile_hrtimer_start(NULL);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int oprofile_timer_prep_down(unsigned int cpu)\r\n{\r\n__oprofile_hrtimer_stop(cpu);\r\nreturn 0;\r\n}\r\nstatic int oprofile_hrtimer_setup(void)\r\n{\r\nint ret;\r\nret = cpuhp_setup_state_nocalls(CPUHP_AP_ONLINE_DYN,\r\n"oprofile/timer:online",\r\noprofile_timer_online,\r\noprofile_timer_prep_down);\r\nif (ret < 0)\r\nreturn ret;\r\nhp_online = ret;\r\nreturn 0;\r\n}\r\nstatic void oprofile_hrtimer_shutdown(void)\r\n{\r\ncpuhp_remove_state_nocalls(hp_online);\r\n}\r\nint oprofile_timer_init(struct oprofile_operations *ops)\r\n{\r\nops->create_files = NULL;\r\nops->setup = oprofile_hrtimer_setup;\r\nops->shutdown = oprofile_hrtimer_shutdown;\r\nops->start = oprofile_hrtimer_start;\r\nops->stop = oprofile_hrtimer_stop;\r\nops->cpu_type = "timer";\r\nprintk(KERN_INFO "oprofile: using timer interrupt.\n");\r\nreturn 0;\r\n}

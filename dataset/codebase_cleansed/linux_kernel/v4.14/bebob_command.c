int avc_audio_set_selector(struct fw_unit *unit, unsigned int subunit_id,\r\nunsigned int fb_id, unsigned int num)\r\n{\r\nu8 *buf;\r\nint err;\r\nbuf = kzalloc(12, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nbuf[0] = 0x00;\r\nbuf[1] = 0x08 | (0x07 & subunit_id);\r\nbuf[2] = 0xb8;\r\nbuf[3] = 0x80;\r\nbuf[4] = 0xff & fb_id;\r\nbuf[5] = 0x10;\r\nbuf[6] = 0x02;\r\nbuf[7] = 0xff & num;\r\nbuf[8] = 0x01;\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, 12,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7) | BIT(8));\r\nif (err < 0)\r\n;\r\nelse if (err < 9)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse\r\nerr = 0;\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint avc_audio_get_selector(struct fw_unit *unit, unsigned int subunit_id,\r\nunsigned int fb_id, unsigned int *num)\r\n{\r\nu8 *buf;\r\nint err;\r\nbuf = kzalloc(12, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nbuf[0] = 0x01;\r\nbuf[1] = 0x08 | (0x07 & subunit_id);\r\nbuf[2] = 0xb8;\r\nbuf[3] = 0x80;\r\nbuf[4] = 0xff & fb_id;\r\nbuf[5] = 0x10;\r\nbuf[6] = 0x02;\r\nbuf[7] = 0xff;\r\nbuf[8] = 0x01;\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, 12,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(8));\r\nif (err < 0)\r\n;\r\nelse if (err < 9)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nif (err < 0)\r\ngoto end;\r\n*num = buf[7];\r\nerr = 0;\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nstatic inline void\r\navc_bridgeco_fill_extension_addr(u8 *buf, u8 *addr)\r\n{\r\nbuf[1] = addr[0];\r\nmemcpy(buf + 4, addr + 1, 5);\r\n}\r\nstatic inline void\r\navc_bridgeco_fill_plug_info_extension_command(u8 *buf, u8 *addr,\r\nunsigned int itype)\r\n{\r\nbuf[0] = 0x01;\r\nbuf[2] = 0x02;\r\nbuf[3] = 0xc0;\r\navc_bridgeco_fill_extension_addr(buf, addr);\r\nbuf[9] = itype;\r\n}\r\nint avc_bridgeco_get_plug_type(struct fw_unit *unit,\r\nu8 addr[AVC_BRIDGECO_ADDR_BYTES],\r\nenum avc_bridgeco_plug_type *type)\r\n{\r\nu8 *buf;\r\nint err;\r\nbuf = kzalloc(12, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\navc_bridgeco_fill_plug_info_extension_command(buf, addr, 0x00);\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, 12,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7) | BIT(9));\r\nif (err < 0)\r\n;\r\nelse if (err < 11)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nif (err < 0)\r\ngoto end;\r\n*type = buf[10];\r\nerr = 0;\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint avc_bridgeco_get_plug_ch_pos(struct fw_unit *unit,\r\nu8 addr[AVC_BRIDGECO_ADDR_BYTES],\r\nu8 *buf, unsigned int len)\r\n{\r\nint err;\r\navc_bridgeco_fill_plug_info_extension_command(buf, addr, 0x03);\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, 256,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) |\r\nBIT(5) | BIT(6) | BIT(7) | BIT(9));\r\nif (err < 0)\r\n;\r\nelse if (err < 11)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nif (err < 0)\r\ngoto end;\r\nmemmove(buf, buf + 10, err - 10);\r\nerr = 0;\r\nend:\r\nreturn err;\r\n}\r\nint avc_bridgeco_get_plug_section_type(struct fw_unit *unit,\r\nu8 addr[AVC_BRIDGECO_ADDR_BYTES],\r\nunsigned int id, u8 *type)\r\n{\r\nu8 *buf;\r\nint err;\r\nbuf = kzalloc(12, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\navc_bridgeco_fill_plug_info_extension_command(buf, addr, 0x07);\r\nbuf[10] = 0xff & ++id;\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, 12,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7) | BIT(9) | BIT(10));\r\nif (err < 0)\r\n;\r\nelse if (err < 12)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nif (err < 0)\r\ngoto end;\r\n*type = buf[11];\r\nerr = 0;\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint avc_bridgeco_get_plug_input(struct fw_unit *unit,\r\nu8 addr[AVC_BRIDGECO_ADDR_BYTES], u8 input[7])\r\n{\r\nint err;\r\nu8 *buf;\r\nbuf = kzalloc(18, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\navc_bridgeco_fill_plug_info_extension_command(buf, addr, 0x05);\r\nerr = fcp_avc_transaction(unit, buf, 16, buf, 16,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7));\r\nif (err < 0)\r\n;\r\nelse if (err < 16)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nif (err < 0)\r\ngoto end;\r\nmemcpy(input, buf + 10, 5);\r\nerr = 0;\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint avc_bridgeco_get_plug_strm_fmt(struct fw_unit *unit,\r\nu8 addr[AVC_BRIDGECO_ADDR_BYTES], u8 *buf,\r\nunsigned int *len, unsigned int eid)\r\n{\r\nint err;\r\nif ((buf == NULL) || (*len < 12)) {\r\nerr = -EINVAL;\r\ngoto end;\r\n}\r\nbuf[0] = 0x01;\r\nbuf[2] = 0x2f;\r\nbuf[3] = 0xc1;\r\navc_bridgeco_fill_extension_addr(buf, addr);\r\nbuf[10] = 0xff & eid;\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, *len,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7) | BIT(10));\r\nif (err < 0)\r\n;\r\nelse if (err < 12)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nelse if (buf[10] != eid)\r\nerr = -EIO;\r\nif (err < 0)\r\ngoto end;\r\nmemmove(buf, buf + 11, err - 11);\r\n*len = err - 11;\r\nerr = 0;\r\nend:\r\nreturn err;\r\n}

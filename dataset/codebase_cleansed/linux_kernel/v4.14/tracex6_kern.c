int bpf_prog1(struct pt_regs *ctx)\r\n{\r\nu32 key = bpf_get_smp_processor_id();\r\nu64 count, *val;\r\ns64 error;\r\ncount = bpf_perf_event_read(&counters, key);\r\nerror = (s64)count;\r\nif (error <= -2 && error >= -22)\r\nreturn 0;\r\nval = bpf_map_lookup_elem(&values, &key);\r\nif (val)\r\n*val = count;\r\nelse\r\nbpf_map_update_elem(&values, &key, &count, BPF_NOEXIST);\r\nreturn 0;\r\n}

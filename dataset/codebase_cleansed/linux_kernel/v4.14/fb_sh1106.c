static int init_display(struct fbtft_par *par)\r\n{\r\nif (!par->info->var.xres || par->info->var.xres > WIDTH ||\r\n!par->info->var.yres || par->info->var.yres > HEIGHT ||\r\npar->info->var.yres % 8) {\r\ndev_err(par->info->device, "Invalid screen size\n");\r\nreturn -EINVAL;\r\n}\r\nif (par->info->var.rotate) {\r\ndev_err(par->info->device, "Display rotation not supported\n");\r\nreturn -EINVAL;\r\n}\r\npar->fbtftops.reset(par);\r\nwrite_reg(par, 0xAE);\r\nwrite_reg(par, 0xD5, 0x80);\r\nwrite_reg(par, 0xA8, par->info->var.yres - 1);\r\nwrite_reg(par, 0xD3, 0x00);\r\nwrite_reg(par, 0x40 | 0x0);\r\nwrite_reg(par, 0xA0 | 0x1);\r\nwrite_reg(par, 0xC8);\r\nif (par->info->var.yres == 64)\r\nwrite_reg(par, 0xDA, 0x12);\r\nelse if (par->info->var.yres == 48)\r\nwrite_reg(par, 0xDA, 0x12);\r\nelse\r\nwrite_reg(par, 0xDA, 0x02);\r\nwrite_reg(par, 0xD9, 0xF1);\r\nwrite_reg(par, 0xDB, 0x40);\r\nwrite_reg(par, 0xAF);\r\nmsleep(150);\r\nreturn 0;\r\n}\r\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\r\n{\r\n}\r\nstatic int blank(struct fbtft_par *par, bool on)\r\n{\r\nfbtft_par_dbg(DEBUG_BLANK, par, "%s(blank=%s)\n",\r\n__func__, on ? "true" : "false");\r\nwrite_reg(par, on ? 0xAE : 0xAF);\r\nreturn 0;\r\n}\r\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\r\n{\r\ncurves[0] &= 0xFF;\r\nwrite_reg(par, 0x81, curves[0]);\r\nreturn 0;\r\n}\r\nstatic int write_vmem(struct fbtft_par *par, size_t offset, size_t len)\r\n{\r\nu16 *vmem16 = (u16 *)par->info->screen_buffer;\r\nu32 xres = par->info->var.xres;\r\nint page, page_start, page_end, x, i, ret;\r\nu8 *buf = par->txbuf.buf;\r\npage_start = offset / (8 * 2 * xres);\r\npage_end = DIV_ROUND_UP(offset + len, 8 * 2 * xres);\r\nfor (page = page_start; page < page_end; page++) {\r\nwrite_reg(par, 0xb0 | page, 0x00 | 2, 0x10 | 0);\r\nmemset(buf, 0, xres);\r\nfor (x = 0; x < xres; x++)\r\nfor (i = 0; i < 8; i++)\r\nif (vmem16[(page * 8 + i) * xres + x])\r\nbuf[x] |= BIT(i);\r\nret = fbtft_write_buf_dc(par, buf, xres, 1);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void write_register(struct fbtft_par *par, int len, ...)\r\n{\r\nva_list args;\r\nint i;\r\nva_start(args, len);\r\nfor (i = 0; i < len; i++)\r\npar->buf[i] = va_arg(args, unsigned int);\r\nfbtft_write_buf_dc(par, par->buf, len, 0);\r\nva_end(args);\r\n}

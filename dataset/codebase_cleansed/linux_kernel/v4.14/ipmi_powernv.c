static int ipmi_powernv_start_processing(void *send_info, ipmi_smi_t intf)\r\n{\r\nstruct ipmi_smi_powernv *smi = send_info;\r\nsmi->intf = intf;\r\nreturn 0;\r\n}\r\nstatic void send_error_reply(struct ipmi_smi_powernv *smi,\r\nstruct ipmi_smi_msg *msg, u8 completion_code)\r\n{\r\nmsg->rsp[0] = msg->data[0] | 0x4;\r\nmsg->rsp[1] = msg->data[1];\r\nmsg->rsp[2] = completion_code;\r\nmsg->rsp_size = 3;\r\nipmi_smi_msg_received(smi->intf, msg);\r\n}\r\nstatic void ipmi_powernv_send(void *send_info, struct ipmi_smi_msg *msg)\r\n{\r\nstruct ipmi_smi_powernv *smi = send_info;\r\nstruct opal_ipmi_msg *opal_msg;\r\nunsigned long flags;\r\nint comp, rc;\r\nsize_t size;\r\nif (msg->data_size > IPMI_MAX_MSG_LENGTH) {\r\ncomp = IPMI_REQ_LEN_EXCEEDED_ERR;\r\ngoto err;\r\n}\r\nif (msg->data_size < 2) {\r\ncomp = IPMI_REQ_LEN_INVALID_ERR;\r\ngoto err;\r\n}\r\nspin_lock_irqsave(&smi->msg_lock, flags);\r\nif (smi->cur_msg) {\r\ncomp = IPMI_NODE_BUSY_ERR;\r\ngoto err_unlock;\r\n}\r\nopal_msg = smi->opal_msg;\r\nopal_msg->version = OPAL_IPMI_MSG_FORMAT_VERSION_1;\r\nopal_msg->netfn = msg->data[0];\r\nopal_msg->cmd = msg->data[1];\r\nif (msg->data_size > 2)\r\nmemcpy(opal_msg->data, msg->data + 2, msg->data_size - 2);\r\nsize = sizeof(*opal_msg) + msg->data_size - 2;\r\npr_devel("%s: opal_ipmi_send(0x%llx, %p, %ld)\n", __func__,\r\nsmi->interface_id, opal_msg, size);\r\nrc = opal_ipmi_send(smi->interface_id, opal_msg, size);\r\npr_devel("%s: -> %d\n", __func__, rc);\r\nif (!rc) {\r\nsmi->cur_msg = msg;\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\nreturn;\r\n}\r\ncomp = IPMI_ERR_UNSPECIFIED;\r\nerr_unlock:\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\nerr:\r\nsend_error_reply(smi, msg, comp);\r\n}\r\nstatic int ipmi_powernv_recv(struct ipmi_smi_powernv *smi)\r\n{\r\nstruct opal_ipmi_msg *opal_msg;\r\nstruct ipmi_smi_msg *msg;\r\nunsigned long flags;\r\nuint64_t size;\r\nint rc;\r\npr_devel("%s: opal_ipmi_recv(%llx, msg, sz)\n", __func__,\r\nsmi->interface_id);\r\nspin_lock_irqsave(&smi->msg_lock, flags);\r\nif (!smi->cur_msg) {\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\npr_warn("no current message?\n");\r\nreturn 0;\r\n}\r\nmsg = smi->cur_msg;\r\nopal_msg = smi->opal_msg;\r\nsize = cpu_to_be64(sizeof(*opal_msg) + IPMI_MAX_MSG_LENGTH);\r\nrc = opal_ipmi_recv(smi->interface_id,\r\nopal_msg,\r\n&size);\r\nsize = be64_to_cpu(size);\r\npr_devel("%s: -> %d (size %lld)\n", __func__,\r\nrc, rc == 0 ? size : 0);\r\nif (rc) {\r\nif (rc == OPAL_EMPTY) {\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\nreturn 0;\r\n}\r\nsmi->cur_msg = NULL;\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\nsend_error_reply(smi, msg, IPMI_ERR_UNSPECIFIED);\r\nreturn 0;\r\n}\r\nif (size < sizeof(*opal_msg)) {\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\npr_warn("unexpected IPMI message size %lld\n", size);\r\nreturn 0;\r\n}\r\nif (opal_msg->version != OPAL_IPMI_MSG_FORMAT_VERSION_1) {\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\npr_warn("unexpected IPMI message format (version %d)\n",\r\nopal_msg->version);\r\nreturn 0;\r\n}\r\nmsg->rsp[0] = opal_msg->netfn;\r\nmsg->rsp[1] = opal_msg->cmd;\r\nif (size > sizeof(*opal_msg))\r\nmemcpy(&msg->rsp[2], opal_msg->data, size - sizeof(*opal_msg));\r\nmsg->rsp_size = 2 + size - sizeof(*opal_msg);\r\nsmi->cur_msg = NULL;\r\nspin_unlock_irqrestore(&smi->msg_lock, flags);\r\nipmi_smi_msg_received(smi->intf, msg);\r\nreturn 0;\r\n}\r\nstatic void ipmi_powernv_request_events(void *send_info)\r\n{\r\n}\r\nstatic void ipmi_powernv_set_run_to_completion(void *send_info,\r\nbool run_to_completion)\r\n{\r\n}\r\nstatic void ipmi_powernv_poll(void *send_info)\r\n{\r\nstruct ipmi_smi_powernv *smi = send_info;\r\nipmi_powernv_recv(smi);\r\n}\r\nstatic irqreturn_t ipmi_opal_event(int irq, void *data)\r\n{\r\nstruct ipmi_smi_powernv *smi = data;\r\nipmi_powernv_recv(smi);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ipmi_powernv_probe(struct platform_device *pdev)\r\n{\r\nstruct ipmi_smi_powernv *ipmi;\r\nstruct device *dev;\r\nu32 prop;\r\nint rc;\r\nif (!pdev || !pdev->dev.of_node)\r\nreturn -ENODEV;\r\ndev = &pdev->dev;\r\nipmi = devm_kzalloc(dev, sizeof(*ipmi), GFP_KERNEL);\r\nif (!ipmi)\r\nreturn -ENOMEM;\r\nspin_lock_init(&ipmi->msg_lock);\r\nrc = of_property_read_u32(dev->of_node, "ibm,ipmi-interface-id",\r\n&prop);\r\nif (rc) {\r\ndev_warn(dev, "No interface ID property\n");\r\ngoto err_free;\r\n}\r\nipmi->interface_id = prop;\r\nrc = of_property_read_u32(dev->of_node, "interrupts", &prop);\r\nif (rc) {\r\ndev_warn(dev, "No interrupts property\n");\r\ngoto err_free;\r\n}\r\nipmi->irq = irq_of_parse_and_map(dev->of_node, 0);\r\nif (!ipmi->irq) {\r\ndev_info(dev, "Unable to map irq from device tree\n");\r\nipmi->irq = opal_event_request(prop);\r\n}\r\nif (request_irq(ipmi->irq, ipmi_opal_event, IRQ_TYPE_LEVEL_HIGH,\r\n"opal-ipmi", ipmi)) {\r\ndev_warn(dev, "Unable to request irq\n");\r\ngoto err_dispose;\r\n}\r\nipmi->opal_msg = devm_kmalloc(dev,\r\nsizeof(*ipmi->opal_msg) + IPMI_MAX_MSG_LENGTH,\r\nGFP_KERNEL);\r\nif (!ipmi->opal_msg) {\r\nrc = -ENOMEM;\r\ngoto err_unregister;\r\n}\r\nrc = ipmi_register_smi(&ipmi_powernv_smi_handlers, ipmi,\r\n&ipmi->ipmi_id, dev, 0);\r\nif (rc) {\r\ndev_warn(dev, "IPMI SMI registration failed (%d)\n", rc);\r\ngoto err_free_msg;\r\n}\r\ndev_set_drvdata(dev, ipmi);\r\nreturn 0;\r\nerr_free_msg:\r\ndevm_kfree(dev, ipmi->opal_msg);\r\nerr_unregister:\r\nfree_irq(ipmi->irq, ipmi);\r\nerr_dispose:\r\nirq_dispose_mapping(ipmi->irq);\r\nerr_free:\r\ndevm_kfree(dev, ipmi);\r\nreturn rc;\r\n}\r\nstatic int ipmi_powernv_remove(struct platform_device *pdev)\r\n{\r\nstruct ipmi_smi_powernv *smi = dev_get_drvdata(&pdev->dev);\r\nipmi_unregister_smi(smi->intf);\r\nfree_irq(smi->irq, smi);\r\nirq_dispose_mapping(smi->irq);\r\nreturn 0;\r\n}

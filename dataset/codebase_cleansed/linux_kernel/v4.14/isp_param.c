void\r\nia_css_isp_param_set_mem_init(\r\nstruct ia_css_isp_param_host_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem,\r\nchar *address, size_t size)\r\n{\r\nmem_init->params[pclass][mem].address = address;\r\nmem_init->params[pclass][mem].size = (uint32_t)size;\r\n}\r\nvoid\r\nia_css_isp_param_set_css_mem_init(\r\nstruct ia_css_isp_param_css_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem,\r\nhrt_vaddress address, size_t size)\r\n{\r\nmem_init->params[pclass][mem].address = address;\r\nmem_init->params[pclass][mem].size = (uint32_t)size;\r\n}\r\nvoid\r\nia_css_isp_param_set_isp_mem_init(\r\nstruct ia_css_isp_param_isp_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem,\r\nuint32_t address, size_t size)\r\n{\r\nmem_init->params[pclass][mem].address = address;\r\nmem_init->params[pclass][mem].size = (uint32_t)size;\r\n}\r\nconst struct ia_css_host_data*\r\nia_css_isp_param_get_mem_init(\r\nconst struct ia_css_isp_param_host_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem)\r\n{\r\nreturn &mem_init->params[pclass][mem];\r\n}\r\nconst struct ia_css_data*\r\nia_css_isp_param_get_css_mem_init(\r\nconst struct ia_css_isp_param_css_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem)\r\n{\r\nreturn &mem_init->params[pclass][mem];\r\n}\r\nconst struct ia_css_isp_data*\r\nia_css_isp_param_get_isp_mem_init(\r\nconst struct ia_css_isp_param_isp_segments *mem_init,\r\nenum ia_css_param_class pclass,\r\nenum ia_css_isp_memories mem)\r\n{\r\nreturn &mem_init->params[pclass][mem];\r\n}\r\nvoid\r\nia_css_init_memory_interface(\r\nstruct ia_css_isp_param_css_segments *isp_mem_if,\r\nconst struct ia_css_isp_param_host_segments *mem_params,\r\nconst struct ia_css_isp_param_css_segments *css_params)\r\n{\r\nunsigned pclass, mem;\r\nfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\r\nmemset(isp_mem_if->params[pclass], 0, sizeof(isp_mem_if->params[pclass]));\r\nfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\r\nif (!mem_params->params[pclass][mem].address)\r\ncontinue;\r\nisp_mem_if->params[pclass][mem].size = mem_params->params[pclass][mem].size;\r\nif (pclass != IA_CSS_PARAM_CLASS_PARAM)\r\nisp_mem_if->params[pclass][mem].address = css_params->params[pclass][mem].address;\r\n}\r\n}\r\n}\r\nenum ia_css_err\r\nia_css_isp_param_allocate_isp_parameters(\r\nstruct ia_css_isp_param_host_segments *mem_params,\r\nstruct ia_css_isp_param_css_segments *css_params,\r\nconst struct ia_css_isp_param_isp_segments *mem_initializers)\r\n{\r\nenum ia_css_err err = IA_CSS_SUCCESS;\r\nunsigned mem, pclass;\r\npclass = IA_CSS_PARAM_CLASS_PARAM;\r\nfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\r\nfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\r\nuint32_t size = 0;\r\nif (mem_initializers)\r\nsize = mem_initializers->params[pclass][mem].size;\r\nmem_params->params[pclass][mem].size = size;\r\nmem_params->params[pclass][mem].address = NULL;\r\ncss_params->params[pclass][mem].size = size;\r\ncss_params->params[pclass][mem].address = 0x0;\r\nif (size) {\r\nmem_params->params[pclass][mem].address = sh_css_calloc(1, size);\r\nif (!mem_params->params[pclass][mem].address) {\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngoto cleanup;\r\n}\r\nif (pclass != IA_CSS_PARAM_CLASS_PARAM) {\r\ncss_params->params[pclass][mem].address = mmgr_malloc(size);\r\nif (!css_params->params[pclass][mem].address) {\r\nerr = IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\ngoto cleanup;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nreturn err;\r\ncleanup:\r\nia_css_isp_param_destroy_isp_parameters(mem_params, css_params);\r\nreturn err;\r\n}\r\nvoid\r\nia_css_isp_param_destroy_isp_parameters(\r\nstruct ia_css_isp_param_host_segments *mem_params,\r\nstruct ia_css_isp_param_css_segments *css_params)\r\n{\r\nunsigned mem, pclass;\r\nfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\r\nfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\r\nif (mem_params->params[pclass][mem].address)\r\nsh_css_free(mem_params->params[pclass][mem].address);\r\nif (css_params->params[pclass][mem].address)\r\nhmm_free(css_params->params[pclass][mem].address);\r\nmem_params->params[pclass][mem].address = NULL;\r\ncss_params->params[pclass][mem].address = 0x0;\r\n}\r\n}\r\n}\r\nvoid\r\nia_css_isp_param_load_fw_params(\r\nconst char *fw,\r\nunion ia_css_all_memory_offsets *mem_offsets,\r\nconst struct ia_css_isp_param_memory_offsets *memory_offsets,\r\nbool init)\r\n{\r\nunsigned pclass;\r\nfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\r\nmem_offsets->array[pclass].ptr = NULL;\r\nif (init)\r\nmem_offsets->array[pclass].ptr = (void *)(fw + memory_offsets->offsets[pclass]);\r\n}\r\n}\r\nenum ia_css_err\r\nia_css_isp_param_copy_isp_mem_if_to_ddr(\r\nstruct ia_css_isp_param_css_segments *ddr,\r\nconst struct ia_css_isp_param_host_segments *host,\r\nenum ia_css_param_class pclass)\r\n{\r\nunsigned mem;\r\nfor (mem = 0; mem < N_IA_CSS_ISP_MEMORIES; mem++) {\r\nsize_t size = host->params[pclass][mem].size;\r\nhrt_vaddress ddr_mem_ptr = ddr->params[pclass][mem].address;\r\nchar *host_mem_ptr = host->params[pclass][mem].address;\r\nif (size != ddr->params[pclass][mem].size)\r\nreturn IA_CSS_ERR_INTERNAL_ERROR;\r\nif (!size)\r\ncontinue;\r\nmmgr_store(ddr_mem_ptr, host_mem_ptr, size);\r\n}\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nvoid\r\nia_css_isp_param_enable_pipeline(\r\nconst struct ia_css_isp_param_host_segments *mem_params)\r\n{\r\nshort dmem_offset = 0;\r\nif (mem_params->params[IA_CSS_PARAM_CLASS_PARAM][IA_CSS_ISP_DMEM0].size == 0)\r\nreturn;\r\n*(uint32_t *)&mem_params->params[IA_CSS_PARAM_CLASS_PARAM][IA_CSS_ISP_DMEM0].address[dmem_offset] = 0x0;\r\n}

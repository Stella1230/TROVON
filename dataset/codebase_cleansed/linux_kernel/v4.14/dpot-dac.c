static int dpot_dac_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct dpot_dac *dac = iio_priv(indio_dev);\r\nint ret;\r\nunsigned long long tmp;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nreturn iio_read_channel_raw(dac->dpot, val);\r\ncase IIO_CHAN_INFO_SCALE:\r\nret = iio_read_channel_scale(dac->dpot, val, val2);\r\nswitch (ret) {\r\ncase IIO_VAL_FRACTIONAL_LOG2:\r\ntmp = *val * 1000000000LL;\r\ndo_div(tmp, dac->max_ohms);\r\ntmp *= regulator_get_voltage(dac->vref) / 1000;\r\ndo_div(tmp, 1000000000LL);\r\n*val = tmp;\r\nreturn ret;\r\ncase IIO_VAL_INT:\r\n*val2 = 1;\r\nret = IIO_VAL_FRACTIONAL;\r\ncase IIO_VAL_FRACTIONAL:\r\n*val *= regulator_get_voltage(dac->vref) / 1000;\r\n*val2 *= dac->max_ohms;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int dpot_dac_read_avail(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nconst int **vals, int *type, int *length,\r\nlong mask)\r\n{\r\nstruct dpot_dac *dac = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\n*type = IIO_VAL_INT;\r\nreturn iio_read_avail_channel_raw(dac->dpot, vals, length);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int dpot_dac_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val, int val2, long mask)\r\n{\r\nstruct dpot_dac *dac = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nreturn iio_write_channel_raw(dac->dpot, val);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int dpot_dac_channel_max_ohms(struct iio_dev *indio_dev)\r\n{\r\nstruct device *dev = &indio_dev->dev;\r\nstruct dpot_dac *dac = iio_priv(indio_dev);\r\nunsigned long long tmp;\r\nint ret;\r\nint val;\r\nint val2;\r\nint max;\r\nret = iio_read_max_channel_raw(dac->dpot, &max);\r\nif (ret < 0) {\r\ndev_err(dev, "dpot does not indicate its raw maximum value\n");\r\nreturn ret;\r\n}\r\nswitch (iio_read_channel_scale(dac->dpot, &val, &val2)) {\r\ncase IIO_VAL_INT:\r\nreturn max * val;\r\ncase IIO_VAL_FRACTIONAL:\r\ntmp = (unsigned long long)max * val;\r\ndo_div(tmp, val2);\r\nreturn tmp;\r\ncase IIO_VAL_FRACTIONAL_LOG2:\r\ntmp = val * 1000000000LL * max >> val2;\r\ndo_div(tmp, 1000000000LL);\r\nreturn tmp;\r\ndefault:\r\ndev_err(dev, "dpot has a scale that is too weird\n");\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int dpot_dac_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct iio_dev *indio_dev;\r\nstruct dpot_dac *dac;\r\nenum iio_chan_type type;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(*dac));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, indio_dev);\r\ndac = iio_priv(indio_dev);\r\nindio_dev->name = dev_name(dev);\r\nindio_dev->dev.parent = dev;\r\nindio_dev->info = &dpot_dac_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = &dpot_dac_iio_channel;\r\nindio_dev->num_channels = 1;\r\ndac->vref = devm_regulator_get(dev, "vref");\r\nif (IS_ERR(dac->vref)) {\r\nif (PTR_ERR(dac->vref) != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "failed to get vref regulator\n");\r\nreturn PTR_ERR(dac->vref);\r\n}\r\ndac->dpot = devm_iio_channel_get(dev, "dpot");\r\nif (IS_ERR(dac->dpot)) {\r\nif (PTR_ERR(dac->dpot) != -EPROBE_DEFER)\r\ndev_err(dev, "failed to get dpot input channel\n");\r\nreturn PTR_ERR(dac->dpot);\r\n}\r\nret = iio_get_channel_type(dac->dpot, &type);\r\nif (ret < 0)\r\nreturn ret;\r\nif (type != IIO_RESISTANCE) {\r\ndev_err(dev, "dpot is of the wrong type\n");\r\nreturn -EINVAL;\r\n}\r\nret = dpot_dac_channel_max_ohms(indio_dev);\r\nif (ret < 0)\r\nreturn ret;\r\ndac->max_ohms = ret;\r\nret = regulator_enable(dac->vref);\r\nif (ret) {\r\ndev_err(dev, "failed to enable the vref regulator\n");\r\nreturn ret;\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret) {\r\ndev_err(dev, "failed to register iio device\n");\r\ngoto disable_reg;\r\n}\r\nreturn 0;\r\ndisable_reg:\r\nregulator_disable(dac->vref);\r\nreturn ret;\r\n}\r\nstatic int dpot_dac_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct dpot_dac *dac = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nregulator_disable(dac->vref);\r\nreturn 0;\r\n}

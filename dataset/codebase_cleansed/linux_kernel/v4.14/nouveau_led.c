static enum led_brightness\r\nnouveau_led_get_brightness(struct led_classdev *led)\r\n{\r\nstruct drm_device *drm_dev = container_of(led, struct nouveau_led, led)->dev;\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvif_object *device = &drm->client.device.object;\r\nu32 div, duty;\r\ndiv = nvif_rd32(device, 0x61c880) & 0x00ffffff;\r\nduty = nvif_rd32(device, 0x61c884) & 0x00ffffff;\r\nif (div > 0)\r\nreturn duty * LED_FULL / div;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void\r\nnouveau_led_set_brightness(struct led_classdev *led, enum led_brightness value)\r\n{\r\nstruct drm_device *drm_dev = container_of(led, struct nouveau_led, led)->dev;\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nvif_object *device = &drm->client.device.object;\r\nu32 input_clk = 27e6;\r\nu32 freq = 100;\r\nu32 div, duty;\r\ndiv = input_clk / freq;\r\nduty = value * div / LED_FULL;\r\nnvif_wr32(device, 0x61c880, div);\r\nnvif_wr32(device, 0x61c884, 0xc0000000 | duty);\r\n}\r\nint\r\nnouveau_led_init(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvkm_gpio *gpio = nvxx_gpio(&drm->client.device);\r\nstruct dcb_gpio_func logo_led;\r\nint ret;\r\nif (!gpio)\r\nreturn 0;\r\nif (nvkm_gpio_find(gpio, 0, DCB_GPIO_LOGO_LED_PWM, 0xff, &logo_led))\r\nreturn 0;\r\ndrm->led = kzalloc(sizeof(*drm->led), GFP_KERNEL);\r\nif (!drm->led)\r\nreturn -ENOMEM;\r\ndrm->led->dev = dev;\r\ndrm->led->led.name = "nvidia-logo";\r\ndrm->led->led.max_brightness = 255;\r\ndrm->led->led.brightness_get = nouveau_led_get_brightness;\r\ndrm->led->led.brightness_set = nouveau_led_set_brightness;\r\nret = led_classdev_register(dev->dev, &drm->led->led);\r\nif (ret) {\r\nkfree(drm->led);\r\ndrm->led = NULL;\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nnouveau_led_suspend(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nif (drm->led)\r\nled_classdev_suspend(&drm->led->led);\r\n}\r\nvoid\r\nnouveau_led_resume(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nif (drm->led)\r\nled_classdev_resume(&drm->led->led);\r\n}\r\nvoid\r\nnouveau_led_fini(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nif (drm->led) {\r\nled_classdev_unregister(&drm->led->led);\r\nkfree(drm->led);\r\ndrm->led = NULL;\r\n}\r\n}

static int i2c_mux_select(struct i2c_mux_core *muxc, u32 chan)\r\n{\r\nstruct mux *mux = i2c_mux_priv(muxc);\r\nint ret;\r\nret = mux_control_select(mux->control, chan);\r\nmux->do_not_deselect = ret < 0;\r\nreturn ret;\r\n}\r\nstatic int i2c_mux_deselect(struct i2c_mux_core *muxc, u32 chan)\r\n{\r\nstruct mux *mux = i2c_mux_priv(muxc);\r\nif (mux->do_not_deselect)\r\nreturn 0;\r\nreturn mux_control_deselect(mux->control);\r\n}\r\nstatic struct i2c_adapter *mux_parent_adapter(struct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *parent_np;\r\nstruct i2c_adapter *parent;\r\nparent_np = of_parse_phandle(np, "i2c-parent", 0);\r\nif (!parent_np) {\r\ndev_err(dev, "Cannot parse i2c-parent\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nparent = of_find_i2c_adapter_by_node(parent_np);\r\nof_node_put(parent_np);\r\nif (!parent)\r\nreturn ERR_PTR(-EPROBE_DEFER);\r\nreturn parent;\r\n}\r\nstatic int i2c_mux_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *child;\r\nstruct i2c_mux_core *muxc;\r\nstruct mux *mux;\r\nstruct i2c_adapter *parent;\r\nint children;\r\nint ret;\r\nif (!np)\r\nreturn -ENODEV;\r\nmux = devm_kzalloc(dev, sizeof(*mux), GFP_KERNEL);\r\nif (!mux)\r\nreturn -ENOMEM;\r\nmux->control = devm_mux_control_get(dev, NULL);\r\nif (IS_ERR(mux->control)) {\r\nif (PTR_ERR(mux->control) != -EPROBE_DEFER)\r\ndev_err(dev, "failed to get control-mux\n");\r\nreturn PTR_ERR(mux->control);\r\n}\r\nparent = mux_parent_adapter(dev);\r\nif (IS_ERR(parent)) {\r\nif (PTR_ERR(parent) != -EPROBE_DEFER)\r\ndev_err(dev, "failed to get i2c-parent adapter\n");\r\nreturn PTR_ERR(parent);\r\n}\r\nchildren = of_get_child_count(np);\r\nmuxc = i2c_mux_alloc(parent, dev, children, 0, 0,\r\ni2c_mux_select, i2c_mux_deselect);\r\nif (!muxc) {\r\nret = -ENOMEM;\r\ngoto err_parent;\r\n}\r\nmuxc->priv = mux;\r\nplatform_set_drvdata(pdev, muxc);\r\nmuxc->mux_locked = of_property_read_bool(np, "mux-locked");\r\nfor_each_child_of_node(np, child) {\r\nu32 chan;\r\nret = of_property_read_u32(child, "reg", &chan);\r\nif (ret < 0) {\r\ndev_err(dev, "no reg property for node '%s'\n",\r\nchild->name);\r\ngoto err_children;\r\n}\r\nif (chan >= mux_control_states(mux->control)) {\r\ndev_err(dev, "invalid reg %u\n", chan);\r\nret = -EINVAL;\r\ngoto err_children;\r\n}\r\nret = i2c_mux_add_adapter(muxc, 0, chan, 0);\r\nif (ret)\r\ngoto err_children;\r\n}\r\ndev_info(dev, "%d-port mux on %s adapter\n", children, parent->name);\r\nreturn 0;\r\nerr_children:\r\ni2c_mux_del_adapters(muxc);\r\nerr_parent:\r\ni2c_put_adapter(parent);\r\nreturn ret;\r\n}\r\nstatic int i2c_mux_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_mux_core *muxc = platform_get_drvdata(pdev);\r\ni2c_mux_del_adapters(muxc);\r\ni2c_put_adapter(muxc->parent);\r\nreturn 0;\r\n}

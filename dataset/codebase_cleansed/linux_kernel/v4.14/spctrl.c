enum ia_css_err ia_css_spctrl_load_fw(sp_ID_t sp_id,\r\nia_css_spctrl_cfg *spctrl_cfg)\r\n{\r\nhrt_vaddress code_addr = mmgr_NULL;\r\nstruct ia_css_sp_init_dmem_cfg *init_dmem_cfg;\r\nif ((sp_id >= N_SP_ID) || (spctrl_cfg == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nspctrl_cofig_info[sp_id].code_addr = mmgr_NULL;\r\ninit_dmem_cfg = &spctrl_cofig_info[sp_id].dmem_config;\r\ninit_dmem_cfg->dmem_data_addr = spctrl_cfg->dmem_data_addr;\r\ninit_dmem_cfg->dmem_bss_addr = spctrl_cfg->dmem_bss_addr;\r\ninit_dmem_cfg->data_size = spctrl_cfg->data_size;\r\ninit_dmem_cfg->bss_size = spctrl_cfg->bss_size;\r\ninit_dmem_cfg->sp_id = sp_id;\r\nspctrl_cofig_info[sp_id].spctrl_config_dmem_addr = spctrl_cfg->spctrl_config_dmem_addr;\r\nspctrl_cofig_info[sp_id].spctrl_state_dmem_addr = spctrl_cfg->spctrl_state_dmem_addr;\r\ncode_addr = mmgr_malloc(spctrl_cfg->code_size);\r\nif (code_addr == mmgr_NULL)\r\nreturn IA_CSS_ERR_CANNOT_ALLOCATE_MEMORY;\r\nmmgr_store(code_addr, spctrl_cfg->code, spctrl_cfg->code_size);\r\nif (sizeof(hrt_vaddress) > sizeof(hrt_data)) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_ERROR,\r\n"size of hrt_vaddress can not be greater than hrt_data\n");\r\nhmm_free(code_addr);\r\ncode_addr = mmgr_NULL;\r\nreturn IA_CSS_ERR_INTERNAL_ERROR;\r\n}\r\ninit_dmem_cfg->ddr_data_addr = code_addr + spctrl_cfg->ddr_data_offset;\r\nif ((init_dmem_cfg->ddr_data_addr % HIVE_ISP_DDR_WORD_BYTES) != 0) {\r\nia_css_debug_dtrace(IA_CSS_DEBUG_ERROR,\r\n"DDR address pointer is not properly aligned for DMA transfer\n");\r\nhmm_free(code_addr);\r\ncode_addr = mmgr_NULL;\r\nreturn IA_CSS_ERR_INTERNAL_ERROR;\r\n}\r\nspctrl_cofig_info[sp_id].sp_entry = spctrl_cfg->sp_entry;\r\nspctrl_cofig_info[sp_id].code_addr = code_addr;\r\nspctrl_cofig_info[sp_id].program_name = spctrl_cfg->program_name;\r\nsp_ctrl_store(sp_id, SP_ICACHE_ADDR_REG, (hrt_data)spctrl_cofig_info[sp_id].code_addr);\r\nsp_ctrl_setbit(sp_id, SP_ICACHE_INV_REG, SP_ICACHE_INV_BIT);\r\nspctrl_loaded[sp_id] = true;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nvoid sh_css_spctrl_reload_fw(sp_ID_t sp_id)\r\n{\r\nsp_ctrl_store(sp_id, SP_ICACHE_ADDR_REG, (hrt_data)spctrl_cofig_info[sp_id].code_addr);\r\nsp_ctrl_setbit(sp_id, SP_ICACHE_INV_REG, SP_ICACHE_INV_BIT);\r\nspctrl_loaded[sp_id] = true;\r\n}\r\nhrt_vaddress get_sp_code_addr(sp_ID_t sp_id)\r\n{\r\nreturn spctrl_cofig_info[sp_id].code_addr;\r\n}\r\nenum ia_css_err ia_css_spctrl_unload_fw(sp_ID_t sp_id)\r\n{\r\nif ((sp_id >= N_SP_ID) || ((sp_id < N_SP_ID) && (!spctrl_loaded[sp_id])))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nif (spctrl_cofig_info[sp_id].code_addr)\r\nhmm_free(spctrl_cofig_info[sp_id].code_addr);\r\nspctrl_loaded[sp_id] = false;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nenum ia_css_err ia_css_spctrl_start(sp_ID_t sp_id)\r\n{\r\nif ((sp_id >= N_SP_ID) || ((sp_id < N_SP_ID) && (!spctrl_loaded[sp_id])))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nassert(sizeof(unsigned int) <= sizeof(hrt_data));\r\nsp_dmem_store(sp_id,\r\nspctrl_cofig_info[sp_id].spctrl_config_dmem_addr,\r\n&spctrl_cofig_info[sp_id].dmem_config,\r\nsizeof(spctrl_cofig_info[sp_id].dmem_config));\r\nsp_ctrl_store(sp_id, SP_START_ADDR_REG, (hrt_data)spctrl_cofig_info[sp_id].sp_entry);\r\nsp_ctrl_setbit(sp_id, SP_SC_REG, SP_RUN_BIT);\r\nsp_ctrl_setbit(sp_id, SP_SC_REG, SP_START_BIT);\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nia_css_spctrl_sp_sw_state ia_css_spctrl_get_state(sp_ID_t sp_id)\r\n{\r\nia_css_spctrl_sp_sw_state state = 0;\r\nunsigned int HIVE_ADDR_sp_sw_state;\r\nif (sp_id >= N_SP_ID)\r\nreturn IA_CSS_SP_SW_TERMINATED;\r\nHIVE_ADDR_sp_sw_state = spctrl_cofig_info[sp_id].spctrl_state_dmem_addr;\r\n(void)HIVE_ADDR_sp_sw_state;\r\nif (sp_id == SP0_ID)\r\nstate = sp_dmem_load_uint32(sp_id, (unsigned)sp_address_of(sp_sw_state));\r\nreturn state;\r\n}\r\nint ia_css_spctrl_is_idle(sp_ID_t sp_id)\r\n{\r\nint state = 0;\r\nassert (sp_id < N_SP_ID);\r\nstate = sp_ctrl_getbit(sp_id, SP_SC_REG, SP_IDLE_BIT);\r\nreturn state;\r\n}

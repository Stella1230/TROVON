int sport_set_multichannel(struct sport_device *sport,\r\nint tdm_count, u32 tx_mask, u32 rx_mask, int packed)\r\n{\r\npr_debug("%s tdm_count=%d tx_mask:0x%08x rx_mask:0x%08x packed=%d\n",\r\n__func__, tdm_count, tx_mask, rx_mask, packed);\r\nif ((sport->regs->tcr1 & TSPEN) || (sport->regs->rcr1 & RSPEN))\r\nreturn -EBUSY;\r\nif (tdm_count & 0x7)\r\nreturn -EINVAL;\r\nif (tdm_count > 32)\r\nreturn -EINVAL;\r\nif (tdm_count) {\r\nsport->regs->mcmc1 = ((tdm_count>>3)-1) << 12;\r\nsport->regs->mcmc2 = FRAME_DELAY | MCMEN | \\r\n(packed ? (MCDTXPE|MCDRXPE) : 0);\r\nsport->regs->mtcs0 = tx_mask;\r\nsport->regs->mrcs0 = rx_mask;\r\nsport->regs->mtcs1 = 0;\r\nsport->regs->mrcs1 = 0;\r\nsport->regs->mtcs2 = 0;\r\nsport->regs->mrcs2 = 0;\r\nsport->regs->mtcs3 = 0;\r\nsport->regs->mrcs3 = 0;\r\n} else {\r\nsport->regs->mcmc1 = 0;\r\nsport->regs->mcmc2 = 0;\r\nsport->regs->mtcs0 = 0;\r\nsport->regs->mrcs0 = 0;\r\n}\r\nsport->regs->mtcs1 = 0; sport->regs->mtcs2 = 0; sport->regs->mtcs3 = 0;\r\nsport->regs->mrcs1 = 0; sport->regs->mrcs2 = 0; sport->regs->mrcs3 = 0;\r\nSSYNC();\r\nreturn 0;\r\n}\r\nint sport_config_rx(struct sport_device *sport, unsigned int rcr1,\r\nunsigned int rcr2, unsigned int clkdiv, unsigned int fsdiv)\r\n{\r\nif ((sport->regs->tcr1 & TSPEN) || (sport->regs->rcr1 & RSPEN))\r\nreturn -EBUSY;\r\nsport->regs->rcr1 = rcr1;\r\nsport->regs->rcr2 = rcr2;\r\nsport->regs->rclkdiv = clkdiv;\r\nsport->regs->rfsdiv = fsdiv;\r\nSSYNC();\r\nreturn 0;\r\n}\r\nint sport_config_tx(struct sport_device *sport, unsigned int tcr1,\r\nunsigned int tcr2, unsigned int clkdiv, unsigned int fsdiv)\r\n{\r\nif ((sport->regs->tcr1 & TSPEN) || (sport->regs->rcr1 & RSPEN))\r\nreturn -EBUSY;\r\nsport->regs->tcr1 = tcr1;\r\nsport->regs->tcr2 = tcr2;\r\nsport->regs->tclkdiv = clkdiv;\r\nsport->regs->tfsdiv = fsdiv;\r\nSSYNC();\r\nreturn 0;\r\n}\r\nstatic void setup_desc(struct dmasg *desc, void *buf, int fragcount,\r\nsize_t fragsize, unsigned int cfg,\r\nunsigned int x_count, unsigned int ycount, size_t wdsize)\r\n{\r\nint i;\r\nfor (i = 0; i < fragcount; ++i) {\r\ndesc[i].next_desc_addr = &(desc[i + 1]);\r\ndesc[i].start_addr = (unsigned long)buf + i*fragsize;\r\ndesc[i].cfg = cfg;\r\ndesc[i].x_count = x_count;\r\ndesc[i].x_modify = wdsize;\r\ndesc[i].y_count = ycount;\r\ndesc[i].y_modify = wdsize;\r\n}\r\ndesc[fragcount-1].next_desc_addr = desc;\r\npr_debug("setup desc: desc0=%p, next0=%p, desc1=%p,"\r\n"next1=%p\nx_count=%x,y_count=%x,addr=0x%lx,cfs=0x%x\n",\r\ndesc, desc[0].next_desc_addr,\r\ndesc+1, desc[1].next_desc_addr,\r\ndesc[0].x_count, desc[0].y_count,\r\ndesc[0].start_addr, desc[0].cfg);\r\n}\r\nstatic int sport_start(struct sport_device *sport)\r\n{\r\nenable_dma(sport->dma_rx_chan);\r\nenable_dma(sport->dma_tx_chan);\r\nsport->regs->rcr1 |= RSPEN;\r\nsport->regs->tcr1 |= TSPEN;\r\nSSYNC();\r\nreturn 0;\r\n}\r\nstatic int sport_stop(struct sport_device *sport)\r\n{\r\nsport->regs->tcr1 &= ~TSPEN;\r\nsport->regs->rcr1 &= ~RSPEN;\r\nSSYNC();\r\ndisable_dma(sport->dma_rx_chan);\r\ndisable_dma(sport->dma_tx_chan);\r\nreturn 0;\r\n}\r\nstatic inline int sport_hook_rx_dummy(struct sport_device *sport)\r\n{\r\nstruct dmasg *desc, temp_desc;\r\nunsigned long flags;\r\nif (WARN_ON(!sport->dummy_rx_desc) ||\r\nWARN_ON(sport->curr_rx_desc == sport->dummy_rx_desc))\r\nreturn -EINVAL;\r\nsport->dummy_rx_desc->next_desc_addr = sport->dummy_rx_desc + 1;\r\nlocal_irq_save(flags);\r\ndesc = get_dma_next_desc_ptr(sport->dma_rx_chan);\r\ntemp_desc = *desc;\r\ndesc->x_count = sport->dummy_count / 2;\r\ndesc->y_count = 0;\r\ndesc->next_desc_addr = sport->dummy_rx_desc;\r\nlocal_irq_restore(flags);\r\nwhile ((get_dma_curr_desc_ptr(sport->dma_rx_chan) -\r\nsizeof(struct dmasg)) != sport->dummy_rx_desc)\r\ncontinue;\r\nsport->curr_rx_desc = sport->dummy_rx_desc;\r\n*desc = temp_desc;\r\nreturn 0;\r\n}\r\nstatic inline int sport_rx_dma_start(struct sport_device *sport, int dummy)\r\n{\r\nif (dummy) {\r\nsport->dummy_rx_desc->next_desc_addr = sport->dummy_rx_desc;\r\nsport->curr_rx_desc = sport->dummy_rx_desc;\r\n} else\r\nsport->curr_rx_desc = sport->dma_rx_desc;\r\nset_dma_next_desc_addr(sport->dma_rx_chan, sport->curr_rx_desc);\r\nset_dma_x_count(sport->dma_rx_chan, 0);\r\nset_dma_x_modify(sport->dma_rx_chan, 0);\r\nset_dma_config(sport->dma_rx_chan, (DMAFLOW_LARGE | NDSIZE_9 | \\r\nWDSIZE_32 | WNR));\r\nset_dma_curr_addr(sport->dma_rx_chan, sport->curr_rx_desc->start_addr);\r\nSSYNC();\r\nreturn 0;\r\n}\r\nstatic inline int sport_tx_dma_start(struct sport_device *sport, int dummy)\r\n{\r\nif (dummy) {\r\nsport->dummy_tx_desc->next_desc_addr = sport->dummy_tx_desc;\r\nsport->curr_tx_desc = sport->dummy_tx_desc;\r\n} else\r\nsport->curr_tx_desc = sport->dma_tx_desc;\r\nset_dma_next_desc_addr(sport->dma_tx_chan, sport->curr_tx_desc);\r\nset_dma_x_count(sport->dma_tx_chan, 0);\r\nset_dma_x_modify(sport->dma_tx_chan, 0);\r\nset_dma_config(sport->dma_tx_chan,\r\n(DMAFLOW_LARGE | NDSIZE_9 | WDSIZE_32));\r\nset_dma_curr_addr(sport->dma_tx_chan, sport->curr_tx_desc->start_addr);\r\nSSYNC();\r\nreturn 0;\r\n}\r\nint sport_rx_start(struct sport_device *sport)\r\n{\r\nunsigned long flags;\r\npr_debug("%s enter\n", __func__);\r\nif (sport->rx_run)\r\nreturn -EBUSY;\r\nif (sport->tx_run) {\r\nif (WARN_ON(!sport->dma_rx_desc) ||\r\nWARN_ON(sport->curr_rx_desc != sport->dummy_rx_desc))\r\nreturn -EINVAL;\r\nlocal_irq_save(flags);\r\nwhile ((get_dma_curr_desc_ptr(sport->dma_rx_chan) -\r\nsizeof(struct dmasg)) != sport->dummy_rx_desc)\r\ncontinue;\r\nsport->dummy_rx_desc->next_desc_addr = sport->dma_rx_desc;\r\nlocal_irq_restore(flags);\r\nsport->curr_rx_desc = sport->dma_rx_desc;\r\n} else {\r\nsport_tx_dma_start(sport, 1);\r\nsport_rx_dma_start(sport, 0);\r\nsport_start(sport);\r\n}\r\nsport->rx_run = 1;\r\nreturn 0;\r\n}\r\nint sport_rx_stop(struct sport_device *sport)\r\n{\r\npr_debug("%s enter\n", __func__);\r\nif (!sport->rx_run)\r\nreturn 0;\r\nif (sport->tx_run) {\r\nsport_hook_rx_dummy(sport);\r\n} else {\r\nsport_stop(sport);\r\nsport->curr_rx_desc = NULL;\r\nsport->curr_tx_desc = NULL;\r\n}\r\nsport->rx_run = 0;\r\nreturn 0;\r\n}\r\nstatic inline int sport_hook_tx_dummy(struct sport_device *sport)\r\n{\r\nstruct dmasg *desc, temp_desc;\r\nunsigned long flags;\r\nif (WARN_ON(!sport->dummy_tx_desc) ||\r\nWARN_ON(sport->curr_tx_desc == sport->dummy_tx_desc))\r\nreturn -EINVAL;\r\nsport->dummy_tx_desc->next_desc_addr = sport->dummy_tx_desc + 1;\r\nlocal_irq_save(flags);\r\ndesc = get_dma_next_desc_ptr(sport->dma_tx_chan);\r\ntemp_desc = *desc;\r\ndesc->x_count = sport->dummy_count / 2;\r\ndesc->y_count = 0;\r\ndesc->next_desc_addr = sport->dummy_tx_desc;\r\nlocal_irq_restore(flags);\r\nwhile ((get_dma_curr_desc_ptr(sport->dma_tx_chan) - \\r\nsizeof(struct dmasg)) != sport->dummy_tx_desc)\r\ncontinue;\r\nsport->curr_tx_desc = sport->dummy_tx_desc;\r\n*desc = temp_desc;\r\nreturn 0;\r\n}\r\nint sport_tx_start(struct sport_device *sport)\r\n{\r\nunsigned long flags;\r\npr_debug("%s: tx_run:%d, rx_run:%d\n", __func__,\r\nsport->tx_run, sport->rx_run);\r\nif (sport->tx_run)\r\nreturn -EBUSY;\r\nif (sport->rx_run) {\r\nif (WARN_ON(!sport->dma_tx_desc) ||\r\nWARN_ON(sport->curr_tx_desc != sport->dummy_tx_desc))\r\nreturn -EINVAL;\r\nlocal_irq_save(flags);\r\nwhile ((get_dma_curr_desc_ptr(sport->dma_tx_chan) -\r\nsizeof(struct dmasg)) != sport->dummy_tx_desc)\r\ncontinue;\r\nsport->dummy_tx_desc->next_desc_addr = sport->dma_tx_desc;\r\nlocal_irq_restore(flags);\r\nsport->curr_tx_desc = sport->dma_tx_desc;\r\n} else {\r\nsport_tx_dma_start(sport, 0);\r\nsport_rx_dma_start(sport, 1);\r\nsport_start(sport);\r\n}\r\nsport->tx_run = 1;\r\nreturn 0;\r\n}\r\nint sport_tx_stop(struct sport_device *sport)\r\n{\r\nif (!sport->tx_run)\r\nreturn 0;\r\nif (sport->rx_run) {\r\nsport_hook_tx_dummy(sport);\r\n} else {\r\nsport_stop(sport);\r\nsport->curr_rx_desc = NULL;\r\nsport->curr_tx_desc = NULL;\r\n}\r\nsport->tx_run = 0;\r\nreturn 0;\r\n}\r\nstatic inline int compute_wdsize(size_t wdsize)\r\n{\r\nswitch (wdsize) {\r\ncase 1:\r\nreturn WDSIZE_8;\r\ncase 2:\r\nreturn WDSIZE_16;\r\ncase 4:\r\ndefault:\r\nreturn WDSIZE_32;\r\n}\r\n}\r\nint sport_config_rx_dma(struct sport_device *sport, void *buf,\r\nint fragcount, size_t fragsize)\r\n{\r\nunsigned int x_count;\r\nunsigned int y_count;\r\nunsigned int cfg;\r\ndma_addr_t addr;\r\npr_debug("%s buf:%p, frag:%d, fragsize:0x%lx\n", __func__, \\r\nbuf, fragcount, fragsize);\r\nx_count = fragsize / sport->wdsize;\r\ny_count = 0;\r\nif (x_count >= 0x10000) {\r\nint i, count = x_count;\r\nfor (i = 16; i > 0; i--) {\r\nx_count = 1 << i;\r\nif ((count & (x_count - 1)) == 0) {\r\ny_count = count >> i;\r\nif (y_count < 0x10000)\r\nbreak;\r\n}\r\n}\r\nif (i == 0)\r\nreturn -EINVAL;\r\n}\r\npr_debug("%s(x_count:0x%x, y_count:0x%x)\n", __func__,\r\nx_count, y_count);\r\nif (sport->dma_rx_desc)\r\ndma_free_coherent(NULL, sport->rx_desc_bytes,\r\nsport->dma_rx_desc, 0);\r\nsport->dma_rx_desc = dma_alloc_coherent(NULL, \\r\nfragcount * sizeof(struct dmasg), &addr, 0);\r\nsport->rx_desc_bytes = fragcount * sizeof(struct dmasg);\r\nif (!sport->dma_rx_desc) {\r\npr_err("Failed to allocate memory for rx desc\n");\r\nreturn -ENOMEM;\r\n}\r\nsport->rx_buf = buf;\r\nsport->rx_fragsize = fragsize;\r\nsport->rx_frags = fragcount;\r\ncfg = 0x7000 | DI_EN | compute_wdsize(sport->wdsize) | WNR | \\r\n(DESC_ELEMENT_COUNT << 8);\r\nif (y_count != 0)\r\ncfg |= DMA2D;\r\nsetup_desc(sport->dma_rx_desc, buf, fragcount, fragsize,\r\ncfg|DMAEN, x_count, y_count, sport->wdsize);\r\nreturn 0;\r\n}\r\nint sport_config_tx_dma(struct sport_device *sport, void *buf, \\r\nint fragcount, size_t fragsize)\r\n{\r\nunsigned int x_count;\r\nunsigned int y_count;\r\nunsigned int cfg;\r\ndma_addr_t addr;\r\npr_debug("%s buf:%p, fragcount:%d, fragsize:0x%lx\n",\r\n__func__, buf, fragcount, fragsize);\r\nx_count = fragsize/sport->wdsize;\r\ny_count = 0;\r\nif (x_count >= 0x10000) {\r\nint i, count = x_count;\r\nfor (i = 16; i > 0; i--) {\r\nx_count = 1 << i;\r\nif ((count & (x_count - 1)) == 0) {\r\ny_count = count >> i;\r\nif (y_count < 0x10000)\r\nbreak;\r\n}\r\n}\r\nif (i == 0)\r\nreturn -EINVAL;\r\n}\r\npr_debug("%s x_count:0x%x, y_count:0x%x\n", __func__,\r\nx_count, y_count);\r\nif (sport->dma_tx_desc) {\r\ndma_free_coherent(NULL, sport->tx_desc_bytes, \\r\nsport->dma_tx_desc, 0);\r\n}\r\nsport->dma_tx_desc = dma_alloc_coherent(NULL, \\r\nfragcount * sizeof(struct dmasg), &addr, 0);\r\nsport->tx_desc_bytes = fragcount * sizeof(struct dmasg);\r\nif (!sport->dma_tx_desc) {\r\npr_err("Failed to allocate memory for tx desc\n");\r\nreturn -ENOMEM;\r\n}\r\nsport->tx_buf = buf;\r\nsport->tx_fragsize = fragsize;\r\nsport->tx_frags = fragcount;\r\ncfg = 0x7000 | DI_EN | compute_wdsize(sport->wdsize) | \\r\n(DESC_ELEMENT_COUNT << 8);\r\nif (y_count != 0)\r\ncfg |= DMA2D;\r\nsetup_desc(sport->dma_tx_desc, buf, fragcount, fragsize,\r\ncfg|DMAEN, x_count, y_count, sport->wdsize);\r\nreturn 0;\r\n}\r\nstatic int sport_config_rx_dummy(struct sport_device *sport)\r\n{\r\nstruct dmasg *desc;\r\nunsigned config;\r\npr_debug("%s entered\n", __func__);\r\nif (L1_DATA_A_LENGTH)\r\ndesc = l1_data_sram_zalloc(2 * sizeof(*desc));\r\nelse {\r\ndma_addr_t addr;\r\ndesc = dma_alloc_coherent(NULL, 2 * sizeof(*desc), &addr, 0);\r\nmemset(desc, 0, 2 * sizeof(*desc));\r\n}\r\nif (desc == NULL) {\r\npr_err("Failed to allocate memory for dummy rx desc\n");\r\nreturn -ENOMEM;\r\n}\r\nsport->dummy_rx_desc = desc;\r\ndesc->start_addr = (unsigned long)sport->dummy_buf;\r\nconfig = DMAFLOW_LARGE | NDSIZE_9 | compute_wdsize(sport->wdsize)\r\n| WNR | DMAEN;\r\ndesc->cfg = config;\r\ndesc->x_count = sport->dummy_count/sport->wdsize;\r\ndesc->x_modify = sport->wdsize;\r\ndesc->y_count = 0;\r\ndesc->y_modify = 0;\r\nmemcpy(desc+1, desc, sizeof(*desc));\r\ndesc->next_desc_addr = desc + 1;\r\ndesc[1].next_desc_addr = desc;\r\nreturn 0;\r\n}\r\nstatic int sport_config_tx_dummy(struct sport_device *sport)\r\n{\r\nstruct dmasg *desc;\r\nunsigned int config;\r\npr_debug("%s entered\n", __func__);\r\nif (L1_DATA_A_LENGTH)\r\ndesc = l1_data_sram_zalloc(2 * sizeof(*desc));\r\nelse {\r\ndma_addr_t addr;\r\ndesc = dma_alloc_coherent(NULL, 2 * sizeof(*desc), &addr, 0);\r\nmemset(desc, 0, 2 * sizeof(*desc));\r\n}\r\nif (!desc) {\r\npr_err("Failed to allocate memory for dummy tx desc\n");\r\nreturn -ENOMEM;\r\n}\r\nsport->dummy_tx_desc = desc;\r\ndesc->start_addr = (unsigned long)sport->dummy_buf + \\r\nsport->dummy_count;\r\nconfig = DMAFLOW_LARGE | NDSIZE_9 |\r\ncompute_wdsize(sport->wdsize) | DMAEN;\r\ndesc->cfg = config;\r\ndesc->x_count = sport->dummy_count/sport->wdsize;\r\ndesc->x_modify = sport->wdsize;\r\ndesc->y_count = 0;\r\ndesc->y_modify = 0;\r\nmemcpy(desc+1, desc, sizeof(*desc));\r\ndesc->next_desc_addr = desc + 1;\r\ndesc[1].next_desc_addr = desc;\r\nreturn 0;\r\n}\r\nunsigned long sport_curr_offset_rx(struct sport_device *sport)\r\n{\r\nunsigned long curr = get_dma_curr_addr(sport->dma_rx_chan);\r\nreturn (unsigned char *)curr - sport->rx_buf;\r\n}\r\nunsigned long sport_curr_offset_tx(struct sport_device *sport)\r\n{\r\nunsigned long curr = get_dma_curr_addr(sport->dma_tx_chan);\r\nreturn (unsigned char *)curr - sport->tx_buf;\r\n}\r\nvoid sport_incfrag(struct sport_device *sport, int *frag, int tx)\r\n{\r\n++(*frag);\r\nif (tx == 1 && *frag == sport->tx_frags)\r\n*frag = 0;\r\nif (tx == 0 && *frag == sport->rx_frags)\r\n*frag = 0;\r\n}\r\nvoid sport_decfrag(struct sport_device *sport, int *frag, int tx)\r\n{\r\n--(*frag);\r\nif (tx == 1 && *frag == 0)\r\n*frag = sport->tx_frags;\r\nif (tx == 0 && *frag == 0)\r\n*frag = sport->rx_frags;\r\n}\r\nstatic int sport_check_status(struct sport_device *sport,\r\nunsigned int *sport_stat,\r\nunsigned int *rx_stat,\r\nunsigned int *tx_stat)\r\n{\r\nint status = 0;\r\nif (sport_stat) {\r\nSSYNC();\r\nstatus = sport->regs->stat;\r\nif (status & (TOVF|TUVF|ROVF|RUVF))\r\nsport->regs->stat = (status & (TOVF|TUVF|ROVF|RUVF));\r\nSSYNC();\r\n*sport_stat = status;\r\n}\r\nif (rx_stat) {\r\nSSYNC();\r\nstatus = get_dma_curr_irqstat(sport->dma_rx_chan);\r\nif (status & (DMA_DONE|DMA_ERR))\r\nclear_dma_irqstat(sport->dma_rx_chan);\r\nSSYNC();\r\n*rx_stat = status;\r\n}\r\nif (tx_stat) {\r\nSSYNC();\r\nstatus = get_dma_curr_irqstat(sport->dma_tx_chan);\r\nif (status & (DMA_DONE|DMA_ERR))\r\nclear_dma_irqstat(sport->dma_tx_chan);\r\nSSYNC();\r\n*tx_stat = status;\r\n}\r\nreturn 0;\r\n}\r\nint sport_dump_stat(struct sport_device *sport, char *buf, size_t len)\r\n{\r\nint ret;\r\nret = snprintf(buf, len,\r\n"sts: 0x%04x\n"\r\n"rx dma %d sts: 0x%04x tx dma %d sts: 0x%04x\n",\r\nsport->regs->stat,\r\nsport->dma_rx_chan,\r\nget_dma_curr_irqstat(sport->dma_rx_chan),\r\nsport->dma_tx_chan,\r\nget_dma_curr_irqstat(sport->dma_tx_chan));\r\nbuf += ret;\r\nlen -= ret;\r\nret += snprintf(buf, len,\r\n"curr_rx_desc:0x%p, curr_tx_desc:0x%p\n"\r\n"dma_rx_desc:0x%p, dma_tx_desc:0x%p\n"\r\n"dummy_rx_desc:0x%p, dummy_tx_desc:0x%p\n",\r\nsport->curr_rx_desc, sport->curr_tx_desc,\r\nsport->dma_rx_desc, sport->dma_tx_desc,\r\nsport->dummy_rx_desc, sport->dummy_tx_desc);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t rx_handler(int irq, void *dev_id)\r\n{\r\nunsigned int rx_stat;\r\nstruct sport_device *sport = dev_id;\r\npr_debug("%s enter\n", __func__);\r\nsport_check_status(sport, NULL, &rx_stat, NULL);\r\nif (!(rx_stat & DMA_DONE))\r\npr_err("rx dma is already stopped\n");\r\nif (sport->rx_callback) {\r\nsport->rx_callback(sport->rx_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic irqreturn_t tx_handler(int irq, void *dev_id)\r\n{\r\nunsigned int tx_stat;\r\nstruct sport_device *sport = dev_id;\r\npr_debug("%s enter\n", __func__);\r\nsport_check_status(sport, NULL, NULL, &tx_stat);\r\nif (!(tx_stat & DMA_DONE)) {\r\npr_err("tx dma is already stopped\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nif (sport->tx_callback) {\r\nsport->tx_callback(sport->tx_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic irqreturn_t err_handler(int irq, void *dev_id)\r\n{\r\nunsigned int status = 0;\r\nstruct sport_device *sport = dev_id;\r\npr_debug("%s\n", __func__);\r\nif (sport_check_status(sport, &status, NULL, NULL)) {\r\npr_err("error checking status ??");\r\nreturn IRQ_NONE;\r\n}\r\nif (status & (TOVF|TUVF|ROVF|RUVF)) {\r\npr_info("sport status error:%s%s%s%s\n",\r\nstatus & TOVF ? " TOVF" : "",\r\nstatus & TUVF ? " TUVF" : "",\r\nstatus & ROVF ? " ROVF" : "",\r\nstatus & RUVF ? " RUVF" : "");\r\nif (status & TOVF || status & TUVF) {\r\ndisable_dma(sport->dma_tx_chan);\r\nif (sport->tx_run)\r\nsport_tx_dma_start(sport, 0);\r\nelse\r\nsport_tx_dma_start(sport, 1);\r\nenable_dma(sport->dma_tx_chan);\r\n} else {\r\ndisable_dma(sport->dma_rx_chan);\r\nif (sport->rx_run)\r\nsport_rx_dma_start(sport, 0);\r\nelse\r\nsport_rx_dma_start(sport, 1);\r\nenable_dma(sport->dma_rx_chan);\r\n}\r\n}\r\nstatus = sport->regs->stat;\r\nif (status & (TOVF|TUVF|ROVF|RUVF))\r\nsport->regs->stat = (status & (TOVF|TUVF|ROVF|RUVF));\r\nSSYNC();\r\nif (sport->err_callback)\r\nsport->err_callback(sport->err_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nint sport_set_rx_callback(struct sport_device *sport,\r\nvoid (*rx_callback)(void *), void *rx_data)\r\n{\r\nif (WARN_ON(!rx_callback))\r\nreturn -EINVAL;\r\nsport->rx_callback = rx_callback;\r\nsport->rx_data = rx_data;\r\nreturn 0;\r\n}\r\nint sport_set_tx_callback(struct sport_device *sport,\r\nvoid (*tx_callback)(void *), void *tx_data)\r\n{\r\nif (WARN_ON(!tx_callback))\r\nreturn -EINVAL;\r\nsport->tx_callback = tx_callback;\r\nsport->tx_data = tx_data;\r\nreturn 0;\r\n}\r\nint sport_set_err_callback(struct sport_device *sport,\r\nvoid (*err_callback)(void *), void *err_data)\r\n{\r\nif (WARN_ON(!err_callback))\r\nreturn -EINVAL;\r\nsport->err_callback = err_callback;\r\nsport->err_data = err_data;\r\nreturn 0;\r\n}\r\nstatic int sport_config_pdev(struct platform_device *pdev, struct sport_param *param)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct bfin_snd_platform_data *pdata = dev->platform_data;\r\nstruct resource *res;\r\nparam->num = pdev->id;\r\nif (!pdata) {\r\ndev_err(dev, "no platform_data\n");\r\nreturn -ENODEV;\r\n}\r\nparam->pin_req = pdata->pin_req;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "no MEM resource\n");\r\nreturn -ENODEV;\r\n}\r\nparam->regs = (struct sport_register *)res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!res) {\r\ndev_err(dev, "no rx DMA resource\n");\r\nreturn -ENODEV;\r\n}\r\nparam->dma_rx_chan = res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!res) {\r\ndev_err(dev, "no tx DMA resource\n");\r\nreturn -ENODEV;\r\n}\r\nparam->dma_tx_chan = res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\ndev_err(dev, "no irq resource\n");\r\nreturn -ENODEV;\r\n}\r\nparam->err_irq = res->start;\r\nreturn 0;\r\n}\r\nstruct sport_device *sport_init(struct platform_device *pdev,\r\nunsigned int wdsize, unsigned int dummy_count, size_t priv_size)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct sport_param param;\r\nstruct sport_device *sport;\r\nint ret;\r\ndev_dbg(dev, "%s enter\n", __func__);\r\nparam.wdsize = wdsize;\r\nparam.dummy_count = dummy_count;\r\nif (WARN_ON(param.wdsize == 0 || param.dummy_count == 0))\r\nreturn NULL;\r\nret = sport_config_pdev(pdev, &param);\r\nif (ret)\r\nreturn NULL;\r\nif (peripheral_request_list(param.pin_req, "soc-audio")) {\r\ndev_err(dev, "requesting Peripherals failed\n");\r\nreturn NULL;\r\n}\r\nsport = kzalloc(sizeof(*sport), GFP_KERNEL);\r\nif (!sport) {\r\ndev_err(dev, "failed to allocate for sport device\n");\r\ngoto __init_err0;\r\n}\r\nsport->num = param.num;\r\nsport->dma_rx_chan = param.dma_rx_chan;\r\nsport->dma_tx_chan = param.dma_tx_chan;\r\nsport->err_irq = param.err_irq;\r\nsport->regs = param.regs;\r\nsport->pin_req = param.pin_req;\r\nif (request_dma(sport->dma_rx_chan, "SPORT RX Data") == -EBUSY) {\r\ndev_err(dev, "failed to request RX dma %d\n", sport->dma_rx_chan);\r\ngoto __init_err1;\r\n}\r\nif (set_dma_callback(sport->dma_rx_chan, rx_handler, sport) != 0) {\r\ndev_err(dev, "failed to request RX irq %d\n", sport->dma_rx_chan);\r\ngoto __init_err2;\r\n}\r\nif (request_dma(sport->dma_tx_chan, "SPORT TX Data") == -EBUSY) {\r\ndev_err(dev, "failed to request TX dma %d\n", sport->dma_tx_chan);\r\ngoto __init_err2;\r\n}\r\nif (set_dma_callback(sport->dma_tx_chan, tx_handler, sport) != 0) {\r\ndev_err(dev, "failed to request TX irq %d\n", sport->dma_tx_chan);\r\ngoto __init_err3;\r\n}\r\nif (request_irq(sport->err_irq, err_handler, IRQF_SHARED, "SPORT err",\r\nsport) < 0) {\r\ndev_err(dev, "failed to request err irq %d\n", sport->err_irq);\r\ngoto __init_err3;\r\n}\r\ndev_info(dev, "dma rx:%d tx:%d, err irq:%d, regs:%p\n",\r\nsport->dma_rx_chan, sport->dma_tx_chan,\r\nsport->err_irq, sport->regs);\r\nsport->wdsize = param.wdsize;\r\nsport->dummy_count = param.dummy_count;\r\nsport->private_data = kzalloc(priv_size, GFP_KERNEL);\r\nif (!sport->private_data) {\r\ndev_err(dev, "could not alloc priv data %zu bytes\n", priv_size);\r\ngoto __init_err4;\r\n}\r\nif (L1_DATA_A_LENGTH)\r\nsport->dummy_buf = l1_data_sram_zalloc(param.dummy_count * 2);\r\nelse\r\nsport->dummy_buf = kzalloc(param.dummy_count * 2, GFP_KERNEL);\r\nif (sport->dummy_buf == NULL) {\r\ndev_err(dev, "failed to allocate dummy buffer\n");\r\ngoto __error1;\r\n}\r\nret = sport_config_rx_dummy(sport);\r\nif (ret) {\r\ndev_err(dev, "failed to config rx dummy ring\n");\r\ngoto __error2;\r\n}\r\nret = sport_config_tx_dummy(sport);\r\nif (ret) {\r\ndev_err(dev, "failed to config tx dummy ring\n");\r\ngoto __error3;\r\n}\r\nplatform_set_drvdata(pdev, sport);\r\nreturn sport;\r\n__error3:\r\nif (L1_DATA_A_LENGTH)\r\nl1_data_sram_free(sport->dummy_rx_desc);\r\nelse\r\ndma_free_coherent(NULL, 2*sizeof(struct dmasg),\r\nsport->dummy_rx_desc, 0);\r\n__error2:\r\nif (L1_DATA_A_LENGTH)\r\nl1_data_sram_free(sport->dummy_buf);\r\nelse\r\nkfree(sport->dummy_buf);\r\n__error1:\r\nkfree(sport->private_data);\r\n__init_err4:\r\nfree_irq(sport->err_irq, sport);\r\n__init_err3:\r\nfree_dma(sport->dma_tx_chan);\r\n__init_err2:\r\nfree_dma(sport->dma_rx_chan);\r\n__init_err1:\r\nkfree(sport);\r\n__init_err0:\r\nperipheral_free_list(param.pin_req);\r\nreturn NULL;\r\n}\r\nvoid sport_done(struct sport_device *sport)\r\n{\r\nif (sport == NULL)\r\nreturn;\r\nsport_stop(sport);\r\nif (sport->dma_rx_desc)\r\ndma_free_coherent(NULL, sport->rx_desc_bytes,\r\nsport->dma_rx_desc, 0);\r\nif (sport->dma_tx_desc)\r\ndma_free_coherent(NULL, sport->tx_desc_bytes,\r\nsport->dma_tx_desc, 0);\r\n#if L1_DATA_A_LENGTH != 0\r\nl1_data_sram_free(sport->dummy_rx_desc);\r\nl1_data_sram_free(sport->dummy_tx_desc);\r\nl1_data_sram_free(sport->dummy_buf);\r\n#else\r\ndma_free_coherent(NULL, 2*sizeof(struct dmasg),\r\nsport->dummy_rx_desc, 0);\r\ndma_free_coherent(NULL, 2*sizeof(struct dmasg),\r\nsport->dummy_tx_desc, 0);\r\nkfree(sport->dummy_buf);\r\n#endif\r\nfree_dma(sport->dma_rx_chan);\r\nfree_dma(sport->dma_tx_chan);\r\nfree_irq(sport->err_irq, sport);\r\nkfree(sport->private_data);\r\nperipheral_free_list(sport->pin_req);\r\nkfree(sport);\r\n}\r\nint sport_send_and_recv(struct sport_device *sport, u8 *out_data, \\r\nu8 *in_data, int len)\r\n{\r\nunsigned short dma_config;\r\nunsigned short status;\r\nunsigned long flags;\r\nunsigned long wait = 0;\r\npr_debug("%s enter, out_data:%p, in_data:%p len:%d\n", \\r\n__func__, out_data, in_data, len);\r\npr_debug("tcr1:0x%04x, tcr2:0x%04x, tclkdiv:0x%04x, tfsdiv:0x%04x\n"\r\n"mcmc1:0x%04x, mcmc2:0x%04x\n",\r\nsport->regs->tcr1, sport->regs->tcr2,\r\nsport->regs->tclkdiv, sport->regs->tfsdiv,\r\nsport->regs->mcmc1, sport->regs->mcmc2);\r\nflush_dcache_range((unsigned)out_data, (unsigned)(out_data + len));\r\ndma_config = (RESTART | WDSIZE_16 | DI_EN);\r\nset_dma_start_addr(sport->dma_tx_chan, (unsigned long)out_data);\r\nset_dma_x_count(sport->dma_tx_chan, len/2);\r\nset_dma_x_modify(sport->dma_tx_chan, 2);\r\nset_dma_config(sport->dma_tx_chan, dma_config);\r\nenable_dma(sport->dma_tx_chan);\r\nif (in_data != NULL) {\r\ninvalidate_dcache_range((unsigned)in_data, \\r\n(unsigned)(in_data + len));\r\ndma_config = (RESTART | WDSIZE_16 | WNR | DI_EN);\r\nset_dma_start_addr(sport->dma_rx_chan, (unsigned long)in_data);\r\nset_dma_x_count(sport->dma_rx_chan, len/2);\r\nset_dma_x_modify(sport->dma_rx_chan, 2);\r\nset_dma_config(sport->dma_rx_chan, dma_config);\r\nenable_dma(sport->dma_rx_chan);\r\n}\r\nlocal_irq_save(flags);\r\nsport->regs->tcr1 |= TSPEN;\r\nsport->regs->rcr1 |= RSPEN;\r\nSSYNC();\r\nstatus = get_dma_curr_irqstat(sport->dma_tx_chan);\r\nwhile (status & DMA_RUN) {\r\nudelay(1);\r\nstatus = get_dma_curr_irqstat(sport->dma_tx_chan);\r\npr_debug("DMA status:0x%04x\n", status);\r\nif (wait++ > 100)\r\ngoto __over;\r\n}\r\nstatus = sport->regs->stat;\r\nwait = 0;\r\nwhile (!(status & TXHRE)) {\r\npr_debug("sport status:0x%04x\n", status);\r\nudelay(1);\r\nstatus = *(unsigned short *)&sport->regs->stat;\r\nif (wait++ > 1000)\r\ngoto __over;\r\n}\r\nudelay(20);\r\npr_debug("sport status:0x%04x\n", status);\r\n__over:\r\nsport->regs->tcr1 &= ~TSPEN;\r\nsport->regs->rcr1 &= ~RSPEN;\r\nSSYNC();\r\ndisable_dma(sport->dma_tx_chan);\r\nclear_dma_irqstat(sport->dma_tx_chan);\r\nif (in_data != NULL) {\r\ndisable_dma(sport->dma_rx_chan);\r\nclear_dma_irqstat(sport->dma_rx_chan);\r\n}\r\nSSYNC();\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}

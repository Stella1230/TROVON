static int nci_hci_result_to_errno(u8 result)\r\n{\r\nswitch (result) {\r\ncase NCI_HCI_ANY_OK:\r\nreturn 0;\r\ncase NCI_HCI_ANY_E_REG_PAR_UNKNOWN:\r\nreturn -EOPNOTSUPP;\r\ncase NCI_HCI_ANY_E_TIMEOUT:\r\nreturn -ETIME;\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\nstatic void nci_hci_reset_pipes(struct nci_hci_dev *hdev)\r\n{\r\nint i;\r\nfor (i = 0; i < NCI_HCI_MAX_PIPES; i++) {\r\nhdev->pipes[i].gate = NCI_HCI_INVALID_GATE;\r\nhdev->pipes[i].host = NCI_HCI_INVALID_HOST;\r\n}\r\nmemset(hdev->gate2pipe, NCI_HCI_INVALID_PIPE, sizeof(hdev->gate2pipe));\r\n}\r\nstatic void nci_hci_reset_pipes_per_host(struct nci_dev *ndev, u8 host)\r\n{\r\nint i;\r\nfor (i = 0; i < NCI_HCI_MAX_PIPES; i++) {\r\nif (ndev->hci_dev->pipes[i].host == host) {\r\nndev->hci_dev->pipes[i].gate = NCI_HCI_INVALID_GATE;\r\nndev->hci_dev->pipes[i].host = NCI_HCI_INVALID_HOST;\r\n}\r\n}\r\n}\r\nstatic int nci_hci_send_data(struct nci_dev *ndev, u8 pipe,\r\nconst u8 data_type, const u8 *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_conn_info *conn_info;\r\nstruct sk_buff *skb;\r\nint len, i, r;\r\nu8 cb = pipe;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\ni = 0;\r\nskb = nci_skb_alloc(ndev, conn_info->max_pkt_payload_len +\r\nNCI_DATA_HDR_SIZE, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_reserve(skb, NCI_DATA_HDR_SIZE + 2);\r\n*(u8 *)skb_push(skb, 1) = data_type;\r\ndo {\r\nlen = conn_info->max_pkt_payload_len;\r\nif (i + conn_info->max_pkt_payload_len -\r\n(skb->len + 1) >= data_len) {\r\ncb |= NCI_HFP_NO_CHAINING;\r\nlen = data_len - i;\r\n} else {\r\nlen = conn_info->max_pkt_payload_len - skb->len - 1;\r\n}\r\n*(u8 *)skb_push(skb, 1) = cb;\r\nif (len > 0)\r\nskb_put_data(skb, data + i, len);\r\nr = nci_send_data(ndev, conn_info->conn_id, skb);\r\nif (r < 0)\r\nreturn r;\r\ni += len;\r\nif (i < data_len) {\r\nskb = nci_skb_alloc(ndev,\r\nconn_info->max_pkt_payload_len +\r\nNCI_DATA_HDR_SIZE, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_reserve(skb, NCI_DATA_HDR_SIZE + 1);\r\n}\r\n} while (i < data_len);\r\nreturn i;\r\n}\r\nstatic void nci_hci_send_data_req(struct nci_dev *ndev, unsigned long opt)\r\n{\r\nstruct nci_data *data = (struct nci_data *)opt;\r\nnci_hci_send_data(ndev, data->pipe, data->cmd,\r\ndata->data, data->data_len);\r\n}\r\nint nci_hci_send_event(struct nci_dev *ndev, u8 gate, u8 event,\r\nconst u8 *param, size_t param_len)\r\n{\r\nu8 pipe = ndev->hci_dev->gate2pipe[gate];\r\nif (pipe == NCI_HCI_INVALID_PIPE)\r\nreturn -EADDRNOTAVAIL;\r\nreturn nci_hci_send_data(ndev, pipe,\r\nNCI_HCP_HEADER(NCI_HCI_HCP_EVENT, event),\r\nparam, param_len);\r\n}\r\nint nci_hci_send_cmd(struct nci_dev *ndev, u8 gate, u8 cmd,\r\nconst u8 *param, size_t param_len,\r\nstruct sk_buff **skb)\r\n{\r\nstruct nci_hcp_message *message;\r\nstruct nci_conn_info *conn_info;\r\nstruct nci_data data;\r\nint r;\r\nu8 pipe = ndev->hci_dev->gate2pipe[gate];\r\nif (pipe == NCI_HCI_INVALID_PIPE)\r\nreturn -EADDRNOTAVAIL;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\ndata.conn_id = conn_info->conn_id;\r\ndata.pipe = pipe;\r\ndata.cmd = NCI_HCP_HEADER(NCI_HCI_HCP_COMMAND, cmd);\r\ndata.data = param;\r\ndata.data_len = param_len;\r\nr = nci_request(ndev, nci_hci_send_data_req, (unsigned long)&data,\r\nmsecs_to_jiffies(NCI_DATA_TIMEOUT));\r\nif (r == NCI_STATUS_OK) {\r\nmessage = (struct nci_hcp_message *)conn_info->rx_skb->data;\r\nr = nci_hci_result_to_errno(\r\nNCI_HCP_MSG_GET_CMD(message->header));\r\nskb_pull(conn_info->rx_skb, NCI_HCI_HCP_MESSAGE_HEADER_LEN);\r\nif (!r && skb)\r\n*skb = conn_info->rx_skb;\r\n}\r\nreturn r;\r\n}\r\nint nci_hci_clear_all_pipes(struct nci_dev *ndev)\r\n{\r\nint r;\r\nr = nci_hci_send_cmd(ndev, NCI_HCI_ADMIN_GATE,\r\nNCI_HCI_ADM_CLEAR_ALL_PIPE, NULL, 0, NULL);\r\nif (r < 0)\r\nreturn r;\r\nnci_hci_reset_pipes(ndev->hci_dev);\r\nreturn r;\r\n}\r\nstatic void nci_hci_event_received(struct nci_dev *ndev, u8 pipe,\r\nu8 event, struct sk_buff *skb)\r\n{\r\nif (ndev->ops->hci_event_received)\r\nndev->ops->hci_event_received(ndev, pipe, event, skb);\r\n}\r\nstatic void nci_hci_cmd_received(struct nci_dev *ndev, u8 pipe,\r\nu8 cmd, struct sk_buff *skb)\r\n{\r\nu8 gate = ndev->hci_dev->pipes[pipe].gate;\r\nu8 status = NCI_HCI_ANY_OK | ~NCI_HCI_FRAGMENT;\r\nu8 dest_gate, new_pipe;\r\nstruct nci_hci_create_pipe_resp *create_info;\r\nstruct nci_hci_delete_pipe_noti *delete_info;\r\nstruct nci_hci_all_pipe_cleared_noti *cleared_info;\r\npr_debug("from gate %x pipe %x cmd %x\n", gate, pipe, cmd);\r\nswitch (cmd) {\r\ncase NCI_HCI_ADM_NOTIFY_PIPE_CREATED:\r\nif (skb->len != 5) {\r\nstatus = NCI_HCI_ANY_E_NOK;\r\ngoto exit;\r\n}\r\ncreate_info = (struct nci_hci_create_pipe_resp *)skb->data;\r\ndest_gate = create_info->dest_gate;\r\nnew_pipe = create_info->pipe;\r\nndev->hci_dev->gate2pipe[dest_gate] = new_pipe;\r\nndev->hci_dev->pipes[new_pipe].gate = dest_gate;\r\nndev->hci_dev->pipes[new_pipe].host =\r\ncreate_info->src_host;\r\nbreak;\r\ncase NCI_HCI_ANY_OPEN_PIPE:\r\nif (gate == NCI_HCI_INVALID_GATE) {\r\nstatus = NCI_HCI_ANY_E_NOK;\r\ngoto exit;\r\n}\r\nbreak;\r\ncase NCI_HCI_ADM_NOTIFY_PIPE_DELETED:\r\nif (skb->len != 1) {\r\nstatus = NCI_HCI_ANY_E_NOK;\r\ngoto exit;\r\n}\r\ndelete_info = (struct nci_hci_delete_pipe_noti *)skb->data;\r\nndev->hci_dev->pipes[delete_info->pipe].gate =\r\nNCI_HCI_INVALID_GATE;\r\nndev->hci_dev->pipes[delete_info->pipe].host =\r\nNCI_HCI_INVALID_HOST;\r\nbreak;\r\ncase NCI_HCI_ADM_NOTIFY_ALL_PIPE_CLEARED:\r\nif (skb->len != 1) {\r\nstatus = NCI_HCI_ANY_E_NOK;\r\ngoto exit;\r\n}\r\ncleared_info =\r\n(struct nci_hci_all_pipe_cleared_noti *)skb->data;\r\nnci_hci_reset_pipes_per_host(ndev, cleared_info->host);\r\nbreak;\r\ndefault:\r\npr_debug("Discarded unknown cmd %x to gate %x\n", cmd, gate);\r\nbreak;\r\n}\r\nif (ndev->ops->hci_cmd_received)\r\nndev->ops->hci_cmd_received(ndev, pipe, cmd, skb);\r\nexit:\r\nnci_hci_send_data(ndev, pipe, status, NULL, 0);\r\nkfree_skb(skb);\r\n}\r\nstatic void nci_hci_resp_received(struct nci_dev *ndev, u8 pipe,\r\nu8 result, struct sk_buff *skb)\r\n{\r\nstruct nci_conn_info *conn_info;\r\nu8 status = result;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info) {\r\nstatus = NCI_STATUS_REJECTED;\r\ngoto exit;\r\n}\r\nconn_info->rx_skb = skb;\r\nexit:\r\nnci_req_complete(ndev, NCI_STATUS_OK);\r\n}\r\nstatic void nci_hci_hcp_message_rx(struct nci_dev *ndev, u8 pipe,\r\nu8 type, u8 instruction, struct sk_buff *skb)\r\n{\r\nswitch (type) {\r\ncase NCI_HCI_HCP_RESPONSE:\r\nnci_hci_resp_received(ndev, pipe, instruction, skb);\r\nbreak;\r\ncase NCI_HCI_HCP_COMMAND:\r\nnci_hci_cmd_received(ndev, pipe, instruction, skb);\r\nbreak;\r\ncase NCI_HCI_HCP_EVENT:\r\nnci_hci_event_received(ndev, pipe, instruction, skb);\r\nbreak;\r\ndefault:\r\npr_err("UNKNOWN MSG Type %d, instruction=%d\n",\r\ntype, instruction);\r\nkfree_skb(skb);\r\nbreak;\r\n}\r\nnci_req_complete(ndev, NCI_STATUS_OK);\r\n}\r\nstatic void nci_hci_msg_rx_work(struct work_struct *work)\r\n{\r\nstruct nci_hci_dev *hdev =\r\ncontainer_of(work, struct nci_hci_dev, msg_rx_work);\r\nstruct sk_buff *skb;\r\nstruct nci_hcp_message *message;\r\nu8 pipe, type, instruction;\r\nwhile ((skb = skb_dequeue(&hdev->msg_rx_queue)) != NULL) {\r\npipe = NCI_HCP_MSG_GET_PIPE(skb->data[0]);\r\nskb_pull(skb, NCI_HCI_HCP_PACKET_HEADER_LEN);\r\nmessage = (struct nci_hcp_message *)skb->data;\r\ntype = NCI_HCP_MSG_GET_TYPE(message->header);\r\ninstruction = NCI_HCP_MSG_GET_CMD(message->header);\r\nskb_pull(skb, NCI_HCI_HCP_MESSAGE_HEADER_LEN);\r\nnci_hci_hcp_message_rx(hdev->ndev, pipe,\r\ntype, instruction, skb);\r\n}\r\n}\r\nvoid nci_hci_data_received_cb(void *context,\r\nstruct sk_buff *skb, int err)\r\n{\r\nstruct nci_dev *ndev = (struct nci_dev *)context;\r\nstruct nci_hcp_packet *packet;\r\nu8 pipe, type;\r\nstruct sk_buff *hcp_skb;\r\nstruct sk_buff *frag_skb;\r\nint msg_len;\r\npr_debug("\n");\r\nif (err) {\r\nnci_req_complete(ndev, err);\r\nreturn;\r\n}\r\npacket = (struct nci_hcp_packet *)skb->data;\r\nif ((packet->header & ~NCI_HCI_FRAGMENT) == 0) {\r\nskb_queue_tail(&ndev->hci_dev->rx_hcp_frags, skb);\r\nreturn;\r\n}\r\nif (skb_queue_len(&ndev->hci_dev->rx_hcp_frags)) {\r\npipe = NCI_HCP_MSG_GET_PIPE(packet->header);\r\nskb_queue_tail(&ndev->hci_dev->rx_hcp_frags, skb);\r\nmsg_len = 0;\r\nskb_queue_walk(&ndev->hci_dev->rx_hcp_frags, frag_skb) {\r\nmsg_len += (frag_skb->len -\r\nNCI_HCI_HCP_PACKET_HEADER_LEN);\r\n}\r\nhcp_skb = nfc_alloc_recv_skb(NCI_HCI_HCP_PACKET_HEADER_LEN +\r\nmsg_len, GFP_KERNEL);\r\nif (!hcp_skb) {\r\nnci_req_complete(ndev, -ENOMEM);\r\nreturn;\r\n}\r\nskb_put_u8(hcp_skb, pipe);\r\nskb_queue_walk(&ndev->hci_dev->rx_hcp_frags, frag_skb) {\r\nmsg_len = frag_skb->len - NCI_HCI_HCP_PACKET_HEADER_LEN;\r\nskb_put_data(hcp_skb,\r\nfrag_skb->data + NCI_HCI_HCP_PACKET_HEADER_LEN,\r\nmsg_len);\r\n}\r\nskb_queue_purge(&ndev->hci_dev->rx_hcp_frags);\r\n} else {\r\npacket->header &= NCI_HCI_FRAGMENT;\r\nhcp_skb = skb;\r\n}\r\npacket = (struct nci_hcp_packet *)hcp_skb->data;\r\ntype = NCI_HCP_MSG_GET_TYPE(packet->message.header);\r\nif (type == NCI_HCI_HCP_RESPONSE) {\r\npipe = NCI_HCP_MSG_GET_PIPE(packet->header);\r\nskb_pull(hcp_skb, NCI_HCI_HCP_PACKET_HEADER_LEN);\r\nnci_hci_hcp_message_rx(ndev, pipe, type,\r\nNCI_STATUS_OK, hcp_skb);\r\n} else {\r\nskb_queue_tail(&ndev->hci_dev->msg_rx_queue, hcp_skb);\r\nschedule_work(&ndev->hci_dev->msg_rx_work);\r\n}\r\n}\r\nint nci_hci_open_pipe(struct nci_dev *ndev, u8 pipe)\r\n{\r\nstruct nci_data data;\r\nstruct nci_conn_info *conn_info;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\ndata.conn_id = conn_info->conn_id;\r\ndata.pipe = pipe;\r\ndata.cmd = NCI_HCP_HEADER(NCI_HCI_HCP_COMMAND,\r\nNCI_HCI_ANY_OPEN_PIPE);\r\ndata.data = NULL;\r\ndata.data_len = 0;\r\nreturn nci_request(ndev, nci_hci_send_data_req,\r\n(unsigned long)&data,\r\nmsecs_to_jiffies(NCI_DATA_TIMEOUT));\r\n}\r\nstatic u8 nci_hci_create_pipe(struct nci_dev *ndev, u8 dest_host,\r\nu8 dest_gate, int *result)\r\n{\r\nu8 pipe;\r\nstruct sk_buff *skb;\r\nstruct nci_hci_create_pipe_params params;\r\nstruct nci_hci_create_pipe_resp *resp;\r\npr_debug("gate=%d\n", dest_gate);\r\nparams.src_gate = NCI_HCI_ADMIN_GATE;\r\nparams.dest_host = dest_host;\r\nparams.dest_gate = dest_gate;\r\n*result = nci_hci_send_cmd(ndev, NCI_HCI_ADMIN_GATE,\r\nNCI_HCI_ADM_CREATE_PIPE,\r\n(u8 *)&params, sizeof(params), &skb);\r\nif (*result < 0)\r\nreturn NCI_HCI_INVALID_PIPE;\r\nresp = (struct nci_hci_create_pipe_resp *)skb->data;\r\npipe = resp->pipe;\r\nkfree_skb(skb);\r\npr_debug("pipe created=%d\n", pipe);\r\nreturn pipe;\r\n}\r\nstatic int nci_hci_delete_pipe(struct nci_dev *ndev, u8 pipe)\r\n{\r\npr_debug("\n");\r\nreturn nci_hci_send_cmd(ndev, NCI_HCI_ADMIN_GATE,\r\nNCI_HCI_ADM_DELETE_PIPE, &pipe, 1, NULL);\r\n}\r\nint nci_hci_set_param(struct nci_dev *ndev, u8 gate, u8 idx,\r\nconst u8 *param, size_t param_len)\r\n{\r\nstruct nci_hcp_message *message;\r\nstruct nci_conn_info *conn_info;\r\nstruct nci_data data;\r\nint r;\r\nu8 *tmp;\r\nu8 pipe = ndev->hci_dev->gate2pipe[gate];\r\npr_debug("idx=%d to gate %d\n", idx, gate);\r\nif (pipe == NCI_HCI_INVALID_PIPE)\r\nreturn -EADDRNOTAVAIL;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\ntmp = kmalloc(1 + param_len, GFP_KERNEL);\r\nif (!tmp)\r\nreturn -ENOMEM;\r\n*tmp = idx;\r\nmemcpy(tmp + 1, param, param_len);\r\ndata.conn_id = conn_info->conn_id;\r\ndata.pipe = pipe;\r\ndata.cmd = NCI_HCP_HEADER(NCI_HCI_HCP_COMMAND,\r\nNCI_HCI_ANY_SET_PARAMETER);\r\ndata.data = tmp;\r\ndata.data_len = param_len + 1;\r\nr = nci_request(ndev, nci_hci_send_data_req,\r\n(unsigned long)&data,\r\nmsecs_to_jiffies(NCI_DATA_TIMEOUT));\r\nif (r == NCI_STATUS_OK) {\r\nmessage = (struct nci_hcp_message *)conn_info->rx_skb->data;\r\nr = nci_hci_result_to_errno(\r\nNCI_HCP_MSG_GET_CMD(message->header));\r\nskb_pull(conn_info->rx_skb, NCI_HCI_HCP_MESSAGE_HEADER_LEN);\r\n}\r\nkfree(tmp);\r\nreturn r;\r\n}\r\nint nci_hci_get_param(struct nci_dev *ndev, u8 gate, u8 idx,\r\nstruct sk_buff **skb)\r\n{\r\nstruct nci_hcp_message *message;\r\nstruct nci_conn_info *conn_info;\r\nstruct nci_data data;\r\nint r;\r\nu8 pipe = ndev->hci_dev->gate2pipe[gate];\r\npr_debug("idx=%d to gate %d\n", idx, gate);\r\nif (pipe == NCI_HCI_INVALID_PIPE)\r\nreturn -EADDRNOTAVAIL;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\ndata.conn_id = conn_info->conn_id;\r\ndata.pipe = pipe;\r\ndata.cmd = NCI_HCP_HEADER(NCI_HCI_HCP_COMMAND,\r\nNCI_HCI_ANY_GET_PARAMETER);\r\ndata.data = &idx;\r\ndata.data_len = 1;\r\nr = nci_request(ndev, nci_hci_send_data_req, (unsigned long)&data,\r\nmsecs_to_jiffies(NCI_DATA_TIMEOUT));\r\nif (r == NCI_STATUS_OK) {\r\nmessage = (struct nci_hcp_message *)conn_info->rx_skb->data;\r\nr = nci_hci_result_to_errno(\r\nNCI_HCP_MSG_GET_CMD(message->header));\r\nskb_pull(conn_info->rx_skb, NCI_HCI_HCP_MESSAGE_HEADER_LEN);\r\nif (!r && skb)\r\n*skb = conn_info->rx_skb;\r\n}\r\nreturn r;\r\n}\r\nint nci_hci_connect_gate(struct nci_dev *ndev,\r\nu8 dest_host, u8 dest_gate, u8 pipe)\r\n{\r\nbool pipe_created = false;\r\nint r;\r\nif (pipe == NCI_HCI_DO_NOT_OPEN_PIPE)\r\nreturn 0;\r\nif (ndev->hci_dev->gate2pipe[dest_gate] != NCI_HCI_INVALID_PIPE)\r\nreturn -EADDRINUSE;\r\nif (pipe != NCI_HCI_INVALID_PIPE)\r\ngoto open_pipe;\r\nswitch (dest_gate) {\r\ncase NCI_HCI_LINK_MGMT_GATE:\r\npipe = NCI_HCI_LINK_MGMT_PIPE;\r\nbreak;\r\ncase NCI_HCI_ADMIN_GATE:\r\npipe = NCI_HCI_ADMIN_PIPE;\r\nbreak;\r\ndefault:\r\npipe = nci_hci_create_pipe(ndev, dest_host, dest_gate, &r);\r\nif (pipe == NCI_HCI_INVALID_PIPE)\r\nreturn r;\r\npipe_created = true;\r\nbreak;\r\n}\r\nopen_pipe:\r\nr = nci_hci_open_pipe(ndev, pipe);\r\nif (r < 0) {\r\nif (pipe_created) {\r\nif (nci_hci_delete_pipe(ndev, pipe) < 0) {\r\n}\r\n}\r\nreturn r;\r\n}\r\nndev->hci_dev->pipes[pipe].gate = dest_gate;\r\nndev->hci_dev->pipes[pipe].host = dest_host;\r\nndev->hci_dev->gate2pipe[dest_gate] = pipe;\r\nreturn 0;\r\n}\r\nstatic int nci_hci_dev_connect_gates(struct nci_dev *ndev,\r\nu8 gate_count,\r\nstruct nci_hci_gate *gates)\r\n{\r\nint r;\r\nwhile (gate_count--) {\r\nr = nci_hci_connect_gate(ndev, gates->dest_host,\r\ngates->gate, gates->pipe);\r\nif (r < 0)\r\nreturn r;\r\ngates++;\r\n}\r\nreturn 0;\r\n}\r\nint nci_hci_dev_session_init(struct nci_dev *ndev)\r\n{\r\nstruct nci_conn_info *conn_info;\r\nstruct sk_buff *skb;\r\nint r;\r\nndev->hci_dev->count_pipes = 0;\r\nndev->hci_dev->expected_pipes = 0;\r\nconn_info = ndev->hci_dev->conn_info;\r\nif (!conn_info)\r\nreturn -EPROTO;\r\nconn_info->data_exchange_cb = nci_hci_data_received_cb;\r\nconn_info->data_exchange_cb_context = ndev;\r\nnci_hci_reset_pipes(ndev->hci_dev);\r\nif (ndev->hci_dev->init_data.gates[0].gate != NCI_HCI_ADMIN_GATE)\r\nreturn -EPROTO;\r\nr = nci_hci_connect_gate(ndev,\r\nndev->hci_dev->init_data.gates[0].dest_host,\r\nndev->hci_dev->init_data.gates[0].gate,\r\nndev->hci_dev->init_data.gates[0].pipe);\r\nif (r < 0)\r\nreturn r;\r\nr = nci_hci_get_param(ndev, NCI_HCI_ADMIN_GATE,\r\nNCI_HCI_ADMIN_PARAM_SESSION_IDENTITY, &skb);\r\nif (r < 0)\r\nreturn r;\r\nif (skb->len &&\r\nskb->len == strlen(ndev->hci_dev->init_data.session_id) &&\r\n!memcmp(ndev->hci_dev->init_data.session_id, skb->data, skb->len) &&\r\nndev->ops->hci_load_session) {\r\nr = ndev->ops->hci_load_session(ndev);\r\n} else {\r\nr = nci_hci_clear_all_pipes(ndev);\r\nif (r < 0)\r\ngoto exit;\r\nr = nci_hci_dev_connect_gates(ndev,\r\nndev->hci_dev->init_data.gate_count,\r\nndev->hci_dev->init_data.gates);\r\nif (r < 0)\r\ngoto exit;\r\nr = nci_hci_set_param(ndev, NCI_HCI_ADMIN_GATE,\r\nNCI_HCI_ADMIN_PARAM_SESSION_IDENTITY,\r\nndev->hci_dev->init_data.session_id,\r\nstrlen(ndev->hci_dev->init_data.session_id));\r\n}\r\nexit:\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nstruct nci_hci_dev *nci_hci_allocate(struct nci_dev *ndev)\r\n{\r\nstruct nci_hci_dev *hdev;\r\nhdev = kzalloc(sizeof(*hdev), GFP_KERNEL);\r\nif (!hdev)\r\nreturn NULL;\r\nskb_queue_head_init(&hdev->rx_hcp_frags);\r\nINIT_WORK(&hdev->msg_rx_work, nci_hci_msg_rx_work);\r\nskb_queue_head_init(&hdev->msg_rx_queue);\r\nhdev->ndev = ndev;\r\nreturn hdev;\r\n}

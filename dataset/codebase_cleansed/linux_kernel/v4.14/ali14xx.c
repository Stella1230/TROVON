static inline u8 inReg(u8 reg)\r\n{\r\noutb_p(reg, regPort);\r\nreturn inb(dataPort);\r\n}\r\nstatic void outReg(u8 data, u8 reg)\r\n{\r\noutb_p(reg, regPort);\r\noutb_p(data, dataPort);\r\n}\r\nstatic void ali14xx_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nint driveNum;\r\nint time1, time2;\r\nu8 param1, param2, param3, param4;\r\nunsigned long flags;\r\nint bus_speed = ide_vlb_clk ? ide_vlb_clk : 50;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nstruct ide_timing *t = ide_timing_find_mode(XFER_PIO_0 + pio);\r\ntime1 = ide_pio_cycle_time(drive, pio);\r\ntime2 = t->active;\r\nparam3 = param1 = (time2 * bus_speed + 999) / 1000;\r\nparam4 = param2 = (time1 * bus_speed + 999) / 1000 - param1;\r\nif (pio < 3) {\r\nparam3 += 8;\r\nparam4 += 8;\r\n}\r\nprintk(KERN_DEBUG "%s: PIO mode%d, t1=%dns, t2=%dns, cycles = %d+%d, %d+%d\n",\r\ndrive->name, pio, time1, time2, param1, param2, param3, param4);\r\ndriveNum = (drive->hwif->index << 1) + (drive->dn & 1);\r\nspin_lock_irqsave(&ali14xx_lock, flags);\r\noutb_p(regOn, basePort);\r\noutReg(param1, regTab[driveNum].reg1);\r\noutReg(param2, regTab[driveNum].reg2);\r\noutReg(param3, regTab[driveNum].reg3);\r\noutReg(param4, regTab[driveNum].reg4);\r\noutb_p(regOff, basePort);\r\nspin_unlock_irqrestore(&ali14xx_lock, flags);\r\n}\r\nstatic int __init findPort(void)\r\n{\r\nint i;\r\nu8 t;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nfor (i = 0; i < ALI_NUM_PORTS; ++i) {\r\nbasePort = ports[i];\r\nregOff = inb(basePort);\r\nfor (regOn = 0x30; regOn <= 0x33; ++regOn) {\r\noutb_p(regOn, basePort);\r\nif (inb(basePort) == regOn) {\r\nregPort = basePort + 4;\r\ndataPort = basePort + 8;\r\nt = inReg(0) & 0xf0;\r\noutb_p(regOff, basePort);\r\nlocal_irq_restore(flags);\r\nif (t != 0x50)\r\nreturn 0;\r\nreturn 1;\r\n}\r\n}\r\noutb_p(regOff, basePort);\r\n}\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int __init initRegisters(void)\r\n{\r\nconst RegInitializer *p;\r\nu8 t;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\noutb_p(regOn, basePort);\r\nfor (p = initData; p->reg != 0; ++p)\r\noutReg(p->data, p->reg);\r\noutb_p(0x01, regPort);\r\nt = inb(regPort) & 0x01;\r\noutb_p(regOff, basePort);\r\nlocal_irq_restore(flags);\r\nreturn t;\r\n}\r\nstatic int __init ali14xx_probe(void)\r\n{\r\nprintk(KERN_DEBUG "ali14xx: base=0x%03x, regOn=0x%02x.\n",\r\nbasePort, regOn);\r\nif (!initRegisters()) {\r\nprintk(KERN_ERR "ali14xx: Chip initialization failed.\n");\r\nreturn 1;\r\n}\r\nreturn ide_legacy_device_add(&ali14xx_port_info, 0);\r\n}\r\nstatic int __init ali14xx_init(void)\r\n{\r\nif (probe_ali14xx == 0)\r\ngoto out;\r\nif (findPort()) {\r\nif (ali14xx_probe())\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nprintk(KERN_ERR "ali14xx: not found.\n");\r\nout:\r\nreturn -ENODEV;\r\n}

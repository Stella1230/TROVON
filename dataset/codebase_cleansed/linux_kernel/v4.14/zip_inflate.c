static int prepare_inflate_zcmd(struct zip_operation *zip_ops,\r\nstruct zip_state *s, union zip_inst_s *zip_cmd)\r\n{\r\nunion zip_zres_s *result_ptr = &s->result;\r\nmemset(zip_cmd, 0, sizeof(s->zip_cmd));\r\nmemset(result_ptr, 0, sizeof(s->result));\r\nzip_cmd->s.hg = 0;\r\nzip_cmd->s.ce = 0;\r\nzip_cmd->s.ss = 0;\r\nzip_cmd->s.sf = 1;\r\nif (zip_ops->begin_file == 0)\r\nzip_cmd->s.bf = 0;\r\nelse\r\nzip_cmd->s.bf = 1;\r\nzip_cmd->s.ef = 1;\r\nzip_cmd->s.cc = zip_ops->ccode;\r\nzip_cmd->s.adlercrc32 = zip_ops->csum;\r\nzip_cmd->s.historylength = 0;\r\nzip_cmd->s.ds = 0;\r\nzip_cmd->s.out_ptr_addr.s.addr = __pa(zip_ops->output);\r\nzip_cmd->s.out_ptr_ctl.s.length = zip_ops->output_len;\r\nzip_cmd->s.totaloutputlength = zip_ops->output_len;\r\nzip_dbg("Data Direct Input case ");\r\nzip_cmd->s.dg = 0;\r\nzip_cmd->s.inp_ptr_addr.s.addr = __pa((u8 *)zip_ops->input);\r\nzip_cmd->s.inp_ptr_ctl.s.length = zip_ops->input_len;\r\nzip_cmd->s.res_ptr_addr.s.addr = __pa(result_ptr);\r\nresult_ptr->s.compcode = 0;\r\nreturn 0;\r\n}\r\nint zip_inflate(struct zip_operation *zip_ops, struct zip_state *s,\r\nstruct zip_device *zip_dev)\r\n{\r\nunion zip_inst_s *zip_cmd = &s->zip_cmd;\r\nunion zip_zres_s *result_ptr = &s->result;\r\nu32 queue;\r\nprepare_inflate_zcmd(zip_ops, s, zip_cmd);\r\natomic64_add(zip_ops->input_len, &zip_dev->stats.decomp_in_bytes);\r\nqueue = zip_load_instr(zip_cmd, zip_dev);\r\natomic64_inc(&zip_dev->stats.decomp_req_submit);\r\nwhile (!result_ptr->s.compcode)\r\ncontinue;\r\natomic64_inc(&zip_dev->stats.decomp_req_complete);\r\nzip_ops->compcode = result_ptr->s.compcode;\r\nswitch (zip_ops->compcode) {\r\ncase ZIP_CMD_NOTDONE:\r\nzip_dbg("Zip Instruction not yet completed\n");\r\nreturn ZIP_ERROR;\r\ncase ZIP_CMD_SUCCESS:\r\nzip_dbg("Zip Instruction completed successfully\n");\r\nbreak;\r\ncase ZIP_CMD_DYNAMIC_STOP:\r\nzip_dbg(" Dynamic stop Initiated\n");\r\nbreak;\r\ndefault:\r\nzip_dbg("Instruction failed. Code = %d\n", zip_ops->compcode);\r\natomic64_inc(&zip_dev->stats.decomp_bad_reqs);\r\nzip_update_cmd_bufs(zip_dev, queue);\r\nreturn ZIP_ERROR;\r\n}\r\nzip_update_cmd_bufs(zip_dev, queue);\r\nif ((zip_ops->ccode == 3) && (zip_ops->flush == 4) &&\r\n(zip_ops->compcode != ZIP_CMD_DYNAMIC_STOP))\r\nresult_ptr->s.ef = 1;\r\nzip_ops->csum = result_ptr->s.adler32;\r\natomic64_add(result_ptr->s.totalbyteswritten,\r\n&zip_dev->stats.decomp_out_bytes);\r\nif (zip_ops->output_len < result_ptr->s.totalbyteswritten) {\r\nzip_err("output_len (%d) < total bytes written (%d)\n",\r\nzip_ops->output_len, result_ptr->s.totalbyteswritten);\r\nzip_ops->output_len = 0;\r\n} else {\r\nzip_ops->output_len = result_ptr->s.totalbyteswritten;\r\n}\r\nzip_ops->bytes_read = result_ptr->s.totalbytesread;\r\nzip_ops->bits_processed = result_ptr->s.totalbitsprocessed;\r\nzip_ops->end_file = result_ptr->s.ef;\r\nif (zip_ops->end_file) {\r\nswitch (zip_ops->format) {\r\ncase RAW_FORMAT:\r\nzip_dbg("RAW Format: %d ", zip_ops->format);\r\nzip_ops->csum = result_ptr->s.adler32;\r\nbreak;\r\ncase ZLIB_FORMAT:\r\nzip_dbg("ZLIB Format: %d ", zip_ops->format);\r\nzip_ops->csum = result_ptr->s.adler32;\r\nbreak;\r\ncase GZIP_FORMAT:\r\nzip_dbg("GZIP Format: %d ", zip_ops->format);\r\nzip_ops->csum = result_ptr->s.crc32;\r\nbreak;\r\ncase LZS_FORMAT:\r\nzip_dbg("LZS Format: %d ", zip_ops->format);\r\nbreak;\r\ndefault:\r\nzip_err("Format error:%d\n", zip_ops->format);\r\n}\r\n}\r\nreturn 0;\r\n}

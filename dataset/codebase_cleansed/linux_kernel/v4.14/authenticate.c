int main(int argc, char *argv[])\r\n{\r\nunsigned int timeout = 10000;\r\nchar *capdev;\r\nint fd, ret;\r\nif (argc != 2) {\r\nprintf("\nUsage: ./firmware <Path of the gb-cap-X dev>\n");\r\nreturn 0;\r\n}\r\ncapdev = argv[1];\r\nprintf("Opening %s authentication device\n", capdev);\r\nfd = open(capdev, O_RDWR);\r\nif (fd < 0) {\r\nprintf("Failed to open: %s\n", capdev);\r\nreturn -1;\r\n}\r\nprintf("Get UID\n");\r\nret = ioctl(fd, CAP_IOC_GET_ENDPOINT_UID, &uid);\r\nif (ret < 0) {\r\nprintf("Failed to get UID: %s (%d)\n", capdev, ret);\r\nret = -1;\r\ngoto close_fd;\r\n}\r\nprintf("UID received: 0x%llx\n", *(unsigned long long int *)(uid.uid));\r\nprintf("Get IMS certificate\n");\r\nret = ioctl(fd, CAP_IOC_GET_IMS_CERTIFICATE, &cert);\r\nif (ret < 0) {\r\nprintf("Failed to get IMS certificate: %s (%d)\n", capdev, ret);\r\nret = -1;\r\ngoto close_fd;\r\n}\r\nprintf("IMS Certificate size: %d\n", cert.cert_size);\r\nprintf("Authenticate module\n");\r\nmemcpy(authenticate.uid, uid.uid, 8);\r\nret = ioctl(fd, CAP_IOC_AUTHENTICATE, &authenticate);\r\nif (ret < 0) {\r\nprintf("Failed to authenticate module: %s (%d)\n", capdev, ret);\r\nret = -1;\r\ngoto close_fd;\r\n}\r\nprintf("Authenticated, result (%02x), sig-size (%02x)\n",\r\nauthenticate.result_code, authenticate.signature_size);\r\nclose_fd:\r\nclose(fd);\r\nreturn ret;\r\n}

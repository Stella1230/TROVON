static void netlbl_domhsh_free_entry(struct rcu_head *entry)\r\n{\r\nstruct netlbl_dom_map *ptr;\r\nstruct netlbl_af4list *iter4;\r\nstruct netlbl_af4list *tmp4;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct netlbl_af6list *iter6;\r\nstruct netlbl_af6list *tmp6;\r\n#endif\r\nptr = container_of(entry, struct netlbl_dom_map, rcu);\r\nif (ptr->def.type == NETLBL_NLTYPE_ADDRSELECT) {\r\nnetlbl_af4list_foreach_safe(iter4, tmp4,\r\n&ptr->def.addrsel->list4) {\r\nnetlbl_af4list_remove_entry(iter4);\r\nkfree(netlbl_domhsh_addr4_entry(iter4));\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_safe(iter6, tmp6,\r\n&ptr->def.addrsel->list6) {\r\nnetlbl_af6list_remove_entry(iter6);\r\nkfree(netlbl_domhsh_addr6_entry(iter6));\r\n}\r\n#endif\r\n}\r\nkfree(ptr->domain);\r\nkfree(ptr);\r\n}\r\nstatic u32 netlbl_domhsh_hash(const char *key)\r\n{\r\nu32 iter;\r\nu32 val;\r\nu32 len;\r\nfor (iter = 0, val = 0, len = strlen(key); iter < len; iter++)\r\nval = (val << 4 | (val >> (8 * sizeof(u32) - 4))) ^ key[iter];\r\nreturn val & (netlbl_domhsh_rcu_deref(netlbl_domhsh)->size - 1);\r\n}\r\nstatic bool netlbl_family_match(u16 f1, u16 f2)\r\n{\r\nreturn (f1 == f2) || (f1 == AF_UNSPEC) || (f2 == AF_UNSPEC);\r\n}\r\nstatic struct netlbl_dom_map *netlbl_domhsh_search(const char *domain,\r\nu16 family)\r\n{\r\nu32 bkt;\r\nstruct list_head *bkt_list;\r\nstruct netlbl_dom_map *iter;\r\nif (domain != NULL) {\r\nbkt = netlbl_domhsh_hash(domain);\r\nbkt_list = &netlbl_domhsh_rcu_deref(netlbl_domhsh)->tbl[bkt];\r\nlist_for_each_entry_rcu(iter, bkt_list, list)\r\nif (iter->valid &&\r\nnetlbl_family_match(iter->family, family) &&\r\nstrcmp(iter->domain, domain) == 0)\r\nreturn iter;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct netlbl_dom_map *netlbl_domhsh_search_def(const char *domain,\r\nu16 family)\r\n{\r\nstruct netlbl_dom_map *entry;\r\nentry = netlbl_domhsh_search(domain, family);\r\nif (entry != NULL)\r\nreturn entry;\r\nif (family == AF_INET || family == AF_UNSPEC) {\r\nentry = netlbl_domhsh_rcu_deref(netlbl_domhsh_def_ipv4);\r\nif (entry != NULL && entry->valid)\r\nreturn entry;\r\n}\r\nif (family == AF_INET6 || family == AF_UNSPEC) {\r\nentry = netlbl_domhsh_rcu_deref(netlbl_domhsh_def_ipv6);\r\nif (entry != NULL && entry->valid)\r\nreturn entry;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void netlbl_domhsh_audit_add(struct netlbl_dom_map *entry,\r\nstruct netlbl_af4list *addr4,\r\nstruct netlbl_af6list *addr6,\r\nint result,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nstruct audit_buffer *audit_buf;\r\nstruct cipso_v4_doi *cipsov4 = NULL;\r\nstruct calipso_doi *calipso = NULL;\r\nu32 type;\r\naudit_buf = netlbl_audit_start_common(AUDIT_MAC_MAP_ADD, audit_info);\r\nif (audit_buf != NULL) {\r\naudit_log_format(audit_buf, " nlbl_domain=%s",\r\nentry->domain ? entry->domain : "(default)");\r\nif (addr4 != NULL) {\r\nstruct netlbl_domaddr4_map *map4;\r\nmap4 = netlbl_domhsh_addr4_entry(addr4);\r\ntype = map4->def.type;\r\ncipsov4 = map4->def.cipso;\r\nnetlbl_af4list_audit_addr(audit_buf, 0, NULL,\r\naddr4->addr, addr4->mask);\r\n#if IS_ENABLED(CONFIG_IPV6)\r\n} else if (addr6 != NULL) {\r\nstruct netlbl_domaddr6_map *map6;\r\nmap6 = netlbl_domhsh_addr6_entry(addr6);\r\ntype = map6->def.type;\r\ncalipso = map6->def.calipso;\r\nnetlbl_af6list_audit_addr(audit_buf, 0, NULL,\r\n&addr6->addr, &addr6->mask);\r\n#endif\r\n} else {\r\ntype = entry->def.type;\r\ncipsov4 = entry->def.cipso;\r\ncalipso = entry->def.calipso;\r\n}\r\nswitch (type) {\r\ncase NETLBL_NLTYPE_UNLABELED:\r\naudit_log_format(audit_buf, " nlbl_protocol=unlbl");\r\nbreak;\r\ncase NETLBL_NLTYPE_CIPSOV4:\r\nBUG_ON(cipsov4 == NULL);\r\naudit_log_format(audit_buf,\r\n" nlbl_protocol=cipsov4 cipso_doi=%u",\r\ncipsov4->doi);\r\nbreak;\r\ncase NETLBL_NLTYPE_CALIPSO:\r\nBUG_ON(calipso == NULL);\r\naudit_log_format(audit_buf,\r\n" nlbl_protocol=calipso calipso_doi=%u",\r\ncalipso->doi);\r\nbreak;\r\n}\r\naudit_log_format(audit_buf, " res=%u", result == 0 ? 1 : 0);\r\naudit_log_end(audit_buf);\r\n}\r\n}\r\nstatic int netlbl_domhsh_validate(const struct netlbl_dom_map *entry)\r\n{\r\nstruct netlbl_af4list *iter4;\r\nstruct netlbl_domaddr4_map *map4;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct netlbl_af6list *iter6;\r\nstruct netlbl_domaddr6_map *map6;\r\n#endif\r\nif (entry == NULL)\r\nreturn -EINVAL;\r\nif (entry->family != AF_INET && entry->family != AF_INET6 &&\r\n(entry->family != AF_UNSPEC ||\r\nentry->def.type != NETLBL_NLTYPE_UNLABELED))\r\nreturn -EINVAL;\r\nswitch (entry->def.type) {\r\ncase NETLBL_NLTYPE_UNLABELED:\r\nif (entry->def.cipso != NULL || entry->def.calipso != NULL ||\r\nentry->def.addrsel != NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NETLBL_NLTYPE_CIPSOV4:\r\nif (entry->family != AF_INET ||\r\nentry->def.cipso == NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NETLBL_NLTYPE_CALIPSO:\r\nif (entry->family != AF_INET6 ||\r\nentry->def.calipso == NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NETLBL_NLTYPE_ADDRSELECT:\r\nnetlbl_af4list_foreach(iter4, &entry->def.addrsel->list4) {\r\nmap4 = netlbl_domhsh_addr4_entry(iter4);\r\nswitch (map4->def.type) {\r\ncase NETLBL_NLTYPE_UNLABELED:\r\nif (map4->def.cipso != NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NETLBL_NLTYPE_CIPSOV4:\r\nif (map4->def.cipso == NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach(iter6, &entry->def.addrsel->list6) {\r\nmap6 = netlbl_domhsh_addr6_entry(iter6);\r\nswitch (map6->def.type) {\r\ncase NETLBL_NLTYPE_UNLABELED:\r\nif (map6->def.calipso != NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NETLBL_NLTYPE_CALIPSO:\r\nif (map6->def.calipso == NULL)\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\n#endif\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint __init netlbl_domhsh_init(u32 size)\r\n{\r\nu32 iter;\r\nstruct netlbl_domhsh_tbl *hsh_tbl;\r\nif (size == 0)\r\nreturn -EINVAL;\r\nhsh_tbl = kmalloc(sizeof(*hsh_tbl), GFP_KERNEL);\r\nif (hsh_tbl == NULL)\r\nreturn -ENOMEM;\r\nhsh_tbl->size = 1 << size;\r\nhsh_tbl->tbl = kcalloc(hsh_tbl->size,\r\nsizeof(struct list_head),\r\nGFP_KERNEL);\r\nif (hsh_tbl->tbl == NULL) {\r\nkfree(hsh_tbl);\r\nreturn -ENOMEM;\r\n}\r\nfor (iter = 0; iter < hsh_tbl->size; iter++)\r\nINIT_LIST_HEAD(&hsh_tbl->tbl[iter]);\r\nspin_lock(&netlbl_domhsh_lock);\r\nrcu_assign_pointer(netlbl_domhsh, hsh_tbl);\r\nspin_unlock(&netlbl_domhsh_lock);\r\nreturn 0;\r\n}\r\nint netlbl_domhsh_add(struct netlbl_dom_map *entry,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val = 0;\r\nstruct netlbl_dom_map *entry_old, *entry_b;\r\nstruct netlbl_af4list *iter4;\r\nstruct netlbl_af4list *tmp4;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct netlbl_af6list *iter6;\r\nstruct netlbl_af6list *tmp6;\r\n#endif\r\nret_val = netlbl_domhsh_validate(entry);\r\nif (ret_val != 0)\r\nreturn ret_val;\r\nrcu_read_lock();\r\nspin_lock(&netlbl_domhsh_lock);\r\nif (entry->domain != NULL)\r\nentry_old = netlbl_domhsh_search(entry->domain, entry->family);\r\nelse\r\nentry_old = netlbl_domhsh_search_def(entry->domain,\r\nentry->family);\r\nif (entry_old == NULL) {\r\nentry->valid = 1;\r\nif (entry->domain != NULL) {\r\nu32 bkt = netlbl_domhsh_hash(entry->domain);\r\nlist_add_tail_rcu(&entry->list,\r\n&rcu_dereference(netlbl_domhsh)->tbl[bkt]);\r\n} else {\r\nINIT_LIST_HEAD(&entry->list);\r\nswitch (entry->family) {\r\ncase AF_INET:\r\nrcu_assign_pointer(netlbl_domhsh_def_ipv4,\r\nentry);\r\nbreak;\r\ncase AF_INET6:\r\nrcu_assign_pointer(netlbl_domhsh_def_ipv6,\r\nentry);\r\nbreak;\r\ncase AF_UNSPEC:\r\nif (entry->def.type !=\r\nNETLBL_NLTYPE_UNLABELED) {\r\nret_val = -EINVAL;\r\ngoto add_return;\r\n}\r\nentry_b = kzalloc(sizeof(*entry_b), GFP_ATOMIC);\r\nif (entry_b == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_return;\r\n}\r\nentry_b->family = AF_INET6;\r\nentry_b->def.type = NETLBL_NLTYPE_UNLABELED;\r\nentry_b->valid = 1;\r\nentry->family = AF_INET;\r\nrcu_assign_pointer(netlbl_domhsh_def_ipv4,\r\nentry);\r\nrcu_assign_pointer(netlbl_domhsh_def_ipv6,\r\nentry_b);\r\nbreak;\r\ndefault:\r\nret_val = -EINVAL;\r\ngoto add_return;\r\n}\r\n}\r\nif (entry->def.type == NETLBL_NLTYPE_ADDRSELECT) {\r\nnetlbl_af4list_foreach_rcu(iter4,\r\n&entry->def.addrsel->list4)\r\nnetlbl_domhsh_audit_add(entry, iter4, NULL,\r\nret_val, audit_info);\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_rcu(iter6,\r\n&entry->def.addrsel->list6)\r\nnetlbl_domhsh_audit_add(entry, NULL, iter6,\r\nret_val, audit_info);\r\n#endif\r\n} else\r\nnetlbl_domhsh_audit_add(entry, NULL, NULL,\r\nret_val, audit_info);\r\n} else if (entry_old->def.type == NETLBL_NLTYPE_ADDRSELECT &&\r\nentry->def.type == NETLBL_NLTYPE_ADDRSELECT) {\r\nstruct list_head *old_list4;\r\nstruct list_head *old_list6;\r\nold_list4 = &entry_old->def.addrsel->list4;\r\nold_list6 = &entry_old->def.addrsel->list6;\r\nnetlbl_af4list_foreach_rcu(iter4, &entry->def.addrsel->list4)\r\nif (netlbl_af4list_search_exact(iter4->addr,\r\niter4->mask,\r\nold_list4)) {\r\nret_val = -EEXIST;\r\ngoto add_return;\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_rcu(iter6, &entry->def.addrsel->list6)\r\nif (netlbl_af6list_search_exact(&iter6->addr,\r\n&iter6->mask,\r\nold_list6)) {\r\nret_val = -EEXIST;\r\ngoto add_return;\r\n}\r\n#endif\r\nnetlbl_af4list_foreach_safe(iter4, tmp4,\r\n&entry->def.addrsel->list4) {\r\nnetlbl_af4list_remove_entry(iter4);\r\niter4->valid = 1;\r\nret_val = netlbl_af4list_add(iter4, old_list4);\r\nnetlbl_domhsh_audit_add(entry_old, iter4, NULL,\r\nret_val, audit_info);\r\nif (ret_val != 0)\r\ngoto add_return;\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_safe(iter6, tmp6,\r\n&entry->def.addrsel->list6) {\r\nnetlbl_af6list_remove_entry(iter6);\r\niter6->valid = 1;\r\nret_val = netlbl_af6list_add(iter6, old_list6);\r\nnetlbl_domhsh_audit_add(entry_old, NULL, iter6,\r\nret_val, audit_info);\r\nif (ret_val != 0)\r\ngoto add_return;\r\n}\r\n#endif\r\n} else\r\nret_val = -EINVAL;\r\nadd_return:\r\nspin_unlock(&netlbl_domhsh_lock);\r\nrcu_read_unlock();\r\nreturn ret_val;\r\n}\r\nint netlbl_domhsh_add_default(struct netlbl_dom_map *entry,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nreturn netlbl_domhsh_add(entry, audit_info);\r\n}\r\nint netlbl_domhsh_remove_entry(struct netlbl_dom_map *entry,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val = 0;\r\nstruct audit_buffer *audit_buf;\r\nif (entry == NULL)\r\nreturn -ENOENT;\r\nspin_lock(&netlbl_domhsh_lock);\r\nif (entry->valid) {\r\nentry->valid = 0;\r\nif (entry == rcu_dereference(netlbl_domhsh_def_ipv4))\r\nRCU_INIT_POINTER(netlbl_domhsh_def_ipv4, NULL);\r\nelse if (entry == rcu_dereference(netlbl_domhsh_def_ipv6))\r\nRCU_INIT_POINTER(netlbl_domhsh_def_ipv6, NULL);\r\nelse\r\nlist_del_rcu(&entry->list);\r\n} else\r\nret_val = -ENOENT;\r\nspin_unlock(&netlbl_domhsh_lock);\r\naudit_buf = netlbl_audit_start_common(AUDIT_MAC_MAP_DEL, audit_info);\r\nif (audit_buf != NULL) {\r\naudit_log_format(audit_buf,\r\n" nlbl_domain=%s res=%u",\r\nentry->domain ? entry->domain : "(default)",\r\nret_val == 0 ? 1 : 0);\r\naudit_log_end(audit_buf);\r\n}\r\nif (ret_val == 0) {\r\nstruct netlbl_af4list *iter4;\r\nstruct netlbl_domaddr4_map *map4;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct netlbl_af6list *iter6;\r\nstruct netlbl_domaddr6_map *map6;\r\n#endif\r\nswitch (entry->def.type) {\r\ncase NETLBL_NLTYPE_ADDRSELECT:\r\nnetlbl_af4list_foreach_rcu(iter4,\r\n&entry->def.addrsel->list4) {\r\nmap4 = netlbl_domhsh_addr4_entry(iter4);\r\ncipso_v4_doi_putdef(map4->def.cipso);\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_rcu(iter6,\r\n&entry->def.addrsel->list6) {\r\nmap6 = netlbl_domhsh_addr6_entry(iter6);\r\ncalipso_doi_putdef(map6->def.calipso);\r\n}\r\n#endif\r\nbreak;\r\ncase NETLBL_NLTYPE_CIPSOV4:\r\ncipso_v4_doi_putdef(entry->def.cipso);\r\nbreak;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\ncase NETLBL_NLTYPE_CALIPSO:\r\ncalipso_doi_putdef(entry->def.calipso);\r\nbreak;\r\n#endif\r\n}\r\ncall_rcu(&entry->rcu, netlbl_domhsh_free_entry);\r\n}\r\nreturn ret_val;\r\n}\r\nint netlbl_domhsh_remove_af4(const char *domain,\r\nconst struct in_addr *addr,\r\nconst struct in_addr *mask,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nstruct netlbl_dom_map *entry_map;\r\nstruct netlbl_af4list *entry_addr;\r\nstruct netlbl_af4list *iter4;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct netlbl_af6list *iter6;\r\n#endif\r\nstruct netlbl_domaddr4_map *entry;\r\nrcu_read_lock();\r\nif (domain)\r\nentry_map = netlbl_domhsh_search(domain, AF_INET);\r\nelse\r\nentry_map = netlbl_domhsh_search_def(domain, AF_INET);\r\nif (entry_map == NULL ||\r\nentry_map->def.type != NETLBL_NLTYPE_ADDRSELECT)\r\ngoto remove_af4_failure;\r\nspin_lock(&netlbl_domhsh_lock);\r\nentry_addr = netlbl_af4list_remove(addr->s_addr, mask->s_addr,\r\n&entry_map->def.addrsel->list4);\r\nspin_unlock(&netlbl_domhsh_lock);\r\nif (entry_addr == NULL)\r\ngoto remove_af4_failure;\r\nnetlbl_af4list_foreach_rcu(iter4, &entry_map->def.addrsel->list4)\r\ngoto remove_af4_single_addr;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nnetlbl_af6list_foreach_rcu(iter6, &entry_map->def.addrsel->list6)\r\ngoto remove_af4_single_addr;\r\n#endif\r\nnetlbl_domhsh_remove_entry(entry_map, audit_info);\r\nremove_af4_single_addr:\r\nrcu_read_unlock();\r\nsynchronize_rcu();\r\nentry = netlbl_domhsh_addr4_entry(entry_addr);\r\ncipso_v4_doi_putdef(entry->def.cipso);\r\nkfree(entry);\r\nreturn 0;\r\nremove_af4_failure:\r\nrcu_read_unlock();\r\nreturn -ENOENT;\r\n}\r\nint netlbl_domhsh_remove_af6(const char *domain,\r\nconst struct in6_addr *addr,\r\nconst struct in6_addr *mask,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nstruct netlbl_dom_map *entry_map;\r\nstruct netlbl_af6list *entry_addr;\r\nstruct netlbl_af4list *iter4;\r\nstruct netlbl_af6list *iter6;\r\nstruct netlbl_domaddr6_map *entry;\r\nrcu_read_lock();\r\nif (domain)\r\nentry_map = netlbl_domhsh_search(domain, AF_INET6);\r\nelse\r\nentry_map = netlbl_domhsh_search_def(domain, AF_INET6);\r\nif (entry_map == NULL ||\r\nentry_map->def.type != NETLBL_NLTYPE_ADDRSELECT)\r\ngoto remove_af6_failure;\r\nspin_lock(&netlbl_domhsh_lock);\r\nentry_addr = netlbl_af6list_remove(addr, mask,\r\n&entry_map->def.addrsel->list6);\r\nspin_unlock(&netlbl_domhsh_lock);\r\nif (entry_addr == NULL)\r\ngoto remove_af6_failure;\r\nnetlbl_af4list_foreach_rcu(iter4, &entry_map->def.addrsel->list4)\r\ngoto remove_af6_single_addr;\r\nnetlbl_af6list_foreach_rcu(iter6, &entry_map->def.addrsel->list6)\r\ngoto remove_af6_single_addr;\r\nnetlbl_domhsh_remove_entry(entry_map, audit_info);\r\nremove_af6_single_addr:\r\nrcu_read_unlock();\r\nsynchronize_rcu();\r\nentry = netlbl_domhsh_addr6_entry(entry_addr);\r\ncalipso_doi_putdef(entry->def.calipso);\r\nkfree(entry);\r\nreturn 0;\r\nremove_af6_failure:\r\nrcu_read_unlock();\r\nreturn -ENOENT;\r\n}\r\nint netlbl_domhsh_remove(const char *domain, u16 family,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct netlbl_dom_map *entry;\r\nrcu_read_lock();\r\nif (family == AF_INET || family == AF_UNSPEC) {\r\nif (domain)\r\nentry = netlbl_domhsh_search(domain, AF_INET);\r\nelse\r\nentry = netlbl_domhsh_search_def(domain, AF_INET);\r\nret_val = netlbl_domhsh_remove_entry(entry, audit_info);\r\nif (ret_val && ret_val != -ENOENT)\r\ngoto done;\r\n}\r\nif (family == AF_INET6 || family == AF_UNSPEC) {\r\nint ret_val2;\r\nif (domain)\r\nentry = netlbl_domhsh_search(domain, AF_INET6);\r\nelse\r\nentry = netlbl_domhsh_search_def(domain, AF_INET6);\r\nret_val2 = netlbl_domhsh_remove_entry(entry, audit_info);\r\nif (ret_val2 != -ENOENT)\r\nret_val = ret_val2;\r\n}\r\ndone:\r\nrcu_read_unlock();\r\nreturn ret_val;\r\n}\r\nint netlbl_domhsh_remove_default(u16 family, struct netlbl_audit *audit_info)\r\n{\r\nreturn netlbl_domhsh_remove(NULL, family, audit_info);\r\n}\r\nstruct netlbl_dom_map *netlbl_domhsh_getentry(const char *domain, u16 family)\r\n{\r\nif (family == AF_UNSPEC)\r\nreturn NULL;\r\nreturn netlbl_domhsh_search_def(domain, family);\r\n}\r\nstruct netlbl_dommap_def *netlbl_domhsh_getentry_af4(const char *domain,\r\n__be32 addr)\r\n{\r\nstruct netlbl_dom_map *dom_iter;\r\nstruct netlbl_af4list *addr_iter;\r\ndom_iter = netlbl_domhsh_search_def(domain, AF_INET);\r\nif (dom_iter == NULL)\r\nreturn NULL;\r\nif (dom_iter->def.type != NETLBL_NLTYPE_ADDRSELECT)\r\nreturn &dom_iter->def;\r\naddr_iter = netlbl_af4list_search(addr, &dom_iter->def.addrsel->list4);\r\nif (addr_iter == NULL)\r\nreturn NULL;\r\nreturn &(netlbl_domhsh_addr4_entry(addr_iter)->def);\r\n}\r\nstruct netlbl_dommap_def *netlbl_domhsh_getentry_af6(const char *domain,\r\nconst struct in6_addr *addr)\r\n{\r\nstruct netlbl_dom_map *dom_iter;\r\nstruct netlbl_af6list *addr_iter;\r\ndom_iter = netlbl_domhsh_search_def(domain, AF_INET6);\r\nif (dom_iter == NULL)\r\nreturn NULL;\r\nif (dom_iter->def.type != NETLBL_NLTYPE_ADDRSELECT)\r\nreturn &dom_iter->def;\r\naddr_iter = netlbl_af6list_search(addr, &dom_iter->def.addrsel->list6);\r\nif (addr_iter == NULL)\r\nreturn NULL;\r\nreturn &(netlbl_domhsh_addr6_entry(addr_iter)->def);\r\n}\r\nint netlbl_domhsh_walk(u32 *skip_bkt,\r\nu32 *skip_chain,\r\nint (*callback) (struct netlbl_dom_map *entry, void *arg),\r\nvoid *cb_arg)\r\n{\r\nint ret_val = -ENOENT;\r\nu32 iter_bkt;\r\nstruct list_head *iter_list;\r\nstruct netlbl_dom_map *iter_entry;\r\nu32 chain_cnt = 0;\r\nrcu_read_lock();\r\nfor (iter_bkt = *skip_bkt;\r\niter_bkt < rcu_dereference(netlbl_domhsh)->size;\r\niter_bkt++, chain_cnt = 0) {\r\niter_list = &rcu_dereference(netlbl_domhsh)->tbl[iter_bkt];\r\nlist_for_each_entry_rcu(iter_entry, iter_list, list)\r\nif (iter_entry->valid) {\r\nif (chain_cnt++ < *skip_chain)\r\ncontinue;\r\nret_val = callback(iter_entry, cb_arg);\r\nif (ret_val < 0) {\r\nchain_cnt--;\r\ngoto walk_return;\r\n}\r\n}\r\n}\r\nwalk_return:\r\nrcu_read_unlock();\r\n*skip_bkt = iter_bkt;\r\n*skip_chain = chain_cnt;\r\nreturn ret_val;\r\n}

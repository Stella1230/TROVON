static void sunxi_clrbits(void __iomem *reg, u32 clr_val)\r\n{\r\nu32 reg_val;\r\nreg_val = readl(reg);\r\nreg_val &= ~(clr_val);\r\nwritel(reg_val, reg);\r\n}\r\nstatic void sunxi_setbits(void __iomem *reg, u32 set_val)\r\n{\r\nu32 reg_val;\r\nreg_val = readl(reg);\r\nreg_val |= set_val;\r\nwritel(reg_val, reg);\r\n}\r\nstatic void sunxi_clrsetbits(void __iomem *reg, u32 clr_val, u32 set_val)\r\n{\r\nu32 reg_val;\r\nreg_val = readl(reg);\r\nreg_val &= ~(clr_val);\r\nreg_val |= set_val;\r\nwritel(reg_val, reg);\r\n}\r\nstatic u32 sunxi_getbits(void __iomem *reg, u8 mask, u8 shift)\r\n{\r\nreturn (readl(reg) >> shift) & mask;\r\n}\r\nstatic int ahci_sunxi_phy_init(struct device *dev, void __iomem *reg_base)\r\n{\r\nu32 reg_val;\r\nint timeout;\r\nwritel(0, reg_base + AHCI_RWCR);\r\nmsleep(5);\r\nsunxi_setbits(reg_base + AHCI_PHYCS1R, BIT(19));\r\nsunxi_clrsetbits(reg_base + AHCI_PHYCS0R,\r\n(0x7 << 24),\r\n(0x5 << 24) | BIT(23) | BIT(18));\r\nsunxi_clrsetbits(reg_base + AHCI_PHYCS1R,\r\n(0x3 << 16) | (0x1f << 8) | (0x3 << 6),\r\n(0x2 << 16) | (0x6 << 8) | (0x2 << 6));\r\nsunxi_setbits(reg_base + AHCI_PHYCS1R, BIT(28) | BIT(15));\r\nsunxi_clrbits(reg_base + AHCI_PHYCS1R, BIT(19));\r\nsunxi_clrsetbits(reg_base + AHCI_PHYCS0R,\r\n(0x7 << 20), (0x3 << 20));\r\nsunxi_clrsetbits(reg_base + AHCI_PHYCS2R,\r\n(0x1f << 5), (0x19 << 5));\r\nmsleep(5);\r\nsunxi_setbits(reg_base + AHCI_PHYCS0R, (0x1 << 19));\r\ntimeout = 250;\r\ndo {\r\nreg_val = sunxi_getbits(reg_base + AHCI_PHYCS0R, 0x7, 28);\r\nif (reg_val == 0x02)\r\nbreak;\r\nif (--timeout == 0) {\r\ndev_err(dev, "PHY power up failed.\n");\r\nreturn -EIO;\r\n}\r\nudelay(1);\r\n} while (1);\r\nsunxi_setbits(reg_base + AHCI_PHYCS2R, (0x1 << 24));\r\ntimeout = 100;\r\ndo {\r\nreg_val = sunxi_getbits(reg_base + AHCI_PHYCS2R, 0x1, 24);\r\nif (reg_val == 0x00)\r\nbreak;\r\nif (--timeout == 0) {\r\ndev_err(dev, "PHY calibration failed.\n");\r\nreturn -EIO;\r\n}\r\nudelay(1);\r\n} while (1);\r\nmsleep(15);\r\nwritel(0x7, reg_base + AHCI_RWCR);\r\nreturn 0;\r\n}\r\nstatic void ahci_sunxi_start_engine(struct ata_port *ap)\r\n{\r\nvoid __iomem *port_mmio = ahci_port_base(ap);\r\nstruct ahci_host_priv *hpriv = ap->host->private_data;\r\nsunxi_clrsetbits(hpriv->mmio + AHCI_P0DMACR, 0x0000ff00, 0x00004400);\r\nsunxi_setbits(port_mmio + PORT_CMD, PORT_CMD_START);\r\n}\r\nstatic int ahci_sunxi_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ahci_host_priv *hpriv;\r\nint rc;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nhpriv->start_engine = ahci_sunxi_start_engine;\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nrc = ahci_sunxi_phy_init(dev, hpriv->mmio);\r\nif (rc)\r\ngoto disable_resources;\r\nhpriv->flags = AHCI_HFLAG_32BIT_ONLY | AHCI_HFLAG_NO_MSI |\r\nAHCI_HFLAG_YES_NCQ;\r\nif (!enable_pmp)\r\nhpriv->flags |= AHCI_HFLAG_NO_PMP;\r\nrc = ahci_platform_init_host(pdev, hpriv, &ahci_sunxi_port_info,\r\n&ahci_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}\r\nstatic int ahci_sunxi_resume(struct device *dev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(dev);\r\nstruct ahci_host_priv *hpriv = host->private_data;\r\nint rc;\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nrc = ahci_sunxi_phy_init(dev, hpriv->mmio);\r\nif (rc)\r\ngoto disable_resources;\r\nrc = ahci_platform_resume_host(dev);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

struct mlx5_fpga_conn *\r\nmlx5_fpga_sbu_conn_create(struct mlx5_fpga_device *fdev,\r\nstruct mlx5_fpga_conn_attr *attr)\r\n{\r\nreturn mlx5_fpga_conn_create(fdev, attr, MLX5_FPGA_QPC_QP_TYPE_SANDBOX_QP);\r\n}\r\nvoid mlx5_fpga_sbu_conn_destroy(struct mlx5_fpga_conn *conn)\r\n{\r\nmlx5_fpga_conn_destroy(conn);\r\n}\r\nint mlx5_fpga_sbu_conn_sendmsg(struct mlx5_fpga_conn *conn,\r\nstruct mlx5_fpga_dma_buf *buf)\r\n{\r\nreturn mlx5_fpga_conn_send(conn, buf);\r\n}\r\nstatic int mlx5_fpga_mem_read_i2c(struct mlx5_fpga_device *fdev, size_t size,\r\nu64 addr, u8 *buf)\r\n{\r\nsize_t max_size = MLX5_FPGA_ACCESS_REG_SIZE_MAX;\r\nsize_t bytes_done = 0;\r\nu8 actual_size;\r\nint err;\r\nif (!fdev->mdev)\r\nreturn -ENOTCONN;\r\nwhile (bytes_done < size) {\r\nactual_size = min(max_size, (size - bytes_done));\r\nerr = mlx5_fpga_access_reg(fdev->mdev, actual_size,\r\naddr + bytes_done,\r\nbuf + bytes_done, false);\r\nif (err) {\r\nmlx5_fpga_err(fdev, "Failed to read over I2C: %d\n",\r\nerr);\r\nbreak;\r\n}\r\nbytes_done += actual_size;\r\n}\r\nreturn err;\r\n}\r\nstatic int mlx5_fpga_mem_write_i2c(struct mlx5_fpga_device *fdev, size_t size,\r\nu64 addr, u8 *buf)\r\n{\r\nsize_t max_size = MLX5_FPGA_ACCESS_REG_SIZE_MAX;\r\nsize_t bytes_done = 0;\r\nu8 actual_size;\r\nint err;\r\nif (!fdev->mdev)\r\nreturn -ENOTCONN;\r\nwhile (bytes_done < size) {\r\nactual_size = min(max_size, (size - bytes_done));\r\nerr = mlx5_fpga_access_reg(fdev->mdev, actual_size,\r\naddr + bytes_done,\r\nbuf + bytes_done, true);\r\nif (err) {\r\nmlx5_fpga_err(fdev, "Failed to write FPGA crspace\n");\r\nbreak;\r\n}\r\nbytes_done += actual_size;\r\n}\r\nreturn err;\r\n}\r\nint mlx5_fpga_mem_read(struct mlx5_fpga_device *fdev, size_t size, u64 addr,\r\nvoid *buf, enum mlx5_fpga_access_type access_type)\r\n{\r\nint ret;\r\nswitch (access_type) {\r\ncase MLX5_FPGA_ACCESS_TYPE_I2C:\r\nret = mlx5_fpga_mem_read_i2c(fdev, size, addr, buf);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\nmlx5_fpga_warn(fdev, "Unexpected read access_type %u\n",\r\naccess_type);\r\nreturn -EACCES;\r\n}\r\nreturn size;\r\n}\r\nint mlx5_fpga_mem_write(struct mlx5_fpga_device *fdev, size_t size, u64 addr,\r\nvoid *buf, enum mlx5_fpga_access_type access_type)\r\n{\r\nint ret;\r\nswitch (access_type) {\r\ncase MLX5_FPGA_ACCESS_TYPE_I2C:\r\nret = mlx5_fpga_mem_write_i2c(fdev, size, addr, buf);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\nmlx5_fpga_warn(fdev, "Unexpected write access_type %u\n",\r\naccess_type);\r\nreturn -EACCES;\r\n}\r\nreturn size;\r\n}\r\nint mlx5_fpga_get_sbu_caps(struct mlx5_fpga_device *fdev, int size, void *buf)\r\n{\r\nreturn mlx5_fpga_sbu_caps(fdev->mdev, buf, size);\r\n}

static char *mapfile(const char *fn, size_t *size)\r\n{\r\nunsigned ps = sysconf(_SC_PAGESIZE);\r\nstruct stat st;\r\nchar *map = NULL;\r\nint err;\r\nint fd = open(fn, O_RDONLY);\r\nif (fd < 0 && verbose > 0 && fn) {\r\npr_err("Error opening events file '%s': %s\n", fn,\r\nstrerror(errno));\r\n}\r\nif (fd < 0)\r\nreturn NULL;\r\nerr = fstat(fd, &st);\r\nif (err < 0)\r\ngoto out;\r\n*size = st.st_size;\r\nmap = mmap(NULL,\r\n(st.st_size + ps - 1) & ~(ps - 1),\r\nPROT_READ|PROT_WRITE, MAP_PRIVATE, fd, 0);\r\nif (map == MAP_FAILED)\r\nmap = NULL;\r\nout:\r\nclose(fd);\r\nreturn map;\r\n}\r\nstatic void unmapfile(char *map, size_t size)\r\n{\r\nunsigned ps = sysconf(_SC_PAGESIZE);\r\nmunmap(map, roundup(size, ps));\r\n}\r\njsmntok_t *parse_json(const char *fn, char **map, size_t *size, int *len)\r\n{\r\njsmn_parser parser;\r\njsmntok_t *tokens;\r\njsmnerr_t res;\r\nunsigned sz;\r\n*map = mapfile(fn, size);\r\nif (!*map)\r\nreturn NULL;\r\nsz = *size * 16;\r\ntokens = malloc(sz);\r\nif (!tokens)\r\ngoto error;\r\njsmn_init(&parser);\r\nres = jsmn_parse(&parser, *map, *size, tokens,\r\nsz / sizeof(jsmntok_t));\r\nif (res != JSMN_SUCCESS) {\r\npr_err("%s: json error %s\n", fn, jsmn_strerror(res));\r\ngoto error_free;\r\n}\r\nif (len)\r\n*len = parser.toknext;\r\nreturn tokens;\r\nerror_free:\r\nfree(tokens);\r\nerror:\r\nunmapfile(*map, *size);\r\nreturn NULL;\r\n}\r\nvoid free_json(char *map, size_t size, jsmntok_t *tokens)\r\n{\r\nfree(tokens);\r\nunmapfile(map, size);\r\n}\r\nstatic int countchar(char *map, char c, int end)\r\n{\r\nint i;\r\nint count = 0;\r\nfor (i = 0; i < end; i++)\r\nif (map[i] == c)\r\ncount++;\r\nreturn count;\r\n}\r\nint json_line(char *map, jsmntok_t *t)\r\n{\r\nreturn countchar(map, '\n', t->start) + 1;\r\n}\r\nconst char *json_name(jsmntok_t *t)\r\n{\r\nreturn LOOKUP(jsmn_types, t->type);\r\n}\r\nint json_len(jsmntok_t *t)\r\n{\r\nreturn t->end - t->start;\r\n}\r\nint json_streq(char *map, jsmntok_t *t, const char *s)\r\n{\r\nunsigned len = json_len(t);\r\nreturn len == strlen(s) && !strncasecmp(map + t->start, s, len);\r\n}

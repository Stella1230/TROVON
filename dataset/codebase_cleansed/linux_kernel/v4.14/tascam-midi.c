static int midi_capture_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_playback_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_tscm *tscm = substream->rmidi->private_data;\r\nsnd_fw_async_midi_port_init(&tscm->out_ports[substream->number]);\r\nreturn 0;\r\n}\r\nstatic int midi_capture_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_playback_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic void midi_playback_drain(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_tscm *tscm = substream->rmidi->private_data;\r\nsnd_fw_async_midi_port_finish(&tscm->out_ports[substream->number]);\r\n}\r\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substrm, int up)\r\n{\r\nstruct snd_tscm *tscm = substrm->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tscm->lock, flags);\r\nif (up)\r\ntscm->tx_midi_substreams[substrm->number] = substrm;\r\nelse\r\ntscm->tx_midi_substreams[substrm->number] = NULL;\r\nspin_unlock_irqrestore(&tscm->lock, flags);\r\n}\r\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substrm, int up)\r\n{\r\nstruct snd_tscm *tscm = substrm->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tscm->lock, flags);\r\nif (up)\r\nsnd_fw_async_midi_port_run(&tscm->out_ports[substrm->number],\r\nsubstrm);\r\nspin_unlock_irqrestore(&tscm->lock, flags);\r\n}\r\nint snd_tscm_create_midi_devices(struct snd_tscm *tscm)\r\n{\r\nstatic const struct snd_rawmidi_ops capture_ops = {\r\n.open = midi_capture_open,\r\n.close = midi_capture_close,\r\n.trigger = midi_capture_trigger,\r\n};\r\nstatic const struct snd_rawmidi_ops playback_ops = {\r\n.open = midi_playback_open,\r\n.close = midi_playback_close,\r\n.drain = midi_playback_drain,\r\n.trigger = midi_playback_trigger,\r\n};\r\nstruct snd_rawmidi *rmidi;\r\nstruct snd_rawmidi_str *stream;\r\nstruct snd_rawmidi_substream *subs;\r\nint err;\r\nerr = snd_rawmidi_new(tscm->card, tscm->card->driver, 0,\r\ntscm->spec->midi_playback_ports,\r\ntscm->spec->midi_capture_ports,\r\n&rmidi);\r\nif (err < 0)\r\nreturn err;\r\nsnprintf(rmidi->name, sizeof(rmidi->name),\r\n"%s MIDI", tscm->card->shortname);\r\nrmidi->private_data = tscm;\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&capture_ops);\r\nstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT];\r\nlist_for_each_entry(subs, &stream->substreams, list) {\r\nif (subs->number < tscm->spec->midi_capture_ports) {\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s MIDI %d",\r\ntscm->card->shortname, subs->number + 1);\r\n}\r\n}\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&playback_ops);\r\nstream = &rmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\r\nlist_for_each_entry(subs, &stream->substreams, list) {\r\nif (subs->number < tscm->spec->midi_playback_ports) {\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s MIDI %d",\r\ntscm->card->shortname, subs->number + 1);\r\n}\r\n}\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\r\nreturn 0;\r\n}

static struct qed_ooo_archipelago\r\n*qed_ooo_seek_archipelago(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info\r\n*p_ooo_info,\r\nu32 cid)\r\n{\r\nu32 idx = (cid & 0xffff) - p_ooo_info->cid_base;\r\nstruct qed_ooo_archipelago *p_archipelago;\r\nif (idx >= p_ooo_info->max_num_archipelagos)\r\nreturn NULL;\r\np_archipelago = &p_ooo_info->p_archipelagos_mem[idx];\r\nif (list_empty(&p_archipelago->isles_list))\r\nreturn NULL;\r\nreturn p_archipelago;\r\n}\r\nstatic struct qed_ooo_isle *qed_ooo_seek_isle(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nu32 cid, u8 isle)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago = NULL;\r\nstruct qed_ooo_isle *p_isle = NULL;\r\nu8 the_num_of_isle = 1;\r\np_archipelago = qed_ooo_seek_archipelago(p_hwfn, p_ooo_info, cid);\r\nif (!p_archipelago) {\r\nDP_NOTICE(p_hwfn,\r\n"Connection %d is not found in OOO list\n", cid);\r\nreturn NULL;\r\n}\r\nlist_for_each_entry(p_isle, &p_archipelago->isles_list, list_entry) {\r\nif (the_num_of_isle == isle)\r\nreturn p_isle;\r\nthe_num_of_isle++;\r\n}\r\nreturn NULL;\r\n}\r\nvoid qed_ooo_save_history_entry(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nstruct ooo_opaque *p_cqe)\r\n{\r\nstruct qed_ooo_history *p_history = &p_ooo_info->ooo_history;\r\nif (p_history->head_idx == p_history->num_of_cqes)\r\np_history->head_idx = 0;\r\np_history->p_cqes[p_history->head_idx] = *p_cqe;\r\np_history->head_idx++;\r\n}\r\nint qed_ooo_alloc(struct qed_hwfn *p_hwfn)\r\n{\r\nu16 max_num_archipelagos = 0, cid_base;\r\nstruct qed_ooo_info *p_ooo_info;\r\nu16 max_num_isles = 0;\r\nu32 i;\r\nif (p_hwfn->hw_info.personality != QED_PCI_ISCSI) {\r\nDP_NOTICE(p_hwfn,\r\n"Failed to allocate qed_ooo_info: unknown personality\n");\r\nreturn -EINVAL;\r\n}\r\nmax_num_archipelagos = p_hwfn->pf_params.iscsi_pf_params.num_cons;\r\nmax_num_isles = QED_MAX_NUM_ISLES + max_num_archipelagos;\r\ncid_base = (u16)qed_cxt_get_proto_cid_start(p_hwfn, PROTOCOLID_ISCSI);\r\nif (!max_num_archipelagos) {\r\nDP_NOTICE(p_hwfn,\r\n"Failed to allocate qed_ooo_info: unknown amount of connections\n");\r\nreturn -EINVAL;\r\n}\r\np_ooo_info = kzalloc(sizeof(*p_ooo_info), GFP_KERNEL);\r\nif (!p_ooo_info)\r\nreturn -ENOMEM;\r\np_ooo_info->cid_base = cid_base;\r\np_ooo_info->max_num_archipelagos = max_num_archipelagos;\r\nINIT_LIST_HEAD(&p_ooo_info->free_buffers_list);\r\nINIT_LIST_HEAD(&p_ooo_info->ready_buffers_list);\r\nINIT_LIST_HEAD(&p_ooo_info->free_isles_list);\r\np_ooo_info->p_isles_mem = kcalloc(max_num_isles,\r\nsizeof(struct qed_ooo_isle),\r\nGFP_KERNEL);\r\nif (!p_ooo_info->p_isles_mem)\r\ngoto no_isles_mem;\r\nfor (i = 0; i < max_num_isles; i++) {\r\nINIT_LIST_HEAD(&p_ooo_info->p_isles_mem[i].buffers_list);\r\nlist_add_tail(&p_ooo_info->p_isles_mem[i].list_entry,\r\n&p_ooo_info->free_isles_list);\r\n}\r\np_ooo_info->p_archipelagos_mem =\r\nkcalloc(max_num_archipelagos,\r\nsizeof(struct qed_ooo_archipelago),\r\nGFP_KERNEL);\r\nif (!p_ooo_info->p_archipelagos_mem)\r\ngoto no_archipelagos_mem;\r\nfor (i = 0; i < max_num_archipelagos; i++)\r\nINIT_LIST_HEAD(&p_ooo_info->p_archipelagos_mem[i].isles_list);\r\np_ooo_info->ooo_history.p_cqes =\r\nkcalloc(QED_MAX_NUM_OOO_HISTORY_ENTRIES,\r\nsizeof(struct ooo_opaque),\r\nGFP_KERNEL);\r\nif (!p_ooo_info->ooo_history.p_cqes)\r\ngoto no_history_mem;\r\np_ooo_info->ooo_history.num_of_cqes = QED_MAX_NUM_OOO_HISTORY_ENTRIES;\r\np_hwfn->p_ooo_info = p_ooo_info;\r\nreturn 0;\r\nno_history_mem:\r\nkfree(p_ooo_info->p_archipelagos_mem);\r\nno_archipelagos_mem:\r\nkfree(p_ooo_info->p_isles_mem);\r\nno_isles_mem:\r\nkfree(p_ooo_info);\r\nreturn -ENOMEM;\r\n}\r\nvoid qed_ooo_release_connection_isles(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info, u32 cid)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago;\r\nstruct qed_ooo_buffer *p_buffer;\r\nstruct qed_ooo_isle *p_isle;\r\np_archipelago = qed_ooo_seek_archipelago(p_hwfn, p_ooo_info, cid);\r\nif (!p_archipelago)\r\nreturn;\r\nwhile (!list_empty(&p_archipelago->isles_list)) {\r\np_isle = list_first_entry(&p_archipelago->isles_list,\r\nstruct qed_ooo_isle, list_entry);\r\nlist_del(&p_isle->list_entry);\r\nwhile (!list_empty(&p_isle->buffers_list)) {\r\np_buffer = list_first_entry(&p_isle->buffers_list,\r\nstruct qed_ooo_buffer,\r\nlist_entry);\r\nif (!p_buffer)\r\nbreak;\r\nlist_del(&p_buffer->list_entry);\r\nlist_add_tail(&p_buffer->list_entry,\r\n&p_ooo_info->free_buffers_list);\r\n}\r\nlist_add_tail(&p_isle->list_entry,\r\n&p_ooo_info->free_isles_list);\r\n}\r\n}\r\nvoid qed_ooo_release_all_isles(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago;\r\nstruct qed_ooo_buffer *p_buffer;\r\nstruct qed_ooo_isle *p_isle;\r\nu32 i;\r\nfor (i = 0; i < p_ooo_info->max_num_archipelagos; i++) {\r\np_archipelago = &(p_ooo_info->p_archipelagos_mem[i]);\r\nwhile (!list_empty(&p_archipelago->isles_list)) {\r\np_isle = list_first_entry(&p_archipelago->isles_list,\r\nstruct qed_ooo_isle,\r\nlist_entry);\r\nlist_del(&p_isle->list_entry);\r\nwhile (!list_empty(&p_isle->buffers_list)) {\r\np_buffer =\r\nlist_first_entry(&p_isle->buffers_list,\r\nstruct qed_ooo_buffer,\r\nlist_entry);\r\nif (!p_buffer)\r\nbreak;\r\nlist_del(&p_buffer->list_entry);\r\nlist_add_tail(&p_buffer->list_entry,\r\n&p_ooo_info->free_buffers_list);\r\n}\r\nlist_add_tail(&p_isle->list_entry,\r\n&p_ooo_info->free_isles_list);\r\n}\r\n}\r\nif (!list_empty(&p_ooo_info->ready_buffers_list))\r\nlist_splice_tail_init(&p_ooo_info->ready_buffers_list,\r\n&p_ooo_info->free_buffers_list);\r\n}\r\nvoid qed_ooo_setup(struct qed_hwfn *p_hwfn)\r\n{\r\nqed_ooo_release_all_isles(p_hwfn, p_hwfn->p_ooo_info);\r\nmemset(p_hwfn->p_ooo_info->ooo_history.p_cqes, 0,\r\np_hwfn->p_ooo_info->ooo_history.num_of_cqes *\r\nsizeof(struct ooo_opaque));\r\np_hwfn->p_ooo_info->ooo_history.head_idx = 0;\r\n}\r\nvoid qed_ooo_free(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_ooo_info *p_ooo_info = p_hwfn->p_ooo_info;\r\nstruct qed_ooo_buffer *p_buffer;\r\nif (!p_ooo_info)\r\nreturn;\r\nqed_ooo_release_all_isles(p_hwfn, p_ooo_info);\r\nwhile (!list_empty(&p_ooo_info->free_buffers_list)) {\r\np_buffer = list_first_entry(&p_ooo_info->free_buffers_list,\r\nstruct qed_ooo_buffer, list_entry);\r\nif (!p_buffer)\r\nbreak;\r\nlist_del(&p_buffer->list_entry);\r\ndma_free_coherent(&p_hwfn->cdev->pdev->dev,\r\np_buffer->rx_buffer_size,\r\np_buffer->rx_buffer_virt_addr,\r\np_buffer->rx_buffer_phys_addr);\r\nkfree(p_buffer);\r\n}\r\nkfree(p_ooo_info->p_isles_mem);\r\nkfree(p_ooo_info->p_archipelagos_mem);\r\nkfree(p_ooo_info->ooo_history.p_cqes);\r\nkfree(p_ooo_info);\r\np_hwfn->p_ooo_info = NULL;\r\n}\r\nvoid qed_ooo_put_free_buffer(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nstruct qed_ooo_buffer *p_buffer)\r\n{\r\nlist_add_tail(&p_buffer->list_entry, &p_ooo_info->free_buffers_list);\r\n}\r\nstruct qed_ooo_buffer *qed_ooo_get_free_buffer(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info)\r\n{\r\nstruct qed_ooo_buffer *p_buffer = NULL;\r\nif (!list_empty(&p_ooo_info->free_buffers_list)) {\r\np_buffer = list_first_entry(&p_ooo_info->free_buffers_list,\r\nstruct qed_ooo_buffer, list_entry);\r\nlist_del(&p_buffer->list_entry);\r\n}\r\nreturn p_buffer;\r\n}\r\nvoid qed_ooo_put_ready_buffer(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nstruct qed_ooo_buffer *p_buffer, u8 on_tail)\r\n{\r\nif (on_tail)\r\nlist_add_tail(&p_buffer->list_entry,\r\n&p_ooo_info->ready_buffers_list);\r\nelse\r\nlist_add(&p_buffer->list_entry,\r\n&p_ooo_info->ready_buffers_list);\r\n}\r\nstruct qed_ooo_buffer *qed_ooo_get_ready_buffer(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info)\r\n{\r\nstruct qed_ooo_buffer *p_buffer = NULL;\r\nif (!list_empty(&p_ooo_info->ready_buffers_list)) {\r\np_buffer = list_first_entry(&p_ooo_info->ready_buffers_list,\r\nstruct qed_ooo_buffer, list_entry);\r\nlist_del(&p_buffer->list_entry);\r\n}\r\nreturn p_buffer;\r\n}\r\nvoid qed_ooo_delete_isles(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nu32 cid, u8 drop_isle, u8 drop_size)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago = NULL;\r\nstruct qed_ooo_isle *p_isle = NULL;\r\nu8 isle_idx;\r\np_archipelago = qed_ooo_seek_archipelago(p_hwfn, p_ooo_info, cid);\r\nfor (isle_idx = 0; isle_idx < drop_size; isle_idx++) {\r\np_isle = qed_ooo_seek_isle(p_hwfn, p_ooo_info, cid, drop_isle);\r\nif (!p_isle) {\r\nDP_NOTICE(p_hwfn,\r\n"Isle %d is not found(cid %d)\n",\r\ndrop_isle, cid);\r\nreturn;\r\n}\r\nif (list_empty(&p_isle->buffers_list))\r\nDP_NOTICE(p_hwfn,\r\n"Isle %d is empty(cid %d)\n", drop_isle, cid);\r\nelse\r\nlist_splice_tail_init(&p_isle->buffers_list,\r\n&p_ooo_info->free_buffers_list);\r\nlist_del(&p_isle->list_entry);\r\np_ooo_info->cur_isles_number--;\r\nlist_add(&p_isle->list_entry, &p_ooo_info->free_isles_list);\r\n}\r\n}\r\nvoid qed_ooo_add_new_isle(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nu32 cid, u8 ooo_isle,\r\nstruct qed_ooo_buffer *p_buffer)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago = NULL;\r\nstruct qed_ooo_isle *p_prev_isle = NULL;\r\nstruct qed_ooo_isle *p_isle = NULL;\r\nif (ooo_isle > 1) {\r\np_prev_isle = qed_ooo_seek_isle(p_hwfn,\r\np_ooo_info, cid, ooo_isle - 1);\r\nif (!p_prev_isle) {\r\nDP_NOTICE(p_hwfn,\r\n"Isle %d is not found(cid %d)\n",\r\nooo_isle - 1, cid);\r\nreturn;\r\n}\r\n}\r\np_archipelago = qed_ooo_seek_archipelago(p_hwfn, p_ooo_info, cid);\r\nif (!p_archipelago && (ooo_isle != 1)) {\r\nDP_NOTICE(p_hwfn,\r\n"Connection %d is not found in OOO list\n", cid);\r\nreturn;\r\n}\r\nif (!list_empty(&p_ooo_info->free_isles_list)) {\r\np_isle = list_first_entry(&p_ooo_info->free_isles_list,\r\nstruct qed_ooo_isle, list_entry);\r\nlist_del(&p_isle->list_entry);\r\nif (!list_empty(&p_isle->buffers_list)) {\r\nDP_NOTICE(p_hwfn, "Free isle is not empty\n");\r\nINIT_LIST_HEAD(&p_isle->buffers_list);\r\n}\r\n} else {\r\nDP_NOTICE(p_hwfn, "No more free isles\n");\r\nreturn;\r\n}\r\nif (!p_archipelago) {\r\nu32 idx = (cid & 0xffff) - p_ooo_info->cid_base;\r\np_archipelago = &p_ooo_info->p_archipelagos_mem[idx];\r\n}\r\nlist_add(&p_buffer->list_entry, &p_isle->buffers_list);\r\np_ooo_info->cur_isles_number++;\r\np_ooo_info->gen_isles_number++;\r\nif (p_ooo_info->cur_isles_number > p_ooo_info->max_isles_number)\r\np_ooo_info->max_isles_number = p_ooo_info->cur_isles_number;\r\nif (!p_prev_isle)\r\nlist_add(&p_isle->list_entry, &p_archipelago->isles_list);\r\nelse\r\nlist_add(&p_isle->list_entry, &p_prev_isle->list_entry);\r\n}\r\nvoid qed_ooo_add_new_buffer(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info,\r\nu32 cid,\r\nu8 ooo_isle,\r\nstruct qed_ooo_buffer *p_buffer, u8 buffer_side)\r\n{\r\nstruct qed_ooo_isle *p_isle = NULL;\r\np_isle = qed_ooo_seek_isle(p_hwfn, p_ooo_info, cid, ooo_isle);\r\nif (!p_isle) {\r\nDP_NOTICE(p_hwfn,\r\n"Isle %d is not found(cid %d)\n", ooo_isle, cid);\r\nreturn;\r\n}\r\nif (buffer_side == QED_OOO_LEFT_BUF)\r\nlist_add(&p_buffer->list_entry, &p_isle->buffers_list);\r\nelse\r\nlist_add_tail(&p_buffer->list_entry, &p_isle->buffers_list);\r\n}\r\nvoid qed_ooo_join_isles(struct qed_hwfn *p_hwfn,\r\nstruct qed_ooo_info *p_ooo_info, u32 cid, u8 left_isle)\r\n{\r\nstruct qed_ooo_archipelago *p_archipelago = NULL;\r\nstruct qed_ooo_isle *p_right_isle = NULL;\r\nstruct qed_ooo_isle *p_left_isle = NULL;\r\np_right_isle = qed_ooo_seek_isle(p_hwfn, p_ooo_info, cid,\r\nleft_isle + 1);\r\nif (!p_right_isle) {\r\nDP_NOTICE(p_hwfn,\r\n"Right isle %d is not found(cid %d)\n",\r\nleft_isle + 1, cid);\r\nreturn;\r\n}\r\np_archipelago = qed_ooo_seek_archipelago(p_hwfn, p_ooo_info, cid);\r\nlist_del(&p_right_isle->list_entry);\r\np_ooo_info->cur_isles_number--;\r\nif (left_isle) {\r\np_left_isle = qed_ooo_seek_isle(p_hwfn, p_ooo_info, cid,\r\nleft_isle);\r\nif (!p_left_isle) {\r\nDP_NOTICE(p_hwfn,\r\n"Left isle %d is not found(cid %d)\n",\r\nleft_isle, cid);\r\nreturn;\r\n}\r\nlist_splice_tail_init(&p_right_isle->buffers_list,\r\n&p_left_isle->buffers_list);\r\n} else {\r\nlist_splice_tail_init(&p_right_isle->buffers_list,\r\n&p_ooo_info->ready_buffers_list);\r\n}\r\nlist_add_tail(&p_right_isle->list_entry, &p_ooo_info->free_isles_list);\r\n}

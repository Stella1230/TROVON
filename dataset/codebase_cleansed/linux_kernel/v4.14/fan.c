static int fan_get_max_state(struct thermal_cooling_device *cdev, unsigned long\r\n*state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nif (fan->acpi4)\r\n*state = fan->fps_count - 1;\r\nelse\r\n*state = 1;\r\nreturn 0;\r\n}\r\nstatic int fan_get_state_acpi4(struct acpi_device *device, unsigned long *state)\r\n{\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nint control, i;\r\nstatus = acpi_evaluate_object(device->handle, "_FST", NULL, &buffer);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(&device->dev, "Get fan state failed\n");\r\nreturn status;\r\n}\r\nobj = buffer.pointer;\r\nif (!obj || obj->type != ACPI_TYPE_PACKAGE ||\r\nobj->package.count != 3 ||\r\nobj->package.elements[1].type != ACPI_TYPE_INTEGER) {\r\ndev_err(&device->dev, "Invalid _FST data\n");\r\nstatus = -EINVAL;\r\ngoto err;\r\n}\r\ncontrol = obj->package.elements[1].integer.value;\r\nfor (i = 0; i < fan->fps_count; i++) {\r\nif (fan->fif.fine_grain_ctrl && control < fan->fps[i].control) {\r\ni = (i > 0) ? i - 1 : 0;\r\nbreak;\r\n} else if (control == fan->fps[i].control) {\r\nbreak;\r\n}\r\n}\r\nif (i == fan->fps_count) {\r\ndev_dbg(&device->dev, "Invalid control value returned\n");\r\nstatus = -EINVAL;\r\ngoto err;\r\n}\r\n*state = i;\r\nerr:\r\nkfree(obj);\r\nreturn status;\r\n}\r\nstatic int fan_get_state(struct acpi_device *device, unsigned long *state)\r\n{\r\nint result;\r\nint acpi_state = ACPI_STATE_D0;\r\nresult = acpi_device_update_power(device, &acpi_state);\r\nif (result)\r\nreturn result;\r\n*state = acpi_state == ACPI_STATE_D3_COLD\r\n|| acpi_state == ACPI_STATE_D3_HOT ?\r\n0 : (acpi_state == ACPI_STATE_D0 ? 1 : -1);\r\nreturn 0;\r\n}\r\nstatic int fan_get_cur_state(struct thermal_cooling_device *cdev, unsigned long\r\n*state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nif (fan->acpi4)\r\nreturn fan_get_state_acpi4(device, state);\r\nelse\r\nreturn fan_get_state(device, state);\r\n}\r\nstatic int fan_set_state(struct acpi_device *device, unsigned long state)\r\n{\r\nif (state != 0 && state != 1)\r\nreturn -EINVAL;\r\nreturn acpi_device_set_power(device,\r\nstate ? ACPI_STATE_D0 : ACPI_STATE_D3_COLD);\r\n}\r\nstatic int fan_set_state_acpi4(struct acpi_device *device, unsigned long state)\r\n{\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nacpi_status status;\r\nif (state >= fan->fps_count)\r\nreturn -EINVAL;\r\nstatus = acpi_execute_simple_method(device->handle, "_FSL",\r\nfan->fps[state].control);\r\nif (ACPI_FAILURE(status)) {\r\ndev_dbg(&device->dev, "Failed to set state by _FSL\n");\r\nreturn status;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nfan_set_cur_state(struct thermal_cooling_device *cdev, unsigned long state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nif (fan->acpi4)\r\nreturn fan_set_state_acpi4(device, state);\r\nelse\r\nreturn fan_set_state(device, state);\r\n}\r\nstatic bool acpi_fan_is_acpi4(struct acpi_device *device)\r\n{\r\nreturn acpi_has_method(device->handle, "_FIF") &&\r\nacpi_has_method(device->handle, "_FPS") &&\r\nacpi_has_method(device->handle, "_FSL") &&\r\nacpi_has_method(device->handle, "_FST");\r\n}\r\nstatic int acpi_fan_get_fif(struct acpi_device *device)\r\n{\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nstruct acpi_buffer format = { sizeof("NNNN"), "NNNN" };\r\nstruct acpi_buffer fif = { sizeof(fan->fif), &fan->fif };\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nstatus = acpi_evaluate_object(device->handle, "_FIF", NULL, &buffer);\r\nif (ACPI_FAILURE(status))\r\nreturn status;\r\nobj = buffer.pointer;\r\nif (!obj || obj->type != ACPI_TYPE_PACKAGE) {\r\ndev_err(&device->dev, "Invalid _FIF data\n");\r\nstatus = -EINVAL;\r\ngoto err;\r\n}\r\nstatus = acpi_extract_package(obj, &format, &fif);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(&device->dev, "Invalid _FIF element\n");\r\nstatus = -EINVAL;\r\n}\r\nerr:\r\nkfree(obj);\r\nreturn status;\r\n}\r\nstatic int acpi_fan_speed_cmp(const void *a, const void *b)\r\n{\r\nconst struct acpi_fan_fps *fps1 = a;\r\nconst struct acpi_fan_fps *fps2 = b;\r\nreturn fps1->speed - fps2->speed;\r\n}\r\nstatic int acpi_fan_get_fps(struct acpi_device *device)\r\n{\r\nstruct acpi_fan *fan = acpi_driver_data(device);\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nint i;\r\nstatus = acpi_evaluate_object(device->handle, "_FPS", NULL, &buffer);\r\nif (ACPI_FAILURE(status))\r\nreturn status;\r\nobj = buffer.pointer;\r\nif (!obj || obj->type != ACPI_TYPE_PACKAGE || obj->package.count < 2) {\r\ndev_err(&device->dev, "Invalid _FPS data\n");\r\nstatus = -EINVAL;\r\ngoto err;\r\n}\r\nfan->fps_count = obj->package.count - 1;\r\nfan->fps = devm_kzalloc(&device->dev,\r\nfan->fps_count * sizeof(struct acpi_fan_fps),\r\nGFP_KERNEL);\r\nif (!fan->fps) {\r\ndev_err(&device->dev, "Not enough memory\n");\r\nstatus = -ENOMEM;\r\ngoto err;\r\n}\r\nfor (i = 0; i < fan->fps_count; i++) {\r\nstruct acpi_buffer format = { sizeof("NNNNN"), "NNNNN" };\r\nstruct acpi_buffer fps = { sizeof(fan->fps[i]), &fan->fps[i] };\r\nstatus = acpi_extract_package(&obj->package.elements[i + 1],\r\n&format, &fps);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(&device->dev, "Invalid _FPS element\n");\r\nbreak;\r\n}\r\n}\r\nsort(fan->fps, fan->fps_count, sizeof(*fan->fps),\r\nacpi_fan_speed_cmp, NULL);\r\nerr:\r\nkfree(obj);\r\nreturn status;\r\n}\r\nstatic int acpi_fan_probe(struct platform_device *pdev)\r\n{\r\nint result = 0;\r\nstruct thermal_cooling_device *cdev;\r\nstruct acpi_fan *fan;\r\nstruct acpi_device *device = ACPI_COMPANION(&pdev->dev);\r\nchar *name;\r\nfan = devm_kzalloc(&pdev->dev, sizeof(*fan), GFP_KERNEL);\r\nif (!fan) {\r\ndev_err(&device->dev, "No memory for fan\n");\r\nreturn -ENOMEM;\r\n}\r\ndevice->driver_data = fan;\r\nplatform_set_drvdata(pdev, fan);\r\nif (acpi_fan_is_acpi4(device)) {\r\nif (acpi_fan_get_fif(device) || acpi_fan_get_fps(device))\r\ngoto end;\r\nfan->acpi4 = true;\r\n} else {\r\nresult = acpi_device_update_power(device, NULL);\r\nif (result) {\r\ndev_err(&device->dev, "Failed to set initial power state\n");\r\ngoto end;\r\n}\r\n}\r\nif (!strncmp(pdev->name, "PNP0C0B", strlen("PNP0C0B")))\r\nname = "Fan";\r\nelse\r\nname = acpi_device_bid(device);\r\ncdev = thermal_cooling_device_register(name, device,\r\n&fan_cooling_ops);\r\nif (IS_ERR(cdev)) {\r\nresult = PTR_ERR(cdev);\r\ngoto end;\r\n}\r\ndev_dbg(&pdev->dev, "registered as cooling_device%d\n", cdev->id);\r\nfan->cdev = cdev;\r\nresult = sysfs_create_link(&pdev->dev.kobj,\r\n&cdev->device.kobj,\r\n"thermal_cooling");\r\nif (result)\r\ndev_err(&pdev->dev, "Failed to create sysfs link 'thermal_cooling'\n");\r\nresult = sysfs_create_link(&cdev->device.kobj,\r\n&pdev->dev.kobj,\r\n"device");\r\nif (result)\r\ndev_err(&pdev->dev, "Failed to create sysfs link 'device'\n");\r\nend:\r\nreturn result;\r\n}\r\nstatic int acpi_fan_remove(struct platform_device *pdev)\r\n{\r\nstruct acpi_fan *fan = platform_get_drvdata(pdev);\r\nsysfs_remove_link(&pdev->dev.kobj, "thermal_cooling");\r\nsysfs_remove_link(&fan->cdev->device.kobj, "device");\r\nthermal_cooling_device_unregister(fan->cdev);\r\nreturn 0;\r\n}\r\nstatic int acpi_fan_suspend(struct device *dev)\r\n{\r\nstruct acpi_fan *fan = dev_get_drvdata(dev);\r\nif (fan->acpi4)\r\nreturn 0;\r\nacpi_device_set_power(ACPI_COMPANION(dev), ACPI_STATE_D0);\r\nreturn AE_OK;\r\n}\r\nstatic int acpi_fan_resume(struct device *dev)\r\n{\r\nint result;\r\nstruct acpi_fan *fan = dev_get_drvdata(dev);\r\nif (fan->acpi4)\r\nreturn 0;\r\nresult = acpi_device_update_power(ACPI_COMPANION(dev), NULL);\r\nif (result)\r\ndev_err(dev, "Error updating fan power state\n");\r\nreturn result;\r\n}

static int ams_delta_lcd_set_power(struct lcd_device *dev, int power)\r\n{\r\nif (power == FB_BLANK_UNBLANK) {\r\nif (!(ams_delta_lcd & AMS_DELTA_LCD_POWER)) {\r\nomap_writeb(ams_delta_lcd & AMS_DELTA_MAX_CONTRAST,\r\nOMAP_PWL_ENABLE);\r\nomap_writeb(1, OMAP_PWL_CLK_ENABLE);\r\nams_delta_lcd |= AMS_DELTA_LCD_POWER;\r\n}\r\n} else {\r\nif (ams_delta_lcd & AMS_DELTA_LCD_POWER) {\r\nomap_writeb(0, OMAP_PWL_ENABLE);\r\nomap_writeb(0, OMAP_PWL_CLK_ENABLE);\r\nams_delta_lcd &= ~AMS_DELTA_LCD_POWER;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ams_delta_lcd_set_contrast(struct lcd_device *dev, int value)\r\n{\r\nif ((value >= 0) && (value <= AMS_DELTA_MAX_CONTRAST)) {\r\nomap_writeb(value, OMAP_PWL_ENABLE);\r\nams_delta_lcd &= ~AMS_DELTA_MAX_CONTRAST;\r\nams_delta_lcd |= value;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ams_delta_lcd_get_power(struct lcd_device *dev)\r\n{\r\nif (ams_delta_lcd & AMS_DELTA_LCD_POWER)\r\nreturn FB_BLANK_UNBLANK;\r\nelse\r\nreturn FB_BLANK_POWERDOWN;\r\n}\r\nstatic int ams_delta_lcd_get_contrast(struct lcd_device *dev)\r\n{\r\nif (!(ams_delta_lcd & AMS_DELTA_LCD_POWER))\r\nreturn 0;\r\nreturn ams_delta_lcd & AMS_DELTA_MAX_CONTRAST;\r\n}\r\nstatic int ams_delta_panel_init(struct lcd_panel *panel,\r\nstruct omapfb_device *fbdev)\r\n{\r\nreturn gpio_request_array(_gpios, ARRAY_SIZE(_gpios));\r\n}\r\nstatic void ams_delta_panel_cleanup(struct lcd_panel *panel)\r\n{\r\ngpio_free_array(_gpios, ARRAY_SIZE(_gpios));\r\n}\r\nstatic int ams_delta_panel_enable(struct lcd_panel *panel)\r\n{\r\ngpio_set_value(AMS_DELTA_GPIO_PIN_LCD_NDISP, 1);\r\ngpio_set_value(AMS_DELTA_GPIO_PIN_LCD_VBLEN, 1);\r\nreturn 0;\r\n}\r\nstatic void ams_delta_panel_disable(struct lcd_panel *panel)\r\n{\r\ngpio_set_value(AMS_DELTA_GPIO_PIN_LCD_VBLEN, 0);\r\ngpio_set_value(AMS_DELTA_GPIO_PIN_LCD_NDISP, 0);\r\n}\r\nstatic int ams_delta_panel_probe(struct platform_device *pdev)\r\n{\r\nstruct lcd_device *lcd_device = NULL;\r\n#ifdef CONFIG_LCD_CLASS_DEVICE\r\nint ret;\r\nlcd_device = lcd_device_register("omapfb", &pdev->dev, NULL,\r\n&ams_delta_lcd_ops);\r\nif (IS_ERR(lcd_device)) {\r\nret = PTR_ERR(lcd_device);\r\ndev_err(&pdev->dev, "failed to register device\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, lcd_device);\r\nlcd_device->props.max_contrast = AMS_DELTA_MAX_CONTRAST;\r\n#endif\r\nams_delta_lcd_set_contrast(lcd_device, AMS_DELTA_DEFAULT_CONTRAST);\r\nams_delta_lcd_set_power(lcd_device, FB_BLANK_UNBLANK);\r\nomapfb_register_panel(&ams_delta_panel);\r\nreturn 0;\r\n}

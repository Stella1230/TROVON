static void mchp23k256_addr2cmd(struct mchp23k256_flash *flash,\r\nunsigned int addr, u8 *cmd)\r\n{\r\nint i;\r\nfor (i = flash->caps->addr_width; i > 0; i--, addr >>= 8)\r\ncmd[i] = addr;\r\n}\r\nstatic int mchp23k256_cmdsz(struct mchp23k256_flash *flash)\r\n{\r\nreturn 1 + flash->caps->addr_width;\r\n}\r\nstatic int mchp23k256_write(struct mtd_info *mtd, loff_t to, size_t len,\r\nsize_t *retlen, const unsigned char *buf)\r\n{\r\nstruct mchp23k256_flash *flash = to_mchp23k256_flash(mtd);\r\nstruct spi_transfer transfer[2] = {};\r\nstruct spi_message message;\r\nunsigned char command[MAX_CMD_SIZE];\r\nspi_message_init(&message);\r\ncommand[0] = MCHP23K256_CMD_WRITE;\r\nmchp23k256_addr2cmd(flash, to, command);\r\ntransfer[0].tx_buf = command;\r\ntransfer[0].len = mchp23k256_cmdsz(flash);\r\nspi_message_add_tail(&transfer[0], &message);\r\ntransfer[1].tx_buf = buf;\r\ntransfer[1].len = len;\r\nspi_message_add_tail(&transfer[1], &message);\r\nmutex_lock(&flash->lock);\r\nspi_sync(flash->spi, &message);\r\nif (retlen && message.actual_length > sizeof(command))\r\n*retlen += message.actual_length - sizeof(command);\r\nmutex_unlock(&flash->lock);\r\nreturn 0;\r\n}\r\nstatic int mchp23k256_read(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, unsigned char *buf)\r\n{\r\nstruct mchp23k256_flash *flash = to_mchp23k256_flash(mtd);\r\nstruct spi_transfer transfer[2] = {};\r\nstruct spi_message message;\r\nunsigned char command[MAX_CMD_SIZE];\r\nspi_message_init(&message);\r\nmemset(&transfer, 0, sizeof(transfer));\r\ncommand[0] = MCHP23K256_CMD_READ;\r\nmchp23k256_addr2cmd(flash, from, command);\r\ntransfer[0].tx_buf = command;\r\ntransfer[0].len = mchp23k256_cmdsz(flash);\r\nspi_message_add_tail(&transfer[0], &message);\r\ntransfer[1].rx_buf = buf;\r\ntransfer[1].len = len;\r\nspi_message_add_tail(&transfer[1], &message);\r\nmutex_lock(&flash->lock);\r\nspi_sync(flash->spi, &message);\r\nif (retlen && message.actual_length > sizeof(command))\r\n*retlen += message.actual_length - sizeof(command);\r\nmutex_unlock(&flash->lock);\r\nreturn 0;\r\n}\r\nstatic int mchp23k256_set_mode(struct spi_device *spi)\r\n{\r\nstruct spi_transfer transfer = {};\r\nstruct spi_message message;\r\nunsigned char command[2];\r\nspi_message_init(&message);\r\ncommand[0] = MCHP23K256_CMD_WRITE_STATUS;\r\ncommand[1] = MCHP23K256_MODE_SEQ;\r\ntransfer.tx_buf = command;\r\ntransfer.len = sizeof(command);\r\nspi_message_add_tail(&transfer, &message);\r\nreturn spi_sync(spi, &message);\r\n}\r\nstatic int mchp23k256_probe(struct spi_device *spi)\r\n{\r\nstruct mchp23k256_flash *flash;\r\nstruct flash_platform_data *data;\r\nint err;\r\nflash = devm_kzalloc(&spi->dev, sizeof(*flash), GFP_KERNEL);\r\nif (!flash)\r\nreturn -ENOMEM;\r\nflash->spi = spi;\r\nmutex_init(&flash->lock);\r\nspi_set_drvdata(spi, flash);\r\nerr = mchp23k256_set_mode(spi);\r\nif (err)\r\nreturn err;\r\ndata = dev_get_platdata(&spi->dev);\r\nflash->caps = of_device_get_match_data(&spi->dev);\r\nif (!flash->caps)\r\nflash->caps = &mchp23k256_caps;\r\nmtd_set_of_node(&flash->mtd, spi->dev.of_node);\r\nflash->mtd.dev.parent = &spi->dev;\r\nflash->mtd.type = MTD_RAM;\r\nflash->mtd.flags = MTD_CAP_RAM;\r\nflash->mtd.writesize = 1;\r\nflash->mtd.size = flash->caps->size;\r\nflash->mtd._read = mchp23k256_read;\r\nflash->mtd._write = mchp23k256_write;\r\nerr = mtd_device_register(&flash->mtd, data ? data->parts : NULL,\r\ndata ? data->nr_parts : 0);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int mchp23k256_remove(struct spi_device *spi)\r\n{\r\nstruct mchp23k256_flash *flash = spi_get_drvdata(spi);\r\nreturn mtd_device_unregister(&flash->mtd);\r\n}

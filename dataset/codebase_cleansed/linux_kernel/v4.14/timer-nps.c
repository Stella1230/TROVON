static int __init nps_get_timer_clk(struct device_node *node,\r\nunsigned long *timer_freq,\r\nstruct clk **clk)\r\n{\r\nint ret;\r\n*clk = of_clk_get(node, 0);\r\nret = PTR_ERR_OR_ZERO(*clk);\r\nif (ret) {\r\npr_err("timer missing clk\n");\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(*clk);\r\nif (ret) {\r\npr_err("Couldn't enable parent clk\n");\r\nclk_put(*clk);\r\nreturn ret;\r\n}\r\n*timer_freq = clk_get_rate(*clk);\r\nif (!(*timer_freq)) {\r\npr_err("Couldn't get clk rate\n");\r\nclk_disable_unprepare(*clk);\r\nclk_put(*clk);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic u64 nps_clksrc_read(struct clocksource *clksrc)\r\n{\r\nint cluster = raw_smp_processor_id() >> NPS_CLUSTER_OFFSET;\r\nreturn (u64)ioread32be(nps_msu_reg_low_addr[cluster]);\r\n}\r\nstatic int __init nps_setup_clocksource(struct device_node *node)\r\n{\r\nint ret, cluster;\r\nstruct clk *clk;\r\nunsigned long nps_timer1_freq;\r\nfor (cluster = 0; cluster < NPS_CLUSTER_NUM; cluster++)\r\nnps_msu_reg_low_addr[cluster] =\r\nnps_host_reg((cluster << NPS_CLUSTER_OFFSET),\r\nNPS_MSU_BLKID, NPS_MSU_TICK_LOW);\r\nret = nps_get_timer_clk(node, &nps_timer1_freq, &clk);\r\nif (ret)\r\nreturn ret;\r\nret = clocksource_mmio_init(nps_msu_reg_low_addr, "nps-tick",\r\nnps_timer1_freq, 300, 32, nps_clksrc_read);\r\nif (ret) {\r\npr_err("Couldn't register clock source.\n");\r\nclk_disable_unprepare(clk);\r\n}\r\nreturn ret;\r\n}\r\nstatic void nps_clkevent_rm_thread(void)\r\n{\r\nint thread;\r\nunsigned int cflags, enabled_threads;\r\nhw_schd_save(&cflags);\r\nenabled_threads = read_aux_reg(NPS_REG_TIMER0_TSI);\r\nthread = read_aux_reg(CTOP_AUX_THREAD_ID);\r\nenabled_threads &= ~(1 << thread);\r\nwrite_aux_reg(NPS_REG_TIMER0_TSI, enabled_threads);\r\nif (!enabled_threads)\r\nwrite_aux_reg(NPS_REG_TIMER0_CTRL, TIMER0_CTRL_NH);\r\nelse\r\nwrite_aux_reg(NPS_REG_TIMER0_CTRL,\r\nTIMER0_CTRL_IE | TIMER0_CTRL_NH);\r\nhw_schd_restore(cflags);\r\n}\r\nstatic void nps_clkevent_add_thread(unsigned long delta)\r\n{\r\nint thread;\r\nunsigned int cflags, enabled_threads;\r\nhw_schd_save(&cflags);\r\nthread = read_aux_reg(CTOP_AUX_THREAD_ID);\r\nenabled_threads = read_aux_reg(NPS_REG_TIMER0_TSI);\r\nenabled_threads |= (1 << thread);\r\nwrite_aux_reg(NPS_REG_TIMER0_TSI, enabled_threads);\r\nwrite_aux_reg(NPS_REG_TIMER0_LIMIT, delta);\r\nwrite_aux_reg(NPS_REG_TIMER0_CNT, 0);\r\nwrite_aux_reg(NPS_REG_TIMER0_CTRL,\r\nTIMER0_CTRL_IE | TIMER0_CTRL_NH);\r\nhw_schd_restore(cflags);\r\n}\r\nstatic int nps_clkevent_set_state(struct clock_event_device *dev)\r\n{\r\nnps_clkevent_rm_thread();\r\ndisable_percpu_irq(nps_timer0_irq);\r\nreturn 0;\r\n}\r\nstatic int nps_clkevent_set_next_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\nnps_clkevent_add_thread(delta);\r\nenable_percpu_irq(nps_timer0_irq, IRQ_TYPE_NONE);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t timer_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nnps_clkevent_rm_thread();\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int nps_timer_starting_cpu(unsigned int cpu)\r\n{\r\nstruct clock_event_device *evt = this_cpu_ptr(&nps_clockevent_device);\r\nevt->cpumask = cpumask_of(smp_processor_id());\r\nclockevents_config_and_register(evt, nps_timer0_freq, 0, ULONG_MAX);\r\nenable_percpu_irq(nps_timer0_irq, IRQ_TYPE_NONE);\r\nreturn 0;\r\n}\r\nstatic int nps_timer_dying_cpu(unsigned int cpu)\r\n{\r\ndisable_percpu_irq(nps_timer0_irq);\r\nreturn 0;\r\n}\r\nstatic int __init nps_setup_clockevent(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nint ret;\r\nnps_timer0_irq = irq_of_parse_and_map(node, 0);\r\nif (nps_timer0_irq <= 0) {\r\npr_err("clockevent: missing irq\n");\r\nreturn -EINVAL;\r\n}\r\nret = nps_get_timer_clk(node, &nps_timer0_freq, &clk);\r\nif (ret)\r\nreturn ret;\r\nret = request_percpu_irq(nps_timer0_irq, timer_irq_handler,\r\n"Timer0 (per-cpu-tick)",\r\n&nps_clockevent_device);\r\nif (ret) {\r\npr_err("Couldn't request irq\n");\r\nclk_disable_unprepare(clk);\r\nreturn ret;\r\n}\r\nret = cpuhp_setup_state(CPUHP_AP_ARC_TIMER_STARTING,\r\n"clockevents/nps:starting",\r\nnps_timer_starting_cpu,\r\nnps_timer_dying_cpu);\r\nif (ret) {\r\npr_err("Failed to setup hotplug state\n");\r\nclk_disable_unprepare(clk);\r\nfree_percpu_irq(nps_timer0_irq, &nps_clockevent_device);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

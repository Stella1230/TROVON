static void zip_static_init_zip_ops(struct zip_operation *zip_ops,\r\nint lzs_flag)\r\n{\r\nzip_ops->flush = ZIP_FLUSH_FINISH;\r\nzip_ops->speed = 1;\r\nif (!lzs_flag) {\r\nzip_ops->ccode = 0;\r\nzip_ops->lzs_flag = 0;\r\nzip_ops->format = ZLIB_FORMAT;\r\n} else {\r\nzip_ops->ccode = 3;\r\nzip_ops->lzs_flag = 1;\r\nzip_ops->format = LZS_FORMAT;\r\n}\r\nzip_ops->begin_file = 1;\r\nzip_ops->history_len = 0;\r\nzip_ops->end_file = 1;\r\nzip_ops->compcode = 0;\r\nzip_ops->csum = 1;\r\n}\r\nint zip_ctx_init(struct zip_kernel_ctx *zip_ctx, int lzs_flag)\r\n{\r\nstruct zip_operation *comp_ctx = &zip_ctx->zip_comp;\r\nstruct zip_operation *decomp_ctx = &zip_ctx->zip_decomp;\r\nzip_static_init_zip_ops(comp_ctx, lzs_flag);\r\nzip_static_init_zip_ops(decomp_ctx, lzs_flag);\r\ncomp_ctx->input = zip_data_buf_alloc(MAX_INPUT_BUFFER_SIZE);\r\nif (!comp_ctx->input)\r\nreturn -ENOMEM;\r\ncomp_ctx->output = zip_data_buf_alloc(MAX_OUTPUT_BUFFER_SIZE);\r\nif (!comp_ctx->output)\r\ngoto err_comp_input;\r\ndecomp_ctx->input = zip_data_buf_alloc(MAX_INPUT_BUFFER_SIZE);\r\nif (!decomp_ctx->input)\r\ngoto err_comp_output;\r\ndecomp_ctx->output = zip_data_buf_alloc(MAX_OUTPUT_BUFFER_SIZE);\r\nif (!decomp_ctx->output)\r\ngoto err_decomp_input;\r\nreturn 0;\r\nerr_decomp_input:\r\nzip_data_buf_free(decomp_ctx->input, MAX_INPUT_BUFFER_SIZE);\r\nerr_comp_output:\r\nzip_data_buf_free(comp_ctx->output, MAX_OUTPUT_BUFFER_SIZE);\r\nerr_comp_input:\r\nzip_data_buf_free(comp_ctx->input, MAX_INPUT_BUFFER_SIZE);\r\nreturn -ENOMEM;\r\n}\r\nvoid zip_ctx_exit(struct zip_kernel_ctx *zip_ctx)\r\n{\r\nstruct zip_operation *comp_ctx = &zip_ctx->zip_comp;\r\nstruct zip_operation *dec_ctx = &zip_ctx->zip_decomp;\r\nzip_data_buf_free(comp_ctx->input, MAX_INPUT_BUFFER_SIZE);\r\nzip_data_buf_free(comp_ctx->output, MAX_OUTPUT_BUFFER_SIZE);\r\nzip_data_buf_free(dec_ctx->input, MAX_INPUT_BUFFER_SIZE);\r\nzip_data_buf_free(dec_ctx->output, MAX_OUTPUT_BUFFER_SIZE);\r\n}\r\nint zip_compress(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen,\r\nstruct zip_kernel_ctx *zip_ctx)\r\n{\r\nstruct zip_operation *zip_ops = NULL;\r\nstruct zip_state zip_state;\r\nstruct zip_device *zip = NULL;\r\nint ret;\r\nif (!zip_ctx || !src || !dst || !dlen)\r\nreturn -ENOMEM;\r\nzip = zip_get_device(zip_get_node_id());\r\nif (!zip)\r\nreturn -ENODEV;\r\nmemset(&zip_state, 0, sizeof(struct zip_state));\r\nzip_ops = &zip_ctx->zip_comp;\r\nzip_ops->input_len = slen;\r\nzip_ops->output_len = *dlen;\r\nmemcpy(zip_ops->input, src, slen);\r\nret = zip_deflate(zip_ops, &zip_state, zip);\r\nif (!ret) {\r\n*dlen = zip_ops->output_len;\r\nmemcpy(dst, zip_ops->output, *dlen);\r\n}\r\nreturn ret;\r\n}\r\nint zip_decompress(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen,\r\nstruct zip_kernel_ctx *zip_ctx)\r\n{\r\nstruct zip_operation *zip_ops = NULL;\r\nstruct zip_state zip_state;\r\nstruct zip_device *zip = NULL;\r\nint ret;\r\nif (!zip_ctx || !src || !dst || !dlen)\r\nreturn -ENOMEM;\r\nzip = zip_get_device(zip_get_node_id());\r\nif (!zip)\r\nreturn -ENODEV;\r\nmemset(&zip_state, 0, sizeof(struct zip_state));\r\nzip_ops = &zip_ctx->zip_decomp;\r\nmemcpy(zip_ops->input, src, slen);\r\nif (zip_ops->ccode != 3)\r\nzip_ops->input[slen++] = 0;\r\nzip_ops->input_len = slen;\r\nzip_ops->output_len = *dlen;\r\nret = zip_inflate(zip_ops, &zip_state, zip);\r\nif (!ret) {\r\n*dlen = zip_ops->output_len;\r\nmemcpy(dst, zip_ops->output, *dlen);\r\n}\r\nreturn ret;\r\n}\r\nint zip_alloc_comp_ctx_deflate(struct crypto_tfm *tfm)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = crypto_tfm_ctx(tfm);\r\nret = zip_ctx_init(zip_ctx, 0);\r\nreturn ret;\r\n}\r\nint zip_alloc_comp_ctx_lzs(struct crypto_tfm *tfm)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = crypto_tfm_ctx(tfm);\r\nret = zip_ctx_init(zip_ctx, 1);\r\nreturn ret;\r\n}\r\nvoid zip_free_comp_ctx(struct crypto_tfm *tfm)\r\n{\r\nstruct zip_kernel_ctx *zip_ctx = crypto_tfm_ctx(tfm);\r\nzip_ctx_exit(zip_ctx);\r\n}\r\nint zip_comp_compress(struct crypto_tfm *tfm,\r\nconst u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = crypto_tfm_ctx(tfm);\r\nret = zip_compress(src, slen, dst, dlen, zip_ctx);\r\nreturn ret;\r\n}\r\nint zip_comp_decompress(struct crypto_tfm *tfm,\r\nconst u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = crypto_tfm_ctx(tfm);\r\nret = zip_decompress(src, slen, dst, dlen, zip_ctx);\r\nreturn ret;\r\n}\r\nvoid *zip_alloc_scomp_ctx_deflate(struct crypto_scomp *tfm)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx;\r\nzip_ctx = kzalloc(sizeof(*zip_ctx), GFP_KERNEL);\r\nif (!zip_ctx)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = zip_ctx_init(zip_ctx, 0);\r\nif (ret) {\r\nkzfree(zip_ctx);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn zip_ctx;\r\n}\r\nvoid *zip_alloc_scomp_ctx_lzs(struct crypto_scomp *tfm)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx;\r\nzip_ctx = kzalloc(sizeof(*zip_ctx), GFP_KERNEL);\r\nif (!zip_ctx)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = zip_ctx_init(zip_ctx, 1);\r\nif (ret) {\r\nkzfree(zip_ctx);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn zip_ctx;\r\n}\r\nvoid zip_free_scomp_ctx(struct crypto_scomp *tfm, void *ctx)\r\n{\r\nstruct zip_kernel_ctx *zip_ctx = ctx;\r\nzip_ctx_exit(zip_ctx);\r\nkzfree(zip_ctx);\r\n}\r\nint zip_scomp_compress(struct crypto_scomp *tfm,\r\nconst u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen, void *ctx)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = ctx;\r\nret = zip_compress(src, slen, dst, dlen, zip_ctx);\r\nreturn ret;\r\n}\r\nint zip_scomp_decompress(struct crypto_scomp *tfm,\r\nconst u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen, void *ctx)\r\n{\r\nint ret;\r\nstruct zip_kernel_ctx *zip_ctx = ctx;\r\nret = zip_decompress(src, slen, dst, dlen, zip_ctx);\r\nreturn ret;\r\n}

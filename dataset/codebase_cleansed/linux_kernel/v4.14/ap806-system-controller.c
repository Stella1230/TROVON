static char *ap806_unique_name(struct device *dev, struct device_node *np,\r\nchar *name)\r\n{\r\nconst __be32 *reg;\r\nu64 addr;\r\nreg = of_get_property(np, "reg", NULL);\r\naddr = of_translate_address(np, reg);\r\nreturn devm_kasprintf(dev, GFP_KERNEL, "%llx-%s",\r\n(unsigned long long)addr, name);\r\n}\r\nstatic int ap806_syscon_common_probe(struct platform_device *pdev,\r\nstruct device_node *syscon_node)\r\n{\r\nunsigned int freq_mode, cpuclk_freq;\r\nconst char *name, *fixedclk_name;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct regmap *regmap;\r\nu32 reg;\r\nint ret;\r\nregmap = syscon_node_to_regmap(syscon_node);\r\nif (IS_ERR(regmap)) {\r\ndev_err(dev, "cannot get regmap\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nret = regmap_read(regmap, AP806_SAR_REG, &reg);\r\nif (ret) {\r\ndev_err(dev, "cannot read from regmap\n");\r\nreturn ret;\r\n}\r\nfreq_mode = reg & AP806_SAR_CLKFREQ_MODE_MASK;\r\nswitch (freq_mode) {\r\ncase 0x0:\r\ncase 0x1:\r\ncpuclk_freq = 2000;\r\nbreak;\r\ncase 0x6:\r\ncase 0x7:\r\ncpuclk_freq = 1800;\r\nbreak;\r\ncase 0x4:\r\ncase 0xB:\r\ncase 0xD:\r\ncpuclk_freq = 1600;\r\nbreak;\r\ncase 0x1a:\r\ncpuclk_freq = 1400;\r\nbreak;\r\ncase 0x14:\r\ncase 0x17:\r\ncpuclk_freq = 1300;\r\nbreak;\r\ncase 0x19:\r\ncpuclk_freq = 1200;\r\nbreak;\r\ncase 0x13:\r\ncase 0x1d:\r\ncpuclk_freq = 1000;\r\nbreak;\r\ncase 0x1c:\r\ncpuclk_freq = 800;\r\nbreak;\r\ncase 0x1b:\r\ncpuclk_freq = 600;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid SAR value\n");\r\nreturn -EINVAL;\r\n}\r\ncpuclk_freq *= 1000 * 1000;\r\nname = ap806_unique_name(dev, syscon_node, "cpu-cluster-0");\r\nap806_clks[0] = clk_register_fixed_rate(dev, name, NULL,\r\n0, cpuclk_freq);\r\nif (IS_ERR(ap806_clks[0])) {\r\nret = PTR_ERR(ap806_clks[0]);\r\ngoto fail0;\r\n}\r\nname = ap806_unique_name(dev, syscon_node, "cpu-cluster-1");\r\nap806_clks[1] = clk_register_fixed_rate(dev, name, NULL, 0,\r\ncpuclk_freq);\r\nif (IS_ERR(ap806_clks[1])) {\r\nret = PTR_ERR(ap806_clks[1]);\r\ngoto fail1;\r\n}\r\nfixedclk_name = ap806_unique_name(dev, syscon_node, "fixed");\r\nap806_clks[2] = clk_register_fixed_rate(dev, fixedclk_name, NULL,\r\n0, 1200 * 1000 * 1000);\r\nif (IS_ERR(ap806_clks[2])) {\r\nret = PTR_ERR(ap806_clks[2]);\r\ngoto fail2;\r\n}\r\nname = ap806_unique_name(dev, syscon_node, "mss");\r\nap806_clks[3] = clk_register_fixed_factor(NULL, name, fixedclk_name,\r\n0, 1, 6);\r\nif (IS_ERR(ap806_clks[3])) {\r\nret = PTR_ERR(ap806_clks[3]);\r\ngoto fail3;\r\n}\r\nname = ap806_unique_name(dev, syscon_node, "sdio");\r\nap806_clks[4] = clk_register_fixed_factor(NULL, name,\r\nfixedclk_name,\r\n0, 1, 3);\r\nif (IS_ERR(ap806_clks[4])) {\r\nret = PTR_ERR(ap806_clks[4]);\r\ngoto fail4;\r\n}\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &ap806_clk_data);\r\nret = of_clk_add_provider(np, of_clk_src_onecell_get, &ap806_clk_data);\r\nif (ret)\r\ngoto fail_clk_add;\r\nreturn 0;\r\nfail_clk_add:\r\nclk_unregister_fixed_factor(ap806_clks[4]);\r\nfail4:\r\nclk_unregister_fixed_factor(ap806_clks[3]);\r\nfail3:\r\nclk_unregister_fixed_rate(ap806_clks[2]);\r\nfail2:\r\nclk_unregister_fixed_rate(ap806_clks[1]);\r\nfail1:\r\nclk_unregister_fixed_rate(ap806_clks[0]);\r\nfail0:\r\nreturn ret;\r\n}\r\nstatic int ap806_syscon_legacy_probe(struct platform_device *pdev)\r\n{\r\ndev_warn(&pdev->dev, FW_WARN "Using legacy device tree binding\n");\r\ndev_warn(&pdev->dev, FW_WARN "Update your device tree:\n");\r\ndev_warn(&pdev->dev, FW_WARN\r\n"This binding won't be supported in future kernel\n");\r\nreturn ap806_syscon_common_probe(pdev, pdev->dev.of_node);\r\n}\r\nstatic int ap806_clock_probe(struct platform_device *pdev)\r\n{\r\nreturn ap806_syscon_common_probe(pdev, pdev->dev.of_node->parent);\r\n}

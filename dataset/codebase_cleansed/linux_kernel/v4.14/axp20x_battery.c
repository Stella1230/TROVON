static int axp20x_battery_get_max_voltage(struct axp20x_batt_ps *axp20x_batt,\r\nint *val)\r\n{\r\nint ret, reg;\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_CHRG_CTRL1, &reg);\r\nif (ret)\r\nreturn ret;\r\nswitch (reg & AXP20X_CHRG_CTRL1_TGT_VOLT) {\r\ncase AXP20X_CHRG_CTRL1_TGT_4_1V:\r\n*val = 4100000;\r\nbreak;\r\ncase AXP20X_CHRG_CTRL1_TGT_4_15V:\r\n*val = 4150000;\r\nbreak;\r\ncase AXP20X_CHRG_CTRL1_TGT_4_2V:\r\n*val = 4200000;\r\nbreak;\r\ncase AXP20X_CHRG_CTRL1_TGT_4_36V:\r\n*val = 4360000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int axp22x_battery_get_max_voltage(struct axp20x_batt_ps *axp20x_batt,\r\nint *val)\r\n{\r\nint ret, reg;\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_CHRG_CTRL1, &reg);\r\nif (ret)\r\nreturn ret;\r\nswitch (reg & AXP20X_CHRG_CTRL1_TGT_VOLT) {\r\ncase AXP20X_CHRG_CTRL1_TGT_4_1V:\r\n*val = 4100000;\r\nbreak;\r\ncase AXP20X_CHRG_CTRL1_TGT_4_2V:\r\n*val = 4200000;\r\nbreak;\r\ncase AXP22X_CHRG_CTRL1_TGT_4_22V:\r\n*val = 4220000;\r\nbreak;\r\ncase AXP22X_CHRG_CTRL1_TGT_4_24V:\r\n*val = 4240000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void raw_to_constant_charge_current(struct axp20x_batt_ps *axp, int *val)\r\n{\r\nif (axp->axp_id == AXP209_ID)\r\n*val = *val * 100000 + 300000;\r\nelse\r\n*val = *val * 150000 + 300000;\r\n}\r\nstatic void constant_charge_current_to_raw(struct axp20x_batt_ps *axp, int *val)\r\n{\r\nif (axp->axp_id == AXP209_ID)\r\n*val = (*val - 300000) / 100000;\r\nelse\r\n*val = (*val - 300000) / 150000;\r\n}\r\nstatic int axp20x_get_constant_charge_current(struct axp20x_batt_ps *axp,\r\nint *val)\r\n{\r\nint ret;\r\nret = regmap_read(axp->regmap, AXP20X_CHRG_CTRL1, val);\r\nif (ret)\r\nreturn ret;\r\n*val &= AXP20X_CHRG_CTRL1_TGT_CURR;\r\nraw_to_constant_charge_current(axp, val);\r\nreturn 0;\r\n}\r\nstatic int axp20x_battery_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct axp20x_batt_ps *axp20x_batt = power_supply_get_drvdata(psy);\r\nstruct iio_channel *chan;\r\nint ret = 0, reg, val1;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_PWR_OP_MODE,\r\n&reg);\r\nif (ret)\r\nreturn ret;\r\nval->intval = !!(reg & AXP20X_PWR_OP_BATT_PRESENT);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_PWR_INPUT_STATUS,\r\n&reg);\r\nif (ret)\r\nreturn ret;\r\nif (reg & AXP20X_PWR_STATUS_BAT_CHARGING) {\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nreturn 0;\r\n}\r\nret = iio_read_channel_processed(axp20x_batt->batt_dischrg_i,\r\n&val1);\r\nif (ret)\r\nreturn ret;\r\nif (val1) {\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nreturn 0;\r\n}\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_FG_RES, &val1);\r\nif (ret)\r\nreturn ret;\r\nif ((val1 & AXP209_FG_PERCENT) == 100)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_PWR_OP_MODE,\r\n&val1);\r\nif (ret)\r\nreturn ret;\r\nif (val1 & AXP20X_PWR_OP_BATT_ACTIVATED) {\r\nval->intval = POWER_SUPPLY_HEALTH_DEAD;\r\nreturn 0;\r\n}\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\r\nret = axp20x_get_constant_charge_current(axp20x_batt,\r\n&val->intval);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\r\nval->intval = axp20x_batt->max_ccc;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_PWR_INPUT_STATUS,\r\n&reg);\r\nif (ret)\r\nreturn ret;\r\nif (reg & AXP20X_PWR_STATUS_BAT_CHARGING)\r\nchan = axp20x_batt->batt_chrg_i;\r\nelse\r\nchan = axp20x_batt->batt_dischrg_i;\r\nret = iio_read_channel_processed(chan, &val->intval);\r\nif (ret)\r\nreturn ret;\r\nval->intval *= 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_PWR_OP_MODE,\r\n&reg);\r\nif (ret)\r\nreturn ret;\r\nif (!(reg & AXP20X_PWR_OP_BATT_PRESENT)) {\r\nval->intval = 100;\r\nreturn 0;\r\n}\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_FG_RES, &reg);\r\nif (ret)\r\nreturn ret;\r\nif (axp20x_batt->axp_id == AXP221_ID &&\r\n!(reg & AXP22X_FG_VALID))\r\nreturn -EINVAL;\r\nval->intval = reg & AXP209_FG_PERCENT;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nif (axp20x_batt->axp_id == AXP209_ID)\r\nreturn axp20x_battery_get_max_voltage(axp20x_batt,\r\n&val->intval);\r\nreturn axp22x_battery_get_max_voltage(axp20x_batt,\r\n&val->intval);\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nret = regmap_read(axp20x_batt->regmap, AXP20X_V_OFF, &reg);\r\nif (ret)\r\nreturn ret;\r\nval->intval = 2600000 + 100000 * (reg & AXP20X_V_OFF_MASK);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = iio_read_channel_processed(axp20x_batt->batt_v,\r\n&val->intval);\r\nif (ret)\r\nreturn ret;\r\nval->intval *= 1000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int axp20x_battery_set_max_voltage(struct axp20x_batt_ps *axp20x_batt,\r\nint val)\r\n{\r\nswitch (val) {\r\ncase 4100000:\r\nval = AXP20X_CHRG_CTRL1_TGT_4_1V;\r\nbreak;\r\ncase 4150000:\r\nif (axp20x_batt->axp_id == AXP221_ID)\r\nreturn -EINVAL;\r\nval = AXP20X_CHRG_CTRL1_TGT_4_15V;\r\nbreak;\r\ncase 4200000:\r\nval = AXP20X_CHRG_CTRL1_TGT_4_2V;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn regmap_update_bits(axp20x_batt->regmap, AXP20X_CHRG_CTRL1,\r\nAXP20X_CHRG_CTRL1_TGT_VOLT, val);\r\n}\r\nstatic int axp20x_set_constant_charge_current(struct axp20x_batt_ps *axp_batt,\r\nint charge_current)\r\n{\r\nif (charge_current > axp_batt->max_ccc)\r\nreturn -EINVAL;\r\nconstant_charge_current_to_raw(axp_batt, &charge_current);\r\nif (charge_current > AXP20X_CHRG_CTRL1_TGT_CURR || charge_current < 0)\r\nreturn -EINVAL;\r\nreturn regmap_update_bits(axp_batt->regmap, AXP20X_CHRG_CTRL1,\r\nAXP20X_CHRG_CTRL1_TGT_CURR, charge_current);\r\n}\r\nstatic int axp20x_set_max_constant_charge_current(struct axp20x_batt_ps *axp,\r\nint charge_current)\r\n{\r\nbool lower_max = false;\r\nconstant_charge_current_to_raw(axp, &charge_current);\r\nif (charge_current > AXP20X_CHRG_CTRL1_TGT_CURR || charge_current < 0)\r\nreturn -EINVAL;\r\nraw_to_constant_charge_current(axp, &charge_current);\r\nif (charge_current > axp->max_ccc)\r\ndev_warn(axp->dev,\r\n"Setting max constant charge current higher than previously defined. Note that increasing the constant charge current may damage your battery.\n");\r\nelse\r\nlower_max = true;\r\naxp->max_ccc = charge_current;\r\nif (lower_max) {\r\nint current_cc;\r\naxp20x_get_constant_charge_current(axp, &current_cc);\r\nif (current_cc > charge_current)\r\naxp20x_set_constant_charge_current(axp, charge_current);\r\n}\r\nreturn 0;\r\n}\r\nstatic int axp20x_set_voltage_min_design(struct axp20x_batt_ps *axp_batt,\r\nint min_voltage)\r\n{\r\nint val1 = (min_voltage - 2600000) / 100000;\r\nif (val1 < 0 || val1 > AXP20X_V_OFF_MASK)\r\nreturn -EINVAL;\r\nreturn regmap_update_bits(axp_batt->regmap, AXP20X_V_OFF,\r\nAXP20X_V_OFF_MASK, val1);\r\n}\r\nstatic int axp20x_battery_set_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct axp20x_batt_ps *axp20x_batt = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nreturn axp20x_set_voltage_min_design(axp20x_batt, val->intval);\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nreturn axp20x_battery_set_max_voltage(axp20x_batt, val->intval);\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\r\nreturn axp20x_set_constant_charge_current(axp20x_batt,\r\nval->intval);\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\r\nreturn axp20x_set_max_constant_charge_current(axp20x_batt,\r\nval->intval);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int axp20x_battery_prop_writeable(struct power_supply *psy,\r\nenum power_supply_property psp)\r\n{\r\nreturn psp == POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN ||\r\npsp == POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN ||\r\npsp == POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT ||\r\npsp == POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX;\r\n}\r\nstatic int axp20x_power_probe(struct platform_device *pdev)\r\n{\r\nstruct axp20x_batt_ps *axp20x_batt;\r\nstruct power_supply_config psy_cfg = {};\r\nstruct power_supply_battery_info info;\r\nif (!of_device_is_available(pdev->dev.of_node))\r\nreturn -ENODEV;\r\naxp20x_batt = devm_kzalloc(&pdev->dev, sizeof(*axp20x_batt),\r\nGFP_KERNEL);\r\nif (!axp20x_batt)\r\nreturn -ENOMEM;\r\naxp20x_batt->dev = &pdev->dev;\r\naxp20x_batt->batt_v = devm_iio_channel_get(&pdev->dev, "batt_v");\r\nif (IS_ERR(axp20x_batt->batt_v)) {\r\nif (PTR_ERR(axp20x_batt->batt_v) == -ENODEV)\r\nreturn -EPROBE_DEFER;\r\nreturn PTR_ERR(axp20x_batt->batt_v);\r\n}\r\naxp20x_batt->batt_chrg_i = devm_iio_channel_get(&pdev->dev,\r\n"batt_chrg_i");\r\nif (IS_ERR(axp20x_batt->batt_chrg_i)) {\r\nif (PTR_ERR(axp20x_batt->batt_chrg_i) == -ENODEV)\r\nreturn -EPROBE_DEFER;\r\nreturn PTR_ERR(axp20x_batt->batt_chrg_i);\r\n}\r\naxp20x_batt->batt_dischrg_i = devm_iio_channel_get(&pdev->dev,\r\n"batt_dischrg_i");\r\nif (IS_ERR(axp20x_batt->batt_dischrg_i)) {\r\nif (PTR_ERR(axp20x_batt->batt_dischrg_i) == -ENODEV)\r\nreturn -EPROBE_DEFER;\r\nreturn PTR_ERR(axp20x_batt->batt_dischrg_i);\r\n}\r\naxp20x_batt->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nplatform_set_drvdata(pdev, axp20x_batt);\r\npsy_cfg.drv_data = axp20x_batt;\r\npsy_cfg.of_node = pdev->dev.of_node;\r\naxp20x_batt->axp_id = (uintptr_t)of_device_get_match_data(&pdev->dev);\r\naxp20x_batt->batt = devm_power_supply_register(&pdev->dev,\r\n&axp20x_batt_ps_desc,\r\n&psy_cfg);\r\nif (IS_ERR(axp20x_batt->batt)) {\r\ndev_err(&pdev->dev, "failed to register power supply: %ld\n",\r\nPTR_ERR(axp20x_batt->batt));\r\nreturn PTR_ERR(axp20x_batt->batt);\r\n}\r\nif (!power_supply_get_battery_info(axp20x_batt->batt, &info)) {\r\nint vmin = info.voltage_min_design_uv;\r\nint ccc = info.constant_charge_current_max_ua;\r\nif (vmin > 0 && axp20x_set_voltage_min_design(axp20x_batt,\r\nvmin))\r\ndev_err(&pdev->dev,\r\n"couldn't set voltage_min_design\n");\r\naxp20x_batt->max_ccc = ccc;\r\nif (ccc <= 0 || axp20x_set_constant_charge_current(axp20x_batt,\r\nccc)) {\r\ndev_err(&pdev->dev,\r\n"couldn't set constant charge current from DT: fallback to minimum value\n");\r\nccc = 300000;\r\naxp20x_batt->max_ccc = ccc;\r\naxp20x_set_constant_charge_current(axp20x_batt, ccc);\r\n}\r\n}\r\naxp20x_get_constant_charge_current(axp20x_batt,\r\n&axp20x_batt->max_ccc);\r\nreturn 0;\r\n}

void vr41xx_supply_clock(vr41xx_clock_t clock)\r\n{\r\nspin_lock_irq(&cmu_lock);\r\nswitch (clock) {\r\ncase PIU_CLOCK:\r\ncmuclkmsk |= MSKPIU;\r\nbreak;\r\ncase SIU_CLOCK:\r\ncmuclkmsk |= MSKSIU | MSKSSIU;\r\nbreak;\r\ncase AIU_CLOCK:\r\ncmuclkmsk |= MSKAIU;\r\nbreak;\r\ncase KIU_CLOCK:\r\ncmuclkmsk |= MSKKIU;\r\nbreak;\r\ncase FIR_CLOCK:\r\ncmuclkmsk |= MSKFIR | MSKFFIR;\r\nbreak;\r\ncase DSIU_CLOCK:\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121)\r\ncmuclkmsk |= MSKDSIU;\r\nelse\r\ncmuclkmsk |= MSKSIU | MSKDSIU;\r\nbreak;\r\ncase CSI_CLOCK:\r\ncmuclkmsk |= MSKCSI | MSKSCSI;\r\nbreak;\r\ncase PCIU_CLOCK:\r\ncmuclkmsk |= MSKPCIU;\r\nbreak;\r\ncase HSP_CLOCK:\r\ncmuclkmsk |= MSKSHSP;\r\nbreak;\r\ncase PCI_CLOCK:\r\ncmuclkmsk |= MSKPPCIU;\r\nbreak;\r\ncase CEU_CLOCK:\r\ncmuclkmsk2 |= MSKCEU;\r\nbreak;\r\ncase ETHER0_CLOCK:\r\ncmuclkmsk2 |= MSKMAC0;\r\nbreak;\r\ncase ETHER1_CLOCK:\r\ncmuclkmsk2 |= MSKMAC1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (clock == CEU_CLOCK || clock == ETHER0_CLOCK ||\r\nclock == ETHER1_CLOCK)\r\ncmu_write(CMUCLKMSK2, cmuclkmsk2);\r\nelse\r\ncmu_write(CMUCLKMSK, cmuclkmsk);\r\nspin_unlock_irq(&cmu_lock);\r\n}\r\nvoid vr41xx_mask_clock(vr41xx_clock_t clock)\r\n{\r\nspin_lock_irq(&cmu_lock);\r\nswitch (clock) {\r\ncase PIU_CLOCK:\r\ncmuclkmsk &= ~MSKPIU;\r\nbreak;\r\ncase SIU_CLOCK:\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\ncmuclkmsk &= ~(MSKSIU | MSKSSIU);\r\n} else {\r\nif (cmuclkmsk & MSKDSIU)\r\ncmuclkmsk &= ~MSKSSIU;\r\nelse\r\ncmuclkmsk &= ~(MSKSIU | MSKSSIU);\r\n}\r\nbreak;\r\ncase AIU_CLOCK:\r\ncmuclkmsk &= ~MSKAIU;\r\nbreak;\r\ncase KIU_CLOCK:\r\ncmuclkmsk &= ~MSKKIU;\r\nbreak;\r\ncase FIR_CLOCK:\r\ncmuclkmsk &= ~(MSKFIR | MSKFFIR);\r\nbreak;\r\ncase DSIU_CLOCK:\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\ncmuclkmsk &= ~MSKDSIU;\r\n} else {\r\nif (cmuclkmsk & MSKSSIU)\r\ncmuclkmsk &= ~MSKDSIU;\r\nelse\r\ncmuclkmsk &= ~(MSKSIU | MSKDSIU);\r\n}\r\nbreak;\r\ncase CSI_CLOCK:\r\ncmuclkmsk &= ~(MSKCSI | MSKSCSI);\r\nbreak;\r\ncase PCIU_CLOCK:\r\ncmuclkmsk &= ~MSKPCIU;\r\nbreak;\r\ncase HSP_CLOCK:\r\ncmuclkmsk &= ~MSKSHSP;\r\nbreak;\r\ncase PCI_CLOCK:\r\ncmuclkmsk &= ~MSKPPCIU;\r\nbreak;\r\ncase CEU_CLOCK:\r\ncmuclkmsk2 &= ~MSKCEU;\r\nbreak;\r\ncase ETHER0_CLOCK:\r\ncmuclkmsk2 &= ~MSKMAC0;\r\nbreak;\r\ncase ETHER1_CLOCK:\r\ncmuclkmsk2 &= ~MSKMAC1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (clock == CEU_CLOCK || clock == ETHER0_CLOCK ||\r\nclock == ETHER1_CLOCK)\r\ncmu_write(CMUCLKMSK2, cmuclkmsk2);\r\nelse\r\ncmu_write(CMUCLKMSK, cmuclkmsk);\r\nspin_unlock_irq(&cmu_lock);\r\n}\r\nstatic int __init vr41xx_cmu_init(void)\r\n{\r\nunsigned long start, size;\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\ncase CPU_VR4121:\r\nstart = CMU_TYPE1_BASE;\r\nsize = CMU_TYPE1_SIZE;\r\nbreak;\r\ncase CPU_VR4122:\r\ncase CPU_VR4131:\r\nstart = CMU_TYPE2_BASE;\r\nsize = CMU_TYPE2_SIZE;\r\nbreak;\r\ncase CPU_VR4133:\r\nstart = CMU_TYPE3_BASE;\r\nsize = CMU_TYPE3_SIZE;\r\nbreak;\r\ndefault:\r\npanic("Unexpected CPU of NEC VR4100 series");\r\nbreak;\r\n}\r\nif (request_mem_region(start, size, "CMU") == NULL)\r\nreturn -EBUSY;\r\ncmu_base = ioremap(start, size);\r\nif (cmu_base == NULL) {\r\nrelease_mem_region(start, size);\r\nreturn -EBUSY;\r\n}\r\ncmuclkmsk = cmu_read(CMUCLKMSK);\r\nif (current_cpu_type() == CPU_VR4133)\r\ncmuclkmsk2 = cmu_read(CMUCLKMSK2);\r\nspin_lock_init(&cmu_lock);\r\nreturn 0;\r\n}

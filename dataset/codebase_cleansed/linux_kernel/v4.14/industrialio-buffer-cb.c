static struct iio_cb_buffer *buffer_to_cb_buffer(struct iio_buffer *buffer)\r\n{\r\nreturn container_of(buffer, struct iio_cb_buffer, buffer);\r\n}\r\nstatic int iio_buffer_cb_store_to(struct iio_buffer *buffer, const void *data)\r\n{\r\nstruct iio_cb_buffer *cb_buff = buffer_to_cb_buffer(buffer);\r\nreturn cb_buff->cb(data, cb_buff->private);\r\n}\r\nstatic void iio_buffer_cb_release(struct iio_buffer *buffer)\r\n{\r\nstruct iio_cb_buffer *cb_buff = buffer_to_cb_buffer(buffer);\r\nkfree(cb_buff->buffer.scan_mask);\r\nkfree(cb_buff);\r\n}\r\nstruct iio_cb_buffer *iio_channel_get_all_cb(struct device *dev,\r\nint (*cb)(const void *data,\r\nvoid *private),\r\nvoid *private)\r\n{\r\nint ret;\r\nstruct iio_cb_buffer *cb_buff;\r\nstruct iio_channel *chan;\r\ncb_buff = kzalloc(sizeof(*cb_buff), GFP_KERNEL);\r\nif (cb_buff == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\niio_buffer_init(&cb_buff->buffer);\r\ncb_buff->private = private;\r\ncb_buff->cb = cb;\r\ncb_buff->buffer.access = &iio_cb_access;\r\nINIT_LIST_HEAD(&cb_buff->buffer.demux_list);\r\ncb_buff->channels = iio_channel_get_all(dev);\r\nif (IS_ERR(cb_buff->channels)) {\r\nret = PTR_ERR(cb_buff->channels);\r\ngoto error_free_cb_buff;\r\n}\r\ncb_buff->indio_dev = cb_buff->channels[0].indio_dev;\r\ncb_buff->buffer.scan_mask\r\n= kcalloc(BITS_TO_LONGS(cb_buff->indio_dev->masklength),\r\nsizeof(long), GFP_KERNEL);\r\nif (cb_buff->buffer.scan_mask == NULL) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\nchan = &cb_buff->channels[0];\r\nwhile (chan->indio_dev) {\r\nif (chan->indio_dev != cb_buff->indio_dev) {\r\nret = -EINVAL;\r\ngoto error_free_scan_mask;\r\n}\r\nset_bit(chan->channel->scan_index,\r\ncb_buff->buffer.scan_mask);\r\nchan++;\r\n}\r\nreturn cb_buff;\r\nerror_free_scan_mask:\r\nkfree(cb_buff->buffer.scan_mask);\r\nerror_release_channels:\r\niio_channel_release_all(cb_buff->channels);\r\nerror_free_cb_buff:\r\nkfree(cb_buff);\r\nreturn ERR_PTR(ret);\r\n}\r\nint iio_channel_start_all_cb(struct iio_cb_buffer *cb_buff)\r\n{\r\nreturn iio_update_buffers(cb_buff->indio_dev, &cb_buff->buffer,\r\nNULL);\r\n}\r\nvoid iio_channel_stop_all_cb(struct iio_cb_buffer *cb_buff)\r\n{\r\niio_update_buffers(cb_buff->indio_dev, NULL, &cb_buff->buffer);\r\n}\r\nvoid iio_channel_release_all_cb(struct iio_cb_buffer *cb_buff)\r\n{\r\niio_channel_release_all(cb_buff->channels);\r\niio_buffer_put(&cb_buff->buffer);\r\n}\r\nstruct iio_channel\r\n*iio_channel_cb_get_channels(const struct iio_cb_buffer *cb_buffer)\r\n{\r\nreturn cb_buffer->channels;\r\n}\r\nstruct iio_dev\r\n*iio_channel_cb_get_iio_dev(const struct iio_cb_buffer *cb_buffer)\r\n{\r\nreturn cb_buffer->indio_dev;\r\n}

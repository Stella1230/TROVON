static void brcms_c_stf_stbc_rx_ht_update(struct brcms_c_info *wlc, int val)\r\n{\r\nif (BRCMS_STF_SS_STBC_RX(wlc)) {\r\nif ((wlc->stf->rxstreams == 1) && (val != HT_CAP_RX_STBC_NO))\r\nreturn;\r\n}\r\nif (wlc->pub->up) {\r\nbrcms_c_update_beacon(wlc);\r\nbrcms_c_update_probe_resp(wlc, true);\r\n}\r\n}\r\nvoid brcms_c_tempsense_upd(struct brcms_c_info *wlc)\r\n{\r\nstruct brcms_phy_pub *pi = wlc->band->pi;\r\nuint active_chains, txchain;\r\nactive_chains = wlc_phy_stf_chain_active_get(pi);\r\ntxchain = active_chains & 0xf;\r\nif (wlc->stf->txchain == wlc->stf->hw_txchain) {\r\nif (txchain && (txchain < wlc->stf->hw_txchain))\r\nbrcms_c_stf_txchain_set(wlc, txchain, true);\r\n} else if (wlc->stf->txchain < wlc->stf->hw_txchain) {\r\nif (txchain == wlc->stf->hw_txchain)\r\nbrcms_c_stf_txchain_set(wlc, txchain, true);\r\n}\r\n}\r\nvoid\r\nbrcms_c_stf_ss_algo_channel_get(struct brcms_c_info *wlc, u16 *ss_algo_channel,\r\nu16 chanspec)\r\n{\r\nstruct tx_power power = { };\r\nu8 siso_mcs_id, cdd_mcs_id, stbc_mcs_id;\r\n*ss_algo_channel = 0;\r\nif (!wlc->pub->up) {\r\n*ss_algo_channel = (u16) -1;\r\nreturn;\r\n}\r\nwlc_phy_txpower_get_current(wlc->band->pi, &power,\r\nCHSPEC_CHANNEL(chanspec));\r\nsiso_mcs_id = (CHSPEC_IS40(chanspec)) ?\r\nWL_TX_POWER_MCS40_SISO_FIRST : WL_TX_POWER_MCS20_SISO_FIRST;\r\ncdd_mcs_id = (CHSPEC_IS40(chanspec)) ?\r\nWL_TX_POWER_MCS40_CDD_FIRST : WL_TX_POWER_MCS20_CDD_FIRST;\r\nstbc_mcs_id = (CHSPEC_IS40(chanspec)) ?\r\nWL_TX_POWER_MCS40_STBC_FIRST : WL_TX_POWER_MCS20_STBC_FIRST;\r\nif (power.target[siso_mcs_id] > (power.target[cdd_mcs_id] + 12))\r\nsetbit(ss_algo_channel, PHY_TXC1_MODE_SISO);\r\nelse\r\nsetbit(ss_algo_channel, PHY_TXC1_MODE_CDD);\r\nif (power.target[siso_mcs_id] <= (power.target[stbc_mcs_id] + 12))\r\nsetbit(ss_algo_channel, PHY_TXC1_MODE_STBC);\r\n}\r\nstatic bool brcms_c_stf_stbc_tx_set(struct brcms_c_info *wlc, s32 int_val)\r\n{\r\nif ((int_val != AUTO) && (int_val != OFF) && (int_val != ON))\r\nreturn false;\r\nif ((int_val == ON) && (wlc->stf->txstreams == 1))\r\nreturn false;\r\nwlc->bandstate[BAND_2G_INDEX]->band_stf_stbc_tx = (s8) int_val;\r\nwlc->bandstate[BAND_5G_INDEX]->band_stf_stbc_tx = (s8) int_val;\r\nreturn true;\r\n}\r\nbool brcms_c_stf_stbc_rx_set(struct brcms_c_info *wlc, s32 int_val)\r\n{\r\nif ((int_val != HT_CAP_RX_STBC_NO)\r\n&& (int_val != HT_CAP_RX_STBC_ONE_STREAM))\r\nreturn false;\r\nif (BRCMS_STF_SS_STBC_RX(wlc)) {\r\nif ((int_val != HT_CAP_RX_STBC_NO)\r\n&& (wlc->stf->rxstreams == 1))\r\nreturn false;\r\n}\r\nbrcms_c_stf_stbc_rx_ht_update(wlc, int_val);\r\nreturn true;\r\n}\r\nstatic int brcms_c_stf_txcore_set(struct brcms_c_info *wlc, u8 Nsts,\r\nu8 core_mask)\r\n{\r\nbrcms_dbg_ht(wlc->hw->d11core, "wl%d: Nsts %d core_mask %x\n",\r\nwlc->pub->unit, Nsts, core_mask);\r\nif (hweight8(core_mask) > wlc->stf->txstreams)\r\ncore_mask = 0;\r\nif ((hweight8(core_mask) == wlc->stf->txstreams) &&\r\n((core_mask & ~wlc->stf->txchain)\r\n|| !(core_mask & wlc->stf->txchain)))\r\ncore_mask = wlc->stf->txchain;\r\nwlc->stf->txcore[Nsts] = core_mask;\r\nif (Nsts == 1) {\r\nwlc->stf->phytxant = core_mask << PHY_TXC_ANT_SHIFT;\r\nbrcms_b_txant_set(wlc->hw, wlc->stf->phytxant);\r\nif (wlc->clk) {\r\nbrcms_c_suspend_mac_and_wait(wlc);\r\nbrcms_c_beacon_phytxctl_txant_upd(wlc, wlc->bcn_rspec);\r\nbrcms_c_enable_mac(wlc);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int brcms_c_stf_spatial_policy_set(struct brcms_c_info *wlc, int val)\r\n{\r\nint i;\r\nu8 core_mask = 0;\r\nbrcms_dbg_ht(wlc->hw->d11core, "wl%d: val %x\n", wlc->pub->unit,\r\nval);\r\nwlc->stf->spatial_policy = (s8) val;\r\nfor (i = 1; i <= MAX_STREAMS_SUPPORTED; i++) {\r\ncore_mask = (val == MAX_SPATIAL_EXPANSION) ?\r\nwlc->stf->txchain : txcore_default[i];\r\nbrcms_c_stf_txcore_set(wlc, (u8) i, core_mask);\r\n}\r\nreturn 0;\r\n}\r\nstatic void _brcms_c_stf_phy_txant_upd(struct brcms_c_info *wlc)\r\n{\r\ns8 txant;\r\ntxant = (s8) wlc->stf->txant;\r\nif (BRCMS_PHY_11N_CAP(wlc->band)) {\r\nif (txant == ANT_TX_FORCE_0) {\r\nwlc->stf->phytxant = PHY_TXC_ANT_0;\r\n} else if (txant == ANT_TX_FORCE_1) {\r\nwlc->stf->phytxant = PHY_TXC_ANT_1;\r\nif (BRCMS_ISNPHY(wlc->band) &&\r\nNREV_GE(wlc->band->phyrev, 3)\r\n&& NREV_LT(wlc->band->phyrev, 7))\r\nwlc->stf->phytxant = PHY_TXC_ANT_2;\r\n} else {\r\nif (BRCMS_ISLCNPHY(wlc->band) ||\r\nBRCMS_ISSSLPNPHY(wlc->band))\r\nwlc->stf->phytxant = PHY_TXC_LCNPHY_ANT_LAST;\r\nelse {\r\nWARN_ON(wlc->stf->txchain <= 0);\r\nwlc->stf->phytxant =\r\nwlc->stf->txchain << PHY_TXC_ANT_SHIFT;\r\n}\r\n}\r\n} else {\r\nif (txant == ANT_TX_FORCE_0)\r\nwlc->stf->phytxant = PHY_TXC_OLD_ANT_0;\r\nelse if (txant == ANT_TX_FORCE_1)\r\nwlc->stf->phytxant = PHY_TXC_OLD_ANT_1;\r\nelse\r\nwlc->stf->phytxant = PHY_TXC_OLD_ANT_LAST;\r\n}\r\nbrcms_b_txant_set(wlc->hw, wlc->stf->phytxant);\r\n}\r\nint brcms_c_stf_txchain_set(struct brcms_c_info *wlc, s32 int_val, bool force)\r\n{\r\nu8 txchain = (u8) int_val;\r\nu8 txstreams;\r\nuint i;\r\nif (wlc->stf->txchain == txchain)\r\nreturn 0;\r\nif ((txchain & ~wlc->stf->hw_txchain)\r\n|| !(txchain & wlc->stf->hw_txchain))\r\nreturn -EINVAL;\r\ntxstreams = (u8) hweight8(txchain);\r\nif (txstreams > MAX_STREAMS_SUPPORTED)\r\nreturn -EINVAL;\r\nwlc->stf->txchain = txchain;\r\nwlc->stf->txstreams = txstreams;\r\nbrcms_c_stf_stbc_tx_set(wlc, wlc->band->band_stf_stbc_tx);\r\nbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_2G_INDEX]);\r\nbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_5G_INDEX]);\r\nwlc->stf->txant =\r\n(wlc->stf->txstreams == 1) ? ANT_TX_FORCE_0 : ANT_TX_DEF;\r\n_brcms_c_stf_phy_txant_upd(wlc);\r\nwlc_phy_stf_chain_set(wlc->band->pi, wlc->stf->txchain,\r\nwlc->stf->rxchain);\r\nfor (i = 1; i <= MAX_STREAMS_SUPPORTED; i++)\r\nbrcms_c_stf_txcore_set(wlc, (u8) i, txcore_default[i]);\r\nreturn 0;\r\n}\r\nint brcms_c_stf_ss_update(struct brcms_c_info *wlc, struct brcms_band *band)\r\n{\r\nint ret_code = 0;\r\nu8 prev_stf_ss;\r\nu8 upd_stf_ss;\r\nprev_stf_ss = wlc->stf->ss_opmode;\r\nif (BRCMS_STBC_CAP_PHY(wlc) &&\r\nwlc->stf->ss_algosel_auto\r\n&& (wlc->stf->ss_algo_channel != (u16) -1)) {\r\nupd_stf_ss = (wlc->stf->txstreams == 1 ||\r\nisset(&wlc->stf->ss_algo_channel,\r\nPHY_TXC1_MODE_SISO)) ?\r\nPHY_TXC1_MODE_SISO : PHY_TXC1_MODE_CDD;\r\n} else {\r\nif (wlc->band != band)\r\nreturn ret_code;\r\nupd_stf_ss = (wlc->stf->txstreams == 1) ?\r\nPHY_TXC1_MODE_SISO : band->band_stf_ss_mode;\r\n}\r\nif (prev_stf_ss != upd_stf_ss) {\r\nwlc->stf->ss_opmode = upd_stf_ss;\r\nbrcms_b_band_stf_ss_set(wlc->hw, upd_stf_ss);\r\n}\r\nreturn ret_code;\r\n}\r\nint brcms_c_stf_attach(struct brcms_c_info *wlc)\r\n{\r\nwlc->bandstate[BAND_2G_INDEX]->band_stf_ss_mode = PHY_TXC1_MODE_SISO;\r\nwlc->bandstate[BAND_5G_INDEX]->band_stf_ss_mode = PHY_TXC1_MODE_CDD;\r\nif (BRCMS_ISNPHY(wlc->band) &&\r\n(wlc_phy_txpower_hw_ctrl_get(wlc->band->pi) != PHY_TPC_HW_ON))\r\nwlc->bandstate[BAND_2G_INDEX]->band_stf_ss_mode =\r\nPHY_TXC1_MODE_CDD;\r\nbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_2G_INDEX]);\r\nbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_5G_INDEX]);\r\nbrcms_c_stf_stbc_rx_ht_update(wlc, HT_CAP_RX_STBC_NO);\r\nwlc->bandstate[BAND_2G_INDEX]->band_stf_stbc_tx = OFF;\r\nwlc->bandstate[BAND_5G_INDEX]->band_stf_stbc_tx = OFF;\r\nif (BRCMS_STBC_CAP_PHY(wlc)) {\r\nwlc->stf->ss_algosel_auto = true;\r\nwlc->stf->ss_algo_channel = (u16) -1;\r\n}\r\nreturn 0;\r\n}\r\nvoid brcms_c_stf_detach(struct brcms_c_info *wlc)\r\n{\r\n}\r\nvoid brcms_c_stf_phy_txant_upd(struct brcms_c_info *wlc)\r\n{\r\n_brcms_c_stf_phy_txant_upd(wlc);\r\n}\r\nvoid brcms_c_stf_phy_chain_calc(struct brcms_c_info *wlc)\r\n{\r\nstruct ssb_sprom *sprom = &wlc->hw->d11core->bus->sprom;\r\nwlc->stf->hw_txchain = sprom->txchain;\r\nwlc->stf->hw_rxchain = sprom->rxchain;\r\nif (wlc->stf->hw_txchain == 0 || wlc->stf->hw_txchain == 0xf) {\r\nif (BRCMS_ISNPHY(wlc->band))\r\nwlc->stf->hw_txchain = TXCHAIN_DEF_NPHY;\r\nelse\r\nwlc->stf->hw_txchain = TXCHAIN_DEF;\r\n}\r\nwlc->stf->txchain = wlc->stf->hw_txchain;\r\nwlc->stf->txstreams = (u8) hweight8(wlc->stf->hw_txchain);\r\nif (wlc->stf->hw_rxchain == 0 || wlc->stf->hw_rxchain == 0xf) {\r\nif (BRCMS_ISNPHY(wlc->band))\r\nwlc->stf->hw_rxchain = RXCHAIN_DEF_NPHY;\r\nelse\r\nwlc->stf->hw_rxchain = RXCHAIN_DEF;\r\n}\r\nwlc->stf->rxchain = wlc->stf->hw_rxchain;\r\nwlc->stf->rxstreams = (u8) hweight8(wlc->stf->hw_rxchain);\r\nmemcpy(wlc->stf->txcore, txcore_default, sizeof(wlc->stf->txcore));\r\nwlc->stf->spatial_policy = MIN_SPATIAL_EXPANSION;\r\nbrcms_c_stf_spatial_policy_set(wlc, MIN_SPATIAL_EXPANSION);\r\n}\r\nstatic u16 _brcms_c_stf_phytxchain_sel(struct brcms_c_info *wlc,\r\nu32 rspec)\r\n{\r\nu16 phytxant = wlc->stf->phytxant;\r\nif (rspec_stf(rspec) != PHY_TXC1_MODE_SISO)\r\nphytxant = wlc->stf->txchain << PHY_TXC_ANT_SHIFT;\r\nelse if (wlc->stf->txant == ANT_TX_DEF)\r\nphytxant = wlc->stf->txchain << PHY_TXC_ANT_SHIFT;\r\nphytxant &= PHY_TXC_ANT_MASK;\r\nreturn phytxant;\r\n}\r\nu16 brcms_c_stf_phytxchain_sel(struct brcms_c_info *wlc, u32 rspec)\r\n{\r\nreturn _brcms_c_stf_phytxchain_sel(wlc, rspec);\r\n}\r\nu16 brcms_c_stf_d11hdrs_phyctl_txant(struct brcms_c_info *wlc, u32 rspec)\r\n{\r\nu16 phytxant = wlc->stf->phytxant;\r\nu16 mask = PHY_TXC_ANT_MASK;\r\nif (BRCMS_ISNPHY(wlc->band)) {\r\nphytxant = _brcms_c_stf_phytxchain_sel(wlc, rspec);\r\nmask = PHY_TXC_HTANT_MASK;\r\n}\r\nphytxant |= phytxant & mask;\r\nreturn phytxant;\r\n}

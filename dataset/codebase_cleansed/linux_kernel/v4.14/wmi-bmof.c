static ssize_t\r\nread_bmof(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct bmof_priv *priv =\r\ncontainer_of(attr, struct bmof_priv, bmof_bin_attr);\r\nif (off < 0)\r\nreturn -EINVAL;\r\nif (off >= priv->bmofdata->buffer.length)\r\nreturn 0;\r\nif (count > priv->bmofdata->buffer.length - off)\r\ncount = priv->bmofdata->buffer.length - off;\r\nmemcpy(buf, priv->bmofdata->buffer.pointer + off, count);\r\nreturn count;\r\n}\r\nstatic int wmi_bmof_probe(struct wmi_device *wdev)\r\n{\r\nstruct bmof_priv *priv;\r\nint ret;\r\npriv = devm_kzalloc(&wdev->dev, sizeof(struct bmof_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&wdev->dev, priv);\r\npriv->bmofdata = wmidev_block_query(wdev, 0);\r\nif (!priv->bmofdata) {\r\ndev_err(&wdev->dev, "failed to read Binary MOF\n");\r\nreturn -EIO;\r\n}\r\nif (priv->bmofdata->type != ACPI_TYPE_BUFFER) {\r\ndev_err(&wdev->dev, "Binary MOF is not a buffer\n");\r\nret = -EIO;\r\ngoto err_free;\r\n}\r\nsysfs_bin_attr_init(&priv->bmof_bin_attr);\r\npriv->bmof_bin_attr.attr.name = "bmof";\r\npriv->bmof_bin_attr.attr.mode = 0400;\r\npriv->bmof_bin_attr.read = read_bmof;\r\npriv->bmof_bin_attr.size = priv->bmofdata->buffer.length;\r\nret = sysfs_create_bin_file(&wdev->dev.kobj, &priv->bmof_bin_attr);\r\nif (ret)\r\ngoto err_free;\r\nreturn 0;\r\nerr_free:\r\nkfree(priv->bmofdata);\r\nreturn ret;\r\n}\r\nstatic int wmi_bmof_remove(struct wmi_device *wdev)\r\n{\r\nstruct bmof_priv *priv = dev_get_drvdata(&wdev->dev);\r\nsysfs_remove_bin_file(&wdev->dev.kobj, &priv->bmof_bin_attr);\r\nkfree(priv->bmofdata);\r\nreturn 0;\r\n}

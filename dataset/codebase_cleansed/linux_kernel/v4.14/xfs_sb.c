struct xfs_perag *\r\nxfs_perag_get(\r\nstruct xfs_mount *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\nint ref = 0;\r\nrcu_read_lock();\r\npag = radix_tree_lookup(&mp->m_perag_tree, agno);\r\nif (pag) {\r\nASSERT(atomic_read(&pag->pag_ref) >= 0);\r\nref = atomic_inc_return(&pag->pag_ref);\r\n}\r\nrcu_read_unlock();\r\ntrace_xfs_perag_get(mp, agno, ref, _RET_IP_);\r\nreturn pag;\r\n}\r\nstruct xfs_perag *\r\nxfs_perag_get_tag(\r\nstruct xfs_mount *mp,\r\nxfs_agnumber_t first,\r\nint tag)\r\n{\r\nstruct xfs_perag *pag;\r\nint found;\r\nint ref;\r\nrcu_read_lock();\r\nfound = radix_tree_gang_lookup_tag(&mp->m_perag_tree,\r\n(void **)&pag, first, 1, tag);\r\nif (found <= 0) {\r\nrcu_read_unlock();\r\nreturn NULL;\r\n}\r\nref = atomic_inc_return(&pag->pag_ref);\r\nrcu_read_unlock();\r\ntrace_xfs_perag_get_tag(mp, pag->pag_agno, ref, _RET_IP_);\r\nreturn pag;\r\n}\r\nvoid\r\nxfs_perag_put(\r\nstruct xfs_perag *pag)\r\n{\r\nint ref;\r\nASSERT(atomic_read(&pag->pag_ref) > 0);\r\nref = atomic_dec_return(&pag->pag_ref);\r\ntrace_xfs_perag_put(pag->pag_mount, pag->pag_agno, ref, _RET_IP_);\r\n}\r\nSTATIC int\r\nxfs_mount_validate_sb(\r\nxfs_mount_t *mp,\r\nxfs_sb_t *sbp,\r\nbool check_inprogress,\r\nbool check_version)\r\n{\r\nif (sbp->sb_magicnum != XFS_SB_MAGIC) {\r\nxfs_warn(mp, "bad magic number");\r\nreturn -EWRONGFS;\r\n}\r\nif (!xfs_sb_good_version(sbp)) {\r\nxfs_warn(mp, "bad version");\r\nreturn -EWRONGFS;\r\n}\r\nif (check_version && XFS_SB_VERSION_NUM(sbp) == XFS_SB_VERSION_5) {\r\nif (xfs_sb_has_compat_feature(sbp,\r\nXFS_SB_FEAT_COMPAT_UNKNOWN)) {\r\nxfs_warn(mp,\r\n"Superblock has unknown compatible features (0x%x) enabled.",\r\n(sbp->sb_features_compat &\r\nXFS_SB_FEAT_COMPAT_UNKNOWN));\r\nxfs_warn(mp,\r\n"Using a more recent kernel is recommended.");\r\n}\r\nif (xfs_sb_has_ro_compat_feature(sbp,\r\nXFS_SB_FEAT_RO_COMPAT_UNKNOWN)) {\r\nxfs_alert(mp,\r\n"Superblock has unknown read-only compatible features (0x%x) enabled.",\r\n(sbp->sb_features_ro_compat &\r\nXFS_SB_FEAT_RO_COMPAT_UNKNOWN));\r\nif (!(mp->m_flags & XFS_MOUNT_RDONLY)) {\r\nxfs_warn(mp,\r\n"Attempted to mount read-only compatible filesystem read-write.");\r\nxfs_warn(mp,\r\n"Filesystem can only be safely mounted read only.");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (xfs_sb_has_incompat_feature(sbp,\r\nXFS_SB_FEAT_INCOMPAT_UNKNOWN)) {\r\nxfs_warn(mp,\r\n"Superblock has unknown incompatible features (0x%x) enabled.",\r\n(sbp->sb_features_incompat &\r\nXFS_SB_FEAT_INCOMPAT_UNKNOWN));\r\nxfs_warn(mp,\r\n"Filesystem can not be safely mounted by this kernel.");\r\nreturn -EINVAL;\r\n}\r\n} else if (xfs_sb_version_hascrc(sbp)) {\r\nif (!xfs_log_check_lsn(mp, sbp->sb_lsn))\r\nreturn -EFSCORRUPTED;\r\n}\r\nif (xfs_sb_version_has_pquotino(sbp)) {\r\nif (sbp->sb_qflags & (XFS_OQUOTA_ENFD | XFS_OQUOTA_CHKD)) {\r\nxfs_notice(mp,\r\n"Version 5 of Super block has XFS_OQUOTA bits.");\r\nreturn -EFSCORRUPTED;\r\n}\r\n} else if (sbp->sb_qflags & (XFS_PQUOTA_ENFD | XFS_GQUOTA_ENFD |\r\nXFS_PQUOTA_CHKD | XFS_GQUOTA_CHKD)) {\r\nxfs_notice(mp,\r\n"Superblock earlier than Version 5 has XFS_[PQ]UOTA_{ENFD|CHKD} bits.");\r\nreturn -EFSCORRUPTED;\r\n}\r\nif (xfs_sb_version_hassparseinodes(sbp)) {\r\nuint32_t align;\r\nalign = XFS_INODES_PER_CHUNK * sbp->sb_inodesize\r\n>> sbp->sb_blocklog;\r\nif (sbp->sb_inoalignmt != align) {\r\nxfs_warn(mp,\r\n"Inode block alignment (%u) must match chunk size (%u) for sparse inodes.",\r\nsbp->sb_inoalignmt, align);\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (unlikely(\r\nsbp->sb_logstart == 0 && mp->m_logdev_targp == mp->m_ddev_targp)) {\r\nxfs_warn(mp,\r\n"filesystem is marked as having an external log; "\r\n"specify logdev on the mount command line.");\r\nreturn -EINVAL;\r\n}\r\nif (unlikely(\r\nsbp->sb_logstart != 0 && mp->m_logdev_targp != mp->m_ddev_targp)) {\r\nxfs_warn(mp,\r\n"filesystem is marked as having an internal log; "\r\n"do not specify logdev on the mount command line.");\r\nreturn -EINVAL;\r\n}\r\nif (unlikely(\r\nsbp->sb_agcount <= 0 ||\r\nsbp->sb_sectsize < XFS_MIN_SECTORSIZE ||\r\nsbp->sb_sectsize > XFS_MAX_SECTORSIZE ||\r\nsbp->sb_sectlog < XFS_MIN_SECTORSIZE_LOG ||\r\nsbp->sb_sectlog > XFS_MAX_SECTORSIZE_LOG ||\r\nsbp->sb_sectsize != (1 << sbp->sb_sectlog) ||\r\nsbp->sb_blocksize < XFS_MIN_BLOCKSIZE ||\r\nsbp->sb_blocksize > XFS_MAX_BLOCKSIZE ||\r\nsbp->sb_blocklog < XFS_MIN_BLOCKSIZE_LOG ||\r\nsbp->sb_blocklog > XFS_MAX_BLOCKSIZE_LOG ||\r\nsbp->sb_blocksize != (1 << sbp->sb_blocklog) ||\r\nsbp->sb_dirblklog + sbp->sb_blocklog > XFS_MAX_BLOCKSIZE_LOG ||\r\nsbp->sb_inodesize < XFS_DINODE_MIN_SIZE ||\r\nsbp->sb_inodesize > XFS_DINODE_MAX_SIZE ||\r\nsbp->sb_inodelog < XFS_DINODE_MIN_LOG ||\r\nsbp->sb_inodelog > XFS_DINODE_MAX_LOG ||\r\nsbp->sb_inodesize != (1 << sbp->sb_inodelog) ||\r\nsbp->sb_logsunit > XLOG_MAX_RECORD_BSIZE ||\r\nsbp->sb_inopblock != howmany(sbp->sb_blocksize,sbp->sb_inodesize) ||\r\n(sbp->sb_blocklog - sbp->sb_inodelog != sbp->sb_inopblog) ||\r\n(sbp->sb_rextsize * sbp->sb_blocksize > XFS_MAX_RTEXTSIZE) ||\r\n(sbp->sb_rextsize * sbp->sb_blocksize < XFS_MIN_RTEXTSIZE) ||\r\n(sbp->sb_imax_pct > 100 ) ||\r\nsbp->sb_dblocks == 0 ||\r\nsbp->sb_dblocks > XFS_MAX_DBLOCKS(sbp) ||\r\nsbp->sb_dblocks < XFS_MIN_DBLOCKS(sbp) ||\r\nsbp->sb_shared_vn != 0)) {\r\nxfs_notice(mp, "SB sanity check failed");\r\nreturn -EFSCORRUPTED;\r\n}\r\nif (xfs_sb_version_hascrc(&mp->m_sb) &&\r\nsbp->sb_blocksize < XFS_MIN_CRC_BLOCKSIZE) {\r\nxfs_notice(mp, "v5 SB sanity check failed");\r\nreturn -EFSCORRUPTED;\r\n}\r\nif (unlikely(sbp->sb_blocksize > PAGE_SIZE)) {\r\nxfs_warn(mp,\r\n"File system with blocksize %d bytes. "\r\n"Only pagesize (%ld) or less will currently work.",\r\nsbp->sb_blocksize, PAGE_SIZE);\r\nreturn -ENOSYS;\r\n}\r\nswitch (sbp->sb_inodesize) {\r\ncase 256:\r\ncase 512:\r\ncase 1024:\r\ncase 2048:\r\nbreak;\r\ndefault:\r\nxfs_warn(mp, "inode size of %d bytes not supported",\r\nsbp->sb_inodesize);\r\nreturn -ENOSYS;\r\n}\r\nif (xfs_sb_validate_fsb_count(sbp, sbp->sb_dblocks) ||\r\nxfs_sb_validate_fsb_count(sbp, sbp->sb_rblocks)) {\r\nxfs_warn(mp,\r\n"file system too large to be mounted on this system.");\r\nreturn -EFBIG;\r\n}\r\nif (check_inprogress && sbp->sb_inprogress) {\r\nxfs_warn(mp, "Offline file system operation in progress!");\r\nreturn -EFSCORRUPTED;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_sb_quota_from_disk(struct xfs_sb *sbp)\r\n{\r\nif (sbp->sb_uquotino == 0)\r\nsbp->sb_uquotino = NULLFSINO;\r\nif (sbp->sb_gquotino == 0)\r\nsbp->sb_gquotino = NULLFSINO;\r\nif (sbp->sb_pquotino == 0)\r\nsbp->sb_pquotino = NULLFSINO;\r\nif (xfs_sb_version_has_pquotino(sbp))\r\nreturn;\r\nif (sbp->sb_qflags & XFS_OQUOTA_ENFD)\r\nsbp->sb_qflags |= (sbp->sb_qflags & XFS_PQUOTA_ACCT) ?\r\nXFS_PQUOTA_ENFD : XFS_GQUOTA_ENFD;\r\nif (sbp->sb_qflags & XFS_OQUOTA_CHKD)\r\nsbp->sb_qflags |= (sbp->sb_qflags & XFS_PQUOTA_ACCT) ?\r\nXFS_PQUOTA_CHKD : XFS_GQUOTA_CHKD;\r\nsbp->sb_qflags &= ~(XFS_OQUOTA_ENFD | XFS_OQUOTA_CHKD);\r\nif (sbp->sb_qflags & XFS_PQUOTA_ACCT &&\r\nsbp->sb_gquotino != NULLFSINO) {\r\nsbp->sb_pquotino = sbp->sb_gquotino;\r\nsbp->sb_gquotino = NULLFSINO;\r\n}\r\n}\r\nstatic void\r\n__xfs_sb_from_disk(\r\nstruct xfs_sb *to,\r\nxfs_dsb_t *from,\r\nbool convert_xquota)\r\n{\r\nto->sb_magicnum = be32_to_cpu(from->sb_magicnum);\r\nto->sb_blocksize = be32_to_cpu(from->sb_blocksize);\r\nto->sb_dblocks = be64_to_cpu(from->sb_dblocks);\r\nto->sb_rblocks = be64_to_cpu(from->sb_rblocks);\r\nto->sb_rextents = be64_to_cpu(from->sb_rextents);\r\nmemcpy(&to->sb_uuid, &from->sb_uuid, sizeof(to->sb_uuid));\r\nto->sb_logstart = be64_to_cpu(from->sb_logstart);\r\nto->sb_rootino = be64_to_cpu(from->sb_rootino);\r\nto->sb_rbmino = be64_to_cpu(from->sb_rbmino);\r\nto->sb_rsumino = be64_to_cpu(from->sb_rsumino);\r\nto->sb_rextsize = be32_to_cpu(from->sb_rextsize);\r\nto->sb_agblocks = be32_to_cpu(from->sb_agblocks);\r\nto->sb_agcount = be32_to_cpu(from->sb_agcount);\r\nto->sb_rbmblocks = be32_to_cpu(from->sb_rbmblocks);\r\nto->sb_logblocks = be32_to_cpu(from->sb_logblocks);\r\nto->sb_versionnum = be16_to_cpu(from->sb_versionnum);\r\nto->sb_sectsize = be16_to_cpu(from->sb_sectsize);\r\nto->sb_inodesize = be16_to_cpu(from->sb_inodesize);\r\nto->sb_inopblock = be16_to_cpu(from->sb_inopblock);\r\nmemcpy(&to->sb_fname, &from->sb_fname, sizeof(to->sb_fname));\r\nto->sb_blocklog = from->sb_blocklog;\r\nto->sb_sectlog = from->sb_sectlog;\r\nto->sb_inodelog = from->sb_inodelog;\r\nto->sb_inopblog = from->sb_inopblog;\r\nto->sb_agblklog = from->sb_agblklog;\r\nto->sb_rextslog = from->sb_rextslog;\r\nto->sb_inprogress = from->sb_inprogress;\r\nto->sb_imax_pct = from->sb_imax_pct;\r\nto->sb_icount = be64_to_cpu(from->sb_icount);\r\nto->sb_ifree = be64_to_cpu(from->sb_ifree);\r\nto->sb_fdblocks = be64_to_cpu(from->sb_fdblocks);\r\nto->sb_frextents = be64_to_cpu(from->sb_frextents);\r\nto->sb_uquotino = be64_to_cpu(from->sb_uquotino);\r\nto->sb_gquotino = be64_to_cpu(from->sb_gquotino);\r\nto->sb_qflags = be16_to_cpu(from->sb_qflags);\r\nto->sb_flags = from->sb_flags;\r\nto->sb_shared_vn = from->sb_shared_vn;\r\nto->sb_inoalignmt = be32_to_cpu(from->sb_inoalignmt);\r\nto->sb_unit = be32_to_cpu(from->sb_unit);\r\nto->sb_width = be32_to_cpu(from->sb_width);\r\nto->sb_dirblklog = from->sb_dirblklog;\r\nto->sb_logsectlog = from->sb_logsectlog;\r\nto->sb_logsectsize = be16_to_cpu(from->sb_logsectsize);\r\nto->sb_logsunit = be32_to_cpu(from->sb_logsunit);\r\nto->sb_features2 = be32_to_cpu(from->sb_features2);\r\nto->sb_bad_features2 = be32_to_cpu(from->sb_bad_features2);\r\nto->sb_features_compat = be32_to_cpu(from->sb_features_compat);\r\nto->sb_features_ro_compat = be32_to_cpu(from->sb_features_ro_compat);\r\nto->sb_features_incompat = be32_to_cpu(from->sb_features_incompat);\r\nto->sb_features_log_incompat =\r\nbe32_to_cpu(from->sb_features_log_incompat);\r\nto->sb_crc = 0;\r\nto->sb_spino_align = be32_to_cpu(from->sb_spino_align);\r\nto->sb_pquotino = be64_to_cpu(from->sb_pquotino);\r\nto->sb_lsn = be64_to_cpu(from->sb_lsn);\r\nif (xfs_sb_version_hasmetauuid(to))\r\nuuid_copy(&to->sb_meta_uuid, &from->sb_meta_uuid);\r\nelse\r\nuuid_copy(&to->sb_meta_uuid, &from->sb_uuid);\r\nif (convert_xquota)\r\nxfs_sb_quota_from_disk(to);\r\n}\r\nvoid\r\nxfs_sb_from_disk(\r\nstruct xfs_sb *to,\r\nxfs_dsb_t *from)\r\n{\r\n__xfs_sb_from_disk(to, from, true);\r\n}\r\nstatic void\r\nxfs_sb_quota_to_disk(\r\nstruct xfs_dsb *to,\r\nstruct xfs_sb *from)\r\n{\r\nuint16_t qflags = from->sb_qflags;\r\nto->sb_uquotino = cpu_to_be64(from->sb_uquotino);\r\nif (xfs_sb_version_has_pquotino(from)) {\r\nto->sb_qflags = cpu_to_be16(from->sb_qflags);\r\nto->sb_gquotino = cpu_to_be64(from->sb_gquotino);\r\nto->sb_pquotino = cpu_to_be64(from->sb_pquotino);\r\nreturn;\r\n}\r\nqflags &= ~(XFS_PQUOTA_ENFD | XFS_PQUOTA_CHKD |\r\nXFS_GQUOTA_ENFD | XFS_GQUOTA_CHKD);\r\nif (from->sb_qflags &\r\n(XFS_PQUOTA_ENFD | XFS_GQUOTA_ENFD))\r\nqflags |= XFS_OQUOTA_ENFD;\r\nif (from->sb_qflags &\r\n(XFS_PQUOTA_CHKD | XFS_GQUOTA_CHKD))\r\nqflags |= XFS_OQUOTA_CHKD;\r\nto->sb_qflags = cpu_to_be16(qflags);\r\nif (from->sb_qflags & XFS_GQUOTA_ACCT)\r\nto->sb_gquotino = cpu_to_be64(from->sb_gquotino);\r\nelse if (from->sb_qflags & XFS_PQUOTA_ACCT)\r\nto->sb_gquotino = cpu_to_be64(from->sb_pquotino);\r\nelse {\r\nif (from->sb_gquotino == NULLFSINO &&\r\nfrom->sb_pquotino == NULLFSINO)\r\nto->sb_gquotino = cpu_to_be64(NULLFSINO);\r\n}\r\nto->sb_pquotino = 0;\r\n}\r\nvoid\r\nxfs_sb_to_disk(\r\nstruct xfs_dsb *to,\r\nstruct xfs_sb *from)\r\n{\r\nxfs_sb_quota_to_disk(to, from);\r\nto->sb_magicnum = cpu_to_be32(from->sb_magicnum);\r\nto->sb_blocksize = cpu_to_be32(from->sb_blocksize);\r\nto->sb_dblocks = cpu_to_be64(from->sb_dblocks);\r\nto->sb_rblocks = cpu_to_be64(from->sb_rblocks);\r\nto->sb_rextents = cpu_to_be64(from->sb_rextents);\r\nmemcpy(&to->sb_uuid, &from->sb_uuid, sizeof(to->sb_uuid));\r\nto->sb_logstart = cpu_to_be64(from->sb_logstart);\r\nto->sb_rootino = cpu_to_be64(from->sb_rootino);\r\nto->sb_rbmino = cpu_to_be64(from->sb_rbmino);\r\nto->sb_rsumino = cpu_to_be64(from->sb_rsumino);\r\nto->sb_rextsize = cpu_to_be32(from->sb_rextsize);\r\nto->sb_agblocks = cpu_to_be32(from->sb_agblocks);\r\nto->sb_agcount = cpu_to_be32(from->sb_agcount);\r\nto->sb_rbmblocks = cpu_to_be32(from->sb_rbmblocks);\r\nto->sb_logblocks = cpu_to_be32(from->sb_logblocks);\r\nto->sb_versionnum = cpu_to_be16(from->sb_versionnum);\r\nto->sb_sectsize = cpu_to_be16(from->sb_sectsize);\r\nto->sb_inodesize = cpu_to_be16(from->sb_inodesize);\r\nto->sb_inopblock = cpu_to_be16(from->sb_inopblock);\r\nmemcpy(&to->sb_fname, &from->sb_fname, sizeof(to->sb_fname));\r\nto->sb_blocklog = from->sb_blocklog;\r\nto->sb_sectlog = from->sb_sectlog;\r\nto->sb_inodelog = from->sb_inodelog;\r\nto->sb_inopblog = from->sb_inopblog;\r\nto->sb_agblklog = from->sb_agblklog;\r\nto->sb_rextslog = from->sb_rextslog;\r\nto->sb_inprogress = from->sb_inprogress;\r\nto->sb_imax_pct = from->sb_imax_pct;\r\nto->sb_icount = cpu_to_be64(from->sb_icount);\r\nto->sb_ifree = cpu_to_be64(from->sb_ifree);\r\nto->sb_fdblocks = cpu_to_be64(from->sb_fdblocks);\r\nto->sb_frextents = cpu_to_be64(from->sb_frextents);\r\nto->sb_flags = from->sb_flags;\r\nto->sb_shared_vn = from->sb_shared_vn;\r\nto->sb_inoalignmt = cpu_to_be32(from->sb_inoalignmt);\r\nto->sb_unit = cpu_to_be32(from->sb_unit);\r\nto->sb_width = cpu_to_be32(from->sb_width);\r\nto->sb_dirblklog = from->sb_dirblklog;\r\nto->sb_logsectlog = from->sb_logsectlog;\r\nto->sb_logsectsize = cpu_to_be16(from->sb_logsectsize);\r\nto->sb_logsunit = cpu_to_be32(from->sb_logsunit);\r\nfrom->sb_bad_features2 = from->sb_features2;\r\nto->sb_features2 = cpu_to_be32(from->sb_features2);\r\nto->sb_bad_features2 = cpu_to_be32(from->sb_bad_features2);\r\nif (xfs_sb_version_hascrc(from)) {\r\nto->sb_features_compat = cpu_to_be32(from->sb_features_compat);\r\nto->sb_features_ro_compat =\r\ncpu_to_be32(from->sb_features_ro_compat);\r\nto->sb_features_incompat =\r\ncpu_to_be32(from->sb_features_incompat);\r\nto->sb_features_log_incompat =\r\ncpu_to_be32(from->sb_features_log_incompat);\r\nto->sb_spino_align = cpu_to_be32(from->sb_spino_align);\r\nto->sb_lsn = cpu_to_be64(from->sb_lsn);\r\nif (xfs_sb_version_hasmetauuid(from))\r\nuuid_copy(&to->sb_meta_uuid, &from->sb_meta_uuid);\r\n}\r\n}\r\nstatic int\r\nxfs_sb_verify(\r\nstruct xfs_buf *bp,\r\nbool check_version)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_sb sb;\r\n__xfs_sb_from_disk(&sb, XFS_BUF_TO_SBP(bp), false);\r\nreturn xfs_mount_validate_sb(mp, &sb,\r\nbp->b_maps[0].bm_bn == XFS_SB_DADDR,\r\ncheck_version);\r\n}\r\nstatic void\r\nxfs_sb_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_dsb *dsb = XFS_BUF_TO_SBP(bp);\r\nint error;\r\nif (dsb->sb_magicnum == cpu_to_be32(XFS_SB_MAGIC) &&\r\n(((be16_to_cpu(dsb->sb_versionnum) & XFS_SB_VERSION_NUMBITS) ==\r\nXFS_SB_VERSION_5) ||\r\ndsb->sb_crc != 0)) {\r\nif (!xfs_buf_verify_cksum(bp, XFS_SB_CRC_OFF)) {\r\nif (bp->b_bn == XFS_SB_DADDR ||\r\nxfs_sb_version_hascrc(&mp->m_sb)) {\r\nerror = -EFSBADCRC;\r\ngoto out_error;\r\n}\r\n}\r\n}\r\nerror = xfs_sb_verify(bp, true);\r\nout_error:\r\nif (error) {\r\nxfs_buf_ioerror(bp, error);\r\nif (error == -EFSCORRUPTED || error == -EFSBADCRC)\r\nxfs_verifier_error(bp);\r\n}\r\n}\r\nstatic void\r\nxfs_sb_quiet_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dsb *dsb = XFS_BUF_TO_SBP(bp);\r\nif (dsb->sb_magicnum == cpu_to_be32(XFS_SB_MAGIC)) {\r\nxfs_sb_read_verify(bp);\r\nreturn;\r\n}\r\nxfs_buf_ioerror(bp, -EWRONGFS);\r\n}\r\nstatic void\r\nxfs_sb_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nint error;\r\nerror = xfs_sb_verify(bp, false);\r\nif (error) {\r\nxfs_buf_ioerror(bp, error);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (bip)\r\nXFS_BUF_TO_SBP(bp)->sb_lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\nxfs_buf_update_cksum(bp, XFS_SB_CRC_OFF);\r\n}\r\nvoid\r\nxfs_sb_mount_common(\r\nstruct xfs_mount *mp,\r\nstruct xfs_sb *sbp)\r\n{\r\nmp->m_agfrotor = mp->m_agirotor = 0;\r\nspin_lock_init(&mp->m_agirotor_lock);\r\nmp->m_maxagi = mp->m_sb.sb_agcount;\r\nmp->m_blkbit_log = sbp->sb_blocklog + XFS_NBBYLOG;\r\nmp->m_blkbb_log = sbp->sb_blocklog - BBSHIFT;\r\nmp->m_sectbb_log = sbp->sb_sectlog - BBSHIFT;\r\nmp->m_agno_log = xfs_highbit32(sbp->sb_agcount - 1) + 1;\r\nmp->m_agino_log = sbp->sb_inopblog + sbp->sb_agblklog;\r\nmp->m_blockmask = sbp->sb_blocksize - 1;\r\nmp->m_blockwsize = sbp->sb_blocksize >> XFS_WORDLOG;\r\nmp->m_blockwmask = mp->m_blockwsize - 1;\r\nmp->m_alloc_mxr[0] = xfs_allocbt_maxrecs(mp, sbp->sb_blocksize, 1);\r\nmp->m_alloc_mxr[1] = xfs_allocbt_maxrecs(mp, sbp->sb_blocksize, 0);\r\nmp->m_alloc_mnr[0] = mp->m_alloc_mxr[0] / 2;\r\nmp->m_alloc_mnr[1] = mp->m_alloc_mxr[1] / 2;\r\nmp->m_inobt_mxr[0] = xfs_inobt_maxrecs(mp, sbp->sb_blocksize, 1);\r\nmp->m_inobt_mxr[1] = xfs_inobt_maxrecs(mp, sbp->sb_blocksize, 0);\r\nmp->m_inobt_mnr[0] = mp->m_inobt_mxr[0] / 2;\r\nmp->m_inobt_mnr[1] = mp->m_inobt_mxr[1] / 2;\r\nmp->m_bmap_dmxr[0] = xfs_bmbt_maxrecs(mp, sbp->sb_blocksize, 1);\r\nmp->m_bmap_dmxr[1] = xfs_bmbt_maxrecs(mp, sbp->sb_blocksize, 0);\r\nmp->m_bmap_dmnr[0] = mp->m_bmap_dmxr[0] / 2;\r\nmp->m_bmap_dmnr[1] = mp->m_bmap_dmxr[1] / 2;\r\nmp->m_rmap_mxr[0] = xfs_rmapbt_maxrecs(mp, sbp->sb_blocksize, 1);\r\nmp->m_rmap_mxr[1] = xfs_rmapbt_maxrecs(mp, sbp->sb_blocksize, 0);\r\nmp->m_rmap_mnr[0] = mp->m_rmap_mxr[0] / 2;\r\nmp->m_rmap_mnr[1] = mp->m_rmap_mxr[1] / 2;\r\nmp->m_refc_mxr[0] = xfs_refcountbt_maxrecs(mp, sbp->sb_blocksize,\r\ntrue);\r\nmp->m_refc_mxr[1] = xfs_refcountbt_maxrecs(mp, sbp->sb_blocksize,\r\nfalse);\r\nmp->m_refc_mnr[0] = mp->m_refc_mxr[0] / 2;\r\nmp->m_refc_mnr[1] = mp->m_refc_mxr[1] / 2;\r\nmp->m_bsize = XFS_FSB_TO_BB(mp, 1);\r\nmp->m_ialloc_inos = (int)MAX((uint16_t)XFS_INODES_PER_CHUNK,\r\nsbp->sb_inopblock);\r\nmp->m_ialloc_blks = mp->m_ialloc_inos >> sbp->sb_inopblog;\r\nif (sbp->sb_spino_align)\r\nmp->m_ialloc_min_blks = sbp->sb_spino_align;\r\nelse\r\nmp->m_ialloc_min_blks = mp->m_ialloc_blks;\r\nmp->m_alloc_set_aside = xfs_alloc_set_aside(mp);\r\nmp->m_ag_max_usable = xfs_alloc_ag_max_usable(mp);\r\n}\r\nint\r\nxfs_initialize_perag_data(\r\nstruct xfs_mount *mp,\r\nxfs_agnumber_t agcount)\r\n{\r\nxfs_agnumber_t index;\r\nxfs_perag_t *pag;\r\nxfs_sb_t *sbp = &mp->m_sb;\r\nuint64_t ifree = 0;\r\nuint64_t ialloc = 0;\r\nuint64_t bfree = 0;\r\nuint64_t bfreelst = 0;\r\nuint64_t btree = 0;\r\nint error;\r\nfor (index = 0; index < agcount; index++) {\r\nerror = xfs_alloc_pagf_init(mp, NULL, index, 0);\r\nif (error)\r\nreturn error;\r\nerror = xfs_ialloc_pagi_init(mp, NULL, index);\r\nif (error)\r\nreturn error;\r\npag = xfs_perag_get(mp, index);\r\nifree += pag->pagi_freecount;\r\nialloc += pag->pagi_count;\r\nbfree += pag->pagf_freeblks;\r\nbfreelst += pag->pagf_flcount;\r\nbtree += pag->pagf_btreeblks;\r\nxfs_perag_put(pag);\r\n}\r\nspin_lock(&mp->m_sb_lock);\r\nsbp->sb_ifree = ifree;\r\nsbp->sb_icount = ialloc;\r\nsbp->sb_fdblocks = bfree + bfreelst + btree;\r\nspin_unlock(&mp->m_sb_lock);\r\nxfs_reinit_percpu_counters(mp);\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_log_sb(\r\nstruct xfs_trans *tp)\r\n{\r\nstruct xfs_mount *mp = tp->t_mountp;\r\nstruct xfs_buf *bp = xfs_trans_getsb(tp, mp, 0);\r\nmp->m_sb.sb_icount = percpu_counter_sum(&mp->m_icount);\r\nmp->m_sb.sb_ifree = percpu_counter_sum(&mp->m_ifree);\r\nmp->m_sb.sb_fdblocks = percpu_counter_sum(&mp->m_fdblocks);\r\nxfs_sb_to_disk(XFS_BUF_TO_SBP(bp), &mp->m_sb);\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_SB_BUF);\r\nxfs_trans_log_buf(tp, bp, 0, sizeof(struct xfs_dsb));\r\n}\r\nint\r\nxfs_sync_sb(\r\nstruct xfs_mount *mp,\r\nbool wait)\r\n{\r\nstruct xfs_trans *tp;\r\nint error;\r\nerror = xfs_trans_alloc(mp, &M_RES(mp)->tr_sb, 0, 0,\r\nXFS_TRANS_NO_WRITECOUNT, &tp);\r\nif (error)\r\nreturn error;\r\nxfs_log_sb(tp);\r\nif (wait)\r\nxfs_trans_set_sync(tp);\r\nreturn xfs_trans_commit(tp);\r\n}

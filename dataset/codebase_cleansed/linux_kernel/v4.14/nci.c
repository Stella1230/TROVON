static int s3fwrn5_nci_prop_rsp(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\nnci_req_complete(ndev, status);\r\nreturn 0;\r\n}\r\nvoid s3fwrn5_nci_get_prop_ops(struct nci_driver_ops **ops, size_t *n)\r\n{\r\n*ops = s3fwrn5_nci_prop_ops;\r\n*n = ARRAY_SIZE(s3fwrn5_nci_prop_ops);\r\n}\r\nint s3fwrn5_nci_rf_configure(struct s3fwrn5_info *info, const char *fw_name)\r\n{\r\nconst struct firmware *fw;\r\nstruct nci_prop_fw_cfg_cmd fw_cfg;\r\nstruct nci_prop_set_rfreg_cmd set_rfreg;\r\nstruct nci_prop_stop_rfreg_cmd stop_rfreg;\r\nu32 checksum;\r\nint i, len;\r\nint ret;\r\nret = request_firmware(&fw, fw_name, &info->ndev->nfc_dev->dev);\r\nif (ret < 0)\r\nreturn ret;\r\nchecksum = 0;\r\nfor (i = 0; i < fw->size; i += 4)\r\nchecksum += *((u32 *)(fw->data+i));\r\nfw_cfg.clk_type = 0x01;\r\nfw_cfg.clk_speed = 0xff;\r\nfw_cfg.clk_req = 0xff;\r\nret = nci_prop_cmd(info->ndev, NCI_PROP_FW_CFG,\r\nsizeof(fw_cfg), (__u8 *)&fw_cfg);\r\nif (ret < 0)\r\ngoto out;\r\ndev_info(&info->ndev->nfc_dev->dev,\r\n"rfreg configuration update: %s\n", fw_name);\r\nret = nci_prop_cmd(info->ndev, NCI_PROP_START_RFREG, 0, NULL);\r\nif (ret < 0) {\r\ndev_err(&info->ndev->nfc_dev->dev,\r\n"Unable to start rfreg update\n");\r\ngoto out;\r\n}\r\nset_rfreg.index = 0;\r\nfor (i = 0; i < fw->size; i += S3FWRN5_RFREG_SECTION_SIZE) {\r\nlen = (fw->size - i < S3FWRN5_RFREG_SECTION_SIZE) ?\r\n(fw->size - i) : S3FWRN5_RFREG_SECTION_SIZE;\r\nmemcpy(set_rfreg.data, fw->data+i, len);\r\nret = nci_prop_cmd(info->ndev, NCI_PROP_SET_RFREG,\r\nlen+1, (__u8 *)&set_rfreg);\r\nif (ret < 0) {\r\ndev_err(&info->ndev->nfc_dev->dev,\r\n"rfreg update error (code=%d)\n", ret);\r\ngoto out;\r\n}\r\nset_rfreg.index++;\r\n}\r\nstop_rfreg.checksum = checksum & 0xffff;\r\nret = nci_prop_cmd(info->ndev, NCI_PROP_STOP_RFREG,\r\nsizeof(stop_rfreg), (__u8 *)&stop_rfreg);\r\nif (ret < 0) {\r\ndev_err(&info->ndev->nfc_dev->dev,\r\n"Unable to stop rfreg update\n");\r\ngoto out;\r\n}\r\ndev_info(&info->ndev->nfc_dev->dev,\r\n"rfreg configuration update: success\n");\r\nout:\r\nrelease_firmware(fw);\r\nreturn ret;\r\n}

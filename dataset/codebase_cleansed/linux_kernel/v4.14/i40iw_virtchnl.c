static enum i40iw_status_code vchnl_vf_send_get_ver_req(struct i40iw_sc_dev *dev,\r\nstruct i40iw_virtchnl_req *vchnl_req)\r\n{\r\nenum i40iw_status_code ret_code = I40IW_ERR_NOT_READY;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = vchnl_req->vchnl_msg;\r\nif (!dev->vchnl_up)\r\nreturn ret_code;\r\nmemset(vchnl_msg, 0, sizeof(*vchnl_msg));\r\nvchnl_msg->iw_chnl_op_ctx = (uintptr_t)vchnl_req;\r\nvchnl_msg->iw_chnl_buf_len = sizeof(*vchnl_msg);\r\nvchnl_msg->iw_op_code = I40IW_VCHNL_OP_GET_VER;\r\nvchnl_msg->iw_op_ver = I40IW_VCHNL_OP_GET_VER_V0;\r\nret_code = dev->vchnl_if.vchnl_send(dev, 0, (u8 *)vchnl_msg, vchnl_msg->iw_chnl_buf_len);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code vchnl_vf_send_get_hmc_fcn_req(struct i40iw_sc_dev *dev,\r\nstruct i40iw_virtchnl_req *vchnl_req)\r\n{\r\nenum i40iw_status_code ret_code = I40IW_ERR_NOT_READY;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = vchnl_req->vchnl_msg;\r\nif (!dev->vchnl_up)\r\nreturn ret_code;\r\nmemset(vchnl_msg, 0, sizeof(*vchnl_msg));\r\nvchnl_msg->iw_chnl_op_ctx = (uintptr_t)vchnl_req;\r\nvchnl_msg->iw_chnl_buf_len = sizeof(*vchnl_msg);\r\nvchnl_msg->iw_op_code = I40IW_VCHNL_OP_GET_HMC_FCN;\r\nvchnl_msg->iw_op_ver = I40IW_VCHNL_OP_GET_HMC_FCN_V0;\r\nret_code = dev->vchnl_if.vchnl_send(dev, 0, (u8 *)vchnl_msg, vchnl_msg->iw_chnl_buf_len);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code vchnl_vf_send_get_pe_stats_req(struct i40iw_sc_dev *dev,\r\nstruct i40iw_virtchnl_req *vchnl_req)\r\n{\r\nenum i40iw_status_code ret_code = I40IW_ERR_NOT_READY;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = vchnl_req->vchnl_msg;\r\nif (!dev->vchnl_up)\r\nreturn ret_code;\r\nmemset(vchnl_msg, 0, sizeof(*vchnl_msg));\r\nvchnl_msg->iw_chnl_op_ctx = (uintptr_t)vchnl_req;\r\nvchnl_msg->iw_chnl_buf_len = sizeof(*vchnl_msg) + sizeof(struct i40iw_dev_hw_stats) - 1;\r\nvchnl_msg->iw_op_code = I40IW_VCHNL_OP_GET_STATS;\r\nvchnl_msg->iw_op_ver = I40IW_VCHNL_OP_GET_STATS_V0;\r\nret_code = dev->vchnl_if.vchnl_send(dev, 0, (u8 *)vchnl_msg, vchnl_msg->iw_chnl_buf_len);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code vchnl_vf_send_add_hmc_objs_req(struct i40iw_sc_dev *dev,\r\nstruct i40iw_virtchnl_req *vchnl_req,\r\nenum i40iw_hmc_rsrc_type rsrc_type,\r\nu32 start_index,\r\nu32 rsrc_count)\r\n{\r\nenum i40iw_status_code ret_code = I40IW_ERR_NOT_READY;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = vchnl_req->vchnl_msg;\r\nstruct i40iw_virtchnl_hmc_obj_range *add_hmc_obj;\r\nif (!dev->vchnl_up)\r\nreturn ret_code;\r\nadd_hmc_obj = (struct i40iw_virtchnl_hmc_obj_range *)vchnl_msg->iw_chnl_buf;\r\nmemset(vchnl_msg, 0, sizeof(*vchnl_msg));\r\nmemset(add_hmc_obj, 0, sizeof(*add_hmc_obj));\r\nvchnl_msg->iw_chnl_op_ctx = (uintptr_t)vchnl_req;\r\nvchnl_msg->iw_chnl_buf_len = sizeof(*vchnl_msg) + sizeof(struct i40iw_virtchnl_hmc_obj_range) - 1;\r\nvchnl_msg->iw_op_code = I40IW_VCHNL_OP_ADD_HMC_OBJ_RANGE;\r\nvchnl_msg->iw_op_ver = I40IW_VCHNL_OP_ADD_HMC_OBJ_RANGE_V0;\r\nadd_hmc_obj->obj_type = (u16)rsrc_type;\r\nadd_hmc_obj->start_index = start_index;\r\nadd_hmc_obj->obj_count = rsrc_count;\r\nret_code = dev->vchnl_if.vchnl_send(dev, 0, (u8 *)vchnl_msg, vchnl_msg->iw_chnl_buf_len);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code vchnl_vf_send_del_hmc_objs_req(struct i40iw_sc_dev *dev,\r\nstruct i40iw_virtchnl_req *vchnl_req,\r\nenum i40iw_hmc_rsrc_type rsrc_type,\r\nu32 start_index,\r\nu32 rsrc_count)\r\n{\r\nenum i40iw_status_code ret_code = I40IW_ERR_NOT_READY;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = vchnl_req->vchnl_msg;\r\nstruct i40iw_virtchnl_hmc_obj_range *add_hmc_obj;\r\nif (!dev->vchnl_up)\r\nreturn ret_code;\r\nadd_hmc_obj = (struct i40iw_virtchnl_hmc_obj_range *)vchnl_msg->iw_chnl_buf;\r\nmemset(vchnl_msg, 0, sizeof(*vchnl_msg));\r\nmemset(add_hmc_obj, 0, sizeof(*add_hmc_obj));\r\nvchnl_msg->iw_chnl_op_ctx = (uintptr_t)vchnl_req;\r\nvchnl_msg->iw_chnl_buf_len = sizeof(*vchnl_msg) + sizeof(struct i40iw_virtchnl_hmc_obj_range) - 1;\r\nvchnl_msg->iw_op_code = I40IW_VCHNL_OP_DEL_HMC_OBJ_RANGE;\r\nvchnl_msg->iw_op_ver = I40IW_VCHNL_OP_DEL_HMC_OBJ_RANGE_V0;\r\nadd_hmc_obj->obj_type = (u16)rsrc_type;\r\nadd_hmc_obj->start_index = start_index;\r\nadd_hmc_obj->obj_count = rsrc_count;\r\nret_code = dev->vchnl_if.vchnl_send(dev, 0, (u8 *)vchnl_msg, vchnl_msg->iw_chnl_buf_len);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nstatic void vchnl_pf_send_get_ver_resp(struct i40iw_sc_dev *dev,\r\nu32 vf_id,\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg)\r\n{\r\nenum i40iw_status_code ret_code;\r\nu8 resp_buffer[sizeof(struct i40iw_virtchnl_resp_buf) + sizeof(u32) - 1];\r\nstruct i40iw_virtchnl_resp_buf *vchnl_msg_resp = (struct i40iw_virtchnl_resp_buf *)resp_buffer;\r\nmemset(resp_buffer, 0, sizeof(*resp_buffer));\r\nvchnl_msg_resp->iw_chnl_op_ctx = vchnl_msg->iw_chnl_op_ctx;\r\nvchnl_msg_resp->iw_chnl_buf_len = sizeof(resp_buffer);\r\nvchnl_msg_resp->iw_op_ret_code = I40IW_SUCCESS;\r\n*((u32 *)vchnl_msg_resp->iw_chnl_buf) = I40IW_VCHNL_CHNL_VER_V0;\r\nret_code = dev->vchnl_if.vchnl_send(dev, vf_id, resp_buffer, sizeof(resp_buffer));\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\n}\r\nstatic void vchnl_pf_send_get_hmc_fcn_resp(struct i40iw_sc_dev *dev,\r\nu32 vf_id,\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg,\r\nu16 hmc_fcn)\r\n{\r\nenum i40iw_status_code ret_code;\r\nu8 resp_buffer[sizeof(struct i40iw_virtchnl_resp_buf) + sizeof(u16) - 1];\r\nstruct i40iw_virtchnl_resp_buf *vchnl_msg_resp = (struct i40iw_virtchnl_resp_buf *)resp_buffer;\r\nmemset(resp_buffer, 0, sizeof(*resp_buffer));\r\nvchnl_msg_resp->iw_chnl_op_ctx = vchnl_msg->iw_chnl_op_ctx;\r\nvchnl_msg_resp->iw_chnl_buf_len = sizeof(resp_buffer);\r\nvchnl_msg_resp->iw_op_ret_code = I40IW_SUCCESS;\r\n*((u16 *)vchnl_msg_resp->iw_chnl_buf) = hmc_fcn;\r\nret_code = dev->vchnl_if.vchnl_send(dev, vf_id, resp_buffer, sizeof(resp_buffer));\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\n}\r\nstatic void vchnl_pf_send_get_pe_stats_resp(struct i40iw_sc_dev *dev,\r\nu32 vf_id,\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg,\r\nstruct i40iw_dev_hw_stats *hw_stats)\r\n{\r\nenum i40iw_status_code ret_code;\r\nu8 resp_buffer[sizeof(struct i40iw_virtchnl_resp_buf) + sizeof(struct i40iw_dev_hw_stats) - 1];\r\nstruct i40iw_virtchnl_resp_buf *vchnl_msg_resp = (struct i40iw_virtchnl_resp_buf *)resp_buffer;\r\nmemset(resp_buffer, 0, sizeof(*resp_buffer));\r\nvchnl_msg_resp->iw_chnl_op_ctx = vchnl_msg->iw_chnl_op_ctx;\r\nvchnl_msg_resp->iw_chnl_buf_len = sizeof(resp_buffer);\r\nvchnl_msg_resp->iw_op_ret_code = I40IW_SUCCESS;\r\n*((struct i40iw_dev_hw_stats *)vchnl_msg_resp->iw_chnl_buf) = *hw_stats;\r\nret_code = dev->vchnl_if.vchnl_send(dev, vf_id, resp_buffer, sizeof(resp_buffer));\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\n}\r\nstatic void vchnl_pf_send_error_resp(struct i40iw_sc_dev *dev, u32 vf_id,\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg,\r\nu16 op_ret_code)\r\n{\r\nenum i40iw_status_code ret_code;\r\nu8 resp_buffer[sizeof(struct i40iw_virtchnl_resp_buf)];\r\nstruct i40iw_virtchnl_resp_buf *vchnl_msg_resp = (struct i40iw_virtchnl_resp_buf *)resp_buffer;\r\nmemset(resp_buffer, 0, sizeof(resp_buffer));\r\nvchnl_msg_resp->iw_chnl_op_ctx = vchnl_msg->iw_chnl_op_ctx;\r\nvchnl_msg_resp->iw_chnl_buf_len = sizeof(resp_buffer);\r\nvchnl_msg_resp->iw_op_ret_code = (u16)op_ret_code;\r\nret_code = dev->vchnl_if.vchnl_send(dev, vf_id, resp_buffer, sizeof(resp_buffer));\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: virt channel send failed 0x%x\n", __func__, ret_code);\r\n}\r\nstatic void pf_cqp_get_hmc_fcn_callback(struct i40iw_sc_dev *dev, void *callback_param,\r\nstruct i40iw_ccq_cqe_info *cqe_info)\r\n{\r\nstruct i40iw_vfdev *vf_dev = callback_param;\r\nstruct i40iw_virt_mem vf_dev_mem;\r\nif (cqe_info->error) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"CQP Completion Error on Get HMC Function. Maj = 0x%04x, Minor = 0x%04x\n",\r\ncqe_info->maj_err_code, cqe_info->min_err_code);\r\ndev->vf_dev[vf_dev->iw_vf_idx] = NULL;\r\nvchnl_pf_send_error_resp(dev, vf_dev->vf_id, &vf_dev->vf_msg_buffer.vchnl_msg,\r\n(u16)I40IW_ERR_CQP_COMPL_ERROR);\r\nvf_dev_mem.va = vf_dev;\r\nvf_dev_mem.size = sizeof(*vf_dev);\r\ni40iw_free_virt_mem(dev->hw, &vf_dev_mem);\r\n} else {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"CQP Completion Operation Return information = 0x%08x\n",\r\ncqe_info->op_ret_val);\r\nvf_dev->pmf_index = (u16)cqe_info->op_ret_val;\r\nvf_dev->msg_count--;\r\nvchnl_pf_send_get_hmc_fcn_resp(dev,\r\nvf_dev->vf_id,\r\n&vf_dev->vf_msg_buffer.vchnl_msg,\r\nvf_dev->pmf_index);\r\n}\r\n}\r\nstatic void pf_add_hmc_obj_callback(void *work_vf_dev)\r\n{\r\nstruct i40iw_vfdev *vf_dev = (struct i40iw_vfdev *)work_vf_dev;\r\nstruct i40iw_hmc_info *hmc_info = &vf_dev->hmc_info;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = &vf_dev->vf_msg_buffer.vchnl_msg;\r\nstruct i40iw_hmc_create_obj_info info;\r\nstruct i40iw_virtchnl_hmc_obj_range *add_hmc_obj;\r\nenum i40iw_status_code ret_code;\r\nif (!vf_dev->pf_hmc_initialized) {\r\nret_code = i40iw_pf_init_vfhmc(vf_dev->pf_dev, (u8)vf_dev->pmf_index, NULL);\r\nif (ret_code)\r\ngoto add_out;\r\nvf_dev->pf_hmc_initialized = true;\r\n}\r\nadd_hmc_obj = (struct i40iw_virtchnl_hmc_obj_range *)vchnl_msg->iw_chnl_buf;\r\nmemset(&info, 0, sizeof(info));\r\ninfo.hmc_info = hmc_info;\r\ninfo.is_pf = false;\r\ninfo.rsrc_type = (u32)add_hmc_obj->obj_type;\r\ninfo.entry_type = (info.rsrc_type == I40IW_HMC_IW_PBLE) ? I40IW_SD_TYPE_PAGED : I40IW_SD_TYPE_DIRECT;\r\ninfo.start_idx = add_hmc_obj->start_index;\r\ninfo.count = add_hmc_obj->obj_count;\r\ni40iw_debug(vf_dev->pf_dev, I40IW_DEBUG_VIRT,\r\n"I40IW_VCHNL_OP_ADD_HMC_OBJ_RANGE. Add %u type %u objects\n",\r\ninfo.count, info.rsrc_type);\r\nret_code = i40iw_sc_create_hmc_obj(vf_dev->pf_dev, &info);\r\nif (!ret_code)\r\nvf_dev->hmc_info.hmc_obj[add_hmc_obj->obj_type].cnt = add_hmc_obj->obj_count;\r\nadd_out:\r\nvf_dev->msg_count--;\r\nvchnl_pf_send_error_resp(vf_dev->pf_dev, vf_dev->vf_id, vchnl_msg, (u16)ret_code);\r\n}\r\nstatic void pf_del_hmc_obj_callback(void *work_vf_dev)\r\n{\r\nstruct i40iw_vfdev *vf_dev = (struct i40iw_vfdev *)work_vf_dev;\r\nstruct i40iw_hmc_info *hmc_info = &vf_dev->hmc_info;\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = &vf_dev->vf_msg_buffer.vchnl_msg;\r\nstruct i40iw_hmc_del_obj_info info;\r\nstruct i40iw_virtchnl_hmc_obj_range *del_hmc_obj;\r\nenum i40iw_status_code ret_code = I40IW_SUCCESS;\r\nif (!vf_dev->pf_hmc_initialized)\r\ngoto del_out;\r\ndel_hmc_obj = (struct i40iw_virtchnl_hmc_obj_range *)vchnl_msg->iw_chnl_buf;\r\nmemset(&info, 0, sizeof(info));\r\ninfo.hmc_info = hmc_info;\r\ninfo.is_pf = false;\r\ninfo.rsrc_type = (u32)del_hmc_obj->obj_type;\r\ninfo.start_idx = del_hmc_obj->start_index;\r\ninfo.count = del_hmc_obj->obj_count;\r\ni40iw_debug(vf_dev->pf_dev, I40IW_DEBUG_VIRT,\r\n"I40IW_VCHNL_OP_DEL_HMC_OBJ_RANGE. Delete %u type %u objects\n",\r\ninfo.count, info.rsrc_type);\r\nret_code = i40iw_sc_del_hmc_obj(vf_dev->pf_dev, &info, false);\r\ndel_out:\r\nvf_dev->msg_count--;\r\nvchnl_pf_send_error_resp(vf_dev->pf_dev, vf_dev->vf_id, vchnl_msg, (u16)ret_code);\r\n}\r\nstatic void i40iw_vf_init_pestat(struct i40iw_sc_dev *dev, struct i40iw_vsi_pestat *stats, u16 index)\r\n{\r\nstats->hw = dev->hw;\r\ni40iw_hw_stats_init(stats, (u8)index, false);\r\nspin_lock_init(&stats->lock);\r\n}\r\nenum i40iw_status_code i40iw_vchnl_recv_pf(struct i40iw_sc_dev *dev,\r\nu32 vf_id,\r\nu8 *msg,\r\nu16 len)\r\n{\r\nstruct i40iw_virtchnl_op_buf *vchnl_msg = (struct i40iw_virtchnl_op_buf *)msg;\r\nstruct i40iw_vfdev *vf_dev = NULL;\r\nstruct i40iw_hmc_fcn_info hmc_fcn_info;\r\nu16 iw_vf_idx;\r\nu16 first_avail_iw_vf = I40IW_MAX_PE_ENABLED_VF_COUNT;\r\nstruct i40iw_virt_mem vf_dev_mem;\r\nstruct i40iw_virtchnl_work_info work_info;\r\nstruct i40iw_vsi_pestat *stats;\r\nenum i40iw_status_code ret_code;\r\nif (!dev || !msg || !len)\r\nreturn I40IW_ERR_PARAM;\r\nif (!dev->vchnl_up)\r\nreturn I40IW_ERR_NOT_READY;\r\nif (vchnl_msg->iw_op_code == I40IW_VCHNL_OP_GET_VER) {\r\nvchnl_pf_send_get_ver_resp(dev, vf_id, vchnl_msg);\r\nreturn I40IW_SUCCESS;\r\n}\r\nfor (iw_vf_idx = 0; iw_vf_idx < I40IW_MAX_PE_ENABLED_VF_COUNT; iw_vf_idx++) {\r\nif (!dev->vf_dev[iw_vf_idx]) {\r\nif (first_avail_iw_vf == I40IW_MAX_PE_ENABLED_VF_COUNT)\r\nfirst_avail_iw_vf = iw_vf_idx;\r\ncontinue;\r\n}\r\nif (dev->vf_dev[iw_vf_idx]->vf_id == vf_id) {\r\nvf_dev = dev->vf_dev[iw_vf_idx];\r\nbreak;\r\n}\r\n}\r\nif (vf_dev) {\r\nif (!vf_dev->msg_count) {\r\nvf_dev->msg_count++;\r\n} else {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"VF%u already has a channel message in progress.\n",\r\nvf_id);\r\nreturn I40IW_SUCCESS;\r\n}\r\n}\r\nswitch (vchnl_msg->iw_op_code) {\r\ncase I40IW_VCHNL_OP_GET_HMC_FCN:\r\nif (!vf_dev &&\r\n(first_avail_iw_vf != I40IW_MAX_PE_ENABLED_VF_COUNT)) {\r\nret_code = i40iw_allocate_virt_mem(dev->hw, &vf_dev_mem, sizeof(struct i40iw_vfdev) +\r\n(sizeof(struct i40iw_hmc_obj_info) * I40IW_HMC_IW_MAX));\r\nif (!ret_code) {\r\nvf_dev = vf_dev_mem.va;\r\nvf_dev->stats_initialized = false;\r\nvf_dev->pf_dev = dev;\r\nvf_dev->msg_count = 1;\r\nvf_dev->vf_id = vf_id;\r\nvf_dev->iw_vf_idx = first_avail_iw_vf;\r\nvf_dev->pf_hmc_initialized = false;\r\nvf_dev->hmc_info.hmc_obj = (struct i40iw_hmc_obj_info *)(&vf_dev[1]);\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"vf_dev %p, hmc_info %p, hmc_obj %p\n",\r\nvf_dev, &vf_dev->hmc_info, vf_dev->hmc_info.hmc_obj);\r\ndev->vf_dev[first_avail_iw_vf] = vf_dev;\r\niw_vf_idx = first_avail_iw_vf;\r\n} else {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"VF%u Unable to allocate a VF device structure.\n",\r\nvf_id);\r\nvchnl_pf_send_error_resp(dev, vf_id, vchnl_msg, (u16)I40IW_ERR_NO_MEMORY);\r\nreturn I40IW_SUCCESS;\r\n}\r\nmemcpy(&vf_dev->vf_msg_buffer.vchnl_msg, vchnl_msg, len);\r\nhmc_fcn_info.callback_fcn = pf_cqp_get_hmc_fcn_callback;\r\nhmc_fcn_info.vf_id = vf_id;\r\nhmc_fcn_info.iw_vf_idx = vf_dev->iw_vf_idx;\r\nhmc_fcn_info.cqp_callback_param = vf_dev;\r\nhmc_fcn_info.free_fcn = false;\r\nret_code = i40iw_cqp_manage_hmc_fcn_cmd(dev, &hmc_fcn_info);\r\nif (ret_code)\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"VF%u error CQP HMC Function operation.\n",\r\nvf_id);\r\ni40iw_vf_init_pestat(dev, &vf_dev->pestat, vf_dev->pmf_index);\r\nvf_dev->stats_initialized = true;\r\n} else {\r\nif (vf_dev) {\r\nvf_dev->msg_count--;\r\nvchnl_pf_send_get_hmc_fcn_resp(dev, vf_id, vchnl_msg, vf_dev->pmf_index);\r\n} else {\r\nvchnl_pf_send_error_resp(dev, vf_id, vchnl_msg,\r\n(u16)I40IW_ERR_NO_MEMORY);\r\n}\r\n}\r\nbreak;\r\ncase I40IW_VCHNL_OP_ADD_HMC_OBJ_RANGE:\r\nif (!vf_dev)\r\nreturn I40IW_ERR_BAD_PTR;\r\nwork_info.worker_vf_dev = vf_dev;\r\nwork_info.callback_fcn = pf_add_hmc_obj_callback;\r\nmemcpy(&vf_dev->vf_msg_buffer.vchnl_msg, vchnl_msg, len);\r\ni40iw_cqp_spawn_worker(dev, &work_info, vf_dev->iw_vf_idx);\r\nbreak;\r\ncase I40IW_VCHNL_OP_DEL_HMC_OBJ_RANGE:\r\nif (!vf_dev)\r\nreturn I40IW_ERR_BAD_PTR;\r\nwork_info.worker_vf_dev = vf_dev;\r\nwork_info.callback_fcn = pf_del_hmc_obj_callback;\r\nmemcpy(&vf_dev->vf_msg_buffer.vchnl_msg, vchnl_msg, len);\r\ni40iw_cqp_spawn_worker(dev, &work_info, vf_dev->iw_vf_idx);\r\nbreak;\r\ncase I40IW_VCHNL_OP_GET_STATS:\r\nif (!vf_dev)\r\nreturn I40IW_ERR_BAD_PTR;\r\nstats = &vf_dev->pestat;\r\ni40iw_hw_stats_read_all(stats, &stats->hw_stats);\r\nvf_dev->msg_count--;\r\nvchnl_pf_send_get_pe_stats_resp(dev, vf_id, vchnl_msg, &stats->hw_stats);\r\nbreak;\r\ndefault:\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"40iw_vchnl_recv_pf: Invalid OpCode 0x%x\n",\r\nvchnl_msg->iw_op_code);\r\nvchnl_pf_send_error_resp(dev, vf_id,\r\nvchnl_msg, (u16)I40IW_ERR_NOT_IMPLEMENTED);\r\n}\r\nreturn I40IW_SUCCESS;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_recv_vf(struct i40iw_sc_dev *dev,\r\nu32 vf_id,\r\nu8 *msg,\r\nu16 len)\r\n{\r\nstruct i40iw_virtchnl_resp_buf *vchnl_msg_resp = (struct i40iw_virtchnl_resp_buf *)msg;\r\nstruct i40iw_virtchnl_req *vchnl_req;\r\nvchnl_req = (struct i40iw_virtchnl_req *)(uintptr_t)vchnl_msg_resp->iw_chnl_op_ctx;\r\nvchnl_req->ret_code = (enum i40iw_status_code)vchnl_msg_resp->iw_op_ret_code;\r\nif (len == (sizeof(*vchnl_msg_resp) + vchnl_req->parm_len - 1)) {\r\nif (vchnl_req->parm_len && vchnl_req->parm)\r\nmemcpy(vchnl_req->parm, vchnl_msg_resp->iw_chnl_buf, vchnl_req->parm_len);\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: Got response, data size %u\n", __func__,\r\nvchnl_req->parm_len);\r\n} else {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s: error length on response, Got %u, expected %u\n", __func__,\r\nlen, (u32)(sizeof(*vchnl_msg_resp) + vchnl_req->parm_len - 1));\r\n}\r\nreturn I40IW_SUCCESS;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_vf_get_ver(struct i40iw_sc_dev *dev,\r\nu32 *vchnl_ver)\r\n{\r\nstruct i40iw_virtchnl_req vchnl_req;\r\nenum i40iw_status_code ret_code;\r\nif (!i40iw_vf_clear_to_send(dev))\r\nreturn I40IW_ERR_TIMEOUT;\r\nmemset(&vchnl_req, 0, sizeof(vchnl_req));\r\nvchnl_req.dev = dev;\r\nvchnl_req.parm = vchnl_ver;\r\nvchnl_req.parm_len = sizeof(*vchnl_ver);\r\nvchnl_req.vchnl_msg = &dev->vchnl_vf_msg_buf.vchnl_msg;\r\nret_code = vchnl_vf_send_get_ver_req(dev, &vchnl_req);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s Send message failed 0x%0x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nret_code = i40iw_vf_wait_vchnl_resp(dev);\r\nif (ret_code)\r\nreturn ret_code;\r\nelse\r\nreturn vchnl_req.ret_code;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_vf_get_hmc_fcn(struct i40iw_sc_dev *dev,\r\nu16 *hmc_fcn)\r\n{\r\nstruct i40iw_virtchnl_req vchnl_req;\r\nenum i40iw_status_code ret_code;\r\nif (!i40iw_vf_clear_to_send(dev))\r\nreturn I40IW_ERR_TIMEOUT;\r\nmemset(&vchnl_req, 0, sizeof(vchnl_req));\r\nvchnl_req.dev = dev;\r\nvchnl_req.parm = hmc_fcn;\r\nvchnl_req.parm_len = sizeof(*hmc_fcn);\r\nvchnl_req.vchnl_msg = &dev->vchnl_vf_msg_buf.vchnl_msg;\r\nret_code = vchnl_vf_send_get_hmc_fcn_req(dev, &vchnl_req);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s Send message failed 0x%0x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nret_code = i40iw_vf_wait_vchnl_resp(dev);\r\nif (ret_code)\r\nreturn ret_code;\r\nelse\r\nreturn vchnl_req.ret_code;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_vf_add_hmc_objs(struct i40iw_sc_dev *dev,\r\nenum i40iw_hmc_rsrc_type rsrc_type,\r\nu32 start_index,\r\nu32 rsrc_count)\r\n{\r\nstruct i40iw_virtchnl_req vchnl_req;\r\nenum i40iw_status_code ret_code;\r\nif (!i40iw_vf_clear_to_send(dev))\r\nreturn I40IW_ERR_TIMEOUT;\r\nmemset(&vchnl_req, 0, sizeof(vchnl_req));\r\nvchnl_req.dev = dev;\r\nvchnl_req.vchnl_msg = &dev->vchnl_vf_msg_buf.vchnl_msg;\r\nret_code = vchnl_vf_send_add_hmc_objs_req(dev,\r\n&vchnl_req,\r\nrsrc_type,\r\nstart_index,\r\nrsrc_count);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s Send message failed 0x%0x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nret_code = i40iw_vf_wait_vchnl_resp(dev);\r\nif (ret_code)\r\nreturn ret_code;\r\nelse\r\nreturn vchnl_req.ret_code;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_vf_del_hmc_obj(struct i40iw_sc_dev *dev,\r\nenum i40iw_hmc_rsrc_type rsrc_type,\r\nu32 start_index,\r\nu32 rsrc_count)\r\n{\r\nstruct i40iw_virtchnl_req vchnl_req;\r\nenum i40iw_status_code ret_code;\r\nif (!i40iw_vf_clear_to_send(dev))\r\nreturn I40IW_ERR_TIMEOUT;\r\nmemset(&vchnl_req, 0, sizeof(vchnl_req));\r\nvchnl_req.dev = dev;\r\nvchnl_req.vchnl_msg = &dev->vchnl_vf_msg_buf.vchnl_msg;\r\nret_code = vchnl_vf_send_del_hmc_objs_req(dev,\r\n&vchnl_req,\r\nrsrc_type,\r\nstart_index,\r\nrsrc_count);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s Send message failed 0x%0x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nret_code = i40iw_vf_wait_vchnl_resp(dev);\r\nif (ret_code)\r\nreturn ret_code;\r\nelse\r\nreturn vchnl_req.ret_code;\r\n}\r\nenum i40iw_status_code i40iw_vchnl_vf_get_pe_stats(struct i40iw_sc_dev *dev,\r\nstruct i40iw_dev_hw_stats *hw_stats)\r\n{\r\nstruct i40iw_virtchnl_req vchnl_req;\r\nenum i40iw_status_code ret_code;\r\nif (!i40iw_vf_clear_to_send(dev))\r\nreturn I40IW_ERR_TIMEOUT;\r\nmemset(&vchnl_req, 0, sizeof(vchnl_req));\r\nvchnl_req.dev = dev;\r\nvchnl_req.parm = hw_stats;\r\nvchnl_req.parm_len = sizeof(*hw_stats);\r\nvchnl_req.vchnl_msg = &dev->vchnl_vf_msg_buf.vchnl_msg;\r\nret_code = vchnl_vf_send_get_pe_stats_req(dev, &vchnl_req);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_VIRT,\r\n"%s Send message failed 0x%0x\n", __func__, ret_code);\r\nreturn ret_code;\r\n}\r\nret_code = i40iw_vf_wait_vchnl_resp(dev);\r\nif (ret_code)\r\nreturn ret_code;\r\nelse\r\nreturn vchnl_req.ret_code;\r\n}

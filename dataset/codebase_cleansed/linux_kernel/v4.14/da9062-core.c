static int da9062_clear_fault_log(struct da9062 *chip)\r\n{\r\nint ret;\r\nint fault_log;\r\nret = regmap_read(chip->regmap, DA9062AA_FAULT_LOG, &fault_log);\r\nif (ret < 0)\r\nreturn ret;\r\nif (fault_log) {\r\nif (fault_log & DA9062AA_TWD_ERROR_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: TWD_ERROR\n");\r\nif (fault_log & DA9062AA_POR_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: POR\n");\r\nif (fault_log & DA9062AA_VDD_FAULT_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: VDD_FAULT\n");\r\nif (fault_log & DA9062AA_VDD_START_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: VDD_START\n");\r\nif (fault_log & DA9062AA_TEMP_CRIT_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: TEMP_CRIT\n");\r\nif (fault_log & DA9062AA_KEY_RESET_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: KEY_RESET\n");\r\nif (fault_log & DA9062AA_NSHUTDOWN_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: NSHUTDOWN\n");\r\nif (fault_log & DA9062AA_WAIT_SHUT_MASK)\r\ndev_dbg(chip->dev, "Fault log entry detected: WAIT_SHUT\n");\r\nret = regmap_write(chip->regmap, DA9062AA_FAULT_LOG,\r\nfault_log);\r\n}\r\nreturn ret;\r\n}\r\nstatic int da9062_get_device_type(struct da9062 *chip)\r\n{\r\nint device_id, variant_id, variant_mrc, variant_vrc;\r\nchar *type;\r\nint ret;\r\nret = regmap_read(chip->regmap, DA9062AA_DEVICE_ID, &device_id);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Cannot read chip ID.\n");\r\nreturn -EIO;\r\n}\r\nif (device_id != DA9062_PMIC_DEVICE_ID) {\r\ndev_err(chip->dev, "Invalid device ID: 0x%02x\n", device_id);\r\nreturn -ENODEV;\r\n}\r\nret = regmap_read(chip->regmap, DA9062AA_VARIANT_ID, &variant_id);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Cannot read chip variant id.\n");\r\nreturn -EIO;\r\n}\r\nvariant_vrc = (variant_id & DA9062AA_VRC_MASK) >> DA9062AA_VRC_SHIFT;\r\nswitch (variant_vrc) {\r\ncase DA9062_PMIC_VARIANT_VRC_DA9061:\r\ntype = "DA9061";\r\nbreak;\r\ncase DA9062_PMIC_VARIANT_VRC_DA9062:\r\ntype = "DA9062";\r\nbreak;\r\ndefault:\r\ntype = "Unknown";\r\nbreak;\r\n}\r\ndev_info(chip->dev,\r\n"Device detected (device-ID: 0x%02X, var-ID: 0x%02X, %s)\n",\r\ndevice_id, variant_id, type);\r\nvariant_mrc = (variant_id & DA9062AA_MRC_MASK) >> DA9062AA_MRC_SHIFT;\r\nif (variant_mrc < DA9062_PMIC_VARIANT_MRC_AA) {\r\ndev_err(chip->dev,\r\n"Cannot support variant MRC: 0x%02X\n", variant_mrc);\r\nreturn -ENODEV;\r\n}\r\nreturn ret;\r\n}\r\nstatic int da9062_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct da9062 *chip;\r\nconst struct of_device_id *match;\r\nunsigned int irq_base;\r\nconst struct mfd_cell *cell;\r\nconst struct regmap_irq_chip *irq_chip;\r\nconst struct regmap_config *config;\r\nint cell_num;\r\nint ret;\r\nchip = devm_kzalloc(&i2c->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nif (i2c->dev.of_node) {\r\nmatch = of_match_node(da9062_dt_ids, i2c->dev.of_node);\r\nif (!match)\r\nreturn -EINVAL;\r\nchip->chip_type = (uintptr_t)match->data;\r\n} else {\r\nchip->chip_type = id->driver_data;\r\n}\r\ni2c_set_clientdata(i2c, chip);\r\nchip->dev = &i2c->dev;\r\nif (!i2c->irq) {\r\ndev_err(chip->dev, "No IRQ configured\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (chip->chip_type) {\r\ncase COMPAT_TYPE_DA9061:\r\ncell = da9061_devs;\r\ncell_num = ARRAY_SIZE(da9061_devs);\r\nirq_chip = &da9061_irq_chip;\r\nconfig = &da9061_regmap_config;\r\nbreak;\r\ncase COMPAT_TYPE_DA9062:\r\ncell = da9062_devs;\r\ncell_num = ARRAY_SIZE(da9062_devs);\r\nirq_chip = &da9062_irq_chip;\r\nconfig = &da9062_regmap_config;\r\nbreak;\r\ndefault:\r\ndev_err(chip->dev, "Unrecognised chip type\n");\r\nreturn -ENODEV;\r\n}\r\nchip->regmap = devm_regmap_init_i2c(i2c, config);\r\nif (IS_ERR(chip->regmap)) {\r\nret = PTR_ERR(chip->regmap);\r\ndev_err(chip->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = da9062_clear_fault_log(chip);\r\nif (ret < 0)\r\ndev_warn(chip->dev, "Cannot clear fault log\n");\r\nret = da9062_get_device_type(chip);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_add_irq_chip(chip->regmap, i2c->irq,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT | IRQF_SHARED,\r\n-1, irq_chip,\r\n&chip->regmap_irq);\r\nif (ret) {\r\ndev_err(chip->dev, "Failed to request IRQ %d: %d\n",\r\ni2c->irq, ret);\r\nreturn ret;\r\n}\r\nirq_base = regmap_irq_chip_get_base(chip->regmap_irq);\r\nret = mfd_add_devices(chip->dev, PLATFORM_DEVID_NONE, cell,\r\ncell_num, NULL, irq_base,\r\nNULL);\r\nif (ret) {\r\ndev_err(chip->dev, "Cannot register child devices\n");\r\nregmap_del_irq_chip(i2c->irq, chip->regmap_irq);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int da9062_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct da9062 *chip = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(chip->dev);\r\nregmap_del_irq_chip(i2c->irq, chip->regmap_irq);\r\nreturn 0;\r\n}

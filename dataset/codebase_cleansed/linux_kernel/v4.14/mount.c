int configfs_is_root(struct config_item *item)\r\n{\r\nreturn item == &configfs_root_group.cg_item;\r\n}\r\nstatic int configfs_fill_super(struct super_block *sb, void *data, int silent)\r\n{\r\nstruct inode *inode;\r\nstruct dentry *root;\r\nsb->s_blocksize = PAGE_SIZE;\r\nsb->s_blocksize_bits = PAGE_SHIFT;\r\nsb->s_magic = CONFIGFS_MAGIC;\r\nsb->s_op = &configfs_ops;\r\nsb->s_time_gran = 1;\r\ninode = configfs_new_inode(S_IFDIR | S_IRWXU | S_IRUGO | S_IXUGO,\r\n&configfs_root, sb);\r\nif (inode) {\r\ninode->i_op = &configfs_root_inode_operations;\r\ninode->i_fop = &configfs_dir_operations;\r\ninc_nlink(inode);\r\n} else {\r\npr_debug("could not get root inode\n");\r\nreturn -ENOMEM;\r\n}\r\nroot = d_make_root(inode);\r\nif (!root) {\r\npr_debug("%s: could not get root dentry!\n",__func__);\r\nreturn -ENOMEM;\r\n}\r\nconfig_group_init(&configfs_root_group);\r\nconfigfs_root_group.cg_item.ci_dentry = root;\r\nroot->d_fsdata = &configfs_root;\r\nsb->s_root = root;\r\nsb->s_d_op = &configfs_dentry_ops;\r\nreturn 0;\r\n}\r\nstatic struct dentry *configfs_do_mount(struct file_system_type *fs_type,\r\nint flags, const char *dev_name, void *data)\r\n{\r\nreturn mount_single(fs_type, flags, data, configfs_fill_super);\r\n}\r\nstruct dentry *configfs_pin_fs(void)\r\n{\r\nint err = simple_pin_fs(&configfs_fs_type, &configfs_mount,\r\n&configfs_mnt_count);\r\nreturn err ? ERR_PTR(err) : configfs_mount->mnt_root;\r\n}\r\nvoid configfs_release_fs(void)\r\n{\r\nsimple_release_fs(&configfs_mount, &configfs_mnt_count);\r\n}\r\nstatic int __init configfs_init(void)\r\n{\r\nint err = -ENOMEM;\r\nconfigfs_dir_cachep = kmem_cache_create("configfs_dir_cache",\r\nsizeof(struct configfs_dirent),\r\n0, 0, NULL);\r\nif (!configfs_dir_cachep)\r\ngoto out;\r\nerr = sysfs_create_mount_point(kernel_kobj, "config");\r\nif (err)\r\ngoto out2;\r\nerr = register_filesystem(&configfs_fs_type);\r\nif (err)\r\ngoto out3;\r\nreturn 0;\r\nout3:\r\npr_err("Unable to register filesystem!\n");\r\nsysfs_remove_mount_point(kernel_kobj, "config");\r\nout2:\r\nkmem_cache_destroy(configfs_dir_cachep);\r\nconfigfs_dir_cachep = NULL;\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit configfs_exit(void)\r\n{\r\nunregister_filesystem(&configfs_fs_type);\r\nsysfs_remove_mount_point(kernel_kobj, "config");\r\nkmem_cache_destroy(configfs_dir_cachep);\r\nconfigfs_dir_cachep = NULL;\r\n}

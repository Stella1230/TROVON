static void ccu_nk_find_best(unsigned long parent, unsigned long rate,\r\nstruct _ccu_nk *nk)\r\n{\r\nunsigned long best_rate = 0;\r\nunsigned int best_k = 0, best_n = 0;\r\nunsigned int _k, _n;\r\nfor (_k = nk->min_k; _k <= nk->max_k; _k++) {\r\nfor (_n = nk->min_n; _n <= nk->max_n; _n++) {\r\nunsigned long tmp_rate = parent * _n * _k;\r\nif (tmp_rate > rate)\r\ncontinue;\r\nif ((rate - tmp_rate) < (rate - best_rate)) {\r\nbest_rate = tmp_rate;\r\nbest_k = _k;\r\nbest_n = _n;\r\n}\r\n}\r\n}\r\nnk->k = best_k;\r\nnk->n = best_n;\r\n}\r\nstatic void ccu_nk_disable(struct clk_hw *hw)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nreturn ccu_gate_helper_disable(&nk->common, nk->enable);\r\n}\r\nstatic int ccu_nk_enable(struct clk_hw *hw)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nreturn ccu_gate_helper_enable(&nk->common, nk->enable);\r\n}\r\nstatic int ccu_nk_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nreturn ccu_gate_helper_is_enabled(&nk->common, nk->enable);\r\n}\r\nstatic unsigned long ccu_nk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nunsigned long rate, n, k;\r\nu32 reg;\r\nreg = readl(nk->common.base + nk->common.reg);\r\nn = reg >> nk->n.shift;\r\nn &= (1 << nk->n.width) - 1;\r\nn += nk->n.offset;\r\nif (!n)\r\nn++;\r\nk = reg >> nk->k.shift;\r\nk &= (1 << nk->k.width) - 1;\r\nk += nk->k.offset;\r\nif (!k)\r\nk++;\r\nrate = parent_rate * n * k;\r\nif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\r\nrate /= nk->fixed_post_div;\r\nreturn rate;\r\n}\r\nstatic long ccu_nk_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nstruct _ccu_nk _nk;\r\nif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\r\nrate *= nk->fixed_post_div;\r\n_nk.min_n = nk->n.min ?: 1;\r\n_nk.max_n = nk->n.max ?: 1 << nk->n.width;\r\n_nk.min_k = nk->k.min ?: 1;\r\n_nk.max_k = nk->k.max ?: 1 << nk->k.width;\r\nccu_nk_find_best(*parent_rate, rate, &_nk);\r\nrate = *parent_rate * _nk.n * _nk.k;\r\nif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\r\nrate = rate / nk->fixed_post_div;\r\nreturn rate;\r\n}\r\nstatic int ccu_nk_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct ccu_nk *nk = hw_to_ccu_nk(hw);\r\nunsigned long flags;\r\nstruct _ccu_nk _nk;\r\nu32 reg;\r\nif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\r\nrate = rate * nk->fixed_post_div;\r\n_nk.min_n = nk->n.min ?: 1;\r\n_nk.max_n = nk->n.max ?: 1 << nk->n.width;\r\n_nk.min_k = nk->k.min ?: 1;\r\n_nk.max_k = nk->k.max ?: 1 << nk->k.width;\r\nccu_nk_find_best(parent_rate, rate, &_nk);\r\nspin_lock_irqsave(nk->common.lock, flags);\r\nreg = readl(nk->common.base + nk->common.reg);\r\nreg &= ~GENMASK(nk->n.width + nk->n.shift - 1, nk->n.shift);\r\nreg &= ~GENMASK(nk->k.width + nk->k.shift - 1, nk->k.shift);\r\nreg |= (_nk.k - nk->k.offset) << nk->k.shift;\r\nreg |= (_nk.n - nk->n.offset) << nk->n.shift;\r\nwritel(reg, nk->common.base + nk->common.reg);\r\nspin_unlock_irqrestore(nk->common.lock, flags);\r\nccu_helper_wait_for_lock(&nk->common, nk->lock);\r\nreturn 0;\r\n}

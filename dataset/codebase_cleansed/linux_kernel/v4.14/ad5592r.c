static int ad5592r_spi_wnop_r16(struct ad5592r_state *st, __be16 *buf)\r\n{\r\nstruct spi_device *spi = container_of(st->dev, struct spi_device, dev);\r\nstruct spi_transfer t = {\r\n.tx_buf = &st->spi_msg_nop,\r\n.rx_buf = buf,\r\n.len = 2\r\n};\r\nst->spi_msg_nop = 0;\r\nreturn spi_sync_transfer(spi, &t, 1);\r\n}\r\nstatic int ad5592r_write_dac(struct ad5592r_state *st, unsigned chan, u16 value)\r\n{\r\nstruct spi_device *spi = container_of(st->dev, struct spi_device, dev);\r\nst->spi_msg = cpu_to_be16(BIT(15) | (chan << 12) | value);\r\nreturn spi_write(spi, &st->spi_msg, sizeof(st->spi_msg));\r\n}\r\nstatic int ad5592r_read_adc(struct ad5592r_state *st, unsigned chan, u16 *value)\r\n{\r\nstruct spi_device *spi = container_of(st->dev, struct spi_device, dev);\r\nint ret;\r\nst->spi_msg = cpu_to_be16((AD5592R_REG_ADC_SEQ << 11) | BIT(chan));\r\nret = spi_write(spi, &st->spi_msg, sizeof(st->spi_msg));\r\nif (ret)\r\nreturn ret;\r\nret = ad5592r_spi_wnop_r16(st, &st->spi_msg);\r\nif (ret)\r\nreturn ret;\r\nret = ad5592r_spi_wnop_r16(st, &st->spi_msg);\r\nif (ret)\r\nreturn ret;\r\n*value = be16_to_cpu(st->spi_msg);\r\nreturn 0;\r\n}\r\nstatic int ad5592r_reg_write(struct ad5592r_state *st, u8 reg, u16 value)\r\n{\r\nstruct spi_device *spi = container_of(st->dev, struct spi_device, dev);\r\nst->spi_msg = cpu_to_be16((reg << 11) | value);\r\nreturn spi_write(spi, &st->spi_msg, sizeof(st->spi_msg));\r\n}\r\nstatic int ad5592r_reg_read(struct ad5592r_state *st, u8 reg, u16 *value)\r\n{\r\nstruct spi_device *spi = container_of(st->dev, struct spi_device, dev);\r\nint ret;\r\nst->spi_msg = cpu_to_be16((AD5592R_REG_LDAC << 11) |\r\nAD5592R_LDAC_READBACK_EN | (reg << 2));\r\nret = spi_write(spi, &st->spi_msg, sizeof(st->spi_msg));\r\nif (ret)\r\nreturn ret;\r\nret = ad5592r_spi_wnop_r16(st, &st->spi_msg);\r\nif (ret)\r\nreturn ret;\r\n*value = be16_to_cpu(st->spi_msg);\r\nreturn 0;\r\n}\r\nstatic int ad5593r_gpio_read(struct ad5592r_state *st, u8 *value)\r\n{\r\nint ret;\r\nret = ad5592r_reg_write(st, AD5592R_REG_GPIO_IN_EN,\r\nAD5592R_GPIO_READBACK_EN | st->gpio_in);\r\nif (ret)\r\nreturn ret;\r\nret = ad5592r_spi_wnop_r16(st, &st->spi_msg);\r\nif (ret)\r\nreturn ret;\r\n*value = (u8) be16_to_cpu(st->spi_msg);\r\nreturn 0;\r\n}\r\nstatic int ad5592r_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nreturn ad5592r_probe(&spi->dev, id->name, &ad5592r_rw_ops);\r\n}\r\nstatic int ad5592r_spi_remove(struct spi_device *spi)\r\n{\r\nreturn ad5592r_remove(&spi->dev);\r\n}

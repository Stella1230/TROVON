enum efi_secureboot_mode efi_get_secureboot(efi_system_table_t *sys_table_arg)\r\n{\r\nu32 attr;\r\nu8 secboot, setupmode, moksbstate;\r\nunsigned long size;\r\nefi_status_t status;\r\nsize = sizeof(secboot);\r\nstatus = get_efi_var(efi_SecureBoot_name, &efi_variable_guid,\r\nNULL, &size, &secboot);\r\nif (status == EFI_NOT_FOUND)\r\nreturn efi_secureboot_mode_disabled;\r\nif (status != EFI_SUCCESS)\r\ngoto out_efi_err;\r\nsize = sizeof(setupmode);\r\nstatus = get_efi_var(efi_SetupMode_name, &efi_variable_guid,\r\nNULL, &size, &setupmode);\r\nif (status != EFI_SUCCESS)\r\ngoto out_efi_err;\r\nif (secboot == 0 || setupmode == 1)\r\nreturn efi_secureboot_mode_disabled;\r\nsize = sizeof(moksbstate);\r\nstatus = get_efi_var(shim_MokSBState_name, &shim_guid,\r\n&attr, &size, &moksbstate);\r\nif (status != EFI_SUCCESS)\r\ngoto secure_boot_enabled;\r\nif (!(attr & EFI_VARIABLE_RUNTIME_ACCESS) && moksbstate == 1)\r\nreturn efi_secureboot_mode_disabled;\r\nsecure_boot_enabled:\r\npr_efi(sys_table_arg, "UEFI Secure Boot is enabled.\n");\r\nreturn efi_secureboot_mode_enabled;\r\nout_efi_err:\r\npr_efi_err(sys_table_arg, "Could not determine UEFI Secure Boot status.\n");\r\nreturn efi_secureboot_mode_unknown;\r\n}

void s5p_mfc_init_hw_ops(struct s5p_mfc_dev *dev)\r\n{\r\nif (IS_MFCV6_PLUS(dev)) {\r\ns5p_mfc_ops = s5p_mfc_init_hw_ops_v6();\r\ndev->warn_start = S5P_FIMV_ERR_WARNINGS_START_V6;\r\n} else {\r\ns5p_mfc_ops = s5p_mfc_init_hw_ops_v5();\r\ndev->warn_start = S5P_FIMV_ERR_WARNINGS_START;\r\n}\r\ndev->mfc_ops = s5p_mfc_ops;\r\n}\r\nvoid s5p_mfc_init_regs(struct s5p_mfc_dev *dev)\r\n{\r\nif (IS_MFCV6_PLUS(dev))\r\ndev->mfc_regs = s5p_mfc_init_regs_v6_plus(dev);\r\n}\r\nint s5p_mfc_alloc_priv_buf(struct s5p_mfc_dev *dev, unsigned int mem_ctx,\r\nstruct s5p_mfc_priv_buf *b)\r\n{\r\nunsigned int bits = dev->mem_size >> PAGE_SHIFT;\r\nunsigned int count = b->size >> PAGE_SHIFT;\r\nunsigned int align = (SZ_64K >> PAGE_SHIFT) - 1;\r\nunsigned int start, offset;\r\nmfc_debug(3, "Allocating priv: %zu\n", b->size);\r\nif (dev->mem_virt) {\r\nstart = bitmap_find_next_zero_area(dev->mem_bitmap, bits, 0, count, align);\r\nif (start > bits)\r\ngoto no_mem;\r\nbitmap_set(dev->mem_bitmap, start, count);\r\noffset = start << PAGE_SHIFT;\r\nb->virt = dev->mem_virt + offset;\r\nb->dma = dev->mem_base + offset;\r\n} else {\r\nstruct device *mem_dev = dev->mem_dev[mem_ctx];\r\ndma_addr_t base = dev->dma_base[mem_ctx];\r\nb->ctx = mem_ctx;\r\nb->virt = dma_alloc_coherent(mem_dev, b->size, &b->dma, GFP_KERNEL);\r\nif (!b->virt)\r\ngoto no_mem;\r\nif (b->dma < base) {\r\nmfc_err("Invalid memory configuration - buffer (%pad) is below base memory address(%pad)\n",\r\n&b->dma, &base);\r\ndma_free_coherent(mem_dev, b->size, b->virt, b->dma);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nmfc_debug(3, "Allocated addr %p %pad\n", b->virt, &b->dma);\r\nreturn 0;\r\nno_mem:\r\nmfc_err("Allocating private buffer of size %zu failed\n", b->size);\r\nreturn -ENOMEM;\r\n}\r\nint s5p_mfc_alloc_generic_buf(struct s5p_mfc_dev *dev, unsigned int mem_ctx,\r\nstruct s5p_mfc_priv_buf *b)\r\n{\r\nstruct device *mem_dev = dev->mem_dev[mem_ctx];\r\nmfc_debug(3, "Allocating generic buf: %zu\n", b->size);\r\nb->ctx = mem_ctx;\r\nb->virt = dma_alloc_coherent(mem_dev, b->size, &b->dma, GFP_KERNEL);\r\nif (!b->virt)\r\ngoto no_mem;\r\nmfc_debug(3, "Allocated addr %p %pad\n", b->virt, &b->dma);\r\nreturn 0;\r\nno_mem:\r\nmfc_err("Allocating generic buffer of size %zu failed\n", b->size);\r\nreturn -ENOMEM;\r\n}\r\nvoid s5p_mfc_release_priv_buf(struct s5p_mfc_dev *dev,\r\nstruct s5p_mfc_priv_buf *b)\r\n{\r\nif (dev->mem_virt) {\r\nunsigned int start = (b->dma - dev->mem_base) >> PAGE_SHIFT;\r\nunsigned int count = b->size >> PAGE_SHIFT;\r\nbitmap_clear(dev->mem_bitmap, start, count);\r\n} else {\r\nstruct device *mem_dev = dev->mem_dev[b->ctx];\r\ndma_free_coherent(mem_dev, b->size, b->virt, b->dma);\r\n}\r\nb->virt = NULL;\r\nb->dma = 0;\r\nb->size = 0;\r\n}\r\nvoid s5p_mfc_release_generic_buf(struct s5p_mfc_dev *dev,\r\nstruct s5p_mfc_priv_buf *b)\r\n{\r\nstruct device *mem_dev = dev->mem_dev[b->ctx];\r\ndma_free_coherent(mem_dev, b->size, b->virt, b->dma);\r\nb->virt = NULL;\r\nb->dma = 0;\r\nb->size = 0;\r\n}

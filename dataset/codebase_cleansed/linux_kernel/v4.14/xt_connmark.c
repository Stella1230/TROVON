static unsigned int\r\nconnmark_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_connmark_tginfo1 *info = par->targinfo;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nu_int32_t newmark;\r\nct = nf_ct_get(skb, &ctinfo);\r\nif (ct == NULL)\r\nreturn XT_CONTINUE;\r\nswitch (info->mode) {\r\ncase XT_CONNMARK_SET:\r\nnewmark = (ct->mark & ~info->ctmask) ^ info->ctmark;\r\nif (ct->mark != newmark) {\r\nct->mark = newmark;\r\nnf_conntrack_event_cache(IPCT_MARK, ct);\r\n}\r\nbreak;\r\ncase XT_CONNMARK_SAVE:\r\nnewmark = (ct->mark & ~info->ctmask) ^\r\n(skb->mark & info->nfmask);\r\nif (ct->mark != newmark) {\r\nct->mark = newmark;\r\nnf_conntrack_event_cache(IPCT_MARK, ct);\r\n}\r\nbreak;\r\ncase XT_CONNMARK_RESTORE:\r\nnewmark = (skb->mark & ~info->nfmask) ^\r\n(ct->mark & info->ctmask);\r\nskb->mark = newmark;\r\nbreak;\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int connmark_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nint ret;\r\nret = nf_ct_netns_get(par->net, par->family);\r\nif (ret < 0)\r\npr_info("cannot load conntrack support for proto=%u\n",\r\npar->family);\r\nreturn ret;\r\n}\r\nstatic void connmark_tg_destroy(const struct xt_tgdtor_param *par)\r\n{\r\nnf_ct_netns_put(par->net, par->family);\r\n}\r\nstatic bool\r\nconnmark_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_connmark_mtinfo1 *info = par->matchinfo;\r\nenum ip_conntrack_info ctinfo;\r\nconst struct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nif (ct == NULL)\r\nreturn false;\r\nreturn ((ct->mark & info->mask) == info->mark) ^ info->invert;\r\n}\r\nstatic int connmark_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nint ret;\r\nret = nf_ct_netns_get(par->net, par->family);\r\nif (ret < 0)\r\npr_info("cannot load conntrack support for proto=%u\n",\r\npar->family);\r\nreturn ret;\r\n}\r\nstatic void connmark_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nnf_ct_netns_put(par->net, par->family);\r\n}\r\nstatic int __init connmark_mt_init(void)\r\n{\r\nint ret;\r\nret = xt_register_target(&connmark_tg_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nret = xt_register_match(&connmark_mt_reg);\r\nif (ret < 0) {\r\nxt_unregister_target(&connmark_tg_reg);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit connmark_mt_exit(void)\r\n{\r\nxt_unregister_match(&connmark_mt_reg);\r\nxt_unregister_target(&connmark_tg_reg);\r\n}

static int mwifiex_check_uap_capabilties(struct mwifiex_private *priv,\r\nstruct sk_buff *event)\r\n{\r\nint evt_len;\r\nu8 *curr;\r\nu16 tlv_len;\r\nstruct mwifiex_ie_types_data *tlv_hdr;\r\nstruct ieee_types_wmm_parameter *wmm_param_ie = NULL;\r\nint mask = IEEE80211_WMM_IE_AP_QOSINFO_PARAM_SET_CNT_MASK;\r\npriv->wmm_enabled = false;\r\nskb_pull(event, MWIFIEX_BSS_START_EVT_FIX_SIZE);\r\nevt_len = event->len;\r\ncurr = event->data;\r\nmwifiex_dbg_dump(priv->adapter, EVT_D, "uap capabilties:",\r\nevent->data, event->len);\r\nskb_push(event, MWIFIEX_BSS_START_EVT_FIX_SIZE);\r\nwhile ((evt_len >= sizeof(tlv_hdr->header))) {\r\ntlv_hdr = (struct mwifiex_ie_types_data *)curr;\r\ntlv_len = le16_to_cpu(tlv_hdr->header.len);\r\nif (evt_len < tlv_len + sizeof(tlv_hdr->header))\r\nbreak;\r\nswitch (le16_to_cpu(tlv_hdr->header.type)) {\r\ncase WLAN_EID_HT_CAPABILITY:\r\npriv->ap_11n_enabled = true;\r\nbreak;\r\ncase WLAN_EID_VHT_CAPABILITY:\r\npriv->ap_11ac_enabled = true;\r\nbreak;\r\ncase WLAN_EID_VENDOR_SPECIFIC:\r\nwmm_param_ie = (void *)(curr + 2);\r\nwmm_param_ie->vend_hdr.len = (u8)tlv_len;\r\nwmm_param_ie->vend_hdr.element_id =\r\nWLAN_EID_VENDOR_SPECIFIC;\r\nmwifiex_dbg(priv->adapter, EVENT,\r\n"info: check uap capabilities:\t"\r\n"wmm parameter set count: %d\n",\r\nwmm_param_ie->qos_info_bitmap & mask);\r\nmwifiex_wmm_setup_ac_downgrade(priv);\r\npriv->wmm_enabled = true;\r\nmwifiex_wmm_setup_queue_priorities(priv, wmm_param_ie);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncurr += (tlv_len + sizeof(tlv_hdr->header));\r\nevt_len -= (tlv_len + sizeof(tlv_hdr->header));\r\n}\r\nreturn 0;\r\n}\r\nint mwifiex_process_uap_event(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nint len, i;\r\nu32 eventcause = adapter->event_cause;\r\nstruct station_info sinfo;\r\nstruct mwifiex_assoc_event *event;\r\nstruct mwifiex_sta_node *node;\r\nu8 *deauth_mac;\r\nstruct host_cmd_ds_11n_batimeout *ba_timeout;\r\nu16 ctrl;\r\nswitch (eventcause) {\r\ncase EVENT_UAP_STA_ASSOC:\r\nmemset(&sinfo, 0, sizeof(sinfo));\r\nevent = (struct mwifiex_assoc_event *)\r\n(adapter->event_body + MWIFIEX_UAP_EVENT_EXTRA_HEADER);\r\nif (le16_to_cpu(event->type) == TLV_TYPE_UAP_MGMT_FRAME) {\r\nlen = -1;\r\nif (ieee80211_is_assoc_req(event->frame_control))\r\nlen = 0;\r\nelse if (ieee80211_is_reassoc_req(event->frame_control))\r\nlen = ETH_ALEN;\r\nif (len != -1) {\r\nsinfo.assoc_req_ies = &event->data[len];\r\nlen = (u8 *)sinfo.assoc_req_ies -\r\n(u8 *)&event->frame_control;\r\nsinfo.assoc_req_ies_len =\r\nle16_to_cpu(event->len) - (u16)len;\r\n}\r\n}\r\ncfg80211_new_sta(priv->netdev, event->sta_addr, &sinfo,\r\nGFP_KERNEL);\r\nnode = mwifiex_add_sta_entry(priv, event->sta_addr);\r\nif (!node) {\r\nmwifiex_dbg(adapter, ERROR,\r\n"could not create station entry!\n");\r\nreturn -1;\r\n}\r\nif (!priv->ap_11n_enabled)\r\nbreak;\r\nmwifiex_set_sta_ht_cap(priv, sinfo.assoc_req_ies,\r\nsinfo.assoc_req_ies_len, node);\r\nfor (i = 0; i < MAX_NUM_TID; i++) {\r\nif (node->is_11n_enabled)\r\nnode->ampdu_sta[i] =\r\npriv->aggr_prio_tbl[i].ampdu_user;\r\nelse\r\nnode->ampdu_sta[i] = BA_STREAM_NOT_ALLOWED;\r\n}\r\nmemset(node->rx_seq, 0xff, sizeof(node->rx_seq));\r\nbreak;\r\ncase EVENT_UAP_STA_DEAUTH:\r\ndeauth_mac = adapter->event_body +\r\nMWIFIEX_UAP_EVENT_EXTRA_HEADER;\r\ncfg80211_del_sta(priv->netdev, deauth_mac, GFP_KERNEL);\r\nif (priv->ap_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, deauth_mac);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, deauth_mac);\r\n}\r\nmwifiex_wmm_del_peer_ra_list(priv, deauth_mac);\r\nmwifiex_del_sta_entry(priv, deauth_mac);\r\nbreak;\r\ncase EVENT_UAP_BSS_IDLE:\r\npriv->media_connected = false;\r\npriv->port_open = false;\r\nmwifiex_clean_txrx(priv);\r\nmwifiex_del_all_sta_list(priv);\r\nbreak;\r\ncase EVENT_UAP_BSS_ACTIVE:\r\npriv->media_connected = true;\r\npriv->port_open = true;\r\nbreak;\r\ncase EVENT_UAP_BSS_START:\r\nmwifiex_dbg(adapter, EVENT,\r\n"AP EVENT: event id: %#x\n", eventcause);\r\npriv->port_open = false;\r\nmemcpy(priv->netdev->dev_addr, adapter->event_body + 2,\r\nETH_ALEN);\r\nif (priv->hist_data)\r\nmwifiex_hist_data_reset(priv);\r\nmwifiex_check_uap_capabilties(priv, adapter->event_skb);\r\nbreak;\r\ncase EVENT_UAP_MIC_COUNTERMEASURES:\r\nmwifiex_dbg(adapter, EVENT,\r\n"AP EVENT: event id: %#x\n", eventcause);\r\nbreak;\r\ncase EVENT_AMSDU_AGGR_CTRL:\r\nctrl = get_unaligned_le16(adapter->event_body);\r\nmwifiex_dbg(adapter, EVENT,\r\n"event: AMSDU_AGGR_CTRL %d\n", ctrl);\r\nif (priv->media_connected) {\r\nadapter->tx_buf_size =\r\nmin_t(u16, adapter->curr_tx_buf_size, ctrl);\r\nmwifiex_dbg(adapter, EVENT,\r\n"event: tx_buf_size %d\n",\r\nadapter->tx_buf_size);\r\n}\r\nbreak;\r\ncase EVENT_ADDBA:\r\nmwifiex_dbg(adapter, EVENT, "event: ADDBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_send_cmd(priv, HostCmd_CMD_11N_ADDBA_RSP,\r\nHostCmd_ACT_GEN_SET, 0,\r\nadapter->event_body, false);\r\nbreak;\r\ncase EVENT_DELBA:\r\nmwifiex_dbg(adapter, EVENT, "event: DELBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_11n_delete_ba_stream(priv, adapter->event_body);\r\nbreak;\r\ncase EVENT_BA_STREAM_TIEMOUT:\r\nmwifiex_dbg(adapter, EVENT, "event: BA Stream timeout\n");\r\nif (priv->media_connected) {\r\nba_timeout = (void *)adapter->event_body;\r\nmwifiex_11n_ba_stream_timeout(priv, ba_timeout);\r\n}\r\nbreak;\r\ncase EVENT_EXT_SCAN_REPORT:\r\nmwifiex_dbg(adapter, EVENT, "event: EXT_SCAN Report\n");\r\nif (adapter->ext_scan)\r\nreturn mwifiex_handle_event_ext_scan_report(priv,\r\nadapter->event_skb->data);\r\nbreak;\r\ncase EVENT_TX_STATUS_REPORT:\r\nmwifiex_dbg(adapter, EVENT, "event: TX_STATUS Report\n");\r\nmwifiex_parse_tx_status_event(priv, adapter->event_body);\r\nbreak;\r\ncase EVENT_PS_SLEEP:\r\nmwifiex_dbg(adapter, EVENT, "info: EVENT: SLEEP\n");\r\nadapter->ps_state = PS_STATE_PRE_SLEEP;\r\nmwifiex_check_ps_cond(adapter);\r\nbreak;\r\ncase EVENT_PS_AWAKE:\r\nmwifiex_dbg(adapter, EVENT, "info: EVENT: AWAKE\n");\r\nif (!adapter->pps_uapsd_mode &&\r\npriv->media_connected && adapter->sleep_period.period) {\r\nadapter->pps_uapsd_mode = true;\r\nmwifiex_dbg(adapter, EVENT,\r\n"event: PPS/UAPSD mode activated\n");\r\n}\r\nadapter->tx_lock_flag = false;\r\nif (adapter->pps_uapsd_mode && adapter->gen_null_pkt) {\r\nif (mwifiex_check_last_packet_indication(priv)) {\r\nif (adapter->data_sent ||\r\n(adapter->if_ops.is_port_ready &&\r\n!adapter->if_ops.is_port_ready(priv))) {\r\nadapter->ps_state = PS_STATE_AWAKE;\r\nadapter->pm_wakeup_card_req = false;\r\nadapter->pm_wakeup_fw_try = false;\r\nbreak;\r\n}\r\nif (!mwifiex_send_null_packet\r\n(priv,\r\nMWIFIEX_TxPD_POWER_MGMT_NULL_PACKET |\r\nMWIFIEX_TxPD_POWER_MGMT_LAST_PACKET))\r\nadapter->ps_state =\r\nPS_STATE_SLEEP;\r\nreturn 0;\r\n}\r\n}\r\nadapter->ps_state = PS_STATE_AWAKE;\r\nadapter->pm_wakeup_card_req = false;\r\nadapter->pm_wakeup_fw_try = false;\r\nbreak;\r\ncase EVENT_CHANNEL_REPORT_RDY:\r\nmwifiex_dbg(adapter, EVENT, "event: Channel Report\n");\r\nmwifiex_11h_handle_chanrpt_ready(priv, adapter->event_skb);\r\nbreak;\r\ncase EVENT_RADAR_DETECTED:\r\nmwifiex_dbg(adapter, EVENT, "event: Radar detected\n");\r\nmwifiex_11h_handle_radar_detected(priv, adapter->event_skb);\r\nbreak;\r\ncase EVENT_BT_COEX_WLAN_PARA_CHANGE:\r\ndev_err(adapter->dev, "EVENT: BT coex wlan param update\n");\r\nmwifiex_bt_coex_wlan_param_update_event(priv,\r\nadapter->event_skb);\r\nbreak;\r\ncase EVENT_TX_DATA_PAUSE:\r\nmwifiex_dbg(adapter, EVENT, "event: TX DATA PAUSE\n");\r\nmwifiex_process_tx_pause_event(priv, adapter->event_skb);\r\nbreak;\r\ncase EVENT_MULTI_CHAN_INFO:\r\nmwifiex_dbg(adapter, EVENT, "event: multi-chan info\n");\r\nmwifiex_process_multi_chan_event(priv, adapter->event_skb);\r\nbreak;\r\ncase EVENT_RXBA_SYNC:\r\ndev_dbg(adapter->dev, "EVENT: RXBA_SYNC\n");\r\nmwifiex_11n_rxba_sync_event(priv, adapter->event_body,\r\nadapter->event_skb->len -\r\nsizeof(eventcause));\r\nbreak;\r\ncase EVENT_REMAIN_ON_CHAN_EXPIRED:\r\nmwifiex_dbg(adapter, EVENT,\r\n"event: uap: Remain on channel expired\n");\r\ncfg80211_remain_on_channel_expired(&priv->wdev,\r\npriv->roc_cfg.cookie,\r\n&priv->roc_cfg.chan,\r\nGFP_ATOMIC);\r\nmemset(&priv->roc_cfg, 0x00, sizeof(struct mwifiex_roc_cfg));\r\nbreak;\r\ndefault:\r\nmwifiex_dbg(adapter, EVENT,\r\n"event: unknown event id: %#x\n", eventcause);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid mwifiex_uap_del_sta_data(struct mwifiex_private *priv,\r\nstruct mwifiex_sta_node *node)\r\n{\r\nif (priv->ap_11n_enabled && node->is_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, node->mac_addr);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, node->mac_addr);\r\n}\r\nmwifiex_del_sta_entry(priv, node->mac_addr);\r\nreturn;\r\n}

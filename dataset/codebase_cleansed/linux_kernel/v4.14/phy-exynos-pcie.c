static void exynos_pcie_phy_writel(void __iomem *base, u32 val, u32 offset)\r\n{\r\nwritel(val, base + offset);\r\n}\r\nstatic u32 exynos_pcie_phy_readl(void __iomem *base, u32 offset)\r\n{\r\nreturn readl(base + offset);\r\n}\r\nstatic int exynos5440_pcie_phy_init(struct phy *phy)\r\n{\r\nstruct exynos_pcie_phy *ep = phy_get_drvdata(phy);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x29, PCIE_PHY_DCC_FEEDBACK);\r\nexynos_pcie_phy_writel(ep->phy_base, 0xd5, PCIE_PHY_IMPEDANCE);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x14, PCIE_PHY_PLL_DIV_0);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x12, PCIE_PHY_PLL_DIV_1);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x7f, PCIE_PHY_TRSV0_DRV_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x0, PCIE_PHY_TRSV0_EMP_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0xe7, PCIE_PHY_PLL_BIAS);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x82, PCIE_PHY_TRSV0_RXCDR);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x82, PCIE_PHY_TRSV1_RXCDR);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x82, PCIE_PHY_TRSV2_RXCDR);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x82, PCIE_PHY_TRSV3_RXCDR);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x39, PCIE_PHY_TRSV0_EMP_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x39, PCIE_PHY_TRSV1_EMP_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x39, PCIE_PHY_TRSV2_EMP_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x39, PCIE_PHY_TRSV3_EMP_LVL);\r\nexynos_pcie_phy_writel(ep->phy_base, 0x20, PCIE_PHY_TRSV0_LVCC);\r\nexynos_pcie_phy_writel(ep->phy_base, 0xa0, PCIE_PHY_TRSV1_LVCC);\r\nexynos_pcie_phy_writel(ep->phy_base, 0xa0, PCIE_PHY_TRSV2_LVCC);\r\nexynos_pcie_phy_writel(ep->phy_base, 0xa0, PCIE_PHY_TRSV3_LVCC);\r\nexynos_pcie_phy_writel(ep->blk_base, 1, PCIE_PHY_COMMON_RESET);\r\nudelay(500);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_COMMON_RESET);\r\nreturn 0;\r\n}\r\nstatic int exynos5440_pcie_phy_power_on(struct phy *phy)\r\n{\r\nstruct exynos_pcie_phy *ep = phy_get_drvdata(phy);\r\nu32 val;\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_COMMON_RESET);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_CMN_REG);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_TRSVREG_RESET);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_TRSV_RESET);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_COMMON_POWER);\r\nval &= ~PCIE_PHY_COMMON_PD_CMN;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_COMMON_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV0_POWER);\r\nval &= ~PCIE_PHY_TRSV0_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV0_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV1_POWER);\r\nval &= ~PCIE_PHY_TRSV1_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV1_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV2_POWER);\r\nval &= ~PCIE_PHY_TRSV2_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV2_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV3_POWER);\r\nval &= ~PCIE_PHY_TRSV3_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV3_POWER);\r\nreturn 0;\r\n}\r\nstatic int exynos5440_pcie_phy_power_off(struct phy *phy)\r\n{\r\nstruct exynos_pcie_phy *ep = phy_get_drvdata(phy);\r\nu32 val;\r\nif (readl_poll_timeout(ep->phy_base + PCIE_PHY_PLL_LOCKED, val,\r\n(val != 0), 1, 500)) {\r\ndev_err(&phy->dev, "PLL Locked: 0x%x\n", val);\r\nreturn -ETIMEDOUT;\r\n}\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_COMMON_POWER);\r\nval |= PCIE_PHY_COMMON_PD_CMN;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_COMMON_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV0_POWER);\r\nval |= PCIE_PHY_TRSV0_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV0_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV1_POWER);\r\nval |= PCIE_PHY_TRSV1_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV1_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV2_POWER);\r\nval |= PCIE_PHY_TRSV2_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV2_POWER);\r\nval = exynos_pcie_phy_readl(ep->phy_base, PCIE_PHY_TRSV3_POWER);\r\nval |= PCIE_PHY_TRSV3_PD_TSV;\r\nexynos_pcie_phy_writel(ep->phy_base, val, PCIE_PHY_TRSV3_POWER);\r\nreturn 0;\r\n}\r\nstatic int exynos5440_pcie_phy_reset(struct phy *phy)\r\n{\r\nstruct exynos_pcie_phy *ep = phy_get_drvdata(phy);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_MAC_RESET);\r\nexynos_pcie_phy_writel(ep->blk_base, 1, PCIE_PHY_GLOBAL_RESET);\r\nexynos_pcie_phy_writel(ep->blk_base, 0, PCIE_PHY_GLOBAL_RESET);\r\nreturn 0;\r\n}\r\nstatic int exynos_pcie_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct exynos_pcie_phy *exynos_phy;\r\nstruct phy *generic_phy;\r\nstruct phy_provider *phy_provider;\r\nstruct resource *res;\r\nconst struct exynos_pcie_phy_data *drv_data;\r\ndrv_data = of_device_get_match_data(dev);\r\nif (!drv_data)\r\nreturn -ENODEV;\r\nexynos_phy = devm_kzalloc(dev, sizeof(*exynos_phy), GFP_KERNEL);\r\nif (!exynos_phy)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nexynos_phy->phy_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(exynos_phy->phy_base))\r\nreturn PTR_ERR(exynos_phy->phy_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nexynos_phy->blk_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(exynos_phy->blk_base))\r\nreturn PTR_ERR(exynos_phy->blk_base);\r\nexynos_phy->drv_data = drv_data;\r\ngeneric_phy = devm_phy_create(dev, dev->of_node, drv_data->ops);\r\nif (IS_ERR(generic_phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(generic_phy);\r\n}\r\nphy_set_drvdata(generic_phy, exynos_phy);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

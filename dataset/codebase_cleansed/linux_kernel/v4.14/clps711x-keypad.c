static void clps711x_keypad_poll(struct input_polled_dev *dev)\r\n{\r\nconst unsigned short *keycodes = dev->input->keycode;\r\nstruct clps711x_keypad_data *priv = dev->private;\r\nbool sync = false;\r\nint col, row;\r\nfor (col = 0; col < CLPS711X_KEYPAD_COL_COUNT; col++) {\r\nregmap_update_bits(priv->syscon, SYSCON_OFFSET,\r\nSYSCON1_KBDSCAN_MASK,\r\nSYSCON1_KBDSCAN(8 + col));\r\nfor (row = 0; row < priv->row_count; row++) {\r\nstruct clps711x_gpio_data *data = &priv->gpio_data[row];\r\nbool state, state1;\r\ndo {\r\nstate = gpiod_get_value_cansleep(data->desc);\r\ncond_resched();\r\nstate1 = gpiod_get_value_cansleep(data->desc);\r\n} while (state != state1);\r\nif (test_bit(col, data->last_state) != state) {\r\nint code = MATRIX_SCAN_CODE(row, col,\r\npriv->row_shift);\r\nif (state) {\r\nset_bit(col, data->last_state);\r\ninput_event(dev->input, EV_MSC,\r\nMSC_SCAN, code);\r\n} else {\r\nclear_bit(col, data->last_state);\r\n}\r\nif (keycodes[code])\r\ninput_report_key(dev->input,\r\nkeycodes[code], state);\r\nsync = true;\r\n}\r\n}\r\nregmap_update_bits(priv->syscon, SYSCON_OFFSET,\r\nSYSCON1_KBDSCAN_MASK, SYSCON1_KBDSCAN(1));\r\n}\r\nif (sync)\r\ninput_sync(dev->input);\r\n}\r\nstatic int clps711x_keypad_probe(struct platform_device *pdev)\r\n{\r\nstruct clps711x_keypad_data *priv;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct input_polled_dev *poll_dev;\r\nu32 poll_interval;\r\nint i, err;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->syscon =\r\nsyscon_regmap_lookup_by_compatible("cirrus,ep7209-syscon1");\r\nif (IS_ERR(priv->syscon))\r\nreturn PTR_ERR(priv->syscon);\r\npriv->row_count = of_gpio_named_count(np, "row-gpios");\r\nif (priv->row_count < 1)\r\nreturn -EINVAL;\r\npriv->gpio_data = devm_kzalloc(dev,\r\nsizeof(*priv->gpio_data) * priv->row_count,\r\nGFP_KERNEL);\r\nif (!priv->gpio_data)\r\nreturn -ENOMEM;\r\npriv->row_shift = get_count_order(CLPS711X_KEYPAD_COL_COUNT);\r\nfor (i = 0; i < priv->row_count; i++) {\r\nstruct clps711x_gpio_data *data = &priv->gpio_data[i];\r\ndata->desc = devm_gpiod_get_index(dev, "row", i, GPIOD_IN);\r\nif (IS_ERR(data->desc))\r\nreturn PTR_ERR(data->desc);\r\n}\r\nerr = of_property_read_u32(np, "poll-interval", &poll_interval);\r\nif (err)\r\nreturn err;\r\npoll_dev = input_allocate_polled_device();\r\nif (!poll_dev)\r\nreturn -ENOMEM;\r\npoll_dev->private = priv;\r\npoll_dev->poll = clps711x_keypad_poll;\r\npoll_dev->poll_interval = poll_interval;\r\npoll_dev->input->name = pdev->name;\r\npoll_dev->input->dev.parent = dev;\r\npoll_dev->input->id.bustype = BUS_HOST;\r\npoll_dev->input->id.vendor = 0x0001;\r\npoll_dev->input->id.product = 0x0001;\r\npoll_dev->input->id.version = 0x0100;\r\nerr = matrix_keypad_build_keymap(NULL, NULL, priv->row_count,\r\nCLPS711X_KEYPAD_COL_COUNT,\r\nNULL, poll_dev->input);\r\nif (err)\r\ngoto out_err;\r\ninput_set_capability(poll_dev->input, EV_MSC, MSC_SCAN);\r\nif (of_property_read_bool(np, "autorepeat"))\r\n__set_bit(EV_REP, poll_dev->input->evbit);\r\nplatform_set_drvdata(pdev, poll_dev);\r\nregmap_update_bits(priv->syscon, SYSCON_OFFSET, SYSCON1_KBDSCAN_MASK,\r\nSYSCON1_KBDSCAN(1));\r\nerr = input_register_polled_device(poll_dev);\r\nif (err)\r\ngoto out_err;\r\nreturn 0;\r\nout_err:\r\ninput_free_polled_device(poll_dev);\r\nreturn err;\r\n}\r\nstatic int clps711x_keypad_remove(struct platform_device *pdev)\r\n{\r\nstruct input_polled_dev *poll_dev = platform_get_drvdata(pdev);\r\ninput_unregister_polled_device(poll_dev);\r\ninput_free_polled_device(poll_dev);\r\nreturn 0;\r\n}

static inline void nuc900_wdt_keepalive(void)\r\n{\r\nunsigned int val;\r\nspin_lock(&nuc900_wdt->wdt_lock);\r\nval = __raw_readl(nuc900_wdt->wdt_base + REG_WTCR);\r\nval |= (WTR | WTIF);\r\n__raw_writel(val, nuc900_wdt->wdt_base + REG_WTCR);\r\nspin_unlock(&nuc900_wdt->wdt_lock);\r\n}\r\nstatic inline void nuc900_wdt_start(void)\r\n{\r\nunsigned int val;\r\nspin_lock(&nuc900_wdt->wdt_lock);\r\nval = __raw_readl(nuc900_wdt->wdt_base + REG_WTCR);\r\nval |= (WTRE | WTE | WTR | WTCLK | WTIF);\r\nval &= ~WTIS;\r\nval |= (WDT_HW_TIMEOUT << 0x04);\r\n__raw_writel(val, nuc900_wdt->wdt_base + REG_WTCR);\r\nspin_unlock(&nuc900_wdt->wdt_lock);\r\nnuc900_wdt->next_heartbeat = jiffies + heartbeat * HZ;\r\nmod_timer(&nuc900_wdt->timer, jiffies + WDT_TIMEOUT);\r\n}\r\nstatic inline void nuc900_wdt_stop(void)\r\n{\r\nunsigned int val;\r\ndel_timer(&nuc900_wdt->timer);\r\nspin_lock(&nuc900_wdt->wdt_lock);\r\nval = __raw_readl(nuc900_wdt->wdt_base + REG_WTCR);\r\nval &= ~WTE;\r\n__raw_writel(val, nuc900_wdt->wdt_base + REG_WTCR);\r\nspin_unlock(&nuc900_wdt->wdt_lock);\r\n}\r\nstatic inline void nuc900_wdt_ping(void)\r\n{\r\nnuc900_wdt->next_heartbeat = jiffies + heartbeat * HZ;\r\n}\r\nstatic int nuc900_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &nuc900wdt_busy))\r\nreturn -EBUSY;\r\nnuc900_wdt_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int nuc900_wdt_close(struct inode *inode, struct file *file)\r\n{\r\nif (nuc900_wdt->expect_close == 42)\r\nnuc900_wdt_stop();\r\nelse {\r\ndev_crit(&nuc900_wdt->pdev->dev,\r\n"Unexpected close, not stopping watchdog!\n");\r\nnuc900_wdt_ping();\r\n}\r\nnuc900_wdt->expect_close = 0;\r\nclear_bit(0, &nuc900wdt_busy);\r\nreturn 0;\r\n}\r\nstatic long nuc900_wdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_value;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &nuc900_wdt_info,\r\nsizeof(nuc900_wdt_info)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_KEEPALIVE:\r\nnuc900_wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_value, p))\r\nreturn -EFAULT;\r\nheartbeat = new_value;\r\nnuc900_wdt_ping();\r\nreturn put_user(new_value, p);\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(heartbeat, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic ssize_t nuc900_wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (!len)\r\nreturn 0;\r\nif (!nowayout) {\r\nsize_t i;\r\nnuc900_wdt->expect_close = 0;\r\nfor (i = 0; i < len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V') {\r\nnuc900_wdt->expect_close = 42;\r\nbreak;\r\n}\r\n}\r\n}\r\nnuc900_wdt_ping();\r\nreturn len;\r\n}\r\nstatic void nuc900_wdt_timer_ping(unsigned long data)\r\n{\r\nif (time_before(jiffies, nuc900_wdt->next_heartbeat)) {\r\nnuc900_wdt_keepalive();\r\nmod_timer(&nuc900_wdt->timer, jiffies + WDT_TIMEOUT);\r\n} else\r\ndev_warn(&nuc900_wdt->pdev->dev, "Will reset the machine !\n");\r\n}\r\nstatic int nuc900wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret = 0;\r\nnuc900_wdt = devm_kzalloc(&pdev->dev, sizeof(*nuc900_wdt),\r\nGFP_KERNEL);\r\nif (!nuc900_wdt)\r\nreturn -ENOMEM;\r\nnuc900_wdt->pdev = pdev;\r\nspin_lock_init(&nuc900_wdt->wdt_lock);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nnuc900_wdt->wdt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(nuc900_wdt->wdt_base))\r\nreturn PTR_ERR(nuc900_wdt->wdt_base);\r\nnuc900_wdt->wdt_clock = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(nuc900_wdt->wdt_clock)) {\r\ndev_err(&pdev->dev, "failed to find watchdog clock source\n");\r\nreturn PTR_ERR(nuc900_wdt->wdt_clock);\r\n}\r\nclk_enable(nuc900_wdt->wdt_clock);\r\nsetup_timer(&nuc900_wdt->timer, nuc900_wdt_timer_ping, 0);\r\nret = misc_register(&nuc900wdt_miscdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "err register miscdev on minor=%d (%d)\n",\r\nWATCHDOG_MINOR, ret);\r\ngoto err_clk;\r\n}\r\nreturn 0;\r\nerr_clk:\r\nclk_disable(nuc900_wdt->wdt_clock);\r\nreturn ret;\r\n}\r\nstatic int nuc900wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&nuc900wdt_miscdev);\r\nclk_disable(nuc900_wdt->wdt_clock);\r\nreturn 0;\r\n}

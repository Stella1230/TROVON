static void\r\ngm200_sor_dp_drive(struct nvkm_ior *sor, int ln, int pc, int dc, int pe, int pu)\r\n{\r\nstruct nvkm_device *device = sor->disp->engine.subdev.device;\r\nconst u32 loff = nv50_sor_link(sor);\r\nconst u32 shift = sor->func->dp.lanes[ln] * 8;\r\nu32 data[4];\r\npu &= 0x0f;\r\ndata[0] = nvkm_rd32(device, 0x61c118 + loff) & ~(0x000000ff << shift);\r\ndata[1] = nvkm_rd32(device, 0x61c120 + loff) & ~(0x000000ff << shift);\r\ndata[2] = nvkm_rd32(device, 0x61c130 + loff);\r\nif ((data[2] & 0x00000f00) < (pu << 8) || ln == 0)\r\ndata[2] = (data[2] & ~0x00000f00) | (pu << 8);\r\nnvkm_wr32(device, 0x61c118 + loff, data[0] | (dc << shift));\r\nnvkm_wr32(device, 0x61c120 + loff, data[1] | (pe << shift));\r\nnvkm_wr32(device, 0x61c130 + loff, data[2]);\r\ndata[3] = nvkm_rd32(device, 0x61c13c + loff) & ~(0x000000ff << shift);\r\nnvkm_wr32(device, 0x61c13c + loff, data[3] | (pc << shift));\r\n}\r\nstatic void\r\ngm200_sor_route_set(struct nvkm_outp *outp, struct nvkm_ior *ior)\r\n{\r\nstruct nvkm_device *device = outp->disp->engine.subdev.device;\r\nconst u32 moff = __ffs(outp->info.or) * 0x100;\r\nconst u32 sor = ior ? ior->id + 1 : 0;\r\nu32 link = ior ? (ior->asy.link == 2) : 0;\r\nif (outp->info.sorconf.link & 1) {\r\nnvkm_mask(device, 0x612308 + moff, 0x0000001f, link << 4 | sor);\r\nlink++;\r\n}\r\nif (outp->info.sorconf.link & 2)\r\nnvkm_mask(device, 0x612388 + moff, 0x0000001f, link << 4 | sor);\r\n}\r\nstatic int\r\ngm200_sor_route_get(struct nvkm_outp *outp, int *link)\r\n{\r\nstruct nvkm_device *device = outp->disp->engine.subdev.device;\r\nconst int sublinks = outp->info.sorconf.link;\r\nint lnk[2], sor[2], m, s;\r\nfor (*link = 0, m = __ffs(outp->info.or) * 2, s = 0; s < 2; m++, s++) {\r\nif (sublinks & BIT(s)) {\r\nu32 data = nvkm_rd32(device, 0x612308 + (m * 0x80));\r\nlnk[s] = (data & 0x00000010) >> 4;\r\nsor[s] = (data & 0x0000000f);\r\nif (!sor[s])\r\nreturn -1;\r\n*link |= lnk[s];\r\n}\r\n}\r\nif (sublinks == 3) {\r\nif (sor[0] != sor[1] || WARN_ON(lnk[0] || !lnk[1]))\r\nreturn -1;\r\n}\r\nreturn ((sublinks & 1) ? sor[0] : sor[1]) - 1;\r\n}\r\nint\r\ngm200_sor_new(struct nvkm_disp *disp, int id)\r\n{\r\nreturn gf119_sor_new_(&gm200_sor, disp, id);\r\n}

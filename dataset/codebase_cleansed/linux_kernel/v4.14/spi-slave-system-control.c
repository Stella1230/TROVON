static void spi_slave_system_control_complete(void *arg)\r\n{\r\nstruct spi_slave_system_control_priv *priv = arg;\r\nu16 cmd;\r\nint ret;\r\nif (priv->msg.status)\r\ngoto terminate;\r\ncmd = be16_to_cpu(priv->cmd);\r\nswitch (cmd) {\r\ncase CMD_REBOOT:\r\ndev_info(&priv->spi->dev, "Rebooting system...\n");\r\nkernel_restart(NULL);\r\ncase CMD_POWEROFF:\r\ndev_info(&priv->spi->dev, "Powering off system...\n");\r\nkernel_power_off();\r\nbreak;\r\ncase CMD_HALT:\r\ndev_info(&priv->spi->dev, "Halting system...\n");\r\nkernel_halt();\r\nbreak;\r\ncase CMD_SUSPEND:\r\ndev_info(&priv->spi->dev, "Suspending system...\n");\r\npm_suspend(PM_SUSPEND_MEM);\r\nbreak;\r\ndefault:\r\ndev_warn(&priv->spi->dev, "Unknown command 0x%x\n", cmd);\r\nbreak;\r\n}\r\nret = spi_slave_system_control_submit(priv);\r\nif (ret)\r\ngoto terminate;\r\nreturn;\r\nterminate:\r\ndev_info(&priv->spi->dev, "Terminating\n");\r\ncomplete(&priv->finished);\r\n}\r\nstatic\r\nint spi_slave_system_control_submit(struct spi_slave_system_control_priv *priv)\r\n{\r\nint ret;\r\nspi_message_init_with_transfers(&priv->msg, &priv->xfer, 1);\r\npriv->msg.complete = spi_slave_system_control_complete;\r\npriv->msg.context = priv;\r\nret = spi_async(priv->spi, &priv->msg);\r\nif (ret)\r\ndev_err(&priv->spi->dev, "spi_async() failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int spi_slave_system_control_probe(struct spi_device *spi)\r\n{\r\nstruct spi_slave_system_control_priv *priv;\r\nint ret;\r\npriv = devm_kzalloc(&spi->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->spi = spi;\r\ninit_completion(&priv->finished);\r\npriv->xfer.rx_buf = &priv->cmd;\r\npriv->xfer.len = sizeof(priv->cmd);\r\nret = spi_slave_system_control_submit(priv);\r\nif (ret)\r\nreturn ret;\r\nspi_set_drvdata(spi, priv);\r\nreturn 0;\r\n}\r\nstatic int spi_slave_system_control_remove(struct spi_device *spi)\r\n{\r\nstruct spi_slave_system_control_priv *priv = spi_get_drvdata(spi);\r\nspi_slave_abort(spi);\r\nwait_for_completion(&priv->finished);\r\nreturn 0;\r\n}

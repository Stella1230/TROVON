static void hd44780_backlight(struct charlcd *lcd, int on)\r\n{\r\nstruct hd44780 *hd = lcd->drvdata;\r\nif (hd->pins[PIN_CTRL_BL])\r\ngpiod_set_value_cansleep(hd->pins[PIN_CTRL_BL], on);\r\n}\r\nstatic void hd44780_strobe_gpio(struct hd44780 *hd)\r\n{\r\nudelay(20);\r\ngpiod_set_value_cansleep(hd->pins[PIN_CTRL_E], 1);\r\nudelay(40);\r\ngpiod_set_value_cansleep(hd->pins[PIN_CTRL_E], 0);\r\n}\r\nstatic void hd44780_write_gpio8(struct hd44780 *hd, u8 val, unsigned int rs)\r\n{\r\nint values[10];\r\nunsigned int i, n;\r\nfor (i = 0; i < 8; i++)\r\nvalues[PIN_DATA0 + i] = !!(val & BIT(i));\r\nvalues[PIN_CTRL_RS] = rs;\r\nn = 9;\r\nif (hd->pins[PIN_CTRL_RW]) {\r\nvalues[PIN_CTRL_RW] = 0;\r\nn++;\r\n}\r\ngpiod_set_array_value_cansleep(n, &hd->pins[PIN_DATA0], values);\r\nhd44780_strobe_gpio(hd);\r\n}\r\nstatic void hd44780_write_gpio4(struct hd44780 *hd, u8 val, unsigned int rs)\r\n{\r\nint values[10];\r\nunsigned int i, n;\r\nfor (i = 4; i < 8; i++)\r\nvalues[PIN_DATA0 + i] = !!(val & BIT(i));\r\nvalues[PIN_CTRL_RS] = rs;\r\nn = 5;\r\nif (hd->pins[PIN_CTRL_RW]) {\r\nvalues[PIN_CTRL_RW] = 0;\r\nn++;\r\n}\r\ngpiod_set_array_value_cansleep(n, &hd->pins[PIN_DATA4],\r\n&values[PIN_DATA4]);\r\nhd44780_strobe_gpio(hd);\r\nfor (i = 0; i < 4; i++)\r\nvalues[PIN_DATA4 + i] = !!(val & BIT(i));\r\ngpiod_set_array_value_cansleep(n, &hd->pins[PIN_DATA4],\r\n&values[PIN_DATA4]);\r\nhd44780_strobe_gpio(hd);\r\n}\r\nstatic void hd44780_write_cmd_gpio8(struct charlcd *lcd, int cmd)\r\n{\r\nstruct hd44780 *hd = lcd->drvdata;\r\nhd44780_write_gpio8(hd, cmd, 0);\r\nudelay(120);\r\n}\r\nstatic void hd44780_write_data_gpio8(struct charlcd *lcd, int data)\r\n{\r\nstruct hd44780 *hd = lcd->drvdata;\r\nhd44780_write_gpio8(hd, data, 1);\r\nudelay(45);\r\n}\r\nstatic void hd44780_write_cmd_gpio4(struct charlcd *lcd, int cmd)\r\n{\r\nstruct hd44780 *hd = lcd->drvdata;\r\nhd44780_write_gpio4(hd, cmd, 0);\r\nudelay(120);\r\n}\r\nstatic void hd44780_write_cmd_raw_gpio4(struct charlcd *lcd, int cmd)\r\n{\r\nint values[10];\r\nstruct hd44780 *hd = lcd->drvdata;\r\nunsigned int i, n;\r\nfor (i = 0; i < 4; i++)\r\nvalues[PIN_DATA4 + i] = !!(cmd & BIT(i));\r\nvalues[PIN_CTRL_RS] = 0;\r\nn = 5;\r\nif (hd->pins[PIN_CTRL_RW]) {\r\nvalues[PIN_CTRL_RW] = 0;\r\nn++;\r\n}\r\ngpiod_set_array_value_cansleep(n, &hd->pins[PIN_DATA4],\r\n&values[PIN_DATA4]);\r\nhd44780_strobe_gpio(hd);\r\n}\r\nstatic void hd44780_write_data_gpio4(struct charlcd *lcd, int data)\r\n{\r\nstruct hd44780 *hd = lcd->drvdata;\r\nhd44780_write_gpio4(hd, data, 1);\r\nudelay(45);\r\n}\r\nstatic int hd44780_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nunsigned int i, base;\r\nstruct charlcd *lcd;\r\nstruct hd44780 *hd;\r\nint ifwidth, ret;\r\nifwidth = gpiod_count(dev, "data");\r\nif (ifwidth < 0)\r\nreturn ifwidth;\r\nswitch (ifwidth) {\r\ncase 4:\r\nbase = PIN_DATA4;\r\nbreak;\r\ncase 8:\r\nbase = PIN_DATA0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nlcd = charlcd_alloc(sizeof(struct hd44780));\r\nif (!lcd)\r\nreturn -ENOMEM;\r\nhd = lcd->drvdata;\r\nfor (i = 0; i < ifwidth; i++) {\r\nhd->pins[base + i] = devm_gpiod_get_index(dev, "data", i,\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(hd->pins[base + i])) {\r\nret = PTR_ERR(hd->pins[base + i]);\r\ngoto fail;\r\n}\r\n}\r\nhd->pins[PIN_CTRL_E] = devm_gpiod_get(dev, "enable", GPIOD_OUT_LOW);\r\nif (IS_ERR(hd->pins[PIN_CTRL_E])) {\r\nret = PTR_ERR(hd->pins[PIN_CTRL_E]);\r\ngoto fail;\r\n}\r\nhd->pins[PIN_CTRL_RS] = devm_gpiod_get(dev, "rs", GPIOD_OUT_HIGH);\r\nif (IS_ERR(hd->pins[PIN_CTRL_RS])) {\r\nret = PTR_ERR(hd->pins[PIN_CTRL_RS]);\r\ngoto fail;\r\n}\r\nhd->pins[PIN_CTRL_RW] = devm_gpiod_get_optional(dev, "rw",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(hd->pins[PIN_CTRL_RW])) {\r\nret = PTR_ERR(hd->pins[PIN_CTRL_RW]);\r\ngoto fail;\r\n}\r\nhd->pins[PIN_CTRL_BL] = devm_gpiod_get_optional(dev, "backlight",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(hd->pins[PIN_CTRL_BL])) {\r\nret = PTR_ERR(hd->pins[PIN_CTRL_BL]);\r\ngoto fail;\r\n}\r\nret = device_property_read_u32(dev, "display-height-chars",\r\n&lcd->height);\r\nif (ret)\r\ngoto fail;\r\nret = device_property_read_u32(dev, "display-width-chars", &lcd->width);\r\nif (ret)\r\ngoto fail;\r\nif (lcd->height > 2)\r\nlcd->bwidth = lcd->width;\r\ndevice_property_read_u32(dev, "internal-buffer-width", &lcd->bwidth);\r\nlcd->ifwidth = ifwidth;\r\nlcd->ops = ifwidth == 8 ? &hd44780_ops_gpio8 : &hd44780_ops_gpio4;\r\nret = charlcd_register(lcd);\r\nif (ret)\r\ngoto fail;\r\nplatform_set_drvdata(pdev, lcd);\r\nreturn 0;\r\nfail:\r\nkfree(lcd);\r\nreturn ret;\r\n}\r\nstatic int hd44780_remove(struct platform_device *pdev)\r\n{\r\nstruct charlcd *lcd = platform_get_drvdata(pdev);\r\ncharlcd_unregister(lcd);\r\nreturn 0;\r\n}

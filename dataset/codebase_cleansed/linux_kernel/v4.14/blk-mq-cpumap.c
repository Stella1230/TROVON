static int cpu_to_queue_index(unsigned int nr_queues, const int cpu)\r\n{\r\nif (!cpu_present(cpu))\r\nreturn 0;\r\nreturn cpu % nr_queues;\r\n}\r\nstatic int get_first_sibling(unsigned int cpu)\r\n{\r\nunsigned int ret;\r\nret = cpumask_first(topology_sibling_cpumask(cpu));\r\nif (ret < nr_cpu_ids)\r\nreturn ret;\r\nreturn cpu;\r\n}\r\nint blk_mq_map_queues(struct blk_mq_tag_set *set)\r\n{\r\nunsigned int *map = set->mq_map;\r\nunsigned int nr_queues = set->nr_hw_queues;\r\nunsigned int cpu, first_sibling;\r\nfor_each_possible_cpu(cpu) {\r\nif (cpu < nr_queues) {\r\nmap[cpu] = cpu_to_queue_index(nr_queues, cpu);\r\n} else {\r\nfirst_sibling = get_first_sibling(cpu);\r\nif (first_sibling == cpu)\r\nmap[cpu] = cpu_to_queue_index(nr_queues, cpu);\r\nelse\r\nmap[cpu] = map[first_sibling];\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint blk_mq_hw_queue_to_node(unsigned int *mq_map, unsigned int index)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nif (index == mq_map[i])\r\nreturn local_memory_node(cpu_to_node(i));\r\n}\r\nreturn NUMA_NO_NODE;\r\n}

static int\r\ngp100_ram_init(struct nvkm_ram *ram)\r\n{\r\nstruct nvkm_subdev *subdev = &ram->fb->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nstruct nvkm_bios *bios = device->bios;\r\nu8 ver, hdr, cnt, len, snr, ssz;\r\nu32 data;\r\nint i;\r\ndata = nvbios_rammapTe(bios, &ver, &hdr, &cnt, &len, &snr, &ssz);\r\nif (!data || hdr < 0x15)\r\nreturn -EINVAL;\r\ncnt = nvbios_rd08(bios, data + 0x14);\r\ndata = nvbios_rd32(bios, data + 0x10);\r\nif (cnt) {\r\nu32 save = nvkm_rd32(device, 0x9a065c) & 0x000000f0;\r\nfor (i = 0; i < cnt; i++, data += 4) {\r\nif (i != save >> 4) {\r\nnvkm_mask(device, 0x9a065c, 0x000000f0, i << 4);\r\nnvbios_init(subdev, nvbios_rd32(bios, data));\r\n}\r\n}\r\nnvkm_mask(device, 0x9a065c, 0x000000f0, save);\r\n}\r\nnvkm_mask(device, 0x9a0584, 0x11000000, 0x00000000);\r\nnvkm_wr32(device, 0x10ecc0, 0xffffffff);\r\nnvkm_mask(device, 0x9a0160, 0x00000010, 0x00000010);\r\nreturn 0;\r\n}\r\nstatic u32\r\ngp100_ram_probe_fbpa(struct nvkm_device *device, int fbpa)\r\n{\r\nreturn nvkm_rd32(device, 0x90020c + (fbpa * 0x4000));\r\n}\r\nint\r\ngp100_ram_new(struct nvkm_fb *fb, struct nvkm_ram **pram)\r\n{\r\nstruct nvkm_ram *ram;\r\nif (!(ram = *pram = kzalloc(sizeof(*ram), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nreturn gf100_ram_ctor(&gp100_ram, fb, ram);\r\n}

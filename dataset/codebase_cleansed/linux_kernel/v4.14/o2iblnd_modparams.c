int kiblnd_msg_queue_size(int version, struct lnet_ni *ni)\r\n{\r\nif (version == IBLND_MSG_VERSION_1)\r\nreturn IBLND_MSG_QUEUE_SIZE_V1;\r\nelse if (ni)\r\nreturn ni->ni_peertxcredits;\r\nelse\r\nreturn peer_credits;\r\n}\r\nint kiblnd_tunables_setup(struct lnet_ni *ni)\r\n{\r\nstruct lnet_ioctl_config_o2iblnd_tunables *tunables;\r\nif (!ni->ni_lnd_tunables) {\r\nLIBCFS_ALLOC(ni->ni_lnd_tunables,\r\nsizeof(*ni->ni_lnd_tunables));\r\nif (!ni->ni_lnd_tunables)\r\nreturn -ENOMEM;\r\nmemcpy(&ni->ni_lnd_tunables->lt_tun_u.lt_o2ib,\r\n&default_tunables, sizeof(*tunables));\r\n}\r\ntunables = &ni->ni_lnd_tunables->lt_tun_u.lt_o2ib;\r\ntunables->lnd_version = 0;\r\nif (kiblnd_translate_mtu(*kiblnd_tunables.kib_ib_mtu) < 0) {\r\nCERROR("Invalid ib_mtu %d, expected 256/512/1024/2048/4096\n",\r\n*kiblnd_tunables.kib_ib_mtu);\r\nreturn -EINVAL;\r\n}\r\nif (!ni->ni_peertimeout)\r\nni->ni_peertimeout = peer_timeout;\r\nif (!ni->ni_maxtxcredits)\r\nni->ni_maxtxcredits = credits;\r\nif (!ni->ni_peertxcredits)\r\nni->ni_peertxcredits = peer_credits;\r\nif (!ni->ni_peerrtrcredits)\r\nni->ni_peerrtrcredits = peer_buffer_credits;\r\nif (ni->ni_peertxcredits < IBLND_CREDITS_DEFAULT)\r\nni->ni_peertxcredits = IBLND_CREDITS_DEFAULT;\r\nif (ni->ni_peertxcredits > IBLND_CREDITS_MAX)\r\nni->ni_peertxcredits = IBLND_CREDITS_MAX;\r\nif (ni->ni_peertxcredits > credits)\r\nni->ni_peertxcredits = credits;\r\nif (!tunables->lnd_peercredits_hiw)\r\ntunables->lnd_peercredits_hiw = peer_credits_hiw;\r\nif (tunables->lnd_peercredits_hiw < ni->ni_peertxcredits / 2)\r\ntunables->lnd_peercredits_hiw = ni->ni_peertxcredits / 2;\r\nif (tunables->lnd_peercredits_hiw >= ni->ni_peertxcredits)\r\ntunables->lnd_peercredits_hiw = ni->ni_peertxcredits - 1;\r\nif (tunables->lnd_map_on_demand <= 0 ||\r\ntunables->lnd_map_on_demand > IBLND_MAX_RDMA_FRAGS) {\r\nCWARN("Invalid map_on_demand (%d), expects 1 - %d. Using default of %d\n",\r\ntunables->lnd_map_on_demand,\r\nIBLND_MAX_RDMA_FRAGS, IBLND_DEFAULT_MAP_ON_DEMAND);\r\ntunables->lnd_map_on_demand = IBLND_DEFAULT_MAP_ON_DEMAND;\r\n}\r\nif (tunables->lnd_map_on_demand == 1) {\r\ntunables->lnd_map_on_demand = 2;\r\n}\r\nif (!tunables->lnd_concurrent_sends) {\r\nif (tunables->lnd_map_on_demand > 0 &&\r\ntunables->lnd_map_on_demand <= IBLND_MAX_RDMA_FRAGS / 8) {\r\ntunables->lnd_concurrent_sends =\r\nni->ni_peertxcredits * 2;\r\n} else {\r\ntunables->lnd_concurrent_sends = ni->ni_peertxcredits;\r\n}\r\n}\r\nif (tunables->lnd_concurrent_sends > ni->ni_peertxcredits * 2)\r\ntunables->lnd_concurrent_sends = ni->ni_peertxcredits * 2;\r\nif (tunables->lnd_concurrent_sends < ni->ni_peertxcredits / 2)\r\ntunables->lnd_concurrent_sends = ni->ni_peertxcredits / 2;\r\nif (tunables->lnd_concurrent_sends < ni->ni_peertxcredits) {\r\nCWARN("Concurrent sends %d is lower than message queue size: %d, performance may drop slightly.\n",\r\ntunables->lnd_concurrent_sends, ni->ni_peertxcredits);\r\n}\r\nif (!tunables->lnd_fmr_pool_size)\r\ntunables->lnd_fmr_pool_size = fmr_pool_size;\r\nif (!tunables->lnd_fmr_flush_trigger)\r\ntunables->lnd_fmr_flush_trigger = fmr_flush_trigger;\r\nif (!tunables->lnd_fmr_cache)\r\ntunables->lnd_fmr_cache = fmr_cache;\r\nreturn 0;\r\n}\r\nvoid kiblnd_tunables_init(void)\r\n{\r\ndefault_tunables.lnd_version = 0;\r\ndefault_tunables.lnd_peercredits_hiw = peer_credits_hiw,\r\ndefault_tunables.lnd_map_on_demand = map_on_demand;\r\ndefault_tunables.lnd_concurrent_sends = concurrent_sends;\r\ndefault_tunables.lnd_fmr_pool_size = fmr_pool_size;\r\ndefault_tunables.lnd_fmr_flush_trigger = fmr_flush_trigger;\r\ndefault_tunables.lnd_fmr_cache = fmr_cache;\r\n}

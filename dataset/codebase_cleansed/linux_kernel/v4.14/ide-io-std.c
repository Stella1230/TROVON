static u8 ide_inb(unsigned long port)\r\n{\r\nreturn (u8) inb(port);\r\n}\r\nstatic void ide_outb(u8 val, unsigned long port)\r\n{\r\noutb(val, port);\r\n}\r\nstatic u8 ide_mm_inb(unsigned long port)\r\n{\r\nreturn (u8) readb((void __iomem *) port);\r\n}\r\nstatic void ide_mm_outb(u8 value, unsigned long port)\r\n{\r\nwriteb(value, (void __iomem *) port);\r\n}\r\nvoid ide_exec_command(ide_hwif_t *hwif, u8 cmd)\r\n{\r\nif (hwif->host_flags & IDE_HFLAG_MMIO)\r\nwriteb(cmd, (void __iomem *)hwif->io_ports.command_addr);\r\nelse\r\noutb(cmd, hwif->io_ports.command_addr);\r\n}\r\nu8 ide_read_status(ide_hwif_t *hwif)\r\n{\r\nif (hwif->host_flags & IDE_HFLAG_MMIO)\r\nreturn readb((void __iomem *)hwif->io_ports.status_addr);\r\nelse\r\nreturn inb(hwif->io_ports.status_addr);\r\n}\r\nu8 ide_read_altstatus(ide_hwif_t *hwif)\r\n{\r\nif (hwif->host_flags & IDE_HFLAG_MMIO)\r\nreturn readb((void __iomem *)hwif->io_ports.ctl_addr);\r\nelse\r\nreturn inb(hwif->io_ports.ctl_addr);\r\n}\r\nvoid ide_write_devctl(ide_hwif_t *hwif, u8 ctl)\r\n{\r\nif (hwif->host_flags & IDE_HFLAG_MMIO)\r\nwriteb(ctl, (void __iomem *)hwif->io_ports.ctl_addr);\r\nelse\r\noutb(ctl, hwif->io_ports.ctl_addr);\r\n}\r\nvoid ide_dev_select(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu8 select = drive->select | ATA_DEVICE_OBS;\r\nif (hwif->host_flags & IDE_HFLAG_MMIO)\r\nwriteb(select, (void __iomem *)hwif->io_ports.device_addr);\r\nelse\r\noutb(select, hwif->io_ports.device_addr);\r\n}\r\nvoid ide_tf_load(ide_drive_t *drive, struct ide_taskfile *tf, u8 valid)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nvoid (*tf_outb)(u8 addr, unsigned long port);\r\nu8 mmio = (hwif->host_flags & IDE_HFLAG_MMIO) ? 1 : 0;\r\nif (mmio)\r\ntf_outb = ide_mm_outb;\r\nelse\r\ntf_outb = ide_outb;\r\nif (valid & IDE_VALID_FEATURE)\r\ntf_outb(tf->feature, io_ports->feature_addr);\r\nif (valid & IDE_VALID_NSECT)\r\ntf_outb(tf->nsect, io_ports->nsect_addr);\r\nif (valid & IDE_VALID_LBAL)\r\ntf_outb(tf->lbal, io_ports->lbal_addr);\r\nif (valid & IDE_VALID_LBAM)\r\ntf_outb(tf->lbam, io_ports->lbam_addr);\r\nif (valid & IDE_VALID_LBAH)\r\ntf_outb(tf->lbah, io_ports->lbah_addr);\r\nif (valid & IDE_VALID_DEVICE)\r\ntf_outb(tf->device, io_ports->device_addr);\r\n}\r\nvoid ide_tf_read(ide_drive_t *drive, struct ide_taskfile *tf, u8 valid)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nu8 (*tf_inb)(unsigned long port);\r\nu8 mmio = (hwif->host_flags & IDE_HFLAG_MMIO) ? 1 : 0;\r\nif (mmio)\r\ntf_inb = ide_mm_inb;\r\nelse\r\ntf_inb = ide_inb;\r\nif (valid & IDE_VALID_ERROR)\r\ntf->error = tf_inb(io_ports->feature_addr);\r\nif (valid & IDE_VALID_NSECT)\r\ntf->nsect = tf_inb(io_ports->nsect_addr);\r\nif (valid & IDE_VALID_LBAL)\r\ntf->lbal = tf_inb(io_ports->lbal_addr);\r\nif (valid & IDE_VALID_LBAM)\r\ntf->lbam = tf_inb(io_ports->lbam_addr);\r\nif (valid & IDE_VALID_LBAH)\r\ntf->lbah = tf_inb(io_ports->lbah_addr);\r\nif (valid & IDE_VALID_DEVICE)\r\ntf->device = tf_inb(io_ports->device_addr);\r\n}\r\nstatic void ata_vlb_sync(unsigned long port)\r\n{\r\n(void)inb(port);\r\n(void)inb(port);\r\n(void)inb(port);\r\n}\r\nvoid ide_input_data(ide_drive_t *drive, struct ide_cmd *cmd, void *buf,\r\nunsigned int len)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nunsigned long data_addr = io_ports->data_addr;\r\nunsigned int words = (len + 1) >> 1;\r\nu8 io_32bit = drive->io_32bit;\r\nu8 mmio = (hwif->host_flags & IDE_HFLAG_MMIO) ? 1 : 0;\r\nif (io_32bit) {\r\nunsigned long uninitialized_var(flags);\r\nif ((io_32bit & 2) && !mmio) {\r\nlocal_irq_save(flags);\r\nata_vlb_sync(io_ports->nsect_addr);\r\n}\r\nwords >>= 1;\r\nif (mmio)\r\n__ide_mm_insl((void __iomem *)data_addr, buf, words);\r\nelse\r\ninsl(data_addr, buf, words);\r\nif ((io_32bit & 2) && !mmio)\r\nlocal_irq_restore(flags);\r\nif (((len + 1) & 3) < 2)\r\nreturn;\r\nbuf += len & ~3;\r\nwords = 1;\r\n}\r\nif (mmio)\r\n__ide_mm_insw((void __iomem *)data_addr, buf, words);\r\nelse\r\ninsw(data_addr, buf, words);\r\n}\r\nvoid ide_output_data(ide_drive_t *drive, struct ide_cmd *cmd, void *buf,\r\nunsigned int len)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nunsigned long data_addr = io_ports->data_addr;\r\nunsigned int words = (len + 1) >> 1;\r\nu8 io_32bit = drive->io_32bit;\r\nu8 mmio = (hwif->host_flags & IDE_HFLAG_MMIO) ? 1 : 0;\r\nif (io_32bit) {\r\nunsigned long uninitialized_var(flags);\r\nif ((io_32bit & 2) && !mmio) {\r\nlocal_irq_save(flags);\r\nata_vlb_sync(io_ports->nsect_addr);\r\n}\r\nwords >>= 1;\r\nif (mmio)\r\n__ide_mm_outsl((void __iomem *)data_addr, buf, words);\r\nelse\r\noutsl(data_addr, buf, words);\r\nif ((io_32bit & 2) && !mmio)\r\nlocal_irq_restore(flags);\r\nif (((len + 1) & 3) < 2)\r\nreturn;\r\nbuf += len & ~3;\r\nwords = 1;\r\n}\r\nif (mmio)\r\n__ide_mm_outsw((void __iomem *)data_addr, buf, words);\r\nelse\r\noutsw(data_addr, buf, words);\r\n}

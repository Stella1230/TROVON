static int tps65217_config_charger(struct tps65217_charger *charger)\r\n{\r\nint ret;\r\nret = tps65217_clear_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\r\nTPS65217_CHGCONFIG1_NTC_TYPE,\r\nTPS65217_PROTECT_NONE);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"failed to set 100k NTC setting: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_enable_charging(struct tps65217_charger *charger)\r\n{\r\nint ret;\r\nif (charger->online)\r\nreturn 0;\r\ndev_dbg(charger->dev, "%s: enable charging\n", __func__);\r\nret = tps65217_set_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\r\nTPS65217_CHGCONFIG1_CHG_EN,\r\nTPS65217_CHGCONFIG1_CHG_EN,\r\nTPS65217_PROTECT_NONE);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"%s: Error in writing CHG_EN in reg 0x%x: %d\n",\r\n__func__, TPS65217_REG_CHGCONFIG1, ret);\r\nreturn ret;\r\n}\r\ncharger->online = 1;\r\nreturn 0;\r\n}\r\nstatic int tps65217_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct tps65217_charger *charger = power_supply_get_drvdata(psy);\r\nif (psp == POWER_SUPPLY_PROP_ONLINE) {\r\nval->intval = charger->online;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t tps65217_charger_irq(int irq, void *dev)\r\n{\r\nint ret, val;\r\nstruct tps65217_charger *charger = dev;\r\ncharger->prev_online = charger->online;\r\nret = tps65217_reg_read(charger->tps, TPS65217_REG_STATUS, &val);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s: Error in reading reg 0x%x\n",\r\n__func__, TPS65217_REG_STATUS);\r\nreturn IRQ_HANDLED;\r\n}\r\ndev_dbg(charger->dev, "%s: 0x%x\n", __func__, val);\r\nif (val & CHARGER_STATUS_PRESENT) {\r\nret = tps65217_enable_charging(charger);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"failed to enable charger: %d\n", ret);\r\nreturn IRQ_HANDLED;\r\n}\r\n} else {\r\ncharger->online = 0;\r\n}\r\nif (charger->prev_online != charger->online)\r\npower_supply_changed(charger->psy);\r\nret = tps65217_reg_read(charger->tps, TPS65217_REG_CHGCONFIG0, &val);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s: Error in reading reg 0x%x\n",\r\n__func__, TPS65217_REG_CHGCONFIG0);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (val & TPS65217_CHGCONFIG0_ACTIVE)\r\ndev_dbg(charger->dev, "%s: charger is charging\n", __func__);\r\nelse\r\ndev_dbg(charger->dev,\r\n"%s: charger is NOT charging\n", __func__);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tps65217_charger_poll_task(void *data)\r\n{\r\nset_freezable();\r\nwhile (!kthread_should_stop()) {\r\nschedule_timeout_interruptible(POLL_INTERVAL);\r\ntry_to_freeze();\r\ntps65217_charger_irq(-1, data);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65217_charger *charger;\r\nstruct power_supply_config cfg = {};\r\nstruct task_struct *poll_task;\r\nint irq[NUM_CHARGER_IRQS];\r\nint ret;\r\nint i;\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\r\nif (!charger)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, charger);\r\ncharger->tps = tps;\r\ncharger->dev = &pdev->dev;\r\ncfg.of_node = pdev->dev.of_node;\r\ncfg.drv_data = charger;\r\ncharger->psy = devm_power_supply_register(&pdev->dev,\r\n&tps65217_charger_desc,\r\n&cfg);\r\nif (IS_ERR(charger->psy)) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nreturn PTR_ERR(charger->psy);\r\n}\r\nirq[0] = platform_get_irq_byname(pdev, "USB");\r\nirq[1] = platform_get_irq_byname(pdev, "AC");\r\nret = tps65217_config_charger(charger);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "charger config failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nif (irq[0] < 0 || irq[1] < 0) {\r\npoll_task = kthread_run(tps65217_charger_poll_task,\r\ncharger, "ktps65217charger");\r\nif (IS_ERR(poll_task)) {\r\nret = PTR_ERR(poll_task);\r\ndev_err(charger->dev,\r\n"Unable to run kthread err %d\n", ret);\r\nreturn ret;\r\n}\r\ncharger->poll_task = poll_task;\r\nreturn 0;\r\n}\r\nfor (i = 0; i < NUM_CHARGER_IRQS; i++) {\r\nret = devm_request_threaded_irq(&pdev->dev, irq[i], NULL,\r\ntps65217_charger_irq,\r\n0, "tps65217-charger",\r\ncharger);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"Unable to register irq %d err %d\n", irq[i],\r\nret);\r\nreturn ret;\r\n}\r\ntps65217_charger_irq(-1, charger);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct tps65217_charger *charger = platform_get_drvdata(pdev);\r\nif (charger->poll_task)\r\nkthread_stop(charger->poll_task);\r\nreturn 0;\r\n}

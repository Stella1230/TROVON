static unsigned int\r\nlog_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_log_info *loginfo = par->targinfo;\r\nstruct net *net = xt_net(par);\r\nstruct nf_loginfo li;\r\nli.type = NF_LOG_TYPE_LOG;\r\nli.u.log.level = loginfo->level;\r\nli.u.log.logflags = loginfo->logflags;\r\nnf_log_packet(net, xt_family(par), xt_hooknum(par), skb, xt_in(par),\r\nxt_out(par), &li, "%s", loginfo->prefix);\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int log_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct xt_log_info *loginfo = par->targinfo;\r\nif (par->family != NFPROTO_IPV4 && par->family != NFPROTO_IPV6)\r\nreturn -EINVAL;\r\nif (loginfo->level >= 8) {\r\npr_debug("level %u >= 8\n", loginfo->level);\r\nreturn -EINVAL;\r\n}\r\nif (loginfo->prefix[sizeof(loginfo->prefix)-1] != '\0') {\r\npr_debug("prefix is not null-terminated\n");\r\nreturn -EINVAL;\r\n}\r\nreturn nf_logger_find_get(par->family, NF_LOG_TYPE_LOG);\r\n}\r\nstatic void log_tg_destroy(const struct xt_tgdtor_param *par)\r\n{\r\nnf_logger_put(par->family, NF_LOG_TYPE_LOG);\r\n}\r\nstatic int __init log_tg_init(void)\r\n{\r\nreturn xt_register_targets(log_tg_regs, ARRAY_SIZE(log_tg_regs));\r\n}\r\nstatic void __exit log_tg_exit(void)\r\n{\r\nxt_unregister_targets(log_tg_regs, ARRAY_SIZE(log_tg_regs));\r\n}

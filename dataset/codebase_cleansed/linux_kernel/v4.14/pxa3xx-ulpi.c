static inline u32 u2d_readl(u32 reg)\r\n{\r\nreturn __raw_readl(u2d->mmio_base + reg);\r\n}\r\nstatic inline void u2d_writel(u32 reg, u32 val)\r\n{\r\n__raw_writel(val, u2d->mmio_base + reg);\r\n}\r\nstatic inline enum u2d_ulpi_phy_mode pxa310_ulpi_get_phymode(void)\r\n{\r\nreturn (u2d_readl(U2DOTGUSR) >> 28) & 0xF;\r\n}\r\nstatic int pxa310_ulpi_poll(void)\r\n{\r\nint timeout = 50000;\r\nwhile (timeout--) {\r\nif (!(u2d_readl(U2DOTGUCR) & U2DOTGUCR_RUN))\r\nreturn 0;\r\ncpu_relax();\r\n}\r\npr_warn("%s: ULPI access timed out!\n", __func__);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int pxa310_ulpi_read(struct usb_phy *otg, u32 reg)\r\n{\r\nint err;\r\nif (pxa310_ulpi_get_phymode() != SYNCH) {\r\npr_warn("%s: PHY is not in SYNCH mode!\n", __func__);\r\nreturn -EBUSY;\r\n}\r\nu2d_writel(U2DOTGUCR, U2DOTGUCR_RUN | U2DOTGUCR_RNW | (reg << 16));\r\nmsleep(5);\r\nerr = pxa310_ulpi_poll();\r\nif (err)\r\nreturn err;\r\nreturn u2d_readl(U2DOTGUCR) & U2DOTGUCR_RDATA;\r\n}\r\nstatic int pxa310_ulpi_write(struct usb_phy *otg, u32 val, u32 reg)\r\n{\r\nif (pxa310_ulpi_get_phymode() != SYNCH) {\r\npr_warn("%s: PHY is not in SYNCH mode!\n", __func__);\r\nreturn -EBUSY;\r\n}\r\nu2d_writel(U2DOTGUCR, U2DOTGUCR_RUN | (reg << 16) | (val << 8));\r\nmsleep(5);\r\nreturn pxa310_ulpi_poll();\r\n}\r\nstatic void pxa310_otg_transceiver_rtsm(void)\r\n{\r\nu32 u2dotgcr;\r\nu2dotgcr = u2d_readl(U2DOTGCR);\r\nu2dotgcr |= U2DOTGCR_RTSM | U2DOTGCR_UTMID;\r\nu2d_writel(U2DOTGCR, u2dotgcr);\r\nmsleep(10);\r\nu2dotgcr = u2d_readl(U2DOTGCR);\r\nu2dotgcr |= U2DOTGCR_ULAF;\r\nu2dotgcr &= ~(U2DOTGCR_SMAF | U2DOTGCR_CKAF);\r\nu2d_writel(U2DOTGCR, u2dotgcr);\r\n}\r\nstatic int pxa310_start_otg_host_transcvr(struct usb_bus *host)\r\n{\r\nint err;\r\npxa310_otg_transceiver_rtsm();\r\nerr = usb_phy_init(u2d->otg);\r\nif (err) {\r\npr_err("OTG transceiver init failed");\r\nreturn err;\r\n}\r\nerr = otg_set_vbus(u2d->otg->otg, 1);\r\nif (err) {\r\npr_err("OTG transceiver VBUS set failed");\r\nreturn err;\r\n}\r\nerr = otg_set_host(u2d->otg->otg, host);\r\nif (err)\r\npr_err("OTG transceiver Host mode set failed");\r\nreturn err;\r\n}\r\nstatic int pxa310_start_otg_hc(struct usb_bus *host)\r\n{\r\nu32 u2dotgcr;\r\nint err;\r\nu2d_writel(U2DCR, u2d_readl(U2DCR) & ~U2DCR_UDE);\r\nu2d_writel(U2DOTGCR, u2d_readl(U2DOTGCR) | U2DOTGCR_UTMID);\r\nu2d_writel(U2DOTGICR, u2d_readl(U2DOTGICR) & ~0x37F7F);\r\nerr = pxa310_start_otg_host_transcvr(host);\r\nif (err)\r\nreturn err;\r\nif (u2d->ulpi_mode & ULPI_IC_6PIN_SERIAL)\r\nu2d_writel(U2DP3CR, u2d_readl(U2DP3CR) & ~U2DP3CR_P2SS);\r\nelse if (u2d->ulpi_mode & ULPI_IC_3PIN_SERIAL)\r\nu2d_writel(U2DP3CR, u2d_readl(U2DP3CR) | U2DP3CR_P2SS);\r\nu2dotgcr = u2d_readl(U2DOTGCR) | U2DOTGCR_SMAF;\r\nu2d_writel(U2DOTGCR, u2dotgcr & ~(U2DOTGCR_ULAF | U2DOTGCR_CKAF));\r\nreturn 0;\r\n}\r\nstatic void pxa310_stop_otg_hc(void)\r\n{\r\npxa310_otg_transceiver_rtsm();\r\notg_set_host(u2d->otg->otg, NULL);\r\notg_set_vbus(u2d->otg->otg, 0);\r\nusb_phy_shutdown(u2d->otg);\r\n}\r\nstatic void pxa310_u2d_setup_otg_hc(void)\r\n{\r\nu32 u2dotgcr;\r\nu2dotgcr = u2d_readl(U2DOTGCR);\r\nu2dotgcr |= U2DOTGCR_ULAF | U2DOTGCR_UTMID;\r\nu2dotgcr &= ~(U2DOTGCR_SMAF | U2DOTGCR_CKAF);\r\nu2d_writel(U2DOTGCR, u2dotgcr);\r\nmsleep(5);\r\nu2d_writel(U2DOTGCR, u2dotgcr | U2DOTGCR_ULE);\r\nmsleep(5);\r\nu2d_writel(U2DOTGICR, u2d_readl(U2DOTGICR) & ~0x37F7F);\r\n}\r\nstatic int pxa310_otg_init(struct pxa3xx_u2d_platform_data *pdata)\r\n{\r\nunsigned int ulpi_mode = ULPI_OTG_DRVVBUS;\r\nif (pdata) {\r\nif (pdata->ulpi_mode & ULPI_SER_6PIN)\r\nulpi_mode |= ULPI_IC_6PIN_SERIAL;\r\nelse if (pdata->ulpi_mode & ULPI_SER_3PIN)\r\nulpi_mode |= ULPI_IC_3PIN_SERIAL;\r\n}\r\nu2d->ulpi_mode = ulpi_mode;\r\nu2d->otg = otg_ulpi_create(&pxa310_ulpi_access_ops, ulpi_mode);\r\nif (!u2d->otg)\r\nreturn -ENOMEM;\r\nu2d->otg->io_priv = u2d->mmio_base;\r\nreturn 0;\r\n}\r\nstatic void pxa310_otg_exit(void)\r\n{\r\nkfree(u2d->otg);\r\n}\r\nstatic inline void pxa310_u2d_setup_otg_hc(void) {}\r\nstatic inline int pxa310_start_otg_hc(struct usb_bus *host)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void pxa310_stop_otg_hc(void) {}\r\nstatic inline int pxa310_otg_init(struct pxa3xx_u2d_platform_data *pdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void pxa310_otg_exit(void) {}\r\nint pxa3xx_u2d_start_hc(struct usb_bus *host)\r\n{\r\nint err = 0;\r\nif (!u2d)\r\nreturn 0;\r\nclk_enable(u2d->clk);\r\nif (cpu_is_pxa310()) {\r\npxa310_u2d_setup_otg_hc();\r\nerr = pxa310_start_otg_hc(host);\r\n}\r\nreturn err;\r\n}\r\nvoid pxa3xx_u2d_stop_hc(struct usb_bus *host)\r\n{\r\nif (!u2d)\r\nreturn;\r\nif (cpu_is_pxa310())\r\npxa310_stop_otg_hc();\r\nclk_disable(u2d->clk);\r\n}\r\nstatic int pxa3xx_u2d_probe(struct platform_device *pdev)\r\n{\r\nstruct pxa3xx_u2d_platform_data *pdata = pdev->dev.platform_data;\r\nstruct resource *r;\r\nint err;\r\nu2d = kzalloc(sizeof(*u2d), GFP_KERNEL);\r\nif (!u2d)\r\nreturn -ENOMEM;\r\nu2d->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(u2d->clk)) {\r\ndev_err(&pdev->dev, "failed to get u2d clock\n");\r\nerr = PTR_ERR(u2d->clk);\r\ngoto err_free_mem;\r\n}\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!r) {\r\ndev_err(&pdev->dev, "no IO memory resource defined\n");\r\nerr = -ENODEV;\r\ngoto err_put_clk;\r\n}\r\nr = request_mem_region(r->start, resource_size(r), pdev->name);\r\nif (!r) {\r\ndev_err(&pdev->dev, "failed to request memory resource\n");\r\nerr = -EBUSY;\r\ngoto err_put_clk;\r\n}\r\nu2d->mmio_base = ioremap(r->start, resource_size(r));\r\nif (!u2d->mmio_base) {\r\ndev_err(&pdev->dev, "ioremap() failed\n");\r\nerr = -ENODEV;\r\ngoto err_free_res;\r\n}\r\nif (pdata->init) {\r\nerr = pdata->init(&pdev->dev);\r\nif (err)\r\ngoto err_free_io;\r\n}\r\nif (cpu_is_pxa310()) {\r\nerr = pxa310_otg_init(pdata);\r\nif (err)\r\ngoto err_free_plat;\r\n}\r\nplatform_set_drvdata(pdev, &u2d);\r\nreturn 0;\r\nerr_free_plat:\r\nif (pdata->exit)\r\npdata->exit(&pdev->dev);\r\nerr_free_io:\r\niounmap(u2d->mmio_base);\r\nerr_free_res:\r\nrelease_mem_region(r->start, resource_size(r));\r\nerr_put_clk:\r\nclk_put(u2d->clk);\r\nerr_free_mem:\r\nkfree(u2d);\r\nreturn err;\r\n}\r\nstatic int pxa3xx_u2d_remove(struct platform_device *pdev)\r\n{\r\nstruct pxa3xx_u2d_platform_data *pdata = pdev->dev.platform_data;\r\nstruct resource *r;\r\nif (cpu_is_pxa310()) {\r\npxa310_stop_otg_hc();\r\npxa310_otg_exit();\r\n}\r\nif (pdata->exit)\r\npdata->exit(&pdev->dev);\r\nplatform_set_drvdata(pdev, NULL);\r\niounmap(u2d->mmio_base);\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrelease_mem_region(r->start, resource_size(r));\r\nclk_put(u2d->clk);\r\nkfree(u2d);\r\nreturn 0;\r\n}

int ish_init(struct ishtp_device *dev)\r\n{\r\nint ret;\r\nret = ish_hw_start(dev);\r\nif (ret) {\r\ndev_err(dev->devc, "ISH: hw start failed.\n");\r\nreturn ret;\r\n}\r\nret = ishtp_start(dev);\r\nif (ret) {\r\ndev_err(dev->devc, "ISHTP: Protocol init failed.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ish_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct ishtp_device *dev;\r\nstruct ish_hw *hw;\r\nint ret;\r\nret = pci_enable_device(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "ISH: Failed to enable PCI device\n");\r\nreturn ret;\r\n}\r\npci_set_master(pdev);\r\nret = pci_request_regions(pdev, KBUILD_MODNAME);\r\nif (ret) {\r\ndev_err(&pdev->dev, "ISH: Failed to get PCI regions\n");\r\ngoto disable_device;\r\n}\r\ndev = ish_dev_init(pdev);\r\nif (!dev) {\r\nret = -ENOMEM;\r\ngoto release_regions;\r\n}\r\nhw = to_ish_hw(dev);\r\ndev->print_log = ish_event_tracer;\r\nhw->mem_addr = pci_iomap(pdev, 0, 0);\r\nif (!hw->mem_addr) {\r\ndev_err(&pdev->dev, "ISH: mapping I/O range failure\n");\r\nret = -ENOMEM;\r\ngoto free_device;\r\n}\r\ndev->pdev = pdev;\r\npdev->dev_flags |= PCI_DEV_FLAGS_NO_D3;\r\nret = request_irq(pdev->irq, ish_irq_handler, IRQF_SHARED,\r\nKBUILD_MODNAME, dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "ISH: request IRQ failure (%d)\n",\r\npdev->irq);\r\ngoto free_device;\r\n}\r\ndev_set_drvdata(dev->devc, dev);\r\ninit_waitqueue_head(&dev->suspend_wait);\r\ninit_waitqueue_head(&dev->resume_wait);\r\nret = ish_init(dev);\r\nif (ret)\r\ngoto free_irq;\r\nreturn 0;\r\nfree_irq:\r\nfree_irq(pdev->irq, dev);\r\nfree_device:\r\npci_iounmap(pdev, hw->mem_addr);\r\nkfree(dev);\r\nrelease_regions:\r\npci_release_regions(pdev);\r\ndisable_device:\r\npci_clear_master(pdev);\r\npci_disable_device(pdev);\r\ndev_err(&pdev->dev, "ISH: PCI driver initialization failed.\n");\r\nreturn ret;\r\n}\r\nstatic void ish_remove(struct pci_dev *pdev)\r\n{\r\nstruct ishtp_device *ishtp_dev = pci_get_drvdata(pdev);\r\nstruct ish_hw *hw = to_ish_hw(ishtp_dev);\r\nishtp_bus_remove_all_clients(ishtp_dev, false);\r\nish_device_disable(ishtp_dev);\r\nfree_irq(pdev->irq, ishtp_dev);\r\npci_iounmap(pdev, hw->mem_addr);\r\npci_release_regions(pdev);\r\npci_clear_master(pdev);\r\npci_disable_device(pdev);\r\nkfree(ishtp_dev);\r\n}\r\nstatic void ish_resume_handler(struct work_struct *work)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ish_resume_device);\r\nstruct ishtp_device *dev = pci_get_drvdata(pdev);\r\nuint32_t fwsts;\r\nint ret;\r\nfwsts = IPC_GET_ISH_FWSTS(dev->ops->get_fw_status(dev));\r\nif (fwsts >= FWSTS_SENSOR_APP_LOADED) {\r\nishtp_send_resume(dev);\r\nif (dev->resume_flag)\r\nret = wait_event_interruptible_timeout(dev->resume_wait,\r\n!dev->resume_flag,\r\nmsecs_to_jiffies(WAIT_FOR_RESUME_ACK_MS));\r\n}\r\nif (dev->resume_flag)\r\nish_init(dev);\r\n}\r\nstatic int ish_suspend(struct device *device)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(device);\r\nstruct ishtp_device *dev = pci_get_drvdata(pdev);\r\nenable_irq_wake(pdev->irq);\r\nif (dev->suspend_flag)\r\nreturn 0;\r\ndev->resume_flag = 0;\r\ndev->suspend_flag = 1;\r\nishtp_send_suspend(dev);\r\nif (dev->suspend_flag)\r\nwait_event_interruptible_timeout(dev->suspend_wait,\r\n!dev->suspend_flag,\r\nmsecs_to_jiffies(25));\r\nreturn 0;\r\n}\r\nstatic int ish_resume(struct device *device)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(device);\r\nstruct ishtp_device *dev = pci_get_drvdata(pdev);\r\nish_resume_device = device;\r\ndev->resume_flag = 1;\r\ndisable_irq_wake(pdev->irq);\r\nschedule_work(&resume_work);\r\nreturn 0;\r\n}

static int bcm_ns_usb2_phy_init(struct phy *phy)\r\n{\r\nstruct bcm_ns_usb2 *usb2 = phy_get_drvdata(phy);\r\nstruct device *dev = usb2->dev;\r\nvoid __iomem *dmu = usb2->dmu;\r\nu32 ref_clk_rate, usb2ctl, usb_pll_ndiv, usb_pll_pdiv;\r\nint err = 0;\r\nerr = clk_prepare_enable(usb2->ref_clk);\r\nif (err < 0) {\r\ndev_err(dev, "Failed to prepare ref clock: %d\n", err);\r\ngoto err_out;\r\n}\r\nref_clk_rate = clk_get_rate(usb2->ref_clk);\r\nif (!ref_clk_rate) {\r\ndev_err(dev, "Failed to get ref clock rate\n");\r\nerr = -EINVAL;\r\ngoto err_clk_off;\r\n}\r\nusb2ctl = readl(dmu + BCMA_DMU_CRU_USB2_CONTROL);\r\nif (usb2ctl & BCMA_DMU_CRU_USB2_CONTROL_USB_PLL_PDIV_MASK) {\r\nusb_pll_pdiv = usb2ctl;\r\nusb_pll_pdiv &= BCMA_DMU_CRU_USB2_CONTROL_USB_PLL_PDIV_MASK;\r\nusb_pll_pdiv >>= BCMA_DMU_CRU_USB2_CONTROL_USB_PLL_PDIV_SHIFT;\r\n} else {\r\nusb_pll_pdiv = 1 << 3;\r\n}\r\nusb_pll_ndiv = (1920000000 * usb_pll_pdiv) / ref_clk_rate;\r\nwritel(0x0000ea68, dmu + BCMA_DMU_CRU_CLKSET_KEY);\r\nusb2ctl &= ~BCMA_DMU_CRU_USB2_CONTROL_USB_PLL_NDIV_MASK;\r\nusb2ctl |= usb_pll_ndiv << BCMA_DMU_CRU_USB2_CONTROL_USB_PLL_NDIV_SHIFT;\r\nwritel(usb2ctl, dmu + BCMA_DMU_CRU_USB2_CONTROL);\r\nwritel(0x00000000, dmu + BCMA_DMU_CRU_CLKSET_KEY);\r\nerr_clk_off:\r\nclk_disable_unprepare(usb2->ref_clk);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int bcm_ns_usb2_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct bcm_ns_usb2 *usb2;\r\nstruct resource *res;\r\nstruct phy_provider *phy_provider;\r\nusb2 = devm_kzalloc(&pdev->dev, sizeof(*usb2), GFP_KERNEL);\r\nif (!usb2)\r\nreturn -ENOMEM;\r\nusb2->dev = dev;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "dmu");\r\nusb2->dmu = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(usb2->dmu)) {\r\ndev_err(dev, "Failed to map DMU regs\n");\r\nreturn PTR_ERR(usb2->dmu);\r\n}\r\nusb2->ref_clk = devm_clk_get(dev, "phy-ref-clk");\r\nif (IS_ERR(usb2->ref_clk)) {\r\ndev_err(dev, "Clock not defined\n");\r\nreturn PTR_ERR(usb2->ref_clk);\r\n}\r\nusb2->phy = devm_phy_create(dev, NULL, &ops);\r\nif (IS_ERR(usb2->phy))\r\nreturn PTR_ERR(usb2->phy);\r\nphy_set_drvdata(usb2->phy, usb2);\r\nplatform_set_drvdata(pdev, usb2);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

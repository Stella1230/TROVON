void odm_NHMCounterStatisticsInit(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nrtw_write16(pDM_Odm->Adapter, ODM_REG_NHM_TIMER_11N+2, 0x2710);\r\nrtw_write16(pDM_Odm->Adapter, ODM_REG_NHM_TH9_TH10_11N+2, 0xffff);\r\nrtw_write32(pDM_Odm->Adapter, ODM_REG_NHM_TH3_TO_TH0_11N, 0xffffff52);\r\nrtw_write32(pDM_Odm->Adapter, ODM_REG_NHM_TH7_TO_TH4_11N, 0xffffffff);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_FPGA0_IQK_11N, bMaskByte0, 0xff);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_NHM_TH9_TH10_11N, BIT10|BIT9|BIT8, 0x7);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_OFDM_FA_RSTC_11N, BIT7, 0x1);\r\n}\r\nvoid odm_NHMCounterStatistics(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nodm_GetNHMCounterStatistics(pDM_Odm);\r\nodm_NHMCounterStatisticsReset(pDM_Odm);\r\n}\r\nvoid odm_GetNHMCounterStatistics(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nu32 value32 = 0;\r\nvalue32 = PHY_QueryBBReg(pDM_Odm->Adapter, ODM_REG_NHM_CNT_11N, bMaskDWord);\r\npDM_Odm->NHM_cnt_0 = (u8)(value32 & bMaskByte0);\r\n}\r\nvoid odm_NHMCounterStatisticsReset(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_NHM_TH9_TH10_11N, BIT1, 0);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_NHM_TH9_TH10_11N, BIT1, 1);\r\n}\r\nvoid odm_NHMBBInit(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDM_Odm->adaptivity_flag = 0;\r\npDM_Odm->tolerance_cnt = 3;\r\npDM_Odm->NHMLastTxOkcnt = 0;\r\npDM_Odm->NHMLastRxOkcnt = 0;\r\npDM_Odm->NHMCurTxOkcnt = 0;\r\npDM_Odm->NHMCurRxOkcnt = 0;\r\n}\r\nvoid odm_NHMBB(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDM_Odm->NHMCurTxOkcnt =\r\n*(pDM_Odm->pNumTxBytesUnicast)-pDM_Odm->NHMLastTxOkcnt;\r\npDM_Odm->NHMCurRxOkcnt =\r\n*(pDM_Odm->pNumRxBytesUnicast)-pDM_Odm->NHMLastRxOkcnt;\r\npDM_Odm->NHMLastTxOkcnt =\r\n*(pDM_Odm->pNumTxBytesUnicast);\r\npDM_Odm->NHMLastRxOkcnt =\r\n*(pDM_Odm->pNumRxBytesUnicast);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"NHM_cnt_0 =%d, NHMCurTxOkcnt = %llu, NHMCurRxOkcnt = %llu\n",\r\npDM_Odm->NHM_cnt_0,\r\npDM_Odm->NHMCurTxOkcnt,\r\npDM_Odm->NHMCurRxOkcnt\r\n)\r\n);\r\nif ((pDM_Odm->NHMCurTxOkcnt) + 1 > (u64)(pDM_Odm->NHMCurRxOkcnt<<2) + 1) {\r\nif (pDM_Odm->NHM_cnt_0 >= 190 || pDM_Odm->adaptivity_flag == true) {\r\npDM_Odm->adaptivity_flag = true;\r\npDM_Odm->tolerance_cnt = 0;\r\n} else {\r\nif (pDM_Odm->tolerance_cnt < 3)\r\npDM_Odm->tolerance_cnt = pDM_Odm->tolerance_cnt + 1;\r\nelse\r\npDM_Odm->tolerance_cnt = 4;\r\nif (pDM_Odm->tolerance_cnt > 3) {\r\npDM_Odm->adaptivity_flag = false;\r\n}\r\n}\r\n} else {\r\nif (pDM_Odm->adaptivity_flag == true && pDM_Odm->NHM_cnt_0 <= 200) {\r\npDM_Odm->tolerance_cnt = 0;\r\n} else {\r\nif (pDM_Odm->tolerance_cnt < 3)\r\npDM_Odm->tolerance_cnt = pDM_Odm->tolerance_cnt + 1;\r\nelse\r\npDM_Odm->tolerance_cnt = 4;\r\nif (pDM_Odm->tolerance_cnt > 3) {\r\npDM_Odm->adaptivity_flag = false;\r\n}\r\n}\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("adaptivity_flag = %d\n ", pDM_Odm->adaptivity_flag));\r\n}\r\nvoid odm_SearchPwdBLowerBound(void *pDM_VOID, u8 IGI_target)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nu32 value32 = 0;\r\nu8 cnt, IGI;\r\nbool bAdjust = true;\r\ns8 TH_L2H_dmc, TH_H2L_dmc;\r\ns8 Diff;\r\nIGI = 0x50;\r\nODM_Write_DIG(pDM_Odm, IGI);\r\nDiff = IGI_target-(s8)IGI;\r\nTH_L2H_dmc = pDM_Odm->TH_L2H_ini + Diff;\r\nif (TH_L2H_dmc > 10)\r\nTH_L2H_dmc = 10;\r\nTH_H2L_dmc = TH_L2H_dmc - pDM_Odm->TH_EDCCA_HL_diff;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte0, (u8)TH_L2H_dmc);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte2, (u8)TH_H2L_dmc);\r\nmdelay(5);\r\nwhile (bAdjust) {\r\nfor (cnt = 0; cnt < 20; cnt++) {\r\nvalue32 = PHY_QueryBBReg(pDM_Odm->Adapter, ODM_REG_RPT_11N, bMaskDWord);\r\nif (value32 & BIT30)\r\npDM_Odm->txEdcca1 = pDM_Odm->txEdcca1 + 1;\r\nelse if (value32 & BIT29)\r\npDM_Odm->txEdcca1 = pDM_Odm->txEdcca1 + 1;\r\nelse\r\npDM_Odm->txEdcca0 = pDM_Odm->txEdcca0 + 1;\r\n}\r\nif (pDM_Odm->txEdcca1 > 5) {\r\nIGI = IGI-1;\r\nTH_L2H_dmc = TH_L2H_dmc + 1;\r\nif (TH_L2H_dmc > 10)\r\nTH_L2H_dmc = 10;\r\nTH_H2L_dmc = TH_L2H_dmc - pDM_Odm->TH_EDCCA_HL_diff;\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte0, (u8)TH_L2H_dmc);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte2, (u8)TH_H2L_dmc);\r\npDM_Odm->TxHangFlg = true;\r\npDM_Odm->txEdcca1 = 0;\r\npDM_Odm->txEdcca0 = 0;\r\nif (TH_L2H_dmc == 10) {\r\nbAdjust = false;\r\npDM_Odm->TxHangFlg = false;\r\npDM_Odm->txEdcca1 = 0;\r\npDM_Odm->txEdcca0 = 0;\r\npDM_Odm->H2L_lb = TH_H2L_dmc;\r\npDM_Odm->L2H_lb = TH_L2H_dmc;\r\npDM_Odm->Adaptivity_IGI_upper = IGI;\r\n}\r\n} else {\r\nbAdjust = false;\r\npDM_Odm->TxHangFlg = false;\r\npDM_Odm->txEdcca1 = 0;\r\npDM_Odm->txEdcca0 = 0;\r\npDM_Odm->H2L_lb = TH_H2L_dmc;\r\npDM_Odm->L2H_lb = TH_L2H_dmc;\r\npDM_Odm->Adaptivity_IGI_upper = IGI;\r\n}\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("IGI = 0x%x, H2L_lb = 0x%x, L2H_lb = 0x%x\n", IGI, pDM_Odm->H2L_lb, pDM_Odm->L2H_lb));\r\n}\r\nvoid odm_AdaptivityInit(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nif (pDM_Odm->Carrier_Sense_enable == false)\r\npDM_Odm->TH_L2H_ini = 0xf7;\r\nelse\r\npDM_Odm->TH_L2H_ini = 0xa;\r\npDM_Odm->AdapEn_RSSI = 20;\r\npDM_Odm->TH_EDCCA_HL_diff = 7;\r\npDM_Odm->IGI_Base = 0x32;\r\npDM_Odm->IGI_target = 0x1c;\r\npDM_Odm->ForceEDCCA = 0;\r\npDM_Odm->NHM_disable = false;\r\npDM_Odm->TxHangFlg = true;\r\npDM_Odm->txEdcca0 = 0;\r\npDM_Odm->txEdcca1 = 0;\r\npDM_Odm->H2L_lb = 0;\r\npDM_Odm->L2H_lb = 0;\r\npDM_Odm->Adaptivity_IGI_upper = 0;\r\nodm_NHMBBInit(pDM_Odm);\r\nPHY_SetBBReg(pDM_Odm->Adapter, REG_RD_CTRL, BIT11, 1);\r\n}\r\nvoid odm_Adaptivity(void *pDM_VOID, u8 IGI)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\ns8 TH_L2H_dmc, TH_H2L_dmc;\r\ns8 Diff, IGI_target;\r\nbool EDCCA_State = false;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_ADAPTIVITY)) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("Go to odm_DynamicEDCCA()\n"));\r\nreturn;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_Adaptivity() =====>\n"));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("ForceEDCCA =%d, IGI_Base = 0x%x, TH_L2H_ini = %d, TH_EDCCA_HL_diff = %d, AdapEn_RSSI = %d\n",\r\npDM_Odm->ForceEDCCA, pDM_Odm->IGI_Base, pDM_Odm->TH_L2H_ini, pDM_Odm->TH_EDCCA_HL_diff, pDM_Odm->AdapEn_RSSI));\r\nif (*pDM_Odm->pBandWidth == ODM_BW20M)\r\nIGI_target = pDM_Odm->IGI_Base;\r\nelse if (*pDM_Odm->pBandWidth == ODM_BW40M)\r\nIGI_target = pDM_Odm->IGI_Base + 2;\r\nelse if (*pDM_Odm->pBandWidth == ODM_BW80M)\r\nIGI_target = pDM_Odm->IGI_Base + 2;\r\nelse\r\nIGI_target = pDM_Odm->IGI_Base;\r\npDM_Odm->IGI_target = (u8) IGI_target;\r\nif (pDM_Odm->TxHangFlg == true) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_DBG_RPT_11N, bMaskDWord, 0x208);\r\nodm_SearchPwdBLowerBound(pDM_Odm, pDM_Odm->IGI_target);\r\n}\r\nif ((!pDM_Odm->bLinked) || (*pDM_Odm->pChannel > 149)) {\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte0, 0x7f);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte2, 0x7f);\r\nreturn;\r\n}\r\nif (!pDM_Odm->ForceEDCCA) {\r\nif (pDM_Odm->RSSI_Min > pDM_Odm->AdapEn_RSSI)\r\nEDCCA_State = true;\r\nelse if (pDM_Odm->RSSI_Min < (pDM_Odm->AdapEn_RSSI - 5))\r\nEDCCA_State = false;\r\n} else\r\nEDCCA_State = true;\r\nif (\r\npDM_Odm->bLinked &&\r\npDM_Odm->Carrier_Sense_enable == false &&\r\npDM_Odm->NHM_disable == false &&\r\npDM_Odm->TxHangFlg == false\r\n)\r\nodm_NHMBB(pDM_Odm);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"BandWidth =%s, IGI_target = 0x%x, EDCCA_State =%d\n",\r\n(*pDM_Odm->pBandWidth == ODM_BW80M) ? "80M" :\r\n((*pDM_Odm->pBandWidth == ODM_BW40M) ? "40M" : "20M"),\r\nIGI_target,\r\nEDCCA_State\r\n)\r\n);\r\nif (EDCCA_State) {\r\nDiff = IGI_target-(s8)IGI;\r\nTH_L2H_dmc = pDM_Odm->TH_L2H_ini + Diff;\r\nif (TH_L2H_dmc > 10)\r\nTH_L2H_dmc = 10;\r\nTH_H2L_dmc = TH_L2H_dmc - pDM_Odm->TH_EDCCA_HL_diff;\r\nif (TH_H2L_dmc < pDM_Odm->H2L_lb)\r\nTH_H2L_dmc = pDM_Odm->H2L_lb;\r\nif (TH_L2H_dmc < pDM_Odm->L2H_lb)\r\nTH_L2H_dmc = pDM_Odm->L2H_lb;\r\n} else {\r\nTH_L2H_dmc = 0x7f;\r\nTH_H2L_dmc = 0x7f;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("IGI = 0x%x, TH_L2H_dmc = %d, TH_H2L_dmc = %d\n",\r\nIGI, TH_L2H_dmc, TH_H2L_dmc));\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte0, (u8)TH_L2H_dmc);\r\nPHY_SetBBReg(pDM_Odm->Adapter, rOFDM0_ECCAThreshold, bMaskByte2, (u8)TH_H2L_dmc);\r\n}\r\nvoid ODM_Write_DIG(void *pDM_VOID, u8 CurrentIGI)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nif (pDM_DigTable->bStopDIG) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("Stop Writing IGI\n"));\r\nreturn;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_TRACE, ("ODM_REG(IGI_A, pDM_Odm) = 0x%x, ODM_BIT(IGI, pDM_Odm) = 0x%x\n",\r\nODM_REG(IGI_A, pDM_Odm), ODM_BIT(IGI, pDM_Odm)));\r\nif (pDM_DigTable->CurIGValue != CurrentIGI) {\r\nif (!pDM_DigTable->bPSDInProgress) {\r\nif (CurrentIGI > pDM_DigTable->rx_gain_range_max) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_TRACE, ("CurrentIGI(0x%02x) is larger than upper bound !!\n", pDM_DigTable->rx_gain_range_max));\r\nCurrentIGI = pDM_DigTable->rx_gain_range_max;\r\n}\r\n}\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG(IGI_A, pDM_Odm), ODM_BIT(IGI, pDM_Odm), CurrentIGI);\r\nif (pDM_Odm->RFType > ODM_1T1R)\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG(IGI_B, pDM_Odm), ODM_BIT(IGI, pDM_Odm), CurrentIGI);\r\npDM_DigTable->CurIGValue = CurrentIGI;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_TRACE, ("CurrentIGI(0x%02x).\n", CurrentIGI));\r\n}\r\nvoid odm_PauseDIG(\r\nvoid *pDM_VOID,\r\nODM_Pause_DIG_TYPE PauseType,\r\nu8 IGIValue\r\n)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nstatic bool bPaused;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG() =========>\n"));\r\nif (\r\n(pDM_Odm->SupportAbility & ODM_BB_ADAPTIVITY) &&\r\npDM_Odm->TxHangFlg == true\r\n) {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_PauseDIG(): Dynamic adjust threshold in progress !!\n")\r\n);\r\nreturn;\r\n}\r\nif (\r\n!bPaused && (!(pDM_Odm->SupportAbility & ODM_BB_DIG) ||\r\n!(pDM_Odm->SupportAbility & ODM_BB_FA_CNT))\r\n){\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_PauseDIG(): Return: SupportAbility ODM_BB_DIG or ODM_BB_FA_CNT is disabled\n")\r\n);\r\nreturn;\r\n}\r\nswitch (PauseType) {\r\ncase ODM_PAUSE_DIG:\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pDM_Odm->SupportAbility & (~ODM_BB_DIG));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Pause DIG !!\n"));\r\nif (!bPaused) {\r\npDM_DigTable->IGIBackup = pDM_DigTable->CurIGValue;\r\nbPaused = true;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Backup IGI = 0x%x\n", pDM_DigTable->IGIBackup));\r\nODM_Write_DIG(pDM_Odm, IGIValue);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Write new IGI = 0x%x\n", IGIValue));\r\nbreak;\r\ncase ODM_RESUME_DIG:\r\nif (bPaused) {\r\nODM_Write_DIG(pDM_Odm, pDM_DigTable->IGIBackup);\r\nbPaused = false;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Write original IGI = 0x%x\n", pDM_DigTable->IGIBackup));\r\nODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pDM_Odm->SupportAbility | ODM_BB_DIG);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Resume DIG !!\n"));\r\n}\r\nbreak;\r\ndefault:\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_PauseDIG(): Wrong type !!\n"));\r\nbreak;\r\n}\r\n}\r\nbool odm_DigAbort(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_FA_CNT)) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Return: SupportAbility ODM_BB_FA_CNT is disabled\n"));\r\nreturn true;\r\n}\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_DIG)) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Return: SupportAbility ODM_BB_DIG is disabled\n"));\r\nreturn true;\r\n}\r\nif (*(pDM_Odm->pbScanInProcess)) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Return: In Scan Progress\n"));\r\nreturn true;\r\n}\r\nif (pDM_Odm->bDMInitialGainEnable == false) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Return: PSD is Processing\n"));\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid odm_DIGInit(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\npDM_DigTable->bStopDIG = false;\r\npDM_DigTable->bPSDInProgress = false;\r\npDM_DigTable->CurIGValue = (u8) PHY_QueryBBReg(pDM_Odm->Adapter, ODM_REG(IGI_A, pDM_Odm), ODM_BIT(IGI, pDM_Odm));\r\npDM_DigTable->RssiLowThresh = DM_DIG_THRESH_LOW;\r\npDM_DigTable->RssiHighThresh = DM_DIG_THRESH_HIGH;\r\npDM_DigTable->FALowThresh = DMfalseALARM_THRESH_LOW;\r\npDM_DigTable->FAHighThresh = DMfalseALARM_THRESH_HIGH;\r\npDM_DigTable->BackoffVal = DM_DIG_BACKOFF_DEFAULT;\r\npDM_DigTable->BackoffVal_range_max = DM_DIG_BACKOFF_MAX;\r\npDM_DigTable->BackoffVal_range_min = DM_DIG_BACKOFF_MIN;\r\npDM_DigTable->PreCCK_CCAThres = 0xFF;\r\npDM_DigTable->CurCCK_CCAThres = 0x83;\r\npDM_DigTable->ForbiddenIGI = DM_DIG_MIN_NIC;\r\npDM_DigTable->LargeFAHit = 0;\r\npDM_DigTable->Recover_cnt = 0;\r\npDM_DigTable->bMediaConnect_0 = false;\r\npDM_DigTable->bMediaConnect_1 = false;\r\npDM_Odm->bDMInitialGainEnable = true;\r\npDM_DigTable->DIG_Dynamic_MIN_0 = DM_DIG_MIN_NIC;\r\npDM_DigTable->DIG_Dynamic_MIN_1 = DM_DIG_MIN_NIC;\r\npDM_DigTable->BT30_CurIGI = 0x32;\r\nif (pDM_Odm->BoardType & (ODM_BOARD_EXT_PA|ODM_BOARD_EXT_LNA)) {\r\npDM_DigTable->rx_gain_range_max = DM_DIG_MAX_NIC;\r\npDM_DigTable->rx_gain_range_min = DM_DIG_MIN_NIC;\r\n} else {\r\npDM_DigTable->rx_gain_range_max = DM_DIG_MAX_NIC;\r\npDM_DigTable->rx_gain_range_min = DM_DIG_MIN_NIC;\r\n}\r\n}\r\nvoid odm_DIG(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nPfalse_ALARM_STATISTICS pFalseAlmCnt = &pDM_Odm->FalseAlmCnt;\r\nbool FirstConnect, FirstDisConnect;\r\nu8 DIG_MaxOfMin, DIG_Dynamic_MIN;\r\nu8 dm_dig_max, dm_dig_min;\r\nu8 CurrentIGI = pDM_DigTable->CurIGValue;\r\nu8 offset;\r\nu32 dm_FA_thres[3];\r\nu8 Adap_IGI_Upper = 0;\r\nu32 TxTp = 0, RxTp = 0;\r\nbool bDFSBand = false;\r\nbool bPerformance = true, bFirstTpTarget = false, bFirstCoverage = false;\r\nif (odm_DigAbort(pDM_Odm) == true)\r\nreturn;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG() ===========================>\n\n"));\r\nif (pDM_Odm->adaptivity_flag == true)\r\nAdap_IGI_Upper = pDM_Odm->Adaptivity_IGI_upper;\r\nDIG_Dynamic_MIN = pDM_DigTable->DIG_Dynamic_MIN_0;\r\nFirstConnect = (pDM_Odm->bLinked) && (pDM_DigTable->bMediaConnect_0 == false);\r\nFirstDisConnect = (!pDM_Odm->bLinked) && (pDM_DigTable->bMediaConnect_0 == true);\r\ndm_dig_max = 0x5A;\r\ndm_dig_min = DM_DIG_MIN_NIC;\r\nDIG_MaxOfMin = DM_DIG_MAX_AP;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Absolutly upper bound = 0x%x, lower bound = 0x%x\n", dm_dig_max, dm_dig_min));\r\nif (pDM_Odm->bLinked && bPerformance) {\r\nif (pDM_Odm->bBtLimitedDig == 1) {\r\noffset = 10;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Coex. case: Force upper bound to RSSI + %d !!!!!!\n", offset));\r\n} else\r\noffset = 15;\r\nif ((pDM_Odm->RSSI_Min + offset) > dm_dig_max)\r\npDM_DigTable->rx_gain_range_max = dm_dig_max;\r\nelse if ((pDM_Odm->RSSI_Min + offset) < dm_dig_min)\r\npDM_DigTable->rx_gain_range_max = dm_dig_min;\r\nelse\r\npDM_DigTable->rx_gain_range_max = pDM_Odm->RSSI_Min + offset;\r\n{\r\nif (pDM_Odm->RSSI_Min < dm_dig_min)\r\nDIG_Dynamic_MIN = dm_dig_min;\r\nelse if (pDM_Odm->RSSI_Min > DIG_MaxOfMin)\r\nDIG_Dynamic_MIN = DIG_MaxOfMin;\r\nelse\r\nDIG_Dynamic_MIN = pDM_Odm->RSSI_Min;\r\n}\r\n} else {\r\npDM_DigTable->rx_gain_range_max = dm_dig_max;\r\nDIG_Dynamic_MIN = dm_dig_min;\r\n}\r\nif (pDM_Odm->bLinked && !pDM_Odm->bOneEntryOnly) {\r\nif (pDM_Odm->SupportAbility & ODM_BB_ANT_DIV) {\r\nif (\r\npDM_Odm->AntDivType == CG_TRX_HW_ANTDIV ||\r\npDM_Odm->AntDivType == CG_TRX_SMART_ANTDIV ||\r\npDM_Odm->AntDivType == S0S1_SW_ANTDIV\r\n) {\r\nif (pDM_DigTable->AntDiv_RSSI_max > DIG_MaxOfMin)\r\nDIG_Dynamic_MIN = DIG_MaxOfMin;\r\nelse\r\nDIG_Dynamic_MIN = (u8) pDM_DigTable->AntDiv_RSSI_max;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_ANT_DIV,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Antenna diversity case: Force lower bound to 0x%x !!!!!!\n",\r\nDIG_Dynamic_MIN\r\n)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_ANT_DIV,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Antenna diversity case: RSSI_max = 0x%x !!!!!!\n",\r\npDM_DigTable->AntDiv_RSSI_max\r\n)\r\n);\r\n}\r\n}\r\n}\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Adjust boundary by RSSI Upper bound = 0x%x, Lower bound = 0x%x\n",\r\npDM_DigTable->rx_gain_range_max,\r\nDIG_Dynamic_MIN\r\n)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Link status: bLinked = %d, RSSI = %d, bFirstConnect = %d, bFirsrDisConnect = %d\n\n",\r\npDM_Odm->bLinked,\r\npDM_Odm->RSSI_Min,\r\nFirstConnect,\r\nFirstDisConnect\r\n)\r\n);\r\nif (FirstDisConnect) {\r\npDM_DigTable->rx_gain_range_min = DIG_Dynamic_MIN;\r\npDM_DigTable->ForbiddenIGI = DIG_Dynamic_MIN;\r\n} else\r\npDM_DigTable->rx_gain_range_min =\r\nodm_ForbiddenIGICheck(pDM_Odm, DIG_Dynamic_MIN, CurrentIGI);\r\nif (pDM_Odm->bLinked && !FirstConnect) {\r\nif (\r\n(pDM_Odm->PhyDbgInfo.NumQryBeaconPkt < 5) &&\r\npDM_Odm->bsta_state\r\n) {\r\npDM_DigTable->rx_gain_range_min = dm_dig_min;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Abnrormal #beacon (%d) case in STA mode: Force lower bound to 0x%x !!!!!!\n\n",\r\npDM_Odm->PhyDbgInfo.NumQryBeaconPkt,\r\npDM_DigTable->rx_gain_range_min\r\n)\r\n);\r\n}\r\n}\r\nif (pDM_DigTable->rx_gain_range_min > pDM_DigTable->rx_gain_range_max) {\r\npDM_DigTable->rx_gain_range_min = pDM_DigTable->rx_gain_range_max;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Abnrormal lower bound case: Force lower bound to 0x%x !!!!!!\n\n",\r\npDM_DigTable->rx_gain_range_min\r\n)\r\n);\r\n}\r\nodm_FAThresholdCheck(pDM_Odm, bDFSBand, bPerformance, RxTp, TxTp, dm_FA_thres);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): False alarm threshold = %d, %d, %d\n\n", dm_FA_thres[0], dm_FA_thres[1], dm_FA_thres[2]));\r\nif (pDM_Odm->bLinked && bPerformance) {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIG(): Adjust IGI after link\n")\r\n);\r\nif (bFirstTpTarget || (FirstConnect && bPerformance)) {\r\npDM_DigTable->LargeFAHit = 0;\r\nif (pDM_Odm->RSSI_Min < DIG_MaxOfMin) {\r\nif (CurrentIGI < pDM_Odm->RSSI_Min)\r\nCurrentIGI = pDM_Odm->RSSI_Min;\r\n} else {\r\nif (CurrentIGI < DIG_MaxOfMin)\r\nCurrentIGI = DIG_MaxOfMin;\r\n}\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): First connect case: IGI does on-shot to 0x%x\n",\r\nCurrentIGI\r\n)\r\n);\r\n} else {\r\nif (pFalseAlmCnt->Cnt_all > dm_FA_thres[2])\r\nCurrentIGI = CurrentIGI + 4;\r\nelse if (pFalseAlmCnt->Cnt_all > dm_FA_thres[1])\r\nCurrentIGI = CurrentIGI + 2;\r\nelse if (pFalseAlmCnt->Cnt_all < dm_FA_thres[0])\r\nCurrentIGI = CurrentIGI - 2;\r\nif (\r\n(pDM_Odm->PhyDbgInfo.NumQryBeaconPkt < 5) &&\r\n(pFalseAlmCnt->Cnt_all < DM_DIG_FA_TH1) &&\r\n(pDM_Odm->bsta_state)\r\n) {\r\nCurrentIGI = pDM_DigTable->rx_gain_range_min;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): Abnormal #beacon (%d) case: IGI does one-shot to 0x%x\n",\r\npDM_Odm->PhyDbgInfo.NumQryBeaconPkt,\r\nCurrentIGI\r\n)\r\n);\r\n}\r\n}\r\n} else {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIG(): Adjust IGI before link\n")\r\n);\r\nif (FirstDisConnect || bFirstCoverage) {\r\nCurrentIGI = dm_dig_min;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIG(): First disconnect case: IGI does on-shot to lower bound\n")\r\n);\r\n} else {\r\nif (pFalseAlmCnt->Cnt_all > dm_FA_thres[2])\r\nCurrentIGI = CurrentIGI + 4;\r\nelse if (pFalseAlmCnt->Cnt_all > dm_FA_thres[1])\r\nCurrentIGI = CurrentIGI + 2;\r\nelse if (pFalseAlmCnt->Cnt_all < dm_FA_thres[0])\r\nCurrentIGI = CurrentIGI - 2;\r\n}\r\n}\r\nif (CurrentIGI < pDM_DigTable->rx_gain_range_min)\r\nCurrentIGI = pDM_DigTable->rx_gain_range_min;\r\nif (CurrentIGI > pDM_DigTable->rx_gain_range_max)\r\nCurrentIGI = pDM_DigTable->rx_gain_range_max;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_DIG(): CurIGValue = 0x%x, TotalFA = %d\n\n",\r\nCurrentIGI,\r\npFalseAlmCnt->Cnt_all\r\n)\r\n);\r\nif (\r\npDM_Odm->SupportAbility & ODM_BB_ADAPTIVITY &&\r\npDM_Odm->adaptivity_flag == true\r\n) {\r\nif (CurrentIGI > Adap_IGI_Upper)\r\nCurrentIGI = Adap_IGI_Upper;\r\nif (pDM_Odm->IGI_LowerBound != 0) {\r\nif (CurrentIGI < pDM_Odm->IGI_LowerBound)\r\nCurrentIGI = pDM_Odm->IGI_LowerBound;\r\n}\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Adaptivity case: Force upper bound to 0x%x !!!!!!\n", Adap_IGI_Upper));\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Adaptivity case: Force lower bound to 0x%x !!!!!!\n\n", pDM_Odm->IGI_LowerBound));\r\n}\r\nif (pDM_Odm->bBtHsOperation) {\r\nif (pDM_Odm->bLinked) {\r\nif (pDM_DigTable->BT30_CurIGI > (CurrentIGI))\r\nODM_Write_DIG(pDM_Odm, CurrentIGI);\r\nelse\r\nODM_Write_DIG(pDM_Odm, pDM_DigTable->BT30_CurIGI);\r\npDM_DigTable->bMediaConnect_0 = pDM_Odm->bLinked;\r\npDM_DigTable->DIG_Dynamic_MIN_0 = DIG_Dynamic_MIN;\r\n} else {\r\nif (pDM_Odm->bLinkInProcess)\r\nODM_Write_DIG(pDM_Odm, 0x1c);\r\nelse if (pDM_Odm->bBtConnectProcess)\r\nODM_Write_DIG(pDM_Odm, 0x28);\r\nelse\r\nODM_Write_DIG(pDM_Odm, pDM_DigTable->BT30_CurIGI);\r\n}\r\n} else {\r\nODM_Write_DIG(pDM_Odm, CurrentIGI);\r\npDM_DigTable->bMediaConnect_0 = pDM_Odm->bLinked;\r\npDM_DigTable->DIG_Dynamic_MIN_0 = DIG_Dynamic_MIN;\r\n}\r\n}\r\nvoid odm_DIGbyRSSI_LPS(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPfalse_ALARM_STATISTICS pFalseAlmCnt = &pDM_Odm->FalseAlmCnt;\r\nu8 RSSI_Lower = DM_DIG_MIN_NIC;\r\nu8 CurrentIGI = pDM_Odm->RSSI_Min;\r\nCurrentIGI = CurrentIGI+RSSI_OFFSET_DIG;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIGbyRSSI_LPS() ==>\n")\r\n);\r\nif (pFalseAlmCnt->Cnt_all > DM_DIG_FA_TH2_LPS)\r\nCurrentIGI = CurrentIGI+4;\r\nelse if (pFalseAlmCnt->Cnt_all > DM_DIG_FA_TH1_LPS)\r\nCurrentIGI = CurrentIGI+2;\r\nelse if (pFalseAlmCnt->Cnt_all < DM_DIG_FA_TH0_LPS)\r\nCurrentIGI = CurrentIGI-2;\r\nif ((pDM_Odm->RSSI_Min-10) > DM_DIG_MIN_NIC)\r\nRSSI_Lower = pDM_Odm->RSSI_Min-10;\r\nelse\r\nRSSI_Lower = DM_DIG_MIN_NIC;\r\nif (CurrentIGI > DM_DIG_MAX_NIC)\r\nCurrentIGI = DM_DIG_MAX_NIC;\r\nelse if (CurrentIGI < RSSI_Lower)\r\nCurrentIGI = RSSI_Lower;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIGbyRSSI_LPS(): pFalseAlmCnt->Cnt_all = %d\n", pFalseAlmCnt->Cnt_all)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIGbyRSSI_LPS(): pDM_Odm->RSSI_Min = %d\n", pDM_Odm->RSSI_Min)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_DIG,\r\nODM_DBG_LOUD,\r\n("odm_DIGbyRSSI_LPS(): CurrentIGI = 0x%x\n", CurrentIGI)\r\n);\r\nODM_Write_DIG(pDM_Odm, CurrentIGI);\r\n}\r\nvoid odm_FalseAlarmCounterStatistics(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPfalse_ALARM_STATISTICS FalseAlmCnt = &(pDM_Odm->FalseAlmCnt);\r\nu32 ret_value;\r\nif (!(pDM_Odm->SupportAbility & ODM_BB_FA_CNT))\r\nreturn;\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_OFDM_FA_HOLDC_11N, BIT31, 1);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_OFDM_FA_RSTD_11N, BIT31, 1);\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_OFDM_FA_TYPE1_11N, bMaskDWord\r\n);\r\nFalseAlmCnt->Cnt_Fast_Fsync = (ret_value&0xffff);\r\nFalseAlmCnt->Cnt_SB_Search_fail = ((ret_value&0xffff0000)>>16);\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_OFDM_FA_TYPE2_11N, bMaskDWord\r\n);\r\nFalseAlmCnt->Cnt_OFDM_CCA = (ret_value&0xffff);\r\nFalseAlmCnt->Cnt_Parity_Fail = ((ret_value&0xffff0000)>>16);\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_OFDM_FA_TYPE3_11N, bMaskDWord\r\n);\r\nFalseAlmCnt->Cnt_Rate_Illegal = (ret_value&0xffff);\r\nFalseAlmCnt->Cnt_Crc8_fail = ((ret_value&0xffff0000)>>16);\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_OFDM_FA_TYPE4_11N, bMaskDWord\r\n);\r\nFalseAlmCnt->Cnt_Mcs_fail = (ret_value&0xffff);\r\nFalseAlmCnt->Cnt_Ofdm_fail =\r\nFalseAlmCnt->Cnt_Parity_Fail +\r\nFalseAlmCnt->Cnt_Rate_Illegal +\r\nFalseAlmCnt->Cnt_Crc8_fail +\r\nFalseAlmCnt->Cnt_Mcs_fail +\r\nFalseAlmCnt->Cnt_Fast_Fsync +\r\nFalseAlmCnt->Cnt_SB_Search_fail;\r\n{\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_CCK_FA_RST_11N, BIT12, 1);\r\nPHY_SetBBReg(pDM_Odm->Adapter, ODM_REG_CCK_FA_RST_11N, BIT14, 1);\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_CCK_FA_LSB_11N, bMaskByte0\r\n);\r\nFalseAlmCnt->Cnt_Cck_fail = ret_value;\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_CCK_FA_MSB_11N, bMaskByte3\r\n);\r\nFalseAlmCnt->Cnt_Cck_fail += (ret_value&0xff)<<8;\r\nret_value = PHY_QueryBBReg(\r\npDM_Odm->Adapter, ODM_REG_CCK_CCA_CNT_11N, bMaskDWord\r\n);\r\nFalseAlmCnt->Cnt_CCK_CCA =\r\n((ret_value&0xFF)<<8) | ((ret_value&0xFF00)>>8);\r\n}\r\nFalseAlmCnt->Cnt_all = (\r\nFalseAlmCnt->Cnt_Fast_Fsync +\r\nFalseAlmCnt->Cnt_SB_Search_fail +\r\nFalseAlmCnt->Cnt_Parity_Fail +\r\nFalseAlmCnt->Cnt_Rate_Illegal +\r\nFalseAlmCnt->Cnt_Crc8_fail +\r\nFalseAlmCnt->Cnt_Mcs_fail +\r\nFalseAlmCnt->Cnt_Cck_fail\r\n);\r\nFalseAlmCnt->Cnt_CCA_all =\r\nFalseAlmCnt->Cnt_OFDM_CCA + FalseAlmCnt->Cnt_CCK_CCA;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Enter odm_FalseAlarmCounterStatistics\n")\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n(\r\n"Cnt_Fast_Fsync =%d, Cnt_SB_Search_fail =%d\n",\r\nFalseAlmCnt->Cnt_Fast_Fsync,\r\nFalseAlmCnt->Cnt_SB_Search_fail\r\n)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n(\r\n"Cnt_Parity_Fail =%d, Cnt_Rate_Illegal =%d\n",\r\nFalseAlmCnt->Cnt_Parity_Fail,\r\nFalseAlmCnt->Cnt_Rate_Illegal\r\n)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n(\r\n"Cnt_Crc8_fail =%d, Cnt_Mcs_fail =%d\n",\r\nFalseAlmCnt->Cnt_Crc8_fail,\r\nFalseAlmCnt->Cnt_Mcs_fail\r\n)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_OFDM_CCA =%d\n", FalseAlmCnt->Cnt_OFDM_CCA)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_CCK_CCA =%d\n", FalseAlmCnt->Cnt_CCK_CCA)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_CCA_all =%d\n", FalseAlmCnt->Cnt_CCA_all)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_Ofdm_fail =%d\n", FalseAlmCnt->Cnt_Ofdm_fail)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_Cck_fail =%d\n", FalseAlmCnt->Cnt_Cck_fail)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Cnt_Ofdm_fail =%d\n", FalseAlmCnt->Cnt_Ofdm_fail)\r\n);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_FA_CNT,\r\nODM_DBG_LOUD,\r\n("Total False Alarm =%d\n", FalseAlmCnt->Cnt_all)\r\n);\r\n}\r\nvoid odm_FAThresholdCheck(\r\nvoid *pDM_VOID,\r\nbool bDFSBand,\r\nbool bPerformance,\r\nu32 RxTp,\r\nu32 TxTp,\r\nu32 *dm_FA_thres\r\n)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nif (pDM_Odm->bLinked && (bPerformance || bDFSBand)) {\r\ndm_FA_thres[0] = DM_DIG_FA_TH0;\r\ndm_FA_thres[1] = DM_DIG_FA_TH1;\r\ndm_FA_thres[2] = DM_DIG_FA_TH2;\r\n} else {\r\ndm_FA_thres[0] = 2000;\r\ndm_FA_thres[1] = 4000;\r\ndm_FA_thres[2] = 5000;\r\n}\r\nreturn;\r\n}\r\nu8 odm_ForbiddenIGICheck(void *pDM_VOID, u8 DIG_Dynamic_MIN, u8 CurrentIGI)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nPfalse_ALARM_STATISTICS pFalseAlmCnt = &(pDM_Odm->FalseAlmCnt);\r\nu8 rx_gain_range_min = pDM_DigTable->rx_gain_range_min;\r\nif (pFalseAlmCnt->Cnt_all > 10000) {\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Abnormally false alarm case.\n"));\r\nif (pDM_DigTable->LargeFAHit != 3)\r\npDM_DigTable->LargeFAHit++;\r\nif (pDM_DigTable->ForbiddenIGI < CurrentIGI) {\r\npDM_DigTable->ForbiddenIGI = CurrentIGI;\r\npDM_DigTable->LargeFAHit = 1;\r\n}\r\nif (pDM_DigTable->LargeFAHit >= 3) {\r\nif ((pDM_DigTable->ForbiddenIGI + 2) > pDM_DigTable->rx_gain_range_max)\r\nrx_gain_range_min = pDM_DigTable->rx_gain_range_max;\r\nelse\r\nrx_gain_range_min = (pDM_DigTable->ForbiddenIGI + 2);\r\npDM_DigTable->Recover_cnt = 1800;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Abnormally false alarm case: Recover_cnt = %d\n", pDM_DigTable->Recover_cnt));\r\n}\r\n} else {\r\nif (pDM_DigTable->Recover_cnt != 0) {\r\npDM_DigTable->Recover_cnt--;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Normal Case: Recover_cnt = %d\n", pDM_DigTable->Recover_cnt));\r\n} else {\r\nif (pDM_DigTable->LargeFAHit < 3) {\r\nif ((pDM_DigTable->ForbiddenIGI - 2) < DIG_Dynamic_MIN) {\r\npDM_DigTable->ForbiddenIGI = DIG_Dynamic_MIN;\r\nrx_gain_range_min = DIG_Dynamic_MIN;\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Normal Case: At Lower Bound\n"));\r\n} else {\r\npDM_DigTable->ForbiddenIGI -= 2;\r\nrx_gain_range_min = (pDM_DigTable->ForbiddenIGI + 2);\r\nODM_RT_TRACE(pDM_Odm, ODM_COMP_DIG, ODM_DBG_LOUD, ("odm_DIG(): Normal Case: Approach Lower Bound\n"));\r\n}\r\n} else\r\npDM_DigTable->LargeFAHit = 0;\r\n}\r\n}\r\nreturn rx_gain_range_min;\r\n}\r\nvoid odm_CCKPacketDetectionThresh(void *pDM_VOID)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\nPfalse_ALARM_STATISTICS FalseAlmCnt = &(pDM_Odm->FalseAlmCnt);\r\nu8 CurCCK_CCAThres;\r\nif (\r\n!(pDM_Odm->SupportAbility & ODM_BB_CCK_PD) ||\r\n!(pDM_Odm->SupportAbility & ODM_BB_FA_CNT)\r\n) {\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CCK_PD,\r\nODM_DBG_LOUD,\r\n("odm_CCKPacketDetectionThresh() return ==========\n")\r\n);\r\nreturn;\r\n}\r\nif (pDM_Odm->ExtLNA)\r\nreturn;\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CCK_PD,\r\nODM_DBG_LOUD,\r\n("odm_CCKPacketDetectionThresh() ==========>\n")\r\n);\r\nif (pDM_Odm->bLinked) {\r\nif (pDM_Odm->RSSI_Min > 25)\r\nCurCCK_CCAThres = 0xcd;\r\nelse if ((pDM_Odm->RSSI_Min <= 25) && (pDM_Odm->RSSI_Min > 10))\r\nCurCCK_CCAThres = 0x83;\r\nelse {\r\nif (FalseAlmCnt->Cnt_Cck_fail > 1000)\r\nCurCCK_CCAThres = 0x83;\r\nelse\r\nCurCCK_CCAThres = 0x40;\r\n}\r\n} else {\r\nif (FalseAlmCnt->Cnt_Cck_fail > 1000)\r\nCurCCK_CCAThres = 0x83;\r\nelse\r\nCurCCK_CCAThres = 0x40;\r\n}\r\nODM_Write_CCK_CCA_Thres(pDM_Odm, CurCCK_CCAThres);\r\nODM_RT_TRACE(\r\npDM_Odm,\r\nODM_COMP_CCK_PD,\r\nODM_DBG_LOUD,\r\n(\r\n"odm_CCKPacketDetectionThresh() CurCCK_CCAThres = 0x%x\n",\r\nCurCCK_CCAThres\r\n)\r\n);\r\n}\r\nvoid ODM_Write_CCK_CCA_Thres(void *pDM_VOID, u8 CurCCK_CCAThres)\r\n{\r\nPDM_ODM_T pDM_Odm = (PDM_ODM_T)pDM_VOID;\r\npDIG_T pDM_DigTable = &pDM_Odm->DM_DigTable;\r\nif (pDM_DigTable->CurCCK_CCAThres != CurCCK_CCAThres)\r\nrtw_write8(pDM_Odm->Adapter, ODM_REG(CCK_CCA, pDM_Odm), CurCCK_CCAThres);\r\npDM_DigTable->PreCCK_CCAThres = pDM_DigTable->CurCCK_CCAThres;\r\npDM_DigTable->CurCCK_CCAThres = CurCCK_CCAThres;\r\n}

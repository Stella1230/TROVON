static int s6e3ha2_dcs_write(struct s6e3ha2 *ctx, const void *data, size_t len)\r\n{\r\nstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\r\nreturn mipi_dsi_dcs_write_buffer(dsi, data, len);\r\n}\r\nstatic int s6e3ha2_test_key_on_f0(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf0, 0x5a, 0x5a);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_test_key_off_f0(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf0, 0xa5, 0xa5);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_test_key_on_fc(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfc, 0x5a, 0x5a);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_test_key_off_fc(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfc, 0xa5, 0xa5);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_single_dsi_set(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf2, 0x67);\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf9, 0x09);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_freq_calibration(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfd, 0x1c);\r\nif (ctx->desc->type == HF2_TYPE)\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf2, 0x67, 0x40, 0xc5);\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfe, 0x20, 0x39);\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfe, 0xa0);\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfe, 0x20);\r\nif (ctx->desc->type == HA2_TYPE)\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xce, 0x03, 0x3b, 0x12, 0x62,\r\n0x40, 0x80, 0xc0, 0x28, 0x28,\r\n0x28, 0x28, 0x39, 0xc5);\r\nelse\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xce, 0x03, 0x3b, 0x14, 0x6d,\r\n0x40, 0x80, 0xc0, 0x28, 0x28,\r\n0x28, 0x28, 0x39, 0xc5);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_aor_control(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb2, 0x03, 0x10);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_caps_elvss_set(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb6, 0x9c, 0x0a);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_acl_off(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0x55, 0x00);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_acl_off_opr(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb5, 0x40);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_test_global(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb0, 0x07);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_test(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb8, 0x19);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_touch_hsync_on1(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xbd, 0x33, 0x11, 0x02,\r\n0x16, 0x02, 0x16);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_pentile_control(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xc0, 0x00, 0x00, 0xd8, 0xd8);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_poc_global(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb0, 0x20);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_poc_setting(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xfe, 0x08);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_pcd_set_off(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xcc, 0x40, 0x51);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_err_fg_set(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xed, 0x44);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_hbm_off(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0x53, 0x00);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_te_start_setting(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xb9, 0x10, 0x09, 0xff, 0x00, 0x09);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_gamma_update(struct s6e3ha2 *ctx)\r\n{\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf7, 0x03);\r\nndelay(100);\r\ns6e3ha2_dcs_write_seq_static(ctx, 0xf7, 0x00);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_get_brightness(struct backlight_device *bl_dev)\r\n{\r\nreturn bl_dev->props.brightness;\r\n}\r\nstatic int s6e3ha2_set_vint(struct s6e3ha2 *ctx)\r\n{\r\nstruct backlight_device *bl_dev = ctx->bl_dev;\r\nunsigned int brightness = bl_dev->props.brightness;\r\nunsigned char data[] = { 0xf4, 0x8b,\r\nvint_table[brightness * (S6E3HA2_VINT_STATUS_MAX - 1) /\r\nS6E3HA2_MAX_BRIGHTNESS] };\r\nreturn s6e3ha2_dcs_write(ctx, data, ARRAY_SIZE(data));\r\n}\r\nstatic unsigned int s6e3ha2_get_brightness_index(unsigned int brightness)\r\n{\r\nreturn (brightness * (S6E3HA2_NUM_GAMMA_STEPS - 1)) /\r\nS6E3HA2_MAX_BRIGHTNESS;\r\n}\r\nstatic int s6e3ha2_update_gamma(struct s6e3ha2 *ctx, unsigned int brightness)\r\n{\r\nstruct backlight_device *bl_dev = ctx->bl_dev;\r\nunsigned int index = s6e3ha2_get_brightness_index(brightness);\r\nu8 data[S6E3HA2_GAMMA_CMD_CNT + 1] = { 0xca, };\r\nint ret;\r\nmemcpy(data + 1, gamma_tbl + index, S6E3HA2_GAMMA_CMD_CNT);\r\ns6e3ha2_call_write_func(ret,\r\ns6e3ha2_dcs_write(ctx, data, ARRAY_SIZE(data)));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_gamma_update(ctx));\r\nbl_dev->props.brightness = brightness;\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_set_brightness(struct backlight_device *bl_dev)\r\n{\r\nstruct s6e3ha2 *ctx = bl_get_data(bl_dev);\r\nunsigned int brightness = bl_dev->props.brightness;\r\nint ret;\r\nif (brightness < S6E3HA2_MIN_BRIGHTNESS ||\r\nbrightness > bl_dev->props.max_brightness) {\r\ndev_err(ctx->dev, "Invalid brightness: %u\n", brightness);\r\nreturn -EINVAL;\r\n}\r\nif (bl_dev->props.power > FB_BLANK_NORMAL)\r\nreturn -EPERM;\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_on_f0(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_update_gamma(ctx, brightness));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_aor_control(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_set_vint(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_off_f0(ctx));\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_panel_init(struct s6e3ha2 *ctx)\r\n{\r\nstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\r\nint ret;\r\ns6e3ha2_call_write_func(ret, mipi_dsi_dcs_exit_sleep_mode(dsi));\r\nusleep_range(5000, 6000);\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_on_f0(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_single_dsi_set(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_on_fc(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_freq_calibration(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_off_fc(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_off_f0(ctx));\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_power_off(struct s6e3ha2 *ctx)\r\n{\r\nreturn regulator_bulk_disable(ARRAY_SIZE(ctx->supplies), ctx->supplies);\r\n}\r\nstatic int s6e3ha2_disable(struct drm_panel *panel)\r\n{\r\nstruct s6e3ha2 *ctx = container_of(panel, struct s6e3ha2, panel);\r\nstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\r\nint ret;\r\ns6e3ha2_call_write_func(ret, mipi_dsi_dcs_enter_sleep_mode(dsi));\r\ns6e3ha2_call_write_func(ret, mipi_dsi_dcs_set_display_off(dsi));\r\nmsleep(40);\r\nctx->bl_dev->props.power = FB_BLANK_NORMAL;\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_unprepare(struct drm_panel *panel)\r\n{\r\nstruct s6e3ha2 *ctx = container_of(panel, struct s6e3ha2, panel);\r\nreturn s6e3ha2_power_off(ctx);\r\n}\r\nstatic int s6e3ha2_power_on(struct s6e3ha2 *ctx)\r\n{\r\nint ret;\r\nret = regulator_bulk_enable(ARRAY_SIZE(ctx->supplies), ctx->supplies);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\ngpiod_set_value(ctx->enable_gpio, 0);\r\nusleep_range(5000, 6000);\r\ngpiod_set_value(ctx->enable_gpio, 1);\r\ngpiod_set_value(ctx->reset_gpio, 1);\r\nusleep_range(5000, 6000);\r\ngpiod_set_value(ctx->reset_gpio, 0);\r\nusleep_range(5000, 6000);\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_prepare(struct drm_panel *panel)\r\n{\r\nstruct s6e3ha2 *ctx = container_of(panel, struct s6e3ha2, panel);\r\nint ret;\r\nret = s6e3ha2_power_on(ctx);\r\nif (ret < 0)\r\nreturn ret;\r\nret = s6e3ha2_panel_init(ctx);\r\nif (ret < 0)\r\ngoto err;\r\nctx->bl_dev->props.power = FB_BLANK_NORMAL;\r\nreturn 0;\r\nerr:\r\ns6e3ha2_power_off(ctx);\r\nreturn ret;\r\n}\r\nstatic int s6e3ha2_enable(struct drm_panel *panel)\r\n{\r\nstruct s6e3ha2 *ctx = container_of(panel, struct s6e3ha2, panel);\r\nstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\r\nint ret;\r\ns6e3ha2_call_write_func(ret,\r\nmipi_dsi_dcs_set_tear_on(dsi, MIPI_DSI_DCS_TEAR_MODE_VBLANK));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_on_f0(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_on_fc(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_touch_hsync_on1(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_pentile_control(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_poc_global(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_poc_setting(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_off_fc(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_pcd_set_off(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_err_fg_set(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_te_start_setting(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_set_brightness(ctx->bl_dev));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_aor_control(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_caps_elvss_set(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_gamma_update(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_acl_off(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_acl_off_opr(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_hbm_off(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_global(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test(ctx));\r\ns6e3ha2_call_write_func(ret, s6e3ha2_test_key_off_f0(ctx));\r\ns6e3ha2_call_write_func(ret, mipi_dsi_dcs_set_display_on(dsi));\r\nctx->bl_dev->props.power = FB_BLANK_UNBLANK;\r\nreturn 0;\r\n}\r\nstatic int s6e3ha2_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_connector *connector = panel->connector;\r\nstruct s6e3ha2 *ctx = container_of(panel, struct s6e3ha2, panel);\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, ctx->desc->mode);\r\nif (!mode) {\r\nDRM_ERROR("failed to add mode %ux%ux@%u\n",\r\nctx->desc->mode->hdisplay, ctx->desc->mode->vdisplay,\r\nctx->desc->mode->vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\nmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\r\ndrm_mode_probed_add(connector, mode);\r\nconnector->display_info.width_mm = 71;\r\nconnector->display_info.height_mm = 125;\r\nreturn 1;\r\n}\r\nstatic int s6e3ha2_probe(struct mipi_dsi_device *dsi)\r\n{\r\nstruct device *dev = &dsi->dev;\r\nstruct s6e3ha2 *ctx;\r\nint ret;\r\nctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nmipi_dsi_set_drvdata(dsi, ctx);\r\nctx->dev = dev;\r\nctx->desc = of_device_get_match_data(dev);\r\ndsi->lanes = 4;\r\ndsi->format = MIPI_DSI_FMT_RGB888;\r\ndsi->mode_flags = MIPI_DSI_CLOCK_NON_CONTINUOUS;\r\nctx->supplies[0].supply = "vdd3";\r\nctx->supplies[1].supply = "vci";\r\nret = devm_regulator_bulk_get(dev, ARRAY_SIZE(ctx->supplies),\r\nctx->supplies);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to get regulators: %d\n", ret);\r\nreturn ret;\r\n}\r\nctx->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(ctx->reset_gpio)) {\r\ndev_err(dev, "cannot get reset-gpios %ld\n",\r\nPTR_ERR(ctx->reset_gpio));\r\nreturn PTR_ERR(ctx->reset_gpio);\r\n}\r\nctx->enable_gpio = devm_gpiod_get(dev, "enable", GPIOD_OUT_HIGH);\r\nif (IS_ERR(ctx->enable_gpio)) {\r\ndev_err(dev, "cannot get enable-gpios %ld\n",\r\nPTR_ERR(ctx->enable_gpio));\r\nreturn PTR_ERR(ctx->enable_gpio);\r\n}\r\nctx->bl_dev = backlight_device_register("s6e3ha2", dev, ctx,\r\n&s6e3ha2_bl_ops, NULL);\r\nif (IS_ERR(ctx->bl_dev)) {\r\ndev_err(dev, "failed to register backlight device\n");\r\nreturn PTR_ERR(ctx->bl_dev);\r\n}\r\nctx->bl_dev->props.max_brightness = S6E3HA2_MAX_BRIGHTNESS;\r\nctx->bl_dev->props.brightness = S6E3HA2_DEFAULT_BRIGHTNESS;\r\nctx->bl_dev->props.power = FB_BLANK_POWERDOWN;\r\ndrm_panel_init(&ctx->panel);\r\nctx->panel.dev = dev;\r\nctx->panel.funcs = &s6e3ha2_drm_funcs;\r\nret = drm_panel_add(&ctx->panel);\r\nif (ret < 0)\r\ngoto unregister_backlight;\r\nret = mipi_dsi_attach(dsi);\r\nif (ret < 0)\r\ngoto remove_panel;\r\nreturn ret;\r\nremove_panel:\r\ndrm_panel_remove(&ctx->panel);\r\nunregister_backlight:\r\nbacklight_device_unregister(ctx->bl_dev);\r\nreturn ret;\r\n}\r\nstatic int s6e3ha2_remove(struct mipi_dsi_device *dsi)\r\n{\r\nstruct s6e3ha2 *ctx = mipi_dsi_get_drvdata(dsi);\r\nmipi_dsi_detach(dsi);\r\ndrm_panel_remove(&ctx->panel);\r\nbacklight_device_unregister(ctx->bl_dev);\r\nreturn 0;\r\n}

static inline struct sun4i_ddc *hw_to_ddc(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct sun4i_ddc, hw);\r\n}\r\nstatic unsigned long sun4i_ddc_calc_divider(unsigned long rate,\r\nunsigned long parent_rate,\r\nu8 *m, u8 *n)\r\n{\r\nunsigned long best_rate = 0;\r\nu8 best_m = 0, best_n = 0, _m, _n;\r\nfor (_m = 0; _m < 8; _m++) {\r\nfor (_n = 0; _n < 8; _n++) {\r\nunsigned long tmp_rate;\r\ntmp_rate = (((parent_rate / 2) / 10) >> _n) / (_m + 1);\r\nif (tmp_rate > rate)\r\ncontinue;\r\nif (abs(rate - tmp_rate) < abs(rate - best_rate)) {\r\nbest_rate = tmp_rate;\r\nbest_m = _m;\r\nbest_n = _n;\r\n}\r\n}\r\n}\r\nif (m && n) {\r\n*m = best_m;\r\n*n = best_n;\r\n}\r\nreturn best_rate;\r\n}\r\nstatic long sun4i_ddc_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nreturn sun4i_ddc_calc_divider(rate, *prate, NULL, NULL);\r\n}\r\nstatic unsigned long sun4i_ddc_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun4i_ddc *ddc = hw_to_ddc(hw);\r\nu32 reg;\r\nu8 m, n;\r\nreg = readl(ddc->hdmi->base + SUN4I_HDMI_DDC_CLK_REG);\r\nm = (reg >> 3) & 0x7;\r\nn = reg & 0x7;\r\nreturn (((parent_rate / 2) / 10) >> n) / (m + 1);\r\n}\r\nstatic int sun4i_ddc_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun4i_ddc *ddc = hw_to_ddc(hw);\r\nu8 div_m, div_n;\r\nsun4i_ddc_calc_divider(rate, parent_rate, &div_m, &div_n);\r\nwritel(SUN4I_HDMI_DDC_CLK_M(div_m) | SUN4I_HDMI_DDC_CLK_N(div_n),\r\nddc->hdmi->base + SUN4I_HDMI_DDC_CLK_REG);\r\nreturn 0;\r\n}\r\nint sun4i_ddc_create(struct sun4i_hdmi *hdmi, struct clk *parent)\r\n{\r\nstruct clk_init_data init;\r\nstruct sun4i_ddc *ddc;\r\nconst char *parent_name;\r\nparent_name = __clk_get_name(parent);\r\nif (!parent_name)\r\nreturn -ENODEV;\r\nddc = devm_kzalloc(hdmi->dev, sizeof(*ddc), GFP_KERNEL);\r\nif (!ddc)\r\nreturn -ENOMEM;\r\ninit.name = "hdmi-ddc";\r\ninit.ops = &sun4i_ddc_ops;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\nddc->hdmi = hdmi;\r\nddc->hw.init = &init;\r\nhdmi->ddc_clk = devm_clk_register(hdmi->dev, &ddc->hw);\r\nif (IS_ERR(hdmi->ddc_clk))\r\nreturn PTR_ERR(hdmi->ddc_clk);\r\nreturn 0;\r\n}

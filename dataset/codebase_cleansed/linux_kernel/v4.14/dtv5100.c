static int dtv5100_i2c_msg(struct dvb_usb_device *d, u8 addr,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nstruct dtv5100_state *st = d->priv;\r\nu8 request;\r\nu8 type;\r\nu16 value;\r\nu16 index;\r\nswitch (wlen) {\r\ncase 1:\r\nrequest = (addr == DTV5100_DEMOD_ADDR ? DTV5100_DEMOD_READ :\r\nDTV5100_TUNER_READ);\r\ntype = USB_TYPE_VENDOR | USB_DIR_IN;\r\nvalue = 0;\r\nbreak;\r\ncase 2:\r\nrequest = (addr == DTV5100_DEMOD_ADDR ? DTV5100_DEMOD_WRITE :\r\nDTV5100_TUNER_WRITE);\r\ntype = USB_TYPE_VENDOR | USB_DIR_OUT;\r\nvalue = wbuf[1];\r\nbreak;\r\ndefault:\r\nwarn("wlen = %x, aborting.", wlen);\r\nreturn -EINVAL;\r\n}\r\nindex = (addr << 8) + wbuf[0];\r\nmemcpy(st->data, rbuf, rlen);\r\nmsleep(1);\r\nreturn usb_control_msg(d->udev, usb_rcvctrlpipe(d->udev, 0), request,\r\ntype, value, index, st->data, rlen,\r\nDTV5100_USB_TIMEOUT);\r\n}\r\nstatic int dtv5100_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msg[],\r\nint num)\r\n{\r\nstruct dvb_usb_device *d = i2c_get_adapdata(adap);\r\nint i;\r\nif (num > 2)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\r\nreturn -EAGAIN;\r\nfor (i = 0; i < num; i++) {\r\nif (i+1 < num && (msg[i+1].flags & I2C_M_RD)) {\r\nif (dtv5100_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, msg[i+1].buf,\r\nmsg[i+1].len) < 0)\r\nbreak;\r\ni++;\r\n} else if (dtv5100_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, NULL, 0) < 0)\r\nbreak;\r\n}\r\nmutex_unlock(&d->i2c_mutex);\r\nreturn i;\r\n}\r\nstatic u32 dtv5100_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C;\r\n}\r\nstatic int dtv5100_frontend_attach(struct dvb_usb_adapter *adap)\r\n{\r\nadap->fe_adap[0].fe = dvb_attach(zl10353_attach, &dtv5100_zl10353_config,\r\n&adap->dev->i2c_adap);\r\nif (adap->fe_adap[0].fe == NULL)\r\nreturn -EIO;\r\nadap->fe_adap[0].fe->ops.i2c_gate_ctrl = NULL;\r\nreturn 0;\r\n}\r\nstatic int dtv5100_tuner_attach(struct dvb_usb_adapter *adap)\r\n{\r\nreturn dvb_attach(qt1010_attach,\r\nadap->fe_adap[0].fe, &adap->dev->i2c_adap,\r\n&dtv5100_qt1010_config) == NULL ? -ENODEV : 0;\r\n}\r\nstatic int dtv5100_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nint i, ret;\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nfor (i = 0; dtv5100_init[i].request; i++) {\r\nret = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0),\r\ndtv5100_init[i].request,\r\nUSB_TYPE_VENDOR | USB_DIR_OUT,\r\ndtv5100_init[i].value,\r\ndtv5100_init[i].index, NULL, 0,\r\nDTV5100_USB_TIMEOUT);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = dvb_usb_device_init(intf, &dtv5100_properties,\r\nTHIS_MODULE, NULL, adapter_nr);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

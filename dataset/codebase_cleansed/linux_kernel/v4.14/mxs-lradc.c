static int mxs_lradc_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *of_id;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = dev->of_node;\r\nstruct mxs_lradc *lradc;\r\nstruct mfd_cell *cells = NULL;\r\nstruct resource *res;\r\nint ret = 0;\r\nu32 ts_wires = 0;\r\nlradc = devm_kzalloc(&pdev->dev, sizeof(*lradc), GFP_KERNEL);\r\nif (!lradc)\r\nreturn -ENOMEM;\r\nof_id = of_match_device(mxs_lradc_dt_ids, &pdev->dev);\r\nif (!of_id)\r\nreturn -EINVAL;\r\nlradc->soc = (enum mxs_lradc_id)of_id->data;\r\nlradc->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(lradc->clk)) {\r\ndev_err(dev, "Failed to get the delay unit clock\n");\r\nreturn PTR_ERR(lradc->clk);\r\n}\r\nret = clk_prepare_enable(lradc->clk);\r\nif (ret) {\r\ndev_err(dev, "Failed to enable the delay unit clock\n");\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(node, "fsl,lradc-touchscreen-wires",\r\n&ts_wires);\r\nif (!ret) {\r\nlradc->buffer_vchans = BUFFER_VCHANS_LIMITED;\r\nswitch (ts_wires) {\r\ncase 4:\r\nlradc->touchscreen_wire = MXS_LRADC_TOUCHSCREEN_4WIRE;\r\nbreak;\r\ncase 5:\r\nif (lradc->soc == IMX28_LRADC) {\r\nlradc->touchscreen_wire =\r\nMXS_LRADC_TOUCHSCREEN_5WIRE;\r\nbreak;\r\n}\r\ndefault:\r\ndev_err(&pdev->dev,\r\n"Unsupported number of touchscreen wires (%d)\n"\r\n, ts_wires);\r\nret = -EINVAL;\r\ngoto err_clk;\r\n}\r\n} else {\r\nlradc->buffer_vchans = BUFFER_VCHANS_ALL;\r\n}\r\nplatform_set_drvdata(pdev, lradc);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOMEM;\r\nswitch (lradc->soc) {\r\ncase IMX23_LRADC:\r\nmx23_adc_resources[RES_MEM] = *res;\r\nmx23_touchscreen_resources[RES_MEM] = *res;\r\ncells = mx23_cells;\r\nbreak;\r\ncase IMX28_LRADC:\r\nmx28_adc_resources[RES_MEM] = *res;\r\nmx28_touchscreen_resources[RES_MEM] = *res;\r\ncells = mx28_cells;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "Unsupported SoC\n");\r\nret = -ENODEV;\r\ngoto err_clk;\r\n}\r\nret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\r\n&cells[ADC_CELL], 1, NULL, 0, NULL);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add the ADC subdevice\n");\r\ngoto err_clk;\r\n}\r\nif (!lradc->touchscreen_wire)\r\nreturn 0;\r\nret = devm_mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE,\r\n&cells[TSC_CELL], 1, NULL, 0, NULL);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to add the touchscreen subdevice\n");\r\ngoto err_clk;\r\n}\r\nreturn 0;\r\nerr_clk:\r\nclk_disable_unprepare(lradc->clk);\r\nreturn ret;\r\n}\r\nstatic int mxs_lradc_remove(struct platform_device *pdev)\r\n{\r\nstruct mxs_lradc *lradc = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(lradc->clk);\r\nreturn 0;\r\n}

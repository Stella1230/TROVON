static int lp87565_buck_set_ramp_delay(struct regulator_dev *rdev,\r\nint ramp_delay)\r\n{\r\nint id = rdev_get_id(rdev);\r\nstruct lp87565 *lp87565 = rdev_get_drvdata(rdev);\r\nunsigned int reg;\r\nint ret;\r\nif (ramp_delay <= 470)\r\nreg = 7;\r\nelse if (ramp_delay <= 940)\r\nreg = 6;\r\nelse if (ramp_delay <= 1900)\r\nreg = 5;\r\nelse if (ramp_delay <= 3800)\r\nreg = 4;\r\nelse if (ramp_delay <= 7500)\r\nreg = 3;\r\nelse if (ramp_delay <= 10000)\r\nreg = 2;\r\nelse if (ramp_delay <= 15000)\r\nreg = 1;\r\nelse\r\nreg = 0;\r\nret = regmap_update_bits(lp87565->regmap, regulators[id].ctrl2_reg,\r\nLP87565_BUCK_CTRL_2_SLEW_RATE,\r\nreg << __ffs(LP87565_BUCK_CTRL_2_SLEW_RATE));\r\nif (ret) {\r\ndev_err(lp87565->dev, "SLEW RATE write failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nrdev->constraints->ramp_delay = lp87565_buck_ramp_delay[reg];\r\nreturn 0;\r\n}\r\nstatic int lp87565_buck_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nint id = rdev_get_id(rdev);\r\nstruct lp87565 *lp87565 = rdev_get_drvdata(rdev);\r\nint i;\r\nfor (i = ARRAY_SIZE(lp87565_buck_uA) - 1; i >= 0; i--) {\r\nif (lp87565_buck_uA[i] >= min_uA &&\r\nlp87565_buck_uA[i] <= max_uA)\r\nreturn regmap_update_bits(lp87565->regmap,\r\nregulators[id].ctrl2_reg,\r\nLP87565_BUCK_CTRL_2_ILIM,\r\ni << __ffs(LP87565_BUCK_CTRL_2_ILIM));\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int lp87565_buck_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nint id = rdev_get_id(rdev);\r\nstruct lp87565 *lp87565 = rdev_get_drvdata(rdev);\r\nint ret;\r\nunsigned int val;\r\nret = regmap_read(lp87565->regmap, regulators[id].ctrl2_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nval = (val & LP87565_BUCK_CTRL_2_ILIM) >>\r\n__ffs(LP87565_BUCK_CTRL_2_ILIM);\r\nreturn (val < ARRAY_SIZE(lp87565_buck_uA)) ?\r\nlp87565_buck_uA[val] : -EINVAL;\r\n}\r\nstatic int lp87565_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct lp87565 *lp87565 = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_config config = { };\r\nstruct regulator_dev *rdev;\r\nint i, min_idx = LP87565_BUCK_1, max_idx = LP87565_BUCK_3;\r\nplatform_set_drvdata(pdev, lp87565);\r\nconfig.dev = &pdev->dev;\r\nconfig.dev->of_node = lp87565->dev->of_node;\r\nconfig.driver_data = lp87565;\r\nconfig.regmap = lp87565->regmap;\r\nif (lp87565->dev_type == LP87565_DEVICE_TYPE_LP87565_Q1) {\r\nmin_idx = LP87565_BUCK_10;\r\nmax_idx = LP87565_BUCK_23;\r\n}\r\nfor (i = min_idx; i <= max_idx; i++) {\r\nrdev = devm_regulator_register(&pdev->dev, &regulators[i].desc,\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(lp87565->dev, "failed to register %s regulator\n",\r\npdev->name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}

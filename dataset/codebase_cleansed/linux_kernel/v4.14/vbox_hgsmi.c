static u32 hgsmi_hash_process(u32 hash, const u8 *data, int size)\r\n{\r\nwhile (size--) {\r\nhash += *data++;\r\nhash += (hash << 10);\r\nhash ^= (hash >> 6);\r\n}\r\nreturn hash;\r\n}\r\nstatic u32 hgsmi_hash_end(u32 hash)\r\n{\r\nhash += (hash << 3);\r\nhash ^= (hash >> 11);\r\nhash += (hash << 15);\r\nreturn hash;\r\n}\r\nstatic u32 hgsmi_checksum(u32 offset,\r\nconst struct hgsmi_buffer_header *header,\r\nconst struct hgsmi_buffer_tail *tail)\r\n{\r\nu32 checksum;\r\nchecksum = hgsmi_hash_process(0, (u8 *)&offset, sizeof(offset));\r\nchecksum = hgsmi_hash_process(checksum, (u8 *)header, sizeof(*header));\r\nchecksum = hgsmi_hash_process(checksum, (u8 *)tail, 4);\r\nreturn hgsmi_hash_end(checksum);\r\n}\r\nvoid *hgsmi_buffer_alloc(struct gen_pool *guest_pool, size_t size,\r\nu8 channel, u16 channel_info)\r\n{\r\nstruct hgsmi_buffer_header *h;\r\nstruct hgsmi_buffer_tail *t;\r\nsize_t total_size;\r\ndma_addr_t offset;\r\ntotal_size = size + sizeof(*h) + sizeof(*t);\r\nh = gen_pool_dma_alloc(guest_pool, total_size, &offset);\r\nif (!h)\r\nreturn NULL;\r\nt = (struct hgsmi_buffer_tail *)((u8 *)h + sizeof(*h) + size);\r\nh->flags = HGSMI_BUFFER_HEADER_F_SEQ_SINGLE;\r\nh->data_size = size;\r\nh->channel = channel;\r\nh->channel_info = channel_info;\r\nmemset(&h->u.header_data, 0, sizeof(h->u.header_data));\r\nt->reserved = 0;\r\nt->checksum = hgsmi_checksum(offset, h, t);\r\nreturn (u8 *)h + sizeof(*h);\r\n}\r\nvoid hgsmi_buffer_free(struct gen_pool *guest_pool, void *buf)\r\n{\r\nstruct hgsmi_buffer_header *h =\r\n(struct hgsmi_buffer_header *)((u8 *)buf - sizeof(*h));\r\nsize_t total_size = h->data_size + sizeof(*h) +\r\nsizeof(struct hgsmi_buffer_tail);\r\ngen_pool_free(guest_pool, (unsigned long)h, total_size);\r\n}\r\nint hgsmi_buffer_submit(struct gen_pool *guest_pool, void *buf)\r\n{\r\nphys_addr_t offset;\r\noffset = gen_pool_virt_to_phys(guest_pool, (unsigned long)buf -\r\nsizeof(struct hgsmi_buffer_header));\r\noutl(offset, VGA_PORT_HGSMI_GUEST);\r\nmb();\r\nreturn 0;\r\n}

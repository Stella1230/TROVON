int avc_stream_set_format(struct fw_unit *unit, enum avc_general_plug_dir dir,\r\nunsigned int pid, u8 *format, unsigned int len)\r\n{\r\nu8 *buf;\r\nint err;\r\nbuf = kmalloc(len + 10, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nbuf[0] = 0x00;\r\nbuf[1] = 0xff;\r\nbuf[2] = 0xbf;\r\nbuf[3] = 0xc0;\r\nbuf[4] = dir;\r\nbuf[5] = 0x00;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0xff & pid;\r\nbuf[8] = 0xff;\r\nbuf[9] = 0xff;\r\nmemcpy(buf + 10, format, len);\r\nerr = fcp_avc_transaction(unit, buf, len + 10, buf, len + 10,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7) | BIT(8));\r\nif (err < 0)\r\n;\r\nelse if (err < len + 10)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse\r\nerr = 0;\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint avc_stream_get_format(struct fw_unit *unit,\r\nenum avc_general_plug_dir dir, unsigned int pid,\r\nu8 *buf, unsigned int *len, unsigned int eid)\r\n{\r\nunsigned int subfunc;\r\nint err;\r\nif (eid == 0xff)\r\nsubfunc = 0xc0;\r\nelse\r\nsubfunc = 0xc1;\r\nbuf[0] = 0x01;\r\nbuf[1] = 0xff;\r\nbuf[2] = 0xbf;\r\nbuf[3] = subfunc;\r\nbuf[4] = dir;\r\nbuf[5] = 0x00;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0xff & pid;\r\nbuf[8] = 0xff;\r\nbuf[9] = 0xff;\r\nbuf[10] = 0xff & eid;\r\nbuf[11] = 0xff;\r\nerr = fcp_avc_transaction(unit, buf, 12, buf, *len,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5) |\r\nBIT(6) | BIT(7));\r\nif (err < 0)\r\n;\r\nelse if (err < 12)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nelse if (buf[0] == 0x0a)\r\nerr = -EINVAL;\r\nelse if (buf[0] == 0x0b)\r\nerr = -EAGAIN;\r\nelse if ((subfunc == 0xc1) && (buf[10] != eid))\r\nerr = -EIO;\r\nif (err < 0)\r\ngoto end;\r\nif (subfunc == 0xc0) {\r\nmemmove(buf, buf + 10, err - 10);\r\n*len = err - 10;\r\n} else {\r\nmemmove(buf, buf + 11, err - 11);\r\n*len = err - 11;\r\n}\r\nerr = 0;\r\nend:\r\nreturn err;\r\n}\r\nint avc_general_inquiry_sig_fmt(struct fw_unit *unit, unsigned int rate,\r\nenum avc_general_plug_dir dir,\r\nunsigned short pid)\r\n{\r\nunsigned int sfc;\r\nu8 *buf;\r\nint err;\r\nfor (sfc = 0; sfc < CIP_SFC_COUNT; sfc++) {\r\nif (amdtp_rate_table[sfc] == rate)\r\nbreak;\r\n}\r\nif (sfc == CIP_SFC_COUNT)\r\nreturn -EINVAL;\r\nbuf = kzalloc(8, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nbuf[0] = 0x02;\r\nbuf[1] = 0xff;\r\nif (dir == AVC_GENERAL_PLUG_DIR_IN)\r\nbuf[2] = 0x19;\r\nelse\r\nbuf[2] = 0x18;\r\nbuf[3] = 0xff & pid;\r\nbuf[4] = 0x90;\r\nbuf[5] = 0x07 & sfc;\r\nbuf[6] = 0xff;\r\nbuf[7] = 0xff;\r\nerr = fcp_avc_transaction(unit, buf, 8, buf, 8,\r\nBIT(1) | BIT(2) | BIT(3) | BIT(4) | BIT(5));\r\nif (err < 0)\r\n;\r\nelse if (err < 8)\r\nerr = -EIO;\r\nelse if (buf[0] == 0x08)\r\nerr = -ENOSYS;\r\nif (err < 0)\r\ngoto end;\r\nerr = 0;\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}

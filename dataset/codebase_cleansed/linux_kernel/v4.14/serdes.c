static int mv88e6352_serdes_read(struct mv88e6xxx_chip *chip, int reg,\r\nu16 *val)\r\n{\r\nreturn mv88e6xxx_phy_page_read(chip, MV88E6352_ADDR_SERDES,\r\nMV88E6352_SERDES_PAGE_FIBER,\r\nreg, val);\r\n}\r\nstatic int mv88e6352_serdes_write(struct mv88e6xxx_chip *chip, int reg,\r\nu16 val)\r\n{\r\nreturn mv88e6xxx_phy_page_write(chip, MV88E6352_ADDR_SERDES,\r\nMV88E6352_SERDES_PAGE_FIBER,\r\nreg, val);\r\n}\r\nstatic int mv88e6352_serdes_power_set(struct mv88e6xxx_chip *chip, bool on)\r\n{\r\nu16 val, new_val;\r\nint err;\r\nerr = mv88e6352_serdes_read(chip, MII_BMCR, &val);\r\nif (err)\r\nreturn err;\r\nif (on)\r\nnew_val = val & ~BMCR_PDOWN;\r\nelse\r\nnew_val = val | BMCR_PDOWN;\r\nif (val != new_val)\r\nerr = mv88e6352_serdes_write(chip, MII_BMCR, new_val);\r\nreturn err;\r\n}\r\nint mv88e6352_serdes_power(struct mv88e6xxx_chip *chip, int port, bool on)\r\n{\r\nint err;\r\nu8 cmode;\r\nerr = mv88e6xxx_port_get_cmode(chip, port, &cmode);\r\nif (err)\r\nreturn err;\r\nif ((cmode == MV88E6XXX_PORT_STS_CMODE_100BASE_X) ||\r\n(cmode == MV88E6XXX_PORT_STS_CMODE_1000BASE_X) ||\r\n(cmode == MV88E6XXX_PORT_STS_CMODE_SGMII)) {\r\nerr = mv88e6352_serdes_power_set(chip, on);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6390_serdes_10g(struct mv88e6xxx_chip *chip, int addr, bool on)\r\n{\r\nu16 val, new_val;\r\nint reg_c45;\r\nint err;\r\nreg_c45 = MII_ADDR_C45 | MV88E6390_SERDES_DEVICE |\r\nMV88E6390_PCS_CONTROL_1;\r\nerr = mv88e6xxx_phy_read(chip, addr, reg_c45, &val);\r\nif (err)\r\nreturn err;\r\nif (on)\r\nnew_val = val & ~(MV88E6390_PCS_CONTROL_1_RESET |\r\nMV88E6390_PCS_CONTROL_1_LOOPBACK |\r\nMV88E6390_PCS_CONTROL_1_PDOWN);\r\nelse\r\nnew_val = val | MV88E6390_PCS_CONTROL_1_PDOWN;\r\nif (val != new_val)\r\nerr = mv88e6xxx_phy_write(chip, addr, reg_c45, new_val);\r\nreturn err;\r\n}\r\nstatic int mv88e6390_serdes_sgmii(struct mv88e6xxx_chip *chip, int addr,\r\nbool on)\r\n{\r\nu16 val, new_val;\r\nint reg_c45;\r\nint err;\r\nreg_c45 = MII_ADDR_C45 | MV88E6390_SERDES_DEVICE |\r\nMV88E6390_SGMII_CONTROL;\r\nerr = mv88e6xxx_phy_read(chip, addr, reg_c45, &val);\r\nif (err)\r\nreturn err;\r\nif (on)\r\nnew_val = val & ~(MV88E6390_SGMII_CONTROL_RESET |\r\nMV88E6390_SGMII_CONTROL_LOOPBACK |\r\nMV88E6390_SGMII_CONTROL_PDOWN);\r\nelse\r\nnew_val = val | MV88E6390_SGMII_CONTROL_PDOWN;\r\nif (val != new_val)\r\nerr = mv88e6xxx_phy_write(chip, addr, reg_c45, new_val);\r\nreturn err;\r\n}\r\nstatic int mv88e6390_serdes_lower(struct mv88e6xxx_chip *chip, u8 cmode,\r\nint port_donor, int lane, bool rxaui, bool on)\r\n{\r\nint err;\r\nu8 cmode_donor;\r\nerr = mv88e6xxx_port_get_cmode(chip, port_donor, &cmode_donor);\r\nif (err)\r\nreturn err;\r\nswitch (cmode_donor) {\r\ncase MV88E6XXX_PORT_STS_CMODE_RXAUI:\r\nif (!rxaui)\r\nbreak;\r\ncase MV88E6XXX_PORT_STS_CMODE_1000BASE_X:\r\ncase MV88E6XXX_PORT_STS_CMODE_SGMII:\r\ncase MV88E6XXX_PORT_STS_CMODE_2500BASEX:\r\nif (cmode == MV88E6XXX_PORT_STS_CMODE_1000BASE_X ||\r\ncmode == MV88E6XXX_PORT_STS_CMODE_SGMII)\r\nreturn mv88e6390_serdes_sgmii(chip, lane, on);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6390_serdes_port9(struct mv88e6xxx_chip *chip, u8 cmode,\r\nbool on)\r\n{\r\nswitch (cmode) {\r\ncase MV88E6XXX_PORT_STS_CMODE_1000BASE_X:\r\ncase MV88E6XXX_PORT_STS_CMODE_SGMII:\r\nreturn mv88e6390_serdes_sgmii(chip, MV88E6390_PORT9_LANE0, on);\r\ncase MV88E6XXX_PORT_STS_CMODE_XAUI:\r\ncase MV88E6XXX_PORT_STS_CMODE_RXAUI:\r\ncase MV88E6XXX_PORT_STS_CMODE_2500BASEX:\r\nreturn mv88e6390_serdes_10g(chip, MV88E6390_PORT9_LANE0, on);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6390_serdes_port10(struct mv88e6xxx_chip *chip, u8 cmode,\r\nbool on)\r\n{\r\nswitch (cmode) {\r\ncase MV88E6XXX_PORT_STS_CMODE_SGMII:\r\nreturn mv88e6390_serdes_sgmii(chip, MV88E6390_PORT10_LANE0, on);\r\ncase MV88E6XXX_PORT_STS_CMODE_XAUI:\r\ncase MV88E6XXX_PORT_STS_CMODE_RXAUI:\r\ncase MV88E6XXX_PORT_STS_CMODE_1000BASE_X:\r\ncase MV88E6XXX_PORT_STS_CMODE_2500BASEX:\r\nreturn mv88e6390_serdes_10g(chip, MV88E6390_PORT10_LANE0, on);\r\n}\r\nreturn 0;\r\n}\r\nint mv88e6390_serdes_power(struct mv88e6xxx_chip *chip, int port, bool on)\r\n{\r\nu8 cmode;\r\nint err;\r\nerr = mv88e6xxx_port_get_cmode(chip, port, &cmode);\r\nif (err)\r\nreturn err;\r\nswitch (port) {\r\ncase 2:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 9,\r\nMV88E6390_PORT9_LANE1,\r\nfalse, on);\r\ncase 3:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 9,\r\nMV88E6390_PORT9_LANE2,\r\ntrue, on);\r\ncase 4:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 9,\r\nMV88E6390_PORT9_LANE3,\r\ntrue, on);\r\ncase 5:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 10,\r\nMV88E6390_PORT10_LANE1,\r\nfalse, on);\r\ncase 6:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 10,\r\nMV88E6390_PORT10_LANE2,\r\ntrue, on);\r\ncase 7:\r\nreturn mv88e6390_serdes_lower(chip, cmode, 10,\r\nMV88E6390_PORT10_LANE3,\r\ntrue, on);\r\ncase 9:\r\nreturn mv88e6390_serdes_port9(chip, cmode, on);\r\ncase 10:\r\nreturn mv88e6390_serdes_port10(chip, cmode, on);\r\n}\r\nreturn 0;\r\n}

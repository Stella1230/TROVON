static int ac97_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nint reg;\r\nsnd_soc_update_bits(codec, AC97_EXTENDED_STATUS, 0x1, 0x1);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreg = AC97_PCM_FRONT_DAC_RATE;\r\nelse\r\nreg = AC97_PCM_LR_ADC_RATE;\r\nreturn snd_soc_write(codec, reg, substream->runtime->rate);\r\n}\r\nstatic int wm9705_soc_suspend(struct snd_soc_codec *codec)\r\n{\r\nregcache_cache_bypass(codec->component.regmap, true);\r\nsnd_soc_write(codec, AC97_POWERDOWN, 0xffff);\r\nregcache_cache_bypass(codec->component.regmap, false);\r\nreturn 0;\r\n}\r\nstatic int wm9705_soc_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nret = snd_ac97_reset(ac97, true, WM9705_VENDOR_ID,\r\nWM9705_VENDOR_ID_MASK);\r\nif (ret < 0)\r\nreturn ret;\r\nregcache_sync(codec->component.regmap);\r\nreturn 0;\r\n}\r\nstatic int wm9705_soc_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97;\r\nstruct regmap *regmap;\r\nint ret;\r\nac97 = snd_soc_new_ac97_codec(codec, WM9705_VENDOR_ID,\r\nWM9705_VENDOR_ID_MASK);\r\nif (IS_ERR(ac97)) {\r\ndev_err(codec->dev, "Failed to register AC97 codec\n");\r\nreturn PTR_ERR(ac97);\r\n}\r\nregmap = regmap_init_ac97(ac97, &wm9705_regmap_config);\r\nif (IS_ERR(regmap)) {\r\nret = PTR_ERR(regmap);\r\ngoto err_free_ac97_codec;\r\n}\r\nsnd_soc_codec_set_drvdata(codec, ac97);\r\nsnd_soc_codec_init_regmap(codec, regmap);\r\nreturn 0;\r\nerr_free_ac97_codec:\r\nsnd_soc_free_ac97_codec(ac97);\r\nreturn ret;\r\n}\r\nstatic int wm9705_soc_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nsnd_soc_codec_exit_regmap(codec);\r\nsnd_soc_free_ac97_codec(ac97);\r\nreturn 0;\r\n}\r\nstatic int wm9705_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_wm9705, wm9705_dai, ARRAY_SIZE(wm9705_dai));\r\n}\r\nstatic int wm9705_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

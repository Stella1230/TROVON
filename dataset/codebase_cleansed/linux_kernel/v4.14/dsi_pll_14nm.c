static bool pll_14nm_poll_for_ready(struct dsi_pll_14nm *pll_14nm,\r\nu32 nb_tries, u32 timeout_us)\r\n{\r\nbool pll_locked = false;\r\nvoid __iomem *base = pll_14nm->mmio;\r\nu32 tries, val;\r\ntries = nb_tries;\r\nwhile (tries--) {\r\nval = pll_read(base +\r\nREG_DSI_14nm_PHY_PLL_RESET_SM_READY_STATUS);\r\npll_locked = !!(val & BIT(5));\r\nif (pll_locked)\r\nbreak;\r\nudelay(timeout_us);\r\n}\r\nif (!pll_locked) {\r\ntries = nb_tries;\r\nwhile (tries--) {\r\nval = pll_read(base +\r\nREG_DSI_14nm_PHY_PLL_RESET_SM_READY_STATUS);\r\npll_locked = !!(val & BIT(0));\r\nif (pll_locked)\r\nbreak;\r\nudelay(timeout_us);\r\n}\r\n}\r\nDBG("DSI PLL is %slocked", pll_locked ? "" : "*not* ");\r\nreturn pll_locked;\r\n}\r\nstatic void dsi_pll_14nm_input_init(struct dsi_pll_14nm *pll)\r\n{\r\npll->in.fref = pll->vco_ref_clk_rate;\r\npll->in.fdata = 0;\r\npll->in.dsiclk_sel = 1;\r\npll->in.ldo_en = 0;\r\npll->in.refclk_dbler_en = 0;\r\npll->in.vco_measure_time = 5;\r\npll->in.kvco_measure_time = 5;\r\npll->in.bandgap_timer = 4;\r\npll->in.pll_wakeup_timer = 5;\r\npll->in.plllock_cnt = 1;\r\npll->in.plllock_rng = 0;\r\npll->in.ssc_en = 1;\r\npll->in.ssc_center = 0;\r\npll->in.ssc_spread = 5;\r\npll->in.ssc_freq = 31500;\r\npll->in.ssc_adj_period = 37;\r\npll->in.pll_ie_trim = 4;\r\npll->in.pll_ip_trim = 4;\r\npll->in.pll_cpcset_cur = 1;\r\npll->in.pll_cpmset_cur = 1;\r\npll->in.pll_icpmset = 4;\r\npll->in.pll_icpcset = 4;\r\npll->in.pll_icpmset_p = 0;\r\npll->in.pll_icpmset_m = 0;\r\npll->in.pll_icpcset_p = 0;\r\npll->in.pll_icpcset_m = 0;\r\npll->in.pll_lpf_res1 = 3;\r\npll->in.pll_lpf_cap1 = 11;\r\npll->in.pll_lpf_cap2 = 1;\r\npll->in.pll_iptat_trim = 7;\r\npll->in.pll_c3ctrl = 2;\r\npll->in.pll_r3ctrl = 1;\r\n}\r\nstatic void pll_14nm_ssc_calc(struct dsi_pll_14nm *pll)\r\n{\r\nu32 period, ssc_period;\r\nu32 ref, rem;\r\nu64 step_size;\r\nDBG("vco=%lld ref=%lld", pll->vco_current_rate, pll->vco_ref_clk_rate);\r\nssc_period = pll->in.ssc_freq / 500;\r\nperiod = (u32)pll->vco_ref_clk_rate / 1000;\r\nssc_period = CEIL(period, ssc_period);\r\nssc_period -= 1;\r\npll->out.ssc_period = ssc_period;\r\nDBG("ssc freq=%d spread=%d period=%d", pll->in.ssc_freq,\r\npll->in.ssc_spread, pll->out.ssc_period);\r\nstep_size = (u32)pll->vco_current_rate;\r\nref = pll->vco_ref_clk_rate;\r\nref /= 1000;\r\nstep_size = div_u64(step_size, ref);\r\nstep_size <<= 20;\r\nstep_size = div_u64(step_size, 1000);\r\nstep_size *= pll->in.ssc_spread;\r\nstep_size = div_u64(step_size, 1000);\r\nstep_size *= (pll->in.ssc_adj_period + 1);\r\nrem = 0;\r\nstep_size = div_u64_rem(step_size, ssc_period + 1, &rem);\r\nif (rem)\r\nstep_size++;\r\nDBG("step_size=%lld", step_size);\r\nstep_size &= 0x0ffff;\r\npll->out.ssc_step_size = step_size;\r\n}\r\nstatic void pll_14nm_dec_frac_calc(struct dsi_pll_14nm *pll)\r\n{\r\nstruct dsi_pll_input *pin = &pll->in;\r\nstruct dsi_pll_output *pout = &pll->out;\r\nu64 multiplier = BIT(20);\r\nu64 dec_start_multiple, dec_start, pll_comp_val;\r\nu32 duration, div_frac_start;\r\nu64 vco_clk_rate = pll->vco_current_rate;\r\nu64 fref = pll->vco_ref_clk_rate;\r\nDBG("vco_clk_rate=%lld ref_clk_rate=%lld", vco_clk_rate, fref);\r\ndec_start_multiple = div_u64(vco_clk_rate * multiplier, fref);\r\ndiv_u64_rem(dec_start_multiple, multiplier, &div_frac_start);\r\ndec_start = div_u64(dec_start_multiple, multiplier);\r\npout->dec_start = (u32)dec_start;\r\npout->div_frac_start = div_frac_start;\r\nif (pin->plllock_cnt == 0)\r\nduration = 1024;\r\nelse if (pin->plllock_cnt == 1)\r\nduration = 256;\r\nelse if (pin->plllock_cnt == 2)\r\nduration = 128;\r\nelse\r\nduration = 32;\r\npll_comp_val = duration * dec_start_multiple;\r\npll_comp_val = div_u64(pll_comp_val, multiplier);\r\ndo_div(pll_comp_val, 10);\r\npout->plllock_cmp = (u32)pll_comp_val;\r\npout->pll_txclk_en = 1;\r\npout->cmn_ldo_cntrl = 0x3c;\r\n}\r\nstatic u32 pll_14nm_kvco_slop(u32 vrate)\r\n{\r\nu32 slop = 0;\r\nif (vrate > VCO_MIN_RATE && vrate <= 1800000000UL)\r\nslop = 600;\r\nelse if (vrate > 1800000000UL && vrate < 2300000000UL)\r\nslop = 400;\r\nelse if (vrate > 2300000000UL && vrate < VCO_MAX_RATE)\r\nslop = 280;\r\nreturn slop;\r\n}\r\nstatic void pll_14nm_calc_vco_count(struct dsi_pll_14nm *pll)\r\n{\r\nstruct dsi_pll_input *pin = &pll->in;\r\nstruct dsi_pll_output *pout = &pll->out;\r\nu64 vco_clk_rate = pll->vco_current_rate;\r\nu64 fref = pll->vco_ref_clk_rate;\r\nu64 data;\r\nu32 cnt;\r\ndata = fref * pin->vco_measure_time;\r\ndo_div(data, 1000000);\r\ndata &= 0x03ff;\r\ndata -= 2;\r\npout->pll_vco_div_ref = data;\r\ndata = div_u64(vco_clk_rate, 1000000);\r\ndata *= pin->vco_measure_time;\r\ndo_div(data, 10);\r\npout->pll_vco_count = data;\r\ndata = fref * pin->kvco_measure_time;\r\ndo_div(data, 1000000);\r\ndata &= 0x03ff;\r\ndata -= 1;\r\npout->pll_kvco_div_ref = data;\r\ncnt = pll_14nm_kvco_slop(vco_clk_rate);\r\ncnt *= 2;\r\ncnt /= 100;\r\ncnt *= pin->kvco_measure_time;\r\npout->pll_kvco_count = cnt;\r\npout->pll_misc1 = 16;\r\npout->pll_resetsm_cntrl = 48;\r\npout->pll_resetsm_cntrl2 = pin->bandgap_timer << 3;\r\npout->pll_resetsm_cntrl5 = pin->pll_wakeup_timer;\r\npout->pll_kvco_code = 0;\r\n}\r\nstatic void pll_db_commit_ssc(struct dsi_pll_14nm *pll)\r\n{\r\nvoid __iomem *base = pll->mmio;\r\nstruct dsi_pll_input *pin = &pll->in;\r\nstruct dsi_pll_output *pout = &pll->out;\r\nu8 data;\r\ndata = pin->ssc_adj_period;\r\ndata &= 0x0ff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_ADJ_PER1, data);\r\ndata = (pin->ssc_adj_period >> 8);\r\ndata &= 0x03;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_ADJ_PER2, data);\r\ndata = pout->ssc_period;\r\ndata &= 0x0ff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_PER1, data);\r\ndata = (pout->ssc_period >> 8);\r\ndata &= 0x0ff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_PER2, data);\r\ndata = pout->ssc_step_size;\r\ndata &= 0x0ff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_STEP_SIZE1, data);\r\ndata = (pout->ssc_step_size >> 8);\r\ndata &= 0x0ff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_STEP_SIZE2, data);\r\ndata = (pin->ssc_center & 0x01);\r\ndata <<= 1;\r\ndata |= 0x01;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SSC_EN_CENTER, data);\r\nwmb();\r\n}\r\nstatic void pll_db_commit_common(struct dsi_pll_14nm *pll,\r\nstruct dsi_pll_input *pin,\r\nstruct dsi_pll_output *pout)\r\n{\r\nvoid __iomem *base = pll->mmio;\r\nu8 data;\r\ndata = 0;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_SYSCLK_EN_RESET, data);\r\ndata = pout->pll_txclk_en;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_TXCLK_EN, data);\r\ndata = pout->pll_resetsm_cntrl;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_RESETSM_CNTRL, data);\r\ndata = pout->pll_resetsm_cntrl2;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_RESETSM_CNTRL2, data);\r\ndata = pout->pll_resetsm_cntrl5;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_RESETSM_CNTRL5, data);\r\ndata = pout->pll_vco_div_ref & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_VCO_DIV_REF1, data);\r\ndata = (pout->pll_vco_div_ref >> 8) & 0x3;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_VCO_DIV_REF2, data);\r\ndata = pout->pll_kvco_div_ref & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_KVCO_DIV_REF1, data);\r\ndata = (pout->pll_kvco_div_ref >> 8) & 0x3;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_KVCO_DIV_REF2, data);\r\ndata = pout->pll_misc1;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_MISC1, data);\r\ndata = pin->pll_ie_trim;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_IE_TRIM, data);\r\ndata = pin->pll_ip_trim;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_IP_TRIM, data);\r\ndata = pin->pll_cpmset_cur << 3 | pin->pll_cpcset_cur;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_CP_SET_CUR, data);\r\ndata = pin->pll_icpcset_p << 3 | pin->pll_icpcset_m;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_ICPCSET, data);\r\ndata = pin->pll_icpmset_p << 3 | pin->pll_icpcset_m;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_ICPMSET, data);\r\ndata = pin->pll_icpmset << 3 | pin->pll_icpcset;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_ICP_SET, data);\r\ndata = pin->pll_lpf_cap2 << 4 | pin->pll_lpf_cap1;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_LPF1, data);\r\ndata = pin->pll_iptat_trim;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_IPTAT_TRIM, data);\r\ndata = pin->pll_c3ctrl | pin->pll_r3ctrl << 4;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_CRCTRL, data);\r\n}\r\nstatic void pll_14nm_software_reset(struct dsi_pll_14nm *pll_14nm)\r\n{\r\nvoid __iomem *cmn_base = pll_14nm->phy_cmn_mmio;\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_PLL_CNTRL, 0);\r\npll_write_udelay(cmn_base + REG_DSI_14nm_PHY_CMN_CTRL_1, 0x20, 10);\r\nwmb();\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_CTRL_1, 0);\r\nwmb();\r\n}\r\nstatic void pll_db_commit_14nm(struct dsi_pll_14nm *pll,\r\nstruct dsi_pll_input *pin,\r\nstruct dsi_pll_output *pout)\r\n{\r\nvoid __iomem *base = pll->mmio;\r\nvoid __iomem *cmn_base = pll->phy_cmn_mmio;\r\nu8 data;\r\nDBG("DSI%d PLL", pll->id);\r\ndata = pout->cmn_ldo_cntrl;\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_LDO_CNTRL, data);\r\npll_db_commit_common(pll, pin, pout);\r\npll_14nm_software_reset(pll);\r\ndata = pin->dsiclk_sel;\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_CLK_CFG1, data);\r\ndata = 0xff;\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_CTRL_0, data);\r\ndata = pout->dec_start;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_DEC_START, data);\r\ndata = pout->div_frac_start & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START1, data);\r\ndata = (pout->div_frac_start >> 8) & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START2, data);\r\ndata = (pout->div_frac_start >> 16) & 0xf;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START3, data);\r\ndata = pout->plllock_cmp & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLLLOCK_CMP1, data);\r\ndata = (pout->plllock_cmp >> 8) & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLLLOCK_CMP2, data);\r\ndata = (pout->plllock_cmp >> 16) & 0x3;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLLLOCK_CMP3, data);\r\ndata = pin->plllock_cnt << 1 | pin->plllock_rng << 3;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLLLOCK_CMP_EN, data);\r\ndata = pout->pll_vco_count & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_VCO_COUNT1, data);\r\ndata = (pout->pll_vco_count >> 8) & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_VCO_COUNT2, data);\r\ndata = pout->pll_kvco_count & 0xff;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_KVCO_COUNT1, data);\r\ndata = (pout->pll_kvco_count >> 8) & 0x3;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_KVCO_COUNT2, data);\r\ndata = (pout->pll_postdiv - 1) << 4 | pin->pll_lpf_res1;\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_LPF2_POSTDIV, data);\r\nif (pin->ssc_en)\r\npll_db_commit_ssc(pll);\r\nwmb();\r\n}\r\nstatic int dsi_pll_14nm_vco_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct msm_dsi_pll *pll = hw_clk_to_pll(hw);\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nstruct dsi_pll_input *pin = &pll_14nm->in;\r\nstruct dsi_pll_output *pout = &pll_14nm->out;\r\nDBG("DSI PLL%d rate=%lu, parent's=%lu", pll_14nm->id, rate,\r\nparent_rate);\r\npll_14nm->vco_current_rate = rate;\r\npll_14nm->vco_ref_clk_rate = VCO_REF_CLK_RATE;\r\ndsi_pll_14nm_input_init(pll_14nm);\r\npout->pll_postdiv = DSI_PLL_DEFAULT_VCO_POSTDIV;\r\npll_14nm_dec_frac_calc(pll_14nm);\r\nif (pin->ssc_en)\r\npll_14nm_ssc_calc(pll_14nm);\r\npll_14nm_calc_vco_count(pll_14nm);\r\nif (pll_14nm->uc == MSM_DSI_PHY_MASTER) {\r\nstruct dsi_pll_14nm *pll_14nm_slave = pll_14nm->slave;\r\npll_db_commit_14nm(pll_14nm_slave, pin, pout);\r\n}\r\npll_db_commit_14nm(pll_14nm, pin, pout);\r\nreturn 0;\r\n}\r\nstatic unsigned long dsi_pll_14nm_vco_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct msm_dsi_pll *pll = hw_clk_to_pll(hw);\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nvoid __iomem *base = pll_14nm->mmio;\r\nu64 vco_rate, multiplier = BIT(20);\r\nu32 div_frac_start;\r\nu32 dec_start;\r\nu64 ref_clk = parent_rate;\r\ndec_start = pll_read(base + REG_DSI_14nm_PHY_PLL_DEC_START);\r\ndec_start &= 0x0ff;\r\nDBG("dec_start = %x", dec_start);\r\ndiv_frac_start = (pll_read(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START3)\r\n& 0xf) << 16;\r\ndiv_frac_start |= (pll_read(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START2)\r\n& 0xff) << 8;\r\ndiv_frac_start |= pll_read(base + REG_DSI_14nm_PHY_PLL_DIV_FRAC_START1)\r\n& 0xff;\r\nDBG("div_frac_start = %x", div_frac_start);\r\nvco_rate = ref_clk * dec_start;\r\nvco_rate += ((ref_clk * div_frac_start) / multiplier);\r\nvco_rate = DIV_ROUND_UP_ULL(vco_rate, 1000) * 1000;\r\nDBG("returning vco rate = %lu", (unsigned long)vco_rate);\r\nreturn (unsigned long)vco_rate;\r\n}\r\nstatic unsigned long dsi_pll_14nm_postdiv_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct dsi_pll_14nm_postdiv *postdiv = to_pll_14nm_postdiv(hw);\r\nstruct dsi_pll_14nm *pll_14nm = postdiv->pll;\r\nvoid __iomem *base = pll_14nm->phy_cmn_mmio;\r\nu8 shift = postdiv->shift;\r\nu8 width = postdiv->width;\r\nu32 val;\r\nDBG("DSI%d PLL parent rate=%lu", pll_14nm->id, parent_rate);\r\nval = pll_read(base + REG_DSI_14nm_PHY_CMN_CLK_CFG0) >> shift;\r\nval &= div_mask(width);\r\nreturn divider_recalc_rate(hw, parent_rate, val, NULL,\r\npostdiv->flags);\r\n}\r\nstatic long dsi_pll_14nm_postdiv_round_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct dsi_pll_14nm_postdiv *postdiv = to_pll_14nm_postdiv(hw);\r\nstruct dsi_pll_14nm *pll_14nm = postdiv->pll;\r\nDBG("DSI%d PLL parent rate=%lu", pll_14nm->id, rate);\r\nreturn divider_round_rate(hw, rate, prate, NULL,\r\npostdiv->width,\r\npostdiv->flags);\r\n}\r\nstatic int dsi_pll_14nm_postdiv_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct dsi_pll_14nm_postdiv *postdiv = to_pll_14nm_postdiv(hw);\r\nstruct dsi_pll_14nm *pll_14nm = postdiv->pll;\r\nvoid __iomem *base = pll_14nm->phy_cmn_mmio;\r\nspinlock_t *lock = &pll_14nm->postdiv_lock;\r\nu8 shift = postdiv->shift;\r\nu8 width = postdiv->width;\r\nunsigned int value;\r\nunsigned long flags = 0;\r\nu32 val;\r\nDBG("DSI%d PLL parent rate=%lu parent rate %lu", pll_14nm->id, rate,\r\nparent_rate);\r\nvalue = divider_get_val(rate, parent_rate, NULL, postdiv->width,\r\npostdiv->flags);\r\nspin_lock_irqsave(lock, flags);\r\nval = pll_read(base + REG_DSI_14nm_PHY_CMN_CLK_CFG0);\r\nval &= ~(div_mask(width) << shift);\r\nval |= value << shift;\r\npll_write(base + REG_DSI_14nm_PHY_CMN_CLK_CFG0, val);\r\nif (pll_14nm->uc == MSM_DSI_PHY_MASTER) {\r\nstruct dsi_pll_14nm *pll_14nm_slave = pll_14nm->slave;\r\nvoid __iomem *slave_base = pll_14nm_slave->phy_cmn_mmio;\r\npll_write(slave_base + REG_DSI_14nm_PHY_CMN_CLK_CFG0, val);\r\n}\r\nspin_unlock_irqrestore(lock, flags);\r\nreturn 0;\r\n}\r\nstatic int dsi_pll_14nm_enable_seq(struct msm_dsi_pll *pll)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nvoid __iomem *base = pll_14nm->mmio;\r\nvoid __iomem *cmn_base = pll_14nm->phy_cmn_mmio;\r\nbool locked;\r\nDBG("");\r\npll_write(base + REG_DSI_14nm_PHY_PLL_VREF_CFG1, 0x10);\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_PLL_CNTRL, 1);\r\nlocked = pll_14nm_poll_for_ready(pll_14nm, POLL_MAX_READS,\r\nPOLL_TIMEOUT_US);\r\nif (unlikely(!locked))\r\ndev_err(&pll_14nm->pdev->dev, "DSI PLL lock failed\n");\r\nelse\r\nDBG("DSI PLL lock success");\r\nreturn locked ? 0 : -EINVAL;\r\n}\r\nstatic void dsi_pll_14nm_disable_seq(struct msm_dsi_pll *pll)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nvoid __iomem *cmn_base = pll_14nm->phy_cmn_mmio;\r\nDBG("");\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_PLL_CNTRL, 0);\r\n}\r\nstatic void dsi_pll_14nm_save_state(struct msm_dsi_pll *pll)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nstruct pll_14nm_cached_state *cached_state = &pll_14nm->cached_state;\r\nvoid __iomem *cmn_base = pll_14nm->phy_cmn_mmio;\r\nu32 data;\r\ndata = pll_read(cmn_base + REG_DSI_14nm_PHY_CMN_CLK_CFG0);\r\ncached_state->n1postdiv = data & 0xf;\r\ncached_state->n2postdiv = (data >> 4) & 0xf;\r\nDBG("DSI%d PLL save state %x %x", pll_14nm->id,\r\ncached_state->n1postdiv, cached_state->n2postdiv);\r\ncached_state->vco_rate = clk_hw_get_rate(&pll->clk_hw);\r\n}\r\nstatic int dsi_pll_14nm_restore_state(struct msm_dsi_pll *pll)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nstruct pll_14nm_cached_state *cached_state = &pll_14nm->cached_state;\r\nvoid __iomem *cmn_base = pll_14nm->phy_cmn_mmio;\r\nu32 data;\r\nint ret;\r\nret = dsi_pll_14nm_vco_set_rate(&pll->clk_hw,\r\ncached_state->vco_rate, 0);\r\nif (ret) {\r\ndev_err(&pll_14nm->pdev->dev,\r\n"restore vco rate failed. ret=%d\n", ret);\r\nreturn ret;\r\n}\r\ndata = cached_state->n1postdiv | (cached_state->n2postdiv << 4);\r\nDBG("DSI%d PLL restore state %x %x", pll_14nm->id,\r\ncached_state->n1postdiv, cached_state->n2postdiv);\r\npll_write(cmn_base + REG_DSI_14nm_PHY_CMN_CLK_CFG0, data);\r\nif (pll_14nm->uc == MSM_DSI_PHY_MASTER) {\r\nstruct dsi_pll_14nm *pll_14nm_slave = pll_14nm->slave;\r\nvoid __iomem *slave_base = pll_14nm_slave->phy_cmn_mmio;\r\npll_write(slave_base + REG_DSI_14nm_PHY_CMN_CLK_CFG0, data);\r\n}\r\nreturn 0;\r\n}\r\nstatic int dsi_pll_14nm_set_usecase(struct msm_dsi_pll *pll,\r\nenum msm_dsi_phy_usecase uc)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nvoid __iomem *base = pll_14nm->mmio;\r\nu32 clkbuflr_en, bandgap = 0;\r\nswitch (uc) {\r\ncase MSM_DSI_PHY_STANDALONE:\r\nclkbuflr_en = 0x1;\r\nbreak;\r\ncase MSM_DSI_PHY_MASTER:\r\nclkbuflr_en = 0x3;\r\npll_14nm->slave = pll_14nm_list[(pll_14nm->id + 1) % DSI_MAX];\r\nbreak;\r\ncase MSM_DSI_PHY_SLAVE:\r\nclkbuflr_en = 0x0;\r\nbandgap = 0x3;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\npll_write(base + REG_DSI_14nm_PHY_PLL_CLKBUFLR_EN, clkbuflr_en);\r\nif (bandgap)\r\npll_write(base + REG_DSI_14nm_PHY_PLL_PLL_BANDGAP, bandgap);\r\npll_14nm->uc = uc;\r\nreturn 0;\r\n}\r\nstatic int dsi_pll_14nm_get_provider(struct msm_dsi_pll *pll,\r\nstruct clk **byte_clk_provider,\r\nstruct clk **pixel_clk_provider)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nstruct clk_hw_onecell_data *hw_data = pll_14nm->hw_data;\r\nif (byte_clk_provider)\r\n*byte_clk_provider = hw_data->hws[DSI_BYTE_PLL_CLK]->clk;\r\nif (pixel_clk_provider)\r\n*pixel_clk_provider = hw_data->hws[DSI_PIXEL_PLL_CLK]->clk;\r\nreturn 0;\r\n}\r\nstatic void dsi_pll_14nm_destroy(struct msm_dsi_pll *pll)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm = to_pll_14nm(pll);\r\nstruct platform_device *pdev = pll_14nm->pdev;\r\nint num_hws = pll_14nm->num_hws;\r\nof_clk_del_provider(pdev->dev.of_node);\r\nwhile (num_hws--)\r\nclk_hw_unregister(pll_14nm->hws[num_hws]);\r\n}\r\nstatic struct clk_hw *pll_14nm_postdiv_register(struct dsi_pll_14nm *pll_14nm,\r\nconst char *name,\r\nconst char *parent_name,\r\nunsigned long flags,\r\nu8 shift)\r\n{\r\nstruct dsi_pll_14nm_postdiv *pll_postdiv;\r\nstruct device *dev = &pll_14nm->pdev->dev;\r\nstruct clk_init_data postdiv_init = {\r\n.parent_names = (const char *[]) { parent_name },\r\n.num_parents = 1,\r\n.name = name,\r\n.flags = flags,\r\n.ops = &clk_ops_dsi_pll_14nm_postdiv,\r\n};\r\nint ret;\r\npll_postdiv = devm_kzalloc(dev, sizeof(*pll_postdiv), GFP_KERNEL);\r\nif (!pll_postdiv)\r\nreturn ERR_PTR(-ENOMEM);\r\npll_postdiv->pll = pll_14nm;\r\npll_postdiv->shift = shift;\r\npll_postdiv->width = 4;\r\npll_postdiv->flags = CLK_DIVIDER_ONE_BASED;\r\npll_postdiv->hw.init = &postdiv_init;\r\nret = clk_hw_register(dev, &pll_postdiv->hw);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn &pll_postdiv->hw;\r\n}\r\nstatic int pll_14nm_register(struct dsi_pll_14nm *pll_14nm)\r\n{\r\nchar clk_name[32], parent[32], vco_name[32];\r\nstruct clk_init_data vco_init = {\r\n.parent_names = (const char *[]){ "xo" },\r\n.num_parents = 1,\r\n.name = vco_name,\r\n.flags = CLK_IGNORE_UNUSED,\r\n.ops = &clk_ops_dsi_pll_14nm_vco,\r\n};\r\nstruct device *dev = &pll_14nm->pdev->dev;\r\nstruct clk_hw **hws = pll_14nm->hws;\r\nstruct clk_hw_onecell_data *hw_data;\r\nstruct clk_hw *hw;\r\nint num = 0;\r\nint ret;\r\nDBG("DSI%d", pll_14nm->id);\r\nhw_data = devm_kzalloc(dev, sizeof(*hw_data) +\r\nNUM_PROVIDED_CLKS * sizeof(struct clk_hw *),\r\nGFP_KERNEL);\r\nif (!hw_data)\r\nreturn -ENOMEM;\r\nsnprintf(vco_name, 32, "dsi%dvco_clk", pll_14nm->id);\r\npll_14nm->base.clk_hw.init = &vco_init;\r\nret = clk_hw_register(dev, &pll_14nm->base.clk_hw);\r\nif (ret)\r\nreturn ret;\r\nhws[num++] = &pll_14nm->base.clk_hw;\r\nsnprintf(clk_name, 32, "dsi%dn1_postdiv_clk", pll_14nm->id);\r\nsnprintf(parent, 32, "dsi%dvco_clk", pll_14nm->id);\r\nhw = pll_14nm_postdiv_register(pll_14nm, clk_name, parent,\r\nCLK_SET_RATE_PARENT, 0);\r\nif (IS_ERR(hw))\r\nreturn PTR_ERR(hw);\r\nhws[num++] = hw;\r\nsnprintf(clk_name, 32, "dsi%dpllbyte", pll_14nm->id);\r\nsnprintf(parent, 32, "dsi%dn1_postdiv_clk", pll_14nm->id);\r\nhw = clk_hw_register_fixed_factor(dev, clk_name, parent,\r\nCLK_SET_RATE_PARENT, 1, 8);\r\nif (IS_ERR(hw))\r\nreturn PTR_ERR(hw);\r\nhws[num++] = hw;\r\nhw_data->hws[DSI_BYTE_PLL_CLK] = hw;\r\nsnprintf(clk_name, 32, "dsi%dn1_postdivby2_clk", pll_14nm->id);\r\nsnprintf(parent, 32, "dsi%dn1_postdiv_clk", pll_14nm->id);\r\nhw = clk_hw_register_fixed_factor(dev, clk_name, parent, 0, 1, 2);\r\nif (IS_ERR(hw))\r\nreturn PTR_ERR(hw);\r\nhws[num++] = hw;\r\nsnprintf(clk_name, 32, "dsi%dpll", pll_14nm->id);\r\nsnprintf(parent, 32, "dsi%dn1_postdivby2_clk", pll_14nm->id);\r\nhw = pll_14nm_postdiv_register(pll_14nm, clk_name, parent, 0, 4);\r\nif (IS_ERR(hw))\r\nreturn PTR_ERR(hw);\r\nhws[num++] = hw;\r\nhw_data->hws[DSI_PIXEL_PLL_CLK] = hw;\r\npll_14nm->num_hws = num;\r\nhw_data->num = NUM_PROVIDED_CLKS;\r\npll_14nm->hw_data = hw_data;\r\nret = of_clk_add_hw_provider(dev->of_node, of_clk_hw_onecell_get,\r\npll_14nm->hw_data);\r\nif (ret) {\r\ndev_err(dev, "failed to register clk provider: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstruct msm_dsi_pll *msm_dsi_pll_14nm_init(struct platform_device *pdev, int id)\r\n{\r\nstruct dsi_pll_14nm *pll_14nm;\r\nstruct msm_dsi_pll *pll;\r\nint ret;\r\nif (!pdev)\r\nreturn ERR_PTR(-ENODEV);\r\npll_14nm = devm_kzalloc(&pdev->dev, sizeof(*pll_14nm), GFP_KERNEL);\r\nif (!pll_14nm)\r\nreturn ERR_PTR(-ENOMEM);\r\nDBG("PLL%d", id);\r\npll_14nm->pdev = pdev;\r\npll_14nm->id = id;\r\npll_14nm_list[id] = pll_14nm;\r\npll_14nm->phy_cmn_mmio = msm_ioremap(pdev, "dsi_phy", "DSI_PHY");\r\nif (IS_ERR_OR_NULL(pll_14nm->phy_cmn_mmio)) {\r\ndev_err(&pdev->dev, "failed to map CMN PHY base\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\npll_14nm->mmio = msm_ioremap(pdev, "dsi_pll", "DSI_PLL");\r\nif (IS_ERR_OR_NULL(pll_14nm->mmio)) {\r\ndev_err(&pdev->dev, "failed to map PLL base\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nspin_lock_init(&pll_14nm->postdiv_lock);\r\npll = &pll_14nm->base;\r\npll->min_rate = VCO_MIN_RATE;\r\npll->max_rate = VCO_MAX_RATE;\r\npll->get_provider = dsi_pll_14nm_get_provider;\r\npll->destroy = dsi_pll_14nm_destroy;\r\npll->disable_seq = dsi_pll_14nm_disable_seq;\r\npll->save_state = dsi_pll_14nm_save_state;\r\npll->restore_state = dsi_pll_14nm_restore_state;\r\npll->set_usecase = dsi_pll_14nm_set_usecase;\r\npll_14nm->vco_delay = 1;\r\npll->en_seq_cnt = 1;\r\npll->enable_seqs[0] = dsi_pll_14nm_enable_seq;\r\nret = pll_14nm_register(pll_14nm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register PLL: %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn pll;\r\n}

static void\r\nhs_ucode_patch_signature(const struct nvkm_falcon *falcon, void *acr_image,\r\nbool new_format)\r\n{\r\nstruct fw_bin_header *hsbin_hdr = acr_image;\r\nstruct hsf_fw_header *fw_hdr = acr_image + hsbin_hdr->header_offset;\r\nvoid *hs_data = acr_image + hsbin_hdr->data_offset;\r\nvoid *sig;\r\nu32 sig_size;\r\nu32 patch_loc, patch_sig;\r\nif (new_format) {\r\npatch_loc = fw_hdr->patch_loc;\r\npatch_sig = fw_hdr->patch_sig;\r\n} else {\r\npatch_loc = *(u32 *)(acr_image + fw_hdr->patch_loc);\r\npatch_sig = *(u32 *)(acr_image + fw_hdr->patch_sig);\r\n}\r\nif (falcon->debug) {\r\nsig = acr_image + fw_hdr->sig_dbg_offset;\r\nsig_size = fw_hdr->sig_dbg_size;\r\n} else {\r\nsig = acr_image + fw_hdr->sig_prod_offset;\r\nsig_size = fw_hdr->sig_prod_size;\r\n}\r\nmemcpy(hs_data + patch_loc, sig + patch_sig, sig_size);\r\n}\r\nvoid *\r\nhs_ucode_load_blob(struct nvkm_subdev *subdev, const struct nvkm_falcon *falcon,\r\nconst char *fw)\r\n{\r\nvoid *acr_image;\r\nbool new_format;\r\nacr_image = nvkm_acr_load_firmware(subdev, fw, 0);\r\nif (IS_ERR(acr_image))\r\nreturn acr_image;\r\nswitch (((u32 *)acr_image)[0]) {\r\ncase 0x3b1d14f0:\r\nnew_format = true;\r\nbreak;\r\ncase 0x000010de:\r\nnew_format = false;\r\nbreak;\r\ndefault:\r\nnvkm_error(subdev, "unknown header for HS blob %s\n", fw);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nhs_ucode_patch_signature(falcon, acr_image, new_format);\r\nreturn acr_image;\r\n}

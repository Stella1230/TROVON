static int snd_msndmidi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_msndmidi *mpu;\r\nsnd_printdd("snd_msndmidi_input_open()\n");\r\nmpu = substream->rmidi->private_data;\r\nmpu->substream_input = substream;\r\nsnd_msnd_enable_irq(mpu->dev);\r\nsnd_msnd_send_dsp_cmd(mpu->dev, HDEX_MIDI_IN_START);\r\nset_bit(MSNDMIDI_MODE_BIT_INPUT, &mpu->mode);\r\nreturn 0;\r\n}\r\nstatic int snd_msndmidi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_msndmidi *mpu;\r\nmpu = substream->rmidi->private_data;\r\nsnd_msnd_send_dsp_cmd(mpu->dev, HDEX_MIDI_IN_STOP);\r\nclear_bit(MSNDMIDI_MODE_BIT_INPUT, &mpu->mode);\r\nmpu->substream_input = NULL;\r\nsnd_msnd_disable_irq(mpu->dev);\r\nreturn 0;\r\n}\r\nstatic void snd_msndmidi_input_drop(struct snd_msndmidi *mpu)\r\n{\r\nu16 tail;\r\ntail = readw(mpu->dev->MIDQ + JQS_wTail);\r\nwritew(tail, mpu->dev->MIDQ + JQS_wHead);\r\n}\r\nstatic void snd_msndmidi_input_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nunsigned long flags;\r\nstruct snd_msndmidi *mpu;\r\nsnd_printdd("snd_msndmidi_input_trigger(, %i)\n", up);\r\nmpu = substream->rmidi->private_data;\r\nspin_lock_irqsave(&mpu->input_lock, flags);\r\nif (up) {\r\nif (!test_and_set_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER,\r\n&mpu->mode))\r\nsnd_msndmidi_input_drop(mpu);\r\n} else {\r\nclear_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER, &mpu->mode);\r\n}\r\nspin_unlock_irqrestore(&mpu->input_lock, flags);\r\nif (up)\r\nsnd_msndmidi_input_read(mpu);\r\n}\r\nvoid snd_msndmidi_input_read(void *mpuv)\r\n{\r\nunsigned long flags;\r\nstruct snd_msndmidi *mpu = mpuv;\r\nvoid *pwMIDQData = mpu->dev->mappedbase + MIDQ_DATA_BUFF;\r\nu16 head, tail, size;\r\nspin_lock_irqsave(&mpu->input_lock, flags);\r\nhead = readw(mpu->dev->MIDQ + JQS_wHead);\r\ntail = readw(mpu->dev->MIDQ + JQS_wTail);\r\nsize = readw(mpu->dev->MIDQ + JQS_wSize);\r\nif (head > size || tail > size)\r\ngoto out;\r\nwhile (head != tail) {\r\nunsigned char val = readw(pwMIDQData + 2 * head);\r\nif (test_bit(MSNDMIDI_MODE_BIT_INPUT_TRIGGER, &mpu->mode))\r\nsnd_rawmidi_receive(mpu->substream_input, &val, 1);\r\nif (++head > size)\r\nhead = 0;\r\nwritew(head, mpu->dev->MIDQ + JQS_wHead);\r\n}\r\nout:\r\nspin_unlock_irqrestore(&mpu->input_lock, flags);\r\n}\r\nstatic void snd_msndmidi_free(struct snd_rawmidi *rmidi)\r\n{\r\nstruct snd_msndmidi *mpu = rmidi->private_data;\r\nkfree(mpu);\r\n}\r\nint snd_msndmidi_new(struct snd_card *card, int device)\r\n{\r\nstruct snd_msnd *chip = card->private_data;\r\nstruct snd_msndmidi *mpu;\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nerr = snd_rawmidi_new(card, "MSND-MIDI", device, 1, 1, &rmidi);\r\nif (err < 0)\r\nreturn err;\r\nmpu = kzalloc(sizeof(*mpu), GFP_KERNEL);\r\nif (mpu == NULL) {\r\nsnd_device_free(card, rmidi);\r\nreturn -ENOMEM;\r\n}\r\nmpu->dev = chip;\r\nchip->msndmidi_mpu = mpu;\r\nrmidi->private_data = mpu;\r\nrmidi->private_free = snd_msndmidi_free;\r\nspin_lock_init(&mpu->input_lock);\r\nstrcpy(rmidi->name, "MSND MIDI");\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&snd_msndmidi_input);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nreturn 0;\r\n}

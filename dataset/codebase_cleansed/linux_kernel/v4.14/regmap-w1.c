static int w1_reg_a8_v8_read(void *context, unsigned int reg, unsigned int *val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 255)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_READ_DATA);\r\nw1_write_8(sl->master, reg);\r\n*val = w1_read_8(sl->master);\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic int w1_reg_a8_v8_write(void *context, unsigned int reg, unsigned int val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 255)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_WRITE_DATA);\r\nw1_write_8(sl->master, reg);\r\nw1_write_8(sl->master, val);\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic int w1_reg_a8_v16_read(void *context, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 255)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_READ_DATA);\r\nw1_write_8(sl->master, reg);\r\n*val = w1_read_8(sl->master);\r\n*val |= w1_read_8(sl->master)<<8;\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic int w1_reg_a8_v16_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 255)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_WRITE_DATA);\r\nw1_write_8(sl->master, reg);\r\nw1_write_8(sl->master, val & 0x00FF);\r\nw1_write_8(sl->master, val>>8 & 0x00FF);\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic int w1_reg_a16_v16_read(void *context, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 65535)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_READ_DATA);\r\nw1_write_8(sl->master, reg & 0x00FF);\r\nw1_write_8(sl->master, reg>>8 & 0x00FF);\r\n*val = w1_read_8(sl->master);\r\n*val |= w1_read_8(sl->master)<<8;\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic int w1_reg_a16_v16_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct device *dev = context;\r\nstruct w1_slave *sl = container_of(dev, struct w1_slave, dev);\r\nint ret = 0;\r\nif (reg > 65535)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_8(sl->master, W1_CMD_WRITE_DATA);\r\nw1_write_8(sl->master, reg & 0x00FF);\r\nw1_write_8(sl->master, reg>>8 & 0x00FF);\r\nw1_write_8(sl->master, val & 0x00FF);\r\nw1_write_8(sl->master, val>>8 & 0x00FF);\r\n} else {\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn ret;\r\n}\r\nstatic const struct regmap_bus *regmap_get_w1_bus(struct device *w1_dev,\r\nconst struct regmap_config *config)\r\n{\r\nif (config->reg_bits == 8 && config->val_bits == 8)\r\nreturn &regmap_w1_bus_a8_v8;\r\nif (config->reg_bits == 8 && config->val_bits == 16)\r\nreturn &regmap_w1_bus_a8_v16;\r\nif (config->reg_bits == 16 && config->val_bits == 16)\r\nreturn &regmap_w1_bus_a16_v16;\r\nreturn ERR_PTR(-ENOTSUPP);\r\n}\r\nstruct regmap *__regmap_init_w1(struct device *w1_dev,\r\nconst struct regmap_config *config,\r\nstruct lock_class_key *lock_key,\r\nconst char *lock_name)\r\n{\r\nconst struct regmap_bus *bus = regmap_get_w1_bus(w1_dev, config);\r\nif (IS_ERR(bus))\r\nreturn ERR_CAST(bus);\r\nreturn __regmap_init(w1_dev, bus, w1_dev, config,\r\nlock_key, lock_name);\r\nreturn NULL;\r\n}\r\nstruct regmap *__devm_regmap_init_w1(struct device *w1_dev,\r\nconst struct regmap_config *config,\r\nstruct lock_class_key *lock_key,\r\nconst char *lock_name)\r\n{\r\nconst struct regmap_bus *bus = regmap_get_w1_bus(w1_dev, config);\r\nif (IS_ERR(bus))\r\nreturn ERR_CAST(bus);\r\nreturn __devm_regmap_init(w1_dev, bus, w1_dev, config,\r\nlock_key, lock_name);\r\nreturn NULL;\r\n}

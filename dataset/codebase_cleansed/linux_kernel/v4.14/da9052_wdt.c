static int da9052_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct da9052_wdt_data *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct da9052 *da9052 = driver_data->da9052;\r\nint ret, i;\r\nret = da9052_reg_update(da9052, DA9052_CONTROL_D_REG,\r\nDA9052_CONTROLD_TWDSCALE, 0);\r\nif (ret < 0) {\r\ndev_err(da9052->dev, "Failed to disable watchdog bit, %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (timeout) {\r\nudelay(150);\r\nfor (i = 0; i < ARRAY_SIZE(da9052_wdt_maps); i++)\r\nif (da9052_wdt_maps[i].time == timeout)\r\nbreak;\r\nif (i == ARRAY_SIZE(da9052_wdt_maps))\r\nret = -EINVAL;\r\nelse\r\nret = da9052_reg_update(da9052, DA9052_CONTROL_D_REG,\r\nDA9052_CONTROLD_TWDSCALE,\r\nda9052_wdt_maps[i].reg_val);\r\nif (ret < 0) {\r\ndev_err(da9052->dev,\r\n"Failed to update timescale bit, %d\n", ret);\r\nreturn ret;\r\n}\r\nwdt_dev->timeout = timeout;\r\ndriver_data->jpast = jiffies;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9052_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nreturn da9052_wdt_set_timeout(wdt_dev, wdt_dev->timeout);\r\n}\r\nstatic int da9052_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nreturn da9052_wdt_set_timeout(wdt_dev, 0);\r\n}\r\nstatic int da9052_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct da9052_wdt_data *driver_data = watchdog_get_drvdata(wdt_dev);\r\nstruct da9052 *da9052 = driver_data->da9052;\r\nunsigned long msec, jnow = jiffies;\r\nint ret;\r\nmsec = (jnow - driver_data->jpast) * 1000/HZ;\r\nif (msec < DA9052_TWDMIN)\r\nmdelay(msec);\r\nret = da9052_reg_update(da9052, DA9052_CONTROL_D_REG,\r\nDA9052_CONTROLD_WATCHDOG, 1 << 7);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn da9052_reg_update(da9052, DA9052_CONTROL_D_REG,\r\nDA9052_CONTROLD_WATCHDOG, 0 << 7);\r\n}\r\nstatic int da9052_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct da9052 *da9052 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9052_wdt_data *driver_data;\r\nstruct watchdog_device *da9052_wdt;\r\nint ret;\r\ndriver_data = devm_kzalloc(&pdev->dev, sizeof(*driver_data),\r\nGFP_KERNEL);\r\nif (!driver_data)\r\nreturn -ENOMEM;\r\ndriver_data->da9052 = da9052;\r\nda9052_wdt = &driver_data->wdt;\r\nda9052_wdt->timeout = DA9052_DEF_TIMEOUT;\r\nda9052_wdt->info = &da9052_wdt_info;\r\nda9052_wdt->ops = &da9052_wdt_ops;\r\nda9052_wdt->parent = &pdev->dev;\r\nwatchdog_set_drvdata(da9052_wdt, driver_data);\r\nret = da9052_reg_update(da9052, DA9052_CONTROL_D_REG,\r\nDA9052_CONTROLD_TWDSCALE, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to disable watchdog bits, %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = devm_watchdog_register_device(&pdev->dev, &driver_data->wdt);\r\nif (ret != 0) {\r\ndev_err(da9052->dev, "watchdog_register_device() failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}

static int qi_lb60_ooblayout_ecc(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nif (section)\r\nreturn -ERANGE;\r\noobregion->length = 36;\r\noobregion->offset = 6;\r\nif (mtd->oobsize == 128) {\r\noobregion->length *= 2;\r\noobregion->offset *= 2;\r\n}\r\nreturn 0;\r\n}\r\nstatic int qi_lb60_ooblayout_free(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nint eccbytes = 36, eccoff = 6;\r\nif (section > 1)\r\nreturn -ERANGE;\r\nif (mtd->oobsize == 128) {\r\neccbytes *= 2;\r\neccoff *= 2;\r\n}\r\nif (!section) {\r\noobregion->offset = 2;\r\noobregion->length = eccoff - 2;\r\n} else {\r\noobregion->offset = eccoff + eccbytes;\r\noobregion->length = mtd->oobsize - oobregion->offset;\r\n}\r\nreturn 0;\r\n}\r\nstatic void qi_lb60_nand_ident(struct platform_device *pdev,\r\nstruct mtd_info *mtd, struct mtd_partition **partitions,\r\nint *num_partitions)\r\n{\r\nstruct nand_chip *chip = mtd_to_nand(mtd);\r\nif (chip->page_shift == 12) {\r\n*partitions = qi_lb60_partitions_2gb;\r\n*num_partitions = ARRAY_SIZE(qi_lb60_partitions_2gb);\r\n} else {\r\n*partitions = qi_lb60_partitions_1gb;\r\n*num_partitions = ARRAY_SIZE(qi_lb60_partitions_1gb);\r\n}\r\nmtd_set_ooblayout(mtd, &qi_lb60_ooblayout_ops);\r\n}\r\nstatic int __init qi_lb60_init_platform_devices(void)\r\n{\r\njz4740_framebuffer_device.dev.platform_data = &qi_lb60_fb_pdata;\r\njz4740_nand_device.dev.platform_data = &qi_lb60_nand_pdata;\r\njz4740_adc_device.dev.platform_data = &qi_lb60_battery_pdata;\r\njz4740_mmc_device.dev.platform_data = &qi_lb60_mmc_pdata;\r\ngpiod_add_lookup_table(&qi_lb60_audio_gpio_table);\r\ngpiod_add_lookup_table(&qi_lb60_nand_gpio_table);\r\nspi_register_board_info(qi_lb60_spi_board_info,\r\nARRAY_SIZE(qi_lb60_spi_board_info));\r\npwm_add_table(qi_lb60_pwm_lookup, ARRAY_SIZE(qi_lb60_pwm_lookup));\r\npinctrl_register_mappings(pin_map, ARRAY_SIZE(pin_map));\r\nreturn platform_add_devices(jz_platform_devices,\r\nARRAY_SIZE(jz_platform_devices));\r\n}\r\nstatic int __init qi_lb60_board_setup(void)\r\n{\r\nprintk(KERN_INFO "Qi Hardware JZ4740 QI LB60 setup\n");\r\nif (qi_lb60_init_platform_devices())\r\npanic("Failed to initialize platform devices");\r\nreturn 0;\r\n}

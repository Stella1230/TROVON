int genphy_c45_pma_setup_forced(struct phy_device *phydev)\r\n{\r\nint ctrl1, ctrl2, ret;\r\nif (phydev->duplex != DUPLEX_FULL)\r\nreturn -EINVAL;\r\nctrl1 = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1);\r\nif (ctrl1 < 0)\r\nreturn ctrl1;\r\nctrl2 = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL2);\r\nif (ctrl2 < 0)\r\nreturn ctrl2;\r\nctrl1 &= ~MDIO_CTRL1_SPEEDSEL;\r\nctrl2 &= ~(MDIO_PMA_CTRL2_TYPE | 0x30);\r\nswitch (phydev->speed) {\r\ncase SPEED_10:\r\nctrl2 |= MDIO_PMA_CTRL2_10BT;\r\nbreak;\r\ncase SPEED_100:\r\nctrl1 |= MDIO_PMA_CTRL1_SPEED100;\r\nctrl2 |= MDIO_PMA_CTRL2_100BTX;\r\nbreak;\r\ncase SPEED_1000:\r\nctrl1 |= MDIO_PMA_CTRL1_SPEED1000;\r\nctrl2 |= MDIO_PMA_CTRL2_1000BT;\r\nbreak;\r\ncase SPEED_10000:\r\nctrl1 |= MDIO_CTRL1_SPEED10G;\r\nctrl2 |= MDIO_PMA_CTRL2_10GBT;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = phy_write_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1, ctrl1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn phy_write_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL2, ctrl2);\r\n}\r\nint genphy_c45_an_disable_aneg(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_CTRL1);\r\nif (val < 0)\r\nreturn val;\r\nval &= ~(MDIO_AN_CTRL1_ENABLE | MDIO_AN_CTRL1_RESTART);\r\nreturn phy_write_mmd(phydev, MDIO_MMD_AN, MDIO_CTRL1, val);\r\n}\r\nint genphy_c45_restart_aneg(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_CTRL1);\r\nif (val < 0)\r\nreturn val;\r\nval |= MDIO_AN_CTRL1_ENABLE | MDIO_AN_CTRL1_RESTART;\r\nreturn phy_write_mmd(phydev, MDIO_MMD_AN, MDIO_CTRL1, val);\r\n}\r\nint genphy_c45_aneg_done(struct phy_device *phydev)\r\n{\r\nint val = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_STAT1);\r\nreturn val < 0 ? val : val & MDIO_AN_STAT1_COMPLETE ? 1 : 0;\r\n}\r\nint genphy_c45_read_link(struct phy_device *phydev, u32 mmd_mask)\r\n{\r\nint val, devad;\r\nbool link = true;\r\nwhile (mmd_mask) {\r\ndevad = __ffs(mmd_mask);\r\nmmd_mask &= ~BIT(devad);\r\nval = phy_read_mmd(phydev, devad, MDIO_STAT1);\r\nif (val < 0)\r\nreturn val;\r\nif (!(val & MDIO_STAT1_LSTATUS))\r\nlink = false;\r\n}\r\nreturn link;\r\n}\r\nint genphy_c45_read_lpa(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_LPA);\r\nif (val < 0)\r\nreturn val;\r\nphydev->lp_advertising = mii_lpa_to_ethtool_lpa_t(val);\r\nphydev->pause = val & LPA_PAUSE_CAP ? 1 : 0;\r\nphydev->asym_pause = val & LPA_PAUSE_ASYM ? 1 : 0;\r\nval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_10GBT_STAT);\r\nif (val < 0)\r\nreturn val;\r\nif (val & MDIO_AN_10GBT_STAT_LP10G)\r\nphydev->lp_advertising |= ADVERTISED_10000baseT_Full;\r\nreturn 0;\r\n}\r\nint genphy_c45_read_pma(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1);\r\nif (val < 0)\r\nreturn val;\r\nswitch (val & MDIO_CTRL1_SPEEDSEL) {\r\ncase 0:\r\nphydev->speed = SPEED_10;\r\nbreak;\r\ncase MDIO_PMA_CTRL1_SPEED100:\r\nphydev->speed = SPEED_100;\r\nbreak;\r\ncase MDIO_PMA_CTRL1_SPEED1000:\r\nphydev->speed = SPEED_1000;\r\nbreak;\r\ncase MDIO_CTRL1_SPEED10G:\r\nphydev->speed = SPEED_10000;\r\nbreak;\r\ndefault:\r\nphydev->speed = SPEED_UNKNOWN;\r\nbreak;\r\n}\r\nphydev->duplex = DUPLEX_FULL;\r\nreturn 0;\r\n}\r\nstatic int gen10g_config_aneg(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int gen10g_read_status(struct phy_device *phydev)\r\n{\r\nu32 mmd_mask = phydev->c45_ids.devices_in_package;\r\nint ret;\r\nphydev->speed = SPEED_10000;\r\nphydev->duplex = DUPLEX_FULL;\r\nmmd_mask &= ~(BIT(MDIO_MMD_VEND1) | BIT(MDIO_MMD_VEND2));\r\nret = genphy_c45_read_link(phydev, mmd_mask);\r\nphydev->link = ret > 0 ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int gen10g_soft_reset(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int gen10g_config_init(struct phy_device *phydev)\r\n{\r\nphydev->supported = SUPPORTED_10000baseT_Full;\r\nphydev->advertising = SUPPORTED_10000baseT_Full;\r\nreturn 0;\r\n}\r\nstatic int gen10g_suspend(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int gen10g_resume(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}

int r520_mc_wait_for_idle(struct radeon_device *rdev)\r\n{\r\nunsigned i;\r\nuint32_t tmp;\r\nfor (i = 0; i < rdev->usec_timeout; i++) {\r\ntmp = RREG32_MC(R520_MC_STATUS);\r\nif (tmp & R520_MC_STATUS_IDLE) {\r\nreturn 0;\r\n}\r\nDRM_UDELAY(1);\r\n}\r\nreturn -1;\r\n}\r\nstatic void r520_gpu_init(struct radeon_device *rdev)\r\n{\r\nunsigned pipe_select_current, gb_pipe_select, tmp;\r\nrv515_vga_render_disable(rdev);\r\nif (rdev->family == CHIP_RV530) {\r\nWREG32(0x4128, 0xFF);\r\n}\r\nr420_pipes_init(rdev);\r\ngb_pipe_select = RREG32(R400_GB_PIPE_SELECT);\r\ntmp = RREG32(R300_DST_PIPE_CONFIG);\r\npipe_select_current = (tmp >> 2) & 3;\r\ntmp = (1 << pipe_select_current) |\r\n(((gb_pipe_select >> 8) & 0xF) << 4);\r\nWREG32_PLL(0x000D, tmp);\r\nif (r520_mc_wait_for_idle(rdev)) {\r\npr_warn("Failed to wait MC idle while programming pipes. Bad things might happen.\n");\r\n}\r\n}\r\nstatic void r520_vram_get_type(struct radeon_device *rdev)\r\n{\r\nuint32_t tmp;\r\nrdev->mc.vram_width = 128;\r\nrdev->mc.vram_is_ddr = true;\r\ntmp = RREG32_MC(R520_MC_CNTL0);\r\nswitch ((tmp & R520_MEM_NUM_CHANNELS_MASK) >> R520_MEM_NUM_CHANNELS_SHIFT) {\r\ncase 0:\r\nrdev->mc.vram_width = 32;\r\nbreak;\r\ncase 1:\r\nrdev->mc.vram_width = 64;\r\nbreak;\r\ncase 2:\r\nrdev->mc.vram_width = 128;\r\nbreak;\r\ncase 3:\r\nrdev->mc.vram_width = 256;\r\nbreak;\r\ndefault:\r\nrdev->mc.vram_width = 128;\r\nbreak;\r\n}\r\nif (tmp & R520_MC_CHANNEL_SIZE)\r\nrdev->mc.vram_width *= 2;\r\n}\r\nstatic void r520_mc_init(struct radeon_device *rdev)\r\n{\r\nr520_vram_get_type(rdev);\r\nr100_vram_init_sizes(rdev);\r\nradeon_vram_location(rdev, &rdev->mc, 0);\r\nrdev->mc.gtt_base_align = 0;\r\nif (!(rdev->flags & RADEON_IS_AGP))\r\nradeon_gtt_location(rdev, &rdev->mc);\r\nradeon_update_bandwidth_info(rdev);\r\n}\r\nstatic void r520_mc_program(struct radeon_device *rdev)\r\n{\r\nstruct rv515_mc_save save;\r\nrv515_mc_stop(rdev, &save);\r\nif (r520_mc_wait_for_idle(rdev))\r\ndev_warn(rdev->dev, "Wait MC idle timeout before updating MC.\n");\r\nWREG32(R_0000F8_CONFIG_MEMSIZE, rdev->mc.real_vram_size);\r\nWREG32_MC(R_000004_MC_FB_LOCATION,\r\nS_000004_MC_FB_START(rdev->mc.vram_start >> 16) |\r\nS_000004_MC_FB_TOP(rdev->mc.vram_end >> 16));\r\nWREG32(R_000134_HDP_FB_LOCATION,\r\nS_000134_HDP_FB_START(rdev->mc.vram_start >> 16));\r\nif (rdev->flags & RADEON_IS_AGP) {\r\nWREG32_MC(R_000005_MC_AGP_LOCATION,\r\nS_000005_MC_AGP_START(rdev->mc.gtt_start >> 16) |\r\nS_000005_MC_AGP_TOP(rdev->mc.gtt_end >> 16));\r\nWREG32_MC(R_000006_AGP_BASE, lower_32_bits(rdev->mc.agp_base));\r\nWREG32_MC(R_000007_AGP_BASE_2,\r\nS_000007_AGP_BASE_ADDR_2(upper_32_bits(rdev->mc.agp_base)));\r\n} else {\r\nWREG32_MC(R_000005_MC_AGP_LOCATION, 0xFFFFFFFF);\r\nWREG32_MC(R_000006_AGP_BASE, 0);\r\nWREG32_MC(R_000007_AGP_BASE_2, 0);\r\n}\r\nrv515_mc_resume(rdev, &save);\r\n}\r\nstatic int r520_startup(struct radeon_device *rdev)\r\n{\r\nint r;\r\nr520_mc_program(rdev);\r\nrv515_clock_startup(rdev);\r\nr520_gpu_init(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE) {\r\nr = rv370_pcie_gart_enable(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr = radeon_wb_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP fences (%d).\n", r);\r\nreturn r;\r\n}\r\nif (!rdev->irq.installed) {\r\nr = radeon_irq_kms_init(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nrs600_irq_set(rdev);\r\nrdev->config.r300.hdp_cntl = RREG32(RADEON_HOST_PATH_CNTL);\r\nr = r100_cp_init(rdev, 1024 * 1024);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP (%d).\n", r);\r\nreturn r;\r\n}\r\nr = radeon_ib_pool_init(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "IB initialization failed (%d).\n", r);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nint r520_resume(struct radeon_device *rdev)\r\n{\r\nint r;\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nrv370_pcie_gart_disable(rdev);\r\nrv515_clock_startup(rdev);\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev, "GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\natom_asic_init(rdev->mode_info.atom_context);\r\nrv515_clock_startup(rdev);\r\nradeon_surface_init(rdev);\r\nrdev->accel_working = true;\r\nr = r520_startup(rdev);\r\nif (r) {\r\nrdev->accel_working = false;\r\n}\r\nreturn r;\r\n}\r\nint r520_init(struct radeon_device *rdev)\r\n{\r\nint r;\r\nradeon_scratch_init(rdev);\r\nradeon_surface_init(rdev);\r\nr100_restore_sanity(rdev);\r\nif (!radeon_get_bios(rdev)) {\r\nif (ASIC_IS_AVIVO(rdev))\r\nreturn -EINVAL;\r\n}\r\nif (rdev->is_atom_bios) {\r\nr = radeon_atombios_init(rdev);\r\nif (r)\r\nreturn r;\r\n} else {\r\ndev_err(rdev->dev, "Expecting atombios for RV515 GPU\n");\r\nreturn -EINVAL;\r\n}\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev,\r\n"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\nif (radeon_boot_test_post_card(rdev) == false)\r\nreturn -EINVAL;\r\nif (!radeon_card_posted(rdev) && rdev->bios) {\r\nDRM_INFO("GPU not posted. posting now...\n");\r\natom_asic_init(rdev->mode_info.atom_context);\r\n}\r\nradeon_get_clock_info(rdev->ddev);\r\nif (rdev->flags & RADEON_IS_AGP) {\r\nr = radeon_agp_init(rdev);\r\nif (r) {\r\nradeon_agp_disable(rdev);\r\n}\r\n}\r\nr520_mc_init(rdev);\r\nrv515_debugfs(rdev);\r\nr = radeon_fence_driver_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_bo_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = rv370_pcie_gart_init(rdev);\r\nif (r)\r\nreturn r;\r\nrv515_set_safe_registers(rdev);\r\nradeon_pm_init(rdev);\r\nrdev->accel_working = true;\r\nr = r520_startup(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "Disabling GPU acceleration\n");\r\nr100_cp_fini(rdev);\r\nradeon_wb_fini(rdev);\r\nradeon_ib_pool_fini(rdev);\r\nradeon_irq_kms_fini(rdev);\r\nrv370_pcie_gart_fini(rdev);\r\nradeon_agp_fini(rdev);\r\nrdev->accel_working = false;\r\n}\r\nreturn 0;\r\n}

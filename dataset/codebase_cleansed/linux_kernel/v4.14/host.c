static int dwc3_host_get_irq(struct dwc3 *dwc)\r\n{\r\nstruct platform_device *dwc3_pdev = to_platform_device(dwc->dev);\r\nint irq;\r\nirq = platform_get_irq_byname(dwc3_pdev, "host");\r\nif (irq > 0)\r\ngoto out;\r\nif (irq == -EPROBE_DEFER)\r\ngoto out;\r\nirq = platform_get_irq_byname(dwc3_pdev, "dwc_usb3");\r\nif (irq > 0)\r\ngoto out;\r\nif (irq == -EPROBE_DEFER)\r\ngoto out;\r\nirq = platform_get_irq(dwc3_pdev, 0);\r\nif (irq > 0)\r\ngoto out;\r\nif (irq != -EPROBE_DEFER)\r\ndev_err(dwc->dev, "missing host IRQ\n");\r\nif (!irq)\r\nirq = -EINVAL;\r\nout:\r\nreturn irq;\r\n}\r\nint dwc3_host_init(struct dwc3 *dwc)\r\n{\r\nstruct property_entry props[3];\r\nstruct platform_device *xhci;\r\nint ret, irq;\r\nstruct resource *res;\r\nstruct platform_device *dwc3_pdev = to_platform_device(dwc->dev);\r\nint prop_idx = 0;\r\nirq = dwc3_host_get_irq(dwc);\r\nif (irq < 0)\r\nreturn irq;\r\nres = platform_get_resource_byname(dwc3_pdev, IORESOURCE_IRQ, "host");\r\nif (!res)\r\nres = platform_get_resource_byname(dwc3_pdev, IORESOURCE_IRQ,\r\n"dwc_usb3");\r\nif (!res)\r\nres = platform_get_resource(dwc3_pdev, IORESOURCE_IRQ, 0);\r\nif (!res)\r\nreturn -ENOMEM;\r\ndwc->xhci_resources[1].start = irq;\r\ndwc->xhci_resources[1].end = irq;\r\ndwc->xhci_resources[1].flags = res->flags;\r\ndwc->xhci_resources[1].name = res->name;\r\nxhci = platform_device_alloc("xhci-hcd", PLATFORM_DEVID_AUTO);\r\nif (!xhci) {\r\ndev_err(dwc->dev, "couldn't allocate xHCI device\n");\r\nreturn -ENOMEM;\r\n}\r\nxhci->dev.parent = dwc->dev;\r\ndwc->xhci = xhci;\r\nret = platform_device_add_resources(xhci, dwc->xhci_resources,\r\nDWC3_XHCI_RESOURCES_NUM);\r\nif (ret) {\r\ndev_err(dwc->dev, "couldn't add resources to xHCI device\n");\r\ngoto err1;\r\n}\r\nmemset(props, 0, sizeof(struct property_entry) * ARRAY_SIZE(props));\r\nif (dwc->usb3_lpm_capable)\r\nprops[prop_idx++].name = "usb3-lpm-capable";\r\nif (dwc->revision <= DWC3_REVISION_300A)\r\nprops[prop_idx++].name = "quirk-broken-port-ped";\r\nif (prop_idx) {\r\nret = platform_device_add_properties(xhci, props);\r\nif (ret) {\r\ndev_err(dwc->dev, "failed to add properties to xHCI\n");\r\ngoto err1;\r\n}\r\n}\r\nphy_create_lookup(dwc->usb2_generic_phy, "usb2-phy",\r\ndev_name(dwc->dev));\r\nphy_create_lookup(dwc->usb3_generic_phy, "usb3-phy",\r\ndev_name(dwc->dev));\r\nret = platform_device_add(xhci);\r\nif (ret) {\r\ndev_err(dwc->dev, "failed to register xHCI device\n");\r\ngoto err2;\r\n}\r\nreturn 0;\r\nerr2:\r\nphy_remove_lookup(dwc->usb2_generic_phy, "usb2-phy",\r\ndev_name(dwc->dev));\r\nphy_remove_lookup(dwc->usb3_generic_phy, "usb3-phy",\r\ndev_name(dwc->dev));\r\nerr1:\r\nplatform_device_put(xhci);\r\nreturn ret;\r\n}\r\nvoid dwc3_host_exit(struct dwc3 *dwc)\r\n{\r\nphy_remove_lookup(dwc->usb2_generic_phy, "usb2-phy",\r\ndev_name(dwc->dev));\r\nphy_remove_lookup(dwc->usb3_generic_phy, "usb3-phy",\r\ndev_name(dwc->dev));\r\nplatform_device_unregister(dwc->xhci);\r\n}

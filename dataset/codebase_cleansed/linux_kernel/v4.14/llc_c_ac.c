int llc_conn_ac_clear_remote_busy(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (llc->remote_busy_flag) {\r\nu8 nr;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nllc->remote_busy_flag = 0;\r\ndel_timer(&llc->busy_state_timer.timer);\r\nnr = LLC_I_GET_NR(pdu);\r\nllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_conn_ind(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->ind_prim = LLC_CONN_PRIM;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_conn_confirm(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->cfm_prim = LLC_CONN_PRIM;\r\nreturn 0;\r\n}\r\nstatic int llc_conn_ac_data_confirm(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->cfm_prim = LLC_DATA_PRIM;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_data_ind(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_conn_rtn_pdu(sk, skb);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_disc_ind(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nu8 reason = 0;\r\nint rc = 0;\r\nif (ev->type == LLC_CONN_EV_TYPE_PDU) {\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nif (LLC_PDU_IS_RSP(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_RSP(pdu) == LLC_2_PDU_RSP_DM)\r\nreason = LLC_DISC_REASON_RX_DM_RSP_PDU;\r\nelse if (LLC_PDU_IS_CMD(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_CMD(pdu) == LLC_2_PDU_CMD_DISC)\r\nreason = LLC_DISC_REASON_RX_DISC_CMD_PDU;\r\n} else if (ev->type == LLC_CONN_EV_TYPE_ACK_TMR)\r\nreason = LLC_DISC_REASON_ACK_TMR_EXP;\r\nelse\r\nrc = -EINVAL;\r\nif (!rc) {\r\nev->reason = reason;\r\nev->ind_prim = LLC_DISC_PRIM;\r\n}\r\nreturn rc;\r\n}\r\nint llc_conn_ac_disc_confirm(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->reason = ev->status;\r\nev->cfm_prim = LLC_DISC_PRIM;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_rst_ind(struct sock *sk, struct sk_buff *skb)\r\n{\r\nu8 reason = 0;\r\nint rc = 1;\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nstruct llc_sock *llc = llc_sk(sk);\r\nswitch (ev->type) {\r\ncase LLC_CONN_EV_TYPE_PDU:\r\nif (LLC_PDU_IS_RSP(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_RSP(pdu) == LLC_2_PDU_RSP_FRMR) {\r\nreason = LLC_RESET_REASON_LOCAL;\r\nrc = 0;\r\n} else if (LLC_PDU_IS_CMD(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_CMD(pdu) == LLC_2_PDU_CMD_SABME) {\r\nreason = LLC_RESET_REASON_REMOTE;\r\nrc = 0;\r\n}\r\nbreak;\r\ncase LLC_CONN_EV_TYPE_ACK_TMR:\r\ncase LLC_CONN_EV_TYPE_P_TMR:\r\ncase LLC_CONN_EV_TYPE_REJ_TMR:\r\ncase LLC_CONN_EV_TYPE_BUSY_TMR:\r\nif (llc->retry_count > llc->n2) {\r\nreason = LLC_RESET_REASON_LOCAL;\r\nrc = 0;\r\n}\r\nbreak;\r\n}\r\nif (!rc) {\r\nev->reason = reason;\r\nev->ind_prim = LLC_RESET_PRIM;\r\n}\r\nreturn rc;\r\n}\r\nint llc_conn_ac_rst_confirm(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->reason = 0;\r\nev->cfm_prim = LLC_RESET_PRIM;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_clear_remote_busy_if_f_eq_1(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nif (LLC_PDU_IS_RSP(pdu) &&\r\nLLC_PDU_TYPE_IS_I(pdu) &&\r\nLLC_I_PF_IS_1(pdu) && llc_sk(sk)->ack_pf)\r\nllc_conn_ac_clear_remote_busy(sk, skb);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_rej_tmr_if_data_flag_eq_2(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (llc->data_flag == 2)\r\ndel_timer(&llc->rej_sent_timer.timer);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_send_disc_cmd_p_set_x(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_disc_cmd(nskb, 1);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\nllc_conn_ac_set_p_flag_1(sk, skb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_dm_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nu8 f_bit;\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_dm_rsp(nskb, f_bit);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_dm_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_dm_rsp(nskb, 1);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_frmr_rsp_f_set_x(struct sock *sk, struct sk_buff *skb)\r\n{\r\nu8 f_bit;\r\nint rc = -ENOBUFS;\r\nstruct sk_buff *nskb;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc->rx_pdu_hdr = *((u32 *)pdu);\r\nif (LLC_PDU_IS_CMD(pdu))\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nelse\r\nf_bit = 0;\r\nnskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\r\nsizeof(struct llc_frmr_info));\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_frmr_rsp(nskb, pdu, f_bit, llc->vS,\r\nllc->vR, INCORRECT);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_resend_frmr_rsp_f_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\r\nsizeof(struct llc_frmr_info));\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nstruct llc_pdu_sn *pdu = (struct llc_pdu_sn *)&llc->rx_pdu_hdr;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_frmr_rsp(nskb, pdu, 0, llc->vS,\r\nllc->vR, INCORRECT);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_resend_frmr_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\r\n{\r\nu8 f_bit;\r\nint rc = -ENOBUFS;\r\nstruct sk_buff *nskb;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nnskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U,\r\nsizeof(struct llc_frmr_info));\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_frmr_rsp(nskb, pdu, f_bit, llc->vS,\r\nllc->vR, INCORRECT);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_i_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_i_cmd(skb, 1, llc->vS, llc->vR);\r\nrc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (likely(!rc)) {\r\nllc_conn_send_pdu(sk, skb);\r\nllc_conn_ac_inc_vs_by_1(sk, skb);\r\n}\r\nreturn rc;\r\n}\r\nstatic int llc_conn_ac_send_i_cmd_p_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_i_cmd(skb, 0, llc->vS, llc->vR);\r\nrc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (likely(!rc)) {\r\nllc_conn_send_pdu(sk, skb);\r\nllc_conn_ac_inc_vs_by_1(sk, skb);\r\n}\r\nreturn rc;\r\n}\r\nint llc_conn_ac_send_i_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_i_cmd(skb, 0, llc->vS, llc->vR);\r\nrc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (likely(!rc)) {\r\nllc_conn_send_pdu(sk, skb);\r\nllc_conn_ac_inc_vs_by_1(sk, skb);\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_resend_i_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nu8 nr = LLC_I_GET_NR(pdu);\r\nllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_resend_i_xxx_x_set_0_or_send_rr(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nu8 nr;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (likely(!rc))\r\nllc_conn_send_pdu(sk, nskb);\r\nelse\r\nkfree_skb(skb);\r\n}\r\nif (rc) {\r\nnr = LLC_I_GET_NR(pdu);\r\nrc = 0;\r\nllc_conn_resend_i_pdu_as_cmd(sk, nr, 0);\r\n}\r\nreturn rc;\r\n}\r\nint llc_conn_ac_resend_i_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nu8 nr = LLC_I_GET_NR(pdu);\r\nllc_conn_resend_i_pdu_as_rsp(sk, nr, 1);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_send_rej_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_rej_cmd(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rej_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rej_rsp(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rej_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rej_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rnr_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_rnr_cmd(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rnr_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rnr_rsp(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rnr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rnr_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_set_remote_busy(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (!llc->remote_busy_flag) {\r\nllc->remote_busy_flag = 1;\r\nmod_timer(&llc->busy_state_timer.timer,\r\njiffies + llc->busy_state_timer.expire);\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_opt_send_rnr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rnr_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rr_cmd_p_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_rr_cmd(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rr_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nu8 f_bit = 1;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, f_bit, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_ack_rsp_f_set_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, 1, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_rr_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_ack_xxx_x_set_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, 0, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nvoid llc_conn_set_p_flag(struct sock *sk, u8 value)\r\n{\r\nint state_changed = llc_sk(sk)->p_flag && !value;\r\nllc_sk(sk)->p_flag = value;\r\nif (state_changed)\r\nsk->sk_state_change(sk);\r\n}\r\nint llc_conn_ac_send_sabme_cmd_p_set_x(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nu8 *dmac = llc->daddr.mac;\r\nif (llc->dev->flags & IFF_LOOPBACK)\r\ndmac = llc->dev->dev_addr;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_CMD);\r\nllc_pdu_init_as_sabme_cmd(nskb, 1);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, dmac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\nllc_conn_set_p_flag(sk, 1);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_send_ua_rsp_f_set_p(struct sock *sk, struct sk_buff *skb)\r\n{\r\nu8 f_bit;\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_U, 0);\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nnskb->dev = llc->dev;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_ua_rsp(nskb, f_bit);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nint llc_conn_ac_set_s_flag_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->s_flag = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_s_flag_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->s_flag = 1;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_start_p_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc_conn_set_p_flag(sk, 1);\r\nmod_timer(&llc->pf_cycle_timer.timer,\r\njiffies + llc->pf_cycle_timer.expire);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_send_ack_if_needed(struct sock *sk, struct sk_buff *skb)\r\n{\r\nu8 pf_bit;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc_pdu_decode_pf_bit(skb, &pf_bit);\r\nllc->ack_pf |= pf_bit & 1;\r\nif (!llc->ack_must_be_send) {\r\nllc->first_pdu_Ns = llc->vR;\r\nllc->ack_must_be_send = 1;\r\nllc->ack_pf = pf_bit & 1;\r\n}\r\nif (((llc->vR - llc->first_pdu_Ns + 1 + LLC_2_SEQ_NBR_MODULO)\r\n% LLC_2_SEQ_NBR_MODULO) >= llc->npta) {\r\nllc_conn_ac_send_rr_rsp_f_set_ackpf(sk, skb);\r\nllc->ack_must_be_send = 0;\r\nllc->ack_pf = 0;\r\nllc_conn_ac_inc_npta_value(sk, skb);\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_rst_sendack_flag(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->ack_must_be_send = llc_sk(sk)->ack_pf = 0;\r\nreturn 0;\r\n}\r\nstatic int llc_conn_ac_send_i_rsp_f_set_ackpf(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nint rc;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(skb, LLC_PDU_TYPE_I, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_i_cmd(skb, llc->ack_pf, llc->vS, llc->vR);\r\nrc = llc_mac_hdr_init(skb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (likely(!rc)) {\r\nllc_conn_send_pdu(sk, skb);\r\nllc_conn_ac_inc_vs_by_1(sk, skb);\r\n}\r\nreturn rc;\r\n}\r\nint llc_conn_ac_send_i_as_ack(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (llc->ack_must_be_send) {\r\nllc_conn_ac_send_i_rsp_f_set_ackpf(sk, skb);\r\nllc->ack_must_be_send = 0 ;\r\nllc->ack_pf = 0;\r\n} else\r\nllc_conn_ac_send_i_cmd_p_set_0(sk, skb);\r\nreturn 0;\r\n}\r\nstatic int llc_conn_ac_send_rr_rsp_f_set_ackpf(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nint rc = -ENOBUFS;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sk_buff *nskb = llc_alloc_frame(sk, llc->dev, LLC_PDU_TYPE_S, 0);\r\nif (nskb) {\r\nstruct llc_sap *sap = llc->sap;\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_S, sap->laddr.lsap,\r\nllc->daddr.lsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_rr_rsp(nskb, llc->ack_pf, llc->vR);\r\nrc = llc_mac_hdr_init(nskb, llc->dev->dev_addr, llc->daddr.mac);\r\nif (unlikely(rc))\r\ngoto free;\r\nllc_conn_send_pdu(sk, nskb);\r\n}\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nstatic int llc_conn_ac_inc_npta_value(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (!llc->inc_cntr) {\r\nllc->dec_step = 0;\r\nllc->dec_cntr = llc->inc_cntr = 2;\r\n++llc->npta;\r\nif (llc->npta > (u8) ~LLC_2_SEQ_NBR_MODULO)\r\nllc->npta = (u8) ~LLC_2_SEQ_NBR_MODULO;\r\n} else\r\n--llc->inc_cntr;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_adjust_npta_by_rr(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (!llc->connect_step && !llc->remote_busy_flag) {\r\nif (!llc->dec_step) {\r\nif (!llc->dec_cntr) {\r\nllc->inc_cntr = llc->dec_cntr = 2;\r\nif (llc->npta > 0)\r\nllc->npta = llc->npta - 1;\r\n} else\r\nllc->dec_cntr -=1;\r\n}\r\n} else\r\nllc->connect_step = 0 ;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_adjust_npta_by_rnr(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (llc->remote_busy_flag)\r\nif (!llc->dec_step) {\r\nif (!llc->dec_cntr) {\r\nllc->inc_cntr = llc->dec_cntr = 2;\r\nif (llc->npta > 0)\r\n--llc->npta;\r\n} else\r\n--llc->dec_cntr;\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_dec_tx_win_size(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nu8 unacked_pdu = skb_queue_len(&llc->pdu_unack_q);\r\nif (llc->k - unacked_pdu < 1)\r\nllc->k = 1;\r\nelse\r\nllc->k -= unacked_pdu;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_inc_tx_win_size(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc->k += 1;\r\nif (llc->k > (u8) ~LLC_2_SEQ_NBR_MODULO)\r\nllc->k = (u8) ~LLC_2_SEQ_NBR_MODULO;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_all_timers(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\ndel_timer(&llc->pf_cycle_timer.timer);\r\ndel_timer(&llc->ack_timer.timer);\r\ndel_timer(&llc->rej_sent_timer.timer);\r\ndel_timer(&llc->busy_state_timer.timer);\r\nllc->ack_must_be_send = 0;\r\nllc->ack_pf = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_other_timers(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\ndel_timer(&llc->rej_sent_timer.timer);\r\ndel_timer(&llc->pf_cycle_timer.timer);\r\ndel_timer(&llc->busy_state_timer.timer);\r\nllc->ack_must_be_send = 0;\r\nllc->ack_pf = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_start_ack_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nmod_timer(&llc->ack_timer.timer, jiffies + llc->ack_timer.expire);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_start_rej_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nmod_timer(&llc->rej_sent_timer.timer,\r\njiffies + llc->rej_sent_timer.expire);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_start_ack_tmr_if_not_running(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (!timer_pending(&llc->ack_timer.timer))\r\nmod_timer(&llc->ack_timer.timer,\r\njiffies + llc->ack_timer.expire);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_ack_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\ndel_timer(&llc_sk(sk)->ack_timer.timer);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_p_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_sock *llc = llc_sk(sk);\r\ndel_timer(&llc->pf_cycle_timer.timer);\r\nllc_conn_set_p_flag(sk, 0);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_stop_rej_timer(struct sock *sk, struct sk_buff *skb)\r\n{\r\ndel_timer(&llc_sk(sk)->rej_sent_timer.timer);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_upd_nr_received(struct sock *sk, struct sk_buff *skb)\r\n{\r\nint acked;\r\nu16 unacked = 0;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nstruct llc_sock *llc = llc_sk(sk);\r\nllc->last_nr = PDU_SUPV_GET_Nr(pdu);\r\nacked = llc_conn_remove_acked_pdus(sk, llc->last_nr, &unacked);\r\nif (acked > 0 || (llc->dev->flags & IFF_LOOPBACK)) {\r\nllc->retry_count = 0;\r\ndel_timer(&llc->ack_timer.timer);\r\nif (llc->failed_data_req) {\r\nllc->failed_data_req = 0;\r\nllc_conn_ac_data_confirm(sk, skb);\r\n}\r\nif (unacked)\r\nmod_timer(&llc->ack_timer.timer,\r\njiffies + llc->ack_timer.expire);\r\n} else if (llc->failed_data_req) {\r\nu8 f_bit;\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nif (f_bit == 1) {\r\nllc->failed_data_req = 0;\r\nllc_conn_ac_data_confirm(sk, skb);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_upd_p_flag(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nif (LLC_PDU_IS_RSP(pdu)) {\r\nu8 f_bit;\r\nllc_pdu_decode_pf_bit(skb, &f_bit);\r\nif (f_bit) {\r\nllc_conn_set_p_flag(sk, 0);\r\nllc_conn_ac_stop_p_timer(sk, skb);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_data_flag_2(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->data_flag = 2;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_data_flag_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->data_flag = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_data_flag_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->data_flag = 1;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_data_flag_1_if_data_flag_eq_0(struct sock *sk,\r\nstruct sk_buff *skb)\r\n{\r\nif (!llc_sk(sk)->data_flag)\r\nllc_sk(sk)->data_flag = 1;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_p_flag_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_conn_set_p_flag(sk, 0);\r\nreturn 0;\r\n}\r\nstatic int llc_conn_ac_set_p_flag_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_conn_set_p_flag(sk, 1);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_remote_busy_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->remote_busy_flag = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_cause_flag_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->cause_flag = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_cause_flag_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->cause_flag = 1;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_retry_cnt_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->retry_count = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_inc_retry_cnt_by_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->retry_count++;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_vr_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->vR = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_inc_vr_by_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->vR = PDU_GET_NEXT_Vr(llc_sk(sk)->vR);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_vs_0(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->vS = 0;\r\nreturn 0;\r\n}\r\nint llc_conn_ac_set_vs_nr(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->vS = llc_sk(sk)->last_nr;\r\nreturn 0;\r\n}\r\nstatic int llc_conn_ac_inc_vs_by_1(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->vS = (llc_sk(sk)->vS + 1) % LLC_2_SEQ_NBR_MODULO;\r\nreturn 0;\r\n}\r\nstatic void llc_conn_tmr_common_cb(unsigned long timeout_data, u8 type)\r\n{\r\nstruct sock *sk = (struct sock *)timeout_data;\r\nstruct sk_buff *skb = alloc_skb(0, GFP_ATOMIC);\r\nbh_lock_sock(sk);\r\nif (skb) {\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nskb_set_owner_r(skb, sk);\r\nev->type = type;\r\nllc_process_tmr_ev(sk, skb);\r\n}\r\nbh_unlock_sock(sk);\r\n}\r\nvoid llc_conn_pf_cycle_tmr_cb(unsigned long timeout_data)\r\n{\r\nllc_conn_tmr_common_cb(timeout_data, LLC_CONN_EV_TYPE_P_TMR);\r\n}\r\nvoid llc_conn_busy_tmr_cb(unsigned long timeout_data)\r\n{\r\nllc_conn_tmr_common_cb(timeout_data, LLC_CONN_EV_TYPE_BUSY_TMR);\r\n}\r\nvoid llc_conn_ack_tmr_cb(unsigned long timeout_data)\r\n{\r\nllc_conn_tmr_common_cb(timeout_data, LLC_CONN_EV_TYPE_ACK_TMR);\r\n}\r\nvoid llc_conn_rej_tmr_cb(unsigned long timeout_data)\r\n{\r\nllc_conn_tmr_common_cb(timeout_data, LLC_CONN_EV_TYPE_REJ_TMR);\r\n}\r\nint llc_conn_ac_rst_vs(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk(sk)->X = llc_sk(sk)->vS;\r\nllc_conn_ac_set_vs_nr(sk, skb);\r\nreturn 0;\r\n}\r\nint llc_conn_ac_upd_vs(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nu8 nr = PDU_SUPV_GET_Nr(pdu);\r\nif (llc_circular_between(llc_sk(sk)->vS, nr, llc_sk(sk)->X))\r\nllc_conn_ac_set_vs_nr(sk, skb);\r\nreturn 0;\r\n}\r\nint llc_conn_disc(struct sock *sk, struct sk_buff *skb)\r\n{\r\nreturn 0;\r\n}\r\nint llc_conn_reset(struct sock *sk, struct sk_buff *skb)\r\n{\r\nllc_sk_reset(sk);\r\nreturn 0;\r\n}\r\nu8 llc_circular_between(u8 a, u8 b, u8 c)\r\n{\r\nb = b - a;\r\nc = c - a;\r\nreturn b <= c;\r\n}\r\nstatic void llc_process_tmr_ev(struct sock *sk, struct sk_buff *skb)\r\n{\r\nif (llc_sk(sk)->state == LLC_CONN_OUT_OF_SVC) {\r\nprintk(KERN_WARNING "%s: timer called on closed connection\n",\r\n__func__);\r\nkfree_skb(skb);\r\n} else {\r\nif (!sock_owned_by_user(sk))\r\nllc_conn_state_process(sk, skb);\r\nelse {\r\nllc_set_backlog_type(skb, LLC_EVENT);\r\n__sk_add_backlog(sk, skb);\r\n}\r\n}\r\n}

void i915_syncmap_init(struct i915_syncmap **root)\r\n{\r\nBUILD_BUG_ON_NOT_POWER_OF_2(KSYNCMAP);\r\nBUILD_BUG_ON_NOT_POWER_OF_2(SHIFT);\r\nBUILD_BUG_ON(KSYNCMAP > BITS_PER_BYTE * sizeof((*root)->bitmap));\r\n*root = NULL;\r\n}\r\nstatic inline u32 *__sync_seqno(struct i915_syncmap *p)\r\n{\r\nGEM_BUG_ON(p->height);\r\nreturn (u32 *)(p + 1);\r\n}\r\nstatic inline struct i915_syncmap **__sync_child(struct i915_syncmap *p)\r\n{\r\nGEM_BUG_ON(!p->height);\r\nreturn (struct i915_syncmap **)(p + 1);\r\n}\r\nstatic inline unsigned int\r\n__sync_branch_idx(const struct i915_syncmap *p, u64 id)\r\n{\r\nreturn (id >> p->height) & MASK;\r\n}\r\nstatic inline unsigned int\r\n__sync_leaf_idx(const struct i915_syncmap *p, u64 id)\r\n{\r\nGEM_BUG_ON(p->height);\r\nreturn id & MASK;\r\n}\r\nstatic inline u64 __sync_branch_prefix(const struct i915_syncmap *p, u64 id)\r\n{\r\nreturn id >> p->height >> SHIFT;\r\n}\r\nstatic inline u64 __sync_leaf_prefix(const struct i915_syncmap *p, u64 id)\r\n{\r\nGEM_BUG_ON(p->height);\r\nreturn id >> SHIFT;\r\n}\r\nstatic inline bool seqno_later(u32 a, u32 b)\r\n{\r\nreturn (s32)(a - b) >= 0;\r\n}\r\nbool i915_syncmap_is_later(struct i915_syncmap **root, u64 id, u32 seqno)\r\n{\r\nstruct i915_syncmap *p;\r\nunsigned int idx;\r\np = *root;\r\nif (!p)\r\nreturn false;\r\nif (likely(__sync_leaf_prefix(p, id) == p->prefix))\r\ngoto found;\r\ndo {\r\np = p->parent;\r\nif (!p)\r\nreturn false;\r\nif (__sync_branch_prefix(p, id) == p->prefix)\r\nbreak;\r\n} while (1);\r\ndo {\r\nif (!p->height)\r\nbreak;\r\np = __sync_child(p)[__sync_branch_idx(p, id)];\r\nif (!p)\r\nreturn false;\r\nif (__sync_branch_prefix(p, id) != p->prefix)\r\nreturn false;\r\n} while (1);\r\n*root = p;\r\nfound:\r\nidx = __sync_leaf_idx(p, id);\r\nif (!(p->bitmap & BIT(idx)))\r\nreturn false;\r\nreturn seqno_later(__sync_seqno(p)[idx], seqno);\r\n}\r\nstatic struct i915_syncmap *\r\n__sync_alloc_leaf(struct i915_syncmap *parent, u64 id)\r\n{\r\nstruct i915_syncmap *p;\r\np = kmalloc(sizeof(*p) + KSYNCMAP * sizeof(u32), GFP_KERNEL);\r\nif (unlikely(!p))\r\nreturn NULL;\r\np->parent = parent;\r\np->height = 0;\r\np->bitmap = 0;\r\np->prefix = __sync_leaf_prefix(p, id);\r\nreturn p;\r\n}\r\nstatic inline void __sync_set_seqno(struct i915_syncmap *p, u64 id, u32 seqno)\r\n{\r\nunsigned int idx = __sync_leaf_idx(p, id);\r\np->bitmap |= BIT(idx);\r\n__sync_seqno(p)[idx] = seqno;\r\n}\r\nstatic inline void __sync_set_child(struct i915_syncmap *p,\r\nunsigned int idx,\r\nstruct i915_syncmap *child)\r\n{\r\np->bitmap |= BIT(idx);\r\n__sync_child(p)[idx] = child;\r\n}\r\nstatic noinline int __sync_set(struct i915_syncmap **root, u64 id, u32 seqno)\r\n{\r\nstruct i915_syncmap *p = *root;\r\nunsigned int idx;\r\nif (!p) {\r\np = __sync_alloc_leaf(NULL, id);\r\nif (unlikely(!p))\r\nreturn -ENOMEM;\r\ngoto found;\r\n}\r\nGEM_BUG_ON(__sync_leaf_prefix(p, id) == p->prefix);\r\ndo {\r\nif (!p->parent)\r\nbreak;\r\np = p->parent;\r\nif (__sync_branch_prefix(p, id) == p->prefix)\r\nbreak;\r\n} while (1);\r\ndo {\r\nstruct i915_syncmap *next;\r\nif (__sync_branch_prefix(p, id) != p->prefix) {\r\nunsigned int above;\r\nnext = kzalloc(sizeof(*next) + KSYNCMAP * sizeof(next),\r\nGFP_KERNEL);\r\nif (unlikely(!next))\r\nreturn -ENOMEM;\r\nabove = fls64(__sync_branch_prefix(p, id) ^ p->prefix);\r\nabove = round_up(above, SHIFT);\r\nnext->height = above + p->height;\r\nnext->prefix = __sync_branch_prefix(next, id);\r\nif (p->parent) {\r\nidx = __sync_branch_idx(p->parent, id);\r\n__sync_child(p->parent)[idx] = next;\r\nGEM_BUG_ON(!(p->parent->bitmap & BIT(idx)));\r\n}\r\nnext->parent = p->parent;\r\nidx = p->prefix >> (above - SHIFT) & MASK;\r\n__sync_set_child(next, idx, p);\r\np->parent = next;\r\np = next;\r\n} else {\r\nif (!p->height)\r\nbreak;\r\n}\r\nGEM_BUG_ON(!p->height);\r\nidx = __sync_branch_idx(p, id);\r\nnext = __sync_child(p)[idx];\r\nif (!next) {\r\nnext = __sync_alloc_leaf(p, id);\r\nif (unlikely(!next))\r\nreturn -ENOMEM;\r\n__sync_set_child(p, idx, next);\r\np = next;\r\nbreak;\r\n}\r\np = next;\r\n} while (1);\r\nfound:\r\nGEM_BUG_ON(p->prefix != __sync_leaf_prefix(p, id));\r\n__sync_set_seqno(p, id, seqno);\r\n*root = p;\r\nreturn 0;\r\n}\r\nint i915_syncmap_set(struct i915_syncmap **root, u64 id, u32 seqno)\r\n{\r\nstruct i915_syncmap *p = *root;\r\nif (likely(p && __sync_leaf_prefix(p, id) == p->prefix)) {\r\n__sync_set_seqno(p, id, seqno);\r\nreturn 0;\r\n}\r\nreturn __sync_set(root, id, seqno);\r\n}\r\nstatic void __sync_free(struct i915_syncmap *p)\r\n{\r\nif (p->height) {\r\nunsigned int i;\r\nwhile ((i = ffs(p->bitmap))) {\r\np->bitmap &= ~0u << i;\r\n__sync_free(__sync_child(p)[i - 1]);\r\n}\r\n}\r\nkfree(p);\r\n}\r\nvoid i915_syncmap_free(struct i915_syncmap **root)\r\n{\r\nstruct i915_syncmap *p;\r\np = *root;\r\nif (!p)\r\nreturn;\r\nwhile (p->parent)\r\np = p->parent;\r\n__sync_free(p);\r\n*root = NULL;\r\n}

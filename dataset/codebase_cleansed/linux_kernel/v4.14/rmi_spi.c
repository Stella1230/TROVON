static int rmi_spi_manage_pools(struct rmi_spi_xport *rmi_spi, int len)\r\n{\r\nstruct spi_device *spi = rmi_spi->spi;\r\nint buf_size = rmi_spi->xfer_buf_size\r\n? rmi_spi->xfer_buf_size : RMI_SPI_DEFAULT_XFER_BUF_SIZE;\r\nstruct spi_transfer *xfer_buf;\r\nvoid *buf;\r\nvoid *tmp;\r\nwhile (buf_size < len)\r\nbuf_size *= 2;\r\nif (buf_size > RMI_SPI_XFER_SIZE_LIMIT)\r\nbuf_size = RMI_SPI_XFER_SIZE_LIMIT;\r\ntmp = rmi_spi->rx_buf;\r\nbuf = devm_kzalloc(&spi->dev, buf_size * 2,\r\nGFP_KERNEL | GFP_DMA);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nrmi_spi->rx_buf = buf;\r\nrmi_spi->tx_buf = &rmi_spi->rx_buf[buf_size];\r\nrmi_spi->xfer_buf_size = buf_size;\r\nif (tmp)\r\ndevm_kfree(&spi->dev, tmp);\r\nif (rmi_spi->xport.pdata.spi_data.read_delay_us)\r\nrmi_spi->rx_xfer_count = buf_size;\r\nelse\r\nrmi_spi->rx_xfer_count = 1;\r\nif (rmi_spi->xport.pdata.spi_data.write_delay_us)\r\nrmi_spi->tx_xfer_count = buf_size;\r\nelse\r\nrmi_spi->tx_xfer_count = 1;\r\ntmp = rmi_spi->rx_xfers;\r\nxfer_buf = devm_kzalloc(&spi->dev,\r\n(rmi_spi->rx_xfer_count + rmi_spi->tx_xfer_count)\r\n* sizeof(struct spi_transfer), GFP_KERNEL);\r\nif (!xfer_buf)\r\nreturn -ENOMEM;\r\nrmi_spi->rx_xfers = xfer_buf;\r\nrmi_spi->tx_xfers = &xfer_buf[rmi_spi->rx_xfer_count];\r\nif (tmp)\r\ndevm_kfree(&spi->dev, tmp);\r\nreturn 0;\r\n}\r\nstatic int rmi_spi_xfer(struct rmi_spi_xport *rmi_spi,\r\nconst struct rmi_spi_cmd *cmd, const u8 *tx_buf,\r\nint tx_len, u8 *rx_buf, int rx_len)\r\n{\r\nstruct spi_device *spi = rmi_spi->spi;\r\nstruct rmi_device_platform_data_spi *spi_data =\r\n&rmi_spi->xport.pdata.spi_data;\r\nstruct spi_message msg;\r\nstruct spi_transfer *xfer;\r\nint ret = 0;\r\nint len;\r\nint cmd_len = 0;\r\nint total_tx_len;\r\nint i;\r\nu16 addr = cmd->addr;\r\nspi_message_init(&msg);\r\nswitch (cmd->op) {\r\ncase RMI_SPI_WRITE:\r\ncase RMI_SPI_READ:\r\ncmd_len += 2;\r\nbreak;\r\ncase RMI_SPI_V2_READ_UNIFIED:\r\ncase RMI_SPI_V2_READ_SPLIT:\r\ncase RMI_SPI_V2_WRITE:\r\ncmd_len += 4;\r\nbreak;\r\n}\r\ntotal_tx_len = cmd_len + tx_len;\r\nlen = max(total_tx_len, rx_len);\r\nif (len > RMI_SPI_XFER_SIZE_LIMIT)\r\nreturn -EINVAL;\r\nif (rmi_spi->xfer_buf_size < len)\r\nrmi_spi_manage_pools(rmi_spi, len);\r\nif (addr == 0)\r\naddr = 0x7FF;\r\nswitch (cmd->op) {\r\ncase RMI_SPI_WRITE:\r\nrmi_spi->tx_buf[0] = (addr >> 8);\r\nrmi_spi->tx_buf[1] = addr & 0xFF;\r\nbreak;\r\ncase RMI_SPI_READ:\r\nrmi_spi->tx_buf[0] = (addr >> 8) | 0x80;\r\nrmi_spi->tx_buf[1] = addr & 0xFF;\r\nbreak;\r\ncase RMI_SPI_V2_READ_UNIFIED:\r\nbreak;\r\ncase RMI_SPI_V2_READ_SPLIT:\r\nbreak;\r\ncase RMI_SPI_V2_WRITE:\r\nrmi_spi->tx_buf[0] = 0x40;\r\nrmi_spi->tx_buf[1] = (addr >> 8) & 0xFF;\r\nrmi_spi->tx_buf[2] = addr & 0xFF;\r\nrmi_spi->tx_buf[3] = tx_len;\r\nbreak;\r\n}\r\nif (tx_buf)\r\nmemcpy(&rmi_spi->tx_buf[cmd_len], tx_buf, tx_len);\r\nif (rmi_spi->tx_xfer_count > 1) {\r\nfor (i = 0; i < total_tx_len; i++) {\r\nxfer = &rmi_spi->tx_xfers[i];\r\nmemset(xfer, 0, sizeof(struct spi_transfer));\r\nxfer->tx_buf = &rmi_spi->tx_buf[i];\r\nxfer->len = 1;\r\nxfer->delay_usecs = spi_data->write_delay_us;\r\nspi_message_add_tail(xfer, &msg);\r\n}\r\n} else {\r\nxfer = rmi_spi->tx_xfers;\r\nmemset(xfer, 0, sizeof(struct spi_transfer));\r\nxfer->tx_buf = rmi_spi->tx_buf;\r\nxfer->len = total_tx_len;\r\nspi_message_add_tail(xfer, &msg);\r\n}\r\nrmi_dbg(RMI_DEBUG_XPORT, &spi->dev, "%s: cmd: %s tx_buf len: %d tx_buf: %*ph\n",\r\n__func__, cmd->op == RMI_SPI_WRITE ? "WRITE" : "READ",\r\ntotal_tx_len, total_tx_len, rmi_spi->tx_buf);\r\nif (rx_buf) {\r\nif (rmi_spi->rx_xfer_count > 1) {\r\nfor (i = 0; i < rx_len; i++) {\r\nxfer = &rmi_spi->rx_xfers[i];\r\nmemset(xfer, 0, sizeof(struct spi_transfer));\r\nxfer->rx_buf = &rmi_spi->rx_buf[i];\r\nxfer->len = 1;\r\nxfer->delay_usecs = spi_data->read_delay_us;\r\nspi_message_add_tail(xfer, &msg);\r\n}\r\n} else {\r\nxfer = rmi_spi->rx_xfers;\r\nmemset(xfer, 0, sizeof(struct spi_transfer));\r\nxfer->rx_buf = rmi_spi->rx_buf;\r\nxfer->len = rx_len;\r\nspi_message_add_tail(xfer, &msg);\r\n}\r\n}\r\nret = spi_sync(spi, &msg);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "spi xfer failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (rx_buf) {\r\nmemcpy(rx_buf, rmi_spi->rx_buf, rx_len);\r\nrmi_dbg(RMI_DEBUG_XPORT, &spi->dev, "%s: (%d) %*ph\n",\r\n__func__, rx_len, rx_len, rx_buf);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rmi_set_page(struct rmi_spi_xport *rmi_spi, u8 page)\r\n{\r\nstruct rmi_spi_cmd cmd;\r\nint ret;\r\ncmd.op = RMI_SPI_WRITE;\r\ncmd.addr = RMI_PAGE_SELECT_REGISTER;\r\nret = rmi_spi_xfer(rmi_spi, &cmd, &page, 1, NULL, 0);\r\nif (ret)\r\nrmi_spi->page = page;\r\nreturn ret;\r\n}\r\nstatic int rmi_spi_write_block(struct rmi_transport_dev *xport, u16 addr,\r\nconst void *buf, size_t len)\r\n{\r\nstruct rmi_spi_xport *rmi_spi =\r\ncontainer_of(xport, struct rmi_spi_xport, xport);\r\nstruct rmi_spi_cmd cmd;\r\nint ret;\r\nmutex_lock(&rmi_spi->page_mutex);\r\nif (RMI_SPI_PAGE(addr) != rmi_spi->page) {\r\nret = rmi_set_page(rmi_spi, RMI_SPI_PAGE(addr));\r\nif (ret)\r\ngoto exit;\r\n}\r\ncmd.op = RMI_SPI_WRITE;\r\ncmd.addr = addr;\r\nret = rmi_spi_xfer(rmi_spi, &cmd, buf, len, NULL, 0);\r\nexit:\r\nmutex_unlock(&rmi_spi->page_mutex);\r\nreturn ret;\r\n}\r\nstatic int rmi_spi_read_block(struct rmi_transport_dev *xport, u16 addr,\r\nvoid *buf, size_t len)\r\n{\r\nstruct rmi_spi_xport *rmi_spi =\r\ncontainer_of(xport, struct rmi_spi_xport, xport);\r\nstruct rmi_spi_cmd cmd;\r\nint ret;\r\nmutex_lock(&rmi_spi->page_mutex);\r\nif (RMI_SPI_PAGE(addr) != rmi_spi->page) {\r\nret = rmi_set_page(rmi_spi, RMI_SPI_PAGE(addr));\r\nif (ret)\r\ngoto exit;\r\n}\r\ncmd.op = RMI_SPI_READ;\r\ncmd.addr = addr;\r\nret = rmi_spi_xfer(rmi_spi, &cmd, NULL, 0, buf, len);\r\nexit:\r\nmutex_unlock(&rmi_spi->page_mutex);\r\nreturn ret;\r\n}\r\nstatic int rmi_spi_of_probe(struct spi_device *spi,\r\nstruct rmi_device_platform_data *pdata)\r\n{\r\nstruct device *dev = &spi->dev;\r\nint retval;\r\nretval = rmi_of_property_read_u32(dev,\r\n&pdata->spi_data.read_delay_us,\r\n"spi-rx-delay-us", 1);\r\nif (retval)\r\nreturn retval;\r\nretval = rmi_of_property_read_u32(dev,\r\n&pdata->spi_data.write_delay_us,\r\n"spi-tx-delay-us", 1);\r\nif (retval)\r\nreturn retval;\r\nreturn 0;\r\n}\r\nstatic inline int rmi_spi_of_probe(struct spi_device *spi,\r\nstruct rmi_device_platform_data *pdata)\r\n{\r\nreturn -ENODEV;\r\n}\r\nstatic void rmi_spi_unregister_transport(void *data)\r\n{\r\nstruct rmi_spi_xport *rmi_spi = data;\r\nrmi_unregister_transport_device(&rmi_spi->xport);\r\n}\r\nstatic int rmi_spi_probe(struct spi_device *spi)\r\n{\r\nstruct rmi_spi_xport *rmi_spi;\r\nstruct rmi_device_platform_data *pdata;\r\nstruct rmi_device_platform_data *spi_pdata = spi->dev.platform_data;\r\nint error;\r\nif (spi->master->flags & SPI_MASTER_HALF_DUPLEX)\r\nreturn -EINVAL;\r\nrmi_spi = devm_kzalloc(&spi->dev, sizeof(struct rmi_spi_xport),\r\nGFP_KERNEL);\r\nif (!rmi_spi)\r\nreturn -ENOMEM;\r\npdata = &rmi_spi->xport.pdata;\r\nif (spi->dev.of_node) {\r\nerror = rmi_spi_of_probe(spi, pdata);\r\nif (error)\r\nreturn error;\r\n} else if (spi_pdata) {\r\n*pdata = *spi_pdata;\r\n}\r\nif (pdata->spi_data.bits_per_word)\r\nspi->bits_per_word = pdata->spi_data.bits_per_word;\r\nif (pdata->spi_data.mode)\r\nspi->mode = pdata->spi_data.mode;\r\nerror = spi_setup(spi);\r\nif (error < 0) {\r\ndev_err(&spi->dev, "spi_setup failed!\n");\r\nreturn error;\r\n}\r\npdata->irq = spi->irq;\r\nrmi_spi->spi = spi;\r\nmutex_init(&rmi_spi->page_mutex);\r\nrmi_spi->xport.dev = &spi->dev;\r\nrmi_spi->xport.proto_name = "spi";\r\nrmi_spi->xport.ops = &rmi_spi_ops;\r\nspi_set_drvdata(spi, rmi_spi);\r\nerror = rmi_spi_manage_pools(rmi_spi, RMI_SPI_DEFAULT_XFER_BUF_SIZE);\r\nif (error)\r\nreturn error;\r\nerror = rmi_set_page(rmi_spi, 0);\r\nif (error) {\r\ndev_err(&spi->dev, "Failed to set page select to 0.\n");\r\nreturn error;\r\n}\r\ndev_info(&spi->dev, "registering SPI-connected sensor\n");\r\nerror = rmi_register_transport_device(&rmi_spi->xport);\r\nif (error) {\r\ndev_err(&spi->dev, "failed to register sensor: %d\n", error);\r\nreturn error;\r\n}\r\nerror = devm_add_action_or_reset(&spi->dev,\r\nrmi_spi_unregister_transport,\r\nrmi_spi);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}\r\nstatic int rmi_spi_suspend(struct device *dev)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rmi_spi_xport *rmi_spi = spi_get_drvdata(spi);\r\nint ret;\r\nret = rmi_driver_suspend(rmi_spi->xport.rmi_dev, true);\r\nif (ret)\r\ndev_warn(dev, "Failed to resume device: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int rmi_spi_resume(struct device *dev)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rmi_spi_xport *rmi_spi = spi_get_drvdata(spi);\r\nint ret;\r\nret = rmi_driver_resume(rmi_spi->xport.rmi_dev, true);\r\nif (ret)\r\ndev_warn(dev, "Failed to resume device: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int rmi_spi_runtime_suspend(struct device *dev)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rmi_spi_xport *rmi_spi = spi_get_drvdata(spi);\r\nint ret;\r\nret = rmi_driver_suspend(rmi_spi->xport.rmi_dev, false);\r\nif (ret)\r\ndev_warn(dev, "Failed to resume device: %d\n", ret);\r\nreturn 0;\r\n}\r\nstatic int rmi_spi_runtime_resume(struct device *dev)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rmi_spi_xport *rmi_spi = spi_get_drvdata(spi);\r\nint ret;\r\nret = rmi_driver_resume(rmi_spi->xport.rmi_dev, false);\r\nif (ret)\r\ndev_warn(dev, "Failed to resume device: %d\n", ret);\r\nreturn 0;\r\n}

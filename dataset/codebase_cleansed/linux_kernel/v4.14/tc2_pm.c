static int tc2_pm_cpu_powerup(unsigned int cpu, unsigned int cluster)\r\n{\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nif (cluster >= TC2_CLUSTERS || cpu >= tc2_nr_cpus[cluster])\r\nreturn -EINVAL;\r\nve_spc_set_resume_addr(cluster, cpu,\r\n__pa_symbol(mcpm_entry_point));\r\nve_spc_cpu_wakeup_irq(cluster, cpu, true);\r\nreturn 0;\r\n}\r\nstatic int tc2_pm_cluster_powerup(unsigned int cluster)\r\n{\r\npr_debug("%s: cluster %u\n", __func__, cluster);\r\nif (cluster >= TC2_CLUSTERS)\r\nreturn -EINVAL;\r\nve_spc_powerdown(cluster, false);\r\nreturn 0;\r\n}\r\nstatic void tc2_pm_cpu_powerdown_prepare(unsigned int cpu, unsigned int cluster)\r\n{\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nBUG_ON(cluster >= TC2_CLUSTERS || cpu >= TC2_MAX_CPUS_PER_CLUSTER);\r\nve_spc_cpu_wakeup_irq(cluster, cpu, true);\r\ngic_cpu_if_down(0);\r\n}\r\nstatic void tc2_pm_cluster_powerdown_prepare(unsigned int cluster)\r\n{\r\npr_debug("%s: cluster %u\n", __func__, cluster);\r\nBUG_ON(cluster >= TC2_CLUSTERS);\r\nve_spc_powerdown(cluster, true);\r\nve_spc_global_wakeup_irq(true);\r\n}\r\nstatic void tc2_pm_cpu_cache_disable(void)\r\n{\r\nv7_exit_coherency_flush(louis);\r\n}\r\nstatic void tc2_pm_cluster_cache_disable(void)\r\n{\r\nif (read_cpuid_part() == ARM_CPU_PART_CORTEX_A15) {\r\nasm volatile(\r\n"mcr p15, 1, %0, c15, c0, 3 \n\t"\r\n"isb \n\t"\r\n"dsb "\r\n: : "r" (0x400) );\r\n}\r\nv7_exit_coherency_flush(all);\r\ncci_disable_port_by_cpu(read_cpuid_mpidr());\r\n}\r\nstatic int tc2_core_in_reset(unsigned int cpu, unsigned int cluster)\r\n{\r\nu32 mask = cluster ?\r\nRESET_A7_NCORERESET(cpu)\r\n: RESET_A15_NCORERESET(cpu);\r\nreturn !(readl_relaxed(scc + RESET_CTRL) & mask);\r\n}\r\nstatic int tc2_pm_wait_for_powerdown(unsigned int cpu, unsigned int cluster)\r\n{\r\nunsigned tries;\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nBUG_ON(cluster >= TC2_CLUSTERS || cpu >= TC2_MAX_CPUS_PER_CLUSTER);\r\nfor (tries = 0; tries < TIMEOUT_MSEC / POLL_MSEC; ++tries) {\r\npr_debug("%s(cpu=%u, cluster=%u): RESET_CTRL = 0x%08X\n",\r\n__func__, cpu, cluster,\r\nreadl_relaxed(scc + RESET_CTRL));\r\nif (tc2_core_in_reset(cpu, cluster) ||\r\nve_spc_cpu_in_wfi(cpu, cluster))\r\nreturn 0;\r\nmsleep(POLL_MSEC);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void tc2_pm_cpu_suspend_prepare(unsigned int cpu, unsigned int cluster)\r\n{\r\nve_spc_set_resume_addr(cluster, cpu, __pa_symbol(mcpm_entry_point));\r\n}\r\nstatic void tc2_pm_cpu_is_up(unsigned int cpu, unsigned int cluster)\r\n{\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nBUG_ON(cluster >= TC2_CLUSTERS || cpu >= TC2_MAX_CPUS_PER_CLUSTER);\r\nve_spc_cpu_wakeup_irq(cluster, cpu, false);\r\nve_spc_set_resume_addr(cluster, cpu, 0);\r\n}\r\nstatic void tc2_pm_cluster_is_up(unsigned int cluster)\r\n{\r\npr_debug("%s: cluster %u\n", __func__, cluster);\r\nBUG_ON(cluster >= TC2_CLUSTERS);\r\nve_spc_powerdown(cluster, false);\r\nve_spc_global_wakeup_irq(false);\r\n}\r\nstatic void __naked tc2_pm_power_up_setup(unsigned int affinity_level)\r\n{\r\nasm volatile (" \n"\r\n" cmp r0, #1 \n"\r\n" bxne lr \n"\r\n" b cci_enable_port_for_self ");\r\n}\r\nstatic int __init tc2_pm_init(void)\r\n{\r\nunsigned int mpidr, cpu, cluster;\r\nint ret, irq;\r\nu32 a15_cluster_id, a7_cluster_id, sys_info;\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"arm,vexpress-scc,v2p-ca15_a7");\r\nscc = of_iomap(np, 0);\r\nif (!scc)\r\nreturn -ENODEV;\r\na15_cluster_id = readl_relaxed(scc + A15_CONF) & 0xf;\r\na7_cluster_id = readl_relaxed(scc + A7_CONF) & 0xf;\r\nif (a15_cluster_id >= TC2_CLUSTERS || a7_cluster_id >= TC2_CLUSTERS)\r\nreturn -EINVAL;\r\nsys_info = readl_relaxed(scc + SYS_INFO);\r\ntc2_nr_cpus[a15_cluster_id] = (sys_info >> 16) & 0xf;\r\ntc2_nr_cpus[a7_cluster_id] = (sys_info >> 20) & 0xf;\r\nirq = irq_of_parse_and_map(np, 0);\r\nret = ve_spc_init(scc + SPC_BASE, a15_cluster_id, irq);\r\nif (ret)\r\nreturn ret;\r\nif (!cci_probed())\r\nreturn -ENODEV;\r\nmpidr = read_cpuid_mpidr();\r\ncpu = MPIDR_AFFINITY_LEVEL(mpidr, 0);\r\ncluster = MPIDR_AFFINITY_LEVEL(mpidr, 1);\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nif (cluster >= TC2_CLUSTERS || cpu >= tc2_nr_cpus[cluster]) {\r\npr_err("%s: boot CPU is out of bound!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nret = mcpm_platform_register(&tc2_pm_power_ops);\r\nif (!ret) {\r\nmcpm_sync_init(tc2_pm_power_up_setup);\r\nBUG_ON(mcpm_loopback(tc2_pm_cluster_cache_disable) != 0);\r\npr_info("TC2 power management initialized\n");\r\n}\r\nreturn ret;\r\n}

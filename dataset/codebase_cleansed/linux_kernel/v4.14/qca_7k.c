void\r\nqcaspi_spi_error(struct qcaspi *qca)\r\n{\r\nif (qca->sync != QCASPI_SYNC_READY)\r\nreturn;\r\nnetdev_err(qca->net_dev, "spi error\n");\r\nqca->sync = QCASPI_SYNC_UNKNOWN;\r\nqca->stats.spi_err++;\r\n}\r\nint\r\nqcaspi_read_register(struct qcaspi *qca, u16 reg, u16 *result)\r\n{\r\n__be16 rx_data;\r\n__be16 tx_data;\r\nstruct spi_transfer *transfer;\r\nstruct spi_message *msg;\r\nint ret;\r\ntx_data = cpu_to_be16(QCA7K_SPI_READ | QCA7K_SPI_INTERNAL | reg);\r\nif (qca->legacy_mode) {\r\nmsg = &qca->spi_msg1;\r\ntransfer = &qca->spi_xfer1;\r\ntransfer->tx_buf = &tx_data;\r\ntransfer->rx_buf = NULL;\r\ntransfer->len = QCASPI_CMD_LEN;\r\nspi_sync(qca->spi_dev, msg);\r\n} else {\r\nmsg = &qca->spi_msg2;\r\ntransfer = &qca->spi_xfer2[0];\r\ntransfer->tx_buf = &tx_data;\r\ntransfer->rx_buf = NULL;\r\ntransfer->len = QCASPI_CMD_LEN;\r\ntransfer = &qca->spi_xfer2[1];\r\n}\r\ntransfer->tx_buf = NULL;\r\ntransfer->rx_buf = &rx_data;\r\ntransfer->len = QCASPI_CMD_LEN;\r\nret = spi_sync(qca->spi_dev, msg);\r\nif (!ret)\r\nret = msg->status;\r\nif (ret)\r\nqcaspi_spi_error(qca);\r\nelse\r\n*result = be16_to_cpu(rx_data);\r\nreturn ret;\r\n}\r\nint\r\nqcaspi_write_register(struct qcaspi *qca, u16 reg, u16 value)\r\n{\r\n__be16 tx_data[2];\r\nstruct spi_transfer *transfer;\r\nstruct spi_message *msg;\r\nint ret;\r\ntx_data[0] = cpu_to_be16(QCA7K_SPI_WRITE | QCA7K_SPI_INTERNAL | reg);\r\ntx_data[1] = cpu_to_be16(value);\r\nif (qca->legacy_mode) {\r\nmsg = &qca->spi_msg1;\r\ntransfer = &qca->spi_xfer1;\r\ntransfer->tx_buf = &tx_data[0];\r\ntransfer->rx_buf = NULL;\r\ntransfer->len = QCASPI_CMD_LEN;\r\nspi_sync(qca->spi_dev, msg);\r\n} else {\r\nmsg = &qca->spi_msg2;\r\ntransfer = &qca->spi_xfer2[0];\r\ntransfer->tx_buf = &tx_data[0];\r\ntransfer->rx_buf = NULL;\r\ntransfer->len = QCASPI_CMD_LEN;\r\ntransfer = &qca->spi_xfer2[1];\r\n}\r\ntransfer->tx_buf = &tx_data[1];\r\ntransfer->rx_buf = NULL;\r\ntransfer->len = QCASPI_CMD_LEN;\r\nret = spi_sync(qca->spi_dev, msg);\r\nif (!ret)\r\nret = msg->status;\r\nif (ret)\r\nqcaspi_spi_error(qca);\r\nreturn ret;\r\n}

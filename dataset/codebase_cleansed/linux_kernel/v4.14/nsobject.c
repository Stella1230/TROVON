acpi_status\r\nacpi_ns_attach_object(struct acpi_namespace_node *node,\r\nunion acpi_operand_object *object, acpi_object_type type)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *last_obj_desc;\r\nacpi_object_type object_type = ACPI_TYPE_ANY;\r\nACPI_FUNCTION_TRACE(ns_attach_object);\r\nif (!node) {\r\nACPI_ERROR((AE_INFO, "Null NamedObj handle"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (!object && (ACPI_TYPE_ANY != type)) {\r\nACPI_ERROR((AE_INFO,\r\n"Null object, but type not ACPI_TYPE_ANY"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(node) != ACPI_DESC_TYPE_NAMED) {\r\nACPI_ERROR((AE_INFO, "Invalid handle %p [%s]",\r\nnode, acpi_ut_get_descriptor_name(node)));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (node->object == object) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Obj %p already installed in NameObj %p\n",\r\nobject, node));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (!object) {\r\nobj_desc = NULL;\r\nobject_type = ACPI_TYPE_ANY;\r\n}\r\nelse if ((ACPI_GET_DESCRIPTOR_TYPE(object) == ACPI_DESC_TYPE_NAMED) &&\r\n((struct acpi_namespace_node *)object)->object) {\r\nobj_desc = ((struct acpi_namespace_node *)object)->object;\r\nobject_type = ((struct acpi_namespace_node *)object)->type;\r\n}\r\nelse {\r\nobj_desc = (union acpi_operand_object *)object;\r\nobject_type = type;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Installing %p into Node %p [%4.4s]\n",\r\nobj_desc, node, acpi_ut_get_node_name(node)));\r\nif (node->object) {\r\nacpi_ns_detach_object(node);\r\n}\r\nif (obj_desc) {\r\nacpi_ut_add_reference(obj_desc);\r\nlast_obj_desc = obj_desc;\r\nwhile (last_obj_desc->common.next_object) {\r\nlast_obj_desc = last_obj_desc->common.next_object;\r\n}\r\nlast_obj_desc->common.next_object = node->object;\r\n}\r\nnode->type = (u8) object_type;\r\nnode->object = obj_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nvoid acpi_ns_detach_object(struct acpi_namespace_node *node)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nACPI_FUNCTION_TRACE(ns_detach_object);\r\nobj_desc = node->object;\r\nif (!obj_desc || (obj_desc->common.type == ACPI_TYPE_LOCAL_DATA)) {\r\nreturn_VOID;\r\n}\r\nif (node->flags & ANOBJ_ALLOCATED_BUFFER) {\r\nif (obj_desc->common.type == ACPI_TYPE_METHOD) {\r\nACPI_FREE(obj_desc->method.aml_start);\r\n}\r\n}\r\nnode->object = NULL;\r\nif (ACPI_GET_DESCRIPTOR_TYPE(obj_desc) == ACPI_DESC_TYPE_OPERAND) {\r\nnode->object = obj_desc->common.next_object;\r\nif (node->object &&\r\n(node->object->common.type != ACPI_TYPE_LOCAL_DATA)) {\r\nnode->object = node->object->common.next_object;\r\n}\r\nif (obj_desc->common.next_object &&\r\n((obj_desc->common.next_object)->common.type ==\r\nACPI_TYPE_LOCAL_DATA)) {\r\nobj_desc->common.next_object = NULL;\r\n}\r\n}\r\nnode->type = ACPI_TYPE_ANY;\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES, "Node %p [%4.4s] Object %p\n",\r\nnode, acpi_ut_get_node_name(node), obj_desc));\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_VOID;\r\n}\r\nunion acpi_operand_object *acpi_ns_get_attached_object(struct\r\nacpi_namespace_node\r\n*node)\r\n{\r\nACPI_FUNCTION_TRACE_PTR(ns_get_attached_object, node);\r\nif (!node) {\r\nACPI_WARNING((AE_INFO, "Null Node ptr"));\r\nreturn_PTR(NULL);\r\n}\r\nif (!node->object ||\r\n((ACPI_GET_DESCRIPTOR_TYPE(node->object) != ACPI_DESC_TYPE_OPERAND)\r\n&& (ACPI_GET_DESCRIPTOR_TYPE(node->object) !=\r\nACPI_DESC_TYPE_NAMED))\r\n|| ((node->object)->common.type == ACPI_TYPE_LOCAL_DATA)) {\r\nreturn_PTR(NULL);\r\n}\r\nreturn_PTR(node->object);\r\n}\r\nunion acpi_operand_object *acpi_ns_get_secondary_object(union\r\nacpi_operand_object\r\n*obj_desc)\r\n{\r\nACPI_FUNCTION_TRACE_PTR(ns_get_secondary_object, obj_desc);\r\nif ((!obj_desc) ||\r\n(obj_desc->common.type == ACPI_TYPE_LOCAL_DATA) ||\r\n(!obj_desc->common.next_object) ||\r\n((obj_desc->common.next_object)->common.type ==\r\nACPI_TYPE_LOCAL_DATA)) {\r\nreturn_PTR(NULL);\r\n}\r\nreturn_PTR(obj_desc->common.next_object);\r\n}\r\nacpi_status\r\nacpi_ns_attach_data(struct acpi_namespace_node *node,\r\nacpi_object_handler handler, void *data)\r\n{\r\nunion acpi_operand_object *prev_obj_desc;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *data_desc;\r\nprev_obj_desc = NULL;\r\nobj_desc = node->object;\r\nwhile (obj_desc) {\r\nif ((obj_desc->common.type == ACPI_TYPE_LOCAL_DATA) &&\r\n(obj_desc->data.handler == handler)) {\r\nreturn (AE_ALREADY_EXISTS);\r\n}\r\nprev_obj_desc = obj_desc;\r\nobj_desc = obj_desc->common.next_object;\r\n}\r\ndata_desc = acpi_ut_create_internal_object(ACPI_TYPE_LOCAL_DATA);\r\nif (!data_desc) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\ndata_desc->data.handler = handler;\r\ndata_desc->data.pointer = data;\r\nif (prev_obj_desc) {\r\nprev_obj_desc->common.next_object = data_desc;\r\n} else {\r\nnode->object = data_desc;\r\n}\r\nreturn (AE_OK);\r\n}\r\nacpi_status\r\nacpi_ns_detach_data(struct acpi_namespace_node *node,\r\nacpi_object_handler handler)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *prev_obj_desc;\r\nprev_obj_desc = NULL;\r\nobj_desc = node->object;\r\nwhile (obj_desc) {\r\nif ((obj_desc->common.type == ACPI_TYPE_LOCAL_DATA) &&\r\n(obj_desc->data.handler == handler)) {\r\nif (prev_obj_desc) {\r\nprev_obj_desc->common.next_object =\r\nobj_desc->common.next_object;\r\n} else {\r\nnode->object = obj_desc->common.next_object;\r\n}\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn (AE_OK);\r\n}\r\nprev_obj_desc = obj_desc;\r\nobj_desc = obj_desc->common.next_object;\r\n}\r\nreturn (AE_NOT_FOUND);\r\n}\r\nacpi_status\r\nacpi_ns_get_attached_data(struct acpi_namespace_node *node,\r\nacpi_object_handler handler, void **data)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nobj_desc = node->object;\r\nwhile (obj_desc) {\r\nif ((obj_desc->common.type == ACPI_TYPE_LOCAL_DATA) &&\r\n(obj_desc->data.handler == handler)) {\r\n*data = obj_desc->data.pointer;\r\nreturn (AE_OK);\r\n}\r\nobj_desc = obj_desc->common.next_object;\r\n}\r\nreturn (AE_NOT_FOUND);\r\n}

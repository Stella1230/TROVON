u32 dce6_endpoint_rreg(struct radeon_device *rdev,\r\nu32 block_offset, u32 reg)\r\n{\r\nunsigned long flags;\r\nu32 r;\r\nspin_lock_irqsave(&rdev->end_idx_lock, flags);\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset, reg);\r\nr = RREG32(AZ_F0_CODEC_ENDPOINT_DATA + block_offset);\r\nspin_unlock_irqrestore(&rdev->end_idx_lock, flags);\r\nreturn r;\r\n}\r\nvoid dce6_endpoint_wreg(struct radeon_device *rdev,\r\nu32 block_offset, u32 reg, u32 v)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rdev->end_idx_lock, flags);\r\nif (ASIC_IS_DCE8(rdev))\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset, reg);\r\nelse\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset,\r\nAZ_ENDPOINT_REG_WRITE_EN | AZ_ENDPOINT_REG_INDEX(reg));\r\nWREG32(AZ_F0_CODEC_ENDPOINT_DATA + block_offset, v);\r\nspin_unlock_irqrestore(&rdev->end_idx_lock, flags);\r\n}\r\nstatic void dce6_afmt_get_connected_pins(struct radeon_device *rdev)\r\n{\r\nint i;\r\nu32 offset, tmp;\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\noffset = rdev->audio.pin[i].offset;\r\ntmp = RREG32_ENDPOINT(offset,\r\nAZ_F0_CODEC_PIN_CONTROL_RESPONSE_CONFIGURATION_DEFAULT);\r\nif (((tmp & PORT_CONNECTIVITY_MASK) >> PORT_CONNECTIVITY_SHIFT) == 1)\r\nrdev->audio.pin[i].connected = false;\r\nelse\r\nrdev->audio.pin[i].connected = true;\r\n}\r\n}\r\nstruct r600_audio_pin *dce6_audio_get_pin(struct radeon_device *rdev)\r\n{\r\nstruct drm_encoder *encoder;\r\nstruct radeon_encoder *radeon_encoder;\r\nstruct radeon_encoder_atom_dig *dig;\r\nstruct r600_audio_pin *pin = NULL;\r\nint i, pin_count;\r\ndce6_afmt_get_connected_pins(rdev);\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\nif (rdev->audio.pin[i].connected) {\r\npin = &rdev->audio.pin[i];\r\npin_count = 0;\r\nlist_for_each_entry(encoder, &rdev->ddev->mode_config.encoder_list, head) {\r\nif (radeon_encoder_is_digital(encoder)) {\r\nradeon_encoder = to_radeon_encoder(encoder);\r\ndig = radeon_encoder->enc_priv;\r\nif (dig->pin == pin)\r\npin_count++;\r\n}\r\n}\r\nif (pin_count == 0)\r\nreturn pin;\r\n}\r\n}\r\nif (!pin)\r\nDRM_ERROR("No connected audio pins found!\n");\r\nreturn pin;\r\n}\r\nvoid dce6_afmt_select_pin(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt || !dig->pin)\r\nreturn;\r\nWREG32(AFMT_AUDIO_SRC_CONTROL + dig->afmt->offset,\r\nAFMT_AUDIO_SRC_SELECT(dig->pin->id));\r\n}\r\nvoid dce6_afmt_write_latency_fields(struct drm_encoder *encoder,\r\nstruct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nu32 tmp = 0;\r\nif (!dig || !dig->afmt || !dig->pin)\r\nreturn;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\r\nif (connector->latency_present[1])\r\ntmp = VIDEO_LIPSYNC(connector->video_latency[1]) |\r\nAUDIO_LIPSYNC(connector->audio_latency[1]);\r\nelse\r\ntmp = VIDEO_LIPSYNC(0) | AUDIO_LIPSYNC(0);\r\n} else {\r\nif (connector->latency_present[0])\r\ntmp = VIDEO_LIPSYNC(connector->video_latency[0]) |\r\nAUDIO_LIPSYNC(connector->audio_latency[0]);\r\nelse\r\ntmp = VIDEO_LIPSYNC(0) | AUDIO_LIPSYNC(0);\r\n}\r\nWREG32_ENDPOINT(dig->pin->offset,\r\nAZ_F0_CODEC_PIN_CONTROL_RESPONSE_LIPSYNC, tmp);\r\n}\r\nvoid dce6_afmt_hdmi_write_speaker_allocation(struct drm_encoder *encoder,\r\nu8 *sadb, int sad_count)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nu32 tmp;\r\nif (!dig || !dig->afmt || !dig->pin)\r\nreturn;\r\ntmp = RREG32_ENDPOINT(dig->pin->offset,\r\nAZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER);\r\ntmp &= ~(DP_CONNECTION | SPEAKER_ALLOCATION_MASK);\r\ntmp |= HDMI_CONNECTION;\r\nif (sad_count)\r\ntmp |= SPEAKER_ALLOCATION(sadb[0]);\r\nelse\r\ntmp |= SPEAKER_ALLOCATION(5);\r\nWREG32_ENDPOINT(dig->pin->offset,\r\nAZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER, tmp);\r\n}\r\nvoid dce6_afmt_dp_write_speaker_allocation(struct drm_encoder *encoder,\r\nu8 *sadb, int sad_count)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nu32 tmp;\r\nif (!dig || !dig->afmt || !dig->pin)\r\nreturn;\r\ntmp = RREG32_ENDPOINT(dig->pin->offset,\r\nAZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER);\r\ntmp &= ~(HDMI_CONNECTION | SPEAKER_ALLOCATION_MASK);\r\ntmp |= DP_CONNECTION;\r\nif (sad_count)\r\ntmp |= SPEAKER_ALLOCATION(sadb[0]);\r\nelse\r\ntmp |= SPEAKER_ALLOCATION(5);\r\nWREG32_ENDPOINT(dig->pin->offset,\r\nAZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER, tmp);\r\n}\r\nvoid dce6_afmt_write_sad_regs(struct drm_encoder *encoder,\r\nstruct cea_sad *sads, int sad_count)\r\n{\r\nint i;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstatic const u16 eld_reg_to_type[][2] = {\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR0, HDMI_AUDIO_CODING_TYPE_PCM },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR1, HDMI_AUDIO_CODING_TYPE_AC3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR2, HDMI_AUDIO_CODING_TYPE_MPEG1 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR3, HDMI_AUDIO_CODING_TYPE_MP3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR4, HDMI_AUDIO_CODING_TYPE_MPEG2 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR5, HDMI_AUDIO_CODING_TYPE_AAC_LC },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR6, HDMI_AUDIO_CODING_TYPE_DTS },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR7, HDMI_AUDIO_CODING_TYPE_ATRAC },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR9, HDMI_AUDIO_CODING_TYPE_EAC3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR10, HDMI_AUDIO_CODING_TYPE_DTS_HD },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR11, HDMI_AUDIO_CODING_TYPE_MLP },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR13, HDMI_AUDIO_CODING_TYPE_WMA_PRO },\r\n};\r\nif (!dig || !dig->afmt || !dig->pin)\r\nreturn;\r\nfor (i = 0; i < ARRAY_SIZE(eld_reg_to_type); i++) {\r\nu32 value = 0;\r\nu8 stereo_freqs = 0;\r\nint max_channels = -1;\r\nint j;\r\nfor (j = 0; j < sad_count; j++) {\r\nstruct cea_sad *sad = &sads[j];\r\nif (sad->format == eld_reg_to_type[i][1]) {\r\nif (sad->channels > max_channels) {\r\nvalue = MAX_CHANNELS(sad->channels) |\r\nDESCRIPTOR_BYTE_2(sad->byte2) |\r\nSUPPORTED_FREQUENCIES(sad->freq);\r\nmax_channels = sad->channels;\r\n}\r\nif (sad->format == HDMI_AUDIO_CODING_TYPE_PCM)\r\nstereo_freqs |= sad->freq;\r\nelse\r\nbreak;\r\n}\r\n}\r\nvalue |= SUPPORTED_FREQUENCIES_STEREO(stereo_freqs);\r\nWREG32_ENDPOINT(dig->pin->offset, eld_reg_to_type[i][0], value);\r\n}\r\n}\r\nvoid dce6_audio_enable(struct radeon_device *rdev,\r\nstruct r600_audio_pin *pin,\r\nu8 enable_mask)\r\n{\r\nif (!pin)\r\nreturn;\r\nWREG32_ENDPOINT(pin->offset, AZ_F0_CODEC_PIN_CONTROL_HOT_PLUG_CONTROL,\r\nenable_mask ? AUDIO_ENABLED : 0);\r\n}\r\nvoid dce6_hdmi_audio_set_dto(struct radeon_device *rdev,\r\nstruct radeon_crtc *crtc, unsigned int clock)\r\n{\r\nu32 value = 0;\r\nif (crtc)\r\nvalue |= DCCG_AUDIO_DTO0_SOURCE_SEL(crtc->crtc_id);\r\nWREG32(DCCG_AUDIO_DTO_SOURCE, value);\r\nWREG32(DCCG_AUDIO_DTO0_PHASE, 24000);\r\nWREG32(DCCG_AUDIO_DTO0_MODULE, clock);\r\n}\r\nvoid dce6_dp_audio_set_dto(struct radeon_device *rdev,\r\nstruct radeon_crtc *crtc, unsigned int clock)\r\n{\r\nu32 value = 0;\r\nvalue |= DCCG_AUDIO_DTO_SEL;\r\nif (crtc)\r\nvalue |= DCCG_AUDIO_DTO0_SOURCE_SEL(crtc->crtc_id);\r\nWREG32(DCCG_AUDIO_DTO_SOURCE, value);\r\nif (ASIC_IS_DCE8(rdev)) {\r\nunsigned int div = (RREG32(DENTIST_DISPCLK_CNTL) &\r\nDENTIST_DPREFCLK_WDIVIDER_MASK) >>\r\nDENTIST_DPREFCLK_WDIVIDER_SHIFT;\r\ndiv = radeon_audio_decode_dfs_div(div);\r\nif (div)\r\nclock = clock * 100 / div;\r\nWREG32(DCE8_DCCG_AUDIO_DTO1_PHASE, 24000);\r\nWREG32(DCE8_DCCG_AUDIO_DTO1_MODULE, clock);\r\n} else {\r\nWREG32(DCCG_AUDIO_DTO1_PHASE, 24000);\r\nWREG32(DCCG_AUDIO_DTO1_MODULE, clock);\r\n}\r\n}

int intel_gvt_init_host(void)\r\n{\r\nif (intel_gvt_host.initialized)\r\nreturn 0;\r\nif (xen_domain() && !xen_initial_domain())\r\nreturn -ENODEV;\r\nif (xen_initial_domain()) {\r\nintel_gvt_host.mpt = try_then_request_module(\r\nsymbol_get(xengt_mpt), "xengt");\r\nintel_gvt_host.hypervisor_type = INTEL_GVT_HYPERVISOR_XEN;\r\n} else {\r\n#if IS_ENABLED(CONFIG_DRM_I915_GVT_KVMGT)\r\nintel_gvt_host.mpt = try_then_request_module(\r\nsymbol_get(kvmgt_mpt), "kvmgt");\r\nintel_gvt_host.hypervisor_type = INTEL_GVT_HYPERVISOR_KVM;\r\n#endif\r\n}\r\nif (!intel_gvt_host.mpt)\r\nreturn -EINVAL;\r\ngvt_dbg_core("Running with hypervisor %s in host mode\n",\r\nsupported_hypervisors[intel_gvt_host.hypervisor_type]);\r\nintel_gvt_host.initialized = true;\r\nreturn 0;\r\n}\r\nstatic void init_device_info(struct intel_gvt *gvt)\r\n{\r\nstruct intel_gvt_device_info *info = &gvt->device_info;\r\nstruct pci_dev *pdev = gvt->dev_priv->drm.pdev;\r\nif (IS_BROADWELL(gvt->dev_priv) || IS_SKYLAKE(gvt->dev_priv)\r\n|| IS_KABYLAKE(gvt->dev_priv)) {\r\ninfo->max_support_vgpus = 8;\r\ninfo->cfg_space_size = 256;\r\ninfo->mmio_size = 2 * 1024 * 1024;\r\ninfo->mmio_bar = 0;\r\ninfo->gtt_start_offset = 8 * 1024 * 1024;\r\ninfo->gtt_entry_size = 8;\r\ninfo->gtt_entry_size_shift = 3;\r\ninfo->gmadr_bytes_in_cmd = 8;\r\ninfo->max_surface_size = 36 * 1024 * 1024;\r\n}\r\ninfo->msi_cap_offset = pdev->msi_cap;\r\n}\r\nstatic int gvt_service_thread(void *data)\r\n{\r\nstruct intel_gvt *gvt = (struct intel_gvt *)data;\r\nint ret;\r\ngvt_dbg_core("service thread start\n");\r\nwhile (!kthread_should_stop()) {\r\nret = wait_event_interruptible(gvt->service_thread_wq,\r\nkthread_should_stop() || gvt->service_request);\r\nif (kthread_should_stop())\r\nbreak;\r\nif (WARN_ONCE(ret, "service thread is waken up by signal.\n"))\r\ncontinue;\r\nif (test_and_clear_bit(INTEL_GVT_REQUEST_EMULATE_VBLANK,\r\n(void *)&gvt->service_request)) {\r\nmutex_lock(&gvt->lock);\r\nintel_gvt_emulate_vblank(gvt);\r\nmutex_unlock(&gvt->lock);\r\n}\r\nif (test_bit(INTEL_GVT_REQUEST_SCHED,\r\n(void *)&gvt->service_request) ||\r\ntest_bit(INTEL_GVT_REQUEST_EVENT_SCHED,\r\n(void *)&gvt->service_request)) {\r\nintel_gvt_schedule(gvt);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void clean_service_thread(struct intel_gvt *gvt)\r\n{\r\nkthread_stop(gvt->service_thread);\r\n}\r\nstatic int init_service_thread(struct intel_gvt *gvt)\r\n{\r\ninit_waitqueue_head(&gvt->service_thread_wq);\r\ngvt->service_thread = kthread_run(gvt_service_thread,\r\ngvt, "gvt_service_thread");\r\nif (IS_ERR(gvt->service_thread)) {\r\ngvt_err("fail to start service thread.\n");\r\nreturn PTR_ERR(gvt->service_thread);\r\n}\r\nreturn 0;\r\n}\r\nvoid intel_gvt_clean_device(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_gvt *gvt = to_gvt(dev_priv);\r\nif (WARN_ON(!gvt))\r\nreturn;\r\nclean_service_thread(gvt);\r\nintel_gvt_clean_cmd_parser(gvt);\r\nintel_gvt_clean_sched_policy(gvt);\r\nintel_gvt_clean_workload_scheduler(gvt);\r\nintel_gvt_clean_opregion(gvt);\r\nintel_gvt_clean_gtt(gvt);\r\nintel_gvt_clean_irq(gvt);\r\nintel_gvt_clean_mmio_info(gvt);\r\nintel_gvt_free_firmware(gvt);\r\nintel_gvt_hypervisor_host_exit(&dev_priv->drm.pdev->dev, gvt);\r\nintel_gvt_clean_vgpu_types(gvt);\r\nidr_destroy(&gvt->vgpu_idr);\r\nintel_gvt_destroy_idle_vgpu(gvt->idle_vgpu);\r\nkfree(dev_priv->gvt);\r\ndev_priv->gvt = NULL;\r\n}\r\nint intel_gvt_init_device(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_gvt *gvt;\r\nstruct intel_vgpu *vgpu;\r\nint ret;\r\nif (WARN_ON(!intel_gvt_host.initialized))\r\nreturn -EINVAL;\r\nif (WARN_ON(dev_priv->gvt))\r\nreturn -EEXIST;\r\ngvt = kzalloc(sizeof(struct intel_gvt), GFP_KERNEL);\r\nif (!gvt)\r\nreturn -ENOMEM;\r\ngvt_dbg_core("init gvt device\n");\r\nidr_init(&gvt->vgpu_idr);\r\nspin_lock_init(&gvt->scheduler.mmio_context_lock);\r\nmutex_init(&gvt->lock);\r\ngvt->dev_priv = dev_priv;\r\ninit_device_info(gvt);\r\nret = intel_gvt_setup_mmio_info(gvt);\r\nif (ret)\r\ngoto out_clean_idr;\r\nret = intel_gvt_load_firmware(gvt);\r\nif (ret)\r\ngoto out_clean_mmio_info;\r\nret = intel_gvt_init_irq(gvt);\r\nif (ret)\r\ngoto out_free_firmware;\r\nret = intel_gvt_init_gtt(gvt);\r\nif (ret)\r\ngoto out_clean_irq;\r\nret = intel_gvt_init_opregion(gvt);\r\nif (ret)\r\ngoto out_clean_gtt;\r\nret = intel_gvt_init_workload_scheduler(gvt);\r\nif (ret)\r\ngoto out_clean_opregion;\r\nret = intel_gvt_init_sched_policy(gvt);\r\nif (ret)\r\ngoto out_clean_workload_scheduler;\r\nret = intel_gvt_init_cmd_parser(gvt);\r\nif (ret)\r\ngoto out_clean_sched_policy;\r\nret = init_service_thread(gvt);\r\nif (ret)\r\ngoto out_clean_cmd_parser;\r\nret = intel_gvt_init_vgpu_types(gvt);\r\nif (ret)\r\ngoto out_clean_thread;\r\nret = intel_gvt_hypervisor_host_init(&dev_priv->drm.pdev->dev, gvt,\r\n&intel_gvt_ops);\r\nif (ret) {\r\ngvt_err("failed to register gvt-g host device: %d\n", ret);\r\ngoto out_clean_types;\r\n}\r\nvgpu = intel_gvt_create_idle_vgpu(gvt);\r\nif (IS_ERR(vgpu)) {\r\nret = PTR_ERR(vgpu);\r\ngvt_err("failed to create idle vgpu\n");\r\ngoto out_clean_types;\r\n}\r\ngvt->idle_vgpu = vgpu;\r\ngvt_dbg_core("gvt device initialization is done\n");\r\ndev_priv->gvt = gvt;\r\nreturn 0;\r\nout_clean_types:\r\nintel_gvt_clean_vgpu_types(gvt);\r\nout_clean_thread:\r\nclean_service_thread(gvt);\r\nout_clean_cmd_parser:\r\nintel_gvt_clean_cmd_parser(gvt);\r\nout_clean_sched_policy:\r\nintel_gvt_clean_sched_policy(gvt);\r\nout_clean_workload_scheduler:\r\nintel_gvt_clean_workload_scheduler(gvt);\r\nout_clean_opregion:\r\nintel_gvt_clean_opregion(gvt);\r\nout_clean_gtt:\r\nintel_gvt_clean_gtt(gvt);\r\nout_clean_irq:\r\nintel_gvt_clean_irq(gvt);\r\nout_free_firmware:\r\nintel_gvt_free_firmware(gvt);\r\nout_clean_mmio_info:\r\nintel_gvt_clean_mmio_info(gvt);\r\nout_clean_idr:\r\nidr_destroy(&gvt->vgpu_idr);\r\nkfree(gvt);\r\nreturn ret;\r\n}

static char *ipc_open_param_str(struct jpeg_video_decode_init_params_t *p,\r\nchar *str, unsigned int len)\r\n{\r\nchar *b = str;\r\nif (!p)\r\nreturn "";\r\nb += snprintf(b, len,\r\n"jpeg_video_decode_init_params_t\n"\r\n"circular_buffer_begin_addr_p 0x%x\n"\r\n"circular_buffer_end_addr_p 0x%x\n",\r\np->circular_buffer_begin_addr_p,\r\np->circular_buffer_end_addr_p);\r\nreturn str;\r\n}\r\nstatic char *ipc_decode_param_str(struct jpeg_decode_params_t *p,\r\nchar *str, unsigned int len)\r\n{\r\nchar *b = str;\r\nif (!p)\r\nreturn "";\r\nb += snprintf(b, len,\r\n"jpeg_decode_params_t\n"\r\n"picture_start_addr_p 0x%x\n"\r\n"picture_end_addr_p 0x%x\n"\r\n"decoding_mode %d\n"\r\n"display_buffer_addr.display_decimated_luma_p 0x%x\n"\r\n"display_buffer_addr.display_decimated_chroma_p 0x%x\n"\r\n"main_aux_enable %d\n"\r\n"additional_flags 0x%x\n"\r\n"field_flag %x\n"\r\n"is_jpeg_image %x\n",\r\np->picture_start_addr_p,\r\np->picture_end_addr_p,\r\np->decoding_mode,\r\np->display_buffer_addr.display_decimated_luma_p,\r\np->display_buffer_addr.display_decimated_chroma_p,\r\np->main_aux_enable, p->additional_flags,\r\np->field_flag,\r\np->is_jpeg_image);\r\nreturn str;\r\n}\r\nstatic inline bool is_stream_error(enum jpeg_decoding_error_t err)\r\n{\r\nswitch (err) {\r\ncase JPEG_DECODER_UNDEFINED_HUFF_TABLE:\r\ncase JPEG_DECODER_BAD_RESTART_MARKER:\r\ncase JPEG_DECODER_BAD_SOS_SPECTRAL:\r\ncase JPEG_DECODER_BAD_SOS_SUCCESSIVE:\r\ncase JPEG_DECODER_BAD_HEADER_LENGTH:\r\ncase JPEG_DECODER_BAD_COUNT_VALUE:\r\ncase JPEG_DECODER_BAD_DHT_MARKER:\r\ncase JPEG_DECODER_BAD_INDEX_VALUE:\r\ncase JPEG_DECODER_BAD_NUMBER_HUFFMAN_TABLES:\r\ncase JPEG_DECODER_BAD_QUANT_TABLE_LENGTH:\r\ncase JPEG_DECODER_BAD_NUMBER_QUANT_TABLES:\r\ncase JPEG_DECODER_BAD_COMPONENT_COUNT:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic inline const char *err_str(enum jpeg_decoding_error_t err)\r\n{\r\nswitch (err) {\r\ncase JPEG_DECODER_NO_ERROR:\r\nreturn "JPEG_DECODER_NO_ERROR";\r\ncase JPEG_DECODER_UNDEFINED_HUFF_TABLE:\r\nreturn "JPEG_DECODER_UNDEFINED_HUFF_TABLE";\r\ncase JPEG_DECODER_UNSUPPORTED_MARKER:\r\nreturn "JPEG_DECODER_UNSUPPORTED_MARKER";\r\ncase JPEG_DECODER_UNABLE_ALLOCATE_MEMORY:\r\nreturn "JPEG_DECODER_UNABLE_ALLOCATE_MEMORY";\r\ncase JPEG_DECODER_NON_SUPPORTED_SAMP_FACTORS:\r\nreturn "JPEG_DECODER_NON_SUPPORTED_SAMP_FACTORS";\r\ncase JPEG_DECODER_BAD_PARAMETER:\r\nreturn "JPEG_DECODER_BAD_PARAMETER";\r\ncase JPEG_DECODER_DECODE_ERROR:\r\nreturn "JPEG_DECODER_DECODE_ERROR";\r\ncase JPEG_DECODER_BAD_RESTART_MARKER:\r\nreturn "JPEG_DECODER_BAD_RESTART_MARKER";\r\ncase JPEG_DECODER_UNSUPPORTED_COLORSPACE:\r\nreturn "JPEG_DECODER_UNSUPPORTED_COLORSPACE";\r\ncase JPEG_DECODER_BAD_SOS_SPECTRAL:\r\nreturn "JPEG_DECODER_BAD_SOS_SPECTRAL";\r\ncase JPEG_DECODER_BAD_SOS_SUCCESSIVE:\r\nreturn "JPEG_DECODER_BAD_SOS_SUCCESSIVE";\r\ncase JPEG_DECODER_BAD_HEADER_LENGTH:\r\nreturn "JPEG_DECODER_BAD_HEADER_LENGTH";\r\ncase JPEG_DECODER_BAD_COUNT_VALUE:\r\nreturn "JPEG_DECODER_BAD_COUNT_VALUE";\r\ncase JPEG_DECODER_BAD_DHT_MARKER:\r\nreturn "JPEG_DECODER_BAD_DHT_MARKER";\r\ncase JPEG_DECODER_BAD_INDEX_VALUE:\r\nreturn "JPEG_DECODER_BAD_INDEX_VALUE";\r\ncase JPEG_DECODER_BAD_NUMBER_HUFFMAN_TABLES:\r\nreturn "JPEG_DECODER_BAD_NUMBER_HUFFMAN_TABLES";\r\ncase JPEG_DECODER_BAD_QUANT_TABLE_LENGTH:\r\nreturn "JPEG_DECODER_BAD_QUANT_TABLE_LENGTH";\r\ncase JPEG_DECODER_BAD_NUMBER_QUANT_TABLES:\r\nreturn "JPEG_DECODER_BAD_NUMBER_QUANT_TABLES";\r\ncase JPEG_DECODER_BAD_COMPONENT_COUNT:\r\nreturn "JPEG_DECODER_BAD_COMPONENT_COUNT";\r\ncase JPEG_DECODER_DIVIDE_BY_ZERO_ERROR:\r\nreturn "JPEG_DECODER_DIVIDE_BY_ZERO_ERROR";\r\ncase JPEG_DECODER_NOT_JPG_IMAGE:\r\nreturn "JPEG_DECODER_NOT_JPG_IMAGE";\r\ncase JPEG_DECODER_UNSUPPORTED_ROTATION_ANGLE:\r\nreturn "JPEG_DECODER_UNSUPPORTED_ROTATION_ANGLE";\r\ncase JPEG_DECODER_UNSUPPORTED_SCALING:\r\nreturn "JPEG_DECODER_UNSUPPORTED_SCALING";\r\ncase JPEG_DECODER_INSUFFICIENT_OUTPUTBUFFER_SIZE:\r\nreturn "JPEG_DECODER_INSUFFICIENT_OUTPUTBUFFER_SIZE";\r\ncase JPEG_DECODER_BAD_HWCFG_GP_VERSION_VALUE:\r\nreturn "JPEG_DECODER_BAD_HWCFG_GP_VERSION_VALUE";\r\ncase JPEG_DECODER_BAD_VALUE_FROM_RED:\r\nreturn "JPEG_DECODER_BAD_VALUE_FROM_RED";\r\ncase JPEG_DECODER_BAD_SUBREGION_PARAMETERS:\r\nreturn "JPEG_DECODER_BAD_SUBREGION_PARAMETERS";\r\ncase JPEG_DECODER_PROGRESSIVE_DECODE_NOT_SUPPORTED:\r\nreturn "JPEG_DECODER_PROGRESSIVE_DECODE_NOT_SUPPORTED";\r\ncase JPEG_DECODER_ERROR_TASK_TIMEOUT:\r\nreturn "JPEG_DECODER_ERROR_TASK_TIMEOUT";\r\ncase JPEG_DECODER_ERROR_FEATURE_NOT_SUPPORTED:\r\nreturn "JPEG_DECODER_ERROR_FEATURE_NOT_SUPPORTED";\r\ndefault:\r\nreturn "!unknown MJPEG error!";\r\n}\r\n}\r\nstatic bool delta_mjpeg_check_status(struct delta_ctx *pctx,\r\nstruct jpeg_decode_return_params_t *status)\r\n{\r\nstruct delta_dev *delta = pctx->dev;\r\nbool dump = false;\r\nif (status->error_code == JPEG_DECODER_NO_ERROR)\r\ngoto out;\r\nif (is_stream_error(status->error_code)) {\r\ndev_warn_ratelimited(delta->dev,\r\n"%s firmware: stream error @ frame %d (%s)\n",\r\npctx->name, pctx->decoded_frames,\r\nerr_str(status->error_code));\r\npctx->stream_errors++;\r\n} else {\r\ndev_warn_ratelimited(delta->dev,\r\n"%s firmware: decode error @ frame %d (%s)\n",\r\npctx->name, pctx->decoded_frames,\r\nerr_str(status->error_code));\r\npctx->decode_errors++;\r\ndump = true;\r\n}\r\nout:\r\ndev_dbg(delta->dev,\r\n"%s firmware: decoding time(us)=%d\n", pctx->name,\r\nstatus->decode_time_in_us);\r\nreturn dump;\r\n}\r\nstatic int delta_mjpeg_ipc_open(struct delta_ctx *pctx)\r\n{\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nint ret = 0;\r\nstruct jpeg_video_decode_init_params_t params_struct;\r\nstruct jpeg_video_decode_init_params_t *params = &params_struct;\r\nstruct delta_buf *ipc_buf;\r\nu32 ipc_buf_size;\r\nstruct delta_ipc_param ipc_param;\r\nvoid *hdl;\r\nmemset(params, 0, sizeof(*params));\r\nparams->circular_buffer_begin_addr_p = 0x00000000;\r\nparams->circular_buffer_end_addr_p = 0xffffffff;\r\ndev_vdbg(delta->dev,\r\n"%s %s\n", pctx->name,\r\nipc_open_param_str(params, ctx->str, sizeof(ctx->str)));\r\nipc_param.size = sizeof(*params);\r\nipc_param.data = params;\r\nipc_buf_size = sizeof(struct jpeg_decode_params_t) +\r\nsizeof(struct jpeg_decode_return_params_t);\r\nret = delta_ipc_open(pctx, "JPEG_DECODER_HW0", &ipc_param,\r\nipc_buf_size, &ipc_buf, &hdl);\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s dumping command %s\n", pctx->name,\r\nipc_open_param_str(params, ctx->str, sizeof(ctx->str)));\r\nreturn ret;\r\n}\r\nctx->ipc_buf = ipc_buf;\r\nctx->ipc_hdl = hdl;\r\nreturn 0;\r\n}\r\nstatic int delta_mjpeg_ipc_decode(struct delta_ctx *pctx, struct delta_au *au)\r\n{\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nint ret = 0;\r\nstruct jpeg_decode_params_t *params = ctx->ipc_buf->vaddr;\r\nstruct jpeg_decode_return_params_t *status =\r\nctx->ipc_buf->vaddr + sizeof(*params);\r\nstruct delta_frame *frame;\r\nstruct delta_ipc_param ipc_param, ipc_status;\r\nret = delta_get_free_frame(pctx, &frame);\r\nif (ret)\r\nreturn ret;\r\nmemset(params, 0, sizeof(*params));\r\nparams->picture_start_addr_p = (u32)(au->paddr);\r\nparams->picture_end_addr_p = (u32)(au->paddr + au->size - 1);\r\nparams->main_aux_enable = JPEG_DISP_AUX_EN;\r\nparams->additional_flags = JPEG_ADDITIONAL_FLAG_420MB;\r\nparams->horizontal_decimation_factor = JPEG_HDEC_1;\r\nparams->vertical_decimation_factor = JPEG_VDEC_1;\r\nparams->decoding_mode = JPEG_NORMAL_DECODE;\r\nparams->display_buffer_addr.struct_size =\r\nsizeof(struct jpeg_display_buffer_address_t);\r\nparams->display_buffer_addr.display_decimated_luma_p =\r\n(u32)frame->paddr;\r\nparams->display_buffer_addr.display_decimated_chroma_p =\r\n(u32)(frame->paddr\r\n+ frame->info.aligned_width * frame->info.aligned_height);\r\ndev_vdbg(delta->dev,\r\n"%s %s\n", pctx->name,\r\nipc_decode_param_str(params, ctx->str, sizeof(ctx->str)));\r\nmemset(status, 0, sizeof(*status));\r\nstatus->error_code = JPEG_DECODER_NO_ERROR;\r\nipc_param.size = sizeof(*params);\r\nipc_param.data = params;\r\nipc_status.size = sizeof(*status);\r\nipc_status.data = status;\r\nret = delta_ipc_decode(ctx->ipc_hdl, &ipc_param, &ipc_status);\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s dumping command %s\n", pctx->name,\r\nipc_decode_param_str(params, ctx->str,\r\nsizeof(ctx->str)));\r\nreturn ret;\r\n}\r\npctx->decoded_frames++;\r\nif (delta_mjpeg_check_status(pctx, status)) {\r\ndev_err(delta->dev,\r\n"%s dumping command %s\n", pctx->name,\r\nipc_decode_param_str(params, ctx->str,\r\nsizeof(ctx->str)));\r\n}\r\nframe->field = V4L2_FIELD_NONE;\r\nframe->flags = V4L2_BUF_FLAG_KEYFRAME;\r\nframe->state |= DELTA_FRAME_DEC;\r\nctx->out_frame = frame;\r\nreturn 0;\r\n}\r\nstatic int delta_mjpeg_open(struct delta_ctx *pctx)\r\n{\r\nstruct delta_mjpeg_ctx *ctx;\r\nctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\npctx->priv = ctx;\r\nreturn 0;\r\n}\r\nstatic int delta_mjpeg_close(struct delta_ctx *pctx)\r\n{\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nif (ctx->ipc_hdl) {\r\ndelta_ipc_close(ctx->ipc_hdl);\r\nctx->ipc_hdl = NULL;\r\n}\r\nkfree(ctx);\r\nreturn 0;\r\n}\r\nstatic int delta_mjpeg_get_streaminfo(struct delta_ctx *pctx,\r\nstruct delta_streaminfo *streaminfo)\r\n{\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nif (!ctx->header)\r\ngoto nodata;\r\nstreaminfo->streamformat = V4L2_PIX_FMT_MJPEG;\r\nstreaminfo->width = ctx->header->frame_width;\r\nstreaminfo->height = ctx->header->frame_height;\r\nstreaminfo->field = V4L2_FIELD_NONE;\r\nstreaminfo->dpb = 1;\r\nreturn 0;\r\nnodata:\r\nreturn -ENODATA;\r\n}\r\nstatic int delta_mjpeg_decode(struct delta_ctx *pctx, struct delta_au *pau)\r\n{\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nint ret;\r\nstruct delta_au au = *pau;\r\nunsigned int data_offset = 0;\r\nstruct mjpeg_header *header = &ctx->header_struct;\r\nif (!ctx->header) {\r\nret = delta_mjpeg_read_header(pctx, au.vaddr, au.size,\r\nheader, &data_offset);\r\nif (ret) {\r\npctx->stream_errors++;\r\ngoto err;\r\n}\r\nif (header->frame_width * header->frame_height >\r\nDELTA_MJPEG_MAX_RESO) {\r\ndev_err(delta->dev,\r\n"%s stream resolution too large: %dx%d > %d pixels budget\n",\r\npctx->name,\r\nheader->frame_width,\r\nheader->frame_height, DELTA_MJPEG_MAX_RESO);\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nctx->header = header;\r\ngoto out;\r\n}\r\nif (!ctx->ipc_hdl) {\r\nret = delta_mjpeg_ipc_open(pctx);\r\nif (ret)\r\ngoto err;\r\n}\r\nret = delta_mjpeg_read_header(pctx, au.vaddr, au.size,\r\nctx->header, &data_offset);\r\nif (ret) {\r\npctx->stream_errors++;\r\ngoto err;\r\n}\r\nau.paddr += data_offset;\r\nau.vaddr += data_offset;\r\nret = delta_mjpeg_ipc_decode(pctx, &au);\r\nif (ret)\r\ngoto err;\r\nout:\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int delta_mjpeg_get_frame(struct delta_ctx *pctx,\r\nstruct delta_frame **frame)\r\n{\r\nstruct delta_mjpeg_ctx *ctx = to_ctx(pctx);\r\nif (!ctx->out_frame)\r\nreturn -ENODATA;\r\n*frame = ctx->out_frame;\r\nctx->out_frame = NULL;\r\nreturn 0;\r\n}

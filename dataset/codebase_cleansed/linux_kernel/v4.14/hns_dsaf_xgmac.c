static void hns_xgmac_tx_enable(struct mac_driver *drv, u32 value)\r\n{\r\ndsaf_set_dev_bit(drv, XGMAC_MAC_ENABLE_REG, XGMAC_ENABLE_TX_B, !!value);\r\n}\r\nstatic void hns_xgmac_rx_enable(struct mac_driver *drv, u32 value)\r\n{\r\ndsaf_set_dev_bit(drv, XGMAC_MAC_ENABLE_REG, XGMAC_ENABLE_RX_B, !!value);\r\n}\r\nstatic void hns_xgmac_lf_rf_insert(struct mac_driver *mac_drv, u32 mode)\r\n{\r\ndsaf_set_dev_field(mac_drv, XGMAC_MAC_TX_LF_RF_CONTROL_REG,\r\nXGMAC_LF_RF_INSERT_M, XGMAC_LF_RF_INSERT_S, mode);\r\n}\r\nstatic void hns_xgmac_lf_rf_control_init(struct mac_driver *mac_drv)\r\n{\r\nu32 val = 0;\r\ndsaf_set_bit(val, XGMAC_UNIDIR_EN_B, 0);\r\ndsaf_set_bit(val, XGMAC_RF_TX_EN_B, 1);\r\ndsaf_set_field(val, XGMAC_LF_RF_INSERT_M, XGMAC_LF_RF_INSERT_S, 0);\r\ndsaf_write_reg(mac_drv, XGMAC_MAC_TX_LF_RF_CONTROL_REG, val);\r\n}\r\nstatic void hns_xgmac_enable(void *mac_drv, enum mac_commom_mode mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nhns_xgmac_lf_rf_insert(drv, HNS_XGMAC_NO_LF_RF_INSERT);\r\nif (mode == MAC_COMM_MODE_TX) {\r\nhns_xgmac_tx_enable(drv, 1);\r\n} else if (mode == MAC_COMM_MODE_RX) {\r\nhns_xgmac_rx_enable(drv, 1);\r\n} else if (mode == MAC_COMM_MODE_RX_AND_TX) {\r\nhns_xgmac_tx_enable(drv, 1);\r\nhns_xgmac_rx_enable(drv, 1);\r\n} else {\r\ndev_err(drv->dev, "error mac mode:%d\n", mode);\r\n}\r\n}\r\nstatic void hns_xgmac_disable(void *mac_drv, enum mac_commom_mode mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nif (mode == MAC_COMM_MODE_TX) {\r\nhns_xgmac_tx_enable(drv, 0);\r\n} else if (mode == MAC_COMM_MODE_RX) {\r\nhns_xgmac_rx_enable(drv, 0);\r\n} else if (mode == MAC_COMM_MODE_RX_AND_TX) {\r\nhns_xgmac_tx_enable(drv, 0);\r\nhns_xgmac_rx_enable(drv, 0);\r\n}\r\nhns_xgmac_lf_rf_insert(drv, HNS_XGMAC_LF_INSERT);\r\n}\r\nstatic void hns_xgmac_pma_fec_enable(struct mac_driver *drv, u32 tx_value,\r\nu32 rx_value)\r\n{\r\nu32 origin = dsaf_read_dev(drv, XGMAC_PMA_FEC_CONTROL_REG);\r\ndsaf_set_bit(origin, XGMAC_PMA_FEC_CTL_TX_B, !!tx_value);\r\ndsaf_set_bit(origin, XGMAC_PMA_FEC_CTL_RX_B, !!rx_value);\r\ndsaf_write_dev(drv, XGMAC_PMA_FEC_CONTROL_REG, origin);\r\n}\r\nstatic void hns_xgmac_exc_irq_en(struct mac_driver *drv, u32 en)\r\n{\r\nu32 clr_vlue = 0xfffffffful;\r\nu32 msk_vlue = en ? 0xfffffffful : 0;\r\ndsaf_write_dev(drv, XGMAC_INT_STATUS_REG, clr_vlue);\r\ndsaf_write_dev(drv, XGMAC_INT_ENABLE_REG, msk_vlue);\r\n}\r\nstatic void hns_xgmac_init(void *mac_drv)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct dsaf_device *dsaf_dev\r\n= (struct dsaf_device *)dev_get_drvdata(drv->dev);\r\nu32 port = drv->mac_id;\r\ndsaf_dev->misc_op->xge_srst(dsaf_dev, port, 0);\r\nmdelay(100);\r\ndsaf_dev->misc_op->xge_srst(dsaf_dev, port, 1);\r\nmdelay(100);\r\nhns_xgmac_lf_rf_control_init(drv);\r\nhns_xgmac_exc_irq_en(drv, 0);\r\nhns_xgmac_pma_fec_enable(drv, 0x0, 0x0);\r\nhns_xgmac_disable(mac_drv, MAC_COMM_MODE_RX_AND_TX);\r\n}\r\nstatic void hns_xgmac_config_pad_and_crc(void *mac_drv, u8 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 origin = dsaf_read_dev(drv, XGMAC_MAC_CONTROL_REG);\r\ndsaf_set_bit(origin, XGMAC_CTL_TX_PAD_B, !!newval);\r\ndsaf_set_bit(origin, XGMAC_CTL_TX_FCS_B, !!newval);\r\ndsaf_set_bit(origin, XGMAC_CTL_RX_FCS_B, !!newval);\r\ndsaf_write_dev(drv, XGMAC_MAC_CONTROL_REG, origin);\r\n}\r\nstatic void hns_xgmac_pausefrm_cfg(void *mac_drv, u32 rx_en, u32 tx_en)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 origin = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_CTRL_REG);\r\ndsaf_set_bit(origin, XGMAC_PAUSE_CTL_TX_B, !!tx_en);\r\ndsaf_set_bit(origin, XGMAC_PAUSE_CTL_RX_B, !!rx_en);\r\ndsaf_write_dev(drv, XGMAC_MAC_PAUSE_CTRL_REG, origin);\r\n}\r\nstatic void hns_xgmac_set_pausefrm_mac_addr(void *mac_drv, char *mac_addr)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 high_val = mac_addr[1] | (mac_addr[0] << 8);\r\nu32 low_val = mac_addr[5] | (mac_addr[4] << 8)\r\n| (mac_addr[3] << 16) | (mac_addr[2] << 24);\r\ndsaf_write_dev(drv, XGMAC_MAC_PAUSE_LOCAL_MAC_L_REG, low_val);\r\ndsaf_write_dev(drv, XGMAC_MAC_PAUSE_LOCAL_MAC_H_REG, high_val);\r\n}\r\nstatic void hns_xgmac_set_rx_ignore_pause_frames(void *mac_drv, u32 enable)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, XGMAC_MAC_PAUSE_CTRL_REG,\r\nXGMAC_PAUSE_CTL_RX_B, !!enable);\r\n}\r\nstatic void hns_xgmac_set_tx_auto_pause_frames(void *mac_drv, u16 enable)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, XGMAC_MAC_PAUSE_CTRL_REG,\r\nXGMAC_PAUSE_CTL_TX_B, !!enable);\r\nif (enable)\r\ndsaf_write_dev(drv, XGMAC_MAC_PAUSE_TIME_REG, enable);\r\n}\r\nstatic void hns_xgmac_config_max_frame_length(void *mac_drv, u16 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_write_dev(drv, XGMAC_MAC_MAX_PKT_SIZE_REG, newval);\r\n}\r\nvoid hns_xgmac_update_stats(void *mac_drv)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct mac_hw_stats *hw_stats = &drv->mac_cb->hw_stats;\r\nhw_stats->tx_fragment_err\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_FRAGMENT);\r\nhw_stats->tx_undersize\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_UNDERSIZE);\r\nhw_stats->tx_under_min_pkts\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_UNDERMIN);\r\nhw_stats->tx_64bytes = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_64OCTETS);\r\nhw_stats->tx_65to127\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_65TO127OCTETS);\r\nhw_stats->tx_128to255\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_128TO255OCTETS);\r\nhw_stats->tx_256to511\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_256TO511OCTETS);\r\nhw_stats->tx_512to1023\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_512TO1023OCTETS);\r\nhw_stats->tx_1024to1518\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1024TO1518OCTETS);\r\nhw_stats->tx_1519tomax\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1519TOMAXOCTETS);\r\nhw_stats->tx_1519tomax_good\r\n= hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1519TOMAXOCTETSOK);\r\nhw_stats->tx_oversize = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_OVERSIZE);\r\nhw_stats->tx_jabber_err = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_JABBER);\r\nhw_stats->tx_good_pkts = hns_mac_reg_read64(drv, XGMAC_TX_GOODPKTS);\r\nhw_stats->tx_good_bytes = hns_mac_reg_read64(drv, XGMAC_TX_GOODOCTETS);\r\nhw_stats->tx_total_pkts = hns_mac_reg_read64(drv, XGMAC_TX_TOTAL_PKTS);\r\nhw_stats->tx_total_bytes\r\n= hns_mac_reg_read64(drv, XGMAC_TX_TOTALOCTETS);\r\nhw_stats->tx_uc_pkts = hns_mac_reg_read64(drv, XGMAC_TX_UNICASTPKTS);\r\nhw_stats->tx_mc_pkts = hns_mac_reg_read64(drv, XGMAC_TX_MULTICASTPKTS);\r\nhw_stats->tx_bc_pkts = hns_mac_reg_read64(drv, XGMAC_TX_BROADCASTPKTS);\r\nhw_stats->tx_pfc_tc0 = hns_mac_reg_read64(drv, XGMAC_TX_PRI0PAUSEPKTS);\r\nhw_stats->tx_pfc_tc1 = hns_mac_reg_read64(drv, XGMAC_TX_PRI1PAUSEPKTS);\r\nhw_stats->tx_pfc_tc2 = hns_mac_reg_read64(drv, XGMAC_TX_PRI2PAUSEPKTS);\r\nhw_stats->tx_pfc_tc3 = hns_mac_reg_read64(drv, XGMAC_TX_PRI3PAUSEPKTS);\r\nhw_stats->tx_pfc_tc4 = hns_mac_reg_read64(drv, XGMAC_TX_PRI4PAUSEPKTS);\r\nhw_stats->tx_pfc_tc5 = hns_mac_reg_read64(drv, XGMAC_TX_PRI5PAUSEPKTS);\r\nhw_stats->tx_pfc_tc6 = hns_mac_reg_read64(drv, XGMAC_TX_PRI6PAUSEPKTS);\r\nhw_stats->tx_pfc_tc7 = hns_mac_reg_read64(drv, XGMAC_TX_PRI7PAUSEPKTS);\r\nhw_stats->tx_ctrl = hns_mac_reg_read64(drv, XGMAC_TX_MACCTRLPKTS);\r\nhw_stats->tx_1731_pkts = hns_mac_reg_read64(drv, XGMAC_TX_1731PKTS);\r\nhw_stats->tx_1588_pkts = hns_mac_reg_read64(drv, XGMAC_TX_1588PKTS);\r\nhw_stats->rx_good_from_sw\r\n= hns_mac_reg_read64(drv, XGMAC_RX_FROMAPPGOODPKTS);\r\nhw_stats->rx_bad_from_sw\r\n= hns_mac_reg_read64(drv, XGMAC_RX_FROMAPPBADPKTS);\r\nhw_stats->tx_bad_pkts = hns_mac_reg_read64(drv, XGMAC_TX_ERRALLPKTS);\r\nhw_stats->rx_fragment_err\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_FRAGMENT);\r\nhw_stats->rx_undersize\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTSUNDERSIZE);\r\nhw_stats->rx_under_min\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_UNDERMIN);\r\nhw_stats->rx_64bytes = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_64OCTETS);\r\nhw_stats->rx_65to127\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_65TO127OCTETS);\r\nhw_stats->rx_128to255\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_128TO255OCTETS);\r\nhw_stats->rx_256to511\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_256TO511OCTETS);\r\nhw_stats->rx_512to1023\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_512TO1023OCTETS);\r\nhw_stats->rx_1024to1518\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1024TO1518OCTETS);\r\nhw_stats->rx_1519tomax\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1519TOMAXOCTETS);\r\nhw_stats->rx_1519tomax_good\r\n= hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1519TOMAXOCTETSOK);\r\nhw_stats->rx_oversize = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_OVERSIZE);\r\nhw_stats->rx_jabber_err = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_JABBER);\r\nhw_stats->rx_good_pkts = hns_mac_reg_read64(drv, XGMAC_RX_GOODPKTS);\r\nhw_stats->rx_good_bytes = hns_mac_reg_read64(drv, XGMAC_RX_GOODOCTETS);\r\nhw_stats->rx_total_pkts = hns_mac_reg_read64(drv, XGMAC_RX_TOTAL_PKTS);\r\nhw_stats->rx_total_bytes\r\n= hns_mac_reg_read64(drv, XGMAC_RX_TOTALOCTETS);\r\nhw_stats->rx_uc_pkts = hns_mac_reg_read64(drv, XGMAC_RX_UNICASTPKTS);\r\nhw_stats->rx_mc_pkts = hns_mac_reg_read64(drv, XGMAC_RX_MULTICASTPKTS);\r\nhw_stats->rx_bc_pkts = hns_mac_reg_read64(drv, XGMAC_RX_BROADCASTPKTS);\r\nhw_stats->rx_pfc_tc0 = hns_mac_reg_read64(drv, XGMAC_RX_PRI0PAUSEPKTS);\r\nhw_stats->rx_pfc_tc1 = hns_mac_reg_read64(drv, XGMAC_RX_PRI1PAUSEPKTS);\r\nhw_stats->rx_pfc_tc2 = hns_mac_reg_read64(drv, XGMAC_RX_PRI2PAUSEPKTS);\r\nhw_stats->rx_pfc_tc3 = hns_mac_reg_read64(drv, XGMAC_RX_PRI3PAUSEPKTS);\r\nhw_stats->rx_pfc_tc4 = hns_mac_reg_read64(drv, XGMAC_RX_PRI4PAUSEPKTS);\r\nhw_stats->rx_pfc_tc5 = hns_mac_reg_read64(drv, XGMAC_RX_PRI5PAUSEPKTS);\r\nhw_stats->rx_pfc_tc6 = hns_mac_reg_read64(drv, XGMAC_RX_PRI6PAUSEPKTS);\r\nhw_stats->rx_pfc_tc7 = hns_mac_reg_read64(drv, XGMAC_RX_PRI7PAUSEPKTS);\r\nhw_stats->rx_unknown_ctrl\r\n= hns_mac_reg_read64(drv, XGMAC_RX_MACCTRLPKTS);\r\nhw_stats->tx_good_to_sw\r\n= hns_mac_reg_read64(drv, XGMAC_TX_SENDAPPGOODPKTS);\r\nhw_stats->tx_bad_to_sw\r\n= hns_mac_reg_read64(drv, XGMAC_TX_SENDAPPBADPKTS);\r\nhw_stats->rx_1731_pkts = hns_mac_reg_read64(drv, XGMAC_RX_1731PKTS);\r\nhw_stats->rx_symbol_err\r\n= hns_mac_reg_read64(drv, XGMAC_RX_SYMBOLERRPKTS);\r\nhw_stats->rx_fcs_err = hns_mac_reg_read64(drv, XGMAC_RX_FCSERRPKTS);\r\n}\r\nstatic void hns_xgmac_free(void *mac_drv)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct dsaf_device *dsaf_dev\r\n= (struct dsaf_device *)dev_get_drvdata(drv->dev);\r\nu32 mac_id = drv->mac_id;\r\ndsaf_dev->misc_op->xge_srst(dsaf_dev, mac_id, 0);\r\n}\r\nstatic void hns_xgmac_get_info(void *mac_drv, struct mac_info *mac_info)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 pause_time, pause_ctrl, port_mode, ctrl_val;\r\nctrl_val = dsaf_read_dev(drv, XGMAC_MAC_CONTROL_REG);\r\nmac_info->pad_and_crc_en = dsaf_get_bit(ctrl_val, XGMAC_CTL_TX_PAD_B);\r\nmac_info->auto_neg = 0;\r\npause_time = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_TIME_REG);\r\nmac_info->tx_pause_time = pause_time;\r\nport_mode = dsaf_read_dev(drv, XGMAC_PORT_MODE_REG);\r\nmac_info->port_en = dsaf_get_field(port_mode, XGMAC_PORT_MODE_TX_M,\r\nXGMAC_PORT_MODE_TX_S) &&\r\ndsaf_get_field(port_mode, XGMAC_PORT_MODE_RX_M,\r\nXGMAC_PORT_MODE_RX_S);\r\nmac_info->duplex = 1;\r\nmac_info->speed = MAC_SPEED_10000;\r\npause_ctrl = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_CTRL_REG);\r\nmac_info->rx_pause_en = dsaf_get_bit(pause_ctrl, XGMAC_PAUSE_CTL_RX_B);\r\nmac_info->tx_pause_en = dsaf_get_bit(pause_ctrl, XGMAC_PAUSE_CTL_TX_B);\r\n}\r\nstatic void hns_xgmac_get_pausefrm_cfg(void *mac_drv, u32 *rx_en, u32 *tx_en)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 pause_ctrl;\r\npause_ctrl = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_CTRL_REG);\r\n*rx_en = dsaf_get_bit(pause_ctrl, XGMAC_PAUSE_CTL_RX_B);\r\n*tx_en = dsaf_get_bit(pause_ctrl, XGMAC_PAUSE_CTL_TX_B);\r\n}\r\nstatic void hns_xgmac_get_link_status(void *mac_drv, u32 *link_stat)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*link_stat = dsaf_read_dev(drv, XGMAC_LINK_STATUS_REG);\r\n}\r\nstatic void hns_xgmac_get_regs(void *mac_drv, void *data)\r\n{\r\nu32 i = 0;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 *regs = data;\r\nu64 qtmp;\r\nregs[0] = dsaf_read_dev(drv, XGMAC_INT_STATUS_REG);\r\nregs[1] = dsaf_read_dev(drv, XGMAC_INT_ENABLE_REG);\r\nregs[2] = dsaf_read_dev(drv, XGMAC_INT_SET_REG);\r\nregs[3] = dsaf_read_dev(drv, XGMAC_IERR_U_INFO_REG);\r\nregs[4] = dsaf_read_dev(drv, XGMAC_OVF_INFO_REG);\r\nregs[5] = dsaf_read_dev(drv, XGMAC_OVF_CNT_REG);\r\nregs[6] = dsaf_read_dev(drv, XGMAC_PORT_MODE_REG);\r\nregs[7] = dsaf_read_dev(drv, XGMAC_CLK_ENABLE_REG);\r\nregs[8] = dsaf_read_dev(drv, XGMAC_RESET_REG);\r\nregs[9] = dsaf_read_dev(drv, XGMAC_LINK_CONTROL_REG);\r\nregs[10] = dsaf_read_dev(drv, XGMAC_LINK_STATUS_REG);\r\nregs[11] = dsaf_read_dev(drv, XGMAC_SPARE_REG);\r\nregs[12] = dsaf_read_dev(drv, XGMAC_SPARE_CNT_REG);\r\nregs[13] = dsaf_read_dev(drv, XGMAC_MAC_ENABLE_REG);\r\nregs[14] = dsaf_read_dev(drv, XGMAC_MAC_CONTROL_REG);\r\nregs[15] = dsaf_read_dev(drv, XGMAC_MAC_IPG_REG);\r\nregs[16] = dsaf_read_dev(drv, XGMAC_MAC_MSG_CRC_EN_REG);\r\nregs[17] = dsaf_read_dev(drv, XGMAC_MAC_MSG_IMG_REG);\r\nregs[18] = dsaf_read_dev(drv, XGMAC_MAC_MSG_FC_CFG_REG);\r\nregs[19] = dsaf_read_dev(drv, XGMAC_MAC_MSG_TC_CFG_REG);\r\nregs[20] = dsaf_read_dev(drv, XGMAC_MAC_PAD_SIZE_REG);\r\nregs[21] = dsaf_read_dev(drv, XGMAC_MAC_MIN_PKT_SIZE_REG);\r\nregs[22] = dsaf_read_dev(drv, XGMAC_MAC_MAX_PKT_SIZE_REG);\r\nregs[23] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_CTRL_REG);\r\nregs[24] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_TIME_REG);\r\nregs[25] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_GAP_REG);\r\nregs[26] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_LOCAL_MAC_H_REG);\r\nregs[27] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_LOCAL_MAC_L_REG);\r\nregs[28] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_PEER_MAC_H_REG);\r\nregs[29] = dsaf_read_dev(drv, XGMAC_MAC_PAUSE_PEER_MAC_L_REG);\r\nregs[30] = dsaf_read_dev(drv, XGMAC_MAC_PFC_PRI_EN_REG);\r\nregs[31] = dsaf_read_dev(drv, XGMAC_MAC_1588_CTRL_REG);\r\nregs[32] = dsaf_read_dev(drv, XGMAC_MAC_1588_TX_PORT_DLY_REG);\r\nregs[33] = dsaf_read_dev(drv, XGMAC_MAC_1588_RX_PORT_DLY_REG);\r\nregs[34] = dsaf_read_dev(drv, XGMAC_MAC_1588_ASYM_DLY_REG);\r\nregs[35] = dsaf_read_dev(drv, XGMAC_MAC_1588_ADJUST_CFG_REG);\r\nregs[36] = dsaf_read_dev(drv, XGMAC_MAC_Y1731_ETH_TYPE_REG);\r\nregs[37] = dsaf_read_dev(drv, XGMAC_MAC_MIB_CONTROL_REG);\r\nregs[38] = dsaf_read_dev(drv, XGMAC_MAC_WAN_RATE_ADJUST_REG);\r\nregs[39] = dsaf_read_dev(drv, XGMAC_MAC_TX_ERR_MARK_REG);\r\nregs[40] = dsaf_read_dev(drv, XGMAC_MAC_TX_LF_RF_CONTROL_REG);\r\nregs[41] = dsaf_read_dev(drv, XGMAC_MAC_RX_LF_RF_STATUS_REG);\r\nregs[42] = dsaf_read_dev(drv, XGMAC_MAC_TX_RUNT_PKT_CNT_REG);\r\nregs[43] = dsaf_read_dev(drv, XGMAC_MAC_RX_RUNT_PKT_CNT_REG);\r\nregs[44] = dsaf_read_dev(drv, XGMAC_MAC_RX_PREAM_ERR_PKT_CNT_REG);\r\nregs[45] = dsaf_read_dev(drv, XGMAC_MAC_TX_LF_RF_TERM_PKT_CNT_REG);\r\nregs[46] = dsaf_read_dev(drv, XGMAC_MAC_TX_SN_MISMATCH_PKT_CNT_REG);\r\nregs[47] = dsaf_read_dev(drv, XGMAC_MAC_RX_ERR_MSG_CNT_REG);\r\nregs[48] = dsaf_read_dev(drv, XGMAC_MAC_RX_ERR_EFD_CNT_REG);\r\nregs[49] = dsaf_read_dev(drv, XGMAC_MAC_ERR_INFO_REG);\r\nregs[50] = dsaf_read_dev(drv, XGMAC_MAC_DBG_INFO_REG);\r\nregs[51] = dsaf_read_dev(drv, XGMAC_PCS_BASER_SYNC_THD_REG);\r\nregs[52] = dsaf_read_dev(drv, XGMAC_PCS_STATUS1_REG);\r\nregs[53] = dsaf_read_dev(drv, XGMAC_PCS_BASER_STATUS1_REG);\r\nregs[54] = dsaf_read_dev(drv, XGMAC_PCS_BASER_STATUS2_REG);\r\nregs[55] = dsaf_read_dev(drv, XGMAC_PCS_BASER_SEEDA_0_REG);\r\nregs[56] = dsaf_read_dev(drv, XGMAC_PCS_BASER_SEEDA_1_REG);\r\nregs[57] = dsaf_read_dev(drv, XGMAC_PCS_BASER_SEEDB_0_REG);\r\nregs[58] = dsaf_read_dev(drv, XGMAC_PCS_BASER_SEEDB_1_REG);\r\nregs[59] = dsaf_read_dev(drv, XGMAC_PCS_BASER_TEST_CONTROL_REG);\r\nregs[60] = dsaf_read_dev(drv, XGMAC_PCS_BASER_TEST_ERR_CNT_REG);\r\nregs[61] = dsaf_read_dev(drv, XGMAC_PCS_DBG_INFO_REG);\r\nregs[62] = dsaf_read_dev(drv, XGMAC_PCS_DBG_INFO1_REG);\r\nregs[63] = dsaf_read_dev(drv, XGMAC_PCS_DBG_INFO2_REG);\r\nregs[64] = dsaf_read_dev(drv, XGMAC_PCS_DBG_INFO3_REG);\r\nregs[65] = dsaf_read_dev(drv, XGMAC_PMA_ENABLE_REG);\r\nregs[66] = dsaf_read_dev(drv, XGMAC_PMA_CONTROL_REG);\r\nregs[67] = dsaf_read_dev(drv, XGMAC_PMA_SIGNAL_STATUS_REG);\r\nregs[68] = dsaf_read_dev(drv, XGMAC_PMA_DBG_INFO_REG);\r\nregs[69] = dsaf_read_dev(drv, XGMAC_PMA_FEC_ABILITY_REG);\r\nregs[70] = dsaf_read_dev(drv, XGMAC_PMA_FEC_CONTROL_REG);\r\nregs[71] = dsaf_read_dev(drv, XGMAC_PMA_FEC_CORR_BLOCK_CNT__REG);\r\nregs[72] = dsaf_read_dev(drv, XGMAC_PMA_FEC_UNCORR_BLOCK_CNT__REG);\r\n#define hns_xgmac_cpy_q(p, q) \\r\ndo {\\r\n*(p) = (u32)(q);\\r\n*((p) + 1) = (u32)((q) >> 32);\\r\n} while (0)\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_FRAGMENT);\r\nhns_xgmac_cpy_q(&regs[73], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_UNDERSIZE);\r\nhns_xgmac_cpy_q(&regs[75], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_UNDERMIN);\r\nhns_xgmac_cpy_q(&regs[77], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_64OCTETS);\r\nhns_xgmac_cpy_q(&regs[79], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_65TO127OCTETS);\r\nhns_xgmac_cpy_q(&regs[81], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_128TO255OCTETS);\r\nhns_xgmac_cpy_q(&regs[83], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_256TO511OCTETS);\r\nhns_xgmac_cpy_q(&regs[85], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_512TO1023OCTETS);\r\nhns_xgmac_cpy_q(&regs[87], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1024TO1518OCTETS);\r\nhns_xgmac_cpy_q(&regs[89], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1519TOMAXOCTETS);\r\nhns_xgmac_cpy_q(&regs[91], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_1519TOMAXOCTETSOK);\r\nhns_xgmac_cpy_q(&regs[93], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_OVERSIZE);\r\nhns_xgmac_cpy_q(&regs[95], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PKTS_JABBER);\r\nhns_xgmac_cpy_q(&regs[97], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_GOODPKTS);\r\nhns_xgmac_cpy_q(&regs[99], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_GOODOCTETS);\r\nhns_xgmac_cpy_q(&regs[101], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_TOTAL_PKTS);\r\nhns_xgmac_cpy_q(&regs[103], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_TOTALOCTETS);\r\nhns_xgmac_cpy_q(&regs[105], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_UNICASTPKTS);\r\nhns_xgmac_cpy_q(&regs[107], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_MULTICASTPKTS);\r\nhns_xgmac_cpy_q(&regs[109], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_BROADCASTPKTS);\r\nhns_xgmac_cpy_q(&regs[111], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI0PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[113], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI1PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[115], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI2PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[117], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI3PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[119], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI4PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[121], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI5PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[123], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI6PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[125], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_PRI7PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[127], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_MACCTRLPKTS);\r\nhns_xgmac_cpy_q(&regs[129], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_1731PKTS);\r\nhns_xgmac_cpy_q(&regs[131], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_1588PKTS);\r\nhns_xgmac_cpy_q(&regs[133], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_FROMAPPGOODPKTS);\r\nhns_xgmac_cpy_q(&regs[135], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_FROMAPPBADPKTS);\r\nhns_xgmac_cpy_q(&regs[137], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_ERRALLPKTS);\r\nhns_xgmac_cpy_q(&regs[139], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_FRAGMENT);\r\nhns_xgmac_cpy_q(&regs[141], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTSUNDERSIZE);\r\nhns_xgmac_cpy_q(&regs[143], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_UNDERMIN);\r\nhns_xgmac_cpy_q(&regs[145], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_64OCTETS);\r\nhns_xgmac_cpy_q(&regs[147], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_65TO127OCTETS);\r\nhns_xgmac_cpy_q(&regs[149], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_128TO255OCTETS);\r\nhns_xgmac_cpy_q(&regs[151], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_256TO511OCTETS);\r\nhns_xgmac_cpy_q(&regs[153], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_512TO1023OCTETS);\r\nhns_xgmac_cpy_q(&regs[155], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1024TO1518OCTETS);\r\nhns_xgmac_cpy_q(&regs[157], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1519TOMAXOCTETS);\r\nhns_xgmac_cpy_q(&regs[159], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_1519TOMAXOCTETSOK);\r\nhns_xgmac_cpy_q(&regs[161], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_OVERSIZE);\r\nhns_xgmac_cpy_q(&regs[163], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PKTS_JABBER);\r\nhns_xgmac_cpy_q(&regs[165], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_GOODPKTS);\r\nhns_xgmac_cpy_q(&regs[167], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_GOODOCTETS);\r\nhns_xgmac_cpy_q(&regs[169], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_TOTAL_PKTS);\r\nhns_xgmac_cpy_q(&regs[171], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_TOTALOCTETS);\r\nhns_xgmac_cpy_q(&regs[173], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_UNICASTPKTS);\r\nhns_xgmac_cpy_q(&regs[175], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_MULTICASTPKTS);\r\nhns_xgmac_cpy_q(&regs[177], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_BROADCASTPKTS);\r\nhns_xgmac_cpy_q(&regs[179], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI0PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[181], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI1PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[183], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI2PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[185], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI3PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[187], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI4PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[189], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI5PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[191], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI6PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[193], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_PRI7PAUSEPKTS);\r\nhns_xgmac_cpy_q(&regs[195], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_MACCTRLPKTS);\r\nhns_xgmac_cpy_q(&regs[197], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_SENDAPPGOODPKTS);\r\nhns_xgmac_cpy_q(&regs[199], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_TX_SENDAPPBADPKTS);\r\nhns_xgmac_cpy_q(&regs[201], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_1731PKTS);\r\nhns_xgmac_cpy_q(&regs[203], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_SYMBOLERRPKTS);\r\nhns_xgmac_cpy_q(&regs[205], qtmp);\r\nqtmp = hns_mac_reg_read64(drv, XGMAC_RX_FCSERRPKTS);\r\nhns_xgmac_cpy_q(&regs[207], qtmp);\r\nfor (i = 208; i < 214; i++)\r\nregs[i] = 0xaaaaaaaa;\r\n}\r\nstatic void hns_xgmac_get_stats(void *mac_drv, u64 *data)\r\n{\r\nu32 i;\r\nu64 *buf = data;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct mac_hw_stats *hw_stats = NULL;\r\nhw_stats = &drv->mac_cb->hw_stats;\r\nfor (i = 0; i < ARRAY_SIZE(g_xgmac_stats_string); i++) {\r\nbuf[i] = DSAF_STATS_READ(hw_stats,\r\ng_xgmac_stats_string[i].offset);\r\n}\r\n}\r\nstatic void hns_xgmac_get_strings(u32 stringset, u8 *data)\r\n{\r\nchar *buff = (char *)data;\r\nu32 i;\r\nif (stringset != ETH_SS_STATS)\r\nreturn;\r\nfor (i = 0; i < ARRAY_SIZE(g_xgmac_stats_string); i++) {\r\nsnprintf(buff, ETH_GSTRING_LEN, g_xgmac_stats_string[i].desc);\r\nbuff = buff + ETH_GSTRING_LEN;\r\n}\r\n}\r\nstatic int hns_xgmac_get_sset_count(int stringset)\r\n{\r\nif (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)\r\nreturn ARRAY_SIZE(g_xgmac_stats_string);\r\nreturn 0;\r\n}\r\nstatic int hns_xgmac_get_regs_count(void)\r\n{\r\nreturn HNS_XGMAC_DUMP_NUM;\r\n}\r\nvoid *hns_xgmac_config(struct hns_mac_cb *mac_cb, struct mac_params *mac_param)\r\n{\r\nstruct mac_driver *mac_drv;\r\nmac_drv = devm_kzalloc(mac_cb->dev, sizeof(*mac_drv), GFP_KERNEL);\r\nif (!mac_drv)\r\nreturn NULL;\r\nmac_drv->mac_init = hns_xgmac_init;\r\nmac_drv->mac_enable = hns_xgmac_enable;\r\nmac_drv->mac_disable = hns_xgmac_disable;\r\nmac_drv->mac_id = mac_param->mac_id;\r\nmac_drv->mac_mode = mac_param->mac_mode;\r\nmac_drv->io_base = mac_param->vaddr;\r\nmac_drv->dev = mac_param->dev;\r\nmac_drv->mac_cb = mac_cb;\r\nmac_drv->set_mac_addr = hns_xgmac_set_pausefrm_mac_addr;\r\nmac_drv->set_an_mode = NULL;\r\nmac_drv->config_loopback = NULL;\r\nmac_drv->config_pad_and_crc = hns_xgmac_config_pad_and_crc;\r\nmac_drv->config_half_duplex = NULL;\r\nmac_drv->set_rx_ignore_pause_frames =\r\nhns_xgmac_set_rx_ignore_pause_frames;\r\nmac_drv->mac_free = hns_xgmac_free;\r\nmac_drv->adjust_link = NULL;\r\nmac_drv->set_tx_auto_pause_frames = hns_xgmac_set_tx_auto_pause_frames;\r\nmac_drv->config_max_frame_length = hns_xgmac_config_max_frame_length;\r\nmac_drv->mac_pausefrm_cfg = hns_xgmac_pausefrm_cfg;\r\nmac_drv->autoneg_stat = NULL;\r\nmac_drv->get_info = hns_xgmac_get_info;\r\nmac_drv->get_pause_enable = hns_xgmac_get_pausefrm_cfg;\r\nmac_drv->get_link_status = hns_xgmac_get_link_status;\r\nmac_drv->get_regs = hns_xgmac_get_regs;\r\nmac_drv->get_ethtool_stats = hns_xgmac_get_stats;\r\nmac_drv->get_sset_count = hns_xgmac_get_sset_count;\r\nmac_drv->get_regs_count = hns_xgmac_get_regs_count;\r\nmac_drv->get_strings = hns_xgmac_get_strings;\r\nmac_drv->update_stats = hns_xgmac_update_stats;\r\nreturn (void *)mac_drv;\r\n}

static int\r\nath10k_thermal_get_max_throttle_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\n*state = ATH10K_THERMAL_THROTTLE_MAX;\r\nreturn 0;\r\n}\r\nstatic int\r\nath10k_thermal_get_cur_throttle_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct ath10k *ar = cdev->devdata;\r\nmutex_lock(&ar->conf_mutex);\r\n*state = ar->thermal.throttle_state;\r\nmutex_unlock(&ar->conf_mutex);\r\nreturn 0;\r\n}\r\nstatic int\r\nath10k_thermal_set_cur_throttle_state(struct thermal_cooling_device *cdev,\r\nunsigned long throttle_state)\r\n{\r\nstruct ath10k *ar = cdev->devdata;\r\nif (throttle_state > ATH10K_THERMAL_THROTTLE_MAX) {\r\nath10k_warn(ar, "throttle state %ld is exceeding the limit %d\n",\r\nthrottle_state, ATH10K_THERMAL_THROTTLE_MAX);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&ar->conf_mutex);\r\nar->thermal.throttle_state = throttle_state;\r\nath10k_thermal_set_throttling(ar);\r\nmutex_unlock(&ar->conf_mutex);\r\nreturn 0;\r\n}\r\nstatic ssize_t ath10k_thermal_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct ath10k *ar = dev_get_drvdata(dev);\r\nint ret, temperature;\r\nunsigned long time_left;\r\nmutex_lock(&ar->conf_mutex);\r\nif (ar->state != ATH10K_STATE_ON) {\r\nret = -ENETDOWN;\r\ngoto out;\r\n}\r\nreinit_completion(&ar->thermal.wmi_sync);\r\nret = ath10k_wmi_pdev_get_temperature(ar);\r\nif (ret) {\r\nath10k_warn(ar, "failed to read temperature %d\n", ret);\r\ngoto out;\r\n}\r\nif (test_bit(ATH10K_FLAG_CRASH_FLUSH, &ar->dev_flags)) {\r\nret = -ESHUTDOWN;\r\ngoto out;\r\n}\r\ntime_left = wait_for_completion_timeout(&ar->thermal.wmi_sync,\r\nATH10K_THERMAL_SYNC_TIMEOUT_HZ);\r\nif (!time_left) {\r\nath10k_warn(ar, "failed to synchronize thermal read\n");\r\nret = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nspin_lock_bh(&ar->data_lock);\r\ntemperature = ar->thermal.temperature;\r\nspin_unlock_bh(&ar->data_lock);\r\nret = snprintf(buf, PAGE_SIZE, "%d\n", temperature * 1000);\r\nout:\r\nmutex_unlock(&ar->conf_mutex);\r\nreturn ret;\r\n}\r\nvoid ath10k_thermal_event_temperature(struct ath10k *ar, int temperature)\r\n{\r\nspin_lock_bh(&ar->data_lock);\r\nar->thermal.temperature = temperature;\r\nspin_unlock_bh(&ar->data_lock);\r\ncomplete(&ar->thermal.wmi_sync);\r\n}\r\nvoid ath10k_thermal_set_throttling(struct ath10k *ar)\r\n{\r\nu32 period, duration, enabled;\r\nint ret;\r\nlockdep_assert_held(&ar->conf_mutex);\r\nif (!ar->wmi.ops->gen_pdev_set_quiet_mode)\r\nreturn;\r\nif (ar->state != ATH10K_STATE_ON)\r\nreturn;\r\nperiod = ar->thermal.quiet_period;\r\nduration = (period * ar->thermal.throttle_state) / 100;\r\nenabled = duration ? 1 : 0;\r\nret = ath10k_wmi_pdev_set_quiet_mode(ar, period, duration,\r\nATH10K_QUIET_START_OFFSET,\r\nenabled);\r\nif (ret) {\r\nath10k_warn(ar, "failed to set quiet mode period %u duarion %u enabled %u ret %d\n",\r\nperiod, duration, enabled, ret);\r\n}\r\n}\r\nint ath10k_thermal_register(struct ath10k *ar)\r\n{\r\nstruct thermal_cooling_device *cdev;\r\nstruct device *hwmon_dev;\r\nint ret;\r\ncdev = thermal_cooling_device_register("ath10k_thermal", ar,\r\n&ath10k_thermal_ops);\r\nif (IS_ERR(cdev)) {\r\nath10k_err(ar, "failed to setup thermal device result: %ld\n",\r\nPTR_ERR(cdev));\r\nreturn -EINVAL;\r\n}\r\nret = sysfs_create_link(&ar->dev->kobj, &cdev->device.kobj,\r\n"cooling_device");\r\nif (ret) {\r\nath10k_err(ar, "failed to create cooling device symlink\n");\r\ngoto err_cooling_destroy;\r\n}\r\nar->thermal.cdev = cdev;\r\nar->thermal.quiet_period = ATH10K_QUIET_PERIOD_DEFAULT;\r\nif (!(ar->wmi.ops->gen_pdev_get_temperature))\r\nreturn 0;\r\nif (!IS_REACHABLE(CONFIG_HWMON))\r\nreturn 0;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(ar->dev,\r\n"ath10k_hwmon", ar,\r\nath10k_hwmon_groups);\r\nif (IS_ERR(hwmon_dev)) {\r\nath10k_err(ar, "failed to register hwmon device: %ld\n",\r\nPTR_ERR(hwmon_dev));\r\nret = -EINVAL;\r\ngoto err_remove_link;\r\n}\r\nreturn 0;\r\nerr_remove_link:\r\nsysfs_remove_link(&ar->dev->kobj, "cooling_device");\r\nerr_cooling_destroy:\r\nthermal_cooling_device_unregister(cdev);\r\nreturn ret;\r\n}\r\nvoid ath10k_thermal_unregister(struct ath10k *ar)\r\n{\r\nsysfs_remove_link(&ar->dev->kobj, "cooling_device");\r\nthermal_cooling_device_unregister(ar->thermal.cdev);\r\n}

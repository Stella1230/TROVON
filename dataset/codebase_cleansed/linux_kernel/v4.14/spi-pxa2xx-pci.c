static bool lpss_dma_filter(struct dma_chan *chan, void *param)\r\n{\r\nstruct dw_dma_slave *dws = param;\r\nif (dws->dma_dev != chan->device->dev)\r\nreturn false;\r\nchan->private = dws;\r\nreturn true;\r\n}\r\nstatic int lpss_spi_setup(struct pci_dev *dev, struct pxa_spi_info *c)\r\n{\r\nstruct pci_dev *dma_dev;\r\nc->num_chipselect = 1;\r\nc->max_clk_rate = 50000000;\r\ndma_dev = pci_get_slot(dev->bus, PCI_DEVFN(PCI_SLOT(dev->devfn), 0));\r\nif (c->tx_param) {\r\nstruct dw_dma_slave *slave = c->tx_param;\r\nslave->dma_dev = &dma_dev->dev;\r\nslave->m_master = 0;\r\nslave->p_master = 1;\r\n}\r\nif (c->rx_param) {\r\nstruct dw_dma_slave *slave = c->rx_param;\r\nslave->dma_dev = &dma_dev->dev;\r\nslave->m_master = 0;\r\nslave->p_master = 1;\r\n}\r\nc->dma_filter = lpss_dma_filter;\r\nreturn 0;\r\n}\r\nstatic int mrfld_spi_setup(struct pci_dev *dev, struct pxa_spi_info *c)\r\n{\r\nstruct pci_dev *dma_dev = pci_get_slot(dev->bus, PCI_DEVFN(21, 0));\r\nstruct dw_dma_slave *tx, *rx;\r\nswitch (PCI_FUNC(dev->devfn)) {\r\ncase 0:\r\nc->port_id = 3;\r\nc->num_chipselect = 1;\r\nc->tx_param = &mrfld3_tx_param;\r\nc->rx_param = &mrfld3_rx_param;\r\nbreak;\r\ncase 1:\r\nc->port_id = 5;\r\nc->num_chipselect = 4;\r\nc->tx_param = &mrfld5_tx_param;\r\nc->rx_param = &mrfld5_rx_param;\r\nbreak;\r\ncase 2:\r\nc->port_id = 6;\r\nc->num_chipselect = 1;\r\nc->tx_param = &mrfld6_tx_param;\r\nc->rx_param = &mrfld6_rx_param;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\ntx = c->tx_param;\r\ntx->dma_dev = &dma_dev->dev;\r\nrx = c->rx_param;\r\nrx->dma_dev = &dma_dev->dev;\r\nc->dma_filter = lpss_dma_filter;\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_spi_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct platform_device_info pi;\r\nint ret;\r\nstruct platform_device *pdev;\r\nstruct pxa2xx_spi_master spi_pdata;\r\nstruct ssp_device *ssp;\r\nstruct pxa_spi_info *c;\r\nchar buf[40];\r\nret = pcim_enable_device(dev);\r\nif (ret)\r\nreturn ret;\r\nret = pcim_iomap_regions(dev, 1 << 0, "PXA2xx SPI");\r\nif (ret)\r\nreturn ret;\r\nc = &spi_info_configs[ent->driver_data];\r\nif (c->setup) {\r\nret = c->setup(dev, c);\r\nif (ret)\r\nreturn ret;\r\n}\r\nmemset(&spi_pdata, 0, sizeof(spi_pdata));\r\nspi_pdata.num_chipselect = (c->num_chipselect > 0) ? c->num_chipselect : dev->devfn;\r\nspi_pdata.dma_filter = c->dma_filter;\r\nspi_pdata.tx_param = c->tx_param;\r\nspi_pdata.rx_param = c->rx_param;\r\nspi_pdata.enable_dma = c->rx_param && c->tx_param;\r\nssp = &spi_pdata.ssp;\r\nssp->phys_base = pci_resource_start(dev, 0);\r\nssp->mmio_base = pcim_iomap_table(dev)[0];\r\nssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;\r\nssp->type = c->type;\r\npci_set_master(dev);\r\nret = pci_alloc_irq_vectors(dev, 1, 1, PCI_IRQ_ALL_TYPES);\r\nif (ret < 0)\r\nreturn ret;\r\nssp->irq = pci_irq_vector(dev, 0);\r\nsnprintf(buf, sizeof(buf), "pxa2xx-spi.%d", ssp->port_id);\r\nssp->clk = clk_register_fixed_rate(&dev->dev, buf , NULL, 0,\r\nc->max_clk_rate);\r\nif (IS_ERR(ssp->clk))\r\nreturn PTR_ERR(ssp->clk);\r\nmemset(&pi, 0, sizeof(pi));\r\npi.fwnode = dev->dev.fwnode;\r\npi.parent = &dev->dev;\r\npi.name = "pxa2xx-spi";\r\npi.id = ssp->port_id;\r\npi.data = &spi_pdata;\r\npi.size_data = sizeof(spi_pdata);\r\npdev = platform_device_register_full(&pi);\r\nif (IS_ERR(pdev)) {\r\nclk_unregister(ssp->clk);\r\nreturn PTR_ERR(pdev);\r\n}\r\npci_set_drvdata(dev, pdev);\r\nreturn 0;\r\n}\r\nstatic void pxa2xx_spi_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct platform_device *pdev = pci_get_drvdata(dev);\r\nstruct pxa2xx_spi_master *spi_pdata;\r\nspi_pdata = dev_get_platdata(&pdev->dev);\r\nplatform_device_unregister(pdev);\r\nclk_unregister(spi_pdata->ssp.clk);\r\n}

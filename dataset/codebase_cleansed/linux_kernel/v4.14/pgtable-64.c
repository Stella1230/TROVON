void pgd_init(unsigned long page)\r\n{\r\nunsigned long *p, *end;\r\nunsigned long entry;\r\n#if !defined(__PAGETABLE_PUD_FOLDED)\r\nentry = (unsigned long)invalid_pud_table;\r\n#elif !defined(__PAGETABLE_PMD_FOLDED)\r\nentry = (unsigned long)invalid_pmd_table;\r\n#else\r\nentry = (unsigned long)invalid_pte_table;\r\n#endif\r\np = (unsigned long *) page;\r\nend = p + PTRS_PER_PGD;\r\ndo {\r\np[0] = entry;\r\np[1] = entry;\r\np[2] = entry;\r\np[3] = entry;\r\np[4] = entry;\r\np += 8;\r\np[-3] = entry;\r\np[-2] = entry;\r\np[-1] = entry;\r\n} while (p != end);\r\n}\r\nvoid pmd_init(unsigned long addr, unsigned long pagetable)\r\n{\r\nunsigned long *p, *end;\r\np = (unsigned long *) addr;\r\nend = p + PTRS_PER_PMD;\r\ndo {\r\np[0] = pagetable;\r\np[1] = pagetable;\r\np[2] = pagetable;\r\np[3] = pagetable;\r\np[4] = pagetable;\r\np += 8;\r\np[-3] = pagetable;\r\np[-2] = pagetable;\r\np[-1] = pagetable;\r\n} while (p != end);\r\n}\r\nvoid pud_init(unsigned long addr, unsigned long pagetable)\r\n{\r\nunsigned long *p, *end;\r\np = (unsigned long *)addr;\r\nend = p + PTRS_PER_PUD;\r\ndo {\r\np[0] = pagetable;\r\np[1] = pagetable;\r\np[2] = pagetable;\r\np[3] = pagetable;\r\np[4] = pagetable;\r\np += 8;\r\np[-3] = pagetable;\r\np[-2] = pagetable;\r\np[-1] = pagetable;\r\n} while (p != end);\r\n}\r\npmd_t mk_pmd(struct page *page, pgprot_t prot)\r\n{\r\npmd_t pmd;\r\npmd_val(pmd) = (page_to_pfn(page) << _PFN_SHIFT) | pgprot_val(prot);\r\nreturn pmd;\r\n}\r\nvoid set_pmd_at(struct mm_struct *mm, unsigned long addr,\r\npmd_t *pmdp, pmd_t pmd)\r\n{\r\n*pmdp = pmd;\r\nflush_tlb_all();\r\n}\r\nvoid __init pagetable_init(void)\r\n{\r\nunsigned long vaddr;\r\npgd_t *pgd_base;\r\npgd_init((unsigned long)swapper_pg_dir);\r\n#ifndef __PAGETABLE_PUD_FOLDED\r\npud_init((unsigned long)invalid_pud_table, (unsigned long)invalid_pmd_table);\r\n#endif\r\n#ifndef __PAGETABLE_PMD_FOLDED\r\npmd_init((unsigned long)invalid_pmd_table, (unsigned long)invalid_pte_table);\r\n#endif\r\npgd_base = swapper_pg_dir;\r\nvaddr = __fix_to_virt(__end_of_fixed_addresses - 1) & PMD_MASK;\r\nfixrange_init(vaddr, vaddr + FIXADDR_SIZE, pgd_base);\r\n}

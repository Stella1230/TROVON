static int pseries_rng_read(struct hwrng *rng, void *data, size_t max, bool wait)\r\n{\r\nu64 buffer[PLPAR_HCALL_BUFSIZE];\r\nint rc;\r\nrc = plpar_hcall(H_RANDOM, (unsigned long *)buffer);\r\nif (rc != H_SUCCESS) {\r\npr_err_ratelimited("H_RANDOM call failed %d\n", rc);\r\nreturn -EIO;\r\n}\r\nmemcpy(data, buffer, 8);\r\nreturn 8;\r\n}\r\nstatic unsigned long pseries_rng_get_desired_dma(struct vio_dev *vdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pseries_rng_probe(struct vio_dev *dev,\r\nconst struct vio_device_id *id)\r\n{\r\nreturn hwrng_register(&pseries_rng);\r\n}\r\nstatic int pseries_rng_remove(struct vio_dev *dev)\r\n{\r\nhwrng_unregister(&pseries_rng);\r\nreturn 0;\r\n}\r\nstatic int __init rng_init(void)\r\n{\r\npr_info("Registering IBM pSeries RNG driver\n");\r\nreturn vio_register_driver(&pseries_rng_driver);\r\n}\r\nstatic void __exit rng_exit(void)\r\n{\r\nvio_unregister_driver(&pseries_rng_driver);\r\n}

static int\r\ngk104_top_oneinit(struct nvkm_top *top)\r\n{\r\nstruct nvkm_subdev *subdev = &top->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nstruct nvkm_top_device *info = NULL;\r\nu32 data, type, inst;\r\nint i;\r\nfor (i = 0; i < 64; i++) {\r\nif (!info) {\r\nif (!(info = nvkm_top_device_new(top)))\r\nreturn -ENOMEM;\r\ntype = ~0;\r\ninst = 0;\r\n}\r\ndata = nvkm_rd32(device, 0x022700 + (i * 0x04));\r\nnvkm_trace(subdev, "%02x: %08x\n", i, data);\r\nswitch (data & 0x00000003) {\r\ncase 0x00000000:\r\ncontinue;\r\ncase 0x00000001:\r\ninst = (data & 0x3c000000) >> 26;\r\ninfo->addr = (data & 0x00fff000);\r\ninfo->fault = (data & 0x000000f8) >> 3;\r\nbreak;\r\ncase 0x00000002:\r\nif (data & 0x00000020)\r\ninfo->engine = (data & 0x3c000000) >> 26;\r\nif (data & 0x00000010)\r\ninfo->runlist = (data & 0x01e00000) >> 21;\r\nif (data & 0x00000008)\r\ninfo->intr = (data & 0x000f8000) >> 15;\r\nif (data & 0x00000004)\r\ninfo->reset = (data & 0x00003e00) >> 9;\r\nbreak;\r\ncase 0x00000003:\r\ntype = (data & 0x7ffffffc) >> 2;\r\nbreak;\r\n}\r\nif (data & 0x80000000)\r\ncontinue;\r\n#define A_(A) if (inst == 0) info->index = NVKM_ENGINE_##A\r\n#define B_(A) if (inst + NVKM_ENGINE_##A##0 < NVKM_ENGINE_##A##_LAST + 1) \\r\ninfo->index = NVKM_ENGINE_##A##0 + inst\r\nswitch (type) {\r\ncase 0x00000000: A_(GR ); break;\r\ncase 0x00000001: A_(CE0 ); break;\r\ncase 0x00000002: A_(CE1 ); break;\r\ncase 0x00000003: A_(CE2 ); break;\r\ncase 0x00000008: A_(MSPDEC); break;\r\ncase 0x00000009: A_(MSPPP ); break;\r\ncase 0x0000000a: A_(MSVLD ); break;\r\ncase 0x0000000b: A_(MSENC ); break;\r\ncase 0x0000000c: A_(VIC ); break;\r\ncase 0x0000000d: A_(SEC2 ); break;\r\ncase 0x0000000e: B_(NVENC ); break;\r\ncase 0x0000000f: A_(NVENC1); break;\r\ncase 0x00000010: A_(NVDEC ); break;\r\ncase 0x00000013: B_(CE ); break;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nnvkm_debug(subdev, "%02x.%d (%8s): addr %06x fault %2d "\r\n"engine %2d runlist %2d intr %2d "\r\n"reset %2d\n", type, inst,\r\ninfo->index == NVKM_SUBDEV_NR ? NULL :\r\nnvkm_subdev_name[info->index],\r\ninfo->addr, info->fault, info->engine, info->runlist,\r\ninfo->intr, info->reset);\r\ninfo = NULL;\r\n}\r\nreturn 0;\r\n}\r\nint\r\ngk104_top_new(struct nvkm_device *device, int index, struct nvkm_top **ptop)\r\n{\r\nreturn nvkm_top_new_(&gk104_top, device, index, ptop);\r\n}

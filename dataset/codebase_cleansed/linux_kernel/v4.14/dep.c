static void st21nfca_tx_work(struct work_struct *work)\r\n{\r\nstruct st21nfca_hci_info *info = container_of(work,\r\nstruct st21nfca_hci_info,\r\ndep_info.tx_work);\r\nstruct nfc_dev *dev;\r\nstruct sk_buff *skb;\r\nif (info) {\r\ndev = info->hdev->ndev;\r\nskb = info->dep_info.tx_pending;\r\ndevice_lock(&dev->dev);\r\nnfc_hci_send_cmd_async(info->hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_WR_XCHG_DATA, skb->data, skb->len,\r\ninfo->async_cb, info);\r\ndevice_unlock(&dev->dev);\r\nkfree_skb(skb);\r\n}\r\n}\r\nstatic void st21nfca_im_send_pdu(struct st21nfca_hci_info *info,\r\nstruct sk_buff *skb)\r\n{\r\ninfo->dep_info.tx_pending = skb;\r\nschedule_work(&info->dep_info.tx_work);\r\n}\r\nstatic int st21nfca_tm_send_atr_res(struct nfc_hci_dev *hdev,\r\nstruct st21nfca_atr_req *atr_req)\r\n{\r\nstruct st21nfca_atr_res *atr_res;\r\nstruct sk_buff *skb;\r\nsize_t gb_len;\r\nint r;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ngb_len = atr_req->length - sizeof(struct st21nfca_atr_req);\r\nskb = alloc_skb(atr_req->length + 1, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct st21nfca_atr_res));\r\natr_res = (struct st21nfca_atr_res *)skb->data;\r\nmemset(atr_res, 0, sizeof(struct st21nfca_atr_res));\r\natr_res->length = atr_req->length + 1;\r\natr_res->cmd0 = ST21NFCA_NFCIP1_RES;\r\natr_res->cmd1 = ST21NFCA_NFCIP1_ATR_RES;\r\nmemcpy(atr_res->nfcid3, atr_req->nfcid3, 6);\r\natr_res->bsi = 0x00;\r\natr_res->bri = 0x00;\r\natr_res->to = ST21NFCA_DEFAULT_TIMEOUT;\r\natr_res->ppi = ST21NFCA_LR_BITS_PAYLOAD_SIZE_254B;\r\nif (gb_len) {\r\nskb_put(skb, gb_len);\r\natr_res->ppi |= ST21NFCA_GB_BIT;\r\nmemcpy(atr_res->gbi, atr_req->gbi, gb_len);\r\nr = nfc_set_remote_general_bytes(hdev->ndev, atr_res->gbi,\r\ngb_len);\r\nif (r < 0)\r\nreturn r;\r\n}\r\ninfo->dep_info.curr_nfc_dep_pni = 0;\r\nr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_tm_recv_atr_req(struct nfc_hci_dev *hdev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st21nfca_atr_req *atr_req;\r\nsize_t gb_len;\r\nint r;\r\nskb_trim(skb, skb->len - 1);\r\nif (!skb->len) {\r\nr = -EIO;\r\ngoto exit;\r\n}\r\nif (skb->len < ST21NFCA_ATR_REQ_MIN_SIZE) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\natr_req = (struct st21nfca_atr_req *)skb->data;\r\nif (atr_req->length < sizeof(struct st21nfca_atr_req)) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nr = st21nfca_tm_send_atr_res(hdev, atr_req);\r\nif (r)\r\ngoto exit;\r\ngb_len = skb->len - sizeof(struct st21nfca_atr_req);\r\nr = nfc_tm_activated(hdev->ndev, NFC_PROTO_NFC_DEP_MASK,\r\nNFC_COMM_PASSIVE, atr_req->gbi, gb_len);\r\nif (r)\r\ngoto exit;\r\nr = 0;\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st21nfca_tm_send_psl_res(struct nfc_hci_dev *hdev,\r\nstruct st21nfca_psl_req *psl_req)\r\n{\r\nstruct st21nfca_psl_res *psl_res;\r\nstruct sk_buff *skb;\r\nu8 bitrate[2] = {0, 0};\r\nint r;\r\nskb = alloc_skb(sizeof(struct st21nfca_psl_res), GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct st21nfca_psl_res));\r\npsl_res = (struct st21nfca_psl_res *)skb->data;\r\npsl_res->length = sizeof(struct st21nfca_psl_res);\r\npsl_res->cmd0 = ST21NFCA_NFCIP1_RES;\r\npsl_res->cmd1 = ST21NFCA_NFCIP1_PSL_RES;\r\npsl_res->did = psl_req->did;\r\nr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\r\nif (r < 0)\r\ngoto error;\r\nif (ST21NFCA_PSL_REQ_SEND_SPEED(psl_req->brs) &&\r\nST21NFCA_PSL_REQ_RECV_SPEED(psl_req->brs)) {\r\nbitrate[0] = ST21NFCA_CARD_BITRATE_424;\r\nbitrate[1] = ST21NFCA_CARD_BITRATE_424;\r\n}\r\nr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_EVT_CARD_F_BITRATE, bitrate, 2);\r\nerror:\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_tm_recv_psl_req(struct nfc_hci_dev *hdev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st21nfca_psl_req *psl_req;\r\nint r;\r\nskb_trim(skb, skb->len - 1);\r\nif (!skb->len) {\r\nr = -EIO;\r\ngoto exit;\r\n}\r\npsl_req = (struct st21nfca_psl_req *)skb->data;\r\nif (skb->len < sizeof(struct st21nfca_psl_req)) {\r\nr = -EIO;\r\ngoto exit;\r\n}\r\nr = st21nfca_tm_send_psl_res(hdev, psl_req);\r\nexit:\r\nreturn r;\r\n}\r\nint st21nfca_tm_send_dep_res(struct nfc_hci_dev *hdev, struct sk_buff *skb)\r\n{\r\nint r;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.curr_nfc_dep_pni;\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_RES;\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_RES;\r\n*(u8 *)skb_push(skb, 1) = skb->len;\r\nr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_tm_recv_dep_req(struct nfc_hci_dev *hdev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st21nfca_dep_req_res *dep_req;\r\nu8 size;\r\nint r;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nskb_trim(skb, skb->len - 1);\r\nsize = 4;\r\ndep_req = (struct st21nfca_dep_req_res *)skb->data;\r\nif (skb->len < size) {\r\nr = -EIO;\r\ngoto exit;\r\n}\r\nif (ST21NFCA_NFC_DEP_DID_BIT_SET(dep_req->pfb))\r\nsize++;\r\nif (ST21NFCA_NFC_DEP_NAD_BIT_SET(dep_req->pfb))\r\nsize++;\r\nif (skb->len < size) {\r\nr = -EIO;\r\ngoto exit;\r\n}\r\nswitch (ST21NFCA_NFC_DEP_PFB_TYPE(dep_req->pfb)) {\r\ncase ST21NFCA_NFC_DEP_PFB_I_PDU:\r\ninfo->dep_info.curr_nfc_dep_pni =\r\nST21NFCA_NFC_DEP_PFB_PNI(dep_req->pfb);\r\nbreak;\r\ncase ST21NFCA_NFC_DEP_PFB_ACK_NACK_PDU:\r\npr_err("Received a ACK/NACK PDU\n");\r\nbreak;\r\ncase ST21NFCA_NFC_DEP_PFB_SUPERVISOR_PDU:\r\npr_err("Received a SUPERVISOR PDU\n");\r\nbreak;\r\n}\r\nskb_pull(skb, size);\r\nreturn nfc_tm_data_received(hdev->ndev, skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st21nfca_tm_event_send_data(struct nfc_hci_dev *hdev,\r\nstruct sk_buff *skb)\r\n{\r\nu8 cmd0, cmd1;\r\nint r;\r\ncmd0 = skb->data[1];\r\nswitch (cmd0) {\r\ncase ST21NFCA_NFCIP1_REQ:\r\ncmd1 = skb->data[2];\r\nswitch (cmd1) {\r\ncase ST21NFCA_NFCIP1_ATR_REQ:\r\nr = st21nfca_tm_recv_atr_req(hdev, skb);\r\nbreak;\r\ncase ST21NFCA_NFCIP1_PSL_REQ:\r\nr = st21nfca_tm_recv_psl_req(hdev, skb);\r\nbreak;\r\ncase ST21NFCA_NFCIP1_DEP_REQ:\r\nr = st21nfca_tm_recv_dep_req(hdev, skb);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\ndefault:\r\nreturn 1;\r\n}\r\nreturn r;\r\n}\r\nint st21nfca_dep_event_received(struct nfc_hci_dev *hdev,\r\nu8 event, struct sk_buff *skb)\r\n{\r\nint r = 0;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\npr_debug("dep event: %d\n", event);\r\nswitch (event) {\r\ncase ST21NFCA_EVT_CARD_ACTIVATED:\r\ninfo->dep_info.curr_nfc_dep_pni = 0;\r\nbreak;\r\ncase ST21NFCA_EVT_CARD_DEACTIVATED:\r\nbreak;\r\ncase ST21NFCA_EVT_FIELD_ON:\r\nbreak;\r\ncase ST21NFCA_EVT_FIELD_OFF:\r\nbreak;\r\ncase ST21NFCA_EVT_SEND_DATA:\r\nr = st21nfca_tm_event_send_data(hdev, skb);\r\nif (r < 0)\r\nreturn r;\r\nreturn 0;\r\ndefault:\r\nnfc_err(&hdev->ndev->dev, "Unexpected event on card f gate\n");\r\nreturn 1;\r\n}\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nstatic void st21nfca_im_send_psl_req(struct nfc_hci_dev *hdev, u8 did, u8 bsi,\r\nu8 bri, u8 lri)\r\n{\r\nstruct sk_buff *skb;\r\nstruct st21nfca_psl_req *psl_req;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nskb =\r\nalloc_skb(sizeof(struct st21nfca_psl_req) + 1, GFP_KERNEL);\r\nif (!skb)\r\nreturn;\r\nskb_reserve(skb, 1);\r\nskb_put(skb, sizeof(struct st21nfca_psl_req));\r\npsl_req = (struct st21nfca_psl_req *) skb->data;\r\npsl_req->length = sizeof(struct st21nfca_psl_req);\r\npsl_req->cmd0 = ST21NFCA_NFCIP1_REQ;\r\npsl_req->cmd1 = ST21NFCA_NFCIP1_PSL_REQ;\r\npsl_req->did = did;\r\npsl_req->brs = (0x30 & bsi << 4) | (bri & 0x03);\r\npsl_req->fsl = lri;\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\r\nst21nfca_im_send_pdu(info, skb);\r\n}\r\nstatic void st21nfca_im_recv_atr_res_cb(void *context, struct sk_buff *skb,\r\nint err)\r\n{\r\nstruct st21nfca_hci_info *info = context;\r\nstruct st21nfca_atr_res *atr_res;\r\nint r;\r\nif (err != 0)\r\nreturn;\r\nif (!skb)\r\nreturn;\r\nswitch (info->async_cb_type) {\r\ncase ST21NFCA_CB_TYPE_READER_F:\r\nskb_trim(skb, skb->len - 1);\r\natr_res = (struct st21nfca_atr_res *)skb->data;\r\nr = nfc_set_remote_general_bytes(info->hdev->ndev,\r\natr_res->gbi,\r\nskb->len - sizeof(struct st21nfca_atr_res));\r\nif (r < 0)\r\nreturn;\r\nif (atr_res->to >= 0x0e)\r\ninfo->dep_info.to = 0x0e;\r\nelse\r\ninfo->dep_info.to = atr_res->to + 1;\r\ninfo->dep_info.to |= 0x10;\r\nr = nfc_dep_link_is_up(info->hdev->ndev, info->dep_info.idx,\r\nNFC_COMM_PASSIVE, NFC_RF_INITIATOR);\r\nif (r < 0)\r\nreturn;\r\ninfo->dep_info.curr_nfc_dep_pni = 0;\r\nif (ST21NFCA_PP2LRI(atr_res->ppi) != info->dep_info.lri)\r\nst21nfca_im_send_psl_req(info->hdev, atr_res->did,\r\natr_res->bsi, atr_res->bri,\r\nST21NFCA_PP2LRI(atr_res->ppi));\r\nbreak;\r\ndefault:\r\nkfree_skb(skb);\r\nbreak;\r\n}\r\n}\r\nint st21nfca_im_send_atr_req(struct nfc_hci_dev *hdev, u8 *gb, size_t gb_len)\r\n{\r\nstruct sk_buff *skb;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nstruct st21nfca_atr_req *atr_req;\r\nstruct nfc_target *target;\r\nuint size;\r\ninfo->dep_info.to = ST21NFCA_DEFAULT_TIMEOUT;\r\nsize = ST21NFCA_ATR_REQ_MIN_SIZE + gb_len;\r\nif (size > ST21NFCA_ATR_REQ_MAX_SIZE) {\r\nPROTOCOL_ERR("14.6.1.1");\r\nreturn -EINVAL;\r\n}\r\nskb =\r\nalloc_skb(sizeof(struct st21nfca_atr_req) + gb_len + 1, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_reserve(skb, 1);\r\nskb_put(skb, sizeof(struct st21nfca_atr_req));\r\natr_req = (struct st21nfca_atr_req *)skb->data;\r\nmemset(atr_req, 0, sizeof(struct st21nfca_atr_req));\r\natr_req->cmd0 = ST21NFCA_NFCIP1_REQ;\r\natr_req->cmd1 = ST21NFCA_NFCIP1_ATR_REQ;\r\nmemset(atr_req->nfcid3, 0, NFC_NFCID3_MAXSIZE);\r\ntarget = hdev->ndev->targets;\r\nif (target->sensf_res_len > 0)\r\nmemcpy(atr_req->nfcid3, target->sensf_res,\r\ntarget->sensf_res_len);\r\nelse\r\nget_random_bytes(atr_req->nfcid3, NFC_NFCID3_MAXSIZE);\r\natr_req->did = 0x0;\r\natr_req->bsi = 0x00;\r\natr_req->bri = 0x00;\r\natr_req->ppi = ST21NFCA_LR_BITS_PAYLOAD_SIZE_254B;\r\nif (gb_len) {\r\natr_req->ppi |= ST21NFCA_GB_BIT;\r\nskb_put_data(skb, gb, gb_len);\r\n}\r\natr_req->length = sizeof(struct st21nfca_atr_req) + hdev->gb_len;\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\r\ninfo->async_cb_type = ST21NFCA_CB_TYPE_READER_F;\r\ninfo->async_cb_context = info;\r\ninfo->async_cb = st21nfca_im_recv_atr_res_cb;\r\ninfo->dep_info.bri = atr_req->bri;\r\ninfo->dep_info.bsi = atr_req->bsi;\r\ninfo->dep_info.lri = ST21NFCA_PP2LRI(atr_req->ppi);\r\nreturn nfc_hci_send_cmd_async(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_WR_XCHG_DATA, skb->data,\r\nskb->len, info->async_cb, info);\r\n}\r\nstatic void st21nfca_im_recv_dep_res_cb(void *context, struct sk_buff *skb,\r\nint err)\r\n{\r\nstruct st21nfca_hci_info *info = context;\r\nstruct st21nfca_dep_req_res *dep_res;\r\nint size;\r\nif (err != 0)\r\nreturn;\r\nif (!skb)\r\nreturn;\r\nswitch (info->async_cb_type) {\r\ncase ST21NFCA_CB_TYPE_READER_F:\r\ndep_res = (struct st21nfca_dep_req_res *)skb->data;\r\nsize = 3;\r\nif (skb->len < size)\r\ngoto exit;\r\nif (ST21NFCA_NFC_DEP_DID_BIT_SET(dep_res->pfb))\r\nsize++;\r\nif (ST21NFCA_NFC_DEP_NAD_BIT_SET(dep_res->pfb))\r\nsize++;\r\nif (skb->len < size)\r\ngoto exit;\r\nskb_trim(skb, skb->len - 1);\r\nswitch (ST21NFCA_NFC_DEP_PFB_TYPE(dep_res->pfb)) {\r\ncase ST21NFCA_NFC_DEP_PFB_ACK_NACK_PDU:\r\npr_err("Received a ACK/NACK PDU\n");\r\ncase ST21NFCA_NFC_DEP_PFB_I_PDU:\r\ninfo->dep_info.curr_nfc_dep_pni =\r\nST21NFCA_NFC_DEP_PFB_PNI(dep_res->pfb + 1);\r\nsize++;\r\nskb_pull(skb, size);\r\nnfc_tm_data_received(info->hdev->ndev, skb);\r\nbreak;\r\ncase ST21NFCA_NFC_DEP_PFB_SUPERVISOR_PDU:\r\npr_err("Received a SUPERVISOR PDU\n");\r\nskb_pull(skb, size);\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_REQ;\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_REQ;\r\n*(u8 *)skb_push(skb, 1) = skb->len;\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\r\nst21nfca_im_send_pdu(info, skb);\r\nbreak;\r\n}\r\nreturn;\r\ndefault:\r\nbreak;\r\n}\r\nexit:\r\nkfree_skb(skb);\r\n}\r\nint st21nfca_im_send_dep_req(struct nfc_hci_dev *hdev, struct sk_buff *skb)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ninfo->async_cb_type = ST21NFCA_CB_TYPE_READER_F;\r\ninfo->async_cb_context = info;\r\ninfo->async_cb = st21nfca_im_recv_dep_res_cb;\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.curr_nfc_dep_pni;\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_REQ;\r\n*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_REQ;\r\n*(u8 *)skb_push(skb, 1) = skb->len;\r\n*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\r\nreturn nfc_hci_send_cmd_async(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_WR_XCHG_DATA,\r\nskb->data, skb->len,\r\ninfo->async_cb, info);\r\n}\r\nvoid st21nfca_dep_init(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nINIT_WORK(&info->dep_info.tx_work, st21nfca_tx_work);\r\ninfo->dep_info.curr_nfc_dep_pni = 0;\r\ninfo->dep_info.idx = 0;\r\ninfo->dep_info.to = ST21NFCA_DEFAULT_TIMEOUT;\r\n}\r\nvoid st21nfca_dep_deinit(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ncancel_work_sync(&info->dep_info.tx_work);\r\n}

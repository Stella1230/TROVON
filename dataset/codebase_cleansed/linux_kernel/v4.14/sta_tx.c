void *mwifiex_process_sta_txpd(struct mwifiex_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nstruct txpd *local_tx_pd;\r\nstruct mwifiex_txinfo *tx_info = MWIFIEX_SKB_TXCB(skb);\r\nunsigned int pad;\r\nu16 pkt_type, pkt_offset;\r\nint hroom = adapter->intf_hdr_len;\r\nif (!skb->len) {\r\nmwifiex_dbg(adapter, ERROR,\r\n"Tx: bad packet length: %d\n", skb->len);\r\ntx_info->status_code = -1;\r\nreturn skb->data;\r\n}\r\nBUG_ON(skb_headroom(skb) < MWIFIEX_MIN_DATA_HEADER_LEN);\r\npkt_type = mwifiex_is_skb_mgmt_frame(skb) ? PKT_TYPE_MGMT : 0;\r\npad = ((void *)skb->data - (sizeof(*local_tx_pd) + hroom)-\r\nNULL) & (MWIFIEX_DMA_ALIGN_SZ - 1);\r\nskb_push(skb, sizeof(*local_tx_pd) + pad);\r\nlocal_tx_pd = (struct txpd *) skb->data;\r\nmemset(local_tx_pd, 0, sizeof(struct txpd));\r\nlocal_tx_pd->bss_num = priv->bss_num;\r\nlocal_tx_pd->bss_type = priv->bss_type;\r\nlocal_tx_pd->tx_pkt_length = cpu_to_le16((u16)(skb->len -\r\n(sizeof(struct txpd) +\r\npad)));\r\nlocal_tx_pd->priority = (u8) skb->priority;\r\nlocal_tx_pd->pkt_delay_2ms =\r\nmwifiex_wmm_compute_drv_pkt_delay(priv, skb);\r\nif (tx_info->flags & MWIFIEX_BUF_FLAG_EAPOL_TX_STATUS ||\r\ntx_info->flags & MWIFIEX_BUF_FLAG_ACTION_TX_STATUS) {\r\nlocal_tx_pd->tx_token_id = tx_info->ack_frame_id;\r\nlocal_tx_pd->flags |= MWIFIEX_TXPD_FLAGS_REQ_TX_STATUS;\r\n}\r\nif (local_tx_pd->priority <\r\nARRAY_SIZE(priv->wmm.user_pri_pkt_tx_ctrl))\r\nlocal_tx_pd->tx_control =\r\ncpu_to_le32(priv->wmm.user_pri_pkt_tx_ctrl[local_tx_pd->\r\npriority]);\r\nif (adapter->pps_uapsd_mode) {\r\nif (mwifiex_check_last_packet_indication(priv)) {\r\nadapter->tx_lock_flag = true;\r\nlocal_tx_pd->flags =\r\nMWIFIEX_TxPD_POWER_MGMT_LAST_PACKET;\r\n}\r\n}\r\nif (tx_info->flags & MWIFIEX_BUF_FLAG_TDLS_PKT)\r\nlocal_tx_pd->flags |= MWIFIEX_TXPD_FLAGS_TDLS_PACKET;\r\npkt_offset = sizeof(struct txpd) + pad;\r\nif (pkt_type == PKT_TYPE_MGMT) {\r\nlocal_tx_pd->tx_pkt_type = cpu_to_le16(pkt_type);\r\npkt_offset += MWIFIEX_MGMT_FRAME_HEADER_SIZE;\r\n}\r\nlocal_tx_pd->tx_pkt_offset = cpu_to_le16(pkt_offset);\r\nskb_push(skb, hroom);\r\nif (!local_tx_pd->tx_control)\r\nlocal_tx_pd->tx_control = cpu_to_le32(priv->pkt_tx_ctrl);\r\nreturn skb->data;\r\n}\r\nint mwifiex_send_null_packet(struct mwifiex_private *priv, u8 flags)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nstruct txpd *local_tx_pd;\r\nstruct mwifiex_tx_param tx_param;\r\n#define NULL_PACKET_HDR 64\r\nu32 data_len = NULL_PACKET_HDR;\r\nstruct sk_buff *skb;\r\nint ret;\r\nstruct mwifiex_txinfo *tx_info = NULL;\r\nif (adapter->surprise_removed)\r\nreturn -1;\r\nif (!priv->media_connected)\r\nreturn -1;\r\nif (adapter->data_sent)\r\nreturn -1;\r\nif (adapter->if_ops.is_port_ready &&\r\n!adapter->if_ops.is_port_ready(priv))\r\nreturn -1;\r\nskb = dev_alloc_skb(data_len);\r\nif (!skb)\r\nreturn -1;\r\ntx_info = MWIFIEX_SKB_TXCB(skb);\r\nmemset(tx_info, 0, sizeof(*tx_info));\r\ntx_info->bss_num = priv->bss_num;\r\ntx_info->bss_type = priv->bss_type;\r\ntx_info->pkt_len = data_len -\r\n(sizeof(struct txpd) + adapter->intf_hdr_len);\r\nskb_reserve(skb, sizeof(struct txpd) + adapter->intf_hdr_len);\r\nskb_push(skb, sizeof(struct txpd));\r\nlocal_tx_pd = (struct txpd *) skb->data;\r\nlocal_tx_pd->tx_control = cpu_to_le32(priv->pkt_tx_ctrl);\r\nlocal_tx_pd->flags = flags;\r\nlocal_tx_pd->priority = WMM_HIGHEST_PRIORITY;\r\nlocal_tx_pd->tx_pkt_offset = cpu_to_le16(sizeof(struct txpd));\r\nlocal_tx_pd->bss_num = priv->bss_num;\r\nlocal_tx_pd->bss_type = priv->bss_type;\r\nskb_push(skb, adapter->intf_hdr_len);\r\nif (adapter->iface_type == MWIFIEX_USB) {\r\nret = adapter->if_ops.host_to_card(adapter, priv->usb_port,\r\nskb, NULL);\r\n} else {\r\ntx_param.next_pkt_len = 0;\r\nret = adapter->if_ops.host_to_card(adapter, MWIFIEX_TYPE_DATA,\r\nskb, &tx_param);\r\n}\r\nswitch (ret) {\r\ncase -EBUSY:\r\ndev_kfree_skb_any(skb);\r\nmwifiex_dbg(adapter, ERROR,\r\n"%s: host_to_card failed: ret=%d\n",\r\n__func__, ret);\r\nadapter->dbg.num_tx_host_to_card_failure++;\r\nbreak;\r\ncase -1:\r\ndev_kfree_skb_any(skb);\r\nmwifiex_dbg(adapter, ERROR,\r\n"%s: host_to_card failed: ret=%d\n",\r\n__func__, ret);\r\nadapter->dbg.num_tx_host_to_card_failure++;\r\nbreak;\r\ncase 0:\r\ndev_kfree_skb_any(skb);\r\nmwifiex_dbg(adapter, DATA,\r\n"data: %s: host_to_card succeeded\n",\r\n__func__);\r\nadapter->tx_lock_flag = true;\r\nbreak;\r\ncase -EINPROGRESS:\r\nadapter->tx_lock_flag = true;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nu8\r\nmwifiex_check_last_packet_indication(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu8 ret = false;\r\nif (!adapter->sleep_period.period)\r\nreturn ret;\r\nif (mwifiex_wmm_lists_empty(adapter))\r\nret = true;\r\nif (ret && !adapter->cmd_sent && !adapter->curr_cmd &&\r\n!is_command_pending(adapter)) {\r\nadapter->delay_null_pkt = false;\r\nret = true;\r\n} else {\r\nret = false;\r\nadapter->delay_null_pkt = true;\r\n}\r\nreturn ret;\r\n}

static inline int tmp103_reg_to_mc(s8 val)\r\n{\r\nreturn val * 1000;\r\n}\r\nstatic inline u8 tmp103_mc_to_reg(int val)\r\n{\r\nreturn DIV_ROUND_CLOSEST(val, 1000);\r\n}\r\nstatic ssize_t tmp103_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sda = to_sensor_dev_attr(attr);\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nunsigned int regval;\r\nint ret;\r\nret = regmap_read(regmap, sda->index, &regval);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", tmp103_reg_to_mc(regval));\r\n}\r\nstatic ssize_t tmp103_set_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sda = to_sensor_dev_attr(attr);\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nlong val;\r\nint ret;\r\nif (kstrtol(buf, 10, &val) < 0)\r\nreturn -EINVAL;\r\nval = clamp_val(val, -55000, 127000);\r\nret = regmap_write(regmap, sda->index, tmp103_mc_to_reg(val));\r\nreturn ret ? ret : count;\r\n}\r\nstatic bool tmp103_regmap_is_volatile(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg == TMP103_TEMP_REG;\r\n}\r\nstatic int tmp103_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct device *hwmon_dev;\r\nstruct regmap *regmap;\r\nint ret;\r\nregmap = devm_regmap_init_i2c(client, &tmp103_regmap_config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(dev, "failed to allocate register map\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nret = regmap_update_bits(regmap, TMP103_CONF_REG, TMP103_CONFIG_MASK,\r\nTMP103_CONFIG);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "error writing config register\n");\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, regmap);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\nregmap, tmp103_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}\r\nstatic int __maybe_unused tmp103_suspend(struct device *dev)\r\n{\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nreturn regmap_update_bits(regmap, TMP103_CONF_REG,\r\nTMP103_CONF_SD_MASK, 0);\r\n}\r\nstatic int __maybe_unused tmp103_resume(struct device *dev)\r\n{\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nreturn regmap_update_bits(regmap, TMP103_CONF_REG,\r\nTMP103_CONF_SD_MASK, TMP103_CONF_SD);\r\n}

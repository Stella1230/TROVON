static inline u32 xstore(u32 *addr, u32 edx_in)\r\n{\r\nu32 eax_out;\r\nasm(".byte 0x0F,0xA7,0xC0 /* xstore %%edi (addr=%0) */"\r\n: "=m" (*addr), "=a" (eax_out), "+d" (edx_in), "+D" (addr));\r\nreturn eax_out;\r\n}\r\nstatic int via_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nchar buf[16 + PADLOCK_ALIGNMENT - STACK_ALIGN] __attribute__\r\n((aligned(STACK_ALIGN)));\r\nu32 *via_rng_datum = (u32 *)PTR_ALIGN(&buf[0], PADLOCK_ALIGNMENT);\r\nu32 bytes_out;\r\nint i;\r\nfor (i = 0; i < 20; i++) {\r\n*via_rng_datum = 0;\r\nbytes_out = xstore(via_rng_datum, VIA_RNG_CHUNK_1);\r\nbytes_out &= VIA_XSTORE_CNT_MASK;\r\nif (bytes_out || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nrng->priv = *via_rng_datum;\r\nreturn bytes_out ? 1 : 0;\r\n}\r\nstatic int via_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nu32 via_rng_datum = (u32)rng->priv;\r\n*data = via_rng_datum;\r\nreturn 1;\r\n}\r\nstatic int via_rng_init(struct hwrng *rng)\r\n{\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nu32 lo, hi, old_lo;\r\nif ((c->x86 == 6) && (c->x86_model >= 0x0f)) {\r\nif (!boot_cpu_has(X86_FEATURE_XSTORE_EN)) {\r\npr_err(PFX "can't enable hardware RNG "\r\n"if XSTORE is not enabled\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nrdmsr(MSR_VIA_RNG, lo, hi);\r\nold_lo = lo;\r\nlo &= ~(0x7f << VIA_STRFILT_CNT_SHIFT);\r\nlo &= ~VIA_XSTORE_CNT_MASK;\r\nlo &= ~(VIA_STRFILT_ENABLE | VIA_STRFILT_FAIL | VIA_RAWBITS_ENABLE);\r\nlo |= VIA_RNG_ENABLE;\r\nlo |= VIA_NOISESRC1;\r\nif ((c->x86_model == 9) && (c->x86_mask > 7))\r\nlo |= VIA_NOISESRC2;\r\nif (c->x86_model >= 10)\r\nlo |= VIA_NOISESRC2;\r\nif (lo != old_lo)\r\nwrmsr(MSR_VIA_RNG, lo, hi);\r\nrdmsr(MSR_VIA_RNG, lo, hi);\r\nif ((lo & VIA_RNG_ENABLE) == 0) {\r\npr_err(PFX "cannot enable VIA C3 RNG, aborting\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init mod_init(void)\r\n{\r\nint err;\r\nif (!boot_cpu_has(X86_FEATURE_XSTORE))\r\nreturn -ENODEV;\r\npr_info("VIA RNG detected\n");\r\nerr = hwrng_register(&via_rng);\r\nif (err) {\r\npr_err(PFX "RNG registering failed (%d)\n",\r\nerr);\r\ngoto out;\r\n}\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit mod_exit(void)\r\n{\r\nhwrng_unregister(&via_rng);\r\n}

static int _stb0899_read_reg(struct stb0899_state *state, unsigned int reg)\r\n{\r\nint ret;\r\nu8 b0[] = { reg >> 8, reg & 0xff };\r\nu8 buf;\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = b0,\r\n.len = 2\r\n},{\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = &buf,\r\n.len = 1\r\n}\r\n};\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2) {\r\nif (ret != -ERESTARTSYS)\r\ndprintk(state->verbose, FE_ERROR, 1,\r\n"Read error, Reg=[0x%02x], Status=%d",\r\nreg, ret);\r\nreturn ret < 0 ? ret : -EREMOTEIO;\r\n}\r\nif (unlikely(*state->verbose >= FE_DEBUGREG))\r\ndprintk(state->verbose, FE_ERROR, 1, "Reg=[0x%02x], data=%02x",\r\nreg, buf);\r\nreturn (unsigned int)buf;\r\n}\r\nint stb0899_read_reg(struct stb0899_state *state, unsigned int reg)\r\n{\r\nint result;\r\nresult = _stb0899_read_reg(state, reg);\r\nif ((reg != 0xf2ff) && (reg != 0xf6ff) &&\r\n(((reg & 0xff00) == 0xf200) || ((reg & 0xff00) == 0xf600)))\r\n_stb0899_read_reg(state, (reg | 0x00ff));\r\nreturn result;\r\n}\r\nu32 _stb0899_read_s2reg(struct stb0899_state *state,\r\nu32 stb0899_i2cdev,\r\nu32 stb0899_base_addr,\r\nu16 stb0899_reg_offset)\r\n{\r\nint status;\r\nu32 data;\r\nu8 buf[7] = { 0 };\r\nu16 tmpaddr;\r\nu8 buf_0[] = {\r\nGETBYTE(stb0899_i2cdev, BYTE1),\r\nGETBYTE(stb0899_i2cdev, BYTE0),\r\nGETBYTE(stb0899_base_addr, BYTE0),\r\nGETBYTE(stb0899_base_addr, BYTE1),\r\nGETBYTE(stb0899_base_addr, BYTE2),\r\nGETBYTE(stb0899_base_addr, BYTE3),\r\n};\r\nu8 buf_1[] = {\r\n0x00,\r\n0x00,\r\n};\r\nstruct i2c_msg msg_0 = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf_0,\r\n.len = 6\r\n};\r\nstruct i2c_msg msg_1 = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf_1,\r\n.len = 2\r\n};\r\nstruct i2c_msg msg_r = {\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = buf,\r\n.len = 4\r\n};\r\ntmpaddr = stb0899_reg_offset & 0xff00;\r\nif (!(stb0899_reg_offset & 0x8))\r\ntmpaddr = stb0899_reg_offset | 0x20;\r\nbuf_1[0] = GETBYTE(tmpaddr, BYTE1);\r\nbuf_1[1] = GETBYTE(tmpaddr, BYTE0);\r\nstatus = i2c_transfer(state->i2c, &msg_0, 1);\r\nif (status < 1) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s ERR(1), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, status);\r\ngoto err;\r\n}\r\nstatus = i2c_transfer(state->i2c, &msg_1, 1);\r\nif (status < 1)\r\ngoto err;\r\nstatus = i2c_transfer(state->i2c, &msg_r, 1);\r\nif (status < 1)\r\ngoto err;\r\nbuf_1[0] = GETBYTE(stb0899_reg_offset, BYTE1);\r\nbuf_1[1] = GETBYTE(stb0899_reg_offset, BYTE0);\r\nstatus = i2c_transfer(state->i2c, &msg_1, 1);\r\nif (status < 1) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s ERR(2), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, status);\r\ngoto err;\r\n}\r\nstatus = i2c_transfer(state->i2c, &msg_r, 1);\r\nif (status < 1) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s ERR(3), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, status);\r\nreturn status < 0 ? status : -EREMOTEIO;\r\n}\r\ndata = MAKEWORD32(buf[3], buf[2], buf[1], buf[0]);\r\nif (unlikely(*state->verbose >= FE_DEBUGREG))\r\nprintk(KERN_DEBUG "%s Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Data=[0x%08x]\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, data);\r\nreturn data;\r\nerr:\r\nreturn status < 0 ? status : -EREMOTEIO;\r\n}\r\nint stb0899_write_s2reg(struct stb0899_state *state,\r\nu32 stb0899_i2cdev,\r\nu32 stb0899_base_addr,\r\nu16 stb0899_reg_offset,\r\nu32 stb0899_data)\r\n{\r\nint status;\r\nu8 buf_0[] = {\r\nGETBYTE(stb0899_i2cdev, BYTE1),\r\nGETBYTE(stb0899_i2cdev, BYTE0),\r\nGETBYTE(stb0899_base_addr, BYTE0),\r\nGETBYTE(stb0899_base_addr, BYTE1),\r\nGETBYTE(stb0899_base_addr, BYTE2),\r\nGETBYTE(stb0899_base_addr, BYTE3),\r\n};\r\nu8 buf_1[] = {\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x00,\r\n};\r\nstruct i2c_msg msg_0 = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf_0,\r\n.len = 6\r\n};\r\nstruct i2c_msg msg_1 = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf_1,\r\n.len = 6\r\n};\r\nbuf_1[0] = GETBYTE(stb0899_reg_offset, BYTE1);\r\nbuf_1[1] = GETBYTE(stb0899_reg_offset, BYTE0);\r\nbuf_1[2] = GETBYTE(stb0899_data, BYTE0);\r\nbuf_1[3] = GETBYTE(stb0899_data, BYTE1);\r\nbuf_1[4] = GETBYTE(stb0899_data, BYTE2);\r\nbuf_1[5] = GETBYTE(stb0899_data, BYTE3);\r\nif (unlikely(*state->verbose >= FE_DEBUGREG))\r\nprintk(KERN_DEBUG "%s Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x]\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, stb0899_data);\r\nstatus = i2c_transfer(state->i2c, &msg_0, 1);\r\nif (unlikely(status < 1)) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s ERR (1), Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x], status=%d\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, stb0899_data, status);\r\ngoto err;\r\n}\r\nstatus = i2c_transfer(state->i2c, &msg_1, 1);\r\nif (unlikely(status < 1)) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s ERR (2), Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x], status=%d\n",\r\n__func__, stb0899_i2cdev, stb0899_base_addr, stb0899_reg_offset, stb0899_data, status);\r\nreturn status < 0 ? status : -EREMOTEIO;\r\n}\r\nreturn 0;\r\nerr:\r\nreturn status < 0 ? status : -EREMOTEIO;\r\n}\r\nint stb0899_read_regs(struct stb0899_state *state, unsigned int reg, u8 *buf, u32 count)\r\n{\r\nint status;\r\nu8 b0[] = { reg >> 8, reg & 0xff };\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = b0,\r\n.len = 2\r\n},{\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = buf,\r\n.len = count\r\n}\r\n};\r\nstatus = i2c_transfer(state->i2c, msg, 2);\r\nif (status != 2) {\r\nif (status != -ERESTARTSYS)\r\nprintk(KERN_ERR "%s Read error, Reg=[0x%04x], Count=%u, Status=%d\n",\r\n__func__, reg, count, status);\r\ngoto err;\r\n}\r\nif ((reg != 0xf2ff) && (reg != 0xf6ff) &&\r\n(((reg & 0xff00) == 0xf200) || ((reg & 0xff00) == 0xf600)))\r\n_stb0899_read_reg(state, (reg | 0x00ff));\r\ndprintk(state->verbose, FE_DEBUGREG, 1,\r\n"%s [0x%04x]: %*ph", __func__, reg, count, buf);\r\nreturn 0;\r\nerr:\r\nreturn status < 0 ? status : -EREMOTEIO;\r\n}\r\nint stb0899_write_regs(struct stb0899_state *state, unsigned int reg, u8 *data, u32 count)\r\n{\r\nint ret;\r\nu8 buf[MAX_XFER_SIZE];\r\nstruct i2c_msg i2c_msg = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = 2 + count\r\n};\r\nif (2 + count > sizeof(buf)) {\r\nprintk(KERN_WARNING\r\n"%s: i2c wr reg=%04x: len=%d is too big!\n",\r\nKBUILD_MODNAME, reg, count);\r\nreturn -EINVAL;\r\n}\r\nbuf[0] = reg >> 8;\r\nbuf[1] = reg & 0xff;\r\nmemcpy(&buf[2], data, count);\r\ndprintk(state->verbose, FE_DEBUGREG, 1,\r\n"%s [0x%04x]: %*ph", __func__, reg, count, data);\r\nret = i2c_transfer(state->i2c, &i2c_msg, 1);\r\nif ((((reg & 0xff00) == 0xf200) || ((reg & 0xff00) == 0xf600)))\r\nstb0899_read_reg(state, (reg | 0x00ff));\r\nif (ret != 1) {\r\nif (ret != -ERESTARTSYS)\r\ndprintk(state->verbose, FE_ERROR, 1, "Reg=[0x%04x], Data=[0x%02x ...], Count=%u, Status=%d",\r\nreg, data[0], count, ret);\r\nreturn ret < 0 ? ret : -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nint stb0899_write_reg(struct stb0899_state *state, unsigned int reg, u8 data)\r\n{\r\nreturn stb0899_write_regs(state, reg, &data, 1);\r\n}\r\nstatic u32 stb0899_get_mclk(struct stb0899_state *state)\r\n{\r\nu32 mclk = 0, div = 0;\r\ndiv = stb0899_read_reg(state, STB0899_NCOARSE);\r\nmclk = (div + 1) * state->config->xtal_freq / 6;\r\ndprintk(state->verbose, FE_DEBUG, 1, "div=%d, mclk=%d", div, mclk);\r\nreturn mclk;\r\n}\r\nstatic void stb0899_set_mclk(struct stb0899_state *state, u32 Mclk)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nu8 mdiv = 0;\r\ndprintk(state->verbose, FE_DEBUG, 1, "state->config=%p", state->config);\r\nmdiv = ((6 * Mclk) / state->config->xtal_freq) - 1;\r\ndprintk(state->verbose, FE_DEBUG, 1, "mdiv=%d", mdiv);\r\nstb0899_write_reg(state, STB0899_NCOARSE, mdiv);\r\ninternal->master_clk = stb0899_get_mclk(state);\r\ndprintk(state->verbose, FE_DEBUG, 1, "MasterCLOCK=%d", internal->master_clk);\r\n}\r\nstatic int stb0899_postproc(struct stb0899_state *state, u8 ctl, int enable)\r\n{\r\nstruct stb0899_config *config = state->config;\r\nconst struct stb0899_postproc *postproc = config->postproc;\r\nif (postproc) {\r\nif (enable) {\r\nif (postproc[ctl].level == STB0899_GPIOPULLUP)\r\nstb0899_write_reg(state, postproc[ctl].gpio, 0x02);\r\nelse\r\nstb0899_write_reg(state, postproc[ctl].gpio, 0x82);\r\n} else {\r\nif (postproc[ctl].level == STB0899_GPIOPULLUP)\r\nstb0899_write_reg(state, postproc[ctl].gpio, 0x82);\r\nelse\r\nstb0899_write_reg(state, postproc[ctl].gpio, 0x02);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void stb0899_detach(struct dvb_frontend *fe)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstb0899_postproc(state, STB0899_POSTPROC_GPIO_POWER, 0);\r\n}\r\nstatic void stb0899_release(struct dvb_frontend *fe)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Release Frontend");\r\nkfree(state);\r\n}\r\nstatic int stb0899_get_alpha(struct stb0899_state *state)\r\n{\r\nu8 mode_coeff;\r\nmode_coeff = stb0899_read_reg(state, STB0899_DEMOD);\r\nif (STB0899_GETFIELD(MODECOEFF, mode_coeff) == 1)\r\nreturn 20;\r\nelse\r\nreturn 35;\r\n}\r\nstatic void stb0899_init_calc(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nint master_clk;\r\nu8 agc[2];\r\nu32 reg;\r\nstb0899_read_regs(state, STB0899_AGC1REF, agc, 2);\r\nmaster_clk = stb0899_get_mclk(state);\r\ninternal->t_agc1 = 0;\r\ninternal->t_agc2 = 0;\r\ninternal->master_clk = master_clk;\r\ninternal->mclk = master_clk / 65536L;\r\ninternal->rolloff = stb0899_get_alpha(state);\r\ninternal->agc_gain = 8154;\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_CNTRL);\r\nSTB0899_SETFIELD_VAL(IF_GAIN_INIT, reg, internal->agc_gain);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_IF_AGC_CNTRL, STB0899_OFF0_IF_AGC_CNTRL, reg);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, RRC_ALPHA);\r\ninternal->rrc_alpha = STB0899_GETFIELD(RRC_ALPHA, reg);\r\ninternal->center_freq = 0;\r\ninternal->av_frame_coarse = 10;\r\ninternal->av_frame_fine = 20;\r\ninternal->step_size = 2;\r\n}\r\nstatic int stb0899_wait_diseqc_fifo_empty(struct stb0899_state *state, int timeout)\r\n{\r\nu8 reg = 0;\r\nunsigned long start = jiffies;\r\nwhile (1) {\r\nreg = stb0899_read_reg(state, STB0899_DISSTATUS);\r\nif (!STB0899_GETFIELD(FIFOFULL, reg))\r\nbreak;\r\nif (time_after(jiffies, start + timeout)) {\r\ndprintk(state->verbose, FE_ERROR, 1, "timed out !!");\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_send_diseqc_msg(struct dvb_frontend *fe, struct dvb_diseqc_master_cmd *cmd)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nu8 reg, i;\r\nif (cmd->msg_len > sizeof(cmd->msg))\r\nreturn -EINVAL;\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nSTB0899_SETFIELD_VAL(DISPRECHARGE, reg, 1);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nfor (i = 0; i < cmd->msg_len; i++) {\r\nif (stb0899_wait_diseqc_fifo_empty(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nstb0899_write_reg(state, STB0899_DISFIFO, cmd->msg[i]);\r\n}\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nSTB0899_SETFIELD_VAL(DISPRECHARGE, reg, 0);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nmsleep(100);\r\nreturn 0;\r\n}\r\nstatic int stb0899_wait_diseqc_rxidle(struct stb0899_state *state, int timeout)\r\n{\r\nu8 reg = 0;\r\nunsigned long start = jiffies;\r\nwhile (!STB0899_GETFIELD(RXEND, reg)) {\r\nreg = stb0899_read_reg(state, STB0899_DISRX_ST0);\r\nif (time_after(jiffies, start + timeout)) {\r\ndprintk(state->verbose, FE_ERROR, 1, "timed out!!");\r\nreturn -ETIMEDOUT;\r\n}\r\nmsleep(10);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_recv_slave_reply(struct dvb_frontend *fe, struct dvb_diseqc_slave_reply *reply)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nu8 reg, length = 0, i;\r\nint result;\r\nif (stb0899_wait_diseqc_rxidle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nreg = stb0899_read_reg(state, STB0899_DISRX_ST0);\r\nif (STB0899_GETFIELD(RXEND, reg)) {\r\nreg = stb0899_read_reg(state, STB0899_DISRX_ST1);\r\nlength = STB0899_GETFIELD(FIFOBYTENBR, reg);\r\nif (length > sizeof (reply->msg)) {\r\nresult = -EOVERFLOW;\r\ngoto exit;\r\n}\r\nreply->msg_len = length;\r\nfor (i = 0; i < length; i++)\r\nreply->msg[i] = stb0899_read_reg(state, STB0899_DISFIFO);\r\n}\r\nreturn 0;\r\nexit:\r\nreturn result;\r\n}\r\nstatic int stb0899_wait_diseqc_txidle(struct stb0899_state *state, int timeout)\r\n{\r\nu8 reg = 0;\r\nunsigned long start = jiffies;\r\nwhile (!STB0899_GETFIELD(TXIDLE, reg)) {\r\nreg = stb0899_read_reg(state, STB0899_DISSTATUS);\r\nif (time_after(jiffies, start + timeout)) {\r\ndprintk(state->verbose, FE_ERROR, 1, "timed out!!");\r\nreturn -ETIMEDOUT;\r\n}\r\nmsleep(10);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_send_diseqc_burst(struct dvb_frontend *fe,\r\nenum fe_sec_mini_cmd burst)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nu8 reg, old_state;\r\nif (stb0899_wait_diseqc_txidle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nold_state = reg;\r\nSTB0899_SETFIELD_VAL(DISEQCMODE, reg, 0x03);\r\nSTB0899_SETFIELD_VAL(DISPRECHARGE, reg, 0x01);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nswitch (burst) {\r\ncase SEC_MINI_A:\r\nstb0899_write_reg(state, STB0899_DISFIFO, 0x00);\r\nbreak;\r\ncase SEC_MINI_B:\r\nstb0899_write_reg(state, STB0899_DISFIFO, 0xff);\r\nbreak;\r\n}\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nSTB0899_SETFIELD_VAL(DISPRECHARGE, reg, 0x00);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nif (stb0899_wait_diseqc_txidle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, old_state);\r\nreturn 0;\r\n}\r\nstatic int stb0899_diseqc_init(struct stb0899_state *state)\r\n{\r\nu8 f22_tx, reg;\r\nu32 mclk, tx_freq = 22000;\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL2);\r\nSTB0899_SETFIELD_VAL(ONECHIP_TRX, reg, 0);\r\nstb0899_write_reg(state, STB0899_DISCNTRL2, reg);\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nSTB0899_SETFIELD_VAL(DISEQCRESET, reg, 1);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nreg = stb0899_read_reg(state, STB0899_DISCNTRL1);\r\nSTB0899_SETFIELD_VAL(DISEQCRESET, reg, 0);\r\nstb0899_write_reg(state, STB0899_DISCNTRL1, reg);\r\nmclk = stb0899_get_mclk(state);\r\nf22_tx = mclk / (tx_freq * 32);\r\nstb0899_write_reg(state, STB0899_DISF22, f22_tx);\r\nstate->rx_freq = 20000;\r\nreturn 0;\r\n}\r\nstatic int stb0899_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Going to Sleep .. (Really tired .. :-))");\r\nstb0899_postproc(state, STB0899_POSTPROC_GPIO_POWER, 0);\r\nreturn 0;\r\n}\r\nstatic int stb0899_wakeup(struct dvb_frontend *fe)\r\n{\r\nint rc;\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nif ((rc = stb0899_write_reg(state, STB0899_SYNTCTRL, STB0899_SELOSCI)))\r\nreturn rc;\r\nif ((rc = stb0899_write_reg(state, STB0899_STOPCLK1, 0x00)))\r\nreturn rc;\r\nif ((rc = stb0899_write_reg(state, STB0899_STOPCLK2, 0x00)))\r\nreturn rc;\r\nstb0899_postproc(state, STB0899_POSTPROC_GPIO_POWER, 1);\r\nreturn 0;\r\n}\r\nstatic int stb0899_init(struct dvb_frontend *fe)\r\n{\r\nint i;\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_config *config = state->config;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Initializing STB0899 ... ");\r\ndprintk(state->verbose, FE_DEBUG, 1, "init device");\r\nfor (i = 0; config->init_dev[i].address != 0xffff; i++)\r\nstb0899_write_reg(state, config->init_dev[i].address, config->init_dev[i].data);\r\ndprintk(state->verbose, FE_DEBUG, 1, "init S2 demod");\r\nfor (i = 0; config->init_s2_demod[i].offset != 0xffff; i++)\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD,\r\nconfig->init_s2_demod[i].base_address,\r\nconfig->init_s2_demod[i].offset,\r\nconfig->init_s2_demod[i].data);\r\ndprintk(state->verbose, FE_DEBUG, 1, "init S1 demod");\r\nfor (i = 0; config->init_s1_demod[i].address != 0xffff; i++)\r\nstb0899_write_reg(state, config->init_s1_demod[i].address, config->init_s1_demod[i].data);\r\ndprintk(state->verbose, FE_DEBUG, 1, "init S2 FEC");\r\nfor (i = 0; config->init_s2_fec[i].offset != 0xffff; i++)\r\nstb0899_write_s2reg(state, STB0899_S2FEC,\r\nconfig->init_s2_fec[i].base_address,\r\nconfig->init_s2_fec[i].offset,\r\nconfig->init_s2_fec[i].data);\r\ndprintk(state->verbose, FE_DEBUG, 1, "init TST");\r\nfor (i = 0; config->init_tst[i].address != 0xffff; i++)\r\nstb0899_write_reg(state, config->init_tst[i].address, config->init_tst[i].data);\r\nstb0899_init_calc(state);\r\nstb0899_diseqc_init(state);\r\nreturn 0;\r\n}\r\nstatic int stb0899_table_lookup(const struct stb0899_tab *tab, int max, int val)\r\n{\r\nint res = 0;\r\nint min = 0, med;\r\nif (val < tab[min].read)\r\nres = tab[min].real;\r\nelse if (val >= tab[max].read)\r\nres = tab[max].real;\r\nelse {\r\nwhile ((max - min) > 1) {\r\nmed = (max + min) / 2;\r\nif (val >= tab[min].read && val < tab[med].read)\r\nmax = med;\r\nelse\r\nmin = med;\r\n}\r\nres = ((val - tab[min].read) *\r\n(tab[max].real - tab[min].real) /\r\n(tab[max].read - tab[min].read)) +\r\ntab[min].real;\r\n}\r\nreturn res;\r\n}\r\nstatic int stb0899_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\nint val;\r\nu32 reg;\r\n*strength = 0;\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ncase SYS_DSS:\r\nif (internal->lock) {\r\nreg = stb0899_read_reg(state, STB0899_VSTATUS);\r\nif (STB0899_GETFIELD(VSTATUS_LOCKEDVIT, reg)) {\r\nreg = stb0899_read_reg(state, STB0899_AGCIQIN);\r\nval = (s32)(s8)STB0899_GETFIELD(AGCIQVALUE, reg);\r\n*strength = stb0899_table_lookup(stb0899_dvbsrf_tab, ARRAY_SIZE(stb0899_dvbsrf_tab) - 1, val);\r\n*strength += 750;\r\ndprintk(state->verbose, FE_DEBUG, 1, "AGCIQVALUE = 0x%02x, C = %d * 0.1 dBm",\r\nval & 0xff, *strength);\r\n}\r\n}\r\nbreak;\r\ncase SYS_DVBS2:\r\nif (internal->lock) {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_GAIN);\r\nval = STB0899_GETFIELD(IF_AGC_GAIN, reg);\r\n*strength = stb0899_table_lookup(stb0899_dvbs2rf_tab, ARRAY_SIZE(stb0899_dvbs2rf_tab) - 1, val);\r\n*strength += 950;\r\ndprintk(state->verbose, FE_DEBUG, 1, "IF_AGC_GAIN = 0x%04x, C = %d * 0.1 dBm",\r\nval & 0x3fff, *strength);\r\n}\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Unsupported delivery system");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\nunsigned int val, quant, quantn = -1, est, estn = -1;\r\nu8 buf[2];\r\nu32 reg;\r\n*snr = 0;\r\nreg = stb0899_read_reg(state, STB0899_VSTATUS);\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ncase SYS_DSS:\r\nif (internal->lock) {\r\nif (STB0899_GETFIELD(VSTATUS_LOCKEDVIT, reg)) {\r\nstb0899_read_regs(state, STB0899_NIRM, buf, 2);\r\nval = MAKEWORD16(buf[0], buf[1]);\r\n*snr = stb0899_table_lookup(stb0899_cn_tab, ARRAY_SIZE(stb0899_cn_tab) - 1, val);\r\ndprintk(state->verbose, FE_DEBUG, 1, "NIR = 0x%02x%02x = %u, C/N = %d * 0.1 dBm\n",\r\nbuf[0], buf[1], val, *snr);\r\n}\r\n}\r\nbreak;\r\ncase SYS_DVBS2:\r\nif (internal->lock) {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_CNTRL1);\r\nquant = STB0899_GETFIELD(UWP_ESN0_QUANT, reg);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_STAT2);\r\nest = STB0899_GETFIELD(ESN0_EST, reg);\r\nif (est == 1)\r\nval = 301;\r\nelse if (est == 2)\r\nval = 270;\r\nelse {\r\nquantn = stb0899_table_lookup(stb0899_quant_tab, ARRAY_SIZE(stb0899_quant_tab) - 1, quant * 100);\r\nestn = stb0899_table_lookup(stb0899_est_tab, ARRAY_SIZE(stb0899_est_tab) - 1, est);\r\nval = (quantn - estn) / 10;\r\n}\r\n*snr = val;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Es/N0 quant = %d (%d) estimate = %u (%d), C/N = %d * 0.1 dBm",\r\nquant, quantn, est, estn, val);\r\n}\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Unsupported delivery system");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_read_status(struct dvb_frontend *fe, enum fe_status *status)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\nu8 reg;\r\n*status = 0;\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ncase SYS_DSS:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Delivery system DVB-S/DSS");\r\nif (internal->lock) {\r\nreg = stb0899_read_reg(state, STB0899_VSTATUS);\r\nif (STB0899_GETFIELD(VSTATUS_LOCKEDVIT, reg)) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "--------> FE_HAS_CARRIER | FE_HAS_LOCK");\r\n*status |= FE_HAS_SIGNAL | FE_HAS_CARRIER | FE_HAS_LOCK;\r\nreg = stb0899_read_reg(state, STB0899_PLPARM);\r\nif (STB0899_GETFIELD(VITCURPUN, reg)) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "--------> FE_HAS_VITERBI | FE_HAS_SYNC");\r\n*status |= FE_HAS_VITERBI | FE_HAS_SYNC;\r\nstb0899_postproc(state, STB0899_POSTPROC_GPIO_LOCK, 1);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase SYS_DVBS2:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Delivery system DVB-S2");\r\nif (internal->lock) {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_STAT2);\r\nif (STB0899_GETFIELD(UWP_LOCK, reg) && STB0899_GETFIELD(CSM_LOCK, reg)) {\r\n*status |= FE_HAS_CARRIER;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"UWP & CSM Lock ! ---> DVB-S2 FE_HAS_CARRIER");\r\nreg = stb0899_read_reg(state, STB0899_CFGPDELSTATUS1);\r\nif (STB0899_GETFIELD(CFGPDELSTATUS_LOCK, reg)) {\r\n*status |= FE_HAS_LOCK;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"Packet Delineator Locked ! -----> DVB-S2 FE_HAS_LOCK");\r\n}\r\nif (STB0899_GETFIELD(CONTINUOUS_STREAM, reg)) {\r\n*status |= FE_HAS_VITERBI;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"Packet Delineator found VITERBI ! -----> DVB-S2 FE_HAS_VITERBI");\r\n}\r\nif (STB0899_GETFIELD(ACCEPTED_STREAM, reg)) {\r\n*status |= FE_HAS_SYNC;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"Packet Delineator found SYNC ! -----> DVB-S2 FE_HAS_SYNC");\r\nstb0899_postproc(state, STB0899_POSTPROC_GPIO_LOCK, 1);\r\n}\r\n}\r\n}\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Unsupported delivery system");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\nu8 lsb, msb;\r\n*ber = 0;\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ncase SYS_DSS:\r\nif (internal->lock) {\r\nlsb = stb0899_read_reg(state, STB0899_ECNT1L);\r\nmsb = stb0899_read_reg(state, STB0899_ECNT1M);\r\n*ber = MAKEWORD16(msb, lsb);\r\nif (STB0899_GETFIELD(VSTATUS_PRFVIT, internal->v_status)) {\r\n*ber *= 9766;\r\n*ber /= (-1 + (1 << (2 * STB0899_GETFIELD(NOE, internal->err_ctrl))));\r\n*ber /= 8;\r\n}\r\n}\r\nbreak;\r\ncase SYS_DVBS2:\r\nif (internal->lock) {\r\nlsb = stb0899_read_reg(state, STB0899_ECNT1L);\r\nmsb = stb0899_read_reg(state, STB0899_ECNT1M);\r\n*ber = MAKEWORD16(msb, lsb);\r\n*ber *= 10000000;\r\n*ber /= (-1 + (1 << (4 + 2 * STB0899_GETFIELD(NOE, internal->err_ctrl))));\r\n}\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Unsupported delivery system");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_set_voltage(struct dvb_frontend *fe,\r\nenum fe_sec_voltage voltage)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_13:\r\nstb0899_write_reg(state, STB0899_GPIO00CFG, 0x82);\r\nstb0899_write_reg(state, STB0899_GPIO01CFG, 0x02);\r\nstb0899_write_reg(state, STB0899_GPIO02CFG, 0x00);\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nstb0899_write_reg(state, STB0899_GPIO00CFG, 0x02);\r\nstb0899_write_reg(state, STB0899_GPIO01CFG, 0x02);\r\nstb0899_write_reg(state, STB0899_GPIO02CFG, 0x82);\r\nbreak;\r\ncase SEC_VOLTAGE_OFF:\r\nstb0899_write_reg(state, STB0899_GPIO00CFG, 0x82);\r\nstb0899_write_reg(state, STB0899_GPIO01CFG, 0x82);\r\nstb0899_write_reg(state, STB0899_GPIO02CFG, 0x82);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stb0899_set_tone(struct dvb_frontend *fe, enum fe_sec_tone_mode tone)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\nu8 div, reg;\r\nif (stb0899_wait_diseqc_txidle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\ndiv = (internal->master_clk / 100) / 5632;\r\ndiv = (div + 5) / 10;\r\nstb0899_write_reg(state, STB0899_DISEQCOCFG, 0x66);\r\nreg = stb0899_read_reg(state, STB0899_ACRPRESC);\r\nSTB0899_SETFIELD_VAL(ACRPRESC, reg, 0x03);\r\nstb0899_write_reg(state, STB0899_ACRPRESC, reg);\r\nstb0899_write_reg(state, STB0899_ACRDIV1, div);\r\nbreak;\r\ncase SEC_TONE_OFF:\r\nstb0899_write_reg(state, STB0899_DISEQCOCFG, 0x20);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint stb0899_i2c_gate_ctrl(struct dvb_frontend *fe, int enable)\r\n{\r\nint i2c_stat;\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\ni2c_stat = stb0899_read_reg(state, STB0899_I2CRPT);\r\nif (i2c_stat < 0)\r\ngoto err;\r\nif (enable) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Enabling I2C Repeater ...");\r\ni2c_stat |= STB0899_I2CTON;\r\nif (stb0899_write_reg(state, STB0899_I2CRPT, i2c_stat) < 0)\r\ngoto err;\r\n} else {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Disabling I2C Repeater ...");\r\ni2c_stat &= ~STB0899_I2CTON;\r\nif (stb0899_write_reg(state, STB0899_I2CRPT, i2c_stat) < 0)\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(state->verbose, FE_ERROR, 1, "I2C Repeater control failed");\r\nreturn -EREMOTEIO;\r\n}\r\nstatic inline void CONVERT32(u32 x, char *str)\r\n{\r\n*str++ = (x >> 24) & 0xff;\r\n*str++ = (x >> 16) & 0xff;\r\n*str++ = (x >> 8) & 0xff;\r\n*str++ = (x >> 0) & 0xff;\r\n*str = '\0';\r\n}\r\nstatic int stb0899_get_dev_id(struct stb0899_state *state)\r\n{\r\nu8 chip_id, release;\r\nu16 id;\r\nu32 demod_ver = 0, fec_ver = 0;\r\nchar demod_str[5] = { 0 };\r\nchar fec_str[5] = { 0 };\r\nid = stb0899_read_reg(state, STB0899_DEV_ID);\r\ndprintk(state->verbose, FE_DEBUG, 1, "ID reg=[0x%02x]", id);\r\nchip_id = STB0899_GETFIELD(CHIP_ID, id);\r\nrelease = STB0899_GETFIELD(CHIP_REL, id);\r\ndprintk(state->verbose, FE_ERROR, 1, "Device ID=[%d], Release=[%d]",\r\nchip_id, release);\r\nCONVERT32(STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_CORE_ID), (char *)&demod_str);\r\ndemod_ver = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_VERSION_ID);\r\ndprintk(state->verbose, FE_ERROR, 1, "Demodulator Core ID=[%s], Version=[%d]", (char *) &demod_str, demod_ver);\r\nCONVERT32(STB0899_READ_S2REG(STB0899_S2FEC, FEC_CORE_ID_REG), (char *)&fec_str);\r\nfec_ver = STB0899_READ_S2REG(STB0899_S2FEC, FEC_VER_ID_REG);\r\nif (! (chip_id > 0)) {\r\ndprintk(state->verbose, FE_ERROR, 1, "couldn't find a STB 0899");\r\nreturn -ENODEV;\r\n}\r\ndprintk(state->verbose, FE_ERROR, 1, "FEC Core ID=[%s], Version=[%d]", (char*) &fec_str, fec_ver);\r\nreturn 0;\r\n}\r\nstatic void stb0899_set_delivery(struct stb0899_state *state)\r\n{\r\nu8 reg;\r\nu8 stop_clk[2];\r\nstop_clk[0] = stb0899_read_reg(state, STB0899_STOPCLK1);\r\nstop_clk[1] = stb0899_read_reg(state, STB0899_STOPCLK2);\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Delivery System -- DVB-S");\r\nreg = stb0899_read_reg(state, STB0899_FECM);\r\nSTB0899_SETFIELD_VAL(FECM_RSVD0, reg, 0);\r\nSTB0899_SETFIELD_VAL(FECM_VITERBI_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_FECM, reg);\r\nstb0899_write_reg(state, STB0899_RSULC, 0xb1);\r\nstb0899_write_reg(state, STB0899_TSULC, 0x40);\r\nstb0899_write_reg(state, STB0899_RSLLC, 0x42);\r\nstb0899_write_reg(state, STB0899_TSLPL, 0x12);\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESLDPC, reg, 1);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nSTB0899_SETFIELD_VAL(STOP_CHK8PSK, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC108, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC216, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN108, stop_clk[1], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN216, stop_clk[1], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKINTBUF216, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKCORE216, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKS2DMD108, stop_clk[1], 1);\r\nbreak;\r\ncase SYS_DVBS2:\r\nreg = stb0899_read_reg(state, STB0899_FECM);\r\nSTB0899_SETFIELD_VAL(FECM_RSVD0, reg, 0);\r\nSTB0899_SETFIELD_VAL(FECM_VITERBI_ON, reg, 0);\r\nstb0899_write_reg(state, STB0899_FECM, reg);\r\nstb0899_write_reg(state, STB0899_RSULC, 0xb1);\r\nstb0899_write_reg(state, STB0899_TSULC, 0x42);\r\nstb0899_write_reg(state, STB0899_RSLLC, 0x40);\r\nstb0899_write_reg(state, STB0899_TSLPL, 0x02);\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESLDPC, reg, 0);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nSTB0899_SETFIELD_VAL(STOP_CHK8PSK, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC108, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC216, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN108, stop_clk[1], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN216, stop_clk[1], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKINTBUF216, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKCORE216, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKS2DMD108, stop_clk[1], 0);\r\nbreak;\r\ncase SYS_DSS:\r\nreg = stb0899_read_reg(state, STB0899_FECM);\r\nSTB0899_SETFIELD_VAL(FECM_RSVD0, reg, 1);\r\nSTB0899_SETFIELD_VAL(FECM_VITERBI_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_FECM, reg);\r\nstb0899_write_reg(state, STB0899_RSULC, 0xa1);\r\nstb0899_write_reg(state, STB0899_TSULC, 0x61);\r\nstb0899_write_reg(state, STB0899_RSLLC, 0x42);\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESLDPC, reg, 1);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nSTB0899_SETFIELD_VAL(STOP_CHK8PSK, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC108, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKFEC216, stop_clk[0], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN108, stop_clk[1], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKPKDLIN216, stop_clk[1], 1);\r\nSTB0899_SETFIELD_VAL(STOP_CKCORE216, stop_clk[0], 0);\r\nSTB0899_SETFIELD_VAL(STOP_CKS2DMD108, stop_clk[1], 1);\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_ERROR, 1, "Unsupported delivery system");\r\nbreak;\r\n}\r\nSTB0899_SETFIELD_VAL(STOP_CKADCI108, stop_clk[0], 0);\r\nstb0899_write_regs(state, STB0899_STOPCLK1, stop_clk, 2);\r\n}\r\nstatic void stb0899_set_iterations(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\ns32 iter_scale;\r\nu32 reg;\r\niter_scale = 17 * (internal->master_clk / 1000);\r\niter_scale += 410000;\r\niter_scale /= (internal->srate / 1000000);\r\niter_scale /= 1000;\r\nif (iter_scale > config->ldpc_max_iter)\r\niter_scale = config->ldpc_max_iter;\r\nreg = STB0899_READ_S2REG(STB0899_S2FEC, MAX_ITER);\r\nSTB0899_SETFIELD_VAL(MAX_ITERATIONS, reg, iter_scale);\r\nstb0899_write_s2reg(state, STB0899_S2FEC, STB0899_BASE_MAX_ITER, STB0899_OFF0_MAX_ITER, reg);\r\n}\r\nstatic enum dvbfe_search stb0899_search(struct dvb_frontend *fe)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_params *i_params = &state->params;\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nstruct dtv_frontend_properties *props = &fe->dtv_property_cache;\r\nu32 SearchRange, gain;\r\ni_params->freq = props->frequency;\r\ni_params->srate = props->symbol_rate;\r\nstate->delsys = props->delivery_system;\r\ndprintk(state->verbose, FE_DEBUG, 1, "delivery system=%d", state->delsys);\r\nSearchRange = 10000000;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Frequency=%d, Srate=%d", i_params->freq, i_params->srate);\r\nif (INRANGE(i_params->srate, 1000000, 45000000)) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Parameters IN RANGE");\r\nstb0899_set_delivery(state);\r\nif (state->config->tuner_set_rfsiggain) {\r\nif (internal->srate > 15000000)\r\ngain = 8;\r\nelse if (internal->srate > 5000000)\r\ngain = 12;\r\nelse\r\ngain = 14;\r\nstate->config->tuner_set_rfsiggain(fe, gain);\r\n}\r\nif (i_params->srate <= 5000000)\r\nstb0899_set_mclk(state, config->lo_clk);\r\nelse\r\nstb0899_set_mclk(state, config->hi_clk);\r\nswitch (state->delsys) {\r\ncase SYS_DVBS:\r\ncase SYS_DSS:\r\ndprintk(state->verbose, FE_DEBUG, 1, "DVB-S delivery system");\r\ninternal->freq = i_params->freq;\r\ninternal->srate = i_params->srate;\r\ninternal->srch_range = SearchRange + 1500000 + (i_params->srate / 5);\r\ninternal->derot_percent = 30;\r\nstb0899_i2c_gate_ctrl(&state->frontend, 1);\r\nif (state->config->tuner_set_bandwidth)\r\nstate->config->tuner_set_bandwidth(fe, (13 * (stb0899_carr_width(state) + SearchRange)) / 10);\r\nif (state->config->tuner_get_bandwidth)\r\nstate->config->tuner_get_bandwidth(fe, &internal->tuner_bw);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 0);\r\nstb0899_write_reg(state, STB0899_AGCRFCFG, 0x11);\r\ndprintk(state->verbose, FE_DEBUG, 1, "running DVB-S search algo ..");\r\nif (stb0899_dvbs_algo(state) == RANGEOK) {\r\ninternal->lock = 1;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"-------------------------------------> DVB-S LOCK !");\r\nreturn DVBFE_ALGO_SEARCH_SUCCESS;\r\n} else {\r\ninternal->lock = 0;\r\nreturn DVBFE_ALGO_SEARCH_FAILED;\r\n}\r\nbreak;\r\ncase SYS_DVBS2:\r\ninternal->freq = i_params->freq;\r\ninternal->srate = i_params->srate;\r\ninternal->srch_range = SearchRange;\r\nstb0899_i2c_gate_ctrl(&state->frontend, 1);\r\nif (state->config->tuner_set_bandwidth)\r\nstate->config->tuner_set_bandwidth(fe, (stb0899_carr_width(state) + SearchRange));\r\nif (state->config->tuner_get_bandwidth)\r\nstate->config->tuner_get_bandwidth(fe, &internal->tuner_bw);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 0);\r\nstb0899_write_reg(state, STB0899_AGCRFCFG, 0x1c);\r\nstb0899_set_iterations(state);\r\ndprintk(state->verbose, FE_DEBUG, 1, "running DVB-S2 search algo ..");\r\nif (stb0899_dvbs2_algo(state) == DVBS2_FEC_LOCK) {\r\ninternal->lock = 1;\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"-------------------------------------> DVB-S2 LOCK !");\r\nreturn DVBFE_ALGO_SEARCH_SUCCESS;\r\n} else {\r\ninternal->lock = 0;\r\nreturn DVBFE_ALGO_SEARCH_FAILED;\r\n}\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_ERROR, 1, "Unsupported delivery system");\r\nreturn DVBFE_ALGO_SEARCH_INVALID;\r\n}\r\n}\r\nreturn DVBFE_ALGO_SEARCH_ERROR;\r\n}\r\nstatic int stb0899_get_frontend(struct dvb_frontend *fe,\r\nstruct dtv_frontend_properties *p)\r\n{\r\nstruct stb0899_state *state = fe->demodulator_priv;\r\nstruct stb0899_internal *internal = &state->internal;\r\ndprintk(state->verbose, FE_DEBUG, 1, "Get params");\r\np->symbol_rate = internal->srate;\r\np->frequency = internal->freq;\r\nreturn 0;\r\n}\r\nstatic enum dvbfe_algo stb0899_frontend_algo(struct dvb_frontend *fe)\r\n{\r\nreturn DVBFE_ALGO_CUSTOM;\r\n}\r\nstruct dvb_frontend *stb0899_attach(struct stb0899_config *config, struct i2c_adapter *i2c)\r\n{\r\nstruct stb0899_state *state = NULL;\r\nstate = kzalloc(sizeof (struct stb0899_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nstate->verbose = &verbose;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->frontend.ops = stb0899_ops;\r\nstate->frontend.demodulator_priv = state;\r\nstate->internal.inversion = config->inversion;\r\nstb0899_wakeup(&state->frontend);\r\nif (stb0899_get_dev_id(state) == -ENODEV) {\r\nprintk("%s: Exiting .. !\n", __func__);\r\ngoto error;\r\n}\r\nprintk("%s: Attaching STB0899 \n", __func__);\r\nreturn &state->frontend;\r\nerror:\r\nkfree(state);\r\nreturn NULL;\r\n}

static int cosm_log_buf_show(struct seq_file *s, void *unused)\r\n{\r\nvoid __iomem *log_buf_va;\r\nint __iomem *log_buf_len_va;\r\nstruct cosm_device *cdev = s->private;\r\nvoid *kva;\r\nint size;\r\nu64 aper_offset;\r\nif (!cdev || !cdev->log_buf_addr || !cdev->log_buf_len)\r\ngoto done;\r\nmutex_lock(&cdev->cosm_mutex);\r\nswitch (cdev->state) {\r\ncase MIC_BOOTING:\r\ncase MIC_ONLINE:\r\ncase MIC_SHUTTING_DOWN:\r\nbreak;\r\ndefault:\r\ngoto unlock;\r\n}\r\naper_offset = (u64)cdev->log_buf_len - __START_KERNEL_map;\r\nlog_buf_len_va = cdev->hw_ops->aper(cdev)->va + aper_offset;\r\naper_offset = (u64)cdev->log_buf_addr - __START_KERNEL_map;\r\nlog_buf_va = cdev->hw_ops->aper(cdev)->va + aper_offset;\r\nsize = ioread32(log_buf_len_va);\r\nkva = kmalloc(size, GFP_KERNEL);\r\nif (!kva)\r\ngoto unlock;\r\nmemcpy_fromio(kva, log_buf_va, size);\r\nseq_write(s, kva, size);\r\nkfree(kva);\r\nunlock:\r\nmutex_unlock(&cdev->cosm_mutex);\r\ndone:\r\nreturn 0;\r\n}\r\nstatic int cosm_log_buf_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, cosm_log_buf_show, inode->i_private);\r\n}\r\nstatic int cosm_force_reset_show(struct seq_file *s, void *pos)\r\n{\r\nstruct cosm_device *cdev = s->private;\r\ncosm_stop(cdev, true);\r\nreturn 0;\r\n}\r\nstatic int cosm_force_reset_debug_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, cosm_force_reset_show, inode->i_private);\r\n}\r\nvoid cosm_create_debug_dir(struct cosm_device *cdev)\r\n{\r\nchar name[16];\r\nif (!cosm_dbg)\r\nreturn;\r\nscnprintf(name, sizeof(name), "mic%d", cdev->index);\r\ncdev->dbg_dir = debugfs_create_dir(name, cosm_dbg);\r\nif (!cdev->dbg_dir)\r\nreturn;\r\ndebugfs_create_file("log_buf", 0444, cdev->dbg_dir, cdev, &log_buf_ops);\r\ndebugfs_create_file("force_reset", 0444, cdev->dbg_dir, cdev,\r\n&force_reset_ops);\r\n}\r\nvoid cosm_delete_debug_dir(struct cosm_device *cdev)\r\n{\r\nif (!cdev->dbg_dir)\r\nreturn;\r\ndebugfs_remove_recursive(cdev->dbg_dir);\r\n}\r\nvoid cosm_init_debugfs(void)\r\n{\r\ncosm_dbg = debugfs_create_dir(KBUILD_MODNAME, NULL);\r\nif (!cosm_dbg)\r\npr_err("can't create debugfs dir\n");\r\n}\r\nvoid cosm_exit_debugfs(void)\r\n{\r\ndebugfs_remove(cosm_dbg);\r\n}

static const char *dma_mode_name(unsigned int mode)\r\n{\r\nswitch (mode) {\r\ncase TW686X_DMA_MODE_MEMCPY:\r\nreturn "memcpy";\r\ncase TW686X_DMA_MODE_CONTIG:\r\nreturn "contig";\r\ncase TW686X_DMA_MODE_SG:\r\nreturn "sg";\r\ndefault:\r\nreturn "unknown";\r\n}\r\n}\r\nstatic int tw686x_dma_mode_get(char *buffer, struct kernel_param *kp)\r\n{\r\nreturn sprintf(buffer, "%s", dma_mode_name(dma_mode));\r\n}\r\nstatic int tw686x_dma_mode_set(const char *val, struct kernel_param *kp)\r\n{\r\nif (!strcasecmp(val, dma_mode_name(TW686X_DMA_MODE_MEMCPY)))\r\ndma_mode = TW686X_DMA_MODE_MEMCPY;\r\nelse if (!strcasecmp(val, dma_mode_name(TW686X_DMA_MODE_CONTIG)))\r\ndma_mode = TW686X_DMA_MODE_CONTIG;\r\nelse if (!strcasecmp(val, dma_mode_name(TW686X_DMA_MODE_SG)))\r\ndma_mode = TW686X_DMA_MODE_SG;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nvoid tw686x_disable_channel(struct tw686x_dev *dev, unsigned int channel)\r\n{\r\nu32 dma_en = reg_read(dev, DMA_CHANNEL_ENABLE);\r\nu32 dma_cmd = reg_read(dev, DMA_CMD);\r\ndma_en &= ~BIT(channel);\r\ndma_cmd &= ~BIT(channel);\r\ndev->pending_dma_en &= ~BIT(channel);\r\ndev->pending_dma_cmd &= ~BIT(channel);\r\nif (!dma_en)\r\ndma_cmd = 0;\r\nreg_write(dev, DMA_CHANNEL_ENABLE, dma_en);\r\nreg_write(dev, DMA_CMD, dma_cmd);\r\n}\r\nvoid tw686x_enable_channel(struct tw686x_dev *dev, unsigned int channel)\r\n{\r\nu32 dma_en = reg_read(dev, DMA_CHANNEL_ENABLE);\r\nu32 dma_cmd = reg_read(dev, DMA_CMD);\r\ndev->pending_dma_en |= dma_en | BIT(channel);\r\ndev->pending_dma_cmd |= dma_cmd | DMA_CMD_ENABLE | BIT(channel);\r\n}\r\nstatic void tw686x_dma_delay(unsigned long data)\r\n{\r\nstruct tw686x_dev *dev = (struct tw686x_dev *)data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nreg_write(dev, DMA_CHANNEL_ENABLE, dev->pending_dma_en);\r\nreg_write(dev, DMA_CMD, dev->pending_dma_cmd);\r\ndev->pending_dma_en = 0;\r\ndev->pending_dma_cmd = 0;\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\n}\r\nstatic void tw686x_reset_channels(struct tw686x_dev *dev, unsigned int ch_mask)\r\n{\r\nu32 dma_en, dma_cmd;\r\ndma_en = reg_read(dev, DMA_CHANNEL_ENABLE);\r\ndma_cmd = reg_read(dev, DMA_CMD);\r\ndev->pending_dma_en |= dma_en;\r\ndev->pending_dma_cmd |= dma_cmd;\r\nreg_write(dev, DMA_CHANNEL_ENABLE, dma_en & ~ch_mask);\r\nif ((dma_en & ~ch_mask) == 0) {\r\ndev_dbg(&dev->pci_dev->dev, "reset: stopping DMA\n");\r\ndma_cmd &= ~DMA_CMD_ENABLE;\r\n}\r\nreg_write(dev, DMA_CMD, dma_cmd & ~ch_mask);\r\n}\r\nstatic irqreturn_t tw686x_irq(int irq, void *dev_id)\r\n{\r\nstruct tw686x_dev *dev = (struct tw686x_dev *)dev_id;\r\nunsigned int video_requests, audio_requests, reset_ch;\r\nu32 fifo_status, fifo_signal, fifo_ov, fifo_bad, fifo_errors;\r\nu32 int_status, dma_en, video_en, pb_status;\r\nunsigned long flags;\r\nint_status = reg_read(dev, INT_STATUS);\r\nfifo_status = reg_read(dev, VIDEO_FIFO_STATUS);\r\nif (!int_status && !TW686X_FIFO_ERROR(fifo_status))\r\nreturn IRQ_NONE;\r\nif (int_status & INT_STATUS_DMA_TOUT) {\r\ndev_dbg(&dev->pci_dev->dev,\r\n"DMA timeout. Resetting DMA for all channels\n");\r\nreset_ch = ~0;\r\ngoto reset_channels;\r\n}\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndma_en = reg_read(dev, DMA_CHANNEL_ENABLE);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nvideo_en = dma_en & 0xff;\r\nfifo_signal = ~(fifo_status & 0xff) & video_en;\r\nfifo_ov = fifo_status >> 24;\r\nfifo_bad = fifo_status >> 16;\r\nfifo_errors = fifo_signal & (fifo_ov | fifo_bad);\r\nreset_ch = 0;\r\npb_status = reg_read(dev, PB_STATUS);\r\nvideo_requests = (int_status & video_en) | fifo_errors;\r\naudio_requests = (int_status & dma_en) >> 8;\r\nif (video_requests)\r\ntw686x_video_irq(dev, video_requests, pb_status,\r\nfifo_status, &reset_ch);\r\nif (audio_requests)\r\ntw686x_audio_irq(dev, audio_requests, pb_status);\r\nreset_channels:\r\nif (reset_ch) {\r\nspin_lock_irqsave(&dev->lock, flags);\r\ntw686x_reset_channels(dev, reset_ch);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nmod_timer(&dev->dma_delay_timer,\r\njiffies + msecs_to_jiffies(100));\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void tw686x_dev_release(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct tw686x_dev *dev = container_of(v4l2_dev, struct tw686x_dev,\r\nv4l2_dev);\r\nunsigned int ch;\r\nfor (ch = 0; ch < max_channels(dev); ch++)\r\nv4l2_ctrl_handler_free(&dev->video_channels[ch].ctrl_handler);\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\nkfree(dev->audio_channels);\r\nkfree(dev->video_channels);\r\nkfree(dev);\r\n}\r\nstatic int tw686x_probe(struct pci_dev *pci_dev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct tw686x_dev *dev;\r\nint err;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->type = pci_id->driver_data;\r\ndev->dma_mode = dma_mode;\r\nsprintf(dev->name, "tw%04X", pci_dev->device);\r\ndev->video_channels = kcalloc(max_channels(dev),\r\nsizeof(*dev->video_channels), GFP_KERNEL);\r\nif (!dev->video_channels) {\r\nerr = -ENOMEM;\r\ngoto free_dev;\r\n}\r\ndev->audio_channels = kcalloc(max_channels(dev),\r\nsizeof(*dev->audio_channels), GFP_KERNEL);\r\nif (!dev->audio_channels) {\r\nerr = -ENOMEM;\r\ngoto free_video;\r\n}\r\npr_info("%s: PCI %s, IRQ %d, MMIO 0x%lx (%s mode)\n", dev->name,\r\npci_name(pci_dev), pci_dev->irq,\r\n(unsigned long)pci_resource_start(pci_dev, 0),\r\ndma_mode_name(dma_mode));\r\ndev->pci_dev = pci_dev;\r\nif (pci_enable_device(pci_dev)) {\r\nerr = -EIO;\r\ngoto free_audio;\r\n}\r\npci_set_master(pci_dev);\r\nerr = pci_set_dma_mask(pci_dev, DMA_BIT_MASK(32));\r\nif (err) {\r\ndev_err(&pci_dev->dev, "32-bit PCI DMA not supported\n");\r\nerr = -EIO;\r\ngoto disable_pci;\r\n}\r\nerr = pci_request_regions(pci_dev, dev->name);\r\nif (err) {\r\ndev_err(&pci_dev->dev, "unable to request PCI region\n");\r\ngoto disable_pci;\r\n}\r\ndev->mmio = pci_ioremap_bar(pci_dev, 0);\r\nif (!dev->mmio) {\r\ndev_err(&pci_dev->dev, "unable to remap PCI region\n");\r\nerr = -ENOMEM;\r\ngoto free_region;\r\n}\r\nreg_write(dev, SYS_SOFT_RST, 0x0f);\r\nmdelay(1);\r\nreg_write(dev, SRST[0], 0x3f);\r\nif (max_channels(dev) > 4)\r\nreg_write(dev, SRST[1], 0x3f);\r\nreg_write(dev, DMA_CMD, 0);\r\nreg_write(dev, DMA_CHANNEL_ENABLE, 0);\r\nreg_write(dev, DMA_CONFIG, 0xffffff04);\r\nreg_write(dev, DMA_CHANNEL_TIMEOUT, 0x140c8584);\r\nreg_write(dev, DMA_TIMER_INTERVAL, dma_interval);\r\nspin_lock_init(&dev->lock);\r\nerr = request_irq(pci_dev->irq, tw686x_irq, IRQF_SHARED,\r\ndev->name, dev);\r\nif (err < 0) {\r\ndev_err(&pci_dev->dev, "unable to request interrupt\n");\r\ngoto iounmap;\r\n}\r\nsetup_timer(&dev->dma_delay_timer,\r\ntw686x_dma_delay, (unsigned long) dev);\r\ndev->v4l2_dev.release = tw686x_dev_release;\r\nerr = tw686x_video_init(dev);\r\nif (err) {\r\ndev_err(&pci_dev->dev, "can't register video\n");\r\ngoto free_irq;\r\n}\r\nerr = tw686x_audio_init(dev);\r\nif (err)\r\ndev_warn(&pci_dev->dev, "can't register audio\n");\r\npci_set_drvdata(pci_dev, dev);\r\nreturn 0;\r\nfree_irq:\r\nfree_irq(pci_dev->irq, dev);\r\niounmap:\r\npci_iounmap(pci_dev, dev->mmio);\r\nfree_region:\r\npci_release_regions(pci_dev);\r\ndisable_pci:\r\npci_disable_device(pci_dev);\r\nfree_audio:\r\nkfree(dev->audio_channels);\r\nfree_video:\r\nkfree(dev->video_channels);\r\nfree_dev:\r\nkfree(dev);\r\nreturn err;\r\n}\r\nstatic void tw686x_remove(struct pci_dev *pci_dev)\r\n{\r\nstruct tw686x_dev *dev = pci_get_drvdata(pci_dev);\r\nunsigned long flags;\r\nfree_irq(pci_dev->irq, dev);\r\ntw686x_video_free(dev);\r\ntw686x_audio_free(dev);\r\ndel_timer_sync(&dev->dma_delay_timer);\r\npci_iounmap(pci_dev, dev->mmio);\r\npci_release_regions(pci_dev);\r\npci_disable_device(pci_dev);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->pci_dev = NULL;\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nv4l2_device_put(&dev->v4l2_dev);\r\n}

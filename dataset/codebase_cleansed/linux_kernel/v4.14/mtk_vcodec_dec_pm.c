int mtk_vcodec_init_dec_pm(struct mtk_vcodec_dev *mtkdev)\r\n{\r\nstruct device_node *node;\r\nstruct platform_device *pdev;\r\nstruct mtk_vcodec_pm *pm;\r\nint ret = 0;\r\npdev = mtkdev->plat_dev;\r\npm = &mtkdev->pm;\r\npm->mtkdev = mtkdev;\r\nnode = of_parse_phandle(pdev->dev.of_node, "mediatek,larb", 0);\r\nif (!node) {\r\nmtk_v4l2_err("of_parse_phandle mediatek,larb fail!");\r\nreturn -1;\r\n}\r\npdev = of_find_device_by_node(node);\r\nif (WARN_ON(!pdev)) {\r\nof_node_put(node);\r\nreturn -1;\r\n}\r\npm->larbvdec = &pdev->dev;\r\npdev = mtkdev->plat_dev;\r\npm->dev = &pdev->dev;\r\npm->vcodecpll = devm_clk_get(&pdev->dev, "vcodecpll");\r\nif (IS_ERR(pm->vcodecpll)) {\r\nmtk_v4l2_err("devm_clk_get vcodecpll fail");\r\nret = PTR_ERR(pm->vcodecpll);\r\n}\r\npm->univpll_d2 = devm_clk_get(&pdev->dev, "univpll_d2");\r\nif (IS_ERR(pm->univpll_d2)) {\r\nmtk_v4l2_err("devm_clk_get univpll_d2 fail");\r\nret = PTR_ERR(pm->univpll_d2);\r\n}\r\npm->clk_cci400_sel = devm_clk_get(&pdev->dev, "clk_cci400_sel");\r\nif (IS_ERR(pm->clk_cci400_sel)) {\r\nmtk_v4l2_err("devm_clk_get clk_cci400_sel fail");\r\nret = PTR_ERR(pm->clk_cci400_sel);\r\n}\r\npm->vdec_sel = devm_clk_get(&pdev->dev, "vdec_sel");\r\nif (IS_ERR(pm->vdec_sel)) {\r\nmtk_v4l2_err("devm_clk_get vdec_sel fail");\r\nret = PTR_ERR(pm->vdec_sel);\r\n}\r\npm->vdecpll = devm_clk_get(&pdev->dev, "vdecpll");\r\nif (IS_ERR(pm->vdecpll)) {\r\nmtk_v4l2_err("devm_clk_get vdecpll fail");\r\nret = PTR_ERR(pm->vdecpll);\r\n}\r\npm->vencpll = devm_clk_get(&pdev->dev, "vencpll");\r\nif (IS_ERR(pm->vencpll)) {\r\nmtk_v4l2_err("devm_clk_get vencpll fail");\r\nret = PTR_ERR(pm->vencpll);\r\n}\r\npm->venc_lt_sel = devm_clk_get(&pdev->dev, "venc_lt_sel");\r\nif (IS_ERR(pm->venc_lt_sel)) {\r\nmtk_v4l2_err("devm_clk_get venc_lt_sel fail");\r\nret = PTR_ERR(pm->venc_lt_sel);\r\n}\r\npm->vdec_bus_clk_src = devm_clk_get(&pdev->dev, "vdec_bus_clk_src");\r\nif (IS_ERR(pm->vdec_bus_clk_src)) {\r\nmtk_v4l2_err("devm_clk_get vdec_bus_clk_src");\r\nret = PTR_ERR(pm->vdec_bus_clk_src);\r\n}\r\npm_runtime_enable(&pdev->dev);\r\nreturn ret;\r\n}\r\nvoid mtk_vcodec_release_dec_pm(struct mtk_vcodec_dev *dev)\r\n{\r\npm_runtime_disable(dev->pm.dev);\r\n}\r\nvoid mtk_vcodec_dec_pw_on(struct mtk_vcodec_pm *pm)\r\n{\r\nint ret;\r\nret = pm_runtime_get_sync(pm->dev);\r\nif (ret)\r\nmtk_v4l2_err("pm_runtime_get_sync fail %d", ret);\r\n}\r\nvoid mtk_vcodec_dec_pw_off(struct mtk_vcodec_pm *pm)\r\n{\r\nint ret;\r\nret = pm_runtime_put_sync(pm->dev);\r\nif (ret)\r\nmtk_v4l2_err("pm_runtime_put_sync fail %d", ret);\r\n}\r\nvoid mtk_vcodec_dec_clock_on(struct mtk_vcodec_pm *pm)\r\n{\r\nint ret;\r\nret = clk_set_rate(pm->vcodecpll, 1482 * 1000000);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_rate vcodecpll fail %d", ret);\r\nret = clk_set_rate(pm->vencpll, 800 * 1000000);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_rate vencpll fail %d", ret);\r\nret = clk_prepare_enable(pm->vcodecpll);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable vcodecpll fail %d", ret);\r\nret = clk_prepare_enable(pm->vencpll);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable vencpll fail %d", ret);\r\nret = clk_prepare_enable(pm->vdec_bus_clk_src);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable vdec_bus_clk_src fail %d",\r\nret);\r\nret = clk_prepare_enable(pm->venc_lt_sel);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable venc_lt_sel fail %d", ret);\r\nret = clk_set_parent(pm->venc_lt_sel, pm->vdec_bus_clk_src);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_parent venc_lt_sel vdec_bus_clk_src fail %d",\r\nret);\r\nret = clk_prepare_enable(pm->univpll_d2);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable univpll_d2 fail %d", ret);\r\nret = clk_prepare_enable(pm->clk_cci400_sel);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable clk_cci400_sel fail %d", ret);\r\nret = clk_set_parent(pm->clk_cci400_sel, pm->univpll_d2);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_parent clk_cci400_sel univpll_d2 fail %d",\r\nret);\r\nret = clk_prepare_enable(pm->vdecpll);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable vdecpll fail %d", ret);\r\nret = clk_prepare_enable(pm->vdec_sel);\r\nif (ret)\r\nmtk_v4l2_err("clk_prepare_enable vdec_sel fail %d", ret);\r\nret = clk_set_parent(pm->vdec_sel, pm->vdecpll);\r\nif (ret)\r\nmtk_v4l2_err("clk_set_parent vdec_sel vdecpll fail %d", ret);\r\nret = mtk_smi_larb_get(pm->larbvdec);\r\nif (ret)\r\nmtk_v4l2_err("mtk_smi_larb_get larbvdec fail %d", ret);\r\n}\r\nvoid mtk_vcodec_dec_clock_off(struct mtk_vcodec_pm *pm)\r\n{\r\nmtk_smi_larb_put(pm->larbvdec);\r\nclk_disable_unprepare(pm->vdec_sel);\r\nclk_disable_unprepare(pm->vdecpll);\r\nclk_disable_unprepare(pm->univpll_d2);\r\nclk_disable_unprepare(pm->clk_cci400_sel);\r\nclk_disable_unprepare(pm->venc_lt_sel);\r\nclk_disable_unprepare(pm->vdec_bus_clk_src);\r\nclk_disable_unprepare(pm->vencpll);\r\nclk_disable_unprepare(pm->vcodecpll);\r\n}

static int ili922x_read_status(struct spi_device *spi, u16 *rs)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer;\r\nunsigned char tbuf[CMD_BUFSIZE];\r\nunsigned char rbuf[CMD_BUFSIZE];\r\nint ret, i;\r\nmemset(&xfer, 0, sizeof(struct spi_transfer));\r\nspi_message_init(&msg);\r\nxfer.tx_buf = tbuf;\r\nxfer.rx_buf = rbuf;\r\nxfer.cs_change = 1;\r\nCHECK_FREQ_REG(spi, &xfer);\r\ntbuf[0] = set_tx_byte(START_BYTE(ili922x_id, START_RS_INDEX,\r\nSTART_RW_READ));\r\nfor (i = 1; i < 4; i++)\r\ntbuf[i] = set_tx_byte(0);\r\nxfer.bits_per_word = 8;\r\nxfer.len = 4;\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(spi, &msg);\r\nif (ret < 0) {\r\ndev_dbg(&spi->dev, "Error sending SPI message 0x%x", ret);\r\nreturn ret;\r\n}\r\n*rs = (rbuf[2] << 8) + rbuf[3];\r\nreturn 0;\r\n}\r\nstatic int ili922x_read(struct spi_device *spi, u8 reg, u16 *rx)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer_regindex, xfer_regvalue;\r\nunsigned char tbuf[CMD_BUFSIZE];\r\nunsigned char rbuf[CMD_BUFSIZE];\r\nint ret, len = 0, send_bytes;\r\nmemset(&xfer_regindex, 0, sizeof(struct spi_transfer));\r\nmemset(&xfer_regvalue, 0, sizeof(struct spi_transfer));\r\nspi_message_init(&msg);\r\nxfer_regindex.tx_buf = tbuf;\r\nxfer_regindex.rx_buf = rbuf;\r\nxfer_regindex.cs_change = 1;\r\nCHECK_FREQ_REG(spi, &xfer_regindex);\r\ntbuf[0] = set_tx_byte(START_BYTE(ili922x_id, START_RS_INDEX,\r\nSTART_RW_WRITE));\r\ntbuf[1] = set_tx_byte(0);\r\ntbuf[2] = set_tx_byte(reg);\r\nxfer_regindex.bits_per_word = 8;\r\nlen = xfer_regindex.len = 3;\r\nspi_message_add_tail(&xfer_regindex, &msg);\r\nsend_bytes = len;\r\ntbuf[len++] = set_tx_byte(START_BYTE(ili922x_id, START_RS_REG,\r\nSTART_RW_READ));\r\ntbuf[len++] = set_tx_byte(0);\r\ntbuf[len] = set_tx_byte(0);\r\nxfer_regvalue.cs_change = 1;\r\nxfer_regvalue.len = 3;\r\nxfer_regvalue.tx_buf = &tbuf[send_bytes];\r\nxfer_regvalue.rx_buf = &rbuf[send_bytes];\r\nCHECK_FREQ_REG(spi, &xfer_regvalue);\r\nspi_message_add_tail(&xfer_regvalue, &msg);\r\nret = spi_sync(spi, &msg);\r\nif (ret < 0) {\r\ndev_dbg(&spi->dev, "Error sending SPI message 0x%x", ret);\r\nreturn ret;\r\n}\r\n*rx = (rbuf[1 + send_bytes] << 8) + rbuf[2 + send_bytes];\r\nreturn 0;\r\n}\r\nstatic int ili922x_write(struct spi_device *spi, u8 reg, u16 value)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer_regindex, xfer_regvalue;\r\nunsigned char tbuf[CMD_BUFSIZE];\r\nunsigned char rbuf[CMD_BUFSIZE];\r\nint ret, len = 0;\r\nmemset(&xfer_regindex, 0, sizeof(struct spi_transfer));\r\nmemset(&xfer_regvalue, 0, sizeof(struct spi_transfer));\r\nspi_message_init(&msg);\r\nxfer_regindex.tx_buf = tbuf;\r\nxfer_regindex.rx_buf = rbuf;\r\nxfer_regindex.cs_change = 1;\r\nCHECK_FREQ_REG(spi, &xfer_regindex);\r\ntbuf[0] = set_tx_byte(START_BYTE(ili922x_id, START_RS_INDEX,\r\nSTART_RW_WRITE));\r\ntbuf[1] = set_tx_byte(0);\r\ntbuf[2] = set_tx_byte(reg);\r\nxfer_regindex.bits_per_word = 8;\r\nxfer_regindex.len = 3;\r\nspi_message_add_tail(&xfer_regindex, &msg);\r\nret = spi_sync(spi, &msg);\r\nspi_message_init(&msg);\r\nlen = 0;\r\ntbuf[0] = set_tx_byte(START_BYTE(ili922x_id, START_RS_REG,\r\nSTART_RW_WRITE));\r\ntbuf[1] = set_tx_byte((value & 0xFF00) >> 8);\r\ntbuf[2] = set_tx_byte(value & 0x00FF);\r\nxfer_regvalue.cs_change = 1;\r\nxfer_regvalue.len = 3;\r\nxfer_regvalue.tx_buf = tbuf;\r\nxfer_regvalue.rx_buf = rbuf;\r\nCHECK_FREQ_REG(spi, &xfer_regvalue);\r\nspi_message_add_tail(&xfer_regvalue, &msg);\r\nret = spi_sync(spi, &msg);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "Error sending SPI message 0x%x", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ili922x_reg_dump(struct spi_device *spi)\r\n{\r\nu8 reg;\r\nu16 rx;\r\ndev_dbg(&spi->dev, "ILI922x configuration registers:\n");\r\nfor (reg = REG_START_OSCILLATION;\r\nreg <= REG_OTP_PROGRAMMING_ID_KEY; reg++) {\r\nili922x_read(spi, reg, &rx);\r\ndev_dbg(&spi->dev, "reg @ 0x%02X: 0x%04X\n", reg, rx);\r\n}\r\n}\r\nstatic inline void ili922x_reg_dump(struct spi_device *spi) {}\r\nstatic void set_write_to_gram_reg(struct spi_device *spi)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer;\r\nunsigned char tbuf[CMD_BUFSIZE];\r\nmemset(&xfer, 0, sizeof(struct spi_transfer));\r\nspi_message_init(&msg);\r\nxfer.tx_buf = tbuf;\r\nxfer.rx_buf = NULL;\r\nxfer.cs_change = 1;\r\ntbuf[0] = START_BYTE(ili922x_id, START_RS_INDEX, START_RW_WRITE);\r\ntbuf[1] = 0;\r\ntbuf[2] = REG_WRITE_DATA_TO_GRAM;\r\nxfer.bits_per_word = 8;\r\nxfer.len = 3;\r\nspi_message_add_tail(&xfer, &msg);\r\nspi_sync(spi, &msg);\r\n}\r\nstatic int ili922x_poweron(struct spi_device *spi)\r\n{\r\nint ret;\r\nret = ili922x_write(spi, REG_POWER_CONTROL_1, 0x0000);\r\nusleep_range(10000, 10500);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_2, 0x0000);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_3, 0x0000);\r\nmsleep(40);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_4, 0x0000);\r\nmsleep(40);\r\nret += ili922x_write(spi, 0x56, 0x080F);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_1, 0x4240);\r\nusleep_range(10000, 10500);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_2, 0x0000);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_3, 0x0014);\r\nmsleep(40);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_4, 0x1319);\r\nmsleep(40);\r\nreturn ret;\r\n}\r\nstatic int ili922x_poweroff(struct spi_device *spi)\r\n{\r\nint ret;\r\nret = ili922x_write(spi, REG_POWER_CONTROL_1, 0x0000);\r\nusleep_range(10000, 10500);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_2, 0x0000);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_3, 0x0000);\r\nmsleep(40);\r\nret += ili922x_write(spi, REG_POWER_CONTROL_4, 0x0000);\r\nmsleep(40);\r\nreturn ret;\r\n}\r\nstatic void ili922x_display_init(struct spi_device *spi)\r\n{\r\nili922x_write(spi, REG_START_OSCILLATION, 1);\r\nusleep_range(10000, 10500);\r\nili922x_write(spi, REG_DRIVER_OUTPUT_CONTROL, 0x691B);\r\nili922x_write(spi, REG_LCD_AC_DRIVEING_CONTROL, 0x0700);\r\nili922x_write(spi, REG_ENTRY_MODE, 0x1030);\r\nili922x_write(spi, REG_COMPARE_1, 0x0000);\r\nili922x_write(spi, REG_COMPARE_2, 0x0000);\r\nili922x_write(spi, REG_DISPLAY_CONTROL_1, 0x0037);\r\nili922x_write(spi, REG_DISPLAY_CONTROL_2, 0x0202);\r\nili922x_write(spi, REG_DISPLAY_CONTROL_3, 0x0000);\r\nili922x_write(spi, REG_FRAME_CYCLE_CONTROL, 0x0000);\r\nili922x_write(spi, REG_EXT_INTF_CONTROL, 0x0110);\r\nili922x_poweron(spi);\r\nili922x_write(spi, REG_GAMMA_CONTROL_1, 0x0302);\r\nili922x_write(spi, REG_GAMMA_CONTROL_2, 0x0407);\r\nili922x_write(spi, REG_GAMMA_CONTROL_3, 0x0304);\r\nili922x_write(spi, REG_GAMMA_CONTROL_4, 0x0203);\r\nili922x_write(spi, REG_GAMMA_CONTROL_5, 0x0706);\r\nili922x_write(spi, REG_GAMMA_CONTROL_6, 0x0407);\r\nili922x_write(spi, REG_GAMMA_CONTROL_7, 0x0706);\r\nili922x_write(spi, REG_GAMMA_CONTROL_8, 0x0000);\r\nili922x_write(spi, REG_GAMMA_CONTROL_9, 0x0C06);\r\nili922x_write(spi, REG_GAMMA_CONTROL_10, 0x0F00);\r\nili922x_write(spi, REG_RAM_ADDRESS_SET, 0x0000);\r\nili922x_write(spi, REG_GATE_SCAN_CONTROL, 0x0000);\r\nili922x_write(spi, REG_VERT_SCROLL_CONTROL, 0x0000);\r\nili922x_write(spi, REG_FIRST_SCREEN_DRIVE_POS, 0xDB00);\r\nili922x_write(spi, REG_SECOND_SCREEN_DRIVE_POS, 0xDB00);\r\nili922x_write(spi, REG_RAM_ADDR_POS_H, 0xAF00);\r\nili922x_write(spi, REG_RAM_ADDR_POS_V, 0xDB00);\r\nili922x_reg_dump(spi);\r\nset_write_to_gram_reg(spi);\r\n}\r\nstatic int ili922x_lcd_power(struct ili922x *lcd, int power)\r\n{\r\nint ret = 0;\r\nif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->power))\r\nret = ili922x_poweron(lcd->spi);\r\nelse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->power))\r\nret = ili922x_poweroff(lcd->spi);\r\nif (!ret)\r\nlcd->power = power;\r\nreturn ret;\r\n}\r\nstatic int ili922x_set_power(struct lcd_device *ld, int power)\r\n{\r\nstruct ili922x *ili = lcd_get_data(ld);\r\nreturn ili922x_lcd_power(ili, power);\r\n}\r\nstatic int ili922x_get_power(struct lcd_device *ld)\r\n{\r\nstruct ili922x *ili = lcd_get_data(ld);\r\nreturn ili->power;\r\n}\r\nstatic int ili922x_probe(struct spi_device *spi)\r\n{\r\nstruct ili922x *ili;\r\nstruct lcd_device *lcd;\r\nint ret;\r\nu16 reg = 0;\r\nili = devm_kzalloc(&spi->dev, sizeof(*ili), GFP_KERNEL);\r\nif (!ili)\r\nreturn -ENOMEM;\r\nili->spi = spi;\r\nspi_set_drvdata(spi, ili);\r\nret = ili922x_read(spi, REG_DRIVER_CODE_READ, &reg);\r\nif (ret || ((reg & ILITEK_DEVICE_ID_MASK) != ILITEK_DEVICE_ID)) {\r\ndev_err(&spi->dev,\r\n"no LCD found: Chip ID 0x%x, ret %d\n",\r\nreg, ret);\r\nreturn -ENODEV;\r\n}\r\ndev_info(&spi->dev, "ILI%x found, SPI freq %d, mode %d\n",\r\nreg, spi->max_speed_hz, spi->mode);\r\nret = ili922x_read_status(spi, &reg);\r\nif (ret) {\r\ndev_err(&spi->dev, "reading RS failed...\n");\r\nreturn ret;\r\n}\r\ndev_dbg(&spi->dev, "status: 0x%x\n", reg);\r\nili922x_display_init(spi);\r\nili->power = FB_BLANK_POWERDOWN;\r\nlcd = devm_lcd_device_register(&spi->dev, "ili922xlcd", &spi->dev, ili,\r\n&ili922x_ops);\r\nif (IS_ERR(lcd)) {\r\ndev_err(&spi->dev, "cannot register LCD\n");\r\nreturn PTR_ERR(lcd);\r\n}\r\nili->ld = lcd;\r\nspi_set_drvdata(spi, ili);\r\nili922x_lcd_power(ili, FB_BLANK_UNBLANK);\r\nreturn 0;\r\n}\r\nstatic int ili922x_remove(struct spi_device *spi)\r\n{\r\nili922x_poweroff(spi);\r\nreturn 0;\r\n}

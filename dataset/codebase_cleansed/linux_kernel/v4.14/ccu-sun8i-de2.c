static int sunxi_de2_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct clk *bus_clk, *mod_clk;\r\nstruct reset_control *rstc;\r\nvoid __iomem *reg;\r\nconst struct sunxi_ccu_desc *ccu_desc;\r\nint ret;\r\nccu_desc = of_device_get_match_data(&pdev->dev);\r\nif (!ccu_desc)\r\nreturn -EINVAL;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nreg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(reg))\r\nreturn PTR_ERR(reg);\r\nbus_clk = devm_clk_get(&pdev->dev, "bus");\r\nif (IS_ERR(bus_clk)) {\r\nret = PTR_ERR(bus_clk);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "Couldn't get bus clk: %d\n", ret);\r\nreturn ret;\r\n}\r\nmod_clk = devm_clk_get(&pdev->dev, "mod");\r\nif (IS_ERR(mod_clk)) {\r\nret = PTR_ERR(mod_clk);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "Couldn't get mod clk: %d\n", ret);\r\nreturn ret;\r\n}\r\nrstc = devm_reset_control_get_exclusive(&pdev->dev, NULL);\r\nif (IS_ERR(rstc)) {\r\nret = PTR_ERR(rstc);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(&pdev->dev,\r\n"Couldn't get reset control: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(bus_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Couldn't enable bus clk: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(mod_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Couldn't enable mod clk: %d\n", ret);\r\ngoto err_disable_bus_clk;\r\n}\r\nret = reset_control_deassert(rstc);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Couldn't deassert reset control: %d\n", ret);\r\ngoto err_disable_mod_clk;\r\n}\r\nret = sunxi_ccu_probe(pdev->dev.of_node, reg, ccu_desc);\r\nif (ret)\r\ngoto err_assert_reset;\r\nreturn 0;\r\nerr_assert_reset:\r\nreset_control_assert(rstc);\r\nerr_disable_mod_clk:\r\nclk_disable_unprepare(mod_clk);\r\nerr_disable_bus_clk:\r\nclk_disable_unprepare(bus_clk);\r\nreturn ret;\r\n}

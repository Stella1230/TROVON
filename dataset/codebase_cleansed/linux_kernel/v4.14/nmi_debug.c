static int nmi_debug_notify(struct notifier_block *self,\r\nunsigned long val, void *data)\r\n{\r\nstruct die_args *args = data;\r\nif (likely(val != DIE_NMI))\r\nreturn NOTIFY_DONE;\r\nif (nmi_actions & NMI_SHOW_STATE)\r\nshow_state();\r\nif (nmi_actions & NMI_SHOW_REGS)\r\nshow_regs(args->regs);\r\nif (nmi_actions & NMI_DEBOUNCE)\r\nmdelay(10);\r\nif (nmi_actions & NMI_DIE)\r\nreturn NOTIFY_BAD;\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init nmi_debug_setup(char *str)\r\n{\r\nchar *p, *sep;\r\nregister_die_notifier(&nmi_debug_nb);\r\nif (*str != '=')\r\nreturn 0;\r\nfor (p = str + 1; *p; p = sep + 1) {\r\nsep = strchr(p, ',');\r\nif (sep)\r\n*sep = 0;\r\nif (strcmp(p, "state") == 0)\r\nnmi_actions |= NMI_SHOW_STATE;\r\nelse if (strcmp(p, "regs") == 0)\r\nnmi_actions |= NMI_SHOW_REGS;\r\nelse if (strcmp(p, "debounce") == 0)\r\nnmi_actions |= NMI_DEBOUNCE;\r\nelse if (strcmp(p, "die") == 0)\r\nnmi_actions |= NMI_DIE;\r\nelse\r\nprintk(KERN_WARNING "NMI: Unrecognized action `%s'\n",\r\np);\r\nif (!sep)\r\nbreak;\r\n}\r\nreturn 0;\r\n}

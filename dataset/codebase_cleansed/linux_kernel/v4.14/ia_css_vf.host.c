void\r\nia_css_vf_config(\r\nstruct sh_css_isp_vf_isp_config *to,\r\nconst struct ia_css_vf_configuration *from,\r\nunsigned size)\r\n{\r\nunsigned elems_a = ISP_VEC_NELEMS;\r\n(void)size;\r\nto->vf_downscale_bits = from->vf_downscale_bits;\r\nto->enable = from->info != NULL;\r\nif (from->info) {\r\nia_css_frame_info_to_frame_sp_info(&to->info, from->info);\r\nia_css_dma_configure_from_info(&to->dma.port_b, from->info);\r\nto->dma.width_a_over_b = elems_a / to->dma.port_b.elems;\r\nassert (elems_a % to->dma.port_b.elems == 0);\r\n}\r\n}\r\nenum ia_css_err\r\nsh_css_vf_downscale_log2(\r\nconst struct ia_css_frame_info *out_info,\r\nconst struct ia_css_frame_info *vf_info,\r\nunsigned int *downscale_log2)\r\n{\r\nunsigned int ds_log2 = 0;\r\nunsigned int out_width;\r\nif ((out_info == NULL) | (vf_info == NULL))\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nout_width = out_info->res.width;\r\nif (out_width == 0)\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\nwhile (out_width >= vf_info->res.width) {\r\nds_log2++;\r\nout_width /= 2;\r\n}\r\nif ((ds_log2 > 0) && (out_width < ia_css_binary_max_vf_width()))\r\nds_log2--;\r\nif ((out_info->res.width >> ds_log2) >= 2 * ia_css_binary_max_vf_width())\r\nreturn IA_CSS_ERR_INVALID_ARGUMENTS;\r\n*downscale_log2 = ds_log2;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic enum ia_css_err\r\nconfigure_kernel(\r\nconst struct ia_css_binary_info *info,\r\nconst struct ia_css_frame_info *out_info,\r\nconst struct ia_css_frame_info *vf_info,\r\nunsigned int *downscale_log2,\r\nstruct ia_css_vf_configuration *config)\r\n{\r\nenum ia_css_err err;\r\nunsigned vf_log_ds = 0;\r\nif (vf_info) {\r\nerr = sh_css_vf_downscale_log2(out_info, vf_info, &vf_log_ds);\r\nif (err != IA_CSS_SUCCESS)\r\nreturn err;\r\n}\r\nvf_log_ds = min(vf_log_ds, info->vf_dec.max_log_downscale);\r\n*downscale_log2 = vf_log_ds;\r\nconfig->vf_downscale_bits = vf_log_ds;\r\nreturn IA_CSS_SUCCESS;\r\n}\r\nstatic void\r\nconfigure_dma(\r\nstruct ia_css_vf_configuration *config,\r\nconst struct ia_css_frame_info *vf_info)\r\n{\r\nconfig->info = vf_info;\r\n}\r\nenum ia_css_err\r\nia_css_vf_configure(\r\nconst struct ia_css_binary *binary,\r\nconst struct ia_css_frame_info *out_info,\r\nstruct ia_css_frame_info *vf_info,\r\nunsigned int *downscale_log2)\r\n{\r\nenum ia_css_err err;\r\nstruct ia_css_vf_configuration config;\r\nconst struct ia_css_binary_info *info = &binary->info->sp;\r\nerr = configure_kernel(info, out_info, vf_info, downscale_log2, &config);\r\nconfigure_dma(&config, vf_info);\r\nif (binary) {\r\nif (vf_info)\r\nvf_info->raw_bit_depth = info->dma.vfdec_bits_per_pixel;\r\nia_css_configure_vf (binary, &config);\r\n}\r\nreturn IA_CSS_SUCCESS;\r\n}

static u32 phy_CalculateBitShift(u32 BitMask)\r\n{\r\nu32 i;\r\nfor (i = 0; i <= 31; i++) {\r\nif (((BitMask>>i) & 0x1) == 1)\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nu32 PHY_QueryBBReg_8723B(struct adapter *Adapter, u32 RegAddr, u32 BitMask)\r\n{\r\nu32 ReturnValue = 0, OriginalValue, BitShift;\r\n#if (DISABLE_BB_RF == 1)\r\nreturn 0;\r\n#endif\r\nOriginalValue = rtw_read32(Adapter, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nReturnValue = (OriginalValue & BitMask) >> BitShift;\r\nreturn ReturnValue;\r\n}\r\nvoid PHY_SetBBReg_8723B(\r\nstruct adapter *Adapter,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Data\r\n)\r\n{\r\nu32 OriginalValue, BitShift;\r\n#if (DISABLE_BB_RF == 1)\r\nreturn;\r\n#endif\r\nif (BitMask != bMaskDWord) {\r\nOriginalValue = rtw_read32(Adapter, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nData = ((OriginalValue & (~BitMask)) | ((Data << BitShift) & BitMask));\r\n}\r\nrtw_write32(Adapter, RegAddr, Data);\r\n}\r\nstatic u32 phy_RFSerialRead_8723B(\r\nstruct adapter *Adapter, enum RF_PATH eRFPath, u32 Offset\r\n)\r\n{\r\nu32 retValue = 0;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nstruct bb_register_def *pPhyReg = &pHalData->PHYRegDef[eRFPath];\r\nu32 NewOffset;\r\nu32 tmplong2;\r\nu8 RfPiEnable = 0;\r\nu32 MaskforPhySet = 0;\r\nint i = 0;\r\nOffset &= 0xff;\r\nNewOffset = Offset;\r\nif (eRFPath == RF_PATH_A) {\r\ntmplong2 = PHY_QueryBBReg(Adapter, rFPGA0_XA_HSSIParameter2|MaskforPhySet, bMaskDWord);;\r\ntmplong2 = (tmplong2 & (~bLSSIReadAddress)) | (NewOffset<<23) | bLSSIReadEdge;\r\nPHY_SetBBReg(Adapter, rFPGA0_XA_HSSIParameter2|MaskforPhySet, bMaskDWord, tmplong2&(~bLSSIReadEdge));\r\n} else {\r\ntmplong2 = PHY_QueryBBReg(Adapter, rFPGA0_XB_HSSIParameter2|MaskforPhySet, bMaskDWord);\r\ntmplong2 = (tmplong2 & (~bLSSIReadAddress)) | (NewOffset<<23) | bLSSIReadEdge;\r\nPHY_SetBBReg(Adapter, rFPGA0_XB_HSSIParameter2|MaskforPhySet, bMaskDWord, tmplong2&(~bLSSIReadEdge));\r\n}\r\ntmplong2 = PHY_QueryBBReg(Adapter, rFPGA0_XA_HSSIParameter2|MaskforPhySet, bMaskDWord);\r\nPHY_SetBBReg(Adapter, rFPGA0_XA_HSSIParameter2|MaskforPhySet, bMaskDWord, tmplong2 & (~bLSSIReadEdge));\r\nPHY_SetBBReg(Adapter, rFPGA0_XA_HSSIParameter2|MaskforPhySet, bMaskDWord, tmplong2 | bLSSIReadEdge);\r\nudelay(10);\r\nfor (i = 0; i < 2; i++)\r\nudelay(MAX_STALL_TIME);\r\nudelay(10);\r\nif (eRFPath == RF_PATH_A)\r\nRfPiEnable = (u8)PHY_QueryBBReg(Adapter, rFPGA0_XA_HSSIParameter1|MaskforPhySet, BIT8);\r\nelse if (eRFPath == RF_PATH_B)\r\nRfPiEnable = (u8)PHY_QueryBBReg(Adapter, rFPGA0_XB_HSSIParameter1|MaskforPhySet, BIT8);\r\nif (RfPiEnable) {\r\nretValue = PHY_QueryBBReg(Adapter, pPhyReg->rfLSSIReadBackPi|MaskforPhySet, bLSSIReadBackData);\r\n} else {\r\nretValue = PHY_QueryBBReg(Adapter, pPhyReg->rfLSSIReadBack|MaskforPhySet, bLSSIReadBackData);\r\n}\r\nreturn retValue;\r\n}\r\nstatic void phy_RFSerialWrite_8723B(\r\nstruct adapter *Adapter,\r\nenum RF_PATH eRFPath,\r\nu32 Offset,\r\nu32 Data\r\n)\r\n{\r\nu32 DataAndAddr = 0;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nstruct bb_register_def *pPhyReg = &pHalData->PHYRegDef[eRFPath];\r\nu32 NewOffset;\r\nOffset &= 0xff;\r\nNewOffset = Offset;\r\nDataAndAddr = ((NewOffset<<20) | (Data&0x000fffff)) & 0x0fffffff;\r\nPHY_SetBBReg(Adapter, pPhyReg->rf3wireOffset, bMaskDWord, DataAndAddr);\r\n}\r\nu32 PHY_QueryRFReg_8723B(\r\nstruct adapter *Adapter,\r\nu8 eRFPath,\r\nu32 RegAddr,\r\nu32 BitMask\r\n)\r\n{\r\nu32 Original_Value, Readback_Value, BitShift;\r\n#if (DISABLE_BB_RF == 1)\r\nreturn 0;\r\n#endif\r\nOriginal_Value = phy_RFSerialRead_8723B(Adapter, eRFPath, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nReadback_Value = (Original_Value & BitMask) >> BitShift;\r\nreturn Readback_Value;\r\n}\r\nvoid PHY_SetRFReg_8723B(\r\nstruct adapter *Adapter,\r\nu8 eRFPath,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Data\r\n)\r\n{\r\nu32 Original_Value, BitShift;\r\n#if (DISABLE_BB_RF == 1)\r\nreturn;\r\n#endif\r\nif (BitMask != bRFRegOffsetMask) {\r\nOriginal_Value = phy_RFSerialRead_8723B(Adapter, eRFPath, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nData = ((Original_Value & (~BitMask)) | (Data<<BitShift));\r\n}\r\nphy_RFSerialWrite_8723B(Adapter, eRFPath, RegAddr, Data);\r\n}\r\ns32 PHY_MACConfig8723B(struct adapter *Adapter)\r\n{\r\nint rtStatus = _SUCCESS;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\ns8 *pszMACRegFile;\r\ns8 sz8723MACRegFile[] = RTL8723B_PHY_MACREG;\r\npszMACRegFile = sz8723MACRegFile;\r\nrtStatus = phy_ConfigMACWithParaFile(Adapter, pszMACRegFile);\r\nif (rtStatus == _FAIL) {\r\nODM_ConfigMACWithHeaderFile(&pHalData->odmpriv);\r\nrtStatus = _SUCCESS;\r\n}\r\nreturn rtStatus;\r\n}\r\nstatic void phy_InitBBRFRegisterDefinition(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfintfs = rFPGA0_XAB_RFInterfaceSW;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfintfs = rFPGA0_XAB_RFInterfaceSW;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfintfo = rFPGA0_XA_RFInterfaceOE;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfintfo = rFPGA0_XB_RFInterfaceOE;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfintfe = rFPGA0_XA_RFInterfaceOE;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfintfe = rFPGA0_XB_RFInterfaceOE;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rf3wireOffset = rFPGA0_XA_LSSIParameter;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rf3wireOffset = rFPGA0_XB_LSSIParameter;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfHSSIPara2 = rFPGA0_XA_HSSIParameter2;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfHSSIPara2 = rFPGA0_XB_HSSIParameter2;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfLSSIReadBack = rFPGA0_XA_LSSIReadBack;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfLSSIReadBack = rFPGA0_XB_LSSIReadBack;\r\npHalData->PHYRegDef[ODM_RF_PATH_A].rfLSSIReadBackPi = TransceiverA_HSPI_Readback;\r\npHalData->PHYRegDef[ODM_RF_PATH_B].rfLSSIReadBackPi = TransceiverB_HSPI_Readback;\r\n}\r\nstatic int phy_BB8723b_Config_ParaFile(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nint rtStatus = _SUCCESS;\r\nu8 sz8723BBRegFile[] = RTL8723B_PHY_REG;\r\nu8 sz8723AGCTableFile[] = RTL8723B_AGC_TAB;\r\nu8 sz8723BBBRegPgFile[] = RTL8723B_PHY_REG_PG;\r\nu8 sz8723BBRegMpFile[] = RTL8723B_PHY_REG_MP;\r\nu8 sz8723BRFTxPwrLmtFile[] = RTL8723B_TXPWR_LMT;\r\nu8 *pszBBRegFile = NULL, *pszAGCTableFile = NULL, *pszBBRegPgFile = NULL, *pszBBRegMpFile = NULL, *pszRFTxPwrLmtFile = NULL;\r\npszBBRegFile = sz8723BBRegFile;\r\npszAGCTableFile = sz8723AGCTableFile;\r\npszBBRegPgFile = sz8723BBBRegPgFile;\r\npszBBRegMpFile = sz8723BBRegMpFile;\r\npszRFTxPwrLmtFile = sz8723BRFTxPwrLmtFile;\r\nPHY_InitTxPowerLimit(Adapter);\r\nif (\r\nAdapter->registrypriv.RegEnableTxPowerLimit == 1 ||\r\n(Adapter->registrypriv.RegEnableTxPowerLimit == 2 && pHalData->EEPROMRegulatory == 1)\r\n) {\r\nif (PHY_ConfigRFWithPowerLimitTableParaFile(Adapter, pszRFTxPwrLmtFile) == _FAIL) {\r\nif (HAL_STATUS_SUCCESS != ODM_ConfigRFWithHeaderFile(&pHalData->odmpriv, CONFIG_RF_TXPWR_LMT, (ODM_RF_RADIO_PATH_E)0))\r\nrtStatus = _FAIL;\r\n}\r\nif (rtStatus != _SUCCESS) {\r\nDBG_871X("%s():Read Tx power limit fail\n", __func__);\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\n}\r\n}\r\nif (phy_ConfigBBWithParaFile(Adapter, pszBBRegFile, CONFIG_BB_PHY_REG) ==\r\n_FAIL) {\r\nif (HAL_STATUS_SUCCESS != ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_PHY_REG))\r\nrtStatus = _FAIL;\r\n}\r\nif (rtStatus != _SUCCESS) {\r\nDBG_8192C("%s():Write BB Reg Fail!!", __func__);\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\n}\r\nPHY_InitTxPowerByRate(Adapter);\r\nif (\r\nAdapter->registrypriv.RegEnableTxPowerByRate == 1 ||\r\n(Adapter->registrypriv.RegEnableTxPowerByRate == 2 && pHalData->EEPROMRegulatory != 2)\r\n) {\r\nif (phy_ConfigBBWithPgParaFile(Adapter, pszBBRegPgFile) ==\r\n_FAIL) {\r\nif (HAL_STATUS_SUCCESS != ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_PHY_REG_PG))\r\nrtStatus = _FAIL;\r\n}\r\nif (pHalData->odmpriv.PhyRegPgValueType == PHY_REG_PG_EXACT_VALUE)\r\nPHY_TxPowerByRateConfiguration(Adapter);\r\nif (\r\nAdapter->registrypriv.RegEnableTxPowerLimit == 1 ||\r\n(Adapter->registrypriv.RegEnableTxPowerLimit == 2 && pHalData->EEPROMRegulatory == 1)\r\n)\r\nPHY_ConvertTxPowerLimitToPowerIndex(Adapter);\r\nif (rtStatus != _SUCCESS) {\r\nDBG_8192C("%s():BB_PG Reg Fail!!\n", __func__);\r\n}\r\n}\r\nif (phy_ConfigBBWithParaFile(Adapter, pszAGCTableFile,\r\nCONFIG_BB_AGC_TAB) == _FAIL) {\r\nif (HAL_STATUS_SUCCESS != ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_AGC_TAB))\r\nrtStatus = _FAIL;\r\n}\r\nif (rtStatus != _SUCCESS) {\r\nDBG_8192C("%s():AGC Table Fail\n", __func__);\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\n}\r\nphy_BB8190_Config_ParaFile_Fail:\r\nreturn rtStatus;\r\n}\r\nint PHY_BBConfig8723B(struct adapter *Adapter)\r\n{\r\nint rtStatus = _SUCCESS;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu32 RegVal;\r\nu8 CrystalCap;\r\nphy_InitBBRFRegisterDefinition(Adapter);\r\nRegVal = rtw_read16(Adapter, REG_SYS_FUNC_EN);\r\nrtw_write16(Adapter, REG_SYS_FUNC_EN, (u16)(RegVal|BIT13|BIT0|BIT1));\r\nrtw_write32(Adapter, 0x948, 0x280);\r\nrtw_write8(Adapter, REG_RF_CTRL, RF_EN|RF_RSTB|RF_SDMRSTB);\r\nmsleep(1);\r\nPHY_SetRFReg(Adapter, ODM_RF_PATH_A, 0x1, 0xfffff, 0x780);\r\nrtw_write8(Adapter, REG_SYS_FUNC_EN, FEN_PPLL|FEN_PCIEA|FEN_DIO_PCIE|FEN_BB_GLB_RSTn|FEN_BBRSTB);\r\nrtw_write8(Adapter, REG_AFE_XTAL_CTRL+1, 0x80);\r\nrtStatus = phy_BB8723b_Config_ParaFile(Adapter);\r\nCrystalCap = pHalData->CrystalCap & 0x3F;\r\nPHY_SetBBReg(Adapter, REG_MAC_PHY_CTRL, 0xFFF000, (CrystalCap | (CrystalCap << 6)));\r\nreturn rtStatus;\r\n}\r\nstatic void phy_LCK_8723B(struct adapter *Adapter)\r\n{\r\nPHY_SetRFReg(Adapter, RF_PATH_A, 0xB0, bRFRegOffsetMask, 0xDFBE0);\r\nPHY_SetRFReg(Adapter, RF_PATH_A, RF_CHNLBW, bRFRegOffsetMask, 0x8C01);\r\nmdelay(200);\r\nPHY_SetRFReg(Adapter, RF_PATH_A, 0xB0, bRFRegOffsetMask, 0xDFFE0);\r\n}\r\nint PHY_RFConfig8723B(struct adapter *Adapter)\r\n{\r\nint rtStatus = _SUCCESS;\r\nrtStatus = PHY_RF6052_Config8723B(Adapter);\r\nphy_LCK_8723B(Adapter);\r\nreturn rtStatus;\r\n}\r\nvoid PHY_SetTxPowerIndex_8723B(\r\nstruct adapter *Adapter,\r\nu32 PowerIndex,\r\nu8 RFPath,\r\nu8 Rate\r\n)\r\n{\r\nif (RFPath == ODM_RF_PATH_A || RFPath == ODM_RF_PATH_B) {\r\nswitch (Rate) {\r\ncase MGN_1M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_CCK1_Mcs32, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_2M:\r\nPHY_SetBBReg(Adapter, rTxAGC_B_CCK11_A_CCK2_11, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_5_5M:\r\nPHY_SetBBReg(Adapter, rTxAGC_B_CCK11_A_CCK2_11, bMaskByte2, PowerIndex);\r\nbreak;\r\ncase MGN_11M:\r\nPHY_SetBBReg(Adapter, rTxAGC_B_CCK11_A_CCK2_11, bMaskByte3, PowerIndex);\r\nbreak;\r\ncase MGN_6M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate18_06, bMaskByte0, PowerIndex);\r\nbreak;\r\ncase MGN_9M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate18_06, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_12M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate18_06, bMaskByte2, PowerIndex);\r\nbreak;\r\ncase MGN_18M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate18_06, bMaskByte3, PowerIndex);\r\nbreak;\r\ncase MGN_24M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate54_24, bMaskByte0, PowerIndex);\r\nbreak;\r\ncase MGN_36M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate54_24, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_48M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate54_24, bMaskByte2, PowerIndex);\r\nbreak;\r\ncase MGN_54M:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Rate54_24, bMaskByte3, PowerIndex);\r\nbreak;\r\ncase MGN_MCS0:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs03_Mcs00, bMaskByte0, PowerIndex);\r\nbreak;\r\ncase MGN_MCS1:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs03_Mcs00, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_MCS2:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs03_Mcs00, bMaskByte2, PowerIndex);\r\nbreak;\r\ncase MGN_MCS3:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs03_Mcs00, bMaskByte3, PowerIndex);\r\nbreak;\r\ncase MGN_MCS4:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs07_Mcs04, bMaskByte0, PowerIndex);\r\nbreak;\r\ncase MGN_MCS5:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs07_Mcs04, bMaskByte1, PowerIndex);\r\nbreak;\r\ncase MGN_MCS6:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs07_Mcs04, bMaskByte2, PowerIndex);\r\nbreak;\r\ncase MGN_MCS7:\r\nPHY_SetBBReg(Adapter, rTxAGC_A_Mcs07_Mcs04, bMaskByte3, PowerIndex);\r\nbreak;\r\ndefault:\r\nDBG_871X("Invalid Rate!!\n");\r\nbreak;\r\n}\r\n} else {\r\nRT_TRACE(_module_hal_init_c_, _drv_err_, ("Invalid RFPath!!\n"));\r\n}\r\n}\r\nu8 PHY_GetTxPowerIndex_8723B(\r\nstruct adapter *padapter,\r\nu8 RFPath,\r\nu8 Rate,\r\nenum CHANNEL_WIDTH BandWidth,\r\nu8 Channel\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\ns8 txPower = 0, powerDiffByRate = 0, limit = 0;\r\nbool bIn24G = false;\r\ntxPower = (s8) PHY_GetTxPowerIndexBase(padapter, RFPath, Rate, BandWidth, Channel, &bIn24G);\r\npowerDiffByRate = PHY_GetTxPowerByRate(padapter, BAND_ON_2_4G, ODM_RF_PATH_A, RF_1TX, Rate);\r\nlimit = PHY_GetTxPowerLimit(\r\npadapter,\r\npadapter->registrypriv.RegPwrTblSel,\r\n(u8)(!bIn24G),\r\npHalData->CurrentChannelBW,\r\nRFPath,\r\nRate,\r\npHalData->CurrentChannel\r\n);\r\npowerDiffByRate = powerDiffByRate > limit ? limit : powerDiffByRate;\r\ntxPower += powerDiffByRate;\r\ntxPower += PHY_GetTxPowerTrackingOffset(padapter, RFPath, Rate);\r\nif (txPower > MAX_POWER_INDEX)\r\ntxPower = MAX_POWER_INDEX;\r\nreturn (u8) txPower;\r\n}\r\nvoid PHY_SetTxPowerLevel8723B(struct adapter *Adapter, u8 Channel)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nPDM_ODM_T pDM_Odm = &pHalData->odmpriv;\r\npFAT_T pDM_FatTable = &pDM_Odm->DM_FatTable;\r\nu8 RFPath = ODM_RF_PATH_A;\r\nif (pHalData->AntDivCfg) {\r\nRFPath = ((pDM_FatTable->RxIdleAnt == MAIN_ANT) ? ODM_RF_PATH_A : ODM_RF_PATH_B);\r\n} else {\r\nRFPath = pHalData->ant_path;\r\n}\r\nRT_TRACE(_module_hal_init_c_, _drv_info_, ("==>PHY_SetTxPowerLevel8723B()\n"));\r\nPHY_SetTxPowerLevelByPath(Adapter, Channel, RFPath);\r\nRT_TRACE(_module_hal_init_c_, _drv_info_, ("<==PHY_SetTxPowerLevel8723B()\n"));\r\n}\r\nvoid PHY_GetTxPowerLevel8723B(struct adapter *Adapter, s32 *powerlevel)\r\n{\r\n}\r\nstatic void phy_SetRegBW_8723B(\r\nstruct adapter *Adapter, enum CHANNEL_WIDTH CurrentBW\r\n)\r\n{\r\nu16 RegRfMod_BW, u2tmp = 0;\r\nRegRfMod_BW = rtw_read16(Adapter, REG_TRXPTCL_CTL_8723B);\r\nswitch (CurrentBW) {\r\ncase CHANNEL_WIDTH_20:\r\nrtw_write16(Adapter, REG_TRXPTCL_CTL_8723B, (RegRfMod_BW & 0xFE7F));\r\nbreak;\r\ncase CHANNEL_WIDTH_40:\r\nu2tmp = RegRfMod_BW | BIT7;\r\nrtw_write16(Adapter, REG_TRXPTCL_CTL_8723B, (u2tmp & 0xFEFF));\r\nbreak;\r\ncase CHANNEL_WIDTH_80:\r\nu2tmp = RegRfMod_BW | BIT8;\r\nrtw_write16(Adapter, REG_TRXPTCL_CTL_8723B, (u2tmp & 0xFF7F));\r\nbreak;\r\ndefault:\r\nDBG_871X("phy_PostSetBWMode8723B(): unknown Bandwidth: %#X\n", CurrentBW);\r\nbreak;\r\n}\r\n}\r\nstatic u8 phy_GetSecondaryChnl_8723B(struct adapter *Adapter)\r\n{\r\nu8 SCSettingOf40 = 0, SCSettingOf20 = 0;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nRT_TRACE(\r\n_module_hal_init_c_,\r\n_drv_info_,\r\n(\r\n"SCMapping: VHT Case: pHalData->CurrentChannelBW %d, pHalData->nCur80MhzPrimeSC %d, pHalData->nCur40MhzPrimeSC %d\n",\r\npHalData->CurrentChannelBW,\r\npHalData->nCur80MhzPrimeSC,\r\npHalData->nCur40MhzPrimeSC\r\n)\r\n);\r\nif (pHalData->CurrentChannelBW == CHANNEL_WIDTH_80) {\r\nif (pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER)\r\nSCSettingOf40 = VHT_DATA_SC_40_LOWER_OF_80MHZ;\r\nelse if (pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER)\r\nSCSettingOf40 = VHT_DATA_SC_40_UPPER_OF_80MHZ;\r\nelse\r\nRT_TRACE(_module_hal_init_c_, _drv_err_, ("SCMapping: Not Correct Primary40MHz Setting\n"));\r\nif (\r\n(pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER) &&\r\n(pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER)\r\n)\r\nSCSettingOf20 = VHT_DATA_SC_20_LOWEST_OF_80MHZ;\r\nelse if (\r\n(pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER) &&\r\n(pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER)\r\n)\r\nSCSettingOf20 = VHT_DATA_SC_20_LOWER_OF_80MHZ;\r\nelse if (\r\n(pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER) &&\r\n(pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER)\r\n)\r\nSCSettingOf20 = VHT_DATA_SC_20_UPPER_OF_80MHZ;\r\nelse if (\r\n(pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER) &&\r\n(pHalData->nCur80MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER)\r\n)\r\nSCSettingOf20 = VHT_DATA_SC_20_UPPERST_OF_80MHZ;\r\nelse\r\nRT_TRACE(_module_hal_init_c_, _drv_err_, ("SCMapping: Not Correct Primary40MHz Setting\n"));\r\n} else if (pHalData->CurrentChannelBW == CHANNEL_WIDTH_40) {\r\nRT_TRACE(\r\n_module_hal_init_c_,\r\n_drv_info_,\r\n(\r\n"SCMapping: VHT Case: pHalData->CurrentChannelBW %d, pHalData->nCur40MhzPrimeSC %d\n",\r\npHalData->CurrentChannelBW,\r\npHalData->nCur40MhzPrimeSC\r\n)\r\n);\r\nif (pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_UPPER)\r\nSCSettingOf20 = VHT_DATA_SC_20_UPPER_OF_80MHZ;\r\nelse if (pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER)\r\nSCSettingOf20 = VHT_DATA_SC_20_LOWER_OF_80MHZ;\r\nelse\r\nRT_TRACE(_module_hal_init_c_, _drv_err_, ("SCMapping: Not Correct Primary40MHz Setting\n"));\r\n}\r\nRT_TRACE(_module_hal_init_c_, _drv_info_, ("SCMapping: SC Value %x\n", ((SCSettingOf40 << 4) | SCSettingOf20)));\r\nreturn ((SCSettingOf40 << 4) | SCSettingOf20);\r\n}\r\nstatic void phy_PostSetBwMode8723B(struct adapter *Adapter)\r\n{\r\nu8 SubChnlNum = 0;\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nphy_SetRegBW_8723B(Adapter, pHalData->CurrentChannelBW);\r\nSubChnlNum = phy_GetSecondaryChnl_8723B(Adapter);\r\nrtw_write8(Adapter, REG_DATA_SC_8723B, SubChnlNum);\r\nswitch (pHalData->CurrentChannelBW) {\r\ncase CHANNEL_WIDTH_20:\r\nPHY_SetBBReg(Adapter, rFPGA0_RFMOD, bRFMOD, 0x0);\r\nPHY_SetBBReg(Adapter, rFPGA1_RFMOD, bRFMOD, 0x0);\r\nPHY_SetBBReg(Adapter, rOFDM0_TxPseudoNoiseWgt, (BIT31|BIT30), 0x0);\r\nbreak;\r\ncase CHANNEL_WIDTH_40:\r\nPHY_SetBBReg(Adapter, rFPGA0_RFMOD, bRFMOD, 0x1);\r\nPHY_SetBBReg(Adapter, rFPGA1_RFMOD, bRFMOD, 0x1);\r\nPHY_SetBBReg(Adapter, rCCK0_System, bCCKSideBand, (pHalData->nCur40MhzPrimeSC>>1));\r\nPHY_SetBBReg(Adapter, rOFDM1_LSTF, 0xC00, pHalData->nCur40MhzPrimeSC);\r\nPHY_SetBBReg(Adapter, 0x818, (BIT26|BIT27), (pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER) ? 2 : 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nPHY_RF6052SetBandwidth8723B(Adapter, pHalData->CurrentChannelBW);\r\n}\r\nstatic void phy_SwChnl8723B(struct adapter *padapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\r\nu8 channelToSW = pHalData->CurrentChannel;\r\nif (pHalData->rf_chip == RF_PSEUDO_11N) {\r\nreturn;\r\n}\r\npHalData->RfRegChnlVal[0] = ((pHalData->RfRegChnlVal[0] & 0xfffff00) | channelToSW);\r\nPHY_SetRFReg(padapter, ODM_RF_PATH_A, RF_CHNLBW, 0x3FF, pHalData->RfRegChnlVal[0]);\r\nPHY_SetRFReg(padapter, ODM_RF_PATH_B, RF_CHNLBW, 0x3FF, pHalData->RfRegChnlVal[0]);\r\nDBG_8192C("===>phy_SwChnl8723B: Channel = %d\n", channelToSW);\r\n}\r\nstatic void phy_SwChnlAndSetBwMode8723B(struct adapter *Adapter)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nif (Adapter->bNotifyChannelChange) {\r\nDBG_871X("[%s] bSwChnl =%d, ch =%d, bSetChnlBW =%d, bw =%d\n",\r\n__func__,\r\npHalData->bSwChnl,\r\npHalData->CurrentChannel,\r\npHalData->bSetChnlBW,\r\npHalData->CurrentChannelBW);\r\n}\r\nif (Adapter->bDriverStopped || Adapter->bSurpriseRemoved)\r\nreturn;\r\nif (pHalData->bSwChnl) {\r\nphy_SwChnl8723B(Adapter);\r\npHalData->bSwChnl = false;\r\n}\r\nif (pHalData->bSetChnlBW) {\r\nphy_PostSetBwMode8723B(Adapter);\r\npHalData->bSetChnlBW = false;\r\n}\r\nPHY_SetTxPowerLevel8723B(Adapter, pHalData->CurrentChannel);\r\n}\r\nstatic void PHY_HandleSwChnlAndSetBW8723B(\r\nstruct adapter *Adapter,\r\nbool bSwitchChannel,\r\nbool bSetBandWidth,\r\nu8 ChannelNum,\r\nenum CHANNEL_WIDTH ChnlWidth,\r\nenum EXTCHNL_OFFSET ExtChnlOffsetOf40MHz,\r\nenum EXTCHNL_OFFSET ExtChnlOffsetOf80MHz,\r\nu8 CenterFrequencyIndex1\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nu8 tmpChannel = pHalData->CurrentChannel;\r\nenum CHANNEL_WIDTH tmpBW = pHalData->CurrentChannelBW;\r\nu8 tmpnCur40MhzPrimeSC = pHalData->nCur40MhzPrimeSC;\r\nu8 tmpnCur80MhzPrimeSC = pHalData->nCur80MhzPrimeSC;\r\nu8 tmpCenterFrequencyIndex1 = pHalData->CurrentCenterFrequencyIndex1;\r\nif (!bSwitchChannel && !bSetBandWidth) {\r\nDBG_871X("PHY_HandleSwChnlAndSetBW8812: not switch channel and not set bandwidth\n");\r\nreturn;\r\n}\r\nif (bSwitchChannel) {\r\n{\r\nif (HAL_IsLegalChannel(Adapter, ChannelNum))\r\npHalData->bSwChnl = true;\r\n}\r\n}\r\nif (bSetBandWidth)\r\npHalData->bSetChnlBW = true;\r\nif (!pHalData->bSetChnlBW && !pHalData->bSwChnl) {\r\nreturn;\r\n}\r\nif (pHalData->bSwChnl) {\r\npHalData->CurrentChannel = ChannelNum;\r\npHalData->CurrentCenterFrequencyIndex1 = ChannelNum;\r\n}\r\nif (pHalData->bSetChnlBW) {\r\npHalData->CurrentChannelBW = ChnlWidth;\r\npHalData->nCur40MhzPrimeSC = ExtChnlOffsetOf40MHz;\r\npHalData->nCur80MhzPrimeSC = ExtChnlOffsetOf80MHz;\r\npHalData->CurrentCenterFrequencyIndex1 = CenterFrequencyIndex1;\r\n}\r\nif ((!Adapter->bDriverStopped) && (!Adapter->bSurpriseRemoved)) {\r\nphy_SwChnlAndSetBwMode8723B(Adapter);\r\n} else {\r\nif (pHalData->bSwChnl) {\r\npHalData->CurrentChannel = tmpChannel;\r\npHalData->CurrentCenterFrequencyIndex1 = tmpChannel;\r\n}\r\nif (pHalData->bSetChnlBW) {\r\npHalData->CurrentChannelBW = tmpBW;\r\npHalData->nCur40MhzPrimeSC = tmpnCur40MhzPrimeSC;\r\npHalData->nCur80MhzPrimeSC = tmpnCur80MhzPrimeSC;\r\npHalData->CurrentCenterFrequencyIndex1 = tmpCenterFrequencyIndex1;\r\n}\r\n}\r\n}\r\nvoid PHY_SetBWMode8723B(\r\nstruct adapter *Adapter,\r\nenum CHANNEL_WIDTH Bandwidth,\r\nunsigned char Offset\r\n)\r\n{\r\nstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\r\nPHY_HandleSwChnlAndSetBW8723B(Adapter, false, true, pHalData->CurrentChannel, Bandwidth, Offset, Offset, pHalData->CurrentChannel);\r\n}\r\nvoid PHY_SwChnl8723B(struct adapter *Adapter, u8 channel)\r\n{\r\nPHY_HandleSwChnlAndSetBW8723B(Adapter, true, false, channel, 0, 0, 0, channel);\r\n}\r\nvoid PHY_SetSwChnlBWMode8723B(\r\nstruct adapter *Adapter,\r\nu8 channel,\r\nenum CHANNEL_WIDTH Bandwidth,\r\nu8 Offset40,\r\nu8 Offset80\r\n)\r\n{\r\nPHY_HandleSwChnlAndSetBW8723B(Adapter, true, true, channel, Bandwidth, Offset40, Offset80, channel);\r\n}

void print_flags(unsigned long flags)\r\n{\r\nint i;\r\nint printed = 0;\r\nfor (i = 0; i < ARRAY_SIZE(flagnames); i++) {\r\nif (flags & flagnames[i].mask) {\r\nif (printed)\r\nfprintf(stdout, " ");\r\nfprintf(stdout, "%s", flagnames[i].name);\r\nprinted++;\r\n}\r\n}\r\n}\r\nint list_device(const char *device_name)\r\n{\r\nstruct gpiochip_info cinfo;\r\nchar *chrdev_name;\r\nint fd;\r\nint ret;\r\nint i;\r\nret = asprintf(&chrdev_name, "/dev/%s", device_name);\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\nfd = open(chrdev_name, 0);\r\nif (fd == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to open %s\n", chrdev_name);\r\ngoto exit_close_error;\r\n}\r\nret = ioctl(fd, GPIO_GET_CHIPINFO_IOCTL, &cinfo);\r\nif (ret == -1) {\r\nret = -errno;\r\nperror("Failed to issue CHIPINFO IOCTL\n");\r\ngoto exit_close_error;\r\n}\r\nfprintf(stdout, "GPIO chip: %s, \"%s\", %u GPIO lines\n",\r\ncinfo.name, cinfo.label, cinfo.lines);\r\nfor (i = 0; i < cinfo.lines; i++) {\r\nstruct gpioline_info linfo;\r\nmemset(&linfo, 0, sizeof(linfo));\r\nlinfo.line_offset = i;\r\nret = ioctl(fd, GPIO_GET_LINEINFO_IOCTL, &linfo);\r\nif (ret == -1) {\r\nret = -errno;\r\nperror("Failed to issue LINEINFO IOCTL\n");\r\ngoto exit_close_error;\r\n}\r\nfprintf(stdout, "\tline %2d:", linfo.line_offset);\r\nif (linfo.name[0])\r\nfprintf(stdout, " \"%s\"", linfo.name);\r\nelse\r\nfprintf(stdout, " unnamed");\r\nif (linfo.consumer[0])\r\nfprintf(stdout, " \"%s\"", linfo.consumer);\r\nelse\r\nfprintf(stdout, " unused");\r\nif (linfo.flags) {\r\nfprintf(stdout, " [");\r\nprint_flags(linfo.flags);\r\nfprintf(stdout, "]");\r\n}\r\nfprintf(stdout, "\n");\r\n}\r\nexit_close_error:\r\nif (close(fd) == -1)\r\nperror("Failed to close GPIO character device file");\r\nfree(chrdev_name);\r\nreturn ret;\r\n}\r\nvoid print_usage(void)\r\n{\r\nfprintf(stderr, "Usage: lsgpio [options]...\n"\r\n"List GPIO chips, lines and states\n"\r\n" -n <name> List GPIOs on a named device\n"\r\n" -? This helptext\n"\r\n);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nconst char *device_name = NULL;\r\nint ret;\r\nint c;\r\nwhile ((c = getopt(argc, argv, "n:")) != -1) {\r\nswitch (c) {\r\ncase 'n':\r\ndevice_name = optarg;\r\nbreak;\r\ncase '?':\r\nprint_usage();\r\nreturn -1;\r\n}\r\n}\r\nif (device_name)\r\nret = list_device(device_name);\r\nelse {\r\nconst struct dirent *ent;\r\nDIR *dp;\r\ndp = opendir("/dev");\r\nif (!dp) {\r\nret = -errno;\r\ngoto error_out;\r\n}\r\nret = -ENOENT;\r\nwhile (ent = readdir(dp), ent) {\r\nif (check_prefix(ent->d_name, "gpiochip")) {\r\nret = list_device(ent->d_name);\r\nif (ret)\r\nbreak;\r\n}\r\n}\r\nret = 0;\r\nif (closedir(dp) == -1) {\r\nperror("scanning devices: Failed to close directory");\r\nret = -errno;\r\n}\r\n}\r\nerror_out:\r\nreturn ret;\r\n}

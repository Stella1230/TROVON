static inline u32 vsp1_hgo_read(struct vsp1_hgo *hgo, u32 reg)\r\n{\r\nreturn vsp1_read(hgo->histo.entity.vsp1, reg);\r\n}\r\nstatic inline void vsp1_hgo_write(struct vsp1_hgo *hgo, struct vsp1_dl_list *dl,\r\nu32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg, data);\r\n}\r\nvoid vsp1_hgo_frame_end(struct vsp1_entity *entity)\r\n{\r\nstruct vsp1_hgo *hgo = to_hgo(&entity->subdev);\r\nstruct vsp1_histogram_buffer *buf;\r\nunsigned int i;\r\nsize_t size;\r\nu32 *data;\r\nbuf = vsp1_histogram_buffer_get(&hgo->histo);\r\nif (!buf)\r\nreturn;\r\ndata = buf->addr;\r\nif (hgo->num_bins == 256) {\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_MAXMIN);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_SUM);\r\nfor (i = 0; i < 256; ++i) {\r\nvsp1_write(hgo->histo.entity.vsp1,\r\nVI6_HGO_EXT_HIST_ADDR, i);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_EXT_HIST_DATA);\r\n}\r\nsize = (2 + 256) * sizeof(u32);\r\n} else if (hgo->max_rgb) {\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_MAXMIN);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_SUM);\r\nfor (i = 0; i < 64; ++i)\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_HISTO(i));\r\nsize = (2 + 64) * sizeof(u32);\r\n} else {\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_R_MAXMIN);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_MAXMIN);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_B_MAXMIN);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_R_SUM);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_G_SUM);\r\n*data++ = vsp1_hgo_read(hgo, VI6_HGO_B_SUM);\r\nfor (i = 0; i < 64; ++i) {\r\ndata[i] = vsp1_hgo_read(hgo, VI6_HGO_R_HISTO(i));\r\ndata[i+64] = vsp1_hgo_read(hgo, VI6_HGO_G_HISTO(i));\r\ndata[i+128] = vsp1_hgo_read(hgo, VI6_HGO_B_HISTO(i));\r\n}\r\nsize = (6 + 64 * 3) * sizeof(u32);\r\n}\r\nvsp1_histogram_buffer_complete(&hgo->histo, buf, size);\r\n}\r\nstatic void hgo_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nstruct vsp1_hgo *hgo = to_hgo(&entity->subdev);\r\nstruct v4l2_rect *compose;\r\nstruct v4l2_rect *crop;\r\nunsigned int hratio;\r\nunsigned int vratio;\r\nif (params != VSP1_ENTITY_PARAMS_INIT)\r\nreturn;\r\ncrop = vsp1_entity_get_pad_selection(entity, entity->config,\r\nHISTO_PAD_SINK, V4L2_SEL_TGT_CROP);\r\ncompose = vsp1_entity_get_pad_selection(entity, entity->config,\r\nHISTO_PAD_SINK,\r\nV4L2_SEL_TGT_COMPOSE);\r\nvsp1_hgo_write(hgo, dl, VI6_HGO_REGRST, VI6_HGO_REGRST_RCLEA);\r\nvsp1_hgo_write(hgo, dl, VI6_HGO_OFFSET,\r\n(crop->left << VI6_HGO_OFFSET_HOFFSET_SHIFT) |\r\n(crop->top << VI6_HGO_OFFSET_VOFFSET_SHIFT));\r\nvsp1_hgo_write(hgo, dl, VI6_HGO_SIZE,\r\n(crop->width << VI6_HGO_SIZE_HSIZE_SHIFT) |\r\n(crop->height << VI6_HGO_SIZE_VSIZE_SHIFT));\r\nmutex_lock(hgo->ctrls.handler.lock);\r\nhgo->max_rgb = hgo->ctrls.max_rgb->cur.val;\r\nif (hgo->ctrls.num_bins)\r\nhgo->num_bins = hgo_num_bins[hgo->ctrls.num_bins->cur.val];\r\nmutex_unlock(hgo->ctrls.handler.lock);\r\nhratio = crop->width * 2 / compose->width / 3;\r\nvratio = crop->height * 2 / compose->height / 3;\r\nvsp1_hgo_write(hgo, dl, VI6_HGO_MODE,\r\n(hgo->num_bins == 256 ? VI6_HGO_MODE_STEP : 0) |\r\n(hgo->max_rgb ? VI6_HGO_MODE_MAXRGB : 0) |\r\n(hratio << VI6_HGO_MODE_HRATIO_SHIFT) |\r\n(vratio << VI6_HGO_MODE_VRATIO_SHIFT));\r\n}\r\nstruct vsp1_hgo *vsp1_hgo_create(struct vsp1_device *vsp1)\r\n{\r\nstruct vsp1_hgo *hgo;\r\nint ret;\r\nhgo = devm_kzalloc(vsp1->dev, sizeof(*hgo), GFP_KERNEL);\r\nif (hgo == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nv4l2_ctrl_handler_init(&hgo->ctrls.handler,\r\nvsp1->info->gen == 3 ? 2 : 1);\r\nhgo->ctrls.max_rgb = v4l2_ctrl_new_custom(&hgo->ctrls.handler,\r\n&hgo_max_rgb_control, NULL);\r\nif (vsp1->info->gen == 3)\r\nhgo->ctrls.num_bins =\r\nv4l2_ctrl_new_custom(&hgo->ctrls.handler,\r\n&hgo_num_bins_control, NULL);\r\nhgo->max_rgb = false;\r\nhgo->num_bins = 64;\r\nhgo->histo.entity.subdev.ctrl_handler = &hgo->ctrls.handler;\r\nret = vsp1_histogram_init(vsp1, &hgo->histo, VSP1_ENTITY_HGO, "hgo",\r\n&hgo_entity_ops, hgo_mbus_formats,\r\nARRAY_SIZE(hgo_mbus_formats),\r\nHGO_DATA_SIZE, V4L2_META_FMT_VSP1_HGO);\r\nif (ret < 0) {\r\nvsp1_entity_destroy(&hgo->histo.entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn hgo;\r\n}

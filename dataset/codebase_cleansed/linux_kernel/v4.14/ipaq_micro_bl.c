static int micro_bl_update_status(struct backlight_device *bd)\r\n{\r\nstruct ipaq_micro *micro = dev_get_drvdata(&bd->dev);\r\nint intensity = bd->props.brightness;\r\nstruct ipaq_micro_msg msg = {\r\n.id = MSG_BACKLIGHT,\r\n.tx_len = 3,\r\n};\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.state & (BL_CORE_FBBLANK | BL_CORE_SUSPENDED))\r\nintensity = 0;\r\nmsg.tx_data[0] = 0x01;\r\nmsg.tx_data[1] = intensity > 0 ? 1 : 0;\r\nmsg.tx_data[2] = intensity;\r\nreturn ipaq_micro_tx_msg_sync(micro, &msg);\r\n}\r\nstatic int micro_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd;\r\nstruct ipaq_micro *micro = dev_get_drvdata(pdev->dev.parent);\r\nbd = devm_backlight_device_register(&pdev->dev, "ipaq-micro-backlight",\r\n&pdev->dev, micro, &micro_bl_ops,\r\n&micro_bl_props);\r\nif (IS_ERR(bd))\r\nreturn PTR_ERR(bd);\r\nplatform_set_drvdata(pdev, bd);\r\nbacklight_update_status(bd);\r\nreturn 0;\r\n}

static unsigned long rxrpc_peer_hash_key(struct rxrpc_local *local,\r\nconst struct sockaddr_rxrpc *srx)\r\n{\r\nconst u16 *p;\r\nunsigned int i, size;\r\nunsigned long hash_key;\r\n_enter("");\r\nhash_key = (unsigned long)local / __alignof__(*local);\r\nhash_key += srx->transport_type;\r\nhash_key += srx->transport_len;\r\nhash_key += srx->transport.family;\r\nswitch (srx->transport.family) {\r\ncase AF_INET:\r\nhash_key += (u16 __force)srx->transport.sin.sin_port;\r\nsize = sizeof(srx->transport.sin.sin_addr);\r\np = (u16 *)&srx->transport.sin.sin_addr;\r\nbreak;\r\n#ifdef CONFIG_AF_RXRPC_IPV6\r\ncase AF_INET6:\r\nhash_key += (u16 __force)srx->transport.sin.sin_port;\r\nsize = sizeof(srx->transport.sin6.sin6_addr);\r\np = (u16 *)&srx->transport.sin6.sin6_addr;\r\nbreak;\r\n#endif\r\ndefault:\r\nWARN(1, "AF_RXRPC: Unsupported transport address family\n");\r\nreturn 0;\r\n}\r\nfor (i = 0; i < size; i += sizeof(*p), p++)\r\nhash_key += *p;\r\n_leave(" 0x%lx", hash_key);\r\nreturn hash_key;\r\n}\r\nstatic long rxrpc_peer_cmp_key(const struct rxrpc_peer *peer,\r\nstruct rxrpc_local *local,\r\nconst struct sockaddr_rxrpc *srx,\r\nunsigned long hash_key)\r\n{\r\nlong diff;\r\ndiff = ((peer->hash_key - hash_key) ?:\r\n((unsigned long)peer->local - (unsigned long)local) ?:\r\n(peer->srx.transport_type - srx->transport_type) ?:\r\n(peer->srx.transport_len - srx->transport_len) ?:\r\n(peer->srx.transport.family - srx->transport.family));\r\nif (diff != 0)\r\nreturn diff;\r\nswitch (srx->transport.family) {\r\ncase AF_INET:\r\nreturn ((u16 __force)peer->srx.transport.sin.sin_port -\r\n(u16 __force)srx->transport.sin.sin_port) ?:\r\nmemcmp(&peer->srx.transport.sin.sin_addr,\r\n&srx->transport.sin.sin_addr,\r\nsizeof(struct in_addr));\r\n#ifdef CONFIG_AF_RXRPC_IPV6\r\ncase AF_INET6:\r\nreturn ((u16 __force)peer->srx.transport.sin6.sin6_port -\r\n(u16 __force)srx->transport.sin6.sin6_port) ?:\r\nmemcmp(&peer->srx.transport.sin6.sin6_addr,\r\n&srx->transport.sin6.sin6_addr,\r\nsizeof(struct in6_addr));\r\n#endif\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nstatic struct rxrpc_peer *__rxrpc_lookup_peer_rcu(\r\nstruct rxrpc_local *local,\r\nconst struct sockaddr_rxrpc *srx,\r\nunsigned long hash_key)\r\n{\r\nstruct rxrpc_peer *peer;\r\nstruct rxrpc_net *rxnet = local->rxnet;\r\nhash_for_each_possible_rcu(rxnet->peer_hash, peer, hash_link, hash_key) {\r\nif (rxrpc_peer_cmp_key(peer, local, srx, hash_key) == 0) {\r\nif (atomic_read(&peer->usage) == 0)\r\nreturn NULL;\r\nreturn peer;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstruct rxrpc_peer *rxrpc_lookup_peer_rcu(struct rxrpc_local *local,\r\nconst struct sockaddr_rxrpc *srx)\r\n{\r\nstruct rxrpc_peer *peer;\r\nunsigned long hash_key = rxrpc_peer_hash_key(local, srx);\r\npeer = __rxrpc_lookup_peer_rcu(local, srx, hash_key);\r\nif (peer) {\r\n_net("PEER %d {%pISp}", peer->debug_id, &peer->srx.transport);\r\n_leave(" = %p {u=%d}", peer, atomic_read(&peer->usage));\r\n}\r\nreturn peer;\r\n}\r\nstatic void rxrpc_assess_MTU_size(struct rxrpc_peer *peer)\r\n{\r\nstruct dst_entry *dst;\r\nstruct rtable *rt;\r\nstruct flowi fl;\r\nstruct flowi4 *fl4 = &fl.u.ip4;\r\n#ifdef CONFIG_AF_RXRPC_IPV6\r\nstruct flowi6 *fl6 = &fl.u.ip6;\r\n#endif\r\npeer->if_mtu = 1500;\r\nmemset(&fl, 0, sizeof(fl));\r\nswitch (peer->srx.transport.family) {\r\ncase AF_INET:\r\nrt = ip_route_output_ports(\r\n&init_net, fl4, NULL,\r\npeer->srx.transport.sin.sin_addr.s_addr, 0,\r\nhtons(7000), htons(7001), IPPROTO_UDP, 0, 0);\r\nif (IS_ERR(rt)) {\r\n_leave(" [route err %ld]", PTR_ERR(rt));\r\nreturn;\r\n}\r\ndst = &rt->dst;\r\nbreak;\r\n#ifdef CONFIG_AF_RXRPC_IPV6\r\ncase AF_INET6:\r\nfl6->flowi6_iif = LOOPBACK_IFINDEX;\r\nfl6->flowi6_scope = RT_SCOPE_UNIVERSE;\r\nfl6->flowi6_proto = IPPROTO_UDP;\r\nmemcpy(&fl6->daddr, &peer->srx.transport.sin6.sin6_addr,\r\nsizeof(struct in6_addr));\r\nfl6->fl6_dport = htons(7001);\r\nfl6->fl6_sport = htons(7000);\r\ndst = ip6_route_output(&init_net, NULL, fl6);\r\nif (dst->error) {\r\n_leave(" [route err %d]", dst->error);\r\nreturn;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG();\r\n}\r\npeer->if_mtu = dst_mtu(dst);\r\ndst_release(dst);\r\n_leave(" [if_mtu %u]", peer->if_mtu);\r\n}\r\nstruct rxrpc_peer *rxrpc_alloc_peer(struct rxrpc_local *local, gfp_t gfp)\r\n{\r\nstruct rxrpc_peer *peer;\r\n_enter("");\r\npeer = kzalloc(sizeof(struct rxrpc_peer), gfp);\r\nif (peer) {\r\natomic_set(&peer->usage, 1);\r\npeer->local = local;\r\nINIT_HLIST_HEAD(&peer->error_targets);\r\nINIT_WORK(&peer->error_distributor,\r\n&rxrpc_peer_error_distributor);\r\npeer->service_conns = RB_ROOT;\r\nseqlock_init(&peer->service_conn_lock);\r\nspin_lock_init(&peer->lock);\r\npeer->debug_id = atomic_inc_return(&rxrpc_debug_id);\r\nif (RXRPC_TX_SMSS > 2190)\r\npeer->cong_cwnd = 2;\r\nelse if (RXRPC_TX_SMSS > 1095)\r\npeer->cong_cwnd = 3;\r\nelse\r\npeer->cong_cwnd = 4;\r\n}\r\n_leave(" = %p", peer);\r\nreturn peer;\r\n}\r\nstatic void rxrpc_init_peer(struct rxrpc_peer *peer, unsigned long hash_key)\r\n{\r\npeer->hash_key = hash_key;\r\nrxrpc_assess_MTU_size(peer);\r\npeer->mtu = peer->if_mtu;\r\npeer->rtt_last_req = ktime_get_real();\r\nswitch (peer->srx.transport.family) {\r\ncase AF_INET:\r\npeer->hdrsize = sizeof(struct iphdr);\r\nbreak;\r\n#ifdef CONFIG_AF_RXRPC_IPV6\r\ncase AF_INET6:\r\npeer->hdrsize = sizeof(struct ipv6hdr);\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG();\r\n}\r\nswitch (peer->srx.transport_type) {\r\ncase SOCK_DGRAM:\r\npeer->hdrsize += sizeof(struct udphdr);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\npeer->hdrsize += sizeof(struct rxrpc_wire_header);\r\npeer->maxdata = peer->mtu - peer->hdrsize;\r\n}\r\nstatic struct rxrpc_peer *rxrpc_create_peer(struct rxrpc_local *local,\r\nstruct sockaddr_rxrpc *srx,\r\nunsigned long hash_key,\r\ngfp_t gfp)\r\n{\r\nstruct rxrpc_peer *peer;\r\n_enter("");\r\npeer = rxrpc_alloc_peer(local, gfp);\r\nif (peer) {\r\nmemcpy(&peer->srx, srx, sizeof(*srx));\r\nrxrpc_init_peer(peer, hash_key);\r\n}\r\n_leave(" = %p", peer);\r\nreturn peer;\r\n}\r\nstruct rxrpc_peer *rxrpc_lookup_incoming_peer(struct rxrpc_local *local,\r\nstruct rxrpc_peer *prealloc)\r\n{\r\nstruct rxrpc_peer *peer;\r\nstruct rxrpc_net *rxnet = local->rxnet;\r\nunsigned long hash_key;\r\nhash_key = rxrpc_peer_hash_key(local, &prealloc->srx);\r\nprealloc->local = local;\r\nrxrpc_init_peer(prealloc, hash_key);\r\nspin_lock(&rxnet->peer_hash_lock);\r\npeer = __rxrpc_lookup_peer_rcu(local, &prealloc->srx, hash_key);\r\nif (peer && !rxrpc_get_peer_maybe(peer))\r\npeer = NULL;\r\nif (!peer) {\r\npeer = prealloc;\r\nhash_add_rcu(rxnet->peer_hash, &peer->hash_link, hash_key);\r\n}\r\nspin_unlock(&rxnet->peer_hash_lock);\r\nreturn peer;\r\n}\r\nstruct rxrpc_peer *rxrpc_lookup_peer(struct rxrpc_local *local,\r\nstruct sockaddr_rxrpc *srx, gfp_t gfp)\r\n{\r\nstruct rxrpc_peer *peer, *candidate;\r\nstruct rxrpc_net *rxnet = local->rxnet;\r\nunsigned long hash_key = rxrpc_peer_hash_key(local, srx);\r\n_enter("{%pISp}", &srx->transport);\r\nrcu_read_lock();\r\npeer = __rxrpc_lookup_peer_rcu(local, srx, hash_key);\r\nif (peer && !rxrpc_get_peer_maybe(peer))\r\npeer = NULL;\r\nrcu_read_unlock();\r\nif (!peer) {\r\ncandidate = rxrpc_create_peer(local, srx, hash_key, gfp);\r\nif (!candidate) {\r\n_leave(" = NULL [nomem]");\r\nreturn NULL;\r\n}\r\nspin_lock_bh(&rxnet->peer_hash_lock);\r\npeer = __rxrpc_lookup_peer_rcu(local, srx, hash_key);\r\nif (peer && !rxrpc_get_peer_maybe(peer))\r\npeer = NULL;\r\nif (!peer)\r\nhash_add_rcu(rxnet->peer_hash,\r\n&candidate->hash_link, hash_key);\r\nspin_unlock_bh(&rxnet->peer_hash_lock);\r\nif (peer)\r\nkfree(candidate);\r\nelse\r\npeer = candidate;\r\n}\r\n_net("PEER %d {%pISp}", peer->debug_id, &peer->srx.transport);\r\n_leave(" = %p {u=%d}", peer, atomic_read(&peer->usage));\r\nreturn peer;\r\n}\r\nvoid __rxrpc_put_peer(struct rxrpc_peer *peer)\r\n{\r\nstruct rxrpc_net *rxnet = peer->local->rxnet;\r\nASSERT(hlist_empty(&peer->error_targets));\r\nspin_lock_bh(&rxnet->peer_hash_lock);\r\nhash_del_rcu(&peer->hash_link);\r\nspin_unlock_bh(&rxnet->peer_hash_lock);\r\nkfree_rcu(peer, rcu);\r\n}\r\nvoid rxrpc_kernel_get_peer(struct socket *sock, struct rxrpc_call *call,\r\nstruct sockaddr_rxrpc *_srx)\r\n{\r\n*_srx = call->peer->srx;\r\n}

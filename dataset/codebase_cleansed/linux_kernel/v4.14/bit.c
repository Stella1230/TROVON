static inline void\r\nnvkm_i2c_drive_scl(struct nvkm_i2c_bus *bus, int state)\r\n{\r\nbus->func->drive_scl(bus, state);\r\n}\r\nstatic inline void\r\nnvkm_i2c_drive_sda(struct nvkm_i2c_bus *bus, int state)\r\n{\r\nbus->func->drive_sda(bus, state);\r\n}\r\nstatic inline int\r\nnvkm_i2c_sense_scl(struct nvkm_i2c_bus *bus)\r\n{\r\nreturn bus->func->sense_scl(bus);\r\n}\r\nstatic inline int\r\nnvkm_i2c_sense_sda(struct nvkm_i2c_bus *bus)\r\n{\r\nreturn bus->func->sense_sda(bus);\r\n}\r\nstatic void\r\nnvkm_i2c_delay(struct nvkm_i2c_bus *bus, u32 nsec)\r\n{\r\nudelay((nsec + 500) / 1000);\r\n}\r\nstatic bool\r\nnvkm_i2c_raise_scl(struct nvkm_i2c_bus *bus)\r\n{\r\nu32 timeout = T_TIMEOUT / T_RISEFALL;\r\nnvkm_i2c_drive_scl(bus, 1);\r\ndo {\r\nnvkm_i2c_delay(bus, T_RISEFALL);\r\n} while (!nvkm_i2c_sense_scl(bus) && --timeout);\r\nreturn timeout != 0;\r\n}\r\nstatic int\r\ni2c_start(struct nvkm_i2c_bus *bus)\r\n{\r\nint ret = 0;\r\nif (!nvkm_i2c_sense_scl(bus) ||\r\n!nvkm_i2c_sense_sda(bus)) {\r\nnvkm_i2c_drive_scl(bus, 0);\r\nnvkm_i2c_drive_sda(bus, 1);\r\nif (!nvkm_i2c_raise_scl(bus))\r\nret = -EBUSY;\r\n}\r\nnvkm_i2c_drive_sda(bus, 0);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nnvkm_i2c_drive_scl(bus, 0);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nreturn ret;\r\n}\r\nstatic void\r\ni2c_stop(struct nvkm_i2c_bus *bus)\r\n{\r\nnvkm_i2c_drive_scl(bus, 0);\r\nnvkm_i2c_drive_sda(bus, 0);\r\nnvkm_i2c_delay(bus, T_RISEFALL);\r\nnvkm_i2c_drive_scl(bus, 1);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nnvkm_i2c_drive_sda(bus, 1);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\n}\r\nstatic int\r\ni2c_bitw(struct nvkm_i2c_bus *bus, int sda)\r\n{\r\nnvkm_i2c_drive_sda(bus, sda);\r\nnvkm_i2c_delay(bus, T_RISEFALL);\r\nif (!nvkm_i2c_raise_scl(bus))\r\nreturn -ETIMEDOUT;\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nnvkm_i2c_drive_scl(bus, 0);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nreturn 0;\r\n}\r\nstatic int\r\ni2c_bitr(struct nvkm_i2c_bus *bus)\r\n{\r\nint sda;\r\nnvkm_i2c_drive_sda(bus, 1);\r\nnvkm_i2c_delay(bus, T_RISEFALL);\r\nif (!nvkm_i2c_raise_scl(bus))\r\nreturn -ETIMEDOUT;\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nsda = nvkm_i2c_sense_sda(bus);\r\nnvkm_i2c_drive_scl(bus, 0);\r\nnvkm_i2c_delay(bus, T_HOLD);\r\nreturn sda;\r\n}\r\nstatic int\r\nnvkm_i2c_get_byte(struct nvkm_i2c_bus *bus, u8 *byte, bool last)\r\n{\r\nint i, bit;\r\n*byte = 0;\r\nfor (i = 7; i >= 0; i--) {\r\nbit = i2c_bitr(bus);\r\nif (bit < 0)\r\nreturn bit;\r\n*byte |= bit << i;\r\n}\r\nreturn i2c_bitw(bus, last ? 1 : 0);\r\n}\r\nstatic int\r\nnvkm_i2c_put_byte(struct nvkm_i2c_bus *bus, u8 byte)\r\n{\r\nint i, ret;\r\nfor (i = 7; i >= 0; i--) {\r\nret = i2c_bitw(bus, !!(byte & (1 << i)));\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = i2c_bitr(bus);\r\nif (ret == 1)\r\nret = -EIO;\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_addr(struct nvkm_i2c_bus *bus, struct i2c_msg *msg)\r\n{\r\nu32 addr = msg->addr << 1;\r\nif (msg->flags & I2C_M_RD)\r\naddr |= 1;\r\nreturn nvkm_i2c_put_byte(bus, addr);\r\n}\r\nint\r\nnvkm_i2c_bit_xfer(struct nvkm_i2c_bus *bus, struct i2c_msg *msgs, int num)\r\n{\r\nstruct i2c_msg *msg = msgs;\r\nint ret = 0, mcnt = num;\r\nwhile (!ret && mcnt--) {\r\nu8 remaining = msg->len;\r\nu8 *ptr = msg->buf;\r\nret = i2c_start(bus);\r\nif (ret == 0)\r\nret = i2c_addr(bus, msg);\r\nif (msg->flags & I2C_M_RD) {\r\nwhile (!ret && remaining--)\r\nret = nvkm_i2c_get_byte(bus, ptr++, !remaining);\r\n} else {\r\nwhile (!ret && remaining--)\r\nret = nvkm_i2c_put_byte(bus, *ptr++);\r\n}\r\nmsg++;\r\n}\r\ni2c_stop(bus);\r\nreturn (ret < 0) ? ret : num;\r\n}\r\nint\r\nnvkm_i2c_bit_xfer(struct nvkm_i2c_bus *bus, struct i2c_msg *msgs, int num)\r\n{\r\nreturn -ENODEV;\r\n}

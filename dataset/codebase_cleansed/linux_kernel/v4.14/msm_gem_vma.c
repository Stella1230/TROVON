static void\r\nmsm_gem_address_space_destroy(struct kref *kref)\r\n{\r\nstruct msm_gem_address_space *aspace = container_of(kref,\r\nstruct msm_gem_address_space, kref);\r\ndrm_mm_takedown(&aspace->mm);\r\nif (aspace->mmu)\r\naspace->mmu->funcs->destroy(aspace->mmu);\r\nkfree(aspace);\r\n}\r\nvoid msm_gem_address_space_put(struct msm_gem_address_space *aspace)\r\n{\r\nif (aspace)\r\nkref_put(&aspace->kref, msm_gem_address_space_destroy);\r\n}\r\nvoid\r\nmsm_gem_unmap_vma(struct msm_gem_address_space *aspace,\r\nstruct msm_gem_vma *vma, struct sg_table *sgt)\r\n{\r\nif (!aspace || !vma->iova)\r\nreturn;\r\nif (aspace->mmu) {\r\nunsigned size = vma->node.size << PAGE_SHIFT;\r\naspace->mmu->funcs->unmap(aspace->mmu, vma->iova, sgt, size);\r\n}\r\nspin_lock(&aspace->lock);\r\ndrm_mm_remove_node(&vma->node);\r\nspin_unlock(&aspace->lock);\r\nvma->iova = 0;\r\nmsm_gem_address_space_put(aspace);\r\n}\r\nint\r\nmsm_gem_map_vma(struct msm_gem_address_space *aspace,\r\nstruct msm_gem_vma *vma, struct sg_table *sgt, int npages)\r\n{\r\nint ret;\r\nspin_lock(&aspace->lock);\r\nif (WARN_ON(drm_mm_node_allocated(&vma->node))) {\r\nspin_unlock(&aspace->lock);\r\nreturn 0;\r\n}\r\nret = drm_mm_insert_node(&aspace->mm, &vma->node, npages);\r\nspin_unlock(&aspace->lock);\r\nif (ret)\r\nreturn ret;\r\nvma->iova = vma->node.start << PAGE_SHIFT;\r\nif (aspace->mmu) {\r\nunsigned size = npages << PAGE_SHIFT;\r\nret = aspace->mmu->funcs->map(aspace->mmu, vma->iova, sgt,\r\nsize, IOMMU_READ | IOMMU_WRITE);\r\n}\r\nkref_get(&aspace->kref);\r\nreturn ret;\r\n}\r\nstruct msm_gem_address_space *\r\nmsm_gem_address_space_create(struct device *dev, struct iommu_domain *domain,\r\nconst char *name)\r\n{\r\nstruct msm_gem_address_space *aspace;\r\naspace = kzalloc(sizeof(*aspace), GFP_KERNEL);\r\nif (!aspace)\r\nreturn ERR_PTR(-ENOMEM);\r\nspin_lock_init(&aspace->lock);\r\naspace->name = name;\r\naspace->mmu = msm_iommu_new(dev, domain);\r\ndrm_mm_init(&aspace->mm, (domain->geometry.aperture_start >> PAGE_SHIFT),\r\n(domain->geometry.aperture_end >> PAGE_SHIFT) - 1);\r\nkref_init(&aspace->kref);\r\nreturn aspace;\r\n}

static inline unsigned long RD(struct au1xpsc_audio_data *ctx, int reg)\r\n{\r\nreturn __raw_readl(ctx->mmio + reg);\r\n}\r\nstatic inline void WR(struct au1xpsc_audio_data *ctx, int reg, unsigned long v)\r\n{\r\n__raw_writel(v, ctx->mmio + reg);\r\nwmb();\r\n}\r\nstatic unsigned short au1xac97c_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short r)\r\n{\r\nstruct au1xpsc_audio_data *ctx = ac97_to_ctx(ac97);\r\nunsigned int tmo, retry;\r\nunsigned long data;\r\ndata = ~0;\r\nretry = AC97_RW_RETRIES;\r\ndo {\r\nmutex_lock(&ctx->lock);\r\ntmo = 5;\r\nwhile ((RD(ctx, AC97_STATUS) & STAT_CP) && tmo--)\r\nudelay(21);\r\nif (!tmo) {\r\npr_debug("ac97rd timeout #1\n");\r\ngoto next;\r\n}\r\nWR(ctx, AC97_CMDRESP, CMD_IDX(r) | CMD_READ);\r\ntmo = 0x10000;\r\nwhile ((RD(ctx, AC97_STATUS) & STAT_CP) && tmo--)\r\nasm volatile ("nop");\r\ndata = RD(ctx, AC97_CMDRESP);\r\nif (!tmo)\r\npr_debug("ac97rd timeout #2\n");\r\nnext:\r\nmutex_unlock(&ctx->lock);\r\n} while (--retry && !tmo);\r\npr_debug("AC97RD %04x %04lx %d\n", r, data, retry);\r\nreturn retry ? data & 0xffff : 0xffff;\r\n}\r\nstatic void au1xac97c_ac97_write(struct snd_ac97 *ac97, unsigned short r,\r\nunsigned short v)\r\n{\r\nstruct au1xpsc_audio_data *ctx = ac97_to_ctx(ac97);\r\nunsigned int tmo, retry;\r\nretry = AC97_RW_RETRIES;\r\ndo {\r\nmutex_lock(&ctx->lock);\r\nfor (tmo = 5; (RD(ctx, AC97_STATUS) & STAT_CP) && tmo; tmo--)\r\nudelay(21);\r\nif (!tmo) {\r\npr_debug("ac97wr timeout #1\n");\r\ngoto next;\r\n}\r\nWR(ctx, AC97_CMDRESP, CMD_WRITE | CMD_IDX(r) | CMD_SET_DATA(v));\r\nfor (tmo = 10; (RD(ctx, AC97_STATUS) & STAT_CP) && tmo; tmo--)\r\nudelay(21);\r\nif (!tmo)\r\npr_debug("ac97wr timeout #2\n");\r\nnext:\r\nmutex_unlock(&ctx->lock);\r\n} while (--retry && !tmo);\r\npr_debug("AC97WR %04x %04x %d\n", r, v, retry);\r\n}\r\nstatic void au1xac97c_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct au1xpsc_audio_data *ctx = ac97_to_ctx(ac97);\r\nWR(ctx, AC97_CONFIG, ctx->cfg | CFG_SG | CFG_SN);\r\nmsleep(20);\r\nWR(ctx, AC97_CONFIG, ctx->cfg | CFG_SG);\r\nWR(ctx, AC97_CONFIG, ctx->cfg);\r\n}\r\nstatic void au1xac97c_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct au1xpsc_audio_data *ctx = ac97_to_ctx(ac97);\r\nint i;\r\nWR(ctx, AC97_CONFIG, ctx->cfg | CFG_RS);\r\nmsleep(500);\r\nWR(ctx, AC97_CONFIG, ctx->cfg);\r\ni = 50;\r\nwhile (((RD(ctx, AC97_STATUS) & STAT_RD) == 0) && --i)\r\nmsleep(20);\r\nif (!i)\r\nprintk(KERN_ERR "ac97c: codec not ready after cold reset\n");\r\n}\r\nstatic int alchemy_ac97c_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *ctx = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, &ctx->dmaids[0]);\r\nreturn 0;\r\n}\r\nstatic int au1xac97c_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nreturn ac97c_workdata ? 0 : -ENODEV;\r\n}\r\nstatic int au1xac97c_drvprobe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct resource *iores, *dmares;\r\nstruct au1xpsc_audio_data *ctx;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nmutex_init(&ctx->lock);\r\niores = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iores)\r\nreturn -ENODEV;\r\nif (!devm_request_mem_region(&pdev->dev, iores->start,\r\nresource_size(iores),\r\npdev->name))\r\nreturn -EBUSY;\r\nctx->mmio = devm_ioremap_nocache(&pdev->dev, iores->start,\r\nresource_size(iores));\r\nif (!ctx->mmio)\r\nreturn -EBUSY;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nctx->dmaids[SNDRV_PCM_STREAM_PLAYBACK] = dmares->start;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nctx->dmaids[SNDRV_PCM_STREAM_CAPTURE] = dmares->start;\r\nWR(ctx, AC97_ENABLE, EN_D | EN_CE);\r\nWR(ctx, AC97_ENABLE, EN_CE);\r\nctx->cfg = CFG_RC(3) | CFG_XS(3);\r\nWR(ctx, AC97_CONFIG, ctx->cfg);\r\nplatform_set_drvdata(pdev, ctx);\r\nret = snd_soc_set_ac97_ops(&ac97c_bus_ops);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_register_component(&pdev->dev, &au1xac97c_component,\r\n&au1xac97c_dai_driver, 1);\r\nif (ret)\r\nreturn ret;\r\nac97c_workdata = ctx;\r\nreturn 0;\r\n}\r\nstatic int au1xac97c_drvremove(struct platform_device *pdev)\r\n{\r\nstruct au1xpsc_audio_data *ctx = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nWR(ctx, AC97_ENABLE, EN_D);\r\nac97c_workdata = NULL;\r\nreturn 0;\r\n}\r\nstatic int au1xac97c_drvsuspend(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *ctx = dev_get_drvdata(dev);\r\nWR(ctx, AC97_ENABLE, EN_D);\r\nreturn 0;\r\n}\r\nstatic int au1xac97c_drvresume(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *ctx = dev_get_drvdata(dev);\r\nWR(ctx, AC97_ENABLE, EN_D | EN_CE);\r\nWR(ctx, AC97_ENABLE, EN_CE);\r\nWR(ctx, AC97_CONFIG, ctx->cfg);\r\nreturn 0;\r\n}

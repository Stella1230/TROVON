static int ltc2632_spi_write(struct spi_device *spi,\r\nu8 cmd, u8 addr, u16 val, u8 shift)\r\n{\r\nu32 data;\r\nu8 msg[3];\r\ndata = (cmd << 20) | (addr << 16) | (val << shift);\r\nmsg[0] = data >> 16;\r\nmsg[1] = data >> 8;\r\nmsg[2] = data;\r\nreturn spi_write(spi, msg, sizeof(msg));\r\n}\r\nstatic int ltc2632_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nstruct ltc2632_chip_info *chip_info;\r\nconst struct ltc2632_state *st = iio_priv(indio_dev);\r\nconst struct spi_device_id *spi_dev_id = spi_get_device_id(st->spi_dev);\r\nchip_info = (struct ltc2632_chip_info *)spi_dev_id->driver_data;\r\nswitch (m) {\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = chip_info->vref_mv;\r\n*val2 = chan->scan_type.realbits;\r\nreturn IIO_VAL_FRACTIONAL_LOG2;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ltc2632_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct ltc2632_state *st = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (val >= (1 << chan->scan_type.realbits) || val < 0)\r\nreturn -EINVAL;\r\nreturn ltc2632_spi_write(st->spi_dev,\r\nLTC2632_CMD_WRITE_INPUT_N_UPDATE_N,\r\nchan->address, val,\r\nchan->scan_type.shift);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic ssize_t ltc2632_read_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private,\r\nconst struct iio_chan_spec *chan,\r\nchar *buf)\r\n{\r\nstruct ltc2632_state *st = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n",\r\n!!(st->powerdown_cache_mask & (1 << chan->channel)));\r\n}\r\nstatic ssize_t ltc2632_write_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private,\r\nconst struct iio_chan_spec *chan,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nbool pwr_down;\r\nint ret;\r\nstruct ltc2632_state *st = iio_priv(indio_dev);\r\nret = strtobool(buf, &pwr_down);\r\nif (ret)\r\nreturn ret;\r\nif (pwr_down)\r\nst->powerdown_cache_mask |= (1 << chan->channel);\r\nelse\r\nst->powerdown_cache_mask &= ~(1 << chan->channel);\r\nret = ltc2632_spi_write(st->spi_dev,\r\nLTC2632_CMD_POWERDOWN_DAC_N,\r\nchan->channel, 0, 0);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ltc2632_probe(struct spi_device *spi)\r\n{\r\nstruct ltc2632_state *st;\r\nstruct iio_dev *indio_dev;\r\nstruct ltc2632_chip_info *chip_info;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->spi_dev = spi;\r\nchip_info = (struct ltc2632_chip_info *)\r\nspi_get_device_id(spi)->driver_data;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->name = dev_of_node(&spi->dev) ? dev_of_node(&spi->dev)->name\r\n: spi_get_device_id(spi)->name;\r\nindio_dev->info = &ltc2632_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = chip_info->channels;\r\nindio_dev->num_channels = LTC2632_DAC_CHANNELS;\r\nret = ltc2632_spi_write(spi, LTC2632_CMD_INTERNAL_REFER, 0, 0, 0);\r\nif (ret) {\r\ndev_err(&spi->dev,\r\n"Set internal reference command failed, %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn devm_iio_device_register(&spi->dev, indio_dev);\r\n}

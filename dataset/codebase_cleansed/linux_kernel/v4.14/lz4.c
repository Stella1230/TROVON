static void *lz4_alloc_ctx(struct crypto_scomp *tfm)\r\n{\r\nvoid *ctx;\r\nctx = vmalloc(LZ4_MEM_COMPRESS);\r\nif (!ctx)\r\nreturn ERR_PTR(-ENOMEM);\r\nreturn ctx;\r\n}\r\nstatic int lz4_init(struct crypto_tfm *tfm)\r\n{\r\nstruct lz4_ctx *ctx = crypto_tfm_ctx(tfm);\r\nctx->lz4_comp_mem = lz4_alloc_ctx(NULL);\r\nif (IS_ERR(ctx->lz4_comp_mem))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void lz4_free_ctx(struct crypto_scomp *tfm, void *ctx)\r\n{\r\nvfree(ctx);\r\n}\r\nstatic void lz4_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct lz4_ctx *ctx = crypto_tfm_ctx(tfm);\r\nlz4_free_ctx(NULL, ctx->lz4_comp_mem);\r\n}\r\nstatic int __lz4_compress_crypto(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen, void *ctx)\r\n{\r\nint out_len = LZ4_compress_default(src, dst,\r\nslen, *dlen, ctx);\r\nif (!out_len)\r\nreturn -EINVAL;\r\n*dlen = out_len;\r\nreturn 0;\r\n}\r\nstatic int lz4_scompress(struct crypto_scomp *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen,\r\nvoid *ctx)\r\n{\r\nreturn __lz4_compress_crypto(src, slen, dst, dlen, ctx);\r\n}\r\nstatic int lz4_compress_crypto(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct lz4_ctx *ctx = crypto_tfm_ctx(tfm);\r\nreturn __lz4_compress_crypto(src, slen, dst, dlen, ctx->lz4_comp_mem);\r\n}\r\nstatic int __lz4_decompress_crypto(const u8 *src, unsigned int slen,\r\nu8 *dst, unsigned int *dlen, void *ctx)\r\n{\r\nint out_len = LZ4_decompress_safe(src, dst, slen, *dlen);\r\nif (out_len < 0)\r\nreturn -EINVAL;\r\n*dlen = out_len;\r\nreturn 0;\r\n}\r\nstatic int lz4_sdecompress(struct crypto_scomp *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen,\r\nvoid *ctx)\r\n{\r\nreturn __lz4_decompress_crypto(src, slen, dst, dlen, NULL);\r\n}\r\nstatic int lz4_decompress_crypto(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst,\r\nunsigned int *dlen)\r\n{\r\nreturn __lz4_decompress_crypto(src, slen, dst, dlen, NULL);\r\n}\r\nstatic int __init lz4_mod_init(void)\r\n{\r\nint ret;\r\nret = crypto_register_alg(&alg_lz4);\r\nif (ret)\r\nreturn ret;\r\nret = crypto_register_scomp(&scomp);\r\nif (ret) {\r\ncrypto_unregister_alg(&alg_lz4);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit lz4_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg_lz4);\r\ncrypto_unregister_scomp(&scomp);\r\n}

static int sdhci_bcm_kona_sd_reset(struct sdhci_host *host)\r\n{\r\nunsigned int val;\r\nunsigned long timeout;\r\ntimeout = jiffies + msecs_to_jiffies(100);\r\nval = sdhci_readl(host, KONA_SDHOST_CORECTRL);\r\nval |= KONA_SDHOST_RESET;\r\nsdhci_writel(host, val, KONA_SDHOST_CORECTRL);\r\nwhile (!(sdhci_readl(host, KONA_SDHOST_CORECTRL) & KONA_SDHOST_RESET)) {\r\nif (time_is_before_jiffies(timeout)) {\r\npr_err("Error: sd host is stuck in reset!!!\n");\r\nreturn -EFAULT;\r\n}\r\n}\r\nval = sdhci_readl(host, KONA_SDHOST_CORECTRL);\r\nval &= ~KONA_SDHOST_RESET;\r\nusleep_range(1000, 5000);\r\nsdhci_writel(host, val, KONA_SDHOST_CORECTRL);\r\nreturn 0;\r\n}\r\nstatic void sdhci_bcm_kona_sd_init(struct sdhci_host *host)\r\n{\r\nunsigned int val;\r\nval = sdhci_readl(host, KONA_SDHOST_COREIMR);\r\nval |= KONA_SDHOST_IP;\r\nsdhci_writel(host, val, KONA_SDHOST_COREIMR);\r\nval = sdhci_readl(host, KONA_SDHOST_CORECTRL);\r\nval |= KONA_SDHOST_EN;\r\nusleep_range(1000, 5000);\r\nsdhci_writel(host, val, KONA_SDHOST_CORECTRL);\r\n}\r\nstatic int sdhci_bcm_kona_sd_card_emulate(struct sdhci_host *host, int insert)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_priv = sdhci_priv(host);\r\nstruct sdhci_bcm_kona_dev *kona_dev = sdhci_pltfm_priv(pltfm_priv);\r\nu32 val;\r\nmutex_lock(&kona_dev->write_lock);\r\nudelay(20);\r\nval = sdhci_readl(host, KONA_SDHOST_CORESTAT);\r\nif (insert) {\r\nint ret;\r\nret = mmc_gpio_get_ro(host->mmc);\r\nif (ret >= 0)\r\nval = (val & ~KONA_SDHOST_WP) |\r\n((ret) ? KONA_SDHOST_WP : 0);\r\nval |= KONA_SDHOST_CD_SW;\r\nsdhci_writel(host, val, KONA_SDHOST_CORESTAT);\r\n} else {\r\nval &= ~KONA_SDHOST_CD_SW;\r\nsdhci_writel(host, val, KONA_SDHOST_CORESTAT);\r\n}\r\nmutex_unlock(&kona_dev->write_lock);\r\nreturn 0;\r\n}\r\nstatic void sdhci_bcm_kona_card_event(struct sdhci_host *host)\r\n{\r\nif (mmc_gpio_get_cd(host->mmc) > 0) {\r\ndev_dbg(mmc_dev(host->mmc),\r\n"card inserted\n");\r\nsdhci_bcm_kona_sd_card_emulate(host, 1);\r\n} else {\r\ndev_dbg(mmc_dev(host->mmc),\r\n"card removed\n");\r\nsdhci_bcm_kona_sd_card_emulate(host, 0);\r\n}\r\n}\r\nstatic unsigned int sdhci_bcm_kona_get_max_clk(struct sdhci_host *host)\r\n{\r\nstruct sdhci_bcm_kona_dev *kona_dev;\r\nstruct sdhci_pltfm_host *pltfm_priv = sdhci_priv(host);\r\nkona_dev = sdhci_pltfm_priv(pltfm_priv);\r\nreturn host->mmc->f_max;\r\n}\r\nstatic unsigned int sdhci_bcm_kona_get_timeout_clock(struct sdhci_host *host)\r\n{\r\nreturn sdhci_bcm_kona_get_max_clk(host);\r\n}\r\nstatic void sdhci_bcm_kona_init_74_clocks(struct sdhci_host *host,\r\nu8 power_mode)\r\n{\r\nif (power_mode != MMC_POWER_OFF)\r\nudelay(740);\r\n}\r\nstatic int sdhci_bcm_kona_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_bcm_kona_dev *kona_dev = NULL;\r\nstruct sdhci_pltfm_host *pltfm_priv;\r\nstruct device *dev = &pdev->dev;\r\nstruct sdhci_host *host;\r\nint ret;\r\nret = 0;\r\nhost = sdhci_pltfm_init(pdev, &sdhci_pltfm_data_kona,\r\nsizeof(*kona_dev));\r\nif (IS_ERR(host))\r\nreturn PTR_ERR(host);\r\ndev_dbg(dev, "%s: inited. IOADDR=%p\n", __func__, host->ioaddr);\r\npltfm_priv = sdhci_priv(host);\r\nkona_dev = sdhci_pltfm_priv(pltfm_priv);\r\nmutex_init(&kona_dev->write_lock);\r\nmmc_of_parse(host->mmc);\r\nif (!host->mmc->f_max) {\r\ndev_err(&pdev->dev, "Missing max-freq for SDHCI cfg\n");\r\nret = -ENXIO;\r\ngoto err_pltfm_free;\r\n}\r\nkona_dev->external_clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(kona_dev->external_clk)) {\r\ndev_err(dev, "Failed to get external clock\n");\r\nret = PTR_ERR(kona_dev->external_clk);\r\ngoto err_pltfm_free;\r\n}\r\nif (clk_set_rate(kona_dev->external_clk, host->mmc->f_max) != 0) {\r\ndev_err(dev, "Failed to set rate external clock\n");\r\ngoto err_pltfm_free;\r\n}\r\nif (clk_prepare_enable(kona_dev->external_clk) != 0) {\r\ndev_err(dev, "Failed to enable external clock\n");\r\ngoto err_pltfm_free;\r\n}\r\ndev_dbg(dev, "non-removable=%c\n",\r\n(host->mmc->caps & MMC_CAP_NONREMOVABLE) ? 'Y' : 'N');\r\ndev_dbg(dev, "cd_gpio %c, wp_gpio %c\n",\r\n(mmc_gpio_get_cd(host->mmc) != -ENOSYS) ? 'Y' : 'N',\r\n(mmc_gpio_get_ro(host->mmc) != -ENOSYS) ? 'Y' : 'N');\r\nif (host->mmc->caps & MMC_CAP_NONREMOVABLE)\r\nhost->quirks |= SDHCI_QUIRK_BROKEN_CARD_DETECTION;\r\ndev_dbg(dev, "is_8bit=%c\n",\r\n(host->mmc->caps | MMC_CAP_8_BIT_DATA) ? 'Y' : 'N');\r\nret = sdhci_bcm_kona_sd_reset(host);\r\nif (ret)\r\ngoto err_clk_disable;\r\nsdhci_bcm_kona_sd_init(host);\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_err(dev, "Failed sdhci_add_host\n");\r\ngoto err_reset;\r\n}\r\nif (host->mmc->caps & MMC_CAP_NONREMOVABLE) {\r\nret = sdhci_bcm_kona_sd_card_emulate(host, 1);\r\nif (ret) {\r\ndev_err(dev,\r\n"unable to emulate card insertion\n");\r\ngoto err_remove_host;\r\n}\r\n}\r\nif (mmc_gpio_get_cd(host->mmc) > 0)\r\nsdhci_bcm_kona_sd_card_emulate(host, 1);\r\ndev_dbg(dev, "initialized properly\n");\r\nreturn 0;\r\nerr_remove_host:\r\nsdhci_remove_host(host, 0);\r\nerr_reset:\r\nsdhci_bcm_kona_sd_reset(host);\r\nerr_clk_disable:\r\nclk_disable_unprepare(kona_dev->external_clk);\r\nerr_pltfm_free:\r\nsdhci_pltfm_free(pdev);\r\ndev_err(dev, "Probing of sdhci-pltfm failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int sdhci_bcm_kona_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_priv = sdhci_priv(host);\r\nstruct sdhci_bcm_kona_dev *kona_dev = sdhci_pltfm_priv(pltfm_priv);\r\nint dead = (readl(host->ioaddr + SDHCI_INT_STATUS) == 0xffffffff);\r\nsdhci_remove_host(host, dead);\r\nclk_disable_unprepare(kona_dev->external_clk);\r\nsdhci_pltfm_free(pdev);\r\nreturn 0;\r\n}

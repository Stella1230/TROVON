static int as102_fe_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nint ret = 0;\r\nstruct as102_dev_t *dev;\r\nstruct as10x_tune_args tune_args = { 0 };\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (mutex_lock_interruptible(&dev->bus_adap.lock))\r\nreturn -EBUSY;\r\nas102_fe_copy_tune_parameters(&tune_args, p);\r\nret = as10x_cmd_set_tune(&dev->bus_adap, &tune_args);\r\nif (ret != 0)\r\ndprintk(debug, "as10x_cmd_set_tune failed. (err = %d)\n", ret);\r\nmutex_unlock(&dev->bus_adap.lock);\r\nreturn (ret < 0) ? -EINVAL : 0;\r\n}\r\nstatic int as102_fe_get_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nint ret = 0;\r\nstruct as102_dev_t *dev;\r\nstruct as10x_tps tps = { 0 };\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&dev->bus_adap.lock))\r\nreturn -EBUSY;\r\nret = as10x_cmd_get_tps(&dev->bus_adap, &tps);\r\nif (ret == 0)\r\nas10x_fe_copy_tps_parameters(p, &tps);\r\nmutex_unlock(&dev->bus_adap.lock);\r\nreturn (ret < 0) ? -EINVAL : 0;\r\n}\r\nstatic int as102_fe_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings *settings) {\r\n#if 0\r\ndprintk(debug, "step_size = %d\n", settings->step_size);\r\ndprintk(debug, "max_drift = %d\n", settings->max_drift);\r\ndprintk(debug, "min_delay_ms = %d -> %d\n", settings->min_delay_ms,\r\n1000);\r\n#endif\r\nsettings->min_delay_ms = 1000;\r\nreturn 0;\r\n}\r\nstatic int as102_fe_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nint ret = 0;\r\nstruct as102_dev_t *dev;\r\nstruct as10x_tune_status tstate = { 0 };\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (mutex_lock_interruptible(&dev->bus_adap.lock))\r\nreturn -EBUSY;\r\nret = as10x_cmd_get_tune_status(&dev->bus_adap, &tstate);\r\nif (ret < 0) {\r\ndprintk(debug, "as10x_cmd_get_tune_status failed (err = %d)\n",\r\nret);\r\ngoto out;\r\n}\r\ndev->signal_strength = tstate.signal_strength;\r\ndev->ber = tstate.BER;\r\nswitch (tstate.tune_state) {\r\ncase TUNE_STATUS_SIGNAL_DVB_OK:\r\n*status = FE_HAS_SIGNAL | FE_HAS_CARRIER;\r\nbreak;\r\ncase TUNE_STATUS_STREAM_DETECTED:\r\n*status = FE_HAS_SIGNAL | FE_HAS_CARRIER | FE_HAS_SYNC;\r\nbreak;\r\ncase TUNE_STATUS_STREAM_TUNED:\r\n*status = FE_HAS_SIGNAL | FE_HAS_CARRIER | FE_HAS_SYNC |\r\nFE_HAS_LOCK;\r\nbreak;\r\ndefault:\r\n*status = TUNE_STATUS_NOT_TUNED;\r\n}\r\ndprintk(debug, "tuner status: 0x%02x, strength %d, per: %d, ber: %d\n",\r\ntstate.tune_state, tstate.signal_strength,\r\ntstate.PER, tstate.BER);\r\nif (*status & FE_HAS_LOCK) {\r\nif (as10x_cmd_get_demod_stats(&dev->bus_adap,\r\n(struct as10x_demod_stats *) &dev->demod_stats) < 0) {\r\nmemset(&dev->demod_stats, 0, sizeof(dev->demod_stats));\r\ndprintk(debug,\r\n"as10x_cmd_get_demod_stats failed (probably not tuned)\n");\r\n} else {\r\ndprintk(debug,\r\n"demod status: fc: 0x%08x, bad fc: 0x%08x, "\r\n"bytes corrected: 0x%08x , MER: 0x%04x\n",\r\ndev->demod_stats.frame_count,\r\ndev->demod_stats.bad_frame_count,\r\ndev->demod_stats.bytes_fixed_by_rs,\r\ndev->demod_stats.mer);\r\n}\r\n} else {\r\nmemset(&dev->demod_stats, 0, sizeof(dev->demod_stats));\r\n}\r\nout:\r\nmutex_unlock(&dev->bus_adap.lock);\r\nreturn ret;\r\n}\r\nstatic int as102_fe_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct as102_dev_t *dev;\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\n*snr = dev->demod_stats.mer;\r\nreturn 0;\r\n}\r\nstatic int as102_fe_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct as102_dev_t *dev;\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\n*ber = dev->ber;\r\nreturn 0;\r\n}\r\nstatic int as102_fe_read_signal_strength(struct dvb_frontend *fe,\r\nu16 *strength)\r\n{\r\nstruct as102_dev_t *dev;\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\n*strength = (((0xffff * 400) * dev->signal_strength + 41000) * 2);\r\nreturn 0;\r\n}\r\nstatic int as102_fe_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct as102_dev_t *dev;\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (dev->demod_stats.has_started)\r\n*ucblocks = dev->demod_stats.bad_frame_count;\r\nelse\r\n*ucblocks = 0;\r\nreturn 0;\r\n}\r\nstatic int as102_fe_ts_bus_ctrl(struct dvb_frontend *fe, int acquire)\r\n{\r\nstruct as102_dev_t *dev;\r\nint ret;\r\ndev = (struct as102_dev_t *) fe->tuner_priv;\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (mutex_lock_interruptible(&dev->bus_adap.lock))\r\nreturn -EBUSY;\r\nif (acquire) {\r\nif (elna_enable)\r\nas10x_cmd_set_context(&dev->bus_adap,\r\nCONTEXT_LNA, dev->elna_cfg);\r\nret = as10x_cmd_turn_on(&dev->bus_adap);\r\n} else {\r\nret = as10x_cmd_turn_off(&dev->bus_adap);\r\n}\r\nmutex_unlock(&dev->bus_adap.lock);\r\nreturn ret;\r\n}\r\nint as102_dvb_unregister_fe(struct dvb_frontend *fe)\r\n{\r\ndvb_unregister_frontend(fe);\r\ndvb_frontend_detach(fe);\r\nreturn 0;\r\n}\r\nint as102_dvb_register_fe(struct as102_dev_t *as102_dev,\r\nstruct dvb_frontend *dvb_fe)\r\n{\r\nint errno;\r\nstruct dvb_adapter *dvb_adap;\r\nif (as102_dev == NULL)\r\nreturn -EINVAL;\r\ndvb_adap = &as102_dev->dvb_adap;\r\nmemcpy(&dvb_fe->ops, &as102_fe_ops, sizeof(struct dvb_frontend_ops));\r\nstrncpy(dvb_fe->ops.info.name, as102_dev->name,\r\nsizeof(dvb_fe->ops.info.name));\r\nerrno = dvb_register_frontend(dvb_adap, dvb_fe);\r\nif (errno == 0)\r\ndvb_fe->tuner_priv = as102_dev;\r\nreturn errno;\r\n}\r\nstatic void as10x_fe_copy_tps_parameters(struct dtv_frontend_properties *fe_tps,\r\nstruct as10x_tps *as10x_tps)\r\n{\r\nswitch (as10x_tps->modulation) {\r\ncase CONST_QPSK:\r\nfe_tps->modulation = QPSK;\r\nbreak;\r\ncase CONST_QAM16:\r\nfe_tps->modulation = QAM_16;\r\nbreak;\r\ncase CONST_QAM64:\r\nfe_tps->modulation = QAM_64;\r\nbreak;\r\n}\r\nswitch (as10x_tps->hierarchy) {\r\ncase HIER_NONE:\r\nfe_tps->hierarchy = HIERARCHY_NONE;\r\nbreak;\r\ncase HIER_ALPHA_1:\r\nfe_tps->hierarchy = HIERARCHY_1;\r\nbreak;\r\ncase HIER_ALPHA_2:\r\nfe_tps->hierarchy = HIERARCHY_2;\r\nbreak;\r\ncase HIER_ALPHA_4:\r\nfe_tps->hierarchy = HIERARCHY_4;\r\nbreak;\r\n}\r\nswitch (as10x_tps->code_rate_HP) {\r\ncase CODE_RATE_1_2:\r\nfe_tps->code_rate_HP = FEC_1_2;\r\nbreak;\r\ncase CODE_RATE_2_3:\r\nfe_tps->code_rate_HP = FEC_2_3;\r\nbreak;\r\ncase CODE_RATE_3_4:\r\nfe_tps->code_rate_HP = FEC_3_4;\r\nbreak;\r\ncase CODE_RATE_5_6:\r\nfe_tps->code_rate_HP = FEC_5_6;\r\nbreak;\r\ncase CODE_RATE_7_8:\r\nfe_tps->code_rate_HP = FEC_7_8;\r\nbreak;\r\n}\r\nswitch (as10x_tps->code_rate_LP) {\r\ncase CODE_RATE_1_2:\r\nfe_tps->code_rate_LP = FEC_1_2;\r\nbreak;\r\ncase CODE_RATE_2_3:\r\nfe_tps->code_rate_LP = FEC_2_3;\r\nbreak;\r\ncase CODE_RATE_3_4:\r\nfe_tps->code_rate_LP = FEC_3_4;\r\nbreak;\r\ncase CODE_RATE_5_6:\r\nfe_tps->code_rate_LP = FEC_5_6;\r\nbreak;\r\ncase CODE_RATE_7_8:\r\nfe_tps->code_rate_LP = FEC_7_8;\r\nbreak;\r\n}\r\nswitch (as10x_tps->guard_interval) {\r\ncase GUARD_INT_1_32:\r\nfe_tps->guard_interval = GUARD_INTERVAL_1_32;\r\nbreak;\r\ncase GUARD_INT_1_16:\r\nfe_tps->guard_interval = GUARD_INTERVAL_1_16;\r\nbreak;\r\ncase GUARD_INT_1_8:\r\nfe_tps->guard_interval = GUARD_INTERVAL_1_8;\r\nbreak;\r\ncase GUARD_INT_1_4:\r\nfe_tps->guard_interval = GUARD_INTERVAL_1_4;\r\nbreak;\r\n}\r\nswitch (as10x_tps->transmission_mode) {\r\ncase TRANS_MODE_2K:\r\nfe_tps->transmission_mode = TRANSMISSION_MODE_2K;\r\nbreak;\r\ncase TRANS_MODE_8K:\r\nfe_tps->transmission_mode = TRANSMISSION_MODE_8K;\r\nbreak;\r\n}\r\n}\r\nstatic uint8_t as102_fe_get_code_rate(fe_code_rate_t arg)\r\n{\r\nuint8_t c;\r\nswitch (arg) {\r\ncase FEC_1_2:\r\nc = CODE_RATE_1_2;\r\nbreak;\r\ncase FEC_2_3:\r\nc = CODE_RATE_2_3;\r\nbreak;\r\ncase FEC_3_4:\r\nc = CODE_RATE_3_4;\r\nbreak;\r\ncase FEC_5_6:\r\nc = CODE_RATE_5_6;\r\nbreak;\r\ncase FEC_7_8:\r\nc = CODE_RATE_7_8;\r\nbreak;\r\ndefault:\r\nc = CODE_RATE_UNKNOWN;\r\nbreak;\r\n}\r\nreturn c;\r\n}\r\nstatic void as102_fe_copy_tune_parameters(struct as10x_tune_args *tune_args,\r\nstruct dtv_frontend_properties *params)\r\n{\r\ntune_args->freq = params->frequency / 1000;\r\ntune_args->interleaving_mode = INTLV_NATIVE;\r\nswitch (params->bandwidth_hz) {\r\ncase 8000000:\r\ntune_args->bandwidth = BW_8_MHZ;\r\nbreak;\r\ncase 7000000:\r\ntune_args->bandwidth = BW_7_MHZ;\r\nbreak;\r\ncase 6000000:\r\ntune_args->bandwidth = BW_6_MHZ;\r\nbreak;\r\ndefault:\r\ntune_args->bandwidth = BW_8_MHZ;\r\n}\r\nswitch (params->guard_interval) {\r\ncase GUARD_INTERVAL_1_32:\r\ntune_args->guard_interval = GUARD_INT_1_32;\r\nbreak;\r\ncase GUARD_INTERVAL_1_16:\r\ntune_args->guard_interval = GUARD_INT_1_16;\r\nbreak;\r\ncase GUARD_INTERVAL_1_8:\r\ntune_args->guard_interval = GUARD_INT_1_8;\r\nbreak;\r\ncase GUARD_INTERVAL_1_4:\r\ntune_args->guard_interval = GUARD_INT_1_4;\r\nbreak;\r\ncase GUARD_INTERVAL_AUTO:\r\ndefault:\r\ntune_args->guard_interval = GUARD_UNKNOWN;\r\nbreak;\r\n}\r\nswitch (params->modulation) {\r\ncase QPSK:\r\ntune_args->modulation = CONST_QPSK;\r\nbreak;\r\ncase QAM_16:\r\ntune_args->modulation = CONST_QAM16;\r\nbreak;\r\ncase QAM_64:\r\ntune_args->modulation = CONST_QAM64;\r\nbreak;\r\ndefault:\r\ntune_args->modulation = CONST_UNKNOWN;\r\nbreak;\r\n}\r\nswitch (params->transmission_mode) {\r\ncase TRANSMISSION_MODE_2K:\r\ntune_args->transmission_mode = TRANS_MODE_2K;\r\nbreak;\r\ncase TRANSMISSION_MODE_8K:\r\ntune_args->transmission_mode = TRANS_MODE_8K;\r\nbreak;\r\ndefault:\r\ntune_args->transmission_mode = TRANS_MODE_UNKNOWN;\r\n}\r\nswitch (params->hierarchy) {\r\ncase HIERARCHY_NONE:\r\ntune_args->hierarchy = HIER_NONE;\r\nbreak;\r\ncase HIERARCHY_1:\r\ntune_args->hierarchy = HIER_ALPHA_1;\r\nbreak;\r\ncase HIERARCHY_2:\r\ntune_args->hierarchy = HIER_ALPHA_2;\r\nbreak;\r\ncase HIERARCHY_4:\r\ntune_args->hierarchy = HIER_ALPHA_4;\r\nbreak;\r\ncase HIERARCHY_AUTO:\r\ntune_args->hierarchy = HIER_UNKNOWN;\r\nbreak;\r\n}\r\ndprintk(debug, "tuner parameters: freq: %d bw: 0x%02x gi: 0x%02x\n",\r\nparams->frequency,\r\ntune_args->bandwidth,\r\ntune_args->guard_interval);\r\nif ((tune_args->hierarchy != HIER_NONE) &&\r\n((params->code_rate_LP == FEC_NONE) ||\r\n(params->code_rate_HP == FEC_NONE))) {\r\nif (params->code_rate_LP == FEC_NONE) {\r\ntune_args->hier_select = HIER_HIGH_PRIORITY;\r\ntune_args->code_rate =\r\nas102_fe_get_code_rate(params->code_rate_HP);\r\n}\r\nif (params->code_rate_HP == FEC_NONE) {\r\ntune_args->hier_select = HIER_LOW_PRIORITY;\r\ntune_args->code_rate =\r\nas102_fe_get_code_rate(params->code_rate_LP);\r\n}\r\ndprintk(debug,\r\n"\thierarchy: 0x%02x selected: %s code_rate_%s: 0x%02x\n",\r\ntune_args->hierarchy,\r\ntune_args->hier_select == HIER_HIGH_PRIORITY ?\r\n"HP" : "LP",\r\ntune_args->hier_select == HIER_HIGH_PRIORITY ?\r\n"HP" : "LP",\r\ntune_args->code_rate);\r\n} else {\r\ntune_args->code_rate =\r\nas102_fe_get_code_rate(params->code_rate_HP);\r\n}\r\n}

static void __iomem * __init earlycon_map(unsigned long paddr, size_t size)\r\n{\r\nvoid __iomem *base;\r\n#ifdef CONFIG_FIX_EARLYCON_MEM\r\nset_fixmap_io(FIX_EARLYCON_MEM_BASE, paddr & PAGE_MASK);\r\nbase = (void __iomem *)__fix_to_virt(FIX_EARLYCON_MEM_BASE);\r\nbase += paddr & ~PAGE_MASK;\r\n#else\r\nbase = ioremap(paddr, size);\r\n#endif\r\nif (!base)\r\npr_err("%s: Couldn't map 0x%llx\n", __func__,\r\n(unsigned long long)paddr);\r\nreturn base;\r\n}\r\nstatic int __init parse_options(struct earlycon_device *device,\r\nchar *options)\r\n{\r\nstruct uart_port *port = &device->port;\r\nint mmio, mmio32, length;\r\nunsigned long addr;\r\nif (!options)\r\nreturn -ENODEV;\r\nmmio = !strncmp(options, "mmio,", 5);\r\nmmio32 = !strncmp(options, "mmio32,", 7);\r\nif (mmio || mmio32) {\r\nport->iotype = (mmio ? UPIO_MEM : UPIO_MEM32);\r\noptions += mmio ? 5 : 7;\r\naddr = simple_strtoul(options, NULL, 0);\r\nport->mapbase = addr;\r\nif (mmio32)\r\nport->regshift = 2;\r\n} else if (!strncmp(options, "io,", 3)) {\r\nport->iotype = UPIO_PORT;\r\noptions += 3;\r\naddr = simple_strtoul(options, NULL, 0);\r\nport->iobase = addr;\r\nmmio = 0;\r\n} else if (!strncmp(options, "0x", 2)) {\r\nport->iotype = UPIO_MEM;\r\naddr = simple_strtoul(options, NULL, 0);\r\nport->mapbase = addr;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nport->uartclk = BASE_BAUD * 16;\r\noptions = strchr(options, ',');\r\nif (options) {\r\noptions++;\r\ndevice->baud = simple_strtoul(options, NULL, 0);\r\nlength = min(strcspn(options, " ") + 1,\r\n(size_t)(sizeof(device->options)));\r\nstrlcpy(device->options, options, length);\r\n}\r\nif (mmio || mmio32)\r\npr_info("Early serial console at MMIO%s 0x%llx (options '%s')\n",\r\nmmio32 ? "32" : "",\r\n(unsigned long long)port->mapbase,\r\ndevice->options);\r\nelse\r\npr_info("Early serial console at I/O port 0x%lx (options '%s')\n",\r\nport->iobase,\r\ndevice->options);\r\nreturn 0;\r\n}\r\nint __init setup_earlycon(char *buf, const char *match,\r\nint (*setup)(struct earlycon_device *, const char *))\r\n{\r\nint err;\r\nsize_t len;\r\nstruct uart_port *port = &early_console_dev.port;\r\nif (!buf || !match || !setup)\r\nreturn 0;\r\nlen = strlen(match);\r\nif (strncmp(buf, match, len))\r\nreturn 0;\r\nif (buf[len] && (buf[len] != ','))\r\nreturn 0;\r\nbuf += len + 1;\r\nerr = parse_options(&early_console_dev, buf);\r\nif (!err)\r\nbuf = NULL;\r\nif (port->mapbase)\r\nport->membase = earlycon_map(port->mapbase, 64);\r\nearly_console_dev.con->data = &early_console_dev;\r\nerr = setup(&early_console_dev, buf);\r\nif (err < 0)\r\nreturn err;\r\nif (!early_console_dev.con->write)\r\nreturn -ENODEV;\r\nregister_console(early_console_dev.con);\r\nreturn 0;\r\n}\r\nint __init of_setup_earlycon(unsigned long addr,\r\nint (*setup)(struct earlycon_device *, const char *))\r\n{\r\nint err;\r\nstruct uart_port *port = &early_console_dev.port;\r\nport->iotype = UPIO_MEM;\r\nport->mapbase = addr;\r\nport->uartclk = BASE_BAUD * 16;\r\nport->membase = earlycon_map(addr, SZ_4K);\r\nearly_console_dev.con->data = &early_console_dev;\r\nerr = setup(&early_console_dev, NULL);\r\nif (err < 0)\r\nreturn err;\r\nif (!early_console_dev.con->write)\r\nreturn -ENODEV;\r\nregister_console(early_console_dev.con);\r\nreturn 0;\r\n}

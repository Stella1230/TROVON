static noinline void print_reg_file(long *reg_rev, int start_num)\r\n{\r\nunsigned int i;\r\nchar buf[512];\r\nint n = 0, len = sizeof(buf);\r\nfor (i = start_num; i < start_num + 13; i++) {\r\nn += scnprintf(buf + n, len - n, "r%02u: 0x%08lx\t",\r\ni, (unsigned long)*reg_rev);\r\nif (((i + 1) % 3) == 0)\r\nn += scnprintf(buf + n, len - n, "\n");\r\nreg_rev--;\r\n}\r\nif (start_num != 0)\r\nn += scnprintf(buf + n, len - n, "\n\n");\r\nif (start_num == 0)\r\npr_info("%s", buf);\r\nelse\r\npr_cont("%s\n", buf);\r\n}\r\nstatic void show_callee_regs(struct callee_regs *cregs)\r\n{\r\nprint_reg_file(&(cregs->r13), 13);\r\n}\r\nvoid print_task_path_n_nm(struct task_struct *tsk, char *buf)\r\n{\r\nstruct path path;\r\nchar *path_nm = NULL;\r\nstruct mm_struct *mm;\r\nstruct file *exe_file;\r\nmm = get_task_mm(tsk);\r\nif (!mm)\r\ngoto done;\r\nexe_file = get_mm_exe_file(mm);\r\nmmput(mm);\r\nif (exe_file) {\r\npath = exe_file->f_path;\r\npath_get(&exe_file->f_path);\r\nfput(exe_file);\r\npath_nm = d_path(&path, buf, 255);\r\npath_put(&path);\r\n}\r\ndone:\r\npr_info("Path: %s\n", path_nm);\r\n}\r\nstatic void show_faulting_vma(unsigned long address, char *buf)\r\n{\r\nstruct vm_area_struct *vma;\r\nstruct inode *inode;\r\nunsigned long ino = 0;\r\ndev_t dev = 0;\r\nchar *nm = buf;\r\nstruct mm_struct *active_mm = current->active_mm;\r\ndown_read(&active_mm->mmap_sem);\r\nvma = find_vma(active_mm, address);\r\nif (vma && (vma->vm_start <= address)) {\r\nstruct file *file = vma->vm_file;\r\nif (file) {\r\nstruct path *path = &file->f_path;\r\nnm = d_path(path, buf, PAGE_SIZE - 1);\r\ninode = file_inode(vma->vm_file);\r\ndev = inode->i_sb->s_dev;\r\nino = inode->i_ino;\r\n}\r\npr_info(" @off 0x%lx in [%s]\n"\r\n" VMA: 0x%08lx to 0x%08lx\n",\r\nvma->vm_start < TASK_UNMAPPED_BASE ?\r\naddress : address - vma->vm_start,\r\nnm, vma->vm_start, vma->vm_end);\r\n} else\r\npr_info(" @No matching VMA found\n");\r\nup_read(&active_mm->mmap_sem);\r\n}\r\nstatic void show_ecr_verbose(struct pt_regs *regs)\r\n{\r\nunsigned int vec, cause_code;\r\nunsigned long address;\r\npr_info("\n[ECR ]: 0x%08lx => ", regs->event);\r\naddress = current->thread.fault_address;\r\nvec = regs->ecr_vec;\r\ncause_code = regs->ecr_cause;\r\nif (vec == ECR_V_DTLB_MISS) {\r\npr_cont("Invalid %s @ 0x%08lx by insn @ 0x%08lx\n",\r\n(cause_code == 0x01) ? "Read" :\r\n((cause_code == 0x02) ? "Write" : "EX"),\r\naddress, regs->ret);\r\n} else if (vec == ECR_V_ITLB_MISS) {\r\npr_cont("Insn could not be fetched\n");\r\n} else if (vec == ECR_V_MACH_CHK) {\r\npr_cont("%s\n", (cause_code == 0x0) ?\r\n"Double Fault" : "Other Fatal Err");\r\n} else if (vec == ECR_V_PROTV) {\r\nif (cause_code == ECR_C_PROTV_INST_FETCH)\r\npr_cont("Execute from Non-exec Page\n");\r\nelse if (cause_code == ECR_C_PROTV_MISALIG_DATA)\r\npr_cont("Misaligned r/w from 0x%08lx\n", address);\r\nelse\r\npr_cont("%s access not allowed on page\n",\r\n(cause_code == 0x01) ? "Read" :\r\n((cause_code == 0x02) ? "Write" : "EX"));\r\n} else if (vec == ECR_V_INSN_ERR) {\r\npr_cont("Illegal Insn\n");\r\n} else {\r\npr_cont("Check Programmer's Manual\n");\r\n}\r\n}\r\nvoid show_regs(struct pt_regs *regs)\r\n{\r\nstruct task_struct *tsk = current;\r\nstruct callee_regs *cregs;\r\nchar *buf;\r\nbuf = (char *)__get_free_page(GFP_TEMPORARY);\r\nif (!buf)\r\nreturn;\r\nprint_task_path_n_nm(tsk, buf);\r\nshow_regs_print_info(KERN_INFO);\r\nshow_ecr_verbose(regs);\r\npr_info("[EFA ]: 0x%08lx\n[BLINK ]: %pS\n[ERET ]: %pS\n",\r\ncurrent->thread.fault_address,\r\n(void *)regs->blink, (void *)regs->ret);\r\nif (user_mode(regs))\r\nshow_faulting_vma(regs->ret, buf);\r\npr_info("[STAT32]: 0x%08lx", regs->status32);\r\n#define STS_BIT(r, bit) r->status32 & STATUS_##bit##_MASK ? #bit : ""\r\nif (!user_mode(regs))\r\npr_cont(" : %2s %2s %2s %2s %2s\n",\r\nSTS_BIT(regs, AE), STS_BIT(regs, A2), STS_BIT(regs, A1),\r\nSTS_BIT(regs, E2), STS_BIT(regs, E1));\r\npr_info("BTA: 0x%08lx\t SP: 0x%08lx\t FP: 0x%08lx\n",\r\nregs->bta, regs->sp, regs->fp);\r\npr_info("LPS: 0x%08lx\tLPE: 0x%08lx\tLPC: 0x%08lx\n",\r\nregs->lp_start, regs->lp_end, regs->lp_count);\r\nprint_reg_file(&(regs->r0), 0);\r\ncregs = (struct callee_regs *)current->thread.callee_reg;\r\nif (cregs)\r\nshow_callee_regs(cregs);\r\nfree_page((unsigned long)buf);\r\n}\r\nvoid show_kernel_fault_diag(const char *str, struct pt_regs *regs,\r\nunsigned long address)\r\n{\r\ncurrent->thread.fault_address = address;\r\nshow_regs(regs);\r\nif (!user_mode(regs))\r\nshow_stacktrace(current, regs);\r\n}\r\nstatic int fill_display_data(char *kbuf)\r\n{\r\nsize_t num = 0;\r\nnum += sprintf(kbuf + num, "I-TLB Miss %x\n", numitlb);\r\nnum += sprintf(kbuf + num, "D-TLB Miss %x\n", numdtlb);\r\nnum += sprintf(kbuf + num, "PTE not present %x\n", num_pte_not_present);\r\nif (clr_on_read)\r\nnumitlb = numdtlb = num_pte_not_present = 0;\r\nreturn num;\r\n}\r\nstatic int tlb_stats_open(struct inode *inode, struct file *file)\r\n{\r\nfile->private_data = (void *)__get_free_page(GFP_KERNEL);\r\nreturn 0;\r\n}\r\nstatic ssize_t tlb_stats_output(struct file *file,\r\nchar __user *user_buf,\r\nsize_t len,\r\nloff_t *offset)\r\n{\r\nsize_t num;\r\nchar *kbuf = (char *)file->private_data;\r\nif (*offset != 0)\r\nreturn 0;\r\nnum = fill_display_data(kbuf);\r\nreturn simple_read_from_buffer(user_buf, num, offset, kbuf, len);\r\n}\r\nstatic ssize_t tlb_stats_clear(struct file *file, const char __user *user_buf,\r\nsize_t length, loff_t *offset)\r\n{\r\nnumitlb = numdtlb = num_pte_not_present = 0;\r\nreturn length;\r\n}\r\nstatic int tlb_stats_close(struct inode *inode, struct file *file)\r\n{\r\nfree_page((unsigned long)(file->private_data));\r\nreturn 0;\r\n}\r\nstatic int __init arc_debugfs_init(void)\r\n{\r\ntest_dir = debugfs_create_dir("arc", NULL);\r\n#ifdef CONFIG_ARC_DBG_TLB_MISS_COUNT\r\ntest_dentry = debugfs_create_file("tlb_stats", 0444, test_dir, NULL,\r\n&tlb_stats_file_ops);\r\n#endif\r\ntest_u32_dentry =\r\ndebugfs_create_u32("clr_on_read", 0444, test_dir, &clr_on_read);\r\nreturn 0;\r\n}\r\nstatic void __exit arc_debugfs_exit(void)\r\n{\r\ndebugfs_remove(test_u32_dentry);\r\ndebugfs_remove(test_dentry);\r\ndebugfs_remove(test_dir);\r\n}

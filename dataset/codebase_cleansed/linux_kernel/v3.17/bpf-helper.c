int bpf_resolve_jumps(struct bpf_labels *labels,\r\nstruct sock_filter *filter, size_t count)\r\n{\r\nstruct sock_filter *begin = filter;\r\n__u8 insn = count - 1;\r\nif (count < 1)\r\nreturn -1;\r\nfilter += insn;\r\nfor (; filter >= begin; --insn, --filter) {\r\nif (filter->code != (BPF_JMP+BPF_JA))\r\ncontinue;\r\nswitch ((filter->jt<<8)|filter->jf) {\r\ncase (JUMP_JT<<8)|JUMP_JF:\r\nif (labels->labels[filter->k].location == 0xffffffff) {\r\nfprintf(stderr, "Unresolved label: '%s'\n",\r\nlabels->labels[filter->k].label);\r\nreturn 1;\r\n}\r\nfilter->k = labels->labels[filter->k].location -\r\n(insn + 1);\r\nfilter->jt = 0;\r\nfilter->jf = 0;\r\ncontinue;\r\ncase (LABEL_JT<<8)|LABEL_JF:\r\nif (labels->labels[filter->k].location != 0xffffffff) {\r\nfprintf(stderr, "Duplicate label use: '%s'\n",\r\nlabels->labels[filter->k].label);\r\nreturn 1;\r\n}\r\nlabels->labels[filter->k].location = insn;\r\nfilter->k = 0;\r\nfilter->jt = 0;\r\nfilter->jf = 0;\r\ncontinue;\r\n}\r\n}\r\nreturn 0;\r\n}\r\n__u32 seccomp_bpf_label(struct bpf_labels *labels, const char *label)\r\n{\r\nstruct __bpf_label *begin = labels->labels, *end;\r\nint id;\r\nif (labels->count == 0) {\r\nbegin->label = label;\r\nbegin->location = 0xffffffff;\r\nlabels->count++;\r\nreturn 0;\r\n}\r\nend = begin + labels->count;\r\nfor (id = 0; begin < end; ++begin, ++id) {\r\nif (!strcmp(label, begin->label))\r\nreturn id;\r\n}\r\nbegin->label = label;\r\nbegin->location = 0xffffffff;\r\nlabels->count++;\r\nreturn id;\r\n}\r\nvoid seccomp_bpf_print(struct sock_filter *filter, size_t count)\r\n{\r\nstruct sock_filter *end = filter + count;\r\nfor ( ; filter < end; ++filter)\r\nprintf("{ code=%u,jt=%u,jf=%u,k=%u },\n",\r\nfilter->code, filter->jt, filter->jf, filter->k);\r\n}

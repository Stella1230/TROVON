static int zt5550_hc_config(struct pci_dev *pdev)\r\n{\r\nint ret;\r\nif(hc_dev) {\r\nerr("too many host controller devices?");\r\nreturn -EBUSY;\r\n}\r\nret = pci_enable_device(pdev);\r\nif(ret) {\r\nerr("cannot enable %s\n", pci_name(pdev));\r\nreturn ret;\r\n}\r\nhc_dev = pdev;\r\ndbg("hc_dev = %p", hc_dev);\r\ndbg("pci resource start %llx", (unsigned long long)pci_resource_start(hc_dev, 1));\r\ndbg("pci resource len %llx", (unsigned long long)pci_resource_len(hc_dev, 1));\r\nif(!request_mem_region(pci_resource_start(hc_dev, 1),\r\npci_resource_len(hc_dev, 1), MY_NAME)) {\r\nerr("cannot reserve MMIO region");\r\nret = -ENOMEM;\r\ngoto exit_disable_device;\r\n}\r\nhc_registers =\r\nioremap(pci_resource_start(hc_dev, 1), pci_resource_len(hc_dev, 1));\r\nif(!hc_registers) {\r\nerr("cannot remap MMIO region %llx @ %llx",\r\n(unsigned long long)pci_resource_len(hc_dev, 1),\r\n(unsigned long long)pci_resource_start(hc_dev, 1));\r\nret = -ENODEV;\r\ngoto exit_release_region;\r\n}\r\ncsr_hc_index = hc_registers + CSR_HCINDEX;\r\ncsr_hc_data = hc_registers + CSR_HCDATA;\r\ncsr_int_status = hc_registers + CSR_INTSTAT;\r\ncsr_int_mask = hc_registers + CSR_INTMASK;\r\ndbg("disabling host control, fault and serial interrupts");\r\nwriteb((u8) HC_INT_MASK_REG, csr_hc_index);\r\nwriteb((u8) ALL_INDEXED_INTS_MASK, csr_hc_data);\r\ndbg("disabled host control, fault and serial interrupts");\r\ndbg("disabling timer0, timer1 and ENUM interrupts");\r\nwriteb((u8) ALL_DIRECT_INTS_MASK, csr_int_mask);\r\ndbg("disabled timer0, timer1 and ENUM interrupts");\r\nreturn 0;\r\nexit_release_region:\r\nrelease_mem_region(pci_resource_start(hc_dev, 1),\r\npci_resource_len(hc_dev, 1));\r\nexit_disable_device:\r\npci_disable_device(hc_dev);\r\nreturn ret;\r\n}\r\nstatic int zt5550_hc_cleanup(void)\r\n{\r\nif(!hc_dev)\r\nreturn -ENODEV;\r\niounmap(hc_registers);\r\nrelease_mem_region(pci_resource_start(hc_dev, 1),\r\npci_resource_len(hc_dev, 1));\r\npci_disable_device(hc_dev);\r\nreturn 0;\r\n}\r\nstatic int zt5550_hc_query_enum(void)\r\n{\r\nu8 value;\r\nvalue = inb_p(ENUM_PORT);\r\nreturn ((value & ENUM_MASK) == ENUM_MASK);\r\n}\r\nstatic int zt5550_hc_check_irq(void *dev_id)\r\n{\r\nint ret;\r\nu8 reg;\r\nret = 0;\r\nif(dev_id == zt5550_hpc.dev_id) {\r\nreg = readb(csr_int_status);\r\nif(reg)\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int zt5550_hc_enable_irq(void)\r\n{\r\nu8 reg;\r\nif(hc_dev == NULL) {\r\nreturn -ENODEV;\r\n}\r\nreg = readb(csr_int_mask);\r\nreg = reg & ~ENUM_INT_MASK;\r\nwriteb(reg, csr_int_mask);\r\nreturn 0;\r\n}\r\nstatic int zt5550_hc_disable_irq(void)\r\n{\r\nu8 reg;\r\nif(hc_dev == NULL) {\r\nreturn -ENODEV;\r\n}\r\nreg = readb(csr_int_mask);\r\nreg = reg | ENUM_INT_MASK;\r\nwriteb(reg, csr_int_mask);\r\nreturn 0;\r\n}\r\nstatic int zt5550_hc_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nint status;\r\nstatus = zt5550_hc_config(pdev);\r\nif(status != 0) {\r\nreturn status;\r\n}\r\ndbg("returned from zt5550_hc_config");\r\nmemset(&zt5550_hpc, 0, sizeof (struct cpci_hp_controller));\r\nzt5550_hpc_ops.query_enum = zt5550_hc_query_enum;\r\nzt5550_hpc.ops = &zt5550_hpc_ops;\r\nif(!poll) {\r\nzt5550_hpc.irq = hc_dev->irq;\r\nzt5550_hpc.irq_flags = IRQF_SHARED;\r\nzt5550_hpc.dev_id = hc_dev;\r\nzt5550_hpc_ops.enable_irq = zt5550_hc_enable_irq;\r\nzt5550_hpc_ops.disable_irq = zt5550_hc_disable_irq;\r\nzt5550_hpc_ops.check_irq = zt5550_hc_check_irq;\r\n} else {\r\ninfo("using ENUM# polling mode");\r\n}\r\nstatus = cpci_hp_register_controller(&zt5550_hpc);\r\nif(status != 0) {\r\nerr("could not register cPCI hotplug controller");\r\ngoto init_hc_error;\r\n}\r\ndbg("registered controller");\r\nif(!(bus0_dev = pci_get_device(PCI_VENDOR_ID_DEC,\r\nPCI_DEVICE_ID_DEC_21154, NULL))) {\r\nstatus = -ENODEV;\r\ngoto init_register_error;\r\n}\r\nbus0 = bus0_dev->subordinate;\r\npci_dev_put(bus0_dev);\r\nstatus = cpci_hp_register_bus(bus0, 0x0a, 0x0f);\r\nif(status != 0) {\r\nerr("could not register cPCI hotplug bus");\r\ngoto init_register_error;\r\n}\r\ndbg("registered bus");\r\nstatus = cpci_hp_start();\r\nif(status != 0) {\r\nerr("could not started cPCI hotplug system");\r\ncpci_hp_unregister_bus(bus0);\r\ngoto init_register_error;\r\n}\r\ndbg("started cpci hp system");\r\nreturn 0;\r\ninit_register_error:\r\ncpci_hp_unregister_controller(&zt5550_hpc);\r\ninit_hc_error:\r\nerr("status = %d", status);\r\nzt5550_hc_cleanup();\r\nreturn status;\r\n}\r\nstatic void zt5550_hc_remove_one(struct pci_dev *pdev)\r\n{\r\ncpci_hp_stop();\r\ncpci_hp_unregister_bus(bus0);\r\ncpci_hp_unregister_controller(&zt5550_hpc);\r\nzt5550_hc_cleanup();\r\n}\r\nstatic int __init zt5550_init(void)\r\n{\r\nstruct resource *r;\r\nint rc;\r\ninfo(DRIVER_DESC " version: " DRIVER_VERSION);\r\nr = request_region(ENUM_PORT, 1, "#ENUM hotswap signal register");\r\nif(!r)\r\nreturn -EBUSY;\r\nrc = pci_register_driver(&zt5550_hc_driver);\r\nif(rc < 0)\r\nrelease_region(ENUM_PORT, 1);\r\nreturn rc;\r\n}\r\nstatic void __exit\r\nzt5550_exit(void)\r\n{\r\npci_unregister_driver(&zt5550_hc_driver);\r\nrelease_region(ENUM_PORT, 1);\r\n}

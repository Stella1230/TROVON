static int\r\ndecode_pst(char *p, int npstates)\r\n{\r\nint i;\r\nint freq, fid, vid;\r\nfor (i = 0; i < npstates; ++i) {\r\nfid = *p++;\r\nvid = *p++;\r\nfreq = 100 * fid_to_mult[fid] * fsb;\r\nprintf(" %2d %8dkHz FID %02x (%2d.%01d) VID %02x (%4dmV)\n",\r\ni,\r\nfreq,\r\nfid, fid_to_mult[fid]/10, fid_to_mult[fid]%10,\r\nvid, vid_to_voltage[vid]);\r\n}\r\nreturn 0;\r\n}\r\nstatic\r\nvoid decode_psb(char *p, int numpst)\r\n{\r\nint i;\r\nstruct psb_header *psb;\r\nstruct pst_header *pst;\r\npsb = (struct psb_header*) p;\r\nif (psb->version != 0x12)\r\nreturn;\r\nprintf("PSB version: %hhx flags: %hhx settling time %hhuus res1 %hhx num pst %hhu\n",\r\npsb->version,\r\npsb->flags,\r\npsb->settlingtime,\r\npsb->res1,\r\npsb->numpst);\r\nsgtc = psb->settlingtime * 100;\r\nif (sgtc < 10000)\r\nsgtc = 10000;\r\np = ((char *) psb) + sizeof(struct psb_header);\r\nif (numpst < 0)\r\nnumpst = psb->numpst;\r\nelse\r\nprintf("Overriding number of pst :%d\n", numpst);\r\nfor (i = 0; i < numpst; i++) {\r\npst = (struct pst_header*) p;\r\nif (relevant != 0) {\r\nif (relevant!= pst->cpuid)\r\ngoto next_one;\r\n}\r\nprintf(" PST %d cpuid %.3x fsb %hhu mfid %hhx svid %hhx numberstates %hhu\n",\r\ni+1,\r\npst->cpuid,\r\npst->fsb,\r\npst->maxfid,\r\npst->startvid,\r\npst->numpstates);\r\nfsb = pst->fsb;\r\ndecode_pst(p + sizeof(struct pst_header), pst->numpstates);\r\nnext_one:\r\np += sizeof(struct pst_header) + 2*pst->numpstates;\r\n}\r\n}\r\nvoid print_help(void)\r\n{\r\nprintf ("Usage: dump_psb [options]\n");\r\nprintf ("Options:\n");\r\nprintf (" -n, --numpst Set number of PST tables to scan\n");\r\nprintf (" -r, --relevant Only display PSTs relevant to cpuid N\n");\r\n}\r\nint\r\nmain(int argc, char *argv[])\r\n{\r\nint fd;\r\nint numpst=-1;\r\nint ret=0, cont=1;\r\nchar *mem = NULL;\r\nchar *p;\r\ndo {\r\nret = getopt_long(argc, argv, "hr:n:", info_opts, NULL);\r\nswitch (ret){\r\ncase '?':\r\ncase 'h':\r\nprint_help();\r\ncont = 0;\r\nbreak;\r\ncase 'r':\r\nrelevant = strtol(optarg, NULL, 16);\r\nbreak;\r\ncase 'n':\r\nnumpst = strtol(optarg, NULL, 10);\r\nbreak;\r\ncase -1:\r\ncont = 0;\r\nbreak;\r\n}\r\n} while(cont);\r\nfd = open("/dev/mem", O_RDONLY);\r\nif (fd < 0) {\r\nprintf ("Couldn't open /dev/mem. Are you root?\n");\r\nexit(1);\r\n}\r\nmem = mmap(mem, 0x100000 - 0xc0000, PROT_READ, MAP_SHARED, fd, 0xc0000);\r\nclose(fd);\r\nfor (p = mem; p - mem < LEN; p+=16) {\r\nif (memcmp(p, "AMDK7PNOW!", 10) == 0) {\r\ndecode_psb(p, numpst);\r\nbreak;\r\n}\r\n}\r\nmunmap(mem, LEN);\r\nreturn 0;\r\n}

static unsigned long amb_reg_temp_status(unsigned int amb)\r\n{\r\nreturn AMB_FUNC_3_OFFSET + AMB_REG_TEMP_STATUS_ADDR +\r\nAMB_CONFIG_SIZE * amb;\r\n}\r\nstatic unsigned long amb_reg_temp_min(unsigned int amb)\r\n{\r\nreturn AMB_FUNC_3_OFFSET + AMB_REG_TEMP_MIN_ADDR +\r\nAMB_CONFIG_SIZE * amb;\r\n}\r\nstatic unsigned long amb_reg_temp_mid(unsigned int amb)\r\n{\r\nreturn AMB_FUNC_3_OFFSET + AMB_REG_TEMP_MID_ADDR +\r\nAMB_CONFIG_SIZE * amb;\r\n}\r\nstatic unsigned long amb_reg_temp_max(unsigned int amb)\r\n{\r\nreturn AMB_FUNC_3_OFFSET + AMB_REG_TEMP_MAX_ADDR +\r\nAMB_CONFIG_SIZE * amb;\r\n}\r\nstatic unsigned long amb_reg_temp(unsigned int amb)\r\n{\r\nreturn AMB_FUNC_3_OFFSET + AMB_REG_TEMP_ADDR +\r\nAMB_CONFIG_SIZE * amb;\r\n}\r\nstatic unsigned long amb_num_from_reg(unsigned int byte_num, unsigned int bit)\r\n{\r\nreturn byte_num * MAX_AMBS_PER_CHANNEL + bit;\r\n}\r\nstatic ssize_t show_name(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", DRVNAME);\r\n}\r\nstatic u8 amb_read_byte(struct i5k_amb_data *data, unsigned long offset)\r\n{\r\nreturn ioread8(data->amb_mmio + offset);\r\n}\r\nstatic void amb_write_byte(struct i5k_amb_data *data, unsigned long offset,\r\nu8 val)\r\n{\r\niowrite8(val, data->amb_mmio + offset);\r\n}\r\nstatic ssize_t show_amb_alarm(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nif (!(amb_read_byte(data, amb_reg_temp_status(attr->index)) & 0x20) &&\r\n(amb_read_byte(data, amb_reg_temp_status(attr->index)) & 0x8))\r\nreturn sprintf(buf, "1\n");\r\nelse\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t store_amb_min(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nunsigned long temp;\r\nint ret = kstrtoul(buf, 10, &temp);\r\nif (ret < 0)\r\nreturn ret;\r\ntemp = temp / 500;\r\nif (temp > 255)\r\ntemp = 255;\r\namb_write_byte(data, amb_reg_temp_min(attr->index), temp);\r\nreturn count;\r\n}\r\nstatic ssize_t store_amb_mid(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nunsigned long temp;\r\nint ret = kstrtoul(buf, 10, &temp);\r\nif (ret < 0)\r\nreturn ret;\r\ntemp = temp / 500;\r\nif (temp > 255)\r\ntemp = 255;\r\namb_write_byte(data, amb_reg_temp_mid(attr->index), temp);\r\nreturn count;\r\n}\r\nstatic ssize_t store_amb_max(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nunsigned long temp;\r\nint ret = kstrtoul(buf, 10, &temp);\r\nif (ret < 0)\r\nreturn ret;\r\ntemp = temp / 500;\r\nif (temp > 255)\r\ntemp = 255;\r\namb_write_byte(data, amb_reg_temp_max(attr->index), temp);\r\nreturn count;\r\n}\r\nstatic ssize_t show_amb_min(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n",\r\n500 * amb_read_byte(data, amb_reg_temp_min(attr->index)));\r\n}\r\nstatic ssize_t show_amb_mid(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n",\r\n500 * amb_read_byte(data, amb_reg_temp_mid(attr->index)));\r\n}\r\nstatic ssize_t show_amb_max(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n",\r\n500 * amb_read_byte(data, amb_reg_temp_max(attr->index)));\r\n}\r\nstatic ssize_t show_amb_temp(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i5k_amb_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n",\r\n500 * amb_read_byte(data, amb_reg_temp(attr->index)));\r\n}\r\nstatic ssize_t show_label(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nreturn sprintf(buf, "Ch. %d DIMM %d\n", attr->index >> CHANNEL_SHIFT,\r\nattr->index & DIMM_MASK);\r\n}\r\nstatic int i5k_amb_hwmon_init(struct platform_device *pdev)\r\n{\r\nint i, j, k, d = 0;\r\nu16 c;\r\nint res = 0;\r\nint num_ambs = 0;\r\nstruct i5k_amb_data *data = platform_get_drvdata(pdev);\r\nfor (i = 0; i < MAX_MEM_CHANNELS; i++)\r\nnum_ambs += hweight16(data->amb_present[i] & 0x7fff);\r\ndata->attrs = kzalloc(sizeof(*data->attrs) * num_ambs * KNOBS_PER_AMB,\r\nGFP_KERNEL);\r\nif (!data->attrs)\r\nreturn -ENOMEM;\r\ndata->num_attrs = 0;\r\nfor (i = 0; i < MAX_MEM_CHANNELS; i++) {\r\nc = data->amb_present[i];\r\nfor (j = 0; j < REAL_MAX_AMBS_PER_CHANNEL; j++, c >>= 1) {\r\nstruct i5k_device_attribute *iattr;\r\nk = amb_num_from_reg(i, j);\r\nif (!(c & 0x1))\r\ncontinue;\r\nd++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_label", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_label;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_input", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_amb_temp;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_min", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IWUSR | S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_amb_min;\r\niattr->s_attr.dev_attr.store = store_amb_min;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_mid", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IWUSR | S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_amb_mid;\r\niattr->s_attr.dev_attr.store = store_amb_mid;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_max", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IWUSR | S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_amb_max;\r\niattr->s_attr.dev_attr.store = store_amb_max;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\niattr = data->attrs + data->num_attrs;\r\nsnprintf(iattr->name, AMB_SYSFS_NAME_LEN,\r\n"temp%d_alarm", d);\r\niattr->s_attr.dev_attr.attr.name = iattr->name;\r\niattr->s_attr.dev_attr.attr.mode = S_IRUGO;\r\niattr->s_attr.dev_attr.show = show_amb_alarm;\r\niattr->s_attr.index = k;\r\nsysfs_attr_init(&iattr->s_attr.dev_attr.attr);\r\nres = device_create_file(&pdev->dev,\r\n&iattr->s_attr.dev_attr);\r\nif (res)\r\ngoto exit_remove;\r\ndata->num_attrs++;\r\n}\r\n}\r\nres = device_create_file(&pdev->dev, &dev_attr_name);\r\nif (res)\r\ngoto exit_remove;\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nres = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn res;\r\nexit_remove:\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\nfor (i = 0; i < data->num_attrs; i++)\r\ndevice_remove_file(&pdev->dev, &data->attrs[i].s_attr.dev_attr);\r\nkfree(data->attrs);\r\nreturn res;\r\n}\r\nstatic int i5k_amb_add(void)\r\n{\r\nint res = -ENODEV;\r\namb_pdev = platform_device_alloc(DRVNAME, 0);\r\nif (!amb_pdev)\r\nreturn -ENOMEM;\r\nres = platform_device_add(amb_pdev);\r\nif (res)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nplatform_device_put(amb_pdev);\r\nreturn res;\r\n}\r\nstatic int i5k_find_amb_registers(struct i5k_amb_data *data,\r\nunsigned long devid)\r\n{\r\nstruct pci_dev *pcidev;\r\nu32 val32;\r\nint res = -ENODEV;\r\npcidev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\ndevid,\r\nNULL);\r\nif (!pcidev)\r\nreturn -ENODEV;\r\nif (pci_read_config_dword(pcidev, I5K_REG_AMB_BASE_ADDR, &val32))\r\ngoto out;\r\ndata->amb_base = val32;\r\nif (pci_read_config_dword(pcidev, I5K_REG_AMB_LEN_ADDR, &val32))\r\ngoto out;\r\ndata->amb_len = val32;\r\nif (data->amb_len < AMB_CONFIG_SIZE * MAX_AMBS) {\r\ndev_err(&pcidev->dev, "AMB region too small!\n");\r\ngoto out;\r\n}\r\nres = 0;\r\nout:\r\npci_dev_put(pcidev);\r\nreturn res;\r\n}\r\nstatic int i5k_channel_probe(u16 *amb_present, unsigned long dev_id)\r\n{\r\nstruct pci_dev *pcidev;\r\nu16 val16;\r\nint res = -ENODEV;\r\npcidev = pci_get_device(PCI_VENDOR_ID_INTEL, dev_id, NULL);\r\nif (!pcidev)\r\nreturn -ENODEV;\r\nif (pci_read_config_word(pcidev, I5K_REG_CHAN0_PRESENCE_ADDR, &val16))\r\ngoto out;\r\namb_present[0] = val16;\r\nif (pci_read_config_word(pcidev, I5K_REG_CHAN1_PRESENCE_ADDR, &val16))\r\ngoto out;\r\namb_present[1] = val16;\r\nres = 0;\r\nout:\r\npci_dev_put(pcidev);\r\nreturn res;\r\n}\r\nstatic int i5k_amb_probe(struct platform_device *pdev)\r\n{\r\nstruct i5k_amb_data *data;\r\nstruct resource *reso;\r\nint i, res;\r\ndata = kzalloc(sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni = 0;\r\ndo {\r\nres = i5k_find_amb_registers(data, chipset_ids[i].err);\r\nif (res == 0)\r\nbreak;\r\ni++;\r\n} while (chipset_ids[i].err);\r\nif (res)\r\ngoto err;\r\nres = i5k_channel_probe(&data->amb_present[0], chipset_ids[i].fbd0);\r\nif (res)\r\ngoto err;\r\ni5k_channel_probe(&data->amb_present[2], chipset_ids[i].fbd0 + 1);\r\nreso = request_mem_region(data->amb_base, data->amb_len, DRVNAME);\r\nif (!reso) {\r\nres = -EBUSY;\r\ngoto err;\r\n}\r\ndata->amb_mmio = ioremap_nocache(data->amb_base, data->amb_len);\r\nif (!data->amb_mmio) {\r\nres = -EBUSY;\r\ngoto err_map_failed;\r\n}\r\nplatform_set_drvdata(pdev, data);\r\nres = i5k_amb_hwmon_init(pdev);\r\nif (res)\r\ngoto err_init_failed;\r\nreturn res;\r\nerr_init_failed:\r\niounmap(data->amb_mmio);\r\nerr_map_failed:\r\nrelease_mem_region(data->amb_base, data->amb_len);\r\nerr:\r\nkfree(data);\r\nreturn res;\r\n}\r\nstatic int i5k_amb_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nstruct i5k_amb_data *data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\nfor (i = 0; i < data->num_attrs; i++)\r\ndevice_remove_file(&pdev->dev, &data->attrs[i].s_attr.dev_attr);\r\nkfree(data->attrs);\r\niounmap(data->amb_mmio);\r\nrelease_mem_region(data->amb_base, data->amb_len);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __init i5k_amb_init(void)\r\n{\r\nint res;\r\nres = platform_driver_register(&i5k_amb_driver);\r\nif (res)\r\nreturn res;\r\nres = i5k_amb_add();\r\nif (res)\r\nplatform_driver_unregister(&i5k_amb_driver);\r\nreturn res;\r\n}\r\nstatic void __exit i5k_amb_exit(void)\r\n{\r\nplatform_device_unregister(amb_pdev);\r\nplatform_driver_unregister(&i5k_amb_driver);\r\n}

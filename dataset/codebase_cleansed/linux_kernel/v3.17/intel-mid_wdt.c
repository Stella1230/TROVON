static inline int wdt_command(int sub, u32 *in, int inlen)\r\n{\r\nreturn intel_scu_ipc_command(IPC_WATCHDOG, sub, in, inlen, NULL, 0);\r\n}\r\nstatic int wdt_start(struct watchdog_device *wd)\r\n{\r\nint ret, in_size;\r\nint timeout = wd->timeout;\r\nstruct ipc_wd_start {\r\nu32 pretimeout;\r\nu32 timeout;\r\n} ipc_wd_start = { timeout - MID_WDT_PRETIMEOUT, timeout };\r\nin_size = DIV_ROUND_UP(sizeof(ipc_wd_start), 4);\r\nret = wdt_command(SCU_WATCHDOG_START, (u32 *)&ipc_wd_start, in_size);\r\nif (ret) {\r\nstruct device *dev = watchdog_get_drvdata(wd);\r\ndev_crit(dev, "error starting watchdog: %d\n", ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic int wdt_ping(struct watchdog_device *wd)\r\n{\r\nint ret;\r\nret = wdt_command(SCU_WATCHDOG_KEEPALIVE, NULL, 0);\r\nif (ret) {\r\nstruct device *dev = watchdog_get_drvdata(wd);\r\ndev_crit(dev, "Error executing keepalive: 0x%x\n", ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic int wdt_stop(struct watchdog_device *wd)\r\n{\r\nint ret;\r\nret = wdt_command(SCU_WATCHDOG_STOP, NULL, 0);\r\nif (ret) {\r\nstruct device *dev = watchdog_get_drvdata(wd);\r\ndev_crit(dev, "Error stopping watchdog: 0x%x\n", ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t mid_wdt_irq(int irq, void *dev_id)\r\n{\r\npanic("Kernel Watchdog");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mid_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdt_dev;\r\nstruct intel_mid_wdt_pdata *pdata = pdev->dev.platform_data;\r\nint ret;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "missing platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->probe) {\r\nret = pdata->probe(pdev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nwdt_dev = devm_kzalloc(&pdev->dev, sizeof(*wdt_dev), GFP_KERNEL);\r\nif (!wdt_dev)\r\nreturn -ENOMEM;\r\nwdt_dev->info = &mid_wdt_info;\r\nwdt_dev->ops = &mid_wdt_ops;\r\nwdt_dev->min_timeout = MID_WDT_TIMEOUT_MIN;\r\nwdt_dev->max_timeout = MID_WDT_TIMEOUT_MAX;\r\nwdt_dev->timeout = MID_WDT_DEFAULT_TIMEOUT;\r\nwatchdog_set_drvdata(wdt_dev, &pdev->dev);\r\nplatform_set_drvdata(pdev, wdt_dev);\r\nret = devm_request_irq(&pdev->dev, pdata->irq, mid_wdt_irq,\r\nIRQF_SHARED | IRQF_NO_SUSPEND, "watchdog",\r\nwdt_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "error requesting warning irq %d\n",\r\npdata->irq);\r\nreturn ret;\r\n}\r\nret = watchdog_register_device(wdt_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "error registering watchdog device\n");\r\nreturn ret;\r\n}\r\ndev_info(&pdev->dev, "Intel MID watchdog device probed\n");\r\nreturn 0;\r\n}\r\nstatic int mid_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wd = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(wd);\r\nreturn 0;\r\n}

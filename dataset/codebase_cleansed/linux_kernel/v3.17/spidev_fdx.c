static void do_read(int fd, int len)\r\n{\r\nunsigned char buf[32], *bp;\r\nint status;\r\nif (len < 2)\r\nlen = 2;\r\nelse if (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nmemset(buf, 0, sizeof buf);\r\nstatus = read(fd, buf, len);\r\nif (status < 0) {\r\nperror("read");\r\nreturn;\r\n}\r\nif (status != len) {\r\nfprintf(stderr, "short read\n");\r\nreturn;\r\n}\r\nprintf("read(%2d, %2d): %02x %02x,", len, status,\r\nbuf[0], buf[1]);\r\nstatus -= 2;\r\nbp = buf + 2;\r\nwhile (status-- > 0)\r\nprintf(" %02x", *bp++);\r\nprintf("\n");\r\n}\r\nstatic void do_msg(int fd, int len)\r\n{\r\nstruct spi_ioc_transfer xfer[2];\r\nunsigned char buf[32], *bp;\r\nint status;\r\nmemset(xfer, 0, sizeof xfer);\r\nmemset(buf, 0, sizeof buf);\r\nif (len > sizeof buf)\r\nlen = sizeof buf;\r\nbuf[0] = 0xaa;\r\nxfer[0].tx_buf = (unsigned long)buf;\r\nxfer[0].len = 1;\r\nxfer[1].rx_buf = (unsigned long) buf;\r\nxfer[1].len = len;\r\nstatus = ioctl(fd, SPI_IOC_MESSAGE(2), xfer);\r\nif (status < 0) {\r\nperror("SPI_IOC_MESSAGE");\r\nreturn;\r\n}\r\nprintf("response(%2d, %2d): ", len, status);\r\nfor (bp = buf; len; len--)\r\nprintf(" %02x", *bp++);\r\nprintf("\n");\r\n}\r\nstatic void dumpstat(const char *name, int fd)\r\n{\r\n__u8 lsb, bits;\r\n__u32 mode, speed;\r\nif (ioctl(fd, SPI_IOC_RD_MODE32, &mode) < 0) {\r\nperror("SPI rd_mode");\r\nreturn;\r\n}\r\nif (ioctl(fd, SPI_IOC_RD_LSB_FIRST, &lsb) < 0) {\r\nperror("SPI rd_lsb_fist");\r\nreturn;\r\n}\r\nif (ioctl(fd, SPI_IOC_RD_BITS_PER_WORD, &bits) < 0) {\r\nperror("SPI bits_per_word");\r\nreturn;\r\n}\r\nif (ioctl(fd, SPI_IOC_RD_MAX_SPEED_HZ, &speed) < 0) {\r\nperror("SPI max_speed_hz");\r\nreturn;\r\n}\r\nprintf("%s: spi mode 0x%x, %d bits %sper word, %d Hz max\n",\r\nname, mode, bits, lsb ? "(lsb first) " : "", speed);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint c;\r\nint readcount = 0;\r\nint msglen = 0;\r\nint fd;\r\nconst char *name;\r\nwhile ((c = getopt(argc, argv, "hm:r:v")) != EOF) {\r\nswitch (c) {\r\ncase 'm':\r\nmsglen = atoi(optarg);\r\nif (msglen < 0)\r\ngoto usage;\r\ncontinue;\r\ncase 'r':\r\nreadcount = atoi(optarg);\r\nif (readcount < 0)\r\ngoto usage;\r\ncontinue;\r\ncase 'v':\r\nverbose++;\r\ncontinue;\r\ncase 'h':\r\ncase '?':\r\nusage:\r\nfprintf(stderr,\r\n"usage: %s [-h] [-m N] [-r N] /dev/spidevB.D\n",\r\nargv[0]);\r\nreturn 1;\r\n}\r\n}\r\nif ((optind + 1) != argc)\r\ngoto usage;\r\nname = argv[optind];\r\nfd = open(name, O_RDWR);\r\nif (fd < 0) {\r\nperror("open");\r\nreturn 1;\r\n}\r\ndumpstat(name, fd);\r\nif (msglen)\r\ndo_msg(fd, msglen);\r\nif (readcount)\r\ndo_read(fd, readcount);\r\nclose(fd);\r\nreturn 0;\r\n}

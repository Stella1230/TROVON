unsigned long hv_perf_caps_get(struct hv_perf_caps *caps)\r\n{\r\nunsigned long r;\r\nstruct p {\r\nstruct hv_get_perf_counter_info_params params;\r\nstruct cv_system_performance_capabilities caps;\r\n} __packed __aligned(sizeof(uint64_t));\r\nstruct p arg = {\r\n.params = {\r\n.counter_request = cpu_to_be32(\r\nCIR_SYSTEM_PERFORMANCE_CAPABILITIES),\r\n.starting_index = cpu_to_be32(-1),\r\n.counter_info_version_in = 0,\r\n}\r\n};\r\nr = plpar_hcall_norets(H_GET_PERF_COUNTER_INFO,\r\nvirt_to_phys(&arg), sizeof(arg));\r\nif (r)\r\nreturn r;\r\npr_devel("capability_mask: 0x%x\n", arg.caps.capability_mask);\r\ncaps->version = arg.params.counter_info_version_out;\r\ncaps->collect_privileged = !!arg.caps.perf_collect_privileged;\r\ncaps->ga = !!(arg.caps.capability_mask & CV_CM_GA);\r\ncaps->expanded = !!(arg.caps.capability_mask & CV_CM_EXPANDED);\r\ncaps->lab = !!(arg.caps.capability_mask & CV_CM_LAB);\r\nreturn r;\r\n}

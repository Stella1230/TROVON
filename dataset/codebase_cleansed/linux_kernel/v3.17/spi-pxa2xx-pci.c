static int pxa2xx_spi_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct platform_device_info pi;\r\nint ret;\r\nstruct platform_device *pdev;\r\nstruct pxa2xx_spi_master spi_pdata;\r\nstruct ssp_device *ssp;\r\nstruct pxa_spi_info *c;\r\nret = pcim_enable_device(dev);\r\nif (ret)\r\nreturn ret;\r\nret = pcim_iomap_regions(dev, 1 << 0, "PXA2xx SPI");\r\nif (ret)\r\nreturn ret;\r\nc = &spi_info_configs[ent->driver_data];\r\nmemset(&spi_pdata, 0, sizeof(spi_pdata));\r\nspi_pdata.num_chipselect = (c->num_chipselect > 0) ?\r\nc->num_chipselect : dev->devfn;\r\nspi_pdata.tx_slave_id = c->tx_slave_id;\r\nspi_pdata.tx_chan_id = c->tx_chan_id;\r\nspi_pdata.rx_slave_id = c->rx_slave_id;\r\nspi_pdata.rx_chan_id = c->rx_chan_id;\r\nspi_pdata.enable_dma = c->rx_slave_id >= 0 && c->tx_slave_id >= 0;\r\nssp = &spi_pdata.ssp;\r\nssp->phys_base = pci_resource_start(dev, 0);\r\nssp->mmio_base = pcim_iomap_table(dev)[0];\r\nif (!ssp->mmio_base) {\r\ndev_err(&dev->dev, "failed to ioremap() registers\n");\r\nreturn -EIO;\r\n}\r\nssp->irq = dev->irq;\r\nssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;\r\nssp->type = c->type;\r\nmemset(&pi, 0, sizeof(pi));\r\npi.parent = &dev->dev;\r\npi.name = "pxa2xx-spi";\r\npi.id = ssp->port_id;\r\npi.data = &spi_pdata;\r\npi.size_data = sizeof(spi_pdata);\r\npdev = platform_device_register_full(&pi);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\npci_set_drvdata(dev, pdev);\r\nreturn 0;\r\n}\r\nstatic void pxa2xx_spi_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct platform_device *pdev = pci_get_drvdata(dev);\r\nplatform_device_unregister(pdev);\r\n}

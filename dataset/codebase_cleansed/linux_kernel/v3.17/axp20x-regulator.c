static int axp20x_set_dcdc_freq(struct platform_device *pdev, u32 dcdcfreq)\r\n{\r\nstruct axp20x_dev *axp20x = dev_get_drvdata(pdev->dev.parent);\r\nif (dcdcfreq < 750) {\r\ndcdcfreq = 750;\r\ndev_warn(&pdev->dev, "DCDC frequency too low. Set to 750kHz\n");\r\n}\r\nif (dcdcfreq > 1875) {\r\ndcdcfreq = 1875;\r\ndev_warn(&pdev->dev, "DCDC frequency too high. Set to 1875kHz\n");\r\n}\r\ndcdcfreq = (dcdcfreq - 750) / 75;\r\nreturn regmap_update_bits(axp20x->regmap, AXP20X_DCDC_FREQ,\r\nAXP20X_FREQ_DCDC_MASK, dcdcfreq);\r\n}\r\nstatic int axp20x_regulator_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct device_node *np, *regulators;\r\nint ret;\r\nu32 dcdcfreq;\r\nnp = of_node_get(pdev->dev.parent->of_node);\r\nif (!np)\r\nreturn 0;\r\nregulators = of_get_child_by_name(np, "regulators");\r\nif (!regulators) {\r\ndev_warn(&pdev->dev, "regulators node not found\n");\r\n} else {\r\nret = of_regulator_match(&pdev->dev, regulators, axp20x_matches,\r\nARRAY_SIZE(axp20x_matches));\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Error parsing regulator init data: %d\n", ret);\r\nreturn ret;\r\n}\r\ndcdcfreq = 1500;\r\nof_property_read_u32(regulators, "x-powers,dcdc-freq", &dcdcfreq);\r\nret = axp20x_set_dcdc_freq(pdev, dcdcfreq);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Error setting dcdc frequency: %d\n", ret);\r\nreturn ret;\r\n}\r\nof_node_put(regulators);\r\n}\r\nreturn 0;\r\n}\r\nstatic int axp20x_set_dcdc_workmode(struct regulator_dev *rdev, int id, u32 workmode)\r\n{\r\nunsigned int mask = AXP20X_WORKMODE_DCDC2_MASK;\r\nif ((id != AXP20X_DCDC2) && (id != AXP20X_DCDC3))\r\nreturn -EINVAL;\r\nif (id == AXP20X_DCDC3)\r\nmask = AXP20X_WORKMODE_DCDC3_MASK;\r\nworkmode <<= ffs(mask) - 1;\r\nreturn regmap_update_bits(rdev->regmap, AXP20X_DCDC_MODE, mask, workmode);\r\n}\r\nstatic int axp20x_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev;\r\nstruct axp20x_dev *axp20x = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_config config = { };\r\nstruct regulator_init_data *init_data;\r\nint ret, i;\r\nu32 workmode;\r\nret = axp20x_regulator_parse_dt(pdev);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < AXP20X_REG_ID_MAX; i++) {\r\ninit_data = axp20x_matches[i].init_data;\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = init_data;\r\nconfig.regmap = axp20x->regmap;\r\nconfig.of_node = axp20x_matches[i].of_node;\r\nrdev = devm_regulator_register(&pdev->dev, &axp20x_regulators[i],\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "Failed to register %s\n",\r\naxp20x_regulators[i].name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nret = of_property_read_u32(axp20x_matches[i].of_node, "x-powers,dcdc-workmode",\r\n&workmode);\r\nif (!ret) {\r\nif (axp20x_set_dcdc_workmode(rdev, i, workmode))\r\ndev_err(&pdev->dev, "Failed to set workmode on %s\n",\r\naxp20x_regulators[i].name);\r\n}\r\n}\r\nreturn 0;\r\n}

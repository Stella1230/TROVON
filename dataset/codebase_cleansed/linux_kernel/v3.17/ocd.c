void ocd_enable(struct task_struct *child)\r\n{\r\nu32 dc;\r\nif (child)\r\npr_debug("ocd_enable: child=%s [%u]\n",\r\nchild->comm, child->pid);\r\nelse\r\npr_debug("ocd_enable (no child)\n");\r\nif (!child || !test_and_set_tsk_thread_flag(child, TIF_DEBUG)) {\r\nspin_lock(&ocd_lock);\r\nocd_count++;\r\ndc = ocd_read(DC);\r\ndc |= (1 << OCD_DC_MM_BIT) | (1 << OCD_DC_DBE_BIT);\r\nocd_write(DC, dc);\r\nspin_unlock(&ocd_lock);\r\n}\r\n}\r\nvoid ocd_disable(struct task_struct *child)\r\n{\r\nu32 dc;\r\nif (!child)\r\npr_debug("ocd_disable (no child)\n");\r\nelse if (test_tsk_thread_flag(child, TIF_DEBUG))\r\npr_debug("ocd_disable: child=%s [%u]\n",\r\nchild->comm, child->pid);\r\nif (!child || test_and_clear_tsk_thread_flag(child, TIF_DEBUG)) {\r\nspin_lock(&ocd_lock);\r\nocd_count--;\r\nWARN_ON(ocd_count < 0);\r\nif (ocd_count <= 0) {\r\ndc = ocd_read(DC);\r\ndc &= ~((1 << OCD_DC_MM_BIT) | (1 << OCD_DC_DBE_BIT));\r\nocd_write(DC, dc);\r\n}\r\nspin_unlock(&ocd_lock);\r\n}\r\n}\r\nstatic int ocd_DC_get(void *data, u64 *val)\r\n{\r\n*val = ocd_read(DC);\r\nreturn 0;\r\n}\r\nstatic int ocd_DC_set(void *data, u64 val)\r\n{\r\nocd_write(DC, val);\r\nreturn 0;\r\n}\r\nstatic int ocd_DS_get(void *data, u64 *val)\r\n{\r\n*val = ocd_read(DS);\r\nreturn 0;\r\n}\r\nstatic int ocd_count_get(void *data, u64 *val)\r\n{\r\n*val = ocd_count;\r\nreturn 0;\r\n}\r\nstatic void ocd_debugfs_init(void)\r\n{\r\nstruct dentry *root;\r\nroot = debugfs_create_dir("ocd", NULL);\r\nif (IS_ERR(root) || !root)\r\ngoto err_root;\r\nocd_debugfs_root = root;\r\nocd_debugfs_DC = debugfs_create_file("DC", S_IRUSR | S_IWUSR,\r\nroot, NULL, &fops_DC);\r\nif (!ocd_debugfs_DC)\r\ngoto err_DC;\r\nocd_debugfs_DS = debugfs_create_file("DS", S_IRUSR, root,\r\nNULL, &fops_DS);\r\nif (!ocd_debugfs_DS)\r\ngoto err_DS;\r\nocd_debugfs_count = debugfs_create_file("count", S_IRUSR, root,\r\nNULL, &fops_count);\r\nif (!ocd_debugfs_count)\r\ngoto err_count;\r\nreturn;\r\nerr_count:\r\ndebugfs_remove(ocd_debugfs_DS);\r\nerr_DS:\r\ndebugfs_remove(ocd_debugfs_DC);\r\nerr_DC:\r\ndebugfs_remove(ocd_debugfs_root);\r\nerr_root:\r\nprintk(KERN_WARNING "OCD: Failed to create debugfs entries\n");\r\n}\r\nstatic inline void ocd_debugfs_init(void)\r\n{\r\n}\r\nstatic int __init ocd_init(void)\r\n{\r\nspin_lock_init(&ocd_lock);\r\nocd_debugfs_init();\r\nreturn 0;\r\n}

static int verb_write_ioctl(struct hda_codec *codec,\r\nstruct hda_verb_ioctl __user *arg)\r\n{\r\nu32 verb, res;\r\nif (get_user(verb, &arg->verb))\r\nreturn -EFAULT;\r\nres = snd_hda_codec_read(codec, verb >> 24, 0,\r\n(verb >> 8) & 0xffff, verb & 0xff);\r\nif (put_user(res, &arg->res))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int get_wcap_ioctl(struct hda_codec *codec,\r\nstruct hda_verb_ioctl __user *arg)\r\n{\r\nu32 verb, res;\r\nif (get_user(verb, &arg->verb))\r\nreturn -EFAULT;\r\nres = get_wcaps(codec, verb >> 24);\r\nif (put_user(res, &arg->res))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int hda_hwdep_ioctl(struct snd_hwdep *hw, struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct hda_codec *codec = hw->private_data;\r\nvoid __user *argp = (void __user *)arg;\r\nswitch (cmd) {\r\ncase HDA_IOCTL_PVERSION:\r\nreturn put_user(HDA_HWDEP_VERSION, (int __user *)argp);\r\ncase HDA_IOCTL_VERB_WRITE:\r\nreturn verb_write_ioctl(codec, argp);\r\ncase HDA_IOCTL_GET_WCAP:\r\nreturn get_wcap_ioctl(codec, argp);\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}\r\nstatic int hda_hwdep_ioctl_compat(struct snd_hwdep *hw, struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nreturn hda_hwdep_ioctl(hw, file, cmd, (unsigned long)compat_ptr(arg));\r\n}\r\nstatic int hda_hwdep_open(struct snd_hwdep *hw, struct file *file)\r\n{\r\n#ifndef CONFIG_SND_DEBUG_VERBOSE\r\nif (!capable(CAP_SYS_RAWIO))\r\nreturn -EACCES;\r\n#endif\r\nreturn 0;\r\n}\r\nint snd_hda_create_hwdep(struct hda_codec *codec)\r\n{\r\nchar hwname[16];\r\nstruct snd_hwdep *hwdep;\r\nint err;\r\nsprintf(hwname, "HDA Codec %d", codec->addr);\r\nerr = snd_hwdep_new(codec->bus->card, hwname, codec->addr, &hwdep);\r\nif (err < 0)\r\nreturn err;\r\ncodec->hwdep = hwdep;\r\nsprintf(hwdep->name, "HDA Codec %d", codec->addr);\r\nhwdep->iface = SNDRV_HWDEP_IFACE_HDA;\r\nhwdep->private_data = codec;\r\nhwdep->exclusive = 1;\r\nhwdep->groups = snd_hda_dev_attr_groups;\r\nhwdep->ops.open = hda_hwdep_open;\r\nhwdep->ops.ioctl = hda_hwdep_ioctl;\r\n#ifdef CONFIG_COMPAT\r\nhwdep->ops.ioctl_compat = hda_hwdep_ioctl_compat;\r\n#endif\r\nhwdep->dev = &codec->dev;\r\nreturn 0;\r\n}

int __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint virq;\r\nvirq = irq_tab[slot][pin];\r\nreturn pci_irq[virq];\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void malta_piix_func3_base_fixup(struct pci_dev *dev)\r\n{\r\npci_write_config_word(dev, PIIX4_FUNC3_PMBA, 0x1000);\r\npci_write_config_byte(dev, PIIX4_FUNC3_PMREGMISC,\r\nPIIX4_FUNC3_PMREGMISC_EN);\r\n}\r\nstatic void malta_piix_func0_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned char reg_val;\r\nu32 reg_val32;\r\nu16 reg_val16;\r\nstatic int piixirqmap[PIIX4_FUNC0_PIRQRC_IRQ_ROUTING_MAX] = {\r\n0, 0, 0, 3,\r\n4, 5, 6, 7,\r\n0, 9, 10, 11,\r\n12, 0, 14, 15\r\n};\r\nint i;\r\nfor (i = 0; i <= 3; i++) {\r\npci_read_config_byte(pdev, PIIX4_FUNC0_PIRQRC+i, &reg_val);\r\nif (reg_val & PIIX4_FUNC0_PIRQRC_IRQ_ROUTING_DISABLE)\r\npci_irq[PCIA+i] = 0;\r\nelse\r\npci_irq[PCIA+i] = piixirqmap[reg_val &\r\nPIIX4_FUNC0_PIRQRC_IRQ_ROUTING_MASK];\r\n}\r\nif (PCI_SLOT(pdev->devfn) == 10) {\r\npci_read_config_byte(pdev, PIIX4_FUNC0_TOM, &reg_val);\r\npci_write_config_byte(pdev, PIIX4_FUNC0_TOM, reg_val |\r\nPIIX4_FUNC0_TOM_TOP_OF_MEMORY_MASK);\r\n}\r\npci_read_config_dword(pdev, PIIX4_FUNC0_GENCFG, &reg_val32);\r\npci_write_config_dword(pdev, PIIX4_FUNC0_GENCFG,\r\nreg_val32 | PIIX4_FUNC0_GENCFG_SERIRQ);\r\npci_read_config_byte(pdev, PIIX4_FUNC0_SERIRQC, &reg_val);\r\nreg_val |= PIIX4_FUNC0_SERIRQC_EN | PIIX4_FUNC0_SERIRQC_CONT;\r\npci_write_config_byte(pdev, PIIX4_FUNC0_SERIRQC, reg_val);\r\npci_read_config_word(pdev, PCI_COMMAND, &reg_val16);\r\npci_write_config_word(pdev, PCI_COMMAND,\r\nreg_val16 | PCI_COMMAND_SPECIAL);\r\n}\r\nstatic void malta_piix_func1_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned char reg_val;\r\nif (PCI_SLOT(pdev->devfn) == 10) {\r\npci_read_config_byte(pdev, PIIX4_FUNC1_IDETIM_PRIMARY_HI,\r\n&reg_val);\r\npci_write_config_byte(pdev, PIIX4_FUNC1_IDETIM_PRIMARY_HI,\r\nreg_val|PIIX4_FUNC1_IDETIM_PRIMARY_HI_IDE_DECODE_EN);\r\npci_read_config_byte(pdev, PIIX4_FUNC1_IDETIM_SECONDARY_HI,\r\n&reg_val);\r\npci_write_config_byte(pdev, PIIX4_FUNC1_IDETIM_SECONDARY_HI,\r\nreg_val|PIIX4_FUNC1_IDETIM_SECONDARY_HI_IDE_DECODE_EN);\r\n}\r\n}\r\nstatic void quirk_dlcsetup(struct pci_dev *dev)\r\n{\r\nu8 odlc, ndlc;\r\n(void) pci_read_config_byte(dev, PIIX4_FUNC0_DLC, &odlc);\r\nndlc = odlc | PIIX4_FUNC0_DLC_USBPR_EN |\r\nPIIX4_FUNC0_DLC_PASSIVE_RELEASE_EN |\r\nPIIX4_FUNC0_DLC_DELAYED_TRANSACTION_EN;\r\n(void) pci_write_config_byte(dev, PIIX4_FUNC0_DLC, ndlc);\r\n}

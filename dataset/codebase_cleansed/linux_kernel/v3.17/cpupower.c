static void print_help(void)\r\n{\r\nunsigned int i;\r\n#ifdef DEBUG\r\nprintf(_("Usage:\tcpupower [-d|--debug] [-c|--cpu cpulist ] <command> [<args>]\n"));\r\n#else\r\nprintf(_("Usage:\tcpupower [-c|--cpu cpulist ] <command> [<args>]\n"));\r\n#endif\r\nprintf(_("Supported commands are:\n"));\r\nfor (i = 0; i < ARRAY_SIZE(commands); i++)\r\nprintf("\t%s\n", commands[i].cmd);\r\nprintf(_("\nNot all commands can make use of the -c cpulist option.\n"));\r\nprintf(_("\nUse 'cpupower help <command>' for getting help for above commands.\n"));\r\n}\r\nstatic int print_man_page(const char *subpage)\r\n{\r\nint len;\r\nchar *page;\r\nlen = 10;\r\nif (subpage != NULL)\r\nlen += strlen(subpage);\r\npage = malloc(len);\r\nif (!page)\r\nreturn -ENOMEM;\r\nsprintf(page, "cpupower");\r\nif ((subpage != NULL) && strcmp(subpage, "help")) {\r\nstrcat(page, "-");\r\nstrcat(page, subpage);\r\n}\r\nexeclp("man", "man", page, NULL);\r\nreturn -EINVAL;\r\n}\r\nstatic int cmd_help(int argc, const char **argv)\r\n{\r\nif (argc > 1) {\r\nprint_man_page(argv[1]);\r\nreturn EXIT_FAILURE;\r\n}\r\nprint_help();\r\nreturn EXIT_SUCCESS;\r\n}\r\nstatic void print_version(void)\r\n{\r\nprintf(PACKAGE " " VERSION "\n");\r\nprintf(_("Report errors and bugs to %s, please.\n"), PACKAGE_BUGREPORT);\r\n}\r\nstatic void handle_options(int *argc, const char ***argv)\r\n{\r\nint ret, x, new_argc = 0;\r\nif (*argc < 1)\r\nreturn;\r\nfor (x = 0; x < *argc && ((*argv)[x])[0] == '-'; x++) {\r\nconst char *param = (*argv)[x];\r\nif (!strcmp(param, "-h") || !strcmp(param, "--help")) {\r\nprint_help();\r\nexit(EXIT_SUCCESS);\r\n} else if (!strcmp(param, "-c") || !strcmp(param, "--cpu")) {\r\nif (*argc < 2) {\r\nprint_help();\r\nexit(EXIT_FAILURE);\r\n}\r\nif (!strcmp((*argv)[x+1], "all"))\r\nbitmask_setall(cpus_chosen);\r\nelse {\r\nret = bitmask_parselist(\r\n(*argv)[x+1], cpus_chosen);\r\nif (ret < 0) {\r\nfprintf(stderr, _("Error parsing cpu "\r\n"list\n"));\r\nexit(EXIT_FAILURE);\r\n}\r\n}\r\nx += 1;\r\nnew_argc += 2;\r\ncontinue;\r\n} else if (!strcmp(param, "-v") ||\r\n!strcmp(param, "--version")) {\r\nprint_version();\r\nexit(EXIT_SUCCESS);\r\n#ifdef DEBUG\r\n} else if (!strcmp(param, "-d") || !strcmp(param, "--debug")) {\r\nbe_verbose = 1;\r\nnew_argc++;\r\ncontinue;\r\n#endif\r\n} else {\r\nfprintf(stderr, "Unknown option: %s\n", param);\r\nprint_help();\r\nexit(EXIT_FAILURE);\r\n}\r\n}\r\n*argc -= new_argc;\r\n*argv += new_argc;\r\n}\r\nint main(int argc, const char *argv[])\r\n{\r\nconst char *cmd;\r\nunsigned int i, ret;\r\nstruct stat statbuf;\r\nstruct utsname uts;\r\ncpus_chosen = bitmask_alloc(sysconf(_SC_NPROCESSORS_CONF));\r\nargc--;\r\nargv += 1;\r\nhandle_options(&argc, &argv);\r\ncmd = argv[0];\r\nif (argc < 1) {\r\nprint_help();\r\nreturn EXIT_FAILURE;\r\n}\r\nsetlocale(LC_ALL, "");\r\ntextdomain(PACKAGE);\r\nif (argc > 1 && !strcmp(argv[1], "--help")) {\r\nargv[1] = argv[0];\r\nargv[0] = cmd = "help";\r\n}\r\nget_cpu_info(0, &cpupower_cpu_info);\r\nrun_as_root = !getuid();\r\nif (run_as_root) {\r\nret = uname(&uts);\r\nif (!ret && !strcmp(uts.machine, "x86_64") &&\r\nstat("/dev/cpu/0/msr", &statbuf) != 0) {\r\nif (system("modprobe msr") == -1)\r\nfprintf(stderr, _("MSR access not available.\n"));\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(commands); i++) {\r\nstruct cmd_struct *p = commands + i;\r\nif (strcmp(p->cmd, cmd))\r\ncontinue;\r\nif (!run_as_root && p->needs_root) {\r\nfprintf(stderr, _("Subcommand %s needs root "\r\n"privileges\n"), cmd);\r\nreturn EXIT_FAILURE;\r\n}\r\nret = p->main(argc, argv);\r\nif (cpus_chosen)\r\nbitmask_free(cpus_chosen);\r\nreturn ret;\r\n}\r\nprint_help();\r\nreturn EXIT_FAILURE;\r\n}

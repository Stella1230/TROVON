void stdma_lock(irq_handler_t handler, void *data)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nwait_event(stdma_wait, !stdma_locked);\r\nstdma_locked = 1;\r\nstdma_isr = handler;\r\nstdma_isr_data = data;\r\nlocal_irq_restore(flags);\r\n}\r\nvoid stdma_release(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nstdma_locked = 0;\r\nstdma_isr = NULL;\r\nstdma_isr_data = NULL;\r\nwake_up(&stdma_wait);\r\nlocal_irq_restore(flags);\r\n}\r\nint stdma_others_waiting(void)\r\n{\r\nreturn waitqueue_active(&stdma_wait);\r\n}\r\nint stdma_islocked(void)\r\n{\r\nreturn stdma_locked;\r\n}\r\nvoid __init stdma_init(void)\r\n{\r\nstdma_isr = NULL;\r\nif (request_irq(IRQ_MFP_FDC, stdma_int, IRQ_TYPE_SLOW | IRQF_SHARED,\r\n"ST-DMA floppy,ACSI,IDE,Falcon-SCSI", stdma_int))\r\npr_err("Couldn't register ST-DMA interrupt\n");\r\n}\r\nstatic irqreturn_t stdma_int(int irq, void *dummy)\r\n{\r\nif (stdma_isr)\r\n(*stdma_isr)(irq, stdma_isr_data);\r\nreturn IRQ_HANDLED;\r\n}

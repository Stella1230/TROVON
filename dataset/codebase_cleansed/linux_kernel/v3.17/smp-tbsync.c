static void enter_contest(u64 mark, long add)\r\n{\r\nwhile (get_tb() < mark)\r\ntbsync->race_result = add;\r\n}\r\nvoid smp_generic_take_timebase(void)\r\n{\r\nint cmd;\r\nu64 tb;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nwhile (!running)\r\nbarrier();\r\nrmb();\r\nfor (;;) {\r\ntbsync->ack = 1;\r\nwhile (!tbsync->handshake)\r\nbarrier();\r\nrmb();\r\ncmd = tbsync->cmd;\r\ntb = tbsync->tb;\r\nmb();\r\ntbsync->ack = 0;\r\nif (cmd == kExit)\r\nbreak;\r\nwhile (tbsync->handshake)\r\nbarrier();\r\nif (cmd == kSetAndTest)\r\nset_tb(tb >> 32, tb & 0xfffffffful);\r\nenter_contest(tbsync->mark, -1);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int start_contest(int cmd, long offset, int num)\r\n{\r\nint i, score=0;\r\nu64 tb;\r\nu64 mark;\r\ntbsync->cmd = cmd;\r\nlocal_irq_disable();\r\nfor (i = -3; i < num; ) {\r\ntb = get_tb() + 400;\r\ntbsync->tb = tb + offset;\r\ntbsync->mark = mark = tb + 400;\r\nwmb();\r\ntbsync->handshake = 1;\r\nwhile (tbsync->ack)\r\nbarrier();\r\nwhile (get_tb() <= tb)\r\nbarrier();\r\ntbsync->handshake = 0;\r\nenter_contest(mark, 1);\r\nwhile (!tbsync->ack)\r\nbarrier();\r\nif (i++ > 0)\r\nscore += tbsync->race_result;\r\n}\r\nlocal_irq_enable();\r\nreturn score;\r\n}\r\nvoid smp_generic_give_timebase(void)\r\n{\r\nint i, score, score2, old, min=0, max=5000, offset=1000;\r\npr_debug("Software timebase sync\n");\r\ntbsync = kzalloc( sizeof(*tbsync), GFP_KERNEL );\r\nmb();\r\nrunning = 1;\r\nwhile (!tbsync->ack)\r\nbarrier();\r\npr_debug("Got ack\n");\r\nfor (old = -1; old != offset ; offset = (min+max) / 2) {\r\nscore = start_contest(kSetAndTest, offset, NUM_ITER);\r\npr_debug("score %d, offset %d\n", score, offset );\r\nif( score > 0 )\r\nmax = offset;\r\nelse\r\nmin = offset;\r\nold = offset;\r\n}\r\nscore = start_contest(kSetAndTest, min, NUM_ITER);\r\nscore2 = start_contest(kSetAndTest, max, NUM_ITER);\r\npr_debug("Min %d (score %d), Max %d (score %d)\n",\r\nmin, score, max, score2);\r\nscore = abs(score);\r\nscore2 = abs(score2);\r\noffset = (score < score2) ? min : max;\r\nfor (i = 0; i < 10; i++) {\r\nstart_contest(kSetAndTest, offset, NUM_ITER/10);\r\nif ((score2 = start_contest(kTest, offset, NUM_ITER)) < 0)\r\nscore2 = -score2;\r\nif (score2 <= score || score2 < 20)\r\nbreak;\r\n}\r\npr_debug("Final offset: %d (%d/%d)\n", offset, score2, NUM_ITER );\r\ntbsync->cmd = kExit;\r\nwmb();\r\ntbsync->handshake = 1;\r\nwhile (tbsync->ack)\r\nbarrier();\r\ntbsync->handshake = 0;\r\nkfree(tbsync);\r\ntbsync = NULL;\r\nrunning = 0;\r\n}

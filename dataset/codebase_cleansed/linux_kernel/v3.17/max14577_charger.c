static int max14577_get_charger_state(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nint state = POWER_SUPPLY_STATUS_DISCHARGING;\r\nu8 reg_data;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL2, &reg_data);\r\nif ((reg_data & CHGCTRL2_MBCHOSTEN_MASK) == 0)\r\ngoto state_set;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\r\nif (reg_data & STATUS3_CGMBC_MASK) {\r\nif (reg_data & STATUS3_EOC_MASK)\r\nstate = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\nstate = POWER_SUPPLY_STATUS_CHARGING;\r\ngoto state_set;\r\n}\r\nstate_set:\r\nchg->charging_state = state;\r\nreturn state;\r\n}\r\nstatic int max14577_get_charge_type(struct max14577_charger *chg)\r\n{\r\nif (max14577_get_charger_state(chg) == POWER_SUPPLY_STATUS_CHARGING)\r\nreturn POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nreturn POWER_SUPPLY_CHARGE_TYPE_NONE;\r\n}\r\nstatic int max14577_get_online(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nu8 reg_data;\r\nmax14577_read_reg(rmap, MAX14577_MUIC_REG_STATUS2, &reg_data);\r\nreg_data = ((reg_data & STATUS2_CHGTYP_MASK) >> STATUS2_CHGTYP_SHIFT);\r\nswitch (reg_data) {\r\ncase MAX14577_CHARGER_TYPE_USB:\r\ncase MAX14577_CHARGER_TYPE_DEDICATED_CHG:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_500MA:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_1A:\r\ncase MAX14577_CHARGER_TYPE_DEAD_BATTERY:\r\nreturn 1;\r\ncase MAX14577_CHARGER_TYPE_NONE:\r\ncase MAX14577_CHARGER_TYPE_DOWNSTREAM_PORT:\r\ncase MAX14577_CHARGER_TYPE_RESERVED:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int max14577_get_battery_health(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nint state = POWER_SUPPLY_HEALTH_GOOD;\r\nu8 reg_data;\r\nmax14577_read_reg(rmap, MAX14577_MUIC_REG_STATUS2, &reg_data);\r\nreg_data = ((reg_data & STATUS2_CHGTYP_MASK) >> STATUS2_CHGTYP_SHIFT);\r\nif (reg_data == MAX14577_CHARGER_TYPE_DEAD_BATTERY) {\r\nstate = POWER_SUPPLY_HEALTH_DEAD;\r\ngoto state_set;\r\n}\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\r\nif (reg_data & STATUS3_OVP_MASK) {\r\nstate = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\ngoto state_set;\r\n}\r\nstate_set:\r\nchg->battery_state = state;\r\nreturn state;\r\n}\r\nstatic int max14577_get_present(struct max14577_charger *chg)\r\n{\r\nreturn 1;\r\n}\r\nstatic void max14577_charger_reg_init(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nu8 reg_data;\r\nreg_data = 0x1 << CDETCTRL1_CHGDETEN_SHIFT;\r\nmax14577_update_reg(rmap, MAX14577_REG_CDETCTRL1,\r\nCDETCTRL1_CHGDETEN_MASK | CDETCTRL1_CHGTYPMAN_MASK,\r\nreg_data);\r\nreg_data = 0x3 << CHGCTRL1_TCHW_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL1, reg_data);\r\nreg_data = 0x1 << CHGCTRL2_VCHGR_RC_SHIFT;\r\nreg_data |= 0x1 << CHGCTRL2_MBCHOSTEN_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL2, reg_data);\r\nreg_data = 0xf << CHGCTRL3_MBCCVWRC_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL3, reg_data);\r\nreg_data = 0x1 << CHGCTRL4_MBCICHWRCL_SHIFT;\r\nreg_data |= 0x5 << CHGCTRL4_MBCICHWRCH_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL4, reg_data);\r\nreg_data = 0x0 << CHGCTRL5_EOCS_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL5, reg_data);\r\nreg_data = 0x0 << CHGCTRL6_AUTOSTOP_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL6, reg_data);\r\nreg_data = 0x2 << CHGCTRL7_OTPCGHCVS_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL7, reg_data);\r\n}\r\nstatic int max14577_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max14577_charger *chg = container_of(psy,\r\nstruct max14577_charger,\r\ncharger);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = max14577_get_charger_state(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nval->intval = max14577_get_charge_type(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = max14577_get_battery_health(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = max14577_get_present(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = max14577_get_online(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = model_name;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = manufacturer;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int max14577_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct max14577_charger *chg;\r\nstruct max14577 *max14577 = dev_get_drvdata(pdev->dev.parent);\r\nint ret;\r\nchg = devm_kzalloc(&pdev->dev, sizeof(*chg), GFP_KERNEL);\r\nif (!chg)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, chg);\r\nchg->dev = &pdev->dev;\r\nchg->max14577 = max14577;\r\nmax14577_charger_reg_init(chg);\r\nchg->charger.name = "max14577-charger",\r\nchg->charger.type = POWER_SUPPLY_TYPE_BATTERY,\r\nchg->charger.properties = max14577_charger_props,\r\nchg->charger.num_properties = ARRAY_SIZE(max14577_charger_props),\r\nchg->charger.get_property = max14577_charger_get_property,\r\nret = power_supply_register(&pdev->dev, &chg->charger);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max14577_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct max14577_charger *chg = platform_get_drvdata(pdev);\r\npower_supply_unregister(&chg->charger);\r\nreturn 0;\r\n}

int\r\nmain(int ac, char **av)\r\n{\r\nint fd, n, i;\r\nunsigned long ph, ps, np;\r\nlong nnote, nnote2, ns;\r\nif (ac != 2) {\r\nfprintf(stderr, "Usage: %s elf-file\n", av[0]);\r\nexit(1);\r\n}\r\nfd = open(av[1], O_RDWR);\r\nif (fd < 0) {\r\nperror(av[1]);\r\nexit(1);\r\n}\r\nnnote = 12 + ROUNDUP(strlen(arch) + 1) + sizeof(descr);\r\nnnote2 = 12 + ROUNDUP(strlen(rpaname) + 1) + sizeof(rpanote);\r\nn = read(fd, buf, sizeof(buf));\r\nif (n < 0) {\r\nperror("read");\r\nexit(1);\r\n}\r\nif (memcmp(&buf[E_IDENT+EI_MAGIC], elf_magic, 4) != 0)\r\ngoto notelf;\r\ne_class = buf[E_IDENT+EI_CLASS];\r\nif (e_class != ELFCLASS32 && e_class != ELFCLASS64)\r\ngoto notelf;\r\ne_data = buf[E_IDENT+EI_DATA];\r\nif (e_data != ELFDATA2MSB && e_data != ELFDATA2LSB)\r\ngoto notelf;\r\nif (n < E_HSIZE)\r\ngoto notelf;\r\nph = (e_class == ELFCLASS32 ? GET_32(E_PHOFF) : GET_64(E_PHOFF));\r\nps = GET_16(E_PHENTSIZE);\r\nnp = GET_16(E_PHNUM);\r\nif (ph < E_HSIZE || ps < PH_HSIZE || np < 1)\r\ngoto notelf;\r\nif (ph + (np + 2) * ps + nnote + nnote2 > n)\r\ngoto nospace;\r\nfor (i = 0; i < np; ++i) {\r\nif (GET_32(ph + PH_TYPE) == PT_NOTE) {\r\nfprintf(stderr, "%s already has a note entry\n",\r\nav[1]);\r\nexit(0);\r\n}\r\nph += ps;\r\n}\r\nfor (i = 0; i < 2 * ps + nnote + nnote2; ++i)\r\nif (buf[ph + i] != 0)\r\ngoto nospace;\r\nns = ph + 2 * ps;\r\nPUT_32(ph + PH_TYPE, PT_NOTE);\r\nif (e_class == ELFCLASS32)\r\nPUT_32(ph + PH_OFFSET, ns);\r\nelse\r\nPUT_64(ph + PH_OFFSET, ns);\r\nif (e_class == ELFCLASS32)\r\nPUT_32(ph + PH_FILESZ, nnote);\r\nelse\r\nPUT_64(ph + PH_FILESZ, nnote);\r\nPUT_32(ns, strlen(arch) + 1);\r\nPUT_32(ns + 4, N_DESCR * 4);\r\nPUT_32(ns + 8, 0x1275);\r\nstrcpy((char *) &buf[ns + 12], arch);\r\nns += 12 + strlen(arch) + 1;\r\nfor (i = 0; i < N_DESCR; ++i, ns += 4)\r\nPUT_32BE(ns, descr[i]);\r\nph += ps;\r\nPUT_32(ph + PH_TYPE, PT_NOTE);\r\nif (e_class == ELFCLASS32)\r\nPUT_32(ph + PH_OFFSET, ns);\r\nelse\r\nPUT_64(ph + PH_OFFSET, ns);\r\nif (e_class == ELFCLASS32)\r\nPUT_32(ph + PH_FILESZ, nnote);\r\nelse\r\nPUT_64(ph + PH_FILESZ, nnote2);\r\nPUT_32(ns, strlen(rpaname) + 1);\r\nPUT_32(ns + 4, sizeof(rpanote));\r\nPUT_32(ns + 8, 0x12759999);\r\nstrcpy((char *) &buf[ns + 12], rpaname);\r\nns += 12 + ROUNDUP(strlen(rpaname) + 1);\r\nfor (i = 0; i < N_RPA_DESCR; ++i, ns += 4)\r\nPUT_32BE(ns, rpanote[i]);\r\nPUT_16(E_PHNUM, np + 2);\r\nlseek(fd, (long) 0, SEEK_SET);\r\ni = write(fd, buf, n);\r\nif (i < 0) {\r\nperror("write");\r\nexit(1);\r\n}\r\nif (i < n) {\r\nfprintf(stderr, "%s: write truncated\n", av[1]);\r\nexit(1);\r\n}\r\nexit(0);\r\nnotelf:\r\nfprintf(stderr, "%s does not appear to be an ELF file\n", av[1]);\r\nexit(1);\r\nnospace:\r\nfprintf(stderr, "sorry, I can't find space in %s to put the note\n",\r\nav[1]);\r\nexit(1);\r\n}

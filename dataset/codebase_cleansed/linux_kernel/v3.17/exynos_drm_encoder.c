static void exynos_drm_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\nstruct exynos_drm_display *display = exynos_encoder->display;\r\nDRM_DEBUG_KMS("encoder dpms: %d\n", mode);\r\nif (display->ops->dpms)\r\ndisplay->ops->dpms(display, mode);\r\n}\r\nstatic bool\r\nexynos_drm_encoder_mode_fixup(struct drm_encoder *encoder,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\nstruct exynos_drm_display *display = exynos_encoder->display;\r\nstruct drm_connector *connector;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nif (connector->encoder != encoder)\r\ncontinue;\r\nif (display->ops->mode_fixup)\r\ndisplay->ops->mode_fixup(display, connector, mode,\r\nadjusted_mode);\r\n}\r\nreturn true;\r\n}\r\nstatic void exynos_drm_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\nstruct exynos_drm_display *display = exynos_encoder->display;\r\nif (display->ops->mode_set)\r\ndisplay->ops->mode_set(display, adjusted_mode);\r\n}\r\nstatic void exynos_drm_encoder_prepare(struct drm_encoder *encoder)\r\n{\r\n}\r\nstatic void exynos_drm_encoder_commit(struct drm_encoder *encoder)\r\n{\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\nstruct exynos_drm_display *display = exynos_encoder->display;\r\nif (display->ops->dpms)\r\ndisplay->ops->dpms(display, DRM_MODE_DPMS_ON);\r\nif (display->ops->commit)\r\ndisplay->ops->commit(display);\r\n}\r\nstatic void exynos_drm_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct drm_plane *plane;\r\nstruct drm_device *dev = encoder->dev;\r\nexynos_drm_encoder_dpms(encoder, DRM_MODE_DPMS_OFF);\r\ndrm_for_each_legacy_plane(plane, &dev->mode_config.plane_list) {\r\nif (plane->crtc == encoder->crtc)\r\nplane->funcs->disable_plane(plane);\r\n}\r\n}\r\nstatic void exynos_drm_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(exynos_encoder);\r\n}\r\nstatic unsigned int exynos_drm_encoder_clones(struct drm_encoder *encoder)\r\n{\r\nstruct drm_encoder *clone;\r\nstruct drm_device *dev = encoder->dev;\r\nstruct exynos_drm_encoder *exynos_encoder = to_exynos_encoder(encoder);\r\nstruct exynos_drm_display *display = exynos_encoder->display;\r\nunsigned int clone_mask = 0;\r\nint cnt = 0;\r\nlist_for_each_entry(clone, &dev->mode_config.encoder_list, head) {\r\nswitch (display->type) {\r\ncase EXYNOS_DISPLAY_TYPE_LCD:\r\ncase EXYNOS_DISPLAY_TYPE_HDMI:\r\ncase EXYNOS_DISPLAY_TYPE_VIDI:\r\nclone_mask |= (1 << (cnt++));\r\nbreak;\r\ndefault:\r\ncontinue;\r\n}\r\n}\r\nreturn clone_mask;\r\n}\r\nvoid exynos_drm_encoder_setup(struct drm_device *dev)\r\n{\r\nstruct drm_encoder *encoder;\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head)\r\nencoder->possible_clones = exynos_drm_encoder_clones(encoder);\r\n}\r\nstruct drm_encoder *\r\nexynos_drm_encoder_create(struct drm_device *dev,\r\nstruct exynos_drm_display *display,\r\nunsigned long possible_crtcs)\r\n{\r\nstruct drm_encoder *encoder;\r\nstruct exynos_drm_encoder *exynos_encoder;\r\nif (!possible_crtcs)\r\nreturn NULL;\r\nexynos_encoder = kzalloc(sizeof(*exynos_encoder), GFP_KERNEL);\r\nif (!exynos_encoder)\r\nreturn NULL;\r\nexynos_encoder->display = display;\r\nencoder = &exynos_encoder->drm_encoder;\r\nencoder->possible_crtcs = possible_crtcs;\r\nDRM_DEBUG_KMS("possible_crtcs = 0x%x\n", encoder->possible_crtcs);\r\ndrm_encoder_init(dev, encoder, &exynos_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(encoder, &exynos_encoder_helper_funcs);\r\nDRM_DEBUG_KMS("encoder has been created\n");\r\nreturn encoder;\r\n}\r\nstruct exynos_drm_display *exynos_drm_get_display(struct drm_encoder *encoder)\r\n{\r\nreturn to_exynos_encoder(encoder)->display;\r\n}

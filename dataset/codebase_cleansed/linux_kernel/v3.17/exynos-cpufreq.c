static int exynos_cpufreq_get_index(unsigned int freq)\r\n{\r\nstruct cpufreq_frequency_table *freq_table = exynos_info->freq_table;\r\nstruct cpufreq_frequency_table *pos;\r\ncpufreq_for_each_entry(pos, freq_table)\r\nif (pos->frequency == freq)\r\nbreak;\r\nif (pos->frequency == CPUFREQ_TABLE_END)\r\nreturn -EINVAL;\r\nreturn pos - freq_table;\r\n}\r\nstatic int exynos_cpufreq_scale(unsigned int target_freq)\r\n{\r\nstruct cpufreq_frequency_table *freq_table = exynos_info->freq_table;\r\nunsigned int *volt_table = exynos_info->volt_table;\r\nstruct cpufreq_policy *policy = cpufreq_cpu_get(0);\r\nunsigned int arm_volt, safe_arm_volt = 0;\r\nunsigned int mpll_freq_khz = exynos_info->mpll_freq_khz;\r\nstruct device *dev = exynos_info->dev;\r\nunsigned int old_freq;\r\nint index, old_index;\r\nint ret = 0;\r\nold_freq = policy->cur;\r\nold_index = exynos_cpufreq_get_index(old_freq);\r\nif (old_index < 0) {\r\nret = old_index;\r\ngoto out;\r\n}\r\nindex = exynos_cpufreq_get_index(target_freq);\r\nif (index < 0) {\r\nret = index;\r\ngoto out;\r\n}\r\nif (exynos_info->need_apll_change != NULL) {\r\nif (exynos_info->need_apll_change(old_index, index) &&\r\n(freq_table[index].frequency < mpll_freq_khz) &&\r\n(freq_table[old_index].frequency < mpll_freq_khz))\r\nsafe_arm_volt = volt_table[exynos_info->pll_safe_idx];\r\n}\r\narm_volt = volt_table[index];\r\nif ((target_freq > old_freq) && !safe_arm_volt) {\r\nret = regulator_set_voltage(arm_regulator, arm_volt, arm_volt);\r\nif (ret) {\r\ndev_err(dev, "failed to set cpu voltage to %d\n",\r\narm_volt);\r\nreturn ret;\r\n}\r\n}\r\nif (safe_arm_volt) {\r\nret = regulator_set_voltage(arm_regulator, safe_arm_volt,\r\nsafe_arm_volt);\r\nif (ret) {\r\ndev_err(dev, "failed to set cpu voltage to %d\n",\r\nsafe_arm_volt);\r\nreturn ret;\r\n}\r\n}\r\nexynos_info->set_freq(old_index, index);\r\nif ((target_freq < old_freq) ||\r\n((target_freq > old_freq) && safe_arm_volt)) {\r\nret = regulator_set_voltage(arm_regulator, arm_volt,\r\narm_volt);\r\nif (ret) {\r\ndev_err(dev, "failed to set cpu voltage to %d\n",\r\narm_volt);\r\ngoto out;\r\n}\r\n}\r\nout:\r\ncpufreq_cpu_put(policy);\r\nreturn ret;\r\n}\r\nstatic int exynos_target(struct cpufreq_policy *policy, unsigned int index)\r\n{\r\nreturn exynos_cpufreq_scale(exynos_info->freq_table[index].frequency);\r\n}\r\nstatic int exynos_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\npolicy->clk = exynos_info->cpu_clk;\r\npolicy->suspend_freq = locking_frequency;\r\nreturn cpufreq_generic_init(policy, exynos_info->freq_table, 100000);\r\n}\r\nstatic int exynos_cpufreq_probe(struct platform_device *pdev)\r\n{\r\nint ret = -EINVAL;\r\nexynos_info = kzalloc(sizeof(*exynos_info), GFP_KERNEL);\r\nif (!exynos_info)\r\nreturn -ENOMEM;\r\nexynos_info->dev = &pdev->dev;\r\nif (of_machine_is_compatible("samsung,exynos4210")) {\r\nexynos_info->type = EXYNOS_SOC_4210;\r\nret = exynos4210_cpufreq_init(exynos_info);\r\n} else if (of_machine_is_compatible("samsung,exynos4212")) {\r\nexynos_info->type = EXYNOS_SOC_4212;\r\nret = exynos4x12_cpufreq_init(exynos_info);\r\n} else if (of_machine_is_compatible("samsung,exynos4412")) {\r\nexynos_info->type = EXYNOS_SOC_4412;\r\nret = exynos4x12_cpufreq_init(exynos_info);\r\n} else if (of_machine_is_compatible("samsung,exynos5250")) {\r\nexynos_info->type = EXYNOS_SOC_5250;\r\nret = exynos5250_cpufreq_init(exynos_info);\r\n} else {\r\npr_err("%s: Unknown SoC type\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nif (ret)\r\ngoto err_vdd_arm;\r\nif (exynos_info->set_freq == NULL) {\r\ndev_err(&pdev->dev, "No set_freq function (ERR)\n");\r\ngoto err_vdd_arm;\r\n}\r\narm_regulator = regulator_get(NULL, "vdd_arm");\r\nif (IS_ERR(arm_regulator)) {\r\ndev_err(&pdev->dev, "failed to get resource vdd_arm\n");\r\ngoto err_vdd_arm;\r\n}\r\nlocking_frequency = clk_get_rate(exynos_info->cpu_clk) / 1000;\r\nif (!cpufreq_register_driver(&exynos_driver))\r\nreturn 0;\r\ndev_err(&pdev->dev, "failed to register cpufreq driver\n");\r\nregulator_put(arm_regulator);\r\nerr_vdd_arm:\r\nkfree(exynos_info);\r\nreturn -EINVAL;\r\n}

static inline struct upd64031a_state *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct upd64031a_state, sd);\r\n}\r\nstatic u8 upd64031a_read(struct v4l2_subdev *sd, u8 reg)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nu8 buf[2];\r\nif (reg >= sizeof(buf))\r\nreturn 0xff;\r\ni2c_master_recv(client, buf, 2);\r\nreturn buf[reg];\r\n}\r\nstatic void upd64031a_write(struct v4l2_subdev *sd, u8 reg, u8 val)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nu8 buf[2];\r\nbuf[0] = reg;\r\nbuf[1] = val;\r\nv4l2_dbg(1, debug, sd, "write reg: %02X val: %02X\n", reg, val);\r\nif (i2c_master_send(client, buf, 2) != 2)\r\nv4l2_err(sd, "I/O error write 0x%02x/0x%02x\n", reg, val);\r\n}\r\nstatic int upd64031a_s_frequency(struct v4l2_subdev *sd, const struct v4l2_frequency *freq)\r\n{\r\nstruct upd64031a_state *state = to_state(sd);\r\nu8 reg = state->regs[R00];\r\nv4l2_dbg(1, debug, sd, "changed input or channel\n");\r\nupd64031a_write(sd, R00, reg | 0x10);\r\nupd64031a_write(sd, R00, reg & ~0x10);\r\nreturn 0;\r\n}\r\nstatic int upd64031a_s_routing(struct v4l2_subdev *sd,\r\nu32 input, u32 output, u32 config)\r\n{\r\nstruct upd64031a_state *state = to_state(sd);\r\nu8 r00, r05, r08;\r\nstate->gr_mode = (input & 3) << 6;\r\nstate->direct_3dycs_connect = (input & 0xc) << 4;\r\nstate->ext_comp_sync =\r\n(input & UPD64031A_COMPOSITE_EXTERNAL) << 1;\r\nstate->ext_vert_sync =\r\n(input & UPD64031A_VERTICAL_EXTERNAL) << 2;\r\nr00 = (state->regs[R00] & ~GR_MODE_MASK) | state->gr_mode;\r\nr05 = (state->regs[R00] & ~SYNC_CIRCUIT_MASK) |\r\nstate->ext_comp_sync | state->ext_vert_sync;\r\nr08 = (state->regs[R08] & ~DIRECT_3DYCS_CONNECT_MASK) |\r\nstate->direct_3dycs_connect;\r\nupd64031a_write(sd, R00, r00);\r\nupd64031a_write(sd, R05, r05);\r\nupd64031a_write(sd, R08, r08);\r\nreturn upd64031a_s_frequency(sd, NULL);\r\n}\r\nstatic int upd64031a_log_status(struct v4l2_subdev *sd)\r\n{\r\nv4l2_info(sd, "Status: SA00=0x%02x SA01=0x%02x\n",\r\nupd64031a_read(sd, 0), upd64031a_read(sd, 1));\r\nreturn 0;\r\n}\r\nstatic int upd64031a_g_register(struct v4l2_subdev *sd, struct v4l2_dbg_register *reg)\r\n{\r\nreg->val = upd64031a_read(sd, reg->reg & 0xff);\r\nreg->size = 1;\r\nreturn 0;\r\n}\r\nstatic int upd64031a_s_register(struct v4l2_subdev *sd, const struct v4l2_dbg_register *reg)\r\n{\r\nupd64031a_write(sd, reg->reg & 0xff, reg->val & 0xff);\r\nreturn 0;\r\n}\r\nstatic int upd64031a_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct upd64031a_state *state;\r\nstruct v4l2_subdev *sd;\r\nint i;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\nv4l_info(client, "chip found @ 0x%x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nstate = devm_kzalloc(&client->dev, sizeof(*state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn -ENOMEM;\r\nsd = &state->sd;\r\nv4l2_i2c_subdev_init(sd, client, &upd64031a_ops);\r\nmemcpy(state->regs, upd64031a_init, sizeof(state->regs));\r\nstate->gr_mode = UPD64031A_GR_ON << 6;\r\nstate->direct_3dycs_connect = UPD64031A_3DYCS_COMPOSITE << 4;\r\nstate->ext_comp_sync = state->ext_vert_sync = 0;\r\nfor (i = 0; i < TOT_REGS; i++)\r\nupd64031a_write(sd, i, state->regs[i]);\r\nreturn 0;\r\n}\r\nstatic int upd64031a_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nv4l2_device_unregister_subdev(sd);\r\nreturn 0;\r\n}

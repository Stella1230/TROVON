static int smdk_wm8994_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned long mclk_freq;\r\nint rfs, ret;\r\nswitch(params_rate(params)) {\r\ncase 8000:\r\nrfs = 512;\r\nbreak;\r\ndefault:\r\ndev_err(cpu_dai->dev, "%s:%d Sampling Rate %u not supported!\n",\r\n__func__, __LINE__, params_rate(params));\r\nreturn -EINVAL;\r\n}\r\nmclk_freq = params_rate(params) * rfs;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_DSP_B\r\n| SND_SOC_DAIFMT_IB_NF\r\n| SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_DSP_B\r\n| SND_SOC_DAIFMT_IB_NF\r\n| SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_FLL1,\r\nmclk_freq, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8994_FLL1, WM8994_FLL_SRC_MCLK1,\r\nSMDK_WM8994_FREQ, mclk_freq);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, S3C_PCM_CLKSRC_MUX,\r\nmclk_freq, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C_PCM_SCLK_PER_FS, rfs);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int snd_smdk_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nsmdk_pcm.dev = &pdev->dev;\r\nret = devm_snd_soc_register_card(&pdev->dev, &smdk_pcm);\r\nif (ret)\r\ndev_err(&pdev->dev, "snd_soc_register_card failed %d\n", ret);\r\nreturn ret;\r\n}

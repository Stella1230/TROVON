static int armada_drm_slave_get_modes(struct drm_connector *conn)\r\n{\r\nstruct drm_encoder *enc = armada_drm_connector_encoder(conn);\r\nint count = 0;\r\nif (enc) {\r\nstruct drm_encoder_slave *slave = to_encoder_slave(enc);\r\ncount = slave->slave_funcs->get_modes(enc, conn);\r\n}\r\nreturn count;\r\n}\r\nstatic void armada_drm_slave_destroy(struct drm_encoder *enc)\r\n{\r\nstruct drm_encoder_slave *slave = to_encoder_slave(enc);\r\nstruct i2c_client *client = drm_i2c_encoder_get_client(enc);\r\nif (slave->slave_funcs)\r\nslave->slave_funcs->destroy(enc);\r\nif (client)\r\ni2c_put_adapter(client->adapter);\r\ndrm_encoder_cleanup(&slave->base);\r\nkfree(slave);\r\n}\r\nstatic int\r\narmada_drm_conn_slave_create(struct drm_connector *conn, const void *data)\r\n{\r\nconst struct armada_drm_slave_config *config = data;\r\nstruct drm_encoder_slave *slave;\r\nstruct i2c_adapter *adap;\r\nint ret;\r\nconn->interlace_allowed = config->interlace_allowed;\r\nconn->doublescan_allowed = config->doublescan_allowed;\r\nconn->polled = config->polled;\r\ndrm_connector_helper_add(conn, &armada_drm_slave_helper_funcs);\r\nslave = kzalloc(sizeof(*slave), GFP_KERNEL);\r\nif (!slave)\r\nreturn -ENOMEM;\r\nslave->base.possible_crtcs = config->crtcs;\r\nadap = i2c_get_adapter(config->i2c_adapter_id);\r\nif (!adap) {\r\nkfree(slave);\r\nreturn -EPROBE_DEFER;\r\n}\r\nret = drm_encoder_init(conn->dev, &slave->base,\r\n&armada_drm_slave_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS);\r\nif (ret) {\r\nDRM_ERROR("unable to init encoder\n");\r\ni2c_put_adapter(adap);\r\nkfree(slave);\r\nreturn ret;\r\n}\r\nret = drm_i2c_encoder_init(conn->dev, slave, adap, &config->info);\r\ni2c_put_adapter(adap);\r\nif (ret) {\r\nDRM_ERROR("unable to init encoder slave\n");\r\narmada_drm_slave_destroy(&slave->base);\r\nreturn ret;\r\n}\r\ndrm_encoder_helper_add(&slave->base, &drm_slave_encoder_helpers);\r\nret = slave->slave_funcs->create_resources(&slave->base, conn);\r\nif (ret) {\r\narmada_drm_slave_destroy(&slave->base);\r\nreturn ret;\r\n}\r\nret = drm_mode_connector_attach_encoder(conn, &slave->base);\r\nif (ret) {\r\narmada_drm_slave_destroy(&slave->base);\r\nreturn ret;\r\n}\r\nconn->encoder = &slave->base;\r\nreturn ret;\r\n}\r\nint armada_drm_connector_slave_create(struct drm_device *dev,\r\nconst struct armada_drm_slave_config *config)\r\n{\r\nreturn armada_output_create(dev, &armada_drm_conn_slave, config);\r\n}

int omap2_wd_timer_disable(struct omap_hwmod *oh)\r\n{\r\nvoid __iomem *base;\r\nif (!oh) {\r\npr_err("%s: Could not look up wdtimer_hwmod\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nbase = omap_hwmod_get_mpu_rt_va(oh);\r\nif (!base) {\r\npr_err("%s: Could not get the base address for %s\n",\r\noh->name, __func__);\r\nreturn -EINVAL;\r\n}\r\nwritel_relaxed(0xAAAA, base + OMAP_WDT_SPR);\r\nwhile (readl_relaxed(base + OMAP_WDT_WPS) & 0x10)\r\ncpu_relax();\r\nwritel_relaxed(0x5555, base + OMAP_WDT_SPR);\r\nwhile (readl_relaxed(base + OMAP_WDT_WPS) & 0x10)\r\ncpu_relax();\r\nreturn 0;\r\n}\r\nint omap2_wd_timer_reset(struct omap_hwmod *oh)\r\n{\r\nint c = 0;\r\nomap_hwmod_softreset(oh);\r\nomap_test_timeout((omap_hwmod_read(oh,\r\noh->class->sysc->syss_offs)\r\n& SYSS_RESETDONE_MASK),\r\nMAX_MODULE_SOFTRESET_WAIT, c);\r\nif (oh->class->sysc->srst_udelay)\r\nudelay(oh->class->sysc->srst_udelay);\r\nif (c == MAX_MODULE_SOFTRESET_WAIT)\r\npr_warning("%s: %s: softreset failed (waited %d usec)\n",\r\n__func__, oh->name, MAX_MODULE_SOFTRESET_WAIT);\r\nelse\r\npr_debug("%s: %s: softreset in %d usec\n", __func__,\r\noh->name, c);\r\nreturn (c == MAX_MODULE_SOFTRESET_WAIT) ? -ETIMEDOUT :\r\nomap2_wd_timer_disable(oh);\r\n}\r\nstatic int __init omap_init_wdt(void)\r\n{\r\nint id = -1;\r\nstruct platform_device *pdev;\r\nstruct omap_hwmod *oh;\r\nchar *oh_name = "wd_timer2";\r\nchar *dev_name = "omap_wdt";\r\nstruct omap_wd_timer_platform_data pdata;\r\nif (!cpu_class_is_omap2() || of_have_populated_dt())\r\nreturn 0;\r\noh = omap_hwmod_lookup(oh_name);\r\nif (!oh) {\r\npr_err("Could not look up wd_timer%d hwmod\n", id);\r\nreturn -EINVAL;\r\n}\r\npdata.read_reset_sources = prm_read_reset_sources;\r\npdev = omap_device_build(dev_name, id, oh, &pdata,\r\nsizeof(struct omap_wd_timer_platform_data));\r\nWARN(IS_ERR(pdev), "Can't build omap_device for %s:%s.\n",\r\ndev_name, oh->name);\r\nreturn 0;\r\n}

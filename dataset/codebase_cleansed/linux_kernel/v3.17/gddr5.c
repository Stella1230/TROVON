int\r\nnouveau_gddr5_calc(struct nouveau_ram *ram, bool nuts)\r\n{\r\nint pd, lf, xd, vh, vr, vo, l3;\r\nint WL, CL, WR, at[2], dt, ds;\r\nint rq = ram->freq < 1000000;\r\nswitch (ram->ramcfg.version) {\r\ncase 0x11:\r\npd = ram->next->bios.ramcfg_11_01_80;\r\nlf = ram->next->bios.ramcfg_11_01_40;\r\nxd = !ram->next->bios.ramcfg_11_01_20;\r\nvh = ram->next->bios.ramcfg_11_02_10;\r\nvr = ram->next->bios.ramcfg_11_02_04;\r\nvo = ram->next->bios.ramcfg_11_06;\r\nl3 = !ram->next->bios.ramcfg_11_07_02;\r\nbreak;\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\nswitch (ram->timing.version) {\r\ncase 0x20:\r\nWL = (ram->next->bios.timing[1] & 0x00000f80) >> 7;\r\nCL = (ram->next->bios.timing[1] & 0x0000001f);\r\nWR = (ram->next->bios.timing[2] & 0x007f0000) >> 16;\r\nat[0] = ram->next->bios.timing_20_2e_c0;\r\nat[1] = ram->next->bios.timing_20_2e_30;\r\ndt = ram->next->bios.timing_20_2e_03;\r\nds = ram->next->bios.timing_20_2f_03;\r\nbreak;\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\nif (WL < 1 || WL > 7 || CL < 5 || CL > 36 || WR < 4 || WR > 35)\r\nreturn -EINVAL;\r\nCL -= 5;\r\nWR -= 4;\r\nram->mr[0] &= ~0xf7f;\r\nram->mr[0] |= (WR & 0x0f) << 8;\r\nram->mr[0] |= (CL & 0x0f) << 3;\r\nram->mr[0] |= (WL & 0x07) << 0;\r\nram->mr[1] &= ~0x0bf;\r\nram->mr[1] |= (xd & 0x01) << 7;\r\nram->mr[1] |= (at[0] & 0x03) << 4;\r\nram->mr[1] |= (dt & 0x03) << 2;\r\nram->mr[1] |= (ds & 0x03) << 0;\r\nram->mr1_nuts = ram->mr[1];\r\nif (nuts) {\r\nram->mr[1] &= ~0x030;\r\nram->mr[1] |= (at[1] & 0x03) << 4;\r\n}\r\nram->mr[3] &= ~0x020;\r\nram->mr[3] |= (rq & 0x01) << 5;\r\nram->mr[5] &= ~0x004;\r\nram->mr[5] |= (l3 << 2);\r\nif (!vo)\r\nvo = (ram->mr[6] & 0xff0) >> 4;\r\nif (ram->mr[6] & 0x001)\r\npd = 1;\r\nram->mr[6] &= ~0xff1;\r\nram->mr[6] |= (vo & 0xff) << 4;\r\nram->mr[6] |= (pd & 0x01) << 0;\r\nif (NOTE00(vr)) {\r\nram->mr[7] &= ~0x300;\r\nram->mr[7] |= (vr & 0x03) << 8;\r\n}\r\nram->mr[7] &= ~0x088;\r\nram->mr[7] |= (vh & 0x01) << 7;\r\nram->mr[7] |= (lf & 0x01) << 3;\r\nram->mr[8] &= ~0x003;\r\nram->mr[8] |= (WR & 0x10) >> 3;\r\nram->mr[8] |= (CL & 0x10) >> 4;\r\nreturn 0;\r\n}

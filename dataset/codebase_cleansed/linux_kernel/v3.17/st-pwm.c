static int st_pwm_regulator_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct st_pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nreturn drvdata->state;\r\n}\r\nstatic int st_pwm_regulator_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct st_pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nint dutycycle;\r\nint ret;\r\ndutycycle = (ST_PWM_REG_PERIOD / 100) *\r\ndrvdata->pdata->duty_cycle_table[selector].dutycycle;\r\nret = pwm_config(drvdata->pwm, dutycycle, ST_PWM_REG_PERIOD);\r\nif (ret) {\r\ndev_err(&dev->dev, "Failed to configure PWM\n");\r\nreturn ret;\r\n}\r\ndrvdata->state = selector;\r\nif (!drvdata->enabled) {\r\nret = pwm_enable(drvdata->pwm);\r\nif (ret) {\r\ndev_err(&dev->dev, "Failed to enable PWM\n");\r\nreturn ret;\r\n}\r\ndrvdata->enabled = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_pwm_regulator_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct st_pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nif (selector >= dev->desc->n_voltages)\r\nreturn -EINVAL;\r\nreturn drvdata->pdata->duty_cycle_table[selector].uV;\r\n}\r\nstatic int st_pwm_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct st_pwm_regulator_data *drvdata;\r\nstruct regulator_dev *regulator;\r\nstruct regulator_config config = { };\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst struct of_device_id *of_match;\r\nif (!np) {\r\ndev_err(&pdev->dev, "Device Tree node missing\n");\r\nreturn -EINVAL;\r\n}\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nof_match = of_match_device(st_pwm_of_match, &pdev->dev);\r\nif (!of_match) {\r\ndev_err(&pdev->dev, "failed to match of device\n");\r\nreturn -ENODEV;\r\n}\r\ndrvdata->pdata = of_match->data;\r\nconfig.init_data = of_get_regulator_init_data(&pdev->dev, np);\r\nif (!config.init_data)\r\nreturn -ENOMEM;\r\nconfig.of_node = np;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = drvdata;\r\ndrvdata->pwm = devm_pwm_get(&pdev->dev, NULL);\r\nif (IS_ERR(drvdata->pwm)) {\r\ndev_err(&pdev->dev, "Failed to get PWM\n");\r\nreturn PTR_ERR(drvdata->pwm);\r\n}\r\nregulator = devm_regulator_register(&pdev->dev,\r\ndrvdata->pdata->desc, &config);\r\nif (IS_ERR(regulator)) {\r\ndev_err(&pdev->dev, "Failed to register regulator %s\n",\r\ndrvdata->pdata->desc->name);\r\nreturn PTR_ERR(regulator);\r\n}\r\nreturn 0;\r\n}

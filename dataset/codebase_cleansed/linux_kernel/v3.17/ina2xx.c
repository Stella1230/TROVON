static struct ina2xx_data *ina2xx_update_device(struct device *dev)\r\n{\r\nstruct ina2xx_data *data = dev_get_drvdata(dev);\r\nstruct i2c_client *client = data->client;\r\nstruct ina2xx_data *ret = data;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated +\r\nHZ / INA2XX_CONVERSION_RATE) || !data->valid) {\r\nint i;\r\ndev_dbg(&client->dev, "Starting ina2xx update\n");\r\nfor (i = 0; i < data->config->registers; i++) {\r\nint rv = i2c_smbus_read_word_swapped(client, i);\r\nif (rv < 0) {\r\nret = ERR_PTR(rv);\r\ngoto abort;\r\n}\r\ndata->regs[i] = rv;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int ina2xx_get_value(struct ina2xx_data *data, u8 reg)\r\n{\r\nint val;\r\nswitch (reg) {\r\ncase INA2XX_SHUNT_VOLTAGE:\r\nval = DIV_ROUND_CLOSEST((s16)data->regs[reg],\r\ndata->config->shunt_div);\r\nbreak;\r\ncase INA2XX_BUS_VOLTAGE:\r\nval = (data->regs[reg] >> data->config->bus_voltage_shift)\r\n* data->config->bus_voltage_lsb;\r\nval = DIV_ROUND_CLOSEST(val, 1000);\r\nbreak;\r\ncase INA2XX_POWER:\r\nval = data->regs[reg] * data->config->power_lsb;\r\nbreak;\r\ncase INA2XX_CURRENT:\r\nval = (s16)data->regs[reg];\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nval = 0;\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic ssize_t ina2xx_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ina2xx_data *data = ina2xx_update_device(dev);\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\nina2xx_get_value(data, attr->index));\r\n}\r\nstatic int ina2xx_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nstruct ina2xx_platform_data *pdata;\r\nstruct device *dev = &client->dev;\r\nstruct ina2xx_data *data;\r\nstruct device *hwmon_dev;\r\nlong shunt = 10000;\r\nu32 val;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_WORD_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (dev_get_platdata(dev)) {\r\npdata = dev_get_platdata(dev);\r\nshunt = pdata->shunt_uohms;\r\n} else if (!of_property_read_u32(dev->of_node,\r\n"shunt-resistor", &val)) {\r\nshunt = val;\r\n}\r\nif (shunt <= 0)\r\nreturn -ENODEV;\r\ndata->kind = id->driver_data;\r\ndata->config = &ina2xx_config[data->kind];\r\ni2c_smbus_write_word_swapped(client, INA2XX_CONFIG,\r\ndata->config->config_default);\r\ni2c_smbus_write_word_swapped(client, INA2XX_CALIBRATION,\r\ndata->config->calibration_factor / shunt);\r\ndata->client = client;\r\nmutex_init(&data->update_lock);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\ndata, ina2xx_groups);\r\nif (IS_ERR(hwmon_dev))\r\nreturn PTR_ERR(hwmon_dev);\r\ndev_info(dev, "power monitor %s (Rshunt = %li uOhm)\n",\r\nid->name, shunt);\r\nreturn 0;\r\n}

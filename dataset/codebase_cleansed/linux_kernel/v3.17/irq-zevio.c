static void zevio_irq_ack(struct irq_data *irqd)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(irqd);\r\nstruct irq_chip_regs *regs =\r\n&container_of(irqd->chip, struct irq_chip_type, chip)->regs;\r\nreadl(gc->reg_base + regs->ack);\r\n}\r\nstatic void __exception_irq_entry zevio_handle_irq(struct pt_regs *regs)\r\n{\r\nint irqnr;\r\nwhile (readl(zevio_irq_io + IO_STATUS)) {\r\nirqnr = readl(zevio_irq_io + IO_CURRENT);\r\nirqnr = irq_find_mapping(zevio_irq_domain, irqnr);\r\nhandle_IRQ(irqnr, regs);\r\n};\r\n}\r\nstatic void __init zevio_init_irq_base(void __iomem *base)\r\n{\r\nwritel(~0, base + IO_DISABLE);\r\nwritel(0xF, base + IO_MAX_PRIOTY);\r\nreadl(base + IO_RESET);\r\n}\r\nstatic int __init zevio_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nunsigned int clr = IRQ_NOREQUEST | IRQ_NOPROBE | IRQ_NOAUTOEN;\r\nstruct irq_chip_generic *gc;\r\nint ret;\r\nif (WARN_ON(zevio_irq_io || zevio_irq_domain))\r\nreturn -EBUSY;\r\nzevio_irq_io = of_iomap(node, 0);\r\nBUG_ON(!zevio_irq_io);\r\nwritel(~0, zevio_irq_io + IO_INVERT_SEL);\r\nwritel(0, zevio_irq_io + IO_STICKY_SEL);\r\nmemset_io(zevio_irq_io + IO_PRIORITY_SEL, 0, MAX_INTRS * sizeof(u32));\r\nzevio_init_irq_base(zevio_irq_io + IO_IRQ_BASE);\r\nzevio_init_irq_base(zevio_irq_io + IO_FIQ_BASE);\r\nzevio_irq_domain = irq_domain_add_linear(node, MAX_INTRS,\r\n&irq_generic_chip_ops, NULL);\r\nBUG_ON(!zevio_irq_domain);\r\nret = irq_alloc_domain_generic_chips(zevio_irq_domain, MAX_INTRS, 1,\r\n"zevio_intc", handle_level_irq,\r\nclr, 0, IRQ_GC_INIT_MASK_CACHE);\r\nBUG_ON(ret);\r\ngc = irq_get_domain_generic_chip(zevio_irq_domain, 0);\r\ngc->reg_base = zevio_irq_io;\r\ngc->chip_types[0].chip.irq_ack = zevio_irq_ack;\r\ngc->chip_types[0].chip.irq_mask = irq_gc_mask_disable_reg;\r\ngc->chip_types[0].chip.irq_unmask = irq_gc_unmask_enable_reg;\r\ngc->chip_types[0].regs.mask = IO_IRQ_BASE + IO_ENABLE;\r\ngc->chip_types[0].regs.enable = IO_IRQ_BASE + IO_ENABLE;\r\ngc->chip_types[0].regs.disable = IO_IRQ_BASE + IO_DISABLE;\r\ngc->chip_types[0].regs.ack = IO_IRQ_BASE + IO_RESET;\r\nset_handle_irq(zevio_handle_irq);\r\npr_info("TI-NSPIRE classic IRQ controller\n");\r\nreturn 0;\r\n}

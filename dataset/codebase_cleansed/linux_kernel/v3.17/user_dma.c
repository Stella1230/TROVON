int dma_skb_copy_datagram_iovec(struct dma_chan *chan,\r\nstruct sk_buff *skb, int offset, struct iovec *to,\r\nsize_t len, struct dma_pinned_list *pinned_list)\r\n{\r\nint start = skb_headlen(skb);\r\nint i, copy = start - offset;\r\nstruct sk_buff *frag_iter;\r\ndma_cookie_t cookie = 0;\r\nif (copy > 0) {\r\nif (copy > len)\r\ncopy = len;\r\ncookie = dma_memcpy_to_iovec(chan, to, pinned_list,\r\nskb->data + offset, copy);\r\nif (cookie < 0)\r\ngoto fault;\r\nlen -= copy;\r\nif (len == 0)\r\ngoto end;\r\noffset += copy;\r\n}\r\nfor (i = 0; i < skb_shinfo(skb)->nr_frags; i++) {\r\nint end;\r\nconst skb_frag_t *frag = &skb_shinfo(skb)->frags[i];\r\nWARN_ON(start > offset + len);\r\nend = start + skb_frag_size(frag);\r\ncopy = end - offset;\r\nif (copy > 0) {\r\nstruct page *page = skb_frag_page(frag);\r\nif (copy > len)\r\ncopy = len;\r\ncookie = dma_memcpy_pg_to_iovec(chan, to, pinned_list, page,\r\nfrag->page_offset + offset - start, copy);\r\nif (cookie < 0)\r\ngoto fault;\r\nlen -= copy;\r\nif (len == 0)\r\ngoto end;\r\noffset += copy;\r\n}\r\nstart = end;\r\n}\r\nskb_walk_frags(skb, frag_iter) {\r\nint end;\r\nWARN_ON(start > offset + len);\r\nend = start + frag_iter->len;\r\ncopy = end - offset;\r\nif (copy > 0) {\r\nif (copy > len)\r\ncopy = len;\r\ncookie = dma_skb_copy_datagram_iovec(chan, frag_iter,\r\noffset - start,\r\nto, copy,\r\npinned_list);\r\nif (cookie < 0)\r\ngoto fault;\r\nlen -= copy;\r\nif (len == 0)\r\ngoto end;\r\noffset += copy;\r\n}\r\nstart = end;\r\n}\r\nend:\r\nif (!len) {\r\nskb->dma_cookie = cookie;\r\nreturn cookie;\r\n}\r\nfault:\r\nreturn -EFAULT;\r\n}

static bool find_voltage_set_register(struct max8973_chip *tps,\r\nint req_vsel, int *vout_reg, int *gpio_val)\r\n{\r\nint i;\r\nbool found = false;\r\nint new_vout_reg = tps->lru_index[MAX8973_MAX_VOUT_REG - 1];\r\nint found_index = MAX8973_MAX_VOUT_REG - 1;\r\nfor (i = 0; i < MAX8973_MAX_VOUT_REG; ++i) {\r\nif (tps->curr_vout_val[tps->lru_index[i]] == req_vsel) {\r\nnew_vout_reg = tps->lru_index[i];\r\nfound_index = i;\r\nfound = true;\r\ngoto update_lru_index;\r\n}\r\n}\r\nupdate_lru_index:\r\nfor (i = found_index; i > 0; i--)\r\ntps->lru_index[i] = tps->lru_index[i - 1];\r\ntps->lru_index[0] = new_vout_reg;\r\n*gpio_val = new_vout_reg;\r\n*vout_reg = MAX8973_VOUT + new_vout_reg;\r\nreturn found;\r\n}\r\nstatic int max8973_dcdc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(max->regmap, max->curr_vout_reg, &data);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed, err = %d\n",\r\nmax->curr_vout_reg, ret);\r\nreturn ret;\r\n}\r\nreturn data & MAX8973_VOUT_MASK;\r\n}\r\nstatic int max8973_dcdc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned vsel)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nint ret;\r\nbool found = false;\r\nint vout_reg = max->curr_vout_reg;\r\nint gpio_val = max->curr_gpio_val;\r\nif (max->valid_dvs_gpio)\r\nfound = find_voltage_set_register(max, vsel,\r\n&vout_reg, &gpio_val);\r\nif (!found) {\r\nret = regmap_update_bits(max->regmap, vout_reg,\r\nMAX8973_VOUT_MASK, vsel);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d update failed, err %d\n",\r\nvout_reg, ret);\r\nreturn ret;\r\n}\r\nmax->curr_vout_reg = vout_reg;\r\nmax->curr_vout_val[gpio_val] = vsel;\r\n}\r\nif (max->valid_dvs_gpio) {\r\ngpio_set_value_cansleep(max->dvs_gpio, gpio_val & 0x1);\r\nmax->curr_gpio_val = gpio_val;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8973_dcdc_set_mode(struct regulator_dev *rdev, unsigned int mode)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nint ret;\r\nint pwm;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\npwm = MAX8973_FPWM_EN_M;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\npwm = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(max->regmap, MAX8973_CONTROL1,\r\nMAX8973_FPWM_EN_M, pwm);\r\nif (ret < 0)\r\ndev_err(max->dev, "register %d update failed, err %d\n",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nstatic unsigned int max8973_dcdc_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(max->regmap, MAX8973_CONTROL1, &data);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed, err %d\n",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nreturn (data & MAX8973_FPWM_EN_M) ?\r\nREGULATOR_MODE_FAST : REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int max8973_init_dcdc(struct max8973_chip *max,\r\nstruct max8973_regulator_platform_data *pdata)\r\n{\r\nint ret;\r\nuint8_t control1 = 0;\r\nuint8_t control2 = 0;\r\nif (pdata->control_flags & MAX8973_CONTROL_REMOTE_SENSE_ENABLE)\r\ncontrol1 |= MAX8973_SNS_ENABLE;\r\nif (!(pdata->control_flags & MAX8973_CONTROL_FALLING_SLEW_RATE_ENABLE))\r\ncontrol1 |= MAX8973_NFSR_ENABLE;\r\nif (pdata->control_flags & MAX8973_CONTROL_OUTPUT_ACTIVE_DISCH_ENABLE)\r\ncontrol1 |= MAX8973_AD_ENABLE;\r\nif (pdata->control_flags & MAX8973_CONTROL_BIAS_ENABLE)\r\ncontrol1 |= MAX8973_BIAS_ENABLE;\r\nif (pdata->control_flags & MAX8973_CONTROL_FREQ_SHIFT_9PER_ENABLE)\r\ncontrol1 |= MAX8973_FREQSHIFT_9PER;\r\nif (pdata->reg_init_data &&\r\npdata->reg_init_data->constraints.ramp_delay) {\r\nif (pdata->reg_init_data->constraints.ramp_delay < 25000)\r\ncontrol1 |= MAX8973_RAMP_12mV_PER_US;\r\nelse if (pdata->reg_init_data->constraints.ramp_delay < 50000)\r\ncontrol1 |= MAX8973_RAMP_25mV_PER_US;\r\nelse if (pdata->reg_init_data->constraints.ramp_delay < 200000)\r\ncontrol1 |= MAX8973_RAMP_50mV_PER_US;\r\nelse\r\ncontrol1 |= MAX8973_RAMP_200mV_PER_US;\r\n} else {\r\ncontrol1 |= MAX8973_RAMP_12mV_PER_US;\r\nmax->desc.ramp_delay = 12500;\r\n}\r\nif (!(pdata->control_flags & MAX8973_CONTROL_PULL_DOWN_ENABLE))\r\ncontrol2 |= MAX8973_DISCH_ENBABLE;\r\nswitch (pdata->control_flags & MAX8973_CONTROL_CLKADV_TRIP_MASK) {\r\ncase MAX8973_CONTROL_CLKADV_TRIP_DISABLED:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_DISABLE;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_75mV_PER_US:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_75mV_PER_US;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_150mV_PER_US:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_150mV_PER_US;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_75mV_PER_US_HIST_DIS:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_75mV_PER_US_HIST_DIS;\r\nbreak;\r\n}\r\nswitch (pdata->control_flags & MAX8973_CONTROL_INDUCTOR_VALUE_MASK) {\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_NOMINAL:\r\ncontrol2 |= MAX8973_INDUCTOR_NOMINAL;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_MINUS_30_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_MIN_30_PER;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_PLUS_30_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_PLUS_30_PER;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_PLUS_60_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_PLUS_60_PER;\r\nbreak;\r\n}\r\nret = regmap_write(max->regmap, MAX8973_CONTROL1, control1);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d write failed, err = %d",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nret = regmap_write(max->regmap, MAX8973_CONTROL2, control2);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d write failed, err = %d",\r\nMAX8973_CONTROL2, ret);\r\nreturn ret;\r\n}\r\nif (max->enable_external_control) {\r\nret = regmap_update_bits(max->regmap, MAX8973_VOUT,\r\nMAX8973_VOUT_ENABLE, 0);\r\nif (ret < 0)\r\ndev_err(max->dev, "register %d update failed, err = %d",\r\nMAX8973_VOUT, ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic int max8973_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8973_regulator_platform_data *pdata;\r\nstruct regulator_config config = { };\r\nstruct regulator_dev *rdev;\r\nstruct max8973_chip *max;\r\nint ret;\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata && !client->dev.of_node) {\r\ndev_err(&client->dev, "No Platform data");\r\nreturn -EIO;\r\n}\r\nmax = devm_kzalloc(&client->dev, sizeof(*max), GFP_KERNEL);\r\nif (!max)\r\nreturn -ENOMEM;\r\nmax->regmap = devm_regmap_init_i2c(client, &max8973_regmap_config);\r\nif (IS_ERR(max->regmap)) {\r\nret = PTR_ERR(max->regmap);\r\ndev_err(&client->dev, "regmap init failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, max);\r\nmax->ops = max8973_dcdc_ops;\r\nmax->dev = &client->dev;\r\nmax->desc.name = id->name;\r\nmax->desc.id = 0;\r\nmax->desc.ops = &max->ops;\r\nmax->desc.type = REGULATOR_VOLTAGE;\r\nmax->desc.owner = THIS_MODULE;\r\nmax->desc.min_uV = MAX8973_MIN_VOLATGE;\r\nmax->desc.uV_step = MAX8973_VOLATGE_STEP;\r\nmax->desc.n_voltages = MAX8973_BUCK_N_VOLTAGE;\r\nif (!pdata || !pdata->enable_ext_control) {\r\nmax->desc.enable_reg = MAX8973_VOUT;\r\nmax->desc.enable_mask = MAX8973_VOUT_ENABLE;\r\nmax->ops.enable = regulator_enable_regmap;\r\nmax->ops.disable = regulator_disable_regmap;\r\nmax->ops.is_enabled = regulator_is_enabled_regmap;\r\n}\r\nif (pdata) {\r\nmax->dvs_gpio = pdata->dvs_gpio;\r\nmax->enable_external_control = pdata->enable_ext_control;\r\nmax->curr_gpio_val = pdata->dvs_def_state;\r\nmax->curr_vout_reg = MAX8973_VOUT + pdata->dvs_def_state;\r\n} else {\r\nmax->dvs_gpio = -EINVAL;\r\nmax->curr_vout_reg = MAX8973_VOUT;\r\n}\r\nmax->lru_index[0] = max->curr_vout_reg;\r\nif (gpio_is_valid(max->dvs_gpio)) {\r\nint gpio_flags;\r\nint i;\r\ngpio_flags = (pdata->dvs_def_state) ?\r\nGPIOF_OUT_INIT_HIGH : GPIOF_OUT_INIT_LOW;\r\nret = devm_gpio_request_one(&client->dev, max->dvs_gpio,\r\ngpio_flags, "max8973-dvs");\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"gpio_request for gpio %d failed, err = %d\n",\r\nmax->dvs_gpio, ret);\r\nreturn ret;\r\n}\r\nmax->valid_dvs_gpio = true;\r\nfor (i = 0; i < MAX8973_MAX_VOUT_REG; ++i)\r\nmax->lru_index[i] = i;\r\nmax->lru_index[0] = max->curr_vout_reg;\r\nmax->lru_index[max->curr_vout_reg] = 0;\r\n} else {\r\nmax->valid_dvs_gpio = false;\r\n}\r\nif (pdata) {\r\nret = max8973_init_dcdc(max, pdata);\r\nif (ret < 0) {\r\ndev_err(max->dev, "Max8973 Init failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nconfig.dev = &client->dev;\r\nconfig.init_data = pdata ? pdata->reg_init_data :\r\nof_get_regulator_init_data(&client->dev, client->dev.of_node);\r\nconfig.driver_data = max;\r\nconfig.of_node = client->dev.of_node;\r\nconfig.regmap = max->regmap;\r\nrdev = devm_regulator_register(&client->dev, &max->desc, &config);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(max->dev, "regulator register failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init max8973_init(void)\r\n{\r\nreturn i2c_add_driver(&max8973_i2c_driver);\r\n}\r\nstatic void __exit max8973_cleanup(void)\r\n{\r\ni2c_del_driver(&max8973_i2c_driver);\r\n}

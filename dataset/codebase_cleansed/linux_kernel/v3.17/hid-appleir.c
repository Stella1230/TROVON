static int get_key(int data)\r\n{\r\nint key = (data >> 1) & KEY_MASK;\r\nif ((data & TWO_PACKETS_MASK))\r\nkey = -key;\r\nreturn key;\r\n}\r\nstatic void key_up(struct hid_device *hid, struct appleir *appleir, int key)\r\n{\r\ninput_report_key(appleir->input_dev, key, 0);\r\ninput_sync(appleir->input_dev);\r\n}\r\nstatic void key_down(struct hid_device *hid, struct appleir *appleir, int key)\r\n{\r\ninput_report_key(appleir->input_dev, key, 1);\r\ninput_sync(appleir->input_dev);\r\n}\r\nstatic void battery_flat(struct appleir *appleir)\r\n{\r\ndev_err(&appleir->input_dev->dev, "possible flat battery?\n");\r\n}\r\nstatic void key_up_tick(unsigned long data)\r\n{\r\nstruct appleir *appleir = (struct appleir *)data;\r\nstruct hid_device *hid = appleir->hid;\r\nunsigned long flags;\r\nspin_lock_irqsave(&appleir->lock, flags);\r\nif (appleir->current_key) {\r\nkey_up(hid, appleir, appleir->current_key);\r\nappleir->current_key = 0;\r\n}\r\nspin_unlock_irqrestore(&appleir->lock, flags);\r\n}\r\nstatic int appleir_raw_event(struct hid_device *hid, struct hid_report *report,\r\nu8 *data, int len)\r\n{\r\nstruct appleir *appleir = hid_get_drvdata(hid);\r\nstatic const u8 keydown[] = { 0x25, 0x87, 0xee };\r\nstatic const u8 keyrepeat[] = { 0x26, };\r\nstatic const u8 flatbattery[] = { 0x25, 0x87, 0xe0 };\r\nunsigned long flags;\r\nif (len != 5)\r\ngoto out;\r\nif (!memcmp(data, keydown, sizeof(keydown))) {\r\nint index;\r\nspin_lock_irqsave(&appleir->lock, flags);\r\nif (appleir->current_key)\r\nkey_up(hid, appleir, appleir->current_key);\r\nif (appleir->prev_key_idx > 0)\r\nindex = appleir->prev_key_idx;\r\nelse\r\nindex = get_key(data[4]);\r\nif (index >= 0) {\r\nappleir->current_key = appleir->keymap[index];\r\nkey_down(hid, appleir, appleir->current_key);\r\nmod_timer(&appleir->key_up_timer, jiffies + HZ / 8);\r\nappleir->prev_key_idx = 0;\r\n} else\r\nappleir->prev_key_idx = -index;\r\nspin_unlock_irqrestore(&appleir->lock, flags);\r\ngoto out;\r\n}\r\nappleir->prev_key_idx = 0;\r\nif (!memcmp(data, keyrepeat, sizeof(keyrepeat))) {\r\nkey_down(hid, appleir, appleir->current_key);\r\nmod_timer(&appleir->key_up_timer, jiffies + HZ / 8);\r\ngoto out;\r\n}\r\nif (!memcmp(data, flatbattery, sizeof(flatbattery))) {\r\nbattery_flat(appleir);\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nstatic void appleir_input_configured(struct hid_device *hid,\r\nstruct hid_input *hidinput)\r\n{\r\nstruct input_dev *input_dev = hidinput->input;\r\nstruct appleir *appleir = hid_get_drvdata(hid);\r\nint i;\r\nappleir->input_dev = input_dev;\r\ninput_dev->keycode = appleir->keymap;\r\ninput_dev->keycodesize = sizeof(unsigned short);\r\ninput_dev->keycodemax = ARRAY_SIZE(appleir->keymap);\r\ninput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\r\nmemcpy(appleir->keymap, appleir_key_table, sizeof(appleir->keymap));\r\nfor (i = 0; i < ARRAY_SIZE(appleir_key_table); i++)\r\nset_bit(appleir->keymap[i], input_dev->keybit);\r\nclear_bit(KEY_RESERVED, input_dev->keybit);\r\n}\r\nstatic int appleir_input_mapping(struct hid_device *hid,\r\nstruct hid_input *hi, struct hid_field *field,\r\nstruct hid_usage *usage, unsigned long **bit, int *max)\r\n{\r\nreturn -1;\r\n}\r\nstatic int appleir_probe(struct hid_device *hid, const struct hid_device_id *id)\r\n{\r\nint ret;\r\nstruct appleir *appleir;\r\nappleir = kzalloc(sizeof(struct appleir), GFP_KERNEL);\r\nif (!appleir) {\r\nret = -ENOMEM;\r\ngoto allocfail;\r\n}\r\nappleir->hid = hid;\r\nhid->quirks |= HID_QUIRK_HIDINPUT_FORCE;\r\nspin_lock_init(&appleir->lock);\r\nsetup_timer(&appleir->key_up_timer,\r\nkey_up_tick, (unsigned long) appleir);\r\nhid_set_drvdata(hid, appleir);\r\nret = hid_parse(hid);\r\nif (ret) {\r\nhid_err(hid, "parse failed\n");\r\ngoto fail;\r\n}\r\nret = hid_hw_start(hid, HID_CONNECT_DEFAULT | HID_CONNECT_HIDDEV_FORCE);\r\nif (ret) {\r\nhid_err(hid, "hw start failed\n");\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nkfree(appleir);\r\nallocfail:\r\nreturn ret;\r\n}\r\nstatic void appleir_remove(struct hid_device *hid)\r\n{\r\nstruct appleir *appleir = hid_get_drvdata(hid);\r\nhid_hw_stop(hid);\r\ndel_timer_sync(&appleir->key_up_timer);\r\nkfree(appleir);\r\n}

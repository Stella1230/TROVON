char *dbg_get_reg(int regno, void *mem, struct pt_regs *regs)\r\n{\r\nif (regno >= DBG_MAX_REG_NUM || regno < 0)\r\nreturn NULL;\r\n*((unsigned long *) mem) = *((unsigned long *) ((void *)regs +\r\ndbg_reg_def[regno].offset));\r\nreturn dbg_reg_def[regno].name;\r\n}\r\nint dbg_set_reg(int regno, void *mem, struct pt_regs *regs)\r\n{\r\nif (regno >= DBG_MAX_REG_NUM || regno < 0)\r\nreturn -EINVAL;\r\n*((unsigned long *) ((void *)regs + dbg_reg_def[regno].offset)) =\r\n*((unsigned long *) mem);\r\nreturn 0;\r\n}\r\nvoid kgdb_arch_set_pc(struct pt_regs *regs, unsigned long pc)\r\n{\r\ninstruction_pointer(regs) = pc;\r\n}\r\nstatic void hexagon_kgdb_nmi_hook(void *ignored)\r\n{\r\nkgdb_nmicallback(raw_smp_processor_id(), get_irq_regs());\r\n}\r\nvoid kgdb_roundup_cpus(unsigned long flags)\r\n{\r\nlocal_irq_enable();\r\nsmp_call_function(hexagon_kgdb_nmi_hook, NULL, 0);\r\nlocal_irq_disable();\r\n}\r\nvoid sleeping_thread_to_gdb_regs(unsigned long *gdb_regs,\r\nstruct task_struct *task)\r\n{\r\nstruct pt_regs *thread_regs;\r\nif (task == NULL)\r\nreturn;\r\nmemset(gdb_regs, 0, NUMREGBYTES);\r\nthread_regs = task_pt_regs(task);\r\ngdb_regs[0] = thread_regs->r00;\r\n}\r\nint kgdb_arch_handle_exception(int vector, int signo, int err_code,\r\nchar *remcom_in_buffer, char *remcom_out_buffer,\r\nstruct pt_regs *linux_regs)\r\n{\r\nswitch (remcom_in_buffer[0]) {\r\ncase 's':\r\ncase 'c':\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nstatic int __kgdb_notify(struct die_args *args, unsigned long cmd)\r\n{\r\nif (atomic_read(&kgdb_active) != -1) {\r\nkgdb_nmicallback(smp_processor_id(), args->regs);\r\nreturn NOTIFY_STOP;\r\n}\r\nif (user_mode(args->regs))\r\nreturn NOTIFY_DONE;\r\nif (kgdb_handle_exception(args->trapnr & 0xff, args->signr, args->err,\r\nargs->regs))\r\nreturn NOTIFY_DONE;\r\nreturn NOTIFY_STOP;\r\n}\r\nstatic int\r\nkgdb_notify(struct notifier_block *self, unsigned long cmd, void *ptr)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nlocal_irq_save(flags);\r\nret = __kgdb_notify(ptr, cmd);\r\nlocal_irq_restore(flags);\r\nreturn ret;\r\n}\r\nint kgdb_arch_init(void)\r\n{\r\nreturn register_die_notifier(&kgdb_notifier);\r\n}\r\nvoid kgdb_arch_exit(void)\r\n{\r\nunregister_die_notifier(&kgdb_notifier);\r\n}

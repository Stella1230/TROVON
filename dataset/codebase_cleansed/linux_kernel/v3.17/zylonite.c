static int zylonite_wm9713_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nif (clk_pout)\r\nsnd_soc_dai_set_pll(rtd->codec_dai, 0, 0,\r\nclk_get_rate(pout), 0);\r\nreturn 0;\r\n}\r\nstatic int zylonite_voice_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned int pll_out = 0;\r\nunsigned int wm9713_div = 0;\r\nint ret = 0;\r\nint rate = params_rate(params);\r\nint width = snd_pcm_format_physical_width(params_format(params));\r\nswitch (rate) {\r\ncase 8000:\r\nwm9713_div = 12;\r\nbreak;\r\ncase 16000:\r\nwm9713_div = 6;\r\nbreak;\r\ncase 48000:\r\nwm9713_div = 2;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\npll_out = rate * (width + 1) * 8;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, PXA_SSP_CLK_AUDIO, 0, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(cpu_dai, 0, 0, 0, pll_out);\r\nif (ret < 0)\r\nreturn ret;\r\nif (clk_pout)\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM9713_PCMCLK_PLL_DIV,\r\nWM9713_PCMDIV(wm9713_div));\r\nelse\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM9713_PCMCLK_DIV,\r\nWM9713_PCMDIV(wm9713_div));\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int zylonite_probe(struct snd_soc_card *card)\r\n{\r\nint ret;\r\nif (clk_pout) {\r\npout = clk_get(NULL, "CLK_POUT");\r\nif (IS_ERR(pout)) {\r\ndev_err(card->dev, "Unable to obtain CLK_POUT: %ld\n",\r\nPTR_ERR(pout));\r\nreturn PTR_ERR(pout);\r\n}\r\nret = clk_enable(pout);\r\nif (ret != 0) {\r\ndev_err(card->dev, "Unable to enable CLK_POUT: %d\n",\r\nret);\r\nclk_put(pout);\r\nreturn ret;\r\n}\r\ndev_dbg(card->dev, "MCLK enabled at %luHz\n",\r\nclk_get_rate(pout));\r\n}\r\nreturn 0;\r\n}\r\nstatic int zylonite_remove(struct snd_soc_card *card)\r\n{\r\nif (clk_pout) {\r\nclk_disable(pout);\r\nclk_put(pout);\r\n}\r\nreturn 0;\r\n}\r\nstatic int zylonite_suspend_post(struct snd_soc_card *card)\r\n{\r\nif (clk_pout)\r\nclk_disable(pout);\r\nreturn 0;\r\n}\r\nstatic int zylonite_resume_pre(struct snd_soc_card *card)\r\n{\r\nint ret = 0;\r\nif (clk_pout) {\r\nret = clk_enable(pout);\r\nif (ret != 0)\r\ndev_err(card->dev, "Unable to enable CLK_POUT: %d\n",\r\nret);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init zylonite_init(void)\r\n{\r\nint ret;\r\nzylonite_snd_ac97_device = platform_device_alloc("soc-audio", -1);\r\nif (!zylonite_snd_ac97_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(zylonite_snd_ac97_device, &zylonite);\r\nret = platform_device_add(zylonite_snd_ac97_device);\r\nif (ret != 0)\r\nplatform_device_put(zylonite_snd_ac97_device);\r\nreturn ret;\r\n}\r\nstatic void __exit zylonite_exit(void)\r\n{\r\nplatform_device_unregister(zylonite_snd_ac97_device);\r\n}

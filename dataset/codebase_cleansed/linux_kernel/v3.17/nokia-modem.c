static void do_nokia_modem_rst_ind_tasklet(unsigned long data)\r\n{\r\nstruct nokia_modem_device *modem = (struct nokia_modem_device *)data;\r\nif (!modem)\r\nreturn;\r\ndev_info(modem->device, "CMT rst line change detected\n");\r\nif (modem->ssi_protocol)\r\nssip_reset_event(modem->ssi_protocol);\r\n}\r\nstatic irqreturn_t nokia_modem_rst_ind_isr(int irq, void *data)\r\n{\r\nstruct nokia_modem_device *modem = (struct nokia_modem_device *)data;\r\ntasklet_schedule(&modem->nokia_modem_rst_ind_tasklet);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void nokia_modem_gpio_unexport(struct device *dev)\r\n{\r\nstruct nokia_modem_device *modem = dev_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < modem->gpio_amount; i++) {\r\nsysfs_remove_link(&dev->kobj, modem->gpios[i].name);\r\ngpiod_unexport(modem->gpios[i].gpio);\r\n}\r\n}\r\nstatic int nokia_modem_gpio_probe(struct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct nokia_modem_device *modem = dev_get_drvdata(dev);\r\nint gpio_count, gpio_name_count, i, err;\r\ngpio_count = of_gpio_count(np);\r\nif (gpio_count < 0) {\r\ndev_err(dev, "missing gpios: %d\n", gpio_count);\r\nreturn gpio_count;\r\n}\r\ngpio_name_count = of_property_count_strings(np, "gpio-names");\r\nif (gpio_count != gpio_name_count) {\r\ndev_err(dev, "number of gpios does not equal number of gpio names\n");\r\nreturn -EINVAL;\r\n}\r\nmodem->gpios = devm_kzalloc(dev, gpio_count *\r\nsizeof(struct nokia_modem_gpio), GFP_KERNEL);\r\nif (!modem->gpios) {\r\ndev_err(dev, "Could not allocate memory for gpios\n");\r\nreturn -ENOMEM;\r\n}\r\nmodem->gpio_amount = gpio_count;\r\nfor (i = 0; i < gpio_count; i++) {\r\nmodem->gpios[i].gpio = devm_gpiod_get_index(dev, NULL, i);\r\nif (IS_ERR(modem->gpios[i].gpio)) {\r\ndev_err(dev, "Could not get gpio %d\n", i);\r\nreturn PTR_ERR(modem->gpios[i].gpio);\r\n}\r\nerr = of_property_read_string_index(np, "gpio-names", i,\r\n&(modem->gpios[i].name));\r\nif (err) {\r\ndev_err(dev, "Could not get gpio name %d\n", i);\r\nreturn err;\r\n}\r\nerr = gpiod_direction_output(modem->gpios[i].gpio, 0);\r\nif (err)\r\nreturn err;\r\nerr = gpiod_export(modem->gpios[i].gpio, 0);\r\nif (err)\r\nreturn err;\r\nerr = gpiod_export_link(dev, modem->gpios[i].name,\r\nmodem->gpios[i].gpio);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nokia_modem_probe(struct device *dev)\r\n{\r\nstruct device_node *np;\r\nstruct nokia_modem_device *modem;\r\nstruct hsi_client *cl = to_hsi_client(dev);\r\nstruct hsi_port *port = hsi_get_port(cl);\r\nint irq, pflags, err;\r\nstruct hsi_board_info ssip;\r\nnp = dev->of_node;\r\nif (!np) {\r\ndev_err(dev, "device tree node not found\n");\r\nreturn -ENXIO;\r\n}\r\nmodem = devm_kzalloc(dev, sizeof(*modem), GFP_KERNEL);\r\nif (!modem) {\r\ndev_err(dev, "Could not allocate memory for nokia_modem_device\n");\r\nreturn -ENOMEM;\r\n}\r\ndev_set_drvdata(dev, modem);\r\nirq = irq_of_parse_and_map(np, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "Invalid rst_ind interrupt (%d)\n", irq);\r\nreturn irq;\r\n}\r\nmodem->nokia_modem_rst_ind_irq = irq;\r\npflags = irq_get_trigger_type(irq);\r\ntasklet_init(&modem->nokia_modem_rst_ind_tasklet,\r\ndo_nokia_modem_rst_ind_tasklet, (unsigned long)modem);\r\nerr = devm_request_irq(dev, irq, nokia_modem_rst_ind_isr,\r\nIRQF_DISABLED | pflags, "modem_rst_ind", modem);\r\nif (err < 0) {\r\ndev_err(dev, "Request rst_ind irq(%d) failed (flags %d)\n",\r\nirq, pflags);\r\nreturn err;\r\n}\r\nenable_irq_wake(irq);\r\nif(pm) {\r\nerr = nokia_modem_gpio_probe(dev);\r\nif (err < 0) {\r\ndev_err(dev, "Could not probe GPIOs\n");\r\ngoto error1;\r\n}\r\n}\r\nssip.name = "ssi-protocol";\r\nssip.tx_cfg = cl->tx_cfg;\r\nssip.rx_cfg = cl->rx_cfg;\r\nssip.platform_data = NULL;\r\nssip.archdata = NULL;\r\nmodem->ssi_protocol = hsi_new_client(port, &ssip);\r\nif (!modem->ssi_protocol) {\r\ndev_err(dev, "Could not register ssi-protocol device\n");\r\ngoto error2;\r\n}\r\nerr = device_attach(&modem->ssi_protocol->device);\r\nif (err == 0) {\r\ndev_err(dev, "Missing ssi-protocol driver\n");\r\nerr = -EPROBE_DEFER;\r\ngoto error3;\r\n} else if (err < 0) {\r\ndev_err(dev, "Could not load ssi-protocol driver (%d)\n", err);\r\ngoto error3;\r\n}\r\ndev_info(dev, "Registered Nokia HSI modem\n");\r\nreturn 0;\r\nerror3:\r\nhsi_remove_client(&modem->ssi_protocol->device, NULL);\r\nerror2:\r\nnokia_modem_gpio_unexport(dev);\r\nerror1:\r\ndisable_irq_wake(modem->nokia_modem_rst_ind_irq);\r\ntasklet_kill(&modem->nokia_modem_rst_ind_tasklet);\r\nreturn err;\r\n}\r\nstatic int nokia_modem_remove(struct device *dev)\r\n{\r\nstruct nokia_modem_device *modem = dev_get_drvdata(dev);\r\nif (!modem)\r\nreturn 0;\r\nif (modem->ssi_protocol) {\r\nhsi_remove_client(&modem->ssi_protocol->device, NULL);\r\nmodem->ssi_protocol = NULL;\r\n}\r\nnokia_modem_gpio_unexport(dev);\r\ndev_set_drvdata(dev, NULL);\r\ndisable_irq_wake(modem->nokia_modem_rst_ind_irq);\r\ntasklet_kill(&modem->nokia_modem_rst_ind_tasklet);\r\nreturn 0;\r\n}\r\nstatic int __init nokia_modem_init(void)\r\n{\r\nreturn hsi_register_client_driver(&nokia_modem_driver);\r\n}\r\nstatic void __exit nokia_modem_exit(void)\r\n{\r\nhsi_unregister_client_driver(&nokia_modem_driver);\r\n}

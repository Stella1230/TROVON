void mantis_event_cam_plugin(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 gpif_irqcfg;\r\nif (ca->slot_state == MODULE_XTRACTED) {\r\ndprintk(MANTIS_DEBUG, 1, "Event: CAM Plugged IN: Adapter(%d) Slot(0)", mantis->num);\r\nudelay(50);\r\nmmwrite(0xda000000, MANTIS_CARD_RESET);\r\ngpif_irqcfg = mmread(MANTIS_GPIF_IRQCFG);\r\ngpif_irqcfg |= MANTIS_MASK_PLUGOUT;\r\ngpif_irqcfg &= ~MANTIS_MASK_PLUGIN;\r\nmmwrite(gpif_irqcfg, MANTIS_GPIF_IRQCFG);\r\nudelay(500);\r\nca->slot_state = MODULE_INSERTED;\r\n}\r\nudelay(100);\r\n}\r\nvoid mantis_event_cam_unplug(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 gpif_irqcfg;\r\nif (ca->slot_state == MODULE_INSERTED) {\r\ndprintk(MANTIS_DEBUG, 1, "Event: CAM Unplugged: Adapter(%d) Slot(0)", mantis->num);\r\nudelay(50);\r\nmmwrite(0x00da0000, MANTIS_CARD_RESET);\r\ngpif_irqcfg = mmread(MANTIS_GPIF_IRQCFG);\r\ngpif_irqcfg |= MANTIS_MASK_PLUGIN;\r\ngpif_irqcfg &= ~MANTIS_MASK_PLUGOUT;\r\nmmwrite(gpif_irqcfg, MANTIS_GPIF_IRQCFG);\r\nudelay(500);\r\nca->slot_state = MODULE_XTRACTED;\r\n}\r\nudelay(100);\r\n}\r\nint mantis_pcmcia_init(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 gpif_stat, card_stat;\r\nmmwrite(mmread(MANTIS_INT_MASK) | MANTIS_INT_IRQ0, MANTIS_INT_MASK);\r\ngpif_stat = mmread(MANTIS_GPIF_STATUS);\r\ncard_stat = mmread(MANTIS_GPIF_IRQCFG);\r\nif (gpif_stat & MANTIS_GPIF_DETSTAT) {\r\ndprintk(MANTIS_DEBUG, 1, "CAM found on Adapter(%d) Slot(0)", mantis->num);\r\nmmwrite(card_stat | MANTIS_MASK_PLUGOUT, MANTIS_GPIF_IRQCFG);\r\nca->slot_state = MODULE_INSERTED;\r\ndvb_ca_en50221_camchange_irq(&ca->en50221,\r\n0,\r\nDVB_CA_EN50221_CAMCHANGE_INSERTED);\r\n} else {\r\ndprintk(MANTIS_DEBUG, 1, "Empty Slot on Adapter(%d) Slot(0)", mantis->num);\r\nmmwrite(card_stat | MANTIS_MASK_PLUGIN, MANTIS_GPIF_IRQCFG);\r\nca->slot_state = MODULE_XTRACTED;\r\ndvb_ca_en50221_camchange_irq(&ca->en50221,\r\n0,\r\nDVB_CA_EN50221_CAMCHANGE_REMOVED);\r\n}\r\nreturn 0;\r\n}\r\nvoid mantis_pcmcia_exit(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nmmwrite(mmread(MANTIS_GPIF_STATUS) & (~MANTIS_CARD_PLUGOUT | ~MANTIS_CARD_PLUGIN), MANTIS_GPIF_STATUS);\r\nmmwrite(mmread(MANTIS_INT_MASK) & ~MANTIS_INT_IRQ0, MANTIS_INT_MASK);\r\n}

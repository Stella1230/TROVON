static u16 tx4939ide_readw(void __iomem *base, u32 reg)\r\n{\r\nreturn __raw_readw(base + tx4939ide_swizzlew(reg));\r\n}\r\nstatic u8 tx4939ide_readb(void __iomem *base, u32 reg)\r\n{\r\nreturn __raw_readb(base + tx4939ide_swizzleb(reg));\r\n}\r\nstatic void tx4939ide_writel(u32 val, void __iomem *base, u32 reg)\r\n{\r\n__raw_writel(val, base + tx4939ide_swizzlel(reg));\r\n}\r\nstatic void tx4939ide_writew(u16 val, void __iomem *base, u32 reg)\r\n{\r\n__raw_writew(val, base + tx4939ide_swizzlew(reg));\r\n}\r\nstatic void tx4939ide_writeb(u8 val, void __iomem *base, u32 reg)\r\n{\r\n__raw_writeb(val, base + tx4939ide_swizzleb(reg));\r\n}\r\nstatic void tx4939ide_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nint is_slave = drive->dn;\r\nu32 mask, val;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nu8 safe = pio;\r\nide_drive_t *pair;\r\npair = ide_get_pair_dev(drive);\r\nif (pair)\r\nsafe = min_t(u8, safe, pair->pio_mode - XFER_PIO_0);\r\nmask = is_slave ? 0x07f00000 : 0x000007f0;\r\nval = ((safe << 8) | (pio << 4)) << (is_slave ? 16 : 0);\r\nhwif->select_data = (hwif->select_data & ~mask) | val;\r\n}\r\nstatic void tx4939ide_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nu32 mask, val;\r\nconst u8 mode = drive->dma_mode;\r\nif (mode >= XFER_UDMA_0)\r\nval = mode - XFER_UDMA_0 + 8;\r\nelse\r\nval = mode - XFER_MW_DMA_0 + 5;\r\nif (drive->dn) {\r\nmask = 0x00f00000;\r\nval <<= 20;\r\n} else {\r\nmask = 0x000000f0;\r\nval <<= 4;\r\n}\r\nhwif->select_data = (hwif->select_data & ~mask) | val;\r\n}\r\nstatic u16 tx4939ide_check_error_ints(ide_hwif_t *hwif)\r\n{\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu16 ctl = tx4939ide_readw(base, TX4939IDE_Int_Ctl);\r\nif (ctl & TX4939IDE_INT_BUSERR) {\r\nu16 sysctl = tx4939ide_readw(base, TX4939IDE_Sys_Ctl);\r\ntx4939ide_writew(sysctl | 0x4000, base, TX4939IDE_Sys_Ctl);\r\nmmiowb();\r\nndelay(270);\r\ntx4939ide_writew(sysctl, base, TX4939IDE_Sys_Ctl);\r\n}\r\nif (ctl & (TX4939IDE_INT_ADDRERR |\r\nTX4939IDE_INT_DEVTIMING | TX4939IDE_INT_BUSERR))\r\npr_err("%s: Error interrupt %#x (%s%s%s )\n",\r\nhwif->name, ctl,\r\nctl & TX4939IDE_INT_ADDRERR ? " Address-Error" : "",\r\nctl & TX4939IDE_INT_DEVTIMING ? " DEV-Timing" : "",\r\nctl & TX4939IDE_INT_BUSERR ? " Bus-Error" : "");\r\nreturn ctl;\r\n}\r\nstatic void tx4939ide_clear_irq(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif;\r\nvoid __iomem *base;\r\nu16 ctl;\r\nif (drive->waiting_for_dma)\r\nreturn;\r\nhwif = drive->hwif;\r\nbase = TX4939IDE_BASE(hwif);\r\nctl = tx4939ide_check_error_ints(hwif);\r\ntx4939ide_writew(ctl, base, TX4939IDE_Int_Ctl);\r\n}\r\nstatic u8 tx4939ide_cable_detect(ide_hwif_t *hwif)\r\n{\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nreturn tx4939ide_readw(base, TX4939IDE_Sys_Ctl) & 0x2000 ?\r\nATA_CBL_PATA40 : ATA_CBL_PATA80;\r\n}\r\nstatic void tx4939ide_dma_host_set(ide_drive_t *drive, int on)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu8 unit = drive->dn;\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu8 dma_stat = tx4939ide_readb(base, TX4939IDE_DMA_Stat);\r\nif (on)\r\ndma_stat |= (1 << (5 + unit));\r\nelse\r\ndma_stat &= ~(1 << (5 + unit));\r\ntx4939ide_writeb(dma_stat, base, TX4939IDE_DMA_Stat);\r\n}\r\nstatic u8 tx4939ide_clear_dma_status(void __iomem *base)\r\n{\r\nu8 dma_stat;\r\ndma_stat = tx4939ide_readb(base, TX4939IDE_DMA_Stat);\r\ntx4939ide_writeb(dma_stat | ATA_DMA_INTR | ATA_DMA_ERR, base,\r\nTX4939IDE_DMA_Stat);\r\ntx4939ide_writew(TX4939IDE_IGNORE_INTS << 8, base, TX4939IDE_Int_Ctl);\r\nreturn dma_stat;\r\n}\r\nstatic int tx4939ide_build_dmatable(ide_drive_t *drive, struct ide_cmd *cmd)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu32 *table = (u32 *)hwif->dmatable_cpu;\r\nunsigned int count = 0;\r\nint i;\r\nstruct scatterlist *sg;\r\nfor_each_sg(hwif->sg_table, sg, cmd->sg_nents, i) {\r\nu32 cur_addr, cur_len, bcount;\r\ncur_addr = sg_dma_address(sg);\r\ncur_len = sg_dma_len(sg);\r\nwhile (cur_len) {\r\nif (count++ >= PRD_ENTRIES)\r\ngoto use_pio_instead;\r\nbcount = 0x10000 - (cur_addr & 0xffff);\r\nif (bcount > cur_len)\r\nbcount = cur_len;\r\nif (bcount == 0x10000)\r\nbcount = 0x8000;\r\n*table++ = bcount & 0xffff;\r\n*table++ = cur_addr;\r\ncur_addr += bcount;\r\ncur_len -= bcount;\r\n}\r\n}\r\nif (count) {\r\n*(table - 2) |= 0x80000000;\r\nreturn count;\r\n}\r\nuse_pio_instead:\r\nprintk(KERN_ERR "%s: %s\n", drive->name,\r\ncount ? "DMA table too small" : "empty DMA table?");\r\nreturn 0;\r\n}\r\nstatic int tx4939ide_dma_setup(ide_drive_t *drive, struct ide_cmd *cmd)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu8 rw = (cmd->tf_flags & IDE_TFLAG_WRITE) ? 0 : ATA_DMA_WR;\r\nif (tx4939ide_build_dmatable(drive, cmd) == 0)\r\nreturn 1;\r\ntx4939ide_writel(hwif->dmatable_dma, base, TX4939IDE_PRD_Ptr);\r\ntx4939ide_writeb(rw, base, TX4939IDE_DMA_Cmd);\r\ntx4939ide_clear_dma_status(base);\r\ntx4939ide_writew(SECTOR_SIZE / 2, base, drive->dn ?\r\nTX4939IDE_Xfer_Cnt_2 : TX4939IDE_Xfer_Cnt_1);\r\ntx4939ide_writew(blk_rq_sectors(cmd->rq), base, TX4939IDE_Sec_Cnt);\r\nreturn 0;\r\n}\r\nstatic int tx4939ide_dma_end(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu8 dma_stat, dma_cmd;\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu16 ctl = tx4939ide_readw(base, TX4939IDE_Int_Ctl);\r\ndma_cmd = tx4939ide_readb(base, TX4939IDE_DMA_Cmd);\r\ntx4939ide_writeb(dma_cmd & ~ATA_DMA_START, base, TX4939IDE_DMA_Cmd);\r\ndma_stat = tx4939ide_clear_dma_status(base);\r\n#define CHECK_DMA_MASK (ATA_DMA_ACTIVE | ATA_DMA_ERR | ATA_DMA_INTR)\r\nif ((dma_stat & CHECK_DMA_MASK) == 0 &&\r\n(ctl & (TX4939IDE_INT_XFEREND | TX4939IDE_INT_HOST)) ==\r\n(TX4939IDE_INT_XFEREND | TX4939IDE_INT_HOST))\r\nreturn 0;\r\nreturn ((dma_stat & CHECK_DMA_MASK) !=\r\nATA_DMA_INTR) ? 0x10 | dma_stat : 0;\r\n}\r\nstatic int tx4939ide_dma_test_irq(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu16 ctl, ide_int;\r\nu8 dma_stat, stat;\r\nint found = 0;\r\nctl = tx4939ide_check_error_ints(hwif);\r\nide_int = ctl & (TX4939IDE_INT_XFEREND | TX4939IDE_INT_HOST);\r\nswitch (ide_int) {\r\ncase TX4939IDE_INT_HOST:\r\nstat = tx4939ide_readb(base, TX4939IDE_AltStat_DevCtl);\r\nif ((stat & (ATA_BUSY | ATA_DRQ | ATA_ERR)) == ATA_ERR)\r\nfound = 1;\r\nelse\r\nctl &= ~TX4939IDE_INT_XFEREND << 8;\r\nctl |= ide_int << 8;\r\nbreak;\r\ncase TX4939IDE_INT_HOST | TX4939IDE_INT_XFEREND:\r\ndma_stat = tx4939ide_readb(base, TX4939IDE_DMA_Stat);\r\nif (!(dma_stat & ATA_DMA_INTR))\r\npr_warning("%s: weird interrupt status. "\r\n"DMA_Stat %#02x int_ctl %#04x\n",\r\nhwif->name, dma_stat, ctl);\r\nfound = 1;\r\nbreak;\r\n}\r\nctl &= ~ide_int;\r\ntx4939ide_writew(ctl, base, TX4939IDE_Int_Ctl);\r\nreturn found;\r\n}\r\nstatic u8 tx4939ide_dma_sff_read_status(ide_hwif_t *hwif)\r\n{\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nreturn tx4939ide_readb(base, TX4939IDE_DMA_Stat);\r\n}\r\nstatic void tx4939ide_init_hwif(ide_hwif_t *hwif)\r\n{\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\ntx4939ide_writew(0x8000, base, TX4939IDE_Sys_Ctl);\r\nmmiowb();\r\nndelay(450);\r\ntx4939ide_writew(0x0000, base, TX4939IDE_Sys_Ctl);\r\ntx4939ide_writew((TX4939IDE_IGNORE_INTS << 8) | 0xff, base,\r\nTX4939IDE_Int_Ctl);\r\ntx4939ide_writew(0x0008, base, TX4939IDE_Lo_Burst_Cnt);\r\ntx4939ide_writew(0, base, TX4939IDE_Up_Burst_Cnt);\r\n}\r\nstatic int tx4939ide_init_dma(ide_hwif_t *hwif, const struct ide_port_info *d)\r\n{\r\nhwif->dma_base =\r\nhwif->extra_base + tx4939ide_swizzleb(TX4939IDE_DMA_Cmd);\r\nreturn ide_allocate_dma_engine(hwif);\r\n}\r\nstatic void tx4939ide_tf_load_fixup(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nvoid __iomem *base = TX4939IDE_BASE(hwif);\r\nu16 sysctl = hwif->select_data >> (drive->dn ? 16 : 0);\r\ntx4939ide_writew(sysctl, base, TX4939IDE_Sys_Ctl);\r\n}\r\nstatic void tx4939ide_tf_load(ide_drive_t *drive, struct ide_taskfile *tf,\r\nu8 valid)\r\n{\r\nide_tf_load(drive, tf, valid);\r\nif (valid & IDE_VALID_DEVICE)\r\ntx4939ide_tf_load_fixup(drive);\r\n}\r\nstatic void tx4939ide_input_data_swap(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long port = drive->hwif->io_ports.data_addr;\r\nunsigned short *ptr = buf;\r\nunsigned int count = (len + 1) / 2;\r\nwhile (count--)\r\n*ptr++ = cpu_to_le16(__raw_readw((void __iomem *)port));\r\n__ide_flush_dcache_range((unsigned long)buf, roundup(len, 2));\r\n}\r\nstatic void tx4939ide_output_data_swap(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long port = drive->hwif->io_ports.data_addr;\r\nunsigned short *ptr = buf;\r\nunsigned int count = (len + 1) / 2;\r\nwhile (count--) {\r\n__raw_writew(le16_to_cpu(*ptr), (void __iomem *)port);\r\nptr++;\r\n}\r\n__ide_flush_dcache_range((unsigned long)buf, roundup(len, 2));\r\n}\r\nstatic int __init tx4939ide_probe(struct platform_device *pdev)\r\n{\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nstruct ide_host *host;\r\nstruct resource *res;\r\nint irq, ret;\r\nunsigned long mapbase;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nif (!devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), "tx4938ide"))\r\nreturn -EBUSY;\r\nmapbase = (unsigned long)devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!mapbase)\r\nreturn -EBUSY;\r\nmemset(&hw, 0, sizeof(hw));\r\nhw.io_ports.data_addr =\r\nmapbase + tx4939ide_swizzlew(TX4939IDE_Data);\r\nhw.io_ports.error_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_Error_Feature);\r\nhw.io_ports.nsect_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_Sec);\r\nhw.io_ports.lbal_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_LBA0);\r\nhw.io_ports.lbam_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_LBA1);\r\nhw.io_ports.lbah_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_LBA2);\r\nhw.io_ports.device_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_DevHead);\r\nhw.io_ports.command_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_Stat_Cmd);\r\nhw.io_ports.ctl_addr =\r\nmapbase + tx4939ide_swizzleb(TX4939IDE_AltStat_DevCtl);\r\nhw.irq = irq;\r\nhw.dev = &pdev->dev;\r\npr_info("TX4939 IDE interface (base %#lx, irq %d)\n", mapbase, irq);\r\nhost = ide_host_alloc(&tx4939ide_port_info, hws, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\nhost->ports[0]->extra_base = mapbase;\r\nret = ide_host_register(host, &tx4939ide_port_info, hws);\r\nif (ret) {\r\nide_host_free(host);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nreturn 0;\r\n}\r\nstatic int __exit tx4939ide_remove(struct platform_device *pdev)\r\n{\r\nstruct ide_host *host = platform_get_drvdata(pdev);\r\nide_host_remove(host);\r\nreturn 0;\r\n}\r\nstatic int tx4939ide_resume(struct platform_device *dev)\r\n{\r\nstruct ide_host *host = platform_get_drvdata(dev);\r\nide_hwif_t *hwif = host->ports[0];\r\ntx4939ide_init_hwif(hwif);\r\nreturn 0;\r\n}

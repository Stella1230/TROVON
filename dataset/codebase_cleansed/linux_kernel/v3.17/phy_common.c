u32 rtl8723_phy_query_bb_reg(struct ieee80211_hw *hw,\r\nu32 regaddr, u32 bitmask)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 returnvalue, originalvalue, bitshift;\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"regaddr(%#x), bitmask(%#x)\n", regaddr, bitmask);\r\noriginalvalue = rtl_read_dword(rtlpriv, regaddr);\r\nbitshift = rtl8723_phy_calculate_bit_shift(bitmask);\r\nreturnvalue = (originalvalue & bitmask) >> bitshift;\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"BBR MASK = 0x%x Addr[0x%x]= 0x%x\n",\r\nbitmask, regaddr, originalvalue);\r\nreturn returnvalue;\r\n}\r\nvoid rtl8723_phy_set_bb_reg(struct ieee80211_hw *hw, u32 regaddr,\r\nu32 bitmask, u32 data)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 originalvalue, bitshift;\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"regaddr(%#x), bitmask(%#x), data(%#x)\n",\r\nregaddr, bitmask, data);\r\nif (bitmask != MASKDWORD) {\r\noriginalvalue = rtl_read_dword(rtlpriv, regaddr);\r\nbitshift = rtl8723_phy_calculate_bit_shift(bitmask);\r\ndata = ((originalvalue & (~bitmask)) | (data << bitshift));\r\n}\r\nrtl_write_dword(rtlpriv, regaddr, data);\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"regaddr(%#x), bitmask(%#x), data(%#x)\n",\r\nregaddr, bitmask, data);\r\n}\r\nu32 rtl8723_phy_calculate_bit_shift(u32 bitmask)\r\n{\r\nu32 i;\r\nfor (i = 0; i <= 31; i++) {\r\nif (((bitmask >> i) & 0x1) == 1)\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nu32 rtl8723_phy_rf_serial_read(struct ieee80211_hw *hw,\r\nenum radio_path rfpath, u32 offset)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct bb_reg_def *pphyreg = &rtlphy->phyreg_def[rfpath];\r\nu32 newoffset;\r\nu32 tmplong, tmplong2;\r\nu8 rfpi_enable = 0;\r\nu32 retvalue;\r\noffset &= 0xff;\r\nnewoffset = offset;\r\nif (RT_CANNOT_IO(hw)) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG, "return all one\n");\r\nreturn 0xFFFFFFFF;\r\n}\r\ntmplong = rtl_get_bbreg(hw, RFPGA0_XA_HSSIPARAMETER2, MASKDWORD);\r\nif (rfpath == RF90_PATH_A)\r\ntmplong2 = tmplong;\r\nelse\r\ntmplong2 = rtl_get_bbreg(hw, pphyreg->rfhssi_para2, MASKDWORD);\r\ntmplong2 = (tmplong2 & (~BLSSIREADADDRESS)) |\r\n(newoffset << 23) | BLSSIREADEDGE;\r\nrtl_set_bbreg(hw, RFPGA0_XA_HSSIPARAMETER2, MASKDWORD,\r\ntmplong & (~BLSSIREADEDGE));\r\nmdelay(1);\r\nrtl_set_bbreg(hw, pphyreg->rfhssi_para2, MASKDWORD, tmplong2);\r\nmdelay(2);\r\nif (rfpath == RF90_PATH_A)\r\nrfpi_enable = (u8) rtl_get_bbreg(hw, RFPGA0_XA_HSSIPARAMETER1,\r\nBIT(8));\r\nelse if (rfpath == RF90_PATH_B)\r\nrfpi_enable = (u8) rtl_get_bbreg(hw, RFPGA0_XB_HSSIPARAMETER1,\r\nBIT(8));\r\nif (rfpi_enable)\r\nretvalue = rtl_get_bbreg(hw, pphyreg->rf_rbpi,\r\nBLSSIREADBACKDATA);\r\nelse\r\nretvalue = rtl_get_bbreg(hw, pphyreg->rf_rb,\r\nBLSSIREADBACKDATA);\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"RFR-%d Addr[0x%x]= 0x%x\n",\r\nrfpath, pphyreg->rf_rb, retvalue);\r\nreturn retvalue;\r\n}\r\nvoid rtl8723_phy_rf_serial_write(struct ieee80211_hw *hw,\r\nenum radio_path rfpath,\r\nu32 offset, u32 data)\r\n{\r\nu32 data_and_addr;\r\nu32 newoffset;\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct bb_reg_def *pphyreg = &rtlphy->phyreg_def[rfpath];\r\nif (RT_CANNOT_IO(hw)) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG, "stop\n");\r\nreturn;\r\n}\r\noffset &= 0xff;\r\nnewoffset = offset;\r\ndata_and_addr = ((newoffset << 20) | (data & 0x000fffff)) & 0x0fffffff;\r\nrtl_set_bbreg(hw, pphyreg->rf3wire_offset, MASKDWORD, data_and_addr);\r\nRT_TRACE(rtlpriv, COMP_RF, DBG_TRACE,\r\n"RFW-%d Addr[0x%x]= 0x%x\n", rfpath,\r\npphyreg->rf3wire_offset, data_and_addr);\r\n}\r\nlong rtl8723_phy_txpwr_idx_to_dbm(struct ieee80211_hw *hw,\r\nenum wireless_mode wirelessmode,\r\nu8 txpwridx)\r\n{\r\nlong offset;\r\nlong pwrout_dbm;\r\nswitch (wirelessmode) {\r\ncase WIRELESS_MODE_B:\r\noffset = -7;\r\nbreak;\r\ncase WIRELESS_MODE_G:\r\ncase WIRELESS_MODE_N_24G:\r\ndefault:\r\noffset = -8;\r\nbreak;\r\n}\r\npwrout_dbm = txpwridx / 2 + offset;\r\nreturn pwrout_dbm;\r\n}\r\nvoid rtl8723_phy_init_bb_rf_reg_def(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nrtlphy->phyreg_def[RF90_PATH_A].rfintfs = RFPGA0_XAB_RFINTERFACESW;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfintfs = RFPGA0_XAB_RFINTERFACESW;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfintfs = RFPGA0_XCD_RFINTERFACESW;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfintfs = RFPGA0_XCD_RFINTERFACESW;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfintfi = RFPGA0_XAB_RFINTERFACERB;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfintfi = RFPGA0_XAB_RFINTERFACERB;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfintfi = RFPGA0_XCD_RFINTERFACERB;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfintfi = RFPGA0_XCD_RFINTERFACERB;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfintfo = RFPGA0_XA_RFINTERFACEOE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfintfo = RFPGA0_XB_RFINTERFACEOE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfintfe = RFPGA0_XA_RFINTERFACEOE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfintfe = RFPGA0_XB_RFINTERFACEOE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rf3wire_offset =\r\nRFPGA0_XA_LSSIPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_B].rf3wire_offset =\r\nRFPGA0_XB_LSSIPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_A].rflssi_select = rFPGA0_XAB_RFPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_B].rflssi_select = rFPGA0_XAB_RFPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_C].rflssi_select = rFPGA0_XCD_RFPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_D].rflssi_select = rFPGA0_XCD_RFPARAMETER;\r\nrtlphy->phyreg_def[RF90_PATH_A].rftxgain_stage = RFPGA0_TXGAINSTAGE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rftxgain_stage = RFPGA0_TXGAINSTAGE;\r\nrtlphy->phyreg_def[RF90_PATH_C].rftxgain_stage = RFPGA0_TXGAINSTAGE;\r\nrtlphy->phyreg_def[RF90_PATH_D].rftxgain_stage = RFPGA0_TXGAINSTAGE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfhssi_para1 = RFPGA0_XA_HSSIPARAMETER1;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfhssi_para1 = RFPGA0_XB_HSSIPARAMETER1;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfhssi_para2 = RFPGA0_XA_HSSIPARAMETER2;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfhssi_para2 = RFPGA0_XB_HSSIPARAMETER2;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfsw_ctrl = RFPGA0_XAB_SWITCHCONTROL;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfsw_ctrl = RFPGA0_XAB_SWITCHCONTROL;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfsw_ctrl = RFPGA0_XCD_SWITCHCONTROL;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfsw_ctrl = RFPGA0_XCD_SWITCHCONTROL;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfagc_control1 = ROFDM0_XAAGCCORE1;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfagc_control1 = ROFDM0_XBAGCCORE1;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfagc_control1 = ROFDM0_XCAGCCORE1;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfagc_control1 = ROFDM0_XDAGCCORE1;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfagc_control2 = ROFDM0_XAAGCCORE2;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfagc_control2 = ROFDM0_XBAGCCORE2;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfagc_control2 = ROFDM0_XCAGCCORE2;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfagc_control2 = ROFDM0_XDAGCCORE2;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfrxiq_imbal = ROFDM0_XARXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfrxiq_imbal = ROFDM0_XBRXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfrxiq_imbal = ROFDM0_XCRXIQIMBANLANCE;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfrxiq_imbal = ROFDM0_XDRXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rfrx_afe = ROFDM0_XARXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rfrx_afe = ROFDM0_XBRXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_C].rfrx_afe = ROFDM0_XCRXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_D].rfrx_afe = ROFDM0_XDRXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rftxiq_imbal = ROFDM0_XATXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rftxiq_imbal = ROFDM0_XBTXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_C].rftxiq_imbal = ROFDM0_XCTXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_D].rftxiq_imbal = ROFDM0_XDTXIQIMBALANCE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rftx_afe = ROFDM0_XATXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_B].rftx_afe = ROFDM0_XBTXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_C].rftx_afe = ROFDM0_XCTXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_D].rftx_afe = ROFDM0_XDTXAFE;\r\nrtlphy->phyreg_def[RF90_PATH_A].rf_rb = RFPGA0_XA_LSSIREADBACK;\r\nrtlphy->phyreg_def[RF90_PATH_B].rf_rb = RFPGA0_XB_LSSIREADBACK;\r\nrtlphy->phyreg_def[RF90_PATH_C].rf_rb = RFPGA0_XC_LSSIREADBACK;\r\nrtlphy->phyreg_def[RF90_PATH_D].rf_rb = RFPGA0_XD_LSSIREADBACK;\r\nrtlphy->phyreg_def[RF90_PATH_A].rf_rbpi = TRANSCEIVEA_HSPI_READBACK;\r\nrtlphy->phyreg_def[RF90_PATH_B].rf_rbpi = TRANSCEIVEB_HSPI_READBACK;\r\n}\r\nbool rtl8723_phy_set_sw_chnl_cmdarray(struct swchnlcmd *cmdtable,\r\nu32 cmdtableidx,\r\nu32 cmdtablesz,\r\nenum swchnlcmd_id cmdid,\r\nu32 para1, u32 para2,\r\nu32 msdelay)\r\n{\r\nstruct swchnlcmd *pcmd;\r\nif (cmdtable == NULL) {\r\nRT_ASSERT(false, "cmdtable cannot be NULL.\n");\r\nreturn false;\r\n}\r\nif (cmdtableidx >= cmdtablesz)\r\nreturn false;\r\npcmd = cmdtable + cmdtableidx;\r\npcmd->cmdid = cmdid;\r\npcmd->para1 = para1;\r\npcmd->para2 = para2;\r\npcmd->msdelay = msdelay;\r\nreturn true;\r\n}\r\nvoid rtl8723_phy_path_a_fill_iqk_matrix(struct ieee80211_hw *hw,\r\nbool iqk_ok,\r\nlong result[][8],\r\nu8 final_candidate,\r\nbool btxonly)\r\n{\r\nu32 oldval_0, x, tx0_a, reg;\r\nlong y, tx0_c;\r\nif (final_candidate == 0xFF) {\r\nreturn;\r\n} else if (iqk_ok) {\r\noldval_0 = (rtl_get_bbreg(hw, ROFDM0_XATXIQIMBALANCE,\r\nMASKDWORD) >> 22) & 0x3FF;\r\nx = result[final_candidate][0];\r\nif ((x & 0x00000200) != 0)\r\nx = x | 0xFFFFFC00;\r\ntx0_a = (x * oldval_0) >> 8;\r\nrtl_set_bbreg(hw, ROFDM0_XATXIQIMBALANCE, 0x3FF, tx0_a);\r\nrtl_set_bbreg(hw, ROFDM0_ECCATHRESHOLD, BIT(31),\r\n((x * oldval_0 >> 7) & 0x1));\r\ny = result[final_candidate][1];\r\nif ((y & 0x00000200) != 0)\r\ny = y | 0xFFFFFC00;\r\ntx0_c = (y * oldval_0) >> 8;\r\nrtl_set_bbreg(hw, ROFDM0_XCTXAFE, 0xF0000000,\r\n((tx0_c & 0x3C0) >> 6));\r\nrtl_set_bbreg(hw, ROFDM0_XATXIQIMBALANCE, 0x003F0000,\r\n(tx0_c & 0x3F));\r\nrtl_set_bbreg(hw, ROFDM0_ECCATHRESHOLD, BIT(29),\r\n((y * oldval_0 >> 7) & 0x1));\r\nif (btxonly)\r\nreturn;\r\nreg = result[final_candidate][2];\r\nrtl_set_bbreg(hw, ROFDM0_XARXIQIMBALANCE, 0x3FF, reg);\r\nreg = result[final_candidate][3] & 0x3F;\r\nrtl_set_bbreg(hw, ROFDM0_XARXIQIMBALANCE, 0xFC00, reg);\r\nreg = (result[final_candidate][3] >> 6) & 0xF;\r\nrtl_set_bbreg(hw, 0xca0, 0xF0000000, reg);\r\n}\r\n}\r\nvoid rtl8723_save_adda_registers(struct ieee80211_hw *hw, u32 *addareg,\r\nu32 *addabackup, u32 registernum)\r\n{\r\nu32 i;\r\nfor (i = 0; i < registernum; i++)\r\naddabackup[i] = rtl_get_bbreg(hw, addareg[i], MASKDWORD);\r\n}\r\nvoid rtl8723_phy_save_mac_registers(struct ieee80211_hw *hw,\r\nu32 *macreg, u32 *macbackup)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 i;\r\nfor (i = 0; i < (IQK_MAC_REG_NUM - 1); i++)\r\nmacbackup[i] = rtl_read_byte(rtlpriv, macreg[i]);\r\nmacbackup[i] = rtl_read_dword(rtlpriv, macreg[i]);\r\n}\r\nvoid rtl8723_phy_reload_adda_registers(struct ieee80211_hw *hw,\r\nu32 *addareg, u32 *addabackup,\r\nu32 regiesternum)\r\n{\r\nu32 i;\r\nfor (i = 0; i < regiesternum; i++)\r\nrtl_set_bbreg(hw, addareg[i], MASKDWORD, addabackup[i]);\r\n}\r\nvoid rtl8723_phy_reload_mac_registers(struct ieee80211_hw *hw,\r\nu32 *macreg, u32 *macbackup)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 i;\r\nfor (i = 0; i < (IQK_MAC_REG_NUM - 1); i++)\r\nrtl_write_byte(rtlpriv, macreg[i], (u8) macbackup[i]);\r\nrtl_write_dword(rtlpriv, macreg[i], macbackup[i]);\r\n}\r\nvoid rtl8723_phy_path_adda_on(struct ieee80211_hw *hw, u32 *addareg,\r\nbool is_patha_on, bool is2t)\r\n{\r\nu32 pathon;\r\nu32 i;\r\npathon = is_patha_on ? 0x04db25a4 : 0x0b1b25a4;\r\nif (!is2t) {\r\npathon = 0x0bdb25a0;\r\nrtl_set_bbreg(hw, addareg[0], MASKDWORD, 0x0b1b25a0);\r\n} else {\r\nrtl_set_bbreg(hw, addareg[0], MASKDWORD, pathon);\r\n}\r\nfor (i = 1; i < IQK_ADDA_REG_NUM; i++)\r\nrtl_set_bbreg(hw, addareg[i], MASKDWORD, pathon);\r\n}\r\nvoid rtl8723_phy_mac_setting_calibration(struct ieee80211_hw *hw,\r\nu32 *macreg, u32 *macbackup)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 i = 0;\r\nrtl_write_byte(rtlpriv, macreg[i], 0x3F);\r\nfor (i = 1; i < (IQK_MAC_REG_NUM - 1); i++)\r\nrtl_write_byte(rtlpriv, macreg[i],\r\n(u8) (macbackup[i] & (~BIT(3))));\r\nrtl_write_byte(rtlpriv, macreg[i], (u8) (macbackup[i] & (~BIT(5))));\r\n}\r\nvoid rtl8723_phy_path_a_standby(struct ieee80211_hw *hw)\r\n{\r\nrtl_set_bbreg(hw, 0xe28, MASKDWORD, 0x0);\r\nrtl_set_bbreg(hw, 0x840, MASKDWORD, 0x00010000);\r\nrtl_set_bbreg(hw, 0xe28, MASKDWORD, 0x80800000);\r\n}\r\nvoid rtl8723_phy_pi_mode_switch(struct ieee80211_hw *hw, bool pi_mode)\r\n{\r\nu32 mode;\r\nmode = pi_mode ? 0x01000100 : 0x01000000;\r\nrtl_set_bbreg(hw, 0x820, MASKDWORD, mode);\r\nrtl_set_bbreg(hw, 0x828, MASKDWORD, mode);\r\n}

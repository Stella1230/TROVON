static void intelfb_gpio_setscl(void *data, int state)\r\n{\r\nstruct intelfb_i2c_chan *chan = data;\r\nstruct intelfb_info *dinfo = chan->dinfo;\r\nu32 val;\r\nOUTREG(chan->reg, (state ? SCL_VAL_OUT : 0) |\r\nSCL_DIR | SCL_DIR_MASK | SCL_VAL_MASK);\r\nval = INREG(chan->reg);\r\n}\r\nstatic void intelfb_gpio_setsda(void *data, int state)\r\n{\r\nstruct intelfb_i2c_chan *chan = data;\r\nstruct intelfb_info *dinfo = chan->dinfo;\r\nu32 val;\r\nOUTREG(chan->reg, (state ? SDA_VAL_OUT : 0) |\r\nSDA_DIR | SDA_DIR_MASK | SDA_VAL_MASK);\r\nval = INREG(chan->reg);\r\n}\r\nstatic int intelfb_gpio_getscl(void *data)\r\n{\r\nstruct intelfb_i2c_chan *chan = data;\r\nstruct intelfb_info *dinfo = chan->dinfo;\r\nu32 val;\r\nOUTREG(chan->reg, SCL_DIR_MASK);\r\nOUTREG(chan->reg, 0);\r\nval = INREG(chan->reg);\r\nreturn ((val & SCL_VAL_IN) != 0);\r\n}\r\nstatic int intelfb_gpio_getsda(void *data)\r\n{\r\nstruct intelfb_i2c_chan *chan = data;\r\nstruct intelfb_info *dinfo = chan->dinfo;\r\nu32 val;\r\nOUTREG(chan->reg, SDA_DIR_MASK);\r\nOUTREG(chan->reg, 0);\r\nval = INREG(chan->reg);\r\nreturn ((val & SDA_VAL_IN) != 0);\r\n}\r\nstatic int intelfb_setup_i2c_bus(struct intelfb_info *dinfo,\r\nstruct intelfb_i2c_chan *chan,\r\nconst u32 reg, const char *name,\r\nint class)\r\n{\r\nint rc;\r\nchan->dinfo = dinfo;\r\nchan->reg = reg;\r\nsnprintf(chan->adapter.name, sizeof(chan->adapter.name),\r\n"intelfb %s", name);\r\nchan->adapter.class = class;\r\nchan->adapter.owner = THIS_MODULE;\r\nchan->adapter.algo_data = &chan->algo;\r\nchan->adapter.dev.parent = &chan->dinfo->pdev->dev;\r\nchan->algo.setsda = intelfb_gpio_setsda;\r\nchan->algo.setscl = intelfb_gpio_setscl;\r\nchan->algo.getsda = intelfb_gpio_getsda;\r\nchan->algo.getscl = intelfb_gpio_getscl;\r\nchan->algo.udelay = 40;\r\nchan->algo.timeout = 20;\r\nchan->algo.data = chan;\r\ni2c_set_adapdata(&chan->adapter, chan);\r\nintelfb_gpio_setsda(chan, 1);\r\nintelfb_gpio_setscl(chan, 1);\r\nudelay(20);\r\nrc = i2c_bit_add_bus(&chan->adapter);\r\nif (rc == 0)\r\nDBG_MSG("I2C bus %s registered.\n", name);\r\nelse\r\nWRN_MSG("Failed to register I2C bus %s.\n", name);\r\nreturn rc;\r\n}\r\nvoid intelfb_create_i2c_busses(struct intelfb_info *dinfo)\r\n{\r\nint i = 0;\r\ndinfo->num_outputs = 1;\r\ndinfo->output[i].type = INTELFB_OUTPUT_ANALOG;\r\nintelfb_setup_i2c_bus(dinfo, &dinfo->output[i].ddc_bus, GPIOA,\r\n"CRTDDC_A", I2C_CLASS_DDC);\r\ni++;\r\nswitch(dinfo->chipset) {\r\ncase INTEL_830M:\r\ncase INTEL_845G:\r\ncase INTEL_854:\r\ncase INTEL_855GM:\r\ncase INTEL_865G:\r\ndinfo->output[i].type = INTELFB_OUTPUT_DVO;\r\nintelfb_setup_i2c_bus(dinfo, &dinfo->output[i].ddc_bus,\r\nGPIOD, "DVODDC_D", I2C_CLASS_DDC);\r\nintelfb_setup_i2c_bus(dinfo, &dinfo->output[i].i2c_bus,\r\nGPIOE, "DVOI2C_E", 0);\r\ni++;\r\nbreak;\r\ncase INTEL_915G:\r\ncase INTEL_915GM:\r\ncase INTEL_945G:\r\ncase INTEL_945GM:\r\ncase INTEL_945GME:\r\ncase INTEL_965G:\r\ncase INTEL_965GM:\r\ndinfo->output[i].type = INTELFB_OUTPUT_SDVO;\r\nintelfb_setup_i2c_bus(dinfo, &dinfo->output[i].i2c_bus,\r\nGPIOE, "SDVOCTRL_E", 0);\r\ni++;\r\ndinfo->output[i].type = INTELFB_OUTPUT_SDVO;\r\ndinfo->output[i].i2c_bus = dinfo->output[i - 1].i2c_bus;\r\ni++;\r\nbreak;\r\n}\r\ndinfo->num_outputs = i;\r\n}\r\nvoid intelfb_delete_i2c_busses(struct intelfb_info *dinfo)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_OUTPUTS; i++) {\r\nif (dinfo->output[i].i2c_bus.dinfo) {\r\ni2c_del_adapter(&dinfo->output[i].i2c_bus.adapter);\r\ndinfo->output[i].i2c_bus.dinfo = NULL;\r\n}\r\nif (dinfo->output[i].ddc_bus.dinfo) {\r\ni2c_del_adapter(&dinfo->output[i].ddc_bus.adapter);\r\ndinfo->output[i].ddc_bus.dinfo = NULL;\r\n}\r\n}\r\n}

static int addi_watchdog_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_watchdog_private *spriv = s->private;\r\nunsigned int reload;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_ARM:\r\nspriv->wdog_ctrl = ADDI_WDOG_CTRL_ENABLE;\r\nreload = data[1] & s->maxdata;\r\noutl(reload, spriv->iobase + ADDI_WDOG_RELOAD_REG);\r\ndev_info(dev->class_dev, "watchdog enabled, timeout:%dms\n",\r\n20 * reload + 20);\r\nbreak;\r\ncase INSN_CONFIG_DISARM:\r\nspriv->wdog_ctrl = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\noutl(spriv->wdog_ctrl, spriv->iobase + ADDI_WDOG_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int addi_watchdog_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_watchdog_private *spriv = s->private;\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = inl(spriv->iobase + ADDI_WDOG_STATUS_REG);\r\nreturn insn->n;\r\n}\r\nstatic int addi_watchdog_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_watchdog_private *spriv = s->private;\r\nint i;\r\nif (spriv->wdog_ctrl == 0) {\r\ndev_warn(dev->class_dev, "watchdog is disabled\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < insn->n; i++) {\r\noutl(spriv->wdog_ctrl | ADDI_WDOG_CTRL_SW_TRIG,\r\nspriv->iobase + ADDI_WDOG_CTRL_REG);\r\n}\r\nreturn insn->n;\r\n}\r\nvoid addi_watchdog_reset(unsigned long iobase)\r\n{\r\noutl(0x0, iobase + ADDI_WDOG_CTRL_REG);\r\noutl(0x0, iobase + ADDI_WDOG_RELOAD_REG);\r\n}\r\nint addi_watchdog_init(struct comedi_subdevice *s, unsigned long iobase)\r\n{\r\nstruct addi_watchdog_private *spriv;\r\nspriv = comedi_alloc_spriv(s, sizeof(*spriv));\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nspriv->iobase = iobase;\r\ns->type = COMEDI_SUBD_TIMER;\r\ns->subdev_flags = SDF_WRITEABLE;\r\ns->n_chan = 1;\r\ns->maxdata = 0xff;\r\ns->insn_config = addi_watchdog_insn_config;\r\ns->insn_read = addi_watchdog_insn_read;\r\ns->insn_write = addi_watchdog_insn_write;\r\nreturn 0;\r\n}\r\nstatic int __init addi_watchdog_module_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit addi_watchdog_module_exit(void)\r\n{\r\n}

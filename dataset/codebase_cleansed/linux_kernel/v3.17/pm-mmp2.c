int mmp2_set_wake(struct irq_data *d, unsigned int on)\r\n{\r\nunsigned long data = 0;\r\nint irq = d->irq;\r\nswitch (irq) {\r\ncase IRQ_MMP2_RTC:\r\ncase IRQ_MMP2_RTC_ALARM:\r\ndata = MPMU_WUCRM_PJ_WAKEUP(4) | MPMU_WUCRM_PJ_RTC_ALARM;\r\nbreak;\r\ncase IRQ_MMP2_PMIC:\r\ndata = MPMU_WUCRM_PJ_WAKEUP(7);\r\nbreak;\r\ncase IRQ_MMP2_MMC2:\r\ndata = MPMU_WUCRM_PJ_WAKEUP(2);\r\nbreak;\r\n}\r\nif (on) {\r\nif (data) {\r\ndata |= __raw_readl(MPMU_WUCRM_PJ);\r\n__raw_writel(data, MPMU_WUCRM_PJ);\r\n}\r\n} else {\r\nif (data) {\r\ndata = ~data & __raw_readl(MPMU_WUCRM_PJ);\r\n__raw_writel(data, MPMU_WUCRM_PJ);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void pm_scu_clk_disable(void)\r\n{\r\nunsigned int val;\r\n__raw_writel(0x0, CIU_REG(0x64));\r\n__raw_writel(0x0, CIU_REG(0x68));\r\nval = __raw_readl(CIU_REG(0x1c));\r\nval |= 0xf0;\r\n__raw_writel(val, CIU_REG(0x1c));\r\nreturn ;\r\n}\r\nstatic void pm_scu_clk_enable(void)\r\n{\r\nunsigned int val;\r\n__raw_writel(0x03003003, CIU_REG(0x64));\r\n__raw_writel(0x00303030, CIU_REG(0x68));\r\nval = __raw_readl(CIU_REG(0x1c));\r\nval &= ~(0xf0);\r\n__raw_writel(val, CIU_REG(0x1c));\r\nreturn ;\r\n}\r\nstatic void pm_mpmu_clk_disable(void)\r\n{\r\n__raw_writel(0x0000a010, MPMU_CGR_PJ);\r\n}\r\nstatic void pm_mpmu_clk_enable(void)\r\n{\r\nunsigned int val;\r\n__raw_writel(0xdffefffe, MPMU_CGR_PJ);\r\nval = __raw_readl(MPMU_PLL2_CTRL1);\r\nval |= (1 << 29);\r\n__raw_writel(val, MPMU_PLL2_CTRL1);\r\nreturn ;\r\n}\r\nvoid mmp2_pm_enter_lowpower_mode(int state)\r\n{\r\nuint32_t idle_cfg, apcr;\r\nidle_cfg = __raw_readl(APMU_PJ_IDLE_CFG);\r\napcr = __raw_readl(MPMU_PCR_PJ);\r\napcr &= ~(MPMU_PCR_PJ_SLPEN | MPMU_PCR_PJ_DDRCORSD | MPMU_PCR_PJ_APBSD\r\n| MPMU_PCR_PJ_AXISD | MPMU_PCR_PJ_VCTCXOSD | (1 << 13));\r\nidle_cfg &= ~APMU_PJ_IDLE_CFG_PJ_IDLE;\r\nswitch (state) {\r\ncase POWER_MODE_SYS_SLEEP:\r\napcr |= MPMU_PCR_PJ_SLPEN;\r\napcr |= MPMU_PCR_PJ_VCTCXOSD;\r\ncase POWER_MODE_CHIP_SLEEP:\r\napcr |= MPMU_PCR_PJ_SLPEN;\r\ncase POWER_MODE_APPS_SLEEP:\r\napcr |= MPMU_PCR_PJ_APBSD;\r\ncase POWER_MODE_APPS_IDLE:\r\napcr |= MPMU_PCR_PJ_AXISD;\r\napcr |= MPMU_PCR_PJ_DDRCORSD;\r\nidle_cfg |= APMU_PJ_IDLE_CFG_PJ_PWRDWN;\r\napcr |= MPMU_PCR_PJ_SPSD;\r\ncase POWER_MODE_CORE_EXTIDLE:\r\nidle_cfg |= APMU_PJ_IDLE_CFG_PJ_IDLE;\r\nidle_cfg &= ~APMU_PJ_IDLE_CFG_ISO_MODE_CNTRL_MASK;\r\nidle_cfg |= APMU_PJ_IDLE_CFG_PWR_SW(3)\r\n| APMU_PJ_IDLE_CFG_L2_PWR_SW;\r\nbreak;\r\ncase POWER_MODE_CORE_INTIDLE:\r\napcr &= ~MPMU_PCR_PJ_SPSD;\r\nbreak;\r\n}\r\napcr |= (1 << 30) | (1 << 25);\r\n__raw_writel(idle_cfg, APMU_PJ_IDLE_CFG);\r\n__raw_writel(apcr, MPMU_PCR_PJ);\r\n}\r\nstatic int mmp2_pm_enter(suspend_state_t state)\r\n{\r\nint temp;\r\ntemp = __raw_readl(MMP2_ICU_INT4_MASK);\r\nif (temp & (1 << 1)) {\r\nprintk(KERN_ERR "%s: PMIC interrupt is handling\n", __func__);\r\nreturn -EAGAIN;\r\n}\r\ntemp = __raw_readl(APMU_SRAM_PWR_DWN);\r\ntemp |= ((1 << 19) | (1 << 18));\r\n__raw_writel(temp, APMU_SRAM_PWR_DWN);\r\npm_mpmu_clk_disable();\r\npm_scu_clk_disable();\r\nprintk(KERN_INFO "%s: before suspend\n", __func__);\r\ncpu_do_idle();\r\nprintk(KERN_INFO "%s: after suspend\n", __func__);\r\npm_mpmu_clk_enable();\r\npm_scu_clk_enable();\r\nreturn 0;\r\n}\r\nstatic int mmp2_pm_prepare(void)\r\n{\r\nmmp2_pm_enter_lowpower_mode(POWER_MODE_SYS_SLEEP);\r\nreturn 0;\r\n}\r\nstatic void mmp2_pm_finish(void)\r\n{\r\nmmp2_pm_enter_lowpower_mode(POWER_MODE_CORE_INTIDLE);\r\n}\r\nstatic int mmp2_pm_valid(suspend_state_t state)\r\n{\r\nreturn ((state == PM_SUSPEND_STANDBY) || (state == PM_SUSPEND_MEM));\r\n}\r\nstatic int __init mmp2_pm_init(void)\r\n{\r\nuint32_t apcr;\r\nif (!cpu_is_mmp2())\r\nreturn -EIO;\r\nsuspend_set_ops(&mmp2_pm_ops);\r\n__raw_writel(0x5, MPMU_SCCR);\r\n__raw_writel(__raw_readl(CIU_REG(0x8)) & ~(0x1 << 23), CIU_REG(0x8));\r\napcr = __raw_readl(MPMU_PCR_PJ);\r\napcr &= ~(MPMU_PCR_PJ_SLPEN | MPMU_PCR_PJ_DDRCORSD\r\n| MPMU_PCR_PJ_APBSD | MPMU_PCR_PJ_AXISD | 1 << 13);\r\n__raw_writel(apcr, MPMU_PCR_PJ);\r\nreturn 0;\r\n}

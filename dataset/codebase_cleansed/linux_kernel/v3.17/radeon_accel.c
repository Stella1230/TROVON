static void radeon_fixup_offset(struct radeonfb_info *rinfo)\r\n{\r\nu32 local_base;\r\nradeon_fifo_wait (1);\r\nlocal_base = INREG(MC_FB_LOCATION) << 16;\r\nif (local_base == rinfo->fb_local_base)\r\nreturn;\r\nrinfo->fb_local_base = local_base;\r\nradeon_fifo_wait (3);\r\nOUTREG(DEFAULT_PITCH_OFFSET, (rinfo->pitch << 0x16) |\r\n(rinfo->fb_local_base >> 10));\r\nOUTREG(DST_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\r\nOUTREG(SRC_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\r\n}\r\nstatic void radeonfb_prim_fillrect(struct radeonfb_info *rinfo,\r\nconst struct fb_fillrect *region)\r\n{\r\nradeon_fifo_wait(4);\r\nOUTREG(DP_GUI_MASTER_CNTL,\r\nrinfo->dp_gui_master_cntl\r\n| GMC_BRUSH_SOLID_COLOR\r\n| ROP3_P);\r\nif (radeon_get_dstbpp(rinfo->depth) != DST_8BPP)\r\nOUTREG(DP_BRUSH_FRGD_CLR, rinfo->pseudo_palette[region->color]);\r\nelse\r\nOUTREG(DP_BRUSH_FRGD_CLR, region->color);\r\nOUTREG(DP_WRITE_MSK, 0xffffffff);\r\nOUTREG(DP_CNTL, (DST_X_LEFT_TO_RIGHT | DST_Y_TOP_TO_BOTTOM));\r\nradeon_fifo_wait(2);\r\nOUTREG(DSTCACHE_CTLSTAT, RB2D_DC_FLUSH_ALL);\r\nOUTREG(WAIT_UNTIL, (WAIT_2D_IDLECLEAN | WAIT_DMA_GUI_IDLE));\r\nradeon_fifo_wait(2);\r\nOUTREG(DST_Y_X, (region->dy << 16) | region->dx);\r\nOUTREG(DST_WIDTH_HEIGHT, (region->width << 16) | region->height);\r\n}\r\nvoid radeonfb_fillrect(struct fb_info *info, const struct fb_fillrect *region)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nstruct fb_fillrect modded;\r\nint vxres, vyres;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif (info->flags & FBINFO_HWACCEL_DISABLED) {\r\ncfb_fillrect(info, region);\r\nreturn;\r\n}\r\nradeon_fixup_offset(rinfo);\r\nvxres = info->var.xres_virtual;\r\nvyres = info->var.yres_virtual;\r\nmemcpy(&modded, region, sizeof(struct fb_fillrect));\r\nif(!modded.width || !modded.height ||\r\nmodded.dx >= vxres || modded.dy >= vyres)\r\nreturn;\r\nif(modded.dx + modded.width > vxres) modded.width = vxres - modded.dx;\r\nif(modded.dy + modded.height > vyres) modded.height = vyres - modded.dy;\r\nradeonfb_prim_fillrect(rinfo, &modded);\r\n}\r\nstatic void radeonfb_prim_copyarea(struct radeonfb_info *rinfo,\r\nconst struct fb_copyarea *area)\r\n{\r\nint xdir, ydir;\r\nu32 sx, sy, dx, dy, w, h;\r\nw = area->width; h = area->height;\r\ndx = area->dx; dy = area->dy;\r\nsx = area->sx; sy = area->sy;\r\nxdir = sx - dx;\r\nydir = sy - dy;\r\nif ( xdir < 0 ) { sx += w-1; dx += w-1; }\r\nif ( ydir < 0 ) { sy += h-1; dy += h-1; }\r\nradeon_fifo_wait(3);\r\nOUTREG(DP_GUI_MASTER_CNTL,\r\nrinfo->dp_gui_master_cntl\r\n| GMC_BRUSH_NONE\r\n| GMC_SRC_DSTCOLOR\r\n| ROP3_S\r\n| DP_SRC_SOURCE_MEMORY );\r\nOUTREG(DP_WRITE_MSK, 0xffffffff);\r\nOUTREG(DP_CNTL, (xdir>=0 ? DST_X_LEFT_TO_RIGHT : 0)\r\n| (ydir>=0 ? DST_Y_TOP_TO_BOTTOM : 0));\r\nradeon_fifo_wait(2);\r\nOUTREG(DSTCACHE_CTLSTAT, RB2D_DC_FLUSH_ALL);\r\nOUTREG(WAIT_UNTIL, (WAIT_2D_IDLECLEAN | WAIT_DMA_GUI_IDLE));\r\nradeon_fifo_wait(3);\r\nOUTREG(SRC_Y_X, (sy << 16) | sx);\r\nOUTREG(DST_Y_X, (dy << 16) | dx);\r\nOUTREG(DST_HEIGHT_WIDTH, (h << 16) | w);\r\n}\r\nvoid radeonfb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nstruct fb_copyarea modded;\r\nu32 vxres, vyres;\r\nmodded.sx = area->sx;\r\nmodded.sy = area->sy;\r\nmodded.dx = area->dx;\r\nmodded.dy = area->dy;\r\nmodded.width = area->width;\r\nmodded.height = area->height;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif (info->flags & FBINFO_HWACCEL_DISABLED) {\r\ncfb_copyarea(info, area);\r\nreturn;\r\n}\r\nradeon_fixup_offset(rinfo);\r\nvxres = info->var.xres_virtual;\r\nvyres = info->var.yres_virtual;\r\nif(!modded.width || !modded.height ||\r\nmodded.sx >= vxres || modded.sy >= vyres ||\r\nmodded.dx >= vxres || modded.dy >= vyres)\r\nreturn;\r\nif(modded.sx + modded.width > vxres) modded.width = vxres - modded.sx;\r\nif(modded.dx + modded.width > vxres) modded.width = vxres - modded.dx;\r\nif(modded.sy + modded.height > vyres) modded.height = vyres - modded.sy;\r\nif(modded.dy + modded.height > vyres) modded.height = vyres - modded.dy;\r\nradeonfb_prim_copyarea(rinfo, &modded);\r\n}\r\nvoid radeonfb_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nradeon_engine_idle();\r\ncfb_imageblit(info, image);\r\n}\r\nint radeonfb_sync(struct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn 0;\r\nradeon_engine_idle();\r\nreturn 0;\r\n}\r\nvoid radeonfb_engine_reset(struct radeonfb_info *rinfo)\r\n{\r\nu32 clock_cntl_index, mclk_cntl, rbbm_soft_reset;\r\nu32 host_path_cntl;\r\nradeon_engine_flush (rinfo);\r\nclock_cntl_index = INREG(CLOCK_CNTL_INDEX);\r\nmclk_cntl = INPLL(MCLK_CNTL);\r\nOUTPLL(MCLK_CNTL, (mclk_cntl |\r\nFORCEON_MCLKA |\r\nFORCEON_MCLKB |\r\nFORCEON_YCLKA |\r\nFORCEON_YCLKB |\r\nFORCEON_MC |\r\nFORCEON_AIC));\r\nhost_path_cntl = INREG(HOST_PATH_CNTL);\r\nrbbm_soft_reset = INREG(RBBM_SOFT_RESET);\r\nif (IS_R300_VARIANT(rinfo)) {\r\nu32 tmp;\r\nOUTREG(RBBM_SOFT_RESET, (rbbm_soft_reset |\r\nSOFT_RESET_CP |\r\nSOFT_RESET_HI |\r\nSOFT_RESET_E2));\r\nINREG(RBBM_SOFT_RESET);\r\nOUTREG(RBBM_SOFT_RESET, 0);\r\ntmp = INREG(RB2D_DSTCACHE_MODE);\r\nOUTREG(RB2D_DSTCACHE_MODE, tmp | (1 << 17));\r\n} else {\r\nOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset |\r\nSOFT_RESET_CP |\r\nSOFT_RESET_HI |\r\nSOFT_RESET_SE |\r\nSOFT_RESET_RE |\r\nSOFT_RESET_PP |\r\nSOFT_RESET_E2 |\r\nSOFT_RESET_RB);\r\nINREG(RBBM_SOFT_RESET);\r\nOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset & (u32)\r\n~(SOFT_RESET_CP |\r\nSOFT_RESET_HI |\r\nSOFT_RESET_SE |\r\nSOFT_RESET_RE |\r\nSOFT_RESET_PP |\r\nSOFT_RESET_E2 |\r\nSOFT_RESET_RB));\r\nINREG(RBBM_SOFT_RESET);\r\n}\r\nOUTREG(HOST_PATH_CNTL, host_path_cntl | HDP_SOFT_RESET);\r\nINREG(HOST_PATH_CNTL);\r\nOUTREG(HOST_PATH_CNTL, host_path_cntl);\r\nif (!IS_R300_VARIANT(rinfo))\r\nOUTREG(RBBM_SOFT_RESET, rbbm_soft_reset);\r\nOUTREG(CLOCK_CNTL_INDEX, clock_cntl_index);\r\nOUTPLL(MCLK_CNTL, mclk_cntl);\r\n}\r\nvoid radeonfb_engine_init (struct radeonfb_info *rinfo)\r\n{\r\nunsigned long temp;\r\nOUTREG(RB3D_CNTL, 0);\r\nradeonfb_engine_reset(rinfo);\r\nradeon_fifo_wait (1);\r\nif (IS_R300_VARIANT(rinfo)) {\r\nOUTREG(RB2D_DSTCACHE_MODE, INREG(RB2D_DSTCACHE_MODE) |\r\nRB2D_DC_AUTOFLUSH_ENABLE |\r\nRB2D_DC_DC_DISABLE_IGNORE_PE);\r\n} else {\r\nOUTREG(RB2D_DSTCACHE_MODE, 0);\r\n}\r\nradeon_fifo_wait (3);\r\nrinfo->fb_local_base = INREG(MC_FB_LOCATION) << 16;\r\nOUTREG(DEFAULT_PITCH_OFFSET, (rinfo->pitch << 0x16) |\r\n(rinfo->fb_local_base >> 10));\r\nOUTREG(DST_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\r\nOUTREG(SRC_PITCH_OFFSET, (rinfo->pitch << 0x16) | (rinfo->fb_local_base >> 10));\r\nradeon_fifo_wait (1);\r\n#if defined(__BIG_ENDIAN)\r\nOUTREGP(DP_DATATYPE, HOST_BIG_ENDIAN_EN, ~HOST_BIG_ENDIAN_EN);\r\n#else\r\nOUTREGP(DP_DATATYPE, 0, ~HOST_BIG_ENDIAN_EN);\r\n#endif\r\nradeon_fifo_wait (2);\r\nOUTREG(DEFAULT_SC_TOP_LEFT, 0);\r\nOUTREG(DEFAULT_SC_BOTTOM_RIGHT, (DEFAULT_SC_RIGHT_MAX |\r\nDEFAULT_SC_BOTTOM_MAX));\r\ntemp = radeon_get_dstbpp(rinfo->depth);\r\nrinfo->dp_gui_master_cntl = ((temp << 8) | GMC_CLR_CMP_CNTL_DIS);\r\nradeon_fifo_wait (1);\r\nOUTREG(DP_GUI_MASTER_CNTL, (rinfo->dp_gui_master_cntl |\r\nGMC_BRUSH_SOLID_COLOR |\r\nGMC_SRC_DATATYPE_COLOR));\r\nradeon_fifo_wait (7);\r\nOUTREG(DST_LINE_START, 0);\r\nOUTREG(DST_LINE_END, 0);\r\nOUTREG(DP_BRUSH_FRGD_CLR, 0xffffffff);\r\nOUTREG(DP_BRUSH_BKGD_CLR, 0x00000000);\r\nOUTREG(DP_SRC_FRGD_CLR, 0xffffffff);\r\nOUTREG(DP_SRC_BKGD_CLR, 0x00000000);\r\nOUTREG(DP_WRITE_MSK, 0xffffffff);\r\nradeon_engine_idle ();\r\n}

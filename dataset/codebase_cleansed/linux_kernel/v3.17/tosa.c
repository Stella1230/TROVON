static int tosa_mci_init(struct device *dev, irq_handler_t tosa_detect_int, void *data)\r\n{\r\nint err;\r\nerr = gpio_request(TOSA_GPIO_nSD_INT, "SD Int");\r\nif (err) {\r\nprintk(KERN_ERR "tosa_mci_init: can't request SD_PWR gpio\n");\r\ngoto err_gpio_int;\r\n}\r\nerr = gpio_direction_input(TOSA_GPIO_nSD_INT);\r\nif (err)\r\ngoto err_gpio_int_dir;\r\nreturn 0;\r\nerr_gpio_int_dir:\r\ngpio_free(TOSA_GPIO_nSD_INT);\r\nerr_gpio_int:\r\nreturn err;\r\n}\r\nstatic void tosa_mci_exit(struct device *dev, void *data)\r\n{\r\ngpio_free(TOSA_GPIO_nSD_INT);\r\n}\r\nstatic void tosa_irda_transceiver_mode(struct device *dev, int mode)\r\n{\r\nif (mode & IR_OFF) {\r\ngpio_set_value(TOSA_GPIO_IR_POWERDWN, 0);\r\npxa2xx_transceiver_mode(dev, mode);\r\ngpio_direction_output(TOSA_GPIO_IRDA_TX, 0);\r\n} else {\r\npxa2xx_transceiver_mode(dev, mode);\r\ngpio_set_value(TOSA_GPIO_IR_POWERDWN, 1);\r\n}\r\n}\r\nstatic int tosa_irda_startup(struct device *dev)\r\n{\r\nint ret;\r\nret = gpio_request(TOSA_GPIO_IRDA_TX, "IrDA TX");\r\nif (ret)\r\ngoto err_tx;\r\nret = gpio_direction_output(TOSA_GPIO_IRDA_TX, 0);\r\nif (ret)\r\ngoto err_tx_dir;\r\nret = gpio_request(TOSA_GPIO_IR_POWERDWN, "IrDA powerdown");\r\nif (ret)\r\ngoto err_pwr;\r\nret = gpio_direction_output(TOSA_GPIO_IR_POWERDWN, 0);\r\nif (ret)\r\ngoto err_pwr_dir;\r\ntosa_irda_transceiver_mode(dev, IR_SIRMODE | IR_OFF);\r\nreturn 0;\r\nerr_pwr_dir:\r\ngpio_free(TOSA_GPIO_IR_POWERDWN);\r\nerr_pwr:\r\nerr_tx_dir:\r\ngpio_free(TOSA_GPIO_IRDA_TX);\r\nerr_tx:\r\nreturn ret;\r\n}\r\nstatic void tosa_irda_shutdown(struct device *dev)\r\n{\r\ntosa_irda_transceiver_mode(dev, IR_SIRMODE | IR_OFF);\r\ngpio_free(TOSA_GPIO_IR_POWERDWN);\r\ngpio_free(TOSA_GPIO_IRDA_TX);\r\n}\r\nstatic int tosa_power_init(struct device *dev)\r\n{\r\nint ret = gpio_request(TOSA_GPIO_AC_IN, "ac in");\r\nif (ret)\r\ngoto err_gpio_req;\r\nret = gpio_direction_input(TOSA_GPIO_AC_IN);\r\nif (ret)\r\ngoto err_gpio_in;\r\nreturn 0;\r\nerr_gpio_in:\r\ngpio_free(TOSA_GPIO_AC_IN);\r\nerr_gpio_req:\r\nreturn ret;\r\n}\r\nstatic void tosa_power_exit(struct device *dev)\r\n{\r\ngpio_free(TOSA_GPIO_AC_IN);\r\n}\r\nstatic int tosa_power_ac_online(void)\r\n{\r\nreturn gpio_get_value(TOSA_GPIO_AC_IN) == 0;\r\n}\r\nstatic int tosa_tc6393xb_enable(struct platform_device *dev)\r\n{\r\nint rc;\r\nrc = gpio_request(TOSA_GPIO_TC6393XB_REST_IN, "tc6393xb #pclr");\r\nif (rc)\r\ngoto err_req_pclr;\r\nrc = gpio_request(TOSA_GPIO_TC6393XB_SUSPEND, "tc6393xb #suspend");\r\nif (rc)\r\ngoto err_req_suspend;\r\nrc = gpio_request(TOSA_GPIO_TC6393XB_L3V_ON, "tc6393xb l3v");\r\nif (rc)\r\ngoto err_req_l3v;\r\nrc = gpio_direction_output(TOSA_GPIO_TC6393XB_L3V_ON, 0);\r\nif (rc)\r\ngoto err_dir_l3v;\r\nrc = gpio_direction_output(TOSA_GPIO_TC6393XB_SUSPEND, 0);\r\nif (rc)\r\ngoto err_dir_suspend;\r\nrc = gpio_direction_output(TOSA_GPIO_TC6393XB_REST_IN, 0);\r\nif (rc)\r\ngoto err_dir_pclr;\r\nmdelay(1);\r\ngpio_set_value(TOSA_GPIO_TC6393XB_SUSPEND, 1);\r\nmdelay(10);\r\ngpio_set_value(TOSA_GPIO_TC6393XB_REST_IN, 1);\r\ngpio_set_value(TOSA_GPIO_TC6393XB_L3V_ON, 1);\r\nreturn 0;\r\nerr_dir_pclr:\r\nerr_dir_suspend:\r\nerr_dir_l3v:\r\ngpio_free(TOSA_GPIO_TC6393XB_L3V_ON);\r\nerr_req_l3v:\r\ngpio_free(TOSA_GPIO_TC6393XB_SUSPEND);\r\nerr_req_suspend:\r\ngpio_free(TOSA_GPIO_TC6393XB_REST_IN);\r\nerr_req_pclr:\r\nreturn rc;\r\n}\r\nstatic int tosa_tc6393xb_disable(struct platform_device *dev)\r\n{\r\ngpio_free(TOSA_GPIO_TC6393XB_L3V_ON);\r\ngpio_free(TOSA_GPIO_TC6393XB_SUSPEND);\r\ngpio_free(TOSA_GPIO_TC6393XB_REST_IN);\r\nreturn 0;\r\n}\r\nstatic int tosa_tc6393xb_resume(struct platform_device *dev)\r\n{\r\ngpio_set_value(TOSA_GPIO_TC6393XB_SUSPEND, 1);\r\nmdelay(10);\r\ngpio_set_value(TOSA_GPIO_TC6393XB_L3V_ON, 1);\r\nmdelay(10);\r\nreturn 0;\r\n}\r\nstatic int tosa_tc6393xb_suspend(struct platform_device *dev)\r\n{\r\ngpio_set_value(TOSA_GPIO_TC6393XB_L3V_ON, 0);\r\ngpio_set_value(TOSA_GPIO_TC6393XB_SUSPEND, 0);\r\nreturn 0;\r\n}\r\nstatic int tosa_tc6393xb_setup(struct platform_device *dev)\r\n{\r\nint rc;\r\nrc = gpio_request(TOSA_GPIO_CARD_VCC_ON, "CARD_VCC_ON");\r\nif (rc)\r\ngoto err_req;\r\nrc = gpio_direction_output(TOSA_GPIO_CARD_VCC_ON, 1);\r\nif (rc)\r\ngoto err_dir;\r\nreturn rc;\r\nerr_dir:\r\ngpio_free(TOSA_GPIO_CARD_VCC_ON);\r\nerr_req:\r\nreturn rc;\r\n}\r\nstatic void tosa_tc6393xb_teardown(struct platform_device *dev)\r\n{\r\ngpio_free(TOSA_GPIO_CARD_VCC_ON);\r\n}\r\nstatic void tosa_poweroff(void)\r\n{\r\npxa_restart(REBOOT_GPIO, NULL);\r\n}\r\nstatic void tosa_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nuint32_t msc0 = __raw_readl(MSC0);\r\nif((msc0 & 0xffff0000) == 0x7ff00000)\r\n__raw_writel((msc0 & 0xffff) | 0x7ee00000, MSC0);\r\ntosa_poweroff();\r\n}\r\nstatic void __init tosa_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(tosa_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\ngpio_set_wake(MFP_PIN_GPIO1, 1);\r\ninit_gpio_reset(TOSA_GPIO_ON_RESET, 0, 0);\r\npm_power_off = tosa_poweroff;\r\nPCFR |= PCFR_OPDE;\r\nPMCR = 0x01;\r\npxa_set_mci_info(&tosa_mci_platform_data);\r\npxa_set_ficp_info(&tosa_ficp_platform_data);\r\npxa_set_i2c_info(NULL);\r\npxa_set_ac97_info(NULL);\r\nplatform_scoop_config = &tosa_pcmcia_config;\r\npxa2xx_set_spi_info(2, &pxa_ssp_master_info);\r\nspi_register_board_info(spi_board_info, ARRAY_SIZE(spi_board_info));\r\nclk_add_alias("CLK_CK3P6MI", tc6393xb_device.name, "GPIO11_CLK", NULL);\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\n}\r\nstatic void __init fixup_tosa(struct tag *tags, char **cmdline)\r\n{\r\nsharpsl_save_param();\r\nmemblock_add(0xa0000000, SZ_64M);\r\n}

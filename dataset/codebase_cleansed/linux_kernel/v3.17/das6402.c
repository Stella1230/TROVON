static void das6402_set_mode(struct comedi_device *dev,\r\nunsigned int mode)\r\n{\r\noutb(DAS6402_MODE_ENHANCED | mode, dev->iobase + DAS6402_MODE_REG);\r\n}\r\nstatic void das6402_set_extended(struct comedi_device *dev,\r\nunsigned int val)\r\n{\r\noutb(DAS6402_STATUS_W_EXTEND, dev->iobase + DAS6402_STATUS_REG);\r\noutb(DAS6402_STATUS_W_EXTEND | val, dev->iobase + DAS6402_STATUS_REG);\r\noutb(val, dev->iobase + DAS6402_STATUS_REG);\r\n}\r\nstatic void das6402_clear_all_interrupts(struct comedi_device *dev)\r\n{\r\noutb(DAS6402_STATUS_W_CLRINT |\r\nDAS6402_STATUS_W_CLRXTR |\r\nDAS6402_STATUS_W_CLRXIN, dev->iobase + DAS6402_STATUS_REG);\r\n}\r\nstatic void das6402_ai_clear_eoc(struct comedi_device *dev)\r\n{\r\noutb(DAS6402_STATUS_W_CLRINT, dev->iobase + DAS6402_STATUS_REG);\r\n}\r\nstatic void das6402_enable_counter(struct comedi_device *dev, bool load)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\nunsigned long timer_iobase = dev->iobase + DAS6402_TIMER_BASE;\r\nif (load) {\r\ni8254_set_mode(timer_iobase, 0, 0, I8254_MODE0 | I8254_BINARY);\r\ni8254_set_mode(timer_iobase, 0, 1, I8254_MODE2 | I8254_BINARY);\r\ni8254_set_mode(timer_iobase, 0, 2, I8254_MODE2 | I8254_BINARY);\r\ni8254_write(timer_iobase, 0, 0, devpriv->count);\r\ni8254_write(timer_iobase, 0, 1, devpriv->divider1);\r\ni8254_write(timer_iobase, 0, 2, devpriv->divider2);\r\n} else {\r\ni8254_set_mode(timer_iobase, 0, 0, I8254_MODE0 | I8254_BINARY);\r\ni8254_set_mode(timer_iobase, 0, 1, I8254_MODE0 | I8254_BINARY);\r\ni8254_set_mode(timer_iobase, 0, 2, I8254_MODE0 | I8254_BINARY);\r\n}\r\n}\r\nstatic irqreturn_t das6402_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\ndas6402_clear_all_interrupts(dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int das6402_ai_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int das6402_ai_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int das6402_ai_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\noutb(DAS6402_CTRL_SOFT_TRIG, dev->iobase + DAS6402_CTRL_REG);\r\nreturn 0;\r\n}\r\nstatic void das6402_ai_soft_trig(struct comedi_device *dev)\r\n{\r\noutw(0, dev->iobase + DAS6402_AI_DATA_REG);\r\n}\r\nstatic int das6402_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + DAS6402_STATUS_REG);\r\nif (status & DAS6402_STATUS_FFNE)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int das6402_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int aref = CR_AREF(insn->chanspec);\r\nunsigned int val;\r\nint ret;\r\nint i;\r\nval = DAS6402_MODE_RANGE(range) | DAS6402_MODE_POLLED;\r\nif (aref == AREF_DIFF) {\r\nif (chan > s->n_chan / 2)\r\nreturn -EINVAL;\r\n} else {\r\nval |= DAS6402_MODE_SE;\r\n}\r\nif (comedi_range_is_unipolar(s, range))\r\nval |= DAS6402_MODE_UNI;\r\noutb(DAS6402_CTRL_SOFT_TRIG, dev->iobase + DAS6402_CTRL_REG);\r\ndas6402_set_mode(dev, val);\r\noutw(DAS6402_AI_MUX_HI(chan) | DAS6402_AI_MUX_LO(chan),\r\ndev->iobase + DAS6402_AI_MUX_REG);\r\nfor (i = 0; i < insn->n; i++) {\r\ndas6402_ai_clear_eoc(dev);\r\ndas6402_ai_soft_trig(dev);\r\nret = comedi_timeout(dev, s, insn, das6402_ai_eoc, 0);\r\nif (ret)\r\nbreak;\r\nval = inw(dev->iobase + DAS6402_AI_DATA_REG);\r\nif (s->maxdata == 0x0fff)\r\nval >>= 4;\r\ndata[i] = val;\r\n}\r\ndas6402_ai_clear_eoc(dev);\r\nreturn insn->n;\r\n}\r\nstatic int das6402_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int val;\r\nint i;\r\nval = devpriv->ao_range;\r\nval &= ~DAS6402_AO_RANGE_MASK(chan);\r\nval |= DAS6402_AO_RANGE(chan, range);\r\nif (val != devpriv->ao_range) {\r\ndevpriv->ao_range = val;\r\noutb(val, dev->iobase + DAS6402_TRIG_REG);\r\n}\r\nfor (i = 0; i < insn->n; i++) {\r\nval = data[i];\r\ndevpriv->ao_readback[chan] = val;\r\nif (s->maxdata == 0x0fff) {\r\nval <<= 4;\r\noutw(val, dev->iobase + DAS6402_AO_DATA_REG(chan));\r\n} else {\r\noutb(val & 0xff,\r\ndev->iobase + DAS6402_AO_LSB_REG(chan));\r\noutb((val >> 8) & 0xff,\r\ndev->iobase + DAS6402_AO_LSB_REG(chan));\r\n}\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int das6402_ao_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint i;\r\ninw(dev->iobase + DAS6402_AO_LSB_REG(chan));\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn insn->n;\r\n}\r\nstatic int das6402_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = inb(dev->iobase + DAS6402_DI_DO_REG);\r\nreturn insn->n;\r\n}\r\nstatic int das6402_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutb(s->state, dev->iobase + DAS6402_DI_DO_REG);\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic void das6402_reset(struct comedi_device *dev)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\noutb(DAS6402_MODE_ENHANCED, dev->iobase + DAS6402_MODE_REG);\r\ndas6402_set_extended(dev, DAS6402_STATUS_W_10MHZ);\r\noutb(DAS6402_CTRL_SOFT_TRIG, dev->iobase + DAS6402_CTRL_REG);\r\ndas6402_set_mode(dev, DAS6402_MODE_RANGE(0) |\r\nDAS6402_MODE_POLLED |\r\nDAS6402_MODE_SE |\r\nDAS6402_MODE_UNI);\r\noutw(DAS6402_AI_MUX_HI(0) | DAS6402_AI_MUX_LO(0),\r\ndev->iobase + DAS6402_AI_MUX_REG);\r\ndevpriv->ao_range = DAS6402_AO_RANGE(0, 2) | DAS6402_AO_RANGE(1, 2);\r\noutb(devpriv->ao_range, dev->iobase + DAS6402_TRIG_REG);\r\noutw(0, dev->iobase + DAS6402_AO_DATA_REG(0));\r\noutw(0, dev->iobase + DAS6402_AO_DATA_REG(0));\r\ninw(dev->iobase + DAS6402_AO_LSB_REG(0));\r\ndas6402_enable_counter(dev, false);\r\noutb(0, dev->iobase + DAS6402_DI_DO_REG);\r\ndas6402_clear_all_interrupts(dev);\r\n}\r\nstatic int das6402_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct das6402_boardinfo *board = comedi_board(dev);\r\nstruct das6402_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_request_region(dev, it->options[0], 0x10);\r\nif (ret)\r\nreturn ret;\r\ndas6402_reset(dev);\r\nif ((1 << it->options[1]) & 0x8cec) {\r\nret = request_irq(it->options[1], das6402_interrupt, 0,\r\ndev->board_name, dev);\r\nif (ret == 0) {\r\ndev->irq = it->options[1];\r\nswitch (dev->irq) {\r\ncase 10:\r\ndevpriv->irq = 4;\r\nbreak;\r\ncase 11:\r\ndevpriv->irq = 1;\r\nbreak;\r\ncase 15:\r\ndevpriv->irq = 6;\r\nbreak;\r\ndefault:\r\ndevpriv->irq = dev->irq;\r\nbreak;\r\n}\r\n}\r\n}\r\nret = comedi_alloc_subdevices(dev, 4);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = 64;\r\ns->maxdata = board->maxdata;\r\ns->range_table = &das6402_ai_ranges;\r\ns->insn_read = das6402_ai_insn_read;\r\nif (dev->irq) {\r\ndev->read_subdev = s;\r\ns->subdev_flags |= SDF_CMD_READ;\r\ns->len_chanlist = s->n_chan;\r\ns->do_cmdtest = das6402_ai_cmdtest;\r\ns->do_cmd = das6402_ai_cmd;\r\ns->cancel = das6402_ai_cancel;\r\n}\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE;\r\ns->n_chan = 2;\r\ns->maxdata = board->maxdata;\r\ns->range_table = &das6402_ao_ranges;\r\ns->insn_write = das6402_ao_insn_write;\r\ns->insn_read = das6402_ao_insn_read;\r\ns = &dev->subdevices[2];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = das6402_di_insn_bits;\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITEABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = das6402_do_insn_bits;\r\nreturn 0;\r\n}

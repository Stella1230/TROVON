static int ipip_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nskb_push(skb, -skb_network_offset(skb));\r\nreturn 0;\r\n}\r\nstatic int ipip_xfrm_rcv(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nreturn ip_hdr(skb)->protocol;\r\n}\r\nstatic int ipip_init_state(struct xfrm_state *x)\r\n{\r\nif (x->props.mode != XFRM_MODE_TUNNEL)\r\nreturn -EINVAL;\r\nif (x->encap)\r\nreturn -EINVAL;\r\nx->props.header_len = sizeof(struct iphdr);\r\nreturn 0;\r\n}\r\nstatic void ipip_destroy(struct xfrm_state *x)\r\n{\r\n}\r\nstatic int xfrm_tunnel_rcv(struct sk_buff *skb)\r\n{\r\nreturn xfrm4_rcv_spi(skb, IPPROTO_IPIP, ip_hdr(skb)->saddr);\r\n}\r\nstatic int xfrm_tunnel_err(struct sk_buff *skb, u32 info)\r\n{\r\nreturn -ENOENT;\r\n}\r\nstatic int __init ipip_init(void)\r\n{\r\nif (xfrm_register_type(&ipip_type, AF_INET) < 0) {\r\npr_info("%s: can't add xfrm type\n", __func__);\r\nreturn -EAGAIN;\r\n}\r\nif (xfrm4_tunnel_register(&xfrm_tunnel_handler, AF_INET)) {\r\npr_info("%s: can't add xfrm handler for AF_INET\n", __func__);\r\nxfrm_unregister_type(&ipip_type, AF_INET);\r\nreturn -EAGAIN;\r\n}\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nif (xfrm4_tunnel_register(&xfrm64_tunnel_handler, AF_INET6)) {\r\npr_info("%s: can't add xfrm handler for AF_INET6\n", __func__);\r\nxfrm4_tunnel_deregister(&xfrm_tunnel_handler, AF_INET);\r\nxfrm_unregister_type(&ipip_type, AF_INET);\r\nreturn -EAGAIN;\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit ipip_fini(void)\r\n{\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nif (xfrm4_tunnel_deregister(&xfrm64_tunnel_handler, AF_INET6))\r\npr_info("%s: can't remove xfrm handler for AF_INET6\n",\r\n__func__);\r\n#endif\r\nif (xfrm4_tunnel_deregister(&xfrm_tunnel_handler, AF_INET))\r\npr_info("%s: can't remove xfrm handler for AF_INET\n",\r\n__func__);\r\nif (xfrm_unregister_type(&ipip_type, AF_INET) < 0)\r\npr_info("%s: can't remove xfrm type\n", __func__);\r\n}

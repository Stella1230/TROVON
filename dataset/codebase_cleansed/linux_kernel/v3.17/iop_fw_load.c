static int wait_mpu_idle(void)\r\n{\r\nreg_iop_mpu_r_stat mpu_stat;\r\nunsigned int timeout = IOP_TIMEOUT;\r\ndo {\r\nmpu_stat = REG_RD(iop_mpu, regi_iop_mpu, r_stat);\r\n} while (mpu_stat.instr_reg_busy == regk_iop_mpu_yes && --timeout > 0);\r\nif (timeout == 0) {\r\nprintk(KERN_ERR "Timeout waiting for MPU to be idle\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint iop_fw_load_spu(const unsigned char *fw_name, unsigned int spu_inst)\r\n{\r\nreg_iop_sw_cpu_rw_mc_ctrl mc_ctrl = {\r\n.wr_spu0_mem = regk_iop_sw_cpu_no,\r\n.wr_spu1_mem = regk_iop_sw_cpu_no,\r\n.size = 4,\r\n.cmd = regk_iop_sw_cpu_reg_copy,\r\n.keep_owner = regk_iop_sw_cpu_yes\r\n};\r\nreg_iop_spu_rw_ctrl spu_ctrl = {\r\n.en = regk_iop_spu_no,\r\n.fsm = regk_iop_spu_no,\r\n};\r\nreg_iop_sw_cpu_r_mc_stat mc_stat;\r\nconst struct firmware *fw_entry;\r\nu32 *data;\r\nunsigned int timeout;\r\nint retval, i;\r\nif (spu_inst > 1)\r\nreturn -ENODEV;\r\nretval = request_firmware(&fw_entry,\r\nfw_name,\r\n&iop_spu_device[spu_inst]);\r\nif (retval != 0)\r\n{\r\nprintk(KERN_ERR\r\n"iop_load_spu: Failed to load firmware \"%s\"\n",\r\nfw_name);\r\nreturn retval;\r\n}\r\ndata = (u32 *) fw_entry->data;\r\nswitch (spu_inst) {\r\ncase 0:\r\nmc_ctrl.wr_spu0_mem = regk_iop_sw_cpu_yes;\r\nREG_WR(iop_spu, regi_iop_spu0, rw_ctrl, spu_ctrl);\r\nbreak;\r\ncase 1:\r\nmc_ctrl.wr_spu1_mem = regk_iop_sw_cpu_yes;\r\nREG_WR(iop_spu, regi_iop_spu1, rw_ctrl, spu_ctrl);\r\nbreak;\r\n}\r\ntimeout = IOP_TIMEOUT;\r\ndo {\r\nREG_WR(iop_sw_cpu, regi_iop_sw_cpu, rw_mc_ctrl, mc_ctrl);\r\nmc_stat = REG_RD(iop_sw_cpu, regi_iop_sw_cpu, r_mc_stat);\r\n} while (mc_stat.owned_by_cpu == regk_iop_sw_cpu_no && --timeout > 0);\r\nif (timeout == 0) {\r\nprintk(KERN_ERR "Timeout waiting to acquire MC\n");\r\nretval = -EBUSY;\r\ngoto out;\r\n}\r\nfor (i = 0; i < (fw_entry->size/4); i++) {\r\nswitch (spu_inst) {\r\ncase 0:\r\nREG_WR_INT(iop_spu, regi_iop_spu0, rw_seq_pc, (i*4));\r\nbreak;\r\ncase 1:\r\nREG_WR_INT(iop_spu, regi_iop_spu1, rw_seq_pc, (i*4));\r\nbreak;\r\n}\r\nREG_WR_INT(iop_sw_cpu, regi_iop_sw_cpu, rw_mc_data, *data);\r\ndata++;\r\n}\r\n(void) REG_RD(iop_sw_cpu, regi_iop_sw_cpu, rs_mc_data);\r\nout:\r\nrelease_firmware(fw_entry);\r\nreturn retval;\r\n}\r\nint iop_fw_load_mpu(unsigned char *fw_name)\r\n{\r\nconst unsigned int start_addr = 0;\r\nreg_iop_mpu_rw_ctrl mpu_ctrl;\r\nconst struct firmware *fw_entry;\r\nu32 *data;\r\nint retval, i;\r\nretval = request_firmware(&fw_entry, fw_name, &iop_mpu_device);\r\nif (retval != 0)\r\n{\r\nprintk(KERN_ERR\r\n"iop_load_spu: Failed to load firmware \"%s\"\n",\r\nfw_name);\r\nreturn retval;\r\n}\r\ndata = (u32 *) fw_entry->data;\r\nmpu_ctrl.en = regk_iop_mpu_no;\r\nREG_WR(iop_mpu, regi_iop_mpu, rw_ctrl, mpu_ctrl);\r\nREG_WR_VECT(iop_mpu, regi_iop_mpu, rw_r, 0, start_addr);\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nREG_WR(iop_mpu, regi_iop_mpu, rw_instr, MPU_SWX_IIR_INSTR(0, 4, 0));\r\nfor (i = 0; i < (fw_entry->size / 4); i++) {\r\nREG_WR_INT(iop_mpu, regi_iop_mpu, rw_immediate, *data);\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\ndata++;\r\n}\r\nout:\r\nrelease_firmware(fw_entry);\r\nreturn retval;\r\n}\r\nint iop_start_mpu(unsigned int start_addr)\r\n{\r\nreg_iop_mpu_rw_ctrl mpu_ctrl = { .en = regk_iop_mpu_yes };\r\nint retval;\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nREG_WR(iop_mpu, regi_iop_mpu, rw_instr, MPU_HALT());\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nREG_WR_INT(iop_mpu, regi_iop_mpu, rw_instr, MPU_BA_I(start_addr));\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nREG_WR(iop_mpu, regi_iop_mpu, rw_instr, MPU_DI());\r\nif ((retval = wait_mpu_idle()) != 0)\r\ngoto out;\r\nREG_WR(iop_mpu, regi_iop_mpu, rw_ctrl, mpu_ctrl);\r\nout:\r\nreturn retval;\r\n}\r\nstatic int __init iop_fw_load_init(void)\r\n{\r\n#if 0\r\ndevice_initialize(&iop_spu_device[0]);\r\nkobject_set_name(&iop_spu_device[0].kobj, "iop-spu0");\r\nkobject_add(&iop_spu_device[0].kobj);\r\ndevice_initialize(&iop_spu_device[1]);\r\nkobject_set_name(&iop_spu_device[1].kobj, "iop-spu1");\r\nkobject_add(&iop_spu_device[1].kobj);\r\ndevice_initialize(&iop_mpu_device);\r\nkobject_set_name(&iop_mpu_device.kobj, "iop-mpu");\r\nkobject_add(&iop_mpu_device.kobj);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit iop_fw_load_exit(void)\r\n{\r\n}

static int hci_h4p_bcm_set_bdaddr(struct hci_h4p_info *info,\r\nstruct sk_buff *skb)\r\n{\r\nint i;\r\nstatic const u8 nokia_oui[3] = {0x00, 0x1f, 0xdf};\r\nint not_valid;\r\nnot_valid = 1;\r\nfor (i = 0; i < 6; i++) {\r\nif (info->bd_addr[i] != 0x00) {\r\nnot_valid = 0;\r\nbreak;\r\n}\r\n}\r\nif (not_valid) {\r\ndev_info(info->dev, "Valid bluetooth address not found, setting some random\n");\r\nmemcpy(info->bd_addr, nokia_oui, 3);\r\nget_random_bytes(info->bd_addr + 3, 3);\r\n}\r\nfor (i = 0; i < 6; i++)\r\nskb->data[9 - i] = info->bd_addr[i];\r\nreturn 0;\r\n}\r\nvoid hci_h4p_bcm_parse_fw_event(struct hci_h4p_info *info, struct sk_buff *skb)\r\n{\r\nstruct sk_buff *fw_skb;\r\nint err;\r\nunsigned long flags;\r\nif (skb->data[5] != 0x00) {\r\ndev_err(info->dev, "Firmware sending command failed 0x%.2x\n",\r\nskb->data[5]);\r\ninfo->fw_error = -EPROTO;\r\n}\r\nkfree_skb(skb);\r\nfw_skb = skb_dequeue(info->fw_q);\r\nif (fw_skb == NULL || info->fw_error) {\r\ncomplete(&info->fw_completion);\r\nreturn;\r\n}\r\nif (fw_skb->data[1] == 0x01 && fw_skb->data[2] == 0xfc &&\r\nfw_skb->len >= 10) {\r\nBT_DBG("Setting bluetooth address");\r\nerr = hci_h4p_bcm_set_bdaddr(info, fw_skb);\r\nif (err < 0) {\r\nkfree_skb(fw_skb);\r\ninfo->fw_error = err;\r\ncomplete(&info->fw_completion);\r\nreturn;\r\n}\r\n}\r\nskb_queue_tail(&info->txq, fw_skb);\r\nspin_lock_irqsave(&info->lock, flags);\r\nhci_h4p_outb(info, UART_IER, hci_h4p_inb(info, UART_IER) |\r\nUART_IER_THRI);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\n}\r\nint hci_h4p_bcm_send_fw(struct hci_h4p_info *info,\r\nstruct sk_buff_head *fw_queue)\r\n{\r\nstruct sk_buff *skb;\r\nunsigned long flags, time;\r\ninfo->fw_error = 0;\r\nBT_DBG("Sending firmware");\r\ntime = jiffies;\r\ninfo->fw_q = fw_queue;\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb)\r\nreturn -ENODATA;\r\nBT_DBG("Sending commands");\r\nhci_h4p_smart_idle(info, 0);\r\ninit_completion(&info->fw_completion);\r\nskb_queue_tail(&info->txq, skb);\r\nspin_lock_irqsave(&info->lock, flags);\r\nhci_h4p_outb(info, UART_IER, hci_h4p_inb(info, UART_IER) |\r\nUART_IER_THRI);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\nif (!wait_for_completion_timeout(&info->fw_completion,\r\nmsecs_to_jiffies(2000))) {\r\ndev_err(info->dev, "No reply to fw command\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (info->fw_error) {\r\ndev_err(info->dev, "FW error\n");\r\nreturn -EPROTO;\r\n}\r\nBT_DBG("Firmware sent in %d msecs",\r\njiffies_to_msecs(jiffies-time));\r\nhci_h4p_set_auto_ctsrts(info, 0, UART_EFR_RTS);\r\nhci_h4p_set_rts(info, 0);\r\nhci_h4p_change_speed(info, BC4_MAX_BAUD_RATE);\r\nhci_h4p_set_auto_ctsrts(info, 1, UART_EFR_RTS);\r\nreturn 0;\r\n}

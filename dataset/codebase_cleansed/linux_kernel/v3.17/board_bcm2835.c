static void bcm2835_setup_restart(void)\r\n{\r\nstruct device_node *np = of_find_compatible_node(NULL, NULL,\r\n"brcm,bcm2835-pm-wdt");\r\nif (WARN(!np, "unable to setup watchdog restart"))\r\nreturn;\r\nwdt_regs = of_iomap(np, 0);\r\nWARN(!wdt_regs, "failed to remap watchdog regs");\r\n}\r\nstatic void bcm2835_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nu32 val;\r\nif (!wdt_regs)\r\nreturn;\r\nwritel_relaxed(10 | PM_PASSWORD, wdt_regs + PM_WDOG);\r\nval = readl_relaxed(wdt_regs + PM_RSTC);\r\nval &= ~PM_RSTC_WRCFG_MASK;\r\nval |= PM_PASSWORD | PM_RSTC_WRCFG_FULL_RESET;\r\nwritel_relaxed(val, wdt_regs + PM_RSTC);\r\nmdelay(1);\r\n}\r\nstatic void bcm2835_power_off(void)\r\n{\r\nu32 val;\r\nval = readl_relaxed(wdt_regs + PM_RSTS);\r\nval &= ~PM_RSTC_WRCFG_MASK;\r\nval |= PM_PASSWORD | PM_RSTS_HADWRH_SET;\r\nwritel_relaxed(val, wdt_regs + PM_RSTS);\r\nbcm2835_restart(REBOOT_HARD, "");\r\n}\r\nstatic void __init bcm2835_map_io(void)\r\n{\r\niotable_init(&io_map, 1);\r\n}\r\nstatic void __init bcm2835_init(void)\r\n{\r\nint ret;\r\nbcm2835_setup_restart();\r\nif (wdt_regs)\r\npm_power_off = bcm2835_power_off;\r\nbcm2835_init_clocks();\r\nret = of_platform_populate(NULL, of_default_bus_match_table, NULL,\r\nNULL);\r\nif (ret) {\r\npr_err("of_platform_populate failed: %d\n", ret);\r\nBUG();\r\n}\r\n}

static inline u8 w5100_read_direct(struct w5100_priv *priv, u16 addr)\r\n{\r\nreturn ioread8(priv->base + (addr << CONFIG_WIZNET_BUS_SHIFT));\r\n}\r\nstatic inline void w5100_write_direct(struct w5100_priv *priv,\r\nu16 addr, u8 data)\r\n{\r\niowrite8(data, priv->base + (addr << CONFIG_WIZNET_BUS_SHIFT));\r\n}\r\nstatic u16 w5100_read16_direct(struct w5100_priv *priv, u16 addr)\r\n{\r\nu16 data;\r\ndata = w5100_read_direct(priv, addr) << 8;\r\ndata |= w5100_read_direct(priv, addr + 1);\r\nreturn data;\r\n}\r\nstatic void w5100_write16_direct(struct w5100_priv *priv, u16 addr, u16 data)\r\n{\r\nw5100_write_direct(priv, addr, data >> 8);\r\nw5100_write_direct(priv, addr + 1, data);\r\n}\r\nstatic void w5100_readbuf_direct(struct w5100_priv *priv,\r\nu16 offset, u8 *buf, int len)\r\n{\r\nu16 addr = W5100_RX_MEM_START + (offset & W5100_RX_MEM_MASK);\r\nint i;\r\nfor (i = 0; i < len; i++, addr++) {\r\nif (unlikely(addr > W5100_RX_MEM_END))\r\naddr = W5100_RX_MEM_START;\r\n*buf++ = w5100_read_direct(priv, addr);\r\n}\r\n}\r\nstatic void w5100_writebuf_direct(struct w5100_priv *priv,\r\nu16 offset, u8 *buf, int len)\r\n{\r\nu16 addr = W5100_TX_MEM_START + (offset & W5100_TX_MEM_MASK);\r\nint i;\r\nfor (i = 0; i < len; i++, addr++) {\r\nif (unlikely(addr > W5100_TX_MEM_END))\r\naddr = W5100_TX_MEM_START;\r\nw5100_write_direct(priv, addr, *buf++);\r\n}\r\n}\r\nstatic u8 w5100_read_indirect(struct w5100_priv *priv, u16 addr)\r\n{\r\nunsigned long flags;\r\nu8 data;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\ndata = w5100_read_direct(priv, W5100_IDM_DR);\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\nreturn data;\r\n}\r\nstatic void w5100_write_indirect(struct w5100_priv *priv, u16 addr, u8 data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\nw5100_write_direct(priv, W5100_IDM_DR, data);\r\nmmiowb();\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\n}\r\nstatic u16 w5100_read16_indirect(struct w5100_priv *priv, u16 addr)\r\n{\r\nunsigned long flags;\r\nu16 data;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\ndata = w5100_read_direct(priv, W5100_IDM_DR) << 8;\r\ndata |= w5100_read_direct(priv, W5100_IDM_DR);\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\nreturn data;\r\n}\r\nstatic void w5100_write16_indirect(struct w5100_priv *priv, u16 addr, u16 data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\nw5100_write_direct(priv, W5100_IDM_DR, data >> 8);\r\nw5100_write_direct(priv, W5100_IDM_DR, data);\r\nmmiowb();\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\n}\r\nstatic void w5100_readbuf_indirect(struct w5100_priv *priv,\r\nu16 offset, u8 *buf, int len)\r\n{\r\nu16 addr = W5100_RX_MEM_START + (offset & W5100_RX_MEM_MASK);\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\nfor (i = 0; i < len; i++, addr++) {\r\nif (unlikely(addr > W5100_RX_MEM_END)) {\r\naddr = W5100_RX_MEM_START;\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\n}\r\n*buf++ = w5100_read_direct(priv, W5100_IDM_DR);\r\n}\r\nmmiowb();\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\n}\r\nstatic void w5100_writebuf_indirect(struct w5100_priv *priv,\r\nu16 offset, u8 *buf, int len)\r\n{\r\nu16 addr = W5100_TX_MEM_START + (offset & W5100_TX_MEM_MASK);\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&priv->reg_lock, flags);\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\nfor (i = 0; i < len; i++, addr++) {\r\nif (unlikely(addr > W5100_TX_MEM_END)) {\r\naddr = W5100_TX_MEM_START;\r\nw5100_write16_direct(priv, W5100_IDM_AR, addr);\r\nmmiowb();\r\n}\r\nw5100_write_direct(priv, W5100_IDM_DR, *buf++);\r\n}\r\nmmiowb();\r\nspin_unlock_irqrestore(&priv->reg_lock, flags);\r\n}\r\nstatic int w5100_command(struct w5100_priv *priv, u16 cmd)\r\n{\r\nunsigned long timeout = jiffies + msecs_to_jiffies(100);\r\nw5100_write(priv, W5100_S0_CR, cmd);\r\nmmiowb();\r\nwhile (w5100_read(priv, W5100_S0_CR) != 0) {\r\nif (time_after(jiffies, timeout))\r\nreturn -EIO;\r\ncpu_relax();\r\n}\r\nreturn 0;\r\n}\r\nstatic void w5100_write_macaddr(struct w5100_priv *priv)\r\n{\r\nstruct net_device *ndev = priv->ndev;\r\nint i;\r\nfor (i = 0; i < ETH_ALEN; i++)\r\nw5100_write(priv, W5100_SHAR + i, ndev->dev_addr[i]);\r\nmmiowb();\r\n}\r\nstatic void w5100_hw_reset(struct w5100_priv *priv)\r\n{\r\nw5100_write_direct(priv, W5100_MR, MR_RST);\r\nmmiowb();\r\nmdelay(5);\r\nw5100_write_direct(priv, W5100_MR, priv->indirect ?\r\nMR_PB | MR_AI | MR_IND :\r\nMR_PB);\r\nmmiowb();\r\nw5100_write(priv, W5100_IMR, 0);\r\nw5100_write_macaddr(priv);\r\nw5100_write(priv, W5100_RMSR, 0x03);\r\nw5100_write(priv, W5100_TMSR, 0x03);\r\nmmiowb();\r\n}\r\nstatic void w5100_hw_start(struct w5100_priv *priv)\r\n{\r\nw5100_write(priv, W5100_S0_MR, priv->promisc ?\r\nS0_MR_MACRAW : S0_MR_MACRAW_MF);\r\nmmiowb();\r\nw5100_command(priv, S0_CR_OPEN);\r\nw5100_write(priv, W5100_IMR, IR_S0);\r\nmmiowb();\r\n}\r\nstatic void w5100_hw_close(struct w5100_priv *priv)\r\n{\r\nw5100_write(priv, W5100_IMR, 0);\r\nmmiowb();\r\nw5100_command(priv, S0_CR_CLOSE);\r\n}\r\nstatic void w5100_get_drvinfo(struct net_device *ndev,\r\nstruct ethtool_drvinfo *info)\r\n{\r\nstrlcpy(info->driver, DRV_NAME, sizeof(info->driver));\r\nstrlcpy(info->version, DRV_VERSION, sizeof(info->version));\r\nstrlcpy(info->bus_info, dev_name(ndev->dev.parent),\r\nsizeof(info->bus_info));\r\n}\r\nstatic u32 w5100_get_link(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (gpio_is_valid(priv->link_gpio))\r\nreturn !!gpio_get_value(priv->link_gpio);\r\nreturn 1;\r\n}\r\nstatic u32 w5100_get_msglevel(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nreturn priv->msg_enable;\r\n}\r\nstatic void w5100_set_msglevel(struct net_device *ndev, u32 value)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\npriv->msg_enable = value;\r\n}\r\nstatic int w5100_get_regs_len(struct net_device *ndev)\r\n{\r\nreturn W5100_COMMON_REGS_LEN + W5100_S0_REGS_LEN;\r\n}\r\nstatic void w5100_get_regs(struct net_device *ndev,\r\nstruct ethtool_regs *regs, void *_buf)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nu8 *buf = _buf;\r\nu16 i;\r\nregs->version = 1;\r\nfor (i = 0; i < W5100_COMMON_REGS_LEN; i++)\r\n*buf++ = w5100_read(priv, W5100_COMMON_REGS + i);\r\nfor (i = 0; i < W5100_S0_REGS_LEN; i++)\r\n*buf++ = w5100_read(priv, W5100_S0_REGS + i);\r\n}\r\nstatic void w5100_tx_timeout(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_stop_queue(ndev);\r\nw5100_hw_reset(priv);\r\nw5100_hw_start(priv);\r\nndev->stats.tx_errors++;\r\nndev->trans_start = jiffies;\r\nnetif_wake_queue(ndev);\r\n}\r\nstatic int w5100_start_tx(struct sk_buff *skb, struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nu16 offset;\r\nnetif_stop_queue(ndev);\r\noffset = w5100_read16(priv, W5100_S0_TX_WR);\r\nw5100_writebuf(priv, offset, skb->data, skb->len);\r\nw5100_write16(priv, W5100_S0_TX_WR, offset + skb->len);\r\nmmiowb();\r\nndev->stats.tx_bytes += skb->len;\r\nndev->stats.tx_packets++;\r\ndev_kfree_skb(skb);\r\nw5100_command(priv, S0_CR_SEND);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic int w5100_napi_poll(struct napi_struct *napi, int budget)\r\n{\r\nstruct w5100_priv *priv = container_of(napi, struct w5100_priv, napi);\r\nstruct net_device *ndev = priv->ndev;\r\nstruct sk_buff *skb;\r\nint rx_count;\r\nu16 rx_len;\r\nu16 offset;\r\nu8 header[2];\r\nfor (rx_count = 0; rx_count < budget; rx_count++) {\r\nu16 rx_buf_len = w5100_read16(priv, W5100_S0_RX_RSR);\r\nif (rx_buf_len == 0)\r\nbreak;\r\noffset = w5100_read16(priv, W5100_S0_RX_RD);\r\nw5100_readbuf(priv, offset, header, 2);\r\nrx_len = get_unaligned_be16(header) - 2;\r\nskb = netdev_alloc_skb_ip_align(ndev, rx_len);\r\nif (unlikely(!skb)) {\r\nw5100_write16(priv, W5100_S0_RX_RD,\r\noffset + rx_buf_len);\r\nw5100_command(priv, S0_CR_RECV);\r\nndev->stats.rx_dropped++;\r\nreturn -ENOMEM;\r\n}\r\nskb_put(skb, rx_len);\r\nw5100_readbuf(priv, offset + 2, skb->data, rx_len);\r\nw5100_write16(priv, W5100_S0_RX_RD, offset + 2 + rx_len);\r\nmmiowb();\r\nw5100_command(priv, S0_CR_RECV);\r\nskb->protocol = eth_type_trans(skb, ndev);\r\nnetif_receive_skb(skb);\r\nndev->stats.rx_packets++;\r\nndev->stats.rx_bytes += rx_len;\r\n}\r\nif (rx_count < budget) {\r\nw5100_write(priv, W5100_IMR, IR_S0);\r\nmmiowb();\r\nnapi_complete(napi);\r\n}\r\nreturn rx_count;\r\n}\r\nstatic irqreturn_t w5100_interrupt(int irq, void *ndev_instance)\r\n{\r\nstruct net_device *ndev = ndev_instance;\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nint ir = w5100_read(priv, W5100_S0_IR);\r\nif (!ir)\r\nreturn IRQ_NONE;\r\nw5100_write(priv, W5100_S0_IR, ir);\r\nmmiowb();\r\nif (ir & S0_IR_SENDOK) {\r\nnetif_dbg(priv, tx_done, ndev, "tx done\n");\r\nnetif_wake_queue(ndev);\r\n}\r\nif (ir & S0_IR_RECV) {\r\nif (napi_schedule_prep(&priv->napi)) {\r\nw5100_write(priv, W5100_IMR, 0);\r\nmmiowb();\r\n__napi_schedule(&priv->napi);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t w5100_detect_link(int irq, void *ndev_instance)\r\n{\r\nstruct net_device *ndev = ndev_instance;\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nif (gpio_get_value(priv->link_gpio) != 0) {\r\nnetif_info(priv, link, ndev, "link is up\n");\r\nnetif_carrier_on(ndev);\r\n} else {\r\nnetif_info(priv, link, ndev, "link is down\n");\r\nnetif_carrier_off(ndev);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void w5100_set_rx_mode(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nbool set_promisc = (ndev->flags & IFF_PROMISC) != 0;\r\nif (priv->promisc != set_promisc) {\r\npriv->promisc = set_promisc;\r\nw5100_hw_start(priv);\r\n}\r\n}\r\nstatic int w5100_set_macaddr(struct net_device *ndev, void *addr)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nstruct sockaddr *sock_addr = addr;\r\nif (!is_valid_ether_addr(sock_addr->sa_data))\r\nreturn -EADDRNOTAVAIL;\r\nmemcpy(ndev->dev_addr, sock_addr->sa_data, ETH_ALEN);\r\nw5100_write_macaddr(priv);\r\nreturn 0;\r\n}\r\nstatic int w5100_open(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_info(priv, ifup, ndev, "enabling\n");\r\nw5100_hw_start(priv);\r\nnapi_enable(&priv->napi);\r\nnetif_start_queue(ndev);\r\nif (!gpio_is_valid(priv->link_gpio) ||\r\ngpio_get_value(priv->link_gpio) != 0)\r\nnetif_carrier_on(ndev);\r\nreturn 0;\r\n}\r\nstatic int w5100_stop(struct net_device *ndev)\r\n{\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nnetif_info(priv, ifdown, ndev, "shutting down\n");\r\nw5100_hw_close(priv);\r\nnetif_carrier_off(ndev);\r\nnetif_stop_queue(ndev);\r\nnapi_disable(&priv->napi);\r\nreturn 0;\r\n}\r\nstatic int w5100_hw_probe(struct platform_device *pdev)\r\n{\r\nstruct wiznet_platform_data *data = dev_get_platdata(&pdev->dev);\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nconst char *name = netdev_name(ndev);\r\nstruct resource *mem;\r\nint mem_size;\r\nint irq;\r\nint ret;\r\nif (data && is_valid_ether_addr(data->mac_addr)) {\r\nmemcpy(ndev->dev_addr, data->mac_addr, ETH_ALEN);\r\n} else {\r\neth_hw_addr_random(ndev);\r\n}\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem)\r\nreturn -ENXIO;\r\nmem_size = resource_size(mem);\r\npriv->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(priv->base))\r\nreturn PTR_ERR(priv->base);\r\nspin_lock_init(&priv->reg_lock);\r\npriv->indirect = mem_size < W5100_BUS_DIRECT_SIZE;\r\nif (priv->indirect) {\r\npriv->read = w5100_read_indirect;\r\npriv->write = w5100_write_indirect;\r\npriv->read16 = w5100_read16_indirect;\r\npriv->write16 = w5100_write16_indirect;\r\npriv->readbuf = w5100_readbuf_indirect;\r\npriv->writebuf = w5100_writebuf_indirect;\r\n} else {\r\npriv->read = w5100_read_direct;\r\npriv->write = w5100_write_direct;\r\npriv->read16 = w5100_read16_direct;\r\npriv->write16 = w5100_write16_direct;\r\npriv->readbuf = w5100_readbuf_direct;\r\npriv->writebuf = w5100_writebuf_direct;\r\n}\r\nw5100_hw_reset(priv);\r\nif (w5100_read16(priv, W5100_RTR) != RTR_DEFAULT)\r\nreturn -ENODEV;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\nret = request_irq(irq, w5100_interrupt,\r\nIRQ_TYPE_LEVEL_LOW, name, ndev);\r\nif (ret < 0)\r\nreturn ret;\r\npriv->irq = irq;\r\npriv->link_gpio = data ? data->link_gpio : -EINVAL;\r\nif (gpio_is_valid(priv->link_gpio)) {\r\nchar *link_name = devm_kzalloc(&pdev->dev, 16, GFP_KERNEL);\r\nif (!link_name)\r\nreturn -ENOMEM;\r\nsnprintf(link_name, 16, "%s-link", name);\r\npriv->link_irq = gpio_to_irq(priv->link_gpio);\r\nif (request_any_context_irq(priv->link_irq, w5100_detect_link,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\nlink_name, priv->ndev) < 0)\r\npriv->link_gpio = -EINVAL;\r\n}\r\nnetdev_info(ndev, "at 0x%llx irq %d\n", (u64)mem->start, irq);\r\nreturn 0;\r\n}\r\nstatic int w5100_probe(struct platform_device *pdev)\r\n{\r\nstruct w5100_priv *priv;\r\nstruct net_device *ndev;\r\nint err;\r\nndev = alloc_etherdev(sizeof(*priv));\r\nif (!ndev)\r\nreturn -ENOMEM;\r\nSET_NETDEV_DEV(ndev, &pdev->dev);\r\nplatform_set_drvdata(pdev, ndev);\r\npriv = netdev_priv(ndev);\r\npriv->ndev = ndev;\r\nether_setup(ndev);\r\nndev->netdev_ops = &w5100_netdev_ops;\r\nndev->ethtool_ops = &w5100_ethtool_ops;\r\nndev->watchdog_timeo = HZ;\r\nnetif_napi_add(ndev, &priv->napi, w5100_napi_poll, 16);\r\nndev->features |= NETIF_F_VLAN_CHALLENGED;\r\nerr = register_netdev(ndev);\r\nif (err < 0)\r\ngoto err_register;\r\nerr = w5100_hw_probe(pdev);\r\nif (err < 0)\r\ngoto err_hw_probe;\r\nreturn 0;\r\nerr_hw_probe:\r\nunregister_netdev(ndev);\r\nerr_register:\r\nfree_netdev(ndev);\r\nreturn err;\r\n}\r\nstatic int w5100_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nw5100_hw_reset(priv);\r\nfree_irq(priv->irq, ndev);\r\nif (gpio_is_valid(priv->link_gpio))\r\nfree_irq(priv->link_irq, ndev);\r\nunregister_netdev(ndev);\r\nfree_netdev(ndev);\r\nreturn 0;\r\n}\r\nstatic int w5100_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nnetif_carrier_off(ndev);\r\nnetif_device_detach(ndev);\r\nw5100_hw_close(priv);\r\n}\r\nreturn 0;\r\n}\r\nstatic int w5100_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct w5100_priv *priv = netdev_priv(ndev);\r\nif (netif_running(ndev)) {\r\nw5100_hw_reset(priv);\r\nw5100_hw_start(priv);\r\nnetif_device_attach(ndev);\r\nif (!gpio_is_valid(priv->link_gpio) ||\r\ngpio_get_value(priv->link_gpio) != 0)\r\nnetif_carrier_on(ndev);\r\n}\r\nreturn 0;\r\n}

int hfs_setxattr(struct dentry *dentry, const char *name,\r\nconst void *value, size_t size, int flags)\r\n{\r\nstruct inode *inode = dentry->d_inode;\r\nstruct hfs_find_data fd;\r\nhfs_cat_rec rec;\r\nstruct hfs_cat_file *file;\r\nint res;\r\nif (!S_ISREG(inode->i_mode) || HFS_IS_RSRC(inode))\r\nreturn -EOPNOTSUPP;\r\nres = hfs_find_init(HFS_SB(inode->i_sb)->cat_tree, &fd);\r\nif (res)\r\nreturn res;\r\nfd.search_key->cat = HFS_I(inode)->cat_key;\r\nres = hfs_brec_find(&fd);\r\nif (res)\r\ngoto out;\r\nhfs_bnode_read(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\nfile = &rec.file;\r\nif (!strcmp(name, "hfs.type")) {\r\nif (size == 4)\r\nmemcpy(&file->UsrWds.fdType, value, 4);\r\nelse\r\nres = -ERANGE;\r\n} else if (!strcmp(name, "hfs.creator")) {\r\nif (size == 4)\r\nmemcpy(&file->UsrWds.fdCreator, value, 4);\r\nelse\r\nres = -ERANGE;\r\n} else\r\nres = -EOPNOTSUPP;\r\nif (!res)\r\nhfs_bnode_write(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\nout:\r\nhfs_find_exit(&fd);\r\nreturn res;\r\n}\r\nssize_t hfs_getxattr(struct dentry *dentry, const char *name,\r\nvoid *value, size_t size)\r\n{\r\nstruct inode *inode = dentry->d_inode;\r\nstruct hfs_find_data fd;\r\nhfs_cat_rec rec;\r\nstruct hfs_cat_file *file;\r\nssize_t res = 0;\r\nif (!S_ISREG(inode->i_mode) || HFS_IS_RSRC(inode))\r\nreturn -EOPNOTSUPP;\r\nif (size) {\r\nres = hfs_find_init(HFS_SB(inode->i_sb)->cat_tree, &fd);\r\nif (res)\r\nreturn res;\r\nfd.search_key->cat = HFS_I(inode)->cat_key;\r\nres = hfs_brec_find(&fd);\r\nif (res)\r\ngoto out;\r\nhfs_bnode_read(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\n}\r\nfile = &rec.file;\r\nif (!strcmp(name, "hfs.type")) {\r\nif (size >= 4) {\r\nmemcpy(value, &file->UsrWds.fdType, 4);\r\nres = 4;\r\n} else\r\nres = size ? -ERANGE : 4;\r\n} else if (!strcmp(name, "hfs.creator")) {\r\nif (size >= 4) {\r\nmemcpy(value, &file->UsrWds.fdCreator, 4);\r\nres = 4;\r\n} else\r\nres = size ? -ERANGE : 4;\r\n} else\r\nres = -ENODATA;\r\nout:\r\nif (size)\r\nhfs_find_exit(&fd);\r\nreturn res;\r\n}\r\nssize_t hfs_listxattr(struct dentry *dentry, char *buffer, size_t size)\r\n{\r\nstruct inode *inode = dentry->d_inode;\r\nif (!S_ISREG(inode->i_mode) || HFS_IS_RSRC(inode))\r\nreturn -EOPNOTSUPP;\r\nif (!buffer || !size)\r\nreturn HFS_ATTRLIST_SIZE;\r\nif (size < HFS_ATTRLIST_SIZE)\r\nreturn -ERANGE;\r\nstrcpy(buffer, "hfs.type");\r\nstrcpy(buffer + sizeof("hfs.type"), "hfs.creator");\r\nreturn HFS_ATTRLIST_SIZE;\r\n}

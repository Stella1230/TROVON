static int __init bcm63xx_detect_flash_type(void)\r\n{\r\nu32 val;\r\nswitch (bcm63xx_get_cpu_id()) {\r\ncase BCM6328_CPU_ID:\r\nval = bcm_misc_readl(MISC_STRAPBUS_6328_REG);\r\nif (val & STRAPBUS_6328_BOOT_SEL_SERIAL)\r\nreturn BCM63XX_FLASH_TYPE_SERIAL;\r\nelse\r\nreturn BCM63XX_FLASH_TYPE_NAND;\r\ncase BCM6338_CPU_ID:\r\ncase BCM6345_CPU_ID:\r\ncase BCM6348_CPU_ID:\r\nreturn BCM63XX_FLASH_TYPE_PARALLEL;\r\ncase BCM3368_CPU_ID:\r\ncase BCM6358_CPU_ID:\r\nval = bcm_gpio_readl(GPIO_STRAPBUS_REG);\r\nif (val & STRAPBUS_6358_BOOT_SEL_PARALLEL)\r\nreturn BCM63XX_FLASH_TYPE_PARALLEL;\r\nelse\r\nreturn BCM63XX_FLASH_TYPE_SERIAL;\r\ncase BCM6362_CPU_ID:\r\nval = bcm_misc_readl(MISC_STRAPBUS_6362_REG);\r\nif (val & STRAPBUS_6362_BOOT_SEL_SERIAL)\r\nreturn BCM63XX_FLASH_TYPE_SERIAL;\r\nelse\r\nreturn BCM63XX_FLASH_TYPE_NAND;\r\ncase BCM6368_CPU_ID:\r\nval = bcm_gpio_readl(GPIO_STRAPBUS_REG);\r\nswitch (val & STRAPBUS_6368_BOOT_SEL_MASK) {\r\ncase STRAPBUS_6368_BOOT_SEL_NAND:\r\nreturn BCM63XX_FLASH_TYPE_NAND;\r\ncase STRAPBUS_6368_BOOT_SEL_SERIAL:\r\nreturn BCM63XX_FLASH_TYPE_SERIAL;\r\ncase STRAPBUS_6368_BOOT_SEL_PARALLEL:\r\nreturn BCM63XX_FLASH_TYPE_PARALLEL;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nint __init bcm63xx_flash_register(void)\r\n{\r\nint flash_type;\r\nu32 val;\r\nflash_type = bcm63xx_detect_flash_type();\r\nswitch (flash_type) {\r\ncase BCM63XX_FLASH_TYPE_PARALLEL:\r\nval = bcm_mpi_readl(MPI_CSBASE_REG(0));\r\nval &= MPI_CSBASE_BASE_MASK;\r\nmtd_resources[0].start = val;\r\nmtd_resources[0].end = 0x1FFFFFFF;\r\nreturn platform_device_register(&mtd_dev);\r\ncase BCM63XX_FLASH_TYPE_SERIAL:\r\npr_warn("unsupported serial flash detected\n");\r\nreturn -ENODEV;\r\ncase BCM63XX_FLASH_TYPE_NAND:\r\npr_warn("unsupported NAND flash detected\n");\r\nreturn -ENODEV;\r\ndefault:\r\npr_err("flash detection failed for BCM%x: %d\n",\r\nbcm63xx_get_cpu_id(), flash_type);\r\nreturn -ENODEV;\r\n}\r\n}

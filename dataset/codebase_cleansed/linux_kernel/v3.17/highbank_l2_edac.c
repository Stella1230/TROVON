static irqreturn_t highbank_l2_err_handler(int irq, void *dev_id)\r\n{\r\nstruct edac_device_ctl_info *dci = dev_id;\r\nstruct hb_l2_drvdata *drvdata = dci->pvt_info;\r\nif (irq == drvdata->sb_irq) {\r\nwritel(1, drvdata->base + SR_CLR_SB_ECC_INTR);\r\nedac_device_handle_ce(dci, 0, 0, dci->ctl_name);\r\n}\r\nif (irq == drvdata->db_irq) {\r\nwritel(1, drvdata->base + SR_CLR_DB_ECC_INTR);\r\nedac_device_handle_ue(dci, 0, 0, dci->ctl_name);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int highbank_l2_err_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *id;\r\nstruct edac_device_ctl_info *dci;\r\nstruct hb_l2_drvdata *drvdata;\r\nstruct resource *r;\r\nint res = 0;\r\ndci = edac_device_alloc_ctl_info(sizeof(*drvdata), "cpu",\r\n1, "L", 1, 2, NULL, 0, 0);\r\nif (!dci)\r\nreturn -ENOMEM;\r\ndrvdata = dci->pvt_info;\r\ndci->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, dci);\r\nif (!devres_open_group(&pdev->dev, NULL, GFP_KERNEL))\r\nreturn -ENOMEM;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!r) {\r\ndev_err(&pdev->dev, "Unable to get mem resource\n");\r\nres = -ENODEV;\r\ngoto err;\r\n}\r\nif (!devm_request_mem_region(&pdev->dev, r->start,\r\nresource_size(r), dev_name(&pdev->dev))) {\r\ndev_err(&pdev->dev, "Error while requesting mem region\n");\r\nres = -EBUSY;\r\ngoto err;\r\n}\r\ndrvdata->base = devm_ioremap(&pdev->dev, r->start, resource_size(r));\r\nif (!drvdata->base) {\r\ndev_err(&pdev->dev, "Unable to map regs\n");\r\nres = -ENOMEM;\r\ngoto err;\r\n}\r\nid = of_match_device(hb_l2_err_of_match, &pdev->dev);\r\ndci->mod_name = pdev->dev.driver->name;\r\ndci->ctl_name = id ? id->compatible : "unknown";\r\ndci->dev_name = dev_name(&pdev->dev);\r\nif (edac_device_add_device(dci))\r\ngoto err;\r\ndrvdata->db_irq = platform_get_irq(pdev, 0);\r\nres = devm_request_irq(&pdev->dev, drvdata->db_irq,\r\nhighbank_l2_err_handler,\r\n0, dev_name(&pdev->dev), dci);\r\nif (res < 0)\r\ngoto err2;\r\ndrvdata->sb_irq = platform_get_irq(pdev, 1);\r\nres = devm_request_irq(&pdev->dev, drvdata->sb_irq,\r\nhighbank_l2_err_handler,\r\n0, dev_name(&pdev->dev), dci);\r\nif (res < 0)\r\ngoto err2;\r\ndevres_close_group(&pdev->dev, NULL);\r\nreturn 0;\r\nerr2:\r\nedac_device_del_device(&pdev->dev);\r\nerr:\r\ndevres_release_group(&pdev->dev, NULL);\r\nedac_device_free_ctl_info(dci);\r\nreturn res;\r\n}\r\nstatic int highbank_l2_err_remove(struct platform_device *pdev)\r\n{\r\nstruct edac_device_ctl_info *dci = platform_get_drvdata(pdev);\r\nedac_device_del_device(&pdev->dev);\r\nedac_device_free_ctl_info(dci);\r\nreturn 0;\r\n}

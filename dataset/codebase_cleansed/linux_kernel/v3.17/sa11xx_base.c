static unsigned int\r\nsa1100_pcmcia_default_mecr_timing(struct soc_pcmcia_socket *skt,\r\nunsigned int cpu_speed,\r\nunsigned int cmd_time)\r\n{\r\nreturn sa1100_pcmcia_mecr_bs(cmd_time, cpu_speed);\r\n}\r\nstatic int\r\nsa1100_pcmcia_set_mecr(struct soc_pcmcia_socket *skt, unsigned int cpu_clock)\r\n{\r\nstruct soc_pcmcia_timing timing;\r\nu32 mecr, old_mecr;\r\nunsigned long flags;\r\nunsigned int bs_io, bs_mem, bs_attr;\r\nsoc_common_pcmcia_get_timing(skt, &timing);\r\nbs_io = skt->ops->get_timing(skt, cpu_clock, timing.io);\r\nbs_mem = skt->ops->get_timing(skt, cpu_clock, timing.mem);\r\nbs_attr = skt->ops->get_timing(skt, cpu_clock, timing.attr);\r\nlocal_irq_save(flags);\r\nold_mecr = mecr = MECR;\r\nMECR_FAST_SET(mecr, skt->nr, 0);\r\nMECR_BSIO_SET(mecr, skt->nr, bs_io);\r\nMECR_BSA_SET(mecr, skt->nr, bs_attr);\r\nMECR_BSM_SET(mecr, skt->nr, bs_mem);\r\nif (old_mecr != mecr)\r\nMECR = mecr;\r\nlocal_irq_restore(flags);\r\ndebug(skt, 2, "FAST %X BSM %X BSA %X BSIO %X\n",\r\nMECR_FAST_GET(mecr, skt->nr),\r\nMECR_BSM_GET(mecr, skt->nr), MECR_BSA_GET(mecr, skt->nr),\r\nMECR_BSIO_GET(mecr, skt->nr));\r\nreturn 0;\r\n}\r\nstatic int\r\nsa1100_pcmcia_frequency_change(struct soc_pcmcia_socket *skt,\r\nunsigned long val,\r\nstruct cpufreq_freqs *freqs)\r\n{\r\nswitch (val) {\r\ncase CPUFREQ_PRECHANGE:\r\nif (freqs->new > freqs->old)\r\nsa1100_pcmcia_set_mecr(skt, freqs->new);\r\nbreak;\r\ncase CPUFREQ_POSTCHANGE:\r\nif (freqs->new < freqs->old)\r\nsa1100_pcmcia_set_mecr(skt, freqs->new);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nsa1100_pcmcia_set_timing(struct soc_pcmcia_socket *skt)\r\n{\r\nreturn sa1100_pcmcia_set_mecr(skt, cpufreq_get(0));\r\n}\r\nstatic int\r\nsa1100_pcmcia_show_timing(struct soc_pcmcia_socket *skt, char *buf)\r\n{\r\nstruct soc_pcmcia_timing timing;\r\nunsigned int clock = cpufreq_get(0);\r\nunsigned long mecr = MECR;\r\nchar *p = buf;\r\nsoc_common_pcmcia_get_timing(skt, &timing);\r\np+=sprintf(p, "I/O : %u (%u)\n", timing.io,\r\nsa1100_pcmcia_cmd_time(clock, MECR_BSIO_GET(mecr, skt->nr)));\r\np+=sprintf(p, "attribute: %u (%u)\n", timing.attr,\r\nsa1100_pcmcia_cmd_time(clock, MECR_BSA_GET(mecr, skt->nr)));\r\np+=sprintf(p, "common : %u (%u)\n", timing.mem,\r\nsa1100_pcmcia_cmd_time(clock, MECR_BSM_GET(mecr, skt->nr)));\r\nreturn p - buf;\r\n}\r\nint sa11xx_drv_pcmcia_add_one(struct soc_pcmcia_socket *skt)\r\n{\r\nskt->res_skt.start = _PCMCIA(skt->nr);\r\nskt->res_skt.end = _PCMCIA(skt->nr) + PCMCIASp - 1;\r\nskt->res_skt.name = skt_names[skt->nr];\r\nskt->res_skt.flags = IORESOURCE_MEM;\r\nskt->res_io.start = _PCMCIAIO(skt->nr);\r\nskt->res_io.end = _PCMCIAIO(skt->nr) + PCMCIAIOSp - 1;\r\nskt->res_io.name = "io";\r\nskt->res_io.flags = IORESOURCE_MEM | IORESOURCE_BUSY;\r\nskt->res_mem.start = _PCMCIAMem(skt->nr);\r\nskt->res_mem.end = _PCMCIAMem(skt->nr) + PCMCIAMemSp - 1;\r\nskt->res_mem.name = "memory";\r\nskt->res_mem.flags = IORESOURCE_MEM;\r\nskt->res_attr.start = _PCMCIAAttr(skt->nr);\r\nskt->res_attr.end = _PCMCIAAttr(skt->nr) + PCMCIAAttrSp - 1;\r\nskt->res_attr.name = "attribute";\r\nskt->res_attr.flags = IORESOURCE_MEM;\r\nreturn soc_pcmcia_add_one(skt);\r\n}\r\nvoid sa11xx_drv_pcmcia_ops(struct pcmcia_low_level *ops)\r\n{\r\nif (!ops->get_timing)\r\nops->get_timing = sa1100_pcmcia_default_mecr_timing;\r\nops->set_timing = sa1100_pcmcia_set_timing;\r\nops->show_timing = sa1100_pcmcia_show_timing;\r\n#ifdef CONFIG_CPU_FREQ\r\nops->frequency_change = sa1100_pcmcia_frequency_change;\r\n#endif\r\n}\r\nint sa11xx_drv_pcmcia_probe(struct device *dev, struct pcmcia_low_level *ops,\r\nint first, int nr)\r\n{\r\nstruct skt_dev_info *sinfo;\r\nstruct soc_pcmcia_socket *skt;\r\nint i, ret = 0;\r\nsa11xx_drv_pcmcia_ops(ops);\r\nsinfo = kzalloc(SKT_DEV_INFO_SIZE(nr), GFP_KERNEL);\r\nif (!sinfo)\r\nreturn -ENOMEM;\r\nsinfo->nskt = nr;\r\nfor (i = 0; i < nr; i++) {\r\nskt = &sinfo->skt[i];\r\nskt->nr = first + i;\r\nsoc_pcmcia_init_one(skt, ops, dev);\r\nret = sa11xx_drv_pcmcia_add_one(skt);\r\nif (ret)\r\nbreak;\r\n}\r\nif (ret) {\r\nwhile (--i >= 0)\r\nsoc_pcmcia_remove_one(&sinfo->skt[i]);\r\nkfree(sinfo);\r\n} else {\r\ndev_set_drvdata(dev, sinfo);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init sa11xx_pcmcia_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit sa11xx_pcmcia_exit(void) {}

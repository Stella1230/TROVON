static int __init divert_init(void)\r\n{\r\nint i;\r\nif (divert_dev_init()) {\r\nprintk(KERN_WARNING "dss1_divert: cannot install device, not loaded\n");\r\nreturn (-EIO);\r\n}\r\nif ((i = DIVERT_REG_NAME(&divert_if)) != DIVERT_NO_ERR) {\r\ndivert_dev_deinit();\r\nprintk(KERN_WARNING "dss1_divert: error %d registering module, not loaded\n", i);\r\nreturn (-EIO);\r\n}\r\nprintk(KERN_INFO "dss1_divert module successfully installed\n");\r\nreturn (0);\r\n}\r\nstatic void __exit divert_exit(void)\r\n{\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&divert_lock, flags);\r\ndivert_if.cmd = DIVERT_CMD_REL;\r\nif ((i = DIVERT_REG_NAME(&divert_if)) != DIVERT_NO_ERR) {\r\nprintk(KERN_WARNING "dss1_divert: error %d releasing module\n", i);\r\nspin_unlock_irqrestore(&divert_lock, flags);\r\nreturn;\r\n}\r\nif (divert_dev_deinit()) {\r\nprintk(KERN_WARNING "dss1_divert: device busy, remove cancelled\n");\r\nspin_unlock_irqrestore(&divert_lock, flags);\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&divert_lock, flags);\r\ndeleterule(-1);\r\ndeleteprocs();\r\nprintk(KERN_INFO "dss1_divert module successfully removed \n");\r\n}

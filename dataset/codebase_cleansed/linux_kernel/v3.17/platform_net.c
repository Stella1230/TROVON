static void config_mac(struct xlr_net_data *nd, int phy, u32 __iomem *serdes,\r\nu32 __iomem *pcs, int rfr, int tx, int *bkt_size,\r\nstruct xlr_fmn_info *gmac_fmn_info, int phy_addr)\r\n{\r\nnd->cpu_mask = nlm_current_node()->coremask;\r\nnd->phy_interface = phy;\r\nnd->rfr_station = rfr;\r\nnd->tx_stnid = tx;\r\nnd->mii_addr = gmac0_addr;\r\nnd->serdes_addr = serdes;\r\nnd->pcs_addr = pcs;\r\nnd->gpio_addr = gpio_addr;\r\nnd->bucket_size = bkt_size;\r\nnd->gmac_fmn_info = gmac_fmn_info;\r\nnd->phy_addr = phy_addr;\r\n}\r\nstatic void net_device_init(int id, struct resource *res, int offset, int irq)\r\n{\r\nres[0].name = "gmac";\r\nres[0].start = CPHYSADDR(nlm_mmio_base(offset));\r\nres[0].end = res[0].start + 0xfff;\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].name = "gmac";\r\nres[1].start = irq;\r\nres[1].end = irq;\r\nres[1].flags = IORESOURCE_IRQ;\r\nxlr_net_dev[id].name = "xlr-net";\r\nxlr_net_dev[id].id = id;\r\nxlr_net_dev[id].num_resources = 2;\r\nxlr_net_dev[id].resource = res;\r\nxlr_net_dev[id].dev.platform_data = &ndata[id];\r\n}\r\nstatic void xls_gmac_init(void)\r\n{\r\nint mac;\r\ngmac4_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GMAC_4_OFFSET)), 0xfff);\r\ngpio_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GPIO_OFFSET)), 0xfff);\r\nswitch (nlm_prom_info.board_major_version) {\r\ncase 12:\r\nconfig_mac(&ndata[0],\r\nPHY_INTERFACE_MODE_RGMII,\r\ngmac0_addr,\r\ngmac0_addr,\r\nFMN_STNID_GMACRFR_0,\r\nFMN_STNID_GMAC0_TX0,\r\nxlr_board_fmn_config.bucket_size,\r\n&xlr_board_fmn_config.gmac[0],\r\n0);\r\nnet_device_init(0, xlr_net_res[0], xlr_gmac_offsets[0],\r\nxlr_gmac_irqs[0]);\r\nplatform_device_register(&xlr_net_dev[0]);\r\nbreak;\r\ndefault:\r\nfor (mac = 0; mac < 4; mac++) {\r\nconfig_mac(&ndata[mac],\r\nPHY_INTERFACE_MODE_SGMII,\r\ngmac0_addr,\r\ngmac0_addr,\r\nFMN_STNID_GMACRFR_0,\r\nFMN_STNID_GMAC0_TX0 + mac,\r\nxlr_board_fmn_config.bucket_size,\r\n&xlr_board_fmn_config.gmac[0],\r\nmac + 0x10);\r\nnet_device_init(mac, xlr_net_res[mac],\r\nxlr_gmac_offsets[mac],\r\nxlr_gmac_irqs[mac]);\r\nplatform_device_register(&xlr_net_dev[mac]);\r\n}\r\nfor (mac = 4; mac < MAX_NUM_XLS_GMAC; mac++) {\r\nconfig_mac(&ndata[mac],\r\nPHY_INTERFACE_MODE_SGMII,\r\ngmac4_addr,\r\ngmac4_addr,\r\nFMN_STNID_GMAC1_FR_0,\r\nFMN_STNID_GMAC1_TX0 + mac - 4,\r\nxlr_board_fmn_config.bucket_size,\r\n&xlr_board_fmn_config.gmac[1],\r\nmac + 0x10);\r\nnet_device_init(mac, xlr_net_res[mac],\r\nxlr_gmac_offsets[mac],\r\nxlr_gmac_irqs[mac]);\r\nplatform_device_register(&xlr_net_dev[mac]);\r\n}\r\n}\r\n}\r\nstatic void xlr_gmac_init(void)\r\n{\r\nint mac;\r\nfor (mac = 0; mac < MAX_NUM_XLR_GMAC; mac++) {\r\nconfig_mac(&ndata[mac],\r\nPHY_INTERFACE_MODE_RGMII,\r\n0,\r\n0,\r\nFMN_STNID_GMACRFR_0,\r\nFMN_STNID_GMAC0_TX0,\r\nxlr_board_fmn_config.bucket_size,\r\n&xlr_board_fmn_config.gmac[0],\r\nmac);\r\nnet_device_init(mac, xlr_net_res[mac], xlr_gmac_offsets[mac],\r\nxlr_gmac_irqs[mac]);\r\nplatform_device_register(&xlr_net_dev[mac]);\r\n}\r\n}\r\nstatic int __init xlr_net_init(void)\r\n{\r\ngmac0_addr = ioremap(CPHYSADDR(\r\nnlm_mmio_base(NETLOGIC_IO_GMAC_0_OFFSET)), 0xfff);\r\nif (nlm_chip_is_xls())\r\nxls_gmac_init();\r\nelse\r\nxlr_gmac_init();\r\nreturn 0;\r\n}

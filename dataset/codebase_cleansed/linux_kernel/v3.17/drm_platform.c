static int drm_get_platform_dev(struct platform_device *platdev,\r\nstruct drm_driver *driver)\r\n{\r\nstruct drm_device *dev;\r\nint ret;\r\nDRM_DEBUG("\n");\r\ndev = drm_dev_alloc(driver, &platdev->dev);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->platformdev = platdev;\r\nret = drm_dev_register(dev, 0);\r\nif (ret)\r\ngoto err_free;\r\nDRM_INFO("Initialized %s %d.%d.%d %s on minor %d\n",\r\ndriver->name, driver->major, driver->minor, driver->patchlevel,\r\ndriver->date, dev->primary->index);\r\nreturn 0;\r\nerr_free:\r\ndrm_dev_unref(dev);\r\nreturn ret;\r\n}\r\nstatic int drm_platform_set_busid(struct drm_device *dev, struct drm_master *master)\r\n{\r\nint len, ret, id;\r\nmaster->unique_len = 13 + strlen(dev->platformdev->name);\r\nmaster->unique_size = master->unique_len;\r\nmaster->unique = kmalloc(master->unique_len + 1, GFP_KERNEL);\r\nif (master->unique == NULL)\r\nreturn -ENOMEM;\r\nid = dev->platformdev->id;\r\nif (id == -1)\r\nid = 0;\r\nlen = snprintf(master->unique, master->unique_len,\r\n"platform:%s:%02d", dev->platformdev->name, id);\r\nif (len > master->unique_len) {\r\nDRM_ERROR("Unique buffer overflowed\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nint drm_platform_init(struct drm_driver *driver, struct platform_device *platform_device)\r\n{\r\nDRM_DEBUG("\n");\r\ndriver->bus = &drm_platform_bus;\r\nreturn drm_get_platform_dev(platform_device, driver);\r\n}

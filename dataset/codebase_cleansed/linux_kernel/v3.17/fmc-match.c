void *fru_alloc(size_t size)\r\n{\r\nreturn kzalloc(size, GFP_KERNEL);\r\n}\r\nint fmc_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct fmc_driver *fdrv = to_fmc_driver(drv);\r\nstruct fmc_device *fdev = to_fmc_device(dev);\r\nstruct fmc_fru_id *fid;\r\nint i, matched = 0;\r\nfid = fdrv->id_table.fru_id;\r\nif (!fid) {\r\ndev_warn(&fdev->dev, "Driver has no ID: matches all\n");\r\nmatched = 1;\r\n} else {\r\nif (!fdev->id.manufacturer || !fdev->id.product_name)\r\nreturn 0;\r\nfor (i = 0; i < fdrv->id_table.fru_id_nr; i++, fid++) {\r\nif (fid->manufacturer &&\r\nstrcmp(fid->manufacturer, fdev->id.manufacturer))\r\ncontinue;\r\nif (fid->product_name &&\r\nstrcmp(fid->product_name, fdev->id.product_name))\r\ncontinue;\r\nmatched = 1;\r\nbreak;\r\n}\r\n}\r\nreturn matched;\r\n}\r\nint fmc_fill_id_info(struct fmc_device *fmc)\r\n{\r\nstruct fru_common_header *h;\r\nstruct fru_board_info_area *bia;\r\nint ret, allocated = 0;\r\nif (fmc->eeprom_len && !fmc->eeprom) {\r\nfmc->eeprom = kzalloc(fmc->eeprom_len, GFP_KERNEL);\r\nif (!fmc->eeprom)\r\nreturn -ENOMEM;\r\nallocated = 1;\r\nret = fmc->op->read_ee(fmc, 0, fmc->eeprom, fmc->eeprom_len);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nif (!fmc->eeprom)\r\nreturn 0;\r\ndev_info(fmc->hwdev, "mezzanine %i\n", fmc->slot_id);\r\nh = (void *)fmc->eeprom;\r\nif (h->format != 1) {\r\npr_info(" EEPROM has no FRU information\n");\r\ngoto out;\r\n}\r\nif (!fru_header_cksum_ok(h)) {\r\npr_info(" FRU: wrong header checksum\n");\r\ngoto out;\r\n}\r\nbia = fru_get_board_area(h);\r\nif (!fru_bia_cksum_ok(bia)) {\r\npr_info(" FRU: wrong board area checksum\n");\r\ngoto out;\r\n}\r\nfmc->id.manufacturer = fru_get_board_manufacturer(h);\r\nfmc->id.product_name = fru_get_product_name(h);\r\npr_info(" Manufacturer: %s\n", fmc->id.manufacturer);\r\npr_info(" Product name: %s\n", fmc->id.product_name);\r\nfmc->mezzanine_name = kstrdup(fmc->id.product_name, GFP_KERNEL);\r\nout:\r\nif (allocated) {\r\nkfree(fmc->eeprom);\r\nfmc->eeprom = NULL;\r\n}\r\nreturn 0;\r\n}\r\nvoid fmc_free_id_info(struct fmc_device *fmc)\r\n{\r\nkfree(fmc->mezzanine_name);\r\nkfree(fmc->id.manufacturer);\r\nkfree(fmc->id.product_name);\r\n}

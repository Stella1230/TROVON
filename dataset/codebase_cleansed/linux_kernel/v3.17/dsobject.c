static acpi_status\r\nacpi_ds_build_internal_object(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op,\r\nunion acpi_operand_object **obj_desc_ptr)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nacpi_object_type type;\r\nACPI_FUNCTION_TRACE(ds_build_internal_object);\r\n*obj_desc_ptr = NULL;\r\nif (op->common.aml_opcode == AML_INT_NAMEPATH_OP) {\r\nif (!op->common.node) {\r\nstatus = acpi_ns_lookup(walk_state->scope_info,\r\nop->common.value.string,\r\nACPI_TYPE_ANY,\r\nACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT |\r\nACPI_NS_DONT_OPEN_SCOPE, NULL,\r\nACPI_CAST_INDIRECT_PTR(struct\r\nacpi_namespace_node,\r\n&(op->\r\ncommon.\r\nnode)));\r\nif (ACPI_FAILURE(status)) {\r\nif ((status == AE_NOT_FOUND)\r\n&& (acpi_gbl_enable_interpreter_slack)\r\n&&\r\n((op->common.parent->common.aml_opcode ==\r\nAML_PACKAGE_OP)\r\n|| (op->common.parent->common.aml_opcode ==\r\nAML_VAR_PACKAGE_OP))) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Ignoring unresolved reference in package [%4.4s]\n",\r\nwalk_state->\r\nscope_info->scope.\r\nnode->name.ascii));\r\nreturn_ACPI_STATUS(AE_OK);\r\n} else {\r\nACPI_ERROR_NAMESPACE(op->common.value.\r\nstring, status);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nif ((op->common.parent->common.aml_opcode == AML_PACKAGE_OP) ||\r\n(op->common.parent->common.aml_opcode ==\r\nAML_VAR_PACKAGE_OP)) {\r\nobj_desc =\r\nACPI_CAST_PTR(union acpi_operand_object,\r\nop->common.node);\r\nstatus =\r\nacpi_ex_resolve_node_to_value(ACPI_CAST_INDIRECT_PTR\r\n(struct\r\nacpi_namespace_node,\r\n&obj_desc),\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\ntype = op->common.node->type;\r\nif (type == ACPI_TYPE_LOCAL_ALIAS) {\r\ntype = obj_desc->common.type;\r\nop->common.node =\r\nACPI_CAST_PTR(struct acpi_namespace_node,\r\nop->common.node->object);\r\n}\r\nswitch (type) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_THERMAL:\r\nacpi_ut_add_reference(op->common.node->object);\r\ncase ACPI_TYPE_MUTEX:\r\ncase ACPI_TYPE_METHOD:\r\ncase ACPI_TYPE_POWER:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_EVENT:\r\ncase ACPI_TYPE_REGION:\r\nbreak;\r\ndefault:\r\ngoto exit;\r\n}\r\n}\r\n}\r\nobj_desc = acpi_ut_create_internal_object((acpi_ps_get_opcode_info\r\n(op->common.aml_opcode))->\r\nobject_type);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nstatus =\r\nacpi_ds_init_object_from_op(walk_state, op, op->common.aml_opcode,\r\n&obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nexit:\r\n*obj_desc_ptr = obj_desc;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_build_internal_buffer_obj(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op,\r\nu32 buffer_length,\r\nunion acpi_operand_object **obj_desc_ptr)\r\n{\r\nunion acpi_parse_object *arg;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_parse_object *byte_list;\r\nu32 byte_list_length = 0;\r\nACPI_FUNCTION_TRACE(ds_build_internal_buffer_obj);\r\nobj_desc = *obj_desc_ptr;\r\nif (!obj_desc) {\r\nobj_desc = acpi_ut_create_internal_object(ACPI_TYPE_BUFFER);\r\n*obj_desc_ptr = obj_desc;\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\n}\r\narg = op->common.value.arg;\r\nbyte_list = arg->named.next;\r\nif (byte_list) {\r\nif (byte_list->common.aml_opcode != AML_INT_BYTELIST_OP) {\r\nACPI_ERROR((AE_INFO,\r\n"Expecting bytelist, found AML opcode 0x%X in op %p",\r\nbyte_list->common.aml_opcode, byte_list));\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn (AE_TYPE);\r\n}\r\nbyte_list_length = (u32) byte_list->common.value.integer;\r\n}\r\nobj_desc->buffer.length = buffer_length;\r\nif (byte_list_length > buffer_length) {\r\nobj_desc->buffer.length = byte_list_length;\r\n}\r\nif (obj_desc->buffer.length == 0) {\r\nobj_desc->buffer.pointer = NULL;\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Buffer defined with zero length in AML, creating\n"));\r\n} else {\r\nobj_desc->buffer.pointer =\r\nACPI_ALLOCATE_ZEROED(obj_desc->buffer.length);\r\nif (!obj_desc->buffer.pointer) {\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nif (byte_list) {\r\nACPI_MEMCPY(obj_desc->buffer.pointer,\r\nbyte_list->named.data, byte_list_length);\r\n}\r\n}\r\nobj_desc->buffer.flags |= AOPOBJ_DATA_VALID;\r\nop->common.node = ACPI_CAST_PTR(struct acpi_namespace_node, obj_desc);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_build_internal_package_obj(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op,\r\nu32 element_count,\r\nunion acpi_operand_object **obj_desc_ptr)\r\n{\r\nunion acpi_parse_object *arg;\r\nunion acpi_parse_object *parent;\r\nunion acpi_operand_object *obj_desc = NULL;\r\nacpi_status status = AE_OK;\r\nu32 i;\r\nu16 index;\r\nu16 reference_count;\r\nACPI_FUNCTION_TRACE(ds_build_internal_package_obj);\r\nparent = op->common.parent;\r\nwhile ((parent->common.aml_opcode == AML_PACKAGE_OP) ||\r\n(parent->common.aml_opcode == AML_VAR_PACKAGE_OP)) {\r\nparent = parent->common.parent;\r\n}\r\nobj_desc = *obj_desc_ptr;\r\nif (!obj_desc) {\r\nobj_desc = acpi_ut_create_internal_object(ACPI_TYPE_PACKAGE);\r\n*obj_desc_ptr = obj_desc;\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nobj_desc->package.node = parent->common.node;\r\n}\r\nobj_desc->package.elements = ACPI_ALLOCATE_ZEROED(((acpi_size)\r\nelement_count +\r\n1) * sizeof(void *));\r\nif (!obj_desc->package.elements) {\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nobj_desc->package.count = element_count;\r\narg = op->common.value.arg;\r\narg = arg->common.next;\r\nfor (i = 0; arg && (i < element_count); i++) {\r\nif (arg->common.aml_opcode == AML_INT_RETURN_VALUE_OP) {\r\nif (arg->common.node->type == ACPI_TYPE_METHOD) {\r\narg->common.aml_opcode = AML_INT_NAMEPATH_OP;\r\nstatus =\r\nacpi_ds_build_internal_object(walk_state,\r\narg,\r\n&obj_desc->\r\npackage.\r\nelements[i]);\r\n} else {\r\nobj_desc->package.elements[i] =\r\nACPI_CAST_PTR(union acpi_operand_object,\r\narg->common.node);\r\n}\r\n} else {\r\nstatus = acpi_ds_build_internal_object(walk_state, arg,\r\n&obj_desc->\r\npackage.\r\nelements[i]);\r\n}\r\nif (*obj_desc_ptr) {\r\nreference_count =\r\n(*obj_desc_ptr)->common.reference_count;\r\nif (reference_count > 1) {\r\nfor (index = 0; index < (reference_count - 1);\r\nindex++) {\r\nacpi_ut_add_reference((obj_desc->\r\npackage.\r\nelements[i]));\r\n}\r\n}\r\n}\r\narg = arg->common.next;\r\n}\r\nif (arg) {\r\nwhile (arg) {\r\nif (arg->common.node) {\r\nacpi_ut_remove_reference(ACPI_CAST_PTR\r\n(union\r\nacpi_operand_object,\r\narg->common.node));\r\narg->common.node = NULL;\r\n}\r\ni++;\r\narg = arg->common.next;\r\n}\r\nACPI_INFO((AE_INFO,\r\n"Actual Package length (%u) is larger than NumElements field (%u), truncated",\r\ni, element_count));\r\n} else if (i < element_count) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Package List length (%u) smaller than NumElements count (%u), padded with null elements\n",\r\ni, element_count));\r\n}\r\nobj_desc->package.flags |= AOPOBJ_DATA_VALID;\r\nop->common.node = ACPI_CAST_PTR(struct acpi_namespace_node, obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_create_node(struct acpi_walk_state *walk_state,\r\nstruct acpi_namespace_node *node,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_node, op);\r\nif (acpi_ns_get_attached_object(node)) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (!op->common.value.arg) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatus = acpi_ds_build_internal_object(walk_state, op->common.value.arg,\r\n&obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nnode->type = obj_desc->common.type;\r\nstatus = acpi_ns_attach_object(node, obj_desc, node->type);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_init_object_from_op(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op,\r\nu16 opcode,\r\nunion acpi_operand_object **ret_obj_desc)\r\n{\r\nconst struct acpi_opcode_info *op_info;\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ds_init_object_from_op);\r\nobj_desc = *ret_obj_desc;\r\nop_info = acpi_ps_get_opcode_info(opcode);\r\nif (op_info->class == AML_CLASS_UNKNOWN) {\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_BUFFER:\r\nobj_desc->buffer.node =\r\nACPI_CAST_PTR(struct acpi_namespace_node,\r\nwalk_state->operands[0]);\r\nobj_desc->buffer.aml_start = op->named.data;\r\nobj_desc->buffer.aml_length = op->named.length;\r\nbreak;\r\ncase ACPI_TYPE_PACKAGE:\r\nobj_desc->package.node =\r\nACPI_CAST_PTR(struct acpi_namespace_node,\r\nwalk_state->operands[0]);\r\nobj_desc->package.aml_start = op->named.data;\r\nobj_desc->package.aml_length = op->named.length;\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\nswitch (op_info->type) {\r\ncase AML_TYPE_CONSTANT:\r\nobj_desc->common.flags = AOPOBJ_AML_CONSTANT;\r\nswitch (opcode) {\r\ncase AML_ZERO_OP:\r\nobj_desc->integer.value = 0;\r\nbreak;\r\ncase AML_ONE_OP:\r\nobj_desc->integer.value = 1;\r\nbreak;\r\ncase AML_ONES_OP:\r\nobj_desc->integer.value = ACPI_UINT64_MAX;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\n(void)acpi_ex_truncate_for32bit_table(obj_desc);\r\n#endif\r\nbreak;\r\ncase AML_REVISION_OP:\r\nobj_desc->integer.value = ACPI_CA_VERSION;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown constant opcode 0x%X",\r\nopcode));\r\nstatus = AE_AML_OPERAND_TYPE;\r\nbreak;\r\n}\r\nbreak;\r\ncase AML_TYPE_LITERAL:\r\nobj_desc->integer.value = op->common.value.integer;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nif (acpi_ex_truncate_for32bit_table(obj_desc)) {\r\nACPI_WARNING((AE_INFO,\r\n"Truncated 64-bit constant found in 32-bit table: %8.8X%8.8X => %8.8X",\r\nACPI_FORMAT_UINT64(op->common.\r\nvalue.integer),\r\n(u32)obj_desc->integer.value));\r\n}\r\n#endif\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Unknown Integer type 0x%X",\r\nop_info->type));\r\nstatus = AE_AML_OPERAND_TYPE;\r\nbreak;\r\n}\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nobj_desc->string.pointer = op->common.value.string;\r\nobj_desc->string.length =\r\n(u32) ACPI_STRLEN(op->common.value.string);\r\nobj_desc->common.flags |= AOPOBJ_STATIC_POINTER;\r\nbreak;\r\ncase ACPI_TYPE_METHOD:\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nswitch (op_info->type) {\r\ncase AML_TYPE_LOCAL_VARIABLE:\r\nobj_desc->reference.value =\r\n((u32)opcode) - AML_LOCAL_OP;\r\nobj_desc->reference.class = ACPI_REFCLASS_LOCAL;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nstatus =\r\nacpi_ds_method_data_get_node(ACPI_REFCLASS_LOCAL,\r\nobj_desc->reference.\r\nvalue, walk_state,\r\nACPI_CAST_INDIRECT_PTR\r\n(struct\r\nacpi_namespace_node,\r\n&obj_desc->reference.\r\nobject));\r\n#endif\r\nbreak;\r\ncase AML_TYPE_METHOD_ARGUMENT:\r\nobj_desc->reference.value = ((u32)opcode) - AML_ARG_OP;\r\nobj_desc->reference.class = ACPI_REFCLASS_ARG;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nstatus = acpi_ds_method_data_get_node(ACPI_REFCLASS_ARG,\r\nobj_desc->\r\nreference.value,\r\nwalk_state,\r\nACPI_CAST_INDIRECT_PTR\r\n(struct\r\nacpi_namespace_node,\r\n&obj_desc->\r\nreference.\r\nobject));\r\n#endif\r\nbreak;\r\ndefault:\r\nswitch (op->common.aml_opcode) {\r\ncase AML_INT_NAMEPATH_OP:\r\nobj_desc->reference.node = op->common.node;\r\nobj_desc->reference.object =\r\nop->common.node->object;\r\nobj_desc->reference.class = ACPI_REFCLASS_NAME;\r\nbreak;\r\ncase AML_DEBUG_OP:\r\nobj_desc->reference.class = ACPI_REFCLASS_DEBUG;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unimplemented reference type for AML opcode: 0x%4.4X",\r\nopcode));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Unimplemented data type: 0x%X",\r\nobj_desc->common.type));\r\nstatus = AE_AML_OPERAND_TYPE;\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}

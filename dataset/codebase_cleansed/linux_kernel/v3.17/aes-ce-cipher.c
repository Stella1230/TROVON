static int num_rounds(struct crypto_aes_ctx *ctx)\r\n{\r\nreturn 6 + ctx->key_length / 4;\r\n}\r\nstatic void aes_cipher_encrypt(struct crypto_tfm *tfm, u8 dst[], u8 const src[])\r\n{\r\nstruct crypto_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct aes_block *out = (struct aes_block *)dst;\r\nstruct aes_block const *in = (struct aes_block *)src;\r\nvoid *dummy0;\r\nint dummy1;\r\nkernel_neon_begin_partial(4);\r\n__asm__(" ld1 {v0.16b}, %[in] ;"\r\n" ld1 {v1.2d}, [%[key]], #16 ;"\r\n" cmp %w[rounds], #10 ;"\r\n" bmi 0f ;"\r\n" bne 3f ;"\r\n" mov v3.16b, v1.16b ;"\r\n" b 2f ;"\r\n"0: mov v2.16b, v1.16b ;"\r\n" ld1 {v3.2d}, [%[key]], #16 ;"\r\n"1: aese v0.16b, v2.16b ;"\r\n" aesmc v0.16b, v0.16b ;"\r\n"2: ld1 {v1.2d}, [%[key]], #16 ;"\r\n" aese v0.16b, v3.16b ;"\r\n" aesmc v0.16b, v0.16b ;"\r\n"3: ld1 {v2.2d}, [%[key]], #16 ;"\r\n" subs %w[rounds], %w[rounds], #3 ;"\r\n" aese v0.16b, v1.16b ;"\r\n" aesmc v0.16b, v0.16b ;"\r\n" ld1 {v3.2d}, [%[key]], #16 ;"\r\n" bpl 1b ;"\r\n" aese v0.16b, v2.16b ;"\r\n" eor v0.16b, v0.16b, v3.16b ;"\r\n" st1 {v0.16b}, %[out] ;"\r\n: [out] "=Q"(*out),\r\n[key] "=r"(dummy0),\r\n[rounds] "=r"(dummy1)\r\n: [in] "Q"(*in),\r\n"1"(ctx->key_enc),\r\n"2"(num_rounds(ctx) - 2)\r\n: "cc");\r\nkernel_neon_end();\r\n}\r\nstatic void aes_cipher_decrypt(struct crypto_tfm *tfm, u8 dst[], u8 const src[])\r\n{\r\nstruct crypto_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct aes_block *out = (struct aes_block *)dst;\r\nstruct aes_block const *in = (struct aes_block *)src;\r\nvoid *dummy0;\r\nint dummy1;\r\nkernel_neon_begin_partial(4);\r\n__asm__(" ld1 {v0.16b}, %[in] ;"\r\n" ld1 {v1.2d}, [%[key]], #16 ;"\r\n" cmp %w[rounds], #10 ;"\r\n" bmi 0f ;"\r\n" bne 3f ;"\r\n" mov v3.16b, v1.16b ;"\r\n" b 2f ;"\r\n"0: mov v2.16b, v1.16b ;"\r\n" ld1 {v3.2d}, [%[key]], #16 ;"\r\n"1: aesd v0.16b, v2.16b ;"\r\n" aesimc v0.16b, v0.16b ;"\r\n"2: ld1 {v1.2d}, [%[key]], #16 ;"\r\n" aesd v0.16b, v3.16b ;"\r\n" aesimc v0.16b, v0.16b ;"\r\n"3: ld1 {v2.2d}, [%[key]], #16 ;"\r\n" subs %w[rounds], %w[rounds], #3 ;"\r\n" aesd v0.16b, v1.16b ;"\r\n" aesimc v0.16b, v0.16b ;"\r\n" ld1 {v3.2d}, [%[key]], #16 ;"\r\n" bpl 1b ;"\r\n" aesd v0.16b, v2.16b ;"\r\n" eor v0.16b, v0.16b, v3.16b ;"\r\n" st1 {v0.16b}, %[out] ;"\r\n: [out] "=Q"(*out),\r\n[key] "=r"(dummy0),\r\n[rounds] "=r"(dummy1)\r\n: [in] "Q"(*in),\r\n"1"(ctx->key_dec),\r\n"2"(num_rounds(ctx) - 2)\r\n: "cc");\r\nkernel_neon_end();\r\n}\r\nstatic int __init aes_mod_init(void)\r\n{\r\nreturn crypto_register_alg(&aes_alg);\r\n}\r\nstatic void __exit aes_mod_exit(void)\r\n{\r\ncrypto_unregister_alg(&aes_alg);\r\n}

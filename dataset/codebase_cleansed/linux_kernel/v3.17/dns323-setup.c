static int __init dns323_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq;\r\nirq = orion5x_pci_map_irq(dev, slot, pin);\r\nif (irq != -1)\r\nreturn irq;\r\nreturn -1;\r\n}\r\nstatic int __init dns323_pci_init(void)\r\n{\r\nif (machine_is_dns323() && system_rev == DNS323_REV_A1)\r\npci_common_init(&dns323_pci);\r\nreturn 0;\r\n}\r\nstatic int __init dns323_parse_hex_nibble(char n)\r\n{\r\nif (n >= '0' && n <= '9')\r\nreturn n - '0';\r\nif (n >= 'A' && n <= 'F')\r\nreturn n - 'A' + 10;\r\nif (n >= 'a' && n <= 'f')\r\nreturn n - 'a' + 10;\r\nreturn -1;\r\n}\r\nstatic int __init dns323_parse_hex_byte(const char *b)\r\n{\r\nint hi;\r\nint lo;\r\nhi = dns323_parse_hex_nibble(b[0]);\r\nlo = dns323_parse_hex_nibble(b[1]);\r\nif (hi < 0 || lo < 0)\r\nreturn -1;\r\nreturn (hi << 4) | lo;\r\n}\r\nstatic int __init dns323_read_mac_addr(void)\r\n{\r\nu_int8_t addr[6];\r\nint i;\r\nchar *mac_page;\r\nmac_page = ioremap(DNS323_NOR_BOOT_BASE + 0x7d0000 + 196480, 1024);\r\nif (!mac_page)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < 5; i++) {\r\nif (*(mac_page + (i * 3) + 2) != ':') {\r\ngoto error_fail;\r\n}\r\n}\r\nfor (i = 0; i < 6; i++) {\r\nint byte;\r\nbyte = dns323_parse_hex_byte(mac_page + (i * 3));\r\nif (byte < 0) {\r\ngoto error_fail;\r\n}\r\naddr[i] = byte;\r\n}\r\niounmap(mac_page);\r\nprintk("DNS-323: Found ethernet MAC address: ");\r\nfor (i = 0; i < 6; i++)\r\nprintk("%.2x%s", addr[i], (i < 5) ? ":" : ".\n");\r\nmemcpy(dns323_eth_data.mac_addr, addr, 6);\r\nreturn 0;\r\nerror_fail:\r\niounmap(mac_page);\r\nreturn -EINVAL;\r\n}\r\nstatic void dns323a_power_off(void)\r\n{\r\npr_info("DNS-323: Triggering power-off...\n");\r\ngpio_set_value(DNS323_GPIO_POWER_OFF, 1);\r\n}\r\nstatic void dns323b_power_off(void)\r\n{\r\npr_info("DNS-323: Triggering power-off...\n");\r\ngpio_set_value(DNS323_GPIO_POWER_OFF, 1);\r\nmdelay(100);\r\ngpio_set_value(DNS323_GPIO_POWER_OFF, 0);\r\n}\r\nstatic void dns323c_power_off(void)\r\n{\r\npr_info("DNS-323: Triggering power-off...\n");\r\ngpio_set_value(DNS323C_GPIO_POWER_OFF, 1);\r\n}\r\nstatic int dns323c_phy_fixup(struct phy_device *phy)\r\n{\r\nphy->dev_flags |= MARVELL_PHY_M1118_DNS323_LEDS;\r\nreturn 0;\r\n}\r\nstatic int __init dns323_identify_rev(void)\r\n{\r\nu32 dev, rev, i, reg;\r\npr_debug("DNS-323: Identifying board ... \n");\r\norion5x_pcie_id(&dev, &rev);\r\nif (dev == MV88F5181_DEV_ID) {\r\npr_debug("DNS-323: 5181 found, board is A1\n");\r\nreturn DNS323_REV_A1;\r\n}\r\npr_debug("DNS-323: 5182 found, board is B1 or C1, checking PHY...\n");\r\n#define ETH_SMI_REG (ORION5X_ETH_VIRT_BASE + 0x2000 + 0x004)\r\n#define SMI_BUSY 0x10000000\r\n#define SMI_READ_VALID 0x08000000\r\n#define SMI_OPCODE_READ 0x04000000\r\n#define SMI_OPCODE_WRITE 0x00000000\r\nfor (i = 0; i < 1000; i++) {\r\nreg = readl(ETH_SMI_REG);\r\nif (!(reg & SMI_BUSY))\r\nbreak;\r\n}\r\nif (i >= 1000) {\r\npr_warning("DNS-323: Timeout accessing PHY, assuming rev B1\n");\r\nreturn DNS323_REV_B1;\r\n}\r\nwritel((3 << 21) |\r\n(8 << 16) |\r\nSMI_OPCODE_READ, ETH_SMI_REG);\r\nfor (i = 0; i < 1000; i++) {\r\nreg = readl(ETH_SMI_REG);\r\nif (reg & SMI_READ_VALID)\r\nbreak;\r\n}\r\nif (i >= 1000) {\r\npr_warning("DNS-323: Timeout reading PHY, assuming rev B1\n");\r\nreturn DNS323_REV_B1;\r\n}\r\npr_debug("DNS-323: Ethernet PHY ID 0x%x\n", reg & 0xffff);\r\nswitch(reg & 0xfff0) {\r\ncase 0x0cc0:\r\nreturn DNS323_REV_B1;\r\ncase 0x0e10:\r\nreturn DNS323_REV_C1;\r\ndefault:\r\npr_warning("DNS-323: Unknown PHY ID 0x%04x, assuming rev B1\n",\r\nreg & 0xffff);\r\n}\r\nreturn DNS323_REV_B1;\r\n}\r\nstatic void __init dns323_init(void)\r\n{\r\norion5x_init();\r\nsystem_rev = dns323_identify_rev();\r\npr_info("DNS-323: Identified HW revision %c1\n", 'A' + system_rev);\r\nswitch(system_rev) {\r\ncase DNS323_REV_A1:\r\norion5x_mpp_conf(dns323a_mpp_modes);\r\nwritel(0, MPP_DEV_CTRL);\r\nbreak;\r\ncase DNS323_REV_B1:\r\norion5x_mpp_conf(dns323b_mpp_modes);\r\nbreak;\r\ncase DNS323_REV_C1:\r\norion5x_mpp_conf(dns323c_mpp_modes);\r\nbreak;\r\n}\r\nmvebu_mbus_add_window_by_id(ORION_MBUS_DEVBUS_BOOT_TARGET,\r\nORION_MBUS_DEVBUS_BOOT_ATTR,\r\nDNS323_NOR_BOOT_BASE,\r\nDNS323_NOR_BOOT_SIZE);\r\nplatform_device_register(&dns323_nor_flash);\r\nswitch(system_rev) {\r\ncase DNS323_REV_A1:\r\ndns323ab_leds[0].active_low = 1;\r\ngpio_request(DNS323_GPIO_LED_POWER1, "Power Led Enable");\r\ngpio_direction_output(DNS323_GPIO_LED_POWER1, 0);\r\ncase DNS323_REV_B1:\r\ni2c_register_board_info(0, dns323ab_i2c_devices,\r\nARRAY_SIZE(dns323ab_i2c_devices));\r\nbreak;\r\ncase DNS323_REV_C1:\r\ndns323_gpio_leds.dev.platform_data = &dns323c_led_data;\r\ndns323_button_device.dev.platform_data = &dns323c_button_data;\r\ni2c_register_board_info(0, dns323c_i2c_devices,\r\nARRAY_SIZE(dns323c_i2c_devices));\r\nplatform_device_register_simple("dns323c-fan", 0, NULL, 0);\r\nif (!IS_BUILTIN(CONFIG_PHYLIB))\r\nbreak;\r\nphy_register_fixup_for_uid(MARVELL_PHY_ID_88E1118,\r\nMARVELL_PHY_ID_MASK,\r\ndns323c_phy_fixup);\r\n}\r\nplatform_device_register(&dns323_gpio_leds);\r\nplatform_device_register(&dns323_button_device);\r\nif (dns323_read_mac_addr() < 0)\r\nprintk("DNS-323: Failed to read MAC address\n");\r\norion5x_ehci0_init();\r\norion5x_eth_init(&dns323_eth_data);\r\norion5x_i2c_init();\r\norion5x_uart0_init();\r\nswitch(system_rev) {\r\ncase DNS323_REV_A1:\r\nif (gpio_request(DNS323_GPIO_POWER_OFF, "POWEROFF") != 0 ||\r\ngpio_direction_output(DNS323_GPIO_POWER_OFF, 0) != 0)\r\npr_err("DNS-323: failed to setup power-off GPIO\n");\r\npm_power_off = dns323a_power_off;\r\nbreak;\r\ncase DNS323_REV_B1:\r\norion5x_sata_init(&dns323_sata_data);\r\nif (gpio_request(DNS323_GPIO_SYSTEM_UP, "SYS_READY") == 0)\r\ngpio_direction_output(DNS323_GPIO_SYSTEM_UP, 1);\r\nif (gpio_request(DNS323_GPIO_POWER_OFF, "POWEROFF") != 0 ||\r\ngpio_direction_output(DNS323_GPIO_POWER_OFF, 0) != 0)\r\npr_err("DNS-323: failed to setup power-off GPIO\n");\r\npm_power_off = dns323b_power_off;\r\nbreak;\r\ncase DNS323_REV_C1:\r\norion5x_sata_init(&dns323_sata_data);\r\nif (gpio_request(DNS323C_GPIO_POWER_OFF, "POWEROFF") != 0 ||\r\ngpio_direction_output(DNS323C_GPIO_POWER_OFF, 0) != 0)\r\npr_err("DNS-323: failed to setup power-off GPIO\n");\r\npm_power_off = dns323c_power_off;\r\nwritel(0x5, ORION5X_SATA_VIRT_BASE + 0x2c);\r\nbreak;\r\n}\r\n}

static void ipmmu_reg_write(struct shmobile_ipmmu *ipmmu, unsigned long reg_off,\r\nunsigned long data)\r\n{\r\niowrite32(data, ipmmu->ipmmu_base + reg_off);\r\n}\r\nvoid ipmmu_tlb_flush(struct shmobile_ipmmu *ipmmu)\r\n{\r\nif (!ipmmu)\r\nreturn;\r\nspin_lock(&ipmmu->flush_lock);\r\nif (ipmmu->tlb_enabled)\r\nipmmu_reg_write(ipmmu, IMCTR1, IMCTR1_FLUSH | IMCTR1_TLBEN);\r\nelse\r\nipmmu_reg_write(ipmmu, IMCTR1, IMCTR1_FLUSH);\r\nspin_unlock(&ipmmu->flush_lock);\r\n}\r\nvoid ipmmu_tlb_set(struct shmobile_ipmmu *ipmmu, unsigned long phys, int size,\r\nint asid)\r\n{\r\nif (!ipmmu)\r\nreturn;\r\nspin_lock(&ipmmu->flush_lock);\r\nswitch (size) {\r\ndefault:\r\nipmmu->tlb_enabled = 0;\r\nbreak;\r\ncase 0x2000:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 1);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x1000:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 2);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x800:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 3);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x400:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 4);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x200:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 5);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x100:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 6);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\ncase 0x80:\r\nipmmu_reg_write(ipmmu, IMTTBCR, 7);\r\nipmmu->tlb_enabled = 1;\r\nbreak;\r\n}\r\nipmmu_reg_write(ipmmu, IMTTBR, phys);\r\nipmmu_reg_write(ipmmu, IMASID, asid);\r\nspin_unlock(&ipmmu->flush_lock);\r\n}\r\nstatic int ipmmu_probe(struct platform_device *pdev)\r\n{\r\nstruct shmobile_ipmmu *ipmmu;\r\nstruct resource *res;\r\nstruct shmobile_ipmmu_platform_data *pdata = pdev->dev.platform_data;\r\nipmmu = devm_kzalloc(&pdev->dev, sizeof(*ipmmu), GFP_KERNEL);\r\nif (!ipmmu) {\r\ndev_err(&pdev->dev, "cannot allocate device data\n");\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_init(&ipmmu->flush_lock);\r\nipmmu->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nipmmu->ipmmu_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ipmmu->ipmmu_base))\r\nreturn PTR_ERR(ipmmu->ipmmu_base);\r\nipmmu->dev_names = pdata->dev_names;\r\nipmmu->num_dev_names = pdata->num_dev_names;\r\nplatform_set_drvdata(pdev, ipmmu);\r\nipmmu_reg_write(ipmmu, IMCTR1, 0x0);\r\nipmmu_reg_write(ipmmu, IMCTR2, 0x0);\r\nreturn ipmmu_iommu_init(ipmmu);\r\n}\r\nstatic int __init ipmmu_init(void)\r\n{\r\nreturn platform_driver_register(&ipmmu_driver);\r\n}

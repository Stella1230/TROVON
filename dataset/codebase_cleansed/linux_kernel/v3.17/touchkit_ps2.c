static psmouse_ret_t touchkit_ps2_process_byte(struct psmouse *psmouse)\r\n{\r\nunsigned char *packet = psmouse->packet;\r\nstruct input_dev *dev = psmouse->dev;\r\nif (psmouse->pktcnt != 5)\r\nreturn PSMOUSE_GOOD_DATA;\r\ninput_report_abs(dev, ABS_X, TOUCHKIT_GET_X(packet));\r\ninput_report_abs(dev, ABS_Y, TOUCHKIT_GET_Y(packet));\r\ninput_report_key(dev, BTN_TOUCH, TOUCHKIT_GET_TOUCHED(packet));\r\ninput_sync(dev);\r\nreturn PSMOUSE_FULL_PACKET;\r\n}\r\nint touchkit_ps2_detect(struct psmouse *psmouse, bool set_properties)\r\n{\r\nstruct input_dev *dev = psmouse->dev;\r\nunsigned char param[3];\r\nint command;\r\nparam[0] = TOUCHKIT_CMD_LENGTH;\r\nparam[1] = TOUCHKIT_CMD_ACTIVE;\r\ncommand = TOUCHKIT_SEND_PARMS(2, 3, TOUCHKIT_CMD);\r\nif (ps2_command(&psmouse->ps2dev, param, command))\r\nreturn -ENODEV;\r\nif (param[0] != TOUCHKIT_CMD || param[1] != 0x01 ||\r\nparam[2] != TOUCHKIT_CMD_ACTIVE)\r\nreturn -ENODEV;\r\nif (set_properties) {\r\ndev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ndev->keybit[BIT_WORD(BTN_MOUSE)] = 0;\r\ndev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(dev, ABS_X, 0, TOUCHKIT_MAX_XC, 0, 0);\r\ninput_set_abs_params(dev, ABS_Y, 0, TOUCHKIT_MAX_YC, 0, 0);\r\npsmouse->vendor = "eGalax";\r\npsmouse->name = "Touchscreen";\r\npsmouse->protocol_handler = touchkit_ps2_process_byte;\r\npsmouse->pktsize = 5;\r\n}\r\nreturn 0;\r\n}

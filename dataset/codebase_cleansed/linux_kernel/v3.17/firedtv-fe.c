static int fdtv_dvb_init(struct dvb_frontend *fe)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nint err;\r\nfdtv->isochannel = fdtv->adapter.num;\r\nerr = cmp_establish_pp_connection(fdtv, fdtv->subunit,\r\nfdtv->isochannel);\r\nif (err) {\r\ndev_err(fdtv->device,\r\n"could not establish point to point connection\n");\r\nreturn err;\r\n}\r\nreturn fdtv_start_iso(fdtv);\r\n}\r\nstatic int fdtv_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nfdtv_stop_iso(fdtv);\r\ncmp_break_pp_connection(fdtv, fdtv->subunit, fdtv->isochannel);\r\nfdtv->isochannel = -1;\r\nreturn 0;\r\n}\r\nstatic int fdtv_diseqc_send_master_cmd(struct dvb_frontend *fe,\r\nstruct dvb_diseqc_master_cmd *cmd)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nreturn avc_lnb_control(fdtv, LNBCONTROL_DONTCARE, LNBCONTROL_DONTCARE,\r\nLNBCONTROL_DONTCARE, 1, cmd);\r\n}\r\nstatic int fdtv_diseqc_send_burst(struct dvb_frontend *fe,\r\nfe_sec_mini_cmd_t minicmd)\r\n{\r\nreturn 0;\r\n}\r\nstatic int fdtv_set_tone(struct dvb_frontend *fe, fe_sec_tone_mode_t tone)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nfdtv->tone = tone;\r\nreturn 0;\r\n}\r\nstatic int fdtv_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nfdtv->voltage = voltage;\r\nreturn 0;\r\n}\r\nstatic int fdtv_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nstruct firedtv_tuner_status stat;\r\nif (avc_tuner_status(fdtv, &stat))\r\nreturn -EINVAL;\r\nif (stat.no_rf)\r\n*status = 0;\r\nelse\r\n*status = FE_HAS_SIGNAL | FE_HAS_VITERBI | FE_HAS_SYNC |\r\nFE_HAS_CARRIER | FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nstatic int fdtv_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nstruct firedtv_tuner_status stat;\r\nif (avc_tuner_status(fdtv, &stat))\r\nreturn -EINVAL;\r\n*ber = stat.ber;\r\nreturn 0;\r\n}\r\nstatic int fdtv_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nstruct firedtv_tuner_status stat;\r\nif (avc_tuner_status(fdtv, &stat))\r\nreturn -EINVAL;\r\n*strength = stat.signal_strength << 8;\r\nreturn 0;\r\n}\r\nstatic int fdtv_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nstruct firedtv_tuner_status stat;\r\nif (avc_tuner_status(fdtv, &stat))\r\nreturn -EINVAL;\r\n*snr = stat.carrier_noise_ratio * 257;\r\nreturn 0;\r\n}\r\nstatic int fdtv_read_uncorrected_blocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic int fdtv_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct firedtv *fdtv = fe->sec_priv;\r\nreturn avc_tuner_dsd(fdtv, p);\r\n}\r\nvoid fdtv_frontend_init(struct firedtv *fdtv, const char *name)\r\n{\r\nstruct dvb_frontend_ops *ops = &fdtv->fe.ops;\r\nstruct dvb_frontend_info *fi = &ops->info;\r\nops->init = fdtv_dvb_init;\r\nops->sleep = fdtv_sleep;\r\nops->set_frontend = fdtv_set_frontend;\r\nops->read_status = fdtv_read_status;\r\nops->read_ber = fdtv_read_ber;\r\nops->read_signal_strength = fdtv_read_signal_strength;\r\nops->read_snr = fdtv_read_snr;\r\nops->read_ucblocks = fdtv_read_uncorrected_blocks;\r\nops->diseqc_send_master_cmd = fdtv_diseqc_send_master_cmd;\r\nops->diseqc_send_burst = fdtv_diseqc_send_burst;\r\nops->set_tone = fdtv_set_tone;\r\nops->set_voltage = fdtv_set_voltage;\r\nswitch (fdtv->type) {\r\ncase FIREDTV_DVB_S:\r\nops->delsys[0] = SYS_DVBS;\r\nfi->frequency_min = 950000;\r\nfi->frequency_max = 2150000;\r\nfi->frequency_stepsize = 125;\r\nfi->symbol_rate_min = 1000000;\r\nfi->symbol_rate_max = 40000000;\r\nfi->caps = FE_CAN_INVERSION_AUTO |\r\nFE_CAN_FEC_1_2 |\r\nFE_CAN_FEC_2_3 |\r\nFE_CAN_FEC_3_4 |\r\nFE_CAN_FEC_5_6 |\r\nFE_CAN_FEC_7_8 |\r\nFE_CAN_FEC_AUTO |\r\nFE_CAN_QPSK;\r\nbreak;\r\ncase FIREDTV_DVB_S2:\r\nops->delsys[0] = SYS_DVBS;\r\nops->delsys[1] = SYS_DVBS2;\r\nfi->frequency_min = 950000;\r\nfi->frequency_max = 2150000;\r\nfi->frequency_stepsize = 125;\r\nfi->symbol_rate_min = 1000000;\r\nfi->symbol_rate_max = 40000000;\r\nfi->caps = FE_CAN_INVERSION_AUTO |\r\nFE_CAN_FEC_1_2 |\r\nFE_CAN_FEC_2_3 |\r\nFE_CAN_FEC_3_4 |\r\nFE_CAN_FEC_5_6 |\r\nFE_CAN_FEC_7_8 |\r\nFE_CAN_FEC_AUTO |\r\nFE_CAN_QPSK |\r\nFE_CAN_2G_MODULATION;\r\nbreak;\r\ncase FIREDTV_DVB_C:\r\nops->delsys[0] = SYS_DVBC_ANNEX_A;\r\nfi->frequency_min = 47000000;\r\nfi->frequency_max = 866000000;\r\nfi->frequency_stepsize = 62500;\r\nfi->symbol_rate_min = 870000;\r\nfi->symbol_rate_max = 6900000;\r\nfi->caps = FE_CAN_INVERSION_AUTO |\r\nFE_CAN_QAM_16 |\r\nFE_CAN_QAM_32 |\r\nFE_CAN_QAM_64 |\r\nFE_CAN_QAM_128 |\r\nFE_CAN_QAM_256 |\r\nFE_CAN_QAM_AUTO;\r\nbreak;\r\ncase FIREDTV_DVB_T:\r\nops->delsys[0] = SYS_DVBT;\r\nfi->frequency_min = 49000000;\r\nfi->frequency_max = 861000000;\r\nfi->frequency_stepsize = 62500;\r\nfi->caps = FE_CAN_INVERSION_AUTO |\r\nFE_CAN_FEC_2_3 |\r\nFE_CAN_TRANSMISSION_MODE_AUTO |\r\nFE_CAN_GUARD_INTERVAL_AUTO |\r\nFE_CAN_HIERARCHY_AUTO;\r\nbreak;\r\ndefault:\r\ndev_err(fdtv->device, "no frontend for model type %d\n",\r\nfdtv->type);\r\n}\r\nstrcpy(fi->name, name);\r\nfdtv->fe.dvb = &fdtv->adapter;\r\nfdtv->fe.sec_priv = fdtv;\r\n}

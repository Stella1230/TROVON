static void sg2_udc_command(int cmd)\r\n{\r\nswitch (cmd) {\r\ncase PXA2XX_UDC_CMD_CONNECT:\r\nUP2OCR |= UP2OCR_HXOE | UP2OCR_DPPUE | UP2OCR_DPPUBE;\r\nbreak;\r\ncase PXA2XX_UDC_CMD_DISCONNECT:\r\nUP2OCR &= ~(UP2OCR_HXOE | UP2OCR_DPPUE | UP2OCR_DPPUBE);\r\nbreak;\r\n}\r\n}\r\nstatic void __init imote2_stargate2_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(sg2_im2_unified_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\npxa2xx_set_spi_info(1, &pxa_ssp_master_0_info);\r\npxa2xx_set_spi_info(2, &pxa_ssp_master_1_info);\r\npxa2xx_set_spi_info(3, &pxa_ssp_master_2_info);\r\nspi_register_board_info(spi_board_info, ARRAY_SIZE(spi_board_info));\r\npxa27x_set_i2c_power_info(&i2c_pwr_pdata);\r\npxa_set_i2c_info(&i2c_pdata);\r\n}\r\nstatic int imote2_mci_get_ro(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __init imote2_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(imote2_pin_config));\r\nimote2_stargate2_init();\r\nplatform_add_devices(imote2_devices, ARRAY_SIZE(imote2_devices));\r\ni2c_register_board_info(0, imote2_i2c_board_info,\r\nARRAY_SIZE(imote2_i2c_board_info));\r\ni2c_register_board_info(1, imote2_pwr_i2c_board_info,\r\nARRAY_SIZE(imote2_pwr_i2c_board_info));\r\npxa_set_mci_info(&imote2_mci_platform_data);\r\npxa_set_udc_info(&imote2_udc_info);\r\n}\r\nstatic int stargate2_mci_init(struct device *dev,\r\nirq_handler_t stargate2_detect_int,\r\nvoid *data)\r\n{\r\nint err;\r\nerr = gpio_request(SG2_SD_POWER_ENABLE, "SG2_sd_power_enable");\r\nif (err) {\r\nprintk(KERN_ERR "Can't get the gpio for SD power control");\r\ngoto return_err;\r\n}\r\ngpio_direction_output(SG2_SD_POWER_ENABLE, 0);\r\nerr = gpio_request(SG2_GPIO_nSD_DETECT, "SG2_sd_detect");\r\nif (err) {\r\nprintk(KERN_ERR "Can't get the sd detect gpio");\r\ngoto free_power_en;\r\n}\r\ngpio_direction_input(SG2_GPIO_nSD_DETECT);\r\nerr = request_irq(PXA_GPIO_TO_IRQ(SG2_GPIO_nSD_DETECT),\r\nstargate2_detect_int,\r\nIRQ_TYPE_EDGE_BOTH,\r\n"MMC card detect",\r\ndata);\r\nif (err) {\r\nprintk(KERN_ERR "can't request MMC card detect IRQ\n");\r\ngoto free_nsd_detect;\r\n}\r\nreturn 0;\r\nfree_nsd_detect:\r\ngpio_free(SG2_GPIO_nSD_DETECT);\r\nfree_power_en:\r\ngpio_free(SG2_SD_POWER_ENABLE);\r\nreturn_err:\r\nreturn err;\r\n}\r\nstatic int stargate2_mci_setpower(struct device *dev, unsigned int vdd)\r\n{\r\ngpio_set_value(SG2_SD_POWER_ENABLE, !!vdd);\r\nreturn 0;\r\n}\r\nstatic void stargate2_mci_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(PXA_GPIO_TO_IRQ(SG2_GPIO_nSD_DETECT), data);\r\ngpio_free(SG2_SD_POWER_ENABLE);\r\ngpio_free(SG2_GPIO_nSD_DETECT);\r\n}\r\nstatic int stargate2_reset_bluetooth(void)\r\n{\r\nint err;\r\nerr = gpio_request(SG2_BT_RESET, "SG2_BT_RESET");\r\nif (err) {\r\nprintk(KERN_ERR "Could not get gpio for bluetooth reset\n");\r\nreturn err;\r\n}\r\ngpio_direction_output(SG2_BT_RESET, 1);\r\nmdelay(5);\r\ngpio_set_value(SG2_BT_RESET, 0);\r\nmdelay(10);\r\ngpio_set_value(SG2_BT_RESET, 1);\r\ngpio_free(SG2_BT_RESET);\r\nreturn 0;\r\n}\r\nstatic int sg2_udc_detect(void)\r\n{\r\nreturn 1;\r\n}\r\nstatic void __init stargate2_init(void)\r\n{\r\n__raw_writel(__raw_readl(MECR) & ~MECR_NOS, MECR);\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(stargate2_pin_config));\r\nimote2_stargate2_init();\r\nplatform_add_devices(ARRAY_AND_SIZE(stargate2_devices));\r\ni2c_register_board_info(0, ARRAY_AND_SIZE(stargate2_i2c_board_info));\r\ni2c_register_board_info(1, stargate2_pwr_i2c_board_info,\r\nARRAY_SIZE(stargate2_pwr_i2c_board_info));\r\npxa_set_mci_info(&stargate2_mci_platform_data);\r\npxa_set_udc_info(&stargate2_udc_info);\r\nstargate2_reset_bluetooth();\r\n}

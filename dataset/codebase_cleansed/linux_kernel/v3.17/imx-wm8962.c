static int imx_hifi_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nsample_rate = params_rate(params);\r\nsample_format = params_format(params);\r\nreturn 0;\r\n}\r\nstatic int imx_wm8962_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[0].codec_dai;\r\nstruct imx_priv *priv = &card_priv;\r\nstruct imx_wm8962_data *data = snd_soc_card_get_drvdata(card);\r\nstruct device *dev = &priv->pdev->dev;\r\nunsigned int pll_out;\r\nint ret;\r\nif (dapm->dev != codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (dapm->bias_level == SND_SOC_BIAS_STANDBY) {\r\nif (sample_format == SNDRV_PCM_FORMAT_S24_LE)\r\npll_out = sample_rate * 384;\r\nelse\r\npll_out = sample_rate * 256;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8962_FLL,\r\nWM8962_FLL_MCLK, data->clk_frequency,\r\npll_out);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to start FLL: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai,\r\nWM8962_SYSCLK_FLL, pll_out,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to set SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (dapm->bias_level == SND_SOC_BIAS_PREPARE) {\r\nret = snd_soc_dai_set_sysclk(codec_dai,\r\nWM8962_SYSCLK_MCLK, data->clk_frequency,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(dev,\r\n"failed to switch away from FLL: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_pll(codec_dai, WM8962_FLL,\r\n0, 0, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to stop FLL: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int imx_wm8962_late_probe(struct snd_soc_card *card)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[0].codec_dai;\r\nstruct imx_priv *priv = &card_priv;\r\nstruct imx_wm8962_data *data = snd_soc_card_get_drvdata(card);\r\nstruct device *dev = &priv->pdev->dev;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8962_SYSCLK_MCLK,\r\ndata->clk_frequency, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\ndev_err(dev, "failed to set sysclk in %s\n", __func__);\r\nreturn ret;\r\n}\r\nstatic int imx_wm8962_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *ssi_np, *codec_np;\r\nstruct platform_device *ssi_pdev;\r\nstruct imx_priv *priv = &card_priv;\r\nstruct i2c_client *codec_dev;\r\nstruct imx_wm8962_data *data;\r\nint int_port, ext_port;\r\nint ret;\r\npriv->pdev = pdev;\r\nret = of_property_read_u32(np, "mux-int-port", &int_port);\r\nif (ret) {\r\ndev_err(&pdev->dev, "mux-int-port missing or invalid\n");\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(np, "mux-ext-port", &ext_port);\r\nif (ret) {\r\ndev_err(&pdev->dev, "mux-ext-port missing or invalid\n");\r\nreturn ret;\r\n}\r\nint_port--;\r\next_port--;\r\nret = imx_audmux_v2_configure_port(int_port,\r\nIMX_AUDMUX_V2_PTCR_SYN |\r\nIMX_AUDMUX_V2_PTCR_TFSEL(ext_port) |\r\nIMX_AUDMUX_V2_PTCR_TCSEL(ext_port) |\r\nIMX_AUDMUX_V2_PTCR_TFSDIR |\r\nIMX_AUDMUX_V2_PTCR_TCLKDIR,\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(ext_port));\r\nif (ret) {\r\ndev_err(&pdev->dev, "audmux internal port setup failed\n");\r\nreturn ret;\r\n}\r\nimx_audmux_v2_configure_port(ext_port,\r\nIMX_AUDMUX_V2_PTCR_SYN,\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(int_port));\r\nif (ret) {\r\ndev_err(&pdev->dev, "audmux external port setup failed\n");\r\nreturn ret;\r\n}\r\nssi_np = of_parse_phandle(pdev->dev.of_node, "ssi-controller", 0);\r\ncodec_np = of_parse_phandle(pdev->dev.of_node, "audio-codec", 0);\r\nif (!ssi_np || !codec_np) {\r\ndev_err(&pdev->dev, "phandle missing or invalid\n");\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nssi_pdev = of_find_device_by_node(ssi_np);\r\nif (!ssi_pdev) {\r\ndev_err(&pdev->dev, "failed to find SSI platform device\n");\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\ncodec_dev = of_find_i2c_device_by_node(codec_np);\r\nif (!codec_dev || !codec_dev->dev.driver) {\r\ndev_err(&pdev->dev, "failed to find codec platform device\n");\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\ndata->codec_clk = devm_clk_get(&codec_dev->dev, NULL);\r\nif (IS_ERR(data->codec_clk)) {\r\nret = PTR_ERR(data->codec_clk);\r\ndev_err(&codec_dev->dev, "failed to get codec clk: %d\n", ret);\r\ngoto fail;\r\n}\r\ndata->clk_frequency = clk_get_rate(data->codec_clk);\r\nret = clk_prepare_enable(data->codec_clk);\r\nif (ret) {\r\ndev_err(&codec_dev->dev, "failed to enable codec clk: %d\n", ret);\r\ngoto fail;\r\n}\r\ndata->dai.name = "HiFi";\r\ndata->dai.stream_name = "HiFi";\r\ndata->dai.codec_dai_name = "wm8962";\r\ndata->dai.codec_of_node = codec_np;\r\ndata->dai.cpu_dai_name = dev_name(&ssi_pdev->dev);\r\ndata->dai.platform_of_node = ssi_np;\r\ndata->dai.ops = &imx_hifi_ops;\r\ndata->dai.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM;\r\ndata->card.dev = &pdev->dev;\r\nret = snd_soc_of_parse_card_name(&data->card, "model");\r\nif (ret)\r\ngoto clk_fail;\r\nret = snd_soc_of_parse_audio_routing(&data->card, "audio-routing");\r\nif (ret)\r\ngoto clk_fail;\r\ndata->card.num_links = 1;\r\ndata->card.dai_link = &data->dai;\r\ndata->card.dapm_widgets = imx_wm8962_dapm_widgets;\r\ndata->card.num_dapm_widgets = ARRAY_SIZE(imx_wm8962_dapm_widgets);\r\ndata->card.late_probe = imx_wm8962_late_probe;\r\ndata->card.set_bias_level = imx_wm8962_set_bias_level;\r\nplatform_set_drvdata(pdev, &data->card);\r\nsnd_soc_card_set_drvdata(&data->card, data);\r\nret = devm_snd_soc_register_card(&pdev->dev, &data->card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed (%d)\n", ret);\r\ngoto clk_fail;\r\n}\r\nof_node_put(ssi_np);\r\nof_node_put(codec_np);\r\nreturn 0;\r\nclk_fail:\r\nclk_disable_unprepare(data->codec_clk);\r\nfail:\r\nif (ssi_np)\r\nof_node_put(ssi_np);\r\nif (codec_np)\r\nof_node_put(codec_np);\r\nreturn ret;\r\n}\r\nstatic int imx_wm8962_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nstruct imx_wm8962_data *data = snd_soc_card_get_drvdata(card);\r\nif (!IS_ERR(data->codec_clk))\r\nclk_disable_unprepare(data->codec_clk);\r\nreturn 0;\r\n}

static irqreturn_t gpio_charger_irq(int irq, void *devid)\r\n{\r\nstruct power_supply *charger = devid;\r\npower_supply_changed(charger);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic inline struct gpio_charger *psy_to_gpio_charger(struct power_supply *psy)\r\n{\r\nreturn container_of(psy, struct gpio_charger, charger);\r\n}\r\nstatic int gpio_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp, union power_supply_propval *val)\r\n{\r\nstruct gpio_charger *gpio_charger = psy_to_gpio_charger(psy);\r\nconst struct gpio_charger_platform_data *pdata = gpio_charger->pdata;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = gpio_get_value_cansleep(pdata->gpio);\r\nval->intval ^= pdata->gpio_active_low;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gpio_charger_probe(struct platform_device *pdev)\r\n{\r\nconst struct gpio_charger_platform_data *pdata = pdev->dev.platform_data;\r\nstruct gpio_charger *gpio_charger;\r\nstruct power_supply *charger;\r\nint ret;\r\nint irq;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (!gpio_is_valid(pdata->gpio)) {\r\ndev_err(&pdev->dev, "Invalid gpio pin\n");\r\nreturn -EINVAL;\r\n}\r\ngpio_charger = devm_kzalloc(&pdev->dev, sizeof(*gpio_charger),\r\nGFP_KERNEL);\r\nif (!gpio_charger) {\r\ndev_err(&pdev->dev, "Failed to alloc driver structure\n");\r\nreturn -ENOMEM;\r\n}\r\ncharger = &gpio_charger->charger;\r\ncharger->name = pdata->name ? pdata->name : "gpio-charger";\r\ncharger->type = pdata->type;\r\ncharger->properties = gpio_charger_properties;\r\ncharger->num_properties = ARRAY_SIZE(gpio_charger_properties);\r\ncharger->get_property = gpio_charger_get_property;\r\ncharger->supplied_to = pdata->supplied_to;\r\ncharger->num_supplicants = pdata->num_supplicants;\r\nret = gpio_request(pdata->gpio, dev_name(&pdev->dev));\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request gpio pin: %d\n", ret);\r\ngoto err_free;\r\n}\r\nret = gpio_direction_input(pdata->gpio);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to set gpio to input: %d\n", ret);\r\ngoto err_gpio_free;\r\n}\r\ngpio_charger->pdata = pdata;\r\nret = power_supply_register(&pdev->dev, charger);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register power supply: %d\n",\r\nret);\r\ngoto err_gpio_free;\r\n}\r\nirq = gpio_to_irq(pdata->gpio);\r\nif (irq > 0) {\r\nret = request_any_context_irq(irq, gpio_charger_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\ndev_name(&pdev->dev), charger);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "Failed to request irq: %d\n", ret);\r\nelse\r\ngpio_charger->irq = irq;\r\n}\r\nplatform_set_drvdata(pdev, gpio_charger);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nerr_gpio_free:\r\ngpio_free(pdata->gpio);\r\nerr_free:\r\nreturn ret;\r\n}\r\nstatic int gpio_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_charger *gpio_charger = platform_get_drvdata(pdev);\r\nif (gpio_charger->irq)\r\nfree_irq(gpio_charger->irq, &gpio_charger->charger);\r\npower_supply_unregister(&gpio_charger->charger);\r\ngpio_free(gpio_charger->pdata->gpio);\r\nreturn 0;\r\n}\r\nstatic int gpio_charger_suspend(struct device *dev)\r\n{\r\nstruct gpio_charger *gpio_charger = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ngpio_charger->wakeup_enabled =\r\nenable_irq_wake(gpio_charger->irq);\r\nreturn 0;\r\n}\r\nstatic int gpio_charger_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct gpio_charger *gpio_charger = platform_get_drvdata(pdev);\r\nif (gpio_charger->wakeup_enabled)\r\ndisable_irq_wake(gpio_charger->irq);\r\npower_supply_changed(&gpio_charger->charger);\r\nreturn 0;\r\n}

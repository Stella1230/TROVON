static int loongson3_pci_config_access(unsigned char access_type,\r\nstruct pci_bus *bus, unsigned int devfn,\r\nint where, u32 *data)\r\n{\r\nunsigned char busnum = bus->number;\r\nu_int64_t addr, type;\r\nvoid *addrp;\r\nint device = PCI_SLOT(devfn);\r\nint function = PCI_FUNC(devfn);\r\nint reg = where & ~3;\r\naddr = (busnum << 16) | (device << 11) | (function << 8) | reg;\r\nif (busnum == 0) {\r\nif (device > 31)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\naddrp = (void *)(TO_UNCAC(HT1LO_PCICFG_BASE) | (addr & 0xffff));\r\ntype = 0;\r\n} else {\r\naddrp = (void *)(TO_UNCAC(HT1LO_PCICFG_BASE_TP1) | (addr));\r\ntype = 0x10000;\r\n}\r\nif (access_type == PCI_ACCESS_WRITE)\r\nwritel(*data, addrp);\r\nelse {\r\n*data = readl(addrp);\r\nif (*data == 0xffffffff) {\r\n*data = -1;\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int loongson3_pci_pcibios_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nu32 data = 0;\r\nint ret = loongson3_pci_config_access(PCI_ACCESS_READ,\r\nbus, devfn, where, &data);\r\nif (ret != PCIBIOS_SUCCESSFUL)\r\nreturn ret;\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int loongson3_pci_pcibios_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data = 0;\r\nint ret;\r\nif (size == 4)\r\ndata = val;\r\nelse {\r\nret = loongson3_pci_config_access(PCI_ACCESS_READ,\r\nbus, devfn, where, &data);\r\nif (ret != PCIBIOS_SUCCESSFUL)\r\nreturn ret;\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\n}\r\nret = loongson3_pci_config_access(PCI_ACCESS_WRITE,\r\nbus, devfn, where, &data);\r\nreturn ret;\r\n}

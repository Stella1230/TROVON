static unsigned evtchn_2l_max_channels(void)\r\n{\r\nreturn EVTCHN_2L_NR_CHANNELS;\r\n}\r\nstatic void evtchn_2l_bind_to_cpu(struct irq_info *info, unsigned cpu)\r\n{\r\nclear_bit(info->evtchn, BM(per_cpu(cpu_evtchn_mask, info->cpu)));\r\nset_bit(info->evtchn, BM(per_cpu(cpu_evtchn_mask, cpu)));\r\n}\r\nstatic void evtchn_2l_clear_pending(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nsync_clear_bit(port, BM(&s->evtchn_pending[0]));\r\n}\r\nstatic void evtchn_2l_set_pending(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nsync_set_bit(port, BM(&s->evtchn_pending[0]));\r\n}\r\nstatic bool evtchn_2l_is_pending(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nreturn sync_test_bit(port, BM(&s->evtchn_pending[0]));\r\n}\r\nstatic bool evtchn_2l_test_and_set_mask(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nreturn sync_test_and_set_bit(port, BM(&s->evtchn_mask[0]));\r\n}\r\nstatic void evtchn_2l_mask(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nsync_set_bit(port, BM(&s->evtchn_mask[0]));\r\n}\r\nstatic void evtchn_2l_unmask(unsigned port)\r\n{\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nunsigned int cpu = get_cpu();\r\nint do_hypercall = 0, evtchn_pending = 0;\r\nBUG_ON(!irqs_disabled());\r\nif (unlikely((cpu != cpu_from_evtchn(port))))\r\ndo_hypercall = 1;\r\nelse {\r\nsync_clear_bit(port, BM(&s->evtchn_mask[0]));\r\nevtchn_pending = sync_test_bit(port, BM(&s->evtchn_pending[0]));\r\nif (unlikely(evtchn_pending && xen_hvm_domain())) {\r\nsync_set_bit(port, BM(&s->evtchn_mask[0]));\r\ndo_hypercall = 1;\r\n}\r\n}\r\nif (do_hypercall) {\r\nstruct evtchn_unmask unmask = { .port = port };\r\n(void)HYPERVISOR_event_channel_op(EVTCHNOP_unmask, &unmask);\r\n} else {\r\nstruct vcpu_info *vcpu_info = __this_cpu_read(xen_vcpu);\r\nif (evtchn_pending &&\r\n!sync_test_and_set_bit(port / BITS_PER_EVTCHN_WORD,\r\nBM(&vcpu_info->evtchn_pending_sel)))\r\nvcpu_info->evtchn_upcall_pending = 1;\r\n}\r\nput_cpu();\r\n}\r\nstatic inline xen_ulong_t active_evtchns(unsigned int cpu,\r\nstruct shared_info *sh,\r\nunsigned int idx)\r\n{\r\nreturn sh->evtchn_pending[idx] &\r\nper_cpu(cpu_evtchn_mask, cpu)[idx] &\r\n~sh->evtchn_mask[idx];\r\n}\r\nstatic void evtchn_2l_handle_events(unsigned cpu)\r\n{\r\nint irq;\r\nxen_ulong_t pending_words;\r\nxen_ulong_t pending_bits;\r\nint start_word_idx, start_bit_idx;\r\nint word_idx, bit_idx;\r\nint i;\r\nstruct shared_info *s = HYPERVISOR_shared_info;\r\nstruct vcpu_info *vcpu_info = __this_cpu_read(xen_vcpu);\r\nirq = irq_from_virq(cpu, VIRQ_TIMER);\r\nif (irq != -1) {\r\nunsigned int evtchn = evtchn_from_irq(irq);\r\nword_idx = evtchn / BITS_PER_LONG;\r\nbit_idx = evtchn % BITS_PER_LONG;\r\nif (active_evtchns(cpu, s, word_idx) & (1ULL << bit_idx))\r\ngeneric_handle_irq(irq);\r\n}\r\npending_words = xchg_xen_ulong(&vcpu_info->evtchn_pending_sel, 0);\r\nstart_word_idx = __this_cpu_read(current_word_idx);\r\nstart_bit_idx = __this_cpu_read(current_bit_idx);\r\nword_idx = start_word_idx;\r\nfor (i = 0; pending_words != 0; i++) {\r\nxen_ulong_t words;\r\nwords = MASK_LSBS(pending_words, word_idx);\r\nif (words == 0) {\r\nword_idx = 0;\r\nbit_idx = 0;\r\ncontinue;\r\n}\r\nword_idx = EVTCHN_FIRST_BIT(words);\r\npending_bits = active_evtchns(cpu, s, word_idx);\r\nbit_idx = 0;\r\nif (word_idx == start_word_idx) {\r\nif (i == 0)\r\nbit_idx = start_bit_idx;\r\n}\r\ndo {\r\nxen_ulong_t bits;\r\nint port;\r\nbits = MASK_LSBS(pending_bits, bit_idx);\r\nif (bits == 0)\r\nbreak;\r\nbit_idx = EVTCHN_FIRST_BIT(bits);\r\nport = (word_idx * BITS_PER_EVTCHN_WORD) + bit_idx;\r\nirq = get_evtchn_to_irq(port);\r\nif (irq != -1)\r\ngeneric_handle_irq(irq);\r\nbit_idx = (bit_idx + 1) % BITS_PER_EVTCHN_WORD;\r\n__this_cpu_write(current_word_idx,\r\nbit_idx ? word_idx :\r\n(word_idx+1) % BITS_PER_EVTCHN_WORD);\r\n__this_cpu_write(current_bit_idx, bit_idx);\r\n} while (bit_idx != 0);\r\nif ((word_idx != start_word_idx) || (i != 0))\r\npending_words &= ~(1UL << word_idx);\r\nword_idx = (word_idx + 1) % BITS_PER_EVTCHN_WORD;\r\n}\r\n}\r\nirqreturn_t xen_debug_interrupt(int irq, void *dev_id)\r\n{\r\nstruct shared_info *sh = HYPERVISOR_shared_info;\r\nint cpu = smp_processor_id();\r\nxen_ulong_t *cpu_evtchn = per_cpu(cpu_evtchn_mask, cpu);\r\nint i;\r\nunsigned long flags;\r\nstatic DEFINE_SPINLOCK(debug_lock);\r\nstruct vcpu_info *v;\r\nspin_lock_irqsave(&debug_lock, flags);\r\nprintk("\nvcpu %d\n ", cpu);\r\nfor_each_online_cpu(i) {\r\nint pending;\r\nv = per_cpu(xen_vcpu, i);\r\npending = (get_irq_regs() && i == cpu)\r\n? xen_irqs_disabled(get_irq_regs())\r\n: v->evtchn_upcall_mask;\r\nprintk("%d: masked=%d pending=%d event_sel %0*"PRI_xen_ulong"\n ", i,\r\npending, v->evtchn_upcall_pending,\r\n(int)(sizeof(v->evtchn_pending_sel)*2),\r\nv->evtchn_pending_sel);\r\n}\r\nv = per_cpu(xen_vcpu, cpu);\r\nprintk("\npending:\n ");\r\nfor (i = ARRAY_SIZE(sh->evtchn_pending)-1; i >= 0; i--)\r\nprintk("%0*"PRI_xen_ulong"%s",\r\n(int)sizeof(sh->evtchn_pending[0])*2,\r\nsh->evtchn_pending[i],\r\ni % 8 == 0 ? "\n " : " ");\r\nprintk("\nglobal mask:\n ");\r\nfor (i = ARRAY_SIZE(sh->evtchn_mask)-1; i >= 0; i--)\r\nprintk("%0*"PRI_xen_ulong"%s",\r\n(int)(sizeof(sh->evtchn_mask[0])*2),\r\nsh->evtchn_mask[i],\r\ni % 8 == 0 ? "\n " : " ");\r\nprintk("\nglobally unmasked:\n ");\r\nfor (i = ARRAY_SIZE(sh->evtchn_mask)-1; i >= 0; i--)\r\nprintk("%0*"PRI_xen_ulong"%s",\r\n(int)(sizeof(sh->evtchn_mask[0])*2),\r\nsh->evtchn_pending[i] & ~sh->evtchn_mask[i],\r\ni % 8 == 0 ? "\n " : " ");\r\nprintk("\nlocal cpu%d mask:\n ", cpu);\r\nfor (i = (EVTCHN_2L_NR_CHANNELS/BITS_PER_EVTCHN_WORD)-1; i >= 0; i--)\r\nprintk("%0*"PRI_xen_ulong"%s", (int)(sizeof(cpu_evtchn[0])*2),\r\ncpu_evtchn[i],\r\ni % 8 == 0 ? "\n " : " ");\r\nprintk("\nlocally unmasked:\n ");\r\nfor (i = ARRAY_SIZE(sh->evtchn_mask)-1; i >= 0; i--) {\r\nxen_ulong_t pending = sh->evtchn_pending[i]\r\n& ~sh->evtchn_mask[i]\r\n& cpu_evtchn[i];\r\nprintk("%0*"PRI_xen_ulong"%s",\r\n(int)(sizeof(sh->evtchn_mask[0])*2),\r\npending, i % 8 == 0 ? "\n " : " ");\r\n}\r\nprintk("\npending list:\n");\r\nfor (i = 0; i < EVTCHN_2L_NR_CHANNELS; i++) {\r\nif (sync_test_bit(i, BM(sh->evtchn_pending))) {\r\nint word_idx = i / BITS_PER_EVTCHN_WORD;\r\nprintk(" %d: event %d -> irq %d%s%s%s\n",\r\ncpu_from_evtchn(i), i,\r\nget_evtchn_to_irq(i),\r\nsync_test_bit(word_idx, BM(&v->evtchn_pending_sel))\r\n? "" : " l2-clear",\r\n!sync_test_bit(i, BM(sh->evtchn_mask))\r\n? "" : " globally-masked",\r\nsync_test_bit(i, BM(cpu_evtchn))\r\n? "" : " locally-masked");\r\n}\r\n}\r\nspin_unlock_irqrestore(&debug_lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init xen_evtchn_2l_init(void)\r\n{\r\npr_info("Using 2-level ABI\n");\r\nevtchn_ops = &evtchn_ops_2l;\r\n}

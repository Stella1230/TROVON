static void max8998_data_to_tm(u8 *data, struct rtc_time *tm)\r\n{\r\ntm->tm_sec = bcd2bin(data[RTC_SEC]);\r\ntm->tm_min = bcd2bin(data[RTC_MIN]);\r\nif (data[RTC_HOUR] & HOUR_12) {\r\ntm->tm_hour = bcd2bin(data[RTC_HOUR] & 0x1f);\r\nif (data[RTC_HOUR] & HOUR_PM)\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour = bcd2bin(data[RTC_HOUR] & 0x3f);\r\ntm->tm_wday = data[RTC_WEEKDAY] & 0x07;\r\ntm->tm_mday = bcd2bin(data[RTC_DATE]);\r\ntm->tm_mon = bcd2bin(data[RTC_MONTH]);\r\ntm->tm_year = bcd2bin(data[RTC_YEAR1]) + bcd2bin(data[RTC_YEAR2]) * 100;\r\ntm->tm_year -= 1900;\r\n}\r\nstatic void max8998_tm_to_data(struct rtc_time *tm, u8 *data)\r\n{\r\ndata[RTC_SEC] = bin2bcd(tm->tm_sec);\r\ndata[RTC_MIN] = bin2bcd(tm->tm_min);\r\ndata[RTC_HOUR] = bin2bcd(tm->tm_hour);\r\ndata[RTC_WEEKDAY] = tm->tm_wday;\r\ndata[RTC_DATE] = bin2bcd(tm->tm_mday);\r\ndata[RTC_MONTH] = bin2bcd(tm->tm_mon);\r\ndata[RTC_YEAR1] = bin2bcd(tm->tm_year % 100);\r\ndata[RTC_YEAR2] = bin2bcd((tm->tm_year + 1900) / 100);\r\n}\r\nstatic int max8998_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8998_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[8];\r\nint ret;\r\nret = max8998_bulk_read(info->rtc, MAX8998_RTC_SEC, 8, data);\r\nif (ret < 0)\r\nreturn ret;\r\nmax8998_data_to_tm(data, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int max8998_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8998_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[8];\r\nint ret;\r\nmax8998_tm_to_data(tm, data);\r\nret = max8998_bulk_write(info->rtc, MAX8998_RTC_SEC, 8, data);\r\nif (info->lp3974_bug_workaround)\r\nmsleep(2000);\r\nreturn ret;\r\n}\r\nstatic int max8998_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8998_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[8];\r\nu8 val;\r\nint ret;\r\nret = max8998_bulk_read(info->rtc, MAX8998_ALARM0_SEC, 8, data);\r\nif (ret < 0)\r\nreturn ret;\r\nmax8998_data_to_tm(data, &alrm->time);\r\nret = max8998_read_reg(info->rtc, MAX8998_ALARM0_CONF, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nalrm->enabled = !!val;\r\nret = max8998_read_reg(info->rtc, MAX8998_RTC_STATUS, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val & ALARM0_STATUS)\r\nalrm->pending = 1;\r\nelse\r\nalrm->pending = 0;\r\nreturn 0;\r\n}\r\nstatic int max8998_rtc_stop_alarm(struct max8998_rtc_info *info)\r\n{\r\nint ret = max8998_write_reg(info->rtc, MAX8998_ALARM0_CONF, 0);\r\nif (info->lp3974_bug_workaround)\r\nmsleep(2000);\r\nreturn ret;\r\n}\r\nstatic int max8998_rtc_start_alarm(struct max8998_rtc_info *info)\r\n{\r\nint ret;\r\nu8 alarm0_conf = 0x77;\r\nif (info->lp3974_bug_workaround)\r\nalarm0_conf = 0x57;\r\nret = max8998_write_reg(info->rtc, MAX8998_ALARM0_CONF, alarm0_conf);\r\nif (info->lp3974_bug_workaround)\r\nmsleep(2000);\r\nreturn ret;\r\n}\r\nstatic int max8998_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8998_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[8];\r\nint ret;\r\nmax8998_tm_to_data(&alrm->time, data);\r\nret = max8998_rtc_stop_alarm(info);\r\nif (ret < 0)\r\nreturn ret;\r\nret = max8998_bulk_write(info->rtc, MAX8998_ALARM0_SEC, 8, data);\r\nif (ret < 0)\r\nreturn ret;\r\nif (info->lp3974_bug_workaround)\r\nmsleep(2000);\r\nif (alrm->enabled)\r\nret = max8998_rtc_start_alarm(info);\r\nreturn ret;\r\n}\r\nstatic int max8998_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct max8998_rtc_info *info = dev_get_drvdata(dev);\r\nif (enabled)\r\nreturn max8998_rtc_start_alarm(info);\r\nelse\r\nreturn max8998_rtc_stop_alarm(info);\r\n}\r\nstatic irqreturn_t max8998_rtc_alarm_irq(int irq, void *data)\r\n{\r\nstruct max8998_rtc_info *info = data;\r\nrtc_update_irq(info->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int max8998_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct max8998_dev *max8998 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8998_platform_data *pdata = max8998->pdata;\r\nstruct max8998_rtc_info *info;\r\nint ret;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(struct max8998_rtc_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->dev = &pdev->dev;\r\ninfo->max8998 = max8998;\r\ninfo->rtc = max8998->rtc;\r\nplatform_set_drvdata(pdev, info);\r\ninfo->rtc_dev = devm_rtc_device_register(&pdev->dev, "max8998-rtc",\r\n&max8998_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(info->rtc_dev)) {\r\nret = PTR_ERR(info->rtc_dev);\r\ndev_err(&pdev->dev, "Failed to register RTC device: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (!max8998->irq_domain)\r\ngoto no_irq;\r\ninfo->irq = irq_create_mapping(max8998->irq_domain, MAX8998_IRQ_ALARM0);\r\nif (!info->irq) {\r\ndev_warn(&pdev->dev, "Failed to map alarm IRQ\n");\r\ngoto no_irq;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, info->irq, NULL,\r\nmax8998_rtc_alarm_irq, 0, "rtc-alarm0", info);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ: %d: %d\n",\r\ninfo->irq, ret);\r\nno_irq:\r\ndev_info(&pdev->dev, "RTC CHIP NAME: %s\n", pdev->id_entry->name);\r\nif (pdata && pdata->rtc_delay) {\r\ninfo->lp3974_bug_workaround = true;\r\ndev_warn(&pdev->dev, "LP3974 with RTC REGERR option."\r\n" RTC updates will be extremely slow.\n");\r\n}\r\nreturn 0;\r\n}

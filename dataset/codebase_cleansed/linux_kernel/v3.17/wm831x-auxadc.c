static int wm831x_auxadc_read_irq(struct wm831x *wm831x,\r\nenum wm831x_auxadc input)\r\n{\r\nstruct wm831x_auxadc_req *req;\r\nint ret;\r\nbool ena = false;\r\nreq = kzalloc(sizeof(*req), GFP_KERNEL);\r\nif (!req)\r\nreturn -ENOMEM;\r\ninit_completion(&req->done);\r\nreq->input = input;\r\nreq->val = -ETIMEDOUT;\r\nmutex_lock(&wm831x->auxadc_lock);\r\nlist_add(&req->list, &wm831x->auxadc_pending);\r\nena = !wm831x->auxadc_active;\r\nif (ena) {\r\nret = wm831x_set_bits(wm831x, WM831X_AUXADC_CONTROL,\r\nWM831X_AUX_ENA, WM831X_AUX_ENA);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to enable AUXADC: %d\n",\r\nret);\r\ngoto out;\r\n}\r\n}\r\nif (!(wm831x->auxadc_active & (1 << input))) {\r\nret = wm831x_set_bits(wm831x, WM831X_AUXADC_SOURCE,\r\n1 << input, 1 << input);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to set AUXADC source: %d\n", ret);\r\ngoto out;\r\n}\r\nwm831x->auxadc_active |= 1 << input;\r\n}\r\nif (ena) {\r\nret = wm831x_set_bits(wm831x, WM831X_AUXADC_CONTROL,\r\nWM831X_AUX_CVT_ENA |\r\nWM831X_AUX_RATE_MASK,\r\nWM831X_AUX_CVT_ENA |\r\nWM831X_AUX_RATE_MASK);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to start AUXADC: %d\n",\r\nret);\r\ngoto out;\r\n}\r\n}\r\nmutex_unlock(&wm831x->auxadc_lock);\r\nwait_for_completion_timeout(&req->done, msecs_to_jiffies(500));\r\nmutex_lock(&wm831x->auxadc_lock);\r\nlist_del(&req->list);\r\nret = req->val;\r\nout:\r\nmutex_unlock(&wm831x->auxadc_lock);\r\nkfree(req);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t wm831x_auxadc_irq(int irq, void *irq_data)\r\n{\r\nstruct wm831x *wm831x = irq_data;\r\nstruct wm831x_auxadc_req *req;\r\nint ret, input, val;\r\nret = wm831x_reg_read(wm831x, WM831X_AUXADC_DATA);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to read AUXADC data: %d\n", ret);\r\nreturn IRQ_NONE;\r\n}\r\ninput = ((ret & WM831X_AUX_DATA_SRC_MASK)\r\n>> WM831X_AUX_DATA_SRC_SHIFT) - 1;\r\nif (input == 14)\r\ninput = WM831X_AUX_CAL;\r\nval = ret & WM831X_AUX_DATA_MASK;\r\nmutex_lock(&wm831x->auxadc_lock);\r\nwm831x_set_bits(wm831x, WM831X_AUXADC_SOURCE,\r\n1 << input, 0);\r\nwm831x->auxadc_active &= ~(1 << input);\r\nif (!wm831x->auxadc_active)\r\nwm831x_reg_write(wm831x, WM831X_AUXADC_CONTROL, 0);\r\nlist_for_each_entry(req, &wm831x->auxadc_pending, list) {\r\nif (req->input == input) {\r\nreq->val = val;\r\ncomplete(&req->done);\r\n}\r\n}\r\nmutex_unlock(&wm831x->auxadc_lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm831x_auxadc_read_polled(struct wm831x *wm831x,\r\nenum wm831x_auxadc input)\r\n{\r\nint ret, src, timeout;\r\nmutex_lock(&wm831x->auxadc_lock);\r\nret = wm831x_set_bits(wm831x, WM831X_AUXADC_CONTROL,\r\nWM831X_AUX_ENA, WM831X_AUX_ENA);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to enable AUXADC: %d\n", ret);\r\ngoto out;\r\n}\r\nsrc = input;\r\nret = wm831x_reg_write(wm831x, WM831X_AUXADC_SOURCE,\r\n1 << src);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to set AUXADC source: %d\n", ret);\r\ngoto out;\r\n}\r\nret = wm831x_set_bits(wm831x, WM831X_AUXADC_CONTROL,\r\nWM831X_AUX_CVT_ENA, WM831X_AUX_CVT_ENA);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to start AUXADC: %d\n", ret);\r\ngoto disable;\r\n}\r\ntimeout = 5;\r\nwhile (timeout) {\r\nmsleep(1);\r\nret = wm831x_reg_read(wm831x,\r\nWM831X_INTERRUPT_STATUS_1);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev,\r\n"ISR 1 read failed: %d\n", ret);\r\ngoto disable;\r\n}\r\nif (ret & WM831X_AUXADC_DATA_EINT) {\r\nwm831x_reg_write(wm831x,\r\nWM831X_INTERRUPT_STATUS_1,\r\nWM831X_AUXADC_DATA_EINT);\r\nbreak;\r\n} else {\r\ndev_err(wm831x->dev,\r\n"AUXADC conversion timeout\n");\r\nret = -EBUSY;\r\ngoto disable;\r\n}\r\n}\r\nret = wm831x_reg_read(wm831x, WM831X_AUXADC_DATA);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to read AUXADC data: %d\n", ret);\r\ngoto disable;\r\n}\r\nsrc = ((ret & WM831X_AUX_DATA_SRC_MASK)\r\n>> WM831X_AUX_DATA_SRC_SHIFT) - 1;\r\nif (src == 14)\r\nsrc = WM831X_AUX_CAL;\r\nif (src != input) {\r\ndev_err(wm831x->dev, "Data from source %d not %d\n",\r\nsrc, input);\r\nret = -EINVAL;\r\n} else {\r\nret &= WM831X_AUX_DATA_MASK;\r\n}\r\ndisable:\r\nwm831x_set_bits(wm831x, WM831X_AUXADC_CONTROL, WM831X_AUX_ENA, 0);\r\nout:\r\nmutex_unlock(&wm831x->auxadc_lock);\r\nreturn ret;\r\n}\r\nint wm831x_auxadc_read(struct wm831x *wm831x, enum wm831x_auxadc input)\r\n{\r\nreturn wm831x->auxadc_read(wm831x, input);\r\n}\r\nint wm831x_auxadc_read_uv(struct wm831x *wm831x, enum wm831x_auxadc input)\r\n{\r\nint ret;\r\nret = wm831x_auxadc_read(wm831x, input);\r\nif (ret < 0)\r\nreturn ret;\r\nret *= 1465;\r\nreturn ret;\r\n}\r\nvoid wm831x_auxadc_init(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nmutex_init(&wm831x->auxadc_lock);\r\nINIT_LIST_HEAD(&wm831x->auxadc_pending);\r\nif (wm831x->irq) {\r\nwm831x->auxadc_read = wm831x_auxadc_read_irq;\r\nret = request_threaded_irq(wm831x_irq(wm831x,\r\nWM831X_IRQ_AUXADC_DATA),\r\nNULL, wm831x_auxadc_irq, 0,\r\n"auxadc", wm831x);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "AUXADC IRQ request failed: %d\n",\r\nret);\r\nwm831x->auxadc_read = NULL;\r\n}\r\n}\r\nif (!wm831x->auxadc_read)\r\nwm831x->auxadc_read = wm831x_auxadc_read_polled;\r\n}

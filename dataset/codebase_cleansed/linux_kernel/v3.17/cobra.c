static unsigned char cobra_read_packet(struct gameport *gameport, unsigned int *data)\r\n{\r\nunsigned long flags;\r\nunsigned char u, v, w;\r\n__u64 buf[2];\r\nint r[2], t[2];\r\nint i, j, ret;\r\nint strobe = gameport_time(gameport, COBRA_MAX_STROBE);\r\nfor (i = 0; i < 2; i++) {\r\nr[i] = buf[i] = 0;\r\nt[i] = COBRA_MAX_STROBE;\r\n}\r\nlocal_irq_save(flags);\r\nu = gameport_read(gameport);\r\ndo {\r\nt[0]--; t[1]--;\r\nv = gameport_read(gameport);\r\nfor (i = 0, w = u ^ v; i < 2 && w; i++, w >>= 2)\r\nif (w & 0x30) {\r\nif ((w & 0x30) < 0x30 && r[i] < COBRA_LENGTH && t[i] > 0) {\r\nbuf[i] |= (__u64)((w >> 5) & 1) << r[i]++;\r\nt[i] = strobe;\r\nu = v;\r\n} else t[i] = 0;\r\n}\r\n} while (t[0] > 0 || t[1] > 0);\r\nlocal_irq_restore(flags);\r\nret = 0;\r\nfor (i = 0; i < 2; i++) {\r\nif (r[i] != COBRA_LENGTH) continue;\r\nfor (j = 0; j < COBRA_LENGTH && (buf[i] & 0x04104107f) ^ 0x041041040; j++)\r\nbuf[i] = (buf[i] >> 1) | ((__u64)(buf[i] & 1) << (COBRA_LENGTH - 1));\r\nif (j < COBRA_LENGTH) ret |= (1 << i);\r\ndata[i] = ((buf[i] >> 7) & 0x000001f) | ((buf[i] >> 8) & 0x00003e0)\r\n| ((buf[i] >> 9) & 0x0007c00) | ((buf[i] >> 10) & 0x00f8000)\r\n| ((buf[i] >> 11) & 0x1f00000);\r\n}\r\nreturn ret;\r\n}\r\nstatic void cobra_poll(struct gameport *gameport)\r\n{\r\nstruct cobra *cobra = gameport_get_drvdata(gameport);\r\nstruct input_dev *dev;\r\nunsigned int data[2];\r\nint i, j, r;\r\ncobra->reads++;\r\nif ((r = cobra_read_packet(gameport, data)) != cobra->exists) {\r\ncobra->bads++;\r\nreturn;\r\n}\r\nfor (i = 0; i < 2; i++)\r\nif (cobra->exists & r & (1 << i)) {\r\ndev = cobra->dev[i];\r\ninput_report_abs(dev, ABS_X, ((data[i] >> 4) & 1) - ((data[i] >> 3) & 1));\r\ninput_report_abs(dev, ABS_Y, ((data[i] >> 2) & 1) - ((data[i] >> 1) & 1));\r\nfor (j = 0; cobra_btn[j]; j++)\r\ninput_report_key(dev, cobra_btn[j], data[i] & (0x20 << j));\r\ninput_sync(dev);\r\n}\r\n}\r\nstatic int cobra_open(struct input_dev *dev)\r\n{\r\nstruct cobra *cobra = input_get_drvdata(dev);\r\ngameport_start_polling(cobra->gameport);\r\nreturn 0;\r\n}\r\nstatic void cobra_close(struct input_dev *dev)\r\n{\r\nstruct cobra *cobra = input_get_drvdata(dev);\r\ngameport_stop_polling(cobra->gameport);\r\n}\r\nstatic int cobra_connect(struct gameport *gameport, struct gameport_driver *drv)\r\n{\r\nstruct cobra *cobra;\r\nstruct input_dev *input_dev;\r\nunsigned int data[2];\r\nint i, j;\r\nint err;\r\ncobra = kzalloc(sizeof(struct cobra), GFP_KERNEL);\r\nif (!cobra)\r\nreturn -ENOMEM;\r\ncobra->gameport = gameport;\r\ngameport_set_drvdata(gameport, cobra);\r\nerr = gameport_open(gameport, drv, GAMEPORT_MODE_RAW);\r\nif (err)\r\ngoto fail1;\r\ncobra->exists = cobra_read_packet(gameport, data);\r\nfor (i = 0; i < 2; i++)\r\nif ((cobra->exists >> i) & data[i] & 1) {\r\nprintk(KERN_WARNING "cobra.c: Device %d on %s has the Ext bit set. ID is: %d"\r\n" Contact vojtech@ucw.cz\n", i, gameport->phys, (data[i] >> 2) & 7);\r\ncobra->exists &= ~(1 << i);\r\n}\r\nif (!cobra->exists) {\r\nerr = -ENODEV;\r\ngoto fail2;\r\n}\r\ngameport_set_poll_handler(gameport, cobra_poll);\r\ngameport_set_poll_interval(gameport, 20);\r\nfor (i = 0; i < 2; i++) {\r\nif (~(cobra->exists >> i) & 1)\r\ncontinue;\r\ncobra->dev[i] = input_dev = input_allocate_device();\r\nif (!input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail3;\r\n}\r\nsnprintf(cobra->phys[i], sizeof(cobra->phys[i]),\r\n"%s/input%d", gameport->phys, i);\r\ninput_dev->name = "Creative Labs Blaster GamePad Cobra";\r\ninput_dev->phys = cobra->phys[i];\r\ninput_dev->id.bustype = BUS_GAMEPORT;\r\ninput_dev->id.vendor = GAMEPORT_ID_VENDOR_CREATIVE;\r\ninput_dev->id.product = 0x0008;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &gameport->dev;\r\ninput_set_drvdata(input_dev, cobra);\r\ninput_dev->open = cobra_open;\r\ninput_dev->close = cobra_close;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_set_abs_params(input_dev, ABS_X, -1, 1, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, -1, 1, 0, 0);\r\nfor (j = 0; cobra_btn[j]; j++)\r\nset_bit(cobra_btn[j], input_dev->keybit);\r\nerr = input_register_device(cobra->dev[i]);\r\nif (err)\r\ngoto fail4;\r\n}\r\nreturn 0;\r\nfail4: input_free_device(cobra->dev[i]);\r\nfail3: while (--i >= 0)\r\nif (cobra->dev[i])\r\ninput_unregister_device(cobra->dev[i]);\r\nfail2: gameport_close(gameport);\r\nfail1: gameport_set_drvdata(gameport, NULL);\r\nkfree(cobra);\r\nreturn err;\r\n}\r\nstatic void cobra_disconnect(struct gameport *gameport)\r\n{\r\nstruct cobra *cobra = gameport_get_drvdata(gameport);\r\nint i;\r\nfor (i = 0; i < 2; i++)\r\nif ((cobra->exists >> i) & 1)\r\ninput_unregister_device(cobra->dev[i]);\r\ngameport_close(gameport);\r\ngameport_set_drvdata(gameport, NULL);\r\nkfree(cobra);\r\n}

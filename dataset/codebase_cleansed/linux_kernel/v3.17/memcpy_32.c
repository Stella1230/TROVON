__visible void *memcpy(void *to, const void *from, size_t n)\r\n{\r\n#ifdef CONFIG_X86_USE_3DNOW\r\nreturn __memcpy3d(to, from, n);\r\n#else\r\nreturn __memcpy(to, from, n);\r\n#endif\r\n}\r\n__visible void *memset(void *s, int c, size_t count)\r\n{\r\nreturn __memset(s, c, count);\r\n}\r\n__visible void *memmove(void *dest, const void *src, size_t n)\r\n{\r\nint d0,d1,d2,d3,d4,d5;\r\nchar *ret = dest;\r\n__asm__ __volatile__(\r\n"cmp $0x10, %0\n\t"\r\n"jb 1f\n\t"\r\n"cmp %2, %1\n\t"\r\n"jb 2f\n\t"\r\n"cmp $680, %0\n\t"\r\n"jb 3f\n\t"\r\n"mov %1, %3\n\t"\r\n"xor %2, %3\n\t"\r\n"and $0xff, %3\n\t"\r\n"jz 4f\n\t"\r\n"3:\n\t"\r\n"sub $0x10, %0\n\t"\r\n"3:\n\t"\r\n"sub $0x10, %0\n\t"\r\n"mov 0*4(%1), %3\n\t"\r\n"mov 1*4(%1), %4\n\t"\r\n"mov %3, 0*4(%2)\n\t"\r\n"mov %4, 1*4(%2)\n\t"\r\n"mov 2*4(%1), %3\n\t"\r\n"mov 3*4(%1), %4\n\t"\r\n"mov %3, 2*4(%2)\n\t"\r\n"mov %4, 3*4(%2)\n\t"\r\n"lea 0x10(%1), %1\n\t"\r\n"lea 0x10(%2), %2\n\t"\r\n"jae 3b\n\t"\r\n"add $0x10, %0\n\t"\r\n"jmp 1f\n\t"\r\n".p2align 4\n\t"\r\n"4:\n\t"\r\n"mov -4(%1, %0), %3\n\t"\r\n"lea -4(%2, %0), %4\n\t"\r\n"shr $2, %0\n\t"\r\n"rep movsl\n\t"\r\n"mov %3, (%4)\n\t"\r\n"jmp 11f\n\t"\r\n".p2align 4\n\t"\r\n"6:\n\t"\r\n"mov (%1), %3\n\t"\r\n"mov %2, %4\n\t"\r\n"lea -4(%1, %0), %1\n\t"\r\n"lea -4(%2, %0), %2\n\t"\r\n"shr $2, %0\n\t"\r\n"std\n\t"\r\n"rep movsl\n\t"\r\n"mov %3,(%4)\n\t"\r\n"cld\n\t"\r\n"jmp 11f\n\t"\r\n".p2align 4\n\t"\r\n"2:\n\t"\r\n"cmp $680, %0\n\t"\r\n"jb 5f\n\t"\r\n"mov %1, %3\n\t"\r\n"xor %2, %3\n\t"\r\n"and $0xff, %3\n\t"\r\n"jz 6b\n\t"\r\n"5:\n\t"\r\n"add %0, %1\n\t"\r\n"add %0, %2\n\t"\r\n"sub $0x10, %0\n\t"\r\n"7:\n\t"\r\n"sub $0x10, %0\n\t"\r\n"mov -1*4(%1), %3\n\t"\r\n"mov -2*4(%1), %4\n\t"\r\n"mov %3, -1*4(%2)\n\t"\r\n"mov %4, -2*4(%2)\n\t"\r\n"mov -3*4(%1), %3\n\t"\r\n"mov -4*4(%1), %4\n\t"\r\n"mov %3, -3*4(%2)\n\t"\r\n"mov %4, -4*4(%2)\n\t"\r\n"lea -0x10(%1), %1\n\t"\r\n"lea -0x10(%2), %2\n\t"\r\n"jae 7b\n\t"\r\n"add $0x10, %0\n\t"\r\n"sub %0, %1\n\t"\r\n"sub %0, %2\n\t"\r\n".p2align 4\n\t"\r\n"1:\n\t"\r\n"cmp $8, %0\n\t"\r\n"jb 8f\n\t"\r\n"mov 0*4(%1), %3\n\t"\r\n"mov 1*4(%1), %4\n\t"\r\n"mov -2*4(%1, %0), %5\n\t"\r\n"mov -1*4(%1, %0), %1\n\t"\r\n"mov %3, 0*4(%2)\n\t"\r\n"mov %4, 1*4(%2)\n\t"\r\n"mov %5, -2*4(%2, %0)\n\t"\r\n"mov %1, -1*4(%2, %0)\n\t"\r\n"jmp 11f\n\t"\r\n".p2align 4\n\t"\r\n"8:\n\t"\r\n"cmp $4, %0\n\t"\r\n"jb 9f\n\t"\r\n"mov 0*4(%1), %3\n\t"\r\n"mov -1*4(%1, %0), %4\n\t"\r\n"mov %3, 0*4(%2)\n\t"\r\n"mov %4, -1*4(%2, %0)\n\t"\r\n"jmp 11f\n\t"\r\n".p2align 4\n\t"\r\n"9:\n\t"\r\n"cmp $2, %0\n\t"\r\n"jb 10f\n\t"\r\n"movw 0*2(%1), %%dx\n\t"\r\n"movw -1*2(%1, %0), %%bx\n\t"\r\n"movw %%dx, 0*2(%2)\n\t"\r\n"movw %%bx, -1*2(%2, %0)\n\t"\r\n"jmp 11f\n\t"\r\n".p2align 4\n\t"\r\n"10:\n\t"\r\n"cmp $1, %0\n\t"\r\n"jb 11f\n\t"\r\n"movb (%1), %%cl\n\t"\r\n"movb %%cl, (%2)\n\t"\r\n".p2align 4\n\t"\r\n"11:"\r\n: "=&c" (d0), "=&S" (d1), "=&D" (d2),\r\n"=r" (d3),"=r" (d4), "=r"(d5)\r\n:"0" (n),\r\n"1" (src),\r\n"2" (dest)\r\n:"memory");\r\nreturn ret;\r\n}

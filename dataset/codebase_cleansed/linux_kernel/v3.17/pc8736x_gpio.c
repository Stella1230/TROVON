static inline void superio_outb(int addr, int val)\r\n{\r\noutb_p(addr, superio_cmd);\r\noutb_p(val, superio_cmd + 1);\r\n}\r\nstatic inline int superio_inb(int addr)\r\n{\r\noutb_p(addr, superio_cmd);\r\nreturn inb_p(superio_cmd + 1);\r\n}\r\nstatic int pc8736x_superio_present(void)\r\n{\r\nint id;\r\nsuperio_cmd = SIO_BASE1;\r\nid = superio_inb(SIO_SID);\r\nif (id == SIO_SID_PC87365 || id == SIO_SID_PC87366)\r\nreturn superio_cmd;\r\nsuperio_cmd = SIO_BASE2;\r\nid = superio_inb(SIO_SID);\r\nif (id == SIO_SID_PC87365 || id == SIO_SID_PC87366)\r\nreturn superio_cmd;\r\nreturn 0;\r\n}\r\nstatic void device_select(unsigned devldn)\r\n{\r\nsuperio_outb(SIO_UNIT_SEL, devldn);\r\nselected_device = devldn;\r\n}\r\nstatic void select_pin(unsigned iminor)\r\n{\r\ndevice_select(SIO_GPIO_UNIT);\r\nsuperio_outb(SIO_GPIO_PIN_SELECT,\r\n((iminor << 1) & 0xF0) | (iminor & 0x7));\r\n}\r\nstatic inline u32 pc8736x_gpio_configure_fn(unsigned index, u32 mask, u32 bits,\r\nu32 func_slct)\r\n{\r\nu32 config, new_config;\r\nmutex_lock(&pc8736x_gpio_config_lock);\r\ndevice_select(SIO_GPIO_UNIT);\r\nselect_pin(index);\r\nconfig = superio_inb(func_slct);\r\nnew_config = (config & mask) | bits;\r\nsuperio_outb(func_slct, new_config);\r\nmutex_unlock(&pc8736x_gpio_config_lock);\r\nreturn config;\r\n}\r\nstatic u32 pc8736x_gpio_configure(unsigned index, u32 mask, u32 bits)\r\n{\r\nreturn pc8736x_gpio_configure_fn(index, mask, bits,\r\nSIO_GPIO_PIN_CONFIG);\r\n}\r\nstatic int pc8736x_gpio_get(unsigned minor)\r\n{\r\nint port, bit, val;\r\nport = minor >> 3;\r\nbit = minor & 7;\r\nval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_IN);\r\nval >>= bit;\r\nval &= 1;\r\ndev_dbg(&pdev->dev, "_gpio_get(%d from %x bit %d) == val %d\n",\r\nminor, pc8736x_gpio_base + port_offset[port] + PORT_IN, bit,\r\nval);\r\nreturn val;\r\n}\r\nstatic void pc8736x_gpio_set(unsigned minor, int val)\r\n{\r\nint port, bit, curval;\r\nminor &= 0x1f;\r\nport = minor >> 3;\r\nbit = minor & 7;\r\ncurval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_OUT);\r\ndev_dbg(&pdev->dev, "addr:%x cur:%x bit-pos:%d cur-bit:%x + new:%d -> bit-new:%d\n",\r\npc8736x_gpio_base + port_offset[port] + PORT_OUT,\r\ncurval, bit, (curval & ~(1 << bit)), val, (val << bit));\r\nval = (curval & ~(1 << bit)) | (val << bit);\r\ndev_dbg(&pdev->dev, "gpio_set(minor:%d port:%d bit:%d)"\r\n" %2x -> %2x\n", minor, port, bit, curval, val);\r\noutb_p(val, pc8736x_gpio_base + port_offset[port] + PORT_OUT);\r\ncurval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_OUT);\r\nval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_IN);\r\ndev_dbg(&pdev->dev, "wrote %x, read: %x\n", curval, val);\r\npc8736x_gpio_shadow[port] = val;\r\n}\r\nstatic int pc8736x_gpio_current(unsigned minor)\r\n{\r\nint port, bit;\r\nminor &= 0x1f;\r\nport = minor >> 3;\r\nbit = minor & 7;\r\nreturn ((pc8736x_gpio_shadow[port] >> bit) & 0x01);\r\n}\r\nstatic void pc8736x_gpio_change(unsigned index)\r\n{\r\npc8736x_gpio_set(index, !pc8736x_gpio_current(index));\r\n}\r\nstatic int pc8736x_gpio_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned m = iminor(inode);\r\nfile->private_data = &pc8736x_gpio_ops;\r\ndev_dbg(&pdev->dev, "open %d\n", m);\r\nif (m >= PC8736X_GPIO_CT)\r\nreturn -EINVAL;\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic void __init pc8736x_init_shadow(void)\r\n{\r\nint port;\r\nfor (port = 0; port < 4; ++port)\r\npc8736x_gpio_shadow[port]\r\n= inb_p(pc8736x_gpio_base + port_offset[port]\r\n+ PORT_OUT);\r\n}\r\nstatic int __init pc8736x_gpio_init(void)\r\n{\r\nint rc;\r\ndev_t devid;\r\npdev = platform_device_alloc(DEVNAME, 0);\r\nif (!pdev)\r\nreturn -ENOMEM;\r\nrc = platform_device_add(pdev);\r\nif (rc) {\r\nrc = -ENODEV;\r\ngoto undo_platform_dev_alloc;\r\n}\r\ndev_info(&pdev->dev, "NatSemi pc8736x GPIO Driver Initializing\n");\r\nif (!pc8736x_superio_present()) {\r\nrc = -ENODEV;\r\ndev_err(&pdev->dev, "no device found\n");\r\ngoto undo_platform_dev_add;\r\n}\r\npc8736x_gpio_ops.dev = &pdev->dev;\r\nrc = superio_inb(SIO_CF1);\r\nif (!(rc & 0x01)) {\r\nrc = -ENODEV;\r\ndev_err(&pdev->dev, "device not enabled\n");\r\ngoto undo_platform_dev_add;\r\n}\r\ndevice_select(SIO_GPIO_UNIT);\r\nif (!superio_inb(SIO_UNIT_ACT)) {\r\nrc = -ENODEV;\r\ndev_err(&pdev->dev, "GPIO unit not enabled\n");\r\ngoto undo_platform_dev_add;\r\n}\r\npc8736x_gpio_base = (superio_inb(SIO_BASE_HADDR) << 8\r\n| superio_inb(SIO_BASE_LADDR));\r\nif (!request_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE, DEVNAME)) {\r\nrc = -ENODEV;\r\ndev_err(&pdev->dev, "GPIO ioport %x busy\n",\r\npc8736x_gpio_base);\r\ngoto undo_platform_dev_add;\r\n}\r\ndev_info(&pdev->dev, "GPIO ioport %x reserved\n", pc8736x_gpio_base);\r\nif (major) {\r\ndevid = MKDEV(major, 0);\r\nrc = register_chrdev_region(devid, PC8736X_GPIO_CT, DEVNAME);\r\n} else {\r\nrc = alloc_chrdev_region(&devid, 0, PC8736X_GPIO_CT, DEVNAME);\r\nmajor = MAJOR(devid);\r\n}\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "register-chrdev failed: %d\n", rc);\r\ngoto undo_request_region;\r\n}\r\nif (!major) {\r\nmajor = rc;\r\ndev_dbg(&pdev->dev, "got dynamic major %d\n", major);\r\n}\r\npc8736x_init_shadow();\r\ncdev_init(&pc8736x_gpio_cdev, &pc8736x_gpio_fileops);\r\ncdev_add(&pc8736x_gpio_cdev, devid, PC8736X_GPIO_CT);\r\nreturn 0;\r\nundo_request_region:\r\nrelease_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE);\r\nundo_platform_dev_add:\r\nplatform_device_del(pdev);\r\nundo_platform_dev_alloc:\r\nplatform_device_put(pdev);\r\nreturn rc;\r\n}\r\nstatic void __exit pc8736x_gpio_cleanup(void)\r\n{\r\ndev_dbg(&pdev->dev, "cleanup\n");\r\ncdev_del(&pc8736x_gpio_cdev);\r\nunregister_chrdev_region(MKDEV(major,0), PC8736X_GPIO_CT);\r\nrelease_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE);\r\nplatform_device_unregister(pdev);\r\n}

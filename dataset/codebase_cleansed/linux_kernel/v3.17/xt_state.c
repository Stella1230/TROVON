static bool\r\nstate_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_state_info *sinfo = par->matchinfo;\r\nenum ip_conntrack_info ctinfo;\r\nunsigned int statebit;\r\nstruct nf_conn *ct = nf_ct_get(skb, &ctinfo);\r\nif (!ct)\r\nstatebit = XT_STATE_INVALID;\r\nelse {\r\nif (nf_ct_is_untracked(ct))\r\nstatebit = XT_STATE_UNTRACKED;\r\nelse\r\nstatebit = XT_STATE_BIT(ctinfo);\r\n}\r\nreturn (sinfo->statemask & statebit);\r\n}\r\nstatic int state_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nint ret;\r\nret = nf_ct_l3proto_try_module_get(par->family);\r\nif (ret < 0)\r\npr_info("cannot load conntrack support for proto=%u\n",\r\npar->family);\r\nreturn ret;\r\n}\r\nstatic void state_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nnf_ct_l3proto_module_put(par->family);\r\n}\r\nstatic int __init state_mt_init(void)\r\n{\r\nreturn xt_register_match(&state_mt_reg);\r\n}\r\nstatic void __exit state_mt_exit(void)\r\n{\r\nxt_unregister_match(&state_mt_reg);\r\n}

static int hci_h4p_open_firmware(struct hci_h4p_info *info,\r\nconst struct firmware **fw_entry)\r\n{\r\nint err;\r\nfw_pos = 0;\r\nBT_DBG("Opening firmware man_id 0x%.2x ver_id 0x%.2x",\r\ninfo->man_id, info->ver_id);\r\nswitch (info->man_id) {\r\ncase H4P_ID_TI1271:\r\nswitch (info->ver_id) {\r\ncase 0xe1:\r\nerr = request_firmware(fw_entry, FW_NAME_TI1271_PRELE,\r\ninfo->dev);\r\nbreak;\r\ncase 0xd1:\r\ncase 0xf1:\r\nerr = request_firmware(fw_entry, FW_NAME_TI1271_LE,\r\ninfo->dev);\r\nbreak;\r\ndefault:\r\nerr = request_firmware(fw_entry, FW_NAME_TI1271,\r\ninfo->dev);\r\n}\r\nbreak;\r\ncase H4P_ID_CSR:\r\nerr = request_firmware(fw_entry, FW_NAME_CSR, info->dev);\r\nbreak;\r\ncase H4P_ID_BCM2048:\r\nerr = request_firmware(fw_entry, FW_NAME_BCM2048, info->dev);\r\nbreak;\r\ndefault:\r\ndev_err(info->dev, "Invalid chip type\n");\r\n*fw_entry = NULL;\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nstatic void hci_h4p_close_firmware(const struct firmware *fw_entry)\r\n{\r\nrelease_firmware(fw_entry);\r\n}\r\nstatic int hci_h4p_read_fw_cmd(struct hci_h4p_info *info, struct sk_buff **skb,\r\nconst struct firmware *fw_entry, gfp_t how)\r\n{\r\nunsigned int cmd_len;\r\nif (fw_pos >= fw_entry->size)\r\nreturn 0;\r\nif (fw_pos + 2 > fw_entry->size) {\r\ndev_err(info->dev, "Corrupted firmware image 1\n");\r\nreturn -EMSGSIZE;\r\n}\r\ncmd_len = fw_entry->data[fw_pos++];\r\ncmd_len += fw_entry->data[fw_pos++] << 8;\r\nif (cmd_len == 0)\r\nreturn 0;\r\nif (fw_pos + cmd_len > fw_entry->size) {\r\ndev_err(info->dev, "Corrupted firmware image 2\n");\r\nreturn -EMSGSIZE;\r\n}\r\n*skb = bt_skb_alloc(cmd_len, how);\r\nif (!*skb) {\r\ndev_err(info->dev, "Cannot reserve memory for buffer\n");\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(skb_put(*skb, cmd_len), &fw_entry->data[fw_pos], cmd_len);\r\nfw_pos += cmd_len;\r\nreturn (*skb)->len;\r\n}\r\nint hci_h4p_read_fw(struct hci_h4p_info *info, struct sk_buff_head *fw_queue)\r\n{\r\nconst struct firmware *fw_entry = NULL;\r\nstruct sk_buff *skb = NULL;\r\nint err;\r\nerr = hci_h4p_open_firmware(info, &fw_entry);\r\nif (err < 0 || !fw_entry)\r\ngoto err_clean;\r\nwhile ((err = hci_h4p_read_fw_cmd(info, &skb, fw_entry, GFP_KERNEL))) {\r\nif (err < 0 || !skb)\r\ngoto err_clean;\r\nskb_queue_tail(fw_queue, skb);\r\n}\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb) {\r\nerr = -EMSGSIZE;\r\ngoto err_clean;\r\n}\r\nkfree_skb(skb);\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb) {\r\nerr = -EMSGSIZE;\r\ngoto err_clean;\r\n}\r\nkfree_skb(skb);\r\nerr_clean:\r\nhci_h4p_close_firmware(fw_entry);\r\nreturn err;\r\n}\r\nint hci_h4p_send_fw(struct hci_h4p_info *info, struct sk_buff_head *fw_queue)\r\n{\r\nint err;\r\nswitch (info->man_id) {\r\ncase H4P_ID_CSR:\r\nerr = hci_h4p_bc4_send_fw(info, fw_queue);\r\nbreak;\r\ncase H4P_ID_TI1271:\r\nerr = hci_h4p_ti1273_send_fw(info, fw_queue);\r\nbreak;\r\ncase H4P_ID_BCM2048:\r\nerr = hci_h4p_bcm_send_fw(info, fw_queue);\r\nbreak;\r\ndefault:\r\ndev_err(info->dev, "Don't know how to send firmware\n");\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nvoid hci_h4p_parse_fw_event(struct hci_h4p_info *info, struct sk_buff *skb)\r\n{\r\nswitch (info->man_id) {\r\ncase H4P_ID_CSR:\r\nhci_h4p_bc4_parse_fw_event(info, skb);\r\nbreak;\r\ncase H4P_ID_TI1271:\r\nhci_h4p_ti1273_parse_fw_event(info, skb);\r\nbreak;\r\ncase H4P_ID_BCM2048:\r\nhci_h4p_bcm_parse_fw_event(info, skb);\r\nbreak;\r\ndefault:\r\ndev_err(info->dev, "Don't know how to parse fw event\n");\r\ninfo->fw_error = -EINVAL;\r\n}\r\nreturn;\r\n}

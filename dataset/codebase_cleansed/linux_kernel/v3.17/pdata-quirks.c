static void __init __used legacy_init_wl12xx(unsigned ref_clock,\r\nunsigned tcxo_clock,\r\nint gpio)\r\n{\r\nint res;\r\nwl12xx.board_ref_clock = ref_clock;\r\nwl12xx.board_tcxo_clock = tcxo_clock;\r\nwl12xx.irq = gpio_to_irq(gpio);\r\nres = wl12xx_set_platform_data(&wl12xx);\r\nif (res) {\r\npr_err("error setting wl12xx data: %d\n", res);\r\nreturn;\r\n}\r\n}\r\nstatic inline void legacy_init_wl12xx(unsigned ref_clock,\r\nunsigned tcxo_clock,\r\nint gpio)\r\n{\r\n}\r\nstatic void __init omap2420_n8x0_legacy_init(void)\r\n{\r\nomap_auxdata_lookup[0].platform_data = n8x0_legacy_init();\r\n}\r\nstatic void __init hsmmc2_internal_input_clk(void)\r\n{\r\nu32 reg;\r\nreg = omap_ctrl_readl(OMAP343X_CONTROL_DEVCONF1);\r\nreg |= OMAP2_MMCSDIO2ADPCLKISEL;\r\nomap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);\r\n}\r\nstatic int omap3_sbc_t3730_twl_callback(struct device *dev,\r\nunsigned gpio,\r\nunsigned ngpio)\r\n{\r\nint res;\r\nres = gpio_request_one(gpio + 2, GPIOF_OUT_INIT_HIGH,\r\n"wlan pwr");\r\nif (res)\r\nreturn res;\r\ngpio_export(gpio, 0);\r\nreturn 0;\r\n}\r\nstatic void __init omap3_sbc_t3x_usb_hub_init(int gpio, char *hub_name)\r\n{\r\nint err = gpio_request_one(gpio, GPIOF_OUT_INIT_LOW, hub_name);\r\nif (err) {\r\npr_err("SBC-T3x: %s reset gpio request failed: %d\n",\r\nhub_name, err);\r\nreturn;\r\n}\r\ngpio_export(gpio, 0);\r\nudelay(10);\r\ngpio_set_value(gpio, 1);\r\nmsleep(1);\r\n}\r\nstatic void __init omap3_sbc_t3730_twl_init(void)\r\n{\r\ntwl_gpio_auxdata.setup = omap3_sbc_t3730_twl_callback;\r\n}\r\nstatic void __init omap3_sbc_t3730_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 136);\r\nomap_ads7846_init(1, 57, 0, NULL);\r\n}\r\nstatic void __init omap3_sbc_t3530_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");\r\nomap_ads7846_init(1, 57, 0, NULL);\r\n}\r\nstatic void __init omap3_igep0020_legacy_init(void)\r\n{\r\n}\r\nstatic void __init omap3_evm_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 149);\r\n}\r\nstatic void __init omap3_zoom_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_26, 0, 162);\r\n}\r\nstatic void am35xx_enable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR |\r\nAM35XX_CPGMAC_C0_MISC_PULSE_CLR | AM35XX_CPGMAC_C0_RX_THRESH_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic void am35xx_disable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic void __init am35xx_emac_reset(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\nv &= ~AM35XX_CPGMACSS_SW_RST;\r\nomap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);\r\nomap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\n}\r\nstatic void __init omap3_sbc_t3517_wifi_init(void)\r\n{\r\nint err = gpio_request_array(cm_t3517_wlan_gpios,\r\nARRAY_SIZE(cm_t3517_wlan_gpios));\r\nif (err) {\r\npr_err("SBC-T3517: wl12xx gpios request failed: %d\n", err);\r\nreturn;\r\n}\r\ngpio_export(cm_t3517_wlan_gpios[0].gpio, 0);\r\ngpio_export(cm_t3517_wlan_gpios[1].gpio, 0);\r\nmsleep(100);\r\ngpio_set_value(cm_t3517_wlan_gpios[1].gpio, 0);\r\n}\r\nstatic void __init omap3_sbc_t3517_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(152, "cm-t3517 usb hub");\r\nomap3_sbc_t3x_usb_hub_init(98, "sb-t35 usb hub");\r\nam35xx_emac_reset();\r\nhsmmc2_internal_input_clk();\r\nomap3_sbc_t3517_wifi_init();\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 145);\r\nomap_ads7846_init(1, 57, 0, NULL);\r\n}\r\nstatic void __init am3517_evm_legacy_init(void)\r\n{\r\nam35xx_emac_reset();\r\n}\r\nstatic void __init nokia_n900_legacy_init(void)\r\n{\r\nhsmmc2_internal_input_clk();\r\nif (omap_type() == OMAP2_DEVICE_TYPE_SEC) {\r\nif (IS_ENABLED(CONFIG_ARM_ERRATA_430973)) {\r\npr_info("RX-51: Enabling ARM errata 430973 workaround\n");\r\nrx51_secure_update_aux_cr(BIT(6), 0);\r\n} else {\r\npr_warning("RX-51: Not enabling ARM errata 430973 workaround\n");\r\npr_warning("Thumb binaries may crash randomly without this workaround\n");\r\n}\r\npr_info("RX-51: Registring OMAP3 HWRNG device\n");\r\nplatform_device_register(&omap3_rom_rng_device);\r\n}\r\n}\r\nstatic void __init omap4_sdp_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_26,\r\nWL12XX_TCXOCLOCK_26, 53);\r\n}\r\nstatic void __init omap4_panda_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);\r\n}\r\nstatic void __init var_som_om44_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 41);\r\n}\r\nstatic void __init am335x_evmsk_legacy_init(void)\r\n{\r\nlegacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 31);\r\n}\r\nstatic void __init omap5_uevm_legacy_init(void)\r\n{\r\n}\r\nvoid omap_pcs_legacy_init(int irq, void (*rearm)(void))\r\n{\r\npcs_pdata.irq = irq;\r\npcs_pdata.rearm = rearm;\r\n}\r\nvoid omap_auxdata_legacy_init(struct device *dev)\r\n{\r\nif (dev->platform_data)\r\nreturn;\r\nif (strcmp("twl4030-gpio", dev_name(dev)))\r\nreturn;\r\ndev->platform_data = &twl_gpio_auxdata;\r\n}\r\nstatic void pdata_quirks_check(struct pdata_init *quirks)\r\n{\r\nwhile (quirks->compatible) {\r\nif (of_machine_is_compatible(quirks->compatible)) {\r\nif (quirks->fn)\r\nquirks->fn();\r\nbreak;\r\n}\r\nquirks++;\r\n}\r\n}\r\nvoid __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)\r\n{\r\nomap_sdrc_init(NULL, NULL);\r\npdata_quirks_check(auxdata_quirks);\r\nof_platform_populate(NULL, omap_dt_match_table,\r\nomap_auxdata_lookup, NULL);\r\npdata_quirks_check(pdata_quirks);\r\n}

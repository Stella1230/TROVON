static inline struct ab8500_usb *phy_to_ab(struct usb_phy *x)\r\n{\r\nreturn container_of(x, struct ab8500_usb, phy);\r\n}\r\nstatic void ab8500_usb_wd_workaround(struct ab8500_usb *ab)\r\n{\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\nAB8500_BIT_WD_CTRL_ENABLE);\r\nudelay(AB8500_WD_KICK_DELAY_US);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\n(AB8500_BIT_WD_CTRL_ENABLE\r\n| AB8500_BIT_WD_CTRL_KICK));\r\nudelay(AB8500_WD_V11_DISABLE_DELAY_US);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\n0);\r\n}\r\nstatic void ab8500_usb_regulator_enable(struct ab8500_usb *ab)\r\n{\r\nint ret, volt;\r\nret = regulator_enable(ab->v_ape);\r\nif (ret)\r\ndev_err(ab->dev, "Failed to enable v-ape\n");\r\nif (ab->flags & AB8500_USB_FLAG_REGULATOR_SET_VOLTAGE) {\r\nab->saved_v_ulpi = regulator_get_voltage(ab->v_ulpi);\r\nif (ab->saved_v_ulpi < 0)\r\ndev_err(ab->dev, "Failed to get v_ulpi voltage\n");\r\nret = regulator_set_voltage(ab->v_ulpi, 1300000, 1350000);\r\nif (ret < 0)\r\ndev_err(ab->dev, "Failed to set the Vintcore to 1.3V, ret=%d\n",\r\nret);\r\nret = regulator_set_optimum_mode(ab->v_ulpi, 28000);\r\nif (ret < 0)\r\ndev_err(ab->dev, "Failed to set optimum mode (ret=%d)\n",\r\nret);\r\n}\r\nret = regulator_enable(ab->v_ulpi);\r\nif (ret)\r\ndev_err(ab->dev, "Failed to enable vddulpivio18\n");\r\nif (ab->flags & AB8500_USB_FLAG_REGULATOR_SET_VOLTAGE) {\r\nvolt = regulator_get_voltage(ab->v_ulpi);\r\nif ((volt != 1300000) && (volt != 1350000))\r\ndev_err(ab->dev, "Vintcore is not set to 1.3V volt=%d\n",\r\nvolt);\r\n}\r\nret = regulator_enable(ab->v_musb);\r\nif (ret)\r\ndev_err(ab->dev, "Failed to enable musb_1v8\n");\r\n}\r\nstatic void ab8500_usb_regulator_disable(struct ab8500_usb *ab)\r\n{\r\nint ret;\r\nregulator_disable(ab->v_musb);\r\nregulator_disable(ab->v_ulpi);\r\nif (ab->flags & AB8500_USB_FLAG_REGULATOR_SET_VOLTAGE) {\r\nif (ab->saved_v_ulpi > 0) {\r\nret = regulator_set_voltage(ab->v_ulpi,\r\nab->saved_v_ulpi, ab->saved_v_ulpi);\r\nif (ret < 0)\r\ndev_err(ab->dev, "Failed to set the Vintcore to %duV, ret=%d\n",\r\nab->saved_v_ulpi, ret);\r\n}\r\nret = regulator_set_optimum_mode(ab->v_ulpi, 0);\r\nif (ret < 0)\r\ndev_err(ab->dev, "Failed to set optimum mode (ret=%d)\n",\r\nret);\r\n}\r\nregulator_disable(ab->v_ape);\r\n}\r\nstatic void ab8500_usb_wd_linkstatus(struct ab8500_usb *ab, u8 bit)\r\n{\r\nif (is_ab8500_2p0(ab->ab8500)) {\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nbit, bit);\r\nudelay(AB8500_V20_31952_DISABLE_DELAY_US);\r\n}\r\n}\r\nstatic void ab8500_usb_phy_enable(struct ab8500_usb *ab, bool sel_host)\r\n{\r\nu8 bit;\r\nbit = sel_host ? AB8500_BIT_PHY_CTRL_HOST_EN :\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN;\r\nab->pinctrl = pinctrl_get_select(ab->dev, PINCTRL_STATE_DEFAULT);\r\nif (IS_ERR(ab->pinctrl))\r\ndev_err(ab->dev, "could not get/set default pinstate\n");\r\nif (clk_prepare_enable(ab->sysclk))\r\ndev_err(ab->dev, "can't prepare/enable clock\n");\r\nab8500_usb_regulator_enable(ab);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nbit, bit);\r\nif (ab->flags & AB8500_USB_FLAG_USE_VBUS_HOST_QUIRK) {\r\nif (sel_host)\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8540_USB_OTG_CTL_REG,\r\nAB8540_BIT_OTG_CTL_VBUS_VALID_ENA |\r\nAB8540_BIT_OTG_CTL_ID_HOST_ENA |\r\nAB8540_BIT_OTG_CTL_ID_DEV_ENA);\r\n}\r\n}\r\nstatic void ab8500_usb_phy_disable(struct ab8500_usb *ab, bool sel_host)\r\n{\r\nu8 bit;\r\nbit = sel_host ? AB8500_BIT_PHY_CTRL_HOST_EN :\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN;\r\nab8500_usb_wd_linkstatus(ab, bit);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nbit, 0);\r\nab8500_usb_wd_workaround(ab);\r\nclk_disable_unprepare(ab->sysclk);\r\nab8500_usb_regulator_disable(ab);\r\nif (!IS_ERR(ab->pinctrl)) {\r\nab->pins_sleep = pinctrl_lookup_state(ab->pinctrl,\r\nPINCTRL_STATE_SLEEP);\r\nif (IS_ERR(ab->pins_sleep))\r\ndev_dbg(ab->dev, "could not get sleep pinstate\n");\r\nelse if (pinctrl_select_state(ab->pinctrl, ab->pins_sleep))\r\ndev_err(ab->dev, "could not set pins to sleep state\n");\r\npinctrl_put(ab->pinctrl);\r\n}\r\n}\r\nstatic int ab9540_usb_link_status_update(struct ab8500_usb *ab,\r\nenum ab9540_usb_link_status lsts)\r\n{\r\nenum ux500_musb_vbus_id_status event = 0;\r\ndev_dbg(ab->dev, "ab9540_usb_link_status_update %d\n", lsts);\r\nif (ab->previous_link_status_state == USB_LINK_HM_IDGND_9540 &&\r\n(lsts == USB_LINK_STD_HOST_C_NS_9540 ||\r\nlsts == USB_LINK_STD_HOST_NC_9540))\r\nreturn 0;\r\nif (ab->previous_link_status_state == USB_LINK_ACA_RID_A_9540 &&\r\n(lsts == USB_LINK_STD_HOST_NC_9540))\r\nreturn 0;\r\nab->previous_link_status_state = lsts;\r\nswitch (lsts) {\r\ncase USB_LINK_ACA_RID_B_9540:\r\nevent = UX500_MUSB_RIDB;\r\ncase USB_LINK_NOT_CONFIGURED_9540:\r\ncase USB_LINK_RESERVED0_9540:\r\ncase USB_LINK_RESERVED1_9540:\r\ncase USB_LINK_RESERVED2_9540:\r\ncase USB_LINK_RESERVED3_9540:\r\nif (ab->mode == USB_PERIPHERAL)\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_CLEAN, &ab->vbus_draw);\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\nif (event != UX500_MUSB_RIDB)\r\nevent = UX500_MUSB_NONE;\r\nab->phy.state = OTG_STATE_B_IDLE;\r\nbreak;\r\ncase USB_LINK_ACA_RID_C_NM_9540:\r\nevent = UX500_MUSB_RIDC;\r\ncase USB_LINK_STD_HOST_NC_9540:\r\ncase USB_LINK_STD_HOST_C_NS_9540:\r\ncase USB_LINK_STD_HOST_C_S_9540:\r\ncase USB_LINK_CDP_9540:\r\nif (ab->mode == USB_HOST) {\r\nab->mode = USB_PERIPHERAL;\r\nab8500_usb_host_phy_dis(ab);\r\nab8500_usb_peri_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_PERIPHERAL;\r\nab8500_usb_peri_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (event != UX500_MUSB_RIDC)\r\nevent = UX500_MUSB_VBUS;\r\nbreak;\r\ncase USB_LINK_ACA_RID_A_9540:\r\nevent = UX500_MUSB_RIDA;\r\ncase USB_LINK_HM_IDGND_9540:\r\ncase USB_LINK_STD_UPSTREAM_9540:\r\nif (ab->mode == USB_PERIPHERAL) {\r\nab->mode = USB_HOST;\r\nab8500_usb_peri_phy_dis(ab);\r\nab8500_usb_host_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_HOST;\r\nab8500_usb_host_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nab->phy.otg->default_a = true;\r\nif (event != UX500_MUSB_RIDA)\r\nevent = UX500_MUSB_ID;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_DEDICATED_CHG_9540:\r\nab->mode = USB_DEDICATED_CHG;\r\nevent = UX500_MUSB_CHARGER;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_PHYEN_NO_VBUS_NO_IDGND_9540:\r\ncase USB_LINK_STD_UPSTREAM_NO_IDGNG_VBUS_9540:\r\nif (!(is_ab9540_2p0_or_earlier(ab->ab8500))) {\r\nevent = UX500_MUSB_NONE;\r\nif (ab->mode == USB_HOST) {\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_host_phy_dis(ab);\r\nab->mode = USB_IDLE;\r\n}\r\nif (ab->mode == USB_PERIPHERAL) {\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_peri_phy_dis(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_CLEAN,\r\n&ab->vbus_draw);\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8540_usb_link_status_update(struct ab8500_usb *ab,\r\nenum ab8540_usb_link_status lsts)\r\n{\r\nenum ux500_musb_vbus_id_status event = 0;\r\ndev_dbg(ab->dev, "ab8540_usb_link_status_update %d\n", lsts);\r\nif (ab->enabled_charging_detection) {\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8540_VBUS_CTRL_REG,\r\nAB8540_BIT_VBUS_CTRL_CHARG_DET_ENA, 0x00);\r\nab->enabled_charging_detection = false;\r\n}\r\nif (ab->previous_link_status_state == USB_LINK_HM_IDGND_8540 &&\r\n(lsts == USB_LINK_STD_HOST_C_NS_8540 ||\r\nlsts == USB_LINK_STD_HOST_NC_8540))\r\nreturn 0;\r\nif (ab->previous_link_status_state == USB_LINK_ACA_RID_A_8540 &&\r\n(lsts == USB_LINK_STD_HOST_NC_8540))\r\nreturn 0;\r\nab->previous_link_status_state = lsts;\r\nswitch (lsts) {\r\ncase USB_LINK_ACA_RID_B_8540:\r\nevent = UX500_MUSB_RIDB;\r\ncase USB_LINK_NOT_CONFIGURED_8540:\r\ncase USB_LINK_RESERVED0_8540:\r\ncase USB_LINK_RESERVED1_8540:\r\ncase USB_LINK_RESERVED2_8540:\r\ncase USB_LINK_RESERVED3_8540:\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\nif (event != UX500_MUSB_RIDB)\r\nevent = UX500_MUSB_NONE;\r\nab->phy.state = OTG_STATE_B_IDLE;\r\nbreak;\r\ncase USB_LINK_ACA_RID_C_NM_8540:\r\nevent = UX500_MUSB_RIDC;\r\ncase USB_LINK_STD_HOST_NC_8540:\r\ncase USB_LINK_STD_HOST_C_NS_8540:\r\ncase USB_LINK_STD_HOST_C_S_8540:\r\ncase USB_LINK_CDP_8540:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_PERIPHERAL;\r\nab8500_usb_peri_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (event != UX500_MUSB_RIDC)\r\nevent = UX500_MUSB_VBUS;\r\nbreak;\r\ncase USB_LINK_ACA_RID_A_8540:\r\ncase USB_LINK_ACA_DOCK_CHGR_8540:\r\nevent = UX500_MUSB_RIDA;\r\ncase USB_LINK_HM_IDGND_8540:\r\ncase USB_LINK_STD_UPSTREAM_8540:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_HOST;\r\nab8500_usb_host_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nab->phy.otg->default_a = true;\r\nif (event != UX500_MUSB_RIDA)\r\nevent = UX500_MUSB_ID;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_DEDICATED_CHG_8540:\r\nab->mode = USB_DEDICATED_CHG;\r\nevent = UX500_MUSB_CHARGER;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_PHYEN_NO_VBUS_NO_IDGND_8540:\r\ncase USB_LINK_STD_UPSTREAM_NO_IDGNG_VBUS_8540:\r\nevent = UX500_MUSB_NONE;\r\nif (ab->mode == USB_HOST) {\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_host_phy_dis(ab);\r\nab->mode = USB_IDLE;\r\n}\r\nif (ab->mode == USB_PERIPHERAL) {\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_peri_phy_dis(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_CLEAN, &ab->vbus_draw);\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\n}\r\nbreak;\r\ndefault:\r\nevent = UX500_MUSB_NONE;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8505_usb_link_status_update(struct ab8500_usb *ab,\r\nenum ab8505_usb_link_status lsts)\r\n{\r\nenum ux500_musb_vbus_id_status event = 0;\r\ndev_dbg(ab->dev, "ab8505_usb_link_status_update %d\n", lsts);\r\nif (ab->previous_link_status_state == USB_LINK_ACA_RID_A_8505 &&\r\n(lsts == USB_LINK_STD_HOST_NC_8505))\r\nreturn 0;\r\nab->previous_link_status_state = lsts;\r\nswitch (lsts) {\r\ncase USB_LINK_ACA_RID_B_8505:\r\nevent = UX500_MUSB_RIDB;\r\ncase USB_LINK_NOT_CONFIGURED_8505:\r\ncase USB_LINK_RESERVED0_8505:\r\ncase USB_LINK_RESERVED1_8505:\r\ncase USB_LINK_RESERVED2_8505:\r\ncase USB_LINK_RESERVED3_8505:\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\nif (event != UX500_MUSB_RIDB)\r\nevent = UX500_MUSB_NONE;\r\nab->phy.state = OTG_STATE_B_IDLE;\r\nbreak;\r\ncase USB_LINK_ACA_RID_C_NM_8505:\r\nevent = UX500_MUSB_RIDC;\r\ncase USB_LINK_STD_HOST_NC_8505:\r\ncase USB_LINK_STD_HOST_C_NS_8505:\r\ncase USB_LINK_STD_HOST_C_S_8505:\r\ncase USB_LINK_CDP_8505:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_PERIPHERAL;\r\nab8500_usb_peri_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (event != UX500_MUSB_RIDC)\r\nevent = UX500_MUSB_VBUS;\r\nbreak;\r\ncase USB_LINK_ACA_RID_A_8505:\r\ncase USB_LINK_ACA_DOCK_CHGR_8505:\r\nevent = UX500_MUSB_RIDA;\r\ncase USB_LINK_HM_IDGND_8505:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_HOST;\r\nab8500_usb_host_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nab->phy.otg->default_a = true;\r\nif (event != UX500_MUSB_RIDA)\r\nevent = UX500_MUSB_ID;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_DEDICATED_CHG_8505:\r\nab->mode = USB_DEDICATED_CHG;\r\nevent = UX500_MUSB_CHARGER;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_link_status_update(struct ab8500_usb *ab,\r\nenum ab8500_usb_link_status lsts)\r\n{\r\nenum ux500_musb_vbus_id_status event = 0;\r\ndev_dbg(ab->dev, "ab8500_usb_link_status_update %d\n", lsts);\r\nif (ab->previous_link_status_state == USB_LINK_HM_IDGND_8500 &&\r\n(lsts == USB_LINK_STD_HOST_C_NS_8500 ||\r\nlsts == USB_LINK_STD_HOST_NC_8500))\r\nreturn 0;\r\nif (ab->previous_link_status_state == USB_LINK_ACA_RID_A_8500 &&\r\nlsts == USB_LINK_STD_HOST_NC_8500)\r\nreturn 0;\r\nab->previous_link_status_state = lsts;\r\nswitch (lsts) {\r\ncase USB_LINK_ACA_RID_B_8500:\r\nevent = UX500_MUSB_RIDB;\r\ncase USB_LINK_NOT_CONFIGURED_8500:\r\ncase USB_LINK_NOT_VALID_LINK_8500:\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\nif (event != UX500_MUSB_RIDB)\r\nevent = UX500_MUSB_NONE;\r\nab->phy.state = OTG_STATE_B_IDLE;\r\nbreak;\r\ncase USB_LINK_ACA_RID_C_NM_8500:\r\ncase USB_LINK_ACA_RID_C_HS_8500:\r\ncase USB_LINK_ACA_RID_C_HS_CHIRP_8500:\r\nevent = UX500_MUSB_RIDC;\r\ncase USB_LINK_STD_HOST_NC_8500:\r\ncase USB_LINK_STD_HOST_C_NS_8500:\r\ncase USB_LINK_STD_HOST_C_S_8500:\r\ncase USB_LINK_HOST_CHG_NM_8500:\r\ncase USB_LINK_HOST_CHG_HS_8500:\r\ncase USB_LINK_HOST_CHG_HS_CHIRP_8500:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_PERIPHERAL;\r\nab8500_usb_peri_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nif (event != UX500_MUSB_RIDC)\r\nevent = UX500_MUSB_VBUS;\r\nbreak;\r\ncase USB_LINK_ACA_RID_A_8500:\r\nevent = UX500_MUSB_RIDA;\r\ncase USB_LINK_HM_IDGND_8500:\r\nif (ab->mode == USB_IDLE) {\r\nab->mode = USB_HOST;\r\nab8500_usb_host_phy_en(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_PREPARE, &ab->vbus_draw);\r\n}\r\nab->phy.otg->default_a = true;\r\nif (event != UX500_MUSB_RIDA)\r\nevent = UX500_MUSB_ID;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_DEDICATED_CHG_8500:\r\nab->mode = USB_DEDICATED_CHG;\r\nevent = UX500_MUSB_CHARGER;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nbreak;\r\ncase USB_LINK_RESERVED_8500:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int abx500_usb_link_status_update(struct ab8500_usb *ab)\r\n{\r\nu8 reg;\r\nint ret = 0;\r\nif (is_ab8500(ab->ab8500)) {\r\nenum ab8500_usb_link_status lsts;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_LINE_STAT_REG, &reg);\r\nlsts = (reg >> 3) & 0x0F;\r\nret = ab8500_usb_link_status_update(ab, lsts);\r\n} else if (is_ab8505(ab->ab8500)) {\r\nenum ab8505_usb_link_status lsts;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB, AB8505_USB_LINE_STAT_REG, &reg);\r\nlsts = (reg >> 3) & 0x1F;\r\nret = ab8505_usb_link_status_update(ab, lsts);\r\n} else if (is_ab8540(ab->ab8500)) {\r\nenum ab8540_usb_link_status lsts;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB, AB8540_USB_LINK_STAT_REG, &reg);\r\nlsts = (reg >> 3) & 0xFF;\r\nret = ab8540_usb_link_status_update(ab, lsts);\r\n} else if (is_ab9540(ab->ab8500)) {\r\nenum ab9540_usb_link_status lsts;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB, AB9540_USB_LINK_STAT_REG, &reg);\r\nlsts = (reg >> 3) & 0xFF;\r\nret = ab9540_usb_link_status_update(ab, lsts);\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t ab8500_usb_disconnect_irq(int irq, void *data)\r\n{\r\nstruct ab8500_usb *ab = (struct ab8500_usb *) data;\r\nenum usb_phy_events event = UX500_MUSB_NONE;\r\nif (ab->mode == USB_HOST) {\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_host_phy_dis(ab);\r\nab->mode = USB_IDLE;\r\n}\r\nif (ab->mode == USB_PERIPHERAL) {\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nevent, &ab->vbus_draw);\r\nab8500_usb_peri_phy_dis(ab);\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_CLEAN, &ab->vbus_draw);\r\nab->mode = USB_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\n}\r\nif (is_ab8500_2p0(ab->ab8500)) {\r\nif (ab->mode == USB_DEDICATED_CHG) {\r\nab8500_usb_wd_linkstatus(ab,\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN, 0);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_usb_link_status_irq(int irq, void *data)\r\n{\r\nstruct ab8500_usb *ab = (struct ab8500_usb *)data;\r\nabx500_usb_link_status_update(ab);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ab8500_usb_phy_disable_work(struct work_struct *work)\r\n{\r\nstruct ab8500_usb *ab = container_of(work, struct ab8500_usb,\r\nphy_dis_work);\r\nif (!ab->phy.otg->host)\r\nab8500_usb_host_phy_dis(ab);\r\nif (!ab->phy.otg->gadget)\r\nab8500_usb_peri_phy_dis(ab);\r\n}\r\nstatic bool ab8500_usb_check_vbus_status(struct ab8500_usb *ab)\r\n{\r\nu8 isource2;\r\nu8 reg;\r\nenum ab8540_usb_link_status lsts;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_INTERRUPT, AB8500_IT_SOURCE2_REG,\r\n&isource2);\r\nif (!(isource2 & AB8500_BIT_SOURCE2_VBUSDET))\r\nreturn false;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB, AB8540_USB_LINK_STAT_REG,\r\n&reg);\r\nlsts = (reg >> 3) & 0xFF;\r\nif (lsts)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void ab8500_usb_vbus_turn_on_event_work(struct work_struct *work)\r\n{\r\nstruct ab8500_usb *ab = container_of(work, struct ab8500_usb,\r\nvbus_event_work);\r\nif (ab->mode != USB_IDLE)\r\nreturn;\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK, AB8500_MAIN_WD_CTRL_REG,\r\nAB8500_BIT_WD_CTRL_ENABLE);\r\nudelay(100);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK, AB8500_MAIN_WD_CTRL_REG,\r\nAB8500_BIT_WD_CTRL_ENABLE | AB8500_BIT_WD_CTRL_KICK);\r\nudelay(100);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK, AB8500_MAIN_WD_CTRL_REG,\r\n0x0);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8540_VBUS_CTRL_REG,\r\nAB8540_BIT_VBUS_CTRL_CHARG_DET_ENA,\r\nAB8540_BIT_VBUS_CTRL_CHARG_DET_ENA);\r\nab->enabled_charging_detection = true;\r\n}\r\nstatic unsigned ab8500_eyediagram_workaroud(struct ab8500_usb *ab, unsigned mA)\r\n{\r\nif (is_ab8500_2p0_or_earlier(ab->ab8500))\r\nif (mA > 100)\r\nmA = 100;\r\nreturn mA;\r\n}\r\nstatic int ab8500_usb_set_power(struct usb_phy *phy, unsigned mA)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!phy)\r\nreturn -ENODEV;\r\nab = phy_to_ab(phy);\r\nmA = ab8500_eyediagram_workaroud(ab, mA);\r\nab->vbus_draw = mA;\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUX500_MUSB_VBUS, &ab->vbus_draw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_suspend(struct usb_phy *x, int suspend)\r\n{\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_peripheral(struct usb_otg *otg,\r\nstruct usb_gadget *gadget)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!otg)\r\nreturn -ENODEV;\r\nab = phy_to_ab(otg->phy);\r\nab->phy.otg->gadget = gadget;\r\nif ((ab->mode != USB_IDLE) && !gadget) {\r\nab->mode = USB_IDLE;\r\nschedule_work(&ab->phy_dis_work);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_host(struct usb_otg *otg, struct usb_bus *host)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!otg)\r\nreturn -ENODEV;\r\nab = phy_to_ab(otg->phy);\r\nab->phy.otg->host = host;\r\nif ((ab->mode != USB_IDLE) && !host) {\r\nab->mode = USB_IDLE;\r\nschedule_work(&ab->phy_dis_work);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ab8500_usb_restart_phy(struct ab8500_usb *ab)\r\n{\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN,\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN);\r\nudelay(100);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nAB8500_BIT_PHY_CTRL_DEVICE_EN,\r\n0);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nAB8500_BIT_PHY_CTRL_HOST_EN,\r\nAB8500_BIT_PHY_CTRL_HOST_EN);\r\nudelay(100);\r\nabx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_USB, AB8500_USB_PHY_CTRL_REG,\r\nAB8500_BIT_PHY_CTRL_HOST_EN,\r\n0);\r\n}\r\nstatic int ab8500_usb_regulator_get(struct ab8500_usb *ab)\r\n{\r\nint err;\r\nab->v_ape = devm_regulator_get(ab->dev, "v-ape");\r\nif (IS_ERR(ab->v_ape)) {\r\ndev_err(ab->dev, "Could not get v-ape supply\n");\r\nerr = PTR_ERR(ab->v_ape);\r\nreturn err;\r\n}\r\nab->v_ulpi = devm_regulator_get(ab->dev, "vddulpivio18");\r\nif (IS_ERR(ab->v_ulpi)) {\r\ndev_err(ab->dev, "Could not get vddulpivio18 supply\n");\r\nerr = PTR_ERR(ab->v_ulpi);\r\nreturn err;\r\n}\r\nab->v_musb = devm_regulator_get(ab->dev, "musb_1v8");\r\nif (IS_ERR(ab->v_musb)) {\r\ndev_err(ab->dev, "Could not get musb_1v8 supply\n");\r\nerr = PTR_ERR(ab->v_musb);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_irq_setup(struct platform_device *pdev,\r\nstruct ab8500_usb *ab)\r\n{\r\nint err;\r\nint irq;\r\nif (ab->flags & AB8500_USB_FLAG_USE_LINK_STATUS_IRQ) {\r\nirq = platform_get_irq_byname(pdev, "USB_LINK_STATUS");\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "Link status irq not found\n");\r\nreturn irq;\r\n}\r\nerr = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\nab8500_usb_link_status_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-link-status", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for link status irq\n");\r\nreturn err;\r\n}\r\n}\r\nif (ab->flags & AB8500_USB_FLAG_USE_ID_WAKEUP_IRQ) {\r\nirq = platform_get_irq_byname(pdev, "ID_WAKEUP_F");\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "ID fall irq not found\n");\r\nreturn irq;\r\n}\r\nerr = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\nab8500_usb_disconnect_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-id-fall", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for ID fall irq\n");\r\nreturn err;\r\n}\r\n}\r\nif (ab->flags & AB8500_USB_FLAG_USE_VBUS_DET_IRQ) {\r\nirq = platform_get_irq_byname(pdev, "VBUS_DET_F");\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "VBUS fall irq not found\n");\r\nreturn irq;\r\n}\r\nerr = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\nab8500_usb_disconnect_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-vbus-fall", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for Vbus fall irq\n");\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void ab8500_usb_set_ab8500_tuning_values(struct ab8500_usb *ab)\r\n{\r\nint err;\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS, 0x01);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to enable bank12 access err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE1, 0xC8);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE1 register err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE2, 0x00);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE2 register err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE3, 0x78);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE3 regester err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS, 0x00);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to switch bank12 access err=%d\n",\r\nerr);\r\n}\r\nstatic void ab8500_usb_set_ab8505_tuning_values(struct ab8500_usb *ab)\r\n{\r\nint err;\r\nerr = abx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS,\r\n0x01, 0x01);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to enable bank12 access err=%d\n",\r\nerr);\r\nerr = abx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE1,\r\n0xC8, 0xC8);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE1 register err=%d\n",\r\nerr);\r\nerr = abx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE2,\r\n0x60, 0x60);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE2 register err=%d\n",\r\nerr);\r\nerr = abx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE3,\r\n0xFC, 0x80);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE3 regester err=%d\n",\r\nerr);\r\nerr = abx500_mask_and_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS,\r\n0x00, 0x00);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to switch bank12 access err=%d\n",\r\nerr);\r\n}\r\nstatic void ab8500_usb_set_ab8540_tuning_values(struct ab8500_usb *ab)\r\n{\r\nint err;\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8540_DEBUG, AB8500_USB_PHY_TUNE1, 0xCC);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE1 register ret=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8540_DEBUG, AB8500_USB_PHY_TUNE2, 0x60);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE2 register ret=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8540_DEBUG, AB8500_USB_PHY_TUNE3, 0x90);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE3 regester ret=%d\n",\r\nerr);\r\n}\r\nstatic void ab8500_usb_set_ab9540_tuning_values(struct ab8500_usb *ab)\r\n{\r\nint err;\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS, 0x01);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to enable bank12 access err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE1, 0xC8);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE1 register err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE2, 0x60);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE2 register err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEBUG, AB8500_USB_PHY_TUNE3, 0x80);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to set PHY_TUNE3 regester err=%d\n",\r\nerr);\r\nerr = abx500_set_register_interruptible(ab->dev,\r\nAB8500_DEVELOPMENT, AB8500_BANK12_ACCESS, 0x00);\r\nif (err < 0)\r\ndev_err(ab->dev, "Failed to switch bank12 access err=%d\n",\r\nerr);\r\n}\r\nstatic int ab8500_usb_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500_usb *ab;\r\nstruct ab8500 *ab8500;\r\nstruct usb_otg *otg;\r\nint err;\r\nint rev;\r\nab8500 = dev_get_drvdata(pdev->dev.parent);\r\nrev = abx500_get_chip_id(&pdev->dev);\r\nif (is_ab8500_1p1_or_earlier(ab8500)) {\r\ndev_err(&pdev->dev, "Unsupported AB8500 chip rev=%d\n", rev);\r\nreturn -ENODEV;\r\n}\r\nab = devm_kzalloc(&pdev->dev, sizeof(*ab), GFP_KERNEL);\r\nif (!ab)\r\nreturn -ENOMEM;\r\notg = devm_kzalloc(&pdev->dev, sizeof(*otg), GFP_KERNEL);\r\nif (!otg)\r\nreturn -ENOMEM;\r\nab->dev = &pdev->dev;\r\nab->ab8500 = ab8500;\r\nab->phy.dev = ab->dev;\r\nab->phy.otg = otg;\r\nab->phy.label = "ab8500";\r\nab->phy.set_suspend = ab8500_usb_set_suspend;\r\nab->phy.set_power = ab8500_usb_set_power;\r\nab->phy.state = OTG_STATE_UNDEFINED;\r\notg->phy = &ab->phy;\r\notg->set_host = ab8500_usb_set_host;\r\notg->set_peripheral = ab8500_usb_set_peripheral;\r\nif (is_ab8500(ab->ab8500)) {\r\nab->flags |= AB8500_USB_FLAG_USE_LINK_STATUS_IRQ |\r\nAB8500_USB_FLAG_USE_ID_WAKEUP_IRQ |\r\nAB8500_USB_FLAG_USE_VBUS_DET_IRQ |\r\nAB8500_USB_FLAG_REGULATOR_SET_VOLTAGE;\r\n} else if (is_ab8505(ab->ab8500)) {\r\nab->flags |= AB8500_USB_FLAG_USE_LINK_STATUS_IRQ |\r\nAB8500_USB_FLAG_USE_ID_WAKEUP_IRQ |\r\nAB8500_USB_FLAG_USE_VBUS_DET_IRQ |\r\nAB8500_USB_FLAG_REGULATOR_SET_VOLTAGE;\r\n} else if (is_ab8540(ab->ab8500)) {\r\nab->flags |= AB8500_USB_FLAG_USE_LINK_STATUS_IRQ |\r\nAB8500_USB_FLAG_USE_CHECK_VBUS_STATUS |\r\nAB8500_USB_FLAG_USE_VBUS_HOST_QUIRK |\r\nAB8500_USB_FLAG_REGULATOR_SET_VOLTAGE;\r\n} else if (is_ab9540(ab->ab8500)) {\r\nab->flags |= AB8500_USB_FLAG_USE_LINK_STATUS_IRQ |\r\nAB8500_USB_FLAG_REGULATOR_SET_VOLTAGE;\r\nif (is_ab9540_2p0_or_earlier(ab->ab8500))\r\nab->flags |= AB8500_USB_FLAG_USE_ID_WAKEUP_IRQ |\r\nAB8500_USB_FLAG_USE_VBUS_DET_IRQ;\r\n}\r\nif (is_ab8500_2p0_or_earlier(ab->ab8500))\r\nab->flags &= ~AB8500_USB_FLAG_REGULATOR_SET_VOLTAGE;\r\nplatform_set_drvdata(pdev, ab);\r\nINIT_WORK(&ab->phy_dis_work, ab8500_usb_phy_disable_work);\r\nINIT_WORK(&ab->vbus_event_work, ab8500_usb_vbus_turn_on_event_work);\r\nerr = ab8500_usb_regulator_get(ab);\r\nif (err)\r\nreturn err;\r\nab->sysclk = devm_clk_get(ab->dev, "sysclk");\r\nif (IS_ERR(ab->sysclk)) {\r\ndev_err(ab->dev, "Could not get sysclk.\n");\r\nreturn PTR_ERR(ab->sysclk);\r\n}\r\nerr = ab8500_usb_irq_setup(pdev, ab);\r\nif (err < 0)\r\nreturn err;\r\nerr = usb_add_phy(&ab->phy, USB_PHY_TYPE_USB2);\r\nif (err) {\r\ndev_err(&pdev->dev, "Can't register transceiver\n");\r\nreturn err;\r\n}\r\nif (is_ab8500(ab->ab8500) && !is_ab8500_2p0_or_earlier(ab->ab8500))\r\nab8500_usb_set_ab8500_tuning_values(ab);\r\nelse if (is_ab8505(ab->ab8500))\r\nab8500_usb_set_ab8505_tuning_values(ab);\r\nelse if (is_ab8540(ab->ab8500))\r\nab8500_usb_set_ab8540_tuning_values(ab);\r\nelse if (is_ab9540(ab->ab8500))\r\nab8500_usb_set_ab9540_tuning_values(ab);\r\nab8500_usb_wd_workaround(ab);\r\nab8500_usb_restart_phy(ab);\r\nif (ab->flags & AB8500_USB_FLAG_USE_CHECK_VBUS_STATUS) {\r\nif (ab8500_usb_check_vbus_status(ab))\r\nschedule_work(&ab->vbus_event_work);\r\n}\r\nabx500_usb_link_status_update(ab);\r\ndev_info(&pdev->dev, "revision 0x%2x driver initialized\n", rev);\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_usb *ab = platform_get_drvdata(pdev);\r\ncancel_work_sync(&ab->phy_dis_work);\r\ncancel_work_sync(&ab->vbus_event_work);\r\nusb_remove_phy(&ab->phy);\r\nif (ab->mode == USB_HOST)\r\nab8500_usb_host_phy_dis(ab);\r\nelse if (ab->mode == USB_PERIPHERAL)\r\nab8500_usb_peri_phy_dis(ab);\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_usb_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_usb_driver);\r\n}\r\nstatic void __exit ab8500_usb_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_usb_driver);\r\n}

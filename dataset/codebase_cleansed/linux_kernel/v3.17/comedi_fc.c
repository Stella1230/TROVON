unsigned int cfc_bytes_per_scan(struct comedi_subdevice *s)\r\n{\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nunsigned int num_samples;\r\nunsigned int bits_per_sample;\r\nswitch (s->type) {\r\ncase COMEDI_SUBD_DI:\r\ncase COMEDI_SUBD_DO:\r\ncase COMEDI_SUBD_DIO:\r\nbits_per_sample = 8 * bytes_per_sample(s);\r\nnum_samples = (cmd->chanlist_len + bits_per_sample - 1) /\r\nbits_per_sample;\r\nbreak;\r\ndefault:\r\nnum_samples = cmd->chanlist_len;\r\nbreak;\r\n}\r\nreturn num_samples * bytes_per_sample(s);\r\n}\r\nvoid cfc_inc_scan_progress(struct comedi_subdevice *s, unsigned int num_bytes)\r\n{\r\nstruct comedi_async *async = s->async;\r\nunsigned int scan_length = cfc_bytes_per_scan(s);\r\nasync->scan_progress += num_bytes;\r\nif (async->scan_progress >= scan_length) {\r\nasync->scan_progress %= scan_length;\r\nasync->events |= COMEDI_CB_EOS;\r\n}\r\n}\r\nunsigned int cfc_write_array_to_buffer(struct comedi_subdevice *s,\r\nvoid *data, unsigned int num_bytes)\r\n{\r\nstruct comedi_async *async = s->async;\r\nunsigned int retval;\r\nif (num_bytes == 0)\r\nreturn 0;\r\nretval = comedi_buf_write_alloc(s, num_bytes);\r\nif (retval != num_bytes) {\r\ndev_warn(s->device->class_dev, "buffer overrun\n");\r\nasync->events |= COMEDI_CB_OVERFLOW;\r\nreturn 0;\r\n}\r\ncomedi_buf_memcpy_to(s, 0, data, num_bytes);\r\ncomedi_buf_write_free(s, num_bytes);\r\ncfc_inc_scan_progress(s, num_bytes);\r\nasync->events |= COMEDI_CB_BLOCK;\r\nreturn num_bytes;\r\n}\r\nunsigned int cfc_read_array_from_buffer(struct comedi_subdevice *s,\r\nvoid *data, unsigned int num_bytes)\r\n{\r\nif (num_bytes == 0)\r\nreturn 0;\r\nnum_bytes = comedi_buf_read_alloc(s, num_bytes);\r\ncomedi_buf_memcpy_from(s, 0, data, num_bytes);\r\ncomedi_buf_read_free(s, num_bytes);\r\ncfc_inc_scan_progress(s, num_bytes);\r\ns->async->events |= COMEDI_CB_BLOCK;\r\nreturn num_bytes;\r\n}\r\nunsigned int cfc_handle_events(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nunsigned int events = s->async->events;\r\nif (events == 0)\r\nreturn events;\r\nif (events & (COMEDI_CB_EOA | COMEDI_CB_ERROR | COMEDI_CB_OVERFLOW))\r\ns->cancel(dev, s);\r\ncomedi_event(dev, s);\r\nreturn events;\r\n}\r\nstatic int __init comedi_fc_init_module(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit comedi_fc_cleanup_module(void)\r\n{\r\n}

static int isl6423_write(struct isl6423_dev *isl6423, u8 reg)\r\n{\r\nstruct i2c_adapter *i2c = isl6423->i2c;\r\nu8 addr = isl6423->config->addr;\r\nint err = 0;\r\nstruct i2c_msg msg = { .addr = addr, .flags = 0, .buf = &reg, .len = 1 };\r\ndprintk(FE_DEBUG, 1, "write reg %02X", reg);\r\nerr = i2c_transfer(i2c, &msg, 1);\r\nif (err < 0)\r\ngoto exit;\r\nreturn 0;\r\nexit:\r\ndprintk(FE_ERROR, 1, "I/O error <%d>", err);\r\nreturn err;\r\n}\r\nstatic int isl6423_set_modulation(struct dvb_frontend *fe)\r\n{\r\nstruct isl6423_dev *isl6423 = (struct isl6423_dev *) fe->sec_priv;\r\nconst struct isl6423_config *config = isl6423->config;\r\nint err = 0;\r\nu8 reg_2 = 0;\r\nreg_2 = 0x01 << 5;\r\nif (config->mod_extern)\r\nreg_2 |= (1 << 3);\r\nelse\r\nreg_2 |= (1 << 4);\r\nerr = isl6423_write(isl6423, reg_2);\r\nif (err < 0)\r\ngoto exit;\r\nreturn 0;\r\nexit:\r\ndprintk(FE_ERROR, 1, "I/O error <%d>", err);\r\nreturn err;\r\n}\r\nstatic int isl6423_voltage_boost(struct dvb_frontend *fe, long arg)\r\n{\r\nstruct isl6423_dev *isl6423 = (struct isl6423_dev *) fe->sec_priv;\r\nu8 reg_3 = isl6423->reg_3;\r\nu8 reg_4 = isl6423->reg_4;\r\nint err = 0;\r\nif (arg) {\r\nreg_4 |= (1 << 4);\r\nreg_4 |= 0x1;\r\nreg_3 |= (1 << 3);\r\n} else {\r\nreg_4 |= (1 << 4);\r\nreg_4 &= ~0x1;\r\nreg_3 |= (1 << 3);\r\n}\r\nerr = isl6423_write(isl6423, reg_3);\r\nif (err < 0)\r\ngoto exit;\r\nerr = isl6423_write(isl6423, reg_4);\r\nif (err < 0)\r\ngoto exit;\r\nisl6423->reg_3 = reg_3;\r\nisl6423->reg_4 = reg_4;\r\nreturn 0;\r\nexit:\r\ndprintk(FE_ERROR, 1, "I/O error <%d>", err);\r\nreturn err;\r\n}\r\nstatic int isl6423_set_voltage(struct dvb_frontend *fe,\r\nenum fe_sec_voltage voltage)\r\n{\r\nstruct isl6423_dev *isl6423 = (struct isl6423_dev *) fe->sec_priv;\r\nu8 reg_3 = isl6423->reg_3;\r\nu8 reg_4 = isl6423->reg_4;\r\nint err = 0;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nreg_4 &= ~(1 << 4);\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nreg_4 |= (1 << 4);\r\nreg_4 &= ~0x3;\r\nreg_3 |= (1 << 3);\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nreg_4 |= (1 << 4);\r\nreg_4 |= 0x2;\r\nreg_4 &= ~0x1;\r\nreg_3 |= (1 << 3);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nerr = isl6423_write(isl6423, reg_3);\r\nif (err < 0)\r\ngoto exit;\r\nerr = isl6423_write(isl6423, reg_4);\r\nif (err < 0)\r\ngoto exit;\r\nisl6423->reg_3 = reg_3;\r\nisl6423->reg_4 = reg_4;\r\nreturn 0;\r\nexit:\r\ndprintk(FE_ERROR, 1, "I/O error <%d>", err);\r\nreturn err;\r\n}\r\nstatic int isl6423_set_current(struct dvb_frontend *fe)\r\n{\r\nstruct isl6423_dev *isl6423 = (struct isl6423_dev *) fe->sec_priv;\r\nu8 reg_3 = isl6423->reg_3;\r\nconst struct isl6423_config *config = isl6423->config;\r\nint err = 0;\r\nswitch (config->current_max) {\r\ncase SEC_CURRENT_275m:\r\nreg_3 &= ~0x3;\r\nbreak;\r\ncase SEC_CURRENT_515m:\r\nreg_3 &= ~0x2;\r\nreg_3 |= 0x1;\r\nbreak;\r\ncase SEC_CURRENT_635m:\r\nreg_3 &= ~0x1;\r\nreg_3 |= 0x2;\r\nbreak;\r\ncase SEC_CURRENT_800m:\r\nreg_3 |= 0x3;\r\nbreak;\r\n}\r\nerr = isl6423_write(isl6423, reg_3);\r\nif (err < 0)\r\ngoto exit;\r\nswitch (config->curlim) {\r\ncase SEC_CURRENT_LIM_ON:\r\nreg_3 &= ~0x10;\r\nbreak;\r\ncase SEC_CURRENT_LIM_OFF:\r\nreg_3 |= 0x10;\r\nbreak;\r\n}\r\nerr = isl6423_write(isl6423, reg_3);\r\nif (err < 0)\r\ngoto exit;\r\nisl6423->reg_3 = reg_3;\r\nreturn 0;\r\nexit:\r\ndprintk(FE_ERROR, 1, "I/O error <%d>", err);\r\nreturn err;\r\n}\r\nstatic void isl6423_release(struct dvb_frontend *fe)\r\n{\r\nisl6423_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstruct dvb_frontend *isl6423_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c,\r\nconst struct isl6423_config *config)\r\n{\r\nstruct isl6423_dev *isl6423;\r\nisl6423 = kzalloc(sizeof(struct isl6423_dev), GFP_KERNEL);\r\nif (!isl6423)\r\nreturn NULL;\r\nisl6423->config = config;\r\nisl6423->i2c = i2c;\r\nfe->sec_priv = isl6423;\r\nisl6423->reg_3 = 0x02 << 5;\r\nisl6423->reg_4 = 0x03 << 5;\r\nif (isl6423_set_current(fe))\r\ngoto exit;\r\nif (isl6423_set_modulation(fe))\r\ngoto exit;\r\nfe->ops.release_sec = isl6423_release;\r\nfe->ops.set_voltage = isl6423_set_voltage;\r\nfe->ops.enable_high_lnb_voltage = isl6423_voltage_boost;\r\nisl6423->verbose = verbose;\r\nreturn fe;\r\nexit:\r\nkfree(isl6423);\r\nfe->sec_priv = NULL;\r\nreturn NULL;\r\n}

static bool ns2501_readb(struct intel_dvo_device *dvo, int addr, uint8_t * ch)\r\n{\r\nstruct ns2501_priv *ns = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nu8 out_buf[2];\r\nu8 in_buf[2];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = out_buf,\r\n},\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = in_buf,\r\n}\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = 0;\r\nif (i2c_transfer(adapter, msgs, 2) == 2) {\r\n*ch = in_buf[0];\r\nreturn true;\r\n}\r\nif (!ns->quiet) {\r\nDRM_DEBUG_KMS\r\n("Unable to read register 0x%02x from %s:0x%02x.\n", addr,\r\nadapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool ns2501_writeb(struct intel_dvo_device *dvo, int addr, uint8_t ch)\r\n{\r\nstruct ns2501_priv *ns = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nuint8_t out_buf[2];\r\nstruct i2c_msg msg = {\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = out_buf,\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = ch;\r\nif (i2c_transfer(adapter, &msg, 1) == 1) {\r\nreturn true;\r\n}\r\nif (!ns->quiet) {\r\nDRM_DEBUG_KMS("Unable to write register 0x%02x to %s:%d\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool ns2501_init(struct intel_dvo_device *dvo,\r\nstruct i2c_adapter *adapter)\r\n{\r\nstruct ns2501_priv *ns;\r\nunsigned char ch;\r\nns = kzalloc(sizeof(struct ns2501_priv), GFP_KERNEL);\r\nif (ns == NULL)\r\nreturn false;\r\ndvo->i2c_bus = adapter;\r\ndvo->dev_priv = ns;\r\nns->quiet = true;\r\nif (!ns2501_readb(dvo, NS2501_VID_LO, &ch))\r\ngoto out;\r\nif (ch != (NS2501_VID & 0xff)) {\r\nDRM_DEBUG_KMS("ns2501 not detected got %d: from %s Slave %d.\n",\r\nch, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nif (!ns2501_readb(dvo, NS2501_DID_LO, &ch))\r\ngoto out;\r\nif (ch != (NS2501_DID & 0xff)) {\r\nDRM_DEBUG_KMS("ns2501 not detected got %d: from %s Slave %d.\n",\r\nch, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nns->quiet = false;\r\nns->reg_8_set = 0;\r\nns->reg_8_shadow =\r\nNS2501_8_PD | NS2501_8_BPAS | NS2501_8_VEN | NS2501_8_HEN;\r\nDRM_DEBUG_KMS("init ns2501 dvo controller successfully!\n");\r\nreturn true;\r\nout:\r\nkfree(ns);\r\nreturn false;\r\n}\r\nstatic enum drm_connector_status ns2501_detect(struct intel_dvo_device *dvo)\r\n{\r\nreturn connector_status_connected;\r\n}\r\nstatic enum drm_mode_status ns2501_mode_valid(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode)\r\n{\r\nDRM_DEBUG_KMS\r\n("is mode valid (hdisplay=%d,htotal=%d,vdisplay=%d,vtotal=%d)\n",\r\nmode->hdisplay, mode->htotal, mode->vdisplay, mode->vtotal);\r\nif ((mode->hdisplay == 800 && mode->vdisplay == 600) ||\r\n(mode->hdisplay == 640 && mode->vdisplay == 480) ||\r\n(mode->hdisplay == 1024 && mode->vdisplay == 768)) {\r\nreturn MODE_OK;\r\n} else {\r\nreturn MODE_ONE_SIZE;\r\n}\r\n}\r\nstatic void ns2501_mode_set(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nbool ok;\r\nint retries = 10;\r\nstruct ns2501_priv *ns = (struct ns2501_priv *)(dvo->dev_priv);\r\nDRM_DEBUG_KMS\r\n("set mode (hdisplay=%d,htotal=%d,vdisplay=%d,vtotal=%d).\n",\r\nmode->hdisplay, mode->htotal, mode->vdisplay, mode->vtotal);\r\ndo {\r\nok = true;\r\nif (mode->hdisplay == 800 && mode->vdisplay == 600) {\r\nns->reg_8_shadow &= ~NS2501_8_BPAS;\r\nDRM_DEBUG_KMS("switching to 800x600\n");\r\nok &= ns2501_writeb(dvo, 0x11, 0xc8);\r\nok &= ns2501_writeb(dvo, 0x1b, 0x19);\r\nok &= ns2501_writeb(dvo, 0x1c, 0x62);\r\nok &= ns2501_writeb(dvo, 0x1d, 0x02);\r\nok &= ns2501_writeb(dvo, 0x34, 0x03);\r\nok &= ns2501_writeb(dvo, 0x35, 0xff);\r\nok &= ns2501_writeb(dvo, 0x80, 0x27);\r\nok &= ns2501_writeb(dvo, 0x81, 0x03);\r\nok &= ns2501_writeb(dvo, 0x82, 0x41);\r\nok &= ns2501_writeb(dvo, 0x83, 0x05);\r\nok &= ns2501_writeb(dvo, 0x8d, 0x02);\r\nok &= ns2501_writeb(dvo, 0x8e, 0x04);\r\nok &= ns2501_writeb(dvo, 0x8f, 0x00);\r\nok &= ns2501_writeb(dvo, 0x90, 0xfe);\r\nok &= ns2501_writeb(dvo, 0x91, 0x07);\r\nok &= ns2501_writeb(dvo, 0x94, 0x00);\r\nok &= ns2501_writeb(dvo, 0x95, 0x00);\r\nok &= ns2501_writeb(dvo, 0x96, 0x00);\r\nok &= ns2501_writeb(dvo, 0x99, 0x00);\r\nok &= ns2501_writeb(dvo, 0x9a, 0x88);\r\nok &= ns2501_writeb(dvo, 0x9c, 0x23);\r\nok &= ns2501_writeb(dvo, 0x9d, 0x00);\r\nok &= ns2501_writeb(dvo, 0x9e, 0x25);\r\nok &= ns2501_writeb(dvo, 0x9f, 0x03);\r\nok &= ns2501_writeb(dvo, 0xa4, 0x80);\r\nok &= ns2501_writeb(dvo, 0xb6, 0x00);\r\nok &= ns2501_writeb(dvo, 0xb9, 0xc8);\r\nok &= ns2501_writeb(dvo, 0xba, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc0, 0x05);\r\nok &= ns2501_writeb(dvo, 0xc1, 0xd7);\r\nok &= ns2501_writeb(dvo, 0xc2, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc3, 0xf8);\r\nok &= ns2501_writeb(dvo, 0xc4, 0x03);\r\nok &= ns2501_writeb(dvo, 0xc5, 0x1a);\r\nok &= ns2501_writeb(dvo, 0xc6, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc7, 0x73);\r\nok &= ns2501_writeb(dvo, 0xc8, 0x02);\r\n} else if (mode->hdisplay == 640 && mode->vdisplay == 480) {\r\nDRM_DEBUG_KMS("switching to 640x480\n");\r\nns->reg_8_shadow &= ~NS2501_8_BPAS;\r\nok &= ns2501_writeb(dvo, 0x11, 0xa0);\r\nok &= ns2501_writeb(dvo, 0x1b, 0x11);\r\nok &= ns2501_writeb(dvo, 0x1c, 0x54);\r\nok &= ns2501_writeb(dvo, 0x1d, 0x03);\r\nok &= ns2501_writeb(dvo, 0x34, 0x03);\r\nok &= ns2501_writeb(dvo, 0x35, 0xff);\r\nok &= ns2501_writeb(dvo, 0x80, 0xff);\r\nok &= ns2501_writeb(dvo, 0x81, 0x07);\r\nok &= ns2501_writeb(dvo, 0x82, 0x3d);\r\nok &= ns2501_writeb(dvo, 0x83, 0x05);\r\nok &= ns2501_writeb(dvo, 0x8d, 0x02);\r\nok &= ns2501_writeb(dvo, 0x8e, 0x10);\r\nok &= ns2501_writeb(dvo, 0x8f, 0x00);\r\nok &= ns2501_writeb(dvo, 0x90, 0xff);\r\nok &= ns2501_writeb(dvo, 0x91, 0x07);\r\nok &= ns2501_writeb(dvo, 0x94, 0x00);\r\nok &= ns2501_writeb(dvo, 0x95, 0x00);\r\nok &= ns2501_writeb(dvo, 0x96, 0x05);\r\nok &= ns2501_writeb(dvo, 0x99, 0x00);\r\nok &= ns2501_writeb(dvo, 0x9a, 0x88);\r\nok &= ns2501_writeb(dvo, 0x9c, 0x24);\r\nok &= ns2501_writeb(dvo, 0x9d, 0x00);\r\nok &= ns2501_writeb(dvo, 0x9e, 0x25);\r\nok &= ns2501_writeb(dvo, 0x9f, 0x03);\r\nok &= ns2501_writeb(dvo, 0xa4, 0x84);\r\nok &= ns2501_writeb(dvo, 0xb6, 0x09);\r\nok &= ns2501_writeb(dvo, 0xb9, 0xa0);\r\nok &= ns2501_writeb(dvo, 0xba, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc0, 0x05);\r\nok &= ns2501_writeb(dvo, 0xc1, 0x90);\r\nok &= ns2501_writeb(dvo, 0xc2, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc3, 0x0f);\r\nok &= ns2501_writeb(dvo, 0xc4, 0x03);\r\nok &= ns2501_writeb(dvo, 0xc5, 0x16);\r\nok &= ns2501_writeb(dvo, 0xc6, 0x00);\r\nok &= ns2501_writeb(dvo, 0xc7, 0x02);\r\nok &= ns2501_writeb(dvo, 0xc8, 0x02);\r\n} else if (mode->hdisplay == 1024 && mode->vdisplay == 768) {\r\nDRM_DEBUG_KMS("switching to 1024x768\n");\r\nns->reg_8_shadow |= NS2501_8_BPAS;\r\nok &= ns2501_writeb(dvo, 0x37, 0x44);\r\n} else {\r\nns->reg_8_shadow |= NS2501_8_BPAS;\r\n}\r\nok &= ns2501_writeb(dvo, NS2501_REG8, ns->reg_8_shadow);\r\n} while (!ok && retries--);\r\n}\r\nstatic bool ns2501_get_hw_state(struct intel_dvo_device *dvo)\r\n{\r\nunsigned char ch;\r\nif (!ns2501_readb(dvo, NS2501_REG8, &ch))\r\nreturn false;\r\nif (ch & NS2501_8_PD)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic void ns2501_dpms(struct intel_dvo_device *dvo, bool enable)\r\n{\r\nbool ok;\r\nint retries = 10;\r\nstruct ns2501_priv *ns = (struct ns2501_priv *)(dvo->dev_priv);\r\nunsigned char ch;\r\nDRM_DEBUG_KMS("Trying set the dpms of the DVO to %i\n", enable);\r\nch = ns->reg_8_shadow;\r\nif (enable)\r\nch |= NS2501_8_PD;\r\nelse\r\nch &= ~NS2501_8_PD;\r\nif (ns->reg_8_set == 0 || ns->reg_8_shadow != ch) {\r\nns->reg_8_set = 1;\r\nns->reg_8_shadow = ch;\r\ndo {\r\nok = true;\r\nok &= ns2501_writeb(dvo, NS2501_REG8, ch);\r\nok &=\r\nns2501_writeb(dvo, 0x34,\r\nenable ? 0x03 : 0x00);\r\nok &=\r\nns2501_writeb(dvo, 0x35,\r\nenable ? 0xff : 0x00);\r\n} while (!ok && retries--);\r\n}\r\n}\r\nstatic void ns2501_dump_regs(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t val;\r\nns2501_readb(dvo, NS2501_FREQ_LO, &val);\r\nDRM_DEBUG_KMS("NS2501_FREQ_LO: 0x%02x\n", val);\r\nns2501_readb(dvo, NS2501_FREQ_HI, &val);\r\nDRM_DEBUG_KMS("NS2501_FREQ_HI: 0x%02x\n", val);\r\nns2501_readb(dvo, NS2501_REG8, &val);\r\nDRM_DEBUG_KMS("NS2501_REG8: 0x%02x\n", val);\r\nns2501_readb(dvo, NS2501_REG9, &val);\r\nDRM_DEBUG_KMS("NS2501_REG9: 0x%02x\n", val);\r\nns2501_readb(dvo, NS2501_REGC, &val);\r\nDRM_DEBUG_KMS("NS2501_REGC: 0x%02x\n", val);\r\n}\r\nstatic void ns2501_destroy(struct intel_dvo_device *dvo)\r\n{\r\nstruct ns2501_priv *ns = dvo->dev_priv;\r\nif (ns) {\r\nkfree(ns);\r\ndvo->dev_priv = NULL;\r\n}\r\n}

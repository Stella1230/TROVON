static int mcb_pci_get_irq(struct mcb_device *mdev)\r\n{\r\nstruct mcb_bus *mbus = mdev->bus;\r\nstruct device *dev = mbus->carrier;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nreturn pdev->irq;\r\n}\r\nstatic int mcb_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct priv *priv;\r\nphys_addr_t mapbase;\r\nint ret;\r\nint num_cells;\r\nunsigned long flags;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nret = pci_enable_device(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to enable PCI device\n");\r\nreturn -ENODEV;\r\n}\r\nmapbase = pci_resource_start(pdev, 0);\r\nif (!mapbase) {\r\ndev_err(&pdev->dev, "No PCI resource\n");\r\ngoto err_start;\r\n}\r\nret = pci_request_region(pdev, 0, KBUILD_MODNAME);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request PCI BARs\n");\r\ngoto err_start;\r\n}\r\npriv->base = pci_iomap(pdev, 0, 0);\r\nif (!priv->base) {\r\ndev_err(&pdev->dev, "Cannot ioremap\n");\r\nret = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nflags = pci_resource_flags(pdev, 0);\r\nif (flags & IORESOURCE_IO) {\r\nret = -ENOTSUPP;\r\ndev_err(&pdev->dev,\r\n"IO mapped PCI devices are not supported\n");\r\ngoto err_ioremap;\r\n}\r\npci_set_drvdata(pdev, priv);\r\npriv->bus = mcb_alloc_bus(&pdev->dev);\r\nif (IS_ERR(priv->bus)) {\r\nret = PTR_ERR(priv->bus);\r\ngoto err_drvdata;\r\n}\r\npriv->bus->get_irq = mcb_pci_get_irq;\r\nret = chameleon_parse_cells(priv->bus, mapbase, priv->base);\r\nif (ret < 0)\r\ngoto err_drvdata;\r\nnum_cells = ret;\r\ndev_dbg(&pdev->dev, "Found %d cells\n", num_cells);\r\nmcb_bus_add_devices(priv->bus);\r\nerr_drvdata:\r\npci_iounmap(pdev, priv->base);\r\nerr_ioremap:\r\npci_release_region(pdev, 0);\r\nerr_start:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic void mcb_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct priv *priv = pci_get_drvdata(pdev);\r\nmcb_release_bus(priv->bus);\r\n}

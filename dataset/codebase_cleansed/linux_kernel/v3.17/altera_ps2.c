static irqreturn_t altera_ps2_rxint(int irq, void *dev_id)\r\n{\r\nstruct ps2if *ps2if = dev_id;\r\nunsigned int status;\r\nint handled = IRQ_NONE;\r\nwhile ((status = readl(ps2if->base)) & 0xffff0000) {\r\nserio_interrupt(ps2if->io, status & 0xff, 0);\r\nhandled = IRQ_HANDLED;\r\n}\r\nreturn handled;\r\n}\r\nstatic int altera_ps2_write(struct serio *io, unsigned char val)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwritel(val, ps2if->base);\r\nreturn 0;\r\n}\r\nstatic int altera_ps2_open(struct serio *io)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwhile (readl(ps2if->base) & 0xffff0000)\r\n;\r\nwritel(1, ps2if->base + 4);\r\nreturn 0;\r\n}\r\nstatic void altera_ps2_close(struct serio *io)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwritel(0, ps2if->base);\r\n}\r\nstatic int altera_ps2_probe(struct platform_device *pdev)\r\n{\r\nstruct ps2if *ps2if;\r\nstruct serio *serio;\r\nint error, irq;\r\nps2if = kzalloc(sizeof(struct ps2if), GFP_KERNEL);\r\nserio = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (!ps2if || !serio) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nserio->id.type = SERIO_8042;\r\nserio->write = altera_ps2_write;\r\nserio->open = altera_ps2_open;\r\nserio->close = altera_ps2_close;\r\nstrlcpy(serio->name, dev_name(&pdev->dev), sizeof(serio->name));\r\nstrlcpy(serio->phys, dev_name(&pdev->dev), sizeof(serio->phys));\r\nserio->port_data = ps2if;\r\nserio->dev.parent = &pdev->dev;\r\nps2if->io = serio;\r\nps2if->iomem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (ps2if->iomem_res == NULL) {\r\nerror = -ENOENT;\r\ngoto err_free_mem;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nerror = -ENXIO;\r\ngoto err_free_mem;\r\n}\r\nps2if->irq = irq;\r\nif (!request_mem_region(ps2if->iomem_res->start,\r\nresource_size(ps2if->iomem_res), pdev->name)) {\r\nerror = -EBUSY;\r\ngoto err_free_mem;\r\n}\r\nps2if->base = ioremap(ps2if->iomem_res->start,\r\nresource_size(ps2if->iomem_res));\r\nif (!ps2if->base) {\r\nerror = -ENOMEM;\r\ngoto err_free_res;\r\n}\r\nerror = request_irq(ps2if->irq, altera_ps2_rxint, 0, pdev->name, ps2if);\r\nif (error) {\r\ndev_err(&pdev->dev, "could not allocate IRQ %d: %d\n",\r\nps2if->irq, error);\r\ngoto err_unmap;\r\n}\r\ndev_info(&pdev->dev, "base %p, irq %d\n", ps2if->base, ps2if->irq);\r\nserio_register_port(ps2if->io);\r\nplatform_set_drvdata(pdev, ps2if);\r\nreturn 0;\r\nerr_unmap:\r\niounmap(ps2if->base);\r\nerr_free_res:\r\nrelease_mem_region(ps2if->iomem_res->start,\r\nresource_size(ps2if->iomem_res));\r\nerr_free_mem:\r\nkfree(ps2if);\r\nkfree(serio);\r\nreturn error;\r\n}\r\nstatic int altera_ps2_remove(struct platform_device *pdev)\r\n{\r\nstruct ps2if *ps2if = platform_get_drvdata(pdev);\r\nserio_unregister_port(ps2if->io);\r\nfree_irq(ps2if->irq, ps2if);\r\niounmap(ps2if->base);\r\nrelease_mem_region(ps2if->iomem_res->start,\r\nresource_size(ps2if->iomem_res));\r\nkfree(ps2if);\r\nreturn 0;\r\n}

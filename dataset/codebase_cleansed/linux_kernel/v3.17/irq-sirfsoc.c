static __init void\r\nsirfsoc_alloc_gc(void __iomem *base, unsigned int irq_start, unsigned int num)\r\n{\r\nstruct irq_chip_generic *gc;\r\nstruct irq_chip_type *ct;\r\nint ret;\r\nunsigned int clr = IRQ_NOREQUEST | IRQ_NOPROBE | IRQ_NOAUTOEN;\r\nunsigned int set = IRQ_LEVEL;\r\nret = irq_alloc_domain_generic_chips(sirfsoc_irqdomain, num, 1, "irq_sirfsoc",\r\nhandle_level_irq, clr, set, IRQ_GC_INIT_MASK_CACHE);\r\ngc = irq_get_domain_generic_chip(sirfsoc_irqdomain, irq_start);\r\ngc->reg_base = base;\r\nct = gc->chip_types;\r\nct->chip.irq_mask = irq_gc_mask_clr_bit;\r\nct->chip.irq_unmask = irq_gc_mask_set_bit;\r\nct->regs.mask = SIRFSOC_INT_RISC_MASK0;\r\n}\r\nstatic void __exception_irq_entry sirfsoc_handle_irq(struct pt_regs *regs)\r\n{\r\nvoid __iomem *base = sirfsoc_irqdomain->host_data;\r\nu32 irqstat, irqnr;\r\nirqstat = readl_relaxed(base + SIRFSOC_INIT_IRQ_ID);\r\nirqnr = irq_find_mapping(sirfsoc_irqdomain, irqstat & 0xff);\r\nhandle_IRQ(irqnr, regs);\r\n}\r\nstatic int __init sirfsoc_irq_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nvoid __iomem *base = of_iomap(np, 0);\r\nif (!base)\r\npanic("unable to map intc cpu registers\n");\r\nsirfsoc_irqdomain = irq_domain_add_linear(np, SIRFSOC_NUM_IRQS,\r\n&irq_generic_chip_ops, base);\r\nsirfsoc_alloc_gc(base, 0, 32);\r\nsirfsoc_alloc_gc(base + 4, 32, SIRFSOC_NUM_IRQS - 32);\r\nwritel_relaxed(0, base + SIRFSOC_INT_RISC_LEVEL0);\r\nwritel_relaxed(0, base + SIRFSOC_INT_RISC_LEVEL1);\r\nwritel_relaxed(0, base + SIRFSOC_INT_RISC_MASK0);\r\nwritel_relaxed(0, base + SIRFSOC_INT_RISC_MASK1);\r\nset_handle_irq(sirfsoc_handle_irq);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_irq_suspend(void)\r\n{\r\nvoid __iomem *base = sirfsoc_irqdomain->host_data;\r\nsirfsoc_irq_st.mask0 = readl_relaxed(base + SIRFSOC_INT_RISC_MASK0);\r\nsirfsoc_irq_st.mask1 = readl_relaxed(base + SIRFSOC_INT_RISC_MASK1);\r\nsirfsoc_irq_st.level0 = readl_relaxed(base + SIRFSOC_INT_RISC_LEVEL0);\r\nsirfsoc_irq_st.level1 = readl_relaxed(base + SIRFSOC_INT_RISC_LEVEL1);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_irq_resume(void)\r\n{\r\nvoid __iomem *base = sirfsoc_irqdomain->host_data;\r\nwritel_relaxed(sirfsoc_irq_st.mask0, base + SIRFSOC_INT_RISC_MASK0);\r\nwritel_relaxed(sirfsoc_irq_st.mask1, base + SIRFSOC_INT_RISC_MASK1);\r\nwritel_relaxed(sirfsoc_irq_st.level0, base + SIRFSOC_INT_RISC_LEVEL0);\r\nwritel_relaxed(sirfsoc_irq_st.level1, base + SIRFSOC_INT_RISC_LEVEL1);\r\n}\r\nstatic int __init sirfsoc_irq_pm_init(void)\r\n{\r\nif (!sirfsoc_irqdomain)\r\nreturn 0;\r\nregister_syscore_ops(&sirfsoc_irq_syscore_ops);\r\nreturn 0;\r\n}

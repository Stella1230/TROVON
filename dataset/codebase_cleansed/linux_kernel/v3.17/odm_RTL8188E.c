static void odm_RX_HWAntDivInit(struct odm_dm_struct *dm_odm)\r\n{\r\nstruct adapter *adapter = dm_odm->Adapter;\r\nu32 value32;\r\nif (*(dm_odm->mp_mode) == 1) {\r\ndm_odm->AntDivType = CGCS_RX_SW_ANTDIV;\r\nPHY_SetBBReg(adapter, ODM_REG_IGI_A_11N, BIT7, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_LNA_SWITCH_11N, BIT31, 1);\r\nreturn;\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("odm_RX_HWAntDivInit()\n"));\r\nvalue32 = PHY_QueryBBReg(adapter, ODM_REG_ANTSEL_PIN_11N, bMaskDWord);\r\nPHY_SetBBReg(adapter, ODM_REG_ANTSEL_PIN_11N, bMaskDWord, value32|(BIT23|BIT25));\r\nPHY_SetBBReg(adapter, ODM_REG_PIN_CTRL_11N, BIT9|BIT8, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT10, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_LNA_SWITCH_11N, BIT22, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_LNA_SWITCH_11N, BIT31, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_ANTDIV_PARA1_11N, bMaskDWord, 0x000000a0);\r\nPHY_SetBBReg(adapter, ODM_REG_BB_PWR_SAV4_11N, BIT7, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_CCK_ANTDIV_PARA2_11N, BIT4, 1);\r\nODM_UpdateRxIdleAnt_88E(dm_odm, MAIN_ANT);\r\nPHY_SetBBReg(adapter, ODM_REG_ANT_MAPPING1_11N, 0xFFFF, 0x0201);\r\n}\r\nstatic void odm_TRX_HWAntDivInit(struct odm_dm_struct *dm_odm)\r\n{\r\nstruct adapter *adapter = dm_odm->Adapter;\r\nu32 value32;\r\nif (*(dm_odm->mp_mode) == 1) {\r\ndm_odm->AntDivType = CGCS_RX_SW_ANTDIV;\r\nPHY_SetBBReg(adapter, ODM_REG_IGI_A_11N, BIT7, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT5|BIT4|BIT3, 0);\r\nreturn;\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("odm_TRX_HWAntDivInit()\n"));\r\nvalue32 = PHY_QueryBBReg(adapter, ODM_REG_ANTSEL_PIN_11N, bMaskDWord);\r\nPHY_SetBBReg(adapter, ODM_REG_ANTSEL_PIN_11N, bMaskDWord, value32|(BIT23|BIT25));\r\nPHY_SetBBReg(adapter, ODM_REG_PIN_CTRL_11N, BIT9|BIT8, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT10, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_LNA_SWITCH_11N, BIT22, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_LNA_SWITCH_11N, BIT31, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_ANTDIV_PARA1_11N, bMaskDWord, 0x000000a0);\r\nPHY_SetBBReg(adapter, ODM_REG_BB_PWR_SAV4_11N, BIT7, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_CCK_ANTDIV_PARA2_11N, BIT4, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_TX_ANT_CTRL_11N, BIT21, 0);\r\nODM_UpdateRxIdleAnt_88E(dm_odm, MAIN_ANT);\r\nif (!dm_odm->bIsMPChip) {\r\nPHY_SetBBReg(adapter, ODM_REG_RX_DEFUALT_A_11N, BIT10|BIT9|BIT8, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_DEFUALT_A_11N, BIT13|BIT12|BIT11, 2);\r\n} else {\r\nPHY_SetBBReg(adapter, ODM_REG_ANT_MAPPING1_11N, bMaskDWord, 0x0201);\r\n}\r\n}\r\nstatic void odm_FastAntTrainingInit(struct odm_dm_struct *dm_odm)\r\n{\r\nstruct adapter *adapter = dm_odm->Adapter;\r\nu32 value32, i;\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nu32 AntCombination = 2;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("odm_FastAntTrainingInit()\n"));\r\nif (*(dm_odm->mp_mode) == 1) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_INIT, ODM_DBG_LOUD, ("dm_odm->AntDivType: %d\n", dm_odm->AntDivType));\r\nreturn;\r\n}\r\nfor (i = 0; i < 6; i++) {\r\ndm_fat_tbl->Bssid[i] = 0;\r\ndm_fat_tbl->antSumRSSI[i] = 0;\r\ndm_fat_tbl->antRSSIcnt[i] = 0;\r\ndm_fat_tbl->antAveRSSI[i] = 0;\r\n}\r\ndm_fat_tbl->TrainIdx = 0;\r\ndm_fat_tbl->FAT_State = FAT_NORMAL_STATE;\r\nvalue32 = PHY_QueryBBReg(adapter, 0x4c, bMaskDWord);\r\nPHY_SetBBReg(adapter, 0x4c, bMaskDWord, value32|(BIT23|BIT25));\r\nvalue32 = PHY_QueryBBReg(adapter, 0x7B4, bMaskDWord);\r\nPHY_SetBBReg(adapter, 0x7b4, bMaskDWord, value32|(BIT16|BIT17));\r\nPHY_SetBBReg(adapter, 0x7b4, 0xFFFF, 0);\r\nPHY_SetBBReg(adapter, 0x7b0, bMaskDWord, 0);\r\nPHY_SetBBReg(adapter, 0x870, BIT9|BIT8, 0);\r\nPHY_SetBBReg(adapter, 0x864, BIT10, 0);\r\nPHY_SetBBReg(adapter, 0xb2c, BIT22, 0);\r\nPHY_SetBBReg(adapter, 0xb2c, BIT31, 1);\r\nPHY_SetBBReg(adapter, 0xca4, bMaskDWord, 0x000000a0);\r\nif (AntCombination == 2) {\r\nif (!dm_odm->bIsMPChip) {\r\nPHY_SetBBReg(adapter, 0x858, BIT10|BIT9|BIT8, 1);\r\nPHY_SetBBReg(adapter, 0x858, BIT13|BIT12|BIT11, 2);\r\n} else {\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte0, 1);\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte1, 2);\r\n}\r\n} else if (AntCombination == 7) {\r\nif (!dm_odm->bIsMPChip) {\r\nPHY_SetBBReg(adapter, 0x858, BIT10|BIT9|BIT8, 0);\r\nPHY_SetBBReg(adapter, 0x858, BIT13|BIT12|BIT11, 1);\r\nPHY_SetBBReg(adapter, 0x878, BIT16, 0);\r\nPHY_SetBBReg(adapter, 0x858, BIT15|BIT14, 2);\r\nPHY_SetBBReg(adapter, 0x878, BIT19|BIT18|BIT17, 3);\r\nPHY_SetBBReg(adapter, 0x878, BIT22|BIT21|BIT20, 4);\r\nPHY_SetBBReg(adapter, 0x878, BIT25|BIT24|BIT23, 5);\r\nPHY_SetBBReg(adapter, 0x878, BIT28|BIT27|BIT26, 6);\r\nPHY_SetBBReg(adapter, 0x878, BIT31|BIT30|BIT29, 7);\r\n} else {\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte0, 0);\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte1, 1);\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte2, 2);\r\nPHY_SetBBReg(adapter, 0x914, bMaskByte3, 3);\r\nPHY_SetBBReg(adapter, 0x918, bMaskByte0, 4);\r\nPHY_SetBBReg(adapter, 0x918, bMaskByte1, 5);\r\nPHY_SetBBReg(adapter, 0x918, bMaskByte2, 6);\r\nPHY_SetBBReg(adapter, 0x918, bMaskByte3, 7);\r\n}\r\n}\r\nPHY_SetBBReg(adapter, 0x80c, BIT21, 1);\r\nPHY_SetBBReg(adapter, 0x864, BIT5|BIT4|BIT3, 0);\r\nPHY_SetBBReg(adapter, 0x864, BIT8|BIT7|BIT6, 1);\r\nPHY_SetBBReg(adapter, 0x864, BIT2|BIT1|BIT0, (AntCombination-1));\r\nPHY_SetBBReg(adapter, 0xc50, BIT7, 1);\r\n}\r\nvoid ODM_AntennaDiversityInit_88E(struct odm_dm_struct *dm_odm)\r\n{\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("dm_odm->AntDivType=%d\n", dm_odm->AntDivType));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("dm_odm->bIsMPChip=%s\n", (dm_odm->bIsMPChip ? "true" : "false")));\r\nif (dm_odm->AntDivType == CGCS_RX_HW_ANTDIV)\r\nodm_RX_HWAntDivInit(dm_odm);\r\nelse if (dm_odm->AntDivType == CG_TRX_HW_ANTDIV)\r\nodm_TRX_HWAntDivInit(dm_odm);\r\nelse if (dm_odm->AntDivType == CG_TRX_SMART_ANTDIV)\r\nodm_FastAntTrainingInit(dm_odm);\r\n}\r\nvoid ODM_UpdateRxIdleAnt_88E(struct odm_dm_struct *dm_odm, u8 Ant)\r\n{\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nstruct adapter *adapter = dm_odm->Adapter;\r\nu32 DefaultAnt, OptionalAnt;\r\nif (dm_fat_tbl->RxIdleAnt != Ant) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("Need to Update Rx Idle Ant\n"));\r\nif (Ant == MAIN_ANT) {\r\nDefaultAnt = (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) ? MAIN_ANT_CG_TRX : MAIN_ANT_CGCS_RX;\r\nOptionalAnt = (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) ? AUX_ANT_CG_TRX : AUX_ANT_CGCS_RX;\r\n} else {\r\nDefaultAnt = (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) ? AUX_ANT_CG_TRX : AUX_ANT_CGCS_RX;\r\nOptionalAnt = (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) ? MAIN_ANT_CG_TRX : MAIN_ANT_CGCS_RX;\r\n}\r\nif (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) {\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT5|BIT4|BIT3, DefaultAnt);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT8|BIT7|BIT6, OptionalAnt);\r\nPHY_SetBBReg(adapter, ODM_REG_ANTSEL_CTRL_11N, BIT14|BIT13|BIT12, DefaultAnt);\r\nPHY_SetBBReg(adapter, ODM_REG_RESP_TX_11N, BIT6|BIT7, DefaultAnt);\r\n} else if (dm_odm->AntDivType == CGCS_RX_HW_ANTDIV) {\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT5|BIT4|BIT3, DefaultAnt);\r\nPHY_SetBBReg(adapter, ODM_REG_RX_ANT_CTRL_11N, BIT8|BIT7|BIT6, OptionalAnt);\r\n}\r\n}\r\ndm_fat_tbl->RxIdleAnt = Ant;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("RxIdleAnt=%s\n", (Ant == MAIN_ANT) ? "MAIN_ANT" : "AUX_ANT"));\r\npr_info("RxIdleAnt=%s\n", (Ant == MAIN_ANT) ? "MAIN_ANT" : "AUX_ANT");\r\n}\r\nstatic void odm_UpdateTxAnt_88E(struct odm_dm_struct *dm_odm, u8 Ant, u32 MacId)\r\n{\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nu8 TargetAnt;\r\nif (Ant == MAIN_ANT)\r\nTargetAnt = MAIN_ANT_CG_TRX;\r\nelse\r\nTargetAnt = AUX_ANT_CG_TRX;\r\ndm_fat_tbl->antsel_a[MacId] = TargetAnt&BIT0;\r\ndm_fat_tbl->antsel_b[MacId] = (TargetAnt&BIT1)>>1;\r\ndm_fat_tbl->antsel_c[MacId] = (TargetAnt&BIT2)>>2;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD,\r\n("Tx from TxInfo, TargetAnt=%s\n",\r\n(Ant == MAIN_ANT) ? "MAIN_ANT" : "AUX_ANT"));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD,\r\n("antsel_tr_mux=3'b%d%d%d\n",\r\ndm_fat_tbl->antsel_c[MacId], dm_fat_tbl->antsel_b[MacId], dm_fat_tbl->antsel_a[MacId]));\r\n}\r\nvoid ODM_SetTxAntByTxInfo_88E(struct odm_dm_struct *dm_odm, u8 *pDesc, u8 macId)\r\n{\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nif ((dm_odm->AntDivType == CG_TRX_HW_ANTDIV) || (dm_odm->AntDivType == CG_TRX_SMART_ANTDIV)) {\r\nSET_TX_DESC_ANTSEL_A_88E(pDesc, dm_fat_tbl->antsel_a[macId]);\r\nSET_TX_DESC_ANTSEL_B_88E(pDesc, dm_fat_tbl->antsel_b[macId]);\r\nSET_TX_DESC_ANTSEL_C_88E(pDesc, dm_fat_tbl->antsel_c[macId]);\r\n}\r\n}\r\nvoid ODM_AntselStatistics_88E(struct odm_dm_struct *dm_odm, u8 antsel_tr_mux, u32 MacId, u8 RxPWDBAll)\r\n{\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nif (dm_odm->AntDivType == CG_TRX_HW_ANTDIV) {\r\nif (antsel_tr_mux == MAIN_ANT_CG_TRX) {\r\ndm_fat_tbl->MainAnt_Sum[MacId] += RxPWDBAll;\r\ndm_fat_tbl->MainAnt_Cnt[MacId]++;\r\n} else {\r\ndm_fat_tbl->AuxAnt_Sum[MacId] += RxPWDBAll;\r\ndm_fat_tbl->AuxAnt_Cnt[MacId]++;\r\n}\r\n} else if (dm_odm->AntDivType == CGCS_RX_HW_ANTDIV) {\r\nif (antsel_tr_mux == MAIN_ANT_CGCS_RX) {\r\ndm_fat_tbl->MainAnt_Sum[MacId] += RxPWDBAll;\r\ndm_fat_tbl->MainAnt_Cnt[MacId]++;\r\n} else {\r\ndm_fat_tbl->AuxAnt_Sum[MacId] += RxPWDBAll;\r\ndm_fat_tbl->AuxAnt_Cnt[MacId]++;\r\n}\r\n}\r\n}\r\nstatic void odm_HWAntDiv(struct odm_dm_struct *dm_odm)\r\n{\r\nu32 i, MinRSSI = 0xFF, AntDivMaxRSSI = 0, MaxRSSI = 0, LocalMinRSSI, LocalMaxRSSI;\r\nu32 Main_RSSI, Aux_RSSI;\r\nu8 RxIdleAnt = 0, TargetAnt = 7;\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nstruct rtw_dig *pDM_DigTable = &dm_odm->DM_DigTable;\r\nstruct sta_info *pEntry;\r\nfor (i = 0; i < ODM_ASSOCIATE_ENTRY_NUM; i++) {\r\npEntry = dm_odm->pODM_StaInfo[i];\r\nif (IS_STA_VALID(pEntry)) {\r\nMain_RSSI = (dm_fat_tbl->MainAnt_Cnt[i] != 0) ? (dm_fat_tbl->MainAnt_Sum[i]/dm_fat_tbl->MainAnt_Cnt[i]) : 0;\r\nAux_RSSI = (dm_fat_tbl->AuxAnt_Cnt[i] != 0) ? (dm_fat_tbl->AuxAnt_Sum[i]/dm_fat_tbl->AuxAnt_Cnt[i]) : 0;\r\nTargetAnt = (Main_RSSI >= Aux_RSSI) ? MAIN_ANT : AUX_ANT;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD,\r\n("MacID=%d, MainAnt_Sum=%d, MainAnt_Cnt=%d\n",\r\ni, dm_fat_tbl->MainAnt_Sum[i],\r\ndm_fat_tbl->MainAnt_Cnt[i]));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD,\r\n("MacID=%d, AuxAnt_Sum=%d, AuxAnt_Cnt=%d\n",\r\ni, dm_fat_tbl->AuxAnt_Sum[i], dm_fat_tbl->AuxAnt_Cnt[i]));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD,\r\n("MacID=%d, Main_RSSI= %d, Aux_RSSI= %d\n",\r\ni, Main_RSSI, Aux_RSSI));\r\nLocalMaxRSSI = (Main_RSSI > Aux_RSSI) ? Main_RSSI : Aux_RSSI;\r\nif ((LocalMaxRSSI > AntDivMaxRSSI) && (LocalMaxRSSI < 40))\r\nAntDivMaxRSSI = LocalMaxRSSI;\r\nif (LocalMaxRSSI > MaxRSSI)\r\nMaxRSSI = LocalMaxRSSI;\r\nif ((dm_fat_tbl->RxIdleAnt == MAIN_ANT) && (Main_RSSI == 0))\r\nMain_RSSI = Aux_RSSI;\r\nelse if ((dm_fat_tbl->RxIdleAnt == AUX_ANT) && (Aux_RSSI == 0))\r\nAux_RSSI = Main_RSSI;\r\nLocalMinRSSI = (Main_RSSI > Aux_RSSI) ? Aux_RSSI : Main_RSSI;\r\nif (LocalMinRSSI < MinRSSI) {\r\nMinRSSI = LocalMinRSSI;\r\nRxIdleAnt = TargetAnt;\r\n}\r\nif (dm_odm->AntDivType == CG_TRX_HW_ANTDIV)\r\nodm_UpdateTxAnt_88E(dm_odm, TargetAnt, i);\r\n}\r\ndm_fat_tbl->MainAnt_Sum[i] = 0;\r\ndm_fat_tbl->AuxAnt_Sum[i] = 0;\r\ndm_fat_tbl->MainAnt_Cnt[i] = 0;\r\ndm_fat_tbl->AuxAnt_Cnt[i] = 0;\r\n}\r\nODM_UpdateRxIdleAnt_88E(dm_odm, RxIdleAnt);\r\npDM_DigTable->AntDiv_RSSI_max = AntDivMaxRSSI;\r\npDM_DigTable->RSSI_max = MaxRSSI;\r\n}\r\nvoid ODM_AntennaDiversity_88E(struct odm_dm_struct *dm_odm)\r\n{\r\nstruct fast_ant_train *dm_fat_tbl = &dm_odm->DM_FatTable;\r\nstruct adapter *adapter = dm_odm->Adapter;\r\nif (!(dm_odm->SupportAbility & ODM_BB_ANT_DIV))\r\nreturn;\r\nif (!dm_odm->bLinked) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("ODM_AntennaDiversity_88E(): No Link.\n"));\r\nif (dm_fat_tbl->bBecomeLinked) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("Need to Turn off HW AntDiv\n"));\r\nPHY_SetBBReg(adapter, ODM_REG_IGI_A_11N, BIT7, 0);\r\nPHY_SetBBReg(adapter, ODM_REG_CCK_ANTDIV_PARA1_11N, BIT15, 0);\r\nif (dm_odm->AntDivType == CG_TRX_HW_ANTDIV)\r\nPHY_SetBBReg(adapter, ODM_REG_TX_ANT_CTRL_11N, BIT21, 0);\r\ndm_fat_tbl->bBecomeLinked = dm_odm->bLinked;\r\n}\r\nreturn;\r\n} else {\r\nif (!dm_fat_tbl->bBecomeLinked) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_ANT_DIV, ODM_DBG_LOUD, ("Need to Turn on HW AntDiv\n"));\r\nPHY_SetBBReg(adapter, ODM_REG_IGI_A_11N, BIT7, 1);\r\nPHY_SetBBReg(adapter, ODM_REG_CCK_ANTDIV_PARA1_11N, BIT15, 1);\r\nif (dm_odm->AntDivType == CG_TRX_HW_ANTDIV)\r\nPHY_SetBBReg(adapter, ODM_REG_TX_ANT_CTRL_11N, BIT21, 1);\r\ndm_fat_tbl->bBecomeLinked = dm_odm->bLinked;\r\n}\r\n}\r\nif ((dm_odm->AntDivType == CG_TRX_HW_ANTDIV) || (dm_odm->AntDivType == CGCS_RX_HW_ANTDIV))\r\nodm_HWAntDiv(dm_odm);\r\n}\r\nvoid odm_PrimaryCCA_Init(struct odm_dm_struct *dm_odm)\r\n{\r\nstruct dyn_primary_cca *PrimaryCCA = &(dm_odm->DM_PriCCA);\r\nPrimaryCCA->DupRTS_flag = 0;\r\nPrimaryCCA->intf_flag = 0;\r\nPrimaryCCA->intf_type = 0;\r\nPrimaryCCA->Monitor_flag = 0;\r\nPrimaryCCA->PriCCA_flag = 0;\r\n}

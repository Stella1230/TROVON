static inline unsigned long bitmap_size(int num_ssid, int num_id)\r\n{\r\nreturn BITS_TO_LONGS(num_ssid * num_id) * sizeof(unsigned long);\r\n}\r\nstatic struct idset *idset_new(int num_ssid, int num_id)\r\n{\r\nstruct idset *set;\r\nset = vmalloc(sizeof(struct idset) + bitmap_size(num_ssid, num_id));\r\nif (set) {\r\nset->num_ssid = num_ssid;\r\nset->num_id = num_id;\r\nmemset(set->bitmap, 0, bitmap_size(num_ssid, num_id));\r\n}\r\nreturn set;\r\n}\r\nvoid idset_free(struct idset *set)\r\n{\r\nvfree(set);\r\n}\r\nvoid idset_clear(struct idset *set)\r\n{\r\nmemset(set->bitmap, 0, bitmap_size(set->num_ssid, set->num_id));\r\n}\r\nvoid idset_fill(struct idset *set)\r\n{\r\nmemset(set->bitmap, 0xff, bitmap_size(set->num_ssid, set->num_id));\r\n}\r\nstatic inline void idset_add(struct idset *set, int ssid, int id)\r\n{\r\nset_bit(ssid * set->num_id + id, set->bitmap);\r\n}\r\nstatic inline void idset_del(struct idset *set, int ssid, int id)\r\n{\r\nclear_bit(ssid * set->num_id + id, set->bitmap);\r\n}\r\nstatic inline int idset_contains(struct idset *set, int ssid, int id)\r\n{\r\nreturn test_bit(ssid * set->num_id + id, set->bitmap);\r\n}\r\nstatic inline int idset_get_first(struct idset *set, int *ssid, int *id)\r\n{\r\nint bitnum;\r\nbitnum = find_first_bit(set->bitmap, set->num_ssid * set->num_id);\r\nif (bitnum >= set->num_ssid * set->num_id)\r\nreturn 0;\r\n*ssid = bitnum / set->num_id;\r\n*id = bitnum % set->num_id;\r\nreturn 1;\r\n}\r\nstruct idset *idset_sch_new(void)\r\n{\r\nreturn idset_new(max_ssid + 1, __MAX_SUBCHANNEL + 1);\r\n}\r\nvoid idset_sch_add(struct idset *set, struct subchannel_id schid)\r\n{\r\nidset_add(set, schid.ssid, schid.sch_no);\r\n}\r\nvoid idset_sch_del(struct idset *set, struct subchannel_id schid)\r\n{\r\nidset_del(set, schid.ssid, schid.sch_no);\r\n}\r\nvoid idset_sch_del_subseq(struct idset *set, struct subchannel_id schid)\r\n{\r\nint pos = schid.ssid * set->num_id + schid.sch_no;\r\nbitmap_clear(set->bitmap, pos, set->num_id - schid.sch_no);\r\n}\r\nint idset_sch_contains(struct idset *set, struct subchannel_id schid)\r\n{\r\nreturn idset_contains(set, schid.ssid, schid.sch_no);\r\n}\r\nint idset_sch_get_first(struct idset *set, struct subchannel_id *schid)\r\n{\r\nint ssid = 0;\r\nint id = 0;\r\nint rc;\r\nrc = idset_get_first(set, &ssid, &id);\r\nif (rc) {\r\ninit_subchannel_id(schid);\r\nschid->ssid = ssid;\r\nschid->sch_no = id;\r\n}\r\nreturn rc;\r\n}\r\nint idset_is_empty(struct idset *set)\r\n{\r\nreturn bitmap_empty(set->bitmap, set->num_ssid * set->num_id);\r\n}\r\nvoid idset_add_set(struct idset *to, struct idset *from)\r\n{\r\nint len = min(to->num_ssid * to->num_id, from->num_ssid * from->num_id);\r\nbitmap_or(to->bitmap, to->bitmap, from->bitmap, len);\r\n}

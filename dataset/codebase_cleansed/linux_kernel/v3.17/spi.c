static irqreturn_t wl1251_irq(int irq, void *cookie)\r\n{\r\nstruct wl1251 *wl;\r\nwl1251_debug(DEBUG_IRQ, "IRQ");\r\nwl = cookie;\r\nieee80211_queue_work(wl->hw, &wl->irq_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic struct spi_device *wl_to_spi(struct wl1251 *wl)\r\n{\r\nreturn wl->if_priv;\r\n}\r\nstatic void wl1251_spi_reset(struct wl1251 *wl)\r\n{\r\nu8 *cmd;\r\nstruct spi_transfer t;\r\nstruct spi_message m;\r\ncmd = kzalloc(WSPI_INIT_CMD_LEN, GFP_KERNEL);\r\nif (!cmd) {\r\nwl1251_error("could not allocate cmd for spi reset");\r\nreturn;\r\n}\r\nmemset(&t, 0, sizeof(t));\r\nspi_message_init(&m);\r\nmemset(cmd, 0xff, WSPI_INIT_CMD_LEN);\r\nt.tx_buf = cmd;\r\nt.len = WSPI_INIT_CMD_LEN;\r\nspi_message_add_tail(&t, &m);\r\nspi_sync(wl_to_spi(wl), &m);\r\nwl1251_dump(DEBUG_SPI, "spi reset -> ", cmd, WSPI_INIT_CMD_LEN);\r\nkfree(cmd);\r\n}\r\nstatic void wl1251_spi_wake(struct wl1251 *wl)\r\n{\r\nstruct spi_transfer t;\r\nstruct spi_message m;\r\nu8 *cmd = kzalloc(WSPI_INIT_CMD_LEN, GFP_KERNEL);\r\nif (!cmd) {\r\nwl1251_error("could not allocate cmd for spi init");\r\nreturn;\r\n}\r\nmemset(&t, 0, sizeof(t));\r\nspi_message_init(&m);\r\ncmd[0] = 0xff;\r\ncmd[1] = 0xff;\r\ncmd[2] = WSPI_INIT_CMD_START | WSPI_INIT_CMD_TX;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\ncmd[5] = HW_ACCESS_WSPI_INIT_CMD_MASK << 3;\r\ncmd[5] |= HW_ACCESS_WSPI_FIXED_BUSY_LEN & WSPI_INIT_CMD_FIXEDBUSY_LEN;\r\ncmd[6] = WSPI_INIT_CMD_IOD | WSPI_INIT_CMD_IP | WSPI_INIT_CMD_CS\r\n| WSPI_INIT_CMD_WSPI | WSPI_INIT_CMD_WS;\r\nif (HW_ACCESS_WSPI_FIXED_BUSY_LEN == 0)\r\ncmd[6] |= WSPI_INIT_CMD_DIS_FIXEDBUSY;\r\nelse\r\ncmd[6] |= WSPI_INIT_CMD_EN_FIXEDBUSY;\r\ncmd[7] = crc7_be(0, cmd+2, WSPI_INIT_CMD_CRC_LEN) | WSPI_INIT_CMD_END;\r\n__swab32s((u32 *)cmd);\r\n__swab32s((u32 *)cmd+1);\r\nt.tx_buf = cmd;\r\nt.len = WSPI_INIT_CMD_LEN;\r\nspi_message_add_tail(&t, &m);\r\nspi_sync(wl_to_spi(wl), &m);\r\nwl1251_dump(DEBUG_SPI, "spi init -> ", cmd, WSPI_INIT_CMD_LEN);\r\nkfree(cmd);\r\n}\r\nstatic void wl1251_spi_reset_wake(struct wl1251 *wl)\r\n{\r\nwl1251_spi_reset(wl);\r\nwl1251_spi_wake(wl);\r\n}\r\nstatic void wl1251_spi_read(struct wl1251 *wl, int addr, void *buf,\r\nsize_t len)\r\n{\r\nstruct spi_transfer t[3];\r\nstruct spi_message m;\r\nu8 *busy_buf;\r\nu32 *cmd;\r\ncmd = &wl->buffer_cmd;\r\nbusy_buf = wl->buffer_busyword;\r\n*cmd = 0;\r\n*cmd |= WSPI_CMD_READ;\r\n*cmd |= (len << WSPI_CMD_BYTE_LENGTH_OFFSET) & WSPI_CMD_BYTE_LENGTH;\r\n*cmd |= addr & WSPI_CMD_BYTE_ADDR;\r\nspi_message_init(&m);\r\nmemset(t, 0, sizeof(t));\r\nt[0].tx_buf = cmd;\r\nt[0].len = 4;\r\nspi_message_add_tail(&t[0], &m);\r\nt[1].rx_buf = busy_buf;\r\nt[1].len = WL1251_BUSY_WORD_LEN;\r\nspi_message_add_tail(&t[1], &m);\r\nt[2].rx_buf = buf;\r\nt[2].len = len;\r\nspi_message_add_tail(&t[2], &m);\r\nspi_sync(wl_to_spi(wl), &m);\r\nwl1251_dump(DEBUG_SPI, "spi_read cmd -> ", cmd, sizeof(*cmd));\r\nwl1251_dump(DEBUG_SPI, "spi_read buf <- ", buf, len);\r\n}\r\nstatic void wl1251_spi_write(struct wl1251 *wl, int addr, void *buf,\r\nsize_t len)\r\n{\r\nstruct spi_transfer t[2];\r\nstruct spi_message m;\r\nu32 *cmd;\r\ncmd = &wl->buffer_cmd;\r\n*cmd = 0;\r\n*cmd |= WSPI_CMD_WRITE;\r\n*cmd |= (len << WSPI_CMD_BYTE_LENGTH_OFFSET) & WSPI_CMD_BYTE_LENGTH;\r\n*cmd |= addr & WSPI_CMD_BYTE_ADDR;\r\nspi_message_init(&m);\r\nmemset(t, 0, sizeof(t));\r\nt[0].tx_buf = cmd;\r\nt[0].len = sizeof(*cmd);\r\nspi_message_add_tail(&t[0], &m);\r\nt[1].tx_buf = buf;\r\nt[1].len = len;\r\nspi_message_add_tail(&t[1], &m);\r\nspi_sync(wl_to_spi(wl), &m);\r\nwl1251_dump(DEBUG_SPI, "spi_write cmd -> ", cmd, sizeof(*cmd));\r\nwl1251_dump(DEBUG_SPI, "spi_write buf -> ", buf, len);\r\n}\r\nstatic void wl1251_spi_enable_irq(struct wl1251 *wl)\r\n{\r\nreturn enable_irq(wl->irq);\r\n}\r\nstatic void wl1251_spi_disable_irq(struct wl1251 *wl)\r\n{\r\nreturn disable_irq(wl->irq);\r\n}\r\nstatic int wl1251_spi_set_power(struct wl1251 *wl, bool enable)\r\n{\r\nif (gpio_is_valid(wl->power_gpio))\r\ngpio_set_value(wl->power_gpio, enable);\r\nreturn 0;\r\n}\r\nstatic int wl1251_spi_probe(struct spi_device *spi)\r\n{\r\nstruct wl1251_platform_data *pdata = dev_get_platdata(&spi->dev);\r\nstruct device_node *np = spi->dev.of_node;\r\nstruct ieee80211_hw *hw;\r\nstruct wl1251 *wl;\r\nint ret;\r\nif (!np && !pdata) {\r\nwl1251_error("no platform data");\r\nreturn -ENODEV;\r\n}\r\nhw = wl1251_alloc_hw();\r\nif (IS_ERR(hw))\r\nreturn PTR_ERR(hw);\r\nwl = hw->priv;\r\nSET_IEEE80211_DEV(hw, &spi->dev);\r\nspi_set_drvdata(spi, wl);\r\nwl->if_priv = spi;\r\nwl->if_ops = &wl1251_spi_ops;\r\nspi->bits_per_word = 32;\r\nret = spi_setup(spi);\r\nif (ret < 0) {\r\nwl1251_error("spi_setup failed");\r\ngoto out_free;\r\n}\r\nif (np) {\r\nwl->use_eeprom = of_property_read_bool(np, "ti,wl1251-has-eeprom");\r\nwl->power_gpio = of_get_named_gpio(np, "ti,power-gpio", 0);\r\n} else if (pdata) {\r\nwl->power_gpio = pdata->power_gpio;\r\nwl->use_eeprom = pdata->use_eeprom;\r\n}\r\nif (wl->power_gpio == -EPROBE_DEFER) {\r\nret = -EPROBE_DEFER;\r\ngoto out_free;\r\n}\r\nif (gpio_is_valid(wl->power_gpio)) {\r\nret = devm_gpio_request_one(&spi->dev, wl->power_gpio,\r\nGPIOF_OUT_INIT_LOW, "wl1251 power");\r\nif (ret) {\r\nwl1251_error("Failed to request gpio: %d\n", ret);\r\ngoto out_free;\r\n}\r\n} else {\r\nwl1251_error("set power gpio missing in platform data");\r\nret = -ENODEV;\r\ngoto out_free;\r\n}\r\nwl->irq = spi->irq;\r\nif (wl->irq < 0) {\r\nwl1251_error("irq missing in platform data");\r\nret = -ENODEV;\r\ngoto out_free;\r\n}\r\nirq_set_status_flags(wl->irq, IRQ_NOAUTOEN);\r\nret = devm_request_irq(&spi->dev, wl->irq, wl1251_irq, 0,\r\nDRIVER_NAME, wl);\r\nif (ret < 0) {\r\nwl1251_error("request_irq() failed: %d", ret);\r\ngoto out_free;\r\n}\r\nirq_set_irq_type(wl->irq, IRQ_TYPE_EDGE_RISING);\r\nwl->vio = devm_regulator_get(&spi->dev, "vio");\r\nif (IS_ERR(wl->vio)) {\r\nret = PTR_ERR(wl->vio);\r\nwl1251_error("vio regulator missing: %d", ret);\r\ngoto out_free;\r\n}\r\nret = regulator_enable(wl->vio);\r\nif (ret)\r\ngoto out_free;\r\nret = wl1251_init_ieee80211(wl);\r\nif (ret)\r\ngoto disable_regulator;\r\nreturn 0;\r\ndisable_regulator:\r\nregulator_disable(wl->vio);\r\nout_free:\r\nieee80211_free_hw(hw);\r\nreturn ret;\r\n}\r\nstatic int wl1251_spi_remove(struct spi_device *spi)\r\n{\r\nstruct wl1251 *wl = spi_get_drvdata(spi);\r\nfree_irq(wl->irq, wl);\r\nwl1251_free_hw(wl);\r\nregulator_disable(wl->vio);\r\nreturn 0;\r\n}

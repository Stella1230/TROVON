acpi_status\r\nacpi_ds_exec_begin_control_op(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_generic_state *control_state;\r\nACPI_FUNCTION_NAME(ds_exec_begin_control_op);\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Op=%p Opcode=%2.2X State=%p\n",\r\nop, op->common.aml_opcode, walk_state));\r\nswitch (op->common.aml_opcode) {\r\ncase AML_WHILE_OP:\r\nif (walk_state->control_state) {\r\nif (walk_state->control_state->control.\r\naml_predicate_start ==\r\n(walk_state->parser_state.aml - 1)) {\r\nwalk_state->control_state->common.state =\r\nACPI_CONTROL_CONDITIONAL_EXECUTING;\r\nbreak;\r\n}\r\n}\r\ncase AML_IF_OP:\r\ncontrol_state = acpi_ut_create_control_state();\r\nif (!control_state) {\r\nstatus = AE_NO_MEMORY;\r\nbreak;\r\n}\r\ncontrol_state->control.aml_predicate_start =\r\nwalk_state->parser_state.aml - 1;\r\ncontrol_state->control.package_end =\r\nwalk_state->parser_state.pkg_end;\r\ncontrol_state->control.opcode = op->common.aml_opcode;\r\nacpi_ut_push_generic_state(&walk_state->control_state,\r\ncontrol_state);\r\nbreak;\r\ncase AML_ELSE_OP:\r\nif (walk_state->last_predicate) {\r\nstatus = AE_CTRL_TRUE;\r\n}\r\nbreak;\r\ncase AML_RETURN_OP:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn (status);\r\n}\r\nacpi_status\r\nacpi_ds_exec_end_control_op(struct acpi_walk_state * walk_state,\r\nunion acpi_parse_object * op)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_generic_state *control_state;\r\nACPI_FUNCTION_NAME(ds_exec_end_control_op);\r\nswitch (op->common.aml_opcode) {\r\ncase AML_IF_OP:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "[IF_OP] Op=%p\n", op));\r\nwalk_state->last_predicate =\r\n(u8)walk_state->control_state->common.value;\r\ncontrol_state =\r\nacpi_ut_pop_generic_state(&walk_state->control_state);\r\nacpi_ut_delete_generic_state(control_state);\r\nbreak;\r\ncase AML_ELSE_OP:\r\nbreak;\r\ncase AML_WHILE_OP:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "[WHILE_OP] Op=%p\n", op));\r\ncontrol_state = walk_state->control_state;\r\nif (control_state->common.value) {\r\ncontrol_state->control.loop_count++;\r\nif (control_state->control.loop_count >\r\nACPI_MAX_LOOP_ITERATIONS) {\r\nstatus = AE_AML_INFINITE_LOOP;\r\nbreak;\r\n}\r\nstatus = AE_CTRL_PENDING;\r\nwalk_state->aml_last_while =\r\ncontrol_state->control.aml_predicate_start;\r\nbreak;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"[WHILE_OP] termination! Op=%p\n", op));\r\ncontrol_state =\r\nacpi_ut_pop_generic_state(&walk_state->control_state);\r\nacpi_ut_delete_generic_state(control_state);\r\nbreak;\r\ncase AML_RETURN_OP:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"[RETURN_OP] Op=%p Arg=%p\n", op,\r\nop->common.value.arg));\r\nif (op->common.value.arg) {\r\nacpi_ds_clear_implicit_return(walk_state);\r\nstatus =\r\nacpi_ds_create_operands(walk_state,\r\nop->common.value.arg);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nstatus =\r\nacpi_ex_resolve_to_value(&walk_state->operands[0],\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nwalk_state->return_desc = walk_state->operands[0];\r\n} else if (walk_state->result_count) {\r\nacpi_ds_clear_implicit_return(walk_state);\r\nif ((ACPI_GET_DESCRIPTOR_TYPE\r\n(walk_state->results->results.obj_desc[0]) ==\r\nACPI_DESC_TYPE_OPERAND)\r\n&& ((walk_state->results->results.obj_desc[0])->\r\ncommon.type == ACPI_TYPE_LOCAL_REFERENCE)\r\n&& ((walk_state->results->results.obj_desc[0])->\r\nreference.class != ACPI_REFCLASS_INDEX)) {\r\nstatus =\r\nacpi_ex_resolve_to_value(&walk_state->\r\nresults->results.\r\nobj_desc[0],\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\n}\r\nwalk_state->return_desc =\r\nwalk_state->results->results.obj_desc[0];\r\n} else {\r\nif (walk_state->num_operands) {\r\nacpi_ut_remove_reference(walk_state->\r\noperands[0]);\r\n}\r\nwalk_state->operands[0] = NULL;\r\nwalk_state->num_operands = 0;\r\nwalk_state->return_desc = NULL;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Completed RETURN_OP State=%p, RetVal=%p\n",\r\nwalk_state, walk_state->return_desc));\r\nstatus = AE_CTRL_TERMINATE;\r\nbreak;\r\ncase AML_NOOP_OP:\r\nbreak;\r\ncase AML_BREAK_POINT_OP:\r\nACPI_DEBUGGER_EXEC(acpi_gbl_cm_single_step = TRUE);\r\nACPI_DEBUGGER_EXEC(acpi_os_printf\r\n("**break** Executed AML BreakPoint opcode\n"));\r\nstatus = acpi_os_signal(ACPI_SIGNAL_BREAKPOINT,\r\n"Executed AML Breakpoint opcode");\r\nbreak;\r\ncase AML_BREAK_OP:\r\ncase AML_CONTINUE_OP:\r\nwhile (walk_state->control_state &&\r\n(walk_state->control_state->control.opcode !=\r\nAML_WHILE_OP)) {\r\ncontrol_state =\r\nacpi_ut_pop_generic_state(&walk_state->\r\ncontrol_state);\r\nacpi_ut_delete_generic_state(control_state);\r\n}\r\nif (!walk_state->control_state) {\r\nreturn (AE_AML_NO_WHILE);\r\n}\r\nwalk_state->aml_last_while =\r\nwalk_state->control_state->control.package_end;\r\nif (op->common.aml_opcode == AML_BREAK_OP) {\r\nstatus = AE_CTRL_BREAK;\r\n} else {\r\nstatus = AE_CTRL_CONTINUE;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Unknown control opcode=0x%X Op=%p",\r\nop->common.aml_opcode, op));\r\nstatus = AE_AML_BAD_OPCODE;\r\nbreak;\r\n}\r\nreturn (status);\r\n}

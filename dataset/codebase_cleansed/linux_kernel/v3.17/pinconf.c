int pinconf_check_ops(struct pinctrl_dev *pctldev)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nif (!ops->pin_config_set && !ops->pin_config_group_set) {\r\ndev_err(pctldev->dev,\r\n"pinconf has to be able to set a pins config\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint pinconf_validate_map(struct pinctrl_map const *map, int i)\r\n{\r\nif (!map->data.configs.group_or_pin) {\r\npr_err("failed to register map %s (%d): no group/pin given\n",\r\nmap->name, i);\r\nreturn -EINVAL;\r\n}\r\nif (!map->data.configs.num_configs ||\r\n!map->data.configs.configs) {\r\npr_err("failed to register map %s (%d): no configs given\n",\r\nmap->name, i);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint pin_config_get_for_pin(struct pinctrl_dev *pctldev, unsigned pin,\r\nunsigned long *config)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nif (!ops || !ops->pin_config_get) {\r\ndev_dbg(pctldev->dev, "cannot get pin configuration, missing "\r\n"pin_config_get() function in driver\n");\r\nreturn -ENOTSUPP;\r\n}\r\nreturn ops->pin_config_get(pctldev, pin, config);\r\n}\r\nint pin_config_group_get(const char *dev_name, const char *pin_group,\r\nunsigned long *config)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *ops;\r\nint selector, ret;\r\npctldev = get_pinctrl_dev_from_devname(dev_name);\r\nif (!pctldev) {\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nmutex_lock(&pctldev->mutex);\r\nops = pctldev->desc->confops;\r\nif (!ops || !ops->pin_config_group_get) {\r\ndev_dbg(pctldev->dev, "cannot get configuration for pin "\r\n"group, missing group config get function in "\r\n"driver\n");\r\nret = -ENOTSUPP;\r\ngoto unlock;\r\n}\r\nselector = pinctrl_get_group_selector(pctldev, pin_group);\r\nif (selector < 0) {\r\nret = selector;\r\ngoto unlock;\r\n}\r\nret = ops->pin_config_group_get(pctldev, selector, config);\r\nunlock:\r\nmutex_unlock(&pctldev->mutex);\r\nreturn ret;\r\n}\r\nint pinconf_map_to_setting(struct pinctrl_map const *map,\r\nstruct pinctrl_setting *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nint pin;\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\npin = pin_get_from_name(pctldev,\r\nmap->data.configs.group_or_pin);\r\nif (pin < 0) {\r\ndev_err(pctldev->dev, "could not map pin config for \"%s\"",\r\nmap->data.configs.group_or_pin);\r\nreturn pin;\r\n}\r\nsetting->data.configs.group_or_pin = pin;\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\npin = pinctrl_get_group_selector(pctldev,\r\nmap->data.configs.group_or_pin);\r\nif (pin < 0) {\r\ndev_err(pctldev->dev, "could not map group config for \"%s\"",\r\nmap->data.configs.group_or_pin);\r\nreturn pin;\r\n}\r\nsetting->data.configs.group_or_pin = pin;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsetting->data.configs.num_configs = map->data.configs.num_configs;\r\nsetting->data.configs.configs = map->data.configs.configs;\r\nreturn 0;\r\n}\r\nvoid pinconf_free_setting(struct pinctrl_setting const *setting)\r\n{\r\n}\r\nint pinconf_apply_setting(struct pinctrl_setting const *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nint ret;\r\nif (!ops) {\r\ndev_err(pctldev->dev, "missing confops\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\nif (!ops->pin_config_set) {\r\ndev_err(pctldev->dev, "missing pin_config_set op\n");\r\nreturn -EINVAL;\r\n}\r\nret = ops->pin_config_set(pctldev,\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs,\r\nsetting->data.configs.num_configs);\r\nif (ret < 0) {\r\ndev_err(pctldev->dev,\r\n"pin_config_set op failed for pin %d\n",\r\nsetting->data.configs.group_or_pin);\r\nreturn ret;\r\n}\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nif (!ops->pin_config_group_set) {\r\ndev_err(pctldev->dev,\r\n"missing pin_config_group_set op\n");\r\nreturn -EINVAL;\r\n}\r\nret = ops->pin_config_group_set(pctldev,\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs,\r\nsetting->data.configs.num_configs);\r\nif (ret < 0) {\r\ndev_err(pctldev->dev,\r\n"pin_config_group_set op failed for group %d\n",\r\nsetting->data.configs.group_or_pin);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nvoid pinconf_show_map(struct seq_file *s, struct pinctrl_map const *map)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *confops;\r\nint i;\r\npctldev = get_pinctrl_dev_from_devname(map->ctrl_dev_name);\r\nif (pctldev)\r\nconfops = pctldev->desc->confops;\r\nelse\r\nconfops = NULL;\r\nswitch (map->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\nseq_printf(s, "pin ");\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nseq_printf(s, "group ");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nseq_printf(s, "%s\n", map->data.configs.group_or_pin);\r\nfor (i = 0; i < map->data.configs.num_configs; i++) {\r\nseq_printf(s, "config ");\r\nif (confops && confops->pin_config_config_dbg_show)\r\nconfops->pin_config_config_dbg_show(pctldev, s,\r\nmap->data.configs.configs[i]);\r\nelse\r\nseq_printf(s, "%08lx", map->data.configs.configs[i]);\r\nseq_printf(s, "\n");\r\n}\r\n}\r\nvoid pinconf_show_setting(struct seq_file *s,\r\nstruct pinctrl_setting const *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nconst struct pinctrl_ops *pctlops = pctldev->desc->pctlops;\r\nconst struct pinconf_ops *confops = pctldev->desc->confops;\r\nstruct pin_desc *desc;\r\nint i;\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\ndesc = pin_desc_get(setting->pctldev,\r\nsetting->data.configs.group_or_pin);\r\nseq_printf(s, "pin %s (%d)",\r\ndesc->name ? desc->name : "unnamed",\r\nsetting->data.configs.group_or_pin);\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nseq_printf(s, "group %s (%d)",\r\npctlops->get_group_name(pctldev,\r\nsetting->data.configs.group_or_pin),\r\nsetting->data.configs.group_or_pin);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nfor (i = 0; i < setting->data.configs.num_configs; i++) {\r\nseq_printf(s, " ");\r\nif (confops && confops->pin_config_config_dbg_show)\r\nconfops->pin_config_config_dbg_show(pctldev, s,\r\nsetting->data.configs.configs[i]);\r\nelse\r\nseq_printf(s, "%08lx",\r\nsetting->data.configs.configs[i]);\r\n}\r\nseq_printf(s, "\n");\r\n}\r\nstatic void pinconf_dump_pin(struct pinctrl_dev *pctldev,\r\nstruct seq_file *s, int pin)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\npinconf_generic_dump_pin(pctldev, s, pin);\r\nif (ops && ops->pin_config_dbg_show)\r\nops->pin_config_dbg_show(pctldev, s, pin);\r\n}\r\nstatic int pinconf_pins_show(struct seq_file *s, void *what)\r\n{\r\nstruct pinctrl_dev *pctldev = s->private;\r\nunsigned i, pin;\r\nseq_puts(s, "Pin config settings per pin\n");\r\nseq_puts(s, "Format: pin (name): configs\n");\r\nmutex_lock(&pctldev->mutex);\r\nfor (i = 0; i < pctldev->desc->npins; i++) {\r\nstruct pin_desc *desc;\r\npin = pctldev->desc->pins[i].number;\r\ndesc = pin_desc_get(pctldev, pin);\r\nif (desc == NULL)\r\ncontinue;\r\nseq_printf(s, "pin %d (%s):", pin,\r\ndesc->name ? desc->name : "unnamed");\r\npinconf_dump_pin(pctldev, s, pin);\r\nseq_printf(s, "\n");\r\n}\r\nmutex_unlock(&pctldev->mutex);\r\nreturn 0;\r\n}\r\nstatic void pinconf_dump_group(struct pinctrl_dev *pctldev,\r\nstruct seq_file *s, unsigned selector,\r\nconst char *gname)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\npinconf_generic_dump_group(pctldev, s, gname);\r\nif (ops && ops->pin_config_group_dbg_show)\r\nops->pin_config_group_dbg_show(pctldev, s, selector);\r\n}\r\nstatic int pinconf_groups_show(struct seq_file *s, void *what)\r\n{\r\nstruct pinctrl_dev *pctldev = s->private;\r\nconst struct pinctrl_ops *pctlops = pctldev->desc->pctlops;\r\nunsigned ngroups = pctlops->get_groups_count(pctldev);\r\nunsigned selector = 0;\r\nseq_puts(s, "Pin config settings per pin group\n");\r\nseq_puts(s, "Format: group (name): configs\n");\r\nwhile (selector < ngroups) {\r\nconst char *gname = pctlops->get_group_name(pctldev, selector);\r\nseq_printf(s, "%u (%s):", selector, gname);\r\npinconf_dump_group(pctldev, s, selector, gname);\r\nseq_printf(s, "\n");\r\nselector++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pinconf_pins_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, pinconf_pins_show, inode->i_private);\r\n}\r\nstatic int pinconf_groups_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, pinconf_groups_show, inode->i_private);\r\n}\r\nstatic int pinconf_dbg_config_print(struct seq_file *s, void *d)\r\n{\r\nstruct pinctrl_maps *maps_node;\r\nconst struct pinctrl_map *map;\r\nconst struct pinctrl_map *found = NULL;\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *confops = NULL;\r\nstruct dbg_cfg *dbg = &pinconf_dbg_conf;\r\nint i, j;\r\nunsigned long config;\r\nmutex_lock(&pinctrl_maps_mutex);\r\nfor_each_maps(maps_node, i, map) {\r\nif (map->type != dbg->map_type)\r\ncontinue;\r\nif (strcmp(map->dev_name, dbg->dev_name))\r\ncontinue;\r\nif (strcmp(map->name, dbg->state_name))\r\ncontinue;\r\nfor (j = 0; j < map->data.configs.num_configs; j++) {\r\nif (!strcmp(map->data.configs.group_or_pin,\r\ndbg->pin_name)) {\r\nfound = map;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (!found) {\r\nseq_printf(s, "No config found for dev/state/pin, expected:\n");\r\nseq_printf(s, "Searched dev:%s\n", dbg->dev_name);\r\nseq_printf(s, "Searched state:%s\n", dbg->state_name);\r\nseq_printf(s, "Searched pin:%s\n", dbg->pin_name);\r\nseq_printf(s, "Use: modify config_pin <devname> "\\r\n"<state> <pinname> <value>\n");\r\ngoto exit;\r\n}\r\npctldev = get_pinctrl_dev_from_devname(found->ctrl_dev_name);\r\nconfig = *found->data.configs.configs;\r\nseq_printf(s, "Dev %s has config of %s in state %s: 0x%08lX\n",\r\ndbg->dev_name, dbg->pin_name,\r\ndbg->state_name, config);\r\nif (pctldev)\r\nconfops = pctldev->desc->confops;\r\nif (confops && confops->pin_config_config_dbg_show)\r\nconfops->pin_config_config_dbg_show(pctldev, s, config);\r\nexit:\r\nmutex_unlock(&pinctrl_maps_mutex);\r\nreturn 0;\r\n}\r\nstatic ssize_t pinconf_dbg_config_write(struct file *file,\r\nconst char __user *user_buf, size_t count, loff_t *ppos)\r\n{\r\nstruct pinctrl_maps *maps_node;\r\nconst struct pinctrl_map *map;\r\nconst struct pinctrl_map *found = NULL;\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *confops = NULL;\r\nstruct dbg_cfg *dbg = &pinconf_dbg_conf;\r\nconst struct pinctrl_map_configs *configs;\r\nchar config[MAX_NAME_LEN+1];\r\nchar buf[128];\r\nchar *b = &buf[0];\r\nint buf_size;\r\nchar *token;\r\nint i;\r\nbuf_size = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, buf_size))\r\nreturn -EFAULT;\r\nbuf[buf_size] = 0;\r\ntoken = strsep(&b, " ");\r\nif (!token)\r\nreturn -EINVAL;\r\nif (strcmp(token, "modify"))\r\nreturn -EINVAL;\r\ntoken = strsep(&b, " ");\r\nif (!token)\r\nreturn -EINVAL;\r\nif (strcmp(token, "config_pin"))\r\nreturn -EINVAL;\r\ndbg->map_type = PIN_MAP_TYPE_CONFIGS_PIN;\r\ntoken = strsep(&b, " ");\r\nif (token == NULL)\r\nreturn -EINVAL;\r\nif (strlen(token) >= MAX_NAME_LEN)\r\nreturn -EINVAL;\r\nstrncpy(dbg->dev_name, token, MAX_NAME_LEN);\r\ntoken = strsep(&b, " ");\r\nif (token == NULL)\r\nreturn -EINVAL;\r\nif (strlen(token) >= MAX_NAME_LEN)\r\nreturn -EINVAL;\r\nstrncpy(dbg->state_name, token, MAX_NAME_LEN);\r\ntoken = strsep(&b, " ");\r\nif (token == NULL)\r\nreturn -EINVAL;\r\nif (strlen(token) >= MAX_NAME_LEN)\r\nreturn -EINVAL;\r\nstrncpy(dbg->pin_name, token, MAX_NAME_LEN);\r\ntoken = strsep(&b, " ");\r\nif (token == NULL)\r\nreturn -EINVAL;\r\nif (strlen(token) >= MAX_NAME_LEN)\r\nreturn -EINVAL;\r\nstrncpy(config, token, MAX_NAME_LEN);\r\nmutex_lock(&pinctrl_maps_mutex);\r\nfor_each_maps(maps_node, i, map) {\r\nif (strcmp(map->dev_name, dbg->dev_name))\r\ncontinue;\r\nif (map->type != dbg->map_type)\r\ncontinue;\r\nif (strcmp(map->name, dbg->state_name))\r\ncontinue;\r\nif (!strcmp(map->data.configs.group_or_pin, dbg->pin_name)) {\r\nfound = map;\r\nbreak;\r\n}\r\n}\r\nif (!found) {\r\ncount = -EINVAL;\r\ngoto exit;\r\n}\r\npctldev = get_pinctrl_dev_from_devname(found->ctrl_dev_name);\r\nif (pctldev)\r\nconfops = pctldev->desc->confops;\r\nif (confops && confops->pin_config_dbg_parse_modify) {\r\nconfigs = &found->data.configs;\r\nfor (i = 0; i < configs->num_configs; i++) {\r\nconfops->pin_config_dbg_parse_modify(pctldev,\r\nconfig,\r\n&configs->configs[i]);\r\n}\r\n}\r\nexit:\r\nmutex_unlock(&pinctrl_maps_mutex);\r\nreturn count;\r\n}\r\nstatic int pinconf_dbg_config_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, pinconf_dbg_config_print, inode->i_private);\r\n}\r\nvoid pinconf_init_device_debugfs(struct dentry *devroot,\r\nstruct pinctrl_dev *pctldev)\r\n{\r\ndebugfs_create_file("pinconf-pins", S_IFREG | S_IRUGO,\r\ndevroot, pctldev, &pinconf_pins_ops);\r\ndebugfs_create_file("pinconf-groups", S_IFREG | S_IRUGO,\r\ndevroot, pctldev, &pinconf_groups_ops);\r\ndebugfs_create_file("pinconf-config", (S_IRUGO | S_IWUSR | S_IWGRP),\r\ndevroot, pctldev, &pinconf_dbg_pinconfig_fops);\r\n}

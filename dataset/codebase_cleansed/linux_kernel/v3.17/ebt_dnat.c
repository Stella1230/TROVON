static unsigned int\r\nebt_dnat_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ebt_nat_info *info = par->targinfo;\r\nif (!skb_make_writable(skb, 0))\r\nreturn EBT_DROP;\r\nether_addr_copy(eth_hdr(skb)->h_dest, info->mac);\r\nreturn info->target;\r\n}\r\nstatic int ebt_dnat_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ebt_nat_info *info = par->targinfo;\r\nunsigned int hook_mask;\r\nif (BASE_CHAIN && info->target == EBT_RETURN)\r\nreturn -EINVAL;\r\nhook_mask = par->hook_mask & ~(1 << NF_BR_NUMHOOKS);\r\nif ((strcmp(par->table, "nat") != 0 ||\r\n(hook_mask & ~((1 << NF_BR_PRE_ROUTING) |\r\n(1 << NF_BR_LOCAL_OUT)))) &&\r\n(strcmp(par->table, "broute") != 0 ||\r\nhook_mask & ~(1 << NF_BR_BROUTING)))\r\nreturn -EINVAL;\r\nif (INVALID_TARGET)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_dnat_init(void)\r\n{\r\nreturn xt_register_target(&ebt_dnat_tg_reg);\r\n}\r\nstatic void __exit ebt_dnat_fini(void)\r\n{\r\nxt_unregister_target(&ebt_dnat_tg_reg);\r\n}

void cx23885_ir_rx_work_handler(struct work_struct *work)\r\n{\r\nstruct cx23885_dev *dev =\r\ncontainer_of(work, struct cx23885_dev, ir_rx_work);\r\nu32 events = 0;\r\nunsigned long *notifications = &dev->ir_rx_notifications;\r\nif (test_and_clear_bit(CX23885_IR_RX_SW_FIFO_OVERRUN, notifications))\r\nevents |= V4L2_SUBDEV_IR_RX_SW_FIFO_OVERRUN;\r\nif (test_and_clear_bit(CX23885_IR_RX_HW_FIFO_OVERRUN, notifications))\r\nevents |= V4L2_SUBDEV_IR_RX_HW_FIFO_OVERRUN;\r\nif (test_and_clear_bit(CX23885_IR_RX_END_OF_RX_DETECTED, notifications))\r\nevents |= V4L2_SUBDEV_IR_RX_END_OF_RX_DETECTED;\r\nif (test_and_clear_bit(CX23885_IR_RX_FIFO_SERVICE_REQ, notifications))\r\nevents |= V4L2_SUBDEV_IR_RX_FIFO_SERVICE_REQ;\r\nif (events == 0)\r\nreturn;\r\nif (dev->kernel_ir)\r\ncx23885_input_rx_work_handler(dev, events);\r\n}\r\nvoid cx23885_ir_tx_work_handler(struct work_struct *work)\r\n{\r\nstruct cx23885_dev *dev =\r\ncontainer_of(work, struct cx23885_dev, ir_tx_work);\r\nu32 events = 0;\r\nunsigned long *notifications = &dev->ir_tx_notifications;\r\nif (test_and_clear_bit(CX23885_IR_TX_FIFO_SERVICE_REQ, notifications))\r\nevents |= V4L2_SUBDEV_IR_TX_FIFO_SERVICE_REQ;\r\nif (events == 0)\r\nreturn;\r\n}\r\nvoid cx23885_ir_rx_v4l2_dev_notify(struct v4l2_subdev *sd, u32 events)\r\n{\r\nstruct cx23885_dev *dev = to_cx23885(sd->v4l2_dev);\r\nunsigned long *notifications = &dev->ir_rx_notifications;\r\nif (events & V4L2_SUBDEV_IR_RX_FIFO_SERVICE_REQ)\r\nset_bit(CX23885_IR_RX_FIFO_SERVICE_REQ, notifications);\r\nif (events & V4L2_SUBDEV_IR_RX_END_OF_RX_DETECTED)\r\nset_bit(CX23885_IR_RX_END_OF_RX_DETECTED, notifications);\r\nif (events & V4L2_SUBDEV_IR_RX_HW_FIFO_OVERRUN)\r\nset_bit(CX23885_IR_RX_HW_FIFO_OVERRUN, notifications);\r\nif (events & V4L2_SUBDEV_IR_RX_SW_FIFO_OVERRUN)\r\nset_bit(CX23885_IR_RX_SW_FIFO_OVERRUN, notifications);\r\nif (sd == dev->sd_cx25840)\r\ncx23885_ir_rx_work_handler(&dev->ir_rx_work);\r\nelse\r\nschedule_work(&dev->ir_rx_work);\r\n}\r\nvoid cx23885_ir_tx_v4l2_dev_notify(struct v4l2_subdev *sd, u32 events)\r\n{\r\nstruct cx23885_dev *dev = to_cx23885(sd->v4l2_dev);\r\nunsigned long *notifications = &dev->ir_tx_notifications;\r\nif (events & V4L2_SUBDEV_IR_TX_FIFO_SERVICE_REQ)\r\nset_bit(CX23885_IR_TX_FIFO_SERVICE_REQ, notifications);\r\nif (sd == dev->sd_cx25840)\r\ncx23885_ir_tx_work_handler(&dev->ir_tx_work);\r\nelse\r\nschedule_work(&dev->ir_tx_work);\r\n}

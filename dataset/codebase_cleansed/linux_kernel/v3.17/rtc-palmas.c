static int palmas_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char rtc_data[PALMAS_NUM_TIME_REGS];\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = palmas_update_bits(palmas, PALMAS_RTC_BASE, PALMAS_RTC_CTRL_REG,\r\nPALMAS_RTC_CTRL_REG_GET_TIME, PALMAS_RTC_CTRL_REG_GET_TIME);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC CTRL reg update failed, err: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = palmas_bulk_read(palmas, PALMAS_RTC_BASE, PALMAS_SECONDS_REG,\r\nrtc_data, PALMAS_NUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_SECONDS reg read failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(rtc_data[0]);\r\ntm->tm_min = bcd2bin(rtc_data[1]);\r\ntm->tm_hour = bcd2bin(rtc_data[2]);\r\ntm->tm_mday = bcd2bin(rtc_data[3]);\r\ntm->tm_mon = bcd2bin(rtc_data[4]) - 1;\r\ntm->tm_year = bcd2bin(rtc_data[5]) + 100;\r\nreturn ret;\r\n}\r\nstatic int palmas_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char rtc_data[PALMAS_NUM_TIME_REGS];\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nint ret;\r\nrtc_data[0] = bin2bcd(tm->tm_sec);\r\nrtc_data[1] = bin2bcd(tm->tm_min);\r\nrtc_data[2] = bin2bcd(tm->tm_hour);\r\nrtc_data[3] = bin2bcd(tm->tm_mday);\r\nrtc_data[4] = bin2bcd(tm->tm_mon + 1);\r\nrtc_data[5] = bin2bcd(tm->tm_year - 100);\r\nret = palmas_update_bits(palmas, PALMAS_RTC_BASE, PALMAS_RTC_CTRL_REG,\r\nPALMAS_RTC_CTRL_REG_STOP_RTC, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC stop failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = palmas_bulk_write(palmas, PALMAS_RTC_BASE, PALMAS_SECONDS_REG,\r\nrtc_data, PALMAS_NUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_SECONDS reg write failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = palmas_update_bits(palmas, PALMAS_RTC_BASE, PALMAS_RTC_CTRL_REG,\r\nPALMAS_RTC_CTRL_REG_STOP_RTC, PALMAS_RTC_CTRL_REG_STOP_RTC);\r\nif (ret < 0)\r\ndev_err(dev, "RTC start failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int palmas_rtc_alarm_irq_enable(struct device *dev, unsigned enabled)\r\n{\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nu8 val;\r\nval = enabled ? PALMAS_RTC_INTERRUPTS_REG_IT_ALARM : 0;\r\nreturn palmas_write(palmas, PALMAS_RTC_BASE,\r\nPALMAS_RTC_INTERRUPTS_REG, val);\r\n}\r\nstatic int palmas_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char alarm_data[PALMAS_NUM_TIME_REGS];\r\nu32 int_val;\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = palmas_bulk_read(palmas, PALMAS_RTC_BASE,\r\nPALMAS_ALARM_SECONDS_REG,\r\nalarm_data, PALMAS_NUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_ALARM_SECONDS read failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nalm->time.tm_sec = bcd2bin(alarm_data[0]);\r\nalm->time.tm_min = bcd2bin(alarm_data[1]);\r\nalm->time.tm_hour = bcd2bin(alarm_data[2]);\r\nalm->time.tm_mday = bcd2bin(alarm_data[3]);\r\nalm->time.tm_mon = bcd2bin(alarm_data[4]) - 1;\r\nalm->time.tm_year = bcd2bin(alarm_data[5]) + 100;\r\nret = palmas_read(palmas, PALMAS_RTC_BASE, PALMAS_RTC_INTERRUPTS_REG,\r\n&int_val);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_INTERRUPTS reg read failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nif (int_val & PALMAS_RTC_INTERRUPTS_REG_IT_ALARM)\r\nalm->enabled = 1;\r\nreturn ret;\r\n}\r\nstatic int palmas_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char alarm_data[PALMAS_NUM_TIME_REGS];\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = palmas_rtc_alarm_irq_enable(dev, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "Disable RTC alarm failed\n");\r\nreturn ret;\r\n}\r\nalarm_data[0] = bin2bcd(alm->time.tm_sec);\r\nalarm_data[1] = bin2bcd(alm->time.tm_min);\r\nalarm_data[2] = bin2bcd(alm->time.tm_hour);\r\nalarm_data[3] = bin2bcd(alm->time.tm_mday);\r\nalarm_data[4] = bin2bcd(alm->time.tm_mon + 1);\r\nalarm_data[5] = bin2bcd(alm->time.tm_year - 100);\r\nret = palmas_bulk_write(palmas, PALMAS_RTC_BASE,\r\nPALMAS_ALARM_SECONDS_REG, alarm_data, PALMAS_NUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "ALARM_SECONDS_REG write failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alm->enabled)\r\nret = palmas_rtc_alarm_irq_enable(dev, 1);\r\nreturn ret;\r\n}\r\nstatic int palmas_clear_interrupts(struct device *dev)\r\n{\r\nstruct palmas *palmas = dev_get_drvdata(dev->parent);\r\nunsigned int rtc_reg;\r\nint ret;\r\nret = palmas_read(palmas, PALMAS_RTC_BASE, PALMAS_RTC_STATUS_REG,\r\n&rtc_reg);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_STATUS read failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = palmas_write(palmas, PALMAS_RTC_BASE, PALMAS_RTC_STATUS_REG,\r\nrtc_reg);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_STATUS write failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t palmas_rtc_interrupt(int irq, void *context)\r\n{\r\nstruct palmas_rtc *palmas_rtc = context;\r\nstruct device *dev = palmas_rtc->dev;\r\nint ret;\r\nret = palmas_clear_interrupts(dev);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC interrupt clear failed, err = %d\n", ret);\r\nreturn IRQ_NONE;\r\n}\r\nrtc_update_irq(palmas_rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int palmas_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct palmas *palmas = dev_get_drvdata(pdev->dev.parent);\r\nstruct palmas_rtc *palmas_rtc = NULL;\r\nint ret;\r\nbool enable_bb_charging = false;\r\nbool high_bb_charging;\r\nif (pdev->dev.of_node) {\r\nenable_bb_charging = of_property_read_bool(pdev->dev.of_node,\r\n"ti,backup-battery-chargeable");\r\nhigh_bb_charging = of_property_read_bool(pdev->dev.of_node,\r\n"ti,backup-battery-charge-high-current");\r\n}\r\npalmas_rtc = devm_kzalloc(&pdev->dev, sizeof(struct palmas_rtc),\r\nGFP_KERNEL);\r\nif (!palmas_rtc)\r\nreturn -ENOMEM;\r\nret = palmas_clear_interrupts(&pdev->dev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "clear RTC int failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\npalmas_rtc->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, palmas_rtc);\r\nif (enable_bb_charging) {\r\nunsigned reg = PALMAS_BACKUP_BATTERY_CTRL_BBS_BBC_LOW_ICHRG;\r\nif (high_bb_charging)\r\nreg = 0;\r\nret = palmas_update_bits(palmas, PALMAS_PMU_CONTROL_BASE,\r\nPALMAS_BACKUP_BATTERY_CTRL,\r\nPALMAS_BACKUP_BATTERY_CTRL_BBS_BBC_LOW_ICHRG, reg);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"BACKUP_BATTERY_CTRL update failed, %d\n", ret);\r\nreturn ret;\r\n}\r\nret = palmas_update_bits(palmas, PALMAS_PMU_CONTROL_BASE,\r\nPALMAS_BACKUP_BATTERY_CTRL,\r\nPALMAS_BACKUP_BATTERY_CTRL_BB_CHG_EN,\r\nPALMAS_BACKUP_BATTERY_CTRL_BB_CHG_EN);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"BACKUP_BATTERY_CTRL update failed, %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = palmas_update_bits(palmas, PALMAS_RTC_BASE, PALMAS_RTC_CTRL_REG,\r\nPALMAS_RTC_CTRL_REG_STOP_RTC,\r\nPALMAS_RTC_CTRL_REG_STOP_RTC);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "RTC_CTRL write failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\npalmas_rtc->irq = platform_get_irq(pdev, 0);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\npalmas_rtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&palmas_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(palmas_rtc->rtc)) {\r\nret = PTR_ERR(palmas_rtc->rtc);\r\ndev_err(&pdev->dev, "RTC register failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, palmas_rtc->irq, NULL,\r\npalmas_rtc_interrupt,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT |\r\nIRQF_EARLY_RESUME,\r\ndev_name(&pdev->dev), palmas_rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "IRQ request failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int palmas_rtc_remove(struct platform_device *pdev)\r\n{\r\npalmas_rtc_alarm_irq_enable(&pdev->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int palmas_rtc_suspend(struct device *dev)\r\n{\r\nstruct palmas_rtc *palmas_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(palmas_rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int palmas_rtc_resume(struct device *dev)\r\n{\r\nstruct palmas_rtc *palmas_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(palmas_rtc->irq);\r\nreturn 0;\r\n}

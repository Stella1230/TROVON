static int dnfb_blank(int blank, struct fb_info *info)\r\n{\r\nif (blank)\r\nout_8(AP_CONTROL_3A, 0x0);\r\nelse\r\nout_8(AP_CONTROL_3A, 0x1);\r\nreturn 0;\r\n}\r\nstatic\r\nvoid dnfb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nint incr, y_delta, pre_read = 0, x_end, x_word_count;\r\nuint start_mask, end_mask, dest;\r\nushort *src, dummy;\r\nshort i, j;\r\nincr = (area->dy <= area->sy) ? 1 : -1;\r\nsrc = (ushort *)(info->screen_base + area->sy * info->fix.line_length +\r\n(area->sx >> 4));\r\ndest = area->dy * (info->fix.line_length >> 1) + (area->dx >> 4);\r\nif (incr > 0) {\r\ny_delta = (info->fix.line_length * 8) - area->sx - area->width;\r\nx_end = area->dx + area->width - 1;\r\nx_word_count = (x_end >> 4) - (area->dx >> 4) + 1;\r\nstart_mask = 0xffff0000 >> (area->dx & 0xf);\r\nend_mask = 0x7ffff >> (x_end & 0xf);\r\nout_8(AP_CONTROL_0,\r\n(((area->dx & 0xf) - (area->sx & 0xf)) % 16) | (0x4 << 5));\r\nif ((area->dx & 0xf) < (area->sx & 0xf))\r\npre_read = 1;\r\n} else {\r\ny_delta = -((info->fix.line_length * 8) - area->sx - area->width);\r\nx_end = area->dx - area->width + 1;\r\nx_word_count = (area->dx >> 4) - (x_end >> 4) + 1;\r\nstart_mask = 0x7ffff >> (area->dx & 0xf);\r\nend_mask = 0xffff0000 >> (x_end & 0xf);\r\nout_8(AP_CONTROL_0,\r\n((-((area->sx & 0xf) - (area->dx & 0xf))) % 16) |\r\n(0x4 << 5));\r\nif ((area->dx & 0xf) > (area->sx & 0xf))\r\npre_read = 1;\r\n}\r\nfor (i = 0; i < area->height; i++) {\r\nout_8(AP_CONTROL_3A, 0xc | (dest >> 16));\r\nif (pre_read) {\r\ndummy = *src;\r\nsrc += incr;\r\n}\r\nif (x_word_count) {\r\nout_8(AP_WRITE_ENABLE, start_mask);\r\n*src = dest;\r\nsrc += incr;\r\ndest += incr;\r\nout_8(AP_WRITE_ENABLE, 0);\r\nfor (j = 1; j < (x_word_count - 1); j++) {\r\n*src = dest;\r\nsrc += incr;\r\ndest += incr;\r\n}\r\nout_8(AP_WRITE_ENABLE, start_mask);\r\n*src = dest;\r\ndest += incr;\r\nsrc += incr;\r\n} else {\r\nout_8(AP_WRITE_ENABLE, start_mask | end_mask);\r\n*src = dest;\r\ndest += incr;\r\nsrc += incr;\r\n}\r\nsrc += (y_delta / 16);\r\ndest += (y_delta / 16);\r\n}\r\nout_8(AP_CONTROL_0, NORMAL_MODE);\r\n}\r\nstatic int dnfb_probe(struct platform_device *dev)\r\n{\r\nstruct fb_info *info;\r\nint err = 0;\r\ninfo = framebuffer_alloc(0, &dev->dev);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->fbops = &dn_fb_ops;\r\ninfo->fix = dnfb_fix;\r\ninfo->var = dnfb_var;\r\ninfo->var.red.length = 1;\r\ninfo->var.red.offset = 0;\r\ninfo->var.green = info->var.blue = info->var.red;\r\ninfo->screen_base = (u_char *) info->fix.smem_start;\r\nerr = fb_alloc_cmap(&info->cmap, 2, 0);\r\nif (err < 0) {\r\nframebuffer_release(info);\r\nreturn err;\r\n}\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(dev, info);\r\nout_8(AP_CONTROL_3A, RESET_CREG);\r\nout_be16(AP_WRITE_ENABLE, 0x0);\r\nout_8(AP_CONTROL_0, NORMAL_MODE);\r\nout_8(AP_CONTROL_1, (AD_BLT | DST_EQ_SRC | NORM_CREG1));\r\nout_8(AP_CONTROL_2, S_DATA_PLN);\r\nout_be16(AP_ROP_1, SWAP(0x3));\r\nprintk("apollo frame buffer alive and kicking !\n");\r\nreturn err;\r\n}\r\nint __init dnfb_init(void)\r\n{\r\nint ret;\r\nif (!MACH_IS_APOLLO)\r\nreturn -ENODEV;\r\nif (fb_get_options("dnfb", NULL))\r\nreturn -ENODEV;\r\nret = platform_driver_register(&dnfb_driver);\r\nif (!ret) {\r\nret = platform_device_register(&dnfb_device);\r\nif (ret)\r\nplatform_driver_unregister(&dnfb_driver);\r\n}\r\nreturn ret;\r\n}

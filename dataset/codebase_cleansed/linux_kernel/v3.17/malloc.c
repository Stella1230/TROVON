int __init jffs2_create_slab_caches(void)\r\n{\r\nfull_dnode_slab = kmem_cache_create("jffs2_full_dnode",\r\nsizeof(struct jffs2_full_dnode),\r\n0, 0, NULL);\r\nif (!full_dnode_slab)\r\ngoto err;\r\nraw_dirent_slab = kmem_cache_create("jffs2_raw_dirent",\r\nsizeof(struct jffs2_raw_dirent),\r\n0, SLAB_HWCACHE_ALIGN, NULL);\r\nif (!raw_dirent_slab)\r\ngoto err;\r\nraw_inode_slab = kmem_cache_create("jffs2_raw_inode",\r\nsizeof(struct jffs2_raw_inode),\r\n0, SLAB_HWCACHE_ALIGN, NULL);\r\nif (!raw_inode_slab)\r\ngoto err;\r\ntmp_dnode_info_slab = kmem_cache_create("jffs2_tmp_dnode",\r\nsizeof(struct jffs2_tmp_dnode_info),\r\n0, 0, NULL);\r\nif (!tmp_dnode_info_slab)\r\ngoto err;\r\nraw_node_ref_slab = kmem_cache_create("jffs2_refblock",\r\nsizeof(struct jffs2_raw_node_ref) * (REFS_PER_BLOCK + 1),\r\n0, 0, NULL);\r\nif (!raw_node_ref_slab)\r\ngoto err;\r\nnode_frag_slab = kmem_cache_create("jffs2_node_frag",\r\nsizeof(struct jffs2_node_frag),\r\n0, 0, NULL);\r\nif (!node_frag_slab)\r\ngoto err;\r\ninode_cache_slab = kmem_cache_create("jffs2_inode_cache",\r\nsizeof(struct jffs2_inode_cache),\r\n0, 0, NULL);\r\nif (!inode_cache_slab)\r\ngoto err;\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\nxattr_datum_cache = kmem_cache_create("jffs2_xattr_datum",\r\nsizeof(struct jffs2_xattr_datum),\r\n0, 0, NULL);\r\nif (!xattr_datum_cache)\r\ngoto err;\r\nxattr_ref_cache = kmem_cache_create("jffs2_xattr_ref",\r\nsizeof(struct jffs2_xattr_ref),\r\n0, 0, NULL);\r\nif (!xattr_ref_cache)\r\ngoto err;\r\n#endif\r\nreturn 0;\r\nerr:\r\njffs2_destroy_slab_caches();\r\nreturn -ENOMEM;\r\n}\r\nvoid jffs2_destroy_slab_caches(void)\r\n{\r\nif(full_dnode_slab)\r\nkmem_cache_destroy(full_dnode_slab);\r\nif(raw_dirent_slab)\r\nkmem_cache_destroy(raw_dirent_slab);\r\nif(raw_inode_slab)\r\nkmem_cache_destroy(raw_inode_slab);\r\nif(tmp_dnode_info_slab)\r\nkmem_cache_destroy(tmp_dnode_info_slab);\r\nif(raw_node_ref_slab)\r\nkmem_cache_destroy(raw_node_ref_slab);\r\nif(node_frag_slab)\r\nkmem_cache_destroy(node_frag_slab);\r\nif(inode_cache_slab)\r\nkmem_cache_destroy(inode_cache_slab);\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\nif (xattr_datum_cache)\r\nkmem_cache_destroy(xattr_datum_cache);\r\nif (xattr_ref_cache)\r\nkmem_cache_destroy(xattr_ref_cache);\r\n#endif\r\n}\r\nstruct jffs2_full_dirent *jffs2_alloc_full_dirent(int namesize)\r\n{\r\nstruct jffs2_full_dirent *ret;\r\nret = kmalloc(sizeof(struct jffs2_full_dirent) + namesize, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_full_dirent(struct jffs2_full_dirent *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkfree(x);\r\n}\r\nstruct jffs2_full_dnode *jffs2_alloc_full_dnode(void)\r\n{\r\nstruct jffs2_full_dnode *ret;\r\nret = kmem_cache_alloc(full_dnode_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_full_dnode(struct jffs2_full_dnode *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(full_dnode_slab, x);\r\n}\r\nstruct jffs2_raw_dirent *jffs2_alloc_raw_dirent(void)\r\n{\r\nstruct jffs2_raw_dirent *ret;\r\nret = kmem_cache_alloc(raw_dirent_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_raw_dirent(struct jffs2_raw_dirent *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(raw_dirent_slab, x);\r\n}\r\nstruct jffs2_raw_inode *jffs2_alloc_raw_inode(void)\r\n{\r\nstruct jffs2_raw_inode *ret;\r\nret = kmem_cache_alloc(raw_inode_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_raw_inode(struct jffs2_raw_inode *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(raw_inode_slab, x);\r\n}\r\nstruct jffs2_tmp_dnode_info *jffs2_alloc_tmp_dnode_info(void)\r\n{\r\nstruct jffs2_tmp_dnode_info *ret;\r\nret = kmem_cache_alloc(tmp_dnode_info_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n",\r\nret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_tmp_dnode_info(struct jffs2_tmp_dnode_info *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(tmp_dnode_info_slab, x);\r\n}\r\nstatic struct jffs2_raw_node_ref *jffs2_alloc_refblock(void)\r\n{\r\nstruct jffs2_raw_node_ref *ret;\r\nret = kmem_cache_alloc(raw_node_ref_slab, GFP_KERNEL);\r\nif (ret) {\r\nint i = 0;\r\nfor (i=0; i < REFS_PER_BLOCK; i++) {\r\nret[i].flash_offset = REF_EMPTY_NODE;\r\nret[i].next_in_ino = NULL;\r\n}\r\nret[i].flash_offset = REF_LINK_NODE;\r\nret[i].next_in_ino = NULL;\r\n}\r\nreturn ret;\r\n}\r\nint jffs2_prealloc_raw_node_refs(struct jffs2_sb_info *c,\r\nstruct jffs2_eraseblock *jeb, int nr)\r\n{\r\nstruct jffs2_raw_node_ref **p, *ref;\r\nint i = nr;\r\ndbg_memalloc("%d\n", nr);\r\np = &jeb->last_node;\r\nref = *p;\r\ndbg_memalloc("Reserving %d refs for block @0x%08x\n", nr, jeb->offset);\r\nif (ref && ref->flash_offset != REF_EMPTY_NODE)\r\nref++;\r\nwhile (i) {\r\nif (!ref) {\r\ndbg_memalloc("Allocating new refblock linked from %p\n", p);\r\nref = *p = jffs2_alloc_refblock();\r\nif (!ref)\r\nreturn -ENOMEM;\r\n}\r\nif (ref->flash_offset == REF_LINK_NODE) {\r\np = &ref->next_in_ino;\r\nref = *p;\r\ncontinue;\r\n}\r\ni--;\r\nref++;\r\n}\r\njeb->allocated_refs = nr;\r\ndbg_memalloc("Reserved %d refs for block @0x%08x, last_node is %p (%08x,%p)\n",\r\nnr, jeb->offset, jeb->last_node, jeb->last_node->flash_offset,\r\njeb->last_node->next_in_ino);\r\nreturn 0;\r\n}\r\nvoid jffs2_free_refblock(struct jffs2_raw_node_ref *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(raw_node_ref_slab, x);\r\n}\r\nstruct jffs2_node_frag *jffs2_alloc_node_frag(void)\r\n{\r\nstruct jffs2_node_frag *ret;\r\nret = kmem_cache_alloc(node_frag_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_node_frag(struct jffs2_node_frag *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(node_frag_slab, x);\r\n}\r\nstruct jffs2_inode_cache *jffs2_alloc_inode_cache(void)\r\n{\r\nstruct jffs2_inode_cache *ret;\r\nret = kmem_cache_alloc(inode_cache_slab, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ret);\r\nreturn ret;\r\n}\r\nvoid jffs2_free_inode_cache(struct jffs2_inode_cache *x)\r\n{\r\ndbg_memalloc("%p\n", x);\r\nkmem_cache_free(inode_cache_slab, x);\r\n}\r\nstruct jffs2_xattr_datum *jffs2_alloc_xattr_datum(void)\r\n{\r\nstruct jffs2_xattr_datum *xd;\r\nxd = kmem_cache_zalloc(xattr_datum_cache, GFP_KERNEL);\r\ndbg_memalloc("%p\n", xd);\r\nif (!xd)\r\nreturn NULL;\r\nxd->class = RAWNODE_CLASS_XATTR_DATUM;\r\nxd->node = (void *)xd;\r\nINIT_LIST_HEAD(&xd->xindex);\r\nreturn xd;\r\n}\r\nvoid jffs2_free_xattr_datum(struct jffs2_xattr_datum *xd)\r\n{\r\ndbg_memalloc("%p\n", xd);\r\nkmem_cache_free(xattr_datum_cache, xd);\r\n}\r\nstruct jffs2_xattr_ref *jffs2_alloc_xattr_ref(void)\r\n{\r\nstruct jffs2_xattr_ref *ref;\r\nref = kmem_cache_zalloc(xattr_ref_cache, GFP_KERNEL);\r\ndbg_memalloc("%p\n", ref);\r\nif (!ref)\r\nreturn NULL;\r\nref->class = RAWNODE_CLASS_XATTR_REF;\r\nref->node = (void *)ref;\r\nreturn ref;\r\n}\r\nvoid jffs2_free_xattr_ref(struct jffs2_xattr_ref *ref)\r\n{\r\ndbg_memalloc("%p\n", ref);\r\nkmem_cache_free(xattr_ref_cache, ref);\r\n}

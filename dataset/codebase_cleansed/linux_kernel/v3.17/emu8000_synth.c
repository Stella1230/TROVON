static int snd_emu8000_new_device(struct snd_seq_device *dev)\r\n{\r\nstruct snd_emu8000 *hw;\r\nstruct snd_emux *emu;\r\nhw = *(struct snd_emu8000**)SNDRV_SEQ_DEVICE_ARGPTR(dev);\r\nif (hw == NULL)\r\nreturn -EINVAL;\r\nif (hw->emu)\r\nreturn -EBUSY;\r\nif (snd_emux_new(&emu) < 0)\r\nreturn -ENOMEM;\r\nhw->emu = emu;\r\nsnd_emu8000_ops_setup(hw);\r\nemu->hw = hw;\r\nemu->max_voices = EMU8000_DRAM_VOICES;\r\nemu->num_ports = hw->seq_ports;\r\nif (hw->memhdr) {\r\nsnd_printk(KERN_ERR "memhdr is already initialized!?\n");\r\nsnd_util_memhdr_free(hw->memhdr);\r\n}\r\nhw->memhdr = snd_util_memhdr_new(hw->mem_size);\r\nif (hw->memhdr == NULL) {\r\nsnd_emux_free(emu);\r\nhw->emu = NULL;\r\nreturn -ENOMEM;\r\n}\r\nemu->memhdr = hw->memhdr;\r\nemu->midi_ports = hw->seq_ports < 2 ? hw->seq_ports : 2;\r\nemu->midi_devidx = 1;\r\nemu->linear_panning = 1;\r\nemu->hwdep_idx = 2;\r\nif (snd_emux_register(emu, dev->card, hw->index, "Emu8000") < 0) {\r\nsnd_emux_free(emu);\r\nsnd_util_memhdr_free(hw->memhdr);\r\nhw->emu = NULL;\r\nhw->memhdr = NULL;\r\nreturn -ENOMEM;\r\n}\r\nif (hw->mem_size > 0)\r\nsnd_emu8000_pcm_new(dev->card, hw, 1);\r\ndev->driver_data = hw;\r\nreturn 0;\r\n}\r\nstatic int snd_emu8000_delete_device(struct snd_seq_device *dev)\r\n{\r\nstruct snd_emu8000 *hw;\r\nif (dev->driver_data == NULL)\r\nreturn 0;\r\nhw = dev->driver_data;\r\nif (hw->pcm)\r\nsnd_device_free(dev->card, hw->pcm);\r\nif (hw->emu)\r\nsnd_emux_free(hw->emu);\r\nif (hw->memhdr)\r\nsnd_util_memhdr_free(hw->memhdr);\r\nhw->emu = NULL;\r\nhw->memhdr = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init alsa_emu8000_init(void)\r\n{\r\nstatic struct snd_seq_dev_ops ops = {\r\nsnd_emu8000_new_device,\r\nsnd_emu8000_delete_device,\r\n};\r\nreturn snd_seq_device_register_driver(SNDRV_SEQ_DEV_ID_EMU8000, &ops,\r\nsizeof(struct snd_emu8000*));\r\n}\r\nstatic void __exit alsa_emu8000_exit(void)\r\n{\r\nsnd_seq_device_unregister_driver(SNDRV_SEQ_DEV_ID_EMU8000);\r\n}

static inline u32 vsp1_lut_read(struct vsp1_lut *lut, u32 reg)\r\n{\r\nreturn vsp1_read(lut->entity.vsp1, reg);\r\n}\r\nstatic inline void vsp1_lut_write(struct vsp1_lut *lut, u32 reg, u32 data)\r\n{\r\nvsp1_write(lut->entity.vsp1, reg, data);\r\n}\r\nstatic void lut_configure(struct vsp1_lut *lut, struct vsp1_lut_config *config)\r\n{\r\nmemcpy_toio(lut->entity.vsp1->mmio + VI6_LUT_TABLE, config->lut,\r\nsizeof(config->lut));\r\n}\r\nstatic long lut_ioctl(struct v4l2_subdev *subdev, unsigned int cmd, void *arg)\r\n{\r\nstruct vsp1_lut *lut = to_lut(subdev);\r\nswitch (cmd) {\r\ncase VIDIOC_VSP1_LUT_CONFIG:\r\nlut_configure(lut, arg);\r\nreturn 0;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic int lut_s_stream(struct v4l2_subdev *subdev, int enable)\r\n{\r\nstruct vsp1_lut *lut = to_lut(subdev);\r\nif (!enable)\r\nreturn 0;\r\nvsp1_lut_write(lut, VI6_LUT_CTRL, VI6_LUT_CTRL_EN);\r\nreturn 0;\r\n}\r\nstatic int lut_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nV4L2_MBUS_FMT_ARGB8888_1X32,\r\nV4L2_MBUS_FMT_AHSV8888_1X32,\r\nV4L2_MBUS_FMT_AYUV8_1X32,\r\n};\r\nstruct v4l2_mbus_framefmt *format;\r\nif (code->pad == LUT_PAD_SINK) {\r\nif (code->index >= ARRAY_SIZE(codes))\r\nreturn -EINVAL;\r\ncode->code = codes[code->index];\r\n} else {\r\nif (code->index)\r\nreturn -EINVAL;\r\nformat = v4l2_subdev_get_try_format(fh, LUT_PAD_SINK);\r\ncode->code = format->code;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lut_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = v4l2_subdev_get_try_format(fh, fse->pad);\r\nif (fse->index || fse->code != format->code)\r\nreturn -EINVAL;\r\nif (fse->pad == LUT_PAD_SINK) {\r\nfse->min_width = LUT_MIN_SIZE;\r\nfse->max_width = LUT_MAX_SIZE;\r\nfse->min_height = LUT_MIN_SIZE;\r\nfse->max_height = LUT_MAX_SIZE;\r\n} else {\r\nfse->min_width = format->width;\r\nfse->max_width = format->width;\r\nfse->min_height = format->height;\r\nfse->max_height = format->height;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lut_get_format(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lut *lut = to_lut(subdev);\r\nfmt->format = *vsp1_entity_get_pad_format(&lut->entity, fh, fmt->pad,\r\nfmt->which);\r\nreturn 0;\r\n}\r\nstatic int lut_set_format(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lut *lut = to_lut(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nif (fmt->format.code != V4L2_MBUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != V4L2_MBUS_FMT_AHSV8888_1X32 &&\r\nfmt->format.code != V4L2_MBUS_FMT_AYUV8_1X32)\r\nfmt->format.code = V4L2_MBUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&lut->entity, fh, fmt->pad,\r\nfmt->which);\r\nif (fmt->pad == LUT_PAD_SOURCE) {\r\nfmt->format = *format;\r\nreturn 0;\r\n}\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nLUT_MIN_SIZE, LUT_MAX_SIZE);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nLUT_MIN_SIZE, LUT_MAX_SIZE);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\nformat = vsp1_entity_get_pad_format(&lut->entity, fh, LUT_PAD_SOURCE,\r\nfmt->which);\r\n*format = fmt->format;\r\nreturn 0;\r\n}\r\nstruct vsp1_lut *vsp1_lut_create(struct vsp1_device *vsp1)\r\n{\r\nstruct v4l2_subdev *subdev;\r\nstruct vsp1_lut *lut;\r\nint ret;\r\nlut = devm_kzalloc(vsp1->dev, sizeof(*lut), GFP_KERNEL);\r\nif (lut == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nlut->entity.type = VSP1_ENTITY_LUT;\r\nret = vsp1_entity_init(vsp1, &lut->entity, 2);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsubdev = &lut->entity.subdev;\r\nv4l2_subdev_init(subdev, &lut_ops);\r\nsubdev->entity.ops = &vsp1_media_ops;\r\nsubdev->internal_ops = &vsp1_subdev_internal_ops;\r\nsnprintf(subdev->name, sizeof(subdev->name), "%s lut",\r\ndev_name(vsp1->dev));\r\nv4l2_set_subdevdata(subdev, lut);\r\nsubdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nvsp1_entity_init_formats(subdev, NULL);\r\nreturn lut;\r\n}

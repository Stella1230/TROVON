MPI mpi_alloc(unsigned nlimbs)\r\n{\r\nMPI a;\r\na = kmalloc(sizeof *a, GFP_KERNEL);\r\nif (!a)\r\nreturn a;\r\nif (nlimbs) {\r\na->d = mpi_alloc_limb_space(nlimbs);\r\nif (!a->d) {\r\nkfree(a);\r\nreturn NULL;\r\n}\r\n} else {\r\na->d = NULL;\r\n}\r\na->alloced = nlimbs;\r\na->nlimbs = 0;\r\na->sign = 0;\r\na->flags = 0;\r\na->nbits = 0;\r\nreturn a;\r\n}\r\nmpi_ptr_t mpi_alloc_limb_space(unsigned nlimbs)\r\n{\r\nsize_t len = nlimbs * sizeof(mpi_limb_t);\r\nif (!len)\r\nreturn NULL;\r\nreturn kmalloc(len, GFP_KERNEL);\r\n}\r\nvoid mpi_free_limb_space(mpi_ptr_t a)\r\n{\r\nif (!a)\r\nreturn;\r\nkfree(a);\r\n}\r\nvoid mpi_assign_limb_space(MPI a, mpi_ptr_t ap, unsigned nlimbs)\r\n{\r\nmpi_free_limb_space(a->d);\r\na->d = ap;\r\na->alloced = nlimbs;\r\n}\r\nint mpi_resize(MPI a, unsigned nlimbs)\r\n{\r\nvoid *p;\r\nif (nlimbs <= a->alloced)\r\nreturn 0;\r\nif (a->d) {\r\np = kmalloc(nlimbs * sizeof(mpi_limb_t), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\nmemcpy(p, a->d, a->alloced * sizeof(mpi_limb_t));\r\nkfree(a->d);\r\na->d = p;\r\n} else {\r\na->d = kzalloc(nlimbs * sizeof(mpi_limb_t), GFP_KERNEL);\r\nif (!a->d)\r\nreturn -ENOMEM;\r\n}\r\na->alloced = nlimbs;\r\nreturn 0;\r\n}\r\nvoid mpi_free(MPI a)\r\n{\r\nif (!a)\r\nreturn;\r\nif (a->flags & 4)\r\nkfree(a->d);\r\nelse\r\nmpi_free_limb_space(a->d);\r\nif (a->flags & ~7)\r\npr_info("invalid flag value in mpi\n");\r\nkfree(a);\r\n}

static void mce_set_error_info(struct machine_check_event *mce,\r\nstruct mce_error_info *mce_err)\r\n{\r\nmce->error_type = mce_err->error_type;\r\nswitch (mce_err->error_type) {\r\ncase MCE_ERROR_TYPE_UE:\r\nmce->u.ue_error.ue_error_type = mce_err->u.ue_error_type;\r\nbreak;\r\ncase MCE_ERROR_TYPE_SLB:\r\nmce->u.slb_error.slb_error_type = mce_err->u.slb_error_type;\r\nbreak;\r\ncase MCE_ERROR_TYPE_ERAT:\r\nmce->u.erat_error.erat_error_type = mce_err->u.erat_error_type;\r\nbreak;\r\ncase MCE_ERROR_TYPE_TLB:\r\nmce->u.tlb_error.tlb_error_type = mce_err->u.tlb_error_type;\r\nbreak;\r\ncase MCE_ERROR_TYPE_UNKNOWN:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid save_mce_event(struct pt_regs *regs, long handled,\r\nstruct mce_error_info *mce_err,\r\nuint64_t nip, uint64_t addr)\r\n{\r\nuint64_t srr1;\r\nint index = __get_cpu_var(mce_nest_count)++;\r\nstruct machine_check_event *mce = &__get_cpu_var(mce_event[index]);\r\nif (index >= MAX_MC_EVT)\r\nreturn;\r\nmce->version = MCE_V1;\r\nmce->srr0 = nip;\r\nmce->srr1 = regs->msr;\r\nmce->gpr3 = regs->gpr[3];\r\nmce->in_use = 1;\r\nmce->initiator = MCE_INITIATOR_CPU;\r\nif (handled)\r\nmce->disposition = MCE_DISPOSITION_RECOVERED;\r\nelse\r\nmce->disposition = MCE_DISPOSITION_NOT_RECOVERED;\r\nmce->severity = MCE_SEV_ERROR_SYNC;\r\nsrr1 = regs->msr;\r\nmce_set_error_info(mce, mce_err);\r\nif (!addr)\r\nreturn;\r\nif (mce->error_type == MCE_ERROR_TYPE_TLB) {\r\nmce->u.tlb_error.effective_address_provided = true;\r\nmce->u.tlb_error.effective_address = addr;\r\n} else if (mce->error_type == MCE_ERROR_TYPE_SLB) {\r\nmce->u.slb_error.effective_address_provided = true;\r\nmce->u.slb_error.effective_address = addr;\r\n} else if (mce->error_type == MCE_ERROR_TYPE_ERAT) {\r\nmce->u.erat_error.effective_address_provided = true;\r\nmce->u.erat_error.effective_address = addr;\r\n} else if (mce->error_type == MCE_ERROR_TYPE_UE) {\r\nmce->u.ue_error.effective_address_provided = true;\r\nmce->u.ue_error.effective_address = addr;\r\n}\r\nreturn;\r\n}\r\nint get_mce_event(struct machine_check_event *mce, bool release)\r\n{\r\nint index = __get_cpu_var(mce_nest_count) - 1;\r\nstruct machine_check_event *mc_evt;\r\nint ret = 0;\r\nif (index < 0)\r\nreturn ret;\r\nif (index < MAX_MC_EVT) {\r\nmc_evt = &__get_cpu_var(mce_event[index]);\r\nif (mce)\r\n*mce = *mc_evt;\r\nif (release)\r\nmc_evt->in_use = 0;\r\nret = 1;\r\n}\r\nif (release)\r\n__get_cpu_var(mce_nest_count)--;\r\nreturn ret;\r\n}\r\nvoid release_mce_event(void)\r\n{\r\nget_mce_event(NULL, true);\r\n}\r\nvoid machine_check_queue_event(void)\r\n{\r\nint index;\r\nstruct machine_check_event evt;\r\nif (!get_mce_event(&evt, MCE_EVENT_RELEASE))\r\nreturn;\r\nindex = __get_cpu_var(mce_queue_count)++;\r\nif (index >= MAX_MC_EVT) {\r\n__get_cpu_var(mce_queue_count)--;\r\nreturn;\r\n}\r\n__get_cpu_var(mce_event_queue[index]) = evt;\r\nirq_work_queue(&mce_event_process_work);\r\n}\r\nstatic void machine_check_process_queued_event(struct irq_work *work)\r\n{\r\nint index;\r\nwhile (__get_cpu_var(mce_queue_count) > 0) {\r\nindex = __get_cpu_var(mce_queue_count) - 1;\r\nmachine_check_print_event_info(\r\n&__get_cpu_var(mce_event_queue[index]));\r\n__get_cpu_var(mce_queue_count)--;\r\n}\r\n}\r\nvoid machine_check_print_event_info(struct machine_check_event *evt)\r\n{\r\nconst char *level, *sevstr, *subtype;\r\nstatic const char *mc_ue_types[] = {\r\n"Indeterminate",\r\n"Instruction fetch",\r\n"Page table walk ifetch",\r\n"Load/Store",\r\n"Page table walk Load/Store",\r\n};\r\nstatic const char *mc_slb_types[] = {\r\n"Indeterminate",\r\n"Parity",\r\n"Multihit",\r\n};\r\nstatic const char *mc_erat_types[] = {\r\n"Indeterminate",\r\n"Parity",\r\n"Multihit",\r\n};\r\nstatic const char *mc_tlb_types[] = {\r\n"Indeterminate",\r\n"Parity",\r\n"Multihit",\r\n};\r\nif (evt->version != MCE_V1) {\r\npr_err("Machine Check Exception, Unknown event version %d !\n",\r\nevt->version);\r\nreturn;\r\n}\r\nswitch (evt->severity) {\r\ncase MCE_SEV_NO_ERROR:\r\nlevel = KERN_INFO;\r\nsevstr = "Harmless";\r\nbreak;\r\ncase MCE_SEV_WARNING:\r\nlevel = KERN_WARNING;\r\nsevstr = "";\r\nbreak;\r\ncase MCE_SEV_ERROR_SYNC:\r\nlevel = KERN_ERR;\r\nsevstr = "Severe";\r\nbreak;\r\ncase MCE_SEV_FATAL:\r\ndefault:\r\nlevel = KERN_ERR;\r\nsevstr = "Fatal";\r\nbreak;\r\n}\r\nprintk("%s%s Machine check interrupt [%s]\n", level, sevstr,\r\nevt->disposition == MCE_DISPOSITION_RECOVERED ?\r\n"Recovered" : "[Not recovered");\r\nprintk("%s Initiator: %s\n", level,\r\nevt->initiator == MCE_INITIATOR_CPU ? "CPU" : "Unknown");\r\nswitch (evt->error_type) {\r\ncase MCE_ERROR_TYPE_UE:\r\nsubtype = evt->u.ue_error.ue_error_type <\r\nARRAY_SIZE(mc_ue_types) ?\r\nmc_ue_types[evt->u.ue_error.ue_error_type]\r\n: "Unknown";\r\nprintk("%s Error type: UE [%s]\n", level, subtype);\r\nif (evt->u.ue_error.effective_address_provided)\r\nprintk("%s Effective address: %016llx\n",\r\nlevel, evt->u.ue_error.effective_address);\r\nif (evt->u.ue_error.physical_address_provided)\r\nprintk("%s Physial address: %016llx\n",\r\nlevel, evt->u.ue_error.physical_address);\r\nbreak;\r\ncase MCE_ERROR_TYPE_SLB:\r\nsubtype = evt->u.slb_error.slb_error_type <\r\nARRAY_SIZE(mc_slb_types) ?\r\nmc_slb_types[evt->u.slb_error.slb_error_type]\r\n: "Unknown";\r\nprintk("%s Error type: SLB [%s]\n", level, subtype);\r\nif (evt->u.slb_error.effective_address_provided)\r\nprintk("%s Effective address: %016llx\n",\r\nlevel, evt->u.slb_error.effective_address);\r\nbreak;\r\ncase MCE_ERROR_TYPE_ERAT:\r\nsubtype = evt->u.erat_error.erat_error_type <\r\nARRAY_SIZE(mc_erat_types) ?\r\nmc_erat_types[evt->u.erat_error.erat_error_type]\r\n: "Unknown";\r\nprintk("%s Error type: ERAT [%s]\n", level, subtype);\r\nif (evt->u.erat_error.effective_address_provided)\r\nprintk("%s Effective address: %016llx\n",\r\nlevel, evt->u.erat_error.effective_address);\r\nbreak;\r\ncase MCE_ERROR_TYPE_TLB:\r\nsubtype = evt->u.tlb_error.tlb_error_type <\r\nARRAY_SIZE(mc_tlb_types) ?\r\nmc_tlb_types[evt->u.tlb_error.tlb_error_type]\r\n: "Unknown";\r\nprintk("%s Error type: TLB [%s]\n", level, subtype);\r\nif (evt->u.tlb_error.effective_address_provided)\r\nprintk("%s Effective address: %016llx\n",\r\nlevel, evt->u.tlb_error.effective_address);\r\nbreak;\r\ndefault:\r\ncase MCE_ERROR_TYPE_UNKNOWN:\r\nprintk("%s Error type: Unknown\n", level);\r\nbreak;\r\n}\r\n}\r\nuint64_t get_mce_fault_addr(struct machine_check_event *evt)\r\n{\r\nswitch (evt->error_type) {\r\ncase MCE_ERROR_TYPE_UE:\r\nif (evt->u.ue_error.effective_address_provided)\r\nreturn evt->u.ue_error.effective_address;\r\nbreak;\r\ncase MCE_ERROR_TYPE_SLB:\r\nif (evt->u.slb_error.effective_address_provided)\r\nreturn evt->u.slb_error.effective_address;\r\nbreak;\r\ncase MCE_ERROR_TYPE_ERAT:\r\nif (evt->u.erat_error.effective_address_provided)\r\nreturn evt->u.erat_error.effective_address;\r\nbreak;\r\ncase MCE_ERROR_TYPE_TLB:\r\nif (evt->u.tlb_error.effective_address_provided)\r\nreturn evt->u.tlb_error.effective_address;\r\nbreak;\r\ndefault:\r\ncase MCE_ERROR_TYPE_UNKNOWN:\r\nbreak;\r\n}\r\nreturn 0;\r\n}

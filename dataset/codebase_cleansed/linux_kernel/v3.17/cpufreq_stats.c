static int cpufreq_stats_update(unsigned int cpu)\r\n{\r\nstruct cpufreq_stats *stat;\r\nunsigned long long cur_time;\r\ncur_time = get_jiffies_64();\r\nspin_lock(&cpufreq_stats_lock);\r\nstat = per_cpu(cpufreq_stats_table, cpu);\r\nif (stat->time_in_state)\r\nstat->time_in_state[stat->last_index] +=\r\ncur_time - stat->last_time;\r\nstat->last_time = cur_time;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t show_total_trans(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\nreturn sprintf(buf, "%d\n",\r\nper_cpu(cpufreq_stats_table, stat->cpu)->total_trans);\r\n}\r\nstatic ssize_t show_time_in_state(struct cpufreq_policy *policy, char *buf)\r\n{\r\nssize_t len = 0;\r\nint i;\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\ncpufreq_stats_update(stat->cpu);\r\nfor (i = 0; i < stat->state_num; i++) {\r\nlen += sprintf(buf + len, "%u %llu\n", stat->freq_table[i],\r\n(unsigned long long)\r\njiffies_64_to_clock_t(stat->time_in_state[i]));\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t show_trans_table(struct cpufreq_policy *policy, char *buf)\r\n{\r\nssize_t len = 0;\r\nint i, j;\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\ncpufreq_stats_update(stat->cpu);\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " From : To\n");\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " : ");\r\nfor (i = 0; i < stat->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstat->freq_table[i]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\nfor (i = 0; i < stat->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u: ",\r\nstat->freq_table[i]);\r\nfor (j = 0; j < stat->state_num; j++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstat->trans_table[i*stat->max_state+j]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nreturn len;\r\n}\r\nstatic int freq_table_get_index(struct cpufreq_stats *stat, unsigned int freq)\r\n{\r\nint index;\r\nfor (index = 0; index < stat->max_state; index++)\r\nif (stat->freq_table[index] == freq)\r\nreturn index;\r\nreturn -1;\r\n}\r\nstatic void __cpufreq_stats_free_table(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn;\r\npr_debug("%s: Free stat table\n", __func__);\r\nsysfs_remove_group(&policy->kobj, &stats_attr_group);\r\nkfree(stat->time_in_state);\r\nkfree(stat);\r\nper_cpu(cpufreq_stats_table, policy->cpu) = NULL;\r\n}\r\nstatic void cpufreq_stats_free_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy;\r\npolicy = cpufreq_cpu_get(cpu);\r\nif (!policy)\r\nreturn;\r\nif (cpufreq_frequency_get_table(policy->cpu))\r\n__cpufreq_stats_free_table(policy);\r\ncpufreq_cpu_put(policy);\r\n}\r\nstatic int __cpufreq_stats_create_table(struct cpufreq_policy *policy)\r\n{\r\nunsigned int i, count = 0, ret = 0;\r\nstruct cpufreq_stats *stat;\r\nunsigned int alloc_size;\r\nunsigned int cpu = policy->cpu;\r\nstruct cpufreq_frequency_table *pos, *table;\r\ntable = cpufreq_frequency_get_table(cpu);\r\nif (unlikely(!table))\r\nreturn 0;\r\nif (per_cpu(cpufreq_stats_table, cpu))\r\nreturn -EBUSY;\r\nstat = kzalloc(sizeof(*stat), GFP_KERNEL);\r\nif ((stat) == NULL)\r\nreturn -ENOMEM;\r\nret = sysfs_create_group(&policy->kobj, &stats_attr_group);\r\nif (ret)\r\ngoto error_out;\r\nstat->cpu = cpu;\r\nper_cpu(cpufreq_stats_table, cpu) = stat;\r\ncpufreq_for_each_valid_entry(pos, table)\r\ncount++;\r\nalloc_size = count * sizeof(int) + count * sizeof(u64);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nalloc_size += count * count * sizeof(int);\r\n#endif\r\nstat->max_state = count;\r\nstat->time_in_state = kzalloc(alloc_size, GFP_KERNEL);\r\nif (!stat->time_in_state) {\r\nret = -ENOMEM;\r\ngoto error_alloc;\r\n}\r\nstat->freq_table = (unsigned int *)(stat->time_in_state + count);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstat->trans_table = stat->freq_table + count;\r\n#endif\r\ni = 0;\r\ncpufreq_for_each_valid_entry(pos, table)\r\nif (freq_table_get_index(stat, pos->frequency) == -1)\r\nstat->freq_table[i++] = pos->frequency;\r\nstat->state_num = i;\r\nspin_lock(&cpufreq_stats_lock);\r\nstat->last_time = get_jiffies_64();\r\nstat->last_index = freq_table_get_index(stat, policy->cur);\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\nerror_alloc:\r\nsysfs_remove_group(&policy->kobj, &stats_attr_group);\r\nerror_out:\r\nkfree(stat);\r\nper_cpu(cpufreq_stats_table, cpu) = NULL;\r\nreturn ret;\r\n}\r\nstatic void cpufreq_stats_create_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy;\r\npolicy = cpufreq_cpu_get(cpu);\r\nif (likely(!policy))\r\nreturn;\r\n__cpufreq_stats_create_table(policy);\r\ncpufreq_cpu_put(policy);\r\n}\r\nstatic void cpufreq_stats_update_policy_cpu(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table,\r\npolicy->last_cpu);\r\npr_debug("Updating stats_table for new_cpu %u from last_cpu %u\n",\r\npolicy->cpu, policy->last_cpu);\r\nper_cpu(cpufreq_stats_table, policy->cpu) = per_cpu(cpufreq_stats_table,\r\npolicy->last_cpu);\r\nper_cpu(cpufreq_stats_table, policy->last_cpu) = NULL;\r\nstat->cpu = policy->cpu;\r\n}\r\nstatic int cpufreq_stat_notifier_policy(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nint ret = 0;\r\nstruct cpufreq_policy *policy = data;\r\nif (val == CPUFREQ_UPDATE_POLICY_CPU) {\r\ncpufreq_stats_update_policy_cpu(policy);\r\nreturn 0;\r\n}\r\nif (val == CPUFREQ_CREATE_POLICY)\r\nret = __cpufreq_stats_create_table(policy);\r\nelse if (val == CPUFREQ_REMOVE_POLICY)\r\n__cpufreq_stats_free_table(policy);\r\nreturn ret;\r\n}\r\nstatic int cpufreq_stat_notifier_trans(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nstruct cpufreq_freqs *freq = data;\r\nstruct cpufreq_stats *stat;\r\nint old_index, new_index;\r\nif (val != CPUFREQ_POSTCHANGE)\r\nreturn 0;\r\nstat = per_cpu(cpufreq_stats_table, freq->cpu);\r\nif (!stat)\r\nreturn 0;\r\nold_index = stat->last_index;\r\nnew_index = freq_table_get_index(stat, freq->new);\r\nif (old_index == -1 || new_index == -1)\r\nreturn 0;\r\ncpufreq_stats_update(freq->cpu);\r\nif (old_index == new_index)\r\nreturn 0;\r\nspin_lock(&cpufreq_stats_lock);\r\nstat->last_index = new_index;\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstat->trans_table[old_index * stat->max_state + new_index]++;\r\n#endif\r\nstat->total_trans++;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic int __init cpufreq_stats_init(void)\r\n{\r\nint ret;\r\nunsigned int cpu;\r\nspin_lock_init(&cpufreq_stats_lock);\r\nret = cpufreq_register_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nif (ret)\r\nreturn ret;\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_create_table(cpu);\r\nret = cpufreq_register_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nif (ret) {\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_free_table(cpu);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cpufreq_stats_exit(void)\r\n{\r\nunsigned int cpu;\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\ncpufreq_unregister_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_free_table(cpu);\r\n}

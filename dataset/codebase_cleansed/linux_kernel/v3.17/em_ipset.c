static int em_ipset_change(struct tcf_proto *tp, void *data, int data_len,\r\nstruct tcf_ematch *em)\r\n{\r\nstruct xt_set_info *set = data;\r\nip_set_id_t index;\r\nstruct net *net = dev_net(qdisc_dev(tp->q));\r\nif (data_len != sizeof(*set))\r\nreturn -EINVAL;\r\nindex = ip_set_nfnl_get_byindex(net, set->index);\r\nif (index == IPSET_INVALID_ID)\r\nreturn -ENOENT;\r\nem->datalen = sizeof(*set);\r\nem->data = (unsigned long)kmemdup(data, em->datalen, GFP_KERNEL);\r\nif (em->data)\r\nreturn 0;\r\nip_set_nfnl_put(net, index);\r\nreturn -ENOMEM;\r\n}\r\nstatic void em_ipset_destroy(struct tcf_proto *p, struct tcf_ematch *em)\r\n{\r\nconst struct xt_set_info *set = (const void *) em->data;\r\nif (set) {\r\nip_set_nfnl_put(dev_net(qdisc_dev(p->q)), set->index);\r\nkfree((void *) em->data);\r\n}\r\n}\r\nstatic int em_ipset_match(struct sk_buff *skb, struct tcf_ematch *em,\r\nstruct tcf_pkt_info *info)\r\n{\r\nstruct ip_set_adt_opt opt;\r\nstruct xt_action_param acpar;\r\nconst struct xt_set_info *set = (const void *) em->data;\r\nstruct net_device *dev, *indev = NULL;\r\nint ret, network_offset;\r\nswitch (skb->protocol) {\r\ncase htons(ETH_P_IP):\r\nacpar.family = NFPROTO_IPV4;\r\nif (!pskb_network_may_pull(skb, sizeof(struct iphdr)))\r\nreturn 0;\r\nacpar.thoff = ip_hdrlen(skb);\r\nbreak;\r\ncase htons(ETH_P_IPV6):\r\nacpar.family = NFPROTO_IPV6;\r\nif (!pskb_network_may_pull(skb, sizeof(struct ipv6hdr)))\r\nreturn 0;\r\nacpar.thoff = sizeof(struct ipv6hdr);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nacpar.hooknum = 0;\r\nopt.family = acpar.family;\r\nopt.dim = set->dim;\r\nopt.flags = set->flags;\r\nopt.cmdflags = 0;\r\nopt.ext.timeout = ~0u;\r\nnetwork_offset = skb_network_offset(skb);\r\nskb_pull(skb, network_offset);\r\ndev = skb->dev;\r\nrcu_read_lock();\r\nif (dev && skb->skb_iif)\r\nindev = dev_get_by_index_rcu(dev_net(dev), skb->skb_iif);\r\nacpar.in = indev ? indev : dev;\r\nacpar.out = dev;\r\nret = ip_set_test(set->index, skb, &acpar, &opt);\r\nrcu_read_unlock();\r\nskb_push(skb, network_offset);\r\nreturn ret;\r\n}\r\nstatic int __init init_em_ipset(void)\r\n{\r\nreturn tcf_em_register(&em_ipset_ops);\r\n}\r\nstatic void __exit exit_em_ipset(void)\r\n{\r\ntcf_em_unregister(&em_ipset_ops);\r\n}

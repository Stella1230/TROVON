static int vmic_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nint retval;\r\nu32 data;\r\nretval = pci_enable_device(pdev);\r\nif (retval) {\r\ndev_err(&pdev->dev, "Unable to enable device\n");\r\ngoto err;\r\n}\r\nretval = pci_request_regions(pdev, driver_name);\r\nif (retval) {\r\ndev_err(&pdev->dev, "Unable to reserve resources\n");\r\ngoto err_resource;\r\n}\r\nvmic_base = ioremap_nocache(pci_resource_start(pdev, 0), 16);\r\nif (!vmic_base) {\r\ndev_err(&pdev->dev, "Unable to remap CRG region\n");\r\nretval = -EIO;\r\ngoto err_remap;\r\n}\r\niowrite32(0, vmic_base + VME_CONTROL);\r\ndata = ioread32(vmic_base + VME_CONTROL) & 0x00000FFF;\r\ndata |= BM_VME_CONTROL_BERRST;\r\niowrite32(data, vmic_base + VME_CONTROL);\r\ndata = ioread32(vmic_base + VME_CONTROL) & 0x00000FFF;\r\ndata = data | BM_VME_CONTROL_MASTER_ENDIAN |\r\nBM_VME_CONTROL_SLAVE_ENDIAN |\r\nBM_VME_CONTROL_ABLE |\r\nBM_VME_CONTROL_BERRI |\r\nBM_VME_CONTROL_BPENA |\r\nBM_VME_CONTROL_VBENA;\r\niowrite32(data, vmic_base + VME_CONTROL);\r\nreturn 0;\r\nerr_remap:\r\npci_release_regions(pdev);\r\nerr_resource:\r\npci_disable_device(pdev);\r\nerr:\r\nreturn retval;\r\n}\r\nstatic void vmic_remove(struct pci_dev *pdev)\r\n{\r\niounmap(vmic_base);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}

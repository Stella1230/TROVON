void iwl_mvm_set_wowlan_qos_seq(struct iwl_mvm_sta *mvm_ap_sta,\r\nstruct iwl_wowlan_config_cmd_v2 *cmd)\r\n{\r\nint i;\r\nfor (i = 0; i < IWL_MAX_TID_COUNT; i++) {\r\nu16 seq = mvm_ap_sta->tid_data[i].seq_number;\r\nseq -= 0x10;\r\ncmd->qos_seq[i] = cpu_to_le16(seq);\r\n}\r\n}\r\nint iwl_mvm_send_proto_offload(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nbool disable_offloading,\r\nu32 cmd_flags)\r\n{\r\nunion {\r\nstruct iwl_proto_offload_cmd_v1 v1;\r\nstruct iwl_proto_offload_cmd_v2 v2;\r\nstruct iwl_proto_offload_cmd_v3_small v3s;\r\nstruct iwl_proto_offload_cmd_v3_large v3l;\r\n} cmd = {};\r\nstruct iwl_host_cmd hcmd = {\r\n.id = PROT_OFFLOAD_CONFIG_CMD,\r\n.flags = cmd_flags,\r\n.data[0] = &cmd,\r\n.dataflags[0] = IWL_HCMD_DFL_DUP,\r\n};\r\nstruct iwl_proto_offload_cmd_common *common;\r\nu32 enabled = 0, size;\r\nu32 capa_flags = mvm->fw->ucode_capa.flags;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nint i;\r\nif (capa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL ||\r\ncapa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_LARGE) {\r\nstruct iwl_ns_config *nsc;\r\nstruct iwl_targ_addr *addrs;\r\nint n_nsc, n_addrs;\r\nint c;\r\nif (capa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL) {\r\nnsc = cmd.v3s.ns_config;\r\nn_nsc = IWL_PROTO_OFFLOAD_NUM_NS_CONFIG_V3S;\r\naddrs = cmd.v3s.targ_addrs;\r\nn_addrs = IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V3S;\r\n} else {\r\nnsc = cmd.v3l.ns_config;\r\nn_nsc = IWL_PROTO_OFFLOAD_NUM_NS_CONFIG_V3L;\r\naddrs = cmd.v3l.targ_addrs;\r\nn_addrs = IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V3L;\r\n}\r\nif (mvmvif->num_target_ipv6_addrs)\r\nenabled |= IWL_D3_PROTO_OFFLOAD_NS;\r\nfor (i = 0, c = 0;\r\ni < mvmvif->num_target_ipv6_addrs &&\r\ni < n_addrs && c < n_nsc; i++) {\r\nstruct in6_addr solicited_addr;\r\nint j;\r\naddrconf_addr_solict_mult(&mvmvif->target_ipv6_addrs[i],\r\n&solicited_addr);\r\nfor (j = 0; j < c; j++)\r\nif (ipv6_addr_cmp(&nsc[j].dest_ipv6_addr,\r\n&solicited_addr) == 0)\r\nbreak;\r\nif (j == c)\r\nc++;\r\naddrs[i].addr = mvmvif->target_ipv6_addrs[i];\r\naddrs[i].config_num = cpu_to_le32(j);\r\nnsc[j].dest_ipv6_addr = solicited_addr;\r\nmemcpy(nsc[j].target_mac_addr, vif->addr, ETH_ALEN);\r\n}\r\nif (capa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL)\r\ncmd.v3s.num_valid_ipv6_addrs = cpu_to_le32(i);\r\nelse\r\ncmd.v3l.num_valid_ipv6_addrs = cpu_to_le32(i);\r\n} else if (capa_flags & IWL_UCODE_TLV_FLAGS_D3_6_IPV6_ADDRS) {\r\nif (mvmvif->num_target_ipv6_addrs) {\r\nenabled |= IWL_D3_PROTO_OFFLOAD_NS;\r\nmemcpy(cmd.v2.ndp_mac_addr, vif->addr, ETH_ALEN);\r\n}\r\nBUILD_BUG_ON(sizeof(cmd.v2.target_ipv6_addr[0]) !=\r\nsizeof(mvmvif->target_ipv6_addrs[0]));\r\nfor (i = 0; i < min(mvmvif->num_target_ipv6_addrs,\r\nIWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V2); i++)\r\nmemcpy(cmd.v2.target_ipv6_addr[i],\r\n&mvmvif->target_ipv6_addrs[i],\r\nsizeof(cmd.v2.target_ipv6_addr[i]));\r\n} else {\r\nif (mvmvif->num_target_ipv6_addrs) {\r\nenabled |= IWL_D3_PROTO_OFFLOAD_NS;\r\nmemcpy(cmd.v1.ndp_mac_addr, vif->addr, ETH_ALEN);\r\n}\r\nBUILD_BUG_ON(sizeof(cmd.v1.target_ipv6_addr[0]) !=\r\nsizeof(mvmvif->target_ipv6_addrs[0]));\r\nfor (i = 0; i < min(mvmvif->num_target_ipv6_addrs,\r\nIWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V1); i++)\r\nmemcpy(cmd.v1.target_ipv6_addr[i],\r\n&mvmvif->target_ipv6_addrs[i],\r\nsizeof(cmd.v1.target_ipv6_addr[i]));\r\n}\r\n#endif\r\nif (capa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL) {\r\ncommon = &cmd.v3s.common;\r\nsize = sizeof(cmd.v3s);\r\n} else if (capa_flags & IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_LARGE) {\r\ncommon = &cmd.v3l.common;\r\nsize = sizeof(cmd.v3l);\r\n} else if (capa_flags & IWL_UCODE_TLV_FLAGS_D3_6_IPV6_ADDRS) {\r\ncommon = &cmd.v2.common;\r\nsize = sizeof(cmd.v2);\r\n} else {\r\ncommon = &cmd.v1.common;\r\nsize = sizeof(cmd.v1);\r\n}\r\nif (vif->bss_conf.arp_addr_cnt) {\r\nenabled |= IWL_D3_PROTO_OFFLOAD_ARP;\r\ncommon->host_ipv4_addr = vif->bss_conf.arp_addr_list[0];\r\nmemcpy(common->arp_mac_addr, vif->addr, ETH_ALEN);\r\n}\r\nif (!disable_offloading)\r\ncommon->enabled = cpu_to_le32(enabled);\r\nhcmd.len[0] = size;\r\nreturn iwl_mvm_send_cmd(mvm, &hcmd);\r\n}

void __init tx3927_wdt_init(void)\r\n{\r\ntxx9_wdt_init(TX3927_TMR_REG(2));\r\n}\r\nvoid __init tx3927_setup(void)\r\n{\r\nint i;\r\nunsigned int conf;\r\ntxx9_reg_res_init(TX3927_REV_PCODE(), TX3927_REG_BASE,\r\nTX3927_REG_SIZE);\r\nfor (i = 0; i < 8; i++) {\r\nif (!(tx3927_romcptr->cr[i] & 0x8))\r\ncontinue;\r\ntxx9_ce_res[i].start = (unsigned long)TX3927_ROMC_BA(i);\r\ntxx9_ce_res[i].end =\r\ntxx9_ce_res[i].start + TX3927_ROMC_SIZE(i) - 1;\r\nrequest_resource(&iomem_resource, &txx9_ce_res[i]);\r\n}\r\ntxx9_gbus_clock = txx9_cpu_clock / 2;\r\nloops_per_jiffy = txx9_cpu_clock / HZ / 2;\r\nif (txx9_ccfg_toeon)\r\ntx3927_ccfgptr->ccfg |= TX3927_CCFG_TOE;\r\ntx3927_ccfgptr->ccfg &= ~TX3927_CCFG_BEOW;\r\nif (read_c0_conf() & TX39_CONF_WBON)\r\ntx3927_ccfgptr->ccfg &= ~TX3927_CCFG_PSNP;\r\nelse\r\ntx3927_ccfgptr->ccfg |= TX3927_CCFG_PSNP;\r\ntx3927_ccfgptr->ccfg |= TX3927_CCFG_WR;\r\nprintk(KERN_INFO "TX3927 -- CRIR:%08lx CCFG:%08lx PCFG:%08lx\n",\r\ntx3927_ccfgptr->crir,\r\ntx3927_ccfgptr->ccfg, tx3927_ccfgptr->pcfg);\r\nfor (i = 0; i < TX3927_NR_TMR; i++)\r\ntxx9_tmr_init(TX3927_TMR_REG(i));\r\ntx3927_dmaptr->mcr = 0;\r\nfor (i = 0; i < ARRAY_SIZE(tx3927_dmaptr->ch); i++) {\r\ntx3927_dmaptr->ch[i].ccr = TX3927_DMA_CCR_CHRST;\r\ntx3927_dmaptr->ch[i].ccr = 0;\r\n}\r\n#ifdef __BIG_ENDIAN\r\ntx3927_dmaptr->mcr = TX3927_DMA_MCR_MSTEN;\r\n#else\r\ntx3927_dmaptr->mcr = TX3927_DMA_MCR_MSTEN | TX3927_DMA_MCR_LE;\r\n#endif\r\n__raw_writel(0, &tx3927_pioptr->maskcpu);\r\n__raw_writel(0, &tx3927_pioptr->maskext);\r\ntxx9_gpio_init(TX3927_PIO_REG, 0, 16);\r\nconf = read_c0_conf();\r\nif (conf & TX39_CONF_DCE) {\r\nif (!(conf & TX39_CONF_WBON))\r\npr_info("TX3927 D-Cache WriteThrough.\n");\r\nelse if (!(conf & TX39_CONF_CWFON))\r\npr_info("TX3927 D-Cache WriteBack.\n");\r\nelse\r\npr_info("TX3927 D-Cache WriteBack (CWF) .\n");\r\n}\r\n}\r\nvoid __init tx3927_time_init(unsigned int evt_tmrnr, unsigned int src_tmrnr)\r\n{\r\ntxx9_clockevent_init(TX3927_TMR_REG(evt_tmrnr),\r\nTXX9_IRQ_BASE + TX3927_IR_TMR(evt_tmrnr),\r\nTXX9_IMCLK);\r\ntxx9_clocksource_init(TX3927_TMR_REG(src_tmrnr), TXX9_IMCLK);\r\n}\r\nvoid __init tx3927_sio_init(unsigned int sclk, unsigned int cts_mask)\r\n{\r\nint i;\r\nfor (i = 0; i < 2; i++)\r\ntxx9_sio_init(TX3927_SIO_REG(i),\r\nTXX9_IRQ_BASE + TX3927_IR_SIO(i),\r\ni, sclk, (1 << i) & cts_mask);\r\n}\r\nvoid __init tx3927_mtd_init(int ch)\r\n{\r\nstruct physmap_flash_data pdata = {\r\n.width = TX3927_ROMC_WIDTH(ch) / 8,\r\n};\r\nunsigned long start = txx9_ce_res[ch].start;\r\nunsigned long size = txx9_ce_res[ch].end - start + 1;\r\nif (!(tx3927_romcptr->cr[ch] & 0x8))\r\nreturn;\r\ntxx9_physmap_flash_init(ch, start, size, &pdata);\r\n}

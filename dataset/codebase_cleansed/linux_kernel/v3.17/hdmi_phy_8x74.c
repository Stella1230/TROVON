static void phy_write(struct hdmi_phy_8x74 *phy, u32 reg, u32 data)\r\n{\r\nmsm_writel(data, phy->mmio + reg);\r\n}\r\nstatic void hdmi_phy_8x74_destroy(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8x74 *phy_8x74 = to_hdmi_phy_8x74(phy);\r\nkfree(phy_8x74);\r\n}\r\nstatic void hdmi_phy_8x74_reset(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8x74 *phy_8x74 = to_hdmi_phy_8x74(phy);\r\nstruct hdmi *hdmi = phy_8x74->hdmi;\r\nunsigned int val;\r\nval = hdmi_read(hdmi, REG_HDMI_PHY_CTRL);\r\nif (val & HDMI_PHY_CTRL_SW_RESET_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET);\r\n}\r\nif (val & HDMI_PHY_CTRL_SW_RESET_PLL_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET_PLL);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET_PLL);\r\n}\r\nmsleep(100);\r\nif (val & HDMI_PHY_CTRL_SW_RESET_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET);\r\n}\r\nif (val & HDMI_PHY_CTRL_SW_RESET_PLL_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET_PLL);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET_PLL);\r\n}\r\n}\r\nstatic void hdmi_phy_8x74_powerup(struct hdmi_phy *phy,\r\nunsigned long int pixclock)\r\n{\r\nstruct hdmi_phy_8x74 *phy_8x74 = to_hdmi_phy_8x74(phy);\r\nphy_write(phy_8x74, REG_HDMI_8x74_ANA_CFG0, 0x1b);\r\nphy_write(phy_8x74, REG_HDMI_8x74_ANA_CFG1, 0xf2);\r\nphy_write(phy_8x74, REG_HDMI_8x74_BIST_CFG0, 0x0);\r\nphy_write(phy_8x74, REG_HDMI_8x74_BIST_PATN0, 0x0);\r\nphy_write(phy_8x74, REG_HDMI_8x74_BIST_PATN1, 0x0);\r\nphy_write(phy_8x74, REG_HDMI_8x74_BIST_PATN2, 0x0);\r\nphy_write(phy_8x74, REG_HDMI_8x74_BIST_PATN3, 0x0);\r\nphy_write(phy_8x74, REG_HDMI_8x74_PD_CTRL1, 0x20);\r\n}\r\nstatic void hdmi_phy_8x74_powerdown(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8x74 *phy_8x74 = to_hdmi_phy_8x74(phy);\r\nphy_write(phy_8x74, REG_HDMI_8x74_PD_CTRL0, 0x7f);\r\n}\r\nstruct hdmi_phy *hdmi_phy_8x74_init(struct hdmi *hdmi)\r\n{\r\nstruct hdmi_phy_8x74 *phy_8x74;\r\nstruct hdmi_phy *phy = NULL;\r\nint ret;\r\nphy_8x74 = kzalloc(sizeof(*phy_8x74), GFP_KERNEL);\r\nif (!phy_8x74) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nphy = &phy_8x74->base;\r\nphy->funcs = &hdmi_phy_8x74_funcs;\r\nphy_8x74->hdmi = hdmi;\r\nphy_8x74->mmio = msm_ioremap(hdmi->pdev,\r\n"phy_physical", "HDMI_8x74");\r\nif (IS_ERR(phy_8x74->mmio)) {\r\nret = PTR_ERR(phy_8x74->mmio);\r\ngoto fail;\r\n}\r\nreturn phy;\r\nfail:\r\nif (phy)\r\nhdmi_phy_8x74_destroy(phy);\r\nreturn ERR_PTR(ret);\r\n}

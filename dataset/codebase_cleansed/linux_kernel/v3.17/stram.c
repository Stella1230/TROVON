static int __init atari_stram_setup(char *arg)\r\n{\r\nif (!MACH_IS_ATARI)\r\nreturn 0;\r\npool_size = memparse(arg, NULL);\r\nreturn 0;\r\n}\r\nvoid __init atari_stram_init(void)\r\n{\r\nint i;\r\nkernel_in_stram = (m68k_memory[0].addr == 0);\r\nfor (i = 0; i < m68k_num_memory; ++i) {\r\nif (m68k_memory[i].addr == 0) {\r\nreturn;\r\n}\r\n}\r\npanic("atari_stram_init: no ST-RAM found!");\r\n}\r\nvoid __init atari_stram_reserve_pages(void *start_mem)\r\n{\r\nif (kernel_in_stram) {\r\npr_debug("atari_stram pool: kernel in ST-RAM, using alloc_bootmem!\n");\r\nstram_pool.start = (resource_size_t)alloc_bootmem_low_pages(pool_size);\r\nstram_pool.end = stram_pool.start + pool_size - 1;\r\nrequest_resource(&iomem_resource, &stram_pool);\r\nstram_virt_offset = 0;\r\npr_debug("atari_stram pool: size = %lu bytes, resource = %pR\n",\r\npool_size, &stram_pool);\r\npr_debug("atari_stram pool: stram_virt_offset = %lx\n",\r\nstram_virt_offset);\r\n}\r\n}\r\nint __init atari_stram_map_pages(void)\r\n{\r\nif (!kernel_in_stram) {\r\npr_debug("atari_stram pool: kernel not in ST-RAM, using ioremap!\n");\r\nstram_pool.start = PAGE_SIZE;\r\nstram_pool.end = stram_pool.start + pool_size - 1;\r\nrequest_resource(&iomem_resource, &stram_pool);\r\nstram_virt_offset = (unsigned long) ioremap(stram_pool.start,\r\nresource_size(&stram_pool)) - stram_pool.start;\r\npr_debug("atari_stram pool: size = %lu bytes, resource = %pR\n",\r\npool_size, &stram_pool);\r\npr_debug("atari_stram pool: stram_virt_offset = %lx\n",\r\nstram_virt_offset);\r\n}\r\nreturn 0;\r\n}\r\nvoid *atari_stram_to_virt(unsigned long phys)\r\n{\r\nreturn (void *)(phys + stram_virt_offset);\r\n}\r\nunsigned long atari_stram_to_phys(void *virt)\r\n{\r\nreturn (unsigned long)(virt - stram_virt_offset);\r\n}\r\nvoid *atari_stram_alloc(unsigned long size, const char *owner)\r\n{\r\nstruct resource *res;\r\nint error;\r\npr_debug("atari_stram_alloc: allocate %lu bytes\n", size);\r\nsize = PAGE_ALIGN(size);\r\nres = kzalloc(sizeof(struct resource), GFP_KERNEL);\r\nif (!res)\r\nreturn NULL;\r\nres->name = owner;\r\nerror = allocate_resource(&stram_pool, res, size, 0, UINT_MAX,\r\nPAGE_SIZE, NULL, NULL);\r\nif (error < 0) {\r\npr_err("atari_stram_alloc: allocate_resource() failed %d!\n",\r\nerror);\r\nkfree(res);\r\nreturn NULL;\r\n}\r\npr_debug("atari_stram_alloc: returning %pR\n", res);\r\nreturn atari_stram_to_virt(res->start);\r\n}\r\nvoid atari_stram_free(void *addr)\r\n{\r\nunsigned long start = atari_stram_to_phys(addr);\r\nstruct resource *res;\r\nunsigned long size;\r\nres = lookup_resource(&stram_pool, start);\r\nif (!res) {\r\npr_err("atari_stram_free: trying to free nonexistent region "\r\n"at %p\n", addr);\r\nreturn;\r\n}\r\nsize = resource_size(res);\r\npr_debug("atari_stram_free: free %lu bytes at %p\n", size, addr);\r\nrelease_resource(res);\r\nkfree(res);\r\n}

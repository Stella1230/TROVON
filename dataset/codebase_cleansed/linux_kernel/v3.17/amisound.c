void __init amiga_init_sound(void)\r\n{\r\nstatic struct resource beep_res = { .name = "Beep" };\r\nsnd_data = amiga_chip_alloc_res(sizeof(sine_data), &beep_res);\r\nif (!snd_data) {\r\npr_crit("amiga init_sound: failed to allocate chipmem\n");\r\nreturn;\r\n}\r\nmemcpy (snd_data, sine_data, sizeof(sine_data));\r\nclock_constant = (amiga_colorclock+DATA_SIZE/2)/DATA_SIZE;\r\n#ifndef CONFIG_FB_AMIGA\r\namifb_video_off();\r\n#endif\r\n}\r\nvoid amiga_mksound( unsigned int hz, unsigned int ticks )\r\n{\r\nunsigned long flags;\r\nif (!snd_data)\r\nreturn;\r\nlocal_irq_save(flags);\r\ndel_timer( &sound_timer );\r\nif (hz > 20 && hz < 32767) {\r\nunsigned long period = (clock_constant / hz);\r\nif (period < amiga_audio_min_period)\r\nperiod = amiga_audio_min_period;\r\nif (period > MAX_PERIOD)\r\nperiod = MAX_PERIOD;\r\ncustom.aud[2].audlc = snd_data;\r\ncustom.aud[2].audlen = sizeof(sine_data)/2;\r\ncustom.aud[2].audper = (unsigned short)period;\r\ncustom.aud[2].audvol = 32;\r\nif (ticks) {\r\nsound_timer.expires = jiffies + ticks;\r\nadd_timer( &sound_timer );\r\n}\r\ncustom.dmacon = DMAF_SETCLR | DMAF_AUD2;\r\n} else\r\nnosound( 0 );\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void nosound( unsigned long ignored )\r\n{\r\ncustom.dmacon = DMAF_AUD2;\r\ncustom.aud[2].audper = amiga_audio_period;\r\n}

static int at91sam9g20ek_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int at91sam9g20ek_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstatic int mclk_on;\r\nint ret = 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (!mclk_on)\r\nret = clk_enable(mclk);\r\nif (ret == 0)\r\nmclk_on = 1;\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (mclk_on)\r\nclk_disable(mclk);\r\nmclk_on = 0;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int at91sam9g20ek_wm8731_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint ret;\r\nprintk(KERN_DEBUG\r\n"at91sam9g20ek_wm8731 "\r\n": at91sam9g20ek_wm8731_init() called\n");\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,\r\nMCLK_RATE, SND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Failed to set WM8731 SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nsnd_soc_dapm_nc_pin(dapm, "RLINEIN");\r\nsnd_soc_dapm_nc_pin(dapm, "LLINEIN");\r\n#ifndef ENABLE_MIC_INPUT\r\nsnd_soc_dapm_nc_pin(&rtd->card->dapm, "Int Mic");\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int at91sam9g20ek_audio_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *codec_np, *cpu_np;\r\nstruct clk *pllb;\r\nstruct snd_soc_card *card = &snd_soc_at91sam9g20ek;\r\nint ret;\r\nif (!np) {\r\nif (!(machine_is_at91sam9g20ek() ||\r\nmachine_is_at91sam9g20ek_2mmc()))\r\nreturn -ENODEV;\r\n}\r\nret = atmel_ssc_set_audio(0);\r\nif (ret) {\r\ndev_err(&pdev->dev, "ssc channel is not valid\n");\r\nreturn -EINVAL;\r\n}\r\nmclk = clk_get(NULL, "pck0");\r\nif (IS_ERR(mclk)) {\r\nprintk(KERN_ERR "ASoC: Failed to get MCLK\n");\r\nret = PTR_ERR(mclk);\r\ngoto err;\r\n}\r\npllb = clk_get(NULL, "pllb");\r\nif (IS_ERR(pllb)) {\r\nprintk(KERN_ERR "ASoC: Failed to get PLLB\n");\r\nret = PTR_ERR(pllb);\r\ngoto err_mclk;\r\n}\r\nret = clk_set_parent(mclk, pllb);\r\nclk_put(pllb);\r\nif (ret != 0) {\r\nprintk(KERN_ERR "ASoC: Failed to set MCLK parent\n");\r\ngoto err_mclk;\r\n}\r\nclk_set_rate(mclk, MCLK_RATE);\r\ncard->dev = &pdev->dev;\r\nif (np) {\r\nret = snd_soc_of_parse_card_name(card, "atmel,model");\r\nif (ret)\r\ngoto err;\r\nret = snd_soc_of_parse_audio_routing(card,\r\n"atmel,audio-routing");\r\nif (ret)\r\ngoto err;\r\nat91sam9g20ek_dai.codec_name = NULL;\r\ncodec_np = of_parse_phandle(np, "atmel,audio-codec", 0);\r\nif (!codec_np) {\r\ndev_err(&pdev->dev, "codec info missing\n");\r\nreturn -EINVAL;\r\n}\r\nat91sam9g20ek_dai.codec_of_node = codec_np;\r\nat91sam9g20ek_dai.cpu_dai_name = NULL;\r\nat91sam9g20ek_dai.platform_name = NULL;\r\ncpu_np = of_parse_phandle(np, "atmel,ssc-controller", 0);\r\nif (!cpu_np) {\r\ndev_err(&pdev->dev, "dai and pcm info missing\n");\r\nreturn -EINVAL;\r\n}\r\nat91sam9g20ek_dai.cpu_of_node = cpu_np;\r\nat91sam9g20ek_dai.platform_of_node = cpu_np;\r\nof_node_put(codec_np);\r\nof_node_put(cpu_np);\r\n}\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\nprintk(KERN_ERR "ASoC: snd_soc_register_card() failed\n");\r\n}\r\nreturn ret;\r\nerr_mclk:\r\nclk_put(mclk);\r\nmclk = NULL;\r\nerr:\r\natmel_ssc_put_audio(0);\r\nreturn ret;\r\n}\r\nstatic int at91sam9g20ek_audio_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nclk_disable(mclk);\r\nmclk = NULL;\r\nsnd_soc_unregister_card(card);\r\natmel_ssc_put_audio(0);\r\nreturn 0;\r\n}

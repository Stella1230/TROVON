static const char *get_allreg_name(int grp, int reg)\r\n{\r\nreturn greg_names[(grp << 3) | reg];\r\n}\r\nstatic bool fix_up_reg(struct pt_regs *fp, long *value, int grp, int reg)\r\n{\r\nlong *val = &fp->r0;\r\nunsigned long tmp;\r\nif (grp == 5 ||\r\n(grp == 4 && (reg == 4 || reg == 5)) ||\r\n(grp == 7))\r\nreturn false;\r\nif (grp == 0 || (grp == 1 && reg < 6))\r\nval -= (reg + 8 * grp);\r\nelse if (grp == 1 && reg == 6)\r\nval = &fp->usp;\r\nelse if (grp == 1 && reg == 7)\r\nval = &fp->fp;\r\nelse if (grp == 2) {\r\nval = &fp->i0;\r\nval -= reg;\r\n} else if (grp == 3 && reg >= 4) {\r\nval = &fp->l0;\r\nval -= (reg - 4);\r\n} else if (grp == 3 && reg < 4) {\r\nval = &fp->b0;\r\nval -= reg;\r\n} else if (grp == 4 && reg < 4) {\r\nval = &fp->a0x;\r\nval -= reg;\r\n} else if (grp == 4 && reg == 6)\r\nval = &fp->astat;\r\nelse if (grp == 4 && reg == 7)\r\nval = &fp->rets;\r\nelse if (grp == 6 && reg < 6) {\r\nval = &fp->lc0;\r\nval -= reg;\r\n} else if (grp == 6 && reg == 6) {\r\n__asm__ __volatile__("%0 = cycles;\n" : "=d"(tmp));\r\nval = &tmp;\r\n} else if (grp == 6 && reg == 7) {\r\n__asm__ __volatile__("%0 = cycles2;\n" : "=d"(tmp));\r\nval = &tmp;\r\n}\r\n*value = *val;\r\nreturn true;\r\n}\r\nbool execute_pseudodbg_assert(struct pt_regs *fp, unsigned int opcode)\r\n{\r\nint expected = ((opcode >> PseudoDbg_Assert_expected_bits) & PseudoDbg_Assert_expected_mask);\r\nint dbgop = ((opcode >> (PseudoDbg_Assert_dbgop_bits)) & PseudoDbg_Assert_dbgop_mask);\r\nint grp = ((opcode >> (PseudoDbg_Assert_grp_bits)) & PseudoDbg_Assert_grp_mask);\r\nint regtest = ((opcode >> (PseudoDbg_Assert_regtest_bits)) & PseudoDbg_Assert_regtest_mask);\r\nlong value;\r\nif ((opcode & 0xFF000000) != PseudoDbg_Assert_opcode)\r\nreturn false;\r\nif (!fix_up_reg(fp, &value, grp, regtest))\r\nreturn false;\r\nif (dbgop == 0 || dbgop == 2) {\r\nif (expected != (value & 0xFFFF)) {\r\npr_notice("DBGA (%s.L,0x%x) failure, got 0x%x\n",\r\nget_allreg_name(grp, regtest),\r\nexpected, (unsigned int)(value & 0xFFFF));\r\nreturn false;\r\n}\r\n} else if (dbgop == 1 || dbgop == 3) {\r\nif (expected != ((value >> 16) & 0xFFFF)) {\r\npr_notice("DBGA (%s.H,0x%x) failure, got 0x%x\n",\r\nget_allreg_name(grp, regtest),\r\nexpected, (unsigned int)((value >> 16) & 0xFFFF));\r\nreturn false;\r\n}\r\n}\r\nfp->pc += 4;\r\nreturn true;\r\n}\r\nbool execute_pseudodbg(struct pt_regs *fp, unsigned int opcode)\r\n{\r\nint grp, fn, reg;\r\nlong value, value1;\r\nif ((opcode & 0xFF000000) != PseudoDbg_opcode)\r\nreturn false;\r\nopcode >>= 16;\r\ngrp = ((opcode >> PseudoDbg_grp_bits) & PseudoDbg_reg_mask);\r\nfn = ((opcode >> PseudoDbg_fn_bits) & PseudoDbg_fn_mask);\r\nreg = ((opcode >> PseudoDbg_reg_bits) & PseudoDbg_reg_mask);\r\nif (fn == 3 && (reg == 0 || reg == 1)) {\r\nif (!fix_up_reg(fp, &value, 4, 2 * reg))\r\nreturn false;\r\nif (!fix_up_reg(fp, &value1, 4, 2 * reg + 1))\r\nreturn false;\r\npr_notice("DBG A%i = %02lx%08lx\n", reg, value & 0xFF, value1);\r\nfp->pc += 2;\r\nreturn true;\r\n} else if (fn == 0) {\r\nif (!fix_up_reg(fp, &value, grp, reg))\r\nreturn false;\r\npr_notice("DBG %s = %08lx\n", get_allreg_name(grp, reg), value);\r\nfp->pc += 2;\r\nreturn true;\r\n}\r\nreturn false;\r\n}

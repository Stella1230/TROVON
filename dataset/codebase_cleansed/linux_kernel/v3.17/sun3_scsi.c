static inline unsigned char sun3scsi_read(int reg)\r\n{\r\nreturn( sun3_scsi_regp[reg] );\r\n}\r\nstatic inline void sun3scsi_write(int reg, int value)\r\n{\r\nsun3_scsi_regp[reg] = value;\r\n}\r\nstatic inline unsigned short sun3_udc_read(unsigned char reg)\r\n{\r\nunsigned short ret;\r\ndregs->udc_addr = UDC_CSR;\r\nudelay(SUN3_DMA_DELAY);\r\nret = dregs->udc_data;\r\nudelay(SUN3_DMA_DELAY);\r\nreturn ret;\r\n}\r\nstatic inline void sun3_udc_write(unsigned short val, unsigned char reg)\r\n{\r\ndregs->udc_addr = reg;\r\nudelay(SUN3_DMA_DELAY);\r\ndregs->udc_data = val;\r\nudelay(SUN3_DMA_DELAY);\r\n}\r\nstatic int __init sun3scsi_detect(struct scsi_host_template *tpnt)\r\n{\r\nunsigned long ioaddr, irq;\r\nstatic int called = 0;\r\nstruct Scsi_Host *instance;\r\n#ifdef SUN3_SCSI_VME\r\nint i;\r\nunsigned long addrs[3] = { IOBASE_SUN3_VMESCSI,\r\nIOBASE_SUN3_VMESCSI + 0x4000,\r\n0 };\r\nunsigned long vecs[3] = { SUN3_VEC_VMESCSI0,\r\nSUN3_VEC_VMESCSI1,\r\n0 };\r\n#endif\r\nswitch(idprom->id_machtype) {\r\n#ifdef SUN3_SCSI_VME\r\ncase SM_SUN3|SM_3_160:\r\ncase SM_SUN3|SM_3_260:\r\nbreak;\r\n#else\r\ncase SM_SUN3|SM_3_50:\r\ncase SM_SUN3|SM_3_60:\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn 0;\r\n}\r\nif(called)\r\nreturn 0;\r\n#ifdef SUN3_SCSI_VME\r\ntpnt->proc_name = "Sun3 5380 VME SCSI";\r\n#else\r\ntpnt->proc_name = "Sun3 5380 SCSI";\r\n#endif\r\ntpnt->can_queue =\r\n(setup_can_queue > 0) ? setup_can_queue : CAN_QUEUE;\r\ntpnt->cmd_per_lun =\r\n(setup_cmd_per_lun > 0) ? setup_cmd_per_lun : CMD_PER_LUN;\r\ntpnt->sg_tablesize =\r\n(setup_sg_tablesize >= 0) ? setup_sg_tablesize : SG_TABLESIZE;\r\nif (setup_hostid >= 0)\r\ntpnt->this_id = setup_hostid;\r\nelse {\r\ntpnt->this_id = 7;\r\n}\r\n#ifdef SUN3_SCSI_VME\r\nioaddr = 0;\r\nfor (i = 0; addrs[i] != 0; i++) {\r\nunsigned char x;\r\nioaddr = (unsigned long)sun3_ioremap(addrs[i], PAGE_SIZE,\r\nSUN3_PAGE_TYPE_VME16);\r\nirq = vecs[i];\r\nsun3_scsi_regp = (unsigned char *)ioaddr;\r\ndregs = (struct sun3_dma_regs *)(((unsigned char *)ioaddr) + 8);\r\nif (sun3_map_test((unsigned long)dregs, &x)) {\r\nunsigned short oldcsr;\r\noldcsr = dregs->csr;\r\ndregs->csr = 0;\r\nudelay(SUN3_DMA_DELAY);\r\nif (dregs->csr == 0x1400)\r\nbreak;\r\ndregs->csr = oldcsr;\r\n}\r\niounmap((void *)ioaddr);\r\nioaddr = 0;\r\n}\r\nif (!ioaddr)\r\nreturn 0;\r\n#else\r\nirq = IRQ_SUN3_SCSI;\r\nioaddr = (unsigned long)ioremap(IOBASE_SUN3_SCSI, PAGE_SIZE);\r\nsun3_scsi_regp = (unsigned char *)ioaddr;\r\ndregs = (struct sun3_dma_regs *)(((unsigned char *)ioaddr) + 8);\r\nif((udc_regs = dvma_malloc(sizeof(struct sun3_udc_regs)))\r\n== NULL) {\r\nprintk("SUN3 Scsi couldn't allocate DVMA memory!\n");\r\nreturn 0;\r\n}\r\n#endif\r\n#ifdef SUPPORT_TAGS\r\nif (setup_use_tagged_queuing < 0)\r\nsetup_use_tagged_queuing = USE_TAGGED_QUEUING;\r\n#endif\r\ninstance = scsi_register (tpnt, sizeof(struct NCR5380_hostdata));\r\nif(instance == NULL)\r\nreturn 0;\r\ndefault_instance = instance;\r\ninstance->io_port = (unsigned long) ioaddr;\r\ninstance->irq = irq;\r\nNCR5380_init(instance, 0);\r\ninstance->n_io_port = 32;\r\n((struct NCR5380_hostdata *)instance->hostdata)->ctrl = 0;\r\nif (request_irq(instance->irq, scsi_sun3_intr,\r\n0, "Sun3SCSI-5380", instance)) {\r\n#ifndef REAL_DMA\r\nprintk("scsi%d: IRQ%d not free, interrupts disabled\n",\r\ninstance->host_no, instance->irq);\r\ninstance->irq = SCSI_IRQ_NONE;\r\n#else\r\nprintk("scsi%d: IRQ%d not free, bailing out\n",\r\ninstance->host_no, instance->irq);\r\nreturn 0;\r\n#endif\r\n}\r\npr_info("scsi%d: %s at port %lX irq", instance->host_no,\r\ntpnt->proc_name, instance->io_port);\r\nif (instance->irq == SCSI_IRQ_NONE)\r\nprintk ("s disabled");\r\nelse\r\nprintk (" %d", instance->irq);\r\nprintk(" options CAN_QUEUE=%d CMD_PER_LUN=%d release=%d",\r\ninstance->can_queue, instance->cmd_per_lun,\r\nSUN3SCSI_PUBLIC_RELEASE);\r\nprintk("\nscsi%d:", instance->host_no);\r\nNCR5380_print_options(instance);\r\nprintk("\n");\r\ndregs->csr = 0;\r\nudelay(SUN3_DMA_DELAY);\r\ndregs->csr = CSR_SCSI | CSR_FIFO | CSR_INTR;\r\nudelay(SUN3_DMA_DELAY);\r\ndregs->fifo_count = 0;\r\n#ifdef SUN3_SCSI_VME\r\ndregs->fifo_count_hi = 0;\r\ndregs->dma_addr_hi = 0;\r\ndregs->dma_addr_lo = 0;\r\ndregs->dma_count_hi = 0;\r\ndregs->dma_count_lo = 0;\r\ndregs->ivect = VME_DATA24 | (instance->irq & 0xff);\r\n#endif\r\ncalled = 1;\r\n#ifdef RESET_BOOT\r\nsun3_scsi_reset_boot(instance);\r\n#endif\r\nreturn 1;\r\n}\r\nint sun3scsi_release (struct Scsi_Host *shpnt)\r\n{\r\nif (shpnt->irq != SCSI_IRQ_NONE)\r\nfree_irq(shpnt->irq, shpnt);\r\niounmap((void *)sun3_scsi_regp);\r\nNCR5380_exit(shpnt);\r\nreturn 0;\r\n}\r\nstatic void sun3_scsi_reset_boot(struct Scsi_Host *instance)\r\n{\r\nunsigned long end;\r\nNCR5380_local_declare();\r\nNCR5380_setup(instance);\r\nprintk( "Sun3 SCSI: resetting the SCSI bus..." );\r\nNCR5380_write( TARGET_COMMAND_REG,\r\nPHASE_SR_TO_TCR( NCR5380_read(STATUS_REG) ));\r\nNCR5380_write( INITIATOR_COMMAND_REG, ICR_BASE | ICR_ASSERT_RST );\r\nudelay( 50 );\r\nNCR5380_write( INITIATOR_COMMAND_REG, ICR_BASE );\r\nNCR5380_read( RESET_PARITY_INTERRUPT_REG );\r\nfor( end = jiffies + AFTER_RESET_DELAY; time_before(jiffies, end); )\r\nbarrier();\r\nprintk( " done\n" );\r\n}\r\nstatic const char *sun3scsi_info(struct Scsi_Host *spnt)\r\n{\r\nreturn "";\r\n}\r\nstatic irqreturn_t scsi_sun3_intr(int irq, void *dummy)\r\n{\r\nunsigned short csr = dregs->csr;\r\nint handled = 0;\r\n#ifdef SUN3_SCSI_VME\r\ndregs->csr &= ~CSR_DMA_ENABLE;\r\n#endif\r\nif(csr & ~CSR_GOOD) {\r\nif(csr & CSR_DMA_BUSERR) {\r\nprintk("scsi%d: bus error in dma\n", default_instance->host_no);\r\n}\r\nif(csr & CSR_DMA_CONFLICT) {\r\nprintk("scsi%d: dma conflict\n", default_instance->host_no);\r\n}\r\nhandled = 1;\r\n}\r\nif(csr & (CSR_SDB_INT | CSR_DMA_INT)) {\r\nNCR5380_intr(irq, dummy);\r\nhandled = 1;\r\n}\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic unsigned long sun3scsi_dma_setup(void *data, unsigned long count, int write_flag)\r\n{\r\nvoid *addr;\r\nif(sun3_dma_orig_addr != NULL)\r\ndvma_unmap(sun3_dma_orig_addr);\r\n#ifdef SUN3_SCSI_VME\r\naddr = (void *)dvma_map_vme((unsigned long) data, count);\r\n#else\r\naddr = (void *)dvma_map((unsigned long) data, count);\r\n#endif\r\nsun3_dma_orig_addr = addr;\r\nsun3_dma_orig_count = count;\r\n#ifndef SUN3_SCSI_VME\r\ndregs->fifo_count = 0;\r\nsun3_udc_write(UDC_RESET, UDC_CSR);\r\ndregs->csr &= ~CSR_FIFO;\r\ndregs->csr |= CSR_FIFO;\r\n#endif\r\nif(write_flag)\r\ndregs->csr |= CSR_SEND;\r\nelse\r\ndregs->csr &= ~CSR_SEND;\r\n#ifdef SUN3_SCSI_VME\r\ndregs->csr |= CSR_PACK_ENABLE;\r\ndregs->dma_addr_hi = ((unsigned long)addr >> 16);\r\ndregs->dma_addr_lo = ((unsigned long)addr & 0xffff);\r\ndregs->dma_count_hi = 0;\r\ndregs->dma_count_lo = 0;\r\ndregs->fifo_count_hi = 0;\r\ndregs->fifo_count = 0;\r\n#else\r\ndregs->fifo_count = count;\r\nsun3_udc_write(UDC_RESET, UDC_CSR);\r\ndregs->csr &= ~CSR_FIFO;\r\ndregs->csr |= CSR_FIFO;\r\nif(dregs->fifo_count != count) {\r\nprintk("scsi%d: fifo_mismatch %04x not %04x\n",\r\ndefault_instance->host_no, dregs->fifo_count,\r\n(unsigned int) count);\r\nNCR5380_dprint(NDEBUG_DMA, default_instance);\r\n}\r\nudc_regs->addr_hi = (((unsigned long)(addr) & 0xff0000) >> 8);\r\nudc_regs->addr_lo = ((unsigned long)(addr) & 0xffff);\r\nudc_regs->count = count/2;\r\nudc_regs->mode_hi = UDC_MODE_HIWORD;\r\nif(write_flag) {\r\nif(count & 1)\r\nudc_regs->count++;\r\nudc_regs->mode_lo = UDC_MODE_LSEND;\r\nudc_regs->rsel = UDC_RSEL_SEND;\r\n} else {\r\nudc_regs->mode_lo = UDC_MODE_LRECV;\r\nudc_regs->rsel = UDC_RSEL_RECV;\r\n}\r\nsun3_udc_write(((dvma_vtob(udc_regs) & 0xff0000) >> 8),\r\nUDC_CHN_HI);\r\nsun3_udc_write((dvma_vtob(udc_regs) & 0xffff), UDC_CHN_LO);\r\nsun3_udc_write(0xd, UDC_MODE);\r\nsun3_udc_write(UDC_INT_ENABLE, UDC_CSR);\r\n#endif\r\nreturn count;\r\n}\r\nstatic inline unsigned long sun3scsi_dma_count(struct Scsi_Host *instance)\r\n{\r\nunsigned short resid;\r\ndregs->udc_addr = 0x32;\r\nudelay(SUN3_DMA_DELAY);\r\nresid = dregs->udc_data;\r\nudelay(SUN3_DMA_DELAY);\r\nresid *= 2;\r\nreturn (unsigned long) resid;\r\n}\r\nstatic inline unsigned long sun3scsi_dma_residual(struct Scsi_Host *instance)\r\n{\r\nreturn last_residual;\r\n}\r\nstatic inline unsigned long sun3scsi_dma_xfer_len(unsigned long wanted,\r\nstruct scsi_cmnd *cmd,\r\nint write_flag)\r\n{\r\nif (cmd->request->cmd_type == REQ_TYPE_FS)\r\nreturn wanted;\r\nelse\r\nreturn 0;\r\n}\r\nstatic inline int sun3scsi_dma_start(unsigned long count, unsigned char *data)\r\n{\r\n#ifdef SUN3_SCSI_VME\r\nunsigned short csr;\r\ncsr = dregs->csr;\r\ndregs->dma_count_hi = (sun3_dma_orig_count >> 16);\r\ndregs->dma_count_lo = (sun3_dma_orig_count & 0xffff);\r\ndregs->fifo_count_hi = (sun3_dma_orig_count >> 16);\r\ndregs->fifo_count = (sun3_dma_orig_count & 0xffff);\r\n#else\r\nsun3_udc_write(UDC_CHN_START, UDC_CSR);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int sun3scsi_dma_finish(int write_flag)\r\n{\r\nunsigned short __maybe_unused count;\r\nunsigned short fifo;\r\nint ret = 0;\r\nsun3_dma_active = 0;\r\n#ifdef SUN3_SCSI_VME\r\ndregs->csr &= ~CSR_DMA_ENABLE;\r\nfifo = dregs->fifo_count;\r\nif (write_flag) {\r\nif ((fifo > 0) && (fifo < sun3_dma_orig_count))\r\nfifo++;\r\n}\r\nlast_residual = fifo;\r\nif ((!write_flag) && (dregs->csr & CSR_LEFT)) {\r\nunsigned char *vaddr;\r\nvaddr = (unsigned char *)dvma_vmetov(sun3_dma_orig_addr);\r\nvaddr += (sun3_dma_orig_count - fifo);\r\nvaddr--;\r\nswitch (dregs->csr & CSR_LEFT) {\r\ncase CSR_LEFT_3:\r\n*vaddr = (dregs->bpack_lo & 0xff00) >> 8;\r\nvaddr--;\r\ncase CSR_LEFT_2:\r\n*vaddr = (dregs->bpack_hi & 0x00ff);\r\nvaddr--;\r\ncase CSR_LEFT_1:\r\n*vaddr = (dregs->bpack_hi & 0xff00) >> 8;\r\nbreak;\r\n}\r\n}\r\n#else\r\nif(!write_flag) {\r\nint tmo = 20000;\r\nwhile(1) {\r\nif(dregs->csr & CSR_FIFO_EMPTY)\r\nbreak;\r\nif(--tmo <= 0) {\r\nprintk("sun3scsi: fifo failed to empty!\n");\r\nreturn 1;\r\n}\r\nudelay(10);\r\n}\r\n}\r\ncount = sun3scsi_dma_count(default_instance);\r\nfifo = dregs->fifo_count;\r\nlast_residual = fifo;\r\nif((!write_flag) && (count - fifo) == 2) {\r\nunsigned short data;\r\nunsigned char *vaddr;\r\ndata = dregs->fifo_data;\r\nvaddr = (unsigned char *)dvma_btov(sun3_dma_orig_addr);\r\nvaddr += (sun3_dma_orig_count - fifo);\r\nvaddr[-2] = (data & 0xff00) >> 8;\r\nvaddr[-1] = (data & 0xff);\r\n}\r\n#endif\r\ndvma_unmap(sun3_dma_orig_addr);\r\nsun3_dma_orig_addr = NULL;\r\n#ifdef SUN3_SCSI_VME\r\ndregs->dma_addr_hi = 0;\r\ndregs->dma_addr_lo = 0;\r\ndregs->dma_count_hi = 0;\r\ndregs->dma_count_lo = 0;\r\ndregs->fifo_count = 0;\r\ndregs->fifo_count_hi = 0;\r\ndregs->csr &= ~CSR_SEND;\r\n#else\r\nsun3_udc_write(UDC_RESET, UDC_CSR);\r\ndregs->fifo_count = 0;\r\ndregs->csr &= ~CSR_SEND;\r\ndregs->csr &= ~CSR_FIFO;\r\ndregs->csr |= CSR_FIFO;\r\n#endif\r\nsun3_dma_setup_done = NULL;\r\nreturn ret;\r\n}

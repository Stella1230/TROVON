struct ib_ah *create_ib_ah(struct ib_ah_attr *ah_attr,\r\nstruct mlx5_ib_ah *ah)\r\n{\r\nif (ah_attr->ah_flags & IB_AH_GRH) {\r\nmemcpy(ah->av.rgid, &ah_attr->grh.dgid, 16);\r\nah->av.grh_gid_fl = cpu_to_be32(ah_attr->grh.flow_label |\r\n(1 << 30) |\r\nah_attr->grh.sgid_index << 20);\r\nah->av.hop_limit = ah_attr->grh.hop_limit;\r\nah->av.tclass = ah_attr->grh.traffic_class;\r\n}\r\nah->av.rlid = cpu_to_be16(ah_attr->dlid);\r\nah->av.fl_mlid = ah_attr->src_path_bits & 0x7f;\r\nah->av.stat_rate_sl = (ah_attr->static_rate << 4) | (ah_attr->sl & 0xf);\r\nreturn &ah->ibah;\r\n}\r\nstruct ib_ah *mlx5_ib_create_ah(struct ib_pd *pd, struct ib_ah_attr *ah_attr)\r\n{\r\nstruct mlx5_ib_ah *ah;\r\nah = kzalloc(sizeof(*ah), GFP_ATOMIC);\r\nif (!ah)\r\nreturn ERR_PTR(-ENOMEM);\r\nreturn create_ib_ah(ah_attr, ah);\r\n}\r\nint mlx5_ib_query_ah(struct ib_ah *ibah, struct ib_ah_attr *ah_attr)\r\n{\r\nstruct mlx5_ib_ah *ah = to_mah(ibah);\r\nu32 tmp;\r\nmemset(ah_attr, 0, sizeof(*ah_attr));\r\ntmp = be32_to_cpu(ah->av.grh_gid_fl);\r\nif (tmp & (1 << 30)) {\r\nah_attr->ah_flags = IB_AH_GRH;\r\nah_attr->grh.sgid_index = (tmp >> 20) & 0xff;\r\nah_attr->grh.flow_label = tmp & 0xfffff;\r\nmemcpy(&ah_attr->grh.dgid, ah->av.rgid, 16);\r\nah_attr->grh.hop_limit = ah->av.hop_limit;\r\nah_attr->grh.traffic_class = ah->av.tclass;\r\n}\r\nah_attr->dlid = be16_to_cpu(ah->av.rlid);\r\nah_attr->static_rate = ah->av.stat_rate_sl >> 4;\r\nah_attr->sl = ah->av.stat_rate_sl & 0xf;\r\nreturn 0;\r\n}\r\nint mlx5_ib_destroy_ah(struct ib_ah *ah)\r\n{\r\nkfree(to_mah(ah));\r\nreturn 0;\r\n}

static int save_return_addr(struct stackframe *frame, void *d)\r\n{\r\nstruct return_address_data *data = d;\r\nif (!data->level) {\r\ndata->addr = (void *)frame->pc;\r\nreturn 1;\r\n} else {\r\n--data->level;\r\nreturn 0;\r\n}\r\n}\r\nvoid *return_address(unsigned int level)\r\n{\r\nstruct return_address_data data;\r\nstruct stackframe frame;\r\nregister unsigned long current_sp asm ("sp");\r\ndata.level = level + 2;\r\ndata.addr = NULL;\r\nframe.fp = (unsigned long)__builtin_frame_address(0);\r\nframe.sp = current_sp;\r\nframe.pc = (unsigned long)return_address;\r\nwalk_stackframe(&frame, save_return_addr, &data);\r\nif (!data.level)\r\nreturn data.addr;\r\nelse\r\nreturn NULL;\r\n}

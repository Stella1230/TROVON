void pnic2_timer(unsigned long data)\r\n{\r\nstruct net_device *dev = (struct net_device *)data;\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint next_tick = 60*HZ;\r\nif (tulip_debug > 3)\r\ndev_info(&dev->dev, "PNIC2 negotiation status %08x\n",\r\nioread32(ioaddr + CSR12));\r\nif (next_tick) {\r\nmod_timer(&tp->timer, RUN_AT(next_tick));\r\n}\r\n}\r\nvoid pnic2_start_nway(struct net_device *dev)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint csr14;\r\nint csr12;\r\ncsr14 = (ioread32(ioaddr + CSR14) & 0xfff0ee39);\r\nif (tp->sym_advertise & 0x0100) csr14 |= 0x00020000;\r\nif (tp->sym_advertise & 0x0080) csr14 |= 0x00010000;\r\nif (tp->sym_advertise & 0x0020) csr14 |= 0x00000040;\r\ncsr14 |= 0x00001184;\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "Restarting PNIC2 autonegotiation, csr14=%08x\n",\r\ncsr14);\r\ndev->if_port = 0;\r\ntp->nway = tp->mediasense = 1;\r\ntp->nwayset = tp->lpar = 0;\r\ntp->csr6 = ioread32(ioaddr + CSR6);\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "On Entry to Nway, csr6=%08x\n", tp->csr6);\r\ntp->csr6 = tp->csr6 & 0xfe3bd1fd;\r\nif (tp->sym_advertise & 0x0040) tp->csr6 |= 0x00000200;\r\ntp->csr6 |= 0x01000000;\r\niowrite32(csr14, ioaddr + CSR14);\r\niowrite32(tp->csr6, ioaddr + CSR6);\r\nudelay(100);\r\ncsr12 = (ioread32(ioaddr + CSR12) & 0xffff8fff);\r\ncsr12 |= 0x1000;\r\niowrite32(csr12, ioaddr + CSR12);\r\n}\r\nvoid pnic2_lnk_change(struct net_device *dev, int csr5)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint csr14;\r\nint csr12 = ioread32(ioaddr + CSR12);\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"PNIC2 link status interrupt %08x, CSR5 %x, %08x\n",\r\ncsr12, csr5, ioread32(ioaddr + CSR14));\r\nif (tp->nway && !tp->nwayset) {\r\nif ((csr12 & 0x7000) == 0x5000) {\r\nint negotiated = ((csr12 >> 16) & 0x01E0) & tp->sym_advertise;\r\ntp->lpar = (csr12 >> 16);\r\ntp->nwayset = 1;\r\nif (negotiated & 0x0100) dev->if_port = 5;\r\nelse if (negotiated & 0x0080) dev->if_port = 3;\r\nelse if (negotiated & 0x0040) dev->if_port = 4;\r\nelse if (negotiated & 0x0020) dev->if_port = 0;\r\nelse {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"funny autonegotiate result csr12 %08x advertising %04x\n",\r\ncsr12, tp->sym_advertise);\r\ntp->nwayset = 0;\r\nif ((csr12 & 2) == 0 && (tp->sym_advertise & 0x0180))\r\ndev->if_port = 3;\r\n}\r\ntp->full_duplex = 0;\r\nif ((dev->if_port == 4) || (dev->if_port == 5))\r\ntp->full_duplex = 1;\r\nif (tulip_debug > 1) {\r\nif (tp->nwayset)\r\ndev_info(&dev->dev,\r\n"Switching to %s based on link negotiation %04x & %04x = %04x\n",\r\nmedianame[dev->if_port],\r\ntp->sym_advertise, tp->lpar,\r\nnegotiated);\r\n}\r\ncsr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\r\niowrite32(csr14,ioaddr + CSR14);\r\ntp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\r\nif (dev->if_port & 1) tp->csr6 |= 0x01840000;\r\nelse tp->csr6 |= 0x00400000;\r\nif (tp->full_duplex) tp->csr6 |= 0x00000200;\r\niowrite32(1, ioaddr + CSR13);\r\nif (tulip_debug > 2)\r\nnetdev_dbg(dev, "Setting CSR6 %08x/%x CSR12 %08x\n",\r\ntp->csr6,\r\nioread32(ioaddr + CSR6),\r\nioread32(ioaddr + CSR12));\r\ntulip_start_rxtx(tp);\r\nreturn;\r\n} else {\r\ndev_info(&dev->dev,\r\n"Autonegotiation failed, using %s, link beat status %04x\n",\r\nmedianame[dev->if_port], csr12);\r\ncsr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\r\niowrite32(csr14,ioaddr + CSR14);\r\ndev->if_port = 0;\r\ntp->nway = 0;\r\ntp->nwayset = 1;\r\ntp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\r\ntp->csr6 |= 0x00400000;\r\ntulip_restart_rxtx(tp);\r\nreturn;\r\n}\r\n}\r\nif ((tp->nwayset && (csr5 & 0x08000000) &&\r\n(dev->if_port == 3 || dev->if_port == 5) &&\r\n(csr12 & 2) == 2) || (tp->nway && (csr5 & (TPLnkFail)))) {\r\nif (tulip_debug > 2)\r\nnetdev_dbg(dev, "Ugh! Link blew?\n");\r\ndel_timer_sync(&tp->timer);\r\npnic2_start_nway(dev);\r\ntp->timer.expires = RUN_AT(3*HZ);\r\nadd_timer(&tp->timer);\r\nreturn;\r\n}\r\nif (dev->if_port == 3 || dev->if_port == 5) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "PNIC2 %s link beat %s\n",\r\nmedianame[dev->if_port],\r\n(csr12 & 2) ? "failed" : "good");\r\ntp->nway = 0;\r\ntp->nwayset = 1;\r\nif ((csr12 & 2) && ! tp->medialock) {\r\ndel_timer_sync(&tp->timer);\r\npnic2_start_nway(dev);\r\ntp->timer.expires = RUN_AT(3*HZ);\r\nadd_timer(&tp->timer);\r\n}\r\nreturn;\r\n}\r\nif (dev->if_port == 0 || dev->if_port == 4) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "PNIC2 %s link beat %s\n",\r\nmedianame[dev->if_port],\r\n(csr12 & 4) ? "failed" : "good");\r\ntp->nway = 0;\r\ntp->nwayset = 1;\r\nif ((csr12 & 4) && ! tp->medialock) {\r\ndel_timer_sync(&tp->timer);\r\npnic2_start_nway(dev);\r\ntp->timer.expires = RUN_AT(3*HZ);\r\nadd_timer(&tp->timer);\r\n}\r\nreturn;\r\n}\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "PNIC2 Link Change Default?\n");\r\ndev->if_port = 0;\r\ncsr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\r\niowrite32(csr14,ioaddr + CSR14);\r\ntp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\r\ntp->csr6 |= 0x00400000;\r\ntulip_restart_rxtx(tp);\r\n}

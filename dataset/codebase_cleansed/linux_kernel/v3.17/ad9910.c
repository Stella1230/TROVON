static ssize_t ad9910_set_parameter(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct spi_transfer xfer;\r\nint ret;\r\nstruct ad9910_config *config = (struct ad9910_config *)buf;\r\nstruct iio_dev *idev = dev_to_iio_dev(dev);\r\nstruct ad9910_state *st = iio_priv(idev);\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->auxdac[0];\r\nmutex_lock(&st->lock);\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->ioupd[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->ftw[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 3;\r\nxfer.tx_buf = &config->pow[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->asf[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->multc[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->dig_rampl[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->dig_ramps[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 5;\r\nxfer.tx_buf = &config->dig_rampr[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep0[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep1[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep2[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep3[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep4[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep5[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep6[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nxfer.len = 9;\r\nxfer.tx_buf = &config->sin_tonep7[0];\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nmutex_unlock(&st->lock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic void ad9910_init(struct ad9910_state *st)\r\n{\r\nstruct spi_transfer xfer;\r\nint ret;\r\nu8 cfr[5];\r\ncfr[0] = CFR1;\r\ncfr[1] = 0;\r\ncfr[2] = MANUAL_OSK | INVSIC | DDS_SINEOP;\r\ncfr[3] = AUTO_OSK | OSKEN | ACLR_PHA | ACLR_DIG | LOAD_LRR;\r\ncfr[4] = 0;\r\nmutex_lock(&st->lock);\r\nxfer.len = 5;\r\nxfer.tx_buf = &cfr;\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\ncfr[0] = CFR2;\r\ncfr[1] = ENA_AMP;\r\ncfr[2] = READ_FTW | DIGR_ENA | ITER_IOUPD;\r\ncfr[3] = TX_ENA | PDCLK_INV | PDCLK_ENB;\r\ncfr[4] = PARA_ENA;\r\nxfer.len = 5;\r\nxfer.tx_buf = &cfr;\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\ncfr[0] = CFR3;\r\ncfr[1] = PLL_ENA;\r\ncfr[2] = 0;\r\ncfr[3] = REFCLK_RST | REFCLK_BYP;\r\ncfr[4] = 0;\r\nxfer.len = 5;\r\nxfer.tx_buf = &cfr;\r\nret = spi_sync_transfer(st->sdev, &xfer, 1);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nmutex_unlock(&st->lock);\r\n}\r\nstatic int ad9910_probe(struct spi_device *spi)\r\n{\r\nstruct ad9910_state *st;\r\nstruct iio_dev *idev;\r\nint ret = 0;\r\nidev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!idev)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, idev);\r\nst = iio_priv(idev);\r\nmutex_init(&st->lock);\r\nst->sdev = spi;\r\nidev->dev.parent = &spi->dev;\r\nidev->info = &ad9910_info;\r\nidev->modes = INDIO_DIRECT_MODE;\r\nret = iio_device_register(idev);\r\nif (ret)\r\nreturn ret;\r\nspi->max_speed_hz = 2000000;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nad9910_init(st);\r\nreturn 0;\r\n}\r\nstatic int ad9910_remove(struct spi_device *spi)\r\n{\r\niio_device_unregister(spi_get_drvdata(spi));\r\nreturn 0;\r\n}

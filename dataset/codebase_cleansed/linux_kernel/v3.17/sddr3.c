static inline int\r\nramxlat(const struct ramxlat *xlat, int id)\r\n{\r\nwhile (xlat->id >= 0) {\r\nif (xlat->id == id)\r\nreturn xlat->enc;\r\nxlat++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint\r\nnouveau_sddr3_calc(struct nouveau_ram *ram)\r\n{\r\nstruct nouveau_bios *bios = nouveau_bios(ram);\r\nint WL, CL, WR;\r\nswitch (!!ram->timing.data * ram->timing.version) {\r\ncase 0x20:\r\nWL = (nv_ro16(bios, ram->timing.data + 0x04) & 0x0f80) >> 7;\r\nCL = nv_ro08(bios, ram->timing.data + 0x04) & 0x1f;\r\nWR = nv_ro08(bios, ram->timing.data + 0x0a) & 0x7f;\r\nbreak;\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\nWL = ramxlat(ramddr3_cwl, WL);\r\nCL = ramxlat(ramddr3_cl, CL);\r\nWR = ramxlat(ramddr3_wr, WR);\r\nif (WL < 0 || CL < 0 || WR < 0)\r\nreturn -EINVAL;\r\nram->mr[0] &= ~0xe74;\r\nram->mr[0] |= (WR & 0x07) << 9;\r\nram->mr[0] |= (CL & 0x0e) << 3;\r\nram->mr[0] |= (CL & 0x01) << 2;\r\nram->mr[2] &= ~0x038;\r\nram->mr[2] |= (WL & 0x07) << 3;\r\nreturn 0;\r\n}

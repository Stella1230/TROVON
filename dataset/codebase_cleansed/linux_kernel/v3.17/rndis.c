static int gen_ndis_query_resp(int configNr, u32 OID, u8 *buf,\r\nunsigned buf_len, rndis_resp_t *r)\r\n{\r\nint retval = -ENOTSUPP;\r\nu32 length = 4;\r\n__le32 *outbuf;\r\nint i, count;\r\nrndis_query_cmplt_type *resp;\r\nstruct net_device *net;\r\nstruct rtnl_link_stats64 temp;\r\nconst struct rtnl_link_stats64 *stats;\r\nif (!r) return -ENOMEM;\r\nresp = (rndis_query_cmplt_type *)r->buf;\r\nif (!resp) return -ENOMEM;\r\nif (buf_len && rndis_debug > 1) {\r\npr_debug("query OID %08x value, len %d:\n", OID, buf_len);\r\nfor (i = 0; i < buf_len; i += 16) {\r\npr_debug("%03d: %08x %08x %08x %08x\n", i,\r\nget_unaligned_le32(&buf[i]),\r\nget_unaligned_le32(&buf[i + 4]),\r\nget_unaligned_le32(&buf[i + 8]),\r\nget_unaligned_le32(&buf[i + 12]));\r\n}\r\n}\r\noutbuf = (__le32 *)&resp[1];\r\nresp->InformationBufferOffset = cpu_to_le32(16);\r\nnet = rndis_per_dev_params[configNr].dev;\r\nstats = dev_get_stats(net, &temp);\r\nswitch (OID) {\r\ncase RNDIS_OID_GEN_SUPPORTED_LIST:\r\npr_debug("%s: RNDIS_OID_GEN_SUPPORTED_LIST\n", __func__);\r\nlength = sizeof(oid_supported_list);\r\ncount = length / sizeof(u32);\r\nfor (i = 0; i < count; i++)\r\noutbuf[i] = cpu_to_le32(oid_supported_list[i]);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_HARDWARE_STATUS:\r\npr_debug("%s: RNDIS_OID_GEN_HARDWARE_STATUS\n", __func__);\r\n*outbuf = cpu_to_le32(0);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MEDIA_SUPPORTED:\r\npr_debug("%s: RNDIS_OID_GEN_MEDIA_SUPPORTED\n", __func__);\r\n*outbuf = cpu_to_le32(rndis_per_dev_params[configNr].medium);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MEDIA_IN_USE:\r\npr_debug("%s: RNDIS_OID_GEN_MEDIA_IN_USE\n", __func__);\r\n*outbuf = cpu_to_le32(rndis_per_dev_params[configNr].medium);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MAXIMUM_FRAME_SIZE:\r\npr_debug("%s: RNDIS_OID_GEN_MAXIMUM_FRAME_SIZE\n", __func__);\r\nif (rndis_per_dev_params[configNr].dev) {\r\n*outbuf = cpu_to_le32(\r\nrndis_per_dev_params[configNr].dev->mtu);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_LINK_SPEED:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_LINK_SPEED\n", __func__);\r\nif (rndis_per_dev_params[configNr].media_state\r\n== RNDIS_MEDIA_STATE_DISCONNECTED)\r\n*outbuf = cpu_to_le32(0);\r\nelse\r\n*outbuf = cpu_to_le32(\r\nrndis_per_dev_params[configNr].speed);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_TRANSMIT_BLOCK_SIZE:\r\npr_debug("%s: RNDIS_OID_GEN_TRANSMIT_BLOCK_SIZE\n", __func__);\r\nif (rndis_per_dev_params[configNr].dev) {\r\n*outbuf = cpu_to_le32(\r\nrndis_per_dev_params[configNr].dev->mtu);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_RECEIVE_BLOCK_SIZE:\r\npr_debug("%s: RNDIS_OID_GEN_RECEIVE_BLOCK_SIZE\n", __func__);\r\nif (rndis_per_dev_params[configNr].dev) {\r\n*outbuf = cpu_to_le32(\r\nrndis_per_dev_params[configNr].dev->mtu);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_VENDOR_ID:\r\npr_debug("%s: RNDIS_OID_GEN_VENDOR_ID\n", __func__);\r\n*outbuf = cpu_to_le32(\r\nrndis_per_dev_params[configNr].vendorID);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_VENDOR_DESCRIPTION:\r\npr_debug("%s: RNDIS_OID_GEN_VENDOR_DESCRIPTION\n", __func__);\r\nif (rndis_per_dev_params[configNr].vendorDescr) {\r\nlength = strlen(rndis_per_dev_params[configNr].\r\nvendorDescr);\r\nmemcpy(outbuf,\r\nrndis_per_dev_params[configNr].vendorDescr,\r\nlength);\r\n} else {\r\noutbuf[0] = 0;\r\n}\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_VENDOR_DRIVER_VERSION:\r\npr_debug("%s: RNDIS_OID_GEN_VENDOR_DRIVER_VERSION\n", __func__);\r\n*outbuf = rndis_driver_version;\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_CURRENT_PACKET_FILTER:\r\npr_debug("%s: RNDIS_OID_GEN_CURRENT_PACKET_FILTER\n", __func__);\r\n*outbuf = cpu_to_le32(*rndis_per_dev_params[configNr].filter);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MAXIMUM_TOTAL_SIZE:\r\npr_debug("%s: RNDIS_OID_GEN_MAXIMUM_TOTAL_SIZE\n", __func__);\r\n*outbuf = cpu_to_le32(RNDIS_MAX_TOTAL_SIZE);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MEDIA_CONNECT_STATUS:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_MEDIA_CONNECT_STATUS\n", __func__);\r\n*outbuf = cpu_to_le32(rndis_per_dev_params[configNr]\r\n.media_state);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_PHYSICAL_MEDIUM:\r\npr_debug("%s: RNDIS_OID_GEN_PHYSICAL_MEDIUM\n", __func__);\r\n*outbuf = cpu_to_le32(0);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_MAC_OPTIONS:\r\npr_debug("%s: RNDIS_OID_GEN_MAC_OPTIONS\n", __func__);\r\n*outbuf = cpu_to_le32(\r\nRNDIS_MAC_OPTION_RECEIVE_SERIALIZED\r\n| RNDIS_MAC_OPTION_FULL_DUPLEX);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_GEN_XMIT_OK:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_XMIT_OK\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->tx_packets\r\n- stats->tx_errors - stats->tx_dropped);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_RCV_OK:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_RCV_OK\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->rx_packets\r\n- stats->rx_errors - stats->rx_dropped);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_XMIT_ERROR:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_XMIT_ERROR\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->tx_errors);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_RCV_ERROR:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_OID_GEN_RCV_ERROR\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->rx_errors);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_GEN_RCV_NO_BUFFER:\r\npr_debug("%s: RNDIS_OID_GEN_RCV_NO_BUFFER\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->rx_dropped);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_802_3_PERMANENT_ADDRESS:\r\npr_debug("%s: RNDIS_OID_802_3_PERMANENT_ADDRESS\n", __func__);\r\nif (rndis_per_dev_params[configNr].dev) {\r\nlength = ETH_ALEN;\r\nmemcpy(outbuf,\r\nrndis_per_dev_params[configNr].host_mac,\r\nlength);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_802_3_CURRENT_ADDRESS:\r\npr_debug("%s: RNDIS_OID_802_3_CURRENT_ADDRESS\n", __func__);\r\nif (rndis_per_dev_params[configNr].dev) {\r\nlength = ETH_ALEN;\r\nmemcpy(outbuf,\r\nrndis_per_dev_params [configNr].host_mac,\r\nlength);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_802_3_MULTICAST_LIST:\r\npr_debug("%s: RNDIS_OID_802_3_MULTICAST_LIST\n", __func__);\r\n*outbuf = cpu_to_le32(0xE0000000);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_802_3_MAXIMUM_LIST_SIZE:\r\npr_debug("%s: RNDIS_OID_802_3_MAXIMUM_LIST_SIZE\n", __func__);\r\n*outbuf = cpu_to_le32(1);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_802_3_MAC_OPTIONS:\r\npr_debug("%s: RNDIS_OID_802_3_MAC_OPTIONS\n", __func__);\r\n*outbuf = cpu_to_le32(0);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_802_3_RCV_ERROR_ALIGNMENT:\r\npr_debug("%s: RNDIS_OID_802_3_RCV_ERROR_ALIGNMENT\n", __func__);\r\nif (stats) {\r\n*outbuf = cpu_to_le32(stats->rx_frame_errors);\r\nretval = 0;\r\n}\r\nbreak;\r\ncase RNDIS_OID_802_3_XMIT_ONE_COLLISION:\r\npr_debug("%s: RNDIS_OID_802_3_XMIT_ONE_COLLISION\n", __func__);\r\n*outbuf = cpu_to_le32(0);\r\nretval = 0;\r\nbreak;\r\ncase RNDIS_OID_802_3_XMIT_MORE_COLLISIONS:\r\npr_debug("%s: RNDIS_OID_802_3_XMIT_MORE_COLLISIONS\n", __func__);\r\n*outbuf = cpu_to_le32(0);\r\nretval = 0;\r\nbreak;\r\ndefault:\r\npr_warning("%s: query unknown OID 0x%08X\n",\r\n__func__, OID);\r\n}\r\nif (retval < 0)\r\nlength = 0;\r\nresp->InformationBufferLength = cpu_to_le32(length);\r\nr->length = length + sizeof(*resp);\r\nresp->MessageLength = cpu_to_le32(r->length);\r\nreturn retval;\r\n}\r\nstatic int gen_ndis_set_resp(u8 configNr, u32 OID, u8 *buf, u32 buf_len,\r\nrndis_resp_t *r)\r\n{\r\nrndis_set_cmplt_type *resp;\r\nint i, retval = -ENOTSUPP;\r\nstruct rndis_params *params;\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_set_cmplt_type *)r->buf;\r\nif (!resp)\r\nreturn -ENOMEM;\r\nif (buf_len && rndis_debug > 1) {\r\npr_debug("set OID %08x value, len %d:\n", OID, buf_len);\r\nfor (i = 0; i < buf_len; i += 16) {\r\npr_debug("%03d: %08x %08x %08x %08x\n", i,\r\nget_unaligned_le32(&buf[i]),\r\nget_unaligned_le32(&buf[i + 4]),\r\nget_unaligned_le32(&buf[i + 8]),\r\nget_unaligned_le32(&buf[i + 12]));\r\n}\r\n}\r\nparams = &rndis_per_dev_params[configNr];\r\nswitch (OID) {\r\ncase RNDIS_OID_GEN_CURRENT_PACKET_FILTER:\r\n*params->filter = (u16)get_unaligned_le32(buf);\r\npr_debug("%s: RNDIS_OID_GEN_CURRENT_PACKET_FILTER %08x\n",\r\n__func__, *params->filter);\r\nretval = 0;\r\nif (*params->filter) {\r\nparams->state = RNDIS_DATA_INITIALIZED;\r\nnetif_carrier_on(params->dev);\r\nif (netif_running(params->dev))\r\nnetif_wake_queue(params->dev);\r\n} else {\r\nparams->state = RNDIS_INITIALIZED;\r\nnetif_carrier_off(params->dev);\r\nnetif_stop_queue(params->dev);\r\n}\r\nbreak;\r\ncase RNDIS_OID_802_3_MULTICAST_LIST:\r\npr_debug("%s: RNDIS_OID_802_3_MULTICAST_LIST\n", __func__);\r\nretval = 0;\r\nbreak;\r\ndefault:\r\npr_warning("%s: set unknown OID 0x%08X, size %d\n",\r\n__func__, OID, buf_len);\r\n}\r\nreturn retval;\r\n}\r\nstatic int rndis_init_response(int configNr, rndis_init_msg_type *buf)\r\n{\r\nrndis_init_cmplt_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nif (!params->dev)\r\nreturn -ENOTSUPP;\r\nr = rndis_add_response(configNr, sizeof(rndis_init_cmplt_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_init_cmplt_type *)r->buf;\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_INIT_C);\r\nresp->MessageLength = cpu_to_le32(52);\r\nresp->RequestID = buf->RequestID;\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_SUCCESS);\r\nresp->MajorVersion = cpu_to_le32(RNDIS_MAJOR_VERSION);\r\nresp->MinorVersion = cpu_to_le32(RNDIS_MINOR_VERSION);\r\nresp->DeviceFlags = cpu_to_le32(RNDIS_DF_CONNECTIONLESS);\r\nresp->Medium = cpu_to_le32(RNDIS_MEDIUM_802_3);\r\nresp->MaxPacketsPerTransfer = cpu_to_le32(1);\r\nresp->MaxTransferSize = cpu_to_le32(\r\nparams->dev->mtu\r\n+ sizeof(struct ethhdr)\r\n+ sizeof(struct rndis_packet_msg_type)\r\n+ 22);\r\nresp->PacketAlignmentFactor = cpu_to_le32(0);\r\nresp->AFListOffset = cpu_to_le32(0);\r\nresp->AFListSize = cpu_to_le32(0);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nstatic int rndis_query_response(int configNr, rndis_query_msg_type *buf)\r\n{\r\nrndis_query_cmplt_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nif (!params->dev)\r\nreturn -ENOTSUPP;\r\nr = rndis_add_response(configNr,\r\nsizeof(oid_supported_list) + sizeof(rndis_query_cmplt_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_query_cmplt_type *)r->buf;\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_QUERY_C);\r\nresp->RequestID = buf->RequestID;\r\nif (gen_ndis_query_resp(configNr, le32_to_cpu(buf->OID),\r\nle32_to_cpu(buf->InformationBufferOffset)\r\n+ 8 + (u8 *)buf,\r\nle32_to_cpu(buf->InformationBufferLength),\r\nr)) {\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_NOT_SUPPORTED);\r\nresp->MessageLength = cpu_to_le32(sizeof *resp);\r\nresp->InformationBufferLength = cpu_to_le32(0);\r\nresp->InformationBufferOffset = cpu_to_le32(0);\r\n} else\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_SUCCESS);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nstatic int rndis_set_response(int configNr, rndis_set_msg_type *buf)\r\n{\r\nu32 BufLength, BufOffset;\r\nrndis_set_cmplt_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nr = rndis_add_response(configNr, sizeof(rndis_set_cmplt_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_set_cmplt_type *)r->buf;\r\nBufLength = le32_to_cpu(buf->InformationBufferLength);\r\nBufOffset = le32_to_cpu(buf->InformationBufferOffset);\r\n#ifdef VERBOSE_DEBUG\r\npr_debug("%s: Length: %d\n", __func__, BufLength);\r\npr_debug("%s: Offset: %d\n", __func__, BufOffset);\r\npr_debug("%s: InfoBuffer: ", __func__);\r\nfor (i = 0; i < BufLength; i++) {\r\npr_debug("%02x ", *(((u8 *) buf) + i + 8 + BufOffset));\r\n}\r\npr_debug("\n");\r\n#endif\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_SET_C);\r\nresp->MessageLength = cpu_to_le32(16);\r\nresp->RequestID = buf->RequestID;\r\nif (gen_ndis_set_resp(configNr, le32_to_cpu(buf->OID),\r\n((u8 *)buf) + 8 + BufOffset, BufLength, r))\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_NOT_SUPPORTED);\r\nelse\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_SUCCESS);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nstatic int rndis_reset_response(int configNr, rndis_reset_msg_type *buf)\r\n{\r\nrndis_reset_cmplt_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nr = rndis_add_response(configNr, sizeof(rndis_reset_cmplt_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_reset_cmplt_type *)r->buf;\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_RESET_C);\r\nresp->MessageLength = cpu_to_le32(16);\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_SUCCESS);\r\nresp->AddressingReset = cpu_to_le32(1);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nstatic int rndis_keepalive_response(int configNr,\r\nrndis_keepalive_msg_type *buf)\r\n{\r\nrndis_keepalive_cmplt_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nr = rndis_add_response(configNr, sizeof(rndis_keepalive_cmplt_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_keepalive_cmplt_type *)r->buf;\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_KEEPALIVE_C);\r\nresp->MessageLength = cpu_to_le32(16);\r\nresp->RequestID = buf->RequestID;\r\nresp->Status = cpu_to_le32(RNDIS_STATUS_SUCCESS);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nstatic int rndis_indicate_status_msg(int configNr, u32 status)\r\n{\r\nrndis_indicate_status_msg_type *resp;\r\nrndis_resp_t *r;\r\nstruct rndis_params *params = rndis_per_dev_params + configNr;\r\nif (params->state == RNDIS_UNINITIALIZED)\r\nreturn -ENOTSUPP;\r\nr = rndis_add_response(configNr,\r\nsizeof(rndis_indicate_status_msg_type));\r\nif (!r)\r\nreturn -ENOMEM;\r\nresp = (rndis_indicate_status_msg_type *)r->buf;\r\nresp->MessageType = cpu_to_le32(RNDIS_MSG_INDICATE);\r\nresp->MessageLength = cpu_to_le32(20);\r\nresp->Status = cpu_to_le32(status);\r\nresp->StatusBufferLength = cpu_to_le32(0);\r\nresp->StatusBufferOffset = cpu_to_le32(0);\r\nparams->resp_avail(params->v);\r\nreturn 0;\r\n}\r\nint rndis_signal_connect(int configNr)\r\n{\r\nrndis_per_dev_params[configNr].media_state\r\n= RNDIS_MEDIA_STATE_CONNECTED;\r\nreturn rndis_indicate_status_msg(configNr,\r\nRNDIS_STATUS_MEDIA_CONNECT);\r\n}\r\nint rndis_signal_disconnect(int configNr)\r\n{\r\nrndis_per_dev_params[configNr].media_state\r\n= RNDIS_MEDIA_STATE_DISCONNECTED;\r\nreturn rndis_indicate_status_msg(configNr,\r\nRNDIS_STATUS_MEDIA_DISCONNECT);\r\n}\r\nvoid rndis_uninit(int configNr)\r\n{\r\nu8 *buf;\r\nu32 length;\r\nif (configNr >= RNDIS_MAX_CONFIGS)\r\nreturn;\r\nrndis_per_dev_params[configNr].state = RNDIS_UNINITIALIZED;\r\nwhile ((buf = rndis_get_next_response(configNr, &length)))\r\nrndis_free_response(configNr, buf);\r\n}\r\nvoid rndis_set_host_mac(int configNr, const u8 *addr)\r\n{\r\nrndis_per_dev_params[configNr].host_mac = addr;\r\n}\r\nint rndis_msg_parser(u8 configNr, u8 *buf)\r\n{\r\nu32 MsgType, MsgLength;\r\n__le32 *tmp;\r\nstruct rndis_params *params;\r\nif (!buf)\r\nreturn -ENOMEM;\r\ntmp = (__le32 *)buf;\r\nMsgType = get_unaligned_le32(tmp++);\r\nMsgLength = get_unaligned_le32(tmp++);\r\nif (configNr >= RNDIS_MAX_CONFIGS)\r\nreturn -ENOTSUPP;\r\nparams = &rndis_per_dev_params[configNr];\r\nswitch (MsgType) {\r\ncase RNDIS_MSG_INIT:\r\npr_debug("%s: RNDIS_MSG_INIT\n",\r\n__func__);\r\nparams->state = RNDIS_INITIALIZED;\r\nreturn rndis_init_response(configNr,\r\n(rndis_init_msg_type *)buf);\r\ncase RNDIS_MSG_HALT:\r\npr_debug("%s: RNDIS_MSG_HALT\n",\r\n__func__);\r\nparams->state = RNDIS_UNINITIALIZED;\r\nif (params->dev) {\r\nnetif_carrier_off(params->dev);\r\nnetif_stop_queue(params->dev);\r\n}\r\nreturn 0;\r\ncase RNDIS_MSG_QUERY:\r\nreturn rndis_query_response(configNr,\r\n(rndis_query_msg_type *)buf);\r\ncase RNDIS_MSG_SET:\r\nreturn rndis_set_response(configNr,\r\n(rndis_set_msg_type *)buf);\r\ncase RNDIS_MSG_RESET:\r\npr_debug("%s: RNDIS_MSG_RESET\n",\r\n__func__);\r\nreturn rndis_reset_response(configNr,\r\n(rndis_reset_msg_type *)buf);\r\ncase RNDIS_MSG_KEEPALIVE:\r\nif (rndis_debug > 1)\r\npr_debug("%s: RNDIS_MSG_KEEPALIVE\n",\r\n__func__);\r\nreturn rndis_keepalive_response(configNr,\r\n(rndis_keepalive_msg_type *)\r\nbuf);\r\ndefault:\r\npr_warning("%s: unknown RNDIS message 0x%08X len %d\n",\r\n__func__, MsgType, MsgLength);\r\nprint_hex_dump_bytes(__func__, DUMP_PREFIX_OFFSET,\r\nbuf, MsgLength);\r\nbreak;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nint rndis_register(void (*resp_avail)(void *v), void *v)\r\n{\r\nu8 i;\r\nif (!resp_avail)\r\nreturn -EINVAL;\r\nfor (i = 0; i < RNDIS_MAX_CONFIGS; i++) {\r\nif (!rndis_per_dev_params[i].used) {\r\nrndis_per_dev_params[i].used = 1;\r\nrndis_per_dev_params[i].resp_avail = resp_avail;\r\nrndis_per_dev_params[i].v = v;\r\npr_debug("%s: configNr = %d\n", __func__, i);\r\nreturn i;\r\n}\r\n}\r\npr_debug("failed\n");\r\nreturn -ENODEV;\r\n}\r\nvoid rndis_deregister(int configNr)\r\n{\r\npr_debug("%s:\n", __func__);\r\nif (configNr >= RNDIS_MAX_CONFIGS) return;\r\nrndis_per_dev_params[configNr].used = 0;\r\n}\r\nint rndis_set_param_dev(u8 configNr, struct net_device *dev, u16 *cdc_filter)\r\n{\r\npr_debug("%s:\n", __func__);\r\nif (!dev)\r\nreturn -EINVAL;\r\nif (configNr >= RNDIS_MAX_CONFIGS) return -1;\r\nrndis_per_dev_params[configNr].dev = dev;\r\nrndis_per_dev_params[configNr].filter = cdc_filter;\r\nreturn 0;\r\n}\r\nint rndis_set_param_vendor(u8 configNr, u32 vendorID, const char *vendorDescr)\r\n{\r\npr_debug("%s:\n", __func__);\r\nif (!vendorDescr) return -1;\r\nif (configNr >= RNDIS_MAX_CONFIGS) return -1;\r\nrndis_per_dev_params[configNr].vendorID = vendorID;\r\nrndis_per_dev_params[configNr].vendorDescr = vendorDescr;\r\nreturn 0;\r\n}\r\nint rndis_set_param_medium(u8 configNr, u32 medium, u32 speed)\r\n{\r\npr_debug("%s: %u %u\n", __func__, medium, speed);\r\nif (configNr >= RNDIS_MAX_CONFIGS) return -1;\r\nrndis_per_dev_params[configNr].medium = medium;\r\nrndis_per_dev_params[configNr].speed = speed;\r\nreturn 0;\r\n}\r\nvoid rndis_add_hdr(struct sk_buff *skb)\r\n{\r\nstruct rndis_packet_msg_type *header;\r\nif (!skb)\r\nreturn;\r\nheader = (void *)skb_push(skb, sizeof(*header));\r\nmemset(header, 0, sizeof *header);\r\nheader->MessageType = cpu_to_le32(RNDIS_MSG_PACKET);\r\nheader->MessageLength = cpu_to_le32(skb->len);\r\nheader->DataOffset = cpu_to_le32(36);\r\nheader->DataLength = cpu_to_le32(skb->len - sizeof(*header));\r\n}\r\nvoid rndis_free_response(int configNr, u8 *buf)\r\n{\r\nrndis_resp_t *r;\r\nstruct list_head *act, *tmp;\r\nlist_for_each_safe(act, tmp,\r\n&(rndis_per_dev_params[configNr].resp_queue))\r\n{\r\nr = list_entry(act, rndis_resp_t, list);\r\nif (r && r->buf == buf) {\r\nlist_del(&r->list);\r\nkfree(r);\r\n}\r\n}\r\n}\r\nu8 *rndis_get_next_response(int configNr, u32 *length)\r\n{\r\nrndis_resp_t *r;\r\nstruct list_head *act, *tmp;\r\nif (!length) return NULL;\r\nlist_for_each_safe(act, tmp,\r\n&(rndis_per_dev_params[configNr].resp_queue))\r\n{\r\nr = list_entry(act, rndis_resp_t, list);\r\nif (!r->send) {\r\nr->send = 1;\r\n*length = r->length;\r\nreturn r->buf;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic rndis_resp_t *rndis_add_response(int configNr, u32 length)\r\n{\r\nrndis_resp_t *r;\r\nr = kmalloc(sizeof(rndis_resp_t) + length, GFP_ATOMIC);\r\nif (!r) return NULL;\r\nr->buf = (u8 *)(r + 1);\r\nr->length = length;\r\nr->send = 0;\r\nlist_add_tail(&r->list,\r\n&(rndis_per_dev_params[configNr].resp_queue));\r\nreturn r;\r\n}\r\nint rndis_rm_hdr(struct gether *port,\r\nstruct sk_buff *skb,\r\nstruct sk_buff_head *list)\r\n{\r\n__le32 *tmp = (void *)skb->data;\r\nif (cpu_to_le32(RNDIS_MSG_PACKET)\r\n!= get_unaligned(tmp++)) {\r\ndev_kfree_skb_any(skb);\r\nreturn -EINVAL;\r\n}\r\ntmp++;\r\nif (!skb_pull(skb, get_unaligned_le32(tmp++) + 8)) {\r\ndev_kfree_skb_any(skb);\r\nreturn -EOVERFLOW;\r\n}\r\nskb_trim(skb, get_unaligned_le32(tmp++));\r\nskb_queue_tail(list, skb);\r\nreturn 0;\r\n}\r\nstatic int rndis_proc_show(struct seq_file *m, void *v)\r\n{\r\nrndis_params *param = m->private;\r\nseq_printf(m,\r\n"Config Nr. %d\n"\r\n"used : %s\n"\r\n"state : %s\n"\r\n"medium : 0x%08X\n"\r\n"speed : %d\n"\r\n"cable : %s\n"\r\n"vendor ID : 0x%08X\n"\r\n"vendor : %s\n",\r\nparam->confignr, (param->used) ? "y" : "n",\r\n({ char *s = "?";\r\nswitch (param->state) {\r\ncase RNDIS_UNINITIALIZED:\r\ns = "RNDIS_UNINITIALIZED"; break;\r\ncase RNDIS_INITIALIZED:\r\ns = "RNDIS_INITIALIZED"; break;\r\ncase RNDIS_DATA_INITIALIZED:\r\ns = "RNDIS_DATA_INITIALIZED"; break;\r\n} s; }),\r\nparam->medium,\r\n(param->media_state) ? 0 : param->speed*100,\r\n(param->media_state) ? "disconnected" : "connected",\r\nparam->vendorID, param->vendorDescr);\r\nreturn 0;\r\n}\r\nstatic ssize_t rndis_proc_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nrndis_params *p = PDE_DATA(file_inode(file));\r\nu32 speed = 0;\r\nint i, fl_speed = 0;\r\nfor (i = 0; i < count; i++) {\r\nchar c;\r\nif (get_user(c, buffer))\r\nreturn -EFAULT;\r\nswitch (c) {\r\ncase '0':\r\ncase '1':\r\ncase '2':\r\ncase '3':\r\ncase '4':\r\ncase '5':\r\ncase '6':\r\ncase '7':\r\ncase '8':\r\ncase '9':\r\nfl_speed = 1;\r\nspeed = speed * 10 + c - '0';\r\nbreak;\r\ncase 'C':\r\ncase 'c':\r\nrndis_signal_connect(p->confignr);\r\nbreak;\r\ncase 'D':\r\ncase 'd':\r\nrndis_signal_disconnect(p->confignr);\r\nbreak;\r\ndefault:\r\nif (fl_speed) p->speed = speed;\r\nelse pr_debug("%c is not valid\n", c);\r\nbreak;\r\n}\r\nbuffer++;\r\n}\r\nreturn count;\r\n}\r\nstatic int rndis_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, rndis_proc_show, PDE_DATA(inode));\r\n}\r\nint rndis_init(void)\r\n{\r\nu8 i;\r\nfor (i = 0; i < RNDIS_MAX_CONFIGS; i++) {\r\n#ifdef CONFIG_USB_GADGET_DEBUG_FILES\r\nchar name [20];\r\nsprintf(name, NAME_TEMPLATE, i);\r\nrndis_connect_state[i] = proc_create_data(name, 0660, NULL,\r\n&rndis_proc_fops,\r\n(void *)(rndis_per_dev_params + i));\r\nif (!rndis_connect_state[i]) {\r\npr_debug("%s: remove entries", __func__);\r\nwhile (i) {\r\nsprintf(name, NAME_TEMPLATE, --i);\r\nremove_proc_entry(name, NULL);\r\n}\r\npr_debug("\n");\r\nreturn -EIO;\r\n}\r\n#endif\r\nrndis_per_dev_params[i].confignr = i;\r\nrndis_per_dev_params[i].used = 0;\r\nrndis_per_dev_params[i].state = RNDIS_UNINITIALIZED;\r\nrndis_per_dev_params[i].media_state\r\n= RNDIS_MEDIA_STATE_DISCONNECTED;\r\nINIT_LIST_HEAD(&(rndis_per_dev_params[i].resp_queue));\r\n}\r\nreturn 0;\r\n}\r\nvoid rndis_exit(void)\r\n{\r\n#ifdef CONFIG_USB_GADGET_DEBUG_FILES\r\nu8 i;\r\nchar name[20];\r\nfor (i = 0; i < RNDIS_MAX_CONFIGS; i++) {\r\nsprintf(name, NAME_TEMPLATE, i);\r\nremove_proc_entry(name, NULL);\r\n}\r\n#endif\r\n}

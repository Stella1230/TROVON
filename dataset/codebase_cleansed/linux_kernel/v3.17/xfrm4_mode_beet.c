static void xfrm4_beet_make_header(struct sk_buff *skb)\r\n{\r\nstruct iphdr *iph = ip_hdr(skb);\r\niph->ihl = 5;\r\niph->version = 4;\r\niph->protocol = XFRM_MODE_SKB_CB(skb)->protocol;\r\niph->tos = XFRM_MODE_SKB_CB(skb)->tos;\r\niph->id = XFRM_MODE_SKB_CB(skb)->id;\r\niph->frag_off = XFRM_MODE_SKB_CB(skb)->frag_off;\r\niph->ttl = XFRM_MODE_SKB_CB(skb)->ttl;\r\n}\r\nstatic int xfrm4_beet_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct ip_beet_phdr *ph;\r\nstruct iphdr *top_iph;\r\nint hdrlen, optlen;\r\nhdrlen = 0;\r\noptlen = XFRM_MODE_SKB_CB(skb)->optlen;\r\nif (unlikely(optlen))\r\nhdrlen += IPV4_BEET_PHMAXLEN - (optlen & 4);\r\nskb_set_network_header(skb, -x->props.header_len -\r\nhdrlen + (XFRM_MODE_SKB_CB(skb)->ihl - sizeof(*top_iph)));\r\nif (x->sel.family != AF_INET6)\r\nskb->network_header += IPV4_BEET_PHMAXLEN;\r\nskb->mac_header = skb->network_header +\r\noffsetof(struct iphdr, protocol);\r\nskb->transport_header = skb->network_header + sizeof(*top_iph);\r\nxfrm4_beet_make_header(skb);\r\nph = (struct ip_beet_phdr *)\r\n__skb_pull(skb, XFRM_MODE_SKB_CB(skb)->ihl - hdrlen);\r\ntop_iph = ip_hdr(skb);\r\nif (unlikely(optlen)) {\r\nBUG_ON(optlen < 0);\r\nph->padlen = 4 - (optlen & 4);\r\nph->hdrlen = optlen / 8;\r\nph->nexthdr = top_iph->protocol;\r\nif (ph->padlen)\r\nmemset(ph + 1, IPOPT_NOP, ph->padlen);\r\ntop_iph->protocol = IPPROTO_BEETPH;\r\ntop_iph->ihl = sizeof(struct iphdr) / 4;\r\n}\r\ntop_iph->saddr = x->props.saddr.a4;\r\ntop_iph->daddr = x->id.daddr.a4;\r\nreturn 0;\r\n}\r\nstatic int xfrm4_beet_input(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct iphdr *iph;\r\nint optlen = 0;\r\nint err = -EINVAL;\r\nif (unlikely(XFRM_MODE_SKB_CB(skb)->protocol == IPPROTO_BEETPH)) {\r\nstruct ip_beet_phdr *ph;\r\nint phlen;\r\nif (!pskb_may_pull(skb, sizeof(*ph)))\r\ngoto out;\r\nph = (struct ip_beet_phdr *)skb->data;\r\nphlen = sizeof(*ph) + ph->padlen;\r\noptlen = ph->hdrlen * 8 + (IPV4_BEET_PHMAXLEN - phlen);\r\nif (optlen < 0 || optlen & 3 || optlen > 250)\r\ngoto out;\r\nXFRM_MODE_SKB_CB(skb)->protocol = ph->nexthdr;\r\nif (!pskb_may_pull(skb, phlen))\r\ngoto out;\r\n__skb_pull(skb, phlen);\r\n}\r\nskb_push(skb, sizeof(*iph));\r\nskb_reset_network_header(skb);\r\nskb_mac_header_rebuild(skb);\r\nxfrm4_beet_make_header(skb);\r\niph = ip_hdr(skb);\r\niph->ihl += optlen / 4;\r\niph->tot_len = htons(skb->len);\r\niph->daddr = x->sel.daddr.a4;\r\niph->saddr = x->sel.saddr.a4;\r\niph->check = 0;\r\niph->check = ip_fast_csum(skb_network_header(skb), iph->ihl);\r\nerr = 0;\r\nout:\r\nreturn err;\r\n}\r\nstatic int __init xfrm4_beet_init(void)\r\n{\r\nreturn xfrm_register_mode(&xfrm4_beet_mode, AF_INET);\r\n}\r\nstatic void __exit xfrm4_beet_exit(void)\r\n{\r\nint err;\r\nerr = xfrm_unregister_mode(&xfrm4_beet_mode, AF_INET);\r\nBUG_ON(err);\r\n}

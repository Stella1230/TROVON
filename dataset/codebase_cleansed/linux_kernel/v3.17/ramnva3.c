static int\r\nnva3_ram_calc(struct nouveau_fb *pfb, u32 freq)\r\n{\r\nstruct nouveau_bios *bios = nouveau_bios(pfb);\r\nstruct nva3_ram *ram = (void *)pfb->ram;\r\nstruct nva3_ramfuc *fuc = &ram->fuc;\r\nstruct nva3_clock_info mclk;\r\nu8 ver, cnt, len, strap;\r\nu32 data;\r\nstruct {\r\nu32 data;\r\nu8 size;\r\n} rammap, ramcfg, timing;\r\nu32 r004018, r100760, ctrl;\r\nu32 unk714, unk718, unk71c;\r\nint ret;\r\nrammap.data = nvbios_rammapEm(bios, freq / 1000, &ver, &rammap.size,\r\n&cnt, &ramcfg.size);\r\nif (!rammap.data || ver != 0x10 || rammap.size < 0x0e) {\r\nnv_error(pfb, "invalid/missing rammap entry\n");\r\nreturn -EINVAL;\r\n}\r\nstrap = nvbios_ramcfg_index(nv_subdev(pfb));\r\nif (strap >= cnt) {\r\nnv_error(pfb, "invalid ramcfg strap\n");\r\nreturn -EINVAL;\r\n}\r\nramcfg.data = rammap.data + rammap.size + (strap * ramcfg.size);\r\nif (!ramcfg.data || ver != 0x10 || ramcfg.size < 0x0e) {\r\nnv_error(pfb, "invalid/missing ramcfg entry\n");\r\nreturn -EINVAL;\r\n}\r\nstrap = nv_ro08(bios, ramcfg.data + 0x01);\r\nif (strap != 0xff) {\r\ntiming.data = nvbios_timingEe(bios, strap, &ver, &timing.size,\r\n&cnt, &len);\r\nif (!timing.data || ver != 0x10 || timing.size < 0x19) {\r\nnv_error(pfb, "invalid/missing timing entry\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\ntiming.data = 0;\r\n}\r\nret = nva3_clock_info(nouveau_clock(pfb), 0x12, 0x4000, freq, &mclk);\r\nif (ret < 0) {\r\nnv_error(pfb, "failed mclk calculation\n");\r\nreturn ret;\r\n}\r\nret = ram_init(fuc, pfb);\r\nif (ret)\r\nreturn ret;\r\nif (freq <= 750000) {\r\nr004018 = 0x10000000;\r\nr100760 = 0x22222222;\r\n} else {\r\nr004018 = 0x00000000;\r\nr100760 = 0x00000000;\r\n}\r\nctrl = ram_rd32(fuc, 0x004000);\r\nif (ctrl & 0x00000008) {\r\nif (mclk.pll) {\r\nram_mask(fuc, 0x004128, 0x00000101, 0x00000101);\r\nram_wr32(fuc, 0x004004, mclk.pll);\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000001));\r\nram_wr32(fuc, 0x004000, (ctrl &= 0xffffffef));\r\nram_wait(fuc, 0x004000, 0x00020000, 0x00020000, 64000);\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000010));\r\nram_wr32(fuc, 0x004018, 0x00005000 | r004018);\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000004));\r\n}\r\n} else {\r\nu32 ssel = 0x00000101;\r\nif (mclk.clk)\r\nssel |= mclk.clk;\r\nelse\r\nssel |= 0x00080000;\r\nram_mask(fuc, 0x004168, 0x003f3141, ctrl);\r\n}\r\nif ( (nv_ro08(bios, ramcfg.data + 0x02) & 0x10)) {\r\nram_mask(fuc, 0x111104, 0x00000600, 0x00000000);\r\n} else {\r\nram_mask(fuc, 0x111100, 0x40000000, 0x40000000);\r\nram_mask(fuc, 0x111104, 0x00000180, 0x00000000);\r\n}\r\nif (!(nv_ro08(bios, rammap.data + 0x04) & 0x02))\r\nram_mask(fuc, 0x100200, 0x00000800, 0x00000000);\r\nram_wr32(fuc, 0x611200, 0x00003300);\r\nif (!(nv_ro08(bios, ramcfg.data + 0x02) & 0x10))\r\nram_wr32(fuc, 0x111100, 0x4c020000);\r\nram_wr32(fuc, 0x1002d4, 0x00000001);\r\nram_wr32(fuc, 0x1002d0, 0x00000001);\r\nram_wr32(fuc, 0x1002d0, 0x00000001);\r\nram_wr32(fuc, 0x100210, 0x00000000);\r\nram_wr32(fuc, 0x1002dc, 0x00000001);\r\nram_nsec(fuc, 2000);\r\nctrl = ram_rd32(fuc, 0x004000);\r\nif (!(ctrl & 0x00000008) && mclk.pll) {\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000008));\r\nram_mask(fuc, 0x1110e0, 0x00088000, 0x00088000);\r\nram_wr32(fuc, 0x004018, 0x00001000);\r\nram_wr32(fuc, 0x004000, (ctrl &= ~0x00000001));\r\nram_wr32(fuc, 0x004004, mclk.pll);\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000001));\r\nudelay(64);\r\nram_wr32(fuc, 0x004018, 0x00005000 | r004018);\r\nudelay(20);\r\n} else\r\nif (!mclk.pll) {\r\nram_mask(fuc, 0x004168, 0x003f3040, mclk.clk);\r\nram_wr32(fuc, 0x004000, (ctrl |= 0x00000008));\r\nram_mask(fuc, 0x1110e0, 0x00088000, 0x00088000);\r\nram_wr32(fuc, 0x004018, 0x0000d000 | r004018);\r\n}\r\nif ( (nv_ro08(bios, rammap.data + 0x04) & 0x08)) {\r\nu32 unk5a0 = (nv_ro16(bios, ramcfg.data + 0x05) << 8) |\r\nnv_ro08(bios, ramcfg.data + 0x05);\r\nu32 unk5a4 = (nv_ro16(bios, ramcfg.data + 0x07));\r\nu32 unk804 = (nv_ro08(bios, ramcfg.data + 0x09) & 0xf0) << 16 |\r\n(nv_ro08(bios, ramcfg.data + 0x03) & 0x0f) << 16 |\r\n(nv_ro08(bios, ramcfg.data + 0x09) & 0x0f) |\r\n0x80000000;\r\nram_wr32(fuc, 0x1005a0, unk5a0);\r\nram_wr32(fuc, 0x1005a4, unk5a4);\r\nram_wr32(fuc, 0x10f804, unk804);\r\nram_mask(fuc, 0x10053c, 0x00001000, 0x00000000);\r\n} else {\r\nram_mask(fuc, 0x10053c, 0x00001000, 0x00001000);\r\nram_mask(fuc, 0x10f804, 0x80000000, 0x00000000);\r\nram_mask(fuc, 0x100760, 0x22222222, r100760);\r\nram_mask(fuc, 0x1007a0, 0x22222222, r100760);\r\nram_mask(fuc, 0x1007e0, 0x22222222, r100760);\r\n}\r\nif (mclk.pll) {\r\nram_mask(fuc, 0x1110e0, 0x00088000, 0x00011000);\r\nram_wr32(fuc, 0x004000, (ctrl &= ~0x00000008));\r\n}\r\nram_wr32(fuc, 0x1002dc, 0x00000000);\r\nram_wr32(fuc, 0x1002d4, 0x00000001);\r\nram_wr32(fuc, 0x100210, 0x80000000);\r\nram_nsec(fuc, 1000);\r\nram_nsec(fuc, 1000);\r\nram_mask(fuc, mr[2], 0x00000000, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_nuke(fuc, mr[0]);\r\nram_mask(fuc, mr[0], 0x00000000, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_mask(fuc, 0x100220[3], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[1], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[6], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[7], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[2], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[4], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[5], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[0], 0x00000000, 0x00000000);\r\nram_mask(fuc, 0x100220[8], 0x00000000, 0x00000000);\r\ndata = (nv_ro08(bios, ramcfg.data + 0x02) & 0x08) ? 0x00000000 : 0x00001000;\r\nram_mask(fuc, 0x100200, 0x00001000, data);\r\nunk714 = ram_rd32(fuc, 0x100714) & ~0xf0000010;\r\nunk718 = ram_rd32(fuc, 0x100718) & ~0x00000100;\r\nunk71c = ram_rd32(fuc, 0x10071c) & ~0x00000100;\r\nif ( (nv_ro08(bios, ramcfg.data + 0x02) & 0x20))\r\nunk714 |= 0xf0000000;\r\nif (!(nv_ro08(bios, ramcfg.data + 0x02) & 0x04))\r\nunk714 |= 0x00000010;\r\nram_wr32(fuc, 0x100714, unk714);\r\nif (nv_ro08(bios, ramcfg.data + 0x02) & 0x01)\r\nunk71c |= 0x00000100;\r\nram_wr32(fuc, 0x10071c, unk71c);\r\nif (nv_ro08(bios, ramcfg.data + 0x02) & 0x02)\r\nunk718 |= 0x00000100;\r\nram_wr32(fuc, 0x100718, unk718);\r\nif (nv_ro08(bios, ramcfg.data + 0x02) & 0x10)\r\nram_wr32(fuc, 0x111100, 0x48000000);\r\nram_mask(fuc, mr[0], 0x100, 0x100);\r\nram_nsec(fuc, 1000);\r\nram_mask(fuc, mr[0], 0x100, 0x000);\r\nram_nsec(fuc, 1000);\r\nram_nsec(fuc, 2000);\r\nram_nsec(fuc, 12000);\r\nram_wr32(fuc, 0x611200, 0x00003330);\r\nif ( (nv_ro08(bios, rammap.data + 0x04) & 0x02))\r\nram_mask(fuc, 0x100200, 0x00000800, 0x00000800);\r\nif ( (nv_ro08(bios, ramcfg.data + 0x02) & 0x10)) {\r\nram_mask(fuc, 0x111104, 0x00000180, 0x00000180);\r\nram_mask(fuc, 0x111100, 0x40000000, 0x00000000);\r\n} else {\r\nram_mask(fuc, 0x111104, 0x00000600, 0x00000600);\r\n}\r\nif (mclk.pll) {\r\nram_mask(fuc, 0x004168, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x004168, 0x00000100, 0x00000000);\r\n} else {\r\nram_mask(fuc, 0x004000, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x004128, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x004128, 0x00000100, 0x00000000);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnva3_ram_prog(struct nouveau_fb *pfb)\r\n{\r\nstruct nouveau_device *device = nv_device(pfb);\r\nstruct nva3_ram *ram = (void *)pfb->ram;\r\nstruct nva3_ramfuc *fuc = &ram->fuc;\r\nram_exec(fuc, nouveau_boolopt(device->cfgopt, "NvMemExec", true));\r\nreturn 0;\r\n}\r\nstatic void\r\nnva3_ram_tidy(struct nouveau_fb *pfb)\r\n{\r\nstruct nva3_ram *ram = (void *)pfb->ram;\r\nstruct nva3_ramfuc *fuc = &ram->fuc;\r\nram_exec(fuc, false);\r\n}\r\nstatic int\r\nnva3_ram_init(struct nouveau_object *object)\r\n{\r\nstruct nouveau_fb *pfb = (void *)object->parent;\r\nstruct nva3_ram *ram = (void *)object;\r\nint ret, i;\r\nret = nouveau_ram_init(&ram->base);\r\nif (ret)\r\nreturn ret;\r\nswitch (ram->base.type) {\r\ncase NV_MEM_TYPE_DDR3: {\r\nif (nv_device(pfb)->chipset == 0xa8) {\r\nstatic const u32 pattern[16] = {\r\n0xaaaaaaaa, 0xcccccccc, 0xdddddddd, 0xeeeeeeee,\r\n0x00000000, 0x11111111, 0x44444444, 0xdddddddd,\r\n0x33333333, 0x55555555, 0x77777777, 0x66666666,\r\n0x99999999, 0x88888888, 0xeeeeeeee, 0xbbbbbbbb,\r\n};\r\nnv_wr32(pfb, 0x100538, 0x10001ff6);\r\nnv_wr32(pfb, 0x1005a8, 0x0000ffff);\r\nnv_mask(pfb, 0x10f800, 0x00000001, 0x00000001);\r\nfor (i = 0; i < 0x30; i++) {\r\nnv_wr32(pfb, 0x10f8c0, (i << 8) | i);\r\nnv_wr32(pfb, 0x10f8e0, (i << 8) | i);\r\nnv_wr32(pfb, 0x10f900, pattern[i % 16]);\r\nnv_wr32(pfb, 0x10f920, pattern[i % 16]);\r\n}\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnva3_ram_ctor(struct nouveau_object *parent, struct nouveau_object *engine,\r\nstruct nouveau_oclass *oclass, void *data, u32 datasize,\r\nstruct nouveau_object **pobject)\r\n{\r\nstruct nva3_ram *ram;\r\nint ret, i;\r\nret = nv50_ram_create(parent, engine, oclass, &ram);\r\n*pobject = nv_object(ram);\r\nif (ret)\r\nreturn ret;\r\nswitch (ram->base.type) {\r\ncase NV_MEM_TYPE_DDR3:\r\nram->base.calc = nva3_ram_calc;\r\nram->base.prog = nva3_ram_prog;\r\nram->base.tidy = nva3_ram_tidy;\r\nbreak;\r\ndefault:\r\nnv_warn(ram, "reclocking of this ram type unsupported\n");\r\nreturn 0;\r\n}\r\nram->fuc.r_0x004000 = ramfuc_reg(0x004000);\r\nram->fuc.r_0x004004 = ramfuc_reg(0x004004);\r\nram->fuc.r_0x004018 = ramfuc_reg(0x004018);\r\nram->fuc.r_0x004128 = ramfuc_reg(0x004128);\r\nram->fuc.r_0x004168 = ramfuc_reg(0x004168);\r\nram->fuc.r_0x100200 = ramfuc_reg(0x100200);\r\nram->fuc.r_0x100210 = ramfuc_reg(0x100210);\r\nfor (i = 0; i < 9; i++)\r\nram->fuc.r_0x100220[i] = ramfuc_reg(0x100220 + (i * 4));\r\nram->fuc.r_0x1002d0 = ramfuc_reg(0x1002d0);\r\nram->fuc.r_0x1002d4 = ramfuc_reg(0x1002d4);\r\nram->fuc.r_0x1002dc = ramfuc_reg(0x1002dc);\r\nram->fuc.r_0x10053c = ramfuc_reg(0x10053c);\r\nram->fuc.r_0x1005a0 = ramfuc_reg(0x1005a0);\r\nram->fuc.r_0x1005a4 = ramfuc_reg(0x1005a4);\r\nram->fuc.r_0x100714 = ramfuc_reg(0x100714);\r\nram->fuc.r_0x100718 = ramfuc_reg(0x100718);\r\nram->fuc.r_0x10071c = ramfuc_reg(0x10071c);\r\nram->fuc.r_0x100760 = ramfuc_reg(0x100760);\r\nram->fuc.r_0x1007a0 = ramfuc_reg(0x1007a0);\r\nram->fuc.r_0x1007e0 = ramfuc_reg(0x1007e0);\r\nram->fuc.r_0x10f804 = ramfuc_reg(0x10f804);\r\nram->fuc.r_0x1110e0 = ramfuc_reg(0x1110e0);\r\nram->fuc.r_0x111100 = ramfuc_reg(0x111100);\r\nram->fuc.r_0x111104 = ramfuc_reg(0x111104);\r\nram->fuc.r_0x611200 = ramfuc_reg(0x611200);\r\nif (ram->base.ranks > 1) {\r\nram->fuc.r_mr[0] = ramfuc_reg2(0x1002c0, 0x1002c8);\r\nram->fuc.r_mr[1] = ramfuc_reg2(0x1002c4, 0x1002cc);\r\nram->fuc.r_mr[2] = ramfuc_reg2(0x1002e0, 0x1002e8);\r\nram->fuc.r_mr[3] = ramfuc_reg2(0x1002e4, 0x1002ec);\r\n} else {\r\nram->fuc.r_mr[0] = ramfuc_reg(0x1002c0);\r\nram->fuc.r_mr[1] = ramfuc_reg(0x1002c4);\r\nram->fuc.r_mr[2] = ramfuc_reg(0x1002e0);\r\nram->fuc.r_mr[3] = ramfuc_reg(0x1002e4);\r\n}\r\nreturn 0;\r\n}

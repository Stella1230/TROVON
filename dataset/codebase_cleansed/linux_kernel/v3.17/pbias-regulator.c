static int pbias_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct pbias_regulator_data *drvdata;\r\nstruct resource *res;\r\nstruct regulator_config cfg = { };\r\nstruct regmap *syscon;\r\nconst struct pbias_reg_info *info;\r\nint ret = 0;\r\nint count, idx, data_idx = 0;\r\ncount = of_regulator_match(&pdev->dev, np, pbias_matches,\r\nPBIAS_NUM_REGS);\r\nif (count < 0)\r\nreturn count;\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(struct pbias_regulator_data)\r\n* count, GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nsyscon = syscon_regmap_lookup_by_phandle(np, "syscon");\r\nif (IS_ERR(syscon))\r\nreturn PTR_ERR(syscon);\r\ncfg.regmap = syscon;\r\ncfg.dev = &pdev->dev;\r\nfor (idx = 0; idx < PBIAS_NUM_REGS && data_idx < count; idx++) {\r\nif (!pbias_matches[idx].init_data ||\r\n!pbias_matches[idx].of_node)\r\ncontinue;\r\ninfo = pbias_matches[idx].driver_data;\r\nif (!info)\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EINVAL;\r\ndrvdata[data_idx].syscon = syscon;\r\ndrvdata[data_idx].info = info;\r\ndrvdata[data_idx].desc.name = info->name;\r\ndrvdata[data_idx].desc.owner = THIS_MODULE;\r\ndrvdata[data_idx].desc.type = REGULATOR_VOLTAGE;\r\ndrvdata[data_idx].desc.ops = &pbias_regulator_voltage_ops;\r\ndrvdata[data_idx].desc.volt_table = pbias_volt_table;\r\ndrvdata[data_idx].desc.n_voltages = 2;\r\ndrvdata[data_idx].desc.enable_time = info->enable_time;\r\ndrvdata[data_idx].desc.vsel_reg = res->start;\r\ndrvdata[data_idx].desc.vsel_mask = info->vmode;\r\ndrvdata[data_idx].desc.enable_reg = res->start;\r\ndrvdata[data_idx].desc.enable_mask = info->enable_mask;\r\ndrvdata[data_idx].desc.enable_val = info->enable;\r\ncfg.init_data = pbias_matches[idx].init_data;\r\ncfg.driver_data = &drvdata[data_idx];\r\ncfg.of_node = pbias_matches[idx].of_node;\r\ndrvdata[data_idx].dev = devm_regulator_register(&pdev->dev,\r\n&drvdata[data_idx].desc, &cfg);\r\nif (IS_ERR(drvdata[data_idx].dev)) {\r\nret = PTR_ERR(drvdata[data_idx].dev);\r\ndev_err(&pdev->dev,\r\n"Failed to register regulator: %d\n", ret);\r\ngoto err_regulator;\r\n}\r\ndata_idx++;\r\n}\r\nplatform_set_drvdata(pdev, drvdata);\r\nerr_regulator:\r\nreturn ret;\r\n}

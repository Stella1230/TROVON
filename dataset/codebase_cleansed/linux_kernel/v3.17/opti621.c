static void write_reg(u8 value, int reg)\r\n{\r\ninw(reg_base + 1);\r\ninw(reg_base + 1);\r\noutb(3, reg_base + 2);\r\noutb(value, reg_base + reg);\r\noutb(0x83, reg_base + 2);\r\n}\r\nstatic u8 read_reg(int reg)\r\n{\r\nu8 ret = 0;\r\ninw(reg_base + 1);\r\ninw(reg_base + 1);\r\noutb(3, reg_base + 2);\r\nret = inb(reg_base + reg);\r\noutb(0x83, reg_base + 2);\r\nreturn ret;\r\n}\r\nstatic void opti621_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nide_drive_t *pair = ide_get_pair_dev(drive);\r\nunsigned long flags;\r\nunsigned long mode = drive->pio_mode, pair_mode;\r\nconst u8 pio = mode - XFER_PIO_0;\r\nu8 tim, misc, addr_pio = pio, clk;\r\nstatic const u8 addr_timings[2][5] = {\r\n{ 0x20, 0x10, 0x00, 0x00, 0x00 },\r\n{ 0x10, 0x10, 0x00, 0x00, 0x00 },\r\n};\r\nstatic const u8 data_rec_timings[2][5] = {\r\n{ 0x5b, 0x45, 0x32, 0x21, 0x20 },\r\n{ 0x48, 0x34, 0x21, 0x10, 0x10 }\r\n};\r\nide_set_drivedata(drive, (void *)mode);\r\nif (pair) {\r\npair_mode = (unsigned long)ide_get_drivedata(pair);\r\nif (pair_mode && pair_mode < mode)\r\naddr_pio = pair_mode - XFER_PIO_0;\r\n}\r\nspin_lock_irqsave(&opti621_lock, flags);\r\nreg_base = hwif->io_ports.data_addr;\r\noutb(0xc0, reg_base + CNTRL_REG);\r\noutb(0xff, reg_base + 5);\r\n(void)inb(reg_base + CNTRL_REG);\r\nread_reg(CNTRL_REG);\r\nclk = read_reg(STRAP_REG) & 1;\r\nprintk(KERN_INFO "%s: CLK = %d MHz\n", hwif->name, clk ? 25 : 33);\r\ntim = data_rec_timings[clk][pio];\r\nmisc = addr_timings[clk][addr_pio];\r\nwrite_reg(drive->dn & 1, MISC_REG);\r\nwrite_reg(tim, READ_REG);\r\nwrite_reg(tim, WRITE_REG);\r\nwrite_reg(0x85, CNTRL_REG);\r\nwrite_reg(misc, MISC_REG);\r\nspin_unlock_irqrestore(&opti621_lock, flags);\r\n}\r\nstatic int opti621_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nreturn ide_pci_init_one(dev, &opti621_chipset, NULL);\r\n}\r\nstatic int __init opti621_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&opti621_pci_driver);\r\n}\r\nstatic void __exit opti621_ide_exit(void)\r\n{\r\npci_unregister_driver(&opti621_pci_driver);\r\n}

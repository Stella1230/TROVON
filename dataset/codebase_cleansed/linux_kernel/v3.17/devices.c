static int devinfo_show(struct seq_file *f, void *v)\r\n{\r\nint i = *(loff_t *) v;\r\nif (i < CHRDEV_MAJOR_HASH_SIZE) {\r\nif (i == 0)\r\nseq_puts(f, "Character devices:\n");\r\nchrdev_show(f, i);\r\n}\r\n#ifdef CONFIG_BLOCK\r\nelse {\r\ni -= CHRDEV_MAJOR_HASH_SIZE;\r\nif (i == 0)\r\nseq_puts(f, "\nBlock devices:\n");\r\nblkdev_show(f, i);\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void *devinfo_start(struct seq_file *f, loff_t *pos)\r\n{\r\nif (*pos < (BLKDEV_MAJOR_HASH_SIZE + CHRDEV_MAJOR_HASH_SIZE))\r\nreturn pos;\r\nreturn NULL;\r\n}\r\nstatic void *devinfo_next(struct seq_file *f, void *v, loff_t *pos)\r\n{\r\n(*pos)++;\r\nif (*pos >= (BLKDEV_MAJOR_HASH_SIZE + CHRDEV_MAJOR_HASH_SIZE))\r\nreturn NULL;\r\nreturn pos;\r\n}\r\nstatic void devinfo_stop(struct seq_file *f, void *v)\r\n{\r\n}\r\nstatic int devinfo_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn seq_open(filp, &devinfo_ops);\r\n}\r\nstatic int __init proc_devices_init(void)\r\n{\r\nproc_create("devices", 0, NULL, &proc_devinfo_operations);\r\nreturn 0;\r\n}

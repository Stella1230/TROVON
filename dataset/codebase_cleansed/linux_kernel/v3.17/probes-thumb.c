static unsigned long __kprobes thumb_check_cc(unsigned long cpsr)\r\n{\r\nif (unlikely(in_it_block(cpsr)))\r\nreturn probes_condition_checks[current_cond(cpsr)](cpsr);\r\nreturn true;\r\n}\r\nstatic void __kprobes thumb16_singlestep(probes_opcode_t opcode,\r\nstruct arch_probes_insn *asi,\r\nstruct pt_regs *regs)\r\n{\r\nregs->ARM_pc += 2;\r\nasi->insn_handler(opcode, asi, regs);\r\nregs->ARM_cpsr = it_advance(regs->ARM_cpsr);\r\n}\r\nstatic void __kprobes thumb32_singlestep(probes_opcode_t opcode,\r\nstruct arch_probes_insn *asi,\r\nstruct pt_regs *regs)\r\n{\r\nregs->ARM_pc += 4;\r\nasi->insn_handler(opcode, asi, regs);\r\nregs->ARM_cpsr = it_advance(regs->ARM_cpsr);\r\n}\r\nenum probes_insn __kprobes\r\nthumb16_probes_decode_insn(probes_opcode_t insn, struct arch_probes_insn *asi,\r\nbool emulate, const union decode_action *actions)\r\n{\r\nasi->insn_singlestep = thumb16_singlestep;\r\nasi->insn_check_cc = thumb_check_cc;\r\nreturn probes_decode_insn(insn, asi, probes_decode_thumb16_table, true,\r\nemulate, actions);\r\n}\r\nenum probes_insn __kprobes\r\nthumb32_probes_decode_insn(probes_opcode_t insn, struct arch_probes_insn *asi,\r\nbool emulate, const union decode_action *actions)\r\n{\r\nasi->insn_singlestep = thumb32_singlestep;\r\nasi->insn_check_cc = thumb_check_cc;\r\nreturn probes_decode_insn(insn, asi, probes_decode_thumb32_table, true,\r\nemulate, actions);\r\n}

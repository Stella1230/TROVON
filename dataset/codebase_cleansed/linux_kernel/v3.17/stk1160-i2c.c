static int stk1160_i2c_busy_wait(struct stk1160 *dev, u8 wait_bit_mask)\r\n{\r\nunsigned long end;\r\nu8 flag;\r\nend = jiffies + msecs_to_jiffies(STK1160_I2C_TIMEOUT);\r\nwhile (time_is_after_jiffies(end)) {\r\nstk1160_read_reg(dev, STK1160_SICTL+1, &flag);\r\nif (flag & wait_bit_mask)\r\ngoto done;\r\nusleep_range(10 * USEC_PER_MSEC, 20 * USEC_PER_MSEC);\r\n}\r\nreturn -ETIMEDOUT;\r\ndone:\r\nreturn 0;\r\n}\r\nstatic int stk1160_i2c_write_reg(struct stk1160 *dev, u8 addr,\r\nu8 reg, u8 value)\r\n{\r\nint rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL_SDA, addr);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SBUSW_WA, reg);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SBUSW_WD, value);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL, 0x01);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_i2c_busy_wait(dev, 0x04);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int stk1160_i2c_read_reg(struct stk1160 *dev, u8 addr,\r\nu8 reg, u8 *value)\r\n{\r\nint rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL_SDA, addr);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SBUSR_RA, reg);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL, 0x20);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_i2c_busy_wait(dev, 0x01);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_read_reg(dev, STK1160_SBUSR_RD, value);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int stk1160_i2c_check_for_device(struct stk1160 *dev,\r\nunsigned char addr)\r\n{\r\nint rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL_SDA, addr);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SBUSR_RA, 0x00);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_write_reg(dev, STK1160_SICTL, 0x20);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = stk1160_i2c_busy_wait(dev, 0x01);\r\nif (rc < 0)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int stk1160_i2c_xfer(struct i2c_adapter *i2c_adap,\r\nstruct i2c_msg msgs[], int num)\r\n{\r\nstruct stk1160 *dev = i2c_adap->algo_data;\r\nint addr, rc, i;\r\nfor (i = 0; i < num; i++) {\r\naddr = msgs[i].addr << 1;\r\ndprintk_i2c("%s: addr=%x", __func__, addr);\r\nif (!msgs[i].len) {\r\nrc = stk1160_i2c_check_for_device(dev, addr);\r\nif (rc < 0) {\r\ndprintk_i2c(" no device\n");\r\nreturn rc;\r\n}\r\n} else if (msgs[i].flags & I2C_M_RD) {\r\ndprintk_i2c(" subaddr not selected");\r\nrc = -EOPNOTSUPP;\r\ngoto err;\r\n} else if (i + 1 < num && msgs[i].len <= 2 &&\r\n(msgs[i + 1].flags & I2C_M_RD) &&\r\nmsgs[i].addr == msgs[i + 1].addr) {\r\nif (msgs[i].len != 1 || msgs[i + 1].len != 1) {\r\ndprintk_i2c(" len not supported");\r\nrc = -EOPNOTSUPP;\r\ngoto err;\r\n}\r\ndprintk_i2c(" subaddr=%x", msgs[i].buf[0]);\r\nrc = stk1160_i2c_read_reg(dev, addr, msgs[i].buf[0],\r\nmsgs[i + 1].buf);\r\ndprintk_i2c(" read=%x", *msgs[i + 1].buf);\r\ni++;\r\n} else {\r\nif (msgs[i].len != 2) {\r\ndprintk_i2c(" len not supported");\r\nrc = -EOPNOTSUPP;\r\ngoto err;\r\n}\r\ndprintk_i2c(" subaddr=%x write=%x",\r\nmsgs[i].buf[0], msgs[i].buf[1]);\r\nrc = stk1160_i2c_write_reg(dev, addr, msgs[i].buf[0],\r\nmsgs[i].buf[1]);\r\n}\r\nif (rc < 0)\r\ngoto err;\r\ndprintk_i2c(" OK\n");\r\n}\r\nreturn num;\r\nerr:\r\ndprintk_i2c(" ERROR: %d\n", rc);\r\nreturn num;\r\n}\r\nstatic u32 functionality(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL;\r\n}\r\nint stk1160_i2c_register(struct stk1160 *dev)\r\n{\r\nint rc;\r\ndev->i2c_adap = adap_template;\r\ndev->i2c_adap.dev.parent = dev->dev;\r\nstrcpy(dev->i2c_adap.name, "stk1160");\r\ndev->i2c_adap.algo_data = dev;\r\ni2c_set_adapdata(&dev->i2c_adap, &dev->v4l2_dev);\r\nrc = i2c_add_adapter(&dev->i2c_adap);\r\nif (rc < 0) {\r\nstk1160_err("cannot add i2c adapter (%d)\n", rc);\r\nreturn rc;\r\n}\r\ndev->i2c_client = client_template;\r\ndev->i2c_client.adapter = &dev->i2c_adap;\r\nstk1160_write_reg(dev, STK1160_SICTL_CD, 0x0f);\r\nstk1160_write_reg(dev, STK1160_ASIC + 3, 0x00);\r\nreturn 0;\r\n}\r\nint stk1160_i2c_unregister(struct stk1160 *dev)\r\n{\r\ni2c_del_adapter(&dev->i2c_adap);\r\nreturn 0;\r\n}

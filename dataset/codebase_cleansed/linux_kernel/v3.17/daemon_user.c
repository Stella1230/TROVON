static struct sockaddr_un *new_addr(void *name, int len)\r\n{\r\nstruct sockaddr_un *sun;\r\nsun = uml_kmalloc(sizeof(struct sockaddr_un), UM_GFP_KERNEL);\r\nif (sun == NULL) {\r\nprintk(UM_KERN_ERR "new_addr: allocation of sockaddr_un "\r\n"failed\n");\r\nreturn NULL;\r\n}\r\nsun->sun_family = AF_UNIX;\r\nmemcpy(sun->sun_path, name, len);\r\nreturn sun;\r\n}\r\nstatic int connect_to_switch(struct daemon_data *pri)\r\n{\r\nstruct sockaddr_un *ctl_addr = pri->ctl_addr;\r\nstruct sockaddr_un *local_addr = pri->local_addr;\r\nstruct sockaddr_un *sun;\r\nstruct request_v3 req;\r\nint fd, n, err;\r\npri->control = socket(AF_UNIX, SOCK_STREAM, 0);\r\nif (pri->control < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "daemon_open : control socket failed, "\r\n"errno = %d\n", -err);\r\nreturn err;\r\n}\r\nif (connect(pri->control, (struct sockaddr *) ctl_addr,\r\nsizeof(*ctl_addr)) < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "daemon_open : control connect failed, "\r\n"errno = %d\n", -err);\r\ngoto out;\r\n}\r\nfd = socket(AF_UNIX, SOCK_DGRAM, 0);\r\nif (fd < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "daemon_open : data socket failed, "\r\n"errno = %d\n", -err);\r\ngoto out;\r\n}\r\nif (bind(fd, (struct sockaddr *) local_addr, sizeof(*local_addr)) < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "daemon_open : data bind failed, "\r\n"errno = %d\n", -err);\r\ngoto out_close;\r\n}\r\nsun = uml_kmalloc(sizeof(struct sockaddr_un), UM_GFP_KERNEL);\r\nif (sun == NULL) {\r\nprintk(UM_KERN_ERR "new_addr: allocation of sockaddr_un "\r\n"failed\n");\r\nerr = -ENOMEM;\r\ngoto out_close;\r\n}\r\nreq.magic = SWITCH_MAGIC;\r\nreq.version = SWITCH_VERSION;\r\nreq.type = REQ_NEW_CONTROL;\r\nreq.sock = *local_addr;\r\nn = write(pri->control, &req, sizeof(req));\r\nif (n != sizeof(req)) {\r\nprintk(UM_KERN_ERR "daemon_open : control setup request "\r\n"failed, err = %d\n", -errno);\r\nerr = -ENOTCONN;\r\ngoto out_free;\r\n}\r\nn = read(pri->control, sun, sizeof(*sun));\r\nif (n != sizeof(*sun)) {\r\nprintk(UM_KERN_ERR "daemon_open : read of data socket failed, "\r\n"err = %d\n", -errno);\r\nerr = -ENOTCONN;\r\ngoto out_free;\r\n}\r\npri->data_addr = sun;\r\nreturn fd;\r\nout_free:\r\nkfree(sun);\r\nout_close:\r\nclose(fd);\r\nout:\r\nclose(pri->control);\r\nreturn err;\r\n}\r\nstatic int daemon_user_init(void *data, void *dev)\r\n{\r\nstruct daemon_data *pri = data;\r\nstruct timeval tv;\r\nstruct {\r\nchar zero;\r\nint pid;\r\nint usecs;\r\n} name;\r\nif (!strcmp(pri->sock_type, "unix"))\r\npri->ctl_addr = new_addr(pri->ctl_sock,\r\nstrlen(pri->ctl_sock) + 1);\r\nname.zero = 0;\r\nname.pid = os_getpid();\r\ngettimeofday(&tv, NULL);\r\nname.usecs = tv.tv_usec;\r\npri->local_addr = new_addr(&name, sizeof(name));\r\npri->dev = dev;\r\npri->fd = connect_to_switch(pri);\r\nif (pri->fd < 0) {\r\nkfree(pri->local_addr);\r\npri->local_addr = NULL;\r\nreturn pri->fd;\r\n}\r\nreturn 0;\r\n}\r\nstatic int daemon_open(void *data)\r\n{\r\nstruct daemon_data *pri = data;\r\nreturn pri->fd;\r\n}\r\nstatic void daemon_remove(void *data)\r\n{\r\nstruct daemon_data *pri = data;\r\nclose(pri->fd);\r\npri->fd = -1;\r\nclose(pri->control);\r\npri->control = -1;\r\nkfree(pri->data_addr);\r\npri->data_addr = NULL;\r\nkfree(pri->ctl_addr);\r\npri->ctl_addr = NULL;\r\nkfree(pri->local_addr);\r\npri->local_addr = NULL;\r\n}\r\nint daemon_user_write(int fd, void *buf, int len, struct daemon_data *pri)\r\n{\r\nstruct sockaddr_un *data_addr = pri->data_addr;\r\nreturn net_sendto(fd, buf, len, data_addr, sizeof(*data_addr));\r\n}

static unsigned int sdhci_arasan_get_timeout_clock(struct sdhci_host *host)\r\n{\r\nu32 div;\r\nunsigned long freq;\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\ndiv = readl(host->ioaddr + SDHCI_ARASAN_CLK_CTRL_OFFSET);\r\ndiv = (div & CLK_CTRL_TIMEOUT_MASK) >> CLK_CTRL_TIMEOUT_SHIFT;\r\nfreq = clk_get_rate(pltfm_host->clk);\r\nfreq /= 1 << (CLK_CTRL_TIMEOUT_MIN_EXP + div);\r\nreturn freq;\r\n}\r\nstatic int sdhci_arasan_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_arasan_data *sdhci_arasan = pltfm_host->priv;\r\nint ret;\r\nret = sdhci_suspend_host(host);\r\nif (ret)\r\nreturn ret;\r\nclk_disable(pltfm_host->clk);\r\nclk_disable(sdhci_arasan->clk_ahb);\r\nreturn 0;\r\n}\r\nstatic int sdhci_arasan_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_arasan_data *sdhci_arasan = pltfm_host->priv;\r\nint ret;\r\nret = clk_enable(sdhci_arasan->clk_ahb);\r\nif (ret) {\r\ndev_err(dev, "Cannot enable AHB clock.\n");\r\nreturn ret;\r\n}\r\nret = clk_enable(pltfm_host->clk);\r\nif (ret) {\r\ndev_err(dev, "Cannot enable SD clock.\n");\r\nclk_disable(sdhci_arasan->clk_ahb);\r\nreturn ret;\r\n}\r\nreturn sdhci_resume_host(host);\r\n}\r\nstatic int sdhci_arasan_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct clk *clk_xin;\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct sdhci_arasan_data *sdhci_arasan;\r\nsdhci_arasan = devm_kzalloc(&pdev->dev, sizeof(*sdhci_arasan),\r\nGFP_KERNEL);\r\nif (!sdhci_arasan)\r\nreturn -ENOMEM;\r\nsdhci_arasan->clk_ahb = devm_clk_get(&pdev->dev, "clk_ahb");\r\nif (IS_ERR(sdhci_arasan->clk_ahb)) {\r\ndev_err(&pdev->dev, "clk_ahb clock not found.\n");\r\nreturn PTR_ERR(sdhci_arasan->clk_ahb);\r\n}\r\nclk_xin = devm_clk_get(&pdev->dev, "clk_xin");\r\nif (IS_ERR(clk_xin)) {\r\ndev_err(&pdev->dev, "clk_xin clock not found.\n");\r\nreturn PTR_ERR(clk_xin);\r\n}\r\nret = clk_prepare_enable(sdhci_arasan->clk_ahb);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Unable to enable AHB clock.\n");\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(clk_xin);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Unable to enable SD clock.\n");\r\ngoto clk_dis_ahb;\r\n}\r\nhost = sdhci_pltfm_init(pdev, &sdhci_arasan_pdata, 0);\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ndev_err(&pdev->dev, "platform init failed (%u)\n", ret);\r\ngoto clk_disable_all;\r\n}\r\nsdhci_get_of_property(pdev);\r\npltfm_host = sdhci_priv(host);\r\npltfm_host->priv = sdhci_arasan;\r\npltfm_host->clk = clk_xin;\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_err(&pdev->dev, "platform register failed (%u)\n", ret);\r\ngoto err_pltfm_free;\r\n}\r\nreturn 0;\r\nerr_pltfm_free:\r\nsdhci_pltfm_free(pdev);\r\nclk_disable_all:\r\nclk_disable_unprepare(clk_xin);\r\nclk_dis_ahb:\r\nclk_disable_unprepare(sdhci_arasan->clk_ahb);\r\nreturn ret;\r\n}\r\nstatic int sdhci_arasan_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_arasan_data *sdhci_arasan = pltfm_host->priv;\r\nclk_disable_unprepare(pltfm_host->clk);\r\nclk_disable_unprepare(sdhci_arasan->clk_ahb);\r\nreturn sdhci_pltfm_unregister(pdev);\r\n}

static void do_stack_trace(unsigned long *sp, unsigned long bp)\r\n{\r\nint reliable;\r\nunsigned long addr;\r\nstruct stack_frame *frame = (struct stack_frame *)bp;\r\nprintk(KERN_INFO "Call Trace:\n");\r\nwhile (((long) sp & (THREAD_SIZE-1)) != 0) {\r\naddr = *sp;\r\nif (__kernel_text_address(addr)) {\r\nreliable = 0;\r\nif ((unsigned long) sp == bp + sizeof(long)) {\r\nframe = frame ? frame->next_frame : NULL;\r\nbp = (unsigned long)frame;\r\nreliable = 1;\r\n}\r\nprintk(KERN_INFO " [<%08lx>]", addr);\r\nprintk(KERN_CONT " %s", reliable ? "" : "? ");\r\nprint_symbol(KERN_CONT "%s", addr);\r\nprintk(KERN_CONT "\n");\r\n}\r\nsp++;\r\n}\r\nprintk(KERN_INFO "\n");\r\n}\r\nstatic unsigned long get_frame_pointer(struct task_struct *task,\r\nstruct pt_regs *segv_regs)\r\n{\r\nif (!task || task == current)\r\nreturn segv_regs ? PT_REGS_BP(segv_regs) : current_bp();\r\nelse\r\nreturn KSTK_EBP(task);\r\n}\r\nstatic unsigned long *get_stack_pointer(struct task_struct *task,\r\nstruct pt_regs *segv_regs)\r\n{\r\nif (!task || task == current)\r\nreturn segv_regs ? (unsigned long *)PT_REGS_SP(segv_regs) : current_sp();\r\nelse\r\nreturn (unsigned long *)KSTK_ESP(task);\r\n}\r\nvoid show_stack(struct task_struct *task, unsigned long *stack)\r\n{\r\nunsigned long *sp = stack, bp = 0;\r\nstruct pt_regs *segv_regs = current->thread.segv_regs;\r\nint i;\r\nif (!segv_regs && os_is_signal_stack()) {\r\nprintk(KERN_ERR "Received SIGSEGV in SIGSEGV handler,"\r\n" aborting stack trace!\n");\r\nreturn;\r\n}\r\n#ifdef CONFIG_FRAME_POINTER\r\nbp = get_frame_pointer(task, segv_regs);\r\n#endif\r\nif (!stack)\r\nsp = get_stack_pointer(task, segv_regs);\r\nprintk(KERN_INFO "Stack:\n");\r\nstack = sp;\r\nfor (i = 0; i < 3 * STACKSLOTS_PER_LINE; i++) {\r\nif (kstack_end(stack))\r\nbreak;\r\nif (i && ((i % STACKSLOTS_PER_LINE) == 0))\r\nprintk(KERN_CONT "\n");\r\nprintk(KERN_CONT " %08lx", *stack++);\r\n}\r\nprintk(KERN_CONT "\n");\r\ndo_stack_trace(sp, bp);\r\n}

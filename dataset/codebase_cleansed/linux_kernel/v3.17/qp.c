void mlx5_qp_event(struct mlx5_core_dev *dev, u32 qpn, int event_type)\r\n{\r\nstruct mlx5_qp_table *table = &dev->priv.qp_table;\r\nstruct mlx5_core_qp *qp;\r\nspin_lock(&table->lock);\r\nqp = radix_tree_lookup(&table->tree, qpn);\r\nif (qp)\r\natomic_inc(&qp->refcount);\r\nspin_unlock(&table->lock);\r\nif (!qp) {\r\nmlx5_core_warn(dev, "Async event for bogus QP 0x%x\n", qpn);\r\nreturn;\r\n}\r\nqp->event(qp, event_type);\r\nif (atomic_dec_and_test(&qp->refcount))\r\ncomplete(&qp->free);\r\n}\r\nint mlx5_core_create_qp(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_qp *qp,\r\nstruct mlx5_create_qp_mbox_in *in,\r\nint inlen)\r\n{\r\nstruct mlx5_qp_table *table = &dev->priv.qp_table;\r\nstruct mlx5_create_qp_mbox_out out;\r\nstruct mlx5_destroy_qp_mbox_in din;\r\nstruct mlx5_destroy_qp_mbox_out dout;\r\nint err;\r\nmemset(&out, 0, sizeof(out));\r\nin->hdr.opcode = cpu_to_be16(MLX5_CMD_OP_CREATE_QP);\r\nerr = mlx5_cmd_exec(dev, in, inlen, &out, sizeof(out));\r\nif (err) {\r\nmlx5_core_warn(dev, "ret %d\n", err);\r\nreturn err;\r\n}\r\nif (out.hdr.status) {\r\nmlx5_core_warn(dev, "current num of QPs 0x%x\n",\r\natomic_read(&dev->num_qps));\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\n}\r\nqp->qpn = be32_to_cpu(out.qpn) & 0xffffff;\r\nmlx5_core_dbg(dev, "qpn = 0x%x\n", qp->qpn);\r\nspin_lock_irq(&table->lock);\r\nerr = radix_tree_insert(&table->tree, qp->qpn, qp);\r\nspin_unlock_irq(&table->lock);\r\nif (err) {\r\nmlx5_core_warn(dev, "err %d\n", err);\r\ngoto err_cmd;\r\n}\r\nerr = mlx5_debug_qp_add(dev, qp);\r\nif (err)\r\nmlx5_core_dbg(dev, "failed adding QP 0x%x to debug file system\n",\r\nqp->qpn);\r\nqp->pid = current->pid;\r\natomic_set(&qp->refcount, 1);\r\natomic_inc(&dev->num_qps);\r\ninit_completion(&qp->free);\r\nreturn 0;\r\nerr_cmd:\r\nmemset(&din, 0, sizeof(din));\r\nmemset(&dout, 0, sizeof(dout));\r\ndin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_QP);\r\ndin.qpn = cpu_to_be32(qp->qpn);\r\nmlx5_cmd_exec(dev, &din, sizeof(din), &out, sizeof(dout));\r\nreturn err;\r\n}\r\nint mlx5_core_destroy_qp(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_qp *qp)\r\n{\r\nstruct mlx5_destroy_qp_mbox_in in;\r\nstruct mlx5_destroy_qp_mbox_out out;\r\nstruct mlx5_qp_table *table = &dev->priv.qp_table;\r\nunsigned long flags;\r\nint err;\r\nmlx5_debug_qp_remove(dev, qp);\r\nspin_lock_irqsave(&table->lock, flags);\r\nradix_tree_delete(&table->tree, qp->qpn);\r\nspin_unlock_irqrestore(&table->lock, flags);\r\nif (atomic_dec_and_test(&qp->refcount))\r\ncomplete(&qp->free);\r\nwait_for_completion(&qp->free);\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_QP);\r\nin.qpn = cpu_to_be32(qp->qpn);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\natomic_dec(&dev->num_qps);\r\nreturn 0;\r\n}\r\nint mlx5_core_qp_modify(struct mlx5_core_dev *dev, enum mlx5_qp_state cur_state,\r\nenum mlx5_qp_state new_state,\r\nstruct mlx5_modify_qp_mbox_in *in, int sqd_event,\r\nstruct mlx5_core_qp *qp)\r\n{\r\nstatic const u16 optab[MLX5_QP_NUM_STATE][MLX5_QP_NUM_STATE] = {\r\n[MLX5_QP_STATE_RST] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_INIT] = MLX5_CMD_OP_RST2INIT_QP,\r\n},\r\n[MLX5_QP_STATE_INIT] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_INIT] = MLX5_CMD_OP_INIT2INIT_QP,\r\n[MLX5_QP_STATE_RTR] = MLX5_CMD_OP_INIT2RTR_QP,\r\n},\r\n[MLX5_QP_STATE_RTR] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_RTS] = MLX5_CMD_OP_RTR2RTS_QP,\r\n},\r\n[MLX5_QP_STATE_RTS] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_RTS] = MLX5_CMD_OP_RTS2RTS_QP,\r\n[MLX5_QP_STATE_SQD] = MLX5_CMD_OP_RTS2SQD_QP,\r\n},\r\n[MLX5_QP_STATE_SQD] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_RTS] = MLX5_CMD_OP_SQD2RTS_QP,\r\n[MLX5_QP_STATE_SQD] = MLX5_CMD_OP_SQD2SQD_QP,\r\n},\r\n[MLX5_QP_STATE_SQER] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n[MLX5_QP_STATE_RTS] = MLX5_CMD_OP_SQERR2RTS_QP,\r\n},\r\n[MLX5_QP_STATE_ERR] = {\r\n[MLX5_QP_STATE_RST] = MLX5_CMD_OP_2RST_QP,\r\n[MLX5_QP_STATE_ERR] = MLX5_CMD_OP_2ERR_QP,\r\n}\r\n};\r\nstruct mlx5_modify_qp_mbox_out out;\r\nint err = 0;\r\nu16 op;\r\nif (cur_state >= MLX5_QP_NUM_STATE || new_state >= MLX5_QP_NUM_STATE ||\r\n!optab[cur_state][new_state])\r\nreturn -EINVAL;\r\nmemset(&out, 0, sizeof(out));\r\nop = optab[cur_state][new_state];\r\nin->hdr.opcode = cpu_to_be16(op);\r\nin->qpn = cpu_to_be32(qp->qpn);\r\nerr = mlx5_cmd_exec(dev, in, sizeof(*in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\n}\r\nvoid mlx5_init_qp_table(struct mlx5_core_dev *dev)\r\n{\r\nstruct mlx5_qp_table *table = &dev->priv.qp_table;\r\nspin_lock_init(&table->lock);\r\nINIT_RADIX_TREE(&table->tree, GFP_ATOMIC);\r\nmlx5_qp_debugfs_init(dev);\r\n}\r\nvoid mlx5_cleanup_qp_table(struct mlx5_core_dev *dev)\r\n{\r\nmlx5_qp_debugfs_cleanup(dev);\r\n}\r\nint mlx5_core_qp_query(struct mlx5_core_dev *dev, struct mlx5_core_qp *qp,\r\nstruct mlx5_query_qp_mbox_out *out, int outlen)\r\n{\r\nstruct mlx5_query_qp_mbox_in in;\r\nint err;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(out, 0, outlen);\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_QUERY_QP);\r\nin.qpn = cpu_to_be32(qp->qpn);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), out, outlen);\r\nif (err)\r\nreturn err;\r\nif (out->hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out->hdr);\r\nreturn err;\r\n}\r\nint mlx5_core_xrcd_alloc(struct mlx5_core_dev *dev, u32 *xrcdn)\r\n{\r\nstruct mlx5_alloc_xrcd_mbox_in in;\r\nstruct mlx5_alloc_xrcd_mbox_out out;\r\nint err;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_ALLOC_XRCD);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nerr = mlx5_cmd_status_to_err(&out.hdr);\r\nelse\r\n*xrcdn = be32_to_cpu(out.xrcdn);\r\nreturn err;\r\n}\r\nint mlx5_core_xrcd_dealloc(struct mlx5_core_dev *dev, u32 xrcdn)\r\n{\r\nstruct mlx5_dealloc_xrcd_mbox_in in;\r\nstruct mlx5_dealloc_xrcd_mbox_out out;\r\nint err;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DEALLOC_XRCD);\r\nin.xrcdn = cpu_to_be32(xrcdn);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nerr = mlx5_cmd_status_to_err(&out.hdr);\r\nreturn err;\r\n}

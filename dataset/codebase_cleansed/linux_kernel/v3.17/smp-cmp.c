static void cmp_init_secondary(void)\r\n{\r\nstruct cpuinfo_mips *c __maybe_unused = &current_cpu_data;\r\nchange_c0_status(ST0_IM, STATUSF_IP3 | STATUSF_IP4 | STATUSF_IP6 |\r\nSTATUSF_IP7);\r\n#ifdef CONFIG_MIPS_MT_SMP\r\nif (cpu_has_mipsmt)\r\nc->vpe_id = (read_c0_tcbind() >> TCBIND_CURVPE_SHIFT) &\r\nTCBIND_CURVPE;\r\n#endif\r\n}\r\nstatic void cmp_smp_finish(void)\r\n{\r\npr_debug("SMPCMP: CPU%d: %s\n", smp_processor_id(), __func__);\r\nwrite_c0_compare(read_c0_count() + (8 * mips_hpt_frequency / HZ));\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(smp_processor_id(), mt_fpu_cpumask);\r\n#endif\r\nlocal_irq_enable();\r\n}\r\nstatic void cmp_boot_secondary(int cpu, struct task_struct *idle)\r\n{\r\nstruct thread_info *gp = task_thread_info(idle);\r\nunsigned long sp = __KSTK_TOS(idle);\r\nunsigned long pc = (unsigned long)&smp_bootstrap;\r\nunsigned long a0 = 0;\r\npr_debug("SMPCMP: CPU%d: %s cpu %d\n", smp_processor_id(),\r\n__func__, cpu);\r\n#if 0\r\nflush_icache_range((unsigned long)gp,\r\n(unsigned long)(gp + sizeof(struct thread_info)));\r\n#endif\r\namon_cpu_start(cpu, pc, sp, (unsigned long)gp, a0);\r\n}\r\nvoid __init cmp_smp_setup(void)\r\n{\r\nint i;\r\nint ncpu = 0;\r\npr_debug("SMPCMP: CPU%d: %s\n", smp_processor_id(), __func__);\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(0, mt_fpu_cpumask);\r\n#endif\r\nfor (i = 1; i < NR_CPUS; i++) {\r\nif (amon_cpu_avail(i)) {\r\nset_cpu_possible(i, true);\r\n__cpu_number_map[i] = ++ncpu;\r\n__cpu_logical_map[ncpu] = i;\r\n}\r\n}\r\nif (cpu_has_mipsmt) {\r\nunsigned int nvpe = 1;\r\n#ifdef CONFIG_MIPS_MT_SMP\r\nunsigned int mvpconf0 = read_c0_mvpconf0();\r\nnvpe = ((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT) + 1;\r\n#endif\r\nsmp_num_siblings = nvpe;\r\n}\r\npr_info("Detected %i available secondary CPU(s)\n", ncpu);\r\n}\r\nvoid __init cmp_prepare_cpus(unsigned int max_cpus)\r\n{\r\npr_debug("SMPCMP: CPU%d: %s max_cpus=%d\n",\r\nsmp_processor_id(), __func__, max_cpus);\r\n#ifdef CONFIG_MIPS_MT\r\nmips_mt_set_cpuoptions();\r\n#endif\r\n}

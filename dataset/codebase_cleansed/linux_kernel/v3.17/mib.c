void STAvClearAllCounter(PSStatCounter pStatistic)\r\n{\r\nmemset(pStatistic, 0, sizeof(SStatCounter));\r\n}\r\nvoid STAvUpdateIsrStatCounter(PSStatCounter pStatistic, unsigned long dwIsr)\r\n{\r\nif (dwIsr == 0) {\r\npStatistic->ISRStat.dwIsrUnknown++;\r\nreturn;\r\n}\r\nif (dwIsr & ISR_TXDMA0)\r\npStatistic->ISRStat.dwIsrTx0OK++;\r\nif (dwIsr & ISR_AC0DMA)\r\npStatistic->ISRStat.dwIsrAC0TxOK++;\r\nif (dwIsr & ISR_BNTX)\r\npStatistic->ISRStat.dwIsrBeaconTxOK++;\r\nif (dwIsr & ISR_RXDMA0)\r\npStatistic->ISRStat.dwIsrRx0OK++;\r\nif (dwIsr & ISR_TBTT)\r\npStatistic->ISRStat.dwIsrTBTTInt++;\r\nif (dwIsr & ISR_SOFTTIMER)\r\npStatistic->ISRStat.dwIsrSTIMERInt++;\r\nif (dwIsr & ISR_WATCHDOG)\r\npStatistic->ISRStat.dwIsrWatchDog++;\r\nif (dwIsr & ISR_FETALERR)\r\npStatistic->ISRStat.dwIsrUnrecoverableError++;\r\nif (dwIsr & ISR_SOFTINT)\r\npStatistic->ISRStat.dwIsrSoftInterrupt++;\r\nif (dwIsr & ISR_MIBNEARFULL)\r\npStatistic->ISRStat.dwIsrMIBNearfull++;\r\nif (dwIsr & ISR_RXNOBUF)\r\npStatistic->ISRStat.dwIsrRxNoBuf++;\r\nif (dwIsr & ISR_RXDMA1)\r\npStatistic->ISRStat.dwIsrRx1OK++;\r\nif (dwIsr & ISR_SOFTTIMER1)\r\npStatistic->ISRStat.dwIsrSTIMER1Int++;\r\n}\r\nvoid STAvUpdateRDStatCounter(PSStatCounter pStatistic,\r\nunsigned char byRSR, unsigned char byNewRSR, unsigned char byRxRate,\r\nunsigned char *pbyBuffer, unsigned int cbFrameLength)\r\n{\r\nPS802_11Header pHeader = (PS802_11Header)pbyBuffer;\r\nif (byRSR & RSR_ADDROK)\r\npStatistic->dwRsrADDROk++;\r\nif (byRSR & RSR_CRCOK) {\r\npStatistic->dwRsrCRCOk++;\r\npStatistic->ullRsrOK++;\r\nif (cbFrameLength >= ETH_ALEN) {\r\nif (byRSR & RSR_ADDRBROAD) {\r\npStatistic->ullRxBroadcastFrames++;\r\npStatistic->ullRxBroadcastBytes += (unsigned long long) cbFrameLength;\r\n} else if (byRSR & RSR_ADDRMULTI) {\r\npStatistic->ullRxMulticastFrames++;\r\npStatistic->ullRxMulticastBytes += (unsigned long long) cbFrameLength;\r\n} else {\r\npStatistic->ullRxDirectedFrames++;\r\npStatistic->ullRxDirectedBytes += (unsigned long long) cbFrameLength;\r\n}\r\n}\r\n}\r\nif (byRxRate == 22) {\r\npStatistic->CustomStat.ullRsr11M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr11MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "11M: ALL[%d], OK[%d]:[%02x]\n", (int)pStatistic->CustomStat.ullRsr11M, (int)pStatistic->CustomStat.ullRsr11MCRCOk, byRSR);\r\n} else if (byRxRate == 11) {\r\npStatistic->CustomStat.ullRsr5M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr5MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " 5M: ALL[%d], OK[%d]:[%02x]\n", (int)pStatistic->CustomStat.ullRsr5M, (int)pStatistic->CustomStat.ullRsr5MCRCOk, byRSR);\r\n} else if (byRxRate == 4) {\r\npStatistic->CustomStat.ullRsr2M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr2MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " 2M: ALL[%d], OK[%d]:[%02x]\n", (int)pStatistic->CustomStat.ullRsr2M, (int)pStatistic->CustomStat.ullRsr2MCRCOk, byRSR);\r\n} else if (byRxRate == 2) {\r\npStatistic->CustomStat.ullRsr1M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr1MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " 1M: ALL[%d], OK[%d]:[%02x]\n", (int)pStatistic->CustomStat.ullRsr1M, (int)pStatistic->CustomStat.ullRsr1MCRCOk, byRSR);\r\n} else if (byRxRate == 12) {\r\npStatistic->CustomStat.ullRsr6M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr6MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " 6M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr6M, (int)pStatistic->CustomStat.ullRsr6MCRCOk);\r\n} else if (byRxRate == 18) {\r\npStatistic->CustomStat.ullRsr9M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr9MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " 9M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr9M, (int)pStatistic->CustomStat.ullRsr9MCRCOk);\r\n} else if (byRxRate == 24) {\r\npStatistic->CustomStat.ullRsr12M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr12MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "12M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr12M, (int)pStatistic->CustomStat.ullRsr12MCRCOk);\r\n} else if (byRxRate == 36) {\r\npStatistic->CustomStat.ullRsr18M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr18MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "18M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr18M, (int)pStatistic->CustomStat.ullRsr18MCRCOk);\r\n} else if (byRxRate == 48) {\r\npStatistic->CustomStat.ullRsr24M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr24MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "24M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr24M, (int)pStatistic->CustomStat.ullRsr24MCRCOk);\r\n} else if (byRxRate == 72) {\r\npStatistic->CustomStat.ullRsr36M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr36MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "36M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr36M, (int)pStatistic->CustomStat.ullRsr36MCRCOk);\r\n} else if (byRxRate == 96) {\r\npStatistic->CustomStat.ullRsr48M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr48MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "48M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr48M, (int)pStatistic->CustomStat.ullRsr48MCRCOk);\r\n} else if (byRxRate == 108) {\r\npStatistic->CustomStat.ullRsr54M++;\r\nif (byRSR & RSR_CRCOK)\r\npStatistic->CustomStat.ullRsr54MCRCOk++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "54M: ALL[%d], OK[%d]\n", (int)pStatistic->CustomStat.ullRsr54M, (int)pStatistic->CustomStat.ullRsr54MCRCOk);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Unknown: Total[%d], CRCOK[%d]\n", (int)pStatistic->dwRsrRxPacket+1, (int)pStatistic->dwRsrCRCOk);\r\n}\r\nif (byRSR & RSR_BSSIDOK)\r\npStatistic->dwRsrBSSIDOk++;\r\nif (byRSR & RSR_BCNSSIDOK)\r\npStatistic->dwRsrBCNSSIDOk++;\r\nif (byRSR & RSR_IVLDLEN)\r\npStatistic->dwRsrLENErr++;\r\nif (byRSR & RSR_IVLDTYP)\r\npStatistic->dwRsrTYPErr++;\r\nif (byRSR & (RSR_IVLDTYP | RSR_IVLDLEN))\r\npStatistic->dwRsrErr++;\r\nif (byNewRSR & NEWRSR_DECRYPTOK)\r\npStatistic->dwNewRsrDECRYPTOK++;\r\nif (byNewRSR & NEWRSR_CFPIND)\r\npStatistic->dwNewRsrCFP++;\r\nif (byNewRSR & NEWRSR_HWUTSF)\r\npStatistic->dwNewRsrUTSF++;\r\nif (byNewRSR & NEWRSR_BCNHITAID)\r\npStatistic->dwNewRsrHITAID++;\r\nif (byNewRSR & NEWRSR_BCNHITAID0)\r\npStatistic->dwNewRsrHITAID0++;\r\npStatistic->dwRsrRxPacket++;\r\npStatistic->dwRsrRxOctet += cbFrameLength;\r\nif (IS_TYPE_DATA(pbyBuffer))\r\npStatistic->dwRsrRxData++;\r\nelse if (IS_TYPE_MGMT(pbyBuffer))\r\npStatistic->dwRsrRxManage++;\r\nelse if (IS_TYPE_CONTROL(pbyBuffer))\r\npStatistic->dwRsrRxControl++;\r\nif (byRSR & RSR_ADDRBROAD)\r\npStatistic->dwRsrBroadcast++;\r\nelse if (byRSR & RSR_ADDRMULTI)\r\npStatistic->dwRsrMulticast++;\r\nelse\r\npStatistic->dwRsrDirected++;\r\nif (WLAN_GET_FC_MOREFRAG(pHeader->wFrameCtl))\r\npStatistic->dwRsrRxFragment++;\r\nif (cbFrameLength < ETH_ZLEN + 4)\r\npStatistic->dwRsrRunt++;\r\nelse if (cbFrameLength == ETH_ZLEN + 4)\r\npStatistic->dwRsrRxFrmLen64++;\r\nelse if ((65 <= cbFrameLength) && (cbFrameLength <= 127))\r\npStatistic->dwRsrRxFrmLen65_127++;\r\nelse if ((128 <= cbFrameLength) && (cbFrameLength <= 255))\r\npStatistic->dwRsrRxFrmLen128_255++;\r\nelse if ((256 <= cbFrameLength) && (cbFrameLength <= 511))\r\npStatistic->dwRsrRxFrmLen256_511++;\r\nelse if ((512 <= cbFrameLength) && (cbFrameLength <= 1023))\r\npStatistic->dwRsrRxFrmLen512_1023++;\r\nelse if ((1024 <= cbFrameLength) && (cbFrameLength <= ETH_FRAME_LEN + 4))\r\npStatistic->dwRsrRxFrmLen1024_1518++;\r\nelse if (cbFrameLength > ETH_FRAME_LEN + 4)\r\npStatistic->dwRsrLong++;\r\n}\r\nvoid\r\nSTAvUpdateRDStatCounterEx(\r\nPSStatCounter pStatistic,\r\nunsigned char byRSR,\r\nunsigned char byNewRSR,\r\nunsigned char byRxRate,\r\nunsigned char *pbyBuffer,\r\nunsigned int cbFrameLength\r\n)\r\n{\r\nSTAvUpdateRDStatCounter(\r\npStatistic,\r\nbyRSR,\r\nbyNewRSR,\r\nbyRxRate,\r\npbyBuffer,\r\ncbFrameLength\r\n);\r\npStatistic->dwCntRxFrmLength = cbFrameLength;\r\nmemcpy(pStatistic->abyCntRxPattern, (unsigned char *)pbyBuffer, 10);\r\n}\r\nvoid\r\nSTAvUpdateTDStatCounter(\r\nPSStatCounter pStatistic,\r\nunsigned char byTSR0,\r\nunsigned char byTSR1,\r\nunsigned char *pbyBuffer,\r\nunsigned int cbFrameLength,\r\nunsigned int uIdx\r\n)\r\n{\r\nPWLAN_80211HDR_A4 pHeader;\r\nunsigned char *pbyDestAddr;\r\nunsigned char byTSR0_NCR = byTSR0 & TSR0_NCR;\r\npHeader = (PWLAN_80211HDR_A4) pbyBuffer;\r\nif (WLAN_GET_FC_TODS(pHeader->wFrameCtl) == 0)\r\npbyDestAddr = &(pHeader->abyAddr1[0]);\r\nelse\r\npbyDestAddr = &(pHeader->abyAddr3[0]);\r\npStatistic->dwTsrTxPacket[uIdx]++;\r\npStatistic->dwTsrTxOctet[uIdx] += cbFrameLength;\r\nif (byTSR0_NCR != 0) {\r\npStatistic->dwTsrRetry[uIdx]++;\r\npStatistic->dwTsrTotalRetry[uIdx] += byTSR0_NCR;\r\nif (byTSR0_NCR == 1)\r\npStatistic->dwTsrOnceRetry[uIdx]++;\r\nelse\r\npStatistic->dwTsrMoreThanOnceRetry[uIdx]++;\r\n}\r\nif ((byTSR1&(TSR1_TERR|TSR1_RETRYTMO|TSR1_TMO|ACK_DATA)) == 0) {\r\npStatistic->ullTsrOK[uIdx]++;\r\npStatistic->CustomStat.ullTsrAllOK =\r\n(pStatistic->ullTsrOK[TYPE_AC0DMA] + pStatistic->ullTsrOK[TYPE_TXDMA0]);\r\nif (is_broadcast_ether_addr(pbyDestAddr)) {\r\npStatistic->ullTxBroadcastFrames[uIdx]++;\r\npStatistic->ullTxBroadcastBytes[uIdx] += (unsigned long long) cbFrameLength;\r\n} else if (is_multicast_ether_addr(pbyDestAddr)) {\r\npStatistic->ullTxMulticastFrames[uIdx]++;\r\npStatistic->ullTxMulticastBytes[uIdx] += (unsigned long long) cbFrameLength;\r\n} else {\r\npStatistic->ullTxDirectedFrames[uIdx]++;\r\npStatistic->ullTxDirectedBytes[uIdx] += (unsigned long long) cbFrameLength;\r\n}\r\n} else {\r\nif (byTSR1 & TSR1_TERR)\r\npStatistic->dwTsrErr[uIdx]++;\r\nif (byTSR1 & TSR1_RETRYTMO)\r\npStatistic->dwTsrRetryTimeout[uIdx]++;\r\nif (byTSR1 & TSR1_TMO)\r\npStatistic->dwTsrTransmitTimeout[uIdx]++;\r\nif (byTSR1 & ACK_DATA)\r\npStatistic->dwTsrACKData[uIdx]++;\r\n}\r\nif (is_broadcast_ether_addr(pbyDestAddr))\r\npStatistic->dwTsrBroadcast[uIdx]++;\r\nelse if (is_multicast_ether_addr(pbyDestAddr))\r\npStatistic->dwTsrMulticast[uIdx]++;\r\nelse\r\npStatistic->dwTsrDirected[uIdx]++;\r\n}\r\nvoid\r\nSTAvUpdateTDStatCounterEx(\r\nPSStatCounter pStatistic,\r\nunsigned char *pbyBuffer,\r\nunsigned long cbFrameLength\r\n)\r\n{\r\nunsigned int uPktLength;\r\nuPktLength = (unsigned int)cbFrameLength;\r\npStatistic->dwCntTxBufLength = uPktLength;\r\nmemcpy(pStatistic->abyCntTxPattern, pbyBuffer, 16);\r\n}\r\nvoid\r\nSTAvUpdate802_11Counter(\r\nPSDot11Counters p802_11Counter,\r\nPSStatCounter pStatistic,\r\nunsigned long dwCounter\r\n)\r\n{\r\np802_11Counter->MulticastTransmittedFrameCount = (unsigned long long) (pStatistic->dwTsrBroadcast[TYPE_AC0DMA] +\r\npStatistic->dwTsrBroadcast[TYPE_TXDMA0] +\r\npStatistic->dwTsrMulticast[TYPE_AC0DMA] +\r\npStatistic->dwTsrMulticast[TYPE_TXDMA0]);\r\np802_11Counter->FailedCount = (unsigned long long) (pStatistic->dwTsrErr[TYPE_AC0DMA] + pStatistic->dwTsrErr[TYPE_TXDMA0]);\r\np802_11Counter->RetryCount = (unsigned long long) (pStatistic->dwTsrRetry[TYPE_AC0DMA] + pStatistic->dwTsrRetry[TYPE_TXDMA0]);\r\np802_11Counter->MultipleRetryCount = (unsigned long long) (pStatistic->dwTsrMoreThanOnceRetry[TYPE_AC0DMA] +\r\npStatistic->dwTsrMoreThanOnceRetry[TYPE_TXDMA0]);\r\np802_11Counter->RTSSuccessCount += (unsigned long long) (dwCounter & 0x000000ff);\r\np802_11Counter->RTSFailureCount += (unsigned long long) ((dwCounter & 0x0000ff00) >> 8);\r\np802_11Counter->ACKFailureCount += (unsigned long long) ((dwCounter & 0x00ff0000) >> 16);\r\np802_11Counter->FCSErrorCount += (unsigned long long) ((dwCounter & 0xff000000) >> 24);\r\np802_11Counter->MulticastReceivedFrameCount = (unsigned long long) (pStatistic->dwRsrBroadcast +\r\npStatistic->dwRsrMulticast);\r\n}\r\nvoid\r\nSTAvClear802_11Counter(PSDot11Counters p802_11Counter)\r\n{\r\nmemset(p802_11Counter, 0, sizeof(SDot11Counters));\r\n}

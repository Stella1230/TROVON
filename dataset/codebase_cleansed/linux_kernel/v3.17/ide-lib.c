void ide_toggle_bounce(ide_drive_t *drive, int on)\r\n{\r\nu64 addr = BLK_BOUNCE_HIGH;\r\nif (!PCI_DMA_BUS_IS_PHYS) {\r\naddr = BLK_BOUNCE_ANY;\r\n} else if (on && drive->media == ide_disk) {\r\nstruct device *dev = drive->hwif->dev;\r\nif (dev && dev->dma_mask)\r\naddr = *dev->dma_mask;\r\n}\r\nif (drive->queue)\r\nblk_queue_bounce_limit(drive->queue, addr);\r\n}\r\nu64 ide_get_lba_addr(struct ide_cmd *cmd, int lba48)\r\n{\r\nstruct ide_taskfile *tf = &cmd->tf;\r\nu32 high, low;\r\nlow = (tf->lbah << 16) | (tf->lbam << 8) | tf->lbal;\r\nif (lba48) {\r\ntf = &cmd->hob;\r\nhigh = (tf->lbah << 16) | (tf->lbam << 8) | tf->lbal;\r\n} else\r\nhigh = tf->device & 0xf;\r\nreturn ((u64)high << 24) | low;\r\n}\r\nstatic void ide_dump_sector(ide_drive_t *drive)\r\n{\r\nstruct ide_cmd cmd;\r\nstruct ide_taskfile *tf = &cmd.tf;\r\nu8 lba48 = !!(drive->dev_flags & IDE_DFLAG_LBA48);\r\nmemset(&cmd, 0, sizeof(cmd));\r\nif (lba48) {\r\ncmd.valid.in.tf = IDE_VALID_LBA;\r\ncmd.valid.in.hob = IDE_VALID_LBA;\r\ncmd.tf_flags = IDE_TFLAG_LBA48;\r\n} else\r\ncmd.valid.in.tf = IDE_VALID_LBA | IDE_VALID_DEVICE;\r\nide_tf_readback(drive, &cmd);\r\nif (lba48 || (tf->device & ATA_LBA))\r\nprintk(KERN_CONT ", LBAsect=%llu",\r\n(unsigned long long)ide_get_lba_addr(&cmd, lba48));\r\nelse\r\nprintk(KERN_CONT ", CHS=%d/%d/%d", (tf->lbah << 8) + tf->lbam,\r\ntf->device & 0xf, tf->lbal);\r\n}\r\nstatic void ide_dump_ata_error(ide_drive_t *drive, u8 err)\r\n{\r\nprintk(KERN_CONT "{ ");\r\nif (err & ATA_ABORTED)\r\nprintk(KERN_CONT "DriveStatusError ");\r\nif (err & ATA_ICRC)\r\nprintk(KERN_CONT "%s",\r\n(err & ATA_ABORTED) ? "BadCRC " : "BadSector ");\r\nif (err & ATA_UNC)\r\nprintk(KERN_CONT "UncorrectableError ");\r\nif (err & ATA_IDNF)\r\nprintk(KERN_CONT "SectorIdNotFound ");\r\nif (err & ATA_TRK0NF)\r\nprintk(KERN_CONT "TrackZeroNotFound ");\r\nif (err & ATA_AMNF)\r\nprintk(KERN_CONT "AddrMarkNotFound ");\r\nprintk(KERN_CONT "}");\r\nif ((err & (ATA_BBK | ATA_ABORTED)) == ATA_BBK ||\r\n(err & (ATA_UNC | ATA_IDNF | ATA_AMNF))) {\r\nstruct request *rq = drive->hwif->rq;\r\nide_dump_sector(drive);\r\nif (rq)\r\nprintk(KERN_CONT ", sector=%llu",\r\n(unsigned long long)blk_rq_pos(rq));\r\n}\r\nprintk(KERN_CONT "\n");\r\n}\r\nstatic void ide_dump_atapi_error(ide_drive_t *drive, u8 err)\r\n{\r\nprintk(KERN_CONT "{ ");\r\nif (err & ATAPI_ILI)\r\nprintk(KERN_CONT "IllegalLengthIndication ");\r\nif (err & ATAPI_EOM)\r\nprintk(KERN_CONT "EndOfMedia ");\r\nif (err & ATA_ABORTED)\r\nprintk(KERN_CONT "AbortedCommand ");\r\nif (err & ATA_MCR)\r\nprintk(KERN_CONT "MediaChangeRequested ");\r\nif (err & ATAPI_LFS)\r\nprintk(KERN_CONT "LastFailedSense=0x%02x ",\r\n(err & ATAPI_LFS) >> 4);\r\nprintk(KERN_CONT "}\n");\r\n}\r\nu8 ide_dump_status(ide_drive_t *drive, const char *msg, u8 stat)\r\n{\r\nu8 err = 0;\r\nprintk(KERN_ERR "%s: %s: status=0x%02x { ", drive->name, msg, stat);\r\nif (stat & ATA_BUSY)\r\nprintk(KERN_CONT "Busy ");\r\nelse {\r\nif (stat & ATA_DRDY)\r\nprintk(KERN_CONT "DriveReady ");\r\nif (stat & ATA_DF)\r\nprintk(KERN_CONT "DeviceFault ");\r\nif (stat & ATA_DSC)\r\nprintk(KERN_CONT "SeekComplete ");\r\nif (stat & ATA_DRQ)\r\nprintk(KERN_CONT "DataRequest ");\r\nif (stat & ATA_CORR)\r\nprintk(KERN_CONT "CorrectedError ");\r\nif (stat & ATA_IDX)\r\nprintk(KERN_CONT "Index ");\r\nif (stat & ATA_ERR)\r\nprintk(KERN_CONT "Error ");\r\n}\r\nprintk(KERN_CONT "}\n");\r\nif ((stat & (ATA_BUSY | ATA_ERR)) == ATA_ERR) {\r\nerr = ide_read_error(drive);\r\nprintk(KERN_ERR "%s: %s: error=0x%02x ", drive->name, msg, err);\r\nif (drive->media == ide_disk)\r\nide_dump_ata_error(drive, err);\r\nelse\r\nide_dump_atapi_error(drive, err);\r\n}\r\nprintk(KERN_ERR "%s: possibly failed opcode: 0x%02x\n",\r\ndrive->name, drive->hwif->cmd.tf.command);\r\nreturn err;\r\n}

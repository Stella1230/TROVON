static int i2o_bus_scan(struct i2o_device *dev)\r\n{\r\nstruct i2o_message *msg;\r\nmsg = i2o_msg_get_wait(dev->iop, I2O_TIMEOUT_MESSAGE_GET);\r\nif (IS_ERR(msg))\r\nreturn -ETIMEDOUT;\r\nmsg->u.head[0] = cpu_to_le32(FIVE_WORD_MSG_SIZE | SGL_OFFSET_0);\r\nmsg->u.head[1] =\r\ncpu_to_le32(I2O_CMD_BUS_SCAN << 24 | HOST_TID << 12 | dev->lct_data.\r\ntid);\r\nreturn i2o_msg_post_wait(dev->iop, msg, 60);\r\n}\r\nstatic ssize_t i2o_bus_store_scan(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2o_device *i2o_dev = to_i2o_device(d);\r\nint rc;\r\nif ((rc = i2o_bus_scan(i2o_dev)))\r\nosm_warn("bus scan failed %d\n", rc);\r\nreturn count;\r\n}\r\nstatic int i2o_bus_probe(struct device *dev)\r\n{\r\nstruct i2o_device *i2o_dev = to_i2o_device(get_device(dev));\r\nint rc;\r\nrc = device_create_file(dev, &dev_attr_scan);\r\nif (rc)\r\ngoto err_out;\r\nosm_info("device added (TID: %03x)\n", i2o_dev->lct_data.tid);\r\nreturn 0;\r\nerr_out:\r\nput_device(dev);\r\nreturn rc;\r\n}\r\nstatic int i2o_bus_remove(struct device *dev)\r\n{\r\nstruct i2o_device *i2o_dev = to_i2o_device(dev);\r\ndevice_remove_file(dev, &dev_attr_scan);\r\nput_device(dev);\r\nosm_info("device removed (TID: %03x)\n", i2o_dev->lct_data.tid);\r\nreturn 0;\r\n}\r\nstatic int __init i2o_bus_init(void)\r\n{\r\nint rc;\r\nprintk(KERN_INFO OSM_DESCRIPTION " v" OSM_VERSION "\n");\r\nrc = i2o_driver_register(&i2o_bus_driver);\r\nif (rc) {\r\nosm_err("Could not register Bus Adapter OSM\n");\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit i2o_bus_exit(void)\r\n{\r\ni2o_driver_unregister(&i2o_bus_driver);\r\n}

static void *ipx_seq_interface_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nspin_lock_bh(&ipx_interfaces_lock);\r\nreturn seq_list_start_head(&ipx_interfaces, *pos);\r\n}\r\nstatic void *ipx_seq_interface_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_list_next(v, &ipx_interfaces, pos);\r\n}\r\nstatic void ipx_seq_interface_stop(struct seq_file *seq, void *v)\r\n{\r\nspin_unlock_bh(&ipx_interfaces_lock);\r\n}\r\nstatic int ipx_seq_interface_show(struct seq_file *seq, void *v)\r\n{\r\nstruct ipx_interface *i;\r\nif (v == &ipx_interfaces) {\r\nseq_puts(seq, "Network Node_Address Primary Device "\r\n"Frame_Type");\r\n#ifdef IPX_REFCNT_DEBUG\r\nseq_puts(seq, " refcnt");\r\n#endif\r\nseq_puts(seq, "\n");\r\ngoto out;\r\n}\r\ni = list_entry(v, struct ipx_interface, node);\r\nseq_printf(seq, "%08lX ", (unsigned long int)ntohl(i->if_netnum));\r\nseq_printf(seq, "%02X%02X%02X%02X%02X%02X ",\r\ni->if_node[0], i->if_node[1], i->if_node[2],\r\ni->if_node[3], i->if_node[4], i->if_node[5]);\r\nseq_printf(seq, "%-9s", i == ipx_primary_net ? "Yes" : "No");\r\nseq_printf(seq, "%-11s", ipx_device_name(i));\r\nseq_printf(seq, "%-9s", ipx_frame_name(i->if_dlink_type));\r\n#ifdef IPX_REFCNT_DEBUG\r\nseq_printf(seq, "%6d", atomic_read(&i->refcnt));\r\n#endif\r\nseq_puts(seq, "\n");\r\nout:\r\nreturn 0;\r\n}\r\nstatic void *ipx_seq_route_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nread_lock_bh(&ipx_routes_lock);\r\nreturn seq_list_start_head(&ipx_routes, *pos);\r\n}\r\nstatic void *ipx_seq_route_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_list_next(v, &ipx_routes, pos);\r\n}\r\nstatic void ipx_seq_route_stop(struct seq_file *seq, void *v)\r\n{\r\nread_unlock_bh(&ipx_routes_lock);\r\n}\r\nstatic int ipx_seq_route_show(struct seq_file *seq, void *v)\r\n{\r\nstruct ipx_route *rt;\r\nif (v == &ipx_routes) {\r\nseq_puts(seq, "Network Router_Net Router_Node\n");\r\ngoto out;\r\n}\r\nrt = list_entry(v, struct ipx_route, node);\r\nseq_printf(seq, "%08lX ", (unsigned long int)ntohl(rt->ir_net));\r\nif (rt->ir_routed)\r\nseq_printf(seq, "%08lX %02X%02X%02X%02X%02X%02X\n",\r\n(long unsigned int)ntohl(rt->ir_intrfc->if_netnum),\r\nrt->ir_router_node[0], rt->ir_router_node[1],\r\nrt->ir_router_node[2], rt->ir_router_node[3],\r\nrt->ir_router_node[4], rt->ir_router_node[5]);\r\nelse\r\nseq_puts(seq, "Directly Connected\n");\r\nout:\r\nreturn 0;\r\n}\r\nvoid *ipx_seq_socket_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nloff_t l = *pos;\r\nspin_lock_bh(&ipx_interfaces_lock);\r\nreturn l ? ipx_get_socket_idx(--l) : SEQ_START_TOKEN;\r\n}\r\nstatic void *ipx_seq_socket_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct sock* sk, *next;\r\nstruct ipx_interface *i;\r\nstruct ipx_sock *ipxs;\r\n++*pos;\r\nif (v == SEQ_START_TOKEN) {\r\nsk = NULL;\r\ni = ipx_interfaces_head();\r\nif (!i)\r\ngoto out;\r\nsk = sk_head(&i->if_sklist);\r\nif (sk)\r\nspin_lock_bh(&i->if_sklist_lock);\r\ngoto out;\r\n}\r\nsk = v;\r\nnext = sk_next(sk);\r\nif (next) {\r\nsk = next;\r\ngoto out;\r\n}\r\nipxs = ipx_sk(sk);\r\ni = ipxs->intrfc;\r\nspin_unlock_bh(&i->if_sklist_lock);\r\nsk = NULL;\r\nfor (;;) {\r\nif (i->node.next == &ipx_interfaces)\r\nbreak;\r\ni = list_entry(i->node.next, struct ipx_interface, node);\r\nspin_lock_bh(&i->if_sklist_lock);\r\nif (!hlist_empty(&i->if_sklist)) {\r\nsk = sk_head(&i->if_sklist);\r\nbreak;\r\n}\r\nspin_unlock_bh(&i->if_sklist_lock);\r\n}\r\nout:\r\nreturn sk;\r\n}\r\nstatic int ipx_seq_socket_show(struct seq_file *seq, void *v)\r\n{\r\nstruct sock *s;\r\nstruct ipx_sock *ipxs;\r\nif (v == SEQ_START_TOKEN) {\r\n#ifdef CONFIG_IPX_INTERN\r\nseq_puts(seq, "Local_Address "\r\n"Remote_Address Tx_Queue "\r\n"Rx_Queue State Uid\n");\r\n#else\r\nseq_puts(seq, "Local_Address Remote_Address "\r\n"Tx_Queue Rx_Queue State Uid\n");\r\n#endif\r\ngoto out;\r\n}\r\ns = v;\r\nipxs = ipx_sk(s);\r\n#ifdef CONFIG_IPX_INTERN\r\nseq_printf(seq, "%08lX:%02X%02X%02X%02X%02X%02X:%04X ",\r\n(unsigned long)ntohl(ipxs->intrfc->if_netnum),\r\nipxs->node[0], ipxs->node[1], ipxs->node[2], ipxs->node[3],\r\nipxs->node[4], ipxs->node[5], ntohs(ipxs->port));\r\n#else\r\nseq_printf(seq, "%08lX:%04X ", (unsigned long) ntohl(ipxs->intrfc->if_netnum),\r\nntohs(ipxs->port));\r\n#endif\r\nif (s->sk_state != TCP_ESTABLISHED)\r\nseq_printf(seq, "%-28s", "Not_Connected");\r\nelse {\r\nseq_printf(seq, "%08lX:%02X%02X%02X%02X%02X%02X:%04X ",\r\n(unsigned long)ntohl(ipxs->dest_addr.net),\r\nipxs->dest_addr.node[0], ipxs->dest_addr.node[1],\r\nipxs->dest_addr.node[2], ipxs->dest_addr.node[3],\r\nipxs->dest_addr.node[4], ipxs->dest_addr.node[5],\r\nntohs(ipxs->dest_addr.sock));\r\n}\r\nseq_printf(seq, "%08X %08X %02X %03u\n",\r\nsk_wmem_alloc_get(s),\r\nsk_rmem_alloc_get(s),\r\ns->sk_state,\r\nfrom_kuid_munged(seq_user_ns(seq), sock_i_uid(s)));\r\nout:\r\nreturn 0;\r\n}\r\nstatic int ipx_seq_route_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &ipx_seq_route_ops);\r\n}\r\nstatic int ipx_seq_interface_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &ipx_seq_interface_ops);\r\n}\r\nstatic int ipx_seq_socket_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &ipx_seq_socket_ops);\r\n}\r\nint __init ipx_proc_init(void)\r\n{\r\nstruct proc_dir_entry *p;\r\nint rc = -ENOMEM;\r\nipx_proc_dir = proc_mkdir("ipx", init_net.proc_net);\r\nif (!ipx_proc_dir)\r\ngoto out;\r\np = proc_create("interface", S_IRUGO,\r\nipx_proc_dir, &ipx_seq_interface_fops);\r\nif (!p)\r\ngoto out_interface;\r\np = proc_create("route", S_IRUGO, ipx_proc_dir, &ipx_seq_route_fops);\r\nif (!p)\r\ngoto out_route;\r\np = proc_create("socket", S_IRUGO, ipx_proc_dir, &ipx_seq_socket_fops);\r\nif (!p)\r\ngoto out_socket;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\nout_socket:\r\nremove_proc_entry("route", ipx_proc_dir);\r\nout_route:\r\nremove_proc_entry("interface", ipx_proc_dir);\r\nout_interface:\r\nremove_proc_entry("ipx", init_net.proc_net);\r\ngoto out;\r\n}\r\nvoid __exit ipx_proc_exit(void)\r\n{\r\nremove_proc_entry("interface", ipx_proc_dir);\r\nremove_proc_entry("route", ipx_proc_dir);\r\nremove_proc_entry("socket", ipx_proc_dir);\r\nremove_proc_entry("ipx", init_net.proc_net);\r\n}\r\nint __init ipx_proc_init(void)\r\n{\r\nreturn 0;\r\n}\r\nvoid __exit ipx_proc_exit(void)\r\n{\r\n}

static int nx842_init(struct crypto_tfm *tfm)\r\n{\r\nstruct nx842_ctx *ctx = crypto_tfm_ctx(tfm);\r\nint wmemsize;\r\nwmemsize = max_t(int, nx842_get_workmem_size(), LZO1X_MEM_COMPRESS);\r\nctx->nx842_wmem = kmalloc(wmemsize, GFP_NOFS);\r\nif (!ctx->nx842_wmem)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void nx842_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct nx842_ctx *ctx = crypto_tfm_ctx(tfm);\r\nkfree(ctx->nx842_wmem);\r\n}\r\nstatic void nx842_reset_uselzo(unsigned long data)\r\n{\r\nnx842_uselzo = 0;\r\n}\r\nstatic int nx842_crypto_compress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct nx842_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct nx842_crypto_header *hdr;\r\nunsigned int tmp_len = *dlen;\r\nsize_t lzodlen;\r\nint err;\r\n*dlen = 0;\r\nhdr = (struct nx842_crypto_header *)dst;\r\nhdr->sentinel = NX842_SENTINEL;\r\ndst += sizeof(struct nx842_crypto_header);\r\ntmp_len -= sizeof(struct nx842_crypto_header);\r\nlzodlen = tmp_len;\r\nif (likely(!nx842_uselzo)) {\r\nerr = nx842_compress(src, slen, dst, &tmp_len, ctx->nx842_wmem);\r\nif (likely(!err)) {\r\nhdr->type = NX842_CRYPTO_TYPE_842;\r\n*dlen = tmp_len + sizeof(struct nx842_crypto_header);\r\nreturn 0;\r\n}\r\nnx842_uselzo = 1;\r\nmod_timer(&failover_timer, jiffies + msecs_to_jiffies(1000));\r\n}\r\nerr = lzo1x_1_compress(src, slen, dst, &lzodlen, ctx->nx842_wmem);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\nhdr->type = NX842_CRYPTO_TYPE_LZO;\r\n*dlen = lzodlen + sizeof(struct nx842_crypto_header);\r\nreturn 0;\r\n}\r\nstatic int nx842_crypto_decompress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct nx842_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct nx842_crypto_header *hdr;\r\nunsigned int tmp_len = *dlen;\r\nsize_t lzodlen;\r\nint err;\r\n*dlen = 0;\r\nhdr = (struct nx842_crypto_header *)src;\r\nif (unlikely(hdr->sentinel != NX842_SENTINEL))\r\nreturn -EINVAL;\r\nsrc += sizeof(struct nx842_crypto_header);\r\nslen -= sizeof(struct nx842_crypto_header);\r\nif (likely(hdr->type == NX842_CRYPTO_TYPE_842)) {\r\nerr = nx842_decompress(src, slen, dst, &tmp_len,\r\nctx->nx842_wmem);\r\nif (err)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\n} else if (hdr->type == NX842_CRYPTO_TYPE_LZO) {\r\nlzodlen = tmp_len;\r\nerr = lzo1x_decompress_safe(src, slen, dst, &lzodlen);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\n*dlen = lzodlen;\r\n} else\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init nx842_mod_init(void)\r\n{\r\ndel_timer(&failover_timer);\r\nreturn crypto_register_alg(&alg);\r\n}\r\nstatic void __exit nx842_mod_exit(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\n}

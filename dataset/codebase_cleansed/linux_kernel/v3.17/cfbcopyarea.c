static void\r\nbitcpy(struct fb_info *p, unsigned long __iomem *dst, unsigned dst_idx,\r\nconst unsigned long __iomem *src, unsigned src_idx, int bits,\r\nunsigned n, u32 bswapmask)\r\n{\r\nunsigned long first, last;\r\nint const shift = dst_idx-src_idx;\r\n#if 0\r\nfb_memmove((char *)dst + ((dst_idx & (bits - 1))) / 8,\r\n(char *)src + ((src_idx & (bits - 1))) / 8, n / 8);\r\nreturn;\r\n#endif\r\nfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\r\nlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\r\nif (!shift) {\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\r\n} else {\r\nif (first != ~0UL) {\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\r\ndst++;\r\nsrc++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nn -= 8;\r\n}\r\nwhile (n--)\r\nFB_WRITEL(FB_READL(src++), dst++);\r\nif (last)\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\r\n}\r\n} else {\r\nunsigned long d0, d1;\r\nint m;\r\nint const left = shift & (bits - 1);\r\nint const right = -shift & (bits - 1);\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\nd0 = FB_READL(src);\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nif (shift > 0) {\r\nd0 <<= left;\r\n} else if (src_idx+n <= bits) {\r\nd0 >>= right;\r\n} else {\r\nd1 = FB_READL(src + 1);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 >> right | d1 << left;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\r\n} else {\r\nd0 = FB_READL(src++);\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nif (shift > 0) {\r\nd1 = d0;\r\nd0 <<= left;\r\nn -= bits - dst_idx;\r\n} else {\r\nd1 = FB_READL(src++);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 >> right | d1 << left;\r\nn -= bits - dst_idx;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\r\nd0 = d1;\r\ndst++;\r\nm = n % bits;\r\nn /= bits;\r\nwhile ((n >= 4) && !bswapmask) {\r\nd1 = FB_READL(src++);\r\nFB_WRITEL(d0 >> right | d1 << left, dst++);\r\nd0 = d1;\r\nd1 = FB_READL(src++);\r\nFB_WRITEL(d0 >> right | d1 << left, dst++);\r\nd0 = d1;\r\nd1 = FB_READL(src++);\r\nFB_WRITEL(d0 >> right | d1 << left, dst++);\r\nd0 = d1;\r\nd1 = FB_READL(src++);\r\nFB_WRITEL(d0 >> right | d1 << left, dst++);\r\nd0 = d1;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nd1 = FB_READL(src++);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 >> right | d1 << left;\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(d0, dst++);\r\nd0 = d1;\r\n}\r\nif (m) {\r\nif (m <= bits - right) {\r\nd0 >>= right;\r\n} else {\r\nd1 = FB_READL(src);\r\nd1 = fb_rev_pixels_in_long(d1,\r\nbswapmask);\r\nd0 = d0 >> right | d1 << left;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nbitcpy_rev(struct fb_info *p, unsigned long __iomem *dst, unsigned dst_idx,\r\nconst unsigned long __iomem *src, unsigned src_idx, int bits,\r\nunsigned n, u32 bswapmask)\r\n{\r\nunsigned long first, last;\r\nint shift;\r\n#if 0\r\nfb_memmove((char *)dst + ((dst_idx & (bits - 1))) / 8,\r\n(char *)src + ((src_idx & (bits - 1))) / 8, n / 8);\r\nreturn;\r\n#endif\r\ndst += (dst_idx + n - 1) / bits;\r\nsrc += (src_idx + n - 1) / bits;\r\ndst_idx = (dst_idx + n - 1) % bits;\r\nsrc_idx = (src_idx + n - 1) % bits;\r\nshift = dst_idx-src_idx;\r\nfirst = ~fb_shifted_pixels_mask_long(p, (dst_idx + 1) % bits, bswapmask);\r\nlast = fb_shifted_pixels_mask_long(p, (bits + dst_idx + 1 - n) % bits, bswapmask);\r\nif (!shift) {\r\nif ((unsigned long)dst_idx+1 >= n) {\r\nif (first)\r\nlast &= first;\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\r\n} else {\r\nif (first) {\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), first), dst);\r\ndst--;\r\nsrc--;\r\nn -= dst_idx+1;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nn -= 8;\r\n}\r\nwhile (n--)\r\nFB_WRITEL(FB_READL(src--), dst--);\r\nif (last != -1UL)\r\nFB_WRITEL( comp( FB_READL(src), FB_READL(dst), last), dst);\r\n}\r\n} else {\r\nunsigned long d0, d1;\r\nint m;\r\nint const left = shift & (bits-1);\r\nint const right = -shift & (bits-1);\r\nif ((unsigned long)dst_idx+1 >= n) {\r\nif (first)\r\nlast &= first;\r\nd0 = FB_READL(src);\r\nif (shift < 0) {\r\nd0 >>= right;\r\n} else if (1+(unsigned long)src_idx >= n) {\r\nd0 <<= left;\r\n} else {\r\nd1 = FB_READL(src - 1);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 << left | d1 >> right;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\r\n} else {\r\nd0 = FB_READL(src--);\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nif (shift < 0) {\r\nd1 = d0;\r\nd0 >>= right;\r\n} else {\r\nd1 = FB_READL(src--);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 << left | d1 >> right;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), first), dst);\r\nd0 = d1;\r\ndst--;\r\nn -= dst_idx+1;\r\nm = n % bits;\r\nn /= bits;\r\nwhile ((n >= 4) && !bswapmask) {\r\nd1 = FB_READL(src--);\r\nFB_WRITEL(d0 << left | d1 >> right, dst--);\r\nd0 = d1;\r\nd1 = FB_READL(src--);\r\nFB_WRITEL(d0 << left | d1 >> right, dst--);\r\nd0 = d1;\r\nd1 = FB_READL(src--);\r\nFB_WRITEL(d0 << left | d1 >> right, dst--);\r\nd0 = d1;\r\nd1 = FB_READL(src--);\r\nFB_WRITEL(d0 << left | d1 >> right, dst--);\r\nd0 = d1;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nd1 = FB_READL(src--);\r\nd1 = fb_rev_pixels_in_long(d1, bswapmask);\r\nd0 = d0 << left | d1 >> right;\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(d0, dst--);\r\nd0 = d1;\r\n}\r\nif (m) {\r\nif (m <= bits - left) {\r\nd0 <<= left;\r\n} else {\r\nd1 = FB_READL(src);\r\nd1 = fb_rev_pixels_in_long(d1,\r\nbswapmask);\r\nd0 = d0 << left | d1 >> right;\r\n}\r\nd0 = fb_rev_pixels_in_long(d0, bswapmask);\r\nFB_WRITEL(comp(d0, FB_READL(dst), last), dst);\r\n}\r\n}\r\n}\r\n}\r\nvoid cfb_copyarea(struct fb_info *p, const struct fb_copyarea *area)\r\n{\r\nu32 dx = area->dx, dy = area->dy, sx = area->sx, sy = area->sy;\r\nu32 height = area->height, width = area->width;\r\nunsigned long const bits_per_line = p->fix.line_length*8u;\r\nunsigned long __iomem *base = NULL;\r\nint bits = BITS_PER_LONG, bytes = bits >> 3;\r\nunsigned dst_idx = 0, src_idx = 0, rev_copy = 0;\r\nu32 bswapmask = fb_compute_bswapmask(p);\r\nif (p->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif ((dy == sy && dx > sx) || (dy > sy)) {\r\ndy += height;\r\nsy += height;\r\nrev_copy = 1;\r\n}\r\nbase = (unsigned long __iomem *)((unsigned long)p->screen_base & ~(bytes-1));\r\ndst_idx = src_idx = 8*((unsigned long)p->screen_base & (bytes-1));\r\ndst_idx += dy*bits_per_line + dx*p->var.bits_per_pixel;\r\nsrc_idx += sy*bits_per_line + sx*p->var.bits_per_pixel;\r\nif (p->fbops->fb_sync)\r\np->fbops->fb_sync(p);\r\nif (rev_copy) {\r\nwhile (height--) {\r\ndst_idx -= bits_per_line;\r\nsrc_idx -= bits_per_line;\r\nbitcpy_rev(p, base + (dst_idx / bits), dst_idx % bits,\r\nbase + (src_idx / bits), src_idx % bits, bits,\r\nwidth*p->var.bits_per_pixel, bswapmask);\r\n}\r\n} else {\r\nwhile (height--) {\r\nbitcpy(p, base + (dst_idx / bits), dst_idx % bits,\r\nbase + (src_idx / bits), src_idx % bits, bits,\r\nwidth*p->var.bits_per_pixel, bswapmask);\r\ndst_idx += bits_per_line;\r\nsrc_idx += bits_per_line;\r\n}\r\n}\r\n}

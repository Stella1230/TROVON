void sn_teardown_msi_irq(unsigned int irq)\r\n{\r\nnasid_t nasid;\r\nint widget;\r\nstruct pci_dev *pdev;\r\nstruct pcidev_info *sn_pdev;\r\nstruct sn_irq_info *sn_irq_info;\r\nstruct pcibus_bussoft *bussoft;\r\nstruct sn_pcibus_provider *provider;\r\nsn_irq_info = sn_msi_info[irq].sn_irq_info;\r\nif (sn_irq_info == NULL || sn_irq_info->irq_int_bit >= 0)\r\nreturn;\r\nsn_pdev = (struct pcidev_info *)sn_irq_info->irq_pciioinfo;\r\npdev = sn_pdev->pdi_linux_pcidev;\r\nprovider = SN_PCIDEV_BUSPROVIDER(pdev);\r\n(*provider->dma_unmap)(pdev,\r\nsn_msi_info[irq].pci_addr,\r\nPCI_DMA_FROMDEVICE);\r\nsn_msi_info[irq].pci_addr = 0;\r\nbussoft = SN_PCIDEV_BUSSOFT(pdev);\r\nnasid = NASID_GET(bussoft->bs_base);\r\nwidget = (nasid & 1) ?\r\nTIO_SWIN_WIDGETNUM(bussoft->bs_base) :\r\nSWIN_WIDGETNUM(bussoft->bs_base);\r\nsn_intr_free(nasid, widget, sn_irq_info);\r\nsn_msi_info[irq].sn_irq_info = NULL;\r\ndestroy_irq(irq);\r\n}\r\nint sn_setup_msi_irq(struct pci_dev *pdev, struct msi_desc *entry)\r\n{\r\nstruct msi_msg msg;\r\nint widget;\r\nint status;\r\nnasid_t nasid;\r\nu64 bus_addr;\r\nstruct sn_irq_info *sn_irq_info;\r\nstruct pcibus_bussoft *bussoft = SN_PCIDEV_BUSSOFT(pdev);\r\nstruct sn_pcibus_provider *provider = SN_PCIDEV_BUSPROVIDER(pdev);\r\nint irq;\r\nif (!entry->msi_attrib.is_64)\r\nreturn -EINVAL;\r\nif (bussoft == NULL)\r\nreturn -EINVAL;\r\nif (provider == NULL || provider->dma_map_consistent == NULL)\r\nreturn -EINVAL;\r\nirq = create_irq();\r\nif (irq < 0)\r\nreturn irq;\r\nnasid = NASID_GET(bussoft->bs_base);\r\nwidget = (nasid & 1) ?\r\nTIO_SWIN_WIDGETNUM(bussoft->bs_base) :\r\nSWIN_WIDGETNUM(bussoft->bs_base);\r\nsn_irq_info = kzalloc(sizeof(struct sn_irq_info), GFP_KERNEL);\r\nif (! sn_irq_info) {\r\ndestroy_irq(irq);\r\nreturn -ENOMEM;\r\n}\r\nstatus = sn_intr_alloc(nasid, widget, sn_irq_info, irq, -1, -1);\r\nif (status) {\r\nkfree(sn_irq_info);\r\ndestroy_irq(irq);\r\nreturn -ENOMEM;\r\n}\r\nsn_irq_info->irq_int_bit = -1;\r\nsn_irq_fixup(pdev, sn_irq_info);\r\nsn_irq_info->irq_bridge_type = bussoft->bs_asic_type;\r\nsn_irq_info->irq_bridge = (void *)bussoft->bs_base;\r\nbus_addr = (*provider->dma_map_consistent)(pdev,\r\nsn_irq_info->irq_xtalkaddr,\r\nsizeof(sn_irq_info->irq_xtalkaddr),\r\nSN_DMA_MSI|SN_DMA_ADDR_XIO);\r\nif (! bus_addr) {\r\nsn_intr_free(nasid, widget, sn_irq_info);\r\nkfree(sn_irq_info);\r\ndestroy_irq(irq);\r\nreturn -ENOMEM;\r\n}\r\nsn_msi_info[irq].sn_irq_info = sn_irq_info;\r\nsn_msi_info[irq].pci_addr = bus_addr;\r\nmsg.address_hi = (u32)(bus_addr >> 32);\r\nmsg.address_lo = (u32)(bus_addr & 0x00000000ffffffff);\r\nmsg.data = 0x100 + irq;\r\nirq_set_msi_desc(irq, entry);\r\nwrite_msi_msg(irq, &msg);\r\nirq_set_chip_and_handler(irq, &sn_msi_chip, handle_edge_irq);\r\nreturn 0;\r\n}\r\nstatic int sn_set_msi_irq_affinity(struct irq_data *data,\r\nconst struct cpumask *cpu_mask, bool force)\r\n{\r\nstruct msi_msg msg;\r\nint slice;\r\nnasid_t nasid;\r\nu64 bus_addr;\r\nstruct pci_dev *pdev;\r\nstruct pcidev_info *sn_pdev;\r\nstruct sn_irq_info *sn_irq_info;\r\nstruct sn_irq_info *new_irq_info;\r\nstruct sn_pcibus_provider *provider;\r\nunsigned int cpu, irq = data->irq;\r\ncpu = cpumask_first_and(cpu_mask, cpu_online_mask);\r\nsn_irq_info = sn_msi_info[irq].sn_irq_info;\r\nif (sn_irq_info == NULL || sn_irq_info->irq_int_bit >= 0)\r\nreturn -1;\r\nget_cached_msi_msg(irq, &msg);\r\nsn_pdev = (struct pcidev_info *)sn_irq_info->irq_pciioinfo;\r\npdev = sn_pdev->pdi_linux_pcidev;\r\nprovider = SN_PCIDEV_BUSPROVIDER(pdev);\r\nbus_addr = (u64)(msg.address_hi) << 32 | (u64)(msg.address_lo);\r\n(*provider->dma_unmap)(pdev, bus_addr, PCI_DMA_FROMDEVICE);\r\nsn_msi_info[irq].pci_addr = 0;\r\nnasid = cpuid_to_nasid(cpu);\r\nslice = cpuid_to_slice(cpu);\r\nnew_irq_info = sn_retarget_vector(sn_irq_info, nasid, slice);\r\nsn_msi_info[irq].sn_irq_info = new_irq_info;\r\nif (new_irq_info == NULL)\r\nreturn -1;\r\nbus_addr = (*provider->dma_map_consistent)(pdev,\r\nnew_irq_info->irq_xtalkaddr,\r\nsizeof(new_irq_info->irq_xtalkaddr),\r\nSN_DMA_MSI|SN_DMA_ADDR_XIO);\r\nsn_msi_info[irq].pci_addr = bus_addr;\r\nmsg.address_hi = (u32)(bus_addr >> 32);\r\nmsg.address_lo = (u32)(bus_addr & 0x00000000ffffffff);\r\nwrite_msi_msg(irq, &msg);\r\ncpumask_copy(data->affinity, cpu_mask);\r\nreturn 0;\r\n}\r\nstatic void sn_ack_msi_irq(struct irq_data *data)\r\n{\r\nirq_move_irq(data);\r\nia64_eoi();\r\n}\r\nstatic int sn_msi_retrigger_irq(struct irq_data *data)\r\n{\r\nunsigned int vector = data->irq;\r\nia64_resend_irq(vector);\r\nreturn 1;\r\n}

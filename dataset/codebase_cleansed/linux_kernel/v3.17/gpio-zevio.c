static inline u32 zevio_gpio_port_get(struct zevio_gpio *c, unsigned pin,\r\nunsigned port_offset)\r\n{\r\nunsigned section_offset = ((pin >> 3) & 3)*ZEVIO_GPIO_SECTION_SIZE;\r\nreturn readl(IOMEM(c->chip.regs + section_offset + port_offset));\r\n}\r\nstatic inline void zevio_gpio_port_set(struct zevio_gpio *c, unsigned pin,\r\nunsigned port_offset, u32 val)\r\n{\r\nunsigned section_offset = ((pin >> 3) & 3)*ZEVIO_GPIO_SECTION_SIZE;\r\nwritel(val, IOMEM(c->chip.regs + section_offset + port_offset));\r\n}\r\nstatic int zevio_gpio_get(struct gpio_chip *chip, unsigned pin)\r\n{\r\nstruct zevio_gpio *controller = to_zevio_gpio(chip);\r\nu32 val, dir;\r\nspin_lock(&controller->lock);\r\ndir = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_DIRECTION);\r\nif (dir & BIT(ZEVIO_GPIO_BIT(pin)))\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_INPUT);\r\nelse\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_OUTPUT);\r\nspin_unlock(&controller->lock);\r\nreturn (val >> ZEVIO_GPIO_BIT(pin)) & 0x1;\r\n}\r\nstatic void zevio_gpio_set(struct gpio_chip *chip, unsigned pin, int value)\r\n{\r\nstruct zevio_gpio *controller = to_zevio_gpio(chip);\r\nu32 val;\r\nspin_lock(&controller->lock);\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_OUTPUT);\r\nif (value)\r\nval |= BIT(ZEVIO_GPIO_BIT(pin));\r\nelse\r\nval &= ~BIT(ZEVIO_GPIO_BIT(pin));\r\nzevio_gpio_port_set(controller, pin, ZEVIO_GPIO_OUTPUT, val);\r\nspin_unlock(&controller->lock);\r\n}\r\nstatic int zevio_gpio_direction_input(struct gpio_chip *chip, unsigned pin)\r\n{\r\nstruct zevio_gpio *controller = to_zevio_gpio(chip);\r\nu32 val;\r\nspin_lock(&controller->lock);\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_DIRECTION);\r\nval |= BIT(ZEVIO_GPIO_BIT(pin));\r\nzevio_gpio_port_set(controller, pin, ZEVIO_GPIO_DIRECTION, val);\r\nspin_unlock(&controller->lock);\r\nreturn 0;\r\n}\r\nstatic int zevio_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned pin, int value)\r\n{\r\nstruct zevio_gpio *controller = to_zevio_gpio(chip);\r\nu32 val;\r\nspin_lock(&controller->lock);\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_OUTPUT);\r\nif (value)\r\nval |= BIT(ZEVIO_GPIO_BIT(pin));\r\nelse\r\nval &= ~BIT(ZEVIO_GPIO_BIT(pin));\r\nzevio_gpio_port_set(controller, pin, ZEVIO_GPIO_OUTPUT, val);\r\nval = zevio_gpio_port_get(controller, pin, ZEVIO_GPIO_DIRECTION);\r\nval &= ~BIT(ZEVIO_GPIO_BIT(pin));\r\nzevio_gpio_port_set(controller, pin, ZEVIO_GPIO_DIRECTION, val);\r\nspin_unlock(&controller->lock);\r\nreturn 0;\r\n}\r\nstatic int zevio_gpio_to_irq(struct gpio_chip *chip, unsigned pin)\r\n{\r\nreturn -ENXIO;\r\n}\r\nstatic int zevio_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct zevio_gpio *controller;\r\nint status, i;\r\ncontroller = devm_kzalloc(&pdev->dev, sizeof(*controller), GFP_KERNEL);\r\nif (!controller)\r\nreturn -ENOMEM;\r\ncontroller->chip.gc = zevio_gpio_chip;\r\ncontroller->chip.gc.dev = &pdev->dev;\r\nstatus = of_mm_gpiochip_add(pdev->dev.of_node, &(controller->chip));\r\nif (status) {\r\ndev_err(&pdev->dev, "failed to add gpiochip: %d\n", status);\r\nreturn status;\r\n}\r\nspin_lock_init(&controller->lock);\r\nfor (i = 0; i < controller->chip.gc.ngpio; i += 8)\r\nzevio_gpio_port_set(controller, i, ZEVIO_GPIO_INT_MASK, 0xFF);\r\ndev_dbg(controller->chip.gc.dev, "ZEVIO GPIO controller set up!\n");\r\nreturn 0;\r\n}

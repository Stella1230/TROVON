static int pcmad_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + PCMAD_STATUS);\r\nif ((status & 0x3) == 0x3)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int pcmad_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int val;\r\nint ret;\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\noutb(chan, dev->iobase + PCMAD_CONVERT);\r\nret = comedi_timeout(dev, s, insn, pcmad_ai_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\nval = inb(dev->iobase + PCMAD_LSB) |\r\n(inb(dev->iobase + PCMAD_MSB) << 8);\r\nif (s->maxdata == 0x0fff)\r\nval >>= 4;\r\nif (comedi_range_is_bipolar(s, range)) {\r\nval ^= ((s->maxdata + 1) >> 1);\r\n}\r\ndata[i] = val;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int pcmad_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nconst struct pcmad_board_struct *board = comedi_board(dev);\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], 0x04);\r\nif (ret)\r\nreturn ret;\r\nret = comedi_alloc_subdevices(dev, 1);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\nif (it->options[1]) {\r\ns->subdev_flags = SDF_READABLE | AREF_DIFF;\r\ns->n_chan = 8;\r\n} else {\r\ns->subdev_flags = SDF_READABLE | AREF_GROUND;\r\ns->n_chan = 16;\r\n}\r\ns->len_chanlist = 1;\r\ns->maxdata = board->ai_maxdata;\r\ns->range_table = it->options[2] ? &range_bipolar10 : &range_unipolar5;\r\ns->insn_read = pcmad_ai_insn_read;\r\nreturn 0;\r\n}

static const struct radeon_tv_mode_constants *radeon_legacy_tv_get_std_mode(struct radeon_encoder *radeon_encoder,\r\nuint16_t *pll_ref_freq)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc;\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nstruct radeon_pll *pll;\r\nradeon_crtc = to_radeon_crtc(radeon_encoder->base.crtc);\r\nif (radeon_crtc->crtc_id == 1)\r\npll = &rdev->clock.p2pll;\r\nelse\r\npll = &rdev->clock.p1pll;\r\nif (pll_ref_freq)\r\n*pll_ref_freq = pll->reference_freq;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M) {\r\nif (pll->reference_freq == 2700)\r\nconst_ptr = &available_tv_modes[0];\r\nelse\r\nconst_ptr = &available_tv_modes[2];\r\n} else {\r\nif (pll->reference_freq == 2700)\r\nconst_ptr = &available_tv_modes[1];\r\nelse\r\nconst_ptr = &available_tv_modes[3];\r\n}\r\nreturn const_ptr;\r\n}\r\nstatic void radeon_wait_pll_lock(struct drm_encoder *encoder, unsigned n_tests,\r\nunsigned n_wait_loops, unsigned cnt_threshold)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t save_pll_test;\r\nunsigned int i, j;\r\nWREG32(RADEON_TEST_DEBUG_MUX, (RREG32(RADEON_TEST_DEBUG_MUX) & 0xffff60ff) | 0x100);\r\nsave_pll_test = RREG32_PLL(RADEON_PLL_TEST_CNTL);\r\nWREG32_PLL(RADEON_PLL_TEST_CNTL, save_pll_test & ~RADEON_PLL_MASK_READ_B);\r\nWREG8(RADEON_CLOCK_CNTL_INDEX, RADEON_PLL_TEST_CNTL);\r\nfor (i = 0; i < n_tests; i++) {\r\nWREG8(RADEON_CLOCK_CNTL_DATA + 3, 0);\r\nfor (j = 0; j < n_wait_loops; j++)\r\nif (RREG8(RADEON_CLOCK_CNTL_DATA + 3) >= cnt_threshold)\r\nbreak;\r\n}\r\nWREG32_PLL(RADEON_PLL_TEST_CNTL, save_pll_test);\r\nWREG32(RADEON_TEST_DEBUG_MUX, RREG32(RADEON_TEST_DEBUG_MUX) & 0xffffe0ff);\r\n}\r\nstatic void radeon_legacy_tv_write_fifo(struct radeon_encoder *radeon_encoder,\r\nuint16_t addr, uint32_t value)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t tmp;\r\nint i = 0;\r\nWREG32(RADEON_TV_HOST_WRITE_DATA, value);\r\nWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr);\r\nWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr | RADEON_HOST_FIFO_WT);\r\ndo {\r\ntmp = RREG32(RADEON_TV_HOST_RD_WT_CNTL);\r\nif ((tmp & RADEON_HOST_FIFO_WT_ACK) == 0)\r\nbreak;\r\ni++;\r\n} while (i < 10000);\r\nWREG32(RADEON_TV_HOST_RD_WT_CNTL, 0);\r\n}\r\nstatic uint16_t radeon_get_htiming_tables_addr(uint32_t tv_uv_adr)\r\n{\r\nuint16_t h_table;\r\nswitch ((tv_uv_adr & RADEON_HCODE_TABLE_SEL_MASK) >> RADEON_HCODE_TABLE_SEL_SHIFT) {\r\ncase 0:\r\nh_table = RADEON_TV_MAX_FIFO_ADDR_INTERNAL;\r\nbreak;\r\ncase 1:\r\nh_table = ((tv_uv_adr & RADEON_TABLE1_BOT_ADR_MASK) >> RADEON_TABLE1_BOT_ADR_SHIFT) * 2;\r\nbreak;\r\ncase 2:\r\nh_table = ((tv_uv_adr & RADEON_TABLE3_TOP_ADR_MASK) >> RADEON_TABLE3_TOP_ADR_SHIFT) * 2;\r\nbreak;\r\ndefault:\r\nh_table = 0;\r\nbreak;\r\n}\r\nreturn h_table;\r\n}\r\nstatic uint16_t radeon_get_vtiming_tables_addr(uint32_t tv_uv_adr)\r\n{\r\nuint16_t v_table;\r\nswitch ((tv_uv_adr & RADEON_VCODE_TABLE_SEL_MASK) >> RADEON_VCODE_TABLE_SEL_SHIFT) {\r\ncase 0:\r\nv_table = ((tv_uv_adr & RADEON_MAX_UV_ADR_MASK) >> RADEON_MAX_UV_ADR_SHIFT) * 2 + 1;\r\nbreak;\r\ncase 1:\r\nv_table = ((tv_uv_adr & RADEON_TABLE1_BOT_ADR_MASK) >> RADEON_TABLE1_BOT_ADR_SHIFT) * 2 + 1;\r\nbreak;\r\ncase 2:\r\nv_table = ((tv_uv_adr & RADEON_TABLE3_TOP_ADR_MASK) >> RADEON_TABLE3_TOP_ADR_SHIFT) * 2 + 1;\r\nbreak;\r\ndefault:\r\nv_table = 0;\r\nbreak;\r\n}\r\nreturn v_table;\r\n}\r\nstatic void radeon_restore_tv_timing_tables(struct radeon_encoder *radeon_encoder)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nuint16_t h_table, v_table;\r\nuint32_t tmp;\r\nint i;\r\nWREG32(RADEON_TV_UV_ADR, tv_dac->tv.tv_uv_adr);\r\nh_table = radeon_get_htiming_tables_addr(tv_dac->tv.tv_uv_adr);\r\nv_table = radeon_get_vtiming_tables_addr(tv_dac->tv.tv_uv_adr);\r\nfor (i = 0; i < MAX_H_CODE_TIMING_LEN; i += 2, h_table--) {\r\ntmp = ((uint32_t)tv_dac->tv.h_code_timing[i] << 14) | ((uint32_t)tv_dac->tv.h_code_timing[i+1]);\r\nradeon_legacy_tv_write_fifo(radeon_encoder, h_table, tmp);\r\nif (tv_dac->tv.h_code_timing[i] == 0 || tv_dac->tv.h_code_timing[i + 1] == 0)\r\nbreak;\r\n}\r\nfor (i = 0; i < MAX_V_CODE_TIMING_LEN; i += 2, v_table++) {\r\ntmp = ((uint32_t)tv_dac->tv.v_code_timing[i+1] << 14) | ((uint32_t)tv_dac->tv.v_code_timing[i]);\r\nradeon_legacy_tv_write_fifo(radeon_encoder, v_table, tmp);\r\nif (tv_dac->tv.v_code_timing[i] == 0 || tv_dac->tv.v_code_timing[i + 1] == 0)\r\nbreak;\r\n}\r\n}\r\nstatic void radeon_legacy_write_tv_restarts(struct radeon_encoder *radeon_encoder)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nWREG32(RADEON_TV_FRESTART, tv_dac->tv.frestart);\r\nWREG32(RADEON_TV_HRESTART, tv_dac->tv.hrestart);\r\nWREG32(RADEON_TV_VRESTART, tv_dac->tv.vrestart);\r\n}\r\nstatic bool radeon_legacy_tv_init_restarts(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nstruct radeon_crtc *radeon_crtc;\r\nint restart;\r\nunsigned int h_total, v_total, f_total;\r\nint v_offset, h_offset;\r\nu16 p1, p2, h_inc;\r\nbool h_changed;\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nstruct radeon_pll *pll;\r\nradeon_crtc = to_radeon_crtc(radeon_encoder->base.crtc);\r\nif (radeon_crtc->crtc_id == 1)\r\npll = &rdev->clock.p2pll;\r\nelse\r\npll = &rdev->clock.p1pll;\r\nconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\r\nif (!const_ptr)\r\nreturn false;\r\nh_total = const_ptr->hor_total;\r\nv_total = const_ptr->ver_total;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60)\r\nf_total = NTSC_TV_VFTOTAL + 1;\r\nelse\r\nf_total = PAL_TV_VFTOTAL + 1;\r\nh_offset = tv_dac->h_pos * H_POS_UNIT;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M) {\r\nh_offset -= 50;\r\np1 = hor_timing_NTSC[H_TABLE_POS1];\r\np2 = hor_timing_NTSC[H_TABLE_POS2];\r\n} else {\r\np1 = hor_timing_PAL[H_TABLE_POS1];\r\np2 = hor_timing_PAL[H_TABLE_POS2];\r\n}\r\np1 = (u16)((int)p1 + h_offset);\r\np2 = (u16)((int)p2 - h_offset);\r\nh_changed = (p1 != tv_dac->tv.h_code_timing[H_TABLE_POS1] ||\r\np2 != tv_dac->tv.h_code_timing[H_TABLE_POS2]);\r\ntv_dac->tv.h_code_timing[H_TABLE_POS1] = p1;\r\ntv_dac->tv.h_code_timing[H_TABLE_POS2] = p2;\r\nh_offset = (h_offset * (int)(const_ptr->pix_to_tv)) / 1000;\r\nrestart = const_ptr->def_restart;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60)\r\nv_offset = ((int)(v_total * h_total) * 2 * tv_dac->v_pos) / (int)(NTSC_TV_LINES_PER_FRAME);\r\nelse\r\nv_offset = ((int)(v_total * h_total) * 2 * tv_dac->v_pos) / (int)(PAL_TV_LINES_PER_FRAME);\r\nrestart -= v_offset + h_offset;\r\nDRM_DEBUG_KMS("compute_restarts: def = %u h = %d v = %d, p1 = %04x, p2 = %04x, restart = %d\n",\r\nconst_ptr->def_restart, tv_dac->h_pos, tv_dac->v_pos, p1, p2, restart);\r\ntv_dac->tv.hrestart = restart % h_total;\r\nrestart /= h_total;\r\ntv_dac->tv.vrestart = restart % v_total;\r\nrestart /= v_total;\r\ntv_dac->tv.frestart = restart % f_total;\r\nDRM_DEBUG_KMS("compute_restart: F/H/V=%u,%u,%u\n",\r\n(unsigned)tv_dac->tv.frestart,\r\n(unsigned)tv_dac->tv.vrestart,\r\n(unsigned)tv_dac->tv.hrestart);\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M)\r\nh_inc = (u16)((int)(const_ptr->hor_resolution * 4096 * NTSC_TV_CLOCK_T) /\r\n(tv_dac->h_size * (int)(NTSC_TV_H_SIZE_UNIT) + (int)(NTSC_TV_ZERO_H_SIZE)));\r\nelse\r\nh_inc = (u16)((int)(const_ptr->hor_resolution * 4096 * PAL_TV_CLOCK_T) /\r\n(tv_dac->h_size * (int)(PAL_TV_H_SIZE_UNIT) + (int)(PAL_TV_ZERO_H_SIZE)));\r\ntv_dac->tv.timing_cntl = (tv_dac->tv.timing_cntl & ~RADEON_H_INC_MASK) |\r\n((u32)h_inc << RADEON_H_INC_SHIFT);\r\nDRM_DEBUG_KMS("compute_restart: h_size = %d h_inc = %d\n", tv_dac->h_size, h_inc);\r\nreturn h_changed;\r\n}\r\nvoid radeon_legacy_tv_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nstruct radeon_crtc *radeon_crtc;\r\nint i;\r\nuint16_t pll_ref_freq;\r\nuint32_t vert_space, flicker_removal, tmp;\r\nuint32_t tv_master_cntl, tv_rgb_cntl, tv_dac_cntl;\r\nuint32_t tv_modulator_cntl1, tv_modulator_cntl2;\r\nuint32_t tv_vscaler_cntl1, tv_vscaler_cntl2;\r\nuint32_t tv_pll_cntl, tv_pll_cntl1, tv_ftotal;\r\nuint32_t tv_y_fall_cntl, tv_y_rise_cntl, tv_y_saw_tooth_cntl;\r\nuint32_t m, n, p;\r\nconst uint16_t *hor_timing;\r\nconst uint16_t *vert_timing;\r\nconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, &pll_ref_freq);\r\nif (!const_ptr)\r\nreturn;\r\nradeon_crtc = to_radeon_crtc(encoder->crtc);\r\ntv_master_cntl = (RADEON_VIN_ASYNC_RST |\r\nRADEON_CRT_FIFO_CE_EN |\r\nRADEON_TV_FIFO_CE_EN |\r\nRADEON_TV_ON);\r\nif (!ASIC_IS_R300(rdev))\r\ntv_master_cntl |= RADEON_TVCLK_ALWAYS_ONb;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J)\r\ntv_master_cntl |= RADEON_RESTART_PHASE_FIX;\r\ntv_modulator_cntl1 = (RADEON_SLEW_RATE_LIMIT |\r\nRADEON_SYNC_TIP_LEVEL |\r\nRADEON_YFLT_EN |\r\nRADEON_UVFLT_EN |\r\n(6 << RADEON_CY_FILT_BLEND_SHIFT));\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J) {\r\ntv_modulator_cntl1 |= (0x46 << RADEON_SET_UP_LEVEL_SHIFT) |\r\n(0x3b << RADEON_BLANK_LEVEL_SHIFT);\r\ntv_modulator_cntl2 = (-111 & RADEON_TV_U_BURST_LEVEL_MASK) |\r\n((0 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\r\n} else if (tv_dac->tv_std == TV_STD_SCART_PAL) {\r\ntv_modulator_cntl1 |= RADEON_ALT_PHASE_EN;\r\ntv_modulator_cntl2 = (0 & RADEON_TV_U_BURST_LEVEL_MASK) |\r\n((0 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\r\n} else {\r\ntv_modulator_cntl1 |= RADEON_ALT_PHASE_EN |\r\n(0x3b << RADEON_SET_UP_LEVEL_SHIFT) |\r\n(0x3b << RADEON_BLANK_LEVEL_SHIFT);\r\ntv_modulator_cntl2 = (-78 & RADEON_TV_U_BURST_LEVEL_MASK) |\r\n((62 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\r\n}\r\ntv_rgb_cntl = (RADEON_RGB_DITHER_EN\r\n| RADEON_TVOUT_SCALE_EN\r\n| (0x0b << RADEON_UVRAM_READ_MARGIN_SHIFT)\r\n| (0x07 << RADEON_FIFORAM_FFMACRO_READ_MARGIN_SHIFT)\r\n| RADEON_RGB_ATTEN_SEL(0x3)\r\n| RADEON_RGB_ATTEN_VAL(0xc));\r\nif (radeon_crtc->crtc_id == 1)\r\ntv_rgb_cntl |= RADEON_RGB_SRC_SEL_CRTC2;\r\nelse {\r\nif (radeon_crtc->rmx_type != RMX_OFF)\r\ntv_rgb_cntl |= RADEON_RGB_SRC_SEL_RMX;\r\nelse\r\ntv_rgb_cntl |= RADEON_RGB_SRC_SEL_CRTC1;\r\n}\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60)\r\nvert_space = const_ptr->ver_total * 2 * 10000 / NTSC_TV_LINES_PER_FRAME;\r\nelse\r\nvert_space = const_ptr->ver_total * 2 * 10000 / PAL_TV_LINES_PER_FRAME;\r\ntmp = RREG32(RADEON_TV_VSCALER_CNTL1);\r\ntmp &= 0xe3ff0000;\r\ntmp |= (vert_space * (1 << FRAC_BITS) / 10000);\r\ntv_vscaler_cntl1 = tmp;\r\nif (pll_ref_freq == 2700)\r\ntv_vscaler_cntl1 |= RADEON_RESTART_FIELD;\r\nif (const_ptr->hor_resolution == 1024)\r\ntv_vscaler_cntl1 |= (4 << RADEON_Y_DEL_W_SIG_SHIFT);\r\nelse\r\ntv_vscaler_cntl1 |= (2 << RADEON_Y_DEL_W_SIG_SHIFT);\r\ntmp = const_ptr->ver_total * 2 * 1000;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60) {\r\ntmp /= NTSC_TV_LINES_PER_FRAME;\r\n} else {\r\ntmp /= PAL_TV_LINES_PER_FRAME;\r\n}\r\nflicker_removal = (tmp + 500) / 1000;\r\nif (flicker_removal < 3)\r\nflicker_removal = 3;\r\nfor (i = 0; i < ARRAY_SIZE(SLOPE_limit); ++i) {\r\nif (flicker_removal == SLOPE_limit[i])\r\nbreak;\r\n}\r\ntv_y_saw_tooth_cntl = (vert_space * SLOPE_value[i] * (1 << (FRAC_BITS - 1)) +\r\n5001) / 10000 / 8 | ((SLOPE_value[i] *\r\n(1 << (FRAC_BITS - 1)) / 8) << 16);\r\ntv_y_fall_cntl =\r\n(YCOEF_EN_value[i] << 17) | ((YCOEF_value[i] * (1 << 8) / 8) << 24) |\r\nRADEON_Y_FALL_PING_PONG | (272 * SLOPE_value[i] / 8) * (1 << (FRAC_BITS - 1)) /\r\n1024;\r\ntv_y_rise_cntl = RADEON_Y_RISE_PING_PONG|\r\n(flicker_removal * 1024 - 272) * SLOPE_value[i] / 8 * (1 << (FRAC_BITS - 1)) / 1024;\r\ntv_vscaler_cntl2 = RREG32(RADEON_TV_VSCALER_CNTL2) & 0x00fffff0;\r\ntv_vscaler_cntl2 |= (0x10 << 24) |\r\nRADEON_DITHER_MODE |\r\nRADEON_Y_OUTPUT_DITHER_EN |\r\nRADEON_UV_OUTPUT_DITHER_EN |\r\nRADEON_UV_TO_BUF_DITHER_EN;\r\ntmp = (tv_vscaler_cntl1 >> RADEON_UV_INC_SHIFT) & RADEON_UV_INC_MASK;\r\ntmp = ((16384 * 256 * 10) / tmp + 5) / 10;\r\ntmp = (tmp << RADEON_UV_OUTPUT_POST_SCALE_SHIFT) | 0x000b0000;\r\ntv_dac->tv.timing_cntl = tmp;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60)\r\ntv_dac_cntl = tv_dac->ntsc_tvdac_adj;\r\nelse\r\ntv_dac_cntl = tv_dac->pal_tvdac_adj;\r\ntv_dac_cntl |= RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J)\r\ntv_dac_cntl |= RADEON_TV_DAC_STD_NTSC;\r\nelse\r\ntv_dac_cntl |= RADEON_TV_DAC_STD_PAL;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J) {\r\nif (pll_ref_freq == 2700) {\r\nm = NTSC_TV_PLL_M_27;\r\nn = NTSC_TV_PLL_N_27;\r\np = NTSC_TV_PLL_P_27;\r\n} else {\r\nm = NTSC_TV_PLL_M_14;\r\nn = NTSC_TV_PLL_N_14;\r\np = NTSC_TV_PLL_P_14;\r\n}\r\n} else {\r\nif (pll_ref_freq == 2700) {\r\nm = PAL_TV_PLL_M_27;\r\nn = PAL_TV_PLL_N_27;\r\np = PAL_TV_PLL_P_27;\r\n} else {\r\nm = PAL_TV_PLL_M_14;\r\nn = PAL_TV_PLL_N_14;\r\np = PAL_TV_PLL_P_14;\r\n}\r\n}\r\ntv_pll_cntl = (m & RADEON_TV_M0LO_MASK) |\r\n(((m >> 8) & RADEON_TV_M0HI_MASK) << RADEON_TV_M0HI_SHIFT) |\r\n((n & RADEON_TV_N0LO_MASK) << RADEON_TV_N0LO_SHIFT) |\r\n(((n >> 9) & RADEON_TV_N0HI_MASK) << RADEON_TV_N0HI_SHIFT) |\r\n((p & RADEON_TV_P_MASK) << RADEON_TV_P_SHIFT);\r\ntv_pll_cntl1 = (((4 & RADEON_TVPCP_MASK) << RADEON_TVPCP_SHIFT) |\r\n((4 & RADEON_TVPVG_MASK) << RADEON_TVPVG_SHIFT) |\r\n((1 & RADEON_TVPDC_MASK) << RADEON_TVPDC_SHIFT) |\r\nRADEON_TVCLK_SRC_SEL_TVPLL |\r\nRADEON_TVPLL_TEST_DIS);\r\ntv_dac->tv.tv_uv_adr = 0xc8;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60) {\r\ntv_ftotal = NTSC_TV_VFTOTAL;\r\nhor_timing = hor_timing_NTSC;\r\nvert_timing = vert_timing_NTSC;\r\n} else {\r\nhor_timing = hor_timing_PAL;\r\nvert_timing = vert_timing_PAL;\r\ntv_ftotal = PAL_TV_VFTOTAL;\r\n}\r\nfor (i = 0; i < MAX_H_CODE_TIMING_LEN; i++) {\r\nif ((tv_dac->tv.h_code_timing[i] = hor_timing[i]) == 0)\r\nbreak;\r\n}\r\nfor (i = 0; i < MAX_V_CODE_TIMING_LEN; i++) {\r\nif ((tv_dac->tv.v_code_timing[i] = vert_timing[i]) == 0)\r\nbreak;\r\n}\r\nradeon_legacy_tv_init_restarts(encoder);\r\nWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST |\r\nRADEON_CRT_ASYNC_RST | RADEON_TV_FIFO_ASYNC_RST));\r\ntmp = RREG32(RADEON_TV_DAC_CNTL);\r\ntmp &= ~RADEON_TV_DAC_NBLANK;\r\ntmp |= RADEON_TV_DAC_BGSLEEP |\r\nRADEON_TV_DAC_RDACPD |\r\nRADEON_TV_DAC_GDACPD |\r\nRADEON_TV_DAC_BDACPD;\r\nWREG32(RADEON_TV_DAC_CNTL, tmp);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVCLK_SRC_SEL_TVPLL);\r\nWREG32_PLL(RADEON_TV_PLL_CNTL, tv_pll_cntl);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, RADEON_TVPLL_RESET, ~RADEON_TVPLL_RESET);\r\nradeon_wait_pll_lock(encoder, 200, 800, 135);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVPLL_RESET);\r\nradeon_wait_pll_lock(encoder, 300, 160, 27);\r\nradeon_wait_pll_lock(encoder, 200, 800, 135);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~0xf);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, RADEON_TVCLK_SRC_SEL_TVPLL, ~RADEON_TVCLK_SRC_SEL_TVPLL);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, (1 << RADEON_TVPDC_SHIFT), ~RADEON_TVPDC_MASK);\r\nWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVPLL_SLEEP);\r\nWREG32(RADEON_TV_RGB_CNTL, tv_rgb_cntl);\r\nWREG32(RADEON_TV_HTOTAL, const_ptr->hor_total - 1);\r\nWREG32(RADEON_TV_HDISP, const_ptr->hor_resolution - 1);\r\nWREG32(RADEON_TV_HSTART, const_ptr->hor_start);\r\nWREG32(RADEON_TV_VTOTAL, const_ptr->ver_total - 1);\r\nWREG32(RADEON_TV_VDISP, const_ptr->ver_resolution - 1);\r\nWREG32(RADEON_TV_FTOTAL, tv_ftotal);\r\nWREG32(RADEON_TV_VSCALER_CNTL1, tv_vscaler_cntl1);\r\nWREG32(RADEON_TV_VSCALER_CNTL2, tv_vscaler_cntl2);\r\nWREG32(RADEON_TV_Y_FALL_CNTL, tv_y_fall_cntl);\r\nWREG32(RADEON_TV_Y_RISE_CNTL, tv_y_rise_cntl);\r\nWREG32(RADEON_TV_Y_SAW_TOOTH_CNTL, tv_y_saw_tooth_cntl);\r\nWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST |\r\nRADEON_CRT_ASYNC_RST));\r\nradeon_legacy_write_tv_restarts(radeon_encoder);\r\nradeon_restore_tv_timing_tables(radeon_encoder);\r\nWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST));\r\nWREG32(RADEON_TV_SYNC_CNTL, (RADEON_SYNC_PUB | RADEON_TV_SYNC_IO_DRIVE));\r\nWREG32(RADEON_TV_TIMING_CNTL, tv_dac->tv.timing_cntl);\r\nWREG32(RADEON_TV_MODULATOR_CNTL1, tv_modulator_cntl1);\r\nWREG32(RADEON_TV_MODULATOR_CNTL2, tv_modulator_cntl2);\r\nWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, (RADEON_Y_RED_EN |\r\nRADEON_C_GRN_EN |\r\nRADEON_CMP_BLU_EN |\r\nRADEON_DAC_DITHER_EN));\r\nWREG32(RADEON_TV_CRC_CNTL, 0);\r\nWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\r\nWREG32(RADEON_TV_GAIN_LIMIT_SETTINGS, ((0x17f << RADEON_UV_GAIN_LIMIT_SHIFT) |\r\n(0x5ff << RADEON_Y_GAIN_LIMIT_SHIFT)));\r\nWREG32(RADEON_TV_LINEAR_GAIN_SETTINGS, ((0x100 << RADEON_UV_GAIN_SHIFT) |\r\n(0x100 << RADEON_Y_GAIN_SHIFT)));\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\n}\r\nvoid radeon_legacy_tv_adjust_crtc_reg(struct drm_encoder *encoder,\r\nuint32_t *h_total_disp, uint32_t *h_sync_strt_wid,\r\nuint32_t *v_total_disp, uint32_t *v_sync_strt_wid)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nuint32_t tmp;\r\nconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\r\nif (!const_ptr)\r\nreturn;\r\n*h_total_disp = (((const_ptr->hor_resolution / 8) - 1) << RADEON_CRTC_H_DISP_SHIFT) |\r\n(((const_ptr->hor_total / 8) - 1) << RADEON_CRTC_H_TOTAL_SHIFT);\r\ntmp = *h_sync_strt_wid;\r\ntmp &= ~(RADEON_CRTC_H_SYNC_STRT_PIX | RADEON_CRTC_H_SYNC_STRT_CHAR);\r\ntmp |= (((const_ptr->hor_syncstart / 8) - 1) << RADEON_CRTC_H_SYNC_STRT_CHAR_SHIFT) |\r\n(const_ptr->hor_syncstart & 7);\r\n*h_sync_strt_wid = tmp;\r\n*v_total_disp = ((const_ptr->ver_resolution - 1) << RADEON_CRTC_V_DISP_SHIFT) |\r\n((const_ptr->ver_total - 1) << RADEON_CRTC_V_TOTAL_SHIFT);\r\ntmp = *v_sync_strt_wid;\r\ntmp &= ~RADEON_CRTC_V_SYNC_STRT;\r\ntmp |= ((const_ptr->ver_syncstart - 1) << RADEON_CRTC_V_SYNC_STRT_SHIFT);\r\n*v_sync_strt_wid = tmp;\r\n}\r\nstatic int get_post_div(int value)\r\n{\r\nint post_div;\r\nswitch (value) {\r\ncase 1: post_div = 0; break;\r\ncase 2: post_div = 1; break;\r\ncase 3: post_div = 4; break;\r\ncase 4: post_div = 2; break;\r\ncase 6: post_div = 6; break;\r\ncase 8: post_div = 3; break;\r\ncase 12: post_div = 7; break;\r\ncase 16:\r\ndefault: post_div = 5; break;\r\n}\r\nreturn post_div;\r\n}\r\nvoid radeon_legacy_tv_adjust_pll1(struct drm_encoder *encoder,\r\nuint32_t *htotal_cntl, uint32_t *ppll_ref_div,\r\nuint32_t *ppll_div_3, uint32_t *pixclks_cntl)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\r\nif (!const_ptr)\r\nreturn;\r\n*htotal_cntl = (const_ptr->hor_total & 0x7) | RADEON_HTOT_CNTL_VGA_EN;\r\n*ppll_ref_div = const_ptr->crtcPLL_M;\r\n*ppll_div_3 = (const_ptr->crtcPLL_N & 0x7ff) | (get_post_div(const_ptr->crtcPLL_post_div) << 16);\r\n*pixclks_cntl &= ~(RADEON_PIX2CLK_SRC_SEL_MASK | RADEON_PIXCLK_TV_SRC_SEL);\r\n*pixclks_cntl |= RADEON_PIX2CLK_SRC_SEL_P2PLLCLK;\r\n}\r\nvoid radeon_legacy_tv_adjust_pll2(struct drm_encoder *encoder,\r\nuint32_t *htotal2_cntl, uint32_t *p2pll_ref_div,\r\nuint32_t *p2pll_div_0, uint32_t *pixclks_cntl)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nconst struct radeon_tv_mode_constants *const_ptr;\r\nconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\r\nif (!const_ptr)\r\nreturn;\r\n*htotal2_cntl = (const_ptr->hor_total & 0x7);\r\n*p2pll_ref_div = const_ptr->crtcPLL_M;\r\n*p2pll_div_0 = (const_ptr->crtcPLL_N & 0x7ff) | (get_post_div(const_ptr->crtcPLL_post_div) << 16);\r\n*pixclks_cntl &= ~RADEON_PIX2CLK_SRC_SEL_MASK;\r\n*pixclks_cntl |= RADEON_PIX2CLK_SRC_SEL_P2PLLCLK | RADEON_PIXCLK_TV_SRC_SEL;\r\n}

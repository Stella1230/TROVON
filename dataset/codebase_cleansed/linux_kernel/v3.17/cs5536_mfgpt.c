void disable_mfgpt0_counter(void)\r\n{\r\noutw(inw(MFGPT0_SETUP) & 0x7fff, MFGPT0_SETUP);\r\n}\r\nvoid enable_mfgpt0_counter(void)\r\n{\r\noutw(0xe310, MFGPT0_SETUP);\r\n}\r\nstatic void init_mfgpt_timer(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nraw_spin_lock(&mfgpt_lock);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\noutw(COMPARE, MFGPT0_CMP2);\r\noutw(0, MFGPT0_CNT);\r\nenable_mfgpt0_counter();\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\nif (evt->mode == CLOCK_EVT_MODE_PERIODIC ||\r\nevt->mode == CLOCK_EVT_MODE_ONESHOT)\r\ndisable_mfgpt0_counter();\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nbreak;\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\n}\r\nraw_spin_unlock(&mfgpt_lock);\r\n}\r\nstatic irqreturn_t timer_interrupt(int irq, void *dev_id)\r\n{\r\nu32 basehi;\r\n_rdmsr(DIVIL_MSR_REG(DIVIL_LBAR_MFGPT), &basehi, &mfgpt_base);\r\noutw(inw(MFGPT0_SETUP) | 0x4000, MFGPT0_SETUP);\r\nmfgpt_clockevent.event_handler(&mfgpt_clockevent);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init setup_mfgpt0_timer(void)\r\n{\r\nu32 basehi;\r\nstruct clock_event_device *cd = &mfgpt_clockevent;\r\nunsigned int cpu = smp_processor_id();\r\ncd->cpumask = cpumask_of(cpu);\r\nclockevent_set_clock(cd, MFGPT_TICK_RATE);\r\ncd->max_delta_ns = clockevent_delta2ns(0xffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0xf, cd);\r\n_wrmsr(DIVIL_MSR_REG(MFGPT_IRQ), 0, 0x100);\r\n_wrmsr(DIVIL_MSR_REG(PIC_ZSEL_LOW), 0, 0x50000);\r\n_rdmsr(DIVIL_MSR_REG(DIVIL_LBAR_MFGPT), &basehi, &mfgpt_base);\r\nclockevents_register_device(cd);\r\nsetup_irq(CS5536_MFGPT_INTR, &irq5);\r\n}\r\nstatic cycle_t mfgpt_read(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nint count;\r\nu32 jifs;\r\nstatic int old_count;\r\nstatic u32 old_jifs;\r\nraw_spin_lock_irqsave(&mfgpt_lock, flags);\r\njifs = jiffies;\r\ncount = inw(MFGPT0_CNT);\r\nif (count < old_count && jifs == old_jifs)\r\ncount = old_count;\r\nold_count = count;\r\nold_jifs = jifs;\r\nraw_spin_unlock_irqrestore(&mfgpt_lock, flags);\r\nreturn (cycle_t) (jifs * COMPARE) + count;\r\n}\r\nint __init init_mfgpt_clocksource(void)\r\n{\r\nif (num_possible_cpus() > 1)\r\nreturn 0;\r\nreturn clocksource_register_hz(&clocksource_mfgpt, MFGPT_TICK_RATE);\r\n}

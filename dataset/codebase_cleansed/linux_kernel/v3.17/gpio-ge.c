static void gef_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\nunsigned int data;\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_OUT);\r\nif (value)\r\ndata = data | BIT(offset);\r\nelse\r\ndata = data & ~BIT(offset);\r\niowrite32be(data, mmchip->regs + GEF_GPIO_OUT);\r\n}\r\nstatic int gef_gpio_dir_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nunsigned int data;\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_DIRECT);\r\ndata = data | BIT(offset);\r\niowrite32be(data, mmchip->regs + GEF_GPIO_DIRECT);\r\nreturn 0;\r\n}\r\nstatic int gef_gpio_dir_out(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nunsigned int data;\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\ngef_gpio_set(mmchip->regs + GEF_GPIO_OUT, offset, value);\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_DIRECT);\r\ndata = data & ~BIT(offset);\r\niowrite32be(data, mmchip->regs + GEF_GPIO_DIRECT);\r\nreturn 0;\r\n}\r\nstatic int gef_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\nreturn !!(ioread32be(mmchip->regs + GEF_GPIO_IN) & BIT(offset));\r\n}\r\nstatic int __init gef_gpio_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *of_id =\r\nof_match_device(gef_gpio_ids, &pdev->dev);\r\nstruct of_mm_gpio_chip *mmchip;\r\nmmchip = devm_kzalloc(&pdev->dev, sizeof(*mmchip), GFP_KERNEL);\r\nif (!mmchip)\r\nreturn -ENOMEM;\r\nmmchip->gc.ngpio = (u16)(uintptr_t)of_id->data;\r\nmmchip->gc.of_gpio_n_cells = 2;\r\nmmchip->gc.direction_input = gef_gpio_dir_in;\r\nmmchip->gc.direction_output = gef_gpio_dir_out;\r\nmmchip->gc.get = gef_gpio_get;\r\nmmchip->gc.set = gef_gpio_set;\r\nreturn of_mm_gpiochip_add(pdev->dev.of_node, mmchip);\r\n}

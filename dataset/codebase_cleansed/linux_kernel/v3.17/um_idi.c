int diva_user_mode_idi_init(void)\r\n{\r\ndiva_os_initialize_spin_lock(&adapter_lock, "adapter");\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_user_mode_idi_adapter_features(diva_um_idi_adapter_t *a,\r\ndiva_um_idi_adapter_features_t *\r\nfeatures)\r\n{\r\nIDI_SYNC_REQ sync_req;\r\nif ((a) && (a->d.request)) {\r\nfeatures->type = a->d.type;\r\nfeatures->features = a->d.features;\r\nfeatures->channels = a->d.channels;\r\nmemset(features->name, 0, sizeof(features->name));\r\nsync_req.GetName.Req = 0;\r\nsync_req.GetName.Rc = IDI_SYNC_REQ_GET_NAME;\r\n(*(a->d.request)) ((ENTITY *)&sync_req);\r\nstrlcpy(features->name, sync_req.GetName.name,\r\nsizeof(features->name));\r\nsync_req.GetSerial.Req = 0;\r\nsync_req.GetSerial.Rc = IDI_SYNC_REQ_GET_SERIAL;\r\nsync_req.GetSerial.serial = 0;\r\n(*(a->d.request))((ENTITY *)&sync_req);\r\nfeatures->serial_number = sync_req.GetSerial.serial;\r\n}\r\nreturn ((a) ? 0 : -1);\r\n}\r\nvoid diva_user_mode_idi_remove_adapter(int adapter_nr)\r\n{\r\nstruct list_head *tmp;\r\ndiva_um_idi_adapter_t *a;\r\nlist_for_each(tmp, &adapter_q) {\r\na = list_entry(tmp, diva_um_idi_adapter_t, link);\r\nif (a->adapter_nr == adapter_nr) {\r\nlist_del(tmp);\r\ncleanup_adapter(a);\r\nDBG_LOG(("DIDD: del adapter(%d)", a->adapter_nr));\r\ndiva_os_free(0, a);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid diva_user_mode_idi_finit(void)\r\n{\r\nstruct list_head *tmp, *safe;\r\ndiva_um_idi_adapter_t *a;\r\nlist_for_each_safe(tmp, safe, &adapter_q) {\r\na = list_entry(tmp, diva_um_idi_adapter_t, link);\r\nlist_del(tmp);\r\ncleanup_adapter(a);\r\nDBG_LOG(("DIDD: del adapter(%d)", a->adapter_nr));\r\ndiva_os_free(0, a);\r\n}\r\ndiva_os_destroy_spin_lock(&adapter_lock, "adapter");\r\n}\r\nint diva_user_mode_idi_create_adapter(const DESCRIPTOR *d, int adapter_nr)\r\n{\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_um_idi_adapter_t *a =\r\n(diva_um_idi_adapter_t *) diva_os_malloc(0,\r\nsizeof\r\n(diva_um_idi_adapter_t));\r\nif (!a) {\r\nreturn (-1);\r\n}\r\nmemset(a, 0x00, sizeof(*a));\r\nINIT_LIST_HEAD(&a->entity_q);\r\na->d = *d;\r\na->adapter_nr = adapter_nr;\r\nDBG_LOG(("DIDD_ADD A(%d), type:%02x, features:%04x, channels:%d",\r\nadapter_nr, a->d.type, a->d.features, a->d.channels));\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "create_adapter");\r\nlist_add_tail(&a->link, &adapter_q);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "create_adapter");\r\nreturn (0);\r\n}\r\nstatic diva_um_idi_adapter_t *diva_um_idi_find_adapter(dword nr)\r\n{\r\ndiva_um_idi_adapter_t *a = NULL;\r\nstruct list_head *tmp;\r\nlist_for_each(tmp, &adapter_q) {\r\na = list_entry(tmp, diva_um_idi_adapter_t, link);\r\nDBG_TRC(("find_adapter: (%d)-(%d)", nr, a->adapter_nr));\r\nif (a->adapter_nr == (int)nr)\r\nbreak;\r\na = NULL;\r\n}\r\nreturn (a);\r\n}\r\nstatic void cleanup_adapter(diva_um_idi_adapter_t *a)\r\n{\r\nstruct list_head *tmp, *safe;\r\ndivas_um_idi_entity_t *e;\r\nlist_for_each_safe(tmp, safe, &a->entity_q) {\r\ne = list_entry(tmp, divas_um_idi_entity_t, link);\r\nlist_del(tmp);\r\ncleanup_entity(e);\r\nif (e->os_context) {\r\ndiva_os_wakeup_read(e->os_context);\r\ndiva_os_wakeup_close(e->os_context);\r\n}\r\n}\r\nmemset(&a->d, 0x00, sizeof(DESCRIPTOR));\r\n}\r\nstatic void cleanup_entity(divas_um_idi_entity_t *e)\r\n{\r\ne->os_ref = NULL;\r\ne->status = 0;\r\ne->adapter = NULL;\r\ne->e.Id = 0;\r\ne->rc_count = 0;\r\ne->status |= DIVA_UM_IDI_REMOVED;\r\ne->status |= DIVA_UM_IDI_REMOVE_PENDING;\r\ndiva_data_q_finit(&e->data);\r\ndiva_data_q_finit(&e->rc);\r\n}\r\nvoid *divas_um_idi_create_entity(dword adapter_nr, void *file)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\ndiva_os_spin_lock_magic_t old_irql;\r\nif ((e = (divas_um_idi_entity_t *) diva_os_malloc(0, sizeof(*e)))) {\r\nmemset(e, 0x00, sizeof(*e));\r\nif (!\r\n(e->os_context =\r\ndiva_os_malloc(0, diva_os_get_context_size()))) {\r\nDBG_LOG(("E(%08x) no memory for os context", e));\r\ndiva_os_free(0, e);\r\nreturn NULL;\r\n}\r\nmemset(e->os_context, 0x00, diva_os_get_context_size());\r\nif ((diva_data_q_init(&e->data, 2048 + 512, 16))) {\r\ndiva_os_free(0, e->os_context);\r\ndiva_os_free(0, e);\r\nreturn NULL;\r\n}\r\nif ((diva_data_q_init(&e->rc, sizeof(diva_um_idi_ind_hdr_t), 2))) {\r\ndiva_data_q_finit(&e->data);\r\ndiva_os_free(0, e->os_context);\r\ndiva_os_free(0, e);\r\nreturn NULL;\r\n}\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "create_entity");\r\nif (!(a = diva_um_idi_find_adapter(adapter_nr))) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "create_entity");\r\nDBG_LOG(("A: no adapter(%ld)", adapter_nr));\r\ncleanup_entity(e);\r\ndiva_os_free(0, e->os_context);\r\ndiva_os_free(0, e);\r\nreturn NULL;\r\n}\r\ne->os_ref = file;\r\ne->adapter = a;\r\nlist_add_tail(&e->link, &a->entity_q);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "create_entity");\r\nDBG_LOG(("A(%ld), create E(%08x)", adapter_nr, e));\r\n}\r\nreturn (e);\r\n}\r\nint divas_um_idi_delete_entity(int adapter_nr, void *entity)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\ndiva_os_spin_lock_magic_t old_irql;\r\nif (!(e = (divas_um_idi_entity_t *) entity))\r\nreturn (-1);\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "delete_entity");\r\nif ((a = e->adapter)) {\r\nlist_del(&e->link);\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "delete_entity");\r\ndiva_um_idi_stop_wdog(entity);\r\ncleanup_entity(e);\r\ndiva_os_free(0, e->os_context);\r\nmemset(e, 0x00, sizeof(*e));\r\nDBG_LOG(("A(%d) remove E:%08x", adapter_nr, e));\r\ndiva_os_free(0, e);\r\nreturn (0);\r\n}\r\nint diva_um_idi_read(void *entity,\r\nvoid *os_handle,\r\nvoid *dst,\r\nint max_length, divas_um_idi_copy_to_user_fn_t cp_fn)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\nconst void *data;\r\nint length, ret = 0;\r\ndiva_um_idi_data_queue_t *q;\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "read");\r\ne = (divas_um_idi_entity_t *) entity;\r\nif (!e || (!(a = e->adapter)) ||\r\n(e->status & DIVA_UM_IDI_REMOVE_PENDING) ||\r\n(e->status & DIVA_UM_IDI_REMOVED) ||\r\n(a->status & DIVA_UM_IDI_ADAPTER_REMOVED)) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "read");\r\nDBG_ERR(("E(%08x) read failed - adapter removed", e))\r\nreturn (-1);\r\n}\r\nDBG_TRC(("A(%d) E(%08x) read(%d)", a->adapter_nr, e, max_length));\r\ndata = diva_data_q_get_segment4read(&e->rc);\r\nq = &e->rc;\r\nif (!data) {\r\nif (!(e->status & DIVA_UM_IDI_RC_PENDING)) {\r\nDBG_TRC(("A(%d) E(%08x) read data", a->adapter_nr, e));\r\ndata = diva_data_q_get_segment4read(&e->data);\r\nq = &e->data;\r\n}\r\n} else {\r\ne->status &= ~DIVA_UM_IDI_RC_PENDING;\r\nDBG_TRC(("A(%d) E(%08x) read rc", a->adapter_nr, e));\r\n}\r\nif (data) {\r\nif ((length = diva_data_q_get_segment_length(q)) >\r\nmax_length) {\r\nDBG_ERR(("A: A(%d) E(%08x) read small buffer",\r\na->adapter_nr, e, ret));\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql,\r\n"read");\r\nreturn (-2);\r\n}\r\nif ((ret = (*cp_fn) (os_handle, dst, data, length)) >= 0) {\r\ndiva_data_q_ack_segment4read(q);\r\n}\r\n}\r\nDBG_TRC(("A(%d) E(%08x) read=%d", a->adapter_nr, e, ret));\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "read");\r\nreturn (ret);\r\n}\r\nint diva_um_idi_write(void *entity,\r\nvoid *os_handle,\r\nconst void *src,\r\nint length, divas_um_idi_copy_from_user_fn_t cp_fn)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\ndiva_um_idi_req_hdr_t *req;\r\nvoid *data;\r\nint ret = 0;\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "write");\r\ne = (divas_um_idi_entity_t *) entity;\r\nif (!e || (!(a = e->adapter)) ||\r\n(e->status & DIVA_UM_IDI_REMOVE_PENDING) ||\r\n(e->status & DIVA_UM_IDI_REMOVED) ||\r\n(a->status & DIVA_UM_IDI_ADAPTER_REMOVED)) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nDBG_ERR(("E(%08x) write failed - adapter removed", e))\r\nreturn (-1);\r\n}\r\nDBG_TRC(("A(%d) E(%08x) write(%d)", a->adapter_nr, e, length));\r\nif ((length < sizeof(*req)) || (length > sizeof(e->buffer))) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nreturn (-2);\r\n}\r\nif (e->status & DIVA_UM_IDI_RC_PENDING) {\r\nDBG_ERR(("A: A(%d) E(%08x) rc pending", a->adapter_nr, e));\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nreturn (-1);\r\n}\r\nif ((ret = (*cp_fn) (os_handle, e->buffer, src, length)) < 0) {\r\nDBG_TRC(("A: A(%d) E(%08x) write error=%d", a->adapter_nr,\r\ne, ret));\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nreturn (ret);\r\n}\r\nreq = (diva_um_idi_req_hdr_t *)&e->buffer[0];\r\nswitch (req->type) {\r\ncase DIVA_UM_IDI_GET_FEATURES:{\r\nDBG_LOG(("A(%d) get_features", a->adapter_nr));\r\nif (!(data =\r\ndiva_data_q_get_segment4write(&e->data))) {\r\nDBG_ERR(("A(%d) get_features, no free buffer",\r\na->adapter_nr));\r\ndiva_os_leave_spin_lock(&adapter_lock,\r\n&old_irql,\r\n"write");\r\nreturn (0);\r\n}\r\ndiva_user_mode_idi_adapter_features(a, &(((diva_um_idi_ind_hdr_t\r\n*) data)->hdr.features));\r\n((diva_um_idi_ind_hdr_t *) data)->type =\r\nDIVA_UM_IDI_IND_FEATURES;\r\n((diva_um_idi_ind_hdr_t *) data)->data_length = 0;\r\ndiva_data_q_ack_segment4write(&e->data,\r\nsizeof(diva_um_idi_ind_hdr_t));\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\ndiva_os_wakeup_read(e->os_context);\r\n}\r\nbreak;\r\ncase DIVA_UM_IDI_REQ:\r\ncase DIVA_UM_IDI_REQ_MAN:\r\ncase DIVA_UM_IDI_REQ_SIG:\r\ncase DIVA_UM_IDI_REQ_NET:\r\nDBG_TRC(("A(%d) REQ(%02d)-(%02d)-(%08x)", a->adapter_nr,\r\nreq->Req, req->ReqCh,\r\nreq->type & DIVA_UM_IDI_REQ_TYPE_MASK));\r\nswitch (process_idi_request(e, req)) {\r\ncase -1:\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nreturn (-1);\r\ncase -2:\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\ndiva_os_wakeup_read(e->os_context);\r\nbreak;\r\ndefault:\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "write");\r\nreturn (-1);\r\n}\r\nDBG_TRC(("A(%d) E(%08x) write=%d", a->adapter_nr, e, ret));\r\nreturn (ret);\r\n}\r\nstatic void diva_um_idi_xdi_callback(ENTITY *entity)\r\n{\r\ndivas_um_idi_entity_t *e = DIVAS_CONTAINING_RECORD(entity,\r\ndivas_um_idi_entity_t,\r\ne);\r\ndiva_os_spin_lock_magic_t old_irql;\r\nint call_wakeup = 0;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "xdi_callback");\r\nif (e->e.complete == 255) {\r\nif (!(e->status & DIVA_UM_IDI_REMOVE_PENDING)) {\r\ndiva_um_idi_stop_wdog(e);\r\n}\r\nif ((call_wakeup = process_idi_rc(e, e->e.Rc))) {\r\nif (e->rc_count) {\r\ne->rc_count--;\r\n}\r\n}\r\ne->e.Rc = 0;\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "xdi_callback");\r\nif (call_wakeup) {\r\ndiva_os_wakeup_read(e->os_context);\r\ndiva_os_wakeup_close(e->os_context);\r\n}\r\n} else {\r\nif (e->status & DIVA_UM_IDI_REMOVE_PENDING) {\r\ne->e.RNum = 0;\r\ne->e.RNR = 2;\r\n} else {\r\ncall_wakeup = process_idi_ind(e, e->e.Ind);\r\n}\r\ne->e.Ind = 0;\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "xdi_callback");\r\nif (call_wakeup) {\r\ndiva_os_wakeup_read(e->os_context);\r\n}\r\n}\r\n}\r\nstatic int process_idi_request(divas_um_idi_entity_t *e,\r\nconst diva_um_idi_req_hdr_t *req)\r\n{\r\nint assign = 0;\r\nbyte Req = (byte) req->Req;\r\ndword type = req->type & DIVA_UM_IDI_REQ_TYPE_MASK;\r\nif (!e->e.Id || !e->e.callback) {\r\nif (Req != ASSIGN) {\r\nDBG_ERR(("A: A(%d) E(%08x) not assigned",\r\ne->adapter->adapter_nr, e));\r\nreturn (-1);\r\n} else {\r\nswitch (type) {\r\ncase DIVA_UM_IDI_REQ_TYPE_MAN:\r\ne->e.Id = MAN_ID;\r\nDBG_TRC(("A(%d) E(%08x) assign MAN",\r\ne->adapter->adapter_nr, e));\r\nbreak;\r\ncase DIVA_UM_IDI_REQ_TYPE_SIG:\r\ne->e.Id = DSIG_ID;\r\nDBG_TRC(("A(%d) E(%08x) assign SIG",\r\ne->adapter->adapter_nr, e));\r\nbreak;\r\ncase DIVA_UM_IDI_REQ_TYPE_NET:\r\ne->e.Id = NL_ID;\r\nDBG_TRC(("A(%d) E(%08x) assign NET",\r\ne->adapter->adapter_nr, e));\r\nbreak;\r\ndefault:\r\nDBG_ERR(("A: A(%d) E(%08x) unknown type=%08x",\r\ne->adapter->adapter_nr, e,\r\ntype));\r\nreturn (-1);\r\n}\r\n}\r\ne->e.XNum = 1;\r\ne->e.RNum = 1;\r\ne->e.callback = diva_um_idi_xdi_callback;\r\ne->e.X = &e->XData;\r\ne->e.R = &e->RData;\r\nassign = 1;\r\n}\r\ne->status |= DIVA_UM_IDI_RC_PENDING;\r\ne->e.Req = Req;\r\ne->e.ReqCh = (byte) req->ReqCh;\r\ne->e.X->PLength = (word) req->data_length;\r\ne->e.X->P = (byte *)&req[1];\r\nDBG_TRC(("A(%d) E(%08x) request(%02x-%02x-%02x (%d))",\r\ne->adapter->adapter_nr, e, e->e.Id, e->e.Req,\r\ne->e.ReqCh, e->e.X->PLength));\r\ne->rc_count++;\r\nif (e->adapter && e->adapter->d.request) {\r\ndiva_um_idi_start_wdog(e);\r\n(*(e->adapter->d.request)) (&e->e);\r\n}\r\nif (assign) {\r\nif (e->e.Rc == OUT_OF_RESOURCES) {\r\nDBG_ERR(("A: A(%d) E(%08x) XDI out of entities",\r\ne->adapter->adapter_nr, e));\r\ne->e.Id = 0;\r\ne->e.ReqCh = 0;\r\ne->e.RcCh = 0;\r\ne->e.Ind = 0;\r\ne->e.IndCh = 0;\r\ne->e.XNum = 0;\r\ne->e.RNum = 0;\r\ne->e.callback = NULL;\r\ne->e.X = NULL;\r\ne->e.R = NULL;\r\nwrite_return_code(e, ASSIGN_RC | OUT_OF_RESOURCES);\r\nreturn (-2);\r\n} else {\r\ne->status |= DIVA_UM_IDI_ASSIGN_PENDING;\r\n}\r\n}\r\nreturn (0);\r\n}\r\nstatic int process_idi_rc(divas_um_idi_entity_t *e, byte rc)\r\n{\r\nDBG_TRC(("A(%d) E(%08x) rc(%02x-%02x-%02x)",\r\ne->adapter->adapter_nr, e, e->e.Id, rc, e->e.RcCh));\r\nif (e->status & DIVA_UM_IDI_ASSIGN_PENDING) {\r\ne->status &= ~DIVA_UM_IDI_ASSIGN_PENDING;\r\nif (rc != ASSIGN_OK) {\r\nDBG_ERR(("A: A(%d) E(%08x) ASSIGN failed",\r\ne->adapter->adapter_nr, e));\r\ne->e.callback = NULL;\r\ne->e.Id = 0;\r\ne->e.Req = 0;\r\ne->e.ReqCh = 0;\r\ne->e.Rc = 0;\r\ne->e.RcCh = 0;\r\ne->e.Ind = 0;\r\ne->e.IndCh = 0;\r\ne->e.X = NULL;\r\ne->e.R = NULL;\r\ne->e.XNum = 0;\r\ne->e.RNum = 0;\r\n}\r\n}\r\nif ((e->e.Req == REMOVE) && e->e.Id && (rc == 0xff)) {\r\nDBG_ERR(("A: A(%d) E(%08x) discard OK in REMOVE",\r\ne->adapter->adapter_nr, e));\r\nreturn (0);\r\n}\r\nif ((e->e.Req == REMOVE) && (!e->e.Id)) {\r\ne->e.callback = NULL;\r\ne->e.Id = 0;\r\ne->e.Req = 0;\r\ne->e.ReqCh = 0;\r\ne->e.Rc = 0;\r\ne->e.RcCh = 0;\r\ne->e.Ind = 0;\r\ne->e.IndCh = 0;\r\ne->e.X = NULL;\r\ne->e.R = NULL;\r\ne->e.XNum = 0;\r\ne->e.RNum = 0;\r\ne->rc_count = 0;\r\n}\r\nif ((e->e.Req == REMOVE) && (rc != 0xff)) {\r\nDBG_ERR(("A: A(%d) E(%08x) REMOVE FAILED",\r\ne->adapter->adapter_nr, e));\r\n}\r\nwrite_return_code(e, rc);\r\nreturn (1);\r\n}\r\nstatic int process_idi_ind(divas_um_idi_entity_t *e, byte ind)\r\n{\r\nint do_wakeup = 0;\r\nif (e->e.complete != 0x02) {\r\ndiva_um_idi_ind_hdr_t *pind =\r\n(diva_um_idi_ind_hdr_t *)\r\ndiva_data_q_get_segment4write(&e->data);\r\nif (pind) {\r\ne->e.RNum = 1;\r\ne->e.R->P = (byte *)&pind[1];\r\ne->e.R->PLength =\r\n(word) (diva_data_q_get_max_length(&e->data) -\r\nsizeof(*pind));\r\nDBG_TRC(("A(%d) E(%08x) ind_1(%02x-%02x-%02x)-[%d-%d]",\r\ne->adapter->adapter_nr, e, e->e.Id, ind,\r\ne->e.IndCh, e->e.RLength,\r\ne->e.R->PLength));\r\n} else {\r\nDBG_TRC(("A(%d) E(%08x) ind(%02x-%02x-%02x)-RNR",\r\ne->adapter->adapter_nr, e, e->e.Id, ind,\r\ne->e.IndCh));\r\ne->e.RNum = 0;\r\ne->e.RNR = 1;\r\ndo_wakeup = 1;\r\n}\r\n} else {\r\ndiva_um_idi_ind_hdr_t *pind =\r\n(diva_um_idi_ind_hdr_t *) (e->e.R->P);\r\nDBG_TRC(("A(%d) E(%08x) ind(%02x-%02x-%02x)-[%d]",\r\ne->adapter->adapter_nr, e, e->e.Id, ind,\r\ne->e.IndCh, e->e.R->PLength));\r\npind--;\r\npind->type = DIVA_UM_IDI_IND;\r\npind->hdr.ind.Ind = ind;\r\npind->hdr.ind.IndCh = e->e.IndCh;\r\npind->data_length = e->e.R->PLength;\r\ndiva_data_q_ack_segment4write(&e->data,\r\n(int) (sizeof(*pind) +\r\ne->e.R->PLength));\r\ndo_wakeup = 1;\r\n}\r\nif ((e->status & DIVA_UM_IDI_RC_PENDING) && !e->rc.count) {\r\ndo_wakeup = 0;\r\n}\r\nreturn (do_wakeup);\r\n}\r\nstatic int write_return_code(divas_um_idi_entity_t *e, byte rc)\r\n{\r\ndiva_um_idi_ind_hdr_t *prc;\r\nif (!(prc =\r\n(diva_um_idi_ind_hdr_t *) diva_data_q_get_segment4write(&e->rc)))\r\n{\r\nDBG_ERR(("A: A(%d) E(%08x) rc(%02x) lost",\r\ne->adapter->adapter_nr, e, rc));\r\ne->status &= ~DIVA_UM_IDI_RC_PENDING;\r\nreturn (-1);\r\n}\r\nprc->type = DIVA_UM_IDI_IND_RC;\r\nprc->hdr.rc.Rc = rc;\r\nprc->hdr.rc.RcCh = e->e.RcCh;\r\nprc->data_length = 0;\r\ndiva_data_q_ack_segment4write(&e->rc, sizeof(*prc));\r\nreturn (0);\r\n}\r\nint diva_user_mode_idi_ind_ready(void *entity, void *os_handle)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\ndiva_os_spin_lock_magic_t old_irql;\r\nint ret;\r\nif (!entity)\r\nreturn (-1);\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "ind_ready");\r\ne = (divas_um_idi_entity_t *) entity;\r\na = e->adapter;\r\nif ((!a) || (a->status & DIVA_UM_IDI_ADAPTER_REMOVED)) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "ind_ready");\r\nreturn (-1);\r\n}\r\nif (e->status & DIVA_UM_IDI_REMOVED) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "ind_ready");\r\nreturn (-1);\r\n}\r\nret = e->rc.count + e->data.count;\r\nif ((e->status & DIVA_UM_IDI_RC_PENDING) && !e->rc.count) {\r\nret = 0;\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "ind_ready");\r\nreturn (ret);\r\n}\r\nvoid *diva_um_id_get_os_context(void *entity)\r\n{\r\nreturn (((divas_um_idi_entity_t *) entity)->os_context);\r\n}\r\nint divas_um_idi_entity_assigned(void *entity)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\nint ret;\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "assigned?");\r\ne = (divas_um_idi_entity_t *) entity;\r\nif (!e || (!(a = e->adapter)) ||\r\n(e->status & DIVA_UM_IDI_REMOVED) ||\r\n(a->status & DIVA_UM_IDI_ADAPTER_REMOVED)) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "assigned?");\r\nreturn (0);\r\n}\r\ne->status |= DIVA_UM_IDI_REMOVE_PENDING;\r\nret = (e->e.Id || e->rc_count\r\n|| (e->status & DIVA_UM_IDI_ASSIGN_PENDING));\r\nDBG_TRC(("Id:%02x, rc_count:%d, status:%08x", e->e.Id, e->rc_count,\r\ne->status))\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "assigned?");\r\nreturn (ret);\r\n}\r\nint divas_um_idi_entity_start_remove(void *entity)\r\n{\r\ndivas_um_idi_entity_t *e;\r\ndiva_um_idi_adapter_t *a;\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "start_remove");\r\ne = (divas_um_idi_entity_t *) entity;\r\nif (!e || (!(a = e->adapter)) ||\r\n(e->status & DIVA_UM_IDI_REMOVED) ||\r\n(a->status & DIVA_UM_IDI_ADAPTER_REMOVED)) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "start_remove");\r\nreturn (0);\r\n}\r\nif (e->rc_count) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "start_remove");\r\nreturn (1);\r\n}\r\nif (!e->e.Id) {\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "start_remove");\r\nreturn (0);\r\n}\r\ne->e.Req = REMOVE;\r\ne->e.ReqCh = 0;\r\ne->rc_count++;\r\nDBG_TRC(("A(%d) E(%08x) request(%02x-%02x-%02x (%d))",\r\ne->adapter->adapter_nr, e, e->e.Id, e->e.Req,\r\ne->e.ReqCh, e->e.X->PLength));\r\nif (a->d.request)\r\n(*(a->d.request)) (&e->e);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "start_remove");\r\nreturn (0);\r\n}

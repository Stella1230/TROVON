static inline int serial_in(struct pnx8xxx_port *sport, int offset)\r\n{\r\nreturn (__raw_readl(sport->port.membase + offset));\r\n}\r\nstatic inline void serial_out(struct pnx8xxx_port *sport, int offset, int value)\r\n{\r\n__raw_writel(value, sport->port.membase + offset);\r\n}\r\nstatic void pnx8xxx_mctrl_check(struct pnx8xxx_port *sport)\r\n{\r\nunsigned int status, changed;\r\nstatus = sport->port.ops->get_mctrl(&sport->port);\r\nchanged = status ^ sport->old_status;\r\nif (changed == 0)\r\nreturn;\r\nsport->old_status = status;\r\nif (changed & TIOCM_RI)\r\nsport->port.icount.rng++;\r\nif (changed & TIOCM_DSR)\r\nsport->port.icount.dsr++;\r\nif (changed & TIOCM_CAR)\r\nuart_handle_dcd_change(&sport->port, status & TIOCM_CAR);\r\nif (changed & TIOCM_CTS)\r\nuart_handle_cts_change(&sport->port, status & TIOCM_CTS);\r\nwake_up_interruptible(&sport->port.state->port.delta_msr_wait);\r\n}\r\nstatic void pnx8xxx_timeout(unsigned long data)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)data;\r\nunsigned long flags;\r\nif (sport->port.state) {\r\nspin_lock_irqsave(&sport->port.lock, flags);\r\npnx8xxx_mctrl_check(sport);\r\nspin_unlock_irqrestore(&sport->port.lock, flags);\r\nmod_timer(&sport->timer, jiffies + MCTRL_TIMEOUT);\r\n}\r\n}\r\nstatic void pnx8xxx_stop_tx(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nu32 ien;\r\nien = serial_in(sport, PNX8XXX_IEN);\r\nserial_out(sport, PNX8XXX_IEN, ien & ~PNX8XXX_UART_INT_ALLTX);\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_ALLTX);\r\n}\r\nstatic void pnx8xxx_start_tx(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nu32 ien;\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_ALLTX);\r\nien = serial_in(sport, PNX8XXX_IEN);\r\nserial_out(sport, PNX8XXX_IEN, ien | PNX8XXX_UART_INT_ALLTX);\r\n}\r\nstatic void pnx8xxx_stop_rx(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nu32 ien;\r\nien = serial_in(sport, PNX8XXX_IEN);\r\nserial_out(sport, PNX8XXX_IEN, ien & ~PNX8XXX_UART_INT_ALLRX);\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_ALLRX);\r\n}\r\nstatic void pnx8xxx_enable_ms(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nmod_timer(&sport->timer, jiffies);\r\n}\r\nstatic void pnx8xxx_rx_chars(struct pnx8xxx_port *sport)\r\n{\r\nunsigned int status, ch, flg;\r\nstatus = FIFO_TO_SM(serial_in(sport, PNX8XXX_FIFO)) |\r\nISTAT_TO_SM(serial_in(sport, PNX8XXX_ISTAT));\r\nwhile (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXFIFO)) {\r\nch = serial_in(sport, PNX8XXX_FIFO) & 0xff;\r\nsport->port.icount.rx++;\r\nflg = TTY_NORMAL;\r\nif (status & (FIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE |\r\nPNX8XXX_UART_FIFO_RXPAR |\r\nPNX8XXX_UART_FIFO_RXBRK) |\r\nISTAT_TO_SM(PNX8XXX_UART_INT_RXOVRN))) {\r\nif (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXBRK)) {\r\nstatus &= ~(FIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE) |\r\nFIFO_TO_SM(PNX8XXX_UART_FIFO_RXPAR));\r\nsport->port.icount.brk++;\r\nif (uart_handle_break(&sport->port))\r\ngoto ignore_char;\r\n} else if (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXPAR))\r\nsport->port.icount.parity++;\r\nelse if (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE))\r\nsport->port.icount.frame++;\r\nif (status & ISTAT_TO_SM(PNX8XXX_UART_INT_RXOVRN))\r\nsport->port.icount.overrun++;\r\nstatus &= sport->port.read_status_mask;\r\nif (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXPAR))\r\nflg = TTY_PARITY;\r\nelse if (status & FIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE))\r\nflg = TTY_FRAME;\r\n#ifdef SUPPORT_SYSRQ\r\nsport->port.sysrq = 0;\r\n#endif\r\n}\r\nif (uart_handle_sysrq_char(&sport->port, ch))\r\ngoto ignore_char;\r\nuart_insert_char(&sport->port, status,\r\nISTAT_TO_SM(PNX8XXX_UART_INT_RXOVRN), ch, flg);\r\nignore_char:\r\nserial_out(sport, PNX8XXX_LCR, serial_in(sport, PNX8XXX_LCR) |\r\nPNX8XXX_UART_LCR_RX_NEXT);\r\nstatus = FIFO_TO_SM(serial_in(sport, PNX8XXX_FIFO)) |\r\nISTAT_TO_SM(serial_in(sport, PNX8XXX_ISTAT));\r\n}\r\nspin_unlock(&sport->port.lock);\r\ntty_flip_buffer_push(&sport->port.state->port);\r\nspin_lock(&sport->port.lock);\r\n}\r\nstatic void pnx8xxx_tx_chars(struct pnx8xxx_port *sport)\r\n{\r\nstruct circ_buf *xmit = &sport->port.state->xmit;\r\nif (sport->port.x_char) {\r\nserial_out(sport, PNX8XXX_FIFO, sport->port.x_char);\r\nsport->port.icount.tx++;\r\nsport->port.x_char = 0;\r\nreturn;\r\n}\r\npnx8xxx_mctrl_check(sport);\r\nif (uart_circ_empty(xmit) || uart_tx_stopped(&sport->port)) {\r\npnx8xxx_stop_tx(&sport->port);\r\nreturn;\r\n}\r\nwhile (((serial_in(sport, PNX8XXX_FIFO) &\r\nPNX8XXX_UART_FIFO_TXFIFO) >> 16) < 16) {\r\nserial_out(sport, PNX8XXX_FIFO, xmit->buf[xmit->tail]);\r\nxmit->tail = (xmit->tail + 1) & (UART_XMIT_SIZE - 1);\r\nsport->port.icount.tx++;\r\nif (uart_circ_empty(xmit))\r\nbreak;\r\n}\r\nif (uart_circ_chars_pending(xmit) < WAKEUP_CHARS)\r\nuart_write_wakeup(&sport->port);\r\nif (uart_circ_empty(xmit))\r\npnx8xxx_stop_tx(&sport->port);\r\n}\r\nstatic irqreturn_t pnx8xxx_int(int irq, void *dev_id)\r\n{\r\nstruct pnx8xxx_port *sport = dev_id;\r\nunsigned int status;\r\nspin_lock(&sport->port.lock);\r\nstatus = serial_in(sport, PNX8XXX_ISTAT) & serial_in(sport, PNX8XXX_IEN);\r\nif (status & (PNX8XXX_UART_INT_RX | PNX8XXX_UART_INT_BREAK))\r\npnx8xxx_rx_chars(sport);\r\nif (status & PNX8XXX_UART_INT_TX)\r\npnx8xxx_tx_chars(sport);\r\nserial_out(sport, PNX8XXX_ICLR, status);\r\nspin_unlock(&sport->port.lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic unsigned int pnx8xxx_tx_empty(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nreturn serial_in(sport, PNX8XXX_FIFO) & PNX8XXX_UART_FIFO_TXFIFO_STA ? 0 : TIOCSER_TEMT;\r\n}\r\nstatic unsigned int pnx8xxx_get_mctrl(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nunsigned int mctrl = TIOCM_DSR;\r\nunsigned int msr;\r\nmsr = serial_in(sport, PNX8XXX_MCR);\r\nmctrl |= msr & PNX8XXX_UART_MCR_CTS ? TIOCM_CTS : 0;\r\nmctrl |= msr & PNX8XXX_UART_MCR_DCD ? TIOCM_CAR : 0;\r\nreturn mctrl;\r\n}\r\nstatic void pnx8xxx_set_mctrl(struct uart_port *port, unsigned int mctrl)\r\n{\r\n#if 0\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nunsigned int msr;\r\n#endif\r\n}\r\nstatic void pnx8xxx_break_ctl(struct uart_port *port, int break_state)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nunsigned long flags;\r\nunsigned int lcr;\r\nspin_lock_irqsave(&sport->port.lock, flags);\r\nlcr = serial_in(sport, PNX8XXX_LCR);\r\nif (break_state == -1)\r\nlcr |= PNX8XXX_UART_LCR_TXBREAK;\r\nelse\r\nlcr &= ~PNX8XXX_UART_LCR_TXBREAK;\r\nserial_out(sport, PNX8XXX_LCR, lcr);\r\nspin_unlock_irqrestore(&sport->port.lock, flags);\r\n}\r\nstatic int pnx8xxx_startup(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nint retval;\r\nretval = request_irq(sport->port.irq, pnx8xxx_int, 0,\r\n"pnx8xxx-uart", sport);\r\nif (retval)\r\nreturn retval;\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_ALLRX |\r\nPNX8XXX_UART_INT_ALLTX);\r\nserial_out(sport, PNX8XXX_IEN, serial_in(sport, PNX8XXX_IEN) |\r\nPNX8XXX_UART_INT_ALLRX |\r\nPNX8XXX_UART_INT_ALLTX);\r\nspin_lock_irq(&sport->port.lock);\r\npnx8xxx_enable_ms(&sport->port);\r\nspin_unlock_irq(&sport->port.lock);\r\nreturn 0;\r\n}\r\nstatic void pnx8xxx_shutdown(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nint lcr;\r\ndel_timer_sync(&sport->timer);\r\nserial_out(sport, PNX8XXX_IEN, 0);\r\nlcr = serial_in(sport, PNX8XXX_LCR);\r\nlcr &= ~PNX8XXX_UART_LCR_TXBREAK;\r\nlcr |= PNX8XXX_UART_LCR_TX_RST | PNX8XXX_UART_LCR_RX_RST;\r\nserial_out(sport, PNX8XXX_LCR, lcr);\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_ALLRX |\r\nPNX8XXX_UART_INT_ALLTX);\r\nfree_irq(sport->port.irq, sport);\r\n}\r\nstatic void\r\npnx8xxx_set_termios(struct uart_port *port, struct ktermios *termios,\r\nstruct ktermios *old)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nunsigned long flags;\r\nunsigned int lcr_fcr, old_ien, baud, quot;\r\nunsigned int old_csize = old ? old->c_cflag & CSIZE : CS8;\r\nwhile ((termios->c_cflag & CSIZE) != CS7 &&\r\n(termios->c_cflag & CSIZE) != CS8) {\r\ntermios->c_cflag &= ~CSIZE;\r\ntermios->c_cflag |= old_csize;\r\nold_csize = CS8;\r\n}\r\nif ((termios->c_cflag & CSIZE) == CS8)\r\nlcr_fcr = PNX8XXX_UART_LCR_8BIT;\r\nelse\r\nlcr_fcr = 0;\r\nif (termios->c_cflag & CSTOPB)\r\nlcr_fcr |= PNX8XXX_UART_LCR_2STOPB;\r\nif (termios->c_cflag & PARENB) {\r\nlcr_fcr |= PNX8XXX_UART_LCR_PAREN;\r\nif (!(termios->c_cflag & PARODD))\r\nlcr_fcr |= PNX8XXX_UART_LCR_PAREVN;\r\n}\r\nbaud = uart_get_baud_rate(port, termios, old, 0, port->uartclk/16);\r\nquot = uart_get_divisor(port, baud);\r\nspin_lock_irqsave(&sport->port.lock, flags);\r\nsport->port.read_status_mask = ISTAT_TO_SM(PNX8XXX_UART_INT_RXOVRN) |\r\nISTAT_TO_SM(PNX8XXX_UART_INT_EMPTY) |\r\nISTAT_TO_SM(PNX8XXX_UART_INT_RX);\r\nif (termios->c_iflag & INPCK)\r\nsport->port.read_status_mask |=\r\nFIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE) |\r\nFIFO_TO_SM(PNX8XXX_UART_FIFO_RXPAR);\r\nif (termios->c_iflag & (IGNBRK | BRKINT | PARMRK))\r\nsport->port.read_status_mask |=\r\nISTAT_TO_SM(PNX8XXX_UART_INT_BREAK);\r\nsport->port.ignore_status_mask = 0;\r\nif (termios->c_iflag & IGNPAR)\r\nsport->port.ignore_status_mask |=\r\nFIFO_TO_SM(PNX8XXX_UART_FIFO_RXFE) |\r\nFIFO_TO_SM(PNX8XXX_UART_FIFO_RXPAR);\r\nif (termios->c_iflag & IGNBRK) {\r\nsport->port.ignore_status_mask |=\r\nISTAT_TO_SM(PNX8XXX_UART_INT_BREAK);\r\nif (termios->c_iflag & IGNPAR)\r\nsport->port.ignore_status_mask |=\r\nISTAT_TO_SM(PNX8XXX_UART_INT_RXOVRN);\r\n}\r\nif ((termios->c_cflag & CREAD) == 0)\r\nsport->port.ignore_status_mask |=\r\nISTAT_TO_SM(PNX8XXX_UART_INT_RX);\r\ndel_timer_sync(&sport->timer);\r\nuart_update_timeout(port, termios->c_cflag, baud);\r\nold_ien = serial_in(sport, PNX8XXX_IEN);\r\nserial_out(sport, PNX8XXX_IEN, old_ien & ~(PNX8XXX_UART_INT_ALLTX |\r\nPNX8XXX_UART_INT_ALLRX));\r\nwhile (serial_in(sport, PNX8XXX_FIFO) & PNX8XXX_UART_FIFO_TXFIFO_STA)\r\nbarrier();\r\nserial_out(sport, PNX8XXX_IEN, 0);\r\nlcr_fcr |= PNX8XXX_UART_LCR_TX_RST;\r\nlcr_fcr |= PNX8XXX_UART_LCR_RX_RST;\r\nserial_out(sport, PNX8XXX_LCR, lcr_fcr);\r\nquot -= 1;\r\nserial_out(sport, PNX8XXX_BAUD, quot);\r\nserial_out(sport, PNX8XXX_ICLR, -1);\r\nserial_out(sport, PNX8XXX_IEN, old_ien);\r\nif (UART_ENABLE_MS(&sport->port, termios->c_cflag))\r\npnx8xxx_enable_ms(&sport->port);\r\nspin_unlock_irqrestore(&sport->port.lock, flags);\r\n}\r\nstatic const char *pnx8xxx_type(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nreturn sport->port.type == PORT_PNX8XXX ? "PNX8XXX" : NULL;\r\n}\r\nstatic void pnx8xxx_release_port(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nrelease_mem_region(sport->port.mapbase, UART_PORT_SIZE);\r\n}\r\nstatic int pnx8xxx_request_port(struct uart_port *port)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nreturn request_mem_region(sport->port.mapbase, UART_PORT_SIZE,\r\n"pnx8xxx-uart") != NULL ? 0 : -EBUSY;\r\n}\r\nstatic void pnx8xxx_config_port(struct uart_port *port, int flags)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nif (flags & UART_CONFIG_TYPE &&\r\npnx8xxx_request_port(&sport->port) == 0)\r\nsport->port.type = PORT_PNX8XXX;\r\n}\r\nstatic int\r\npnx8xxx_verify_port(struct uart_port *port, struct serial_struct *ser)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nint ret = 0;\r\nif (ser->type != PORT_UNKNOWN && ser->type != PORT_PNX8XXX)\r\nret = -EINVAL;\r\nif (sport->port.irq != ser->irq)\r\nret = -EINVAL;\r\nif (ser->io_type != SERIAL_IO_MEM)\r\nret = -EINVAL;\r\nif (sport->port.uartclk / 16 != ser->baud_base)\r\nret = -EINVAL;\r\nif ((void *)sport->port.mapbase != ser->iomem_base)\r\nret = -EINVAL;\r\nif (sport->port.iobase != ser->port)\r\nret = -EINVAL;\r\nif (ser->hub6 != 0)\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic void __init pnx8xxx_init_ports(void)\r\n{\r\nstatic int first = 1;\r\nint i;\r\nif (!first)\r\nreturn;\r\nfirst = 0;\r\nfor (i = 0; i < NR_PORTS; i++) {\r\ninit_timer(&pnx8xxx_ports[i].timer);\r\npnx8xxx_ports[i].timer.function = pnx8xxx_timeout;\r\npnx8xxx_ports[i].timer.data = (unsigned long)&pnx8xxx_ports[i];\r\npnx8xxx_ports[i].port.ops = &pnx8xxx_pops;\r\n}\r\n}\r\nstatic void pnx8xxx_console_putchar(struct uart_port *port, int ch)\r\n{\r\nstruct pnx8xxx_port *sport = (struct pnx8xxx_port *)port;\r\nint status;\r\ndo {\r\nstatus = serial_in(sport, PNX8XXX_FIFO);\r\n} while (status & PNX8XXX_UART_FIFO_TXFIFO);\r\nserial_out(sport, PNX8XXX_FIFO, ch);\r\n}\r\nstatic void\r\npnx8xxx_console_write(struct console *co, const char *s, unsigned int count)\r\n{\r\nstruct pnx8xxx_port *sport = &pnx8xxx_ports[co->index];\r\nunsigned int old_ien, status;\r\nold_ien = serial_in(sport, PNX8XXX_IEN);\r\nserial_out(sport, PNX8XXX_IEN, old_ien & ~(PNX8XXX_UART_INT_ALLTX |\r\nPNX8XXX_UART_INT_ALLRX));\r\nuart_console_write(&sport->port, s, count, pnx8xxx_console_putchar);\r\ndo {\r\nstatus = serial_in(sport, PNX8XXX_FIFO);\r\n} while (status & PNX8XXX_UART_FIFO_TXFIFO);\r\nserial_out(sport, PNX8XXX_ICLR, PNX8XXX_UART_INT_TX |\r\nPNX8XXX_UART_INT_EMPTY);\r\nserial_out(sport, PNX8XXX_IEN, old_ien);\r\n}\r\nstatic int __init\r\npnx8xxx_console_setup(struct console *co, char *options)\r\n{\r\nstruct pnx8xxx_port *sport;\r\nint baud = 38400;\r\nint bits = 8;\r\nint parity = 'n';\r\nint flow = 'n';\r\nif (co->index == -1 || co->index >= NR_PORTS)\r\nco->index = 0;\r\nsport = &pnx8xxx_ports[co->index];\r\nif (options)\r\nuart_parse_options(options, &baud, &parity, &bits, &flow);\r\nreturn uart_set_options(&sport->port, co, baud, parity, bits, flow);\r\n}\r\nstatic int __init pnx8xxx_rs_console_init(void)\r\n{\r\npnx8xxx_init_ports();\r\nregister_console(&pnx8xxx_console);\r\nreturn 0;\r\n}\r\nstatic int pnx8xxx_serial_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct pnx8xxx_port *sport = platform_get_drvdata(pdev);\r\nreturn uart_suspend_port(&pnx8xxx_reg, &sport->port);\r\n}\r\nstatic int pnx8xxx_serial_resume(struct platform_device *pdev)\r\n{\r\nstruct pnx8xxx_port *sport = platform_get_drvdata(pdev);\r\nreturn uart_resume_port(&pnx8xxx_reg, &sport->port);\r\n}\r\nstatic int pnx8xxx_serial_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res = pdev->resource;\r\nint i;\r\nfor (i = 0; i < pdev->num_resources; i++, res++) {\r\nif (!(res->flags & IORESOURCE_MEM))\r\ncontinue;\r\nfor (i = 0; i < NR_PORTS; i++) {\r\nif (pnx8xxx_ports[i].port.mapbase != res->start)\r\ncontinue;\r\npnx8xxx_ports[i].port.dev = &pdev->dev;\r\nuart_add_one_port(&pnx8xxx_reg, &pnx8xxx_ports[i].port);\r\nplatform_set_drvdata(pdev, &pnx8xxx_ports[i]);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int pnx8xxx_serial_remove(struct platform_device *pdev)\r\n{\r\nstruct pnx8xxx_port *sport = platform_get_drvdata(pdev);\r\nif (sport)\r\nuart_remove_one_port(&pnx8xxx_reg, &sport->port);\r\nreturn 0;\r\n}\r\nstatic int __init pnx8xxx_serial_init(void)\r\n{\r\nint ret;\r\nprintk(KERN_INFO "Serial: PNX8XXX driver\n");\r\npnx8xxx_init_ports();\r\nret = uart_register_driver(&pnx8xxx_reg);\r\nif (ret == 0) {\r\nret = platform_driver_register(&pnx8xxx_serial_driver);\r\nif (ret)\r\nuart_unregister_driver(&pnx8xxx_reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit pnx8xxx_serial_exit(void)\r\n{\r\nplatform_driver_unregister(&pnx8xxx_serial_driver);\r\nuart_unregister_driver(&pnx8xxx_reg);\r\n}

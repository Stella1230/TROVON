int nfc_llc_init(void)\r\n{\r\nint r;\r\nr = nfc_llc_nop_register();\r\nif (r)\r\ngoto exit;\r\nr = nfc_llc_shdlc_register();\r\nif (r)\r\ngoto exit;\r\nreturn 0;\r\nexit:\r\nnfc_llc_exit();\r\nreturn r;\r\n}\r\nvoid nfc_llc_exit(void)\r\n{\r\nstruct nfc_llc_engine *llc_engine, *n;\r\nlist_for_each_entry_safe(llc_engine, n, &llc_engines, entry) {\r\nlist_del(&llc_engine->entry);\r\nkfree(llc_engine->name);\r\nkfree(llc_engine);\r\n}\r\n}\r\nint nfc_llc_register(const char *name, struct nfc_llc_ops *ops)\r\n{\r\nstruct nfc_llc_engine *llc_engine;\r\nllc_engine = kzalloc(sizeof(struct nfc_llc_engine), GFP_KERNEL);\r\nif (llc_engine == NULL)\r\nreturn -ENOMEM;\r\nllc_engine->name = kstrdup(name, GFP_KERNEL);\r\nif (llc_engine->name == NULL) {\r\nkfree(llc_engine);\r\nreturn -ENOMEM;\r\n}\r\nllc_engine->ops = ops;\r\nINIT_LIST_HEAD(&llc_engine->entry);\r\nlist_add_tail(&llc_engine->entry, &llc_engines);\r\nreturn 0;\r\n}\r\nstatic struct nfc_llc_engine *nfc_llc_name_to_engine(const char *name)\r\n{\r\nstruct nfc_llc_engine *llc_engine;\r\nlist_for_each_entry(llc_engine, &llc_engines, entry) {\r\nif (strcmp(llc_engine->name, name) == 0)\r\nreturn llc_engine;\r\n}\r\nreturn NULL;\r\n}\r\nvoid nfc_llc_unregister(const char *name)\r\n{\r\nstruct nfc_llc_engine *llc_engine;\r\nllc_engine = nfc_llc_name_to_engine(name);\r\nif (llc_engine == NULL)\r\nreturn;\r\nlist_del(&llc_engine->entry);\r\nkfree(llc_engine->name);\r\nkfree(llc_engine);\r\n}\r\nstruct nfc_llc *nfc_llc_allocate(const char *name, struct nfc_hci_dev *hdev,\r\nxmit_to_drv_t xmit_to_drv,\r\nrcv_to_hci_t rcv_to_hci, int tx_headroom,\r\nint tx_tailroom, llc_failure_t llc_failure)\r\n{\r\nstruct nfc_llc_engine *llc_engine;\r\nstruct nfc_llc *llc;\r\nllc_engine = nfc_llc_name_to_engine(name);\r\nif (llc_engine == NULL)\r\nreturn NULL;\r\nllc = kzalloc(sizeof(struct nfc_llc), GFP_KERNEL);\r\nif (llc == NULL)\r\nreturn NULL;\r\nllc->data = llc_engine->ops->init(hdev, xmit_to_drv, rcv_to_hci,\r\ntx_headroom, tx_tailroom,\r\n&llc->rx_headroom, &llc->rx_tailroom,\r\nllc_failure);\r\nif (llc->data == NULL) {\r\nkfree(llc);\r\nreturn NULL;\r\n}\r\nllc->ops = llc_engine->ops;\r\nreturn llc;\r\n}\r\nvoid nfc_llc_free(struct nfc_llc *llc)\r\n{\r\nllc->ops->deinit(llc);\r\nkfree(llc);\r\n}\r\ninline void nfc_llc_get_rx_head_tail_room(struct nfc_llc *llc, int *rx_headroom,\r\nint *rx_tailroom)\r\n{\r\n*rx_headroom = llc->rx_headroom;\r\n*rx_tailroom = llc->rx_tailroom;\r\n}\r\ninline int nfc_llc_start(struct nfc_llc *llc)\r\n{\r\nreturn llc->ops->start(llc);\r\n}\r\ninline int nfc_llc_stop(struct nfc_llc *llc)\r\n{\r\nreturn llc->ops->stop(llc);\r\n}\r\ninline void nfc_llc_rcv_from_drv(struct nfc_llc *llc, struct sk_buff *skb)\r\n{\r\nllc->ops->rcv_from_drv(llc, skb);\r\n}\r\ninline int nfc_llc_xmit_from_hci(struct nfc_llc *llc, struct sk_buff *skb)\r\n{\r\nreturn llc->ops->xmit_from_hci(llc, skb);\r\n}\r\ninline void *nfc_llc_get_data(struct nfc_llc *llc)\r\n{\r\nreturn llc->data;\r\n}

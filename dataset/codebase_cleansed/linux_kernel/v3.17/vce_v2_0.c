static void vce_v2_0_set_sw_cg(struct radeon_device *rdev, bool gated)\r\n{\r\nu32 tmp;\r\nif (gated) {\r\ntmp = RREG32(VCE_CLOCK_GATING_B);\r\ntmp |= 0xe70000;\r\nWREG32(VCE_CLOCK_GATING_B, tmp);\r\ntmp = RREG32(VCE_UENC_CLOCK_GATING);\r\ntmp |= 0xff000000;\r\nWREG32(VCE_UENC_CLOCK_GATING, tmp);\r\ntmp = RREG32(VCE_UENC_REG_CLOCK_GATING);\r\ntmp &= ~0x3fc;\r\nWREG32(VCE_UENC_REG_CLOCK_GATING, tmp);\r\nWREG32(VCE_CGTT_CLK_OVERRIDE, 0);\r\n} else {\r\ntmp = RREG32(VCE_CLOCK_GATING_B);\r\ntmp |= 0xe7;\r\ntmp &= ~0xe70000;\r\nWREG32(VCE_CLOCK_GATING_B, tmp);\r\ntmp = RREG32(VCE_UENC_CLOCK_GATING);\r\ntmp |= 0x1fe000;\r\ntmp &= ~0xff000000;\r\nWREG32(VCE_UENC_CLOCK_GATING, tmp);\r\ntmp = RREG32(VCE_UENC_REG_CLOCK_GATING);\r\ntmp |= 0x3fc;\r\nWREG32(VCE_UENC_REG_CLOCK_GATING, tmp);\r\n}\r\n}\r\nstatic void vce_v2_0_set_dyn_cg(struct radeon_device *rdev, bool gated)\r\n{\r\nu32 orig, tmp;\r\ntmp = RREG32(VCE_CLOCK_GATING_B);\r\ntmp &= ~0x00060006;\r\nif (gated) {\r\ntmp |= 0xe10000;\r\n} else {\r\ntmp |= 0xe1;\r\ntmp &= ~0xe10000;\r\n}\r\nWREG32(VCE_CLOCK_GATING_B, tmp);\r\norig = tmp = RREG32(VCE_UENC_CLOCK_GATING);\r\ntmp &= ~0x1fe000;\r\ntmp &= ~0xff000000;\r\nif (tmp != orig)\r\nWREG32(VCE_UENC_CLOCK_GATING, tmp);\r\norig = tmp = RREG32(VCE_UENC_REG_CLOCK_GATING);\r\ntmp &= ~0x3fc;\r\nif (tmp != orig)\r\nWREG32(VCE_UENC_REG_CLOCK_GATING, tmp);\r\nif (gated)\r\nWREG32(VCE_CGTT_CLK_OVERRIDE, 0);\r\n}\r\nstatic void vce_v2_0_disable_cg(struct radeon_device *rdev)\r\n{\r\nWREG32(VCE_CGTT_CLK_OVERRIDE, 7);\r\n}\r\nvoid vce_v2_0_enable_mgcg(struct radeon_device *rdev, bool enable)\r\n{\r\nbool sw_cg = false;\r\nif (enable && (rdev->cg_flags & RADEON_CG_SUPPORT_VCE_MGCG)) {\r\nif (sw_cg)\r\nvce_v2_0_set_sw_cg(rdev, true);\r\nelse\r\nvce_v2_0_set_dyn_cg(rdev, true);\r\n} else {\r\nvce_v2_0_disable_cg(rdev);\r\nif (sw_cg)\r\nvce_v2_0_set_sw_cg(rdev, false);\r\nelse\r\nvce_v2_0_set_dyn_cg(rdev, false);\r\n}\r\n}\r\nstatic void vce_v2_0_init_cg(struct radeon_device *rdev)\r\n{\r\nu32 tmp;\r\ntmp = RREG32(VCE_CLOCK_GATING_A);\r\ntmp &= ~(CGC_CLK_GATE_DLY_TIMER_MASK | CGC_CLK_GATER_OFF_DLY_TIMER_MASK);\r\ntmp |= (CGC_CLK_GATE_DLY_TIMER(0) | CGC_CLK_GATER_OFF_DLY_TIMER(4));\r\ntmp |= CGC_UENC_WAIT_AWAKE;\r\nWREG32(VCE_CLOCK_GATING_A, tmp);\r\ntmp = RREG32(VCE_UENC_CLOCK_GATING);\r\ntmp &= ~(CLOCK_ON_DELAY_MASK | CLOCK_OFF_DELAY_MASK);\r\ntmp |= (CLOCK_ON_DELAY(0) | CLOCK_OFF_DELAY(4));\r\nWREG32(VCE_UENC_CLOCK_GATING, tmp);\r\ntmp = RREG32(VCE_CLOCK_GATING_B);\r\ntmp |= 0x10;\r\ntmp &= ~0x100000;\r\nWREG32(VCE_CLOCK_GATING_B, tmp);\r\n}\r\nint vce_v2_0_resume(struct radeon_device *rdev)\r\n{\r\nuint64_t addr = rdev->vce.gpu_addr;\r\nuint32_t size;\r\nWREG32_P(VCE_CLOCK_GATING_A, 0, ~(1 << 16));\r\nWREG32_P(VCE_UENC_CLOCK_GATING, 0x1FF000, ~0xFF9FF000);\r\nWREG32_P(VCE_UENC_REG_CLOCK_GATING, 0x3F, ~0x3F);\r\nWREG32(VCE_CLOCK_GATING_B, 0xf7);\r\nWREG32(VCE_LMI_CTRL, 0x00398000);\r\nWREG32_P(VCE_LMI_CACHE_CTRL, 0x0, ~0x1);\r\nWREG32(VCE_LMI_SWAP_CNTL, 0);\r\nWREG32(VCE_LMI_SWAP_CNTL1, 0);\r\nWREG32(VCE_LMI_VM_CTRL, 0);\r\nsize = RADEON_GPU_PAGE_ALIGN(rdev->vce_fw->size);\r\nWREG32(VCE_VCPU_CACHE_OFFSET0, addr & 0x7fffffff);\r\nWREG32(VCE_VCPU_CACHE_SIZE0, size);\r\naddr += size;\r\nsize = RADEON_VCE_STACK_SIZE;\r\nWREG32(VCE_VCPU_CACHE_OFFSET1, addr & 0x7fffffff);\r\nWREG32(VCE_VCPU_CACHE_SIZE1, size);\r\naddr += size;\r\nsize = RADEON_VCE_HEAP_SIZE;\r\nWREG32(VCE_VCPU_CACHE_OFFSET2, addr & 0x7fffffff);\r\nWREG32(VCE_VCPU_CACHE_SIZE2, size);\r\nWREG32_P(VCE_LMI_CTRL2, 0x0, ~0x100);\r\nWREG32_P(VCE_SYS_INT_EN, VCE_SYS_INT_TRAP_INTERRUPT_EN,\r\n~VCE_SYS_INT_TRAP_INTERRUPT_EN);\r\nvce_v2_0_init_cg(rdev);\r\nreturn 0;\r\n}

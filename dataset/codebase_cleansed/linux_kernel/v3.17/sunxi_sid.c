static u8 sunxi_sid_read_byte(const struct sunxi_sid_data *sid_data,\r\nconst unsigned int offset)\r\n{\r\nu32 sid_key;\r\nif (offset >= sid_data->keysize)\r\nreturn 0;\r\nsid_key = ioread32be(sid_data->reg_base + round_down(offset, 4));\r\nsid_key >>= (offset % 4) * 8;\r\nreturn sid_key;\r\n}\r\nstatic ssize_t sid_read(struct file *fd, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t pos, size_t size)\r\n{\r\nstruct platform_device *pdev;\r\nstruct sunxi_sid_data *sid_data;\r\nint i;\r\npdev = to_platform_device(kobj_to_dev(kobj));\r\nsid_data = platform_get_drvdata(pdev);\r\nif (pos < 0 || pos >= sid_data->keysize)\r\nreturn 0;\r\nif (size > sid_data->keysize - pos)\r\nsize = sid_data->keysize - pos;\r\nfor (i = 0; i < size; i++)\r\nbuf[i] = sunxi_sid_read_byte(sid_data, pos + i);\r\nreturn i;\r\n}\r\nstatic int sunxi_sid_remove(struct platform_device *pdev)\r\n{\r\ndevice_remove_bin_file(&pdev->dev, &sid_bin_attr);\r\ndev_dbg(&pdev->dev, "driver unloaded\n");\r\nreturn 0;\r\n}\r\nstatic int sunxi_sid_probe(struct platform_device *pdev)\r\n{\r\nstruct sunxi_sid_data *sid_data;\r\nstruct resource *res;\r\nconst struct of_device_id *of_dev_id;\r\nu8 *entropy;\r\nunsigned int i;\r\nsid_data = devm_kzalloc(&pdev->dev, sizeof(struct sunxi_sid_data),\r\nGFP_KERNEL);\r\nif (!sid_data)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nsid_data->reg_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(sid_data->reg_base))\r\nreturn PTR_ERR(sid_data->reg_base);\r\nof_dev_id = of_match_device(sunxi_sid_of_match, &pdev->dev);\r\nif (!of_dev_id)\r\nreturn -ENODEV;\r\nsid_data->keysize = (int)of_dev_id->data;\r\nplatform_set_drvdata(pdev, sid_data);\r\nsid_bin_attr.size = sid_data->keysize;\r\nif (device_create_bin_file(&pdev->dev, &sid_bin_attr))\r\nreturn -ENODEV;\r\nentropy = kzalloc(sizeof(u8) * sid_data->keysize, GFP_KERNEL);\r\nfor (i = 0; i < sid_data->keysize; i++)\r\nentropy[i] = sunxi_sid_read_byte(sid_data, i);\r\nadd_device_randomness(entropy, sid_data->keysize);\r\nkfree(entropy);\r\ndev_dbg(&pdev->dev, "loaded\n");\r\nreturn 0;\r\n}

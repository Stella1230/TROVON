static int bcm2835_rng_read(struct hwrng *rng, void *buf, size_t max,\r\nbool wait)\r\n{\r\nvoid __iomem *rng_base = (void __iomem *)rng->priv;\r\nwhile ((__raw_readl(rng_base + RNG_STATUS) >> 24) == 0) {\r\nif (!wait)\r\nreturn 0;\r\ncpu_relax();\r\n}\r\n*(u32 *)buf = __raw_readl(rng_base + RNG_DATA);\r\nreturn sizeof(u32);\r\n}\r\nstatic int bcm2835_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nvoid __iomem *rng_base;\r\nint err;\r\nrng_base = of_iomap(np, 0);\r\nif (!rng_base) {\r\ndev_err(dev, "failed to remap rng regs");\r\nreturn -ENODEV;\r\n}\r\nbcm2835_rng_ops.priv = (unsigned long)rng_base;\r\n__raw_writel(RNG_WARMUP_COUNT, rng_base + RNG_STATUS);\r\n__raw_writel(RNG_RBGEN, rng_base + RNG_CTRL);\r\nerr = hwrng_register(&bcm2835_rng_ops);\r\nif (err) {\r\ndev_err(dev, "hwrng registration failed\n");\r\niounmap(rng_base);\r\n} else\r\ndev_info(dev, "hwrng registered\n");\r\nreturn err;\r\n}\r\nstatic int bcm2835_rng_remove(struct platform_device *pdev)\r\n{\r\nvoid __iomem *rng_base = (void __iomem *)bcm2835_rng_ops.priv;\r\n__raw_writel(0, rng_base + RNG_CTRL);\r\nhwrng_unregister(&bcm2835_rng_ops);\r\niounmap(rng_base);\r\nreturn 0;\r\n}

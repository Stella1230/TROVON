inline void hci_h4p_outb(struct hci_h4p_info *info, unsigned int offset, u8 val)\r\n{\r\n__raw_writeb(val, info->uart_base + (offset << 2));\r\n}\r\ninline u8 hci_h4p_inb(struct hci_h4p_info *info, unsigned int offset)\r\n{\r\nreturn __raw_readb(info->uart_base + (offset << 2));\r\n}\r\nvoid hci_h4p_set_rts(struct hci_h4p_info *info, int active)\r\n{\r\nu8 b;\r\nb = hci_h4p_inb(info, UART_MCR);\r\nif (active)\r\nb |= UART_MCR_RTS;\r\nelse\r\nb &= ~UART_MCR_RTS;\r\nhci_h4p_outb(info, UART_MCR, b);\r\n}\r\nint hci_h4p_wait_for_cts(struct hci_h4p_info *info, int active,\r\nint timeout_ms)\r\n{\r\nunsigned long timeout;\r\nint state;\r\ntimeout = jiffies + msecs_to_jiffies(timeout_ms);\r\nfor (;;) {\r\nstate = hci_h4p_inb(info, UART_MSR) & UART_MSR_CTS;\r\nif (active) {\r\nif (state)\r\nreturn 0;\r\n} else {\r\nif (!state)\r\nreturn 0;\r\n}\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nmsleep(1);\r\n}\r\n}\r\nvoid __hci_h4p_set_auto_ctsrts(struct hci_h4p_info *info, int on, u8 which)\r\n{\r\nu8 lcr, b;\r\nlcr = hci_h4p_inb(info, UART_LCR);\r\nhci_h4p_outb(info, UART_LCR, 0xbf);\r\nb = hci_h4p_inb(info, UART_EFR);\r\nif (on)\r\nb |= which;\r\nelse\r\nb &= ~which;\r\nhci_h4p_outb(info, UART_EFR, b);\r\nhci_h4p_outb(info, UART_LCR, lcr);\r\n}\r\nvoid hci_h4p_set_auto_ctsrts(struct hci_h4p_info *info, int on, u8 which)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&info->lock, flags);\r\n__hci_h4p_set_auto_ctsrts(info, on, which);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\n}\r\nvoid hci_h4p_change_speed(struct hci_h4p_info *info, unsigned long speed)\r\n{\r\nunsigned int divisor;\r\nu8 lcr, mdr1;\r\nBT_DBG("Setting speed %lu", speed);\r\nif (speed >= 460800) {\r\ndivisor = UART_CLOCK / 13 / speed;\r\nmdr1 = 3;\r\n} else {\r\ndivisor = UART_CLOCK / 16 / speed;\r\nmdr1 = 0;\r\n}\r\nhci_h4p_outb(info, UART_OMAP_MDR1, 7);\r\nlcr = hci_h4p_inb(info, UART_LCR);\r\nhci_h4p_outb(info, UART_LCR, UART_LCR_DLAB);\r\nhci_h4p_outb(info, UART_DLL, divisor & 0xff);\r\nhci_h4p_outb(info, UART_DLM, divisor >> 8);\r\nhci_h4p_outb(info, UART_LCR, lcr);\r\nhci_h4p_outb(info, UART_OMAP_MDR1, mdr1);\r\n}\r\nint hci_h4p_reset_uart(struct hci_h4p_info *info)\r\n{\r\nint count = 0;\r\nhci_h4p_outb(info, UART_OMAP_SYSC, UART_SYSC_OMAP_RESET);\r\nwhile (!(hci_h4p_inb(info, UART_OMAP_SYSS) & UART_SYSS_RESETDONE)) {\r\nif (count++ > 100) {\r\ndev_err(info->dev, "hci_h4p: UART reset timeout\n");\r\nreturn -ENODEV;\r\n}\r\nudelay(1);\r\n}\r\nreturn 0;\r\n}\r\nvoid hci_h4p_store_regs(struct hci_h4p_info *info)\r\n{\r\nu16 lcr = 0;\r\nlcr = hci_h4p_inb(info, UART_LCR);\r\nhci_h4p_outb(info, UART_LCR, 0xBF);\r\ninfo->dll = hci_h4p_inb(info, UART_DLL);\r\ninfo->dlh = hci_h4p_inb(info, UART_DLM);\r\ninfo->efr = hci_h4p_inb(info, UART_EFR);\r\nhci_h4p_outb(info, UART_LCR, lcr);\r\ninfo->mdr1 = hci_h4p_inb(info, UART_OMAP_MDR1);\r\ninfo->ier = hci_h4p_inb(info, UART_IER);\r\n}\r\nvoid hci_h4p_restore_regs(struct hci_h4p_info *info)\r\n{\r\nu16 lcr = 0;\r\nhci_h4p_init_uart(info);\r\nhci_h4p_outb(info, UART_OMAP_MDR1, 7);\r\nlcr = hci_h4p_inb(info, UART_LCR);\r\nhci_h4p_outb(info, UART_LCR, 0xBF);\r\nhci_h4p_outb(info, UART_DLL, info->dll);\r\nhci_h4p_outb(info, UART_DLM, info->dlh);\r\nhci_h4p_outb(info, UART_EFR, info->efr);\r\nhci_h4p_outb(info, UART_LCR, lcr);\r\nhci_h4p_outb(info, UART_OMAP_MDR1, info->mdr1);\r\nhci_h4p_outb(info, UART_IER, info->ier);\r\n}\r\nvoid hci_h4p_init_uart(struct hci_h4p_info *info)\r\n{\r\nu8 mcr, efr;\r\nhci_h4p_outb(info, UART_OMAP_MDR1, 0x00);\r\nhci_h4p_outb(info, UART_LCR, 0xbf);\r\nefr = hci_h4p_inb(info, UART_EFR);\r\nhci_h4p_outb(info, UART_EFR, UART_EFR_ECB);\r\nhci_h4p_outb(info, UART_LCR, UART_LCR_DLAB);\r\nmcr = hci_h4p_inb(info, UART_MCR);\r\nhci_h4p_outb(info, UART_MCR, UART_MCR_TCRTLR);\r\nhci_h4p_outb(info, UART_FCR, UART_FCR_ENABLE_FIFO |\r\nUART_FCR_CLEAR_RCVR | UART_FCR_CLEAR_XMIT |\r\n(3 << 6) | (0 << 4));\r\nhci_h4p_outb(info, UART_LCR, 0xbf);\r\nhci_h4p_outb(info, UART_TI752_TLR, 0xed);\r\nhci_h4p_outb(info, UART_TI752_TCR, 0xef);\r\nhci_h4p_outb(info, UART_EFR, efr);\r\nhci_h4p_outb(info, UART_LCR, UART_LCR_DLAB);\r\nhci_h4p_outb(info, UART_MCR, 0x00);\r\nhci_h4p_outb(info, UART_LCR, UART_LCR_WLEN8);\r\nhci_h4p_outb(info, UART_IER, UART_IER_RDI);\r\nhci_h4p_outb(info, UART_OMAP_SYSC, (1 << 0) | (1 << 2) | (2 << 3));\r\n}

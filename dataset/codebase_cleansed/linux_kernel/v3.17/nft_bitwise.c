static void nft_bitwise_eval(const struct nft_expr *expr,\r\nstruct nft_data data[NFT_REG_MAX + 1],\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nconst struct nft_bitwise *priv = nft_expr_priv(expr);\r\nconst struct nft_data *src = &data[priv->sreg];\r\nstruct nft_data *dst = &data[priv->dreg];\r\nunsigned int i;\r\nfor (i = 0; i < DIV_ROUND_UP(priv->len, 4); i++) {\r\ndst->data[i] = (src->data[i] & priv->mask.data[i]) ^\r\npriv->xor.data[i];\r\n}\r\n}\r\nstatic int nft_bitwise_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_bitwise *priv = nft_expr_priv(expr);\r\nstruct nft_data_desc d1, d2;\r\nint err;\r\nif (tb[NFTA_BITWISE_SREG] == NULL ||\r\ntb[NFTA_BITWISE_DREG] == NULL ||\r\ntb[NFTA_BITWISE_LEN] == NULL ||\r\ntb[NFTA_BITWISE_MASK] == NULL ||\r\ntb[NFTA_BITWISE_XOR] == NULL)\r\nreturn -EINVAL;\r\npriv->sreg = ntohl(nla_get_be32(tb[NFTA_BITWISE_SREG]));\r\nerr = nft_validate_input_register(priv->sreg);\r\nif (err < 0)\r\nreturn err;\r\npriv->dreg = ntohl(nla_get_be32(tb[NFTA_BITWISE_DREG]));\r\nerr = nft_validate_output_register(priv->dreg);\r\nif (err < 0)\r\nreturn err;\r\nerr = nft_validate_data_load(ctx, priv->dreg, NULL, NFT_DATA_VALUE);\r\nif (err < 0)\r\nreturn err;\r\npriv->len = ntohl(nla_get_be32(tb[NFTA_BITWISE_LEN]));\r\nerr = nft_data_init(NULL, &priv->mask, &d1, tb[NFTA_BITWISE_MASK]);\r\nif (err < 0)\r\nreturn err;\r\nif (d1.len != priv->len)\r\nreturn -EINVAL;\r\nerr = nft_data_init(NULL, &priv->xor, &d2, tb[NFTA_BITWISE_XOR]);\r\nif (err < 0)\r\nreturn err;\r\nif (d2.len != priv->len)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int nft_bitwise_dump(struct sk_buff *skb, const struct nft_expr *expr)\r\n{\r\nconst struct nft_bitwise *priv = nft_expr_priv(expr);\r\nif (nla_put_be32(skb, NFTA_BITWISE_SREG, htonl(priv->sreg)))\r\ngoto nla_put_failure;\r\nif (nla_put_be32(skb, NFTA_BITWISE_DREG, htonl(priv->dreg)))\r\ngoto nla_put_failure;\r\nif (nla_put_be32(skb, NFTA_BITWISE_LEN, htonl(priv->len)))\r\ngoto nla_put_failure;\r\nif (nft_data_dump(skb, NFTA_BITWISE_MASK, &priv->mask,\r\nNFT_DATA_VALUE, priv->len) < 0)\r\ngoto nla_put_failure;\r\nif (nft_data_dump(skb, NFTA_BITWISE_XOR, &priv->xor,\r\nNFT_DATA_VALUE, priv->len) < 0)\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nint __init nft_bitwise_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_bitwise_type);\r\n}\r\nvoid nft_bitwise_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_bitwise_type);\r\n}

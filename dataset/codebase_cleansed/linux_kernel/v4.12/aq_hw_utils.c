void aq_hw_write_reg_bit(struct aq_hw_s *aq_hw, u32 addr, u32 msk,\r\nu32 shift, u32 val)\r\n{\r\nif (msk ^ ~0) {\r\nu32 reg_old, reg_new;\r\nreg_old = aq_hw_read_reg(aq_hw, addr);\r\nreg_new = (reg_old & (~msk)) | (val << shift);\r\nif (reg_old != reg_new)\r\naq_hw_write_reg(aq_hw, addr, reg_new);\r\n} else {\r\naq_hw_write_reg(aq_hw, addr, val);\r\n}\r\n}\r\nu32 aq_hw_read_reg_bit(struct aq_hw_s *aq_hw, u32 addr, u32 msk, u32 shift)\r\n{\r\nreturn ((aq_hw_read_reg(aq_hw, addr) & msk) >> shift);\r\n}\r\nu32 aq_hw_read_reg(struct aq_hw_s *hw, u32 reg)\r\n{\r\nu32 value = readl(hw->mmio + reg);\r\nif ((~0U) == value && (~0U) == readl(hw->mmio + hw->not_ff_addr))\r\naq_utils_obj_set(&hw->header.flags, AQ_HW_FLAG_ERR_UNPLUG);\r\nreturn value;\r\n}\r\nvoid aq_hw_write_reg(struct aq_hw_s *hw, u32 reg, u32 value)\r\n{\r\nwritel(value, hw->mmio + reg);\r\n}\r\nint aq_hw_err_from_flags(struct aq_hw_s *hw)\r\n{\r\nint err = 0;\r\nif (aq_utils_obj_test(&hw->header.flags, AQ_HW_FLAG_ERR_UNPLUG)) {\r\nerr = -ENXIO;\r\ngoto err_exit;\r\n}\r\nif (aq_utils_obj_test(&hw->header.flags, AQ_HW_FLAG_ERR_HW)) {\r\nerr = -EIO;\r\ngoto err_exit;\r\n}\r\nerr_exit:\r\nreturn err;\r\n}

struct ib_mr *ib_mr_pool_get(struct ib_qp *qp, struct list_head *list)\r\n{\r\nstruct ib_mr *mr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&qp->mr_lock, flags);\r\nmr = list_first_entry_or_null(list, struct ib_mr, qp_entry);\r\nif (mr) {\r\nlist_del(&mr->qp_entry);\r\nqp->mrs_used++;\r\n}\r\nspin_unlock_irqrestore(&qp->mr_lock, flags);\r\nreturn mr;\r\n}\r\nvoid ib_mr_pool_put(struct ib_qp *qp, struct list_head *list, struct ib_mr *mr)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&qp->mr_lock, flags);\r\nlist_add(&mr->qp_entry, list);\r\nqp->mrs_used--;\r\nspin_unlock_irqrestore(&qp->mr_lock, flags);\r\n}\r\nint ib_mr_pool_init(struct ib_qp *qp, struct list_head *list, int nr,\r\nenum ib_mr_type type, u32 max_num_sg)\r\n{\r\nstruct ib_mr *mr;\r\nunsigned long flags;\r\nint ret, i;\r\nfor (i = 0; i < nr; i++) {\r\nmr = ib_alloc_mr(qp->pd, type, max_num_sg);\r\nif (IS_ERR(mr)) {\r\nret = PTR_ERR(mr);\r\ngoto out;\r\n}\r\nspin_lock_irqsave(&qp->mr_lock, flags);\r\nlist_add_tail(&mr->qp_entry, list);\r\nspin_unlock_irqrestore(&qp->mr_lock, flags);\r\n}\r\nreturn 0;\r\nout:\r\nib_mr_pool_destroy(qp, list);\r\nreturn ret;\r\n}\r\nvoid ib_mr_pool_destroy(struct ib_qp *qp, struct list_head *list)\r\n{\r\nstruct ib_mr *mr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&qp->mr_lock, flags);\r\nwhile (!list_empty(list)) {\r\nmr = list_first_entry(list, struct ib_mr, qp_entry);\r\nlist_del(&mr->qp_entry);\r\nspin_unlock_irqrestore(&qp->mr_lock, flags);\r\nib_dereg_mr(mr);\r\nspin_lock_irqsave(&qp->mr_lock, flags);\r\n}\r\nspin_unlock_irqrestore(&qp->mr_lock, flags);\r\n}

static inline void do_page_mapin(unsigned long phys, unsigned long virt,\r\nunsigned long type)\r\n{\r\nunsigned long pte;\r\npte_t ptep;\r\nptep = pfn_pte(phys >> PAGE_SHIFT, PAGE_KERNEL);\r\npte = pte_val(ptep);\r\npte |= type;\r\nsun3_put_pte(virt, pte);\r\n#ifdef SUN3_KMAP_DEBUG\r\npr_info("mapin:");\r\nprint_pte_vaddr(virt);\r\n#endif\r\n}\r\nstatic inline void do_pmeg_mapin(unsigned long phys, unsigned long virt,\r\nunsigned long type, int pages)\r\n{\r\nif(sun3_get_segmap(virt & ~SUN3_PMEG_MASK) == SUN3_INVALID_PMEG)\r\nmmu_emu_map_pmeg(sun3_get_context(), virt);\r\nwhile(pages) {\r\ndo_page_mapin(phys, virt, type);\r\nphys += PAGE_SIZE;\r\nvirt += PAGE_SIZE;\r\npages--;\r\n}\r\n}\r\nvoid __iomem *sun3_ioremap(unsigned long phys, unsigned long size,\r\nunsigned long type)\r\n{\r\nstruct vm_struct *area;\r\nunsigned long offset, virt, ret;\r\nint pages;\r\nif(!size)\r\nreturn NULL;\r\noffset = phys & (PAGE_SIZE-1);\r\nphys &= ~(PAGE_SIZE-1);\r\nsize += offset;\r\nsize = PAGE_ALIGN(size);\r\nif((area = get_vm_area(size, VM_IOREMAP)) == NULL)\r\nreturn NULL;\r\n#ifdef SUN3_KMAP_DEBUG\r\npr_info("ioremap: got virt %p size %lx(%lx)\n", area->addr, size,\r\narea->size);\r\n#endif\r\npages = size / PAGE_SIZE;\r\nvirt = (unsigned long)area->addr;\r\nret = virt + offset;\r\nwhile(pages) {\r\nint seg_pages;\r\nseg_pages = (SUN3_PMEG_SIZE - (virt & SUN3_PMEG_MASK)) / PAGE_SIZE;\r\nif(seg_pages > pages)\r\nseg_pages = pages;\r\ndo_pmeg_mapin(phys, virt, type, seg_pages);\r\npages -= seg_pages;\r\nphys += seg_pages * PAGE_SIZE;\r\nvirt += seg_pages * PAGE_SIZE;\r\n}\r\nreturn (void __iomem *)ret;\r\n}\r\nvoid __iomem *__ioremap(unsigned long phys, unsigned long size, int cache)\r\n{\r\nreturn sun3_ioremap(phys, size, SUN3_PAGE_TYPE_IO);\r\n}\r\nvoid iounmap(void __iomem *addr)\r\n{\r\nvfree((void *)(PAGE_MASK & (unsigned long)addr));\r\n}\r\nint sun3_map_test(unsigned long addr, char *val)\r\n{\r\nint ret = 0;\r\n__asm__ __volatile__\r\n(".globl _sun3_map_test_start\n"\r\n"_sun3_map_test_start:\n"\r\n"1: moveb (%2), (%0)\n"\r\n" moveq #1, %1\n"\r\n"2:\n"\r\n".section .fixup,\"ax\"\n"\r\n".even\n"\r\n"3: moveq #0, %1\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n".align 4\n"\r\n".long 1b,3b\n"\r\n".previous\n"\r\n".globl _sun3_map_test_end\n"\r\n"_sun3_map_test_end:\n"\r\n: "=a"(val), "=r"(ret)\r\n: "a"(addr));\r\nreturn ret;\r\n}

static int img_ir_nec_scancode(int len, u64 raw, u64 enabled_protocols,\r\nstruct img_ir_scancode_req *request)\r\n{\r\nunsigned int addr, addr_inv, data, data_inv;\r\nif (!len)\r\nreturn IMG_IR_REPEATCODE;\r\nif (len != 32)\r\nreturn -EINVAL;\r\naddr = (raw >> 0) & 0xff;\r\naddr_inv = (raw >> 8) & 0xff;\r\ndata = (raw >> 16) & 0xff;\r\ndata_inv = (raw >> 24) & 0xff;\r\nif ((data_inv ^ data) != 0xff) {\r\nrequest->scancode = bitrev8(addr) << 24 |\r\nbitrev8(addr_inv) << 16 |\r\nbitrev8(data) << 8 |\r\nbitrev8(data_inv);\r\nrequest->protocol = RC_TYPE_NEC32;\r\n} else if ((addr_inv ^ addr) != 0xff) {\r\nrequest->scancode = addr << 16 |\r\naddr_inv << 8 |\r\ndata;\r\nrequest->protocol = RC_TYPE_NECX;\r\n} else {\r\nrequest->scancode = addr << 8 |\r\ndata;\r\nrequest->protocol = RC_TYPE_NEC;\r\n}\r\nreturn IMG_IR_SCANCODE;\r\n}\r\nstatic int img_ir_nec_filter(const struct rc_scancode_filter *in,\r\nstruct img_ir_filter *out, u64 protocols)\r\n{\r\nunsigned int addr, addr_inv, data, data_inv;\r\nunsigned int addr_m, addr_inv_m, data_m, data_inv_m;\r\ndata = in->data & 0xff;\r\ndata_m = in->mask & 0xff;\r\nprotocols &= RC_BIT_NEC | RC_BIT_NECX | RC_BIT_NEC32;\r\nif (!is_power_of_2(protocols)) {\r\nif ((in->data | in->mask) & 0xff000000)\r\nprotocols = RC_BIT_NEC32;\r\nelse if ((in->data | in->mask) & 0x00ff0000)\r\nprotocols = RC_BIT_NECX;\r\nelse\r\nprotocols = RC_BIT_NEC;\r\n}\r\nif (protocols == RC_BIT_NEC32) {\r\naddr = bitrev8(in->data >> 24);\r\naddr_m = bitrev8(in->mask >> 24);\r\naddr_inv = bitrev8(in->data >> 16);\r\naddr_inv_m = bitrev8(in->mask >> 16);\r\ndata = bitrev8(in->data >> 8);\r\ndata_m = bitrev8(in->mask >> 8);\r\ndata_inv = bitrev8(in->data >> 0);\r\ndata_inv_m = bitrev8(in->mask >> 0);\r\n} else if (protocols == RC_BIT_NECX) {\r\naddr = (in->data >> 16) & 0xff;\r\naddr_m = (in->mask >> 16) & 0xff;\r\naddr_inv = (in->data >> 8) & 0xff;\r\naddr_inv_m = (in->mask >> 8) & 0xff;\r\ndata_inv = data ^ 0xff;\r\ndata_inv_m = data_m;\r\n} else {\r\naddr = (in->data >> 8) & 0xff;\r\naddr_m = (in->mask >> 8) & 0xff;\r\naddr_inv = addr ^ 0xff;\r\naddr_inv_m = addr_m;\r\ndata_inv = data ^ 0xff;\r\ndata_inv_m = data_m;\r\n}\r\nout->data = data_inv << 24 |\r\ndata << 16 |\r\naddr_inv << 8 |\r\naddr;\r\nout->mask = data_inv_m << 24 |\r\ndata_m << 16 |\r\naddr_inv_m << 8 |\r\naddr_m;\r\nreturn 0;\r\n}

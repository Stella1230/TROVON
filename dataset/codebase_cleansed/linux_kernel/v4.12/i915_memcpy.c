static void __memcpy_ntdqa(void *dst, const void *src, unsigned long len)\r\n{\r\nkernel_fpu_begin();\r\nlen >>= 4;\r\nwhile (len >= 4) {\r\nasm("movntdqa (%0), %%xmm0\n"\r\n"movntdqa 16(%0), %%xmm1\n"\r\n"movntdqa 32(%0), %%xmm2\n"\r\n"movntdqa 48(%0), %%xmm3\n"\r\n"movaps %%xmm0, (%1)\n"\r\n"movaps %%xmm1, 16(%1)\n"\r\n"movaps %%xmm2, 32(%1)\n"\r\n"movaps %%xmm3, 48(%1)\n"\r\n:: "r" (src), "r" (dst) : "memory");\r\nsrc += 64;\r\ndst += 64;\r\nlen -= 4;\r\n}\r\nwhile (len--) {\r\nasm("movntdqa (%0), %%xmm0\n"\r\n"movaps %%xmm0, (%1)\n"\r\n:: "r" (src), "r" (dst) : "memory");\r\nsrc += 16;\r\ndst += 16;\r\n}\r\nkernel_fpu_end();\r\n}\r\nbool i915_memcpy_from_wc(void *dst, const void *src, unsigned long len)\r\n{\r\nif (unlikely(((unsigned long)dst | (unsigned long)src | len) & 15))\r\nreturn false;\r\n#ifdef CONFIG_AS_MOVNTDQA\r\nif (static_branch_likely(&has_movntdqa)) {\r\nif (likely(len))\r\n__memcpy_ntdqa(dst, src, len);\r\nreturn true;\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nvoid i915_memcpy_init_early(struct drm_i915_private *dev_priv)\r\n{\r\nif (static_cpu_has(X86_FEATURE_XMM4_1))\r\nstatic_branch_enable(&has_movntdqa);\r\n}

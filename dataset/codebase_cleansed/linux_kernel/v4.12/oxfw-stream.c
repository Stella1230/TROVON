static int set_rate(struct snd_oxfw *oxfw, unsigned int rate)\r\n{\r\nint err;\r\nerr = avc_general_set_sig_fmt(oxfw->unit, rate,\r\nAVC_GENERAL_PLUG_DIR_IN, 0);\r\nif (err < 0)\r\ngoto end;\r\nif (oxfw->has_output)\r\nerr = avc_general_set_sig_fmt(oxfw->unit, rate,\r\nAVC_GENERAL_PLUG_DIR_OUT, 0);\r\nend:\r\nreturn err;\r\n}\r\nstatic int set_stream_format(struct snd_oxfw *oxfw, struct amdtp_stream *s,\r\nunsigned int rate, unsigned int pcm_channels)\r\n{\r\nu8 **formats;\r\nstruct snd_oxfw_stream_formation formation;\r\nenum avc_general_plug_dir dir;\r\nunsigned int len;\r\nint i, err;\r\nif (s == &oxfw->tx_stream) {\r\nformats = oxfw->tx_stream_formats;\r\ndir = AVC_GENERAL_PLUG_DIR_OUT;\r\n} else {\r\nformats = oxfw->rx_stream_formats;\r\ndir = AVC_GENERAL_PLUG_DIR_IN;\r\n}\r\nfor (i = 0; i < SND_OXFW_STREAM_FORMAT_ENTRIES; i++) {\r\nerr = snd_oxfw_stream_parse_format(formats[i], &formation);\r\nif (err < 0)\r\nreturn err;\r\nif ((formation.rate == rate) && (formation.pcm == pcm_channels))\r\nbreak;\r\n}\r\nif (i == SND_OXFW_STREAM_FORMAT_ENTRIES)\r\nreturn -EINVAL;\r\nif (oxfw->assumed)\r\nreturn set_rate(oxfw, rate);\r\nlen = 5 + formats[i][4] * 2;\r\nerr = avc_stream_set_format(oxfw->unit, dir, 0, formats[i], len);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(100);\r\nreturn 0;\r\n}\r\nstatic void stop_stream(struct snd_oxfw *oxfw, struct amdtp_stream *stream)\r\n{\r\namdtp_stream_pcm_abort(stream);\r\namdtp_stream_stop(stream);\r\nif (stream == &oxfw->tx_stream)\r\ncmp_connection_break(&oxfw->out_conn);\r\nelse\r\ncmp_connection_break(&oxfw->in_conn);\r\n}\r\nstatic int start_stream(struct snd_oxfw *oxfw, struct amdtp_stream *stream,\r\nunsigned int rate, unsigned int pcm_channels)\r\n{\r\nu8 **formats;\r\nstruct cmp_connection *conn;\r\nstruct snd_oxfw_stream_formation formation;\r\nunsigned int i, midi_ports;\r\nint err;\r\nif (stream == &oxfw->rx_stream) {\r\nformats = oxfw->rx_stream_formats;\r\nconn = &oxfw->in_conn;\r\n} else {\r\nformats = oxfw->tx_stream_formats;\r\nconn = &oxfw->out_conn;\r\n}\r\nfor (i = 0; i < SND_OXFW_STREAM_FORMAT_ENTRIES; i++) {\r\nif (formats[i] == NULL)\r\nbreak;\r\nerr = snd_oxfw_stream_parse_format(formats[i], &formation);\r\nif (err < 0)\r\ngoto end;\r\nif (rate != formation.rate)\r\ncontinue;\r\nif (pcm_channels == 0 || pcm_channels == formation.pcm)\r\nbreak;\r\n}\r\nif (i == SND_OXFW_STREAM_FORMAT_ENTRIES) {\r\nerr = -EINVAL;\r\ngoto end;\r\n}\r\npcm_channels = formation.pcm;\r\nmidi_ports = formation.midi * 8;\r\nif (pcm_channels == 0) {\r\nerr = -EINVAL;\r\ngoto end;\r\n}\r\nerr = amdtp_am824_set_parameters(stream, rate, pcm_channels, midi_ports,\r\nfalse);\r\nif (err < 0)\r\ngoto end;\r\nerr = cmp_connection_establish(conn,\r\namdtp_stream_get_max_payload(stream));\r\nif (err < 0)\r\ngoto end;\r\nerr = amdtp_stream_start(stream,\r\nconn->resources.channel,\r\nconn->speed);\r\nif (err < 0) {\r\ncmp_connection_break(conn);\r\ngoto end;\r\n}\r\nif (!amdtp_stream_wait_callback(stream, CALLBACK_TIMEOUT)) {\r\nstop_stream(oxfw, stream);\r\nerr = -ETIMEDOUT;\r\n}\r\nend:\r\nreturn err;\r\n}\r\nstatic int check_connection_used_by_others(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream)\r\n{\r\nstruct cmp_connection *conn;\r\nbool used;\r\nint err;\r\nif (stream == &oxfw->tx_stream)\r\nconn = &oxfw->out_conn;\r\nelse\r\nconn = &oxfw->in_conn;\r\nerr = cmp_connection_check_used(conn, &used);\r\nif ((err >= 0) && used && !amdtp_stream_running(stream)) {\r\ndev_err(&oxfw->unit->device,\r\n"Connection established by others: %cPCR[%d]\n",\r\n(conn->direction == CMP_OUTPUT) ? 'o' : 'i',\r\nconn->pcr_index);\r\nerr = -EBUSY;\r\n}\r\nreturn err;\r\n}\r\nint snd_oxfw_stream_init_simplex(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream)\r\n{\r\nstruct cmp_connection *conn;\r\nenum cmp_direction c_dir;\r\nenum amdtp_stream_direction s_dir;\r\nint err;\r\nif (stream == &oxfw->tx_stream) {\r\nconn = &oxfw->out_conn;\r\nc_dir = CMP_OUTPUT;\r\ns_dir = AMDTP_IN_STREAM;\r\n} else {\r\nconn = &oxfw->in_conn;\r\nc_dir = CMP_INPUT;\r\ns_dir = AMDTP_OUT_STREAM;\r\n}\r\nerr = cmp_connection_init(conn, oxfw->unit, c_dir, 0);\r\nif (err < 0)\r\ngoto end;\r\nerr = amdtp_am824_init(stream, oxfw->unit, s_dir, CIP_NONBLOCKING);\r\nif (err < 0) {\r\namdtp_stream_destroy(stream);\r\ncmp_connection_destroy(conn);\r\ngoto end;\r\n}\r\nif (stream == &oxfw->tx_stream) {\r\noxfw->tx_stream.flags |= CIP_JUMBO_PAYLOAD;\r\nif (oxfw->wrong_dbs)\r\noxfw->tx_stream.flags |= CIP_WRONG_DBS;\r\n}\r\nend:\r\nreturn err;\r\n}\r\nint snd_oxfw_stream_start_simplex(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream,\r\nunsigned int rate, unsigned int pcm_channels)\r\n{\r\nstruct amdtp_stream *opposite;\r\nstruct snd_oxfw_stream_formation formation;\r\nenum avc_general_plug_dir dir;\r\nunsigned int substreams, opposite_substreams;\r\nint err = 0;\r\nif (stream == &oxfw->tx_stream) {\r\nsubstreams = oxfw->capture_substreams;\r\nopposite = &oxfw->rx_stream;\r\nopposite_substreams = oxfw->playback_substreams;\r\ndir = AVC_GENERAL_PLUG_DIR_OUT;\r\n} else {\r\nsubstreams = oxfw->playback_substreams;\r\nopposite_substreams = oxfw->capture_substreams;\r\nif (oxfw->has_output)\r\nopposite = &oxfw->rx_stream;\r\nelse\r\nopposite = NULL;\r\ndir = AVC_GENERAL_PLUG_DIR_IN;\r\n}\r\nif (substreams == 0)\r\ngoto end;\r\nerr = check_connection_used_by_others(oxfw, stream);\r\nif (err < 0)\r\ngoto end;\r\nif (amdtp_streaming_error(stream))\r\nstop_stream(oxfw, stream);\r\nerr = snd_oxfw_stream_get_current_formation(oxfw, dir, &formation);\r\nif (err < 0)\r\ngoto end;\r\nif (rate == 0)\r\nrate = formation.rate;\r\nif (pcm_channels == 0)\r\npcm_channels = formation.pcm;\r\nif ((formation.rate != rate) || (formation.pcm != pcm_channels)) {\r\nif (opposite != NULL) {\r\nerr = check_connection_used_by_others(oxfw, opposite);\r\nif (err < 0)\r\ngoto end;\r\nstop_stream(oxfw, opposite);\r\n}\r\nstop_stream(oxfw, stream);\r\nerr = set_stream_format(oxfw, stream, rate, pcm_channels);\r\nif (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to set stream format: %d\n", err);\r\ngoto end;\r\n}\r\nif (opposite && !amdtp_stream_running(opposite) &&\r\n(opposite_substreams > 0)) {\r\nerr = start_stream(oxfw, opposite, rate, 0);\r\nif (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to restart stream: %d\n", err);\r\ngoto end;\r\n}\r\n}\r\n}\r\nif (!amdtp_stream_running(stream)) {\r\nerr = start_stream(oxfw, stream, rate, pcm_channels);\r\nif (err < 0)\r\ndev_err(&oxfw->unit->device,\r\n"fail to start stream: %d\n", err);\r\n}\r\nend:\r\nreturn err;\r\n}\r\nvoid snd_oxfw_stream_stop_simplex(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream)\r\n{\r\nif (((stream == &oxfw->tx_stream) && (oxfw->capture_substreams > 0)) ||\r\n((stream == &oxfw->rx_stream) && (oxfw->playback_substreams > 0)))\r\nreturn;\r\nstop_stream(oxfw, stream);\r\n}\r\nvoid snd_oxfw_stream_destroy_simplex(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream)\r\n{\r\nstruct cmp_connection *conn;\r\nif (stream == &oxfw->tx_stream)\r\nconn = &oxfw->out_conn;\r\nelse\r\nconn = &oxfw->in_conn;\r\namdtp_stream_destroy(stream);\r\ncmp_connection_destroy(conn);\r\n}\r\nvoid snd_oxfw_stream_update_simplex(struct snd_oxfw *oxfw,\r\nstruct amdtp_stream *stream)\r\n{\r\nstruct cmp_connection *conn;\r\nif (stream == &oxfw->tx_stream)\r\nconn = &oxfw->out_conn;\r\nelse\r\nconn = &oxfw->in_conn;\r\nif (cmp_connection_update(conn) < 0)\r\nstop_stream(oxfw, stream);\r\nelse\r\namdtp_stream_update(stream);\r\n}\r\nint snd_oxfw_stream_get_current_formation(struct snd_oxfw *oxfw,\r\nenum avc_general_plug_dir dir,\r\nstruct snd_oxfw_stream_formation *formation)\r\n{\r\nu8 *format;\r\nunsigned int len;\r\nint err;\r\nlen = AVC_GENERIC_FRAME_MAXIMUM_BYTES;\r\nformat = kmalloc(len, GFP_KERNEL);\r\nif (format == NULL)\r\nreturn -ENOMEM;\r\nerr = avc_stream_get_format_single(oxfw->unit, dir, 0, format, &len);\r\nif (err < 0)\r\ngoto end;\r\nif (len < 3) {\r\nerr = -EIO;\r\ngoto end;\r\n}\r\nerr = snd_oxfw_stream_parse_format(format, formation);\r\nend:\r\nkfree(format);\r\nreturn err;\r\n}\r\nint snd_oxfw_stream_parse_format(u8 *format,\r\nstruct snd_oxfw_stream_formation *formation)\r\n{\r\nunsigned int i, e, channels, type;\r\nmemset(formation, 0, sizeof(struct snd_oxfw_stream_formation));\r\nif ((format[0] != 0x90) || (format[1] != 0x40))\r\nreturn -ENOSYS;\r\nfor (i = 0; i < ARRAY_SIZE(avc_stream_rate_table); i++) {\r\nif (format[2] == avc_stream_rate_table[i])\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(avc_stream_rate_table))\r\nreturn -ENOSYS;\r\nformation->rate = oxfw_rate_table[i];\r\nfor (e = 0; e < format[4]; e++) {\r\nchannels = format[5 + e * 2];\r\ntype = format[6 + e * 2];\r\nswitch (type) {\r\ncase 0x00:\r\ncase 0x06:\r\nformation->pcm += channels;\r\nbreak;\r\ncase 0x0d:\r\nformation->midi = channels;\r\nbreak;\r\ncase 0x01:\r\ncase 0x02:\r\ncase 0x03:\r\ncase 0x04:\r\ncase 0x05:\r\ncase 0x07:\r\ncase 0x0c:\r\ncase 0x08:\r\ncase 0x09:\r\ncase 0x0a:\r\ncase 0x0b:\r\ncase 0x0e:\r\ncase 0x0f:\r\ncase 0x10:\r\ncase 0x40:\r\ncase 0xff:\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\n}\r\nif (formation->pcm > AM824_MAX_CHANNELS_FOR_PCM ||\r\nformation->midi > AM824_MAX_CHANNELS_FOR_MIDI)\r\nreturn -ENOSYS;\r\nreturn 0;\r\n}\r\nstatic int\r\nassume_stream_formats(struct snd_oxfw *oxfw, enum avc_general_plug_dir dir,\r\nunsigned int pid, u8 *buf, unsigned int *len,\r\nu8 **formats)\r\n{\r\nstruct snd_oxfw_stream_formation formation;\r\nunsigned int i, eid;\r\nint err;\r\nerr = avc_stream_get_format_single(oxfw->unit, dir, pid, buf, len);\r\nif (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to get current stream format for isoc %s plug %d:%d\n",\r\n(dir == AVC_GENERAL_PLUG_DIR_IN) ? "in" : "out",\r\npid, err);\r\ngoto end;\r\n}\r\neid = 0;\r\nerr = snd_oxfw_stream_parse_format(buf, &formation);\r\nif (err < 0)\r\ngoto end;\r\nformats[eid] = kmemdup(buf, *len, GFP_KERNEL);\r\nif (formats[eid] == NULL) {\r\nerr = -ENOMEM;\r\ngoto end;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(oxfw_rate_table); i++) {\r\nif (formation.rate == oxfw_rate_table[i])\r\ncontinue;\r\nerr = avc_general_inquiry_sig_fmt(oxfw->unit,\r\noxfw_rate_table[i],\r\ndir, pid);\r\nif (err < 0)\r\ncontinue;\r\neid++;\r\nformats[eid] = kmemdup(buf, *len, GFP_KERNEL);\r\nif (formats[eid] == NULL) {\r\nerr = -ENOMEM;\r\ngoto end;\r\n}\r\nformats[eid][2] = avc_stream_rate_table[i];\r\n}\r\nerr = 0;\r\noxfw->assumed = true;\r\nend:\r\nreturn err;\r\n}\r\nstatic int fill_stream_formats(struct snd_oxfw *oxfw,\r\nenum avc_general_plug_dir dir,\r\nunsigned short pid)\r\n{\r\nu8 *buf, **formats;\r\nunsigned int len, eid = 0;\r\nstruct snd_oxfw_stream_formation dummy;\r\nint err;\r\nbuf = kmalloc(AVC_GENERIC_FRAME_MAXIMUM_BYTES, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nif (dir == AVC_GENERAL_PLUG_DIR_OUT)\r\nformats = oxfw->tx_stream_formats;\r\nelse\r\nformats = oxfw->rx_stream_formats;\r\nlen = AVC_GENERIC_FRAME_MAXIMUM_BYTES;\r\nerr = avc_stream_get_format_list(oxfw->unit, dir, 0, buf, &len, 0);\r\nif (err == -ENOSYS) {\r\nlen = AVC_GENERIC_FRAME_MAXIMUM_BYTES;\r\nerr = assume_stream_formats(oxfw, dir, pid, buf, &len,\r\nformats);\r\ngoto end;\r\n} else if (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to get stream format %d for isoc %s plug %d:%d\n",\r\neid, (dir == AVC_GENERAL_PLUG_DIR_IN) ? "in" : "out",\r\npid, err);\r\ngoto end;\r\n}\r\nwhile (eid < SND_OXFW_STREAM_FORMAT_ENTRIES) {\r\nif (len < 3) {\r\nerr = -EIO;\r\nbreak;\r\n}\r\nerr = snd_oxfw_stream_parse_format(buf, &dummy);\r\nif (err < 0)\r\nbreak;\r\nformats[eid] = kmemdup(buf, len, GFP_KERNEL);\r\nif (formats[eid] == NULL) {\r\nerr = -ENOMEM;\r\nbreak;\r\n}\r\nlen = AVC_GENERIC_FRAME_MAXIMUM_BYTES;\r\nerr = avc_stream_get_format_list(oxfw->unit, dir, 0,\r\nbuf, &len, ++eid);\r\nif (err == -EINVAL) {\r\nerr = 0;\r\nbreak;\r\n} else if (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to get stream format %d for isoc %s plug %d:%d\n",\r\neid, (dir == AVC_GENERAL_PLUG_DIR_IN) ? "in" :\r\n"out",\r\npid, err);\r\nbreak;\r\n}\r\n}\r\nend:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nint snd_oxfw_stream_discover(struct snd_oxfw *oxfw)\r\n{\r\nu8 plugs[AVC_PLUG_INFO_BUF_BYTES];\r\nstruct snd_oxfw_stream_formation formation;\r\nu8 *format;\r\nunsigned int i;\r\nint err;\r\nerr = avc_general_get_plug_info(oxfw->unit, 0x1f, 0x07, 0x00, plugs);\r\nif (err < 0) {\r\ndev_err(&oxfw->unit->device,\r\n"fail to get info for isoc/external in/out plugs: %d\n",\r\nerr);\r\ngoto end;\r\n} else if ((plugs[0] == 0) && (plugs[1] == 0)) {\r\nerr = -ENOSYS;\r\ngoto end;\r\n}\r\nif (plugs[1] > 0) {\r\nerr = fill_stream_formats(oxfw, AVC_GENERAL_PLUG_DIR_OUT, 0);\r\nif (err < 0)\r\ngoto end;\r\nfor (i = 0; i < SND_OXFW_STREAM_FORMAT_ENTRIES; i++) {\r\nformat = oxfw->tx_stream_formats[i];\r\nif (format == NULL)\r\ncontinue;\r\nerr = snd_oxfw_stream_parse_format(format, &formation);\r\nif (err < 0)\r\ncontinue;\r\nif (formation.midi > 0)\r\noxfw->midi_input_ports = 1;\r\n}\r\noxfw->has_output = true;\r\n}\r\nif (plugs[0] > 0) {\r\nerr = fill_stream_formats(oxfw, AVC_GENERAL_PLUG_DIR_IN, 0);\r\nif (err < 0)\r\ngoto end;\r\nfor (i = 0; i < SND_OXFW_STREAM_FORMAT_ENTRIES; i++) {\r\nformat = oxfw->rx_stream_formats[i];\r\nif (format == NULL)\r\ncontinue;\r\nerr = snd_oxfw_stream_parse_format(format, &formation);\r\nif (err < 0)\r\ncontinue;\r\nif (formation.midi > 0)\r\noxfw->midi_output_ports = 1;\r\n}\r\n}\r\nend:\r\nreturn err;\r\n}\r\nvoid snd_oxfw_stream_lock_changed(struct snd_oxfw *oxfw)\r\n{\r\noxfw->dev_lock_changed = true;\r\nwake_up(&oxfw->hwdep_wait);\r\n}\r\nint snd_oxfw_stream_lock_try(struct snd_oxfw *oxfw)\r\n{\r\nint err;\r\nspin_lock_irq(&oxfw->lock);\r\nif (oxfw->dev_lock_count < 0) {\r\nerr = -EBUSY;\r\ngoto end;\r\n}\r\nif (oxfw->dev_lock_count++ == 0)\r\nsnd_oxfw_stream_lock_changed(oxfw);\r\nerr = 0;\r\nend:\r\nspin_unlock_irq(&oxfw->lock);\r\nreturn err;\r\n}\r\nvoid snd_oxfw_stream_lock_release(struct snd_oxfw *oxfw)\r\n{\r\nspin_lock_irq(&oxfw->lock);\r\nif (WARN_ON(oxfw->dev_lock_count <= 0))\r\ngoto end;\r\nif (--oxfw->dev_lock_count == 0)\r\nsnd_oxfw_stream_lock_changed(oxfw);\r\nend:\r\nspin_unlock_irq(&oxfw->lock);\r\n}

static inline struct nic78bx_led *to_nic78bx_led(struct led_classdev *cdev)\r\n{\r\nreturn container_of(cdev, struct nic78bx_led, cdev);\r\n}\r\nstatic void nic78bx_brightness_set(struct led_classdev *cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct nic78bx_led *nled = to_nic78bx_led(cdev);\r\nunsigned long flags;\r\nu8 value;\r\nspin_lock_irqsave(&nled->data->lock, flags);\r\nvalue = inb(nled->data->io_base);\r\nif (brightness) {\r\nvalue &= ~nled->mask;\r\nvalue |= nled->bit;\r\n} else {\r\nvalue &= ~nled->bit;\r\n}\r\noutb(value, nled->data->io_base);\r\nspin_unlock_irqrestore(&nled->data->lock, flags);\r\n}\r\nstatic enum led_brightness nic78bx_brightness_get(struct led_classdev *cdev)\r\n{\r\nstruct nic78bx_led *nled = to_nic78bx_led(cdev);\r\nunsigned long flags;\r\nu8 value;\r\nspin_lock_irqsave(&nled->data->lock, flags);\r\nvalue = inb(nled->data->io_base);\r\nspin_unlock_irqrestore(&nled->data->lock, flags);\r\nreturn (value & nled->bit) ? 1 : LED_OFF;\r\n}\r\nstatic int nic78bx_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct nic78bx_led_data *led_data;\r\nstruct resource *io_rc;\r\nint ret, i;\r\nled_data = devm_kzalloc(dev, sizeof(*led_data), GFP_KERNEL);\r\nif (!led_data)\r\nreturn -ENOMEM;\r\nled_data->pdev = pdev;\r\nplatform_set_drvdata(pdev, led_data);\r\nio_rc = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!io_rc) {\r\ndev_err(dev, "missing IO resources\n");\r\nreturn -EINVAL;\r\n}\r\nif (resource_size(io_rc) < NIC78BX_USER_LED_IO_SIZE) {\r\ndev_err(dev, "IO region too small\n");\r\nreturn -EINVAL;\r\n}\r\nif (!devm_request_region(dev, io_rc->start, resource_size(io_rc),\r\nKBUILD_MODNAME)) {\r\ndev_err(dev, "failed to get IO region\n");\r\nreturn -EBUSY;\r\n}\r\nled_data->io_base = io_rc->start;\r\nspin_lock_init(&led_data->lock);\r\nfor (i = 0; i < ARRAY_SIZE(nic78bx_leds); i++) {\r\nnic78bx_leds[i].data = led_data;\r\nret = devm_led_classdev_register(dev, &nic78bx_leds[i].cdev);\r\nif (ret)\r\nreturn ret;\r\n}\r\noutb(NIC78BX_UNLOCK_VALUE,\r\nled_data->io_base + NIC78BX_LOCK_REG_OFFSET);\r\nreturn ret;\r\n}\r\nstatic int nic78bx_remove(struct platform_device *pdev)\r\n{\r\nstruct nic78bx_led_data *led_data = platform_get_drvdata(pdev);\r\noutb(NIC78BX_LOCK_VALUE,\r\nled_data->io_base + NIC78BX_LOCK_REG_OFFSET);\r\nreturn 0;\r\n}

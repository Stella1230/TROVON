const char *scsi_device_type(unsigned type)\r\n{\r\nif (type == 0x1e)\r\nreturn "Well-known LUN ";\r\nif (type == 0x1f)\r\nreturn "No Device ";\r\nif (type >= ARRAY_SIZE(scsi_device_types))\r\nreturn "Unknown ";\r\nreturn scsi_device_types[type];\r\n}\r\nu64 scsilun_to_int(struct scsi_lun *scsilun)\r\n{\r\nint i;\r\nu64 lun;\r\nlun = 0;\r\nfor (i = 0; i < sizeof(lun); i += 2)\r\nlun = lun | (((u64)scsilun->scsi_lun[i] << ((i + 1) * 8)) |\r\n((u64)scsilun->scsi_lun[i + 1] << (i * 8)));\r\nreturn lun;\r\n}\r\nvoid int_to_scsilun(u64 lun, struct scsi_lun *scsilun)\r\n{\r\nint i;\r\nmemset(scsilun->scsi_lun, 0, sizeof(scsilun->scsi_lun));\r\nfor (i = 0; i < sizeof(lun); i += 2) {\r\nscsilun->scsi_lun[i] = (lun >> 8) & 0xFF;\r\nscsilun->scsi_lun[i+1] = lun & 0xFF;\r\nlun = lun >> 16;\r\n}\r\n}\r\nbool scsi_normalize_sense(const u8 *sense_buffer, int sb_len,\r\nstruct scsi_sense_hdr *sshdr)\r\n{\r\nmemset(sshdr, 0, sizeof(struct scsi_sense_hdr));\r\nif (!sense_buffer || !sb_len)\r\nreturn false;\r\nsshdr->response_code = (sense_buffer[0] & 0x7f);\r\nif (!scsi_sense_valid(sshdr))\r\nreturn false;\r\nif (sshdr->response_code >= 0x72) {\r\nif (sb_len > 1)\r\nsshdr->sense_key = (sense_buffer[1] & 0xf);\r\nif (sb_len > 2)\r\nsshdr->asc = sense_buffer[2];\r\nif (sb_len > 3)\r\nsshdr->ascq = sense_buffer[3];\r\nif (sb_len > 7)\r\nsshdr->additional_length = sense_buffer[7];\r\n} else {\r\nif (sb_len > 2)\r\nsshdr->sense_key = (sense_buffer[2] & 0xf);\r\nif (sb_len > 7) {\r\nsb_len = (sb_len < (sense_buffer[7] + 8)) ?\r\nsb_len : (sense_buffer[7] + 8);\r\nif (sb_len > 12)\r\nsshdr->asc = sense_buffer[12];\r\nif (sb_len > 13)\r\nsshdr->ascq = sense_buffer[13];\r\n}\r\n}\r\nreturn true;\r\n}\r\nconst u8 * scsi_sense_desc_find(const u8 * sense_buffer, int sb_len,\r\nint desc_type)\r\n{\r\nint add_sen_len, add_len, desc_len, k;\r\nconst u8 * descp;\r\nif ((sb_len < 8) || (0 == (add_sen_len = sense_buffer[7])))\r\nreturn NULL;\r\nif ((sense_buffer[0] < 0x72) || (sense_buffer[0] > 0x73))\r\nreturn NULL;\r\nadd_sen_len = (add_sen_len < (sb_len - 8)) ?\r\nadd_sen_len : (sb_len - 8);\r\ndescp = &sense_buffer[8];\r\nfor (desc_len = 0, k = 0; k < add_sen_len; k += desc_len) {\r\ndescp += desc_len;\r\nadd_len = (k < (add_sen_len - 1)) ? descp[1]: -1;\r\ndesc_len = add_len + 2;\r\nif (descp[0] == desc_type)\r\nreturn descp;\r\nif (add_len < 0)\r\nbreak;\r\n}\r\nreturn NULL;\r\n}\r\nvoid scsi_build_sense_buffer(int desc, u8 *buf, u8 key, u8 asc, u8 ascq)\r\n{\r\nif (desc) {\r\nbuf[0] = 0x72;\r\nbuf[1] = key;\r\nbuf[2] = asc;\r\nbuf[3] = ascq;\r\nbuf[7] = 0;\r\n} else {\r\nbuf[0] = 0x70;\r\nbuf[2] = key;\r\nbuf[7] = 0xa;\r\nbuf[12] = asc;\r\nbuf[13] = ascq;\r\n}\r\n}\r\nint scsi_set_sense_information(u8 *buf, int buf_len, u64 info)\r\n{\r\nif ((buf[0] & 0x7f) == 0x72) {\r\nu8 *ucp, len;\r\nlen = buf[7];\r\nucp = (char *)scsi_sense_desc_find(buf, len + 8, 0);\r\nif (!ucp) {\r\nbuf[7] = len + 0xc;\r\nucp = buf + 8 + len;\r\n}\r\nif (buf_len < len + 0xc)\r\nreturn -EINVAL;\r\nucp[0] = 0;\r\nucp[1] = 0xa;\r\nucp[2] = 0x80;\r\nucp[3] = 0;\r\nput_unaligned_be64(info, &ucp[4]);\r\n} else if ((buf[0] & 0x7f) == 0x70) {\r\nif (info <= 0xffffffffUL)\r\nbuf[0] |= 0x80;\r\nelse\r\nbuf[0] &= 0x7f;\r\nput_unaligned_be32((u32)info, &buf[3]);\r\n}\r\nreturn 0;\r\n}\r\nint scsi_set_sense_field_pointer(u8 *buf, int buf_len, u16 fp, u8 bp, bool cd)\r\n{\r\nu8 *ucp, len;\r\nif ((buf[0] & 0x7f) == 0x72) {\r\nlen = buf[7];\r\nucp = (char *)scsi_sense_desc_find(buf, len + 8, 2);\r\nif (!ucp) {\r\nbuf[7] = len + 8;\r\nucp = buf + 8 + len;\r\n}\r\nif (buf_len < len + 8)\r\nreturn -EINVAL;\r\nucp[0] = 2;\r\nucp[1] = 6;\r\nucp[4] = 0x80;\r\nif (cd)\r\nucp[4] |= 0x40;\r\nif (bp < 0x8)\r\nucp[4] |= 0x8 | bp;\r\nput_unaligned_be16(fp, &ucp[5]);\r\n} else if ((buf[0] & 0x7f) == 0x70) {\r\nlen = buf[7];\r\nif (len < 18)\r\nbuf[7] = 18;\r\nbuf[15] = 0x80;\r\nif (cd)\r\nbuf[15] |= 0x40;\r\nif (bp < 0x8)\r\nbuf[15] |= 0x8 | bp;\r\nput_unaligned_be16(fp, &buf[16]);\r\n}\r\nreturn 0;\r\n}

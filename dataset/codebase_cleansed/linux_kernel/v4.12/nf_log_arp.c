static void dump_arp_packet(struct nf_log_buf *m,\r\nconst struct nf_loginfo *info,\r\nconst struct sk_buff *skb, unsigned int nhoff)\r\n{\r\nconst struct arphdr *ah;\r\nstruct arphdr _arph;\r\nconst struct arppayload *ap;\r\nstruct arppayload _arpp;\r\nah = skb_header_pointer(skb, 0, sizeof(_arph), &_arph);\r\nif (ah == NULL) {\r\nnf_log_buf_add(m, "TRUNCATED");\r\nreturn;\r\n}\r\nnf_log_buf_add(m, "ARP HTYPE=%d PTYPE=0x%04x OPCODE=%d",\r\nntohs(ah->ar_hrd), ntohs(ah->ar_pro), ntohs(ah->ar_op));\r\nif (ah->ar_hrd != htons(ARPHRD_ETHER) ||\r\nah->ar_hln != ETH_ALEN ||\r\nah->ar_pln != sizeof(__be32))\r\nreturn;\r\nap = skb_header_pointer(skb, sizeof(_arph), sizeof(_arpp), &_arpp);\r\nif (ap == NULL) {\r\nnf_log_buf_add(m, " INCOMPLETE [%zu bytes]",\r\nskb->len - sizeof(_arph));\r\nreturn;\r\n}\r\nnf_log_buf_add(m, " MACSRC=%pM IPSRC=%pI4 MACDST=%pM IPDST=%pI4",\r\nap->mac_src, ap->ip_src, ap->mac_dst, ap->ip_dst);\r\n}\r\nstatic void nf_log_arp_packet(struct net *net, u_int8_t pf,\r\nunsigned int hooknum, const struct sk_buff *skb,\r\nconst struct net_device *in,\r\nconst struct net_device *out,\r\nconst struct nf_loginfo *loginfo,\r\nconst char *prefix)\r\n{\r\nstruct nf_log_buf *m;\r\nif (!net_eq(net, &init_net) && !sysctl_nf_log_all_netns)\r\nreturn;\r\nm = nf_log_buf_open();\r\nif (!loginfo)\r\nloginfo = &default_loginfo;\r\nnf_log_dump_packet_common(m, pf, hooknum, skb, in, out, loginfo,\r\nprefix);\r\ndump_arp_packet(m, loginfo, skb, 0);\r\nnf_log_buf_close(m);\r\n}\r\nstatic int __net_init nf_log_arp_net_init(struct net *net)\r\n{\r\nreturn nf_log_set(net, NFPROTO_ARP, &nf_arp_logger);\r\n}\r\nstatic void __net_exit nf_log_arp_net_exit(struct net *net)\r\n{\r\nnf_log_unset(net, &nf_arp_logger);\r\n}\r\nstatic int __init nf_log_arp_init(void)\r\n{\r\nint ret;\r\nret = register_pernet_subsys(&nf_log_arp_net_ops);\r\nif (ret < 0)\r\nreturn ret;\r\nret = nf_log_register(NFPROTO_ARP, &nf_arp_logger);\r\nif (ret < 0) {\r\npr_err("failed to register logger\n");\r\ngoto err1;\r\n}\r\nreturn 0;\r\nerr1:\r\nunregister_pernet_subsys(&nf_log_arp_net_ops);\r\nreturn ret;\r\n}\r\nstatic void __exit nf_log_arp_exit(void)\r\n{\r\nunregister_pernet_subsys(&nf_log_arp_net_ops);\r\nnf_log_unregister(&nf_arp_logger);\r\n}

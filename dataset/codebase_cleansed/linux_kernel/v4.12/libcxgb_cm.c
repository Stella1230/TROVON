void\r\ncxgb_get_4tuple(struct cpl_pass_accept_req *req, enum chip_type type,\r\nint *iptype, __u8 *local_ip, __u8 *peer_ip,\r\n__be16 *local_port, __be16 *peer_port)\r\n{\r\nint eth_len = (CHELSIO_CHIP_VERSION(type) <= CHELSIO_T5) ?\r\nETH_HDR_LEN_G(be32_to_cpu(req->hdr_len)) :\r\nT6_ETH_HDR_LEN_G(be32_to_cpu(req->hdr_len));\r\nint ip_len = (CHELSIO_CHIP_VERSION(type) <= CHELSIO_T5) ?\r\nIP_HDR_LEN_G(be32_to_cpu(req->hdr_len)) :\r\nT6_IP_HDR_LEN_G(be32_to_cpu(req->hdr_len));\r\nstruct iphdr *ip = (struct iphdr *)((u8 *)(req + 1) + eth_len);\r\nstruct ipv6hdr *ip6 = (struct ipv6hdr *)((u8 *)(req + 1) + eth_len);\r\nstruct tcphdr *tcp = (struct tcphdr *)\r\n((u8 *)(req + 1) + eth_len + ip_len);\r\nif (ip->version == 4) {\r\npr_debug("%s saddr 0x%x daddr 0x%x sport %u dport %u\n",\r\n__func__, ntohl(ip->saddr), ntohl(ip->daddr),\r\nntohs(tcp->source), ntohs(tcp->dest));\r\n*iptype = 4;\r\nmemcpy(peer_ip, &ip->saddr, 4);\r\nmemcpy(local_ip, &ip->daddr, 4);\r\n} else {\r\npr_debug("%s saddr %pI6 daddr %pI6 sport %u dport %u\n",\r\n__func__, ip6->saddr.s6_addr, ip6->daddr.s6_addr,\r\nntohs(tcp->source), ntohs(tcp->dest));\r\n*iptype = 6;\r\nmemcpy(peer_ip, ip6->saddr.s6_addr, 16);\r\nmemcpy(local_ip, ip6->daddr.s6_addr, 16);\r\n}\r\n*peer_port = tcp->source;\r\n*local_port = tcp->dest;\r\n}

static int read_efi_var(const char *name, unsigned long *size,\r\nvoid **return_data)\r\n{\r\nefi_status_t status;\r\nefi_char16_t *uni_name;\r\nefi_guid_t guid;\r\nunsigned long temp_size;\r\nvoid *temp_buffer;\r\nvoid *data;\r\nint i;\r\nint ret;\r\n*size = 0;\r\n*return_data = NULL;\r\nif (!efi_enabled(EFI_RUNTIME_SERVICES))\r\nreturn -EOPNOTSUPP;\r\nuni_name = kcalloc(strlen(name) + 1, sizeof(efi_char16_t), GFP_KERNEL);\r\ntemp_buffer = kzalloc(EFI_DATA_SIZE, GFP_KERNEL);\r\nif (!uni_name || !temp_buffer) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\ntemp_size = EFI_DATA_SIZE;\r\nfor (i = 0; name[i]; i++)\r\nuni_name[i] = name[i];\r\nguid = HFI1_EFIVAR_GUID;\r\nstatus = efi.get_variable(\r\nuni_name,\r\n&guid,\r\nNULL,\r\n&temp_size,\r\ntemp_buffer);\r\nret = status == EFI_SUCCESS ? 0 :\r\nstatus == EFI_NOT_FOUND ? -ENOENT :\r\n-EINVAL;\r\nif (ret)\r\ngoto fail;\r\ndata = kmemdup(temp_buffer, temp_size, GFP_KERNEL);\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\n*size = temp_size;\r\n*return_data = data;\r\nfail:\r\nkfree(uni_name);\r\nkfree(temp_buffer);\r\nreturn ret;\r\n}\r\nint read_hfi1_efi_var(struct hfi1_devdata *dd, const char *kind,\r\nunsigned long *size, void **return_data)\r\n{\r\nchar prefix_name[64];\r\nchar name[64];\r\nint result;\r\nint i;\r\nsnprintf(prefix_name, sizeof(prefix_name), "%04x:%02x:%02x.%x",\r\npci_domain_nr(dd->pcidev->bus),\r\ndd->pcidev->bus->number,\r\nPCI_SLOT(dd->pcidev->devfn),\r\nPCI_FUNC(dd->pcidev->devfn));\r\nsnprintf(name, sizeof(name), "%s-%s", prefix_name, kind);\r\nresult = read_efi_var(name, size, return_data);\r\nif (result) {\r\nfor (i = 0; prefix_name[i]; i++)\r\nif (isalpha(prefix_name[i]))\r\nprefix_name[i] = toupper(prefix_name[i]);\r\nsnprintf(name, sizeof(name), "%s-%s", prefix_name, kind);\r\nresult = read_efi_var(name, size, return_data);\r\n}\r\nreturn result;\r\n}

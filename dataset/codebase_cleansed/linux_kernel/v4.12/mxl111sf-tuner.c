static int mxl111sf_tuner_read_reg(struct mxl111sf_tuner_state *state,\r\nu8 addr, u8 *data)\r\n{\r\nreturn (state->cfg->read_reg) ?\r\nstate->cfg->read_reg(state->mxl_state, addr, data) :\r\n-EINVAL;\r\n}\r\nstatic int mxl111sf_tuner_write_reg(struct mxl111sf_tuner_state *state,\r\nu8 addr, u8 data)\r\n{\r\nreturn (state->cfg->write_reg) ?\r\nstate->cfg->write_reg(state->mxl_state, addr, data) :\r\n-EINVAL;\r\n}\r\nstatic int mxl111sf_tuner_program_regs(struct mxl111sf_tuner_state *state,\r\nstruct mxl111sf_reg_ctrl_info *ctrl_reg_info)\r\n{\r\nreturn (state->cfg->program_regs) ?\r\nstate->cfg->program_regs(state->mxl_state, ctrl_reg_info) :\r\n-EINVAL;\r\n}\r\nstatic int mxl1x1sf_tuner_top_master_ctrl(struct mxl111sf_tuner_state *state,\r\nint onoff)\r\n{\r\nreturn (state->cfg->top_master_ctrl) ?\r\nstate->cfg->top_master_ctrl(state->mxl_state, onoff) :\r\n-EINVAL;\r\n}\r\nstatic struct mxl111sf_reg_ctrl_info *mxl111sf_calc_phy_tune_regs(u32 freq,\r\nu8 bw)\r\n{\r\nu8 filt_bw;\r\nswitch (bw) {\r\ncase 0:\r\nfilt_bw = 25;\r\nbreak;\r\ncase 1:\r\nfilt_bw = 69;\r\nbreak;\r\ncase 6:\r\nfilt_bw = 21;\r\nbreak;\r\ncase 7:\r\nfilt_bw = 42;\r\nbreak;\r\ncase 8:\r\nfilt_bw = 63;\r\nbreak;\r\ndefault:\r\npr_err("%s: invalid bandwidth setting!", __func__);\r\nreturn NULL;\r\n}\r\nfreq /= 1000000;\r\nfreq *= 64;\r\n#if 0\r\nfreq += 0.5;\r\n#endif\r\nmxl_phy_tune_rf[0].data = filt_bw;\r\nmxl_phy_tune_rf[1].data = (freq & 0xff);\r\nmxl_phy_tune_rf[2].data = (freq >> 8) & 0xff;\r\nreturn mxl_phy_tune_rf;\r\n}\r\nstatic int mxl1x1sf_tuner_set_if_output_freq(struct mxl111sf_tuner_state *state)\r\n{\r\nint ret;\r\nu8 ctrl;\r\n#if 0\r\nu16 iffcw;\r\nu32 if_freq;\r\n#endif\r\nmxl_dbg("(IF polarity = %d, IF freq = 0x%02x)",\r\nstate->cfg->invert_spectrum, state->cfg->if_freq);\r\nctrl = state->cfg->invert_spectrum;\r\nctrl |= state->cfg->if_freq;\r\nret = mxl111sf_tuner_write_reg(state, V6_TUNER_IF_SEL_REG, ctrl);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n#if 0\r\nif_freq /= 1000000;\r\nif_freq += 0.5;\r\nif (MXL_IF_LO == state->cfg->if_freq) {\r\nctrl = 0x08;\r\niffcw = (u16)(if_freq / (108 * 4096));\r\n} else if (MXL_IF_HI == state->cfg->if_freq) {\r\nctrl = 0x08;\r\niffcw = (u16)(if_freq / (216 * 4096));\r\n} else {\r\nctrl = 0;\r\niffcw = 0;\r\n}\r\nctrl |= (iffcw >> 8);\r\n#endif\r\nret = mxl111sf_tuner_read_reg(state, V6_TUNER_IF_FCW_BYP_REG, &ctrl);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nctrl &= 0xf0;\r\nctrl |= 0x90;\r\nret = mxl111sf_tuner_write_reg(state, V6_TUNER_IF_FCW_BYP_REG, ctrl);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n#if 0\r\nctrl = iffcw & 0x00ff;\r\n#endif\r\nret = mxl111sf_tuner_write_reg(state, V6_TUNER_IF_FCW_REG, ctrl);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nstate->if_freq = state->cfg->if_freq;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl1x1sf_tune_rf(struct dvb_frontend *fe, u32 freq, u8 bw)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\nstatic struct mxl111sf_reg_ctrl_info *reg_ctrl_array;\r\nint ret;\r\nu8 mxl_mode;\r\nmxl_dbg("(freq = %d, bw = 0x%x)", freq, bw);\r\nret = mxl111sf_tuner_write_reg(state, START_TUNE_REG, 0);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_tuner_read_reg(state, MXL_MODE_REG, &mxl_mode);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nreg_ctrl_array = mxl111sf_calc_phy_tune_regs(freq, bw);\r\nif (!reg_ctrl_array)\r\nreturn -EINVAL;\r\nret = mxl111sf_tuner_program_regs(state, reg_ctrl_array);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nif ((mxl_mode & MXL_DEV_MODE_MASK) == MXL_TUNER_MODE) {\r\nmxl1x1sf_tuner_top_master_ctrl(state, 0);\r\nmxl1x1sf_tuner_top_master_ctrl(state, 1);\r\nmxl1x1sf_tuner_set_if_output_freq(state);\r\n}\r\nret = mxl111sf_tuner_write_reg(state, START_TUNE_REG, 1);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nif (state->cfg->ant_hunt)\r\nstate->cfg->ant_hunt(fe);\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl1x1sf_tuner_get_lock_status(struct mxl111sf_tuner_state *state,\r\nint *rf_synth_lock,\r\nint *ref_synth_lock)\r\n{\r\nint ret;\r\nu8 data;\r\n*rf_synth_lock = 0;\r\n*ref_synth_lock = 0;\r\nret = mxl111sf_tuner_read_reg(state, V6_RF_LOCK_STATUS_REG, &data);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n*ref_synth_lock = ((data & 0x03) == 0x03) ? 1 : 0;\r\n*rf_synth_lock = ((data & 0x0c) == 0x0c) ? 1 : 0;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_tuner_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nu32 delsys = c->delivery_system;\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\nint ret;\r\nu8 bw;\r\nmxl_dbg("()");\r\nswitch (delsys) {\r\ncase SYS_ATSC:\r\ncase SYS_ATSCMH:\r\nbw = 0;\r\nbreak;\r\ncase SYS_DVBC_ANNEX_B:\r\nbw = 1;\r\nbreak;\r\ncase SYS_DVBT:\r\nswitch (c->bandwidth_hz) {\r\ncase 6000000:\r\nbw = 6;\r\nbreak;\r\ncase 7000000:\r\nbw = 7;\r\nbreak;\r\ncase 8000000:\r\nbw = 8;\r\nbreak;\r\ndefault:\r\npr_err("%s: bandwidth not set!", __func__);\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\npr_err("%s: modulation type not supported!", __func__);\r\nreturn -EINVAL;\r\n}\r\nret = mxl1x1sf_tune_rf(fe, c->frequency, bw);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nstate->frequency = c->frequency;\r\nstate->bandwidth = c->bandwidth_hz;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_tuner_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\nint rf_locked, ref_locked, ret;\r\n*status = 0;\r\nret = mxl1x1sf_tuner_get_lock_status(state, &rf_locked, &ref_locked);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nmxl_info("%s%s", rf_locked ? "rf locked " : "",\r\nref_locked ? "ref locked" : "");\r\nif ((rf_locked) || (ref_locked))\r\n*status |= TUNER_STATUS_LOCKED;\r\nfail:\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_get_rf_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\nu8 val1, val2;\r\nint ret;\r\n*strength = 0;\r\nret = mxl111sf_tuner_write_reg(state, 0x00, 0x02);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_tuner_read_reg(state, V6_DIG_RF_PWR_LSB_REG, &val1);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\nret = mxl111sf_tuner_read_reg(state, V6_DIG_RF_PWR_MSB_REG, &val2);\r\nif (mxl_fail(ret))\r\ngoto fail;\r\n*strength = val1 | ((val2 & 0x07) << 8);\r\nfail:\r\nret = mxl111sf_tuner_write_reg(state, 0x00, 0x00);\r\nmxl_fail(ret);\r\nreturn ret;\r\n}\r\nstatic int mxl111sf_tuner_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\n*frequency = state->frequency;\r\nreturn 0;\r\n}\r\nstatic int mxl111sf_tuner_get_bandwidth(struct dvb_frontend *fe, u32 *bandwidth)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\n*bandwidth = state->bandwidth;\r\nreturn 0;\r\n}\r\nstatic int mxl111sf_tuner_get_if_frequency(struct dvb_frontend *fe,\r\nu32 *frequency)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\n*frequency = 0;\r\nswitch (state->if_freq) {\r\ncase MXL_IF_4_0:\r\n*frequency = 4000000;\r\nbreak;\r\ncase MXL_IF_4_5:\r\n*frequency = 4500000;\r\nbreak;\r\ncase MXL_IF_4_57:\r\n*frequency = 4570000;\r\nbreak;\r\ncase MXL_IF_5_0:\r\n*frequency = 5000000;\r\nbreak;\r\ncase MXL_IF_5_38:\r\n*frequency = 5380000;\r\nbreak;\r\ncase MXL_IF_6_0:\r\n*frequency = 6000000;\r\nbreak;\r\ncase MXL_IF_6_28:\r\n*frequency = 6280000;\r\nbreak;\r\ncase MXL_IF_7_2:\r\n*frequency = 7200000;\r\nbreak;\r\ncase MXL_IF_35_25:\r\n*frequency = 35250000;\r\nbreak;\r\ncase MXL_IF_36:\r\n*frequency = 36000000;\r\nbreak;\r\ncase MXL_IF_36_15:\r\n*frequency = 36150000;\r\nbreak;\r\ncase MXL_IF_44:\r\n*frequency = 44000000;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mxl111sf_tuner_release(struct dvb_frontend *fe)\r\n{\r\nstruct mxl111sf_tuner_state *state = fe->tuner_priv;\r\nmxl_dbg("()");\r\nkfree(state);\r\nfe->tuner_priv = NULL;\r\n}\r\nstruct dvb_frontend *mxl111sf_tuner_attach(struct dvb_frontend *fe,\r\nstruct mxl111sf_state *mxl_state,\r\nconst struct mxl111sf_tuner_config *cfg)\r\n{\r\nstruct mxl111sf_tuner_state *state = NULL;\r\nmxl_dbg("()");\r\nstate = kzalloc(sizeof(struct mxl111sf_tuner_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn NULL;\r\nstate->mxl_state = mxl_state;\r\nstate->cfg = cfg;\r\nmemcpy(&fe->ops.tuner_ops, &mxl111sf_tuner_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = state;\r\nreturn fe;\r\n}

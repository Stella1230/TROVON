static void __init ath79_usb_register(const char *name, int id,\r\nunsigned long base, unsigned long size,\r\nint irq, const void *data,\r\nsize_t data_size)\r\n{\r\nstruct resource res[2];\r\nstruct platform_device *pdev;\r\nmemset(res, 0, sizeof(res));\r\nres[0].flags = IORESOURCE_MEM;\r\nres[0].start = base;\r\nres[0].end = base + size - 1;\r\nres[1].flags = IORESOURCE_IRQ;\r\nres[1].start = irq;\r\nres[1].end = irq;\r\npdev = platform_device_register_resndata(NULL, name, id,\r\nres, ARRAY_SIZE(res),\r\ndata, data_size);\r\nif (IS_ERR(pdev)) {\r\npr_err("ath79: unable to register USB at %08lx, err=%d\n",\r\nbase, (int) PTR_ERR(pdev));\r\nreturn;\r\n}\r\npdev->dev.dma_mask = &ath79_usb_dmamask;\r\npdev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\n}\r\nstatic void __init ath79_usb_setup(void)\r\n{\r\nvoid __iomem *usb_ctrl_base;\r\nath79_device_reset_set(AR71XX_USB_RESET_MASK);\r\nmdelay(1000);\r\nath79_device_reset_clear(AR71XX_USB_RESET_MASK);\r\nusb_ctrl_base = ioremap(AR71XX_USB_CTRL_BASE, AR71XX_USB_CTRL_SIZE);\r\n__raw_writel(0xf0000, usb_ctrl_base + AR71XX_USB_CTRL_REG_CONFIG);\r\n__raw_writel(0x20c00, usb_ctrl_base + AR71XX_USB_CTRL_REG_FLADJ);\r\niounmap(usb_ctrl_base);\r\nmdelay(900);\r\nath79_usb_register("ohci-platform", -1,\r\nAR71XX_OHCI_BASE, AR71XX_OHCI_SIZE,\r\nATH79_MISC_IRQ(6),\r\n&ath79_ohci_pdata, sizeof(ath79_ohci_pdata));\r\nath79_usb_register("ehci-platform", -1,\r\nAR71XX_EHCI_BASE, AR71XX_EHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ehci_pdata_v1, sizeof(ath79_ehci_pdata_v1));\r\n}\r\nstatic void __init ar7240_usb_setup(void)\r\n{\r\nvoid __iomem *usb_ctrl_base;\r\nath79_device_reset_clear(AR7240_RESET_OHCI_DLL);\r\nath79_device_reset_set(AR7240_RESET_USB_HOST);\r\nmdelay(1000);\r\nath79_device_reset_set(AR7240_RESET_OHCI_DLL);\r\nath79_device_reset_clear(AR7240_RESET_USB_HOST);\r\nusb_ctrl_base = ioremap(AR7240_USB_CTRL_BASE, AR7240_USB_CTRL_SIZE);\r\n__raw_writel(0x3, usb_ctrl_base + AR71XX_USB_CTRL_REG_FLADJ);\r\niounmap(usb_ctrl_base);\r\nath79_usb_register("ohci-platform", -1,\r\nAR7240_OHCI_BASE, AR7240_OHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ohci_pdata, sizeof(ath79_ohci_pdata));\r\n}\r\nstatic void __init ar724x_usb_setup(void)\r\n{\r\nath79_device_reset_set(AR724X_RESET_USBSUS_OVERRIDE);\r\nmdelay(10);\r\nath79_device_reset_clear(AR724X_RESET_USB_HOST);\r\nmdelay(10);\r\nath79_device_reset_clear(AR724X_RESET_USB_PHY);\r\nmdelay(10);\r\nath79_usb_register("ehci-platform", -1,\r\nAR724X_EHCI_BASE, AR724X_EHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\n}\r\nstatic void __init ar913x_usb_setup(void)\r\n{\r\nath79_device_reset_set(AR913X_RESET_USBSUS_OVERRIDE);\r\nmdelay(10);\r\nath79_device_reset_clear(AR913X_RESET_USB_HOST);\r\nmdelay(10);\r\nath79_device_reset_clear(AR913X_RESET_USB_PHY);\r\nmdelay(10);\r\nath79_usb_register("ehci-platform", -1,\r\nAR913X_EHCI_BASE, AR913X_EHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\n}\r\nstatic void __init ar933x_usb_setup(void)\r\n{\r\nath79_device_reset_set(AR933X_RESET_USBSUS_OVERRIDE);\r\nmdelay(10);\r\nath79_device_reset_clear(AR933X_RESET_USB_HOST);\r\nmdelay(10);\r\nath79_device_reset_clear(AR933X_RESET_USB_PHY);\r\nmdelay(10);\r\nath79_usb_register("ehci-platform", -1,\r\nAR933X_EHCI_BASE, AR933X_EHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\n}\r\nstatic void __init ar934x_usb_setup(void)\r\n{\r\nu32 bootstrap;\r\nbootstrap = ath79_reset_rr(AR934X_RESET_REG_BOOTSTRAP);\r\nif (bootstrap & AR934X_BOOTSTRAP_USB_MODE_DEVICE)\r\nreturn;\r\nath79_device_reset_set(AR934X_RESET_USBSUS_OVERRIDE);\r\nudelay(1000);\r\nath79_device_reset_clear(AR934X_RESET_USB_PHY);\r\nudelay(1000);\r\nath79_device_reset_clear(AR934X_RESET_USB_PHY_ANALOG);\r\nudelay(1000);\r\nath79_device_reset_clear(AR934X_RESET_USB_HOST);\r\nudelay(1000);\r\nath79_usb_register("ehci-platform", -1,\r\nAR934X_EHCI_BASE, AR934X_EHCI_SIZE,\r\nATH79_CPU_IRQ(3),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\n}\r\nstatic void __init qca955x_usb_setup(void)\r\n{\r\nath79_usb_register("ehci-platform", 0,\r\nQCA955X_EHCI0_BASE, QCA955X_EHCI_SIZE,\r\nATH79_IP3_IRQ(0),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\nath79_usb_register("ehci-platform", 1,\r\nQCA955X_EHCI1_BASE, QCA955X_EHCI_SIZE,\r\nATH79_IP3_IRQ(1),\r\n&ath79_ehci_pdata_v2, sizeof(ath79_ehci_pdata_v2));\r\n}\r\nvoid __init ath79_register_usb(void)\r\n{\r\nif (soc_is_ar71xx())\r\nath79_usb_setup();\r\nelse if (soc_is_ar7240())\r\nar7240_usb_setup();\r\nelse if (soc_is_ar7241() || soc_is_ar7242())\r\nar724x_usb_setup();\r\nelse if (soc_is_ar913x())\r\nar913x_usb_setup();\r\nelse if (soc_is_ar933x())\r\nar933x_usb_setup();\r\nelse if (soc_is_ar934x())\r\nar934x_usb_setup();\r\nelse if (soc_is_qca955x())\r\nqca955x_usb_setup();\r\nelse\r\nBUG();\r\n}

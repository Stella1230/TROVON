struct pci_controller *init_phb_dynamic(struct device_node *dn)\r\n{\r\nstruct pci_controller *phb;\r\npr_debug("PCI: Initializing new hotplug PHB %s\n", dn->full_name);\r\nphb = pcibios_alloc_controller(dn);\r\nif (!phb)\r\nreturn NULL;\r\nrtas_setup_phb(phb);\r\npci_process_bridge_OF_ranges(phb, dn, 0);\r\nphb->controller_ops = pseries_pci_controller_ops;\r\npci_devs_phb_init_dynamic(phb);\r\neeh_dev_phb_init_dynamic(phb);\r\nif (dn->child)\r\neeh_add_device_tree_early(PCI_DN(dn));\r\npcibios_scan_phb(phb);\r\npcibios_finish_adding_to_bus(phb->bus);\r\nreturn phb;\r\n}\r\nint remove_phb_dynamic(struct pci_controller *phb)\r\n{\r\nstruct pci_bus *b = phb->bus;\r\nstruct resource *res;\r\nint rc, i;\r\npr_debug("PCI: Removing PHB %04x:%02x...\n",\r\npci_domain_nr(b), b->number);\r\nif (!(list_empty(&b->children) && list_empty(&b->devices)))\r\nreturn -EBUSY;\r\nres = &phb->io_resource;\r\nif (res->flags & IORESOURCE_IO) {\r\nrc = pcibios_unmap_io_space(b);\r\nif (rc) {\r\nprintk(KERN_ERR "%s: failed to unmap IO on bus %s\n",\r\n__func__, b->name);\r\nreturn 1;\r\n}\r\n}\r\nphb->bus = NULL;\r\npci_remove_bus(b);\r\ndevice_unregister(b->bridge);\r\nif (res->flags & IORESOURCE_IO)\r\nrelease_resource(res);\r\nfor (i = 0; i < 3; ++i) {\r\nres = &phb->mem_resources[i];\r\nif (!(res->flags & IORESOURCE_MEM))\r\ncontinue;\r\nrelease_resource(res);\r\n}\r\nreturn 0;\r\n}

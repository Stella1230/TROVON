int dca_sysfs_add_req(struct dca_provider *dca, struct device *dev, int slot)\r\n{\r\nstruct device *cd;\r\nstatic int req_count;\r\ncd = device_create(dca_class, dca->cd, MKDEV(0, slot + 1), NULL,\r\n"requester%d", req_count++);\r\nif (IS_ERR(cd))\r\nreturn PTR_ERR(cd);\r\nreturn 0;\r\n}\r\nvoid dca_sysfs_remove_req(struct dca_provider *dca, int slot)\r\n{\r\ndevice_destroy(dca_class, MKDEV(0, slot + 1));\r\n}\r\nint dca_sysfs_add_provider(struct dca_provider *dca, struct device *dev)\r\n{\r\nstruct device *cd;\r\nint ret;\r\nidr_preload(GFP_KERNEL);\r\nspin_lock(&dca_idr_lock);\r\nret = idr_alloc(&dca_idr, dca, 0, 0, GFP_NOWAIT);\r\nif (ret >= 0)\r\ndca->id = ret;\r\nspin_unlock(&dca_idr_lock);\r\nidr_preload_end();\r\nif (ret < 0)\r\nreturn ret;\r\ncd = device_create(dca_class, dev, MKDEV(0, 0), NULL, "dca%d", dca->id);\r\nif (IS_ERR(cd)) {\r\nspin_lock(&dca_idr_lock);\r\nidr_remove(&dca_idr, dca->id);\r\nspin_unlock(&dca_idr_lock);\r\nreturn PTR_ERR(cd);\r\n}\r\ndca->cd = cd;\r\nreturn 0;\r\n}\r\nvoid dca_sysfs_remove_provider(struct dca_provider *dca)\r\n{\r\ndevice_unregister(dca->cd);\r\ndca->cd = NULL;\r\nspin_lock(&dca_idr_lock);\r\nidr_remove(&dca_idr, dca->id);\r\nspin_unlock(&dca_idr_lock);\r\n}\r\nint __init dca_sysfs_init(void)\r\n{\r\nidr_init(&dca_idr);\r\nspin_lock_init(&dca_idr_lock);\r\ndca_class = class_create(THIS_MODULE, "dca");\r\nif (IS_ERR(dca_class)) {\r\nidr_destroy(&dca_idr);\r\nreturn PTR_ERR(dca_class);\r\n}\r\nreturn 0;\r\n}\r\nvoid __exit dca_sysfs_exit(void)\r\n{\r\nclass_destroy(dca_class);\r\nidr_destroy(&dca_idr);\r\n}

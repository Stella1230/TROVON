static int nf_ct_ipv4_gather_frags(struct net *net, struct sk_buff *skb,\r\nu_int32_t user)\r\n{\r\nint err;\r\nlocal_bh_disable();\r\nerr = ip_defrag(net, skb, user);\r\nlocal_bh_enable();\r\nif (!err)\r\nskb->ignore_df = 1;\r\nreturn err;\r\n}\r\nstatic enum ip_defrag_users nf_ct_defrag_user(unsigned int hooknum,\r\nstruct sk_buff *skb)\r\n{\r\nu16 zone_id = NF_CT_DEFAULT_ZONE_ID;\r\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\r\nif (skb_nfct(skb)) {\r\nenum ip_conntrack_info ctinfo;\r\nconst struct nf_conn *ct = nf_ct_get(skb, &ctinfo);\r\nzone_id = nf_ct_zone_id(nf_ct_zone(ct), CTINFO2DIR(ctinfo));\r\n}\r\n#endif\r\nif (nf_bridge_in_prerouting(skb))\r\nreturn IP_DEFRAG_CONNTRACK_BRIDGE_IN + zone_id;\r\nif (hooknum == NF_INET_PRE_ROUTING)\r\nreturn IP_DEFRAG_CONNTRACK_IN + zone_id;\r\nelse\r\nreturn IP_DEFRAG_CONNTRACK_OUT + zone_id;\r\n}\r\nstatic unsigned int ipv4_conntrack_defrag(void *priv,\r\nstruct sk_buff *skb,\r\nconst struct nf_hook_state *state)\r\n{\r\nstruct sock *sk = skb->sk;\r\nif (sk && sk_fullsock(sk) && (sk->sk_family == PF_INET) &&\r\ninet_sk(sk)->nodefrag)\r\nreturn NF_ACCEPT;\r\n#if IS_ENABLED(CONFIG_NF_CONNTRACK)\r\n#if !IS_ENABLED(CONFIG_NF_NAT)\r\nif (skb_nfct(skb) && !nf_ct_is_template((struct nf_conn *)skb_nfct(skb)))\r\nreturn NF_ACCEPT;\r\n#endif\r\n#endif\r\nif (ip_is_fragment(ip_hdr(skb))) {\r\nenum ip_defrag_users user =\r\nnf_ct_defrag_user(state->hook, skb);\r\nif (nf_ct_ipv4_gather_frags(state->net, skb, user))\r\nreturn NF_STOLEN;\r\n}\r\nreturn NF_ACCEPT;\r\n}\r\nstatic void __net_exit defrag4_net_exit(struct net *net)\r\n{\r\nif (net->nf.defrag_ipv4) {\r\nnf_unregister_net_hooks(net, ipv4_defrag_ops,\r\nARRAY_SIZE(ipv4_defrag_ops));\r\nnet->nf.defrag_ipv4 = false;\r\n}\r\n}\r\nstatic int __init nf_defrag_init(void)\r\n{\r\nreturn register_pernet_subsys(&defrag4_net_ops);\r\n}\r\nstatic void __exit nf_defrag_fini(void)\r\n{\r\nunregister_pernet_subsys(&defrag4_net_ops);\r\n}\r\nint nf_defrag_ipv4_enable(struct net *net)\r\n{\r\nint err = 0;\r\nmight_sleep();\r\nif (net->nf.defrag_ipv4)\r\nreturn 0;\r\nmutex_lock(&defrag4_mutex);\r\nif (net->nf.defrag_ipv4)\r\ngoto out_unlock;\r\nerr = nf_register_net_hooks(net, ipv4_defrag_ops,\r\nARRAY_SIZE(ipv4_defrag_ops));\r\nif (err == 0)\r\nnet->nf.defrag_ipv4 = true;\r\nout_unlock:\r\nmutex_unlock(&defrag4_mutex);\r\nreturn err;\r\n}

int qxl_mode_dumb_create(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nstruct drm_mode_create_dumb *args)\r\n{\r\nstruct qxl_device *qdev = dev->dev_private;\r\nstruct qxl_bo *qobj;\r\nuint32_t handle;\r\nint r;\r\nstruct qxl_surface surf;\r\nuint32_t pitch, format;\r\npitch = args->width * ((args->bpp + 1) / 8);\r\nargs->size = pitch * args->height;\r\nargs->size = ALIGN(args->size, PAGE_SIZE);\r\nswitch (args->bpp) {\r\ncase 16:\r\nformat = SPICE_SURFACE_FMT_16_565;\r\nbreak;\r\ncase 32:\r\nformat = SPICE_SURFACE_FMT_32_xRGB;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsurf.width = args->width;\r\nsurf.height = args->height;\r\nsurf.stride = pitch;\r\nsurf.format = format;\r\nr = qxl_gem_object_create_with_handle(qdev, file_priv,\r\nQXL_GEM_DOMAIN_VRAM,\r\nargs->size, &surf, &qobj,\r\n&handle);\r\nif (r)\r\nreturn r;\r\nargs->pitch = pitch;\r\nargs->handle = handle;\r\nreturn 0;\r\n}\r\nint qxl_mode_dumb_mmap(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nuint32_t handle, uint64_t *offset_p)\r\n{\r\nstruct drm_gem_object *gobj;\r\nstruct qxl_bo *qobj;\r\nBUG_ON(!offset_p);\r\ngobj = drm_gem_object_lookup(file_priv, handle);\r\nif (gobj == NULL)\r\nreturn -ENOENT;\r\nqobj = gem_to_qxl_bo(gobj);\r\n*offset_p = qxl_bo_mmap_offset(qobj);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn 0;\r\n}

void *squashfs_decompressor_create(struct squashfs_sb_info *msblk,\r\nvoid *comp_opts)\r\n{\r\nstruct squashfs_stream *stream;\r\nstruct squashfs_stream __percpu *percpu;\r\nint err, cpu;\r\npercpu = alloc_percpu(struct squashfs_stream);\r\nif (percpu == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor_each_possible_cpu(cpu) {\r\nstream = per_cpu_ptr(percpu, cpu);\r\nstream->stream = msblk->decompressor->init(msblk, comp_opts);\r\nif (IS_ERR(stream->stream)) {\r\nerr = PTR_ERR(stream->stream);\r\ngoto out;\r\n}\r\n}\r\nkfree(comp_opts);\r\nreturn (__force void *) percpu;\r\nout:\r\nfor_each_possible_cpu(cpu) {\r\nstream = per_cpu_ptr(percpu, cpu);\r\nif (!IS_ERR_OR_NULL(stream->stream))\r\nmsblk->decompressor->free(stream->stream);\r\n}\r\nfree_percpu(percpu);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid squashfs_decompressor_destroy(struct squashfs_sb_info *msblk)\r\n{\r\nstruct squashfs_stream __percpu *percpu =\r\n(struct squashfs_stream __percpu *) msblk->stream;\r\nstruct squashfs_stream *stream;\r\nint cpu;\r\nif (msblk->stream) {\r\nfor_each_possible_cpu(cpu) {\r\nstream = per_cpu_ptr(percpu, cpu);\r\nmsblk->decompressor->free(stream->stream);\r\n}\r\nfree_percpu(percpu);\r\n}\r\n}\r\nint squashfs_decompress(struct squashfs_sb_info *msblk, struct buffer_head **bh,\r\nint b, int offset, int length, struct squashfs_page_actor *output)\r\n{\r\nstruct squashfs_stream __percpu *percpu =\r\n(struct squashfs_stream __percpu *) msblk->stream;\r\nstruct squashfs_stream *stream = get_cpu_ptr(percpu);\r\nint res = msblk->decompressor->decompress(msblk, stream->stream, bh, b,\r\noffset, length, output);\r\nput_cpu_ptr(stream);\r\nif (res < 0)\r\nERROR("%s decompression failed, data probably corrupt\n",\r\nmsblk->decompressor->name);\r\nreturn res;\r\n}\r\nint squashfs_max_decompressors(void)\r\n{\r\nreturn num_possible_cpus();\r\n}

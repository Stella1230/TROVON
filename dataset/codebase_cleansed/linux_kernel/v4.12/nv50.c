struct nvkm_vm *\r\nnv50_bar_kmap(struct nvkm_bar *base)\r\n{\r\nreturn nv50_bar(base)->bar3_vm;\r\n}\r\nint\r\nnv50_bar_umap(struct nvkm_bar *base, u64 size, int type, struct nvkm_vma *vma)\r\n{\r\nstruct nv50_bar *bar = nv50_bar(base);\r\nreturn nvkm_vm_get(bar->bar1_vm, size, type, NV_MEM_ACCESS_RW, vma);\r\n}\r\nstatic void\r\nnv50_bar_flush(struct nvkm_bar *base)\r\n{\r\nstruct nv50_bar *bar = nv50_bar(base);\r\nstruct nvkm_device *device = bar->base.subdev.device;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bar->base.lock, flags);\r\nnvkm_wr32(device, 0x00330c, 0x00000001);\r\nnvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x00330c) & 0x00000002))\r\nbreak;\r\n);\r\nspin_unlock_irqrestore(&bar->base.lock, flags);\r\n}\r\nint\r\nnv50_bar_oneinit(struct nvkm_bar *base)\r\n{\r\nstruct nv50_bar *bar = nv50_bar(base);\r\nstruct nvkm_device *device = bar->base.subdev.device;\r\nstatic struct lock_class_key bar1_lock;\r\nstatic struct lock_class_key bar3_lock;\r\nstruct nvkm_vm *vm;\r\nu64 start, limit;\r\nint ret;\r\nret = nvkm_gpuobj_new(device, 0x20000, 0, false, NULL, &bar->mem);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(device, bar->pgd_addr, 0, false, bar->mem,\r\n&bar->pad);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(device, 0x4000, 0, false, bar->mem, &bar->pgd);\r\nif (ret)\r\nreturn ret;\r\nstart = 0x0100000000ULL;\r\nlimit = start + device->func->resource_size(device, 3);\r\nret = nvkm_vm_new(device, start, limit - start, start, &bar3_lock, &vm);\r\nif (ret)\r\nreturn ret;\r\natomic_inc(&vm->engref[NVKM_SUBDEV_BAR]);\r\nret = nvkm_vm_boot(vm, limit-- - start);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_vm_ref(vm, &bar->bar3_vm, bar->pgd);\r\nnvkm_vm_ref(NULL, &vm, NULL);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(device, 24, 16, false, bar->mem, &bar->bar3);\r\nif (ret)\r\nreturn ret;\r\nnvkm_kmap(bar->bar3);\r\nnvkm_wo32(bar->bar3, 0x00, 0x7fc00000);\r\nnvkm_wo32(bar->bar3, 0x04, lower_32_bits(limit));\r\nnvkm_wo32(bar->bar3, 0x08, lower_32_bits(start));\r\nnvkm_wo32(bar->bar3, 0x0c, upper_32_bits(limit) << 24 |\r\nupper_32_bits(start));\r\nnvkm_wo32(bar->bar3, 0x10, 0x00000000);\r\nnvkm_wo32(bar->bar3, 0x14, 0x00000000);\r\nnvkm_done(bar->bar3);\r\nstart = 0x0000000000ULL;\r\nlimit = start + device->func->resource_size(device, 1);\r\nret = nvkm_vm_new(device, start, limit-- - start, start, &bar1_lock, &vm);\r\nif (ret)\r\nreturn ret;\r\natomic_inc(&vm->engref[NVKM_SUBDEV_BAR]);\r\nret = nvkm_vm_ref(vm, &bar->bar1_vm, bar->pgd);\r\nnvkm_vm_ref(NULL, &vm, NULL);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(device, 24, 16, false, bar->mem, &bar->bar1);\r\nif (ret)\r\nreturn ret;\r\nnvkm_kmap(bar->bar1);\r\nnvkm_wo32(bar->bar1, 0x00, 0x7fc00000);\r\nnvkm_wo32(bar->bar1, 0x04, lower_32_bits(limit));\r\nnvkm_wo32(bar->bar1, 0x08, lower_32_bits(start));\r\nnvkm_wo32(bar->bar1, 0x0c, upper_32_bits(limit) << 24 |\r\nupper_32_bits(start));\r\nnvkm_wo32(bar->bar1, 0x10, 0x00000000);\r\nnvkm_wo32(bar->bar1, 0x14, 0x00000000);\r\nnvkm_done(bar->bar1);\r\nreturn 0;\r\n}\r\nint\r\nnv50_bar_init(struct nvkm_bar *base)\r\n{\r\nstruct nv50_bar *bar = nv50_bar(base);\r\nstruct nvkm_device *device = bar->base.subdev.device;\r\nint i;\r\nnvkm_mask(device, 0x000200, 0x00000100, 0x00000000);\r\nnvkm_mask(device, 0x000200, 0x00000100, 0x00000100);\r\nnvkm_wr32(device, 0x100c80, 0x00060001);\r\nif (nvkm_msec(device, 2000,\r\nif (!(nvkm_rd32(device, 0x100c80) & 0x00000001))\r\nbreak;\r\n) < 0)\r\nreturn -EBUSY;\r\nnvkm_wr32(device, 0x001704, 0x00000000 | bar->mem->addr >> 12);\r\nnvkm_wr32(device, 0x001704, 0x40000000 | bar->mem->addr >> 12);\r\nnvkm_wr32(device, 0x001708, 0x80000000 | bar->bar1->node->offset >> 4);\r\nnvkm_wr32(device, 0x00170c, 0x80000000 | bar->bar3->node->offset >> 4);\r\nfor (i = 0; i < 8; i++)\r\nnvkm_wr32(device, 0x001900 + (i * 4), 0x00000000);\r\nreturn 0;\r\n}\r\nvoid *\r\nnv50_bar_dtor(struct nvkm_bar *base)\r\n{\r\nstruct nv50_bar *bar = nv50_bar(base);\r\nnvkm_gpuobj_del(&bar->bar1);\r\nnvkm_vm_ref(NULL, &bar->bar1_vm, bar->pgd);\r\nnvkm_gpuobj_del(&bar->bar3);\r\nif (bar->bar3_vm) {\r\nnvkm_memory_del(&bar->bar3_vm->pgt[0].mem[0]);\r\nnvkm_vm_ref(NULL, &bar->bar3_vm, bar->pgd);\r\n}\r\nnvkm_gpuobj_del(&bar->pgd);\r\nnvkm_gpuobj_del(&bar->pad);\r\nnvkm_gpuobj_del(&bar->mem);\r\nreturn bar;\r\n}\r\nint\r\nnv50_bar_new_(const struct nvkm_bar_func *func, struct nvkm_device *device,\r\nint index, u32 pgd_addr, struct nvkm_bar **pbar)\r\n{\r\nstruct nv50_bar *bar;\r\nif (!(bar = kzalloc(sizeof(*bar), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nnvkm_bar_ctor(func, device, index, &bar->base);\r\nbar->pgd_addr = pgd_addr;\r\n*pbar = &bar->base;\r\nreturn 0;\r\n}\r\nint\r\nnv50_bar_new(struct nvkm_device *device, int index, struct nvkm_bar **pbar)\r\n{\r\nreturn nv50_bar_new_(&nv50_bar_func, device, index, 0x1400, pbar);\r\n}

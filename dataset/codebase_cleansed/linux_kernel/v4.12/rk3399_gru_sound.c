static int rockchip_sound_max98357a_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nunsigned int mclk;\r\nint ret;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\ncase 16000:\r\ncase 48000:\r\ncase 96000:\r\nmclk = params_rate(params) * SOUND_FS;\r\nbreak;\r\ndefault:\r\ndev_err(rtd->card->dev, "%s() doesn't support this sample rate: %d\n",\r\n__func__, params_rate(params));\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_sysclk(rtd->cpu_dai, 0, mclk, 0);\r\nif (ret) {\r\ndev_err(rtd->card->dev, "%s() error setting sysclk to %u: %d\n",\r\n__func__, mclk, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_sound_rt5514_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nunsigned int mclk;\r\nint ret;\r\nmclk = params_rate(params) * SOUND_FS;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\r\nSND_SOC_CLOCK_OUT);\r\nif (ret < 0) {\r\ndev_err(rtd->card->dev, "Can't set cpu clock out %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, RT5514_SCLK_S_MCLK,\r\nmclk, SND_SOC_CLOCK_IN);\r\nif (ret) {\r\ndev_err(rtd->card->dev, "%s() error setting sysclk to %u: %d\n",\r\n__func__, params_rate(params) * 512, ret);\r\nreturn ret;\r\n}\r\nmsleep(rt5514_dmic_delay);\r\nreturn 0;\r\n}\r\nstatic int rockchip_sound_da7219_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint mclk, ret;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\ncase 16000:\r\ncase 24000:\r\ncase 32000:\r\ncase 48000:\r\ncase 64000:\r\ncase 96000:\r\nmclk = 12288000;\r\nbreak;\r\ncase 11025:\r\ncase 22050:\r\ncase 44100:\r\ncase 88200:\r\nmclk = 11289600;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_sysclk(cpu_dai, 0, mclk,\r\nSND_SOC_CLOCK_OUT);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "Can't set cpu clock out %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, mclk,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "Can't set codec clock in %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_pll(codec_dai, 0, DA7219_SYSCLK_MCLK, 0, 0);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "Can't set pll sysclk mclk %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_sound_da7219_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec_dais[0]->codec;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, 12288000,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "Init can't set codec clock in %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_pll(codec_dai, 0, DA7219_SYSCLK_MCLK, 0, 0);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "Init can't set pll sysclk mclk %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_card_jack_new(rtd->card, "Headset Jack",\r\nSND_JACK_HEADSET | SND_JACK_LINEOUT |\r\nSND_JACK_BTN_0 | SND_JACK_BTN_1 |\r\nSND_JACK_BTN_2 | SND_JACK_BTN_3,\r\n&rockchip_sound_jack, NULL, 0);\r\nif (ret) {\r\ndev_err(rtd->card->dev, "New Headset Jack failed! (%d)\n", ret);\r\nreturn ret;\r\n}\r\nsnd_jack_set_key(rockchip_sound_jack.jack, SND_JACK_BTN_0, KEY_MEDIA);\r\nsnd_jack_set_key(\r\nrockchip_sound_jack.jack, SND_JACK_BTN_1, KEY_VOLUMEUP);\r\nsnd_jack_set_key(\r\nrockchip_sound_jack.jack, SND_JACK_BTN_2, KEY_VOLUMEDOWN);\r\nsnd_jack_set_key(\r\nrockchip_sound_jack.jack, SND_JACK_BTN_3, KEY_VOICECOMMAND);\r\nda7219_aad_jack_det(codec, &rockchip_sound_jack);\r\nreturn 0;\r\n}\r\nstatic int rockchip_sound_match_stub(struct device *dev, void *data)\r\n{\r\nreturn 1;\r\n}\r\nstatic int rockchip_sound_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &rockchip_sound_card;\r\nstruct device_node *cpu_node;\r\nstruct device *dev;\r\nstruct device_driver *drv;\r\nint i, ret;\r\ncpu_node = of_parse_phandle(pdev->dev.of_node, "rockchip,cpu", 0);\r\nif (!cpu_node) {\r\ndev_err(&pdev->dev, "Property 'rockchip,cpu' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < DAILINK_ENTITIES; i++) {\r\nrockchip_dailinks[i].platform_of_node = cpu_node;\r\nrockchip_dailinks[i].cpu_of_node = cpu_node;\r\nrockchip_dailinks[i].codec_of_node =\r\nof_parse_phandle(pdev->dev.of_node, "rockchip,codec", i);\r\nif (!rockchip_dailinks[i].codec_of_node) {\r\ndev_err(&pdev->dev,\r\n"Property[%d] 'rockchip,codec' missing or invalid\n", i);\r\nreturn -EINVAL;\r\n}\r\n}\r\ndrv = driver_find("rt5514", &spi_bus_type);\r\nif (!drv) {\r\ndev_err(&pdev->dev, "Can not find the rt5514 driver at the spi bus\n");\r\nreturn -EINVAL;\r\n}\r\ndev = driver_find_device(drv, NULL, NULL, rockchip_sound_match_stub);\r\nif (!dev) {\r\ndev_err(&pdev->dev, "Can not find the rt5514 device\n");\r\nreturn -ENODEV;\r\n}\r\nret = device_property_read_u32(&pdev->dev, "dmic-delay",\r\n&rt5514_dmic_delay);\r\nif (ret) {\r\nrt5514_dmic_delay = 0;\r\ndev_dbg(&pdev->dev,\r\n"no optional property 'dmic-delay' found, default: no delay\n");\r\n}\r\nrockchip_dailinks[DAILINK_RT5514_DSP].cpu_name = kstrdup_const(dev_name(dev), GFP_KERNEL);\r\nrockchip_dailinks[DAILINK_RT5514_DSP].cpu_dai_name = kstrdup_const(dev_name(dev), GFP_KERNEL);\r\nrockchip_dailinks[DAILINK_RT5514_DSP].platform_name = kstrdup_const(dev_name(dev), GFP_KERNEL);\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "%s snd_soc_register_card fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}

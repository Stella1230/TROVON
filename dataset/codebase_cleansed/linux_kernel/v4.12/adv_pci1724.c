static int adv_pci1724_dac_idle(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inl(dev->iobase + PCI1724_SYNC_CTRL_REG);\r\nif ((status & PCI1724_SYNC_CTRL_DACSTAT) == 0)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int adv_pci1724_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long mode = (unsigned long)s->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int ctrl;\r\nint ret;\r\nint i;\r\nctrl = PCI1724_DAC_CTRL_GX(chan) | PCI1724_DAC_CTRL_CX(chan) | mode;\r\noutl(0, dev->iobase + PCI1724_SYNC_CTRL_REG);\r\nfor (i = 0; i < insn->n; ++i) {\r\nunsigned int val = data[i];\r\nret = comedi_timeout(dev, s, insn, adv_pci1724_dac_idle, 0);\r\nif (ret)\r\nreturn ret;\r\noutl(ctrl | PCI1724_DAC_CTRL_DATA(val),\r\ndev->iobase + PCI1724_DAC_CTRL_REG);\r\ns->readback[chan] = val;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int adv_pci1724_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct comedi_subdevice *s;\r\nunsigned int board_id;\r\nint ret;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\nboard_id = inl(dev->iobase + PCI1724_BOARD_ID_REG);\r\ndev_info(dev->class_dev, "board id: %d\n",\r\nboard_id & PCI1724_BOARD_ID_MASK);\r\nret = comedi_alloc_subdevices(dev, 3);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE | SDF_GROUND;\r\ns->n_chan = 32;\r\ns->maxdata = 0x3fff;\r\ns->range_table = &adv_pci1724_ao_ranges;\r\ns->insn_write = adv_pci1724_insn_write;\r\ns->private = (void *)PCI1724_DAC_CTRL_MODE_NORMAL;\r\nret = comedi_alloc_subdev_readback(s);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_CALIB;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE | SDF_INTERNAL;\r\ns->n_chan = 32;\r\ns->maxdata = 0x3fff;\r\ns->insn_write = adv_pci1724_insn_write;\r\ns->private = (void *)PCI1724_DAC_CTRL_MODE_OFFSET;\r\nret = comedi_alloc_subdev_readback(s);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[2];\r\ns->type = COMEDI_SUBD_CALIB;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE | SDF_INTERNAL;\r\ns->n_chan = 32;\r\ns->maxdata = 0x3fff;\r\ns->insn_write = adv_pci1724_insn_write;\r\ns->private = (void *)PCI1724_DAC_CTRL_MODE_GAIN;\r\nreturn comedi_alloc_subdev_readback(s);\r\n}\r\nstatic int adv_pci1724_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &adv_pci1724_driver,\r\nid->driver_data);\r\n}

int rtc_month_days(unsigned int month, unsigned int year)\r\n{\r\nreturn rtc_days_in_month[month] + (is_leap_year(year) && month == 1);\r\n}\r\nint rtc_year_days(unsigned int day, unsigned int month, unsigned int year)\r\n{\r\nreturn rtc_ydays[is_leap_year(year)][month] + day-1;\r\n}\r\nvoid rtc_time64_to_tm(time64_t time, struct rtc_time *tm)\r\n{\r\nunsigned int month, year;\r\nunsigned long secs;\r\nint days;\r\ndays = div_s64(time, 86400);\r\nsecs = time - (unsigned int) days * 86400;\r\ntm->tm_wday = (days + 4) % 7;\r\nyear = 1970 + days / 365;\r\ndays -= (year - 1970) * 365\r\n+ LEAPS_THRU_END_OF(year - 1)\r\n- LEAPS_THRU_END_OF(1970 - 1);\r\nif (days < 0) {\r\nyear -= 1;\r\ndays += 365 + is_leap_year(year);\r\n}\r\ntm->tm_year = year - 1900;\r\ntm->tm_yday = days + 1;\r\nfor (month = 0; month < 11; month++) {\r\nint newdays;\r\nnewdays = days - rtc_month_days(month, year);\r\nif (newdays < 0)\r\nbreak;\r\ndays = newdays;\r\n}\r\ntm->tm_mon = month;\r\ntm->tm_mday = days + 1;\r\ntm->tm_hour = secs / 3600;\r\nsecs -= tm->tm_hour * 3600;\r\ntm->tm_min = secs / 60;\r\ntm->tm_sec = secs - tm->tm_min * 60;\r\ntm->tm_isdst = 0;\r\n}\r\nint rtc_valid_tm(struct rtc_time *tm)\r\n{\r\nif (tm->tm_year < 70\r\n|| ((unsigned)tm->tm_mon) >= 12\r\n|| tm->tm_mday < 1\r\n|| tm->tm_mday > rtc_month_days(tm->tm_mon, tm->tm_year + 1900)\r\n|| ((unsigned)tm->tm_hour) >= 24\r\n|| ((unsigned)tm->tm_min) >= 60\r\n|| ((unsigned)tm->tm_sec) >= 60)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\ntime64_t rtc_tm_to_time64(struct rtc_time *tm)\r\n{\r\nreturn mktime64(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\n}\r\nktime_t rtc_tm_to_ktime(struct rtc_time tm)\r\n{\r\nreturn ktime_set(rtc_tm_to_time64(&tm), 0);\r\n}\r\nstruct rtc_time rtc_ktime_to_tm(ktime_t kt)\r\n{\r\nstruct timespec64 ts;\r\nstruct rtc_time ret;\r\nts = ktime_to_timespec64(kt);\r\nif (ts.tv_nsec)\r\nts.tv_sec++;\r\nrtc_time64_to_tm(ts.tv_sec, &ret);\r\nreturn ret;\r\n}

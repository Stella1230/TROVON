int __init tx4927_report_pciclk(void)\r\n{\r\nint pciclk = 0;\r\npr_info("PCIC --%s PCICLK:",\r\n(__raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_PCI66) ?\r\n" PCI66" : "");\r\nif (__raw_readq(&tx4927_ccfgptr->pcfg) & TX4927_PCFG_PCICLKEN_ALL) {\r\nu64 ccfg = __raw_readq(&tx4927_ccfgptr->ccfg);\r\nswitch ((unsigned long)ccfg &\r\nTX4927_CCFG_PCIDIVMODE_MASK) {\r\ncase TX4927_CCFG_PCIDIVMODE_2_5:\r\npciclk = txx9_cpu_clock * 2 / 5; break;\r\ncase TX4927_CCFG_PCIDIVMODE_3:\r\npciclk = txx9_cpu_clock / 3; break;\r\ncase TX4927_CCFG_PCIDIVMODE_5:\r\npciclk = txx9_cpu_clock / 5; break;\r\ncase TX4927_CCFG_PCIDIVMODE_6:\r\npciclk = txx9_cpu_clock / 6; break;\r\n}\r\npr_cont("Internal(%u.%uMHz)",\r\n(pciclk + 50000) / 1000000,\r\n((pciclk + 50000) / 100000) % 10);\r\n} else {\r\npr_cont("External");\r\npciclk = -1;\r\n}\r\npr_cont("\n");\r\nreturn pciclk;\r\n}\r\nint __init tx4927_pciclk66_setup(void)\r\n{\r\nint pciclk;\r\ntx4927_ccfg_set(TX4927_CCFG_PCI66);\r\nif (__raw_readq(&tx4927_ccfgptr->pcfg) & TX4927_PCFG_PCICLKEN_ALL) {\r\nunsigned int pcidivmode = 0;\r\nu64 ccfg = __raw_readq(&tx4927_ccfgptr->ccfg);\r\npcidivmode = (unsigned long)ccfg &\r\nTX4927_CCFG_PCIDIVMODE_MASK;\r\nswitch (pcidivmode) {\r\ncase TX4927_CCFG_PCIDIVMODE_5:\r\ncase TX4927_CCFG_PCIDIVMODE_2_5:\r\npcidivmode = TX4927_CCFG_PCIDIVMODE_2_5;\r\npciclk = txx9_cpu_clock * 2 / 5;\r\nbreak;\r\ncase TX4927_CCFG_PCIDIVMODE_6:\r\ncase TX4927_CCFG_PCIDIVMODE_3:\r\ndefault:\r\npcidivmode = TX4927_CCFG_PCIDIVMODE_3;\r\npciclk = txx9_cpu_clock / 3;\r\n}\r\ntx4927_ccfg_change(TX4927_CCFG_PCIDIVMODE_MASK,\r\npcidivmode);\r\npr_debug("PCICLK: ccfg:%08lx\n",\r\n(unsigned long)__raw_readq(&tx4927_ccfgptr->ccfg));\r\n} else\r\npciclk = -1;\r\nreturn pciclk;\r\n}\r\nvoid __init tx4927_setup_pcierr_irq(void)\r\n{\r\nif (request_irq(TXX9_IRQ_BASE + TX4927_IR_PCIERR,\r\ntx4927_pcierr_interrupt,\r\n0, "PCI error",\r\n(void *)TX4927_PCIC_REG))\r\npr_warn("Failed to request irq for PCIERR\n");\r\n}

static int sst_platform_get_resources(struct intel_sst_drv *ctx)\r\n{\r\nint ddr_base, ret = 0;\r\nstruct pci_dev *pci = ctx->pci;\r\nret = pci_request_regions(pci, SST_DRV_NAME);\r\nif (ret)\r\nreturn ret;\r\nif (ctx->dev_id == SST_MRFLD_PCI_ID) {\r\nctx->ddr_base = pci_resource_start(pci, 0);\r\nddr_base = relocate_imr_addr_mrfld(ctx->ddr_base);\r\nif (!ctx->pdata->lib_info) {\r\ndev_err(ctx->dev, "lib_info pointer NULL\n");\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\nif (ddr_base != ctx->pdata->lib_info->mod_base) {\r\ndev_err(ctx->dev,\r\n"FW LSP DDR BASE does not match with IFWI\n");\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\nctx->ddr_end = pci_resource_end(pci, 0);\r\nctx->ddr = pcim_iomap(pci, 0,\r\npci_resource_len(pci, 0));\r\nif (!ctx->ddr) {\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\ndev_dbg(ctx->dev, "sst: DDR Ptr %p\n", ctx->ddr);\r\n} else {\r\nctx->ddr = NULL;\r\n}\r\nctx->shim_phy_add = pci_resource_start(pci, 1);\r\nctx->shim = pcim_iomap(pci, 1, pci_resource_len(pci, 1));\r\nif (!ctx->shim) {\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\ndev_dbg(ctx->dev, "SST Shim Ptr %p\n", ctx->shim);\r\nctx->mailbox_add = pci_resource_start(pci, 2);\r\nctx->mailbox = pcim_iomap(pci, 2, pci_resource_len(pci, 2));\r\nif (!ctx->mailbox) {\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\ndev_dbg(ctx->dev, "SRAM Ptr %p\n", ctx->mailbox);\r\nctx->iram_end = pci_resource_end(pci, 3);\r\nctx->iram_base = pci_resource_start(pci, 3);\r\nctx->iram = pcim_iomap(pci, 3, pci_resource_len(pci, 3));\r\nif (!ctx->iram) {\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\ndev_dbg(ctx->dev, "IRAM Ptr %p\n", ctx->iram);\r\nctx->dram_end = pci_resource_end(pci, 4);\r\nctx->dram_base = pci_resource_start(pci, 4);\r\nctx->dram = pcim_iomap(pci, 4, pci_resource_len(pci, 4));\r\nif (!ctx->dram) {\r\nret = -EINVAL;\r\ngoto do_release_regions;\r\n}\r\ndev_dbg(ctx->dev, "DRAM Ptr %p\n", ctx->dram);\r\ndo_release_regions:\r\npci_release_regions(pci);\r\nreturn 0;\r\n}\r\nstatic int intel_sst_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nint ret = 0;\r\nstruct intel_sst_drv *sst_drv_ctx;\r\nstruct sst_platform_info *sst_pdata = pci->dev.platform_data;\r\ndev_dbg(&pci->dev, "Probe for DID %x\n", pci->device);\r\nret = sst_alloc_drv_context(&sst_drv_ctx, &pci->dev, pci->device);\r\nif (ret < 0)\r\nreturn ret;\r\nsst_drv_ctx->pdata = sst_pdata;\r\nsst_drv_ctx->irq_num = pci->irq;\r\nsnprintf(sst_drv_ctx->firmware_name, sizeof(sst_drv_ctx->firmware_name),\r\n"%s%04x%s", "fw_sst_",\r\nsst_drv_ctx->dev_id, ".bin");\r\nret = sst_context_init(sst_drv_ctx);\r\nif (ret < 0)\r\nreturn ret;\r\nret = pcim_enable_device(pci);\r\nif (ret) {\r\ndev_err(sst_drv_ctx->dev,\r\n"device can't be enabled. Returned err: %d\n", ret);\r\ngoto do_free_drv_ctx;\r\n}\r\nsst_drv_ctx->pci = pci_dev_get(pci);\r\nret = sst_platform_get_resources(sst_drv_ctx);\r\nif (ret < 0)\r\ngoto do_free_drv_ctx;\r\npci_set_drvdata(pci, sst_drv_ctx);\r\nsst_configure_runtime_pm(sst_drv_ctx);\r\nreturn ret;\r\ndo_free_drv_ctx:\r\nsst_context_cleanup(sst_drv_ctx);\r\ndev_err(sst_drv_ctx->dev, "Probe failed with %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void intel_sst_remove(struct pci_dev *pci)\r\n{\r\nstruct intel_sst_drv *sst_drv_ctx = pci_get_drvdata(pci);\r\nsst_context_cleanup(sst_drv_ctx);\r\npci_dev_put(sst_drv_ctx->pci);\r\npci_release_regions(pci);\r\npci_set_drvdata(pci, NULL);\r\n}

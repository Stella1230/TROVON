void drain_openssl_errors(void)\r\n{\r\nconst char *file;\r\nint line;\r\nif (ERR_peek_error() == 0)\r\nreturn;\r\nwhile (ERR_get_error_line(&file, &line)) {}\r\n}\r\nstatic int pem_pw_cb(char *buf, int len, int w, void *v)\r\n{\r\nint pwlen;\r\nif (!key_pass)\r\nreturn -1;\r\npwlen = strlen(key_pass);\r\nif (pwlen >= len)\r\nreturn -1;\r\nstrcpy(buf, key_pass);\r\nkey_pass = NULL;\r\nreturn pwlen;\r\n}\r\nstatic EVP_PKEY *read_private_key(const char *private_key_name)\r\n{\r\nEVP_PKEY *private_key;\r\nif (!strncmp(private_key_name, "pkcs11:", 7)) {\r\nENGINE *e;\r\nENGINE_load_builtin_engines();\r\ndrain_openssl_errors();\r\ne = ENGINE_by_id("pkcs11");\r\nERR(!e, "Load PKCS#11 ENGINE");\r\nif (ENGINE_init(e))\r\ndrain_openssl_errors();\r\nelse\r\nERR(1, "ENGINE_init");\r\nif (key_pass)\r\nERR(!ENGINE_ctrl_cmd_string(e, "PIN", key_pass, 0),\r\n"Set PKCS#11 PIN");\r\nprivate_key = ENGINE_load_private_key(e, private_key_name,\r\nNULL, NULL);\r\nERR(!private_key, "%s", private_key_name);\r\n} else {\r\nBIO *b;\r\nb = BIO_new_file(private_key_name, "rb");\r\nERR(!b, "%s", private_key_name);\r\nprivate_key = PEM_read_bio_PrivateKey(b, NULL, pem_pw_cb,\r\nNULL);\r\nERR(!private_key, "%s", private_key_name);\r\nBIO_free(b);\r\n}\r\nreturn private_key;\r\n}\r\nstatic X509 *read_x509(const char *x509_name)\r\n{\r\nunsigned char buf[2];\r\nX509 *x509;\r\nBIO *b;\r\nint n;\r\nb = BIO_new_file(x509_name, "rb");\r\nERR(!b, "%s", x509_name);\r\nn = BIO_read(b, buf, 2);\r\nif (n != 2) {\r\nif (BIO_should_retry(b)) {\r\nfprintf(stderr, "%s: Read wanted retry\n", x509_name);\r\nexit(1);\r\n}\r\nif (n >= 0) {\r\nfprintf(stderr, "%s: Short read\n", x509_name);\r\nexit(1);\r\n}\r\nERR(1, "%s", x509_name);\r\n}\r\nERR(BIO_reset(b) != 0, "%s", x509_name);\r\nif (buf[0] == 0x30 && buf[1] >= 0x81 && buf[1] <= 0x84)\r\nx509 = d2i_X509_bio(b, NULL);\r\nelse\r\nx509 = PEM_read_bio_X509(b, NULL, NULL, NULL);\r\nBIO_free(b);\r\nERR(!x509, "%s", x509_name);\r\nreturn x509;\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nstruct module_signature sig_info = { .id_type = PKEY_ID_PKCS7 };\r\nchar *hash_algo = NULL;\r\nchar *private_key_name = NULL, *raw_sig_name = NULL;\r\nchar *x509_name, *module_name, *dest_name;\r\nbool save_sig = false, replace_orig;\r\nbool sign_only = false;\r\nbool raw_sig = false;\r\nunsigned char buf[4096];\r\nunsigned long module_size, sig_size;\r\nunsigned int use_signed_attrs;\r\nconst EVP_MD *digest_algo;\r\nEVP_PKEY *private_key;\r\n#ifndef USE_PKCS7\r\nCMS_ContentInfo *cms = NULL;\r\nunsigned int use_keyid = 0;\r\n#else\r\nPKCS7 *pkcs7 = NULL;\r\n#endif\r\nX509 *x509;\r\nBIO *bd, *bm;\r\nint opt, n;\r\nOpenSSL_add_all_algorithms();\r\nERR_load_crypto_strings();\r\nERR_clear_error();\r\nkey_pass = getenv("KBUILD_SIGN_PIN");\r\n#ifndef USE_PKCS7\r\nuse_signed_attrs = CMS_NOATTR;\r\n#else\r\nuse_signed_attrs = PKCS7_NOATTR;\r\n#endif\r\ndo {\r\nopt = getopt(argc, argv, "sdpk");\r\nswitch (opt) {\r\ncase 's': raw_sig = true; break;\r\ncase 'p': save_sig = true; break;\r\ncase 'd': sign_only = true; save_sig = true; break;\r\n#ifndef USE_PKCS7\r\ncase 'k': use_keyid = CMS_USE_KEYID; break;\r\n#endif\r\ncase -1: break;\r\ndefault: format();\r\n}\r\n} while (opt != -1);\r\nargc -= optind;\r\nargv += optind;\r\nif (argc < 4 || argc > 5)\r\nformat();\r\nif (raw_sig) {\r\nraw_sig_name = argv[0];\r\nhash_algo = argv[1];\r\n} else {\r\nhash_algo = argv[0];\r\nprivate_key_name = argv[1];\r\n}\r\nx509_name = argv[2];\r\nmodule_name = argv[3];\r\nif (argc == 5 && strcmp(argv[3], argv[4]) != 0) {\r\ndest_name = argv[4];\r\nreplace_orig = false;\r\n} else {\r\nERR(asprintf(&dest_name, "%s.~signed~", module_name) < 0,\r\n"asprintf");\r\nreplace_orig = true;\r\n}\r\n#ifdef USE_PKCS7\r\nif (strcmp(hash_algo, "sha1") != 0) {\r\nfprintf(stderr, "sign-file: %s only supports SHA1 signing\n",\r\nOPENSSL_VERSION_TEXT);\r\nexit(3);\r\n}\r\n#endif\r\nbm = BIO_new_file(module_name, "rb");\r\nERR(!bm, "%s", module_name);\r\nif (!raw_sig) {\r\nprivate_key = read_private_key(private_key_name);\r\nx509 = read_x509(x509_name);\r\nOpenSSL_add_all_digests();\r\ndisplay_openssl_errors(__LINE__);\r\ndigest_algo = EVP_get_digestbyname(hash_algo);\r\nERR(!digest_algo, "EVP_get_digestbyname");\r\n#ifndef USE_PKCS7\r\ncms = CMS_sign(NULL, NULL, NULL, NULL,\r\nCMS_NOCERTS | CMS_PARTIAL | CMS_BINARY |\r\nCMS_DETACHED | CMS_STREAM);\r\nERR(!cms, "CMS_sign");\r\nERR(!CMS_add1_signer(cms, x509, private_key, digest_algo,\r\nCMS_NOCERTS | CMS_BINARY |\r\nCMS_NOSMIMECAP | use_keyid |\r\nuse_signed_attrs),\r\n"CMS_add1_signer");\r\nERR(CMS_final(cms, bm, NULL, CMS_NOCERTS | CMS_BINARY) < 0,\r\n"CMS_final");\r\n#else\r\npkcs7 = PKCS7_sign(x509, private_key, NULL, bm,\r\nPKCS7_NOCERTS | PKCS7_BINARY |\r\nPKCS7_DETACHED | use_signed_attrs);\r\nERR(!pkcs7, "PKCS7_sign");\r\n#endif\r\nif (save_sig) {\r\nchar *sig_file_name;\r\nBIO *b;\r\nERR(asprintf(&sig_file_name, "%s.p7s", module_name) < 0,\r\n"asprintf");\r\nb = BIO_new_file(sig_file_name, "wb");\r\nERR(!b, "%s", sig_file_name);\r\n#ifndef USE_PKCS7\r\nERR(i2d_CMS_bio_stream(b, cms, NULL, 0) < 0,\r\n"%s", sig_file_name);\r\n#else\r\nERR(i2d_PKCS7_bio(b, pkcs7) < 0,\r\n"%s", sig_file_name);\r\n#endif\r\nBIO_free(b);\r\n}\r\nif (sign_only) {\r\nBIO_free(bm);\r\nreturn 0;\r\n}\r\n}\r\nbd = BIO_new_file(dest_name, "wb");\r\nERR(!bd, "%s", dest_name);\r\nERR(BIO_reset(bm) < 0, "%s", module_name);\r\nwhile ((n = BIO_read(bm, buf, sizeof(buf))),\r\nn > 0) {\r\nERR(BIO_write(bd, buf, n) < 0, "%s", dest_name);\r\n}\r\nBIO_free(bm);\r\nERR(n < 0, "%s", module_name);\r\nmodule_size = BIO_number_written(bd);\r\nif (!raw_sig) {\r\n#ifndef USE_PKCS7\r\nERR(i2d_CMS_bio_stream(bd, cms, NULL, 0) < 0, "%s", dest_name);\r\n#else\r\nERR(i2d_PKCS7_bio(bd, pkcs7) < 0, "%s", dest_name);\r\n#endif\r\n} else {\r\nBIO *b;\r\nb = BIO_new_file(raw_sig_name, "rb");\r\nERR(!b, "%s", raw_sig_name);\r\nwhile ((n = BIO_read(b, buf, sizeof(buf))), n > 0)\r\nERR(BIO_write(bd, buf, n) < 0, "%s", dest_name);\r\nBIO_free(b);\r\n}\r\nsig_size = BIO_number_written(bd) - module_size;\r\nsig_info.sig_len = htonl(sig_size);\r\nERR(BIO_write(bd, &sig_info, sizeof(sig_info)) < 0, "%s", dest_name);\r\nERR(BIO_write(bd, magic_number, sizeof(magic_number) - 1) < 0, "%s", dest_name);\r\nERR(BIO_free(bd) < 0, "%s", dest_name);\r\nif (replace_orig)\r\nERR(rename(dest_name, module_name) < 0, "%s", dest_name);\r\nreturn 0;\r\n}

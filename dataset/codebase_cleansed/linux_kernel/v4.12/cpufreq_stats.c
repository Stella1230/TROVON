static int cpufreq_stats_update(struct cpufreq_stats *stats)\r\n{\r\nunsigned long long cur_time = get_jiffies_64();\r\nspin_lock(&cpufreq_stats_lock);\r\nstats->time_in_state[stats->last_index] += cur_time - stats->last_time;\r\nstats->last_time = cur_time;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic void cpufreq_stats_clear_table(struct cpufreq_stats *stats)\r\n{\r\nunsigned int count = stats->max_state;\r\nmemset(stats->time_in_state, 0, count * sizeof(u64));\r\nmemset(stats->trans_table, 0, count * count * sizeof(int));\r\nstats->last_time = get_jiffies_64();\r\nstats->total_trans = 0;\r\n}\r\nstatic ssize_t show_total_trans(struct cpufreq_policy *policy, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", policy->stats->total_trans);\r\n}\r\nstatic ssize_t show_time_in_state(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nssize_t len = 0;\r\nint i;\r\nif (policy->fast_switch_enabled)\r\nreturn 0;\r\ncpufreq_stats_update(stats);\r\nfor (i = 0; i < stats->state_num; i++) {\r\nlen += sprintf(buf + len, "%u %llu\n", stats->freq_table[i],\r\n(unsigned long long)\r\njiffies_64_to_clock_t(stats->time_in_state[i]));\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t store_reset(struct cpufreq_policy *policy, const char *buf,\r\nsize_t count)\r\n{\r\ncpufreq_stats_clear_table(policy->stats);\r\nreturn count;\r\n}\r\nstatic ssize_t show_trans_table(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nssize_t len = 0;\r\nint i, j;\r\nif (policy->fast_switch_enabled)\r\nreturn 0;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " From : To\n");\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " : ");\r\nfor (i = 0; i < stats->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstats->freq_table[i]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\nfor (i = 0; i < stats->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u: ",\r\nstats->freq_table[i]);\r\nfor (j = 0; j < stats->state_num; j++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstats->trans_table[i*stats->max_state+j]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nreturn len;\r\n}\r\nstatic int freq_table_get_index(struct cpufreq_stats *stats, unsigned int freq)\r\n{\r\nint index;\r\nfor (index = 0; index < stats->max_state; index++)\r\nif (stats->freq_table[index] == freq)\r\nreturn index;\r\nreturn -1;\r\n}\r\nvoid cpufreq_stats_free_table(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nif (!stats)\r\nreturn;\r\npr_debug("%s: Free stats table\n", __func__);\r\nsysfs_remove_group(&policy->kobj, &stats_attr_group);\r\nkfree(stats->time_in_state);\r\nkfree(stats);\r\npolicy->stats = NULL;\r\n}\r\nvoid cpufreq_stats_create_table(struct cpufreq_policy *policy)\r\n{\r\nunsigned int i = 0, count = 0, ret = -ENOMEM;\r\nstruct cpufreq_stats *stats;\r\nunsigned int alloc_size;\r\nstruct cpufreq_frequency_table *pos, *table;\r\ntable = policy->freq_table;\r\nif (unlikely(!table))\r\nreturn;\r\nif (policy->stats)\r\nreturn;\r\nstats = kzalloc(sizeof(*stats), GFP_KERNEL);\r\nif (!stats)\r\nreturn;\r\ncpufreq_for_each_valid_entry(pos, table)\r\ncount++;\r\nalloc_size = count * sizeof(int) + count * sizeof(u64);\r\nalloc_size += count * count * sizeof(int);\r\nstats->time_in_state = kzalloc(alloc_size, GFP_KERNEL);\r\nif (!stats->time_in_state)\r\ngoto free_stat;\r\nstats->freq_table = (unsigned int *)(stats->time_in_state + count);\r\nstats->trans_table = stats->freq_table + count;\r\nstats->max_state = count;\r\ncpufreq_for_each_valid_entry(pos, table)\r\nif (freq_table_get_index(stats, pos->frequency) == -1)\r\nstats->freq_table[i++] = pos->frequency;\r\nstats->state_num = i;\r\nstats->last_time = get_jiffies_64();\r\nstats->last_index = freq_table_get_index(stats, policy->cur);\r\npolicy->stats = stats;\r\nret = sysfs_create_group(&policy->kobj, &stats_attr_group);\r\nif (!ret)\r\nreturn;\r\npolicy->stats = NULL;\r\nkfree(stats->time_in_state);\r\nfree_stat:\r\nkfree(stats);\r\n}\r\nvoid cpufreq_stats_record_transition(struct cpufreq_policy *policy,\r\nunsigned int new_freq)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nint old_index, new_index;\r\nif (!stats) {\r\npr_debug("%s: No stats found\n", __func__);\r\nreturn;\r\n}\r\nold_index = stats->last_index;\r\nnew_index = freq_table_get_index(stats, new_freq);\r\nif (old_index == -1 || new_index == -1 || old_index == new_index)\r\nreturn;\r\ncpufreq_stats_update(stats);\r\nstats->last_index = new_index;\r\nstats->trans_table[old_index * stats->max_state + new_index]++;\r\nstats->total_trans++;\r\n}

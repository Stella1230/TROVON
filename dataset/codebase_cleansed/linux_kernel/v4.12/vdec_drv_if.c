int vdec_if_init(struct mtk_vcodec_ctx *ctx, unsigned int fourcc)\r\n{\r\nint ret = 0;\r\nswitch (fourcc) {\r\ncase V4L2_PIX_FMT_H264:\r\nctx->dec_if = get_h264_dec_comm_if();\r\nbreak;\r\ncase V4L2_PIX_FMT_VP8:\r\nctx->dec_if = get_vp8_dec_comm_if();\r\nbreak;\r\ncase V4L2_PIX_FMT_VP9:\r\nctx->dec_if = get_vp9_dec_comm_if();\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmtk_vdec_lock(ctx);\r\nmtk_vcodec_dec_clock_on(&ctx->dev->pm);\r\nret = ctx->dec_if->init(ctx, &ctx->drv_handle);\r\nmtk_vcodec_dec_clock_off(&ctx->dev->pm);\r\nmtk_vdec_unlock(ctx);\r\nreturn ret;\r\n}\r\nint vdec_if_decode(struct mtk_vcodec_ctx *ctx, struct mtk_vcodec_mem *bs,\r\nstruct vdec_fb *fb, bool *res_chg)\r\n{\r\nint ret = 0;\r\nif (bs) {\r\nif ((bs->dma_addr & 63) != 0) {\r\nmtk_v4l2_err("bs dma_addr should 64 byte align");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (fb) {\r\nif (((fb->base_y.dma_addr & 511) != 0) ||\r\n((fb->base_c.dma_addr & 511) != 0)) {\r\nmtk_v4l2_err("frame buffer dma_addr should 512 byte align");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (ctx->drv_handle == 0)\r\nreturn -EIO;\r\nmtk_vdec_lock(ctx);\r\nmtk_vcodec_set_curr_ctx(ctx->dev, ctx);\r\nmtk_vcodec_dec_clock_on(&ctx->dev->pm);\r\nenable_irq(ctx->dev->dec_irq);\r\nret = ctx->dec_if->decode(ctx->drv_handle, bs, fb, res_chg);\r\ndisable_irq(ctx->dev->dec_irq);\r\nmtk_vcodec_dec_clock_off(&ctx->dev->pm);\r\nmtk_vcodec_set_curr_ctx(ctx->dev, NULL);\r\nmtk_vdec_unlock(ctx);\r\nreturn ret;\r\n}\r\nint vdec_if_get_param(struct mtk_vcodec_ctx *ctx, enum vdec_get_param_type type,\r\nvoid *out)\r\n{\r\nint ret = 0;\r\nif (ctx->drv_handle == 0)\r\nreturn -EIO;\r\nmtk_vdec_lock(ctx);\r\nret = ctx->dec_if->get_param(ctx->drv_handle, type, out);\r\nmtk_vdec_unlock(ctx);\r\nreturn ret;\r\n}\r\nvoid vdec_if_deinit(struct mtk_vcodec_ctx *ctx)\r\n{\r\nif (ctx->drv_handle == 0)\r\nreturn;\r\nmtk_vdec_lock(ctx);\r\nmtk_vcodec_dec_clock_on(&ctx->dev->pm);\r\nctx->dec_if->deinit(ctx->drv_handle);\r\nmtk_vcodec_dec_clock_off(&ctx->dev->pm);\r\nmtk_vdec_unlock(ctx);\r\nctx->drv_handle = 0;\r\n}

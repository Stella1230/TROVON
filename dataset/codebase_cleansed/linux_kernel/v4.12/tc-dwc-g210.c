static int tc_dwc_g210_setup_40bit_rmmi(struct ufs_hba *hba)\r\n{\r\nconst struct ufshcd_dme_attr_val setup_attrs[] = {\r\n{ UIC_ARG_MIB(TX_GLOBALHIBERNATE), 0x00, DME_LOCAL },\r\n{ UIC_ARG_MIB(REFCLKMODE), 0x01, DME_LOCAL },\r\n{ UIC_ARG_MIB(CDIRECTCTRL6), 0x80, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBDIVFACTOR), 0x08, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBDCOCTRL5), 0x64, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBPRGTUNING), 0x09, DME_LOCAL },\r\n{ UIC_ARG_MIB(RTOBSERVESELECT), 0x00, DME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN0_TX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN0_TX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN0_TX), 0x14,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN0_RX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN0_RX), 4,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB(DIRECTCTRL10), 0x04, DME_LOCAL },\r\n{ UIC_ARG_MIB(DIRECTCTRL19), 0x02, DME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN0_RX), 0x03,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN0_RX), 0x16,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN0_RX), 0x42,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN0_RX), 0xa4,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN0_RX), 0x28,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN0_RX), 0x1E,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB(CBPRGPLL2), 0x00, DME_LOCAL },\r\n};\r\nreturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\r\nARRAY_SIZE(setup_attrs));\r\n}\r\nstatic int tc_dwc_g210_setup_20bit_rmmi_lane0(struct ufs_hba *hba)\r\n{\r\nconst struct ufshcd_dme_attr_val setup_attrs[] = {\r\n{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN0_TX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN0_TX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN0_RX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN0_TX), 0x12,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN0_RX), 2,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB(DIRECTCTRL10), 0x04, DME_LOCAL },\r\n{ UIC_ARG_MIB(DIRECTCTRL19), 0x02, DME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN0_RX), 0x03,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN0_RX), 0x16,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN0_RX), 0x42,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN0_RX), 0xa4,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN0_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN0_RX), 0x28,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN0_RX), 0x1E,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB(CBPRGPLL2), 0x00, DME_LOCAL },\r\n};\r\nreturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\r\nARRAY_SIZE(setup_attrs));\r\n}\r\nstatic int tc_dwc_g210_setup_20bit_rmmi_lane1(struct ufs_hba *hba)\r\n{\r\nint connected_rx_lanes = 0;\r\nint connected_tx_lanes = 0;\r\nint ret = 0;\r\nconst struct ufshcd_dme_attr_val setup_tx_attrs[] = {\r\n{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN1_TX), 0x0d,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN1_TX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN1_TX), 0x12,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\r\nDME_LOCAL },\r\n};\r\nconst struct ufshcd_dme_attr_val setup_rx_attrs[] = {\r\n{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN1_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN1_RX), 0x19,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN1_RX), 2,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN1_RX), 0x80,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN1_RX), 0x03,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN1_RX), 0x16,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN1_RX), 0x42,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN1_RX), 0xa4,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN1_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN1_RX), 0x01,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN1_RX), 0x28,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN1_RX), 0x1E,\r\nDME_LOCAL },\r\n{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN1_RX), 0x2f,\r\nDME_LOCAL },\r\n};\r\nufshcd_dme_get(hba, UIC_ARG_MIB(PA_AVAILRXDATALANES),\r\n&connected_rx_lanes);\r\nufshcd_dme_get(hba, UIC_ARG_MIB(PA_AVAILTXDATALANES),\r\n&connected_tx_lanes);\r\nif (connected_tx_lanes == 2) {\r\nret = ufshcd_dwc_dme_set_attrs(hba, setup_tx_attrs,\r\nARRAY_SIZE(setup_tx_attrs));\r\nif (ret)\r\ngoto out;\r\n}\r\nif (connected_rx_lanes == 2) {\r\nret = ufshcd_dwc_dme_set_attrs(hba, setup_rx_attrs,\r\nARRAY_SIZE(setup_rx_attrs));\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int tc_dwc_g210_setup_20bit_rmmi(struct ufs_hba *hba)\r\n{\r\nint ret = 0;\r\nconst struct ufshcd_dme_attr_val setup_attrs[] = {\r\n{ UIC_ARG_MIB(TX_GLOBALHIBERNATE), 0x00, DME_LOCAL },\r\n{ UIC_ARG_MIB(REFCLKMODE), 0x01, DME_LOCAL },\r\n{ UIC_ARG_MIB(CDIRECTCTRL6), 0xc0, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBDIVFACTOR), 0x44, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBDCOCTRL5), 0x64, DME_LOCAL },\r\n{ UIC_ARG_MIB(CBPRGTUNING), 0x09, DME_LOCAL },\r\n{ UIC_ARG_MIB(RTOBSERVESELECT), 0x00, DME_LOCAL },\r\n};\r\nret = ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\r\nARRAY_SIZE(setup_attrs));\r\nif (ret)\r\ngoto out;\r\nret = tc_dwc_g210_setup_20bit_rmmi_lane0(hba);\r\nif (ret)\r\ngoto out;\r\nret = tc_dwc_g210_setup_20bit_rmmi_lane1(hba);\r\nif (ret)\r\ngoto out;\r\nout:\r\nreturn ret;\r\n}\r\nint tc_dwc_g210_config_40_bit(struct ufs_hba *hba)\r\n{\r\nint ret = 0;\r\ndev_info(hba->dev, "Configuring Test Chip 40-bit RMMI\n");\r\nret = tc_dwc_g210_setup_40bit_rmmi(hba);\r\nif (ret) {\r\ndev_err(hba->dev, "Configuration failed\n");\r\ngoto out;\r\n}\r\nret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_MPHYCFGUPDT), 0x01);\r\nif (ret)\r\ngoto out;\r\nret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_DEBUGOMC), 0x01);\r\nout:\r\nreturn ret;\r\n}\r\nint tc_dwc_g210_config_20_bit(struct ufs_hba *hba)\r\n{\r\nint ret = 0;\r\ndev_info(hba->dev, "Configuring Test Chip 20-bit RMMI\n");\r\nret = tc_dwc_g210_setup_20bit_rmmi(hba);\r\nif (ret) {\r\ndev_err(hba->dev, "Configuration failed\n");\r\ngoto out;\r\n}\r\nret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_MPHYCFGUPDT), 0x01);\r\nif (ret)\r\ngoto out;\r\nret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_DEBUGOMC), 0x01);\r\nout:\r\nreturn ret;\r\n}

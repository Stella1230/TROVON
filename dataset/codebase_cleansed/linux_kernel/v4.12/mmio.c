int intel_vgpu_gpa_to_mmio_offset(struct intel_vgpu *vgpu, u64 gpa)\r\n{\r\nu64 gttmmio_gpa = *(u64 *)(vgpu_cfg_space(vgpu) + PCI_BASE_ADDRESS_0) &\r\n~GENMASK(3, 0);\r\nreturn gpa - gttmmio_gpa;\r\n}\r\nstatic void failsafe_emulate_mmio_rw(struct intel_vgpu *vgpu, uint64_t pa,\r\nvoid *p_data, unsigned int bytes, bool read)\r\n{\r\nstruct intel_gvt *gvt = NULL;\r\nvoid *pt = NULL;\r\nunsigned int offset = 0;\r\nif (!vgpu || !p_data)\r\nreturn;\r\ngvt = vgpu->gvt;\r\nmutex_lock(&gvt->lock);\r\noffset = intel_vgpu_gpa_to_mmio_offset(vgpu, pa);\r\nif (reg_is_mmio(gvt, offset)) {\r\nif (read)\r\nintel_vgpu_default_mmio_read(vgpu, offset, p_data,\r\nbytes);\r\nelse\r\nintel_vgpu_default_mmio_write(vgpu, offset, p_data,\r\nbytes);\r\n} else if (reg_is_gtt(gvt, offset) &&\r\nvgpu->gtt.ggtt_mm->virtual_page_table) {\r\noffset -= gvt->device_info.gtt_start_offset;\r\npt = vgpu->gtt.ggtt_mm->virtual_page_table + offset;\r\nif (read)\r\nmemcpy(p_data, pt, bytes);\r\nelse\r\nmemcpy(pt, p_data, bytes);\r\n} else if (atomic_read(&vgpu->gtt.n_write_protected_guest_page)) {\r\nstruct intel_vgpu_guest_page *gp;\r\ngp = intel_vgpu_find_guest_page(vgpu, pa >> PAGE_SHIFT);\r\nif (gp) {\r\nintel_vgpu_clean_guest_page(vgpu, gp);\r\nif (read)\r\nintel_gvt_hypervisor_read_gpa(vgpu, pa,\r\np_data, bytes);\r\nelse\r\nintel_gvt_hypervisor_write_gpa(vgpu, pa,\r\np_data, bytes);\r\n}\r\n}\r\nmutex_unlock(&gvt->lock);\r\n}\r\nint intel_vgpu_emulate_mmio_read(struct intel_vgpu *vgpu, uint64_t pa,\r\nvoid *p_data, unsigned int bytes)\r\n{\r\nstruct intel_gvt *gvt = vgpu->gvt;\r\nstruct intel_gvt_mmio_info *mmio;\r\nunsigned int offset = 0;\r\nint ret = -EINVAL;\r\nif (vgpu->failsafe) {\r\nfailsafe_emulate_mmio_rw(vgpu, pa, p_data, bytes, true);\r\nreturn 0;\r\n}\r\nmutex_lock(&gvt->lock);\r\nif (atomic_read(&vgpu->gtt.n_write_protected_guest_page)) {\r\nstruct intel_vgpu_guest_page *gp;\r\ngp = intel_vgpu_find_guest_page(vgpu, pa >> PAGE_SHIFT);\r\nif (gp) {\r\nret = intel_gvt_hypervisor_read_gpa(vgpu, pa,\r\np_data, bytes);\r\nif (ret) {\r\ngvt_vgpu_err("guest page read error %d, "\r\n"gfn 0x%lx, pa 0x%llx, var 0x%x, len %d\n",\r\nret, gp->gfn, pa, *(u32 *)p_data,\r\nbytes);\r\n}\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\n}\r\noffset = intel_vgpu_gpa_to_mmio_offset(vgpu, pa);\r\nif (WARN_ON(bytes > 8))\r\ngoto err;\r\nif (reg_is_gtt(gvt, offset)) {\r\nif (WARN_ON(!IS_ALIGNED(offset, 4) && !IS_ALIGNED(offset, 8)))\r\ngoto err;\r\nif (WARN_ON(bytes != 4 && bytes != 8))\r\ngoto err;\r\nif (WARN_ON(!reg_is_gtt(gvt, offset + bytes - 1)))\r\ngoto err;\r\nret = intel_vgpu_emulate_gtt_mmio_read(vgpu, offset,\r\np_data, bytes);\r\nif (ret)\r\ngoto err;\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nif (WARN_ON_ONCE(!reg_is_mmio(gvt, offset))) {\r\nret = intel_gvt_hypervisor_read_gpa(vgpu, pa, p_data, bytes);\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nif (WARN_ON(!reg_is_mmio(gvt, offset + bytes - 1)))\r\ngoto err;\r\nif (!intel_gvt_mmio_is_unalign(gvt, offset)) {\r\nif (WARN_ON(!IS_ALIGNED(offset, bytes)))\r\ngoto err;\r\n}\r\nmmio = intel_gvt_find_mmio_info(gvt, rounddown(offset, 4));\r\nif (mmio) {\r\nif (!intel_gvt_mmio_is_unalign(gvt, mmio->offset)) {\r\nif (WARN_ON(offset + bytes > mmio->offset + mmio->size))\r\ngoto err;\r\nif (WARN_ON(mmio->offset != offset))\r\ngoto err;\r\n}\r\nret = mmio->read(vgpu, offset, p_data, bytes);\r\n} else {\r\nret = intel_vgpu_default_mmio_read(vgpu, offset, p_data, bytes);\r\nif (!vgpu->mmio.disable_warn_untrack) {\r\ngvt_vgpu_err("read untracked MMIO %x(%dB) val %x\n",\r\noffset, bytes, *(u32 *)p_data);\r\nif (offset == 0x206c) {\r\ngvt_vgpu_err("------------------------------------------\n");\r\ngvt_vgpu_err("likely triggers a gfx reset\n");\r\ngvt_vgpu_err("------------------------------------------\n");\r\nvgpu->mmio.disable_warn_untrack = true;\r\n}\r\n}\r\n}\r\nif (ret)\r\ngoto err;\r\nintel_gvt_mmio_set_accessed(gvt, offset);\r\nmutex_unlock(&gvt->lock);\r\nreturn 0;\r\nerr:\r\ngvt_vgpu_err("fail to emulate MMIO read %08x len %d\n",\r\noffset, bytes);\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nint intel_vgpu_emulate_mmio_write(struct intel_vgpu *vgpu, uint64_t pa,\r\nvoid *p_data, unsigned int bytes)\r\n{\r\nstruct intel_gvt *gvt = vgpu->gvt;\r\nstruct intel_gvt_mmio_info *mmio;\r\nunsigned int offset = 0;\r\nu32 old_vreg = 0, old_sreg = 0;\r\nint ret = -EINVAL;\r\nif (vgpu->failsafe) {\r\nfailsafe_emulate_mmio_rw(vgpu, pa, p_data, bytes, false);\r\nreturn 0;\r\n}\r\nmutex_lock(&gvt->lock);\r\nif (atomic_read(&vgpu->gtt.n_write_protected_guest_page)) {\r\nstruct intel_vgpu_guest_page *gp;\r\ngp = intel_vgpu_find_guest_page(vgpu, pa >> PAGE_SHIFT);\r\nif (gp) {\r\nret = gp->handler(gp, pa, p_data, bytes);\r\nif (ret) {\r\ngvt_err("guest page write error %d, "\r\n"gfn 0x%lx, pa 0x%llx, "\r\n"var 0x%x, len %d\n",\r\nret, gp->gfn, pa,\r\n*(u32 *)p_data, bytes);\r\n}\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\n}\r\noffset = intel_vgpu_gpa_to_mmio_offset(vgpu, pa);\r\nif (WARN_ON(bytes > 8))\r\ngoto err;\r\nif (reg_is_gtt(gvt, offset)) {\r\nif (WARN_ON(!IS_ALIGNED(offset, 4) && !IS_ALIGNED(offset, 8)))\r\ngoto err;\r\nif (WARN_ON(bytes != 4 && bytes != 8))\r\ngoto err;\r\nif (WARN_ON(!reg_is_gtt(gvt, offset + bytes - 1)))\r\ngoto err;\r\nret = intel_vgpu_emulate_gtt_mmio_write(vgpu, offset,\r\np_data, bytes);\r\nif (ret)\r\ngoto err;\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nif (WARN_ON_ONCE(!reg_is_mmio(gvt, offset))) {\r\nret = intel_gvt_hypervisor_write_gpa(vgpu, pa, p_data, bytes);\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nmmio = intel_gvt_find_mmio_info(gvt, rounddown(offset, 4));\r\nif (!mmio && !vgpu->mmio.disable_warn_untrack)\r\ngvt_dbg_mmio("vgpu%d: write untracked MMIO %x len %d val %x\n",\r\nvgpu->id, offset, bytes, *(u32 *)p_data);\r\nif (!intel_gvt_mmio_is_unalign(gvt, offset)) {\r\nif (WARN_ON(!IS_ALIGNED(offset, bytes)))\r\ngoto err;\r\n}\r\nif (mmio) {\r\nu64 ro_mask = mmio->ro_mask;\r\nif (!intel_gvt_mmio_is_unalign(gvt, mmio->offset)) {\r\nif (WARN_ON(offset + bytes > mmio->offset + mmio->size))\r\ngoto err;\r\nif (WARN_ON(mmio->offset != offset))\r\ngoto err;\r\n}\r\nif (intel_gvt_mmio_has_mode_mask(gvt, mmio->offset)) {\r\nold_vreg = vgpu_vreg(vgpu, offset);\r\nold_sreg = vgpu_sreg(vgpu, offset);\r\n}\r\nif (!ro_mask) {\r\nret = mmio->write(vgpu, offset, p_data, bytes);\r\n} else {\r\nu64 data = 0;\r\nif (ro_mask == ~(u64)0) {\r\ngvt_vgpu_err("try to write RO reg %x\n",\r\noffset);\r\nret = 0;\r\ngoto out;\r\n}\r\nmemcpy(&data, p_data, bytes);\r\ndata &= ~mmio->ro_mask;\r\ndata |= vgpu_vreg(vgpu, offset) & mmio->ro_mask;\r\nret = mmio->write(vgpu, offset, &data, bytes);\r\n}\r\nif (intel_gvt_mmio_has_mode_mask(gvt, mmio->offset)) {\r\nu32 mask = vgpu_vreg(vgpu, offset) >> 16;\r\nvgpu_vreg(vgpu, offset) = (old_vreg & ~mask)\r\n| (vgpu_vreg(vgpu, offset) & mask);\r\nvgpu_sreg(vgpu, offset) = (old_sreg & ~mask)\r\n| (vgpu_sreg(vgpu, offset) & mask);\r\n}\r\n} else\r\nret = intel_vgpu_default_mmio_write(vgpu, offset, p_data,\r\nbytes);\r\nif (ret)\r\ngoto err;\r\nout:\r\nintel_gvt_mmio_set_accessed(gvt, offset);\r\nmutex_unlock(&gvt->lock);\r\nreturn 0;\r\nerr:\r\ngvt_vgpu_err("fail to emulate MMIO write %08x len %d\n", offset,\r\nbytes);\r\nmutex_unlock(&gvt->lock);\r\nreturn ret;\r\n}\r\nvoid intel_vgpu_reset_mmio(struct intel_vgpu *vgpu)\r\n{\r\nstruct intel_gvt *gvt = vgpu->gvt;\r\nconst struct intel_gvt_device_info *info = &gvt->device_info;\r\nmemcpy(vgpu->mmio.vreg, gvt->firmware.mmio, info->mmio_size);\r\nmemcpy(vgpu->mmio.sreg, gvt->firmware.mmio, info->mmio_size);\r\nvgpu_vreg(vgpu, GEN6_GT_THREAD_STATUS_REG) = 0;\r\nvgpu_vreg(vgpu, GEN6_GT_CORE_STATUS) = 0;\r\nvgpu->mmio.disable_warn_untrack = false;\r\n}\r\nint intel_vgpu_init_mmio(struct intel_vgpu *vgpu)\r\n{\r\nconst struct intel_gvt_device_info *info = &vgpu->gvt->device_info;\r\nvgpu->mmio.vreg = vzalloc(info->mmio_size * 2);\r\nif (!vgpu->mmio.vreg)\r\nreturn -ENOMEM;\r\nvgpu->mmio.sreg = vgpu->mmio.vreg + info->mmio_size;\r\nintel_vgpu_reset_mmio(vgpu);\r\nreturn 0;\r\n}\r\nvoid intel_vgpu_clean_mmio(struct intel_vgpu *vgpu)\r\n{\r\nvfree(vgpu->mmio.vreg);\r\nvgpu->mmio.vreg = vgpu->mmio.sreg = NULL;\r\n}

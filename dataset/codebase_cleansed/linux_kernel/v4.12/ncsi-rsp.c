static int ncsi_validate_rsp_pkt(struct ncsi_request *nr,\r\nunsigned short payload)\r\n{\r\nstruct ncsi_rsp_pkt_hdr *h;\r\nu32 checksum;\r\n__be32 *pchecksum;\r\nh = (struct ncsi_rsp_pkt_hdr *)skb_network_header(nr->rsp);\r\nif (h->common.revision != NCSI_PKT_REVISION)\r\nreturn -EINVAL;\r\nif (ntohs(h->common.length) != payload)\r\nreturn -EINVAL;\r\nif (ntohs(h->code) != NCSI_PKT_RSP_C_COMPLETED ||\r\nntohs(h->reason) != NCSI_PKT_RSP_R_NO_ERROR)\r\nreturn -EINVAL;\r\npchecksum = (__be32 *)((void *)(h + 1) + payload - 4);\r\nif (ntohl(*pchecksum) == 0)\r\nreturn 0;\r\nchecksum = ncsi_calculate_checksum((unsigned char *)h,\r\nsizeof(*h) + payload - 4);\r\nif (*pchecksum != htonl(checksum))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_cis(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_package *np;\r\nstruct ncsi_channel *nc;\r\nunsigned char id;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel, &np, &nc);\r\nif (!nc) {\r\nif (ndp->flags & NCSI_DEV_PROBED)\r\nreturn -ENXIO;\r\nid = NCSI_CHANNEL_INDEX(rsp->rsp.common.channel);\r\nnc = ncsi_add_channel(np, id);\r\n}\r\nreturn nc ? 0 : -ENODEV;\r\n}\r\nstatic int ncsi_rsp_handler_sp(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_package *np;\r\nunsigned char id;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\n&np, NULL);\r\nif (!np) {\r\nif (ndp->flags & NCSI_DEV_PROBED)\r\nreturn -ENXIO;\r\nid = NCSI_PACKAGE_INDEX(rsp->rsp.common.channel);\r\nnp = ncsi_add_package(ndp, id);\r\nif (!np)\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dp(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_package *np;\r\nstruct ncsi_channel *nc;\r\nunsigned long flags;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\n&np, NULL);\r\nif (!np)\r\nreturn -ENODEV;\r\nNCSI_FOR_EACH_CHANNEL(np, nc) {\r\nspin_lock_irqsave(&nc->lock, flags);\r\nnc->state = NCSI_CHANNEL_INACTIVE;\r\nspin_unlock_irqrestore(&nc->lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_ec(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_ENABLE];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 1;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dc(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nint ret;\r\nret = ncsi_validate_rsp_pkt(nr, 4);\r\nif (ret)\r\nreturn ret;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_ENABLE];\r\nif (!ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 0;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_rc(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nunsigned long flags;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nspin_lock_irqsave(&nc->lock, flags);\r\nnc->state = NCSI_CHANNEL_INACTIVE;\r\nspin_unlock_irqrestore(&nc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_ecnt(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_TX_ENABLE];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 1;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dcnt(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_TX_ENABLE];\r\nif (!ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 1;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_ae(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_ae_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_AEN];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\ncmd = (struct ncsi_cmd_ae_pkt *)skb_network_header(nr->cmd);\r\nncm->enable = 1;\r\nncm->data[0] = cmd->mc_id;\r\nncm->data[1] = ntohl(cmd->mode);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_sl(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_sl_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\ncmd = (struct ncsi_cmd_sl_pkt *)skb_network_header(nr->cmd);\r\nncm = &nc->modes[NCSI_MODE_LINK];\r\nncm->data[0] = ntohl(cmd->mode);\r\nncm->data[1] = ntohl(cmd->oem_mode);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gls(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gls_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nunsigned long flags;\r\nrsp = (struct ncsi_rsp_gls_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_LINK];\r\nncm->data[2] = ntohl(rsp->status);\r\nncm->data[3] = ntohl(rsp->other);\r\nncm->data[4] = ntohl(rsp->oem_status);\r\nif (nr->flags & NCSI_REQ_FLAG_EVENT_DRIVEN)\r\nreturn 0;\r\nspin_lock_irqsave(&nc->lock, flags);\r\nnc->monitor.state = NCSI_CHANNEL_MONITOR_START;\r\nspin_unlock_irqrestore(&nc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_svf(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_svf_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_filter *ncf;\r\nunsigned short vlan;\r\nint ret;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\ncmd = (struct ncsi_cmd_svf_pkt *)skb_network_header(nr->cmd);\r\nncf = nc->filters[NCSI_FILTER_VLAN];\r\nif (!ncf)\r\nreturn -ENOENT;\r\nif (cmd->index >= ncf->total)\r\nreturn -ERANGE;\r\nif (!(cmd->enable & 0x1)) {\r\nret = ncsi_remove_filter(nc, NCSI_FILTER_VLAN, cmd->index);\r\n} else {\r\nvlan = ntohs(cmd->vlan);\r\nret = ncsi_add_filter(nc, NCSI_FILTER_VLAN, &vlan);\r\n}\r\nreturn ret;\r\n}\r\nstatic int ncsi_rsp_handler_ev(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_ev_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_VLAN];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\ncmd = (struct ncsi_cmd_ev_pkt *)skb_network_header(nr->cmd);\r\nncm->enable = 1;\r\nncm->data[0] = ntohl(cmd->mode);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dv(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_VLAN];\r\nif (!ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 0;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_sma(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_sma_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_filter *ncf;\r\nvoid *bitmap;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\ncmd = (struct ncsi_cmd_sma_pkt *)skb_network_header(nr->cmd);\r\nswitch (cmd->at_e >> 5) {\r\ncase 0x0:\r\nncf = nc->filters[NCSI_FILTER_UC];\r\nbreak;\r\ncase 0x1:\r\nncf = nc->filters[NCSI_FILTER_MC];\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (!ncf)\r\nreturn -ENOENT;\r\nelse if (cmd->index >= ncf->total)\r\nreturn -ERANGE;\r\nbitmap = &ncf->bitmap;\r\nif (cmd->at_e & 0x1) {\r\nif (test_and_set_bit(cmd->index, bitmap))\r\nreturn -EBUSY;\r\nmemcpy(ncf->data + 6 * cmd->index, cmd->mac, 6);\r\n} else {\r\nif (!test_and_clear_bit(cmd->index, bitmap))\r\nreturn -EBUSY;\r\nmemset(ncf->data + 6 * cmd->index, 0, 6);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_ebf(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_ebf_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel, NULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_BC];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\ncmd = (struct ncsi_cmd_ebf_pkt *)skb_network_header(nr->cmd);\r\nncm->enable = 1;\r\nncm->data[0] = ntohl(cmd->mode);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dbf(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_BC];\r\nif (!ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 0;\r\nncm->data[0] = 0;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_egmf(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_egmf_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_MC];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\ncmd = (struct ncsi_cmd_egmf_pkt *)skb_network_header(nr->cmd);\r\nncm->enable = 1;\r\nncm->data[0] = ntohl(cmd->mode);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_dgmf(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_MC];\r\nif (!ncm->enable)\r\nreturn -EBUSY;\r\nncm->enable = 0;\r\nncm->data[0] = 0;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_snfc(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_cmd_snfc_pkt *cmd;\r\nstruct ncsi_rsp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_mode *ncm;\r\nrsp = (struct ncsi_rsp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncm = &nc->modes[NCSI_MODE_FC];\r\nif (ncm->enable)\r\nreturn -EBUSY;\r\ncmd = (struct ncsi_cmd_snfc_pkt *)skb_network_header(nr->cmd);\r\nncm->enable = 1;\r\nncm->data[0] = cmd->mode;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gvi(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gvi_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_version *ncv;\r\nint i;\r\nrsp = (struct ncsi_rsp_gvi_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncv = &nc->version;\r\nncv->version = ntohl(rsp->ncsi_version);\r\nncv->alpha2 = rsp->alpha2;\r\nmemcpy(ncv->fw_name, rsp->fw_name, 12);\r\nncv->fw_version = ntohl(rsp->fw_version);\r\nfor (i = 0; i < ARRAY_SIZE(ncv->pci_ids); i++)\r\nncv->pci_ids[i] = ntohs(rsp->pci_ids[i]);\r\nncv->mf_id = ntohl(rsp->mf_id);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gc(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gc_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_filter *ncf;\r\nsize_t size, entry_size;\r\nint cnt, i;\r\nrsp = (struct ncsi_rsp_gc_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nnc->caps[NCSI_CAP_GENERIC].cap = ntohl(rsp->cap) &\r\nNCSI_CAP_GENERIC_MASK;\r\nnc->caps[NCSI_CAP_BC].cap = ntohl(rsp->bc_cap) &\r\nNCSI_CAP_BC_MASK;\r\nnc->caps[NCSI_CAP_MC].cap = ntohl(rsp->mc_cap) &\r\nNCSI_CAP_MC_MASK;\r\nnc->caps[NCSI_CAP_BUFFER].cap = ntohl(rsp->buf_cap);\r\nnc->caps[NCSI_CAP_AEN].cap = ntohl(rsp->aen_cap) &\r\nNCSI_CAP_AEN_MASK;\r\nnc->caps[NCSI_CAP_VLAN].cap = rsp->vlan_mode &\r\nNCSI_CAP_VLAN_MASK;\r\nfor (i = 0; i < NCSI_FILTER_MAX; i++) {\r\nswitch (i) {\r\ncase NCSI_FILTER_VLAN:\r\ncnt = rsp->vlan_cnt;\r\nentry_size = 2;\r\nbreak;\r\ncase NCSI_FILTER_MIXED:\r\ncnt = rsp->mixed_cnt;\r\nentry_size = 6;\r\nbreak;\r\ncase NCSI_FILTER_MC:\r\ncnt = rsp->mc_cnt;\r\nentry_size = 6;\r\nbreak;\r\ncase NCSI_FILTER_UC:\r\ncnt = rsp->uc_cnt;\r\nentry_size = 6;\r\nbreak;\r\ndefault:\r\ncontinue;\r\n}\r\nif (!cnt || nc->filters[i])\r\ncontinue;\r\nsize = sizeof(*ncf) + cnt * entry_size;\r\nncf = kzalloc(size, GFP_ATOMIC);\r\nif (!ncf) {\r\npr_warn("%s: Cannot alloc filter table (%d)\n",\r\n__func__, i);\r\nreturn -ENOMEM;\r\n}\r\nncf->index = i;\r\nncf->total = cnt;\r\nncf->bitmap = 0x0ul;\r\nnc->filters[i] = ncf;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gp(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gp_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nunsigned short enable, vlan;\r\nunsigned char *pdata;\r\nint table, i;\r\nrsp = (struct ncsi_rsp_gp_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nif (ntohl(rsp->valid_modes) & 0x1) {\r\nnc->modes[NCSI_MODE_BC].enable = 1;\r\nnc->modes[NCSI_MODE_BC].data[0] = ntohl(rsp->bc_mode);\r\n}\r\nif (ntohl(rsp->valid_modes) & 0x2)\r\nnc->modes[NCSI_MODE_ENABLE].enable = 1;\r\nif (ntohl(rsp->valid_modes) & 0x4)\r\nnc->modes[NCSI_MODE_TX_ENABLE].enable = 1;\r\nif (ntohl(rsp->valid_modes) & 0x8)\r\nnc->modes[NCSI_MODE_MC].enable = 1;\r\nnc->modes[NCSI_MODE_LINK].enable = 1;\r\nnc->modes[NCSI_MODE_LINK].data[0] = ntohl(rsp->link_mode);\r\nnc->modes[NCSI_MODE_VLAN].enable = 1;\r\nnc->modes[NCSI_MODE_VLAN].data[0] = rsp->vlan_mode;\r\nnc->modes[NCSI_MODE_FC].enable = 1;\r\nnc->modes[NCSI_MODE_FC].data[0] = rsp->fc_mode;\r\nnc->modes[NCSI_MODE_AEN].enable = 1;\r\nnc->modes[NCSI_MODE_AEN].data[0] = ntohl(rsp->aen_mode);\r\npdata = (unsigned char *)rsp + 48;\r\nenable = rsp->mac_enable;\r\nfor (i = 0; i < rsp->mac_cnt; i++, pdata += 6) {\r\nif (i >= (nc->filters[NCSI_FILTER_UC]->total +\r\nnc->filters[NCSI_FILTER_MC]->total))\r\ntable = NCSI_FILTER_MIXED;\r\nelse if (i >= nc->filters[NCSI_FILTER_UC]->total)\r\ntable = NCSI_FILTER_MC;\r\nelse\r\ntable = NCSI_FILTER_UC;\r\nif (!(enable & (0x1 << i)))\r\ncontinue;\r\nif (ncsi_find_filter(nc, table, pdata) >= 0)\r\ncontinue;\r\nncsi_add_filter(nc, table, pdata);\r\n}\r\nenable = ntohs(rsp->vlan_enable);\r\nfor (i = 0; i < rsp->vlan_cnt; i++, pdata += 2) {\r\nif (!(enable & (0x1 << i)))\r\ncontinue;\r\nvlan = ntohs(*(__be16 *)pdata);\r\nif (ncsi_find_filter(nc, NCSI_FILTER_VLAN, &vlan) >= 0)\r\ncontinue;\r\nncsi_add_filter(nc, NCSI_FILTER_VLAN, &vlan);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gcps(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gcps_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_stats *ncs;\r\nrsp = (struct ncsi_rsp_gcps_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncs = &nc->stats;\r\nncs->hnc_cnt_hi = ntohl(rsp->cnt_hi);\r\nncs->hnc_cnt_lo = ntohl(rsp->cnt_lo);\r\nncs->hnc_rx_bytes = ntohl(rsp->rx_bytes);\r\nncs->hnc_tx_bytes = ntohl(rsp->tx_bytes);\r\nncs->hnc_rx_uc_pkts = ntohl(rsp->rx_uc_pkts);\r\nncs->hnc_rx_mc_pkts = ntohl(rsp->rx_mc_pkts);\r\nncs->hnc_rx_bc_pkts = ntohl(rsp->rx_bc_pkts);\r\nncs->hnc_tx_uc_pkts = ntohl(rsp->tx_uc_pkts);\r\nncs->hnc_tx_mc_pkts = ntohl(rsp->tx_mc_pkts);\r\nncs->hnc_tx_bc_pkts = ntohl(rsp->tx_bc_pkts);\r\nncs->hnc_fcs_err = ntohl(rsp->fcs_err);\r\nncs->hnc_align_err = ntohl(rsp->align_err);\r\nncs->hnc_false_carrier = ntohl(rsp->false_carrier);\r\nncs->hnc_runt_pkts = ntohl(rsp->runt_pkts);\r\nncs->hnc_jabber_pkts = ntohl(rsp->jabber_pkts);\r\nncs->hnc_rx_pause_xon = ntohl(rsp->rx_pause_xon);\r\nncs->hnc_rx_pause_xoff = ntohl(rsp->rx_pause_xoff);\r\nncs->hnc_tx_pause_xon = ntohl(rsp->tx_pause_xon);\r\nncs->hnc_tx_pause_xoff = ntohl(rsp->tx_pause_xoff);\r\nncs->hnc_tx_s_collision = ntohl(rsp->tx_s_collision);\r\nncs->hnc_tx_m_collision = ntohl(rsp->tx_m_collision);\r\nncs->hnc_l_collision = ntohl(rsp->l_collision);\r\nncs->hnc_e_collision = ntohl(rsp->e_collision);\r\nncs->hnc_rx_ctl_frames = ntohl(rsp->rx_ctl_frames);\r\nncs->hnc_rx_64_frames = ntohl(rsp->rx_64_frames);\r\nncs->hnc_rx_127_frames = ntohl(rsp->rx_127_frames);\r\nncs->hnc_rx_255_frames = ntohl(rsp->rx_255_frames);\r\nncs->hnc_rx_511_frames = ntohl(rsp->rx_511_frames);\r\nncs->hnc_rx_1023_frames = ntohl(rsp->rx_1023_frames);\r\nncs->hnc_rx_1522_frames = ntohl(rsp->rx_1522_frames);\r\nncs->hnc_rx_9022_frames = ntohl(rsp->rx_9022_frames);\r\nncs->hnc_tx_64_frames = ntohl(rsp->tx_64_frames);\r\nncs->hnc_tx_127_frames = ntohl(rsp->tx_127_frames);\r\nncs->hnc_tx_255_frames = ntohl(rsp->tx_255_frames);\r\nncs->hnc_tx_511_frames = ntohl(rsp->tx_511_frames);\r\nncs->hnc_tx_1023_frames = ntohl(rsp->tx_1023_frames);\r\nncs->hnc_tx_1522_frames = ntohl(rsp->tx_1522_frames);\r\nncs->hnc_tx_9022_frames = ntohl(rsp->tx_9022_frames);\r\nncs->hnc_rx_valid_bytes = ntohl(rsp->rx_valid_bytes);\r\nncs->hnc_rx_runt_pkts = ntohl(rsp->rx_runt_pkts);\r\nncs->hnc_rx_jabber_pkts = ntohl(rsp->rx_jabber_pkts);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gns(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gns_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_stats *ncs;\r\nrsp = (struct ncsi_rsp_gns_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncs = &nc->stats;\r\nncs->ncsi_rx_cmds = ntohl(rsp->rx_cmds);\r\nncs->ncsi_dropped_cmds = ntohl(rsp->dropped_cmds);\r\nncs->ncsi_cmd_type_errs = ntohl(rsp->cmd_type_errs);\r\nncs->ncsi_cmd_csum_errs = ntohl(rsp->cmd_csum_errs);\r\nncs->ncsi_rx_pkts = ntohl(rsp->rx_pkts);\r\nncs->ncsi_tx_pkts = ntohl(rsp->tx_pkts);\r\nncs->ncsi_tx_aen_pkts = ntohl(rsp->tx_aen_pkts);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gnpts(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gnpts_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_channel *nc;\r\nstruct ncsi_channel_stats *ncs;\r\nrsp = (struct ncsi_rsp_gnpts_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\nNULL, &nc);\r\nif (!nc)\r\nreturn -ENODEV;\r\nncs = &nc->stats;\r\nncs->pt_tx_pkts = ntohl(rsp->tx_pkts);\r\nncs->pt_tx_dropped = ntohl(rsp->tx_dropped);\r\nncs->pt_tx_channel_err = ntohl(rsp->tx_channel_err);\r\nncs->pt_tx_us_err = ntohl(rsp->tx_us_err);\r\nncs->pt_rx_pkts = ntohl(rsp->rx_pkts);\r\nncs->pt_rx_dropped = ntohl(rsp->rx_dropped);\r\nncs->pt_rx_channel_err = ntohl(rsp->rx_channel_err);\r\nncs->pt_rx_us_err = ntohl(rsp->rx_us_err);\r\nncs->pt_rx_os_err = ntohl(rsp->rx_os_err);\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gps(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gps_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_package *np;\r\nrsp = (struct ncsi_rsp_gps_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\n&np, NULL);\r\nif (!np)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int ncsi_rsp_handler_gpuuid(struct ncsi_request *nr)\r\n{\r\nstruct ncsi_rsp_gpuuid_pkt *rsp;\r\nstruct ncsi_dev_priv *ndp = nr->ndp;\r\nstruct ncsi_package *np;\r\nrsp = (struct ncsi_rsp_gpuuid_pkt *)skb_network_header(nr->rsp);\r\nncsi_find_package_and_channel(ndp, rsp->rsp.common.channel,\r\n&np, NULL);\r\nif (!np)\r\nreturn -ENODEV;\r\nmemcpy(np->uuid, rsp->uuid, sizeof(rsp->uuid));\r\nreturn 0;\r\n}\r\nint ncsi_rcv_rsp(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct ncsi_rsp_handler *nrh = NULL;\r\nstruct ncsi_dev *nd;\r\nstruct ncsi_dev_priv *ndp;\r\nstruct ncsi_request *nr;\r\nstruct ncsi_pkt_hdr *hdr;\r\nunsigned long flags;\r\nint payload, i, ret;\r\nnd = ncsi_find_dev(dev);\r\nndp = nd ? TO_NCSI_DEV_PRIV(nd) : NULL;\r\nif (!ndp)\r\nreturn -ENODEV;\r\nhdr = (struct ncsi_pkt_hdr *)skb_network_header(skb);\r\nif (hdr->type == NCSI_PKT_AEN)\r\nreturn ncsi_aen_handler(ndp, skb);\r\nfor (i = 0; i < ARRAY_SIZE(ncsi_rsp_handlers); i++) {\r\nif (ncsi_rsp_handlers[i].type == hdr->type) {\r\nif (ncsi_rsp_handlers[i].handler)\r\nnrh = &ncsi_rsp_handlers[i];\r\nelse\r\nnrh = NULL;\r\nbreak;\r\n}\r\n}\r\nif (!nrh) {\r\nnetdev_err(nd->dev, "Received unrecognized packet (0x%x)\n",\r\nhdr->type);\r\nreturn -ENOENT;\r\n}\r\nspin_lock_irqsave(&ndp->lock, flags);\r\nnr = &ndp->requests[hdr->id];\r\nif (!nr->used) {\r\nspin_unlock_irqrestore(&ndp->lock, flags);\r\nreturn -ENODEV;\r\n}\r\nnr->rsp = skb;\r\nif (!nr->enabled) {\r\nspin_unlock_irqrestore(&ndp->lock, flags);\r\nret = -ENOENT;\r\ngoto out;\r\n}\r\nspin_unlock_irqrestore(&ndp->lock, flags);\r\npayload = nrh->payload;\r\nif (payload < 0)\r\npayload = ntohs(hdr->length);\r\nret = ncsi_validate_rsp_pkt(nr, payload);\r\nif (ret)\r\ngoto out;\r\nret = nrh->handler(nr);\r\nout:\r\nncsi_free_request(nr);\r\nreturn ret;\r\n}

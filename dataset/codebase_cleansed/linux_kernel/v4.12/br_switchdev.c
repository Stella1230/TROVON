static int br_switchdev_mark_get(struct net_bridge *br, struct net_device *dev)\r\n{\r\nstruct net_bridge_port *p;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (switchdev_port_same_parent_id(dev, p->dev))\r\nreturn p->offload_fwd_mark;\r\n}\r\nreturn ++br->offload_fwd_mark;\r\n}\r\nint nbp_switchdev_mark_set(struct net_bridge_port *p)\r\n{\r\nstruct switchdev_attr attr = {\r\n.orig_dev = p->dev,\r\n.id = SWITCHDEV_ATTR_ID_PORT_PARENT_ID,\r\n};\r\nint err;\r\nASSERT_RTNL();\r\nerr = switchdev_port_attr_get(p->dev, &attr);\r\nif (err) {\r\nif (err == -EOPNOTSUPP)\r\nreturn 0;\r\nreturn err;\r\n}\r\np->offload_fwd_mark = br_switchdev_mark_get(p->br, p->dev);\r\nreturn 0;\r\n}\r\nvoid nbp_switchdev_frame_mark(const struct net_bridge_port *p,\r\nstruct sk_buff *skb)\r\n{\r\nif (skb->offload_fwd_mark && !WARN_ON_ONCE(!p->offload_fwd_mark))\r\nBR_INPUT_SKB_CB(skb)->offload_fwd_mark = p->offload_fwd_mark;\r\n}\r\nbool nbp_switchdev_allowed_egress(const struct net_bridge_port *p,\r\nconst struct sk_buff *skb)\r\n{\r\nreturn !skb->offload_fwd_mark ||\r\nBR_INPUT_SKB_CB(skb)->offload_fwd_mark != p->offload_fwd_mark;\r\n}

u16\r\nmxm_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr)\r\n{\r\nstruct nvkm_subdev *subdev = &bios->subdev;\r\nstruct bit_entry x;\r\nif (bit_entry(bios, 'x', &x)) {\r\nnvkm_debug(subdev, "BIT 'x' table not present\n");\r\nreturn 0x0000;\r\n}\r\n*ver = x.version;\r\n*hdr = x.length;\r\nif (*ver != 1 || *hdr < 3) {\r\nnvkm_warn(subdev, "BIT 'x' table %d/%d unknown\n", *ver, *hdr);\r\nreturn 0x0000;\r\n}\r\nreturn x.offset;\r\n}\r\nu8\r\nmxm_sor_map(struct nvkm_bios *bios, u8 conn)\r\n{\r\nstruct nvkm_subdev *subdev = &bios->subdev;\r\nu8 ver, hdr;\r\nu16 mxm = mxm_table(bios, &ver, &hdr);\r\nif (mxm && hdr >= 6) {\r\nu16 map = nvbios_rd16(bios, mxm + 4);\r\nif (map) {\r\nver = nvbios_rd08(bios, map);\r\nif (ver == 0x10 || ver == 0x11) {\r\nif (conn < nvbios_rd08(bios, map + 3)) {\r\nmap += nvbios_rd08(bios, map + 1);\r\nmap += conn;\r\nreturn nvbios_rd08(bios, map);\r\n}\r\nreturn 0x00;\r\n}\r\nnvkm_warn(subdev, "unknown sor map v%02x\n", ver);\r\n}\r\n}\r\nif (bios->version.chip == 0x84 || bios->version.chip == 0x86)\r\nreturn g84_sor_map[conn];\r\nif (bios->version.chip == 0x92)\r\nreturn g92_sor_map[conn];\r\nif (bios->version.chip == 0x94 || bios->version.chip == 0x96)\r\nreturn g94_sor_map[conn];\r\nif (bios->version.chip == 0x98)\r\nreturn g98_sor_map[conn];\r\nnvkm_warn(subdev, "missing sor map\n");\r\nreturn 0x00;\r\n}\r\nu8\r\nmxm_ddc_map(struct nvkm_bios *bios, u8 port)\r\n{\r\nstruct nvkm_subdev *subdev = &bios->subdev;\r\nu8 ver, hdr;\r\nu16 mxm = mxm_table(bios, &ver, &hdr);\r\nif (mxm && hdr >= 8) {\r\nu16 map = nvbios_rd16(bios, mxm + 6);\r\nif (map) {\r\nver = nvbios_rd08(bios, map);\r\nif (ver == 0x10) {\r\nif (port < nvbios_rd08(bios, map + 3)) {\r\nmap += nvbios_rd08(bios, map + 1);\r\nmap += port;\r\nreturn nvbios_rd08(bios, map);\r\n}\r\nreturn 0x00;\r\n}\r\nnvkm_warn(subdev, "unknown ddc map v%02x\n", ver);\r\n}\r\n}\r\nreturn (port << 4) | port;\r\n}

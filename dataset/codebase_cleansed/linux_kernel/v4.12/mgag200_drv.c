static void mgag200_kick_out_firmware_fb(struct pci_dev *pdev)\r\n{\r\nstruct apertures_struct *ap;\r\nbool primary = false;\r\nap = alloc_apertures(1);\r\nif (!ap)\r\nreturn;\r\nap->ranges[0].base = pci_resource_start(pdev, 0);\r\nap->ranges[0].size = pci_resource_len(pdev, 0);\r\n#ifdef CONFIG_X86\r\nprimary = pdev->resource[PCI_ROM_RESOURCE].flags & IORESOURCE_ROM_SHADOW;\r\n#endif\r\ndrm_fb_helper_remove_conflicting_framebuffers(ap, "mgag200drmfb", primary);\r\nkfree(ap);\r\n}\r\nstatic int mga_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nmgag200_kick_out_firmware_fb(pdev);\r\nreturn drm_get_pci_dev(pdev, ent, &driver);\r\n}\r\nstatic void mga_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\ndrm_put_dev(dev);\r\n}\r\nstatic int __init mgag200_init(void)\r\n{\r\nif (vgacon_text_force() && mgag200_modeset == -1)\r\nreturn -EINVAL;\r\nif (mgag200_modeset == 0)\r\nreturn -EINVAL;\r\nreturn drm_pci_init(&driver, &mgag200_pci_driver);\r\n}\r\nstatic void __exit mgag200_exit(void)\r\n{\r\ndrm_pci_exit(&driver, &mgag200_pci_driver);\r\n}

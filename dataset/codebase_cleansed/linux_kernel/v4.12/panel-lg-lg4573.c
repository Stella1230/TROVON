static inline struct lg4573 *panel_to_lg4573(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct lg4573, panel);\r\n}\r\nstatic int lg4573_spi_write_u16(struct lg4573 *ctx, u16 data)\r\n{\r\nstruct spi_transfer xfer = {\r\n.len = 2,\r\n};\r\nu16 temp = cpu_to_be16(data);\r\nstruct spi_message msg;\r\ndev_dbg(ctx->panel.dev, "writing data: %x\n", data);\r\nxfer.tx_buf = &temp;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nreturn spi_sync(ctx->spi, &msg);\r\n}\r\nstatic int lg4573_spi_write_u16_array(struct lg4573 *ctx, const u16 *buffer,\r\nunsigned int count)\r\n{\r\nunsigned int i;\r\nint ret;\r\nfor (i = 0; i < count; i++) {\r\nret = lg4573_spi_write_u16(ctx, buffer[i]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lg4573_spi_write_dcs(struct lg4573 *ctx, u8 dcs)\r\n{\r\nreturn lg4573_spi_write_u16(ctx, (0x70 << 8 | dcs));\r\n}\r\nstatic int lg4573_display_on(struct lg4573 *ctx)\r\n{\r\nint ret;\r\nret = lg4573_spi_write_dcs(ctx, MIPI_DCS_EXIT_SLEEP_MODE);\r\nif (ret)\r\nreturn ret;\r\nmsleep(5);\r\nreturn lg4573_spi_write_dcs(ctx, MIPI_DCS_SET_DISPLAY_ON);\r\n}\r\nstatic int lg4573_display_off(struct lg4573 *ctx)\r\n{\r\nint ret;\r\nret = lg4573_spi_write_dcs(ctx, MIPI_DCS_SET_DISPLAY_OFF);\r\nif (ret)\r\nreturn ret;\r\nmsleep(120);\r\nreturn lg4573_spi_write_dcs(ctx, MIPI_DCS_ENTER_SLEEP_MODE);\r\n}\r\nstatic int lg4573_display_mode_settings(struct lg4573 *ctx)\r\n{\r\nstatic const u16 display_mode_settings[] = {\r\n0x703A, 0x7270, 0x70B1, 0x7208,\r\n0x723B, 0x720F, 0x70B2, 0x7200,\r\n0x72C8, 0x70B3, 0x7200, 0x70B4,\r\n0x7200, 0x70B5, 0x7242, 0x7210,\r\n0x7210, 0x7200, 0x7220, 0x70B6,\r\n0x720B, 0x720F, 0x723C, 0x7213,\r\n0x7213, 0x72E8, 0x70B7, 0x7246,\r\n0x7206, 0x720C, 0x7200, 0x7200,\r\n};\r\ndev_dbg(ctx->panel.dev, "transfer display mode settings\n");\r\nreturn lg4573_spi_write_u16_array(ctx, display_mode_settings,\r\nARRAY_SIZE(display_mode_settings));\r\n}\r\nstatic int lg4573_power_settings(struct lg4573 *ctx)\r\n{\r\nstatic const u16 power_settings[] = {\r\n0x70C0, 0x7201, 0x7211, 0x70C3,\r\n0x7207, 0x7203, 0x7204, 0x7204,\r\n0x7204, 0x70C4, 0x7212, 0x7224,\r\n0x7218, 0x7218, 0x7202, 0x7249,\r\n0x70C5, 0x726F, 0x70C6, 0x7241,\r\n0x7263,\r\n};\r\ndev_dbg(ctx->panel.dev, "transfer power settings\n");\r\nreturn lg4573_spi_write_u16_array(ctx, power_settings,\r\nARRAY_SIZE(power_settings));\r\n}\r\nstatic int lg4573_gamma_settings(struct lg4573 *ctx)\r\n{\r\nstatic const u16 gamma_settings[] = {\r\n0x70D0, 0x7203, 0x7207, 0x7273,\r\n0x7235, 0x7200, 0x7201, 0x7220,\r\n0x7200, 0x7203, 0x70D1, 0x7203,\r\n0x7207, 0x7273, 0x7235, 0x7200,\r\n0x7201, 0x7220, 0x7200, 0x7203,\r\n0x70D2, 0x7203, 0x7207, 0x7273,\r\n0x7235, 0x7200, 0x7201, 0x7220,\r\n0x7200, 0x7203, 0x70D3, 0x7203,\r\n0x7207, 0x7273, 0x7235, 0x7200,\r\n0x7201, 0x7220, 0x7200, 0x7203,\r\n0x70D4, 0x7203, 0x7207, 0x7273,\r\n0x7235, 0x7200, 0x7201, 0x7220,\r\n0x7200, 0x7203, 0x70D5, 0x7203,\r\n0x7207, 0x7273, 0x7235, 0x7200,\r\n0x7201, 0x7220, 0x7200, 0x7203,\r\n};\r\ndev_dbg(ctx->panel.dev, "transfer gamma settings\n");\r\nreturn lg4573_spi_write_u16_array(ctx, gamma_settings,\r\nARRAY_SIZE(gamma_settings));\r\n}\r\nstatic int lg4573_init(struct lg4573 *ctx)\r\n{\r\nint ret;\r\ndev_dbg(ctx->panel.dev, "initializing LCD\n");\r\nret = lg4573_display_mode_settings(ctx);\r\nif (ret)\r\nreturn ret;\r\nret = lg4573_power_settings(ctx);\r\nif (ret)\r\nreturn ret;\r\nreturn lg4573_gamma_settings(ctx);\r\n}\r\nstatic int lg4573_power_on(struct lg4573 *ctx)\r\n{\r\nreturn lg4573_display_on(ctx);\r\n}\r\nstatic int lg4573_disable(struct drm_panel *panel)\r\n{\r\nstruct lg4573 *ctx = panel_to_lg4573(panel);\r\nreturn lg4573_display_off(ctx);\r\n}\r\nstatic int lg4573_enable(struct drm_panel *panel)\r\n{\r\nstruct lg4573 *ctx = panel_to_lg4573(panel);\r\nlg4573_init(ctx);\r\nreturn lg4573_power_on(ctx);\r\n}\r\nstatic int lg4573_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_connector *connector = panel->connector;\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(panel->drm->dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\nmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\r\ndrm_mode_probed_add(connector, mode);\r\npanel->connector->display_info.width_mm = 61;\r\npanel->connector->display_info.height_mm = 103;\r\nreturn 1;\r\n}\r\nstatic int lg4573_probe(struct spi_device *spi)\r\n{\r\nstruct lg4573 *ctx;\r\nint ret;\r\nctx = devm_kzalloc(&spi->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->spi = spi;\r\nspi_set_drvdata(spi, ctx);\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "SPI setup failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrm_panel_init(&ctx->panel);\r\nctx->panel.dev = &spi->dev;\r\nctx->panel.funcs = &lg4573_drm_funcs;\r\nreturn drm_panel_add(&ctx->panel);\r\n}\r\nstatic int lg4573_remove(struct spi_device *spi)\r\n{\r\nstruct lg4573 *ctx = spi_get_drvdata(spi);\r\nlg4573_display_off(ctx);\r\ndrm_panel_remove(&ctx->panel);\r\nreturn 0;\r\n}

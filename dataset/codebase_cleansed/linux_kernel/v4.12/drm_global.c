void drm_global_init(void)\r\n{\r\nint i;\r\nfor (i = 0; i < DRM_GLOBAL_NUM; ++i) {\r\nstruct drm_global_item *item = &glob[i];\r\nmutex_init(&item->mutex);\r\nitem->object = NULL;\r\nitem->refcount = 0;\r\n}\r\n}\r\nvoid drm_global_release(void)\r\n{\r\nint i;\r\nfor (i = 0; i < DRM_GLOBAL_NUM; ++i) {\r\nstruct drm_global_item *item = &glob[i];\r\nBUG_ON(item->object != NULL);\r\nBUG_ON(item->refcount != 0);\r\n}\r\n}\r\nint drm_global_item_ref(struct drm_global_reference *ref)\r\n{\r\nint ret = 0;\r\nstruct drm_global_item *item = &glob[ref->global_type];\r\nmutex_lock(&item->mutex);\r\nif (item->refcount == 0) {\r\nref->object = kzalloc(ref->size, GFP_KERNEL);\r\nif (unlikely(ref->object == NULL)) {\r\nret = -ENOMEM;\r\ngoto error_unlock;\r\n}\r\nret = ref->init(ref);\r\nif (unlikely(ret != 0))\r\ngoto error_free;\r\nitem->object = ref->object;\r\n} else {\r\nref->object = item->object;\r\n}\r\n++item->refcount;\r\nmutex_unlock(&item->mutex);\r\nreturn 0;\r\nerror_free:\r\nkfree(ref->object);\r\nref->object = NULL;\r\nerror_unlock:\r\nmutex_unlock(&item->mutex);\r\nreturn ret;\r\n}\r\nvoid drm_global_item_unref(struct drm_global_reference *ref)\r\n{\r\nstruct drm_global_item *item = &glob[ref->global_type];\r\nmutex_lock(&item->mutex);\r\nBUG_ON(item->refcount == 0);\r\nBUG_ON(ref->object != item->object);\r\nif (--item->refcount == 0) {\r\nref->release(ref);\r\nitem->object = NULL;\r\n}\r\nmutex_unlock(&item->mutex);\r\n}

static void __init pq2fads_pic_init(void)\r\n{\r\nstruct device_node *np = of_find_compatible_node(NULL, NULL, "fsl,cpm2-pic");\r\nif (!np) {\r\nprintk(KERN_ERR "PIC init: can not find fsl,cpm2-pic node\n");\r\nreturn;\r\n}\r\ncpm2_pic_init(np);\r\nof_node_put(np);\r\npq2ads_pci_init_irq();\r\n}\r\nstatic void __init init_ioports(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pq2fads_pins); i++) {\r\nstruct cpm_pin *pin = &pq2fads_pins[i];\r\ncpm2_set_pin(pin->port, pin->pin, pin->flags);\r\n}\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_SCC2, CPM_BRG2, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC2, CPM_BRG2, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK13, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK14, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC3, CPM_CLK15, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC3, CPM_CLK16, CPM_CLK_TX);\r\n}\r\nstatic void __init pq2fads_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\n__be32 __iomem *bcsr;\r\nif (ppc_md.progress)\r\nppc_md.progress("pq2fads_setup_arch()", 0);\r\ncpm2_reset();\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,pq2fads-bcsr");\r\nif (!np) {\r\nprintk(KERN_ERR "No fsl,pq2fads-bcsr in device tree\n");\r\nreturn;\r\n}\r\nbcsr = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!bcsr) {\r\nprintk(KERN_ERR "Cannot map BCSR registers\n");\r\nreturn;\r\n}\r\nclrbits32(&bcsr[1], BCSR1_RS232_EN1 | BCSR1_RS232_EN2 | BCSR1_FETHIEN);\r\nsetbits32(&bcsr[1], BCSR1_FETH_RST);\r\nclrbits32(&bcsr[3], BCSR3_FETHIEN2);\r\nsetbits32(&bcsr[3], BCSR3_FETH2_RST);\r\niounmap(bcsr);\r\ninit_ioports();\r\nclrbits32(&cpm2_immr->im_siu_conf.siu_82xx.sc_siumcr, 0x0c000000);\r\npq2_init_pci();\r\nif (ppc_md.progress)\r\nppc_md.progress("pq2fads_setup_arch(), finish", 0);\r\n}\r\nstatic int __init pq2fads_probe(void)\r\n{\r\nreturn of_machine_is_compatible("fsl,pq2fads");\r\n}\r\nstatic int __init declare_of_platform_devices(void)\r\n{\r\nof_platform_bus_probe(NULL, of_bus_ids, NULL);\r\nreturn 0;\r\n}

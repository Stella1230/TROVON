void __init mac_init_IRQ(void)\r\n{\r\nm68k_setup_irq_controller(&mac_irq_chip, handle_simple_irq, IRQ_USER,\r\nNUM_MAC_SOURCES - IRQ_USER);\r\nif (oss_present)\r\noss_register_interrupts();\r\nelse\r\nvia_register_interrupts();\r\nif (psc)\r\npsc_register_interrupts();\r\nif (baboon_present)\r\nbaboon_register_interrupts();\r\niop_register_interrupts();\r\nif (request_irq(IRQ_AUTO_7, mac_nmi_handler, 0, "NMI",\r\nmac_nmi_handler))\r\npr_err("Couldn't register NMI\n");\r\n}\r\nvoid mac_irq_enable(struct irq_data *data)\r\n{\r\nint irq = data->irq;\r\nint irq_src = IRQ_SRC(irq);\r\nswitch(irq_src) {\r\ncase 1:\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\noss_irq_enable(irq);\r\nelse\r\nvia_irq_enable(irq);\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\nif (psc)\r\npsc_irq_enable(irq);\r\nelse if (oss_present)\r\noss_irq_enable(irq);\r\nbreak;\r\ncase 8:\r\nif (baboon_present)\r\nbaboon_irq_enable(irq);\r\nbreak;\r\n}\r\n}\r\nvoid mac_irq_disable(struct irq_data *data)\r\n{\r\nint irq = data->irq;\r\nint irq_src = IRQ_SRC(irq);\r\nswitch(irq_src) {\r\ncase 1:\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\noss_irq_disable(irq);\r\nelse\r\nvia_irq_disable(irq);\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\nif (psc)\r\npsc_irq_disable(irq);\r\nelse if (oss_present)\r\noss_irq_disable(irq);\r\nbreak;\r\ncase 8:\r\nif (baboon_present)\r\nbaboon_irq_disable(irq);\r\nbreak;\r\n}\r\n}\r\nstatic unsigned int mac_irq_startup(struct irq_data *data)\r\n{\r\nint irq = data->irq;\r\nif (IRQ_SRC(irq) == 7 && !oss_present)\r\nvia_nubus_irq_startup(irq);\r\nelse\r\nmac_irq_enable(data);\r\nreturn 0;\r\n}\r\nstatic void mac_irq_shutdown(struct irq_data *data)\r\n{\r\nint irq = data->irq;\r\nif (IRQ_SRC(irq) == 7 && !oss_present)\r\nvia_nubus_irq_shutdown(irq);\r\nelse\r\nmac_irq_disable(data);\r\n}\r\nirqreturn_t mac_nmi_handler(int irq, void *dev_id)\r\n{\r\nif (in_nmi)\r\nreturn IRQ_HANDLED;\r\nin_nmi = 1;\r\npr_info("Non-Maskable Interrupt\n");\r\nshow_registers(get_irq_regs());\r\nin_nmi = 0;\r\nreturn IRQ_HANDLED;\r\n}

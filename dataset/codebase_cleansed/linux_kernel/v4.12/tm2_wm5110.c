static int tm2_start_sysclk(struct snd_soc_card *card)\r\n{\r\nstruct tm2_machine_priv *priv = snd_soc_card_get_drvdata(card);\r\nstruct snd_soc_codec *codec = priv->codec;\r\nint ret;\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL1_REFCLK,\r\nARIZONA_FLL_SRC_MCLK1,\r\nMCLK_RATE,\r\npriv->sysclk_rate);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set FLL1 source: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL1,\r\nARIZONA_FLL_SRC_MCLK1,\r\nMCLK_RATE,\r\npriv->sysclk_rate);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to start FLL1: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_SYSCLK,\r\nARIZONA_CLK_SRC_FLL1,\r\npriv->sysclk_rate,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set SYSCLK source: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tm2_stop_sysclk(struct snd_soc_card *card)\r\n{\r\nstruct tm2_machine_priv *priv = snd_soc_card_get_drvdata(card);\r\nstruct snd_soc_codec *codec = priv->codec;\r\nint ret;\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL1, 0, 0, 0);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to stop FLL1: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_SYSCLK,\r\nARIZONA_CLK_SRC_FLL1, 0, 0);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to stop SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tm2_aif1_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct tm2_machine_priv *priv = snd_soc_card_get_drvdata(rtd->card);\r\nswitch (params_rate(params)) {\r\ncase 4000:\r\ncase 8000:\r\ncase 12000:\r\ncase 16000:\r\ncase 24000:\r\ncase 32000:\r\ncase 48000:\r\ncase 96000:\r\ncase 192000:\r\npriv->sysclk_rate = 147456000U;\r\nbreak;\r\ncase 11025:\r\ncase 22050:\r\ncase 44100:\r\ncase 88200:\r\ncase 176400:\r\npriv->sysclk_rate = 135475200U;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Not supported sample rate: %d\n",\r\nparams_rate(params));\r\nreturn -EINVAL;\r\n}\r\nreturn tm2_start_sysclk(rtd->card);\r\n}\r\nstatic int tm2_aif2_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nunsigned int asyncclk_rate;\r\nint ret;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\ncase 12000:\r\ncase 16000:\r\nasyncclk_rate = 49152000U;\r\nbreak;\r\ncase 11025:\r\nasyncclk_rate = 45158400U;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Not supported sample rate: %d\n",\r\nparams_rate(params));\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL2_REFCLK,\r\nARIZONA_FLL_SRC_MCLK1,\r\nMCLK_RATE,\r\nasyncclk_rate);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set FLL2 source: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL2,\r\nARIZONA_FLL_SRC_MCLK1,\r\nMCLK_RATE,\r\nasyncclk_rate);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to start FLL2: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_ASYNCCLK,\r\nARIZONA_CLK_SRC_FLL2,\r\nasyncclk_rate,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set ASYNCCLK source: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tm2_aif2_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nint ret;\r\nret = snd_soc_codec_set_pll(codec, WM5110_FLL2, ARIZONA_FLL_SRC_MCLK1,\r\n0, 0);\r\nif (ret < 0)\r\ndev_err(codec->dev, "Failed to stop FLL2: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int tm2_mic_bias(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_card *card = w->dapm->card;\r\nstruct tm2_machine_priv *priv = snd_soc_card_get_drvdata(card);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\ngpiod_set_value_cansleep(priv->gpio_mic_bias, 1);\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMD:\r\ngpiod_set_value_cansleep(priv->gpio_mic_bias, 0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tm2_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd;\r\nrtd = snd_soc_get_pcm_runtime(card, card->dai_link[0].name);\r\nif (dapm->dev != rtd->codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (card->dapm.bias_level == SND_SOC_BIAS_OFF)\r\ntm2_start_sysclk(card);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\ntm2_stop_sysclk(card);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tm2_late_probe(struct snd_soc_card *card)\r\n{\r\nstruct tm2_machine_priv *priv = snd_soc_card_get_drvdata(card);\r\nstruct snd_soc_dai_link_component dlc = { 0 };\r\nunsigned int ch_map[] = { 0, 1 };\r\nstruct snd_soc_dai *amp_pdm_dai;\r\nstruct snd_soc_pcm_runtime *rtd;\r\nstruct snd_soc_dai *aif1_dai;\r\nstruct snd_soc_dai *aif2_dai;\r\nint ret;\r\nrtd = snd_soc_get_pcm_runtime(card, card->dai_link[TM2_DAI_AIF1].name);\r\naif1_dai = rtd->codec_dai;\r\npriv->codec = rtd->codec;\r\nret = snd_soc_dai_set_sysclk(aif1_dai, ARIZONA_CLK_SYSCLK, 0, 0);\r\nif (ret < 0) {\r\ndev_err(aif1_dai->dev, "Failed to set SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nrtd = snd_soc_get_pcm_runtime(card, card->dai_link[TM2_DAI_AIF2].name);\r\naif2_dai = rtd->codec_dai;\r\nret = snd_soc_dai_set_sysclk(aif2_dai, ARIZONA_CLK_ASYNCCLK, 0, 0);\r\nif (ret < 0) {\r\ndev_err(aif2_dai->dev, "Failed to set ASYNCCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\ndlc.of_node = tm2_speaker_amp_dev.codec_of_node;\r\namp_pdm_dai = snd_soc_find_dai(&dlc);\r\nif (!amp_pdm_dai)\r\nreturn -ENODEV;\r\nret = snd_soc_dai_set_channel_map(amp_pdm_dai, ARRAY_SIZE(ch_map),\r\nch_map, 0, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_tdm_slot(amp_pdm_dai, 0x3, 0x0, 2, 16);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int tm2_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct snd_soc_card *card = &tm2_card;\r\nstruct tm2_machine_priv *priv;\r\nstruct device_node *cpu_dai_node, *codec_dai_node;\r\nint ret, i;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nsnd_soc_card_set_drvdata(card, priv);\r\ncard->dev = dev;\r\npriv->gpio_mic_bias = devm_gpiod_get(dev, "mic-bias",\r\nGPIOF_OUT_INIT_LOW);\r\nif (IS_ERR(priv->gpio_mic_bias)) {\r\ndev_err(dev, "Failed to get mic bias gpio\n");\r\nreturn PTR_ERR(priv->gpio_mic_bias);\r\n}\r\nret = snd_soc_of_parse_card_name(card, "model");\r\nif (ret < 0) {\r\ndev_err(dev, "Card name is not specified\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_of_parse_audio_routing(card, "samsung,audio-routing");\r\nif (ret < 0) {\r\ndev_err(dev, "Audio routing is not specified or invalid\n");\r\nreturn ret;\r\n}\r\ncard->aux_dev[0].codec_of_node = of_parse_phandle(dev->of_node,\r\n"audio-amplifier", 0);\r\nif (!card->aux_dev[0].codec_of_node) {\r\ndev_err(dev, "audio-amplifier property invalid or missing\n");\r\nreturn -EINVAL;\r\n}\r\ncpu_dai_node = of_parse_phandle(dev->of_node, "i2s-controller", 0);\r\nif (!cpu_dai_node) {\r\ndev_err(dev, "i2s-controllers property invalid or missing\n");\r\nret = -EINVAL;\r\ngoto amp_node_put;\r\n}\r\ncodec_dai_node = of_parse_phandle(dev->of_node, "audio-codec", 0);\r\nif (!codec_dai_node) {\r\ndev_err(dev, "audio-codec property invalid or missing\n");\r\nret = -EINVAL;\r\ngoto cpu_dai_node_put;\r\n}\r\nfor (i = 0; i < card->num_links; i++) {\r\ncard->dai_link[i].cpu_dai_name = NULL;\r\ncard->dai_link[i].cpu_name = NULL;\r\ncard->dai_link[i].platform_name = NULL;\r\ncard->dai_link[i].codec_of_node = codec_dai_node;\r\ncard->dai_link[i].cpu_of_node = cpu_dai_node;\r\ncard->dai_link[i].platform_of_node = cpu_dai_node;\r\n}\r\nret = devm_snd_soc_register_component(dev, &tm2_component,\r\ntm2_ext_dai, ARRAY_SIZE(tm2_ext_dai));\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to register component: %d\n", ret);\r\ngoto codec_dai_node_put;\r\n}\r\nret = devm_snd_soc_register_card(dev, card);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to register card: %d\n", ret);\r\ngoto codec_dai_node_put;\r\n}\r\ncodec_dai_node_put:\r\nof_node_put(codec_dai_node);\r\ncpu_dai_node_put:\r\nof_node_put(cpu_dai_node);\r\namp_node_put:\r\nof_node_put(card->aux_dev[0].codec_of_node);\r\nreturn ret;\r\n}\r\nstatic int tm2_pm_prepare(struct device *dev)\r\n{\r\nstruct snd_soc_card *card = dev_get_drvdata(dev);\r\nreturn tm2_stop_sysclk(card);\r\n}\r\nstatic void tm2_pm_complete(struct device *dev)\r\n{\r\nstruct snd_soc_card *card = dev_get_drvdata(dev);\r\ntm2_start_sysclk(card);\r\n}

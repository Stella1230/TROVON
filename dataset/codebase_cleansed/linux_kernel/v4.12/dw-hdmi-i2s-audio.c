static inline void hdmi_write(struct dw_hdmi_i2s_audio_data *audio,\r\nu8 val, int offset)\r\n{\r\nstruct dw_hdmi *hdmi = audio->hdmi;\r\naudio->write(hdmi, val, offset);\r\n}\r\nstatic inline u8 hdmi_read(struct dw_hdmi_i2s_audio_data *audio, int offset)\r\n{\r\nstruct dw_hdmi *hdmi = audio->hdmi;\r\nreturn audio->read(hdmi, offset);\r\n}\r\nstatic int dw_hdmi_i2s_hw_params(struct device *dev, void *data,\r\nstruct hdmi_codec_daifmt *fmt,\r\nstruct hdmi_codec_params *hparms)\r\n{\r\nstruct dw_hdmi_i2s_audio_data *audio = data;\r\nstruct dw_hdmi *hdmi = audio->hdmi;\r\nu8 conf0 = 0;\r\nu8 conf1 = 0;\r\nu8 inputclkfs = 0;\r\nif ((fmt->fmt != HDMI_I2S) ||\r\n(fmt->bit_clk_master | fmt->frame_clk_master)) {\r\ndev_err(dev, "unsupported format/settings\n");\r\nreturn -EINVAL;\r\n}\r\ninputclkfs = HDMI_AUD_INPUTCLKFS_64FS;\r\nconf0 = HDMI_AUD_CONF0_I2S_ALL_ENABLE;\r\nswitch (hparms->sample_width) {\r\ncase 16:\r\nconf1 = HDMI_AUD_CONF1_WIDTH_16;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nconf1 = HDMI_AUD_CONF1_WIDTH_24;\r\nbreak;\r\n}\r\ndw_hdmi_set_sample_rate(hdmi, hparms->sample_rate);\r\nhdmi_write(audio, inputclkfs, HDMI_AUD_INPUTCLKFS);\r\nhdmi_write(audio, conf0, HDMI_AUD_CONF0);\r\nhdmi_write(audio, conf1, HDMI_AUD_CONF1);\r\ndw_hdmi_audio_enable(hdmi);\r\nreturn 0;\r\n}\r\nstatic void dw_hdmi_i2s_audio_shutdown(struct device *dev, void *data)\r\n{\r\nstruct dw_hdmi_i2s_audio_data *audio = data;\r\nstruct dw_hdmi *hdmi = audio->hdmi;\r\ndw_hdmi_audio_disable(hdmi);\r\nhdmi_write(audio, HDMI_AUD_CONF0_SW_RESET, HDMI_AUD_CONF0);\r\n}\r\nstatic int snd_dw_hdmi_probe(struct platform_device *pdev)\r\n{\r\nstruct dw_hdmi_i2s_audio_data *audio = pdev->dev.platform_data;\r\nstruct platform_device_info pdevinfo;\r\nstruct hdmi_codec_pdata pdata;\r\nstruct platform_device *platform;\r\npdata.ops = &dw_hdmi_i2s_ops;\r\npdata.i2s = 1;\r\npdata.max_i2s_channels = 6;\r\npdata.data = audio;\r\nmemset(&pdevinfo, 0, sizeof(pdevinfo));\r\npdevinfo.parent = pdev->dev.parent;\r\npdevinfo.id = PLATFORM_DEVID_AUTO;\r\npdevinfo.name = HDMI_CODEC_DRV_NAME;\r\npdevinfo.data = &pdata;\r\npdevinfo.size_data = sizeof(pdata);\r\npdevinfo.dma_mask = DMA_BIT_MASK(32);\r\nplatform = platform_device_register_full(&pdevinfo);\r\nif (IS_ERR(platform))\r\nreturn PTR_ERR(platform);\r\ndev_set_drvdata(&pdev->dev, platform);\r\nreturn 0;\r\n}\r\nstatic int snd_dw_hdmi_remove(struct platform_device *pdev)\r\n{\r\nstruct platform_device *platform = dev_get_drvdata(&pdev->dev);\r\nplatform_device_unregister(platform);\r\nreturn 0;\r\n}

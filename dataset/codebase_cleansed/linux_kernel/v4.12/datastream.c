struct buffer_head *\r\nbefs_read_datastream(struct super_block *sb, const befs_data_stream *ds,\r\nbefs_off_t pos, uint *off)\r\n{\r\nstruct buffer_head *bh;\r\nbefs_block_run run;\r\nbefs_blocknr_t block;\r\nbefs_debug(sb, "---> %s %llu", __func__, pos);\r\nblock = pos >> BEFS_SB(sb)->block_shift;\r\nif (off)\r\n*off = pos - (block << BEFS_SB(sb)->block_shift);\r\nif (befs_fblock2brun(sb, ds, block, &run) != BEFS_OK) {\r\nbefs_error(sb, "BeFS: Error finding disk addr of block %lu",\r\n(unsigned long)block);\r\nbefs_debug(sb, "<--- %s ERROR", __func__);\r\nreturn NULL;\r\n}\r\nbh = befs_bread_iaddr(sb, run);\r\nif (!bh) {\r\nbefs_error(sb, "BeFS: Error reading block %lu from datastream",\r\n(unsigned long)block);\r\nreturn NULL;\r\n}\r\nbefs_debug(sb, "<--- %s read data, starting at %llu", __func__, pos);\r\nreturn bh;\r\n}\r\nint\r\nbefs_fblock2brun(struct super_block *sb, const befs_data_stream *data,\r\nbefs_blocknr_t fblock, befs_block_run *run)\r\n{\r\nint err;\r\nbefs_off_t pos = fblock << BEFS_SB(sb)->block_shift;\r\nif (pos < data->max_direct_range) {\r\nerr = befs_find_brun_direct(sb, data, fblock, run);\r\n} else if (pos < data->max_indirect_range) {\r\nerr = befs_find_brun_indirect(sb, data, fblock, run);\r\n} else if (pos < data->max_double_indirect_range) {\r\nerr = befs_find_brun_dblindirect(sb, data, fblock, run);\r\n} else {\r\nbefs_error(sb,\r\n"befs_fblock2brun() was asked to find block %lu, "\r\n"which is not mapped by the datastream\n",\r\n(unsigned long)fblock);\r\nerr = BEFS_ERR;\r\n}\r\nreturn err;\r\n}\r\nsize_t\r\nbefs_read_lsymlink(struct super_block *sb, const befs_data_stream *ds,\r\nvoid *buff, befs_off_t len)\r\n{\r\nbefs_off_t bytes_read = 0;\r\nu16 plen;\r\nstruct buffer_head *bh;\r\nbefs_debug(sb, "---> %s length: %llu", __func__, len);\r\nwhile (bytes_read < len) {\r\nbh = befs_read_datastream(sb, ds, bytes_read, NULL);\r\nif (!bh) {\r\nbefs_error(sb, "BeFS: Error reading datastream block "\r\n"starting from %llu", bytes_read);\r\nbefs_debug(sb, "<--- %s ERROR", __func__);\r\nreturn bytes_read;\r\n}\r\nplen = ((bytes_read + BEFS_SB(sb)->block_size) < len) ?\r\nBEFS_SB(sb)->block_size : len - bytes_read;\r\nmemcpy(buff + bytes_read, bh->b_data, plen);\r\nbrelse(bh);\r\nbytes_read += plen;\r\n}\r\nbefs_debug(sb, "<--- %s read %u bytes", __func__, (unsigned int)\r\nbytes_read);\r\nreturn bytes_read;\r\n}\r\nbefs_blocknr_t\r\nbefs_count_blocks(struct super_block *sb, const befs_data_stream *ds)\r\n{\r\nbefs_blocknr_t blocks;\r\nbefs_blocknr_t datablocks;\r\nbefs_blocknr_t metablocks;\r\nstruct befs_sb_info *befs_sb = BEFS_SB(sb);\r\nbefs_debug(sb, "---> %s", __func__);\r\ndatablocks = ds->size >> befs_sb->block_shift;\r\nif (ds->size & (befs_sb->block_size - 1))\r\ndatablocks += 1;\r\nmetablocks = 1;\r\nif (ds->size > ds->max_direct_range)\r\nmetablocks += ds->indirect.len;\r\nif (ds->size > ds->max_indirect_range && ds->max_indirect_range != 0) {\r\nuint dbl_bytes;\r\nuint dbl_bruns;\r\nuint indirblocks;\r\ndbl_bytes =\r\nds->max_double_indirect_range - ds->max_indirect_range;\r\ndbl_bruns =\r\ndbl_bytes / (befs_sb->block_size * BEFS_DBLINDIR_BRUN_LEN);\r\nindirblocks = dbl_bruns / befs_iaddrs_per_block(sb);\r\nmetablocks += ds->double_indirect.len;\r\nmetablocks += indirblocks;\r\n}\r\nblocks = datablocks + metablocks;\r\nbefs_debug(sb, "<--- %s %u blocks", __func__, (unsigned int)blocks);\r\nreturn blocks;\r\n}\r\nstatic int\r\nbefs_find_brun_direct(struct super_block *sb, const befs_data_stream *data,\r\nbefs_blocknr_t blockno, befs_block_run *run)\r\n{\r\nint i;\r\nconst befs_block_run *array = data->direct;\r\nbefs_blocknr_t sum;\r\nbefs_debug(sb, "---> %s, find %lu", __func__, (unsigned long)blockno);\r\nfor (i = 0, sum = 0; i < BEFS_NUM_DIRECT_BLOCKS;\r\nsum += array[i].len, i++) {\r\nif (blockno >= sum && blockno < sum + (array[i].len)) {\r\nint offset = blockno - sum;\r\nrun->allocation_group = array[i].allocation_group;\r\nrun->start = array[i].start + offset;\r\nrun->len = array[i].len - offset;\r\nbefs_debug(sb, "---> %s, "\r\n"found %lu at direct[%d]", __func__,\r\n(unsigned long)blockno, i);\r\nreturn BEFS_OK;\r\n}\r\n}\r\nbefs_error(sb, "%s failed to find file block %lu", __func__,\r\n(unsigned long)blockno);\r\nbefs_debug(sb, "---> %s ERROR", __func__);\r\nreturn BEFS_ERR;\r\n}\r\nstatic int\r\nbefs_find_brun_indirect(struct super_block *sb,\r\nconst befs_data_stream *data,\r\nbefs_blocknr_t blockno,\r\nbefs_block_run *run)\r\n{\r\nint i, j;\r\nbefs_blocknr_t sum = 0;\r\nbefs_blocknr_t indir_start_blk;\r\nbefs_blocknr_t search_blk;\r\nstruct buffer_head *indirblock;\r\nbefs_disk_block_run *array;\r\nbefs_block_run indirect = data->indirect;\r\nbefs_blocknr_t indirblockno = iaddr2blockno(sb, &indirect);\r\nint arraylen = befs_iaddrs_per_block(sb);\r\nbefs_debug(sb, "---> %s, find %lu", __func__, (unsigned long)blockno);\r\nindir_start_blk = data->max_direct_range >> BEFS_SB(sb)->block_shift;\r\nsearch_blk = blockno - indir_start_blk;\r\nfor (i = 0; i < indirect.len; i++) {\r\nindirblock = sb_bread(sb, indirblockno + i);\r\nif (indirblock == NULL) {\r\nbefs_error(sb, "---> %s failed to read "\r\n"disk block %lu from the indirect brun",\r\n__func__, (unsigned long)indirblockno + i);\r\nbefs_debug(sb, "<--- %s ERROR", __func__);\r\nreturn BEFS_ERR;\r\n}\r\narray = (befs_disk_block_run *) indirblock->b_data;\r\nfor (j = 0; j < arraylen; ++j) {\r\nint len = fs16_to_cpu(sb, array[j].len);\r\nif (search_blk >= sum && search_blk < sum + len) {\r\nint offset = search_blk - sum;\r\nrun->allocation_group =\r\nfs32_to_cpu(sb, array[j].allocation_group);\r\nrun->start =\r\nfs16_to_cpu(sb, array[j].start) + offset;\r\nrun->len =\r\nfs16_to_cpu(sb, array[j].len) - offset;\r\nbrelse(indirblock);\r\nbefs_debug(sb,\r\n"<--- %s found file block "\r\n"%lu at indirect[%d]", __func__,\r\n(unsigned long)blockno,\r\nj + (i * arraylen));\r\nreturn BEFS_OK;\r\n}\r\nsum += len;\r\n}\r\nbrelse(indirblock);\r\n}\r\nbefs_error(sb, "BeFS: %s failed to find "\r\n"file block %lu", __func__, (unsigned long)blockno);\r\nbefs_debug(sb, "<--- %s ERROR", __func__);\r\nreturn BEFS_ERR;\r\n}\r\nstatic int\r\nbefs_find_brun_dblindirect(struct super_block *sb,\r\nconst befs_data_stream *data,\r\nbefs_blocknr_t blockno,\r\nbefs_block_run *run)\r\n{\r\nint dblindir_indx;\r\nint indir_indx;\r\nint offset;\r\nint dbl_which_block;\r\nint which_block;\r\nint dbl_block_indx;\r\nint block_indx;\r\noff_t dblindir_leftover;\r\nbefs_blocknr_t blockno_at_run_start;\r\nstruct buffer_head *dbl_indir_block;\r\nstruct buffer_head *indir_block;\r\nbefs_block_run indir_run;\r\nbefs_disk_inode_addr *iaddr_array;\r\nbefs_blocknr_t indir_start_blk =\r\ndata->max_indirect_range >> BEFS_SB(sb)->block_shift;\r\noff_t dbl_indir_off = blockno - indir_start_blk;\r\nsize_t iblklen = BEFS_DBLINDIR_BRUN_LEN;\r\nsize_t diblklen = iblklen * befs_iaddrs_per_block(sb)\r\n* BEFS_DBLINDIR_BRUN_LEN;\r\nbefs_debug(sb, "---> %s find %lu", __func__, (unsigned long)blockno);\r\ndblindir_indx = dbl_indir_off / diblklen;\r\ndblindir_leftover = dbl_indir_off % diblklen;\r\nindir_indx = dblindir_leftover / diblklen;\r\ndbl_which_block = dblindir_indx / befs_iaddrs_per_block(sb);\r\nif (dbl_which_block > data->double_indirect.len) {\r\nbefs_error(sb, "The double-indirect index calculated by "\r\n"%s, %d, is outside the range "\r\n"of the double-indirect block", __func__,\r\ndblindir_indx);\r\nreturn BEFS_ERR;\r\n}\r\ndbl_indir_block =\r\nsb_bread(sb, iaddr2blockno(sb, &data->double_indirect) +\r\ndbl_which_block);\r\nif (dbl_indir_block == NULL) {\r\nbefs_error(sb, "%s couldn't read the "\r\n"double-indirect block at blockno %lu", __func__,\r\n(unsigned long)\r\niaddr2blockno(sb, &data->double_indirect) +\r\ndbl_which_block);\r\nreturn BEFS_ERR;\r\n}\r\ndbl_block_indx =\r\ndblindir_indx - (dbl_which_block * befs_iaddrs_per_block(sb));\r\niaddr_array = (befs_disk_inode_addr *) dbl_indir_block->b_data;\r\nindir_run = fsrun_to_cpu(sb, iaddr_array[dbl_block_indx]);\r\nbrelse(dbl_indir_block);\r\nwhich_block = indir_indx / befs_iaddrs_per_block(sb);\r\nif (which_block > indir_run.len) {\r\nbefs_error(sb, "The indirect index calculated by "\r\n"%s, %d, is outside the range "\r\n"of the indirect block", __func__, indir_indx);\r\nreturn BEFS_ERR;\r\n}\r\nindir_block =\r\nsb_bread(sb, iaddr2blockno(sb, &indir_run) + which_block);\r\nif (indir_block == NULL) {\r\nbefs_error(sb, "%s couldn't read the indirect block "\r\n"at blockno %lu", __func__, (unsigned long)\r\niaddr2blockno(sb, &indir_run) + which_block);\r\nreturn BEFS_ERR;\r\n}\r\nblock_indx = indir_indx - (which_block * befs_iaddrs_per_block(sb));\r\niaddr_array = (befs_disk_inode_addr *) indir_block->b_data;\r\n*run = fsrun_to_cpu(sb, iaddr_array[block_indx]);\r\nbrelse(indir_block);\r\nblockno_at_run_start = indir_start_blk;\r\nblockno_at_run_start += diblklen * dblindir_indx;\r\nblockno_at_run_start += iblklen * indir_indx;\r\noffset = blockno - blockno_at_run_start;\r\nrun->start += offset;\r\nrun->len -= offset;\r\nbefs_debug(sb, "Found file block %lu in double_indirect[%d][%d],"\r\n" double_indirect_leftover = %lu", (unsigned long)\r\nblockno, dblindir_indx, indir_indx, dblindir_leftover);\r\nreturn BEFS_OK;\r\n}

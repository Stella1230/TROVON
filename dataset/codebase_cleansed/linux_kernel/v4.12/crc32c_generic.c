static int chksum_init(struct shash_desc *desc)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(desc->tfm);\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nctx->crc = mctx->key;\r\nreturn 0;\r\n}\r\nstatic int chksum_setkey(struct crypto_shash *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(tfm);\r\nif (keylen != sizeof(mctx->key)) {\r\ncrypto_shash_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);\r\nreturn -EINVAL;\r\n}\r\nmctx->key = le32_to_cpu(*(__le32 *)key);\r\nreturn 0;\r\n}\r\nstatic int chksum_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int length)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nctx->crc = __crc32c_le(ctx->crc, data, length);\r\nreturn 0;\r\n}\r\nstatic int chksum_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\n*(__le32 *)out = ~cpu_to_le32p(&ctx->crc);\r\nreturn 0;\r\n}\r\nstatic int __chksum_finup(u32 *crcp, const u8 *data, unsigned int len, u8 *out)\r\n{\r\n*(__le32 *)out = ~cpu_to_le32(__crc32c_le(*crcp, data, len));\r\nreturn 0;\r\n}\r\nstatic int chksum_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nreturn __chksum_finup(&ctx->crc, data, len, out);\r\n}\r\nstatic int chksum_digest(struct shash_desc *desc, const u8 *data,\r\nunsigned int length, u8 *out)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(desc->tfm);\r\nreturn __chksum_finup(&mctx->key, data, length, out);\r\n}\r\nstatic int crc32c_cra_init(struct crypto_tfm *tfm)\r\n{\r\nstruct chksum_ctx *mctx = crypto_tfm_ctx(tfm);\r\nmctx->key = ~0;\r\nreturn 0;\r\n}\r\nstatic int __init crc32c_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit crc32c_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

static snd_pcm_uframes_t mtk_afe_pcm_pointer\r\n(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct mtk_base_afe *afe = snd_soc_platform_get_drvdata(rtd->platform);\r\nstruct mtk_base_afe_memif *memif = &afe->memif[rtd->cpu_dai->id];\r\nconst struct mtk_base_memif_data *memif_data = memif->data;\r\nstruct regmap *regmap = afe->regmap;\r\nstruct device *dev = afe->dev;\r\nint reg_ofs_base = memif_data->reg_ofs_base;\r\nint reg_ofs_cur = memif_data->reg_ofs_cur;\r\nunsigned int hw_ptr = 0, hw_base = 0;\r\nint ret, pcm_ptr_bytes;\r\nret = regmap_read(regmap, reg_ofs_cur, &hw_ptr);\r\nif (ret || hw_ptr == 0) {\r\ndev_err(dev, "%s hw_ptr err\n", __func__);\r\npcm_ptr_bytes = 0;\r\ngoto POINTER_RETURN_FRAMES;\r\n}\r\nret = regmap_read(regmap, reg_ofs_base, &hw_base);\r\nif (ret || hw_base == 0) {\r\ndev_err(dev, "%s hw_ptr err\n", __func__);\r\npcm_ptr_bytes = 0;\r\ngoto POINTER_RETURN_FRAMES;\r\n}\r\npcm_ptr_bytes = hw_ptr - hw_base;\r\nPOINTER_RETURN_FRAMES:\r\nreturn bytes_to_frames(substream->runtime, pcm_ptr_bytes);\r\n}\r\nstatic int mtk_afe_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nsize_t size;\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nstruct mtk_base_afe *afe = snd_soc_platform_get_drvdata(rtd->platform);\r\nsize = afe->mtk_afe_hardware->buffer_bytes_max;\r\nreturn snd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\ncard->dev, size, size);\r\n}\r\nstatic void mtk_afe_pcm_free(struct snd_pcm *pcm)\r\n{\r\nsnd_pcm_lib_preallocate_free_for_all(pcm);\r\n}

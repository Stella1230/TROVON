static int syscallcmpname(const void *vkey, const void *ventry)\r\n{\r\nconst char *key = vkey;\r\nconst struct syscall *entry = ventry;\r\nreturn strcmp(key, entry->name);\r\n}\r\nstatic int syscallcmp(const void *va, const void *vb)\r\n{\r\nconst struct syscall *a = va, *b = vb;\r\nreturn strcmp(a->name, b->name);\r\n}\r\nstatic int syscalltbl__init_native(struct syscalltbl *tbl)\r\n{\r\nint nr_entries = 0, i, j;\r\nstruct syscall *entries;\r\nfor (i = 0; i <= syscalltbl_native_max_id; ++i)\r\nif (syscalltbl_native[i])\r\n++nr_entries;\r\nentries = tbl->syscalls.entries = malloc(sizeof(struct syscall) * nr_entries);\r\nif (tbl->syscalls.entries == NULL)\r\nreturn -1;\r\nfor (i = 0, j = 0; i <= syscalltbl_native_max_id; ++i) {\r\nif (syscalltbl_native[i]) {\r\nentries[j].name = syscalltbl_native[i];\r\nentries[j].id = i;\r\n++j;\r\n}\r\n}\r\nqsort(tbl->syscalls.entries, nr_entries, sizeof(struct syscall), syscallcmp);\r\ntbl->syscalls.nr_entries = nr_entries;\r\nreturn 0;\r\n}\r\nstruct syscalltbl *syscalltbl__new(void)\r\n{\r\nstruct syscalltbl *tbl = malloc(sizeof(*tbl));\r\nif (tbl) {\r\nif (syscalltbl__init_native(tbl)) {\r\nfree(tbl);\r\nreturn NULL;\r\n}\r\n}\r\nreturn tbl;\r\n}\r\nvoid syscalltbl__delete(struct syscalltbl *tbl)\r\n{\r\nzfree(&tbl->syscalls.entries);\r\nfree(tbl);\r\n}\r\nconst char *syscalltbl__name(const struct syscalltbl *tbl __maybe_unused, int id)\r\n{\r\nreturn id <= syscalltbl_native_max_id ? syscalltbl_native[id]: NULL;\r\n}\r\nint syscalltbl__id(struct syscalltbl *tbl, const char *name)\r\n{\r\nstruct syscall *sc = bsearch(name, tbl->syscalls.entries,\r\ntbl->syscalls.nr_entries, sizeof(*sc),\r\nsyscallcmpname);\r\nreturn sc ? sc->id : -1;\r\n}\r\nstruct syscalltbl *syscalltbl__new(void)\r\n{\r\nstruct syscalltbl *tbl = malloc(sizeof(*tbl));\r\nif (tbl)\r\ntbl->audit_machine = audit_detect_machine();\r\nreturn tbl;\r\n}\r\nvoid syscalltbl__delete(struct syscalltbl *tbl)\r\n{\r\nfree(tbl);\r\n}\r\nconst char *syscalltbl__name(const struct syscalltbl *tbl, int id)\r\n{\r\nreturn audit_syscall_to_name(id, tbl->audit_machine);\r\n}\r\nint syscalltbl__id(struct syscalltbl *tbl, const char *name)\r\n{\r\nreturn audit_name_to_syscall(name, tbl->audit_machine);\r\n}

static inline int info_blk_hdr__size(enum diag204_format type)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn sizeof(struct diag204_info_blk_hdr);\r\nelse\r\nreturn sizeof(struct diag204_x_info_blk_hdr);\r\n}\r\nstatic inline __u8 info_blk_hdr__npar(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_info_blk_hdr *)hdr)->npar;\r\nelse\r\nreturn ((struct diag204_x_info_blk_hdr *)hdr)->npar;\r\n}\r\nstatic inline __u8 info_blk_hdr__flags(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_info_blk_hdr *)hdr)->flags;\r\nelse\r\nreturn ((struct diag204_x_info_blk_hdr *)hdr)->flags;\r\n}\r\nstatic inline __u16 info_blk_hdr__pcpus(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_info_blk_hdr *)hdr)->phys_cpus;\r\nelse\r\nreturn ((struct diag204_x_info_blk_hdr *)hdr)->phys_cpus;\r\n}\r\nstatic inline int part_hdr__size(enum diag204_format type)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn sizeof(struct diag204_part_hdr);\r\nelse\r\nreturn sizeof(struct diag204_x_part_hdr);\r\n}\r\nstatic inline __u8 part_hdr__rcpus(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_part_hdr *)hdr)->cpus;\r\nelse\r\nreturn ((struct diag204_x_part_hdr *)hdr)->rcpus;\r\n}\r\nstatic inline void part_hdr__part_name(enum diag204_format type, void *hdr,\r\nchar *name)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nmemcpy(name, ((struct diag204_part_hdr *)hdr)->part_name,\r\nDIAG204_LPAR_NAME_LEN);\r\nelse\r\nmemcpy(name, ((struct diag204_x_part_hdr *)hdr)->part_name,\r\nDIAG204_LPAR_NAME_LEN);\r\nEBCASC(name, DIAG204_LPAR_NAME_LEN);\r\nname[DIAG204_LPAR_NAME_LEN] = 0;\r\nstrim(name);\r\n}\r\nstatic inline int cpu_info__size(enum diag204_format type)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn sizeof(struct diag204_cpu_info);\r\nelse\r\nreturn sizeof(struct diag204_x_cpu_info);\r\n}\r\nstatic inline __u8 cpu_info__ctidx(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_cpu_info *)hdr)->ctidx;\r\nelse\r\nreturn ((struct diag204_x_cpu_info *)hdr)->ctidx;\r\n}\r\nstatic inline __u16 cpu_info__cpu_addr(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_cpu_info *)hdr)->cpu_addr;\r\nelse\r\nreturn ((struct diag204_x_cpu_info *)hdr)->cpu_addr;\r\n}\r\nstatic inline __u64 cpu_info__acc_time(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_cpu_info *)hdr)->acc_time;\r\nelse\r\nreturn ((struct diag204_x_cpu_info *)hdr)->acc_time;\r\n}\r\nstatic inline __u64 cpu_info__lp_time(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_cpu_info *)hdr)->lp_time;\r\nelse\r\nreturn ((struct diag204_x_cpu_info *)hdr)->lp_time;\r\n}\r\nstatic inline __u64 cpu_info__online_time(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn 0;\r\nelse\r\nreturn ((struct diag204_x_cpu_info *)hdr)->online_time;\r\n}\r\nstatic inline int phys_hdr__size(enum diag204_format type)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn sizeof(struct diag204_phys_hdr);\r\nelse\r\nreturn sizeof(struct diag204_x_phys_hdr);\r\n}\r\nstatic inline __u8 phys_hdr__cpus(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_phys_hdr *)hdr)->cpus;\r\nelse\r\nreturn ((struct diag204_x_phys_hdr *)hdr)->cpus;\r\n}\r\nstatic inline int phys_cpu__size(enum diag204_format type)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn sizeof(struct diag204_phys_cpu);\r\nelse\r\nreturn sizeof(struct diag204_x_phys_cpu);\r\n}\r\nstatic inline __u16 phys_cpu__cpu_addr(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_phys_cpu *)hdr)->cpu_addr;\r\nelse\r\nreturn ((struct diag204_x_phys_cpu *)hdr)->cpu_addr;\r\n}\r\nstatic inline __u64 phys_cpu__mgm_time(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_phys_cpu *)hdr)->mgm_time;\r\nelse\r\nreturn ((struct diag204_x_phys_cpu *)hdr)->mgm_time;\r\n}\r\nstatic inline __u64 phys_cpu__ctidx(enum diag204_format type, void *hdr)\r\n{\r\nif (type == DIAG204_INFO_SIMPLE)\r\nreturn ((struct diag204_phys_cpu *)hdr)->ctidx;\r\nelse\r\nreturn ((struct diag204_x_phys_cpu *)hdr)->ctidx;\r\n}\r\nstatic void diag204_free_buffer(void)\r\n{\r\nif (!diag204_buf)\r\nreturn;\r\nif (diag204_buf_vmalloc) {\r\nvfree(diag204_buf_vmalloc);\r\ndiag204_buf_vmalloc = NULL;\r\n} else {\r\nfree_pages((unsigned long) diag204_buf, 0);\r\n}\r\ndiag204_buf = NULL;\r\n}\r\nstatic void *page_align_ptr(void *ptr)\r\n{\r\nreturn (void *) PAGE_ALIGN((unsigned long) ptr);\r\n}\r\nstatic void *diag204_alloc_vbuf(int pages)\r\n{\r\ndiag204_buf_vmalloc = vmalloc(PAGE_SIZE * (pages + 1));\r\nif (!diag204_buf_vmalloc)\r\nreturn ERR_PTR(-ENOMEM);\r\ndiag204_buf = page_align_ptr(diag204_buf_vmalloc);\r\ndiag204_buf_pages = pages;\r\nreturn diag204_buf;\r\n}\r\nstatic void *diag204_alloc_rbuf(void)\r\n{\r\ndiag204_buf = (void*)__get_free_pages(GFP_KERNEL,0);\r\nif (!diag204_buf)\r\nreturn ERR_PTR(-ENOMEM);\r\ndiag204_buf_pages = 1;\r\nreturn diag204_buf;\r\n}\r\nstatic void *diag204_get_buffer(enum diag204_format fmt, int *pages)\r\n{\r\nif (diag204_buf) {\r\n*pages = diag204_buf_pages;\r\nreturn diag204_buf;\r\n}\r\nif (fmt == DIAG204_INFO_SIMPLE) {\r\n*pages = 1;\r\nreturn diag204_alloc_rbuf();\r\n} else {\r\n*pages = diag204((unsigned long)DIAG204_SUBC_RSI |\r\n(unsigned long)DIAG204_INFO_EXT, 0, NULL);\r\nif (*pages <= 0)\r\nreturn ERR_PTR(-ENOSYS);\r\nelse\r\nreturn diag204_alloc_vbuf(*pages);\r\n}\r\n}\r\nstatic int diag204_probe(void)\r\n{\r\nvoid *buf;\r\nint pages, rc;\r\nbuf = diag204_get_buffer(DIAG204_INFO_EXT, &pages);\r\nif (!IS_ERR(buf)) {\r\nif (diag204((unsigned long)DIAG204_SUBC_STIB7 |\r\n(unsigned long)DIAG204_INFO_EXT, pages, buf) >= 0) {\r\ndiag204_store_sc = DIAG204_SUBC_STIB7;\r\ndiag204_info_type = DIAG204_INFO_EXT;\r\ngoto out;\r\n}\r\nif (diag204((unsigned long)DIAG204_SUBC_STIB6 |\r\n(unsigned long)DIAG204_INFO_EXT, pages, buf) >= 0) {\r\ndiag204_store_sc = DIAG204_SUBC_STIB6;\r\ndiag204_info_type = DIAG204_INFO_EXT;\r\ngoto out;\r\n}\r\ndiag204_free_buffer();\r\n}\r\nbuf = diag204_get_buffer(DIAG204_INFO_SIMPLE, &pages);\r\nif (IS_ERR(buf)) {\r\nrc = PTR_ERR(buf);\r\ngoto fail_alloc;\r\n}\r\nif (diag204((unsigned long)DIAG204_SUBC_STIB4 |\r\n(unsigned long)DIAG204_INFO_SIMPLE, pages, buf) >= 0) {\r\ndiag204_store_sc = DIAG204_SUBC_STIB4;\r\ndiag204_info_type = DIAG204_INFO_SIMPLE;\r\ngoto out;\r\n} else {\r\nrc = -ENOSYS;\r\ngoto fail_store;\r\n}\r\nout:\r\nrc = 0;\r\nfail_store:\r\ndiag204_free_buffer();\r\nfail_alloc:\r\nreturn rc;\r\n}\r\nstatic int diag204_do_store(void *buf, int pages)\r\n{\r\nint rc;\r\nrc = diag204((unsigned long) diag204_store_sc |\r\n(unsigned long) diag204_info_type, pages, buf);\r\nreturn rc < 0 ? -ENOSYS : 0;\r\n}\r\nstatic void *diag204_store(void)\r\n{\r\nvoid *buf;\r\nint pages, rc;\r\nbuf = diag204_get_buffer(diag204_info_type, &pages);\r\nif (IS_ERR(buf))\r\ngoto out;\r\nrc = diag204_do_store(buf, pages);\r\nif (rc)\r\nreturn ERR_PTR(rc);\r\nout:\r\nreturn buf;\r\n}\r\nstatic int diag224_get_name_table(void)\r\n{\r\ndiag224_cpu_names = (char *) __get_free_page(GFP_KERNEL | GFP_DMA);\r\nif (!diag224_cpu_names)\r\nreturn -ENOMEM;\r\nif (diag224(diag224_cpu_names)) {\r\nfree_page((unsigned long) diag224_cpu_names);\r\nreturn -EOPNOTSUPP;\r\n}\r\nEBCASC(diag224_cpu_names + 16, (*diag224_cpu_names + 1) * 16);\r\nreturn 0;\r\n}\r\nstatic void diag224_delete_name_table(void)\r\n{\r\nfree_page((unsigned long) diag224_cpu_names);\r\n}\r\nstatic int diag224_idx2name(int index, char *name)\r\n{\r\nmemcpy(name, diag224_cpu_names + ((index + 1) * DIAG204_CPU_NAME_LEN),\r\nDIAG204_CPU_NAME_LEN);\r\nname[DIAG204_CPU_NAME_LEN] = 0;\r\nstrim(name);\r\nreturn 0;\r\n}\r\nstatic int dbfs_d204_create(void **data, void **data_free_ptr, size_t *size)\r\n{\r\nstruct dbfs_d204 *d204;\r\nint rc, buf_size;\r\nvoid *base;\r\nbuf_size = PAGE_SIZE * (diag204_buf_pages + 1) + sizeof(d204->hdr);\r\nbase = vzalloc(buf_size);\r\nif (!base)\r\nreturn -ENOMEM;\r\nd204 = page_align_ptr(base + sizeof(d204->hdr)) - sizeof(d204->hdr);\r\nrc = diag204_do_store(d204->buf, diag204_buf_pages);\r\nif (rc) {\r\nvfree(base);\r\nreturn rc;\r\n}\r\nd204->hdr.version = DBFS_D204_HDR_VERSION;\r\nd204->hdr.len = PAGE_SIZE * diag204_buf_pages;\r\nd204->hdr.sc = diag204_store_sc;\r\n*data = d204;\r\n*data_free_ptr = base;\r\n*size = d204->hdr.len + sizeof(struct dbfs_d204_hdr);\r\nreturn 0;\r\n}\r\n__init int hypfs_diag_init(void)\r\n{\r\nint rc;\r\nif (diag204_probe()) {\r\npr_err("The hardware system does not support hypfs\n");\r\nreturn -ENODATA;\r\n}\r\nif (diag204_info_type == DIAG204_INFO_EXT) {\r\nrc = hypfs_dbfs_create_file(&dbfs_file_d204);\r\nif (rc)\r\nreturn rc;\r\n}\r\nif (MACHINE_IS_LPAR) {\r\nrc = diag224_get_name_table();\r\nif (rc) {\r\npr_err("The hardware system does not provide all "\r\n"functions required by hypfs\n");\r\ndebugfs_remove(dbfs_d204_file);\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid hypfs_diag_exit(void)\r\n{\r\ndebugfs_remove(dbfs_d204_file);\r\ndiag224_delete_name_table();\r\ndiag204_free_buffer();\r\nhypfs_dbfs_remove_file(&dbfs_file_d204);\r\n}\r\nstatic int hypfs_create_cpu_files(struct dentry *cpus_dir, void *cpu_info)\r\n{\r\nstruct dentry *cpu_dir;\r\nchar buffer[TMP_SIZE];\r\nvoid *rc;\r\nsnprintf(buffer, TMP_SIZE, "%d", cpu_info__cpu_addr(diag204_info_type,\r\ncpu_info));\r\ncpu_dir = hypfs_mkdir(cpus_dir, buffer);\r\nrc = hypfs_create_u64(cpu_dir, "mgmtime",\r\ncpu_info__acc_time(diag204_info_type, cpu_info) -\r\ncpu_info__lp_time(diag204_info_type, cpu_info));\r\nif (IS_ERR(rc))\r\nreturn PTR_ERR(rc);\r\nrc = hypfs_create_u64(cpu_dir, "cputime",\r\ncpu_info__lp_time(diag204_info_type, cpu_info));\r\nif (IS_ERR(rc))\r\nreturn PTR_ERR(rc);\r\nif (diag204_info_type == DIAG204_INFO_EXT) {\r\nrc = hypfs_create_u64(cpu_dir, "onlinetime",\r\ncpu_info__online_time(diag204_info_type,\r\ncpu_info));\r\nif (IS_ERR(rc))\r\nreturn PTR_ERR(rc);\r\n}\r\ndiag224_idx2name(cpu_info__ctidx(diag204_info_type, cpu_info), buffer);\r\nrc = hypfs_create_str(cpu_dir, "type", buffer);\r\nreturn PTR_RET(rc);\r\n}\r\nstatic void *hypfs_create_lpar_files(struct dentry *systems_dir, void *part_hdr)\r\n{\r\nstruct dentry *cpus_dir;\r\nstruct dentry *lpar_dir;\r\nchar lpar_name[DIAG204_LPAR_NAME_LEN + 1];\r\nvoid *cpu_info;\r\nint i;\r\npart_hdr__part_name(diag204_info_type, part_hdr, lpar_name);\r\nlpar_name[DIAG204_LPAR_NAME_LEN] = 0;\r\nlpar_dir = hypfs_mkdir(systems_dir, lpar_name);\r\nif (IS_ERR(lpar_dir))\r\nreturn lpar_dir;\r\ncpus_dir = hypfs_mkdir(lpar_dir, "cpus");\r\nif (IS_ERR(cpus_dir))\r\nreturn cpus_dir;\r\ncpu_info = part_hdr + part_hdr__size(diag204_info_type);\r\nfor (i = 0; i < part_hdr__rcpus(diag204_info_type, part_hdr); i++) {\r\nint rc;\r\nrc = hypfs_create_cpu_files(cpus_dir, cpu_info);\r\nif (rc)\r\nreturn ERR_PTR(rc);\r\ncpu_info += cpu_info__size(diag204_info_type);\r\n}\r\nreturn cpu_info;\r\n}\r\nstatic int hypfs_create_phys_cpu_files(struct dentry *cpus_dir, void *cpu_info)\r\n{\r\nstruct dentry *cpu_dir;\r\nchar buffer[TMP_SIZE];\r\nvoid *rc;\r\nsnprintf(buffer, TMP_SIZE, "%i", phys_cpu__cpu_addr(diag204_info_type,\r\ncpu_info));\r\ncpu_dir = hypfs_mkdir(cpus_dir, buffer);\r\nif (IS_ERR(cpu_dir))\r\nreturn PTR_ERR(cpu_dir);\r\nrc = hypfs_create_u64(cpu_dir, "mgmtime",\r\nphys_cpu__mgm_time(diag204_info_type, cpu_info));\r\nif (IS_ERR(rc))\r\nreturn PTR_ERR(rc);\r\ndiag224_idx2name(phys_cpu__ctidx(diag204_info_type, cpu_info), buffer);\r\nrc = hypfs_create_str(cpu_dir, "type", buffer);\r\nreturn PTR_RET(rc);\r\n}\r\nstatic void *hypfs_create_phys_files(struct dentry *parent_dir, void *phys_hdr)\r\n{\r\nint i;\r\nvoid *cpu_info;\r\nstruct dentry *cpus_dir;\r\ncpus_dir = hypfs_mkdir(parent_dir, "cpus");\r\nif (IS_ERR(cpus_dir))\r\nreturn cpus_dir;\r\ncpu_info = phys_hdr + phys_hdr__size(diag204_info_type);\r\nfor (i = 0; i < phys_hdr__cpus(diag204_info_type, phys_hdr); i++) {\r\nint rc;\r\nrc = hypfs_create_phys_cpu_files(cpus_dir, cpu_info);\r\nif (rc)\r\nreturn ERR_PTR(rc);\r\ncpu_info += phys_cpu__size(diag204_info_type);\r\n}\r\nreturn cpu_info;\r\n}\r\nint hypfs_diag_create_files(struct dentry *root)\r\n{\r\nstruct dentry *systems_dir, *hyp_dir;\r\nvoid *time_hdr, *part_hdr;\r\nint i, rc;\r\nvoid *buffer, *ptr;\r\nbuffer = diag204_store();\r\nif (IS_ERR(buffer))\r\nreturn PTR_ERR(buffer);\r\nsystems_dir = hypfs_mkdir(root, "systems");\r\nif (IS_ERR(systems_dir)) {\r\nrc = PTR_ERR(systems_dir);\r\ngoto err_out;\r\n}\r\ntime_hdr = (struct x_info_blk_hdr *)buffer;\r\npart_hdr = time_hdr + info_blk_hdr__size(diag204_info_type);\r\nfor (i = 0; i < info_blk_hdr__npar(diag204_info_type, time_hdr); i++) {\r\npart_hdr = hypfs_create_lpar_files(systems_dir, part_hdr);\r\nif (IS_ERR(part_hdr)) {\r\nrc = PTR_ERR(part_hdr);\r\ngoto err_out;\r\n}\r\n}\r\nif (info_blk_hdr__flags(diag204_info_type, time_hdr) &\r\nDIAG204_LPAR_PHYS_FLG) {\r\nptr = hypfs_create_phys_files(root, part_hdr);\r\nif (IS_ERR(ptr)) {\r\nrc = PTR_ERR(ptr);\r\ngoto err_out;\r\n}\r\n}\r\nhyp_dir = hypfs_mkdir(root, "hyp");\r\nif (IS_ERR(hyp_dir)) {\r\nrc = PTR_ERR(hyp_dir);\r\ngoto err_out;\r\n}\r\nptr = hypfs_create_str(hyp_dir, "type", "LPAR Hypervisor");\r\nif (IS_ERR(ptr)) {\r\nrc = PTR_ERR(ptr);\r\ngoto err_out;\r\n}\r\nrc = 0;\r\nerr_out:\r\nreturn rc;\r\n}

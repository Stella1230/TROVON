static bool tomoyo_check_env_acl(struct tomoyo_request_info *r,\r\nconst struct tomoyo_acl_info *ptr)\r\n{\r\nconst struct tomoyo_env_acl *acl =\r\ncontainer_of(ptr, typeof(*acl), head);\r\nreturn tomoyo_path_matches_pattern(r->param.environ.name, acl->env);\r\n}\r\nstatic int tomoyo_audit_env_log(struct tomoyo_request_info *r)\r\n{\r\nreturn tomoyo_supervisor(r, "misc env %s\n",\r\nr->param.environ.name->name);\r\n}\r\nint tomoyo_env_perm(struct tomoyo_request_info *r, const char *env)\r\n{\r\nstruct tomoyo_path_info environ;\r\nint error;\r\nif (!env || !*env)\r\nreturn 0;\r\nenviron.name = env;\r\ntomoyo_fill_path_info(&environ);\r\nr->param_type = TOMOYO_TYPE_ENV_ACL;\r\nr->param.environ.name = &environ;\r\ndo {\r\ntomoyo_check_acl(r, tomoyo_check_env_acl);\r\nerror = tomoyo_audit_env_log(r);\r\n} while (error == TOMOYO_RETRY_REQUEST);\r\nreturn error;\r\n}\r\nstatic bool tomoyo_same_env_acl(const struct tomoyo_acl_info *a,\r\nconst struct tomoyo_acl_info *b)\r\n{\r\nconst struct tomoyo_env_acl *p1 = container_of(a, typeof(*p1), head);\r\nconst struct tomoyo_env_acl *p2 = container_of(b, typeof(*p2), head);\r\nreturn p1->env == p2->env;\r\n}\r\nstatic int tomoyo_write_env(struct tomoyo_acl_param *param)\r\n{\r\nstruct tomoyo_env_acl e = { .head.type = TOMOYO_TYPE_ENV_ACL };\r\nint error = -ENOMEM;\r\nconst char *data = tomoyo_read_token(param);\r\nif (!tomoyo_correct_word(data) || strchr(data, '='))\r\nreturn -EINVAL;\r\ne.env = tomoyo_get_name(data);\r\nif (!e.env)\r\nreturn error;\r\nerror = tomoyo_update_domain(&e.head, sizeof(e), param,\r\ntomoyo_same_env_acl, NULL);\r\ntomoyo_put_name(e.env);\r\nreturn error;\r\n}\r\nint tomoyo_write_misc(struct tomoyo_acl_param *param)\r\n{\r\nif (tomoyo_str_starts(&param->data, "env "))\r\nreturn tomoyo_write_env(param);\r\nreturn -EINVAL;\r\n}

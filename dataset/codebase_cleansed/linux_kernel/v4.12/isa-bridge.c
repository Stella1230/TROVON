static void pci_process_ISA_OF_ranges(struct device_node *isa_node,\r\nunsigned long phb_io_base_phys)\r\n{\r\nstruct pci_address {\r\nu32 a_hi;\r\nu32 a_mid;\r\nu32 a_lo;\r\n};\r\nstruct isa_address {\r\nu32 a_hi;\r\nu32 a_lo;\r\n};\r\nstruct isa_range {\r\nstruct isa_address isa_addr;\r\nstruct pci_address pci_addr;\r\nunsigned int size;\r\n};\r\nconst struct isa_range *range;\r\nunsigned long pci_addr;\r\nunsigned int isa_addr;\r\nunsigned int size;\r\nint rlen = 0;\r\nrange = of_get_property(isa_node, "ranges", &rlen);\r\nif (range == NULL || (rlen < sizeof(struct isa_range)))\r\ngoto inval_range;\r\nif ((range->isa_addr.a_hi & ISA_SPACE_MASK) != ISA_SPACE_IO) {\r\nrange++;\r\nrlen -= sizeof(struct isa_range);\r\nif (rlen < sizeof(struct isa_range))\r\ngoto inval_range;\r\n}\r\nif ((range->isa_addr.a_hi & ISA_SPACE_MASK) != ISA_SPACE_IO)\r\ngoto inval_range;\r\nisa_addr = range->isa_addr.a_lo;\r\npci_addr = (unsigned long) range->pci_addr.a_mid << 32 |\r\nrange->pci_addr.a_lo;\r\nif ((pci_addr != 0) || (isa_addr != 0)) {\r\nprintk(KERN_ERR "unexpected isa to pci mapping: %s\n",\r\n__func__);\r\nreturn;\r\n}\r\nsize = PAGE_ALIGN(range->size);\r\nif (size > 0x10000)\r\nsize = 0x10000;\r\n__ioremap_at(phb_io_base_phys, (void *)ISA_IO_BASE,\r\nsize, pgprot_val(pgprot_noncached(__pgprot(0))));\r\nreturn;\r\ninval_range:\r\nprintk(KERN_ERR "no ISA IO ranges or unexpected isa range, "\r\n"mapping 64k\n");\r\n__ioremap_at(phb_io_base_phys, (void *)ISA_IO_BASE,\r\n0x10000, pgprot_val(pgprot_noncached(__pgprot(0))));\r\n}\r\nvoid __init isa_bridge_find_early(struct pci_controller *hose)\r\n{\r\nstruct device_node *np, *parent = NULL, *tmp;\r\nif (isa_bridge_devnode != NULL)\r\nreturn;\r\nfor_each_node_by_type(np, "isa") {\r\nfor (parent = of_get_parent(np); parent;) {\r\nif (parent == hose->dn) {\r\nof_node_put(parent);\r\nbreak;\r\n}\r\ntmp = parent;\r\nparent = of_get_parent(parent);\r\nof_node_put(tmp);\r\n}\r\nif (parent != NULL)\r\nbreak;\r\n}\r\nif (np == NULL)\r\nreturn;\r\nisa_bridge_devnode = np;\r\npci_process_ISA_OF_ranges(np, hose->io_base_phys);\r\nisa_io_base = ISA_IO_BASE;\r\npr_debug("ISA bridge (early) is %s\n", np->full_name);\r\n}\r\nvoid __init isa_bridge_init_non_pci(struct device_node *np)\r\n{\r\nconst __be32 *ranges, *pbasep = NULL;\r\nint rlen, i, rs;\r\nu32 na, ns, pna;\r\nu64 cbase, pbase, size = 0;\r\nif (isa_bridge_devnode != NULL)\r\nreturn;\r\npna = of_n_addr_cells(np);\r\nif (of_property_read_u32(np, "#address-cells", &na) ||\r\nof_property_read_u32(np, "#size-cells", &ns)) {\r\npr_warn("ISA: Non-PCI bridge %s is missing address format\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nif (na != 2 || ns != 1) {\r\npr_warn("ISA: Non-PCI bridge %s has unsupported address format\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nrs = na + ns + pna;\r\nranges = of_get_property(np, "ranges", &rlen);\r\nif (ranges == NULL || rlen < rs) {\r\npr_warn("ISA: Non-PCI bridge %s has absent or invalid ranges\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nfor (i = 0; (i + rs - 1) < rlen; i += rs) {\r\nif (be32_to_cpup(ranges + i) != 1)\r\ncontinue;\r\ncbase = be32_to_cpup(ranges + i + 1);\r\nsize = of_read_number(ranges + i + na + pna, ns);\r\npbasep = ranges + i + na;\r\nbreak;\r\n}\r\nif (!size || !pbasep) {\r\npr_warn("ISA: Non-PCI bridge %s has no usable IO range\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nsize = PAGE_ALIGN(size);\r\nif (size > 0x10000)\r\nsize = 0x10000;\r\npbase = of_translate_address(np, pbasep);\r\nif (pbase == OF_BAD_ADDR) {\r\npr_warn("ISA: Non-PCI bridge %s failed to translate IO base\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nif ((cbase & ~PAGE_MASK) || (pbase & ~PAGE_MASK)) {\r\npr_warn("ISA: Non-PCI bridge %s has non aligned IO range\n",\r\nnp->full_name);\r\nreturn;\r\n}\r\nisa_bridge_devnode = np;\r\nisa_io_base = ISA_IO_BASE;\r\n__ioremap_at(pbase, (void *)ISA_IO_BASE,\r\nsize, pgprot_val(pgprot_noncached(__pgprot(0))));\r\npr_debug("ISA: Non-PCI bridge is %s\n", np->full_name);\r\n}\r\nstatic void isa_bridge_find_late(struct pci_dev *pdev,\r\nstruct device_node *devnode)\r\n{\r\nstruct pci_controller *hose = pci_bus_to_host(pdev->bus);\r\nisa_bridge_devnode = of_node_get(devnode);\r\nisa_bridge_pcidev = pdev;\r\npci_process_ISA_OF_ranges(devnode, hose->io_base_phys);\r\nisa_io_base = ISA_IO_BASE;\r\npr_debug("ISA bridge (late) is %s on %s\n",\r\ndevnode->full_name, pci_name(pdev));\r\n}\r\nstatic void isa_bridge_remove(void)\r\n{\r\npr_debug("ISA bridge removed !\n");\r\nisa_io_base = ISA_IO_BASE;\r\nof_node_put(isa_bridge_devnode);\r\nisa_bridge_devnode = NULL;\r\nisa_bridge_pcidev = NULL;\r\n__iounmap_at((void *)ISA_IO_BASE, 0x10000);\r\n}\r\nstatic int isa_bridge_notify(struct notifier_block *nb, unsigned long action,\r\nvoid *data)\r\n{\r\nstruct device *dev = data;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct device_node *devnode = pci_device_to_OF_node(pdev);\r\nswitch(action) {\r\ncase BUS_NOTIFY_ADD_DEVICE:\r\nif (isa_bridge_devnode && isa_bridge_devnode == devnode &&\r\n!isa_bridge_pcidev) {\r\npr_debug("ISA bridge PCI attached: %s\n",\r\npci_name(pdev));\r\nisa_bridge_pcidev = pdev;\r\n}\r\nif (!isa_bridge_devnode && devnode && devnode->type &&\r\n!strcmp(devnode->type, "isa"))\r\nisa_bridge_find_late(pdev, devnode);\r\nreturn 0;\r\ncase BUS_NOTIFY_DEL_DEVICE:\r\nif (pdev == isa_bridge_pcidev ||\r\n(devnode && devnode == isa_bridge_devnode))\r\nisa_bridge_remove();\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init isa_bridge_init(void)\r\n{\r\nbus_register_notifier(&pci_bus_type, &isa_bridge_notifier);\r\nreturn 0;\r\n}

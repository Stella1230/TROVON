static int cbaf_check(struct cbaf *cbaf)\r\n{\r\nint result;\r\nstruct device *dev = &cbaf->usb_iface->dev;\r\nstruct wusb_cbaf_assoc_info *assoc_info;\r\nstruct wusb_cbaf_assoc_request *assoc_request;\r\nsize_t assoc_size;\r\nvoid *itr, *top;\r\nint ar_rhi = 0, ar_assoc = 0;\r\nresult = usb_control_msg(\r\ncbaf->usb_dev, usb_rcvctrlpipe(cbaf->usb_dev, 0),\r\nCBAF_REQ_GET_ASSOCIATION_INFORMATION,\r\nUSB_DIR_IN | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\r\n0, cbaf->usb_iface->cur_altsetting->desc.bInterfaceNumber,\r\ncbaf->buffer, cbaf->buffer_size, USB_CTRL_GET_TIMEOUT);\r\nif (result < 0) {\r\ndev_err(dev, "Cannot get available association types: %d\n",\r\nresult);\r\nreturn result;\r\n}\r\nassoc_info = cbaf->buffer;\r\nif (result < sizeof(*assoc_info)) {\r\ndev_err(dev, "Not enough data to decode association info "\r\n"header (%zu vs %zu bytes required)\n",\r\n(size_t)result, sizeof(*assoc_info));\r\nreturn result;\r\n}\r\nassoc_size = le16_to_cpu(assoc_info->Length);\r\nif (result < assoc_size) {\r\ndev_err(dev, "Not enough data to decode association info "\r\n"(%zu vs %zu bytes required)\n",\r\n(size_t)assoc_size, sizeof(*assoc_info));\r\nreturn result;\r\n}\r\nitr = cbaf->buffer + sizeof(*assoc_info);\r\ntop = cbaf->buffer + assoc_size;\r\ndev_dbg(dev, "Found %u association requests (%zu bytes)\n",\r\nassoc_info->NumAssociationRequests, assoc_size);\r\nwhile (itr < top) {\r\nu16 ar_type, ar_subtype;\r\nu32 ar_size;\r\nconst char *ar_name;\r\nassoc_request = itr;\r\nif (top - itr < sizeof(*assoc_request)) {\r\ndev_err(dev, "Not enough data to decode association "\r\n"request (%zu vs %zu bytes needed)\n",\r\ntop - itr, sizeof(*assoc_request));\r\nbreak;\r\n}\r\nar_type = le16_to_cpu(assoc_request->AssociationTypeId);\r\nar_subtype = le16_to_cpu(assoc_request->AssociationSubTypeId);\r\nar_size = le32_to_cpu(assoc_request->AssociationTypeInfoSize);\r\nar_name = "unknown";\r\nswitch (ar_type) {\r\ncase AR_TYPE_WUSB:\r\nswitch (ar_subtype) {\r\ncase AR_TYPE_WUSB_RETRIEVE_HOST_INFO:\r\nar_name = "RETRIEVE_HOST_INFO";\r\nar_rhi = 1;\r\nbreak;\r\ncase AR_TYPE_WUSB_ASSOCIATE:\r\nar_name = "ASSOCIATE";\r\nar_assoc = 1;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ndev_dbg(dev, "Association request #%02u: 0x%04x/%04x "\r\n"(%zu bytes): %s\n",\r\nassoc_request->AssociationDataIndex, ar_type,\r\nar_subtype, (size_t)ar_size, ar_name);\r\nitr += sizeof(*assoc_request);\r\n}\r\nif (!ar_rhi) {\r\ndev_err(dev, "Missing RETRIEVE_HOST_INFO association "\r\n"request\n");\r\nreturn -EINVAL;\r\n}\r\nif (!ar_assoc) {\r\ndev_err(dev, "Missing ASSOCIATE association request\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cbaf_send_host_info(struct cbaf *cbaf)\r\n{\r\nstruct wusb_cbaf_host_info *hi;\r\nsize_t name_len;\r\nsize_t hi_size;\r\nhi = cbaf->buffer;\r\nmemset(hi, 0, sizeof(*hi));\r\n*hi = cbaf_host_info_defaults;\r\nhi->CHID = cbaf->chid;\r\nhi->LangID = 0;\r\nstrlcpy(hi->HostFriendlyName, cbaf->host_name, CBA_NAME_LEN);\r\nname_len = strlen(cbaf->host_name);\r\nhi->HostFriendlyName_hdr.len = cpu_to_le16(name_len);\r\nhi_size = sizeof(*hi) + name_len;\r\nreturn usb_control_msg(cbaf->usb_dev,\r\nusb_sndctrlpipe(cbaf->usb_dev, 0),\r\nCBAF_REQ_SET_ASSOCIATION_RESPONSE,\r\nUSB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\r\n0x0101,\r\ncbaf->usb_iface->cur_altsetting->desc.bInterfaceNumber,\r\nhi, hi_size, USB_CTRL_SET_TIMEOUT);\r\n}\r\nstatic int cbaf_cdid_get(struct cbaf *cbaf)\r\n{\r\nint result;\r\nstruct device *dev = &cbaf->usb_iface->dev;\r\nstruct wusb_cbaf_device_info *di;\r\nsize_t needed;\r\ndi = cbaf->buffer;\r\nresult = usb_control_msg(\r\ncbaf->usb_dev, usb_rcvctrlpipe(cbaf->usb_dev, 0),\r\nCBAF_REQ_GET_ASSOCIATION_REQUEST,\r\nUSB_DIR_IN | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\r\n0x0200, cbaf->usb_iface->cur_altsetting->desc.bInterfaceNumber,\r\ndi, cbaf->buffer_size, USB_CTRL_GET_TIMEOUT);\r\nif (result < 0) {\r\ndev_err(dev, "Cannot request device information: %d\n",\r\nresult);\r\nreturn result;\r\n}\r\nneeded = result < sizeof(*di) ? sizeof(*di) : le32_to_cpu(di->Length);\r\nif (result < needed) {\r\ndev_err(dev, "Not enough data in DEVICE_INFO reply (%zu vs "\r\n"%zu bytes needed)\n", (size_t)result, needed);\r\nreturn -ENOENT;\r\n}\r\nstrlcpy(cbaf->device_name, di->DeviceFriendlyName, CBA_NAME_LEN);\r\ncbaf->cdid = di->CDID;\r\ncbaf->device_band_groups = le16_to_cpu(di->BandGroups);\r\nreturn 0;\r\n}\r\nstatic ssize_t cbaf_wusb_chid_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nchar pr_chid[WUSB_CKHDID_STRSIZE];\r\nckhdid_printf(pr_chid, sizeof(pr_chid), &cbaf->chid);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", pr_chid);\r\n}\r\nstatic ssize_t cbaf_wusb_chid_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nssize_t result;\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nresult = sscanf(buf,\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx",\r\n&cbaf->chid.data[0] , &cbaf->chid.data[1],\r\n&cbaf->chid.data[2] , &cbaf->chid.data[3],\r\n&cbaf->chid.data[4] , &cbaf->chid.data[5],\r\n&cbaf->chid.data[6] , &cbaf->chid.data[7],\r\n&cbaf->chid.data[8] , &cbaf->chid.data[9],\r\n&cbaf->chid.data[10], &cbaf->chid.data[11],\r\n&cbaf->chid.data[12], &cbaf->chid.data[13],\r\n&cbaf->chid.data[14], &cbaf->chid.data[15]);\r\nif (result != 16)\r\nreturn -EINVAL;\r\nresult = cbaf_send_host_info(cbaf);\r\nif (result < 0)\r\nreturn result;\r\nresult = cbaf_cdid_get(cbaf);\r\nif (result < 0)\r\nreturn result;\r\nreturn size;\r\n}\r\nstatic ssize_t cbaf_wusb_host_name_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", cbaf->host_name);\r\n}\r\nstatic ssize_t cbaf_wusb_host_name_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nssize_t result;\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nresult = sscanf(buf, "%63s", cbaf->host_name);\r\nif (result != 1)\r\nreturn -EINVAL;\r\nreturn size;\r\n}\r\nstatic ssize_t cbaf_wusb_host_band_groups_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nreturn scnprintf(buf, PAGE_SIZE, "0x%04x\n", cbaf->host_band_groups);\r\n}\r\nstatic ssize_t cbaf_wusb_host_band_groups_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nssize_t result;\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nu16 band_groups = 0;\r\nresult = sscanf(buf, "%04hx", &band_groups);\r\nif (result != 1)\r\nreturn -EINVAL;\r\ncbaf->host_band_groups = band_groups;\r\nreturn size;\r\n}\r\nstatic ssize_t cbaf_wusb_cdid_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nchar pr_cdid[WUSB_CKHDID_STRSIZE];\r\nckhdid_printf(pr_cdid, sizeof(pr_cdid), &cbaf->cdid);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", pr_cdid);\r\n}\r\nstatic ssize_t cbaf_wusb_cdid_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nssize_t result;\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nstruct wusb_ckhdid cdid;\r\nresult = sscanf(buf,\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx",\r\n&cdid.data[0] , &cdid.data[1],\r\n&cdid.data[2] , &cdid.data[3],\r\n&cdid.data[4] , &cdid.data[5],\r\n&cdid.data[6] , &cdid.data[7],\r\n&cdid.data[8] , &cdid.data[9],\r\n&cdid.data[10], &cdid.data[11],\r\n&cdid.data[12], &cdid.data[13],\r\n&cdid.data[14], &cdid.data[15]);\r\nif (result != 16)\r\nreturn -EINVAL;\r\ncbaf->cdid = cdid;\r\nreturn size;\r\n}\r\nstatic ssize_t cbaf_wusb_device_band_groups_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nreturn scnprintf(buf, PAGE_SIZE, "0x%04x\n", cbaf->device_band_groups);\r\n}\r\nstatic ssize_t cbaf_wusb_device_name_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", cbaf->device_name);\r\n}\r\nstatic int cbaf_cc_upload(struct cbaf *cbaf)\r\n{\r\nint result;\r\nstruct device *dev = &cbaf->usb_iface->dev;\r\nstruct wusb_cbaf_cc_data *ccd;\r\nchar pr_cdid[WUSB_CKHDID_STRSIZE];\r\nccd = cbaf->buffer;\r\n*ccd = cbaf_cc_data_defaults;\r\nccd->CHID = cbaf->chid;\r\nccd->CDID = cbaf->cdid;\r\nccd->CK = cbaf->ck;\r\nccd->BandGroups = cpu_to_le16(cbaf->host_band_groups);\r\ndev_dbg(dev, "Trying to upload CC:\n");\r\nckhdid_printf(pr_cdid, sizeof(pr_cdid), &ccd->CHID);\r\ndev_dbg(dev, " CHID %s\n", pr_cdid);\r\nckhdid_printf(pr_cdid, sizeof(pr_cdid), &ccd->CDID);\r\ndev_dbg(dev, " CDID %s\n", pr_cdid);\r\ndev_dbg(dev, " Bandgroups 0x%04x\n", cbaf->host_band_groups);\r\nresult = usb_control_msg(\r\ncbaf->usb_dev, usb_sndctrlpipe(cbaf->usb_dev, 0),\r\nCBAF_REQ_SET_ASSOCIATION_RESPONSE,\r\nUSB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\r\n0x0201, cbaf->usb_iface->cur_altsetting->desc.bInterfaceNumber,\r\nccd, sizeof(*ccd), USB_CTRL_SET_TIMEOUT);\r\nreturn result;\r\n}\r\nstatic ssize_t cbaf_wusb_ck_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nssize_t result;\r\nstruct usb_interface *iface = to_usb_interface(dev);\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nresult = sscanf(buf,\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx",\r\n&cbaf->ck.data[0] , &cbaf->ck.data[1],\r\n&cbaf->ck.data[2] , &cbaf->ck.data[3],\r\n&cbaf->ck.data[4] , &cbaf->ck.data[5],\r\n&cbaf->ck.data[6] , &cbaf->ck.data[7],\r\n&cbaf->ck.data[8] , &cbaf->ck.data[9],\r\n&cbaf->ck.data[10], &cbaf->ck.data[11],\r\n&cbaf->ck.data[12], &cbaf->ck.data[13],\r\n&cbaf->ck.data[14], &cbaf->ck.data[15]);\r\nif (result != 16)\r\nreturn -EINVAL;\r\nresult = cbaf_cc_upload(cbaf);\r\nif (result < 0)\r\nreturn result;\r\nreturn size;\r\n}\r\nstatic int cbaf_probe(struct usb_interface *iface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct cbaf *cbaf;\r\nstruct device *dev = &iface->dev;\r\nint result = -ENOMEM;\r\ncbaf = kzalloc(sizeof(*cbaf), GFP_KERNEL);\r\nif (cbaf == NULL)\r\ngoto error_kzalloc;\r\ncbaf->buffer = kmalloc(512, GFP_KERNEL);\r\nif (cbaf->buffer == NULL)\r\ngoto error_kmalloc_buffer;\r\ncbaf->buffer_size = 512;\r\ncbaf->usb_dev = usb_get_dev(interface_to_usbdev(iface));\r\ncbaf->usb_iface = usb_get_intf(iface);\r\nresult = cbaf_check(cbaf);\r\nif (result < 0) {\r\ndev_err(dev, "This device is not WUSB-CBAF compliant and is not supported yet.\n");\r\ngoto error_check;\r\n}\r\nresult = sysfs_create_group(&dev->kobj, &cbaf_dev_attr_group);\r\nif (result < 0) {\r\ndev_err(dev, "Can't register sysfs attr group: %d\n", result);\r\ngoto error_create_group;\r\n}\r\nusb_set_intfdata(iface, cbaf);\r\nreturn 0;\r\nerror_create_group:\r\nerror_check:\r\nusb_put_intf(iface);\r\nusb_put_dev(cbaf->usb_dev);\r\nkfree(cbaf->buffer);\r\nerror_kmalloc_buffer:\r\nkfree(cbaf);\r\nerror_kzalloc:\r\nreturn result;\r\n}\r\nstatic void cbaf_disconnect(struct usb_interface *iface)\r\n{\r\nstruct cbaf *cbaf = usb_get_intfdata(iface);\r\nstruct device *dev = &iface->dev;\r\nsysfs_remove_group(&dev->kobj, &cbaf_dev_attr_group);\r\nusb_set_intfdata(iface, NULL);\r\nusb_put_intf(iface);\r\nusb_put_dev(cbaf->usb_dev);\r\nkfree(cbaf->buffer);\r\nkzfree(cbaf);\r\n}

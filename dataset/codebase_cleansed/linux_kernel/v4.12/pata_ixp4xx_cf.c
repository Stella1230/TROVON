static int ixp4xx_set_mode(struct ata_link *link, struct ata_device **error)\r\n{\r\nstruct ata_device *dev;\r\nata_for_each_dev(dev, link, ENABLED) {\r\nata_dev_info(dev, "configured for PIO0\n");\r\ndev->pio_mode = XFER_PIO_0;\r\ndev->xfer_mode = XFER_PIO_0;\r\ndev->xfer_shift = ATA_SHIFT_PIO;\r\ndev->flags |= ATA_DFLAG_PIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int ixp4xx_mmio_data_xfer(struct ata_queued_cmd *qc,\r\nunsigned char *buf, unsigned int buflen, int rw)\r\n{\r\nunsigned int i;\r\nunsigned int words = buflen >> 1;\r\nu16 *buf16 = (u16 *) buf;\r\nstruct ata_port *ap = qc->dev->link->ap;\r\nvoid __iomem *mmio = ap->ioaddr.data_addr;\r\nstruct ixp4xx_pata_data *data = dev_get_platdata(ap->host->dev);\r\n*data->cs0_cfg &= ~(0x01);\r\nudelay(100);\r\nif (rw == READ)\r\nfor (i = 0; i < words; i++)\r\nbuf16[i] = readw(mmio);\r\nelse\r\nfor (i = 0; i < words; i++)\r\nwritew(buf16[i], mmio);\r\nif (unlikely(buflen & 0x01)) {\r\nu16 align_buf[1] = { 0 };\r\nunsigned char *trailing_buf = buf + buflen - 1;\r\nif (rw == READ) {\r\nalign_buf[0] = readw(mmio);\r\nmemcpy(trailing_buf, align_buf, 1);\r\n} else {\r\nmemcpy(align_buf, trailing_buf, 1);\r\nwritew(align_buf[0], mmio);\r\n}\r\nwords++;\r\n}\r\nudelay(100);\r\n*data->cs0_cfg |= 0x01;\r\nreturn words << 1;\r\n}\r\nstatic void ixp4xx_setup_port(struct ata_port *ap,\r\nstruct ixp4xx_pata_data *data,\r\nunsigned long raw_cs0, unsigned long raw_cs1)\r\n{\r\nstruct ata_ioports *ioaddr = &ap->ioaddr;\r\nunsigned long raw_cmd = raw_cs0;\r\nunsigned long raw_ctl = raw_cs1 + 0x06;\r\nioaddr->cmd_addr = data->cs0;\r\nioaddr->altstatus_addr = data->cs1 + 0x06;\r\nioaddr->ctl_addr = data->cs1 + 0x06;\r\nata_sff_std_ports(ioaddr);\r\n#ifndef __ARMEB__\r\n*(unsigned long *)&ioaddr->data_addr ^= 0x02;\r\n*(unsigned long *)&ioaddr->cmd_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->altstatus_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->ctl_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->error_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->feature_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->nsect_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->lbal_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->lbam_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->lbah_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->device_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->status_addr ^= 0x03;\r\n*(unsigned long *)&ioaddr->command_addr ^= 0x03;\r\nraw_cmd ^= 0x03;\r\nraw_ctl ^= 0x03;\r\n#endif\r\nata_port_desc(ap, "cmd 0x%lx ctl 0x%lx", raw_cmd, raw_ctl);\r\n}\r\nstatic int ixp4xx_pata_probe(struct platform_device *pdev)\r\n{\r\nunsigned int irq;\r\nstruct resource *cs0, *cs1;\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nstruct ixp4xx_pata_data *data = dev_get_platdata(&pdev->dev);\r\nint ret;\r\ncs0 = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ncs1 = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!cs0 || !cs1)\r\nreturn -EINVAL;\r\nhost = ata_host_alloc(&pdev->dev, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\nret = dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(32));\r\nif (ret)\r\nreturn ret;\r\ndata->cs0 = devm_ioremap(&pdev->dev, cs0->start, 0x1000);\r\ndata->cs1 = devm_ioremap(&pdev->dev, cs1->start, 0x1000);\r\nif (!data->cs0 || !data->cs1)\r\nreturn -ENOMEM;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq)\r\nirq_set_irq_type(irq, IRQ_TYPE_EDGE_RISING);\r\n*data->cs0_cfg = data->cs0_bits;\r\n*data->cs1_cfg = data->cs1_bits;\r\nap = host->ports[0];\r\nap->ops = &ixp4xx_port_ops;\r\nap->pio_mask = ATA_PIO4;\r\nap->flags |= ATA_FLAG_NO_ATAPI;\r\nixp4xx_setup_port(ap, data, cs0->start, cs1->start);\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nreturn ata_host_activate(host, irq, ata_sff_interrupt, 0, &ixp4xx_sht);\r\n}

static int powernv_get_led_type(const char *led_type_desc)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(led_type_map); i++)\r\nif (!strcmp(led_type_map[i].desc, led_type_desc))\r\nreturn led_type_map[i].type;\r\nreturn -1;\r\n}\r\nstatic int powernv_led_set(struct powernv_led_data *powernv_led,\r\nenum led_brightness value)\r\n{\r\nint rc, token;\r\nu64 led_mask, led_value = 0;\r\n__be64 max_type;\r\nstruct opal_msg msg;\r\nstruct device *dev = powernv_led->cdev.dev;\r\nstruct powernv_led_common *powernv_led_common = powernv_led->common;\r\nmax_type = powernv_led_common->max_led_type;\r\nled_mask = OPAL_SLOT_LED_STATE_ON << powernv_led->led_type;\r\nif (value)\r\nled_value = led_mask;\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\nif (token != -ERESTARTSYS)\r\ndev_err(dev, "%s: Couldn't get OPAL async token\n",\r\n__func__);\r\nreturn token;\r\n}\r\nrc = opal_leds_set_ind(token, powernv_led->loc_code,\r\nled_mask, led_value, &max_type);\r\nif (rc != OPAL_ASYNC_COMPLETION) {\r\ndev_err(dev, "%s: OPAL set LED call failed for %s [rc=%d]\n",\r\n__func__, powernv_led->loc_code, rc);\r\ngoto out_token;\r\n}\r\nrc = opal_async_wait_response(token, &msg);\r\nif (rc) {\r\ndev_err(dev,\r\n"%s: Failed to wait for the async response [rc=%d]\n",\r\n__func__, rc);\r\ngoto out_token;\r\n}\r\nrc = opal_get_async_rc(msg);\r\nif (rc != OPAL_SUCCESS)\r\ndev_err(dev, "%s : OAPL async call returned failed [rc=%d]\n",\r\n__func__, rc);\r\nout_token:\r\nopal_async_release_token(token);\r\nreturn rc;\r\n}\r\nstatic enum led_brightness powernv_led_get(struct powernv_led_data *powernv_led)\r\n{\r\nint rc;\r\n__be64 mask, value, max_type;\r\nu64 led_mask, led_value;\r\nstruct device *dev = powernv_led->cdev.dev;\r\nstruct powernv_led_common *powernv_led_common = powernv_led->common;\r\nmask = cpu_to_be64(0);\r\nvalue = cpu_to_be64(0);\r\nmax_type = powernv_led_common->max_led_type;\r\nrc = opal_leds_get_ind(powernv_led->loc_code,\r\n&mask, &value, &max_type);\r\nif (rc != OPAL_SUCCESS && rc != OPAL_PARTIAL) {\r\ndev_err(dev, "%s: OPAL get led call failed [rc=%d]\n",\r\n__func__, rc);\r\nreturn LED_OFF;\r\n}\r\nled_mask = be64_to_cpu(mask);\r\nled_value = be64_to_cpu(value);\r\nif (!((led_mask >> powernv_led->led_type) & OPAL_SLOT_LED_STATE_ON)) {\r\ndev_err(dev, "%s: LED status not available for %s\n",\r\n__func__, powernv_led->cdev.name);\r\nreturn LED_OFF;\r\n}\r\nif ((led_value >> powernv_led->led_type) & OPAL_SLOT_LED_STATE_ON)\r\nreturn LED_FULL;\r\nreturn LED_OFF;\r\n}\r\nstatic int powernv_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nstruct powernv_led_data *powernv_led =\r\ncontainer_of(led_cdev, struct powernv_led_data, cdev);\r\nstruct powernv_led_common *powernv_led_common = powernv_led->common;\r\nint rc;\r\nif (powernv_led_common->led_disabled)\r\nreturn 0;\r\nmutex_lock(&powernv_led_common->lock);\r\nrc = powernv_led_set(powernv_led, value);\r\nmutex_unlock(&powernv_led_common->lock);\r\nreturn rc;\r\n}\r\nstatic enum led_brightness powernv_brightness_get(struct led_classdev *led_cdev)\r\n{\r\nstruct powernv_led_data *powernv_led =\r\ncontainer_of(led_cdev, struct powernv_led_data, cdev);\r\nreturn powernv_led_get(powernv_led);\r\n}\r\nstatic int powernv_led_create(struct device *dev,\r\nstruct powernv_led_data *powernv_led,\r\nconst char *led_type_desc)\r\n{\r\nint rc;\r\npowernv_led->led_type = powernv_get_led_type(led_type_desc);\r\nif (powernv_led->led_type == -1) {\r\ndev_warn(dev, "%s: No support for led type : %s\n",\r\n__func__, led_type_desc);\r\nreturn -EINVAL;\r\n}\r\npowernv_led->cdev.name = devm_kasprintf(dev, GFP_KERNEL, "%s:%s",\r\npowernv_led->loc_code,\r\nled_type_desc);\r\nif (!powernv_led->cdev.name) {\r\ndev_err(dev,\r\n"%s: Memory allocation failed for classdev name\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\npowernv_led->cdev.brightness_set_blocking = powernv_brightness_set;\r\npowernv_led->cdev.brightness_get = powernv_brightness_get;\r\npowernv_led->cdev.brightness = LED_OFF;\r\npowernv_led->cdev.max_brightness = LED_FULL;\r\nrc = devm_led_classdev_register(dev, &powernv_led->cdev);\r\nif (rc) {\r\ndev_err(dev, "%s: Classdev registration failed for %s\n",\r\n__func__, powernv_led->cdev.name);\r\n}\r\nreturn rc;\r\n}\r\nstatic int powernv_led_classdev(struct platform_device *pdev,\r\nstruct device_node *led_node,\r\nstruct powernv_led_common *powernv_led_common)\r\n{\r\nconst char *cur = NULL;\r\nint rc = -1;\r\nstruct property *p;\r\nstruct device_node *np;\r\nstruct powernv_led_data *powernv_led;\r\nstruct device *dev = &pdev->dev;\r\nfor_each_child_of_node(led_node, np) {\r\np = of_find_property(np, "led-types", NULL);\r\nwhile ((cur = of_prop_next_string(p, cur)) != NULL) {\r\npowernv_led = devm_kzalloc(dev, sizeof(*powernv_led),\r\nGFP_KERNEL);\r\nif (!powernv_led) {\r\nof_node_put(np);\r\nreturn -ENOMEM;\r\n}\r\npowernv_led->common = powernv_led_common;\r\npowernv_led->loc_code = (char *)np->name;\r\nrc = powernv_led_create(dev, powernv_led, cur);\r\nif (rc) {\r\nof_node_put(np);\r\nreturn rc;\r\n}\r\n}\r\n}\r\nreturn rc;\r\n}\r\nstatic int powernv_led_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *led_node;\r\nstruct powernv_led_common *powernv_led_common;\r\nstruct device *dev = &pdev->dev;\r\nled_node = of_find_node_by_path("/ibm,opal/leds");\r\nif (!led_node) {\r\ndev_err(dev, "%s: LED parent device node not found\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\npowernv_led_common = devm_kzalloc(dev, sizeof(*powernv_led_common),\r\nGFP_KERNEL);\r\nif (!powernv_led_common)\r\nreturn -ENOMEM;\r\nmutex_init(&powernv_led_common->lock);\r\npowernv_led_common->max_led_type = cpu_to_be64(OPAL_SLOT_LED_TYPE_MAX);\r\nplatform_set_drvdata(pdev, powernv_led_common);\r\nreturn powernv_led_classdev(pdev, led_node, powernv_led_common);\r\n}\r\nstatic int powernv_led_remove(struct platform_device *pdev)\r\n{\r\nstruct powernv_led_common *powernv_led_common;\r\npowernv_led_common = platform_get_drvdata(pdev);\r\npowernv_led_common->led_disabled = true;\r\nmutex_destroy(&powernv_led_common->lock);\r\ndev_info(&pdev->dev, "PowerNV led module unregistered\n");\r\nreturn 0;\r\n}

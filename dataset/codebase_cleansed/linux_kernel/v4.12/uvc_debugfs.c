static int uvc_debugfs_stats_open(struct inode *inode, struct file *file)\r\n{\r\nstruct uvc_streaming *stream = inode->i_private;\r\nstruct uvc_debugfs_buffer *buf;\r\nbuf = kmalloc(sizeof(*buf), GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nbuf->count = uvc_video_stats_dump(stream, buf->data, sizeof(buf->data));\r\nfile->private_data = buf;\r\nreturn 0;\r\n}\r\nstatic ssize_t uvc_debugfs_stats_read(struct file *file, char __user *user_buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct uvc_debugfs_buffer *buf = file->private_data;\r\nreturn simple_read_from_buffer(user_buf, nbytes, ppos, buf->data,\r\nbuf->count);\r\n}\r\nstatic int uvc_debugfs_stats_release(struct inode *inode, struct file *file)\r\n{\r\nkfree(file->private_data);\r\nfile->private_data = NULL;\r\nreturn 0;\r\n}\r\nvoid uvc_debugfs_init_stream(struct uvc_streaming *stream)\r\n{\r\nstruct usb_device *udev = stream->dev->udev;\r\nstruct dentry *dent;\r\nchar dir_name[32];\r\nif (uvc_debugfs_root_dir == NULL)\r\nreturn;\r\nsprintf(dir_name, "%u-%u", udev->bus->busnum, udev->devnum);\r\ndent = debugfs_create_dir(dir_name, uvc_debugfs_root_dir);\r\nif (IS_ERR_OR_NULL(dent)) {\r\nuvc_printk(KERN_INFO, "Unable to create debugfs %s "\r\n"directory.\n", dir_name);\r\nreturn;\r\n}\r\nstream->debugfs_dir = dent;\r\ndent = debugfs_create_file("stats", 0444, stream->debugfs_dir,\r\nstream, &uvc_debugfs_stats_fops);\r\nif (IS_ERR_OR_NULL(dent)) {\r\nuvc_printk(KERN_INFO, "Unable to create debugfs stats file.\n");\r\nuvc_debugfs_cleanup_stream(stream);\r\nreturn;\r\n}\r\n}\r\nvoid uvc_debugfs_cleanup_stream(struct uvc_streaming *stream)\r\n{\r\nif (stream->debugfs_dir == NULL)\r\nreturn;\r\ndebugfs_remove_recursive(stream->debugfs_dir);\r\nstream->debugfs_dir = NULL;\r\n}\r\nvoid uvc_debugfs_init(void)\r\n{\r\nstruct dentry *dir;\r\ndir = debugfs_create_dir("uvcvideo", usb_debug_root);\r\nif (IS_ERR_OR_NULL(dir)) {\r\nuvc_printk(KERN_INFO, "Unable to create debugfs directory\n");\r\nreturn;\r\n}\r\nuvc_debugfs_root_dir = dir;\r\n}\r\nvoid uvc_debugfs_cleanup(void)\r\n{\r\nif (uvc_debugfs_root_dir != NULL)\r\ndebugfs_remove_recursive(uvc_debugfs_root_dir);\r\n}

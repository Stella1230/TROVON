static u64 ocfs2_group_from_res(struct ocfs2_suballoc_result *res)\r\n{\r\nif (res->sr_blkno == 0)\r\nreturn 0;\r\nif (res->sr_bg_blkno)\r\nreturn res->sr_bg_blkno;\r\nreturn ocfs2_which_suballoc_group(res->sr_blkno, res->sr_bit_offset);\r\n}\r\nvoid ocfs2_free_ac_resource(struct ocfs2_alloc_context *ac)\r\n{\r\nstruct inode *inode = ac->ac_inode;\r\nif (inode) {\r\nif (ac->ac_which != OCFS2_AC_USE_LOCAL)\r\nocfs2_inode_unlock(inode, 1);\r\ninode_unlock(inode);\r\niput(inode);\r\nac->ac_inode = NULL;\r\n}\r\nbrelse(ac->ac_bh);\r\nac->ac_bh = NULL;\r\nac->ac_resv = NULL;\r\nkfree(ac->ac_find_loc_priv);\r\nac->ac_find_loc_priv = NULL;\r\n}\r\nvoid ocfs2_free_alloc_context(struct ocfs2_alloc_context *ac)\r\n{\r\nocfs2_free_ac_resource(ac);\r\nkfree(ac);\r\n}\r\nstatic u32 ocfs2_bits_per_group(struct ocfs2_chain_list *cl)\r\n{\r\nreturn (u32)le16_to_cpu(cl->cl_cpg) * (u32)le16_to_cpu(cl->cl_bpc);\r\n}\r\nstatic int ocfs2_validate_gd_self(struct super_block *sb,\r\nstruct buffer_head *bh,\r\nint resize)\r\n{\r\nstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\r\nif (!OCFS2_IS_VALID_GROUP_DESC(gd)) {\r\ndo_error("Group descriptor #%llu has bad signature %.*s\n",\r\n(unsigned long long)bh->b_blocknr, 7,\r\ngd->bg_signature);\r\n}\r\nif (le64_to_cpu(gd->bg_blkno) != bh->b_blocknr) {\r\ndo_error("Group descriptor #%llu has an invalid bg_blkno of %llu\n",\r\n(unsigned long long)bh->b_blocknr,\r\n(unsigned long long)le64_to_cpu(gd->bg_blkno));\r\n}\r\nif (le32_to_cpu(gd->bg_generation) != OCFS2_SB(sb)->fs_generation) {\r\ndo_error("Group descriptor #%llu has an invalid fs_generation of #%u\n",\r\n(unsigned long long)bh->b_blocknr,\r\nle32_to_cpu(gd->bg_generation));\r\n}\r\nif (le16_to_cpu(gd->bg_free_bits_count) > le16_to_cpu(gd->bg_bits)) {\r\ndo_error("Group descriptor #%llu has bit count %u but claims that %u are free\n",\r\n(unsigned long long)bh->b_blocknr,\r\nle16_to_cpu(gd->bg_bits),\r\nle16_to_cpu(gd->bg_free_bits_count));\r\n}\r\nif (le16_to_cpu(gd->bg_bits) > (8 * le16_to_cpu(gd->bg_size))) {\r\ndo_error("Group descriptor #%llu has bit count %u but max bitmap bits of %u\n",\r\n(unsigned long long)bh->b_blocknr,\r\nle16_to_cpu(gd->bg_bits),\r\n8 * le16_to_cpu(gd->bg_size));\r\n}\r\nreturn 0;\r\n}\r\nstatic int ocfs2_validate_gd_parent(struct super_block *sb,\r\nstruct ocfs2_dinode *di,\r\nstruct buffer_head *bh,\r\nint resize)\r\n{\r\nunsigned int max_bits;\r\nstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\r\nif (di->i_blkno != gd->bg_parent_dinode) {\r\ndo_error("Group descriptor #%llu has bad parent pointer (%llu, expected %llu)\n",\r\n(unsigned long long)bh->b_blocknr,\r\n(unsigned long long)le64_to_cpu(gd->bg_parent_dinode),\r\n(unsigned long long)le64_to_cpu(di->i_blkno));\r\n}\r\nmax_bits = le16_to_cpu(di->id2.i_chain.cl_cpg) * le16_to_cpu(di->id2.i_chain.cl_bpc);\r\nif (le16_to_cpu(gd->bg_bits) > max_bits) {\r\ndo_error("Group descriptor #%llu has bit count of %u\n",\r\n(unsigned long long)bh->b_blocknr,\r\nle16_to_cpu(gd->bg_bits));\r\n}\r\nif ((le16_to_cpu(gd->bg_chain) >\r\nle16_to_cpu(di->id2.i_chain.cl_next_free_rec)) ||\r\n((le16_to_cpu(gd->bg_chain) ==\r\nle16_to_cpu(di->id2.i_chain.cl_next_free_rec)) && !resize)) {\r\ndo_error("Group descriptor #%llu has bad chain %u\n",\r\n(unsigned long long)bh->b_blocknr,\r\nle16_to_cpu(gd->bg_chain));\r\n}\r\nreturn 0;\r\n}\r\nint ocfs2_check_group_descriptor(struct super_block *sb,\r\nstruct ocfs2_dinode *di,\r\nstruct buffer_head *bh)\r\n{\r\nint rc;\r\nstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\r\nBUG_ON(!buffer_uptodate(bh));\r\nrc = ocfs2_validate_meta_ecc(sb, bh->b_data, &gd->bg_check);\r\nif (rc) {\r\nmlog(ML_ERROR,\r\n"Checksum failed for group descriptor %llu\n",\r\n(unsigned long long)bh->b_blocknr);\r\n} else\r\nrc = ocfs2_validate_gd_self(sb, bh, 1);\r\nif (!rc)\r\nrc = ocfs2_validate_gd_parent(sb, di, bh, 1);\r\nreturn rc;\r\n}\r\nstatic int ocfs2_validate_group_descriptor(struct super_block *sb,\r\nstruct buffer_head *bh)\r\n{\r\nint rc;\r\nstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *)bh->b_data;\r\ntrace_ocfs2_validate_group_descriptor(\r\n(unsigned long long)bh->b_blocknr);\r\nBUG_ON(!buffer_uptodate(bh));\r\nrc = ocfs2_validate_meta_ecc(sb, bh->b_data, &gd->bg_check);\r\nif (rc)\r\nreturn rc;\r\nreturn ocfs2_validate_gd_self(sb, bh, 0);\r\n}\r\nint ocfs2_read_group_descriptor(struct inode *inode, struct ocfs2_dinode *di,\r\nu64 gd_blkno, struct buffer_head **bh)\r\n{\r\nint rc;\r\nstruct buffer_head *tmp = *bh;\r\nrc = ocfs2_read_block(INODE_CACHE(inode), gd_blkno, &tmp,\r\nocfs2_validate_group_descriptor);\r\nif (rc)\r\ngoto out;\r\nrc = ocfs2_validate_gd_parent(inode->i_sb, di, tmp, 0);\r\nif (rc) {\r\nbrelse(tmp);\r\ngoto out;\r\n}\r\nif (!*bh)\r\n*bh = tmp;\r\nout:\r\nreturn rc;\r\n}\r\nstatic void ocfs2_bg_discontig_add_extent(struct ocfs2_super *osb,\r\nstruct ocfs2_group_desc *bg,\r\nstruct ocfs2_chain_list *cl,\r\nu64 p_blkno, unsigned int clusters)\r\n{\r\nstruct ocfs2_extent_list *el = &bg->bg_list;\r\nstruct ocfs2_extent_rec *rec;\r\nBUG_ON(!ocfs2_supports_discontig_bg(osb));\r\nif (!el->l_next_free_rec)\r\nel->l_count = cpu_to_le16(ocfs2_extent_recs_per_gd(osb->sb));\r\nrec = &el->l_recs[le16_to_cpu(el->l_next_free_rec)];\r\nrec->e_blkno = cpu_to_le64(p_blkno);\r\nrec->e_cpos = cpu_to_le32(le16_to_cpu(bg->bg_bits) /\r\nle16_to_cpu(cl->cl_bpc));\r\nrec->e_leaf_clusters = cpu_to_le16(clusters);\r\nle16_add_cpu(&bg->bg_bits, clusters * le16_to_cpu(cl->cl_bpc));\r\nle16_add_cpu(&bg->bg_free_bits_count,\r\nclusters * le16_to_cpu(cl->cl_bpc));\r\nle16_add_cpu(&el->l_next_free_rec, 1);\r\n}\r\nstatic int ocfs2_block_group_fill(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *bg_bh,\r\nu64 group_blkno,\r\nunsigned int group_clusters,\r\nu16 my_chain,\r\nstruct ocfs2_chain_list *cl)\r\n{\r\nint status = 0;\r\nstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\r\nstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nstruct super_block * sb = alloc_inode->i_sb;\r\nif (((unsigned long long) bg_bh->b_blocknr) != group_blkno) {\r\nstatus = ocfs2_error(alloc_inode->i_sb,\r\n"group block (%llu) != b_blocknr (%llu)\n",\r\n(unsigned long long)group_blkno,\r\n(unsigned long long) bg_bh->b_blocknr);\r\ngoto bail;\r\n}\r\nstatus = ocfs2_journal_access_gd(handle,\r\nINODE_CACHE(alloc_inode),\r\nbg_bh,\r\nOCFS2_JOURNAL_ACCESS_CREATE);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nmemset(bg, 0, sb->s_blocksize);\r\nstrcpy(bg->bg_signature, OCFS2_GROUP_DESC_SIGNATURE);\r\nbg->bg_generation = cpu_to_le32(OCFS2_SB(sb)->fs_generation);\r\nbg->bg_size = cpu_to_le16(ocfs2_group_bitmap_size(sb, 1,\r\nosb->s_feature_incompat));\r\nbg->bg_chain = cpu_to_le16(my_chain);\r\nbg->bg_next_group = cl->cl_recs[my_chain].c_blkno;\r\nbg->bg_parent_dinode = cpu_to_le64(OCFS2_I(alloc_inode)->ip_blkno);\r\nbg->bg_blkno = cpu_to_le64(group_blkno);\r\nif (group_clusters == le16_to_cpu(cl->cl_cpg))\r\nbg->bg_bits = cpu_to_le16(ocfs2_bits_per_group(cl));\r\nelse\r\nocfs2_bg_discontig_add_extent(osb, bg, cl, group_blkno,\r\ngroup_clusters);\r\nocfs2_set_bit(0, (unsigned long *)bg->bg_bitmap);\r\nbg->bg_free_bits_count = cpu_to_le16(le16_to_cpu(bg->bg_bits) - 1);\r\nocfs2_journal_dirty(handle, bg_bh);\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic inline u16 ocfs2_find_smallest_chain(struct ocfs2_chain_list *cl)\r\n{\r\nu16 curr, best;\r\nbest = curr = 0;\r\nwhile (curr < le16_to_cpu(cl->cl_count)) {\r\nif (le32_to_cpu(cl->cl_recs[best].c_total) >\r\nle32_to_cpu(cl->cl_recs[curr].c_total))\r\nbest = curr;\r\ncurr++;\r\n}\r\nreturn best;\r\n}\r\nstatic struct buffer_head *\r\nocfs2_block_group_alloc_contig(struct ocfs2_super *osb, handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct ocfs2_alloc_context *ac,\r\nstruct ocfs2_chain_list *cl)\r\n{\r\nint status;\r\nu32 bit_off, num_bits;\r\nu64 bg_blkno;\r\nstruct buffer_head *bg_bh;\r\nunsigned int alloc_rec = ocfs2_find_smallest_chain(cl);\r\nstatus = ocfs2_claim_clusters(handle, ac,\r\nle16_to_cpu(cl->cl_cpg), &bit_off,\r\n&num_bits);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nbg_blkno = ocfs2_clusters_to_blocks(osb->sb, bit_off);\r\ntrace_ocfs2_block_group_alloc_contig(\r\n(unsigned long long)bg_blkno, alloc_rec);\r\nbg_bh = sb_getblk(osb->sb, bg_blkno);\r\nif (!bg_bh) {\r\nstatus = -ENOMEM;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nocfs2_set_new_buffer_uptodate(INODE_CACHE(alloc_inode), bg_bh);\r\nstatus = ocfs2_block_group_fill(handle, alloc_inode, bg_bh,\r\nbg_blkno, num_bits, alloc_rec, cl);\r\nif (status < 0) {\r\nbrelse(bg_bh);\r\nmlog_errno(status);\r\n}\r\nbail:\r\nreturn status ? ERR_PTR(status) : bg_bh;\r\n}\r\nstatic int ocfs2_block_group_claim_bits(struct ocfs2_super *osb,\r\nhandle_t *handle,\r\nstruct ocfs2_alloc_context *ac,\r\nunsigned int min_bits,\r\nu32 *bit_off, u32 *num_bits)\r\n{\r\nint status = 0;\r\nwhile (min_bits) {\r\nstatus = ocfs2_claim_clusters(handle, ac, min_bits,\r\nbit_off, num_bits);\r\nif (status != -ENOSPC)\r\nbreak;\r\nmin_bits >>= 1;\r\n}\r\nreturn status;\r\n}\r\nstatic int ocfs2_block_group_grow_discontig(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *bg_bh,\r\nstruct ocfs2_alloc_context *ac,\r\nstruct ocfs2_chain_list *cl,\r\nunsigned int min_bits)\r\n{\r\nint status;\r\nstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\r\nstruct ocfs2_group_desc *bg =\r\n(struct ocfs2_group_desc *)bg_bh->b_data;\r\nunsigned int needed = le16_to_cpu(cl->cl_cpg) -\r\nle16_to_cpu(bg->bg_bits) / le16_to_cpu(cl->cl_bpc);\r\nu32 p_cpos, clusters;\r\nu64 p_blkno;\r\nstruct ocfs2_extent_list *el = &bg->bg_list;\r\nstatus = ocfs2_journal_access_gd(handle,\r\nINODE_CACHE(alloc_inode),\r\nbg_bh,\r\nOCFS2_JOURNAL_ACCESS_CREATE);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nwhile ((needed > 0) && (le16_to_cpu(el->l_next_free_rec) <\r\nle16_to_cpu(el->l_count))) {\r\nif (min_bits > needed)\r\nmin_bits = needed;\r\nstatus = ocfs2_block_group_claim_bits(osb, handle, ac,\r\nmin_bits, &p_cpos,\r\n&clusters);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\np_blkno = ocfs2_clusters_to_blocks(osb->sb, p_cpos);\r\nocfs2_bg_discontig_add_extent(osb, bg, cl, p_blkno,\r\nclusters);\r\nmin_bits = clusters;\r\nneeded = le16_to_cpu(cl->cl_cpg) -\r\nle16_to_cpu(bg->bg_bits) / le16_to_cpu(cl->cl_bpc);\r\n}\r\nif (needed > 0) {\r\nstatus = -ENOSPC;\r\ngoto bail;\r\n}\r\nocfs2_journal_dirty(handle, bg_bh);\r\nbail:\r\nreturn status;\r\n}\r\nstatic void ocfs2_bg_alloc_cleanup(handle_t *handle,\r\nstruct ocfs2_alloc_context *cluster_ac,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *bg_bh)\r\n{\r\nint i, ret;\r\nstruct ocfs2_group_desc *bg;\r\nstruct ocfs2_extent_list *el;\r\nstruct ocfs2_extent_rec *rec;\r\nif (!bg_bh)\r\nreturn;\r\nbg = (struct ocfs2_group_desc *)bg_bh->b_data;\r\nel = &bg->bg_list;\r\nfor (i = 0; i < le16_to_cpu(el->l_next_free_rec); i++) {\r\nrec = &el->l_recs[i];\r\nret = ocfs2_free_clusters(handle, cluster_ac->ac_inode,\r\ncluster_ac->ac_bh,\r\nle64_to_cpu(rec->e_blkno),\r\nle16_to_cpu(rec->e_leaf_clusters));\r\nif (ret)\r\nmlog_errno(ret);\r\n}\r\nocfs2_remove_from_cache(INODE_CACHE(alloc_inode), bg_bh);\r\nbrelse(bg_bh);\r\n}\r\nstatic struct buffer_head *\r\nocfs2_block_group_alloc_discontig(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct ocfs2_alloc_context *ac,\r\nstruct ocfs2_chain_list *cl)\r\n{\r\nint status;\r\nu32 bit_off, num_bits;\r\nu64 bg_blkno;\r\nunsigned int min_bits = le16_to_cpu(cl->cl_cpg) >> 1;\r\nstruct buffer_head *bg_bh = NULL;\r\nunsigned int alloc_rec = ocfs2_find_smallest_chain(cl);\r\nstruct ocfs2_super *osb = OCFS2_SB(alloc_inode->i_sb);\r\nif (!ocfs2_supports_discontig_bg(osb)) {\r\nstatus = -ENOSPC;\r\ngoto bail;\r\n}\r\nstatus = ocfs2_extend_trans(handle,\r\nocfs2_calc_bg_discontig_credits(osb->sb));\r\nif (status) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nac->ac_disable_chain_relink = 1;\r\nstatus = ocfs2_block_group_claim_bits(osb, handle, ac, min_bits,\r\n&bit_off, &num_bits);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nmin_bits = num_bits;\r\nbg_blkno = ocfs2_clusters_to_blocks(osb->sb, bit_off);\r\ntrace_ocfs2_block_group_alloc_discontig(\r\n(unsigned long long)bg_blkno, alloc_rec);\r\nbg_bh = sb_getblk(osb->sb, bg_blkno);\r\nif (!bg_bh) {\r\nstatus = -ENOMEM;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nocfs2_set_new_buffer_uptodate(INODE_CACHE(alloc_inode), bg_bh);\r\nstatus = ocfs2_block_group_fill(handle, alloc_inode, bg_bh,\r\nbg_blkno, num_bits, alloc_rec, cl);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nstatus = ocfs2_block_group_grow_discontig(handle, alloc_inode,\r\nbg_bh, ac, cl, min_bits);\r\nif (status)\r\nmlog_errno(status);\r\nbail:\r\nif (status)\r\nocfs2_bg_alloc_cleanup(handle, ac, alloc_inode, bg_bh);\r\nreturn status ? ERR_PTR(status) : bg_bh;\r\n}\r\nstatic int ocfs2_block_group_alloc(struct ocfs2_super *osb,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *bh,\r\nu64 max_block,\r\nu64 *last_alloc_group,\r\nint flags)\r\n{\r\nint status, credits;\r\nstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) bh->b_data;\r\nstruct ocfs2_chain_list *cl;\r\nstruct ocfs2_alloc_context *ac = NULL;\r\nhandle_t *handle = NULL;\r\nu16 alloc_rec;\r\nstruct buffer_head *bg_bh = NULL;\r\nstruct ocfs2_group_desc *bg;\r\nBUG_ON(ocfs2_is_cluster_bitmap(alloc_inode));\r\ncl = &fe->id2.i_chain;\r\nstatus = ocfs2_reserve_clusters_with_limit(osb,\r\nle16_to_cpu(cl->cl_cpg),\r\nmax_block, flags, &ac);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\ncredits = ocfs2_calc_group_alloc_credits(osb->sb,\r\nle16_to_cpu(cl->cl_cpg));\r\nhandle = ocfs2_start_trans(osb, credits);\r\nif (IS_ERR(handle)) {\r\nstatus = PTR_ERR(handle);\r\nhandle = NULL;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nif (last_alloc_group && *last_alloc_group != 0) {\r\ntrace_ocfs2_block_group_alloc(\r\n(unsigned long long)*last_alloc_group);\r\nac->ac_last_group = *last_alloc_group;\r\n}\r\nbg_bh = ocfs2_block_group_alloc_contig(osb, handle, alloc_inode,\r\nac, cl);\r\nif (IS_ERR(bg_bh) && (PTR_ERR(bg_bh) == -ENOSPC))\r\nbg_bh = ocfs2_block_group_alloc_discontig(handle,\r\nalloc_inode,\r\nac, cl);\r\nif (IS_ERR(bg_bh)) {\r\nstatus = PTR_ERR(bg_bh);\r\nbg_bh = NULL;\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nbg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\r\nbh, OCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nalloc_rec = le16_to_cpu(bg->bg_chain);\r\nle32_add_cpu(&cl->cl_recs[alloc_rec].c_free,\r\nle16_to_cpu(bg->bg_free_bits_count));\r\nle32_add_cpu(&cl->cl_recs[alloc_rec].c_total,\r\nle16_to_cpu(bg->bg_bits));\r\ncl->cl_recs[alloc_rec].c_blkno = bg->bg_blkno;\r\nif (le16_to_cpu(cl->cl_next_free_rec) < le16_to_cpu(cl->cl_count))\r\nle16_add_cpu(&cl->cl_next_free_rec, 1);\r\nle32_add_cpu(&fe->id1.bitmap1.i_used, le16_to_cpu(bg->bg_bits) -\r\nle16_to_cpu(bg->bg_free_bits_count));\r\nle32_add_cpu(&fe->id1.bitmap1.i_total, le16_to_cpu(bg->bg_bits));\r\nle32_add_cpu(&fe->i_clusters, le16_to_cpu(cl->cl_cpg));\r\nocfs2_journal_dirty(handle, bh);\r\nspin_lock(&OCFS2_I(alloc_inode)->ip_lock);\r\nOCFS2_I(alloc_inode)->ip_clusters = le32_to_cpu(fe->i_clusters);\r\nfe->i_size = cpu_to_le64(ocfs2_clusters_to_bytes(alloc_inode->i_sb,\r\nle32_to_cpu(fe->i_clusters)));\r\nspin_unlock(&OCFS2_I(alloc_inode)->ip_lock);\r\ni_size_write(alloc_inode, le64_to_cpu(fe->i_size));\r\nalloc_inode->i_blocks = ocfs2_inode_sector_count(alloc_inode);\r\nocfs2_update_inode_fsync_trans(handle, alloc_inode, 0);\r\nstatus = 0;\r\nif (last_alloc_group)\r\n*last_alloc_group = ac->ac_last_group;\r\nbail:\r\nif (handle)\r\nocfs2_commit_trans(osb, handle);\r\nif (ac)\r\nocfs2_free_alloc_context(ac);\r\nbrelse(bg_bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic int ocfs2_reserve_suballoc_bits(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context *ac,\r\nint type,\r\nu32 slot,\r\nu64 *last_alloc_group,\r\nint flags)\r\n{\r\nint status;\r\nu32 bits_wanted = ac->ac_bits_wanted;\r\nstruct inode *alloc_inode;\r\nstruct buffer_head *bh = NULL;\r\nstruct ocfs2_dinode *fe;\r\nu32 free_bits;\r\nalloc_inode = ocfs2_get_system_file_inode(osb, type, slot);\r\nif (!alloc_inode) {\r\nmlog_errno(-EINVAL);\r\nreturn -EINVAL;\r\n}\r\ninode_lock(alloc_inode);\r\nstatus = ocfs2_inode_lock(alloc_inode, &bh, 1);\r\nif (status < 0) {\r\ninode_unlock(alloc_inode);\r\niput(alloc_inode);\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nac->ac_inode = alloc_inode;\r\nac->ac_alloc_slot = slot;\r\nfe = (struct ocfs2_dinode *) bh->b_data;\r\nBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\r\nif (!(fe->i_flags & cpu_to_le32(OCFS2_CHAIN_FL))) {\r\nstatus = ocfs2_error(alloc_inode->i_sb,\r\n"Invalid chain allocator %llu\n",\r\n(unsigned long long)le64_to_cpu(fe->i_blkno));\r\ngoto bail;\r\n}\r\nfree_bits = le32_to_cpu(fe->id1.bitmap1.i_total) -\r\nle32_to_cpu(fe->id1.bitmap1.i_used);\r\nif (bits_wanted > free_bits) {\r\nif (ocfs2_is_cluster_bitmap(alloc_inode)) {\r\ntrace_ocfs2_reserve_suballoc_bits_nospc(bits_wanted,\r\nfree_bits);\r\nstatus = -ENOSPC;\r\ngoto bail;\r\n}\r\nif (!(flags & ALLOC_NEW_GROUP)) {\r\ntrace_ocfs2_reserve_suballoc_bits_no_new_group(\r\nslot, bits_wanted, free_bits);\r\nstatus = -ENOSPC;\r\ngoto bail;\r\n}\r\nstatus = ocfs2_block_group_alloc(osb, alloc_inode, bh,\r\nac->ac_max_block,\r\nlast_alloc_group, flags);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\natomic_inc(&osb->alloc_stats.bg_extends);\r\nBUG_ON(bits_wanted >\r\n(le32_to_cpu(fe->id1.bitmap1.i_total)\r\n- le32_to_cpu(fe->id1.bitmap1.i_used)));\r\n}\r\nget_bh(bh);\r\nac->ac_bh = bh;\r\nbail:\r\nbrelse(bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic void ocfs2_init_inode_steal_slot(struct ocfs2_super *osb)\r\n{\r\nspin_lock(&osb->osb_lock);\r\nosb->s_inode_steal_slot = OCFS2_INVALID_SLOT;\r\nspin_unlock(&osb->osb_lock);\r\natomic_set(&osb->s_num_inodes_stolen, 0);\r\n}\r\nstatic void ocfs2_init_meta_steal_slot(struct ocfs2_super *osb)\r\n{\r\nspin_lock(&osb->osb_lock);\r\nosb->s_meta_steal_slot = OCFS2_INVALID_SLOT;\r\nspin_unlock(&osb->osb_lock);\r\natomic_set(&osb->s_num_meta_stolen, 0);\r\n}\r\nvoid ocfs2_init_steal_slots(struct ocfs2_super *osb)\r\n{\r\nocfs2_init_inode_steal_slot(osb);\r\nocfs2_init_meta_steal_slot(osb);\r\n}\r\nstatic void __ocfs2_set_steal_slot(struct ocfs2_super *osb, int slot, int type)\r\n{\r\nspin_lock(&osb->osb_lock);\r\nif (type == INODE_ALLOC_SYSTEM_INODE)\r\nosb->s_inode_steal_slot = slot;\r\nelse if (type == EXTENT_ALLOC_SYSTEM_INODE)\r\nosb->s_meta_steal_slot = slot;\r\nspin_unlock(&osb->osb_lock);\r\n}\r\nstatic int __ocfs2_get_steal_slot(struct ocfs2_super *osb, int type)\r\n{\r\nint slot = OCFS2_INVALID_SLOT;\r\nspin_lock(&osb->osb_lock);\r\nif (type == INODE_ALLOC_SYSTEM_INODE)\r\nslot = osb->s_inode_steal_slot;\r\nelse if (type == EXTENT_ALLOC_SYSTEM_INODE)\r\nslot = osb->s_meta_steal_slot;\r\nspin_unlock(&osb->osb_lock);\r\nreturn slot;\r\n}\r\nstatic int ocfs2_get_inode_steal_slot(struct ocfs2_super *osb)\r\n{\r\nreturn __ocfs2_get_steal_slot(osb, INODE_ALLOC_SYSTEM_INODE);\r\n}\r\nstatic int ocfs2_get_meta_steal_slot(struct ocfs2_super *osb)\r\n{\r\nreturn __ocfs2_get_steal_slot(osb, EXTENT_ALLOC_SYSTEM_INODE);\r\n}\r\nstatic int ocfs2_steal_resource(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context *ac,\r\nint type)\r\n{\r\nint i, status = -ENOSPC;\r\nint slot = __ocfs2_get_steal_slot(osb, type);\r\nif (slot == OCFS2_INVALID_SLOT)\r\nslot = osb->slot_num + 1;\r\nfor (i = 0; i < osb->max_slots; i++, slot++) {\r\nif (slot == osb->max_slots)\r\nslot = 0;\r\nif (slot == osb->slot_num)\r\ncontinue;\r\nstatus = ocfs2_reserve_suballoc_bits(osb, ac,\r\ntype,\r\n(u32)slot, NULL,\r\nNOT_ALLOC_NEW_GROUP);\r\nif (status >= 0) {\r\n__ocfs2_set_steal_slot(osb, slot, type);\r\nbreak;\r\n}\r\nocfs2_free_ac_resource(ac);\r\n}\r\nreturn status;\r\n}\r\nstatic int ocfs2_steal_inode(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context *ac)\r\n{\r\nreturn ocfs2_steal_resource(osb, ac, INODE_ALLOC_SYSTEM_INODE);\r\n}\r\nstatic int ocfs2_steal_meta(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context *ac)\r\n{\r\nreturn ocfs2_steal_resource(osb, ac, EXTENT_ALLOC_SYSTEM_INODE);\r\n}\r\nint ocfs2_reserve_new_metadata_blocks(struct ocfs2_super *osb,\r\nint blocks,\r\nstruct ocfs2_alloc_context **ac)\r\n{\r\nint status;\r\nint slot = ocfs2_get_meta_steal_slot(osb);\r\n*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\r\nif (!(*ac)) {\r\nstatus = -ENOMEM;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n(*ac)->ac_bits_wanted = blocks;\r\n(*ac)->ac_which = OCFS2_AC_USE_META;\r\n(*ac)->ac_group_search = ocfs2_block_group_search;\r\nif (slot != OCFS2_INVALID_SLOT &&\r\natomic_read(&osb->s_num_meta_stolen) < OCFS2_MAX_TO_STEAL)\r\ngoto extent_steal;\r\natomic_set(&osb->s_num_meta_stolen, 0);\r\nstatus = ocfs2_reserve_suballoc_bits(osb, (*ac),\r\nEXTENT_ALLOC_SYSTEM_INODE,\r\n(u32)osb->slot_num, NULL,\r\nALLOC_GROUPS_FROM_GLOBAL|ALLOC_NEW_GROUP);\r\nif (status >= 0) {\r\nstatus = 0;\r\nif (slot != OCFS2_INVALID_SLOT)\r\nocfs2_init_meta_steal_slot(osb);\r\ngoto bail;\r\n} else if (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nocfs2_free_ac_resource(*ac);\r\nextent_steal:\r\nstatus = ocfs2_steal_meta(osb, *ac);\r\natomic_inc(&osb->s_num_meta_stolen);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nstatus = 0;\r\nbail:\r\nif ((status < 0) && *ac) {\r\nocfs2_free_alloc_context(*ac);\r\n*ac = NULL;\r\n}\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_reserve_new_metadata(struct ocfs2_super *osb,\r\nstruct ocfs2_extent_list *root_el,\r\nstruct ocfs2_alloc_context **ac)\r\n{\r\nreturn ocfs2_reserve_new_metadata_blocks(osb,\r\nocfs2_extend_meta_needed(root_el),\r\nac);\r\n}\r\nint ocfs2_reserve_new_inode(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context **ac)\r\n{\r\nint status;\r\nint slot = ocfs2_get_inode_steal_slot(osb);\r\nu64 alloc_group;\r\n*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\r\nif (!(*ac)) {\r\nstatus = -ENOMEM;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n(*ac)->ac_bits_wanted = 1;\r\n(*ac)->ac_which = OCFS2_AC_USE_INODE;\r\n(*ac)->ac_group_search = ocfs2_block_group_search;\r\nif (!(osb->s_mount_opt & OCFS2_MOUNT_INODE64))\r\n(*ac)->ac_max_block = (u32)~0U;\r\nif (slot != OCFS2_INVALID_SLOT &&\r\natomic_read(&osb->s_num_inodes_stolen) < OCFS2_MAX_TO_STEAL)\r\ngoto inode_steal;\r\natomic_set(&osb->s_num_inodes_stolen, 0);\r\nalloc_group = osb->osb_inode_alloc_group;\r\nstatus = ocfs2_reserve_suballoc_bits(osb, *ac,\r\nINODE_ALLOC_SYSTEM_INODE,\r\n(u32)osb->slot_num,\r\n&alloc_group,\r\nALLOC_NEW_GROUP |\r\nALLOC_GROUPS_FROM_GLOBAL);\r\nif (status >= 0) {\r\nstatus = 0;\r\nspin_lock(&osb->osb_lock);\r\nosb->osb_inode_alloc_group = alloc_group;\r\nspin_unlock(&osb->osb_lock);\r\ntrace_ocfs2_reserve_new_inode_new_group(\r\n(unsigned long long)alloc_group);\r\nif (slot != OCFS2_INVALID_SLOT)\r\nocfs2_init_inode_steal_slot(osb);\r\ngoto bail;\r\n} else if (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nocfs2_free_ac_resource(*ac);\r\ninode_steal:\r\nstatus = ocfs2_steal_inode(osb, *ac);\r\natomic_inc(&osb->s_num_inodes_stolen);\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nstatus = 0;\r\nbail:\r\nif ((status < 0) && *ac) {\r\nocfs2_free_alloc_context(*ac);\r\n*ac = NULL;\r\n}\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_reserve_cluster_bitmap_bits(struct ocfs2_super *osb,\r\nstruct ocfs2_alloc_context *ac)\r\n{\r\nint status;\r\nac->ac_which = OCFS2_AC_USE_MAIN;\r\nac->ac_group_search = ocfs2_cluster_group_search;\r\nstatus = ocfs2_reserve_suballoc_bits(osb, ac,\r\nGLOBAL_BITMAP_SYSTEM_INODE,\r\nOCFS2_INVALID_SLOT, NULL,\r\nALLOC_NEW_GROUP);\r\nif (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nbail:\r\nreturn status;\r\n}\r\nstatic int ocfs2_reserve_clusters_with_limit(struct ocfs2_super *osb,\r\nu32 bits_wanted, u64 max_block,\r\nint flags,\r\nstruct ocfs2_alloc_context **ac)\r\n{\r\nint status, ret = 0;\r\nint retried = 0;\r\n*ac = kzalloc(sizeof(struct ocfs2_alloc_context), GFP_KERNEL);\r\nif (!(*ac)) {\r\nstatus = -ENOMEM;\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n(*ac)->ac_bits_wanted = bits_wanted;\r\n(*ac)->ac_max_block = max_block;\r\nstatus = -ENOSPC;\r\nif (!(flags & ALLOC_GROUPS_FROM_GLOBAL) &&\r\nocfs2_alloc_should_use_local(osb, bits_wanted)) {\r\nstatus = ocfs2_reserve_local_alloc_bits(osb,\r\nbits_wanted,\r\n*ac);\r\nif ((status < 0) && (status != -ENOSPC)) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n}\r\nif (status == -ENOSPC) {\r\nretry:\r\nstatus = ocfs2_reserve_cluster_bitmap_bits(osb, *ac);\r\nif (status == -ENOSPC && !retried) {\r\nretried = 1;\r\nocfs2_inode_unlock((*ac)->ac_inode, 1);\r\ninode_unlock((*ac)->ac_inode);\r\nret = ocfs2_try_to_free_truncate_log(osb, bits_wanted);\r\nif (ret == 1) {\r\niput((*ac)->ac_inode);\r\n(*ac)->ac_inode = NULL;\r\ngoto retry;\r\n}\r\nif (ret < 0)\r\nmlog_errno(ret);\r\ninode_lock((*ac)->ac_inode);\r\nret = ocfs2_inode_lock((*ac)->ac_inode, NULL, 1);\r\nif (ret < 0) {\r\nmlog_errno(ret);\r\ninode_unlock((*ac)->ac_inode);\r\niput((*ac)->ac_inode);\r\n(*ac)->ac_inode = NULL;\r\ngoto bail;\r\n}\r\n}\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n}\r\nstatus = 0;\r\nbail:\r\nif ((status < 0) && *ac) {\r\nocfs2_free_alloc_context(*ac);\r\n*ac = NULL;\r\n}\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_reserve_clusters(struct ocfs2_super *osb,\r\nu32 bits_wanted,\r\nstruct ocfs2_alloc_context **ac)\r\n{\r\nreturn ocfs2_reserve_clusters_with_limit(osb, bits_wanted, 0,\r\nALLOC_NEW_GROUP, ac);\r\n}\r\nstatic int ocfs2_test_bg_bit_allocatable(struct buffer_head *bg_bh,\r\nint nr)\r\n{\r\nstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nint ret;\r\nif (ocfs2_test_bit(nr, (unsigned long *)bg->bg_bitmap))\r\nreturn 0;\r\nif (!buffer_jbd(bg_bh))\r\nreturn 1;\r\njbd_lock_bh_state(bg_bh);\r\nbg = (struct ocfs2_group_desc *) bh2jh(bg_bh)->b_committed_data;\r\nif (bg)\r\nret = !ocfs2_test_bit(nr, (unsigned long *)bg->bg_bitmap);\r\nelse\r\nret = 1;\r\njbd_unlock_bh_state(bg_bh);\r\nreturn ret;\r\n}\r\nstatic int ocfs2_block_group_find_clear_bits(struct ocfs2_super *osb,\r\nstruct buffer_head *bg_bh,\r\nunsigned int bits_wanted,\r\nunsigned int total_bits,\r\nstruct ocfs2_suballoc_result *res)\r\n{\r\nvoid *bitmap;\r\nu16 best_offset, best_size;\r\nint offset, start, found, status = 0;\r\nstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\r\nfound = start = best_offset = best_size = 0;\r\nbitmap = bg->bg_bitmap;\r\nwhile((offset = ocfs2_find_next_zero_bit(bitmap, total_bits, start)) != -1) {\r\nif (offset == total_bits)\r\nbreak;\r\nif (!ocfs2_test_bg_bit_allocatable(bg_bh, offset)) {\r\nfound = 0;\r\nstart = offset + 1;\r\n} else if (offset == start) {\r\nfound++;\r\nstart++;\r\n} else {\r\nfound = 1;\r\nstart = offset + 1;\r\n}\r\nif (found > best_size) {\r\nbest_size = found;\r\nbest_offset = start - found;\r\n}\r\nif (found == bits_wanted) {\r\nbreak;\r\n}\r\n}\r\nif (best_size) {\r\nres->sr_bit_offset = best_offset;\r\nres->sr_bits = best_size;\r\n} else {\r\nstatus = -ENOSPC;\r\n}\r\nreturn status;\r\n}\r\nint ocfs2_block_group_set_bits(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct ocfs2_group_desc *bg,\r\nstruct buffer_head *group_bh,\r\nunsigned int bit_off,\r\nunsigned int num_bits)\r\n{\r\nint status;\r\nvoid *bitmap = bg->bg_bitmap;\r\nint journal_type = OCFS2_JOURNAL_ACCESS_WRITE;\r\nBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\r\nBUG_ON(le16_to_cpu(bg->bg_free_bits_count) < num_bits);\r\ntrace_ocfs2_block_group_set_bits(bit_off, num_bits);\r\nif (ocfs2_is_cluster_bitmap(alloc_inode))\r\njournal_type = OCFS2_JOURNAL_ACCESS_UNDO;\r\nstatus = ocfs2_journal_access_gd(handle,\r\nINODE_CACHE(alloc_inode),\r\ngroup_bh,\r\njournal_type);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nle16_add_cpu(&bg->bg_free_bits_count, -num_bits);\r\nif (le16_to_cpu(bg->bg_free_bits_count) > le16_to_cpu(bg->bg_bits)) {\r\nreturn ocfs2_error(alloc_inode->i_sb, "Group descriptor # %llu has bit count %u but claims %u are freed. num_bits %d\n",\r\n(unsigned long long)le64_to_cpu(bg->bg_blkno),\r\nle16_to_cpu(bg->bg_bits),\r\nle16_to_cpu(bg->bg_free_bits_count),\r\nnum_bits);\r\n}\r\nwhile(num_bits--)\r\nocfs2_set_bit(bit_off++, bitmap);\r\nocfs2_journal_dirty(handle, group_bh);\r\nbail:\r\nreturn status;\r\n}\r\nstatic inline u16 ocfs2_find_victim_chain(struct ocfs2_chain_list *cl)\r\n{\r\nu16 curr, best;\r\nBUG_ON(!cl->cl_next_free_rec);\r\nbest = curr = 0;\r\nwhile (curr < le16_to_cpu(cl->cl_next_free_rec)) {\r\nif (le32_to_cpu(cl->cl_recs[curr].c_free) >\r\nle32_to_cpu(cl->cl_recs[best].c_free))\r\nbest = curr;\r\ncurr++;\r\n}\r\nBUG_ON(best >= le16_to_cpu(cl->cl_next_free_rec));\r\nreturn best;\r\n}\r\nstatic int ocfs2_relink_block_group(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *fe_bh,\r\nstruct buffer_head *bg_bh,\r\nstruct buffer_head *prev_bg_bh,\r\nu16 chain)\r\n{\r\nint status;\r\nu64 bg_ptr, prev_bg_ptr;\r\nstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) fe_bh->b_data;\r\nstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nstruct ocfs2_group_desc *prev_bg = (struct ocfs2_group_desc *) prev_bg_bh->b_data;\r\nBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\r\nBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(prev_bg));\r\ntrace_ocfs2_relink_block_group(\r\n(unsigned long long)le64_to_cpu(fe->i_blkno), chain,\r\n(unsigned long long)le64_to_cpu(bg->bg_blkno),\r\n(unsigned long long)le64_to_cpu(prev_bg->bg_blkno));\r\nbg_ptr = le64_to_cpu(bg->bg_next_group);\r\nprev_bg_ptr = le64_to_cpu(prev_bg->bg_next_group);\r\nstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\r\nprev_bg_bh,\r\nOCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0)\r\ngoto out;\r\nprev_bg->bg_next_group = bg->bg_next_group;\r\nocfs2_journal_dirty(handle, prev_bg_bh);\r\nstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\r\nbg_bh, OCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0)\r\ngoto out_rollback_prev_bg;\r\nbg->bg_next_group = fe->id2.i_chain.cl_recs[chain].c_blkno;\r\nocfs2_journal_dirty(handle, bg_bh);\r\nstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\r\nfe_bh, OCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0)\r\ngoto out_rollback_bg;\r\nfe->id2.i_chain.cl_recs[chain].c_blkno = bg->bg_blkno;\r\nocfs2_journal_dirty(handle, fe_bh);\r\nout:\r\nif (status < 0)\r\nmlog_errno(status);\r\nreturn status;\r\nout_rollback_bg:\r\nbg->bg_next_group = cpu_to_le64(bg_ptr);\r\nout_rollback_prev_bg:\r\nprev_bg->bg_next_group = cpu_to_le64(prev_bg_ptr);\r\ngoto out;\r\n}\r\nstatic inline int ocfs2_block_group_reasonably_empty(struct ocfs2_group_desc *bg,\r\nu32 wanted)\r\n{\r\nreturn le16_to_cpu(bg->bg_free_bits_count) > wanted;\r\n}\r\nstatic int ocfs2_cluster_group_search(struct inode *inode,\r\nstruct buffer_head *group_bh,\r\nu32 bits_wanted, u32 min_bits,\r\nu64 max_block,\r\nstruct ocfs2_suballoc_result *res)\r\n{\r\nint search = -ENOSPC;\r\nint ret;\r\nu64 blkoff;\r\nstruct ocfs2_group_desc *gd = (struct ocfs2_group_desc *) group_bh->b_data;\r\nstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\r\nunsigned int max_bits, gd_cluster_off;\r\nBUG_ON(!ocfs2_is_cluster_bitmap(inode));\r\nif (gd->bg_free_bits_count) {\r\nmax_bits = le16_to_cpu(gd->bg_bits);\r\ngd_cluster_off = ocfs2_blocks_to_clusters(inode->i_sb,\r\nle64_to_cpu(gd->bg_blkno));\r\nif ((gd_cluster_off + max_bits) >\r\nOCFS2_I(inode)->ip_clusters) {\r\nmax_bits = OCFS2_I(inode)->ip_clusters - gd_cluster_off;\r\ntrace_ocfs2_cluster_group_search_wrong_max_bits(\r\n(unsigned long long)le64_to_cpu(gd->bg_blkno),\r\nle16_to_cpu(gd->bg_bits),\r\nOCFS2_I(inode)->ip_clusters, max_bits);\r\n}\r\nret = ocfs2_block_group_find_clear_bits(OCFS2_SB(inode->i_sb),\r\ngroup_bh, bits_wanted,\r\nmax_bits, res);\r\nif (ret)\r\nreturn ret;\r\nif (max_block) {\r\nblkoff = ocfs2_clusters_to_blocks(inode->i_sb,\r\ngd_cluster_off +\r\nres->sr_bit_offset +\r\nres->sr_bits);\r\ntrace_ocfs2_cluster_group_search_max_block(\r\n(unsigned long long)blkoff,\r\n(unsigned long long)max_block);\r\nif (blkoff > max_block)\r\nreturn -ENOSPC;\r\n}\r\nif (min_bits <= res->sr_bits)\r\nsearch = 0;\r\nelse if (res->sr_bits) {\r\nocfs2_local_alloc_seen_free_bits(osb, res->sr_bits);\r\n}\r\n}\r\nreturn search;\r\n}\r\nstatic int ocfs2_block_group_search(struct inode *inode,\r\nstruct buffer_head *group_bh,\r\nu32 bits_wanted, u32 min_bits,\r\nu64 max_block,\r\nstruct ocfs2_suballoc_result *res)\r\n{\r\nint ret = -ENOSPC;\r\nu64 blkoff;\r\nstruct ocfs2_group_desc *bg = (struct ocfs2_group_desc *) group_bh->b_data;\r\nBUG_ON(min_bits != 1);\r\nBUG_ON(ocfs2_is_cluster_bitmap(inode));\r\nif (bg->bg_free_bits_count) {\r\nret = ocfs2_block_group_find_clear_bits(OCFS2_SB(inode->i_sb),\r\ngroup_bh, bits_wanted,\r\nle16_to_cpu(bg->bg_bits),\r\nres);\r\nif (!ret && max_block) {\r\nblkoff = le64_to_cpu(bg->bg_blkno) +\r\nres->sr_bit_offset + res->sr_bits;\r\ntrace_ocfs2_block_group_search_max_block(\r\n(unsigned long long)blkoff,\r\n(unsigned long long)max_block);\r\nif (blkoff > max_block)\r\nret = -ENOSPC;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nint ocfs2_alloc_dinode_update_counts(struct inode *inode,\r\nhandle_t *handle,\r\nstruct buffer_head *di_bh,\r\nu32 num_bits,\r\nu16 chain)\r\n{\r\nint ret;\r\nu32 tmp_used;\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *) di_bh->b_data;\r\nstruct ocfs2_chain_list *cl = (struct ocfs2_chain_list *) &di->id2.i_chain;\r\nret = ocfs2_journal_access_di(handle, INODE_CACHE(inode), di_bh,\r\nOCFS2_JOURNAL_ACCESS_WRITE);\r\nif (ret < 0) {\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\ntmp_used = le32_to_cpu(di->id1.bitmap1.i_used);\r\ndi->id1.bitmap1.i_used = cpu_to_le32(num_bits + tmp_used);\r\nle32_add_cpu(&cl->cl_recs[chain].c_free, -num_bits);\r\nocfs2_journal_dirty(handle, di_bh);\r\nout:\r\nreturn ret;\r\n}\r\nvoid ocfs2_rollback_alloc_dinode_counts(struct inode *inode,\r\nstruct buffer_head *di_bh,\r\nu32 num_bits,\r\nu16 chain)\r\n{\r\nu32 tmp_used;\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *) di_bh->b_data;\r\nstruct ocfs2_chain_list *cl;\r\ncl = (struct ocfs2_chain_list *)&di->id2.i_chain;\r\ntmp_used = le32_to_cpu(di->id1.bitmap1.i_used);\r\ndi->id1.bitmap1.i_used = cpu_to_le32(tmp_used - num_bits);\r\nle32_add_cpu(&cl->cl_recs[chain].c_free, num_bits);\r\n}\r\nstatic int ocfs2_bg_discontig_fix_by_rec(struct ocfs2_suballoc_result *res,\r\nstruct ocfs2_extent_rec *rec,\r\nstruct ocfs2_chain_list *cl)\r\n{\r\nunsigned int bpc = le16_to_cpu(cl->cl_bpc);\r\nunsigned int bitoff = le32_to_cpu(rec->e_cpos) * bpc;\r\nunsigned int bitcount = le16_to_cpu(rec->e_leaf_clusters) * bpc;\r\nif (res->sr_bit_offset < bitoff)\r\nreturn 0;\r\nif (res->sr_bit_offset >= (bitoff + bitcount))\r\nreturn 0;\r\nres->sr_blkno = le64_to_cpu(rec->e_blkno) +\r\n(res->sr_bit_offset - bitoff);\r\nif ((res->sr_bit_offset + res->sr_bits) > (bitoff + bitcount))\r\nres->sr_bits = (bitoff + bitcount) - res->sr_bit_offset;\r\nreturn 1;\r\n}\r\nstatic void ocfs2_bg_discontig_fix_result(struct ocfs2_alloc_context *ac,\r\nstruct ocfs2_group_desc *bg,\r\nstruct ocfs2_suballoc_result *res)\r\n{\r\nint i;\r\nu64 bg_blkno = res->sr_bg_blkno;\r\nstruct ocfs2_extent_rec *rec;\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *)ac->ac_bh->b_data;\r\nstruct ocfs2_chain_list *cl = &di->id2.i_chain;\r\nif (ocfs2_is_cluster_bitmap(ac->ac_inode)) {\r\nres->sr_blkno = 0;\r\nreturn;\r\n}\r\nres->sr_blkno = res->sr_bg_blkno + res->sr_bit_offset;\r\nres->sr_bg_blkno = 0;\r\nif (!ocfs2_supports_discontig_bg(OCFS2_SB(ac->ac_inode->i_sb)) ||\r\n!bg->bg_list.l_next_free_rec)\r\nreturn;\r\nfor (i = 0; i < le16_to_cpu(bg->bg_list.l_next_free_rec); i++) {\r\nrec = &bg->bg_list.l_recs[i];\r\nif (ocfs2_bg_discontig_fix_by_rec(res, rec, cl)) {\r\nres->sr_bg_blkno = bg_blkno;\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int ocfs2_search_one_group(struct ocfs2_alloc_context *ac,\r\nhandle_t *handle,\r\nu32 bits_wanted,\r\nu32 min_bits,\r\nstruct ocfs2_suballoc_result *res,\r\nu16 *bits_left)\r\n{\r\nint ret;\r\nstruct buffer_head *group_bh = NULL;\r\nstruct ocfs2_group_desc *gd;\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *)ac->ac_bh->b_data;\r\nstruct inode *alloc_inode = ac->ac_inode;\r\nret = ocfs2_read_group_descriptor(alloc_inode, di,\r\nres->sr_bg_blkno, &group_bh);\r\nif (ret < 0) {\r\nmlog_errno(ret);\r\nreturn ret;\r\n}\r\ngd = (struct ocfs2_group_desc *) group_bh->b_data;\r\nret = ac->ac_group_search(alloc_inode, group_bh, bits_wanted, min_bits,\r\nac->ac_max_block, res);\r\nif (ret < 0) {\r\nif (ret != -ENOSPC)\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nif (!ret)\r\nocfs2_bg_discontig_fix_result(ac, gd, res);\r\nres->sr_bg_stable_blkno = group_bh->b_blocknr;\r\nif (ac->ac_find_loc_only)\r\ngoto out_loc_only;\r\nret = ocfs2_alloc_dinode_update_counts(alloc_inode, handle, ac->ac_bh,\r\nres->sr_bits,\r\nle16_to_cpu(gd->bg_chain));\r\nif (ret < 0) {\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nret = ocfs2_block_group_set_bits(handle, alloc_inode, gd, group_bh,\r\nres->sr_bit_offset, res->sr_bits);\r\nif (ret < 0) {\r\nocfs2_rollback_alloc_dinode_counts(alloc_inode, ac->ac_bh,\r\nres->sr_bits,\r\nle16_to_cpu(gd->bg_chain));\r\nmlog_errno(ret);\r\n}\r\nout_loc_only:\r\n*bits_left = le16_to_cpu(gd->bg_free_bits_count);\r\nout:\r\nbrelse(group_bh);\r\nreturn ret;\r\n}\r\nstatic int ocfs2_search_chain(struct ocfs2_alloc_context *ac,\r\nhandle_t *handle,\r\nu32 bits_wanted,\r\nu32 min_bits,\r\nstruct ocfs2_suballoc_result *res,\r\nu16 *bits_left)\r\n{\r\nint status;\r\nu16 chain;\r\nu64 next_group;\r\nstruct inode *alloc_inode = ac->ac_inode;\r\nstruct buffer_head *group_bh = NULL;\r\nstruct buffer_head *prev_group_bh = NULL;\r\nstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) ac->ac_bh->b_data;\r\nstruct ocfs2_chain_list *cl = (struct ocfs2_chain_list *) &fe->id2.i_chain;\r\nstruct ocfs2_group_desc *bg;\r\nchain = ac->ac_chain;\r\ntrace_ocfs2_search_chain_begin(\r\n(unsigned long long)OCFS2_I(alloc_inode)->ip_blkno,\r\nbits_wanted, chain);\r\nstatus = ocfs2_read_group_descriptor(alloc_inode, fe,\r\nle64_to_cpu(cl->cl_recs[chain].c_blkno),\r\n&group_bh);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nbg = (struct ocfs2_group_desc *) group_bh->b_data;\r\nstatus = -ENOSPC;\r\nwhile ((status = ac->ac_group_search(alloc_inode, group_bh,\r\nbits_wanted, min_bits,\r\nac->ac_max_block,\r\nres)) == -ENOSPC) {\r\nif (!bg->bg_next_group)\r\nbreak;\r\nbrelse(prev_group_bh);\r\nprev_group_bh = NULL;\r\nnext_group = le64_to_cpu(bg->bg_next_group);\r\nprev_group_bh = group_bh;\r\ngroup_bh = NULL;\r\nstatus = ocfs2_read_group_descriptor(alloc_inode, fe,\r\nnext_group, &group_bh);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nbg = (struct ocfs2_group_desc *) group_bh->b_data;\r\n}\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\ntrace_ocfs2_search_chain_succ(\r\n(unsigned long long)le64_to_cpu(bg->bg_blkno), res->sr_bits);\r\nres->sr_bg_blkno = le64_to_cpu(bg->bg_blkno);\r\nBUG_ON(res->sr_bits == 0);\r\nif (!status)\r\nocfs2_bg_discontig_fix_result(ac, bg, res);\r\nres->sr_bg_stable_blkno = group_bh->b_blocknr;\r\nif (!ac->ac_disable_chain_relink &&\r\n(prev_group_bh) &&\r\n(ocfs2_block_group_reasonably_empty(bg, res->sr_bits))) {\r\nstatus = ocfs2_relink_block_group(handle, alloc_inode,\r\nac->ac_bh, group_bh,\r\nprev_group_bh, chain);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n}\r\nif (ac->ac_find_loc_only)\r\ngoto out_loc_only;\r\nstatus = ocfs2_alloc_dinode_update_counts(alloc_inode, handle,\r\nac->ac_bh, res->sr_bits,\r\nchain);\r\nif (status) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nstatus = ocfs2_block_group_set_bits(handle,\r\nalloc_inode,\r\nbg,\r\ngroup_bh,\r\nres->sr_bit_offset,\r\nres->sr_bits);\r\nif (status < 0) {\r\nocfs2_rollback_alloc_dinode_counts(alloc_inode,\r\nac->ac_bh, res->sr_bits, chain);\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\ntrace_ocfs2_search_chain_end(\r\n(unsigned long long)le64_to_cpu(fe->i_blkno),\r\nres->sr_bits);\r\nout_loc_only:\r\n*bits_left = le16_to_cpu(bg->bg_free_bits_count);\r\nbail:\r\nbrelse(group_bh);\r\nbrelse(prev_group_bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic int ocfs2_claim_suballoc_bits(struct ocfs2_alloc_context *ac,\r\nhandle_t *handle,\r\nu32 bits_wanted,\r\nu32 min_bits,\r\nstruct ocfs2_suballoc_result *res)\r\n{\r\nint status;\r\nu16 victim, i;\r\nu16 bits_left = 0;\r\nu64 hint = ac->ac_last_group;\r\nstruct ocfs2_chain_list *cl;\r\nstruct ocfs2_dinode *fe;\r\nBUG_ON(ac->ac_bits_given >= ac->ac_bits_wanted);\r\nBUG_ON(bits_wanted > (ac->ac_bits_wanted - ac->ac_bits_given));\r\nBUG_ON(!ac->ac_bh);\r\nfe = (struct ocfs2_dinode *) ac->ac_bh->b_data;\r\nBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\r\nif (le32_to_cpu(fe->id1.bitmap1.i_used) >=\r\nle32_to_cpu(fe->id1.bitmap1.i_total)) {\r\nstatus = ocfs2_error(ac->ac_inode->i_sb,\r\n"Chain allocator dinode %llu has %u used bits but only %u total\n",\r\n(unsigned long long)le64_to_cpu(fe->i_blkno),\r\nle32_to_cpu(fe->id1.bitmap1.i_used),\r\nle32_to_cpu(fe->id1.bitmap1.i_total));\r\ngoto bail;\r\n}\r\nres->sr_bg_blkno = hint;\r\nif (res->sr_bg_blkno) {\r\nstatus = ocfs2_search_one_group(ac, handle, bits_wanted,\r\nmin_bits, res, &bits_left);\r\nif (!status)\r\ngoto set_hint;\r\nif (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n}\r\ncl = (struct ocfs2_chain_list *) &fe->id2.i_chain;\r\nvictim = ocfs2_find_victim_chain(cl);\r\nac->ac_chain = victim;\r\nstatus = ocfs2_search_chain(ac, handle, bits_wanted, min_bits,\r\nres, &bits_left);\r\nif (!status) {\r\nif (ocfs2_is_cluster_bitmap(ac->ac_inode))\r\nhint = res->sr_bg_blkno;\r\nelse\r\nhint = ocfs2_group_from_res(res);\r\ngoto set_hint;\r\n}\r\nif (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\ntrace_ocfs2_claim_suballoc_bits(victim);\r\nac->ac_disable_chain_relink = 1;\r\nfor (i = 0; i < le16_to_cpu(cl->cl_next_free_rec); i ++) {\r\nif (i == victim)\r\ncontinue;\r\nif (!cl->cl_recs[i].c_free)\r\ncontinue;\r\nac->ac_chain = i;\r\nstatus = ocfs2_search_chain(ac, handle, bits_wanted, min_bits,\r\nres, &bits_left);\r\nif (!status) {\r\nhint = ocfs2_group_from_res(res);\r\nbreak;\r\n}\r\nif (status < 0 && status != -ENOSPC) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\n}\r\nset_hint:\r\nif (status != -ENOSPC) {\r\nif (bits_left < min_bits)\r\nac->ac_last_group = 0;\r\nelse\r\nac->ac_last_group = hint;\r\n}\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_claim_metadata(handle_t *handle,\r\nstruct ocfs2_alloc_context *ac,\r\nu32 bits_wanted,\r\nu64 *suballoc_loc,\r\nu16 *suballoc_bit_start,\r\nunsigned int *num_bits,\r\nu64 *blkno_start)\r\n{\r\nint status;\r\nstruct ocfs2_suballoc_result res = { .sr_blkno = 0, };\r\nBUG_ON(!ac);\r\nBUG_ON(ac->ac_bits_wanted < (ac->ac_bits_given + bits_wanted));\r\nBUG_ON(ac->ac_which != OCFS2_AC_USE_META);\r\nstatus = ocfs2_claim_suballoc_bits(ac,\r\nhandle,\r\nbits_wanted,\r\n1,\r\n&res);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\natomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\r\n*suballoc_loc = res.sr_bg_blkno;\r\n*suballoc_bit_start = res.sr_bit_offset;\r\n*blkno_start = res.sr_blkno;\r\nac->ac_bits_given += res.sr_bits;\r\n*num_bits = res.sr_bits;\r\nstatus = 0;\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic void ocfs2_init_inode_ac_group(struct inode *dir,\r\nstruct buffer_head *parent_di_bh,\r\nstruct ocfs2_alloc_context *ac)\r\n{\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *)parent_di_bh->b_data;\r\nif (OCFS2_I(dir)->ip_last_used_group &&\r\nOCFS2_I(dir)->ip_last_used_slot == ac->ac_alloc_slot)\r\nac->ac_last_group = OCFS2_I(dir)->ip_last_used_group;\r\nelse if (le16_to_cpu(di->i_suballoc_slot) == ac->ac_alloc_slot) {\r\nif (di->i_suballoc_loc)\r\nac->ac_last_group = le64_to_cpu(di->i_suballoc_loc);\r\nelse\r\nac->ac_last_group = ocfs2_which_suballoc_group(\r\nle64_to_cpu(di->i_blkno),\r\nle16_to_cpu(di->i_suballoc_bit));\r\n}\r\n}\r\nstatic inline void ocfs2_save_inode_ac_group(struct inode *dir,\r\nstruct ocfs2_alloc_context *ac)\r\n{\r\nOCFS2_I(dir)->ip_last_used_group = ac->ac_last_group;\r\nOCFS2_I(dir)->ip_last_used_slot = ac->ac_alloc_slot;\r\n}\r\nint ocfs2_find_new_inode_loc(struct inode *dir,\r\nstruct buffer_head *parent_fe_bh,\r\nstruct ocfs2_alloc_context *ac,\r\nu64 *fe_blkno)\r\n{\r\nint ret;\r\nhandle_t *handle = NULL;\r\nstruct ocfs2_suballoc_result *res;\r\nBUG_ON(!ac);\r\nBUG_ON(ac->ac_bits_given != 0);\r\nBUG_ON(ac->ac_bits_wanted != 1);\r\nBUG_ON(ac->ac_which != OCFS2_AC_USE_INODE);\r\nres = kzalloc(sizeof(*res), GFP_NOFS);\r\nif (res == NULL) {\r\nret = -ENOMEM;\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nocfs2_init_inode_ac_group(dir, parent_fe_bh, ac);\r\nhandle = ocfs2_start_trans(OCFS2_SB(dir->i_sb), OCFS2_SUBALLOC_ALLOC);\r\nif (IS_ERR(handle)) {\r\nret = PTR_ERR(handle);\r\nhandle = NULL;\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nac->ac_find_loc_only = 1;\r\nret = ocfs2_claim_suballoc_bits(ac, handle, 1, 1, res);\r\nif (ret < 0) {\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nac->ac_find_loc_priv = res;\r\n*fe_blkno = res->sr_blkno;\r\nocfs2_update_inode_fsync_trans(handle, dir, 0);\r\nout:\r\nif (handle)\r\nocfs2_commit_trans(OCFS2_SB(dir->i_sb), handle);\r\nif (ret)\r\nkfree(res);\r\nreturn ret;\r\n}\r\nint ocfs2_claim_new_inode_at_loc(handle_t *handle,\r\nstruct inode *dir,\r\nstruct ocfs2_alloc_context *ac,\r\nu64 *suballoc_loc,\r\nu16 *suballoc_bit,\r\nu64 di_blkno)\r\n{\r\nint ret;\r\nu16 chain;\r\nstruct ocfs2_suballoc_result *res = ac->ac_find_loc_priv;\r\nstruct buffer_head *bg_bh = NULL;\r\nstruct ocfs2_group_desc *bg;\r\nstruct ocfs2_dinode *di = (struct ocfs2_dinode *) ac->ac_bh->b_data;\r\nBUG_ON(res->sr_blkno != di_blkno);\r\nret = ocfs2_read_group_descriptor(ac->ac_inode, di,\r\nres->sr_bg_stable_blkno, &bg_bh);\r\nif (ret) {\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nbg = (struct ocfs2_group_desc *) bg_bh->b_data;\r\nchain = le16_to_cpu(bg->bg_chain);\r\nret = ocfs2_alloc_dinode_update_counts(ac->ac_inode, handle,\r\nac->ac_bh, res->sr_bits,\r\nchain);\r\nif (ret) {\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nret = ocfs2_block_group_set_bits(handle,\r\nac->ac_inode,\r\nbg,\r\nbg_bh,\r\nres->sr_bit_offset,\r\nres->sr_bits);\r\nif (ret < 0) {\r\nocfs2_rollback_alloc_dinode_counts(ac->ac_inode,\r\nac->ac_bh, res->sr_bits, chain);\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\ntrace_ocfs2_claim_new_inode_at_loc((unsigned long long)di_blkno,\r\nres->sr_bits);\r\natomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\r\nBUG_ON(res->sr_bits != 1);\r\n*suballoc_loc = res->sr_bg_blkno;\r\n*suballoc_bit = res->sr_bit_offset;\r\nac->ac_bits_given++;\r\nocfs2_save_inode_ac_group(dir, ac);\r\nout:\r\nbrelse(bg_bh);\r\nreturn ret;\r\n}\r\nint ocfs2_claim_new_inode(handle_t *handle,\r\nstruct inode *dir,\r\nstruct buffer_head *parent_fe_bh,\r\nstruct ocfs2_alloc_context *ac,\r\nu64 *suballoc_loc,\r\nu16 *suballoc_bit,\r\nu64 *fe_blkno)\r\n{\r\nint status;\r\nstruct ocfs2_suballoc_result res;\r\nBUG_ON(!ac);\r\nBUG_ON(ac->ac_bits_given != 0);\r\nBUG_ON(ac->ac_bits_wanted != 1);\r\nBUG_ON(ac->ac_which != OCFS2_AC_USE_INODE);\r\nocfs2_init_inode_ac_group(dir, parent_fe_bh, ac);\r\nstatus = ocfs2_claim_suballoc_bits(ac,\r\nhandle,\r\n1,\r\n1,\r\n&res);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\natomic_inc(&OCFS2_SB(ac->ac_inode->i_sb)->alloc_stats.bg_allocs);\r\nBUG_ON(res.sr_bits != 1);\r\n*suballoc_loc = res.sr_bg_blkno;\r\n*suballoc_bit = res.sr_bit_offset;\r\n*fe_blkno = res.sr_blkno;\r\nac->ac_bits_given++;\r\nocfs2_save_inode_ac_group(dir, ac);\r\nstatus = 0;\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic inline u32 ocfs2_desc_bitmap_to_cluster_off(struct inode *inode,\r\nu64 bg_blkno,\r\nu16 bg_bit_off)\r\n{\r\nstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\r\nu32 cluster = 0;\r\nBUG_ON(!ocfs2_is_cluster_bitmap(inode));\r\nif (bg_blkno != osb->first_cluster_group_blkno)\r\ncluster = ocfs2_blocks_to_clusters(inode->i_sb, bg_blkno);\r\ncluster += (u32) bg_bit_off;\r\nreturn cluster;\r\n}\r\nu64 ocfs2_which_cluster_group(struct inode *inode, u32 cluster)\r\n{\r\nstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\r\nu32 group_no;\r\nBUG_ON(!ocfs2_is_cluster_bitmap(inode));\r\ngroup_no = cluster / osb->bitmap_cpg;\r\nif (!group_no)\r\nreturn osb->first_cluster_group_blkno;\r\nreturn ocfs2_clusters_to_blocks(inode->i_sb,\r\ngroup_no * osb->bitmap_cpg);\r\n}\r\nstatic inline void ocfs2_block_to_cluster_group(struct inode *inode,\r\nu64 data_blkno,\r\nu64 *bg_blkno,\r\nu16 *bg_bit_off)\r\n{\r\nstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\r\nu32 data_cluster = ocfs2_blocks_to_clusters(osb->sb, data_blkno);\r\nBUG_ON(!ocfs2_is_cluster_bitmap(inode));\r\n*bg_blkno = ocfs2_which_cluster_group(inode,\r\ndata_cluster);\r\nif (*bg_blkno == osb->first_cluster_group_blkno)\r\n*bg_bit_off = (u16) data_cluster;\r\nelse\r\n*bg_bit_off = (u16) ocfs2_blocks_to_clusters(osb->sb,\r\ndata_blkno - *bg_blkno);\r\n}\r\nint __ocfs2_claim_clusters(handle_t *handle,\r\nstruct ocfs2_alloc_context *ac,\r\nu32 min_clusters,\r\nu32 max_clusters,\r\nu32 *cluster_start,\r\nu32 *num_clusters)\r\n{\r\nint status;\r\nunsigned int bits_wanted = max_clusters;\r\nstruct ocfs2_suballoc_result res = { .sr_blkno = 0, };\r\nstruct ocfs2_super *osb = OCFS2_SB(ac->ac_inode->i_sb);\r\nBUG_ON(ac->ac_bits_given >= ac->ac_bits_wanted);\r\nBUG_ON(ac->ac_which != OCFS2_AC_USE_LOCAL\r\n&& ac->ac_which != OCFS2_AC_USE_MAIN);\r\nif (ac->ac_which == OCFS2_AC_USE_LOCAL) {\r\nWARN_ON(min_clusters > 1);\r\nstatus = ocfs2_claim_local_alloc_bits(osb,\r\nhandle,\r\nac,\r\nbits_wanted,\r\ncluster_start,\r\nnum_clusters);\r\nif (!status)\r\natomic_inc(&osb->alloc_stats.local_data);\r\n} else {\r\nif (min_clusters > (osb->bitmap_cpg - 1)) {\r\nmlog(ML_ERROR, "minimum allocation requested %u exceeds "\r\n"group bitmap size %u!\n", min_clusters,\r\nosb->bitmap_cpg);\r\nstatus = -ENOSPC;\r\ngoto bail;\r\n}\r\nif (bits_wanted > (osb->bitmap_cpg - 1))\r\nbits_wanted = osb->bitmap_cpg - 1;\r\nstatus = ocfs2_claim_suballoc_bits(ac,\r\nhandle,\r\nbits_wanted,\r\nmin_clusters,\r\n&res);\r\nif (!status) {\r\nBUG_ON(res.sr_blkno);\r\n*cluster_start =\r\nocfs2_desc_bitmap_to_cluster_off(ac->ac_inode,\r\nres.sr_bg_blkno,\r\nres.sr_bit_offset);\r\natomic_inc(&osb->alloc_stats.bitmap_data);\r\n*num_clusters = res.sr_bits;\r\n}\r\n}\r\nif (status < 0) {\r\nif (status != -ENOSPC)\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nac->ac_bits_given += *num_clusters;\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_claim_clusters(handle_t *handle,\r\nstruct ocfs2_alloc_context *ac,\r\nu32 min_clusters,\r\nu32 *cluster_start,\r\nu32 *num_clusters)\r\n{\r\nunsigned int bits_wanted = ac->ac_bits_wanted - ac->ac_bits_given;\r\nreturn __ocfs2_claim_clusters(handle, ac, min_clusters,\r\nbits_wanted, cluster_start, num_clusters);\r\n}\r\nstatic int ocfs2_block_group_clear_bits(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct ocfs2_group_desc *bg,\r\nstruct buffer_head *group_bh,\r\nunsigned int bit_off,\r\nunsigned int num_bits,\r\nvoid (*undo_fn)(unsigned int bit,\r\nunsigned long *bmap))\r\n{\r\nint status;\r\nunsigned int tmp;\r\nstruct ocfs2_group_desc *undo_bg = NULL;\r\nBUG_ON(!OCFS2_IS_VALID_GROUP_DESC(bg));\r\ntrace_ocfs2_block_group_clear_bits(bit_off, num_bits);\r\nBUG_ON(undo_fn && !ocfs2_is_cluster_bitmap(alloc_inode));\r\nstatus = ocfs2_journal_access_gd(handle, INODE_CACHE(alloc_inode),\r\ngroup_bh,\r\nundo_fn ?\r\nOCFS2_JOURNAL_ACCESS_UNDO :\r\nOCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nif (undo_fn) {\r\njbd_lock_bh_state(group_bh);\r\nundo_bg = (struct ocfs2_group_desc *)\r\nbh2jh(group_bh)->b_committed_data;\r\nBUG_ON(!undo_bg);\r\n}\r\ntmp = num_bits;\r\nwhile(tmp--) {\r\nocfs2_clear_bit((bit_off + tmp),\r\n(unsigned long *) bg->bg_bitmap);\r\nif (undo_fn)\r\nundo_fn(bit_off + tmp,\r\n(unsigned long *) undo_bg->bg_bitmap);\r\n}\r\nle16_add_cpu(&bg->bg_free_bits_count, num_bits);\r\nif (le16_to_cpu(bg->bg_free_bits_count) > le16_to_cpu(bg->bg_bits)) {\r\nreturn ocfs2_error(alloc_inode->i_sb, "Group descriptor # %llu has bit count %u but claims %u are freed. num_bits %d\n",\r\n(unsigned long long)le64_to_cpu(bg->bg_blkno),\r\nle16_to_cpu(bg->bg_bits),\r\nle16_to_cpu(bg->bg_free_bits_count),\r\nnum_bits);\r\n}\r\nif (undo_fn)\r\njbd_unlock_bh_state(group_bh);\r\nocfs2_journal_dirty(handle, group_bh);\r\nbail:\r\nreturn status;\r\n}\r\nstatic int _ocfs2_free_suballoc_bits(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *alloc_bh,\r\nunsigned int start_bit,\r\nu64 bg_blkno,\r\nunsigned int count,\r\nvoid (*undo_fn)(unsigned int bit,\r\nunsigned long *bitmap))\r\n{\r\nint status = 0;\r\nu32 tmp_used;\r\nstruct ocfs2_dinode *fe = (struct ocfs2_dinode *) alloc_bh->b_data;\r\nstruct ocfs2_chain_list *cl = &fe->id2.i_chain;\r\nstruct buffer_head *group_bh = NULL;\r\nstruct ocfs2_group_desc *group;\r\nBUG_ON(!OCFS2_IS_VALID_DINODE(fe));\r\nBUG_ON((count + start_bit) > ocfs2_bits_per_group(cl));\r\ntrace_ocfs2_free_suballoc_bits(\r\n(unsigned long long)OCFS2_I(alloc_inode)->ip_blkno,\r\n(unsigned long long)bg_blkno,\r\nstart_bit, count);\r\nstatus = ocfs2_read_group_descriptor(alloc_inode, fe, bg_blkno,\r\n&group_bh);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\ngroup = (struct ocfs2_group_desc *) group_bh->b_data;\r\nBUG_ON((count + start_bit) > le16_to_cpu(group->bg_bits));\r\nstatus = ocfs2_block_group_clear_bits(handle, alloc_inode,\r\ngroup, group_bh,\r\nstart_bit, count, undo_fn);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto bail;\r\n}\r\nstatus = ocfs2_journal_access_di(handle, INODE_CACHE(alloc_inode),\r\nalloc_bh, OCFS2_JOURNAL_ACCESS_WRITE);\r\nif (status < 0) {\r\nmlog_errno(status);\r\nocfs2_block_group_set_bits(handle, alloc_inode, group, group_bh,\r\nstart_bit, count);\r\ngoto bail;\r\n}\r\nle32_add_cpu(&cl->cl_recs[le16_to_cpu(group->bg_chain)].c_free,\r\ncount);\r\ntmp_used = le32_to_cpu(fe->id1.bitmap1.i_used);\r\nfe->id1.bitmap1.i_used = cpu_to_le32(tmp_used - count);\r\nocfs2_journal_dirty(handle, alloc_bh);\r\nbail:\r\nbrelse(group_bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_free_suballoc_bits(handle_t *handle,\r\nstruct inode *alloc_inode,\r\nstruct buffer_head *alloc_bh,\r\nunsigned int start_bit,\r\nu64 bg_blkno,\r\nunsigned int count)\r\n{\r\nreturn _ocfs2_free_suballoc_bits(handle, alloc_inode, alloc_bh,\r\nstart_bit, bg_blkno, count, NULL);\r\n}\r\nint ocfs2_free_dinode(handle_t *handle,\r\nstruct inode *inode_alloc_inode,\r\nstruct buffer_head *inode_alloc_bh,\r\nstruct ocfs2_dinode *di)\r\n{\r\nu64 blk = le64_to_cpu(di->i_blkno);\r\nu16 bit = le16_to_cpu(di->i_suballoc_bit);\r\nu64 bg_blkno = ocfs2_which_suballoc_group(blk, bit);\r\nif (di->i_suballoc_loc)\r\nbg_blkno = le64_to_cpu(di->i_suballoc_loc);\r\nreturn ocfs2_free_suballoc_bits(handle, inode_alloc_inode,\r\ninode_alloc_bh, bit, bg_blkno, 1);\r\n}\r\nstatic int _ocfs2_free_clusters(handle_t *handle,\r\nstruct inode *bitmap_inode,\r\nstruct buffer_head *bitmap_bh,\r\nu64 start_blk,\r\nunsigned int num_clusters,\r\nvoid (*undo_fn)(unsigned int bit,\r\nunsigned long *bitmap))\r\n{\r\nint status;\r\nu16 bg_start_bit;\r\nu64 bg_blkno;\r\nstruct ocfs2_dinode *fe;\r\nBUG_ON(start_blk != ocfs2_clusters_to_blocks(bitmap_inode->i_sb, ocfs2_blocks_to_clusters(bitmap_inode->i_sb, start_blk)));\r\nfe = (struct ocfs2_dinode *) bitmap_bh->b_data;\r\nocfs2_block_to_cluster_group(bitmap_inode, start_blk, &bg_blkno,\r\n&bg_start_bit);\r\ntrace_ocfs2_free_clusters((unsigned long long)bg_blkno,\r\n(unsigned long long)start_blk,\r\nbg_start_bit, num_clusters);\r\nstatus = _ocfs2_free_suballoc_bits(handle, bitmap_inode, bitmap_bh,\r\nbg_start_bit, bg_blkno,\r\nnum_clusters, undo_fn);\r\nif (status < 0) {\r\nmlog_errno(status);\r\ngoto out;\r\n}\r\nocfs2_local_alloc_seen_free_bits(OCFS2_SB(bitmap_inode->i_sb),\r\nnum_clusters);\r\nout:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_free_clusters(handle_t *handle,\r\nstruct inode *bitmap_inode,\r\nstruct buffer_head *bitmap_bh,\r\nu64 start_blk,\r\nunsigned int num_clusters)\r\n{\r\nreturn _ocfs2_free_clusters(handle, bitmap_inode, bitmap_bh,\r\nstart_blk, num_clusters,\r\n_ocfs2_set_bit);\r\n}\r\nint ocfs2_release_clusters(handle_t *handle,\r\nstruct inode *bitmap_inode,\r\nstruct buffer_head *bitmap_bh,\r\nu64 start_blk,\r\nunsigned int num_clusters)\r\n{\r\nreturn _ocfs2_free_clusters(handle, bitmap_inode, bitmap_bh,\r\nstart_blk, num_clusters,\r\n_ocfs2_clear_bit);\r\n}\r\nstatic inline void ocfs2_debug_bg(struct ocfs2_group_desc *bg)\r\n{\r\nprintk("Block Group:\n");\r\nprintk("bg_signature: %s\n", bg->bg_signature);\r\nprintk("bg_size: %u\n", bg->bg_size);\r\nprintk("bg_bits: %u\n", bg->bg_bits);\r\nprintk("bg_free_bits_count: %u\n", bg->bg_free_bits_count);\r\nprintk("bg_chain: %u\n", bg->bg_chain);\r\nprintk("bg_generation: %u\n", le32_to_cpu(bg->bg_generation));\r\nprintk("bg_next_group: %llu\n",\r\n(unsigned long long)bg->bg_next_group);\r\nprintk("bg_parent_dinode: %llu\n",\r\n(unsigned long long)bg->bg_parent_dinode);\r\nprintk("bg_blkno: %llu\n",\r\n(unsigned long long)bg->bg_blkno);\r\n}\r\nstatic inline void ocfs2_debug_suballoc_inode(struct ocfs2_dinode *fe)\r\n{\r\nint i;\r\nprintk("Suballoc Inode %llu:\n", (unsigned long long)fe->i_blkno);\r\nprintk("i_signature: %s\n", fe->i_signature);\r\nprintk("i_size: %llu\n",\r\n(unsigned long long)fe->i_size);\r\nprintk("i_clusters: %u\n", fe->i_clusters);\r\nprintk("i_generation: %u\n",\r\nle32_to_cpu(fe->i_generation));\r\nprintk("id1.bitmap1.i_used: %u\n",\r\nle32_to_cpu(fe->id1.bitmap1.i_used));\r\nprintk("id1.bitmap1.i_total: %u\n",\r\nle32_to_cpu(fe->id1.bitmap1.i_total));\r\nprintk("id2.i_chain.cl_cpg: %u\n", fe->id2.i_chain.cl_cpg);\r\nprintk("id2.i_chain.cl_bpc: %u\n", fe->id2.i_chain.cl_bpc);\r\nprintk("id2.i_chain.cl_count: %u\n", fe->id2.i_chain.cl_count);\r\nprintk("id2.i_chain.cl_next_free_rec: %u\n",\r\nfe->id2.i_chain.cl_next_free_rec);\r\nfor(i = 0; i < fe->id2.i_chain.cl_next_free_rec; i++) {\r\nprintk("fe->id2.i_chain.cl_recs[%d].c_free: %u\n", i,\r\nfe->id2.i_chain.cl_recs[i].c_free);\r\nprintk("fe->id2.i_chain.cl_recs[%d].c_total: %u\n", i,\r\nfe->id2.i_chain.cl_recs[i].c_total);\r\nprintk("fe->id2.i_chain.cl_recs[%d].c_blkno: %llu\n", i,\r\n(unsigned long long)fe->id2.i_chain.cl_recs[i].c_blkno);\r\n}\r\n}\r\nint ocfs2_lock_allocators(struct inode *inode,\r\nstruct ocfs2_extent_tree *et,\r\nu32 clusters_to_add, u32 extents_to_split,\r\nstruct ocfs2_alloc_context **data_ac,\r\nstruct ocfs2_alloc_context **meta_ac)\r\n{\r\nint ret = 0, num_free_extents;\r\nunsigned int max_recs_needed = clusters_to_add + 2 * extents_to_split;\r\nstruct ocfs2_super *osb = OCFS2_SB(inode->i_sb);\r\n*meta_ac = NULL;\r\nif (data_ac)\r\n*data_ac = NULL;\r\nBUG_ON(clusters_to_add != 0 && data_ac == NULL);\r\nnum_free_extents = ocfs2_num_free_extents(osb, et);\r\nif (num_free_extents < 0) {\r\nret = num_free_extents;\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nif (!num_free_extents ||\r\n(ocfs2_sparse_alloc(osb) && num_free_extents < max_recs_needed)) {\r\nret = ocfs2_reserve_new_metadata(osb, et->et_root_el, meta_ac);\r\nif (ret < 0) {\r\nif (ret != -ENOSPC)\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\n}\r\nif (clusters_to_add == 0)\r\ngoto out;\r\nret = ocfs2_reserve_clusters(osb, clusters_to_add, data_ac);\r\nif (ret < 0) {\r\nif (ret != -ENOSPC)\r\nmlog_errno(ret);\r\ngoto out;\r\n}\r\nout:\r\nif (ret) {\r\nif (*meta_ac) {\r\nocfs2_free_alloc_context(*meta_ac);\r\n*meta_ac = NULL;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int ocfs2_get_suballoc_slot_bit(struct ocfs2_super *osb, u64 blkno,\r\nu16 *suballoc_slot, u64 *group_blkno,\r\nu16 *suballoc_bit)\r\n{\r\nint status;\r\nstruct buffer_head *inode_bh = NULL;\r\nstruct ocfs2_dinode *inode_fe;\r\ntrace_ocfs2_get_suballoc_slot_bit((unsigned long long)blkno);\r\nstatus = ocfs2_read_blocks_sync(osb, blkno, 1, &inode_bh);\r\nif (status < 0) {\r\nmlog(ML_ERROR, "read block %llu failed %d\n",\r\n(unsigned long long)blkno, status);\r\ngoto bail;\r\n}\r\ninode_fe = (struct ocfs2_dinode *) inode_bh->b_data;\r\nif (!OCFS2_IS_VALID_DINODE(inode_fe)) {\r\nmlog(ML_ERROR, "invalid inode %llu requested\n",\r\n(unsigned long long)blkno);\r\nstatus = -EINVAL;\r\ngoto bail;\r\n}\r\nif (le16_to_cpu(inode_fe->i_suballoc_slot) != (u16)OCFS2_INVALID_SLOT &&\r\n(u32)le16_to_cpu(inode_fe->i_suballoc_slot) > osb->max_slots - 1) {\r\nmlog(ML_ERROR, "inode %llu has invalid suballoc slot %u\n",\r\n(unsigned long long)blkno,\r\n(u32)le16_to_cpu(inode_fe->i_suballoc_slot));\r\nstatus = -EINVAL;\r\ngoto bail;\r\n}\r\nif (suballoc_slot)\r\n*suballoc_slot = le16_to_cpu(inode_fe->i_suballoc_slot);\r\nif (suballoc_bit)\r\n*suballoc_bit = le16_to_cpu(inode_fe->i_suballoc_bit);\r\nif (group_blkno)\r\n*group_blkno = le64_to_cpu(inode_fe->i_suballoc_loc);\r\nbail:\r\nbrelse(inode_bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nstatic int ocfs2_test_suballoc_bit(struct ocfs2_super *osb,\r\nstruct inode *suballoc,\r\nstruct buffer_head *alloc_bh,\r\nu64 group_blkno, u64 blkno,\r\nu16 bit, int *res)\r\n{\r\nstruct ocfs2_dinode *alloc_di;\r\nstruct ocfs2_group_desc *group;\r\nstruct buffer_head *group_bh = NULL;\r\nu64 bg_blkno;\r\nint status;\r\ntrace_ocfs2_test_suballoc_bit((unsigned long long)blkno,\r\n(unsigned int)bit);\r\nalloc_di = (struct ocfs2_dinode *)alloc_bh->b_data;\r\nif ((bit + 1) > ocfs2_bits_per_group(&alloc_di->id2.i_chain)) {\r\nmlog(ML_ERROR, "suballoc bit %u out of range of %u\n",\r\n(unsigned int)bit,\r\nocfs2_bits_per_group(&alloc_di->id2.i_chain));\r\nstatus = -EINVAL;\r\ngoto bail;\r\n}\r\nbg_blkno = group_blkno ? group_blkno :\r\nocfs2_which_suballoc_group(blkno, bit);\r\nstatus = ocfs2_read_group_descriptor(suballoc, alloc_di, bg_blkno,\r\n&group_bh);\r\nif (status < 0) {\r\nmlog(ML_ERROR, "read group %llu failed %d\n",\r\n(unsigned long long)bg_blkno, status);\r\ngoto bail;\r\n}\r\ngroup = (struct ocfs2_group_desc *) group_bh->b_data;\r\n*res = ocfs2_test_bit(bit, (unsigned long *)group->bg_bitmap);\r\nbail:\r\nbrelse(group_bh);\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}\r\nint ocfs2_test_inode_bit(struct ocfs2_super *osb, u64 blkno, int *res)\r\n{\r\nint status;\r\nu64 group_blkno = 0;\r\nu16 suballoc_bit = 0, suballoc_slot = 0;\r\nstruct inode *inode_alloc_inode;\r\nstruct buffer_head *alloc_bh = NULL;\r\ntrace_ocfs2_test_inode_bit((unsigned long long)blkno);\r\nstatus = ocfs2_get_suballoc_slot_bit(osb, blkno, &suballoc_slot,\r\n&group_blkno, &suballoc_bit);\r\nif (status < 0) {\r\nmlog(ML_ERROR, "get alloc slot and bit failed %d\n", status);\r\ngoto bail;\r\n}\r\ninode_alloc_inode =\r\nocfs2_get_system_file_inode(osb, INODE_ALLOC_SYSTEM_INODE,\r\nsuballoc_slot);\r\nif (!inode_alloc_inode) {\r\nstatus = -EINVAL;\r\nmlog(ML_ERROR, "unable to get alloc inode in slot %u\n",\r\n(u32)suballoc_slot);\r\ngoto bail;\r\n}\r\ninode_lock(inode_alloc_inode);\r\nstatus = ocfs2_inode_lock(inode_alloc_inode, &alloc_bh, 0);\r\nif (status < 0) {\r\ninode_unlock(inode_alloc_inode);\r\niput(inode_alloc_inode);\r\nmlog(ML_ERROR, "lock on alloc inode on slot %u failed %d\n",\r\n(u32)suballoc_slot, status);\r\ngoto bail;\r\n}\r\nstatus = ocfs2_test_suballoc_bit(osb, inode_alloc_inode, alloc_bh,\r\ngroup_blkno, blkno, suballoc_bit, res);\r\nif (status < 0)\r\nmlog(ML_ERROR, "test suballoc bit failed %d\n", status);\r\nocfs2_inode_unlock(inode_alloc_inode, 0);\r\ninode_unlock(inode_alloc_inode);\r\niput(inode_alloc_inode);\r\nbrelse(alloc_bh);\r\nbail:\r\nif (status)\r\nmlog_errno(status);\r\nreturn status;\r\n}

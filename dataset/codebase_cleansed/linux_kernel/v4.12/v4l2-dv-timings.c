bool v4l2_valid_dv_timings(const struct v4l2_dv_timings *t,\r\nconst struct v4l2_dv_timings_cap *dvcap,\r\nv4l2_check_dv_timings_fnc fnc,\r\nvoid *fnc_handle)\r\n{\r\nconst struct v4l2_bt_timings *bt = &t->bt;\r\nconst struct v4l2_bt_timings_cap *cap = &dvcap->bt;\r\nu32 caps = cap->capabilities;\r\nif (t->type != V4L2_DV_BT_656_1120)\r\nreturn false;\r\nif (t->type != dvcap->type ||\r\nbt->height < cap->min_height ||\r\nbt->height > cap->max_height ||\r\nbt->width < cap->min_width ||\r\nbt->width > cap->max_width ||\r\nbt->pixelclock < cap->min_pixelclock ||\r\nbt->pixelclock > cap->max_pixelclock ||\r\n(!(caps & V4L2_DV_BT_CAP_CUSTOM) &&\r\ncap->standards && bt->standards &&\r\n!(bt->standards & cap->standards)) ||\r\n(bt->interlaced && !(caps & V4L2_DV_BT_CAP_INTERLACED)) ||\r\n(!bt->interlaced && !(caps & V4L2_DV_BT_CAP_PROGRESSIVE)))\r\nreturn false;\r\nreturn fnc == NULL || fnc(t, fnc_handle);\r\n}\r\nint v4l2_enum_dv_timings_cap(struct v4l2_enum_dv_timings *t,\r\nconst struct v4l2_dv_timings_cap *cap,\r\nv4l2_check_dv_timings_fnc fnc,\r\nvoid *fnc_handle)\r\n{\r\nu32 i, idx;\r\nmemset(t->reserved, 0, sizeof(t->reserved));\r\nfor (i = idx = 0; v4l2_dv_timings_presets[i].bt.width; i++) {\r\nif (v4l2_valid_dv_timings(v4l2_dv_timings_presets + i, cap,\r\nfnc, fnc_handle) &&\r\nidx++ == t->index) {\r\nt->timings = v4l2_dv_timings_presets[i];\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nbool v4l2_find_dv_timings_cap(struct v4l2_dv_timings *t,\r\nconst struct v4l2_dv_timings_cap *cap,\r\nunsigned pclock_delta,\r\nv4l2_check_dv_timings_fnc fnc,\r\nvoid *fnc_handle)\r\n{\r\nint i;\r\nif (!v4l2_valid_dv_timings(t, cap, fnc, fnc_handle))\r\nreturn false;\r\nfor (i = 0; i < v4l2_dv_timings_presets[i].bt.width; i++) {\r\nif (v4l2_valid_dv_timings(v4l2_dv_timings_presets + i, cap,\r\nfnc, fnc_handle) &&\r\nv4l2_match_dv_timings(t, v4l2_dv_timings_presets + i,\r\npclock_delta, false)) {\r\nu32 flags = t->bt.flags & V4L2_DV_FL_REDUCED_FPS;\r\n*t = v4l2_dv_timings_presets[i];\r\nif (can_reduce_fps(&t->bt))\r\nt->bt.flags |= flags;\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nbool v4l2_find_dv_timings_cea861_vic(struct v4l2_dv_timings *t, u8 vic)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < v4l2_dv_timings_presets[i].bt.width; i++) {\r\nconst struct v4l2_bt_timings *bt =\r\n&v4l2_dv_timings_presets[i].bt;\r\nif ((bt->flags & V4L2_DV_FL_HAS_CEA861_VIC) &&\r\nbt->cea861_vic == vic) {\r\n*t = v4l2_dv_timings_presets[i];\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nbool v4l2_match_dv_timings(const struct v4l2_dv_timings *t1,\r\nconst struct v4l2_dv_timings *t2,\r\nunsigned pclock_delta, bool match_reduced_fps)\r\n{\r\nif (t1->type != t2->type || t1->type != V4L2_DV_BT_656_1120)\r\nreturn false;\r\nif (t1->bt.width == t2->bt.width &&\r\nt1->bt.height == t2->bt.height &&\r\nt1->bt.interlaced == t2->bt.interlaced &&\r\nt1->bt.polarities == t2->bt.polarities &&\r\nt1->bt.pixelclock >= t2->bt.pixelclock - pclock_delta &&\r\nt1->bt.pixelclock <= t2->bt.pixelclock + pclock_delta &&\r\nt1->bt.hfrontporch == t2->bt.hfrontporch &&\r\nt1->bt.hsync == t2->bt.hsync &&\r\nt1->bt.hbackporch == t2->bt.hbackporch &&\r\nt1->bt.vfrontporch == t2->bt.vfrontporch &&\r\nt1->bt.vsync == t2->bt.vsync &&\r\nt1->bt.vbackporch == t2->bt.vbackporch &&\r\n(!match_reduced_fps ||\r\n(t1->bt.flags & V4L2_DV_FL_REDUCED_FPS) ==\r\n(t2->bt.flags & V4L2_DV_FL_REDUCED_FPS)) &&\r\n(!t1->bt.interlaced ||\r\n(t1->bt.il_vfrontporch == t2->bt.il_vfrontporch &&\r\nt1->bt.il_vsync == t2->bt.il_vsync &&\r\nt1->bt.il_vbackporch == t2->bt.il_vbackporch)))\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid v4l2_print_dv_timings(const char *dev_prefix, const char *prefix,\r\nconst struct v4l2_dv_timings *t, bool detailed)\r\n{\r\nconst struct v4l2_bt_timings *bt = &t->bt;\r\nu32 htot, vtot;\r\nu32 fps;\r\nif (t->type != V4L2_DV_BT_656_1120)\r\nreturn;\r\nhtot = V4L2_DV_BT_FRAME_WIDTH(bt);\r\nvtot = V4L2_DV_BT_FRAME_HEIGHT(bt);\r\nif (bt->interlaced)\r\nvtot /= 2;\r\nfps = (htot * vtot) > 0 ? div_u64((100 * (u64)bt->pixelclock),\r\n(htot * vtot)) : 0;\r\nif (prefix == NULL)\r\nprefix = "";\r\npr_info("%s: %s%ux%u%s%u.%u (%ux%u)\n", dev_prefix, prefix,\r\nbt->width, bt->height, bt->interlaced ? "i" : "p",\r\nfps / 100, fps % 100, htot, vtot);\r\nif (!detailed)\r\nreturn;\r\npr_info("%s: horizontal: fp = %u, %ssync = %u, bp = %u\n",\r\ndev_prefix, bt->hfrontporch,\r\n(bt->polarities & V4L2_DV_HSYNC_POS_POL) ? "+" : "-",\r\nbt->hsync, bt->hbackporch);\r\npr_info("%s: vertical: fp = %u, %ssync = %u, bp = %u\n",\r\ndev_prefix, bt->vfrontporch,\r\n(bt->polarities & V4L2_DV_VSYNC_POS_POL) ? "+" : "-",\r\nbt->vsync, bt->vbackporch);\r\nif (bt->interlaced)\r\npr_info("%s: vertical bottom field: fp = %u, %ssync = %u, bp = %u\n",\r\ndev_prefix, bt->il_vfrontporch,\r\n(bt->polarities & V4L2_DV_VSYNC_POS_POL) ? "+" : "-",\r\nbt->il_vsync, bt->il_vbackporch);\r\npr_info("%s: pixelclock: %llu\n", dev_prefix, bt->pixelclock);\r\npr_info("%s: flags (0x%x):%s%s%s%s%s%s%s%s%s%s\n",\r\ndev_prefix, bt->flags,\r\n(bt->flags & V4L2_DV_FL_REDUCED_BLANKING) ?\r\n" REDUCED_BLANKING" : "",\r\n((bt->flags & V4L2_DV_FL_REDUCED_BLANKING) &&\r\nbt->vsync == 8) ? " (V2)" : "",\r\n(bt->flags & V4L2_DV_FL_CAN_REDUCE_FPS) ?\r\n" CAN_REDUCE_FPS" : "",\r\n(bt->flags & V4L2_DV_FL_REDUCED_FPS) ?\r\n" REDUCED_FPS" : "",\r\n(bt->flags & V4L2_DV_FL_HALF_LINE) ?\r\n" HALF_LINE" : "",\r\n(bt->flags & V4L2_DV_FL_IS_CE_VIDEO) ?\r\n" CE_VIDEO" : "",\r\n(bt->flags & V4L2_DV_FL_FIRST_FIELD_EXTRA_LINE) ?\r\n" FIRST_FIELD_EXTRA_LINE" : "",\r\n(bt->flags & V4L2_DV_FL_HAS_PICTURE_ASPECT) ?\r\n" HAS_PICTURE_ASPECT" : "",\r\n(bt->flags & V4L2_DV_FL_HAS_CEA861_VIC) ?\r\n" HAS_CEA861_VIC" : "",\r\n(bt->flags & V4L2_DV_FL_HAS_HDMI_VIC) ?\r\n" HAS_HDMI_VIC" : "");\r\npr_info("%s: standards (0x%x):%s%s%s%s%s\n", dev_prefix, bt->standards,\r\n(bt->standards & V4L2_DV_BT_STD_CEA861) ? " CEA" : "",\r\n(bt->standards & V4L2_DV_BT_STD_DMT) ? " DMT" : "",\r\n(bt->standards & V4L2_DV_BT_STD_CVT) ? " CVT" : "",\r\n(bt->standards & V4L2_DV_BT_STD_GTF) ? " GTF" : "",\r\n(bt->standards & V4L2_DV_BT_STD_SDI) ? " SDI" : "");\r\nif (bt->flags & V4L2_DV_FL_HAS_PICTURE_ASPECT)\r\npr_info("%s: picture aspect (hor:vert): %u:%u\n", dev_prefix,\r\nbt->picture_aspect.numerator,\r\nbt->picture_aspect.denominator);\r\nif (bt->flags & V4L2_DV_FL_HAS_CEA861_VIC)\r\npr_info("%s: CEA-861 VIC: %u\n", dev_prefix, bt->cea861_vic);\r\nif (bt->flags & V4L2_DV_FL_HAS_HDMI_VIC)\r\npr_info("%s: HDMI VIC: %u\n", dev_prefix, bt->hdmi_vic);\r\n}\r\nstruct v4l2_fract v4l2_dv_timings_aspect_ratio(const struct v4l2_dv_timings *t)\r\n{\r\nstruct v4l2_fract ratio = { 1, 1 };\r\nunsigned long n, d;\r\nif (t->type != V4L2_DV_BT_656_1120)\r\nreturn ratio;\r\nif (!(t->bt.flags & V4L2_DV_FL_HAS_PICTURE_ASPECT))\r\nreturn ratio;\r\nratio.numerator = t->bt.width * t->bt.picture_aspect.denominator;\r\nratio.denominator = t->bt.height * t->bt.picture_aspect.numerator;\r\nrational_best_approximation(ratio.numerator, ratio.denominator,\r\nratio.numerator, ratio.denominator, &n, &d);\r\nratio.numerator = n;\r\nratio.denominator = d;\r\nreturn ratio;\r\n}\r\nbool v4l2_detect_cvt(unsigned frame_height,\r\nunsigned hfreq,\r\nunsigned vsync,\r\nunsigned active_width,\r\nu32 polarities,\r\nbool interlaced,\r\nstruct v4l2_dv_timings *fmt)\r\n{\r\nint v_fp, v_bp, h_fp, h_bp, hsync;\r\nint frame_width, image_height, image_width;\r\nbool reduced_blanking;\r\nbool rb_v2 = false;\r\nunsigned pix_clk;\r\nif (vsync < 4 || vsync > 8)\r\nreturn false;\r\nif (polarities == V4L2_DV_VSYNC_POS_POL)\r\nreduced_blanking = false;\r\nelse if (polarities == V4L2_DV_HSYNC_POS_POL)\r\nreduced_blanking = true;\r\nelse\r\nreturn false;\r\nif (reduced_blanking && vsync == 8)\r\nrb_v2 = true;\r\nif (rb_v2 && active_width == 0)\r\nreturn false;\r\nif (!rb_v2 && vsync > 7)\r\nreturn false;\r\nif (hfreq == 0)\r\nreturn false;\r\nif (reduced_blanking) {\r\nif (rb_v2) {\r\nv_bp = CVT_RB_V_BPORCH;\r\nv_fp = (CVT_RB_MIN_V_BLANK * hfreq) / 1000000 + 1;\r\nv_fp -= vsync + v_bp;\r\nif (v_fp < CVT_RB_V2_MIN_V_FPORCH)\r\nv_fp = CVT_RB_V2_MIN_V_FPORCH;\r\n} else {\r\nv_fp = CVT_RB_V_FPORCH;\r\nv_bp = (CVT_RB_MIN_V_BLANK * hfreq) / 1000000 + 1;\r\nv_bp -= vsync + v_fp;\r\nif (v_bp < CVT_RB_MIN_V_BPORCH)\r\nv_bp = CVT_RB_MIN_V_BPORCH;\r\n}\r\n} else {\r\nv_fp = CVT_MIN_V_PORCH_RND;\r\nv_bp = (CVT_MIN_VSYNC_BP * hfreq) / 1000000 + 1 - vsync;\r\nif (v_bp < CVT_MIN_V_BPORCH)\r\nv_bp = CVT_MIN_V_BPORCH;\r\n}\r\nif (interlaced)\r\nimage_height = (frame_height - 2 * v_fp - 2 * vsync - 2 * v_bp) & ~0x1;\r\nelse\r\nimage_height = (frame_height - v_fp - vsync - v_bp + 1) & ~0x1;\r\nif (image_height < 0)\r\nreturn false;\r\nswitch (vsync) {\r\ncase 4:\r\nimage_width = (image_height * 4) / 3;\r\nbreak;\r\ncase 5:\r\nimage_width = (image_height * 16) / 9;\r\nbreak;\r\ncase 6:\r\nimage_width = (image_height * 16) / 10;\r\nbreak;\r\ncase 7:\r\nif (image_height == 1024)\r\nimage_width = (image_height * 5) / 4;\r\nelse if (image_height == 768)\r\nimage_width = (image_height * 15) / 9;\r\nelse\r\nreturn false;\r\nbreak;\r\ncase 8:\r\nimage_width = active_width;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nif (!rb_v2)\r\nimage_width = image_width & ~7;\r\nif (reduced_blanking) {\r\nint h_blank;\r\nint clk_gran;\r\nh_blank = rb_v2 ? CVT_RB_V2_H_BLANK : CVT_RB_H_BLANK;\r\nclk_gran = rb_v2 ? CVT_PXL_CLK_GRAN_RB_V2 : CVT_PXL_CLK_GRAN;\r\npix_clk = (image_width + h_blank) * hfreq;\r\npix_clk = (pix_clk / clk_gran) * clk_gran;\r\nh_bp = h_blank / 2;\r\nhsync = CVT_RB_H_SYNC;\r\nh_fp = h_blank - h_bp - hsync;\r\nframe_width = image_width + h_blank;\r\n} else {\r\nunsigned ideal_duty_cycle_per_myriad =\r\n100 * CVT_C_PRIME - (CVT_M_PRIME * 100000) / hfreq;\r\nint h_blank;\r\nif (ideal_duty_cycle_per_myriad < 2000)\r\nideal_duty_cycle_per_myriad = 2000;\r\nh_blank = image_width * ideal_duty_cycle_per_myriad /\r\n(10000 - ideal_duty_cycle_per_myriad);\r\nh_blank = (h_blank / (2 * CVT_CELL_GRAN)) * 2 * CVT_CELL_GRAN;\r\npix_clk = (image_width + h_blank) * hfreq;\r\npix_clk = (pix_clk / CVT_PXL_CLK_GRAN) * CVT_PXL_CLK_GRAN;\r\nh_bp = h_blank / 2;\r\nframe_width = image_width + h_blank;\r\nhsync = frame_width * CVT_HSYNC_PERCENT / 100;\r\nhsync = (hsync / CVT_CELL_GRAN) * CVT_CELL_GRAN;\r\nh_fp = h_blank - hsync - h_bp;\r\n}\r\nfmt->type = V4L2_DV_BT_656_1120;\r\nfmt->bt.polarities = polarities;\r\nfmt->bt.width = image_width;\r\nfmt->bt.height = image_height;\r\nfmt->bt.hfrontporch = h_fp;\r\nfmt->bt.vfrontporch = v_fp;\r\nfmt->bt.hsync = hsync;\r\nfmt->bt.vsync = vsync;\r\nfmt->bt.hbackporch = frame_width - image_width - h_fp - hsync;\r\nif (!interlaced) {\r\nfmt->bt.vbackporch = frame_height - image_height - v_fp - vsync;\r\nfmt->bt.interlaced = V4L2_DV_PROGRESSIVE;\r\n} else {\r\nfmt->bt.vbackporch = (frame_height - image_height - 2 * v_fp -\r\n2 * vsync) / 2;\r\nfmt->bt.il_vbackporch = frame_height - image_height - 2 * v_fp -\r\n2 * vsync - fmt->bt.vbackporch;\r\nfmt->bt.il_vfrontporch = v_fp;\r\nfmt->bt.il_vsync = vsync;\r\nfmt->bt.flags |= V4L2_DV_FL_HALF_LINE;\r\nfmt->bt.interlaced = V4L2_DV_INTERLACED;\r\n}\r\nfmt->bt.pixelclock = pix_clk;\r\nfmt->bt.standards = V4L2_DV_BT_STD_CVT;\r\nif (reduced_blanking)\r\nfmt->bt.flags |= V4L2_DV_FL_REDUCED_BLANKING;\r\nreturn true;\r\n}\r\nbool v4l2_detect_gtf(unsigned frame_height,\r\nunsigned hfreq,\r\nunsigned vsync,\r\nu32 polarities,\r\nbool interlaced,\r\nstruct v4l2_fract aspect,\r\nstruct v4l2_dv_timings *fmt)\r\n{\r\nint pix_clk;\r\nint v_fp, v_bp, h_fp, hsync;\r\nint frame_width, image_height, image_width;\r\nbool default_gtf;\r\nint h_blank;\r\nif (vsync != 3)\r\nreturn false;\r\nif (polarities == V4L2_DV_VSYNC_POS_POL)\r\ndefault_gtf = true;\r\nelse if (polarities == V4L2_DV_HSYNC_POS_POL)\r\ndefault_gtf = false;\r\nelse\r\nreturn false;\r\nif (hfreq == 0)\r\nreturn false;\r\nv_fp = GTF_V_FP;\r\nv_bp = (GTF_MIN_VSYNC_BP * hfreq + 500000) / 1000000 - vsync;\r\nif (interlaced)\r\nimage_height = (frame_height - 2 * v_fp - 2 * vsync - 2 * v_bp) & ~0x1;\r\nelse\r\nimage_height = (frame_height - v_fp - vsync - v_bp + 1) & ~0x1;\r\nif (image_height < 0)\r\nreturn false;\r\nif (aspect.numerator == 0 || aspect.denominator == 0) {\r\naspect.numerator = 16;\r\naspect.denominator = 9;\r\n}\r\nimage_width = ((image_height * aspect.numerator) / aspect.denominator);\r\nimage_width = (image_width + GTF_CELL_GRAN/2) & ~(GTF_CELL_GRAN - 1);\r\nif (default_gtf) {\r\nu64 num;\r\nu32 den;\r\nnum = ((image_width * GTF_D_C_PRIME * (u64)hfreq) -\r\n((u64)image_width * GTF_D_M_PRIME * 1000));\r\nden = (hfreq * (100 - GTF_D_C_PRIME) + GTF_D_M_PRIME * 1000) *\r\n(2 * GTF_CELL_GRAN);\r\nh_blank = div_u64((num + (den >> 1)), den);\r\nh_blank *= (2 * GTF_CELL_GRAN);\r\n} else {\r\nu64 num;\r\nu32 den;\r\nnum = ((image_width * GTF_S_C_PRIME * (u64)hfreq) -\r\n((u64)image_width * GTF_S_M_PRIME * 1000));\r\nden = (hfreq * (100 - GTF_S_C_PRIME) + GTF_S_M_PRIME * 1000) *\r\n(2 * GTF_CELL_GRAN);\r\nh_blank = div_u64((num + (den >> 1)), den);\r\nh_blank *= (2 * GTF_CELL_GRAN);\r\n}\r\nframe_width = image_width + h_blank;\r\npix_clk = (image_width + h_blank) * hfreq;\r\npix_clk = pix_clk / GTF_PXL_CLK_GRAN * GTF_PXL_CLK_GRAN;\r\nhsync = (frame_width * 8 + 50) / 100;\r\nhsync = ((hsync + GTF_CELL_GRAN / 2) / GTF_CELL_GRAN) * GTF_CELL_GRAN;\r\nh_fp = h_blank / 2 - hsync;\r\nfmt->type = V4L2_DV_BT_656_1120;\r\nfmt->bt.polarities = polarities;\r\nfmt->bt.width = image_width;\r\nfmt->bt.height = image_height;\r\nfmt->bt.hfrontporch = h_fp;\r\nfmt->bt.vfrontporch = v_fp;\r\nfmt->bt.hsync = hsync;\r\nfmt->bt.vsync = vsync;\r\nfmt->bt.hbackporch = frame_width - image_width - h_fp - hsync;\r\nif (!interlaced) {\r\nfmt->bt.vbackporch = frame_height - image_height - v_fp - vsync;\r\nfmt->bt.interlaced = V4L2_DV_PROGRESSIVE;\r\n} else {\r\nfmt->bt.vbackporch = (frame_height - image_height - 2 * v_fp -\r\n2 * vsync) / 2;\r\nfmt->bt.il_vbackporch = frame_height - image_height - 2 * v_fp -\r\n2 * vsync - fmt->bt.vbackporch;\r\nfmt->bt.il_vfrontporch = v_fp;\r\nfmt->bt.il_vsync = vsync;\r\nfmt->bt.flags |= V4L2_DV_FL_HALF_LINE;\r\nfmt->bt.interlaced = V4L2_DV_INTERLACED;\r\n}\r\nfmt->bt.pixelclock = pix_clk;\r\nfmt->bt.standards = V4L2_DV_BT_STD_GTF;\r\nif (!default_gtf)\r\nfmt->bt.flags |= V4L2_DV_FL_REDUCED_BLANKING;\r\nreturn true;\r\n}\r\nstruct v4l2_fract v4l2_calc_aspect_ratio(u8 hor_landscape, u8 vert_portrait)\r\n{\r\nstruct v4l2_fract aspect = { 16, 9 };\r\nu8 ratio;\r\nif (!hor_landscape && !vert_portrait)\r\nreturn aspect;\r\nif (hor_landscape && vert_portrait) {\r\naspect.numerator = hor_landscape;\r\naspect.denominator = vert_portrait;\r\nreturn aspect;\r\n}\r\nratio = hor_landscape | vert_portrait;\r\nif (ratio == 79) {\r\naspect.numerator = 16;\r\naspect.denominator = 9;\r\n} else if (ratio == 34) {\r\naspect.numerator = 4;\r\naspect.denominator = 3;\r\n} else if (ratio == 68) {\r\naspect.numerator = 15;\r\naspect.denominator = 9;\r\n} else {\r\naspect.numerator = hor_landscape + 99;\r\naspect.denominator = 100;\r\n}\r\nif (hor_landscape)\r\nreturn aspect;\r\nswap(aspect.denominator, aspect.numerator);\r\nreturn aspect;\r\n}

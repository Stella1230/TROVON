static int zynq_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct zynq_reset_data *priv = to_zynq_reset_data(rcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\npr_debug("%s: %s reset bank %u offset %u\n", KBUILD_MODNAME, __func__,\r\nbank, offset);\r\nreturn regmap_update_bits(priv->slcr,\r\npriv->offset + (bank * 4),\r\nBIT(offset),\r\nBIT(offset));\r\n}\r\nstatic int zynq_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct zynq_reset_data *priv = to_zynq_reset_data(rcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\npr_debug("%s: %s reset bank %u offset %u\n", KBUILD_MODNAME, __func__,\r\nbank, offset);\r\nreturn regmap_update_bits(priv->slcr,\r\npriv->offset + (bank * 4),\r\nBIT(offset),\r\n~BIT(offset));\r\n}\r\nstatic int zynq_reset_status(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct zynq_reset_data *priv = to_zynq_reset_data(rcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\nint ret;\r\nu32 reg;\r\npr_debug("%s: %s reset bank %u offset %u\n", KBUILD_MODNAME, __func__,\r\nbank, offset);\r\nret = regmap_read(priv->slcr, priv->offset + (bank * 4), &reg);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(reg & BIT(offset));\r\n}\r\nstatic int zynq_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct zynq_reset_data *priv;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, priv);\r\npriv->slcr = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\r\n"syscon");\r\nif (IS_ERR(priv->slcr)) {\r\ndev_err(&pdev->dev, "unable to get zynq-slcr regmap");\r\nreturn PTR_ERR(priv->slcr);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "missing IO resource\n");\r\nreturn -ENODEV;\r\n}\r\npriv->offset = res->start;\r\npriv->rcdev.owner = THIS_MODULE;\r\npriv->rcdev.nr_resets = resource_size(res) / 4 * BITS_PER_LONG;\r\npriv->rcdev.ops = &zynq_reset_ops;\r\npriv->rcdev.of_node = pdev->dev.of_node;\r\nreturn devm_reset_controller_register(&pdev->dev, &priv->rcdev);\r\n}

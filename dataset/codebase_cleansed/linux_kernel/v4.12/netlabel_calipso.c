static int netlbl_calipso_add_pass(struct genl_info *info,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val;\r\nstruct calipso_doi *doi_def = NULL;\r\ndoi_def = kmalloc(sizeof(*doi_def), GFP_KERNEL);\r\nif (!doi_def)\r\nreturn -ENOMEM;\r\ndoi_def->type = CALIPSO_MAP_PASS;\r\ndoi_def->doi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\r\nret_val = calipso_doi_add(doi_def, audit_info);\r\nif (ret_val != 0)\r\ncalipso_doi_free(doi_def);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_calipso_add(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct netlbl_audit audit_info;\r\nif (!info->attrs[NLBL_CALIPSO_A_DOI] ||\r\n!info->attrs[NLBL_CALIPSO_A_MTYPE])\r\nreturn -EINVAL;\r\nnetlbl_netlink_auditinfo(skb, &audit_info);\r\nswitch (nla_get_u32(info->attrs[NLBL_CALIPSO_A_MTYPE])) {\r\ncase CALIPSO_MAP_PASS:\r\nret_val = netlbl_calipso_add_pass(info, &audit_info);\r\nbreak;\r\n}\r\nif (ret_val == 0)\r\natomic_inc(&netlabel_mgmt_protocount);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_calipso_list(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val;\r\nstruct sk_buff *ans_skb = NULL;\r\nvoid *data;\r\nu32 doi;\r\nstruct calipso_doi *doi_def;\r\nif (!info->attrs[NLBL_CALIPSO_A_DOI]) {\r\nret_val = -EINVAL;\r\ngoto list_failure;\r\n}\r\ndoi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\r\ndoi_def = calipso_doi_getdef(doi);\r\nif (!doi_def) {\r\nret_val = -EINVAL;\r\ngoto list_failure;\r\n}\r\nans_skb = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!ans_skb) {\r\nret_val = -ENOMEM;\r\ngoto list_failure_put;\r\n}\r\ndata = genlmsg_put_reply(ans_skb, info, &netlbl_calipso_gnl_family,\r\n0, NLBL_CALIPSO_C_LIST);\r\nif (!data) {\r\nret_val = -ENOMEM;\r\ngoto list_failure_put;\r\n}\r\nret_val = nla_put_u32(ans_skb, NLBL_CALIPSO_A_MTYPE, doi_def->type);\r\nif (ret_val != 0)\r\ngoto list_failure_put;\r\ncalipso_doi_putdef(doi_def);\r\ngenlmsg_end(ans_skb, data);\r\nreturn genlmsg_reply(ans_skb, info);\r\nlist_failure_put:\r\ncalipso_doi_putdef(doi_def);\r\nlist_failure:\r\nkfree_skb(ans_skb);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_calipso_listall_cb(struct calipso_doi *doi_def, void *arg)\r\n{\r\nint ret_val = -ENOMEM;\r\nstruct netlbl_calipso_doiwalk_arg *cb_arg = arg;\r\nvoid *data;\r\ndata = genlmsg_put(cb_arg->skb, NETLINK_CB(cb_arg->nl_cb->skb).portid,\r\ncb_arg->seq, &netlbl_calipso_gnl_family,\r\nNLM_F_MULTI, NLBL_CALIPSO_C_LISTALL);\r\nif (!data)\r\ngoto listall_cb_failure;\r\nret_val = nla_put_u32(cb_arg->skb, NLBL_CALIPSO_A_DOI, doi_def->doi);\r\nif (ret_val != 0)\r\ngoto listall_cb_failure;\r\nret_val = nla_put_u32(cb_arg->skb,\r\nNLBL_CALIPSO_A_MTYPE,\r\ndoi_def->type);\r\nif (ret_val != 0)\r\ngoto listall_cb_failure;\r\ngenlmsg_end(cb_arg->skb, data);\r\nreturn 0;\r\nlistall_cb_failure:\r\ngenlmsg_cancel(cb_arg->skb, data);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_calipso_listall(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nstruct netlbl_calipso_doiwalk_arg cb_arg;\r\nu32 doi_skip = cb->args[0];\r\ncb_arg.nl_cb = cb;\r\ncb_arg.skb = skb;\r\ncb_arg.seq = cb->nlh->nlmsg_seq;\r\ncalipso_doi_walk(&doi_skip, netlbl_calipso_listall_cb, &cb_arg);\r\ncb->args[0] = doi_skip;\r\nreturn skb->len;\r\n}\r\nstatic int netlbl_calipso_remove_cb(struct netlbl_dom_map *entry, void *arg)\r\n{\r\nstruct netlbl_domhsh_walk_arg *cb_arg = arg;\r\nif (entry->def.type == NETLBL_NLTYPE_CALIPSO &&\r\nentry->def.calipso->doi == cb_arg->doi)\r\nreturn netlbl_domhsh_remove_entry(entry, cb_arg->audit_info);\r\nreturn 0;\r\n}\r\nstatic int netlbl_calipso_remove(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct netlbl_domhsh_walk_arg cb_arg;\r\nstruct netlbl_audit audit_info;\r\nu32 skip_bkt = 0;\r\nu32 skip_chain = 0;\r\nif (!info->attrs[NLBL_CALIPSO_A_DOI])\r\nreturn -EINVAL;\r\nnetlbl_netlink_auditinfo(skb, &audit_info);\r\ncb_arg.doi = nla_get_u32(info->attrs[NLBL_CALIPSO_A_DOI]);\r\ncb_arg.audit_info = &audit_info;\r\nret_val = netlbl_domhsh_walk(&skip_bkt, &skip_chain,\r\nnetlbl_calipso_remove_cb, &cb_arg);\r\nif (ret_val == 0 || ret_val == -ENOENT) {\r\nret_val = calipso_doi_remove(cb_arg.doi, &audit_info);\r\nif (ret_val == 0)\r\natomic_dec(&netlabel_mgmt_protocount);\r\n}\r\nreturn ret_val;\r\n}\r\nint __init netlbl_calipso_genl_init(void)\r\n{\r\nreturn genl_register_family(&netlbl_calipso_gnl_family);\r\n}\r\nconst struct netlbl_calipso_ops *\r\nnetlbl_calipso_ops_register(const struct netlbl_calipso_ops *ops)\r\n{\r\nreturn xchg(&calipso_ops, ops);\r\n}\r\nstatic const struct netlbl_calipso_ops *netlbl_calipso_ops_get(void)\r\n{\r\nreturn ACCESS_ONCE(calipso_ops);\r\n}\r\nint calipso_doi_add(struct calipso_doi *doi_def,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->doi_add(doi_def, audit_info);\r\nreturn ret_val;\r\n}\r\nvoid calipso_doi_free(struct calipso_doi *doi_def)\r\n{\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nops->doi_free(doi_def);\r\n}\r\nint calipso_doi_remove(u32 doi, struct netlbl_audit *audit_info)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->doi_remove(doi, audit_info);\r\nreturn ret_val;\r\n}\r\nstruct calipso_doi *calipso_doi_getdef(u32 doi)\r\n{\r\nstruct calipso_doi *ret_val = NULL;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->doi_getdef(doi);\r\nreturn ret_val;\r\n}\r\nvoid calipso_doi_putdef(struct calipso_doi *doi_def)\r\n{\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nops->doi_putdef(doi_def);\r\n}\r\nint calipso_doi_walk(u32 *skip_cnt,\r\nint (*callback)(struct calipso_doi *doi_def, void *arg),\r\nvoid *cb_arg)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->doi_walk(skip_cnt, callback, cb_arg);\r\nreturn ret_val;\r\n}\r\nint calipso_sock_getattr(struct sock *sk, struct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->sock_getattr(sk, secattr);\r\nreturn ret_val;\r\n}\r\nint calipso_sock_setattr(struct sock *sk,\r\nconst struct calipso_doi *doi_def,\r\nconst struct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->sock_setattr(sk, doi_def, secattr);\r\nreturn ret_val;\r\n}\r\nvoid calipso_sock_delattr(struct sock *sk)\r\n{\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nops->sock_delattr(sk);\r\n}\r\nint calipso_req_setattr(struct request_sock *req,\r\nconst struct calipso_doi *doi_def,\r\nconst struct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->req_setattr(req, doi_def, secattr);\r\nreturn ret_val;\r\n}\r\nvoid calipso_req_delattr(struct request_sock *req)\r\n{\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nops->req_delattr(req);\r\n}\r\nunsigned char *calipso_optptr(const struct sk_buff *skb)\r\n{\r\nunsigned char *ret_val = NULL;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->skbuff_optptr(skb);\r\nreturn ret_val;\r\n}\r\nint calipso_getattr(const unsigned char *calipso,\r\nstruct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->opt_getattr(calipso, secattr);\r\nreturn ret_val;\r\n}\r\nint calipso_skbuff_setattr(struct sk_buff *skb,\r\nconst struct calipso_doi *doi_def,\r\nconst struct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->skbuff_setattr(skb, doi_def, secattr);\r\nreturn ret_val;\r\n}\r\nint calipso_skbuff_delattr(struct sk_buff *skb)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->skbuff_delattr(skb);\r\nreturn ret_val;\r\n}\r\nvoid calipso_cache_invalidate(void)\r\n{\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nops->cache_invalidate();\r\n}\r\nint calipso_cache_add(const unsigned char *calipso_ptr,\r\nconst struct netlbl_lsm_secattr *secattr)\r\n{\r\nint ret_val = -ENOMSG;\r\nconst struct netlbl_calipso_ops *ops = netlbl_calipso_ops_get();\r\nif (ops)\r\nret_val = ops->cache_add(calipso_ptr, secattr);\r\nreturn ret_val;\r\n}

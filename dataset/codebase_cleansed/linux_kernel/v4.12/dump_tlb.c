void dump_tlb_regs(void)\r\n{\r\nconst int field = 2 * sizeof(unsigned long);\r\npr_info("Index : %0x\n", read_c0_index());\r\npr_info("PageMask : %0x\n", read_c0_pagemask());\r\nif (cpu_has_guestid)\r\npr_info("GuestCtl1: %0x\n", read_c0_guestctl1());\r\npr_info("EntryHi : %0*lx\n", field, read_c0_entryhi());\r\npr_info("EntryLo0 : %0*lx\n", field, read_c0_entrylo0());\r\npr_info("EntryLo1 : %0*lx\n", field, read_c0_entrylo1());\r\npr_info("Wired : %0x\n", read_c0_wired());\r\nswitch (current_cpu_type()) {\r\ncase CPU_R10000:\r\ncase CPU_R12000:\r\ncase CPU_R14000:\r\ncase CPU_R16000:\r\npr_info("FrameMask: %0x\n", read_c0_framemask());\r\nbreak;\r\n}\r\nif (cpu_has_small_pages || cpu_has_rixi || cpu_has_xpa)\r\npr_info("PageGrain: %0x\n", read_c0_pagegrain());\r\nif (cpu_has_htw) {\r\npr_info("PWField : %0*lx\n", field, read_c0_pwfield());\r\npr_info("PWSize : %0*lx\n", field, read_c0_pwsize());\r\npr_info("PWCtl : %0x\n", read_c0_pwctl());\r\n}\r\n}\r\nstatic inline const char *msk2str(unsigned int mask)\r\n{\r\nswitch (mask) {\r\ncase PM_4K: return "4kb";\r\ncase PM_16K: return "16kb";\r\ncase PM_64K: return "64kb";\r\ncase PM_256K: return "256kb";\r\n#ifdef CONFIG_CPU_CAVIUM_OCTEON\r\ncase PM_8K: return "8kb";\r\ncase PM_32K: return "32kb";\r\ncase PM_128K: return "128kb";\r\ncase PM_512K: return "512kb";\r\ncase PM_2M: return "2Mb";\r\ncase PM_8M: return "8Mb";\r\ncase PM_32M: return "32Mb";\r\n#endif\r\n#ifndef CONFIG_CPU_VR41XX\r\ncase PM_1M: return "1Mb";\r\ncase PM_4M: return "4Mb";\r\ncase PM_16M: return "16Mb";\r\ncase PM_64M: return "64Mb";\r\ncase PM_256M: return "256Mb";\r\ncase PM_1G: return "1Gb";\r\n#endif\r\n}\r\nreturn "";\r\n}\r\nstatic void dump_tlb(int first, int last)\r\n{\r\nunsigned long s_entryhi, entryhi, asid;\r\nunsigned long long entrylo0, entrylo1, pa;\r\nunsigned int s_index, s_pagemask, s_guestctl1 = 0;\r\nunsigned int pagemask, guestctl1 = 0, c0, c1, i;\r\nunsigned long asidmask = cpu_asid_mask(&current_cpu_data);\r\nint asidwidth = DIV_ROUND_UP(ilog2(asidmask) + 1, 4);\r\n#ifdef CONFIG_32BIT\r\nbool xpa = cpu_has_xpa && (read_c0_pagegrain() & PG_ELPA);\r\nint pwidth = xpa ? 11 : 8;\r\nint vwidth = 8;\r\n#else\r\nbool xpa = false;\r\nint pwidth = 11;\r\nint vwidth = 11;\r\n#endif\r\ns_pagemask = read_c0_pagemask();\r\ns_entryhi = read_c0_entryhi();\r\ns_index = read_c0_index();\r\nasid = s_entryhi & asidmask;\r\nif (cpu_has_guestid)\r\ns_guestctl1 = read_c0_guestctl1();\r\nfor (i = first; i <= last; i++) {\r\nwrite_c0_index(i);\r\nmtc0_tlbr_hazard();\r\ntlb_read();\r\ntlb_read_hazard();\r\npagemask = read_c0_pagemask();\r\nentryhi = read_c0_entryhi();\r\nentrylo0 = read_c0_entrylo0();\r\nentrylo1 = read_c0_entrylo1();\r\nif (cpu_has_guestid)\r\nguestctl1 = read_c0_guestctl1();\r\nif (cpu_has_tlbinv && entryhi & MIPS_ENTRYHI_EHINV)\r\ncontinue;\r\nif ((entryhi & ~0x1ffffUL) == CKSEG0)\r\ncontinue;\r\nif (!((entrylo0 | entrylo1) & ENTRYLO_G) &&\r\n(entryhi & asidmask) != asid)\r\ncontinue;\r\nprintk("Index: %2d pgmask=%s ", i, msk2str(pagemask));\r\nc0 = (entrylo0 & ENTRYLO_C) >> ENTRYLO_C_SHIFT;\r\nc1 = (entrylo1 & ENTRYLO_C) >> ENTRYLO_C_SHIFT;\r\npr_cont("va=%0*lx asid=%0*lx",\r\nvwidth, (entryhi & ~0x1fffUL),\r\nasidwidth, entryhi & asidmask);\r\nif (cpu_has_guestid)\r\npr_cont(" gid=%02lx",\r\n(guestctl1 & MIPS_GCTL1_RID)\r\n>> MIPS_GCTL1_RID_SHIFT);\r\npa = entrylo0 & ~(MIPS_ENTRYLO_RI | MIPS_ENTRYLO_XI);\r\nif (xpa)\r\npa |= (unsigned long long)readx_c0_entrylo0() << 30;\r\npa = (pa << 6) & PAGE_MASK;\r\npr_cont("\n\t[");\r\nif (cpu_has_rixi)\r\npr_cont("ri=%d xi=%d ",\r\n(entrylo0 & MIPS_ENTRYLO_RI) ? 1 : 0,\r\n(entrylo0 & MIPS_ENTRYLO_XI) ? 1 : 0);\r\npr_cont("pa=%0*llx c=%d d=%d v=%d g=%d] [",\r\npwidth, pa, c0,\r\n(entrylo0 & ENTRYLO_D) ? 1 : 0,\r\n(entrylo0 & ENTRYLO_V) ? 1 : 0,\r\n(entrylo0 & ENTRYLO_G) ? 1 : 0);\r\npa = entrylo1 & ~(MIPS_ENTRYLO_RI | MIPS_ENTRYLO_XI);\r\nif (xpa)\r\npa |= (unsigned long long)readx_c0_entrylo1() << 30;\r\npa = (pa << 6) & PAGE_MASK;\r\nif (cpu_has_rixi)\r\npr_cont("ri=%d xi=%d ",\r\n(entrylo1 & MIPS_ENTRYLO_RI) ? 1 : 0,\r\n(entrylo1 & MIPS_ENTRYLO_XI) ? 1 : 0);\r\npr_cont("pa=%0*llx c=%d d=%d v=%d g=%d]\n",\r\npwidth, pa, c1,\r\n(entrylo1 & ENTRYLO_D) ? 1 : 0,\r\n(entrylo1 & ENTRYLO_V) ? 1 : 0,\r\n(entrylo1 & ENTRYLO_G) ? 1 : 0);\r\n}\r\nprintk("\n");\r\nwrite_c0_entryhi(s_entryhi);\r\nwrite_c0_index(s_index);\r\nwrite_c0_pagemask(s_pagemask);\r\nif (cpu_has_guestid)\r\nwrite_c0_guestctl1(s_guestctl1);\r\n}\r\nvoid dump_tlb_all(void)\r\n{\r\ndump_tlb(0, current_cpu_data.tlbsize - 1);\r\n}

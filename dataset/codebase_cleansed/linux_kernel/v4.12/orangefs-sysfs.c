static ssize_t orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct orangefs_attribute *attribute;\r\nattribute = container_of(attr, struct orangefs_attribute, attr);\r\nif (!attribute->show)\r\nreturn -EIO;\r\nreturn attribute->show(kobj, attribute, buf);\r\n}\r\nstatic ssize_t orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct orangefs_attribute *attribute;\r\nif (!strcmp(kobj->name, PC_KOBJ_ID) ||\r\n!strcmp(kobj->name, STATS_KOBJ_ID))\r\nreturn -EPERM;\r\nattribute = container_of(attr, struct orangefs_attribute, attr);\r\nif (!attribute->store)\r\nreturn -EIO;\r\nreturn attribute->store(kobj, attribute, buf, len);\r\n}\r\nstatic ssize_t sysfs_int_show(struct kobject *kobj,\r\nstruct orangefs_attribute *attr, char *buf)\r\n{\r\nint rc = -EIO;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "sysfs_int_show: id:%s:\n",\r\nkobj->name);\r\nif (!strcmp(kobj->name, ORANGEFS_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "op_timeout_secs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\nop_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name,\r\n"slot_timeout_secs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\nslot_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name,\r\n"dcache_timeout_msecs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\norangefs_dcache_timeout_msecs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name,\r\n"getattr_timeout_msecs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\norangefs_getattr_timeout_msecs);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\n} else if (!strcmp(kobj->name, STATS_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "reads")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%lu\n",\r\norangefs_stats.reads);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name, "writes")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%lu\n",\r\norangefs_stats.writes);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\n}\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t sysfs_int_store(struct kobject *kobj,\r\nstruct orangefs_attribute *attr, const char *buf, size_t count)\r\n{\r\nint rc = 0;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"sysfs_int_store: start attr->attr.name:%s: buf:%s:\n",\r\nattr->attr.name, buf);\r\nif (!strcmp(attr->attr.name, "op_timeout_secs")) {\r\nrc = kstrtoint(buf, 0, &op_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name, "slot_timeout_secs")) {\r\nrc = kstrtoint(buf, 0, &slot_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name, "dcache_timeout_msecs")) {\r\nrc = kstrtoint(buf, 0, &orangefs_dcache_timeout_msecs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name, "getattr_timeout_msecs")) {\r\nrc = kstrtoint(buf, 0, &orangefs_getattr_timeout_msecs);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\nout:\r\nif (rc)\r\nrc = -EINVAL;\r\nelse\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t sysfs_service_op_show(struct kobject *kobj,\r\nstruct orangefs_attribute *attr, char *buf)\r\n{\r\nstruct orangefs_kernel_op_s *new_op = NULL;\r\nint rc = 0;\r\nchar *ser_op_type = NULL;\r\n__u32 op_alloc_type;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"sysfs_service_op_show: id:%s:\n",\r\nkobj->name);\r\nif (strcmp(kobj->name, PC_KOBJ_ID))\r\nop_alloc_type = ORANGEFS_VFS_OP_PARAM;\r\nelse\r\nop_alloc_type = ORANGEFS_VFS_OP_PERF_COUNT;\r\nnew_op = op_alloc(op_alloc_type);\r\nif (!new_op)\r\nreturn -ENOMEM;\r\nrc = is_daemon_in_service();\r\nif (rc) {\r\npr_info("%s: Client not running :%d:\n",\r\n__func__,\r\nis_daemon_in_service());\r\ngoto out;\r\n}\r\nif (strcmp(kobj->name, PC_KOBJ_ID))\r\nnew_op->upcall.req.param.type = ORANGEFS_PARAM_REQUEST_GET;\r\nif (!strcmp(kobj->name, ORANGEFS_KOBJ_ID)) {\r\nif (!(orangefs_features & ORANGEFS_FEATURE_READAHEAD) &&\r\n(!strcmp(attr->attr.name, "readahead_count") ||\r\n!strcmp(attr->attr.name, "readahead_size") ||\r\n!strcmp(attr->attr.name, "readahead_count_size") ||\r\n!strcmp(attr->attr.name, "readahead_readcnt"))) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nif (!strcmp(attr->attr.name, "perf_history_size"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_HISTORY_SIZE;\r\nelse if (!strcmp(attr->attr.name,\r\n"perf_time_interval_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_TIME_INTERVAL_SECS;\r\nelse if (!strcmp(attr->attr.name,\r\n"perf_counter_reset"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_RESET;\r\nelse if (!strcmp(attr->attr.name,\r\n"readahead_count"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_COUNT;\r\nelse if (!strcmp(attr->attr.name,\r\n"readahead_size"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_SIZE;\r\nelse if (!strcmp(attr->attr.name,\r\n"readahead_count_size"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_COUNT_SIZE;\r\nelse if (!strcmp(attr->attr.name,\r\n"readahead_readcnt"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_READCNT;\r\n} else if (!strcmp(kobj->name, ACACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "timeout_msecs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_TIMEOUT_MSECS;\r\nif (!strcmp(attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_HARD_LIMIT;\r\nif (!strcmp(attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_SOFT_LIMIT;\r\nif (!strcmp(attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj->name, CAPCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "timeout_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_TIMEOUT_SECS;\r\nif (!strcmp(attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_HARD_LIMIT;\r\nif (!strcmp(attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_SOFT_LIMIT;\r\nif (!strcmp(attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj->name, CCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "timeout_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_TIMEOUT_SECS;\r\nif (!strcmp(attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_HARD_LIMIT;\r\nif (!strcmp(attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_SOFT_LIMIT;\r\nif (!strcmp(attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj->name, NCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "timeout_msecs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_TIMEOUT_MSECS;\r\nif (!strcmp(attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_HARD_LIMIT;\r\nif (!strcmp(attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_SOFT_LIMIT;\r\nif (!strcmp(attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj->name, PC_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, ACACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_ACACHE;\r\nif (!strcmp(attr->attr.name, CAPCACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_CAPCACHE;\r\nif (!strcmp(attr->attr.name, NCACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_NCACHE;\r\n} else {\r\ngossip_err("sysfs_service_op_show: unknown kobj_id:%s:\n",\r\nkobj->name);\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nif (strcmp(kobj->name, PC_KOBJ_ID))\r\nser_op_type = "orangefs_param";\r\nelse\r\nser_op_type = "orangefs_perf_count";\r\nrc = service_operation(new_op, ser_op_type, ORANGEFS_OP_INTERRUPTIBLE);\r\nout:\r\nif (!rc) {\r\nif (strcmp(kobj->name, PC_KOBJ_ID)) {\r\nif (new_op->upcall.req.param.op ==\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_COUNT_SIZE) {\r\nrc = scnprintf(buf, PAGE_SIZE, "%d %d\n",\r\n(int)new_op->downcall.resp.param.u.\r\nvalue32[0],\r\n(int)new_op->downcall.resp.param.u.\r\nvalue32[1]);\r\n} else {\r\nrc = scnprintf(buf, PAGE_SIZE, "%d\n",\r\n(int)new_op->downcall.resp.param.u.value64);\r\n}\r\n} else {\r\nrc = scnprintf(\r\nbuf,\r\nPAGE_SIZE,\r\n"%s",\r\nnew_op->downcall.resp.perf_count.buffer);\r\n}\r\n}\r\nop_release(new_op);\r\nreturn rc;\r\n}\r\nstatic ssize_t sysfs_service_op_store(struct kobject *kobj,\r\nstruct orangefs_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct orangefs_kernel_op_s *new_op = NULL;\r\nint val = 0;\r\nint rc = 0;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"sysfs_service_op_store: id:%s:\n",\r\nkobj->name);\r\nnew_op = op_alloc(ORANGEFS_VFS_OP_PARAM);\r\nif (!new_op)\r\nreturn -EINVAL;\r\nrc = is_daemon_in_service();\r\nif (rc) {\r\npr_info("%s: Client not running :%d:\n",\r\n__func__,\r\nis_daemon_in_service());\r\ngoto out;\r\n}\r\nif (strcmp(kobj->name, ORANGEFS_KOBJ_ID) ||\r\nstrcmp(attr->attr.name, "readahead_count_size")) {\r\nrc = kstrtoint(buf, 0, &val);\r\nif (rc)\r\ngoto out;\r\n}\r\nnew_op->upcall.req.param.type = ORANGEFS_PARAM_REQUEST_SET;\r\nif (!strcmp(kobj->name, ORANGEFS_KOBJ_ID)) {\r\nif (!(orangefs_features & ORANGEFS_FEATURE_READAHEAD) &&\r\n(!strcmp(attr->attr.name, "readahead_count") ||\r\n!strcmp(attr->attr.name, "readahead_size") ||\r\n!strcmp(attr->attr.name, "readahead_count_size") ||\r\n!strcmp(attr->attr.name, "readahead_readcnt"))) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nif (!strcmp(attr->attr.name, "perf_history_size")) {\r\nif (val > 0) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_HISTORY_SIZE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"perf_time_interval_secs")) {\r\nif (val > 0) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_TIME_INTERVAL_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"perf_counter_reset")) {\r\nif ((val == 0) || (val == 1)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_RESET;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"readahead_count")) {\r\nif ((val >= 0)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_COUNT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"readahead_size")) {\r\nif ((val >= 0)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_SIZE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"readahead_count_size")) {\r\nint val1, val2;\r\nrc = sscanf(buf, "%d %d", &val1, &val2);\r\nif (rc < 2) {\r\nrc = 0;\r\ngoto out;\r\n}\r\nif ((val1 >= 0) && (val2 >= 0)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_COUNT_SIZE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\nnew_op->upcall.req.param.u.value32[0] = val1;\r\nnew_op->upcall.req.param.u.value32[1] = val2;\r\ngoto value_set;\r\n} else if (!strcmp(attr->attr.name,\r\n"readahead_readcnt")) {\r\nif ((val >= 0)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_READAHEAD_READCNT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj->name, ACACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "timeout_msecs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_TIMEOUT_MSECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj->name, CAPCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "timeout_secs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_TIMEOUT_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj->name, CCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "timeout_secs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_TIMEOUT_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj->name, NCACHE_KOBJ_ID)) {\r\nif (!strcmp(attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(attr->attr.name, "timeout_msecs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_TIMEOUT_MSECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else {\r\ngossip_err("sysfs_service_op_store: unknown kobj_id:%s:\n",\r\nkobj->name);\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nnew_op->upcall.req.param.u.value64 = val;\r\nvalue_set:\r\nrc = service_operation(new_op, "orangefs_param", ORANGEFS_OP_INTERRUPTIBLE);\r\nif (rc < 0) {\r\ngossip_err("sysfs_service_op_store: service op returned:%d:\n",\r\nrc);\r\nrc = 0;\r\n} else {\r\nrc = count;\r\n}\r\nout:\r\nop_release(new_op);\r\nif (rc == -ENOMEM || rc == 0)\r\nrc = -EINVAL;\r\nreturn rc;\r\n}\r\nint orangefs_sysfs_init(void)\r\n{\r\nint rc = -EINVAL;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "orangefs_sysfs_init: start\n");\r\norangefs_obj = kzalloc(sizeof(*orangefs_obj), GFP_KERNEL);\r\nif (!orangefs_obj)\r\ngoto out;\r\nrc = kobject_init_and_add(orangefs_obj,\r\n&orangefs_ktype,\r\nfs_kobj,\r\nORANGEFS_KOBJ_ID);\r\nif (rc)\r\ngoto ofs_obj_bail;\r\nkobject_uevent(orangefs_obj, KOBJ_ADD);\r\nacache_orangefs_obj = kzalloc(sizeof(*acache_orangefs_obj), GFP_KERNEL);\r\nif (!acache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ofs_obj_bail;\r\n}\r\nrc = kobject_init_and_add(acache_orangefs_obj,\r\n&acache_orangefs_ktype,\r\norangefs_obj,\r\nACACHE_KOBJ_ID);\r\nif (rc)\r\ngoto acache_obj_bail;\r\nkobject_uevent(acache_orangefs_obj, KOBJ_ADD);\r\ncapcache_orangefs_obj =\r\nkzalloc(sizeof(*capcache_orangefs_obj), GFP_KERNEL);\r\nif (!capcache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto acache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(capcache_orangefs_obj,\r\n&capcache_orangefs_ktype,\r\norangefs_obj,\r\nCAPCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto capcache_obj_bail;\r\nkobject_uevent(capcache_orangefs_obj, KOBJ_ADD);\r\nccache_orangefs_obj =\r\nkzalloc(sizeof(*ccache_orangefs_obj), GFP_KERNEL);\r\nif (!ccache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto capcache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(ccache_orangefs_obj,\r\n&ccache_orangefs_ktype,\r\norangefs_obj,\r\nCCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto ccache_obj_bail;\r\nkobject_uevent(ccache_orangefs_obj, KOBJ_ADD);\r\nncache_orangefs_obj = kzalloc(sizeof(*ncache_orangefs_obj), GFP_KERNEL);\r\nif (!ncache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ccache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(ncache_orangefs_obj,\r\n&ncache_orangefs_ktype,\r\norangefs_obj,\r\nNCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto ncache_obj_bail;\r\nkobject_uevent(ncache_orangefs_obj, KOBJ_ADD);\r\npc_orangefs_obj = kzalloc(sizeof(*pc_orangefs_obj), GFP_KERNEL);\r\nif (!pc_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ncache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(pc_orangefs_obj,\r\n&pc_orangefs_ktype,\r\norangefs_obj,\r\n"perf_counters");\r\nif (rc)\r\ngoto pc_obj_bail;\r\nkobject_uevent(pc_orangefs_obj, KOBJ_ADD);\r\nstats_orangefs_obj = kzalloc(sizeof(*stats_orangefs_obj), GFP_KERNEL);\r\nif (!stats_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto pc_obj_bail;\r\n}\r\nrc = kobject_init_and_add(stats_orangefs_obj,\r\n&stats_orangefs_ktype,\r\norangefs_obj,\r\nSTATS_KOBJ_ID);\r\nif (rc)\r\ngoto stats_obj_bail;\r\nkobject_uevent(stats_orangefs_obj, KOBJ_ADD);\r\ngoto out;\r\nstats_obj_bail:\r\nkobject_put(stats_orangefs_obj);\r\npc_obj_bail:\r\nkobject_put(pc_orangefs_obj);\r\nncache_obj_bail:\r\nkobject_put(ncache_orangefs_obj);\r\nccache_obj_bail:\r\nkobject_put(ccache_orangefs_obj);\r\ncapcache_obj_bail:\r\nkobject_put(capcache_orangefs_obj);\r\nacache_obj_bail:\r\nkobject_put(acache_orangefs_obj);\r\nofs_obj_bail:\r\nkobject_put(orangefs_obj);\r\nout:\r\nreturn rc;\r\n}\r\nvoid orangefs_sysfs_exit(void)\r\n{\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "orangefs_sysfs_exit: start\n");\r\nkobject_put(acache_orangefs_obj);\r\nkobject_put(capcache_orangefs_obj);\r\nkobject_put(ccache_orangefs_obj);\r\nkobject_put(ncache_orangefs_obj);\r\nkobject_put(pc_orangefs_obj);\r\nkobject_put(stats_orangefs_obj);\r\nkobject_put(orangefs_obj);\r\n}

void uwb_pal_init(struct uwb_pal *pal)\r\n{\r\nINIT_LIST_HEAD(&pal->node);\r\n}\r\nint uwb_pal_register(struct uwb_pal *pal)\r\n{\r\nstruct uwb_rc *rc = pal->rc;\r\nint ret;\r\nif (pal->device) {\r\nret = sysfs_create_link(&pal->device->kobj,\r\n&rc->uwb_dev.dev.kobj, "uwb_rc");\r\nif (ret < 0)\r\nreturn ret;\r\nret = sysfs_create_link(&rc->uwb_dev.dev.kobj,\r\n&pal->device->kobj, pal->name);\r\nif (ret < 0) {\r\nsysfs_remove_link(&pal->device->kobj, "uwb_rc");\r\nreturn ret;\r\n}\r\n}\r\npal->debugfs_dir = uwb_dbg_create_pal_dir(pal);\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nlist_add(&pal->node, &rc->pals);\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nreturn 0;\r\n}\r\nstatic int find_rc(struct device *dev, const void *data)\r\n{\r\nconst struct uwb_rc *target_rc = data;\r\nstruct uwb_rc *rc = dev_get_drvdata(dev);\r\nif (rc == NULL) {\r\nWARN_ON(1);\r\nreturn 0;\r\n}\r\nif (rc == target_rc) {\r\nif (rc->ready == 0)\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool uwb_rc_class_device_exists(struct uwb_rc *target_rc)\r\n{\r\nstruct device *dev;\r\ndev = class_find_device(&uwb_rc_class, NULL, target_rc, find_rc);\r\nput_device(dev);\r\nreturn (dev != NULL);\r\n}\r\nvoid uwb_pal_unregister(struct uwb_pal *pal)\r\n{\r\nstruct uwb_rc *rc = pal->rc;\r\nuwb_radio_stop(pal);\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nlist_del(&pal->node);\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\ndebugfs_remove(pal->debugfs_dir);\r\nif (pal->device) {\r\nif (uwb_rc_class_device_exists(rc))\r\nsysfs_remove_link(&rc->uwb_dev.dev.kobj, pal->name);\r\nsysfs_remove_link(&pal->device->kobj, "uwb_rc");\r\n}\r\n}\r\nvoid uwb_rc_pal_init(struct uwb_rc *rc)\r\n{\r\nINIT_LIST_HEAD(&rc->pals);\r\n}

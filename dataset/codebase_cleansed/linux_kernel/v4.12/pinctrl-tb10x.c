static inline void tb10x_pinctrl_set_config(struct tb10x_pinctrl *state,\r\nunsigned int port, unsigned int mode)\r\n{\r\nu32 pcfg;\r\nif (state->ports[port].count)\r\nreturn;\r\nstate->ports[port].mode = mode;\r\npcfg = ioread32(state->base) & ~(PCFG_PORT_MASK(port));\r\npcfg |= (mode << (PCFG_PORT_BITWIDTH * port)) & PCFG_PORT_MASK(port);\r\niowrite32(pcfg, state->base);\r\n}\r\nstatic inline unsigned int tb10x_pinctrl_get_config(\r\nstruct tb10x_pinctrl *state,\r\nunsigned int port)\r\n{\r\nreturn (ioread32(state->base) & PCFG_PORT_MASK(port))\r\n>> (PCFG_PORT_BITWIDTH * port);\r\n}\r\nstatic int tb10x_get_groups_count(struct pinctrl_dev *pctl)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nreturn state->pinfuncgrpcnt;\r\n}\r\nstatic const char *tb10x_get_group_name(struct pinctrl_dev *pctl, unsigned n)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nreturn state->pingroups[n].name;\r\n}\r\nstatic int tb10x_get_group_pins(struct pinctrl_dev *pctl, unsigned n,\r\nunsigned const **pins,\r\nunsigned * const num_pins)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\n*pins = state->pingroups[n].pins;\r\n*num_pins = state->pingroups[n].pincnt;\r\nreturn 0;\r\n}\r\nstatic int tb10x_dt_node_to_map(struct pinctrl_dev *pctl,\r\nstruct device_node *np_config,\r\nstruct pinctrl_map **map, unsigned *num_maps)\r\n{\r\nconst char *string;\r\nunsigned reserved_maps = 0;\r\nint ret = 0;\r\nif (of_property_read_string(np_config, "abilis,function", &string)) {\r\npr_err("%s: No abilis,function property in device tree.\n",\r\nnp_config->full_name);\r\nreturn -EINVAL;\r\n}\r\n*map = NULL;\r\n*num_maps = 0;\r\nret = pinctrl_utils_reserve_map(pctl, map, &reserved_maps,\r\nnum_maps, 1);\r\nif (ret)\r\ngoto out;\r\nret = pinctrl_utils_add_map_mux(pctl, map, &reserved_maps,\r\nnum_maps, string, np_config->name);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int tb10x_get_functions_count(struct pinctrl_dev *pctl)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nreturn state->pinfuncnt;\r\n}\r\nstatic const char *tb10x_get_function_name(struct pinctrl_dev *pctl,\r\nunsigned n)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nreturn state->pinfuncs[n].name;\r\n}\r\nstatic int tb10x_get_function_groups(struct pinctrl_dev *pctl,\r\nunsigned n, const char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\n*groups = &state->pinfuncs[n].group;\r\n*num_groups = 1;\r\nreturn 0;\r\n}\r\nstatic int tb10x_gpio_request_enable(struct pinctrl_dev *pctl,\r\nstruct pinctrl_gpio_range *range,\r\nunsigned pin)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nint muxport = -1;\r\nint muxmode = -1;\r\nint i;\r\nmutex_lock(&state->mutex);\r\nfor (i = 0; i < state->pinfuncgrpcnt; i++) {\r\nconst struct tb10x_pinfuncgrp *pfg = &state->pingroups[i];\r\nunsigned int mode = pfg->mode;\r\nint j, port = pfg->port;\r\nif (port < 0)\r\ncontinue;\r\nfor (j = 0; j < pfg->pincnt; j++) {\r\nif (pin == pfg->pins[j]) {\r\nif (pfg->isgpio) {\r\nmuxport = port;\r\nmuxmode = mode;\r\n} else if (state->ports[port].count\r\n&& (state->ports[port].mode == mode)) {\r\nmutex_unlock(&state->mutex);\r\nreturn -EBUSY;\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nset_bit(pin, state->gpios);\r\nif (muxport >= 0)\r\ntb10x_pinctrl_set_config(state, muxport, muxmode);\r\nmutex_unlock(&state->mutex);\r\nreturn 0;\r\n}\r\nstatic void tb10x_gpio_disable_free(struct pinctrl_dev *pctl,\r\nstruct pinctrl_gpio_range *range,\r\nunsigned pin)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nmutex_lock(&state->mutex);\r\nclear_bit(pin, state->gpios);\r\nmutex_unlock(&state->mutex);\r\n}\r\nstatic int tb10x_pctl_set_mux(struct pinctrl_dev *pctl,\r\nunsigned func_selector, unsigned group_selector)\r\n{\r\nstruct tb10x_pinctrl *state = pinctrl_dev_get_drvdata(pctl);\r\nconst struct tb10x_pinfuncgrp *grp = &state->pingroups[group_selector];\r\nint i;\r\nif (grp->port < 0)\r\nreturn 0;\r\nmutex_lock(&state->mutex);\r\nif (state->ports[grp->port].count\r\n&& (state->ports[grp->port].mode != grp->mode)) {\r\nmutex_unlock(&state->mutex);\r\nreturn -EBUSY;\r\n}\r\nfor (i = 0; i < grp->pincnt; i++)\r\nif (test_bit(grp->pins[i], state->gpios)) {\r\nmutex_unlock(&state->mutex);\r\nreturn -EBUSY;\r\n}\r\ntb10x_pinctrl_set_config(state, grp->port, grp->mode);\r\nstate->ports[grp->port].count++;\r\nmutex_unlock(&state->mutex);\r\nreturn 0;\r\n}\r\nstatic int tb10x_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nint ret = -EINVAL;\r\nstruct resource *mem;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *of_node = dev->of_node;\r\nstruct device_node *child;\r\nstruct tb10x_pinctrl *state;\r\nint i;\r\nif (!of_node) {\r\ndev_err(dev, "No device tree node found.\n");\r\nreturn -EINVAL;\r\n}\r\nstate = devm_kzalloc(dev, sizeof(struct tb10x_pinctrl) +\r\nof_get_child_count(of_node)\r\n* sizeof(struct tb10x_of_pinfunc),\r\nGFP_KERNEL);\r\nif (!state)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, state);\r\nstate->pinfuncs = (struct tb10x_of_pinfunc *)(state + 1);\r\nmutex_init(&state->mutex);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nstate->base = devm_ioremap_resource(dev, mem);\r\nif (IS_ERR(state->base)) {\r\nret = PTR_ERR(state->base);\r\ngoto fail;\r\n}\r\nstate->pingroups = tb10x_pingroups;\r\nstate->pinfuncgrpcnt = ARRAY_SIZE(tb10x_pingroups);\r\nfor (i = 0; i < TB10X_PORTS; i++)\r\nstate->ports[i].mode = tb10x_pinctrl_get_config(state, i);\r\nfor_each_child_of_node(of_node, child) {\r\nconst char *name;\r\nif (!of_property_read_string(child, "abilis,function",\r\n&name)) {\r\nstate->pinfuncs[state->pinfuncnt].name = child->name;\r\nstate->pinfuncs[state->pinfuncnt].group = name;\r\nstate->pinfuncnt++;\r\n}\r\n}\r\nstate->pctl = devm_pinctrl_register(dev, &tb10x_pindesc, state);\r\nif (IS_ERR(state->pctl)) {\r\ndev_err(dev, "could not register TB10x pin driver\n");\r\nret = PTR_ERR(state->pctl);\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nmutex_destroy(&state->mutex);\r\nreturn ret;\r\n}\r\nstatic int tb10x_pinctrl_remove(struct platform_device *pdev)\r\n{\r\nstruct tb10x_pinctrl *state = platform_get_drvdata(pdev);\r\nmutex_destroy(&state->mutex);\r\nreturn 0;\r\n}

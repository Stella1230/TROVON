static int vendor_command(struct usb_device *dev, unsigned char request,\r\nunsigned char value, unsigned char index,\r\nvoid *buf, int size)\r\n{\r\nreturn usb_control_msg(dev, usb_rcvctrlpipe(dev, 0),\r\nrequest,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_OTHER,\r\nvalue,\r\nindex, buf, size,\r\nUSB_CTRL_GET_TIMEOUT);\r\n}\r\nstatic ssize_t show_brightness(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nreturn sprintf(buf, "%i", cytherm->brightness);\r\n}\r\nstatic ssize_t set_brightness(struct device *dev, struct device_attribute *attr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nunsigned char *buffer;\r\nint retval;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\ncytherm->brightness = simple_strtoul(buf, NULL, 10);\r\nif (cytherm->brightness > 0xFF)\r\ncytherm->brightness = 0xFF;\r\nelse if (cytherm->brightness < 0)\r\ncytherm->brightness = 0;\r\nretval = vendor_command(cytherm->udev, WRITE_RAM, BRIGHTNESS,\r\ncytherm->brightness, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nretval = vendor_command(cytherm->udev, WRITE_RAM, BRIGHTNESS_SEM,\r\n0x01, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nkfree(buffer);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nint retval;\r\nunsigned char *buffer;\r\nint temp, sign;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nretval = vendor_command(cytherm->udev, READ_RAM, TEMP, 0, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\ntemp = buffer[1];\r\nretval = vendor_command(cytherm->udev, READ_RAM, SIGN, 0, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nsign = buffer[1];\r\nkfree(buffer);\r\nreturn sprintf(buf, "%c%i.%i", sign ? '-' : '+', temp >> 1,\r\n5*(temp - ((temp >> 1) << 1)));\r\n}\r\nstatic ssize_t set_temp(struct device *dev, struct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn count;\r\n}\r\nstatic ssize_t show_button(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nint retval;\r\nunsigned char *buffer;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nretval = vendor_command(cytherm->udev, READ_RAM, BUTTON, 0, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nretval = buffer[1];\r\nkfree(buffer);\r\nif (retval)\r\nreturn sprintf(buf, "1");\r\nelse\r\nreturn sprintf(buf, "0");\r\n}\r\nstatic ssize_t set_button(struct device *dev, struct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn count;\r\n}\r\nstatic ssize_t show_port0(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nint retval;\r\nunsigned char *buffer;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nretval = vendor_command(cytherm->udev, READ_PORT, 0, 0, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nretval = buffer[1];\r\nkfree(buffer);\r\nreturn sprintf(buf, "%d", retval);\r\n}\r\nstatic ssize_t set_port0(struct device *dev, struct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nunsigned char *buffer;\r\nint retval;\r\nint tmp;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\ntmp = simple_strtoul(buf, NULL, 10);\r\nif (tmp > 0xFF)\r\ntmp = 0xFF;\r\nelse if (tmp < 0)\r\ntmp = 0;\r\nretval = vendor_command(cytherm->udev, WRITE_PORT, 0,\r\ntmp, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nkfree(buffer);\r\nreturn count;\r\n}\r\nstatic ssize_t show_port1(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nint retval;\r\nunsigned char *buffer;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nretval = vendor_command(cytherm->udev, READ_PORT, 1, 0, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nretval = buffer[1];\r\nkfree(buffer);\r\nreturn sprintf(buf, "%d", retval);\r\n}\r\nstatic ssize_t set_port1(struct device *dev, struct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_cytherm *cytherm = usb_get_intfdata(intf);\r\nunsigned char *buffer;\r\nint retval;\r\nint tmp;\r\nbuffer = kmalloc(8, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\ntmp = simple_strtoul(buf, NULL, 10);\r\nif (tmp > 0xFF)\r\ntmp = 0xFF;\r\nelse if (tmp < 0)\r\ntmp = 0;\r\nretval = vendor_command(cytherm->udev, WRITE_PORT, 1,\r\ntmp, buffer, 8);\r\nif (retval)\r\ndev_dbg(&cytherm->udev->dev, "retval = %d\n", retval);\r\nkfree(buffer);\r\nreturn count;\r\n}\r\nstatic int cytherm_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(interface);\r\nstruct usb_cytherm *dev = NULL;\r\nint retval = -ENOMEM;\r\ndev = kzalloc (sizeof(struct usb_cytherm), GFP_KERNEL);\r\nif (!dev)\r\ngoto error_mem;\r\ndev->udev = usb_get_dev(udev);\r\nusb_set_intfdata (interface, dev);\r\ndev->brightness = 0xFF;\r\nretval = device_create_file(&interface->dev, &dev_attr_brightness);\r\nif (retval)\r\ngoto error;\r\nretval = device_create_file(&interface->dev, &dev_attr_temp);\r\nif (retval)\r\ngoto error;\r\nretval = device_create_file(&interface->dev, &dev_attr_button);\r\nif (retval)\r\ngoto error;\r\nretval = device_create_file(&interface->dev, &dev_attr_port0);\r\nif (retval)\r\ngoto error;\r\nretval = device_create_file(&interface->dev, &dev_attr_port1);\r\nif (retval)\r\ngoto error;\r\ndev_info (&interface->dev,\r\n"Cypress thermometer device now attached\n");\r\nreturn 0;\r\nerror:\r\ndevice_remove_file(&interface->dev, &dev_attr_brightness);\r\ndevice_remove_file(&interface->dev, &dev_attr_temp);\r\ndevice_remove_file(&interface->dev, &dev_attr_button);\r\ndevice_remove_file(&interface->dev, &dev_attr_port0);\r\ndevice_remove_file(&interface->dev, &dev_attr_port1);\r\nusb_set_intfdata (interface, NULL);\r\nusb_put_dev(dev->udev);\r\nkfree(dev);\r\nerror_mem:\r\nreturn retval;\r\n}\r\nstatic void cytherm_disconnect(struct usb_interface *interface)\r\n{\r\nstruct usb_cytherm *dev;\r\ndev = usb_get_intfdata (interface);\r\ndevice_remove_file(&interface->dev, &dev_attr_brightness);\r\ndevice_remove_file(&interface->dev, &dev_attr_temp);\r\ndevice_remove_file(&interface->dev, &dev_attr_button);\r\ndevice_remove_file(&interface->dev, &dev_attr_port0);\r\ndevice_remove_file(&interface->dev, &dev_attr_port1);\r\nusb_set_intfdata (interface, NULL);\r\nusb_put_dev(dev->udev);\r\nkfree(dev);\r\ndev_info(&interface->dev, "Cypress thermometer now disconnected\n");\r\n}

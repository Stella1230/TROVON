static int zx2967_thermal_get_temp(void *data, int *temp)\r\n{\r\nvoid __iomem *regs;\r\nstruct zx2967_thermal_priv *priv = data;\r\nu32 val;\r\nint ret;\r\nif (!priv->tzd)\r\nreturn -EAGAIN;\r\nregs = priv->regs;\r\nmutex_lock(&priv->lock);\r\nwritel_relaxed(ZX2967_POWER_MODE_LOW,\r\nregs + ZX2967_THERMAL_POWER_MODE);\r\nwritel_relaxed(ZX2967_DCF_EN, regs + ZX2967_THERMAL_DCF);\r\nval = readl_relaxed(regs + ZX2967_THERMAL_SEL);\r\nval &= ~ZX2967_THERMAL_ID_MASK;\r\nval |= ZX2967_THERMAL_ID;\r\nwritel_relaxed(val, regs + ZX2967_THERMAL_SEL);\r\nusleep_range(100, 300);\r\nret = readx_poll_timeout(readl, regs + ZX2967_THERMAL_CTRL,\r\nval, val & ZX2967_THERMAL_READY, 300,\r\nZX2967_GET_TEMP_TIMEOUT_US);\r\nif (ret) {\r\ndev_err(priv->dev, "Thermal sensor data timeout\n");\r\ngoto unlock;\r\n}\r\nwritel_relaxed(ZX2967_DCF_FREEZE | ZX2967_DCF_EN,\r\nregs + ZX2967_THERMAL_DCF);\r\nval = readl_relaxed(regs + ZX2967_THERMAL_CTRL)\r\n& ZX2967_THERMAL_TEMP_MASK;\r\nwritel_relaxed(ZX2967_POWER_MODE_HIGH,\r\nregs + ZX2967_THERMAL_POWER_MODE);\r\n*temp = DIV_ROUND_CLOSEST(((s32)val + priv->tzd->tzp->offset) * 1000,\r\npriv->tzd->tzp->slope);\r\nunlock:\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int zx2967_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct zx2967_thermal_priv *priv;\r\nstruct resource *res;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->regs))\r\nreturn PTR_ERR(priv->regs);\r\npriv->clk_topcrm = devm_clk_get(&pdev->dev, "topcrm");\r\nif (IS_ERR(priv->clk_topcrm)) {\r\nret = PTR_ERR(priv->clk_topcrm);\r\ndev_err(&pdev->dev, "failed to get topcrm clock: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(priv->clk_topcrm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to enable topcrm clock: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\npriv->clk_apb = devm_clk_get(&pdev->dev, "apb");\r\nif (IS_ERR(priv->clk_apb)) {\r\nret = PTR_ERR(priv->clk_apb);\r\ndev_err(&pdev->dev, "failed to get apb clock: %d\n", ret);\r\ngoto disable_clk_topcrm;\r\n}\r\nret = clk_prepare_enable(priv->clk_apb);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to enable apb clock: %d\n",\r\nret);\r\ngoto disable_clk_topcrm;\r\n}\r\nmutex_init(&priv->lock);\r\npriv->tzd = thermal_zone_of_sensor_register(&pdev->dev,\r\n0, priv, &zx2967_of_thermal_ops);\r\nif (IS_ERR(priv->tzd)) {\r\nret = PTR_ERR(priv->tzd);\r\ndev_err(&pdev->dev, "failed to register sensor: %d\n", ret);\r\ngoto disable_clk_all;\r\n}\r\nif (priv->tzd->tzp->slope == 0) {\r\nthermal_zone_of_sensor_unregister(&pdev->dev, priv->tzd);\r\ndev_err(&pdev->dev, "coefficients of sensor is invalid\n");\r\nret = -EINVAL;\r\ngoto disable_clk_all;\r\n}\r\npriv->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, priv);\r\nreturn 0;\r\ndisable_clk_all:\r\nclk_disable_unprepare(priv->clk_apb);\r\ndisable_clk_topcrm:\r\nclk_disable_unprepare(priv->clk_topcrm);\r\nreturn ret;\r\n}\r\nstatic int zx2967_thermal_exit(struct platform_device *pdev)\r\n{\r\nstruct zx2967_thermal_priv *priv = platform_get_drvdata(pdev);\r\nthermal_zone_of_sensor_unregister(&pdev->dev, priv->tzd);\r\nclk_disable_unprepare(priv->clk_topcrm);\r\nclk_disable_unprepare(priv->clk_apb);\r\nreturn 0;\r\n}\r\nstatic int zx2967_thermal_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct zx2967_thermal_priv *priv = platform_get_drvdata(pdev);\r\nif (priv && priv->clk_topcrm)\r\nclk_disable_unprepare(priv->clk_topcrm);\r\nif (priv && priv->clk_apb)\r\nclk_disable_unprepare(priv->clk_apb);\r\nreturn 0;\r\n}\r\nstatic int zx2967_thermal_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct zx2967_thermal_priv *priv = platform_get_drvdata(pdev);\r\nint error;\r\nerror = clk_prepare_enable(priv->clk_topcrm);\r\nif (error)\r\nreturn error;\r\nerror = clk_prepare_enable(priv->clk_apb);\r\nif (error) {\r\nclk_disable_unprepare(priv->clk_topcrm);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

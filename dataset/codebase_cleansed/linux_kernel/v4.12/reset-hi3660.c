static int hi3660_reset_program_hw(struct reset_controller_dev *rcdev,\r\nunsigned long idx, bool assert)\r\n{\r\nstruct hi3660_reset_controller *rc = to_hi3660_reset_controller(rcdev);\r\nunsigned int offset = idx >> 8;\r\nunsigned int mask = BIT(idx & 0x1f);\r\nif (assert)\r\nreturn regmap_write(rc->map, offset, mask);\r\nelse\r\nreturn regmap_write(rc->map, offset + 4, mask);\r\n}\r\nstatic int hi3660_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long idx)\r\n{\r\nreturn hi3660_reset_program_hw(rcdev, idx, true);\r\n}\r\nstatic int hi3660_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long idx)\r\n{\r\nreturn hi3660_reset_program_hw(rcdev, idx, false);\r\n}\r\nstatic int hi3660_reset_dev(struct reset_controller_dev *rcdev,\r\nunsigned long idx)\r\n{\r\nint err;\r\nerr = hi3660_reset_assert(rcdev, idx);\r\nif (err)\r\nreturn err;\r\nreturn hi3660_reset_deassert(rcdev, idx);\r\n}\r\nstatic int hi3660_reset_xlate(struct reset_controller_dev *rcdev,\r\nconst struct of_phandle_args *reset_spec)\r\n{\r\nunsigned int offset, bit;\r\noffset = reset_spec->args[0];\r\nbit = reset_spec->args[1];\r\nreturn (offset << 8) | bit;\r\n}\r\nstatic int hi3660_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct hi3660_reset_controller *rc;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device *dev = &pdev->dev;\r\nrc = devm_kzalloc(dev, sizeof(*rc), GFP_KERNEL);\r\nif (!rc)\r\nreturn -ENOMEM;\r\nrc->map = syscon_regmap_lookup_by_phandle(np, "hisi,rst-syscon");\r\nif (IS_ERR(rc->map)) {\r\ndev_err(dev, "failed to get hi3660,rst-syscon\n");\r\nreturn PTR_ERR(rc->map);\r\n}\r\nrc->rst.ops = &hi3660_reset_ops,\r\nrc->rst.of_node = np;\r\nrc->rst.of_reset_n_cells = 2;\r\nrc->rst.of_xlate = hi3660_reset_xlate;\r\nreturn reset_controller_register(&rc->rst);\r\n}\r\nstatic int __init hi3660_reset_init(void)\r\n{\r\nreturn platform_driver_register(&hi3660_reset_driver);\r\n}

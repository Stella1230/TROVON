void mdp4_set_irqmask(struct mdp_kms *mdp_kms, uint32_t irqmask,\r\nuint32_t old_irqmask)\r\n{\r\nmdp4_write(to_mdp4_kms(mdp_kms), REG_MDP4_INTR_CLEAR,\r\nirqmask ^ (irqmask & old_irqmask));\r\nmdp4_write(to_mdp4_kms(mdp_kms), REG_MDP4_INTR_ENABLE, irqmask);\r\n}\r\nstatic void mdp4_irq_error_handler(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nstruct mdp4_kms *mdp4_kms = container_of(irq, struct mdp4_kms, error_handler);\r\nstatic DEFINE_RATELIMIT_STATE(rs, 5*HZ, 1);\r\nextern bool dumpstate;\r\nDRM_ERROR_RATELIMITED("errors: %08x\n", irqstatus);\r\nif (dumpstate && __ratelimit(&rs)) {\r\nstruct drm_printer p = drm_info_printer(mdp4_kms->dev->dev);\r\ndrm_state_dump(mdp4_kms->dev, &p);\r\n}\r\n}\r\nvoid mdp4_irq_preinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(to_mdp_kms(kms));\r\nmdp4_enable(mdp4_kms);\r\nmdp4_write(mdp4_kms, REG_MDP4_INTR_CLEAR, 0xffffffff);\r\nmdp4_write(mdp4_kms, REG_MDP4_INTR_ENABLE, 0x00000000);\r\nmdp4_disable(mdp4_kms);\r\n}\r\nint mdp4_irq_postinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(mdp_kms);\r\nstruct mdp_irq *error_handler = &mdp4_kms->error_handler;\r\nerror_handler->irq = mdp4_irq_error_handler;\r\nerror_handler->irqmask = MDP4_IRQ_PRIMARY_INTF_UDERRUN |\r\nMDP4_IRQ_EXTERNAL_INTF_UDERRUN;\r\nmdp_irq_register(mdp_kms, error_handler);\r\nreturn 0;\r\n}\r\nvoid mdp4_irq_uninstall(struct msm_kms *kms)\r\n{\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(to_mdp_kms(kms));\r\nmdp4_enable(mdp4_kms);\r\nmdp4_write(mdp4_kms, REG_MDP4_INTR_ENABLE, 0x00000000);\r\nmdp4_disable(mdp4_kms);\r\n}\r\nirqreturn_t mdp4_irq(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(mdp_kms);\r\nstruct drm_device *dev = mdp4_kms->dev;\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nunsigned int id;\r\nuint32_t status, enable;\r\nenable = mdp4_read(mdp4_kms, REG_MDP4_INTR_ENABLE);\r\nstatus = mdp4_read(mdp4_kms, REG_MDP4_INTR_STATUS) & enable;\r\nmdp4_write(mdp4_kms, REG_MDP4_INTR_CLEAR, status);\r\nVERB("status=%08x", status);\r\nmdp_dispatch_irqs(mdp_kms, status);\r\nfor (id = 0; id < priv->num_crtcs; id++)\r\nif (status & mdp4_crtc_vblank(priv->crtcs[id]))\r\ndrm_handle_vblank(dev, id);\r\nreturn IRQ_HANDLED;\r\n}\r\nint mdp4_enable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(to_mdp_kms(kms));\r\nmdp4_enable(mdp4_kms);\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp4_crtc_vblank(crtc), true);\r\nmdp4_disable(mdp4_kms);\r\nreturn 0;\r\n}\r\nvoid mdp4_disable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_kms *mdp4_kms = to_mdp4_kms(to_mdp_kms(kms));\r\nmdp4_enable(mdp4_kms);\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp4_crtc_vblank(crtc), false);\r\nmdp4_disable(mdp4_kms);\r\n}

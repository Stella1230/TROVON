static inline int\r\nramxlat(const struct ramxlat *xlat, int id)\r\n{\r\nwhile (xlat->id >= 0) {\r\nif (xlat->id == id)\r\nreturn xlat->enc;\r\nxlat++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint\r\nnvkm_sddr3_calc(struct nvkm_ram *ram)\r\n{\r\nint CWL, CL, WR, DLL = 0, ODT = 0;\r\nDLL = !ram->next->bios.ramcfg_DLLoff;\r\nswitch (ram->next->bios.timing_ver) {\r\ncase 0x10:\r\nif (ram->next->bios.timing_hdr < 0x17) {\r\nreturn -ENOSYS;\r\n}\r\nCWL = ram->next->bios.timing_10_CWL;\r\nCL = ram->next->bios.timing_10_CL;\r\nWR = ram->next->bios.timing_10_WR;\r\nODT = ram->next->bios.timing_10_ODT;\r\nbreak;\r\ncase 0x20:\r\nCWL = (ram->next->bios.timing[1] & 0x00000f80) >> 7;\r\nCL = (ram->next->bios.timing[1] & 0x0000001f) >> 0;\r\nWR = (ram->next->bios.timing[2] & 0x007f0000) >> 16;\r\nODT = (ram->mr[1] & 0x004) >> 2 |\r\n(ram->mr[1] & 0x040) >> 5 |\r\n(ram->mr[1] & 0x200) >> 7;\r\nbreak;\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\nCWL = ramxlat(ramddr3_cwl, CWL);\r\nCL = ramxlat(ramddr3_cl, CL);\r\nWR = ramxlat(ramddr3_wr, WR);\r\nif (CL < 0 || CWL < 0 || WR < 0)\r\nreturn -EINVAL;\r\nram->mr[0] &= ~0xf74;\r\nram->mr[0] |= (WR & 0x07) << 9;\r\nram->mr[0] |= (CL & 0x0e) << 3;\r\nram->mr[0] |= (CL & 0x01) << 2;\r\nram->mr[1] &= ~0x245;\r\nram->mr[1] |= (ODT & 0x1) << 2;\r\nram->mr[1] |= (ODT & 0x2) << 5;\r\nram->mr[1] |= (ODT & 0x4) << 7;\r\nram->mr[1] |= !DLL;\r\nram->mr[2] &= ~0x038;\r\nram->mr[2] |= (CWL & 0x07) << 3;\r\nreturn 0;\r\n}

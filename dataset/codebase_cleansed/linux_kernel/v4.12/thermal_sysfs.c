static ssize_t\r\ntype_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nreturn sprintf(buf, "%s\n", tz->type);\r\n}\r\nstatic ssize_t\r\ntemp_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint temperature, ret;\r\nret = thermal_zone_get_temp(tz, &temperature);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", temperature);\r\n}\r\nstatic ssize_t\r\nmode_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nenum thermal_device_mode mode;\r\nint result;\r\nif (!tz->ops->get_mode)\r\nreturn -EPERM;\r\nresult = tz->ops->get_mode(tz, &mode);\r\nif (result)\r\nreturn result;\r\nreturn sprintf(buf, "%s\n", mode == THERMAL_DEVICE_ENABLED ? "enabled"\r\n: "disabled");\r\n}\r\nstatic ssize_t\r\nmode_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint result;\r\nif (!tz->ops->set_mode)\r\nreturn -EPERM;\r\nif (!strncmp(buf, "enabled", sizeof("enabled") - 1))\r\nresult = tz->ops->set_mode(tz, THERMAL_DEVICE_ENABLED);\r\nelse if (!strncmp(buf, "disabled", sizeof("disabled") - 1))\r\nresult = tz->ops->set_mode(tz, THERMAL_DEVICE_DISABLED);\r\nelse\r\nresult = -EINVAL;\r\nif (result)\r\nreturn result;\r\nreturn count;\r\n}\r\nstatic ssize_t\r\ntrip_point_type_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nenum thermal_trip_type type;\r\nint trip, result;\r\nif (!tz->ops->get_trip_type)\r\nreturn -EPERM;\r\nif (sscanf(attr->attr.name, "trip_point_%d_type", &trip) != 1)\r\nreturn -EINVAL;\r\nresult = tz->ops->get_trip_type(tz, trip, &type);\r\nif (result)\r\nreturn result;\r\nswitch (type) {\r\ncase THERMAL_TRIP_CRITICAL:\r\nreturn sprintf(buf, "critical\n");\r\ncase THERMAL_TRIP_HOT:\r\nreturn sprintf(buf, "hot\n");\r\ncase THERMAL_TRIP_PASSIVE:\r\nreturn sprintf(buf, "passive\n");\r\ncase THERMAL_TRIP_ACTIVE:\r\nreturn sprintf(buf, "active\n");\r\ndefault:\r\nreturn sprintf(buf, "unknown\n");\r\n}\r\n}\r\nstatic ssize_t\r\ntrip_point_temp_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint trip, ret;\r\nint temperature;\r\nif (!tz->ops->set_trip_temp)\r\nreturn -EPERM;\r\nif (sscanf(attr->attr.name, "trip_point_%d_temp", &trip) != 1)\r\nreturn -EINVAL;\r\nif (kstrtoint(buf, 10, &temperature))\r\nreturn -EINVAL;\r\nret = tz->ops->set_trip_temp(tz, trip, temperature);\r\nif (ret)\r\nreturn ret;\r\nthermal_zone_device_update(tz, THERMAL_EVENT_UNSPECIFIED);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\ntrip_point_temp_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint trip, ret;\r\nint temperature;\r\nif (!tz->ops->get_trip_temp)\r\nreturn -EPERM;\r\nif (sscanf(attr->attr.name, "trip_point_%d_temp", &trip) != 1)\r\nreturn -EINVAL;\r\nret = tz->ops->get_trip_temp(tz, trip, &temperature);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", temperature);\r\n}\r\nstatic ssize_t\r\ntrip_point_hyst_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint trip, ret;\r\nint temperature;\r\nif (!tz->ops->set_trip_hyst)\r\nreturn -EPERM;\r\nif (sscanf(attr->attr.name, "trip_point_%d_hyst", &trip) != 1)\r\nreturn -EINVAL;\r\nif (kstrtoint(buf, 10, &temperature))\r\nreturn -EINVAL;\r\nret = tz->ops->set_trip_hyst(tz, trip, temperature);\r\nif (!ret)\r\nthermal_zone_set_trips(tz);\r\nreturn ret ? ret : count;\r\n}\r\nstatic ssize_t\r\ntrip_point_hyst_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint trip, ret;\r\nint temperature;\r\nif (!tz->ops->get_trip_hyst)\r\nreturn -EPERM;\r\nif (sscanf(attr->attr.name, "trip_point_%d_hyst", &trip) != 1)\r\nreturn -EINVAL;\r\nret = tz->ops->get_trip_hyst(tz, trip, &temperature);\r\nreturn ret ? ret : sprintf(buf, "%d\n", temperature);\r\n}\r\nstatic ssize_t\r\npassive_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint state;\r\nif (sscanf(buf, "%d\n", &state) != 1)\r\nreturn -EINVAL;\r\nif (state && state < 1000)\r\nreturn -EINVAL;\r\nif (state && !tz->forced_passive) {\r\nif (!tz->passive_delay)\r\ntz->passive_delay = 1000;\r\nthermal_zone_device_rebind_exception(tz, "Processor",\r\nsizeof("Processor"));\r\n} else if (!state && tz->forced_passive) {\r\ntz->passive_delay = 0;\r\nthermal_zone_device_unbind_exception(tz, "Processor",\r\nsizeof("Processor"));\r\n}\r\ntz->forced_passive = state;\r\nthermal_zone_device_update(tz, THERMAL_EVENT_UNSPECIFIED);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\npassive_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nreturn sprintf(buf, "%d\n", tz->forced_passive);\r\n}\r\nstatic ssize_t\r\npolicy_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nchar name[THERMAL_NAME_LENGTH];\r\nint ret;\r\nsnprintf(name, sizeof(name), "%s", buf);\r\nret = thermal_zone_device_set_policy(tz, name);\r\nif (!ret)\r\nret = count;\r\nreturn ret;\r\n}\r\nstatic ssize_t\r\npolicy_show(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nreturn sprintf(buf, "%s\n", tz->governor->name);\r\n}\r\nstatic ssize_t\r\navailable_policies_show(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nreturn thermal_build_list_of_policies(buf);\r\n}\r\nstatic ssize_t\r\nemul_temp_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nint ret = 0;\r\nint temperature;\r\nif (kstrtoint(buf, 10, &temperature))\r\nreturn -EINVAL;\r\nif (!tz->ops->set_emul_temp) {\r\nmutex_lock(&tz->lock);\r\ntz->emul_temperature = temperature;\r\nmutex_unlock(&tz->lock);\r\n} else {\r\nret = tz->ops->set_emul_temp(tz, temperature);\r\n}\r\nif (!ret)\r\nthermal_zone_device_update(tz, THERMAL_EVENT_UNSPECIFIED);\r\nreturn ret ? ret : count;\r\n}\r\nstatic ssize_t\r\nsustainable_power_show(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nif (tz->tzp)\r\nreturn sprintf(buf, "%u\n", tz->tzp->sustainable_power);\r\nelse\r\nreturn -EIO;\r\n}\r\nstatic ssize_t\r\nsustainable_power_store(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_zone_device *tz = to_thermal_zone(dev);\r\nu32 sustainable_power;\r\nif (!tz->tzp)\r\nreturn -EIO;\r\nif (kstrtou32(buf, 10, &sustainable_power))\r\nreturn -EINVAL;\r\ntz->tzp->sustainable_power = sustainable_power;\r\nreturn count;\r\n}\r\nstatic umode_t thermal_zone_mode_is_visible(struct kobject *kobj,\r\nstruct attribute *attr,\r\nint attrno)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct thermal_zone_device *tz;\r\ntz = container_of(dev, struct thermal_zone_device, device);\r\nif (tz->ops->get_mode)\r\nreturn attr->mode;\r\nreturn 0;\r\n}\r\nstatic umode_t thermal_zone_passive_is_visible(struct kobject *kobj,\r\nstruct attribute *attr,\r\nint attrno)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct thermal_zone_device *tz;\r\nenum thermal_trip_type trip_type;\r\nint count, passive = 0;\r\ntz = container_of(dev, struct thermal_zone_device, device);\r\nfor (count = 0; count < tz->trips && !passive; count++) {\r\ntz->ops->get_trip_type(tz, count, &trip_type);\r\nif (trip_type == THERMAL_TRIP_PASSIVE)\r\npassive = 1;\r\n}\r\nif (!passive)\r\nreturn attr->mode;\r\nreturn 0;\r\n}\r\nstatic int create_trip_attrs(struct thermal_zone_device *tz, int mask)\r\n{\r\nstruct attribute **attrs;\r\nint indx;\r\nif (tz->trips <= 0)\r\nreturn -EINVAL;\r\ntz->trip_type_attrs = kcalloc(tz->trips, sizeof(*tz->trip_type_attrs),\r\nGFP_KERNEL);\r\nif (!tz->trip_type_attrs)\r\nreturn -ENOMEM;\r\ntz->trip_temp_attrs = kcalloc(tz->trips, sizeof(*tz->trip_temp_attrs),\r\nGFP_KERNEL);\r\nif (!tz->trip_temp_attrs) {\r\nkfree(tz->trip_type_attrs);\r\nreturn -ENOMEM;\r\n}\r\nif (tz->ops->get_trip_hyst) {\r\ntz->trip_hyst_attrs = kcalloc(tz->trips,\r\nsizeof(*tz->trip_hyst_attrs),\r\nGFP_KERNEL);\r\nif (!tz->trip_hyst_attrs) {\r\nkfree(tz->trip_type_attrs);\r\nkfree(tz->trip_temp_attrs);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nattrs = kcalloc(tz->trips * 3 + 1, sizeof(*attrs), GFP_KERNEL);\r\nif (!attrs) {\r\nkfree(tz->trip_type_attrs);\r\nkfree(tz->trip_temp_attrs);\r\nif (tz->ops->get_trip_hyst)\r\nkfree(tz->trip_hyst_attrs);\r\nreturn -ENOMEM;\r\n}\r\nfor (indx = 0; indx < tz->trips; indx++) {\r\nsnprintf(tz->trip_type_attrs[indx].name, THERMAL_NAME_LENGTH,\r\n"trip_point_%d_type", indx);\r\nsysfs_attr_init(&tz->trip_type_attrs[indx].attr.attr);\r\ntz->trip_type_attrs[indx].attr.attr.name =\r\ntz->trip_type_attrs[indx].name;\r\ntz->trip_type_attrs[indx].attr.attr.mode = S_IRUGO;\r\ntz->trip_type_attrs[indx].attr.show = trip_point_type_show;\r\nattrs[indx] = &tz->trip_type_attrs[indx].attr.attr;\r\nsnprintf(tz->trip_temp_attrs[indx].name, THERMAL_NAME_LENGTH,\r\n"trip_point_%d_temp", indx);\r\nsysfs_attr_init(&tz->trip_temp_attrs[indx].attr.attr);\r\ntz->trip_temp_attrs[indx].attr.attr.name =\r\ntz->trip_temp_attrs[indx].name;\r\ntz->trip_temp_attrs[indx].attr.attr.mode = S_IRUGO;\r\ntz->trip_temp_attrs[indx].attr.show = trip_point_temp_show;\r\nif (IS_ENABLED(CONFIG_THERMAL_WRITABLE_TRIPS) &&\r\nmask & (1 << indx)) {\r\ntz->trip_temp_attrs[indx].attr.attr.mode |= S_IWUSR;\r\ntz->trip_temp_attrs[indx].attr.store =\r\ntrip_point_temp_store;\r\n}\r\nattrs[indx + tz->trips] = &tz->trip_temp_attrs[indx].attr.attr;\r\nif (!tz->ops->get_trip_hyst)\r\ncontinue;\r\nsnprintf(tz->trip_hyst_attrs[indx].name, THERMAL_NAME_LENGTH,\r\n"trip_point_%d_hyst", indx);\r\nsysfs_attr_init(&tz->trip_hyst_attrs[indx].attr.attr);\r\ntz->trip_hyst_attrs[indx].attr.attr.name =\r\ntz->trip_hyst_attrs[indx].name;\r\ntz->trip_hyst_attrs[indx].attr.attr.mode = S_IRUGO;\r\ntz->trip_hyst_attrs[indx].attr.show = trip_point_hyst_show;\r\nif (tz->ops->set_trip_hyst) {\r\ntz->trip_hyst_attrs[indx].attr.attr.mode |= S_IWUSR;\r\ntz->trip_hyst_attrs[indx].attr.store =\r\ntrip_point_hyst_store;\r\n}\r\nattrs[indx + tz->trips * 2] =\r\n&tz->trip_hyst_attrs[indx].attr.attr;\r\n}\r\nattrs[tz->trips * 3] = NULL;\r\ntz->trips_attribute_group.attrs = attrs;\r\nreturn 0;\r\n}\r\nint thermal_zone_create_device_groups(struct thermal_zone_device *tz,\r\nint mask)\r\n{\r\nconst struct attribute_group **groups;\r\nint i, size, result;\r\nsize = ARRAY_SIZE(thermal_zone_attribute_groups) + 2;\r\ngroups = kcalloc(size, sizeof(*groups), GFP_KERNEL);\r\nif (!groups)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < size - 2; i++)\r\ngroups[i] = thermal_zone_attribute_groups[i];\r\nif (tz->trips) {\r\nresult = create_trip_attrs(tz, mask);\r\nif (result) {\r\nkfree(groups);\r\nreturn result;\r\n}\r\ngroups[size - 2] = &tz->trips_attribute_group;\r\n}\r\ntz->device.groups = groups;\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nthermal_cooling_device_type_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_cooling_device *cdev = to_cooling_device(dev);\r\nreturn sprintf(buf, "%s\n", cdev->type);\r\n}\r\nstatic ssize_t\r\nthermal_cooling_device_max_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_cooling_device *cdev = to_cooling_device(dev);\r\nunsigned long state;\r\nint ret;\r\nret = cdev->ops->get_max_state(cdev, &state);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%ld\n", state);\r\n}\r\nstatic ssize_t\r\nthermal_cooling_device_cur_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_cooling_device *cdev = to_cooling_device(dev);\r\nunsigned long state;\r\nint ret;\r\nret = cdev->ops->get_cur_state(cdev, &state);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%ld\n", state);\r\n}\r\nstatic ssize_t\r\nthermal_cooling_device_cur_state_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_cooling_device *cdev = to_cooling_device(dev);\r\nunsigned long state;\r\nint result;\r\nif (sscanf(buf, "%ld\n", &state) != 1)\r\nreturn -EINVAL;\r\nif ((long)state < 0)\r\nreturn -EINVAL;\r\nresult = cdev->ops->set_cur_state(cdev, state);\r\nif (result)\r\nreturn result;\r\nreturn count;\r\n}\r\nvoid thermal_cooling_device_setup_sysfs(struct thermal_cooling_device *cdev)\r\n{\r\ncdev->device.groups = cooling_device_attr_groups;\r\n}\r\nssize_t\r\nthermal_cooling_device_trip_point_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_instance *instance;\r\ninstance =\r\ncontainer_of(attr, struct thermal_instance, attr);\r\nif (instance->trip == THERMAL_TRIPS_NONE)\r\nreturn sprintf(buf, "-1\n");\r\nelse\r\nreturn sprintf(buf, "%d\n", instance->trip);\r\n}\r\nssize_t\r\nthermal_cooling_device_weight_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_instance *instance;\r\ninstance = container_of(attr, struct thermal_instance, weight_attr);\r\nreturn sprintf(buf, "%d\n", instance->weight);\r\n}\r\nssize_t\r\nthermal_cooling_device_weight_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct thermal_instance *instance;\r\nint ret, weight;\r\nret = kstrtoint(buf, 0, &weight);\r\nif (ret)\r\nreturn ret;\r\ninstance = container_of(attr, struct thermal_instance, weight_attr);\r\ninstance->weight = weight;\r\nreturn count;\r\n}

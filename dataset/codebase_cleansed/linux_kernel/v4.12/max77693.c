static int max77693_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max77693_dev *max77693;\r\nunsigned int reg_data;\r\nint ret = 0;\r\nmax77693 = devm_kzalloc(&i2c->dev,\r\nsizeof(struct max77693_dev), GFP_KERNEL);\r\nif (max77693 == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, max77693);\r\nmax77693->dev = &i2c->dev;\r\nmax77693->i2c = i2c;\r\nmax77693->irq = i2c->irq;\r\nmax77693->type = id->driver_data;\r\nmax77693->regmap = devm_regmap_init_i2c(i2c, &max77693_regmap_config);\r\nif (IS_ERR(max77693->regmap)) {\r\nret = PTR_ERR(max77693->regmap);\r\ndev_err(max77693->dev, "failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = regmap_read(max77693->regmap, MAX77693_PMIC_REG_PMIC_ID2,\r\n&reg_data);\r\nif (ret < 0) {\r\ndev_err(max77693->dev, "device not found on this channel\n");\r\nreturn ret;\r\n} else\r\ndev_info(max77693->dev, "device ID: 0x%x\n", reg_data);\r\nmax77693->i2c_muic = i2c_new_dummy(i2c->adapter, I2C_ADDR_MUIC);\r\nif (!max77693->i2c_muic) {\r\ndev_err(max77693->dev, "Failed to allocate I2C device for MUIC\n");\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(max77693->i2c_muic, max77693);\r\nmax77693->i2c_haptic = i2c_new_dummy(i2c->adapter, I2C_ADDR_HAPTIC);\r\nif (!max77693->i2c_haptic) {\r\ndev_err(max77693->dev, "Failed to allocate I2C device for Haptic\n");\r\nret = -ENODEV;\r\ngoto err_i2c_haptic;\r\n}\r\ni2c_set_clientdata(max77693->i2c_haptic, max77693);\r\nmax77693->regmap_haptic = devm_regmap_init_i2c(max77693->i2c_haptic,\r\n&max77693_regmap_haptic_config);\r\nif (IS_ERR(max77693->regmap_haptic)) {\r\nret = PTR_ERR(max77693->regmap_haptic);\r\ndev_err(max77693->dev,\r\n"failed to initialize haptic register map: %d\n", ret);\r\ngoto err_regmap;\r\n}\r\nmax77693->regmap_muic = devm_regmap_init_i2c(max77693->i2c_muic,\r\n&max77693_regmap_muic_config);\r\nif (IS_ERR(max77693->regmap_muic)) {\r\nret = PTR_ERR(max77693->regmap_muic);\r\ndev_err(max77693->dev,\r\n"failed to allocate register map: %d\n", ret);\r\ngoto err_regmap;\r\n}\r\nret = regmap_add_irq_chip(max77693->regmap, max77693->irq,\r\nIRQF_ONESHOT | IRQF_SHARED |\r\nIRQF_TRIGGER_FALLING, 0,\r\n&max77693_led_irq_chip,\r\n&max77693->irq_data_led);\r\nif (ret) {\r\ndev_err(max77693->dev, "failed to add irq chip: %d\n", ret);\r\ngoto err_regmap;\r\n}\r\nret = regmap_add_irq_chip(max77693->regmap, max77693->irq,\r\nIRQF_ONESHOT | IRQF_SHARED |\r\nIRQF_TRIGGER_FALLING, 0,\r\n&max77693_topsys_irq_chip,\r\n&max77693->irq_data_topsys);\r\nif (ret) {\r\ndev_err(max77693->dev, "failed to add irq chip: %d\n", ret);\r\ngoto err_irq_topsys;\r\n}\r\nret = regmap_add_irq_chip(max77693->regmap, max77693->irq,\r\nIRQF_ONESHOT | IRQF_SHARED |\r\nIRQF_TRIGGER_FALLING, 0,\r\n&max77693_charger_irq_chip,\r\n&max77693->irq_data_chg);\r\nif (ret) {\r\ndev_err(max77693->dev, "failed to add irq chip: %d\n", ret);\r\ngoto err_irq_charger;\r\n}\r\nret = regmap_add_irq_chip(max77693->regmap_muic, max77693->irq,\r\nIRQF_ONESHOT | IRQF_SHARED |\r\nIRQF_TRIGGER_FALLING, 0,\r\n&max77693_muic_irq_chip,\r\n&max77693->irq_data_muic);\r\nif (ret) {\r\ndev_err(max77693->dev, "failed to add irq chip: %d\n", ret);\r\ngoto err_irq_muic;\r\n}\r\nret = regmap_update_bits(max77693->regmap,\r\nMAX77693_PMIC_REG_INTSRC_MASK,\r\nSRC_IRQ_ALL, (unsigned int)~SRC_IRQ_ALL);\r\nif (ret < 0) {\r\ndev_err(max77693->dev,\r\n"Could not unmask interrupts in INTSRC: %d\n",\r\nret);\r\ngoto err_intsrc;\r\n}\r\npm_runtime_set_active(max77693->dev);\r\nret = mfd_add_devices(max77693->dev, -1, max77693_devs,\r\nARRAY_SIZE(max77693_devs), NULL, 0, NULL);\r\nif (ret < 0)\r\ngoto err_mfd;\r\nreturn ret;\r\nerr_mfd:\r\nmfd_remove_devices(max77693->dev);\r\nerr_intsrc:\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_muic);\r\nerr_irq_muic:\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_chg);\r\nerr_irq_charger:\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_topsys);\r\nerr_irq_topsys:\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_led);\r\nerr_regmap:\r\ni2c_unregister_device(max77693->i2c_haptic);\r\nerr_i2c_haptic:\r\ni2c_unregister_device(max77693->i2c_muic);\r\nreturn ret;\r\n}\r\nstatic int max77693_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct max77693_dev *max77693 = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(max77693->dev);\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_muic);\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_chg);\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_topsys);\r\nregmap_del_irq_chip(max77693->irq, max77693->irq_data_led);\r\ni2c_unregister_device(max77693->i2c_muic);\r\ni2c_unregister_device(max77693->i2c_haptic);\r\nreturn 0;\r\n}\r\nstatic int max77693_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77693_dev *max77693 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev)) {\r\nenable_irq_wake(max77693->irq);\r\ndisable_irq(max77693->irq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77693_dev *max77693 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev)) {\r\ndisable_irq_wake(max77693->irq);\r\nenable_irq(max77693->irq);\r\n}\r\nreturn 0;\r\n}

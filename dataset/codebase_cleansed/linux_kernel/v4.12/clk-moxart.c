static void __init moxart_of_pll_clk_init(struct device_node *node)\r\n{\r\nstatic void __iomem *base;\r\nstruct clk_hw *hw;\r\nstruct clk *ref_clk;\r\nunsigned int mul;\r\nconst char *name = node->name;\r\nconst char *parent_name;\r\nof_property_read_string(node, "clock-output-names", &name);\r\nparent_name = of_clk_get_parent_name(node, 0);\r\nbase = of_iomap(node, 0);\r\nif (!base) {\r\npr_err("%s: of_iomap failed\n", node->full_name);\r\nreturn;\r\n}\r\nmul = readl(base + 0x30) >> 3 & 0x3f;\r\niounmap(base);\r\nref_clk = of_clk_get(node, 0);\r\nif (IS_ERR(ref_clk)) {\r\npr_err("%s: of_clk_get failed\n", node->full_name);\r\nreturn;\r\n}\r\nhw = clk_hw_register_fixed_factor(NULL, name, parent_name, 0, mul, 1);\r\nif (IS_ERR(hw)) {\r\npr_err("%s: failed to register clock\n", node->full_name);\r\nreturn;\r\n}\r\nclk_hw_register_clkdev(hw, NULL, name);\r\nof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\r\n}\r\nstatic void __init moxart_of_apb_clk_init(struct device_node *node)\r\n{\r\nstatic void __iomem *base;\r\nstruct clk_hw *hw;\r\nstruct clk *pll_clk;\r\nunsigned int div, val;\r\nunsigned int div_idx[] = { 2, 3, 4, 6, 8};\r\nconst char *name = node->name;\r\nconst char *parent_name;\r\nof_property_read_string(node, "clock-output-names", &name);\r\nparent_name = of_clk_get_parent_name(node, 0);\r\nbase = of_iomap(node, 0);\r\nif (!base) {\r\npr_err("%s: of_iomap failed\n", node->full_name);\r\nreturn;\r\n}\r\nval = readl(base + 0xc) >> 4 & 0x7;\r\niounmap(base);\r\nif (val > 4)\r\nval = 0;\r\ndiv = div_idx[val] * 2;\r\npll_clk = of_clk_get(node, 0);\r\nif (IS_ERR(pll_clk)) {\r\npr_err("%s: of_clk_get failed\n", node->full_name);\r\nreturn;\r\n}\r\nhw = clk_hw_register_fixed_factor(NULL, name, parent_name, 0, 1, div);\r\nif (IS_ERR(hw)) {\r\npr_err("%s: failed to register clock\n", node->full_name);\r\nreturn;\r\n}\r\nclk_hw_register_clkdev(hw, NULL, name);\r\nof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\r\n}

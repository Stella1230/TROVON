static inline struct twl_pwmled_chip *to_twl(struct pwm_chip *chip)\r\n{\r\nreturn container_of(chip, struct twl_pwmled_chip, chip);\r\n}\r\nstatic int twl4030_pwmled_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nint duty_cycle = DIV_ROUND_UP(duty_ns * TWL4030_LED_MAX, period_ns) + 1;\r\nu8 pwm_config[2] = { 1, 0 };\r\nint base, ret;\r\nif (duty_cycle == 1)\r\nduty_cycle = 2;\r\nelse if (duty_cycle > TWL4030_LED_MAX)\r\nduty_cycle = 1;\r\nbase = pwm->hwpwm * 2 + TWL4030_PWMA_REG;\r\npwm_config[1] = duty_cycle;\r\nret = twl_i2c_write(TWL4030_MODULE_LED, pwm_config, base, 2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to configure PWM\n", pwm->label);\r\nreturn ret;\r\n}\r\nstatic int twl4030_pwmled_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_LED, &val, TWL4030_LEDEN_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read LEDEN\n", pwm->label);\r\ngoto out;\r\n}\r\nval |= TWL4030_LED_TOGGLE(pwm->hwpwm, TWL4030_LED_PINS);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_LED, val, TWL4030_LEDEN_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to enable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl4030_pwmled_disable(struct pwm_chip *chip,\r\nstruct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_LED, &val, TWL4030_LEDEN_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read LEDEN\n", pwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL4030_LED_TOGGLE(pwm->hwpwm, TWL4030_LED_PINS);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_LED, val, TWL4030_LEDEN_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to disable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl6030_pwmled_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nint duty_cycle = (duty_ns * TWL6030_LED_MAX) / period_ns;\r\nu8 on_time;\r\nint ret;\r\non_time = duty_cycle & 0xff;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, on_time,\r\nTWL6030_LED_PWM_CTRL1);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to configure PWM\n", pwm->label);\r\nreturn ret;\r\n}\r\nstatic int twl6030_pwmled_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PWM_CTRL2\n",\r\npwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL6040_LED_MODE_MASK;\r\nval |= TWL6040_LED_MODE_ON;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to enable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl6030_pwmled_disable(struct pwm_chip *chip,\r\nstruct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PWM_CTRL2\n",\r\npwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL6040_LED_MODE_MASK;\r\nval |= TWL6040_LED_MODE_OFF;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to disable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl6030_pwmled_request(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PWM_CTRL2\n",\r\npwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL6040_LED_MODE_MASK;\r\nval |= TWL6040_LED_MODE_OFF;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to request PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl6030_pwmled_free(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwmled_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PWM_CTRL2\n",\r\npwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL6040_LED_MODE_MASK;\r\nval |= TWL6040_LED_MODE_HW;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to free PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl_pwmled_probe(struct platform_device *pdev)\r\n{\r\nstruct twl_pwmled_chip *twl;\r\nint ret;\r\ntwl = devm_kzalloc(&pdev->dev, sizeof(*twl), GFP_KERNEL);\r\nif (!twl)\r\nreturn -ENOMEM;\r\nif (twl_class_is_4030()) {\r\ntwl->chip.ops = &twl4030_pwmled_ops;\r\ntwl->chip.npwm = 2;\r\n} else {\r\ntwl->chip.ops = &twl6030_pwmled_ops;\r\ntwl->chip.npwm = 1;\r\n}\r\ntwl->chip.dev = &pdev->dev;\r\ntwl->chip.base = -1;\r\nmutex_init(&twl->mutex);\r\nret = pwmchip_add(&twl->chip);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, twl);\r\nreturn 0;\r\n}\r\nstatic int twl_pwmled_remove(struct platform_device *pdev)\r\n{\r\nstruct twl_pwmled_chip *twl = platform_get_drvdata(pdev);\r\nreturn pwmchip_remove(&twl->chip);\r\n}

void ieee80211_aes_cmac(struct crypto_shash *tfm, const u8 *aad,\r\nconst u8 *data, size_t data_len, u8 *mic)\r\n{\r\nSHASH_DESC_ON_STACK(desc, tfm);\r\nu8 out[AES_BLOCK_SIZE];\r\ndesc->tfm = tfm;\r\ncrypto_shash_init(desc);\r\ncrypto_shash_update(desc, aad, AAD_LEN);\r\ncrypto_shash_update(desc, data, data_len - CMAC_TLEN);\r\ncrypto_shash_finup(desc, zero, CMAC_TLEN, out);\r\nmemcpy(mic, out, CMAC_TLEN);\r\n}\r\nvoid ieee80211_aes_cmac_256(struct crypto_shash *tfm, const u8 *aad,\r\nconst u8 *data, size_t data_len, u8 *mic)\r\n{\r\nSHASH_DESC_ON_STACK(desc, tfm);\r\ndesc->tfm = tfm;\r\ncrypto_shash_init(desc);\r\ncrypto_shash_update(desc, aad, AAD_LEN);\r\ncrypto_shash_update(desc, data, data_len - CMAC_TLEN_256);\r\ncrypto_shash_finup(desc, zero, CMAC_TLEN_256, mic);\r\n}\r\nstruct crypto_shash *ieee80211_aes_cmac_key_setup(const u8 key[],\r\nsize_t key_len)\r\n{\r\nstruct crypto_shash *tfm;\r\ntfm = crypto_alloc_shash("cmac(aes)", 0, 0);\r\nif (!IS_ERR(tfm))\r\ncrypto_shash_setkey(tfm, key, key_len);\r\nreturn tfm;\r\n}\r\nvoid ieee80211_aes_cmac_key_free(struct crypto_shash *tfm)\r\n{\r\ncrypto_free_shash(tfm);\r\n}

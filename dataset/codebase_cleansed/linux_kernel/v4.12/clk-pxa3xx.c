unsigned int pxa3xx_get_clk_frequency_khz(int info)\r\n{\r\nstruct clk *clk;\r\nunsigned long clks[5];\r\nint i;\r\nfor (i = 0; i < 5; i++) {\r\nclk = clk_get(NULL, get_freq_khz[i]);\r\nif (IS_ERR(clk)) {\r\nclks[i] = 0;\r\n} else {\r\nclks[i] = clk_get_rate(clk);\r\nclk_put(clk);\r\n}\r\n}\r\nif (info) {\r\npr_info("RO Mode clock: %ld.%02ldMHz\n",\r\nclks[1] / 1000000, (clks[0] % 1000000) / 10000);\r\npr_info("Run Mode clock: %ld.%02ldMHz\n",\r\nclks[2] / 1000000, (clks[1] % 1000000) / 10000);\r\npr_info("Turbo Mode clock: %ld.%02ldMHz\n",\r\nclks[3] / 1000000, (clks[2] % 1000000) / 10000);\r\npr_info("System bus clock: %ld.%02ldMHz\n",\r\nclks[4] / 1000000, (clks[4] % 1000000) / 10000);\r\n}\r\nreturn (unsigned int)clks[0] / KHz;\r\n}\r\nstatic unsigned long clk_pxa3xx_ac97_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long ac97_div, rate;\r\nac97_div = AC97_DIV;\r\nrate = parent_rate / 2;\r\nrate /= ((ac97_div >> 12) & 0x7fff);\r\nrate *= (ac97_div & 0xfff);\r\nreturn rate;\r\n}\r\nstatic unsigned long clk_pxa3xx_smemc_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long acsr = ACSR;\r\nunsigned long memclkcfg = __raw_readl(MEMCLKCFG);\r\nreturn (parent_rate / 48) * smcfs_mult[(acsr >> 23) & 0x7] /\r\ndf_clkdiv[(memclkcfg >> 16) & 0x3];\r\n}\r\nstatic bool pxa3xx_is_ring_osc_forced(void)\r\n{\r\nunsigned long acsr = ACSR;\r\nreturn acsr & ACCR_D0CS;\r\n}\r\nstatic unsigned long clk_pxa3xx_system_bus_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long acsr = ACSR;\r\nunsigned int hss = (acsr >> 14) & 0x3;\r\nif (pxa3xx_is_ring_osc_forced())\r\nreturn parent_rate;\r\nreturn parent_rate / 48 * hss_mult[hss];\r\n}\r\nstatic u8 clk_pxa3xx_system_bus_get_parent(struct clk_hw *hw)\r\n{\r\nif (pxa3xx_is_ring_osc_forced())\r\nreturn PXA_BUS_60Mhz;\r\nelse\r\nreturn PXA_BUS_HSS;\r\n}\r\nstatic unsigned long clk_pxa3xx_core_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn parent_rate;\r\n}\r\nstatic u8 clk_pxa3xx_core_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned long xclkcfg;\r\nunsigned int t;\r\nif (pxa3xx_is_ring_osc_forced())\r\nreturn PXA_CORE_60Mhz;\r\n__asm__ __volatile__("mrc\tp14, 0, %0, c6, c0, 0" : "=r"(xclkcfg));\r\nt = xclkcfg & 0x1;\r\nif (t)\r\nreturn PXA_CORE_TURBO;\r\nreturn PXA_CORE_RUN;\r\n}\r\nstatic unsigned long clk_pxa3xx_run_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long acsr = ACSR;\r\nunsigned int xn = (acsr & ACCR_XN_MASK) >> 8;\r\nunsigned int t, xclkcfg;\r\n__asm__ __volatile__("mrc\tp14, 0, %0, c6, c0, 0" : "=r"(xclkcfg));\r\nt = xclkcfg & 0x1;\r\nreturn t ? (parent_rate / xn) * 2 : parent_rate;\r\n}\r\nstatic unsigned long clk_pxa3xx_cpll_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long acsr = ACSR;\r\nunsigned int xn = (acsr & ACCR_XN_MASK) >> 8;\r\nunsigned int xl = acsr & ACCR_XL_MASK;\r\nunsigned int t, xclkcfg;\r\n__asm__ __volatile__("mrc\tp14, 0, %0, c6, c0, 0" : "=r"(xclkcfg));\r\nt = xclkcfg & 0x1;\r\npr_info("RJK: parent_rate=%lu, xl=%u, xn=%u\n", parent_rate, xl, xn);\r\nreturn t ? parent_rate * xl * xn : parent_rate * xl;\r\n}\r\nstatic void __init pxa3xx_register_core(void)\r\n{\r\nclk_register_clk_pxa3xx_cpll();\r\nclk_register_clk_pxa3xx_run();\r\nclkdev_pxa_register(CLK_CORE, "core", NULL,\r\nclk_register_clk_pxa3xx_core());\r\n}\r\nstatic void __init pxa3xx_register_plls(void)\r\n{\r\nclk_register_fixed_rate(NULL, "osc_13mhz", NULL,\r\nCLK_GET_RATE_NOCACHE,\r\n13 * MHz);\r\nclk_register_fixed_rate(NULL, "osc_32_768khz", NULL,\r\nCLK_GET_RATE_NOCACHE,\r\n32768);\r\nclk_register_fixed_rate(NULL, "ring_osc_120mhz", NULL,\r\nCLK_GET_RATE_NOCACHE,\r\n120 * MHz);\r\nclk_register_fixed_rate(NULL, "clk_dummy", NULL, 0, 0);\r\nclk_register_fixed_factor(NULL, "spll_624mhz", "osc_13mhz", 0, 48, 1);\r\nclk_register_fixed_factor(NULL, "ring_osc_60mhz", "ring_osc_120mhz",\r\n0, 1, 2);\r\n}\r\nstatic void __init pxa3xx_dummy_clocks_init(void)\r\n{\r\nstruct clk *clk;\r\nstruct dummy_clk *d;\r\nconst char *name;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(dummy_clks); i++) {\r\nd = &dummy_clks[i];\r\nname = d->dev_id ? d->dev_id : d->con_id;\r\nclk = clk_register_fixed_factor(NULL, name, d->parent, 0, 1, 1);\r\nclk_register_clkdev(clk, d->con_id, d->dev_id);\r\n}\r\n}\r\nstatic void __init pxa3xx_base_clocks_init(void)\r\n{\r\npxa3xx_register_plls();\r\npxa3xx_register_core();\r\nclk_register_clk_pxa3xx_system_bus();\r\nclk_register_clk_pxa3xx_ac97();\r\nclk_register_clk_pxa3xx_smemc();\r\nclk_register_gate(NULL, "CLK_POUT", "osc_13mhz", 0, OSCC, 11, 0, NULL);\r\nclkdev_pxa_register(CLK_OSTIMER, "OSTIMER0", NULL,\r\nclk_register_fixed_factor(NULL, "os-timer0",\r\n"osc_13mhz", 0, 1, 4));\r\n}\r\nint __init pxa3xx_clocks_init(void)\r\n{\r\nint ret;\r\npxa3xx_base_clocks_init();\r\npxa3xx_dummy_clocks_init();\r\nret = clk_pxa_cken_init(pxa3xx_clocks, ARRAY_SIZE(pxa3xx_clocks));\r\nif (ret)\r\nreturn ret;\r\nif (cpu_is_pxa320())\r\nreturn clk_pxa_cken_init(pxa320_clocks,\r\nARRAY_SIZE(pxa320_clocks));\r\nif (cpu_is_pxa300() || cpu_is_pxa310())\r\nreturn clk_pxa_cken_init(pxa300_310_clocks,\r\nARRAY_SIZE(pxa300_310_clocks));\r\nreturn clk_pxa_cken_init(pxa93x_clocks, ARRAY_SIZE(pxa93x_clocks));\r\n}\r\nstatic void __init pxa3xx_dt_clocks_init(struct device_node *np)\r\n{\r\npxa3xx_clocks_init();\r\nclk_pxa_dt_common_init(np);\r\n}

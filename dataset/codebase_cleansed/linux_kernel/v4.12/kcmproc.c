static struct kcm_mux *kcm_get_first(struct seq_file *seq)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\nstruct kcm_net *knet = net_generic(net, kcm_net_id);\r\nreturn list_first_or_null_rcu(&knet->mux_list,\r\nstruct kcm_mux, kcm_mux_list);\r\n}\r\nstatic struct kcm_mux *kcm_get_next(struct kcm_mux *mux)\r\n{\r\nstruct kcm_net *knet = mux->knet;\r\nreturn list_next_or_null_rcu(&knet->mux_list, &mux->kcm_mux_list,\r\nstruct kcm_mux, kcm_mux_list);\r\n}\r\nstatic struct kcm_mux *kcm_get_idx(struct seq_file *seq, loff_t pos)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\nstruct kcm_net *knet = net_generic(net, kcm_net_id);\r\nstruct kcm_mux *m;\r\nlist_for_each_entry_rcu(m, &knet->mux_list, kcm_mux_list) {\r\nif (!pos)\r\nreturn m;\r\n--pos;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void *kcm_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nvoid *p;\r\nif (v == SEQ_START_TOKEN)\r\np = kcm_get_first(seq);\r\nelse\r\np = kcm_get_next(v);\r\n++*pos;\r\nreturn p;\r\n}\r\nstatic void *kcm_seq_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(rcu)\r\n{\r\nrcu_read_lock();\r\nif (!*pos)\r\nreturn SEQ_START_TOKEN;\r\nelse\r\nreturn kcm_get_idx(seq, *pos - 1);\r\n}\r\nstatic void kcm_seq_stop(struct seq_file *seq, void *v)\r\n__releases(rcu)\r\n{\r\nrcu_read_unlock();\r\n}\r\nstatic int kcm_seq_open(struct inode *inode, struct file *file)\r\n{\r\nstruct kcm_seq_muxinfo *muxinfo = PDE_DATA(inode);\r\nreturn seq_open_net(inode, file, &muxinfo->seq_ops,\r\nsizeof(struct kcm_proc_mux_state));\r\n}\r\nstatic void kcm_format_mux_header(struct seq_file *seq)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\nstruct kcm_net *knet = net_generic(net, kcm_net_id);\r\nseq_printf(seq,\r\n"*** KCM statistics (%d MUX) ****\n",\r\nknet->count);\r\nseq_printf(seq,\r\n"%-14s %-10s %-16s %-10s %-16s %-8s %-8s %-8s %-8s %s",\r\n"Object",\r\n"RX-Msgs",\r\n"RX-Bytes",\r\n"TX-Msgs",\r\n"TX-Bytes",\r\n"Recv-Q",\r\n"Rmem",\r\n"Send-Q",\r\n"Smem",\r\n"Status");\r\nseq_puts(seq, "\n");\r\n}\r\nstatic void kcm_format_sock(struct kcm_sock *kcm, struct seq_file *seq,\r\nint i, int *len)\r\n{\r\nseq_printf(seq,\r\n" kcm-%-7u %-10llu %-16llu %-10llu %-16llu %-8d %-8d %-8d %-8s ",\r\nkcm->index,\r\nkcm->stats.rx_msgs,\r\nkcm->stats.rx_bytes,\r\nkcm->stats.tx_msgs,\r\nkcm->stats.tx_bytes,\r\nkcm->sk.sk_receive_queue.qlen,\r\nsk_rmem_alloc_get(&kcm->sk),\r\nkcm->sk.sk_write_queue.qlen,\r\n"-");\r\nif (kcm->tx_psock)\r\nseq_printf(seq, "Psck-%u ", kcm->tx_psock->index);\r\nif (kcm->tx_wait)\r\nseq_puts(seq, "TxWait ");\r\nif (kcm->tx_wait_more)\r\nseq_puts(seq, "WMore ");\r\nif (kcm->rx_wait)\r\nseq_puts(seq, "RxWait ");\r\nseq_puts(seq, "\n");\r\n}\r\nstatic void kcm_format_psock(struct kcm_psock *psock, struct seq_file *seq,\r\nint i, int *len)\r\n{\r\nseq_printf(seq,\r\n" psock-%-5u %-10llu %-16llu %-10llu %-16llu %-8d %-8d %-8d %-8d ",\r\npsock->index,\r\npsock->strp.stats.rx_msgs,\r\npsock->strp.stats.rx_bytes,\r\npsock->stats.tx_msgs,\r\npsock->stats.tx_bytes,\r\npsock->sk->sk_receive_queue.qlen,\r\natomic_read(&psock->sk->sk_rmem_alloc),\r\npsock->sk->sk_write_queue.qlen,\r\natomic_read(&psock->sk->sk_wmem_alloc));\r\nif (psock->done)\r\nseq_puts(seq, "Done ");\r\nif (psock->tx_stopped)\r\nseq_puts(seq, "TxStop ");\r\nif (psock->strp.rx_stopped)\r\nseq_puts(seq, "RxStop ");\r\nif (psock->tx_kcm)\r\nseq_printf(seq, "Rsvd-%d ", psock->tx_kcm->index);\r\nif (!psock->strp.rx_paused && !psock->ready_rx_msg) {\r\nif (psock->sk->sk_receive_queue.qlen) {\r\nif (psock->strp.rx_need_bytes)\r\nseq_printf(seq, "RxWait=%u ",\r\npsock->strp.rx_need_bytes);\r\nelse\r\nseq_printf(seq, "RxWait ");\r\n}\r\n} else {\r\nif (psock->strp.rx_paused)\r\nseq_puts(seq, "RxPause ");\r\nif (psock->ready_rx_msg)\r\nseq_puts(seq, "RdyRx ");\r\n}\r\nseq_puts(seq, "\n");\r\n}\r\nstatic void\r\nkcm_format_mux(struct kcm_mux *mux, loff_t idx, struct seq_file *seq)\r\n{\r\nint i, len;\r\nstruct kcm_sock *kcm;\r\nstruct kcm_psock *psock;\r\nseq_printf(seq,\r\n"%-6s%-8s %-10llu %-16llu %-10llu %-16llu %-8s %-8s %-8s %-8s ",\r\n"mux", "",\r\nmux->stats.rx_msgs,\r\nmux->stats.rx_bytes,\r\nmux->stats.tx_msgs,\r\nmux->stats.tx_bytes,\r\n"-", "-", "-", "-");\r\nseq_printf(seq, "KCMs: %d, Psocks %d\n",\r\nmux->kcm_socks_cnt, mux->psocks_cnt);\r\ni = 0;\r\nspin_lock_bh(&mux->lock);\r\nlist_for_each_entry(kcm, &mux->kcm_socks, kcm_sock_list) {\r\nkcm_format_sock(kcm, seq, i, &len);\r\ni++;\r\n}\r\ni = 0;\r\nlist_for_each_entry(psock, &mux->psocks, psock_list) {\r\nkcm_format_psock(psock, seq, i, &len);\r\ni++;\r\n}\r\nspin_unlock_bh(&mux->lock);\r\n}\r\nstatic int kcm_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct kcm_proc_mux_state *mux_state;\r\nmux_state = seq->private;\r\nif (v == SEQ_START_TOKEN) {\r\nmux_state->idx = 0;\r\nkcm_format_mux_header(seq);\r\n} else {\r\nkcm_format_mux(v, mux_state->idx, seq);\r\nmux_state->idx++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int kcm_proc_register(struct net *net, struct kcm_seq_muxinfo *muxinfo)\r\n{\r\nstruct proc_dir_entry *p;\r\nint rc = 0;\r\np = proc_create_data(muxinfo->name, S_IRUGO, net->proc_net,\r\nmuxinfo->seq_fops, muxinfo);\r\nif (!p)\r\nrc = -ENOMEM;\r\nreturn rc;\r\n}\r\nstatic void kcm_proc_unregister(struct net *net,\r\nstruct kcm_seq_muxinfo *muxinfo)\r\n{\r\nremove_proc_entry(muxinfo->name, net->proc_net);\r\n}\r\nstatic int kcm_stats_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct kcm_psock_stats psock_stats;\r\nstruct kcm_mux_stats mux_stats;\r\nstruct strp_aggr_stats strp_stats;\r\nstruct kcm_mux *mux;\r\nstruct kcm_psock *psock;\r\nstruct net *net = seq->private;\r\nstruct kcm_net *knet = net_generic(net, kcm_net_id);\r\nmemset(&mux_stats, 0, sizeof(mux_stats));\r\nmemset(&psock_stats, 0, sizeof(psock_stats));\r\nmemset(&strp_stats, 0, sizeof(strp_stats));\r\nmutex_lock(&knet->mutex);\r\naggregate_mux_stats(&knet->aggregate_mux_stats, &mux_stats);\r\naggregate_psock_stats(&knet->aggregate_psock_stats,\r\n&psock_stats);\r\naggregate_strp_stats(&knet->aggregate_strp_stats,\r\n&strp_stats);\r\nlist_for_each_entry_rcu(mux, &knet->mux_list, kcm_mux_list) {\r\nspin_lock_bh(&mux->lock);\r\naggregate_mux_stats(&mux->stats, &mux_stats);\r\naggregate_psock_stats(&mux->aggregate_psock_stats,\r\n&psock_stats);\r\naggregate_strp_stats(&mux->aggregate_strp_stats,\r\n&strp_stats);\r\nlist_for_each_entry(psock, &mux->psocks, psock_list) {\r\naggregate_psock_stats(&psock->stats, &psock_stats);\r\nsave_strp_stats(&psock->strp, &strp_stats);\r\n}\r\nspin_unlock_bh(&mux->lock);\r\n}\r\nmutex_unlock(&knet->mutex);\r\nseq_printf(seq,\r\n"%-8s %-10s %-16s %-10s %-16s %-10s %-10s %-10s %-10s %-10s\n",\r\n"MUX",\r\n"RX-Msgs",\r\n"RX-Bytes",\r\n"TX-Msgs",\r\n"TX-Bytes",\r\n"TX-Retries",\r\n"Attach",\r\n"Unattach",\r\n"UnattchRsvd",\r\n"RX-RdyDrops");\r\nseq_printf(seq,\r\n"%-8s %-10llu %-16llu %-10llu %-16llu %-10u %-10u %-10u %-10u %-10u\n",\r\n"",\r\nmux_stats.rx_msgs,\r\nmux_stats.rx_bytes,\r\nmux_stats.tx_msgs,\r\nmux_stats.tx_bytes,\r\nmux_stats.tx_retries,\r\nmux_stats.psock_attach,\r\nmux_stats.psock_unattach_rsvd,\r\nmux_stats.psock_unattach,\r\nmux_stats.rx_ready_drops);\r\nseq_printf(seq,\r\n"%-8s %-10s %-16s %-10s %-16s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s %-10s\n",\r\n"Psock",\r\n"RX-Msgs",\r\n"RX-Bytes",\r\n"TX-Msgs",\r\n"TX-Bytes",\r\n"Reserved",\r\n"Unreserved",\r\n"RX-Aborts",\r\n"RX-Intr",\r\n"RX-Unrecov",\r\n"RX-MemFail",\r\n"RX-NeedMor",\r\n"RX-BadLen",\r\n"RX-TooBig",\r\n"RX-Timeout",\r\n"TX-Aborts");\r\nseq_printf(seq,\r\n"%-8s %-10llu %-16llu %-10llu %-16llu %-10llu %-10llu %-10u %-10u %-10u %-10u %-10u %-10u %-10u %-10u %-10u\n",\r\n"",\r\nstrp_stats.rx_msgs,\r\nstrp_stats.rx_bytes,\r\npsock_stats.tx_msgs,\r\npsock_stats.tx_bytes,\r\npsock_stats.reserved,\r\npsock_stats.unreserved,\r\nstrp_stats.rx_aborts,\r\nstrp_stats.rx_interrupted,\r\nstrp_stats.rx_unrecov_intr,\r\nstrp_stats.rx_mem_fail,\r\nstrp_stats.rx_need_more_hdr,\r\nstrp_stats.rx_bad_hdr_len,\r\nstrp_stats.rx_msg_too_big,\r\nstrp_stats.rx_msg_timeouts,\r\npsock_stats.tx_aborts);\r\nreturn 0;\r\n}\r\nstatic int kcm_stats_seq_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open_net(inode, file, kcm_stats_seq_show);\r\n}\r\nstatic int kcm_proc_init_net(struct net *net)\r\n{\r\nint err;\r\nif (!proc_create("kcm_stats", S_IRUGO, net->proc_net,\r\n&kcm_stats_seq_fops)) {\r\nerr = -ENOMEM;\r\ngoto out_kcm_stats;\r\n}\r\nerr = kcm_proc_register(net, &kcm_seq_muxinfo);\r\nif (err)\r\ngoto out_kcm;\r\nreturn 0;\r\nout_kcm:\r\nremove_proc_entry("kcm_stats", net->proc_net);\r\nout_kcm_stats:\r\nreturn err;\r\n}\r\nstatic void kcm_proc_exit_net(struct net *net)\r\n{\r\nkcm_proc_unregister(net, &kcm_seq_muxinfo);\r\nremove_proc_entry("kcm_stats", net->proc_net);\r\n}\r\nint __init kcm_proc_init(void)\r\n{\r\nreturn register_pernet_subsys(&kcm_net_ops);\r\n}\r\nvoid __exit kcm_proc_exit(void)\r\n{\r\nunregister_pernet_subsys(&kcm_net_ops);\r\n}

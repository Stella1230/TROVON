static int vgic_irqfd_set_irq(struct kvm_kernel_irq_routing_entry *e,\r\nstruct kvm *kvm, int irq_source_id,\r\nint level, bool line_status)\r\n{\r\nunsigned int spi_id = e->irqchip.pin + VGIC_NR_PRIVATE_IRQS;\r\nif (!vgic_valid_spi(kvm, spi_id))\r\nreturn -EINVAL;\r\nreturn kvm_vgic_inject_irq(kvm, 0, spi_id, level);\r\n}\r\nint kvm_set_routing_entry(struct kvm *kvm,\r\nstruct kvm_kernel_irq_routing_entry *e,\r\nconst struct kvm_irq_routing_entry *ue)\r\n{\r\nint r = -EINVAL;\r\nswitch (ue->type) {\r\ncase KVM_IRQ_ROUTING_IRQCHIP:\r\ne->set = vgic_irqfd_set_irq;\r\ne->irqchip.irqchip = ue->u.irqchip.irqchip;\r\ne->irqchip.pin = ue->u.irqchip.pin;\r\nif ((e->irqchip.pin >= KVM_IRQCHIP_NUM_PINS) ||\r\n(e->irqchip.irqchip >= KVM_NR_IRQCHIPS))\r\ngoto out;\r\nbreak;\r\ncase KVM_IRQ_ROUTING_MSI:\r\ne->set = kvm_set_msi;\r\ne->msi.address_lo = ue->u.msi.address_lo;\r\ne->msi.address_hi = ue->u.msi.address_hi;\r\ne->msi.data = ue->u.msi.data;\r\ne->msi.flags = ue->flags;\r\ne->msi.devid = ue->u.msi.devid;\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nr = 0;\r\nout:\r\nreturn r;\r\n}\r\nint kvm_set_msi(struct kvm_kernel_irq_routing_entry *e,\r\nstruct kvm *kvm, int irq_source_id,\r\nint level, bool line_status)\r\n{\r\nstruct kvm_msi msi;\r\nmsi.address_lo = e->msi.address_lo;\r\nmsi.address_hi = e->msi.address_hi;\r\nmsi.data = e->msi.data;\r\nmsi.flags = e->msi.flags;\r\nmsi.devid = e->msi.devid;\r\nif (!vgic_has_its(kvm))\r\nreturn -ENODEV;\r\nif (!level)\r\nreturn -1;\r\nreturn vgic_its_inject_msi(kvm, &msi);\r\n}\r\nint kvm_vgic_setup_default_irq_routing(struct kvm *kvm)\r\n{\r\nstruct kvm_irq_routing_entry *entries;\r\nstruct vgic_dist *dist = &kvm->arch.vgic;\r\nu32 nr = dist->nr_spis;\r\nint i, ret;\r\nentries = kcalloc(nr, sizeof(struct kvm_kernel_irq_routing_entry),\r\nGFP_KERNEL);\r\nif (!entries)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < nr; i++) {\r\nentries[i].gsi = i;\r\nentries[i].type = KVM_IRQ_ROUTING_IRQCHIP;\r\nentries[i].u.irqchip.irqchip = 0;\r\nentries[i].u.irqchip.pin = i;\r\n}\r\nret = kvm_set_irq_routing(kvm, entries, nr, 0);\r\nkfree(entries);\r\nreturn ret;\r\n}

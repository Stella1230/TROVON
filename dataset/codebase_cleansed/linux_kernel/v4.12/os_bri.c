static void diva_bri_set_addresses(diva_os_xdi_adapter_t *a)\r\n{\r\na->resources.pci.mem_type_id[MEM_TYPE_RAM] = 0;\r\na->resources.pci.mem_type_id[MEM_TYPE_CFG] = 1;\r\na->resources.pci.mem_type_id[MEM_TYPE_ADDRESS] = 2;\r\na->resources.pci.mem_type_id[MEM_TYPE_RESET] = 1;\r\na->resources.pci.mem_type_id[MEM_TYPE_PORT] = 2;\r\na->resources.pci.mem_type_id[MEM_TYPE_CTLREG] = 2;\r\na->xdi_adapter.ram = a->resources.pci.addr[0];\r\na->xdi_adapter.cfg = a->resources.pci.addr[1];\r\na->xdi_adapter.Address = a->resources.pci.addr[2];\r\na->xdi_adapter.reset = a->xdi_adapter.cfg;\r\na->xdi_adapter.port = a->xdi_adapter.Address;\r\na->xdi_adapter.ctlReg = a->xdi_adapter.port + M_PCI_RESET;\r\na->xdi_adapter.reset += 0x4C;\r\n}\r\nint diva_bri_init_card(diva_os_xdi_adapter_t *a)\r\n{\r\nint bar;\r\ndword bar2 = 0, bar2_length = 0xffffffff;\r\nword cmd = 0, cmd_org;\r\nbyte Bus, Slot;\r\nvoid *hdev;\r\nbyte __iomem *p;\r\na->xdi_adapter.Properties = CardProperties[a->CardOrdinal];\r\nDBG_LOG(("Load %s", a->xdi_adapter.Properties.Name))\r\nfor (bar = 0; bar < 3; bar++) {\r\na->resources.pci.bar[bar] =\r\ndivasa_get_pci_bar(a->resources.pci.bus,\r\na->resources.pci.func, bar,\r\na->resources.pci.hdev);\r\nif (!a->resources.pci.bar[bar]) {\r\nDBG_ERR(("A: can't get BAR[%d]", bar))\r\nreturn (-1);\r\n}\r\n}\r\na->resources.pci.irq =\r\n(byte) divasa_get_pci_irq(a->resources.pci.bus,\r\na->resources.pci.func,\r\na->resources.pci.hdev);\r\nif (!a->resources.pci.irq) {\r\nDBG_ERR(("A: invalid irq"));\r\nreturn (-1);\r\n}\r\nBus = a->resources.pci.bus;\r\nSlot = a->resources.pci.func;\r\nhdev = a->resources.pci.hdev;\r\nPCIread(Bus, Slot, 0x18, &bar2, sizeof(bar2), hdev);\r\nPCIread(Bus, Slot, 0x04, &cmd_org, sizeof(cmd_org), hdev);\r\nPCIwrite(Bus, Slot, 0x04, &cmd, sizeof(cmd), hdev);\r\nPCIwrite(Bus, Slot, 0x18, &bar2_length, sizeof(bar2_length), hdev);\r\nPCIread(Bus, Slot, 0x18, &bar2_length, sizeof(bar2_length), hdev);\r\nPCIwrite(Bus, Slot, 0x18, &bar2, sizeof(bar2), hdev);\r\nPCIwrite(Bus, Slot, 0x04, &cmd_org, sizeof(cmd_org), hdev);\r\nbar2_length = (~(bar2_length & ~7)) + 1;\r\nDBG_LOG(("BAR[2] length=%lx", bar2_length))\r\nif (!(a->resources.pci.addr[0] =\r\ndivasa_remap_pci_bar(a, 0, a->resources.pci.bar[0],\r\nbri_bar_length[0]))) {\r\nDBG_ERR(("A: BRI, can't map BAR[0]"))\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nsprintf(&a->port_name[0], "BRI %02x:%02x",\r\na->resources.pci.bus, a->resources.pci.func);\r\nif (diva_os_register_io_port(a, 1, a->resources.pci.bar[1],\r\nbri_bar_length[1], &a->port_name[0], 1)) {\r\nDBG_ERR(("A: BRI, can't register BAR[1]"))\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->resources.pci.addr[1] = (void *) (unsigned long) a->resources.pci.bar[1];\r\na->resources.pci.length[1] = bri_bar_length[1];\r\nif (diva_os_register_io_port(a, 1, a->resources.pci.bar[2],\r\nbar2_length, &a->port_name[0], 2)) {\r\nDBG_ERR(("A: BRI, can't register BAR[2]"))\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->resources.pci.addr[2] = (void *) (unsigned long) a->resources.pci.bar[2];\r\na->resources.pci.length[2] = bar2_length;\r\ndiva_bri_set_addresses(a);\r\na->xdi_adapter.serialNo = diva_bri_get_serial_number(a);\r\nif (diva_bri_reregister_io(a)) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nif (diva_os_initialize_spin_lock\r\n(&a->xdi_adapter.isr_spin_lock, "isr")) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nif (diva_os_initialize_spin_lock\r\n(&a->xdi_adapter.data_spin_lock, "data")) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nstrcpy(a->xdi_adapter.req_soft_isr.dpc_thread_name, "kdivasbrid");\r\nif (diva_os_initialize_soft_isr(&a->xdi_adapter.req_soft_isr,\r\nDIDpcRoutine, &a->xdi_adapter)) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->xdi_adapter.isr_soft_isr.object = a->xdi_adapter.req_soft_isr.object;\r\na->xdi_adapter.Channels = CardProperties[a->CardOrdinal].Channels;\r\na->xdi_adapter.e_max = CardProperties[a->CardOrdinal].E_info;\r\na->xdi_adapter.e_tbl = diva_os_malloc(0, a->xdi_adapter.e_max * sizeof(E_INFO));\r\nif (!a->xdi_adapter.e_tbl) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nmemset(a->xdi_adapter.e_tbl, 0x00, a->xdi_adapter.e_max * sizeof(E_INFO));\r\na->xdi_adapter.a.io = &a->xdi_adapter;\r\na->xdi_adapter.DIRequest = request;\r\na->interface.cleanup_adapter_proc = diva_bri_cleanup_adapter;\r\na->interface.cmd_proc = diva_bri_cmd_card_proc;\r\np = DIVA_OS_MEM_ATTACH_RESET(&a->xdi_adapter);\r\noutpp(p, 0x41);\r\nDIVA_OS_MEM_DETACH_RESET(&a->xdi_adapter, p);\r\nprepare_maestra_functions(&a->xdi_adapter);\r\na->dsp_mask = 0x00000003;\r\na->xdi_adapter.irq_info.irq_nr = a->resources.pci.irq;\r\nsprintf(a->xdi_adapter.irq_info.irq_name, "DIVA BRI %ld",\r\n(long) a->xdi_adapter.serialNo);\r\nif (diva_os_register_irq(a, a->xdi_adapter.irq_info.irq_nr,\r\na->xdi_adapter.irq_info.irq_name)) {\r\ndiva_bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->xdi_adapter.irq_info.registered = 1;\r\ndiva_log_info("%s IRQ:%d SerNo:%d", a->xdi_adapter.Properties.Name,\r\na->resources.pci.irq, a->xdi_adapter.serialNo);\r\nreturn (0);\r\n}\r\nstatic int diva_bri_cleanup_adapter(diva_os_xdi_adapter_t *a)\r\n{\r\nint i;\r\nif (a->xdi_adapter.Initialized) {\r\ndiva_bri_stop_adapter(a);\r\n}\r\nif (a->xdi_adapter.irq_info.registered) {\r\ndiva_os_remove_irq(a, a->xdi_adapter.irq_info.irq_nr);\r\n}\r\na->xdi_adapter.irq_info.registered = 0;\r\nif (a->resources.pci.addr[0] && a->resources.pci.bar[0]) {\r\ndivasa_unmap_pci_bar(a->resources.pci.addr[0]);\r\na->resources.pci.addr[0] = NULL;\r\na->resources.pci.bar[0] = 0;\r\n}\r\nfor (i = 1; i < 3; i++) {\r\nif (a->resources.pci.addr[i] && a->resources.pci.bar[i]) {\r\ndiva_os_register_io_port(a, 0,\r\na->resources.pci.bar[i],\r\na->resources.pci.\r\nlength[i],\r\n&a->port_name[0], i);\r\na->resources.pci.addr[i] = NULL;\r\na->resources.pci.bar[i] = 0;\r\n}\r\n}\r\ndiva_os_cancel_soft_isr(&a->xdi_adapter.req_soft_isr);\r\ndiva_os_cancel_soft_isr(&a->xdi_adapter.isr_soft_isr);\r\ndiva_os_remove_soft_isr(&a->xdi_adapter.req_soft_isr);\r\na->xdi_adapter.isr_soft_isr.object = NULL;\r\ndiva_os_destroy_spin_lock(&a->xdi_adapter.isr_spin_lock, "rm");\r\ndiva_os_destroy_spin_lock(&a->xdi_adapter.data_spin_lock, "rm");\r\nif (a->xdi_adapter.e_tbl) {\r\ndiva_os_free(0, a->xdi_adapter.e_tbl);\r\na->xdi_adapter.e_tbl = NULL;\r\n}\r\nreturn (0);\r\n}\r\nvoid diva_os_prepare_maestra_functions(PISDN_ADAPTER IoAdapter)\r\n{\r\n}\r\nstatic dword diva_bri_get_serial_number(diva_os_xdi_adapter_t *a)\r\n{\r\ndword serNo = 0;\r\nbyte __iomem *confIO;\r\nword serHi, serLo;\r\nword __iomem *confMem;\r\nconfIO = DIVA_OS_MEM_ATTACH_CFG(&a->xdi_adapter);\r\nserHi = (word) (inppw(&confIO[0x22]) & 0x0FFF);\r\nserLo = (word) (inppw(&confIO[0x26]) & 0x0FFF);\r\nserNo = ((dword) serHi << 16) | (dword) serLo;\r\nDIVA_OS_MEM_DETACH_CFG(&a->xdi_adapter, confIO);\r\nif ((serNo == 0) || (serNo == 0xFFFFFFFF)) {\r\nDBG_FTL(("W: BRI use BAR[0] to get card serial number"))\r\nconfMem = (word __iomem *)DIVA_OS_MEM_ATTACH_RAM(&a->xdi_adapter);\r\nserHi = (word) (READ_WORD(&confMem[0x11]) & 0x0FFF);\r\nserLo = (word) (READ_WORD(&confMem[0x13]) & 0x0FFF);\r\nserNo = (((dword) serHi) << 16) | ((dword) serLo);\r\nDIVA_OS_MEM_DETACH_RAM(&a->xdi_adapter, confMem);\r\n}\r\nDBG_LOG(("Serial Number=%ld", serNo))\r\nreturn (serNo);\r\n}\r\nstatic int diva_bri_reregister_io(diva_os_xdi_adapter_t *a)\r\n{\r\nint i;\r\nfor (i = 1; i < 3; i++) {\r\ndiva_os_register_io_port(a, 0, a->resources.pci.bar[i],\r\na->resources.pci.length[i],\r\n&a->port_name[0], i);\r\na->resources.pci.addr[i] = NULL;\r\n}\r\nsprintf(a->port_name, "DIVA BRI %ld",\r\n(long) a->xdi_adapter.serialNo);\r\nfor (i = 1; i < 3; i++) {\r\nif (diva_os_register_io_port(a, 1, a->resources.pci.bar[i],\r\na->resources.pci.length[i],\r\n&a->port_name[0], i)) {\r\nDBG_ERR(("A: failed to reregister BAR[%d]", i))\r\nreturn (-1);\r\n}\r\na->resources.pci.addr[i] =\r\n(void *) (unsigned long) a->resources.pci.bar[i];\r\n}\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_bri_cmd_card_proc(struct _diva_os_xdi_adapter *a,\r\ndiva_xdi_um_cfg_cmd_t *cmd, int length)\r\n{\r\nint ret = -1;\r\nif (cmd->adapter != a->controller) {\r\nDBG_ERR(("A: pri_cmd, invalid controller=%d != %d",\r\ncmd->adapter, a->controller))\r\nreturn (-1);\r\n}\r\nswitch (cmd->command) {\r\ncase DIVA_XDI_UM_CMD_GET_CARD_ORDINAL:\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\n*(dword *) a->xdi_mbox.data =\r\n(dword) a->CardOrdinal;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_SERIAL_NR:\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\n*(dword *) a->xdi_mbox.data =\r\n(dword) a->xdi_adapter.serialNo;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_PCI_HW_CONFIG:\r\na->xdi_mbox.data_length = sizeof(dword) * 9;\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\nint i;\r\ndword *data = (dword *) a->xdi_mbox.data;\r\nfor (i = 0; i < 8; i++) {\r\n*data++ = a->resources.pci.bar[i];\r\n}\r\n*data++ = (dword) a->resources.pci.irq;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_CARD_STATE:\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\ndword *data = (dword *) a->xdi_mbox.data;\r\nif (!a->xdi_adapter.port) {\r\n*data = 3;\r\n} else if (a->xdi_adapter.trapped) {\r\n*data = 2;\r\n} else if (a->xdi_adapter.Initialized) {\r\n*data = 1;\r\n} else {\r\n*data = 0;\r\n}\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_RESET_ADAPTER:\r\nret = diva_bri_reset_adapter(&a->xdi_adapter);\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_WRITE_SDRAM_BLOCK:\r\nret = diva_bri_write_sdram_block(&a->xdi_adapter,\r\ncmd->command_data.\r\nwrite_sdram.offset,\r\n(byte *)&cmd[1],\r\ncmd->command_data.\r\nwrite_sdram.length);\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_START_ADAPTER:\r\nret = diva_bri_start_adapter(&a->xdi_adapter,\r\ncmd->command_data.start.\r\noffset,\r\ncmd->command_data.start.\r\nfeatures);\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_SET_PROTOCOL_FEATURES:\r\na->xdi_adapter.features =\r\ncmd->command_data.features.features;\r\na->xdi_adapter.a.protocol_capabilities =\r\na->xdi_adapter.features;\r\nDBG_TRC(\r\n("Set raw protocol features (%08x)",\r\na->xdi_adapter.features)) ret = 0;\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_STOP_ADAPTER:\r\nret = diva_bri_stop_adapter(a);\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_READ_XLOG_ENTRY:\r\nret = diva_card_read_xlog(a);\r\nbreak;\r\ndefault:\r\nDBG_ERR(\r\n("A: A(%d) invalid cmd=%d", a->controller,\r\ncmd->command))}\r\nreturn (ret);\r\n}\r\nstatic int diva_bri_reset_adapter(PISDN_ADAPTER IoAdapter)\r\n{\r\nbyte __iomem *addrHi, *addrLo, *ioaddr;\r\ndword i;\r\nbyte __iomem *Port;\r\nif (!IoAdapter->port) {\r\nreturn (-1);\r\n}\r\nif (IoAdapter->Initialized) {\r\nDBG_ERR(("A: A(%d) can't reset BRI adapter - please stop first",\r\nIoAdapter->ANum)) return (-1);\r\n}\r\n(*(IoAdapter->rstFnc)) (IoAdapter);\r\ndiva_os_wait(100);\r\nPort = DIVA_OS_MEM_ATTACH_PORT(IoAdapter);\r\naddrHi = Port +\r\n((IoAdapter->Properties.Bus == BUS_PCI) ? M_PCI_ADDRH : ADDRH);\r\naddrLo = Port + ADDR;\r\nioaddr = Port + DATA;\r\noutpp(addrHi, (byte) 0);\r\noutppw(addrLo, (word) 0);\r\noutppw(ioaddr, (word) 0);\r\noutpp(addrHi,\r\n(byte) (\r\n(IoAdapter->MemoryBase + IoAdapter->MemorySize -\r\nBRI_SHARED_RAM_SIZE) >> 16));\r\noutppw(addrLo, 0);\r\nfor (i = 0; i < 0x8000; outppw(ioaddr, 0), ++i);\r\ndiva_os_wait(100);\r\noutpp(addrHi,\r\n(byte) (\r\n(IoAdapter->MemoryBase + IoAdapter->MemorySize -\r\nBRI_SHARED_RAM_SIZE) >> 16));\r\noutppw(addrLo, 0x1e);\r\noutpp(ioaddr, 0);\r\noutpp(ioaddr, 0);\r\noutpp(addrHi, (byte) 0);\r\noutppw(addrLo, (word) 0);\r\noutppw(ioaddr, (word) 0);\r\nDIVA_OS_MEM_DETACH_PORT(IoAdapter, Port);\r\nIoAdapter->e_count = 0;\r\nif (IoAdapter->e_tbl) {\r\nmemset(IoAdapter->e_tbl, 0x00,\r\nIoAdapter->e_max * sizeof(E_INFO));\r\n}\r\nIoAdapter->head = 0;\r\nIoAdapter->tail = 0;\r\nIoAdapter->assign = 0;\r\nIoAdapter->trapped = 0;\r\nmemset(&IoAdapter->a.IdTable[0], 0x00,\r\nsizeof(IoAdapter->a.IdTable));\r\nmemset(&IoAdapter->a.IdTypeTable[0], 0x00,\r\nsizeof(IoAdapter->a.IdTypeTable));\r\nmemset(&IoAdapter->a.FlowControlIdTable[0], 0x00,\r\nsizeof(IoAdapter->a.FlowControlIdTable));\r\nmemset(&IoAdapter->a.FlowControlSkipTable[0], 0x00,\r\nsizeof(IoAdapter->a.FlowControlSkipTable));\r\nmemset(&IoAdapter->a.misc_flags_table[0], 0x00,\r\nsizeof(IoAdapter->a.misc_flags_table));\r\nmemset(&IoAdapter->a.rx_stream[0], 0x00,\r\nsizeof(IoAdapter->a.rx_stream));\r\nmemset(&IoAdapter->a.tx_stream[0], 0x00,\r\nsizeof(IoAdapter->a.tx_stream));\r\nmemset(&IoAdapter->a.tx_pos[0], 0x00, sizeof(IoAdapter->a.tx_pos));\r\nmemset(&IoAdapter->a.rx_pos[0], 0x00, sizeof(IoAdapter->a.rx_pos));\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_bri_write_sdram_block(PISDN_ADAPTER IoAdapter,\r\ndword address, const byte *data, dword length)\r\n{\r\nbyte __iomem *addrHi, *addrLo, *ioaddr;\r\nbyte __iomem *Port;\r\nif (!IoAdapter->port) {\r\nreturn (-1);\r\n}\r\nPort = DIVA_OS_MEM_ATTACH_PORT(IoAdapter);\r\naddrHi = Port +\r\n((IoAdapter->Properties.Bus == BUS_PCI) ? M_PCI_ADDRH : ADDRH);\r\naddrLo = Port + ADDR;\r\nioaddr = Port + DATA;\r\nwhile (length--) {\r\noutpp(addrHi, (word) (address >> 16));\r\noutppw(addrLo, (word) (address & 0x0000ffff));\r\noutpp(ioaddr, *data++);\r\naddress++;\r\n}\r\nDIVA_OS_MEM_DETACH_PORT(IoAdapter, Port);\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_bri_start_adapter(PISDN_ADAPTER IoAdapter,\r\ndword start_address, dword features)\r\n{\r\nbyte __iomem *Port;\r\ndword i, test;\r\nbyte __iomem *addrHi, *addrLo, *ioaddr;\r\nint started = 0;\r\nADAPTER *a = &IoAdapter->a;\r\nif (IoAdapter->Initialized) {\r\nDBG_ERR(\r\n("A: A(%d) bri_start_adapter, adapter already running",\r\nIoAdapter->ANum)) return (-1);\r\n}\r\nif (!IoAdapter->port) {\r\nDBG_ERR(("A: A(%d) bri_start_adapter, adapter not mapped",\r\nIoAdapter->ANum)) return (-1);\r\n}\r\nsprintf(IoAdapter->Name, "A(%d)", (int) IoAdapter->ANum);\r\nDBG_LOG(("A(%d) start BRI", IoAdapter->ANum))\r\nPort = DIVA_OS_MEM_ATTACH_PORT(IoAdapter);\r\naddrHi = Port +\r\n((IoAdapter->Properties.Bus == BUS_PCI) ? M_PCI_ADDRH : ADDRH);\r\naddrLo = Port + ADDR;\r\nioaddr = Port + DATA;\r\noutpp(addrHi,\r\n(byte) (\r\n(IoAdapter->MemoryBase + IoAdapter->MemorySize -\r\nBRI_SHARED_RAM_SIZE) >> 16));\r\noutppw(addrLo, 0x1e);\r\noutppw(ioaddr, 0x00);\r\nDIVA_OS_MEM_DETACH_PORT(IoAdapter, Port);\r\nPort = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\noutpp(Port, 0x08);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, Port);\r\nPort = DIVA_OS_MEM_ATTACH_PORT(IoAdapter);\r\naddrHi = Port +\r\n((IoAdapter->Properties.Bus == BUS_PCI) ? M_PCI_ADDRH : ADDRH);\r\naddrLo = Port + ADDR;\r\nioaddr = Port + DATA;\r\nfor (i = 0; i < 300; ++i) {\r\ndiva_os_wait(10);\r\noutpp(addrHi,\r\n(byte) (\r\n(IoAdapter->MemoryBase +\r\nIoAdapter->MemorySize -\r\nBRI_SHARED_RAM_SIZE) >> 16));\r\noutppw(addrLo, 0x1e);\r\ntest = (dword) inppw(ioaddr);\r\nif (test == 0x4447) {\r\nDBG_LOG(\r\n("Protocol startup time %d.%02d seconds",\r\n(i / 100), (i % 100)))\r\nstarted = 1;\r\nbreak;\r\n}\r\n}\r\nDIVA_OS_MEM_DETACH_PORT(IoAdapter, Port);\r\nif (!started) {\r\nDBG_FTL(("A: A(%d) %s: Adapter selftest failed 0x%04X",\r\nIoAdapter->ANum, IoAdapter->Properties.Name,\r\ntest))\r\n(*(IoAdapter->trapFnc)) (IoAdapter);\r\nreturn (-1);\r\n}\r\nIoAdapter->Initialized = 1;\r\nIoAdapter->IrqCount = 0;\r\na->ReadyInt = 1;\r\nif (IoAdapter->reset) {\r\nPort = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\noutpp(Port, 0x41);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, Port);\r\n}\r\na->ram_out(a, &PR_RAM->ReadyInt, 1);\r\nfor (i = 0; ((!IoAdapter->IrqCount) && (i < 100)); i++) {\r\ndiva_os_wait(10);\r\n}\r\nif (!IoAdapter->IrqCount) {\r\nDBG_ERR(\r\n("A: A(%d) interrupt test failed",\r\nIoAdapter->ANum))\r\nIoAdapter->Initialized = 0;\r\nIoAdapter->stop(IoAdapter);\r\nreturn (-1);\r\n}\r\nIoAdapter->Properties.Features = (word) features;\r\ndiva_xdi_display_adapter_features(IoAdapter->ANum);\r\nDBG_LOG(("A(%d) BRI adapter successfully started", IoAdapter->ANum))\r\ndiva_xdi_didd_register_adapter(IoAdapter->ANum);\r\nreturn (0);\r\n}\r\nstatic void diva_bri_clear_interrupts(diva_os_xdi_adapter_t *a)\r\n{\r\nPISDN_ADAPTER IoAdapter = &a->xdi_adapter;\r\nIoAdapter->disIrq(IoAdapter);\r\nIoAdapter->tst_irq(&IoAdapter->a);\r\nIoAdapter->clr_irq(&IoAdapter->a);\r\nIoAdapter->tst_irq(&IoAdapter->a);\r\ndiva_os_cancel_soft_isr(&IoAdapter->req_soft_isr);\r\ndiva_os_cancel_soft_isr(&IoAdapter->isr_soft_isr);\r\n}\r\nstatic int diva_bri_stop_adapter(diva_os_xdi_adapter_t *a)\r\n{\r\nPISDN_ADAPTER IoAdapter = &a->xdi_adapter;\r\nint i = 100;\r\nif (!IoAdapter->port) {\r\nreturn (-1);\r\n}\r\nif (!IoAdapter->Initialized) {\r\nDBG_ERR(("A: A(%d) can't stop BRI adapter - not running",\r\nIoAdapter->ANum))\r\nreturn (-1);\r\n}\r\nIoAdapter->Initialized = 0;\r\ndiva_xdi_didd_remove_adapter(IoAdapter->ANum);\r\na->clear_interrupts_proc = diva_bri_clear_interrupts;\r\nIoAdapter->a.ReadyInt = 1;\r\nIoAdapter->a.ram_inc(&IoAdapter->a, &PR_RAM->ReadyInt);\r\ndo {\r\ndiva_os_sleep(10);\r\n} while (i-- && a->clear_interrupts_proc);\r\nif (a->clear_interrupts_proc) {\r\ndiva_bri_clear_interrupts(a);\r\na->clear_interrupts_proc = NULL;\r\nDBG_ERR(("A: A(%d) no final interrupt from BRI adapter",\r\nIoAdapter->ANum))\r\n}\r\nIoAdapter->a.ReadyInt = 0;\r\nIoAdapter->stop(IoAdapter);\r\nreturn (0);\r\n}

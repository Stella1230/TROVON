static inline int volt_reg_to_mv(int value)\r\n{\r\nreturn DIV_ROUND_CLOSEST(value * 2000, 1023) + 2500;\r\n}\r\nstatic inline int input_reg_to_mv(int value)\r\n{\r\nreturn DIV_ROUND_CLOSEST(value * 2500, 1023);\r\n}\r\nstatic inline int vbbat_reg_to_mv(int value)\r\n{\r\nreturn DIV_ROUND_CLOSEST(value * 5000, 1023);\r\n}\r\nstatic inline int da9052_enable_vddout_channel(struct da9052 *da9052)\r\n{\r\nreturn da9052_reg_update(da9052, DA9052_ADC_CONT_REG,\r\nDA9052_ADCCONT_AUTOVDDEN,\r\nDA9052_ADCCONT_AUTOVDDEN);\r\n}\r\nstatic inline int da9052_disable_vddout_channel(struct da9052 *da9052)\r\n{\r\nreturn da9052_reg_update(da9052, DA9052_ADC_CONT_REG,\r\nDA9052_ADCCONT_AUTOVDDEN, 0);\r\n}\r\nstatic ssize_t da9052_read_vddout(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint ret, vdd;\r\nmutex_lock(&hwmon->hwmon_lock);\r\nret = da9052_enable_vddout_channel(hwmon->da9052);\r\nif (ret < 0)\r\ngoto hwmon_err;\r\nvdd = da9052_reg_read(hwmon->da9052, DA9052_VDD_RES_REG);\r\nif (vdd < 0) {\r\nret = vdd;\r\ngoto hwmon_err_release;\r\n}\r\nret = da9052_disable_vddout_channel(hwmon->da9052);\r\nif (ret < 0)\r\ngoto hwmon_err;\r\nmutex_unlock(&hwmon->hwmon_lock);\r\nreturn sprintf(buf, "%d\n", volt_reg_to_mv(vdd));\r\nhwmon_err_release:\r\nda9052_disable_vddout_channel(hwmon->da9052);\r\nhwmon_err:\r\nmutex_unlock(&hwmon->hwmon_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t da9052_read_ich(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint ret;\r\nret = da9052_reg_read(hwmon->da9052, DA9052_ICHG_AV_REG);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", DIV_ROUND_CLOSEST(ret * 39, 10));\r\n}\r\nstatic ssize_t da9052_read_tbat(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", da9052_adc_read_temp(hwmon->da9052));\r\n}\r\nstatic ssize_t da9052_read_vbat(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint ret;\r\nret = da9052_adc_manual_read(hwmon->da9052, DA9052_ADC_VBAT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", volt_reg_to_mv(ret));\r\n}\r\nstatic ssize_t da9052_read_misc_channel(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint channel = to_sensor_dev_attr(devattr)->index;\r\nint ret;\r\nret = da9052_adc_manual_read(hwmon->da9052, channel);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", input_reg_to_mv(ret));\r\n}\r\nstatic ssize_t da9052_read_tjunc(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint tjunc;\r\nint toffset;\r\ntjunc = da9052_reg_read(hwmon->da9052, DA9052_TJUNC_RES_REG);\r\nif (tjunc < 0)\r\nreturn tjunc;\r\ntoffset = da9052_reg_read(hwmon->da9052, DA9052_T_OFFSET_REG);\r\nif (toffset < 0)\r\nreturn toffset;\r\nreturn sprintf(buf, "%d\n", 1708 * (tjunc - toffset) - 108800);\r\n}\r\nstatic ssize_t da9052_read_vbbat(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct da9052_hwmon *hwmon = dev_get_drvdata(dev);\r\nint ret;\r\nret = da9052_adc_manual_read(hwmon->da9052, DA9052_ADC_VBBAT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", vbbat_reg_to_mv(ret));\r\n}\r\nstatic ssize_t show_label(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nreturn sprintf(buf, "%s\n",\r\ninput_names[to_sensor_dev_attr(devattr)->index]);\r\n}\r\nstatic int da9052_hwmon_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct da9052_hwmon *hwmon;\r\nstruct device *hwmon_dev;\r\nhwmon = devm_kzalloc(dev, sizeof(struct da9052_hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nmutex_init(&hwmon->hwmon_lock);\r\nhwmon->da9052 = dev_get_drvdata(pdev->dev.parent);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, "da9052",\r\nhwmon,\r\nda9052_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

static int __init system_timer_of_register(struct device_node *np)\r\n{\r\nstruct clk *clk = NULL;\r\nvoid __iomem *base;\r\nu32 rate;\r\nint ret;\r\nbase = of_iomap(np, 0);\r\nif (!base) {\r\npr_warn("system-timer: invalid base address\n");\r\nreturn -ENXIO;\r\n}\r\nret = of_property_read_u32(np, "clock-frequency", &rate);\r\nif (ret) {\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto out_unmap;\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\ngoto out_clk_put;\r\nrate = clk_get_rate(clk);\r\nif (!rate) {\r\nret = -EINVAL;\r\ngoto out_clk_disable;\r\n}\r\n}\r\nwritel_relaxed(SYSTICK_LOAD_RELOAD_MASK, base + SYST_RVR);\r\nwritel_relaxed(SYST_CSR_ENABLE, base + SYST_CSR);\r\nret = clocksource_mmio_init(base + SYST_CVR, "arm_system_timer", rate,\r\n200, 24, clocksource_mmio_readl_down);\r\nif (ret) {\r\npr_err("failed to init clocksource (%d)\n", ret);\r\nif (clk)\r\ngoto out_clk_disable;\r\nelse\r\ngoto out_unmap;\r\n}\r\npr_info("ARM System timer initialized as clocksource\n");\r\nreturn 0;\r\nout_clk_disable:\r\nclk_disable_unprepare(clk);\r\nout_clk_put:\r\nclk_put(clk);\r\nout_unmap:\r\niounmap(base);\r\npr_warn("ARM System timer register failed (%d)\n", ret);\r\nreturn ret;\r\n}

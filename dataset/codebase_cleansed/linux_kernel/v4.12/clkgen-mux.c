static const char ** __init clkgen_mux_get_parents(struct device_node *np,\r\nint *num_parents)\r\n{\r\nconst char **parents;\r\nunsigned int nparents;\r\nnparents = of_clk_get_parent_count(np);\r\nif (WARN_ON(!nparents))\r\nreturn ERR_PTR(-EINVAL);\r\nparents = kcalloc(nparents, sizeof(const char *), GFP_KERNEL);\r\nif (!parents)\r\nreturn ERR_PTR(-ENOMEM);\r\n*num_parents = of_clk_parent_fill(np, parents, nparents);\r\nreturn parents;\r\n}\r\nstatic void __init st_of_clkgen_mux_setup(struct device_node *np,\r\nstruct clkgen_mux_data *data)\r\n{\r\nstruct clk *clk;\r\nvoid __iomem *reg;\r\nconst char **parents;\r\nint num_parents = 0;\r\nreg = of_iomap(np, 0);\r\nif (!reg) {\r\npr_err("%s: Failed to get base address\n", __func__);\r\nreturn;\r\n}\r\nparents = clkgen_mux_get_parents(np, &num_parents);\r\nif (IS_ERR(parents)) {\r\npr_err("%s: Failed to get parents (%ld)\n",\r\n__func__, PTR_ERR(parents));\r\ngoto err_parents;\r\n}\r\nclk = clk_register_mux(NULL, np->name, parents, num_parents,\r\ndata->clk_flags | CLK_SET_RATE_PARENT,\r\nreg + data->offset,\r\ndata->shift, data->width, data->mux_flags,\r\ndata->lock);\r\nif (IS_ERR(clk))\r\ngoto err;\r\npr_debug("%s: parent %s rate %u\n",\r\n__clk_get_name(clk),\r\n__clk_get_name(clk_get_parent(clk)),\r\n(unsigned int)clk_get_rate(clk));\r\nkfree(parents);\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\nreturn;\r\nerr:\r\nkfree(parents);\r\nerr_parents:\r\niounmap(reg);\r\n}\r\nstatic void __init st_of_clkgen_a9_mux_setup(struct device_node *np)\r\n{\r\nst_of_clkgen_mux_setup(np, &stih407_a9_mux_data);\r\n}

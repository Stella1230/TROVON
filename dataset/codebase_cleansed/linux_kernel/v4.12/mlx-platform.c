static int __init mlxplat_dmi_default_matched(const struct dmi_system_id *dmi)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mlxplat_mux_data); i++) {\r\nmlxplat_mux_data[i].values = mlxplat_default_channels[i];\r\nmlxplat_mux_data[i].n_values =\r\nARRAY_SIZE(mlxplat_default_channels[i]);\r\n}\r\nmlxplat_hotplug = &mlxplat_mlxcpld_default_data;\r\nreturn 1;\r\n}\r\nstatic int __init mlxplat_dmi_msn21xx_matched(const struct dmi_system_id *dmi)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mlxplat_mux_data); i++) {\r\nmlxplat_mux_data[i].values = mlxplat_msn21xx_channels;\r\nmlxplat_mux_data[i].n_values =\r\nARRAY_SIZE(mlxplat_msn21xx_channels);\r\n}\r\nmlxplat_hotplug = &mlxplat_mlxcpld_msn21xx_data;\r\nreturn 1;\r\n}\r\nstatic int __init mlxplat_init(void)\r\n{\r\nstruct mlxplat_priv *priv;\r\nint i, err;\r\nif (!dmi_check_system(mlxplat_dmi_table))\r\nreturn -ENODEV;\r\nmlxplat_dev = platform_device_register_simple(MLX_PLAT_DEVICE_NAME, -1,\r\nmlxplat_lpc_resources,\r\nARRAY_SIZE(mlxplat_lpc_resources));\r\nif (IS_ERR(mlxplat_dev))\r\nreturn PTR_ERR(mlxplat_dev);\r\npriv = devm_kzalloc(&mlxplat_dev->dev, sizeof(struct mlxplat_priv),\r\nGFP_KERNEL);\r\nif (!priv) {\r\nerr = -ENOMEM;\r\ngoto fail_alloc;\r\n}\r\nplatform_set_drvdata(mlxplat_dev, priv);\r\npriv->pdev_i2c = platform_device_register_simple("i2c_mlxcpld", -1,\r\nNULL, 0);\r\nif (IS_ERR(priv->pdev_i2c)) {\r\nerr = PTR_ERR(priv->pdev_i2c);\r\ngoto fail_alloc;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(mlxplat_mux_data); i++) {\r\npriv->pdev_mux[i] = platform_device_register_resndata(\r\n&mlxplat_dev->dev,\r\n"i2c-mux-reg", i, NULL,\r\n0, &mlxplat_mux_data[i],\r\nsizeof(mlxplat_mux_data[i]));\r\nif (IS_ERR(priv->pdev_mux[i])) {\r\nerr = PTR_ERR(priv->pdev_mux[i]);\r\ngoto fail_platform_mux_register;\r\n}\r\n}\r\npriv->pdev_hotplug = platform_device_register_resndata(\r\n&mlxplat_dev->dev, "mlxcpld-hotplug",\r\nPLATFORM_DEVID_NONE,\r\nmlxplat_mlxcpld_resources,\r\nARRAY_SIZE(mlxplat_mlxcpld_resources),\r\nmlxplat_hotplug, sizeof(*mlxplat_hotplug));\r\nif (IS_ERR(priv->pdev_hotplug)) {\r\nerr = PTR_ERR(priv->pdev_hotplug);\r\ngoto fail_platform_mux_register;\r\n}\r\nreturn 0;\r\nfail_platform_mux_register:\r\nwhile (--i >= 0)\r\nplatform_device_unregister(priv->pdev_mux[i]);\r\nplatform_device_unregister(priv->pdev_i2c);\r\nfail_alloc:\r\nplatform_device_unregister(mlxplat_dev);\r\nreturn err;\r\n}\r\nstatic void __exit mlxplat_exit(void)\r\n{\r\nstruct mlxplat_priv *priv = platform_get_drvdata(mlxplat_dev);\r\nint i;\r\nplatform_device_unregister(priv->pdev_hotplug);\r\nfor (i = ARRAY_SIZE(mlxplat_mux_data) - 1; i >= 0 ; i--)\r\nplatform_device_unregister(priv->pdev_mux[i]);\r\nplatform_device_unregister(priv->pdev_i2c);\r\nplatform_device_unregister(mlxplat_dev);\r\n}

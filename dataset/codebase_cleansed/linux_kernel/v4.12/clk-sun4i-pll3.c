static void __init sun4i_a10_pll3_setup(struct device_node *node)\r\n{\r\nconst char *clk_name = node->name, *parent;\r\nstruct clk_multiplier *mult;\r\nstruct clk_gate *gate;\r\nstruct resource res;\r\nvoid __iomem *reg;\r\nstruct clk *clk;\r\nint ret;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nparent = of_clk_get_parent_name(node, 0);\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("%s: Could not map the clock registers\n", clk_name);\r\nreturn;\r\n}\r\ngate = kzalloc(sizeof(*gate), GFP_KERNEL);\r\nif (!gate)\r\ngoto err_unmap;\r\ngate->reg = reg;\r\ngate->bit_idx = SUN4I_A10_PLL3_GATE_BIT;\r\ngate->lock = &sun4i_a10_pll3_lock;\r\nmult = kzalloc(sizeof(*mult), GFP_KERNEL);\r\nif (!mult)\r\ngoto err_free_gate;\r\nmult->reg = reg;\r\nmult->shift = SUN4I_A10_PLL3_DIV_SHIFT;\r\nmult->width = SUN4I_A10_PLL3_DIV_WIDTH;\r\nmult->lock = &sun4i_a10_pll3_lock;\r\nclk = clk_register_composite(NULL, clk_name,\r\n&parent, 1,\r\nNULL, NULL,\r\n&mult->hw, &clk_multiplier_ops,\r\n&gate->hw, &clk_gate_ops,\r\n0);\r\nif (IS_ERR(clk)) {\r\npr_err("%s: Couldn't register the clock\n", clk_name);\r\ngoto err_free_mult;\r\n}\r\nret = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nif (ret) {\r\npr_err("%s: Couldn't register DT provider\n",\r\nclk_name);\r\ngoto err_clk_unregister;\r\n}\r\nreturn;\r\nerr_clk_unregister:\r\nclk_unregister_composite(clk);\r\nerr_free_mult:\r\nkfree(mult);\r\nerr_free_gate:\r\nkfree(gate);\r\nerr_unmap:\r\niounmap(reg);\r\nof_address_to_resource(node, 0, &res);\r\nrelease_mem_region(res.start, resource_size(&res));\r\n}

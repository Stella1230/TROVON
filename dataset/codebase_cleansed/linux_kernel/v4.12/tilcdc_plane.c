static int tilcdc_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct drm_crtc_state *crtc_state;\r\nstruct drm_plane_state *old_state = plane->state;\r\nunsigned int pitch;\r\nif (!state->crtc)\r\nreturn 0;\r\nif (WARN_ON(!state->fb))\r\nreturn -EINVAL;\r\nif (state->crtc_x || state->crtc_y) {\r\ndev_err(plane->dev->dev, "%s: crtc position must be zero.",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\ncrtc_state = drm_atomic_get_existing_crtc_state(state->state,\r\nstate->crtc);\r\nif (WARN_ON(!crtc_state))\r\nreturn 0;\r\nif (crtc_state->mode.hdisplay != state->crtc_w ||\r\ncrtc_state->mode.vdisplay != state->crtc_h) {\r\ndev_err(plane->dev->dev,\r\n"%s: Size must match mode (%dx%d == %dx%d)", __func__,\r\ncrtc_state->mode.hdisplay, crtc_state->mode.vdisplay,\r\nstate->crtc_w, state->crtc_h);\r\nreturn -EINVAL;\r\n}\r\npitch = crtc_state->mode.hdisplay *\r\nstate->fb->format->cpp[0];\r\nif (state->fb->pitches[0] != pitch) {\r\ndev_err(plane->dev->dev,\r\n"Invalid pitch: fb and crtc widths must be the same");\r\nreturn -EINVAL;\r\n}\r\nif (state->fb && old_state->fb &&\r\nstate->fb->format != old_state->fb->format) {\r\ndev_dbg(plane->dev->dev,\r\n"%s(): pixel format change requires mode_change\n",\r\n__func__);\r\ncrtc_state->mode_changed = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic void tilcdc_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct drm_plane_state *state = plane->state;\r\nif (!state->crtc)\r\nreturn;\r\nif (WARN_ON(!state->fb || !state->crtc->state))\r\nreturn;\r\ntilcdc_crtc_update_fb(state->crtc,\r\nstate->fb,\r\nstate->crtc->state->event);\r\n}\r\nint tilcdc_plane_init(struct drm_device *dev,\r\nstruct drm_plane *plane)\r\n{\r\nstruct tilcdc_drm_private *priv = dev->dev_private;\r\nint ret;\r\nret = drm_plane_init(dev, plane, 1,\r\n&tilcdc_plane_funcs,\r\npriv->pixelformats,\r\npriv->num_pixelformats,\r\ntrue);\r\nif (ret) {\r\ndev_err(dev->dev, "Failed to initialize plane: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrm_plane_helper_add(plane, &plane_helper_funcs);\r\nreturn 0;\r\n}

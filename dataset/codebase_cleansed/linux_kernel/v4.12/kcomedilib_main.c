struct comedi_device *comedi_open(const char *filename)\r\n{\r\nstruct comedi_device *dev, *retval = NULL;\r\nunsigned int minor;\r\nif (strncmp(filename, "/dev/comedi", 11) != 0)\r\nreturn NULL;\r\nif (kstrtouint(filename + 11, 0, &minor))\r\nreturn NULL;\r\nif (minor >= COMEDI_NUM_BOARD_MINORS)\r\nreturn NULL;\r\ndev = comedi_dev_get_from_minor(minor);\r\nif (!dev)\r\nreturn NULL;\r\ndown_read(&dev->attach_lock);\r\nif (dev->attached)\r\nretval = dev;\r\nelse\r\nretval = NULL;\r\nup_read(&dev->attach_lock);\r\nif (!retval)\r\ncomedi_dev_put(dev);\r\nreturn retval;\r\n}\r\nint comedi_close(struct comedi_device *dev)\r\n{\r\ncomedi_dev_put(dev);\r\nreturn 0;\r\n}\r\nstatic int comedi_do_insn(struct comedi_device *dev,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nmutex_lock(&dev->mutex);\r\nif (!dev->attached) {\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\nif (insn->subdev >= dev->n_subdevices) {\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\ns = &dev->subdevices[insn->subdev];\r\nif (s->type == COMEDI_SUBD_UNUSED) {\r\ndev_err(dev->class_dev,\r\n"%d not usable subdevice\n", insn->subdev);\r\nret = -EIO;\r\ngoto error;\r\n}\r\nret = comedi_check_chanlist(s, 1, &insn->chanspec);\r\nif (ret < 0) {\r\ndev_err(dev->class_dev, "bad chanspec\n");\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\nif (s->busy) {\r\nret = -EBUSY;\r\ngoto error;\r\n}\r\ns->busy = dev;\r\nswitch (insn->insn) {\r\ncase INSN_BITS:\r\nret = s->insn_bits(dev, s, insn, data);\r\nbreak;\r\ncase INSN_CONFIG:\r\nret = s->insn_config(dev, s, insn, data);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ns->busy = NULL;\r\nerror:\r\nmutex_unlock(&dev->mutex);\r\nreturn ret;\r\n}\r\nint comedi_dio_get_config(struct comedi_device *dev, unsigned int subdev,\r\nunsigned int chan, unsigned int *io)\r\n{\r\nstruct comedi_insn insn;\r\nunsigned int data[2];\r\nint ret;\r\nmemset(&insn, 0, sizeof(insn));\r\ninsn.insn = INSN_CONFIG;\r\ninsn.n = 2;\r\ninsn.subdev = subdev;\r\ninsn.chanspec = CR_PACK(chan, 0, 0);\r\ndata[0] = INSN_CONFIG_DIO_QUERY;\r\ndata[1] = 0;\r\nret = comedi_do_insn(dev, &insn, data);\r\nif (ret >= 0)\r\n*io = data[1];\r\nreturn ret;\r\n}\r\nint comedi_dio_config(struct comedi_device *dev, unsigned int subdev,\r\nunsigned int chan, unsigned int io)\r\n{\r\nstruct comedi_insn insn;\r\nmemset(&insn, 0, sizeof(insn));\r\ninsn.insn = INSN_CONFIG;\r\ninsn.n = 1;\r\ninsn.subdev = subdev;\r\ninsn.chanspec = CR_PACK(chan, 0, 0);\r\nreturn comedi_do_insn(dev, &insn, &io);\r\n}\r\nint comedi_dio_bitfield2(struct comedi_device *dev, unsigned int subdev,\r\nunsigned int mask, unsigned int *bits,\r\nunsigned int base_channel)\r\n{\r\nstruct comedi_insn insn;\r\nunsigned int data[2];\r\nunsigned int n_chan;\r\nunsigned int shift;\r\nint ret;\r\nbase_channel = CR_CHAN(base_channel);\r\nn_chan = comedi_get_n_channels(dev, subdev);\r\nif (base_channel >= n_chan)\r\nreturn -EINVAL;\r\nmemset(&insn, 0, sizeof(insn));\r\ninsn.insn = INSN_BITS;\r\ninsn.chanspec = base_channel;\r\ninsn.n = 2;\r\ninsn.subdev = subdev;\r\ndata[0] = mask;\r\ndata[1] = *bits;\r\nif (n_chan <= 32) {\r\nshift = base_channel;\r\nif (shift) {\r\ninsn.chanspec = 0;\r\ndata[0] <<= shift;\r\ndata[1] <<= shift;\r\n}\r\n} else {\r\nshift = 0;\r\n}\r\nret = comedi_do_insn(dev, &insn, data);\r\n*bits = data[1] >> shift;\r\nreturn ret;\r\n}\r\nint comedi_find_subdevice_by_type(struct comedi_device *dev, int type,\r\nunsigned int subd)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret = -ENODEV;\r\ndown_read(&dev->attach_lock);\r\nif (dev->attached)\r\nfor (; subd < dev->n_subdevices; subd++) {\r\ns = &dev->subdevices[subd];\r\nif (s->type == type) {\r\nret = subd;\r\nbreak;\r\n}\r\n}\r\nup_read(&dev->attach_lock);\r\nreturn ret;\r\n}\r\nint comedi_get_n_channels(struct comedi_device *dev, unsigned int subdevice)\r\n{\r\nint n;\r\ndown_read(&dev->attach_lock);\r\nif (!dev->attached || subdevice >= dev->n_subdevices)\r\nn = 0;\r\nelse\r\nn = dev->subdevices[subdevice].n_chan;\r\nup_read(&dev->attach_lock);\r\nreturn n;\r\n}\r\nstatic int __init kcomedilib_module_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit kcomedilib_module_exit(void)\r\n{\r\n}

acpi_status acpi_db_hex_char_to_value(int hex_char, u8 *return_value)\r\n{\r\nu8 value;\r\nif (!isxdigit(hex_char)) {\r\nreturn (AE_BAD_HEX_CONSTANT);\r\n}\r\nif (hex_char <= 0x39) {\r\nvalue = (u8)(hex_char - 0x30);\r\n} else {\r\nvalue = (u8)(toupper(hex_char) - 0x37);\r\n}\r\n*return_value = value;\r\nreturn (AE_OK);\r\n}\r\nstatic acpi_status acpi_db_hex_byte_to_binary(char *hex_byte, u8 *return_value)\r\n{\r\nu8 local0;\r\nu8 local1;\r\nacpi_status status;\r\nstatus = acpi_db_hex_char_to_value(hex_byte[0], &local0);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nstatus = acpi_db_hex_char_to_value(hex_byte[1], &local1);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\n*return_value = (u8)((local0 << 4) | local1);\r\nreturn (AE_OK);\r\n}\r\nstatic acpi_status\r\nacpi_db_convert_to_buffer(char *string, union acpi_object *object)\r\n{\r\nu32 i;\r\nu32 j;\r\nu32 length;\r\nu8 *buffer;\r\nacpi_status status;\r\nfor (i = 0, length = 0; string[i];) {\r\ni += 2;\r\nlength++;\r\nwhile (string[i] && ((string[i] == ',') || (string[i] == ' '))) {\r\ni++;\r\n}\r\n}\r\nbuffer = ACPI_ALLOCATE(length);\r\nif (!buffer) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nfor (i = 0, j = 0; string[i];) {\r\nstatus = acpi_db_hex_byte_to_binary(&string[i], &buffer[j]);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_FREE(buffer);\r\nreturn (status);\r\n}\r\nj++;\r\ni += 2;\r\nwhile (string[i] && ((string[i] == ',') || (string[i] == ' '))) {\r\ni++;\r\n}\r\n}\r\nobject->type = ACPI_TYPE_BUFFER;\r\nobject->buffer.pointer = buffer;\r\nobject->buffer.length = length;\r\nreturn (AE_OK);\r\n}\r\nacpi_status acpi_db_convert_to_package(char *string, union acpi_object *object)\r\n{\r\nchar *this;\r\nchar *next;\r\nu32 i;\r\nacpi_object_type type;\r\nunion acpi_object *elements;\r\nacpi_status status;\r\nelements =\r\nACPI_ALLOCATE_ZEROED(DB_DEFAULT_PKG_ELEMENTS *\r\nsizeof(union acpi_object));\r\nthis = string;\r\nfor (i = 0; i < (DB_DEFAULT_PKG_ELEMENTS - 1); i++) {\r\nthis = acpi_db_get_next_token(this, &next, &type);\r\nif (!this) {\r\nbreak;\r\n}\r\nstatus = acpi_db_convert_to_object(type, this, &elements[i]);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_db_delete_objects(i + 1, elements);\r\nACPI_FREE(elements);\r\nreturn (status);\r\n}\r\nthis = next;\r\n}\r\nobject->type = ACPI_TYPE_PACKAGE;\r\nobject->package.count = i;\r\nobject->package.elements = elements;\r\nreturn (AE_OK);\r\n}\r\nacpi_status\r\nacpi_db_convert_to_object(acpi_object_type type,\r\nchar *string, union acpi_object *object)\r\n{\r\nacpi_status status = AE_OK;\r\nswitch (type) {\r\ncase ACPI_TYPE_STRING:\r\nobject->type = ACPI_TYPE_STRING;\r\nobject->string.pointer = string;\r\nobject->string.length = (u32)strlen(string);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nstatus = acpi_db_convert_to_buffer(string, object);\r\nbreak;\r\ncase ACPI_TYPE_PACKAGE:\r\nstatus = acpi_db_convert_to_package(string, object);\r\nbreak;\r\ndefault:\r\nobject->type = ACPI_TYPE_INTEGER;\r\nstatus = acpi_ut_strtoul64(string,\r\n(acpi_gbl_integer_byte_width |\r\nACPI_STRTOUL_BASE16),\r\n&object->integer.value);\r\nbreak;\r\n}\r\nreturn (status);\r\n}\r\nu8 *acpi_db_encode_pld_buffer(struct acpi_pld_info *pld_info)\r\n{\r\nu32 *buffer;\r\nu32 dword;\r\nbuffer = ACPI_ALLOCATE_ZEROED(ACPI_PLD_BUFFER_SIZE);\r\nif (!buffer) {\r\nreturn (NULL);\r\n}\r\ndword = 0;\r\nACPI_PLD_SET_REVISION(&dword, pld_info->revision);\r\nACPI_PLD_SET_IGNORE_COLOR(&dword, pld_info->ignore_color);\r\nACPI_PLD_SET_RED(&dword, pld_info->red);\r\nACPI_PLD_SET_GREEN(&dword, pld_info->green);\r\nACPI_PLD_SET_BLUE(&dword, pld_info->blue);\r\nACPI_MOVE_32_TO_32(&buffer[0], &dword);\r\ndword = 0;\r\nACPI_PLD_SET_WIDTH(&dword, pld_info->width);\r\nACPI_PLD_SET_HEIGHT(&dword, pld_info->height);\r\nACPI_MOVE_32_TO_32(&buffer[1], &dword);\r\ndword = 0;\r\nACPI_PLD_SET_USER_VISIBLE(&dword, pld_info->user_visible);\r\nACPI_PLD_SET_DOCK(&dword, pld_info->dock);\r\nACPI_PLD_SET_LID(&dword, pld_info->lid);\r\nACPI_PLD_SET_PANEL(&dword, pld_info->panel);\r\nACPI_PLD_SET_VERTICAL(&dword, pld_info->vertical_position);\r\nACPI_PLD_SET_HORIZONTAL(&dword, pld_info->horizontal_position);\r\nACPI_PLD_SET_SHAPE(&dword, pld_info->shape);\r\nACPI_PLD_SET_ORIENTATION(&dword, pld_info->group_orientation);\r\nACPI_PLD_SET_TOKEN(&dword, pld_info->group_token);\r\nACPI_PLD_SET_POSITION(&dword, pld_info->group_position);\r\nACPI_PLD_SET_BAY(&dword, pld_info->bay);\r\nACPI_MOVE_32_TO_32(&buffer[2], &dword);\r\ndword = 0;\r\nACPI_PLD_SET_EJECTABLE(&dword, pld_info->ejectable);\r\nACPI_PLD_SET_OSPM_EJECT(&dword, pld_info->ospm_eject_required);\r\nACPI_PLD_SET_CABINET(&dword, pld_info->cabinet_number);\r\nACPI_PLD_SET_CARD_CAGE(&dword, pld_info->card_cage_number);\r\nACPI_PLD_SET_REFERENCE(&dword, pld_info->reference);\r\nACPI_PLD_SET_ROTATION(&dword, pld_info->rotation);\r\nACPI_PLD_SET_ORDER(&dword, pld_info->order);\r\nACPI_MOVE_32_TO_32(&buffer[3], &dword);\r\nif (pld_info->revision >= 2) {\r\ndword = 0;\r\nACPI_PLD_SET_VERT_OFFSET(&dword, pld_info->vertical_offset);\r\nACPI_PLD_SET_HORIZ_OFFSET(&dword, pld_info->horizontal_offset);\r\nACPI_MOVE_32_TO_32(&buffer[4], &dword);\r\n}\r\nreturn (ACPI_CAST_PTR(u8, buffer));\r\n}\r\nvoid acpi_db_dump_pld_buffer(union acpi_object *obj_desc)\r\n{\r\nunion acpi_object *buffer_desc;\r\nstruct acpi_pld_info *pld_info;\r\nu8 *new_buffer;\r\nacpi_status status;\r\nif (obj_desc->type != ACPI_TYPE_PACKAGE) {\r\nreturn;\r\n}\r\nbuffer_desc = &obj_desc->package.elements[0];\r\nif (buffer_desc->type != ACPI_TYPE_BUFFER) {\r\nreturn;\r\n}\r\nstatus = acpi_decode_pld_buffer(buffer_desc->buffer.pointer,\r\nbuffer_desc->buffer.length, &pld_info);\r\nif (ACPI_FAILURE(status)) {\r\nreturn;\r\n}\r\nnew_buffer = acpi_db_encode_pld_buffer(pld_info);\r\nif (!new_buffer) {\r\ngoto exit;\r\n}\r\nif (memcmp(new_buffer, buffer_desc->buffer.pointer,\r\nbuffer_desc->buffer.length)) {\r\nacpi_os_printf\r\n("Converted _PLD buffer does not compare. New:\n");\r\nacpi_ut_dump_buffer(new_buffer,\r\nbuffer_desc->buffer.length, DB_BYTE_DISPLAY,\r\n0);\r\n}\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Revision", pld_info->revision);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_IgnoreColor",\r\npld_info->ignore_color);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Red", pld_info->red);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Green", pld_info->green);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Blue", pld_info->blue);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Width", pld_info->width);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Height", pld_info->height);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_UserVisible",\r\npld_info->user_visible);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Dock", pld_info->dock);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Lid", pld_info->lid);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Panel", pld_info->panel);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_VerticalPosition",\r\npld_info->vertical_position);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_HorizontalPosition",\r\npld_info->horizontal_position);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Shape", pld_info->shape);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_GroupOrientation",\r\npld_info->group_orientation);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_GroupToken",\r\npld_info->group_token);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_GroupPosition",\r\npld_info->group_position);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Bay", pld_info->bay);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Ejectable", pld_info->ejectable);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_EjectRequired",\r\npld_info->ospm_eject_required);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_CabinetNumber",\r\npld_info->cabinet_number);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_CardCageNumber",\r\npld_info->card_cage_number);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Reference", pld_info->reference);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Rotation", pld_info->rotation);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_Order", pld_info->order);\r\nif (buffer_desc->buffer.length > 16) {\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_VerticalOffset",\r\npld_info->vertical_offset);\r\nacpi_os_printf(ACPI_PLD_OUTPUT, "PLD_HorizontalOffset",\r\npld_info->horizontal_offset);\r\n}\r\nACPI_FREE(new_buffer);\r\nexit:\r\nACPI_FREE(pld_info);\r\n}

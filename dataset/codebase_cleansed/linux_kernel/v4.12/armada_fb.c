static void armada_fb_destroy(struct drm_framebuffer *fb)\r\n{\r\nstruct armada_framebuffer *dfb = drm_fb_to_armada_fb(fb);\r\ndrm_framebuffer_cleanup(&dfb->fb);\r\ndrm_gem_object_unreference_unlocked(&dfb->obj->obj);\r\nkfree(dfb);\r\n}\r\nstatic int armada_fb_create_handle(struct drm_framebuffer *fb,\r\nstruct drm_file *dfile, unsigned int *handle)\r\n{\r\nstruct armada_framebuffer *dfb = drm_fb_to_armada_fb(fb);\r\nreturn drm_gem_handle_create(dfile, &dfb->obj->obj, handle);\r\n}\r\nstruct armada_framebuffer *armada_framebuffer_create(struct drm_device *dev,\r\nconst struct drm_mode_fb_cmd2 *mode, struct armada_gem_object *obj)\r\n{\r\nstruct armada_framebuffer *dfb;\r\nuint8_t format, config;\r\nint ret;\r\nswitch (mode->pixel_format) {\r\n#define FMT(drm, fmt, mod) \\r\ncase DRM_FORMAT_##drm: \\r\nformat = CFG_##fmt; \\r\nconfig = mod; \\r\nbreak\r\nFMT(RGB565, 565, CFG_SWAPRB);\r\nFMT(BGR565, 565, 0);\r\nFMT(ARGB1555, 1555, CFG_SWAPRB);\r\nFMT(ABGR1555, 1555, 0);\r\nFMT(RGB888, 888PACK, CFG_SWAPRB);\r\nFMT(BGR888, 888PACK, 0);\r\nFMT(XRGB8888, X888, CFG_SWAPRB);\r\nFMT(XBGR8888, X888, 0);\r\nFMT(ARGB8888, 8888, CFG_SWAPRB);\r\nFMT(ABGR8888, 8888, 0);\r\nFMT(YUYV, 422PACK, CFG_YUV2RGB | CFG_SWAPYU | CFG_SWAPUV);\r\nFMT(UYVY, 422PACK, CFG_YUV2RGB);\r\nFMT(VYUY, 422PACK, CFG_YUV2RGB | CFG_SWAPUV);\r\nFMT(YVYU, 422PACK, CFG_YUV2RGB | CFG_SWAPYU);\r\nFMT(YUV422, 422, CFG_YUV2RGB);\r\nFMT(YVU422, 422, CFG_YUV2RGB | CFG_SWAPUV);\r\nFMT(YUV420, 420, CFG_YUV2RGB);\r\nFMT(YVU420, 420, CFG_YUV2RGB | CFG_SWAPUV);\r\nFMT(C8, PSEUDO8, 0);\r\n#undef FMT\r\ndefault:\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ndfb = kzalloc(sizeof(*dfb), GFP_KERNEL);\r\nif (!dfb) {\r\nDRM_ERROR("failed to allocate Armada fb object\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ndfb->fmt = format;\r\ndfb->mod = config;\r\ndfb->obj = obj;\r\ndrm_helper_mode_fill_fb_struct(dev, &dfb->fb, mode);\r\nret = drm_framebuffer_init(dev, &dfb->fb, &armada_fb_funcs);\r\nif (ret) {\r\nkfree(dfb);\r\nreturn ERR_PTR(ret);\r\n}\r\ndrm_gem_object_reference(&obj->obj);\r\nreturn dfb;\r\n}\r\nstatic struct drm_framebuffer *armada_fb_create(struct drm_device *dev,\r\nstruct drm_file *dfile, const struct drm_mode_fb_cmd2 *mode)\r\n{\r\nstruct armada_gem_object *obj;\r\nstruct armada_framebuffer *dfb;\r\nint ret;\r\nDRM_DEBUG_DRIVER("w%u h%u pf%08x f%u p%u,%u,%u\n",\r\nmode->width, mode->height, mode->pixel_format,\r\nmode->flags, mode->pitches[0], mode->pitches[1],\r\nmode->pitches[2]);\r\nif (drm_format_num_planes(mode->pixel_format) > 1 &&\r\n(mode->handles[0] != mode->handles[1] ||\r\nmode->handles[0] != mode->handles[2])) {\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nobj = armada_gem_object_lookup(dfile, mode->handles[0]);\r\nif (!obj) {\r\nret = -ENOENT;\r\ngoto err;\r\n}\r\nif (obj->obj.import_attach && !obj->sgt) {\r\nret = armada_gem_map_import(obj);\r\nif (ret)\r\ngoto err_unref;\r\n}\r\nif (obj->dev_addr == DMA_ERROR_CODE) {\r\nret = -EINVAL;\r\ngoto err_unref;\r\n}\r\ndfb = armada_framebuffer_create(dev, mode, obj);\r\nif (IS_ERR(dfb)) {\r\nret = PTR_ERR(dfb);\r\ngoto err;\r\n}\r\ndrm_gem_object_unreference_unlocked(&obj->obj);\r\nreturn &dfb->fb;\r\nerr_unref:\r\ndrm_gem_object_unreference_unlocked(&obj->obj);\r\nerr:\r\nDRM_ERROR("failed to initialize framebuffer: %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void armada_output_poll_changed(struct drm_device *dev)\r\n{\r\nstruct armada_private *priv = dev->dev_private;\r\nstruct drm_fb_helper *fbh = priv->fbdev;\r\nif (fbh)\r\ndrm_fb_helper_hotplug_event(fbh);\r\n}

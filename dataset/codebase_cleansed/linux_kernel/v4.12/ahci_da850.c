static void da850_sata_init(struct device *dev, void __iomem *pwrdn_reg,\r\nvoid __iomem *ahci_base, u32 mpy)\r\n{\r\nunsigned int val;\r\nval = readl(pwrdn_reg);\r\nval &= ~BIT(0);\r\nwritel(val, pwrdn_reg);\r\nval = SATA_PHY_MPY(mpy) | SATA_PHY_LOS(1) | SATA_PHY_RXCDR(4) |\r\nSATA_PHY_RXEQ(1) | SATA_PHY_TXSWING(3) | SATA_PHY_ENPLL(1);\r\nwritel(val, ahci_base + SATA_P0PHYCR_REG);\r\n}\r\nstatic u32 ahci_da850_calculate_mpy(unsigned long refclk_rate)\r\n{\r\nu32 pll_output = 1500000000, needed;\r\nWARN((refclk_rate % 10) != 0, "refclk must be divisible by 10");\r\nneeded = pll_output / (refclk_rate / 10);\r\nswitch (needed) {\r\ncase 50:\r\nreturn 0x1;\r\ncase 60:\r\nreturn 0x2;\r\ncase 80:\r\nreturn 0x4;\r\ncase 100:\r\nreturn 0x5;\r\ncase 120:\r\nreturn 0x6;\r\ncase 125:\r\nreturn 0x7;\r\ncase 150:\r\nreturn 0x8;\r\ncase 200:\r\nreturn 0x9;\r\ncase 250:\r\nreturn 0xa;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int ahci_da850_softreset(struct ata_link *link,\r\nunsigned int *class, unsigned long deadline)\r\n{\r\nint pmp, ret;\r\npmp = sata_srst_pmp(link);\r\nret = ahci_do_softreset(link, class, pmp, deadline, ahci_check_ready);\r\nif (pmp && ret == -EBUSY)\r\nreturn ahci_do_softreset(link, class, 0,\r\ndeadline, ahci_check_ready);\r\nreturn ret;\r\n}\r\nstatic int ahci_da850_hardreset(struct ata_link *link,\r\nunsigned int *class, unsigned long deadline)\r\n{\r\nint ret, retry = HARDRESET_RETRIES;\r\nbool online;\r\ndo {\r\nret = ahci_do_hardreset(link, class, deadline, &online);\r\nif (online)\r\nreturn ret;\r\n} while (retry--);\r\nreturn ret;\r\n}\r\nstatic int ahci_da850_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ahci_host_priv *hpriv;\r\nvoid __iomem *pwrdn_reg;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nu32 mpy;\r\nint rc;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nif (!hpriv->clks[0]) {\r\nclk = clk_get(dev, "fck");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nhpriv->clks[0] = clk;\r\n}\r\nif (!hpriv->clks[1]) {\r\nclk = clk_get(dev, "refclk");\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "unable to obtain the reference clock");\r\nreturn -ENODEV;\r\n}\r\nhpriv->clks[1] = clk;\r\n}\r\nmpy = ahci_da850_calculate_mpy(clk_get_rate(hpriv->clks[1]));\r\nif (mpy == 0) {\r\ndev_err(dev, "invalid REFCLK multiplier value: 0x%x", mpy);\r\nreturn -EINVAL;\r\n}\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res)\r\ngoto disable_resources;\r\npwrdn_reg = devm_ioremap(dev, res->start, resource_size(res));\r\nif (!pwrdn_reg)\r\ngoto disable_resources;\r\nda850_sata_init(dev, pwrdn_reg, hpriv->mmio, mpy);\r\nrc = ahci_platform_init_host(pdev, hpriv, &ahci_da850_port_info,\r\n&ahci_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

static int poll_interval_param_set(const char *val, const struct kernel_param *kp)\r\n{\r\nstruct bq27xxx_device_info *di;\r\nunsigned int prev_val = *(unsigned int *) kp->arg;\r\nint ret;\r\nret = param_set_uint(val, kp);\r\nif (ret < 0 || prev_val == *(unsigned int *) kp->arg)\r\nreturn ret;\r\nmutex_lock(&bq27xxx_list_lock);\r\nlist_for_each_entry(di, &bq27xxx_battery_devices, list) {\r\ncancel_delayed_work_sync(&di->work);\r\nschedule_delayed_work(&di->work, 0);\r\n}\r\nmutex_unlock(&bq27xxx_list_lock);\r\nreturn ret;\r\n}\r\nstatic inline int bq27xxx_read(struct bq27xxx_device_info *di, int reg_index,\r\nbool single)\r\n{\r\nif (!di || di->regs[reg_index] == INVALID_REG_ADDR)\r\nreturn -EINVAL;\r\nreturn di->bus.read(di, di->regs[reg_index], single);\r\n}\r\nstatic int bq27xxx_battery_read_soc(struct bq27xxx_device_info *di)\r\n{\r\nint soc;\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\nsoc = bq27xxx_read(di, BQ27XXX_REG_SOC, true);\r\nelse\r\nsoc = bq27xxx_read(di, BQ27XXX_REG_SOC, false);\r\nif (soc < 0)\r\ndev_dbg(di->dev, "error reading State-of-Charge\n");\r\nreturn soc;\r\n}\r\nstatic int bq27xxx_battery_read_charge(struct bq27xxx_device_info *di, u8 reg)\r\n{\r\nint charge;\r\ncharge = bq27xxx_read(di, reg, false);\r\nif (charge < 0) {\r\ndev_dbg(di->dev, "error reading charge register %02x: %d\n",\r\nreg, charge);\r\nreturn charge;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\ncharge *= BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\r\nelse\r\ncharge *= 1000;\r\nreturn charge;\r\n}\r\nstatic inline int bq27xxx_battery_read_nac(struct bq27xxx_device_info *di)\r\n{\r\nint flags;\r\nif (di->chip == BQ27000 || di->chip == BQ27010) {\r\nflags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, true);\r\nif (flags >= 0 && (flags & BQ27000_FLAG_CI))\r\nreturn -ENODATA;\r\n}\r\nreturn bq27xxx_battery_read_charge(di, BQ27XXX_REG_NAC);\r\n}\r\nstatic inline int bq27xxx_battery_read_fcc(struct bq27xxx_device_info *di)\r\n{\r\nreturn bq27xxx_battery_read_charge(di, BQ27XXX_REG_FCC);\r\n}\r\nstatic int bq27xxx_battery_read_dcap(struct bq27xxx_device_info *di)\r\n{\r\nint dcap;\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\ndcap = bq27xxx_read(di, BQ27XXX_REG_DCAP, true);\r\nelse\r\ndcap = bq27xxx_read(di, BQ27XXX_REG_DCAP, false);\r\nif (dcap < 0) {\r\ndev_dbg(di->dev, "error reading initial last measured discharge\n");\r\nreturn dcap;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\ndcap = (dcap << 8) * BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\r\nelse\r\ndcap *= 1000;\r\nreturn dcap;\r\n}\r\nstatic int bq27xxx_battery_read_energy(struct bq27xxx_device_info *di)\r\n{\r\nint ae;\r\nae = bq27xxx_read(di, BQ27XXX_REG_AE, false);\r\nif (ae < 0) {\r\ndev_dbg(di->dev, "error reading available energy\n");\r\nreturn ae;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\nae *= BQ27XXX_POWER_CONSTANT / BQ27XXX_RS;\r\nelse\r\nae *= 1000;\r\nreturn ae;\r\n}\r\nstatic int bq27xxx_battery_read_temperature(struct bq27xxx_device_info *di)\r\n{\r\nint temp;\r\ntemp = bq27xxx_read(di, BQ27XXX_REG_TEMP, false);\r\nif (temp < 0) {\r\ndev_err(di->dev, "error reading temperature\n");\r\nreturn temp;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\ntemp = 5 * temp / 2;\r\nreturn temp;\r\n}\r\nstatic int bq27xxx_battery_read_cyct(struct bq27xxx_device_info *di)\r\n{\r\nint cyct;\r\ncyct = bq27xxx_read(di, BQ27XXX_REG_CYCT, false);\r\nif (cyct < 0)\r\ndev_err(di->dev, "error reading cycle count total\n");\r\nreturn cyct;\r\n}\r\nstatic int bq27xxx_battery_read_time(struct bq27xxx_device_info *di, u8 reg)\r\n{\r\nint tval;\r\ntval = bq27xxx_read(di, reg, false);\r\nif (tval < 0) {\r\ndev_dbg(di->dev, "error reading time register %02x: %d\n",\r\nreg, tval);\r\nreturn tval;\r\n}\r\nif (tval == 65535)\r\nreturn -ENODATA;\r\nreturn tval * 60;\r\n}\r\nstatic int bq27xxx_battery_read_pwr_avg(struct bq27xxx_device_info *di)\r\n{\r\nint tval;\r\ntval = bq27xxx_read(di, BQ27XXX_REG_AP, false);\r\nif (tval < 0) {\r\ndev_err(di->dev, "error reading average power register %02x: %d\n",\r\nBQ27XXX_REG_AP, tval);\r\nreturn tval;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\nreturn (tval * BQ27XXX_POWER_CONSTANT) / BQ27XXX_RS;\r\nelse\r\nreturn tval;\r\n}\r\nstatic bool bq27xxx_battery_overtemp(struct bq27xxx_device_info *di, u16 flags)\r\n{\r\nswitch (di->chip) {\r\ncase BQ2750X:\r\ncase BQ2751X:\r\ncase BQ27500:\r\ncase BQ27510G1:\r\ncase BQ27510G2:\r\ncase BQ27510G3:\r\ncase BQ27520G1:\r\ncase BQ27520G2:\r\ncase BQ27520G3:\r\ncase BQ27520G4:\r\ncase BQ27541:\r\ncase BQ27545:\r\nreturn flags & (BQ27XXX_FLAG_OTC | BQ27XXX_FLAG_OTD);\r\ncase BQ27530:\r\ncase BQ27421:\r\nreturn flags & BQ27XXX_FLAG_OT;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool bq27xxx_battery_undertemp(struct bq27xxx_device_info *di, u16 flags)\r\n{\r\nif (di->chip == BQ27530 || di->chip == BQ27421)\r\nreturn flags & BQ27XXX_FLAG_UT;\r\nreturn false;\r\n}\r\nstatic bool bq27xxx_battery_dead(struct bq27xxx_device_info *di, u16 flags)\r\n{\r\nif (di->chip == BQ27000 || di->chip == BQ27010)\r\nreturn flags & (BQ27000_FLAG_EDV1 | BQ27000_FLAG_EDVF);\r\nelse\r\nreturn flags & (BQ27XXX_FLAG_SOC1 | BQ27XXX_FLAG_SOCF);\r\n}\r\nstatic int bq27xxx_battery_read_health(struct bq27xxx_device_info *di)\r\n{\r\nint flags;\r\nbool has_singe_flag = di->chip == BQ27000 || di->chip == BQ27010;\r\nflags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, has_singe_flag);\r\nif (flags < 0) {\r\ndev_err(di->dev, "error reading flag register:%d\n", flags);\r\nreturn flags;\r\n}\r\nif (unlikely(bq27xxx_battery_overtemp(di, flags)))\r\nreturn POWER_SUPPLY_HEALTH_OVERHEAT;\r\nif (unlikely(bq27xxx_battery_undertemp(di, flags)))\r\nreturn POWER_SUPPLY_HEALTH_COLD;\r\nif (unlikely(bq27xxx_battery_dead(di, flags)))\r\nreturn POWER_SUPPLY_HEALTH_DEAD;\r\nreturn POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\nvoid bq27xxx_battery_update(struct bq27xxx_device_info *di)\r\n{\r\nstruct bq27xxx_reg_cache cache = {0, };\r\nbool has_ci_flag = di->chip == BQ27000 || di->chip == BQ27010;\r\nbool has_singe_flag = di->chip == BQ27000 || di->chip == BQ27010;\r\ncache.flags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, has_singe_flag);\r\nif ((cache.flags & 0xff) == 0xff)\r\ncache.flags = -1;\r\nif (cache.flags >= 0) {\r\ncache.temperature = bq27xxx_battery_read_temperature(di);\r\nif (has_ci_flag && (cache.flags & BQ27000_FLAG_CI)) {\r\ndev_info_once(di->dev, "battery is not calibrated! ignoring capacity values\n");\r\ncache.capacity = -ENODATA;\r\ncache.energy = -ENODATA;\r\ncache.time_to_empty = -ENODATA;\r\ncache.time_to_empty_avg = -ENODATA;\r\ncache.time_to_full = -ENODATA;\r\ncache.charge_full = -ENODATA;\r\ncache.health = -ENODATA;\r\n} else {\r\nif (di->regs[BQ27XXX_REG_TTE] != INVALID_REG_ADDR)\r\ncache.time_to_empty = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTE);\r\nif (di->regs[BQ27XXX_REG_TTECP] != INVALID_REG_ADDR)\r\ncache.time_to_empty_avg = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTECP);\r\nif (di->regs[BQ27XXX_REG_TTF] != INVALID_REG_ADDR)\r\ncache.time_to_full = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTF);\r\ncache.charge_full = bq27xxx_battery_read_fcc(di);\r\ncache.capacity = bq27xxx_battery_read_soc(di);\r\nif (di->regs[BQ27XXX_REG_AE] != INVALID_REG_ADDR)\r\ncache.energy = bq27xxx_battery_read_energy(di);\r\ncache.health = bq27xxx_battery_read_health(di);\r\n}\r\nif (di->regs[BQ27XXX_REG_CYCT] != INVALID_REG_ADDR)\r\ncache.cycle_count = bq27xxx_battery_read_cyct(di);\r\nif (di->regs[BQ27XXX_REG_AP] != INVALID_REG_ADDR)\r\ncache.power_avg = bq27xxx_battery_read_pwr_avg(di);\r\nif (di->charge_design_full <= 0)\r\ndi->charge_design_full = bq27xxx_battery_read_dcap(di);\r\n}\r\nif (di->cache.capacity != cache.capacity)\r\npower_supply_changed(di->bat);\r\nif (memcmp(&di->cache, &cache, sizeof(cache)) != 0)\r\ndi->cache = cache;\r\ndi->last_update = jiffies;\r\n}\r\nstatic void bq27xxx_battery_poll(struct work_struct *work)\r\n{\r\nstruct bq27xxx_device_info *di =\r\ncontainer_of(work, struct bq27xxx_device_info,\r\nwork.work);\r\nbq27xxx_battery_update(di);\r\nif (poll_interval > 0)\r\nschedule_delayed_work(&di->work, poll_interval * HZ);\r\n}\r\nstatic int bq27xxx_battery_current(struct bq27xxx_device_info *di,\r\nunion power_supply_propval *val)\r\n{\r\nint curr;\r\nint flags;\r\ncurr = bq27xxx_read(di, BQ27XXX_REG_AI, false);\r\nif (curr < 0) {\r\ndev_err(di->dev, "error reading current\n");\r\nreturn curr;\r\n}\r\nif (di->chip == BQ27000 || di->chip == BQ27010) {\r\nflags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, true);\r\nif (flags & BQ27000_FLAG_CHGS) {\r\ndev_dbg(di->dev, "negative current!\n");\r\ncurr = -curr;\r\n}\r\nval->intval = curr * BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\r\n} else {\r\nval->intval = (int)((s16)curr) * 1000;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bq27xxx_battery_status(struct bq27xxx_device_info *di,\r\nunion power_supply_propval *val)\r\n{\r\nint status;\r\nif (di->chip == BQ27000 || di->chip == BQ27010) {\r\nif (di->cache.flags & BQ27000_FLAG_FC)\r\nstatus = POWER_SUPPLY_STATUS_FULL;\r\nelse if (di->cache.flags & BQ27000_FLAG_CHGS)\r\nstatus = POWER_SUPPLY_STATUS_CHARGING;\r\nelse if (power_supply_am_i_supplied(di->bat))\r\nstatus = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nelse\r\nstatus = POWER_SUPPLY_STATUS_DISCHARGING;\r\n} else {\r\nif (di->cache.flags & BQ27XXX_FLAG_FC)\r\nstatus = POWER_SUPPLY_STATUS_FULL;\r\nelse if (di->cache.flags & BQ27XXX_FLAG_DSC)\r\nstatus = POWER_SUPPLY_STATUS_DISCHARGING;\r\nelse\r\nstatus = POWER_SUPPLY_STATUS_CHARGING;\r\n}\r\nval->intval = status;\r\nreturn 0;\r\n}\r\nstatic int bq27xxx_battery_capacity_level(struct bq27xxx_device_info *di,\r\nunion power_supply_propval *val)\r\n{\r\nint level;\r\nif (di->chip == BQ27000 || di->chip == BQ27010) {\r\nif (di->cache.flags & BQ27000_FLAG_FC)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\r\nelse if (di->cache.flags & BQ27000_FLAG_EDV1)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\r\nelse if (di->cache.flags & BQ27000_FLAG_EDVF)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\r\nelse\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\r\n} else {\r\nif (di->cache.flags & BQ27XXX_FLAG_FC)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\r\nelse if (di->cache.flags & BQ27XXX_FLAG_SOC1)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\r\nelse if (di->cache.flags & BQ27XXX_FLAG_SOCF)\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\r\nelse\r\nlevel = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\r\n}\r\nval->intval = level;\r\nreturn 0;\r\n}\r\nstatic int bq27xxx_battery_voltage(struct bq27xxx_device_info *di,\r\nunion power_supply_propval *val)\r\n{\r\nint volt;\r\nvolt = bq27xxx_read(di, BQ27XXX_REG_VOLT, false);\r\nif (volt < 0) {\r\ndev_err(di->dev, "error reading voltage\n");\r\nreturn volt;\r\n}\r\nval->intval = volt * 1000;\r\nreturn 0;\r\n}\r\nstatic int bq27xxx_simple_value(int value,\r\nunion power_supply_propval *val)\r\n{\r\nif (value < 0)\r\nreturn value;\r\nval->intval = value;\r\nreturn 0;\r\n}\r\nstatic int bq27xxx_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nint ret = 0;\r\nstruct bq27xxx_device_info *di = power_supply_get_drvdata(psy);\r\nmutex_lock(&di->lock);\r\nif (time_is_before_jiffies(di->last_update + 5 * HZ)) {\r\ncancel_delayed_work_sync(&di->work);\r\nbq27xxx_battery_poll(&di->work.work);\r\n}\r\nmutex_unlock(&di->lock);\r\nif (psp != POWER_SUPPLY_PROP_PRESENT && di->cache.flags < 0)\r\nreturn -ENODEV;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = bq27xxx_battery_status(di, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = bq27xxx_battery_voltage(di, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = di->cache.flags < 0 ? 0 : 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = bq27xxx_battery_current(di, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nret = bq27xxx_simple_value(di->cache.capacity, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\r\nret = bq27xxx_battery_capacity_level(di, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nret = bq27xxx_simple_value(di->cache.temperature, val);\r\nif (ret == 0)\r\nval->intval -= 2731;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW:\r\nret = bq27xxx_simple_value(di->cache.time_to_empty, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG:\r\nret = bq27xxx_simple_value(di->cache.time_to_empty_avg, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_FULL_NOW:\r\nret = bq27xxx_simple_value(di->cache.time_to_full, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nret = bq27xxx_simple_value(bq27xxx_battery_read_nac(di), val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nret = bq27xxx_simple_value(di->cache.charge_full, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\r\nret = bq27xxx_simple_value(di->charge_design_full, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CYCLE_COUNT:\r\nret = bq27xxx_simple_value(di->cache.cycle_count, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ENERGY_NOW:\r\nret = bq27xxx_simple_value(di->cache.energy, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_POWER_AVG:\r\nret = bq27xxx_simple_value(di->cache.power_avg, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = bq27xxx_simple_value(di->cache.health, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = BQ27XXX_MANUFACTURER;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic void bq27xxx_external_power_changed(struct power_supply *psy)\r\n{\r\nstruct bq27xxx_device_info *di = power_supply_get_drvdata(psy);\r\ncancel_delayed_work_sync(&di->work);\r\nschedule_delayed_work(&di->work, 0);\r\n}\r\nint bq27xxx_battery_setup(struct bq27xxx_device_info *di)\r\n{\r\nstruct power_supply_desc *psy_desc;\r\nstruct power_supply_config psy_cfg = { .drv_data = di, };\r\nINIT_DELAYED_WORK(&di->work, bq27xxx_battery_poll);\r\nmutex_init(&di->lock);\r\ndi->regs = bq27xxx_regs[di->chip];\r\npsy_desc = devm_kzalloc(di->dev, sizeof(*psy_desc), GFP_KERNEL);\r\nif (!psy_desc)\r\nreturn -ENOMEM;\r\npsy_desc->name = di->name;\r\npsy_desc->type = POWER_SUPPLY_TYPE_BATTERY;\r\npsy_desc->properties = bq27xxx_battery_props[di->chip].props;\r\npsy_desc->num_properties = bq27xxx_battery_props[di->chip].size;\r\npsy_desc->get_property = bq27xxx_battery_get_property;\r\npsy_desc->external_power_changed = bq27xxx_external_power_changed;\r\ndi->bat = power_supply_register_no_ws(di->dev, psy_desc, &psy_cfg);\r\nif (IS_ERR(di->bat)) {\r\ndev_err(di->dev, "failed to register battery\n");\r\nreturn PTR_ERR(di->bat);\r\n}\r\ndev_info(di->dev, "support ver. %s enabled\n", DRIVER_VERSION);\r\nbq27xxx_battery_update(di);\r\nmutex_lock(&bq27xxx_list_lock);\r\nlist_add(&di->list, &bq27xxx_battery_devices);\r\nmutex_unlock(&bq27xxx_list_lock);\r\nreturn 0;\r\n}\r\nvoid bq27xxx_battery_teardown(struct bq27xxx_device_info *di)\r\n{\r\npoll_interval = 0;\r\ncancel_delayed_work_sync(&di->work);\r\npower_supply_unregister(di->bat);\r\nmutex_lock(&bq27xxx_list_lock);\r\nlist_del(&di->list);\r\nmutex_unlock(&bq27xxx_list_lock);\r\nmutex_destroy(&di->lock);\r\n}\r\nstatic int bq27xxx_battery_platform_read(struct bq27xxx_device_info *di, u8 reg,\r\nbool single)\r\n{\r\nstruct device *dev = di->dev;\r\nstruct bq27xxx_platform_data *pdata = dev->platform_data;\r\nunsigned int timeout = 3;\r\nint upper, lower;\r\nint temp;\r\nif (!single) {\r\nupper = pdata->read(dev, reg + 1);\r\ndo {\r\ntemp = upper;\r\nif (upper < 0)\r\nreturn upper;\r\nlower = pdata->read(dev, reg);\r\nif (lower < 0)\r\nreturn lower;\r\nupper = pdata->read(dev, reg + 1);\r\n} while (temp != upper && --timeout);\r\nif (timeout == 0)\r\nreturn -EIO;\r\nreturn (upper << 8) | lower;\r\n}\r\nreturn pdata->read(dev, reg);\r\n}\r\nstatic int bq27xxx_battery_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct bq27xxx_device_info *di;\r\nstruct bq27xxx_platform_data *pdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform_data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdata->read) {\r\ndev_err(&pdev->dev, "no hdq read callback supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdata->chip) {\r\ndev_err(&pdev->dev, "no device supplied\n");\r\nreturn -EINVAL;\r\n}\r\ndi = devm_kzalloc(&pdev->dev, sizeof(*di), GFP_KERNEL);\r\nif (!di)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, di);\r\ndi->dev = &pdev->dev;\r\ndi->chip = pdata->chip;\r\ndi->name = pdata->name ?: dev_name(&pdev->dev);\r\ndi->bus.read = bq27xxx_battery_platform_read;\r\nreturn bq27xxx_battery_setup(di);\r\n}\r\nstatic int bq27xxx_battery_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct bq27xxx_device_info *di = platform_get_drvdata(pdev);\r\nbq27xxx_battery_teardown(di);\r\nreturn 0;\r\n}

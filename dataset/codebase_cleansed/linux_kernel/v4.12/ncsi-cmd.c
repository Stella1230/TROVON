u32 ncsi_calculate_checksum(unsigned char *data, int len)\r\n{\r\nu32 checksum = 0;\r\nint i;\r\nfor (i = 0; i < len; i += 2)\r\nchecksum += (((u32)data[i] << 8) | data[i + 1]);\r\nchecksum = (~checksum + 1);\r\nreturn checksum;\r\n}\r\nstatic void ncsi_cmd_build_header(struct ncsi_pkt_hdr *h,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nu32 checksum;\r\n__be32 *pchecksum;\r\nh->mc_id = 0;\r\nh->revision = NCSI_PKT_REVISION;\r\nh->reserved = 0;\r\nh->id = nca->id;\r\nh->type = nca->type;\r\nh->channel = NCSI_TO_CHANNEL(nca->package,\r\nnca->channel);\r\nh->length = htons(nca->payload);\r\nh->reserved1[0] = 0;\r\nh->reserved1[1] = 0;\r\nchecksum = ncsi_calculate_checksum((unsigned char *)h,\r\nsizeof(*h) + nca->payload);\r\npchecksum = (__be32 *)((void *)h + sizeof(struct ncsi_pkt_hdr) +\r\nnca->payload);\r\n*pchecksum = htonl(checksum);\r\n}\r\nstatic int ncsi_cmd_handler_default(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_pkt *cmd;\r\ncmd = (struct ncsi_cmd_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_sp(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_sp_pkt *cmd;\r\ncmd = (struct ncsi_cmd_sp_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->hw_arbitration = nca->bytes[0];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_dc(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_dc_pkt *cmd;\r\ncmd = (struct ncsi_cmd_dc_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->ald = nca->bytes[0];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_rc(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_rc_pkt *cmd;\r\ncmd = (struct ncsi_cmd_rc_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_ae(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_ae_pkt *cmd;\r\ncmd = (struct ncsi_cmd_ae_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mc_id = nca->bytes[0];\r\ncmd->mode = htonl(nca->dwords[1]);\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_sl(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_sl_pkt *cmd;\r\ncmd = (struct ncsi_cmd_sl_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mode = htonl(nca->dwords[0]);\r\ncmd->oem_mode = htonl(nca->dwords[1]);\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_svf(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_svf_pkt *cmd;\r\ncmd = (struct ncsi_cmd_svf_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->vlan = htons(nca->words[0]);\r\ncmd->index = nca->bytes[2];\r\ncmd->enable = nca->bytes[3];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_ev(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_ev_pkt *cmd;\r\ncmd = (struct ncsi_cmd_ev_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mode = nca->bytes[0];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_sma(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_sma_pkt *cmd;\r\nint i;\r\ncmd = (struct ncsi_cmd_sma_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\nfor (i = 0; i < 6; i++)\r\ncmd->mac[i] = nca->bytes[i];\r\ncmd->index = nca->bytes[6];\r\ncmd->at_e = nca->bytes[7];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_ebf(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_ebf_pkt *cmd;\r\ncmd = (struct ncsi_cmd_ebf_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mode = htonl(nca->dwords[0]);\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_egmf(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_egmf_pkt *cmd;\r\ncmd = (struct ncsi_cmd_egmf_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mode = htonl(nca->dwords[0]);\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic int ncsi_cmd_handler_snfc(struct sk_buff *skb,\r\nstruct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_cmd_snfc_pkt *cmd;\r\ncmd = (struct ncsi_cmd_snfc_pkt *)skb_put(skb, sizeof(*cmd));\r\nmemset(cmd, 0, sizeof(*cmd));\r\ncmd->mode = nca->bytes[0];\r\nncsi_cmd_build_header(&cmd->cmd.common, nca);\r\nreturn 0;\r\n}\r\nstatic struct ncsi_request *ncsi_alloc_command(struct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_dev_priv *ndp = nca->ndp;\r\nstruct ncsi_dev *nd = &ndp->ndev;\r\nstruct net_device *dev = nd->dev;\r\nint hlen = LL_RESERVED_SPACE(dev);\r\nint tlen = dev->needed_tailroom;\r\nint len = hlen + tlen;\r\nstruct sk_buff *skb;\r\nstruct ncsi_request *nr;\r\nnr = ncsi_alloc_request(ndp, nca->req_flags);\r\nif (!nr)\r\nreturn NULL;\r\nlen += sizeof(struct ncsi_cmd_pkt_hdr) + 4;\r\nif (nca->payload < 26)\r\nlen += 26;\r\nelse\r\nlen += nca->payload;\r\nskb = alloc_skb(len, GFP_ATOMIC);\r\nif (!skb) {\r\nncsi_free_request(nr);\r\nreturn NULL;\r\n}\r\nnr->cmd = skb;\r\nskb_reserve(skb, hlen);\r\nskb_reset_network_header(skb);\r\nskb->dev = dev;\r\nskb->protocol = htons(ETH_P_NCSI);\r\nreturn nr;\r\n}\r\nint ncsi_xmit_cmd(struct ncsi_cmd_arg *nca)\r\n{\r\nstruct ncsi_request *nr;\r\nstruct ethhdr *eh;\r\nstruct ncsi_cmd_handler *nch = NULL;\r\nint i, ret;\r\nfor (i = 0; i < ARRAY_SIZE(ncsi_cmd_handlers); i++) {\r\nif (ncsi_cmd_handlers[i].type == nca->type) {\r\nif (ncsi_cmd_handlers[i].handler)\r\nnch = &ncsi_cmd_handlers[i];\r\nelse\r\nnch = NULL;\r\nbreak;\r\n}\r\n}\r\nif (!nch) {\r\nnetdev_err(nca->ndp->ndev.dev,\r\n"Cannot send packet with type 0x%02x\n", nca->type);\r\nreturn -ENOENT;\r\n}\r\nnca->payload = nch->payload;\r\nnr = ncsi_alloc_command(nca);\r\nif (!nr)\r\nreturn -ENOMEM;\r\nnca->id = nr->id;\r\nret = nch->handler(nr->cmd, nca);\r\nif (ret) {\r\nncsi_free_request(nr);\r\nreturn ret;\r\n}\r\neh = (struct ethhdr *)skb_push(nr->cmd, sizeof(*eh));\r\neh->h_proto = htons(ETH_P_NCSI);\r\neth_broadcast_addr(eh->h_dest);\r\neth_broadcast_addr(eh->h_source);\r\nnr->enabled = true;\r\nmod_timer(&nr->timer, jiffies + 1 * HZ);\r\nskb_get(nr->cmd);\r\nret = dev_queue_xmit(nr->cmd);\r\nif (ret < 0) {\r\nncsi_free_request(nr);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

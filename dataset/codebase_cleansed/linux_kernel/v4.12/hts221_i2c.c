static int hts221_i2c_read(struct device *dev, u8 addr, int len, u8 *data)\r\n{\r\nstruct i2c_msg msg[2];\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nif (len > 1)\r\naddr |= I2C_AUTO_INCREMENT;\r\nmsg[0].addr = client->addr;\r\nmsg[0].flags = client->flags;\r\nmsg[0].len = 1;\r\nmsg[0].buf = &addr;\r\nmsg[1].addr = client->addr;\r\nmsg[1].flags = client->flags | I2C_M_RD;\r\nmsg[1].len = len;\r\nmsg[1].buf = data;\r\nreturn i2c_transfer(client->adapter, msg, 2);\r\n}\r\nstatic int hts221_i2c_write(struct device *dev, u8 addr, int len, u8 *data)\r\n{\r\nu8 send[len + 1];\r\nstruct i2c_msg msg;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nif (len > 1)\r\naddr |= I2C_AUTO_INCREMENT;\r\nsend[0] = addr;\r\nmemcpy(&send[1], data, len * sizeof(u8));\r\nmsg.addr = client->addr;\r\nmsg.flags = client->flags;\r\nmsg.len = len + 1;\r\nmsg.buf = send;\r\nreturn i2c_transfer(client->adapter, &msg, 1);\r\n}\r\nstatic int hts221_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct hts221_hw *hw;\r\nstruct iio_dev *iio_dev;\r\niio_dev = devm_iio_device_alloc(&client->dev, sizeof(*hw));\r\nif (!iio_dev)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, iio_dev);\r\nhw = iio_priv(iio_dev);\r\nhw->name = client->name;\r\nhw->dev = &client->dev;\r\nhw->irq = client->irq;\r\nhw->tf = &hts221_transfer_fn;\r\nreturn hts221_probe(iio_dev);\r\n}

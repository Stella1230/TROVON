static int clkgate_separated_enable(struct clk_hw *hw)\r\n{\r\nstruct clkgate_separated *sclk;\r\nunsigned long flags = 0;\r\nu32 reg;\r\nsclk = container_of(hw, struct clkgate_separated, hw);\r\nif (sclk->lock)\r\nspin_lock_irqsave(sclk->lock, flags);\r\nreg = BIT(sclk->bit_idx);\r\nwritel_relaxed(reg, sclk->enable);\r\nreadl_relaxed(sclk->enable + CLKGATE_SEPERATED_STATUS);\r\nif (sclk->lock)\r\nspin_unlock_irqrestore(sclk->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void clkgate_separated_disable(struct clk_hw *hw)\r\n{\r\nstruct clkgate_separated *sclk;\r\nunsigned long flags = 0;\r\nu32 reg;\r\nsclk = container_of(hw, struct clkgate_separated, hw);\r\nif (sclk->lock)\r\nspin_lock_irqsave(sclk->lock, flags);\r\nreg = BIT(sclk->bit_idx);\r\nwritel_relaxed(reg, sclk->enable + CLKGATE_SEPERATED_DISABLE);\r\nreadl_relaxed(sclk->enable + CLKGATE_SEPERATED_STATUS);\r\nif (sclk->lock)\r\nspin_unlock_irqrestore(sclk->lock, flags);\r\n}\r\nstatic int clkgate_separated_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clkgate_separated *sclk;\r\nu32 reg;\r\nsclk = container_of(hw, struct clkgate_separated, hw);\r\nreg = readl_relaxed(sclk->enable + CLKGATE_SEPERATED_STATUS);\r\nreg &= BIT(sclk->bit_idx);\r\nreturn reg ? 1 : 0;\r\n}\r\nstruct clk *hisi_register_clkgate_sep(struct device *dev, const char *name,\r\nconst char *parent_name,\r\nunsigned long flags,\r\nvoid __iomem *reg, u8 bit_idx,\r\nu8 clk_gate_flags, spinlock_t *lock)\r\n{\r\nstruct clkgate_separated *sclk;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nsclk = kzalloc(sizeof(*sclk), GFP_KERNEL);\r\nif (!sclk) {\r\npr_err("%s: fail to allocate separated gated clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.ops = &clkgate_separated_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nsclk->enable = reg + CLKGATE_SEPERATED_ENABLE;\r\nsclk->bit_idx = bit_idx;\r\nsclk->flags = clk_gate_flags;\r\nsclk->hw.init = &init;\r\nsclk->lock = lock;\r\nclk = clk_register(dev, &sclk->hw);\r\nif (IS_ERR(clk))\r\nkfree(sclk);\r\nreturn clk;\r\n}

static int xgene_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct xgene_rtc_dev *pdata = dev_get_drvdata(dev);\r\nrtc_time_to_tm(readl(pdata->csr_base + RTC_CCVR), tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int xgene_rtc_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nstruct xgene_rtc_dev *pdata = dev_get_drvdata(dev);\r\nwritel((u32) secs, pdata->csr_base + RTC_CLR);\r\nreadl(pdata->csr_base + RTC_CLR);\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct xgene_rtc_dev *pdata = dev_get_drvdata(dev);\r\nrtc_time_to_tm(pdata->alarm_time, &alrm->time);\r\nalrm->enabled = readl(pdata->csr_base + RTC_CCR) & RTC_CCR_IE;\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_alarm_irq_enable(struct device *dev, u32 enabled)\r\n{\r\nstruct xgene_rtc_dev *pdata = dev_get_drvdata(dev);\r\nu32 ccr;\r\nccr = readl(pdata->csr_base + RTC_CCR);\r\nif (enabled) {\r\nccr &= ~RTC_CCR_MASK;\r\nccr |= RTC_CCR_IE;\r\n} else {\r\nccr &= ~RTC_CCR_IE;\r\nccr |= RTC_CCR_MASK;\r\n}\r\nwritel(ccr, pdata->csr_base + RTC_CCR);\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct xgene_rtc_dev *pdata = dev_get_drvdata(dev);\r\nunsigned long rtc_time;\r\nunsigned long alarm_time;\r\nrtc_time = readl(pdata->csr_base + RTC_CCVR);\r\nrtc_tm_to_time(&alrm->time, &alarm_time);\r\npdata->alarm_time = alarm_time;\r\nwritel((u32) pdata->alarm_time, pdata->csr_base + RTC_CMR);\r\nxgene_rtc_alarm_irq_enable(dev, alrm->enabled);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t xgene_rtc_interrupt(int irq, void *id)\r\n{\r\nstruct xgene_rtc_dev *pdata = (struct xgene_rtc_dev *) id;\r\nif (!(readl(pdata->csr_base + RTC_STAT) & RTC_STAT_BIT))\r\nreturn IRQ_NONE;\r\nreadl(pdata->csr_base + RTC_EOI);\r\nrtc_update_irq(pdata->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xgene_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct xgene_rtc_dev *pdata;\r\nstruct resource *res;\r\nint ret;\r\nint irq;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, pdata);\r\npdata->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npdata->csr_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pdata->csr_base))\r\nreturn PTR_ERR(pdata->csr_base);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "No IRQ resource\n");\r\nreturn irq;\r\n}\r\nret = devm_request_irq(&pdev->dev, irq, xgene_rtc_interrupt, 0,\r\ndev_name(&pdev->dev), pdata);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not request IRQ\n");\r\nreturn ret;\r\n}\r\npdata->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(pdata->clk)) {\r\ndev_err(&pdev->dev, "Couldn't get the clock for RTC\n");\r\nreturn -ENODEV;\r\n}\r\nclk_prepare_enable(pdata->clk);\r\nwritel(RTC_CCR_EN, pdata->csr_base + RTC_CCR);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\npdata->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&xgene_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(pdata->rtc)) {\r\nclk_disable_unprepare(pdata->clk);\r\nreturn PTR_ERR(pdata->rtc);\r\n}\r\npdata->rtc->uie_unsupported = 1;\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct xgene_rtc_dev *pdata = platform_get_drvdata(pdev);\r\nxgene_rtc_alarm_irq_enable(&pdev->dev, 0);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nclk_disable_unprepare(pdata->clk);\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct xgene_rtc_dev *pdata = platform_get_drvdata(pdev);\r\nint irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (device_may_wakeup(&pdev->dev)) {\r\nif (!enable_irq_wake(irq))\r\npdata->irq_wake = 1;\r\n} else {\r\nxgene_rtc_alarm_irq_enable(dev, 0);\r\nclk_disable(pdata->clk);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xgene_rtc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct xgene_rtc_dev *pdata = platform_get_drvdata(pdev);\r\nint irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (device_may_wakeup(&pdev->dev)) {\r\nif (pdata->irq_wake) {\r\ndisable_irq_wake(irq);\r\npdata->irq_wake = 0;\r\n}\r\n} else {\r\nclk_enable(pdata->clk);\r\nxgene_rtc_alarm_irq_enable(dev, 1);\r\n}\r\nreturn 0;\r\n}

static void rt5514_spi_copy_work(struct work_struct *work)\r\n{\r\nstruct rt5514_dsp *rt5514_dsp =\r\ncontainer_of(work, struct rt5514_dsp, copy_work.work);\r\nstruct snd_pcm_runtime *runtime;\r\nsize_t period_bytes, truncated_bytes = 0;\r\nmutex_lock(&rt5514_dsp->dma_lock);\r\nif (!rt5514_dsp->substream) {\r\ndev_err(rt5514_dsp->dev, "No pcm substream\n");\r\ngoto done;\r\n}\r\nruntime = rt5514_dsp->substream->runtime;\r\nperiod_bytes = snd_pcm_lib_period_bytes(rt5514_dsp->substream);\r\nif (rt5514_dsp->buf_size - rt5514_dsp->dsp_offset < period_bytes)\r\nperiod_bytes = rt5514_dsp->buf_size - rt5514_dsp->dsp_offset;\r\nif (rt5514_dsp->buf_rp + period_bytes <= rt5514_dsp->buf_limit) {\r\nrt5514_spi_burst_read(rt5514_dsp->buf_rp,\r\nruntime->dma_area + rt5514_dsp->dma_offset,\r\nperiod_bytes);\r\nif (rt5514_dsp->buf_rp + period_bytes == rt5514_dsp->buf_limit)\r\nrt5514_dsp->buf_rp = rt5514_dsp->buf_base;\r\nelse\r\nrt5514_dsp->buf_rp += period_bytes;\r\n} else {\r\ntruncated_bytes = rt5514_dsp->buf_limit - rt5514_dsp->buf_rp;\r\nrt5514_spi_burst_read(rt5514_dsp->buf_rp,\r\nruntime->dma_area + rt5514_dsp->dma_offset,\r\ntruncated_bytes);\r\nrt5514_spi_burst_read(rt5514_dsp->buf_base,\r\nruntime->dma_area + rt5514_dsp->dma_offset +\r\ntruncated_bytes, period_bytes - truncated_bytes);\r\nrt5514_dsp->buf_rp = rt5514_dsp->buf_base +\r\nperiod_bytes - truncated_bytes;\r\n}\r\nrt5514_dsp->dma_offset += period_bytes;\r\nif (rt5514_dsp->dma_offset >= runtime->dma_bytes)\r\nrt5514_dsp->dma_offset = 0;\r\nrt5514_dsp->dsp_offset += period_bytes;\r\nsnd_pcm_period_elapsed(rt5514_dsp->substream);\r\nif (rt5514_dsp->dsp_offset < rt5514_dsp->buf_size)\r\nschedule_delayed_work(&rt5514_dsp->copy_work, 5);\r\ndone:\r\nmutex_unlock(&rt5514_dsp->dma_lock);\r\n}\r\nstatic int rt5514_spi_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nsnd_soc_set_runtime_hwparams(substream, &rt5514_spi_pcm_hardware);\r\nreturn 0;\r\n}\r\nstatic int rt5514_spi_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct rt5514_dsp *rt5514_dsp =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nint ret;\r\nmutex_lock(&rt5514_dsp->dma_lock);\r\nret = snd_pcm_lib_alloc_vmalloc_buffer(substream,\r\nparams_buffer_bytes(hw_params));\r\nrt5514_dsp->substream = substream;\r\nmutex_unlock(&rt5514_dsp->dma_lock);\r\nreturn ret;\r\n}\r\nstatic int rt5514_spi_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct rt5514_dsp *rt5514_dsp =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nmutex_lock(&rt5514_dsp->dma_lock);\r\nrt5514_dsp->substream = NULL;\r\nmutex_unlock(&rt5514_dsp->dma_lock);\r\ncancel_delayed_work_sync(&rt5514_dsp->copy_work);\r\nreturn snd_pcm_lib_free_vmalloc_buffer(substream);\r\n}\r\nstatic int rt5514_spi_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct rt5514_dsp *rt5514_dsp =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nu8 buf[8];\r\nrt5514_dsp->dma_offset = 0;\r\nrt5514_dsp->dsp_offset = 0;\r\nrt5514_spi_burst_read(RT5514_BUFFER_VOICE_BASE, (u8 *)&buf,\r\nsizeof(buf));\r\nrt5514_dsp->buf_base = buf[0] | buf[1] << 8 | buf[2] << 16 |\r\nbuf[3] << 24;\r\nrt5514_spi_burst_read(RT5514_BUFFER_VOICE_LIMIT, (u8 *)&buf,\r\nsizeof(buf));\r\nrt5514_dsp->buf_limit = buf[0] | buf[1] << 8 | buf[2] << 16 |\r\nbuf[3] << 24;\r\nrt5514_spi_burst_read(RT5514_BUFFER_VOICE_RP, (u8 *)&buf,\r\nsizeof(buf));\r\nrt5514_dsp->buf_rp = buf[0] | buf[1] << 8 | buf[2] << 16 |\r\nbuf[3] << 24;\r\nrt5514_spi_burst_read(RT5514_BUFFER_VOICE_SIZE, (u8 *)&buf,\r\nsizeof(buf));\r\nrt5514_dsp->buf_size = buf[0] | buf[1] << 8 | buf[2] << 16 |\r\nbuf[3] << 24;\r\nreturn 0;\r\n}\r\nstatic int rt5514_spi_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct rt5514_dsp *rt5514_dsp =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nif (cmd == SNDRV_PCM_TRIGGER_START) {\r\nif (rt5514_dsp->buf_base && rt5514_dsp->buf_limit &&\r\nrt5514_dsp->buf_rp && rt5514_dsp->buf_size)\r\nschedule_delayed_work(&rt5514_dsp->copy_work, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t rt5514_spi_pcm_pointer(\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct rt5514_dsp *rt5514_dsp =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nreturn bytes_to_frames(runtime, rt5514_dsp->dma_offset);\r\n}\r\nstatic int rt5514_spi_pcm_probe(struct snd_soc_platform *platform)\r\n{\r\nstruct rt5514_dsp *rt5514_dsp;\r\nrt5514_dsp = devm_kzalloc(platform->dev, sizeof(*rt5514_dsp),\r\nGFP_KERNEL);\r\nrt5514_dsp->dev = &rt5514_spi->dev;\r\nmutex_init(&rt5514_dsp->dma_lock);\r\nINIT_DELAYED_WORK(&rt5514_dsp->copy_work, rt5514_spi_copy_work);\r\nsnd_soc_platform_set_drvdata(platform, rt5514_dsp);\r\nreturn 0;\r\n}\r\nint rt5514_spi_burst_read(unsigned int addr, u8 *rxbuf, size_t len)\r\n{\r\nu8 spi_cmd = RT5514_SPI_CMD_BURST_READ;\r\nint status;\r\nu8 write_buf[8];\r\nunsigned int i, end, offset = 0;\r\nstruct spi_message message;\r\nstruct spi_transfer x[3];\r\nwhile (offset < len) {\r\nif (offset + RT5514_SPI_BUF_LEN <= len)\r\nend = RT5514_SPI_BUF_LEN;\r\nelse\r\nend = len % RT5514_SPI_BUF_LEN;\r\nwrite_buf[0] = spi_cmd;\r\nwrite_buf[1] = ((addr + offset) & 0xff000000) >> 24;\r\nwrite_buf[2] = ((addr + offset) & 0x00ff0000) >> 16;\r\nwrite_buf[3] = ((addr + offset) & 0x0000ff00) >> 8;\r\nwrite_buf[4] = ((addr + offset) & 0x000000ff) >> 0;\r\nspi_message_init(&message);\r\nmemset(x, 0, sizeof(x));\r\nx[0].len = 5;\r\nx[0].tx_buf = write_buf;\r\nspi_message_add_tail(&x[0], &message);\r\nx[1].len = 4;\r\nx[1].tx_buf = write_buf;\r\nspi_message_add_tail(&x[1], &message);\r\nx[2].len = end;\r\nx[2].rx_buf = rxbuf + offset;\r\nspi_message_add_tail(&x[2], &message);\r\nstatus = spi_sync(rt5514_spi, &message);\r\nif (status)\r\nreturn false;\r\noffset += RT5514_SPI_BUF_LEN;\r\n}\r\nfor (i = 0; i < len; i += 8) {\r\nwrite_buf[0] = rxbuf[i + 0];\r\nwrite_buf[1] = rxbuf[i + 1];\r\nwrite_buf[2] = rxbuf[i + 2];\r\nwrite_buf[3] = rxbuf[i + 3];\r\nwrite_buf[4] = rxbuf[i + 4];\r\nwrite_buf[5] = rxbuf[i + 5];\r\nwrite_buf[6] = rxbuf[i + 6];\r\nwrite_buf[7] = rxbuf[i + 7];\r\nrxbuf[i + 0] = write_buf[7];\r\nrxbuf[i + 1] = write_buf[6];\r\nrxbuf[i + 2] = write_buf[5];\r\nrxbuf[i + 3] = write_buf[4];\r\nrxbuf[i + 4] = write_buf[3];\r\nrxbuf[i + 5] = write_buf[2];\r\nrxbuf[i + 6] = write_buf[1];\r\nrxbuf[i + 7] = write_buf[0];\r\n}\r\nreturn true;\r\n}\r\nint rt5514_spi_burst_write(u32 addr, const u8 *txbuf, size_t len)\r\n{\r\nu8 spi_cmd = RT5514_SPI_CMD_BURST_WRITE;\r\nu8 *write_buf;\r\nunsigned int i, end, offset = 0;\r\nwrite_buf = kmalloc(RT5514_SPI_BUF_LEN + 6, GFP_KERNEL);\r\nif (write_buf == NULL)\r\nreturn -ENOMEM;\r\nwhile (offset < len) {\r\nif (offset + RT5514_SPI_BUF_LEN <= len)\r\nend = RT5514_SPI_BUF_LEN;\r\nelse\r\nend = len % RT5514_SPI_BUF_LEN;\r\nwrite_buf[0] = spi_cmd;\r\nwrite_buf[1] = ((addr + offset) & 0xff000000) >> 24;\r\nwrite_buf[2] = ((addr + offset) & 0x00ff0000) >> 16;\r\nwrite_buf[3] = ((addr + offset) & 0x0000ff00) >> 8;\r\nwrite_buf[4] = ((addr + offset) & 0x000000ff) >> 0;\r\nfor (i = 0; i < end; i += 8) {\r\nwrite_buf[i + 12] = txbuf[offset + i + 0];\r\nwrite_buf[i + 11] = txbuf[offset + i + 1];\r\nwrite_buf[i + 10] = txbuf[offset + i + 2];\r\nwrite_buf[i + 9] = txbuf[offset + i + 3];\r\nwrite_buf[i + 8] = txbuf[offset + i + 4];\r\nwrite_buf[i + 7] = txbuf[offset + i + 5];\r\nwrite_buf[i + 6] = txbuf[offset + i + 6];\r\nwrite_buf[i + 5] = txbuf[offset + i + 7];\r\n}\r\nwrite_buf[end + 5] = spi_cmd;\r\nspi_write(rt5514_spi, write_buf, end + 6);\r\noffset += RT5514_SPI_BUF_LEN;\r\n}\r\nkfree(write_buf);\r\nreturn 0;\r\n}\r\nstatic int rt5514_spi_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nrt5514_spi = spi;\r\nret = devm_snd_soc_register_platform(&spi->dev, &rt5514_spi_platform);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "Failed to register platform.\n");\r\nreturn ret;\r\n}\r\nret = devm_snd_soc_register_component(&spi->dev,\r\n&rt5514_spi_dai_component,\r\n&rt5514_spi_dai, 1);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "Failed to register component.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

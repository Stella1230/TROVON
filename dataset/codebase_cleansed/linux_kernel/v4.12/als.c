static void __init u16_to_hex(char *str, u16 val)\r\n{\r\nint i, num;\r\nfor (i = 1; i <= 4; i++) {\r\nnum = (val >> (16 - 4 * i)) & 0xf;\r\nif (num >= 10)\r\nnum += 7;\r\n*str++ = '0' + num;\r\n}\r\n*str = '\0';\r\n}\r\nstatic void __init print_machine_type(void)\r\n{\r\nstatic char mach_str[80] __initdata = "Detected machine-type number: ";\r\nchar type_str[5];\r\nstruct cpuid id;\r\nget_cpu_id(&id);\r\nu16_to_hex(type_str, id.machine);\r\nstrcat(mach_str, type_str);\r\nstrcat(mach_str, "\n");\r\nsclp_early_printk(mach_str);\r\n}\r\nstatic void __init u16_to_decimal(char *str, u16 val)\r\n{\r\nint div = 1;\r\nwhile (div * 10 <= val)\r\ndiv *= 10;\r\nwhile (div) {\r\n*str++ = '0' + val / div;\r\nval %= div;\r\ndiv /= 10;\r\n}\r\n*str = '\0';\r\n}\r\nstatic void __init print_missing_facilities(void)\r\n{\r\nstatic char als_str[80] __initdata = "Missing facilities: ";\r\nunsigned long val;\r\nchar val_str[6];\r\nint i, j, first;\r\nfirst = 1;\r\nfor (i = 0; i < ARRAY_SIZE(als); i++) {\r\nval = ~S390_lowcore.stfle_fac_list[i] & als[i];\r\nfor (j = 0; j < BITS_PER_LONG; j++) {\r\nif (!(val & (1UL << (BITS_PER_LONG - 1 - j))))\r\ncontinue;\r\nif (!first)\r\nstrcat(als_str, ",");\r\nif (strlen(als_str) > 70) {\r\nstrcat(als_str, "\n");\r\nsclp_early_printk(als_str);\r\n*als_str = '\0';\r\n}\r\nu16_to_decimal(val_str, i * BITS_PER_LONG + j);\r\nstrcat(als_str, val_str);\r\nfirst = 0;\r\n}\r\n}\r\nstrcat(als_str, "\n");\r\nsclp_early_printk(als_str);\r\nsclp_early_printk("See Principles of Operations for facility bits\n");\r\n}\r\nstatic void __init facility_mismatch(void)\r\n{\r\nsclp_early_printk("The Linux kernel requires more recent processor hardware\n");\r\nprint_machine_type();\r\nprint_missing_facilities();\r\ndisabled_wait(0x8badcccc);\r\n}\r\nvoid __init verify_facilities(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(S390_lowcore.stfle_fac_list); i++)\r\nS390_lowcore.stfle_fac_list[i] = 0;\r\nasm volatile(\r\n" stfl 0(0)\n"\r\n: "=m" (S390_lowcore.stfl_fac_list));\r\nS390_lowcore.stfle_fac_list[0] = (u64)S390_lowcore.stfl_fac_list << 32;\r\nif (S390_lowcore.stfl_fac_list & 0x01000000) {\r\nregister unsigned long reg0 asm("0") = ARRAY_SIZE(als) - 1;\r\nasm volatile(".insn s,0xb2b00000,0(%1)"\r\n: "+d" (reg0)\r\n: "a" (&S390_lowcore.stfle_fac_list)\r\n: "memory", "cc");\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(als); i++) {\r\nif ((S390_lowcore.stfle_fac_list[i] & als[i]) != als[i])\r\nfacility_mismatch();\r\n}\r\n}

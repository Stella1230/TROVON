static ssize_t seattle_transmit_led_message(struct ata_port *ap, u32 state,\r\nssize_t size)\r\n{\r\nstruct ahci_host_priv *hpriv = ap->host->private_data;\r\nstruct ahci_port_priv *pp = ap->private_data;\r\nstruct seattle_plat_data *plat_data = hpriv->plat_data;\r\nunsigned long flags;\r\nint pmp;\r\nstruct ahci_em_priv *emp;\r\nu32 val;\r\npmp = (state & EM_MSG_LED_PMP_SLOT) >> 8;\r\nif (pmp >= EM_MAX_SLOTS)\r\nreturn -EINVAL;\r\nemp = &pp->em_priv[pmp];\r\nval = ioread32(plat_data->sgpio_ctrl);\r\nif (state & ACTIVITY_MASK)\r\nval |= 1 << ACTIVITY_BIT_POS((ap->port_no));\r\nelse\r\nval &= ~(1 << ACTIVITY_BIT_POS((ap->port_no)));\r\nif (state & LOCATE_MASK)\r\nval |= 1 << LOCATE_BIT_POS((ap->port_no));\r\nelse\r\nval &= ~(1 << LOCATE_BIT_POS((ap->port_no)));\r\nif (state & FAULT_MASK)\r\nval |= 1 << FAULT_BIT_POS((ap->port_no));\r\nelse\r\nval &= ~(1 << FAULT_BIT_POS((ap->port_no)));\r\niowrite32(val, plat_data->sgpio_ctrl);\r\nspin_lock_irqsave(ap->lock, flags);\r\nemp->led_state = state;\r\nspin_unlock_irqrestore(ap->lock, flags);\r\nreturn size;\r\n}\r\nstatic const struct ata_port_info *ahci_seattle_get_port_info(\r\nstruct platform_device *pdev, struct ahci_host_priv *hpriv)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct seattle_plat_data *plat_data;\r\nu32 val;\r\nplat_data = devm_kzalloc(dev, sizeof(*plat_data), GFP_KERNEL);\r\nif (!plat_data)\r\nreturn &ahci_port_info;\r\nplat_data->sgpio_ctrl = devm_ioremap_resource(dev,\r\nplatform_get_resource(pdev, IORESOURCE_MEM, 1));\r\nif (IS_ERR(plat_data->sgpio_ctrl))\r\nreturn &ahci_port_info;\r\nval = ioread32(plat_data->sgpio_ctrl);\r\nif (!(val & 0xf))\r\nreturn &ahci_port_info;\r\nhpriv->em_loc = 0;\r\nhpriv->em_buf_sz = 4;\r\nhpriv->em_msg_type = EM_MSG_TYPE_LED;\r\nhpriv->plat_data = plat_data;\r\ndev_info(dev, "SGPIO LED control is enabled.\n");\r\nreturn &ahci_port_seattle_info;\r\n}\r\nstatic int ahci_seattle_probe(struct platform_device *pdev)\r\n{\r\nint rc;\r\nstruct ahci_host_priv *hpriv;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nrc = ahci_platform_init_host(pdev, hpriv,\r\nahci_seattle_get_port_info(pdev, hpriv),\r\n&ahci_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

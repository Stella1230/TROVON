static u8 digital_payload_bits_to_size(u8 payload_bits)\r\n{\r\nif (payload_bits >= ARRAY_SIZE(digital_payload_bits_map))\r\nreturn 0;\r\nreturn digital_payload_bits_map[payload_bits];\r\n}\r\nstatic u8 digital_payload_size_to_bits(u8 payload_size)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(digital_payload_bits_map); i++)\r\nif (digital_payload_bits_map[i] == payload_size)\r\nreturn i;\r\nreturn 0xff;\r\n}\r\nstatic void digital_skb_push_dep_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nskb_push(skb, sizeof(u8));\r\nskb->data[0] = skb->len;\r\nif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\r\n*skb_push(skb, sizeof(u8)) = DIGITAL_NFC_DEP_NFCA_SOD_SB;\r\n}\r\nstatic int digital_skb_pull_dep_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nu8 size;\r\nif (skb->len < 2)\r\nreturn -EIO;\r\nif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\r\nskb_pull(skb, sizeof(u8));\r\nsize = skb->data[0];\r\nif (size != skb->len)\r\nreturn -EIO;\r\nskb_pull(skb, sizeof(u8));\r\nreturn 0;\r\n}\r\nstatic struct sk_buff *\r\ndigital_send_dep_data_prep(struct nfc_digital_dev *ddev, struct sk_buff *skb,\r\nstruct digital_dep_req_res *dep_req_res,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct sk_buff *new_skb;\r\nif (skb->len > ddev->remote_payload_max) {\r\ndep_req_res->pfb |= DIGITAL_NFC_DEP_PFB_MI_BIT;\r\nnew_skb = digital_skb_alloc(ddev, ddev->remote_payload_max);\r\nif (!new_skb) {\r\nkfree_skb(ddev->chaining_skb);\r\nddev->chaining_skb = NULL;\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nmemcpy(skb_put(new_skb, ddev->remote_payload_max), skb->data,\r\nddev->remote_payload_max);\r\nskb_pull(skb, ddev->remote_payload_max);\r\nddev->chaining_skb = skb;\r\nddev->data_exch = data_exch;\r\n} else {\r\nddev->chaining_skb = NULL;\r\nnew_skb = skb;\r\n}\r\nreturn new_skb;\r\n}\r\nstatic struct sk_buff *\r\ndigital_recv_dep_data_gather(struct nfc_digital_dev *ddev, u8 pfb,\r\nstruct sk_buff *resp,\r\nint (*send_ack)(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch\r\n*data_exch),\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct sk_buff *new_skb;\r\nint rc;\r\nif (DIGITAL_NFC_DEP_MI_BIT_SET(pfb) && (!ddev->chaining_skb)) {\r\nddev->chaining_skb =\r\nnfc_alloc_recv_skb(8 * ddev->local_payload_max,\r\nGFP_KERNEL);\r\nif (!ddev->chaining_skb) {\r\nrc = -ENOMEM;\r\ngoto error;\r\n}\r\n}\r\nif (ddev->chaining_skb) {\r\nif (resp->len > skb_tailroom(ddev->chaining_skb)) {\r\nnew_skb = skb_copy_expand(ddev->chaining_skb,\r\nskb_headroom(\r\nddev->chaining_skb),\r\n8 * ddev->local_payload_max,\r\nGFP_KERNEL);\r\nif (!new_skb) {\r\nrc = -ENOMEM;\r\ngoto error;\r\n}\r\nkfree_skb(ddev->chaining_skb);\r\nddev->chaining_skb = new_skb;\r\n}\r\nmemcpy(skb_put(ddev->chaining_skb, resp->len), resp->data,\r\nresp->len);\r\nkfree_skb(resp);\r\nresp = NULL;\r\nif (DIGITAL_NFC_DEP_MI_BIT_SET(pfb)) {\r\nrc = send_ack(ddev, data_exch);\r\nif (rc)\r\ngoto error;\r\nreturn NULL;\r\n}\r\nresp = ddev->chaining_skb;\r\nddev->chaining_skb = NULL;\r\n}\r\nreturn resp;\r\nerror:\r\nkfree_skb(resp);\r\nkfree_skb(ddev->chaining_skb);\r\nddev->chaining_skb = NULL;\r\nreturn ERR_PTR(rc);\r\n}\r\nstatic void digital_in_recv_psl_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nstruct digital_psl_res *psl_res;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\npsl_res = (struct digital_psl_res *)resp->data;\r\nif ((resp->len != sizeof(*psl_res)) ||\r\n(psl_res->dir != DIGITAL_NFC_DEP_FRAME_DIR_IN) ||\r\n(psl_res->cmd != DIGITAL_CMD_PSL_RES)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\r\nNFC_DIGITAL_RF_TECH_424F);\r\nif (rc)\r\ngoto exit;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCF_NFC_DEP);\r\nif (rc)\r\ngoto exit;\r\nif (!DIGITAL_DRV_CAPS_IN_CRC(ddev) &&\r\n(ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)) {\r\nddev->skb_add_crc = digital_skb_add_crc_f;\r\nddev->skb_check_crc = digital_skb_check_crc_f;\r\n}\r\nddev->curr_rf_tech = NFC_DIGITAL_RF_TECH_424F;\r\nnfc_dep_link_is_up(ddev->nfc_dev, target->idx, NFC_COMM_ACTIVE,\r\nNFC_RF_INITIATOR);\r\nddev->curr_nfc_dep_pni = 0;\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\nddev->curr_protocol = 0;\r\n}\r\nstatic int digital_in_send_psl_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target)\r\n{\r\nstruct sk_buff *skb;\r\nstruct digital_psl_req *psl_req;\r\nint rc;\r\nu8 payload_size, payload_bits;\r\nskb = digital_skb_alloc(ddev, sizeof(*psl_req));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(*psl_req));\r\npsl_req = (struct digital_psl_req *)skb->data;\r\npsl_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\npsl_req->cmd = DIGITAL_CMD_PSL_REQ;\r\npsl_req->did = 0;\r\npsl_req->brs = (0x2 << 3) | 0x2;\r\npayload_size = min(ddev->local_payload_max, ddev->remote_payload_max);\r\npayload_bits = digital_payload_size_to_bits(payload_size);\r\npsl_req->fsl = DIGITAL_PAYLOAD_BITS_TO_FSL(payload_bits);\r\nddev->local_payload_max = payload_size;\r\nddev->remote_payload_max = payload_size;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\r\ndigital_in_recv_psl_res, target);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_atr_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nstruct digital_atr_res *atr_res;\r\nu8 gb_len, payload_bits;\r\nu8 wt;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\nif (resp->len < sizeof(struct digital_atr_res)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ngb_len = resp->len - sizeof(struct digital_atr_res);\r\natr_res = (struct digital_atr_res *)resp->data;\r\nwt = DIGITAL_ATR_RES_TO_WT(atr_res->to);\r\nif (wt > DIGITAL_NFC_DEP_IN_MAX_WT)\r\nwt = DIGITAL_NFC_DEP_IN_MAX_WT;\r\nddev->dep_rwt = digital_rwt_map[wt];\r\npayload_bits = DIGITAL_PAYLOAD_PP_TO_BITS(atr_res->pp);\r\nddev->remote_payload_max = digital_payload_bits_to_size(payload_bits);\r\nif (!ddev->remote_payload_max) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = nfc_set_remote_general_bytes(ddev->nfc_dev, atr_res->gb, gb_len);\r\nif (rc)\r\ngoto exit;\r\nif ((ddev->protocols & NFC_PROTO_FELICA_MASK) &&\r\n(ddev->curr_rf_tech != NFC_DIGITAL_RF_TECH_424F)) {\r\nrc = digital_in_send_psl_req(ddev, target);\r\nif (!rc)\r\ngoto exit;\r\n}\r\nrc = nfc_dep_link_is_up(ddev->nfc_dev, target->idx, NFC_COMM_ACTIVE,\r\nNFC_RF_INITIATOR);\r\nddev->curr_nfc_dep_pni = 0;\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\nddev->curr_protocol = 0;\r\n}\r\nint digital_in_send_atr_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target, __u8 comm_mode, __u8 *gb,\r\nsize_t gb_len)\r\n{\r\nstruct sk_buff *skb;\r\nstruct digital_atr_req *atr_req;\r\nuint size;\r\nint rc;\r\nu8 payload_bits;\r\nsize = DIGITAL_ATR_REQ_MIN_SIZE + gb_len;\r\nif (size > DIGITAL_ATR_REQ_MAX_SIZE) {\r\nPROTOCOL_ERR("14.6.1.1");\r\nreturn -EINVAL;\r\n}\r\nskb = digital_skb_alloc(ddev, size);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_atr_req));\r\natr_req = (struct digital_atr_req *)skb->data;\r\nmemset(atr_req, 0, sizeof(struct digital_atr_req));\r\natr_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\natr_req->cmd = DIGITAL_CMD_ATR_REQ;\r\nif (target->nfcid2_len)\r\nmemcpy(atr_req->nfcid3, target->nfcid2, NFC_NFCID2_MAXSIZE);\r\nelse\r\nget_random_bytes(atr_req->nfcid3, NFC_NFCID3_MAXSIZE);\r\natr_req->did = 0;\r\natr_req->bs = 0;\r\natr_req->br = 0;\r\nddev->local_payload_max = DIGITAL_PAYLOAD_SIZE_MAX;\r\npayload_bits = digital_payload_size_to_bits(ddev->local_payload_max);\r\natr_req->pp = DIGITAL_PAYLOAD_BITS_TO_PP(payload_bits);\r\nif (gb_len) {\r\natr_req->pp |= DIGITAL_GB_BIT;\r\nmemcpy(skb_put(skb, gb_len), gb, gb_len);\r\n}\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, DIGITAL_ATR_RES_RWT,\r\ndigital_in_recv_atr_res, target);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_in_send_ack(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\r\nddev->curr_nfc_dep_pni;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nddev->saved_skb = pskb_copy(skb, GFP_KERNEL);\r\nrc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc) {\r\nkfree_skb(skb);\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\n}\r\nreturn rc;\r\n}\r\nstatic int digital_in_send_nack(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\r\nDIGITAL_NFC_DEP_PFB_NACK_BIT | ddev->curr_nfc_dep_pni;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_in_send_atn(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, ddev->dep_rwt,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_in_send_rtox(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch, u8 rtox)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nu16 rwt_int;\r\nrwt_int = ddev->dep_rwt * rtox;\r\nif (rwt_int > digital_rwt_map[DIGITAL_NFC_DEP_IN_MAX_WT])\r\nrwt_int = digital_rwt_map[DIGITAL_NFC_DEP_IN_MAX_WT];\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\n*skb_put(skb, 1) = rtox;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU |\r\nDIGITAL_NFC_DEP_PFB_TIMEOUT_BIT;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, rwt_int,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_in_send_saved_skb(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nint rc;\r\nif (!ddev->saved_skb)\r\nreturn -EINVAL;\r\nskb_get(ddev->saved_skb);\r\nrc = digital_in_send_cmd(ddev, ddev->saved_skb, ddev->dep_rwt,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc)\r\nkfree_skb(ddev->saved_skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_dep_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct digital_data_exch *data_exch = arg;\r\nstruct digital_dep_req_res *dep_res;\r\nu8 pfb;\r\nuint size;\r\nint rc;\r\nu8 rtox;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\nif ((rc == -EIO || (rc == -ETIMEDOUT && ddev->nack_count)) &&\r\n(ddev->nack_count++ < DIGITAL_NFC_DEP_N_RETRY_NACK)) {\r\nddev->atn_count = 0;\r\nrc = digital_in_send_nack(ddev, data_exch);\r\nif (rc)\r\ngoto error;\r\nreturn;\r\n} else if ((rc == -ETIMEDOUT) &&\r\n(ddev->atn_count++ < DIGITAL_NFC_DEP_N_RETRY_ATN)) {\r\nddev->nack_count = 0;\r\nrc = digital_in_send_atn(ddev, data_exch);\r\nif (rc)\r\ngoto error;\r\nreturn;\r\n}\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nif ((resp->len >= 4) &&\r\n(ddev->nack_count++ < DIGITAL_NFC_DEP_N_RETRY_NACK)) {\r\nddev->atn_count = 0;\r\nrc = digital_in_send_nack(ddev, data_exch);\r\nif (rc)\r\ngoto error;\r\nkfree_skb(resp);\r\nreturn;\r\n}\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto error;\r\n}\r\nddev->atn_count = 0;\r\nddev->nack_count = 0;\r\nif (resp->len > ddev->local_payload_max) {\r\nrc = -EMSGSIZE;\r\ngoto exit;\r\n}\r\nsize = sizeof(struct digital_dep_req_res);\r\ndep_res = (struct digital_dep_req_res *)resp->data;\r\nif (resp->len < size || dep_res->dir != DIGITAL_NFC_DEP_FRAME_DIR_IN ||\r\ndep_res->cmd != DIGITAL_CMD_DEP_RES) {\r\nrc = -EIO;\r\ngoto error;\r\n}\r\npfb = dep_res->pfb;\r\nif (DIGITAL_NFC_DEP_DID_BIT_SET(pfb)) {\r\nPROTOCOL_ERR("14.8.2.1");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nif (DIGITAL_NFC_DEP_NAD_BIT_SET(pfb)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (size > resp->len) {\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nskb_pull(resp, size);\r\nswitch (DIGITAL_NFC_DEP_PFB_TYPE(pfb)) {\r\ncase DIGITAL_NFC_DEP_PFB_I_PDU:\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\r\nPROTOCOL_ERR("14.12.3.3");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nresp = digital_recv_dep_data_gather(ddev, pfb, resp,\r\ndigital_in_send_ack,\r\ndata_exch);\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto error;\r\n}\r\nif (!resp)\r\nreturn;\r\nrc = 0;\r\nbreak;\r\ncase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\r\nif (DIGITAL_NFC_DEP_NACK_BIT_SET(pfb)) {\r\nPROTOCOL_ERR("14.12.4.5");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\r\nPROTOCOL_ERR("14.12.3.3");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\r\nif (!ddev->chaining_skb) {\r\nPROTOCOL_ERR("14.12.4.3");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nrc = digital_in_send_dep_req(ddev, NULL,\r\nddev->chaining_skb,\r\nddev->data_exch);\r\nif (rc)\r\ngoto error;\r\ngoto free_resp;\r\ncase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\r\nif (!DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb)) {\r\nrc = digital_in_send_saved_skb(ddev, data_exch);\r\nif (rc)\r\ngoto error;\r\ngoto free_resp;\r\n}\r\nif (ddev->atn_count || ddev->nack_count) {\r\nPROTOCOL_ERR("14.12.4.4");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nrtox = DIGITAL_NFC_DEP_RTOX_VALUE(resp->data[0]);\r\nif (!rtox || rtox > DIGITAL_NFC_DEP_RTOX_MAX) {\r\nPROTOCOL_ERR("14.8.4.1");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nrc = digital_in_send_rtox(ddev, data_exch, rtox);\r\nif (rc)\r\ngoto error;\r\ngoto free_resp;\r\n}\r\nexit:\r\ndata_exch->cb(data_exch->cb_context, resp, rc);\r\nerror:\r\nkfree(data_exch);\r\nkfree_skb(ddev->chaining_skb);\r\nddev->chaining_skb = NULL;\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nif (rc)\r\nkfree_skb(resp);\r\nreturn;\r\nfree_resp:\r\ndev_kfree_skb(resp);\r\n}\r\nint digital_in_send_dep_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target, struct sk_buff *skb,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *chaining_skb, *tmp_skb;\r\nint rc;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = ddev->curr_nfc_dep_pni;\r\nddev->atn_count = 0;\r\nddev->nack_count = 0;\r\nchaining_skb = ddev->chaining_skb;\r\ntmp_skb = digital_send_dep_data_prep(ddev, skb, dep_req, data_exch);\r\nif (IS_ERR(tmp_skb))\r\nreturn PTR_ERR(tmp_skb);\r\ndigital_skb_push_dep_sod(ddev, tmp_skb);\r\nddev->skb_add_crc(tmp_skb);\r\nddev->saved_skb = pskb_copy(tmp_skb, GFP_KERNEL);\r\nrc = digital_in_send_cmd(ddev, tmp_skb, ddev->dep_rwt,\r\ndigital_in_recv_dep_res, data_exch);\r\nif (rc) {\r\nif (tmp_skb != skb)\r\nkfree_skb(tmp_skb);\r\nkfree_skb(chaining_skb);\r\nddev->chaining_skb = NULL;\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\n}\r\nreturn rc;\r\n}\r\nstatic void digital_tg_set_rf_tech(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nddev->curr_rf_tech = rf_tech;\r\nddev->skb_add_crc = digital_skb_add_crc_none;\r\nddev->skb_check_crc = digital_skb_check_crc_none;\r\nif (DIGITAL_DRV_CAPS_TG_CRC(ddev))\r\nreturn;\r\nswitch (ddev->curr_rf_tech) {\r\ncase NFC_DIGITAL_RF_TECH_106A:\r\nddev->skb_add_crc = digital_skb_add_crc_a;\r\nddev->skb_check_crc = digital_skb_check_crc_a;\r\nbreak;\r\ncase NFC_DIGITAL_RF_TECH_212F:\r\ncase NFC_DIGITAL_RF_TECH_424F:\r\nddev->skb_add_crc = digital_skb_add_crc_f;\r\nddev->skb_check_crc = digital_skb_check_crc_f;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int digital_tg_send_ack(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_res;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_res = (struct digital_dep_req_res *)skb->data;\r\ndep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\ndep_res->cmd = DIGITAL_CMD_DEP_RES;\r\ndep_res->pfb = DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU |\r\nddev->curr_nfc_dep_pni;\r\nif (ddev->did) {\r\ndep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\r\nmemcpy(skb_put(skb, sizeof(ddev->did)), &ddev->did,\r\nsizeof(ddev->did));\r\n}\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nddev->saved_skb = pskb_copy(skb, GFP_KERNEL);\r\nrc = digital_tg_send_cmd(ddev, skb, 1500, digital_tg_recv_dep_req,\r\ndata_exch);\r\nif (rc) {\r\nkfree_skb(skb);\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\n}\r\nreturn rc;\r\n}\r\nstatic int digital_tg_send_atn(struct nfc_digital_dev *ddev)\r\n{\r\nstruct digital_dep_req_res *dep_res;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_res = (struct digital_dep_req_res *)skb->data;\r\ndep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\ndep_res->cmd = DIGITAL_CMD_DEP_RES;\r\ndep_res->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU;\r\nif (ddev->did) {\r\ndep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\r\nmemcpy(skb_put(skb, sizeof(ddev->did)), &ddev->did,\r\nsizeof(ddev->did));\r\n}\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_tg_send_cmd(ddev, skb, 1500, digital_tg_recv_dep_req,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_tg_send_saved_skb(struct nfc_digital_dev *ddev)\r\n{\r\nint rc;\r\nif (!ddev->saved_skb)\r\nreturn -EINVAL;\r\nskb_get(ddev->saved_skb);\r\nrc = digital_tg_send_cmd(ddev, ddev->saved_skb, 1500,\r\ndigital_tg_recv_dep_req, NULL);\r\nif (rc)\r\nkfree_skb(ddev->saved_skb);\r\nreturn rc;\r\n}\r\nstatic void digital_tg_recv_dep_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_dep_req_res *dep_req;\r\nu8 pfb;\r\nsize_t size;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\nif (resp->len > ddev->local_payload_max) {\r\nrc = -EMSGSIZE;\r\ngoto exit;\r\n}\r\nsize = sizeof(struct digital_dep_req_res);\r\ndep_req = (struct digital_dep_req_res *)resp->data;\r\nif (resp->len < size || dep_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\ndep_req->cmd != DIGITAL_CMD_DEP_REQ) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\npfb = dep_req->pfb;\r\nif (DIGITAL_NFC_DEP_DID_BIT_SET(pfb)) {\r\nif (ddev->did && (ddev->did == resp->data[3])) {\r\nsize++;\r\n} else {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\n} else if (ddev->did) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (DIGITAL_NFC_DEP_NAD_BIT_SET(pfb)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (size > resp->len) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nskb_pull(resp, size);\r\nswitch (DIGITAL_NFC_DEP_PFB_TYPE(pfb)) {\r\ncase DIGITAL_NFC_DEP_PFB_I_PDU:\r\npr_debug("DIGITAL_NFC_DEP_PFB_I_PDU\n");\r\nif (ddev->atn_count) {\r\nddev->atn_count = 0;\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb) ==\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni - 1)) {\r\nrc = digital_tg_send_saved_skb(ddev);\r\nif (rc)\r\ngoto exit;\r\ngoto free_resp;\r\n}\r\n}\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\r\nPROTOCOL_ERR("14.12.3.4");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nresp = digital_recv_dep_data_gather(ddev, pfb, resp,\r\ndigital_tg_send_ack, NULL);\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!resp)\r\nreturn;\r\nrc = 0;\r\nbreak;\r\ncase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\r\nif (DIGITAL_NFC_DEP_NACK_BIT_SET(pfb)) {\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb + 1) !=\r\nddev->curr_nfc_dep_pni) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nddev->atn_count = 0;\r\nrc = digital_tg_send_saved_skb(ddev);\r\nif (rc)\r\ngoto exit;\r\ngoto free_resp;\r\n}\r\nif (ddev->atn_count) {\r\nddev->atn_count = 0;\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb + 1) ==\r\nddev->curr_nfc_dep_pni) {\r\nrc = digital_tg_send_saved_skb(ddev);\r\nif (rc)\r\ngoto exit;\r\ngoto free_resp;\r\n}\r\n}\r\nif (!ddev->chaining_skb ||\r\nDIGITAL_NFC_DEP_PFB_PNI(pfb) !=\r\nddev->curr_nfc_dep_pni) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nrc = digital_tg_send_dep_res(ddev, ddev->chaining_skb);\r\nif (rc)\r\ngoto exit;\r\ngoto free_resp;\r\ncase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\r\nif (DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb)) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = digital_tg_send_atn(ddev);\r\nif (rc)\r\ngoto exit;\r\nddev->atn_count++;\r\ngoto free_resp;\r\n}\r\nrc = nfc_tm_data_received(ddev->nfc_dev, resp);\r\nexit:\r\nkfree_skb(ddev->chaining_skb);\r\nddev->chaining_skb = NULL;\r\nddev->atn_count = 0;\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\nif (rc)\r\nkfree_skb(resp);\r\nreturn;\r\nfree_resp:\r\ndev_kfree_skb(resp);\r\n}\r\nint digital_tg_send_dep_res(struct nfc_digital_dev *ddev, struct sk_buff *skb)\r\n{\r\nstruct digital_dep_req_res *dep_res;\r\nstruct sk_buff *chaining_skb, *tmp_skb;\r\nint rc;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_res = (struct digital_dep_req_res *)skb->data;\r\ndep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\ndep_res->cmd = DIGITAL_CMD_DEP_RES;\r\ndep_res->pfb = ddev->curr_nfc_dep_pni;\r\nif (ddev->did) {\r\ndep_res->pfb |= DIGITAL_NFC_DEP_PFB_DID_BIT;\r\nmemcpy(skb_put(skb, sizeof(ddev->did)), &ddev->did,\r\nsizeof(ddev->did));\r\n}\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\r\nchaining_skb = ddev->chaining_skb;\r\ntmp_skb = digital_send_dep_data_prep(ddev, skb, dep_res, NULL);\r\nif (IS_ERR(tmp_skb))\r\nreturn PTR_ERR(tmp_skb);\r\ndigital_skb_push_dep_sod(ddev, tmp_skb);\r\nddev->skb_add_crc(tmp_skb);\r\nddev->saved_skb = pskb_copy(tmp_skb, GFP_KERNEL);\r\nrc = digital_tg_send_cmd(ddev, tmp_skb, 1500, digital_tg_recv_dep_req,\r\nNULL);\r\nif (rc) {\r\nif (tmp_skb != skb)\r\nkfree_skb(tmp_skb);\r\nkfree_skb(chaining_skb);\r\nddev->chaining_skb = NULL;\r\nkfree_skb(ddev->saved_skb);\r\nddev->saved_skb = NULL;\r\n}\r\nreturn rc;\r\n}\r\nstatic void digital_tg_send_psl_res_complete(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nu8 rf_tech = (unsigned long)arg;\r\nif (IS_ERR(resp))\r\nreturn;\r\ndigital_tg_set_rf_tech(ddev, rf_tech);\r\ndigital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH, rf_tech);\r\ndigital_tg_listen(ddev, 1500, digital_tg_recv_dep_req, NULL);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic int digital_tg_send_psl_res(struct nfc_digital_dev *ddev, u8 did,\r\nu8 rf_tech)\r\n{\r\nstruct digital_psl_res *psl_res;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_psl_res));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_psl_res));\r\npsl_res = (struct digital_psl_res *)skb->data;\r\npsl_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\npsl_res->cmd = DIGITAL_CMD_PSL_RES;\r\npsl_res->did = did;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nddev->curr_nfc_dep_pni = 0;\r\nrc = digital_tg_send_cmd(ddev, skb, 0, digital_tg_send_psl_res_complete,\r\n(void *)(unsigned long)rf_tech);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_tg_recv_psl_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_psl_req *psl_req;\r\nu8 rf_tech;\r\nu8 dsi, payload_size, payload_bits;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\npsl_req = (struct digital_psl_req *)resp->data;\r\nif (resp->len != sizeof(struct digital_psl_req) ||\r\npsl_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\npsl_req->cmd != DIGITAL_CMD_PSL_REQ) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ndsi = (psl_req->brs >> 3) & 0x07;\r\nswitch (dsi) {\r\ncase 0:\r\nrf_tech = NFC_DIGITAL_RF_TECH_106A;\r\nbreak;\r\ncase 1:\r\nrf_tech = NFC_DIGITAL_RF_TECH_212F;\r\nbreak;\r\ncase 2:\r\nrf_tech = NFC_DIGITAL_RF_TECH_424F;\r\nbreak;\r\ndefault:\r\npr_err("Unsupported dsi value %d\n", dsi);\r\ngoto exit;\r\n}\r\npayload_bits = DIGITAL_PAYLOAD_FSL_TO_BITS(psl_req->fsl);\r\npayload_size = digital_payload_bits_to_size(payload_bits);\r\nif (!payload_size || (payload_size > min(ddev->local_payload_max,\r\nddev->remote_payload_max))) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nddev->local_payload_max = payload_size;\r\nddev->remote_payload_max = payload_size;\r\nrc = digital_tg_send_psl_res(ddev, psl_req->did, rf_tech);\r\nexit:\r\nkfree_skb(resp);\r\n}\r\nstatic void digital_tg_send_atr_res_complete(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nint offset;\r\nif (IS_ERR(resp)) {\r\ndigital_poll_next_tech(ddev);\r\nreturn;\r\n}\r\noffset = 2;\r\nif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB)\r\noffset++;\r\nddev->atn_count = 0;\r\nif (resp->data[offset] == DIGITAL_CMD_PSL_REQ)\r\ndigital_tg_recv_psl_req(ddev, arg, resp);\r\nelse\r\ndigital_tg_recv_dep_req(ddev, arg, resp);\r\n}\r\nstatic int digital_tg_send_atr_res(struct nfc_digital_dev *ddev,\r\nstruct digital_atr_req *atr_req)\r\n{\r\nstruct digital_atr_res *atr_res;\r\nstruct sk_buff *skb;\r\nu8 *gb, payload_bits;\r\nsize_t gb_len;\r\nint rc;\r\ngb = nfc_get_local_general_bytes(ddev->nfc_dev, &gb_len);\r\nif (!gb)\r\ngb_len = 0;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_atr_res) + gb_len);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_atr_res));\r\natr_res = (struct digital_atr_res *)skb->data;\r\nmemset(atr_res, 0, sizeof(struct digital_atr_res));\r\natr_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\natr_res->cmd = DIGITAL_CMD_ATR_RES;\r\nmemcpy(atr_res->nfcid3, atr_req->nfcid3, sizeof(atr_req->nfcid3));\r\natr_res->to = DIGITAL_NFC_DEP_TG_MAX_WT;\r\nddev->local_payload_max = DIGITAL_PAYLOAD_SIZE_MAX;\r\npayload_bits = digital_payload_size_to_bits(ddev->local_payload_max);\r\natr_res->pp = DIGITAL_PAYLOAD_BITS_TO_PP(payload_bits);\r\nif (gb_len) {\r\nskb_put(skb, gb_len);\r\natr_res->pp |= DIGITAL_GB_BIT;\r\nmemcpy(atr_res->gb, gb, gb_len);\r\n}\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nddev->curr_nfc_dep_pni = 0;\r\nrc = digital_tg_send_cmd(ddev, skb, 999,\r\ndigital_tg_send_atr_res_complete, NULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nvoid digital_tg_recv_atr_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_atr_req *atr_req;\r\nsize_t gb_len, min_size;\r\nu8 poll_tech_count, payload_bits;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!resp->len) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB) {\r\nmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 2;\r\ndigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_106A);\r\n} else {\r\nmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 1;\r\ndigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_212F);\r\n}\r\nif (resp->len < min_size) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nddev->curr_protocol = NFC_PROTO_NFC_DEP_MASK;\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\natr_req = (struct digital_atr_req *)resp->data;\r\nif (atr_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\natr_req->cmd != DIGITAL_CMD_ATR_REQ ||\r\natr_req->did > DIGITAL_DID_MAX) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\npayload_bits = DIGITAL_PAYLOAD_PP_TO_BITS(atr_req->pp);\r\nddev->remote_payload_max = digital_payload_bits_to_size(payload_bits);\r\nif (!ddev->remote_payload_max) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nddev->did = atr_req->did;\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFC_DEP_ACTIVATED);\r\nif (rc)\r\ngoto exit;\r\nrc = digital_tg_send_atr_res(ddev, atr_req);\r\nif (rc)\r\ngoto exit;\r\ngb_len = resp->len - sizeof(struct digital_atr_req);\r\npoll_tech_count = ddev->poll_tech_count;\r\nddev->poll_tech_count = 0;\r\nrc = nfc_tm_activated(ddev->nfc_dev, NFC_PROTO_NFC_DEP_MASK,\r\nNFC_COMM_PASSIVE, atr_req->gb, gb_len);\r\nif (rc) {\r\nddev->poll_tech_count = poll_tech_count;\r\ngoto exit;\r\n}\r\nrc = 0;\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}

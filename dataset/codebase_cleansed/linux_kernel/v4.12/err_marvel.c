static void\r\nmarvel_print_680_frame(struct ev7_lf_subpackets *lf_subpackets)\r\n{\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nstruct ev7_pal_environmental_subpacket *env;\r\nstruct { int type; char *name; } ev_packets[] = {\r\n{ EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE,\r\n"Ambient Temperature" },\r\n{ EL_TYPE__PAL__ENV__AIRMOVER_FAN,\r\n"AirMover / Fan" },\r\n{ EL_TYPE__PAL__ENV__VOLTAGE,\r\n"Voltage" },\r\n{ EL_TYPE__PAL__ENV__INTRUSION,\r\n"Intrusion" },\r\n{ EL_TYPE__PAL__ENV__POWER_SUPPLY,\r\n"Power Supply" },\r\n{ EL_TYPE__PAL__ENV__LAN,\r\n"LAN" },\r\n{ EL_TYPE__PAL__ENV__HOT_PLUG,\r\n"Hot Plug" },\r\n{ 0, NULL }\r\n};\r\nint i;\r\nfor (i = 0; ev_packets[i].type != 0; i++) {\r\nenv = lf_subpackets->env[ev7_lf_env_index(ev_packets[i].type)];\r\nif (!env)\r\ncontinue;\r\nprintk("%s**%s event (cabinet %d, drawer %d)\n",\r\nerr_print_prefix,\r\nev_packets[i].name,\r\nenv->cabinet,\r\nenv->drawer);\r\nprintk("%s Module Type: 0x%x - Unit ID 0x%x - "\r\n"Condition 0x%x\n",\r\nerr_print_prefix,\r\nenv->module_type,\r\nenv->unit_id,\r\nenv->condition);\r\n}\r\n#endif\r\n}\r\nstatic int\r\nmarvel_process_680_frame(struct ev7_lf_subpackets *lf_subpackets, int print)\r\n{\r\nint status = MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nint i;\r\nfor (i = ev7_lf_env_index(EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE);\r\ni <= ev7_lf_env_index(EL_TYPE__PAL__ENV__HOT_PLUG);\r\ni++) {\r\nif (lf_subpackets->env[i])\r\nstatus = MCHK_DISPOSITION_REPORT;\r\n}\r\nif (print)\r\nmarvel_print_680_frame(lf_subpackets);\r\nreturn status;\r\n}\r\nstatic void\r\nmarvel_print_err_cyc(u64 err_cyc)\r\n{\r\nstatic char *packet_desc[] = {\r\n"No Error",\r\n"UNKNOWN",\r\n"1 cycle (1 or 2 flit packet)",\r\n"2 cycles (3 flit packet)",\r\n"9 cycles (18 flit packet)",\r\n"10 cycles (19 flit packet)",\r\n"UNKNOWN",\r\n"UNKNOWN",\r\n"UNKNOWN"\r\n};\r\n#define IO7__ERR_CYC__ODD_FLT (1UL << 0)\r\n#define IO7__ERR_CYC__EVN_FLT (1UL << 1)\r\n#define IO7__ERR_CYC__PACKET__S (6)\r\n#define IO7__ERR_CYC__PACKET__M (0x7)\r\n#define IO7__ERR_CYC__LOC (1UL << 5)\r\n#define IO7__ERR_CYC__CYCLE__S (2)\r\n#define IO7__ERR_CYC__CYCLE__M (0x7)\r\nprintk("%s Packet In Error: %s\n"\r\n"%s Error in %s, cycle %lld%s%s\n",\r\nerr_print_prefix,\r\npacket_desc[EXTRACT(err_cyc, IO7__ERR_CYC__PACKET)],\r\nerr_print_prefix,\r\n(err_cyc & IO7__ERR_CYC__LOC) ? "DATA" : "HEADER",\r\nEXTRACT(err_cyc, IO7__ERR_CYC__CYCLE),\r\n(err_cyc & IO7__ERR_CYC__ODD_FLT) ? " [ODD Flit]": "",\r\n(err_cyc & IO7__ERR_CYC__EVN_FLT) ? " [Even Flit]": "");\r\n}\r\nstatic void\r\nmarvel_print_po7_crrct_sym(u64 crrct_sym)\r\n{\r\n#define IO7__PO7_CRRCT_SYM__SYN__S (0)\r\n#define IO7__PO7_CRRCT_SYM__SYN__M (0x7f)\r\n#define IO7__PO7_CRRCT_SYM__ERR_CYC__S (7)\r\n#define IO7__PO7_CRRCT_SYM__ERR_CYC__M (0x1ff)\r\nprintk("%s Correctable Error Symptoms:\n"\r\n"%s Syndrome: 0x%llx\n",\r\nerr_print_prefix,\r\nerr_print_prefix, EXTRACT(crrct_sym, IO7__PO7_CRRCT_SYM__SYN));\r\nmarvel_print_err_cyc(EXTRACT(crrct_sym, IO7__PO7_CRRCT_SYM__ERR_CYC));\r\n}\r\nstatic void\r\nmarvel_print_po7_uncrr_sym(u64 uncrr_sym, u64 valid_mask)\r\n{\r\nstatic char *clk_names[] = { "_h[0]", "_h[1]", "_n[0]", "_n[1]" };\r\nstatic char *clk_decode[] = {\r\n"No Error",\r\n"One extra rising edge",\r\n"Two extra rising edges",\r\n"Lost one clock"\r\n};\r\nstatic char *port_names[] = { "Port 0", "Port 1",\r\n"Port 2", "Port 3",\r\n"Unknown Port", "Unknown Port",\r\n"Unknown Port", "Port 7" };\r\nint scratch, i;\r\n#define IO7__PO7_UNCRR_SYM__SYN__S (0)\r\n#define IO7__PO7_UNCRR_SYM__SYN__M (0x7f)\r\n#define IO7__PO7_UNCRR_SYM__ERR_CYC__S (7)\r\n#define IO7__PO7_UNCRR_SYM__ERR_CYC__M (0x1ff)\r\n#define IO7__PO7_UNCRR_SYM__CLK__S (16)\r\n#define IO7__PO7_UNCRR_SYM__CLK__M (0xff)\r\n#define IO7__PO7_UNCRR_SYM__CDT_OVF_TO__REQ (1UL << 24)\r\n#define IO7__PO7_UNCRR_SYM__CDT_OVF_TO__RIO (1UL << 25)\r\n#define IO7__PO7_UNCRR_SYM__CDT_OVF_TO__WIO (1UL << 26)\r\n#define IO7__PO7_UNCRR_SYM__CDT_OVF_TO__BLK (1UL << 27)\r\n#define IO7__PO7_UNCRR_SYM__CDT_OVF_TO__NBK (1UL << 28)\r\n#define IO7__PO7_UNCRR_SYM__OVF__READIO (1UL << 29)\r\n#define IO7__PO7_UNCRR_SYM__OVF__WRITEIO (1UL << 30)\r\n#define IO7__PO7_UNCRR_SYM__OVF__FWD (1UL << 31)\r\n#define IO7__PO7_UNCRR_SYM__VICTIM_SP__S (32)\r\n#define IO7__PO7_UNCRR_SYM__VICTIM_SP__M (0xff)\r\n#define IO7__PO7_UNCRR_SYM__DETECT_SP__S (40)\r\n#define IO7__PO7_UNCRR_SYM__DETECT_SP__M (0xff)\r\n#define IO7__PO7_UNCRR_SYM__STRV_VTR__S (48)\r\n#define IO7__PO7_UNCRR_SYM__STRV_VTR__M (0x3ff)\r\n#define IO7__STRV_VTR__LSI__INTX__S (0)\r\n#define IO7__STRV_VTR__LSI__INTX__M (0x3)\r\n#define IO7__STRV_VTR__LSI__SLOT__S (2)\r\n#define IO7__STRV_VTR__LSI__SLOT__M (0x7)\r\n#define IO7__STRV_VTR__LSI__BUS__S (5)\r\n#define IO7__STRV_VTR__LSI__BUS__M (0x3)\r\n#define IO7__STRV_VTR__MSI__INTNUM__S (0)\r\n#define IO7__STRV_VTR__MSI__INTNUM__M (0x1ff)\r\n#define IO7__STRV_VTR__IS_MSI (1UL << 9)\r\nprintk("%s Uncorrectable Error Symptoms:\n", err_print_prefix);\r\nuncrr_sym &= valid_mask;\r\nif (EXTRACT(valid_mask, IO7__PO7_UNCRR_SYM__SYN))\r\nprintk("%s Syndrome: 0x%llx\n",\r\nerr_print_prefix,\r\nEXTRACT(uncrr_sym, IO7__PO7_UNCRR_SYM__SYN));\r\nif (EXTRACT(valid_mask, IO7__PO7_UNCRR_SYM__ERR_CYC))\r\nmarvel_print_err_cyc(EXTRACT(uncrr_sym,\r\nIO7__PO7_UNCRR_SYM__ERR_CYC));\r\nscratch = EXTRACT(uncrr_sym, IO7__PO7_UNCRR_SYM__CLK);\r\nfor (i = 0; i < 4; i++, scratch >>= 2) {\r\nif (scratch & 0x3)\r\nprintk("%s Clock %s: %s\n",\r\nerr_print_prefix,\r\nclk_names[i], clk_decode[scratch & 0x3]);\r\n}\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__CDT_OVF_TO__REQ)\r\nprintk("%s REQ Credit Timeout or Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__CDT_OVF_TO__RIO)\r\nprintk("%s RIO Credit Timeout or Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__CDT_OVF_TO__WIO)\r\nprintk("%s WIO Credit Timeout or Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__CDT_OVF_TO__BLK)\r\nprintk("%s BLK Credit Timeout or Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__CDT_OVF_TO__NBK)\r\nprintk("%s NBK Credit Timeout or Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__OVF__READIO)\r\nprintk("%s Read I/O Buffer Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__OVF__WRITEIO)\r\nprintk("%s Write I/O Buffer Overflow\n",\r\nerr_print_prefix);\r\nif (uncrr_sym & IO7__PO7_UNCRR_SYM__OVF__FWD)\r\nprintk("%s FWD Buffer Overflow\n",\r\nerr_print_prefix);\r\nif ((scratch = EXTRACT(uncrr_sym, IO7__PO7_UNCRR_SYM__VICTIM_SP))) {\r\nint lost = scratch & (1UL << 4);\r\nscratch &= ~lost;\r\nfor (i = 0; i < 8; i++, scratch >>= 1) {\r\nif (!(scratch & 1))\r\ncontinue;\r\nprintk("%s Error Response sent to %s",\r\nerr_print_prefix, port_names[i]);\r\n}\r\nif (lost)\r\nprintk("%s Lost Error sent somewhere else\n",\r\nerr_print_prefix);\r\n}\r\nif ((scratch = EXTRACT(uncrr_sym, IO7__PO7_UNCRR_SYM__DETECT_SP))) {\r\nfor (i = 0; i < 8; i++, scratch >>= 1) {\r\nif (!(scratch & 1))\r\ncontinue;\r\nprintk("%s Error Reported by %s",\r\nerr_print_prefix, port_names[i]);\r\n}\r\n}\r\nif (EXTRACT(valid_mask, IO7__PO7_UNCRR_SYM__STRV_VTR)) {\r\nchar starvation_message[80];\r\nscratch = EXTRACT(uncrr_sym, IO7__PO7_UNCRR_SYM__STRV_VTR);\r\nif (scratch & IO7__STRV_VTR__IS_MSI)\r\nsprintf(starvation_message,\r\n"MSI Interrupt 0x%x",\r\nEXTRACT(scratch, IO7__STRV_VTR__MSI__INTNUM));\r\nelse\r\nsprintf(starvation_message,\r\n"LSI INT%c for Bus:Slot (%d:%d)\n",\r\n'A' + EXTRACT(scratch,\r\nIO7__STRV_VTR__LSI__INTX),\r\nEXTRACT(scratch, IO7__STRV_VTR__LSI__BUS),\r\nEXTRACT(scratch, IO7__STRV_VTR__LSI__SLOT));\r\nprintk("%s Starvation Int Trigger By: %s\n",\r\nerr_print_prefix, starvation_message);\r\n}\r\n}\r\nstatic void\r\nmarvel_print_po7_ugbge_sym(u64 ugbge_sym)\r\n{\r\nchar opcode_str[10];\r\n#define IO7__PO7_UGBGE_SYM__UPH_PKT_OFF__S (6)\r\n#define IO7__PO7_UGBGE_SYM__UPH_PKT_OFF__M (0xfffffffful)\r\n#define IO7__PO7_UGBGE_SYM__UPH_OPCODE__S (40)\r\n#define IO7__PO7_UGBGE_SYM__UPH_OPCODE__M (0xff)\r\n#define IO7__PO7_UGBGE_SYM__UPH_SRC_PORT__S (48)\r\n#define IO7__PO7_UGBGE_SYM__UPH_SRC_PORT__M (0xf)\r\n#define IO7__PO7_UGBGE_SYM__UPH_DEST_PID__S (52)\r\n#define IO7__PO7_UGBGE_SYM__UPH_DEST_PID__M (0x7ff)\r\n#define IO7__PO7_UGBGE_SYM__VALID (1UL << 63)\r\nif (!(ugbge_sym & IO7__PO7_UGBGE_SYM__VALID))\r\nreturn;\r\nswitch(EXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_OPCODE)) {\r\ncase 0x51:\r\nsprintf(opcode_str, "Wr32");\r\nbreak;\r\ncase 0x50:\r\nsprintf(opcode_str, "WrQW");\r\nbreak;\r\ncase 0x54:\r\nsprintf(opcode_str, "WrIPR");\r\nbreak;\r\ncase 0xD8:\r\nsprintf(opcode_str, "Victim");\r\nbreak;\r\ncase 0xC5:\r\nsprintf(opcode_str, "BlkIO");\r\nbreak;\r\ndefault:\r\nsprintf(opcode_str, "0x%llx\n",\r\nEXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_OPCODE));\r\nbreak;\r\n}\r\nprintk("%s Up Hose Garbage Symptom:\n"\r\n"%s Source Port: %lld - Dest PID: %lld - OpCode: %s\n",\r\nerr_print_prefix,\r\nerr_print_prefix,\r\nEXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_SRC_PORT),\r\nEXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_DEST_PID),\r\nopcode_str);\r\nif (0xC5 != EXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_OPCODE))\r\nprintk("%s Packet Offset 0x%08llx\n",\r\nerr_print_prefix,\r\nEXTRACT(ugbge_sym, IO7__PO7_UGBGE_SYM__UPH_PKT_OFF));\r\n}\r\nstatic void\r\nmarvel_print_po7_err_sum(struct ev7_pal_io_subpacket *io)\r\n{\r\nu64 uncrr_sym_valid = 0;\r\n#define IO7__PO7_ERRSUM__CR_SBE (1UL << 32)\r\n#define IO7__PO7_ERRSUM__CR_SBE2 (1UL << 33)\r\n#define IO7__PO7_ERRSUM__CR_PIO_WBYTE (1UL << 34)\r\n#define IO7__PO7_ERRSUM__CR_CSR_NXM (1UL << 35)\r\n#define IO7__PO7_ERRSUM__CR_RPID_ACV (1UL << 36)\r\n#define IO7__PO7_ERRSUM__CR_RSP_NXM (1UL << 37)\r\n#define IO7__PO7_ERRSUM__CR_ERR_RESP (1UL << 38)\r\n#define IO7__PO7_ERRSUM__CR_CLK_DERR (1UL << 39)\r\n#define IO7__PO7_ERRSUM__CR_DAT_DBE (1UL << 40)\r\n#define IO7__PO7_ERRSUM__CR_DAT_GRBG (1UL << 41)\r\n#define IO7__PO7_ERRSUM__MAF_TO (1UL << 42)\r\n#define IO7__PO7_ERRSUM__UGBGE (1UL << 43)\r\n#define IO7__PO7_ERRSUM__UN_MAF_LOST (1UL << 44)\r\n#define IO7__PO7_ERRSUM__UN_PKT_OVF (1UL << 45)\r\n#define IO7__PO7_ERRSUM__UN_CDT_OVF (1UL << 46)\r\n#define IO7__PO7_ERRSUM__UN_DEALLOC (1UL << 47)\r\n#define IO7__PO7_ERRSUM__BH_CDT_TO (1UL << 51)\r\n#define IO7__PO7_ERRSUM__BH_CLK_HDR (1UL << 52)\r\n#define IO7__PO7_ERRSUM__BH_DBE_HDR (1UL << 53)\r\n#define IO7__PO7_ERRSUM__BH_GBG_HDR (1UL << 54)\r\n#define IO7__PO7_ERRSUM__BH_BAD_CMD (1UL << 55)\r\n#define IO7__PO7_ERRSUM__HLT_INT (1UL << 56)\r\n#define IO7__PO7_ERRSUM__HP_INT (1UL << 57)\r\n#define IO7__PO7_ERRSUM__CRD_INT (1UL << 58)\r\n#define IO7__PO7_ERRSUM__STV_INT (1UL << 59)\r\n#define IO7__PO7_ERRSUM__HRD_INT (1UL << 60)\r\n#define IO7__PO7_ERRSUM__BH_SUM (1UL << 61)\r\n#define IO7__PO7_ERRSUM__ERR_LST (1UL << 62)\r\n#define IO7__PO7_ERRSUM__ERR_VALID (1UL << 63)\r\n#define IO7__PO7_ERRSUM__ERR_MASK (IO7__PO7_ERRSUM__ERR_VALID | \\r\nIO7__PO7_ERRSUM__CR_SBE)\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_SBE) {\r\nprintk("%s %sSingle Bit Error(s) detected/corrected\n",\r\nerr_print_prefix,\r\n(io->po7_error_sum & IO7__PO7_ERRSUM__CR_SBE2)\r\n? "Multiple " : "");\r\nmarvel_print_po7_crrct_sym(io->po7_crrct_sym);\r\n}\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__HLT_INT)\r\nprintk("%s Halt Interrupt posted", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__HP_INT) {\r\nprintk("%s Hot Plug Event Interrupt posted",\r\nerr_print_prefix);\r\nuncrr_sym_valid |= GEN_MASK(IO7__PO7_UNCRR_SYM__DETECT_SP);\r\n}\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CRD_INT)\r\nprintk("%s Correctable Error Interrupt posted",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__STV_INT) {\r\nprintk("%s Starvation Interrupt posted", err_print_prefix);\r\nuncrr_sym_valid |= GEN_MASK(IO7__PO7_UNCRR_SYM__STRV_VTR);\r\n}\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__HRD_INT) {\r\nprintk("%s Hard Error Interrupt posted", err_print_prefix);\r\nuncrr_sym_valid |= GEN_MASK(IO7__PO7_UNCRR_SYM__DETECT_SP);\r\n}\r\nif (!(io->po7_error_sum & IO7__PO7_ERRSUM__ERR_VALID))\r\ngoto check_uncrr_sym;\r\nuncrr_sym_valid |= GEN_MASK(IO7__PO7_UNCRR_SYM__VICTIM_SP);\r\nif (!(io->po7_error_sum & (IO7__PO7_ERRSUM__CR_PIO_WBYTE |\r\nIO7__PO7_ERRSUM__CR_CSR_NXM |\r\nIO7__PO7_ERRSUM__CR_RSP_NXM |\r\nIO7__PO7_ERRSUM__CR_ERR_RESP |\r\nIO7__PO7_ERRSUM__MAF_TO)))\r\nuncrr_sym_valid |= 0x3ffffffful;\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_PIO_WBYTE)\r\nprintk("%s Write byte into IO7 CSR\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_CSR_NXM)\r\nprintk("%s PIO to non-existent CSR\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_RPID_ACV)\r\nprintk("%s Bus Requester PID (Access Violation)\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_RSP_NXM)\r\nprintk("%s Received NXM response from EV7\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_ERR_RESP)\r\nprintk("%s Received ERROR RESPONSE\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_CLK_DERR)\r\nprintk("%s Clock error on data flit\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_DAT_DBE)\r\nprintk("%s Double Bit Error Data Error Detected\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__CR_DAT_GRBG)\r\nprintk("%s Garbage Encoding Detected on the data\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__UGBGE) {\r\nprintk("%s Garbage Encoding sent up hose\n",\r\nerr_print_prefix);\r\nmarvel_print_po7_ugbge_sym(io->po7_ugbge_sym);\r\n}\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__UN_MAF_LOST)\r\nprintk("%s Orphan response (unexpected response)\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__UN_PKT_OVF)\r\nprintk("%s Down hose packet overflow\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__UN_CDT_OVF)\r\nprintk("%s Down hose credit overflow\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__UN_DEALLOC)\r\nprintk("%s Unexpected or bad dealloc field\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__MAF_TO)\r\nprintk("%s BLACK HOLE: Timeout for all responses\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__BH_CDT_TO)\r\nprintk("%s BLACK HOLE: Credit Timeout\n", err_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__BH_CLK_HDR)\r\nprintk("%s BLACK HOLE: Clock check on header\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__BH_DBE_HDR)\r\nprintk("%s BLACK HOLE: Uncorrectable Error on header\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__BH_GBG_HDR)\r\nprintk("%s BLACK HOLE: Garbage on header\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__BH_BAD_CMD)\r\nprintk("%s BLACK HOLE: Bad EV7 command\n",\r\nerr_print_prefix);\r\nif (io->po7_error_sum & IO7__PO7_ERRSUM__ERR_LST)\r\nprintk("%s Lost Error\n", err_print_prefix);\r\nprintk("%s Failing Packet:\n"\r\n"%s Cycle 1: %016llx\n"\r\n"%s Cycle 2: %016llx\n",\r\nerr_print_prefix,\r\nerr_print_prefix, io->po7_err_pkt0,\r\nerr_print_prefix, io->po7_err_pkt1);\r\ncheck_uncrr_sym:\r\nif (uncrr_sym_valid)\r\nmarvel_print_po7_uncrr_sym(io->po7_uncrr_sym, uncrr_sym_valid);\r\n}\r\nstatic void\r\nmarvel_print_pox_tlb_err(u64 tlb_err)\r\n{\r\nstatic char *tlb_errors[] = {\r\n"No Error",\r\n"North Port Signaled Error fetching TLB entry",\r\n"PTE invalid or UCC or GBG error on this entry",\r\n"Address did not hit any DMA window"\r\n};\r\n#define IO7__POX_TLBERR__ERR_VALID (1UL << 63)\r\n#define IO7__POX_TLBERR__ERRCODE__S (0)\r\n#define IO7__POX_TLBERR__ERRCODE__M (0x3)\r\n#define IO7__POX_TLBERR__ERR_TLB_PTR__S (3)\r\n#define IO7__POX_TLBERR__ERR_TLB_PTR__M (0x7)\r\n#define IO7__POX_TLBERR__FADDR__S (6)\r\n#define IO7__POX_TLBERR__FADDR__M (0x3fffffffffful)\r\nif (!(tlb_err & IO7__POX_TLBERR__ERR_VALID))\r\nreturn;\r\nprintk("%s TLB Error on index 0x%llx:\n"\r\n"%s - %s\n"\r\n"%s - Addr: 0x%016llx\n",\r\nerr_print_prefix,\r\nEXTRACT(tlb_err, IO7__POX_TLBERR__ERR_TLB_PTR),\r\nerr_print_prefix,\r\ntlb_errors[EXTRACT(tlb_err, IO7__POX_TLBERR__ERRCODE)],\r\nerr_print_prefix,\r\nEXTRACT(tlb_err, IO7__POX_TLBERR__FADDR) << 6);\r\n}\r\nstatic void\r\nmarvel_print_pox_spl_cmplt(u64 spl_cmplt)\r\n{\r\nchar message[80];\r\n#define IO7__POX_SPLCMPLT__MESSAGE__S (0)\r\n#define IO7__POX_SPLCMPLT__MESSAGE__M (0x0fffffffful)\r\n#define IO7__POX_SPLCMPLT__SOURCE_BUS__S (40)\r\n#define IO7__POX_SPLCMPLT__SOURCE_BUS__M (0xfful)\r\n#define IO7__POX_SPLCMPLT__SOURCE_DEV__S (35)\r\n#define IO7__POX_SPLCMPLT__SOURCE_DEV__M (0x1ful)\r\n#define IO7__POX_SPLCMPLT__SOURCE_FUNC__S (32)\r\n#define IO7__POX_SPLCMPLT__SOURCE_FUNC__M (0x07ul)\r\n#define IO7__POX_SPLCMPLT__MSG_CLASS__S (28)\r\n#define IO7__POX_SPLCMPLT__MSG_CLASS__M (0xf)\r\n#define IO7__POX_SPLCMPLT__MSG_INDEX__S (20)\r\n#define IO7__POX_SPLCMPLT__MSG_INDEX__M (0xff)\r\n#define IO7__POX_SPLCMPLT__MSG_CLASSINDEX__S (20)\r\n#define IO7__POX_SPLCMPLT__MSG_CLASSINDEX__M (0xfff)\r\n#define IO7__POX_SPLCMPLT__REM_LOWER_ADDR__S (12)\r\n#define IO7__POX_SPLCMPLT__REM_LOWER_ADDR__M (0x7f)\r\n#define IO7__POX_SPLCMPLT__REM_BYTE_COUNT__S (0)\r\n#define IO7__POX_SPLCMPLT__REM_BYTE_COUNT__M (0xfff)\r\nprintk("%s Split Completion Error:\n"\r\n"%s Source (Bus:Dev:Func): %lld:%lld:%lld\n",\r\nerr_print_prefix,\r\nerr_print_prefix,\r\nEXTRACT(spl_cmplt, IO7__POX_SPLCMPLT__SOURCE_BUS),\r\nEXTRACT(spl_cmplt, IO7__POX_SPLCMPLT__SOURCE_DEV),\r\nEXTRACT(spl_cmplt, IO7__POX_SPLCMPLT__SOURCE_FUNC));\r\nswitch(EXTRACT(spl_cmplt, IO7__POX_SPLCMPLT__MSG_CLASSINDEX)) {\r\ncase 0x000:\r\nsprintf(message, "Normal completion");\r\nbreak;\r\ncase 0x100:\r\nsprintf(message, "Bridge - Master Abort");\r\nbreak;\r\ncase 0x101:\r\nsprintf(message, "Bridge - Target Abort");\r\nbreak;\r\ncase 0x102:\r\nsprintf(message, "Bridge - Uncorrectable Write Data Error");\r\nbreak;\r\ncase 0x200:\r\nsprintf(message, "Byte Count Out of Range");\r\nbreak;\r\ncase 0x201:\r\nsprintf(message, "Uncorrectable Split Write Data Error");\r\nbreak;\r\ndefault:\r\nsprintf(message, "%08llx\n",\r\nEXTRACT(spl_cmplt, IO7__POX_SPLCMPLT__MESSAGE));\r\nbreak;\r\n}\r\nprintk("%s Message: %s\n", err_print_prefix, message);\r\n}\r\nstatic void\r\nmarvel_print_pox_trans_sum(u64 trans_sum)\r\n{\r\nstatic const char * const pcix_cmd[] = {\r\n"Interrupt Acknowledge",\r\n"Special Cycle",\r\n"I/O Read",\r\n"I/O Write",\r\n"Reserved",\r\n"Reserved / Device ID Message",\r\n"Memory Read",\r\n"Memory Write",\r\n"Reserved / Alias to Memory Read Block",\r\n"Reserved / Alias to Memory Write Block",\r\n"Configuration Read",\r\n"Configuration Write",\r\n"Memory Read Multiple / Split Completion",\r\n"Dual Address Cycle",\r\n"Memory Read Line / Memory Read Block",\r\n"Memory Write and Invalidate / Memory Write Block"\r\n};\r\n#define IO7__POX_TRANSUM__PCI_ADDR__S (0)\r\n#define IO7__POX_TRANSUM__PCI_ADDR__M (0x3fffffffffffful)\r\n#define IO7__POX_TRANSUM__DAC (1UL << 50)\r\n#define IO7__POX_TRANSUM__PCIX_MASTER_SLOT__S (52)\r\n#define IO7__POX_TRANSUM__PCIX_MASTER_SLOT__M (0xf)\r\n#define IO7__POX_TRANSUM__PCIX_CMD__S (56)\r\n#define IO7__POX_TRANSUM__PCIX_CMD__M (0xf)\r\n#define IO7__POX_TRANSUM__ERR_VALID (1UL << 63)\r\nif (!(trans_sum & IO7__POX_TRANSUM__ERR_VALID))\r\nreturn;\r\nprintk("%s Transaction Summary:\n"\r\n"%s Command: 0x%llx - %s\n"\r\n"%s Address: 0x%016llx%s\n"\r\n"%s PCI-X Master Slot: 0x%llx\n",\r\nerr_print_prefix,\r\nerr_print_prefix,\r\nEXTRACT(trans_sum, IO7__POX_TRANSUM__PCIX_CMD),\r\npcix_cmd[EXTRACT(trans_sum, IO7__POX_TRANSUM__PCIX_CMD)],\r\nerr_print_prefix,\r\nEXTRACT(trans_sum, IO7__POX_TRANSUM__PCI_ADDR),\r\n(trans_sum & IO7__POX_TRANSUM__DAC) ? " (DAC)" : "",\r\nerr_print_prefix,\r\nEXTRACT(trans_sum, IO7__POX_TRANSUM__PCIX_MASTER_SLOT));\r\n}\r\nstatic void\r\nmarvel_print_pox_err(u64 err_sum, struct ev7_pal_io_one_port *port)\r\n{\r\n#define IO7__POX_ERRSUM__AGP_REQQ_OVFL (1UL << 4)\r\n#define IO7__POX_ERRSUM__AGP_SYNC_ERR (1UL << 5)\r\n#define IO7__POX_ERRSUM__MRETRY_TO (1UL << 6)\r\n#define IO7__POX_ERRSUM__PCIX_UX_SPL (1UL << 7)\r\n#define IO7__POX_ERRSUM__PCIX_SPLIT_TO (1UL << 8)\r\n#define IO7__POX_ERRSUM__PCIX_DISCARD_SPL (1UL << 9)\r\n#define IO7__POX_ERRSUM__DMA_RD_TO (1UL << 10)\r\n#define IO7__POX_ERRSUM__CSR_NXM_RD (1UL << 11)\r\n#define IO7__POX_ERRSUM__CSR_NXM_WR (1UL << 12)\r\n#define IO7__POX_ERRSUM__DMA_TO (1UL << 13)\r\n#define IO7__POX_ERRSUM__ALL_MABORTS (1UL << 14)\r\n#define IO7__POX_ERRSUM__MABORT (1UL << 15)\r\n#define IO7__POX_ERRSUM__MABORT_MASK (IO7__POX_ERRSUM__ALL_MABORTS|\\r\nIO7__POX_ERRSUM__MABORT)\r\n#define IO7__POX_ERRSUM__PT_TABORT (1UL << 16)\r\n#define IO7__POX_ERRSUM__PM_TABORT (1UL << 17)\r\n#define IO7__POX_ERRSUM__TABORT_MASK (IO7__POX_ERRSUM__PT_TABORT | \\r\nIO7__POX_ERRSUM__PM_TABORT)\r\n#define IO7__POX_ERRSUM__SERR (1UL << 18)\r\n#define IO7__POX_ERRSUM__ADDRERR_STB (1UL << 19)\r\n#define IO7__POX_ERRSUM__DETECTED_SERR (1UL << 20)\r\n#define IO7__POX_ERRSUM__PERR (1UL << 21)\r\n#define IO7__POX_ERRSUM__DATAERR_STB_NIOW (1UL << 22)\r\n#define IO7__POX_ERRSUM__DETECTED_PERR (1UL << 23)\r\n#define IO7__POX_ERRSUM__PM_PERR (1UL << 24)\r\n#define IO7__POX_ERRSUM__PT_SCERROR (1UL << 26)\r\n#define IO7__POX_ERRSUM__HUNG_BUS (1UL << 28)\r\n#define IO7__POX_ERRSUM__UPE_ERROR__S (51)\r\n#define IO7__POX_ERRSUM__UPE_ERROR__M (0xffUL)\r\n#define IO7__POX_ERRSUM__UPE_ERROR GEN_MASK(IO7__POX_ERRSUM__UPE_ERROR)\r\n#define IO7__POX_ERRSUM__TLB_ERR (1UL << 59)\r\n#define IO7__POX_ERRSUM__ERR_VALID (1UL << 63)\r\n#define IO7__POX_ERRSUM__TRANS_SUM__MASK (IO7__POX_ERRSUM__MRETRY_TO | \\r\nIO7__POX_ERRSUM__PCIX_UX_SPL | \\r\nIO7__POX_ERRSUM__PCIX_SPLIT_TO | \\r\nIO7__POX_ERRSUM__DMA_TO | \\r\nIO7__POX_ERRSUM__MABORT_MASK | \\r\nIO7__POX_ERRSUM__TABORT_MASK | \\r\nIO7__POX_ERRSUM__SERR | \\r\nIO7__POX_ERRSUM__ADDRERR_STB | \\r\nIO7__POX_ERRSUM__PERR | \\r\nIO7__POX_ERRSUM__DATAERR_STB_NIOW |\\r\nIO7__POX_ERRSUM__DETECTED_PERR | \\r\nIO7__POX_ERRSUM__PM_PERR | \\r\nIO7__POX_ERRSUM__PT_SCERROR | \\r\nIO7__POX_ERRSUM__UPE_ERROR)\r\nif (!(err_sum & IO7__POX_ERRSUM__ERR_VALID))\r\nreturn;\r\nif (err_sum & IO7__POX_ERRSUM__MRETRY_TO)\r\nprintk("%s IO7 Master Retry Timeout expired\n",\r\nerr_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PCIX_UX_SPL)\r\nprintk("%s Unexpected Split Completion\n",\r\nerr_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PCIX_SPLIT_TO)\r\nprintk("%s IO7 Split Completion Timeout expired\n",\r\nerr_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__DMA_TO)\r\nprintk("%s Hung bus during DMA transaction\n",\r\nerr_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__MABORT_MASK)\r\nprintk("%s Master Abort\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PT_TABORT)\r\nprintk("%s IO7 Asserted Target Abort\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PM_TABORT)\r\nprintk("%s IO7 Received Target Abort\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__ADDRERR_STB) {\r\nprintk("%s Address or PCI-X Attribute Parity Error\n",\r\nerr_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__SERR)\r\nprintk("%s IO7 Asserted SERR\n", err_print_prefix);\r\n}\r\nif (err_sum & IO7__POX_ERRSUM__PERR) {\r\nif (err_sum & IO7__POX_ERRSUM__DATAERR_STB_NIOW)\r\nprintk("%s IO7 Detected Data Parity Error\n",\r\nerr_print_prefix);\r\nelse\r\nprintk("%s Split Completion Response with "\r\n"Parity Error\n", err_print_prefix);\r\n}\r\nif (err_sum & IO7__POX_ERRSUM__DETECTED_PERR)\r\nprintk("%s PERR detected\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PM_PERR)\r\nprintk("%s PERR while IO7 is master\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PT_SCERROR) {\r\nprintk("%s IO7 Received Split Completion Error message\n",\r\nerr_print_prefix);\r\nmarvel_print_pox_spl_cmplt(port->pox_spl_cmplt);\r\n}\r\nif (err_sum & IO7__POX_ERRSUM__UPE_ERROR) {\r\nunsigned int upe_error = EXTRACT(err_sum,\r\nIO7__POX_ERRSUM__UPE_ERROR);\r\nint i;\r\nstatic char *upe_errors[] = {\r\n"Parity Error on MSI write data",\r\n"MSI read (MSI window is write only",\r\n"TLB - Invalid WR transaction",\r\n"TLB - Invalid RD transaction",\r\n"DMA - WR error (see north port)",\r\n"DMA - RD error (see north port)",\r\n"PPR - WR error (see north port)",\r\n"PPR - RD error (see north port)"\r\n};\r\nprintk("%s UPE Error:\n", err_print_prefix);\r\nfor (i = 0; i < 8; i++) {\r\nif (upe_error & (1 << i))\r\nprintk("%s %s\n", err_print_prefix,\r\nupe_errors[i]);\r\n}\r\n}\r\nif (err_sum & IO7__POX_ERRSUM__TRANS_SUM__MASK)\r\nmarvel_print_pox_trans_sum(port->pox_trans_sum);\r\nif (err_sum & IO7__POX_ERRSUM__TLB_ERR) {\r\nprintk("%s TLB ERROR\n", err_print_prefix);\r\nmarvel_print_pox_tlb_err(port->pox_tlb_err);\r\n}\r\nif (err_sum & IO7__POX_ERRSUM__AGP_REQQ_OVFL)\r\nprintk("%s AGP Request Queue Overflow\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__AGP_SYNC_ERR)\r\nprintk("%s AGP Sync Error\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__PCIX_DISCARD_SPL)\r\nprintk("%s Discarded split completion\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__DMA_RD_TO)\r\nprintk("%s DMA Read Timeout\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__CSR_NXM_RD)\r\nprintk("%s CSR NXM READ\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__CSR_NXM_WR)\r\nprintk("%s CSR NXM WRITE\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__DETECTED_SERR)\r\nprintk("%s SERR detected\n", err_print_prefix);\r\nif (err_sum & IO7__POX_ERRSUM__HUNG_BUS)\r\nprintk("%s HUNG BUS detected\n", err_print_prefix);\r\n}\r\nstatic struct ev7_pal_io_subpacket *\r\nmarvel_find_io7_with_error(struct ev7_lf_subpackets *lf_subpackets)\r\n{\r\nstruct ev7_pal_io_subpacket *io = lf_subpackets->io;\r\nstruct io7 *io7;\r\nint i;\r\nif (!io)\r\nreturn NULL;\r\nmemset(io, 0x55, sizeof(*io));\r\nfor (io7 = NULL; NULL != (io7 = marvel_next_io7(io7)); ) {\r\nunsigned long err_sum = 0;\r\nerr_sum |= io7->csrs->PO7_ERROR_SUM.csr;\r\nfor (i = 0; i < IO7_NUM_PORTS; i++) {\r\nif (!io7->ports[i].enabled)\r\ncontinue;\r\nerr_sum |= io7->ports[i].csrs->POx_ERR_SUM.csr;\r\n}\r\nif (err_sum & (1UL << 63))\r\nbreak;\r\n}\r\nif (!io7)\r\nreturn NULL;\r\nio->io_asic_rev = io7->csrs->IO_ASIC_REV.csr;\r\nio->io_sys_rev = io7->csrs->IO_SYS_REV.csr;\r\nio->io7_uph = io7->csrs->IO7_UPH.csr;\r\nio->hpi_ctl = io7->csrs->HPI_CTL.csr;\r\nio->crd_ctl = io7->csrs->CRD_CTL.csr;\r\nio->hei_ctl = io7->csrs->HEI_CTL.csr;\r\nio->po7_error_sum = io7->csrs->PO7_ERROR_SUM.csr;\r\nio->po7_uncrr_sym = io7->csrs->PO7_UNCRR_SYM.csr;\r\nio->po7_crrct_sym = io7->csrs->PO7_CRRCT_SYM.csr;\r\nio->po7_ugbge_sym = io7->csrs->PO7_UGBGE_SYM.csr;\r\nio->po7_err_pkt0 = io7->csrs->PO7_ERR_PKT[0].csr;\r\nio->po7_err_pkt1 = io7->csrs->PO7_ERR_PKT[1].csr;\r\nfor (i = 0; i < IO7_NUM_PORTS; i++) {\r\nio7_ioport_csrs *csrs = io7->ports[i].csrs;\r\nif (!io7->ports[i].enabled)\r\ncontinue;\r\nio->ports[i].pox_err_sum = csrs->POx_ERR_SUM.csr;\r\nio->ports[i].pox_tlb_err = csrs->POx_TLB_ERR.csr;\r\nio->ports[i].pox_spl_cmplt = csrs->POx_SPL_COMPLT.csr;\r\nio->ports[i].pox_trans_sum = csrs->POx_TRANS_SUM.csr;\r\nio->ports[i].pox_first_err = csrs->POx_FIRST_ERR.csr;\r\nio->ports[i].pox_mult_err = csrs->POx_MULT_ERR.csr;\r\nio->ports[i].pox_dm_source = csrs->POx_DM_SOURCE.csr;\r\nio->ports[i].pox_dm_dest = csrs->POx_DM_DEST.csr;\r\nio->ports[i].pox_dm_size = csrs->POx_DM_SIZE.csr;\r\nio->ports[i].pox_dm_ctrl = csrs->POx_DM_CTRL.csr;\r\ncsrs->POx_TLB_ERR.csr = io->ports[i].pox_tlb_err;\r\ncsrs->POx_ERR_SUM.csr = io->ports[i].pox_err_sum;\r\nmb();\r\ncsrs->POx_ERR_SUM.csr;\r\n}\r\nio7->csrs->PO7_ERROR_SUM.csr = io->po7_error_sum;\r\nmb();\r\nio7->csrs->PO7_ERROR_SUM.csr;\r\nlf_subpackets->io_pid = io7->pe;\r\nreturn io;\r\n}\r\nstatic int\r\nmarvel_process_io_error(struct ev7_lf_subpackets *lf_subpackets, int print)\r\n{\r\nint status = MCHK_DISPOSITION_UNKNOWN_ERROR;\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nstruct ev7_pal_io_subpacket *io = lf_subpackets->io;\r\nint i;\r\n#endif\r\n#define MARVEL_IO_ERR_VALID(x) ((x) & (1UL << 63))\r\nif (!lf_subpackets->logout || !lf_subpackets->io)\r\nreturn status;\r\nif ((lf_subpackets->io->po7_error_sum & (1UL << 32)) ||\r\n((lf_subpackets->io->po7_error_sum |\r\nlf_subpackets->io->ports[0].pox_err_sum |\r\nlf_subpackets->io->ports[1].pox_err_sum |\r\nlf_subpackets->io->ports[2].pox_err_sum |\r\nlf_subpackets->io->ports[3].pox_err_sum) & (1UL << 63))) {\r\nif (!marvel_find_io7_with_error(lf_subpackets))\r\nreturn status;\r\n}\r\nstatus = MCHK_DISPOSITION_REPORT;\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nif (!print)\r\nreturn status;\r\nprintk("%s*Error occurred on IO7 at PID %u\n",\r\nerr_print_prefix, lf_subpackets->io_pid);\r\nif (lf_subpackets->io->po7_error_sum & IO7__PO7_ERRSUM__ERR_MASK) {\r\nmarvel_print_po7_err_sum(io);\r\n#if 0\r\nprintk("%s PORT 7 ERROR:\n"\r\n"%s PO7_ERROR_SUM: %016llx\n"\r\n"%s PO7_UNCRR_SYM: %016llx\n"\r\n"%s PO7_CRRCT_SYM: %016llx\n"\r\n"%s PO7_UGBGE_SYM: %016llx\n"\r\n"%s PO7_ERR_PKT0: %016llx\n"\r\n"%s PO7_ERR_PKT1: %016llx\n",\r\nerr_print_prefix,\r\nerr_print_prefix, io->po7_error_sum,\r\nerr_print_prefix, io->po7_uncrr_sym,\r\nerr_print_prefix, io->po7_crrct_sym,\r\nerr_print_prefix, io->po7_ugbge_sym,\r\nerr_print_prefix, io->po7_err_pkt0,\r\nerr_print_prefix, io->po7_err_pkt1);\r\n#endif\r\n}\r\nfor (i = 0; i < IO7_NUM_PORTS; i++) {\r\nif (!MARVEL_IO_ERR_VALID(io->ports[i].pox_err_sum))\r\ncontinue;\r\nprintk("%s PID %u PORT %d POx_ERR_SUM: %016llx\n",\r\nerr_print_prefix,\r\nlf_subpackets->io_pid, i, io->ports[i].pox_err_sum);\r\nmarvel_print_pox_err(io->ports[i].pox_err_sum, &io->ports[i]);\r\nprintk("%s [ POx_FIRST_ERR: %016llx ]\n",\r\nerr_print_prefix, io->ports[i].pox_first_err);\r\nmarvel_print_pox_err(io->ports[i].pox_first_err,\r\n&io->ports[i]);\r\n}\r\n#endif\r\nreturn status;\r\n}\r\nstatic int\r\nmarvel_process_logout_frame(struct ev7_lf_subpackets *lf_subpackets, int print)\r\n{\r\nint status = MCHK_DISPOSITION_UNKNOWN_ERROR;\r\n#define EV7__RBOX_INT__IO_ERROR__MASK 0x20000400ul\r\nif (lf_subpackets->logout &&\r\n(lf_subpackets->logout->rbox_int & 0x20000400ul))\r\nstatus = marvel_process_io_error(lf_subpackets, print);\r\nif (lf_subpackets->ev7 &&\r\n(lf_subpackets->ev7->c_stat == 0x14) &&\r\n!(lf_subpackets->ev7->c_sts & 0x8) &&\r\n((lf_subpackets->ev7->c_addr & 0x400ff000000ul)\r\n== 0x400fe000000ul))\r\nstatus = MCHK_DISPOSITION_DISMISS;\r\nreturn status;\r\n}\r\nvoid\r\nmarvel_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nstruct el_subpacket *el_ptr = (struct el_subpacket *)la_ptr;\r\nint (*process_frame)(struct ev7_lf_subpackets *, int) = NULL;\r\nstruct ev7_lf_subpackets subpacket_collection = { NULL, };\r\nstruct ev7_pal_io_subpacket scratch_io_packet = { 0, };\r\nstruct ev7_lf_subpackets *lf_subpackets = NULL;\r\nint disposition = MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nchar *saved_err_prefix = err_print_prefix;\r\nchar *error_type = NULL;\r\nmb();\r\ndraina();\r\nswitch(vector) {\r\ncase SCB_Q_SYSEVENT:\r\nprocess_frame = marvel_process_680_frame;\r\nerror_type = "System Event";\r\nbreak;\r\ncase SCB_Q_SYSMCHK:\r\nprocess_frame = marvel_process_logout_frame;\r\nerror_type = "System Uncorrectable Error";\r\nbreak;\r\ncase SCB_Q_SYSERR:\r\nprocess_frame = marvel_process_logout_frame;\r\nerror_type = "System Correctable Error";\r\nbreak;\r\ndefault:\r\nev7_machine_check(vector, la_ptr);\r\nreturn;\r\n}\r\nerr_print_prefix = KERN_CRIT;\r\nlf_subpackets =\r\nev7_collect_logout_frame_subpackets(el_ptr,\r\n&subpacket_collection);\r\nif (process_frame && lf_subpackets && lf_subpackets->logout) {\r\nif (!lf_subpackets->io)\r\nlf_subpackets->io = &scratch_io_packet;\r\nlf_subpackets->io_pid = lf_subpackets->logout->whami;\r\ndisposition = process_frame(lf_subpackets, 0);\r\n}\r\nswitch(disposition) {\r\ncase MCHK_DISPOSITION_DISMISS:\r\nbreak;\r\ncase MCHK_DISPOSITION_REPORT:\r\nprintk("%s*%s (Vector 0x%x) reported on CPU %d\n",\r\nerr_print_prefix, error_type,\r\n(unsigned int)vector, (int)smp_processor_id());\r\nel_print_timestamp(&lf_subpackets->logout->timestamp);\r\nprocess_frame(lf_subpackets, 1);\r\nbreak;\r\ndefault:\r\nprintk("%s*%s (Vector 0x%x) reported on CPU %d\n",\r\nerr_print_prefix, error_type,\r\n(unsigned int)vector, (int)smp_processor_id());\r\nel_process_subpacket(el_ptr);\r\nbreak;\r\n}\r\nerr_print_prefix = saved_err_prefix;\r\nwrmces(0x7);\r\nmb();\r\n}\r\nvoid __init\r\nmarvel_register_error_handlers(void)\r\n{\r\nev7_register_error_handlers();\r\n}

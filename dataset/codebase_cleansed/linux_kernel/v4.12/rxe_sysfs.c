static int sanitize_arg(const char *val, char *intf, int intf_len)\r\n{\r\nint len;\r\nif (!val)\r\nreturn 0;\r\nfor (len = 0; len < intf_len - 1 && val[len] && val[len] != '\n'; len++)\r\nintf[len] = val[len];\r\nintf[len] = 0;\r\nif (len == 0 || (val[len] != 0 && val[len] != '\n'))\r\nreturn 0;\r\nreturn len;\r\n}\r\nstatic void rxe_set_port_state(struct net_device *ndev)\r\n{\r\nstruct rxe_dev *rxe = net_to_rxe(ndev);\r\nbool is_up = netif_running(ndev) && netif_carrier_ok(ndev);\r\nif (!rxe)\r\ngoto out;\r\nif (is_up)\r\nrxe_port_up(rxe);\r\nelse\r\nrxe_port_down(rxe);\r\nout:\r\nreturn;\r\n}\r\nstatic int rxe_param_set_add(const char *val, const struct kernel_param *kp)\r\n{\r\nint len;\r\nint err = 0;\r\nchar intf[32];\r\nstruct net_device *ndev = NULL;\r\nstruct rxe_dev *rxe;\r\nlen = sanitize_arg(val, intf, sizeof(intf));\r\nif (!len) {\r\npr_err("add: invalid interface name\n");\r\nerr = -EINVAL;\r\ngoto err;\r\n}\r\nndev = dev_get_by_name(&init_net, intf);\r\nif (!ndev) {\r\npr_err("interface %s not found\n", intf);\r\nerr = -EINVAL;\r\ngoto err;\r\n}\r\nif (net_to_rxe(ndev)) {\r\npr_err("already configured on %s\n", intf);\r\nerr = -EINVAL;\r\ngoto err;\r\n}\r\nrxe = rxe_net_add(ndev);\r\nif (!rxe) {\r\npr_err("failed to add %s\n", intf);\r\nerr = -EINVAL;\r\ngoto err;\r\n}\r\nrxe_set_port_state(ndev);\r\npr_info("added %s to %s\n", rxe->ib_dev.name, intf);\r\nerr:\r\nif (ndev)\r\ndev_put(ndev);\r\nreturn err;\r\n}\r\nstatic int rxe_param_set_remove(const char *val, const struct kernel_param *kp)\r\n{\r\nint len;\r\nchar intf[32];\r\nstruct rxe_dev *rxe;\r\nlen = sanitize_arg(val, intf, sizeof(intf));\r\nif (!len) {\r\npr_err("add: invalid interface name\n");\r\nreturn -EINVAL;\r\n}\r\nif (strncmp("all", intf, len) == 0) {\r\npr_info("rxe_sys: remove all");\r\nrxe_remove_all();\r\nreturn 0;\r\n}\r\nrxe = get_rxe_by_name(intf);\r\nif (!rxe) {\r\npr_err("not configured on %s\n", intf);\r\nreturn -EINVAL;\r\n}\r\nlist_del(&rxe->list);\r\nrxe_remove(rxe);\r\nreturn 0;\r\n}

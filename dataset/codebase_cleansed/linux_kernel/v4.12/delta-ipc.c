static inline dma_addr_t to_paddr(struct delta_ipc_ctx *ctx, void *vaddr)\r\n{\r\nreturn (ctx->ipc_buf->paddr + (vaddr - ctx->ipc_buf->vaddr));\r\n}\r\nstatic inline bool is_valid_data(struct delta_ipc_ctx *ctx,\r\nvoid *data, u32 size)\r\n{\r\nreturn ((data >= ctx->ipc_buf->vaddr) &&\r\n((data + size) <= (ctx->ipc_buf->vaddr + ctx->ipc_buf->size)));\r\n}\r\nstatic void build_msg_header(struct delta_ipc_ctx *ctx,\r\nenum delta_ipc_fw_command command,\r\nstruct delta_ipc_header_msg *header)\r\n{\r\nheader->tag = IPC_SANITY_TAG;\r\nheader->host_hdl = to_host_hdl(ctx);\r\nheader->copro_hdl = ctx->copro_hdl;\r\nheader->command = command;\r\n}\r\nint delta_ipc_open(struct delta_ctx *pctx, const char *name,\r\nstruct delta_ipc_param *param, u32 ipc_buf_size,\r\nstruct delta_buf **ipc_buf, void **hdl)\r\n{\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\r\nstruct delta_ipc_ctx *ctx = &pctx->ipc_ctx;\r\nstruct delta_ipc_open_msg msg;\r\nstruct delta_buf *buf = &ctx->ipc_buf_struct;\r\nint ret;\r\nif (!rpmsg_device) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, rpmsg is not initialized\n",\r\npctx->name);\r\npctx->sys_errors++;\r\nreturn -EINVAL;\r\n}\r\nif (!name) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, no name given\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!param || !param->data || !param->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, empty parameter\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!ipc_buf_size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, no size given for ipc buffer\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (param->size > ipc_buf_size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, too large ipc parameter (%d bytes while max %d expected)\n",\r\npctx->name,\r\nparam->size, ctx->ipc_buf->size);\r\nreturn -EINVAL;\r\n}\r\ninit_completion(&ctx->done);\r\nret = hw_alloc(pctx, ipc_buf_size,\r\n"ipc data buffer", buf);\r\nif (ret)\r\nreturn ret;\r\nctx->ipc_buf = buf;\r\nbuild_msg_header(ctx, DELTA_IPC_OPEN, &msg.header);\r\nmsg.ipc_buf_size = ipc_buf_size;\r\nmsg.ipc_buf_paddr = ctx->ipc_buf->paddr;\r\nmemcpy(msg.name, name, sizeof(msg.name));\r\nmsg.name[sizeof(msg.name) - 1] = 0;\r\nmsg.param_size = param->size;\r\nmemcpy(ctx->ipc_buf->vaddr, param->data, msg.param_size);\r\nmsg.param_paddr = ctx->ipc_buf->paddr;\r\nret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, rpmsg_send failed (%d) for DELTA_IPC_OPEN (name=%s, size=%d, data=%p)\n",\r\npctx->name,\r\nret, name, param->size, param->data);\r\ngoto err;\r\n}\r\nif (!wait_for_completion_timeout\r\n(&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, timeout waiting for DELTA_IPC_OPEN callback (name=%s, size=%d, data=%p)\n",\r\npctx->name,\r\nname, param->size, param->data);\r\nret = -ETIMEDOUT;\r\ngoto err;\r\n}\r\nif (ctx->cb_err) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to open, DELTA_IPC_OPEN completed but with error (%d) (name=%s, size=%d, data=%p)\n",\r\npctx->name,\r\nctx->cb_err, name, param->size, param->data);\r\nret = -EIO;\r\ngoto err;\r\n}\r\n*ipc_buf = ctx->ipc_buf;\r\n*hdl = (void *)ctx;\r\nreturn 0;\r\nerr:\r\npctx->sys_errors++;\r\nif (ctx->ipc_buf) {\r\nhw_free(pctx, ctx->ipc_buf);\r\nctx->ipc_buf = NULL;\r\n}\r\nreturn ret;\r\n}\r\nint delta_ipc_set_stream(void *hdl, struct delta_ipc_param *param)\r\n{\r\nstruct delta_ipc_ctx *ctx = to_ctx(hdl);\r\nstruct delta_ctx *pctx = to_pctx(ctx);\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\r\nstruct delta_ipc_set_stream_msg msg;\r\nint ret;\r\nif (!hdl) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, invalid ipc handle\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!rpmsg_device) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, rpmsg is not initialized\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!param || !param->data || !param->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, empty parameter\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (param->size > ctx->ipc_buf->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, too large ipc parameter(%d bytes while max %d expected)\n",\r\npctx->name,\r\nparam->size, ctx->ipc_buf->size);\r\nreturn -EINVAL;\r\n}\r\nif (!is_valid_data(ctx, param->data, param->size)) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, parameter is not in expected address range (size=%d, data=%p not in %p..%p)\n",\r\npctx->name,\r\nparam->size,\r\nparam->data,\r\nctx->ipc_buf->vaddr,\r\nctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\r\nreturn -EINVAL;\r\n}\r\nbuild_msg_header(ctx, DELTA_IPC_SET_STREAM, &msg.header);\r\nmsg.param_size = param->size;\r\nmsg.param_paddr = to_paddr(ctx, param->data);\r\nret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, rpmsg_send failed (%d) for DELTA_IPC_SET_STREAM (size=%d, data=%p)\n",\r\npctx->name,\r\nret, param->size, param->data);\r\npctx->sys_errors++;\r\nreturn ret;\r\n}\r\nif (!wait_for_completion_timeout\r\n(&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, timeout waiting for DELTA_IPC_SET_STREAM callback (size=%d, data=%p)\n",\r\npctx->name,\r\nparam->size, param->data);\r\npctx->sys_errors++;\r\nreturn -ETIMEDOUT;\r\n}\r\nif (ctx->cb_err) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to set stream, DELTA_IPC_SET_STREAM completed but with error (%d) (size=%d, data=%p)\n",\r\npctx->name,\r\nctx->cb_err, param->size, param->data);\r\npctx->sys_errors++;\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint delta_ipc_decode(void *hdl, struct delta_ipc_param *param,\r\nstruct delta_ipc_param *status)\r\n{\r\nstruct delta_ipc_ctx *ctx = to_ctx(hdl);\r\nstruct delta_ctx *pctx = to_pctx(ctx);\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\r\nstruct delta_ipc_decode_msg msg;\r\nint ret;\r\nif (!hdl) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, invalid ipc handle\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!rpmsg_device) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, rpmsg is not initialized\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!param || !param->data || !param->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, empty parameter\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (!status || !status->data || !status->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, empty status\n",\r\npctx->name);\r\nreturn -EINVAL;\r\n}\r\nif (param->size + status->size > ctx->ipc_buf->size) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, too large ipc parameter (%d bytes (param) + %d bytes (status) while max %d expected)\n",\r\npctx->name,\r\nparam->size,\r\nstatus->size,\r\nctx->ipc_buf->size);\r\nreturn -EINVAL;\r\n}\r\nif (!is_valid_data(ctx, param->data, param->size)) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, parameter is not in expected address range (size=%d, data=%p not in %p..%p)\n",\r\npctx->name,\r\nparam->size,\r\nparam->data,\r\nctx->ipc_buf->vaddr,\r\nctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\r\nreturn -EINVAL;\r\n}\r\nif (!is_valid_data(ctx, status->data, status->size)) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, status is not in expected address range (size=%d, data=%p not in %p..%p)\n",\r\npctx->name,\r\nstatus->size,\r\nstatus->data,\r\nctx->ipc_buf->vaddr,\r\nctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\r\nreturn -EINVAL;\r\n}\r\nbuild_msg_header(ctx, DELTA_IPC_DECODE, &msg.header);\r\nmsg.param_size = param->size;\r\nmsg.param_paddr = to_paddr(ctx, param->data);\r\nmsg.status_size = status->size;\r\nmsg.status_paddr = to_paddr(ctx, status->data);\r\nret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, rpmsg_send failed (%d) for DELTA_IPC_DECODE (size=%d, data=%p)\n",\r\npctx->name,\r\nret, param->size, param->data);\r\npctx->sys_errors++;\r\nreturn ret;\r\n}\r\nif (!wait_for_completion_timeout\r\n(&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, timeout waiting for DELTA_IPC_DECODE callback (size=%d, data=%p)\n",\r\npctx->name,\r\nparam->size, param->data);\r\npctx->sys_errors++;\r\nreturn -ETIMEDOUT;\r\n}\r\nif (ctx->cb_err) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to decode, DELTA_IPC_DECODE completed but with error (%d) (size=%d, data=%p)\n",\r\npctx->name,\r\nctx->cb_err, param->size, param->data);\r\npctx->sys_errors++;\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nvoid delta_ipc_close(void *hdl)\r\n{\r\nstruct delta_ipc_ctx *ctx = to_ctx(hdl);\r\nstruct delta_ctx *pctx = to_pctx(ctx);\r\nstruct delta_dev *delta = pctx->dev;\r\nstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\r\nstruct delta_ipc_close_msg msg;\r\nint ret;\r\nif (!hdl) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to close, invalid ipc handle\n",\r\npctx->name);\r\nreturn;\r\n}\r\nif (ctx->ipc_buf) {\r\nhw_free(pctx, ctx->ipc_buf);\r\nctx->ipc_buf = NULL;\r\n}\r\nif (!rpmsg_device) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to close, rpmsg is not initialized\n",\r\npctx->name);\r\nreturn;\r\n}\r\nbuild_msg_header(ctx, DELTA_IPC_CLOSE, &msg.header);\r\nret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\r\nif (ret) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to close, rpmsg_send failed (%d) for DELTA_IPC_CLOSE\n",\r\npctx->name, ret);\r\npctx->sys_errors++;\r\nreturn;\r\n}\r\nif (!wait_for_completion_timeout\r\n(&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to close, timeout waiting for DELTA_IPC_CLOSE callback\n",\r\npctx->name);\r\npctx->sys_errors++;\r\nreturn;\r\n}\r\nif (ctx->cb_err) {\r\ndev_err(delta->dev,\r\n"%s ipc: failed to close, DELTA_IPC_CLOSE completed but with error (%d)\n",\r\npctx->name, ctx->cb_err);\r\npctx->sys_errors++;\r\n}\r\n}\r\nstatic int delta_ipc_cb(struct rpmsg_device *rpdev, void *data,\r\nint len, void *priv, u32 src)\r\n{\r\nstruct delta_ipc_ctx *ctx;\r\nstruct delta_ipc_cb_msg *msg;\r\nif (!rpdev) {\r\ndev_err(NULL, "rpdev is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nif (!data || !len) {\r\ndev_err(&rpdev->dev,\r\n"unexpected empty message received from src=%d\n", src);\r\nreturn -EINVAL;\r\n}\r\nif (len != sizeof(*msg)) {\r\ndev_err(&rpdev->dev,\r\n"unexpected message length received from src=%d (received %d bytes while %zu bytes expected)\n",\r\nlen, src, sizeof(*msg));\r\nreturn -EINVAL;\r\n}\r\nmsg = (struct delta_ipc_cb_msg *)data;\r\nif (msg->header.tag != IPC_SANITY_TAG) {\r\ndev_err(&rpdev->dev,\r\n"unexpected message tag received from src=%d (received %x tag while %x expected)\n",\r\nsrc, msg->header.tag, IPC_SANITY_TAG);\r\nreturn -EINVAL;\r\n}\r\nctx = msg_to_ctx(msg);\r\nif (!ctx) {\r\ndev_err(&rpdev->dev,\r\n"unexpected message with NULL host_hdl received from src=%d\n",\r\nsrc);\r\nreturn -EINVAL;\r\n}\r\nif (!ctx->copro_hdl)\r\nctx->copro_hdl = msg_to_copro_hdl(msg);\r\nctx->cb_err = msg->err;\r\ncomplete(&ctx->done);\r\nreturn 0;\r\n}\r\nstatic int delta_ipc_probe(struct rpmsg_device *rpmsg_device)\r\n{\r\nstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpmsg_device->dev.driver);\r\nstruct delta_dev *delta = to_delta(rpdrv);\r\ndelta->rpmsg_device = rpmsg_device;\r\nreturn 0;\r\n}\r\nstatic void delta_ipc_remove(struct rpmsg_device *rpmsg_device)\r\n{\r\nstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpmsg_device->dev.driver);\r\nstruct delta_dev *delta = to_delta(rpdrv);\r\ndelta->rpmsg_device = NULL;\r\n}\r\nint delta_ipc_init(struct delta_dev *delta)\r\n{\r\ndelta->rpmsg_driver = delta_rpmsg_driver;\r\nreturn register_rpmsg_driver(&delta->rpmsg_driver);\r\n}\r\nvoid delta_ipc_exit(struct delta_dev *delta)\r\n{\r\nunregister_rpmsg_driver(&delta->rpmsg_driver);\r\n}

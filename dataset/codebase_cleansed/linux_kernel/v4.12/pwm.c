static int gb_pwm_count_operation(struct gb_pwm_chip *pwmc)\r\n{\r\nstruct gb_pwm_count_response response;\r\nint ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_PWM_COUNT,\r\nNULL, 0, &response, sizeof(response));\r\nif (ret)\r\nreturn ret;\r\npwmc->pwm_max = response.count;\r\nreturn 0;\r\n}\r\nstatic int gb_pwm_activate_operation(struct gb_pwm_chip *pwmc,\r\nu8 which)\r\n{\r\nstruct gb_pwm_activate_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\nreturn ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_ACTIVATE,\r\n&request, sizeof(request), NULL, 0);\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_deactivate_operation(struct gb_pwm_chip *pwmc,\r\nu8 which)\r\n{\r\nstruct gb_pwm_deactivate_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\nreturn ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_DEACTIVATE,\r\n&request, sizeof(request), NULL, 0);\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_config_operation(struct gb_pwm_chip *pwmc,\r\nu8 which, u32 duty, u32 period)\r\n{\r\nstruct gb_pwm_config_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\nrequest.duty = cpu_to_le32(duty);\r\nrequest.period = cpu_to_le32(period);\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\nreturn ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_CONFIG,\r\n&request, sizeof(request), NULL, 0);\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_set_polarity_operation(struct gb_pwm_chip *pwmc,\r\nu8 which, u8 polarity)\r\n{\r\nstruct gb_pwm_polarity_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\nrequest.polarity = polarity;\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\nreturn ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_POLARITY,\r\n&request, sizeof(request), NULL, 0);\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_enable_operation(struct gb_pwm_chip *pwmc,\r\nu8 which)\r\n{\r\nstruct gb_pwm_enable_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\nreturn ret;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_ENABLE,\r\n&request, sizeof(request), NULL, 0);\r\nif (ret)\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_disable_operation(struct gb_pwm_chip *pwmc,\r\nu8 which)\r\n{\r\nstruct gb_pwm_disable_request request;\r\nstruct gbphy_device *gbphy_dev;\r\nint ret;\r\nif (which > pwmc->pwm_max)\r\nreturn -EINVAL;\r\nrequest.which = which;\r\nret = gb_operation_sync(pwmc->connection, GB_PWM_TYPE_DISABLE,\r\n&request, sizeof(request), NULL, 0);\r\ngbphy_dev = to_gbphy_dev(pwmc->chip.dev);\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn ret;\r\n}\r\nstatic int gb_pwm_request(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\nreturn gb_pwm_activate_operation(pwmc, pwm->hwpwm);\r\n}\r\nstatic void gb_pwm_free(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\nif (pwm_is_enabled(pwm))\r\ndev_warn(chip->dev, "freeing PWM device without disabling\n");\r\ngb_pwm_deactivate_operation(pwmc, pwm->hwpwm);\r\n}\r\nstatic int gb_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\nreturn gb_pwm_config_operation(pwmc, pwm->hwpwm, duty_ns, period_ns);\r\n}\r\nstatic int gb_pwm_set_polarity(struct pwm_chip *chip, struct pwm_device *pwm,\r\nenum pwm_polarity polarity)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\nreturn gb_pwm_set_polarity_operation(pwmc, pwm->hwpwm, polarity);\r\n}\r\nstatic int gb_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\nreturn gb_pwm_enable_operation(pwmc, pwm->hwpwm);\r\n}\r\nstatic void gb_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct gb_pwm_chip *pwmc = pwm_chip_to_gb_pwm_chip(chip);\r\ngb_pwm_disable_operation(pwmc, pwm->hwpwm);\r\n}\r\nstatic int gb_pwm_probe(struct gbphy_device *gbphy_dev,\r\nconst struct gbphy_device_id *id)\r\n{\r\nstruct gb_connection *connection;\r\nstruct gb_pwm_chip *pwmc;\r\nstruct pwm_chip *pwm;\r\nint ret;\r\npwmc = kzalloc(sizeof(*pwmc), GFP_KERNEL);\r\nif (!pwmc)\r\nreturn -ENOMEM;\r\nconnection = gb_connection_create(gbphy_dev->bundle,\r\nle16_to_cpu(gbphy_dev->cport_desc->id),\r\nNULL);\r\nif (IS_ERR(connection)) {\r\nret = PTR_ERR(connection);\r\ngoto exit_pwmc_free;\r\n}\r\npwmc->connection = connection;\r\ngb_connection_set_data(connection, pwmc);\r\ngb_gbphy_set_data(gbphy_dev, pwmc);\r\nret = gb_connection_enable(connection);\r\nif (ret)\r\ngoto exit_connection_destroy;\r\nret = gb_pwm_count_operation(pwmc);\r\nif (ret)\r\ngoto exit_connection_disable;\r\npwm = &pwmc->chip;\r\npwm->dev = &gbphy_dev->dev;\r\npwm->ops = &gb_pwm_ops;\r\npwm->base = -1;\r\npwm->npwm = pwmc->pwm_max + 1;\r\nret = pwmchip_add(pwm);\r\nif (ret) {\r\ndev_err(&gbphy_dev->dev,\r\n"failed to register PWM: %d\n", ret);\r\ngoto exit_connection_disable;\r\n}\r\ngbphy_runtime_put_autosuspend(gbphy_dev);\r\nreturn 0;\r\nexit_connection_disable:\r\ngb_connection_disable(connection);\r\nexit_connection_destroy:\r\ngb_connection_destroy(connection);\r\nexit_pwmc_free:\r\nkfree(pwmc);\r\nreturn ret;\r\n}\r\nstatic void gb_pwm_remove(struct gbphy_device *gbphy_dev)\r\n{\r\nstruct gb_pwm_chip *pwmc = gb_gbphy_get_data(gbphy_dev);\r\nstruct gb_connection *connection = pwmc->connection;\r\nint ret;\r\nret = gbphy_runtime_get_sync(gbphy_dev);\r\nif (ret)\r\ngbphy_runtime_get_noresume(gbphy_dev);\r\npwmchip_remove(&pwmc->chip);\r\ngb_connection_disable(connection);\r\ngb_connection_destroy(connection);\r\nkfree(pwmc);\r\n}

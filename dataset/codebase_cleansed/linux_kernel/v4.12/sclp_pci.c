static int do_pci_configure(sclp_cmdw_t cmd, u32 fid)\r\n{\r\nstruct pci_cfg_sccb *sccb;\r\nint rc;\r\nif (!SCLP_HAS_PCI_RECONFIG)\r\nreturn -EOPNOTSUPP;\r\nsccb = (struct pci_cfg_sccb *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!sccb)\r\nreturn -ENOMEM;\r\nsccb->header.length = PAGE_SIZE;\r\nsccb->atype = SCLP_ATYPE_PCI;\r\nsccb->aid = fid;\r\nrc = sclp_sync_request(cmd, sccb);\r\nif (rc)\r\ngoto out;\r\nswitch (sccb->header.response_code) {\r\ncase 0x0020:\r\ncase 0x0120:\r\nbreak;\r\ndefault:\r\npr_warn("configure PCI I/O adapter failed: cmd=0x%08x response=0x%04x\n",\r\ncmd, sccb->header.response_code);\r\nrc = -EIO;\r\nbreak;\r\n}\r\nout:\r\nfree_page((unsigned long) sccb);\r\nreturn rc;\r\n}\r\nint sclp_pci_configure(u32 fid)\r\n{\r\nreturn do_pci_configure(SCLP_CMDW_CONFIGURE_PCI, fid);\r\n}\r\nint sclp_pci_deconfigure(u32 fid)\r\n{\r\nreturn do_pci_configure(SCLP_CMDW_DECONFIGURE_PCI, fid);\r\n}\r\nstatic void sclp_pci_callback(struct sclp_req *req, void *data)\r\n{\r\nstruct completion *completion = data;\r\ncomplete(completion);\r\n}\r\nstatic int sclp_pci_check_report(struct zpci_report_error_header *report)\r\n{\r\nif (report->version != 1)\r\nreturn -EINVAL;\r\nif (report->action != SCLP_ERRNOTIFY_AQ_REPAIR &&\r\nreport->action != SCLP_ERRNOTIFY_AQ_INFO_LOG)\r\nreturn -EINVAL;\r\nif (report->length > (PAGE_SIZE - sizeof(struct err_notify_sccb)))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint sclp_pci_report(struct zpci_report_error_header *report, u32 fh, u32 fid)\r\n{\r\nDECLARE_COMPLETION_ONSTACK(completion);\r\nstruct err_notify_sccb *sccb;\r\nstruct sclp_req req;\r\nint ret;\r\nret = sclp_pci_check_report(report);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&sclp_pci_mutex);\r\nret = sclp_register(&sclp_pci_event);\r\nif (ret)\r\ngoto out_unlock;\r\nif (!(sclp_pci_event.sclp_receive_mask & EVTYP_ERRNOTIFY_MASK)) {\r\nret = -EOPNOTSUPP;\r\ngoto out_unregister;\r\n}\r\nsccb = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!sccb) {\r\nret = -ENOMEM;\r\ngoto out_unregister;\r\n}\r\nmemset(&req, 0, sizeof(req));\r\nreq.callback_data = &completion;\r\nreq.callback = sclp_pci_callback;\r\nreq.command = SCLP_CMDW_WRITE_EVENT_DATA;\r\nreq.status = SCLP_REQ_FILLED;\r\nreq.sccb = sccb;\r\nsccb->evbuf.header.length = sizeof(sccb->evbuf) + report->length;\r\nsccb->evbuf.header.type = EVTYP_ERRNOTIFY;\r\nsccb->header.length = sizeof(sccb->header) + sccb->evbuf.header.length;\r\nsccb->evbuf.action = report->action;\r\nsccb->evbuf.atype = SCLP_ATYPE_PCI;\r\nsccb->evbuf.fh = fh;\r\nsccb->evbuf.fid = fid;\r\nmemcpy(sccb->evbuf.data, report->data, report->length);\r\nret = sclp_add_request(&req);\r\nif (ret)\r\ngoto out_free_req;\r\nwait_for_completion(&completion);\r\nif (req.status != SCLP_REQ_DONE) {\r\npr_warn("request failed (status=0x%02x)\n",\r\nreq.status);\r\nret = -EIO;\r\ngoto out_free_req;\r\n}\r\nif (sccb->header.response_code != 0x0020) {\r\npr_warn("request failed with response code 0x%x\n",\r\nsccb->header.response_code);\r\nret = -EIO;\r\n}\r\nout_free_req:\r\nfree_page((unsigned long) sccb);\r\nout_unregister:\r\nsclp_unregister(&sclp_pci_event);\r\nout_unlock:\r\nmutex_unlock(&sclp_pci_mutex);\r\nreturn ret;\r\n}

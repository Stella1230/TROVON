void timecounter_init(struct timecounter *tc,\r\nconst struct cyclecounter *cc,\r\nu64 start_tstamp)\r\n{\r\ntc->cc = cc;\r\ntc->cycle_last = cc->read(cc);\r\ntc->nsec = start_tstamp;\r\ntc->mask = (1ULL << cc->shift) - 1;\r\ntc->frac = 0;\r\n}\r\nstatic u64 timecounter_read_delta(struct timecounter *tc)\r\n{\r\nu64 cycle_now, cycle_delta;\r\nu64 ns_offset;\r\ncycle_now = tc->cc->read(tc->cc);\r\ncycle_delta = (cycle_now - tc->cycle_last) & tc->cc->mask;\r\nns_offset = cyclecounter_cyc2ns(tc->cc, cycle_delta,\r\ntc->mask, &tc->frac);\r\ntc->cycle_last = cycle_now;\r\nreturn ns_offset;\r\n}\r\nu64 timecounter_read(struct timecounter *tc)\r\n{\r\nu64 nsec;\r\nnsec = timecounter_read_delta(tc);\r\nnsec += tc->nsec;\r\ntc->nsec = nsec;\r\nreturn nsec;\r\n}\r\nstatic u64 cc_cyc2ns_backwards(const struct cyclecounter *cc,\r\nu64 cycles, u64 mask, u64 frac)\r\n{\r\nu64 ns = (u64) cycles;\r\nns = ((ns * cc->mult) - frac) >> cc->shift;\r\nreturn ns;\r\n}\r\nu64 timecounter_cyc2time(struct timecounter *tc,\r\nu64 cycle_tstamp)\r\n{\r\nu64 delta = (cycle_tstamp - tc->cycle_last) & tc->cc->mask;\r\nu64 nsec = tc->nsec, frac = tc->frac;\r\nif (delta > tc->cc->mask / 2) {\r\ndelta = (tc->cycle_last - cycle_tstamp) & tc->cc->mask;\r\nnsec -= cc_cyc2ns_backwards(tc->cc, delta, tc->mask, frac);\r\n} else {\r\nnsec += cyclecounter_cyc2ns(tc->cc, delta, tc->mask, &frac);\r\n}\r\nreturn nsec;\r\n}

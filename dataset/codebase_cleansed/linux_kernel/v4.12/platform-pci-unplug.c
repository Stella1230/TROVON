static int check_platform_magic(void)\r\n{\r\nshort magic;\r\nchar protocol;\r\nmagic = inw(XEN_IOPORT_MAGIC);\r\nif (magic != XEN_IOPORT_MAGIC_VAL) {\r\nprintk(KERN_ERR "Xen Platform PCI: unrecognised magic value\n");\r\nreturn XEN_PLATFORM_ERR_MAGIC;\r\n}\r\nprotocol = inb(XEN_IOPORT_PROTOVER);\r\nprintk(KERN_DEBUG "Xen Platform PCI: I/O protocol version %d\n",\r\nprotocol);\r\nswitch (protocol) {\r\ncase 1:\r\noutw(XEN_IOPORT_LINUX_PRODNUM, XEN_IOPORT_PRODNUM);\r\noutl(XEN_IOPORT_LINUX_DRVVER, XEN_IOPORT_DRVVER);\r\nif (inw(XEN_IOPORT_MAGIC) != XEN_IOPORT_MAGIC_VAL) {\r\nprintk(KERN_ERR "Xen Platform: blacklisted by host\n");\r\nreturn XEN_PLATFORM_ERR_BLACKLIST;\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "Xen Platform PCI: unknown I/O protocol version\n");\r\nreturn XEN_PLATFORM_ERR_PROTOCOL;\r\n}\r\nreturn 0;\r\n}\r\nbool xen_has_pv_devices(void)\r\n{\r\nif (!xen_domain())\r\nreturn false;\r\nif (xen_pv_domain() || xen_pvh_domain())\r\nreturn true;\r\nif (xen_platform_pci_unplug == 0)\r\nreturn false;\r\nif (xen_platform_pci_unplug & XEN_UNPLUG_NEVER)\r\nreturn false;\r\nif (xen_platform_pci_unplug & XEN_UNPLUG_ALL)\r\nreturn true;\r\nif (xen_platform_pci_unplug & XEN_UNPLUG_UNNECESSARY)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool __xen_has_pv_device(int state)\r\n{\r\nif (xen_hvm_domain() && (xen_platform_pci_unplug & state))\r\nreturn true;\r\nreturn xen_has_pv_devices();\r\n}\r\nbool xen_has_pv_nic_devices(void)\r\n{\r\nreturn __xen_has_pv_device(XEN_UNPLUG_ALL_NICS | XEN_UNPLUG_ALL);\r\n}\r\nbool xen_has_pv_disk_devices(void)\r\n{\r\nreturn __xen_has_pv_device(XEN_UNPLUG_ALL_IDE_DISKS |\r\nXEN_UNPLUG_AUX_IDE_DISKS | XEN_UNPLUG_ALL);\r\n}\r\nbool xen_has_pv_and_legacy_disk_devices(void)\r\n{\r\nif (!xen_domain())\r\nreturn false;\r\nif (xen_pv_domain())\r\nreturn false;\r\nif (xen_platform_pci_unplug & XEN_UNPLUG_UNNECESSARY)\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid xen_unplug_emulated_devices(void)\r\n{\r\nint r;\r\nif (xen_emul_unplug & XEN_UNPLUG_NEVER)\r\nreturn;\r\nr = check_platform_magic();\r\nif (r && !(r == XEN_PLATFORM_ERR_MAGIC &&\r\n(xen_emul_unplug & XEN_UNPLUG_UNNECESSARY)))\r\nreturn;\r\nif (!xen_emul_unplug) {\r\nif (xen_must_unplug_nics()) {\r\nprintk(KERN_INFO "Netfront and the Xen platform PCI driver have "\r\n"been compiled for this kernel: unplug emulated NICs.\n");\r\nxen_emul_unplug |= XEN_UNPLUG_ALL_NICS;\r\n}\r\nif (xen_must_unplug_disks()) {\r\nprintk(KERN_INFO "Blkfront and the Xen platform PCI driver have "\r\n"been compiled for this kernel: unplug emulated disks.\n"\r\n"You might have to change the root device\n"\r\n"from /dev/hd[a-d] to /dev/xvd[a-d]\n"\r\n"in your root= kernel command line option\n");\r\nxen_emul_unplug |= XEN_UNPLUG_ALL_IDE_DISKS;\r\n}\r\n}\r\nif (!(xen_emul_unplug & XEN_UNPLUG_UNNECESSARY))\r\noutw(xen_emul_unplug, XEN_IOPORT_UNPLUG);\r\nxen_platform_pci_unplug = xen_emul_unplug;\r\n}\r\nstatic int __init parse_xen_emul_unplug(char *arg)\r\n{\r\nchar *p, *q;\r\nint l;\r\nfor (p = arg; p; p = q) {\r\nq = strchr(p, ',');\r\nif (q) {\r\nl = q - p;\r\nq++;\r\n} else {\r\nl = strlen(p);\r\n}\r\nif (!strncmp(p, "all", l))\r\nxen_emul_unplug |= XEN_UNPLUG_ALL;\r\nelse if (!strncmp(p, "ide-disks", l))\r\nxen_emul_unplug |= XEN_UNPLUG_ALL_IDE_DISKS;\r\nelse if (!strncmp(p, "aux-ide-disks", l))\r\nxen_emul_unplug |= XEN_UNPLUG_AUX_IDE_DISKS;\r\nelse if (!strncmp(p, "nics", l))\r\nxen_emul_unplug |= XEN_UNPLUG_ALL_NICS;\r\nelse if (!strncmp(p, "unnecessary", l))\r\nxen_emul_unplug |= XEN_UNPLUG_UNNECESSARY;\r\nelse if (!strncmp(p, "never", l))\r\nxen_emul_unplug |= XEN_UNPLUG_NEVER;\r\nelse\r\nprintk(KERN_WARNING "unrecognised option '%s' "\r\n"in parameter 'xen_emul_unplug'\n", p);\r\n}\r\nreturn 0;\r\n}

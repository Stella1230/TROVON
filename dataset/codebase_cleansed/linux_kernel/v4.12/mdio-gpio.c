static void *mdio_gpio_of_get_data(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct mdio_gpio_platform_data *pdata;\r\nenum of_gpio_flags flags;\r\nint ret;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn NULL;\r\nret = of_get_gpio_flags(np, 0, &flags);\r\nif (ret < 0)\r\nreturn NULL;\r\npdata->mdc = ret;\r\npdata->mdc_active_low = flags & OF_GPIO_ACTIVE_LOW;\r\nret = of_get_gpio_flags(np, 1, &flags);\r\nif (ret < 0)\r\nreturn NULL;\r\npdata->mdio = ret;\r\npdata->mdio_active_low = flags & OF_GPIO_ACTIVE_LOW;\r\nret = of_get_gpio_flags(np, 2, &flags);\r\nif (ret > 0) {\r\npdata->mdo = ret;\r\npdata->mdo_active_low = flags & OF_GPIO_ACTIVE_LOW;\r\n}\r\nreturn pdata;\r\n}\r\nstatic void mdio_dir(struct mdiobb_ctrl *ctrl, int dir)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\nif (bitbang->mdo) {\r\ngpiod_set_value(bitbang->mdo, 1);\r\nreturn;\r\n}\r\nif (dir)\r\ngpiod_direction_output(bitbang->mdio, 1);\r\nelse\r\ngpiod_direction_input(bitbang->mdio);\r\n}\r\nstatic int mdio_get(struct mdiobb_ctrl *ctrl)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\nreturn gpiod_get_value(bitbang->mdio);\r\n}\r\nstatic void mdio_set(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\nif (bitbang->mdo)\r\ngpiod_set_value(bitbang->mdo, what);\r\nelse\r\ngpiod_set_value(bitbang->mdio, what);\r\n}\r\nstatic void mdc_set(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\ngpiod_set_value(bitbang->mdc, what);\r\n}\r\nstatic struct mii_bus *mdio_gpio_bus_init(struct device *dev,\r\nstruct mdio_gpio_platform_data *pdata,\r\nint bus_id)\r\n{\r\nstruct mii_bus *new_bus;\r\nstruct mdio_gpio_info *bitbang;\r\nint i;\r\nint mdc, mdio, mdo;\r\nunsigned long mdc_flags = GPIOF_OUT_INIT_LOW;\r\nunsigned long mdio_flags = GPIOF_DIR_IN;\r\nunsigned long mdo_flags = GPIOF_OUT_INIT_HIGH;\r\nbitbang = devm_kzalloc(dev, sizeof(*bitbang), GFP_KERNEL);\r\nif (!bitbang)\r\ngoto out;\r\nbitbang->ctrl.ops = &mdio_gpio_ops;\r\nbitbang->ctrl.reset = pdata->reset;\r\nmdc = pdata->mdc;\r\nbitbang->mdc = gpio_to_desc(mdc);\r\nif (pdata->mdc_active_low)\r\nmdc_flags = GPIOF_OUT_INIT_HIGH | GPIOF_ACTIVE_LOW;\r\nmdio = pdata->mdio;\r\nbitbang->mdio = gpio_to_desc(mdio);\r\nif (pdata->mdio_active_low)\r\nmdio_flags |= GPIOF_ACTIVE_LOW;\r\nmdo = pdata->mdo;\r\nif (mdo) {\r\nbitbang->mdo = gpio_to_desc(mdo);\r\nif (pdata->mdo_active_low)\r\nmdo_flags = GPIOF_OUT_INIT_LOW | GPIOF_ACTIVE_LOW;\r\n}\r\nnew_bus = alloc_mdio_bitbang(&bitbang->ctrl);\r\nif (!new_bus)\r\ngoto out;\r\nnew_bus->name = "GPIO Bitbanged MDIO",\r\nnew_bus->phy_mask = pdata->phy_mask;\r\nnew_bus->phy_ignore_ta_mask = pdata->phy_ignore_ta_mask;\r\nmemcpy(new_bus->irq, pdata->irqs, sizeof(new_bus->irq));\r\nnew_bus->parent = dev;\r\nif (new_bus->phy_mask == ~0)\r\ngoto out_free_bus;\r\nfor (i = 0; i < PHY_MAX_ADDR; i++)\r\nif (!new_bus->irq[i])\r\nnew_bus->irq[i] = PHY_POLL;\r\nif (bus_id != -1)\r\nsnprintf(new_bus->id, MII_BUS_ID_SIZE, "gpio-%x", bus_id);\r\nelse\r\nstrncpy(new_bus->id, "gpio", MII_BUS_ID_SIZE);\r\nif (devm_gpio_request_one(dev, mdc, mdc_flags, "mdc"))\r\ngoto out_free_bus;\r\nif (devm_gpio_request_one(dev, mdio, mdio_flags, "mdio"))\r\ngoto out_free_bus;\r\nif (mdo && devm_gpio_request_one(dev, mdo, mdo_flags, "mdo"))\r\ngoto out_free_bus;\r\ndev_set_drvdata(dev, new_bus);\r\nreturn new_bus;\r\nout_free_bus:\r\nfree_mdio_bitbang(new_bus);\r\nout:\r\nreturn NULL;\r\n}\r\nstatic void mdio_gpio_bus_deinit(struct device *dev)\r\n{\r\nstruct mii_bus *bus = dev_get_drvdata(dev);\r\nfree_mdio_bitbang(bus);\r\n}\r\nstatic void mdio_gpio_bus_destroy(struct device *dev)\r\n{\r\nstruct mii_bus *bus = dev_get_drvdata(dev);\r\nmdiobus_unregister(bus);\r\nmdio_gpio_bus_deinit(dev);\r\n}\r\nstatic int mdio_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct mdio_gpio_platform_data *pdata;\r\nstruct mii_bus *new_bus;\r\nint ret, bus_id;\r\nif (pdev->dev.of_node) {\r\npdata = mdio_gpio_of_get_data(pdev);\r\nbus_id = of_alias_get_id(pdev->dev.of_node, "mdio-gpio");\r\nif (bus_id < 0) {\r\ndev_warn(&pdev->dev, "failed to get alias id\n");\r\nbus_id = 0;\r\n}\r\n} else {\r\npdata = dev_get_platdata(&pdev->dev);\r\nbus_id = pdev->id;\r\n}\r\nif (!pdata)\r\nreturn -ENODEV;\r\nnew_bus = mdio_gpio_bus_init(&pdev->dev, pdata, bus_id);\r\nif (!new_bus)\r\nreturn -ENODEV;\r\nif (pdev->dev.of_node)\r\nret = of_mdiobus_register(new_bus, pdev->dev.of_node);\r\nelse\r\nret = mdiobus_register(new_bus);\r\nif (ret)\r\nmdio_gpio_bus_deinit(&pdev->dev);\r\nreturn ret;\r\n}\r\nstatic int mdio_gpio_remove(struct platform_device *pdev)\r\n{\r\nmdio_gpio_bus_destroy(&pdev->dev);\r\nreturn 0;\r\n}

static irqreturn_t st_mmap_thermal_trip_handler(int irq, void *sdata)\r\n{\r\nstruct st_thermal_sensor *sensor = sdata;\r\nthermal_zone_device_update(sensor->thermal_dev,\r\nTHERMAL_EVENT_UNSPECIFIED);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int st_mmap_power_ctrl(struct st_thermal_sensor *sensor,\r\nenum st_thermal_power_state power_state)\r\n{\r\nconst unsigned int mask = (THERMAL_PDN | THERMAL_SRSTN);\r\nconst unsigned int val = power_state ? mask : 0;\r\nreturn regmap_update_bits(sensor->regmap, STIH416_MPE_CONF, mask, val);\r\n}\r\nstatic int st_mmap_alloc_regfields(struct st_thermal_sensor *sensor)\r\n{\r\nstruct device *dev = sensor->dev;\r\nstruct regmap *regmap = sensor->regmap;\r\nconst struct reg_field *reg_fields = sensor->cdata->reg_fields;\r\nsensor->int_thresh_hi = devm_regmap_field_alloc(dev, regmap,\r\nreg_fields[INT_THRESH_HI]);\r\nsensor->int_enable = devm_regmap_field_alloc(dev, regmap,\r\nreg_fields[INT_ENABLE]);\r\nif (IS_ERR(sensor->int_thresh_hi) || IS_ERR(sensor->int_enable)) {\r\ndev_err(dev, "failed to alloc mmap regfields\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_mmap_enable_irq(struct st_thermal_sensor *sensor)\r\n{\r\nint ret;\r\nret = regmap_field_write(sensor->int_thresh_hi,\r\nsensor->cdata->crit_temp -\r\nsensor->cdata->temp_adjust_val);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_field_write(sensor->int_enable, 1);\r\n}\r\nstatic int st_mmap_register_enable_irq(struct st_thermal_sensor *sensor)\r\n{\r\nstruct device *dev = sensor->dev;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint ret;\r\nsensor->irq = platform_get_irq(pdev, 0);\r\nif (sensor->irq < 0) {\r\ndev_err(dev, "failed to register IRQ\n");\r\nreturn sensor->irq;\r\n}\r\nret = devm_request_threaded_irq(dev, sensor->irq,\r\nNULL, st_mmap_thermal_trip_handler,\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\ndev->driver->name, sensor);\r\nif (ret) {\r\ndev_err(dev, "failed to register IRQ %d\n", sensor->irq);\r\nreturn ret;\r\n}\r\nreturn st_mmap_enable_irq(sensor);\r\n}\r\nstatic int st_mmap_regmap_init(struct st_thermal_sensor *sensor)\r\n{\r\nstruct device *dev = sensor->dev;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "no memory resources defined\n");\r\nreturn -ENODEV;\r\n}\r\nsensor->mmio_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(sensor->mmio_base)) {\r\ndev_err(dev, "failed to remap IO\n");\r\nreturn PTR_ERR(sensor->mmio_base);\r\n}\r\nsensor->regmap = devm_regmap_init_mmio(dev, sensor->mmio_base,\r\n&st_416mpe_regmap_config);\r\nif (IS_ERR(sensor->regmap)) {\r\ndev_err(dev, "failed to initialise regmap\n");\r\nreturn PTR_ERR(sensor->regmap);\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_mmap_probe(struct platform_device *pdev)\r\n{\r\nreturn st_thermal_register(pdev, st_mmap_thermal_of_match);\r\n}\r\nstatic int st_mmap_remove(struct platform_device *pdev)\r\n{\r\nreturn st_thermal_unregister(pdev);\r\n}

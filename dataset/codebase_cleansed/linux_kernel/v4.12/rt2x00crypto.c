enum cipher rt2x00crypto_key_to_cipher(struct ieee80211_key_conf *key)\r\n{\r\nswitch (key->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\nreturn CIPHER_WEP64;\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nreturn CIPHER_WEP128;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nreturn CIPHER_TKIP;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\nreturn CIPHER_AES;\r\ndefault:\r\nreturn CIPHER_NONE;\r\n}\r\n}\r\nvoid rt2x00crypto_create_tx_descriptor(struct rt2x00_dev *rt2x00dev,\r\nstruct sk_buff *skb,\r\nstruct txentry_desc *txdesc)\r\n{\r\nstruct ieee80211_tx_info *tx_info = IEEE80211_SKB_CB(skb);\r\nstruct ieee80211_key_conf *hw_key = tx_info->control.hw_key;\r\nif (!rt2x00_has_cap_hw_crypto(rt2x00dev) || !hw_key)\r\nreturn;\r\n__set_bit(ENTRY_TXD_ENCRYPT, &txdesc->flags);\r\ntxdesc->cipher = rt2x00crypto_key_to_cipher(hw_key);\r\nif (hw_key->flags & IEEE80211_KEY_FLAG_PAIRWISE)\r\n__set_bit(ENTRY_TXD_ENCRYPT_PAIRWISE, &txdesc->flags);\r\ntxdesc->key_idx = hw_key->hw_key_idx;\r\ntxdesc->iv_offset = txdesc->header_length;\r\ntxdesc->iv_len = hw_key->iv_len;\r\nif (!(hw_key->flags & IEEE80211_KEY_FLAG_GENERATE_IV))\r\n__set_bit(ENTRY_TXD_ENCRYPT_IV, &txdesc->flags);\r\nif (!(hw_key->flags & IEEE80211_KEY_FLAG_GENERATE_MMIC))\r\n__set_bit(ENTRY_TXD_ENCRYPT_MMIC, &txdesc->flags);\r\n}\r\nunsigned int rt2x00crypto_tx_overhead(struct rt2x00_dev *rt2x00dev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct ieee80211_tx_info *tx_info = IEEE80211_SKB_CB(skb);\r\nstruct ieee80211_key_conf *key = tx_info->control.hw_key;\r\nunsigned int overhead = 0;\r\nif (!rt2x00_has_cap_hw_crypto(rt2x00dev) || !key)\r\nreturn overhead;\r\noverhead += key->icv_len;\r\nif (!(key->flags & IEEE80211_KEY_FLAG_GENERATE_IV))\r\noverhead += key->iv_len;\r\nif (!(key->flags & IEEE80211_KEY_FLAG_GENERATE_MMIC)) {\r\nif (key->cipher == WLAN_CIPHER_SUITE_TKIP)\r\noverhead += 8;\r\n}\r\nreturn overhead;\r\n}\r\nvoid rt2x00crypto_tx_copy_iv(struct sk_buff *skb, struct txentry_desc *txdesc)\r\n{\r\nstruct skb_frame_desc *skbdesc = get_skb_frame_desc(skb);\r\nif (unlikely(!txdesc->iv_len))\r\nreturn;\r\nmemcpy(skbdesc->iv, skb->data + txdesc->iv_offset, txdesc->iv_len);\r\n}\r\nvoid rt2x00crypto_tx_remove_iv(struct sk_buff *skb, struct txentry_desc *txdesc)\r\n{\r\nstruct skb_frame_desc *skbdesc = get_skb_frame_desc(skb);\r\nif (unlikely(!txdesc->iv_len))\r\nreturn;\r\nmemcpy(skbdesc->iv, skb->data + txdesc->iv_offset, txdesc->iv_len);\r\nmemmove(skb->data + txdesc->iv_len, skb->data, txdesc->iv_offset);\r\nskb_pull(skb, txdesc->iv_len);\r\ntxdesc->length -= txdesc->iv_len;\r\nskbdesc->flags |= SKBDESC_IV_STRIPPED;\r\n}\r\nvoid rt2x00crypto_tx_insert_iv(struct sk_buff *skb, unsigned int header_length)\r\n{\r\nstruct skb_frame_desc *skbdesc = get_skb_frame_desc(skb);\r\nconst unsigned int iv_len =\r\n((!!(skbdesc->iv[0])) * 4) + ((!!(skbdesc->iv[1])) * 4);\r\nif (!(skbdesc->flags & SKBDESC_IV_STRIPPED))\r\nreturn;\r\nskb_push(skb, iv_len);\r\nmemmove(skb->data, skb->data + iv_len, header_length);\r\nmemcpy(skb->data + header_length, skbdesc->iv, iv_len);\r\nskbdesc->flags &= ~SKBDESC_IV_STRIPPED;\r\n}\r\nvoid rt2x00crypto_rx_insert_iv(struct sk_buff *skb,\r\nunsigned int header_length,\r\nstruct rxdone_entry_desc *rxdesc)\r\n{\r\nunsigned int payload_len = rxdesc->size - header_length;\r\nunsigned int align = ALIGN_SIZE(skb, header_length);\r\nunsigned int iv_len;\r\nunsigned int icv_len;\r\nunsigned int transfer = 0;\r\nswitch (rxdesc->cipher) {\r\ncase CIPHER_WEP64:\r\ncase CIPHER_WEP128:\r\niv_len = 4;\r\nicv_len = 4;\r\nbreak;\r\ncase CIPHER_TKIP:\r\niv_len = 8;\r\nicv_len = 4;\r\nbreak;\r\ncase CIPHER_AES:\r\niv_len = 8;\r\nicv_len = 8;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nif (rxdesc->dev_flags & RXDONE_L2PAD) {\r\nskb_push(skb, iv_len - align);\r\nskb_put(skb, icv_len);\r\nmemmove(skb->data + transfer,\r\nskb->data + transfer + (iv_len - align),\r\nheader_length);\r\ntransfer += header_length;\r\n} else {\r\nskb_push(skb, iv_len + align);\r\nif (align < icv_len)\r\nskb_put(skb, icv_len - align);\r\nelse if (align > icv_len)\r\nskb_trim(skb, rxdesc->size + iv_len + icv_len);\r\nmemmove(skb->data + transfer,\r\nskb->data + transfer + iv_len + align,\r\nheader_length);\r\ntransfer += header_length;\r\n}\r\nmemcpy(skb->data + transfer, rxdesc->iv, iv_len);\r\ntransfer += iv_len;\r\nif (!(rxdesc->dev_flags & RXDONE_L2PAD)) {\r\nmemmove(skb->data + transfer,\r\nskb->data + transfer + align,\r\npayload_len);\r\n}\r\ntransfer += payload_len;\r\nmemcpy(skb->data + transfer, &rxdesc->icv, 4);\r\ntransfer += icv_len;\r\nrxdesc->size = transfer;\r\nrxdesc->flags &= ~RX_FLAG_IV_STRIPPED;\r\n}

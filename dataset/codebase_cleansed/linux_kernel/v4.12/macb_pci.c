static int macb_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nint err;\r\nstruct platform_device *plat_dev;\r\nstruct platform_device_info plat_info;\r\nstruct macb_platform_data plat_data;\r\nstruct resource res[2];\r\nerr = pcim_enable_device(pdev);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "Enabling PCI device has failed: %d", err);\r\nreturn err;\r\n}\r\npci_set_master(pdev);\r\nmemset(res, 0x00, sizeof(struct resource) * ARRAY_SIZE(res));\r\nres[0].start = pci_resource_start(pdev, 0);\r\nres[0].end = pci_resource_end(pdev, 0);\r\nres[0].name = PCI_DRIVER_NAME;\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].start = pci_irq_vector(pdev, 0);\r\nres[1].name = PCI_DRIVER_NAME;\r\nres[1].flags = IORESOURCE_IRQ;\r\ndev_info(&pdev->dev, "EMAC physical base addr: %pa\n",\r\n&res[0].start);\r\nmemset(&plat_data, 0, sizeof(plat_data));\r\nplat_data.pclk = clk_register_fixed_rate(&pdev->dev, "pclk", NULL, 0,\r\nGEM_PCLK_RATE);\r\nif (IS_ERR(plat_data.pclk)) {\r\nerr = PTR_ERR(plat_data.pclk);\r\ngoto err_pclk_register;\r\n}\r\nplat_data.hclk = clk_register_fixed_rate(&pdev->dev, "hclk", NULL, 0,\r\nGEM_HCLK_RATE);\r\nif (IS_ERR(plat_data.hclk)) {\r\nerr = PTR_ERR(plat_data.hclk);\r\ngoto err_hclk_register;\r\n}\r\nmemset(&plat_info, 0, sizeof(plat_info));\r\nplat_info.parent = &pdev->dev;\r\nplat_info.fwnode = pdev->dev.fwnode;\r\nplat_info.name = PLAT_DRIVER_NAME;\r\nplat_info.id = pdev->devfn;\r\nplat_info.res = res;\r\nplat_info.num_res = ARRAY_SIZE(res);\r\nplat_info.data = &plat_data;\r\nplat_info.size_data = sizeof(plat_data);\r\nplat_info.dma_mask = pdev->dma_mask;\r\nplat_dev = platform_device_register_full(&plat_info);\r\nif (IS_ERR(plat_dev)) {\r\nerr = PTR_ERR(plat_dev);\r\ngoto err_plat_dev_register;\r\n}\r\npci_set_drvdata(pdev, plat_dev);\r\nreturn 0;\r\nerr_plat_dev_register:\r\nclk_unregister(plat_data.hclk);\r\nerr_hclk_register:\r\nclk_unregister(plat_data.pclk);\r\nerr_pclk_register:\r\nreturn err;\r\n}\r\nstatic void macb_remove(struct pci_dev *pdev)\r\n{\r\nstruct platform_device *plat_dev = pci_get_drvdata(pdev);\r\nstruct macb_platform_data *plat_data = dev_get_platdata(&plat_dev->dev);\r\nplatform_device_unregister(plat_dev);\r\nclk_unregister(plat_data->pclk);\r\nclk_unregister(plat_data->hclk);\r\n}

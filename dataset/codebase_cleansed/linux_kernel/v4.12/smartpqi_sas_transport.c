static struct pqi_sas_phy *pqi_alloc_sas_phy(struct pqi_sas_port *pqi_sas_port)\r\n{\r\nstruct pqi_sas_phy *pqi_sas_phy;\r\nstruct sas_phy *phy;\r\npqi_sas_phy = kzalloc(sizeof(*pqi_sas_phy), GFP_KERNEL);\r\nif (!pqi_sas_phy)\r\nreturn NULL;\r\nphy = sas_phy_alloc(pqi_sas_port->parent_node->parent_dev,\r\npqi_sas_port->next_phy_index);\r\nif (!phy) {\r\nkfree(pqi_sas_phy);\r\nreturn NULL;\r\n}\r\npqi_sas_port->next_phy_index++;\r\npqi_sas_phy->phy = phy;\r\npqi_sas_phy->parent_port = pqi_sas_port;\r\nreturn pqi_sas_phy;\r\n}\r\nstatic void pqi_free_sas_phy(struct pqi_sas_phy *pqi_sas_phy)\r\n{\r\nstruct sas_phy *phy = pqi_sas_phy->phy;\r\nsas_port_delete_phy(pqi_sas_phy->parent_port->port, phy);\r\nsas_phy_free(phy);\r\nif (pqi_sas_phy->added_to_port)\r\nlist_del(&pqi_sas_phy->phy_list_entry);\r\nkfree(pqi_sas_phy);\r\n}\r\nstatic int pqi_sas_port_add_phy(struct pqi_sas_phy *pqi_sas_phy)\r\n{\r\nint rc;\r\nstruct pqi_sas_port *pqi_sas_port;\r\nstruct sas_phy *phy;\r\nstruct sas_identify *identify;\r\npqi_sas_port = pqi_sas_phy->parent_port;\r\nphy = pqi_sas_phy->phy;\r\nidentify = &phy->identify;\r\nmemset(identify, 0, sizeof(*identify));\r\nidentify->sas_address = pqi_sas_port->sas_address;\r\nidentify->device_type = SAS_END_DEVICE;\r\nidentify->initiator_port_protocols = SAS_PROTOCOL_STP;\r\nidentify->target_port_protocols = SAS_PROTOCOL_STP;\r\nphy->minimum_linkrate_hw = SAS_LINK_RATE_UNKNOWN;\r\nphy->maximum_linkrate_hw = SAS_LINK_RATE_UNKNOWN;\r\nphy->minimum_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nphy->maximum_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nphy->negotiated_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nrc = sas_phy_add(pqi_sas_phy->phy);\r\nif (rc)\r\nreturn rc;\r\nsas_port_add_phy(pqi_sas_port->port, pqi_sas_phy->phy);\r\nlist_add_tail(&pqi_sas_phy->phy_list_entry,\r\n&pqi_sas_port->phy_list_head);\r\npqi_sas_phy->added_to_port = true;\r\nreturn 0;\r\n}\r\nstatic int pqi_sas_port_add_rphy(struct pqi_sas_port *pqi_sas_port,\r\nstruct sas_rphy *rphy)\r\n{\r\nstruct sas_identify *identify;\r\nidentify = &rphy->identify;\r\nidentify->sas_address = pqi_sas_port->sas_address;\r\nidentify->initiator_port_protocols = SAS_PROTOCOL_STP;\r\nidentify->target_port_protocols = SAS_PROTOCOL_STP;\r\nreturn sas_rphy_add(rphy);\r\n}\r\nstatic struct pqi_sas_port *pqi_alloc_sas_port(\r\nstruct pqi_sas_node *pqi_sas_node, u64 sas_address)\r\n{\r\nint rc;\r\nstruct pqi_sas_port *pqi_sas_port;\r\nstruct sas_port *port;\r\npqi_sas_port = kzalloc(sizeof(*pqi_sas_port), GFP_KERNEL);\r\nif (!pqi_sas_port)\r\nreturn NULL;\r\nINIT_LIST_HEAD(&pqi_sas_port->phy_list_head);\r\npqi_sas_port->parent_node = pqi_sas_node;\r\nport = sas_port_alloc_num(pqi_sas_node->parent_dev);\r\nif (!port)\r\ngoto free_pqi_port;\r\nrc = sas_port_add(port);\r\nif (rc)\r\ngoto free_sas_port;\r\npqi_sas_port->port = port;\r\npqi_sas_port->sas_address = sas_address;\r\nlist_add_tail(&pqi_sas_port->port_list_entry,\r\n&pqi_sas_node->port_list_head);\r\nreturn pqi_sas_port;\r\nfree_sas_port:\r\nsas_port_free(port);\r\nfree_pqi_port:\r\nkfree(pqi_sas_port);\r\nreturn NULL;\r\n}\r\nstatic void pqi_free_sas_port(struct pqi_sas_port *pqi_sas_port)\r\n{\r\nstruct pqi_sas_phy *pqi_sas_phy;\r\nstruct pqi_sas_phy *next;\r\nlist_for_each_entry_safe(pqi_sas_phy, next,\r\n&pqi_sas_port->phy_list_head, phy_list_entry)\r\npqi_free_sas_phy(pqi_sas_phy);\r\nsas_port_delete(pqi_sas_port->port);\r\nlist_del(&pqi_sas_port->port_list_entry);\r\nkfree(pqi_sas_port);\r\n}\r\nstatic struct pqi_sas_node *pqi_alloc_sas_node(struct device *parent_dev)\r\n{\r\nstruct pqi_sas_node *pqi_sas_node;\r\npqi_sas_node = kzalloc(sizeof(*pqi_sas_node), GFP_KERNEL);\r\nif (pqi_sas_node) {\r\npqi_sas_node->parent_dev = parent_dev;\r\nINIT_LIST_HEAD(&pqi_sas_node->port_list_head);\r\n}\r\nreturn pqi_sas_node;\r\n}\r\nstatic void pqi_free_sas_node(struct pqi_sas_node *pqi_sas_node)\r\n{\r\nstruct pqi_sas_port *pqi_sas_port;\r\nstruct pqi_sas_port *next;\r\nif (!pqi_sas_node)\r\nreturn;\r\nlist_for_each_entry_safe(pqi_sas_port, next,\r\n&pqi_sas_node->port_list_head, port_list_entry)\r\npqi_free_sas_port(pqi_sas_port);\r\nkfree(pqi_sas_node);\r\n}\r\nstruct pqi_scsi_dev *pqi_find_device_by_sas_rphy(\r\nstruct pqi_ctrl_info *ctrl_info, struct sas_rphy *rphy)\r\n{\r\nstruct pqi_scsi_dev *device;\r\nlist_for_each_entry(device, &ctrl_info->scsi_device_list,\r\nscsi_device_list_entry) {\r\nif (!device->sas_port)\r\ncontinue;\r\nif (device->sas_port->rphy == rphy)\r\nreturn device;\r\n}\r\nreturn NULL;\r\n}\r\nint pqi_add_sas_host(struct Scsi_Host *shost, struct pqi_ctrl_info *ctrl_info)\r\n{\r\nint rc;\r\nstruct device *parent_dev;\r\nstruct pqi_sas_node *pqi_sas_node;\r\nstruct pqi_sas_port *pqi_sas_port;\r\nstruct pqi_sas_phy *pqi_sas_phy;\r\nparent_dev = &shost->shost_gendev;\r\npqi_sas_node = pqi_alloc_sas_node(parent_dev);\r\nif (!pqi_sas_node)\r\nreturn -ENOMEM;\r\npqi_sas_port = pqi_alloc_sas_port(pqi_sas_node, ctrl_info->sas_address);\r\nif (!pqi_sas_port) {\r\nrc = -ENODEV;\r\ngoto free_sas_node;\r\n}\r\npqi_sas_phy = pqi_alloc_sas_phy(pqi_sas_port);\r\nif (!pqi_sas_phy) {\r\nrc = -ENODEV;\r\ngoto free_sas_port;\r\n}\r\nrc = pqi_sas_port_add_phy(pqi_sas_phy);\r\nif (rc)\r\ngoto free_sas_phy;\r\nctrl_info->sas_host = pqi_sas_node;\r\nreturn 0;\r\nfree_sas_phy:\r\npqi_free_sas_phy(pqi_sas_phy);\r\nfree_sas_port:\r\npqi_free_sas_port(pqi_sas_port);\r\nfree_sas_node:\r\npqi_free_sas_node(pqi_sas_node);\r\nreturn rc;\r\n}\r\nvoid pqi_delete_sas_host(struct pqi_ctrl_info *ctrl_info)\r\n{\r\npqi_free_sas_node(ctrl_info->sas_host);\r\n}\r\nint pqi_add_sas_device(struct pqi_sas_node *pqi_sas_node,\r\nstruct pqi_scsi_dev *device)\r\n{\r\nint rc;\r\nstruct pqi_sas_port *pqi_sas_port;\r\nstruct sas_rphy *rphy;\r\npqi_sas_port = pqi_alloc_sas_port(pqi_sas_node, device->sas_address);\r\nif (!pqi_sas_port)\r\nreturn -ENOMEM;\r\nrphy = sas_end_device_alloc(pqi_sas_port->port);\r\nif (!rphy) {\r\nrc = -ENODEV;\r\ngoto free_sas_port;\r\n}\r\npqi_sas_port->rphy = rphy;\r\ndevice->sas_port = pqi_sas_port;\r\nrc = pqi_sas_port_add_rphy(pqi_sas_port, rphy);\r\nif (rc)\r\ngoto free_sas_port;\r\nreturn 0;\r\nfree_sas_port:\r\npqi_free_sas_port(pqi_sas_port);\r\ndevice->sas_port = NULL;\r\nreturn rc;\r\n}\r\nvoid pqi_remove_sas_device(struct pqi_scsi_dev *device)\r\n{\r\nif (device->sas_port) {\r\npqi_free_sas_port(device->sas_port);\r\ndevice->sas_port = NULL;\r\n}\r\n}\r\nstatic int pqi_sas_get_linkerrors(struct sas_phy *phy)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pqi_sas_get_enclosure_identifier(struct sas_rphy *rphy,\r\nu64 *identifier)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pqi_sas_get_bay_identifier(struct sas_rphy *rphy)\r\n{\r\nreturn -ENXIO;\r\n}\r\nstatic int pqi_sas_phy_reset(struct sas_phy *phy, int hard_reset)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pqi_sas_phy_enable(struct sas_phy *phy, int enable)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pqi_sas_phy_setup(struct sas_phy *phy)\r\n{\r\nreturn 0;\r\n}\r\nstatic void pqi_sas_phy_release(struct sas_phy *phy)\r\n{\r\n}\r\nstatic int pqi_sas_phy_speed(struct sas_phy *phy,\r\nstruct sas_phy_linkrates *rates)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int pqi_sas_smp_handler(struct Scsi_Host *shost, struct sas_rphy *rphy,\r\nstruct request *req)\r\n{\r\nreturn -EINVAL;\r\n}

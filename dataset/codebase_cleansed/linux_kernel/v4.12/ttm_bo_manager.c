static int ttm_bo_man_get_node(struct ttm_mem_type_manager *man,\r\nstruct ttm_buffer_object *bo,\r\nconst struct ttm_place *place,\r\nstruct ttm_mem_reg *mem)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nstruct drm_mm *mm = &rman->mm;\r\nstruct drm_mm_node *node;\r\nenum drm_mm_insert_mode mode;\r\nunsigned long lpfn;\r\nint ret;\r\nlpfn = place->lpfn;\r\nif (!lpfn)\r\nlpfn = man->size;\r\nnode = kzalloc(sizeof(*node), GFP_KERNEL);\r\nif (!node)\r\nreturn -ENOMEM;\r\nmode = DRM_MM_INSERT_BEST;\r\nif (place->flags & TTM_PL_FLAG_TOPDOWN)\r\nmode = DRM_MM_INSERT_HIGH;\r\nspin_lock(&rman->lock);\r\nret = drm_mm_insert_node_in_range(mm, node,\r\nmem->num_pages,\r\nmem->page_alignment, 0,\r\nplace->fpfn, lpfn, mode);\r\nspin_unlock(&rman->lock);\r\nif (unlikely(ret)) {\r\nkfree(node);\r\n} else {\r\nmem->mm_node = node;\r\nmem->start = node->start;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ttm_bo_man_put_node(struct ttm_mem_type_manager *man,\r\nstruct ttm_mem_reg *mem)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nif (mem->mm_node) {\r\nspin_lock(&rman->lock);\r\ndrm_mm_remove_node(mem->mm_node);\r\nspin_unlock(&rman->lock);\r\nkfree(mem->mm_node);\r\nmem->mm_node = NULL;\r\n}\r\n}\r\nstatic int ttm_bo_man_init(struct ttm_mem_type_manager *man,\r\nunsigned long p_size)\r\n{\r\nstruct ttm_range_manager *rman;\r\nrman = kzalloc(sizeof(*rman), GFP_KERNEL);\r\nif (!rman)\r\nreturn -ENOMEM;\r\ndrm_mm_init(&rman->mm, 0, p_size);\r\nspin_lock_init(&rman->lock);\r\nman->priv = rman;\r\nreturn 0;\r\n}\r\nstatic int ttm_bo_man_takedown(struct ttm_mem_type_manager *man)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nstruct drm_mm *mm = &rman->mm;\r\nspin_lock(&rman->lock);\r\nif (drm_mm_clean(mm)) {\r\ndrm_mm_takedown(mm);\r\nspin_unlock(&rman->lock);\r\nkfree(rman);\r\nman->priv = NULL;\r\nreturn 0;\r\n}\r\nspin_unlock(&rman->lock);\r\nreturn -EBUSY;\r\n}\r\nstatic void ttm_bo_man_debug(struct ttm_mem_type_manager *man,\r\nconst char *prefix)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nstruct drm_printer p = drm_debug_printer(prefix);\r\nspin_lock(&rman->lock);\r\ndrm_mm_print(&rman->mm, &p);\r\nspin_unlock(&rman->lock);\r\n}

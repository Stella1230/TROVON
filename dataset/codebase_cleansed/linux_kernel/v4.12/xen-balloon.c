static void watch_target(struct xenbus_watch *watch,\r\nconst char *path, const char *token)\r\n{\r\nunsigned long long new_target;\r\nint err;\r\nerr = xenbus_scanf(XBT_NIL, "memory", "target", "%llu", &new_target);\r\nif (err != 1) {\r\nreturn;\r\n}\r\nballoon_set_new_target(new_target >> (PAGE_SHIFT - 10));\r\n}\r\nstatic int balloon_init_watcher(struct notifier_block *notifier,\r\nunsigned long event,\r\nvoid *data)\r\n{\r\nint err;\r\nerr = register_xenbus_watch(&target_watch);\r\nif (err)\r\npr_err("Failed to set balloon watcher\n");\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init balloon_init(void)\r\n{\r\nif (!xen_domain())\r\nreturn -ENODEV;\r\npr_info("Initialising balloon driver\n");\r\nregister_balloon(&balloon_dev);\r\nregister_xen_selfballooning(&balloon_dev);\r\nregister_xenstore_notifier(&xenstore_notifier);\r\nreturn 0;\r\n}\r\nstatic ssize_t show_target_kb(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%lu\n", PAGES2KB(balloon_stats.target_pages));\r\n}\r\nstatic ssize_t store_target_kb(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nchar *endchar;\r\nunsigned long long target_bytes;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\ntarget_bytes = simple_strtoull(buf, &endchar, 0) * 1024;\r\nballoon_set_new_target(target_bytes >> PAGE_SHIFT);\r\nreturn count;\r\n}\r\nstatic ssize_t show_target(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%llu\n",\r\n(unsigned long long)balloon_stats.target_pages\r\n<< PAGE_SHIFT);\r\n}\r\nstatic ssize_t store_target(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nchar *endchar;\r\nunsigned long long target_bytes;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\ntarget_bytes = memparse(buf, &endchar);\r\nballoon_set_new_target(target_bytes >> PAGE_SHIFT);\r\nreturn count;\r\n}\r\nstatic int register_balloon(struct device *dev)\r\n{\r\nint error;\r\nerror = subsys_system_register(&balloon_subsys, NULL);\r\nif (error)\r\nreturn error;\r\ndev->id = 0;\r\ndev->bus = &balloon_subsys;\r\ndev->groups = balloon_groups;\r\nerror = device_register(dev);\r\nif (error) {\r\nbus_unregister(&balloon_subsys);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

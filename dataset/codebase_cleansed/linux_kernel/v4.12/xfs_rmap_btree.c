static struct xfs_btree_cur *\r\nxfs_rmapbt_dup_cursor(\r\nstruct xfs_btree_cur *cur)\r\n{\r\nreturn xfs_rmapbt_init_cursor(cur->bc_mp, cur->bc_tp,\r\ncur->bc_private.a.agbp, cur->bc_private.a.agno);\r\n}\r\nSTATIC void\r\nxfs_rmapbt_set_root(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr,\r\nint inc)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nxfs_agnumber_t seqno = be32_to_cpu(agf->agf_seqno);\r\nint btnum = cur->bc_btnum;\r\nstruct xfs_perag *pag = xfs_perag_get(cur->bc_mp, seqno);\r\nASSERT(ptr->s != 0);\r\nagf->agf_roots[btnum] = ptr->s;\r\nbe32_add_cpu(&agf->agf_levels[btnum], inc);\r\npag->pagf_levels[btnum] += inc;\r\nxfs_perag_put(pag);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_ROOTS | XFS_AGF_LEVELS);\r\n}\r\nSTATIC int\r\nxfs_rmapbt_alloc_block(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *start,\r\nunion xfs_btree_ptr *new,\r\nint *stat)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nint error;\r\nxfs_agblock_t bno;\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ENTRY);\r\nerror = xfs_alloc_get_freelist(cur->bc_tp, cur->bc_private.a.agbp,\r\n&bno, 1);\r\nif (error) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ERROR);\r\nreturn error;\r\n}\r\ntrace_xfs_rmapbt_alloc_block(cur->bc_mp, cur->bc_private.a.agno,\r\nbno, 1);\r\nif (bno == NULLAGBLOCK) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 0;\r\nreturn 0;\r\n}\r\nxfs_extent_busy_reuse(cur->bc_mp, cur->bc_private.a.agno, bno, 1,\r\nfalse);\r\nxfs_trans_agbtree_delta(cur->bc_tp, 1);\r\nnew->s = cpu_to_be32(bno);\r\nbe32_add_cpu(&agf->agf_rmap_blocks, 1);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_RMAP_BLOCKS);\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rmapbt_free_block(\r\nstruct xfs_btree_cur *cur,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nxfs_agblock_t bno;\r\nint error;\r\nbno = xfs_daddr_to_agbno(cur->bc_mp, XFS_BUF_ADDR(bp));\r\ntrace_xfs_rmapbt_free_block(cur->bc_mp, cur->bc_private.a.agno,\r\nbno, 1);\r\nbe32_add_cpu(&agf->agf_rmap_blocks, -1);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_RMAP_BLOCKS);\r\nerror = xfs_alloc_put_freelist(cur->bc_tp, agbp, NULL, bno, 1);\r\nif (error)\r\nreturn error;\r\nxfs_extent_busy_insert(cur->bc_tp, be32_to_cpu(agf->agf_seqno), bno, 1,\r\nXFS_EXTENT_BUSY_SKIP_DISCARD);\r\nxfs_trans_agbtree_delta(cur->bc_tp, -1);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rmapbt_get_minrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_rmap_mnr[level != 0];\r\n}\r\nSTATIC int\r\nxfs_rmapbt_get_maxrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_rmap_mxr[level != 0];\r\n}\r\nSTATIC void\r\nxfs_rmapbt_init_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nkey->rmap.rm_startblock = rec->rmap.rm_startblock;\r\nkey->rmap.rm_owner = rec->rmap.rm_owner;\r\nkey->rmap.rm_offset = rec->rmap.rm_offset;\r\n}\r\nSTATIC void\r\nxfs_rmapbt_init_high_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\n__uint64_t off;\r\nint adj;\r\nadj = be32_to_cpu(rec->rmap.rm_blockcount) - 1;\r\nkey->rmap.rm_startblock = rec->rmap.rm_startblock;\r\nbe32_add_cpu(&key->rmap.rm_startblock, adj);\r\nkey->rmap.rm_owner = rec->rmap.rm_owner;\r\nkey->rmap.rm_offset = rec->rmap.rm_offset;\r\nif (XFS_RMAP_NON_INODE_OWNER(be64_to_cpu(rec->rmap.rm_owner)) ||\r\nXFS_RMAP_IS_BMBT_BLOCK(be64_to_cpu(rec->rmap.rm_offset)))\r\nreturn;\r\noff = be64_to_cpu(key->rmap.rm_offset);\r\noff = (XFS_RMAP_OFF(off) + adj) | (off & ~XFS_RMAP_OFF_MASK);\r\nkey->rmap.rm_offset = cpu_to_be64(off);\r\n}\r\nSTATIC void\r\nxfs_rmapbt_init_rec_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *rec)\r\n{\r\nrec->rmap.rm_startblock = cpu_to_be32(cur->bc_rec.r.rm_startblock);\r\nrec->rmap.rm_blockcount = cpu_to_be32(cur->bc_rec.r.rm_blockcount);\r\nrec->rmap.rm_owner = cpu_to_be64(cur->bc_rec.r.rm_owner);\r\nrec->rmap.rm_offset = cpu_to_be64(\r\nxfs_rmap_irec_offset_pack(&cur->bc_rec.r));\r\n}\r\nSTATIC void\r\nxfs_rmapbt_init_ptr_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr)\r\n{\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(cur->bc_private.a.agbp);\r\nASSERT(cur->bc_private.a.agno == be32_to_cpu(agf->agf_seqno));\r\nASSERT(agf->agf_roots[cur->bc_btnum] != 0);\r\nptr->s = agf->agf_roots[cur->bc_btnum];\r\n}\r\nSTATIC __int64_t\r\nxfs_rmapbt_key_diff(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *key)\r\n{\r\nstruct xfs_rmap_irec *rec = &cur->bc_rec.r;\r\nstruct xfs_rmap_key *kp = &key->rmap;\r\n__u64 x, y;\r\n__int64_t d;\r\nd = (__int64_t)be32_to_cpu(kp->rm_startblock) - rec->rm_startblock;\r\nif (d)\r\nreturn d;\r\nx = be64_to_cpu(kp->rm_owner);\r\ny = rec->rm_owner;\r\nif (x > y)\r\nreturn 1;\r\nelse if (y > x)\r\nreturn -1;\r\nx = XFS_RMAP_OFF(be64_to_cpu(kp->rm_offset));\r\ny = rec->rm_offset;\r\nif (x > y)\r\nreturn 1;\r\nelse if (y > x)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nSTATIC __int64_t\r\nxfs_rmapbt_diff_two_keys(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\nstruct xfs_rmap_key *kp1 = &k1->rmap;\r\nstruct xfs_rmap_key *kp2 = &k2->rmap;\r\n__int64_t d;\r\n__u64 x, y;\r\nd = (__int64_t)be32_to_cpu(kp1->rm_startblock) -\r\nbe32_to_cpu(kp2->rm_startblock);\r\nif (d)\r\nreturn d;\r\nx = be64_to_cpu(kp1->rm_owner);\r\ny = be64_to_cpu(kp2->rm_owner);\r\nif (x > y)\r\nreturn 1;\r\nelse if (y > x)\r\nreturn -1;\r\nx = XFS_RMAP_OFF(be64_to_cpu(kp1->rm_offset));\r\ny = XFS_RMAP_OFF(be64_to_cpu(kp2->rm_offset));\r\nif (x > y)\r\nreturn 1;\r\nelse if (y > x)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic bool\r\nxfs_rmapbt_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_btree_block *block = XFS_BUF_TO_BLOCK(bp);\r\nstruct xfs_perag *pag = bp->b_pag;\r\nunsigned int level;\r\nif (block->bb_magic != cpu_to_be32(XFS_RMAP_CRC_MAGIC))\r\nreturn false;\r\nif (!xfs_sb_version_hasrmapbt(&mp->m_sb))\r\nreturn false;\r\nif (!xfs_btree_sblock_v5hdr_verify(bp))\r\nreturn false;\r\nlevel = be16_to_cpu(block->bb_level);\r\nif (pag && pag->pagf_init) {\r\nif (level >= pag->pagf_levels[XFS_BTNUM_RMAPi])\r\nreturn false;\r\n} else if (level >= mp->m_rmap_maxlevels)\r\nreturn false;\r\nreturn xfs_btree_sblock_verify(bp, mp->m_rmap_mxr[level != 0]);\r\n}\r\nstatic void\r\nxfs_rmapbt_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_btree_sblock_verify_crc(bp))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_rmapbt_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_verifier_error(bp);\r\n}\r\n}\r\nstatic void\r\nxfs_rmapbt_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_rmapbt_verify(bp)) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nxfs_btree_sblock_calc_crc(bp);\r\n}\r\nSTATIC int\r\nxfs_rmapbt_keys_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\n__uint32_t x;\r\n__uint32_t y;\r\n__uint64_t a;\r\n__uint64_t b;\r\nx = be32_to_cpu(k1->rmap.rm_startblock);\r\ny = be32_to_cpu(k2->rmap.rm_startblock);\r\nif (x < y)\r\nreturn 1;\r\nelse if (x > y)\r\nreturn 0;\r\na = be64_to_cpu(k1->rmap.rm_owner);\r\nb = be64_to_cpu(k2->rmap.rm_owner);\r\nif (a < b)\r\nreturn 1;\r\nelse if (a > b)\r\nreturn 0;\r\na = XFS_RMAP_OFF(be64_to_cpu(k1->rmap.rm_offset));\r\nb = XFS_RMAP_OFF(be64_to_cpu(k2->rmap.rm_offset));\r\nif (a <= b)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rmapbt_recs_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *r1,\r\nunion xfs_btree_rec *r2)\r\n{\r\n__uint32_t x;\r\n__uint32_t y;\r\n__uint64_t a;\r\n__uint64_t b;\r\nx = be32_to_cpu(r1->rmap.rm_startblock);\r\ny = be32_to_cpu(r2->rmap.rm_startblock);\r\nif (x < y)\r\nreturn 1;\r\nelse if (x > y)\r\nreturn 0;\r\na = be64_to_cpu(r1->rmap.rm_owner);\r\nb = be64_to_cpu(r2->rmap.rm_owner);\r\nif (a < b)\r\nreturn 1;\r\nelse if (a > b)\r\nreturn 0;\r\na = XFS_RMAP_OFF(be64_to_cpu(r1->rmap.rm_offset));\r\nb = XFS_RMAP_OFF(be64_to_cpu(r2->rmap.rm_offset));\r\nif (a <= b)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstruct xfs_btree_cur *\r\nxfs_rmapbt_init_cursor(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *agbp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nstruct xfs_btree_cur *cur;\r\ncur = kmem_zone_zalloc(xfs_btree_cur_zone, KM_NOFS);\r\ncur->bc_tp = tp;\r\ncur->bc_mp = mp;\r\ncur->bc_btnum = XFS_BTNUM_RMAP;\r\ncur->bc_flags = XFS_BTREE_CRC_BLOCKS | XFS_BTREE_OVERLAPPING;\r\ncur->bc_blocklog = mp->m_sb.sb_blocklog;\r\ncur->bc_ops = &xfs_rmapbt_ops;\r\ncur->bc_nlevels = be32_to_cpu(agf->agf_levels[XFS_BTNUM_RMAP]);\r\ncur->bc_statoff = XFS_STATS_CALC_INDEX(xs_rmap_2);\r\ncur->bc_private.a.agbp = agbp;\r\ncur->bc_private.a.agno = agno;\r\nreturn cur;\r\n}\r\nint\r\nxfs_rmapbt_maxrecs(\r\nstruct xfs_mount *mp,\r\nint blocklen,\r\nint leaf)\r\n{\r\nblocklen -= XFS_RMAP_BLOCK_LEN;\r\nif (leaf)\r\nreturn blocklen / sizeof(struct xfs_rmap_rec);\r\nreturn blocklen /\r\n(2 * sizeof(struct xfs_rmap_key) + sizeof(xfs_rmap_ptr_t));\r\n}\r\nvoid\r\nxfs_rmapbt_compute_maxlevels(\r\nstruct xfs_mount *mp)\r\n{\r\nif (xfs_sb_version_hasreflink(&mp->m_sb))\r\nmp->m_rmap_maxlevels = XFS_BTREE_MAXLEVELS;\r\nelse\r\nmp->m_rmap_maxlevels = xfs_btree_compute_maxlevels(mp,\r\nmp->m_rmap_mnr, mp->m_sb.sb_agblocks);\r\n}\r\nxfs_extlen_t\r\nxfs_rmapbt_calc_size(\r\nstruct xfs_mount *mp,\r\nunsigned long long len)\r\n{\r\nreturn xfs_btree_calc_size(mp, mp->m_rmap_mnr, len);\r\n}\r\nxfs_extlen_t\r\nxfs_rmapbt_max_size(\r\nstruct xfs_mount *mp,\r\nxfs_agblock_t agblocks)\r\n{\r\nif (mp->m_rmap_mxr[0] == 0)\r\nreturn 0;\r\nreturn xfs_rmapbt_calc_size(mp, agblocks);\r\n}\r\nint\r\nxfs_rmapbt_calc_reserves(\r\nstruct xfs_mount *mp,\r\nxfs_agnumber_t agno,\r\nxfs_extlen_t *ask,\r\nxfs_extlen_t *used)\r\n{\r\nstruct xfs_buf *agbp;\r\nstruct xfs_agf *agf;\r\nxfs_agblock_t agblocks;\r\nxfs_extlen_t tree_len;\r\nint error;\r\nif (!xfs_sb_version_hasrmapbt(&mp->m_sb))\r\nreturn 0;\r\nerror = xfs_alloc_read_agf(mp, NULL, agno, 0, &agbp);\r\nif (error)\r\nreturn error;\r\nagf = XFS_BUF_TO_AGF(agbp);\r\nagblocks = be32_to_cpu(agf->agf_length);\r\ntree_len = be32_to_cpu(agf->agf_rmap_blocks);\r\nxfs_buf_relse(agbp);\r\n*ask += max(agblocks / 100, xfs_rmapbt_max_size(mp, agblocks));\r\n*used += tree_len;\r\nreturn error;\r\n}

static int sam9x5_wm8731_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct device *dev = rtd->dev;\r\nint ret;\r\ndev_dbg(dev, "ASoC: %s called\n", __func__);\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_XTAL,\r\nMCLK_RATE, SND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(dev, "ASoC: Failed to set WM8731 SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sam9x5_wm8731_driver_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *codec_np, *cpu_np;\r\nstruct snd_soc_card *card;\r\nstruct snd_soc_dai_link *dai;\r\nstruct sam9x5_drvdata *priv;\r\nint ret;\r\nif (!np) {\r\ndev_err(&pdev->dev, "No device node supplied\n");\r\nreturn -EINVAL;\r\n}\r\ncard = devm_kzalloc(&pdev->dev, sizeof(*card), GFP_KERNEL);\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\ndai = devm_kzalloc(&pdev->dev, sizeof(*dai), GFP_KERNEL);\r\nif (!dai || !card || !priv) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nsnd_soc_card_set_drvdata(card, priv);\r\ncard->dev = &pdev->dev;\r\ncard->owner = THIS_MODULE;\r\ncard->dai_link = dai;\r\ncard->num_links = 1;\r\ncard->dapm_widgets = sam9x5_dapm_widgets;\r\ncard->num_dapm_widgets = ARRAY_SIZE(sam9x5_dapm_widgets);\r\ndai->name = "WM8731";\r\ndai->stream_name = "WM8731 PCM";\r\ndai->codec_dai_name = "wm8731-hifi";\r\ndai->init = sam9x5_wm8731_init;\r\ndai->dai_fmt = SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_NB_NF\r\n| SND_SOC_DAIFMT_CBM_CFM;\r\nret = snd_soc_of_parse_card_name(card, "atmel,model");\r\nif (ret) {\r\ndev_err(&pdev->dev, "atmel,model node missing\n");\r\ngoto out;\r\n}\r\nret = snd_soc_of_parse_audio_routing(card, "atmel,audio-routing");\r\nif (ret) {\r\ndev_err(&pdev->dev, "atmel,audio-routing node missing\n");\r\ngoto out;\r\n}\r\ncodec_np = of_parse_phandle(np, "atmel,audio-codec", 0);\r\nif (!codec_np) {\r\ndev_err(&pdev->dev, "atmel,audio-codec node missing\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ndai->codec_of_node = codec_np;\r\ncpu_np = of_parse_phandle(np, "atmel,ssc-controller", 0);\r\nif (!cpu_np) {\r\ndev_err(&pdev->dev, "atmel,ssc-controller node missing\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ndai->cpu_of_node = cpu_np;\r\ndai->platform_of_node = cpu_np;\r\npriv->ssc_id = of_alias_get_id(cpu_np, "ssc");\r\nret = atmel_ssc_set_audio(priv->ssc_id);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev,\r\n"ASoC: Failed to set SSC %d for audio: %d\n",\r\nret, priv->ssc_id);\r\ngoto out;\r\n}\r\nof_node_put(codec_np);\r\nof_node_put(cpu_np);\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"ASoC: Platform device allocation failed\n");\r\ngoto out_put_audio;\r\n}\r\ndev_dbg(&pdev->dev, "ASoC: %s ok\n", __func__);\r\nreturn ret;\r\nout_put_audio:\r\natmel_ssc_put_audio(priv->ssc_id);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int sam9x5_wm8731_driver_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nstruct sam9x5_drvdata *priv = card->drvdata;\r\nsnd_soc_unregister_card(card);\r\natmel_ssc_put_audio(priv->ssc_id);\r\nreturn 0;\r\n}

static int qcom_usb_hsic_phy_power_on(struct phy *phy)\r\n{\r\nstruct qcom_usb_hsic_phy *uphy = phy_get_drvdata(phy);\r\nstruct ulpi *ulpi = uphy->ulpi;\r\nstruct pinctrl_state *pins_default;\r\nint ret;\r\nret = clk_prepare_enable(uphy->phy_clk);\r\nif (ret)\r\nreturn ret;\r\nret = clk_prepare_enable(uphy->cal_clk);\r\nif (ret)\r\ngoto err_cal;\r\nret = clk_prepare_enable(uphy->cal_sleep_clk);\r\nif (ret)\r\ngoto err_sleep;\r\nret = ulpi_write(ulpi, ULPI_HSIC_IO_CAL, 0xff);\r\nif (ret)\r\ngoto err_ulpi;\r\nret = ulpi_write(ulpi, ULPI_HSIC_CFG, 0xa8);\r\nif (ret)\r\ngoto err_ulpi;\r\npins_default = pinctrl_lookup_state(uphy->pctl, PINCTRL_STATE_DEFAULT);\r\nif (IS_ERR(pins_default))\r\nreturn PTR_ERR(pins_default);\r\nret = pinctrl_select_state(uphy->pctl, pins_default);\r\nif (ret)\r\ngoto err_ulpi;\r\nret = ulpi_write(ulpi, ULPI_SET(ULPI_HSIC_CFG), 0x01);\r\nif (ret)\r\ngoto err_ulpi;\r\nret = ulpi_write(ulpi, ULPI_CLR(ULPI_IFC_CTRL),\r\nULPI_IFC_CTRL_AUTORESUME);\r\nif (ret)\r\ngoto err_ulpi;\r\nreturn ret;\r\nerr_ulpi:\r\nclk_disable_unprepare(uphy->cal_sleep_clk);\r\nerr_sleep:\r\nclk_disable_unprepare(uphy->cal_clk);\r\nerr_cal:\r\nclk_disable_unprepare(uphy->phy_clk);\r\nreturn ret;\r\n}\r\nstatic int qcom_usb_hsic_phy_power_off(struct phy *phy)\r\n{\r\nstruct qcom_usb_hsic_phy *uphy = phy_get_drvdata(phy);\r\nclk_disable_unprepare(uphy->cal_sleep_clk);\r\nclk_disable_unprepare(uphy->cal_clk);\r\nclk_disable_unprepare(uphy->phy_clk);\r\nreturn 0;\r\n}\r\nstatic int qcom_usb_hsic_phy_probe(struct ulpi *ulpi)\r\n{\r\nstruct qcom_usb_hsic_phy *uphy;\r\nstruct phy_provider *p;\r\nstruct clk *clk;\r\nuphy = devm_kzalloc(&ulpi->dev, sizeof(*uphy), GFP_KERNEL);\r\nif (!uphy)\r\nreturn -ENOMEM;\r\nulpi_set_drvdata(ulpi, uphy);\r\nuphy->ulpi = ulpi;\r\nuphy->pctl = devm_pinctrl_get(&ulpi->dev);\r\nif (IS_ERR(uphy->pctl))\r\nreturn PTR_ERR(uphy->pctl);\r\nuphy->phy_clk = clk = devm_clk_get(&ulpi->dev, "phy");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nuphy->cal_clk = clk = devm_clk_get(&ulpi->dev, "cal");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nuphy->cal_sleep_clk = clk = devm_clk_get(&ulpi->dev, "cal_sleep");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nuphy->phy = devm_phy_create(&ulpi->dev, ulpi->dev.of_node,\r\n&qcom_usb_hsic_phy_ops);\r\nif (IS_ERR(uphy->phy))\r\nreturn PTR_ERR(uphy->phy);\r\nphy_set_drvdata(uphy->phy, uphy);\r\np = devm_of_phy_provider_register(&ulpi->dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(p);\r\n}

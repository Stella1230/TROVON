static int rockchip_set_phy_state(struct phy *phy, bool enable)\r\n{\r\nstruct rockchip_dp_phy *dp = phy_get_drvdata(phy);\r\nint ret;\r\nif (enable) {\r\nret = regmap_write(dp->grf, GRF_SOC_CON12,\r\nGRF_EDP_PHY_SIDDQ_HIWORD_MASK |\r\nGRF_EDP_PHY_SIDDQ_ON);\r\nif (ret < 0) {\r\ndev_err(dp->dev, "Can't enable PHY power %d\n", ret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(dp->phy_24m);\r\n} else {\r\nclk_disable_unprepare(dp->phy_24m);\r\nret = regmap_write(dp->grf, GRF_SOC_CON12,\r\nGRF_EDP_PHY_SIDDQ_HIWORD_MASK |\r\nGRF_EDP_PHY_SIDDQ_OFF);\r\n}\r\nreturn ret;\r\n}\r\nstatic int rockchip_dp_phy_power_on(struct phy *phy)\r\n{\r\nreturn rockchip_set_phy_state(phy, true);\r\n}\r\nstatic int rockchip_dp_phy_power_off(struct phy *phy)\r\n{\r\nreturn rockchip_set_phy_state(phy, false);\r\n}\r\nstatic int rockchip_dp_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct phy_provider *phy_provider;\r\nstruct rockchip_dp_phy *dp;\r\nstruct phy *phy;\r\nint ret;\r\nif (!np)\r\nreturn -ENODEV;\r\nif (!dev->parent || !dev->parent->of_node)\r\nreturn -ENODEV;\r\ndp = devm_kzalloc(dev, sizeof(*dp), GFP_KERNEL);\r\nif (!dp)\r\nreturn -ENOMEM;\r\ndp->dev = dev;\r\ndp->phy_24m = devm_clk_get(dev, "24m");\r\nif (IS_ERR(dp->phy_24m)) {\r\ndev_err(dev, "cannot get clock 24m\n");\r\nreturn PTR_ERR(dp->phy_24m);\r\n}\r\nret = clk_set_rate(dp->phy_24m, 24000000);\r\nif (ret < 0) {\r\ndev_err(dp->dev, "cannot set clock phy_24m %d\n", ret);\r\nreturn ret;\r\n}\r\ndp->grf = syscon_node_to_regmap(dev->parent->of_node);\r\nif (IS_ERR(dp->grf)) {\r\ndev_err(dev, "rk3288-dp needs the General Register Files syscon\n");\r\nreturn PTR_ERR(dp->grf);\r\n}\r\nret = regmap_write(dp->grf, GRF_SOC_CON12, GRF_EDP_REF_CLK_SEL_INTER |\r\nGRF_EDP_REF_CLK_SEL_INTER_HIWORD_MASK);\r\nif (ret != 0) {\r\ndev_err(dp->dev, "Could not config GRF edp ref clk: %d\n", ret);\r\nreturn ret;\r\n}\r\nphy = devm_phy_create(dev, np, &rockchip_dp_phy_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(dev, "failed to create phy\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nphy_set_drvdata(phy, dp);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

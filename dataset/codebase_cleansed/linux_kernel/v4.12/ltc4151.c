static struct ltc4151_data *ltc4151_update_device(struct device *dev)\r\n{\r\nstruct ltc4151_data *data = dev_get_drvdata(dev);\r\nstruct i2c_client *client = data->client;\r\nstruct ltc4151_data *ret = data;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ / 6) || !data->valid) {\r\nint i;\r\ndev_dbg(&client->dev, "Starting ltc4151 update\n");\r\nfor (i = 0; i < ARRAY_SIZE(data->regs); i++) {\r\nint val;\r\nval = i2c_smbus_read_byte_data(client, i);\r\nif (unlikely(val < 0)) {\r\ndev_dbg(dev,\r\n"Failed to read ADC value: error %d\n",\r\nval);\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->regs[i] = val;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int ltc4151_get_value(struct ltc4151_data *data, u8 reg)\r\n{\r\nu32 val;\r\nval = (data->regs[reg] << 4) + (data->regs[reg + 1] >> 4);\r\nswitch (reg) {\r\ncase LTC4151_ADIN_H:\r\nval = val * 500 / 1000;\r\nbreak;\r\ncase LTC4151_SENSE_H:\r\nval = val * 20 * 1000 / data->shunt;\r\nbreak;\r\ncase LTC4151_VIN_H:\r\nval = val * 25;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nval = 0;\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic ssize_t ltc4151_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ltc4151_data *data = ltc4151_update_device(dev);\r\nint value;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nvalue = ltc4151_get_value(data, attr->index);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", value);\r\n}\r\nstatic int ltc4151_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nstruct device *dev = &client->dev;\r\nstruct ltc4151_data *data;\r\nstruct device *hwmon_dev;\r\nu32 shunt;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (of_property_read_u32(client->dev.of_node,\r\n"shunt-resistor-micro-ohms", &shunt))\r\nshunt = 1000;\r\nif (shunt == 0)\r\nreturn -EINVAL;\r\ndata->shunt = shunt;\r\ndata->client = client;\r\nmutex_init(&data->update_lock);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\ndata,\r\nltc4151_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

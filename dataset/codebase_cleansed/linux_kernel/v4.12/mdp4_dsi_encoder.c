static struct mdp4_kms *get_kms(struct drm_encoder *encoder)\r\n{\r\nstruct msm_drm_private *priv = encoder->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void mdp4_dsi_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct mdp4_dsi_encoder *mdp4_dsi_encoder = to_mdp4_dsi_encoder(encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(mdp4_dsi_encoder);\r\n}\r\nstatic void mdp4_dsi_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nuint32_t dsi_hsync_skew, vsync_period, vsync_len, ctrl_pol;\r\nuint32_t display_v_start, display_v_end;\r\nuint32_t hsync_start_x, hsync_end_x;\r\nmode = adjusted_mode;\r\nDBG("set mode: %d:\"%s\" %d %d %d %d %d %d %d %d %d %d 0x%x 0x%x",\r\nmode->base.id, mode->name,\r\nmode->vrefresh, mode->clock,\r\nmode->hdisplay, mode->hsync_start,\r\nmode->hsync_end, mode->htotal,\r\nmode->vdisplay, mode->vsync_start,\r\nmode->vsync_end, mode->vtotal,\r\nmode->type, mode->flags);\r\nctrl_pol = 0;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nctrl_pol |= MDP4_DSI_CTRL_POLARITY_HSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nctrl_pol |= MDP4_DSI_CTRL_POLARITY_VSYNC_LOW;\r\ndsi_hsync_skew = 0;\r\nhsync_start_x = (mode->htotal - mode->hsync_start);\r\nhsync_end_x = mode->htotal - (mode->hsync_start - mode->hdisplay) - 1;\r\nvsync_period = mode->vtotal * mode->htotal;\r\nvsync_len = (mode->vsync_end - mode->vsync_start) * mode->htotal;\r\ndisplay_v_start = (mode->vtotal - mode->vsync_start) * mode->htotal + dsi_hsync_skew;\r\ndisplay_v_end = vsync_period - ((mode->vsync_start - mode->vdisplay) * mode->htotal) + dsi_hsync_skew - 1;\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_HSYNC_CTRL,\r\nMDP4_DSI_HSYNC_CTRL_PULSEW(mode->hsync_end - mode->hsync_start) |\r\nMDP4_DSI_HSYNC_CTRL_PERIOD(mode->htotal));\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_VSYNC_PERIOD, vsync_period);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_VSYNC_LEN, vsync_len);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_DISPLAY_HCTRL,\r\nMDP4_DSI_DISPLAY_HCTRL_START(hsync_start_x) |\r\nMDP4_DSI_DISPLAY_HCTRL_END(hsync_end_x));\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_DISPLAY_VSTART, display_v_start);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_DISPLAY_VEND, display_v_end);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_CTRL_POLARITY, ctrl_pol);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_UNDERFLOW_CLR,\r\nMDP4_DSI_UNDERFLOW_CLR_ENABLE_RECOVERY |\r\nMDP4_DSI_UNDERFLOW_CLR_COLOR(0xff));\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_ACTIVE_HCTL,\r\nMDP4_DSI_ACTIVE_HCTL_START(0) |\r\nMDP4_DSI_ACTIVE_HCTL_END(0));\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_HSYNC_SKEW, dsi_hsync_skew);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_BORDER_CLR, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_ACTIVE_VSTART, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_ACTIVE_VEND, 0);\r\n}\r\nstatic void mdp4_dsi_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct mdp4_dsi_encoder *mdp4_dsi_encoder = to_mdp4_dsi_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nif (!mdp4_dsi_encoder->enabled)\r\nreturn;\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_ENABLE, 0);\r\nmdp_irq_wait(&mdp4_kms->base, MDP4_IRQ_PRIMARY_VSYNC);\r\nmdp4_dsi_encoder->enabled = false;\r\n}\r\nstatic void mdp4_dsi_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct mdp4_dsi_encoder *mdp4_dsi_encoder = to_mdp4_dsi_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nif (mdp4_dsi_encoder->enabled)\r\nreturn;\r\nmdp4_crtc_set_config(encoder->crtc,\r\nMDP4_DMA_CONFIG_PACK_ALIGN_MSB |\r\nMDP4_DMA_CONFIG_DEFLKR_EN |\r\nMDP4_DMA_CONFIG_DITHER_EN |\r\nMDP4_DMA_CONFIG_R_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_G_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_B_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_PACK(0x21));\r\nmdp4_crtc_set_intf(encoder->crtc, INTF_DSI_VIDEO, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DSI_ENABLE, 1);\r\nmdp4_dsi_encoder->enabled = true;\r\n}\r\nstruct drm_encoder *mdp4_dsi_encoder_init(struct drm_device *dev)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct mdp4_dsi_encoder *mdp4_dsi_encoder;\r\nint ret;\r\nmdp4_dsi_encoder = kzalloc(sizeof(*mdp4_dsi_encoder), GFP_KERNEL);\r\nif (!mdp4_dsi_encoder) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nencoder = &mdp4_dsi_encoder->base;\r\ndrm_encoder_init(dev, encoder, &mdp4_dsi_encoder_funcs,\r\nDRM_MODE_ENCODER_DSI, NULL);\r\ndrm_encoder_helper_add(encoder, &mdp4_dsi_encoder_helper_funcs);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nmdp4_dsi_encoder_destroy(encoder);\r\nreturn ERR_PTR(ret);\r\n}

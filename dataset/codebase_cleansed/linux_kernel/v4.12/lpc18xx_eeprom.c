static inline void lpc18xx_eeprom_writel(struct lpc18xx_eeprom_dev *eeprom,\r\nu32 reg, u32 val)\r\n{\r\nwritel(val, eeprom->reg_base + reg);\r\n}\r\nstatic inline u32 lpc18xx_eeprom_readl(struct lpc18xx_eeprom_dev *eeprom,\r\nu32 reg)\r\n{\r\nreturn readl(eeprom->reg_base + reg);\r\n}\r\nstatic int lpc18xx_eeprom_busywait_until_prog(struct lpc18xx_eeprom_dev *eeprom)\r\n{\r\nunsigned long end;\r\nu32 val;\r\nend = jiffies + msecs_to_jiffies(LPC18XX_EEPROM_PROGRAM_TIME * 10);\r\nwhile (time_is_after_jiffies(end)) {\r\nval = lpc18xx_eeprom_readl(eeprom, LPC18XX_EEPROM_INTSTAT);\r\nif (val & LPC18XX_EEPROM_INTSTAT_END_OF_PROG) {\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_INTSTATCLR,\r\nLPC18XX_EEPROM_INTSTATCLR_PROG_CLR_ST);\r\nreturn 0;\r\n}\r\nusleep_range(LPC18XX_EEPROM_PROGRAM_TIME * USEC_PER_MSEC,\r\n(LPC18XX_EEPROM_PROGRAM_TIME + 1) * USEC_PER_MSEC);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int lpc18xx_eeprom_gather_write(void *context, unsigned int reg,\r\nvoid *val, size_t bytes)\r\n{\r\nstruct lpc18xx_eeprom_dev *eeprom = context;\r\nunsigned int offset = reg;\r\nint ret;\r\nif ((reg > eeprom->size - LPC18XX_EEPROM_PAGE_SIZE) ||\r\n(reg + bytes > eeprom->size - LPC18XX_EEPROM_PAGE_SIZE))\r\nreturn -EINVAL;\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\r\nLPC18XX_EEPROM_PWRDWN_NO);\r\nusleep_range(100, 200);\r\nwhile (bytes) {\r\nwritel(*(u32 *)val, eeprom->mem_base + offset);\r\nret = lpc18xx_eeprom_busywait_until_prog(eeprom);\r\nif (ret < 0)\r\nreturn ret;\r\nbytes -= eeprom->val_bytes;\r\nval += eeprom->val_bytes;\r\noffset += eeprom->val_bytes;\r\n}\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\r\nLPC18XX_EEPROM_PWRDWN_YES);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_eeprom_read(void *context, unsigned int offset,\r\nvoid *val, size_t bytes)\r\n{\r\nstruct lpc18xx_eeprom_dev *eeprom = context;\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\r\nLPC18XX_EEPROM_PWRDWN_NO);\r\nusleep_range(100, 200);\r\nwhile (bytes) {\r\n*(u32 *)val = readl(eeprom->mem_base + offset);\r\nbytes -= eeprom->val_bytes;\r\nval += eeprom->val_bytes;\r\noffset += eeprom->val_bytes;\r\n}\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\r\nLPC18XX_EEPROM_PWRDWN_YES);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_eeprom_probe(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_eeprom_dev *eeprom;\r\nstruct device *dev = &pdev->dev;\r\nstruct reset_control *rst;\r\nunsigned long clk_rate;\r\nstruct resource *res;\r\nint ret;\r\neeprom = devm_kzalloc(dev, sizeof(*eeprom), GFP_KERNEL);\r\nif (!eeprom)\r\nreturn -ENOMEM;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "reg");\r\neeprom->reg_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(eeprom->reg_base))\r\nreturn PTR_ERR(eeprom->reg_base);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "mem");\r\neeprom->mem_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(eeprom->mem_base))\r\nreturn PTR_ERR(eeprom->mem_base);\r\neeprom->clk = devm_clk_get(&pdev->dev, "eeprom");\r\nif (IS_ERR(eeprom->clk)) {\r\ndev_err(&pdev->dev, "failed to get eeprom clock\n");\r\nreturn PTR_ERR(eeprom->clk);\r\n}\r\nret = clk_prepare_enable(eeprom->clk);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to prepare/enable eeprom clk: %d\n", ret);\r\nreturn ret;\r\n}\r\nrst = devm_reset_control_get(dev, NULL);\r\nif (IS_ERR(rst)) {\r\ndev_err(dev, "failed to get reset: %ld\n", PTR_ERR(rst));\r\nret = PTR_ERR(rst);\r\ngoto err_clk;\r\n}\r\nret = reset_control_assert(rst);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to assert reset: %d\n", ret);\r\ngoto err_clk;\r\n}\r\neeprom->val_bytes = 4;\r\neeprom->reg_bytes = 4;\r\nclk_rate = clk_get_rate(eeprom->clk);\r\nclk_rate = DIV_ROUND_UP(clk_rate, LPC18XX_EEPROM_CLOCK_HZ) - 1;\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_CLKDIV, clk_rate);\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_AUTOPROG,\r\nLPC18XX_EEPROM_AUTOPROG_WORD);\r\nlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\r\nLPC18XX_EEPROM_PWRDWN_YES);\r\neeprom->size = resource_size(res);\r\nlpc18xx_nvmem_config.size = resource_size(res);\r\nlpc18xx_nvmem_config.dev = dev;\r\nlpc18xx_nvmem_config.priv = eeprom;\r\neeprom->nvmem = nvmem_register(&lpc18xx_nvmem_config);\r\nif (IS_ERR(eeprom->nvmem)) {\r\nret = PTR_ERR(eeprom->nvmem);\r\ngoto err_clk;\r\n}\r\nplatform_set_drvdata(pdev, eeprom);\r\nreturn 0;\r\nerr_clk:\r\nclk_disable_unprepare(eeprom->clk);\r\nreturn ret;\r\n}\r\nstatic int lpc18xx_eeprom_remove(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_eeprom_dev *eeprom = platform_get_drvdata(pdev);\r\nint ret;\r\nret = nvmem_unregister(eeprom->nvmem);\r\nif (ret < 0)\r\nreturn ret;\r\nclk_disable_unprepare(eeprom->clk);\r\nreturn 0;\r\n}

static inline bool ite_is_high_carrier_freq(unsigned int freq)\r\n{\r\nreturn freq >= ITE_HCF_MIN_CARRIER_FREQ;\r\n}\r\nstatic u8 ite_get_carrier_freq_bits(unsigned int freq)\r\n{\r\nif (ite_is_high_carrier_freq(freq)) {\r\nif (freq < 425000)\r\nreturn ITE_CFQ_400;\r\nelse if (freq < 465000)\r\nreturn ITE_CFQ_450;\r\nelse if (freq < 490000)\r\nreturn ITE_CFQ_480;\r\nelse\r\nreturn ITE_CFQ_500;\r\n} else {\r\nif (freq < ITE_LCF_MIN_CARRIER_FREQ)\r\nfreq = ITE_LCF_MIN_CARRIER_FREQ;\r\nif (freq > ITE_LCF_MAX_CARRIER_FREQ)\r\nfreq = ITE_LCF_MAX_CARRIER_FREQ;\r\nfreq =\r\nDIV_ROUND_CLOSEST(freq - ITE_LCF_MIN_CARRIER_FREQ,\r\n1000);\r\nreturn (u8) freq;\r\n}\r\n}\r\nstatic u8 ite_get_pulse_width_bits(unsigned int freq, int duty_cycle)\r\n{\r\nunsigned long period_ns, on_ns;\r\nif (freq < ITE_LCF_MIN_CARRIER_FREQ)\r\nfreq = ITE_LCF_MIN_CARRIER_FREQ;\r\nif (freq > ITE_HCF_MAX_CARRIER_FREQ)\r\nfreq = ITE_HCF_MAX_CARRIER_FREQ;\r\nperiod_ns = 1000000000UL / freq;\r\non_ns = period_ns * duty_cycle / 100;\r\nif (ite_is_high_carrier_freq(freq)) {\r\nif (on_ns < 750)\r\nreturn ITE_TXMPW_A;\r\nelse if (on_ns < 850)\r\nreturn ITE_TXMPW_B;\r\nelse if (on_ns < 950)\r\nreturn ITE_TXMPW_C;\r\nelse if (on_ns < 1080)\r\nreturn ITE_TXMPW_D;\r\nelse\r\nreturn ITE_TXMPW_E;\r\n} else {\r\nif (on_ns < 6500)\r\nreturn ITE_TXMPW_A;\r\nelse if (on_ns < 7850)\r\nreturn ITE_TXMPW_B;\r\nelse if (on_ns < 9650)\r\nreturn ITE_TXMPW_C;\r\nelse if (on_ns < 11950)\r\nreturn ITE_TXMPW_D;\r\nelse\r\nreturn ITE_TXMPW_E;\r\n}\r\n}\r\nstatic void ite_decode_bytes(struct ite_dev *dev, const u8 * data, int\r\nlength)\r\n{\r\nu32 sample_period;\r\nunsigned long *ldata;\r\nunsigned int next_one, next_zero, size;\r\nDEFINE_IR_RAW_EVENT(ev);\r\nif (length == 0)\r\nreturn;\r\nsample_period = dev->params.sample_period;\r\nldata = (unsigned long *)data;\r\nsize = length << 3;\r\nnext_one = find_next_bit_le(ldata, size, 0);\r\nif (next_one > 0) {\r\nev.pulse = true;\r\nev.duration =\r\nITE_BITS_TO_NS(next_one, sample_period);\r\nir_raw_event_store_with_filter(dev->rdev, &ev);\r\n}\r\nwhile (next_one < size) {\r\nnext_zero = find_next_zero_bit_le(ldata, size, next_one + 1);\r\nev.pulse = false;\r\nev.duration = ITE_BITS_TO_NS(next_zero - next_one, sample_period);\r\nir_raw_event_store_with_filter(dev->rdev, &ev);\r\nif (next_zero < size) {\r\nnext_one =\r\nfind_next_bit_le(ldata,\r\nsize,\r\nnext_zero + 1);\r\nev.pulse = true;\r\nev.duration =\r\nITE_BITS_TO_NS(next_one - next_zero,\r\nsample_period);\r\nir_raw_event_store_with_filter\r\n(dev->rdev, &ev);\r\n} else\r\nnext_one = size;\r\n}\r\nir_raw_event_handle(dev->rdev);\r\nite_dbg_verbose("decoded %d bytes.", length);\r\n}\r\nstatic void ite_set_carrier_params(struct ite_dev *dev)\r\n{\r\nunsigned int freq, low_freq, high_freq;\r\nint allowance;\r\nbool use_demodulator;\r\nbool for_tx = dev->transmitting;\r\nite_dbg("%s called", __func__);\r\nif (for_tx) {\r\nfreq = dev->params.tx_carrier_freq;\r\nallowance = ITE_RXDCR_DEFAULT;\r\nuse_demodulator = false;\r\n} else {\r\nlow_freq = dev->params.rx_low_carrier_freq;\r\nhigh_freq = dev->params.rx_high_carrier_freq;\r\nif (low_freq == 0) {\r\nfreq =\r\nITE_DEFAULT_CARRIER_FREQ;\r\nallowance = ITE_RXDCR_DEFAULT;\r\nuse_demodulator = false;\r\n} else {\r\nfreq = (low_freq + high_freq) / 2;\r\nallowance =\r\nDIV_ROUND_CLOSEST(10000 * (high_freq - low_freq),\r\nITE_RXDCR_PER_10000_STEP\r\n* (high_freq + low_freq));\r\nif (allowance < 1)\r\nallowance = 1;\r\nif (allowance > ITE_RXDCR_MAX)\r\nallowance = ITE_RXDCR_MAX;\r\nuse_demodulator = true;\r\n}\r\n}\r\ndev->params.set_carrier_params(dev, ite_is_high_carrier_freq(freq),\r\nuse_demodulator, ite_get_carrier_freq_bits(freq), allowance,\r\nite_get_pulse_width_bits(freq, dev->params.tx_duty_cycle));\r\n}\r\nstatic irqreturn_t ite_cir_isr(int irq, void *data)\r\n{\r\nstruct ite_dev *dev = data;\r\nunsigned long flags;\r\nirqreturn_t ret = IRQ_RETVAL(IRQ_NONE);\r\nu8 rx_buf[ITE_RX_FIFO_LEN];\r\nint rx_bytes;\r\nint iflags;\r\nite_dbg_verbose("%s firing", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\niflags = dev->params.get_irq_causes(dev);\r\nif (iflags & (ITE_IRQ_RX_FIFO | ITE_IRQ_RX_FIFO_OVERRUN)) {\r\nrx_bytes =\r\ndev->params.get_rx_bytes(dev, rx_buf,\r\nITE_RX_FIFO_LEN);\r\nif (rx_bytes > 0) {\r\nspin_unlock_irqrestore(&dev->\r\nlock,\r\nflags);\r\nite_decode_bytes(dev, rx_buf,\r\nrx_bytes);\r\nspin_lock_irqsave(&dev->lock,\r\nflags);\r\nret = IRQ_RETVAL(IRQ_HANDLED);\r\n}\r\n} else if (iflags & ITE_IRQ_TX_FIFO) {\r\nite_dbg_verbose("got interrupt for TX FIFO");\r\nwake_up_interruptible(&dev->tx_queue);\r\nret = IRQ_RETVAL(IRQ_HANDLED);\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nite_dbg_verbose("%s done returning %d", __func__, (int)ret);\r\nreturn ret;\r\n}\r\nstatic int ite_set_rx_carrier_range(struct rc_dev *rcdev, u32 carrier_low, u32\r\ncarrier_high)\r\n{\r\nunsigned long flags;\r\nstruct ite_dev *dev = rcdev->priv;\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.rx_low_carrier_freq = carrier_low;\r\ndev->params.rx_high_carrier_freq = carrier_high;\r\nite_set_carrier_params(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ite_set_tx_carrier(struct rc_dev *rcdev, u32 carrier)\r\n{\r\nunsigned long flags;\r\nstruct ite_dev *dev = rcdev->priv;\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.tx_carrier_freq = carrier;\r\nite_set_carrier_params(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ite_set_tx_duty_cycle(struct rc_dev *rcdev, u32 duty_cycle)\r\n{\r\nunsigned long flags;\r\nstruct ite_dev *dev = rcdev->priv;\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.tx_duty_cycle = duty_cycle;\r\nite_set_carrier_params(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ite_tx_ir(struct rc_dev *rcdev, unsigned *txbuf, unsigned n)\r\n{\r\nunsigned long flags;\r\nstruct ite_dev *dev = rcdev->priv;\r\nbool is_pulse = false;\r\nint remaining_us, fifo_avail, fifo_remaining, last_idx = 0;\r\nint max_rle_us, next_rle_us;\r\nint ret = n;\r\nu8 last_sent[ITE_TX_FIFO_LEN];\r\nu8 val;\r\nite_dbg("%s called", __func__);\r\nmemset(last_sent, 0, ARRAY_SIZE(last_sent));\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->transmitting = true;\r\nite_set_carrier_params(dev);\r\nmax_rle_us =\r\n(ITE_BAUDRATE_DIVISOR * dev->params.sample_period *\r\nITE_TX_MAX_RLE) / 1000;\r\ndev->params.disable_rx(dev);\r\nfifo_avail =\r\nITE_TX_FIFO_LEN - dev->params.get_tx_used_slots(dev);\r\nwhile (n > 0 && dev->in_use) {\r\nis_pulse = !is_pulse;\r\nremaining_us = *(txbuf++);\r\nn--;\r\nite_dbg("%s: %ld",\r\n((is_pulse) ? "pulse" : "space"),\r\n(long int)\r\nremaining_us);\r\nwhile (remaining_us > 0 && dev->in_use) {\r\nif (remaining_us > max_rle_us)\r\nnext_rle_us = max_rle_us;\r\nelse\r\nnext_rle_us = remaining_us;\r\nremaining_us -= next_rle_us;\r\nval = (ITE_TX_MAX_RLE * next_rle_us) / max_rle_us;\r\nlast_sent[last_idx++] = val;\r\nlast_idx &= (ITE_TX_FIFO_LEN);\r\nval = (val - 1) & ITE_TX_RLE_MASK;\r\nif (is_pulse)\r\nval |= ITE_TX_PULSE;\r\nelse\r\nval |= ITE_TX_SPACE;\r\nif (fifo_avail <= 0)\r\nfifo_avail = ITE_TX_FIFO_LEN - dev->params.get_tx_used_slots(dev);\r\nif (fifo_avail <= 0) {\r\ndev->params.\r\nenable_tx_interrupt(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nwait_event_interruptible(dev->tx_queue, (fifo_avail = ITE_TX_FIFO_LEN - dev->params.get_tx_used_slots(dev)) >= 8);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.\r\ndisable_tx_interrupt(dev);\r\n}\r\ndev->params.put_tx_byte(dev, val);\r\nfifo_avail--;\r\n}\r\n}\r\nfifo_remaining = dev->params.get_tx_used_slots(dev);\r\nremaining_us = 0;\r\nwhile (fifo_remaining > 0) {\r\nfifo_remaining--;\r\nlast_idx--;\r\nlast_idx &= (ITE_TX_FIFO_LEN - 1);\r\nremaining_us += last_sent[last_idx];\r\n}\r\nremaining_us = (remaining_us * max_rle_us) / (ITE_TX_MAX_RLE);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nmdelay(DIV_ROUND_UP(remaining_us, 1000));\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->transmitting = false;\r\nite_set_carrier_params(dev);\r\nif (dev->in_use)\r\ndev->params.enable_rx(dev);\r\nwake_up_interruptible(&dev->tx_ended);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn ret;\r\n}\r\nstatic void ite_s_idle(struct rc_dev *rcdev, bool enable)\r\n{\r\nunsigned long flags;\r\nstruct ite_dev *dev = rcdev->priv;\r\nite_dbg("%s called", __func__);\r\nif (enable) {\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.idle_rx(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\n}\r\n}\r\nstatic int it87_get_irq_causes(struct ite_dev *dev)\r\n{\r\nu8 iflags;\r\nint ret = 0;\r\nite_dbg("%s called", __func__);\r\niflags = inb(dev->cir_addr + IT87_IIR) & IT87_II;\r\nswitch (iflags) {\r\ncase IT87_II_RXDS:\r\nret = ITE_IRQ_RX_FIFO;\r\nbreak;\r\ncase IT87_II_RXFO:\r\nret = ITE_IRQ_RX_FIFO_OVERRUN;\r\nbreak;\r\ncase IT87_II_TXLDL:\r\nret = ITE_IRQ_TX_FIFO;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void it87_set_carrier_params(struct ite_dev *dev, bool high_freq,\r\nbool use_demodulator,\r\nu8 carrier_freq_bits, u8 allowance_bits,\r\nu8 pulse_width_bits)\r\n{\r\nu8 val;\r\nite_dbg("%s called", __func__);\r\nval = inb(dev->cir_addr + IT87_RCR)\r\n& ~(IT87_HCFS | IT87_RXEND | IT87_RXDCR);\r\nif (high_freq)\r\nval |= IT87_HCFS;\r\nif (use_demodulator)\r\nval |= IT87_RXEND;\r\nval |= allowance_bits;\r\noutb(val, dev->cir_addr + IT87_RCR);\r\noutb((carrier_freq_bits << IT87_CFQ_SHIFT) | pulse_width_bits,\r\ndev->cir_addr + IT87_TCR2);\r\n}\r\nstatic int it87_get_rx_bytes(struct ite_dev *dev, u8 * buf, int buf_size)\r\n{\r\nint fifo, read = 0;\r\nite_dbg("%s called", __func__);\r\nfifo = inb(dev->cir_addr + IT87_RSR) & IT87_RXFBC;\r\nwhile (fifo > 0 && buf_size > 0) {\r\n*(buf++) = inb(dev->cir_addr + IT87_DR);\r\nfifo--;\r\nread++;\r\nbuf_size--;\r\n}\r\nreturn read;\r\n}\r\nstatic int it87_get_tx_used_slots(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nreturn inb(dev->cir_addr + IT87_TSR) & IT87_TXFBC;\r\n}\r\nstatic void it87_put_tx_byte(struct ite_dev *dev, u8 value)\r\n{\r\noutb(value, dev->cir_addr + IT87_DR);\r\n}\r\nstatic void it87_idle_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_RCR) | IT87_RXACT,\r\ndev->cir_addr + IT87_RCR);\r\noutb(inb(dev->cir_addr + IT87_TCR1) | IT87_FIFOCLR,\r\ndev->cir_addr + IT87_TCR1);\r\n}\r\nstatic void it87_disable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_IER) & ~(IT87_RDAIE | IT87_RFOIE),\r\ndev->cir_addr + IT87_IER);\r\noutb(inb(dev->cir_addr + IT87_RCR) & ~IT87_RXEN,\r\ndev->cir_addr + IT87_RCR);\r\nit87_idle_rx(dev);\r\n}\r\nstatic void it87_enable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_RCR) | IT87_RXEN,\r\ndev->cir_addr + IT87_RCR);\r\nit87_idle_rx(dev);\r\noutb(inb(dev->cir_addr + IT87_IER) | IT87_RDAIE | IT87_RFOIE | IT87_IEC,\r\ndev->cir_addr + IT87_IER);\r\n}\r\nstatic void it87_disable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_IER) & ~IT87_TLDLIE,\r\ndev->cir_addr + IT87_IER);\r\n}\r\nstatic void it87_enable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_IER) | IT87_TLDLIE | IT87_IEC,\r\ndev->cir_addr + IT87_IER);\r\n}\r\nstatic void it87_disable(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT87_IER) &\r\n~(IT87_IEC | IT87_RFOIE | IT87_RDAIE | IT87_TLDLIE),\r\ndev->cir_addr + IT87_IER);\r\nit87_disable_rx(dev);\r\noutb(IT87_FIFOCLR | inb(dev->cir_addr + IT87_TCR1),\r\ndev->cir_addr + IT87_TCR1);\r\n}\r\nstatic void it87_init_hardware(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb((inb(dev->cir_addr + IT87_IER) &\r\n~(IT87_IEC | IT87_RFOIE | IT87_RDAIE | IT87_TLDLIE)) | IT87_BR,\r\ndev->cir_addr + IT87_IER);\r\noutb(ITE_BAUDRATE_DIVISOR & 0xff, dev->cir_addr + IT87_BDLR);\r\noutb((ITE_BAUDRATE_DIVISOR >> 8) & 0xff, dev->cir_addr + IT87_BDHR);\r\noutb(inb(dev->cir_addr + IT87_IER) & ~IT87_BR,\r\ndev->cir_addr + IT87_IER);\r\noutb(ITE_RXDCR_DEFAULT, dev->cir_addr + IT87_RCR);\r\noutb(IT87_TXMPM_DEFAULT | IT87_TXENDF | IT87_TXRLE\r\n| IT87_FIFOTL_DEFAULT | IT87_FIFOCLR,\r\ndev->cir_addr + IT87_TCR1);\r\nite_set_carrier_params(dev);\r\n}\r\nstatic int it8708_get_irq_causes(struct ite_dev *dev)\r\n{\r\nu8 iflags;\r\nint ret = 0;\r\nite_dbg("%s called", __func__);\r\niflags = inb(dev->cir_addr + IT8708_C0IIR);\r\nif (iflags & IT85_TLDLI)\r\nret |= ITE_IRQ_TX_FIFO;\r\nif (iflags & IT85_RDAI)\r\nret |= ITE_IRQ_RX_FIFO;\r\nif (iflags & IT85_RFOI)\r\nret |= ITE_IRQ_RX_FIFO_OVERRUN;\r\nreturn ret;\r\n}\r\nstatic void it8708_set_carrier_params(struct ite_dev *dev, bool high_freq,\r\nbool use_demodulator,\r\nu8 carrier_freq_bits, u8 allowance_bits,\r\nu8 pulse_width_bits)\r\n{\r\nu8 val;\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_BANKSEL) | IT8708_HRAE,\r\ndev->cir_addr + IT8708_BANKSEL);\r\nval = (inb(dev->cir_addr + IT8708_C0CFR)\r\n& ~(IT85_HCFS | IT85_CFQ)) | carrier_freq_bits;\r\nif (high_freq)\r\nval |= IT85_HCFS;\r\noutb(val, dev->cir_addr + IT8708_C0CFR);\r\noutb(inb(dev->cir_addr + IT8708_BANKSEL) & ~IT8708_HRAE,\r\ndev->cir_addr + IT8708_BANKSEL);\r\nval = inb(dev->cir_addr + IT8708_C0RCR)\r\n& ~(IT85_RXEND | IT85_RXDCR);\r\nif (use_demodulator)\r\nval |= IT85_RXEND;\r\nval |= allowance_bits;\r\noutb(val, dev->cir_addr + IT8708_C0RCR);\r\nval = inb(dev->cir_addr + IT8708_C0TCR) & ~IT85_TXMPW;\r\nval |= pulse_width_bits;\r\noutb(val, dev->cir_addr + IT8708_C0TCR);\r\n}\r\nstatic int it8708_get_rx_bytes(struct ite_dev *dev, u8 * buf, int buf_size)\r\n{\r\nint fifo, read = 0;\r\nite_dbg("%s called", __func__);\r\nfifo = inb(dev->cir_addr + IT8708_C0RFSR) & IT85_RXFBC;\r\nwhile (fifo > 0 && buf_size > 0) {\r\n*(buf++) = inb(dev->cir_addr + IT8708_C0DR);\r\nfifo--;\r\nread++;\r\nbuf_size--;\r\n}\r\nreturn read;\r\n}\r\nstatic int it8708_get_tx_used_slots(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nreturn inb(dev->cir_addr + IT8708_C0TFSR) & IT85_TXFBC;\r\n}\r\nstatic void it8708_put_tx_byte(struct ite_dev *dev, u8 value)\r\n{\r\noutb(value, dev->cir_addr + IT8708_C0DR);\r\n}\r\nstatic void it8708_idle_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0RCR) | IT85_RXACT,\r\ndev->cir_addr + IT8708_C0RCR);\r\noutb(inb(dev->cir_addr + IT8708_C0MSTCR) | IT85_FIFOCLR,\r\ndev->cir_addr + IT8708_C0MSTCR);\r\n}\r\nstatic void it8708_disable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0IER) &\r\n~(IT85_RDAIE | IT85_RFOIE),\r\ndev->cir_addr + IT8708_C0IER);\r\noutb(inb(dev->cir_addr + IT8708_C0RCR) & ~IT85_RXEN,\r\ndev->cir_addr + IT8708_C0RCR);\r\nit8708_idle_rx(dev);\r\n}\r\nstatic void it8708_enable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0RCR) | IT85_RXEN,\r\ndev->cir_addr + IT8708_C0RCR);\r\nit8708_idle_rx(dev);\r\noutb(inb(dev->cir_addr + IT8708_C0IER)\r\n|IT85_RDAIE | IT85_RFOIE | IT85_IEC,\r\ndev->cir_addr + IT8708_C0IER);\r\n}\r\nstatic void it8708_disable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0IER) & ~IT85_TLDLIE,\r\ndev->cir_addr + IT8708_C0IER);\r\n}\r\nstatic void it8708_enable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0IER)\r\n|IT85_TLDLIE | IT85_IEC,\r\ndev->cir_addr + IT8708_C0IER);\r\n}\r\nstatic void it8708_disable(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0IER) &\r\n~(IT85_IEC | IT85_RFOIE | IT85_RDAIE | IT85_TLDLIE),\r\ndev->cir_addr + IT8708_C0IER);\r\nit8708_disable_rx(dev);\r\noutb(IT85_FIFOCLR | inb(dev->cir_addr + IT8708_C0MSTCR),\r\ndev->cir_addr + IT8708_C0MSTCR);\r\n}\r\nstatic void it8708_init_hardware(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\noutb(inb(dev->cir_addr + IT8708_C0IER) &\r\n~(IT85_IEC | IT85_RFOIE | IT85_RDAIE | IT85_TLDLIE),\r\ndev->cir_addr + IT8708_C0IER);\r\noutb(inb(dev->cir_addr + IT8708_BANKSEL) | IT8708_HRAE,\r\ndev->cir_addr + IT8708_BANKSEL);\r\noutb(ITE_BAUDRATE_DIVISOR & 0xff, dev->cir_addr + IT8708_C0BDLR);\r\noutb((ITE_BAUDRATE_DIVISOR >> 8) & 0xff,\r\ndev->cir_addr + IT8708_C0BDHR);\r\noutb(inb(dev->cir_addr + IT8708_BANKSEL) & ~IT8708_HRAE,\r\ndev->cir_addr + IT8708_BANKSEL);\r\noutb((inb(dev->cir_addr + IT8708_C0MSTCR) &\r\n~(IT85_ILSEL | IT85_ILE | IT85_FIFOTL |\r\nIT85_FIFOCLR | IT85_RESET)) |\r\nIT85_FIFOTL_DEFAULT,\r\ndev->cir_addr + IT8708_C0MSTCR);\r\noutb((inb(dev->cir_addr + IT8708_C0RCR) &\r\n~(IT85_RXEN | IT85_RDWOS | IT85_RXEND |\r\nIT85_RXACT | IT85_RXDCR)) |\r\nITE_RXDCR_DEFAULT,\r\ndev->cir_addr + IT8708_C0RCR);\r\noutb((inb(dev->cir_addr + IT8708_C0TCR) &\r\n~(IT85_TXMPM | IT85_TXMPW))\r\n|IT85_TXRLE | IT85_TXENDF |\r\nIT85_TXMPM_DEFAULT | IT85_TXMPW_DEFAULT,\r\ndev->cir_addr + IT8708_C0TCR);\r\nite_set_carrier_params(dev);\r\n}\r\nstatic inline u8 it8709_rm(struct ite_dev *dev, int index)\r\n{\r\noutb(index, dev->cir_addr + IT8709_RAM_IDX);\r\nreturn inb(dev->cir_addr + IT8709_RAM_VAL);\r\n}\r\nstatic inline void it8709_wm(struct ite_dev *dev, u8 val, int index)\r\n{\r\noutb(index, dev->cir_addr + IT8709_RAM_IDX);\r\noutb(val, dev->cir_addr + IT8709_RAM_VAL);\r\n}\r\nstatic void it8709_wait(struct ite_dev *dev)\r\n{\r\nint i = 0;\r\nfor (i = 0; i < 15000; i++) {\r\nudelay(2);\r\nif (it8709_rm(dev, IT8709_MODE) == IT8709_IDLE)\r\nbreak;\r\n}\r\n}\r\nstatic u8 it8709_rr(struct ite_dev *dev, int index)\r\n{\r\nit8709_wait(dev);\r\nit8709_wm(dev, index, IT8709_REG_IDX);\r\nit8709_wm(dev, IT8709_READ, IT8709_MODE);\r\nit8709_wait(dev);\r\nreturn it8709_rm(dev, IT8709_REG_VAL);\r\n}\r\nstatic void it8709_wr(struct ite_dev *dev, u8 val, int index)\r\n{\r\nit8709_wait(dev);\r\nit8709_wm(dev, val, IT8709_REG_VAL);\r\nit8709_wm(dev, index, IT8709_REG_IDX);\r\nit8709_wm(dev, IT8709_WRITE, IT8709_MODE);\r\n}\r\nstatic int it8709_get_irq_causes(struct ite_dev *dev)\r\n{\r\nu8 iflags;\r\nint ret = 0;\r\nite_dbg("%s called", __func__);\r\niflags = it8709_rm(dev, IT8709_IIR);\r\nif (iflags & IT85_TLDLI)\r\nret |= ITE_IRQ_TX_FIFO;\r\nif (iflags & IT85_RDAI)\r\nret |= ITE_IRQ_RX_FIFO;\r\nif (iflags & IT85_RFOI)\r\nret |= ITE_IRQ_RX_FIFO_OVERRUN;\r\nreturn ret;\r\n}\r\nstatic void it8709_set_carrier_params(struct ite_dev *dev, bool high_freq,\r\nbool use_demodulator,\r\nu8 carrier_freq_bits, u8 allowance_bits,\r\nu8 pulse_width_bits)\r\n{\r\nu8 val;\r\nite_dbg("%s called", __func__);\r\nval = (it8709_rr(dev, IT85_C0CFR)\r\n&~(IT85_HCFS | IT85_CFQ)) |\r\ncarrier_freq_bits;\r\nif (high_freq)\r\nval |= IT85_HCFS;\r\nit8709_wr(dev, val, IT85_C0CFR);\r\nval = it8709_rr(dev, IT85_C0RCR)\r\n& ~(IT85_RXEND | IT85_RXDCR);\r\nif (use_demodulator)\r\nval |= IT85_RXEND;\r\nval |= allowance_bits;\r\nit8709_wr(dev, val, IT85_C0RCR);\r\nval = it8709_rr(dev, IT85_C0TCR) & ~IT85_TXMPW;\r\nval |= pulse_width_bits;\r\nit8709_wr(dev, val, IT85_C0TCR);\r\n}\r\nstatic int it8709_get_rx_bytes(struct ite_dev *dev, u8 * buf, int buf_size)\r\n{\r\nint fifo, read = 0;\r\nite_dbg("%s called", __func__);\r\nfifo = it8709_rm(dev, IT8709_RFSR) & IT85_RXFBC;\r\nwhile (fifo > 0 && buf_size > 0) {\r\n*(buf++) = it8709_rm(dev, IT8709_FIFO + read);\r\nfifo--;\r\nread++;\r\nbuf_size--;\r\n}\r\nit8709_wm(dev, 0, IT8709_RFSR);\r\nreturn read;\r\n}\r\nstatic int it8709_get_tx_used_slots(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nreturn it8709_rr(dev, IT85_C0TFSR) & IT85_TXFBC;\r\n}\r\nstatic void it8709_put_tx_byte(struct ite_dev *dev, u8 value)\r\n{\r\nit8709_wr(dev, value, IT85_C0DR);\r\n}\r\nstatic void it8709_idle_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0RCR) | IT85_RXACT,\r\nIT85_C0RCR);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0MSTCR) | IT85_FIFOCLR,\r\nIT85_C0MSTCR);\r\n}\r\nstatic void it8709_disable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER) &\r\n~(IT85_RDAIE | IT85_RFOIE),\r\nIT85_C0IER);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0RCR) & ~IT85_RXEN,\r\nIT85_C0RCR);\r\nit8709_idle_rx(dev);\r\n}\r\nstatic void it8709_enable_rx(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0RCR) | IT85_RXEN,\r\nIT85_C0RCR);\r\nit8709_idle_rx(dev);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER)\r\n|IT85_RDAIE | IT85_RFOIE | IT85_IEC,\r\nIT85_C0IER);\r\n}\r\nstatic void it8709_disable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER) & ~IT85_TLDLIE,\r\nIT85_C0IER);\r\n}\r\nstatic void it8709_enable_tx_interrupt(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER)\r\n|IT85_TLDLIE | IT85_IEC,\r\nIT85_C0IER);\r\n}\r\nstatic void it8709_disable(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER) &\r\n~(IT85_IEC | IT85_RFOIE | IT85_RDAIE | IT85_TLDLIE),\r\nIT85_C0IER);\r\nit8709_disable_rx(dev);\r\nit8709_wr(dev, IT85_FIFOCLR | it8709_rr(dev, IT85_C0MSTCR),\r\nIT85_C0MSTCR);\r\n}\r\nstatic void it8709_init_hardware(struct ite_dev *dev)\r\n{\r\nite_dbg("%s called", __func__);\r\nit8709_wr(dev, it8709_rr(dev, IT85_C0IER) &\r\n~(IT85_IEC | IT85_RFOIE | IT85_RDAIE | IT85_TLDLIE),\r\nIT85_C0IER);\r\nit8709_wr(dev, ITE_BAUDRATE_DIVISOR & 0xff, IT85_C0BDLR);\r\nit8709_wr(dev, (ITE_BAUDRATE_DIVISOR >> 8) & 0xff,\r\nIT85_C0BDHR);\r\nit8709_wr(dev, (it8709_rr(dev, IT85_C0MSTCR) &\r\n~(IT85_ILSEL | IT85_ILE | IT85_FIFOTL\r\n| IT85_FIFOCLR | IT85_RESET)) | IT85_FIFOTL_DEFAULT,\r\nIT85_C0MSTCR);\r\nit8709_wr(dev, (it8709_rr(dev, IT85_C0RCR) &\r\n~(IT85_RXEN | IT85_RDWOS | IT85_RXEND | IT85_RXACT\r\n| IT85_RXDCR)) | ITE_RXDCR_DEFAULT,\r\nIT85_C0RCR);\r\nit8709_wr(dev, (it8709_rr(dev, IT85_C0TCR) & ~(IT85_TXMPM | IT85_TXMPW))\r\n| IT85_TXRLE | IT85_TXENDF | IT85_TXMPM_DEFAULT\r\n| IT85_TXMPW_DEFAULT,\r\nIT85_C0TCR);\r\nite_set_carrier_params(dev);\r\n}\r\nstatic int ite_open(struct rc_dev *rcdev)\r\n{\r\nstruct ite_dev *dev = rcdev->priv;\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->in_use = true;\r\ndev->params.enable_rx(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void ite_close(struct rc_dev *rcdev)\r\n{\r\nstruct ite_dev *dev = rcdev->priv;\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->in_use = false;\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nwait_event_interruptible(dev->tx_ended, !dev->transmitting);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.disable(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\n}\r\nstatic int ite_probe(struct pnp_dev *pdev, const struct pnp_device_id\r\n*dev_id)\r\n{\r\nconst struct ite_dev_params *dev_desc = NULL;\r\nstruct ite_dev *itdev = NULL;\r\nstruct rc_dev *rdev = NULL;\r\nint ret = -ENOMEM;\r\nint model_no;\r\nint io_rsrc_no;\r\nite_dbg("%s called", __func__);\r\nitdev = kzalloc(sizeof(struct ite_dev), GFP_KERNEL);\r\nif (!itdev)\r\nreturn ret;\r\nrdev = rc_allocate_device(RC_DRIVER_IR_RAW);\r\nif (!rdev)\r\ngoto exit_free_dev_rdev;\r\nitdev->rdev = rdev;\r\nret = -ENODEV;\r\nmodel_no = (int)dev_id->driver_data;\r\nite_pr(KERN_NOTICE, "Auto-detected model: %s\n",\r\nite_dev_descs[model_no].model);\r\nif (model_number >= 0 && model_number < ARRAY_SIZE(ite_dev_descs)) {\r\nmodel_no = model_number;\r\nite_pr(KERN_NOTICE, "The model has been fixed by a module parameter.");\r\n}\r\nite_pr(KERN_NOTICE, "Using model: %s\n", ite_dev_descs[model_no].model);\r\ndev_desc = &ite_dev_descs[model_no];\r\nio_rsrc_no = dev_desc->io_rsrc_no;\r\nif (!pnp_port_valid(pdev, io_rsrc_no) ||\r\npnp_port_len(pdev, io_rsrc_no) != dev_desc->io_region_size) {\r\ndev_err(&pdev->dev, "IR PNP Port not valid!\n");\r\ngoto exit_free_dev_rdev;\r\n}\r\nif (!pnp_irq_valid(pdev, 0)) {\r\ndev_err(&pdev->dev, "PNP IRQ not valid!\n");\r\ngoto exit_free_dev_rdev;\r\n}\r\nitdev->cir_addr = pnp_port_start(pdev, io_rsrc_no);\r\nitdev->cir_irq = pnp_irq(pdev, 0);\r\nspin_lock_init(&itdev->lock);\r\ninit_ir_raw_event(&itdev->rawir);\r\npnp_set_drvdata(pdev, itdev);\r\nitdev->pdev = pdev;\r\ninit_waitqueue_head(&itdev->tx_queue);\r\ninit_waitqueue_head(&itdev->tx_ended);\r\nitdev->params = *dev_desc;\r\nif (sample_period > 0)\r\nitdev->params.sample_period = sample_period;\r\nif (tx_carrier_freq > 0)\r\nitdev->params.tx_carrier_freq = tx_carrier_freq;\r\nif (tx_duty_cycle > 0 && tx_duty_cycle <= 100)\r\nitdev->params.tx_duty_cycle = tx_duty_cycle;\r\nif (rx_low_carrier_freq > 0)\r\nitdev->params.rx_low_carrier_freq = rx_low_carrier_freq;\r\nif (rx_high_carrier_freq > 0)\r\nitdev->params.rx_high_carrier_freq = rx_high_carrier_freq;\r\nite_pr(KERN_NOTICE, "TX-capable: %d\n", (int)\r\nitdev->params.hw_tx_capable);\r\nite_pr(KERN_NOTICE, "Sample period (ns): %ld\n", (long)\r\nitdev->params.sample_period);\r\nite_pr(KERN_NOTICE, "TX carrier frequency (Hz): %d\n", (int)\r\nitdev->params.tx_carrier_freq);\r\nite_pr(KERN_NOTICE, "TX duty cycle (%%): %d\n", (int)\r\nitdev->params.tx_duty_cycle);\r\nite_pr(KERN_NOTICE, "RX low carrier frequency (Hz): %d\n", (int)\r\nitdev->params.rx_low_carrier_freq);\r\nite_pr(KERN_NOTICE, "RX high carrier frequency (Hz): %d\n", (int)\r\nitdev->params.rx_high_carrier_freq);\r\nitdev->params.init_hardware(itdev);\r\nrdev->priv = itdev;\r\nrdev->allowed_protocols = RC_BIT_ALL_IR_DECODER;\r\nrdev->open = ite_open;\r\nrdev->close = ite_close;\r\nrdev->s_idle = ite_s_idle;\r\nrdev->s_rx_carrier_range = ite_set_rx_carrier_range;\r\nrdev->min_timeout = ITE_MIN_IDLE_TIMEOUT;\r\nrdev->max_timeout = ITE_MAX_IDLE_TIMEOUT;\r\nrdev->timeout = ITE_IDLE_TIMEOUT;\r\nrdev->rx_resolution = ITE_BAUDRATE_DIVISOR *\r\nitdev->params.sample_period;\r\nrdev->tx_resolution = ITE_BAUDRATE_DIVISOR *\r\nitdev->params.sample_period;\r\nif (itdev->params.hw_tx_capable) {\r\nrdev->tx_ir = ite_tx_ir;\r\nrdev->s_tx_carrier = ite_set_tx_carrier;\r\nrdev->s_tx_duty_cycle = ite_set_tx_duty_cycle;\r\n}\r\nrdev->input_name = dev_desc->model;\r\nrdev->input_id.bustype = BUS_HOST;\r\nrdev->input_id.vendor = PCI_VENDOR_ID_ITE;\r\nrdev->input_id.product = 0;\r\nrdev->input_id.version = 0;\r\nrdev->driver_name = ITE_DRIVER_NAME;\r\nrdev->map_name = RC_MAP_RC6_MCE;\r\nret = rc_register_device(rdev);\r\nif (ret)\r\ngoto exit_free_dev_rdev;\r\nret = -EBUSY;\r\nif (!request_region(itdev->cir_addr,\r\ndev_desc->io_region_size, ITE_DRIVER_NAME))\r\ngoto exit_unregister_device;\r\nif (request_irq(itdev->cir_irq, ite_cir_isr, IRQF_SHARED,\r\nITE_DRIVER_NAME, (void *)itdev))\r\ngoto exit_release_cir_addr;\r\nite_pr(KERN_NOTICE, "driver has been successfully loaded\n");\r\nreturn 0;\r\nexit_release_cir_addr:\r\nrelease_region(itdev->cir_addr, itdev->params.io_region_size);\r\nexit_unregister_device:\r\nrc_unregister_device(rdev);\r\nrdev = NULL;\r\nexit_free_dev_rdev:\r\nrc_free_device(rdev);\r\nkfree(itdev);\r\nreturn ret;\r\n}\r\nstatic void ite_remove(struct pnp_dev *pdev)\r\n{\r\nstruct ite_dev *dev = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.disable(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nfree_irq(dev->cir_irq, dev);\r\nrelease_region(dev->cir_addr, dev->params.io_region_size);\r\nrc_unregister_device(dev->rdev);\r\nkfree(dev);\r\n}\r\nstatic int ite_suspend(struct pnp_dev *pdev, pm_message_t state)\r\n{\r\nstruct ite_dev *dev = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nwait_event_interruptible(dev->tx_ended, !dev->transmitting);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.disable(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ite_resume(struct pnp_dev *pdev)\r\n{\r\nstruct ite_dev *dev = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.init_hardware(dev);\r\ndev->params.enable_rx(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void ite_shutdown(struct pnp_dev *pdev)\r\n{\r\nstruct ite_dev *dev = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nite_dbg("%s called", __func__);\r\nspin_lock_irqsave(&dev->lock, flags);\r\ndev->params.disable(dev);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\n}

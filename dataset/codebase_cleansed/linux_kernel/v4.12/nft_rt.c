void nft_rt_get_eval(const struct nft_expr *expr,\r\nstruct nft_regs *regs,\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nconst struct nft_rt *priv = nft_expr_priv(expr);\r\nconst struct sk_buff *skb = pkt->skb;\r\nu32 *dest = &regs->data[priv->dreg];\r\nconst struct dst_entry *dst;\r\ndst = skb_dst(skb);\r\nif (!dst)\r\ngoto err;\r\nswitch (priv->key) {\r\n#ifdef CONFIG_IP_ROUTE_CLASSID\r\ncase NFT_RT_CLASSID:\r\n*dest = dst->tclassid;\r\nbreak;\r\n#endif\r\ncase NFT_RT_NEXTHOP4:\r\nif (nft_pf(pkt) != NFPROTO_IPV4)\r\ngoto err;\r\n*dest = rt_nexthop((const struct rtable *)dst,\r\nip_hdr(skb)->daddr);\r\nbreak;\r\ncase NFT_RT_NEXTHOP6:\r\nif (nft_pf(pkt) != NFPROTO_IPV6)\r\ngoto err;\r\nmemcpy(dest, rt6_nexthop((struct rt6_info *)dst,\r\n&ipv6_hdr(skb)->daddr),\r\nsizeof(struct in6_addr));\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\ngoto err;\r\n}\r\nreturn;\r\nerr:\r\nregs->verdict.code = NFT_BREAK;\r\n}\r\nint nft_rt_get_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_rt *priv = nft_expr_priv(expr);\r\nunsigned int len;\r\nif (tb[NFTA_RT_KEY] == NULL ||\r\ntb[NFTA_RT_DREG] == NULL)\r\nreturn -EINVAL;\r\npriv->key = ntohl(nla_get_be32(tb[NFTA_RT_KEY]));\r\nswitch (priv->key) {\r\n#ifdef CONFIG_IP_ROUTE_CLASSID\r\ncase NFT_RT_CLASSID:\r\n#endif\r\ncase NFT_RT_NEXTHOP4:\r\nlen = sizeof(u32);\r\nbreak;\r\ncase NFT_RT_NEXTHOP6:\r\nlen = sizeof(struct in6_addr);\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\npriv->dreg = nft_parse_register(tb[NFTA_RT_DREG]);\r\nreturn nft_validate_register_store(ctx, priv->dreg, NULL,\r\nNFT_DATA_VALUE, len);\r\n}\r\nint nft_rt_get_dump(struct sk_buff *skb,\r\nconst struct nft_expr *expr)\r\n{\r\nconst struct nft_rt *priv = nft_expr_priv(expr);\r\nif (nla_put_be32(skb, NFTA_RT_KEY, htonl(priv->key)))\r\ngoto nla_put_failure;\r\nif (nft_dump_register(skb, NFTA_RT_DREG, priv->dreg))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int __init nft_rt_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_rt_type);\r\n}\r\nstatic void __exit nft_rt_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_rt_type);\r\n}

int asoc_simple_card_parse_daifmt(struct device *dev,\r\nstruct device_node *node,\r\nstruct device_node *codec,\r\nchar *prefix,\r\nunsigned int *retfmt)\r\n{\r\nstruct device_node *bitclkmaster = NULL;\r\nstruct device_node *framemaster = NULL;\r\nint prefix_len = prefix ? strlen(prefix) : 0;\r\nunsigned int daifmt;\r\ndaifmt = snd_soc_of_parse_daifmt(node, prefix,\r\n&bitclkmaster, &framemaster);\r\ndaifmt &= ~SND_SOC_DAIFMT_MASTER_MASK;\r\nif (prefix_len && !bitclkmaster && !framemaster) {\r\ndev_dbg(dev, "Revert to legacy daifmt parsing\n");\r\ndaifmt = snd_soc_of_parse_daifmt(codec, NULL, NULL, NULL) |\r\n(daifmt & ~SND_SOC_DAIFMT_CLOCK_MASK);\r\n} else {\r\nif (codec == bitclkmaster)\r\ndaifmt |= (codec == framemaster) ?\r\nSND_SOC_DAIFMT_CBM_CFM : SND_SOC_DAIFMT_CBM_CFS;\r\nelse\r\ndaifmt |= (codec == framemaster) ?\r\nSND_SOC_DAIFMT_CBS_CFM : SND_SOC_DAIFMT_CBS_CFS;\r\n}\r\nof_node_put(bitclkmaster);\r\nof_node_put(framemaster);\r\n*retfmt = daifmt;\r\nreturn 0;\r\n}\r\nint asoc_simple_card_set_dailink_name(struct device *dev,\r\nstruct snd_soc_dai_link *dai_link,\r\nconst char *fmt, ...)\r\n{\r\nva_list ap;\r\nchar *name = NULL;\r\nint ret = -ENOMEM;\r\nva_start(ap, fmt);\r\nname = devm_kvasprintf(dev, GFP_KERNEL, fmt, ap);\r\nva_end(ap);\r\nif (name) {\r\nret = 0;\r\ndai_link->name = name;\r\ndai_link->stream_name = name;\r\n}\r\nreturn ret;\r\n}\r\nint asoc_simple_card_parse_card_name(struct snd_soc_card *card,\r\nchar *prefix)\r\n{\r\nchar prop[128];\r\nint ret;\r\nsnprintf(prop, sizeof(prop), "%sname", prefix);\r\nret = snd_soc_of_parse_card_name(card, prop);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!card->name && card->dai_link)\r\ncard->name = card->dai_link->name;\r\nreturn 0;\r\n}\r\nint asoc_simple_card_parse_clk(struct device *dev,\r\nstruct device_node *node,\r\nstruct device_node *dai_of_node,\r\nstruct asoc_simple_dai *simple_dai)\r\n{\r\nstruct clk *clk;\r\nu32 val;\r\nclk = devm_get_clk_from_child(dev, node, NULL);\r\nif (!IS_ERR(clk)) {\r\nsimple_dai->sysclk = clk_get_rate(clk);\r\nsimple_dai->clk = clk;\r\n} else if (!of_property_read_u32(node, "system-clock-frequency", &val)) {\r\nsimple_dai->sysclk = val;\r\n} else {\r\nclk = devm_get_clk_from_child(dev, dai_of_node, NULL);\r\nif (!IS_ERR(clk))\r\nsimple_dai->sysclk = clk_get_rate(clk);\r\n}\r\nreturn 0;\r\n}\r\nint asoc_simple_card_parse_dai(struct device_node *node,\r\nstruct device_node **dai_of_node,\r\nconst char **dai_name,\r\nconst char *list_name,\r\nconst char *cells_name,\r\nint *is_single_link)\r\n{\r\nstruct of_phandle_args args;\r\nint ret;\r\nif (!node)\r\nreturn 0;\r\nret = of_parse_phandle_with_args(node, list_name, cells_name, 0, &args);\r\nif (ret)\r\nreturn ret;\r\nif (dai_name) {\r\nret = snd_soc_of_get_dai_name(node, dai_name);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n*dai_of_node = args.np;\r\nif (is_single_link)\r\n*is_single_link = !args.args_count;\r\nreturn 0;\r\n}\r\nint asoc_simple_card_init_dai(struct snd_soc_dai *dai,\r\nstruct asoc_simple_dai *simple_dai)\r\n{\r\nint ret;\r\nif (simple_dai->sysclk) {\r\nret = snd_soc_dai_set_sysclk(dai, 0, simple_dai->sysclk, 0);\r\nif (ret && ret != -ENOTSUPP) {\r\ndev_err(dai->dev, "simple-card: set_sysclk error\n");\r\nreturn ret;\r\n}\r\n}\r\nif (simple_dai->slots) {\r\nret = snd_soc_dai_set_tdm_slot(dai,\r\nsimple_dai->tx_slot_mask,\r\nsimple_dai->rx_slot_mask,\r\nsimple_dai->slots,\r\nsimple_dai->slot_width);\r\nif (ret && ret != -ENOTSUPP) {\r\ndev_err(dai->dev, "simple-card: set_tdm_slot error\n");\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint asoc_simple_card_canonicalize_dailink(struct snd_soc_dai_link *dai_link)\r\n{\r\nif (!dai_link->platform_of_node)\r\ndai_link->platform_of_node = dai_link->cpu_of_node;\r\nreturn 0;\r\n}\r\nvoid asoc_simple_card_canonicalize_cpu(struct snd_soc_dai_link *dai_link,\r\nint is_single_links)\r\n{\r\nif (is_single_links)\r\ndai_link->cpu_dai_name = NULL;\r\n}\r\nint asoc_simple_card_clean_reference(struct snd_soc_card *card)\r\n{\r\nstruct snd_soc_dai_link *dai_link;\r\nint num_links;\r\nfor (num_links = 0, dai_link = card->dai_link;\r\nnum_links < card->num_links;\r\nnum_links++, dai_link++) {\r\nof_node_put(dai_link->cpu_of_node);\r\nof_node_put(dai_link->codec_of_node);\r\n}\r\nreturn 0;\r\n}

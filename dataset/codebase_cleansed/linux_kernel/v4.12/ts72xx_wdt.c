static int ts72xx_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\r\nwriteb(priv->regval, priv->control_reg);\r\nreturn 0;\r\n}\r\nstatic int ts72xx_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\r\nwriteb(TS72XX_WDT_CTRL_DISABLE, priv->control_reg);\r\nreturn 0;\r\n}\r\nstatic int ts72xx_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\r\nreturn 0;\r\n}\r\nstatic int ts72xx_wdt_settimeout(struct watchdog_device *wdd, unsigned int to)\r\n{\r\nstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nif (to == 1) {\r\npriv->regval = TS72XX_WDT_CTRL_1SEC;\r\n} else if (to == 2) {\r\npriv->regval = TS72XX_WDT_CTRL_2SEC;\r\n} else if (to <= 4) {\r\npriv->regval = TS72XX_WDT_CTRL_4SEC;\r\nto = 4;\r\n} else {\r\npriv->regval = TS72XX_WDT_CTRL_8SEC;\r\nif (to <= 8)\r\nto = 8;\r\n}\r\nwdd->timeout = to;\r\nif (watchdog_active(wdd)) {\r\nts72xx_wdt_stop(wdd);\r\nts72xx_wdt_start(wdd);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ts72xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct ts72xx_wdt_priv *priv;\r\nstruct watchdog_device *wdd;\r\nstruct resource *res;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->control_reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->control_reg))\r\nreturn PTR_ERR(priv->control_reg);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\npriv->feed_reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->feed_reg))\r\nreturn PTR_ERR(priv->feed_reg);\r\nwdd = &priv->wdd;\r\nwdd->info = &ts72xx_wdt_ident;\r\nwdd->ops = &ts72xx_wdt_ops;\r\nwdd->min_timeout = 1;\r\nwdd->max_hw_heartbeat_ms = 8000;\r\nwdd->parent = &pdev->dev;\r\nwatchdog_set_nowayout(wdd, nowayout);\r\nwdd->timeout = TS72XX_WDT_DEFAULT_TIMEOUT;\r\nwatchdog_init_timeout(wdd, timeout, &pdev->dev);\r\nwatchdog_set_drvdata(wdd, priv);\r\nret = devm_watchdog_register_device(&pdev->dev, wdd);\r\nif (ret)\r\nreturn ret;\r\ndev_info(&pdev->dev, "TS-72xx Watchdog driver\n");\r\nreturn 0;\r\n}

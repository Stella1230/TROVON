static void piix4_poweroff(void)\r\n{\r\nint spec_devid;\r\nu16 sts;\r\nwhile (1) {\r\nsts = inw(io_offset + PIIX4_FUNC3IO_PMSTS);\r\nif (!(sts & PIIX4_FUNC3IO_PMSTS_PWRBTN_STS))\r\nbreak;\r\noutw(sts, io_offset + PIIX4_FUNC3IO_PMSTS);\r\n}\r\noutw(PIIX4_FUNC3IO_PMCNTRL_SUS_TYP_SOFF | PIIX4_FUNC3IO_PMCNTRL_SUS_EN,\r\nio_offset + PIIX4_FUNC3IO_PMCNTRL);\r\nmdelay(10);\r\nspec_devid = PCI_DEVID(0, PCI_DEVFN(0x1f, 0x7));\r\npci_bus_write_config_dword(pm_dev->bus, spec_devid, 0,\r\nPIIX4_SUSPEND_MAGIC);\r\nmdelay(1000);\r\npr_emerg("Unable to poweroff system\n");\r\n}\r\nstatic int piix4_poweroff_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nint res;\r\nif (pm_dev)\r\nreturn -EINVAL;\r\nres = pci_request_region(dev, piix4_pm_io_region,\r\n"PIIX4 PM IO registers");\r\nif (res) {\r\ndev_err(&dev->dev, "failed to request PM IO registers: %d\n",\r\nres);\r\nreturn res;\r\n}\r\npm_dev = dev;\r\nio_offset = pci_resource_start(dev, piix4_pm_io_region);\r\npm_power_off = piix4_poweroff;\r\nreturn 0;\r\n}\r\nstatic void piix4_poweroff_remove(struct pci_dev *dev)\r\n{\r\nif (pm_power_off == piix4_poweroff)\r\npm_power_off = NULL;\r\npci_release_region(dev, piix4_pm_io_region);\r\npm_dev = NULL;\r\n}

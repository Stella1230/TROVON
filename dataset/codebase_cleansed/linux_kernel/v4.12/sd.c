static inline void sd_set_err_code(struct rtsx_chip *chip, u8 err_code)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nsd_card->err_code |= err_code;\r\n}\r\nstatic inline void sd_clr_err_code(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nsd_card->err_code = 0;\r\n}\r\nstatic inline int sd_check_err_code(struct rtsx_chip *chip, u8 err_code)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nreturn sd_card->err_code & err_code;\r\n}\r\nstatic void sd_init_reg_addr(struct rtsx_chip *chip)\r\n{\r\nREG_SD_CFG1 = 0xFD31;\r\nREG_SD_CFG2 = 0xFD33;\r\nREG_SD_CFG3 = 0xFD3E;\r\nREG_SD_STAT1 = 0xFD30;\r\nREG_SD_STAT2 = 0;\r\nREG_SD_BUS_STAT = 0;\r\nREG_SD_PAD_CTL = 0;\r\nREG_SD_SAMPLE_POINT_CTL = 0;\r\nREG_SD_PUSH_POINT_CTL = 0;\r\nREG_SD_CMD0 = 0xFD34;\r\nREG_SD_CMD1 = 0xFD35;\r\nREG_SD_CMD2 = 0xFD36;\r\nREG_SD_CMD3 = 0xFD37;\r\nREG_SD_CMD4 = 0xFD38;\r\nREG_SD_CMD5 = 0xFD5A;\r\nREG_SD_BYTE_CNT_L = 0xFD39;\r\nREG_SD_BYTE_CNT_H = 0xFD3A;\r\nREG_SD_BLOCK_CNT_L = 0xFD3B;\r\nREG_SD_BLOCK_CNT_H = 0xFD3C;\r\nREG_SD_TRANSFER = 0xFD32;\r\nREG_SD_VPCLK0_CTL = 0;\r\nREG_SD_VPCLK1_CTL = 0;\r\nREG_SD_DCMPS0_CTL = 0;\r\nREG_SD_DCMPS1_CTL = 0;\r\n}\r\nstatic int sd_check_data0_status(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 stat;\r\nretval = rtsx_read_register(chip, REG_SD_STAT1, &stat);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (!(stat & SD_DAT0_STATUS)) {\r\nsd_set_err_code(chip, SD_BUSY);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_read_data(struct rtsx_chip *chip,\r\nu8 trans_mode, u8 *cmd, int cmd_len, u16 byte_cnt,\r\nu16 blk_cnt, u8 bus_width, u8 *buf, int buf_len,\r\nint timeout)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i;\r\nsd_clr_err_code(chip);\r\nif (!buf)\r\nbuf_len = 0;\r\nif (buf_len > 512) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nrtsx_init_cmd(chip);\r\nif (cmd_len) {\r\ndev_dbg(rtsx_dev(chip), "SD/MMC CMD %d\n", cmd[0] - 0x40);\r\nfor (i = 0; i < (min(cmd_len, 6)); i++)\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0 + i,\r\n0xFF, cmd[i]);\r\n}\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\r\n(u8)byte_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\r\n(u8)(byte_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\r\n(u8)blk_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\r\n(u8)(blk_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\r\nSD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\r\nSD_CHECK_CRC7 | SD_RSP_LEN_6);\r\nif (trans_mode != SD_TM_AUTO_TUNING)\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nCARD_DATA_SOURCE, 0x01, PINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\ntrans_mode | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\r\nSD_TRANSFER_END);\r\nretval = rtsx_send_cmd(chip, SD_CARD, timeout);\r\nif (retval < 0) {\r\nif (retval == -ETIMEDOUT) {\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (buf && buf_len) {\r\nretval = rtsx_read_ppbuf(chip, buf, buf_len);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_write_data(struct rtsx_chip *chip, u8 trans_mode,\r\nu8 *cmd, int cmd_len, u16 byte_cnt, u16 blk_cnt,\r\nu8 bus_width, u8 *buf, int buf_len, int timeout)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i;\r\nsd_clr_err_code(chip);\r\nif (!buf)\r\nbuf_len = 0;\r\nif (buf_len > 512) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (buf && buf_len) {\r\nretval = rtsx_write_ppbuf(chip, buf, buf_len);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nrtsx_init_cmd(chip);\r\nif (cmd_len) {\r\ndev_dbg(rtsx_dev(chip), "SD/MMC CMD %d\n", cmd[0] - 0x40);\r\nfor (i = 0; i < (min(cmd_len, 6)); i++) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nREG_SD_CMD0 + i, 0xFF, cmd[i]);\r\n}\r\n}\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\r\n(u8)byte_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\r\n(u8)(byte_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\r\n(u8)blk_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\r\n(u8)(blk_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\r\nSD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\r\nSD_CHECK_CRC7 | SD_RSP_LEN_6);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\ntrans_mode | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\r\nSD_TRANSFER_END);\r\nretval = rtsx_send_cmd(chip, SD_CARD, timeout);\r\nif (retval < 0) {\r\nif (retval == -ETIMEDOUT) {\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_check_csd(struct rtsx_chip *chip, char check_wp)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i;\r\nu8 csd_ver, trans_speed;\r\nu8 rsp[16];\r\nfor (i = 0; i < 6; i++) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SEND_CSD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R2, rsp, 16);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == 6) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nmemcpy(sd_card->raw_csd, rsp + 1, 15);\r\ndev_dbg(rtsx_dev(chip), "CSD Response:\n");\r\ndev_dbg(rtsx_dev(chip), "%*ph\n", 16, sd_card->raw_csd);\r\ncsd_ver = (rsp[1] & 0xc0) >> 6;\r\ndev_dbg(rtsx_dev(chip), "csd_ver = %d\n", csd_ver);\r\ntrans_speed = rsp[4];\r\nif ((trans_speed & 0x07) == 0x02) {\r\nif ((trans_speed & 0xf8) >= 0x30) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 47;\r\nelse\r\nsd_card->sd_clock = CLK_50;\r\n} else if ((trans_speed & 0xf8) == 0x28) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 39;\r\nelse\r\nsd_card->sd_clock = CLK_40;\r\n} else if ((trans_speed & 0xf8) == 0x20) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 29;\r\nelse\r\nsd_card->sd_clock = CLK_30;\r\n} else if ((trans_speed & 0xf8) >= 0x10) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 23;\r\nelse\r\nsd_card->sd_clock = CLK_20;\r\n} else if ((trans_speed & 0x08) >= 0x08) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 19;\r\nelse\r\nsd_card->sd_clock = CLK_20;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MMC_SECTOR_MODE(sd_card)) {\r\nsd_card->capacity = 0;\r\n} else {\r\nif ((!CHK_SD_HCXC(sd_card)) || (csd_ver == 0)) {\r\nu8 blk_size, c_size_mult;\r\nu16 c_size;\r\nblk_size = rsp[6] & 0x0F;\r\nc_size = ((u16)(rsp[7] & 0x03) << 10)\r\n+ ((u16)rsp[8] << 2)\r\n+ ((u16)(rsp[9] & 0xC0) >> 6);\r\nc_size_mult = (u8)((rsp[10] & 0x03) << 1);\r\nc_size_mult += (rsp[11] & 0x80) >> 7;\r\nsd_card->capacity = (((u32)(c_size + 1)) *\r\n(1 << (c_size_mult + 2)))\r\n<< (blk_size - 9);\r\n} else {\r\nu32 total_sector = 0;\r\ntotal_sector = (((u32)rsp[8] & 0x3f) << 16) |\r\n((u32)rsp[9] << 8) | (u32)rsp[10];\r\nsd_card->capacity = (total_sector + 1) << 10;\r\n}\r\n}\r\nif (check_wp) {\r\nif (rsp[15] & 0x30)\r\nchip->card_wp |= SD_CARD;\r\ndev_dbg(rtsx_dev(chip), "CSD WP Status: 0x%x\n", rsp[15]);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_set_sample_push_timing(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nu8 val = 0;\r\nif ((chip->sd_ctl & SD_PUSH_POINT_CTL_MASK) == SD_PUSH_POINT_DELAY)\r\nval |= 0x10;\r\nif ((chip->sd_ctl & SD_SAMPLE_POINT_CTL_MASK) == SD_SAMPLE_POINT_AUTO) {\r\nif (chip->asic_code) {\r\nif (CHK_SD_HS(sd_card) || CHK_MMC_52M(sd_card)) {\r\nif (val & 0x10)\r\nval |= 0x04;\r\nelse\r\nval |= 0x08;\r\n}\r\n} else {\r\nif (val & 0x10)\r\nval |= 0x04;\r\nelse\r\nval |= 0x08;\r\n}\r\n} else if ((chip->sd_ctl & SD_SAMPLE_POINT_CTL_MASK) ==\r\nSD_SAMPLE_POINT_DELAY) {\r\nif (val & 0x10)\r\nval |= 0x04;\r\nelse\r\nval |= 0x08;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x1C, val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic void sd_choose_proper_clock(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nif (CHK_SD_SDR104(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = chip->asic_sd_sdr104_clk;\r\nelse\r\nsd_card->sd_clock = chip->fpga_sd_sdr104_clk;\r\n} else if (CHK_SD_DDR50(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = chip->asic_sd_ddr50_clk;\r\nelse\r\nsd_card->sd_clock = chip->fpga_sd_ddr50_clk;\r\n} else if (CHK_SD_SDR50(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = chip->asic_sd_sdr50_clk;\r\nelse\r\nsd_card->sd_clock = chip->fpga_sd_sdr50_clk;\r\n} else if (CHK_SD_HS(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = chip->asic_sd_hs_clk;\r\nelse\r\nsd_card->sd_clock = chip->fpga_sd_hs_clk;\r\n} else if (CHK_MMC_52M(sd_card) || CHK_MMC_DDR52(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = chip->asic_mmc_52m_clk;\r\nelse\r\nsd_card->sd_clock = chip->fpga_mmc_52m_clk;\r\n} else if (CHK_MMC_26M(sd_card)) {\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 48;\r\nelse\r\nsd_card->sd_clock = CLK_50;\r\n}\r\n}\r\nstatic int sd_set_clock_divider(struct rtsx_chip *chip, u8 clk_div)\r\n{\r\nint retval;\r\nu8 mask = 0, val = 0;\r\nmask = 0x60;\r\nif (clk_div == SD_CLK_DIVIDE_0)\r\nval = 0x00;\r\nelse if (clk_div == SD_CLK_DIVIDE_128)\r\nval = 0x40;\r\nelse if (clk_div == SD_CLK_DIVIDE_256)\r\nval = 0x20;\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, mask, val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_set_init_para(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nretval = sd_set_sample_push_timing(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsd_choose_proper_clock(chip);\r\nretval = switch_clock(chip, sd_card->sd_clock);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_select_card(struct rtsx_chip *chip, int select)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd_idx, cmd_type;\r\nu32 addr;\r\nif (select) {\r\ncmd_idx = SELECT_CARD;\r\ncmd_type = SD_RSP_TYPE_R1;\r\naddr = sd_card->sd_addr;\r\n} else {\r\ncmd_idx = DESELECT_CARD;\r\ncmd_type = SD_RSP_TYPE_R0;\r\naddr = 0;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, cmd_idx, addr, cmd_type, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_update_lock_status(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 rsp[5];\r\nretval = sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, rsp, 5);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (rsp[1] & 0x02)\r\nsd_card->sd_lock_status |= SD_LOCKED;\r\nelse\r\nsd_card->sd_lock_status &= ~SD_LOCKED;\r\ndev_dbg(rtsx_dev(chip), "sd_card->sd_lock_status = 0x%x\n",\r\nsd_card->sd_lock_status);\r\nif (rsp[1] & 0x01) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_wait_state_data_ready(struct rtsx_chip *chip, u8 state,\r\nu8 data_ready, int polling_cnt)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval, i;\r\nu8 rsp[5];\r\nfor (i = 0; i < polling_cnt; i++) {\r\nretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr, SD_RSP_TYPE_R1,\r\nrsp, 5);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (((rsp[3] & 0x1E) == state) &&\r\n((rsp[3] & 0x01) == data_ready))\r\nreturn STATUS_SUCCESS;\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int sd_change_bank_voltage(struct rtsx_chip *chip, u8 voltage)\r\n{\r\nint retval;\r\nif (voltage == SD_IO_3V3) {\r\nif (chip->asic_code) {\r\nretval = rtsx_write_phy_register(chip, 0x08,\r\n0x4FC0 |\r\nchip->phy_voltage);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, SD_PAD_CTL,\r\nSD_IO_USING_1V8, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n} else if (voltage == SD_IO_1V8) {\r\nif (chip->asic_code) {\r\nretval = rtsx_write_phy_register(chip, 0x08,\r\n0x4C40 |\r\nchip->phy_voltage);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, SD_PAD_CTL,\r\nSD_IO_USING_1V8,\r\nSD_IO_USING_1V8);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_voltage_switch(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 stat;\r\nretval = rtsx_write_register(chip, SD_BUS_STAT,\r\nSD_CLK_TOGGLE_EN | SD_CLK_FORCE_STOP,\r\nSD_CLK_TOGGLE_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, VOLTAGE_SWITCH, 0, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nudelay(chip->sd_voltage_switch_delay);\r\nretval = rtsx_read_register(chip, SD_BUS_STAT, &stat);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (stat & (SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\r\nSD_DAT1_STATUS | SD_DAT0_STATUS)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, SD_BUS_STAT, 0xFF,\r\nSD_CLK_FORCE_STOP);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = sd_change_bank_voltage(chip, SD_IO_1V8);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nwait_timeout(50);\r\nretval = rtsx_write_register(chip, SD_BUS_STAT, 0xFF,\r\nSD_CLK_TOGGLE_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nwait_timeout(10);\r\nretval = rtsx_read_register(chip, SD_BUS_STAT, &stat);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif ((stat & (SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\r\nSD_DAT1_STATUS | SD_DAT0_STATUS)) !=\r\n(SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\r\nSD_DAT1_STATUS | SD_DAT0_STATUS)) {\r\ndev_dbg(rtsx_dev(chip), "SD_BUS_STAT: 0x%x\n", stat);\r\nrtsx_write_register(chip, SD_BUS_STAT, SD_CLK_TOGGLE_EN |\r\nSD_CLK_FORCE_STOP, 0);\r\nrtsx_write_register(chip, CARD_CLK_EN, 0xFF, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, SD_BUS_STAT,\r\nSD_CLK_TOGGLE_EN | SD_CLK_FORCE_STOP, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_reset_dcm(struct rtsx_chip *chip, u8 tune_dir)\r\n{\r\nint retval;\r\nif (tune_dir == TUNE_RX) {\r\nretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF,\r\nDCM_RESET | DCM_RX);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF, DCM_RX);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF,\r\nDCM_RESET | DCM_TX);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF, DCM_TX);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_change_phase(struct rtsx_chip *chip, u8 sample_point, u8 tune_dir)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nu16 SD_VP_CTL, SD_DCMPS_CTL;\r\nu8 val;\r\nint retval;\r\nbool ddr_rx = false;\r\ndev_dbg(rtsx_dev(chip), "sd_change_phase (sample_point = %d, tune_dir = %d)\n",\r\nsample_point, tune_dir);\r\nif (tune_dir == TUNE_RX) {\r\nSD_VP_CTL = SD_VPRX_CTL;\r\nSD_DCMPS_CTL = SD_DCMPS_RX_CTL;\r\nif (CHK_SD_DDR50(sd_card))\r\nddr_rx = true;\r\n} else {\r\nSD_VP_CTL = SD_VPTX_CTL;\r\nSD_DCMPS_CTL = SD_DCMPS_TX_CTL;\r\n}\r\nif (chip->asic_code) {\r\nretval = rtsx_write_register(chip, CLK_CTL, CHANGE_CLK,\r\nCHANGE_CLK);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, SD_VP_CTL, 0x1F,\r\nsample_point);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, SD_VPCLK0_CTL,\r\nPHASE_NOT_RESET, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, SD_VPCLK0_CTL,\r\nPHASE_NOT_RESET, PHASE_NOT_RESET);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CLK_CTL, CHANGE_CLK, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else {\r\nrtsx_read_register(chip, SD_VP_CTL, &val);\r\ndev_dbg(rtsx_dev(chip), "SD_VP_CTL: 0x%x\n", val);\r\nrtsx_read_register(chip, SD_DCMPS_CTL, &val);\r\ndev_dbg(rtsx_dev(chip), "SD_DCMPS_CTL: 0x%x\n", val);\r\nif (ddr_rx) {\r\nretval = rtsx_write_register(chip, SD_VP_CTL,\r\nPHASE_CHANGE,\r\nPHASE_CHANGE);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nudelay(50);\r\nretval = rtsx_write_register(chip, SD_VP_CTL, 0xFF,\r\nPHASE_CHANGE |\r\nPHASE_NOT_RESET |\r\nsample_point);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, CLK_CTL,\r\nCHANGE_CLK, CHANGE_CLK);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nudelay(50);\r\nretval = rtsx_write_register(chip, SD_VP_CTL, 0xFF,\r\nPHASE_NOT_RESET |\r\nsample_point);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nudelay(100);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SD_DCMPS_CTL, DCMPS_CHANGE,\r\nDCMPS_CHANGE);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, SD_DCMPS_CTL,\r\nDCMPS_CHANGE_DONE, DCMPS_CHANGE_DONE);\r\nretval = rtsx_send_cmd(chip, SD_CARD, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto fail;\r\n}\r\nval = *rtsx_get_cmd_data(chip);\r\nif (val & DCMPS_ERROR) {\r\nrtsx_trace(chip);\r\ngoto fail;\r\n}\r\nif ((val & DCMPS_CURRENT_PHASE) != sample_point) {\r\nrtsx_trace(chip);\r\ngoto fail;\r\n}\r\nretval = rtsx_write_register(chip, SD_DCMPS_CTL,\r\nDCMPS_CHANGE, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (ddr_rx) {\r\nretval = rtsx_write_register(chip, SD_VP_CTL,\r\nPHASE_CHANGE, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, CLK_CTL,\r\nCHANGE_CLK, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nudelay(50);\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG1, SD_ASYNC_FIFO_NOT_RST, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\nfail:\r\nrtsx_read_register(chip, SD_VP_CTL, &val);\r\ndev_dbg(rtsx_dev(chip), "SD_VP_CTL: 0x%x\n", val);\r\nrtsx_read_register(chip, SD_DCMPS_CTL, &val);\r\ndev_dbg(rtsx_dev(chip), "SD_DCMPS_CTL: 0x%x\n", val);\r\nrtsx_write_register(chip, SD_DCMPS_CTL, DCMPS_CHANGE, 0);\r\nrtsx_write_register(chip, SD_VP_CTL, PHASE_CHANGE, 0);\r\nwait_timeout(10);\r\nsd_reset_dcm(chip, tune_dir);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int sd_check_spec(struct rtsx_chip *chip, u8 bus_width)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5], buf[8];\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ncmd[0] = 0x40 | SEND_SCR;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 8, 1, bus_width,\r\nbuf, 8, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nmemcpy(sd_card->raw_scr, buf, 8);\r\nif ((buf[0] & 0x0F) == 0) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_query_switch_result(struct rtsx_chip *chip, u8 func_group,\r\nu8 func_to_switch, u8 *buf, int buf_len)\r\n{\r\nu8 support_mask = 0, query_switch = 0, switch_busy = 0;\r\nint support_offset = 0, query_switch_offset = 0, check_busy_offset = 0;\r\nif (func_group == SD_FUNC_GROUP_1) {\r\nsupport_offset = FUNCTION_GROUP1_SUPPORT_OFFSET;\r\nquery_switch_offset = FUNCTION_GROUP1_QUERY_SWITCH_OFFSET;\r\ncheck_busy_offset = FUNCTION_GROUP1_CHECK_BUSY_OFFSET;\r\nswitch (func_to_switch) {\r\ncase HS_SUPPORT:\r\nsupport_mask = HS_SUPPORT_MASK;\r\nquery_switch = HS_QUERY_SWITCH_OK;\r\nswitch_busy = HS_SWITCH_BUSY;\r\nbreak;\r\ncase SDR50_SUPPORT:\r\nsupport_mask = SDR50_SUPPORT_MASK;\r\nquery_switch = SDR50_QUERY_SWITCH_OK;\r\nswitch_busy = SDR50_SWITCH_BUSY;\r\nbreak;\r\ncase SDR104_SUPPORT:\r\nsupport_mask = SDR104_SUPPORT_MASK;\r\nquery_switch = SDR104_QUERY_SWITCH_OK;\r\nswitch_busy = SDR104_SWITCH_BUSY;\r\nbreak;\r\ncase DDR50_SUPPORT:\r\nsupport_mask = DDR50_SUPPORT_MASK;\r\nquery_switch = DDR50_QUERY_SWITCH_OK;\r\nswitch_busy = DDR50_SWITCH_BUSY;\r\nbreak;\r\ndefault:\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else if (func_group == SD_FUNC_GROUP_3) {\r\nsupport_offset = FUNCTION_GROUP3_SUPPORT_OFFSET;\r\nquery_switch_offset = FUNCTION_GROUP3_QUERY_SWITCH_OFFSET;\r\ncheck_busy_offset = FUNCTION_GROUP3_CHECK_BUSY_OFFSET;\r\nswitch (func_to_switch) {\r\ncase DRIVING_TYPE_A:\r\nsupport_mask = DRIVING_TYPE_A_MASK;\r\nquery_switch = TYPE_A_QUERY_SWITCH_OK;\r\nswitch_busy = TYPE_A_SWITCH_BUSY;\r\nbreak;\r\ncase DRIVING_TYPE_C:\r\nsupport_mask = DRIVING_TYPE_C_MASK;\r\nquery_switch = TYPE_C_QUERY_SWITCH_OK;\r\nswitch_busy = TYPE_C_SWITCH_BUSY;\r\nbreak;\r\ncase DRIVING_TYPE_D:\r\nsupport_mask = DRIVING_TYPE_D_MASK;\r\nquery_switch = TYPE_D_QUERY_SWITCH_OK;\r\nswitch_busy = TYPE_D_SWITCH_BUSY;\r\nbreak;\r\ndefault:\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else if (func_group == SD_FUNC_GROUP_4) {\r\nsupport_offset = FUNCTION_GROUP4_SUPPORT_OFFSET;\r\nquery_switch_offset = FUNCTION_GROUP4_QUERY_SWITCH_OFFSET;\r\ncheck_busy_offset = FUNCTION_GROUP4_CHECK_BUSY_OFFSET;\r\nswitch (func_to_switch) {\r\ncase CURRENT_LIMIT_400:\r\nsupport_mask = CURRENT_LIMIT_400_MASK;\r\nquery_switch = CURRENT_LIMIT_400_QUERY_SWITCH_OK;\r\nswitch_busy = CURRENT_LIMIT_400_SWITCH_BUSY;\r\nbreak;\r\ncase CURRENT_LIMIT_600:\r\nsupport_mask = CURRENT_LIMIT_600_MASK;\r\nquery_switch = CURRENT_LIMIT_600_QUERY_SWITCH_OK;\r\nswitch_busy = CURRENT_LIMIT_600_SWITCH_BUSY;\r\nbreak;\r\ncase CURRENT_LIMIT_800:\r\nsupport_mask = CURRENT_LIMIT_800_MASK;\r\nquery_switch = CURRENT_LIMIT_800_QUERY_SWITCH_OK;\r\nswitch_busy = CURRENT_LIMIT_800_SWITCH_BUSY;\r\nbreak;\r\ndefault:\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (func_group == SD_FUNC_GROUP_1) {\r\nif (!(buf[support_offset] & support_mask) ||\r\n((buf[query_switch_offset] & 0x0F) != query_switch)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif ((buf[DATA_STRUCTURE_VER_OFFSET] == 0x01) &&\r\n((buf[check_busy_offset] & switch_busy) == switch_busy)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_check_switch_mode(struct rtsx_chip *chip, u8 mode, u8 func_group,\r\nu8 func_to_switch, u8 bus_width)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5], buf[64];\r\ndev_dbg(rtsx_dev(chip), "sd_check_switch_mode (mode = %d, func_group = %d, func_to_switch = %d)\n",\r\nmode, func_group, func_to_switch);\r\ncmd[0] = 0x40 | SWITCH;\r\ncmd[1] = mode;\r\nif (func_group == SD_FUNC_GROUP_1) {\r\ncmd[2] = 0xFF;\r\ncmd[3] = 0xFF;\r\ncmd[4] = 0xF0 + func_to_switch;\r\n} else if (func_group == SD_FUNC_GROUP_3) {\r\ncmd[2] = 0xFF;\r\ncmd[3] = 0xF0 + func_to_switch;\r\ncmd[4] = 0xFF;\r\n} else if (func_group == SD_FUNC_GROUP_4) {\r\ncmd[2] = 0xFF;\r\ncmd[3] = 0x0F + (func_to_switch << 4);\r\ncmd[4] = 0xFF;\r\n} else {\r\ncmd[1] = SD_CHECK_MODE;\r\ncmd[2] = 0xFF;\r\ncmd[3] = 0xFF;\r\ncmd[4] = 0xFF;\r\n}\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1, bus_width,\r\nbuf, 64, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "%*ph\n", 64, buf);\r\nif (func_group == NO_ARGUMENT) {\r\nsd_card->func_group1_mask = buf[0x0D];\r\nsd_card->func_group2_mask = buf[0x0B];\r\nsd_card->func_group3_mask = buf[0x09];\r\nsd_card->func_group4_mask = buf[0x07];\r\ndev_dbg(rtsx_dev(chip), "func_group1_mask = 0x%02x\n",\r\nbuf[0x0D]);\r\ndev_dbg(rtsx_dev(chip), "func_group2_mask = 0x%02x\n",\r\nbuf[0x0B]);\r\ndev_dbg(rtsx_dev(chip), "func_group3_mask = 0x%02x\n",\r\nbuf[0x09]);\r\ndev_dbg(rtsx_dev(chip), "func_group4_mask = 0x%02x\n",\r\nbuf[0x07]);\r\n} else {\r\nu16 cc = ((u16)buf[0] << 8) | buf[1];\r\ndev_dbg(rtsx_dev(chip), "Maximum current consumption: %dmA\n",\r\ncc);\r\nif ((cc == 0) || (cc > 800)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_query_switch_result(chip, func_group,\r\nfunc_to_switch, buf, 64);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif ((cc > 400) || (func_to_switch > CURRENT_LIMIT_400)) {\r\nretval = rtsx_write_register(chip, OCPPARA2,\r\nSD_OCP_THD_MASK,\r\nchip->sd_800mA_ocp_thd);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PWR_CTL,\r\nPMOS_STRG_MASK,\r\nPMOS_STRG_800mA);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic u8 downgrade_switch_mode(u8 func_group, u8 func_to_switch)\r\n{\r\nif (func_group == SD_FUNC_GROUP_1) {\r\nif (func_to_switch > HS_SUPPORT)\r\nfunc_to_switch--;\r\n} else if (func_group == SD_FUNC_GROUP_4) {\r\nif (func_to_switch > CURRENT_LIMIT_200)\r\nfunc_to_switch--;\r\n}\r\nreturn func_to_switch;\r\n}\r\nstatic int sd_check_switch(struct rtsx_chip *chip,\r\nu8 func_group, u8 func_to_switch, u8 bus_width)\r\n{\r\nint retval;\r\nint i;\r\nbool switch_good = false;\r\nfor (i = 0; i < 3; i++) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_check_switch_mode(chip, SD_CHECK_MODE, func_group,\r\nfunc_to_switch, bus_width);\r\nif (retval == STATUS_SUCCESS) {\r\nu8 stat;\r\nretval = sd_check_switch_mode(chip, SD_SWITCH_MODE,\r\nfunc_group,\r\nfunc_to_switch,\r\nbus_width);\r\nif (retval == STATUS_SUCCESS) {\r\nswitch_good = true;\r\nbreak;\r\n}\r\nretval = rtsx_read_register(chip, SD_STAT1, &stat);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (stat & SD_CRC16_ERR) {\r\ndev_dbg(rtsx_dev(chip), "SD CRC16 error when switching mode\n");\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nfunc_to_switch = downgrade_switch_mode(func_group,\r\nfunc_to_switch);\r\nwait_timeout(20);\r\n}\r\nif (!switch_good) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_switch_function(struct rtsx_chip *chip, u8 bus_width)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i;\r\nu8 func_to_switch = 0;\r\nretval = sd_check_switch_mode(chip, SD_CHECK_MODE, NO_ARGUMENT,\r\nNO_ARGUMENT, bus_width);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsd_card->func_group1_mask &= ~(sd_card->sd_switch_fail);\r\nfor (i = 0; i < 4; i++) {\r\nswitch ((u8)(chip->sd_speed_prior >> (i * 8))) {\r\ncase SDR104_SUPPORT:\r\nif ((sd_card->func_group1_mask & SDR104_SUPPORT_MASK) &&\r\nchip->sdr104_en) {\r\nfunc_to_switch = SDR104_SUPPORT;\r\n}\r\nbreak;\r\ncase DDR50_SUPPORT:\r\nif ((sd_card->func_group1_mask & DDR50_SUPPORT_MASK) &&\r\nchip->ddr50_en) {\r\nfunc_to_switch = DDR50_SUPPORT;\r\n}\r\nbreak;\r\ncase SDR50_SUPPORT:\r\nif ((sd_card->func_group1_mask & SDR50_SUPPORT_MASK) &&\r\nchip->sdr50_en) {\r\nfunc_to_switch = SDR50_SUPPORT;\r\n}\r\nbreak;\r\ncase HS_SUPPORT:\r\nif (sd_card->func_group1_mask & HS_SUPPORT_MASK)\r\nfunc_to_switch = HS_SUPPORT;\r\nbreak;\r\ndefault:\r\ncontinue;\r\n}\r\nif (func_to_switch)\r\nbreak;\r\n}\r\ndev_dbg(rtsx_dev(chip), "SD_FUNC_GROUP_1: func_to_switch = 0x%02x",\r\nfunc_to_switch);\r\n#ifdef SUPPORT_SD_LOCK\r\nif ((sd_card->sd_lock_status & SD_SDR_RST) &&\r\n(func_to_switch == DDR50_SUPPORT) &&\r\n(sd_card->func_group1_mask & SDR50_SUPPORT_MASK)) {\r\nfunc_to_switch = SDR50_SUPPORT;\r\ndev_dbg(rtsx_dev(chip), "Using SDR50 instead of DDR50 for SD Lock\n");\r\n}\r\n#endif\r\nif (func_to_switch) {\r\nretval = sd_check_switch(chip, SD_FUNC_GROUP_1, func_to_switch,\r\nbus_width);\r\nif (retval != STATUS_SUCCESS) {\r\nif (func_to_switch == SDR104_SUPPORT) {\r\nsd_card->sd_switch_fail = SDR104_SUPPORT_MASK;\r\n} else if (func_to_switch == DDR50_SUPPORT) {\r\nsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\r\nDDR50_SUPPORT_MASK;\r\n} else if (func_to_switch == SDR50_SUPPORT) {\r\nsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\r\nDDR50_SUPPORT_MASK | SDR50_SUPPORT_MASK;\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (func_to_switch == SDR104_SUPPORT)\r\nSET_SD_SDR104(sd_card);\r\nelse if (func_to_switch == DDR50_SUPPORT)\r\nSET_SD_DDR50(sd_card);\r\nelse if (func_to_switch == SDR50_SUPPORT)\r\nSET_SD_SDR50(sd_card);\r\nelse\r\nSET_SD_HS(sd_card);\r\n}\r\nif (CHK_SD_DDR50(sd_card)) {\r\nretval = rtsx_write_register(chip, SD_PUSH_POINT_CTL, 0x06,\r\n0x04);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = sd_set_sample_push_timing(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (!func_to_switch || (func_to_switch == HS_SUPPORT)) {\r\nreturn STATUS_SUCCESS;\r\n}\r\nfunc_to_switch = 0xFF;\r\nfor (i = 0; i < 4; i++) {\r\nswitch ((u8)(chip->sd_current_prior >> (i * 8))) {\r\ncase CURRENT_LIMIT_800:\r\nif (sd_card->func_group4_mask & CURRENT_LIMIT_800_MASK)\r\nfunc_to_switch = CURRENT_LIMIT_800;\r\nbreak;\r\ncase CURRENT_LIMIT_600:\r\nif (sd_card->func_group4_mask & CURRENT_LIMIT_600_MASK)\r\nfunc_to_switch = CURRENT_LIMIT_600;\r\nbreak;\r\ncase CURRENT_LIMIT_400:\r\nif (sd_card->func_group4_mask & CURRENT_LIMIT_400_MASK)\r\nfunc_to_switch = CURRENT_LIMIT_400;\r\nbreak;\r\ncase CURRENT_LIMIT_200:\r\nif (sd_card->func_group4_mask & CURRENT_LIMIT_200_MASK)\r\nfunc_to_switch = CURRENT_LIMIT_200;\r\nbreak;\r\ndefault:\r\ncontinue;\r\n}\r\nif (func_to_switch != 0xFF)\r\nbreak;\r\n}\r\ndev_dbg(rtsx_dev(chip), "SD_FUNC_GROUP_4: func_to_switch = 0x%02x",\r\nfunc_to_switch);\r\nif (func_to_switch <= CURRENT_LIMIT_800) {\r\nretval = sd_check_switch(chip, SD_FUNC_GROUP_4, func_to_switch,\r\nbus_width);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd_check_err_code(chip, SD_NO_CARD)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\ndev_dbg(rtsx_dev(chip), "Switch current limit finished! (%d)\n",\r\nretval);\r\n}\r\nif (CHK_SD_DDR50(sd_card)) {\r\nretval = rtsx_write_register(chip, SD_PUSH_POINT_CTL, 0x06, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_wait_data_idle(struct rtsx_chip *chip)\r\n{\r\nint retval = STATUS_TIMEDOUT;\r\nint i;\r\nu8 val = 0;\r\nfor (i = 0; i < 100; i++) {\r\nretval = rtsx_read_register(chip, SD_DATA_STATE, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (val & SD_DATA_IDLE) {\r\nretval = STATUS_SUCCESS;\r\nbreak;\r\n}\r\nudelay(100);\r\n}\r\ndev_dbg(rtsx_dev(chip), "SD_DATA_STATE: 0x%02x\n", val);\r\nreturn retval;\r\n}\r\nstatic int sd_sdr_tuning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\r\n{\r\nint retval;\r\nu8 cmd[5];\r\nretval = sd_change_phase(chip, sample_point, TUNE_RX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ncmd[0] = 0x40 | SEND_TUNING_PATTERN;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_read_data(chip, SD_TM_AUTO_TUNING, cmd, 5, 0x40, 1,\r\nSD_BUS_WIDTH_4, NULL, 0, 100);\r\nif (retval != STATUS_SUCCESS) {\r\n(void)sd_wait_data_idle(chip);\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_ddr_tuning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5];\r\nretval = sd_change_phase(chip, sample_point, TUNE_RX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "sd ddr tuning rx\n");\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ncmd[0] = 0x40 | SD_STATUS;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1,\r\nSD_BUS_WIDTH_4, NULL, 0, 100);\r\nif (retval != STATUS_SUCCESS) {\r\n(void)sd_wait_data_idle(chip);\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mmc_ddr_tunning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5], bus_width;\r\nif (CHK_MMC_8BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_8;\r\nelse if (CHK_MMC_4BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_4;\r\nelse\r\nbus_width = SD_BUS_WIDTH_1;\r\nretval = sd_change_phase(chip, sample_point, TUNE_RX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "mmc ddr tuning rx\n");\r\ncmd[0] = 0x40 | SEND_EXT_CSD;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 0x200, 1,\r\nbus_width, NULL, 0, 100);\r\nif (retval != STATUS_SUCCESS) {\r\n(void)sd_wait_data_idle(chip);\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_sdr_tuning_tx_cmd(struct rtsx_chip *chip, u8 sample_point)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nretval = sd_change_phase(chip, sample_point, TUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\nSD_RSP_80CLK_TIMEOUT_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd_check_err_code(chip, SD_RSP_TIMEOUT)) {\r\nrtsx_write_register(chip, SD_CFG3,\r\nSD_RSP_80CLK_TIMEOUT_EN, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\n0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_ddr_tuning_tx_cmd(struct rtsx_chip *chip, u8 sample_point)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5], bus_width;\r\nretval = sd_change_phase(chip, sample_point, TUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_SD(sd_card)) {\r\nbus_width = SD_BUS_WIDTH_4;\r\n} else {\r\nif (CHK_MMC_8BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_8;\r\nelse if (CHK_MMC_4BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_4;\r\nelse\r\nbus_width = SD_BUS_WIDTH_1;\r\n}\r\nretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\nSD_RSP_80CLK_TIMEOUT_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ncmd[0] = 0x40 | PROGRAM_CSD;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_write_data(chip, SD_TM_AUTO_WRITE_2, cmd, 5, 16, 1,\r\nbus_width, sd_card->raw_csd, 16, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\n0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic u8 sd_search_final_phase(struct rtsx_chip *chip, u32 phase_map,\r\nu8 tune_dir)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nstruct timing_phase_path path[MAX_PHASE + 1];\r\nint i, j, cont_path_cnt;\r\nbool new_block;\r\nint max_len, final_path_idx;\r\nu8 final_phase = 0xFF;\r\nif (phase_map == 0xFFFFFFFF) {\r\nif (tune_dir == TUNE_RX)\r\nfinal_phase = (u8)chip->sd_default_rx_phase;\r\nelse\r\nfinal_phase = (u8)chip->sd_default_tx_phase;\r\ngoto search_finish;\r\n}\r\ncont_path_cnt = 0;\r\nnew_block = true;\r\nj = 0;\r\nfor (i = 0; i < MAX_PHASE + 1; i++) {\r\nif (phase_map & (1 << i)) {\r\nif (new_block) {\r\nnew_block = false;\r\nj = cont_path_cnt++;\r\npath[j].start = i;\r\npath[j].end = i;\r\n} else {\r\npath[j].end = i;\r\n}\r\n} else {\r\nnew_block = true;\r\nif (cont_path_cnt) {\r\nint idx = cont_path_cnt - 1;\r\npath[idx].len = path[idx].end -\r\npath[idx].start + 1;\r\npath[idx].mid = path[idx].start +\r\npath[idx].len / 2;\r\n}\r\n}\r\n}\r\nif (cont_path_cnt == 0) {\r\ndev_dbg(rtsx_dev(chip), "No continuous phase path\n");\r\ngoto search_finish;\r\n} else {\r\nint idx = cont_path_cnt - 1;\r\npath[idx].len = path[idx].end - path[idx].start + 1;\r\npath[idx].mid = path[idx].start + path[idx].len / 2;\r\n}\r\nif ((path[0].start == 0) &&\r\n(path[cont_path_cnt - 1].end == MAX_PHASE)) {\r\npath[0].start = path[cont_path_cnt - 1].start - MAX_PHASE - 1;\r\npath[0].len += path[cont_path_cnt - 1].len;\r\npath[0].mid = path[0].start + path[0].len / 2;\r\nif (path[0].mid < 0)\r\npath[0].mid += MAX_PHASE + 1;\r\ncont_path_cnt--;\r\n}\r\nmax_len = 0;\r\nfinal_phase = 0;\r\nfinal_path_idx = 0;\r\nfor (i = 0; i < cont_path_cnt; i++) {\r\nif (path[i].len > max_len) {\r\nmax_len = path[i].len;\r\nfinal_phase = (u8)path[i].mid;\r\nfinal_path_idx = i;\r\n}\r\ndev_dbg(rtsx_dev(chip), "path[%d].start = %d\n",\r\ni, path[i].start);\r\ndev_dbg(rtsx_dev(chip), "path[%d].end = %d\n", i, path[i].end);\r\ndev_dbg(rtsx_dev(chip), "path[%d].len = %d\n", i, path[i].len);\r\ndev_dbg(rtsx_dev(chip), "path[%d].mid = %d\n", i, path[i].mid);\r\ndev_dbg(rtsx_dev(chip), "\n");\r\n}\r\nif (tune_dir == TUNE_TX) {\r\nif (CHK_SD_SDR104(sd_card)) {\r\nif (max_len > 15) {\r\nint temp_mid = (max_len - 16) / 2;\r\nint temp_final_phase =\r\npath[final_path_idx].end -\r\n(max_len - (6 + temp_mid));\r\nif (temp_final_phase < 0)\r\nfinal_phase = (u8)(temp_final_phase +\r\nMAX_PHASE + 1);\r\nelse\r\nfinal_phase = (u8)temp_final_phase;\r\n}\r\n} else if (CHK_SD_SDR50(sd_card)) {\r\nif (max_len > 12) {\r\nint temp_mid = (max_len - 13) / 2;\r\nint temp_final_phase =\r\npath[final_path_idx].end -\r\n(max_len - (3 + temp_mid));\r\nif (temp_final_phase < 0)\r\nfinal_phase = (u8)(temp_final_phase +\r\nMAX_PHASE + 1);\r\nelse\r\nfinal_phase = (u8)temp_final_phase;\r\n}\r\n}\r\n}\r\nsearch_finish:\r\ndev_dbg(rtsx_dev(chip), "Final chosen phase: %d\n", final_phase);\r\nreturn final_phase;\r\n}\r\nstatic int sd_tuning_rx(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i, j;\r\nu32 raw_phase_map[3], phase_map;\r\nu8 final_phase;\r\nint (*tuning_cmd)(struct rtsx_chip *chip, u8 sample_point);\r\nif (CHK_SD(sd_card)) {\r\nif (CHK_SD_DDR50(sd_card))\r\ntuning_cmd = sd_ddr_tuning_rx_cmd;\r\nelse\r\ntuning_cmd = sd_sdr_tuning_rx_cmd;\r\n} else {\r\nif (CHK_MMC_DDR52(sd_card)) {\r\ntuning_cmd = mmc_ddr_tunning_rx_cmd;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nfor (i = 0; i < 3; i++) {\r\nraw_phase_map[i] = 0;\r\nfor (j = MAX_PHASE; j >= 0; j--) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = tuning_cmd(chip, (u8)j);\r\nif (retval == STATUS_SUCCESS)\r\nraw_phase_map[i] |= 1 << j;\r\n}\r\n}\r\nphase_map = raw_phase_map[0] & raw_phase_map[1] & raw_phase_map[2];\r\nfor (i = 0; i < 3; i++)\r\ndev_dbg(rtsx_dev(chip), "RX raw_phase_map[%d] = 0x%08x\n",\r\ni, raw_phase_map[i]);\r\ndev_dbg(rtsx_dev(chip), "RX phase_map = 0x%08x\n", phase_map);\r\nfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_RX);\r\nif (final_phase == 0xFF) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_change_phase(chip, final_phase, TUNE_RX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_ddr_pre_tuning_tx(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i;\r\nu32 phase_map;\r\nu8 final_phase;\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\nSD_RSP_80CLK_TIMEOUT_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nphase_map = 0;\r\nfor (i = MAX_PHASE; i >= 0; i--) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_write_register(chip, SD_CFG3,\r\nSD_RSP_80CLK_TIMEOUT_EN, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_change_phase(chip, (u8)i, TUNE_TX);\r\nif (retval != STATUS_SUCCESS)\r\ncontinue;\r\nretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif ((retval == STATUS_SUCCESS) ||\r\n!sd_check_err_code(chip, SD_RSP_TIMEOUT))\r\nphase_map |= 1 << i;\r\n}\r\nretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\r\n0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ndev_dbg(rtsx_dev(chip), "DDR TX pre tune phase_map = 0x%08x\n",\r\nphase_map);\r\nfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_TX);\r\nif (final_phase == 0xFF) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_change_phase(chip, final_phase, TUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "DDR TX pre tune phase: %d\n",\r\n(int)final_phase);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_tuning_tx(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint i, j;\r\nu32 raw_phase_map[3], phase_map;\r\nu8 final_phase;\r\nint (*tuning_cmd)(struct rtsx_chip *chip, u8 sample_point);\r\nif (CHK_SD(sd_card)) {\r\nif (CHK_SD_DDR50(sd_card))\r\ntuning_cmd = sd_ddr_tuning_tx_cmd;\r\nelse\r\ntuning_cmd = sd_sdr_tuning_tx_cmd;\r\n} else {\r\nif (CHK_MMC_DDR52(sd_card)) {\r\ntuning_cmd = sd_ddr_tuning_tx_cmd;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nfor (i = 0; i < 3; i++) {\r\nraw_phase_map[i] = 0;\r\nfor (j = MAX_PHASE; j >= 0; j--) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_write_register(chip, SD_CFG3,\r\nSD_RSP_80CLK_TIMEOUT_EN, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = tuning_cmd(chip, (u8)j);\r\nif (retval == STATUS_SUCCESS)\r\nraw_phase_map[i] |= 1 << j;\r\n}\r\n}\r\nphase_map = raw_phase_map[0] & raw_phase_map[1] & raw_phase_map[2];\r\nfor (i = 0; i < 3; i++)\r\ndev_dbg(rtsx_dev(chip), "TX raw_phase_map[%d] = 0x%08x\n",\r\ni, raw_phase_map[i]);\r\ndev_dbg(rtsx_dev(chip), "TX phase_map = 0x%08x\n", phase_map);\r\nfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_TX);\r\nif (final_phase == 0xFF) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_change_phase(chip, final_phase, TUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_sdr_tuning(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nretval = sd_tuning_tx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_tuning_rx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_ddr_tuning(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nif (!(chip->sd_ctl & SD_DDR_TX_PHASE_SET_BY_USER)) {\r\nretval = sd_ddr_pre_tuning_tx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = sd_change_phase(chip, (u8)chip->sd_ddr_tx_phase,\r\nTUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = sd_tuning_rx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(chip->sd_ctl & SD_DDR_TX_PHASE_SET_BY_USER)) {\r\nretval = sd_tuning_tx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mmc_ddr_tuning(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nif (!(chip->sd_ctl & MMC_DDR_TX_PHASE_SET_BY_USER)) {\r\nretval = sd_ddr_pre_tuning_tx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = sd_change_phase(chip, (u8)chip->mmc_ddr_tx_phase,\r\nTUNE_TX);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = sd_tuning_rx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(chip->sd_ctl & MMC_DDR_TX_PHASE_SET_BY_USER)) {\r\nretval = sd_tuning_tx(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_switch_clock(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nint re_tuning = 0;\r\nretval = select_card(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = switch_clock(chip, sd_card->sd_clock);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (re_tuning) {\r\nif (CHK_SD(sd_card)) {\r\nif (CHK_SD_DDR50(sd_card))\r\nretval = sd_ddr_tuning(chip);\r\nelse\r\nretval = sd_sdr_tuning(chip);\r\n} else {\r\nif (CHK_MMC_DDR52(sd_card))\r\nretval = mmc_ddr_tuning(chip);\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_prepare_reset(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nif (chip->asic_code)\r\nsd_card->sd_clock = 29;\r\nelse\r\nsd_card->sd_clock = CLK_30;\r\nsd_card->sd_type = 0;\r\nsd_card->seq_mode = 0;\r\nsd_card->sd_data_buf_ready = 0;\r\nsd_card->capacity = 0;\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status = 0;\r\nsd_card->sd_erase_status = 0;\r\n#endif\r\nchip->capacity[chip->card2lun[SD_CARD]] = 0;\r\nchip->sd_io = 0;\r\nretval = sd_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0xFF, 0x40);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_STOP, SD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = select_card(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_pull_ctl_disable(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nif (CHECK_PID(chip, 0x5208)) {\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL1, 0xFF,\r\nXD_D3_PD | SD_D7_PD | SD_CLK_PD |\r\nSD_D5_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL2, 0xFF,\r\nSD_D6_PD | SD_D0_PD | SD_D1_PD |\r\nXD_D5_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL3, 0xFF,\r\nSD_D4_PD | XD_CE_PD | XD_CLE_PD |\r\nXD_CD_PU);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL4, 0xFF,\r\nXD_RDY_PD | SD_D3_PD | SD_D2_PD |\r\nXD_ALE_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL5, 0xFF,\r\nMS_INS_PU | SD_WP_PD | SD_CD_PU |\r\nSD_CMD_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL6, 0xFF,\r\nMS_D5_PD | MS_D4_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else if (CHECK_PID(chip, 0x5288)) {\r\nif (CHECK_BARO_PKG(chip, QFN)) {\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL1,\r\n0xFF, 0x55);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL2,\r\n0xFF, 0x55);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL3,\r\n0xFF, 0x4B);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL4,\r\n0xFF, 0x69);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_pull_ctl_enable(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nrtsx_init_cmd(chip);\r\nif (CHECK_PID(chip, 0x5208)) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL1, 0xFF,\r\nXD_D3_PD | SD_DAT7_PU | SD_CLK_NP | SD_D5_PU);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL2, 0xFF,\r\nSD_D6_PU | SD_D0_PU | SD_D1_PU | XD_D5_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL3, 0xFF,\r\nSD_D4_PU | XD_CE_PD | XD_CLE_PD | XD_CD_PU);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL4, 0xFF,\r\nXD_RDY_PD | SD_D3_PU | SD_D2_PU | XD_ALE_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL5, 0xFF,\r\nMS_INS_PU | SD_WP_PU | SD_CD_PU | SD_CMD_PU);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL6, 0xFF,\r\nMS_D5_PD | MS_D4_PD);\r\n} else if (CHECK_PID(chip, 0x5288)) {\r\nif (CHECK_BARO_PKG(chip, QFN)) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL1, 0xFF,\r\n0xA8);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL2, 0xFF,\r\n0x5A);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL3, 0xFF,\r\n0x95);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL4, 0xFF,\r\n0xAA);\r\n}\r\n}\r\nretval = rtsx_send_cmd(chip, SD_CARD, 100);\r\nif (retval < 0) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_init_power(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nretval = sd_power_off_card3v3(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!chip->ft2_fast_mode)\r\nwait_timeout(250);\r\nretval = enable_card_clock(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->asic_code) {\r\nretval = sd_pull_ctl_enable(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, FPGA_PULL_CTL,\r\nFPGA_SD_PULL_CTL_BIT | 0x20, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nif (!chip->ft2_fast_mode) {\r\nretval = card_power_on(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nwait_timeout(260);\r\n#ifdef SUPPORT_OCP\r\nif (chip->ocp_stat & (SD_OC_NOW | SD_OC_EVER)) {\r\ndev_dbg(rtsx_dev(chip), "Over current, OCPSTAT is 0x%x\n",\r\nchip->ocp_stat);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\n}\r\nretval = rtsx_write_register(chip, CARD_OE, SD_OUTPUT_EN,\r\nSD_OUTPUT_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_dummy_clock(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nretval = rtsx_write_register(chip, REG_SD_CFG3, 0x01, 0x01);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nwait_timeout(5);\r\nretval = rtsx_write_register(chip, REG_SD_CFG3, 0x01, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_read_lba0(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 cmd[5], bus_width;\r\ncmd[0] = 0x40 | READ_SINGLE_BLOCK;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nif (CHK_SD(sd_card)) {\r\nbus_width = SD_BUS_WIDTH_4;\r\n} else {\r\nif (CHK_MMC_8BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_8;\r\nelse if (CHK_MMC_4BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_4;\r\nelse\r\nbus_width = SD_BUS_WIDTH_1;\r\n}\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 512, 1,\r\nbus_width, NULL, 0, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int sd_check_wp_state(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu32 val;\r\nu16 sd_card_type;\r\nu8 cmd[5], buf[64];\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ncmd[0] = 0x40 | SD_STATUS;\r\ncmd[1] = 0;\r\ncmd[2] = 0;\r\ncmd[3] = 0;\r\ncmd[4] = 0;\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1,\r\nSD_BUS_WIDTH_4, buf, 64, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "ACMD13:\n");\r\ndev_dbg(rtsx_dev(chip), "%*ph\n", 64, buf);\r\nsd_card_type = ((u16)buf[2] << 8) | buf[3];\r\ndev_dbg(rtsx_dev(chip), "sd_card_type = 0x%04x\n", sd_card_type);\r\nif ((sd_card_type == 0x0001) || (sd_card_type == 0x0002)) {\r\nchip->card_wp |= SD_CARD;\r\n}\r\nval = rtsx_readl(chip, RTSX_BIPR);\r\nif (val & SD_WRITE_PROTECT)\r\nchip->card_wp |= SD_CARD;\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int reset_sd(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nbool hi_cap_flow = false;\r\nint retval, i = 0, j = 0, k = 0;\r\nbool sd_dont_switch = false;\r\nbool support_1v8 = false;\r\nbool try_sdio = true;\r\nu8 rsp[16];\r\nu8 switch_bus_width;\r\nu32 voltage = 0;\r\nbool sd20_mode = false;\r\nSET_SD(sd_card);\r\nswitch_fail:\r\ni = 0;\r\nj = 0;\r\nk = 0;\r\nhi_cap_flow = false;\r\n#ifdef SUPPORT_SD_LOCK\r\nif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON)\r\ngoto SD_UNLOCK_ENTRY;\r\n#endif\r\nretval = sd_prepare_reset(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_dummy_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nif (CHK_SDIO_EXIST(chip) && !CHK_SDIO_IGNORED(chip) && try_sdio) {\r\nint rty_cnt = 0;\r\nfor (; rty_cnt < chip->sdio_retry_cnt; rty_cnt++) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\ngoto status_fail;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, IO_SEND_OP_COND, 0,\r\nSD_RSP_TYPE_R4, rsp, 5);\r\nif (retval == STATUS_SUCCESS) {\r\nint func_num = (rsp[1] >> 4) & 0x07;\r\nif (func_num) {\r\ndev_dbg(rtsx_dev(chip), "SD_IO card (Function number: %d)!\n",\r\nfunc_num);\r\nchip->sd_io = 1;\r\ngoto status_fail;\r\n}\r\nbreak;\r\n}\r\nsd_init_power(chip);\r\nsd_dummy_clock(chip);\r\n}\r\ndev_dbg(rtsx_dev(chip), "Normal card!\n");\r\n}\r\nRTY_SD_RST:\r\nretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0, SD_RSP_TYPE_R0,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nwait_timeout(20);\r\nretval = sd_send_cmd_get_rsp(chip, SEND_IF_COND, 0x000001AA,\r\nSD_RSP_TYPE_R7, rsp, 5);\r\nif (retval == STATUS_SUCCESS) {\r\nif ((rsp[4] == 0xAA) && ((rsp[3] & 0x0f) == 0x01)) {\r\nhi_cap_flow = true;\r\nvoltage = SUPPORT_VOLTAGE | 0x40000000;\r\n}\r\n}\r\nif (!hi_cap_flow) {\r\nvoltage = SUPPORT_VOLTAGE;\r\nretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0,\r\nSD_RSP_TYPE_R0, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nwait_timeout(20);\r\n}\r\ndo {\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, 0, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\ngoto status_fail;\r\n}\r\nj++;\r\nif (j < 3)\r\ngoto RTY_SD_RST;\r\nelse\r\ngoto status_fail;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SD_APP_OP_COND, voltage,\r\nSD_RSP_TYPE_R3, rsp, 5);\r\nif (retval != STATUS_SUCCESS) {\r\nk++;\r\nif (k < 3)\r\ngoto RTY_SD_RST;\r\nelse\r\ngoto status_fail;\r\n}\r\ni++;\r\nwait_timeout(20);\r\n} while (!(rsp[1] & 0x80) && (i < 255));\r\nif (i == 255)\r\ngoto status_fail;\r\nif (hi_cap_flow) {\r\nif (rsp[1] & 0x40)\r\nSET_SD_HCXC(sd_card);\r\nelse\r\nCLR_SD_HCXC(sd_card);\r\nsupport_1v8 = false;\r\n} else {\r\nCLR_SD_HCXC(sd_card);\r\nsupport_1v8 = false;\r\n}\r\ndev_dbg(rtsx_dev(chip), "support_1v8 = %d\n", support_1v8);\r\nif (support_1v8) {\r\nretval = sd_voltage_switch(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, ALL_SEND_CID, 0, SD_RSP_TYPE_R2,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nfor (i = 0; i < 3; i++) {\r\nretval = sd_send_cmd_get_rsp(chip, SEND_RELATIVE_ADDR, 0,\r\nSD_RSP_TYPE_R6, rsp, 5);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nsd_card->sd_addr = (u32)rsp[1] << 24;\r\nsd_card->sd_addr += (u32)rsp[2] << 16;\r\nif (sd_card->sd_addr)\r\nbreak;\r\n}\r\nretval = sd_check_csd(chip, 1);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\n#ifdef SUPPORT_SD_LOCK\r\nSD_UNLOCK_ENTRY:\r\nretval = sd_update_lock_status(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nif (sd_card->sd_lock_status & SD_LOCKED) {\r\nsd_card->sd_lock_status |= (SD_LOCK_1BIT_MODE | SD_PWD_EXIST);\r\nreturn STATUS_SUCCESS;\r\n} else if (!(sd_card->sd_lock_status & SD_UNLOCK_POW_ON)) {\r\nsd_card->sd_lock_status &= ~SD_PWD_EXIST;\r\n}\r\n#endif\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_send_cmd_get_rsp(chip, SET_CLR_CARD_DETECT, 0,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nif (support_1v8) {\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_send_cmd_get_rsp(chip, SET_BUS_WIDTH, 2,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nswitch_bus_width = SD_BUS_WIDTH_4;\r\n} else {\r\nswitch_bus_width = SD_BUS_WIDTH_1;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nif (!(sd_card->raw_csd[4] & 0x40))\r\nsd_dont_switch = true;\r\nif (!sd_dont_switch) {\r\nif (sd20_mode) {\r\nsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\r\nDDR50_SUPPORT_MASK | SDR50_SUPPORT_MASK;\r\n}\r\nretval = sd_check_spec(chip, switch_bus_width);\r\nif (retval == STATUS_SUCCESS) {\r\nretval = sd_switch_function(chip, switch_bus_width);\r\nif (retval != STATUS_SUCCESS) {\r\nsd_init_power(chip);\r\nsd_dont_switch = true;\r\ntry_sdio = false;\r\ngoto switch_fail;\r\n}\r\n} else {\r\nif (support_1v8) {\r\nsd_init_power(chip);\r\nsd_dont_switch = true;\r\ntry_sdio = false;\r\ngoto switch_fail;\r\n}\r\n}\r\n}\r\nif (!support_1v8) {\r\nretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nretval = sd_send_cmd_get_rsp(chip, SET_BUS_WIDTH, 2,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\r\n#endif\r\nif (!sd20_mode && CHK_SD30_SPEED(sd_card)) {\r\nint read_lba0 = 1;\r\nretval = rtsx_write_register(chip, SD30_DRIVE_SEL, 0x07,\r\nchip->sd30_drive_sel_1v8);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = sd_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nif (CHK_SD_DDR50(sd_card))\r\nretval = sd_ddr_tuning(chip);\r\nelse\r\nretval = sd_sdr_tuning(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd20_mode) {\r\ngoto status_fail;\r\n} else {\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\ntry_sdio = false;\r\nsd20_mode = true;\r\ngoto switch_fail;\r\n}\r\n}\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nif (CHK_SD_DDR50(sd_card)) {\r\nretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\r\nif (retval != STATUS_SUCCESS)\r\nread_lba0 = 0;\r\n}\r\nif (read_lba0) {\r\nretval = sd_read_lba0(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd20_mode) {\r\ngoto status_fail;\r\n} else {\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\ntry_sdio = false;\r\nsd20_mode = true;\r\ngoto switch_fail;\r\n}\r\n}\r\n}\r\n}\r\nretval = sd_check_wp_state(chip);\r\nif (retval != STATUS_SUCCESS)\r\ngoto status_fail;\r\nchip->card_bus_width[chip->card2lun[SD_CARD]] = 4;\r\n#ifdef SUPPORT_SD_LOCK\r\nif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON) {\r\nretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_H, 0xFF,\r\n0x02);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_L, 0xFF,\r\n0x00);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n#endif\r\nreturn STATUS_SUCCESS;\r\nstatus_fail:\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int mmc_test_switch_bus(struct rtsx_chip *chip, u8 width)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 buf[8] = {0}, bus_width, *ptr;\r\nu16 byte_cnt;\r\nint len;\r\nretval = sd_send_cmd_get_rsp(chip, BUSTEST_W, 0, SD_RSP_TYPE_R1, NULL,\r\n0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn SWITCH_FAIL;\r\n}\r\nif (width == MMC_8BIT_BUS) {\r\nbuf[0] = 0x55;\r\nbuf[1] = 0xAA;\r\nlen = 8;\r\nbyte_cnt = 8;\r\nbus_width = SD_BUS_WIDTH_8;\r\n} else {\r\nbuf[0] = 0x5A;\r\nlen = 4;\r\nbyte_cnt = 4;\r\nbus_width = SD_BUS_WIDTH_4;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_CFG3, 0x02, 0x02);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn SWITCH_ERR;\r\n}\r\nretval = sd_write_data(chip, SD_TM_AUTO_WRITE_3, NULL, 0, byte_cnt, 1,\r\nbus_width, buf, len, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_write_register(chip, REG_SD_CFG3, 0x02, 0);\r\nrtsx_trace(chip);\r\nreturn SWITCH_ERR;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_CFG3, 0x02, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn SWITCH_ERR;\r\n}\r\ndev_dbg(rtsx_dev(chip), "SD/MMC CMD %d\n", BUSTEST_R);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF, 0x40 | BUSTEST_R);\r\nif (width == MMC_8BIT_BUS)\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L,\r\n0xFF, 0x08);\r\nelse\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L,\r\n0xFF, 0x04);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF, 1);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, SD_CALCULATE_CRC7 |\r\nSD_NO_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\r\nSD_CHECK_CRC7 | SD_RSP_LEN_6);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\r\nPINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_NORMAL_READ | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\r\nSD_TRANSFER_END);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2, 0, 0);\r\nif (width == MMC_8BIT_BUS)\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 1, 0, 0);\r\nretval = rtsx_send_cmd(chip, SD_CARD, 100);\r\nif (retval < 0) {\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\nreturn SWITCH_ERR;\r\n}\r\nptr = rtsx_get_cmd_data(chip) + 1;\r\nif (width == MMC_8BIT_BUS) {\r\ndev_dbg(rtsx_dev(chip), "BUSTEST_R [8bits]: 0x%02x 0x%02x\n",\r\nptr[0], ptr[1]);\r\nif ((ptr[0] == 0xAA) && (ptr[1] == 0x55)) {\r\nu8 rsp[5];\r\nu32 arg;\r\nif (CHK_MMC_DDR52(sd_card))\r\narg = 0x03B70600;\r\nelse\r\narg = 0x03B70200;\r\nretval = sd_send_cmd_get_rsp(chip, SWITCH, arg,\r\nSD_RSP_TYPE_R1b, rsp, 5);\r\nif ((retval == STATUS_SUCCESS) &&\r\n!(rsp[4] & MMC_SWITCH_ERR))\r\nreturn SWITCH_SUCCESS;\r\n}\r\n} else {\r\ndev_dbg(rtsx_dev(chip), "BUSTEST_R [4bits]: 0x%02x\n", ptr[0]);\r\nif (ptr[0] == 0xA5) {\r\nu8 rsp[5];\r\nu32 arg;\r\nif (CHK_MMC_DDR52(sd_card))\r\narg = 0x03B70500;\r\nelse\r\narg = 0x03B70100;\r\nretval = sd_send_cmd_get_rsp(chip, SWITCH, arg,\r\nSD_RSP_TYPE_R1b, rsp, 5);\r\nif ((retval == STATUS_SUCCESS) &&\r\n!(rsp[4] & MMC_SWITCH_ERR))\r\nreturn SWITCH_SUCCESS;\r\n}\r\n}\r\nrtsx_trace(chip);\r\nreturn SWITCH_FAIL;\r\n}\r\nstatic int mmc_switch_timing_bus(struct rtsx_chip *chip, bool switch_ddr)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nu8 *ptr, card_type, card_type_mask = 0;\r\nCLR_MMC_HS(sd_card);\r\ndev_dbg(rtsx_dev(chip), "SD/MMC CMD %d\n", SEND_EXT_CSD);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\r\n0x40 | SEND_EXT_CSD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF, 2);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF, 1);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\r\nSD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\r\nSD_CHECK_CRC7 | SD_RSP_LEN_6);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\r\nPINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_NORMAL_READ | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\r\nSD_TRANSFER_END);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 196, 0xFF, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 212, 0xFF, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 213, 0xFF, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 214, 0xFF, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 215, 0xFF, 0);\r\nretval = rtsx_send_cmd(chip, SD_CARD, 1000);\r\nif (retval < 0) {\r\nif (retval == -ETIMEDOUT) {\r\nrtsx_clear_sd_error(chip);\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nptr = rtsx_get_cmd_data(chip);\r\nif (ptr[0] & SD_TRANSFER_ERR) {\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MMC_SECTOR_MODE(sd_card)) {\r\nsd_card->capacity = ((u32)ptr[5] << 24) | ((u32)ptr[4] << 16) |\r\n((u32)ptr[3] << 8) | ((u32)ptr[2]);\r\n}\r\ncard_type_mask = 0x03;\r\ncard_type = ptr[1] & card_type_mask;\r\nif (card_type) {\r\nu8 rsp[5];\r\nif (card_type & 0x04) {\r\nif (switch_ddr)\r\nSET_MMC_DDR52(sd_card);\r\nelse\r\nSET_MMC_52M(sd_card);\r\n} else if (card_type & 0x02) {\r\nSET_MMC_52M(sd_card);\r\n} else {\r\nSET_MMC_26M(sd_card);\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SWITCH, 0x03B90100,\r\nSD_RSP_TYPE_R1b, rsp, 5);\r\nif ((retval != STATUS_SUCCESS) || (rsp[4] & MMC_SWITCH_ERR))\r\nCLR_MMC_HS(sd_card);\r\n}\r\nsd_choose_proper_clock(chip);\r\nretval = switch_clock(chip, sd_card->sd_clock);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mmc_test_switch_bus(chip, MMC_8BIT_BUS);\r\nif (retval == SWITCH_SUCCESS) {\r\nSET_MMC_8BIT(sd_card);\r\nchip->card_bus_width[chip->card2lun[SD_CARD]] = 8;\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\r\n#endif\r\n} else if (retval == SWITCH_FAIL) {\r\nretval = mmc_test_switch_bus(chip, MMC_4BIT_BUS);\r\nif (retval == SWITCH_SUCCESS) {\r\nSET_MMC_4BIT(sd_card);\r\nchip->card_bus_width[chip->card2lun[SD_CARD]] = 4;\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\r\n#endif\r\n} else if (retval == SWITCH_FAIL) {\r\nCLR_MMC_8BIT(sd_card);\r\nCLR_MMC_4BIT(sd_card);\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int reset_mmc(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval, i = 0, j = 0, k = 0;\r\nbool switch_ddr = true;\r\nu8 rsp[16];\r\nu8 spec_ver = 0;\r\nu32 temp;\r\n#ifdef SUPPORT_SD_LOCK\r\nif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON)\r\ngoto MMC_UNLOCK_ENTRY;\r\n#endif\r\nswitch_fail:\r\nretval = sd_prepare_reset(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nSET_MMC(sd_card);\r\nRTY_MMC_RST:\r\nretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0, SD_RSP_TYPE_R0,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndo {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SEND_OP_COND,\r\n(SUPPORT_VOLTAGE | 0x40000000),\r\nSD_RSP_TYPE_R3, rsp, 5);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd_check_err_code(chip, SD_BUSY) ||\r\nsd_check_err_code(chip, SD_TO_ERR)) {\r\nk++;\r\nif (k < 20) {\r\nsd_clr_err_code(chip);\r\ngoto RTY_MMC_RST;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nj++;\r\nif (j < 100) {\r\nsd_clr_err_code(chip);\r\ngoto RTY_MMC_RST;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\nwait_timeout(20);\r\ni++;\r\n} while (!(rsp[1] & 0x80) && (i < 255));\r\nif (i == 255) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif ((rsp[1] & 0x60) == 0x40)\r\nSET_MMC_SECTOR_MODE(sd_card);\r\nelse\r\nCLR_MMC_SECTOR_MODE(sd_card);\r\nretval = sd_send_cmd_get_rsp(chip, ALL_SEND_CID, 0, SD_RSP_TYPE_R2,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsd_card->sd_addr = 0x00100000;\r\nretval = sd_send_cmd_get_rsp(chip, SET_RELATIVE_ADDR, sd_card->sd_addr,\r\nSD_RSP_TYPE_R6, rsp, 5);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_check_csd(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nspec_ver = (sd_card->raw_csd[0] & 0x3C) >> 2;\r\nretval = sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nMMC_UNLOCK_ENTRY:\r\nretval = sd_update_lock_status(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nchip->card_bus_width[chip->card2lun[SD_CARD]] = 1;\r\nif (!sd_card->mmc_dont_switch_bus) {\r\nif (spec_ver == 4) {\r\nretval = mmc_switch_timing_bus(chip, switch_ddr);\r\nif (retval != STATUS_SUCCESS) {\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsd_card->mmc_dont_switch_bus = 1;\r\nrtsx_trace(chip);\r\ngoto switch_fail;\r\n}\r\n}\r\nif (CHK_MMC_SECTOR_MODE(sd_card) && (sd_card->capacity == 0)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (switch_ddr && CHK_MMC_DDR52(sd_card)) {\r\nretval = sd_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mmc_ddr_tuning(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nswitch_ddr = false;\r\nrtsx_trace(chip);\r\ngoto switch_fail;\r\n}\r\nretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\r\nif (retval == STATUS_SUCCESS) {\r\nretval = sd_read_lba0(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nswitch_ddr = false;\r\nrtsx_trace(chip);\r\ngoto switch_fail;\r\n}\r\n}\r\n}\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON) {\r\nretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_H, 0xFF,\r\n0x02);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_L, 0xFF,\r\n0x00);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n#endif\r\ntemp = rtsx_readl(chip, RTSX_BIPR);\r\nif (temp & SD_WRITE_PROTECT)\r\nchip->card_wp |= SD_CARD;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint reset_sd_card(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nsd_init_reg_addr(chip);\r\nmemset(sd_card, 0, sizeof(struct sd_info));\r\nchip->capacity[chip->card2lun[SD_CARD]] = 0;\r\nretval = enable_card_clock(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->ignore_sd && CHK_SDIO_EXIST(chip) &&\r\n!CHK_SDIO_IGNORED(chip)) {\r\nif (chip->asic_code) {\r\nretval = sd_pull_ctl_enable(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, FPGA_PULL_CTL,\r\nFPGA_SD_PULL_CTL_BIT |\r\n0x20, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = card_share_mode(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nchip->sd_io = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->sd_ctl & RESET_MMC_FIRST) {\r\nretval = reset_mmc(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd_check_err_code(chip, SD_NO_CARD)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = reset_sd(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n} else {\r\nretval = reset_sd(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (sd_check_err_code(chip, SD_NO_CARD)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->sd_io) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = reset_mmc(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\nretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_L, 0xFF, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_H, 0xFF, 2);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity;\r\nretval = sd_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "sd_card->sd_type = 0x%x\n", sd_card->sd_type);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int reset_mmc_only(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nsd_card->sd_type = 0;\r\nsd_card->seq_mode = 0;\r\nsd_card->sd_data_buf_ready = 0;\r\nsd_card->capacity = 0;\r\nsd_card->sd_switch_fail = 0;\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status = 0;\r\nsd_card->sd_erase_status = 0;\r\n#endif\r\nchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity = 0;\r\nretval = enable_card_clock(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_init_power(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = reset_mmc(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_L, 0xFF, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_H, 0xFF, 2);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity;\r\nretval = sd_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndev_dbg(rtsx_dev(chip), "In reset_mmc_only, sd_card->sd_type = 0x%x\n",\r\nsd_card->sd_type);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int wait_data_buf_ready(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint i, retval;\r\nfor (i = 0; i < WAIT_DATA_READY_RTY_CNT; i++) {\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsd_card->sd_data_buf_ready = 0;\r\nretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (sd_card->sd_data_buf_ready) {\r\nreturn sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr, SD_RSP_TYPE_R1, NULL, 0);\r\n}\r\n}\r\nsd_set_err_code(chip, SD_TO_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nvoid sd_stop_seq_mode(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nif (sd_card->seq_mode) {\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nreturn;\r\nretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\r\nSD_RSP_TYPE_R1b, NULL, 0);\r\nif (retval != STATUS_SUCCESS)\r\nsd_set_err_code(chip, SD_STS_ERR);\r\nretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\r\nif (retval != STATUS_SUCCESS)\r\nsd_set_err_code(chip, SD_STS_ERR);\r\nsd_card->seq_mode = 0;\r\nrtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\n}\r\n}\r\nstatic inline int sd_auto_tune_clock(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nif (chip->asic_code) {\r\nif (sd_card->sd_clock > 30)\r\nsd_card->sd_clock -= 20;\r\n} else {\r\nswitch (sd_card->sd_clock) {\r\ncase CLK_200:\r\nsd_card->sd_clock = CLK_150;\r\nbreak;\r\ncase CLK_150:\r\nsd_card->sd_clock = CLK_120;\r\nbreak;\r\ncase CLK_120:\r\nsd_card->sd_clock = CLK_100;\r\nbreak;\r\ncase CLK_100:\r\nsd_card->sd_clock = CLK_80;\r\nbreak;\r\ncase CLK_80:\r\nsd_card->sd_clock = CLK_60;\r\nbreak;\r\ncase CLK_60:\r\nsd_card->sd_clock = CLK_50;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_rw(struct scsi_cmnd *srb, struct rtsx_chip *chip, u32 start_sector,\r\nu16 sector_cnt)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nu32 data_addr;\r\nu8 cfg2;\r\nint retval;\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\ndev_dbg(rtsx_dev(chip), "sd_rw: Read %d %s from 0x%x\n",\r\nsector_cnt, (sector_cnt > 1) ? "sectors" : "sector",\r\nstart_sector);\r\n} else {\r\ndev_dbg(rtsx_dev(chip), "sd_rw: Write %d %s to 0x%x\n",\r\nsector_cnt, (sector_cnt > 1) ? "sectors" : "sector",\r\nstart_sector);\r\n}\r\nsd_card->cleanup_counter = 0;\r\nif (!(chip->card_ready & SD_CARD)) {\r\nsd_card->seq_mode = 0;\r\nretval = reset_sd_card(chip);\r\nif (retval == STATUS_SUCCESS) {\r\nchip->card_ready |= SD_CARD;\r\nchip->card_fail &= ~SD_CARD;\r\n} else {\r\nchip->card_ready &= ~SD_CARD;\r\nchip->card_fail |= SD_CARD;\r\nchip->capacity[chip->card2lun[SD_CARD]] = 0;\r\nchip->rw_need_retry = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (!CHK_SD_HCXC(sd_card) && !CHK_MMC_SECTOR_MODE(sd_card))\r\ndata_addr = start_sector << 9;\r\nelse\r\ndata_addr = start_sector;\r\nsd_clr_err_code(chip);\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_IO_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nif (sd_card->seq_mode &&\r\n((sd_card->pre_dir != srb->sc_data_direction) ||\r\n((sd_card->pre_sec_addr + sd_card->pre_sec_cnt) !=\r\nstart_sector))) {\r\nif ((sd_card->pre_sec_cnt < 0x80) &&\r\n(sd_card->pre_dir == DMA_FROM_DEVICE) &&\r\n!CHK_SD30_SPEED(sd_card) &&\r\n!CHK_SD_HS(sd_card) &&\r\n!CHK_MMC_HS(sd_card)) {\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\r\nSD_RSP_TYPE_R1b, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 1;\r\nsd_set_err_code(chip, SD_STS_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nsd_card->seq_mode = 0;\r\nretval = rtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\nif (retval != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_IO_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nif ((sd_card->pre_sec_cnt < 0x80) &&\r\n!CHK_SD30_SPEED(sd_card) &&\r\n!CHK_SD_HS(sd_card) &&\r\n!CHK_MMC_HS(sd_card)) {\r\nsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0);\r\n}\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF, 0x00);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF, 0x02);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\r\n(u8)sector_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\r\n(u8)(sector_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01, RING_BUFFER);\r\nif (CHK_MMC_8BIT(sd_card))\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\r\n0x03, SD_BUS_WIDTH_8);\r\nelse if (CHK_MMC_4BIT(sd_card) || CHK_SD(sd_card))\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\r\n0x03, SD_BUS_WIDTH_4);\r\nelse\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\r\n0x03, SD_BUS_WIDTH_1);\r\nif (sd_card->seq_mode) {\r\ncfg2 = SD_NO_CALCULATE_CRC7 | SD_CHECK_CRC16 |\r\nSD_NO_WAIT_BUSY_END | SD_NO_CHECK_CRC7 |\r\nSD_RSP_LEN_0;\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, cfg2);\r\ntrans_dma_enable(srb->sc_data_direction, chip, sector_cnt * 512,\r\nDMA_512);\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_READ_3 | SD_TRANSFER_START);\r\n} else {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\n}\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\n} else {\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\ndev_dbg(rtsx_dev(chip), "SD/MMC CMD %d\n",\r\nREAD_MULTIPLE_BLOCK);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\r\n0x40 | READ_MULTIPLE_BLOCK);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF,\r\n(u8)(data_addr >> 24));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF,\r\n(u8)(data_addr >> 16));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF,\r\n(u8)(data_addr >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF,\r\n(u8)data_addr);\r\ncfg2 = SD_CALCULATE_CRC7 | SD_CHECK_CRC16 |\r\nSD_NO_WAIT_BUSY_END | SD_CHECK_CRC7 |\r\nSD_RSP_LEN_6;\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\r\ncfg2);\r\ntrans_dma_enable(srb->sc_data_direction, chip,\r\nsector_cnt * 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_READ_2 | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\n} else {\r\nretval = rtsx_send_cmd(chip, SD_CARD, 50);\r\nif (retval < 0) {\r\nrtsx_clear_sd_error(chip);\r\nchip->rw_need_retry = 1;\r\nsd_set_err_code(chip, SD_TO_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nretval = wait_data_buf_ready(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 1;\r\nsd_set_err_code(chip, SD_TO_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nretval = sd_send_cmd_get_rsp(chip, WRITE_MULTIPLE_BLOCK,\r\ndata_addr, SD_RSP_TYPE_R1,\r\nNULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 1;\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nrtsx_init_cmd(chip);\r\ncfg2 = SD_NO_CALCULATE_CRC7 | SD_CHECK_CRC16 |\r\nSD_NO_WAIT_BUSY_END |\r\nSD_NO_CHECK_CRC7 | SD_RSP_LEN_0;\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\r\ncfg2);\r\ntrans_dma_enable(srb->sc_data_direction, chip,\r\nsector_cnt * 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\n}\r\nsd_card->seq_mode = 1;\r\n}\r\nretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\r\nscsi_bufflen(srb), scsi_sg_count(srb),\r\nsrb->sc_data_direction, chip->sd_timeout);\r\nif (retval < 0) {\r\nu8 stat = 0;\r\nint err;\r\nsd_card->seq_mode = 0;\r\nif (retval == -ETIMEDOUT)\r\nerr = STATUS_TIMEDOUT;\r\nelse\r\nerr = STATUS_FAIL;\r\nrtsx_read_register(chip, REG_SD_STAT1, &stat);\r\nrtsx_clear_sd_error(chip);\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 0;\r\ndev_dbg(rtsx_dev(chip), "No card exist, exit sd_rw\n");\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nchip->rw_need_retry = 1;\r\nretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\r\nSD_RSP_TYPE_R1b, NULL, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nsd_set_err_code(chip, SD_STS_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nif (stat & (SD_CRC7_ERR | SD_CRC16_ERR | SD_CRC_WRITE_ERR)) {\r\ndev_dbg(rtsx_dev(chip), "SD CRC error, tune clock!\n");\r\nsd_set_err_code(chip, SD_CRC_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nif (err == STATUS_TIMEDOUT) {\r\nsd_set_err_code(chip, SD_TO_ERR);\r\nrtsx_trace(chip);\r\ngoto RW_FAIL;\r\n}\r\nrtsx_trace(chip);\r\nreturn err;\r\n}\r\nsd_card->pre_sec_addr = start_sector;\r\nsd_card->pre_sec_cnt = sector_cnt;\r\nsd_card->pre_dir = srb->sc_data_direction;\r\nreturn STATUS_SUCCESS;\r\nRW_FAIL:\r\nsd_card->seq_mode = 0;\r\nif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 0;\r\ndev_dbg(rtsx_dev(chip), "No card exist, exit sd_rw\n");\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (sd_check_err_code(chip, SD_CRC_ERR)) {\r\nif (CHK_MMC_4BIT(sd_card) || CHK_MMC_8BIT(sd_card)) {\r\nsd_card->mmc_dont_switch_bus = 1;\r\nreset_mmc_only(chip);\r\nsd_card->mmc_dont_switch_bus = 0;\r\n} else {\r\nsd_card->need_retune = 1;\r\nsd_auto_tune_clock(chip);\r\n}\r\n} else if (sd_check_err_code(chip, SD_TO_ERR | SD_STS_ERR)) {\r\nretval = reset_sd_card(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->card_ready &= ~SD_CARD;\r\nchip->card_fail |= SD_CARD;\r\nchip->capacity[chip->card2lun[SD_CARD]] = 0;\r\n}\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nint soft_reset_sd_card(struct rtsx_chip *chip)\r\n{\r\nreturn reset_sd(chip);\r\n}\r\nint ext_sd_get_rsp(struct rtsx_chip *chip, int len, u8 *rsp, u8 rsp_type)\r\n{\r\nint retval, rsp_len;\r\nu16 reg_addr;\r\nif (rsp_type == SD_RSP_TYPE_R0)\r\nreturn STATUS_SUCCESS;\r\nrtsx_init_cmd(chip);\r\nif (rsp_type == SD_RSP_TYPE_R2) {\r\nfor (reg_addr = PPBUF_BASE2; reg_addr < PPBUF_BASE2 + 16;\r\nreg_addr++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\r\nrsp_len = 17;\r\n} else if (rsp_type != SD_RSP_TYPE_R0) {\r\nfor (reg_addr = REG_SD_CMD0; reg_addr <= REG_SD_CMD4;\r\nreg_addr++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\r\nrsp_len = 6;\r\n}\r\nrtsx_add_cmd(chip, READ_REG_CMD, REG_SD_CMD5, 0xFF, 0);\r\nretval = rtsx_send_cmd(chip, SD_CARD, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (rsp) {\r\nint min_len = (rsp_len < len) ? rsp_len : len;\r\nmemcpy(rsp, rtsx_get_cmd_data(chip), min_len);\r\ndev_dbg(rtsx_dev(chip), "min_len = %d\n", min_len);\r\ndev_dbg(rtsx_dev(chip), "Response in cmd buf: 0x%x 0x%x 0x%x 0x%x\n",\r\nrsp[0], rsp[1], rsp[2], rsp[3]);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_pass_thru_mode(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint len;\r\nu8 buf[18] = {\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x0E,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x53,\r\n0x44,\r\n0x20,\r\n0x43,\r\n0x61,\r\n0x72,\r\n0x64,\r\n0x00,\r\n0x00,\r\n0x00,\r\n};\r\nsd_card->pre_cmd_err = 0;\r\nif (!(CHK_BIT(chip->lun_mc, lun))) {\r\nSET_BIT(chip->lun_mc, lun);\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif ((srb->cmnd[2] != 0x53) || (srb->cmnd[3] != 0x44) ||\r\n(srb->cmnd[4] != 0x20) || (srb->cmnd[5] != 0x43) ||\r\n(srb->cmnd[6] != 0x61) || (srb->cmnd[7] != 0x72) ||\r\n(srb->cmnd[8] != 0x64)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nswitch (srb->cmnd[1] & 0x0F) {\r\ncase 0:\r\nsd_card->sd_pass_thru_en = 0;\r\nbreak;\r\ncase 1:\r\nsd_card->sd_pass_thru_en = 1;\r\nbreak;\r\ndefault:\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nbuf[5] = (CHK_SD(sd_card) == 1) ? 0x01 : 0x02;\r\nif (chip->card_wp & SD_CARD)\r\nbuf[5] |= 0x80;\r\nbuf[6] = (u8)(sd_card->sd_addr >> 16);\r\nbuf[7] = (u8)(sd_card->sd_addr >> 24);\r\nbuf[15] = chip->max_lun;\r\nlen = min_t(int, 18, scsi_bufflen(srb));\r\nrtsx_stor_set_xfer_buf(buf, len, srb);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic inline int get_rsp_type(struct scsi_cmnd *srb, u8 *rsp_type,\r\nint *rsp_len)\r\n{\r\nif (!rsp_type || !rsp_len)\r\nreturn STATUS_FAIL;\r\nswitch (srb->cmnd[10]) {\r\ncase 0x03:\r\n*rsp_type = SD_RSP_TYPE_R0;\r\n*rsp_len = 0;\r\nbreak;\r\ncase 0x04:\r\n*rsp_type = SD_RSP_TYPE_R1;\r\n*rsp_len = 6;\r\nbreak;\r\ncase 0x05:\r\n*rsp_type = SD_RSP_TYPE_R1b;\r\n*rsp_len = 6;\r\nbreak;\r\ncase 0x06:\r\n*rsp_type = SD_RSP_TYPE_R2;\r\n*rsp_len = 17;\r\nbreak;\r\ncase 0x07:\r\n*rsp_type = SD_RSP_TYPE_R3;\r\n*rsp_len = 6;\r\nbreak;\r\ndefault:\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint sd_execute_no_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval, rsp_len;\r\nu8 cmd_idx, rsp_type;\r\nbool standby = false, acmd = false;\r\nu32 arg;\r\nif (!sd_card->sd_pass_thru_en) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = true;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = true;\r\narg = ((u32)srb->cmnd[3] << 24) | ((u32)srb->cmnd[4] << 16) |\r\n((u32)srb->cmnd[5] << 8) | srb->cmnd[6];\r\nretval = get_rsp_type(srb, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\r\nif (CHK_MMC_8BIT(sd_card)) {\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\r\nSD_BUS_WIDTH_8);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n} else if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card)) {\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\r\nSD_BUS_WIDTH_4);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n}\r\n}\r\n#else\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03, SD_BUS_WIDTH_4);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#endif\r\nif (standby) {\r\nretval = sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_cmd_failed;\r\n}\r\n}\r\nif (acmd) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\r\nsd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_cmd_failed;\r\n}\r\n}\r\nretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\r\nsd_card->rsp, rsp_len, false);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_cmd_failed;\r\n}\r\nif (standby) {\r\nretval = sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_cmd_failed;\r\n}\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nretval = sd_update_lock_status(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_cmd_failed;\r\n}\r\n#endif\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\nsd_execute_cmd_failed:\r\nsd_card->pre_cmd_err = 1;\r\nset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nrelease_sd_card(chip);\r\ndo_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nint sd_execute_read_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval, rsp_len, i;\r\nbool read_err = false, cmd13_checkbit = false;\r\nu8 cmd_idx, rsp_type, bus_width;\r\nbool standby = false, send_cmd12 = false, acmd = false;\r\nu32 data_len;\r\nif (!sd_card->sd_pass_thru_en) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x04)\r\nsend_cmd12 = true;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = true;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = true;\r\ndata_len = ((u32)srb->cmnd[7] << 16) | ((u32)srb->cmnd[8]\r\n<< 8) | srb->cmnd[9];\r\nretval = get_rsp_type(srb, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\r\nif (CHK_MMC_8BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_8;\r\nelse if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card))\r\nbus_width = SD_BUS_WIDTH_4;\r\nelse\r\nbus_width = SD_BUS_WIDTH_1;\r\n} else {\r\nbus_width = SD_BUS_WIDTH_4;\r\n}\r\ndev_dbg(rtsx_dev(chip), "bus_width = %d\n", bus_width);\r\n#else\r\nbus_width = SD_BUS_WIDTH_4;\r\n#endif\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif (standby) {\r\nretval = sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif (acmd) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\r\nsd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif (data_len <= 512) {\r\nint min_len;\r\nu8 *buf;\r\nu16 byte_cnt, blk_cnt;\r\nu8 cmd[5];\r\nbyte_cnt = ((u16)(srb->cmnd[8] & 0x03) << 8) | srb->cmnd[9];\r\nblk_cnt = 1;\r\ncmd[0] = 0x40 | cmd_idx;\r\ncmd[1] = srb->cmnd[3];\r\ncmd[2] = srb->cmnd[4];\r\ncmd[3] = srb->cmnd[5];\r\ncmd[4] = srb->cmnd[6];\r\nbuf = kmalloc(data_len, GFP_KERNEL);\r\nif (!buf) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_ERROR;\r\n}\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, byte_cnt,\r\nblk_cnt, bus_width, buf, data_len, 2000);\r\nif (retval != STATUS_SUCCESS) {\r\nread_err = true;\r\nkfree(buf);\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nmin_len = min(data_len, scsi_bufflen(srb));\r\nrtsx_stor_set_xfer_buf(buf, min_len, srb);\r\nkfree(buf);\r\n} else if (!(data_len & 0x1FF)) {\r\nrtsx_init_cmd(chip);\r\ntrans_dma_enable(DMA_FROM_DEVICE, chip, data_len, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\r\n0x02);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\r\n0x00);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H,\r\n0xFF, (srb->cmnd[7] & 0xFE) >> 1);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L,\r\n0xFF, (u8)((data_len & 0x0001FE00) >> 9));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\r\n0x40 | cmd_idx);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF,\r\nsrb->cmnd[3]);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF,\r\nsrb->cmnd[4]);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF,\r\nsrb->cmnd[5]);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF,\r\nsrb->cmnd[6]);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, rsp_type);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER,\r\n0xFF, SD_TM_AUTO_READ_2 | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\r\nscsi_bufflen(srb),\r\nscsi_sg_count(srb),\r\nDMA_FROM_DEVICE, 10000);\r\nif (retval < 0) {\r\nread_err = true;\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nretval = ext_sd_get_rsp(chip, rsp_len, sd_card->rsp, rsp_type);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nif (standby) {\r\nretval = sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif (send_cmd12) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\r\nSD_RSP_TYPE_R1b, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nretval = rtsx_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nretval = rtsx_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\n}\r\nif ((srb->cmnd[1] & 0x02) || (srb->cmnd[1] & 0x04))\r\ncmd13_checkbit = true;\r\nfor (i = 0; i < 3; i++) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\ncmd13_checkbit);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_read_cmd_failed;\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\nsd_execute_read_cmd_failed:\r\nsd_card->pre_cmd_err = 1;\r\nset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nif (read_err)\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrelease_sd_card(chip);\r\ndo_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nint sd_execute_write_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval, rsp_len, i;\r\nbool write_err = false, cmd13_checkbit = false;\r\nu8 cmd_idx, rsp_type;\r\nbool standby = false, send_cmd12 = false, acmd = false;\r\nu32 data_len, arg;\r\n#ifdef SUPPORT_SD_LOCK\r\nint lock_cmd_fail = 0;\r\nu8 sd_lock_state = 0;\r\nu8 lock_cmd_type = 0;\r\n#endif\r\nif (!sd_card->sd_pass_thru_en) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x04)\r\nsend_cmd12 = true;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = true;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = true;\r\ndata_len = ((u32)srb->cmnd[7] << 16) | ((u32)srb->cmnd[8]\r\n<< 8) | srb->cmnd[9];\r\narg = ((u32)srb->cmnd[3] << 24) | ((u32)srb->cmnd[4] << 16) |\r\n((u32)srb->cmnd[5] << 8) | srb->cmnd[6];\r\n#ifdef SUPPORT_SD_LOCK\r\nif (cmd_idx == LOCK_UNLOCK) {\r\nsd_lock_state = sd_card->sd_lock_status;\r\nsd_lock_state &= SD_LOCKED;\r\n}\r\n#endif\r\nretval = get_rsp_type(srb, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\r\nif (CHK_MMC_8BIT(sd_card)) {\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\r\nSD_BUS_WIDTH_8);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n} else if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card)) {\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\r\nSD_BUS_WIDTH_4);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n}\r\n}\r\n#else\r\nretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03, SD_BUS_WIDTH_4);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#endif\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nif (standby) {\r\nretval = sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nif (acmd) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\r\nsd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\r\nsd_card->rsp, rsp_len, false);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\nif (data_len <= 512) {\r\nu16 i;\r\nu8 *buf;\r\nbuf = kmalloc(data_len, GFP_KERNEL);\r\nif (!buf) {\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_ERROR;\r\n}\r\nrtsx_stor_get_xfer_buf(buf, data_len, srb);\r\n#ifdef SUPPORT_SD_LOCK\r\nif (cmd_idx == LOCK_UNLOCK)\r\nlock_cmd_type = buf[0] & 0x0F;\r\n#endif\r\nif (data_len > 256) {\r\nrtsx_init_cmd(chip);\r\nfor (i = 0; i < 256; i++) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nPPBUF_BASE2 + i, 0xFF, buf[i]);\r\n}\r\nretval = rtsx_send_cmd(chip, 0, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\nrtsx_init_cmd(chip);\r\nfor (i = 256; i < data_len; i++) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nPPBUF_BASE2 + i, 0xFF, buf[i]);\r\n}\r\nretval = rtsx_send_cmd(chip, 0, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n} else {\r\nrtsx_init_cmd(chip);\r\nfor (i = 0; i < data_len; i++) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nPPBUF_BASE2 + i, 0xFF, buf[i]);\r\n}\r\nretval = rtsx_send_cmd(chip, 0, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nkfree(buf);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\r\nsrb->cmnd[8] & 0x03);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\r\nsrb->cmnd[9]);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\r\n0x00);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\r\n0x01);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\r\nPINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nretval = rtsx_send_cmd(chip, SD_CARD, 250);\r\n} else if (!(data_len & 0x1FF)) {\r\nrtsx_init_cmd(chip);\r\ntrans_dma_enable(DMA_TO_DEVICE, chip, data_len, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\r\n0x02);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\r\n0x00);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H,\r\n0xFF, (srb->cmnd[7] & 0xFE) >> 1);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L,\r\n0xFF, (u8)((data_len & 0x0001FE00) >> 9));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\r\nscsi_bufflen(srb),\r\nscsi_sg_count(srb),\r\nDMA_TO_DEVICE, 10000);\r\n} else {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\nif (retval < 0) {\r\nwrite_err = true;\r\nrtsx_clear_sd_error(chip);\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif (cmd_idx == LOCK_UNLOCK) {\r\nif (lock_cmd_type == SD_ERASE) {\r\nsd_card->sd_erase_status = SD_UNDER_ERASING;\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, 0xFD30, 0x02, 0x02);\r\nrtsx_send_cmd(chip, SD_CARD, 250);\r\nretval = sd_update_lock_status(chip);\r\nif (retval != STATUS_SUCCESS) {\r\ndev_dbg(rtsx_dev(chip), "Lock command fail!\n");\r\nlock_cmd_fail = 1;\r\n}\r\n}\r\n#endif\r\nif (standby) {\r\nretval = sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nif (send_cmd12) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\r\nSD_RSP_TYPE_R1b, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\nfalse);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\nretval = rtsx_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\nrtsx_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nif ((srb->cmnd[1] & 0x02) || (srb->cmnd[1] & 0x04))\r\ncmd13_checkbit = true;\r\nfor (i = 0; i < 3; i++) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SEND_STATUS,\r\nsd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\ncmd13_checkbit);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nif (cmd_idx == LOCK_UNLOCK) {\r\nif (!lock_cmd_fail) {\r\ndev_dbg(rtsx_dev(chip), "lock_cmd_type = 0x%x\n",\r\nlock_cmd_type);\r\nif (lock_cmd_type & SD_CLR_PWD)\r\nsd_card->sd_lock_status &= ~SD_PWD_EXIST;\r\nif (lock_cmd_type & SD_SET_PWD)\r\nsd_card->sd_lock_status |= SD_PWD_EXIST;\r\n}\r\ndev_dbg(rtsx_dev(chip), "sd_lock_state = 0x%x, sd_card->sd_lock_status = 0x%x\n",\r\nsd_lock_state, sd_card->sd_lock_status);\r\nif (sd_lock_state ^ (sd_card->sd_lock_status & SD_LOCKED)) {\r\nsd_card->sd_lock_notify = 1;\r\nif (sd_lock_state) {\r\nif (sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) {\r\nsd_card->sd_lock_status |= (\r\nSD_UNLOCK_POW_ON | SD_SDR_RST);\r\nif (CHK_SD(sd_card)) {\r\nretval = reset_sd(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nsd_card->sd_lock_status &= ~(SD_UNLOCK_POW_ON | SD_SDR_RST);\r\nrtsx_trace(chip);\r\ngoto sd_execute_write_cmd_failed;\r\n}\r\n}\r\nsd_card->sd_lock_status &= ~(SD_UNLOCK_POW_ON | SD_SDR_RST);\r\n}\r\n}\r\n}\r\n}\r\nif (lock_cmd_fail) {\r\nscsi_set_resid(srb, 0);\r\nset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#endif\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\nsd_execute_write_cmd_failed:\r\nsd_card->pre_cmd_err = 1;\r\nset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nif (write_err)\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\nrelease_sd_card(chip);\r\ndo_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nint sd_get_cmd_rsp(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint count;\r\nu16 data_len;\r\nif (!sd_card->sd_pass_thru_en) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\ndata_len = ((u16)srb->cmnd[7] << 8) | srb->cmnd[8];\r\nif (sd_card->last_rsp_type == SD_RSP_TYPE_R0) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n} else if (sd_card->last_rsp_type == SD_RSP_TYPE_R2) {\r\ncount = (data_len < 17) ? data_len : 17;\r\n} else {\r\ncount = (data_len < 6) ? data_len : 6;\r\n}\r\nrtsx_stor_set_xfer_buf(sd_card->rsp, count, srb);\r\ndev_dbg(rtsx_dev(chip), "Response length: %d\n", data_len);\r\ndev_dbg(rtsx_dev(chip), "Response: 0x%x 0x%x 0x%x 0x%x\n",\r\nsd_card->rsp[0], sd_card->rsp[1],\r\nsd_card->rsp[2], sd_card->rsp[3]);\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nint sd_hw_rst(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nif (!sd_card->sd_pass_thru_en) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif ((srb->cmnd[2] != 0x53) || (srb->cmnd[3] != 0x44) ||\r\n(srb->cmnd[4] != 0x20) || (srb->cmnd[5] != 0x43) ||\r\n(srb->cmnd[6] != 0x61) || (srb->cmnd[7] != 0x72) ||\r\n(srb->cmnd[8] != 0x64)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nswitch (srb->cmnd[1] & 0x0F) {\r\ncase 0:\r\n#ifdef SUPPORT_SD_LOCK\r\nif (srb->cmnd[9] == 0x64)\r\nsd_card->sd_lock_status |= SD_SDR_RST;\r\n#endif\r\nretval = reset_sd_card(chip);\r\nif (retval != STATUS_SUCCESS) {\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status &= ~SD_SDR_RST;\r\n#endif\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nsd_card->pre_cmd_err = 1;\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status &= ~SD_SDR_RST;\r\n#endif\r\nbreak;\r\ncase 1:\r\nretval = soft_reset_sd_card(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nsd_card->pre_cmd_err = 1;\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nbreak;\r\ndefault:\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nvoid sd_cleanup_work(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nif (sd_card->seq_mode) {\r\ndev_dbg(rtsx_dev(chip), "SD: stop transmission\n");\r\nsd_stop_seq_mode(chip);\r\nsd_card->cleanup_counter = 0;\r\n}\r\n}\r\nint sd_power_off_card3v3(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nretval = disable_card_clock(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, CARD_OE, SD_OUTPUT_EN, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (!chip->ft2_fast_mode) {\r\nretval = card_power_off(chip, SD_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nwait_timeout(50);\r\n}\r\nif (chip->asic_code) {\r\nretval = sd_pull_ctl_disable(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, FPGA_PULL_CTL,\r\nFPGA_SD_PULL_CTL_BIT | 0x20,\r\nFPGA_SD_PULL_CTL_BIT);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint release_sd_card(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &chip->sd_card;\r\nint retval;\r\nchip->card_ready &= ~SD_CARD;\r\nchip->card_fail &= ~SD_CARD;\r\nchip->card_wp &= ~SD_CARD;\r\nchip->sd_io = 0;\r\nchip->sd_int = 0;\r\n#ifdef SUPPORT_SD_LOCK\r\nsd_card->sd_lock_status = 0;\r\nsd_card->sd_erase_status = 0;\r\n#endif\r\nmemset(sd_card->raw_csd, 0, 16);\r\nmemset(sd_card->raw_scr, 0, 8);\r\nretval = sd_power_off_card3v3(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}

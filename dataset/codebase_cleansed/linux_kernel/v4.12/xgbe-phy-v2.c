static int xgbe_phy_i2c_xfer(struct xgbe_prv_data *pdata,\r\nstruct xgbe_i2c_op *i2c_op)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (WARN_ON(!phy_data->comm_owned))\r\nreturn -EIO;\r\nreturn pdata->i2c_if.i2c_xfer(pdata, i2c_op);\r\n}\r\nstatic int xgbe_phy_redrv_write(struct xgbe_prv_data *pdata, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_i2c_op i2c_op;\r\n__be16 *redrv_val;\r\nu8 redrv_data[5], csum;\r\nunsigned int i, retry;\r\nint ret;\r\nredrv_data[0] = ((reg >> 8) & 0xff) << 1;\r\nredrv_data[1] = reg & 0xff;\r\nredrv_val = (__be16 *)&redrv_data[2];\r\n*redrv_val = cpu_to_be16(val);\r\ncsum = 0;\r\nfor (i = 0; i < 4; i++) {\r\ncsum += redrv_data[i];\r\nif (redrv_data[i] > csum)\r\ncsum++;\r\n}\r\nredrv_data[4] = ~csum;\r\nretry = 1;\r\nagain1:\r\ni2c_op.cmd = XGBE_I2C_CMD_WRITE;\r\ni2c_op.target = phy_data->redrv_addr;\r\ni2c_op.len = sizeof(redrv_data);\r\ni2c_op.buf = redrv_data;\r\nret = xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\nif (ret) {\r\nif ((ret == -EAGAIN) && retry--)\r\ngoto again1;\r\nreturn ret;\r\n}\r\nretry = 1;\r\nagain2:\r\ni2c_op.cmd = XGBE_I2C_CMD_READ;\r\ni2c_op.target = phy_data->redrv_addr;\r\ni2c_op.len = 1;\r\ni2c_op.buf = redrv_data;\r\nret = xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\nif (ret) {\r\nif ((ret == -EAGAIN) && retry--)\r\ngoto again2;\r\nreturn ret;\r\n}\r\nif (redrv_data[0] != 0xff) {\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"Redriver write checksum error\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_i2c_write(struct xgbe_prv_data *pdata, unsigned int target,\r\nvoid *val, unsigned int val_len)\r\n{\r\nstruct xgbe_i2c_op i2c_op;\r\nint retry, ret;\r\nretry = 1;\r\nagain:\r\ni2c_op.cmd = XGBE_I2C_CMD_WRITE;\r\ni2c_op.target = target;\r\ni2c_op.len = val_len;\r\ni2c_op.buf = val;\r\nret = xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\nif ((ret == -EAGAIN) && retry--)\r\ngoto again;\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_i2c_read(struct xgbe_prv_data *pdata, unsigned int target,\r\nvoid *reg, unsigned int reg_len,\r\nvoid *val, unsigned int val_len)\r\n{\r\nstruct xgbe_i2c_op i2c_op;\r\nint retry, ret;\r\nretry = 1;\r\nagain1:\r\ni2c_op.cmd = XGBE_I2C_CMD_WRITE;\r\ni2c_op.target = target;\r\ni2c_op.len = reg_len;\r\ni2c_op.buf = reg;\r\nret = xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\nif (ret) {\r\nif ((ret == -EAGAIN) && retry--)\r\ngoto again1;\r\nreturn ret;\r\n}\r\nretry = 1;\r\nagain2:\r\ni2c_op.cmd = XGBE_I2C_CMD_READ;\r\ni2c_op.target = target;\r\ni2c_op.len = val_len;\r\ni2c_op.buf = val;\r\nret = xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\nif ((ret == -EAGAIN) && retry--)\r\ngoto again2;\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_sfp_put_mux(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_i2c_op i2c_op;\r\nu8 mux_channel;\r\nif (phy_data->sfp_comm == XGBE_SFP_COMM_DIRECT)\r\nreturn 0;\r\nmux_channel = 0;\r\ni2c_op.cmd = XGBE_I2C_CMD_WRITE;\r\ni2c_op.target = phy_data->sfp_mux_address;\r\ni2c_op.len = sizeof(mux_channel);\r\ni2c_op.buf = &mux_channel;\r\nreturn xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\n}\r\nstatic int xgbe_phy_sfp_get_mux(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_i2c_op i2c_op;\r\nu8 mux_channel;\r\nif (phy_data->sfp_comm == XGBE_SFP_COMM_DIRECT)\r\nreturn 0;\r\nmux_channel = 1 << phy_data->sfp_mux_channel;\r\ni2c_op.cmd = XGBE_I2C_CMD_WRITE;\r\ni2c_op.target = phy_data->sfp_mux_address;\r\ni2c_op.len = sizeof(mux_channel);\r\ni2c_op.buf = &mux_channel;\r\nreturn xgbe_phy_i2c_xfer(pdata, &i2c_op);\r\n}\r\nstatic void xgbe_phy_put_comm_ownership(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nphy_data->comm_owned = 0;\r\nmutex_unlock(&xgbe_phy_comm_lock);\r\n}\r\nstatic int xgbe_phy_get_comm_ownership(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned long timeout;\r\nunsigned int mutex_id;\r\nif (phy_data->comm_owned)\r\nreturn 0;\r\nmutex_lock(&xgbe_phy_comm_lock);\r\nXP_IOWRITE(pdata, XP_I2C_MUTEX, XGBE_MUTEX_RELEASE);\r\nXP_IOWRITE(pdata, XP_MDIO_MUTEX, XGBE_MUTEX_RELEASE);\r\nmutex_id = 0;\r\nXP_SET_BITS(mutex_id, XP_I2C_MUTEX, ID, phy_data->port_id);\r\nXP_SET_BITS(mutex_id, XP_I2C_MUTEX, ACTIVE, 1);\r\ntimeout = jiffies + (5 * HZ);\r\nwhile (time_before(jiffies, timeout)) {\r\nif (XP_IOREAD(pdata, XP_I2C_MUTEX) ||\r\nXP_IOREAD(pdata, XP_MDIO_MUTEX)) {\r\nusleep_range(100, 200);\r\ncontinue;\r\n}\r\nXP_IOWRITE(pdata, XP_I2C_MUTEX, mutex_id);\r\nXP_IOWRITE(pdata, XP_MDIO_MUTEX, mutex_id);\r\nphy_data->comm_owned = 1;\r\nreturn 0;\r\n}\r\nmutex_unlock(&xgbe_phy_comm_lock);\r\nnetdev_err(pdata->netdev, "unable to obtain hardware mutexes\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int xgbe_phy_mdio_mii_write(struct xgbe_prv_data *pdata, int addr,\r\nint reg, u16 val)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (reg & MII_ADDR_C45) {\r\nif (phy_data->phydev_mode != XGBE_MDIO_MODE_CL45)\r\nreturn -ENOTSUPP;\r\n} else {\r\nif (phy_data->phydev_mode != XGBE_MDIO_MODE_CL22)\r\nreturn -ENOTSUPP;\r\n}\r\nreturn pdata->hw_if.write_ext_mii_regs(pdata, addr, reg, val);\r\n}\r\nstatic int xgbe_phy_i2c_mii_write(struct xgbe_prv_data *pdata, int reg, u16 val)\r\n{\r\n__be16 *mii_val;\r\nu8 mii_data[3];\r\nint ret;\r\nret = xgbe_phy_sfp_get_mux(pdata);\r\nif (ret)\r\nreturn ret;\r\nmii_data[0] = reg & 0xff;\r\nmii_val = (__be16 *)&mii_data[1];\r\n*mii_val = cpu_to_be16(val);\r\nret = xgbe_phy_i2c_write(pdata, XGBE_SFP_PHY_ADDRESS,\r\nmii_data, sizeof(mii_data));\r\nxgbe_phy_sfp_put_mux(pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_mii_write(struct mii_bus *mii, int addr, int reg, u16 val)\r\n{\r\nstruct xgbe_prv_data *pdata = mii->priv;\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nret = xgbe_phy_get_comm_ownership(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (phy_data->conn_type == XGBE_CONN_TYPE_SFP)\r\nret = xgbe_phy_i2c_mii_write(pdata, reg, val);\r\nelse if (phy_data->conn_type & XGBE_CONN_TYPE_MDIO)\r\nret = xgbe_phy_mdio_mii_write(pdata, addr, reg, val);\r\nelse\r\nret = -ENOTSUPP;\r\nxgbe_phy_put_comm_ownership(pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_mdio_mii_read(struct xgbe_prv_data *pdata, int addr,\r\nint reg)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (reg & MII_ADDR_C45) {\r\nif (phy_data->phydev_mode != XGBE_MDIO_MODE_CL45)\r\nreturn -ENOTSUPP;\r\n} else {\r\nif (phy_data->phydev_mode != XGBE_MDIO_MODE_CL22)\r\nreturn -ENOTSUPP;\r\n}\r\nreturn pdata->hw_if.read_ext_mii_regs(pdata, addr, reg);\r\n}\r\nstatic int xgbe_phy_i2c_mii_read(struct xgbe_prv_data *pdata, int reg)\r\n{\r\n__be16 mii_val;\r\nu8 mii_reg;\r\nint ret;\r\nret = xgbe_phy_sfp_get_mux(pdata);\r\nif (ret)\r\nreturn ret;\r\nmii_reg = reg;\r\nret = xgbe_phy_i2c_read(pdata, XGBE_SFP_PHY_ADDRESS,\r\n&mii_reg, sizeof(mii_reg),\r\n&mii_val, sizeof(mii_val));\r\nif (!ret)\r\nret = be16_to_cpu(mii_val);\r\nxgbe_phy_sfp_put_mux(pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_mii_read(struct mii_bus *mii, int addr, int reg)\r\n{\r\nstruct xgbe_prv_data *pdata = mii->priv;\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nret = xgbe_phy_get_comm_ownership(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (phy_data->conn_type == XGBE_CONN_TYPE_SFP)\r\nret = xgbe_phy_i2c_mii_read(pdata, reg);\r\nelse if (phy_data->conn_type & XGBE_CONN_TYPE_MDIO)\r\nret = xgbe_phy_mdio_mii_read(pdata, addr, reg);\r\nelse\r\nret = -ENOTSUPP;\r\nxgbe_phy_put_comm_ownership(pdata);\r\nreturn ret;\r\n}\r\nstatic void xgbe_phy_sfp_phy_settings(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (phy_data->sfp_mod_absent) {\r\npdata->phy.speed = SPEED_UNKNOWN;\r\npdata->phy.duplex = DUPLEX_UNKNOWN;\r\npdata->phy.autoneg = AUTONEG_ENABLE;\r\npdata->phy.advertising = pdata->phy.supported;\r\nreturn;\r\n}\r\npdata->phy.advertising &= ~ADVERTISED_Autoneg;\r\npdata->phy.advertising &= ~ADVERTISED_TP;\r\npdata->phy.advertising &= ~ADVERTISED_FIBRE;\r\npdata->phy.advertising &= ~ADVERTISED_100baseT_Full;\r\npdata->phy.advertising &= ~ADVERTISED_1000baseT_Full;\r\npdata->phy.advertising &= ~ADVERTISED_10000baseT_Full;\r\npdata->phy.advertising &= ~ADVERTISED_10000baseR_FEC;\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\ncase XGBE_SFP_BASE_1000_SX:\r\ncase XGBE_SFP_BASE_1000_LX:\r\ncase XGBE_SFP_BASE_1000_CX:\r\npdata->phy.speed = SPEED_UNKNOWN;\r\npdata->phy.duplex = DUPLEX_UNKNOWN;\r\npdata->phy.autoneg = AUTONEG_ENABLE;\r\npdata->phy.advertising |= ADVERTISED_Autoneg;\r\nbreak;\r\ncase XGBE_SFP_BASE_10000_SR:\r\ncase XGBE_SFP_BASE_10000_LR:\r\ncase XGBE_SFP_BASE_10000_LRM:\r\ncase XGBE_SFP_BASE_10000_ER:\r\ncase XGBE_SFP_BASE_10000_CR:\r\ndefault:\r\npdata->phy.speed = SPEED_10000;\r\npdata->phy.duplex = DUPLEX_FULL;\r\npdata->phy.autoneg = AUTONEG_DISABLE;\r\nbreak;\r\n}\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\ncase XGBE_SFP_BASE_1000_CX:\r\ncase XGBE_SFP_BASE_10000_CR:\r\npdata->phy.advertising |= ADVERTISED_TP;\r\nbreak;\r\ndefault:\r\npdata->phy.advertising |= ADVERTISED_FIBRE;\r\n}\r\nswitch (phy_data->sfp_speed) {\r\ncase XGBE_SFP_SPEED_100_1000:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100)\r\npdata->phy.advertising |= ADVERTISED_100baseT_Full;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000)\r\npdata->phy.advertising |= ADVERTISED_1000baseT_Full;\r\nbreak;\r\ncase XGBE_SFP_SPEED_1000:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000)\r\npdata->phy.advertising |= ADVERTISED_1000baseT_Full;\r\nbreak;\r\ncase XGBE_SFP_SPEED_10000:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000)\r\npdata->phy.advertising |= ADVERTISED_10000baseT_Full;\r\nbreak;\r\ndefault:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000)\r\npdata->phy.advertising |= ADVERTISED_10000baseT_Full;\r\nelse if (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000)\r\npdata->phy.advertising |= ADVERTISED_1000baseT_Full;\r\nelse if (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100)\r\npdata->phy.advertising |= ADVERTISED_100baseT_Full;\r\n}\r\n}\r\nstatic bool xgbe_phy_sfp_bit_rate(struct xgbe_sfp_eeprom *sfp_eeprom,\r\nenum xgbe_sfp_speed sfp_speed)\r\n{\r\nu8 *sfp_base, min, max;\r\nsfp_base = sfp_eeprom->base;\r\nswitch (sfp_speed) {\r\ncase XGBE_SFP_SPEED_1000:\r\nmin = XGBE_SFP_BASE_BR_1GBE_MIN;\r\nmax = XGBE_SFP_BASE_BR_1GBE_MAX;\r\nbreak;\r\ncase XGBE_SFP_SPEED_10000:\r\nmin = XGBE_SFP_BASE_BR_10GBE_MIN;\r\nmax = XGBE_SFP_BASE_BR_10GBE_MAX;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nreturn ((sfp_base[XGBE_SFP_BASE_BR] >= min) &&\r\n(sfp_base[XGBE_SFP_BASE_BR] <= max));\r\n}\r\nstatic void xgbe_phy_free_phy_device(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (phy_data->phydev) {\r\nphy_detach(phy_data->phydev);\r\nphy_device_remove(phy_data->phydev);\r\nphy_device_free(phy_data->phydev);\r\nphy_data->phydev = NULL;\r\n}\r\n}\r\nstatic bool xgbe_phy_finisar_phy_quirks(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int phy_id = phy_data->phydev->phy_id;\r\nif ((phy_id & 0xfffffff0) != 0x01ff0cc0)\r\nreturn false;\r\nphy_write(phy_data->phydev, 0x16, 0x0001);\r\nphy_write(phy_data->phydev, 0x00, 0x9140);\r\nphy_write(phy_data->phydev, 0x16, 0x0000);\r\nphy_write(phy_data->phydev, 0x1b, 0x9084);\r\nphy_write(phy_data->phydev, 0x09, 0x0e00);\r\nphy_write(phy_data->phydev, 0x00, 0x8140);\r\nphy_write(phy_data->phydev, 0x04, 0x0d01);\r\nphy_write(phy_data->phydev, 0x00, 0x9140);\r\nphy_data->phydev->supported = PHY_GBIT_FEATURES;\r\nphy_data->phydev->supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\nphy_data->phydev->advertising = phy_data->phydev->supported;\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"Finisar PHY quirk in place\n");\r\nreturn true;\r\n}\r\nstatic void xgbe_phy_external_phy_quirks(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_phy_finisar_phy_quirks(pdata))\r\nreturn;\r\n}\r\nstatic int xgbe_phy_find_phy_device(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct phy_device *phydev;\r\nint ret;\r\nif (phy_data->phydev)\r\nreturn 0;\r\nif (phy_data->phydev_mode == XGBE_MDIO_MODE_NONE)\r\nreturn 0;\r\nif ((phy_data->port_mode == XGBE_PORT_MODE_SFP) &&\r\n!phy_data->sfp_phy_avail)\r\nreturn 0;\r\nret = pdata->hw_if.set_ext_mii_mode(pdata, phy_data->mdio_addr,\r\nphy_data->phydev_mode);\r\nif (ret) {\r\nnetdev_err(pdata->netdev,\r\n"mdio port/clause not compatible (%u/%u)\n",\r\nphy_data->mdio_addr, phy_data->phydev_mode);\r\nreturn ret;\r\n}\r\nphydev = get_phy_device(phy_data->mii, phy_data->mdio_addr,\r\n(phy_data->phydev_mode == XGBE_MDIO_MODE_CL45));\r\nif (IS_ERR(phydev)) {\r\nnetdev_err(pdata->netdev, "get_phy_device failed\n");\r\nreturn -ENODEV;\r\n}\r\nnetif_dbg(pdata, drv, pdata->netdev, "external PHY id is %#010x\n",\r\nphydev->phy_id);\r\nret = phy_device_register(phydev);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "phy_device_register failed\n");\r\nphy_device_free(phydev);\r\nreturn ret;\r\n}\r\nret = phy_attach_direct(pdata->netdev, phydev, phydev->dev_flags,\r\nPHY_INTERFACE_MODE_SGMII);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "phy_attach_direct failed\n");\r\nphy_device_remove(phydev);\r\nphy_device_free(phydev);\r\nreturn ret;\r\n}\r\nphy_data->phydev = phydev;\r\nxgbe_phy_external_phy_quirks(pdata);\r\nphydev->advertising &= pdata->phy.advertising;\r\nphy_start_aneg(phy_data->phydev);\r\nreturn 0;\r\n}\r\nstatic void xgbe_phy_sfp_external_phy(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nif (!phy_data->sfp_changed)\r\nreturn;\r\nphy_data->sfp_phy_avail = 0;\r\nif (phy_data->sfp_base != XGBE_SFP_BASE_1000_T)\r\nreturn;\r\nret = xgbe_phy_i2c_mii_read(pdata, MII_BMCR);\r\nif (ret < 0)\r\nreturn;\r\nphy_data->sfp_phy_avail = 1;\r\n}\r\nstatic bool xgbe_phy_belfuse_parse_quirks(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_sfp_eeprom *sfp_eeprom = &phy_data->sfp_eeprom;\r\nif (memcmp(&sfp_eeprom->base[XGBE_SFP_BASE_VENDOR_NAME],\r\nXGBE_BEL_FUSE_VENDOR, XGBE_SFP_BASE_VENDOR_NAME_LEN))\r\nreturn false;\r\nif (!memcmp(&sfp_eeprom->base[XGBE_SFP_BASE_VENDOR_PN],\r\nXGBE_BEL_FUSE_PARTNO, XGBE_SFP_BASE_VENDOR_PN_LEN)) {\r\nphy_data->sfp_base = XGBE_SFP_BASE_1000_SX;\r\nphy_data->sfp_cable = XGBE_SFP_CABLE_ACTIVE;\r\nphy_data->sfp_speed = XGBE_SFP_SPEED_1000;\r\nif (phy_data->sfp_changed)\r\nnetif_dbg(pdata, drv, pdata->netdev,\r\n"Bel-Fuse SFP quirk in place\n");\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool xgbe_phy_sfp_parse_quirks(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_phy_belfuse_parse_quirks(pdata))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic void xgbe_phy_sfp_parse_eeprom(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_sfp_eeprom *sfp_eeprom = &phy_data->sfp_eeprom;\r\nu8 *sfp_base;\r\nsfp_base = sfp_eeprom->base;\r\nif (sfp_base[XGBE_SFP_BASE_ID] != XGBE_SFP_ID_SFP)\r\nreturn;\r\nif (sfp_base[XGBE_SFP_BASE_EXT_ID] != XGBE_SFP_EXT_ID_SFP)\r\nreturn;\r\nif (xgbe_phy_sfp_parse_quirks(pdata))\r\nreturn;\r\nif (sfp_base[XGBE_SFP_BASE_CABLE] & XGBE_SFP_BASE_CABLE_PASSIVE) {\r\nphy_data->sfp_cable = XGBE_SFP_CABLE_PASSIVE;\r\nphy_data->sfp_cable_len = sfp_base[XGBE_SFP_BASE_CU_CABLE_LEN];\r\n} else {\r\nphy_data->sfp_cable = XGBE_SFP_CABLE_ACTIVE;\r\n}\r\nif (sfp_base[XGBE_SFP_BASE_10GBE_CC] & XGBE_SFP_BASE_10GBE_CC_SR)\r\nphy_data->sfp_base = XGBE_SFP_BASE_10000_SR;\r\nelse if (sfp_base[XGBE_SFP_BASE_10GBE_CC] & XGBE_SFP_BASE_10GBE_CC_LR)\r\nphy_data->sfp_base = XGBE_SFP_BASE_10000_LR;\r\nelse if (sfp_base[XGBE_SFP_BASE_10GBE_CC] & XGBE_SFP_BASE_10GBE_CC_LRM)\r\nphy_data->sfp_base = XGBE_SFP_BASE_10000_LRM;\r\nelse if (sfp_base[XGBE_SFP_BASE_10GBE_CC] & XGBE_SFP_BASE_10GBE_CC_ER)\r\nphy_data->sfp_base = XGBE_SFP_BASE_10000_ER;\r\nelse if (sfp_base[XGBE_SFP_BASE_1GBE_CC] & XGBE_SFP_BASE_1GBE_CC_SX)\r\nphy_data->sfp_base = XGBE_SFP_BASE_1000_SX;\r\nelse if (sfp_base[XGBE_SFP_BASE_1GBE_CC] & XGBE_SFP_BASE_1GBE_CC_LX)\r\nphy_data->sfp_base = XGBE_SFP_BASE_1000_LX;\r\nelse if (sfp_base[XGBE_SFP_BASE_1GBE_CC] & XGBE_SFP_BASE_1GBE_CC_CX)\r\nphy_data->sfp_base = XGBE_SFP_BASE_1000_CX;\r\nelse if (sfp_base[XGBE_SFP_BASE_1GBE_CC] & XGBE_SFP_BASE_1GBE_CC_T)\r\nphy_data->sfp_base = XGBE_SFP_BASE_1000_T;\r\nelse if ((phy_data->sfp_cable == XGBE_SFP_CABLE_PASSIVE) &&\r\nxgbe_phy_sfp_bit_rate(sfp_eeprom, XGBE_SFP_SPEED_10000))\r\nphy_data->sfp_base = XGBE_SFP_BASE_10000_CR;\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\nphy_data->sfp_speed = XGBE_SFP_SPEED_100_1000;\r\nbreak;\r\ncase XGBE_SFP_BASE_1000_SX:\r\ncase XGBE_SFP_BASE_1000_LX:\r\ncase XGBE_SFP_BASE_1000_CX:\r\nphy_data->sfp_speed = XGBE_SFP_SPEED_1000;\r\nbreak;\r\ncase XGBE_SFP_BASE_10000_SR:\r\ncase XGBE_SFP_BASE_10000_LR:\r\ncase XGBE_SFP_BASE_10000_LRM:\r\ncase XGBE_SFP_BASE_10000_ER:\r\ncase XGBE_SFP_BASE_10000_CR:\r\nphy_data->sfp_speed = XGBE_SFP_SPEED_10000;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void xgbe_phy_sfp_eeprom_info(struct xgbe_prv_data *pdata,\r\nstruct xgbe_sfp_eeprom *sfp_eeprom)\r\n{\r\nstruct xgbe_sfp_ascii sfp_ascii;\r\nchar *sfp_data = (char *)&sfp_ascii;\r\nnetif_dbg(pdata, drv, pdata->netdev, "SFP detected:\n");\r\nmemcpy(sfp_data, &sfp_eeprom->base[XGBE_SFP_BASE_VENDOR_NAME],\r\nXGBE_SFP_BASE_VENDOR_NAME_LEN);\r\nsfp_data[XGBE_SFP_BASE_VENDOR_NAME_LEN] = '\0';\r\nnetif_dbg(pdata, drv, pdata->netdev, " vendor: %s\n",\r\nsfp_data);\r\nmemcpy(sfp_data, &sfp_eeprom->base[XGBE_SFP_BASE_VENDOR_PN],\r\nXGBE_SFP_BASE_VENDOR_PN_LEN);\r\nsfp_data[XGBE_SFP_BASE_VENDOR_PN_LEN] = '\0';\r\nnetif_dbg(pdata, drv, pdata->netdev, " part number: %s\n",\r\nsfp_data);\r\nmemcpy(sfp_data, &sfp_eeprom->base[XGBE_SFP_BASE_VENDOR_REV],\r\nXGBE_SFP_BASE_VENDOR_REV_LEN);\r\nsfp_data[XGBE_SFP_BASE_VENDOR_REV_LEN] = '\0';\r\nnetif_dbg(pdata, drv, pdata->netdev, " revision level: %s\n",\r\nsfp_data);\r\nmemcpy(sfp_data, &sfp_eeprom->extd[XGBE_SFP_BASE_VENDOR_SN],\r\nXGBE_SFP_BASE_VENDOR_SN_LEN);\r\nsfp_data[XGBE_SFP_BASE_VENDOR_SN_LEN] = '\0';\r\nnetif_dbg(pdata, drv, pdata->netdev, " serial number: %s\n",\r\nsfp_data);\r\n}\r\nstatic bool xgbe_phy_sfp_verify_eeprom(u8 cc_in, u8 *buf, unsigned int len)\r\n{\r\nu8 cc;\r\nfor (cc = 0; len; buf++, len--)\r\ncc += *buf;\r\nreturn (cc == cc_in) ? true : false;\r\n}\r\nstatic int xgbe_phy_sfp_read_eeprom(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nstruct xgbe_sfp_eeprom sfp_eeprom;\r\nu8 eeprom_addr;\r\nint ret;\r\nret = xgbe_phy_sfp_get_mux(pdata);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "I2C error setting SFP MUX\n");\r\nreturn ret;\r\n}\r\neeprom_addr = 0;\r\nret = xgbe_phy_i2c_read(pdata, XGBE_SFP_SERIAL_ID_ADDRESS,\r\n&eeprom_addr, sizeof(eeprom_addr),\r\n&sfp_eeprom, sizeof(sfp_eeprom));\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "I2C error reading SFP EEPROM\n");\r\ngoto put;\r\n}\r\nif (!xgbe_phy_sfp_verify_eeprom(sfp_eeprom.base[XGBE_SFP_BASE_CC],\r\nsfp_eeprom.base,\r\nsizeof(sfp_eeprom.base) - 1)) {\r\nret = -EINVAL;\r\ngoto put;\r\n}\r\nif (!xgbe_phy_sfp_verify_eeprom(sfp_eeprom.extd[XGBE_SFP_EXTD_CC],\r\nsfp_eeprom.extd,\r\nsizeof(sfp_eeprom.extd) - 1)) {\r\nret = -EINVAL;\r\ngoto put;\r\n}\r\nif (memcmp(&phy_data->sfp_eeprom, &sfp_eeprom, sizeof(sfp_eeprom))) {\r\nphy_data->sfp_changed = 1;\r\nif (netif_msg_drv(pdata))\r\nxgbe_phy_sfp_eeprom_info(pdata, &sfp_eeprom);\r\nmemcpy(&phy_data->sfp_eeprom, &sfp_eeprom, sizeof(sfp_eeprom));\r\nif (sfp_eeprom.extd[XGBE_SFP_EXTD_SFF_8472]) {\r\nu8 diag_type = sfp_eeprom.extd[XGBE_SFP_EXTD_DIAG];\r\nif (!(diag_type & XGBE_SFP_EXTD_DIAG_ADDR_CHANGE))\r\nphy_data->sfp_diags = 1;\r\n}\r\nxgbe_phy_free_phy_device(pdata);\r\n} else {\r\nphy_data->sfp_changed = 0;\r\n}\r\nput:\r\nxgbe_phy_sfp_put_mux(pdata);\r\nreturn ret;\r\n}\r\nstatic void xgbe_phy_sfp_signals(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int gpio_input;\r\nu8 gpio_reg, gpio_ports[2];\r\nint ret;\r\ngpio_reg = 0;\r\nret = xgbe_phy_i2c_read(pdata, phy_data->sfp_gpio_address,\r\n&gpio_reg, sizeof(gpio_reg),\r\ngpio_ports, sizeof(gpio_ports));\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "I2C error reading SFP GPIOs\n");\r\nreturn;\r\n}\r\ngpio_input = (gpio_ports[1] << 8) | gpio_ports[0];\r\nif (phy_data->sfp_gpio_mask & XGBE_GPIO_NO_MOD_ABSENT) {\r\nphy_data->sfp_mod_absent = 0;\r\n} else {\r\nif (!(gpio_input & (1 << phy_data->sfp_gpio_mod_absent)))\r\nphy_data->sfp_mod_absent = 0;\r\n}\r\nif (!(phy_data->sfp_gpio_mask & XGBE_GPIO_NO_RX_LOS) &&\r\n(gpio_input & (1 << phy_data->sfp_gpio_rx_los)))\r\nphy_data->sfp_rx_los = 1;\r\nif (!(phy_data->sfp_gpio_mask & XGBE_GPIO_NO_TX_FAULT) &&\r\n(gpio_input & (1 << phy_data->sfp_gpio_tx_fault)))\r\nphy_data->sfp_tx_fault = 1;\r\n}\r\nstatic void xgbe_phy_sfp_mod_absent(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nxgbe_phy_free_phy_device(pdata);\r\nphy_data->sfp_mod_absent = 1;\r\nphy_data->sfp_phy_avail = 0;\r\nmemset(&phy_data->sfp_eeprom, 0, sizeof(phy_data->sfp_eeprom));\r\n}\r\nstatic void xgbe_phy_sfp_reset(struct xgbe_phy_data *phy_data)\r\n{\r\nphy_data->sfp_rx_los = 0;\r\nphy_data->sfp_tx_fault = 0;\r\nphy_data->sfp_mod_absent = 1;\r\nphy_data->sfp_diags = 0;\r\nphy_data->sfp_base = XGBE_SFP_BASE_UNKNOWN;\r\nphy_data->sfp_cable = XGBE_SFP_CABLE_UNKNOWN;\r\nphy_data->sfp_speed = XGBE_SFP_SPEED_UNKNOWN;\r\n}\r\nstatic void xgbe_phy_sfp_detect(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nxgbe_phy_sfp_reset(phy_data);\r\nret = xgbe_phy_get_comm_ownership(pdata);\r\nif (ret)\r\nreturn;\r\nxgbe_phy_sfp_signals(pdata);\r\nif (phy_data->sfp_mod_absent) {\r\nxgbe_phy_sfp_mod_absent(pdata);\r\ngoto put;\r\n}\r\nret = xgbe_phy_sfp_read_eeprom(pdata);\r\nif (ret) {\r\nxgbe_phy_sfp_reset(phy_data);\r\nxgbe_phy_sfp_mod_absent(pdata);\r\ngoto put;\r\n}\r\nxgbe_phy_sfp_parse_eeprom(pdata);\r\nxgbe_phy_sfp_external_phy(pdata);\r\nput:\r\nxgbe_phy_sfp_phy_settings(pdata);\r\nxgbe_phy_put_comm_ownership(pdata);\r\n}\r\nstatic void xgbe_phy_phydev_flowctrl(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nu16 lcl_adv = 0, rmt_adv = 0;\r\nu8 fc;\r\npdata->phy.tx_pause = 0;\r\npdata->phy.rx_pause = 0;\r\nif (!phy_data->phydev)\r\nreturn;\r\nif (phy_data->phydev->advertising & ADVERTISED_Pause)\r\nlcl_adv |= ADVERTISE_PAUSE_CAP;\r\nif (phy_data->phydev->advertising & ADVERTISED_Asym_Pause)\r\nlcl_adv |= ADVERTISE_PAUSE_ASYM;\r\nif (phy_data->phydev->pause) {\r\npdata->phy.lp_advertising |= ADVERTISED_Pause;\r\nrmt_adv |= LPA_PAUSE_CAP;\r\n}\r\nif (phy_data->phydev->asym_pause) {\r\npdata->phy.lp_advertising |= ADVERTISED_Asym_Pause;\r\nrmt_adv |= LPA_PAUSE_ASYM;\r\n}\r\nfc = mii_resolve_flowctrl_fdx(lcl_adv, rmt_adv);\r\nif (fc & FLOW_CTRL_TX)\r\npdata->phy.tx_pause = 1;\r\nif (fc & FLOW_CTRL_RX)\r\npdata->phy.rx_pause = 1;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_an37_sgmii_outcome(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\npdata->phy.lp_advertising |= ADVERTISED_Autoneg;\r\npdata->phy.lp_advertising |= ADVERTISED_TP;\r\nif (pdata->phy.pause_autoneg)\r\nxgbe_phy_phydev_flowctrl(pdata);\r\nswitch (pdata->an_status & XGBE_SGMII_AN_LINK_SPEED) {\r\ncase XGBE_SGMII_AN_LINK_SPEED_100:\r\nif (pdata->an_status & XGBE_SGMII_AN_LINK_DUPLEX) {\r\npdata->phy.lp_advertising |= ADVERTISED_100baseT_Full;\r\nmode = XGBE_MODE_SGMII_100;\r\n} else {\r\npdata->phy.lp_advertising |= ADVERTISED_100baseT_Half;\r\nmode = XGBE_MODE_UNKNOWN;\r\n}\r\nbreak;\r\ncase XGBE_SGMII_AN_LINK_SPEED_1000:\r\nif (pdata->an_status & XGBE_SGMII_AN_LINK_DUPLEX) {\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseT_Full;\r\nmode = XGBE_MODE_SGMII_1000;\r\n} else {\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseT_Half;\r\nmode = XGBE_MODE_UNKNOWN;\r\n}\r\nbreak;\r\ndefault:\r\nmode = XGBE_MODE_UNKNOWN;\r\n}\r\nreturn mode;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_an37_outcome(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\nunsigned int ad_reg, lp_reg;\r\npdata->phy.lp_advertising |= ADVERTISED_Autoneg;\r\npdata->phy.lp_advertising |= ADVERTISED_FIBRE;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_ADVERTISE);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_LP_ABILITY);\r\nif (lp_reg & 0x100)\r\npdata->phy.lp_advertising |= ADVERTISED_Pause;\r\nif (lp_reg & 0x80)\r\npdata->phy.lp_advertising |= ADVERTISED_Asym_Pause;\r\nif (pdata->phy.pause_autoneg) {\r\npdata->phy.tx_pause = 0;\r\npdata->phy.rx_pause = 0;\r\nif (ad_reg & lp_reg & 0x100) {\r\npdata->phy.tx_pause = 1;\r\npdata->phy.rx_pause = 1;\r\n} else if (ad_reg & lp_reg & 0x80) {\r\nif (ad_reg & 0x100)\r\npdata->phy.rx_pause = 1;\r\nelse if (lp_reg & 0x100)\r\npdata->phy.tx_pause = 1;\r\n}\r\n}\r\nif (lp_reg & 0x40)\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseT_Half;\r\nif (lp_reg & 0x20)\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseT_Full;\r\nad_reg &= lp_reg;\r\nmode = (ad_reg & 0x20) ? XGBE_MODE_X : XGBE_MODE_UNKNOWN;\r\nreturn mode;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_an73_redrv_outcome(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nenum xgbe_mode mode;\r\nunsigned int ad_reg, lp_reg;\r\npdata->phy.lp_advertising |= ADVERTISED_Autoneg;\r\npdata->phy.lp_advertising |= ADVERTISED_Backplane;\r\nif (pdata->phy.pause_autoneg)\r\nxgbe_phy_phydev_flowctrl(pdata);\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 1);\r\nif (lp_reg & 0x80)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseKR_Full;\r\nif (lp_reg & 0x20)\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseKX_Full;\r\nad_reg &= lp_reg;\r\nif (ad_reg & 0x80) {\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nmode = XGBE_MODE_KR;\r\nbreak;\r\ndefault:\r\nmode = XGBE_MODE_SFI;\r\nbreak;\r\n}\r\n} else if (ad_reg & 0x20) {\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nmode = XGBE_MODE_KX_1000;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\nmode = XGBE_MODE_X;\r\nbreak;\r\ncase XGBE_PORT_MODE_SFP:\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\nif (phy_data->phydev &&\r\n(phy_data->phydev->speed == SPEED_100))\r\nmode = XGBE_MODE_SGMII_100;\r\nelse\r\nmode = XGBE_MODE_SGMII_1000;\r\nbreak;\r\ncase XGBE_SFP_BASE_1000_SX:\r\ncase XGBE_SFP_BASE_1000_LX:\r\ncase XGBE_SFP_BASE_1000_CX:\r\ndefault:\r\nmode = XGBE_MODE_X;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nif (phy_data->phydev &&\r\n(phy_data->phydev->speed == SPEED_100))\r\nmode = XGBE_MODE_SGMII_100;\r\nelse\r\nmode = XGBE_MODE_SGMII_1000;\r\nbreak;\r\n}\r\n} else {\r\nmode = XGBE_MODE_UNKNOWN;\r\n}\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 2);\r\nif (lp_reg & 0xc000)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseR_FEC;\r\nreturn mode;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_an73_outcome(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\nunsigned int ad_reg, lp_reg;\r\npdata->phy.lp_advertising |= ADVERTISED_Autoneg;\r\npdata->phy.lp_advertising |= ADVERTISED_Backplane;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA);\r\nif (lp_reg & 0x400)\r\npdata->phy.lp_advertising |= ADVERTISED_Pause;\r\nif (lp_reg & 0x800)\r\npdata->phy.lp_advertising |= ADVERTISED_Asym_Pause;\r\nif (pdata->phy.pause_autoneg) {\r\npdata->phy.tx_pause = 0;\r\npdata->phy.rx_pause = 0;\r\nif (ad_reg & lp_reg & 0x400) {\r\npdata->phy.tx_pause = 1;\r\npdata->phy.rx_pause = 1;\r\n} else if (ad_reg & lp_reg & 0x800) {\r\nif (ad_reg & 0x400)\r\npdata->phy.rx_pause = 1;\r\nelse if (lp_reg & 0x400)\r\npdata->phy.tx_pause = 1;\r\n}\r\n}\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 1);\r\nif (lp_reg & 0x80)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseKR_Full;\r\nif (lp_reg & 0x20)\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseKX_Full;\r\nad_reg &= lp_reg;\r\nif (ad_reg & 0x80)\r\nmode = XGBE_MODE_KR;\r\nelse if (ad_reg & 0x20)\r\nmode = XGBE_MODE_KX_1000;\r\nelse\r\nmode = XGBE_MODE_UNKNOWN;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 2);\r\nif (lp_reg & 0xc000)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseR_FEC;\r\nreturn mode;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_an_outcome(struct xgbe_prv_data *pdata)\r\n{\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\nreturn xgbe_phy_an73_outcome(pdata);\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nreturn xgbe_phy_an73_redrv_outcome(pdata);\r\ncase XGBE_AN_MODE_CL37:\r\nreturn xgbe_phy_an37_outcome(pdata);\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nreturn xgbe_phy_an37_sgmii_outcome(pdata);\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic unsigned int xgbe_phy_an_advertising(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int advertising;\r\nif (!phy_data->redrv)\r\nreturn pdata->phy.advertising;\r\nadvertising = pdata->phy.advertising;\r\nadvertising &= ~ADVERTISED_1000baseKX_Full;\r\nadvertising &= ~ADVERTISED_10000baseKR_Full;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nadvertising |= ADVERTISED_10000baseKR_Full;\r\nbreak;\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nadvertising |= ADVERTISED_1000baseKX_Full;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\nadvertising |= ADVERTISED_1000baseKX_Full;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nif (phy_data->phydev &&\r\n(phy_data->phydev->speed == SPEED_10000))\r\nadvertising |= ADVERTISED_10000baseKR_Full;\r\nelse\r\nadvertising |= ADVERTISED_1000baseKX_Full;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nadvertising |= ADVERTISED_10000baseKR_Full;\r\nbreak;\r\ncase XGBE_PORT_MODE_SFP:\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\ncase XGBE_SFP_BASE_1000_SX:\r\ncase XGBE_SFP_BASE_1000_LX:\r\ncase XGBE_SFP_BASE_1000_CX:\r\nadvertising |= ADVERTISED_1000baseKX_Full;\r\nbreak;\r\ndefault:\r\nadvertising |= ADVERTISED_10000baseKR_Full;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nadvertising |= ADVERTISED_10000baseKR_Full;\r\nbreak;\r\n}\r\nreturn advertising;\r\n}\r\nstatic int xgbe_phy_an_config(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nret = xgbe_phy_find_phy_device(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (!phy_data->phydev)\r\nreturn 0;\r\nphy_data->phydev->autoneg = pdata->phy.autoneg;\r\nphy_data->phydev->advertising = phy_data->phydev->supported &\r\npdata->phy.advertising;\r\nif (pdata->phy.autoneg != AUTONEG_ENABLE) {\r\nphy_data->phydev->speed = pdata->phy.speed;\r\nphy_data->phydev->duplex = pdata->phy.duplex;\r\n}\r\nret = phy_start_aneg(phy_data->phydev);\r\nreturn ret;\r\n}\r\nstatic enum xgbe_an_mode xgbe_phy_an_sfp_mode(struct xgbe_phy_data *phy_data)\r\n{\r\nswitch (phy_data->sfp_base) {\r\ncase XGBE_SFP_BASE_1000_T:\r\nreturn XGBE_AN_MODE_CL37_SGMII;\r\ncase XGBE_SFP_BASE_1000_SX:\r\ncase XGBE_SFP_BASE_1000_LX:\r\ncase XGBE_SFP_BASE_1000_CX:\r\nreturn XGBE_AN_MODE_CL37;\r\ndefault:\r\nreturn XGBE_AN_MODE_NONE;\r\n}\r\n}\r\nstatic enum xgbe_an_mode xgbe_phy_an_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (phy_data->redrv)\r\nreturn XGBE_AN_MODE_CL73_REDRV;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nreturn XGBE_AN_MODE_CL73;\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nreturn XGBE_AN_MODE_NONE;\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\nreturn XGBE_AN_MODE_CL37_SGMII;\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\nreturn XGBE_AN_MODE_CL37;\r\ncase XGBE_PORT_MODE_NBASE_T:\r\nreturn XGBE_AN_MODE_CL37_SGMII;\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nreturn XGBE_AN_MODE_CL73;\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nreturn XGBE_AN_MODE_NONE;\r\ncase XGBE_PORT_MODE_SFP:\r\nreturn xgbe_phy_an_sfp_mode(phy_data);\r\ndefault:\r\nreturn XGBE_AN_MODE_NONE;\r\n}\r\n}\r\nstatic int xgbe_phy_set_redrv_mode_mdio(struct xgbe_prv_data *pdata,\r\nenum xgbe_phy_redrv_mode mode)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nu16 redrv_reg, redrv_val;\r\nredrv_reg = XGBE_PHY_REDRV_MODE_REG + (phy_data->redrv_lane * 0x1000);\r\nredrv_val = (u16)mode;\r\nreturn pdata->hw_if.write_ext_mii_regs(pdata, phy_data->redrv_addr,\r\nredrv_reg, redrv_val);\r\n}\r\nstatic int xgbe_phy_set_redrv_mode_i2c(struct xgbe_prv_data *pdata,\r\nenum xgbe_phy_redrv_mode mode)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int redrv_reg;\r\nint ret;\r\nredrv_reg = XGBE_PHY_REDRV_MODE_REG + (phy_data->redrv_lane * 0x1000);\r\nret = xgbe_phy_redrv_write(pdata, redrv_reg, mode);\r\nreturn ret;\r\n}\r\nstatic void xgbe_phy_set_redrv_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nenum xgbe_phy_redrv_mode mode;\r\nint ret;\r\nif (!phy_data->redrv)\r\nreturn;\r\nmode = XGBE_PHY_REDRV_MODE_CX;\r\nif ((phy_data->port_mode == XGBE_PORT_MODE_SFP) &&\r\n(phy_data->sfp_base != XGBE_SFP_BASE_1000_CX) &&\r\n(phy_data->sfp_base != XGBE_SFP_BASE_10000_CR))\r\nmode = XGBE_PHY_REDRV_MODE_SR;\r\nret = xgbe_phy_get_comm_ownership(pdata);\r\nif (ret)\r\nreturn;\r\nif (phy_data->redrv_if)\r\nxgbe_phy_set_redrv_mode_i2c(pdata, mode);\r\nelse\r\nxgbe_phy_set_redrv_mode_mdio(pdata, mode);\r\nxgbe_phy_put_comm_ownership(pdata);\r\n}\r\nstatic void xgbe_phy_start_ratechange(struct xgbe_prv_data *pdata)\r\n{\r\nif (!XP_IOREAD_BITS(pdata, XP_DRIVER_INT_RO, STATUS))\r\nreturn;\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"firmware mailbox not ready for command\n");\r\n}\r\nstatic void xgbe_phy_complete_ratechange(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int wait;\r\nwait = XGBE_RATECHANGE_COUNT;\r\nwhile (wait--) {\r\nif (!XP_IOREAD_BITS(pdata, XP_DRIVER_INT_RO, STATUS))\r\nreturn;\r\nusleep_range(1000, 2000);\r\n}\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"firmware mailbox command did not complete\n");\r\n}\r\nstatic void xgbe_phy_rrc(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int s0;\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 5);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "receiver reset complete\n");\r\n}\r\nstatic void xgbe_phy_power_off(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nxgbe_phy_start_ratechange(pdata);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, 0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_UNKNOWN;\r\nnetif_dbg(pdata, link, pdata->netdev, "phy powered off\n");\r\n}\r\nstatic void xgbe_phy_sfi_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 3);\r\nif (phy_data->sfp_cable != XGBE_SFP_CABLE_PASSIVE) {\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 0);\r\n} else {\r\nif (phy_data->sfp_cable_len <= 1)\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 1);\r\nelse if (phy_data->sfp_cable_len <= 3)\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 2);\r\nelse\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 3);\r\n}\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_SFI;\r\nnetif_dbg(pdata, link, pdata->netdev, "10GbE SFI mode set\n");\r\n}\r\nstatic void xgbe_phy_x_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 1);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 3);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_X;\r\nnetif_dbg(pdata, link, pdata->netdev, "1GbE X mode set\n");\r\n}\r\nstatic void xgbe_phy_sgmii_1000_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 1);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 2);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_SGMII_1000;\r\nnetif_dbg(pdata, link, pdata->netdev, "1GbE SGMII mode set\n");\r\n}\r\nstatic void xgbe_phy_sgmii_100_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 1);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 1);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_SGMII_100;\r\nnetif_dbg(pdata, link, pdata->netdev, "100MbE SGMII mode set\n");\r\n}\r\nstatic void xgbe_phy_kr_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 4);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_KR;\r\nnetif_dbg(pdata, link, pdata->netdev, "10GbE KR mode set\n");\r\n}\r\nstatic void xgbe_phy_kx_2500_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 2);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_KX_2500;\r\nnetif_dbg(pdata, link, pdata->netdev, "2.5GbE KX mode set\n");\r\n}\r\nstatic void xgbe_phy_kx_1000_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int s0;\r\nxgbe_phy_set_redrv_mode(pdata);\r\nxgbe_phy_start_ratechange(pdata);\r\ns0 = 0;\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, COMMAND, 1);\r\nXP_SET_BITS(s0, XP_DRIVER_SCRATCH_0, SUB_COMMAND, 3);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_0, s0);\r\nXP_IOWRITE(pdata, XP_DRIVER_SCRATCH_1, 0);\r\nXP_IOWRITE_BITS(pdata, XP_DRIVER_INT_REQ, REQUEST, 1);\r\nxgbe_phy_complete_ratechange(pdata);\r\nphy_data->cur_mode = XGBE_MODE_KX_1000;\r\nnetif_dbg(pdata, link, pdata->netdev, "1GbE KX mode set\n");\r\n}\r\nstatic enum xgbe_mode xgbe_phy_cur_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nreturn phy_data->cur_mode;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_switch_baset_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nif (phy_data->port_mode != XGBE_PORT_MODE_10GBASE_T)\r\nreturn xgbe_phy_cur_mode(pdata);\r\nswitch (xgbe_phy_cur_mode(pdata)) {\r\ncase XGBE_MODE_SGMII_100:\r\ncase XGBE_MODE_SGMII_1000:\r\nreturn XGBE_MODE_KR;\r\ncase XGBE_MODE_KR:\r\ndefault:\r\nreturn XGBE_MODE_SGMII_1000;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_switch_bp_2500_mode(struct xgbe_prv_data *pdata)\r\n{\r\nreturn XGBE_MODE_KX_2500;\r\n}\r\nstatic enum xgbe_mode xgbe_phy_switch_bp_mode(struct xgbe_prv_data *pdata)\r\n{\r\nswitch (xgbe_phy_cur_mode(pdata)) {\r\ncase XGBE_MODE_KX_1000:\r\nreturn XGBE_MODE_KR;\r\ncase XGBE_MODE_KR:\r\ndefault:\r\nreturn XGBE_MODE_KX_1000;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_switch_mode(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nreturn xgbe_phy_switch_bp_mode(pdata);\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nreturn xgbe_phy_switch_bp_2500_mode(pdata);\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nreturn xgbe_phy_switch_baset_mode(pdata);\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\ncase XGBE_PORT_MODE_SFP:\r\nreturn xgbe_phy_cur_mode(pdata);\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_basex_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_1000:\r\nreturn XGBE_MODE_X;\r\ncase SPEED_10000:\r\nreturn XGBE_MODE_KR;\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_baset_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_100:\r\nreturn XGBE_MODE_SGMII_100;\r\ncase SPEED_1000:\r\nreturn XGBE_MODE_SGMII_1000;\r\ncase SPEED_10000:\r\nreturn XGBE_MODE_KR;\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_sfp_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_100:\r\nreturn XGBE_MODE_SGMII_100;\r\ncase SPEED_1000:\r\nif (phy_data->sfp_base == XGBE_SFP_BASE_1000_T)\r\nreturn XGBE_MODE_SGMII_1000;\r\nelse\r\nreturn XGBE_MODE_X;\r\ncase SPEED_10000:\r\ncase SPEED_UNKNOWN:\r\nreturn XGBE_MODE_SFI;\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_bp_2500_mode(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_2500:\r\nreturn XGBE_MODE_KX_2500;\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_bp_mode(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_1000:\r\nreturn XGBE_MODE_KX_1000;\r\ncase SPEED_10000:\r\nreturn XGBE_MODE_KR;\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_get_mode(struct xgbe_prv_data *pdata,\r\nint speed)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nreturn xgbe_phy_get_bp_mode(speed);\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nreturn xgbe_phy_get_bp_2500_mode(speed);\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nreturn xgbe_phy_get_baset_mode(phy_data, speed);\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nreturn xgbe_phy_get_basex_mode(phy_data, speed);\r\ncase XGBE_PORT_MODE_SFP:\r\nreturn xgbe_phy_get_sfp_mode(phy_data, speed);\r\ndefault:\r\nreturn XGBE_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic void xgbe_phy_set_mode(struct xgbe_prv_data *pdata, enum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_KX_1000:\r\nxgbe_phy_kx_1000_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_KX_2500:\r\nxgbe_phy_kx_2500_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_KR:\r\nxgbe_phy_kr_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SGMII_100:\r\nxgbe_phy_sgmii_100_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SGMII_1000:\r\nxgbe_phy_sgmii_1000_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_X:\r\nxgbe_phy_x_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SFI:\r\nxgbe_phy_sfi_mode(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic bool xgbe_phy_check_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode, u32 advert)\r\n{\r\nif (pdata->phy.autoneg == AUTONEG_ENABLE) {\r\nif (pdata->phy.advertising & advert)\r\nreturn true;\r\n} else {\r\nenum xgbe_mode cur_mode;\r\ncur_mode = xgbe_phy_get_mode(pdata, pdata->phy.speed);\r\nif (cur_mode == mode)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool xgbe_phy_use_basex_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_X:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_1000baseT_Full);\r\ncase XGBE_MODE_KR:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_10000baseT_Full);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_use_baset_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_SGMII_100:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_100baseT_Full);\r\ncase XGBE_MODE_SGMII_1000:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_1000baseT_Full);\r\ncase XGBE_MODE_KR:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_10000baseT_Full);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_use_sfp_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (mode) {\r\ncase XGBE_MODE_X:\r\nif (phy_data->sfp_base == XGBE_SFP_BASE_1000_T)\r\nreturn false;\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_1000baseT_Full);\r\ncase XGBE_MODE_SGMII_100:\r\nif (phy_data->sfp_base != XGBE_SFP_BASE_1000_T)\r\nreturn false;\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_100baseT_Full);\r\ncase XGBE_MODE_SGMII_1000:\r\nif (phy_data->sfp_base != XGBE_SFP_BASE_1000_T)\r\nreturn false;\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_1000baseT_Full);\r\ncase XGBE_MODE_SFI:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_10000baseT_Full);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_use_bp_2500_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_KX_2500:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_2500baseX_Full);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_use_bp_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_KX_1000:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_1000baseKX_Full);\r\ncase XGBE_MODE_KR:\r\nreturn xgbe_phy_check_mode(pdata, mode,\r\nADVERTISED_10000baseKR_Full);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_use_mode(struct xgbe_prv_data *pdata, enum xgbe_mode mode)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nreturn xgbe_phy_use_bp_mode(pdata, mode);\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nreturn xgbe_phy_use_bp_2500_mode(pdata, mode);\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nreturn xgbe_phy_use_baset_mode(pdata, mode);\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nreturn xgbe_phy_use_basex_mode(pdata, mode);\r\ncase XGBE_PORT_MODE_SFP:\r\nreturn xgbe_phy_use_sfp_mode(pdata, mode);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed_basex_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_1000:\r\nreturn (phy_data->port_mode == XGBE_PORT_MODE_1000BASE_X);\r\ncase SPEED_10000:\r\nreturn (phy_data->port_mode == XGBE_PORT_MODE_10GBASE_R);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed_baset_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_100:\r\ncase SPEED_1000:\r\nreturn true;\r\ncase SPEED_10000:\r\nreturn (phy_data->port_mode == XGBE_PORT_MODE_10GBASE_T);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed_sfp_mode(struct xgbe_phy_data *phy_data,\r\nint speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_100:\r\nreturn (phy_data->sfp_speed == XGBE_SFP_SPEED_100_1000);\r\ncase SPEED_1000:\r\nreturn ((phy_data->sfp_speed == XGBE_SFP_SPEED_100_1000) ||\r\n(phy_data->sfp_speed == XGBE_SFP_SPEED_1000));\r\ncase SPEED_10000:\r\nreturn (phy_data->sfp_speed == XGBE_SFP_SPEED_10000);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed_bp_2500_mode(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_2500:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed_bp_mode(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_1000:\r\ncase SPEED_10000:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool xgbe_phy_valid_speed(struct xgbe_prv_data *pdata, int speed)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nreturn xgbe_phy_valid_speed_bp_mode(speed);\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nreturn xgbe_phy_valid_speed_bp_2500_mode(speed);\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nreturn xgbe_phy_valid_speed_baset_mode(phy_data, speed);\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nreturn xgbe_phy_valid_speed_basex_mode(phy_data, speed);\r\ncase XGBE_PORT_MODE_SFP:\r\nreturn xgbe_phy_valid_speed_sfp_mode(phy_data, speed);\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int xgbe_phy_link_status(struct xgbe_prv_data *pdata, int *an_restart)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int reg;\r\nint ret;\r\n*an_restart = 0;\r\nif (phy_data->port_mode == XGBE_PORT_MODE_SFP) {\r\nxgbe_phy_sfp_detect(pdata);\r\nif (phy_data->sfp_changed) {\r\n*an_restart = 1;\r\nreturn 0;\r\n}\r\nif (phy_data->sfp_mod_absent || phy_data->sfp_rx_los)\r\nreturn 0;\r\n}\r\nif (phy_data->phydev) {\r\nret = phy_read_status(phy_data->phydev);\r\nif (ret < 0)\r\nreturn 0;\r\nif ((pdata->phy.autoneg == AUTONEG_ENABLE) &&\r\n!phy_aneg_done(phy_data->phydev))\r\nreturn 0;\r\nif (!phy_data->phydev->link)\r\nreturn 0;\r\n}\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);\r\nif (reg & MDIO_STAT1_LSTATUS)\r\nreturn 1;\r\nif (phy_data->rrc_count++) {\r\nphy_data->rrc_count = 0;\r\nxgbe_phy_rrc(pdata);\r\n}\r\nreturn 0;\r\n}\r\nstatic void xgbe_phy_sfp_gpio_setup(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int reg;\r\nreg = XP_IOREAD(pdata, XP_PROP_3);\r\nphy_data->sfp_gpio_address = XGBE_GPIO_ADDRESS_PCA9555 +\r\nXP_GET_BITS(reg, XP_PROP_3, GPIO_ADDR);\r\nphy_data->sfp_gpio_mask = XP_GET_BITS(reg, XP_PROP_3, GPIO_MASK);\r\nphy_data->sfp_gpio_rx_los = XP_GET_BITS(reg, XP_PROP_3,\r\nGPIO_RX_LOS);\r\nphy_data->sfp_gpio_tx_fault = XP_GET_BITS(reg, XP_PROP_3,\r\nGPIO_TX_FAULT);\r\nphy_data->sfp_gpio_mod_absent = XP_GET_BITS(reg, XP_PROP_3,\r\nGPIO_MOD_ABS);\r\nphy_data->sfp_gpio_rate_select = XP_GET_BITS(reg, XP_PROP_3,\r\nGPIO_RATE_SELECT);\r\nif (netif_msg_probe(pdata)) {\r\ndev_dbg(pdata->dev, "SFP: gpio_address=%#x\n",\r\nphy_data->sfp_gpio_address);\r\ndev_dbg(pdata->dev, "SFP: gpio_mask=%#x\n",\r\nphy_data->sfp_gpio_mask);\r\ndev_dbg(pdata->dev, "SFP: gpio_rx_los=%u\n",\r\nphy_data->sfp_gpio_rx_los);\r\ndev_dbg(pdata->dev, "SFP: gpio_tx_fault=%u\n",\r\nphy_data->sfp_gpio_tx_fault);\r\ndev_dbg(pdata->dev, "SFP: gpio_mod_absent=%u\n",\r\nphy_data->sfp_gpio_mod_absent);\r\ndev_dbg(pdata->dev, "SFP: gpio_rate_select=%u\n",\r\nphy_data->sfp_gpio_rate_select);\r\n}\r\n}\r\nstatic void xgbe_phy_sfp_comm_setup(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int reg, mux_addr_hi, mux_addr_lo;\r\nreg = XP_IOREAD(pdata, XP_PROP_4);\r\nmux_addr_hi = XP_GET_BITS(reg, XP_PROP_4, MUX_ADDR_HI);\r\nmux_addr_lo = XP_GET_BITS(reg, XP_PROP_4, MUX_ADDR_LO);\r\nif (mux_addr_lo == XGBE_SFP_DIRECT)\r\nreturn;\r\nphy_data->sfp_comm = XGBE_SFP_COMM_PCA9545;\r\nphy_data->sfp_mux_address = (mux_addr_hi << 2) + mux_addr_lo;\r\nphy_data->sfp_mux_channel = XP_GET_BITS(reg, XP_PROP_4, MUX_CHAN);\r\nif (netif_msg_probe(pdata)) {\r\ndev_dbg(pdata->dev, "SFP: mux_address=%#x\n",\r\nphy_data->sfp_mux_address);\r\ndev_dbg(pdata->dev, "SFP: mux_channel=%u\n",\r\nphy_data->sfp_mux_channel);\r\n}\r\n}\r\nstatic void xgbe_phy_sfp_setup(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_phy_sfp_comm_setup(pdata);\r\nxgbe_phy_sfp_gpio_setup(pdata);\r\n}\r\nstatic int xgbe_phy_int_mdio_reset(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int ret;\r\nret = pdata->hw_if.set_gpio(pdata, phy_data->mdio_reset_gpio);\r\nif (ret)\r\nreturn ret;\r\nret = pdata->hw_if.clr_gpio(pdata, phy_data->mdio_reset_gpio);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_i2c_mdio_reset(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nu8 gpio_reg, gpio_ports[2], gpio_data[3];\r\nint ret;\r\ngpio_reg = 2;\r\nret = xgbe_phy_i2c_read(pdata, phy_data->mdio_reset_addr,\r\n&gpio_reg, sizeof(gpio_reg),\r\ngpio_ports, sizeof(gpio_ports));\r\nif (ret)\r\nreturn ret;\r\ngpio_data[0] = 2;\r\ngpio_data[1] = gpio_ports[0];\r\ngpio_data[2] = gpio_ports[1];\r\nif (phy_data->mdio_reset_gpio < 8)\r\ngpio_data[1] |= (1 << (phy_data->mdio_reset_gpio % 8));\r\nelse\r\ngpio_data[2] |= (1 << (phy_data->mdio_reset_gpio % 8));\r\nret = xgbe_phy_i2c_write(pdata, phy_data->mdio_reset_addr,\r\ngpio_data, sizeof(gpio_data));\r\nif (ret)\r\nreturn ret;\r\nif (phy_data->mdio_reset_gpio < 8)\r\ngpio_data[1] &= ~(1 << (phy_data->mdio_reset_gpio % 8));\r\nelse\r\ngpio_data[2] &= ~(1 << (phy_data->mdio_reset_gpio % 8));\r\nret = xgbe_phy_i2c_write(pdata, phy_data->mdio_reset_addr,\r\ngpio_data, sizeof(gpio_data));\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_mdio_reset(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nif (phy_data->conn_type != XGBE_CONN_TYPE_MDIO)\r\nreturn 0;\r\nret = xgbe_phy_get_comm_ownership(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (phy_data->mdio_reset == XGBE_MDIO_RESET_I2C_GPIO)\r\nret = xgbe_phy_i2c_mdio_reset(pdata);\r\nelse if (phy_data->mdio_reset == XGBE_MDIO_RESET_INT_GPIO)\r\nret = xgbe_phy_int_mdio_reset(pdata);\r\nxgbe_phy_put_comm_ownership(pdata);\r\nreturn ret;\r\n}\r\nstatic bool xgbe_phy_redrv_error(struct xgbe_phy_data *phy_data)\r\n{\r\nif (!phy_data->redrv)\r\nreturn false;\r\nif (phy_data->redrv_if >= XGBE_PHY_REDRV_IF_MAX)\r\nreturn true;\r\nswitch (phy_data->redrv_model) {\r\ncase XGBE_PHY_REDRV_MODEL_4223:\r\nif (phy_data->redrv_lane > 3)\r\nreturn true;\r\nbreak;\r\ncase XGBE_PHY_REDRV_MODEL_4227:\r\nif (phy_data->redrv_lane > 1)\r\nreturn true;\r\nbreak;\r\ndefault:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int xgbe_phy_mdio_reset_setup(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nunsigned int reg;\r\nif (phy_data->conn_type != XGBE_CONN_TYPE_MDIO)\r\nreturn 0;\r\nreg = XP_IOREAD(pdata, XP_PROP_3);\r\nphy_data->mdio_reset = XP_GET_BITS(reg, XP_PROP_3, MDIO_RESET);\r\nswitch (phy_data->mdio_reset) {\r\ncase XGBE_MDIO_RESET_NONE:\r\ncase XGBE_MDIO_RESET_I2C_GPIO:\r\ncase XGBE_MDIO_RESET_INT_GPIO:\r\nbreak;\r\ndefault:\r\ndev_err(pdata->dev, "unsupported MDIO reset (%#x)\n",\r\nphy_data->mdio_reset);\r\nreturn -EINVAL;\r\n}\r\nif (phy_data->mdio_reset == XGBE_MDIO_RESET_I2C_GPIO) {\r\nphy_data->mdio_reset_addr = XGBE_GPIO_ADDRESS_PCA9555 +\r\nXP_GET_BITS(reg, XP_PROP_3,\r\nMDIO_RESET_I2C_ADDR);\r\nphy_data->mdio_reset_gpio = XP_GET_BITS(reg, XP_PROP_3,\r\nMDIO_RESET_I2C_GPIO);\r\n} else if (phy_data->mdio_reset == XGBE_MDIO_RESET_INT_GPIO) {\r\nphy_data->mdio_reset_gpio = XP_GET_BITS(reg, XP_PROP_3,\r\nMDIO_RESET_INT_GPIO);\r\n}\r\nreturn 0;\r\n}\r\nstatic bool xgbe_phy_port_mode_mismatch(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\nif ((phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000))\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_2500)\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\nif ((phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000))\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000)\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_NBASE_T:\r\nif ((phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_2500))\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\nif ((phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000))\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000)\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_SFP:\r\nif ((phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) ||\r\n(phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000))\r\nreturn false;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn true;\r\n}\r\nstatic bool xgbe_phy_conn_type_mismatch(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\nif (phy_data->conn_type == XGBE_CONN_TYPE_BACKPLANE)\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\ncase XGBE_PORT_MODE_NBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\nif (phy_data->conn_type == XGBE_CONN_TYPE_MDIO)\r\nreturn false;\r\nbreak;\r\ncase XGBE_PORT_MODE_SFP:\r\nif (phy_data->conn_type == XGBE_CONN_TYPE_SFP)\r\nreturn false;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn true;\r\n}\r\nstatic bool xgbe_phy_port_enabled(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XP_IOREAD(pdata, XP_PROP_0);\r\nif (!XP_GET_BITS(reg, XP_PROP_0, PORT_SPEEDS))\r\nreturn false;\r\nif (!XP_GET_BITS(reg, XP_PROP_0, CONN_TYPE))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void xgbe_phy_stop(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nxgbe_phy_free_phy_device(pdata);\r\nxgbe_phy_sfp_reset(phy_data);\r\nxgbe_phy_sfp_mod_absent(pdata);\r\nxgbe_phy_power_off(pdata);\r\npdata->i2c_if.i2c_stop(pdata);\r\n}\r\nstatic int xgbe_phy_start(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nint ret;\r\nret = pdata->i2c_if.i2c_start(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (phy_data->redrv && !phy_data->redrv_if) {\r\nret = pdata->hw_if.set_ext_mii_mode(pdata, phy_data->redrv_addr,\r\nXGBE_MDIO_MODE_CL22);\r\nif (ret) {\r\nnetdev_err(pdata->netdev,\r\n"redriver mdio port not compatible (%u)\n",\r\nphy_data->redrv_addr);\r\nreturn ret;\r\n}\r\n}\r\nxgbe_phy_set_mode(pdata, phy_data->start_mode);\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_SFP:\r\nxgbe_phy_sfp_detect(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nret = xgbe_phy_find_phy_device(pdata);\r\nif (ret)\r\ngoto err_i2c;\r\nreturn 0;\r\nerr_i2c:\r\npdata->i2c_if.i2c_stop(pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_reset(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nenum xgbe_mode cur_mode;\r\nint ret;\r\ncur_mode = phy_data->cur_mode;\r\nxgbe_phy_power_off(pdata);\r\nxgbe_phy_set_mode(pdata, cur_mode);\r\nif (!phy_data->phydev)\r\nreturn 0;\r\nret = xgbe_phy_mdio_reset(pdata);\r\nif (ret)\r\nreturn ret;\r\nreturn phy_init_hw(phy_data->phydev);\r\n}\r\nstatic void xgbe_phy_exit(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data = pdata->phy_data;\r\nmdiobus_unregister(phy_data->mii);\r\n}\r\nstatic int xgbe_phy_init(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_phy_data *phy_data;\r\nstruct mii_bus *mii;\r\nunsigned int reg;\r\nint ret;\r\nif (!xgbe_phy_port_enabled(pdata)) {\r\ndev_info(pdata->dev, "device is not enabled\n");\r\nreturn -ENODEV;\r\n}\r\nret = pdata->i2c_if.i2c_init(pdata);\r\nif (ret)\r\nreturn ret;\r\nphy_data = devm_kzalloc(pdata->dev, sizeof(*phy_data), GFP_KERNEL);\r\nif (!phy_data)\r\nreturn -ENOMEM;\r\npdata->phy_data = phy_data;\r\nreg = XP_IOREAD(pdata, XP_PROP_0);\r\nphy_data->port_mode = XP_GET_BITS(reg, XP_PROP_0, PORT_MODE);\r\nphy_data->port_id = XP_GET_BITS(reg, XP_PROP_0, PORT_ID);\r\nphy_data->port_speeds = XP_GET_BITS(reg, XP_PROP_0, PORT_SPEEDS);\r\nphy_data->conn_type = XP_GET_BITS(reg, XP_PROP_0, CONN_TYPE);\r\nphy_data->mdio_addr = XP_GET_BITS(reg, XP_PROP_0, MDIO_ADDR);\r\nif (netif_msg_probe(pdata)) {\r\ndev_dbg(pdata->dev, "port mode=%u\n", phy_data->port_mode);\r\ndev_dbg(pdata->dev, "port id=%u\n", phy_data->port_id);\r\ndev_dbg(pdata->dev, "port speeds=%#x\n", phy_data->port_speeds);\r\ndev_dbg(pdata->dev, "conn type=%u\n", phy_data->conn_type);\r\ndev_dbg(pdata->dev, "mdio addr=%u\n", phy_data->mdio_addr);\r\n}\r\nreg = XP_IOREAD(pdata, XP_PROP_4);\r\nphy_data->redrv = XP_GET_BITS(reg, XP_PROP_4, REDRV_PRESENT);\r\nphy_data->redrv_if = XP_GET_BITS(reg, XP_PROP_4, REDRV_IF);\r\nphy_data->redrv_addr = XP_GET_BITS(reg, XP_PROP_4, REDRV_ADDR);\r\nphy_data->redrv_lane = XP_GET_BITS(reg, XP_PROP_4, REDRV_LANE);\r\nphy_data->redrv_model = XP_GET_BITS(reg, XP_PROP_4, REDRV_MODEL);\r\nif (phy_data->redrv && netif_msg_probe(pdata)) {\r\ndev_dbg(pdata->dev, "redrv present\n");\r\ndev_dbg(pdata->dev, "redrv i/f=%u\n", phy_data->redrv_if);\r\ndev_dbg(pdata->dev, "redrv addr=%#x\n", phy_data->redrv_addr);\r\ndev_dbg(pdata->dev, "redrv lane=%u\n", phy_data->redrv_lane);\r\ndev_dbg(pdata->dev, "redrv model=%u\n", phy_data->redrv_model);\r\n}\r\nif (xgbe_phy_conn_type_mismatch(pdata)) {\r\ndev_err(pdata->dev, "phy mode/connection mismatch (%#x/%#x)\n",\r\nphy_data->port_mode, phy_data->conn_type);\r\nreturn -EINVAL;\r\n}\r\nif (xgbe_phy_port_mode_mismatch(pdata)) {\r\ndev_err(pdata->dev, "phy mode/speed mismatch (%#x/%#x)\n",\r\nphy_data->port_mode, phy_data->port_speeds);\r\nreturn -EINVAL;\r\n}\r\nret = xgbe_phy_mdio_reset_setup(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (xgbe_phy_redrv_error(phy_data)) {\r\ndev_err(pdata->dev, "phy re-driver settings error\n");\r\nreturn -EINVAL;\r\n}\r\npdata->kr_redrv = phy_data->redrv;\r\nphy_data->cur_mode = XGBE_MODE_UNKNOWN;\r\npdata->phy.supported = 0;\r\nswitch (phy_data->port_mode) {\r\ncase XGBE_PORT_MODE_BACKPLANE:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_Backplane;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) {\r\npdata->phy.supported |= SUPPORTED_1000baseKX_Full;\r\nphy_data->start_mode = XGBE_MODE_KX_1000;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000) {\r\npdata->phy.supported |= SUPPORTED_10000baseKR_Full;\r\nif (pdata->fec_ability & MDIO_PMA_10GBR_FECABLE_ABLE)\r\npdata->phy.supported |=\r\nSUPPORTED_10000baseR_FEC;\r\nphy_data->start_mode = XGBE_MODE_KR;\r\n}\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_NONE;\r\nbreak;\r\ncase XGBE_PORT_MODE_BACKPLANE_2500:\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_Backplane;\r\npdata->phy.supported |= SUPPORTED_2500baseX_Full;\r\nphy_data->start_mode = XGBE_MODE_KX_2500;\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_NONE;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_T:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_TP;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) {\r\npdata->phy.supported |= SUPPORTED_100baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_100;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) {\r\npdata->phy.supported |= SUPPORTED_1000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_1000;\r\n}\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_CL22;\r\nbreak;\r\ncase XGBE_PORT_MODE_1000BASE_X:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_FIBRE;\r\npdata->phy.supported |= SUPPORTED_1000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_X;\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_CL22;\r\nbreak;\r\ncase XGBE_PORT_MODE_NBASE_T:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_TP;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) {\r\npdata->phy.supported |= SUPPORTED_100baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_100;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) {\r\npdata->phy.supported |= SUPPORTED_1000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_1000;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_2500) {\r\npdata->phy.supported |= SUPPORTED_2500baseX_Full;\r\nphy_data->start_mode = XGBE_MODE_KX_2500;\r\n}\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_CL45;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_T:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_TP;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) {\r\npdata->phy.supported |= SUPPORTED_100baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_100;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) {\r\npdata->phy.supported |= SUPPORTED_1000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_1000;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000) {\r\npdata->phy.supported |= SUPPORTED_10000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_KR;\r\n}\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_NONE;\r\nbreak;\r\ncase XGBE_PORT_MODE_10GBASE_R:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_TP;\r\npdata->phy.supported |= SUPPORTED_10000baseT_Full;\r\nif (pdata->fec_ability & MDIO_PMA_10GBR_FECABLE_ABLE)\r\npdata->phy.supported |= SUPPORTED_10000baseR_FEC;\r\nphy_data->start_mode = XGBE_MODE_SFI;\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_NONE;\r\nbreak;\r\ncase XGBE_PORT_MODE_SFP:\r\npdata->phy.supported |= SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_TP;\r\npdata->phy.supported |= SUPPORTED_FIBRE;\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_100) {\r\npdata->phy.supported |= SUPPORTED_100baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_100;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_1000) {\r\npdata->phy.supported |= SUPPORTED_1000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SGMII_1000;\r\n}\r\nif (phy_data->port_speeds & XGBE_PHY_PORT_SPEED_10000) {\r\npdata->phy.supported |= SUPPORTED_10000baseT_Full;\r\nphy_data->start_mode = XGBE_MODE_SFI;\r\nif (pdata->fec_ability & MDIO_PMA_10GBR_FECABLE_ABLE)\r\npdata->phy.supported |=\r\nSUPPORTED_10000baseR_FEC;\r\n}\r\nphy_data->phydev_mode = XGBE_MDIO_MODE_CL22;\r\nxgbe_phy_sfp_setup(pdata);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(pdata->dev, "phy supported=%#x\n",\r\npdata->phy.supported);\r\nif ((phy_data->conn_type & XGBE_CONN_TYPE_MDIO) &&\r\n(phy_data->phydev_mode != XGBE_MDIO_MODE_NONE)) {\r\nret = pdata->hw_if.set_ext_mii_mode(pdata, phy_data->mdio_addr,\r\nphy_data->phydev_mode);\r\nif (ret) {\r\ndev_err(pdata->dev,\r\n"mdio port/clause not compatible (%d/%u)\n",\r\nphy_data->mdio_addr, phy_data->phydev_mode);\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (phy_data->redrv && !phy_data->redrv_if) {\r\nret = pdata->hw_if.set_ext_mii_mode(pdata, phy_data->redrv_addr,\r\nXGBE_MDIO_MODE_CL22);\r\nif (ret) {\r\ndev_err(pdata->dev,\r\n"redriver mdio port not compatible (%u)\n",\r\nphy_data->redrv_addr);\r\nreturn -EINVAL;\r\n}\r\n}\r\nmii = devm_mdiobus_alloc(pdata->dev);\r\nif (!mii) {\r\ndev_err(pdata->dev, "mdiobus_alloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\nmii->priv = pdata;\r\nmii->name = "amd-xgbe-mii";\r\nmii->read = xgbe_phy_mii_read;\r\nmii->write = xgbe_phy_mii_write;\r\nmii->parent = pdata->dev;\r\nmii->phy_mask = ~0;\r\nsnprintf(mii->id, sizeof(mii->id), "%s", dev_name(pdata->dev));\r\nret = mdiobus_register(mii);\r\nif (ret) {\r\ndev_err(pdata->dev, "mdiobus_register failed\n");\r\nreturn ret;\r\n}\r\nphy_data->mii = mii;\r\nreturn 0;\r\n}\r\nvoid xgbe_init_function_ptrs_phy_v2(struct xgbe_phy_if *phy_if)\r\n{\r\nstruct xgbe_phy_impl_if *phy_impl = &phy_if->phy_impl;\r\nphy_impl->init = xgbe_phy_init;\r\nphy_impl->exit = xgbe_phy_exit;\r\nphy_impl->reset = xgbe_phy_reset;\r\nphy_impl->start = xgbe_phy_start;\r\nphy_impl->stop = xgbe_phy_stop;\r\nphy_impl->link_status = xgbe_phy_link_status;\r\nphy_impl->valid_speed = xgbe_phy_valid_speed;\r\nphy_impl->use_mode = xgbe_phy_use_mode;\r\nphy_impl->set_mode = xgbe_phy_set_mode;\r\nphy_impl->get_mode = xgbe_phy_get_mode;\r\nphy_impl->switch_mode = xgbe_phy_switch_mode;\r\nphy_impl->cur_mode = xgbe_phy_cur_mode;\r\nphy_impl->an_mode = xgbe_phy_an_mode;\r\nphy_impl->an_config = xgbe_phy_an_config;\r\nphy_impl->an_advertising = xgbe_phy_an_advertising;\r\nphy_impl->an_outcome = xgbe_phy_an_outcome;\r\n}

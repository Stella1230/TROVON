static void update_voltage_constraints(struct device *dev,\r\nstruct virtual_consumer_data *data)\r\n{\r\nint ret;\r\nif (data->min_uV && data->max_uV\r\n&& data->min_uV <= data->max_uV) {\r\ndev_dbg(dev, "Requesting %d-%duV\n",\r\ndata->min_uV, data->max_uV);\r\nret = regulator_set_voltage(data->regulator,\r\ndata->min_uV, data->max_uV);\r\nif (ret != 0) {\r\ndev_err(dev,\r\n"regulator_set_voltage() failed: %d\n", ret);\r\nreturn;\r\n}\r\n}\r\nif (data->min_uV && data->max_uV && !data->enabled) {\r\ndev_dbg(dev, "Enabling regulator\n");\r\nret = regulator_enable(data->regulator);\r\nif (ret == 0)\r\ndata->enabled = true;\r\nelse\r\ndev_err(dev, "regulator_enable() failed: %d\n",\r\nret);\r\n}\r\nif (!(data->min_uV && data->max_uV) && data->enabled) {\r\ndev_dbg(dev, "Disabling regulator\n");\r\nret = regulator_disable(data->regulator);\r\nif (ret == 0)\r\ndata->enabled = false;\r\nelse\r\ndev_err(dev, "regulator_disable() failed: %d\n",\r\nret);\r\n}\r\n}\r\nstatic void update_current_limit_constraints(struct device *dev,\r\nstruct virtual_consumer_data *data)\r\n{\r\nint ret;\r\nif (data->max_uA\r\n&& data->min_uA <= data->max_uA) {\r\ndev_dbg(dev, "Requesting %d-%duA\n",\r\ndata->min_uA, data->max_uA);\r\nret = regulator_set_current_limit(data->regulator,\r\ndata->min_uA, data->max_uA);\r\nif (ret != 0) {\r\ndev_err(dev,\r\n"regulator_set_current_limit() failed: %d\n",\r\nret);\r\nreturn;\r\n}\r\n}\r\nif (data->max_uA && !data->enabled) {\r\ndev_dbg(dev, "Enabling regulator\n");\r\nret = regulator_enable(data->regulator);\r\nif (ret == 0)\r\ndata->enabled = true;\r\nelse\r\ndev_err(dev, "regulator_enable() failed: %d\n",\r\nret);\r\n}\r\nif (!(data->min_uA && data->max_uA) && data->enabled) {\r\ndev_dbg(dev, "Disabling regulator\n");\r\nret = regulator_disable(data->regulator);\r\nif (ret == 0)\r\ndata->enabled = false;\r\nelse\r\ndev_err(dev, "regulator_disable() failed: %d\n",\r\nret);\r\n}\r\n}\r\nstatic ssize_t show_min_uV(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->min_uV);\r\n}\r\nstatic ssize_t set_min_uV(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nif (kstrtol(buf, 10, &val) != 0)\r\nreturn count;\r\nmutex_lock(&data->lock);\r\ndata->min_uV = val;\r\nupdate_voltage_constraints(dev, data);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_max_uV(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->max_uV);\r\n}\r\nstatic ssize_t set_max_uV(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nif (kstrtol(buf, 10, &val) != 0)\r\nreturn count;\r\nmutex_lock(&data->lock);\r\ndata->max_uV = val;\r\nupdate_voltage_constraints(dev, data);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_min_uA(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->min_uA);\r\n}\r\nstatic ssize_t set_min_uA(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nif (kstrtol(buf, 10, &val) != 0)\r\nreturn count;\r\nmutex_lock(&data->lock);\r\ndata->min_uA = val;\r\nupdate_current_limit_constraints(dev, data);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_max_uA(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->max_uA);\r\n}\r\nstatic ssize_t set_max_uA(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nif (kstrtol(buf, 10, &val) != 0)\r\nreturn count;\r\nmutex_lock(&data->lock);\r\ndata->max_uA = val;\r\nupdate_current_limit_constraints(dev, data);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_mode(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nswitch (data->mode) {\r\ncase REGULATOR_MODE_FAST:\r\nreturn sprintf(buf, "fast\n");\r\ncase REGULATOR_MODE_NORMAL:\r\nreturn sprintf(buf, "normal\n");\r\ncase REGULATOR_MODE_IDLE:\r\nreturn sprintf(buf, "idle\n");\r\ncase REGULATOR_MODE_STANDBY:\r\nreturn sprintf(buf, "standby\n");\r\ndefault:\r\nreturn sprintf(buf, "unknown\n");\r\n}\r\n}\r\nstatic ssize_t set_mode(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct virtual_consumer_data *data = dev_get_drvdata(dev);\r\nunsigned int mode;\r\nint ret;\r\nif (sysfs_streq(buf, "fast\n"))\r\nmode = REGULATOR_MODE_FAST;\r\nelse if (sysfs_streq(buf, "normal\n"))\r\nmode = REGULATOR_MODE_NORMAL;\r\nelse if (sysfs_streq(buf, "idle\n"))\r\nmode = REGULATOR_MODE_IDLE;\r\nelse if (sysfs_streq(buf, "standby\n"))\r\nmode = REGULATOR_MODE_STANDBY;\r\nelse {\r\ndev_err(dev, "Configuring invalid mode\n");\r\nreturn count;\r\n}\r\nmutex_lock(&data->lock);\r\nret = regulator_set_mode(data->regulator, mode);\r\nif (ret == 0)\r\ndata->mode = mode;\r\nelse\r\ndev_err(dev, "Failed to configure mode: %d\n", ret);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic int regulator_virtual_probe(struct platform_device *pdev)\r\n{\r\nchar *reg_id = dev_get_platdata(&pdev->dev);\r\nstruct virtual_consumer_data *drvdata;\r\nint ret;\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(struct virtual_consumer_data),\r\nGFP_KERNEL);\r\nif (drvdata == NULL)\r\nreturn -ENOMEM;\r\nmutex_init(&drvdata->lock);\r\ndrvdata->regulator = devm_regulator_get(&pdev->dev, reg_id);\r\nif (IS_ERR(drvdata->regulator)) {\r\nret = PTR_ERR(drvdata->regulator);\r\ndev_err(&pdev->dev, "Failed to obtain supply '%s': %d\n",\r\nreg_id, ret);\r\nreturn ret;\r\n}\r\nret = sysfs_create_group(&pdev->dev.kobj,\r\n&regulator_virtual_attr_group);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to create attribute group: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrvdata->mode = regulator_get_mode(drvdata->regulator);\r\nplatform_set_drvdata(pdev, drvdata);\r\nreturn 0;\r\n}\r\nstatic int regulator_virtual_remove(struct platform_device *pdev)\r\n{\r\nstruct virtual_consumer_data *drvdata = platform_get_drvdata(pdev);\r\nsysfs_remove_group(&pdev->dev.kobj, &regulator_virtual_attr_group);\r\nif (drvdata->enabled)\r\nregulator_disable(drvdata->regulator);\r\nreturn 0;\r\n}

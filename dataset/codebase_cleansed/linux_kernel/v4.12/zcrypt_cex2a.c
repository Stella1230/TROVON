static int zcrypt_cex2a_card_probe(struct ap_device *ap_dev)\r\n{\r\nstatic const int CEX2A_SPEED_IDX[] = {\r\n800, 1000, 2000, 900, 1200, 2400, 0, 0};\r\nstatic const int CEX3A_SPEED_IDX[] = {\r\n400, 500, 1000, 450, 550, 1200, 0, 0};\r\nstruct ap_card *ac = to_ap_card(&ap_dev->device);\r\nstruct zcrypt_card *zc;\r\nint rc = 0;\r\nzc = zcrypt_card_alloc();\r\nif (!zc)\r\nreturn -ENOMEM;\r\nzc->card = ac;\r\nac->private = zc;\r\nif (ac->ap_dev.device_type == AP_DEVICE_TYPE_CEX2A) {\r\nzc->min_mod_size = CEX2A_MIN_MOD_SIZE;\r\nzc->max_mod_size = CEX2A_MAX_MOD_SIZE;\r\nmemcpy(zc->speed_rating, CEX2A_SPEED_IDX,\r\nsizeof(CEX2A_SPEED_IDX));\r\nzc->max_exp_bit_length = CEX2A_MAX_MOD_SIZE;\r\nzc->type_string = "CEX2A";\r\nzc->user_space_type = ZCRYPT_CEX2A;\r\n} else if (ac->ap_dev.device_type == AP_DEVICE_TYPE_CEX3A) {\r\nzc->min_mod_size = CEX2A_MIN_MOD_SIZE;\r\nzc->max_mod_size = CEX2A_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = CEX2A_MAX_MOD_SIZE;\r\nif (ap_test_bit(&ac->functions, AP_FUNC_MEX4K) &&\r\nap_test_bit(&ac->functions, AP_FUNC_CRT4K)) {\r\nzc->max_mod_size = CEX3A_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = CEX3A_MAX_MOD_SIZE;\r\n}\r\nmemcpy(zc->speed_rating, CEX3A_SPEED_IDX,\r\nsizeof(CEX3A_SPEED_IDX));\r\nzc->type_string = "CEX3A";\r\nzc->user_space_type = ZCRYPT_CEX3A;\r\n} else {\r\nzcrypt_card_free(zc);\r\nreturn -ENODEV;\r\n}\r\nzc->online = 1;\r\nrc = zcrypt_card_register(zc);\r\nif (rc) {\r\nac->private = NULL;\r\nzcrypt_card_free(zc);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex2a_card_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(&ap_dev->device)->private;\r\nif (zc)\r\nzcrypt_card_unregister(zc);\r\n}\r\nstatic int zcrypt_cex2a_queue_probe(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq = NULL;\r\nint rc;\r\nswitch (ap_dev->device_type) {\r\ncase AP_DEVICE_TYPE_CEX2A:\r\nzq = zcrypt_queue_alloc(CEX2A_MAX_RESPONSE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nbreak;\r\ncase AP_DEVICE_TYPE_CEX3A:\r\nzq = zcrypt_queue_alloc(CEX3A_MAX_RESPONSE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nbreak;\r\n}\r\nif (!zq)\r\nreturn -ENODEV;\r\nzq->ops = zcrypt_msgtype(MSGTYPE50_NAME, MSGTYPE50_VARIANT_DEFAULT);\r\nzq->queue = aq;\r\nzq->online = 1;\r\natomic_set(&zq->load, 0);\r\nap_queue_init_reply(aq, &zq->reply);\r\naq->request_timeout = CEX2A_CLEANUP_TIME,\r\naq->private = zq;\r\nrc = zcrypt_queue_register(zq);\r\nif (rc) {\r\naq->private = NULL;\r\nzcrypt_queue_free(zq);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex2a_queue_remove(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq = aq->private;\r\nap_queue_remove(aq);\r\nif (zq)\r\nzcrypt_queue_unregister(zq);\r\n}\r\nint __init zcrypt_cex2a_init(void)\r\n{\r\nint rc;\r\nrc = ap_driver_register(&zcrypt_cex2a_card_driver,\r\nTHIS_MODULE, "cex2acard");\r\nif (rc)\r\nreturn rc;\r\nrc = ap_driver_register(&zcrypt_cex2a_queue_driver,\r\nTHIS_MODULE, "cex2aqueue");\r\nif (rc)\r\nap_driver_unregister(&zcrypt_cex2a_card_driver);\r\nreturn rc;\r\n}\r\nvoid __exit zcrypt_cex2a_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_cex2a_queue_driver);\r\nap_driver_unregister(&zcrypt_cex2a_card_driver);\r\n}

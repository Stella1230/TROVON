bool\r\nxfs_ag_resv_critical(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type)\r\n{\r\nxfs_extlen_t avail;\r\nxfs_extlen_t orig;\r\nswitch (type) {\r\ncase XFS_AG_RESV_METADATA:\r\navail = pag->pagf_freeblks - pag->pag_agfl_resv.ar_reserved;\r\norig = pag->pag_meta_resv.ar_asked;\r\nbreak;\r\ncase XFS_AG_RESV_AGFL:\r\navail = pag->pagf_freeblks + pag->pagf_flcount -\r\npag->pag_meta_resv.ar_reserved;\r\norig = pag->pag_agfl_resv.ar_asked;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nreturn false;\r\n}\r\ntrace_xfs_ag_resv_critical(pag, type, avail);\r\nreturn XFS_TEST_ERROR(avail < orig / 10 || avail < XFS_BTREE_MAXLEVELS,\r\npag->pag_mount, XFS_ERRTAG_AG_RESV_CRITICAL,\r\nXFS_RANDOM_AG_RESV_CRITICAL);\r\n}\r\nxfs_extlen_t\r\nxfs_ag_resv_needed(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type)\r\n{\r\nxfs_extlen_t len;\r\nlen = pag->pag_meta_resv.ar_reserved + pag->pag_agfl_resv.ar_reserved;\r\nswitch (type) {\r\ncase XFS_AG_RESV_METADATA:\r\ncase XFS_AG_RESV_AGFL:\r\nlen -= xfs_perag_resv(pag, type)->ar_reserved;\r\nbreak;\r\ncase XFS_AG_RESV_NONE:\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\n}\r\ntrace_xfs_ag_resv_needed(pag, type, len);\r\nreturn len;\r\n}\r\nstatic int\r\n__xfs_ag_resv_free(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type)\r\n{\r\nstruct xfs_ag_resv *resv;\r\nxfs_extlen_t oldresv;\r\nint error;\r\ntrace_xfs_ag_resv_free(pag, type, 0);\r\nresv = xfs_perag_resv(pag, type);\r\npag->pag_mount->m_ag_max_usable += resv->ar_asked;\r\nif (type == XFS_AG_RESV_AGFL)\r\noldresv = resv->ar_orig_reserved;\r\nelse\r\noldresv = resv->ar_reserved;\r\nerror = xfs_mod_fdblocks(pag->pag_mount, oldresv, true);\r\nresv->ar_reserved = 0;\r\nresv->ar_asked = 0;\r\nif (error)\r\ntrace_xfs_ag_resv_free_error(pag->pag_mount, pag->pag_agno,\r\nerror, _RET_IP_);\r\nreturn error;\r\n}\r\nint\r\nxfs_ag_resv_free(\r\nstruct xfs_perag *pag)\r\n{\r\nint error;\r\nint err2;\r\nerror = __xfs_ag_resv_free(pag, XFS_AG_RESV_AGFL);\r\nerr2 = __xfs_ag_resv_free(pag, XFS_AG_RESV_METADATA);\r\nif (err2 && !error)\r\nerror = err2;\r\nreturn error;\r\n}\r\nstatic int\r\n__xfs_ag_resv_init(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type,\r\nxfs_extlen_t ask,\r\nxfs_extlen_t used)\r\n{\r\nstruct xfs_mount *mp = pag->pag_mount;\r\nstruct xfs_ag_resv *resv;\r\nint error;\r\nxfs_extlen_t reserved;\r\nif (used > ask)\r\nask = used;\r\nreserved = ask - used;\r\nerror = xfs_mod_fdblocks(mp, -(int64_t)reserved, true);\r\nif (error) {\r\ntrace_xfs_ag_resv_init_error(pag->pag_mount, pag->pag_agno,\r\nerror, _RET_IP_);\r\nxfs_warn(mp,\r\n"Per-AG reservation for AG %u failed. Filesystem may run out of space.",\r\npag->pag_agno);\r\nreturn error;\r\n}\r\nmp->m_ag_max_usable -= ask;\r\nresv = xfs_perag_resv(pag, type);\r\nresv->ar_asked = ask;\r\nresv->ar_reserved = resv->ar_orig_reserved = reserved;\r\ntrace_xfs_ag_resv_init(pag, type, ask);\r\nreturn 0;\r\n}\r\nint\r\nxfs_ag_resv_init(\r\nstruct xfs_perag *pag)\r\n{\r\nstruct xfs_mount *mp = pag->pag_mount;\r\nxfs_agnumber_t agno = pag->pag_agno;\r\nxfs_extlen_t ask;\r\nxfs_extlen_t used;\r\nint error = 0;\r\nif (pag->pag_meta_resv.ar_asked == 0) {\r\nask = used = 0;\r\nerror = xfs_refcountbt_calc_reserves(mp, agno, &ask, &used);\r\nif (error)\r\ngoto out;\r\nerror = xfs_finobt_calc_reserves(mp, agno, &ask, &used);\r\nif (error)\r\ngoto out;\r\nerror = __xfs_ag_resv_init(pag, XFS_AG_RESV_METADATA,\r\nask, used);\r\nif (error) {\r\nask = used = 0;\r\nmp->m_inotbt_nores = true;\r\nerror = xfs_refcountbt_calc_reserves(mp, agno, &ask,\r\n&used);\r\nif (error)\r\ngoto out;\r\nerror = __xfs_ag_resv_init(pag, XFS_AG_RESV_METADATA,\r\nask, used);\r\nif (error)\r\ngoto out;\r\n}\r\n}\r\nif (pag->pag_agfl_resv.ar_asked == 0) {\r\nask = used = 0;\r\nerror = xfs_rmapbt_calc_reserves(mp, agno, &ask, &used);\r\nif (error)\r\ngoto out;\r\nerror = __xfs_ag_resv_init(pag, XFS_AG_RESV_AGFL, ask, used);\r\nif (error)\r\ngoto out;\r\n}\r\n#ifdef DEBUG\r\nerror = xfs_alloc_pagf_init(pag->pag_mount, NULL, pag->pag_agno, 0);\r\nif (error)\r\nreturn error;\r\nASSERT(xfs_perag_resv(pag, XFS_AG_RESV_METADATA)->ar_reserved +\r\nxfs_perag_resv(pag, XFS_AG_RESV_AGFL)->ar_reserved <=\r\npag->pagf_freeblks + pag->pagf_flcount);\r\n#endif\r\nout:\r\nreturn error;\r\n}\r\nvoid\r\nxfs_ag_resv_alloc_extent(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type,\r\nstruct xfs_alloc_arg *args)\r\n{\r\nstruct xfs_ag_resv *resv;\r\nxfs_extlen_t len;\r\nuint field;\r\ntrace_xfs_ag_resv_alloc_extent(pag, type, args->len);\r\nswitch (type) {\r\ncase XFS_AG_RESV_METADATA:\r\ncase XFS_AG_RESV_AGFL:\r\nresv = xfs_perag_resv(pag, type);\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\ncase XFS_AG_RESV_NONE:\r\nfield = args->wasdel ? XFS_TRANS_SB_RES_FDBLOCKS :\r\nXFS_TRANS_SB_FDBLOCKS;\r\nxfs_trans_mod_sb(args->tp, field, -(int64_t)args->len);\r\nreturn;\r\n}\r\nlen = min_t(xfs_extlen_t, args->len, resv->ar_reserved);\r\nresv->ar_reserved -= len;\r\nif (type == XFS_AG_RESV_AGFL)\r\nreturn;\r\nxfs_trans_mod_sb(args->tp, XFS_TRANS_SB_RES_FDBLOCKS, -(int64_t)len);\r\nif (args->len > len)\r\nxfs_trans_mod_sb(args->tp, XFS_TRANS_SB_FDBLOCKS,\r\n-((int64_t)args->len - len));\r\n}\r\nvoid\r\nxfs_ag_resv_free_extent(\r\nstruct xfs_perag *pag,\r\nenum xfs_ag_resv_type type,\r\nstruct xfs_trans *tp,\r\nxfs_extlen_t len)\r\n{\r\nxfs_extlen_t leftover;\r\nstruct xfs_ag_resv *resv;\r\ntrace_xfs_ag_resv_free_extent(pag, type, len);\r\nswitch (type) {\r\ncase XFS_AG_RESV_METADATA:\r\ncase XFS_AG_RESV_AGFL:\r\nresv = xfs_perag_resv(pag, type);\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\ncase XFS_AG_RESV_NONE:\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FDBLOCKS, (int64_t)len);\r\nreturn;\r\n}\r\nleftover = min_t(xfs_extlen_t, len, resv->ar_asked - resv->ar_reserved);\r\nresv->ar_reserved += leftover;\r\nif (type == XFS_AG_RESV_AGFL)\r\nreturn;\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_RES_FDBLOCKS, len);\r\nif (len > leftover)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FDBLOCKS, len - leftover);\r\n}

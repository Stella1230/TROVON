static int das08_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + DAS08_STATUS_REG);\r\nif ((status & DAS08_STATUS_AI_BUSY) == 0)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int das08_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct das08_board_struct *board = dev->board_ptr;\r\nstruct das08_private_struct *devpriv = dev->private;\r\nint n;\r\nint chan;\r\nint range;\r\nint lsb, msb;\r\nint ret;\r\nchan = CR_CHAN(insn->chanspec);\r\nrange = CR_RANGE(insn->chanspec);\r\ninb(dev->iobase + DAS08_AI_LSB_REG);\r\ninb(dev->iobase + DAS08_AI_MSB_REG);\r\nspin_lock(&dev->spinlock);\r\ndevpriv->do_mux_bits &= ~DAS08_CONTROL_MUX_MASK;\r\ndevpriv->do_mux_bits |= DAS08_CONTROL_MUX(chan);\r\noutb(devpriv->do_mux_bits, dev->iobase + DAS08_CONTROL_REG);\r\nspin_unlock(&dev->spinlock);\r\nif (devpriv->pg_gainlist) {\r\nrange = CR_RANGE(insn->chanspec);\r\noutb(devpriv->pg_gainlist[range],\r\ndev->iobase + DAS08_GAIN_REG);\r\n}\r\nfor (n = 0; n < insn->n; n++) {\r\nif (board->ai_nbits == 16)\r\nif (inb(dev->iobase + DAS08_AI_MSB_REG) & 0x80)\r\ndev_info(dev->class_dev, "over-range\n");\r\noutb_p(0, dev->iobase + DAS08_AI_TRIG_REG);\r\nret = comedi_timeout(dev, s, insn, das08_ai_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\nmsb = inb(dev->iobase + DAS08_AI_MSB_REG);\r\nlsb = inb(dev->iobase + DAS08_AI_LSB_REG);\r\nif (board->ai_encoding == das08_encode12) {\r\ndata[n] = (lsb >> 4) | (msb << 4);\r\n} else if (board->ai_encoding == das08_pcm_encode12) {\r\ndata[n] = (msb << 8) + lsb;\r\n} else if (board->ai_encoding == das08_encode16) {\r\nunsigned int magnitude = lsb | ((msb & 0x7f) << 8);\r\nif (msb & 0x80)\r\ndata[n] = (1 << 15) + magnitude;\r\nelse\r\ndata[n] = (1 << 15) - magnitude;\r\n} else {\r\ndev_err(dev->class_dev, "bug! unknown ai encoding\n");\r\nreturn -1;\r\n}\r\n}\r\nreturn n;\r\n}\r\nstatic int das08_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[0] = 0;\r\ndata[1] = DAS08_STATUS_DI(inb(dev->iobase + DAS08_STATUS_REG));\r\nreturn insn->n;\r\n}\r\nstatic int das08_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct das08_private_struct *devpriv = dev->private;\r\nif (comedi_dio_update_state(s, data)) {\r\nspin_lock(&dev->spinlock);\r\ndevpriv->do_mux_bits &= ~DAS08_CONTROL_DO_MASK;\r\ndevpriv->do_mux_bits |= DAS08_CONTROL_DO(s->state);\r\noutb(devpriv->do_mux_bits, dev->iobase + DAS08_CONTROL_REG);\r\nspin_unlock(&dev->spinlock);\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int das08jr_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[0] = 0;\r\ndata[1] = inb(dev->iobase + DAS08JR_DI_REG);\r\nreturn insn->n;\r\n}\r\nstatic int das08jr_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutb(s->state, dev->iobase + DAS08JR_DO_REG);\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic void das08_ao_set_data(struct comedi_device *dev,\r\nunsigned int chan, unsigned int data)\r\n{\r\nconst struct das08_board_struct *board = dev->board_ptr;\r\nunsigned char lsb;\r\nunsigned char msb;\r\nlsb = data & 0xff;\r\nmsb = (data >> 8) & 0xff;\r\nif (board->is_jr) {\r\noutb(lsb, dev->iobase + DAS08JR_AO_LSB_REG(chan));\r\noutb(msb, dev->iobase + DAS08JR_AO_MSB_REG(chan));\r\ninb(dev->iobase + DAS08JR_AO_UPDATE_REG);\r\n} else {\r\noutb(lsb, dev->iobase + DAS08AOX_AO_LSB_REG(chan));\r\noutb(msb, dev->iobase + DAS08AOX_AO_MSB_REG(chan));\r\ninb(dev->iobase + DAS08AOX_AO_UPDATE_REG);\r\n}\r\n}\r\nstatic int das08_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int val = s->readback[chan];\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\nval = data[i];\r\ndas08_ao_set_data(dev, chan, val);\r\n}\r\ns->readback[chan] = val;\r\nreturn insn->n;\r\n}\r\nint das08_common_attach(struct comedi_device *dev, unsigned long iobase)\r\n{\r\nconst struct das08_board_struct *board = dev->board_ptr;\r\nstruct das08_private_struct *devpriv = dev->private;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nint i;\r\ndev->iobase = iobase;\r\ndev->board_name = board->name;\r\nret = comedi_alloc_subdevices(dev, 6);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\nif (board->ai_nbits) {\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 8;\r\ns->maxdata = (1 << board->ai_nbits) - 1;\r\ns->range_table = das08_ai_lranges[board->ai_pg];\r\ns->insn_read = das08_ai_insn_read;\r\ndevpriv->pg_gainlist = das08_ai_gainlists[board->ai_pg];\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[1];\r\nif (board->ao_nbits) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = (1 << board->ao_nbits) - 1;\r\ns->range_table = &range_bipolar5;\r\ns->insn_write = das08_ao_insn_write;\r\nret = comedi_alloc_subdev_readback(s);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < s->n_chan; i++) {\r\ns->readback[i] = s->maxdata / 2;\r\ndas08_ao_set_data(dev, i, s->readback[i]);\r\n}\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[2];\r\nif (board->di_nchan) {\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = board->di_nchan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = board->is_jr ? das08jr_di_insn_bits :\r\ndas08_di_insn_bits;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[3];\r\nif (board->do_nchan) {\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = board->do_nchan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = board->is_jr ? das08jr_do_insn_bits :\r\ndas08_do_insn_bits;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[4];\r\nif (board->i8255_offset != 0) {\r\nret = subdev_8255_init(dev, s, NULL, board->i8255_offset);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[5];\r\nif (board->i8254_offset) {\r\ndev->pacer = comedi_8254_init(dev->iobase + board->i8254_offset,\r\n0, I8254_IO8, 0);\r\nif (!dev->pacer)\r\nreturn -ENOMEM;\r\ncomedi_8254_subdevice_init(s, dev->pacer);\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init das08_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit das08_exit(void)\r\n{\r\n}

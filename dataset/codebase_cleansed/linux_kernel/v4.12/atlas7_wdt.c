static unsigned int atlas7_wdt_gettimeleft(struct watchdog_device *wdd)\r\n{\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\nu32 counter, match, delta;\r\ncounter = readl(wdt->base + ATLAS7_WDT_CNT);\r\nmatch = readl(wdt->base + ATLAS7_WDT_CNT_MATCH);\r\ndelta = match - counter;\r\nreturn delta / wdt->tick_rate;\r\n}\r\nstatic int atlas7_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\nu32 counter, match, delta;\r\ncounter = readl(wdt->base + ATLAS7_WDT_CNT);\r\ndelta = wdd->timeout * wdt->tick_rate;\r\nmatch = counter + delta;\r\nwritel(match, wdt->base + ATLAS7_WDT_CNT_MATCH);\r\nreturn 0;\r\n}\r\nstatic int atlas7_wdt_enable(struct watchdog_device *wdd)\r\n{\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\natlas7_wdt_ping(wdd);\r\nwritel(readl(wdt->base + ATLAS7_WDT_CNT_CTRL) | ATLAS7_WDT_CNT_EN,\r\nwdt->base + ATLAS7_WDT_CNT_CTRL);\r\nwritel(1, wdt->base + ATLAS7_WDT_EN);\r\nreturn 0;\r\n}\r\nstatic int atlas7_wdt_disable(struct watchdog_device *wdd)\r\n{\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\nwritel(0, wdt->base + ATLAS7_WDT_EN);\r\nwritel(readl(wdt->base + ATLAS7_WDT_CNT_CTRL) & ~ATLAS7_WDT_CNT_EN,\r\nwdt->base + ATLAS7_WDT_CNT_CTRL);\r\nreturn 0;\r\n}\r\nstatic int atlas7_wdt_settimeout(struct watchdog_device *wdd, unsigned int to)\r\n{\r\nwdd->timeout = to;\r\nreturn 0;\r\n}\r\nstatic int atlas7_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct atlas7_wdog *wdt;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nint ret;\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nwdt->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(wdt->base))\r\nreturn PTR_ERR(wdt->base);\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "clk enable failed\n");\r\ngoto err;\r\n}\r\nwritel(0, wdt->base + ATLAS7_WDT_CNT_CTRL);\r\nwdt->tick_rate = clk_get_rate(clk);\r\nif (!wdt->tick_rate) {\r\nret = -EINVAL;\r\ngoto err1;\r\n}\r\nwdt->clk = clk;\r\natlas7_wdd.min_timeout = 1;\r\natlas7_wdd.max_timeout = UINT_MAX / wdt->tick_rate;\r\nwatchdog_init_timeout(&atlas7_wdd, 0, &pdev->dev);\r\nwatchdog_set_nowayout(&atlas7_wdd, nowayout);\r\nwatchdog_set_drvdata(&atlas7_wdd, wdt);\r\nplatform_set_drvdata(pdev, &atlas7_wdd);\r\nret = watchdog_register_device(&atlas7_wdd);\r\nif (ret)\r\ngoto err1;\r\nreturn 0;\r\nerr1:\r\nclk_disable_unprepare(clk);\r\nerr:\r\nclk_put(clk);\r\nreturn ret;\r\n}\r\nstatic void atlas7_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdd = platform_get_drvdata(pdev);\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\natlas7_wdt_disable(wdd);\r\nclk_disable_unprepare(wdt->clk);\r\n}\r\nstatic int atlas7_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdd = platform_get_drvdata(pdev);\r\nstruct atlas7_wdog *wdt = watchdog_get_drvdata(wdd);\r\natlas7_wdt_shutdown(pdev);\r\nclk_put(wdt->clk);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused atlas7_wdt_suspend(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused atlas7_wdt_resume(struct device *dev)\r\n{\r\nstruct watchdog_device *wdd = dev_get_drvdata(dev);\r\natlas7_wdt_ping(wdd);\r\nreturn 0;\r\n}

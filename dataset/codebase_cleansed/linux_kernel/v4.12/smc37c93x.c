static unsigned long __init SMCConfigState(unsigned long baseAddr)\r\n{\r\nunsigned char devId;\r\nunsigned long configPort;\r\nunsigned long indexPort;\r\nunsigned long dataPort;\r\nint i;\r\nconfigPort = indexPort = baseAddr;\r\ndataPort = configPort + 1;\r\n#define NUM_RETRIES 5\r\nfor (i = 0; i < NUM_RETRIES; i++)\r\n{\r\noutb(CONFIG_ON_KEY, configPort);\r\noutb(CONFIG_ON_KEY, configPort);\r\noutb(DEVICE_ID, indexPort);\r\ndevId = inb(dataPort);\r\nif (devId == VALID_DEVICE_ID) {\r\noutb(DEVICE_REV, indexPort);\r\ninb(dataPort);\r\nbreak;\r\n}\r\nelse\r\nudelay(100);\r\n}\r\nreturn (i != NUM_RETRIES) ? baseAddr : 0L;\r\n}\r\nstatic void __init SMCRunState(unsigned long baseAddr)\r\n{\r\noutb(CONFIG_OFF_KEY, baseAddr);\r\n}\r\nstatic unsigned long __init SMCDetectUltraIO(void)\r\n{\r\nunsigned long baseAddr;\r\nbaseAddr = 0x3F0;\r\nif ( ( baseAddr = SMCConfigState( baseAddr ) ) == 0x3F0 ) {\r\nreturn( baseAddr );\r\n}\r\nbaseAddr = 0x370;\r\nif ( ( baseAddr = SMCConfigState( baseAddr ) ) == 0x370 ) {\r\nreturn( baseAddr );\r\n}\r\nreturn( ( unsigned long )0 );\r\n}\r\nstatic void __init SMCEnableDevice(unsigned long baseAddr,\r\nunsigned long device,\r\nunsigned long portaddr,\r\nunsigned long interrupt)\r\n{\r\nunsigned long indexPort;\r\nunsigned long dataPort;\r\nindexPort = baseAddr;\r\ndataPort = baseAddr + 1;\r\noutb(LOGICAL_DEVICE_NUMBER, indexPort);\r\noutb(device, dataPort);\r\noutb(ADDR_LO, indexPort);\r\noutb(( portaddr & 0xFF ), dataPort);\r\noutb(ADDR_HI, indexPort);\r\noutb((portaddr >> 8) & 0xFF, dataPort);\r\noutb(INTERRUPT_SEL, indexPort);\r\noutb(interrupt, dataPort);\r\noutb(ACTIVATE, indexPort);\r\noutb(DEVICE_ON, dataPort);\r\n}\r\nstatic void __init SMCEnableKYBD(unsigned long baseAddr)\r\n{\r\nunsigned long indexPort;\r\nunsigned long dataPort;\r\nindexPort = baseAddr;\r\ndataPort = baseAddr + 1;\r\noutb(LOGICAL_DEVICE_NUMBER, indexPort);\r\noutb(KYBD, dataPort);\r\noutb(INTERRUPT_SEL, indexPort);\r\noutb(KYBD_INTERRUPT, dataPort);\r\noutb(INTERRUPT_SEL_2, indexPort);\r\noutb(MOUS_INTERRUPT, dataPort);\r\noutb(ACTIVATE, indexPort);\r\noutb(DEVICE_ON, dataPort);\r\n}\r\nstatic void __init SMCEnableFDC(unsigned long baseAddr)\r\n{\r\nunsigned long indexPort;\r\nunsigned long dataPort;\r\nunsigned char oldValue;\r\nindexPort = baseAddr;\r\ndataPort = baseAddr + 1;\r\noutb(LOGICAL_DEVICE_NUMBER, indexPort);\r\noutb(FDC, dataPort);\r\noutb(FDD_MODE_REGISTER, indexPort);\r\noldValue = inb(dataPort);\r\noldValue |= 0x0E;\r\noutb(oldValue, dataPort);\r\noutb(INTERRUPT_SEL, indexPort);\r\noutb(0x06, dataPort );\r\noutb(DMA_CHANNEL_SEL, indexPort);\r\noutb(0x02, dataPort);\r\noutb(ACTIVATE, indexPort);\r\noutb(DEVICE_ON, dataPort);\r\n}\r\nstatic void __init SMCReportDeviceStatus(unsigned long baseAddr)\r\n{\r\nunsigned long indexPort;\r\nunsigned long dataPort;\r\nunsigned char currentControl;\r\nindexPort = baseAddr;\r\ndataPort = baseAddr + 1;\r\noutb(POWER_CONTROL, indexPort);\r\ncurrentControl = inb(dataPort);\r\nprintk(currentControl & (1 << FDC)\r\n? "\t+FDC Enabled\n" : "\t-FDC Disabled\n");\r\nprintk(currentControl & (1 << IDE1)\r\n? "\t+IDE1 Enabled\n" : "\t-IDE1 Disabled\n");\r\nprintk(currentControl & (1 << IDE2)\r\n? "\t+IDE2 Enabled\n" : "\t-IDE2 Disabled\n");\r\nprintk(currentControl & (1 << PARP)\r\n? "\t+PARP Enabled\n" : "\t-PARP Disabled\n");\r\nprintk(currentControl & (1 << SER1)\r\n? "\t+SER1 Enabled\n" : "\t-SER1 Disabled\n");\r\nprintk(currentControl & (1 << SER2)\r\n? "\t+SER2 Enabled\n" : "\t-SER2 Disabled\n");\r\nprintk( "\n" );\r\n}\r\nint __init SMC93x_Init(void)\r\n{\r\nunsigned long SMCUltraBase;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif ((SMCUltraBase = SMCDetectUltraIO()) != 0UL) {\r\n#if SMC_DEBUG\r\nSMCReportDeviceStatus(SMCUltraBase);\r\n#endif\r\nSMCEnableDevice(SMCUltraBase, SER1, COM1_BASE, COM1_INTERRUPT);\r\nDBG_DEVS(("SMC FDC37C93X: SER1 done\n"));\r\nSMCEnableDevice(SMCUltraBase, SER2, COM2_BASE, COM2_INTERRUPT);\r\nDBG_DEVS(("SMC FDC37C93X: SER2 done\n"));\r\nSMCEnableDevice(SMCUltraBase, PARP, PARP_BASE, PARP_INTERRUPT);\r\nDBG_DEVS(("SMC FDC37C93X: PARP done\n"));\r\nSMCEnableKYBD(SMCUltraBase);\r\nDBG_DEVS(("SMC FDC37C93X: KYB done\n"));\r\nSMCEnableFDC(SMCUltraBase);\r\nDBG_DEVS(("SMC FDC37C93X: FDC done\n"));\r\n#if SMC_DEBUG\r\nSMCReportDeviceStatus(SMCUltraBase);\r\n#endif\r\nSMCRunState(SMCUltraBase);\r\nlocal_irq_restore(flags);\r\nprintk("SMC FDC37C93X Ultra I/O Controller found @ 0x%lx\n",\r\nSMCUltraBase);\r\nreturn 1;\r\n}\r\nelse {\r\nlocal_irq_restore(flags);\r\nDBG_DEVS(("No SMC FDC37C93X Ultra I/O Controller found\n"));\r\nreturn 0;\r\n}\r\n}

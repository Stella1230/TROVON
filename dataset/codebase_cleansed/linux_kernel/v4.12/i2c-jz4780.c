static inline unsigned short jz4780_i2c_readw(struct jz4780_i2c *i2c,\r\nunsigned long offset)\r\n{\r\nreturn readw(i2c->iomem + offset);\r\n}\r\nstatic inline void jz4780_i2c_writew(struct jz4780_i2c *i2c,\r\nunsigned long offset, unsigned short val)\r\n{\r\nwritew(val, i2c->iomem + offset);\r\n}\r\nstatic int jz4780_i2c_disable(struct jz4780_i2c *i2c)\r\n{\r\nunsigned short regval;\r\nunsigned long loops = 5;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_ENB, 0);\r\ndo {\r\nregval = jz4780_i2c_readw(i2c, JZ4780_I2C_ENSTA);\r\nif (!(regval & JZ4780_I2C_ENB_I2C))\r\nreturn 0;\r\nusleep_range(5000, 15000);\r\n} while (--loops);\r\ndev_err(&i2c->adap.dev, "disable failed: ENSTA=0x%04x\n", regval);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int jz4780_i2c_enable(struct jz4780_i2c *i2c)\r\n{\r\nunsigned short regval;\r\nunsigned long loops = 5;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_ENB, 1);\r\ndo {\r\nregval = jz4780_i2c_readw(i2c, JZ4780_I2C_ENSTA);\r\nif (regval & JZ4780_I2C_ENB_I2C)\r\nreturn 0;\r\nusleep_range(5000, 15000);\r\n} while (--loops);\r\ndev_err(&i2c->adap.dev, "enable failed: ENSTA=0x%04x\n", regval);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int jz4780_i2c_set_target(struct jz4780_i2c *i2c, unsigned char address)\r\n{\r\nunsigned short regval;\r\nunsigned long loops = 5;\r\ndo {\r\nregval = jz4780_i2c_readw(i2c, JZ4780_I2C_STA);\r\nif ((regval & JZ4780_I2C_STA_TFE) &&\r\n!(regval & JZ4780_I2C_STA_MSTACT))\r\nbreak;\r\nusleep_range(5000, 15000);\r\n} while (--loops);\r\nif (loops) {\r\njz4780_i2c_writew(i2c, JZ4780_I2C_TAR, address);\r\nreturn 0;\r\n}\r\ndev_err(&i2c->adap.dev,\r\n"set device to address 0x%02x failed, STA=0x%04x\n",\r\naddress, regval);\r\nreturn -ENXIO;\r\n}\r\nstatic int jz4780_i2c_set_speed(struct jz4780_i2c *i2c)\r\n{\r\nint dev_clk_khz = clk_get_rate(i2c->clk) / 1000;\r\nint cnt_high = 0;\r\nint cnt_low = 0;\r\nint cnt_period = 0;\r\nint setup_time = 0;\r\nint hold_time = 0;\r\nunsigned short tmp = 0;\r\nint i2c_clk = i2c->speed;\r\nif (jz4780_i2c_disable(i2c))\r\ndev_dbg(&i2c->adap.dev, "i2c not disabled\n");\r\ncnt_period = dev_clk_khz / i2c_clk;\r\nif (i2c_clk <= 100)\r\ncnt_high = (cnt_period * 4000) / (4700 + 4000);\r\nelse\r\ncnt_high = (cnt_period * 600) / (1300 + 600);\r\ncnt_low = cnt_period - cnt_high;\r\nif (i2c_clk <= 100) {\r\ntmp = JZ4780_I2C_CTRL_SPDS | JZ4780_I2C_CTRL_REST\r\n| JZ4780_I2C_CTRL_SLVDIS | JZ4780_I2C_CTRL_MD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_SHCNT,\r\nJZ4780_I2CSHCNT_ADJUST(cnt_high));\r\njz4780_i2c_writew(i2c, JZ4780_I2C_SLCNT,\r\nJZ4780_I2CSLCNT_ADJUST(cnt_low));\r\n} else {\r\ntmp = JZ4780_I2C_CTRL_SPDF | JZ4780_I2C_CTRL_REST\r\n| JZ4780_I2C_CTRL_SLVDIS | JZ4780_I2C_CTRL_MD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_FHCNT,\r\nJZ4780_I2CFHCNT_ADJUST(cnt_high));\r\njz4780_i2c_writew(i2c, JZ4780_I2C_FLCNT,\r\nJZ4780_I2CFLCNT_ADJUST(cnt_low));\r\n}\r\nif (i2c_clk <= 100) {\r\nsetup_time = 300;\r\nhold_time = 400;\r\n} else {\r\nsetup_time = 450;\r\nhold_time = 450;\r\n}\r\nhold_time = ((hold_time * dev_clk_khz) / 1000000) - 1;\r\nsetup_time = ((setup_time * dev_clk_khz) / 1000000) + 1;\r\nif (setup_time > 255)\r\nsetup_time = 255;\r\nif (setup_time <= 0)\r\nsetup_time = 1;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_SDASU, setup_time);\r\nif (hold_time > 255)\r\nhold_time = 255;\r\nif (hold_time >= 0) {\r\nhold_time |= JZ4780_I2C_SDAHD_HDENB;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_SDAHD, hold_time);\r\n} else {\r\njz4780_i2c_writew(i2c, JZ4780_I2C_SDAHD, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int jz4780_i2c_cleanup(struct jz4780_i2c *i2c)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nunsigned short tmp;\r\nspin_lock_irqsave(&i2c->lock, flags);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp &= ~JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM, 0);\r\njz4780_i2c_readw(i2c, JZ4780_I2C_CTXABRT);\r\njz4780_i2c_readw(i2c, JZ4780_I2C_CINTR);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp &= ~JZ4780_I2C_ENB_I2C;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\nudelay(10);\r\ntmp |= JZ4780_I2C_ENB_I2C;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\nret = jz4780_i2c_disable(i2c);\r\nif (ret)\r\ndev_err(&i2c->adap.dev,\r\n"unable to disable device during cleanup!\n");\r\nif (unlikely(jz4780_i2c_readw(i2c, JZ4780_I2C_INTM)\r\n& jz4780_i2c_readw(i2c, JZ4780_I2C_INTST)))\r\ndev_err(&i2c->adap.dev,\r\n"device has interrupts after a complete cleanup!\n");\r\nreturn ret;\r\n}\r\nstatic int jz4780_i2c_prepare(struct jz4780_i2c *i2c)\r\n{\r\njz4780_i2c_set_speed(i2c);\r\nreturn jz4780_i2c_enable(i2c);\r\n}\r\nstatic void jz4780_i2c_send_rcmd(struct jz4780_i2c *i2c, int cmd_count)\r\n{\r\nint i;\r\nfor (i = 0; i < cmd_count; i++)\r\njz4780_i2c_writew(i2c, JZ4780_I2C_DC, JZ4780_I2C_DC_READ);\r\n}\r\nstatic void jz4780_i2c_trans_done(struct jz4780_i2c *i2c)\r\n{\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM, 0);\r\ncomplete(&i2c->trans_waitq);\r\n}\r\nstatic irqreturn_t jz4780_i2c_irq(int irqno, void *dev_id)\r\n{\r\nunsigned short tmp;\r\nunsigned short intst;\r\nunsigned short intmsk;\r\nstruct jz4780_i2c *i2c = dev_id;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nintmsk = jz4780_i2c_readw(i2c, JZ4780_I2C_INTM);\r\nintst = jz4780_i2c_readw(i2c, JZ4780_I2C_INTST);\r\nintst &= intmsk;\r\nif (intst & JZ4780_I2C_INTST_TXABT) {\r\njz4780_i2c_trans_done(i2c);\r\ngoto done;\r\n}\r\nif (intst & JZ4780_I2C_INTST_RXOF) {\r\ndev_dbg(&i2c->adap.dev, "received fifo overflow!\n");\r\njz4780_i2c_trans_done(i2c);\r\ngoto done;\r\n}\r\nif (i2c->is_write == 0) {\r\nint rd_left;\r\nwhile ((jz4780_i2c_readw(i2c, JZ4780_I2C_STA)\r\n& JZ4780_I2C_STA_RFNE)) {\r\n*(i2c->rbuf++) = jz4780_i2c_readw(i2c, JZ4780_I2C_DC)\r\n& 0xff;\r\ni2c->rd_data_xfered++;\r\nif (i2c->rd_data_xfered == i2c->rd_total_len) {\r\njz4780_i2c_trans_done(i2c);\r\ngoto done;\r\n}\r\n}\r\nrd_left = i2c->rd_total_len - i2c->rd_data_xfered;\r\nif (rd_left <= JZ4780_I2C_FIFO_LEN)\r\njz4780_i2c_writew(i2c, JZ4780_I2C_RXTL, rd_left - 1);\r\n}\r\nif (intst & JZ4780_I2C_INTST_TXEMP) {\r\nif (i2c->is_write == 0) {\r\nint cmd_left = i2c->rd_total_len - i2c->rd_cmd_xfered;\r\nint max_send = (JZ4780_I2C_FIFO_LEN - 1)\r\n- (i2c->rd_cmd_xfered\r\n- i2c->rd_data_xfered);\r\nint cmd_to_send = min(cmd_left, max_send);\r\nif (i2c->rd_cmd_xfered != 0)\r\ncmd_to_send = min(cmd_to_send,\r\nJZ4780_I2C_FIFO_LEN\r\n- TX_LEVEL - 1);\r\nif (cmd_to_send) {\r\njz4780_i2c_send_rcmd(i2c, cmd_to_send);\r\ni2c->rd_cmd_xfered += cmd_to_send;\r\n}\r\ncmd_left = i2c->rd_total_len - i2c->rd_cmd_xfered;\r\nif (cmd_left == 0) {\r\nintmsk = jz4780_i2c_readw(i2c, JZ4780_I2C_INTM);\r\nintmsk &= ~JZ4780_I2C_INTM_MTXEMP;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM, intmsk);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp &= ~JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\n}\r\n} else {\r\nunsigned short data;\r\nunsigned short i2c_sta;\r\ni2c_sta = jz4780_i2c_readw(i2c, JZ4780_I2C_STA);\r\nwhile ((i2c_sta & JZ4780_I2C_STA_TFNF) &&\r\n(i2c->wt_len > 0)) {\r\ni2c_sta = jz4780_i2c_readw(i2c, JZ4780_I2C_STA);\r\ndata = *i2c->wbuf;\r\ndata &= ~JZ4780_I2C_DC_READ;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_DC,\r\ndata);\r\ni2c->wbuf++;\r\ni2c->wt_len--;\r\n}\r\nif (i2c->wt_len == 0) {\r\nif (!i2c->stop_hold) {\r\ntmp = jz4780_i2c_readw(i2c,\r\nJZ4780_I2C_CTRL);\r\ntmp &= ~JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL,\r\ntmp);\r\n}\r\njz4780_i2c_trans_done(i2c);\r\ngoto done;\r\n}\r\n}\r\n}\r\ndone:\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void jz4780_i2c_txabrt(struct jz4780_i2c *i2c, int src)\r\n{\r\nint i;\r\ndev_err(&i2c->adap.dev, "txabrt: 0x%08x\n", src);\r\ndev_err(&i2c->adap.dev, "device addr=%x\n",\r\njz4780_i2c_readw(i2c, JZ4780_I2C_TAR));\r\ndev_err(&i2c->adap.dev, "send cmd count:%d %d\n",\r\ni2c->cmd, i2c->cmd_buf[i2c->cmd]);\r\ndev_err(&i2c->adap.dev, "receive data count:%d %d\n",\r\ni2c->cmd, i2c->data_buf[i2c->cmd]);\r\nfor (i = 0; i < 16; i++) {\r\nif (src & BIT(i))\r\ndev_dbg(&i2c->adap.dev, "I2C TXABRT[%d]=%s\n",\r\ni, jz4780_i2c_abrt_src[i]);\r\n}\r\n}\r\nstatic inline int jz4780_i2c_xfer_read(struct jz4780_i2c *i2c,\r\nunsigned char *buf, int len, int cnt,\r\nint idx)\r\n{\r\nint ret = 0;\r\nlong timeout;\r\nint wait_time = JZ4780_I2C_TIMEOUT * (len + 5);\r\nunsigned short tmp;\r\nunsigned long flags;\r\nmemset(buf, 0, len);\r\nspin_lock_irqsave(&i2c->lock, flags);\r\ni2c->stop_hold = 0;\r\ni2c->is_write = 0;\r\ni2c->rbuf = buf;\r\ni2c->rd_total_len = len;\r\ni2c->rd_data_xfered = 0;\r\ni2c->rd_cmd_xfered = 0;\r\nif (len <= JZ4780_I2C_FIFO_LEN)\r\njz4780_i2c_writew(i2c, JZ4780_I2C_RXTL, len - 1);\r\nelse\r\njz4780_i2c_writew(i2c, JZ4780_I2C_RXTL, RX_LEVEL);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_TXTL, TX_LEVEL);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM,\r\nJZ4780_I2C_INTM_MRXFL | JZ4780_I2C_INTM_MTXEMP\r\n| JZ4780_I2C_INTM_MTXABT | JZ4780_I2C_INTM_MRXOF);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp |= JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\ntimeout = wait_for_completion_timeout(&i2c->trans_waitq,\r\nmsecs_to_jiffies(wait_time));\r\nif (!timeout) {\r\ndev_err(&i2c->adap.dev, "irq read timeout\n");\r\ndev_dbg(&i2c->adap.dev, "send cmd count:%d %d\n",\r\ni2c->cmd, i2c->cmd_buf[i2c->cmd]);\r\ndev_dbg(&i2c->adap.dev, "receive data count:%d %d\n",\r\ni2c->cmd, i2c->data_buf[i2c->cmd]);\r\nret = -EIO;\r\n}\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_TXABRT);\r\nif (tmp) {\r\njz4780_i2c_txabrt(i2c, tmp);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int jz4780_i2c_xfer_write(struct jz4780_i2c *i2c,\r\nunsigned char *buf, int len,\r\nint cnt, int idx)\r\n{\r\nint ret = 0;\r\nint wait_time = JZ4780_I2C_TIMEOUT * (len + 5);\r\nlong timeout;\r\nunsigned short tmp;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nif (idx < (cnt - 1))\r\ni2c->stop_hold = 1;\r\nelse\r\ni2c->stop_hold = 0;\r\ni2c->is_write = 1;\r\ni2c->wbuf = buf;\r\ni2c->wt_len = len;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_TXTL, TX_LEVEL);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM, JZ4780_I2C_INTM_MTXEMP\r\n| JZ4780_I2C_INTM_MTXABT);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp |= JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\ntimeout = wait_for_completion_timeout(&i2c->trans_waitq,\r\nmsecs_to_jiffies(wait_time));\r\nif (timeout && !i2c->stop_hold) {\r\nunsigned short i2c_sta;\r\nint write_in_process;\r\ntimeout = JZ4780_I2C_TIMEOUT * 100;\r\nfor (; timeout > 0; timeout--) {\r\ni2c_sta = jz4780_i2c_readw(i2c, JZ4780_I2C_STA);\r\nwrite_in_process = (i2c_sta & JZ4780_I2C_STA_MSTACT) ||\r\n!(i2c_sta & JZ4780_I2C_STA_TFE);\r\nif (!write_in_process)\r\nbreak;\r\nudelay(10);\r\n}\r\n}\r\nif (!timeout) {\r\ndev_err(&i2c->adap.dev, "write wait timeout\n");\r\nret = -EIO;\r\n}\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_TXABRT);\r\nif (tmp) {\r\njz4780_i2c_txabrt(i2c, tmp);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int jz4780_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msg,\r\nint count)\r\n{\r\nint i = -EIO;\r\nint ret = 0;\r\nstruct jz4780_i2c *i2c = adap->algo_data;\r\nret = jz4780_i2c_prepare(i2c);\r\nif (ret) {\r\ndev_err(&i2c->adap.dev, "I2C prepare failed\n");\r\ngoto out;\r\n}\r\nif (msg->addr != jz4780_i2c_readw(i2c, JZ4780_I2C_TAR)) {\r\nret = jz4780_i2c_set_target(i2c, msg->addr);\r\nif (ret)\r\ngoto out;\r\n}\r\nfor (i = 0; i < count; i++, msg++) {\r\nif (msg->flags & I2C_M_RD)\r\nret = jz4780_i2c_xfer_read(i2c, msg->buf, msg->len,\r\ncount, i);\r\nelse\r\nret = jz4780_i2c_xfer_write(i2c, msg->buf, msg->len,\r\ncount, i);\r\nif (ret)\r\ngoto out;\r\n}\r\nret = i;\r\nout:\r\njz4780_i2c_cleanup(i2c);\r\nreturn ret;\r\n}\r\nstatic u32 jz4780_i2c_functionality(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int jz4780_i2c_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nunsigned int clk_freq = 0;\r\nunsigned short tmp;\r\nstruct resource *r;\r\nstruct jz4780_i2c *i2c;\r\ni2c = devm_kzalloc(&pdev->dev, sizeof(struct jz4780_i2c), GFP_KERNEL);\r\nif (!i2c)\r\nreturn -ENOMEM;\r\ni2c->adap.owner = THIS_MODULE;\r\ni2c->adap.algo = &jz4780_i2c_algorithm;\r\ni2c->adap.algo_data = i2c;\r\ni2c->adap.retries = 5;\r\ni2c->adap.dev.parent = &pdev->dev;\r\ni2c->adap.dev.of_node = pdev->dev.of_node;\r\nsprintf(i2c->adap.name, "%s", pdev->name);\r\ninit_completion(&i2c->trans_waitq);\r\nspin_lock_init(&i2c->lock);\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ni2c->iomem = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(i2c->iomem))\r\nreturn PTR_ERR(i2c->iomem);\r\nplatform_set_drvdata(pdev, i2c);\r\ni2c->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(i2c->clk))\r\nreturn PTR_ERR(i2c->clk);\r\nret = clk_prepare_enable(i2c->clk);\r\nif (ret)\r\nreturn ret;\r\nret = of_property_read_u32(pdev->dev.of_node, "clock-frequency",\r\n&clk_freq);\r\nif (ret) {\r\ndev_err(&pdev->dev, "clock-frequency not specified in DT\n");\r\ngoto err;\r\n}\r\ni2c->speed = clk_freq / 1000;\r\nif (i2c->speed == 0) {\r\nret = -EINVAL;\r\ndev_err(&pdev->dev, "clock-frequency minimum is 1000\n");\r\ngoto err;\r\n}\r\njz4780_i2c_set_speed(i2c);\r\ndev_info(&pdev->dev, "Bus frequency is %d KHz\n", i2c->speed);\r\ntmp = jz4780_i2c_readw(i2c, JZ4780_I2C_CTRL);\r\ntmp &= ~JZ4780_I2C_CTRL_STPHLD;\r\njz4780_i2c_writew(i2c, JZ4780_I2C_CTRL, tmp);\r\njz4780_i2c_writew(i2c, JZ4780_I2C_INTM, 0x0);\r\ni2c->irq = platform_get_irq(pdev, 0);\r\nret = devm_request_irq(&pdev->dev, i2c->irq, jz4780_i2c_irq, 0,\r\ndev_name(&pdev->dev), i2c);\r\nif (ret)\r\ngoto err;\r\nret = i2c_add_adapter(&i2c->adap);\r\nif (ret < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nclk_disable_unprepare(i2c->clk);\r\nreturn ret;\r\n}\r\nstatic int jz4780_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4780_i2c *i2c = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(i2c->clk);\r\ni2c_del_adapter(&i2c->adap);\r\nreturn 0;\r\n}

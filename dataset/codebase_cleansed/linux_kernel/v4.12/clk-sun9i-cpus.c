static unsigned long sun9i_a80_cpus_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun9i_a80_cpus_clk *cpus = to_sun9i_a80_cpus_clk(hw);\r\nunsigned long rate;\r\nu32 reg;\r\nreg = readl(cpus->reg);\r\nif (SUN9I_CPUS_MUX_GET_PARENT(reg) == SUN9I_CPUS_MUX_PARENT_PLL4)\r\nparent_rate /= SUN9I_CPUS_PLL4_DIV_GET(reg) + 1;\r\nrate = parent_rate / (SUN9I_CPUS_DIV_GET(reg) + 1);\r\nreturn rate;\r\n}\r\nstatic long sun9i_a80_cpus_clk_round(unsigned long rate, u8 *divp, u8 *pre_divp,\r\nu8 parent, unsigned long parent_rate)\r\n{\r\nu8 div, pre_div = 1;\r\nif (parent_rate && rate > parent_rate)\r\nrate = parent_rate;\r\ndiv = DIV_ROUND_UP(parent_rate, rate);\r\nif (parent == SUN9I_CPUS_MUX_PARENT_PLL4 && div > 4) {\r\nif (div < 32) {\r\npre_div = div;\r\ndiv = 1;\r\n} else if (div < 64) {\r\npre_div = DIV_ROUND_UP(div, 2);\r\ndiv = 2;\r\n} else if (div < 96) {\r\npre_div = DIV_ROUND_UP(div, 3);\r\ndiv = 3;\r\n} else {\r\npre_div = DIV_ROUND_UP(div, 4);\r\ndiv = 4;\r\n}\r\n}\r\nif (divp) {\r\n*divp = div - 1;\r\n*pre_divp = pre_div - 1;\r\n}\r\nreturn parent_rate / pre_div / div;\r\n}\r\nstatic int sun9i_a80_cpus_clk_determine_rate(struct clk_hw *clk,\r\nstruct clk_rate_request *req)\r\n{\r\nstruct clk_hw *parent, *best_parent = NULL;\r\nint i, num_parents;\r\nunsigned long parent_rate, best = 0, child_rate, best_child_rate = 0;\r\nunsigned long rate = req->rate;\r\nnum_parents = clk_hw_get_num_parents(clk);\r\nfor (i = 0; i < num_parents; i++) {\r\nparent = clk_hw_get_parent_by_index(clk, i);\r\nif (!parent)\r\ncontinue;\r\nif (clk_hw_get_flags(clk) & CLK_SET_RATE_PARENT)\r\nparent_rate = clk_hw_round_rate(parent, rate);\r\nelse\r\nparent_rate = clk_hw_get_rate(parent);\r\nchild_rate = sun9i_a80_cpus_clk_round(rate, NULL, NULL, i,\r\nparent_rate);\r\nif (child_rate <= rate && child_rate > best_child_rate) {\r\nbest_parent = parent;\r\nbest = parent_rate;\r\nbest_child_rate = child_rate;\r\n}\r\n}\r\nif (!best_parent)\r\nreturn -EINVAL;\r\nreq->best_parent_hw = best_parent;\r\nreq->best_parent_rate = best;\r\nreq->rate = best_child_rate;\r\nreturn 0;\r\n}\r\nstatic int sun9i_a80_cpus_clk_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct sun9i_a80_cpus_clk *cpus = to_sun9i_a80_cpus_clk(hw);\r\nunsigned long flags;\r\nu8 div, pre_div, parent;\r\nu32 reg;\r\nspin_lock_irqsave(&sun9i_a80_cpus_lock, flags);\r\nreg = readl(cpus->reg);\r\nparent = SUN9I_CPUS_MUX_GET_PARENT(reg);\r\nsun9i_a80_cpus_clk_round(rate, &div, &pre_div, parent, parent_rate);\r\nreg = SUN9I_CPUS_DIV_SET(reg, div);\r\nreg = SUN9I_CPUS_PLL4_DIV_SET(reg, pre_div);\r\nwritel(reg, cpus->reg);\r\nspin_unlock_irqrestore(&sun9i_a80_cpus_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void sun9i_a80_cpus_setup(struct device_node *node)\r\n{\r\nconst char *clk_name = node->name;\r\nconst char *parents[SUN9I_CPUS_MAX_PARENTS];\r\nstruct resource res;\r\nstruct sun9i_a80_cpus_clk *cpus;\r\nstruct clk_mux *mux;\r\nstruct clk *clk;\r\nint ret;\r\ncpus = kzalloc(sizeof(*cpus), GFP_KERNEL);\r\nif (!cpus)\r\nreturn;\r\ncpus->reg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(cpus->reg))\r\ngoto err_free_cpus;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nret = of_clk_parent_fill(node, parents, SUN9I_CPUS_MAX_PARENTS);\r\nmux = kzalloc(sizeof(*mux), GFP_KERNEL);\r\nif (!mux)\r\ngoto err_unmap;\r\nmux->reg = cpus->reg;\r\nmux->shift = SUN9I_CPUS_MUX_SHIFT;\r\nmux->mask = SUN9I_CPUS_MUX_MASK >> SUN9I_CPUS_MUX_SHIFT;\r\nmux->lock = &sun9i_a80_cpus_lock;\r\nclk = clk_register_composite(NULL, clk_name, parents, ret,\r\n&mux->hw, &clk_mux_ops,\r\n&cpus->hw, &sun9i_a80_cpus_clk_ops,\r\nNULL, NULL, 0);\r\nif (IS_ERR(clk))\r\ngoto err_free_mux;\r\nret = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nif (ret)\r\ngoto err_unregister;\r\nreturn;\r\nerr_unregister:\r\nclk_unregister(clk);\r\nerr_free_mux:\r\nkfree(mux);\r\nerr_unmap:\r\niounmap(cpus->reg);\r\nof_address_to_resource(node, 0, &res);\r\nrelease_mem_region(res.start, resource_size(&res));\r\nerr_free_cpus:\r\nkfree(cpus);\r\n}

static int swphy_decode_speed(int speed)\r\n{\r\nswitch (speed) {\r\ncase 1000:\r\nreturn SWMII_SPEED_1000;\r\ncase 100:\r\nreturn SWMII_SPEED_100;\r\ncase 10:\r\nreturn SWMII_SPEED_10;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nint swphy_validate_state(const struct fixed_phy_status *state)\r\n{\r\nint err;\r\nif (state->link) {\r\nerr = swphy_decode_speed(state->speed);\r\nif (err < 0) {\r\npr_warn("swphy: unknown speed\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint swphy_read_reg(int reg, const struct fixed_phy_status *state)\r\n{\r\nint speed_index, duplex_index;\r\nu16 bmsr = BMSR_ANEGCAPABLE;\r\nu16 bmcr = 0;\r\nu16 lpagb = 0;\r\nu16 lpa = 0;\r\nif (reg > MII_REGS_NUM)\r\nreturn -1;\r\nspeed_index = swphy_decode_speed(state->speed);\r\nif (WARN_ON(speed_index < 0))\r\nreturn 0;\r\nduplex_index = state->duplex ? SWMII_DUPLEX_FULL : SWMII_DUPLEX_HALF;\r\nbmsr |= speed[speed_index].bmsr & duplex[duplex_index].bmsr;\r\nif (state->link) {\r\nbmsr |= BMSR_LSTATUS | BMSR_ANEGCOMPLETE;\r\nbmcr |= speed[speed_index].bmcr & duplex[duplex_index].bmcr;\r\nlpa |= speed[speed_index].lpa & duplex[duplex_index].lpa;\r\nlpagb |= speed[speed_index].lpagb & duplex[duplex_index].lpagb;\r\nif (state->pause)\r\nlpa |= LPA_PAUSE_CAP;\r\nif (state->asym_pause)\r\nlpa |= LPA_PAUSE_ASYM;\r\n}\r\nswitch (reg) {\r\ncase MII_BMCR:\r\nreturn bmcr;\r\ncase MII_BMSR:\r\nreturn bmsr;\r\ncase MII_PHYSID1:\r\ncase MII_PHYSID2:\r\nreturn 0;\r\ncase MII_LPA:\r\nreturn lpa;\r\ncase MII_STAT1000:\r\nreturn lpagb;\r\ncase MII_MMD_CTRL:\r\ncase MII_MMD_DATA:\r\nreturn -1;\r\ndefault:\r\nreturn 0xffff;\r\n}\r\n}

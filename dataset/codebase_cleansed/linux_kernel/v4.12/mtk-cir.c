static void mtk_w32_mask(struct mtk_ir *ir, u32 val, u32 mask, unsigned int reg)\r\n{\r\nu32 tmp;\r\ntmp = __raw_readl(ir->base + reg);\r\ntmp = (tmp & ~mask) | val;\r\n__raw_writel(tmp, ir->base + reg);\r\n}\r\nstatic void mtk_w32(struct mtk_ir *ir, u32 val, unsigned int reg)\r\n{\r\n__raw_writel(val, ir->base + reg);\r\n}\r\nstatic u32 mtk_r32(struct mtk_ir *ir, unsigned int reg)\r\n{\r\nreturn __raw_readl(ir->base + reg);\r\n}\r\nstatic inline void mtk_irq_disable(struct mtk_ir *ir, u32 mask)\r\n{\r\nu32 val;\r\nval = mtk_r32(ir, MTK_IRINT_EN_REG);\r\nmtk_w32(ir, val & ~mask, MTK_IRINT_EN_REG);\r\n}\r\nstatic inline void mtk_irq_enable(struct mtk_ir *ir, u32 mask)\r\n{\r\nu32 val;\r\nval = mtk_r32(ir, MTK_IRINT_EN_REG);\r\nmtk_w32(ir, val | mask, MTK_IRINT_EN_REG);\r\n}\r\nstatic irqreturn_t mtk_ir_irq(int irqno, void *dev_id)\r\n{\r\nstruct mtk_ir *ir = dev_id;\r\nu8 wid = 0;\r\nu32 i, j, val;\r\nDEFINE_IR_RAW_EVENT(rawir);\r\nir_raw_event_reset(ir->rc);\r\nrawir.pulse = false;\r\nfor (i = 0 ; i < MTK_CHKDATA_SZ ; i++) {\r\nval = mtk_r32(ir, MTK_CHKDATA_REG(i));\r\ndev_dbg(ir->dev, "@reg%d=0x%08x\n", i, val);\r\nfor (j = 0 ; j < 4 ; j++) {\r\nwid = (val & (MTK_WIDTH_MASK << j * 8)) >> j * 8;\r\nrawir.pulse = !rawir.pulse;\r\nrawir.duration = wid * (MTK_IR_SAMPLE + 1);\r\nir_raw_event_store_with_filter(ir->rc, &rawir);\r\n}\r\n}\r\nif (!MTK_IR_END(wid, rawir.pulse)) {\r\nrawir.pulse = false;\r\nrawir.duration = MTK_MAX_SAMPLES * (MTK_IR_SAMPLE + 1);\r\nir_raw_event_store_with_filter(ir->rc, &rawir);\r\n}\r\nir_raw_event_handle(ir->rc);\r\nmtk_w32_mask(ir, 0x1, MTK_IRCLR, MTK_IRCLR_REG);\r\nmtk_w32_mask(ir, 0x1, MTK_IRINT_CLR, MTK_IRINT_CLR_REG);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mtk_ir_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *dn = dev->of_node;\r\nstruct resource *res;\r\nstruct mtk_ir *ir;\r\nu32 val;\r\nint ret = 0;\r\nconst char *map_name;\r\nir = devm_kzalloc(dev, sizeof(struct mtk_ir), GFP_KERNEL);\r\nif (!ir)\r\nreturn -ENOMEM;\r\nir->dev = dev;\r\nif (!of_device_is_compatible(dn, "mediatek,mt7623-cir"))\r\nreturn -ENODEV;\r\nir->clk = devm_clk_get(dev, "clk");\r\nif (IS_ERR(ir->clk)) {\r\ndev_err(dev, "failed to get a ir clock.\n");\r\nreturn PTR_ERR(ir->clk);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nir->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(ir->base)) {\r\ndev_err(dev, "failed to map registers\n");\r\nreturn PTR_ERR(ir->base);\r\n}\r\nir->rc = devm_rc_allocate_device(dev, RC_DRIVER_IR_RAW);\r\nif (!ir->rc) {\r\ndev_err(dev, "failed to allocate device\n");\r\nreturn -ENOMEM;\r\n}\r\nir->rc->priv = ir;\r\nir->rc->input_name = MTK_IR_DEV;\r\nir->rc->input_phys = MTK_IR_DEV "/input0";\r\nir->rc->input_id.bustype = BUS_HOST;\r\nir->rc->input_id.vendor = 0x0001;\r\nir->rc->input_id.product = 0x0001;\r\nir->rc->input_id.version = 0x0001;\r\nmap_name = of_get_property(dn, "linux,rc-map-name", NULL);\r\nir->rc->map_name = map_name ?: RC_MAP_EMPTY;\r\nir->rc->dev.parent = dev;\r\nir->rc->driver_name = MTK_IR_DEV;\r\nir->rc->allowed_protocols = RC_BIT_ALL;\r\nir->rc->rx_resolution = MTK_IR_SAMPLE;\r\nir->rc->timeout = MTK_MAX_SAMPLES * (MTK_IR_SAMPLE + 1);\r\nret = devm_rc_register_device(dev, ir->rc);\r\nif (ret) {\r\ndev_err(dev, "failed to register rc device\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, ir);\r\nir->irq = platform_get_irq(pdev, 0);\r\nif (ir->irq < 0) {\r\ndev_err(dev, "no irq resource\n");\r\nreturn -ENODEV;\r\n}\r\nif (clk_prepare_enable(ir->clk)) {\r\ndev_err(dev, "try to enable ir_clk failed\n");\r\nret = -EINVAL;\r\ngoto exit_clkdisable_clk;\r\n}\r\nmtk_irq_disable(ir, MTK_IRINT_EN);\r\nret = devm_request_irq(dev, ir->irq, mtk_ir_irq, 0, MTK_IR_DEV, ir);\r\nif (ret) {\r\ndev_err(dev, "failed request irq\n");\r\ngoto exit_clkdisable_clk;\r\n}\r\nval = mtk_r32(ir, MTK_CONFIG_HIGH_REG);\r\nval |= MTK_PWM_EN | MTK_IR_EN;\r\nmtk_w32(ir, val, MTK_CONFIG_HIGH_REG);\r\nmtk_w32_mask(ir, MTK_CHK_PERIOD, MTK_CHK_PERIOD_MASK,\r\nMTK_CONFIG_LOW_REG);\r\nmtk_irq_enable(ir, MTK_IRINT_EN);\r\ndev_info(dev, "Initialized MT7623 IR driver, sample period = %luus\n",\r\nDIV_ROUND_CLOSEST(MTK_IR_SAMPLE, 1000));\r\nreturn 0;\r\nexit_clkdisable_clk:\r\nclk_disable_unprepare(ir->clk);\r\nreturn ret;\r\n}\r\nstatic int mtk_ir_remove(struct platform_device *pdev)\r\n{\r\nstruct mtk_ir *ir = platform_get_drvdata(pdev);\r\nmtk_irq_disable(ir, MTK_IRINT_EN);\r\nsynchronize_irq(ir->irq);\r\nclk_disable_unprepare(ir->clk);\r\nreturn 0;\r\n}

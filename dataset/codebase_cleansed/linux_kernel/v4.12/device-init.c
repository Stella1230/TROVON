static int __init ps3_register_lpm_devices(void)\r\n{\r\nint result;\r\nu64 tmp1;\r\nu64 tmp2;\r\nstruct ps3_system_bus_device *dev;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->match_id = PS3_MATCH_ID_LPM;\r\ndev->dev_type = PS3_DEVICE_TYPE_LPM;\r\nresult = ps3_repository_read_be_node_id(0, &dev->lpm.node_id);\r\nif (result) {\r\npr_debug("%s:%d: ps3_repository_read_be_node_id failed \n",\r\n__func__, __LINE__);\r\ngoto fail_read_repo;\r\n}\r\nresult = ps3_repository_read_lpm_privileges(dev->lpm.node_id, &tmp1,\r\n&dev->lpm.rights);\r\nif (result) {\r\npr_debug("%s:%d: ps3_repository_read_lpm_privileges failed\n",\r\n__func__, __LINE__);\r\ngoto fail_read_repo;\r\n}\r\nlv1_get_logical_partition_id(&tmp2);\r\nif (tmp1 != tmp2) {\r\npr_debug("%s:%d: wrong lpar\n",\r\n__func__, __LINE__);\r\nresult = -ENODEV;\r\ngoto fail_rights;\r\n}\r\nif (!(dev->lpm.rights & PS3_LPM_RIGHTS_USE_LPM)) {\r\npr_debug("%s:%d: don't have rights to use lpm\n",\r\n__func__, __LINE__);\r\nresult = -EPERM;\r\ngoto fail_rights;\r\n}\r\npr_debug("%s:%d: pu_id %llu, rights %llu(%llxh)\n",\r\n__func__, __LINE__, dev->lpm.pu_id, dev->lpm.rights,\r\ndev->lpm.rights);\r\nresult = ps3_repository_read_pu_id(0, &dev->lpm.pu_id);\r\nif (result) {\r\npr_debug("%s:%d: ps3_repository_read_pu_id failed \n",\r\n__func__, __LINE__);\r\ngoto fail_read_repo;\r\n}\r\nresult = ps3_system_bus_device_register(dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_register:\r\nfail_rights:\r\nfail_read_repo:\r\nkfree(dev);\r\npr_debug(" <- %s:%d: failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_setup_gelic_device(\r\nconst struct ps3_repository_device *repo)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\nstruct ps3_dma_region d_region;\r\n} *p;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nBUG_ON(repo->bus_type != PS3_BUS_TYPE_SB);\r\nBUG_ON(repo->dev_type != PS3_DEV_TYPE_SB_GELIC);\r\np = kzalloc(sizeof(struct layout), GFP_KERNEL);\r\nif (!p) {\r\nresult = -ENOMEM;\r\ngoto fail_malloc;\r\n}\r\np->dev.match_id = PS3_MATCH_ID_GELIC;\r\np->dev.dev_type = PS3_DEVICE_TYPE_SB;\r\np->dev.bus_id = repo->bus_id;\r\np->dev.dev_id = repo->dev_id;\r\np->dev.d_region = &p->d_region;\r\nresult = ps3_repository_find_interrupt(repo,\r\nPS3_INTERRUPT_TYPE_EVENT_PORT, &p->dev.interrupt_id);\r\nif (result) {\r\npr_debug("%s:%d ps3_repository_find_interrupt failed\n",\r\n__func__, __LINE__);\r\ngoto fail_find_interrupt;\r\n}\r\nBUG_ON(p->dev.interrupt_id != 0);\r\nresult = ps3_dma_region_init(&p->dev, p->dev.d_region, PS3_DMA_64K,\r\nPS3_DMA_OTHER, NULL, 0);\r\nif (result) {\r\npr_debug("%s:%d ps3_dma_region_init failed\n",\r\n__func__, __LINE__);\r\ngoto fail_dma_init;\r\n}\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\nfail_device_register:\r\nfail_dma_init:\r\nfail_find_interrupt:\r\nkfree(p);\r\nfail_malloc:\r\npr_debug(" <- %s:%d: fail.\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __ref ps3_setup_uhc_device(\r\nconst struct ps3_repository_device *repo, enum ps3_match_id match_id,\r\nenum ps3_interrupt_type interrupt_type, enum ps3_reg_type reg_type)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\nstruct ps3_dma_region d_region;\r\nstruct ps3_mmio_region m_region;\r\n} *p;\r\nu64 bus_addr;\r\nu64 len;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nBUG_ON(repo->bus_type != PS3_BUS_TYPE_SB);\r\nBUG_ON(repo->dev_type != PS3_DEV_TYPE_SB_USB);\r\np = kzalloc(sizeof(struct layout), GFP_KERNEL);\r\nif (!p) {\r\nresult = -ENOMEM;\r\ngoto fail_malloc;\r\n}\r\np->dev.match_id = match_id;\r\np->dev.dev_type = PS3_DEVICE_TYPE_SB;\r\np->dev.bus_id = repo->bus_id;\r\np->dev.dev_id = repo->dev_id;\r\np->dev.d_region = &p->d_region;\r\np->dev.m_region = &p->m_region;\r\nresult = ps3_repository_find_interrupt(repo,\r\ninterrupt_type, &p->dev.interrupt_id);\r\nif (result) {\r\npr_debug("%s:%d ps3_repository_find_interrupt failed\n",\r\n__func__, __LINE__);\r\ngoto fail_find_interrupt;\r\n}\r\nresult = ps3_repository_find_reg(repo, reg_type,\r\n&bus_addr, &len);\r\nif (result) {\r\npr_debug("%s:%d ps3_repository_find_reg failed\n",\r\n__func__, __LINE__);\r\ngoto fail_find_reg;\r\n}\r\nresult = ps3_dma_region_init(&p->dev, p->dev.d_region, PS3_DMA_64K,\r\nPS3_DMA_INTERNAL, NULL, 0);\r\nif (result) {\r\npr_debug("%s:%d ps3_dma_region_init failed\n",\r\n__func__, __LINE__);\r\ngoto fail_dma_init;\r\n}\r\nresult = ps3_mmio_region_init(&p->dev, p->dev.m_region, bus_addr, len,\r\nPS3_MMIO_4K);\r\nif (result) {\r\npr_debug("%s:%d ps3_mmio_region_init failed\n",\r\n__func__, __LINE__);\r\ngoto fail_mmio_init;\r\n}\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\nfail_device_register:\r\nfail_mmio_init:\r\nfail_dma_init:\r\nfail_find_reg:\r\nfail_find_interrupt:\r\nkfree(p);\r\nfail_malloc:\r\npr_debug(" <- %s:%d: fail.\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_setup_ehci_device(\r\nconst struct ps3_repository_device *repo)\r\n{\r\nreturn ps3_setup_uhc_device(repo, PS3_MATCH_ID_EHCI,\r\nPS3_INTERRUPT_TYPE_SB_EHCI, PS3_REG_TYPE_SB_EHCI);\r\n}\r\nstatic int __init ps3_setup_ohci_device(\r\nconst struct ps3_repository_device *repo)\r\n{\r\nreturn ps3_setup_uhc_device(repo, PS3_MATCH_ID_OHCI,\r\nPS3_INTERRUPT_TYPE_SB_OHCI, PS3_REG_TYPE_SB_OHCI);\r\n}\r\nstatic int __init ps3_setup_vuart_device(enum ps3_match_id match_id,\r\nunsigned int port_number)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\n} *p;\r\npr_debug(" -> %s:%d: match_id %u, port %u\n", __func__, __LINE__,\r\nmatch_id, port_number);\r\np = kzalloc(sizeof(struct layout), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\np->dev.match_id = match_id;\r\np->dev.dev_type = PS3_DEVICE_TYPE_VUART;\r\np->dev.port_number = port_number;\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_device_register:\r\nkfree(p);\r\npr_debug(" <- %s:%d fail\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int ps3_setup_storage_dev(const struct ps3_repository_device *repo,\r\nenum ps3_match_id match_id)\r\n{\r\nint result;\r\nstruct ps3_storage_device *p;\r\nu64 port, blk_size, num_blocks;\r\nunsigned int num_regions, i;\r\npr_debug(" -> %s:%u: match_id %u\n", __func__, __LINE__, match_id);\r\nresult = ps3_repository_read_stor_dev_info(repo->bus_index,\r\nrepo->dev_index, &port,\r\n&blk_size, &num_blocks,\r\n&num_regions);\r\nif (result) {\r\nprintk(KERN_ERR "%s:%u: _read_stor_dev_info failed %d\n",\r\n__func__, __LINE__, result);\r\nreturn -ENODEV;\r\n}\r\npr_debug("%s:%u: (%u:%u:%u): port %llu blk_size %llu num_blocks %llu "\r\n"num_regions %u\n", __func__, __LINE__, repo->bus_index,\r\nrepo->dev_index, repo->dev_type, port, blk_size, num_blocks,\r\nnum_regions);\r\np = kzalloc(sizeof(struct ps3_storage_device) +\r\nnum_regions * sizeof(struct ps3_storage_region),\r\nGFP_KERNEL);\r\nif (!p) {\r\nresult = -ENOMEM;\r\ngoto fail_malloc;\r\n}\r\np->sbd.match_id = match_id;\r\np->sbd.dev_type = PS3_DEVICE_TYPE_SB;\r\np->sbd.bus_id = repo->bus_id;\r\np->sbd.dev_id = repo->dev_id;\r\np->sbd.d_region = &p->dma_region;\r\np->blk_size = blk_size;\r\np->num_regions = num_regions;\r\nresult = ps3_repository_find_interrupt(repo,\r\nPS3_INTERRUPT_TYPE_EVENT_PORT,\r\n&p->sbd.interrupt_id);\r\nif (result) {\r\nprintk(KERN_ERR "%s:%u: find_interrupt failed %d\n", __func__,\r\n__LINE__, result);\r\nresult = -ENODEV;\r\ngoto fail_find_interrupt;\r\n}\r\nfor (i = 0; i < num_regions; i++) {\r\nunsigned int id;\r\nu64 start, size;\r\nresult = ps3_repository_read_stor_dev_region(repo->bus_index,\r\nrepo->dev_index,\r\ni, &id, &start,\r\n&size);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"%s:%u: read_stor_dev_region failed %d\n",\r\n__func__, __LINE__, result);\r\nresult = -ENODEV;\r\ngoto fail_read_region;\r\n}\r\npr_debug("%s:%u: region %u: id %u start %llu size %llu\n",\r\n__func__, __LINE__, i, id, start, size);\r\np->regions[i].id = id;\r\np->regions[i].start = start;\r\np->regions[i].size = size;\r\n}\r\nresult = ps3_system_bus_device_register(&p->sbd);\r\nif (result) {\r\npr_debug("%s:%u ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%u\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_device_register:\r\nfail_read_region:\r\nfail_find_interrupt:\r\nkfree(p);\r\nfail_malloc:\r\npr_debug(" <- %s:%u: fail.\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_register_vuart_devices(void)\r\n{\r\nint result;\r\nunsigned int port_number;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nresult = ps3_repository_read_vuart_av_port(&port_number);\r\nif (result)\r\nport_number = 0;\r\nresult = ps3_setup_vuart_device(PS3_MATCH_ID_AV_SETTINGS, port_number);\r\nWARN_ON(result);\r\nresult = ps3_repository_read_vuart_sysmgr_port(&port_number);\r\nif (result)\r\nport_number = 2;\r\nresult = ps3_setup_vuart_device(PS3_MATCH_ID_SYSTEM_MANAGER,\r\nport_number);\r\nWARN_ON(result);\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_register_sound_devices(void)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\nstruct ps3_dma_region d_region;\r\nstruct ps3_mmio_region m_region;\r\n} *p;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\np = kzalloc(sizeof(*p), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\np->dev.match_id = PS3_MATCH_ID_SOUND;\r\np->dev.dev_type = PS3_DEVICE_TYPE_IOC0;\r\np->dev.d_region = &p->d_region;\r\np->dev.m_region = &p->m_region;\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_device_register:\r\nkfree(p);\r\npr_debug(" <- %s:%d failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_register_graphics_devices(void)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\n} *p;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\np = kzalloc(sizeof(struct layout), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\np->dev.match_id = PS3_MATCH_ID_GPU;\r\np->dev.match_sub_id = PS3_MATCH_SUB_ID_GPU_FB;\r\np->dev.dev_type = PS3_DEVICE_TYPE_IOC0;\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_device_register:\r\nkfree(p);\r\npr_debug(" <- %s:%d failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int __init ps3_register_ramdisk_device(void)\r\n{\r\nint result;\r\nstruct layout {\r\nstruct ps3_system_bus_device dev;\r\n} *p;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\np = kzalloc(sizeof(struct layout), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\np->dev.match_id = PS3_MATCH_ID_GPU;\r\np->dev.match_sub_id = PS3_MATCH_SUB_ID_GPU_RAMDISK;\r\np->dev.dev_type = PS3_DEVICE_TYPE_IOC0;\r\nresult = ps3_system_bus_device_register(&p->dev);\r\nif (result) {\r\npr_debug("%s:%d ps3_system_bus_device_register failed\n",\r\n__func__, __LINE__);\r\ngoto fail_device_register;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail_device_register:\r\nkfree(p);\r\npr_debug(" <- %s:%d failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int ps3_setup_dynamic_device(const struct ps3_repository_device *repo)\r\n{\r\nint result;\r\nswitch (repo->dev_type) {\r\ncase PS3_DEV_TYPE_STOR_DISK:\r\nresult = ps3_setup_storage_dev(repo, PS3_MATCH_ID_STOR_DISK);\r\nif (result == -ENODEV) {\r\nresult = 0;\r\npr_debug("%s:%u: not accessible\n", __func__,\r\n__LINE__);\r\n}\r\nif (result)\r\npr_debug("%s:%u ps3_setup_storage_dev failed\n",\r\n__func__, __LINE__);\r\nbreak;\r\ncase PS3_DEV_TYPE_STOR_ROM:\r\nresult = ps3_setup_storage_dev(repo, PS3_MATCH_ID_STOR_ROM);\r\nif (result)\r\npr_debug("%s:%u ps3_setup_storage_dev failed\n",\r\n__func__, __LINE__);\r\nbreak;\r\ncase PS3_DEV_TYPE_STOR_FLASH:\r\nresult = ps3_setup_storage_dev(repo, PS3_MATCH_ID_STOR_FLASH);\r\nif (result)\r\npr_debug("%s:%u ps3_setup_storage_dev failed\n",\r\n__func__, __LINE__);\r\nbreak;\r\ndefault:\r\nresult = 0;\r\npr_debug("%s:%u: unsupported dev_type %u\n", __func__, __LINE__,\r\nrepo->dev_type);\r\n}\r\nreturn result;\r\n}\r\nstatic int __init ps3_setup_static_device(const struct ps3_repository_device *repo)\r\n{\r\nint result;\r\nswitch (repo->dev_type) {\r\ncase PS3_DEV_TYPE_SB_GELIC:\r\nresult = ps3_setup_gelic_device(repo);\r\nif (result) {\r\npr_debug("%s:%d ps3_setup_gelic_device failed\n",\r\n__func__, __LINE__);\r\n}\r\nbreak;\r\ncase PS3_DEV_TYPE_SB_USB:\r\nresult = ps3_setup_ehci_device(repo);\r\nif (result) {\r\npr_debug("%s:%d ps3_setup_ehci_device failed\n",\r\n__func__, __LINE__);\r\n}\r\nresult = ps3_setup_ohci_device(repo);\r\nif (result) {\r\npr_debug("%s:%d ps3_setup_ohci_device failed\n",\r\n__func__, __LINE__);\r\n}\r\nbreak;\r\ndefault:\r\nreturn ps3_setup_dynamic_device(repo);\r\n}\r\nreturn result;\r\n}\r\nstatic void ps3_find_and_add_device(u64 bus_id, u64 dev_id)\r\n{\r\nstruct ps3_repository_device repo;\r\nint res;\r\nunsigned int retries;\r\nunsigned long rem;\r\nfor (retries = 0; retries < 10; retries++) {\r\nres = ps3_repository_find_device_by_id(&repo, bus_id, dev_id);\r\nif (!res)\r\ngoto found;\r\nrem = msleep_interruptible(100);\r\nif (rem)\r\nbreak;\r\n}\r\npr_warning("%s:%u: device %llu:%llu not found\n", __func__, __LINE__,\r\nbus_id, dev_id);\r\nreturn;\r\nfound:\r\nif (retries)\r\npr_debug("%s:%u: device %llu:%llu found after %u retries\n",\r\n__func__, __LINE__, bus_id, dev_id, retries);\r\nps3_setup_dynamic_device(&repo);\r\nreturn;\r\n}\r\nstatic irqreturn_t ps3_notification_interrupt(int irq, void *data)\r\n{\r\nstruct ps3_notification_device *dev = data;\r\nint res;\r\nu64 tag, status;\r\nspin_lock(&dev->lock);\r\nres = lv1_storage_get_async_status(PS3_NOTIFICATION_DEV_ID, &tag,\r\n&status);\r\nif (tag != dev->tag)\r\npr_err("%s:%u: tag mismatch, got %llx, expected %llx\n",\r\n__func__, __LINE__, tag, dev->tag);\r\nif (res) {\r\npr_err("%s:%u: res %d status 0x%llx\n", __func__, __LINE__, res,\r\nstatus);\r\n} else {\r\npr_debug("%s:%u: completed, status 0x%llx\n", __func__,\r\n__LINE__, status);\r\ndev->lv1_status = status;\r\ncomplete(&dev->done);\r\n}\r\nspin_unlock(&dev->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ps3_notification_read_write(struct ps3_notification_device *dev,\r\nu64 lpar, int write)\r\n{\r\nconst char *op = write ? "write" : "read";\r\nunsigned long flags;\r\nint res;\r\ninit_completion(&dev->done);\r\nspin_lock_irqsave(&dev->lock, flags);\r\nres = write ? lv1_storage_write(dev->sbd.dev_id, 0, 0, 1, 0, lpar,\r\n&dev->tag)\r\n: lv1_storage_read(dev->sbd.dev_id, 0, 0, 1, 0, lpar,\r\n&dev->tag);\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nif (res) {\r\npr_err("%s:%u: %s failed %d\n", __func__, __LINE__, op, res);\r\nreturn -EPERM;\r\n}\r\npr_debug("%s:%u: notification %s issued\n", __func__, __LINE__, op);\r\nres = wait_event_interruptible(dev->done.wait,\r\ndev->done.done || kthread_should_stop());\r\nif (kthread_should_stop())\r\nres = -EINTR;\r\nif (res) {\r\npr_debug("%s:%u: interrupted %s\n", __func__, __LINE__, op);\r\nreturn res;\r\n}\r\nif (dev->lv1_status) {\r\npr_err("%s:%u: %s not completed, status 0x%llx\n", __func__,\r\n__LINE__, op, dev->lv1_status);\r\nreturn -EIO;\r\n}\r\npr_debug("%s:%u: notification %s completed\n", __func__, __LINE__, op);\r\nreturn 0;\r\n}\r\nstatic int ps3_probe_thread(void *data)\r\n{\r\nstruct ps3_notification_device dev;\r\nint res;\r\nunsigned int irq;\r\nu64 lpar;\r\nvoid *buf;\r\nstruct ps3_notify_cmd *notify_cmd;\r\nstruct ps3_notify_event *notify_event;\r\npr_debug(" -> %s:%u: kthread started\n", __func__, __LINE__);\r\nbuf = kzalloc(512, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nlpar = ps3_mm_phys_to_lpar(__pa(buf));\r\nnotify_cmd = buf;\r\nnotify_event = buf;\r\ndev.sbd.bus_id = (u64)data;\r\ndev.sbd.dev_id = PS3_NOTIFICATION_DEV_ID;\r\ndev.sbd.interrupt_id = PS3_NOTIFICATION_INTERRUPT_ID;\r\nres = lv1_open_device(dev.sbd.bus_id, dev.sbd.dev_id, 0);\r\nif (res) {\r\npr_err("%s:%u: lv1_open_device failed %s\n", __func__,\r\n__LINE__, ps3_result(res));\r\ngoto fail_free;\r\n}\r\nres = ps3_sb_event_receive_port_setup(&dev.sbd, PS3_BINDING_CPU_ANY,\r\n&irq);\r\nif (res) {\r\npr_err("%s:%u: ps3_sb_event_receive_port_setup failed %d\n",\r\n__func__, __LINE__, res);\r\ngoto fail_close_device;\r\n}\r\nspin_lock_init(&dev.lock);\r\nres = request_irq(irq, ps3_notification_interrupt, 0,\r\n"ps3_notification", &dev);\r\nif (res) {\r\npr_err("%s:%u: request_irq failed %d\n", __func__, __LINE__,\r\nres);\r\ngoto fail_sb_event_receive_port_destroy;\r\n}\r\nnotify_cmd->operation_code = 0;\r\nnotify_cmd->event_mask = 1UL << notify_region_probe;\r\nres = ps3_notification_read_write(&dev, lpar, 1);\r\nif (res)\r\ngoto fail_free_irq;\r\ndo {\r\ntry_to_freeze();\r\nmemset(notify_event, 0, sizeof(*notify_event));\r\nres = ps3_notification_read_write(&dev, lpar, 0);\r\nif (res)\r\nbreak;\r\npr_debug("%s:%u: notify event type 0x%llx bus id %llu dev id %llu"\r\n" type %llu port %llu\n", __func__, __LINE__,\r\nnotify_event->event_type, notify_event->bus_id,\r\nnotify_event->dev_id, notify_event->dev_type,\r\nnotify_event->dev_port);\r\nif (notify_event->event_type != notify_region_probe ||\r\nnotify_event->bus_id != dev.sbd.bus_id) {\r\npr_warning("%s:%u: bad notify_event: event %llu, "\r\n"dev_id %llu, dev_type %llu\n",\r\n__func__, __LINE__, notify_event->event_type,\r\nnotify_event->dev_id,\r\nnotify_event->dev_type);\r\ncontinue;\r\n}\r\nps3_find_and_add_device(dev.sbd.bus_id, notify_event->dev_id);\r\n} while (!kthread_should_stop());\r\nfail_free_irq:\r\nfree_irq(irq, &dev);\r\nfail_sb_event_receive_port_destroy:\r\nps3_sb_event_receive_port_destroy(&dev.sbd, irq);\r\nfail_close_device:\r\nlv1_close_device(dev.sbd.bus_id, dev.sbd.dev_id);\r\nfail_free:\r\nkfree(buf);\r\nprobe_task = NULL;\r\npr_debug(" <- %s:%u: kthread finished\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic int ps3_stop_probe_thread(struct notifier_block *nb, unsigned long code,\r\nvoid *data)\r\n{\r\nif (probe_task)\r\nkthread_stop(probe_task);\r\nreturn 0;\r\n}\r\nstatic int __init ps3_start_probe_thread(enum ps3_bus_type bus_type)\r\n{\r\nint result;\r\nstruct task_struct *task;\r\nstruct ps3_repository_device repo;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nmemset(&repo, 0, sizeof(repo));\r\nrepo.bus_type = bus_type;\r\nresult = ps3_repository_find_bus(repo.bus_type, 0, &repo.bus_index);\r\nif (result) {\r\nprintk(KERN_ERR "%s: Cannot find bus (%d)\n", __func__, result);\r\nreturn -ENODEV;\r\n}\r\nresult = ps3_repository_read_bus_id(repo.bus_index, &repo.bus_id);\r\nif (result) {\r\nprintk(KERN_ERR "%s: read_bus_id failed %d\n", __func__,\r\nresult);\r\nreturn -ENODEV;\r\n}\r\ntask = kthread_run(ps3_probe_thread, (void *)repo.bus_id,\r\n"ps3-probe-%u", bus_type);\r\nif (IS_ERR(task)) {\r\nresult = PTR_ERR(task);\r\nprintk(KERN_ERR "%s: kthread_run failed %d\n", __func__,\r\nresult);\r\nreturn result;\r\n}\r\nprobe_task = task;\r\nregister_reboot_notifier(&nb);\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic int __init ps3_register_devices(void)\r\n{\r\nint result;\r\nif (!firmware_has_feature(FW_FEATURE_PS3_LV1))\r\nreturn -ENODEV;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nresult = ps3_start_probe_thread(PS3_BUS_TYPE_STORAGE);\r\nps3_register_vuart_devices();\r\nps3_register_graphics_devices();\r\nps3_repository_find_devices(PS3_BUS_TYPE_SB, ps3_setup_static_device);\r\nps3_register_sound_devices();\r\nps3_register_lpm_devices();\r\nps3_register_ramdisk_device();\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\n}

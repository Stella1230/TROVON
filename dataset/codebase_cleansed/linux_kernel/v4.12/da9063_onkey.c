static void da9063_poll_on(struct work_struct *work)\r\n{\r\nstruct da9063_onkey *onkey = container_of(work,\r\nstruct da9063_onkey,\r\nwork.work);\r\nconst struct da906x_chip_config *config = onkey->config;\r\nunsigned int val;\r\nint fault_log = 0;\r\nbool poll = true;\r\nint error;\r\nerror = regmap_read(onkey->regmap,\r\nconfig->onkey_status,\r\n&val);\r\nif (error) {\r\ndev_err(onkey->dev,\r\n"Failed to read ON status: %d\n", error);\r\ngoto err_poll;\r\n}\r\nif (!(val & config->onkey_nonkey_mask)) {\r\nerror = regmap_update_bits(onkey->regmap,\r\nconfig->onkey_pwr_signalling,\r\nconfig->onkey_nonkey_lock_mask,\r\n0);\r\nif (error) {\r\ndev_err(onkey->dev,\r\n"Failed to reset the Key Delay %d\n", error);\r\ngoto err_poll;\r\n}\r\ninput_report_key(onkey->input, KEY_POWER, 0);\r\ninput_sync(onkey->input);\r\npoll = false;\r\n}\r\nerror = regmap_read(onkey->regmap,\r\nconfig->onkey_fault_log,\r\n&fault_log);\r\nif (error) {\r\ndev_warn(&onkey->input->dev,\r\n"Cannot read FAULT_LOG: %d\n", error);\r\n} else if (fault_log & config->onkey_key_reset_mask) {\r\nerror = regmap_write(onkey->regmap,\r\nconfig->onkey_fault_log,\r\nconfig->onkey_key_reset_mask);\r\nif (error) {\r\ndev_warn(&onkey->input->dev,\r\n"Cannot reset KEY_RESET fault log: %d\n",\r\nerror);\r\n} else {\r\ndev_dbg(&onkey->input->dev,\r\n"Sending SHUTDOWN to PMIC ...\n");\r\nerror = regmap_write(onkey->regmap,\r\nconfig->onkey_shutdown,\r\nconfig->onkey_shutdown_mask);\r\nif (error)\r\ndev_err(&onkey->input->dev,\r\n"Cannot SHUTDOWN PMIC: %d\n",\r\nerror);\r\n}\r\n}\r\nerr_poll:\r\nif (poll)\r\nschedule_delayed_work(&onkey->work, msecs_to_jiffies(50));\r\n}\r\nstatic irqreturn_t da9063_onkey_irq_handler(int irq, void *data)\r\n{\r\nstruct da9063_onkey *onkey = data;\r\nconst struct da906x_chip_config *config = onkey->config;\r\nunsigned int val;\r\nint error;\r\nerror = regmap_read(onkey->regmap,\r\nconfig->onkey_status,\r\n&val);\r\nif (onkey->key_power && !error && (val & config->onkey_nonkey_mask)) {\r\ninput_report_key(onkey->input, KEY_POWER, 1);\r\ninput_sync(onkey->input);\r\nschedule_delayed_work(&onkey->work, 0);\r\ndev_dbg(onkey->dev, "KEY_POWER long press.\n");\r\n} else {\r\ninput_report_key(onkey->input, KEY_POWER, 1);\r\ninput_sync(onkey->input);\r\ninput_report_key(onkey->input, KEY_POWER, 0);\r\ninput_sync(onkey->input);\r\ndev_dbg(onkey->dev, "KEY_POWER short press.\n");\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void da9063_cancel_poll(void *data)\r\n{\r\nstruct da9063_onkey *onkey = data;\r\ncancel_delayed_work_sync(&onkey->work);\r\n}\r\nstatic int da9063_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct da9063 *da9063 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9063_pdata *pdata = dev_get_platdata(da9063->dev);\r\nstruct da9063_onkey *onkey;\r\nconst struct of_device_id *match;\r\nint irq;\r\nint error;\r\nmatch = of_match_node(da9063_compatible_reg_id_table,\r\npdev->dev.of_node);\r\nif (!match)\r\nreturn -ENXIO;\r\nonkey = devm_kzalloc(&pdev->dev, sizeof(struct da9063_onkey),\r\nGFP_KERNEL);\r\nif (!onkey) {\r\ndev_err(&pdev->dev, "Failed to allocate memory.\n");\r\nreturn -ENOMEM;\r\n}\r\nonkey->config = match->data;\r\nonkey->dev = &pdev->dev;\r\nonkey->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!onkey->regmap) {\r\ndev_err(&pdev->dev, "Parent regmap unavailable.\n");\r\nreturn -ENXIO;\r\n}\r\nif (pdata)\r\nonkey->key_power = pdata->key_power;\r\nelse\r\nonkey->key_power =\r\n!of_property_read_bool(pdev->dev.of_node,\r\n"dlg,disable-key-power");\r\nonkey->input = devm_input_allocate_device(&pdev->dev);\r\nif (!onkey->input) {\r\ndev_err(&pdev->dev, "Failed to allocated input device.\n");\r\nreturn -ENOMEM;\r\n}\r\nonkey->input->name = onkey->config->name;\r\nsnprintf(onkey->phys, sizeof(onkey->phys), "%s/input0",\r\nonkey->config->name);\r\nonkey->input->phys = onkey->phys;\r\nonkey->input->dev.parent = &pdev->dev;\r\nif (onkey->key_power)\r\ninput_set_capability(onkey->input, EV_KEY, KEY_POWER);\r\ninput_set_capability(onkey->input, EV_KEY, KEY_SLEEP);\r\nINIT_DELAYED_WORK(&onkey->work, da9063_poll_on);\r\nerror = devm_add_action(&pdev->dev, da9063_cancel_poll, onkey);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to add cancel poll action: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nirq = platform_get_irq_byname(pdev, "ONKEY");\r\nif (irq < 0) {\r\nerror = irq;\r\ndev_err(&pdev->dev, "Failed to get platform IRQ: %d\n", error);\r\nreturn error;\r\n}\r\nerror = devm_request_threaded_irq(&pdev->dev, irq,\r\nNULL, da9063_onkey_irq_handler,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"ONKEY", onkey);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to request IRQ %d: %d\n", irq, error);\r\nreturn error;\r\n}\r\nerror = input_register_device(onkey->input);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to register input device: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

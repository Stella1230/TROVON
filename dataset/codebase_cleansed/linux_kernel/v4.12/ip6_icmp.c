int inet6_register_icmp_sender(ip6_icmp_send_t *fn)\r\n{\r\nreturn (cmpxchg((ip6_icmp_send_t **)&ip6_icmp_send, NULL, fn) == NULL) ?\r\n0 : -EBUSY;\r\n}\r\nint inet6_unregister_icmp_sender(ip6_icmp_send_t *fn)\r\n{\r\nint ret;\r\nret = (cmpxchg((ip6_icmp_send_t **)&ip6_icmp_send, fn, NULL) == fn) ?\r\n0 : -EINVAL;\r\nsynchronize_net();\r\nreturn ret;\r\n}\r\nvoid icmpv6_send(struct sk_buff *skb, u8 type, u8 code, __u32 info)\r\n{\r\nip6_icmp_send_t *send;\r\nrcu_read_lock();\r\nsend = rcu_dereference(ip6_icmp_send);\r\nif (!send)\r\ngoto out;\r\nsend(skb, type, code, info, NULL);\r\nout:\r\nrcu_read_unlock();\r\n}

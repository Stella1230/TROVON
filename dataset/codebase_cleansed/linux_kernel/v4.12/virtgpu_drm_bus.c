static void virtio_pci_kick_out_firmware_fb(struct pci_dev *pci_dev)\r\n{\r\nstruct apertures_struct *ap;\r\nbool primary;\r\nap = alloc_apertures(1);\r\nif (!ap)\r\nreturn;\r\nap->ranges[0].base = pci_resource_start(pci_dev, 0);\r\nap->ranges[0].size = pci_resource_len(pci_dev, 0);\r\nprimary = pci_dev->resource[PCI_ROM_RESOURCE].flags\r\n& IORESOURCE_ROM_SHADOW;\r\ndrm_fb_helper_remove_conflicting_framebuffers(ap, "virtiodrmfb", primary);\r\nkfree(ap);\r\n}\r\nint drm_virtio_init(struct drm_driver *driver, struct virtio_device *vdev)\r\n{\r\nstruct drm_device *dev;\r\nint ret;\r\ndev = drm_dev_alloc(driver, &vdev->dev);\r\nif (IS_ERR(dev))\r\nreturn PTR_ERR(dev);\r\ndev->virtdev = vdev;\r\nvdev->priv = dev;\r\nif (strcmp(vdev->dev.parent->bus->name, "pci") == 0) {\r\nstruct pci_dev *pdev = to_pci_dev(vdev->dev.parent);\r\nconst char *pname = dev_name(&pdev->dev);\r\nbool vga = (pdev->class >> 8) == PCI_CLASS_DISPLAY_VGA;\r\nchar unique[20];\r\nDRM_INFO("pci: %s detected at %s\n",\r\nvga ? "virtio-vga" : "virtio-gpu-pci",\r\npname);\r\ndev->pdev = pdev;\r\nif (vga)\r\nvirtio_pci_kick_out_firmware_fb(pdev);\r\nsnprintf(unique, sizeof(unique), "pci:%s", pname);\r\nret = drm_dev_set_unique(dev, unique);\r\nif (ret)\r\ngoto err_free;\r\n}\r\nret = drm_dev_register(dev, 0);\r\nif (ret)\r\ngoto err_free;\r\nreturn 0;\r\nerr_free:\r\ndrm_dev_unref(dev);\r\nreturn ret;\r\n}

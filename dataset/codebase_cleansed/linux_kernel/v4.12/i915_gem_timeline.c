static int __i915_gem_timeline_init(struct drm_i915_private *i915,\r\nstruct i915_gem_timeline *timeline,\r\nconst char *name,\r\nstruct lock_class_key *lockclass,\r\nconst char *lockname)\r\n{\r\nunsigned int i;\r\nu64 fences;\r\nlockdep_assert_held(&i915->drm.struct_mutex);\r\ntimeline->i915 = i915;\r\ntimeline->name = kstrdup(name ?: "[kernel]", GFP_KERNEL);\r\nif (!timeline->name)\r\nreturn -ENOMEM;\r\nlist_add(&timeline->link, &i915->gt.timelines);\r\nfences = dma_fence_context_alloc(ARRAY_SIZE(timeline->engine));\r\nfor (i = 0; i < ARRAY_SIZE(timeline->engine); i++) {\r\nstruct intel_timeline *tl = &timeline->engine[i];\r\ntl->fence_context = fences++;\r\ntl->common = timeline;\r\n#ifdef CONFIG_DEBUG_SPINLOCK\r\n__raw_spin_lock_init(&tl->lock.rlock, lockname, lockclass);\r\n#else\r\nspin_lock_init(&tl->lock);\r\n#endif\r\ninit_request_active(&tl->last_request, NULL);\r\nINIT_LIST_HEAD(&tl->requests);\r\n}\r\nreturn 0;\r\n}\r\nint i915_gem_timeline_init(struct drm_i915_private *i915,\r\nstruct i915_gem_timeline *timeline,\r\nconst char *name)\r\n{\r\nstatic struct lock_class_key class;\r\nreturn __i915_gem_timeline_init(i915, timeline, name,\r\n&class, "&timeline->lock");\r\n}\r\nint i915_gem_timeline_init__global(struct drm_i915_private *i915)\r\n{\r\nstatic struct lock_class_key class;\r\nreturn __i915_gem_timeline_init(i915,\r\n&i915->gt.global_timeline,\r\n"[execution]",\r\n&class, "&global_timeline->lock");\r\n}\r\nvoid i915_gem_timeline_fini(struct i915_gem_timeline *timeline)\r\n{\r\nint i;\r\nlockdep_assert_held(&timeline->i915->drm.struct_mutex);\r\nfor (i = 0; i < ARRAY_SIZE(timeline->engine); i++) {\r\nstruct intel_timeline *tl = &timeline->engine[i];\r\nGEM_BUG_ON(!list_empty(&tl->requests));\r\n}\r\nlist_del(&timeline->link);\r\nkfree(timeline->name);\r\n}

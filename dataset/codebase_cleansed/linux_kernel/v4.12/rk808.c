static bool rk808_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RK808_SECONDS_REG ... RK808_WEEKS_REG:\r\ncase RK808_RTC_STATUS_REG:\r\ncase RK808_VB_MON_REG:\r\ncase RK808_THERMAL_REG:\r\ncase RK808_DCDC_UV_STS_REG:\r\ncase RK808_LDO_UV_STS_REG:\r\ncase RK808_DCDC_PG_REG:\r\ncase RK808_LDO_PG_REG:\r\ncase RK808_DEVCTRL_REG:\r\ncase RK808_INT_STS_REG1:\r\ncase RK808_INT_STS_REG2:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void rk808_device_shutdown(void)\r\n{\r\nint ret;\r\nstruct rk808 *rk808 = i2c_get_clientdata(rk808_i2c_client);\r\nif (!rk808) {\r\ndev_warn(&rk808_i2c_client->dev,\r\n"have no rk808, so do nothing here\n");\r\nreturn;\r\n}\r\nret = regmap_update_bits(rk808->regmap,\r\nRK808_DEVCTRL_REG,\r\nDEV_OFF_RST, DEV_OFF_RST);\r\nif (ret)\r\ndev_err(&rk808_i2c_client->dev, "power off error!\n");\r\n}\r\nstatic void rk818_device_shutdown(void)\r\n{\r\nint ret;\r\nstruct rk808 *rk808 = i2c_get_clientdata(rk808_i2c_client);\r\nif (!rk808) {\r\ndev_warn(&rk808_i2c_client->dev,\r\n"have no rk818, so do nothing here\n");\r\nreturn;\r\n}\r\nret = regmap_update_bits(rk808->regmap,\r\nRK818_DEVCTRL_REG,\r\nDEV_OFF, DEV_OFF);\r\nif (ret)\r\ndev_err(&rk808_i2c_client->dev, "power off error!\n");\r\n}\r\nstatic int rk808_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device_node *np = client->dev.of_node;\r\nstruct rk808 *rk808;\r\nconst struct rk808_reg_data *pre_init_reg;\r\nconst struct mfd_cell *cells;\r\nvoid (*pm_pwroff_fn)(void);\r\nint nr_pre_init_regs;\r\nint nr_cells;\r\nint pm_off = 0;\r\nint ret;\r\nint i;\r\nrk808 = devm_kzalloc(&client->dev, sizeof(*rk808), GFP_KERNEL);\r\nif (!rk808)\r\nreturn -ENOMEM;\r\nrk808->variant = i2c_smbus_read_word_data(client, RK808_ID_MSB);\r\nif (rk808->variant < 0) {\r\ndev_err(&client->dev, "Failed to read the chip id at 0x%02x\n",\r\nRK808_ID_MSB);\r\nreturn rk808->variant;\r\n}\r\ndev_dbg(&client->dev, "Chip id: 0x%x\n", (unsigned int)rk808->variant);\r\nswitch (rk808->variant) {\r\ncase RK808_ID:\r\nrk808->regmap_cfg = &rk808_regmap_config;\r\nrk808->regmap_irq_chip = &rk808_irq_chip;\r\npre_init_reg = rk808_pre_init_reg;\r\nnr_pre_init_regs = ARRAY_SIZE(rk808_pre_init_reg);\r\ncells = rk808s;\r\nnr_cells = ARRAY_SIZE(rk808s);\r\npm_pwroff_fn = rk808_device_shutdown;\r\nbreak;\r\ncase RK818_ID:\r\nrk808->regmap_cfg = &rk818_regmap_config;\r\nrk808->regmap_irq_chip = &rk818_irq_chip;\r\npre_init_reg = rk818_pre_init_reg;\r\nnr_pre_init_regs = ARRAY_SIZE(rk818_pre_init_reg);\r\ncells = rk818s;\r\nnr_cells = ARRAY_SIZE(rk818s);\r\npm_pwroff_fn = rk818_device_shutdown;\r\nbreak;\r\ndefault:\r\ndev_err(&client->dev, "Unsupported RK8XX ID %lu\n",\r\nrk808->variant);\r\nreturn -EINVAL;\r\n}\r\nrk808->i2c = client;\r\ni2c_set_clientdata(client, rk808);\r\nrk808->regmap = devm_regmap_init_i2c(client, rk808->regmap_cfg);\r\nif (IS_ERR(rk808->regmap)) {\r\ndev_err(&client->dev, "regmap initialization failed\n");\r\nreturn PTR_ERR(rk808->regmap);\r\n}\r\nif (!client->irq) {\r\ndev_err(&client->dev, "No interrupt support, no core IRQ\n");\r\nreturn -EINVAL;\r\n}\r\nret = regmap_add_irq_chip(rk808->regmap, client->irq,\r\nIRQF_ONESHOT, -1,\r\nrk808->regmap_irq_chip, &rk808->irq_data);\r\nif (ret) {\r\ndev_err(&client->dev, "Failed to add irq_chip %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < nr_pre_init_regs; i++) {\r\nret = regmap_update_bits(rk808->regmap,\r\npre_init_reg[i].addr,\r\npre_init_reg[i].mask,\r\npre_init_reg[i].value);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"0x%x write err\n",\r\npre_init_reg[i].addr);\r\nreturn ret;\r\n}\r\n}\r\nret = devm_mfd_add_devices(&client->dev, PLATFORM_DEVID_NONE,\r\ncells, nr_cells, NULL, 0,\r\nregmap_irq_get_domain(rk808->irq_data));\r\nif (ret) {\r\ndev_err(&client->dev, "failed to add MFD devices %d\n", ret);\r\ngoto err_irq;\r\n}\r\npm_off = of_property_read_bool(np,\r\n"rockchip,system-power-controller");\r\nif (pm_off && !pm_power_off) {\r\nrk808_i2c_client = client;\r\npm_power_off = pm_pwroff_fn;\r\n}\r\nreturn 0;\r\nerr_irq:\r\nregmap_del_irq_chip(client->irq, rk808->irq_data);\r\nreturn ret;\r\n}\r\nstatic int rk808_remove(struct i2c_client *client)\r\n{\r\nstruct rk808 *rk808 = i2c_get_clientdata(client);\r\nregmap_del_irq_chip(client->irq, rk808->irq_data);\r\npm_power_off = NULL;\r\nreturn 0;\r\n}

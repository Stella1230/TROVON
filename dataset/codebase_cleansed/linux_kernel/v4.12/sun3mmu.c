void __init paging_init(void)\r\n{\r\npgd_t * pg_dir;\r\npte_t * pg_table;\r\nint i;\r\nunsigned long address;\r\nunsigned long next_pgtable;\r\nunsigned long bootmem_end;\r\nunsigned long zones_size[MAX_NR_ZONES] = { 0, };\r\nunsigned long size;\r\nempty_zero_page = alloc_bootmem_pages(PAGE_SIZE);\r\naddress = PAGE_OFFSET;\r\npg_dir = swapper_pg_dir;\r\nmemset (swapper_pg_dir, 0, sizeof (swapper_pg_dir));\r\nmemset (kernel_pg_dir, 0, sizeof (kernel_pg_dir));\r\nsize = num_pages * sizeof(pte_t);\r\nsize = (size + PAGE_SIZE) & ~(PAGE_SIZE-1);\r\nnext_pgtable = (unsigned long)alloc_bootmem_pages(size);\r\nbootmem_end = (next_pgtable + size + PAGE_SIZE) & PAGE_MASK;\r\npg_dir += PAGE_OFFSET >> PGDIR_SHIFT;\r\nwhile (address < (unsigned long)high_memory) {\r\npg_table = (pte_t *) __pa (next_pgtable);\r\nnext_pgtable += PTRS_PER_PTE * sizeof (pte_t);\r\npgd_val(*pg_dir) = (unsigned long) pg_table;\r\npg_dir++;\r\npg_table = (pte_t *) __va ((unsigned long) pg_table);\r\nfor (i=0; i<PTRS_PER_PTE; ++i, ++pg_table) {\r\npte_t pte = pfn_pte(virt_to_pfn(address), PAGE_INIT);\r\nif (address >= (unsigned long)high_memory)\r\npte_val (pte) = 0;\r\nset_pte (pg_table, pte);\r\naddress += PAGE_SIZE;\r\n}\r\n}\r\nmmu_emu_init(bootmem_end);\r\ncurrent->mm = NULL;\r\nzones_size[ZONE_DMA] = ((unsigned long)high_memory - PAGE_OFFSET) >> PAGE_SHIFT;\r\nfree_area_init_node(0, zones_size,\r\n(__pa(PAGE_OFFSET) >> PAGE_SHIFT) + 1, NULL);\r\n}

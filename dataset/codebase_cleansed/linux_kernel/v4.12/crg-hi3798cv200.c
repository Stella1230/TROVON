static struct hisi_clock_data *hi3798cv200_clk_register(\r\nstruct platform_device *pdev)\r\n{\r\nstruct hisi_clock_data *clk_data;\r\nint ret;\r\nclk_data = hisi_clk_alloc(pdev, HI3798CV200_CRG_NR_CLKS);\r\nif (!clk_data)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = hisi_clk_register_fixed_rate(hi3798cv200_fixed_rate_clks,\r\nARRAY_SIZE(hi3798cv200_fixed_rate_clks),\r\nclk_data);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nret = hisi_clk_register_mux(hi3798cv200_mux_clks,\r\nARRAY_SIZE(hi3798cv200_mux_clks),\r\nclk_data);\r\nif (ret)\r\ngoto unregister_fixed_rate;\r\nret = hisi_clk_register_gate(hi3798cv200_gate_clks,\r\nARRAY_SIZE(hi3798cv200_gate_clks),\r\nclk_data);\r\nif (ret)\r\ngoto unregister_mux;\r\nret = of_clk_add_provider(pdev->dev.of_node,\r\nof_clk_src_onecell_get, &clk_data->clk_data);\r\nif (ret)\r\ngoto unregister_gate;\r\nreturn clk_data;\r\nunregister_fixed_rate:\r\nhisi_clk_unregister_fixed_rate(hi3798cv200_fixed_rate_clks,\r\nARRAY_SIZE(hi3798cv200_fixed_rate_clks),\r\nclk_data);\r\nunregister_mux:\r\nhisi_clk_unregister_mux(hi3798cv200_mux_clks,\r\nARRAY_SIZE(hi3798cv200_mux_clks),\r\nclk_data);\r\nunregister_gate:\r\nhisi_clk_unregister_gate(hi3798cv200_gate_clks,\r\nARRAY_SIZE(hi3798cv200_gate_clks),\r\nclk_data);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void hi3798cv200_clk_unregister(struct platform_device *pdev)\r\n{\r\nstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\r\nof_clk_del_provider(pdev->dev.of_node);\r\nhisi_clk_unregister_gate(hi3798cv200_gate_clks,\r\nARRAY_SIZE(hi3798cv200_gate_clks),\r\ncrg->clk_data);\r\nhisi_clk_unregister_mux(hi3798cv200_mux_clks,\r\nARRAY_SIZE(hi3798cv200_mux_clks),\r\ncrg->clk_data);\r\nhisi_clk_unregister_fixed_rate(hi3798cv200_fixed_rate_clks,\r\nARRAY_SIZE(hi3798cv200_fixed_rate_clks),\r\ncrg->clk_data);\r\n}\r\nstatic struct hisi_clock_data *hi3798cv200_sysctrl_clk_register(\r\nstruct platform_device *pdev)\r\n{\r\nstruct hisi_clock_data *clk_data;\r\nint ret;\r\nclk_data = hisi_clk_alloc(pdev, HI3798CV200_SYSCTRL_NR_CLKS);\r\nif (!clk_data)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = hisi_clk_register_gate(hi3798cv200_sysctrl_gate_clks,\r\nARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\r\nclk_data);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nret = of_clk_add_provider(pdev->dev.of_node,\r\nof_clk_src_onecell_get, &clk_data->clk_data);\r\nif (ret)\r\ngoto unregister_gate;\r\nreturn clk_data;\r\nunregister_gate:\r\nhisi_clk_unregister_gate(hi3798cv200_sysctrl_gate_clks,\r\nARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\r\nclk_data);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void hi3798cv200_sysctrl_clk_unregister(struct platform_device *pdev)\r\n{\r\nstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\r\nof_clk_del_provider(pdev->dev.of_node);\r\nhisi_clk_unregister_gate(hi3798cv200_sysctrl_gate_clks,\r\nARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\r\ncrg->clk_data);\r\n}\r\nstatic int hi3798cv200_crg_probe(struct platform_device *pdev)\r\n{\r\nstruct hisi_crg_dev *crg;\r\ncrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\r\nif (!crg)\r\nreturn -ENOMEM;\r\ncrg->funcs = of_device_get_match_data(&pdev->dev);\r\nif (!crg->funcs)\r\nreturn -ENOENT;\r\ncrg->rstc = hisi_reset_init(pdev);\r\nif (!crg->rstc)\r\nreturn -ENOMEM;\r\ncrg->clk_data = crg->funcs->register_clks(pdev);\r\nif (IS_ERR(crg->clk_data)) {\r\nhisi_reset_exit(crg->rstc);\r\nreturn PTR_ERR(crg->clk_data);\r\n}\r\nplatform_set_drvdata(pdev, crg);\r\nreturn 0;\r\n}\r\nstatic int hi3798cv200_crg_remove(struct platform_device *pdev)\r\n{\r\nstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\r\nhisi_reset_exit(crg->rstc);\r\ncrg->funcs->unregister_clks(pdev);\r\nreturn 0;\r\n}\r\nstatic int __init hi3798cv200_crg_init(void)\r\n{\r\nreturn platform_driver_register(&hi3798cv200_crg_driver);\r\n}\r\nstatic void __exit hi3798cv200_crg_exit(void)\r\n{\r\nplatform_driver_unregister(&hi3798cv200_crg_driver);\r\n}

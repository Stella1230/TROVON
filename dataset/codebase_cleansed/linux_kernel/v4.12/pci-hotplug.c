static struct pci_bus *find_bus_among_children(struct pci_bus *bus,\r\nstruct device_node *dn)\r\n{\r\nstruct pci_bus *child = NULL;\r\nstruct pci_bus *tmp;\r\nif (pci_bus_to_OF_node(bus) == dn)\r\nreturn bus;\r\nlist_for_each_entry(tmp, &bus->children, node) {\r\nchild = find_bus_among_children(tmp, dn);\r\nif (child)\r\nbreak;\r\n}\r\nreturn child;\r\n}\r\nstruct pci_bus *pci_find_bus_by_node(struct device_node *dn)\r\n{\r\nstruct pci_dn *pdn = PCI_DN(dn);\r\nif (!pdn || !pdn->phb || !pdn->phb->bus)\r\nreturn NULL;\r\nreturn find_bus_among_children(pdn->phb->bus, dn);\r\n}\r\nvoid pcibios_release_device(struct pci_dev *dev)\r\n{\r\nstruct pci_controller *phb = pci_bus_to_host(dev->bus);\r\neeh_remove_device(dev);\r\nif (phb->controller_ops.release_device)\r\nphb->controller_ops.release_device(dev);\r\n}\r\nvoid pci_hp_remove_devices(struct pci_bus *bus)\r\n{\r\nstruct pci_dev *dev, *tmp;\r\nstruct pci_bus *child_bus;\r\nlist_for_each_entry(child_bus, &bus->children, node)\r\npci_hp_remove_devices(child_bus);\r\npr_debug("PCI: Removing devices on bus %04x:%02x\n",\r\npci_domain_nr(bus), bus->number);\r\nlist_for_each_entry_safe_reverse(dev, tmp, &bus->devices, bus_list) {\r\npr_debug(" Removing %s...\n", pci_name(dev));\r\npci_stop_and_remove_bus_device(dev);\r\n}\r\n}\r\nvoid pci_hp_add_devices(struct pci_bus *bus)\r\n{\r\nint slotno, mode, pass, max;\r\nstruct pci_dev *dev;\r\nstruct pci_controller *phb;\r\nstruct device_node *dn = pci_bus_to_OF_node(bus);\r\neeh_add_device_tree_early(PCI_DN(dn));\r\nphb = pci_bus_to_host(bus);\r\nmode = PCI_PROBE_NORMAL;\r\nif (phb->controller_ops.probe_mode)\r\nmode = phb->controller_ops.probe_mode(bus);\r\nif (mode == PCI_PROBE_DEVTREE) {\r\nof_rescan_bus(dn, bus);\r\n} else if (mode == PCI_PROBE_NORMAL &&\r\ndn->child && PCI_DN(dn->child)) {\r\nslotno = PCI_SLOT(PCI_DN(dn->child)->devfn);\r\npci_scan_slot(bus, PCI_DEVFN(slotno, 0));\r\npcibios_setup_bus_devices(bus);\r\nmax = bus->busn_res.start;\r\nfor (pass = 0; pass < 2; pass++) {\r\nlist_for_each_entry(dev, &bus->devices, bus_list) {\r\nif (pci_is_bridge(dev))\r\nmax = pci_scan_bridge(bus, dev,\r\nmax, pass);\r\n}\r\n}\r\n}\r\npcibios_finish_adding_to_bus(bus);\r\n}

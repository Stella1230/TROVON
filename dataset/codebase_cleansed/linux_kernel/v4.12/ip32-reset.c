static __noreturn void ip32_poweroff(void *data)\r\n{\r\nvoid (*poweroff_func)(struct platform_device *) =\r\nsymbol_get(ds1685_rtc_poweroff);\r\n#ifdef CONFIG_MODULES\r\nif (!poweroff_func) {\r\nrequest_module("rtc-ds1685");\r\npoweroff_func = symbol_get(ds1685_rtc_poweroff);\r\n}\r\n#endif\r\nif (!poweroff_func)\r\npr_emerg("RTC not available for power-off. Spinning forever ...\n");\r\nelse {\r\n(*poweroff_func)((struct platform_device *)data);\r\nsymbol_put(ds1685_rtc_poweroff);\r\n}\r\nunreachable();\r\n}\r\nstatic void ip32_machine_restart(char *cmd)\r\n{\r\nmsleep(20);\r\ncrime->control = CRIME_CONTROL_HARD_RESET;\r\nunreachable();\r\n}\r\nstatic void blink_timeout(unsigned long data)\r\n{\r\nunsigned long led = mace->perif.ctrl.misc ^ MACEISA_LED_RED;\r\nmace->perif.ctrl.misc = led;\r\nmod_timer(&blink_timer, jiffies + data);\r\n}\r\nstatic void ip32_machine_halt(void)\r\n{\r\nip32_poweroff(&ip32_rtc_device);\r\n}\r\nstatic void power_timeout(unsigned long data)\r\n{\r\nip32_poweroff(&ip32_rtc_device);\r\n}\r\nvoid ip32_prepare_poweroff(void)\r\n{\r\nif (has_panicked)\r\nreturn;\r\nif (shutting_down || kill_cad_pid(SIGINT, 1)) {\r\nip32_poweroff(&ip32_rtc_device);\r\n}\r\nshutting_down = 1;\r\nblink_timer.data = POWERDOWN_FREQ;\r\nblink_timeout(POWERDOWN_FREQ);\r\ninit_timer(&power_timer);\r\npower_timer.function = power_timeout;\r\npower_timer.expires = jiffies + POWERDOWN_TIMEOUT * HZ;\r\nadd_timer(&power_timer);\r\n}\r\nstatic int panic_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nunsigned long led;\r\nif (has_panicked)\r\nreturn NOTIFY_DONE;\r\nhas_panicked = 1;\r\nled = mace->perif.ctrl.misc | MACEISA_LED_GREEN;\r\nmace->perif.ctrl.misc = led;\r\nblink_timer.data = PANIC_FREQ;\r\nblink_timeout(PANIC_FREQ);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic __init int ip32_reboot_setup(void)\r\n{\r\nunsigned long led = mace->perif.ctrl.misc;\r\nled |= MACEISA_LED_RED;\r\nled &= ~MACEISA_LED_GREEN;\r\nmace->perif.ctrl.misc = led;\r\n_machine_restart = ip32_machine_restart;\r\n_machine_halt = ip32_machine_halt;\r\npm_power_off = ip32_machine_halt;\r\ninit_timer(&blink_timer);\r\nblink_timer.function = blink_timeout;\r\natomic_notifier_chain_register(&panic_notifier_list, &panic_block);\r\nreturn 0;\r\n}

static void pci_fmb_show(struct seq_file *m, char *name[], int length,\r\nu64 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < length; i++, data++)\r\nseq_printf(m, "%26s:\t%llu\n", name[i], *data);\r\n}\r\nstatic void pci_sw_counter_show(struct seq_file *m)\r\n{\r\nstruct zpci_dev *zdev = m->private;\r\natomic64_t *counter = &zdev->allocated_pages;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pci_sw_names); i++, counter++)\r\nseq_printf(m, "%26s:\t%lu\n", pci_sw_names[i],\r\natomic64_read(counter));\r\n}\r\nstatic int pci_perf_show(struct seq_file *m, void *v)\r\n{\r\nstruct zpci_dev *zdev = m->private;\r\nif (!zdev)\r\nreturn 0;\r\nmutex_lock(&zdev->lock);\r\nif (!zdev->fmb) {\r\nmutex_unlock(&zdev->lock);\r\nseq_puts(m, "FMB statistics disabled\n");\r\nreturn 0;\r\n}\r\nseq_printf(m, "FMB @ %p\n", zdev->fmb);\r\nseq_printf(m, "Update interval: %u ms\n", zdev->fmb_update);\r\nseq_printf(m, "Samples: %u\n", zdev->fmb->samples);\r\nseq_printf(m, "Last update TOD: %Lx\n", zdev->fmb->last_update);\r\npci_fmb_show(m, pci_common_names, ARRAY_SIZE(pci_common_names),\r\n&zdev->fmb->ld_ops);\r\nswitch (zdev->fmb->format) {\r\ncase 0:\r\nif (!(zdev->fmb->fmt_ind & ZPCI_FMB_DMA_COUNTER_VALID))\r\nbreak;\r\npci_fmb_show(m, pci_fmt0_names, ARRAY_SIZE(pci_fmt0_names),\r\n&zdev->fmb->fmt0.dma_rbytes);\r\nbreak;\r\ncase 1:\r\npci_fmb_show(m, pci_fmt1_names, ARRAY_SIZE(pci_fmt1_names),\r\n&zdev->fmb->fmt1.rx_bytes);\r\nbreak;\r\ncase 2:\r\npci_fmb_show(m, pci_fmt2_names, ARRAY_SIZE(pci_fmt2_names),\r\n&zdev->fmb->fmt2.consumed_work_units);\r\nbreak;\r\ndefault:\r\nseq_puts(m, "Unknown format\n");\r\n}\r\npci_sw_counter_show(m);\r\nmutex_unlock(&zdev->lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t pci_perf_seq_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct zpci_dev *zdev = ((struct seq_file *) file->private_data)->private;\r\nunsigned long val;\r\nint rc;\r\nif (!zdev)\r\nreturn 0;\r\nrc = kstrtoul_from_user(ubuf, count, 10, &val);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&zdev->lock);\r\nswitch (val) {\r\ncase 0:\r\nrc = zpci_fmb_disable_device(zdev);\r\nbreak;\r\ncase 1:\r\nrc = zpci_fmb_enable_device(zdev);\r\nbreak;\r\n}\r\nmutex_unlock(&zdev->lock);\r\nreturn rc ? rc : count;\r\n}\r\nstatic int pci_perf_seq_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn single_open(filp, pci_perf_show,\r\nfile_inode(filp)->i_private);\r\n}\r\nvoid zpci_debug_init_device(struct zpci_dev *zdev, const char *name)\r\n{\r\nzdev->debugfs_dev = debugfs_create_dir(name, debugfs_root);\r\nif (IS_ERR(zdev->debugfs_dev))\r\nzdev->debugfs_dev = NULL;\r\nzdev->debugfs_perf = debugfs_create_file("statistics",\r\nS_IFREG | S_IRUGO | S_IWUSR,\r\nzdev->debugfs_dev, zdev,\r\n&debugfs_pci_perf_fops);\r\nif (IS_ERR(zdev->debugfs_perf))\r\nzdev->debugfs_perf = NULL;\r\n}\r\nvoid zpci_debug_exit_device(struct zpci_dev *zdev)\r\n{\r\ndebugfs_remove(zdev->debugfs_perf);\r\ndebugfs_remove(zdev->debugfs_dev);\r\n}\r\nint __init zpci_debug_init(void)\r\n{\r\npci_debug_msg_id = debug_register("pci_msg", 8, 1, 8 * sizeof(long));\r\nif (!pci_debug_msg_id)\r\nreturn -EINVAL;\r\ndebug_register_view(pci_debug_msg_id, &debug_sprintf_view);\r\ndebug_set_level(pci_debug_msg_id, 3);\r\npci_debug_err_id = debug_register("pci_error", 2, 1, 16);\r\nif (!pci_debug_err_id)\r\nreturn -EINVAL;\r\ndebug_register_view(pci_debug_err_id, &debug_hex_ascii_view);\r\ndebug_set_level(pci_debug_err_id, 6);\r\ndebugfs_root = debugfs_create_dir("pci", NULL);\r\nreturn 0;\r\n}\r\nvoid zpci_debug_exit(void)\r\n{\r\ndebug_unregister(pci_debug_msg_id);\r\ndebug_unregister(pci_debug_err_id);\r\ndebugfs_remove(debugfs_root);\r\n}

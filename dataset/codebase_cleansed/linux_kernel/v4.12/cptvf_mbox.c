static void cptvf_send_msg_to_pf(struct cpt_vf *cptvf, struct cpt_mbox *mbx)\r\n{\r\ncpt_write_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 0),\r\nmbx->msg);\r\ncpt_write_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 1),\r\nmbx->data);\r\n}\r\nvoid cptvf_mbox_send_ack(struct cpt_vf *cptvf, struct cpt_mbox *mbx)\r\n{\r\nmbx->msg = CPT_MBOX_MSG_TYPE_ACK;\r\ncptvf_send_msg_to_pf(cptvf, mbx);\r\n}\r\nvoid cptvf_mbox_send_nack(struct cpt_vf *cptvf, struct cpt_mbox *mbx)\r\n{\r\nmbx->msg = CPT_MBOX_MSG_TYPE_NACK;\r\ncptvf_send_msg_to_pf(cptvf, mbx);\r\n}\r\nvoid cptvf_handle_mbox_intr(struct cpt_vf *cptvf)\r\n{\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = cpt_read_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 0));\r\nmbx.data = cpt_read_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 1));\r\ndev_dbg(&cptvf->pdev->dev, "%s: Mailbox msg 0x%llx from PF\n",\r\n__func__, mbx.msg);\r\nswitch (mbx.msg) {\r\ncase CPT_MSG_READY:\r\n{\r\ncptvf->pf_acked = true;\r\ncptvf->vfid = mbx.data;\r\ndev_dbg(&cptvf->pdev->dev, "Received VFID %d\n", cptvf->vfid);\r\nbreak;\r\n}\r\ncase CPT_MSG_QBIND_GRP:\r\ncptvf->pf_acked = true;\r\ncptvf->vftype = mbx.data;\r\ndev_dbg(&cptvf->pdev->dev, "VF %d type %s group %d\n",\r\ncptvf->vfid, ((mbx.data == SE_TYPES) ? "SE" : "AE"),\r\ncptvf->vfgrp);\r\nbreak;\r\ncase CPT_MBOX_MSG_TYPE_ACK:\r\ncptvf->pf_acked = true;\r\nbreak;\r\ncase CPT_MBOX_MSG_TYPE_NACK:\r\ncptvf->pf_nacked = true;\r\nbreak;\r\ndefault:\r\ndev_err(&cptvf->pdev->dev, "Invalid msg from PF, msg 0x%llx\n",\r\nmbx.msg);\r\nbreak;\r\n}\r\n}\r\nstatic int cptvf_send_msg_to_pf_timeout(struct cpt_vf *cptvf,\r\nstruct cpt_mbox *mbx)\r\n{\r\nint timeout = CPT_MBOX_MSG_TIMEOUT;\r\nint sleep = 10;\r\ncptvf->pf_acked = false;\r\ncptvf->pf_nacked = false;\r\ncptvf_send_msg_to_pf(cptvf, mbx);\r\nwhile (!cptvf->pf_acked) {\r\nif (cptvf->pf_nacked)\r\nreturn -EINVAL;\r\nmsleep(sleep);\r\nif (cptvf->pf_acked)\r\nbreak;\r\ntimeout -= sleep;\r\nif (!timeout) {\r\ndev_err(&cptvf->pdev->dev, "PF didn't ack to mbox msg %llx from VF%u\n",\r\n(mbx->msg & 0xFF), cptvf->vfid);\r\nreturn -EBUSY;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_check_pf_ready(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_READY;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to READY msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_send_vq_size_msg(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_QLEN;\r\nmbx.data = cptvf->qsize;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to vq_size msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_send_vf_to_grp_msg(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_QBIND_GRP;\r\nmbx.data = cptvf->vfgrp;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to vf_type msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_send_vf_priority_msg(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_VQ_PRIORITY;\r\nmbx.data = cptvf->priority;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to vf_type msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_send_vf_up(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_VF_UP;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to UP msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nint cptvf_send_vf_down(struct cpt_vf *cptvf)\r\n{\r\nstruct pci_dev *pdev = cptvf->pdev;\r\nstruct cpt_mbox mbx = {};\r\nmbx.msg = CPT_MSG_VF_DOWN;\r\nif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\r\ndev_err(&pdev->dev, "PF didn't respond to DOWN msg\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}

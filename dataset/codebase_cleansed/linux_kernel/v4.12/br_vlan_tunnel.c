static inline int br_vlan_tunid_cmp(struct rhashtable_compare_arg *arg,\r\nconst void *ptr)\r\n{\r\nconst struct net_bridge_vlan *vle = ptr;\r\n__be64 tunid = *(__be64 *)arg->key;\r\nreturn vle->tinfo.tunnel_id != tunid;\r\n}\r\nstatic struct net_bridge_vlan *br_vlan_tunnel_lookup(struct rhashtable *tbl,\r\nu64 tunnel_id)\r\n{\r\nreturn rhashtable_lookup_fast(tbl, &tunnel_id,\r\nbr_vlan_tunnel_rht_params);\r\n}\r\nvoid vlan_tunnel_info_del(struct net_bridge_vlan_group *vg,\r\nstruct net_bridge_vlan *vlan)\r\n{\r\nif (!vlan->tinfo.tunnel_dst)\r\nreturn;\r\nrhashtable_remove_fast(&vg->tunnel_hash, &vlan->tnode,\r\nbr_vlan_tunnel_rht_params);\r\nvlan->tinfo.tunnel_id = 0;\r\ndst_release(&vlan->tinfo.tunnel_dst->dst);\r\nvlan->tinfo.tunnel_dst = NULL;\r\n}\r\nstatic int __vlan_tunnel_info_add(struct net_bridge_vlan_group *vg,\r\nstruct net_bridge_vlan *vlan, u32 tun_id)\r\n{\r\nstruct metadata_dst *metadata = NULL;\r\n__be64 key = key32_to_tunnel_id(cpu_to_be32(tun_id));\r\nint err;\r\nif (vlan->tinfo.tunnel_dst)\r\nreturn -EEXIST;\r\nmetadata = __ip_tun_set_dst(0, 0, 0, 0, 0, TUNNEL_KEY,\r\nkey, 0);\r\nif (!metadata)\r\nreturn -EINVAL;\r\nmetadata->u.tun_info.mode |= IP_TUNNEL_INFO_TX | IP_TUNNEL_INFO_BRIDGE;\r\nvlan->tinfo.tunnel_dst = metadata;\r\nvlan->tinfo.tunnel_id = key;\r\nerr = rhashtable_lookup_insert_fast(&vg->tunnel_hash, &vlan->tnode,\r\nbr_vlan_tunnel_rht_params);\r\nif (err)\r\ngoto out;\r\nreturn 0;\r\nout:\r\ndst_release(&vlan->tinfo.tunnel_dst->dst);\r\nvlan->tinfo.tunnel_dst = NULL;\r\nvlan->tinfo.tunnel_id = 0;\r\nreturn err;\r\n}\r\nint nbp_vlan_tunnel_info_add(struct net_bridge_port *port, u16 vid, u32 tun_id)\r\n{\r\nstruct net_bridge_vlan_group *vg;\r\nstruct net_bridge_vlan *vlan;\r\nASSERT_RTNL();\r\nvg = nbp_vlan_group(port);\r\nvlan = br_vlan_find(vg, vid);\r\nif (!vlan)\r\nreturn -EINVAL;\r\nreturn __vlan_tunnel_info_add(vg, vlan, tun_id);\r\n}\r\nint nbp_vlan_tunnel_info_delete(struct net_bridge_port *port, u16 vid)\r\n{\r\nstruct net_bridge_vlan_group *vg;\r\nstruct net_bridge_vlan *v;\r\nASSERT_RTNL();\r\nvg = nbp_vlan_group(port);\r\nv = br_vlan_find(vg, vid);\r\nif (!v)\r\nreturn -ENOENT;\r\nvlan_tunnel_info_del(vg, v);\r\nreturn 0;\r\n}\r\nstatic void __vlan_tunnel_info_flush(struct net_bridge_vlan_group *vg)\r\n{\r\nstruct net_bridge_vlan *vlan, *tmp;\r\nlist_for_each_entry_safe(vlan, tmp, &vg->vlan_list, vlist)\r\nvlan_tunnel_info_del(vg, vlan);\r\n}\r\nvoid nbp_vlan_tunnel_info_flush(struct net_bridge_port *port)\r\n{\r\nstruct net_bridge_vlan_group *vg;\r\nASSERT_RTNL();\r\nvg = nbp_vlan_group(port);\r\n__vlan_tunnel_info_flush(vg);\r\n}\r\nint vlan_tunnel_init(struct net_bridge_vlan_group *vg)\r\n{\r\nreturn rhashtable_init(&vg->tunnel_hash, &br_vlan_tunnel_rht_params);\r\n}\r\nvoid vlan_tunnel_deinit(struct net_bridge_vlan_group *vg)\r\n{\r\nrhashtable_destroy(&vg->tunnel_hash);\r\n}\r\nint br_handle_ingress_vlan_tunnel(struct sk_buff *skb,\r\nstruct net_bridge_port *p,\r\nstruct net_bridge_vlan_group *vg)\r\n{\r\nstruct ip_tunnel_info *tinfo = skb_tunnel_info(skb);\r\nstruct net_bridge_vlan *vlan;\r\nif (!vg || !tinfo)\r\nreturn 0;\r\nif (skb_vlan_tagged(skb))\r\nreturn 0;\r\nvlan = br_vlan_tunnel_lookup(&vg->tunnel_hash, tinfo->key.tun_id);\r\nif (!vlan)\r\nreturn 0;\r\nskb_dst_drop(skb);\r\n__vlan_hwaccel_put_tag(skb, p->br->vlan_proto, vlan->vid);\r\nreturn 0;\r\n}\r\nint br_handle_egress_vlan_tunnel(struct sk_buff *skb,\r\nstruct net_bridge_vlan *vlan)\r\n{\r\nint err;\r\nif (!vlan || !vlan->tinfo.tunnel_id)\r\nreturn 0;\r\nif (unlikely(!skb_vlan_tag_present(skb)))\r\nreturn 0;\r\nskb_dst_drop(skb);\r\nerr = skb_vlan_pop(skb);\r\nif (err)\r\nreturn err;\r\nskb_dst_set(skb, dst_clone(&vlan->tinfo.tunnel_dst->dst));\r\nreturn 0;\r\n}

static int dwc3_of_simple_clk_init(struct dwc3_of_simple *simple, int count)\r\n{\r\nstruct device *dev = simple->dev;\r\nstruct device_node *np = dev->of_node;\r\nint i;\r\nsimple->num_clocks = count;\r\nif (!count)\r\nreturn 0;\r\nsimple->clks = devm_kcalloc(dev, simple->num_clocks,\r\nsizeof(struct clk *), GFP_KERNEL);\r\nif (!simple->clks)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < simple->num_clocks; i++) {\r\nstruct clk *clk;\r\nint ret;\r\nclk = of_clk_get(np, i);\r\nif (IS_ERR(clk)) {\r\nwhile (--i >= 0)\r\nclk_put(simple->clks[i]);\r\nreturn PTR_ERR(clk);\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret < 0) {\r\nwhile (--i >= 0) {\r\nclk_disable_unprepare(simple->clks[i]);\r\nclk_put(simple->clks[i]);\r\n}\r\nclk_put(clk);\r\nreturn ret;\r\n}\r\nsimple->clks[i] = clk;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dwc3_of_simple_probe(struct platform_device *pdev)\r\n{\r\nstruct dwc3_of_simple *simple;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nint ret;\r\nint i;\r\nsimple = devm_kzalloc(dev, sizeof(*simple), GFP_KERNEL);\r\nif (!simple)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, simple);\r\nsimple->dev = dev;\r\nret = dwc3_of_simple_clk_init(simple, of_clk_get_parent_count(np));\r\nif (ret)\r\nreturn ret;\r\nret = of_platform_populate(np, NULL, NULL, dev);\r\nif (ret) {\r\nfor (i = 0; i < simple->num_clocks; i++) {\r\nclk_disable_unprepare(simple->clks[i]);\r\nclk_put(simple->clks[i]);\r\n}\r\nreturn ret;\r\n}\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\npm_runtime_get_sync(dev);\r\nreturn 0;\r\n}\r\nstatic int dwc3_of_simple_remove(struct platform_device *pdev)\r\n{\r\nstruct dwc3_of_simple *simple = platform_get_drvdata(pdev);\r\nstruct device *dev = &pdev->dev;\r\nint i;\r\nfor (i = 0; i < simple->num_clocks; i++) {\r\nclk_disable_unprepare(simple->clks[i]);\r\nclk_put(simple->clks[i]);\r\n}\r\nof_platform_depopulate(dev);\r\npm_runtime_put_sync(dev);\r\npm_runtime_disable(dev);\r\nreturn 0;\r\n}\r\nstatic int dwc3_of_simple_runtime_suspend(struct device *dev)\r\n{\r\nstruct dwc3_of_simple *simple = dev_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < simple->num_clocks; i++)\r\nclk_disable(simple->clks[i]);\r\nreturn 0;\r\n}\r\nstatic int dwc3_of_simple_runtime_resume(struct device *dev)\r\n{\r\nstruct dwc3_of_simple *simple = dev_get_drvdata(dev);\r\nint ret;\r\nint i;\r\nfor (i = 0; i < simple->num_clocks; i++) {\r\nret = clk_enable(simple->clks[i]);\r\nif (ret < 0) {\r\nwhile (--i >= 0)\r\nclk_disable(simple->clks[i]);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

static inline void vf610_mscm_ir_save(struct vf610_mscm_ir_chip_data *data)\r\n{\r\nint i;\r\nfor (i = 0; i < MSCM_IRSPRC_NUM; i++)\r\ndata->saved_irsprc[i] = readw_relaxed(data->mscm_ir_base + MSCM_IRSPRC(i));\r\n}\r\nstatic inline void vf610_mscm_ir_restore(struct vf610_mscm_ir_chip_data *data)\r\n{\r\nint i;\r\nfor (i = 0; i < MSCM_IRSPRC_NUM; i++)\r\nwritew_relaxed(data->saved_irsprc[i], data->mscm_ir_base + MSCM_IRSPRC(i));\r\n}\r\nstatic int vf610_mscm_ir_notifier(struct notifier_block *self,\r\nunsigned long cmd, void *v)\r\n{\r\nswitch (cmd) {\r\ncase CPU_CLUSTER_PM_ENTER:\r\nvf610_mscm_ir_save(mscm_ir_data);\r\nbreak;\r\ncase CPU_CLUSTER_PM_ENTER_FAILED:\r\ncase CPU_CLUSTER_PM_EXIT:\r\nvf610_mscm_ir_restore(mscm_ir_data);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic void vf610_mscm_ir_enable(struct irq_data *data)\r\n{\r\nirq_hw_number_t hwirq = data->hwirq;\r\nstruct vf610_mscm_ir_chip_data *chip_data = data->chip_data;\r\nu16 irsprc;\r\nirsprc = readw_relaxed(chip_data->mscm_ir_base + MSCM_IRSPRC(hwirq));\r\nirsprc &= MSCM_IRSPRC_CPEN_MASK;\r\nWARN_ON(irsprc & ~chip_data->cpu_mask);\r\nwritew_relaxed(chip_data->cpu_mask,\r\nchip_data->mscm_ir_base + MSCM_IRSPRC(hwirq));\r\nirq_chip_enable_parent(data);\r\n}\r\nstatic void vf610_mscm_ir_disable(struct irq_data *data)\r\n{\r\nirq_hw_number_t hwirq = data->hwirq;\r\nstruct vf610_mscm_ir_chip_data *chip_data = data->chip_data;\r\nwritew_relaxed(0x0, chip_data->mscm_ir_base + MSCM_IRSPRC(hwirq));\r\nirq_chip_disable_parent(data);\r\n}\r\nstatic int vf610_mscm_ir_domain_alloc(struct irq_domain *domain, unsigned int virq,\r\nunsigned int nr_irqs, void *arg)\r\n{\r\nint i;\r\nirq_hw_number_t hwirq;\r\nstruct irq_fwspec *fwspec = arg;\r\nstruct irq_fwspec parent_fwspec;\r\nif (!irq_domain_get_of_node(domain->parent))\r\nreturn -EINVAL;\r\nif (fwspec->param_count != 2)\r\nreturn -EINVAL;\r\nhwirq = fwspec->param[0];\r\nfor (i = 0; i < nr_irqs; i++)\r\nirq_domain_set_hwirq_and_chip(domain, virq + i, hwirq + i,\r\n&vf610_mscm_ir_irq_chip,\r\ndomain->host_data);\r\nparent_fwspec.fwnode = domain->parent->fwnode;\r\nif (mscm_ir_data->is_nvic) {\r\nparent_fwspec.param_count = 1;\r\nparent_fwspec.param[0] = fwspec->param[0];\r\n} else {\r\nparent_fwspec.param_count = 3;\r\nparent_fwspec.param[0] = GIC_SPI;\r\nparent_fwspec.param[1] = fwspec->param[0];\r\nparent_fwspec.param[2] = fwspec->param[1];\r\n}\r\nreturn irq_domain_alloc_irqs_parent(domain, virq, nr_irqs,\r\n&parent_fwspec);\r\n}\r\nstatic int vf610_mscm_ir_domain_translate(struct irq_domain *d,\r\nstruct irq_fwspec *fwspec,\r\nunsigned long *hwirq,\r\nunsigned int *type)\r\n{\r\nif (WARN_ON(fwspec->param_count < 2))\r\nreturn -EINVAL;\r\n*hwirq = fwspec->param[0];\r\n*type = fwspec->param[1] & IRQ_TYPE_SENSE_MASK;\r\nreturn 0;\r\n}\r\nstatic int __init vf610_mscm_ir_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nstruct irq_domain *domain, *domain_parent;\r\nstruct regmap *mscm_cp_regmap;\r\nint ret, cpuid;\r\ndomain_parent = irq_find_host(parent);\r\nif (!domain_parent) {\r\npr_err("vf610_mscm_ir: interrupt-parent not found\n");\r\nreturn -EINVAL;\r\n}\r\nmscm_ir_data = kzalloc(sizeof(*mscm_ir_data), GFP_KERNEL);\r\nif (!mscm_ir_data)\r\nreturn -ENOMEM;\r\nmscm_ir_data->mscm_ir_base = of_io_request_and_map(node, 0, "mscm-ir");\r\nif (IS_ERR(mscm_ir_data->mscm_ir_base)) {\r\npr_err("vf610_mscm_ir: unable to map mscm register\n");\r\nret = PTR_ERR(mscm_ir_data->mscm_ir_base);\r\ngoto out_free;\r\n}\r\nmscm_cp_regmap = syscon_regmap_lookup_by_phandle(node, "fsl,cpucfg");\r\nif (IS_ERR(mscm_cp_regmap)) {\r\nret = PTR_ERR(mscm_cp_regmap);\r\npr_err("vf610_mscm_ir: regmap lookup for cpucfg failed\n");\r\ngoto out_unmap;\r\n}\r\nregmap_read(mscm_cp_regmap, MSCM_CPxNUM, &cpuid);\r\nmscm_ir_data->cpu_mask = 0x1 << cpuid;\r\ndomain = irq_domain_add_hierarchy(domain_parent, 0,\r\nMSCM_IRSPRC_NUM, node,\r\n&mscm_irq_domain_ops, mscm_ir_data);\r\nif (!domain) {\r\nret = -ENOMEM;\r\ngoto out_unmap;\r\n}\r\nif (of_device_is_compatible(irq_domain_get_of_node(domain->parent),\r\n"arm,armv7m-nvic"))\r\nmscm_ir_data->is_nvic = true;\r\ncpu_pm_register_notifier(&mscm_ir_notifier_block);\r\nreturn 0;\r\nout_unmap:\r\niounmap(mscm_ir_data->mscm_ir_base);\r\nout_free:\r\nkfree(mscm_ir_data);\r\nreturn ret;\r\n}

static inline\r\nstruct gemini_wdt *to_gemini_wdt(struct watchdog_device *wdd)\r\n{\r\nreturn container_of(wdd, struct gemini_wdt, wdd);\r\n}\r\nstatic int gemini_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct gemini_wdt *gwdt = to_gemini_wdt(wdd);\r\nwritel(wdd->timeout * WDT_CLOCK, gwdt->base + GEMINI_WDLOAD);\r\nwritel(WDRESTART_MAGIC, gwdt->base + GEMINI_WDRESTART);\r\nwritel(WDCR_CLOCK_5MHZ | WDCR_SYS_RST,\r\ngwdt->base + GEMINI_WDCR);\r\nwritel(WDCR_CLOCK_5MHZ | WDCR_SYS_RST | WDCR_ENABLE,\r\ngwdt->base + GEMINI_WDCR);\r\nreturn 0;\r\n}\r\nstatic int gemini_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct gemini_wdt *gwdt = to_gemini_wdt(wdd);\r\nwritel(0, gwdt->base + GEMINI_WDCR);\r\nreturn 0;\r\n}\r\nstatic int gemini_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct gemini_wdt *gwdt = to_gemini_wdt(wdd);\r\nwritel(WDRESTART_MAGIC, gwdt->base + GEMINI_WDRESTART);\r\nreturn 0;\r\n}\r\nstatic int gemini_wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int timeout)\r\n{\r\nwdd->timeout = timeout;\r\nif (watchdog_active(wdd))\r\ngemini_wdt_start(wdd);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t gemini_wdt_interrupt(int irq, void *data)\r\n{\r\nstruct gemini_wdt *gwdt = data;\r\nwatchdog_notify_pretimeout(&gwdt->wdd);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int gemini_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nstruct gemini_wdt *gwdt;\r\nunsigned int reg;\r\nint irq;\r\nint ret;\r\ngwdt = devm_kzalloc(dev, sizeof(*gwdt), GFP_KERNEL);\r\nif (!gwdt)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ngwdt->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(gwdt->base))\r\nreturn PTR_ERR(gwdt->base);\r\nirq = platform_get_irq(pdev, 0);\r\nif (!irq)\r\nreturn -EINVAL;\r\ngwdt->dev = dev;\r\ngwdt->wdd.info = &gemini_wdt_info;\r\ngwdt->wdd.ops = &gemini_wdt_ops;\r\ngwdt->wdd.min_timeout = 1;\r\ngwdt->wdd.max_timeout = 0xFFFFFFFF / WDT_CLOCK;\r\ngwdt->wdd.parent = dev;\r\ngwdt->wdd.timeout = 13U;\r\nwatchdog_init_timeout(&gwdt->wdd, 0, dev);\r\nreg = readw(gwdt->base + GEMINI_WDCR);\r\nif (reg & WDCR_ENABLE) {\r\nreg &= ~WDCR_ENABLE;\r\nwritel(reg, gwdt->base + GEMINI_WDCR);\r\n}\r\nret = devm_request_irq(dev, irq, gemini_wdt_interrupt, 0,\r\n"watchdog bark", gwdt);\r\nif (ret)\r\nreturn ret;\r\nret = devm_watchdog_register_device(dev, &gwdt->wdd);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register watchdog\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, gwdt);\r\ndev_info(dev, "Gemini watchdog driver enabled\n");\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused gemini_wdt_suspend(struct device *dev)\r\n{\r\nstruct gemini_wdt *gwdt = dev_get_drvdata(dev);\r\nunsigned int reg;\r\nreg = readw(gwdt->base + GEMINI_WDCR);\r\nreg &= ~WDCR_ENABLE;\r\nwritel(reg, gwdt->base + GEMINI_WDCR);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused gemini_wdt_resume(struct device *dev)\r\n{\r\nstruct gemini_wdt *gwdt = dev_get_drvdata(dev);\r\nunsigned int reg;\r\nif (watchdog_active(&gwdt->wdd)) {\r\nreg = readw(gwdt->base + GEMINI_WDCR);\r\nreg |= WDCR_ENABLE;\r\nwritel(reg, gwdt->base + GEMINI_WDCR);\r\n}\r\nreturn 0;\r\n}

static void call_path__init(struct call_path *cp, struct call_path *parent,\r\nstruct symbol *sym, u64 ip, bool in_kernel)\r\n{\r\ncp->parent = parent;\r\ncp->sym = sym;\r\ncp->ip = sym ? 0 : ip;\r\ncp->db_id = 0;\r\ncp->in_kernel = in_kernel;\r\nRB_CLEAR_NODE(&cp->rb_node);\r\ncp->children = RB_ROOT;\r\n}\r\nstruct call_path_root *call_path_root__new(void)\r\n{\r\nstruct call_path_root *cpr;\r\ncpr = zalloc(sizeof(struct call_path_root));\r\nif (!cpr)\r\nreturn NULL;\r\ncall_path__init(&cpr->call_path, NULL, NULL, 0, false);\r\nINIT_LIST_HEAD(&cpr->blocks);\r\nreturn cpr;\r\n}\r\nvoid call_path_root__free(struct call_path_root *cpr)\r\n{\r\nstruct call_path_block *pos, *n;\r\nlist_for_each_entry_safe(pos, n, &cpr->blocks, node) {\r\nlist_del(&pos->node);\r\nfree(pos);\r\n}\r\nfree(cpr);\r\n}\r\nstatic struct call_path *call_path__new(struct call_path_root *cpr,\r\nstruct call_path *parent,\r\nstruct symbol *sym, u64 ip,\r\nbool in_kernel)\r\n{\r\nstruct call_path_block *cpb;\r\nstruct call_path *cp;\r\nsize_t n;\r\nif (cpr->next < cpr->sz) {\r\ncpb = list_last_entry(&cpr->blocks, struct call_path_block,\r\nnode);\r\n} else {\r\ncpb = zalloc(sizeof(struct call_path_block));\r\nif (!cpb)\r\nreturn NULL;\r\nlist_add_tail(&cpb->node, &cpr->blocks);\r\ncpr->sz += CALL_PATH_BLOCK_SIZE;\r\n}\r\nn = cpr->next++ & CALL_PATH_BLOCK_MASK;\r\ncp = &cpb->cp[n];\r\ncall_path__init(cp, parent, sym, ip, in_kernel);\r\nreturn cp;\r\n}\r\nstruct call_path *call_path__findnew(struct call_path_root *cpr,\r\nstruct call_path *parent,\r\nstruct symbol *sym, u64 ip, u64 ks)\r\n{\r\nstruct rb_node **p;\r\nstruct rb_node *node_parent = NULL;\r\nstruct call_path *cp;\r\nbool in_kernel = ip >= ks;\r\nif (sym)\r\nip = 0;\r\nif (!parent)\r\nreturn call_path__new(cpr, parent, sym, ip, in_kernel);\r\np = &parent->children.rb_node;\r\nwhile (*p != NULL) {\r\nnode_parent = *p;\r\ncp = rb_entry(node_parent, struct call_path, rb_node);\r\nif (cp->sym == sym && cp->ip == ip)\r\nreturn cp;\r\nif (sym < cp->sym || (sym == cp->sym && ip < cp->ip))\r\np = &(*p)->rb_left;\r\nelse\r\np = &(*p)->rb_right;\r\n}\r\ncp = call_path__new(cpr, parent, sym, ip, in_kernel);\r\nif (!cp)\r\nreturn NULL;\r\nrb_link_node(&cp->rb_node, node_parent, p);\r\nrb_insert_color(&cp->rb_node, &parent->children);\r\nreturn cp;\r\n}

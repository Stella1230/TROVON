static struct ostm_device *ced_to_ostm(struct clock_event_device *ced)\r\n{\r\nreturn container_of(ced, struct ostm_device, ced);\r\n}\r\nstatic void ostm_timer_stop(struct ostm_device *ostm)\r\n{\r\nif (readb(ostm->base + OSTM_TE) & TE) {\r\nwriteb(TT, ostm->base + OSTM_TT);\r\nwhile (readb(ostm->base + OSTM_TE) & TE)\r\n;\r\n}\r\n}\r\nstatic int __init ostm_init_clksrc(struct ostm_device *ostm, unsigned long rate)\r\n{\r\nostm_timer_stop(ostm);\r\nwritel(0, ostm->base + OSTM_CMP);\r\nwriteb(CTL_FREERUN, ostm->base + OSTM_CTL);\r\nwriteb(TS, ostm->base + OSTM_TS);\r\nreturn clocksource_mmio_init(ostm->base + OSTM_CNT,\r\n"ostm", rate,\r\n300, 32, clocksource_mmio_readl_up);\r\n}\r\nstatic u64 notrace ostm_read_sched_clock(void)\r\n{\r\nreturn readl(system_clock);\r\n}\r\nstatic void __init ostm_init_sched_clock(struct ostm_device *ostm,\r\nunsigned long rate)\r\n{\r\nsystem_clock = ostm->base + OSTM_CNT;\r\nsched_clock_register(ostm_read_sched_clock, 32, rate);\r\n}\r\nstatic int ostm_clock_event_next(unsigned long delta,\r\nstruct clock_event_device *ced)\r\n{\r\nstruct ostm_device *ostm = ced_to_ostm(ced);\r\nostm_timer_stop(ostm);\r\nwritel(delta, ostm->base + OSTM_CMP);\r\nwriteb(CTL_ONESHOT, ostm->base + OSTM_CTL);\r\nwriteb(TS, ostm->base + OSTM_TS);\r\nreturn 0;\r\n}\r\nstatic int ostm_shutdown(struct clock_event_device *ced)\r\n{\r\nstruct ostm_device *ostm = ced_to_ostm(ced);\r\nostm_timer_stop(ostm);\r\nreturn 0;\r\n}\r\nstatic int ostm_set_periodic(struct clock_event_device *ced)\r\n{\r\nstruct ostm_device *ostm = ced_to_ostm(ced);\r\nif (clockevent_state_oneshot(ced) || clockevent_state_periodic(ced))\r\nostm_timer_stop(ostm);\r\nwritel(ostm->ticks_per_jiffy - 1, ostm->base + OSTM_CMP);\r\nwriteb(CTL_PERIODIC, ostm->base + OSTM_CTL);\r\nwriteb(TS, ostm->base + OSTM_TS);\r\nreturn 0;\r\n}\r\nstatic int ostm_set_oneshot(struct clock_event_device *ced)\r\n{\r\nstruct ostm_device *ostm = ced_to_ostm(ced);\r\nostm_timer_stop(ostm);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ostm_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct ostm_device *ostm = dev_id;\r\nif (clockevent_state_oneshot(&ostm->ced))\r\nostm_timer_stop(ostm);\r\nif (ostm->ced.event_handler)\r\nostm->ced.event_handler(&ostm->ced);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init ostm_init_clkevt(struct ostm_device *ostm, int irq,\r\nunsigned long rate)\r\n{\r\nstruct clock_event_device *ced = &ostm->ced;\r\nint ret = -ENXIO;\r\nret = request_irq(irq, ostm_timer_interrupt,\r\nIRQF_TIMER | IRQF_IRQPOLL,\r\n"ostm", ostm);\r\nif (ret) {\r\npr_err("ostm: failed to request irq\n");\r\nreturn ret;\r\n}\r\nced->name = "ostm";\r\nced->features = CLOCK_EVT_FEAT_ONESHOT | CLOCK_EVT_FEAT_PERIODIC;\r\nced->set_state_shutdown = ostm_shutdown;\r\nced->set_state_periodic = ostm_set_periodic;\r\nced->set_state_oneshot = ostm_set_oneshot;\r\nced->set_next_event = ostm_clock_event_next;\r\nced->shift = 32;\r\nced->rating = 300;\r\nced->cpumask = cpumask_of(0);\r\nclockevents_config_and_register(ced, rate, 0xf, 0xffffffff);\r\nreturn 0;\r\n}\r\nstatic int __init ostm_init(struct device_node *np)\r\n{\r\nstruct ostm_device *ostm;\r\nint ret = -EFAULT;\r\nstruct clk *ostm_clk = NULL;\r\nint irq;\r\nunsigned long rate;\r\nostm = kzalloc(sizeof(*ostm), GFP_KERNEL);\r\nif (!ostm)\r\nreturn -ENOMEM;\r\nostm->base = of_iomap(np, 0);\r\nif (!ostm->base) {\r\npr_err("ostm: failed to remap I/O memory\n");\r\ngoto err;\r\n}\r\nirq = irq_of_parse_and_map(np, 0);\r\nif (irq < 0) {\r\npr_err("ostm: Failed to get irq\n");\r\ngoto err;\r\n}\r\nostm_clk = of_clk_get(np, 0);\r\nif (IS_ERR(ostm_clk)) {\r\npr_err("ostm: Failed to get clock\n");\r\nostm_clk = NULL;\r\ngoto err;\r\n}\r\nret = clk_prepare_enable(ostm_clk);\r\nif (ret) {\r\npr_err("ostm: Failed to enable clock\n");\r\ngoto err;\r\n}\r\nrate = clk_get_rate(ostm_clk);\r\nostm->ticks_per_jiffy = (rate + HZ / 2) / HZ;\r\nif (!system_clock) {\r\nret = ostm_init_clksrc(ostm, rate);\r\nif (!ret) {\r\nostm_init_sched_clock(ostm, rate);\r\npr_info("ostm: used for clocksource\n");\r\n}\r\n} else {\r\nret = ostm_init_clkevt(ostm, irq, rate);\r\nif (!ret)\r\npr_info("ostm: used for clock events\n");\r\n}\r\nerr:\r\nif (ret) {\r\nclk_disable_unprepare(ostm_clk);\r\niounmap(ostm->base);\r\nkfree(ostm);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

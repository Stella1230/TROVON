static void bcma_pcie2_fixup_class(struct pci_dev *dev)\r\n{\r\ndev->class = PCI_CLASS_BRIDGE_PCI << 8;\r\n}\r\nstatic int iproc_pcie_bcma_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstruct pci_sys_data *sys = dev->sysdata;\r\nstruct iproc_pcie *pcie = sys->private_data;\r\nstruct bcma_device *bdev = container_of(pcie->dev, struct bcma_device, dev);\r\nreturn bcma_core_irq(bdev, 5);\r\n}\r\nstatic int iproc_pcie_bcma_probe(struct bcma_device *bdev)\r\n{\r\nstruct device *dev = &bdev->dev;\r\nstruct iproc_pcie *pcie;\r\nLIST_HEAD(resources);\r\nint ret;\r\npcie = devm_kzalloc(dev, sizeof(*pcie), GFP_KERNEL);\r\nif (!pcie)\r\nreturn -ENOMEM;\r\npcie->dev = dev;\r\npcie->type = IPROC_PCIE_PAXB_BCMA;\r\npcie->base = bdev->io_addr;\r\nif (!pcie->base) {\r\ndev_err(dev, "no controller registers\n");\r\nreturn -ENOMEM;\r\n}\r\npcie->base_addr = bdev->addr;\r\npcie->mem.start = bdev->addr_s[0];\r\npcie->mem.end = bdev->addr_s[0] + SZ_128M - 1;\r\npcie->mem.name = "PCIe MEM space";\r\npcie->mem.flags = IORESOURCE_MEM;\r\npci_add_resource(&resources, &pcie->mem);\r\npcie->map_irq = iproc_pcie_bcma_map_irq;\r\nret = iproc_pcie_setup(pcie, &resources);\r\nif (ret) {\r\ndev_err(dev, "PCIe controller setup failed\n");\r\npci_free_resource_list(&resources);\r\nreturn ret;\r\n}\r\nbcma_set_drvdata(bdev, pcie);\r\nreturn 0;\r\n}\r\nstatic void iproc_pcie_bcma_remove(struct bcma_device *bdev)\r\n{\r\nstruct iproc_pcie *pcie = bcma_get_drvdata(bdev);\r\niproc_pcie_remove(pcie);\r\n}\r\nstatic int __init iproc_pcie_bcma_init(void)\r\n{\r\nreturn bcma_driver_register(&iproc_pcie_bcma_driver);\r\n}\r\nstatic void __exit iproc_pcie_bcma_exit(void)\r\n{\r\nbcma_driver_unregister(&iproc_pcie_bcma_driver);\r\n}

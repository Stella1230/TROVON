void mdio_device_free(struct mdio_device *mdiodev)\r\n{\r\nput_device(&mdiodev->dev);\r\n}\r\nstatic void mdio_device_release(struct device *dev)\r\n{\r\nkfree(to_mdio_device(dev));\r\n}\r\nint mdio_device_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct mdio_device *mdiodev = to_mdio_device(dev);\r\nstruct mdio_driver *mdiodrv = to_mdio_driver(drv);\r\nif (mdiodrv->mdiodrv.flags & MDIO_DEVICE_IS_PHY)\r\nreturn 0;\r\nreturn strcmp(mdiodev->modalias, drv->name) == 0;\r\n}\r\nstruct mdio_device *mdio_device_create(struct mii_bus *bus, int addr)\r\n{\r\nstruct mdio_device *mdiodev;\r\nmdiodev = kzalloc(sizeof(*mdiodev), GFP_KERNEL);\r\nif (!mdiodev)\r\nreturn ERR_PTR(-ENOMEM);\r\nmdiodev->dev.release = mdio_device_release;\r\nmdiodev->dev.parent = &bus->dev;\r\nmdiodev->dev.bus = &mdio_bus_type;\r\nmdiodev->device_free = mdio_device_free;\r\nmdiodev->device_remove = mdio_device_remove;\r\nmdiodev->bus = bus;\r\nmdiodev->addr = addr;\r\ndev_set_name(&mdiodev->dev, PHY_ID_FMT, bus->id, addr);\r\ndevice_initialize(&mdiodev->dev);\r\nreturn mdiodev;\r\n}\r\nint mdio_device_register(struct mdio_device *mdiodev)\r\n{\r\nint err;\r\ndev_dbg(&mdiodev->dev, "mdio_device_register\n");\r\nerr = mdiobus_register_device(mdiodev);\r\nif (err)\r\nreturn err;\r\nerr = device_add(&mdiodev->dev);\r\nif (err) {\r\npr_err("MDIO %d failed to add\n", mdiodev->addr);\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\nmdiobus_unregister_device(mdiodev);\r\nreturn err;\r\n}\r\nvoid mdio_device_remove(struct mdio_device *mdiodev)\r\n{\r\ndevice_del(&mdiodev->dev);\r\nmdiobus_unregister_device(mdiodev);\r\n}\r\nstatic int mdio_probe(struct device *dev)\r\n{\r\nstruct mdio_device *mdiodev = to_mdio_device(dev);\r\nstruct device_driver *drv = mdiodev->dev.driver;\r\nstruct mdio_driver *mdiodrv = to_mdio_driver(drv);\r\nint err = 0;\r\nif (mdiodrv->probe)\r\nerr = mdiodrv->probe(mdiodev);\r\nreturn err;\r\n}\r\nstatic int mdio_remove(struct device *dev)\r\n{\r\nstruct mdio_device *mdiodev = to_mdio_device(dev);\r\nstruct device_driver *drv = mdiodev->dev.driver;\r\nstruct mdio_driver *mdiodrv = to_mdio_driver(drv);\r\nif (mdiodrv->remove)\r\nmdiodrv->remove(mdiodev);\r\nreturn 0;\r\n}\r\nint mdio_driver_register(struct mdio_driver *drv)\r\n{\r\nstruct mdio_driver_common *mdiodrv = &drv->mdiodrv;\r\nint retval;\r\npr_debug("mdio_driver_register: %s\n", mdiodrv->driver.name);\r\nmdiodrv->driver.bus = &mdio_bus_type;\r\nmdiodrv->driver.probe = mdio_probe;\r\nmdiodrv->driver.remove = mdio_remove;\r\nretval = driver_register(&mdiodrv->driver);\r\nif (retval) {\r\npr_err("%s: Error %d in registering driver\n",\r\nmdiodrv->driver.name, retval);\r\nreturn retval;\r\n}\r\nreturn 0;\r\n}\r\nvoid mdio_driver_unregister(struct mdio_driver *drv)\r\n{\r\nstruct mdio_driver_common *mdiodrv = &drv->mdiodrv;\r\ndriver_unregister(&mdiodrv->driver);\r\n}

static int max7301_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct max7301 *ts = gpiochip_get_data(chip);\r\nu8 *config;\r\nu8 offset_bits, pin_config;\r\nint ret;\r\noffset += 4;\r\noffset_bits = (offset & 3) << 1;\r\nconfig = &ts->port_config[offset >> 2];\r\nif (ts->input_pullup_active & BIT(offset))\r\npin_config = PIN_CONFIG_IN_PULLUP;\r\nelse\r\npin_config = PIN_CONFIG_IN_WO_PULLUP;\r\nmutex_lock(&ts->lock);\r\n*config = (*config & ~(PIN_CONFIG_MASK << offset_bits))\r\n| (pin_config << offset_bits);\r\nret = ts->write(ts->dev, 0x08 + (offset >> 2), *config);\r\nmutex_unlock(&ts->lock);\r\nreturn ret;\r\n}\r\nstatic int __max7301_set(struct max7301 *ts, unsigned offset, int value)\r\n{\r\nif (value) {\r\nts->out_level |= 1 << offset;\r\nreturn ts->write(ts->dev, 0x20 + offset, 0x01);\r\n} else {\r\nts->out_level &= ~(1 << offset);\r\nreturn ts->write(ts->dev, 0x20 + offset, 0x00);\r\n}\r\n}\r\nstatic int max7301_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nstruct max7301 *ts = gpiochip_get_data(chip);\r\nu8 *config;\r\nu8 offset_bits;\r\nint ret;\r\noffset += 4;\r\noffset_bits = (offset & 3) << 1;\r\nconfig = &ts->port_config[offset >> 2];\r\nmutex_lock(&ts->lock);\r\n*config = (*config & ~(PIN_CONFIG_MASK << offset_bits))\r\n| (PIN_CONFIG_OUT << offset_bits);\r\nret = __max7301_set(ts, offset, value);\r\nif (!ret)\r\nret = ts->write(ts->dev, 0x08 + (offset >> 2), *config);\r\nmutex_unlock(&ts->lock);\r\nreturn ret;\r\n}\r\nstatic int max7301_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct max7301 *ts = gpiochip_get_data(chip);\r\nint config, level = -EINVAL;\r\noffset += 4;\r\nmutex_lock(&ts->lock);\r\nconfig = (ts->port_config[offset >> 2] >> ((offset & 3) << 1))\r\n& PIN_CONFIG_MASK;\r\nswitch (config) {\r\ncase PIN_CONFIG_OUT:\r\nlevel = !!(ts->out_level & (1 << offset));\r\nbreak;\r\ncase PIN_CONFIG_IN_WO_PULLUP:\r\ncase PIN_CONFIG_IN_PULLUP:\r\nlevel = ts->read(ts->dev, 0x20 + offset) & 0x01;\r\n}\r\nmutex_unlock(&ts->lock);\r\nreturn level;\r\n}\r\nstatic void max7301_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct max7301 *ts = gpiochip_get_data(chip);\r\noffset += 4;\r\nmutex_lock(&ts->lock);\r\n__max7301_set(ts, offset, value);\r\nmutex_unlock(&ts->lock);\r\n}\r\nint __max730x_probe(struct max7301 *ts)\r\n{\r\nstruct device *dev = ts->dev;\r\nstruct max7301_platform_data *pdata;\r\nint i, ret;\r\npdata = dev_get_platdata(dev);\r\nmutex_init(&ts->lock);\r\ndev_set_drvdata(dev, ts);\r\nts->write(dev, 0x04, 0x01);\r\nif (pdata) {\r\nts->input_pullup_active = pdata->input_pullup_active;\r\nts->chip.base = pdata->base;\r\n} else {\r\nts->chip.base = -1;\r\n}\r\nts->chip.label = dev->driver->name;\r\nts->chip.direction_input = max7301_direction_input;\r\nts->chip.get = max7301_get;\r\nts->chip.direction_output = max7301_direction_output;\r\nts->chip.set = max7301_set;\r\nts->chip.ngpio = PIN_NUMBER;\r\nts->chip.can_sleep = true;\r\nts->chip.parent = dev;\r\nts->chip.owner = THIS_MODULE;\r\nret = gpiochip_add_data(&ts->chip, ts);\r\nif (ret)\r\ngoto exit_destroy;\r\nfor (i = 1; i < 8; i++) {\r\nint j;\r\nts->port_config[i] = 0xAA;\r\nfor (j = 0; j < 4; j++) {\r\nint offset = (i - 1) * 4 + j;\r\nret = max7301_direction_input(&ts->chip, offset);\r\nif (ret)\r\ngoto exit_destroy;\r\n}\r\n}\r\nreturn ret;\r\nexit_destroy:\r\nmutex_destroy(&ts->lock);\r\nreturn ret;\r\n}\r\nint __max730x_remove(struct device *dev)\r\n{\r\nstruct max7301 *ts = dev_get_drvdata(dev);\r\nif (ts == NULL)\r\nreturn -ENODEV;\r\nts->write(dev, 0x04, 0x00);\r\ngpiochip_remove(&ts->chip);\r\nmutex_destroy(&ts->lock);\r\nreturn 0;\r\n}

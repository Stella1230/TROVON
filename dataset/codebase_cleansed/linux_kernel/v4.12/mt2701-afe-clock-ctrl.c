int mt2701_init_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nint i = 0;\r\nfor (i = 0; i < MT2701_CLOCK_NUM; i++) {\r\nafe_priv->clocks[i] = devm_clk_get(afe->dev, aud_clks[i]);\r\nif (IS_ERR(aud_clks[i])) {\r\ndev_warn(afe->dev, "%s devm_clk_get %s fail\n",\r\n__func__, aud_clks[i]);\r\nreturn PTR_ERR(aud_clks[i]);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint mt2701_afe_enable_clock(struct mtk_base_afe *afe)\r\n{\r\nint ret = 0;\r\nret = mt2701_turn_on_a1sys_clock(afe);\r\nif (ret) {\r\ndev_err(afe->dev, "%s turn_on_a1sys_clock fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = mt2701_turn_on_a2sys_clock(afe);\r\nif (ret) {\r\ndev_err(afe->dev, "%s turn_on_a2sys_clock fail %d\n",\r\n__func__, ret);\r\nmt2701_turn_off_a1sys_clock(afe);\r\nreturn ret;\r\n}\r\nret = mt2701_turn_on_afe_clock(afe);\r\nif (ret) {\r\ndev_err(afe->dev, "%s turn_on_afe_clock fail %d\n",\r\n__func__, ret);\r\nmt2701_turn_off_a1sys_clock(afe);\r\nmt2701_turn_off_a2sys_clock(afe);\r\nreturn ret;\r\n}\r\nregmap_update_bits(afe->regmap, ASYS_TOP_CON,\r\nAUDIO_TOP_CON0_A1SYS_A2SYS_ON,\r\nAUDIO_TOP_CON0_A1SYS_A2SYS_ON);\r\nregmap_update_bits(afe->regmap, AFE_DAC_CON0,\r\nAFE_DAC_CON0_AFE_ON,\r\nAFE_DAC_CON0_AFE_ON);\r\nregmap_write(afe->regmap, PWR2_TOP_CON,\r\nPWR2_TOP_CON_INIT_VAL);\r\nregmap_write(afe->regmap, PWR1_ASM_CON1,\r\nPWR1_ASM_CON1_INIT_VAL);\r\nregmap_write(afe->regmap, PWR2_ASM_CON1,\r\nPWR2_ASM_CON1_INIT_VAL);\r\nreturn 0;\r\n}\r\nvoid mt2701_afe_disable_clock(struct mtk_base_afe *afe)\r\n{\r\nmt2701_turn_off_afe_clock(afe);\r\nmt2701_turn_off_a1sys_clock(afe);\r\nmt2701_turn_off_a2sys_clock(afe);\r\nregmap_update_bits(afe->regmap, ASYS_TOP_CON,\r\nAUDIO_TOP_CON0_A1SYS_A2SYS_ON, 0);\r\nregmap_update_bits(afe->regmap, AFE_DAC_CON0,\r\nAFE_DAC_CON0_AFE_ON, 0);\r\n}\r\nint mt2701_turn_on_a1sys_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nint ret = 0;\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_MUX1_SEL]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUD_MUX1_SEL], ret);\r\ngoto A1SYS_CLK_AUD_MUX1_SEL_ERR;\r\n}\r\nret = clk_set_parent(afe_priv->clocks[MT2701_AUD_AUD_MUX1_SEL],\r\nafe_priv->clocks[MT2701_AUD_AUD1PLL_98M]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n", __func__,\r\naud_clks[MT2701_AUD_AUD_MUX1_SEL],\r\naud_clks[MT2701_AUD_AUD1PLL_98M], ret);\r\ngoto A1SYS_CLK_AUD_MUX1_SEL_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_MUX1_DIV]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__,\r\naud_clks[MT2701_AUD_AUD_MUX1_DIV],\r\nret);\r\ngoto A1SYS_CLK_AUD_MUX1_DIV_ERR;\r\n}\r\nret = clk_set_rate(afe_priv->clocks[MT2701_AUD_AUD_MUX1_DIV],\r\nMT2701_AUD_AUD_MUX1_DIV_RATE);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%d fail %d\n", __func__,\r\naud_clks[MT2701_AUD_AUD_MUX1_DIV],\r\nMT2701_AUD_AUD_MUX1_DIV_RATE, ret);\r\ngoto A1SYS_CLK_AUD_MUX1_DIV_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_48K_TIMING]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUD_48K_TIMING], ret);\r\ngoto A1SYS_CLK_AUD_48K_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_INFRA_SYS_AUDIO], ret);\r\ngoto A1SYS_CLK_INFRA_ERR;\r\n}\r\nreturn 0;\r\nA1SYS_CLK_INFRA_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nA1SYS_CLK_AUD_48K_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_48K_TIMING]);\r\nA1SYS_CLK_AUD_MUX1_DIV_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX1_DIV]);\r\nA1SYS_CLK_AUD_MUX1_SEL_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX1_SEL]);\r\nreturn ret;\r\n}\r\nvoid mt2701_turn_off_a1sys_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_48K_TIMING]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX1_DIV]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX1_SEL]);\r\n}\r\nint mt2701_turn_on_a2sys_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nint ret = 0;\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_MUX2_SEL]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUD_MUX2_SEL], ret);\r\ngoto A2SYS_CLK_AUD_MUX2_SEL_ERR;\r\n}\r\nret = clk_set_parent(afe_priv->clocks[MT2701_AUD_AUD_MUX2_SEL],\r\nafe_priv->clocks[MT2701_AUD_AUD2PLL_90M]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n", __func__,\r\naud_clks[MT2701_AUD_AUD_MUX2_SEL],\r\naud_clks[MT2701_AUD_AUD2PLL_90M], ret);\r\ngoto A2SYS_CLK_AUD_MUX2_SEL_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_MUX2_DIV]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUD_MUX2_DIV], ret);\r\ngoto A2SYS_CLK_AUD_MUX2_DIV_ERR;\r\n}\r\nret = clk_set_rate(afe_priv->clocks[MT2701_AUD_AUD_MUX2_DIV],\r\nMT2701_AUD_AUD_MUX2_DIV_RATE);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%d fail %d\n", __func__,\r\naud_clks[MT2701_AUD_AUD_MUX2_DIV],\r\nMT2701_AUD_AUD_MUX2_DIV_RATE, ret);\r\ngoto A2SYS_CLK_AUD_MUX2_DIV_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUD_44K_TIMING]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUD_44K_TIMING], ret);\r\ngoto A2SYS_CLK_AUD_44K_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_INFRA_SYS_AUDIO], ret);\r\ngoto A2SYS_CLK_INFRA_ERR;\r\n}\r\nreturn 0;\r\nA2SYS_CLK_INFRA_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nA2SYS_CLK_AUD_44K_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_44K_TIMING]);\r\nA2SYS_CLK_AUD_MUX2_DIV_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX2_DIV]);\r\nA2SYS_CLK_AUD_MUX2_SEL_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX2_SEL]);\r\nreturn ret;\r\n}\r\nvoid mt2701_turn_off_a2sys_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_44K_TIMING]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX2_DIV]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUD_MUX2_SEL]);\r\n}\r\nint mt2701_turn_on_afe_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nint ret;\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_INFRA_SYS_AUDIO], ret);\r\ngoto AFE_AUD_INFRA_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_AUDINTBUS]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_AUDINTBUS], ret);\r\ngoto AFE_AUD_AUDINTBUS_ERR;\r\n}\r\nret = clk_set_parent(afe_priv->clocks[MT2701_AUD_AUDINTBUS],\r\nafe_priv->clocks[MT2701_AUD_SYSPLL1_D4]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n", __func__,\r\naud_clks[MT2701_AUD_AUDINTBUS],\r\naud_clks[MT2701_AUD_SYSPLL1_D4], ret);\r\ngoto AFE_AUD_AUDINTBUS_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_ASM_H_SEL]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_ASM_H_SEL], ret);\r\ngoto AFE_AUD_ASM_H_ERR;\r\n}\r\nret = clk_set_parent(afe_priv->clocks[MT2701_AUD_ASM_H_SEL],\r\nafe_priv->clocks[MT2701_AUD_UNIVPLL2_D2]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n", __func__,\r\naud_clks[MT2701_AUD_ASM_H_SEL],\r\naud_clks[MT2701_AUD_UNIVPLL2_D2], ret);\r\ngoto AFE_AUD_ASM_H_ERR;\r\n}\r\nret = clk_prepare_enable(afe_priv->clocks[MT2701_AUD_ASM_M_SEL]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[MT2701_AUD_ASM_M_SEL], ret);\r\ngoto AFE_AUD_ASM_M_ERR;\r\n}\r\nret = clk_set_parent(afe_priv->clocks[MT2701_AUD_ASM_M_SEL],\r\nafe_priv->clocks[MT2701_AUD_UNIVPLL2_D4]);\r\nif (ret) {\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n", __func__,\r\naud_clks[MT2701_AUD_ASM_M_SEL],\r\naud_clks[MT2701_AUD_UNIVPLL2_D4], ret);\r\ngoto AFE_AUD_ASM_M_ERR;\r\n}\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\r\nAUDIO_TOP_CON0_PDN_AFE, 0);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\r\nAUDIO_TOP_CON0_PDN_APLL_CK, 0);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_A1SYS, 0);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_A2SYS, 0);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_AFE_CONN, 0);\r\nreturn 0;\r\nAFE_AUD_ASM_M_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_ASM_M_SEL]);\r\nAFE_AUD_ASM_H_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_ASM_H_SEL]);\r\nAFE_AUD_AUDINTBUS_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUDINTBUS]);\r\nAFE_AUD_INFRA_ERR:\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nreturn ret;\r\n}\r\nvoid mt2701_turn_off_afe_clock(struct mtk_base_afe *afe)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_INFRA_SYS_AUDIO]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_AUDINTBUS]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_ASM_H_SEL]);\r\nclk_disable_unprepare(afe_priv->clocks[MT2701_AUD_ASM_M_SEL]);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\r\nAUDIO_TOP_CON0_PDN_AFE, AUDIO_TOP_CON0_PDN_AFE);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON0,\r\nAUDIO_TOP_CON0_PDN_APLL_CK,\r\nAUDIO_TOP_CON0_PDN_APLL_CK);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_A1SYS,\r\nAUDIO_TOP_CON4_PDN_A1SYS);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_A2SYS,\r\nAUDIO_TOP_CON4_PDN_A2SYS);\r\nregmap_update_bits(afe->regmap, AUDIO_TOP_CON4,\r\nAUDIO_TOP_CON4_PDN_AFE_CONN,\r\nAUDIO_TOP_CON4_PDN_AFE_CONN);\r\n}\r\nvoid mt2701_mclk_configuration(struct mtk_base_afe *afe, int id, int domain,\r\nint mclk)\r\n{\r\nstruct mt2701_afe_private *afe_priv = afe->platform_priv;\r\nint ret;\r\nint aud_src_div_id = MT2701_AUD_AUD_K1_SRC_DIV + id;\r\nint aud_src_clk_id = MT2701_AUD_AUD_K1_SRC_SEL + id;\r\nret = clk_prepare_enable(afe_priv->clocks[aud_src_clk_id]);\r\nif (ret)\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[aud_src_clk_id], ret);\r\nif (domain == 0) {\r\nret = clk_set_parent(afe_priv->clocks[aud_src_clk_id],\r\nafe_priv->clocks[MT2701_AUD_AUD_MUX1_SEL]);\r\nif (ret)\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n",\r\n__func__, aud_clks[aud_src_clk_id],\r\naud_clks[MT2701_AUD_AUD_MUX1_SEL], ret);\r\n} else {\r\nret = clk_set_parent(afe_priv->clocks[aud_src_clk_id],\r\nafe_priv->clocks[MT2701_AUD_AUD_MUX2_SEL]);\r\nif (ret)\r\ndev_err(afe->dev, "%s clk_set_parent %s-%s fail %d\n",\r\n__func__, aud_clks[aud_src_clk_id],\r\naud_clks[MT2701_AUD_AUD_MUX2_SEL], ret);\r\n}\r\nclk_disable_unprepare(afe_priv->clocks[aud_src_clk_id]);\r\nret = clk_prepare_enable(afe_priv->clocks[aud_src_div_id]);\r\nif (ret)\r\ndev_err(afe->dev, "%s clk_prepare_enable %s fail %d\n",\r\n__func__, aud_clks[aud_src_div_id], ret);\r\nret = clk_set_rate(afe_priv->clocks[aud_src_div_id], mclk);\r\nif (ret)\r\ndev_err(afe->dev, "%s clk_set_rate %s-%d fail %d\n", __func__,\r\naud_clks[aud_src_div_id], mclk, ret);\r\nclk_disable_unprepare(afe_priv->clocks[aud_src_div_id]);\r\n}

notrace unsigned long __init early_init(unsigned long dt_ptr)\r\n{\r\nunsigned long offset = reloc_offset();\r\nmemset_io((void __iomem *)PTRRELOC(&__bss_start), 0,\r\n__bss_stop - __bss_start);\r\nidentify_cpu(offset, mfspr(SPRN_PVR));\r\napply_feature_fixups();\r\nreturn KERNELBASE + offset;\r\n}\r\nnotrace void __init machine_init(u64 dt_ptr)\r\n{\r\nsetup_feature_keys();\r\nudbg_early_init();\r\npatch_instruction((unsigned int *)&memcpy, PPC_INST_NOP);\r\npatch_instruction(&memset_nocache_branch, PPC_INST_NOP);\r\nearly_init_devtree(__va(dt_ptr));\r\nearly_init_mmu();\r\nsetup_kdump_trampoline();\r\n}\r\nint __init ppc_setup_l2cr(char *str)\r\n{\r\nif (cpu_has_feature(CPU_FTR_L2CR)) {\r\nunsigned long val = simple_strtoul(str, NULL, 0);\r\nprintk(KERN_INFO "l2cr set to %lx\n", val);\r\n_set_L2CR(0);\r\n_set_L2CR(val);\r\n}\r\nreturn 1;\r\n}\r\nint __init ppc_setup_l3cr(char *str)\r\n{\r\nif (cpu_has_feature(CPU_FTR_L3CR)) {\r\nunsigned long val = simple_strtoul(str, NULL, 0);\r\nprintk(KERN_INFO "l3cr set to %lx\n", val);\r\n_set_L3CR(val);\r\n}\r\nreturn 1;\r\n}\r\nunsigned char nvram_read_byte(int addr)\r\n{\r\nif (ppc_md.nvram_read_val)\r\nreturn ppc_md.nvram_read_val(addr);\r\nreturn 0xff;\r\n}\r\nvoid nvram_write_byte(unsigned char val, int addr)\r\n{\r\nif (ppc_md.nvram_write_val)\r\nppc_md.nvram_write_val(addr, val);\r\n}\r\nssize_t nvram_get_size(void)\r\n{\r\nif (ppc_md.nvram_size)\r\nreturn ppc_md.nvram_size();\r\nreturn -1;\r\n}\r\nvoid nvram_sync(void)\r\n{\r\nif (ppc_md.nvram_sync)\r\nppc_md.nvram_sync();\r\n}\r\nint __init ppc_init(void)\r\n{\r\nif (ppc_md.progress)\r\nppc_md.progress(" ", 0xffff);\r\nif (ppc_md.init != NULL) {\r\nppc_md.init();\r\n}\r\nreturn 0;\r\n}\r\nvoid __init irqstack_early_init(void)\r\n{\r\nunsigned int i;\r\nfor_each_possible_cpu(i) {\r\nsoftirq_ctx[i] = (struct thread_info *)\r\n__va(memblock_alloc(THREAD_SIZE, THREAD_SIZE));\r\nhardirq_ctx[i] = (struct thread_info *)\r\n__va(memblock_alloc(THREAD_SIZE, THREAD_SIZE));\r\n}\r\n}\r\nvoid __init exc_lvl_early_init(void)\r\n{\r\nunsigned int i, hw_cpu;\r\nfor_each_possible_cpu(i) {\r\n#ifdef CONFIG_SMP\r\nhw_cpu = get_hard_smp_processor_id(i);\r\n#else\r\nhw_cpu = 0;\r\n#endif\r\ncritirq_ctx[hw_cpu] = (struct thread_info *)\r\n__va(memblock_alloc(THREAD_SIZE, THREAD_SIZE));\r\n#ifdef CONFIG_BOOKE\r\ndbgirq_ctx[hw_cpu] = (struct thread_info *)\r\n__va(memblock_alloc(THREAD_SIZE, THREAD_SIZE));\r\nmcheckirq_ctx[hw_cpu] = (struct thread_info *)\r\n__va(memblock_alloc(THREAD_SIZE, THREAD_SIZE));\r\n#endif\r\n}\r\n}\r\nvoid __init setup_power_save(void)\r\n{\r\n#ifdef CONFIG_6xx\r\nif (cpu_has_feature(CPU_FTR_CAN_DOZE) ||\r\ncpu_has_feature(CPU_FTR_CAN_NAP))\r\nppc_md.power_save = ppc6xx_idle;\r\n#endif\r\n#ifdef CONFIG_E500\r\nif (cpu_has_feature(CPU_FTR_CAN_DOZE) ||\r\ncpu_has_feature(CPU_FTR_CAN_NAP))\r\nppc_md.power_save = e500_idle;\r\n#endif\r\n}\r\n__init void initialize_cache_info(void)\r\n{\r\ndcache_bsize = cur_cpu_spec->dcache_bsize;\r\nicache_bsize = cur_cpu_spec->icache_bsize;\r\nucache_bsize = 0;\r\nif (cpu_has_feature(CPU_FTR_UNIFIED_ID_CACHE))\r\nucache_bsize = icache_bsize = dcache_bsize;\r\n}

static int rx4581_set_reg(struct device *dev, unsigned char address,\r\nunsigned char data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[2];\r\nbuf[0] = address & 0x0f;\r\nbuf[1] = data;\r\nreturn spi_write_then_read(spi, buf, 2, NULL, 0);\r\n}\r\nstatic int rx4581_get_reg(struct device *dev, unsigned char address,\r\nunsigned char *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\n*data = address | 0x80;\r\nreturn spi_write_then_read(spi, data, 1, data, 1);\r\n}\r\nstatic int rx4581_get_datetime(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char date[7];\r\nunsigned char data;\r\nint err;\r\nerr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to read device flags\n");\r\nreturn -EIO;\r\n}\r\ndo {\r\nif (data & RX4581_FLAG_UF) {\r\nerr = rx4581_set_reg(dev,\r\nRX4581_REG_FLAG, (data & ~RX4581_FLAG_UF));\r\nif (err != 0) {\r\ndev_err(dev, "Unable to write device "\r\n"flags\n");\r\nreturn -EIO;\r\n}\r\n}\r\ndate[0] = 0x80;\r\nerr = spi_write_then_read(spi, date, 1, date, 7);\r\nif (err < 0) {\r\ndev_err(dev, "Unable to read date\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to read device flags\n");\r\nreturn -EIO;\r\n}\r\n} while (data & RX4581_FLAG_UF);\r\nif (data & RX4581_FLAG_VLF)\r\ndev_info(dev,\r\n"low voltage detected, date/time is not reliable.\n");\r\ndev_dbg(dev,\r\n"%s: raw data is sec=%02x, min=%02x, hr=%02x, "\r\n"wday=%02x, mday=%02x, mon=%02x, year=%02x\n",\r\n__func__,\r\ndate[0], date[1], date[2], date[3], date[4], date[5], date[6]);\r\ntm->tm_sec = bcd2bin(date[RX4581_REG_SC] & 0x7F);\r\ntm->tm_min = bcd2bin(date[RX4581_REG_MN] & 0x7F);\r\ntm->tm_hour = bcd2bin(date[RX4581_REG_HR] & 0x3F);\r\ntm->tm_wday = ilog2(date[RX4581_REG_DW] & 0x7F);\r\ntm->tm_mday = bcd2bin(date[RX4581_REG_DM] & 0x3F);\r\ntm->tm_mon = bcd2bin(date[RX4581_REG_MO] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(date[RX4581_REG_YR]);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nerr = rtc_valid_tm(tm);\r\nif (err < 0)\r\ndev_err(dev, "retrieved date/time is not valid.\n");\r\nreturn err;\r\n}\r\nstatic int rx4581_set_datetime(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint err;\r\nunsigned char buf[8], data;\r\ndev_dbg(dev, "%s: secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nbuf[0] = 0x00;\r\nbuf[RX4581_REG_SC+1] = bin2bcd(tm->tm_sec);\r\nbuf[RX4581_REG_MN+1] = bin2bcd(tm->tm_min);\r\nbuf[RX4581_REG_HR+1] = bin2bcd(tm->tm_hour);\r\nbuf[RX4581_REG_DM+1] = bin2bcd(tm->tm_mday);\r\nbuf[RX4581_REG_MO+1] = bin2bcd(tm->tm_mon + 1);\r\nbuf[RX4581_REG_YR+1] = bin2bcd(tm->tm_year % 100);\r\nbuf[RX4581_REG_DW+1] = (0x1 << tm->tm_wday);\r\nerr = rx4581_get_reg(dev, RX4581_REG_CTRL, &data);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to read control register\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_set_reg(dev, RX4581_REG_CTRL,\r\n(data | RX4581_CTRL_STOP));\r\nif (err != 0) {\r\ndev_err(dev, "Unable to write control register\n");\r\nreturn -EIO;\r\n}\r\nerr = spi_write_then_read(spi, buf, 8, NULL, 0);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to write to date registers\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to read flag register\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_set_reg(dev, RX4581_REG_FLAG,\r\n(data & ~(RX4581_FLAG_VLF)));\r\nif (err != 0) {\r\ndev_err(dev, "Unable to write flag register\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_get_reg(dev, RX4581_REG_CTRL, &data);\r\nif (err != 0) {\r\ndev_err(dev, "Unable to read control register\n");\r\nreturn -EIO;\r\n}\r\nerr = rx4581_set_reg(dev, RX4581_REG_CTRL,\r\n(data & ~(RX4581_CTRL_STOP)));\r\nif (err != 0) {\r\ndev_err(dev, "Unable to write control register\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rx4581_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nunsigned char tmp;\r\nint res;\r\nres = rx4581_get_reg(&spi->dev, RX4581_REG_SC, &tmp);\r\nif (res != 0)\r\nreturn res;\r\nrtc = devm_rtc_device_register(&spi->dev, "rx4581",\r\n&rx4581_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nspi_set_drvdata(spi, rtc);\r\nreturn 0;\r\n}

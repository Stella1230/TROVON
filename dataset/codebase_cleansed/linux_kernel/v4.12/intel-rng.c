static inline u8 hwstatus_get(void __iomem *mem)\r\n{\r\nreturn readb(mem + INTEL_RNG_HW_STATUS);\r\n}\r\nstatic inline u8 hwstatus_set(void __iomem *mem,\r\nu8 hw_status)\r\n{\r\nwriteb(hw_status, mem + INTEL_RNG_HW_STATUS);\r\nreturn hwstatus_get(mem);\r\n}\r\nstatic int intel_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\nint data, i;\r\nfor (i = 0; i < 20; i++) {\r\ndata = !!(readb(mem + INTEL_RNG_STATUS) &\r\nINTEL_RNG_DATA_PRESENT);\r\nif (data || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn data;\r\n}\r\nstatic int intel_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\n*data = readb(mem + INTEL_RNG_DATA);\r\nreturn 1;\r\n}\r\nstatic int intel_rng_init(struct hwrng *rng)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\nu8 hw_status;\r\nint err = -EIO;\r\nhw_status = hwstatus_get(mem);\r\nif ((hw_status & INTEL_RNG_ENABLED) == 0)\r\nhw_status = hwstatus_set(mem, hw_status | INTEL_RNG_ENABLED);\r\nif ((hw_status & INTEL_RNG_ENABLED) == 0) {\r\npr_err(PFX "cannot enable RNG, aborting\n");\r\ngoto out;\r\n}\r\nerr = 0;\r\nout:\r\nreturn err;\r\n}\r\nstatic void intel_rng_cleanup(struct hwrng *rng)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\nu8 hw_status;\r\nhw_status = hwstatus_get(mem);\r\nif (hw_status & INTEL_RNG_ENABLED)\r\nhwstatus_set(mem, hw_status & ~INTEL_RNG_ENABLED);\r\nelse\r\npr_warn(PFX "unusual: RNG already disabled\n");\r\n}\r\nstatic int __init intel_rng_hw_init(void *_intel_rng_hw)\r\n{\r\nstruct intel_rng_hw *intel_rng_hw = _intel_rng_hw;\r\nu8 mfc, dvc;\r\nif (!(intel_rng_hw->fwh_dec_en1_val & FWH_F8_EN_MASK))\r\npci_write_config_byte(intel_rng_hw->dev,\r\nintel_rng_hw->fwh_dec_en1_off,\r\nintel_rng_hw->fwh_dec_en1_val |\r\nFWH_F8_EN_MASK);\r\nif (!(intel_rng_hw->bios_cntl_val & BIOS_CNTL_WRITE_ENABLE_MASK))\r\npci_write_config_byte(intel_rng_hw->dev,\r\nintel_rng_hw->bios_cntl_off,\r\nintel_rng_hw->bios_cntl_val |\r\nBIOS_CNTL_WRITE_ENABLE_MASK);\r\nwriteb(INTEL_FWH_RESET_CMD, intel_rng_hw->mem);\r\nwriteb(INTEL_FWH_READ_ID_CMD, intel_rng_hw->mem);\r\nmfc = readb(intel_rng_hw->mem + INTEL_FWH_MANUFACTURER_CODE_ADDRESS);\r\ndvc = readb(intel_rng_hw->mem + INTEL_FWH_DEVICE_CODE_ADDRESS);\r\nwriteb(INTEL_FWH_RESET_CMD, intel_rng_hw->mem);\r\nif (!(intel_rng_hw->bios_cntl_val &\r\n(BIOS_CNTL_LOCK_ENABLE_MASK|BIOS_CNTL_WRITE_ENABLE_MASK)))\r\npci_write_config_byte(intel_rng_hw->dev,\r\nintel_rng_hw->bios_cntl_off,\r\nintel_rng_hw->bios_cntl_val);\r\nif (!(intel_rng_hw->fwh_dec_en1_val & FWH_F8_EN_MASK))\r\npci_write_config_byte(intel_rng_hw->dev,\r\nintel_rng_hw->fwh_dec_en1_off,\r\nintel_rng_hw->fwh_dec_en1_val);\r\nif (mfc != INTEL_FWH_MANUFACTURER_CODE ||\r\n(dvc != INTEL_FWH_DEVICE_CODE_8M &&\r\ndvc != INTEL_FWH_DEVICE_CODE_4M)) {\r\npr_notice(PFX "FWH not detected\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init intel_init_hw_struct(struct intel_rng_hw *intel_rng_hw,\r\nstruct pci_dev *dev)\r\n{\r\nintel_rng_hw->bios_cntl_val = 0xff;\r\nintel_rng_hw->fwh_dec_en1_val = 0xff;\r\nintel_rng_hw->dev = dev;\r\nif (dev->device < 0x2640) {\r\nintel_rng_hw->fwh_dec_en1_off = FWH_DEC_EN1_REG_OLD;\r\nintel_rng_hw->bios_cntl_off = BIOS_CNTL_REG_OLD;\r\n} else {\r\nintel_rng_hw->fwh_dec_en1_off = FWH_DEC_EN1_REG_NEW;\r\nintel_rng_hw->bios_cntl_off = BIOS_CNTL_REG_NEW;\r\n}\r\npci_read_config_byte(dev, intel_rng_hw->fwh_dec_en1_off,\r\n&intel_rng_hw->fwh_dec_en1_val);\r\npci_read_config_byte(dev, intel_rng_hw->bios_cntl_off,\r\n&intel_rng_hw->bios_cntl_val);\r\nif ((intel_rng_hw->bios_cntl_val &\r\n(BIOS_CNTL_LOCK_ENABLE_MASK|BIOS_CNTL_WRITE_ENABLE_MASK))\r\n== BIOS_CNTL_LOCK_ENABLE_MASK) {\r\nstatic __initdata char warning[] =\r\nPFX "Firmware space is locked read-only. If you can't or\n"\r\nPFX "don't want to disable this in firmware setup, and if\n"\r\nPFX "you are certain that your system has a functional\n"\r\nPFX "RNG, try using the 'no_fwh_detect' option.\n";\r\nif (no_fwh_detect)\r\nreturn -ENODEV;\r\npr_warn("%s", warning);\r\nreturn -EBUSY;\r\n}\r\nintel_rng_hw->mem = ioremap_nocache(INTEL_FWH_ADDR, INTEL_FWH_ADDR_LEN);\r\nif (intel_rng_hw->mem == NULL)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic int __init mod_init(void)\r\n{\r\nint err = -ENODEV;\r\nint i;\r\nstruct pci_dev *dev = NULL;\r\nvoid __iomem *mem = mem;\r\nu8 hw_status;\r\nstruct intel_rng_hw *intel_rng_hw;\r\nfor (i = 0; !dev && pci_tbl[i].vendor; ++i)\r\ndev = pci_get_device(pci_tbl[i].vendor, pci_tbl[i].device,\r\nNULL);\r\nif (!dev)\r\ngoto out;\r\nif (no_fwh_detect < 0) {\r\npci_dev_put(dev);\r\ngoto fwh_done;\r\n}\r\nintel_rng_hw = kmalloc(sizeof(*intel_rng_hw), GFP_KERNEL);\r\nif (!intel_rng_hw) {\r\npci_dev_put(dev);\r\ngoto out;\r\n}\r\nerr = intel_init_hw_struct(intel_rng_hw, dev);\r\nif (err) {\r\npci_dev_put(dev);\r\nkfree(intel_rng_hw);\r\nif (err == -ENODEV)\r\ngoto fwh_done;\r\ngoto out;\r\n}\r\nerr = stop_machine(intel_rng_hw_init, intel_rng_hw, NULL);\r\npci_dev_put(dev);\r\niounmap(intel_rng_hw->mem);\r\nkfree(intel_rng_hw);\r\nif (err)\r\ngoto out;\r\nfwh_done:\r\nerr = -ENOMEM;\r\nmem = ioremap(INTEL_RNG_ADDR, INTEL_RNG_ADDR_LEN);\r\nif (!mem)\r\ngoto out;\r\nintel_rng.priv = (unsigned long)mem;\r\nerr = -ENODEV;\r\nhw_status = hwstatus_get(mem);\r\nif ((hw_status & INTEL_RNG_PRESENT) == 0) {\r\niounmap(mem);\r\ngoto out;\r\n}\r\npr_info("Intel 82802 RNG detected\n");\r\nerr = hwrng_register(&intel_rng);\r\nif (err) {\r\npr_err(PFX "RNG registering failed (%d)\n",\r\nerr);\r\niounmap(mem);\r\n}\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit mod_exit(void)\r\n{\r\nvoid __iomem *mem = (void __iomem *)intel_rng.priv;\r\nhwrng_unregister(&intel_rng);\r\niounmap(mem);\r\n}

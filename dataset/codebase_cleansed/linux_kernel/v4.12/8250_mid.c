static int pnw_setup(struct mid8250 *mid, struct uart_port *p)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(p->dev);\r\nswitch (pdev->device) {\r\ncase PCI_DEVICE_ID_INTEL_PNW_UART1:\r\nmid->dma_index = 0;\r\nbreak;\r\ncase PCI_DEVICE_ID_INTEL_PNW_UART2:\r\nmid->dma_index = 1;\r\nbreak;\r\ncase PCI_DEVICE_ID_INTEL_PNW_UART3:\r\nmid->dma_index = 2;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmid->dma_dev = pci_get_slot(pdev->bus,\r\nPCI_DEVFN(PCI_SLOT(pdev->devfn), 3));\r\nreturn 0;\r\n}\r\nstatic int tng_handle_irq(struct uart_port *p)\r\n{\r\nstruct mid8250 *mid = p->private_data;\r\nstruct uart_8250_port *up = up_to_u8250p(p);\r\nstruct hsu_dma_chip *chip;\r\nu32 status;\r\nint ret = 0;\r\nint err;\r\nchip = pci_get_drvdata(mid->dma_dev);\r\nerr = hsu_dma_get_status(chip, mid->dma_index * 2 + 1, &status);\r\nif (err > 0) {\r\nserial8250_rx_dma_flush(up);\r\nret |= 1;\r\n} else if (err == 0)\r\nret |= hsu_dma_do_irq(chip, mid->dma_index * 2 + 1, status);\r\nerr = hsu_dma_get_status(chip, mid->dma_index * 2, &status);\r\nif (err > 0)\r\nret |= 1;\r\nelse if (err == 0)\r\nret |= hsu_dma_do_irq(chip, mid->dma_index * 2, status);\r\nret |= serial8250_handle_irq(p, serial_port_in(p, UART_IIR));\r\nreturn IRQ_RETVAL(ret);\r\n}\r\nstatic int tng_setup(struct mid8250 *mid, struct uart_port *p)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(p->dev);\r\nint index = PCI_FUNC(pdev->devfn);\r\nif (index-- == 0)\r\nreturn -ENODEV;\r\nmid->dma_index = index;\r\nmid->dma_dev = pci_get_slot(pdev->bus, PCI_DEVFN(5, 0));\r\np->handle_irq = tng_handle_irq;\r\nreturn 0;\r\n}\r\nstatic int dnv_handle_irq(struct uart_port *p)\r\n{\r\nstruct mid8250 *mid = p->private_data;\r\nstruct uart_8250_port *up = up_to_u8250p(p);\r\nunsigned int fisr = serial_port_in(p, INTEL_MID_UART_DNV_FISR);\r\nu32 status;\r\nint ret = 0;\r\nint err;\r\nif (fisr & BIT(2)) {\r\nerr = hsu_dma_get_status(&mid->dma_chip, 1, &status);\r\nif (err > 0) {\r\nserial8250_rx_dma_flush(up);\r\nret |= 1;\r\n} else if (err == 0)\r\nret |= hsu_dma_do_irq(&mid->dma_chip, 1, status);\r\n}\r\nif (fisr & BIT(1)) {\r\nerr = hsu_dma_get_status(&mid->dma_chip, 0, &status);\r\nif (err > 0)\r\nret |= 1;\r\nelse if (err == 0)\r\nret |= hsu_dma_do_irq(&mid->dma_chip, 0, status);\r\n}\r\nif (fisr & BIT(0))\r\nret |= serial8250_handle_irq(p, serial_port_in(p, UART_IIR));\r\nreturn IRQ_RETVAL(ret);\r\n}\r\nstatic int dnv_setup(struct mid8250 *mid, struct uart_port *p)\r\n{\r\nstruct hsu_dma_chip *chip = &mid->dma_chip;\r\nstruct pci_dev *pdev = to_pci_dev(p->dev);\r\nunsigned int bar = FL_GET_BASE(mid->board->flags);\r\nint ret;\r\npci_set_master(pdev);\r\nret = pci_alloc_irq_vectors(pdev, 1, 1, PCI_IRQ_ALL_TYPES);\r\nif (ret < 0)\r\nreturn ret;\r\np->irq = pci_irq_vector(pdev, 0);\r\nchip->dev = &pdev->dev;\r\nchip->irq = pci_irq_vector(pdev, 0);\r\nchip->regs = p->membase;\r\nchip->length = pci_resource_len(pdev, bar);\r\nchip->offset = DNV_DMA_CHAN_OFFSET;\r\nret = hsu_dma_probe(chip);\r\nif (ret)\r\nreturn 0;\r\nmid->dma_dev = pdev;\r\np->handle_irq = dnv_handle_irq;\r\nreturn 0;\r\n}\r\nstatic void dnv_exit(struct mid8250 *mid)\r\n{\r\nif (!mid->dma_dev)\r\nreturn;\r\nhsu_dma_remove(&mid->dma_chip);\r\n}\r\nstatic void mid8250_set_termios(struct uart_port *p,\r\nstruct ktermios *termios,\r\nstruct ktermios *old)\r\n{\r\nunsigned int baud = tty_termios_baud_rate(termios);\r\nstruct mid8250 *mid = p->private_data;\r\nunsigned short ps = 16;\r\nunsigned long fuart = baud * ps;\r\nunsigned long w = BIT(24) - 1;\r\nunsigned long mul, div;\r\nfuart = fuart ? fuart : 9600 * 16;\r\nif (mid->board->freq < fuart) {\r\nif (mid->board->freq > baud)\r\nps = mid->board->freq / baud;\r\nelse\r\nps = 1;\r\nfuart = baud * ps;\r\n} else {\r\nfuart *= rounddown_pow_of_two(mid->board->freq / fuart);\r\n}\r\nrational_best_approximation(fuart, mid->board->freq, w, w, &mul, &div);\r\np->uartclk = fuart * 16 / ps;\r\nwritel(ps, p->membase + INTEL_MID_UART_PS);\r\nwritel(mul, p->membase + INTEL_MID_UART_MUL);\r\nwritel(div, p->membase + INTEL_MID_UART_DIV);\r\nserial8250_do_set_termios(p, termios, old);\r\n}\r\nstatic bool mid8250_dma_filter(struct dma_chan *chan, void *param)\r\n{\r\nstruct hsu_dma_slave *s = param;\r\nif (s->dma_dev != chan->device->dev || s->chan_id != chan->chan_id)\r\nreturn false;\r\nchan->private = s;\r\nreturn true;\r\n}\r\nstatic int mid8250_dma_setup(struct mid8250 *mid, struct uart_8250_port *port)\r\n{\r\nstruct uart_8250_dma *dma = &mid->dma;\r\nstruct device *dev = port->port.dev;\r\nstruct hsu_dma_slave *rx_param;\r\nstruct hsu_dma_slave *tx_param;\r\nif (!mid->dma_dev)\r\nreturn 0;\r\nrx_param = devm_kzalloc(dev, sizeof(*rx_param), GFP_KERNEL);\r\nif (!rx_param)\r\nreturn -ENOMEM;\r\ntx_param = devm_kzalloc(dev, sizeof(*tx_param), GFP_KERNEL);\r\nif (!tx_param)\r\nreturn -ENOMEM;\r\nrx_param->chan_id = mid->dma_index * 2 + 1;\r\ntx_param->chan_id = mid->dma_index * 2;\r\ndma->rxconf.src_maxburst = 64;\r\ndma->txconf.dst_maxburst = 64;\r\nrx_param->dma_dev = &mid->dma_dev->dev;\r\ntx_param->dma_dev = &mid->dma_dev->dev;\r\ndma->fn = mid8250_dma_filter;\r\ndma->rx_param = rx_param;\r\ndma->tx_param = tx_param;\r\nport->dma = dma;\r\nreturn 0;\r\n}\r\nstatic int mid8250_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct uart_8250_port uart;\r\nstruct mid8250 *mid;\r\nunsigned int bar;\r\nint ret;\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nmid = devm_kzalloc(&pdev->dev, sizeof(*mid), GFP_KERNEL);\r\nif (!mid)\r\nreturn -ENOMEM;\r\nmid->board = (struct mid8250_board *)id->driver_data;\r\nbar = FL_GET_BASE(mid->board->flags);\r\nmemset(&uart, 0, sizeof(struct uart_8250_port));\r\nuart.port.dev = &pdev->dev;\r\nuart.port.irq = pdev->irq;\r\nuart.port.private_data = mid;\r\nuart.port.type = PORT_16750;\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.uartclk = mid->board->base_baud * 16;\r\nuart.port.flags = UPF_SHARE_IRQ | UPF_FIXED_PORT | UPF_FIXED_TYPE;\r\nuart.port.set_termios = mid8250_set_termios;\r\nuart.port.mapbase = pci_resource_start(pdev, bar);\r\nuart.port.membase = pcim_iomap(pdev, bar, 0);\r\nif (!uart.port.membase)\r\nreturn -ENOMEM;\r\nif (mid->board->setup) {\r\nret = mid->board->setup(mid, &uart.port);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = mid8250_dma_setup(mid, &uart);\r\nif (ret)\r\ngoto err;\r\nret = serial8250_register_8250_port(&uart);\r\nif (ret < 0)\r\ngoto err;\r\nmid->line = ret;\r\npci_set_drvdata(pdev, mid);\r\nreturn 0;\r\nerr:\r\nif (mid->board->exit)\r\nmid->board->exit(mid);\r\nreturn ret;\r\n}\r\nstatic void mid8250_remove(struct pci_dev *pdev)\r\n{\r\nstruct mid8250 *mid = pci_get_drvdata(pdev);\r\nserial8250_unregister_port(mid->line);\r\nif (mid->board->exit)\r\nmid->board->exit(mid);\r\n}

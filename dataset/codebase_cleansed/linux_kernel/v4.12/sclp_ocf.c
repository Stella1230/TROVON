static void sclp_ocf_change_notify(struct work_struct *work)\r\n{\r\nkobject_uevent(&ocf_kset->kobj, KOBJ_CHANGE);\r\n}\r\nstatic void sclp_ocf_handler(struct evbuf_header *evbuf)\r\n{\r\nstruct gds_vector *v;\r\nstruct gds_subvector *sv, *netid, *cpc;\r\nsize_t size;\r\nv = sclp_find_gds_vector(evbuf + 1, (void *) evbuf + evbuf->length,\r\n0x9f00);\r\nif (!v)\r\nreturn;\r\nv = sclp_find_gds_vector(v + 1, (void *) v + v->length, 0x9f22);\r\nif (!v)\r\nreturn;\r\nsv = sclp_find_gds_subvector(v + 1, (void *) v + v->length, 0x81);\r\nif (!sv)\r\nreturn;\r\nnetid = sclp_find_gds_subvector(sv + 1, (void *) sv + sv->length, 1);\r\ncpc = sclp_find_gds_subvector(sv + 1, (void *) sv + sv->length, 2);\r\nspin_lock(&sclp_ocf_lock);\r\nif (netid) {\r\nsize = min(OCF_LENGTH_HMC_NETWORK, (size_t) netid->length);\r\nmemcpy(hmc_network, netid + 1, size);\r\nEBCASC(hmc_network, size);\r\nhmc_network[size] = 0;\r\n}\r\nif (cpc) {\r\nsize = min(OCF_LENGTH_CPC_NAME, (size_t) cpc->length);\r\nmemset(cpc_name, 0, OCF_LENGTH_CPC_NAME);\r\nmemcpy(cpc_name, cpc + 1, size);\r\n}\r\nspin_unlock(&sclp_ocf_lock);\r\nschedule_work(&sclp_ocf_change_work);\r\n}\r\nvoid sclp_ocf_cpc_name_copy(char *dst)\r\n{\r\nspin_lock_irq(&sclp_ocf_lock);\r\nmemcpy(dst, cpc_name, OCF_LENGTH_CPC_NAME);\r\nspin_unlock_irq(&sclp_ocf_lock);\r\n}\r\nstatic ssize_t cpc_name_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nchar name[OCF_LENGTH_CPC_NAME + 1];\r\nsclp_ocf_cpc_name_copy(name);\r\nname[OCF_LENGTH_CPC_NAME] = 0;\r\nEBCASC(name, OCF_LENGTH_CPC_NAME);\r\nreturn snprintf(page, PAGE_SIZE, "%s\n", name);\r\n}\r\nstatic ssize_t hmc_network_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nint rc;\r\nspin_lock_irq(&sclp_ocf_lock);\r\nrc = snprintf(page, PAGE_SIZE, "%s\n", hmc_network);\r\nspin_unlock_irq(&sclp_ocf_lock);\r\nreturn rc;\r\n}\r\nstatic int __init ocf_init(void)\r\n{\r\nint rc;\r\nINIT_WORK(&sclp_ocf_change_work, sclp_ocf_change_notify);\r\nocf_kset = kset_create_and_add("ocf", NULL, firmware_kobj);\r\nif (!ocf_kset)\r\nreturn -ENOMEM;\r\nrc = sysfs_create_group(&ocf_kset->kobj, &ocf_attr_group);\r\nif (rc) {\r\nkset_unregister(ocf_kset);\r\nreturn rc;\r\n}\r\nreturn sclp_register(&sclp_ocf_event);\r\n}

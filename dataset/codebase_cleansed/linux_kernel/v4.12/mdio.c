int mdio45_probe(struct mdio_if_info *mdio, int prtad)\r\n{\r\nint mmd, stat2, devs1, devs2;\r\nfor (mmd = 1; mmd <= 5; mmd++) {\r\nstat2 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_STAT2);\r\nif (stat2 < 0 ||\r\n(stat2 & MDIO_STAT2_DEVPRST) != MDIO_STAT2_DEVPRST_VAL)\r\ncontinue;\r\ndevs1 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_DEVS1);\r\ndevs2 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_DEVS2);\r\nif (devs1 < 0 || devs2 < 0)\r\ncontinue;\r\nmdio->prtad = prtad;\r\nmdio->mmds = devs1 | (devs2 << 16);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint mdio_set_flag(const struct mdio_if_info *mdio,\r\nint prtad, int devad, u16 addr, int mask,\r\nbool sense)\r\n{\r\nint old_val = mdio->mdio_read(mdio->dev, prtad, devad, addr);\r\nint new_val;\r\nif (old_val < 0)\r\nreturn old_val;\r\nif (sense)\r\nnew_val = old_val | mask;\r\nelse\r\nnew_val = old_val & ~mask;\r\nif (old_val == new_val)\r\nreturn 0;\r\nreturn mdio->mdio_write(mdio->dev, prtad, devad, addr, new_val);\r\n}\r\nint mdio45_links_ok(const struct mdio_if_info *mdio, u32 mmd_mask)\r\n{\r\nint devad, reg;\r\nif (!mmd_mask) {\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad,\r\nMDIO_MMD_PHYXS, MDIO_STAT2);\r\nreturn reg >= 0 && !(reg & MDIO_STAT2_RXFAULT);\r\n}\r\nfor (devad = 0; mmd_mask; devad++) {\r\nif (mmd_mask & (1 << devad)) {\r\nmmd_mask &= ~(1 << devad);\r\nmdio->mdio_read(mdio->dev, mdio->prtad,\r\ndevad, MDIO_STAT1);\r\nif (devad == MDIO_MMD_PMAPMD || devad == MDIO_MMD_PCS ||\r\ndevad == MDIO_MMD_PHYXS || devad == MDIO_MMD_DTEXS)\r\nmdio->mdio_read(mdio->dev, mdio->prtad,\r\ndevad, MDIO_STAT2);\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad,\r\ndevad, MDIO_STAT1);\r\nif (reg < 0 ||\r\n(reg & (MDIO_STAT1_FAULT | MDIO_STAT1_LSTATUS)) !=\r\nMDIO_STAT1_LSTATUS)\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nint mdio45_nway_restart(const struct mdio_if_info *mdio)\r\n{\r\nif (!(mdio->mmds & MDIO_DEVS_AN))\r\nreturn -EOPNOTSUPP;\r\nmdio_set_flag(mdio, mdio->prtad, MDIO_MMD_AN, MDIO_CTRL1,\r\nMDIO_AN_CTRL1_RESTART, true);\r\nreturn 0;\r\n}\r\nstatic u32 mdio45_get_an(const struct mdio_if_info *mdio, u16 addr)\r\n{\r\nu32 result = 0;\r\nint reg;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN, addr);\r\nif (reg & ADVERTISE_10HALF)\r\nresult |= ADVERTISED_10baseT_Half;\r\nif (reg & ADVERTISE_10FULL)\r\nresult |= ADVERTISED_10baseT_Full;\r\nif (reg & ADVERTISE_100HALF)\r\nresult |= ADVERTISED_100baseT_Half;\r\nif (reg & ADVERTISE_100FULL)\r\nresult |= ADVERTISED_100baseT_Full;\r\nif (reg & ADVERTISE_PAUSE_CAP)\r\nresult |= ADVERTISED_Pause;\r\nif (reg & ADVERTISE_PAUSE_ASYM)\r\nresult |= ADVERTISED_Asym_Pause;\r\nreturn result;\r\n}\r\nvoid mdio45_ethtool_gset_npage(const struct mdio_if_info *mdio,\r\nstruct ethtool_cmd *ecmd,\r\nu32 npage_adv, u32 npage_lpa)\r\n{\r\nint reg;\r\nu32 speed;\r\nBUILD_BUG_ON(MDIO_SUPPORTS_C22 != ETH_MDIO_SUPPORTS_C22);\r\nBUILD_BUG_ON(MDIO_SUPPORTS_C45 != ETH_MDIO_SUPPORTS_C45);\r\necmd->transceiver = XCVR_INTERNAL;\r\necmd->phy_address = mdio->prtad;\r\necmd->mdio_support =\r\nmdio->mode_support & (MDIO_SUPPORTS_C45 | MDIO_SUPPORTS_C22);\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_CTRL2);\r\nswitch (reg & MDIO_PMA_CTRL2_TYPE) {\r\ncase MDIO_PMA_CTRL2_10GBT:\r\ncase MDIO_PMA_CTRL2_1000BT:\r\ncase MDIO_PMA_CTRL2_100BTX:\r\ncase MDIO_PMA_CTRL2_10BT:\r\necmd->port = PORT_TP;\r\necmd->supported = SUPPORTED_TP;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_SPEED);\r\nif (reg & MDIO_SPEED_10G)\r\necmd->supported |= SUPPORTED_10000baseT_Full;\r\nif (reg & MDIO_PMA_SPEED_1000)\r\necmd->supported |= (SUPPORTED_1000baseT_Full |\r\nSUPPORTED_1000baseT_Half);\r\nif (reg & MDIO_PMA_SPEED_100)\r\necmd->supported |= (SUPPORTED_100baseT_Full |\r\nSUPPORTED_100baseT_Half);\r\nif (reg & MDIO_PMA_SPEED_10)\r\necmd->supported |= (SUPPORTED_10baseT_Full |\r\nSUPPORTED_10baseT_Half);\r\necmd->advertising = ADVERTISED_TP;\r\nbreak;\r\ncase MDIO_PMA_CTRL2_10GBCX4:\r\necmd->port = PORT_OTHER;\r\necmd->supported = 0;\r\necmd->advertising = 0;\r\nbreak;\r\ncase MDIO_PMA_CTRL2_10GBKX4:\r\ncase MDIO_PMA_CTRL2_10GBKR:\r\ncase MDIO_PMA_CTRL2_1000BKX:\r\necmd->port = PORT_OTHER;\r\necmd->supported = SUPPORTED_Backplane;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_EXTABLE);\r\nif (reg & MDIO_PMA_EXTABLE_10GBKX4)\r\necmd->supported |= SUPPORTED_10000baseKX4_Full;\r\nif (reg & MDIO_PMA_EXTABLE_10GBKR)\r\necmd->supported |= SUPPORTED_10000baseKR_Full;\r\nif (reg & MDIO_PMA_EXTABLE_1000BKX)\r\necmd->supported |= SUPPORTED_1000baseKX_Full;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBR_FECABLE);\r\nif (reg & MDIO_PMA_10GBR_FECABLE_ABLE)\r\necmd->supported |= SUPPORTED_10000baseR_FEC;\r\necmd->advertising = ADVERTISED_Backplane;\r\nbreak;\r\ndefault:\r\necmd->port = PORT_FIBRE;\r\necmd->supported = SUPPORTED_FIBRE;\r\necmd->advertising = ADVERTISED_FIBRE;\r\nbreak;\r\n}\r\nif (mdio->mmds & MDIO_DEVS_AN) {\r\necmd->supported |= SUPPORTED_Autoneg;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN,\r\nMDIO_CTRL1);\r\nif (reg & MDIO_AN_CTRL1_ENABLE) {\r\necmd->autoneg = AUTONEG_ENABLE;\r\necmd->advertising |=\r\nADVERTISED_Autoneg |\r\nmdio45_get_an(mdio, MDIO_AN_ADVERTISE) |\r\nnpage_adv;\r\n} else {\r\necmd->autoneg = AUTONEG_DISABLE;\r\n}\r\n} else {\r\necmd->autoneg = AUTONEG_DISABLE;\r\n}\r\nif (ecmd->autoneg) {\r\nu32 modes = 0;\r\nint an_stat = mdio->mdio_read(mdio->dev, mdio->prtad,\r\nMDIO_MMD_AN, MDIO_STAT1);\r\nif (an_stat & MDIO_AN_STAT1_COMPLETE) {\r\necmd->lp_advertising =\r\nmdio45_get_an(mdio, MDIO_AN_LPA) | npage_lpa;\r\nif (an_stat & MDIO_AN_STAT1_LPABLE)\r\necmd->lp_advertising |= ADVERTISED_Autoneg;\r\nmodes = ecmd->advertising & ecmd->lp_advertising;\r\n}\r\nif ((modes & ~ADVERTISED_Autoneg) == 0)\r\nmodes = ecmd->advertising;\r\nif (modes & (ADVERTISED_10000baseT_Full |\r\nADVERTISED_10000baseKX4_Full |\r\nADVERTISED_10000baseKR_Full)) {\r\nspeed = SPEED_10000;\r\necmd->duplex = DUPLEX_FULL;\r\n} else if (modes & (ADVERTISED_1000baseT_Full |\r\nADVERTISED_1000baseT_Half |\r\nADVERTISED_1000baseKX_Full)) {\r\nspeed = SPEED_1000;\r\necmd->duplex = !(modes & ADVERTISED_1000baseT_Half);\r\n} else if (modes & (ADVERTISED_100baseT_Full |\r\nADVERTISED_100baseT_Half)) {\r\nspeed = SPEED_100;\r\necmd->duplex = !!(modes & ADVERTISED_100baseT_Full);\r\n} else {\r\nspeed = SPEED_10;\r\necmd->duplex = !!(modes & ADVERTISED_10baseT_Full);\r\n}\r\n} else {\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_CTRL1);\r\nspeed = (((reg & MDIO_PMA_CTRL1_SPEED1000) ? 100 : 1)\r\n* ((reg & MDIO_PMA_CTRL1_SPEED100) ? 100 : 10));\r\necmd->duplex = (reg & MDIO_CTRL1_FULLDPLX ||\r\nspeed == SPEED_10000);\r\n}\r\nethtool_cmd_speed_set(ecmd, speed);\r\nif (ecmd->port == PORT_TP\r\n&& (ethtool_cmd_speed(ecmd) == SPEED_10000)) {\r\nswitch (mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBT_SWAPPOL)) {\r\ncase MDIO_PMA_10GBT_SWAPPOL_ABNX | MDIO_PMA_10GBT_SWAPPOL_CDNX:\r\necmd->eth_tp_mdix = ETH_TP_MDI;\r\nbreak;\r\ncase 0:\r\necmd->eth_tp_mdix = ETH_TP_MDI_X;\r\nbreak;\r\ndefault:\r\necmd->eth_tp_mdix = ETH_TP_MDI_INVALID;\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid mdio45_ethtool_ksettings_get_npage(const struct mdio_if_info *mdio,\r\nstruct ethtool_link_ksettings *cmd,\r\nu32 npage_adv, u32 npage_lpa)\r\n{\r\nint reg;\r\nu32 speed, supported = 0, advertising = 0, lp_advertising = 0;\r\nBUILD_BUG_ON(MDIO_SUPPORTS_C22 != ETH_MDIO_SUPPORTS_C22);\r\nBUILD_BUG_ON(MDIO_SUPPORTS_C45 != ETH_MDIO_SUPPORTS_C45);\r\ncmd->base.phy_address = mdio->prtad;\r\ncmd->base.mdio_support =\r\nmdio->mode_support & (MDIO_SUPPORTS_C45 | MDIO_SUPPORTS_C22);\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_CTRL2);\r\nswitch (reg & MDIO_PMA_CTRL2_TYPE) {\r\ncase MDIO_PMA_CTRL2_10GBT:\r\ncase MDIO_PMA_CTRL2_1000BT:\r\ncase MDIO_PMA_CTRL2_100BTX:\r\ncase MDIO_PMA_CTRL2_10BT:\r\ncmd->base.port = PORT_TP;\r\nsupported = SUPPORTED_TP;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_SPEED);\r\nif (reg & MDIO_SPEED_10G)\r\nsupported |= SUPPORTED_10000baseT_Full;\r\nif (reg & MDIO_PMA_SPEED_1000)\r\nsupported |= (SUPPORTED_1000baseT_Full |\r\nSUPPORTED_1000baseT_Half);\r\nif (reg & MDIO_PMA_SPEED_100)\r\nsupported |= (SUPPORTED_100baseT_Full |\r\nSUPPORTED_100baseT_Half);\r\nif (reg & MDIO_PMA_SPEED_10)\r\nsupported |= (SUPPORTED_10baseT_Full |\r\nSUPPORTED_10baseT_Half);\r\nadvertising = ADVERTISED_TP;\r\nbreak;\r\ncase MDIO_PMA_CTRL2_10GBCX4:\r\ncmd->base.port = PORT_OTHER;\r\nsupported = 0;\r\nadvertising = 0;\r\nbreak;\r\ncase MDIO_PMA_CTRL2_10GBKX4:\r\ncase MDIO_PMA_CTRL2_10GBKR:\r\ncase MDIO_PMA_CTRL2_1000BKX:\r\ncmd->base.port = PORT_OTHER;\r\nsupported = SUPPORTED_Backplane;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_EXTABLE);\r\nif (reg & MDIO_PMA_EXTABLE_10GBKX4)\r\nsupported |= SUPPORTED_10000baseKX4_Full;\r\nif (reg & MDIO_PMA_EXTABLE_10GBKR)\r\nsupported |= SUPPORTED_10000baseKR_Full;\r\nif (reg & MDIO_PMA_EXTABLE_1000BKX)\r\nsupported |= SUPPORTED_1000baseKX_Full;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBR_FECABLE);\r\nif (reg & MDIO_PMA_10GBR_FECABLE_ABLE)\r\nsupported |= SUPPORTED_10000baseR_FEC;\r\nadvertising = ADVERTISED_Backplane;\r\nbreak;\r\ndefault:\r\ncmd->base.port = PORT_FIBRE;\r\nsupported = SUPPORTED_FIBRE;\r\nadvertising = ADVERTISED_FIBRE;\r\nbreak;\r\n}\r\nif (mdio->mmds & MDIO_DEVS_AN) {\r\nsupported |= SUPPORTED_Autoneg;\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN,\r\nMDIO_CTRL1);\r\nif (reg & MDIO_AN_CTRL1_ENABLE) {\r\ncmd->base.autoneg = AUTONEG_ENABLE;\r\nadvertising |=\r\nADVERTISED_Autoneg |\r\nmdio45_get_an(mdio, MDIO_AN_ADVERTISE) |\r\nnpage_adv;\r\n} else {\r\ncmd->base.autoneg = AUTONEG_DISABLE;\r\n}\r\n} else {\r\ncmd->base.autoneg = AUTONEG_DISABLE;\r\n}\r\nif (cmd->base.autoneg) {\r\nu32 modes = 0;\r\nint an_stat = mdio->mdio_read(mdio->dev, mdio->prtad,\r\nMDIO_MMD_AN, MDIO_STAT1);\r\nif (an_stat & MDIO_AN_STAT1_COMPLETE) {\r\nlp_advertising =\r\nmdio45_get_an(mdio, MDIO_AN_LPA) | npage_lpa;\r\nif (an_stat & MDIO_AN_STAT1_LPABLE)\r\nlp_advertising |= ADVERTISED_Autoneg;\r\nmodes = advertising & lp_advertising;\r\n}\r\nif ((modes & ~ADVERTISED_Autoneg) == 0)\r\nmodes = advertising;\r\nif (modes & (ADVERTISED_10000baseT_Full |\r\nADVERTISED_10000baseKX4_Full |\r\nADVERTISED_10000baseKR_Full)) {\r\nspeed = SPEED_10000;\r\ncmd->base.duplex = DUPLEX_FULL;\r\n} else if (modes & (ADVERTISED_1000baseT_Full |\r\nADVERTISED_1000baseT_Half |\r\nADVERTISED_1000baseKX_Full)) {\r\nspeed = SPEED_1000;\r\ncmd->base.duplex = !(modes & ADVERTISED_1000baseT_Half);\r\n} else if (modes & (ADVERTISED_100baseT_Full |\r\nADVERTISED_100baseT_Half)) {\r\nspeed = SPEED_100;\r\ncmd->base.duplex = !!(modes & ADVERTISED_100baseT_Full);\r\n} else {\r\nspeed = SPEED_10;\r\ncmd->base.duplex = !!(modes & ADVERTISED_10baseT_Full);\r\n}\r\n} else {\r\nreg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_CTRL1);\r\nspeed = (((reg & MDIO_PMA_CTRL1_SPEED1000) ? 100 : 1)\r\n* ((reg & MDIO_PMA_CTRL1_SPEED100) ? 100 : 10));\r\ncmd->base.duplex = (reg & MDIO_CTRL1_FULLDPLX ||\r\nspeed == SPEED_10000);\r\n}\r\ncmd->base.speed = speed;\r\nethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.supported,\r\nsupported);\r\nethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.advertising,\r\nadvertising);\r\nethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.lp_advertising,\r\nlp_advertising);\r\nif (cmd->base.port == PORT_TP && (cmd->base.speed == SPEED_10000)) {\r\nswitch (mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBT_SWAPPOL)) {\r\ncase MDIO_PMA_10GBT_SWAPPOL_ABNX | MDIO_PMA_10GBT_SWAPPOL_CDNX:\r\ncmd->base.eth_tp_mdix = ETH_TP_MDI;\r\nbreak;\r\ncase 0:\r\ncmd->base.eth_tp_mdix = ETH_TP_MDI_X;\r\nbreak;\r\ndefault:\r\ncmd->base.eth_tp_mdix = ETH_TP_MDI_INVALID;\r\nbreak;\r\n}\r\n}\r\n}\r\nint mdio_mii_ioctl(const struct mdio_if_info *mdio,\r\nstruct mii_ioctl_data *mii_data, int cmd)\r\n{\r\nint prtad, devad;\r\nu16 addr = mii_data->reg_num;\r\nswitch (cmd) {\r\ncase SIOCGMIIPHY:\r\nif (mdio->prtad == MDIO_PRTAD_NONE)\r\nreturn -EOPNOTSUPP;\r\nmii_data->phy_id = mdio->prtad;\r\ncmd = SIOCGMIIREG;\r\nbreak;\r\ncase SIOCGMIIREG:\r\ncase SIOCSMIIREG:\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nif ((mdio->mode_support & MDIO_SUPPORTS_C45) &&\r\nmdio_phy_id_is_c45(mii_data->phy_id)) {\r\nprtad = mdio_phy_id_prtad(mii_data->phy_id);\r\ndevad = mdio_phy_id_devad(mii_data->phy_id);\r\n} else if ((mdio->mode_support & MDIO_SUPPORTS_C22) &&\r\nmii_data->phy_id < 0x20) {\r\nprtad = mii_data->phy_id;\r\ndevad = MDIO_DEVAD_NONE;\r\naddr &= 0x1f;\r\n} else if ((mdio->mode_support & MDIO_EMULATE_C22) &&\r\nmdio->prtad != MDIO_PRTAD_NONE &&\r\nmii_data->phy_id == mdio->prtad) {\r\nprtad = mdio->prtad;\r\nswitch (addr) {\r\ncase MII_BMCR:\r\ncase MII_BMSR:\r\ncase MII_PHYSID1:\r\ncase MII_PHYSID2:\r\ndevad = __ffs(mdio->mmds);\r\nbreak;\r\ncase MII_ADVERTISE:\r\ncase MII_LPA:\r\nif (!(mdio->mmds & MDIO_DEVS_AN))\r\nreturn -EINVAL;\r\ndevad = MDIO_MMD_AN;\r\nif (addr == MII_ADVERTISE)\r\naddr = MDIO_AN_ADVERTISE;\r\nelse\r\naddr = MDIO_AN_LPA;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nif (cmd == SIOCGMIIREG) {\r\nint rc = mdio->mdio_read(mdio->dev, prtad, devad, addr);\r\nif (rc < 0)\r\nreturn rc;\r\nmii_data->val_out = rc;\r\nreturn 0;\r\n} else {\r\nreturn mdio->mdio_write(mdio->dev, prtad, devad, addr,\r\nmii_data->val_in);\r\n}\r\n}

static void\r\nmlxsw_sib_tx_v1_hdr_construct(struct sk_buff *skb,\r\nconst struct mlxsw_tx_info *tx_info)\r\n{\r\nchar *txhdr = skb_push(skb, MLXSW_TXHDR_LEN);\r\nmemset(txhdr, 0, MLXSW_TXHDR_LEN);\r\nmlxsw_tx_v1_hdr_version_set(txhdr, MLXSW_TXHDR_VERSION_1);\r\nmlxsw_tx_v1_hdr_ctl_set(txhdr, MLXSW_TXHDR_ETH_CTL);\r\nmlxsw_tx_v1_hdr_proto_set(txhdr, MLXSW_TXHDR_PROTO_ETH);\r\nmlxsw_tx_v1_hdr_swid_set(txhdr, 0);\r\nmlxsw_tx_v1_hdr_control_tclass_set(txhdr, 1);\r\nmlxsw_tx_v1_hdr_port_mid_set(txhdr, tx_info->local_port);\r\nmlxsw_tx_v1_hdr_type_set(txhdr, MLXSW_TXHDR_TYPE_CONTROL);\r\n}\r\nstatic int\r\nmlxsw_sib_port_admin_status_set(struct mlxsw_sib_port *mlxsw_sib_port,\r\nbool is_up)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_sib_port->mlxsw_sib;\r\nchar paos_pl[MLXSW_REG_PAOS_LEN];\r\nmlxsw_reg_paos_pack(paos_pl, mlxsw_sib_port->local_port,\r\nis_up ? MLXSW_PORT_ADMIN_STATUS_UP :\r\nMLXSW_PORT_ADMIN_STATUS_DOWN);\r\nreturn mlxsw_reg_write(mlxsw_sib->core, MLXSW_REG(paos), paos_pl);\r\n}\r\nstatic int mlxsw_sib_port_mtu_set(struct mlxsw_sib_port *mlxsw_sib_port,\r\nu16 mtu)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_sib_port->mlxsw_sib;\r\nchar pmtu_pl[MLXSW_REG_PMTU_LEN];\r\nint max_mtu;\r\nint err;\r\nmlxsw_reg_pmtu_pack(pmtu_pl, mlxsw_sib_port->local_port, 0);\r\nerr = mlxsw_reg_query(mlxsw_sib->core, MLXSW_REG(pmtu), pmtu_pl);\r\nif (err)\r\nreturn err;\r\nmax_mtu = mlxsw_reg_pmtu_max_mtu_get(pmtu_pl);\r\nif (mtu > max_mtu)\r\nreturn -EINVAL;\r\nmlxsw_reg_pmtu_pack(pmtu_pl, mlxsw_sib_port->local_port, mtu);\r\nreturn mlxsw_reg_write(mlxsw_sib->core, MLXSW_REG(pmtu), pmtu_pl);\r\n}\r\nstatic int mlxsw_sib_port_set(struct mlxsw_sib_port *mlxsw_sib_port, u8 port)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_sib_port->mlxsw_sib;\r\nchar plib_pl[MLXSW_REG_PLIB_LEN] = {0};\r\nint err;\r\nmlxsw_reg_plib_local_port_set(plib_pl, mlxsw_sib_port->local_port);\r\nmlxsw_reg_plib_ib_port_set(plib_pl, port);\r\nerr = mlxsw_reg_write(mlxsw_sib->core, MLXSW_REG(plib), plib_pl);\r\nreturn err;\r\n}\r\nstatic int mlxsw_sib_port_swid_set(struct mlxsw_sib_port *mlxsw_sib_port,\r\nu8 swid)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_sib_port->mlxsw_sib;\r\nchar pspa_pl[MLXSW_REG_PSPA_LEN];\r\nmlxsw_reg_pspa_pack(pspa_pl, swid, mlxsw_sib_port->local_port);\r\nreturn mlxsw_reg_write(mlxsw_sib->core, MLXSW_REG(pspa), pspa_pl);\r\n}\r\nstatic int mlxsw_sib_port_module_info_get(struct mlxsw_sib *mlxsw_sib,\r\nu8 local_port, u8 *p_module,\r\nu8 *p_width)\r\n{\r\nchar pmlp_pl[MLXSW_REG_PMLP_LEN];\r\nint err;\r\nmlxsw_reg_pmlp_pack(pmlp_pl, local_port);\r\nerr = mlxsw_reg_query(mlxsw_sib->core, MLXSW_REG(pmlp), pmlp_pl);\r\nif (err)\r\nreturn err;\r\n*p_module = mlxsw_reg_pmlp_module_get(pmlp_pl, 0);\r\n*p_width = mlxsw_reg_pmlp_width_get(pmlp_pl);\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sib_port_speed_set(struct mlxsw_sib_port *mlxsw_sib_port,\r\nu16 speed, u16 width)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_sib_port->mlxsw_sib;\r\nchar ptys_pl[MLXSW_REG_PTYS_LEN];\r\nmlxsw_reg_ptys_ib_pack(ptys_pl, mlxsw_sib_port->local_port, speed,\r\nwidth);\r\nreturn mlxsw_reg_write(mlxsw_sib->core, MLXSW_REG(ptys), ptys_pl);\r\n}\r\nstatic bool mlxsw_sib_port_created(struct mlxsw_sib *mlxsw_sib, u8 local_port)\r\n{\r\nreturn mlxsw_sib->ports[local_port] != NULL;\r\n}\r\nstatic int __mlxsw_sib_port_create(struct mlxsw_sib *mlxsw_sib, u8 local_port,\r\nu8 module, u8 width)\r\n{\r\nstruct mlxsw_sib_port *mlxsw_sib_port;\r\nint err;\r\nmlxsw_sib_port = kzalloc(sizeof(*mlxsw_sib_port), GFP_KERNEL);\r\nif (!mlxsw_sib_port)\r\nreturn -ENOMEM;\r\nmlxsw_sib_port->mlxsw_sib = mlxsw_sib;\r\nmlxsw_sib_port->local_port = local_port;\r\nmlxsw_sib_port->mapping.module = module;\r\nerr = mlxsw_sib_port_swid_set(mlxsw_sib_port, 0);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to set SWID\n",\r\nmlxsw_sib_port->local_port);\r\ngoto err_port_swid_set;\r\n}\r\nerr = mlxsw_sib_port_set(mlxsw_sib_port, module + 1);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to set IB port\n",\r\nmlxsw_sib_port->local_port);\r\ngoto err_port_ib_set;\r\n}\r\nerr = mlxsw_sib_port_speed_set(mlxsw_sib_port,\r\nMLXSW_REG_PTYS_IB_SPEED_EDR - 1,\r\nBIT(3) - 1);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to set speed\n",\r\nmlxsw_sib_port->local_port);\r\ngoto err_port_speed_set;\r\n}\r\nerr = mlxsw_sib_port_mtu_set(mlxsw_sib_port, MLXSW_IB_DEFAULT_MTU);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to set MTU\n",\r\nmlxsw_sib_port->local_port);\r\ngoto err_port_mtu_set;\r\n}\r\nerr = mlxsw_sib_port_admin_status_set(mlxsw_sib_port, true);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to change admin state to UP\n",\r\nmlxsw_sib_port->local_port);\r\ngoto err_port_admin_set;\r\n}\r\nmlxsw_core_port_ib_set(mlxsw_sib->core, mlxsw_sib_port->local_port,\r\nmlxsw_sib_port);\r\nmlxsw_sib->ports[local_port] = mlxsw_sib_port;\r\nreturn 0;\r\nerr_port_admin_set:\r\nerr_port_mtu_set:\r\nerr_port_speed_set:\r\nerr_port_ib_set:\r\nmlxsw_sib_port_swid_set(mlxsw_sib_port, MLXSW_PORT_SWID_DISABLED_PORT);\r\nerr_port_swid_set:\r\nkfree(mlxsw_sib_port);\r\nreturn err;\r\n}\r\nstatic int mlxsw_sib_port_create(struct mlxsw_sib *mlxsw_sib, u8 local_port,\r\nu8 module, u8 width)\r\n{\r\nint err;\r\nerr = mlxsw_core_port_init(mlxsw_sib->core, local_port);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Port %d: Failed to init core port\n",\r\nlocal_port);\r\nreturn err;\r\n}\r\nerr = __mlxsw_sib_port_create(mlxsw_sib, local_port, module, width);\r\nif (err)\r\ngoto err_port_create;\r\nreturn 0;\r\nerr_port_create:\r\nmlxsw_core_port_fini(mlxsw_sib->core, local_port);\r\nreturn err;\r\n}\r\nstatic void __mlxsw_sib_port_remove(struct mlxsw_sib *mlxsw_sib, u8 local_port)\r\n{\r\nstruct mlxsw_sib_port *mlxsw_sib_port = mlxsw_sib->ports[local_port];\r\nmlxsw_core_port_clear(mlxsw_sib->core, local_port, mlxsw_sib);\r\nmlxsw_sib->ports[local_port] = NULL;\r\nmlxsw_sib_port_admin_status_set(mlxsw_sib_port, false);\r\nmlxsw_sib_port_swid_set(mlxsw_sib_port, MLXSW_PORT_SWID_DISABLED_PORT);\r\nkfree(mlxsw_sib_port);\r\n}\r\nstatic void mlxsw_sib_port_remove(struct mlxsw_sib *mlxsw_sib, u8 local_port)\r\n{\r\n__mlxsw_sib_port_remove(mlxsw_sib, local_port);\r\nmlxsw_core_port_fini(mlxsw_sib->core, local_port);\r\n}\r\nstatic void mlxsw_sib_ports_remove(struct mlxsw_sib *mlxsw_sib)\r\n{\r\nint i;\r\nfor (i = 1; i < MLXSW_PORT_MAX_IB_PORTS; i++)\r\nif (mlxsw_sib_port_created(mlxsw_sib, i))\r\nmlxsw_sib_port_remove(mlxsw_sib, i);\r\nkfree(mlxsw_sib->ports);\r\n}\r\nstatic int mlxsw_sib_ports_create(struct mlxsw_sib *mlxsw_sib)\r\n{\r\nsize_t alloc_size;\r\nu8 module, width;\r\nint i;\r\nint err;\r\nalloc_size = sizeof(struct mlxsw_sib_port *) * MLXSW_PORT_MAX_IB_PORTS;\r\nmlxsw_sib->ports = kzalloc(alloc_size, GFP_KERNEL);\r\nif (!mlxsw_sib->ports)\r\nreturn -ENOMEM;\r\nfor (i = 1; i < MLXSW_PORT_MAX_IB_PORTS; i++) {\r\nerr = mlxsw_sib_port_module_info_get(mlxsw_sib, i, &module,\r\n&width);\r\nif (err)\r\ngoto err_port_module_info_get;\r\nif (!width)\r\ncontinue;\r\nerr = mlxsw_sib_port_create(mlxsw_sib, i, module, width);\r\nif (err)\r\ngoto err_port_create;\r\n}\r\nreturn 0;\r\nerr_port_create:\r\nerr_port_module_info_get:\r\nfor (i--; i >= 1; i--)\r\nif (mlxsw_sib_port_created(mlxsw_sib, i))\r\nmlxsw_sib_port_remove(mlxsw_sib, i);\r\nkfree(mlxsw_sib->ports);\r\nreturn err;\r\n}\r\nstatic void\r\nmlxsw_sib_pude_ib_event_func(struct mlxsw_sib_port *mlxsw_sib_port,\r\nenum mlxsw_reg_pude_oper_status status)\r\n{\r\nif (status == MLXSW_PORT_OPER_STATUS_UP)\r\npr_info("ib link for port %d - up\n",\r\nmlxsw_sib_port->mapping.module + 1);\r\nelse\r\npr_info("ib link for port %d - down\n",\r\nmlxsw_sib_port->mapping.module + 1);\r\n}\r\nstatic void mlxsw_sib_pude_event_func(const struct mlxsw_reg_info *reg,\r\nchar *pude_pl, void *priv)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = priv;\r\nstruct mlxsw_sib_port *mlxsw_sib_port;\r\nenum mlxsw_reg_pude_oper_status status;\r\nu8 local_port;\r\nlocal_port = mlxsw_reg_pude_local_port_get(pude_pl);\r\nmlxsw_sib_port = mlxsw_sib->ports[local_port];\r\nif (!mlxsw_sib_port) {\r\ndev_warn(mlxsw_sib->bus_info->dev, "Port %d: Link event received for non-existent port\n",\r\nlocal_port);\r\nreturn;\r\n}\r\nstatus = mlxsw_reg_pude_oper_status_get(pude_pl);\r\nmlxsw_sib_pude_ib_event_func(mlxsw_sib_port, status);\r\n}\r\nstatic int mlxsw_sib_taps_init(struct mlxsw_sib *mlxsw_sib)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(mlxsw_sib_listener); i++) {\r\nerr = mlxsw_core_trap_register(mlxsw_sib->core,\r\n&mlxsw_sib_listener[i],\r\nmlxsw_sib);\r\nif (err)\r\ngoto err_rx_listener_register;\r\n}\r\nreturn 0;\r\nerr_rx_listener_register:\r\nfor (i--; i >= 0; i--) {\r\nmlxsw_core_trap_unregister(mlxsw_sib->core,\r\n&mlxsw_sib_listener[i],\r\nmlxsw_sib);\r\n}\r\nreturn err;\r\n}\r\nstatic void mlxsw_sib_traps_fini(struct mlxsw_sib *mlxsw_sib)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mlxsw_sib_listener); i++) {\r\nmlxsw_core_trap_unregister(mlxsw_sib->core,\r\n&mlxsw_sib_listener[i], mlxsw_sib);\r\n}\r\n}\r\nstatic int mlxsw_sib_basic_trap_groups_set(struct mlxsw_core *mlxsw_core)\r\n{\r\nchar htgt_pl[MLXSW_REG_HTGT_LEN];\r\nmlxsw_reg_htgt_pack(htgt_pl, MLXSW_REG_HTGT_TRAP_GROUP_EMAD,\r\nMLXSW_REG_HTGT_INVALID_POLICER,\r\nMLXSW_REG_HTGT_DEFAULT_PRIORITY,\r\nMLXSW_REG_HTGT_DEFAULT_TC);\r\nmlxsw_reg_htgt_swid_set(htgt_pl, MLXSW_PORT_SWID_ALL_SWIDS);\r\nmlxsw_reg_htgt_local_path_rdq_set(htgt_pl,\r\nMLXSW_REG_HTGT_LOCAL_PATH_RDQ_SIB_EMAD);\r\nreturn mlxsw_reg_write(mlxsw_core, MLXSW_REG(htgt), htgt_pl);\r\n}\r\nstatic int mlxsw_sib_init(struct mlxsw_core *mlxsw_core,\r\nconst struct mlxsw_bus_info *mlxsw_bus_info)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_core_driver_priv(mlxsw_core);\r\nint err;\r\nmlxsw_sib->core = mlxsw_core;\r\nmlxsw_sib->bus_info = mlxsw_bus_info;\r\nerr = mlxsw_sib_ports_create(mlxsw_sib);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Failed to create ports\n");\r\nreturn err;\r\n}\r\nerr = mlxsw_sib_taps_init(mlxsw_sib);\r\nif (err) {\r\ndev_err(mlxsw_sib->bus_info->dev, "Failed to set traps\n");\r\ngoto err_traps_init_err;\r\n}\r\nreturn 0;\r\nerr_traps_init_err:\r\nmlxsw_sib_ports_remove(mlxsw_sib);\r\nreturn err;\r\n}\r\nstatic void mlxsw_sib_fini(struct mlxsw_core *mlxsw_core)\r\n{\r\nstruct mlxsw_sib *mlxsw_sib = mlxsw_core_driver_priv(mlxsw_core);\r\nmlxsw_sib_traps_fini(mlxsw_sib);\r\nmlxsw_sib_ports_remove(mlxsw_sib);\r\n}\r\nstatic int __init mlxsw_sib_module_init(void)\r\n{\r\nint err;\r\nerr = mlxsw_core_driver_register(&mlxsw_sib_driver);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_core_driver_register(&mlxsw_sib2_driver);\r\nif (err)\r\ngoto err_sib2_driver_register;\r\nerr = mlxsw_pci_driver_register(&mlxsw_sib_pci_driver);\r\nif (err)\r\ngoto err_sib_pci_driver_register;\r\nerr = mlxsw_pci_driver_register(&mlxsw_sib2_pci_driver);\r\nif (err)\r\ngoto err_sib2_pci_driver_register;\r\nreturn 0;\r\nerr_sib2_pci_driver_register:\r\nmlxsw_pci_driver_unregister(&mlxsw_sib_pci_driver);\r\nerr_sib_pci_driver_register:\r\nmlxsw_core_driver_unregister(&mlxsw_sib2_driver);\r\nerr_sib2_driver_register:\r\nmlxsw_core_driver_unregister(&mlxsw_sib_driver);\r\nreturn err;\r\n}\r\nstatic void __exit mlxsw_sib_module_exit(void)\r\n{\r\nmlxsw_pci_driver_unregister(&mlxsw_sib2_pci_driver);\r\nmlxsw_pci_driver_unregister(&mlxsw_sib_pci_driver);\r\nmlxsw_core_driver_unregister(&mlxsw_sib2_driver);\r\nmlxsw_core_driver_unregister(&mlxsw_sib_driver);\r\n}

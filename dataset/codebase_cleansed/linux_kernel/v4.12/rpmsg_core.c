struct rpmsg_endpoint *rpmsg_create_ept(struct rpmsg_device *rpdev,\r\nrpmsg_rx_cb_t cb, void *priv,\r\nstruct rpmsg_channel_info chinfo)\r\n{\r\nif (WARN_ON(!rpdev))\r\nreturn NULL;\r\nreturn rpdev->ops->create_ept(rpdev, cb, priv, chinfo);\r\n}\r\nvoid rpmsg_destroy_ept(struct rpmsg_endpoint *ept)\r\n{\r\nif (ept)\r\nept->ops->destroy_ept(ept);\r\n}\r\nint rpmsg_send(struct rpmsg_endpoint *ept, void *data, int len)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->send)\r\nreturn -ENXIO;\r\nreturn ept->ops->send(ept, data, len);\r\n}\r\nint rpmsg_sendto(struct rpmsg_endpoint *ept, void *data, int len, u32 dst)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->sendto)\r\nreturn -ENXIO;\r\nreturn ept->ops->sendto(ept, data, len, dst);\r\n}\r\nint rpmsg_send_offchannel(struct rpmsg_endpoint *ept, u32 src, u32 dst,\r\nvoid *data, int len)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->send_offchannel)\r\nreturn -ENXIO;\r\nreturn ept->ops->send_offchannel(ept, src, dst, data, len);\r\n}\r\nint rpmsg_trysend(struct rpmsg_endpoint *ept, void *data, int len)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->trysend)\r\nreturn -ENXIO;\r\nreturn ept->ops->trysend(ept, data, len);\r\n}\r\nint rpmsg_trysendto(struct rpmsg_endpoint *ept, void *data, int len, u32 dst)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->trysendto)\r\nreturn -ENXIO;\r\nreturn ept->ops->trysendto(ept, data, len, dst);\r\n}\r\nunsigned int rpmsg_poll(struct rpmsg_endpoint *ept, struct file *filp,\r\npoll_table *wait)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn 0;\r\nif (!ept->ops->poll)\r\nreturn 0;\r\nreturn ept->ops->poll(ept, filp, wait);\r\n}\r\nint rpmsg_trysend_offchannel(struct rpmsg_endpoint *ept, u32 src, u32 dst,\r\nvoid *data, int len)\r\n{\r\nif (WARN_ON(!ept))\r\nreturn -EINVAL;\r\nif (!ept->ops->trysend_offchannel)\r\nreturn -ENXIO;\r\nreturn ept->ops->trysend_offchannel(ept, src, dst, data, len);\r\n}\r\nstatic int rpmsg_device_match(struct device *dev, void *data)\r\n{\r\nstruct rpmsg_channel_info *chinfo = data;\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nif (chinfo->src != RPMSG_ADDR_ANY && chinfo->src != rpdev->src)\r\nreturn 0;\r\nif (chinfo->dst != RPMSG_ADDR_ANY && chinfo->dst != rpdev->dst)\r\nreturn 0;\r\nif (strncmp(chinfo->name, rpdev->id.name, RPMSG_NAME_SIZE))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstruct device *rpmsg_find_device(struct device *parent,\r\nstruct rpmsg_channel_info *chinfo)\r\n{\r\nreturn device_find_child(parent, chinfo, rpmsg_device_match);\r\n}\r\nstatic ssize_t modalias_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nreturn sprintf(buf, RPMSG_DEVICE_MODALIAS_FMT "\n", rpdev->id.name);\r\n}\r\nstatic inline int rpmsg_id_match(const struct rpmsg_device *rpdev,\r\nconst struct rpmsg_device_id *id)\r\n{\r\nreturn strncmp(id->name, rpdev->id.name, RPMSG_NAME_SIZE) == 0;\r\n}\r\nstatic int rpmsg_dev_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nstruct rpmsg_driver *rpdrv = to_rpmsg_driver(drv);\r\nconst struct rpmsg_device_id *ids = rpdrv->id_table;\r\nunsigned int i;\r\nif (rpdev->driver_override)\r\nreturn !strcmp(rpdev->driver_override, drv->name);\r\nif (ids)\r\nfor (i = 0; ids[i].name[0]; i++)\r\nif (rpmsg_id_match(rpdev, &ids[i]))\r\nreturn 1;\r\nreturn of_driver_match_device(dev, drv);\r\n}\r\nstatic int rpmsg_uevent(struct device *dev, struct kobj_uevent_env *env)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nreturn add_uevent_var(env, "MODALIAS=" RPMSG_DEVICE_MODALIAS_FMT,\r\nrpdev->id.name);\r\n}\r\nstatic int rpmsg_dev_probe(struct device *dev)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpdev->dev.driver);\r\nstruct rpmsg_channel_info chinfo = {};\r\nstruct rpmsg_endpoint *ept = NULL;\r\nint err;\r\nif (rpdrv->callback) {\r\nstrncpy(chinfo.name, rpdev->id.name, RPMSG_NAME_SIZE);\r\nchinfo.src = rpdev->src;\r\nchinfo.dst = RPMSG_ADDR_ANY;\r\nept = rpmsg_create_ept(rpdev, rpdrv->callback, NULL, chinfo);\r\nif (!ept) {\r\ndev_err(dev, "failed to create endpoint\n");\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nrpdev->ept = ept;\r\nrpdev->src = ept->addr;\r\n}\r\nerr = rpdrv->probe(rpdev);\r\nif (err) {\r\ndev_err(dev, "%s: failed: %d\n", __func__, err);\r\nif (ept)\r\nrpmsg_destroy_ept(ept);\r\ngoto out;\r\n}\r\nif (rpdev->ops->announce_create)\r\nerr = rpdev->ops->announce_create(rpdev);\r\nout:\r\nreturn err;\r\n}\r\nstatic int rpmsg_dev_remove(struct device *dev)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpdev->dev.driver);\r\nint err = 0;\r\nif (rpdev->ops->announce_destroy)\r\nerr = rpdev->ops->announce_destroy(rpdev);\r\nrpdrv->remove(rpdev);\r\nif (rpdev->ept)\r\nrpmsg_destroy_ept(rpdev->ept);\r\nreturn err;\r\n}\r\nstatic void rpmsg_release_device(struct device *dev)\r\n{\r\nstruct rpmsg_device *rpdev = to_rpmsg_device(dev);\r\nkfree(rpdev);\r\n}\r\nint rpmsg_register_device(struct rpmsg_device *rpdev)\r\n{\r\nstruct device *dev = &rpdev->dev;\r\nint ret;\r\ndev_set_name(&rpdev->dev, "%s.%s.%d.%d", dev_name(dev->parent),\r\nrpdev->id.name, rpdev->src, rpdev->dst);\r\nrpdev->dev.bus = &rpmsg_bus;\r\nrpdev->dev.release = rpmsg_release_device;\r\nret = device_register(&rpdev->dev);\r\nif (ret) {\r\ndev_err(dev, "device_register failed: %d\n", ret);\r\nput_device(&rpdev->dev);\r\n}\r\nreturn ret;\r\n}\r\nint rpmsg_unregister_device(struct device *parent,\r\nstruct rpmsg_channel_info *chinfo)\r\n{\r\nstruct device *dev;\r\ndev = rpmsg_find_device(parent, chinfo);\r\nif (!dev)\r\nreturn -EINVAL;\r\ndevice_unregister(dev);\r\nput_device(dev);\r\nreturn 0;\r\n}\r\nint __register_rpmsg_driver(struct rpmsg_driver *rpdrv, struct module *owner)\r\n{\r\nrpdrv->drv.bus = &rpmsg_bus;\r\nrpdrv->drv.owner = owner;\r\nreturn driver_register(&rpdrv->drv);\r\n}\r\nvoid unregister_rpmsg_driver(struct rpmsg_driver *rpdrv)\r\n{\r\ndriver_unregister(&rpdrv->drv);\r\n}\r\nstatic int __init rpmsg_init(void)\r\n{\r\nint ret;\r\nret = bus_register(&rpmsg_bus);\r\nif (ret)\r\npr_err("failed to register rpmsg bus: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit rpmsg_fini(void)\r\n{\r\nbus_unregister(&rpmsg_bus);\r\n}

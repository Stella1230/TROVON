static int jffs2_is_best_compression(struct jffs2_compressor *this,\r\nstruct jffs2_compressor *best, uint32_t size, uint32_t bestsize)\r\n{\r\nswitch (jffs2_compression_mode) {\r\ncase JFFS2_COMPR_MODE_SIZE:\r\nif (bestsize > size)\r\nreturn 1;\r\nreturn 0;\r\ncase JFFS2_COMPR_MODE_FAVOURLZO:\r\nif ((this->compr == JFFS2_COMPR_LZO) && (bestsize > size))\r\nreturn 1;\r\nif ((best->compr != JFFS2_COMPR_LZO) && (bestsize > size))\r\nreturn 1;\r\nif ((this->compr == JFFS2_COMPR_LZO) && (bestsize > (size * FAVOUR_LZO_PERCENT / 100)))\r\nreturn 1;\r\nif ((bestsize * FAVOUR_LZO_PERCENT / 100) > size)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int jffs2_selected_compress(u8 compr, unsigned char *data_in,\r\nunsigned char **cpage_out, u32 *datalen, u32 *cdatalen)\r\n{\r\nstruct jffs2_compressor *this;\r\nint err, ret = JFFS2_COMPR_NONE;\r\nuint32_t orig_slen, orig_dlen;\r\nchar *output_buf;\r\noutput_buf = kmalloc(*cdatalen, GFP_KERNEL);\r\nif (!output_buf) {\r\npr_warn("No memory for compressor allocation. Compression failed.\n");\r\nreturn ret;\r\n}\r\norig_slen = *datalen;\r\norig_dlen = *cdatalen;\r\nspin_lock(&jffs2_compressor_list_lock);\r\nlist_for_each_entry(this, &jffs2_compressor_list, list) {\r\nif (!this->compress || this->disabled)\r\ncontinue;\r\nif (compr && (compr != this->compr))\r\ncontinue;\r\nthis->usecount++;\r\nspin_unlock(&jffs2_compressor_list_lock);\r\n*datalen = orig_slen;\r\n*cdatalen = orig_dlen;\r\nerr = this->compress(data_in, output_buf, datalen, cdatalen);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nthis->usecount--;\r\nif (!err) {\r\nret = this->compr;\r\nthis->stat_compr_blocks++;\r\nthis->stat_compr_orig_size += *datalen;\r\nthis->stat_compr_new_size += *cdatalen;\r\nbreak;\r\n}\r\n}\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nif (ret == JFFS2_COMPR_NONE)\r\nkfree(output_buf);\r\nelse\r\n*cpage_out = output_buf;\r\nreturn ret;\r\n}\r\nuint16_t jffs2_compress(struct jffs2_sb_info *c, struct jffs2_inode_info *f,\r\nunsigned char *data_in, unsigned char **cpage_out,\r\nuint32_t *datalen, uint32_t *cdatalen)\r\n{\r\nint ret = JFFS2_COMPR_NONE;\r\nint mode, compr_ret;\r\nstruct jffs2_compressor *this, *best=NULL;\r\nunsigned char *output_buf = NULL, *tmp_buf;\r\nuint32_t orig_slen, orig_dlen;\r\nuint32_t best_slen=0, best_dlen=0;\r\nif (c->mount_opts.override_compr)\r\nmode = c->mount_opts.compr;\r\nelse\r\nmode = jffs2_compression_mode;\r\nswitch (mode) {\r\ncase JFFS2_COMPR_MODE_NONE:\r\nbreak;\r\ncase JFFS2_COMPR_MODE_PRIORITY:\r\nret = jffs2_selected_compress(0, data_in, cpage_out, datalen,\r\ncdatalen);\r\nbreak;\r\ncase JFFS2_COMPR_MODE_SIZE:\r\ncase JFFS2_COMPR_MODE_FAVOURLZO:\r\norig_slen = *datalen;\r\norig_dlen = *cdatalen;\r\nspin_lock(&jffs2_compressor_list_lock);\r\nlist_for_each_entry(this, &jffs2_compressor_list, list) {\r\nif ((!this->compress)||(this->disabled))\r\ncontinue;\r\nif ((this->compr_buf_size < orig_slen) && (this->compr_buf)) {\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nkfree(this->compr_buf);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nthis->compr_buf_size=0;\r\nthis->compr_buf=NULL;\r\n}\r\nif (!this->compr_buf) {\r\nspin_unlock(&jffs2_compressor_list_lock);\r\ntmp_buf = kmalloc(orig_slen, GFP_KERNEL);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nif (!tmp_buf) {\r\npr_warn("No memory for compressor allocation. (%d bytes)\n",\r\norig_slen);\r\ncontinue;\r\n}\r\nelse {\r\nthis->compr_buf = tmp_buf;\r\nthis->compr_buf_size = orig_slen;\r\n}\r\n}\r\nthis->usecount++;\r\nspin_unlock(&jffs2_compressor_list_lock);\r\n*datalen = orig_slen;\r\n*cdatalen = orig_dlen;\r\ncompr_ret = this->compress(data_in, this->compr_buf, datalen, cdatalen);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nthis->usecount--;\r\nif (!compr_ret) {\r\nif (((!best_dlen) || jffs2_is_best_compression(this, best, *cdatalen, best_dlen))\r\n&& (*cdatalen < *datalen)) {\r\nbest_dlen = *cdatalen;\r\nbest_slen = *datalen;\r\nbest = this;\r\n}\r\n}\r\n}\r\nif (best_dlen) {\r\n*cdatalen = best_dlen;\r\n*datalen = best_slen;\r\noutput_buf = best->compr_buf;\r\nbest->compr_buf = NULL;\r\nbest->compr_buf_size = 0;\r\nbest->stat_compr_blocks++;\r\nbest->stat_compr_orig_size += best_slen;\r\nbest->stat_compr_new_size += best_dlen;\r\nret = best->compr;\r\n*cpage_out = output_buf;\r\n}\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nbreak;\r\ncase JFFS2_COMPR_MODE_FORCELZO:\r\nret = jffs2_selected_compress(JFFS2_COMPR_LZO, data_in,\r\ncpage_out, datalen, cdatalen);\r\nbreak;\r\ncase JFFS2_COMPR_MODE_FORCEZLIB:\r\nret = jffs2_selected_compress(JFFS2_COMPR_ZLIB, data_in,\r\ncpage_out, datalen, cdatalen);\r\nbreak;\r\ndefault:\r\npr_err("unknown compression mode\n");\r\n}\r\nif (ret == JFFS2_COMPR_NONE) {\r\n*cpage_out = data_in;\r\n*datalen = *cdatalen;\r\nnone_stat_compr_blocks++;\r\nnone_stat_compr_size += *datalen;\r\n}\r\nreturn ret;\r\n}\r\nint jffs2_decompress(struct jffs2_sb_info *c, struct jffs2_inode_info *f,\r\nuint16_t comprtype, unsigned char *cdata_in,\r\nunsigned char *data_out, uint32_t cdatalen, uint32_t datalen)\r\n{\r\nstruct jffs2_compressor *this;\r\nint ret;\r\nif ((comprtype & 0xff) <= JFFS2_COMPR_ZLIB)\r\ncomprtype &= 0xff;\r\nswitch (comprtype & 0xff) {\r\ncase JFFS2_COMPR_NONE:\r\nmemcpy(data_out, cdata_in, datalen);\r\nnone_stat_decompr_blocks++;\r\nbreak;\r\ncase JFFS2_COMPR_ZERO:\r\nmemset(data_out, 0, datalen);\r\nbreak;\r\ndefault:\r\nspin_lock(&jffs2_compressor_list_lock);\r\nlist_for_each_entry(this, &jffs2_compressor_list, list) {\r\nif (comprtype == this->compr) {\r\nthis->usecount++;\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nret = this->decompress(cdata_in, data_out, cdatalen, datalen);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nif (ret) {\r\npr_warn("Decompressor \"%s\" returned %d\n",\r\nthis->name, ret);\r\n}\r\nelse {\r\nthis->stat_decompr_blocks++;\r\n}\r\nthis->usecount--;\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nreturn ret;\r\n}\r\n}\r\npr_warn("compression type 0x%02x not available\n", comprtype);\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint jffs2_register_compressor(struct jffs2_compressor *comp)\r\n{\r\nstruct jffs2_compressor *this;\r\nif (!comp->name) {\r\npr_warn("NULL compressor name at registering JFFS2 compressor. Failed.\n");\r\nreturn -1;\r\n}\r\ncomp->compr_buf_size=0;\r\ncomp->compr_buf=NULL;\r\ncomp->usecount=0;\r\ncomp->stat_compr_orig_size=0;\r\ncomp->stat_compr_new_size=0;\r\ncomp->stat_compr_blocks=0;\r\ncomp->stat_decompr_blocks=0;\r\njffs2_dbg(1, "Registering JFFS2 compressor \"%s\"\n", comp->name);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nlist_for_each_entry(this, &jffs2_compressor_list, list) {\r\nif (this->priority < comp->priority) {\r\nlist_add(&comp->list, this->list.prev);\r\ngoto out;\r\n}\r\n}\r\nlist_add_tail(&comp->list, &jffs2_compressor_list);\r\nout:\r\nD2(list_for_each_entry(this, &jffs2_compressor_list, list) {\r\nprintk(KERN_DEBUG "Compressor \"%s\", prio %d\n", this->name, this->priority);\r\n})\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nreturn 0;\r\n}\r\nint jffs2_unregister_compressor(struct jffs2_compressor *comp)\r\n{\r\nD2(struct jffs2_compressor *this);\r\njffs2_dbg(1, "Unregistering JFFS2 compressor \"%s\"\n", comp->name);\r\nspin_lock(&jffs2_compressor_list_lock);\r\nif (comp->usecount) {\r\nspin_unlock(&jffs2_compressor_list_lock);\r\npr_warn("Compressor module is in use. Unregister failed.\n");\r\nreturn -1;\r\n}\r\nlist_del(&comp->list);\r\nD2(list_for_each_entry(this, &jffs2_compressor_list, list) {\r\nprintk(KERN_DEBUG "Compressor \"%s\", prio %d\n", this->name, this->priority);\r\n})\r\nspin_unlock(&jffs2_compressor_list_lock);\r\nreturn 0;\r\n}\r\nvoid jffs2_free_comprbuf(unsigned char *comprbuf, unsigned char *orig)\r\n{\r\nif (orig != comprbuf)\r\nkfree(comprbuf);\r\n}\r\nint __init jffs2_compressors_init(void)\r\n{\r\n#ifdef CONFIG_JFFS2_ZLIB\r\njffs2_zlib_init();\r\n#endif\r\n#ifdef CONFIG_JFFS2_RTIME\r\njffs2_rtime_init();\r\n#endif\r\n#ifdef CONFIG_JFFS2_RUBIN\r\njffs2_rubinmips_init();\r\njffs2_dynrubin_init();\r\n#endif\r\n#ifdef CONFIG_JFFS2_LZO\r\njffs2_lzo_init();\r\n#endif\r\n#ifdef CONFIG_JFFS2_CMODE_NONE\r\njffs2_compression_mode = JFFS2_COMPR_MODE_NONE;\r\njffs2_dbg(1, "default compression mode: none\n");\r\n#else\r\n#ifdef CONFIG_JFFS2_CMODE_SIZE\r\njffs2_compression_mode = JFFS2_COMPR_MODE_SIZE;\r\njffs2_dbg(1, "default compression mode: size\n");\r\n#else\r\n#ifdef CONFIG_JFFS2_CMODE_FAVOURLZO\r\njffs2_compression_mode = JFFS2_COMPR_MODE_FAVOURLZO;\r\njffs2_dbg(1, "default compression mode: favourlzo\n");\r\n#else\r\njffs2_dbg(1, "default compression mode: priority\n");\r\n#endif\r\n#endif\r\n#endif\r\nreturn 0;\r\n}\r\nint jffs2_compressors_exit(void)\r\n{\r\n#ifdef CONFIG_JFFS2_LZO\r\njffs2_lzo_exit();\r\n#endif\r\n#ifdef CONFIG_JFFS2_RUBIN\r\njffs2_dynrubin_exit();\r\njffs2_rubinmips_exit();\r\n#endif\r\n#ifdef CONFIG_JFFS2_RTIME\r\njffs2_rtime_exit();\r\n#endif\r\n#ifdef CONFIG_JFFS2_ZLIB\r\njffs2_zlib_exit();\r\n#endif\r\nreturn 0;\r\n}

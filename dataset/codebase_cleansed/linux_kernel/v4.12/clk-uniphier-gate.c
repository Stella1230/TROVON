static int uniphier_clk_gate_endisable(struct clk_hw *hw, int enable)\r\n{\r\nstruct uniphier_clk_gate *gate = to_uniphier_clk_gate(hw);\r\nreturn regmap_write_bits(gate->regmap, gate->reg, BIT(gate->bit),\r\nenable ? BIT(gate->bit) : 0);\r\n}\r\nstatic int uniphier_clk_gate_enable(struct clk_hw *hw)\r\n{\r\nreturn uniphier_clk_gate_endisable(hw, 1);\r\n}\r\nstatic void uniphier_clk_gate_disable(struct clk_hw *hw)\r\n{\r\nif (uniphier_clk_gate_endisable(hw, 0) < 0)\r\npr_warn("failed to disable clk\n");\r\n}\r\nstatic int uniphier_clk_gate_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct uniphier_clk_gate *gate = to_uniphier_clk_gate(hw);\r\nunsigned int val;\r\nif (regmap_read(gate->regmap, gate->reg, &val) < 0)\r\npr_warn("is_enabled() may return wrong result\n");\r\nreturn !!(val & BIT(gate->bit));\r\n}\r\nstruct clk_hw *uniphier_clk_register_gate(struct device *dev,\r\nstruct regmap *regmap,\r\nconst char *name,\r\nconst struct uniphier_clk_gate_data *data)\r\n{\r\nstruct uniphier_clk_gate *gate;\r\nstruct clk_init_data init;\r\nint ret;\r\ngate = devm_kzalloc(dev, sizeof(*gate), GFP_KERNEL);\r\nif (!gate)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &uniphier_clk_gate_ops;\r\ninit.flags = data->parent_name ? CLK_SET_RATE_PARENT : 0;\r\ninit.parent_names = data->parent_name ? &data->parent_name : NULL;\r\ninit.num_parents = data->parent_name ? 1 : 0;\r\ngate->regmap = regmap;\r\ngate->reg = data->reg;\r\ngate->bit = data->bit;\r\ngate->hw.init = &init;\r\nret = devm_clk_hw_register(dev, &gate->hw);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn &gate->hw;\r\n}

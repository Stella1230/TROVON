static inline int telem_get_unitconfig(enum telemetry_unit telem_unit,\r\nstruct telemetry_unit_config **unit_config)\r\n{\r\nif (telem_unit == TELEM_PSS)\r\n*unit_config = &(telm_conf->pss_config);\r\nelse if (telem_unit == TELEM_IOSS)\r\n*unit_config = &(telm_conf->ioss_config);\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int telemetry_check_evtid(enum telemetry_unit telem_unit,\r\nu32 *evtmap, u8 len,\r\nenum telemetry_action action)\r\n{\r\nstruct telemetry_unit_config *unit_config;\r\nint ret;\r\nret = telem_get_unitconfig(telem_unit, &unit_config);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (action) {\r\ncase TELEM_RESET:\r\nif (len > TELEM_MAX_EVENTS_SRAM)\r\nreturn -EINVAL;\r\nbreak;\r\ncase TELEM_UPDATE:\r\nif (len > TELEM_MAX_EVENTS_SRAM)\r\nreturn -EINVAL;\r\nif ((len > 0) && (evtmap == NULL))\r\nreturn -EINVAL;\r\nbreak;\r\ncase TELEM_ADD:\r\nif ((len + unit_config->ssram_evts_used) >\r\nTELEM_MAX_EVENTS_SRAM)\r\nreturn -EINVAL;\r\nif ((len > 0) && (evtmap == NULL))\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\npr_err("Unknown Telemetry action Specified %d\n", action);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int telemetry_plt_config_ioss_event(u32 evt_id, int index)\r\n{\r\nu32 write_buf;\r\nint ret;\r\nwrite_buf = evt_id | TELEM_EVENT_ENABLE;\r\nwrite_buf <<= BITS_PER_BYTE;\r\nwrite_buf |= index;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_WRITE, (u8 *)&write_buf,\r\nIOSS_TELEM_EVT_WRITE_SIZE, NULL, 0);\r\nreturn ret;\r\n}\r\nstatic inline int telemetry_plt_config_pss_event(u32 evt_id, int index)\r\n{\r\nu32 write_buf;\r\nint ret;\r\nwrite_buf = evt_id | TELEM_EVENT_ENABLE;\r\nret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT,\r\nindex, 0, &write_buf, NULL);\r\nreturn ret;\r\n}\r\nstatic int telemetry_setup_iossevtconfig(struct telemetry_evtconfig evtconfig,\r\nenum telemetry_action action)\r\n{\r\nu8 num_ioss_evts, ioss_period;\r\nint ret, index, idx;\r\nu32 *ioss_evtmap;\r\nu32 telem_ctrl;\r\nnum_ioss_evts = evtconfig.num_evts;\r\nioss_period = evtconfig.period;\r\nioss_evtmap = evtconfig.evtmap;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_READ, NULL, 0,\r\n&telem_ctrl, IOSS_TELEM_READ_WORD);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Read Failed\n");\r\nreturn ret;\r\n}\r\nTELEM_DISABLE(telem_ctrl);\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE,\r\nNULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\nif (action == TELEM_RESET) {\r\nTELEM_CLEAR_EVENTS(telem_ctrl);\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE,\r\nNULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->ioss_config.ssram_evts_used = 0;\r\nfor (idx = 0; idx < num_ioss_evts; idx++) {\r\nif (telemetry_plt_config_ioss_event(\r\ntelm_conf->ioss_config.telem_evts[idx].evt_id,\r\nidx)) {\r\npr_err("IOSS TELEM_RESET Fail for data: %x\n",\r\ntelm_conf->ioss_config.telem_evts[idx].evt_id);\r\ncontinue;\r\n}\r\ntelm_conf->ioss_config.ssram_evts_used++;\r\n}\r\n}\r\nif (action == TELEM_UPDATE) {\r\nTELEM_CLEAR_EVENTS(telem_ctrl);\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE,\r\nNULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->ioss_config.ssram_evts_used = 0;\r\nfor (index = 0; index < num_ioss_evts; index++) {\r\ntelm_conf->ioss_config.telem_evts[index].evt_id =\r\nioss_evtmap[index];\r\nif (telemetry_plt_config_ioss_event(\r\ntelm_conf->ioss_config.telem_evts[index].evt_id,\r\nindex)) {\r\npr_err("IOSS TELEM_UPDATE Fail for Evt%x\n",\r\nioss_evtmap[index]);\r\ncontinue;\r\n}\r\ntelm_conf->ioss_config.ssram_evts_used++;\r\n}\r\n}\r\nif (action == TELEM_ADD) {\r\nfor (index = telm_conf->ioss_config.ssram_evts_used, idx = 0;\r\nidx < num_ioss_evts; index++, idx++) {\r\ntelm_conf->ioss_config.telem_evts[index].evt_id =\r\nioss_evtmap[idx];\r\nif (telemetry_plt_config_ioss_event(\r\ntelm_conf->ioss_config.telem_evts[index].evt_id,\r\nindex)) {\r\npr_err("IOSS TELEM_ADD Fail for Event %x\n",\r\nioss_evtmap[idx]);\r\ncontinue;\r\n}\r\ntelm_conf->ioss_config.ssram_evts_used++;\r\n}\r\n}\r\nTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\r\nTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\r\nTELEM_ENABLE_PERIODIC(telem_ctrl);\r\ntelem_ctrl |= ioss_period;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE, NULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Enable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->ioss_config.curr_period = ioss_period;\r\nreturn 0;\r\n}\r\nstatic int telemetry_setup_pssevtconfig(struct telemetry_evtconfig evtconfig,\r\nenum telemetry_action action)\r\n{\r\nu8 num_pss_evts, pss_period;\r\nint ret, index, idx;\r\nu32 *pss_evtmap;\r\nu32 telem_ctrl;\r\nnum_pss_evts = evtconfig.num_evts;\r\npss_period = evtconfig.period;\r\npss_evtmap = evtconfig.evtmap;\r\nret = intel_punit_ipc_command(IPC_PUNIT_BIOS_READ_TELE_EVENT_CTRL,\r\n0, 0, NULL, &telem_ctrl);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Read Failed\n");\r\nreturn ret;\r\n}\r\nTELEM_DISABLE(telem_ctrl);\r\nret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\nif (action == TELEM_RESET) {\r\nTELEM_CLEAR_EVENTS(telem_ctrl);\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->pss_config.ssram_evts_used = 0;\r\nfor (idx = 0; idx < num_pss_evts; idx++) {\r\nif (telemetry_plt_config_pss_event(\r\ntelm_conf->pss_config.telem_evts[idx].evt_id,\r\nidx)) {\r\npr_err("PSS TELEM_RESET Fail for Event %x\n",\r\ntelm_conf->pss_config.telem_evts[idx].evt_id);\r\ncontinue;\r\n}\r\ntelm_conf->pss_config.ssram_evts_used++;\r\n}\r\n}\r\nif (action == TELEM_UPDATE) {\r\nTELEM_CLEAR_EVENTS(telem_ctrl);\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Disable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->pss_config.ssram_evts_used = 0;\r\nfor (index = 0; index < num_pss_evts; index++) {\r\ntelm_conf->pss_config.telem_evts[index].evt_id =\r\npss_evtmap[index];\r\nif (telemetry_plt_config_pss_event(\r\ntelm_conf->pss_config.telem_evts[index].evt_id,\r\nindex)) {\r\npr_err("PSS TELEM_UPDATE Fail for Event %x\n",\r\npss_evtmap[index]);\r\ncontinue;\r\n}\r\ntelm_conf->pss_config.ssram_evts_used++;\r\n}\r\n}\r\nif (action == TELEM_ADD) {\r\nfor (index = telm_conf->pss_config.ssram_evts_used, idx = 0;\r\nidx < num_pss_evts; index++, idx++) {\r\ntelm_conf->pss_config.telem_evts[index].evt_id =\r\npss_evtmap[idx];\r\nif (telemetry_plt_config_pss_event(\r\ntelm_conf->pss_config.telem_evts[index].evt_id,\r\nindex)) {\r\npr_err("PSS TELEM_ADD Fail for Event %x\n",\r\npss_evtmap[idx]);\r\ncontinue;\r\n}\r\ntelm_conf->pss_config.ssram_evts_used++;\r\n}\r\n}\r\nTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\r\nTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\r\nTELEM_ENABLE_PERIODIC(telem_ctrl);\r\ntelem_ctrl |= pss_period;\r\nret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Enable Write Failed\n");\r\nreturn ret;\r\n}\r\ntelm_conf->pss_config.curr_period = pss_period;\r\nreturn 0;\r\n}\r\nstatic int telemetry_setup_evtconfig(struct telemetry_evtconfig pss_evtconfig,\r\nstruct telemetry_evtconfig ioss_evtconfig,\r\nenum telemetry_action action)\r\n{\r\nint ret;\r\nmutex_lock(&(telm_conf->telem_lock));\r\nif ((action == TELEM_UPDATE) && (telm_conf->telem_in_use)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nret = telemetry_check_evtid(TELEM_PSS, pss_evtconfig.evtmap,\r\npss_evtconfig.num_evts, action);\r\nif (ret)\r\ngoto out;\r\nret = telemetry_check_evtid(TELEM_IOSS, ioss_evtconfig.evtmap,\r\nioss_evtconfig.num_evts, action);\r\nif (ret)\r\ngoto out;\r\nif (ioss_evtconfig.num_evts) {\r\nret = telemetry_setup_iossevtconfig(ioss_evtconfig, action);\r\nif (ret)\r\ngoto out;\r\n}\r\nif (pss_evtconfig.num_evts) {\r\nret = telemetry_setup_pssevtconfig(pss_evtconfig, action);\r\nif (ret)\r\ngoto out;\r\n}\r\nif ((action == TELEM_UPDATE) || (action == TELEM_ADD))\r\ntelm_conf->telem_in_use = true;\r\nelse\r\ntelm_conf->telem_in_use = false;\r\nout:\r\nmutex_unlock(&(telm_conf->telem_lock));\r\nreturn ret;\r\n}\r\nstatic int telemetry_setup(struct platform_device *pdev)\r\n{\r\nstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\r\nu32 read_buf, events, event_regs;\r\nint ret;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY, IOSS_TELEM_INFO_READ,\r\nNULL, 0, &read_buf, IOSS_TELEM_READ_WORD);\r\nif (ret) {\r\ndev_err(&pdev->dev, "IOSS TELEM_INFO Read Failed\n");\r\nreturn ret;\r\n}\r\nevents = (read_buf & TELEM_INFO_SRAMEVTS_MASK) >>\r\nTELEM_INFO_SRAMEVTS_SHIFT;\r\nevent_regs = read_buf & TELEM_INFO_NENABLES_MASK;\r\nif ((events < TELEM_MAX_EVENTS_SRAM) ||\r\n(event_regs < TELEM_MAX_EVENTS_SRAM)) {\r\ndev_err(&pdev->dev, "IOSS:Insufficient Space for SRAM Trace\n");\r\ndev_err(&pdev->dev, "SRAM Events %d; Event Regs %d\n",\r\nevents, event_regs);\r\nreturn -ENOMEM;\r\n}\r\ntelm_conf->ioss_config.min_period = TELEM_MIN_PERIOD(read_buf);\r\ntelm_conf->ioss_config.max_period = TELEM_MAX_PERIOD(read_buf);\r\nret = intel_punit_ipc_command(IPC_PUNIT_BIOS_READ_TELE_INFO, 0, 0,\r\nNULL, &read_buf);\r\nif (ret) {\r\ndev_err(&pdev->dev, "PSS TELEM_INFO Read Failed\n");\r\nreturn ret;\r\n}\r\nevents = (read_buf & TELEM_INFO_SRAMEVTS_MASK) >>\r\nTELEM_INFO_SRAMEVTS_SHIFT;\r\nevent_regs = read_buf & TELEM_INFO_SRAMEVTS_MASK;\r\nif ((events < TELEM_MAX_EVENTS_SRAM) ||\r\n(event_regs < TELEM_MAX_EVENTS_SRAM)) {\r\ndev_err(&pdev->dev, "PSS:Insufficient Space for SRAM Trace\n");\r\ndev_err(&pdev->dev, "SRAM Events %d; Event Regs %d\n",\r\nevents, event_regs);\r\nreturn -ENOMEM;\r\n}\r\ntelm_conf->pss_config.min_period = TELEM_MIN_PERIOD(read_buf);\r\ntelm_conf->pss_config.max_period = TELEM_MAX_PERIOD(read_buf);\r\npss_evtconfig.evtmap = NULL;\r\npss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\r\npss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\r\nioss_evtconfig.evtmap = NULL;\r\nioss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\r\nioss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\r\nret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\r\nTELEM_RESET);\r\nif (ret) {\r\ndev_err(&pdev->dev, "TELEMTRY Setup Failed\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int telemetry_plt_update_events(struct telemetry_evtconfig pss_evtconfig,\r\nstruct telemetry_evtconfig ioss_evtconfig)\r\n{\r\nint ret;\r\nif ((pss_evtconfig.num_evts > 0) &&\r\n(TELEM_SAMPLE_PERIOD_INVALID(pss_evtconfig.period))) {\r\npr_err("PSS Sampling Period Out of Range\n");\r\nreturn -EINVAL;\r\n}\r\nif ((ioss_evtconfig.num_evts > 0) &&\r\n(TELEM_SAMPLE_PERIOD_INVALID(ioss_evtconfig.period))) {\r\npr_err("IOSS Sampling Period Out of Range\n");\r\nreturn -EINVAL;\r\n}\r\nret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\r\nTELEM_UPDATE);\r\nif (ret)\r\npr_err("TELEMTRY Config Failed\n");\r\nreturn ret;\r\n}\r\nstatic int telemetry_plt_set_sampling_period(u8 pss_period, u8 ioss_period)\r\n{\r\nu32 telem_ctrl = 0;\r\nint ret = 0;\r\nmutex_lock(&(telm_conf->telem_lock));\r\nif (ioss_period) {\r\nif (TELEM_SAMPLE_PERIOD_INVALID(ioss_period)) {\r\npr_err("IOSS Sampling Period Out of Range\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_READ, NULL, 0,\r\n&telem_ctrl, IOSS_TELEM_READ_WORD);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Read Failed\n");\r\ngoto out;\r\n}\r\nTELEM_DISABLE(telem_ctrl);\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE,\r\nNULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Disable Write Failed\n");\r\ngoto out;\r\n}\r\nTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\r\nTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\r\nTELEM_ENABLE_PERIODIC(telem_ctrl);\r\ntelem_ctrl |= ioss_period;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_EVENT_CTL_WRITE,\r\n(u8 *)&telem_ctrl,\r\nIOSS_TELEM_EVT_CTRL_WRITE_SIZE,\r\nNULL, 0);\r\nif (ret) {\r\npr_err("IOSS TELEM_CTRL Event Enable Write Failed\n");\r\ngoto out;\r\n}\r\ntelm_conf->ioss_config.curr_period = ioss_period;\r\n}\r\nif (pss_period) {\r\nif (TELEM_SAMPLE_PERIOD_INVALID(pss_period)) {\r\npr_err("PSS Sampling Period Out of Range\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_READ_TELE_EVENT_CTRL,\r\n0, 0, NULL, &telem_ctrl);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Read Failed\n");\r\ngoto out;\r\n}\r\nTELEM_DISABLE(telem_ctrl);\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Disable Write Failed\n");\r\ngoto out;\r\n}\r\nTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\r\nTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\r\nTELEM_ENABLE_PERIODIC(telem_ctrl);\r\ntelem_ctrl |= pss_period;\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\r\n0, 0, &telem_ctrl, NULL);\r\nif (ret) {\r\npr_err("PSS TELEM_CTRL Event Enable Write Failed\n");\r\ngoto out;\r\n}\r\ntelm_conf->pss_config.curr_period = pss_period;\r\n}\r\nout:\r\nmutex_unlock(&(telm_conf->telem_lock));\r\nreturn ret;\r\n}\r\nstatic int telemetry_plt_get_sampling_period(u8 *pss_min_period,\r\nu8 *pss_max_period,\r\nu8 *ioss_min_period,\r\nu8 *ioss_max_period)\r\n{\r\n*pss_min_period = telm_conf->pss_config.min_period;\r\n*pss_max_period = telm_conf->pss_config.max_period;\r\n*ioss_min_period = telm_conf->ioss_config.min_period;\r\n*ioss_max_period = telm_conf->ioss_config.max_period;\r\nreturn 0;\r\n}\r\nstatic int telemetry_plt_reset_events(void)\r\n{\r\nstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\r\nint ret;\r\npss_evtconfig.evtmap = NULL;\r\npss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\r\npss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\r\nioss_evtconfig.evtmap = NULL;\r\nioss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\r\nioss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\r\nret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\r\nTELEM_RESET);\r\nif (ret)\r\npr_err("TELEMTRY Reset Failed\n");\r\nreturn ret;\r\n}\r\nstatic int telemetry_plt_get_eventconfig(struct telemetry_evtconfig *pss_config,\r\nstruct telemetry_evtconfig *ioss_config,\r\nint pss_len, int ioss_len)\r\n{\r\nu32 *pss_evtmap, *ioss_evtmap;\r\nu32 index;\r\npss_evtmap = pss_config->evtmap;\r\nioss_evtmap = ioss_config->evtmap;\r\nmutex_lock(&(telm_conf->telem_lock));\r\npss_config->num_evts = telm_conf->pss_config.ssram_evts_used;\r\nioss_config->num_evts = telm_conf->ioss_config.ssram_evts_used;\r\npss_config->period = telm_conf->pss_config.curr_period;\r\nioss_config->period = telm_conf->ioss_config.curr_period;\r\nif ((pss_len < telm_conf->pss_config.ssram_evts_used) ||\r\n(ioss_len < telm_conf->ioss_config.ssram_evts_used)) {\r\nmutex_unlock(&(telm_conf->telem_lock));\r\nreturn -EINVAL;\r\n}\r\nfor (index = 0; index < telm_conf->pss_config.ssram_evts_used;\r\nindex++) {\r\npss_evtmap[index] =\r\ntelm_conf->pss_config.telem_evts[index].evt_id;\r\n}\r\nfor (index = 0; index < telm_conf->ioss_config.ssram_evts_used;\r\nindex++) {\r\nioss_evtmap[index] =\r\ntelm_conf->ioss_config.telem_evts[index].evt_id;\r\n}\r\nmutex_unlock(&(telm_conf->telem_lock));\r\nreturn 0;\r\n}\r\nstatic int telemetry_plt_add_events(u8 num_pss_evts, u8 num_ioss_evts,\r\nu32 *pss_evtmap, u32 *ioss_evtmap)\r\n{\r\nstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\r\nint ret;\r\npss_evtconfig.evtmap = pss_evtmap;\r\npss_evtconfig.num_evts = num_pss_evts;\r\npss_evtconfig.period = telm_conf->pss_config.curr_period;\r\nioss_evtconfig.evtmap = ioss_evtmap;\r\nioss_evtconfig.num_evts = num_ioss_evts;\r\nioss_evtconfig.period = telm_conf->ioss_config.curr_period;\r\nret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\r\nTELEM_ADD);\r\nif (ret)\r\npr_err("TELEMTRY ADD Failed\n");\r\nreturn ret;\r\n}\r\nstatic int telem_evtlog_read(enum telemetry_unit telem_unit,\r\nstruct telem_ssram_region *ssram_region, u8 len)\r\n{\r\nstruct telemetry_unit_config *unit_config;\r\nu64 timestamp_prev, timestamp_next;\r\nint ret, index, timeout = 0;\r\nret = telem_get_unitconfig(telem_unit, &unit_config);\r\nif (ret < 0)\r\nreturn ret;\r\nif (len > unit_config->ssram_evts_used)\r\nlen = unit_config->ssram_evts_used;\r\ndo {\r\ntimestamp_prev = readq(unit_config->regmap);\r\nif (!timestamp_prev) {\r\npr_err("Ssram under update. Please Try Later\n");\r\nreturn -EBUSY;\r\n}\r\nssram_region->start_time = readq(unit_config->regmap +\r\nTELEM_SSRAM_STARTTIME_OFFSET);\r\nfor (index = 0; index < len; index++) {\r\nssram_region->events[index] =\r\nreadq(unit_config->regmap + TELEM_SSRAM_EVTLOG_OFFSET +\r\nBYTES_PER_LONG*index);\r\n}\r\ntimestamp_next = readq(unit_config->regmap);\r\nif (!timestamp_next) {\r\npr_err("Ssram under update. Please Try Later\n");\r\nreturn -EBUSY;\r\n}\r\nif (timeout++ > TELEM_SSRAM_READ_TIMEOUT) {\r\npr_err("Timeout while reading Events\n");\r\nreturn -EBUSY;\r\n}\r\n} while (timestamp_prev != timestamp_next);\r\nssram_region->timestamp = timestamp_next;\r\nreturn len;\r\n}\r\nstatic int telemetry_plt_raw_read_eventlog(enum telemetry_unit telem_unit,\r\nstruct telemetry_evtlog *evtlog,\r\nint len, int log_all_evts)\r\n{\r\nint index, idx1, ret, readlen = len;\r\nstruct telem_ssram_region ssram_region;\r\nstruct telemetry_evtmap *evtmap;\r\nswitch (telem_unit) {\r\ncase TELEM_PSS:\r\nevtmap = telm_conf->pss_config.telem_evts;\r\nbreak;\r\ncase TELEM_IOSS:\r\nevtmap = telm_conf->ioss_config.telem_evts;\r\nbreak;\r\ndefault:\r\npr_err("Unknown Telemetry Unit Specified %d\n", telem_unit);\r\nreturn -EINVAL;\r\n}\r\nif (!log_all_evts)\r\nreadlen = TELEM_MAX_EVENTS_SRAM;\r\nret = telem_evtlog_read(telem_unit, &ssram_region, readlen);\r\nif (ret < 0)\r\nreturn ret;\r\nif ((!log_all_evts) && (len > ret))\r\nreturn -EINVAL;\r\nif (log_all_evts)\r\nfor (index = 0; index < ret; index++) {\r\nevtlog[index].telem_evtlog = ssram_region.events[index];\r\nevtlog[index].telem_evtid = evtmap[index].evt_id;\r\n}\r\nelse\r\nfor (index = 0, readlen = 0; (index < ret) && (readlen < len);\r\nindex++) {\r\nfor (idx1 = 0; idx1 < len; idx1++) {\r\nif (evtmap[index].evt_id ==\r\nevtlog[idx1].telem_evtid) {\r\nevtlog[idx1].telem_evtlog =\r\nssram_region.events[index];\r\nreadlen++;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn readlen;\r\n}\r\nstatic int telemetry_plt_read_eventlog(enum telemetry_unit telem_unit,\r\nstruct telemetry_evtlog *evtlog, int len, int log_all_evts)\r\n{\r\nint ret;\r\nmutex_lock(&(telm_conf->telem_lock));\r\nret = telemetry_plt_raw_read_eventlog(telem_unit, evtlog,\r\nlen, log_all_evts);\r\nmutex_unlock(&(telm_conf->telem_lock));\r\nreturn ret;\r\n}\r\nstatic int telemetry_plt_get_trace_verbosity(enum telemetry_unit telem_unit,\r\nu32 *verbosity)\r\n{\r\nu32 temp = 0;\r\nint ret;\r\nif (verbosity == NULL)\r\nreturn -EINVAL;\r\nmutex_lock(&(telm_conf->telem_trace_lock));\r\nswitch (telem_unit) {\r\ncase TELEM_PSS:\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_READ_TELE_TRACE_CTRL,\r\n0, 0, NULL, &temp);\r\nif (ret) {\r\npr_err("PSS TRACE_CTRL Read Failed\n");\r\ngoto out;\r\n}\r\nbreak;\r\ncase TELEM_IOSS:\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_TRACE_CTL_READ, NULL, 0, &temp,\r\nIOSS_TELEM_READ_WORD);\r\nif (ret) {\r\npr_err("IOSS TRACE_CTL Read Failed\n");\r\ngoto out;\r\n}\r\nbreak;\r\ndefault:\r\npr_err("Unknown Telemetry Unit Specified %d\n", telem_unit);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nTELEM_EXTRACT_VERBOSITY(temp, *verbosity);\r\nout:\r\nmutex_unlock(&(telm_conf->telem_trace_lock));\r\nreturn ret;\r\n}\r\nstatic int telemetry_plt_set_trace_verbosity(enum telemetry_unit telem_unit,\r\nu32 verbosity)\r\n{\r\nu32 temp = 0;\r\nint ret;\r\nverbosity &= TELEM_TRC_VERBOSITY_MASK;\r\nmutex_lock(&(telm_conf->telem_trace_lock));\r\nswitch (telem_unit) {\r\ncase TELEM_PSS:\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_READ_TELE_TRACE_CTRL,\r\n0, 0, NULL, &temp);\r\nif (ret) {\r\npr_err("PSS TRACE_CTRL Read Failed\n");\r\ngoto out;\r\n}\r\nTELEM_CLEAR_VERBOSITY_BITS(temp);\r\nTELEM_SET_VERBOSITY_BITS(temp, verbosity);\r\nret = intel_punit_ipc_command(\r\nIPC_PUNIT_BIOS_WRITE_TELE_TRACE_CTRL,\r\n0, 0, &temp, NULL);\r\nif (ret) {\r\npr_err("PSS TRACE_CTRL Verbosity Set Failed\n");\r\ngoto out;\r\n}\r\nbreak;\r\ncase TELEM_IOSS:\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_TRACE_CTL_READ, NULL, 0, &temp,\r\nIOSS_TELEM_READ_WORD);\r\nif (ret) {\r\npr_err("IOSS TRACE_CTL Read Failed\n");\r\ngoto out;\r\n}\r\nTELEM_CLEAR_VERBOSITY_BITS(temp);\r\nTELEM_SET_VERBOSITY_BITS(temp, verbosity);\r\nret = intel_pmc_ipc_command(PMC_IPC_PMC_TELEMTRY,\r\nIOSS_TELEM_TRACE_CTL_WRITE, (u8 *)&temp,\r\nIOSS_TELEM_WRITE_FOURBYTES, NULL, 0);\r\nif (ret) {\r\npr_err("IOSS TRACE_CTL Verbosity Set Failed\n");\r\ngoto out;\r\n}\r\nbreak;\r\ndefault:\r\npr_err("Unknown Telemetry Unit Specified %d\n", telem_unit);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nout:\r\nmutex_unlock(&(telm_conf->telem_trace_lock));\r\nreturn ret;\r\n}\r\nstatic int telemetry_pltdrv_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res0 = NULL, *res1 = NULL;\r\nconst struct x86_cpu_id *id;\r\nint size, ret = -ENOMEM;\r\nid = x86_match_cpu(telemetry_cpu_ids);\r\nif (!id)\r\nreturn -ENODEV;\r\ntelm_conf = (struct telemetry_plt_config *)id->driver_data;\r\nres0 = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res0) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nsize = resource_size(res0);\r\nif (!devm_request_mem_region(&pdev->dev, res0->start, size,\r\npdev->name)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ntelm_conf->pss_config.ssram_base_addr = res0->start;\r\ntelm_conf->pss_config.ssram_size = size;\r\nres1 = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res1) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nsize = resource_size(res1);\r\nif (!devm_request_mem_region(&pdev->dev, res1->start, size,\r\npdev->name)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ntelm_conf->ioss_config.ssram_base_addr = res1->start;\r\ntelm_conf->ioss_config.ssram_size = size;\r\ntelm_conf->pss_config.regmap = ioremap_nocache(\r\ntelm_conf->pss_config.ssram_base_addr,\r\ntelm_conf->pss_config.ssram_size);\r\nif (!telm_conf->pss_config.regmap) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\ntelm_conf->ioss_config.regmap = ioremap_nocache(\r\ntelm_conf->ioss_config.ssram_base_addr,\r\ntelm_conf->ioss_config.ssram_size);\r\nif (!telm_conf->ioss_config.regmap) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmutex_init(&telm_conf->telem_lock);\r\nmutex_init(&telm_conf->telem_trace_lock);\r\nret = telemetry_setup(pdev);\r\nif (ret)\r\ngoto out;\r\nret = telemetry_set_pltdata(&telm_pltops, telm_conf);\r\nif (ret) {\r\ndev_err(&pdev->dev, "TELEMTRY Set Pltops Failed.\n");\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\nif (res0)\r\nrelease_mem_region(res0->start, resource_size(res0));\r\nif (res1)\r\nrelease_mem_region(res1->start, resource_size(res1));\r\nif (telm_conf->pss_config.regmap)\r\niounmap(telm_conf->pss_config.regmap);\r\nif (telm_conf->ioss_config.regmap)\r\niounmap(telm_conf->ioss_config.regmap);\r\ndev_err(&pdev->dev, "TELEMTRY Setup Failed.\n");\r\nreturn ret;\r\n}\r\nstatic int telemetry_pltdrv_remove(struct platform_device *pdev)\r\n{\r\ntelemetry_clear_pltdata();\r\niounmap(telm_conf->pss_config.regmap);\r\niounmap(telm_conf->ioss_config.regmap);\r\nreturn 0;\r\n}\r\nstatic int __init telemetry_module_init(void)\r\n{\r\npr_info(DRIVER_NAME ": version %s loaded\n", DRIVER_VERSION);\r\nreturn platform_driver_register(&telemetry_soc_driver);\r\n}\r\nstatic void __exit telemetry_module_exit(void)\r\n{\r\nplatform_driver_unregister(&telemetry_soc_driver);\r\n}

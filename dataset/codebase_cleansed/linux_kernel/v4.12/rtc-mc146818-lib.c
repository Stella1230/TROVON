static inline unsigned char mc146818_is_updating(void)\r\n{\r\nunsigned char uip;\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nuip = (CMOS_READ(RTC_FREQ_SELECT) & RTC_UIP);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn uip;\r\n}\r\nunsigned int mc146818_get_time(struct rtc_time *time)\r\n{\r\nunsigned char ctrl;\r\nunsigned long flags;\r\nunsigned char century = 0;\r\n#ifdef CONFIG_MACH_DECSTATION\r\nunsigned int real_year;\r\n#endif\r\nif (mc146818_is_updating())\r\nmdelay(20);\r\nspin_lock_irqsave(&rtc_lock, flags);\r\ntime->tm_sec = CMOS_READ(RTC_SECONDS);\r\ntime->tm_min = CMOS_READ(RTC_MINUTES);\r\ntime->tm_hour = CMOS_READ(RTC_HOURS);\r\ntime->tm_mday = CMOS_READ(RTC_DAY_OF_MONTH);\r\ntime->tm_mon = CMOS_READ(RTC_MONTH);\r\ntime->tm_year = CMOS_READ(RTC_YEAR);\r\n#ifdef CONFIG_MACH_DECSTATION\r\nreal_year = CMOS_READ(RTC_DEC_YEAR);\r\n#endif\r\n#ifdef CONFIG_ACPI\r\nif (acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID &&\r\nacpi_gbl_FADT.century)\r\ncentury = CMOS_READ(acpi_gbl_FADT.century);\r\n#endif\r\nctrl = CMOS_READ(RTC_CONTROL);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nif (!(ctrl & RTC_DM_BINARY) || RTC_ALWAYS_BCD)\r\n{\r\ntime->tm_sec = bcd2bin(time->tm_sec);\r\ntime->tm_min = bcd2bin(time->tm_min);\r\ntime->tm_hour = bcd2bin(time->tm_hour);\r\ntime->tm_mday = bcd2bin(time->tm_mday);\r\ntime->tm_mon = bcd2bin(time->tm_mon);\r\ntime->tm_year = bcd2bin(time->tm_year);\r\ncentury = bcd2bin(century);\r\n}\r\n#ifdef CONFIG_MACH_DECSTATION\r\ntime->tm_year += real_year - 72;\r\n#endif\r\nif (century)\r\ntime->tm_year += (century - 19) * 100;\r\nif (time->tm_year <= 69)\r\ntime->tm_year += 100;\r\ntime->tm_mon--;\r\nreturn RTC_24H;\r\n}\r\nint mc146818_set_time(struct rtc_time *time)\r\n{\r\nunsigned long flags;\r\nunsigned char mon, day, hrs, min, sec;\r\nunsigned char save_control, save_freq_select;\r\nunsigned int yrs;\r\n#ifdef CONFIG_MACH_DECSTATION\r\nunsigned int real_yrs, leap_yr;\r\n#endif\r\nunsigned char century = 0;\r\nyrs = time->tm_year;\r\nmon = time->tm_mon + 1;\r\nday = time->tm_mday;\r\nhrs = time->tm_hour;\r\nmin = time->tm_min;\r\nsec = time->tm_sec;\r\nif (yrs > 255)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\n#ifdef CONFIG_MACH_DECSTATION\r\nreal_yrs = yrs;\r\nleap_yr = ((!((yrs + 1900) % 4) && ((yrs + 1900) % 100)) ||\r\n!((yrs + 1900) % 400));\r\nyrs = 72;\r\nif (!leap_yr && mon < 3) {\r\nreal_yrs--;\r\nyrs = 73;\r\n}\r\n#endif\r\n#ifdef CONFIG_ACPI\r\nif (acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID &&\r\nacpi_gbl_FADT.century) {\r\ncentury = (yrs + 1900) / 100;\r\nyrs %= 100;\r\n}\r\n#endif\r\nif (yrs > 169) {\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn -EINVAL;\r\n}\r\nif (yrs >= 100)\r\nyrs -= 100;\r\nif (!(CMOS_READ(RTC_CONTROL) & RTC_DM_BINARY)\r\n|| RTC_ALWAYS_BCD) {\r\nsec = bin2bcd(sec);\r\nmin = bin2bcd(min);\r\nhrs = bin2bcd(hrs);\r\nday = bin2bcd(day);\r\nmon = bin2bcd(mon);\r\nyrs = bin2bcd(yrs);\r\ncentury = bin2bcd(century);\r\n}\r\nsave_control = CMOS_READ(RTC_CONTROL);\r\nCMOS_WRITE((save_control|RTC_SET), RTC_CONTROL);\r\nsave_freq_select = CMOS_READ(RTC_FREQ_SELECT);\r\nCMOS_WRITE((save_freq_select|RTC_DIV_RESET2), RTC_FREQ_SELECT);\r\n#ifdef CONFIG_MACH_DECSTATION\r\nCMOS_WRITE(real_yrs, RTC_DEC_YEAR);\r\n#endif\r\nCMOS_WRITE(yrs, RTC_YEAR);\r\nCMOS_WRITE(mon, RTC_MONTH);\r\nCMOS_WRITE(day, RTC_DAY_OF_MONTH);\r\nCMOS_WRITE(hrs, RTC_HOURS);\r\nCMOS_WRITE(min, RTC_MINUTES);\r\nCMOS_WRITE(sec, RTC_SECONDS);\r\n#ifdef CONFIG_ACPI\r\nif (acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID &&\r\nacpi_gbl_FADT.century)\r\nCMOS_WRITE(century, acpi_gbl_FADT.century);\r\n#endif\r\nCMOS_WRITE(save_control, RTC_CONTROL);\r\nCMOS_WRITE(save_freq_select, RTC_FREQ_SELECT);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn 0;\r\n}

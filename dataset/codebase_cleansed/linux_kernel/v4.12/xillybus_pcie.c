static int xilly_pci_direction(int direction)\r\n{\r\nswitch (direction) {\r\ncase DMA_TO_DEVICE:\r\nreturn PCI_DMA_TODEVICE;\r\ncase DMA_FROM_DEVICE:\r\nreturn PCI_DMA_FROMDEVICE;\r\ndefault:\r\nreturn PCI_DMA_BIDIRECTIONAL;\r\n}\r\n}\r\nstatic void xilly_dma_sync_single_for_cpu_pci(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\npci_dma_sync_single_for_cpu(ep->pdev,\r\ndma_handle,\r\nsize,\r\nxilly_pci_direction(direction));\r\n}\r\nstatic void xilly_dma_sync_single_for_device_pci(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\npci_dma_sync_single_for_device(ep->pdev,\r\ndma_handle,\r\nsize,\r\nxilly_pci_direction(direction));\r\n}\r\nstatic void xilly_pci_unmap(void *ptr)\r\n{\r\nstruct xilly_mapping *data = ptr;\r\npci_unmap_single(data->device, data->dma_addr,\r\ndata->size, data->direction);\r\nkfree(ptr);\r\n}\r\nstatic int xilly_map_single_pci(struct xilly_endpoint *ep,\r\nvoid *ptr,\r\nsize_t size,\r\nint direction,\r\ndma_addr_t *ret_dma_handle\r\n)\r\n{\r\nint pci_direction;\r\ndma_addr_t addr;\r\nstruct xilly_mapping *this;\r\nthis = kzalloc(sizeof(*this), GFP_KERNEL);\r\nif (!this)\r\nreturn -ENOMEM;\r\npci_direction = xilly_pci_direction(direction);\r\naddr = pci_map_single(ep->pdev, ptr, size, pci_direction);\r\nif (pci_dma_mapping_error(ep->pdev, addr)) {\r\nkfree(this);\r\nreturn -ENODEV;\r\n}\r\nthis->device = ep->pdev;\r\nthis->dma_addr = addr;\r\nthis->size = size;\r\nthis->direction = pci_direction;\r\n*ret_dma_handle = addr;\r\nreturn devm_add_action_or_reset(ep->dev, xilly_pci_unmap, this);\r\n}\r\nstatic int xilly_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct xilly_endpoint *endpoint;\r\nint rc;\r\nendpoint = xillybus_init_endpoint(pdev, &pdev->dev, &pci_hw);\r\nif (!endpoint)\r\nreturn -ENOMEM;\r\npci_set_drvdata(pdev, endpoint);\r\nrc = pcim_enable_device(pdev);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"pcim_enable_device() failed. Aborting.\n");\r\nreturn rc;\r\n}\r\npci_disable_link_state(pdev, PCIE_LINK_STATE_L0S);\r\nif (!(pci_resource_flags(pdev, 0) & IORESOURCE_MEM)) {\r\ndev_err(endpoint->dev,\r\n"Incorrect BAR configuration. Aborting.\n");\r\nreturn -ENODEV;\r\n}\r\nrc = pcim_iomap_regions(pdev, 0x01, xillyname);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"pcim_iomap_regions() failed. Aborting.\n");\r\nreturn rc;\r\n}\r\nendpoint->registers = pcim_iomap_table(pdev)[0];\r\npci_set_master(pdev);\r\nif (pci_enable_msi(pdev)) {\r\ndev_err(endpoint->dev,\r\n"Failed to enable MSI interrupts. Aborting.\n");\r\nreturn -ENODEV;\r\n}\r\nrc = devm_request_irq(&pdev->dev, pdev->irq, xillybus_isr, 0,\r\nxillyname, endpoint);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"Failed to register MSI handler. Aborting.\n");\r\nreturn -ENODEV;\r\n}\r\nif (!pci_set_dma_mask(pdev, DMA_BIT_MASK(32))) {\r\nendpoint->dma_using_dac = 0;\r\n} else if (!pci_set_dma_mask(pdev, DMA_BIT_MASK(64))) {\r\nendpoint->dma_using_dac = 1;\r\n} else {\r\ndev_err(endpoint->dev, "Failed to set DMA mask. Aborting.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn xillybus_endpoint_discovery(endpoint);\r\n}\r\nstatic void xilly_remove(struct pci_dev *pdev)\r\n{\r\nstruct xilly_endpoint *endpoint = pci_get_drvdata(pdev);\r\nxillybus_endpoint_remove(endpoint);\r\n}

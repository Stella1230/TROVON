static int thunderx_spi_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct spi_master *master;\r\nstruct octeon_spi *p;\r\nint ret;\r\nmaster = spi_alloc_master(dev, sizeof(struct octeon_spi));\r\nif (!master)\r\nreturn -ENOMEM;\r\np = spi_master_get_devdata(master);\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\ngoto error;\r\nret = pci_request_regions(pdev, DRV_NAME);\r\nif (ret)\r\ngoto error;\r\np->register_base = pcim_iomap(pdev, 0, pci_resource_len(pdev, 0));\r\nif (!p->register_base) {\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\np->regs.config = 0x1000;\r\np->regs.status = 0x1008;\r\np->regs.tx = 0x1010;\r\np->regs.data = 0x1080;\r\np->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(p->clk)) {\r\nret = PTR_ERR(p->clk);\r\ngoto error;\r\n}\r\nret = clk_prepare_enable(p->clk);\r\nif (ret)\r\ngoto error;\r\np->sys_freq = clk_get_rate(p->clk);\r\nif (!p->sys_freq)\r\np->sys_freq = SYS_FREQ_DEFAULT;\r\ndev_info(dev, "Set system clock to %u\n", p->sys_freq);\r\nmaster->num_chipselect = 4;\r\nmaster->mode_bits = SPI_CPHA | SPI_CPOL | SPI_CS_HIGH |\r\nSPI_LSB_FIRST | SPI_3WIRE;\r\nmaster->transfer_one_message = octeon_spi_transfer_one_message;\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(8);\r\nmaster->max_speed_hz = OCTEON_SPI_MAX_CLOCK_HZ;\r\nmaster->dev.of_node = pdev->dev.of_node;\r\npci_set_drvdata(pdev, master);\r\nret = devm_spi_register_master(dev, master);\r\nif (ret)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nclk_disable_unprepare(p->clk);\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic void thunderx_spi_remove(struct pci_dev *pdev)\r\n{\r\nstruct spi_master *master = pci_get_drvdata(pdev);\r\nstruct octeon_spi *p;\r\np = spi_master_get_devdata(master);\r\nif (!p)\r\nreturn;\r\nclk_disable_unprepare(p->clk);\r\nwriteq(0, p->register_base + OCTEON_SPI_CFG(p));\r\n}

static void divil_lbar_enable(void)\r\n{\r\nu32 hi, lo;\r\nint offset;\r\nfor (offset = DIVIL_LBAR_SMB; offset <= DIVIL_LBAR_PMS; offset++) {\r\n_rdmsr(DIVIL_MSR_REG(offset), &hi, &lo);\r\nhi |= 0x01;\r\n_wrmsr(DIVIL_MSR_REG(offset), hi, lo);\r\n}\r\n}\r\nstatic void divil_lbar_disable(void)\r\n{\r\nu32 hi, lo;\r\nint offset;\r\nfor (offset = DIVIL_LBAR_SMB; offset <= DIVIL_LBAR_PMS; offset++) {\r\n_rdmsr(DIVIL_MSR_REG(offset), &hi, &lo);\r\nhi &= ~0x01;\r\n_wrmsr(DIVIL_MSR_REG(offset), hi, lo);\r\n}\r\n}\r\nvoid pci_isa_write_bar(int n, u32 value)\r\n{\r\nu32 hi = 0, lo = value;\r\nif (value == PCI_BAR_RANGE_MASK) {\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nlo |= soft_bar_flag[n];\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else if (value & 0x01) {\r\nhi = 0x0000f001;\r\nlo &= bar_space_range[n];\r\n_wrmsr(divil_msr_reg[n], hi, lo);\r\nhi = ((value & 0x000ffffc) << 12) |\r\n((bar_space_len[n] - 4) << 12) | 0x01;\r\nlo = ((value & 0x000ffffc) << 12) | 0x01;\r\n_wrmsr(sb_msr_reg[n], hi, lo);\r\n}\r\n}\r\nu32 pci_isa_read_bar(int n)\r\n{\r\nu32 conf_data = 0;\r\nu32 hi, lo;\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nif (lo & soft_bar_flag[n]) {\r\nconf_data = bar_space_range[n] | PCI_BASE_ADDRESS_SPACE_IO;\r\nlo &= ~soft_bar_flag[n];\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else {\r\n_rdmsr(divil_msr_reg[n], &hi, &lo);\r\nconf_data = lo & bar_space_range[n];\r\nconf_data |= 0x01;\r\nconf_data &= ~0x02;\r\n}\r\nreturn conf_data;\r\n}\r\nvoid pci_isa_write_reg(int reg, u32 value)\r\n{\r\nu32 hi = 0, lo = value;\r\nu32 temp;\r\nswitch (reg) {\r\ncase PCI_COMMAND:\r\nif (value & PCI_COMMAND_IO)\r\ndivil_lbar_enable();\r\nelse\r\ndivil_lbar_disable();\r\nbreak;\r\ncase PCI_STATUS:\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\ntemp = lo & 0x0000ffff;\r\nif ((value & PCI_STATUS_SIG_TARGET_ABORT) &&\r\n(lo & SB_TAS_ERR_EN))\r\ntemp |= SB_TAS_ERR_FLAG;\r\nif ((value & PCI_STATUS_REC_TARGET_ABORT) &&\r\n(lo & SB_TAR_ERR_EN))\r\ntemp |= SB_TAR_ERR_FLAG;\r\nif ((value & PCI_STATUS_REC_MASTER_ABORT)\r\n&& (lo & SB_MAR_ERR_EN))\r\ntemp |= SB_MAR_ERR_FLAG;\r\nif ((value & PCI_STATUS_DETECTED_PARITY)\r\n&& (lo & SB_PARE_ERR_EN))\r\ntemp |= SB_PARE_ERR_FLAG;\r\nlo = temp;\r\n_wrmsr(SB_MSR_REG(SB_ERROR), hi, lo);\r\nbreak;\r\ncase PCI_CACHE_LINE_SIZE:\r\nvalue &= 0x0000ff00;\r\n_rdmsr(SB_MSR_REG(SB_CTRL), &hi, &lo);\r\nhi &= 0xffffff00;\r\nhi |= (value >> 8);\r\n_wrmsr(SB_MSR_REG(SB_CTRL), hi, lo);\r\nbreak;\r\ncase PCI_BAR0_REG:\r\npci_isa_write_bar(0, value);\r\nbreak;\r\ncase PCI_BAR1_REG:\r\npci_isa_write_bar(1, value);\r\nbreak;\r\ncase PCI_BAR2_REG:\r\npci_isa_write_bar(2, value);\r\nbreak;\r\ncase PCI_BAR3_REG:\r\npci_isa_write_bar(3, value);\r\nbreak;\r\ncase PCI_BAR4_REG:\r\npci_isa_write_bar(4, value);\r\nbreak;\r\ncase PCI_BAR5_REG:\r\npci_isa_write_bar(5, value);\r\nbreak;\r\ncase PCI_UART1_INT_REG:\r\n_rdmsr(DIVIL_MSR_REG(PIC_YSEL_HIGH), &hi, &lo);\r\nlo &= ~(0xf << 24);\r\nif (value)\r\nlo |= (CS5536_UART1_INTR << 24);\r\n_wrmsr(DIVIL_MSR_REG(PIC_YSEL_HIGH), hi, lo);\r\nbreak;\r\ncase PCI_UART2_INT_REG:\r\n_rdmsr(DIVIL_MSR_REG(PIC_YSEL_HIGH), &hi, &lo);\r\nlo &= ~(0xf << 28);\r\nif (value)\r\nlo |= (CS5536_UART2_INTR << 28);\r\n_wrmsr(DIVIL_MSR_REG(PIC_YSEL_HIGH), hi, lo);\r\nbreak;\r\ncase PCI_ISA_FIXUP_REG:\r\nif (value) {\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nlo |= 0x00000063;\r\n_wrmsr(SB_MSR_REG(SB_ERROR), hi, lo);\r\n}\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nu32 pci_isa_read_reg(int reg)\r\n{\r\nu32 conf_data = 0;\r\nu32 hi, lo;\r\nswitch (reg) {\r\ncase PCI_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_ISA_DEVICE_ID, CS5536_VENDOR_ID);\r\nbreak;\r\ncase PCI_COMMAND:\r\n_rdmsr(DIVIL_MSR_REG(DIVIL_LBAR_SMB), &hi, &lo);\r\nif (hi & 0x01)\r\nconf_data |= PCI_COMMAND_IO;\r\nbreak;\r\ncase PCI_STATUS:\r\nconf_data |= PCI_STATUS_66MHZ;\r\nconf_data |= PCI_STATUS_DEVSEL_MEDIUM;\r\nconf_data |= PCI_STATUS_FAST_BACK;\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nif (lo & SB_TAS_ERR_FLAG)\r\nconf_data |= PCI_STATUS_SIG_TARGET_ABORT;\r\nif (lo & SB_TAR_ERR_FLAG)\r\nconf_data |= PCI_STATUS_REC_TARGET_ABORT;\r\nif (lo & SB_MAR_ERR_FLAG)\r\nconf_data |= PCI_STATUS_REC_MASTER_ABORT;\r\nif (lo & SB_PARE_ERR_FLAG)\r\nconf_data |= PCI_STATUS_DETECTED_PARITY;\r\nbreak;\r\ncase PCI_CLASS_REVISION:\r\n_rdmsr(GLCP_MSR_REG(GLCP_CHIP_REV_ID), &hi, &lo);\r\nconf_data = lo & 0x000000ff;\r\nconf_data |= (CS5536_ISA_CLASS_CODE << 8);\r\nbreak;\r\ncase PCI_CACHE_LINE_SIZE:\r\n_rdmsr(SB_MSR_REG(SB_CTRL), &hi, &lo);\r\nhi &= 0x000000f8;\r\nconf_data = CFG_PCI_CACHE_LINE_SIZE(PCI_BRIDGE_HEADER_TYPE, hi);\r\nbreak;\r\ncase PCI_BAR0_REG:\r\nreturn pci_isa_read_bar(0);\r\nbreak;\r\ncase PCI_BAR1_REG:\r\nreturn pci_isa_read_bar(1);\r\nbreak;\r\ncase PCI_BAR2_REG:\r\nreturn pci_isa_read_bar(2);\r\nbreak;\r\ncase PCI_BAR3_REG:\r\nbreak;\r\ncase PCI_BAR4_REG:\r\nreturn pci_isa_read_bar(4);\r\nbreak;\r\ncase PCI_BAR5_REG:\r\nreturn pci_isa_read_bar(5);\r\nbreak;\r\ncase PCI_CARDBUS_CIS:\r\nconf_data = PCI_CARDBUS_CIS_POINTER;\r\nbreak;\r\ncase PCI_SUBSYSTEM_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_ISA_SUB_ID, CS5536_SUB_VENDOR_ID);\r\nbreak;\r\ncase PCI_ROM_ADDRESS:\r\nconf_data = PCI_EXPANSION_ROM_BAR;\r\nbreak;\r\ncase PCI_CAPABILITY_LIST:\r\nconf_data = PCI_CAPLIST_POINTER;\r\nbreak;\r\ncase PCI_INTERRUPT_LINE:\r\nconf_data = CFG_PCI_INTERRUPT_LINE(0x00, 0x00);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn conf_data;\r\n}\r\nstatic void cs5536_isa_mmio_always_on(struct pci_dev *dev)\r\n{\r\ndev->mmio_always_on = 1;\r\n}

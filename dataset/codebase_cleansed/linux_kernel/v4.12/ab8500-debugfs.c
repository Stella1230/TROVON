static irqreturn_t ab8500_debug_handler(int irq, void *data)\r\n{\r\nchar buf[16];\r\nstruct kobject *kobj = (struct kobject *)data;\r\nunsigned int irq_abb = irq - irq_first;\r\nif (irq_abb < num_irqs)\r\nirq_count[irq_abb]++;\r\nsprintf(buf, "%d", irq);\r\nsysfs_notify(kobj, NULL, buf);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ab8500_registers_print(struct device *dev, u32 bank,\r\nstruct seq_file *s)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < debug_ranges[bank].num_ranges; i++) {\r\nu32 reg;\r\nfor (reg = debug_ranges[bank].range[i].first;\r\nreg <= debug_ranges[bank].range[i].last;\r\nreg++) {\r\nu8 value;\r\nint err;\r\nerr = abx500_get_register_interruptible(dev,\r\n(u8)bank, (u8)reg, &value);\r\nif (err < 0) {\r\ndev_err(dev, "ab->read fail %d\n", err);\r\nreturn err;\r\n}\r\nif (s) {\r\nseq_printf(s, " [0x%02X/0x%02X]: 0x%02X\n",\r\nbank, reg, value);\r\nif (seq_has_overflowed(s))\r\nreturn 0;\r\n} else {\r\ndev_info(dev, " [0x%02X/0x%02X]: 0x%02X\n",\r\nbank, reg, value);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_print_bank_registers(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nu32 bank = debug_bank;\r\nseq_puts(s, AB8500_NAME_STRING " register values:\n");\r\nseq_printf(s, " bank 0x%02X:\n", bank);\r\nreturn ab8500_registers_print(dev, bank, s);\r\n}\r\nstatic int ab8500_registers_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_print_bank_registers, inode->i_private);\r\n}\r\nstatic int ab8500_print_all_banks(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nunsigned int i;\r\nseq_puts(s, AB8500_NAME_STRING " register values:\n");\r\nfor (i = 0; i < AB8500_NUM_BANKS; i++) {\r\nint err;\r\nseq_printf(s, " bank 0x%02X:\n", i);\r\nerr = ab8500_registers_print(dev, i, s);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nvoid ab8500_dump_all_banks(struct device *dev)\r\n{\r\nunsigned int i;\r\ndev_info(dev, "ab8500 register values:\n");\r\nfor (i = 1; i < AB8500_NUM_BANKS; i++) {\r\ndev_info(dev, " bank 0x%02X:\n", i);\r\nab8500_registers_print(dev, i, NULL);\r\n}\r\n}\r\nstatic int ab8500_all_banks_open(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *s;\r\nint err;\r\nerr = single_open(file, ab8500_print_all_banks, inode->i_private);\r\nif (!err) {\r\ns = (struct seq_file *)file->private_data;\r\ns->size = (PAGE_SIZE * 2);\r\ns->buf = kmalloc(s->size, GFP_KERNEL);\r\nif (!s->buf) {\r\nsingle_release(inode, file);\r\nerr = -ENOMEM;\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int ab8500_bank_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "0x%02X\n", debug_bank);\r\nreturn 0;\r\n}\r\nstatic int ab8500_bank_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_bank_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_bank_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_bank;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_bank);\r\nif (err)\r\nreturn err;\r\nif (user_bank >= AB8500_NUM_BANKS) {\r\ndev_err(dev, "debugfs error input > number of banks\n");\r\nreturn -EINVAL;\r\n}\r\ndebug_bank = user_bank;\r\nreturn count;\r\n}\r\nstatic int ab8500_address_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "0x%02X\n", debug_address);\r\nreturn 0;\r\n}\r\nstatic int ab8500_address_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_address_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_address_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_address;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_address);\r\nif (err)\r\nreturn err;\r\nif (user_address > 0xff) {\r\ndev_err(dev, "debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\ndebug_address = user_address;\r\nreturn count;\r\n}\r\nstatic int ab8500_val_print(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nint ret;\r\nu8 regvalue;\r\nret = abx500_get_register_interruptible(dev,\r\n(u8)debug_bank, (u8)debug_address, &regvalue);\r\nif (ret < 0) {\r\ndev_err(dev, "abx500_get_reg fail %d, %d\n",\r\nret, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nseq_printf(s, "0x%02X\n", regvalue);\r\nreturn 0;\r\n}\r\nstatic int ab8500_val_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_val_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_val_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_val;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_val);\r\nif (err)\r\nreturn err;\r\nif (user_val > 0xff) {\r\ndev_err(dev, "debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\nerr = abx500_set_register_interruptible(dev,\r\n(u8)debug_bank, debug_address, (u8)user_val);\r\nif (err < 0) {\r\npr_err("abx500_set_reg failed %d, %d", err, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nvoid ab8500_debug_register_interrupt(int line)\r\n{\r\nif (line < num_interrupt_lines)\r\nnum_interrupts[line]++;\r\n}\r\nstatic int ab8500_interrupts_print(struct seq_file *s, void *p)\r\n{\r\nint line;\r\nseq_puts(s, "name: number: number of: wake:\n");\r\nfor (line = 0; line < num_interrupt_lines; line++) {\r\nstruct irq_desc *desc = irq_to_desc(line + irq_first);\r\nseq_printf(s, "%3i: %6i %4i",\r\nline,\r\nnum_interrupts[line],\r\nnum_wake_interrupts[line]);\r\nif (desc && desc->name)\r\nseq_printf(s, "-%-8s", desc->name);\r\nif (desc && desc->action) {\r\nstruct irqaction *action = desc->action;\r\nseq_printf(s, " %s", action->name);\r\nwhile ((action = action->next) != NULL)\r\nseq_printf(s, ", %s", action->name);\r\n}\r\nseq_putc(s, '\n');\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_interrupts_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_interrupts_print, inode->i_private);\r\n}\r\nstatic int ab8500_hwreg_print(struct seq_file *s, void *d)\r\n{\r\nstruct device *dev = s->private;\r\nint ret;\r\nu8 regvalue;\r\nret = abx500_get_register_interruptible(dev,\r\n(u8)hwreg_cfg.bank, (u8)hwreg_cfg.addr, &regvalue);\r\nif (ret < 0) {\r\ndev_err(dev, "abx500_get_reg fail %d, %d\n",\r\nret, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nif (hwreg_cfg.shift >= 0)\r\nregvalue >>= hwreg_cfg.shift;\r\nelse\r\nregvalue <<= -hwreg_cfg.shift;\r\nregvalue &= hwreg_cfg.mask;\r\nif (REG_FMT_DEC(&hwreg_cfg))\r\nseq_printf(s, "%d\n", regvalue);\r\nelse\r\nseq_printf(s, "0x%02X\n", regvalue);\r\nreturn 0;\r\n}\r\nstatic int ab8500_hwreg_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_hwreg_print, inode->i_private);\r\n}\r\nstatic int ab8500_print_modem_registers(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nstruct ab8500 *ab8500;\r\nint err;\r\nu8 value;\r\nu8 orig_value;\r\nu32 bank = AB8500_REGU_CTRL2;\r\nu32 last_sim_reg = AB8500_LAST_SIM_REG;\r\nu32 reg;\r\nab8500 = dev_get_drvdata(dev->parent);\r\ndev_warn(dev, "WARNING! This operation can interfer with modem side\n"\r\n"and should only be done with care\n");\r\nerr = abx500_get_register_interruptible(dev,\r\nAB8500_REGU_CTRL1, AB8500_SUPPLY_CONTROL_REG, &orig_value);\r\nif (err < 0) {\r\ndev_err(dev, "ab->read fail %d\n", err);\r\nreturn err;\r\n}\r\nerr = abx500_set_register_interruptible(dev,\r\nAB8500_REGU_CTRL1, AB8500_SUPPLY_CONTROL_REG,\r\nAB8500_SUPPLY_CONTROL_CONFIG_1);\r\nif (err < 0) {\r\ndev_err(dev, "ab->write fail %d\n", err);\r\nreturn err;\r\n}\r\nseq_printf(s, " bank 0x%02X:\n", bank);\r\nif (is_ab9540(ab8500) || is_ab8505(ab8500))\r\nlast_sim_reg = AB8505_LAST_SIM_REG;\r\nfor (reg = AB8500_FIRST_SIM_REG; reg <= last_sim_reg; reg++) {\r\nerr = abx500_get_register_interruptible(dev,\r\nbank, reg, &value);\r\nif (err < 0) {\r\ndev_err(dev, "ab->read fail %d\n", err);\r\nreturn err;\r\n}\r\nseq_printf(s, " [0x%02X/0x%02X]: 0x%02X\n", bank, reg, value);\r\n}\r\nerr = abx500_set_register_interruptible(dev,\r\nAB8500_REGU_CTRL1, AB8500_SUPPLY_CONTROL_REG, orig_value);\r\nif (err < 0) {\r\ndev_err(dev, "ab->write fail %d\n", err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_modem_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_print_modem_registers,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_bat_ctrl_print(struct seq_file *s, void *p)\r\n{\r\nint bat_ctrl_raw;\r\nint bat_ctrl_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nbat_ctrl_raw = ab8500_gpadc_read_raw(gpadc, BAT_CTRL,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nbat_ctrl_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nBAT_CTRL, bat_ctrl_raw);\r\nseq_printf(s, "%d,0x%X\n", bat_ctrl_convert, bat_ctrl_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_bat_ctrl_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_bat_ctrl_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_btemp_ball_print(struct seq_file *s, void *p)\r\n{\r\nint btemp_ball_raw;\r\nint btemp_ball_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nbtemp_ball_raw = ab8500_gpadc_read_raw(gpadc, BTEMP_BALL,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nbtemp_ball_convert = ab8500_gpadc_ad_to_voltage(gpadc, BTEMP_BALL,\r\nbtemp_ball_raw);\r\nseq_printf(s, "%d,0x%X\n", btemp_ball_convert, btemp_ball_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_btemp_ball_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_btemp_ball_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_main_charger_v_print(struct seq_file *s, void *p)\r\n{\r\nint main_charger_v_raw;\r\nint main_charger_v_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nmain_charger_v_raw = ab8500_gpadc_read_raw(gpadc, MAIN_CHARGER_V,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nmain_charger_v_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nMAIN_CHARGER_V, main_charger_v_raw);\r\nseq_printf(s, "%d,0x%X\n", main_charger_v_convert, main_charger_v_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_main_charger_v_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_main_charger_v_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_acc_detect1_print(struct seq_file *s, void *p)\r\n{\r\nint acc_detect1_raw;\r\nint acc_detect1_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nacc_detect1_raw = ab8500_gpadc_read_raw(gpadc, ACC_DETECT1,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nacc_detect1_convert = ab8500_gpadc_ad_to_voltage(gpadc, ACC_DETECT1,\r\nacc_detect1_raw);\r\nseq_printf(s, "%d,0x%X\n", acc_detect1_convert, acc_detect1_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_acc_detect1_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_acc_detect1_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_acc_detect2_print(struct seq_file *s, void *p)\r\n{\r\nint acc_detect2_raw;\r\nint acc_detect2_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nacc_detect2_raw = ab8500_gpadc_read_raw(gpadc, ACC_DETECT2,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nacc_detect2_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nACC_DETECT2, acc_detect2_raw);\r\nseq_printf(s, "%d,0x%X\n", acc_detect2_convert, acc_detect2_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_acc_detect2_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_acc_detect2_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_aux1_print(struct seq_file *s, void *p)\r\n{\r\nint aux1_raw;\r\nint aux1_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\naux1_raw = ab8500_gpadc_read_raw(gpadc, ADC_AUX1,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\naux1_convert = ab8500_gpadc_ad_to_voltage(gpadc, ADC_AUX1,\r\naux1_raw);\r\nseq_printf(s, "%d,0x%X\n", aux1_convert, aux1_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_aux1_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_aux1_print, inode->i_private);\r\n}\r\nstatic int ab8500_gpadc_aux2_print(struct seq_file *s, void *p)\r\n{\r\nint aux2_raw;\r\nint aux2_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\naux2_raw = ab8500_gpadc_read_raw(gpadc, ADC_AUX2,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\naux2_convert = ab8500_gpadc_ad_to_voltage(gpadc, ADC_AUX2,\r\naux2_raw);\r\nseq_printf(s, "%d,0x%X\n", aux2_convert, aux2_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_aux2_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_aux2_print, inode->i_private);\r\n}\r\nstatic int ab8500_gpadc_main_bat_v_print(struct seq_file *s, void *p)\r\n{\r\nint main_bat_v_raw;\r\nint main_bat_v_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nmain_bat_v_raw = ab8500_gpadc_read_raw(gpadc, MAIN_BAT_V,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nmain_bat_v_convert = ab8500_gpadc_ad_to_voltage(gpadc, MAIN_BAT_V,\r\nmain_bat_v_raw);\r\nseq_printf(s, "%d,0x%X\n", main_bat_v_convert, main_bat_v_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_main_bat_v_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_main_bat_v_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_vbus_v_print(struct seq_file *s, void *p)\r\n{\r\nint vbus_v_raw;\r\nint vbus_v_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nvbus_v_raw = ab8500_gpadc_read_raw(gpadc, VBUS_V,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nvbus_v_convert = ab8500_gpadc_ad_to_voltage(gpadc, VBUS_V,\r\nvbus_v_raw);\r\nseq_printf(s, "%d,0x%X\n", vbus_v_convert, vbus_v_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_vbus_v_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_vbus_v_print, inode->i_private);\r\n}\r\nstatic int ab8500_gpadc_main_charger_c_print(struct seq_file *s, void *p)\r\n{\r\nint main_charger_c_raw;\r\nint main_charger_c_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nmain_charger_c_raw = ab8500_gpadc_read_raw(gpadc, MAIN_CHARGER_C,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nmain_charger_c_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nMAIN_CHARGER_C, main_charger_c_raw);\r\nseq_printf(s, "%d,0x%X\n", main_charger_c_convert, main_charger_c_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_main_charger_c_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_main_charger_c_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_usb_charger_c_print(struct seq_file *s, void *p)\r\n{\r\nint usb_charger_c_raw;\r\nint usb_charger_c_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nusb_charger_c_raw = ab8500_gpadc_read_raw(gpadc, USB_CHARGER_C,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nusb_charger_c_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nUSB_CHARGER_C, usb_charger_c_raw);\r\nseq_printf(s, "%d,0x%X\n", usb_charger_c_convert, usb_charger_c_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_usb_charger_c_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_usb_charger_c_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_bk_bat_v_print(struct seq_file *s, void *p)\r\n{\r\nint bk_bat_v_raw;\r\nint bk_bat_v_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nbk_bat_v_raw = ab8500_gpadc_read_raw(gpadc, BK_BAT_V,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nbk_bat_v_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nBK_BAT_V, bk_bat_v_raw);\r\nseq_printf(s, "%d,0x%X\n", bk_bat_v_convert, bk_bat_v_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_bk_bat_v_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_bk_bat_v_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_die_temp_print(struct seq_file *s, void *p)\r\n{\r\nint die_temp_raw;\r\nint die_temp_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\ndie_temp_raw = ab8500_gpadc_read_raw(gpadc, DIE_TEMP,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\ndie_temp_convert = ab8500_gpadc_ad_to_voltage(gpadc, DIE_TEMP,\r\ndie_temp_raw);\r\nseq_printf(s, "%d,0x%X\n", die_temp_convert, die_temp_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_die_temp_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_die_temp_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8500_gpadc_usb_id_print(struct seq_file *s, void *p)\r\n{\r\nint usb_id_raw;\r\nint usb_id_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nusb_id_raw = ab8500_gpadc_read_raw(gpadc, USB_ID,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nusb_id_convert = ab8500_gpadc_ad_to_voltage(gpadc, USB_ID,\r\nusb_id_raw);\r\nseq_printf(s, "%d,0x%X\n", usb_id_convert, usb_id_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_usb_id_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_usb_id_print, inode->i_private);\r\n}\r\nstatic int ab8540_gpadc_xtal_temp_print(struct seq_file *s, void *p)\r\n{\r\nint xtal_temp_raw;\r\nint xtal_temp_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nxtal_temp_raw = ab8500_gpadc_read_raw(gpadc, XTAL_TEMP,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nxtal_temp_convert = ab8500_gpadc_ad_to_voltage(gpadc, XTAL_TEMP,\r\nxtal_temp_raw);\r\nseq_printf(s, "%d,0x%X\n", xtal_temp_convert, xtal_temp_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_xtal_temp_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_xtal_temp_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_vbat_true_meas_print(struct seq_file *s, void *p)\r\n{\r\nint vbat_true_meas_raw;\r\nint vbat_true_meas_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nvbat_true_meas_raw = ab8500_gpadc_read_raw(gpadc, VBAT_TRUE_MEAS,\r\navg_sample, trig_edge, trig_timer, conv_type);\r\nvbat_true_meas_convert =\r\nab8500_gpadc_ad_to_voltage(gpadc, VBAT_TRUE_MEAS,\r\nvbat_true_meas_raw);\r\nseq_printf(s, "%d,0x%X\n", vbat_true_meas_convert, vbat_true_meas_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_vbat_true_meas_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_vbat_true_meas_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_bat_ctrl_and_ibat_print(struct seq_file *s, void *p)\r\n{\r\nint bat_ctrl_raw;\r\nint bat_ctrl_convert;\r\nint ibat_raw;\r\nint ibat_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nbat_ctrl_raw = ab8500_gpadc_double_read_raw(gpadc, BAT_CTRL_AND_IBAT,\r\navg_sample, trig_edge, trig_timer, conv_type, &ibat_raw);\r\nbat_ctrl_convert = ab8500_gpadc_ad_to_voltage(gpadc, BAT_CTRL,\r\nbat_ctrl_raw);\r\nibat_convert = ab8500_gpadc_ad_to_voltage(gpadc, IBAT_VIRTUAL_CHANNEL,\r\nibat_raw);\r\nseq_printf(s,\r\n"%d,0x%X\n"\r\n"%d,0x%X\n",\r\nbat_ctrl_convert, bat_ctrl_raw,\r\nibat_convert, ibat_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_bat_ctrl_and_ibat_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_bat_ctrl_and_ibat_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_vbat_meas_and_ibat_print(struct seq_file *s, void *p)\r\n{\r\nint vbat_meas_raw;\r\nint vbat_meas_convert;\r\nint ibat_raw;\r\nint ibat_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nvbat_meas_raw = ab8500_gpadc_double_read_raw(gpadc, VBAT_MEAS_AND_IBAT,\r\navg_sample, trig_edge, trig_timer, conv_type, &ibat_raw);\r\nvbat_meas_convert = ab8500_gpadc_ad_to_voltage(gpadc, MAIN_BAT_V,\r\nvbat_meas_raw);\r\nibat_convert = ab8500_gpadc_ad_to_voltage(gpadc, IBAT_VIRTUAL_CHANNEL,\r\nibat_raw);\r\nseq_printf(s,\r\n"%d,0x%X\n"\r\n"%d,0x%X\n",\r\nvbat_meas_convert, vbat_meas_raw,\r\nibat_convert, ibat_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_vbat_meas_and_ibat_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_vbat_meas_and_ibat_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_vbat_true_meas_and_ibat_print(struct seq_file *s,\r\nvoid *p)\r\n{\r\nint vbat_true_meas_raw;\r\nint vbat_true_meas_convert;\r\nint ibat_raw;\r\nint ibat_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nvbat_true_meas_raw = ab8500_gpadc_double_read_raw(gpadc,\r\nVBAT_TRUE_MEAS_AND_IBAT, avg_sample, trig_edge,\r\ntrig_timer, conv_type, &ibat_raw);\r\nvbat_true_meas_convert = ab8500_gpadc_ad_to_voltage(gpadc,\r\nVBAT_TRUE_MEAS, vbat_true_meas_raw);\r\nibat_convert = ab8500_gpadc_ad_to_voltage(gpadc, IBAT_VIRTUAL_CHANNEL,\r\nibat_raw);\r\nseq_printf(s,\r\n"%d,0x%X\n"\r\n"%d,0x%X\n",\r\nvbat_true_meas_convert, vbat_true_meas_raw,\r\nibat_convert, ibat_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_vbat_true_meas_and_ibat_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_vbat_true_meas_and_ibat_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_bat_temp_and_ibat_print(struct seq_file *s, void *p)\r\n{\r\nint bat_temp_raw;\r\nint bat_temp_convert;\r\nint ibat_raw;\r\nint ibat_convert;\r\nstruct ab8500_gpadc *gpadc;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nbat_temp_raw = ab8500_gpadc_double_read_raw(gpadc, BAT_TEMP_AND_IBAT,\r\navg_sample, trig_edge, trig_timer, conv_type, &ibat_raw);\r\nbat_temp_convert = ab8500_gpadc_ad_to_voltage(gpadc, BTEMP_BALL,\r\nbat_temp_raw);\r\nibat_convert = ab8500_gpadc_ad_to_voltage(gpadc, IBAT_VIRTUAL_CHANNEL,\r\nibat_raw);\r\nseq_printf(s,\r\n"%d,0x%X\n"\r\n"%d,0x%X\n",\r\nbat_temp_convert, bat_temp_raw,\r\nibat_convert, ibat_raw);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_bat_temp_and_ibat_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_bat_temp_and_ibat_print,\r\ninode->i_private);\r\n}\r\nstatic int ab8540_gpadc_otp_cal_print(struct seq_file *s, void *p)\r\n{\r\nstruct ab8500_gpadc *gpadc;\r\nu16 vmain_l, vmain_h, btemp_l, btemp_h;\r\nu16 vbat_l, vbat_h, ibat_l, ibat_h;\r\ngpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nab8540_gpadc_get_otp(gpadc, &vmain_l, &vmain_h, &btemp_l, &btemp_h,\r\n&vbat_l, &vbat_h, &ibat_l, &ibat_h);\r\nseq_printf(s,\r\n"VMAIN_L:0x%X\n"\r\n"VMAIN_H:0x%X\n"\r\n"BTEMP_L:0x%X\n"\r\n"BTEMP_H:0x%X\n"\r\n"VBAT_L:0x%X\n"\r\n"VBAT_H:0x%X\n"\r\n"IBAT_L:0x%X\n"\r\n"IBAT_H:0x%X\n",\r\nvmain_l, vmain_h, btemp_l, btemp_h,\r\nvbat_l, vbat_h, ibat_l, ibat_h);\r\nreturn 0;\r\n}\r\nstatic int ab8540_gpadc_otp_cal_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8540_gpadc_otp_cal_print, inode->i_private);\r\n}\r\nstatic int ab8500_gpadc_avg_sample_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "%d\n", avg_sample);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_avg_sample_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_avg_sample_print,\r\ninode->i_private);\r\n}\r\nstatic ssize_t ab8500_gpadc_avg_sample_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_avg_sample;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_avg_sample);\r\nif (err)\r\nreturn err;\r\nif ((user_avg_sample == SAMPLE_1) || (user_avg_sample == SAMPLE_4)\r\n|| (user_avg_sample == SAMPLE_8)\r\n|| (user_avg_sample == SAMPLE_16)) {\r\navg_sample = (u8) user_avg_sample;\r\n} else {\r\ndev_err(dev,\r\n"debugfs err input: should be egal to 1, 4, 8 or 16\n");\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic int ab8500_gpadc_trig_edge_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "%d\n", trig_edge);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_trig_edge_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_trig_edge_print,\r\ninode->i_private);\r\n}\r\nstatic ssize_t ab8500_gpadc_trig_edge_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_trig_edge;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_trig_edge);\r\nif (err)\r\nreturn err;\r\nif ((user_trig_edge == RISING_EDGE)\r\n|| (user_trig_edge == FALLING_EDGE)) {\r\ntrig_edge = (u8) user_trig_edge;\r\n} else {\r\ndev_err(dev, "Wrong input:\n"\r\n"Enter 0. Rising edge\n"\r\n"Enter 1. Falling edge\n");\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic int ab8500_gpadc_trig_timer_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "%d\n", trig_timer);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_trig_timer_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_trig_timer_print,\r\ninode->i_private);\r\n}\r\nstatic ssize_t ab8500_gpadc_trig_timer_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_trig_timer;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_trig_timer);\r\nif (err)\r\nreturn err;\r\nif (user_trig_timer & ~0xFF) {\r\ndev_err(dev,\r\n"debugfs error input: should be between 0 to 255\n");\r\nreturn -EINVAL;\r\n}\r\ntrig_timer = (u8) user_trig_timer;\r\nreturn count;\r\n}\r\nstatic int ab8500_gpadc_conv_type_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "%d\n", conv_type);\r\nreturn 0;\r\n}\r\nstatic int ab8500_gpadc_conv_type_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_gpadc_conv_type_print,\r\ninode->i_private);\r\n}\r\nstatic ssize_t ab8500_gpadc_conv_type_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_conv_type;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_conv_type);\r\nif (err)\r\nreturn err;\r\nif ((user_conv_type == ADC_SW)\r\n|| (user_conv_type == ADC_HW)) {\r\nconv_type = (u8) user_conv_type;\r\n} else {\r\ndev_err(dev, "Wrong input:\n"\r\n"Enter 0. ADC SW conversion\n"\r\n"Enter 1. ADC HW conversion\n");\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic int strval_len(char *b)\r\n{\r\nchar *s = b;\r\nif ((*s == '0') && ((*(s+1) == 'x') || (*(s+1) == 'X'))) {\r\ns += 2;\r\nfor (; *s && (*s != ' ') && (*s != '\n'); s++) {\r\nif (!isxdigit(*s))\r\nreturn 0;\r\n}\r\n} else {\r\nif (*s == '-')\r\ns++;\r\nfor (; *s && (*s != ' ') && (*s != '\n'); s++) {\r\nif (!isdigit(*s))\r\nreturn 0;\r\n}\r\n}\r\nreturn (int) (s-b);\r\n}\r\nstatic ssize_t hwreg_common_write(char *b, struct hwreg_cfg *cfg,\r\nstruct device *dev)\r\n{\r\nuint write, val = 0;\r\nu8 regvalue;\r\nint ret;\r\nstruct hwreg_cfg loc = {\r\n.bank = 0,\r\n.addr = 0,\r\n.fmt = 0,\r\n.mask = 0xFFFFFFFF,\r\n.shift = 0,\r\n};\r\nif (!strncmp(b, "read ", 5)) {\r\nwrite = 0;\r\nb += 5;\r\n} else if (!strncmp(b, "write ", 6)) {\r\nwrite = 1;\r\nb += 6;\r\n} else\r\nreturn -EINVAL;\r\nwhile ((*b == ' ') || (*b == '-')) {\r\nif (*(b-1) != ' ') {\r\nb++;\r\ncontinue;\r\n}\r\nif ((!strncmp(b, "-d ", 3)) ||\r\n(!strncmp(b, "-dec ", 5))) {\r\nb += (*(b+2) == ' ') ? 3 : 5;\r\nloc.fmt |= (1<<0);\r\n} else if ((!strncmp(b, "-h ", 3)) ||\r\n(!strncmp(b, "-hex ", 5))) {\r\nb += (*(b+2) == ' ') ? 3 : 5;\r\nloc.fmt &= ~(1<<0);\r\n} else if ((!strncmp(b, "-m ", 3)) ||\r\n(!strncmp(b, "-mask ", 6))) {\r\nb += (*(b+2) == ' ') ? 3 : 6;\r\nif (strval_len(b) == 0)\r\nreturn -EINVAL;\r\nret = kstrtoul(b, 0, &loc.mask);\r\nif (ret)\r\nreturn ret;\r\n} else if ((!strncmp(b, "-s ", 3)) ||\r\n(!strncmp(b, "-shift ", 7))) {\r\nb += (*(b+2) == ' ') ? 3 : 7;\r\nif (strval_len(b) == 0)\r\nreturn -EINVAL;\r\nret = kstrtol(b, 0, &loc.shift);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (strval_len(b) == 0)\r\nreturn -EINVAL;\r\nret = kstrtouint(b, 0, &loc.bank);\r\nif (ret)\r\nreturn ret;\r\nwhile (*b == ' ')\r\nb++;\r\nif (strval_len(b) == 0)\r\nreturn -EINVAL;\r\nret = kstrtoul(b, 0, &loc.addr);\r\nif (ret)\r\nreturn ret;\r\nif (write) {\r\nwhile (*b == ' ')\r\nb++;\r\nif (strval_len(b) == 0)\r\nreturn -EINVAL;\r\nret = kstrtouint(b, 0, &val);\r\nif (ret)\r\nreturn ret;\r\n}\r\n*cfg = loc;\r\n#ifdef ABB_HWREG_DEBUG\r\npr_warn("HWREG request: %s, %s,\n", (write) ? "write" : "read",\r\nREG_FMT_DEC(cfg) ? "decimal" : "hexa");\r\npr_warn(" addr=0x%08X, mask=0x%X, shift=%d" "value=0x%X\n",\r\ncfg->addr, cfg->mask, cfg->shift, val);\r\n#endif\r\nif (!write)\r\nreturn 0;\r\nret = abx500_get_register_interruptible(dev,\r\n(u8)cfg->bank, (u8)cfg->addr, &regvalue);\r\nif (ret < 0) {\r\ndev_err(dev, "abx500_get_reg fail %d, %d\n",\r\nret, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nif (cfg->shift >= 0) {\r\nregvalue &= ~(cfg->mask << (cfg->shift));\r\nval = (val & cfg->mask) << (cfg->shift);\r\n} else {\r\nregvalue &= ~(cfg->mask >> (-cfg->shift));\r\nval = (val & cfg->mask) >> (-cfg->shift);\r\n}\r\nval = val | regvalue;\r\nret = abx500_set_register_interruptible(dev,\r\n(u8)cfg->bank, (u8)cfg->addr, (u8)val);\r\nif (ret < 0) {\r\npr_err("abx500_set_reg failed %d, %d", ret, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ab8500_hwreg_write(struct file *file,\r\nconst char __user *user_buf, size_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nchar buf[128];\r\nint buf_size, ret;\r\nbuf_size = min(count, (sizeof(buf)-1));\r\nif (copy_from_user(buf, user_buf, buf_size))\r\nreturn -EFAULT;\r\nbuf[buf_size] = 0;\r\nret = hwreg_common_write(buf, &hwreg_cfg, dev);\r\nreturn (ret) ? ret : buf_size;\r\n}\r\nstatic int ab8500_subscribe_unsubscribe_print(struct seq_file *s, void *p)\r\n{\r\nseq_printf(s, "%d\n", irq_first);\r\nreturn 0;\r\n}\r\nstatic int ab8500_subscribe_unsubscribe_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nreturn single_open(file, ab8500_subscribe_unsubscribe_print,\r\ninode->i_private);\r\n}\r\nstatic ssize_t show_irq(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long name;\r\nunsigned int irq_index;\r\nint err;\r\nerr = kstrtoul(attr->attr.name, 0, &name);\r\nif (err)\r\nreturn err;\r\nirq_index = name - irq_first;\r\nif (irq_index >= num_irqs)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%u\n", irq_count[irq_index]);\r\n}\r\nstatic ssize_t ab8500_subscribe_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_val;\r\nint err;\r\nunsigned int irq_index;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_val);\r\nif (err)\r\nreturn err;\r\nif (user_val < irq_first) {\r\ndev_err(dev, "debugfs error input < %d\n", irq_first);\r\nreturn -EINVAL;\r\n}\r\nif (user_val > irq_last) {\r\ndev_err(dev, "debugfs error input > %d\n", irq_last);\r\nreturn -EINVAL;\r\n}\r\nirq_index = user_val - irq_first;\r\nif (irq_index >= num_irqs)\r\nreturn -EINVAL;\r\ndev_attr[irq_index] = kmalloc(sizeof(struct device_attribute),\r\nGFP_KERNEL);\r\nif (!dev_attr[irq_index])\r\nreturn -ENOMEM;\r\nevent_name[irq_index] = kmalloc(count, GFP_KERNEL);\r\nif (!event_name[irq_index])\r\nreturn -ENOMEM;\r\nsprintf(event_name[irq_index], "%lu", user_val);\r\ndev_attr[irq_index]->show = show_irq;\r\ndev_attr[irq_index]->store = NULL;\r\ndev_attr[irq_index]->attr.name = event_name[irq_index];\r\ndev_attr[irq_index]->attr.mode = S_IRUGO;\r\nerr = sysfs_create_file(&dev->kobj, &dev_attr[irq_index]->attr);\r\nif (err < 0) {\r\npr_info("sysfs_create_file failed %d\n", err);\r\nreturn err;\r\n}\r\nerr = request_threaded_irq(user_val, NULL, ab8500_debug_handler,\r\nIRQF_SHARED | IRQF_NO_SUSPEND | IRQF_ONESHOT,\r\n"ab8500-debug", &dev->kobj);\r\nif (err < 0) {\r\npr_info("request_threaded_irq failed %d, %lu\n",\r\nerr, user_val);\r\nsysfs_remove_file(&dev->kobj, &dev_attr[irq_index]->attr);\r\nreturn err;\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t ab8500_unsubscribe_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_val;\r\nint err;\r\nunsigned int irq_index;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_val);\r\nif (err)\r\nreturn err;\r\nif (user_val < irq_first) {\r\ndev_err(dev, "debugfs error input < %d\n", irq_first);\r\nreturn -EINVAL;\r\n}\r\nif (user_val > irq_last) {\r\ndev_err(dev, "debugfs error input > %d\n", irq_last);\r\nreturn -EINVAL;\r\n}\r\nirq_index = user_val - irq_first;\r\nif (irq_index >= num_irqs)\r\nreturn -EINVAL;\r\nirq_count[irq_index] = 0;\r\nif (dev_attr[irq_index])\r\nsysfs_remove_file(&dev->kobj, &dev_attr[irq_index]->attr);\r\nfree_irq(user_val, &dev->kobj);\r\nkfree(event_name[irq_index]);\r\nkfree(dev_attr[irq_index]);\r\nreturn count;\r\n}\r\nstatic int ab8500_debug_probe(struct platform_device *plf)\r\n{\r\nstruct dentry *file;\r\nstruct ab8500 *ab8500;\r\nstruct resource *res;\r\ndebug_bank = AB8500_MISC;\r\ndebug_address = AB8500_REV_REG & 0x00FF;\r\nab8500 = dev_get_drvdata(plf->dev.parent);\r\nnum_irqs = ab8500->mask_size;\r\nirq_count = devm_kzalloc(&plf->dev,\r\nsizeof(*irq_count)*num_irqs, GFP_KERNEL);\r\nif (!irq_count)\r\nreturn -ENOMEM;\r\ndev_attr = devm_kzalloc(&plf->dev,\r\nsizeof(*dev_attr)*num_irqs, GFP_KERNEL);\r\nif (!dev_attr)\r\nreturn -ENOMEM;\r\nevent_name = devm_kzalloc(&plf->dev,\r\nsizeof(*event_name)*num_irqs, GFP_KERNEL);\r\nif (!event_name)\r\nreturn -ENOMEM;\r\nres = platform_get_resource_byname(plf, 0, "IRQ_AB8500");\r\nif (!res) {\r\ndev_err(&plf->dev, "AB8500 irq not found, err %d\n", irq_first);\r\nreturn -ENXIO;\r\n}\r\nirq_ab8500 = res->start;\r\nirq_first = platform_get_irq_byname(plf, "IRQ_FIRST");\r\nif (irq_first < 0) {\r\ndev_err(&plf->dev, "First irq not found, err %d\n", irq_first);\r\nreturn irq_first;\r\n}\r\nirq_last = platform_get_irq_byname(plf, "IRQ_LAST");\r\nif (irq_last < 0) {\r\ndev_err(&plf->dev, "Last irq not found, err %d\n", irq_last);\r\nreturn irq_last;\r\n}\r\nab8500_dir = debugfs_create_dir(AB8500_NAME_STRING, NULL);\r\nif (!ab8500_dir)\r\ngoto err;\r\nab8500_gpadc_dir = debugfs_create_dir(AB8500_ADC_NAME_STRING,\r\nab8500_dir);\r\nif (!ab8500_gpadc_dir)\r\ngoto err;\r\nfile = debugfs_create_file("all-bank-registers", S_IRUGO, ab8500_dir,\r\n&plf->dev, &ab8500_registers_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("all-banks", S_IRUGO, ab8500_dir,\r\n&plf->dev, &ab8500_all_banks_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("register-bank",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_dir, &plf->dev, &ab8500_bank_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("register-address",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_dir, &plf->dev, &ab8500_address_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("register-value",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_dir, &plf->dev, &ab8500_val_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("irq-subscribe",\r\n(S_IRUGO | S_IWUSR | S_IWGRP), ab8500_dir,\r\n&plf->dev, &ab8500_subscribe_fops);\r\nif (!file)\r\ngoto err;\r\nif (is_ab8500(ab8500)) {\r\ndebug_ranges = ab8500_debug_ranges;\r\nnum_interrupt_lines = AB8500_NR_IRQS;\r\n} else if (is_ab8505(ab8500)) {\r\ndebug_ranges = ab8505_debug_ranges;\r\nnum_interrupt_lines = AB8505_NR_IRQS;\r\n} else if (is_ab9540(ab8500)) {\r\ndebug_ranges = ab8505_debug_ranges;\r\nnum_interrupt_lines = AB9540_NR_IRQS;\r\n} else if (is_ab8540(ab8500)) {\r\ndebug_ranges = ab8540_debug_ranges;\r\nnum_interrupt_lines = AB8540_NR_IRQS;\r\n}\r\nfile = debugfs_create_file("interrupts", (S_IRUGO), ab8500_dir,\r\n&plf->dev, &ab8500_interrupts_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("irq-unsubscribe",\r\n(S_IRUGO | S_IWUSR | S_IWGRP), ab8500_dir,\r\n&plf->dev, &ab8500_unsubscribe_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("hwreg", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_dir, &plf->dev, &ab8500_hwreg_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("all-modem-registers",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_dir, &plf->dev, &ab8500_modem_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("bat_ctrl", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_bat_ctrl_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("btemp_ball", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir,\r\n&plf->dev, &ab8500_gpadc_btemp_ball_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("main_charger_v",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_main_charger_v_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("acc_detect1",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_acc_detect1_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("acc_detect2",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_acc_detect2_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("adc_aux1", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_aux1_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("adc_aux2", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_aux2_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("main_bat_v", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_main_bat_v_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("vbus_v", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_vbus_v_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("main_charger_c",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_main_charger_c_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("usb_charger_c",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir,\r\n&plf->dev, &ab8500_gpadc_usb_charger_c_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("bk_bat_v", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_bk_bat_v_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("die_temp", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_die_temp_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("usb_id", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_usb_id_fops);\r\nif (!file)\r\ngoto err;\r\nif (is_ab8540(ab8500)) {\r\nfile = debugfs_create_file("xtal_temp",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8540_gpadc_xtal_temp_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("vbattruemeas",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8540_gpadc_vbat_true_meas_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("batctrl_and_ibat",\r\n(S_IRUGO | S_IWUGO),\r\nab8500_gpadc_dir,\r\n&plf->dev,\r\n&ab8540_gpadc_bat_ctrl_and_ibat_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("vbatmeas_and_ibat",\r\n(S_IRUGO | S_IWUGO),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8540_gpadc_vbat_meas_and_ibat_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("vbattruemeas_and_ibat",\r\n(S_IRUGO | S_IWUGO),\r\nab8500_gpadc_dir,\r\n&plf->dev,\r\n&ab8540_gpadc_vbat_true_meas_and_ibat_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("battemp_and_ibat",\r\n(S_IRUGO | S_IWUGO),\r\nab8500_gpadc_dir,\r\n&plf->dev, &ab8540_gpadc_bat_temp_and_ibat_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("otp_calib",\r\n(S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir,\r\n&plf->dev, &ab8540_gpadc_otp_calib_fops);\r\nif (!file)\r\ngoto err;\r\n}\r\nfile = debugfs_create_file("avg_sample", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_avg_sample_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("trig_edge", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_trig_edge_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("trig_timer", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_trig_timer_fops);\r\nif (!file)\r\ngoto err;\r\nfile = debugfs_create_file("conv_type", (S_IRUGO | S_IWUSR | S_IWGRP),\r\nab8500_gpadc_dir, &plf->dev,\r\n&ab8500_gpadc_conv_type_fops);\r\nif (!file)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndebugfs_remove_recursive(ab8500_dir);\r\ndev_err(&plf->dev, "failed to create debugfs entries.\n");\r\nreturn -ENOMEM;\r\n}\r\nstatic int __init ab8500_debug_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_debug_driver);\r\n}

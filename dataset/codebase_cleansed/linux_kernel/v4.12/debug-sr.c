static void __hyp_text __debug_save_spe_vhe(u64 *pmscr_el1)\r\n{\r\n}\r\nstatic void __hyp_text __debug_save_spe_nvhe(u64 *pmscr_el1)\r\n{\r\nu64 reg;\r\nif (!cpuid_feature_extract_unsigned_field(read_sysreg(id_aa64dfr0_el1),\r\nID_AA64DFR0_PMSVER_SHIFT))\r\nreturn;\r\nreg = read_sysreg_s(PMBIDR_EL1);\r\nif (reg & PMBIDR_EL1_P)\r\nreturn;\r\nreg = read_sysreg_s(PMBLIMITR_EL1);\r\nif (!(reg & PMBLIMITR_EL1_E))\r\nreturn;\r\n*pmscr_el1 = read_sysreg_s(PMSCR_EL1);\r\nwrite_sysreg_s(0, PMSCR_EL1);\r\nisb();\r\npsb_csync();\r\ndsb(nsh);\r\n}\r\nstatic void __hyp_text __debug_restore_spe(u64 pmscr_el1)\r\n{\r\nif (!pmscr_el1)\r\nreturn;\r\nisb();\r\nwrite_sysreg_s(pmscr_el1, PMSCR_EL1);\r\n}\r\nvoid __hyp_text __debug_save_state(struct kvm_vcpu *vcpu,\r\nstruct kvm_guest_debug_arch *dbg,\r\nstruct kvm_cpu_context *ctxt)\r\n{\r\nu64 aa64dfr0;\r\nint brps, wrps;\r\nif (!(vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY))\r\nreturn;\r\naa64dfr0 = read_sysreg(id_aa64dfr0_el1);\r\nbrps = (aa64dfr0 >> 12) & 0xf;\r\nwrps = (aa64dfr0 >> 20) & 0xf;\r\nsave_debug(dbg->dbg_bcr, dbgbcr, brps);\r\nsave_debug(dbg->dbg_bvr, dbgbvr, brps);\r\nsave_debug(dbg->dbg_wcr, dbgwcr, wrps);\r\nsave_debug(dbg->dbg_wvr, dbgwvr, wrps);\r\nctxt->sys_regs[MDCCINT_EL1] = read_sysreg(mdccint_el1);\r\n}\r\nvoid __hyp_text __debug_restore_state(struct kvm_vcpu *vcpu,\r\nstruct kvm_guest_debug_arch *dbg,\r\nstruct kvm_cpu_context *ctxt)\r\n{\r\nu64 aa64dfr0;\r\nint brps, wrps;\r\nif (!(vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY))\r\nreturn;\r\naa64dfr0 = read_sysreg(id_aa64dfr0_el1);\r\nbrps = (aa64dfr0 >> 12) & 0xf;\r\nwrps = (aa64dfr0 >> 20) & 0xf;\r\nrestore_debug(dbg->dbg_bcr, dbgbcr, brps);\r\nrestore_debug(dbg->dbg_bvr, dbgbvr, brps);\r\nrestore_debug(dbg->dbg_wcr, dbgwcr, wrps);\r\nrestore_debug(dbg->dbg_wvr, dbgwvr, wrps);\r\nwrite_sysreg(ctxt->sys_regs[MDCCINT_EL1], mdccint_el1);\r\n}\r\nvoid __hyp_text __debug_cond_save_host_state(struct kvm_vcpu *vcpu)\r\n{\r\nif ((vcpu->arch.ctxt.sys_regs[MDSCR_EL1] & DBG_MDSCR_KDE) ||\r\n(vcpu->arch.ctxt.sys_regs[MDSCR_EL1] & DBG_MDSCR_MDE))\r\nvcpu->arch.debug_flags |= KVM_ARM64_DEBUG_DIRTY;\r\n__debug_save_state(vcpu, &vcpu->arch.host_debug_state.regs,\r\nkern_hyp_va(vcpu->arch.host_cpu_context));\r\n__debug_save_spe()(&vcpu->arch.host_debug_state.pmscr_el1);\r\n}\r\nvoid __hyp_text __debug_cond_restore_host_state(struct kvm_vcpu *vcpu)\r\n{\r\n__debug_restore_spe(vcpu->arch.host_debug_state.pmscr_el1);\r\n__debug_restore_state(vcpu, &vcpu->arch.host_debug_state.regs,\r\nkern_hyp_va(vcpu->arch.host_cpu_context));\r\nif (vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY)\r\nvcpu->arch.debug_flags &= ~KVM_ARM64_DEBUG_DIRTY;\r\n}\r\nu32 __hyp_text __kvm_get_mdcr_el2(void)\r\n{\r\nreturn read_sysreg(mdcr_el2);\r\n}

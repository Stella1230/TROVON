static int vfio_mdev_open(void *device_data)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nint ret;\r\nif (unlikely(!parent->ops->open))\r\nreturn -EINVAL;\r\nif (!try_module_get(THIS_MODULE))\r\nreturn -ENODEV;\r\nret = parent->ops->open(mdev);\r\nif (ret)\r\nmodule_put(THIS_MODULE);\r\nreturn ret;\r\n}\r\nstatic void vfio_mdev_release(void *device_data)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nif (likely(parent->ops->release))\r\nparent->ops->release(mdev);\r\nmodule_put(THIS_MODULE);\r\n}\r\nstatic long vfio_mdev_unlocked_ioctl(void *device_data,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nif (unlikely(!parent->ops->ioctl))\r\nreturn -EINVAL;\r\nreturn parent->ops->ioctl(mdev, cmd, arg);\r\n}\r\nstatic ssize_t vfio_mdev_read(void *device_data, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nif (unlikely(!parent->ops->read))\r\nreturn -EINVAL;\r\nreturn parent->ops->read(mdev, buf, count, ppos);\r\n}\r\nstatic ssize_t vfio_mdev_write(void *device_data, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nif (unlikely(!parent->ops->write))\r\nreturn -EINVAL;\r\nreturn parent->ops->write(mdev, buf, count, ppos);\r\n}\r\nstatic int vfio_mdev_mmap(void *device_data, struct vm_area_struct *vma)\r\n{\r\nstruct mdev_device *mdev = device_data;\r\nstruct mdev_parent *parent = mdev->parent;\r\nif (unlikely(!parent->ops->mmap))\r\nreturn -EINVAL;\r\nreturn parent->ops->mmap(mdev, vma);\r\n}\r\nint vfio_mdev_probe(struct device *dev)\r\n{\r\nstruct mdev_device *mdev = to_mdev_device(dev);\r\nreturn vfio_add_group_dev(dev, &vfio_mdev_dev_ops, mdev);\r\n}\r\nvoid vfio_mdev_remove(struct device *dev)\r\n{\r\nvfio_del_group_dev(dev);\r\n}\r\nstatic int __init vfio_mdev_init(void)\r\n{\r\nreturn mdev_register_driver(&vfio_mdev_driver, THIS_MODULE);\r\n}\r\nstatic void __exit vfio_mdev_exit(void)\r\n{\r\nmdev_unregister_driver(&vfio_mdev_driver);\r\n}

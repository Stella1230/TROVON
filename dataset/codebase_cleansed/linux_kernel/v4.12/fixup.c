static void pci_fixup_video(struct pci_dev *pdev)\r\n{\r\nstruct pci_dev *bridge;\r\nstruct pci_bus *bus;\r\nu16 config;\r\nstruct resource *res;\r\nif ((strcmp(ia64_platform_name, "dig") != 0)\r\n&& (strcmp(ia64_platform_name, "hpzx1") != 0))\r\nreturn;\r\nbus = pdev->bus;\r\nwhile (bus) {\r\nbridge = bus->self;\r\nif (bridge && (pci_is_bridge(bridge))) {\r\npci_read_config_word(bridge, PCI_BRIDGE_CONTROL,\r\n&config);\r\nif (!(config & PCI_BRIDGE_CTL_VGA))\r\nreturn;\r\n}\r\nbus = bus->parent;\r\n}\r\nif (!vga_default_device() || pdev == vga_default_device()) {\r\npci_read_config_word(pdev, PCI_COMMAND, &config);\r\nif (config & (PCI_COMMAND_IO | PCI_COMMAND_MEMORY)) {\r\nres = &pdev->resource[PCI_ROM_RESOURCE];\r\npci_disable_rom(pdev);\r\nif (res->parent)\r\nrelease_resource(res);\r\nres->start = 0xC0000;\r\nres->end = res->start + 0x20000 - 1;\r\nres->flags = IORESOURCE_MEM | IORESOURCE_ROM_SHADOW |\r\nIORESOURCE_PCI_FIXED;\r\ndev_info(&pdev->dev, "Video device with shadowed ROM at %pR\n",\r\nres);\r\n}\r\n}\r\n}

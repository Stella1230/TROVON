static void\r\nppp_print_buffer (const char *name, const __u8 *buf, int count)\r\n{\r\nif (name != NULL)\r\nprintk(KERN_DEBUG "ppp_synctty: %s, count = %d\n", name, count);\r\nprint_hex_dump_bytes("", DUMP_PREFIX_NONE, buf, count);\r\n}\r\nstatic struct syncppp *sp_get(struct tty_struct *tty)\r\n{\r\nstruct syncppp *ap;\r\nread_lock(&disc_data_lock);\r\nap = tty->disc_data;\r\nif (ap != NULL)\r\natomic_inc(&ap->refcnt);\r\nread_unlock(&disc_data_lock);\r\nreturn ap;\r\n}\r\nstatic void sp_put(struct syncppp *ap)\r\n{\r\nif (atomic_dec_and_test(&ap->refcnt))\r\ncomplete(&ap->dead_cmp);\r\n}\r\nstatic int\r\nppp_sync_open(struct tty_struct *tty)\r\n{\r\nstruct syncppp *ap;\r\nint err;\r\nint speed;\r\nif (tty->ops->write == NULL)\r\nreturn -EOPNOTSUPP;\r\nap = kzalloc(sizeof(*ap), GFP_KERNEL);\r\nerr = -ENOMEM;\r\nif (!ap)\r\ngoto out;\r\nap->tty = tty;\r\nap->mru = PPP_MRU;\r\nspin_lock_init(&ap->xmit_lock);\r\nspin_lock_init(&ap->recv_lock);\r\nap->xaccm[0] = ~0U;\r\nap->xaccm[3] = 0x60000000U;\r\nap->raccm = ~0U;\r\nskb_queue_head_init(&ap->rqueue);\r\ntasklet_init(&ap->tsk, ppp_sync_process, (unsigned long) ap);\r\natomic_set(&ap->refcnt, 1);\r\ninit_completion(&ap->dead_cmp);\r\nap->chan.private = ap;\r\nap->chan.ops = &sync_ops;\r\nap->chan.mtu = PPP_MRU;\r\nap->chan.hdrlen = 2;\r\nspeed = tty_get_baud_rate(tty);\r\nap->chan.speed = speed;\r\nerr = ppp_register_channel(&ap->chan);\r\nif (err)\r\ngoto out_free;\r\ntty->disc_data = ap;\r\ntty->receive_room = 65536;\r\nreturn 0;\r\nout_free:\r\nkfree(ap);\r\nout:\r\nreturn err;\r\n}\r\nstatic void\r\nppp_sync_close(struct tty_struct *tty)\r\n{\r\nstruct syncppp *ap;\r\nwrite_lock_irq(&disc_data_lock);\r\nap = tty->disc_data;\r\ntty->disc_data = NULL;\r\nwrite_unlock_irq(&disc_data_lock);\r\nif (!ap)\r\nreturn;\r\nif (!atomic_dec_and_test(&ap->refcnt))\r\nwait_for_completion(&ap->dead_cmp);\r\ntasklet_kill(&ap->tsk);\r\nppp_unregister_channel(&ap->chan);\r\nskb_queue_purge(&ap->rqueue);\r\nkfree_skb(ap->tpkt);\r\nkfree(ap);\r\n}\r\nstatic int ppp_sync_hangup(struct tty_struct *tty)\r\n{\r\nppp_sync_close(tty);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nppp_sync_read(struct tty_struct *tty, struct file *file,\r\nunsigned char __user *buf, size_t count)\r\n{\r\nreturn -EAGAIN;\r\n}\r\nstatic ssize_t\r\nppp_sync_write(struct tty_struct *tty, struct file *file,\r\nconst unsigned char *buf, size_t count)\r\n{\r\nreturn -EAGAIN;\r\n}\r\nstatic int\r\nppp_synctty_ioctl(struct tty_struct *tty, struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct syncppp *ap = sp_get(tty);\r\nint __user *p = (int __user *)arg;\r\nint err, val;\r\nif (!ap)\r\nreturn -ENXIO;\r\nerr = -EFAULT;\r\nswitch (cmd) {\r\ncase PPPIOCGCHAN:\r\nerr = -EFAULT;\r\nif (put_user(ppp_channel_index(&ap->chan), p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCGUNIT:\r\nerr = -EFAULT;\r\nif (put_user(ppp_unit_number(&ap->chan), p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase TCFLSH:\r\nif (arg == TCIOFLUSH || arg == TCOFLUSH)\r\nppp_sync_flush_output(ap);\r\nerr = n_tty_ioctl_helper(tty, file, cmd, arg);\r\nbreak;\r\ncase FIONREAD:\r\nval = 0;\r\nif (put_user(val, p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ndefault:\r\nerr = tty_mode_ioctl(tty, file, cmd, arg);\r\nbreak;\r\n}\r\nsp_put(ap);\r\nreturn err;\r\n}\r\nstatic unsigned int\r\nppp_sync_poll(struct tty_struct *tty, struct file *file, poll_table *wait)\r\n{\r\nreturn 0;\r\n}\r\nstatic void\r\nppp_sync_receive(struct tty_struct *tty, const unsigned char *buf,\r\nchar *cflags, int count)\r\n{\r\nstruct syncppp *ap = sp_get(tty);\r\nunsigned long flags;\r\nif (!ap)\r\nreturn;\r\nspin_lock_irqsave(&ap->recv_lock, flags);\r\nppp_sync_input(ap, buf, cflags, count);\r\nspin_unlock_irqrestore(&ap->recv_lock, flags);\r\nif (!skb_queue_empty(&ap->rqueue))\r\ntasklet_schedule(&ap->tsk);\r\nsp_put(ap);\r\ntty_unthrottle(tty);\r\n}\r\nstatic void\r\nppp_sync_wakeup(struct tty_struct *tty)\r\n{\r\nstruct syncppp *ap = sp_get(tty);\r\nclear_bit(TTY_DO_WRITE_WAKEUP, &tty->flags);\r\nif (!ap)\r\nreturn;\r\nset_bit(XMIT_WAKEUP, &ap->xmit_flags);\r\ntasklet_schedule(&ap->tsk);\r\nsp_put(ap);\r\n}\r\nstatic int __init\r\nppp_sync_init(void)\r\n{\r\nint err;\r\nerr = tty_register_ldisc(N_SYNC_PPP, &ppp_sync_ldisc);\r\nif (err != 0)\r\nprintk(KERN_ERR "PPP_sync: error %d registering line disc.\n",\r\nerr);\r\nreturn err;\r\n}\r\nstatic int\r\nppp_sync_ioctl(struct ppp_channel *chan, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct syncppp *ap = chan->private;\r\nint err, val;\r\nu32 accm[8];\r\nvoid __user *argp = (void __user *)arg;\r\nu32 __user *p = argp;\r\nerr = -EFAULT;\r\nswitch (cmd) {\r\ncase PPPIOCGFLAGS:\r\nval = ap->flags | ap->rbits;\r\nif (put_user(val, (int __user *) argp))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSFLAGS:\r\nif (get_user(val, (int __user *) argp))\r\nbreak;\r\nap->flags = val & ~SC_RCV_BITS;\r\nspin_lock_irq(&ap->recv_lock);\r\nap->rbits = val & SC_RCV_BITS;\r\nspin_unlock_irq(&ap->recv_lock);\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCGASYNCMAP:\r\nif (put_user(ap->xaccm[0], p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSASYNCMAP:\r\nif (get_user(ap->xaccm[0], p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCGRASYNCMAP:\r\nif (put_user(ap->raccm, p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSRASYNCMAP:\r\nif (get_user(ap->raccm, p))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCGXASYNCMAP:\r\nif (copy_to_user(argp, ap->xaccm, sizeof(ap->xaccm)))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSXASYNCMAP:\r\nif (copy_from_user(accm, argp, sizeof(accm)))\r\nbreak;\r\naccm[2] &= ~0x40000000U;\r\naccm[3] |= 0x60000000U;\r\nmemcpy(ap->xaccm, accm, sizeof(ap->xaccm));\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCGMRU:\r\nif (put_user(ap->mru, (int __user *) argp))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSMRU:\r\nif (get_user(val, (int __user *) argp))\r\nbreak;\r\nif (val < PPP_MRU)\r\nval = PPP_MRU;\r\nap->mru = val;\r\nerr = 0;\r\nbreak;\r\ndefault:\r\nerr = -ENOTTY;\r\n}\r\nreturn err;\r\n}\r\nstatic void ppp_sync_process(unsigned long arg)\r\n{\r\nstruct syncppp *ap = (struct syncppp *) arg;\r\nstruct sk_buff *skb;\r\nwhile ((skb = skb_dequeue(&ap->rqueue)) != NULL) {\r\nif (skb->len == 0) {\r\nppp_input_error(&ap->chan, 0);\r\nkfree_skb(skb);\r\n}\r\nelse\r\nppp_input(&ap->chan, skb);\r\n}\r\nif (test_bit(XMIT_WAKEUP, &ap->xmit_flags) && ppp_sync_push(ap))\r\nppp_output_wakeup(&ap->chan);\r\n}\r\nstatic struct sk_buff*\r\nppp_sync_txmunge(struct syncppp *ap, struct sk_buff *skb)\r\n{\r\nint proto;\r\nunsigned char *data;\r\nint islcp;\r\ndata = skb->data;\r\nproto = get_unaligned_be16(data);\r\nislcp = proto == PPP_LCP && 1 <= data[2] && data[2] <= 7;\r\nif (data[0] == 0 && (ap->flags & SC_COMP_PROT) && !islcp)\r\nskb_pull(skb,1);\r\nif ((ap->flags & SC_COMP_AC) == 0 || islcp) {\r\nif (skb_headroom(skb) < 2) {\r\nstruct sk_buff *npkt = dev_alloc_skb(skb->len + 2);\r\nif (npkt == NULL) {\r\nkfree_skb(skb);\r\nreturn NULL;\r\n}\r\nskb_reserve(npkt,2);\r\nskb_copy_from_linear_data(skb,\r\nskb_put(npkt, skb->len), skb->len);\r\nconsume_skb(skb);\r\nskb = npkt;\r\n}\r\nskb_push(skb,2);\r\nskb->data[0] = PPP_ALLSTATIONS;\r\nskb->data[1] = PPP_UI;\r\n}\r\nap->last_xmit = jiffies;\r\nif (skb && ap->flags & SC_LOG_OUTPKT)\r\nppp_print_buffer ("send buffer", skb->data, skb->len);\r\nreturn skb;\r\n}\r\nstatic int\r\nppp_sync_send(struct ppp_channel *chan, struct sk_buff *skb)\r\n{\r\nstruct syncppp *ap = chan->private;\r\nppp_sync_push(ap);\r\nif (test_and_set_bit(XMIT_FULL, &ap->xmit_flags))\r\nreturn 0;\r\nskb = ppp_sync_txmunge(ap, skb);\r\nif (skb != NULL)\r\nap->tpkt = skb;\r\nelse\r\nclear_bit(XMIT_FULL, &ap->xmit_flags);\r\nppp_sync_push(ap);\r\nreturn 1;\r\n}\r\nstatic int\r\nppp_sync_push(struct syncppp *ap)\r\n{\r\nint sent, done = 0;\r\nstruct tty_struct *tty = ap->tty;\r\nint tty_stuffed = 0;\r\nif (!spin_trylock_bh(&ap->xmit_lock))\r\nreturn 0;\r\nfor (;;) {\r\nif (test_and_clear_bit(XMIT_WAKEUP, &ap->xmit_flags))\r\ntty_stuffed = 0;\r\nif (!tty_stuffed && ap->tpkt) {\r\nset_bit(TTY_DO_WRITE_WAKEUP, &tty->flags);\r\nsent = tty->ops->write(tty, ap->tpkt->data, ap->tpkt->len);\r\nif (sent < 0)\r\ngoto flush;\r\nif (sent < ap->tpkt->len) {\r\ntty_stuffed = 1;\r\n} else {\r\nconsume_skb(ap->tpkt);\r\nap->tpkt = NULL;\r\nclear_bit(XMIT_FULL, &ap->xmit_flags);\r\ndone = 1;\r\n}\r\ncontinue;\r\n}\r\nspin_unlock_bh(&ap->xmit_lock);\r\nif (!(test_bit(XMIT_WAKEUP, &ap->xmit_flags) ||\r\n(!tty_stuffed && ap->tpkt)))\r\nbreak;\r\nif (!spin_trylock_bh(&ap->xmit_lock))\r\nbreak;\r\n}\r\nreturn done;\r\nflush:\r\nif (ap->tpkt) {\r\nkfree_skb(ap->tpkt);\r\nap->tpkt = NULL;\r\nclear_bit(XMIT_FULL, &ap->xmit_flags);\r\ndone = 1;\r\n}\r\nspin_unlock_bh(&ap->xmit_lock);\r\nreturn done;\r\n}\r\nstatic void\r\nppp_sync_flush_output(struct syncppp *ap)\r\n{\r\nint done = 0;\r\nspin_lock_bh(&ap->xmit_lock);\r\nif (ap->tpkt != NULL) {\r\nkfree_skb(ap->tpkt);\r\nap->tpkt = NULL;\r\nclear_bit(XMIT_FULL, &ap->xmit_flags);\r\ndone = 1;\r\n}\r\nspin_unlock_bh(&ap->xmit_lock);\r\nif (done)\r\nppp_output_wakeup(&ap->chan);\r\n}\r\nstatic void\r\nppp_sync_input(struct syncppp *ap, const unsigned char *buf,\r\nchar *flags, int count)\r\n{\r\nstruct sk_buff *skb;\r\nunsigned char *p;\r\nif (count == 0)\r\nreturn;\r\nif (ap->flags & SC_LOG_INPKT)\r\nppp_print_buffer ("receive buffer", buf, count);\r\nskb = dev_alloc_skb(ap->mru + PPP_HDRLEN + 2);\r\nif (!skb) {\r\nprintk(KERN_ERR "PPPsync: no memory (input pkt)\n");\r\ngoto err;\r\n}\r\nif (buf[0] != PPP_ALLSTATIONS)\r\nskb_reserve(skb, 2 + (buf[0] & 1));\r\nif (flags && *flags) {\r\ngoto err;\r\n} else if (count > skb_tailroom(skb)) {\r\ngoto err;\r\n}\r\np = skb_put(skb, count);\r\nmemcpy(p, buf, count);\r\np = skb->data;\r\nif (p[0] == PPP_ALLSTATIONS && p[1] == PPP_UI) {\r\nif (skb->len < 3)\r\ngoto err;\r\np = skb_pull(skb, 2);\r\n}\r\nif (p[0] & 1) {\r\nskb_push(skb, 1)[0] = 0;\r\n} else if (skb->len < 2)\r\ngoto err;\r\nskb_queue_tail(&ap->rqueue, skb);\r\nreturn;\r\nerr:\r\nif (skb || (skb = dev_alloc_skb(0))) {\r\nskb_trim(skb, 0);\r\nskb_queue_tail(&ap->rqueue, skb);\r\n}\r\n}\r\nstatic void __exit\r\nppp_sync_cleanup(void)\r\n{\r\nif (tty_unregister_ldisc(N_SYNC_PPP) != 0)\r\nprintk(KERN_ERR "failed to unregister Sync PPP line discipline\n");\r\n}

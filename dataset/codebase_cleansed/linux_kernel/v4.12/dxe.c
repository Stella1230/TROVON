void *wcn36xx_dxe_get_next_bd(struct wcn36xx *wcn, bool is_low)\r\n{\r\nstruct wcn36xx_dxe_ch *ch = is_low ?\r\n&wcn->dxe_tx_l_ch :\r\n&wcn->dxe_tx_h_ch;\r\nreturn ch->head_blk_ctl->bd_cpu_addr;\r\n}\r\nstatic void wcn36xx_ccu_write_register(struct wcn36xx *wcn, int addr, int data)\r\n{\r\nwcn36xx_dbg(WCN36XX_DBG_DXE,\r\n"wcn36xx_ccu_write_register: addr=%x, data=%x\n",\r\naddr, data);\r\nwritel(data, wcn->ccu_base + addr);\r\n}\r\nstatic void wcn36xx_dxe_write_register(struct wcn36xx *wcn, int addr, int data)\r\n{\r\nwcn36xx_dbg(WCN36XX_DBG_DXE,\r\n"wcn36xx_dxe_write_register: addr=%x, data=%x\n",\r\naddr, data);\r\nwritel(data, wcn->dxe_base + addr);\r\n}\r\nstatic void wcn36xx_dxe_read_register(struct wcn36xx *wcn, int addr, int *data)\r\n{\r\n*data = readl(wcn->dxe_base + addr);\r\nwcn36xx_dbg(WCN36XX_DBG_DXE,\r\n"wcn36xx_dxe_read_register: addr=%x, data=%x\n",\r\naddr, *data);\r\n}\r\nstatic void wcn36xx_dxe_free_ctl_block(struct wcn36xx_dxe_ch *ch)\r\n{\r\nstruct wcn36xx_dxe_ctl *ctl = ch->head_blk_ctl, *next;\r\nint i;\r\nfor (i = 0; i < ch->desc_num && ctl; i++) {\r\nnext = ctl->next;\r\nkfree(ctl);\r\nctl = next;\r\n}\r\n}\r\nstatic int wcn36xx_dxe_allocate_ctl_block(struct wcn36xx_dxe_ch *ch)\r\n{\r\nstruct wcn36xx_dxe_ctl *prev_ctl = NULL;\r\nstruct wcn36xx_dxe_ctl *cur_ctl = NULL;\r\nint i;\r\nspin_lock_init(&ch->lock);\r\nfor (i = 0; i < ch->desc_num; i++) {\r\ncur_ctl = kzalloc(sizeof(*cur_ctl), GFP_KERNEL);\r\nif (!cur_ctl)\r\ngoto out_fail;\r\nspin_lock_init(&cur_ctl->skb_lock);\r\ncur_ctl->ctl_blk_order = i;\r\nif (i == 0) {\r\nch->head_blk_ctl = cur_ctl;\r\nch->tail_blk_ctl = cur_ctl;\r\n} else if (ch->desc_num - 1 == i) {\r\nprev_ctl->next = cur_ctl;\r\ncur_ctl->next = ch->head_blk_ctl;\r\n} else {\r\nprev_ctl->next = cur_ctl;\r\n}\r\nprev_ctl = cur_ctl;\r\n}\r\nreturn 0;\r\nout_fail:\r\nwcn36xx_dxe_free_ctl_block(ch);\r\nreturn -ENOMEM;\r\n}\r\nint wcn36xx_dxe_alloc_ctl_blks(struct wcn36xx *wcn)\r\n{\r\nint ret;\r\nwcn->dxe_tx_l_ch.ch_type = WCN36XX_DXE_CH_TX_L;\r\nwcn->dxe_tx_h_ch.ch_type = WCN36XX_DXE_CH_TX_H;\r\nwcn->dxe_rx_l_ch.ch_type = WCN36XX_DXE_CH_RX_L;\r\nwcn->dxe_rx_h_ch.ch_type = WCN36XX_DXE_CH_RX_H;\r\nwcn->dxe_tx_l_ch.desc_num = WCN36XX_DXE_CH_DESC_NUMB_TX_L;\r\nwcn->dxe_tx_h_ch.desc_num = WCN36XX_DXE_CH_DESC_NUMB_TX_H;\r\nwcn->dxe_rx_l_ch.desc_num = WCN36XX_DXE_CH_DESC_NUMB_RX_L;\r\nwcn->dxe_rx_h_ch.desc_num = WCN36XX_DXE_CH_DESC_NUMB_RX_H;\r\nwcn->dxe_tx_l_ch.dxe_wq = WCN36XX_DXE_WQ_TX_L;\r\nwcn->dxe_tx_h_ch.dxe_wq = WCN36XX_DXE_WQ_TX_H;\r\nwcn->dxe_tx_l_ch.ctrl_bd = WCN36XX_DXE_CTRL_TX_L_BD;\r\nwcn->dxe_tx_h_ch.ctrl_bd = WCN36XX_DXE_CTRL_TX_H_BD;\r\nwcn->dxe_tx_l_ch.ctrl_skb = WCN36XX_DXE_CTRL_TX_L_SKB;\r\nwcn->dxe_tx_h_ch.ctrl_skb = WCN36XX_DXE_CTRL_TX_H_SKB;\r\nwcn->dxe_tx_l_ch.reg_ctrl = WCN36XX_DXE_REG_CTL_TX_L;\r\nwcn->dxe_tx_h_ch.reg_ctrl = WCN36XX_DXE_REG_CTL_TX_H;\r\nwcn->dxe_tx_l_ch.def_ctrl = WCN36XX_DXE_CH_DEFAULT_CTL_TX_L;\r\nwcn->dxe_tx_h_ch.def_ctrl = WCN36XX_DXE_CH_DEFAULT_CTL_TX_H;\r\nret = wcn36xx_dxe_allocate_ctl_block(&wcn->dxe_tx_l_ch);\r\nif (ret)\r\ngoto out_err;\r\nret = wcn36xx_dxe_allocate_ctl_block(&wcn->dxe_tx_h_ch);\r\nif (ret)\r\ngoto out_err;\r\nret = wcn36xx_dxe_allocate_ctl_block(&wcn->dxe_rx_l_ch);\r\nif (ret)\r\ngoto out_err;\r\nret = wcn36xx_dxe_allocate_ctl_block(&wcn->dxe_rx_h_ch);\r\nif (ret)\r\ngoto out_err;\r\nret = qcom_smem_state_update_bits(wcn->tx_enable_state,\r\nWCN36XX_SMSM_WLAN_TX_ENABLE |\r\nWCN36XX_SMSM_WLAN_TX_RINGS_EMPTY,\r\nWCN36XX_SMSM_WLAN_TX_RINGS_EMPTY);\r\nif (ret)\r\ngoto out_err;\r\nreturn 0;\r\nout_err:\r\nwcn36xx_err("Failed to allocate DXE control blocks\n");\r\nwcn36xx_dxe_free_ctl_blks(wcn);\r\nreturn -ENOMEM;\r\n}\r\nvoid wcn36xx_dxe_free_ctl_blks(struct wcn36xx *wcn)\r\n{\r\nwcn36xx_dxe_free_ctl_block(&wcn->dxe_tx_l_ch);\r\nwcn36xx_dxe_free_ctl_block(&wcn->dxe_tx_h_ch);\r\nwcn36xx_dxe_free_ctl_block(&wcn->dxe_rx_l_ch);\r\nwcn36xx_dxe_free_ctl_block(&wcn->dxe_rx_h_ch);\r\n}\r\nstatic int wcn36xx_dxe_init_descs(struct device *dev, struct wcn36xx_dxe_ch *wcn_ch)\r\n{\r\nstruct wcn36xx_dxe_desc *cur_dxe = NULL;\r\nstruct wcn36xx_dxe_desc *prev_dxe = NULL;\r\nstruct wcn36xx_dxe_ctl *cur_ctl = NULL;\r\nsize_t size;\r\nint i;\r\nsize = wcn_ch->desc_num * sizeof(struct wcn36xx_dxe_desc);\r\nwcn_ch->cpu_addr = dma_alloc_coherent(dev, size, &wcn_ch->dma_addr,\r\nGFP_KERNEL);\r\nif (!wcn_ch->cpu_addr)\r\nreturn -ENOMEM;\r\nmemset(wcn_ch->cpu_addr, 0, size);\r\ncur_dxe = (struct wcn36xx_dxe_desc *)wcn_ch->cpu_addr;\r\ncur_ctl = wcn_ch->head_blk_ctl;\r\nfor (i = 0; i < wcn_ch->desc_num; i++) {\r\ncur_ctl->desc = cur_dxe;\r\ncur_ctl->desc_phy_addr = wcn_ch->dma_addr +\r\ni * sizeof(struct wcn36xx_dxe_desc);\r\nswitch (wcn_ch->ch_type) {\r\ncase WCN36XX_DXE_CH_TX_L:\r\ncur_dxe->ctrl = WCN36XX_DXE_CTRL_TX_L;\r\ncur_dxe->dst_addr_l = WCN36XX_DXE_WQ_TX_L;\r\nbreak;\r\ncase WCN36XX_DXE_CH_TX_H:\r\ncur_dxe->ctrl = WCN36XX_DXE_CTRL_TX_H;\r\ncur_dxe->dst_addr_l = WCN36XX_DXE_WQ_TX_H;\r\nbreak;\r\ncase WCN36XX_DXE_CH_RX_L:\r\ncur_dxe->ctrl = WCN36XX_DXE_CTRL_RX_L;\r\ncur_dxe->src_addr_l = WCN36XX_DXE_WQ_RX_L;\r\nbreak;\r\ncase WCN36XX_DXE_CH_RX_H:\r\ncur_dxe->ctrl = WCN36XX_DXE_CTRL_RX_H;\r\ncur_dxe->src_addr_l = WCN36XX_DXE_WQ_RX_H;\r\nbreak;\r\n}\r\nif (0 == i) {\r\ncur_dxe->phy_next_l = 0;\r\n} else if ((0 < i) && (i < wcn_ch->desc_num - 1)) {\r\nprev_dxe->phy_next_l =\r\ncur_ctl->desc_phy_addr;\r\n} else if (i == (wcn_ch->desc_num - 1)) {\r\nprev_dxe->phy_next_l =\r\ncur_ctl->desc_phy_addr;\r\ncur_dxe->phy_next_l =\r\nwcn_ch->head_blk_ctl->desc_phy_addr;\r\n}\r\ncur_ctl = cur_ctl->next;\r\nprev_dxe = cur_dxe;\r\ncur_dxe++;\r\n}\r\nreturn 0;\r\n}\r\nstatic void wcn36xx_dxe_init_tx_bd(struct wcn36xx_dxe_ch *ch,\r\nstruct wcn36xx_dxe_mem_pool *pool)\r\n{\r\nint i, chunk_size = pool->chunk_size;\r\ndma_addr_t bd_phy_addr = pool->phy_addr;\r\nvoid *bd_cpu_addr = pool->virt_addr;\r\nstruct wcn36xx_dxe_ctl *cur = ch->head_blk_ctl;\r\nfor (i = 0; i < ch->desc_num; i++) {\r\nif (!(i & 1)) {\r\ncur->bd_phy_addr = bd_phy_addr;\r\ncur->bd_cpu_addr = bd_cpu_addr;\r\nbd_phy_addr += chunk_size;\r\nbd_cpu_addr += chunk_size;\r\n} else {\r\ncur->bd_phy_addr = 0;\r\ncur->bd_cpu_addr = NULL;\r\n}\r\ncur = cur->next;\r\n}\r\n}\r\nstatic int wcn36xx_dxe_enable_ch_int(struct wcn36xx *wcn, u16 wcn_ch)\r\n{\r\nint reg_data = 0;\r\nwcn36xx_dxe_read_register(wcn,\r\nWCN36XX_DXE_INT_MASK_REG,\r\n&reg_data);\r\nreg_data |= wcn_ch;\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_INT_MASK_REG,\r\n(int)reg_data);\r\nreturn 0;\r\n}\r\nstatic int wcn36xx_dxe_fill_skb(struct device *dev, struct wcn36xx_dxe_ctl *ctl)\r\n{\r\nstruct wcn36xx_dxe_desc *dxe = ctl->desc;\r\nstruct sk_buff *skb;\r\nskb = alloc_skb(WCN36XX_PKT_SIZE, GFP_ATOMIC);\r\nif (skb == NULL)\r\nreturn -ENOMEM;\r\ndxe->dst_addr_l = dma_map_single(dev,\r\nskb_tail_pointer(skb),\r\nWCN36XX_PKT_SIZE,\r\nDMA_FROM_DEVICE);\r\nctl->skb = skb;\r\nreturn 0;\r\n}\r\nstatic int wcn36xx_dxe_ch_alloc_skb(struct wcn36xx *wcn,\r\nstruct wcn36xx_dxe_ch *wcn_ch)\r\n{\r\nint i;\r\nstruct wcn36xx_dxe_ctl *cur_ctl = NULL;\r\ncur_ctl = wcn_ch->head_blk_ctl;\r\nfor (i = 0; i < wcn_ch->desc_num; i++) {\r\nwcn36xx_dxe_fill_skb(wcn->dev, cur_ctl);\r\ncur_ctl = cur_ctl->next;\r\n}\r\nreturn 0;\r\n}\r\nstatic void wcn36xx_dxe_ch_free_skbs(struct wcn36xx *wcn,\r\nstruct wcn36xx_dxe_ch *wcn_ch)\r\n{\r\nstruct wcn36xx_dxe_ctl *cur = wcn_ch->head_blk_ctl;\r\nint i;\r\nfor (i = 0; i < wcn_ch->desc_num; i++) {\r\nkfree_skb(cur->skb);\r\ncur = cur->next;\r\n}\r\n}\r\nvoid wcn36xx_dxe_tx_ack_ind(struct wcn36xx *wcn, u32 status)\r\n{\r\nstruct ieee80211_tx_info *info;\r\nstruct sk_buff *skb;\r\nunsigned long flags;\r\nspin_lock_irqsave(&wcn->dxe_lock, flags);\r\nskb = wcn->tx_ack_skb;\r\nwcn->tx_ack_skb = NULL;\r\nspin_unlock_irqrestore(&wcn->dxe_lock, flags);\r\nif (!skb) {\r\nwcn36xx_warn("Spurious TX complete indication\n");\r\nreturn;\r\n}\r\ninfo = IEEE80211_SKB_CB(skb);\r\nif (status == 1)\r\ninfo->flags |= IEEE80211_TX_STAT_ACK;\r\nwcn36xx_dbg(WCN36XX_DBG_DXE, "dxe tx ack status: %d\n", status);\r\nieee80211_tx_status_irqsafe(wcn->hw, skb);\r\nieee80211_wake_queues(wcn->hw);\r\n}\r\nstatic void reap_tx_dxes(struct wcn36xx *wcn, struct wcn36xx_dxe_ch *ch)\r\n{\r\nstruct wcn36xx_dxe_ctl *ctl;\r\nstruct ieee80211_tx_info *info;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ch->lock, flags);\r\nctl = ch->tail_blk_ctl;\r\ndo {\r\nif (ctl->desc->ctrl & WCN36XX_DXE_CTRL_VALID_MASK)\r\nbreak;\r\nif (ctl->skb) {\r\ndma_unmap_single(wcn->dev, ctl->desc->src_addr_l,\r\nctl->skb->len, DMA_TO_DEVICE);\r\ninfo = IEEE80211_SKB_CB(ctl->skb);\r\nif (!(info->flags & IEEE80211_TX_CTL_REQ_TX_STATUS)) {\r\nieee80211_free_txskb(wcn->hw, ctl->skb);\r\n}\r\nspin_lock(&ctl->skb_lock);\r\nif (wcn->queues_stopped) {\r\nwcn->queues_stopped = false;\r\nieee80211_wake_queues(wcn->hw);\r\n}\r\nspin_unlock(&ctl->skb_lock);\r\nctl->skb = NULL;\r\n}\r\nctl = ctl->next;\r\n} while (ctl != ch->head_blk_ctl &&\r\n!(ctl->desc->ctrl & WCN36XX_DXE_CTRL_VALID_MASK));\r\nch->tail_blk_ctl = ctl;\r\nspin_unlock_irqrestore(&ch->lock, flags);\r\n}\r\nstatic irqreturn_t wcn36xx_irq_tx_complete(int irq, void *dev)\r\n{\r\nstruct wcn36xx *wcn = (struct wcn36xx *)dev;\r\nint int_src, int_reason;\r\nwcn36xx_dxe_read_register(wcn, WCN36XX_DXE_INT_SRC_RAW_REG, &int_src);\r\nif (int_src & WCN36XX_INT_MASK_CHAN_TX_H) {\r\nwcn36xx_dxe_read_register(wcn,\r\nWCN36XX_DXE_CH_STATUS_REG_ADDR_TX_H,\r\n&int_reason);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_0_INT_CLR,\r\nWCN36XX_INT_MASK_CHAN_TX_H);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_0_INT_ED_CLR,\r\nWCN36XX_INT_MASK_CHAN_TX_H);\r\nwcn36xx_dbg(WCN36XX_DBG_DXE, "dxe tx ready high\n");\r\nreap_tx_dxes(wcn, &wcn->dxe_tx_h_ch);\r\n}\r\nif (int_src & WCN36XX_INT_MASK_CHAN_TX_L) {\r\nwcn36xx_dxe_read_register(wcn,\r\nWCN36XX_DXE_CH_STATUS_REG_ADDR_TX_L,\r\n&int_reason);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_0_INT_CLR,\r\nWCN36XX_INT_MASK_CHAN_TX_L);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_0_INT_ED_CLR,\r\nWCN36XX_INT_MASK_CHAN_TX_L);\r\nwcn36xx_dbg(WCN36XX_DBG_DXE, "dxe tx ready low\n");\r\nreap_tx_dxes(wcn, &wcn->dxe_tx_l_ch);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wcn36xx_irq_rx_ready(int irq, void *dev)\r\n{\r\nstruct wcn36xx *wcn = (struct wcn36xx *)dev;\r\ndisable_irq_nosync(wcn->rx_irq);\r\nwcn36xx_dxe_rx_frame(wcn);\r\nenable_irq(wcn->rx_irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wcn36xx_dxe_request_irqs(struct wcn36xx *wcn)\r\n{\r\nint ret;\r\nret = request_irq(wcn->tx_irq, wcn36xx_irq_tx_complete,\r\nIRQF_TRIGGER_HIGH, "wcn36xx_tx", wcn);\r\nif (ret) {\r\nwcn36xx_err("failed to alloc tx irq\n");\r\ngoto out_err;\r\n}\r\nret = request_irq(wcn->rx_irq, wcn36xx_irq_rx_ready, IRQF_TRIGGER_HIGH,\r\n"wcn36xx_rx", wcn);\r\nif (ret) {\r\nwcn36xx_err("failed to alloc rx irq\n");\r\ngoto out_txirq;\r\n}\r\nenable_irq_wake(wcn->rx_irq);\r\nreturn 0;\r\nout_txirq:\r\nfree_irq(wcn->tx_irq, wcn);\r\nout_err:\r\nreturn ret;\r\n}\r\nstatic int wcn36xx_rx_handle_packets(struct wcn36xx *wcn,\r\nstruct wcn36xx_dxe_ch *ch)\r\n{\r\nstruct wcn36xx_dxe_ctl *ctl = ch->head_blk_ctl;\r\nstruct wcn36xx_dxe_desc *dxe = ctl->desc;\r\ndma_addr_t dma_addr;\r\nstruct sk_buff *skb;\r\nint ret = 0, int_mask;\r\nu32 value;\r\nif (ch->ch_type == WCN36XX_DXE_CH_RX_L) {\r\nvalue = WCN36XX_DXE_CTRL_RX_L;\r\nint_mask = WCN36XX_DXE_INT_CH1_MASK;\r\n} else {\r\nvalue = WCN36XX_DXE_CTRL_RX_H;\r\nint_mask = WCN36XX_DXE_INT_CH3_MASK;\r\n}\r\nwhile (!(dxe->ctrl & WCN36XX_DXE_CTRL_VALID_MASK)) {\r\nskb = ctl->skb;\r\ndma_addr = dxe->dst_addr_l;\r\nret = wcn36xx_dxe_fill_skb(wcn->dev, ctl);\r\nif (0 == ret) {\r\ndma_unmap_single(wcn->dev, dma_addr, WCN36XX_PKT_SIZE,\r\nDMA_FROM_DEVICE);\r\nwcn36xx_rx_skb(wcn, skb);\r\n}\r\ndxe->ctrl = value;\r\nctl = ctl->next;\r\ndxe = ctl->desc;\r\n}\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_ENCH_ADDR, int_mask);\r\nch->head_blk_ctl = ctl;\r\nreturn 0;\r\n}\r\nvoid wcn36xx_dxe_rx_frame(struct wcn36xx *wcn)\r\n{\r\nint int_src;\r\nwcn36xx_dxe_read_register(wcn, WCN36XX_DXE_INT_SRC_RAW_REG, &int_src);\r\nif (int_src & WCN36XX_DXE_INT_CH1_MASK) {\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_0_INT_CLR,\r\nWCN36XX_DXE_INT_CH1_MASK);\r\nwcn36xx_rx_handle_packets(wcn, &(wcn->dxe_rx_l_ch));\r\n}\r\nif (int_src & WCN36XX_DXE_INT_CH3_MASK) {\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_0_INT_CLR,\r\nWCN36XX_DXE_INT_CH3_MASK);\r\nwcn36xx_rx_handle_packets(wcn, &(wcn->dxe_rx_h_ch));\r\n}\r\nif (!int_src)\r\nwcn36xx_warn("No DXE interrupt pending\n");\r\n}\r\nint wcn36xx_dxe_allocate_mem_pools(struct wcn36xx *wcn)\r\n{\r\nsize_t s;\r\nvoid *cpu_addr;\r\nwcn->mgmt_mem_pool.chunk_size = WCN36XX_BD_CHUNK_SIZE +\r\n16 - (WCN36XX_BD_CHUNK_SIZE % 8);\r\ns = wcn->mgmt_mem_pool.chunk_size * WCN36XX_DXE_CH_DESC_NUMB_TX_H;\r\ncpu_addr = dma_alloc_coherent(wcn->dev, s, &wcn->mgmt_mem_pool.phy_addr,\r\nGFP_KERNEL);\r\nif (!cpu_addr)\r\ngoto out_err;\r\nwcn->mgmt_mem_pool.virt_addr = cpu_addr;\r\nmemset(cpu_addr, 0, s);\r\nwcn->data_mem_pool.chunk_size = WCN36XX_BD_CHUNK_SIZE +\r\n16 - (WCN36XX_BD_CHUNK_SIZE % 8);\r\ns = wcn->data_mem_pool.chunk_size * WCN36XX_DXE_CH_DESC_NUMB_TX_L;\r\ncpu_addr = dma_alloc_coherent(wcn->dev, s, &wcn->data_mem_pool.phy_addr,\r\nGFP_KERNEL);\r\nif (!cpu_addr)\r\ngoto out_err;\r\nwcn->data_mem_pool.virt_addr = cpu_addr;\r\nmemset(cpu_addr, 0, s);\r\nreturn 0;\r\nout_err:\r\nwcn36xx_dxe_free_mem_pools(wcn);\r\nwcn36xx_err("Failed to allocate BD mempool\n");\r\nreturn -ENOMEM;\r\n}\r\nvoid wcn36xx_dxe_free_mem_pools(struct wcn36xx *wcn)\r\n{\r\nif (wcn->mgmt_mem_pool.virt_addr)\r\ndma_free_coherent(wcn->dev, wcn->mgmt_mem_pool.chunk_size *\r\nWCN36XX_DXE_CH_DESC_NUMB_TX_H,\r\nwcn->mgmt_mem_pool.virt_addr,\r\nwcn->mgmt_mem_pool.phy_addr);\r\nif (wcn->data_mem_pool.virt_addr) {\r\ndma_free_coherent(wcn->dev, wcn->data_mem_pool.chunk_size *\r\nWCN36XX_DXE_CH_DESC_NUMB_TX_L,\r\nwcn->data_mem_pool.virt_addr,\r\nwcn->data_mem_pool.phy_addr);\r\n}\r\n}\r\nint wcn36xx_dxe_tx_frame(struct wcn36xx *wcn,\r\nstruct wcn36xx_vif *vif_priv,\r\nstruct sk_buff *skb,\r\nbool is_low)\r\n{\r\nstruct wcn36xx_dxe_ctl *ctl = NULL;\r\nstruct wcn36xx_dxe_desc *desc = NULL;\r\nstruct wcn36xx_dxe_ch *ch = NULL;\r\nunsigned long flags;\r\nint ret;\r\nch = is_low ? &wcn->dxe_tx_l_ch : &wcn->dxe_tx_h_ch;\r\nspin_lock_irqsave(&ch->lock, flags);\r\nctl = ch->head_blk_ctl;\r\nspin_lock(&ctl->next->skb_lock);\r\nif (NULL != ctl->next->skb) {\r\nieee80211_stop_queues(wcn->hw);\r\nwcn->queues_stopped = true;\r\nspin_unlock(&ctl->next->skb_lock);\r\nspin_unlock_irqrestore(&ch->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nspin_unlock(&ctl->next->skb_lock);\r\nctl->skb = NULL;\r\ndesc = ctl->desc;\r\ndesc->src_addr_l = ctl->bd_phy_addr;\r\ndesc->dst_addr_l = ch->dxe_wq;\r\ndesc->fr_len = sizeof(struct wcn36xx_tx_bd);\r\ndesc->ctrl = ch->ctrl_bd;\r\nwcn36xx_dbg(WCN36XX_DBG_DXE, "DXE TX\n");\r\nwcn36xx_dbg_dump(WCN36XX_DBG_DXE_DUMP, "DESC1 >>> ",\r\n(char *)desc, sizeof(*desc));\r\nwcn36xx_dbg_dump(WCN36XX_DBG_DXE_DUMP,\r\n"BD >>> ", (char *)ctl->bd_cpu_addr,\r\nsizeof(struct wcn36xx_tx_bd));\r\nctl = ctl->next;\r\nctl->skb = skb;\r\ndesc = ctl->desc;\r\nif (ctl->bd_cpu_addr) {\r\nwcn36xx_err("bd_cpu_addr cannot be NULL for skb DXE\n");\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\ndesc->src_addr_l = dma_map_single(wcn->dev,\r\nctl->skb->data,\r\nctl->skb->len,\r\nDMA_TO_DEVICE);\r\ndesc->dst_addr_l = ch->dxe_wq;\r\ndesc->fr_len = ctl->skb->len;\r\ndesc->ctrl = ch->ctrl_skb;\r\nwcn36xx_dbg_dump(WCN36XX_DBG_DXE_DUMP, "DESC2 >>> ",\r\n(char *)desc, sizeof(*desc));\r\nwcn36xx_dbg_dump(WCN36XX_DBG_DXE_DUMP, "SKB >>> ",\r\n(char *)ctl->skb->data, ctl->skb->len);\r\nch->head_blk_ctl = ctl->next;\r\nif (is_low && vif_priv->pw_state == WCN36XX_BMPS) {\r\nqcom_smem_state_update_bits(wcn->tx_rings_empty_state,\r\nWCN36XX_SMSM_WLAN_TX_ENABLE,\r\nWCN36XX_SMSM_WLAN_TX_ENABLE);\r\n} else {\r\nwcn36xx_dxe_write_register(wcn,\r\nch->reg_ctrl, ch->def_ctrl);\r\n}\r\nret = 0;\r\nunlock:\r\nspin_unlock_irqrestore(&ch->lock, flags);\r\nreturn ret;\r\n}\r\nint wcn36xx_dxe_init(struct wcn36xx *wcn)\r\n{\r\nint reg_data = 0, ret;\r\nreg_data = WCN36XX_DXE_REG_RESET;\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_REG_CSR_RESET, reg_data);\r\nreg_data = (WCN36XX_DXE_INT_CH3_MASK | WCN36XX_DXE_INT_CH1_MASK) << 16 |\r\nWCN36XX_DXE_INT_CH0_MASK | WCN36XX_DXE_INT_CH4_MASK;\r\nif (wcn->is_pronto)\r\nwcn36xx_ccu_write_register(wcn, WCN36XX_CCU_DXE_INT_SELECT_PRONTO, reg_data);\r\nelse\r\nwcn36xx_ccu_write_register(wcn, WCN36XX_CCU_DXE_INT_SELECT_RIVA, reg_data);\r\nwcn36xx_dxe_init_descs(wcn->dev, &wcn->dxe_tx_l_ch);\r\nwcn36xx_dxe_init_tx_bd(&wcn->dxe_tx_l_ch, &wcn->data_mem_pool);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_CH_NEXT_DESC_ADDR_TX_L,\r\nwcn->dxe_tx_l_ch.head_blk_ctl->desc_phy_addr);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_DEST_ADDR_TX_L,\r\nWCN36XX_DXE_WQ_TX_L);\r\nwcn36xx_dxe_read_register(wcn, WCN36XX_DXE_REG_CH_EN, &reg_data);\r\nwcn36xx_dxe_enable_ch_int(wcn, WCN36XX_INT_MASK_CHAN_TX_L);\r\nwcn36xx_dxe_init_descs(wcn->dev, &wcn->dxe_tx_h_ch);\r\nwcn36xx_dxe_init_tx_bd(&wcn->dxe_tx_h_ch, &wcn->mgmt_mem_pool);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_CH_NEXT_DESC_ADDR_TX_H,\r\nwcn->dxe_tx_h_ch.head_blk_ctl->desc_phy_addr);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_DEST_ADDR_TX_H,\r\nWCN36XX_DXE_WQ_TX_H);\r\nwcn36xx_dxe_read_register(wcn, WCN36XX_DXE_REG_CH_EN, &reg_data);\r\nwcn36xx_dxe_enable_ch_int(wcn, WCN36XX_INT_MASK_CHAN_TX_H);\r\nwcn36xx_dxe_init_descs(wcn->dev, &wcn->dxe_rx_l_ch);\r\nwcn36xx_dxe_ch_alloc_skb(wcn, &wcn->dxe_rx_l_ch);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_CH_NEXT_DESC_ADDR_RX_L,\r\nwcn->dxe_rx_l_ch.head_blk_ctl->desc_phy_addr);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_SRC_ADDR_RX_L,\r\nWCN36XX_DXE_WQ_RX_L);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_DEST_ADDR_RX_L,\r\nwcn->dxe_rx_l_ch.head_blk_ctl->desc->phy_next_l);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_REG_CTL_RX_L,\r\nWCN36XX_DXE_CH_DEFAULT_CTL_RX_L);\r\nwcn36xx_dxe_enable_ch_int(wcn, WCN36XX_INT_MASK_CHAN_RX_L);\r\nwcn36xx_dxe_init_descs(wcn->dev, &wcn->dxe_rx_h_ch);\r\nwcn36xx_dxe_ch_alloc_skb(wcn, &wcn->dxe_rx_h_ch);\r\nwcn36xx_dxe_write_register(wcn, WCN36XX_DXE_CH_NEXT_DESC_ADDR_RX_H,\r\nwcn->dxe_rx_h_ch.head_blk_ctl->desc_phy_addr);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_SRC_ADDR_RX_H,\r\nWCN36XX_DXE_WQ_RX_H);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_CH_DEST_ADDR_RX_H,\r\nwcn->dxe_rx_h_ch.head_blk_ctl->desc->phy_next_l);\r\nwcn36xx_dxe_write_register(wcn,\r\nWCN36XX_DXE_REG_CTL_RX_H,\r\nWCN36XX_DXE_CH_DEFAULT_CTL_RX_H);\r\nwcn36xx_dxe_enable_ch_int(wcn, WCN36XX_INT_MASK_CHAN_RX_H);\r\nret = wcn36xx_dxe_request_irqs(wcn);\r\nif (ret < 0)\r\ngoto out_err;\r\nreturn 0;\r\nout_err:\r\nreturn ret;\r\n}\r\nvoid wcn36xx_dxe_deinit(struct wcn36xx *wcn)\r\n{\r\nfree_irq(wcn->tx_irq, wcn);\r\nfree_irq(wcn->rx_irq, wcn);\r\nif (wcn->tx_ack_skb) {\r\nieee80211_tx_status_irqsafe(wcn->hw, wcn->tx_ack_skb);\r\nwcn->tx_ack_skb = NULL;\r\n}\r\nwcn36xx_dxe_ch_free_skbs(wcn, &wcn->dxe_rx_l_ch);\r\nwcn36xx_dxe_ch_free_skbs(wcn, &wcn->dxe_rx_h_ch);\r\n}

static int cs47l24_adsp_power_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nunsigned int v;\r\nint ret;\r\nret = regmap_read(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1, &v);\r\nif (ret != 0) {\r\ndev_err(codec->dev, "Failed to read SYSCLK state: %d\n", ret);\r\nreturn ret;\r\n}\r\nv = (v & ARIZONA_SYSCLK_FREQ_MASK) >> ARIZONA_SYSCLK_FREQ_SHIFT;\r\nreturn wm_adsp2_early_event(w, kcontrol, event, v);\r\n}\r\nstatic int cs47l24_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct cs47l24_priv *cs47l24 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase CS47L24_FLL1:\r\nreturn arizona_set_fll(&cs47l24->fll[0], source, Fref, Fout);\r\ncase CS47L24_FLL2:\r\nreturn arizona_set_fll(&cs47l24->fll[1], source, Fref, Fout);\r\ncase CS47L24_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&cs47l24->fll[0], source, Fref,\r\nFout);\r\ncase CS47L24_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&cs47l24->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int cs47l24_open(struct snd_compr_stream *stream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = stream->private_data;\r\nstruct cs47l24_priv *priv = snd_soc_platform_get_drvdata(rtd->platform);\r\nstruct arizona *arizona = priv->core.arizona;\r\nint n_adsp;\r\nif (strcmp(rtd->codec_dai->name, "cs47l24-dsp-voicectrl") == 0) {\r\nn_adsp = 2;\r\n} else if (strcmp(rtd->codec_dai->name, "cs47l24-dsp-trace") == 0) {\r\nn_adsp = 1;\r\n} else {\r\ndev_err(arizona->dev,\r\n"No suitable compressed stream for DAI '%s'\n",\r\nrtd->codec_dai->name);\r\nreturn -EINVAL;\r\n}\r\nreturn wm_adsp_compr_open(&priv->core.adsp[n_adsp], stream);\r\n}\r\nstatic irqreturn_t cs47l24_adsp2_irq(int irq, void *data)\r\n{\r\nstruct cs47l24_priv *priv = data;\r\nstruct arizona *arizona = priv->core.arizona;\r\nstruct arizona_voice_trigger_info info;\r\nint serviced = 0;\r\nint i, ret;\r\nfor (i = 1; i <= 2; ++i) {\r\nret = wm_adsp_compr_handle_irq(&priv->core.adsp[i]);\r\nif (ret != -ENODEV)\r\nserviced++;\r\nif (ret == WM_ADSP_COMPR_VOICE_TRIGGER) {\r\ninfo.core = i;\r\narizona_call_notifiers(arizona,\r\nARIZONA_NOTIFY_VOICE_TRIGGER,\r\n&info);\r\n}\r\n}\r\nif (!serviced) {\r\ndev_err(arizona->dev, "Spurious compressed data IRQ\n");\r\nreturn IRQ_NONE;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int cs47l24_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\r\nstruct cs47l24_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\npriv->core.arizona->dapm = dapm;\r\nret = arizona_init_spk(codec);\r\nif (ret < 0)\r\nreturn ret;\r\narizona_init_gpio(codec);\r\narizona_init_mono(codec);\r\narizona_init_notifiers(codec);\r\nret = wm_adsp2_codec_probe(&priv->core.adsp[1], codec);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\nret = wm_adsp2_codec_probe(&priv->core.adsp[2], codec);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\nret = snd_soc_add_codec_controls(codec,\r\n&arizona_adsp2_rate_controls[1], 2);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\nsnd_soc_component_disable_pin(component, "HAPTICS");\r\nreturn 0;\r\nerr_adsp2_codec_probe:\r\nwm_adsp2_codec_remove(&priv->core.adsp[1], codec);\r\nwm_adsp2_codec_remove(&priv->core.adsp[2], codec);\r\nreturn ret;\r\n}\r\nstatic int cs47l24_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct cs47l24_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nwm_adsp2_codec_remove(&priv->core.adsp[1], codec);\r\nwm_adsp2_codec_remove(&priv->core.adsp[2], codec);\r\npriv->core.arizona->dapm = NULL;\r\nreturn 0;\r\n}\r\nstatic struct regmap *cs47l24_get_regmap(struct device *dev)\r\n{\r\nstruct cs47l24_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int cs47l24_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct cs47l24_priv *cs47l24;\r\nint i, ret;\r\nBUILD_BUG_ON(ARRAY_SIZE(cs47l24_dai) > ARIZONA_MAX_DAI);\r\ncs47l24 = devm_kzalloc(&pdev->dev, sizeof(struct cs47l24_priv),\r\nGFP_KERNEL);\r\nif (!cs47l24)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, cs47l24);\r\ncs47l24->core.arizona = arizona;\r\ncs47l24->core.num_inputs = 4;\r\nfor (i = 1; i <= 2; i++) {\r\ncs47l24->core.adsp[i].part = "cs47l24";\r\ncs47l24->core.adsp[i].num = i + 1;\r\ncs47l24->core.adsp[i].type = WMFW_ADSP2;\r\ncs47l24->core.adsp[i].dev = arizona->dev;\r\ncs47l24->core.adsp[i].regmap = arizona->regmap;\r\ncs47l24->core.adsp[i].base = ARIZONA_DSP1_CONTROL_1 +\r\n(0x100 * i);\r\ncs47l24->core.adsp[i].mem = cs47l24_dsp_regions[i - 1];\r\ncs47l24->core.adsp[i].num_mems =\r\nARRAY_SIZE(cs47l24_dsp2_regions);\r\nret = wm_adsp2_init(&cs47l24->core.adsp[i]);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(cs47l24->fll); i++)\r\ncs47l24->fll[i].vco_mult = 3;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&cs47l24->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&cs47l24->fll[1]);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_2,\r\nARIZONA_SAMPLE_RATE_2_MASK, 0x11);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_3,\r\nARIZONA_SAMPLE_RATE_3_MASK, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(cs47l24_dai); i++)\r\narizona_init_dai(&cs47l24->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(cs47l24_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, cs47l24_digital_vu[i],\r\nCS47L24_DIG_VU, CS47L24_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nret = arizona_request_irq(arizona, ARIZONA_IRQ_DSP_IRQ1,\r\n"ADSP2 Compressed IRQ", cs47l24_adsp2_irq,\r\ncs47l24);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request DSP IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = arizona_init_spk_irqs(arizona);\r\nif (ret < 0)\r\ngoto err_dsp_irq;\r\nret = snd_soc_register_platform(&pdev->dev, &cs47l24_compr_platform);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register platform: %d\n", ret);\r\ngoto err_spk_irqs;\r\n}\r\nret = snd_soc_register_codec(&pdev->dev, &soc_codec_dev_cs47l24,\r\ncs47l24_dai, ARRAY_SIZE(cs47l24_dai));\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register codec: %d\n", ret);\r\ngoto err_platform;\r\n}\r\nreturn ret;\r\nerr_platform:\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nerr_spk_irqs:\r\narizona_free_spk_irqs(arizona);\r\nerr_dsp_irq:\r\narizona_free_irq(arizona, ARIZONA_IRQ_DSP_IRQ1, cs47l24);\r\nreturn ret;\r\n}\r\nstatic int cs47l24_remove(struct platform_device *pdev)\r\n{\r\nstruct cs47l24_priv *cs47l24 = platform_get_drvdata(pdev);\r\nstruct arizona *arizona = cs47l24->core.arizona;\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nwm_adsp2_remove(&cs47l24->core.adsp[1]);\r\nwm_adsp2_remove(&cs47l24->core.adsp[2]);\r\narizona_free_spk_irqs(arizona);\r\narizona_free_irq(arizona, ARIZONA_IRQ_DSP_IRQ1, cs47l24);\r\nreturn 0;\r\n}

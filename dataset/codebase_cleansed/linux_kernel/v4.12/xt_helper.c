static bool\r\nhelper_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_helper_info *info = par->matchinfo;\r\nconst struct nf_conn *ct;\r\nconst struct nf_conn_help *master_help;\r\nconst struct nf_conntrack_helper *helper;\r\nenum ip_conntrack_info ctinfo;\r\nbool ret = info->invert;\r\nct = nf_ct_get(skb, &ctinfo);\r\nif (!ct || !ct->master)\r\nreturn ret;\r\nmaster_help = nfct_help(ct->master);\r\nif (!master_help)\r\nreturn ret;\r\nhelper = rcu_dereference(master_help->helper);\r\nif (!helper)\r\nreturn ret;\r\nif (info->name[0] == '\0')\r\nret = !ret;\r\nelse\r\nret ^= !strncmp(helper->name, info->name,\r\nstrlen(helper->name));\r\nreturn ret;\r\n}\r\nstatic int helper_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_helper_info *info = par->matchinfo;\r\nint ret;\r\nret = nf_ct_netns_get(par->net, par->family);\r\nif (ret < 0) {\r\npr_info("cannot load conntrack support for proto=%u\n",\r\npar->family);\r\nreturn ret;\r\n}\r\ninfo->name[sizeof(info->name) - 1] = '\0';\r\nreturn 0;\r\n}\r\nstatic void helper_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nnf_ct_netns_put(par->net, par->family);\r\n}\r\nstatic int __init helper_mt_init(void)\r\n{\r\nreturn xt_register_match(&helper_mt_reg);\r\n}\r\nstatic void __exit helper_mt_exit(void)\r\n{\r\nxt_unregister_match(&helper_mt_reg);\r\n}

static int zynq_pctrl_get_groups_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctrl->ngroups;\r\n}\r\nstatic const char *zynq_pctrl_get_group_name(struct pinctrl_dev *pctldev,\r\nunsigned selector)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctrl->groups[selector].name;\r\n}\r\nstatic int zynq_pctrl_get_group_pins(struct pinctrl_dev *pctldev,\r\nunsigned selector,\r\nconst unsigned **pins,\r\nunsigned *num_pins)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\n*pins = pctrl->groups[selector].pins;\r\n*num_pins = pctrl->groups[selector].npins;\r\nreturn 0;\r\n}\r\nstatic int zynq_pmux_get_functions_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctrl->nfuncs;\r\n}\r\nstatic const char *zynq_pmux_get_function_name(struct pinctrl_dev *pctldev,\r\nunsigned selector)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctrl->funcs[selector].name;\r\n}\r\nstatic int zynq_pmux_get_function_groups(struct pinctrl_dev *pctldev,\r\nunsigned selector,\r\nconst char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\n*groups = pctrl->funcs[selector].groups;\r\n*num_groups = pctrl->funcs[selector].ngroups;\r\nreturn 0;\r\n}\r\nstatic int zynq_pinmux_set_mux(struct pinctrl_dev *pctldev,\r\nunsigned function,\r\nunsigned group)\r\n{\r\nint i, ret;\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nconst struct zynq_pctrl_group *pgrp = &pctrl->groups[group];\r\nconst struct zynq_pinmux_function *func = &pctrl->funcs[function];\r\nif (function == ZYNQ_PMUX_sdio0_cd || function == ZYNQ_PMUX_sdio0_wp ||\r\nfunction == ZYNQ_PMUX_sdio1_cd ||\r\nfunction == ZYNQ_PMUX_sdio1_wp) {\r\nu32 reg;\r\nret = regmap_read(pctrl->syscon,\r\npctrl->pctrl_offset + func->mux, &reg);\r\nif (ret)\r\nreturn ret;\r\nreg &= ~func->mux_mask;\r\nreg |= pgrp->pins[0] << func->mux_shift;\r\nret = regmap_write(pctrl->syscon,\r\npctrl->pctrl_offset + func->mux, reg);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nfor (i = 0; i < pgrp->npins; i++) {\r\nunsigned int pin = pgrp->pins[i];\r\nu32 reg, addr = pctrl->pctrl_offset + (4 * pin);\r\nret = regmap_read(pctrl->syscon, addr, &reg);\r\nif (ret)\r\nreturn ret;\r\nreg &= ~ZYNQ_PINMUX_MUX_MASK;\r\nreg |= func->mux_val << ZYNQ_PINMUX_MUX_SHIFT;\r\nret = regmap_write(pctrl->syscon, addr, reg);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int zynq_pinconf_iostd_get(u32 reg)\r\n{\r\nreturn (reg & ZYNQ_PINCONF_IOTYPE_MASK) >> ZYNQ_PINCONF_IOTYPE_SHIFT;\r\n}\r\nstatic int zynq_pinconf_cfg_get(struct pinctrl_dev *pctldev,\r\nunsigned pin,\r\nunsigned long *config)\r\n{\r\nu32 reg;\r\nint ret;\r\nunsigned int arg = 0;\r\nunsigned int param = pinconf_to_config_param(*config);\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nif (pin >= ZYNQ_NUM_MIOS)\r\nreturn -ENOTSUPP;\r\nret = regmap_read(pctrl->syscon, pctrl->pctrl_offset + (4 * pin), &reg);\r\nif (ret)\r\nreturn -EIO;\r\nswitch (param) {\r\ncase PIN_CONFIG_BIAS_PULL_UP:\r\nif (!(reg & ZYNQ_PINCONF_PULLUP))\r\nreturn -EINVAL;\r\narg = 1;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_HIGH_IMPEDANCE:\r\nif (!(reg & ZYNQ_PINCONF_TRISTATE))\r\nreturn -EINVAL;\r\narg = 1;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_DISABLE:\r\nif (reg & ZYNQ_PINCONF_PULLUP || reg & ZYNQ_PINCONF_TRISTATE)\r\nreturn -EINVAL;\r\nbreak;\r\ncase PIN_CONFIG_SLEW_RATE:\r\narg = !!(reg & ZYNQ_PINCONF_SPEED);\r\nbreak;\r\ncase PIN_CONFIG_LOW_POWER_MODE:\r\n{\r\nenum zynq_io_standards iostd = zynq_pinconf_iostd_get(reg);\r\nif (iostd != zynq_iostd_hstl)\r\nreturn -EINVAL;\r\nif (!(reg & ZYNQ_PINCONF_DISABLE_RECVR))\r\nreturn -EINVAL;\r\narg = !!(reg & ZYNQ_PINCONF_DISABLE_RECVR);\r\nbreak;\r\n}\r\ncase PIN_CONFIG_IOSTANDARD:\r\narg = zynq_pinconf_iostd_get(reg);\r\nbreak;\r\ndefault:\r\nreturn -ENOTSUPP;\r\n}\r\n*config = pinconf_to_config_packed(param, arg);\r\nreturn 0;\r\n}\r\nstatic int zynq_pinconf_cfg_set(struct pinctrl_dev *pctldev,\r\nunsigned pin,\r\nunsigned long *configs,\r\nunsigned num_configs)\r\n{\r\nint i, ret;\r\nu32 reg;\r\nu32 pullup = 0;\r\nu32 tristate = 0;\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nif (pin >= ZYNQ_NUM_MIOS)\r\nreturn -ENOTSUPP;\r\nret = regmap_read(pctrl->syscon, pctrl->pctrl_offset + (4 * pin), &reg);\r\nif (ret)\r\nreturn -EIO;\r\nfor (i = 0; i < num_configs; i++) {\r\nunsigned int param = pinconf_to_config_param(configs[i]);\r\nunsigned int arg = pinconf_to_config_argument(configs[i]);\r\nswitch (param) {\r\ncase PIN_CONFIG_BIAS_PULL_UP:\r\npullup = ZYNQ_PINCONF_PULLUP;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_HIGH_IMPEDANCE:\r\ntristate = ZYNQ_PINCONF_TRISTATE;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_DISABLE:\r\nreg &= ~(ZYNQ_PINCONF_PULLUP | ZYNQ_PINCONF_TRISTATE);\r\nbreak;\r\ncase PIN_CONFIG_SLEW_RATE:\r\nif (arg)\r\nreg |= ZYNQ_PINCONF_SPEED;\r\nelse\r\nreg &= ~ZYNQ_PINCONF_SPEED;\r\nbreak;\r\ncase PIN_CONFIG_IOSTANDARD:\r\nif (arg <= zynq_iostd_min || arg >= zynq_iostd_max) {\r\ndev_warn(pctldev->dev,\r\n"unsupported IO standard '%u'\n",\r\nparam);\r\nbreak;\r\n}\r\nreg &= ~ZYNQ_PINCONF_IOTYPE_MASK;\r\nreg |= arg << ZYNQ_PINCONF_IOTYPE_SHIFT;\r\nbreak;\r\ncase PIN_CONFIG_LOW_POWER_MODE:\r\nif (arg)\r\nreg |= ZYNQ_PINCONF_DISABLE_RECVR;\r\nelse\r\nreg &= ~ZYNQ_PINCONF_DISABLE_RECVR;\r\nbreak;\r\ndefault:\r\ndev_warn(pctldev->dev,\r\n"unsupported configuration parameter '%u'\n",\r\nparam);\r\ncontinue;\r\n}\r\n}\r\nif (tristate || pullup) {\r\nreg &= ~(ZYNQ_PINCONF_PULLUP | ZYNQ_PINCONF_TRISTATE);\r\nreg |= tristate | pullup;\r\n}\r\nret = regmap_write(pctrl->syscon, pctrl->pctrl_offset + (4 * pin), reg);\r\nif (ret)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int zynq_pinconf_group_set(struct pinctrl_dev *pctldev,\r\nunsigned selector,\r\nunsigned long *configs,\r\nunsigned num_configs)\r\n{\r\nint i, ret;\r\nstruct zynq_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\r\nconst struct zynq_pctrl_group *pgrp = &pctrl->groups[selector];\r\nfor (i = 0; i < pgrp->npins; i++) {\r\nret = zynq_pinconf_cfg_set(pctldev, pgrp->pins[i], configs,\r\nnum_configs);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int zynq_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct zynq_pinctrl *pctrl;\r\npctrl = devm_kzalloc(&pdev->dev, sizeof(*pctrl), GFP_KERNEL);\r\nif (!pctrl)\r\nreturn -ENOMEM;\r\npctrl->syscon = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\r\n"syscon");\r\nif (IS_ERR(pctrl->syscon)) {\r\ndev_err(&pdev->dev, "unable to get syscon\n");\r\nreturn PTR_ERR(pctrl->syscon);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "missing IO resource\n");\r\nreturn -ENODEV;\r\n}\r\npctrl->pctrl_offset = res->start;\r\npctrl->groups = zynq_pctrl_groups;\r\npctrl->ngroups = ARRAY_SIZE(zynq_pctrl_groups);\r\npctrl->funcs = zynq_pmux_functions;\r\npctrl->nfuncs = ARRAY_SIZE(zynq_pmux_functions);\r\npctrl->pctrl = devm_pinctrl_register(&pdev->dev, &zynq_desc, pctrl);\r\nif (IS_ERR(pctrl->pctrl))\r\nreturn PTR_ERR(pctrl->pctrl);\r\nplatform_set_drvdata(pdev, pctrl);\r\ndev_info(&pdev->dev, "zynq pinctrl initialized\n");\r\nreturn 0;\r\n}\r\nstatic int __init zynq_pinctrl_init(void)\r\n{\r\nreturn platform_driver_register(&zynq_pinctrl_driver);\r\n}

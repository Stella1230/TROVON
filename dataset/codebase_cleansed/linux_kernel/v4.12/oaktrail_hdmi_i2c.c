static void hdmi_i2c_irq_enable(struct oaktrail_hdmi_dev *hdmi_dev)\r\n{\r\nu32 temp;\r\ntemp = HDMI_READ(HDMI_HICR);\r\ntemp |= (HDMI_INTR_I2C_ERROR | HDMI_INTR_I2C_FULL | HDMI_INTR_I2C_DONE);\r\nHDMI_WRITE(HDMI_HICR, temp);\r\nHDMI_READ(HDMI_HICR);\r\n}\r\nstatic void hdmi_i2c_irq_disable(struct oaktrail_hdmi_dev *hdmi_dev)\r\n{\r\nHDMI_WRITE(HDMI_HICR, 0x0);\r\nHDMI_READ(HDMI_HICR);\r\n}\r\nstatic int xfer_read(struct i2c_adapter *adap, struct i2c_msg *pmsg)\r\n{\r\nstruct oaktrail_hdmi_dev *hdmi_dev = i2c_get_adapdata(adap);\r\nstruct hdmi_i2c_dev *i2c_dev = hdmi_dev->i2c_dev;\r\nu32 temp;\r\ni2c_dev->status = I2C_STAT_INIT;\r\ni2c_dev->msg = pmsg;\r\ni2c_dev->buf_offset = 0;\r\nreinit_completion(&i2c_dev->complete);\r\ntemp = ((pmsg->len) << 20) | HI2C_EDID_READ | HI2C_ENABLE_TRANSACTION;\r\nHDMI_WRITE(HDMI_HI2CHCR, temp);\r\nHDMI_READ(HDMI_HI2CHCR);\r\nwhile (i2c_dev->status != I2C_TRANSACTION_DONE)\r\nwait_for_completion_interruptible_timeout(&i2c_dev->complete,\r\n10 * HZ);\r\nreturn 0;\r\n}\r\nstatic int xfer_write(struct i2c_adapter *adap, struct i2c_msg *pmsg)\r\n{\r\nreturn 0;\r\n}\r\nstatic int oaktrail_hdmi_i2c_access(struct i2c_adapter *adap,\r\nstruct i2c_msg *pmsg,\r\nint num)\r\n{\r\nstruct oaktrail_hdmi_dev *hdmi_dev = i2c_get_adapdata(adap);\r\nstruct hdmi_i2c_dev *i2c_dev = hdmi_dev->i2c_dev;\r\nint i;\r\nmutex_lock(&i2c_dev->i2c_lock);\r\nHDMI_WRITE(HDMI_ICRH, 0x00008760);\r\nhdmi_i2c_irq_enable(hdmi_dev);\r\nfor (i = 0; i < num; i++) {\r\nif (pmsg->len && pmsg->buf) {\r\nif (pmsg->flags & I2C_M_RD)\r\nxfer_read(adap, pmsg);\r\nelse\r\nxfer_write(adap, pmsg);\r\n}\r\npmsg++;\r\n}\r\nhdmi_i2c_irq_disable(hdmi_dev);\r\nmutex_unlock(&i2c_dev->i2c_lock);\r\nreturn i;\r\n}\r\nstatic u32 oaktrail_hdmi_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_10BIT_ADDR;\r\n}\r\nstatic void hdmi_i2c_read(struct oaktrail_hdmi_dev *hdmi_dev)\r\n{\r\nstruct hdmi_i2c_dev *i2c_dev = hdmi_dev->i2c_dev;\r\nstruct i2c_msg *msg = i2c_dev->msg;\r\nu8 *buf = msg->buf;\r\nu32 temp;\r\nint i, offset;\r\noffset = i2c_dev->buf_offset;\r\nfor (i = 0; i < 0x10; i++) {\r\ntemp = HDMI_READ(HDMI_HI2CRDB0 + (i * 4));\r\nmemcpy(buf + (offset + i * 4), &temp, 4);\r\n}\r\ni2c_dev->buf_offset += (0x10 * 4);\r\ntemp = HDMI_READ(HDMI_HISR);\r\nHDMI_WRITE(HDMI_HISR, temp | HDMI_INTR_I2C_FULL);\r\nHDMI_READ(HDMI_HISR);\r\ntemp = HDMI_READ(HDMI_HI2CHCR);\r\nHDMI_WRITE(HDMI_HI2CHCR, temp | HI2C_READ_CONTINUE);\r\nHDMI_READ(HDMI_HI2CHCR);\r\ni2c_dev->status = I2C_READ_DONE;\r\nreturn;\r\n}\r\nstatic void hdmi_i2c_transaction_done(struct oaktrail_hdmi_dev *hdmi_dev)\r\n{\r\nstruct hdmi_i2c_dev *i2c_dev = hdmi_dev->i2c_dev;\r\nu32 temp;\r\ntemp = HDMI_READ(HDMI_HISR);\r\nHDMI_WRITE(HDMI_HISR, temp | HDMI_INTR_I2C_DONE);\r\nHDMI_READ(HDMI_HISR);\r\ntemp = HDMI_READ(HDMI_HI2CHCR);\r\nHDMI_WRITE(HDMI_HI2CHCR, temp & ~HI2C_ENABLE_TRANSACTION);\r\nHDMI_READ(HDMI_HI2CHCR);\r\ni2c_dev->status = I2C_TRANSACTION_DONE;\r\nreturn;\r\n}\r\nstatic irqreturn_t oaktrail_hdmi_i2c_handler(int this_irq, void *dev)\r\n{\r\nstruct oaktrail_hdmi_dev *hdmi_dev = dev;\r\nstruct hdmi_i2c_dev *i2c_dev = hdmi_dev->i2c_dev;\r\nu32 stat;\r\nstat = HDMI_READ(HDMI_HISR);\r\nif (stat & HDMI_INTR_HPD) {\r\nHDMI_WRITE(HDMI_HISR, stat | HDMI_INTR_HPD);\r\nHDMI_READ(HDMI_HISR);\r\n}\r\nif (stat & HDMI_INTR_I2C_FULL)\r\nhdmi_i2c_read(hdmi_dev);\r\nif (stat & HDMI_INTR_I2C_DONE)\r\nhdmi_i2c_transaction_done(hdmi_dev);\r\ncomplete(&i2c_dev->complete);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void oaktrail_hdmi_i2c_gpio_fix(void)\r\n{\r\nvoid __iomem *base;\r\nunsigned int gpio_base = 0xff12c000;\r\nint gpio_len = 0x1000;\r\nu32 temp;\r\nbase = ioremap((resource_size_t)gpio_base, gpio_len);\r\nif (base == NULL) {\r\nDRM_ERROR("gpio ioremap fail\n");\r\nreturn;\r\n}\r\ntemp = readl(base + 0x44);\r\nDRM_DEBUG_DRIVER("old gpio val %x\n", temp);\r\nwritel((temp | 0x00000a00), (base + 0x44));\r\ntemp = readl(base + 0x44);\r\nDRM_DEBUG_DRIVER("new gpio val %x\n", temp);\r\niounmap(base);\r\n}\r\nint oaktrail_hdmi_i2c_init(struct pci_dev *dev)\r\n{\r\nstruct oaktrail_hdmi_dev *hdmi_dev;\r\nstruct hdmi_i2c_dev *i2c_dev;\r\nint ret;\r\nhdmi_dev = pci_get_drvdata(dev);\r\ni2c_dev = kzalloc(sizeof(struct hdmi_i2c_dev), GFP_KERNEL);\r\nif (i2c_dev == NULL) {\r\nDRM_ERROR("Can't allocate interface\n");\r\nret = -ENOMEM;\r\ngoto exit;\r\n}\r\ni2c_dev->adap = &oaktrail_hdmi_i2c_adapter;\r\ni2c_dev->status = I2C_STAT_INIT;\r\ninit_completion(&i2c_dev->complete);\r\nmutex_init(&i2c_dev->i2c_lock);\r\ni2c_set_adapdata(&oaktrail_hdmi_i2c_adapter, hdmi_dev);\r\nhdmi_dev->i2c_dev = i2c_dev;\r\noaktrail_hdmi_i2c_gpio_fix();\r\nret = request_irq(dev->irq, oaktrail_hdmi_i2c_handler, IRQF_SHARED,\r\noaktrail_hdmi_i2c_adapter.name, hdmi_dev);\r\nif (ret) {\r\nDRM_ERROR("Failed to request IRQ for I2C controller\n");\r\ngoto err;\r\n}\r\nret = i2c_add_numbered_adapter(&oaktrail_hdmi_i2c_adapter);\r\nreturn ret;\r\nerr:\r\nkfree(i2c_dev);\r\nexit:\r\nreturn ret;\r\n}\r\nvoid oaktrail_hdmi_i2c_exit(struct pci_dev *dev)\r\n{\r\nstruct oaktrail_hdmi_dev *hdmi_dev;\r\nstruct hdmi_i2c_dev *i2c_dev;\r\nhdmi_dev = pci_get_drvdata(dev);\r\ni2c_del_adapter(&oaktrail_hdmi_i2c_adapter);\r\ni2c_dev = hdmi_dev->i2c_dev;\r\nkfree(i2c_dev);\r\nfree_irq(dev->irq, hdmi_dev);\r\n}

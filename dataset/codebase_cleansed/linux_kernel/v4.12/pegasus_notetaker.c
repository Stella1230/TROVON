static int pegasus_control_msg(struct pegasus *pegasus, u8 *data, int len)\r\n{\r\nconst int sizeof_buf = len + 2;\r\nint result;\r\nint error;\r\nu8 *cmd_buf;\r\ncmd_buf = kmalloc(sizeof_buf, GFP_KERNEL);\r\nif (!cmd_buf)\r\nreturn -ENOMEM;\r\ncmd_buf[0] = NOTETAKER_REPORT_ID;\r\ncmd_buf[1] = len;\r\nmemcpy(cmd_buf + 2, data, len);\r\nresult = usb_control_msg(pegasus->usbdev,\r\nusb_sndctrlpipe(pegasus->usbdev, 0),\r\nUSB_REQ_SET_REPORT,\r\nUSB_TYPE_VENDOR | USB_DIR_OUT,\r\n0, 0, cmd_buf, sizeof_buf,\r\nUSB_CTRL_SET_TIMEOUT);\r\nkfree(cmd_buf);\r\nif (unlikely(result != sizeof_buf)) {\r\nerror = result < 0 ? result : -EIO;\r\ndev_err(&pegasus->usbdev->dev, "control msg error: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pegasus_set_mode(struct pegasus *pegasus, u8 mode, u8 led)\r\n{\r\nu8 cmd[] = { NOTETAKER_SET_CMD, NOTETAKER_SET_MODE, led, mode };\r\nreturn pegasus_control_msg(pegasus, cmd, sizeof(cmd));\r\n}\r\nstatic void pegasus_parse_packet(struct pegasus *pegasus)\r\n{\r\nunsigned char *data = pegasus->data;\r\nstruct input_dev *dev = pegasus->dev;\r\nu16 x, y;\r\nswitch (data[0]) {\r\ncase SPECIAL_COMMAND:\r\nif (data[1] == BUTTON_PRESSED)\r\nschedule_work(&pegasus->init);\r\nbreak;\r\ncase BATTERY_LOW:\r\ndev_warn_once(&dev->dev, "Pen battery low\n");\r\ncase BATTERY_NO_REPORT:\r\ncase BATTERY_GOOD:\r\nx = le16_to_cpup((__le16 *)&data[2]);\r\ny = le16_to_cpup((__le16 *)&data[4]);\r\nif (x == 0 && y == 0)\r\nbreak;\r\ninput_report_key(dev, BTN_TOUCH, data[1] & PEN_TIP);\r\ninput_report_key(dev, BTN_RIGHT, data[1] & PEN_BUTTON_PRESSED);\r\ninput_report_key(dev, BTN_TOOL_PEN, 1);\r\ninput_report_abs(dev, ABS_X, (s16)x);\r\ninput_report_abs(dev, ABS_Y, y);\r\ninput_sync(dev);\r\nbreak;\r\ndefault:\r\ndev_warn_once(&pegasus->usbdev->dev,\r\n"unknown answer from device\n");\r\n}\r\n}\r\nstatic void pegasus_irq(struct urb *urb)\r\n{\r\nstruct pegasus *pegasus = urb->context;\r\nstruct usb_device *dev = pegasus->usbdev;\r\nint retval;\r\nswitch (urb->status) {\r\ncase 0:\r\npegasus_parse_packet(pegasus);\r\nusb_mark_last_busy(pegasus->usbdev);\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ndev_err(&dev->dev, "%s - urb shutting down with status: %d",\r\n__func__, urb->status);\r\nreturn;\r\ndefault:\r\ndev_err(&dev->dev, "%s - nonzero urb status received: %d",\r\n__func__, urb->status);\r\nbreak;\r\n}\r\nretval = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (retval)\r\ndev_err(&dev->dev, "%s - usb_submit_urb failed with result %d",\r\n__func__, retval);\r\n}\r\nstatic void pegasus_init(struct work_struct *work)\r\n{\r\nstruct pegasus *pegasus = container_of(work, struct pegasus, init);\r\nint error;\r\nerror = pegasus_set_mode(pegasus, PEN_MODE_XY, NOTETAKER_LED_MOUSE);\r\nif (error)\r\ndev_err(&pegasus->usbdev->dev, "pegasus_set_mode error: %d\n",\r\nerror);\r\n}\r\nstatic int pegasus_open(struct input_dev *dev)\r\n{\r\nstruct pegasus *pegasus = input_get_drvdata(dev);\r\nint error;\r\nerror = usb_autopm_get_interface(pegasus->intf);\r\nif (error)\r\nreturn error;\r\npegasus->irq->dev = pegasus->usbdev;\r\nif (usb_submit_urb(pegasus->irq, GFP_KERNEL)) {\r\nerror = -EIO;\r\ngoto err_autopm_put;\r\n}\r\nerror = pegasus_set_mode(pegasus, PEN_MODE_XY, NOTETAKER_LED_MOUSE);\r\nif (error)\r\ngoto err_kill_urb;\r\nreturn 0;\r\nerr_kill_urb:\r\nusb_kill_urb(pegasus->irq);\r\ncancel_work_sync(&pegasus->init);\r\nerr_autopm_put:\r\nusb_autopm_put_interface(pegasus->intf);\r\nreturn error;\r\n}\r\nstatic void pegasus_close(struct input_dev *dev)\r\n{\r\nstruct pegasus *pegasus = input_get_drvdata(dev);\r\nusb_kill_urb(pegasus->irq);\r\ncancel_work_sync(&pegasus->init);\r\nusb_autopm_put_interface(pegasus->intf);\r\n}\r\nstatic int pegasus_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct usb_endpoint_descriptor *endpoint;\r\nstruct pegasus *pegasus;\r\nstruct input_dev *input_dev;\r\nint error;\r\nint pipe;\r\nif (intf->cur_altsetting->desc.bInterfaceNumber >= 1)\r\nreturn -ENODEV;\r\nif (intf->altsetting[0].desc.bNumEndpoints < 1) {\r\ndev_err(&intf->dev, "Invalid number of endpoints\n");\r\nreturn -EINVAL;\r\n}\r\nendpoint = &intf->cur_altsetting->endpoint[0].desc;\r\npegasus = kzalloc(sizeof(*pegasus), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!pegasus || !input_dev) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\npegasus->usbdev = dev;\r\npegasus->dev = input_dev;\r\npegasus->intf = intf;\r\npipe = usb_rcvintpipe(dev, endpoint->bEndpointAddress);\r\npegasus->data_len = usb_maxpacket(dev, pipe, usb_pipeout(pipe));\r\npegasus->data = usb_alloc_coherent(dev, pegasus->data_len, GFP_KERNEL,\r\n&pegasus->data_dma);\r\nif (!pegasus->data) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\npegasus->irq = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!pegasus->irq) {\r\nerror = -ENOMEM;\r\ngoto err_free_dma;\r\n}\r\nusb_fill_int_urb(pegasus->irq, dev, pipe,\r\npegasus->data, pegasus->data_len,\r\npegasus_irq, pegasus, endpoint->bInterval);\r\npegasus->irq->transfer_dma = pegasus->data_dma;\r\npegasus->irq->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\r\nif (dev->manufacturer)\r\nstrlcpy(pegasus->name, dev->manufacturer,\r\nsizeof(pegasus->name));\r\nif (dev->product) {\r\nif (dev->manufacturer)\r\nstrlcat(pegasus->name, " ", sizeof(pegasus->name));\r\nstrlcat(pegasus->name, dev->product, sizeof(pegasus->name));\r\n}\r\nif (!strlen(pegasus->name))\r\nsnprintf(pegasus->name, sizeof(pegasus->name),\r\n"USB Pegasus Device %04x:%04x",\r\nle16_to_cpu(dev->descriptor.idVendor),\r\nle16_to_cpu(dev->descriptor.idProduct));\r\nusb_make_path(dev, pegasus->phys, sizeof(pegasus->phys));\r\nstrlcat(pegasus->phys, "/input0", sizeof(pegasus->phys));\r\nINIT_WORK(&pegasus->init, pegasus_init);\r\nusb_set_intfdata(intf, pegasus);\r\ninput_dev->name = pegasus->name;\r\ninput_dev->phys = pegasus->phys;\r\nusb_to_input_id(dev, &input_dev->id);\r\ninput_dev->dev.parent = &intf->dev;\r\ninput_set_drvdata(input_dev, pegasus);\r\ninput_dev->open = pegasus_open;\r\ninput_dev->close = pegasus_close;\r\n__set_bit(EV_ABS, input_dev->evbit);\r\n__set_bit(EV_KEY, input_dev->evbit);\r\n__set_bit(ABS_X, input_dev->absbit);\r\n__set_bit(ABS_Y, input_dev->absbit);\r\n__set_bit(BTN_TOUCH, input_dev->keybit);\r\n__set_bit(BTN_RIGHT, input_dev->keybit);\r\n__set_bit(BTN_TOOL_PEN, input_dev->keybit);\r\n__set_bit(INPUT_PROP_DIRECT, input_dev->propbit);\r\n__set_bit(INPUT_PROP_POINTER, input_dev->propbit);\r\ninput_set_abs_params(input_dev, ABS_X, -1500, 1500, 8, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 1600, 3000, 8, 0);\r\nerror = input_register_device(pegasus->dev);\r\nif (error)\r\ngoto err_free_urb;\r\nreturn 0;\r\nerr_free_urb:\r\nusb_free_urb(pegasus->irq);\r\nerr_free_dma:\r\nusb_free_coherent(dev, pegasus->data_len,\r\npegasus->data, pegasus->data_dma);\r\nerr_free_mem:\r\ninput_free_device(input_dev);\r\nkfree(pegasus);\r\nusb_set_intfdata(intf, NULL);\r\nreturn error;\r\n}\r\nstatic void pegasus_disconnect(struct usb_interface *intf)\r\n{\r\nstruct pegasus *pegasus = usb_get_intfdata(intf);\r\ninput_unregister_device(pegasus->dev);\r\nusb_free_urb(pegasus->irq);\r\nusb_free_coherent(interface_to_usbdev(intf),\r\npegasus->data_len, pegasus->data,\r\npegasus->data_dma);\r\nkfree(pegasus);\r\nusb_set_intfdata(intf, NULL);\r\n}\r\nstatic int pegasus_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nstruct pegasus *pegasus = usb_get_intfdata(intf);\r\nmutex_lock(&pegasus->dev->mutex);\r\nusb_kill_urb(pegasus->irq);\r\ncancel_work_sync(&pegasus->init);\r\nmutex_unlock(&pegasus->dev->mutex);\r\nreturn 0;\r\n}\r\nstatic int pegasus_resume(struct usb_interface *intf)\r\n{\r\nstruct pegasus *pegasus = usb_get_intfdata(intf);\r\nint retval = 0;\r\nmutex_lock(&pegasus->dev->mutex);\r\nif (pegasus->dev->users && usb_submit_urb(pegasus->irq, GFP_NOIO) < 0)\r\nretval = -EIO;\r\nmutex_unlock(&pegasus->dev->mutex);\r\nreturn retval;\r\n}\r\nstatic int pegasus_reset_resume(struct usb_interface *intf)\r\n{\r\nstruct pegasus *pegasus = usb_get_intfdata(intf);\r\nint retval = 0;\r\nmutex_lock(&pegasus->dev->mutex);\r\nif (pegasus->dev->users) {\r\nretval = pegasus_set_mode(pegasus, PEN_MODE_XY,\r\nNOTETAKER_LED_MOUSE);\r\nif (!retval && usb_submit_urb(pegasus->irq, GFP_NOIO) < 0)\r\nretval = -EIO;\r\n}\r\nmutex_unlock(&pegasus->dev->mutex);\r\nreturn retval;\r\n}

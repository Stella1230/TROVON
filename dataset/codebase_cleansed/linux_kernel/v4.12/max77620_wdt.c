static int max77620_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nreturn regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL2,\r\nMAX77620_WDTEN, MAX77620_WDTEN);\r\n}\r\nstatic int max77620_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nreturn regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL2,\r\nMAX77620_WDTEN, 0);\r\n}\r\nstatic int max77620_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nreturn regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL3,\r\nMAX77620_WDTC_MASK, 0x1);\r\n}\r\nstatic int max77620_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned int wdt_timeout;\r\nu8 regval;\r\nint ret;\r\nswitch (timeout) {\r\ncase 0 ... 2:\r\nregval = MAX77620_TWD_2s;\r\nwdt_timeout = 2;\r\nbreak;\r\ncase 3 ... 16:\r\nregval = MAX77620_TWD_16s;\r\nwdt_timeout = 16;\r\nbreak;\r\ncase 17 ... 64:\r\nregval = MAX77620_TWD_64s;\r\nwdt_timeout = 64;\r\nbreak;\r\ndefault:\r\nregval = MAX77620_TWD_128s;\r\nwdt_timeout = 128;\r\nbreak;\r\n}\r\nret = regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL3,\r\nMAX77620_WDTC_MASK, 0x1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL2,\r\nMAX77620_TWD_MASK, regval);\r\nif (ret < 0)\r\nreturn ret;\r\nwdt_dev->timeout = wdt_timeout;\r\nreturn 0;\r\n}\r\nstatic int max77620_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct max77620_wdt *wdt;\r\nstruct watchdog_device *wdt_dev;\r\nunsigned int regval;\r\nint ret;\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nwdt->dev = &pdev->dev;\r\nwdt->rmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!wdt->rmap) {\r\ndev_err(wdt->dev, "Failed to get parent regmap\n");\r\nreturn -ENODEV;\r\n}\r\nwdt_dev = &wdt->wdt_dev;\r\nwdt_dev->info = &max77620_wdt_info;\r\nwdt_dev->ops = &max77620_wdt_ops;\r\nwdt_dev->min_timeout = 2;\r\nwdt_dev->max_timeout = 128;\r\nwdt_dev->max_hw_heartbeat_ms = 128 * 1000;\r\nplatform_set_drvdata(pdev, wdt);\r\nret = regmap_update_bits(wdt->rmap, MAX77620_REG_ONOFFCNFG2,\r\nMAX77620_ONOFFCNFG2_WD_RST_WK,\r\nMAX77620_ONOFFCNFG2_WD_RST_WK);\r\nif (ret < 0) {\r\ndev_err(wdt->dev, "Failed to set WD_RST_WK: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(wdt->rmap, MAX77620_REG_CNFGGLBL2,\r\nMAX77620_WDTOFFC | MAX77620_WDTSLPC,\r\nMAX77620_WDTOFFC | MAX77620_WDTSLPC);\r\nif (ret < 0) {\r\ndev_err(wdt->dev, "Failed to set WDT OFF mode: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_read(wdt->rmap, MAX77620_REG_CNFGGLBL2, &regval);\r\nif (ret < 0) {\r\ndev_err(wdt->dev, "Failed to read WDT CFG register: %d\n", ret);\r\nreturn ret;\r\n}\r\nswitch (regval & MAX77620_TWD_MASK) {\r\ncase MAX77620_TWD_2s:\r\nwdt_dev->timeout = 2;\r\nbreak;\r\ncase MAX77620_TWD_16s:\r\nwdt_dev->timeout = 16;\r\nbreak;\r\ncase MAX77620_TWD_64s:\r\nwdt_dev->timeout = 64;\r\nbreak;\r\ndefault:\r\nwdt_dev->timeout = 128;\r\nbreak;\r\n}\r\nif (regval & MAX77620_WDTEN)\r\nset_bit(WDOG_HW_RUNNING, &wdt_dev->status);\r\nwatchdog_set_nowayout(wdt_dev, nowayout);\r\nwatchdog_set_drvdata(wdt_dev, wdt);\r\nret = watchdog_register_device(wdt_dev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "watchdog registration failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct max77620_wdt *wdt = platform_get_drvdata(pdev);\r\nmax77620_wdt_stop(&wdt->wdt_dev);\r\nwatchdog_unregister_device(&wdt->wdt_dev);\r\nreturn 0;\r\n}

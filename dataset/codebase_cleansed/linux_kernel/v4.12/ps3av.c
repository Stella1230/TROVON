static u32 *ps3av_search_cmd_table(u32 cid, u32 mask)\r\n{\r\nu32 *table;\r\nint i;\r\ntable = cmd_table;\r\nfor (i = 0;; table++, i++) {\r\nif ((*table & mask) == (cid & mask))\r\nbreak;\r\nif (*table == 0)\r\nreturn NULL;\r\n}\r\nreturn table;\r\n}\r\nstatic int ps3av_parse_event_packet(const struct ps3av_reply_hdr *hdr)\r\n{\r\nu32 *table;\r\nif (hdr->cid & PS3AV_EVENT_CMD_MASK) {\r\ntable = ps3av_search_cmd_table(hdr->cid, PS3AV_EVENT_CMD_MASK);\r\nif (table)\r\ndev_dbg(&ps3av->dev->core,\r\n"recv event packet cid:%08x port:0x%x size:%d\n",\r\nhdr->cid, ps3av_event_get_port_id(hdr->cid),\r\nhdr->size);\r\nelse\r\nprintk(KERN_ERR\r\n"%s: failed event packet, cid:%08x size:%d\n",\r\n__func__, hdr->cid, hdr->size);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3av_vuart_write(struct ps3_system_bus_device *dev,\r\nconst void *buf, unsigned long size)\r\n{\r\nint error;\r\ndev_dbg(&dev->core, " -> %s:%d\n", __func__, __LINE__);\r\nerror = ps3_vuart_write(dev, buf, size);\r\ndev_dbg(&dev->core, " <- %s:%d\n", __func__, __LINE__);\r\nreturn error ? error : size;\r\n}\r\nstatic int ps3av_vuart_read(struct ps3_system_bus_device *dev, void *buf,\r\nunsigned long size, int timeout)\r\n{\r\nint error;\r\nint loopcnt = 0;\r\ndev_dbg(&dev->core, " -> %s:%d\n", __func__, __LINE__);\r\ntimeout = (timeout + POLLING_INTERVAL - 1) / POLLING_INTERVAL;\r\nwhile (loopcnt++ <= timeout) {\r\nerror = ps3_vuart_read(dev, buf, size);\r\nif (!error)\r\nreturn size;\r\nif (error != -EAGAIN) {\r\nprintk(KERN_ERR "%s: ps3_vuart_read failed %d\n",\r\n__func__, error);\r\nreturn error;\r\n}\r\nmsleep(POLLING_INTERVAL);\r\n}\r\nreturn -EWOULDBLOCK;\r\n}\r\nstatic int ps3av_send_cmd_pkt(const struct ps3av_send_hdr *send_buf,\r\nstruct ps3av_reply_hdr *recv_buf, int write_len,\r\nint read_len)\r\n{\r\nint res;\r\nu32 cmd;\r\nint event;\r\nif (!ps3av)\r\nreturn -ENODEV;\r\nres = ps3av_vuart_write(ps3av->dev, send_buf, write_len);\r\nif (res < 0) {\r\ndev_dbg(&ps3av->dev->core,\r\n"%s: ps3av_vuart_write() failed (result=%d)\n",\r\n__func__, res);\r\nreturn res;\r\n}\r\ncmd = send_buf->cid;\r\ndo {\r\nres = ps3av_vuart_read(ps3av->dev, recv_buf, PS3AV_HDR_SIZE,\r\ntimeout);\r\nif (res != PS3AV_HDR_SIZE) {\r\ndev_dbg(&ps3av->dev->core,\r\n"%s: ps3av_vuart_read() failed (result=%d)\n",\r\n__func__, res);\r\nreturn res;\r\n}\r\nres = ps3av_vuart_read(ps3av->dev, &recv_buf->cid,\r\nrecv_buf->size, timeout);\r\nif (res < 0) {\r\ndev_dbg(&ps3av->dev->core,\r\n"%s: ps3av_vuart_read() failed (result=%d)\n",\r\n__func__, res);\r\nreturn res;\r\n}\r\nres += PS3AV_HDR_SIZE;\r\nevent = ps3av_parse_event_packet(recv_buf);\r\n} while (event);\r\nif ((cmd | PS3AV_REPLY_BIT) != recv_buf->cid) {\r\ndev_dbg(&ps3av->dev->core, "%s: reply err (result=%x)\n",\r\n__func__, recv_buf->cid);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3av_process_reply_packet(struct ps3av_send_hdr *cmd_buf,\r\nconst struct ps3av_reply_hdr *recv_buf,\r\nint user_buf_size)\r\n{\r\nint return_len;\r\nif (recv_buf->version != PS3AV_VERSION) {\r\ndev_dbg(&ps3av->dev->core, "reply_packet invalid version:%x\n",\r\nrecv_buf->version);\r\nreturn -EFAULT;\r\n}\r\nreturn_len = recv_buf->size + PS3AV_HDR_SIZE;\r\nif (return_len > user_buf_size)\r\nreturn_len = user_buf_size;\r\nmemcpy(cmd_buf, recv_buf, return_len);\r\nreturn 0;\r\n}\r\nvoid ps3av_set_hdr(u32 cid, u16 size, struct ps3av_send_hdr *hdr)\r\n{\r\nhdr->version = PS3AV_VERSION;\r\nhdr->size = size - PS3AV_HDR_SIZE;\r\nhdr->cid = cid;\r\n}\r\nint ps3av_do_pkt(u32 cid, u16 send_len, size_t usr_buf_size,\r\nstruct ps3av_send_hdr *buf)\r\n{\r\nint res = 0;\r\nu32 *table;\r\nBUG_ON(!ps3av);\r\nmutex_lock(&ps3av->mutex);\r\ntable = ps3av_search_cmd_table(cid, PS3AV_CID_MASK);\r\nBUG_ON(!table);\r\nBUG_ON(send_len < PS3AV_HDR_SIZE);\r\nBUG_ON(usr_buf_size < send_len);\r\nBUG_ON(usr_buf_size > PS3AV_BUF_SIZE);\r\nps3av_set_hdr(cid, send_len, buf);\r\nres = ps3av_send_cmd_pkt(buf, &ps3av->recv_buf.reply_hdr, send_len,\r\nusr_buf_size);\r\nif (res < 0) {\r\nprintk(KERN_ERR\r\n"%s: ps3av_send_cmd_pkt() failed (result=%d)\n",\r\n__func__, res);\r\ngoto err;\r\n}\r\nres = ps3av_process_reply_packet(buf, &ps3av->recv_buf.reply_hdr,\r\nusr_buf_size);\r\nif (res < 0) {\r\nprintk(KERN_ERR "%s: put_return_status() failed (result=%d)\n",\r\n__func__, res);\r\ngoto err;\r\n}\r\nmutex_unlock(&ps3av->mutex);\r\nreturn 0;\r\nerr:\r\nmutex_unlock(&ps3av->mutex);\r\nprintk(KERN_ERR "%s: failed cid:%x res:%d\n", __func__, cid, res);\r\nreturn res;\r\n}\r\nstatic int ps3av_set_av_video_mute(u32 mute)\r\n{\r\nint i, num_of_av_port, res;\r\nnum_of_av_port = ps3av->av_hw_conf.num_of_hdmi +\r\nps3av->av_hw_conf.num_of_avmulti;\r\nfor (i = 0; i < num_of_av_port; i++) {\r\nres = ps3av_cmd_av_video_mute(1, &ps3av->av_port[i], mute);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3av_set_video_disable_sig(void)\r\n{\r\nint i, num_of_hdmi_port, num_of_av_port, res;\r\nnum_of_hdmi_port = ps3av->av_hw_conf.num_of_hdmi;\r\nnum_of_av_port = ps3av->av_hw_conf.num_of_hdmi +\r\nps3av->av_hw_conf.num_of_avmulti;\r\nfor (i = 0; i < num_of_hdmi_port; i++) {\r\nres = ps3av_cmd_av_tv_mute(ps3av->av_port[i],\r\nPS3AV_CMD_MUTE_ON);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\nmsleep(100);\r\nfor (i = 0; i < num_of_av_port; i++) {\r\nres = ps3av_cmd_av_video_disable_sig(ps3av->av_port[i]);\r\nif (res < 0)\r\nreturn -1;\r\nif (i < num_of_hdmi_port) {\r\nres = ps3av_cmd_av_tv_mute(ps3av->av_port[i],\r\nPS3AV_CMD_MUTE_OFF);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\n}\r\nmsleep(300);\r\nreturn 0;\r\n}\r\nstatic int ps3av_set_audio_mute(u32 mute)\r\n{\r\nint i, num_of_av_port, num_of_opt_port, res;\r\nnum_of_av_port = ps3av->av_hw_conf.num_of_hdmi +\r\nps3av->av_hw_conf.num_of_avmulti;\r\nnum_of_opt_port = ps3av->av_hw_conf.num_of_spdif;\r\nfor (i = 0; i < num_of_av_port; i++) {\r\nres = ps3av_cmd_av_audio_mute(1, &ps3av->av_port[i], mute);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\nfor (i = 0; i < num_of_opt_port; i++) {\r\nres = ps3av_cmd_audio_mute(1, &ps3av->opt_port[i], mute);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nint ps3av_set_audio_mode(u32 ch, u32 fs, u32 word_bits, u32 format, u32 source)\r\n{\r\nstruct ps3av_pkt_avb_param avb_param;\r\nint i, num_of_audio, vid, res;\r\nstruct ps3av_pkt_audio_mode audio_mode;\r\nu32 len = 0;\r\nnum_of_audio = ps3av->av_hw_conf.num_of_hdmi +\r\nps3av->av_hw_conf.num_of_avmulti +\r\nps3av->av_hw_conf.num_of_spdif;\r\navb_param.num_of_video_pkt = 0;\r\navb_param.num_of_audio_pkt = PS3AV_AVB_NUM_AUDIO;\r\navb_param.num_of_av_video_pkt = 0;\r\navb_param.num_of_av_audio_pkt = ps3av->av_hw_conf.num_of_hdmi;\r\nvid = video_mode_table[ps3av->ps3av_mode].vid;\r\nps3av_set_audio_mute(PS3AV_CMD_MUTE_ON);\r\nres = ps3av_cmd_audio_active(0, ps3av->audio_port);\r\nif (res < 0)\r\ndev_dbg(&ps3av->dev->core,\r\n"ps3av_cmd_audio_active OFF failed\n");\r\nfor (i = 0; i < num_of_audio; i++) {\r\nps3av_cmd_set_audio_mode(&audio_mode, ps3av->av_port[i], ch,\r\nfs, word_bits, format, source);\r\nif (i < ps3av->av_hw_conf.num_of_hdmi) {\r\nlen += ps3av_cmd_set_av_audio_param(&avb_param.buf[len],\r\nps3av->av_port[i],\r\n&audio_mode, vid);\r\n}\r\nres = ps3av_cmd_audio_mode(&audio_mode);\r\nif (res < 0)\r\ndev_dbg(&ps3av->dev->core,\r\n"ps3av_cmd_audio_mode failed, port:%x\n", i);\r\n}\r\nlen += offsetof(struct ps3av_pkt_avb_param, buf);\r\nres = ps3av_cmd_avb_param(&avb_param, len);\r\nif (res < 0)\r\ndev_dbg(&ps3av->dev->core, "ps3av_cmd_avb_param failed\n");\r\nps3av_set_audio_mute(PS3AV_CMD_MUTE_OFF);\r\nres = ps3av_cmd_audio_active(1, ps3av->audio_port);\r\nif (res < 0)\r\ndev_dbg(&ps3av->dev->core,\r\n"ps3av_cmd_audio_active ON failed\n");\r\nreturn 0;\r\n}\r\nstatic int ps3av_set_videomode(void)\r\n{\r\nps3av_set_av_video_mute(PS3AV_CMD_MUTE_ON);\r\nqueue_work(ps3av->wq, &ps3av->work);\r\nreturn 0;\r\n}\r\nstatic void ps3av_set_videomode_packet(u32 id)\r\n{\r\nstruct ps3av_pkt_avb_param avb_param;\r\nunsigned int i;\r\nu32 len = 0, av_video_cs;\r\nconst struct avset_video_mode *video_mode;\r\nint res;\r\nvideo_mode = &video_mode_table[id & PS3AV_MODE_MASK];\r\navb_param.num_of_video_pkt = PS3AV_AVB_NUM_VIDEO;\r\navb_param.num_of_audio_pkt = 0;\r\navb_param.num_of_av_video_pkt = ps3av->av_hw_conf.num_of_hdmi +\r\nps3av->av_hw_conf.num_of_avmulti;\r\navb_param.num_of_av_audio_pkt = 0;\r\nfor (i = 0; i < avb_param.num_of_video_pkt; i++)\r\nlen += ps3av_cmd_set_video_mode(&avb_param.buf[len],\r\nps3av->head[i], video_mode->vid,\r\nvideo_mode->fmt, id);\r\nfor (i = 0; i < avb_param.num_of_av_video_pkt; i++) {\r\nif (id & PS3AV_MODE_DVI || id & PS3AV_MODE_RGB)\r\nav_video_cs = RGB8;\r\nelse\r\nav_video_cs = video_mode->cs;\r\n#ifndef PS3AV_HDMI_YUV\r\nif (ps3av->av_port[i] == PS3AV_CMD_AVPORT_HDMI_0 ||\r\nps3av->av_port[i] == PS3AV_CMD_AVPORT_HDMI_1)\r\nav_video_cs = RGB8;\r\n#endif\r\nlen += ps3av_cmd_set_av_video_cs(&avb_param.buf[len],\r\nps3av->av_port[i],\r\nvideo_mode->vid, av_video_cs,\r\nvideo_mode->aspect, id);\r\n}\r\nlen += offsetof(struct ps3av_pkt_avb_param, buf);\r\nres = ps3av_cmd_avb_param(&avb_param, len);\r\nif (res == PS3AV_STATUS_NO_SYNC_HEAD)\r\nprintk(KERN_WARNING\r\n"%s: Command failed. Please try your request again.\n",\r\n__func__);\r\nelse if (res)\r\ndev_dbg(&ps3av->dev->core, "ps3av_cmd_avb_param failed\n");\r\n}\r\nstatic void ps3av_set_videomode_cont(u32 id, u32 old_id)\r\n{\r\nstatic int vesa;\r\nint res;\r\nps3av_set_video_disable_sig();\r\nif (vesa == 0 && (id & PS3AV_MODE_MASK) >= PS3AV_MODE_WXGA) {\r\nps3av_set_videomode_packet(PS3AV_MODE_480P);\r\n}\r\nvesa = 1;\r\nif (id & PS3AV_MODE_HDCP_OFF) {\r\nres = ps3av_cmd_av_hdmi_mode(PS3AV_CMD_AV_HDMI_HDCP_OFF);\r\nif (res == PS3AV_STATUS_UNSUPPORTED_HDMI_MODE)\r\ndev_dbg(&ps3av->dev->core, "Not supported\n");\r\nelse if (res)\r\ndev_dbg(&ps3av->dev->core,\r\n"ps3av_cmd_av_hdmi_mode failed\n");\r\n} else if (old_id & PS3AV_MODE_HDCP_OFF) {\r\nres = ps3av_cmd_av_hdmi_mode(PS3AV_CMD_AV_HDMI_MODE_NORMAL);\r\nif (res < 0 && res != PS3AV_STATUS_UNSUPPORTED_HDMI_MODE)\r\ndev_dbg(&ps3av->dev->core,\r\n"ps3av_cmd_av_hdmi_mode failed\n");\r\n}\r\nps3av_set_videomode_packet(id);\r\nmsleep(1500);\r\nps3av_set_av_video_mute(PS3AV_CMD_MUTE_OFF);\r\n}\r\nstatic void ps3avd(struct work_struct *work)\r\n{\r\nps3av_set_videomode_cont(ps3av->ps3av_mode, ps3av->ps3av_mode_old);\r\ncomplete(&ps3av->done);\r\n}\r\nstatic enum ps3av_mode_num ps3av_resbit2id(u32 res_50, u32 res_60,\r\nu32 res_vesa)\r\n{\r\nunsigned int i;\r\nu32 res_all;\r\nBUILD_BUG_ON(PS3AV_RES_MASK_50 << SHIFT_50 &\r\nPS3AV_RES_MASK_60 << SHIFT_60);\r\nBUILD_BUG_ON(PS3AV_RES_MASK_50 << SHIFT_50 &\r\nPS3AV_RES_MASK_VESA << SHIFT_VESA);\r\nBUILD_BUG_ON(PS3AV_RES_MASK_60 << SHIFT_60 &\r\nPS3AV_RES_MASK_VESA << SHIFT_VESA);\r\nres_all = (res_50 & PS3AV_RES_MASK_50) << SHIFT_50 |\r\n(res_60 & PS3AV_RES_MASK_60) << SHIFT_60 |\r\n(res_vesa & PS3AV_RES_MASK_VESA) << SHIFT_VESA;\r\nif (!res_all)\r\nreturn 0;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_preferred_modes); i++)\r\nif (res_all & ps3av_preferred_modes[i].mask)\r\nreturn ps3av_preferred_modes[i].id;\r\nreturn 0;\r\n}\r\nstatic enum ps3av_mode_num ps3av_hdmi_get_id(struct ps3av_info_monitor *info)\r\n{\r\nenum ps3av_mode_num id;\r\nif (safe_mode)\r\nreturn PS3AV_DEFAULT_HDMI_MODE_ID_REG_60;\r\nid = ps3av_resbit2id(info->res_50.native, info->res_60.native,\r\ninfo->res_vesa.native);\r\nif (id) {\r\npr_debug("%s: Using native mode %d\n", __func__, id);\r\nreturn id;\r\n}\r\nid = ps3av_resbit2id(info->res_50.res_bits, info->res_60.res_bits,\r\ninfo->res_vesa.res_bits);\r\nif (id) {\r\npr_debug("%s: Using supported mode %d\n", __func__, id);\r\nreturn id;\r\n}\r\nif (ps3av->region & PS3AV_REGION_60)\r\nid = PS3AV_DEFAULT_HDMI_MODE_ID_REG_60;\r\nelse\r\nid = PS3AV_DEFAULT_HDMI_MODE_ID_REG_50;\r\npr_debug("%s: Using default mode %d\n", __func__, id);\r\nreturn id;\r\n}\r\nstatic void ps3av_monitor_info_dump(\r\nconst struct ps3av_pkt_av_get_monitor_info *monitor_info)\r\n{\r\nconst struct ps3av_info_monitor *info = &monitor_info->info;\r\nconst struct ps3av_info_audio *audio = info->audio;\r\nchar id[sizeof(info->monitor_id)*3+1];\r\nint i;\r\npr_debug("Monitor Info: size %u\n", monitor_info->send_hdr.size);\r\npr_debug("avport: %02x\n", info->avport);\r\nfor (i = 0; i < sizeof(info->monitor_id); i++)\r\nsprintf(&id[i*3], " %02x", info->monitor_id[i]);\r\npr_debug("monitor_id: %s\n", id);\r\npr_debug("monitor_type: %02x\n", info->monitor_type);\r\npr_debug("monitor_name: %.*s\n", (int)sizeof(info->monitor_name),\r\ninfo->monitor_name);\r\npr_debug("resolution_60: bits: %08x native: %08x\n",\r\ninfo->res_60.res_bits, info->res_60.native);\r\npr_debug("resolution_50: bits: %08x native: %08x\n",\r\ninfo->res_50.res_bits, info->res_50.native);\r\npr_debug("resolution_other: bits: %08x native: %08x\n",\r\ninfo->res_other.res_bits, info->res_other.native);\r\npr_debug("resolution_vesa: bits: %08x native: %08x\n",\r\ninfo->res_vesa.res_bits, info->res_vesa.native);\r\npr_debug("color space rgb: %02x\n", info->cs.rgb);\r\npr_debug("color space yuv444: %02x\n", info->cs.yuv444);\r\npr_debug("color space yuv422: %02x\n", info->cs.yuv422);\r\npr_debug("color info red: X %04x Y %04x\n", info->color.red_x,\r\ninfo->color.red_y);\r\npr_debug("color info green: X %04x Y %04x\n", info->color.green_x,\r\ninfo->color.green_y);\r\npr_debug("color info blue: X %04x Y %04x\n", info->color.blue_x,\r\ninfo->color.blue_y);\r\npr_debug("color info white: X %04x Y %04x\n", info->color.white_x,\r\ninfo->color.white_y);\r\npr_debug("color info gamma: %08x\n", info->color.gamma);\r\npr_debug("supported_AI: %02x\n", info->supported_ai);\r\npr_debug("speaker_info: %02x\n", info->speaker_info);\r\npr_debug("num of audio: %02x\n", info->num_of_audio_block);\r\nfor (i = 0; i < info->num_of_audio_block; i++) {\r\npr_debug(\r\n"audio[%d] type: %02x max_ch: %02x fs: %02x sbit: %02x\n",\r\ni, audio->type, audio->max_num_of_ch, audio->fs,\r\naudio->sbit);\r\naudio++;\r\n}\r\n}\r\nstatic void ps3av_fixup_monitor_info(struct ps3av_info_monitor *info)\r\n{\r\nunsigned int i;\r\nconst struct ps3av_monitor_quirk *quirk;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_monitor_quirks); i++) {\r\nquirk = &ps3av_monitor_quirks[i];\r\nif (!strncmp(info->monitor_name, quirk->monitor_name,\r\nsizeof(info->monitor_name))) {\r\npr_info("%s: Applying quirk for %s\n", __func__,\r\nquirk->monitor_name);\r\ninfo->res_60.res_bits &= ~quirk->clear_60;\r\ninfo->res_60.native &= ~quirk->clear_60;\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int ps3av_auto_videomode(struct ps3av_pkt_av_get_hw_conf *av_hw_conf)\r\n{\r\nint i, res, id = 0, dvi = 0, rgb = 0;\r\nstruct ps3av_pkt_av_get_monitor_info monitor_info;\r\nstruct ps3av_info_monitor *info;\r\nfor (i = 0; i < av_hw_conf->num_of_hdmi && !id; i++) {\r\nres = ps3av_cmd_video_get_monitor_info(&monitor_info,\r\nPS3AV_CMD_AVPORT_HDMI_0 +\r\ni);\r\nif (res < 0)\r\nreturn -1;\r\nps3av_monitor_info_dump(&monitor_info);\r\ninfo = &monitor_info.info;\r\nps3av_fixup_monitor_info(info);\r\nswitch (info->monitor_type) {\r\ncase PS3AV_MONITOR_TYPE_DVI:\r\ndvi = PS3AV_MODE_DVI;\r\ncase PS3AV_MONITOR_TYPE_HDMI:\r\nid = ps3av_hdmi_get_id(info);\r\nbreak;\r\n}\r\n}\r\nif (!id) {\r\nif (ps3av->region & PS3AV_REGION_60)\r\nid = PS3AV_DEFAULT_AVMULTI_MODE_ID_REG_60;\r\nelse\r\nid = PS3AV_DEFAULT_AVMULTI_MODE_ID_REG_50;\r\nif (ps3av->region & PS3AV_REGION_RGB)\r\nrgb = PS3AV_MODE_RGB;\r\npr_debug("%s: Using avmulti mode %d\n", __func__, id);\r\n}\r\nreturn id | dvi | rgb;\r\n}\r\nstatic int ps3av_get_hw_conf(struct ps3av *ps3av)\r\n{\r\nint i, j, k, res;\r\nconst struct ps3av_pkt_av_get_hw_conf *hw_conf;\r\nres = ps3av_cmd_av_get_hw_conf(&ps3av->av_hw_conf);\r\nif (res < 0)\r\nreturn -1;\r\nhw_conf = &ps3av->av_hw_conf;\r\npr_debug("av_h_conf: num of hdmi: %u\n", hw_conf->num_of_hdmi);\r\npr_debug("av_h_conf: num of avmulti: %u\n", hw_conf->num_of_avmulti);\r\npr_debug("av_h_conf: num of spdif: %u\n", hw_conf->num_of_spdif);\r\nfor (i = 0; i < PS3AV_HEAD_MAX; i++)\r\nps3av->head[i] = PS3AV_CMD_VIDEO_HEAD_A + i;\r\nfor (i = 0; i < PS3AV_OPT_PORT_MAX; i++)\r\nps3av->opt_port[i] = PS3AV_CMD_AVPORT_SPDIF_0 + i;\r\nfor (i = 0; i < hw_conf->num_of_hdmi; i++)\r\nps3av->av_port[i] = PS3AV_CMD_AVPORT_HDMI_0 + i;\r\nfor (j = 0; j < hw_conf->num_of_avmulti; j++)\r\nps3av->av_port[i + j] = PS3AV_CMD_AVPORT_AVMULTI_0 + j;\r\nfor (k = 0; k < hw_conf->num_of_spdif; k++)\r\nps3av->av_port[i + j + k] = PS3AV_CMD_AVPORT_SPDIF_0 + k;\r\nps3av->audio_port = PS3AV_CMD_AUDIO_PORT_HDMI_0\r\n| PS3AV_CMD_AUDIO_PORT_HDMI_1\r\n| PS3AV_CMD_AUDIO_PORT_AVMULTI_0\r\n| PS3AV_CMD_AUDIO_PORT_SPDIF_0 | PS3AV_CMD_AUDIO_PORT_SPDIF_1;\r\nreturn 0;\r\n}\r\nint ps3av_set_video_mode(int id)\r\n{\r\nint size;\r\nu32 option;\r\nsize = ARRAY_SIZE(video_mode_table);\r\nif ((id & PS3AV_MODE_MASK) > size - 1 || id < 0) {\r\ndev_dbg(&ps3av->dev->core, "%s: error id :%d\n", __func__, id);\r\nreturn -EINVAL;\r\n}\r\noption = id & ~PS3AV_MODE_MASK;\r\nif ((id & PS3AV_MODE_MASK) == PS3AV_MODE_AUTO) {\r\nid = ps3av_auto_videomode(&ps3av->av_hw_conf);\r\nif (id < 1) {\r\nprintk(KERN_ERR "%s: invalid id :%d\n", __func__, id);\r\nreturn -EINVAL;\r\n}\r\nid |= option;\r\n}\r\nwait_for_completion(&ps3av->done);\r\nps3av->ps3av_mode_old = ps3av->ps3av_mode;\r\nps3av->ps3av_mode = id;\r\nif (ps3av_set_videomode())\r\nps3av->ps3av_mode = ps3av->ps3av_mode_old;\r\nreturn 0;\r\n}\r\nint ps3av_get_auto_mode(void)\r\n{\r\nreturn ps3av_auto_videomode(&ps3av->av_hw_conf);\r\n}\r\nint ps3av_get_mode(void)\r\n{\r\nreturn ps3av ? ps3av->ps3av_mode : 0;\r\n}\r\nint ps3av_video_mode2res(u32 id, u32 *xres, u32 *yres)\r\n{\r\nint size;\r\nid = id & PS3AV_MODE_MASK;\r\nsize = ARRAY_SIZE(video_mode_table);\r\nif (id > size - 1 || id < 0) {\r\nprintk(KERN_ERR "%s: invalid mode %d\n", __func__, id);\r\nreturn -EINVAL;\r\n}\r\n*xres = video_mode_table[id].x;\r\n*yres = video_mode_table[id].y;\r\nreturn 0;\r\n}\r\nint ps3av_video_mute(int mute)\r\n{\r\nreturn ps3av_set_av_video_mute(mute ? PS3AV_CMD_MUTE_ON\r\n: PS3AV_CMD_MUTE_OFF);\r\n}\r\nint ps3av_audio_mute_analog(int mute)\r\n{\r\nint i, res;\r\nfor (i = 0; i < ps3av->av_hw_conf.num_of_avmulti; i++) {\r\nres = ps3av_cmd_av_audio_mute(1,\r\n&ps3av->av_port[i + ps3av->av_hw_conf.num_of_hdmi],\r\nmute);\r\nif (res < 0)\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nint ps3av_audio_mute(int mute)\r\n{\r\nreturn ps3av_set_audio_mute(mute ? PS3AV_CMD_MUTE_ON\r\n: PS3AV_CMD_MUTE_OFF);\r\n}\r\nstatic int ps3av_probe(struct ps3_system_bus_device *dev)\r\n{\r\nint res;\r\nint id;\r\ndev_dbg(&dev->core, " -> %s:%d\n", __func__, __LINE__);\r\ndev_dbg(&dev->core, " timeout=%d\n", timeout);\r\nif (ps3av) {\r\ndev_err(&dev->core, "Only one ps3av device is supported\n");\r\nreturn -EBUSY;\r\n}\r\nps3av = kzalloc(sizeof(*ps3av), GFP_KERNEL);\r\nif (!ps3av)\r\nreturn -ENOMEM;\r\nmutex_init(&ps3av->mutex);\r\nps3av->ps3av_mode = PS3AV_MODE_AUTO;\r\nps3av->dev = dev;\r\nINIT_WORK(&ps3av->work, ps3avd);\r\ninit_completion(&ps3av->done);\r\ncomplete(&ps3av->done);\r\nps3av->wq = create_singlethread_workqueue("ps3avd");\r\nif (!ps3av->wq) {\r\nres = -ENOMEM;\r\ngoto fail;\r\n}\r\nswitch (ps3_os_area_get_av_multi_out()) {\r\ncase PS3_PARAM_AV_MULTI_OUT_NTSC:\r\nps3av->region = PS3AV_REGION_60;\r\nbreak;\r\ncase PS3_PARAM_AV_MULTI_OUT_PAL_YCBCR:\r\ncase PS3_PARAM_AV_MULTI_OUT_SECAM:\r\nps3av->region = PS3AV_REGION_50;\r\nbreak;\r\ncase PS3_PARAM_AV_MULTI_OUT_PAL_RGB:\r\nps3av->region = PS3AV_REGION_50 | PS3AV_REGION_RGB;\r\nbreak;\r\ndefault:\r\nps3av->region = PS3AV_REGION_60;\r\nbreak;\r\n}\r\nres = ps3av_cmd_init();\r\nif (res < 0)\r\nprintk(KERN_ERR "%s: ps3av_cmd_init failed %d\n", __func__,\r\nres);\r\nps3av_get_hw_conf(ps3av);\r\n#ifdef CONFIG_FB\r\nif (fb_mode_option && !strcmp(fb_mode_option, "safe"))\r\nsafe_mode = 1;\r\n#endif\r\nid = ps3av_auto_videomode(&ps3av->av_hw_conf);\r\nif (id < 0) {\r\nprintk(KERN_ERR "%s: invalid id :%d\n", __func__, id);\r\nres = -EINVAL;\r\ngoto fail;\r\n}\r\nsafe_mode = 0;\r\nmutex_lock(&ps3av->mutex);\r\nps3av->ps3av_mode = id;\r\nmutex_unlock(&ps3av->mutex);\r\ndev_dbg(&dev->core, " <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\nfail:\r\nkfree(ps3av);\r\nps3av = NULL;\r\nreturn res;\r\n}\r\nstatic int ps3av_remove(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, " -> %s:%d\n", __func__, __LINE__);\r\nif (ps3av) {\r\nps3av_cmd_fin();\r\nif (ps3av->wq)\r\ndestroy_workqueue(ps3av->wq);\r\nkfree(ps3av);\r\nps3av = NULL;\r\n}\r\ndev_dbg(&dev->core, " <- %s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic void ps3av_shutdown(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, " -> %s:%d\n", __func__, __LINE__);\r\nps3av_remove(dev);\r\ndev_dbg(&dev->core, " <- %s:%d\n", __func__, __LINE__);\r\n}\r\nstatic int __init ps3av_module_init(void)\r\n{\r\nint error;\r\nif (!firmware_has_feature(FW_FEATURE_PS3_LV1))\r\nreturn -ENODEV;\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nerror = ps3_vuart_port_driver_register(&ps3av_driver);\r\nif (error) {\r\nprintk(KERN_ERR\r\n"%s: ps3_vuart_port_driver_register failed %d\n",\r\n__func__, error);\r\nreturn error;\r\n}\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\nreturn error;\r\n}\r\nstatic void __exit ps3av_module_exit(void)\r\n{\r\npr_debug(" -> %s:%d\n", __func__, __LINE__);\r\nps3_vuart_port_driver_unregister(&ps3av_driver);\r\npr_debug(" <- %s:%d\n", __func__, __LINE__);\r\n}

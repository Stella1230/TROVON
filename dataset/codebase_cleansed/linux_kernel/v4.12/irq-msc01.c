static inline void mask_msc_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif (irq < (irq_base + 32))\r\nMSCIC_WRITE(MSC01_IC_DISL, 1<<(irq - irq_base));\r\nelse\r\nMSCIC_WRITE(MSC01_IC_DISH, 1<<(irq - irq_base - 32));\r\n}\r\nstatic inline void unmask_msc_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif (irq < (irq_base + 32))\r\nMSCIC_WRITE(MSC01_IC_ENAL, 1<<(irq - irq_base));\r\nelse\r\nMSCIC_WRITE(MSC01_IC_ENAH, 1<<(irq - irq_base - 32));\r\n}\r\nstatic void level_mask_and_ack_msc_irq(struct irq_data *d)\r\n{\r\nmask_msc_irq(d);\r\nif (!cpu_has_veic)\r\nMSCIC_WRITE(MSC01_IC_EOI, 0);\r\n}\r\nstatic void edge_mask_and_ack_msc_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nmask_msc_irq(d);\r\nif (!cpu_has_veic)\r\nMSCIC_WRITE(MSC01_IC_EOI, 0);\r\nelse {\r\nu32 r;\r\nMSCIC_READ(MSC01_IC_SUP+irq*8, r);\r\nMSCIC_WRITE(MSC01_IC_SUP+irq*8, r | ~MSC01_IC_SUP_EDGE_BIT);\r\nMSCIC_WRITE(MSC01_IC_SUP+irq*8, r);\r\n}\r\n}\r\nvoid ll_msc_irq(void)\r\n{\r\nunsigned int irq;\r\nMSCIC_READ(MSC01_IC_VEC, irq);\r\nif (irq < 64)\r\ndo_IRQ(irq + irq_base);\r\nelse {\r\n}\r\n}\r\nstatic void msc_bind_eic_interrupt(int irq, int set)\r\n{\r\nMSCIC_WRITE(MSC01_IC_RAMW,\r\n(irq<<MSC01_IC_RAMW_ADDR_SHF) | (set<<MSC01_IC_RAMW_DATA_SHF));\r\n}\r\nvoid __init init_msc_irqs(unsigned long icubase, unsigned int irqbase, msc_irqmap_t *imp, int nirq)\r\n{\r\n_icctrl_msc = (unsigned long) ioremap(icubase, 0x40000);\r\nMSCIC_WRITE(MSC01_IC_RST, MSC01_IC_RST_RST_BIT);\r\nboard_bind_eic_interrupt = &msc_bind_eic_interrupt;\r\nfor (; nirq > 0; nirq--, imp++) {\r\nint n = imp->im_irq;\r\nswitch (imp->im_type) {\r\ncase MSC01_IRQ_EDGE:\r\nirq_set_chip_and_handler_name(irqbase + n,\r\n&msc_edgeirq_type,\r\nhandle_edge_irq,\r\n"edge");\r\nif (cpu_has_veic)\r\nMSCIC_WRITE(MSC01_IC_SUP+n*8, MSC01_IC_SUP_EDGE_BIT);\r\nelse\r\nMSCIC_WRITE(MSC01_IC_SUP+n*8, MSC01_IC_SUP_EDGE_BIT | imp->im_lvl);\r\nbreak;\r\ncase MSC01_IRQ_LEVEL:\r\nirq_set_chip_and_handler_name(irqbase + n,\r\n&msc_levelirq_type,\r\nhandle_level_irq,\r\n"level");\r\nif (cpu_has_veic)\r\nMSCIC_WRITE(MSC01_IC_SUP+n*8, 0);\r\nelse\r\nMSCIC_WRITE(MSC01_IC_SUP+n*8, imp->im_lvl);\r\n}\r\n}\r\nirq_base = irqbase;\r\nMSCIC_WRITE(MSC01_IC_GENA, MSC01_IC_GENA_GENA_BIT);\r\n}

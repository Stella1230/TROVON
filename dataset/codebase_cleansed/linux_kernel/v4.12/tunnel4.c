static inline struct xfrm_tunnel __rcu **fam_handlers(unsigned short family)\r\n{\r\nreturn (family == AF_INET) ? &tunnel4_handlers :\r\n(family == AF_INET6) ? &tunnel64_handlers :\r\n&tunnelmpls4_handlers;\r\n}\r\nint xfrm4_tunnel_register(struct xfrm_tunnel *handler, unsigned short family)\r\n{\r\nstruct xfrm_tunnel __rcu **pprev;\r\nstruct xfrm_tunnel *t;\r\nint ret = -EEXIST;\r\nint priority = handler->priority;\r\nmutex_lock(&tunnel4_mutex);\r\nfor (pprev = fam_handlers(family);\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&tunnel4_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t->priority > priority)\r\nbreak;\r\nif (t->priority == priority)\r\ngoto err;\r\n}\r\nhandler->next = *pprev;\r\nrcu_assign_pointer(*pprev, handler);\r\nret = 0;\r\nerr:\r\nmutex_unlock(&tunnel4_mutex);\r\nreturn ret;\r\n}\r\nint xfrm4_tunnel_deregister(struct xfrm_tunnel *handler, unsigned short family)\r\n{\r\nstruct xfrm_tunnel __rcu **pprev;\r\nstruct xfrm_tunnel *t;\r\nint ret = -ENOENT;\r\nmutex_lock(&tunnel4_mutex);\r\nfor (pprev = fam_handlers(family);\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&tunnel4_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t == handler) {\r\n*pprev = handler->next;\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&tunnel4_mutex);\r\nsynchronize_net();\r\nreturn ret;\r\n}\r\nstatic int tunnel4_rcv(struct sk_buff *skb)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nif (!pskb_may_pull(skb, sizeof(struct iphdr)))\r\ngoto drop;\r\nfor_each_tunnel_rcu(tunnel4_handlers, handler)\r\nif (!handler->handler(skb))\r\nreturn 0;\r\nicmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);\r\ndrop:\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic int tunnel64_rcv(struct sk_buff *skb)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nif (!pskb_may_pull(skb, sizeof(struct ipv6hdr)))\r\ngoto drop;\r\nfor_each_tunnel_rcu(tunnel64_handlers, handler)\r\nif (!handler->handler(skb))\r\nreturn 0;\r\nicmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);\r\ndrop:\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic int tunnelmpls4_rcv(struct sk_buff *skb)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nif (!pskb_may_pull(skb, sizeof(struct mpls_label)))\r\ngoto drop;\r\nfor_each_tunnel_rcu(tunnelmpls4_handlers, handler)\r\nif (!handler->handler(skb))\r\nreturn 0;\r\nicmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);\r\ndrop:\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic void tunnel4_err(struct sk_buff *skb, u32 info)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nfor_each_tunnel_rcu(tunnel4_handlers, handler)\r\nif (!handler->err_handler(skb, info))\r\nbreak;\r\n}\r\nstatic void tunnel64_err(struct sk_buff *skb, u32 info)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nfor_each_tunnel_rcu(tunnel64_handlers, handler)\r\nif (!handler->err_handler(skb, info))\r\nbreak;\r\n}\r\nstatic void tunnelmpls4_err(struct sk_buff *skb, u32 info)\r\n{\r\nstruct xfrm_tunnel *handler;\r\nfor_each_tunnel_rcu(tunnelmpls4_handlers, handler)\r\nif (!handler->err_handler(skb, info))\r\nbreak;\r\n}\r\nstatic int __init tunnel4_init(void)\r\n{\r\nif (inet_add_protocol(&tunnel4_protocol, IPPROTO_IPIP))\r\ngoto err;\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nif (inet_add_protocol(&tunnel64_protocol, IPPROTO_IPV6)) {\r\ninet_del_protocol(&tunnel4_protocol, IPPROTO_IPIP);\r\ngoto err;\r\n}\r\n#endif\r\n#if IS_ENABLED(CONFIG_MPLS)\r\nif (inet_add_protocol(&tunnelmpls4_protocol, IPPROTO_MPLS)) {\r\ninet_del_protocol(&tunnel4_protocol, IPPROTO_IPIP);\r\n#if IS_ENABLED(CONFIG_IPV6)\r\ninet_del_protocol(&tunnel64_protocol, IPPROTO_IPV6);\r\n#endif\r\ngoto err;\r\n}\r\n#endif\r\nreturn 0;\r\nerr:\r\npr_err("%s: can't add protocol\n", __func__);\r\nreturn -EAGAIN;\r\n}\r\nstatic void __exit tunnel4_fini(void)\r\n{\r\n#if IS_ENABLED(CONFIG_MPLS)\r\nif (inet_del_protocol(&tunnelmpls4_protocol, IPPROTO_MPLS))\r\npr_err("tunnelmpls4 close: can't remove protocol\n");\r\n#endif\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nif (inet_del_protocol(&tunnel64_protocol, IPPROTO_IPV6))\r\npr_err("tunnel64 close: can't remove protocol\n");\r\n#endif\r\nif (inet_del_protocol(&tunnel4_protocol, IPPROTO_IPIP))\r\npr_err("tunnel4 close: can't remove protocol\n");\r\n}

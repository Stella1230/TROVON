static int wm5110_sysclk_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nstruct regmap *regmap = arizona->regmap;\r\nconst struct reg_default *patch = NULL;\r\nint i, patch_size;\r\nswitch (arizona->rev) {\r\ncase 3:\r\npatch = wm5110_sysclk_revd_patch;\r\npatch_size = ARRAY_SIZE(wm5110_sysclk_revd_patch);\r\nbreak;\r\ndefault:\r\npatch = wm5110_sysclk_reve_patch;\r\npatch_size = ARRAY_SIZE(wm5110_sysclk_reve_patch);\r\nbreak;\r\n}\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (patch)\r\nfor (i = 0; i < patch_size; i++)\r\nregmap_write_async(regmap, patch[i].reg,\r\npatch[i].def);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMU:\r\ncase SND_SOC_DAPM_POST_PMD:\r\nreturn arizona_clk_ev(w, kcontrol, event);\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm5110_adsp_power_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nunsigned int v;\r\nint ret;\r\nret = regmap_read(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1, &v);\r\nif (ret != 0) {\r\ndev_err(codec->dev, "Failed to read SYSCLK state: %d\n", ret);\r\nreturn ret;\r\n}\r\nv = (v & ARIZONA_SYSCLK_FREQ_MASK) >> ARIZONA_SYSCLK_FREQ_SHIFT;\r\nreturn wm_adsp2_early_event(w, kcontrol, event, v);\r\n}\r\nstatic int wm5110_hp_pre_enable(struct snd_soc_dapm_widget *w)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nstruct arizona *arizona = priv->arizona;\r\nunsigned int val = snd_soc_read(codec, ARIZONA_DRE_ENABLE);\r\nconst struct reg_sequence *wseq;\r\nint nregs;\r\nswitch (w->shift) {\r\ncase ARIZONA_OUT1L_ENA_SHIFT:\r\nif (val & ARIZONA_DRE1L_ENA_MASK) {\r\nwseq = wm5110_dre_left_enable;\r\nnregs = ARRAY_SIZE(wm5110_dre_left_enable);\r\n} else {\r\nwseq = wm5110_no_dre_left_enable;\r\nnregs = ARRAY_SIZE(wm5110_no_dre_left_enable);\r\npriv->out_up_delay += 10;\r\n}\r\nbreak;\r\ncase ARIZONA_OUT1R_ENA_SHIFT:\r\nif (val & ARIZONA_DRE1R_ENA_MASK) {\r\nwseq = wm5110_dre_right_enable;\r\nnregs = ARRAY_SIZE(wm5110_dre_right_enable);\r\n} else {\r\nwseq = wm5110_no_dre_right_enable;\r\nnregs = ARRAY_SIZE(wm5110_no_dre_right_enable);\r\npriv->out_up_delay += 10;\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn regmap_multi_reg_write(arizona->regmap, wseq, nregs);\r\n}\r\nstatic int wm5110_hp_pre_disable(struct snd_soc_dapm_widget *w)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val = snd_soc_read(codec, ARIZONA_DRE_ENABLE);\r\nswitch (w->shift) {\r\ncase ARIZONA_OUT1L_ENA_SHIFT:\r\nif (!(val & ARIZONA_DRE1L_ENA_MASK)) {\r\nsnd_soc_update_bits(codec, ARIZONA_SPARE_TRIGGERS,\r\nARIZONA_WS_TRG1, ARIZONA_WS_TRG1);\r\nsnd_soc_update_bits(codec, ARIZONA_SPARE_TRIGGERS,\r\nARIZONA_WS_TRG1, 0);\r\npriv->out_down_delay += 27;\r\n}\r\nbreak;\r\ncase ARIZONA_OUT1R_ENA_SHIFT:\r\nif (!(val & ARIZONA_DRE1R_ENA_MASK)) {\r\nsnd_soc_update_bits(codec, ARIZONA_SPARE_TRIGGERS,\r\nARIZONA_WS_TRG2, ARIZONA_WS_TRG2);\r\nsnd_soc_update_bits(codec, ARIZONA_SPARE_TRIGGERS,\r\nARIZONA_WS_TRG2, 0);\r\npriv->out_down_delay += 27;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm5110_hp_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nswitch (priv->arizona->rev) {\r\ncase 0 ... 3:\r\nbreak;\r\ndefault:\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nwm5110_hp_pre_enable(w);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nwm5110_hp_pre_disable(w);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn arizona_hp_ev(w, kcontrol, event);\r\n}\r\nstatic int wm5110_clear_pga_volume(struct arizona *arizona, int output)\r\n{\r\nunsigned int reg = ARIZONA_OUTPUT_PATH_CONFIG_1L + output * 4;\r\nint ret;\r\nret = regmap_write(arizona->regmap, reg, 0x80);\r\nif (ret)\r\ndev_err(arizona->dev, "Failed to clear PGA (0x%x): %d\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nstatic int wm5110_put_dre(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nstruct soc_mixer_control *mc =\r\n(struct soc_mixer_control *)kcontrol->private_value;\r\nunsigned int ena, dre;\r\nunsigned int mask = (0x1 << mc->shift) | (0x1 << mc->rshift);\r\nunsigned int lnew = (!!ucontrol->value.integer.value[0]) << mc->shift;\r\nunsigned int rnew = (!!ucontrol->value.integer.value[1]) << mc->rshift;\r\nunsigned int lold, rold;\r\nunsigned int lena, rena;\r\nint ret;\r\nsnd_soc_dapm_mutex_lock(dapm);\r\nret = regmap_read(arizona->regmap, ARIZONA_OUTPUT_ENABLES_1, &ena);\r\nif (ret) {\r\ndev_err(arizona->dev, "Failed to read output state: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_read(arizona->regmap, ARIZONA_DRE_ENABLE, &dre);\r\nif (ret) {\r\ndev_err(arizona->dev, "Failed to read DRE state: %d\n", ret);\r\ngoto err;\r\n}\r\nlold = dre & (1 << mc->shift);\r\nrold = dre & (1 << mc->rshift);\r\nlena = ena & (1 << mc->rshift);\r\nrena = ena & (1 << mc->shift);\r\nif ((lena && lnew != lold) || (rena && rnew != rold)) {\r\ndev_err(arizona->dev, "Can't change DRE on active outputs\n");\r\nret = -EBUSY;\r\ngoto err;\r\n}\r\nret = regmap_update_bits(arizona->regmap, ARIZONA_DRE_ENABLE,\r\nmask, lnew | rnew);\r\nif (ret) {\r\ndev_err(arizona->dev, "Failed to set DRE: %d\n", ret);\r\ngoto err;\r\n}\r\nif (!lnew && lold)\r\nwm5110_clear_pga_volume(arizona, mc->shift);\r\nif (!rnew && rold)\r\nwm5110_clear_pga_volume(arizona, mc->rshift);\r\nerr:\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\nreturn ret;\r\n}\r\nstatic int wm5110_in_pga_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nint ret;\r\nsnd_soc_dapm_mutex_lock(dapm);\r\nret = snd_soc_get_volsw_range(kcontrol, ucontrol);\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\nreturn ret;\r\n}\r\nstatic int wm5110_in_pga_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nint ret;\r\nsnd_soc_dapm_mutex_lock(dapm);\r\nret = snd_soc_put_volsw_range(kcontrol, ucontrol);\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\nreturn ret;\r\n}\r\nstatic int wm5110_in_analog_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nstruct wm5110_priv *wm5110 = snd_soc_codec_get_drvdata(codec);\r\nstruct arizona *arizona = priv->arizona;\r\nunsigned int reg, mask;\r\nstruct reg_sequence analog_seq[] = {\r\n{ 0x80, 0x3 },\r\n{ 0x35d, 0 },\r\n{ 0x80, 0x0 },\r\n};\r\nreg = ARIZONA_IN1L_CONTROL + ((w->shift ^ 0x1) * 4);\r\nmask = ARIZONA_IN1L_PGA_VOL_MASK;\r\nswitch (event) {\r\ncase SND_SOC_DAPM_WILL_PMU:\r\nwm5110->in_value |= 0x3 << ((w->shift ^ 0x1) * 2);\r\nwm5110->in_pre_pending++;\r\nwm5110->in_post_pending++;\r\nreturn 0;\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nwm5110->in_pga_cache[w->shift] = snd_soc_read(codec, reg);\r\nsnd_soc_update_bits(codec, reg, mask,\r\n0x40 << ARIZONA_IN1L_PGA_VOL_SHIFT);\r\nwm5110->in_pre_pending--;\r\nif (wm5110->in_pre_pending == 0) {\r\nanalog_seq[1].def = wm5110->in_value;\r\nregmap_multi_reg_write_bypassed(arizona->regmap,\r\nanalog_seq,\r\nARRAY_SIZE(analog_seq));\r\nmsleep(55);\r\nwm5110->in_value = 0;\r\n}\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMU:\r\nsnd_soc_update_bits(codec, reg, mask,\r\nwm5110->in_pga_cache[w->shift]);\r\nwm5110->in_post_pending--;\r\nif (wm5110->in_post_pending == 0)\r\nregmap_multi_reg_write_bypassed(arizona->regmap,\r\nanalog_seq,\r\nARRAY_SIZE(analog_seq));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm5110_in_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nstruct arizona *arizona = priv->arizona;\r\nswitch (arizona->rev) {\r\ncase 0 ... 4:\r\nif (arizona_input_analog(codec, w->shift))\r\nwm5110_in_analog_ev(w, kcontrol, event);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn arizona_in_ev(w, kcontrol, event);\r\n}\r\nstatic int wm5110_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct wm5110_priv *wm5110 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase WM5110_FLL1:\r\nreturn arizona_set_fll(&wm5110->fll[0], source, Fref, Fout);\r\ncase WM5110_FLL2:\r\nreturn arizona_set_fll(&wm5110->fll[1], source, Fref, Fout);\r\ncase WM5110_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5110->fll[0], source, Fref,\r\nFout);\r\ncase WM5110_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5110->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int wm5110_open(struct snd_compr_stream *stream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = stream->private_data;\r\nstruct wm5110_priv *priv = snd_soc_platform_get_drvdata(rtd->platform);\r\nstruct arizona *arizona = priv->core.arizona;\r\nint n_adsp;\r\nif (strcmp(rtd->codec_dai->name, "wm5110-dsp-voicectrl") == 0) {\r\nn_adsp = 2;\r\n} else if (strcmp(rtd->codec_dai->name, "wm5110-dsp-trace") == 0) {\r\nn_adsp = 0;\r\n} else {\r\ndev_err(arizona->dev,\r\n"No suitable compressed stream for DAI '%s'\n",\r\nrtd->codec_dai->name);\r\nreturn -EINVAL;\r\n}\r\nreturn wm_adsp_compr_open(&priv->core.adsp[n_adsp], stream);\r\n}\r\nstatic irqreturn_t wm5110_adsp2_irq(int irq, void *data)\r\n{\r\nstruct wm5110_priv *priv = data;\r\nstruct arizona *arizona = priv->core.arizona;\r\nstruct arizona_voice_trigger_info info;\r\nint serviced = 0;\r\nint i, ret;\r\nfor (i = 0; i < WM5110_NUM_ADSP; ++i) {\r\nret = wm_adsp_compr_handle_irq(&priv->core.adsp[i]);\r\nif (ret != -ENODEV)\r\nserviced++;\r\nif (ret == WM_ADSP_COMPR_VOICE_TRIGGER) {\r\ninfo.core = i;\r\narizona_call_notifiers(arizona,\r\nARIZONA_NOTIFY_VOICE_TRIGGER,\r\n&info);\r\n}\r\n}\r\nif (!serviced) {\r\ndev_err(arizona->dev, "Spurious compressed data IRQ\n");\r\nreturn IRQ_NONE;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm5110_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct snd_soc_component *component = snd_soc_dapm_to_component(dapm);\r\nstruct wm5110_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nint i, ret;\r\npriv->core.arizona->dapm = dapm;\r\nret = arizona_init_spk(codec);\r\nif (ret < 0)\r\nreturn ret;\r\narizona_init_gpio(codec);\r\narizona_init_mono(codec);\r\narizona_init_notifiers(codec);\r\nfor (i = 0; i < WM5110_NUM_ADSP; ++i) {\r\nret = wm_adsp2_codec_probe(&priv->core.adsp[i], codec);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\n}\r\nret = snd_soc_add_codec_controls(codec,\r\narizona_adsp2_rate_controls,\r\nWM5110_NUM_ADSP);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\nsnd_soc_component_disable_pin(component, "HAPTICS");\r\nreturn 0;\r\nerr_adsp2_codec_probe:\r\nfor (--i; i >= 0; --i)\r\nwm_adsp2_codec_remove(&priv->core.adsp[i], codec);\r\nreturn ret;\r\n}\r\nstatic int wm5110_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct wm5110_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nint i;\r\nfor (i = 0; i < WM5110_NUM_ADSP; ++i)\r\nwm_adsp2_codec_remove(&priv->core.adsp[i], codec);\r\npriv->core.arizona->dapm = NULL;\r\nreturn 0;\r\n}\r\nstatic struct regmap *wm5110_get_regmap(struct device *dev)\r\n{\r\nstruct wm5110_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int wm5110_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm5110_priv *wm5110;\r\nint i, ret;\r\nwm5110 = devm_kzalloc(&pdev->dev, sizeof(struct wm5110_priv),\r\nGFP_KERNEL);\r\nif (wm5110 == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm5110);\r\nwm5110->core.arizona = arizona;\r\nwm5110->core.num_inputs = 8;\r\nfor (i = 0; i < WM5110_NUM_ADSP; i++) {\r\nwm5110->core.adsp[i].part = "wm5110";\r\nwm5110->core.adsp[i].num = i + 1;\r\nwm5110->core.adsp[i].type = WMFW_ADSP2;\r\nwm5110->core.adsp[i].dev = arizona->dev;\r\nwm5110->core.adsp[i].regmap = arizona->regmap;\r\nwm5110->core.adsp[i].base = ARIZONA_DSP1_CONTROL_1\r\n+ (0x100 * i);\r\nwm5110->core.adsp[i].mem = wm5110_dsp_regions[i];\r\nwm5110->core.adsp[i].num_mems\r\n= ARRAY_SIZE(wm5110_dsp1_regions);\r\nret = wm_adsp2_init(&wm5110->core.adsp[i]);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm5110->fll); i++)\r\nwm5110->fll[i].vco_mult = 3;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&wm5110->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&wm5110->fll[1]);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_2,\r\nARIZONA_SAMPLE_RATE_2_MASK, 0x11);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_3,\r\nARIZONA_SAMPLE_RATE_3_MASK, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(wm5110_dai); i++)\r\narizona_init_dai(&wm5110->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(wm5110_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, wm5110_digital_vu[i],\r\nWM5110_DIG_VU, WM5110_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nret = arizona_request_irq(arizona, ARIZONA_IRQ_DSP_IRQ1,\r\n"ADSP2 Compressed IRQ", wm5110_adsp2_irq,\r\nwm5110);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request DSP IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = arizona_init_spk_irqs(arizona);\r\nif (ret < 0)\r\ngoto err_dsp_irq;\r\nret = snd_soc_register_platform(&pdev->dev, &wm5110_compr_platform);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register platform: %d\n", ret);\r\ngoto err_spk_irqs;\r\n}\r\nret = snd_soc_register_codec(&pdev->dev, &soc_codec_dev_wm5110,\r\nwm5110_dai, ARRAY_SIZE(wm5110_dai));\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register codec: %d\n", ret);\r\ngoto err_platform;\r\n}\r\nreturn ret;\r\nerr_platform:\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nerr_spk_irqs:\r\narizona_free_spk_irqs(arizona);\r\nerr_dsp_irq:\r\narizona_free_irq(arizona, ARIZONA_IRQ_DSP_IRQ1, wm5110);\r\nreturn ret;\r\n}\r\nstatic int wm5110_remove(struct platform_device *pdev)\r\n{\r\nstruct wm5110_priv *wm5110 = platform_get_drvdata(pdev);\r\nstruct arizona *arizona = wm5110->core.arizona;\r\nint i;\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nfor (i = 0; i < WM5110_NUM_ADSP; i++)\r\nwm_adsp2_remove(&wm5110->core.adsp[i]);\r\narizona_free_spk_irqs(arizona);\r\narizona_free_irq(arizona, ARIZONA_IRQ_DSP_IRQ1, wm5110);\r\nreturn 0;\r\n}

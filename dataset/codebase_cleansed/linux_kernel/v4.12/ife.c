void *ife_encode(struct sk_buff *skb, u16 metalen)\r\n{\r\nint hdrm = metalen + IFE_METAHDRLEN;\r\nint total_push = hdrm + skb->dev->hard_header_len;\r\nstruct ifeheadr *ifehdr;\r\nstruct ethhdr *iethh;\r\nint skboff = 0;\r\nint err;\r\nerr = skb_cow_head(skb, total_push);\r\nif (unlikely(err))\r\nreturn NULL;\r\niethh = (struct ethhdr *) skb->data;\r\n__skb_push(skb, total_push);\r\nmemcpy(skb->data, iethh, skb->dev->hard_header_len);\r\nskb_reset_mac_header(skb);\r\nskboff += skb->dev->hard_header_len;\r\nifehdr = (struct ifeheadr *) (skb->data + skboff);\r\nmetalen += IFE_METAHDRLEN;\r\nifehdr->metalen = htons(metalen);\r\nreturn ifehdr->tlv_data;\r\n}\r\nvoid *ife_decode(struct sk_buff *skb, u16 *metalen)\r\n{\r\nstruct ifeheadr *ifehdr;\r\nint total_pull;\r\nu16 ifehdrln;\r\nifehdr = (struct ifeheadr *) (skb->data + skb->dev->hard_header_len);\r\nifehdrln = ntohs(ifehdr->metalen);\r\ntotal_pull = skb->dev->hard_header_len + ifehdrln;\r\nif (unlikely(ifehdrln < 2))\r\nreturn NULL;\r\nif (unlikely(!pskb_may_pull(skb, total_pull)))\r\nreturn NULL;\r\nskb_set_mac_header(skb, total_pull);\r\n__skb_pull(skb, total_pull);\r\n*metalen = ifehdrln - IFE_METAHDRLEN;\r\nreturn &ifehdr->tlv_data;\r\n}\r\nvoid *ife_tlv_meta_decode(void *skbdata, u16 *attrtype, u16 *dlen, u16 *totlen)\r\n{\r\nstruct meta_tlvhdr *tlv = (struct meta_tlvhdr *) skbdata;\r\n*dlen = ntohs(tlv->len) - NLA_HDRLEN;\r\n*attrtype = ntohs(tlv->type);\r\nif (totlen)\r\n*totlen = nla_total_size(*dlen);\r\nreturn skbdata + sizeof(struct meta_tlvhdr);\r\n}\r\nvoid *ife_tlv_meta_next(void *skbdata)\r\n{\r\nstruct meta_tlvhdr *tlv = (struct meta_tlvhdr *) skbdata;\r\nu16 tlvlen = ntohs(tlv->len);\r\ntlvlen = NLA_ALIGN(tlvlen);\r\nreturn skbdata + tlvlen;\r\n}\r\nint ife_tlv_meta_encode(void *skbdata, u16 attrtype, u16 dlen, const void *dval)\r\n{\r\n__be32 *tlv = (__be32 *) (skbdata);\r\nu16 totlen = nla_total_size(dlen);\r\nchar *dptr = (char *) tlv + NLA_HDRLEN;\r\nu32 htlv = attrtype << 16 | (dlen + NLA_HDRLEN);\r\n*tlv = htonl(htlv);\r\nmemset(dptr, 0, totlen - NLA_HDRLEN);\r\nmemcpy(dptr, dval, dlen);\r\nreturn totlen;\r\n}

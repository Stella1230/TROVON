static void hp_ev(struct hid_device *hid, struct cmhid *cm, int value)\r\n{\r\ninput_report_switch(cm->input_dev, SW_HEADPHONE_INSERT, value);\r\ninput_sync(cm->input_dev);\r\n}\r\nstatic int cmhid_raw_event(struct hid_device *hid, struct hid_report *report,\r\nu8 *data, int len)\r\n{\r\nstruct cmhid *cm = hid_get_drvdata(hid);\r\nif (len != CM6533_JD_RAWEV_LEN)\r\ngoto out;\r\nif (memcmp(data+CM6533_JD_SFX_OFFSET, ji_sfx, sizeof(ji_sfx)))\r\ngoto out;\r\nif (!memcmp(data, ji_out, sizeof(ji_out))) {\r\nhp_ev(hid, cm, 0);\r\ngoto out;\r\n}\r\nif (!memcmp(data, ji_in, sizeof(ji_in))) {\r\nhp_ev(hid, cm, 1);\r\ngoto out;\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nstatic int cmhid_input_configured(struct hid_device *hid,\r\nstruct hid_input *hidinput)\r\n{\r\nstruct input_dev *input_dev = hidinput->input;\r\nstruct cmhid *cm = hid_get_drvdata(hid);\r\nint i;\r\ncm->input_dev = input_dev;\r\nmemcpy(cm->switch_map, jack_switch_types, sizeof(cm->switch_map));\r\ninput_dev->evbit[0] = BIT(EV_SW);\r\nfor (i = 0; i < CM6533_JD_TYPE_COUNT; i++)\r\ninput_set_capability(cm->input_dev,\r\nEV_SW, jack_switch_types[i]);\r\nreturn 0;\r\n}\r\nstatic int cmhid_input_mapping(struct hid_device *hid,\r\nstruct hid_input *hi, struct hid_field *field,\r\nstruct hid_usage *usage, unsigned long **bit, int *max)\r\n{\r\nreturn -1;\r\n}\r\nstatic int cmhid_probe(struct hid_device *hid, const struct hid_device_id *id)\r\n{\r\nint ret;\r\nstruct cmhid *cm;\r\ncm = kzalloc(sizeof(struct cmhid), GFP_KERNEL);\r\nif (!cm) {\r\nret = -ENOMEM;\r\ngoto allocfail;\r\n}\r\ncm->hid = hid;\r\nhid->quirks |= HID_QUIRK_HIDINPUT_FORCE;\r\nhid_set_drvdata(hid, cm);\r\nret = hid_parse(hid);\r\nif (ret) {\r\nhid_err(hid, "parse failed\n");\r\ngoto fail;\r\n}\r\nret = hid_hw_start(hid, HID_CONNECT_DEFAULT | HID_CONNECT_HIDDEV_FORCE);\r\nif (ret) {\r\nhid_err(hid, "hw start failed\n");\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nkfree(cm);\r\nallocfail:\r\nreturn ret;\r\n}\r\nstatic void cmhid_remove(struct hid_device *hid)\r\n{\r\nstruct cmhid *cm = hid_get_drvdata(hid);\r\nhid_hw_stop(hid);\r\nkfree(cm);\r\n}

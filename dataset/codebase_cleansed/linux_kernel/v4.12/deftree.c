static void send_bits(\r\ndeflate_state *s,\r\nint value,\r\nint length\r\n)\r\n{\r\nTracevv((stderr," l %2d v %4x ", length, value));\r\nAssert(length > 0 && length <= 15, "invalid length");\r\ns->bits_sent += (ulg)length;\r\nif (s->bi_valid > (int)Buf_size - length) {\r\ns->bi_buf |= (value << s->bi_valid);\r\nput_short(s, s->bi_buf);\r\ns->bi_buf = (ush)value >> (Buf_size - s->bi_valid);\r\ns->bi_valid += length - Buf_size;\r\n} else {\r\ns->bi_buf |= value << s->bi_valid;\r\ns->bi_valid += length;\r\n}\r\n}\r\nstatic void tr_static_init(void)\r\n{\r\nstatic int static_init_done;\r\nint n;\r\nint bits;\r\nint length;\r\nint code;\r\nint dist;\r\nush bl_count[MAX_BITS+1];\r\nif (static_init_done) return;\r\nlength = 0;\r\nfor (code = 0; code < LENGTH_CODES-1; code++) {\r\nbase_length[code] = length;\r\nfor (n = 0; n < (1<<extra_lbits[code]); n++) {\r\nlength_code[length++] = (uch)code;\r\n}\r\n}\r\nAssert (length == 256, "tr_static_init: length != 256");\r\nlength_code[length-1] = (uch)code;\r\ndist = 0;\r\nfor (code = 0 ; code < 16; code++) {\r\nbase_dist[code] = dist;\r\nfor (n = 0; n < (1<<extra_dbits[code]); n++) {\r\ndist_code[dist++] = (uch)code;\r\n}\r\n}\r\nAssert (dist == 256, "tr_static_init: dist != 256");\r\ndist >>= 7;\r\nfor ( ; code < D_CODES; code++) {\r\nbase_dist[code] = dist << 7;\r\nfor (n = 0; n < (1<<(extra_dbits[code]-7)); n++) {\r\ndist_code[256 + dist++] = (uch)code;\r\n}\r\n}\r\nAssert (dist == 256, "tr_static_init: 256+dist != 512");\r\nfor (bits = 0; bits <= MAX_BITS; bits++) bl_count[bits] = 0;\r\nn = 0;\r\nwhile (n <= 143) static_ltree[n++].Len = 8, bl_count[8]++;\r\nwhile (n <= 255) static_ltree[n++].Len = 9, bl_count[9]++;\r\nwhile (n <= 279) static_ltree[n++].Len = 7, bl_count[7]++;\r\nwhile (n <= 287) static_ltree[n++].Len = 8, bl_count[8]++;\r\ngen_codes((ct_data *)static_ltree, L_CODES+1, bl_count);\r\nfor (n = 0; n < D_CODES; n++) {\r\nstatic_dtree[n].Len = 5;\r\nstatic_dtree[n].Code = bitrev32((u32)n) >> (32 - 5);\r\n}\r\nstatic_init_done = 1;\r\n}\r\nvoid zlib_tr_init(\r\ndeflate_state *s\r\n)\r\n{\r\ntr_static_init();\r\ns->compressed_len = 0L;\r\ns->l_desc.dyn_tree = s->dyn_ltree;\r\ns->l_desc.stat_desc = &static_l_desc;\r\ns->d_desc.dyn_tree = s->dyn_dtree;\r\ns->d_desc.stat_desc = &static_d_desc;\r\ns->bl_desc.dyn_tree = s->bl_tree;\r\ns->bl_desc.stat_desc = &static_bl_desc;\r\ns->bi_buf = 0;\r\ns->bi_valid = 0;\r\ns->last_eob_len = 8;\r\n#ifdef DEBUG_ZLIB\r\ns->bits_sent = 0L;\r\n#endif\r\ninit_block(s);\r\n}\r\nstatic void init_block(\r\ndeflate_state *s\r\n)\r\n{\r\nint n;\r\nfor (n = 0; n < L_CODES; n++) s->dyn_ltree[n].Freq = 0;\r\nfor (n = 0; n < D_CODES; n++) s->dyn_dtree[n].Freq = 0;\r\nfor (n = 0; n < BL_CODES; n++) s->bl_tree[n].Freq = 0;\r\ns->dyn_ltree[END_BLOCK].Freq = 1;\r\ns->opt_len = s->static_len = 0L;\r\ns->last_lit = s->matches = 0;\r\n}\r\nstatic void pqdownheap(\r\ndeflate_state *s,\r\nct_data *tree,\r\nint k\r\n)\r\n{\r\nint v = s->heap[k];\r\nint j = k << 1;\r\nwhile (j <= s->heap_len) {\r\nif (j < s->heap_len &&\r\nsmaller(tree, s->heap[j+1], s->heap[j], s->depth)) {\r\nj++;\r\n}\r\nif (smaller(tree, v, s->heap[j], s->depth)) break;\r\ns->heap[k] = s->heap[j]; k = j;\r\nj <<= 1;\r\n}\r\ns->heap[k] = v;\r\n}\r\nstatic void gen_bitlen(\r\ndeflate_state *s,\r\ntree_desc *desc\r\n)\r\n{\r\nct_data *tree = desc->dyn_tree;\r\nint max_code = desc->max_code;\r\nconst ct_data *stree = desc->stat_desc->static_tree;\r\nconst int *extra = desc->stat_desc->extra_bits;\r\nint base = desc->stat_desc->extra_base;\r\nint max_length = desc->stat_desc->max_length;\r\nint h;\r\nint n, m;\r\nint bits;\r\nint xbits;\r\nush f;\r\nint overflow = 0;\r\nfor (bits = 0; bits <= MAX_BITS; bits++) s->bl_count[bits] = 0;\r\ntree[s->heap[s->heap_max]].Len = 0;\r\nfor (h = s->heap_max+1; h < HEAP_SIZE; h++) {\r\nn = s->heap[h];\r\nbits = tree[tree[n].Dad].Len + 1;\r\nif (bits > max_length) bits = max_length, overflow++;\r\ntree[n].Len = (ush)bits;\r\nif (n > max_code) continue;\r\ns->bl_count[bits]++;\r\nxbits = 0;\r\nif (n >= base) xbits = extra[n-base];\r\nf = tree[n].Freq;\r\ns->opt_len += (ulg)f * (bits + xbits);\r\nif (stree) s->static_len += (ulg)f * (stree[n].Len + xbits);\r\n}\r\nif (overflow == 0) return;\r\nTrace((stderr,"\nbit length overflow\n"));\r\ndo {\r\nbits = max_length-1;\r\nwhile (s->bl_count[bits] == 0) bits--;\r\ns->bl_count[bits]--;\r\ns->bl_count[bits+1] += 2;\r\ns->bl_count[max_length]--;\r\noverflow -= 2;\r\n} while (overflow > 0);\r\nfor (bits = max_length; bits != 0; bits--) {\r\nn = s->bl_count[bits];\r\nwhile (n != 0) {\r\nm = s->heap[--h];\r\nif (m > max_code) continue;\r\nif (tree[m].Len != (unsigned) bits) {\r\nTrace((stderr,"code %d bits %d->%d\n", m, tree[m].Len, bits));\r\ns->opt_len += ((long)bits - (long)tree[m].Len)\r\n*(long)tree[m].Freq;\r\ntree[m].Len = (ush)bits;\r\n}\r\nn--;\r\n}\r\n}\r\n}\r\nstatic void gen_codes(\r\nct_data *tree,\r\nint max_code,\r\nush *bl_count\r\n)\r\n{\r\nush next_code[MAX_BITS+1];\r\nush code = 0;\r\nint bits;\r\nint n;\r\nfor (bits = 1; bits <= MAX_BITS; bits++) {\r\nnext_code[bits] = code = (code + bl_count[bits-1]) << 1;\r\n}\r\nAssert (code + bl_count[MAX_BITS]-1 == (1<<MAX_BITS)-1,\r\n"inconsistent bit counts");\r\nTracev((stderr,"\ngen_codes: max_code %d ", max_code));\r\nfor (n = 0; n <= max_code; n++) {\r\nint len = tree[n].Len;\r\nif (len == 0) continue;\r\ntree[n].Code = bitrev32((u32)(next_code[len]++)) >> (32 - len);\r\nTracecv(tree != static_ltree, (stderr,"\nn %3d %c l %2d c %4x (%x) ",\r\nn, (isgraph(n) ? n : ' '), len, tree[n].Code, next_code[len]-1));\r\n}\r\n}\r\nstatic void build_tree(\r\ndeflate_state *s,\r\ntree_desc *desc\r\n)\r\n{\r\nct_data *tree = desc->dyn_tree;\r\nconst ct_data *stree = desc->stat_desc->static_tree;\r\nint elems = desc->stat_desc->elems;\r\nint n, m;\r\nint max_code = -1;\r\nint node;\r\ns->heap_len = 0, s->heap_max = HEAP_SIZE;\r\nfor (n = 0; n < elems; n++) {\r\nif (tree[n].Freq != 0) {\r\ns->heap[++(s->heap_len)] = max_code = n;\r\ns->depth[n] = 0;\r\n} else {\r\ntree[n].Len = 0;\r\n}\r\n}\r\nwhile (s->heap_len < 2) {\r\nnode = s->heap[++(s->heap_len)] = (max_code < 2 ? ++max_code : 0);\r\ntree[node].Freq = 1;\r\ns->depth[node] = 0;\r\ns->opt_len--; if (stree) s->static_len -= stree[node].Len;\r\n}\r\ndesc->max_code = max_code;\r\nfor (n = s->heap_len/2; n >= 1; n--) pqdownheap(s, tree, n);\r\nnode = elems;\r\ndo {\r\npqremove(s, tree, n);\r\nm = s->heap[SMALLEST];\r\ns->heap[--(s->heap_max)] = n;\r\ns->heap[--(s->heap_max)] = m;\r\ntree[node].Freq = tree[n].Freq + tree[m].Freq;\r\ns->depth[node] = (uch) (max(s->depth[n], s->depth[m]) + 1);\r\ntree[n].Dad = tree[m].Dad = (ush)node;\r\n#ifdef DUMP_BL_TREE\r\nif (tree == s->bl_tree) {\r\nfprintf(stderr,"\nnode %d(%d), sons %d(%d) %d(%d)",\r\nnode, tree[node].Freq, n, tree[n].Freq, m, tree[m].Freq);\r\n}\r\n#endif\r\ns->heap[SMALLEST] = node++;\r\npqdownheap(s, tree, SMALLEST);\r\n} while (s->heap_len >= 2);\r\ns->heap[--(s->heap_max)] = s->heap[SMALLEST];\r\ngen_bitlen(s, (tree_desc *)desc);\r\ngen_codes ((ct_data *)tree, max_code, s->bl_count);\r\n}\r\nstatic void scan_tree(\r\ndeflate_state *s,\r\nct_data *tree,\r\nint max_code\r\n)\r\n{\r\nint n;\r\nint prevlen = -1;\r\nint curlen;\r\nint nextlen = tree[0].Len;\r\nint count = 0;\r\nint max_count = 7;\r\nint min_count = 4;\r\nif (nextlen == 0) max_count = 138, min_count = 3;\r\ntree[max_code+1].Len = (ush)0xffff;\r\nfor (n = 0; n <= max_code; n++) {\r\ncurlen = nextlen; nextlen = tree[n+1].Len;\r\nif (++count < max_count && curlen == nextlen) {\r\ncontinue;\r\n} else if (count < min_count) {\r\ns->bl_tree[curlen].Freq += count;\r\n} else if (curlen != 0) {\r\nif (curlen != prevlen) s->bl_tree[curlen].Freq++;\r\ns->bl_tree[REP_3_6].Freq++;\r\n} else if (count <= 10) {\r\ns->bl_tree[REPZ_3_10].Freq++;\r\n} else {\r\ns->bl_tree[REPZ_11_138].Freq++;\r\n}\r\ncount = 0; prevlen = curlen;\r\nif (nextlen == 0) {\r\nmax_count = 138, min_count = 3;\r\n} else if (curlen == nextlen) {\r\nmax_count = 6, min_count = 3;\r\n} else {\r\nmax_count = 7, min_count = 4;\r\n}\r\n}\r\n}\r\nstatic void send_tree(\r\ndeflate_state *s,\r\nct_data *tree,\r\nint max_code\r\n)\r\n{\r\nint n;\r\nint prevlen = -1;\r\nint curlen;\r\nint nextlen = tree[0].Len;\r\nint count = 0;\r\nint max_count = 7;\r\nint min_count = 4;\r\nif (nextlen == 0) max_count = 138, min_count = 3;\r\nfor (n = 0; n <= max_code; n++) {\r\ncurlen = nextlen; nextlen = tree[n+1].Len;\r\nif (++count < max_count && curlen == nextlen) {\r\ncontinue;\r\n} else if (count < min_count) {\r\ndo { send_code(s, curlen, s->bl_tree); } while (--count != 0);\r\n} else if (curlen != 0) {\r\nif (curlen != prevlen) {\r\nsend_code(s, curlen, s->bl_tree); count--;\r\n}\r\nAssert(count >= 3 && count <= 6, " 3_6?");\r\nsend_code(s, REP_3_6, s->bl_tree); send_bits(s, count-3, 2);\r\n} else if (count <= 10) {\r\nsend_code(s, REPZ_3_10, s->bl_tree); send_bits(s, count-3, 3);\r\n} else {\r\nsend_code(s, REPZ_11_138, s->bl_tree); send_bits(s, count-11, 7);\r\n}\r\ncount = 0; prevlen = curlen;\r\nif (nextlen == 0) {\r\nmax_count = 138, min_count = 3;\r\n} else if (curlen == nextlen) {\r\nmax_count = 6, min_count = 3;\r\n} else {\r\nmax_count = 7, min_count = 4;\r\n}\r\n}\r\n}\r\nstatic int build_bl_tree(\r\ndeflate_state *s\r\n)\r\n{\r\nint max_blindex;\r\nscan_tree(s, (ct_data *)s->dyn_ltree, s->l_desc.max_code);\r\nscan_tree(s, (ct_data *)s->dyn_dtree, s->d_desc.max_code);\r\nbuild_tree(s, (tree_desc *)(&(s->bl_desc)));\r\nfor (max_blindex = BL_CODES-1; max_blindex >= 3; max_blindex--) {\r\nif (s->bl_tree[bl_order[max_blindex]].Len != 0) break;\r\n}\r\ns->opt_len += 3*(max_blindex+1) + 5+5+4;\r\nTracev((stderr, "\ndyn trees: dyn %ld, stat %ld",\r\ns->opt_len, s->static_len));\r\nreturn max_blindex;\r\n}\r\nstatic void send_all_trees(\r\ndeflate_state *s,\r\nint lcodes,\r\nint dcodes,\r\nint blcodes\r\n)\r\n{\r\nint rank;\r\nAssert (lcodes >= 257 && dcodes >= 1 && blcodes >= 4, "not enough codes");\r\nAssert (lcodes <= L_CODES && dcodes <= D_CODES && blcodes <= BL_CODES,\r\n"too many codes");\r\nTracev((stderr, "\nbl counts: "));\r\nsend_bits(s, lcodes-257, 5);\r\nsend_bits(s, dcodes-1, 5);\r\nsend_bits(s, blcodes-4, 4);\r\nfor (rank = 0; rank < blcodes; rank++) {\r\nTracev((stderr, "\nbl code %2d ", bl_order[rank]));\r\nsend_bits(s, s->bl_tree[bl_order[rank]].Len, 3);\r\n}\r\nTracev((stderr, "\nbl tree: sent %ld", s->bits_sent));\r\nsend_tree(s, (ct_data *)s->dyn_ltree, lcodes-1);\r\nTracev((stderr, "\nlit tree: sent %ld", s->bits_sent));\r\nsend_tree(s, (ct_data *)s->dyn_dtree, dcodes-1);\r\nTracev((stderr, "\ndist tree: sent %ld", s->bits_sent));\r\n}\r\nvoid zlib_tr_stored_block(\r\ndeflate_state *s,\r\nchar *buf,\r\nulg stored_len,\r\nint eof\r\n)\r\n{\r\nsend_bits(s, (STORED_BLOCK<<1)+eof, 3);\r\ns->compressed_len = (s->compressed_len + 3 + 7) & (ulg)~7L;\r\ns->compressed_len += (stored_len + 4) << 3;\r\ncopy_block(s, buf, (unsigned)stored_len, 1);\r\n}\r\nvoid zlib_tr_stored_type_only(\r\ndeflate_state *s\r\n)\r\n{\r\nsend_bits(s, (STORED_BLOCK << 1), 3);\r\nbi_windup(s);\r\ns->compressed_len = (s->compressed_len + 3) & ~7L;\r\n}\r\nvoid zlib_tr_align(\r\ndeflate_state *s\r\n)\r\n{\r\nsend_bits(s, STATIC_TREES<<1, 3);\r\nsend_code(s, END_BLOCK, static_ltree);\r\ns->compressed_len += 10L;\r\nbi_flush(s);\r\nif (1 + s->last_eob_len + 10 - s->bi_valid < 9) {\r\nsend_bits(s, STATIC_TREES<<1, 3);\r\nsend_code(s, END_BLOCK, static_ltree);\r\ns->compressed_len += 10L;\r\nbi_flush(s);\r\n}\r\ns->last_eob_len = 7;\r\n}\r\nint zlib_tr_tally(\r\ndeflate_state *s,\r\nunsigned dist,\r\nunsigned lc\r\n)\r\n{\r\ns->d_buf[s->last_lit] = (ush)dist;\r\ns->l_buf[s->last_lit++] = (uch)lc;\r\nif (dist == 0) {\r\ns->dyn_ltree[lc].Freq++;\r\n} else {\r\ns->matches++;\r\ndist--;\r\nAssert((ush)dist < (ush)MAX_DIST(s) &&\r\n(ush)lc <= (ush)(MAX_MATCH-MIN_MATCH) &&\r\n(ush)d_code(dist) < (ush)D_CODES, "zlib_tr_tally: bad match");\r\ns->dyn_ltree[length_code[lc]+LITERALS+1].Freq++;\r\ns->dyn_dtree[d_code(dist)].Freq++;\r\n}\r\nif ((s->last_lit & 0xfff) == 0 && s->level > 2) {\r\nulg out_length = (ulg)s->last_lit*8L;\r\nulg in_length = (ulg)((long)s->strstart - s->block_start);\r\nint dcode;\r\nfor (dcode = 0; dcode < D_CODES; dcode++) {\r\nout_length += (ulg)s->dyn_dtree[dcode].Freq *\r\n(5L+extra_dbits[dcode]);\r\n}\r\nout_length >>= 3;\r\nTracev((stderr,"\nlast_lit %u, in %ld, out ~%ld(%ld%%) ",\r\ns->last_lit, in_length, out_length,\r\n100L - out_length*100L/in_length));\r\nif (s->matches < s->last_lit/2 && out_length < in_length/2) return 1;\r\n}\r\nreturn (s->last_lit == s->lit_bufsize-1);\r\n}\r\nstatic void compress_block(\r\ndeflate_state *s,\r\nct_data *ltree,\r\nct_data *dtree\r\n)\r\n{\r\nunsigned dist;\r\nint lc;\r\nunsigned lx = 0;\r\nunsigned code;\r\nint extra;\r\nif (s->last_lit != 0) do {\r\ndist = s->d_buf[lx];\r\nlc = s->l_buf[lx++];\r\nif (dist == 0) {\r\nsend_code(s, lc, ltree);\r\nTracecv(isgraph(lc), (stderr," '%c' ", lc));\r\n} else {\r\ncode = length_code[lc];\r\nsend_code(s, code+LITERALS+1, ltree);\r\nextra = extra_lbits[code];\r\nif (extra != 0) {\r\nlc -= base_length[code];\r\nsend_bits(s, lc, extra);\r\n}\r\ndist--;\r\ncode = d_code(dist);\r\nAssert (code < D_CODES, "bad d_code");\r\nsend_code(s, code, dtree);\r\nextra = extra_dbits[code];\r\nif (extra != 0) {\r\ndist -= base_dist[code];\r\nsend_bits(s, dist, extra);\r\n}\r\n}\r\nAssert(s->pending < s->lit_bufsize + 2*lx, "pendingBuf overflow");\r\n} while (lx < s->last_lit);\r\nsend_code(s, END_BLOCK, ltree);\r\ns->last_eob_len = ltree[END_BLOCK].Len;\r\n}\r\nstatic void set_data_type(\r\ndeflate_state *s\r\n)\r\n{\r\nint n = 0;\r\nunsigned ascii_freq = 0;\r\nunsigned bin_freq = 0;\r\nwhile (n < 7) bin_freq += s->dyn_ltree[n++].Freq;\r\nwhile (n < 128) ascii_freq += s->dyn_ltree[n++].Freq;\r\nwhile (n < LITERALS) bin_freq += s->dyn_ltree[n++].Freq;\r\ns->data_type = (Byte)(bin_freq > (ascii_freq >> 2) ? Z_BINARY : Z_ASCII);\r\n}\r\nstatic void copy_block(\r\ndeflate_state *s,\r\nchar *buf,\r\nunsigned len,\r\nint header\r\n)\r\n{\r\nbi_windup(s);\r\ns->last_eob_len = 8;\r\nif (header) {\r\nput_short(s, (ush)len);\r\nput_short(s, (ush)~len);\r\n#ifdef DEBUG_ZLIB\r\ns->bits_sent += 2*16;\r\n#endif\r\n}\r\n#ifdef DEBUG_ZLIB\r\ns->bits_sent += (ulg)len<<3;\r\n#endif\r\nmemcpy(&s->pending_buf[s->pending], buf, len);\r\ns->pending += len;\r\n}

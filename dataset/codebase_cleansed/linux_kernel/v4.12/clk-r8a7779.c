static struct clk * __init\r\nr8a7779_cpg_register_clock(struct device_node *np, struct r8a7779_cpg *cpg,\r\nconst struct cpg_clk_config *config,\r\nunsigned int plla_mult, const char *name)\r\n{\r\nconst char *parent_name = "plla";\r\nunsigned int mult = 1;\r\nunsigned int div = 1;\r\nif (!strcmp(name, "plla")) {\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nmult = plla_mult;\r\n} else if (!strcmp(name, "z")) {\r\ndiv = config->z_div;\r\nmult = config->z_mult;\r\n} else if (!strcmp(name, "zs") || !strcmp(name, "s")) {\r\ndiv = config->zs_and_s_div;\r\n} else if (!strcmp(name, "s1")) {\r\ndiv = config->s1_div;\r\n} else if (!strcmp(name, "p")) {\r\ndiv = config->p_div;\r\n} else if (!strcmp(name, "b") || !strcmp(name, "out")) {\r\ndiv = config->b_and_out_div;\r\n} else {\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nreturn clk_register_fixed_factor(NULL, name, parent_name, 0, mult, div);\r\n}\r\nstatic void __init r8a7779_cpg_clocks_init(struct device_node *np)\r\n{\r\nconst struct cpg_clk_config *config;\r\nstruct r8a7779_cpg *cpg;\r\nstruct clk **clks;\r\nunsigned int i, plla_mult;\r\nint num_clks;\r\nu32 mode;\r\nif (rcar_rst_read_mode_pins(&mode))\r\nreturn;\r\nnum_clks = of_property_count_strings(np, "clock-output-names");\r\nif (num_clks < 0) {\r\npr_err("%s: failed to count clocks\n", __func__);\r\nreturn;\r\n}\r\ncpg = kzalloc(sizeof(*cpg), GFP_KERNEL);\r\nclks = kzalloc(CPG_NUM_CLOCKS * sizeof(*clks), GFP_KERNEL);\r\nif (cpg == NULL || clks == NULL) {\r\nreturn;\r\n}\r\nspin_lock_init(&cpg->lock);\r\ncpg->data.clks = clks;\r\ncpg->data.clk_num = num_clks;\r\nconfig = &cpg_clk_configs[CPG_CLK_CONFIG_INDEX(mode)];\r\nplla_mult = cpg_plla_mult[CPG_PLLA_MULT_INDEX(mode)];\r\nfor (i = 0; i < num_clks; ++i) {\r\nconst char *name;\r\nstruct clk *clk;\r\nof_property_read_string_index(np, "clock-output-names", i,\r\n&name);\r\nclk = r8a7779_cpg_register_clock(np, cpg, config,\r\nplla_mult, name);\r\nif (IS_ERR(clk))\r\npr_err("%s: failed to register %s %s clock (%ld)\n",\r\n__func__, np->name, name, PTR_ERR(clk));\r\nelse\r\ncpg->data.clks[i] = clk;\r\n}\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &cpg->data);\r\ncpg_mstp_add_clk_domain(np);\r\n}

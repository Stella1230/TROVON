int lov_merge_lvb_kms(struct lov_stripe_md *lsm,\r\nstruct ost_lvb *lvb, __u64 *kms_place)\r\n{\r\n__u64 size = 0;\r\n__u64 kms = 0;\r\n__u64 blocks = 0;\r\ns64 current_mtime = lvb->lvb_mtime;\r\ns64 current_atime = lvb->lvb_atime;\r\ns64 current_ctime = lvb->lvb_ctime;\r\nint i;\r\nint rc = 0;\r\nassert_spin_locked(&lsm->lsm_lock);\r\nLASSERT(lsm->lsm_lock_owner == current_pid());\r\nCDEBUG(D_INODE, "MDT ID "DOSTID" initial value: s=%llu m=%llu a=%llu c=%llu b=%llu\n",\r\nPOSTID(&lsm->lsm_oi), lvb->lvb_size, lvb->lvb_mtime,\r\nlvb->lvb_atime, lvb->lvb_ctime, lvb->lvb_blocks);\r\nfor (i = 0; i < lsm->lsm_stripe_count; i++) {\r\nstruct lov_oinfo *loi = lsm->lsm_oinfo[i];\r\nu64 lov_size, tmpsize;\r\nif (OST_LVB_IS_ERR(loi->loi_lvb.lvb_blocks)) {\r\nrc = OST_LVB_GET_ERR(loi->loi_lvb.lvb_blocks);\r\ncontinue;\r\n}\r\ntmpsize = loi->loi_kms;\r\nlov_size = lov_stripe_size(lsm, tmpsize, i);\r\nif (lov_size > kms)\r\nkms = lov_size;\r\nif (loi->loi_lvb.lvb_size > tmpsize)\r\ntmpsize = loi->loi_lvb.lvb_size;\r\nlov_size = lov_stripe_size(lsm, tmpsize, i);\r\nif (lov_size > size)\r\nsize = lov_size;\r\nblocks += loi->loi_lvb.lvb_blocks;\r\nif (loi->loi_lvb.lvb_mtime > current_mtime)\r\ncurrent_mtime = loi->loi_lvb.lvb_mtime;\r\nif (loi->loi_lvb.lvb_atime > current_atime)\r\ncurrent_atime = loi->loi_lvb.lvb_atime;\r\nif (loi->loi_lvb.lvb_ctime > current_ctime)\r\ncurrent_ctime = loi->loi_lvb.lvb_ctime;\r\nCDEBUG(D_INODE, "MDT ID "DOSTID" on OST[%u]: s=%llu m=%llu a=%llu c=%llu b=%llu\n",\r\nPOSTID(&lsm->lsm_oi), loi->loi_ost_idx,\r\nloi->loi_lvb.lvb_size, loi->loi_lvb.lvb_mtime,\r\nloi->loi_lvb.lvb_atime, loi->loi_lvb.lvb_ctime,\r\nloi->loi_lvb.lvb_blocks);\r\n}\r\n*kms_place = kms;\r\nlvb->lvb_size = size;\r\nlvb->lvb_blocks = blocks;\r\nlvb->lvb_mtime = current_mtime;\r\nlvb->lvb_atime = current_atime;\r\nlvb->lvb_ctime = current_ctime;\r\nreturn rc;\r\n}

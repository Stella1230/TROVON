void msm_hdmi_bridge_destroy(struct drm_bridge *bridge)\r\n{\r\n}\r\nstatic void msm_hdmi_power_on(struct drm_bridge *bridge)\r\n{\r\nstruct drm_device *dev = bridge->dev;\r\nstruct hdmi_bridge *hdmi_bridge = to_hdmi_bridge(bridge);\r\nstruct hdmi *hdmi = hdmi_bridge->hdmi;\r\nconst struct hdmi_platform_config *config = hdmi->config;\r\nint i, ret;\r\nfor (i = 0; i < config->pwr_reg_cnt; i++) {\r\nret = regulator_enable(hdmi->pwr_regs[i]);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to enable pwr regulator: %s (%d)\n",\r\nconfig->pwr_reg_names[i], ret);\r\n}\r\n}\r\nif (config->pwr_clk_cnt > 0) {\r\nDBG("pixclock: %lu", hdmi->pixclock);\r\nret = clk_set_rate(hdmi->pwr_clks[0], hdmi->pixclock);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to set pixel clk: %s (%d)\n",\r\nconfig->pwr_clk_names[0], ret);\r\n}\r\n}\r\nfor (i = 0; i < config->pwr_clk_cnt; i++) {\r\nret = clk_prepare_enable(hdmi->pwr_clks[i]);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to enable pwr clk: %s (%d)\n",\r\nconfig->pwr_clk_names[i], ret);\r\n}\r\n}\r\n}\r\nstatic void power_off(struct drm_bridge *bridge)\r\n{\r\nstruct drm_device *dev = bridge->dev;\r\nstruct hdmi_bridge *hdmi_bridge = to_hdmi_bridge(bridge);\r\nstruct hdmi *hdmi = hdmi_bridge->hdmi;\r\nconst struct hdmi_platform_config *config = hdmi->config;\r\nint i, ret;\r\nmdelay(16 + 4);\r\nfor (i = 0; i < config->pwr_clk_cnt; i++)\r\nclk_disable_unprepare(hdmi->pwr_clks[i]);\r\nfor (i = 0; i < config->pwr_reg_cnt; i++) {\r\nret = regulator_disable(hdmi->pwr_regs[i]);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to disable pwr regulator: %s (%d)\n",\r\nconfig->pwr_reg_names[i], ret);\r\n}\r\n}\r\n}\r\nstatic void msm_hdmi_bridge_pre_enable(struct drm_bridge *bridge)\r\n{\r\nstruct hdmi_bridge *hdmi_bridge = to_hdmi_bridge(bridge);\r\nstruct hdmi *hdmi = hdmi_bridge->hdmi;\r\nstruct hdmi_phy *phy = hdmi->phy;\r\nDBG("power up");\r\nif (!hdmi->power_on) {\r\nmsm_hdmi_phy_resource_enable(phy);\r\nmsm_hdmi_power_on(bridge);\r\nhdmi->power_on = true;\r\nmsm_hdmi_audio_update(hdmi);\r\n}\r\nmsm_hdmi_phy_powerup(phy, hdmi->pixclock);\r\nmsm_hdmi_set_mode(hdmi, true);\r\nif (hdmi->hdcp_ctrl)\r\nmsm_hdmi_hdcp_on(hdmi->hdcp_ctrl);\r\n}\r\nstatic void msm_hdmi_bridge_enable(struct drm_bridge *bridge)\r\n{\r\n}\r\nstatic void msm_hdmi_bridge_disable(struct drm_bridge *bridge)\r\n{\r\n}\r\nstatic void msm_hdmi_bridge_post_disable(struct drm_bridge *bridge)\r\n{\r\nstruct hdmi_bridge *hdmi_bridge = to_hdmi_bridge(bridge);\r\nstruct hdmi *hdmi = hdmi_bridge->hdmi;\r\nstruct hdmi_phy *phy = hdmi->phy;\r\nif (hdmi->hdcp_ctrl)\r\nmsm_hdmi_hdcp_off(hdmi->hdcp_ctrl);\r\nDBG("power down");\r\nmsm_hdmi_set_mode(hdmi, false);\r\nmsm_hdmi_phy_powerdown(phy);\r\nif (hdmi->power_on) {\r\npower_off(bridge);\r\nhdmi->power_on = false;\r\nmsm_hdmi_audio_update(hdmi);\r\nmsm_hdmi_phy_resource_disable(phy);\r\n}\r\n}\r\nstatic void msm_hdmi_bridge_mode_set(struct drm_bridge *bridge,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct hdmi_bridge *hdmi_bridge = to_hdmi_bridge(bridge);\r\nstruct hdmi *hdmi = hdmi_bridge->hdmi;\r\nint hstart, hend, vstart, vend;\r\nuint32_t frame_ctrl;\r\nmode = adjusted_mode;\r\nhdmi->pixclock = mode->clock * 1000;\r\nhstart = mode->htotal - mode->hsync_start;\r\nhend = mode->htotal - mode->hsync_start + mode->hdisplay;\r\nvstart = mode->vtotal - mode->vsync_start - 1;\r\nvend = mode->vtotal - mode->vsync_start + mode->vdisplay - 1;\r\nDBG("htotal=%d, vtotal=%d, hstart=%d, hend=%d, vstart=%d, vend=%d",\r\nmode->htotal, mode->vtotal, hstart, hend, vstart, vend);\r\nhdmi_write(hdmi, REG_HDMI_TOTAL,\r\nHDMI_TOTAL_H_TOTAL(mode->htotal - 1) |\r\nHDMI_TOTAL_V_TOTAL(mode->vtotal - 1));\r\nhdmi_write(hdmi, REG_HDMI_ACTIVE_HSYNC,\r\nHDMI_ACTIVE_HSYNC_START(hstart) |\r\nHDMI_ACTIVE_HSYNC_END(hend));\r\nhdmi_write(hdmi, REG_HDMI_ACTIVE_VSYNC,\r\nHDMI_ACTIVE_VSYNC_START(vstart) |\r\nHDMI_ACTIVE_VSYNC_END(vend));\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\r\nhdmi_write(hdmi, REG_HDMI_VSYNC_TOTAL_F2,\r\nHDMI_VSYNC_TOTAL_F2_V_TOTAL(mode->vtotal));\r\nhdmi_write(hdmi, REG_HDMI_VSYNC_ACTIVE_F2,\r\nHDMI_VSYNC_ACTIVE_F2_START(vstart + 1) |\r\nHDMI_VSYNC_ACTIVE_F2_END(vend + 1));\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_VSYNC_TOTAL_F2,\r\nHDMI_VSYNC_TOTAL_F2_V_TOTAL(0));\r\nhdmi_write(hdmi, REG_HDMI_VSYNC_ACTIVE_F2,\r\nHDMI_VSYNC_ACTIVE_F2_START(0) |\r\nHDMI_VSYNC_ACTIVE_F2_END(0));\r\n}\r\nframe_ctrl = 0;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nframe_ctrl |= HDMI_FRAME_CTRL_HSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nframe_ctrl |= HDMI_FRAME_CTRL_VSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\nframe_ctrl |= HDMI_FRAME_CTRL_INTERLACED_EN;\r\nDBG("frame_ctrl=%08x", frame_ctrl);\r\nhdmi_write(hdmi, REG_HDMI_FRAME_CTRL, frame_ctrl);\r\nmsm_hdmi_audio_update(hdmi);\r\n}\r\nstruct drm_bridge *msm_hdmi_bridge_init(struct hdmi *hdmi)\r\n{\r\nstruct drm_bridge *bridge = NULL;\r\nstruct hdmi_bridge *hdmi_bridge;\r\nint ret;\r\nhdmi_bridge = devm_kzalloc(hdmi->dev->dev,\r\nsizeof(*hdmi_bridge), GFP_KERNEL);\r\nif (!hdmi_bridge) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nhdmi_bridge->hdmi = hdmi;\r\nbridge = &hdmi_bridge->base;\r\nbridge->funcs = &msm_hdmi_bridge_funcs;\r\nret = drm_bridge_attach(hdmi->encoder, bridge, NULL);\r\nif (ret)\r\ngoto fail;\r\nreturn bridge;\r\nfail:\r\nif (bridge)\r\nmsm_hdmi_bridge_destroy(bridge);\r\nreturn ERR_PTR(ret);\r\n}

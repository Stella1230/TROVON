static int install_filter(int nr, int arch, int error)\r\n{\r\nstruct sock_filter filter[] = {\r\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,\r\n(offsetof(struct seccomp_data, arch))),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, arch, 0, 3),\r\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,\r\n(offsetof(struct seccomp_data, nr))),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, nr, 0, 1),\r\nBPF_STMT(BPF_RET+BPF_K,\r\nSECCOMP_RET_ERRNO|(error & SECCOMP_RET_DATA)),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\n};\r\nstruct sock_fprog prog = {\r\n.len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),\r\n.filter = filter,\r\n};\r\nif (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {\r\nperror("prctl(NO_NEW_PRIVS)");\r\nreturn 1;\r\n}\r\nif (prctl(PR_SET_SECCOMP, 2, &prog)) {\r\nperror("prctl(PR_SET_SECCOMP)");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nif (argc < 5) {\r\nfprintf(stderr, "Usage:\n"\r\n"dropper <syscall_nr> <arch> <errno> <prog> [<args>]\n"\r\n"Hint: AUDIT_ARCH_I386: 0x%X\n"\r\n" AUDIT_ARCH_X86_64: 0x%X\n"\r\n"\n", AUDIT_ARCH_I386, AUDIT_ARCH_X86_64);\r\nreturn 1;\r\n}\r\nif (install_filter(strtol(argv[1], NULL, 0), strtol(argv[2], NULL, 0),\r\nstrtol(argv[3], NULL, 0)))\r\nreturn 1;\r\nexecv(argv[4], &argv[4]);\r\nprintf("Failed to execv\n");\r\nreturn 255;\r\n}

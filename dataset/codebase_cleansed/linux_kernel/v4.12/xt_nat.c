static int xt_nat_checkentry_v0(const struct xt_tgchk_param *par)\r\n{\r\nconst struct nf_nat_ipv4_multi_range_compat *mr = par->targinfo;\r\nif (mr->rangesize != 1) {\r\npr_info("%s: multiple ranges no longer supported\n",\r\npar->target->name);\r\nreturn -EINVAL;\r\n}\r\nreturn nf_ct_netns_get(par->net, par->family);\r\n}\r\nstatic int xt_nat_checkentry(const struct xt_tgchk_param *par)\r\n{\r\nreturn nf_ct_netns_get(par->net, par->family);\r\n}\r\nstatic void xt_nat_destroy(const struct xt_tgdtor_param *par)\r\n{\r\nnf_ct_netns_put(par->net, par->family);\r\n}\r\nstatic void xt_nat_convert_range(struct nf_nat_range *dst,\r\nconst struct nf_nat_ipv4_range *src)\r\n{\r\nmemset(&dst->min_addr, 0, sizeof(dst->min_addr));\r\nmemset(&dst->max_addr, 0, sizeof(dst->max_addr));\r\ndst->flags = src->flags;\r\ndst->min_addr.ip = src->min_ip;\r\ndst->max_addr.ip = src->max_ip;\r\ndst->min_proto = src->min;\r\ndst->max_proto = src->max;\r\n}\r\nstatic unsigned int\r\nxt_snat_target_v0(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct nf_nat_ipv4_multi_range_compat *mr = par->targinfo;\r\nstruct nf_nat_range range;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nNF_CT_ASSERT(ct != NULL &&\r\n(ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED ||\r\nctinfo == IP_CT_RELATED_REPLY));\r\nxt_nat_convert_range(&range, &mr->range[0]);\r\nreturn nf_nat_setup_info(ct, &range, NF_NAT_MANIP_SRC);\r\n}\r\nstatic unsigned int\r\nxt_dnat_target_v0(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct nf_nat_ipv4_multi_range_compat *mr = par->targinfo;\r\nstruct nf_nat_range range;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nNF_CT_ASSERT(ct != NULL &&\r\n(ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED));\r\nxt_nat_convert_range(&range, &mr->range[0]);\r\nreturn nf_nat_setup_info(ct, &range, NF_NAT_MANIP_DST);\r\n}\r\nstatic unsigned int\r\nxt_snat_target_v1(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct nf_nat_range *range = par->targinfo;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nNF_CT_ASSERT(ct != NULL &&\r\n(ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED ||\r\nctinfo == IP_CT_RELATED_REPLY));\r\nreturn nf_nat_setup_info(ct, range, NF_NAT_MANIP_SRC);\r\n}\r\nstatic unsigned int\r\nxt_dnat_target_v1(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct nf_nat_range *range = par->targinfo;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nNF_CT_ASSERT(ct != NULL &&\r\n(ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED));\r\nreturn nf_nat_setup_info(ct, range, NF_NAT_MANIP_DST);\r\n}\r\nstatic int __init xt_nat_init(void)\r\n{\r\nreturn xt_register_targets(xt_nat_target_reg,\r\nARRAY_SIZE(xt_nat_target_reg));\r\n}\r\nstatic void __exit xt_nat_exit(void)\r\n{\r\nxt_unregister_targets(xt_nat_target_reg, ARRAY_SIZE(xt_nat_target_reg));\r\n}

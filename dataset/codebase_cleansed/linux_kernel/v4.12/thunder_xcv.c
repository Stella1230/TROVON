void xcv_init_hw(void)\r\n{\r\nu64 cfg;\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg &= ~DLL_RESET;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg &= ~CLK_RESET;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\nmsleep(1);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_DLL_CTL);\r\ncfg &= ~0xFF03;\r\ncfg |= CLKRX_BYP;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_DLL_CTL);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg |= COMP_EN;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\nreadq_relaxed(xcv->reg_base + XCV_RESET);\r\nmsleep(10);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg |= PORT_EN;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg |= CLK_RESET;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\n}\r\nvoid xcv_setup_link(bool link_up, int link_speed)\r\n{\r\nu64 cfg;\r\nint speed = 2;\r\nif (!xcv) {\r\npr_err("XCV init not done, probe may have failed\n");\r\nreturn;\r\n}\r\nif (link_speed == 100)\r\nspeed = 1;\r\nelse if (link_speed == 10)\r\nspeed = 0;\r\nif (link_up) {\r\ncfg = readq_relaxed(xcv->reg_base + XCV_CTL);\r\ncfg &= ~0x03;\r\ncfg |= speed;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_CTL);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg |= TX_DATA_RESET | RX_DATA_RESET;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg |= TX_PKT_RESET | RX_PKT_RESET;\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\nwriteq_relaxed(0x01, xcv->reg_base + XCV_BATCH_CRD_RET);\r\n} else {\r\ncfg = readq_relaxed(xcv->reg_base + XCV_RESET);\r\ncfg &= ~(TX_PKT_RESET | RX_PKT_RESET);\r\nwriteq_relaxed(cfg, xcv->reg_base + XCV_RESET);\r\nreadq_relaxed(xcv->reg_base + XCV_RESET);\r\n}\r\n}\r\nstatic int xcv_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nint err;\r\nstruct device *dev = &pdev->dev;\r\nxcv = devm_kzalloc(dev, sizeof(struct xcv), GFP_KERNEL);\r\nif (!xcv)\r\nreturn -ENOMEM;\r\nxcv->pdev = pdev;\r\npci_set_drvdata(pdev, xcv);\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\ndev_err(dev, "Failed to enable PCI device\n");\r\ngoto err_kfree;\r\n}\r\nerr = pci_request_regions(pdev, DRV_NAME);\r\nif (err) {\r\ndev_err(dev, "PCI request regions failed 0x%x\n", err);\r\ngoto err_disable_device;\r\n}\r\nxcv->reg_base = pcim_iomap(pdev, PCI_CFG_REG_BAR_NUM, 0);\r\nif (!xcv->reg_base) {\r\ndev_err(dev, "XCV: Cannot map CSR memory space, aborting\n");\r\nerr = -ENOMEM;\r\ngoto err_release_regions;\r\n}\r\nreturn 0;\r\nerr_release_regions:\r\npci_release_regions(pdev);\r\nerr_disable_device:\r\npci_disable_device(pdev);\r\nerr_kfree:\r\ndevm_kfree(dev, xcv);\r\nxcv = NULL;\r\nreturn err;\r\n}\r\nstatic void xcv_remove(struct pci_dev *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nif (xcv) {\r\ndevm_kfree(dev, xcv);\r\nxcv = NULL;\r\n}\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init xcv_init_module(void)\r\n{\r\npr_info("%s, ver %s\n", DRV_NAME, DRV_VERSION);\r\nreturn pci_register_driver(&xcv_driver);\r\n}\r\nstatic void __exit xcv_cleanup_module(void)\r\n{\r\npci_unregister_driver(&xcv_driver);\r\n}

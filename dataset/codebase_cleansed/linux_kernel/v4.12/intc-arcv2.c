void arc_init_IRQ(void)\r\n{\r\nunsigned int tmp, irq_prio, i;\r\nstruct bcr_irq_arcv2 irq_bcr;\r\nstruct aux_irq_ctrl {\r\n#ifdef CONFIG_CPU_BIG_ENDIAN\r\nunsigned int res3:18, save_idx_regs:1, res2:1,\r\nsave_u_to_u:1, save_lp_regs:1, save_blink:1,\r\nres:4, save_nr_gpr_pairs:5;\r\n#else\r\nunsigned int save_nr_gpr_pairs:5, res:4,\r\nsave_blink:1, save_lp_regs:1, save_u_to_u:1,\r\nres2:1, save_idx_regs:1, res3:18;\r\n#endif\r\n} ictrl;\r\n*(unsigned int *)&ictrl = 0;\r\nictrl.save_nr_gpr_pairs = 6;\r\nictrl.save_blink = 1;\r\nictrl.save_lp_regs = 1;\r\nictrl.save_u_to_u = 0;\r\nictrl.save_idx_regs = 1;\r\nWRITE_AUX(AUX_IRQ_CTRL, ictrl);\r\nREAD_BCR(ARC_REG_IRQ_BCR, irq_bcr);\r\nirq_prio = irq_bcr.prio;\r\npr_info("archs-intc\t: %d priority levels (default %d)%s\n",\r\nirq_prio + 1, ARCV2_IRQ_DEF_PRIO,\r\nirq_bcr.firq ? " FIRQ (not used)":"");\r\nfor (i = NR_EXCEPTIONS; i < irq_bcr.irqs + NR_EXCEPTIONS; i++) {\r\nwrite_aux_reg(AUX_IRQ_SELECT, i);\r\nwrite_aux_reg(AUX_IRQ_PRIORITY, ARCV2_IRQ_DEF_PRIO);\r\n}\r\ntmp = read_aux_reg(ARC_REG_STATUS32);\r\ntmp |= STATUS_AD_MASK | (ARCV2_IRQ_DEF_PRIO << 1);\r\ntmp &= ~STATUS_IE_MASK;\r\nasm volatile("kflag %0 \n"::"r"(tmp));\r\n}\r\nstatic void arcv2_irq_mask(struct irq_data *data)\r\n{\r\nwrite_aux_reg(AUX_IRQ_SELECT, data->hwirq);\r\nwrite_aux_reg(AUX_IRQ_ENABLE, 0);\r\n}\r\nstatic void arcv2_irq_unmask(struct irq_data *data)\r\n{\r\nwrite_aux_reg(AUX_IRQ_SELECT, data->hwirq);\r\nwrite_aux_reg(AUX_IRQ_ENABLE, 1);\r\n}\r\nvoid arcv2_irq_enable(struct irq_data *data)\r\n{\r\nwrite_aux_reg(AUX_IRQ_SELECT, data->hwirq);\r\nwrite_aux_reg(AUX_IRQ_PRIORITY, ARCV2_IRQ_DEF_PRIO);\r\nwrite_aux_reg(AUX_IRQ_ENABLE, 1);\r\n}\r\nstatic int arcv2_irq_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hw)\r\n{\r\nif (hw < FIRST_EXT_IRQ) {\r\nirq_set_percpu_devid(irq);\r\nirq_set_chip_and_handler(irq, &arcv2_irq_chip, handle_percpu_irq);\r\n} else {\r\nirq_set_chip_and_handler(irq, &arcv2_irq_chip, handle_level_irq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init\r\ninit_onchip_IRQ(struct device_node *intc, struct device_node *parent)\r\n{\r\nstruct irq_domain *root_domain;\r\nstruct bcr_irq_arcv2 irq_bcr;\r\nunsigned int nr_cpu_irqs;\r\nREAD_BCR(ARC_REG_IRQ_BCR, irq_bcr);\r\nnr_cpu_irqs = irq_bcr.irqs + NR_EXCEPTIONS;\r\nif (parent)\r\npanic("DeviceTree incore intc not a root irq controller\n");\r\nroot_domain = irq_domain_add_linear(intc, nr_cpu_irqs, &arcv2_irq_ops, NULL);\r\nif (!root_domain)\r\npanic("root irq domain not avail\n");\r\nirq_set_default_host(root_domain);\r\n#ifdef CONFIG_SMP\r\nirq_create_mapping(root_domain, IPI_IRQ);\r\n#endif\r\nirq_create_mapping(root_domain, SOFTIRQ_IRQ);\r\nreturn 0;\r\n}

static inline void loadSingle(const unsigned int Fn, const unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nfpa11->fType[Fn] = typeSingle;\r\nget_user(fpa11->fpreg[Fn].fSingle, pMem);\r\n}\r\nstatic inline void loadDouble(const unsigned int Fn, const unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nunsigned int *p;\r\np = (unsigned int *) &fpa11->fpreg[Fn].fDouble;\r\nfpa11->fType[Fn] = typeDouble;\r\n#ifdef __ARMEB__\r\nget_user(p[0], &pMem[0]);\r\nget_user(p[1], &pMem[1]);\r\n#else\r\nget_user(p[0], &pMem[1]);\r\nget_user(p[1], &pMem[0]);\r\n#endif\r\n}\r\nstatic inline void loadExtended(const unsigned int Fn, const unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nunsigned int *p;\r\np = (unsigned int *) &fpa11->fpreg[Fn].fExtended;\r\nfpa11->fType[Fn] = typeExtended;\r\nget_user(p[0], &pMem[0]);\r\n#ifdef __ARMEB__\r\nget_user(p[1], &pMem[1]);\r\nget_user(p[2], &pMem[2]);\r\n#else\r\nget_user(p[1], &pMem[2]);\r\nget_user(p[2], &pMem[1]);\r\n#endif\r\n}\r\nstatic inline void loadMultiple(const unsigned int Fn, const unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nregister unsigned int *p;\r\nunsigned long x;\r\np = (unsigned int *) &(fpa11->fpreg[Fn]);\r\nget_user(x, &pMem[0]);\r\nfpa11->fType[Fn] = (x >> 14) & 0x00000003;\r\nswitch (fpa11->fType[Fn]) {\r\ncase typeSingle:\r\ncase typeDouble:\r\n{\r\nget_user(p[0], &pMem[2]);\r\nget_user(p[1], &pMem[1]);\r\np[2] = 0;\r\n}\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase typeExtended:\r\n{\r\nget_user(p[1], &pMem[2]);\r\nget_user(p[2], &pMem[1]);\r\np[0] = (x & 0x80003fff);\r\n}\r\nbreak;\r\n#endif\r\n}\r\n}\r\nstatic inline void storeSingle(struct roundingData *roundData, const unsigned int Fn, unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nunion {\r\nfloat32 f;\r\nunsigned int i[1];\r\n} val;\r\nswitch (fpa11->fType[Fn]) {\r\ncase typeDouble:\r\nval.f = float64_to_float32(roundData, fpa11->fpreg[Fn].fDouble);\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase typeExtended:\r\nval.f = floatx80_to_float32(roundData, fpa11->fpreg[Fn].fExtended);\r\nbreak;\r\n#endif\r\ndefault:\r\nval.f = fpa11->fpreg[Fn].fSingle;\r\n}\r\nput_user(val.i[0], pMem);\r\n}\r\nstatic inline void storeDouble(struct roundingData *roundData, const unsigned int Fn, unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nunion {\r\nfloat64 f;\r\nunsigned int i[2];\r\n} val;\r\nswitch (fpa11->fType[Fn]) {\r\ncase typeSingle:\r\nval.f = float32_to_float64(fpa11->fpreg[Fn].fSingle);\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase typeExtended:\r\nval.f = floatx80_to_float64(roundData, fpa11->fpreg[Fn].fExtended);\r\nbreak;\r\n#endif\r\ndefault:\r\nval.f = fpa11->fpreg[Fn].fDouble;\r\n}\r\n#ifdef __ARMEB__\r\nput_user(val.i[0], &pMem[0]);\r\nput_user(val.i[1], &pMem[1]);\r\n#else\r\nput_user(val.i[1], &pMem[0]);\r\nput_user(val.i[0], &pMem[1]);\r\n#endif\r\n}\r\nstatic inline void storeExtended(const unsigned int Fn, unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nunion {\r\nfloatx80 f;\r\nunsigned int i[3];\r\n} val;\r\nswitch (fpa11->fType[Fn]) {\r\ncase typeSingle:\r\nval.f = float32_to_floatx80(fpa11->fpreg[Fn].fSingle);\r\nbreak;\r\ncase typeDouble:\r\nval.f = float64_to_floatx80(fpa11->fpreg[Fn].fDouble);\r\nbreak;\r\ndefault:\r\nval.f = fpa11->fpreg[Fn].fExtended;\r\n}\r\nput_user(val.i[0], &pMem[0]);\r\n#ifdef __ARMEB__\r\nput_user(val.i[1], &pMem[1]);\r\nput_user(val.i[2], &pMem[2]);\r\n#else\r\nput_user(val.i[1], &pMem[2]);\r\nput_user(val.i[2], &pMem[1]);\r\n#endif\r\n}\r\nstatic inline void storeMultiple(const unsigned int Fn, unsigned int __user *pMem)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nregister unsigned int nType, *p;\r\np = (unsigned int *) &(fpa11->fpreg[Fn]);\r\nnType = fpa11->fType[Fn];\r\nswitch (nType) {\r\ncase typeSingle:\r\ncase typeDouble:\r\n{\r\nput_user(p[0], &pMem[2]);\r\nput_user(p[1], &pMem[1]);\r\nput_user(nType << 14, &pMem[0]);\r\n}\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase typeExtended:\r\n{\r\nput_user(p[2], &pMem[1]);\r\nput_user(p[1], &pMem[2]);\r\nput_user((p[0] & 0x80003fff) | (nType << 14), &pMem[0]);\r\n}\r\nbreak;\r\n#endif\r\n}\r\n}\r\nunsigned int PerformLDF(const unsigned int opcode)\r\n{\r\nunsigned int __user *pBase, *pAddress, *pFinal;\r\nunsigned int nRc = 1, write_back = WRITE_BACK(opcode);\r\npBase = (unsigned int __user *) readRegister(getRn(opcode));\r\nif (REG_PC == getRn(opcode)) {\r\npBase += 2;\r\nwrite_back = 0;\r\n}\r\npFinal = pBase;\r\nif (BIT_UP_SET(opcode))\r\npFinal += getOffset(opcode);\r\nelse\r\npFinal -= getOffset(opcode);\r\nif (PREINDEXED(opcode))\r\npAddress = pFinal;\r\nelse\r\npAddress = pBase;\r\nswitch (opcode & MASK_TRANSFER_LENGTH) {\r\ncase TRANSFER_SINGLE:\r\nloadSingle(getFd(opcode), pAddress);\r\nbreak;\r\ncase TRANSFER_DOUBLE:\r\nloadDouble(getFd(opcode), pAddress);\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase TRANSFER_EXTENDED:\r\nloadExtended(getFd(opcode), pAddress);\r\nbreak;\r\n#endif\r\ndefault:\r\nnRc = 0;\r\n}\r\nif (write_back)\r\nwriteRegister(getRn(opcode), (unsigned long) pFinal);\r\nreturn nRc;\r\n}\r\nunsigned int PerformSTF(const unsigned int opcode)\r\n{\r\nunsigned int __user *pBase, *pAddress, *pFinal;\r\nunsigned int nRc = 1, write_back = WRITE_BACK(opcode);\r\nstruct roundingData roundData;\r\nroundData.mode = SetRoundingMode(opcode);\r\nroundData.precision = SetRoundingPrecision(opcode);\r\nroundData.exception = 0;\r\npBase = (unsigned int __user *) readRegister(getRn(opcode));\r\nif (REG_PC == getRn(opcode)) {\r\npBase += 2;\r\nwrite_back = 0;\r\n}\r\npFinal = pBase;\r\nif (BIT_UP_SET(opcode))\r\npFinal += getOffset(opcode);\r\nelse\r\npFinal -= getOffset(opcode);\r\nif (PREINDEXED(opcode))\r\npAddress = pFinal;\r\nelse\r\npAddress = pBase;\r\nswitch (opcode & MASK_TRANSFER_LENGTH) {\r\ncase TRANSFER_SINGLE:\r\nstoreSingle(&roundData, getFd(opcode), pAddress);\r\nbreak;\r\ncase TRANSFER_DOUBLE:\r\nstoreDouble(&roundData, getFd(opcode), pAddress);\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase TRANSFER_EXTENDED:\r\nstoreExtended(getFd(opcode), pAddress);\r\nbreak;\r\n#endif\r\ndefault:\r\nnRc = 0;\r\n}\r\nif (roundData.exception)\r\nfloat_raise(roundData.exception);\r\nif (write_back)\r\nwriteRegister(getRn(opcode), (unsigned long) pFinal);\r\nreturn nRc;\r\n}\r\nunsigned int PerformLFM(const unsigned int opcode)\r\n{\r\nunsigned int __user *pBase, *pAddress, *pFinal;\r\nunsigned int i, Fd, write_back = WRITE_BACK(opcode);\r\npBase = (unsigned int __user *) readRegister(getRn(opcode));\r\nif (REG_PC == getRn(opcode)) {\r\npBase += 2;\r\nwrite_back = 0;\r\n}\r\npFinal = pBase;\r\nif (BIT_UP_SET(opcode))\r\npFinal += getOffset(opcode);\r\nelse\r\npFinal -= getOffset(opcode);\r\nif (PREINDEXED(opcode))\r\npAddress = pFinal;\r\nelse\r\npAddress = pBase;\r\nFd = getFd(opcode);\r\nfor (i = getRegisterCount(opcode); i > 0; i--) {\r\nloadMultiple(Fd, pAddress);\r\npAddress += 3;\r\nFd++;\r\nif (Fd == 8)\r\nFd = 0;\r\n}\r\nif (write_back)\r\nwriteRegister(getRn(opcode), (unsigned long) pFinal);\r\nreturn 1;\r\n}\r\nunsigned int PerformSFM(const unsigned int opcode)\r\n{\r\nunsigned int __user *pBase, *pAddress, *pFinal;\r\nunsigned int i, Fd, write_back = WRITE_BACK(opcode);\r\npBase = (unsigned int __user *) readRegister(getRn(opcode));\r\nif (REG_PC == getRn(opcode)) {\r\npBase += 2;\r\nwrite_back = 0;\r\n}\r\npFinal = pBase;\r\nif (BIT_UP_SET(opcode))\r\npFinal += getOffset(opcode);\r\nelse\r\npFinal -= getOffset(opcode);\r\nif (PREINDEXED(opcode))\r\npAddress = pFinal;\r\nelse\r\npAddress = pBase;\r\nFd = getFd(opcode);\r\nfor (i = getRegisterCount(opcode); i > 0; i--) {\r\nstoreMultiple(Fd, pAddress);\r\npAddress += 3;\r\nFd++;\r\nif (Fd == 8)\r\nFd = 0;\r\n}\r\nif (write_back)\r\nwriteRegister(getRn(opcode), (unsigned long) pFinal);\r\nreturn 1;\r\n}\r\nunsigned int EmulateCPDT(const unsigned int opcode)\r\n{\r\nunsigned int nRc = 0;\r\nif (LDF_OP(opcode)) {\r\nnRc = PerformLDF(opcode);\r\n} else if (LFM_OP(opcode)) {\r\nnRc = PerformLFM(opcode);\r\n} else if (STF_OP(opcode)) {\r\nnRc = PerformSTF(opcode);\r\n} else if (SFM_OP(opcode)) {\r\nnRc = PerformSFM(opcode);\r\n} else {\r\nnRc = 0;\r\n}\r\nreturn nRc;\r\n}

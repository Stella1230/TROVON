static void gpio_halt_wfn(struct work_struct *work)\r\n{\r\norderly_poweroff(true);\r\n}\r\nstatic void __noreturn gpio_halt_cb(void)\r\n{\r\nenum of_gpio_flags flags;\r\nint trigger, gpio;\r\nif (!halt_node)\r\npanic("No reset GPIO information was provided in DT\n");\r\ngpio = of_get_gpio_flags(halt_node, 0, &flags);\r\nif (!gpio_is_valid(gpio))\r\npanic("Provided GPIO is invalid\n");\r\ntrigger = (flags == OF_GPIO_ACTIVE_LOW);\r\nprintk(KERN_INFO "gpio-halt: triggering GPIO.\n");\r\ngpio_set_value(gpio, trigger);\r\npanic("Halt failed\n");\r\n}\r\nstatic irqreturn_t gpio_halt_irq(int irq, void *__data)\r\n{\r\nprintk(KERN_INFO "gpio-halt: shutdown due to power button IRQ.\n");\r\nschedule_work(&gpio_halt_wq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int gpio_halt_probe(struct platform_device *pdev)\r\n{\r\nenum of_gpio_flags flags;\r\nstruct device_node *node = pdev->dev.of_node;\r\nint gpio, err, irq;\r\nint trigger;\r\nif (!node)\r\nreturn -ENODEV;\r\nhalt_node = of_find_matching_node(node, child_match);\r\nif (!halt_node)\r\nreturn 0;\r\nif (of_gpio_count(halt_node) != 1)\r\nreturn -EINVAL;\r\ngpio = of_get_gpio_flags(halt_node, 0, &flags);\r\nif (!gpio_is_valid(gpio))\r\nreturn -EINVAL;\r\nerr = gpio_request(gpio, "gpio-halt");\r\nif (err) {\r\nprintk(KERN_ERR "gpio-halt: error requesting GPIO %d.\n",\r\ngpio);\r\nhalt_node = NULL;\r\nreturn err;\r\n}\r\ntrigger = (flags == OF_GPIO_ACTIVE_LOW);\r\ngpio_direction_output(gpio, !trigger);\r\nirq = irq_of_parse_and_map(halt_node, 0);\r\nerr = request_irq(irq, gpio_halt_irq, IRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING, "gpio-halt", halt_node);\r\nif (err) {\r\nprintk(KERN_ERR "gpio-halt: error requesting IRQ %d for "\r\n"GPIO %d.\n", irq, gpio);\r\ngpio_free(gpio);\r\nhalt_node = NULL;\r\nreturn err;\r\n}\r\nppc_md.halt = gpio_halt_cb;\r\npm_power_off = gpio_halt_cb;\r\nprintk(KERN_INFO "gpio-halt: registered GPIO %d (%d trigger, %d"\r\n" irq).\n", gpio, trigger, irq);\r\nreturn 0;\r\n}\r\nstatic int gpio_halt_remove(struct platform_device *pdev)\r\n{\r\nif (halt_node) {\r\nint gpio = of_get_gpio(halt_node, 0);\r\nint irq = irq_of_parse_and_map(halt_node, 0);\r\nfree_irq(irq, halt_node);\r\nppc_md.halt = NULL;\r\npm_power_off = NULL;\r\ngpio_free(gpio);\r\nhalt_node = NULL;\r\n}\r\nreturn 0;\r\n}

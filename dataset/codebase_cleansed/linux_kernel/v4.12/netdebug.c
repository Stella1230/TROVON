void o2net_debug_add_nst(struct o2net_send_tracking *nst)\r\n{\r\nspin_lock(&o2net_debug_lock);\r\nlist_add(&nst->st_net_debug_item, &send_tracking);\r\nspin_unlock(&o2net_debug_lock);\r\n}\r\nvoid o2net_debug_del_nst(struct o2net_send_tracking *nst)\r\n{\r\nspin_lock(&o2net_debug_lock);\r\nif (!list_empty(&nst->st_net_debug_item))\r\nlist_del_init(&nst->st_net_debug_item);\r\nspin_unlock(&o2net_debug_lock);\r\n}\r\nstatic struct o2net_send_tracking\r\n*next_nst(struct o2net_send_tracking *nst_start)\r\n{\r\nstruct o2net_send_tracking *nst, *ret = NULL;\r\nassert_spin_locked(&o2net_debug_lock);\r\nlist_for_each_entry(nst, &nst_start->st_net_debug_item,\r\nst_net_debug_item) {\r\nif (&nst->st_net_debug_item == &send_tracking)\r\nbreak;\r\nif (nst->st_task != NULL) {\r\nret = nst;\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void *nst_seq_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nstruct o2net_send_tracking *nst, *dummy_nst = seq->private;\r\nspin_lock(&o2net_debug_lock);\r\nnst = next_nst(dummy_nst);\r\nspin_unlock(&o2net_debug_lock);\r\nreturn nst;\r\n}\r\nstatic void *nst_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct o2net_send_tracking *nst, *dummy_nst = seq->private;\r\nspin_lock(&o2net_debug_lock);\r\nnst = next_nst(dummy_nst);\r\nlist_del_init(&dummy_nst->st_net_debug_item);\r\nif (nst)\r\nlist_add(&dummy_nst->st_net_debug_item,\r\n&nst->st_net_debug_item);\r\nspin_unlock(&o2net_debug_lock);\r\nreturn nst;\r\n}\r\nstatic int nst_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct o2net_send_tracking *nst, *dummy_nst = seq->private;\r\nktime_t now;\r\ns64 sock, send, status;\r\nspin_lock(&o2net_debug_lock);\r\nnst = next_nst(dummy_nst);\r\nif (!nst)\r\ngoto out;\r\nnow = ktime_get();\r\nsock = ktime_to_us(ktime_sub(now, nst->st_sock_time));\r\nsend = ktime_to_us(ktime_sub(now, nst->st_send_time));\r\nstatus = ktime_to_us(ktime_sub(now, nst->st_status_time));\r\nseq_printf(seq, "%p:\n"\r\n" pid: %lu\n"\r\n" tgid: %lu\n"\r\n" process name: %s\n"\r\n" node: %u\n"\r\n" sc: %p\n"\r\n" message id: %d\n"\r\n" message type: %u\n"\r\n" message key: 0x%08x\n"\r\n" sock acquiry: %lld usecs ago\n"\r\n" send start: %lld usecs ago\n"\r\n" wait start: %lld usecs ago\n",\r\nnst, (unsigned long)task_pid_nr(nst->st_task),\r\n(unsigned long)nst->st_task->tgid,\r\nnst->st_task->comm, nst->st_node,\r\nnst->st_sc, nst->st_id, nst->st_msg_type,\r\nnst->st_msg_key,\r\n(long long)sock,\r\n(long long)send,\r\n(long long)status);\r\nout:\r\nspin_unlock(&o2net_debug_lock);\r\nreturn 0;\r\n}\r\nstatic void nst_seq_stop(struct seq_file *seq, void *v)\r\n{\r\n}\r\nstatic int nst_fop_open(struct inode *inode, struct file *file)\r\n{\r\nstruct o2net_send_tracking *dummy_nst;\r\ndummy_nst = __seq_open_private(file, &nst_seq_ops, sizeof(*dummy_nst));\r\nif (!dummy_nst)\r\nreturn -ENOMEM;\r\no2net_debug_add_nst(dummy_nst);\r\nreturn 0;\r\n}\r\nstatic int nst_fop_release(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *seq = file->private_data;\r\nstruct o2net_send_tracking *dummy_nst = seq->private;\r\no2net_debug_del_nst(dummy_nst);\r\nreturn seq_release_private(inode, file);\r\n}\r\nvoid o2net_debug_add_sc(struct o2net_sock_container *sc)\r\n{\r\nspin_lock(&o2net_debug_lock);\r\nlist_add(&sc->sc_net_debug_item, &sock_containers);\r\nspin_unlock(&o2net_debug_lock);\r\n}\r\nvoid o2net_debug_del_sc(struct o2net_sock_container *sc)\r\n{\r\nspin_lock(&o2net_debug_lock);\r\nlist_del_init(&sc->sc_net_debug_item);\r\nspin_unlock(&o2net_debug_lock);\r\n}\r\nstatic struct o2net_sock_container\r\n*next_sc(struct o2net_sock_container *sc_start)\r\n{\r\nstruct o2net_sock_container *sc, *ret = NULL;\r\nassert_spin_locked(&o2net_debug_lock);\r\nlist_for_each_entry(sc, &sc_start->sc_net_debug_item,\r\nsc_net_debug_item) {\r\nif (&sc->sc_net_debug_item == &sock_containers)\r\nbreak;\r\nif (sc->sc_page != NULL) {\r\nret = sc;\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void *sc_seq_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nstruct o2net_sock_debug *sd = seq->private;\r\nstruct o2net_sock_container *sc, *dummy_sc = sd->dbg_sock;\r\nspin_lock(&o2net_debug_lock);\r\nsc = next_sc(dummy_sc);\r\nspin_unlock(&o2net_debug_lock);\r\nreturn sc;\r\n}\r\nstatic void *sc_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct o2net_sock_debug *sd = seq->private;\r\nstruct o2net_sock_container *sc, *dummy_sc = sd->dbg_sock;\r\nspin_lock(&o2net_debug_lock);\r\nsc = next_sc(dummy_sc);\r\nlist_del_init(&dummy_sc->sc_net_debug_item);\r\nif (sc)\r\nlist_add(&dummy_sc->sc_net_debug_item, &sc->sc_net_debug_item);\r\nspin_unlock(&o2net_debug_lock);\r\nreturn sc;\r\n}\r\nstatic void sc_show_sock_stats(struct seq_file *seq,\r\nstruct o2net_sock_container *sc)\r\n{\r\nif (!sc)\r\nreturn;\r\nseq_printf(seq, "%d,%u,%lu,%lld,%lld,%lld,%lu,%lld\n", O2NET_STATS_STR_VERSION,\r\nsc->sc_node->nd_num, (unsigned long)sc_send_count(sc),\r\n(long long)sc_tv_acquiry_total_ns(sc),\r\n(long long)sc_tv_send_total_ns(sc),\r\n(long long)sc_tv_status_total_ns(sc),\r\n(unsigned long)sc_recv_count(sc),\r\n(long long)sc_tv_process_total_ns(sc));\r\n}\r\nstatic void sc_show_sock_container(struct seq_file *seq,\r\nstruct o2net_sock_container *sc)\r\n{\r\nstruct inet_sock *inet = NULL;\r\n__be32 saddr = 0, daddr = 0;\r\n__be16 sport = 0, dport = 0;\r\nif (!sc)\r\nreturn;\r\nif (sc->sc_sock) {\r\ninet = inet_sk(sc->sc_sock->sk);\r\nsaddr = (__force __be32)inet->inet_saddr;\r\ndaddr = (__force __be32)inet->inet_daddr;\r\nsport = (__force __be16)inet->inet_sport;\r\ndport = (__force __be16)inet->inet_dport;\r\n}\r\nseq_printf(seq, "%p:\n"\r\n" krefs: %d\n"\r\n" sock: %pI4:%u -> "\r\n"%pI4:%u\n"\r\n" remote node: %s\n"\r\n" page off: %zu\n"\r\n" handshake ok: %u\n"\r\n" timer: %lld usecs\n"\r\n" data ready: %lld usecs\n"\r\n" advance start: %lld usecs\n"\r\n" advance stop: %lld usecs\n"\r\n" func start: %lld usecs\n"\r\n" func stop: %lld usecs\n"\r\n" func key: 0x%08x\n"\r\n" func type: %u\n",\r\nsc,\r\nkref_read(&sc->sc_kref),\r\n&saddr, inet ? ntohs(sport) : 0,\r\n&daddr, inet ? ntohs(dport) : 0,\r\nsc->sc_node->nd_name,\r\nsc->sc_page_off,\r\nsc->sc_handshake_ok,\r\n(long long)ktime_to_us(sc->sc_tv_timer),\r\n(long long)ktime_to_us(sc->sc_tv_data_ready),\r\n(long long)ktime_to_us(sc->sc_tv_advance_start),\r\n(long long)ktime_to_us(sc->sc_tv_advance_stop),\r\n(long long)ktime_to_us(sc->sc_tv_func_start),\r\n(long long)ktime_to_us(sc->sc_tv_func_stop),\r\nsc->sc_msg_key,\r\nsc->sc_msg_type);\r\n}\r\nstatic int sc_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct o2net_sock_debug *sd = seq->private;\r\nstruct o2net_sock_container *sc, *dummy_sc = sd->dbg_sock;\r\nspin_lock(&o2net_debug_lock);\r\nsc = next_sc(dummy_sc);\r\nif (sc) {\r\nif (sd->dbg_ctxt == SHOW_SOCK_CONTAINERS)\r\nsc_show_sock_container(seq, sc);\r\nelse\r\nsc_show_sock_stats(seq, sc);\r\n}\r\nspin_unlock(&o2net_debug_lock);\r\nreturn 0;\r\n}\r\nstatic void sc_seq_stop(struct seq_file *seq, void *v)\r\n{\r\n}\r\nstatic int sc_common_open(struct file *file, int ctxt)\r\n{\r\nstruct o2net_sock_debug *sd;\r\nstruct o2net_sock_container *dummy_sc;\r\ndummy_sc = kzalloc(sizeof(*dummy_sc), GFP_KERNEL);\r\nif (!dummy_sc)\r\nreturn -ENOMEM;\r\nsd = __seq_open_private(file, &sc_seq_ops, sizeof(*sd));\r\nif (!sd) {\r\nkfree(dummy_sc);\r\nreturn -ENOMEM;\r\n}\r\nsd->dbg_ctxt = ctxt;\r\nsd->dbg_sock = dummy_sc;\r\no2net_debug_add_sc(dummy_sc);\r\nreturn 0;\r\n}\r\nstatic int sc_fop_release(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *seq = file->private_data;\r\nstruct o2net_sock_debug *sd = seq->private;\r\nstruct o2net_sock_container *dummy_sc = sd->dbg_sock;\r\no2net_debug_del_sc(dummy_sc);\r\nreturn seq_release_private(inode, file);\r\n}\r\nstatic int stats_fop_open(struct inode *inode, struct file *file)\r\n{\r\nreturn sc_common_open(file, SHOW_SOCK_STATS);\r\n}\r\nstatic int sc_fop_open(struct inode *inode, struct file *file)\r\n{\r\nreturn sc_common_open(file, SHOW_SOCK_CONTAINERS);\r\n}\r\nstatic int o2net_fill_bitmap(char *buf, int len)\r\n{\r\nunsigned long map[BITS_TO_LONGS(O2NM_MAX_NODES)];\r\nint i = -1, out = 0;\r\no2net_fill_node_map(map, sizeof(map));\r\nwhile ((i = find_next_bit(map, O2NM_MAX_NODES, i + 1)) < O2NM_MAX_NODES)\r\nout += snprintf(buf + out, PAGE_SIZE - out, "%d ", i);\r\nout += snprintf(buf + out, PAGE_SIZE - out, "\n");\r\nreturn out;\r\n}\r\nstatic int nodes_fop_open(struct inode *inode, struct file *file)\r\n{\r\nchar *buf;\r\nbuf = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\ni_size_write(inode, o2net_fill_bitmap(buf, PAGE_SIZE));\r\nfile->private_data = buf;\r\nreturn 0;\r\n}\r\nstatic int o2net_debug_release(struct inode *inode, struct file *file)\r\n{\r\nkfree(file->private_data);\r\nreturn 0;\r\n}\r\nstatic ssize_t o2net_debug_read(struct file *file, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, file->private_data,\r\ni_size_read(file->f_mapping->host));\r\n}\r\nvoid o2net_debugfs_exit(void)\r\n{\r\ndebugfs_remove(nodes_dentry);\r\ndebugfs_remove(stats_dentry);\r\ndebugfs_remove(sc_dentry);\r\ndebugfs_remove(nst_dentry);\r\ndebugfs_remove(o2net_dentry);\r\n}\r\nint o2net_debugfs_init(void)\r\n{\r\numode_t mode = S_IFREG|S_IRUSR;\r\no2net_dentry = debugfs_create_dir(O2NET_DEBUG_DIR, NULL);\r\nif (o2net_dentry)\r\nnst_dentry = debugfs_create_file(NST_DEBUG_NAME, mode,\r\no2net_dentry, NULL, &nst_seq_fops);\r\nif (nst_dentry)\r\nsc_dentry = debugfs_create_file(SC_DEBUG_NAME, mode,\r\no2net_dentry, NULL, &sc_seq_fops);\r\nif (sc_dentry)\r\nstats_dentry = debugfs_create_file(STATS_DEBUG_NAME, mode,\r\no2net_dentry, NULL, &stats_seq_fops);\r\nif (stats_dentry)\r\nnodes_dentry = debugfs_create_file(NODES_DEBUG_NAME, mode,\r\no2net_dentry, NULL, &nodes_fops);\r\nif (nodes_dentry)\r\nreturn 0;\r\no2net_debugfs_exit();\r\nmlog_errno(-ENOMEM);\r\nreturn -ENOMEM;\r\n}

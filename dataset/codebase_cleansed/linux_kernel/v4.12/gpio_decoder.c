static int gpio_decoder_get_gpios_state(struct gpio_decoder *decoder)\r\n{\r\nstruct gpio_descs *gpios = decoder->input_gpios;\r\nunsigned int ret = 0;\r\nint i, val;\r\nfor (i = 0; i < gpios->ndescs; i++) {\r\nval = gpiod_get_value_cansleep(gpios->desc[i]);\r\nif (val < 0) {\r\ndev_err(decoder->dev,\r\n"Error reading gpio %d: %d\n",\r\ndesc_to_gpio(gpios->desc[i]), val);\r\nreturn val;\r\n}\r\nval = !!val;\r\nret = (ret << 1) | val;\r\n}\r\nreturn ret;\r\n}\r\nstatic void gpio_decoder_poll_gpios(struct input_polled_dev *poll_dev)\r\n{\r\nstruct gpio_decoder *decoder = poll_dev->private;\r\nint state;\r\nstate = gpio_decoder_get_gpios_state(decoder);\r\nif (state >= 0 && state != decoder->last_stable) {\r\ninput_report_abs(poll_dev->input, decoder->axis, state);\r\ninput_sync(poll_dev->input);\r\ndecoder->last_stable = state;\r\n}\r\n}\r\nstatic int gpio_decoder_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct gpio_decoder *decoder;\r\nstruct input_polled_dev *poll_dev;\r\nu32 max;\r\nint err;\r\ndecoder = devm_kzalloc(dev, sizeof(struct gpio_decoder), GFP_KERNEL);\r\nif (!decoder)\r\nreturn -ENOMEM;\r\ndevice_property_read_u32(dev, "linux,axis", &decoder->axis);\r\ndecoder->input_gpios = devm_gpiod_get_array(dev, NULL, GPIOD_IN);\r\nif (IS_ERR(decoder->input_gpios)) {\r\ndev_err(dev, "unable to acquire input gpios\n");\r\nreturn PTR_ERR(decoder->input_gpios);\r\n}\r\nif (decoder->input_gpios->ndescs < 2) {\r\ndev_err(dev, "not enough gpios found\n");\r\nreturn -EINVAL;\r\n}\r\nif (device_property_read_u32(dev, "decoder-max-value", &max))\r\nmax = (1U << decoder->input_gpios->ndescs) - 1;\r\ndecoder->dev = dev;\r\npoll_dev = devm_input_allocate_polled_device(decoder->dev);\r\nif (!poll_dev)\r\nreturn -ENOMEM;\r\npoll_dev->private = decoder;\r\npoll_dev->poll = gpio_decoder_poll_gpios;\r\ndecoder->poll_dev = poll_dev;\r\npoll_dev->input->name = pdev->name;\r\npoll_dev->input->id.bustype = BUS_HOST;\r\ninput_set_abs_params(poll_dev->input, decoder->axis, 0, max, 0, 0);\r\nerr = input_register_polled_device(poll_dev);\r\nif (err) {\r\ndev_err(dev, "failed to register polled device\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

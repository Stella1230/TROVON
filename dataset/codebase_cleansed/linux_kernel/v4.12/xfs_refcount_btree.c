static struct xfs_btree_cur *\r\nxfs_refcountbt_dup_cursor(\r\nstruct xfs_btree_cur *cur)\r\n{\r\nreturn xfs_refcountbt_init_cursor(cur->bc_mp, cur->bc_tp,\r\ncur->bc_private.a.agbp, cur->bc_private.a.agno,\r\ncur->bc_private.a.dfops);\r\n}\r\nSTATIC void\r\nxfs_refcountbt_set_root(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr,\r\nint inc)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nxfs_agnumber_t seqno = be32_to_cpu(agf->agf_seqno);\r\nstruct xfs_perag *pag = xfs_perag_get(cur->bc_mp, seqno);\r\nASSERT(ptr->s != 0);\r\nagf->agf_refcount_root = ptr->s;\r\nbe32_add_cpu(&agf->agf_refcount_level, inc);\r\npag->pagf_refcount_level += inc;\r\nxfs_perag_put(pag);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp,\r\nXFS_AGF_REFCOUNT_ROOT | XFS_AGF_REFCOUNT_LEVEL);\r\n}\r\nSTATIC int\r\nxfs_refcountbt_alloc_block(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *start,\r\nunion xfs_btree_ptr *new,\r\nint *stat)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nstruct xfs_alloc_arg args;\r\nint error;\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ENTRY);\r\nmemset(&args, 0, sizeof(args));\r\nargs.tp = cur->bc_tp;\r\nargs.mp = cur->bc_mp;\r\nargs.type = XFS_ALLOCTYPE_NEAR_BNO;\r\nargs.fsbno = XFS_AGB_TO_FSB(cur->bc_mp, cur->bc_private.a.agno,\r\nxfs_refc_block(args.mp));\r\nargs.firstblock = args.fsbno;\r\nxfs_rmap_ag_owner(&args.oinfo, XFS_RMAP_OWN_REFC);\r\nargs.minlen = args.maxlen = args.prod = 1;\r\nargs.resv = XFS_AG_RESV_METADATA;\r\nerror = xfs_alloc_vextent(&args);\r\nif (error)\r\ngoto out_error;\r\ntrace_xfs_refcountbt_alloc_block(cur->bc_mp, cur->bc_private.a.agno,\r\nargs.agbno, 1);\r\nif (args.fsbno == NULLFSBLOCK) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 0;\r\nreturn 0;\r\n}\r\nASSERT(args.agno == cur->bc_private.a.agno);\r\nASSERT(args.len == 1);\r\nnew->s = cpu_to_be32(args.agbno);\r\nbe32_add_cpu(&agf->agf_refcount_blocks, 1);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_REFCOUNT_BLOCKS);\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 1;\r\nreturn 0;\r\nout_error:\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ERROR);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_refcountbt_free_block(\r\nstruct xfs_btree_cur *cur,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = cur->bc_mp;\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nxfs_fsblock_t fsbno = XFS_DADDR_TO_FSB(mp, XFS_BUF_ADDR(bp));\r\nstruct xfs_owner_info oinfo;\r\nint error;\r\ntrace_xfs_refcountbt_free_block(cur->bc_mp, cur->bc_private.a.agno,\r\nXFS_FSB_TO_AGBNO(cur->bc_mp, fsbno), 1);\r\nxfs_rmap_ag_owner(&oinfo, XFS_RMAP_OWN_REFC);\r\nbe32_add_cpu(&agf->agf_refcount_blocks, -1);\r\nxfs_alloc_log_agf(cur->bc_tp, agbp, XFS_AGF_REFCOUNT_BLOCKS);\r\nerror = xfs_free_extent(cur->bc_tp, fsbno, 1, &oinfo,\r\nXFS_AG_RESV_METADATA);\r\nif (error)\r\nreturn error;\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_refcountbt_get_minrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_refc_mnr[level != 0];\r\n}\r\nSTATIC int\r\nxfs_refcountbt_get_maxrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_refc_mxr[level != 0];\r\n}\r\nSTATIC void\r\nxfs_refcountbt_init_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nkey->refc.rc_startblock = rec->refc.rc_startblock;\r\n}\r\nSTATIC void\r\nxfs_refcountbt_init_high_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\n__u32 x;\r\nx = be32_to_cpu(rec->refc.rc_startblock);\r\nx += be32_to_cpu(rec->refc.rc_blockcount) - 1;\r\nkey->refc.rc_startblock = cpu_to_be32(x);\r\n}\r\nSTATIC void\r\nxfs_refcountbt_init_rec_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *rec)\r\n{\r\nrec->refc.rc_startblock = cpu_to_be32(cur->bc_rec.rc.rc_startblock);\r\nrec->refc.rc_blockcount = cpu_to_be32(cur->bc_rec.rc.rc_blockcount);\r\nrec->refc.rc_refcount = cpu_to_be32(cur->bc_rec.rc.rc_refcount);\r\n}\r\nSTATIC void\r\nxfs_refcountbt_init_ptr_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr)\r\n{\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(cur->bc_private.a.agbp);\r\nASSERT(cur->bc_private.a.agno == be32_to_cpu(agf->agf_seqno));\r\nASSERT(agf->agf_refcount_root != 0);\r\nptr->s = agf->agf_refcount_root;\r\n}\r\nSTATIC __int64_t\r\nxfs_refcountbt_key_diff(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *key)\r\n{\r\nstruct xfs_refcount_irec *rec = &cur->bc_rec.rc;\r\nstruct xfs_refcount_key *kp = &key->refc;\r\nreturn (__int64_t)be32_to_cpu(kp->rc_startblock) - rec->rc_startblock;\r\n}\r\nSTATIC __int64_t\r\nxfs_refcountbt_diff_two_keys(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\nreturn (__int64_t)be32_to_cpu(k1->refc.rc_startblock) -\r\nbe32_to_cpu(k2->refc.rc_startblock);\r\n}\r\nSTATIC bool\r\nxfs_refcountbt_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_btree_block *block = XFS_BUF_TO_BLOCK(bp);\r\nstruct xfs_perag *pag = bp->b_pag;\r\nunsigned int level;\r\nif (block->bb_magic != cpu_to_be32(XFS_REFC_CRC_MAGIC))\r\nreturn false;\r\nif (!xfs_sb_version_hasreflink(&mp->m_sb))\r\nreturn false;\r\nif (!xfs_btree_sblock_v5hdr_verify(bp))\r\nreturn false;\r\nlevel = be16_to_cpu(block->bb_level);\r\nif (pag && pag->pagf_init) {\r\nif (level >= pag->pagf_refcount_level)\r\nreturn false;\r\n} else if (level >= mp->m_refc_maxlevels)\r\nreturn false;\r\nreturn xfs_btree_sblock_verify(bp, mp->m_refc_mxr[level != 0]);\r\n}\r\nSTATIC void\r\nxfs_refcountbt_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_btree_sblock_verify_crc(bp))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_refcountbt_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_verifier_error(bp);\r\n}\r\n}\r\nSTATIC void\r\nxfs_refcountbt_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_refcountbt_verify(bp)) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nxfs_btree_sblock_calc_crc(bp);\r\n}\r\nSTATIC int\r\nxfs_refcountbt_keys_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\nreturn be32_to_cpu(k1->refc.rc_startblock) <\r\nbe32_to_cpu(k2->refc.rc_startblock);\r\n}\r\nSTATIC int\r\nxfs_refcountbt_recs_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *r1,\r\nunion xfs_btree_rec *r2)\r\n{\r\nreturn be32_to_cpu(r1->refc.rc_startblock) +\r\nbe32_to_cpu(r1->refc.rc_blockcount) <=\r\nbe32_to_cpu(r2->refc.rc_startblock);\r\n}\r\nstruct xfs_btree_cur *\r\nxfs_refcountbt_init_cursor(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *agbp,\r\nxfs_agnumber_t agno,\r\nstruct xfs_defer_ops *dfops)\r\n{\r\nstruct xfs_agf *agf = XFS_BUF_TO_AGF(agbp);\r\nstruct xfs_btree_cur *cur;\r\nASSERT(agno != NULLAGNUMBER);\r\nASSERT(agno < mp->m_sb.sb_agcount);\r\ncur = kmem_zone_zalloc(xfs_btree_cur_zone, KM_NOFS);\r\ncur->bc_tp = tp;\r\ncur->bc_mp = mp;\r\ncur->bc_btnum = XFS_BTNUM_REFC;\r\ncur->bc_blocklog = mp->m_sb.sb_blocklog;\r\ncur->bc_ops = &xfs_refcountbt_ops;\r\ncur->bc_statoff = XFS_STATS_CALC_INDEX(xs_refcbt_2);\r\ncur->bc_nlevels = be32_to_cpu(agf->agf_refcount_level);\r\ncur->bc_private.a.agbp = agbp;\r\ncur->bc_private.a.agno = agno;\r\ncur->bc_private.a.dfops = dfops;\r\ncur->bc_flags |= XFS_BTREE_CRC_BLOCKS;\r\ncur->bc_private.a.priv.refc.nr_ops = 0;\r\ncur->bc_private.a.priv.refc.shape_changes = 0;\r\nreturn cur;\r\n}\r\nint\r\nxfs_refcountbt_maxrecs(\r\nstruct xfs_mount *mp,\r\nint blocklen,\r\nbool leaf)\r\n{\r\nblocklen -= XFS_REFCOUNT_BLOCK_LEN;\r\nif (leaf)\r\nreturn blocklen / sizeof(struct xfs_refcount_rec);\r\nreturn blocklen / (sizeof(struct xfs_refcount_key) +\r\nsizeof(xfs_refcount_ptr_t));\r\n}\r\nvoid\r\nxfs_refcountbt_compute_maxlevels(\r\nstruct xfs_mount *mp)\r\n{\r\nmp->m_refc_maxlevels = xfs_btree_compute_maxlevels(mp,\r\nmp->m_refc_mnr, mp->m_sb.sb_agblocks);\r\n}\r\nxfs_extlen_t\r\nxfs_refcountbt_calc_size(\r\nstruct xfs_mount *mp,\r\nunsigned long long len)\r\n{\r\nreturn xfs_btree_calc_size(mp, mp->m_refc_mnr, len);\r\n}\r\nxfs_extlen_t\r\nxfs_refcountbt_max_size(\r\nstruct xfs_mount *mp,\r\nxfs_agblock_t agblocks)\r\n{\r\nif (mp->m_refc_mxr[0] == 0)\r\nreturn 0;\r\nreturn xfs_refcountbt_calc_size(mp, agblocks);\r\n}\r\nint\r\nxfs_refcountbt_calc_reserves(\r\nstruct xfs_mount *mp,\r\nxfs_agnumber_t agno,\r\nxfs_extlen_t *ask,\r\nxfs_extlen_t *used)\r\n{\r\nstruct xfs_buf *agbp;\r\nstruct xfs_agf *agf;\r\nxfs_agblock_t agblocks;\r\nxfs_extlen_t tree_len;\r\nint error;\r\nif (!xfs_sb_version_hasreflink(&mp->m_sb))\r\nreturn 0;\r\nerror = xfs_alloc_read_agf(mp, NULL, agno, 0, &agbp);\r\nif (error)\r\nreturn error;\r\nagf = XFS_BUF_TO_AGF(agbp);\r\nagblocks = be32_to_cpu(agf->agf_length);\r\ntree_len = be32_to_cpu(agf->agf_refcount_blocks);\r\nxfs_buf_relse(agbp);\r\n*ask += xfs_refcountbt_max_size(mp, agblocks);\r\n*used += tree_len;\r\nreturn error;\r\n}

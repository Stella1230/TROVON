static int mt2131_readreg(struct mt2131_priv *priv, u8 reg, u8 *val)\r\n{\r\nstruct i2c_msg msg[2] = {\r\n{ .addr = priv->cfg->i2c_address, .flags = 0,\r\n.buf = &reg, .len = 1 },\r\n{ .addr = priv->cfg->i2c_address, .flags = I2C_M_RD,\r\n.buf = val, .len = 1 },\r\n};\r\nif (i2c_transfer(priv->i2c, msg, 2) != 2) {\r\nprintk(KERN_WARNING "mt2131 I2C read failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2131_writereg(struct mt2131_priv *priv, u8 reg, u8 val)\r\n{\r\nu8 buf[2] = { reg, val };\r\nstruct i2c_msg msg = { .addr = priv->cfg->i2c_address, .flags = 0,\r\n.buf = buf, .len = 2 };\r\nif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\r\nprintk(KERN_WARNING "mt2131 I2C write failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2131_writeregs(struct mt2131_priv *priv,u8 *buf, u8 len)\r\n{\r\nstruct i2c_msg msg = { .addr = priv->cfg->i2c_address,\r\n.flags = 0, .buf = buf, .len = len };\r\nif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\r\nprintk(KERN_WARNING "mt2131 I2C write failed (len=%i)\n",\r\n(int)len);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2131_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct mt2131_priv *priv;\r\nint ret=0, i;\r\nu32 freq;\r\nu8 if_band_center;\r\nu32 f_lo1, f_lo2;\r\nu32 div1, num1, div2, num2;\r\nu8 b[8];\r\nu8 lockval = 0;\r\npriv = fe->tuner_priv;\r\nfreq = c->frequency / 1000;\r\ndprintk(1, "%s() freq=%d\n", __func__, freq);\r\nf_lo1 = freq + MT2131_IF1 * 1000;\r\nf_lo1 = (f_lo1 / 250) * 250;\r\nf_lo2 = f_lo1 - freq - MT2131_IF2;\r\npriv->frequency = (f_lo1 - f_lo2 - MT2131_IF2) * 1000;\r\nnum1 = f_lo1 * 64 / (MT2131_FREF / 128);\r\ndiv1 = num1 / 8192;\r\nnum1 &= 0x1fff;\r\nnum2 = f_lo2 * 64 / (MT2131_FREF / 128);\r\ndiv2 = num2 / 8192;\r\nnum2 &= 0x1fff;\r\nif (freq <= 82500) if_band_center = 0x00; else\r\nif (freq <= 137500) if_band_center = 0x01; else\r\nif (freq <= 192500) if_band_center = 0x02; else\r\nif (freq <= 247500) if_band_center = 0x03; else\r\nif (freq <= 302500) if_band_center = 0x04; else\r\nif (freq <= 357500) if_band_center = 0x05; else\r\nif (freq <= 412500) if_band_center = 0x06; else\r\nif (freq <= 467500) if_band_center = 0x07; else\r\nif (freq <= 522500) if_band_center = 0x08; else\r\nif (freq <= 577500) if_band_center = 0x09; else\r\nif (freq <= 632500) if_band_center = 0x0A; else\r\nif (freq <= 687500) if_band_center = 0x0B; else\r\nif (freq <= 742500) if_band_center = 0x0C; else\r\nif (freq <= 797500) if_band_center = 0x0D; else\r\nif (freq <= 852500) if_band_center = 0x0E; else\r\nif (freq <= 907500) if_band_center = 0x0F; else\r\nif (freq <= 962500) if_band_center = 0x10; else\r\nif (freq <= 1017500) if_band_center = 0x11; else\r\nif (freq <= 1072500) if_band_center = 0x12; else if_band_center = 0x13;\r\nb[0] = 1;\r\nb[1] = (num1 >> 5) & 0xFF;\r\nb[2] = (num1 & 0x1F);\r\nb[3] = div1;\r\nb[4] = (num2 >> 5) & 0xFF;\r\nb[5] = num2 & 0x1F;\r\nb[6] = div2;\r\ndprintk(1, "IF1: %dMHz IF2: %dMHz\n", MT2131_IF1, MT2131_IF2);\r\ndprintk(1, "PLL freq=%dkHz band=%d\n", (int)freq, (int)if_band_center);\r\ndprintk(1, "PLL f_lo1=%dkHz f_lo2=%dkHz\n", (int)f_lo1, (int)f_lo2);\r\ndprintk(1, "PLL div1=%d num1=%d div2=%d num2=%d\n",\r\n(int)div1, (int)num1, (int)div2, (int)num2);\r\ndprintk(1, "PLL [1..6]: %2x %2x %2x %2x %2x %2x\n",\r\n(int)b[1], (int)b[2], (int)b[3], (int)b[4], (int)b[5],\r\n(int)b[6]);\r\nret = mt2131_writeregs(priv,b,7);\r\nif (ret < 0)\r\nreturn ret;\r\nmt2131_writereg(priv, 0x0b, if_band_center);\r\ni = 0;\r\ndo {\r\nmt2131_readreg(priv, 0x08, &lockval);\r\nif ((lockval & 0x88) == 0x88)\r\nbreak;\r\nmsleep(4);\r\ni++;\r\n} while (i < 10);\r\nreturn ret;\r\n}\r\nstatic int mt2131_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct mt2131_priv *priv = fe->tuner_priv;\r\ndprintk(1, "%s()\n", __func__);\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstatic int mt2131_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nstruct mt2131_priv *priv = fe->tuner_priv;\r\nu8 lock_status = 0;\r\nu8 afc_status = 0;\r\n*status = 0;\r\nmt2131_readreg(priv, 0x08, &lock_status);\r\nif ((lock_status & 0x88) == 0x88)\r\n*status = TUNER_STATUS_LOCKED;\r\nmt2131_readreg(priv, 0x09, &afc_status);\r\ndprintk(1, "%s() - LO Status = 0x%x, AFC Status = 0x%x\n",\r\n__func__, lock_status, afc_status);\r\nreturn 0;\r\n}\r\nstatic int mt2131_init(struct dvb_frontend *fe)\r\n{\r\nstruct mt2131_priv *priv = fe->tuner_priv;\r\nint ret;\r\ndprintk(1, "%s()\n", __func__);\r\nif ((ret = mt2131_writeregs(priv, mt2131_config1,\r\nsizeof(mt2131_config1))) < 0)\r\nreturn ret;\r\nmt2131_writereg(priv, 0x0b, 0x09);\r\nmt2131_writereg(priv, 0x15, 0x47);\r\nmt2131_writereg(priv, 0x07, 0xf2);\r\nmt2131_writereg(priv, 0x0b, 0x01);\r\nif ((ret = mt2131_writeregs(priv, mt2131_config2,\r\nsizeof(mt2131_config2))) < 0)\r\nreturn ret;\r\nreturn ret;\r\n}\r\nstatic void mt2131_release(struct dvb_frontend *fe)\r\n{\r\ndprintk(1, "%s()\n", __func__);\r\nkfree(fe->tuner_priv);\r\nfe->tuner_priv = NULL;\r\n}\r\nstruct dvb_frontend * mt2131_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c,\r\nstruct mt2131_config *cfg, u16 if1)\r\n{\r\nstruct mt2131_priv *priv = NULL;\r\nu8 id = 0;\r\ndprintk(1, "%s()\n", __func__);\r\npriv = kzalloc(sizeof(struct mt2131_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\npriv->cfg = cfg;\r\npriv->i2c = i2c;\r\nif (mt2131_readreg(priv, 0, &id) != 0) {\r\nkfree(priv);\r\nreturn NULL;\r\n}\r\nif ( (id != 0x3E) && (id != 0x3F) ) {\r\nprintk(KERN_ERR "MT2131: Device not found at addr 0x%02x\n",\r\ncfg->i2c_address);\r\nkfree(priv);\r\nreturn NULL;\r\n}\r\nprintk(KERN_INFO "MT2131: successfully identified at address 0x%02x\n",\r\ncfg->i2c_address);\r\nmemcpy(&fe->ops.tuner_ops, &mt2131_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = priv;\r\nreturn fe;\r\n}

int maxim_charger_calc_reg_current(const struct maxim_charger_current *limits,\r\nunsigned int min_ua, unsigned int max_ua, u8 *dst)\r\n{\r\nunsigned int current_bits = 0xf;\r\nif (min_ua > max_ua)\r\nreturn -EINVAL;\r\nif (min_ua > limits->max || max_ua < limits->min)\r\nreturn -EINVAL;\r\nif (max_ua < limits->high_start) {\r\n*dst = 0x0;\r\nreturn 0;\r\n}\r\nmax_ua = min(limits->max, max_ua);\r\nmax_ua -= limits->high_start;\r\ncurrent_bits = max_ua / limits->high_step;\r\n*dst = 0x1 << CHGCTRL4_MBCICHWRCL_SHIFT;\r\n*dst |= current_bits << CHGCTRL4_MBCICHWRCH_SHIFT;\r\nreturn 0;\r\n}\r\nstatic bool max14577_muic_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase MAX14577_REG_INT1 ... MAX14577_REG_STATUS3:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic bool max77836_muic_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nif (max14577_muic_volatile_reg(dev, reg))\r\nreturn true;\r\nswitch (reg) {\r\ncase MAX77836_FG_REG_VCELL_MSB ... MAX77836_FG_REG_SOC_LSB:\r\ncase MAX77836_FG_REG_CRATE_MSB ... MAX77836_FG_REG_CRATE_LSB:\r\ncase MAX77836_FG_REG_STATUS_H ... MAX77836_FG_REG_STATUS_L:\r\ncase MAX77836_PMIC_REG_INTSRC:\r\ncase MAX77836_PMIC_REG_TOPSYS_INT:\r\ncase MAX77836_PMIC_REG_TOPSYS_STAT:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic void max14577_print_dev_type(struct max14577 *max14577)\r\n{\r\nu8 reg_data, vendor_id, device_id;\r\nint ret;\r\nret = max14577_read_reg(max14577->regmap, MAX14577_REG_DEVICEID,\r\n&reg_data);\r\nif (ret) {\r\ndev_err(max14577->dev,\r\n"Failed to read DEVICEID register: %d\n", ret);\r\nreturn;\r\n}\r\nvendor_id = ((reg_data & DEVID_VENDORID_MASK) >>\r\nDEVID_VENDORID_SHIFT);\r\ndevice_id = ((reg_data & DEVID_DEVICEID_MASK) >>\r\nDEVID_DEVICEID_SHIFT);\r\ndev_info(max14577->dev, "Device type: %u (ID: 0x%x, vendor: 0x%x)\n",\r\nmax14577->dev_type, device_id, vendor_id);\r\n}\r\nstatic int max77836_init(struct max14577 *max14577)\r\n{\r\nint ret;\r\nu8 intsrc_mask;\r\nmax14577->i2c_pmic = i2c_new_dummy(max14577->i2c->adapter,\r\nI2C_ADDR_PMIC);\r\nif (!max14577->i2c_pmic) {\r\ndev_err(max14577->dev, "Failed to register PMIC I2C device\n");\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(max14577->i2c_pmic, max14577);\r\nmax14577->regmap_pmic = devm_regmap_init_i2c(max14577->i2c_pmic,\r\n&max77836_pmic_regmap_config);\r\nif (IS_ERR(max14577->regmap_pmic)) {\r\nret = PTR_ERR(max14577->regmap_pmic);\r\ndev_err(max14577->dev, "Failed to allocate PMIC register map: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nret = max14577_read_reg(max14577->regmap_pmic,\r\nMAX77836_PMIC_REG_INTSRC_MASK, &intsrc_mask);\r\nif (ret < 0) {\r\ndev_err(max14577->dev, "Failed to read PMIC register\n");\r\ngoto err;\r\n}\r\nintsrc_mask &= ~(MAX77836_INTSRC_MASK_TOP_INT_MASK);\r\nintsrc_mask &= ~(MAX77836_INTSRC_MASK_MUIC_CHG_INT_MASK);\r\nret = max14577_write_reg(max14577->regmap_pmic,\r\nMAX77836_PMIC_REG_INTSRC_MASK, intsrc_mask);\r\nif (ret < 0) {\r\ndev_err(max14577->dev, "Failed to write PMIC register\n");\r\ngoto err;\r\n}\r\nret = regmap_add_irq_chip(max14577->regmap_pmic, max14577->irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT | IRQF_SHARED,\r\n0, &max77836_pmic_irq_chip,\r\n&max14577->irq_data_pmic);\r\nif (ret != 0) {\r\ndev_err(max14577->dev, "Failed to request PMIC IRQ %d: %d\n",\r\nmax14577->irq, ret);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ni2c_unregister_device(max14577->i2c_pmic);\r\nreturn ret;\r\n}\r\nstatic void max77836_remove(struct max14577 *max14577)\r\n{\r\nregmap_del_irq_chip(max14577->irq, max14577->irq_data_pmic);\r\ni2c_unregister_device(max14577->i2c_pmic);\r\n}\r\nstatic int max14577_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max14577 *max14577;\r\nstruct max14577_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nstruct device_node *np = i2c->dev.of_node;\r\nint ret = 0;\r\nconst struct regmap_irq_chip *irq_chip;\r\nconst struct mfd_cell *mfd_devs;\r\nunsigned int mfd_devs_size;\r\nint irq_flags;\r\nif (np) {\r\npdata = devm_kzalloc(&i2c->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\ni2c->dev.platform_data = pdata;\r\n}\r\nif (!pdata) {\r\ndev_err(&i2c->dev, "No platform data found.\n");\r\nreturn -EINVAL;\r\n}\r\nmax14577 = devm_kzalloc(&i2c->dev, sizeof(*max14577), GFP_KERNEL);\r\nif (!max14577)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, max14577);\r\nmax14577->dev = &i2c->dev;\r\nmax14577->i2c = i2c;\r\nmax14577->irq = i2c->irq;\r\nmax14577->regmap = devm_regmap_init_i2c(i2c,\r\n&max14577_muic_regmap_config);\r\nif (IS_ERR(max14577->regmap)) {\r\nret = PTR_ERR(max14577->regmap);\r\ndev_err(max14577->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (np) {\r\nconst struct of_device_id *of_id;\r\nof_id = of_match_device(max14577_dt_match, &i2c->dev);\r\nif (of_id)\r\nmax14577->dev_type =\r\n(enum maxim_device_type)of_id->data;\r\n} else {\r\nmax14577->dev_type = id->driver_data;\r\n}\r\nmax14577_print_dev_type(max14577);\r\nswitch (max14577->dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nirq_chip = &max77836_muic_irq_chip;\r\nmfd_devs = max77836_devs;\r\nmfd_devs_size = ARRAY_SIZE(max77836_devs);\r\nirq_flags = IRQF_TRIGGER_FALLING | IRQF_ONESHOT | IRQF_SHARED;\r\nbreak;\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nirq_chip = &max14577_irq_chip;\r\nmfd_devs = max14577_devs;\r\nmfd_devs_size = ARRAY_SIZE(max14577_devs);\r\nirq_flags = IRQF_TRIGGER_FALLING | IRQF_ONESHOT;\r\nbreak;\r\n}\r\nret = regmap_add_irq_chip(max14577->regmap, max14577->irq,\r\nirq_flags, 0, irq_chip,\r\n&max14577->irq_data);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "Failed to request IRQ %d: %d\n",\r\nmax14577->irq, ret);\r\nreturn ret;\r\n}\r\nif (max14577->dev_type == MAXIM_DEVICE_TYPE_MAX77836) {\r\nret = max77836_init(max14577);\r\nif (ret < 0)\r\ngoto err_max77836;\r\n}\r\nret = mfd_add_devices(max14577->dev, -1, mfd_devs,\r\nmfd_devs_size, NULL, 0, NULL);\r\nif (ret < 0)\r\ngoto err_mfd;\r\ndevice_init_wakeup(max14577->dev, 1);\r\nreturn 0;\r\nerr_mfd:\r\nif (max14577->dev_type == MAXIM_DEVICE_TYPE_MAX77836)\r\nmax77836_remove(max14577);\r\nerr_max77836:\r\nregmap_del_irq_chip(max14577->irq, max14577->irq_data);\r\nreturn ret;\r\n}\r\nstatic int max14577_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct max14577 *max14577 = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(max14577->dev);\r\nregmap_del_irq_chip(max14577->irq, max14577->irq_data);\r\nif (max14577->dev_type == MAXIM_DEVICE_TYPE_MAX77836)\r\nmax77836_remove(max14577);\r\nreturn 0;\r\n}\r\nstatic int max14577_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max14577 *max14577 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(max14577->irq);\r\ndisable_irq(max14577->irq);\r\nreturn 0;\r\n}\r\nstatic int max14577_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max14577 *max14577 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(max14577->irq);\r\nenable_irq(max14577->irq);\r\nreturn 0;\r\n}\r\nstatic int __init max14577_i2c_init(void)\r\n{\r\nBUILD_BUG_ON(ARRAY_SIZE(max14577_i2c_id) != MAXIM_DEVICE_TYPE_NUM);\r\nBUILD_BUG_ON(ARRAY_SIZE(max14577_dt_match) != MAXIM_DEVICE_TYPE_NUM);\r\nBUILD_BUG_ON(ARRAY_SIZE(maxim_charger_currents) != MAXIM_DEVICE_TYPE_NUM);\r\nBUILD_BUG_ON(MAX14577_CHARGER_CURRENT_LIMIT_HIGH_START +\r\nMAX14577_CHARGER_CURRENT_LIMIT_HIGH_STEP * 0xf !=\r\nMAX14577_CHARGER_CURRENT_LIMIT_MAX);\r\nBUILD_BUG_ON(MAX14577_CHARGER_CURRENT_LIMIT_HIGH_STEP == 0);\r\nBUILD_BUG_ON(MAX77836_CHARGER_CURRENT_LIMIT_HIGH_START +\r\nMAX77836_CHARGER_CURRENT_LIMIT_HIGH_STEP * 0xf !=\r\nMAX77836_CHARGER_CURRENT_LIMIT_MAX);\r\nBUILD_BUG_ON(MAX77836_CHARGER_CURRENT_LIMIT_HIGH_STEP == 0);\r\nreturn i2c_add_driver(&max14577_i2c_driver);\r\n}\r\nstatic void __exit max14577_i2c_exit(void)\r\n{\r\ni2c_del_driver(&max14577_i2c_driver);\r\n}

static void proc_read_firmware(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_tscm *tscm = entry->private_data;\r\n__be32 data;\r\nunsigned int reg, fpga, arm, hw;\r\nint err;\r\nerr = snd_fw_transaction(tscm->unit, TCODE_READ_QUADLET_REQUEST,\r\nTSCM_ADDR_BASE + TSCM_OFFSET_FIRMWARE_REGISTER,\r\n&data, sizeof(data), 0);\r\nif (err < 0)\r\nreturn;\r\nreg = be32_to_cpu(data);\r\nerr = snd_fw_transaction(tscm->unit, TCODE_READ_QUADLET_REQUEST,\r\nTSCM_ADDR_BASE + TSCM_OFFSET_FIRMWARE_FPGA,\r\n&data, sizeof(data), 0);\r\nif (err < 0)\r\nreturn;\r\nfpga = be32_to_cpu(data);\r\nerr = snd_fw_transaction(tscm->unit, TCODE_READ_QUADLET_REQUEST,\r\nTSCM_ADDR_BASE + TSCM_OFFSET_FIRMWARE_ARM,\r\n&data, sizeof(data), 0);\r\nif (err < 0)\r\nreturn;\r\narm = be32_to_cpu(data);\r\nerr = snd_fw_transaction(tscm->unit, TCODE_READ_QUADLET_REQUEST,\r\nTSCM_ADDR_BASE + TSCM_OFFSET_FIRMWARE_HW,\r\n&data, sizeof(data), 0);\r\nif (err < 0)\r\nreturn;\r\nhw = be32_to_cpu(data);\r\nsnd_iprintf(buffer, "Register: %d (0x%08x)\n", reg & 0xffff, reg);\r\nsnd_iprintf(buffer, "FPGA: %d (0x%08x)\n", fpga & 0xffff, fpga);\r\nsnd_iprintf(buffer, "ARM: %d (0x%08x)\n", arm & 0xffff, arm);\r\nsnd_iprintf(buffer, "Hardware: %d (0x%08x)\n", hw >> 16, hw);\r\n}\r\nstatic void add_node(struct snd_tscm *tscm, struct snd_info_entry *root,\r\nconst char *name,\r\nvoid (*op)(struct snd_info_entry *e,\r\nstruct snd_info_buffer *b))\r\n{\r\nstruct snd_info_entry *entry;\r\nentry = snd_info_create_card_entry(tscm->card, name, root);\r\nif (entry == NULL)\r\nreturn;\r\nsnd_info_set_text_ops(entry, tscm, op);\r\nif (snd_info_register(entry) < 0)\r\nsnd_info_free_entry(entry);\r\n}\r\nvoid snd_tscm_proc_init(struct snd_tscm *tscm)\r\n{\r\nstruct snd_info_entry *root;\r\nroot = snd_info_create_card_entry(tscm->card, "firewire",\r\ntscm->card->proc_root);\r\nif (root == NULL)\r\nreturn;\r\nroot->mode = S_IFDIR | S_IRUGO | S_IXUGO;\r\nif (snd_info_register(root) < 0) {\r\nsnd_info_free_entry(root);\r\nreturn;\r\n}\r\nadd_node(tscm, root, "firmware", proc_read_firmware);\r\n}

static u64 swiotlb_powerpc_get_required(struct device *dev)\r\n{\r\nu64 end, mask, max_direct_dma_addr = dev->archdata.max_direct_dma_addr;\r\nend = memblock_end_of_DRAM();\r\nif (max_direct_dma_addr && end > max_direct_dma_addr)\r\nend = max_direct_dma_addr;\r\nend += get_dma_offset(dev);\r\nmask = 1ULL << (fls64(end) - 1);\r\nmask += mask - 1;\r\nreturn mask;\r\n}\r\nvoid pci_dma_dev_setup_swiotlb(struct pci_dev *pdev)\r\n{\r\nstruct pci_controller *hose;\r\nstruct dev_archdata *sd;\r\nhose = pci_bus_to_host(pdev->bus);\r\nsd = &pdev->dev.archdata;\r\nsd->max_direct_dma_addr =\r\nhose->dma_window_base_cur + hose->dma_window_size;\r\n}\r\nstatic int ppc_swiotlb_bus_notify(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct device *dev = data;\r\nstruct dev_archdata *sd;\r\nif (action != BUS_NOTIFY_ADD_DEVICE)\r\nreturn 0;\r\nsd = &dev->archdata;\r\nsd->max_direct_dma_addr = 0;\r\nif ((dma_get_mask(dev) + 1) < memblock_end_of_DRAM())\r\nset_dma_ops(dev, &swiotlb_dma_ops);\r\nreturn NOTIFY_DONE;\r\n}\r\nint __init swiotlb_setup_bus_notifier(void)\r\n{\r\nbus_register_notifier(&platform_bus_type,\r\n&ppc_swiotlb_plat_bus_notifier);\r\nreturn 0;\r\n}\r\nvoid __init swiotlb_detect_4g(void)\r\n{\r\nif ((memblock_end_of_DRAM() - 1) > 0xffffffff) {\r\nppc_swiotlb_enable = 1;\r\n#ifdef CONFIG_ZONE_DMA32\r\nlimit_zone_pfn(ZONE_DMA32, (1ULL << 32) >> PAGE_SHIFT);\r\n#endif\r\n}\r\n}\r\nstatic int __init check_swiotlb_enabled(void)\r\n{\r\nif (ppc_swiotlb_enable)\r\nswiotlb_print_info();\r\nelse\r\nswiotlb_free();\r\nreturn 0;\r\n}

unsigned int mmc_status(struct device *dev)\r\n{\r\nstruct amba_device *adev = container_of(dev, struct amba_device, dev);\r\nu32 mask;\r\nif (adev->res.start == VERSATILE_MMCI0_BASE)\r\nmask = 1;\r\nelse\r\nmask = 2;\r\nreturn readl(versatile_sys_base + VERSATILE_SYS_MCI_OFFSET) & mask;\r\n}\r\nstatic void versatile_clcd_disable(struct clcd_fb *fb)\r\n{\r\nvoid __iomem *sys_clcd = versatile_sys_base + VERSATILE_SYS_CLCD_OFFSET;\r\nu32 val;\r\nval = readl(sys_clcd);\r\nval &= ~SYS_CLCD_NLCDIOON | SYS_CLCD_PWR3V5SWITCH;\r\nwritel(val, sys_clcd);\r\nif (of_machine_is_compatible("arm,versatile-ab") && is_sanyo_2_5_lcd) {\r\nunsigned long ctrl;\r\nctrl = readl(versatile_ib2_ctrl);\r\nctrl &= ~0x01;\r\nwritel(ctrl, versatile_ib2_ctrl);\r\n}\r\n}\r\nstatic void versatile_clcd_enable(struct clcd_fb *fb)\r\n{\r\nstruct fb_var_screeninfo *var = &fb->fb.var;\r\nvoid __iomem *sys_clcd = versatile_sys_base + VERSATILE_SYS_CLCD_OFFSET;\r\nu32 val;\r\nval = readl(sys_clcd);\r\nval &= ~SYS_CLCD_MODE_MASK;\r\nswitch (var->green.length) {\r\ncase 5:\r\nval |= SYS_CLCD_MODE_5551;\r\nbreak;\r\ncase 6:\r\nif (var->red.offset == 0)\r\nval |= SYS_CLCD_MODE_565_RLSB;\r\nelse\r\nval |= SYS_CLCD_MODE_565_BLSB;\r\nbreak;\r\ncase 8:\r\nval |= SYS_CLCD_MODE_888;\r\nbreak;\r\n}\r\nwritel(val, sys_clcd);\r\nval |= SYS_CLCD_NLCDIOON | SYS_CLCD_PWR3V5SWITCH;\r\nwritel(val, sys_clcd);\r\nif (of_machine_is_compatible("arm,versatile-ab") && is_sanyo_2_5_lcd) {\r\nunsigned long ctrl;\r\nctrl = readl(versatile_ib2_ctrl);\r\nctrl |= 0x01;\r\nwritel(ctrl, versatile_ib2_ctrl);\r\n}\r\n}\r\nstatic int versatile_clcd_setup(struct clcd_fb *fb)\r\n{\r\nvoid __iomem *sys_clcd = versatile_sys_base + VERSATILE_SYS_CLCD_OFFSET;\r\nconst char *panel_name;\r\nu32 val;\r\nis_sanyo_2_5_lcd = false;\r\nval = readl(sys_clcd) & SYS_CLCD_ID_MASK;\r\nif (val == SYS_CLCD_ID_SANYO_3_8)\r\npanel_name = "Sanyo TM38QV67A02A";\r\nelse if (val == SYS_CLCD_ID_SANYO_2_5) {\r\npanel_name = "Sanyo QVGA Portrait";\r\nis_sanyo_2_5_lcd = true;\r\n} else if (val == SYS_CLCD_ID_EPSON_2_2)\r\npanel_name = "Epson L2F50113T00";\r\nelse if (val == SYS_CLCD_ID_VGA)\r\npanel_name = "VGA";\r\nelse {\r\nprintk(KERN_ERR "CLCD: unknown LCD panel ID 0x%08x, using VGA\n",\r\nval);\r\npanel_name = "VGA";\r\n}\r\nfb->panel = versatile_clcd_get_panel(panel_name);\r\nif (!fb->panel)\r\nreturn -EINVAL;\r\nreturn versatile_clcd_setup_dma(fb, SZ_1M);\r\n}\r\nstatic void versatile_clcd_decode(struct clcd_fb *fb, struct clcd_regs *regs)\r\n{\r\nclcdfb_decode(fb, regs);\r\nif (fb->fb.var.green.length == 6)\r\nregs->cntl &= ~CNTL_BGR;\r\n}\r\nstatic void __init versatile_map_io(void)\r\n{\r\ndebug_ll_io_init();\r\niotable_init(versatile_io_desc, ARRAY_SIZE(versatile_io_desc));\r\n}\r\nstatic void __init versatile_init_early(void)\r\n{\r\nu32 val;\r\nval = readl(__io_address(VERSATILE_SCTL_BASE));\r\nwritel((VERSATILE_TIMCLK << VERSATILE_TIMER1_EnSel) |\r\n(VERSATILE_TIMCLK << VERSATILE_TIMER2_EnSel) |\r\n(VERSATILE_TIMCLK << VERSATILE_TIMER3_EnSel) |\r\n(VERSATILE_TIMCLK << VERSATILE_TIMER4_EnSel) | val,\r\n__io_address(VERSATILE_SCTL_BASE));\r\n}\r\nstatic void __init versatile_dt_pci_init(void)\r\n{\r\nu32 val;\r\nstruct device_node *np;\r\nstruct property *newprop;\r\nnp = of_find_compatible_node(NULL, NULL, "arm,versatile-pci");\r\nif (!np)\r\nreturn;\r\nval = readl(versatile_sys_base + VERSATILE_SYS_PCICTL_OFFSET);\r\nif (val & 1) {\r\nwritel(1, versatile_sys_base + VERSATILE_SYS_PCICTL_OFFSET);\r\nreturn;\r\n}\r\nnewprop = kzalloc(sizeof(*newprop), GFP_KERNEL);\r\nif (!newprop)\r\nreturn;\r\nnewprop->name = kstrdup("status", GFP_KERNEL);\r\nnewprop->value = kstrdup("disabled", GFP_KERNEL);\r\nnewprop->length = sizeof("disabled");\r\nof_update_property(np, newprop);\r\npr_info("Not plugged into PCI backplane!\n");\r\n}\r\nstatic void __init versatile_dt_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "arm,core-module-versatile");\r\nif (np)\r\nversatile_sys_base = of_iomap(np, 0);\r\nWARN_ON(!versatile_sys_base);\r\nversatile_ib2_ctrl = ioremap(VERSATILE_IB2_CTL_BASE, SZ_4K);\r\nversatile_dt_pci_init();\r\nof_platform_default_populate(NULL, versatile_auxdata_lookup, NULL);\r\n}

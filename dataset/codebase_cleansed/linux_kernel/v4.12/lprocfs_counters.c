void lprocfs_counter_add(struct lprocfs_stats *stats, int idx, long amount)\r\n{\r\nstruct lprocfs_counter *percpu_cntr;\r\nstruct lprocfs_counter_header *header;\r\nint smp_id;\r\nunsigned long flags = 0;\r\nif (!stats)\r\nreturn;\r\nLASSERTF(0 <= idx && idx < stats->ls_num,\r\n"idx %d, ls_num %hu\n", idx, stats->ls_num);\r\nsmp_id = lprocfs_stats_lock(stats, LPROCFS_GET_SMP_ID, &flags);\r\nif (smp_id < 0)\r\nreturn;\r\nheader = &stats->ls_cnt_header[idx];\r\npercpu_cntr = lprocfs_stats_counter_get(stats, smp_id, idx);\r\npercpu_cntr->lc_count++;\r\nif (header->lc_config & LPROCFS_CNTR_AVGMINMAX) {\r\nif (in_interrupt() &&\r\n(stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE) != 0)\r\npercpu_cntr->lc_sum_irq += amount;\r\nelse\r\npercpu_cntr->lc_sum += amount;\r\nif (header->lc_config & LPROCFS_CNTR_STDDEV)\r\npercpu_cntr->lc_sumsquare += (__s64)amount * amount;\r\nif (amount < percpu_cntr->lc_min)\r\npercpu_cntr->lc_min = amount;\r\nif (amount > percpu_cntr->lc_max)\r\npercpu_cntr->lc_max = amount;\r\n}\r\nlprocfs_stats_unlock(stats, LPROCFS_GET_SMP_ID, &flags);\r\n}\r\nvoid lprocfs_counter_sub(struct lprocfs_stats *stats, int idx, long amount)\r\n{\r\nstruct lprocfs_counter *percpu_cntr;\r\nstruct lprocfs_counter_header *header;\r\nint smp_id;\r\nunsigned long flags = 0;\r\nif (!stats)\r\nreturn;\r\nLASSERTF(0 <= idx && idx < stats->ls_num,\r\n"idx %d, ls_num %hu\n", idx, stats->ls_num);\r\nsmp_id = lprocfs_stats_lock(stats, LPROCFS_GET_SMP_ID, &flags);\r\nif (smp_id < 0)\r\nreturn;\r\nheader = &stats->ls_cnt_header[idx];\r\npercpu_cntr = lprocfs_stats_counter_get(stats, smp_id, idx);\r\nif (header->lc_config & LPROCFS_CNTR_AVGMINMAX) {\r\nif (in_interrupt() &&\r\n(stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE) != 0)\r\npercpu_cntr->lc_sum_irq -= amount;\r\nelse\r\npercpu_cntr->lc_sum -= amount;\r\n}\r\nlprocfs_stats_unlock(stats, LPROCFS_GET_SMP_ID, &flags);\r\n}

static u32 spireg_read(struct a3700_spi *a3700_spi, u32 offset)\r\n{\r\nreturn readl(a3700_spi->base + offset);\r\n}\r\nstatic void spireg_write(struct a3700_spi *a3700_spi, u32 offset, u32 data)\r\n{\r\nwritel(data, a3700_spi->base + offset);\r\n}\r\nstatic void a3700_spi_auto_cs_unset(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~A3700_SPI_AUTO_CS;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic void a3700_spi_activate_cs(struct a3700_spi *a3700_spi, unsigned int cs)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nval |= (A3700_SPI_EN << cs);\r\nspireg_write(a3700_spi, A3700_SPI_IF_CTRL_REG, val);\r\n}\r\nstatic void a3700_spi_deactivate_cs(struct a3700_spi *a3700_spi,\r\nunsigned int cs)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nval &= ~(A3700_SPI_EN << cs);\r\nspireg_write(a3700_spi, A3700_SPI_IF_CTRL_REG, val);\r\n}\r\nstatic int a3700_spi_pin_mode_set(struct a3700_spi *a3700_spi,\r\nunsigned int pin_mode)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~(A3700_SPI_INST_PIN | A3700_SPI_ADDR_PIN);\r\nval &= ~(A3700_SPI_DATA_PIN0 | A3700_SPI_DATA_PIN1);\r\nswitch (pin_mode) {\r\ncase SPI_NBITS_SINGLE:\r\nbreak;\r\ncase SPI_NBITS_DUAL:\r\nval |= A3700_SPI_DATA_PIN0;\r\nbreak;\r\ncase SPI_NBITS_QUAD:\r\nval |= A3700_SPI_DATA_PIN1;\r\nbreak;\r\ndefault:\r\ndev_err(&a3700_spi->master->dev, "wrong pin mode %u", pin_mode);\r\nreturn -EINVAL;\r\n}\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\nreturn 0;\r\n}\r\nstatic void a3700_spi_fifo_mode_set(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= A3700_SPI_FIFO_MODE;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic void a3700_spi_mode_set(struct a3700_spi *a3700_spi,\r\nunsigned int mode_bits)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nif (mode_bits & SPI_CPOL)\r\nval |= A3700_SPI_CLK_POL;\r\nelse\r\nval &= ~A3700_SPI_CLK_POL;\r\nif (mode_bits & SPI_CPHA)\r\nval |= A3700_SPI_CLK_PHA;\r\nelse\r\nval &= ~A3700_SPI_CLK_PHA;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic void a3700_spi_clock_set(struct a3700_spi *a3700_spi,\r\nunsigned int speed_hz, u16 mode)\r\n{\r\nu32 val;\r\nu32 prescale;\r\nprescale = DIV_ROUND_UP(clk_get_rate(a3700_spi->clk), speed_hz);\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval = val & ~A3700_SPI_CLK_PRESCALE_MASK;\r\nval = val | (prescale & A3700_SPI_CLK_PRESCALE_MASK);\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\nif (prescale <= 2) {\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_TIME_REG);\r\nval |= A3700_SPI_CLK_CAPT_EDGE;\r\nspireg_write(a3700_spi, A3700_SPI_IF_TIME_REG, val);\r\n}\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~(A3700_SPI_CLK_POL | A3700_SPI_CLK_PHA);\r\nif (mode & SPI_CPOL)\r\nval |= A3700_SPI_CLK_POL;\r\nif (mode & SPI_CPHA)\r\nval |= A3700_SPI_CLK_PHA;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic void a3700_spi_bytelen_set(struct a3700_spi *a3700_spi, unsigned int len)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nif (len == 4)\r\nval |= A3700_SPI_BYTE_LEN;\r\nelse\r\nval &= ~A3700_SPI_BYTE_LEN;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\na3700_spi->byte_len = len;\r\n}\r\nstatic int a3700_spi_fifo_flush(struct a3700_spi *a3700_spi)\r\n{\r\nint timeout = A3700_SPI_TIMEOUT;\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= A3700_SPI_FIFO_FLUSH;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\nwhile (--timeout) {\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nif (!(val & A3700_SPI_FIFO_FLUSH))\r\nreturn 0;\r\nudelay(1);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int a3700_spi_init(struct a3700_spi *a3700_spi)\r\n{\r\nstruct spi_master *master = a3700_spi->master;\r\nu32 val;\r\nint i, ret = 0;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= A3700_SPI_SRST;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\nudelay(A3700_SPI_TIMEOUT);\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~A3700_SPI_SRST;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\na3700_spi_auto_cs_unset(a3700_spi);\r\nfor (i = 0; i < master->num_chipselect; i++)\r\na3700_spi_deactivate_cs(a3700_spi, i);\r\na3700_spi_fifo_mode_set(a3700_spi);\r\na3700_spi_mode_set(a3700_spi, master->mode_bits);\r\nspireg_write(a3700_spi, A3700_SPI_IF_HDR_CNT_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_IF_DIN_CNT_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_INT_MASK_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_INT_STAT_REG, ~0U);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t a3700_spi_interrupt(int irq, void *dev_id)\r\n{\r\nstruct spi_master *master = dev_id;\r\nstruct a3700_spi *a3700_spi;\r\nu32 cause;\r\na3700_spi = spi_master_get_devdata(master);\r\ncause = spireg_read(a3700_spi, A3700_SPI_INT_STAT_REG);\r\nif (!cause || !(a3700_spi->wait_mask & cause))\r\nreturn IRQ_NONE;\r\nspireg_write(a3700_spi, A3700_SPI_INT_MASK_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_INT_STAT_REG, cause);\r\ncomplete(&a3700_spi->done);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic bool a3700_spi_wait_completion(struct spi_device *spi)\r\n{\r\nstruct a3700_spi *a3700_spi;\r\nunsigned int timeout;\r\nunsigned int ctrl_reg;\r\nunsigned long timeout_jiffies;\r\na3700_spi = spi_master_get_devdata(spi->master);\r\nctrl_reg = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nif (a3700_spi->wait_mask & ctrl_reg)\r\nreturn true;\r\nreinit_completion(&a3700_spi->done);\r\nspireg_write(a3700_spi, A3700_SPI_INT_MASK_REG,\r\na3700_spi->wait_mask);\r\ntimeout_jiffies = msecs_to_jiffies(A3700_SPI_TIMEOUT);\r\ntimeout = wait_for_completion_timeout(&a3700_spi->done,\r\ntimeout_jiffies);\r\na3700_spi->wait_mask = 0;\r\nif (timeout)\r\nreturn true;\r\nctrl_reg = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nif (a3700_spi->wait_mask & ctrl_reg)\r\nreturn true;\r\nspireg_write(a3700_spi, A3700_SPI_INT_MASK_REG, 0);\r\nreturn true;\r\n}\r\nstatic bool a3700_spi_transfer_wait(struct spi_device *spi,\r\nunsigned int bit_mask)\r\n{\r\nstruct a3700_spi *a3700_spi;\r\na3700_spi = spi_master_get_devdata(spi->master);\r\na3700_spi->wait_mask = bit_mask;\r\nreturn a3700_spi_wait_completion(spi);\r\n}\r\nstatic void a3700_spi_fifo_thres_set(struct a3700_spi *a3700_spi,\r\nunsigned int bytes)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~(A3700_SPI_FIFO_THRS_MASK << A3700_SPI_RFIFO_THRS_BIT);\r\nval |= (bytes - 1) << A3700_SPI_RFIFO_THRS_BIT;\r\nval &= ~(A3700_SPI_FIFO_THRS_MASK << A3700_SPI_WFIFO_THRS_BIT);\r\nval |= (7 - bytes) << A3700_SPI_WFIFO_THRS_BIT;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic void a3700_spi_transfer_setup(struct spi_device *spi,\r\nstruct spi_transfer *xfer)\r\n{\r\nstruct a3700_spi *a3700_spi;\r\nunsigned int byte_len;\r\na3700_spi = spi_master_get_devdata(spi->master);\r\na3700_spi_clock_set(a3700_spi, xfer->speed_hz, spi->mode);\r\nbyte_len = xfer->bits_per_word >> 3;\r\na3700_spi_fifo_thres_set(a3700_spi, byte_len);\r\n}\r\nstatic void a3700_spi_set_cs(struct spi_device *spi, bool enable)\r\n{\r\nstruct a3700_spi *a3700_spi = spi_master_get_devdata(spi->master);\r\nif (!enable)\r\na3700_spi_activate_cs(a3700_spi, spi->chip_select);\r\nelse\r\na3700_spi_deactivate_cs(a3700_spi, spi->chip_select);\r\n}\r\nstatic void a3700_spi_header_set(struct a3700_spi *a3700_spi)\r\n{\r\nu32 instr_cnt = 0, addr_cnt = 0, dummy_cnt = 0;\r\nu32 val = 0;\r\nspireg_write(a3700_spi, A3700_SPI_IF_INST_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_IF_ADDR_REG, 0);\r\nspireg_write(a3700_spi, A3700_SPI_IF_RMODE_REG, 0);\r\nif (a3700_spi->tx_buf) {\r\nif (a3700_spi->buf_len <= a3700_spi->instr_cnt) {\r\ninstr_cnt = a3700_spi->buf_len;\r\n} else if (a3700_spi->buf_len <= (a3700_spi->instr_cnt +\r\na3700_spi->addr_cnt)) {\r\ninstr_cnt = a3700_spi->instr_cnt;\r\naddr_cnt = a3700_spi->buf_len - instr_cnt;\r\n} else if (a3700_spi->buf_len <= a3700_spi->hdr_cnt) {\r\ninstr_cnt = a3700_spi->instr_cnt;\r\naddr_cnt = a3700_spi->addr_cnt;\r\nif (!a3700_spi->tx_buf[instr_cnt + addr_cnt])\r\ndummy_cnt = a3700_spi->buf_len - instr_cnt -\r\naddr_cnt;\r\n}\r\nval |= ((instr_cnt & A3700_SPI_INSTR_CNT_MASK)\r\n<< A3700_SPI_INSTR_CNT_BIT);\r\nval |= ((addr_cnt & A3700_SPI_ADDR_CNT_MASK)\r\n<< A3700_SPI_ADDR_CNT_BIT);\r\nval |= ((dummy_cnt & A3700_SPI_DUMMY_CNT_MASK)\r\n<< A3700_SPI_DUMMY_CNT_BIT);\r\n}\r\nspireg_write(a3700_spi, A3700_SPI_IF_HDR_CNT_REG, val);\r\na3700_spi->buf_len -= (instr_cnt + addr_cnt + dummy_cnt);\r\nval = 0;\r\nwhile (instr_cnt--) {\r\nval = (val << 8) | a3700_spi->tx_buf[0];\r\na3700_spi->tx_buf++;\r\n}\r\nspireg_write(a3700_spi, A3700_SPI_IF_INST_REG, val);\r\nval = 0;\r\nwhile (addr_cnt--) {\r\nval = (val << 8) | a3700_spi->tx_buf[0];\r\na3700_spi->tx_buf++;\r\n}\r\nspireg_write(a3700_spi, A3700_SPI_IF_ADDR_REG, val);\r\n}\r\nstatic int a3700_is_wfifo_full(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nreturn (val & A3700_SPI_WFIFO_FULL);\r\n}\r\nstatic int a3700_spi_fifo_write(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val;\r\nint i = 0;\r\nwhile (!a3700_is_wfifo_full(a3700_spi) && a3700_spi->buf_len) {\r\nval = 0;\r\nif (a3700_spi->buf_len >= 4) {\r\nval = cpu_to_le32(*(u32 *)a3700_spi->tx_buf);\r\nspireg_write(a3700_spi, A3700_SPI_DATA_OUT_REG, val);\r\na3700_spi->buf_len -= 4;\r\na3700_spi->tx_buf += 4;\r\n} else {\r\nval = GENMASK(31, 0);\r\nwhile (a3700_spi->buf_len) {\r\nval &= ~(0xff << (8 * i));\r\nval |= *a3700_spi->tx_buf++ << (8 * i);\r\ni++;\r\na3700_spi->buf_len--;\r\nspireg_write(a3700_spi, A3700_SPI_DATA_OUT_REG,\r\nval);\r\n}\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int a3700_is_rfifo_empty(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val = spireg_read(a3700_spi, A3700_SPI_IF_CTRL_REG);\r\nreturn (val & A3700_SPI_RFIFO_EMPTY);\r\n}\r\nstatic int a3700_spi_fifo_read(struct a3700_spi *a3700_spi)\r\n{\r\nu32 val;\r\nwhile (!a3700_is_rfifo_empty(a3700_spi) && a3700_spi->buf_len) {\r\nval = spireg_read(a3700_spi, A3700_SPI_DATA_IN_REG);\r\nif (a3700_spi->buf_len >= 4) {\r\nu32 data = le32_to_cpu(val);\r\nmemcpy(a3700_spi->rx_buf, &data, 4);\r\na3700_spi->buf_len -= 4;\r\na3700_spi->rx_buf += 4;\r\n} else {\r\nwhile (a3700_spi->buf_len) {\r\n*a3700_spi->rx_buf = val & 0xff;\r\nval >>= 8;\r\na3700_spi->buf_len--;\r\na3700_spi->rx_buf++;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void a3700_spi_transfer_abort_fifo(struct a3700_spi *a3700_spi)\r\n{\r\nint timeout = A3700_SPI_TIMEOUT;\r\nu32 val;\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= A3700_SPI_XFER_STOP;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\nwhile (--timeout) {\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nif (!(val & A3700_SPI_XFER_START))\r\nbreak;\r\nudelay(1);\r\n}\r\na3700_spi_fifo_flush(a3700_spi);\r\nval &= ~A3700_SPI_XFER_STOP;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nstatic int a3700_spi_prepare_message(struct spi_master *master,\r\nstruct spi_message *message)\r\n{\r\nstruct a3700_spi *a3700_spi = spi_master_get_devdata(master);\r\nstruct spi_device *spi = message->spi;\r\nint ret;\r\nret = clk_enable(a3700_spi->clk);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to enable clk with error %d\n", ret);\r\nreturn ret;\r\n}\r\nret = a3700_spi_fifo_flush(a3700_spi);\r\nif (ret)\r\nreturn ret;\r\na3700_spi_bytelen_set(a3700_spi, 4);\r\nreturn 0;\r\n}\r\nstatic int a3700_spi_transfer_one(struct spi_master *master,\r\nstruct spi_device *spi,\r\nstruct spi_transfer *xfer)\r\n{\r\nstruct a3700_spi *a3700_spi = spi_master_get_devdata(master);\r\nint ret = 0, timeout = A3700_SPI_TIMEOUT;\r\nunsigned int nbits = 0;\r\nu32 val;\r\na3700_spi_transfer_setup(spi, xfer);\r\na3700_spi->tx_buf = xfer->tx_buf;\r\na3700_spi->rx_buf = xfer->rx_buf;\r\na3700_spi->buf_len = xfer->len;\r\na3700_spi_header_set(a3700_spi);\r\nif (xfer->tx_buf)\r\nnbits = xfer->tx_nbits;\r\nelse if (xfer->rx_buf)\r\nnbits = xfer->rx_nbits;\r\na3700_spi_pin_mode_set(a3700_spi, nbits);\r\nif (xfer->rx_buf) {\r\nspireg_write(a3700_spi, A3700_SPI_IF_DIN_CNT_REG,\r\na3700_spi->buf_len);\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval &= ~A3700_SPI_RW_EN;\r\nval |= A3700_SPI_XFER_START;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n} else if (xfer->tx_buf) {\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= (A3700_SPI_XFER_START | A3700_SPI_RW_EN);\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\na3700_spi->xmit_data = (a3700_spi->buf_len != 0);\r\n}\r\nwhile (a3700_spi->buf_len) {\r\nif (a3700_spi->tx_buf) {\r\nif (!a3700_spi_transfer_wait(spi,\r\nA3700_SPI_WFIFO_RDY)) {\r\ndev_err(&spi->dev,\r\n"wait wfifo ready timed out\n");\r\nret = -ETIMEDOUT;\r\ngoto error;\r\n}\r\nret = a3700_spi_fifo_write(a3700_spi);\r\nif (ret)\r\ngoto error;\r\n} else if (a3700_spi->rx_buf) {\r\nif (!a3700_spi_transfer_wait(spi,\r\nA3700_SPI_RFIFO_RDY)) {\r\ndev_err(&spi->dev,\r\n"wait rfifo ready timed out\n");\r\nret = -ETIMEDOUT;\r\ngoto error;\r\n}\r\nret = a3700_spi_fifo_read(a3700_spi);\r\nif (ret)\r\ngoto error;\r\n}\r\n}\r\nif (a3700_spi->tx_buf) {\r\nif (a3700_spi->xmit_data) {\r\nif (!a3700_spi_transfer_wait(spi,\r\nA3700_SPI_WFIFO_EMPTY)) {\r\ndev_err(&spi->dev, "wait wfifo empty timed out\n");\r\nreturn -ETIMEDOUT;\r\n}\r\n} else {\r\nif (!a3700_spi_transfer_wait(spi, A3700_SPI_XFER_RDY)) {\r\ndev_err(&spi->dev, "wait xfer ready timed out\n");\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nval |= A3700_SPI_XFER_STOP;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\n}\r\nwhile (--timeout) {\r\nval = spireg_read(a3700_spi, A3700_SPI_IF_CFG_REG);\r\nif (!(val & A3700_SPI_XFER_START))\r\nbreak;\r\nudelay(1);\r\n}\r\nif (timeout == 0) {\r\ndev_err(&spi->dev, "wait transfer start clear timed out\n");\r\nret = -ETIMEDOUT;\r\ngoto error;\r\n}\r\nval &= ~A3700_SPI_XFER_STOP;\r\nspireg_write(a3700_spi, A3700_SPI_IF_CFG_REG, val);\r\ngoto out;\r\nerror:\r\na3700_spi_transfer_abort_fifo(a3700_spi);\r\nout:\r\nspi_finalize_current_transfer(master);\r\nreturn ret;\r\n}\r\nstatic int a3700_spi_unprepare_message(struct spi_master *master,\r\nstruct spi_message *message)\r\n{\r\nstruct a3700_spi *a3700_spi = spi_master_get_devdata(master);\r\nclk_disable(a3700_spi->clk);\r\nreturn 0;\r\n}\r\nstatic int a3700_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *of_node = dev->of_node;\r\nstruct resource *res;\r\nstruct spi_master *master;\r\nstruct a3700_spi *spi;\r\nu32 num_cs = 0;\r\nint irq, ret = 0;\r\nmaster = spi_alloc_master(dev, sizeof(*spi));\r\nif (!master) {\r\ndev_err(dev, "master allocation failed\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nif (of_property_read_u32(of_node, "num-cs", &num_cs)) {\r\ndev_err(dev, "could not find num-cs\n");\r\nret = -ENXIO;\r\ngoto error;\r\n}\r\nmaster->bus_num = pdev->id;\r\nmaster->dev.of_node = of_node;\r\nmaster->mode_bits = SPI_MODE_3;\r\nmaster->num_chipselect = num_cs;\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(8) | SPI_BPW_MASK(32);\r\nmaster->prepare_message = a3700_spi_prepare_message;\r\nmaster->transfer_one = a3700_spi_transfer_one;\r\nmaster->unprepare_message = a3700_spi_unprepare_message;\r\nmaster->set_cs = a3700_spi_set_cs;\r\nmaster->flags = SPI_MASTER_HALF_DUPLEX;\r\nmaster->mode_bits |= (SPI_RX_DUAL | SPI_TX_DUAL |\r\nSPI_RX_QUAD | SPI_TX_QUAD);\r\nplatform_set_drvdata(pdev, master);\r\nspi = spi_master_get_devdata(master);\r\nmemset(spi, 0, sizeof(struct a3700_spi));\r\nspi->master = master;\r\nspi->instr_cnt = A3700_INSTR_CNT;\r\nspi->addr_cnt = A3700_ADDR_CNT;\r\nspi->hdr_cnt = A3700_INSTR_CNT + A3700_ADDR_CNT +\r\nA3700_DUMMY_CNT;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nspi->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(spi->base)) {\r\nret = PTR_ERR(spi->base);\r\ngoto error;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "could not get irq: %d\n", irq);\r\nret = -ENXIO;\r\ngoto error;\r\n}\r\nspi->irq = irq;\r\ninit_completion(&spi->done);\r\nspi->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(spi->clk)) {\r\ndev_err(dev, "could not find clk: %ld\n", PTR_ERR(spi->clk));\r\ngoto error;\r\n}\r\nret = clk_prepare(spi->clk);\r\nif (ret) {\r\ndev_err(dev, "could not prepare clk: %d\n", ret);\r\ngoto error;\r\n}\r\nret = a3700_spi_init(spi);\r\nif (ret)\r\ngoto error_clk;\r\nret = devm_request_irq(dev, spi->irq, a3700_spi_interrupt, 0,\r\ndev_name(dev), master);\r\nif (ret) {\r\ndev_err(dev, "could not request IRQ: %d\n", ret);\r\ngoto error_clk;\r\n}\r\nret = devm_spi_register_master(dev, master);\r\nif (ret) {\r\ndev_err(dev, "Failed to register master\n");\r\ngoto error_clk;\r\n}\r\nreturn 0;\r\nerror_clk:\r\nclk_disable_unprepare(spi->clk);\r\nerror:\r\nspi_master_put(master);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int a3700_spi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct a3700_spi *spi = spi_master_get_devdata(master);\r\nclk_unprepare(spi->clk);\r\nreturn 0;\r\n}

static int cm3232_reg_init(struct cm3232_chip *chip)\r\n{\r\nstruct i2c_client *client = chip->client;\r\ns32 ret;\r\nchip->als_info = &cm3232_als_info_default;\r\nret = i2c_smbus_read_word_data(client, CM3232_REG_ADDR_ID);\r\nif (ret < 0) {\r\ndev_err(&chip->client->dev, "Error reading addr_id\n");\r\nreturn ret;\r\n}\r\nif ((ret & 0xFF) != chip->als_info->hw_id)\r\nreturn -ENODEV;\r\nchip->regs_cmd = CM3232_CMD_ALS_DISABLE | CM3232_CMD_ALS_RESET;\r\nret = i2c_smbus_write_byte_data(client, CM3232_REG_ADDR_CMD,\r\nchip->regs_cmd);\r\nif (ret < 0) {\r\ndev_err(&chip->client->dev, "Error writing reg_cmd\n");\r\nreturn ret;\r\n}\r\nchip->regs_cmd = chip->als_info->regs_cmd_default;\r\nret = i2c_smbus_write_byte_data(client, CM3232_REG_ADDR_CMD,\r\nchip->regs_cmd);\r\nif (ret < 0)\r\ndev_err(&chip->client->dev, "Error writing reg_cmd\n");\r\nreturn ret;\r\n}\r\nstatic int cm3232_read_als_it(struct cm3232_chip *chip, int *val, int *val2)\r\n{\r\nu16 als_it;\r\nint i;\r\nals_it = chip->regs_cmd;\r\nals_it &= CM3232_CMD_ALS_IT_MASK;\r\nals_it >>= CM3232_CMD_ALS_IT_SHIFT;\r\nfor (i = 0; i < ARRAY_SIZE(cm3232_als_it_scales); i++) {\r\nif (als_it == cm3232_als_it_scales[i].it) {\r\n*val = cm3232_als_it_scales[i].val;\r\n*val2 = cm3232_als_it_scales[i].val2;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int cm3232_write_als_it(struct cm3232_chip *chip, int val, int val2)\r\n{\r\nstruct i2c_client *client = chip->client;\r\nu16 als_it, cmd;\r\nint i;\r\ns32 ret;\r\nfor (i = 0; i < ARRAY_SIZE(cm3232_als_it_scales); i++) {\r\nif (val == cm3232_als_it_scales[i].val &&\r\nval2 == cm3232_als_it_scales[i].val2) {\r\nals_it = cm3232_als_it_scales[i].it;\r\nals_it <<= CM3232_CMD_ALS_IT_SHIFT;\r\ncmd = chip->regs_cmd & ~CM3232_CMD_ALS_IT_MASK;\r\ncmd |= als_it;\r\nret = i2c_smbus_write_byte_data(client,\r\nCM3232_REG_ADDR_CMD,\r\ncmd);\r\nif (ret < 0)\r\nreturn ret;\r\nchip->regs_cmd = cmd;\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int cm3232_get_lux(struct cm3232_chip *chip)\r\n{\r\nstruct i2c_client *client = chip->client;\r\nstruct cm3232_als_info *als_info = chip->als_info;\r\nint ret;\r\nint val, val2;\r\nint als_it;\r\nu64 lux;\r\nret = cm3232_read_als_it(chip, &val, &val2);\r\nif (ret < 0)\r\nreturn -EINVAL;\r\nals_it = val * 1000000 + val2;\r\nlux = (__force u64)als_info->mlux_per_bit;\r\nlux *= als_info->mlux_per_bit_base_it;\r\nlux = div_u64(lux, als_it);\r\nret = i2c_smbus_read_word_data(client, CM3232_REG_ADDR_ALS);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Error reading reg_addr_als\n");\r\nreturn ret;\r\n}\r\nchip->regs_als = (u16)ret;\r\nlux *= chip->regs_als;\r\nlux *= als_info->calibscale;\r\nlux = div_u64(lux, CM3232_CALIBSCALE_RESOLUTION);\r\nlux = div_u64(lux, CM3232_MLUX_PER_LUX);\r\nif (lux > 0xFFFF)\r\nlux = 0xFFFF;\r\nreturn (int)lux;\r\n}\r\nstatic int cm3232_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct cm3232_chip *chip = iio_priv(indio_dev);\r\nstruct cm3232_als_info *als_info = chip->als_info;\r\nint ret;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_PROCESSED:\r\nret = cm3232_get_lux(chip);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = ret;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\n*val = als_info->calibscale;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_INT_TIME:\r\nreturn cm3232_read_als_it(chip, val, val2);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int cm3232_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val, int val2, long mask)\r\n{\r\nstruct cm3232_chip *chip = iio_priv(indio_dev);\r\nstruct cm3232_als_info *als_info = chip->als_info;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\nals_info->calibscale = val;\r\nreturn 0;\r\ncase IIO_CHAN_INFO_INT_TIME:\r\nreturn cm3232_write_als_it(chip, val, val2);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t cm3232_get_it_available(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint i, len;\r\nfor (i = 0, len = 0; i < ARRAY_SIZE(cm3232_als_it_scales); i++)\r\nlen += scnprintf(buf + len, PAGE_SIZE - len, "%u.%06u ",\r\ncm3232_als_it_scales[i].val,\r\ncm3232_als_it_scales[i].val2);\r\nreturn len + scnprintf(buf + len, PAGE_SIZE - len, "\n");\r\n}\r\nstatic int cm3232_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct cm3232_chip *chip;\r\nstruct iio_dev *indio_dev;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*chip));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nchip = iio_priv(indio_dev);\r\ni2c_set_clientdata(client, indio_dev);\r\nchip->client = client;\r\nindio_dev->dev.parent = &client->dev;\r\nindio_dev->channels = cm3232_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(cm3232_channels);\r\nindio_dev->info = &cm3232_info;\r\nindio_dev->name = id->name;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = cm3232_reg_init(chip);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"%s: register init failed\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nreturn iio_device_register(indio_dev);\r\n}\r\nstatic int cm3232_remove(struct i2c_client *client)\r\n{\r\nstruct iio_dev *indio_dev = i2c_get_clientdata(client);\r\ni2c_smbus_write_byte_data(client, CM3232_REG_ADDR_CMD,\r\nCM3232_CMD_ALS_DISABLE);\r\niio_device_unregister(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int cm3232_suspend(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = i2c_get_clientdata(to_i2c_client(dev));\r\nstruct cm3232_chip *chip = iio_priv(indio_dev);\r\nstruct i2c_client *client = chip->client;\r\nint ret;\r\nchip->regs_cmd |= CM3232_CMD_ALS_DISABLE;\r\nret = i2c_smbus_write_byte_data(client, CM3232_REG_ADDR_CMD,\r\nchip->regs_cmd);\r\nreturn ret;\r\n}\r\nstatic int cm3232_resume(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = i2c_get_clientdata(to_i2c_client(dev));\r\nstruct cm3232_chip *chip = iio_priv(indio_dev);\r\nstruct i2c_client *client = chip->client;\r\nint ret;\r\nchip->regs_cmd &= ~CM3232_CMD_ALS_DISABLE;\r\nret = i2c_smbus_write_byte_data(client, CM3232_REG_ADDR_CMD,\r\nchip->regs_cmd | CM3232_CMD_ALS_RESET);\r\nreturn ret;\r\n}

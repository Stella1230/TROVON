static int generic_set_mode(struct ata_link *link, struct ata_device **unused)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nconst struct pci_device_id *id = ap->host->private_data;\r\nint dma_enabled = 0;\r\nstruct ata_device *dev;\r\nif (id->driver_data & ATA_GEN_FORCE_DMA) {\r\ndma_enabled = 0xff;\r\n} else if (ap->ioaddr.bmdma_addr) {\r\ndma_enabled = ioread8(ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\n}\r\nata_for_each_dev(dev, link, ENABLED) {\r\ndev->pio_mode = XFER_PIO_0;\r\ndev->dma_mode = XFER_MW_DMA_0;\r\nif (dma_enabled & (1 << (5 + dev->devno))) {\r\nunsigned int xfer_mask = ata_id_xfermask(dev->id);\r\nconst char *name;\r\nif (xfer_mask & (ATA_MASK_MWDMA | ATA_MASK_UDMA))\r\nname = ata_mode_string(xfer_mask);\r\nelse {\r\nname = "DMA";\r\nxfer_mask |= ata_xfer_mode2mask(XFER_MW_DMA_0);\r\n}\r\nata_dev_info(dev, "configured for %s\n", name);\r\ndev->xfer_mode = ata_xfer_mask2mode(xfer_mask);\r\ndev->xfer_shift = ata_xfer_mode2shift(dev->xfer_mode);\r\ndev->flags &= ~ATA_DFLAG_PIO;\r\n} else {\r\nata_dev_info(dev, "configured for PIO\n");\r\ndev->xfer_mode = XFER_PIO_0;\r\ndev->xfer_shift = ATA_SHIFT_PIO;\r\ndev->flags |= ATA_DFLAG_PIO;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int is_intel_ider(struct pci_dev *dev)\r\n{\r\nu32 r;\r\nu16 t;\r\npci_read_config_dword(dev, 0xF8, &r);\r\nif (r != 0)\r\nreturn 0;\r\npci_read_config_word(dev, 0x40, &t);\r\nif (t != 0)\r\nreturn 0;\r\npci_write_config_word(dev, 0x40, 1);\r\npci_read_config_word(dev, 0x40, &t);\r\nif (t) {\r\npci_write_config_word(dev, 0x40, 0);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ata_generic_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nu16 command;\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA5,\r\n.port_ops = &generic_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nif ((id->driver_data & ATA_GEN_CLASS_MATCH) && all_generic_ide == 0)\r\nreturn -ENODEV;\r\nif ((id->driver_data & ATA_GEN_INTEL_IDER) && !all_generic_ide)\r\nif (!is_intel_ider(dev))\r\nreturn -ENODEV;\r\nif (dev->vendor == PCI_VENDOR_ID_UMC &&\r\ndev->device == PCI_DEVICE_ID_UMC_UM8886A &&\r\n(!(PCI_FUNC(dev->devfn) & 1)))\r\nreturn -ENODEV;\r\nif (dev->vendor == PCI_VENDOR_ID_OPTI &&\r\ndev->device == PCI_DEVICE_ID_OPTI_82C558 &&\r\n(!(PCI_FUNC(dev->devfn) & 1)))\r\nreturn -ENODEV;\r\npci_read_config_word(dev, PCI_COMMAND, &command);\r\nif (!(command & PCI_COMMAND_IO))\r\nreturn -ENODEV;\r\nif (dev->vendor == PCI_VENDOR_ID_AL)\r\nata_pci_bmdma_clear_simplex(dev);\r\nif (dev->vendor == PCI_VENDOR_ID_ATI) {\r\nint rc = pcim_enable_device(dev);\r\nif (rc < 0)\r\nreturn rc;\r\npcim_pin_device(dev);\r\n}\r\nreturn ata_pci_bmdma_init_one(dev, ppi, &generic_sht, (void *)id, 0);\r\n}

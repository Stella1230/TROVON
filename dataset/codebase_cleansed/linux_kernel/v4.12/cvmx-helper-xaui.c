int __cvmx_helper_xaui_enumerate(int interface)\r\n{\r\nunion cvmx_gmxx_hg2_control gmx_hg2_control;\r\ngmx_hg2_control.u64 = cvmx_read_csr(CVMX_GMXX_HG2_CONTROL(interface));\r\nif (gmx_hg2_control.s.hg2tx_en)\r\nreturn 16;\r\nelse\r\nreturn 1;\r\n}\r\nint __cvmx_helper_xaui_probe(int interface)\r\n{\r\nint i;\r\nunion cvmx_gmxx_inf_mode mode;\r\nmode.u64 = cvmx_read_csr(CVMX_GMXX_INF_MODE(interface));\r\nmode.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_INF_MODE(interface), mode.u64);\r\n__cvmx_helper_setup_gmx(interface, 1);\r\nfor (i = 0; i < 16; i++) {\r\nunion cvmx_pko_mem_port_ptrs pko_mem_port_ptrs;\r\npko_mem_port_ptrs.u64 = 0;\r\npko_mem_port_ptrs.s.static_p = 0;\r\npko_mem_port_ptrs.s.qos_mask = 0xff;\r\npko_mem_port_ptrs.s.eid = interface * 4;\r\npko_mem_port_ptrs.s.pid = interface * 16 + i;\r\ncvmx_write_csr(CVMX_PKO_MEM_PORT_PTRS, pko_mem_port_ptrs.u64);\r\n}\r\nreturn __cvmx_helper_xaui_enumerate(interface);\r\n}\r\nint __cvmx_helper_xaui_enable(int interface)\r\n{\r\nunion cvmx_gmxx_prtx_cfg gmx_cfg;\r\nunion cvmx_pcsxx_control1_reg xauiCtl;\r\nunion cvmx_pcsxx_misc_ctl_reg xauiMiscCtl;\r\nunion cvmx_gmxx_tx_xaui_ctl gmxXauiTxCtl;\r\nunion cvmx_gmxx_rxx_int_en gmx_rx_int_en;\r\nunion cvmx_gmxx_tx_int_en gmx_tx_int_en;\r\nunion cvmx_pcsxx_int_en_reg pcsx_int_en_reg;\r\nif (octeon_has_feature(OCTEON_FEATURE_PKND)) {\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(0, interface));\r\ngmx_cfg.s.pknd = cvmx_helper_get_ipd_port(interface, 0);\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(0, interface), gmx_cfg.u64);\r\n}\r\nxauiMiscCtl.u64 = cvmx_read_csr(CVMX_PCSXX_MISC_CTL_REG(interface));\r\nxauiMiscCtl.s.gmxeno = 1;\r\ncvmx_write_csr(CVMX_PCSXX_MISC_CTL_REG(interface), xauiMiscCtl.u64);\r\ngmx_rx_int_en.u64 = cvmx_read_csr(CVMX_GMXX_RXX_INT_EN(0, interface));\r\ncvmx_write_csr(CVMX_GMXX_RXX_INT_EN(0, interface), 0x0);\r\ngmx_tx_int_en.u64 = cvmx_read_csr(CVMX_GMXX_TX_INT_EN(interface));\r\ncvmx_write_csr(CVMX_GMXX_TX_INT_EN(interface), 0x0);\r\npcsx_int_en_reg.u64 = cvmx_read_csr(CVMX_PCSXX_INT_EN_REG(interface));\r\ncvmx_write_csr(CVMX_PCSXX_INT_EN_REG(interface), 0x0);\r\ngmxXauiTxCtl.u64 = cvmx_read_csr(CVMX_GMXX_TX_XAUI_CTL(interface));\r\ngmxXauiTxCtl.s.dic_en = 1;\r\ngmxXauiTxCtl.s.uni_en = 0;\r\ncvmx_write_csr(CVMX_GMXX_TX_XAUI_CTL(interface), gmxXauiTxCtl.u64);\r\nxauiCtl.u64 = cvmx_read_csr(CVMX_PCSXX_CONTROL1_REG(interface));\r\nxauiCtl.s.lo_pwr = 0;\r\nif (!OCTEON_IS_MODEL(OCTEON_CN68XX_PASS1_X) &&\r\n!OCTEON_IS_MODEL(OCTEON_CN68XX_PASS2_X))\r\nxauiCtl.s.reset = 1;\r\ncvmx_write_csr(CVMX_PCSXX_CONTROL1_REG(interface), xauiCtl.u64);\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSXX_CONTROL1_REG(interface), union cvmx_pcsxx_control1_reg,\r\nreset, ==, 0, 10000))\r\nreturn -1;\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSXX_10GBX_STATUS_REG(interface),\r\nunion cvmx_pcsxx_10gbx_status_reg, alignd, ==, 1, 10000))\r\nreturn -1;\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_GMXX_RX_XAUI_CTL(interface), union cvmx_gmxx_rx_xaui_ctl,\r\nstatus, ==, 0, 10000))\r\nreturn -1;\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(0, interface));\r\ngmx_cfg.s.en = 0;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(0, interface), gmx_cfg.u64);\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_GMXX_PRTX_CFG(0, interface), union cvmx_gmxx_prtx_cfg,\r\nrx_idle, ==, 1, 10000))\r\nreturn -1;\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_GMXX_PRTX_CFG(0, interface), union cvmx_gmxx_prtx_cfg,\r\ntx_idle, ==, 1, 10000))\r\nreturn -1;\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(0, interface));\r\ngmx_cfg.s.speed = 1;\r\ngmx_cfg.s.speed_msb = 0;\r\ngmx_cfg.s.slottime = 1;\r\ncvmx_write_csr(CVMX_GMXX_TX_PRTS(interface), 1);\r\ncvmx_write_csr(CVMX_GMXX_TXX_SLOT(0, interface), 512);\r\ncvmx_write_csr(CVMX_GMXX_TXX_BURST(0, interface), 8192);\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(0, interface), gmx_cfg.u64);\r\ncvmx_write_csr(CVMX_GMXX_RXX_INT_REG(0, interface),\r\ncvmx_read_csr(CVMX_GMXX_RXX_INT_REG(0, interface)));\r\ncvmx_write_csr(CVMX_GMXX_TX_INT_REG(interface),\r\ncvmx_read_csr(CVMX_GMXX_TX_INT_REG(interface)));\r\ncvmx_write_csr(CVMX_PCSXX_INT_REG(interface),\r\ncvmx_read_csr(CVMX_PCSXX_INT_REG(interface)));\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSXX_STATUS1_REG(interface), union cvmx_pcsxx_status1_reg,\r\nrcv_lnk, ==, 1, 10000))\r\nreturn -1;\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSXX_STATUS2_REG(interface), union cvmx_pcsxx_status2_reg,\r\nxmtflt, ==, 0, 10000))\r\nreturn -1;\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSXX_STATUS2_REG(interface), union cvmx_pcsxx_status2_reg,\r\nrcvflt, ==, 0, 10000))\r\nreturn -1;\r\ncvmx_write_csr(CVMX_GMXX_RXX_INT_EN(0, interface), gmx_rx_int_en.u64);\r\ncvmx_write_csr(CVMX_GMXX_TX_INT_EN(interface), gmx_tx_int_en.u64);\r\ncvmx_write_csr(CVMX_PCSXX_INT_EN_REG(interface), pcsx_int_en_reg.u64);\r\nxauiMiscCtl.s.gmxeno = 0;\r\ncvmx_write_csr(CVMX_PCSXX_MISC_CTL_REG(interface), xauiMiscCtl.u64);\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(0, interface));\r\ngmx_cfg.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(0, interface), gmx_cfg.u64);\r\n__cvmx_interrupt_pcsx_intx_en_reg_enable(0, interface);\r\n__cvmx_interrupt_pcsx_intx_en_reg_enable(1, interface);\r\n__cvmx_interrupt_pcsx_intx_en_reg_enable(2, interface);\r\n__cvmx_interrupt_pcsx_intx_en_reg_enable(3, interface);\r\n__cvmx_interrupt_pcsxx_int_en_reg_enable(interface);\r\n__cvmx_interrupt_gmxx_enable(interface);\r\nreturn 0;\r\n}\r\ncvmx_helper_link_info_t __cvmx_helper_xaui_link_get(int ipd_port)\r\n{\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nunion cvmx_gmxx_tx_xaui_ctl gmxx_tx_xaui_ctl;\r\nunion cvmx_gmxx_rx_xaui_ctl gmxx_rx_xaui_ctl;\r\nunion cvmx_pcsxx_status1_reg pcsxx_status1_reg;\r\ncvmx_helper_link_info_t result;\r\ngmxx_tx_xaui_ctl.u64 = cvmx_read_csr(CVMX_GMXX_TX_XAUI_CTL(interface));\r\ngmxx_rx_xaui_ctl.u64 = cvmx_read_csr(CVMX_GMXX_RX_XAUI_CTL(interface));\r\npcsxx_status1_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSXX_STATUS1_REG(interface));\r\nresult.u64 = 0;\r\nif ((gmxx_tx_xaui_ctl.s.ls == 0) && (gmxx_rx_xaui_ctl.s.status == 0) &&\r\n(pcsxx_status1_reg.s.rcv_lnk == 1)) {\r\nresult.s.link_up = 1;\r\nresult.s.full_duplex = 1;\r\nresult.s.speed = 10000;\r\n} else {\r\ncvmx_write_csr(CVMX_GMXX_RXX_INT_EN(0, interface), 0x0);\r\ncvmx_write_csr(CVMX_GMXX_TX_INT_EN(interface), 0x0);\r\ncvmx_write_csr(CVMX_PCSXX_INT_EN_REG(interface), 0x0);\r\n}\r\nreturn result;\r\n}\r\nint __cvmx_helper_xaui_link_set(int ipd_port, cvmx_helper_link_info_t link_info)\r\n{\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nunion cvmx_gmxx_tx_xaui_ctl gmxx_tx_xaui_ctl;\r\nunion cvmx_gmxx_rx_xaui_ctl gmxx_rx_xaui_ctl;\r\ngmxx_tx_xaui_ctl.u64 = cvmx_read_csr(CVMX_GMXX_TX_XAUI_CTL(interface));\r\ngmxx_rx_xaui_ctl.u64 = cvmx_read_csr(CVMX_GMXX_RX_XAUI_CTL(interface));\r\nif (!link_info.s.link_up)\r\nreturn 0;\r\nif ((gmxx_tx_xaui_ctl.s.ls == 0) && (gmxx_rx_xaui_ctl.s.status == 0))\r\nreturn 0;\r\nreturn __cvmx_helper_xaui_enable(interface);\r\n}\r\nextern int __cvmx_helper_xaui_configure_loopback(int ipd_port,\r\nint enable_internal,\r\nint enable_external)\r\n{\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nunion cvmx_pcsxx_control1_reg pcsxx_control1_reg;\r\nunion cvmx_gmxx_xaui_ext_loopback gmxx_xaui_ext_loopback;\r\npcsxx_control1_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSXX_CONTROL1_REG(interface));\r\npcsxx_control1_reg.s.loopbck1 = enable_internal;\r\ncvmx_write_csr(CVMX_PCSXX_CONTROL1_REG(interface),\r\npcsxx_control1_reg.u64);\r\ngmxx_xaui_ext_loopback.u64 =\r\ncvmx_read_csr(CVMX_GMXX_XAUI_EXT_LOOPBACK(interface));\r\ngmxx_xaui_ext_loopback.s.en = enable_external;\r\ncvmx_write_csr(CVMX_GMXX_XAUI_EXT_LOOPBACK(interface),\r\ngmxx_xaui_ext_loopback.u64);\r\nreturn __cvmx_helper_xaui_enable(interface);\r\n}

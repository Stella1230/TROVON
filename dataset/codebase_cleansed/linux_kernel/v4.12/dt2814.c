static int dt2814_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + DT2814_CSR);\r\nif (status & DT2814_FINISH)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int dt2814_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, hi, lo;\r\nint chan;\r\nint ret;\r\nfor (n = 0; n < insn->n; n++) {\r\nchan = CR_CHAN(insn->chanspec);\r\noutb(chan, dev->iobase + DT2814_CSR);\r\nret = comedi_timeout(dev, s, insn, dt2814_ai_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\nhi = inb(dev->iobase + DT2814_DATA);\r\nlo = inb(dev->iobase + DT2814_DATA);\r\ndata[n] = (hi << 4) | (lo >> 4);\r\n}\r\nreturn n;\r\n}\r\nstatic int dt2814_ns_to_timer(unsigned int *ns, unsigned int flags)\r\n{\r\nint i;\r\nunsigned int f;\r\nf = 10000;\r\nfor (i = 0; i < 8; i++) {\r\nif ((2 * (*ns)) < (f * 11))\r\nbreak;\r\nf *= 10;\r\n}\r\n*ns = f;\r\nreturn i;\r\n}\r\nstatic int dt2814_ai_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nunsigned int arg;\r\nerr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\r\nerr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_TIMER);\r\nerr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_NOW);\r\nerr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\r\nerr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_COUNT | TRIG_NONE);\r\nif (err)\r\nreturn 1;\r\nerr |= comedi_check_trigger_is_unique(cmd->stop_src);\r\nif (err)\r\nreturn 2;\r\nerr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\r\nerr |= comedi_check_trigger_arg_max(&cmd->scan_begin_arg, 1000000000);\r\nerr |= comedi_check_trigger_arg_min(&cmd->scan_begin_arg,\r\nDT2814_MAX_SPEED);\r\nerr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\r\ncmd->chanlist_len);\r\nif (cmd->stop_src == TRIG_COUNT)\r\nerr |= comedi_check_trigger_arg_min(&cmd->stop_arg, 2);\r\nelse\r\nerr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\r\nif (err)\r\nreturn 3;\r\narg = cmd->scan_begin_arg;\r\ndt2814_ns_to_timer(&arg, cmd->flags);\r\nerr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, arg);\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int dt2814_ai_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nstruct dt2814_private *devpriv = dev->private;\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nint chan;\r\nint trigvar;\r\ntrigvar = dt2814_ns_to_timer(&cmd->scan_begin_arg, cmd->flags);\r\nchan = CR_CHAN(cmd->chanlist[0]);\r\ndevpriv->ntrig = cmd->stop_arg;\r\noutb(chan | DT2814_ENB | (trigvar << 5), dev->iobase + DT2814_CSR);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t dt2814_interrupt(int irq, void *d)\r\n{\r\nint lo, hi;\r\nstruct comedi_device *dev = d;\r\nstruct dt2814_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s = dev->read_subdev;\r\nint data;\r\nif (!dev->attached) {\r\ndev_err(dev->class_dev, "spurious interrupt\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nhi = inb(dev->iobase + DT2814_DATA);\r\nlo = inb(dev->iobase + DT2814_DATA);\r\ndata = (hi << 4) | (lo >> 4);\r\nif (!(--devpriv->ntrig)) {\r\nint i;\r\noutb(0, dev->iobase + DT2814_CSR);\r\nfor (i = 0; i < DT2814_TIMEOUT; i++) {\r\nif (inb(dev->iobase + DT2814_CSR) & DT2814_FINISH)\r\nbreak;\r\n}\r\ninb(dev->iobase + DT2814_DATA);\r\ninb(dev->iobase + DT2814_DATA);\r\ns->async->events |= COMEDI_CB_EOA;\r\n}\r\ncomedi_handle_events(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int dt2814_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct dt2814_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nint i;\r\nret = comedi_request_region(dev, it->options[0], 0x2);\r\nif (ret)\r\nreturn ret;\r\noutb(0, dev->iobase + DT2814_CSR);\r\nusleep_range(100, 200);\r\nif (inb(dev->iobase + DT2814_CSR) & DT2814_ERR) {\r\ndev_err(dev->class_dev, "reset error (fatal)\n");\r\nreturn -EIO;\r\n}\r\ni = inb(dev->iobase + DT2814_DATA);\r\ni = inb(dev->iobase + DT2814_DATA);\r\nif (it->options[1]) {\r\nret = request_irq(it->options[1], dt2814_interrupt, 0,\r\ndev->board_name, dev);\r\nif (ret == 0)\r\ndev->irq = it->options[1];\r\n}\r\nret = comedi_alloc_subdevices(dev, 1);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 16;\r\ns->insn_read = dt2814_ai_insn_read;\r\ns->maxdata = 0xfff;\r\ns->range_table = &range_unknown;\r\nif (dev->irq) {\r\ndev->read_subdev = s;\r\ns->subdev_flags |= SDF_CMD_READ;\r\ns->len_chanlist = 1;\r\ns->do_cmd = dt2814_ai_cmd;\r\ns->do_cmdtest = dt2814_ai_cmdtest;\r\n}\r\nreturn 0;\r\n}

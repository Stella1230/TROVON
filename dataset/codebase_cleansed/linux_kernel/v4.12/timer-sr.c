void __hyp_text __timer_save_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct arch_timer_cpu *timer = &vcpu->arch.timer_cpu;\r\nstruct arch_timer_context *vtimer = vcpu_vtimer(vcpu);\r\nu64 val;\r\nif (timer->enabled) {\r\nvtimer->cnt_ctl = read_sysreg_el0(cntv_ctl);\r\nvtimer->cnt_cval = read_sysreg_el0(cntv_cval);\r\n}\r\nwrite_sysreg_el0(0, cntv_ctl);\r\nif (!has_vhe()) {\r\nval = read_sysreg(cnthctl_el2);\r\nval |= CNTHCTL_EL1PCTEN | CNTHCTL_EL1PCEN;\r\nwrite_sysreg(val, cnthctl_el2);\r\n}\r\nwrite_sysreg(0, cntvoff_el2);\r\n}\r\nvoid __hyp_text __timer_restore_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct arch_timer_cpu *timer = &vcpu->arch.timer_cpu;\r\nstruct arch_timer_context *vtimer = vcpu_vtimer(vcpu);\r\nu64 val;\r\nif (!has_vhe()) {\r\nval = read_sysreg(cnthctl_el2);\r\nval &= ~CNTHCTL_EL1PCEN;\r\nval |= CNTHCTL_EL1PCTEN;\r\nwrite_sysreg(val, cnthctl_el2);\r\n}\r\nif (timer->enabled) {\r\nwrite_sysreg(vtimer->cntvoff, cntvoff_el2);\r\nwrite_sysreg_el0(vtimer->cnt_cval, cntv_cval);\r\nisb();\r\nwrite_sysreg_el0(vtimer->cnt_ctl, cntv_ctl);\r\n}\r\n}

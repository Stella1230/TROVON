static int orion_wdt_clock_init(struct platform_device *pdev,\r\nstruct orion_watchdog *dev)\r\n{\r\nint ret;\r\ndev->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dev->clk))\r\nreturn PTR_ERR(dev->clk);\r\nret = clk_prepare_enable(dev->clk);\r\nif (ret) {\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\ndev->clk_rate = clk_get_rate(dev->clk);\r\nreturn 0;\r\n}\r\nstatic int armada370_wdt_clock_init(struct platform_device *pdev,\r\nstruct orion_watchdog *dev)\r\n{\r\nint ret;\r\ndev->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dev->clk))\r\nreturn PTR_ERR(dev->clk);\r\nret = clk_prepare_enable(dev->clk);\r\nif (ret) {\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\natomic_io_modify(dev->reg + TIMER_CTRL,\r\nWDT_A370_RATIO_MASK(WDT_A370_RATIO_SHIFT),\r\nWDT_A370_RATIO_MASK(WDT_A370_RATIO_SHIFT));\r\ndev->clk_rate = clk_get_rate(dev->clk) / WDT_A370_RATIO;\r\nreturn 0;\r\n}\r\nstatic int armada375_wdt_clock_init(struct platform_device *pdev,\r\nstruct orion_watchdog *dev)\r\n{\r\nint ret;\r\ndev->clk = of_clk_get_by_name(pdev->dev.of_node, "fixed");\r\nif (!IS_ERR(dev->clk)) {\r\nret = clk_prepare_enable(dev->clk);\r\nif (ret) {\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\natomic_io_modify(dev->reg + TIMER_CTRL,\r\nWDT_AXP_FIXED_ENABLE_BIT,\r\nWDT_AXP_FIXED_ENABLE_BIT);\r\ndev->clk_rate = clk_get_rate(dev->clk);\r\nreturn 0;\r\n}\r\ndev->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dev->clk))\r\nreturn PTR_ERR(dev->clk);\r\nret = clk_prepare_enable(dev->clk);\r\nif (ret) {\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\natomic_io_modify(dev->reg + TIMER_CTRL,\r\nWDT_A370_RATIO_MASK(WDT_A370_RATIO_SHIFT),\r\nWDT_A370_RATIO_MASK(WDT_A370_RATIO_SHIFT));\r\ndev->clk_rate = clk_get_rate(dev->clk) / WDT_A370_RATIO;\r\nreturn 0;\r\n}\r\nstatic int armadaxp_wdt_clock_init(struct platform_device *pdev,\r\nstruct orion_watchdog *dev)\r\n{\r\nint ret;\r\ndev->clk = of_clk_get_by_name(pdev->dev.of_node, "fixed");\r\nif (IS_ERR(dev->clk))\r\nreturn PTR_ERR(dev->clk);\r\nret = clk_prepare_enable(dev->clk);\r\nif (ret) {\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\natomic_io_modify(dev->reg + TIMER_CTRL,\r\nWDT_AXP_FIXED_ENABLE_BIT,\r\nWDT_AXP_FIXED_ENABLE_BIT);\r\ndev->clk_rate = clk_get_rate(dev->clk);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nwritel(dev->clk_rate * wdt_dev->timeout,\r\ndev->reg + dev->data->wdt_counter_offset);\r\nreturn 0;\r\n}\r\nstatic int armada375_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nwritel(dev->clk_rate * wdt_dev->timeout,\r\ndev->reg + dev->data->wdt_counter_offset);\r\natomic_io_modify(dev->reg + TIMER_A370_STATUS, WDT_A370_EXPIRED, 0);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit,\r\ndev->data->wdt_enable_bit);\r\nreg = readl(dev->rstout);\r\nreg |= dev->data->rstout_enable_bit;\r\nwritel(reg, dev->rstout);\r\natomic_io_modify(dev->rstout_mask, dev->data->rstout_mask_bit, 0);\r\nreturn 0;\r\n}\r\nstatic int armada370_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nwritel(dev->clk_rate * wdt_dev->timeout,\r\ndev->reg + dev->data->wdt_counter_offset);\r\natomic_io_modify(dev->reg + TIMER_A370_STATUS, WDT_A370_EXPIRED, 0);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit,\r\ndev->data->wdt_enable_bit);\r\nreg = readl(dev->rstout);\r\nreg |= dev->data->rstout_enable_bit;\r\nwritel(reg, dev->rstout);\r\nreturn 0;\r\n}\r\nstatic int orion_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nwritel(dev->clk_rate * wdt_dev->timeout,\r\ndev->reg + dev->data->wdt_counter_offset);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit,\r\ndev->data->wdt_enable_bit);\r\natomic_io_modify(dev->rstout, dev->data->rstout_enable_bit,\r\ndev->data->rstout_enable_bit);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nreturn dev->data->start(wdt_dev);\r\n}\r\nstatic int orion_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\natomic_io_modify(dev->rstout, dev->data->rstout_enable_bit, 0);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit, 0);\r\nreturn 0;\r\n}\r\nstatic int armada375_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\natomic_io_modify(dev->rstout_mask, dev->data->rstout_mask_bit,\r\ndev->data->rstout_mask_bit);\r\nreg = readl(dev->rstout);\r\nreg &= ~dev->data->rstout_enable_bit;\r\nwritel(reg, dev->rstout);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit, 0);\r\nreturn 0;\r\n}\r\nstatic int armada370_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nreg = readl(dev->rstout);\r\nreg &= ~dev->data->rstout_enable_bit;\r\nwritel(reg, dev->rstout);\r\natomic_io_modify(dev->reg + TIMER_CTRL, dev->data->wdt_enable_bit, 0);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nreturn dev->data->stop(wdt_dev);\r\n}\r\nstatic int orion_enabled(struct orion_watchdog *dev)\r\n{\r\nbool enabled, running;\r\nenabled = readl(dev->rstout) & dev->data->rstout_enable_bit;\r\nrunning = readl(dev->reg + TIMER_CTRL) & dev->data->wdt_enable_bit;\r\nreturn enabled && running;\r\n}\r\nstatic int armada375_enabled(struct orion_watchdog *dev)\r\n{\r\nbool masked, enabled, running;\r\nmasked = readl(dev->rstout_mask) & dev->data->rstout_mask_bit;\r\nenabled = readl(dev->rstout) & dev->data->rstout_enable_bit;\r\nrunning = readl(dev->reg + TIMER_CTRL) & dev->data->wdt_enable_bit;\r\nreturn !masked && enabled && running;\r\n}\r\nstatic int orion_wdt_enabled(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nreturn dev->data->enabled(dev);\r\n}\r\nstatic unsigned int orion_wdt_get_timeleft(struct watchdog_device *wdt_dev)\r\n{\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nreturn readl(dev->reg + dev->data->wdt_counter_offset) / dev->clk_rate;\r\n}\r\nstatic int orion_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nwdt_dev->timeout = timeout;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t orion_wdt_irq(int irq, void *devid)\r\n{\r\npanic("Watchdog Timeout");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __iomem *orion_wdt_ioremap_rstout(struct platform_device *pdev,\r\nphys_addr_t internal_regs)\r\n{\r\nstruct resource *res;\r\nphys_addr_t rstout;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (res)\r\nreturn devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nrstout = internal_regs + ORION_RSTOUT_MASK_OFFSET;\r\nWARN(1, FW_BUG "falling back to hardcoded RSTOUT reg %pa\n", &rstout);\r\nreturn devm_ioremap(&pdev->dev, rstout, 0x4);\r\n}\r\nstatic int orion_wdt_get_regs(struct platform_device *pdev,\r\nstruct orion_watchdog *dev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ndev->reg = devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!dev->reg)\r\nreturn -ENOMEM;\r\nif (of_device_is_compatible(node, "marvell,orion-wdt")) {\r\ndev->rstout = orion_wdt_ioremap_rstout(pdev, res->start &\r\nINTERNAL_REGS_MASK);\r\nif (!dev->rstout)\r\nreturn -ENODEV;\r\n} else if (of_device_is_compatible(node, "marvell,armada-370-wdt") ||\r\nof_device_is_compatible(node, "marvell,armada-xp-wdt")) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\ndev->rstout = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dev->rstout))\r\nreturn PTR_ERR(dev->rstout);\r\n} else if (of_device_is_compatible(node, "marvell,armada-375-wdt") ||\r\nof_device_is_compatible(node, "marvell,armada-380-wdt")) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\ndev->rstout = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dev->rstout))\r\nreturn PTR_ERR(dev->rstout);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 2);\r\nif (!res)\r\nreturn -ENODEV;\r\ndev->rstout_mask = devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!dev->rstout_mask)\r\nreturn -ENOMEM;\r\n} else {\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct orion_watchdog *dev;\r\nconst struct of_device_id *match;\r\nunsigned int wdt_max_duration;\r\nint ret, irq;\r\ndev = devm_kzalloc(&pdev->dev, sizeof(struct orion_watchdog),\r\nGFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nmatch = of_match_device(orion_wdt_of_match_table, &pdev->dev);\r\nif (!match)\r\nmatch = &orion_wdt_of_match_table[0];\r\ndev->wdt.info = &orion_wdt_info;\r\ndev->wdt.ops = &orion_wdt_ops;\r\ndev->wdt.min_timeout = 1;\r\ndev->data = match->data;\r\nret = orion_wdt_get_regs(pdev, dev);\r\nif (ret)\r\nreturn ret;\r\nret = dev->data->clock_init(pdev, dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot initialize clock\n");\r\nreturn ret;\r\n}\r\nwdt_max_duration = WDT_MAX_CYCLE_COUNT / dev->clk_rate;\r\ndev->wdt.timeout = wdt_max_duration;\r\ndev->wdt.max_timeout = wdt_max_duration;\r\ndev->wdt.parent = &pdev->dev;\r\nwatchdog_init_timeout(&dev->wdt, heartbeat, &pdev->dev);\r\nplatform_set_drvdata(pdev, &dev->wdt);\r\nwatchdog_set_drvdata(&dev->wdt, dev);\r\nif (!orion_wdt_enabled(&dev->wdt))\r\norion_wdt_stop(&dev->wdt);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq > 0) {\r\nret = devm_request_irq(&pdev->dev, irq, orion_wdt_irq, 0,\r\npdev->name, dev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to request IRQ\n");\r\ngoto disable_clk;\r\n}\r\n}\r\nwatchdog_set_nowayout(&dev->wdt, nowayout);\r\nret = watchdog_register_device(&dev->wdt);\r\nif (ret)\r\ngoto disable_clk;\r\npr_info("Initial timeout %d sec%s\n",\r\ndev->wdt.timeout, nowayout ? ", nowayout" : "");\r\nreturn 0;\r\ndisable_clk:\r\nclk_disable_unprepare(dev->clk);\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\nstatic int orion_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdt_dev = platform_get_drvdata(pdev);\r\nstruct orion_watchdog *dev = watchdog_get_drvdata(wdt_dev);\r\nwatchdog_unregister_device(wdt_dev);\r\nclk_disable_unprepare(dev->clk);\r\nclk_put(dev->clk);\r\nreturn 0;\r\n}\r\nstatic void orion_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdt_dev = platform_get_drvdata(pdev);\r\norion_wdt_stop(wdt_dev);\r\n}

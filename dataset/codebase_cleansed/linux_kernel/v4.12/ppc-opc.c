static unsigned long\r\ninsert_arx (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif (value >= 8 && value < 24)\r\nreturn insn | ((value - 8) & 0xf);\r\nelse\r\n{\r\n*errmsg = _("invalid register");\r\nreturn 0;\r\n}\r\n}\r\nstatic long\r\nextract_arx (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn & 0xf) + 8;\r\n}\r\nstatic unsigned long\r\ninsert_ary (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif (value >= 8 && value < 24)\r\nreturn insn | (((value - 8) & 0xf) << 4);\r\nelse\r\n{\r\n*errmsg = _("invalid register");\r\nreturn 0;\r\n}\r\n}\r\nstatic long\r\nextract_ary (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 4) & 0xf) + 8;\r\n}\r\nstatic unsigned long\r\ninsert_rx (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value >= 0 && value < 8)\r\nreturn insn | value;\r\nelse if (value >= 24 && value <= 31)\r\nreturn insn | (value - 16);\r\nelse\r\n{\r\n*errmsg = _("invalid register");\r\nreturn 0;\r\n}\r\n}\r\nstatic long\r\nextract_rx (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nint value = insn & 0xf;\r\nif (value >= 0 && value < 8)\r\nreturn value;\r\nelse\r\nreturn value + 16;\r\n}\r\nstatic unsigned long\r\ninsert_ry (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value >= 0 && value < 8)\r\nreturn insn | (value << 4);\r\nelse if (value >= 24 && value <= 31)\r\nreturn insn | ((value - 16) << 4);\r\nelse\r\n{\r\n*errmsg = _("invalid register");\r\nreturn 0;\r\n}\r\n}\r\nstatic long\r\nextract_ry (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nint value = (insn >> 4) & 0xf;\r\nif (value >= 0 && value < 8)\r\nreturn value;\r\nelse\r\nreturn value + 16;\r\n}\r\nstatic unsigned long\r\ninsert_bat (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 21) & 0x1f) << 16);\r\n}\r\nstatic long\r\nextract_bat (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 21) & 0x1f) != ((insn >> 16) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_bba (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 16) & 0x1f) << 11);\r\n}\r\nstatic long\r\nextract_bba (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 16) & 0x1f) != ((insn >> 11) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_bdm (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif ((dialect & ISA_V2) == 0)\r\n{\r\nif ((value & 0x8000) != 0)\r\ninsn |= 1 << 21;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x14 << 21)) == (0x04 << 21))\r\ninsn |= 0x02 << 21;\r\nelse if ((insn & (0x14 << 21)) == (0x10 << 21))\r\ninsn |= 0x08 << 21;\r\n}\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_bdm (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nif ((dialect & ISA_V2) == 0)\r\n{\r\nif (((insn & (1 << 21)) == 0) != ((insn & (1 << 15)) == 0))\r\n*invalid = 1;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x17 << 21)) != (0x06 << 21)\r\n&& (insn & (0x1d << 21)) != (0x18 << 21))\r\n*invalid = 1;\r\n}\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_bdp (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif ((dialect & ISA_V2) == 0)\r\n{\r\nif ((value & 0x8000) == 0)\r\ninsn |= 1 << 21;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x14 << 21)) == (0x04 << 21))\r\ninsn |= 0x03 << 21;\r\nelse if ((insn & (0x14 << 21)) == (0x10 << 21))\r\ninsn |= 0x09 << 21;\r\n}\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_bdp (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nif ((dialect & ISA_V2) == 0)\r\n{\r\nif (((insn & (1 << 21)) == 0) == ((insn & (1 << 15)) == 0))\r\n*invalid = 1;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x17 << 21)) != (0x07 << 21)\r\n&& (insn & (0x1d << 21)) != (0x19 << 21))\r\n*invalid = 1;\r\n}\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic inline int\r\nvalid_bo_pre_v2 (long value)\r\n{\r\nif ((value & 0x14) == 0)\r\nreturn 1;\r\nelse if ((value & 0x14) == 0x4)\r\nreturn (value & 0x2) == 0;\r\nelse if ((value & 0x14) == 0x10)\r\nreturn (value & 0x8) == 0;\r\nelse\r\nreturn value == 0x14;\r\n}\r\nstatic inline int\r\nvalid_bo_post_v2 (long value)\r\n{\r\nif ((value & 0x14) == 0)\r\nreturn (value & 0x1) == 0;\r\nelse if ((value & 0x14) == 0x14)\r\nreturn value == 0x14;\r\nelse\r\nreturn 1;\r\n}\r\nstatic int\r\nvalid_bo (long value, ppc_cpu_t dialect, int extract)\r\n{\r\nint valid_y = valid_bo_pre_v2 (value);\r\nint valid_at = valid_bo_post_v2 (value);\r\nif (extract && dialect == ~(ppc_cpu_t) PPC_OPCODE_ANY)\r\nreturn valid_y || valid_at;\r\nif ((dialect & ISA_V2) == 0)\r\nreturn valid_y;\r\nelse\r\nreturn valid_at;\r\n}\r\nstatic unsigned long\r\ninsert_bo (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nif (!valid_bo (value, dialect, 0))\r\n*errmsg = _("invalid conditional option");\r\nelse if (PPC_OP (insn) == 19 && (insn & 0x400) && ! (value & 4))\r\n*errmsg = _("invalid counter access");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic long\r\nextract_bo (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nlong value;\r\nvalue = (insn >> 21) & 0x1f;\r\nif (!valid_bo (value, dialect, 1))\r\n*invalid = 1;\r\nreturn value;\r\n}\r\nstatic unsigned long\r\ninsert_boe (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nif (!valid_bo (value, dialect, 0))\r\n*errmsg = _("invalid conditional option");\r\nelse if (PPC_OP (insn) == 19 && (insn & 0x400) && ! (value & 4))\r\n*errmsg = _("invalid counter access");\r\nelse if ((value & 1) != 0)\r\n*errmsg = _("attempt to set y bit when using + or - modifier");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic long\r\nextract_boe (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nlong value;\r\nvalue = (insn >> 21) & 0x1f;\r\nif (!valid_bo (value, dialect, 1))\r\n*invalid = 1;\r\nreturn value & 0x1e;\r\n}\r\nstatic unsigned long\r\ninsert_dcmxs (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x20) >> 3) | (value & 0x40);\r\n}\r\nstatic long\r\nextract_dcmxs (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn & 0x40) | ((insn << 3) & 0x20) | ((insn >> 16) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_dxd (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (value & 0xffc1) | ((value & 0x3e) << 15);\r\n}\r\nstatic long\r\nextract_dxd (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nunsigned long dxd = (insn & 0xffc1) | ((insn >> 15) & 0x3e);\r\nreturn (dxd ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_dxdn (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insert_dxd (insn, -value, dialect, errmsg);\r\n}\r\nstatic long\r\nextract_dxdn (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn -extract_dxd (insn, dialect, invalid);\r\n}\r\nstatic unsigned long\r\ninsert_fxm (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nif ((insn & (1 << 20)) != 0)\r\n{\r\nif (value == 0 || (value & -value) != value)\r\n{\r\n*errmsg = _("invalid mask field");\r\nvalue = 0;\r\n}\r\n}\r\nelse if (value > 0\r\n&& (value & -value) == value\r\n&& ((dialect & PPC_OPCODE_POWER4) != 0\r\n|| ((dialect & PPC_OPCODE_ANY) != 0\r\n&& (insn & (0x3ff << 1)) == 19 << 1)))\r\ninsn |= 1 << 20;\r\nelse if ((insn & (0x3ff << 1)) == 19 << 1)\r\n{\r\nif (value != -1)\r\n*errmsg = _("invalid mfcr mask");\r\nvalue = 0;\r\n}\r\nreturn insn | ((value & 0xff) << 12);\r\n}\r\nstatic long\r\nextract_fxm (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong mask = (insn >> 12) & 0xff;\r\nif ((insn & (1 << 20)) != 0)\r\n{\r\nif (mask == 0 || (mask & -mask) != mask)\r\n*invalid = 1;\r\n}\r\nelse if ((insn & (0x3ff << 1)) == 19 << 1)\r\n{\r\nif (mask != 0)\r\n*invalid = 1;\r\nelse\r\nmask = -1;\r\n}\r\nreturn mask;\r\n}\r\nstatic unsigned long\r\ninsert_li20 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0xf0000) >> 5) | ((value & 0x0f800) << 5) | (value & 0x7ff);\r\n}\r\nstatic long\r\nextract_li20 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong ext = ((insn & 0x4000) == 0x4000) ? 0xfff00000 : 0x00000000;\r\nreturn ext\r\n| (((insn >> 11) & 0xf) << 16)\r\n| (((insn >> 17) & 0xf) << 12)\r\n| (((insn >> 16) & 0x1) << 11)\r\n| (insn & 0x7ff);\r\n}\r\nstatic unsigned long\r\ninsert_ls (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nif (((insn >> 1) & 0x3ff) == 598)\r\n{\r\nlong max_lvalue = (dialect & PPC_OPCODE_POWER4) ? 2 : 1;\r\nif (value > max_lvalue)\r\n{\r\n*errmsg = _("illegal L operand value");\r\nreturn insn;\r\n}\r\n}\r\nreturn insn | ((value & 0x3) << 21);\r\n}\r\nstatic unsigned long\r\ninsert_esync (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nunsigned long ls = (insn >> 21) & 0x03;\r\nif (value == 0)\r\n{\r\nif (((dialect & PPC_OPCODE_E6500) != 0 && ls > 1)\r\n|| ((dialect & PPC_OPCODE_POWER9) != 0 && ls > 2))\r\n*errmsg = _("illegal L operand value");\r\nreturn insn;\r\n}\r\nif ((ls & ~0x1)\r\n|| (((value >> 1) & 0x1) ^ ls) == 0)\r\n*errmsg = _("incompatible L operand value");\r\nreturn insn | ((value & 0xf) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_mbe (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nunsigned long uval, mask;\r\nint mb, me, mx, count, last;\r\nuval = value;\r\nif (uval == 0)\r\n{\r\n*errmsg = _("illegal bitmask");\r\nreturn insn;\r\n}\r\nmb = 0;\r\nme = 32;\r\nif ((uval & 1) != 0)\r\nlast = 1;\r\nelse\r\nlast = 0;\r\ncount = 0;\r\nfor (mx = 0, mask = 1L << 31; mx < 32; ++mx, mask >>= 1)\r\n{\r\nif ((uval & mask) && !last)\r\n{\r\n++count;\r\nmb = mx;\r\nlast = 1;\r\n}\r\nelse if (!(uval & mask) && last)\r\n{\r\n++count;\r\nme = mx;\r\nlast = 0;\r\n}\r\n}\r\nif (me == 0)\r\nme = 32;\r\nif (count != 2 && (count != 0 || ! last))\r\n*errmsg = _("illegal bitmask");\r\nreturn insn | (mb << 6) | ((me - 1) << 1);\r\n}\r\nstatic long\r\nextract_mbe (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong ret;\r\nint mb, me;\r\nint i;\r\n*invalid = 1;\r\nmb = (insn >> 6) & 0x1f;\r\nme = (insn >> 1) & 0x1f;\r\nif (mb < me + 1)\r\n{\r\nret = 0;\r\nfor (i = mb; i <= me; i++)\r\nret |= 1L << (31 - i);\r\n}\r\nelse if (mb == me + 1)\r\nret = ~0;\r\nelse\r\n{\r\nret = ~0;\r\nfor (i = me + 1; i < mb; i++)\r\nret &= ~(1L << (31 - i));\r\n}\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\ninsert_mb6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 6) | (value & 0x20);\r\n}\r\nstatic long\r\nextract_mb6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 6) & 0x1f) | (insn & 0x20);\r\n}\r\nstatic long\r\nextract_nb (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong ret;\r\nret = (insn >> 11) & 0x1f;\r\nif (ret == 0)\r\nret = 32;\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\ninsert_nbi (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nlong rtvalue = (insn & RT_MASK) >> 21;\r\nlong ravalue = (insn & RA_MASK) >> 16;\r\nif (value == 0)\r\nvalue = 32;\r\nif (rtvalue + (value + 3) / 4 > (rtvalue > ravalue ? ravalue + 32\r\n: ravalue))\r\n*errmsg = _("address register in load range");\r\nreturn insn | ((value & 0x1f) << 11);\r\n}\r\nstatic unsigned long\r\ninsert_nsi (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (-value & 0xffff);\r\n}\r\nstatic long\r\nextract_nsi (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\n*invalid = 1;\r\nreturn -(((insn & 0xffff) ^ 0x8000) - 0x8000);\r\n}\r\nstatic unsigned long\r\ninsert_ral (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value == 0\r\n|| (unsigned long) value == ((insn >> 21) & 0x1f))\r\n*errmsg = "invalid register operand when updating";\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_ram (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((unsigned long) value >= ((insn >> 21) & 0x1f))\r\n*errmsg = _("index register in load range");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_raq (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nlong rtvalue = (insn & RT_MASK) >> 21;\r\nif (value == rtvalue)\r\n*errmsg = _("source and target register operands must be different");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_ras (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value == 0)\r\n*errmsg = _("invalid register operand when updating");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_rbs (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 21) & 0x1f) << 11);\r\n}\r\nstatic long\r\nextract_rbs (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 21) & 0x1f) != ((insn >> 11) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_rbx (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nlong rtvalue = (insn & RT_MASK) >> 21;\r\nif (value == rtvalue)\r\n*errmsg = _("source and target register operands must be different");\r\nreturn insn | ((value & 0x1f) << 11);\r\n}\r\nstatic unsigned long\r\ninsert_sci8 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nunsigned int fill_scale = 0;\r\nunsigned long ui8 = value;\r\nif ((ui8 & 0xffffff00) == 0)\r\n;\r\nelse if ((ui8 & 0xffffff00) == 0xffffff00)\r\nfill_scale = 0x400;\r\nelse if ((ui8 & 0xffff00ff) == 0)\r\n{\r\nfill_scale = 1 << 8;\r\nui8 >>= 8;\r\n}\r\nelse if ((ui8 & 0xffff00ff) == 0xffff00ff)\r\n{\r\nfill_scale = 0x400 | (1 << 8);\r\nui8 >>= 8;\r\n}\r\nelse if ((ui8 & 0xff00ffff) == 0)\r\n{\r\nfill_scale = 2 << 8;\r\nui8 >>= 16;\r\n}\r\nelse if ((ui8 & 0xff00ffff) == 0xff00ffff)\r\n{\r\nfill_scale = 0x400 | (2 << 8);\r\nui8 >>= 16;\r\n}\r\nelse if ((ui8 & 0x00ffffff) == 0)\r\n{\r\nfill_scale = 3 << 8;\r\nui8 >>= 24;\r\n}\r\nelse if ((ui8 & 0x00ffffff) == 0x00ffffff)\r\n{\r\nfill_scale = 0x400 | (3 << 8);\r\nui8 >>= 24;\r\n}\r\nelse\r\n{\r\n*errmsg = _("illegal immediate value");\r\nui8 = 0;\r\n}\r\nreturn insn | fill_scale | (ui8 & 0xff);\r\n}\r\nstatic long\r\nextract_sci8 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nint fill = insn & 0x400;\r\nint scale_factor = (insn & 0x300) >> 5;\r\nlong value = (insn & 0xff) << scale_factor;\r\nif (fill != 0)\r\nvalue |= ~((long) 0xff << scale_factor);\r\nreturn value;\r\n}\r\nstatic unsigned long\r\ninsert_sci8n (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nreturn insert_sci8 (insn, -value, dialect, errmsg);\r\n}\r\nstatic long\r\nextract_sci8n (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nreturn -extract_sci8 (insn, dialect, invalid);\r\n}\r\nstatic unsigned long\r\ninsert_sd4h (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1e) << 7);\r\n}\r\nstatic long\r\nextract_sd4h (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 8) & 0xf) << 1;\r\n}\r\nstatic unsigned long\r\ninsert_sd4w (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x3c) << 6);\r\n}\r\nstatic long\r\nextract_sd4w (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 8) & 0xf) << 2;\r\n}\r\nstatic unsigned long\r\ninsert_oimm (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((value - 1) & 0x1f) << 4);\r\n}\r\nstatic long\r\nextract_oimm (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 4) & 0x1f) + 1;\r\n}\r\nstatic unsigned long\r\ninsert_sh6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif (PPC_OP (insn) == 4)\r\nreturn insn | ((value & 0x1f) << 6) | ((value & 0x20) >> 5);\r\nelse\r\nreturn insn | ((value & 0x1f) << 11) | ((value & 0x20) >> 4);\r\n}\r\nstatic long\r\nextract_sh6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nif (PPC_OP (insn) == 4)\r\nreturn ((insn >> 6) & 0x1f) | ((insn << 5) & 0x20);\r\nelse\r\nreturn ((insn >> 11) & 0x1f) | ((insn << 4) & 0x20);\r\n}\r\nstatic unsigned long\r\ninsert_spr (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x3e0) << 6);\r\n}\r\nstatic long\r\nextract_spr (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 16) & 0x1f) | ((insn >> 6) & 0x3e0);\r\n}\r\nstatic unsigned long\r\ninsert_sprg (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect,\r\nconst char **errmsg)\r\n{\r\nif (value > 7\r\n|| (value > 3 && (dialect & ALLOW8_SPRG) == 0))\r\n*errmsg = _("invalid sprg number");\r\nif (value <= 3 || (insn & 0x100) != 0)\r\nvalue |= 0x10;\r\nreturn insn | ((value & 0x17) << 16);\r\n}\r\nstatic long\r\nextract_sprg (unsigned long insn,\r\nppc_cpu_t dialect,\r\nint *invalid)\r\n{\r\nunsigned long val = (insn >> 16) & 0x1f;\r\nif ((val - 0x10 > 3 && (dialect & ALLOW8_SPRG) == 0)\r\n|| (val - 0x10 > 7 && (insn & 0x100) != 0)\r\n|| val <= 3\r\n|| (val & 8) != 0)\r\n*invalid = 1;\r\nreturn val & 7;\r\n}\r\nstatic unsigned long\r\ninsert_tbr (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value != 268 && value != 269)\r\n*errmsg = _("invalid tbr number");\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x3e0) << 6);\r\n}\r\nstatic long\r\nextract_tbr (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong ret;\r\nret = ((insn >> 16) & 0x1f) | ((insn >> 6) & 0x3e0);\r\nif (ret != 268 && ret != 269)\r\n*invalid = 1;\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\ninsert_xt6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 21) | ((value & 0x20) >> 5);\r\n}\r\nstatic long\r\nextract_xt6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn << 5) & 0x20) | ((insn >> 21) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_xtq6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 21) | ((value & 0x20) >> 2);\r\n}\r\nstatic long\r\nextract_xtq6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn << 2) & 0x20) | ((insn >> 21) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_xa6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x20) >> 3);\r\n}\r\nstatic long\r\nextract_xa6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn << 3) & 0x20) | ((insn >> 16) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_xb6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 11) | ((value & 0x20) >> 4);\r\n}\r\nstatic long\r\nextract_xb6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn << 4) & 0x20) | ((insn >> 11) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_xb6s (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 16) & 0x1f) << 11) | (((insn >> 2) & 0x1) << 1);\r\n}\r\nstatic long\r\nextract_xb6s (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif ((((insn >> 16) & 0x1f) != ((insn >> 11) & 0x1f))\r\n|| (((insn >> 2) & 0x1) != ((insn >> 1) & 0x1)))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_xc6 (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 6) | ((value & 0x20) >> 2);\r\n}\r\nstatic long\r\nextract_xc6 (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn << 2) & 0x20) | ((insn >> 6) & 0x1f);\r\n}\r\nstatic unsigned long\r\ninsert_dm (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value != 0 && value != 1)\r\n*errmsg = _("invalid constant");\r\nreturn insn | (((value) ? 3 : 0) << 8);\r\n}\r\nstatic long\r\nextract_dm (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong value;\r\nvalue = (insn >> 8) & 3;\r\nif (value != 0 && value != 3)\r\n*invalid = 1;\r\nreturn (value) ? 1 : 0;\r\n}\r\nstatic unsigned long\r\ninsert_vlesi (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0xf800) << 10) | (value & 0x7ff);\r\n}\r\nstatic long\r\nextract_vlesi (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong value = ((insn >> 10) & 0xf800) | (insn & 0x7ff);\r\nvalue = (value ^ 0x8000) - 0x8000;\r\nreturn value;\r\n}\r\nstatic unsigned long\r\ninsert_vlensi (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nvalue = -value;\r\nreturn insn | ((value & 0xf800) << 10) | (value & 0x7ff);\r\n}\r\nstatic long\r\nextract_vlensi (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong value = ((insn >> 10) & 0xf800) | (insn & 0x7ff);\r\nvalue = (value ^ 0x8000) - 0x8000;\r\n*invalid = 1;\r\nreturn -value;\r\n}\r\nstatic unsigned long\r\ninsert_vleui (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0xf800) << 10) | (value & 0x7ff);\r\n}\r\nstatic long\r\nextract_vleui (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 10) & 0xf800) | (insn & 0x7ff);\r\n}\r\nstatic unsigned long\r\ninsert_vleil (unsigned long insn,\r\nlong value,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0xf800) << 5) | (value & 0x7ff);\r\n}\r\nstatic long\r\nextract_vleil (unsigned long insn,\r\nppc_cpu_t dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 5) & 0xf800) | (insn & 0x7ff);\r\n}

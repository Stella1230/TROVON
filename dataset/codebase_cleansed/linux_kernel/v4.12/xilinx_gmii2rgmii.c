static int xgmiitorgmii_read_status(struct phy_device *phydev)\r\n{\r\nstruct gmii2rgmii *priv = phydev->priv;\r\nu16 val = 0;\r\npriv->phy_drv->read_status(phydev);\r\nval = mdiobus_read(phydev->mdio.bus, priv->addr, XILINX_GMII2RGMII_REG);\r\nval &= XILINX_GMII2RGMII_SPEED_MASK;\r\nif (phydev->speed == SPEED_1000)\r\nval |= BMCR_SPEED1000;\r\nelse if (phydev->speed == SPEED_100)\r\nval |= BMCR_SPEED100;\r\nelse\r\nval |= BMCR_SPEED10;\r\nmdiobus_write(phydev->mdio.bus, priv->addr, XILINX_GMII2RGMII_REG, val);\r\nreturn 0;\r\n}\r\nstatic int xgmiitorgmii_probe(struct mdio_device *mdiodev)\r\n{\r\nstruct device *dev = &mdiodev->dev;\r\nstruct device_node *np = dev->of_node, *phy_node;\r\nstruct gmii2rgmii *priv;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nphy_node = of_parse_phandle(np, "phy-handle", 0);\r\nif (!phy_node) {\r\ndev_err(dev, "Couldn't parse phy-handle\n");\r\nreturn -ENODEV;\r\n}\r\npriv->phy_dev = of_phy_find_device(phy_node);\r\nof_node_put(phy_node);\r\nif (!priv->phy_dev) {\r\ndev_info(dev, "Couldn't find phydev\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\npriv->addr = mdiodev->addr;\r\npriv->phy_drv = priv->phy_dev->drv;\r\nmemcpy(&priv->conv_phy_drv, priv->phy_dev->drv,\r\nsizeof(struct phy_driver));\r\npriv->conv_phy_drv.read_status = xgmiitorgmii_read_status;\r\npriv->phy_dev->priv = priv;\r\npriv->phy_dev->drv = &priv->conv_phy_drv;\r\nreturn 0;\r\n}

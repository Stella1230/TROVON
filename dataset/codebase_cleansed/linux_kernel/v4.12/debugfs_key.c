static ssize_t key_algorithm_read(struct file *file,\r\nchar __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar buf[15];\r\nstruct ieee80211_key *key = file->private_data;\r\nu32 c = key->conf.cipher;\r\nsprintf(buf, "%.2x-%.2x-%.2x:%d\n",\r\nc >> 24, (c >> 16) & 0xff, (c >> 8) & 0xff, c & 0xff);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, strlen(buf));\r\n}\r\nstatic ssize_t key_tx_spec_write(struct file *file, const char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nu64 pn;\r\nint ret;\r\nswitch (key->conf.cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nreturn -EINVAL;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nreturn -EOPNOTSUPP;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ncase WLAN_CIPHER_SUITE_CCMP_256:\r\ncase WLAN_CIPHER_SUITE_AES_CMAC:\r\ncase WLAN_CIPHER_SUITE_BIP_CMAC_256:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_128:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_256:\r\ncase WLAN_CIPHER_SUITE_GCMP:\r\ncase WLAN_CIPHER_SUITE_GCMP_256:\r\nret = kstrtou64_from_user(userbuf, count, 16, &pn);\r\nif (ret)\r\nreturn ret;\r\nif (pn >= (1ULL << 48))\r\nreturn -ERANGE;\r\natomic64_set(&key->conf.tx_pn, pn);\r\nreturn count;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic ssize_t key_tx_spec_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nu64 pn;\r\nchar buf[20];\r\nint len;\r\nstruct ieee80211_key *key = file->private_data;\r\nswitch (key->conf.cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nlen = scnprintf(buf, sizeof(buf), "\n");\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\npn = atomic64_read(&key->conf.tx_pn);\r\nlen = scnprintf(buf, sizeof(buf), "%08x %04x\n",\r\nTKIP_PN_TO_IV32(pn),\r\nTKIP_PN_TO_IV16(pn));\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ncase WLAN_CIPHER_SUITE_CCMP_256:\r\ncase WLAN_CIPHER_SUITE_AES_CMAC:\r\ncase WLAN_CIPHER_SUITE_BIP_CMAC_256:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_128:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_256:\r\ncase WLAN_CIPHER_SUITE_GCMP:\r\ncase WLAN_CIPHER_SUITE_GCMP_256:\r\npn = atomic64_read(&key->conf.tx_pn);\r\nlen = scnprintf(buf, sizeof(buf), "%02x%02x%02x%02x%02x%02x\n",\r\n(u8)(pn >> 40), (u8)(pn >> 32), (u8)(pn >> 24),\r\n(u8)(pn >> 16), (u8)(pn >> 8), (u8)pn);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t key_rx_spec_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nchar buf[14*IEEE80211_NUM_TIDS+1], *p = buf;\r\nint i, len;\r\nconst u8 *rpn;\r\nswitch (key->conf.cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nlen = scnprintf(buf, sizeof(buf), "\n");\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nfor (i = 0; i < IEEE80211_NUM_TIDS; i++)\r\np += scnprintf(p, sizeof(buf)+buf-p,\r\n"%08x %04x\n",\r\nkey->u.tkip.rx[i].iv32,\r\nkey->u.tkip.rx[i].iv16);\r\nlen = p - buf;\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ncase WLAN_CIPHER_SUITE_CCMP_256:\r\nfor (i = 0; i < IEEE80211_NUM_TIDS + 1; i++) {\r\nrpn = key->u.ccmp.rx_pn[i];\r\np += scnprintf(p, sizeof(buf)+buf-p,\r\n"%02x%02x%02x%02x%02x%02x\n",\r\nrpn[0], rpn[1], rpn[2],\r\nrpn[3], rpn[4], rpn[5]);\r\n}\r\nlen = p - buf;\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_AES_CMAC:\r\ncase WLAN_CIPHER_SUITE_BIP_CMAC_256:\r\nrpn = key->u.aes_cmac.rx_pn;\r\np += scnprintf(p, sizeof(buf)+buf-p,\r\n"%02x%02x%02x%02x%02x%02x\n",\r\nrpn[0], rpn[1], rpn[2],\r\nrpn[3], rpn[4], rpn[5]);\r\nlen = p - buf;\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_128:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_256:\r\nrpn = key->u.aes_gmac.rx_pn;\r\np += scnprintf(p, sizeof(buf)+buf-p,\r\n"%02x%02x%02x%02x%02x%02x\n",\r\nrpn[0], rpn[1], rpn[2],\r\nrpn[3], rpn[4], rpn[5]);\r\nlen = p - buf;\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_GCMP:\r\ncase WLAN_CIPHER_SUITE_GCMP_256:\r\nfor (i = 0; i < IEEE80211_NUM_TIDS + 1; i++) {\r\nrpn = key->u.gcmp.rx_pn[i];\r\np += scnprintf(p, sizeof(buf)+buf-p,\r\n"%02x%02x%02x%02x%02x%02x\n",\r\nrpn[0], rpn[1], rpn[2],\r\nrpn[3], rpn[4], rpn[5]);\r\n}\r\nlen = p - buf;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t key_replays_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nchar buf[20];\r\nint len;\r\nswitch (key->conf.cipher) {\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ncase WLAN_CIPHER_SUITE_CCMP_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n", key->u.ccmp.replays);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_AES_CMAC:\r\ncase WLAN_CIPHER_SUITE_BIP_CMAC_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n",\r\nkey->u.aes_cmac.replays);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_128:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n",\r\nkey->u.aes_gmac.replays);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_GCMP:\r\ncase WLAN_CIPHER_SUITE_GCMP_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n", key->u.gcmp.replays);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t key_icverrors_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nchar buf[20];\r\nint len;\r\nswitch (key->conf.cipher) {\r\ncase WLAN_CIPHER_SUITE_AES_CMAC:\r\ncase WLAN_CIPHER_SUITE_BIP_CMAC_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n",\r\nkey->u.aes_cmac.icverrors);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_128:\r\ncase WLAN_CIPHER_SUITE_BIP_GMAC_256:\r\nlen = scnprintf(buf, sizeof(buf), "%u\n",\r\nkey->u.aes_gmac.icverrors);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t key_mic_failures_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nchar buf[20];\r\nint len;\r\nif (key->conf.cipher != WLAN_CIPHER_SUITE_TKIP)\r\nreturn -EINVAL;\r\nlen = scnprintf(buf, sizeof(buf), "%u\n", key->u.tkip.mic_failures);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t key_key_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ieee80211_key *key = file->private_data;\r\nint i, bufsize = 2 * key->conf.keylen + 2;\r\nchar *buf = kmalloc(bufsize, GFP_KERNEL);\r\nchar *p = buf;\r\nssize_t res;\r\nif (!buf)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < key->conf.keylen; i++)\r\np += scnprintf(p, bufsize + buf - p, "%02x", key->conf.key[i]);\r\np += scnprintf(p, bufsize+buf-p, "\n");\r\nres = simple_read_from_buffer(userbuf, count, ppos, buf, p - buf);\r\nkfree(buf);\r\nreturn res;\r\n}\r\nvoid ieee80211_debugfs_key_add(struct ieee80211_key *key)\r\n{\r\nstatic int keycount;\r\nchar buf[100];\r\nstruct sta_info *sta;\r\nif (!key->local->debugfs.keys)\r\nreturn;\r\nsprintf(buf, "%d", keycount);\r\nkey->debugfs.cnt = keycount;\r\nkeycount++;\r\nkey->debugfs.dir = debugfs_create_dir(buf,\r\nkey->local->debugfs.keys);\r\nif (!key->debugfs.dir)\r\nreturn;\r\nsta = key->sta;\r\nif (sta) {\r\nsprintf(buf, "../../netdev:%s/stations/%pM",\r\nsta->sdata->name, sta->sta.addr);\r\nkey->debugfs.stalink =\r\ndebugfs_create_symlink("station", key->debugfs.dir, buf);\r\n}\r\nDEBUGFS_ADD(keylen);\r\nDEBUGFS_ADD(flags);\r\nDEBUGFS_ADD(keyidx);\r\nDEBUGFS_ADD(hw_key_idx);\r\nDEBUGFS_ADD(algorithm);\r\nDEBUGFS_ADD_W(tx_spec);\r\nDEBUGFS_ADD(rx_spec);\r\nDEBUGFS_ADD(replays);\r\nDEBUGFS_ADD(icverrors);\r\nDEBUGFS_ADD(mic_failures);\r\nDEBUGFS_ADD(key);\r\nDEBUGFS_ADD(ifindex);\r\n}\r\nvoid ieee80211_debugfs_key_remove(struct ieee80211_key *key)\r\n{\r\nif (!key)\r\nreturn;\r\ndebugfs_remove_recursive(key->debugfs.dir);\r\nkey->debugfs.dir = NULL;\r\n}\r\nvoid ieee80211_debugfs_key_update_default(struct ieee80211_sub_if_data *sdata)\r\n{\r\nchar buf[50];\r\nstruct ieee80211_key *key;\r\nif (!sdata->vif.debugfs_dir)\r\nreturn;\r\nlockdep_assert_held(&sdata->local->key_mtx);\r\ndebugfs_remove(sdata->debugfs.default_unicast_key);\r\nsdata->debugfs.default_unicast_key = NULL;\r\nif (sdata->default_unicast_key) {\r\nkey = key_mtx_dereference(sdata->local,\r\nsdata->default_unicast_key);\r\nsprintf(buf, "../keys/%d", key->debugfs.cnt);\r\nsdata->debugfs.default_unicast_key =\r\ndebugfs_create_symlink("default_unicast_key",\r\nsdata->vif.debugfs_dir, buf);\r\n}\r\ndebugfs_remove(sdata->debugfs.default_multicast_key);\r\nsdata->debugfs.default_multicast_key = NULL;\r\nif (sdata->default_multicast_key) {\r\nkey = key_mtx_dereference(sdata->local,\r\nsdata->default_multicast_key);\r\nsprintf(buf, "../keys/%d", key->debugfs.cnt);\r\nsdata->debugfs.default_multicast_key =\r\ndebugfs_create_symlink("default_multicast_key",\r\nsdata->vif.debugfs_dir, buf);\r\n}\r\n}\r\nvoid ieee80211_debugfs_key_add_mgmt_default(struct ieee80211_sub_if_data *sdata)\r\n{\r\nchar buf[50];\r\nstruct ieee80211_key *key;\r\nif (!sdata->vif.debugfs_dir)\r\nreturn;\r\nkey = key_mtx_dereference(sdata->local,\r\nsdata->default_mgmt_key);\r\nif (key) {\r\nsprintf(buf, "../keys/%d", key->debugfs.cnt);\r\nsdata->debugfs.default_mgmt_key =\r\ndebugfs_create_symlink("default_mgmt_key",\r\nsdata->vif.debugfs_dir, buf);\r\n} else\r\nieee80211_debugfs_key_remove_mgmt_default(sdata);\r\n}\r\nvoid ieee80211_debugfs_key_remove_mgmt_default(struct ieee80211_sub_if_data *sdata)\r\n{\r\nif (!sdata)\r\nreturn;\r\ndebugfs_remove(sdata->debugfs.default_mgmt_key);\r\nsdata->debugfs.default_mgmt_key = NULL;\r\n}\r\nvoid ieee80211_debugfs_key_sta_del(struct ieee80211_key *key,\r\nstruct sta_info *sta)\r\n{\r\ndebugfs_remove(key->debugfs.stalink);\r\nkey->debugfs.stalink = NULL;\r\n}

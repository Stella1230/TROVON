static void handle_init_ack_msg(struct vdec_vpu_ipi_init_ack *msg)\r\n{\r\nstruct vdec_vpu_inst *vpu = (struct vdec_vpu_inst *)\r\n(unsigned long)msg->ap_inst_addr;\r\nmtk_vcodec_debug(vpu, "+ ap_inst_addr = 0x%llx", msg->ap_inst_addr);\r\nvpu->vsi = vpu_mapping_dm_addr(vpu->dev, msg->vpu_inst_addr);\r\nvpu->inst_addr = msg->vpu_inst_addr;\r\nmtk_vcodec_debug(vpu, "- vpu_inst_addr = 0x%x", vpu->inst_addr);\r\n}\r\nvoid vpu_dec_ipi_handler(void *data, unsigned int len, void *priv)\r\n{\r\nstruct vdec_vpu_ipi_ack *msg = data;\r\nstruct vdec_vpu_inst *vpu = (struct vdec_vpu_inst *)\r\n(unsigned long)msg->ap_inst_addr;\r\nmtk_vcodec_debug(vpu, "+ id=%X", msg->msg_id);\r\nif (msg->status == 0) {\r\nswitch (msg->msg_id) {\r\ncase VPU_IPIMSG_DEC_INIT_ACK:\r\nhandle_init_ack_msg(data);\r\nbreak;\r\ncase VPU_IPIMSG_DEC_START_ACK:\r\ncase VPU_IPIMSG_DEC_END_ACK:\r\ncase VPU_IPIMSG_DEC_DEINIT_ACK:\r\ncase VPU_IPIMSG_DEC_RESET_ACK:\r\nbreak;\r\ndefault:\r\nmtk_vcodec_err(vpu, "invalid msg=%X", msg->msg_id);\r\nbreak;\r\n}\r\n}\r\nmtk_vcodec_debug(vpu, "- id=%X", msg->msg_id);\r\nvpu->failure = msg->status;\r\nvpu->signaled = 1;\r\n}\r\nstatic int vcodec_vpu_send_msg(struct vdec_vpu_inst *vpu, void *msg, int len)\r\n{\r\nint err;\r\nmtk_vcodec_debug(vpu, "id=%X", *(uint32_t *)msg);\r\nvpu->failure = 0;\r\nvpu->signaled = 0;\r\nerr = vpu_ipi_send(vpu->dev, vpu->id, msg, len);\r\nif (err) {\r\nmtk_vcodec_err(vpu, "send fail vpu_id=%d msg_id=%X status=%d",\r\nvpu->id, *(uint32_t *)msg, err);\r\nreturn err;\r\n}\r\nreturn vpu->failure;\r\n}\r\nstatic int vcodec_send_ap_ipi(struct vdec_vpu_inst *vpu, unsigned int msg_id)\r\n{\r\nstruct vdec_ap_ipi_cmd msg;\r\nint err = 0;\r\nmtk_vcodec_debug(vpu, "+ id=%X", msg_id);\r\nmemset(&msg, 0, sizeof(msg));\r\nmsg.msg_id = msg_id;\r\nmsg.vpu_inst_addr = vpu->inst_addr;\r\nerr = vcodec_vpu_send_msg(vpu, &msg, sizeof(msg));\r\nmtk_vcodec_debug(vpu, "- id=%X ret=%d", msg_id, err);\r\nreturn err;\r\n}\r\nint vpu_dec_init(struct vdec_vpu_inst *vpu)\r\n{\r\nstruct vdec_ap_ipi_init msg;\r\nint err;\r\nmtk_vcodec_debug_enter(vpu);\r\ninit_waitqueue_head(&vpu->wq);\r\nerr = vpu_ipi_register(vpu->dev, vpu->id, vpu->handler, "vdec", NULL);\r\nif (err != 0) {\r\nmtk_vcodec_err(vpu, "vpu_ipi_register fail status=%d", err);\r\nreturn err;\r\n}\r\nmemset(&msg, 0, sizeof(msg));\r\nmsg.msg_id = AP_IPIMSG_DEC_INIT;\r\nmsg.ap_inst_addr = (unsigned long)vpu;\r\nmtk_vcodec_debug(vpu, "vdec_inst=%p", vpu);\r\nerr = vcodec_vpu_send_msg(vpu, (void *)&msg, sizeof(msg));\r\nmtk_vcodec_debug(vpu, "- ret=%d", err);\r\nreturn err;\r\n}\r\nint vpu_dec_start(struct vdec_vpu_inst *vpu, uint32_t *data, unsigned int len)\r\n{\r\nstruct vdec_ap_ipi_dec_start msg;\r\nint i;\r\nint err = 0;\r\nmtk_vcodec_debug_enter(vpu);\r\nif (len > ARRAY_SIZE(msg.data)) {\r\nmtk_vcodec_err(vpu, "invalid len = %d\n", len);\r\nreturn -EINVAL;\r\n}\r\nmemset(&msg, 0, sizeof(msg));\r\nmsg.msg_id = AP_IPIMSG_DEC_START;\r\nmsg.vpu_inst_addr = vpu->inst_addr;\r\nfor (i = 0; i < len; i++)\r\nmsg.data[i] = data[i];\r\nerr = vcodec_vpu_send_msg(vpu, (void *)&msg, sizeof(msg));\r\nmtk_vcodec_debug(vpu, "- ret=%d", err);\r\nreturn err;\r\n}\r\nint vpu_dec_end(struct vdec_vpu_inst *vpu)\r\n{\r\nreturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_END);\r\n}\r\nint vpu_dec_deinit(struct vdec_vpu_inst *vpu)\r\n{\r\nreturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_DEINIT);\r\n}\r\nint vpu_dec_reset(struct vdec_vpu_inst *vpu)\r\n{\r\nreturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_RESET);\r\n}

static int max14577_reg_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint rid = rdev_get_id(rdev);\r\nstruct regmap *rmap = rdev->regmap;\r\nu8 reg_data;\r\nswitch (rid) {\r\ncase MAX14577_CHARGER:\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL2, &reg_data);\r\nif ((reg_data & CHGCTRL2_MBCHOSTEN_MASK) == 0)\r\nreturn 0;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\r\nif ((reg_data & STATUS3_CGMBC_MASK) == 0)\r\nreturn 0;\r\nreturn 1;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int max14577_reg_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nu8 reg_data;\r\nstruct regmap *rmap = rdev->regmap;\r\nstruct max14577 *max14577 = rdev_get_drvdata(rdev);\r\nconst struct maxim_charger_current *limits =\r\n&maxim_charger_currents[max14577->dev_type];\r\nif (rdev_get_id(rdev) != MAX14577_CHARGER)\r\nreturn -EINVAL;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL4, &reg_data);\r\nif ((reg_data & CHGCTRL4_MBCICHWRCL_MASK) == 0)\r\nreturn limits->min;\r\nreg_data = ((reg_data & CHGCTRL4_MBCICHWRCH_MASK) >>\r\nCHGCTRL4_MBCICHWRCH_SHIFT);\r\nreturn limits->high_start + reg_data * limits->high_step;\r\n}\r\nstatic int max14577_reg_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nu8 reg_data;\r\nint ret;\r\nstruct max14577 *max14577 = rdev_get_drvdata(rdev);\r\nconst struct maxim_charger_current *limits =\r\n&maxim_charger_currents[max14577->dev_type];\r\nif (rdev_get_id(rdev) != MAX14577_CHARGER)\r\nreturn -EINVAL;\r\nret = maxim_charger_calc_reg_current(limits, min_uA, max_uA, &reg_data);\r\nif (ret)\r\nreturn ret;\r\nreturn max14577_update_reg(rdev->regmap, MAX14577_CHG_REG_CHG_CTRL4,\r\nCHGCTRL4_MBCICHWRCL_MASK | CHGCTRL4_MBCICHWRCH_MASK,\r\nreg_data);\r\n}\r\nstatic inline struct regulator_init_data *match_init_data(int index,\r\nenum maxim_device_type dev_type)\r\n{\r\nswitch (dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nreturn max77836_regulator_matches[index].init_data;\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nreturn max14577_regulator_matches[index].init_data;\r\n}\r\n}\r\nstatic inline struct device_node *match_of_node(int index,\r\nenum maxim_device_type dev_type)\r\n{\r\nswitch (dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nreturn max77836_regulator_matches[index].of_node;\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nreturn max14577_regulator_matches[index].of_node;\r\n}\r\n}\r\nstatic inline struct regulator_init_data *match_init_data(int index,\r\nenum maxim_device_type dev_type)\r\n{\r\nreturn NULL;\r\n}\r\nstatic inline struct device_node *match_of_node(int index,\r\nenum maxim_device_type dev_type)\r\n{\r\nreturn NULL;\r\n}\r\nstatic struct regmap *max14577_get_regmap(struct max14577 *max14577,\r\nint reg_id)\r\n{\r\nswitch (max14577->dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nswitch (reg_id) {\r\ncase MAX77836_SAFEOUT ... MAX77836_CHARGER:\r\nreturn max14577->regmap;\r\ndefault:\r\nreturn max14577->regmap_pmic;\r\n}\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nreturn max14577->regmap;\r\n}\r\n}\r\nstatic int max14577_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct max14577 *max14577 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max14577_platform_data *pdata = dev_get_platdata(max14577->dev);\r\nint i, ret = 0;\r\nstruct regulator_config config = {};\r\nconst struct regulator_desc *supported_regulators;\r\nunsigned int supported_regulators_size;\r\nenum maxim_device_type dev_type = max14577->dev_type;\r\nswitch (dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nsupported_regulators = max77836_supported_regulators;\r\nsupported_regulators_size = ARRAY_SIZE(max77836_supported_regulators);\r\nbreak;\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nsupported_regulators = max14577_supported_regulators;\r\nsupported_regulators_size = ARRAY_SIZE(max14577_supported_regulators);\r\n}\r\nconfig.dev = max14577->dev;\r\nconfig.driver_data = max14577;\r\nfor (i = 0; i < supported_regulators_size; i++) {\r\nstruct regulator_dev *regulator;\r\nif (pdata && pdata->regulators) {\r\nconfig.init_data = pdata->regulators[i].initdata;\r\nconfig.of_node = pdata->regulators[i].of_node;\r\n} else {\r\nconfig.init_data = match_init_data(i, dev_type);\r\nconfig.of_node = match_of_node(i, dev_type);\r\n}\r\nconfig.regmap = max14577_get_regmap(max14577,\r\nsupported_regulators[i].id);\r\nregulator = devm_regulator_register(&pdev->dev,\r\n&supported_regulators[i], &config);\r\nif (IS_ERR(regulator)) {\r\nret = PTR_ERR(regulator);\r\ndev_err(&pdev->dev,\r\n"Regulator init failed for %d/%s with error: %d\n",\r\ni, supported_regulators[i].name, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init max14577_regulator_init(void)\r\n{\r\nBUILD_BUG_ON(ARRAY_SIZE(max14577_supported_regulators) != MAX14577_REGULATOR_NUM);\r\nBUILD_BUG_ON(ARRAY_SIZE(max77836_supported_regulators) != MAX77836_REGULATOR_NUM);\r\nBUILD_BUG_ON(MAX77836_REGULATOR_LDO_VOLTAGE_MIN +\r\n(MAX77836_REGULATOR_LDO_VOLTAGE_STEP *\r\n(MAX77836_REGULATOR_LDO_VOLTAGE_STEPS_NUM - 1)) !=\r\nMAX77836_REGULATOR_LDO_VOLTAGE_MAX);\r\nreturn platform_driver_register(&max14577_regulator_driver);\r\n}\r\nstatic void __exit max14577_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&max14577_regulator_driver);\r\n}

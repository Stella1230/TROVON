static int __init armada_xp_pmsu_cpufreq_init(void)\r\n{\r\nstruct device_node *np;\r\nstruct resource res;\r\nint ret, cpu;\r\nif (!of_machine_is_compatible("marvell,armadaxp"))\r\nreturn 0;\r\nnp = of_find_compatible_node(NULL, NULL, "marvell,armada-xp-cpu-clock");\r\nif (!np)\r\nreturn 0;\r\nret = of_address_to_resource(np, 1, &res);\r\nif (ret) {\r\npr_warn(FW_WARN "not enabling cpufreq, deprecated armada-xp-cpu-clock binding\n");\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nof_node_put(np);\r\nfor_each_possible_cpu(cpu) {\r\nstruct device *cpu_dev;\r\nstruct clk *clk;\r\nint ret;\r\ncpu_dev = get_cpu_device(cpu);\r\nif (!cpu_dev) {\r\npr_err("Cannot get CPU %d\n", cpu);\r\ncontinue;\r\n}\r\nclk = clk_get(cpu_dev, NULL);\r\nif (IS_ERR(clk)) {\r\npr_err("Cannot get clock for CPU %d\n", cpu);\r\nreturn PTR_ERR(clk);\r\n}\r\nret = dev_pm_opp_add(cpu_dev, clk_get_rate(clk), 0);\r\nif (ret) {\r\nclk_put(clk);\r\nreturn ret;\r\n}\r\nret = dev_pm_opp_add(cpu_dev, clk_get_rate(clk) / 2, 0);\r\nif (ret) {\r\nclk_put(clk);\r\nreturn ret;\r\n}\r\nret = dev_pm_opp_set_sharing_cpus(cpu_dev,\r\ncpumask_of(cpu_dev->id));\r\nif (ret)\r\ndev_err(cpu_dev, "%s: failed to mark OPPs as shared: %d\n",\r\n__func__, ret);\r\n}\r\nplatform_device_register_simple("cpufreq-dt", -1, NULL, 0);\r\nreturn 0;\r\n}

static int b53_mdio_op(struct b53_device *dev, u8 page, u8 reg, u16 op)\r\n{\r\nint i;\r\nu16 v;\r\nint ret;\r\nstruct mii_bus *bus = dev->priv;\r\nif (dev->current_page != page) {\r\nv = (page << 8) | REG_MII_PAGE_ENABLE;\r\nret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_PAGE, v);\r\nif (ret)\r\nreturn ret;\r\ndev->current_page = page;\r\n}\r\nv = (reg << 8) | op;\r\nret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR, REG_MII_ADDR, v);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < 5; ++i) {\r\nv = mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_ADDR);\r\nif (!(v & (REG_MII_ADDR_WRITE | REG_MII_ADDR_READ)))\r\nbreak;\r\nusleep_range(10, 100);\r\n}\r\nif (WARN_ON(i == 5))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_read8(struct b53_device *dev, u8 page, u8 reg, u8 *val)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nint ret;\r\nret = b53_mdio_op(dev, page, reg, REG_MII_ADDR_READ);\r\nif (ret)\r\nreturn ret;\r\n*val = mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0) & 0xff;\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_read16(struct b53_device *dev, u8 page, u8 reg, u16 *val)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nint ret;\r\nret = b53_mdio_op(dev, page, reg, REG_MII_ADDR_READ);\r\nif (ret)\r\nreturn ret;\r\n*val = mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR, REG_MII_DATA0);\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_read32(struct b53_device *dev, u8 page, u8 reg, u32 *val)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nint ret;\r\nret = b53_mdio_op(dev, page, reg, REG_MII_ADDR_READ);\r\nif (ret)\r\nreturn ret;\r\n*val = mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR, REG_MII_DATA0);\r\n*val |= mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA1) << 16;\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_read48(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nu64 temp = 0;\r\nint i;\r\nint ret;\r\nret = b53_mdio_op(dev, page, reg, REG_MII_ADDR_READ);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 2; i >= 0; i--) {\r\ntemp <<= 16;\r\ntemp |= mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0 + i);\r\n}\r\n*val = temp;\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_read64(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nu64 temp = 0;\r\nint i;\r\nint ret;\r\nret = b53_mdio_op(dev, page, reg, REG_MII_ADDR_READ);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 3; i >= 0; i--) {\r\ntemp <<= 16;\r\ntemp |= mdiobus_read_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0 + i);\r\n}\r\n*val = temp;\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_write8(struct b53_device *dev, u8 page, u8 reg, u8 value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nint ret;\r\nret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0, value);\r\nif (ret)\r\nreturn ret;\r\nreturn b53_mdio_op(dev, page, reg, REG_MII_ADDR_WRITE);\r\n}\r\nstatic int b53_mdio_write16(struct b53_device *dev, u8 page, u8 reg,\r\nu16 value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nint ret;\r\nret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0, value);\r\nif (ret)\r\nreturn ret;\r\nreturn b53_mdio_op(dev, page, reg, REG_MII_ADDR_WRITE);\r\n}\r\nstatic int b53_mdio_write32(struct b53_device *dev, u8 page, u8 reg,\r\nu32 value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nunsigned int i;\r\nu32 temp = value;\r\nfor (i = 0; i < 2; i++) {\r\nint ret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0 + i,\r\ntemp & 0xffff);\r\nif (ret)\r\nreturn ret;\r\ntemp >>= 16;\r\n}\r\nreturn b53_mdio_op(dev, page, reg, REG_MII_ADDR_WRITE);\r\n}\r\nstatic int b53_mdio_write48(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nunsigned int i;\r\nu64 temp = value;\r\nfor (i = 0; i < 3; i++) {\r\nint ret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0 + i,\r\ntemp & 0xffff);\r\nif (ret)\r\nreturn ret;\r\ntemp >>= 16;\r\n}\r\nreturn b53_mdio_op(dev, page, reg, REG_MII_ADDR_WRITE);\r\n}\r\nstatic int b53_mdio_write64(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\nunsigned int i;\r\nu64 temp = value;\r\nfor (i = 0; i < 4; i++) {\r\nint ret = mdiobus_write_nested(bus, BRCM_PSEUDO_PHY_ADDR,\r\nREG_MII_DATA0 + i,\r\ntemp & 0xffff);\r\nif (ret)\r\nreturn ret;\r\ntemp >>= 16;\r\n}\r\nreturn b53_mdio_op(dev, page, reg, REG_MII_ADDR_WRITE);\r\n}\r\nstatic int b53_mdio_phy_read16(struct b53_device *dev, int addr, int reg,\r\nu16 *value)\r\n{\r\nstruct mii_bus *bus = dev->priv;\r\n*value = mdiobus_read_nested(bus, addr, reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mdio_phy_write16(struct b53_device *dev, int addr, int reg,\r\nu16 value)\r\n{\r\nstruct mii_bus *bus = dev->bus;\r\nreturn mdiobus_write_nested(bus, addr, reg, value);\r\n}\r\nstatic int b53_mdio_probe(struct mdio_device *mdiodev)\r\n{\r\nstruct b53_device *dev;\r\nu32 phy_id;\r\nint ret;\r\nif (mdiodev->addr != BRCM_PSEUDO_PHY_ADDR && mdiodev->addr != 0) {\r\ndev_err(&mdiodev->dev, "leaving address %d to PHY\n",\r\nmdiodev->addr);\r\nreturn -ENODEV;\r\n}\r\nphy_id = mdiobus_read(mdiodev->bus, 0, 2) << 16;\r\nphy_id |= mdiobus_read(mdiodev->bus, 0, 3);\r\nif ((phy_id & 0xfffffc00) != B53_BRCM_OUI_1 &&\r\n(phy_id & 0xfffffc00) != B53_BRCM_OUI_2 &&\r\n(phy_id & 0xfffffc00) != B53_BRCM_OUI_3) {\r\ndev_err(&mdiodev->dev, "Unsupported device: 0x%08x\n", phy_id);\r\nreturn -ENODEV;\r\n}\r\nif (of_machine_is_compatible("brcm,bcm7445d0") &&\r\nstrcmp(mdiodev->bus->name, "sf2 slave mii"))\r\nreturn -EPROBE_DEFER;\r\ndev = b53_switch_alloc(&mdiodev->dev, &b53_mdio_ops, mdiodev->bus);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->current_page = 0xff;\r\ndev->bus = mdiodev->bus;\r\ndev_set_drvdata(&mdiodev->dev, dev);\r\nret = b53_switch_register(dev);\r\nif (ret) {\r\ndev_err(&mdiodev->dev, "failed to register switch: %i\n", ret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic void b53_mdio_remove(struct mdio_device *mdiodev)\r\n{\r\nstruct b53_device *dev = dev_get_drvdata(&mdiodev->dev);\r\nstruct dsa_switch *ds = dev->ds;\r\ndsa_unregister_switch(ds);\r\n}

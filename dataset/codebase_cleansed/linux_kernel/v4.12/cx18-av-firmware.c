static int cx18_av_verifyfw(struct cx18 *cx, const struct firmware *fw)\r\n{\r\nstruct v4l2_subdev *sd = &cx->av_state.sd;\r\nint ret = 0;\r\nconst u8 *data;\r\nu32 size;\r\nint addr;\r\nu32 expected, dl_control;\r\ndl_control = cx18_av_read4(cx, CXADEC_DL_CTL);\r\ndo {\r\ndl_control &= 0x00ffffff;\r\ndl_control |= 0x0f000000;\r\ncx18_av_write4_noretry(cx, CXADEC_DL_CTL, dl_control);\r\ndl_control = cx18_av_read4(cx, CXADEC_DL_CTL);\r\n} while ((dl_control & 0xff000000) != 0x0f000000);\r\nwhile (dl_control & 0x3fff)\r\ndl_control = cx18_av_read4(cx, CXADEC_DL_CTL);\r\ndata = fw->data;\r\nsize = fw->size;\r\nfor (addr = 0; addr < size; addr++) {\r\ndl_control &= 0xffff3fff;\r\nexpected = 0x0f000000 | ((u32)data[addr] << 16) | addr;\r\nif (expected != dl_control) {\r\nCX18_ERR_DEV(sd, "verification of %s firmware load failed: expected %#010x got %#010x\n",\r\nFWFILE, expected, dl_control);\r\nret = -EIO;\r\nbreak;\r\n}\r\ndl_control = cx18_av_read4(cx, CXADEC_DL_CTL);\r\n}\r\nif (ret == 0)\r\nCX18_INFO_DEV(sd, "verified load of %s firmware (%d bytes)\n",\r\nFWFILE, size);\r\nreturn ret;\r\n}\r\nint cx18_av_loadfw(struct cx18 *cx)\r\n{\r\nstruct v4l2_subdev *sd = &cx->av_state.sd;\r\nconst struct firmware *fw = NULL;\r\nu32 size;\r\nu32 u, v;\r\nconst u8 *ptr;\r\nint i;\r\nint retries1 = 0;\r\nif (request_firmware(&fw, FWFILE, &cx->pci_dev->dev) != 0) {\r\nCX18_ERR_DEV(sd, "unable to open firmware %s\n", FWFILE);\r\nreturn -EINVAL;\r\n}\r\nwhile (retries1 < 5) {\r\ncx18_av_write4_expect(cx, CXADEC_CHIP_CTRL, 0x00010000,\r\n0x00008430, 0xffffffff);\r\ncx18_av_write_expect(cx, CXADEC_STD_DET_CTL, 0xf6, 0xf6, 0xff);\r\ncx18_av_write4_expect(cx, 0x8100, 0x00010000,\r\n0x00008430, 0xffffffff);\r\ncx18_av_write4_noretry(cx, CXADEC_DL_CTL, 0x0F000000);\r\nptr = fw->data;\r\nsize = fw->size;\r\nfor (i = 0; i < size; i++) {\r\nu32 dl_control = 0x0F000000 | i | ((u32)ptr[i] << 16);\r\nu32 value = 0;\r\nint retries2;\r\nint unrec_err = 0;\r\nfor (retries2 = 0; retries2 < CX18_MAX_MMIO_WR_RETRIES;\r\nretries2++) {\r\ncx18_av_write4_noretry(cx, CXADEC_DL_CTL,\r\ndl_control);\r\nudelay(10);\r\nvalue = cx18_av_read4(cx, CXADEC_DL_CTL);\r\nif (value == dl_control)\r\nbreak;\r\nif ((value & 0x3F00) != (dl_control & 0x3F00)) {\r\nunrec_err = 1;\r\nbreak;\r\n}\r\n}\r\nif (unrec_err || retries2 >= CX18_MAX_MMIO_WR_RETRIES)\r\nbreak;\r\n}\r\nif (i == size)\r\nbreak;\r\nretries1++;\r\n}\r\nif (retries1 >= 5) {\r\nCX18_ERR_DEV(sd, "unable to load firmware %s\n", FWFILE);\r\nrelease_firmware(fw);\r\nreturn -EIO;\r\n}\r\ncx18_av_write4_expect(cx, CXADEC_DL_CTL,\r\n0x03000000 | fw->size, 0x03000000, 0x13000000);\r\nCX18_INFO_DEV(sd, "loaded %s firmware (%d bytes)\n", FWFILE, size);\r\nif (cx18_av_verifyfw(cx, fw) == 0)\r\ncx18_av_write4_expect(cx, CXADEC_DL_CTL,\r\n0x13000000 | fw->size, 0x13000000, 0x13000000);\r\ncx18_av_and_or4(cx, CXADEC_PIN_CTRL1, ~0, 0x78000);\r\ncx18_av_write4(cx, CXADEC_I2S_IN_CTL, 0x000000A0);\r\ncx18_av_write4(cx, CXADEC_I2S_OUT_CTL, 0x000001A0);\r\ncx18_av_write4(cx, CXADEC_PIN_CFG3, 0x5600B687);\r\ncx18_av_write4_expect(cx, CXADEC_STD_DET_CTL, 0x000000F6, 0x000000F6,\r\n0x3F00FFFF);\r\ncx18_av_write4(cx, 0x09CC, 1);\r\nv = cx18_read_reg(cx, CX18_AUDIO_ENABLE);\r\nif (v & 0x800)\r\ncx18_write_reg_expect(cx, v & 0xFFFFFBFF, CX18_AUDIO_ENABLE,\r\n0, 0x400);\r\nv = cx18_read_reg(cx, CX18_AUDIO_ENABLE);\r\nu = v & CX18_AI1_MUX_MASK;\r\nv &= ~CX18_AI1_MUX_MASK;\r\nif (u == CX18_AI1_MUX_843_I2S || u == CX18_AI1_MUX_INVALID) {\r\nv |= CX18_AI1_MUX_I2S1;\r\ncx18_write_reg_expect(cx, v | 0xb00, CX18_AUDIO_ENABLE,\r\nv, CX18_AI1_MUX_MASK);\r\nv = (v & ~CX18_AI1_MUX_MASK) | CX18_AI1_MUX_843_I2S;\r\n} else {\r\nv |= CX18_AI1_MUX_843_I2S;\r\ncx18_write_reg_expect(cx, v | 0xb00, CX18_AUDIO_ENABLE,\r\nv, CX18_AI1_MUX_MASK);\r\nv = (v & ~CX18_AI1_MUX_MASK) | u;\r\n}\r\ncx18_write_reg_expect(cx, v | 0xb00, CX18_AUDIO_ENABLE,\r\nv, CX18_AI1_MUX_MASK);\r\nv = cx18_av_read4(cx, CXADEC_STD_DET_CTL);\r\nv |= 0xFF;\r\nv |= 0x400;\r\nv |= 0x14000000;\r\ncx18_av_write4_expect(cx, CXADEC_STD_DET_CTL, v, v, 0x3F00FFFF);\r\nrelease_firmware(fw);\r\nreturn 0;\r\n}

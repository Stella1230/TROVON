static int get_sdram_rows(void)\r\n{\r\nstatic int sdram_rows;\r\nunsigned int drac2 = 0, drac0 = 0;\r\nu32 mdcnfg;\r\nif (sdram_rows)\r\nreturn sdram_rows;\r\nmdcnfg = readl_relaxed(MDCNFG);\r\nif (mdcnfg & (MDCNFG_DE2 | MDCNFG_DE3))\r\ndrac2 = MDCNFG_DRAC2(mdcnfg);\r\nif (mdcnfg & (MDCNFG_DE0 | MDCNFG_DE1))\r\ndrac0 = MDCNFG_DRAC0(mdcnfg);\r\nsdram_rows = 1 << (11 + max(drac0, drac2));\r\nreturn sdram_rows;\r\n}\r\nstatic u32 mdrefr_dri(unsigned int freq_khz)\r\n{\r\nu32 interval = freq_khz * SDRAM_TREF / get_sdram_rows();\r\nreturn (interval - 31) / 32;\r\n}\r\nunsigned int pxa27x_get_clk_frequency_khz(int info)\r\n{\r\nstruct clk *clk;\r\nunsigned long clks[5];\r\nint i;\r\nfor (i = 0; i < 5; i++) {\r\nclk = clk_get(NULL, get_freq_khz[i]);\r\nif (IS_ERR(clk)) {\r\nclks[i] = 0;\r\n} else {\r\nclks[i] = clk_get_rate(clk);\r\nclk_put(clk);\r\n}\r\n}\r\nif (info) {\r\npr_info("Run Mode clock: %ld.%02ldMHz\n",\r\nclks[1] / 1000000, (clks[1] % 1000000) / 10000);\r\npr_info("Turbo Mode clock: %ld.%02ldMHz\n",\r\nclks[2] / 1000000, (clks[2] % 1000000) / 10000);\r\npr_info("Memory clock: %ld.%02ldMHz\n",\r\nclks[3] / 1000000, (clks[3] % 1000000) / 10000);\r\npr_info("System bus clock: %ld.%02ldMHz\n",\r\nclks[4] / 1000000, (clks[4] % 1000000) / 10000);\r\n}\r\nreturn (unsigned int)clks[0] / KHz;\r\n}\r\nbool pxa27x_is_ppll_disabled(void)\r\n{\r\nunsigned long ccsr = readl(CCSR);\r\nreturn ccsr & (1 << CCCR_PPDIS_BIT);\r\n}\r\nstatic unsigned long clk_pxa27x_cpll_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long clkcfg;\r\nunsigned int t, ht;\r\nunsigned int l, L, n2, N;\r\nunsigned long ccsr = readl(CCSR);\r\nasm("mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nt = clkcfg & (1 << 0);\r\nht = clkcfg & (1 << 2);\r\nl = ccsr & CCSR_L_MASK;\r\nn2 = (ccsr & CCSR_N2_MASK) >> CCSR_N2_SHIFT;\r\nL = l * parent_rate;\r\nN = (L * n2) / 2;\r\nreturn N;\r\n}\r\nstatic int clk_pxa27x_cpll_determine_rate(struct clk_hw *hw,\r\nstruct clk_rate_request *req)\r\n{\r\nreturn pxa2xx_determine_rate(req, pxa27x_freqs,\r\nARRAY_SIZE(pxa27x_freqs));\r\n}\r\nstatic int clk_pxa27x_cpll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nint i;\r\npr_debug("%s(rate=%lu parent_rate=%lu)\n", __func__, rate, parent_rate);\r\nfor (i = 0; i < ARRAY_SIZE(pxa27x_freqs); i++)\r\nif (pxa27x_freqs[i].cpll == rate)\r\nbreak;\r\nif (i >= ARRAY_SIZE(pxa27x_freqs))\r\nreturn -EINVAL;\r\npxa2xx_cpll_change(&pxa27x_freqs[i], mdrefr_dri, MDREFR, CCCR);\r\nreturn 0;\r\n}\r\nstatic unsigned long clk_pxa27x_lcd_base_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned int l, osc_forced;\r\nunsigned long ccsr = readl(CCSR);\r\nunsigned long cccr = readl(CCCR);\r\nl = ccsr & CCSR_L_MASK;\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\nif (osc_forced) {\r\nif (cccr & (1 << CCCR_LCD_26_BIT))\r\nreturn parent_rate * 2;\r\nelse\r\nreturn parent_rate;\r\n}\r\nif (l <= 7)\r\nreturn parent_rate;\r\nif (l <= 16)\r\nreturn parent_rate / 2;\r\nreturn parent_rate / 4;\r\n}\r\nstatic u8 clk_pxa27x_lcd_base_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned int osc_forced;\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\nif (osc_forced)\r\nreturn PXA_LCD_13Mhz;\r\nelse\r\nreturn PXA_LCD_RUN;\r\n}\r\nstatic void __init pxa27x_register_plls(void)\r\n{\r\nclk_register_fixed_rate(NULL, "osc_13mhz", NULL,\r\nCLK_GET_RATE_NOCACHE,\r\n13 * MHz);\r\nclk_register_fixed_rate(NULL, "osc_32_768khz", NULL,\r\nCLK_GET_RATE_NOCACHE,\r\n32768 * KHz);\r\nclk_register_fixed_rate(NULL, "clk_dummy", NULL, 0, 0);\r\nclk_register_fixed_factor(NULL, "ppll_312mhz", "osc_13mhz", 0, 24, 1);\r\n}\r\nstatic u8 clk_pxa27x_core_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned long clkcfg;\r\nunsigned int t, ht, osc_forced;\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\nif (osc_forced)\r\nreturn PXA_CORE_13Mhz;\r\nasm("mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nt = clkcfg & (1 << 0);\r\nht = clkcfg & (1 << 2);\r\nif (ht || t)\r\nreturn PXA_CORE_TURBO;\r\nreturn PXA_CORE_RUN;\r\n}\r\nstatic int clk_pxa27x_core_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nif (index > PXA_CORE_TURBO)\r\nreturn -EINVAL;\r\npxa2xx_core_turbo_switch(index == PXA_CORE_TURBO);\r\nreturn 0;\r\n}\r\nstatic int clk_pxa27x_core_determine_rate(struct clk_hw *hw,\r\nstruct clk_rate_request *req)\r\n{\r\nreturn __clk_mux_determine_rate(hw, req);\r\n}\r\nstatic unsigned long clk_pxa27x_run_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long ccsr = readl(CCSR);\r\nunsigned int n2 = (ccsr & CCSR_N2_MASK) >> CCSR_N2_SHIFT;\r\nreturn (parent_rate / n2) * 2;\r\n}\r\nstatic void __init pxa27x_register_core(void)\r\n{\r\nclkdev_pxa_register(CLK_NONE, "cpll", NULL,\r\nclk_register_clk_pxa27x_cpll());\r\nclkdev_pxa_register(CLK_NONE, "run", NULL,\r\nclk_register_clk_pxa27x_run());\r\nclkdev_pxa_register(CLK_CORE, "core", NULL,\r\nclk_register_clk_pxa27x_core());\r\n}\r\nstatic unsigned long clk_pxa27x_system_bus_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long clkcfg;\r\nunsigned int b, osc_forced;\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\nasm("mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nb = clkcfg & (1 << 3);\r\nif (osc_forced)\r\nreturn parent_rate;\r\nif (b)\r\nreturn parent_rate;\r\nelse\r\nreturn parent_rate / 2;\r\n}\r\nstatic u8 clk_pxa27x_system_bus_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned int osc_forced;\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\nif (osc_forced)\r\nreturn PXA_BUS_13Mhz;\r\nelse\r\nreturn PXA_BUS_RUN;\r\n}\r\nstatic unsigned long clk_pxa27x_memory_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned int a, l, osc_forced;\r\nunsigned long cccr = readl(CCCR);\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\na = cccr & (1 << CCCR_A_BIT);\r\nl = ccsr & CCSR_L_MASK;\r\nif (osc_forced || a)\r\nreturn parent_rate;\r\nif (l <= 10)\r\nreturn parent_rate;\r\nif (l <= 20)\r\nreturn parent_rate / 2;\r\nreturn parent_rate / 4;\r\n}\r\nstatic u8 clk_pxa27x_memory_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned int osc_forced, a;\r\nunsigned long cccr = readl(CCCR);\r\nunsigned long ccsr = readl(CCSR);\r\nosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\r\na = cccr & (1 << CCCR_A_BIT);\r\nif (osc_forced)\r\nreturn PXA_MEM_13Mhz;\r\nif (a)\r\nreturn PXA_MEM_SYSTEM_BUS;\r\nelse\r\nreturn PXA_MEM_RUN;\r\n}\r\nstatic void __init pxa27x_dummy_clocks_init(void)\r\n{\r\nstruct clk *clk;\r\nstruct dummy_clk *d;\r\nconst char *name;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(dummy_clks); i++) {\r\nd = &dummy_clks[i];\r\nname = d->dev_id ? d->dev_id : d->con_id;\r\nclk = clk_register_fixed_factor(NULL, name, d->parent, 0, 1, 1);\r\nclk_register_clkdev(clk, d->con_id, d->dev_id);\r\n}\r\n}\r\nstatic void __init pxa27x_base_clocks_init(void)\r\n{\r\npxa27x_register_plls();\r\npxa27x_register_core();\r\nclkdev_pxa_register(CLK_NONE, "system_bus", NULL,\r\nclk_register_clk_pxa27x_system_bus());\r\nclkdev_pxa_register(CLK_NONE, "memory", NULL,\r\nclk_register_clk_pxa27x_memory());\r\nclk_register_clk_pxa27x_lcd_base();\r\n}\r\nint __init pxa27x_clocks_init(void)\r\n{\r\npxa27x_base_clocks_init();\r\npxa27x_dummy_clocks_init();\r\nreturn clk_pxa_cken_init(pxa27x_clocks, ARRAY_SIZE(pxa27x_clocks));\r\n}\r\nstatic void __init pxa27x_dt_clocks_init(struct device_node *np)\r\n{\r\npxa27x_clocks_init();\r\nclk_pxa_dt_common_init(np);\r\n}

struct gb_connection *to_fw_mgmt_connection(struct device *dev)\r\n{\r\nstruct gb_fw_core *fw_core = dev_get_drvdata(dev);\r\nreturn fw_core->mgmt_connection;\r\n}\r\nstatic int gb_fw_spi_connection_init(struct gb_connection *connection)\r\n{\r\nint ret;\r\nif (!connection)\r\nreturn 0;\r\nret = gb_connection_enable(connection);\r\nif (ret)\r\nreturn ret;\r\nret = gb_spilib_master_init(connection, &connection->bundle->dev,\r\nspilib_ops);\r\nif (ret) {\r\ngb_connection_disable(connection);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void gb_fw_spi_connection_exit(struct gb_connection *connection)\r\n{\r\nif (!connection)\r\nreturn;\r\ngb_spilib_master_exit(connection);\r\ngb_connection_disable(connection);\r\n}\r\nstatic int gb_fw_core_probe(struct gb_bundle *bundle,\r\nconst struct greybus_bundle_id *id)\r\n{\r\nstruct greybus_descriptor_cport *cport_desc;\r\nstruct gb_connection *connection;\r\nstruct gb_fw_core *fw_core;\r\nint ret, i;\r\nu16 cport_id;\r\nu8 protocol_id;\r\nfw_core = kzalloc(sizeof(*fw_core), GFP_KERNEL);\r\nif (!fw_core)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < bundle->num_cports; i++) {\r\ncport_desc = &bundle->cport_desc[i];\r\ncport_id = le16_to_cpu(cport_desc->id);\r\nprotocol_id = cport_desc->protocol_id;\r\nswitch (protocol_id) {\r\ncase GREYBUS_PROTOCOL_FW_MANAGEMENT:\r\nif (fw_core->mgmt_connection) {\r\ndev_err(&bundle->dev,\r\n"multiple management CPorts found\n");\r\nret = -EINVAL;\r\ngoto err_destroy_connections;\r\n}\r\nconnection = gb_connection_create(bundle, cport_id,\r\ngb_fw_mgmt_request_handler);\r\nif (IS_ERR(connection)) {\r\nret = PTR_ERR(connection);\r\ndev_err(&bundle->dev,\r\n"failed to create management connection (%d)\n",\r\nret);\r\ngoto err_destroy_connections;\r\n}\r\nfw_core->mgmt_connection = connection;\r\nbreak;\r\ncase GREYBUS_PROTOCOL_FW_DOWNLOAD:\r\nif (fw_core->download_connection) {\r\ndev_err(&bundle->dev,\r\n"multiple download CPorts found\n");\r\nret = -EINVAL;\r\ngoto err_destroy_connections;\r\n}\r\nconnection = gb_connection_create(bundle, cport_id,\r\ngb_fw_download_request_handler);\r\nif (IS_ERR(connection)) {\r\ndev_err(&bundle->dev, "failed to create download connection (%ld)\n",\r\nPTR_ERR(connection));\r\n} else {\r\nfw_core->download_connection = connection;\r\n}\r\nbreak;\r\ncase GREYBUS_PROTOCOL_SPI:\r\nif (fw_core->spi_connection) {\r\ndev_err(&bundle->dev,\r\n"multiple SPI CPorts found\n");\r\nret = -EINVAL;\r\ngoto err_destroy_connections;\r\n}\r\nconnection = gb_connection_create(bundle, cport_id,\r\nNULL);\r\nif (IS_ERR(connection)) {\r\ndev_err(&bundle->dev, "failed to create SPI connection (%ld)\n",\r\nPTR_ERR(connection));\r\n} else {\r\nfw_core->spi_connection = connection;\r\n}\r\nbreak;\r\ncase GREYBUS_PROTOCOL_AUTHENTICATION:\r\nif (fw_core->cap_connection) {\r\ndev_err(&bundle->dev, "multiple Authentication CPorts found\n");\r\nret = -EINVAL;\r\ngoto err_destroy_connections;\r\n}\r\nconnection = gb_connection_create(bundle, cport_id,\r\nNULL);\r\nif (IS_ERR(connection)) {\r\ndev_err(&bundle->dev, "failed to create Authentication connection (%ld)\n",\r\nPTR_ERR(connection));\r\n} else {\r\nfw_core->cap_connection = connection;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(&bundle->dev, "invalid protocol id (0x%02x)\n",\r\nprotocol_id);\r\nret = -EINVAL;\r\ngoto err_destroy_connections;\r\n}\r\n}\r\nif (!fw_core->mgmt_connection) {\r\ndev_err(&bundle->dev, "missing management connection\n");\r\nret = -ENODEV;\r\ngoto err_destroy_connections;\r\n}\r\nret = gb_fw_download_connection_init(fw_core->download_connection);\r\nif (ret) {\r\ndev_err(&bundle->dev, "failed to initialize firmware download connection, disable it (%d)\n",\r\nret);\r\ngb_connection_destroy(fw_core->download_connection);\r\nfw_core->download_connection = NULL;\r\n}\r\nret = gb_fw_spi_connection_init(fw_core->spi_connection);\r\nif (ret) {\r\ndev_err(&bundle->dev, "failed to initialize SPI connection, disable it (%d)\n",\r\nret);\r\ngb_connection_destroy(fw_core->spi_connection);\r\nfw_core->spi_connection = NULL;\r\n}\r\nret = gb_cap_connection_init(fw_core->cap_connection);\r\nif (ret) {\r\ndev_err(&bundle->dev, "failed to initialize CAP connection, disable it (%d)\n",\r\nret);\r\ngb_connection_destroy(fw_core->cap_connection);\r\nfw_core->cap_connection = NULL;\r\n}\r\nret = gb_fw_mgmt_connection_init(fw_core->mgmt_connection);\r\nif (ret) {\r\ndev_err(&bundle->dev, "failed to initialize firmware management connection, disable it (%d)\n",\r\nret);\r\ngoto err_exit_connections;\r\n}\r\ngreybus_set_drvdata(bundle, fw_core);\r\nif (!(bundle->intf->quirks & GB_INTERFACE_QUIRK_NO_PM))\r\ngb_pm_runtime_put_autosuspend(bundle);\r\nreturn 0;\r\nerr_exit_connections:\r\ngb_cap_connection_exit(fw_core->cap_connection);\r\ngb_fw_spi_connection_exit(fw_core->spi_connection);\r\ngb_fw_download_connection_exit(fw_core->download_connection);\r\nerr_destroy_connections:\r\ngb_connection_destroy(fw_core->mgmt_connection);\r\ngb_connection_destroy(fw_core->cap_connection);\r\ngb_connection_destroy(fw_core->spi_connection);\r\ngb_connection_destroy(fw_core->download_connection);\r\nkfree(fw_core);\r\nreturn ret;\r\n}\r\nstatic void gb_fw_core_disconnect(struct gb_bundle *bundle)\r\n{\r\nstruct gb_fw_core *fw_core = greybus_get_drvdata(bundle);\r\nint ret;\r\nif (!(bundle->intf->quirks & GB_INTERFACE_QUIRK_NO_PM)) {\r\nret = gb_pm_runtime_get_sync(bundle);\r\nif (ret)\r\ngb_pm_runtime_get_noresume(bundle);\r\n}\r\ngb_fw_mgmt_connection_exit(fw_core->mgmt_connection);\r\ngb_cap_connection_exit(fw_core->cap_connection);\r\ngb_fw_spi_connection_exit(fw_core->spi_connection);\r\ngb_fw_download_connection_exit(fw_core->download_connection);\r\ngb_connection_destroy(fw_core->mgmt_connection);\r\ngb_connection_destroy(fw_core->cap_connection);\r\ngb_connection_destroy(fw_core->spi_connection);\r\ngb_connection_destroy(fw_core->download_connection);\r\nkfree(fw_core);\r\n}\r\nstatic int fw_core_init(void)\r\n{\r\nint ret;\r\nret = fw_mgmt_init();\r\nif (ret) {\r\npr_err("Failed to initialize fw-mgmt core (%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = cap_init();\r\nif (ret) {\r\npr_err("Failed to initialize component authentication core (%d)\n",\r\nret);\r\ngoto fw_mgmt_exit;\r\n}\r\nret = greybus_register(&gb_fw_core_driver);\r\nif (ret)\r\ngoto cap_exit;\r\nreturn 0;\r\ncap_exit:\r\ncap_exit();\r\nfw_mgmt_exit:\r\nfw_mgmt_exit();\r\nreturn ret;\r\n}\r\nstatic void __exit fw_core_exit(void)\r\n{\r\ngreybus_deregister(&gb_fw_core_driver);\r\ncap_exit();\r\nfw_mgmt_exit();\r\n}

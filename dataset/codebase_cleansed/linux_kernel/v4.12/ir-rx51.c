static inline void ir_rx51_on(struct ir_rx51 *ir_rx51)\r\n{\r\npwm_enable(ir_rx51->pwm);\r\n}\r\nstatic inline void ir_rx51_off(struct ir_rx51 *ir_rx51)\r\n{\r\npwm_disable(ir_rx51->pwm);\r\n}\r\nstatic int init_timing_params(struct ir_rx51 *ir_rx51)\r\n{\r\nstruct pwm_device *pwm = ir_rx51->pwm;\r\nint duty, period = DIV_ROUND_CLOSEST(NSEC_PER_SEC, ir_rx51->freq);\r\nduty = DIV_ROUND_CLOSEST(ir_rx51->duty_cycle * period, 100);\r\npwm_config(pwm, duty, period);\r\nreturn 0;\r\n}\r\nstatic enum hrtimer_restart ir_rx51_timer_cb(struct hrtimer *timer)\r\n{\r\nstruct ir_rx51 *ir_rx51 = container_of(timer, struct ir_rx51, timer);\r\nktime_t now;\r\nif (ir_rx51->wbuf_index < 0) {\r\ndev_err_ratelimited(ir_rx51->dev,\r\n"BUG wbuf_index has value of %i\n",\r\nir_rx51->wbuf_index);\r\ngoto end;\r\n}\r\ndo {\r\nu64 ns;\r\nif (ir_rx51->wbuf_index >= WBUF_LEN)\r\ngoto end;\r\nif (ir_rx51->wbuf[ir_rx51->wbuf_index] == -1)\r\ngoto end;\r\nif (ir_rx51->wbuf_index % 2)\r\nir_rx51_off(ir_rx51);\r\nelse\r\nir_rx51_on(ir_rx51);\r\nns = US_TO_NS(ir_rx51->wbuf[ir_rx51->wbuf_index]);\r\nhrtimer_add_expires_ns(timer, ns);\r\nir_rx51->wbuf_index++;\r\nnow = timer->base->get_time();\r\n} while (hrtimer_get_expires_tv64(timer) < now);\r\nreturn HRTIMER_RESTART;\r\nend:\r\nir_rx51_off(ir_rx51);\r\nir_rx51->wbuf_index = -1;\r\nwake_up_interruptible(&ir_rx51->wqueue);\r\nreturn HRTIMER_NORESTART;\r\n}\r\nstatic int ir_rx51_tx(struct rc_dev *dev, unsigned int *buffer,\r\nunsigned int count)\r\n{\r\nstruct ir_rx51 *ir_rx51 = dev->priv;\r\nif (count > WBUF_LEN)\r\nreturn -EINVAL;\r\nmemcpy(ir_rx51->wbuf, buffer, count * sizeof(unsigned int));\r\nwait_event_interruptible(ir_rx51->wqueue, ir_rx51->wbuf_index < 0);\r\ninit_timing_params(ir_rx51);\r\nif (count < WBUF_LEN)\r\nir_rx51->wbuf[count] = -1;\r\nir_rx51->pdata->set_max_mpu_wakeup_lat(ir_rx51->dev, 50);\r\nir_rx51_on(ir_rx51);\r\nir_rx51->wbuf_index = 1;\r\nhrtimer_start(&ir_rx51->timer,\r\nns_to_ktime(US_TO_NS(ir_rx51->wbuf[0])),\r\nHRTIMER_MODE_REL);\r\nwait_event_interruptible(ir_rx51->wqueue, ir_rx51->wbuf_index < 0);\r\nir_rx51->pdata->set_max_mpu_wakeup_lat(ir_rx51->dev, -1);\r\nreturn count;\r\n}\r\nstatic int ir_rx51_open(struct rc_dev *dev)\r\n{\r\nstruct ir_rx51 *ir_rx51 = dev->priv;\r\nif (test_and_set_bit(1, &ir_rx51->device_is_open))\r\nreturn -EBUSY;\r\nir_rx51->pwm = pwm_get(ir_rx51->dev, NULL);\r\nif (IS_ERR(ir_rx51->pwm)) {\r\nint res = PTR_ERR(ir_rx51->pwm);\r\ndev_err(ir_rx51->dev, "pwm_get failed: %d\n", res);\r\nreturn res;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ir_rx51_release(struct rc_dev *dev)\r\n{\r\nstruct ir_rx51 *ir_rx51 = dev->priv;\r\nhrtimer_cancel(&ir_rx51->timer);\r\nir_rx51_off(ir_rx51);\r\npwm_put(ir_rx51->pwm);\r\nclear_bit(1, &ir_rx51->device_is_open);\r\n}\r\nstatic int ir_rx51_set_duty_cycle(struct rc_dev *dev, u32 duty)\r\n{\r\nstruct ir_rx51 *ir_rx51 = dev->priv;\r\nir_rx51->duty_cycle = duty;\r\nreturn 0;\r\n}\r\nstatic int ir_rx51_set_tx_carrier(struct rc_dev *dev, u32 carrier)\r\n{\r\nstruct ir_rx51 *ir_rx51 = dev->priv;\r\nif (carrier > 500000 || carrier < 20000)\r\nreturn -EINVAL;\r\nir_rx51->freq = carrier;\r\nreturn 0;\r\n}\r\nstatic int ir_rx51_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nif (test_and_set_bit(1, &ir_rx51.device_is_open))\r\nreturn -EAGAIN;\r\nclear_bit(1, &ir_rx51.device_is_open);\r\nreturn 0;\r\n}\r\nstatic int ir_rx51_resume(struct platform_device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int ir_rx51_probe(struct platform_device *dev)\r\n{\r\nstruct pwm_device *pwm;\r\nstruct rc_dev *rcdev;\r\nir_rx51.pdata = dev->dev.platform_data;\r\nif (!ir_rx51.pdata) {\r\ndev_err(&dev->dev, "Platform Data is missing\n");\r\nreturn -ENXIO;\r\n}\r\npwm = pwm_get(&dev->dev, NULL);\r\nif (IS_ERR(pwm)) {\r\nint err = PTR_ERR(pwm);\r\nif (err != -EPROBE_DEFER)\r\ndev_err(&dev->dev, "pwm_get failed: %d\n", err);\r\nreturn err;\r\n}\r\nir_rx51.freq = DIV_ROUND_CLOSEST(pwm_get_period(pwm), NSEC_PER_SEC);\r\npwm_put(pwm);\r\nhrtimer_init(&ir_rx51.timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\nir_rx51.timer.function = ir_rx51_timer_cb;\r\nir_rx51.dev = &dev->dev;\r\nrcdev = devm_rc_allocate_device(&dev->dev, RC_DRIVER_IR_RAW_TX);\r\nif (!rcdev)\r\nreturn -ENOMEM;\r\nrcdev->priv = &ir_rx51;\r\nrcdev->open = ir_rx51_open;\r\nrcdev->close = ir_rx51_release;\r\nrcdev->tx_ir = ir_rx51_tx;\r\nrcdev->s_tx_duty_cycle = ir_rx51_set_duty_cycle;\r\nrcdev->s_tx_carrier = ir_rx51_set_tx_carrier;\r\nrcdev->driver_name = KBUILD_MODNAME;\r\nir_rx51.rcdev = rcdev;\r\nreturn devm_rc_register_device(&dev->dev, ir_rx51.rcdev);\r\n}\r\nstatic int ir_rx51_remove(struct platform_device *dev)\r\n{\r\nreturn 0;\r\n}

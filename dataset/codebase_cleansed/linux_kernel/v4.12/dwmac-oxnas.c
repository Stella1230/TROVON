static int oxnas_dwmac_init(struct platform_device *pdev, void *priv)\r\n{\r\nstruct oxnas_dwmac *dwmac = priv;\r\nunsigned int value;\r\nint ret;\r\nret = device_reset(dwmac->dev);\r\nif (ret)\r\nreturn ret;\r\nret = clk_prepare_enable(dwmac->clk);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_read(dwmac->regmap, OXNAS_DWMAC_CTRL_REGOFFSET, &value);\r\nif (ret < 0) {\r\nclk_disable_unprepare(dwmac->clk);\r\nreturn ret;\r\n}\r\nvalue |= BIT(DWMAC_CKEN_GTX) |\r\nBIT(DWMAC_SIMPLE_MUX) |\r\nBIT(DWMAC_AUTO_TX_SOURCE) |\r\nBIT(DWMAC_CKEN_TX_OUT) |\r\nBIT(DWMAC_CKEN_TXN_OUT) |\r\nBIT(DWMAC_CKEN_TX_IN) |\r\nBIT(DWMAC_CKEN_RX_OUT) |\r\nBIT(DWMAC_CKEN_RXN_OUT) |\r\nBIT(DWMAC_CKEN_RX_IN);\r\nregmap_write(dwmac->regmap, OXNAS_DWMAC_CTRL_REGOFFSET, value);\r\nvalue = DWMAC_TX_VARDELAY(4) |\r\nDWMAC_TXN_VARDELAY(2) |\r\nDWMAC_RX_VARDELAY(10) |\r\nDWMAC_RXN_VARDELAY(8);\r\nregmap_write(dwmac->regmap, OXNAS_DWMAC_DELAY_REGOFFSET, value);\r\nreturn 0;\r\n}\r\nstatic void oxnas_dwmac_exit(struct platform_device *pdev, void *priv)\r\n{\r\nstruct oxnas_dwmac *dwmac = priv;\r\nclk_disable_unprepare(dwmac->clk);\r\n}\r\nstatic int oxnas_dwmac_probe(struct platform_device *pdev)\r\n{\r\nstruct plat_stmmacenet_data *plat_dat;\r\nstruct stmmac_resources stmmac_res;\r\nstruct oxnas_dwmac *dwmac;\r\nint ret;\r\nret = stmmac_get_platform_resources(pdev, &stmmac_res);\r\nif (ret)\r\nreturn ret;\r\nplat_dat = stmmac_probe_config_dt(pdev, &stmmac_res.mac);\r\nif (IS_ERR(plat_dat))\r\nreturn PTR_ERR(plat_dat);\r\ndwmac = devm_kzalloc(&pdev->dev, sizeof(*dwmac), GFP_KERNEL);\r\nif (!dwmac) {\r\nret = -ENOMEM;\r\ngoto err_remove_config_dt;\r\n}\r\ndwmac->dev = &pdev->dev;\r\nplat_dat->bsp_priv = dwmac;\r\nplat_dat->init = oxnas_dwmac_init;\r\nplat_dat->exit = oxnas_dwmac_exit;\r\ndwmac->regmap = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\r\n"oxsemi,sys-ctrl");\r\nif (IS_ERR(dwmac->regmap)) {\r\ndev_err(&pdev->dev, "failed to have sysctrl regmap\n");\r\nret = PTR_ERR(dwmac->regmap);\r\ngoto err_remove_config_dt;\r\n}\r\ndwmac->clk = devm_clk_get(&pdev->dev, "gmac");\r\nif (IS_ERR(dwmac->clk)) {\r\nret = PTR_ERR(dwmac->clk);\r\ngoto err_remove_config_dt;\r\n}\r\nret = oxnas_dwmac_init(pdev, plat_dat->bsp_priv);\r\nif (ret)\r\ngoto err_remove_config_dt;\r\nret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\r\nif (ret)\r\ngoto err_dwmac_exit;\r\nreturn 0;\r\nerr_dwmac_exit:\r\noxnas_dwmac_exit(pdev, plat_dat->bsp_priv);\r\nerr_remove_config_dt:\r\nstmmac_remove_config_dt(pdev, plat_dat);\r\nreturn ret;\r\n}

int cbe_cpufreq_set_pmode_pmi(int cpu, unsigned int pmode)\r\n{\r\nint ret;\r\npmi_message_t pmi_msg;\r\n#ifdef DEBUG\r\nlong time;\r\n#endif\r\npmi_msg.type = PMI_TYPE_FREQ_CHANGE;\r\npmi_msg.data1 = cbe_cpu_to_node(cpu);\r\npmi_msg.data2 = pmode;\r\n#ifdef DEBUG\r\ntime = jiffies;\r\n#endif\r\npmi_send_message(pmi_msg);\r\n#ifdef DEBUG\r\ntime = jiffies - time;\r\ntime = jiffies_to_msecs(time);\r\npr_debug("had to wait %lu ms for a transition using " \\r\n"PMI\n", time);\r\n#endif\r\nret = pmi_msg.data2;\r\npr_debug("PMI returned slow mode %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void cbe_cpufreq_handle_pmi(pmi_message_t pmi_msg)\r\n{\r\nu8 node, slow_mode;\r\nBUG_ON(pmi_msg.type != PMI_TYPE_FREQ_CHANGE);\r\nnode = pmi_msg.data1;\r\nslow_mode = pmi_msg.data2;\r\npmi_slow_mode_limit[node] = slow_mode;\r\npr_debug("cbe_handle_pmi: node: %d max_freq: %d\n", node, slow_mode);\r\n}\r\nstatic int pmi_notifier(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct cpufreq_policy *policy = data;\r\nstruct cpufreq_frequency_table *cbe_freqs = policy->freq_table;\r\nu8 node;\r\nnode = cbe_cpu_to_node(policy->cpu);\r\npr_debug("got notified, event=%lu, node=%u\n", event, node);\r\nif (pmi_slow_mode_limit[node] != 0) {\r\npr_debug("limiting node %d to slow mode %d\n",\r\nnode, pmi_slow_mode_limit[node]);\r\ncpufreq_verify_within_limits(policy, 0,\r\ncbe_freqs[pmi_slow_mode_limit[node]].frequency);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init cbe_cpufreq_pmi_init(void)\r\n{\r\ncbe_cpufreq_has_pmi = pmi_register_handler(&cbe_pmi_handler) == 0;\r\nif (!cbe_cpufreq_has_pmi)\r\nreturn -ENODEV;\r\ncpufreq_register_notifier(&pmi_notifier_block, CPUFREQ_POLICY_NOTIFIER);\r\nreturn 0;\r\n}

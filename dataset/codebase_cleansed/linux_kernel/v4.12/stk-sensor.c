static int stk_sensor_outb(struct stk_camera *dev, u8 reg, u8 val)\r\n{\r\nint i = 0;\r\nu8 tmpval = 0;\r\nif (stk_camera_write_reg(dev, STK_IIC_TX_INDEX, reg))\r\nreturn 1;\r\nif (stk_camera_write_reg(dev, STK_IIC_TX_VALUE, val))\r\nreturn 1;\r\nif (stk_camera_write_reg(dev, STK_IIC_OP, STK_IIC_OP_TX))\r\nreturn 1;\r\ndo {\r\nif (stk_camera_read_reg(dev, STK_IIC_STAT, &tmpval))\r\nreturn 1;\r\ni++;\r\n} while (tmpval == 0 && i < MAX_RETRIES);\r\nif (tmpval != STK_IIC_STAT_TX_OK) {\r\nif (tmpval)\r\nSTK_ERROR("stk_sensor_outb failed, status=0x%02x\n",\r\ntmpval);\r\nreturn 1;\r\n} else\r\nreturn 0;\r\n}\r\nstatic int stk_sensor_inb(struct stk_camera *dev, u8 reg, u8 *val)\r\n{\r\nint i = 0;\r\nu8 tmpval = 0;\r\nif (stk_camera_write_reg(dev, STK_IIC_RX_INDEX, reg))\r\nreturn 1;\r\nif (stk_camera_write_reg(dev, STK_IIC_OP, STK_IIC_OP_RX))\r\nreturn 1;\r\ndo {\r\nif (stk_camera_read_reg(dev, STK_IIC_STAT, &tmpval))\r\nreturn 1;\r\ni++;\r\n} while (tmpval == 0 && i < MAX_RETRIES);\r\nif (tmpval != STK_IIC_STAT_RX_OK) {\r\nif (tmpval)\r\nSTK_ERROR("stk_sensor_inb failed, status=0x%02x\n",\r\ntmpval);\r\nreturn 1;\r\n}\r\nif (stk_camera_read_reg(dev, STK_IIC_RX_VALUE, &tmpval))\r\nreturn 1;\r\n*val = tmpval;\r\nreturn 0;\r\n}\r\nstatic int stk_sensor_write_regvals(struct stk_camera *dev,\r\nstruct regval *rv)\r\n{\r\nint ret;\r\nif (rv == NULL)\r\nreturn 0;\r\nwhile (rv->reg != 0xff || rv->val != 0xff) {\r\nret = stk_sensor_outb(dev, rv->reg, rv->val);\r\nif (ret != 0)\r\nreturn ret;\r\nrv++;\r\n}\r\nreturn 0;\r\n}\r\nint stk_sensor_sleep(struct stk_camera *dev)\r\n{\r\nu8 tmp;\r\nreturn stk_sensor_inb(dev, REG_COM2, &tmp)\r\n|| stk_sensor_outb(dev, REG_COM2, tmp|COM2_SSLEEP);\r\n}\r\nint stk_sensor_wakeup(struct stk_camera *dev)\r\n{\r\nu8 tmp;\r\nreturn stk_sensor_inb(dev, REG_COM2, &tmp)\r\n|| stk_sensor_outb(dev, REG_COM2, tmp&~COM2_SSLEEP);\r\n}\r\nint stk_sensor_init(struct stk_camera *dev)\r\n{\r\nu8 idl = 0;\r\nu8 idh = 0;\r\nif (stk_camera_write_reg(dev, STK_IIC_ENABLE, STK_IIC_ENABLE_YES)\r\n|| stk_camera_write_reg(dev, STK_IIC_ADDR, SENSOR_ADDRESS)\r\n|| stk_sensor_outb(dev, REG_COM7, COM7_RESET)) {\r\nSTK_ERROR("Sensor resetting failed\n");\r\nreturn -ENODEV;\r\n}\r\nmsleep(10);\r\nif (stk_sensor_inb(dev, REG_MIDH, &idh)\r\n|| stk_sensor_inb(dev, REG_MIDL, &idl)) {\r\nSTK_ERROR("Strange error reading sensor ID\n");\r\nreturn -ENODEV;\r\n}\r\nif (idh != 0x7f || idl != 0xa2) {\r\nSTK_ERROR("Huh? you don't have a sensor from ovt\n");\r\nreturn -ENODEV;\r\n}\r\nif (stk_sensor_inb(dev, REG_PID, &idh)\r\n|| stk_sensor_inb(dev, REG_VER, &idl)) {\r\nSTK_ERROR("Could not read sensor model\n");\r\nreturn -ENODEV;\r\n}\r\nstk_sensor_write_regvals(dev, ov_initvals);\r\nmsleep(10);\r\nSTK_INFO("OmniVision sensor detected, id %02X%02X at address %x\n",\r\nidh, idl, SENSOR_ADDRESS);\r\nreturn 0;\r\n}\r\nstatic int stk_sensor_set_hw(struct stk_camera *dev,\r\nint hstart, int hstop, int vstart, int vstop)\r\n{\r\nint ret;\r\nunsigned char v;\r\nret = stk_sensor_outb(dev, REG_HSTART, (hstart >> 3) & 0xff);\r\nret += stk_sensor_outb(dev, REG_HSTOP, (hstop >> 3) & 0xff);\r\nret += stk_sensor_inb(dev, REG_HREF, &v);\r\nv = (v & 0xc0) | ((hstop & 0x7) << 3) | (hstart & 0x7);\r\nmsleep(10);\r\nret += stk_sensor_outb(dev, REG_HREF, v);\r\nret += stk_sensor_outb(dev, REG_VSTART, (vstart >> 3) & 0xff);\r\nret += stk_sensor_outb(dev, REG_VSTOP, (vstop >> 3) & 0xff);\r\nret += stk_sensor_inb(dev, REG_VREF, &v);\r\nv = (v & 0xc0) | ((vstop & 0x7) << 3) | (vstart & 0x7);\r\nmsleep(10);\r\nret += stk_sensor_outb(dev, REG_VREF, v);\r\nreturn ret;\r\n}\r\nint stk_sensor_configure(struct stk_camera *dev)\r\n{\r\nint com7;\r\nunsigned dummylines;\r\nint flip;\r\nstruct regval *rv;\r\nswitch (dev->vsettings.mode) {\r\ncase MODE_QCIF: com7 = COM7_FMT_QCIF;\r\ndummylines = 604;\r\nbreak;\r\ncase MODE_QVGA: com7 = COM7_FMT_QVGA;\r\ndummylines = 267;\r\nbreak;\r\ncase MODE_CIF: com7 = COM7_FMT_CIF;\r\ndummylines = 412;\r\nbreak;\r\ncase MODE_VGA: com7 = COM7_FMT_VGA;\r\ndummylines = 11;\r\nbreak;\r\ncase MODE_SXGA: com7 = COM7_FMT_SXGA;\r\ndummylines = 0;\r\nbreak;\r\ndefault: STK_ERROR("Unsupported mode %d\n", dev->vsettings.mode);\r\nreturn -EFAULT;\r\n}\r\nswitch (dev->vsettings.palette) {\r\ncase V4L2_PIX_FMT_UYVY:\r\ncom7 |= COM7_YUV;\r\nrv = ov_fmt_uyvy;\r\nbreak;\r\ncase V4L2_PIX_FMT_YUYV:\r\ncom7 |= COM7_YUV;\r\nrv = ov_fmt_yuyv;\r\nbreak;\r\ncase V4L2_PIX_FMT_RGB565:\r\ncom7 |= COM7_RGB;\r\nrv = ov_fmt_rgbp;\r\nbreak;\r\ncase V4L2_PIX_FMT_RGB565X:\r\ncom7 |= COM7_RGB;\r\nrv = ov_fmt_rgbr;\r\nbreak;\r\ncase V4L2_PIX_FMT_SBGGR8:\r\ncom7 |= COM7_PBAYER;\r\nrv = ov_fmt_bayer;\r\nbreak;\r\ndefault: STK_ERROR("Unsupported colorspace\n");\r\nreturn -EFAULT;\r\n}\r\nstk_sensor_outb(dev, REG_COM7, com7);\r\nmsleep(50);\r\nstk_sensor_write_regvals(dev, rv);\r\nflip = (dev->vsettings.vflip?MVFP_FLIP:0)\r\n| (dev->vsettings.hflip?MVFP_MIRROR:0);\r\nstk_sensor_outb(dev, REG_MVFP, flip);\r\nif (dev->vsettings.palette == V4L2_PIX_FMT_SBGGR8\r\n&& !dev->vsettings.vflip)\r\nstk_sensor_outb(dev, REG_TSLB, 0x08);\r\nstk_sensor_outb(dev, REG_ADVFH, dummylines >> 8);\r\nstk_sensor_outb(dev, REG_ADVFL, dummylines & 0xff);\r\nmsleep(50);\r\nswitch (dev->vsettings.mode) {\r\ncase MODE_VGA:\r\nif (stk_sensor_set_hw(dev, 302, 1582, 6, 486))\r\nSTK_ERROR("stk_sensor_set_hw failed (VGA)\n");\r\nbreak;\r\ncase MODE_SXGA:\r\ncase MODE_CIF:\r\ncase MODE_QVGA:\r\ncase MODE_QCIF:\r\nbreak;\r\n}\r\nmsleep(10);\r\nreturn 0;\r\n}\r\nint stk_sensor_set_brightness(struct stk_camera *dev, int br)\r\n{\r\nif (br < 0 || br > 0xff)\r\nreturn -EINVAL;\r\nstk_sensor_outb(dev, REG_AEB, max(0x00, br - 6));\r\nstk_sensor_outb(dev, REG_AEW, min(0xff, br + 6));\r\nreturn 0;\r\n}

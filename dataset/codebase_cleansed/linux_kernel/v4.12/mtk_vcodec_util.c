void __iomem *mtk_vcodec_get_reg_addr(struct mtk_vcodec_ctx *data,\r\nunsigned int reg_idx)\r\n{\r\nstruct mtk_vcodec_ctx *ctx = (struct mtk_vcodec_ctx *)data;\r\nif (!data || reg_idx >= NUM_MAX_VCODEC_REG_BASE) {\r\nmtk_v4l2_err("Invalid arguments, reg_idx=%d", reg_idx);\r\nreturn NULL;\r\n}\r\nreturn ctx->dev->reg_base[reg_idx];\r\n}\r\nint mtk_vcodec_mem_alloc(struct mtk_vcodec_ctx *data,\r\nstruct mtk_vcodec_mem *mem)\r\n{\r\nunsigned long size = mem->size;\r\nstruct mtk_vcodec_ctx *ctx = (struct mtk_vcodec_ctx *)data;\r\nstruct device *dev = &ctx->dev->plat_dev->dev;\r\nmem->va = dma_alloc_coherent(dev, size, &mem->dma_addr, GFP_KERNEL);\r\nif (!mem->va) {\r\nmtk_v4l2_err("%s dma_alloc size=%ld failed!", dev_name(dev),\r\nsize);\r\nreturn -ENOMEM;\r\n}\r\nmemset(mem->va, 0, size);\r\nmtk_v4l2_debug(3, "[%d] - va = %p", ctx->id, mem->va);\r\nmtk_v4l2_debug(3, "[%d] - dma = 0x%lx", ctx->id,\r\n(unsigned long)mem->dma_addr);\r\nmtk_v4l2_debug(3, "[%d] size = 0x%lx", ctx->id, size);\r\nreturn 0;\r\n}\r\nvoid mtk_vcodec_mem_free(struct mtk_vcodec_ctx *data,\r\nstruct mtk_vcodec_mem *mem)\r\n{\r\nunsigned long size = mem->size;\r\nstruct mtk_vcodec_ctx *ctx = (struct mtk_vcodec_ctx *)data;\r\nstruct device *dev = &ctx->dev->plat_dev->dev;\r\nif (!mem->va) {\r\nmtk_v4l2_err("%s dma_free size=%ld failed!", dev_name(dev),\r\nsize);\r\nreturn;\r\n}\r\nmtk_v4l2_debug(3, "[%d] - va = %p", ctx->id, mem->va);\r\nmtk_v4l2_debug(3, "[%d] - dma = 0x%lx", ctx->id,\r\n(unsigned long)mem->dma_addr);\r\nmtk_v4l2_debug(3, "[%d] size = 0x%lx", ctx->id, size);\r\ndma_free_coherent(dev, size, mem->va, mem->dma_addr);\r\nmem->va = NULL;\r\nmem->dma_addr = 0;\r\nmem->size = 0;\r\n}\r\nvoid mtk_vcodec_set_curr_ctx(struct mtk_vcodec_dev *dev,\r\nstruct mtk_vcodec_ctx *ctx)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\ndev->curr_ctx = ctx;\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\n}\r\nstruct mtk_vcodec_ctx *mtk_vcodec_get_curr_ctx(struct mtk_vcodec_dev *dev)\r\n{\r\nunsigned long flags;\r\nstruct mtk_vcodec_ctx *ctx;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nctx = dev->curr_ctx;\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn ctx;\r\n}

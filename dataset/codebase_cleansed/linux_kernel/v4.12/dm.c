void rtl8821ae_dm_txpower_track_adjust(struct ieee80211_hw *hw,\r\nu8 type, u8 *pdirection,\r\nu32 *poutwrite_val)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nu8 pwr_val = 0;\r\nif (type == 0) {\r\nif (rtlpriv->dm.swing_idx_ofdm[RF90_PATH_A] <=\r\nrtlpriv->dm.swing_idx_ofdm_base[RF90_PATH_A]) {\r\n*pdirection = 1;\r\npwr_val = rtldm->swing_idx_ofdm_base[RF90_PATH_A] -\r\nrtldm->swing_idx_ofdm[RF90_PATH_A];\r\n} else {\r\n*pdirection = 2;\r\npwr_val = rtldm->swing_idx_ofdm[RF90_PATH_A] -\r\nrtldm->swing_idx_ofdm_base[RF90_PATH_A];\r\n}\r\n} else if (type == 1) {\r\nif (rtldm->swing_idx_cck <= rtldm->swing_idx_cck_base) {\r\n*pdirection = 1;\r\npwr_val = rtldm->swing_idx_cck_base -\r\nrtldm->swing_idx_cck;\r\n} else {\r\n*pdirection = 2;\r\npwr_val = rtldm->swing_idx_cck -\r\nrtldm->swing_idx_cck_base;\r\n}\r\n}\r\nif (pwr_val >= TXPWRTRACK_MAX_IDX && (*pdirection == 1))\r\npwr_val = TXPWRTRACK_MAX_IDX;\r\n*poutwrite_val = pwr_val | (pwr_val << 8)|\r\n(pwr_val << 16)|\r\n(pwr_val << 24);\r\n}\r\nvoid rtl8821ae_dm_clear_txpower_tracking_state(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtlpriv);\r\nu8 p = 0;\r\nrtldm->swing_idx_cck_base = rtldm->default_cck_index;\r\nrtldm->swing_idx_cck = rtldm->default_cck_index;\r\nrtldm->cck_index = 0;\r\nfor (p = RF90_PATH_A; p <= RF90_PATH_B; ++p) {\r\nrtldm->swing_idx_ofdm_base[p] = rtldm->default_ofdm_index;\r\nrtldm->swing_idx_ofdm[p] = rtldm->default_ofdm_index;\r\nrtldm->ofdm_index[p] = rtldm->default_ofdm_index;\r\nrtldm->power_index_offset[p] = 0;\r\nrtldm->delta_power_index[p] = 0;\r\nrtldm->delta_power_index_last[p] = 0;\r\nrtldm->absolute_ofdm_swing_idx[p] = 0;\r\nrtldm->remnant_ofdm_swing_idx[p] = 0;\r\n}\r\nrtldm->modify_txagc_flag_path_a = false;\r\nrtldm->modify_txagc_flag_path_b = false;\r\nrtldm->remnant_cck_idx = 0;\r\nrtldm->thermalvalue = rtlefuse->eeprom_thermalmeter;\r\nrtldm->thermalvalue_iqk = rtlefuse->eeprom_thermalmeter;\r\nrtldm->thermalvalue_lck = rtlefuse->eeprom_thermalmeter;\r\n}\r\nstatic u8 rtl8821ae_dm_get_swing_index(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu8 i = 0;\r\nu32 bb_swing;\r\nbb_swing = phy_get_tx_swing_8812A(hw, rtlhal->current_bandtype,\r\nRF90_PATH_A);\r\nfor (i = 0; i < TXSCALE_TABLE_SIZE; ++i)\r\nif (bb_swing == rtl8821ae_txscaling_table[i])\r\nbreak;\r\nreturn i;\r\n}\r\nvoid rtl8821ae_dm_initialize_txpower_tracking_thermalmeter(\r\nstruct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtlpriv);\r\nu8 default_swing_index = 0;\r\nu8 p = 0;\r\nrtlpriv->dm.txpower_track_control = true;\r\nrtldm->thermalvalue = rtlefuse->eeprom_thermalmeter;\r\nrtldm->thermalvalue_iqk = rtlefuse->eeprom_thermalmeter;\r\nrtldm->thermalvalue_lck = rtlefuse->eeprom_thermalmeter;\r\ndefault_swing_index = rtl8821ae_dm_get_swing_index(hw);\r\nrtldm->default_ofdm_index =\r\n(default_swing_index == TXSCALE_TABLE_SIZE) ?\r\n24 : default_swing_index;\r\nrtldm->default_cck_index = 24;\r\nrtldm->swing_idx_cck_base = rtldm->default_cck_index;\r\nrtldm->cck_index = rtldm->default_cck_index;\r\nfor (p = RF90_PATH_A; p < MAX_RF_PATH; ++p) {\r\nrtldm->swing_idx_ofdm_base[p] =\r\nrtldm->default_ofdm_index;\r\nrtldm->ofdm_index[p] = rtldm->default_ofdm_index;\r\nrtldm->delta_power_index[p] = 0;\r\nrtldm->power_index_offset[p] = 0;\r\nrtldm->delta_power_index_last[p] = 0;\r\n}\r\n}\r\nvoid rtl8821ae_dm_init_edca_turbo(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nrtlpriv->dm.current_turbo_edca = false;\r\nrtlpriv->dm.is_any_nonbepkts = false;\r\nrtlpriv->dm.is_cur_rdlstate = false;\r\n}\r\nvoid rtl8821ae_dm_init_rate_adaptive_mask(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rate_adaptive *p_ra = &rtlpriv->ra;\r\np_ra->ratr_state = DM_RATR_STA_INIT;\r\np_ra->pre_ratr_state = DM_RATR_STA_INIT;\r\nrtlpriv->dm.dm_type = DM_TYPE_BYDRIVER;\r\nif (rtlpriv->dm.dm_type == DM_TYPE_BYDRIVER)\r\nrtlpriv->dm.useramask = true;\r\nelse\r\nrtlpriv->dm.useramask = false;\r\np_ra->high_rssi_thresh_for_ra = 50;\r\np_ra->low_rssi_thresh_for_ra40m = 20;\r\n}\r\nstatic void rtl8821ae_dm_init_dynamic_atc_switch(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nrtlpriv->dm.crystal_cap = rtlpriv->efuse.crystalcap;\r\nrtlpriv->dm.atc_status = rtl_get_bbreg(hw, ROFDM1_CFOTRACKING, BIT(11));\r\nrtlpriv->dm.cfo_threshold = CFO_THRESHOLD_XTAL;\r\n}\r\nstatic void rtl8821ae_dm_common_info_self_init(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nu8 tmp;\r\nrtlphy->cck_high_power =\r\n(bool)rtl_get_bbreg(hw, ODM_REG_CCK_RPT_FORMAT_11AC,\r\nODM_BIT_CCK_RPT_FORMAT_11AC);\r\ntmp = (u8)rtl_get_bbreg(hw, ODM_REG_BB_RX_PATH_11AC,\r\nODM_BIT_BB_RX_PATH_11AC);\r\nif (tmp & BIT(0))\r\nrtlpriv->dm.rfpath_rxenable[0] = true;\r\nif (tmp & BIT(1))\r\nrtlpriv->dm.rfpath_rxenable[1] = true;\r\n}\r\nvoid rtl8821ae_dm_init(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nu32 cur_igvalue = rtl_get_bbreg(hw, ROFDM0_XAAGCCORE1, 0x7f);\r\nspin_lock(&rtlpriv->locks.iqk_lock);\r\nrtlphy->lck_inprogress = false;\r\nspin_unlock(&rtlpriv->locks.iqk_lock);\r\nrtlpriv->dm.dm_type = DM_TYPE_BYDRIVER;\r\nrtl8821ae_dm_common_info_self_init(hw);\r\nrtl_dm_diginit(hw, cur_igvalue);\r\nrtl8821ae_dm_init_rate_adaptive_mask(hw);\r\nrtl8821ae_dm_init_edca_turbo(hw);\r\nrtl8821ae_dm_initialize_txpower_tracking_thermalmeter(hw);\r\nrtl8821ae_dm_init_dynamic_atc_switch(hw);\r\n}\r\nstatic void rtl8821ae_dm_find_minimum_rssi(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *rtl_dm_dig = &rtlpriv->dm_digtable;\r\nstruct rtl_mac *mac = rtl_mac(rtlpriv);\r\nif ((mac->link_state < MAC80211_LINKED) &&\r\n(rtlpriv->dm.entry_min_undec_sm_pwdb == 0)) {\r\nrtl_dm_dig->min_undec_pwdb_for_dm = 0;\r\npr_debug("rtl8821ae: Not connected to any AP\n");\r\n}\r\nif (mac->link_state >= MAC80211_LINKED) {\r\nif (mac->opmode == NL80211_IFTYPE_AP ||\r\nmac->opmode == NL80211_IFTYPE_ADHOC) {\r\nrtl_dm_dig->min_undec_pwdb_for_dm =\r\nrtlpriv->dm.entry_min_undec_sm_pwdb;\r\nRT_TRACE(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\r\n"AP Client PWDB = 0x%lx\n",\r\nrtlpriv->dm.entry_min_undec_sm_pwdb);\r\n} else {\r\nrtl_dm_dig->min_undec_pwdb_for_dm =\r\nrtlpriv->dm.undec_sm_pwdb;\r\nRT_TRACE(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\r\n"STA Default Port PWDB = 0x%x\n",\r\nrtl_dm_dig->min_undec_pwdb_for_dm);\r\n}\r\n} else {\r\nrtl_dm_dig->min_undec_pwdb_for_dm =\r\nrtlpriv->dm.entry_min_undec_sm_pwdb;\r\nRT_TRACE(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\r\n"AP Ext Port or disconnect PWDB = 0x%x\n",\r\nrtl_dm_dig->min_undec_pwdb_for_dm);\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"MinUndecoratedPWDBForDM =%d\n",\r\nrtl_dm_dig->min_undec_pwdb_for_dm);\r\n}\r\nstatic void rtl8812ae_dm_rssi_dump_to_register(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nrtl_write_byte(rtlpriv, RA_RSSI_DUMP,\r\nrtlpriv->stats.rx_rssi_percentage[0]);\r\nrtl_write_byte(rtlpriv, RB_RSSI_DUMP,\r\nrtlpriv->stats.rx_rssi_percentage[1]);\r\nrtl_write_byte(rtlpriv, RS1_RX_EVM_DUMP,\r\nrtlpriv->stats.rx_evm_dbm[0]);\r\nrtl_write_byte(rtlpriv, RS2_RX_EVM_DUMP,\r\nrtlpriv->stats.rx_evm_dbm[1]);\r\nrtl_write_byte(rtlpriv, RA_RX_SNR_DUMP,\r\n(u8)(rtlpriv->stats.rx_snr_db[0]));\r\nrtl_write_byte(rtlpriv, RB_RX_SNR_DUMP,\r\n(u8)(rtlpriv->stats.rx_snr_db[1]));\r\nrtl_write_word(rtlpriv, RA_CFO_SHORT_DUMP,\r\nrtlpriv->stats.rx_cfo_short[0]);\r\nrtl_write_word(rtlpriv, RB_CFO_SHORT_DUMP,\r\nrtlpriv->stats.rx_cfo_short[1]);\r\nrtl_write_word(rtlpriv, RA_CFO_LONG_DUMP,\r\nrtlpriv->stats.rx_cfo_tail[0]);\r\nrtl_write_word(rtlpriv, RB_CFO_LONG_DUMP,\r\nrtlpriv->stats.rx_cfo_tail[1]);\r\n}\r\nstatic void rtl8821ae_dm_check_rssi_monitor(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_sta_info *drv_priv;\r\nu8 h2c_parameter[4] = { 0 };\r\nlong tmp_entry_max_pwdb = 0, tmp_entry_min_pwdb = 0xff;\r\nu8 stbc_tx = 0;\r\nu64 cur_txokcnt = 0, cur_rxokcnt = 0;\r\nstatic u64 last_txokcnt = 0, last_rxokcnt;\r\ncur_txokcnt = rtlpriv->stats.txbytesunicast - last_txokcnt;\r\ncur_rxokcnt = rtlpriv->stats.rxbytesunicast - last_rxokcnt;\r\nlast_txokcnt = rtlpriv->stats.txbytesunicast;\r\nlast_rxokcnt = rtlpriv->stats.rxbytesunicast;\r\nif (cur_rxokcnt > (last_txokcnt * 6))\r\nh2c_parameter[3] = 0x01;\r\nelse\r\nh2c_parameter[3] = 0x00;\r\nif (mac->opmode == NL80211_IFTYPE_AP ||\r\nmac->opmode == NL80211_IFTYPE_ADHOC ||\r\nmac->opmode == NL80211_IFTYPE_MESH_POINT) {\r\nspin_lock_bh(&rtlpriv->locks.entry_list_lock);\r\nlist_for_each_entry(drv_priv, &rtlpriv->entry_list, list) {\r\nif (drv_priv->rssi_stat.undec_sm_pwdb <\r\ntmp_entry_min_pwdb)\r\ntmp_entry_min_pwdb =\r\ndrv_priv->rssi_stat.undec_sm_pwdb;\r\nif (drv_priv->rssi_stat.undec_sm_pwdb >\r\ntmp_entry_max_pwdb)\r\ntmp_entry_max_pwdb =\r\ndrv_priv->rssi_stat.undec_sm_pwdb;\r\n}\r\nspin_unlock_bh(&rtlpriv->locks.entry_list_lock);\r\nif (tmp_entry_max_pwdb != 0) {\r\nrtlpriv->dm.entry_max_undec_sm_pwdb =\r\ntmp_entry_max_pwdb;\r\nRTPRINT(rtlpriv, FDM, DM_PWDB,\r\n"EntryMaxPWDB = 0x%lx(%ld)\n",\r\ntmp_entry_max_pwdb, tmp_entry_max_pwdb);\r\n} else {\r\nrtlpriv->dm.entry_max_undec_sm_pwdb = 0;\r\n}\r\nif (tmp_entry_min_pwdb != 0xff) {\r\nrtlpriv->dm.entry_min_undec_sm_pwdb =\r\ntmp_entry_min_pwdb;\r\nRTPRINT(rtlpriv, FDM, DM_PWDB,\r\n"EntryMinPWDB = 0x%lx(%ld)\n",\r\ntmp_entry_min_pwdb, tmp_entry_min_pwdb);\r\n} else {\r\nrtlpriv->dm.entry_min_undec_sm_pwdb = 0;\r\n}\r\n}\r\nif (rtlpriv->dm.useramask) {\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\r\nif (mac->mode == WIRELESS_MODE_AC_24G ||\r\nmac->mode == WIRELESS_MODE_AC_5G ||\r\nmac->mode == WIRELESS_MODE_AC_ONLY)\r\nstbc_tx = (mac->vht_cur_stbc &\r\nSTBC_VHT_ENABLE_TX) ? 1 : 0;\r\nelse\r\nstbc_tx = (mac->ht_cur_stbc &\r\nSTBC_HT_ENABLE_TX) ? 1 : 0;\r\nh2c_parameter[3] |= stbc_tx << 1;\r\n}\r\nh2c_parameter[2] =\r\n(u8)(rtlpriv->dm.undec_sm_pwdb & 0xFF);\r\nh2c_parameter[1] = 0x20;\r\nh2c_parameter[0] = 0;\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl8821ae_fill_h2c_cmd(hw, H2C_RSSI_21AE_REPORT, 4,\r\nh2c_parameter);\r\nelse\r\nrtl8821ae_fill_h2c_cmd(hw, H2C_RSSI_21AE_REPORT, 3,\r\nh2c_parameter);\r\n} else {\r\nrtl_write_byte(rtlpriv, 0x4fe, rtlpriv->dm.undec_sm_pwdb);\r\n}\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl8812ae_dm_rssi_dump_to_register(hw);\r\nrtl8821ae_dm_find_minimum_rssi(hw);\r\ndm_digtable->rssi_val_min = rtlpriv->dm_digtable.min_undec_pwdb_for_dm;\r\n}\r\nvoid rtl8821ae_dm_write_cck_cca_thres(struct ieee80211_hw *hw, u8 current_cca)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nif (dm_digtable->cur_cck_cca_thres != current_cca)\r\nrtl_write_byte(rtlpriv, DM_REG_CCK_CCA_11AC, current_cca);\r\ndm_digtable->pre_cck_cca_thres = dm_digtable->cur_cck_cca_thres;\r\ndm_digtable->cur_cck_cca_thres = current_cca;\r\n}\r\nvoid rtl8821ae_dm_write_dig(struct ieee80211_hw *hw, u8 current_igi)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nif (dm_digtable->stop_dig)\r\nreturn;\r\nif (dm_digtable->cur_igvalue != current_igi) {\r\nrtl_set_bbreg(hw, DM_REG_IGI_A_11AC,\r\nDM_BIT_IGI_11AC, current_igi);\r\nif (rtlpriv->phy.rf_type != RF_1T1R)\r\nrtl_set_bbreg(hw, DM_REG_IGI_B_11AC,\r\nDM_BIT_IGI_11AC, current_igi);\r\n}\r\ndm_digtable->cur_igvalue = current_igi;\r\n}\r\nstatic void rtl8821ae_dm_dig(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu8 dig_min_0;\r\nu8 dig_max_of_min;\r\nbool first_connect, first_disconnect;\r\nu8 dm_dig_max, dm_dig_min, offset;\r\nu8 current_igi = dm_digtable->cur_igvalue;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "\n");\r\nif (mac->act_scanning) {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Return: In Scan Progress\n");\r\nreturn;\r\n}\r\ndig_min_0 = dm_digtable->dig_min_0;\r\nfirst_connect = (mac->link_state >= MAC80211_LINKED) &&\r\n(!dm_digtable->media_connect_0);\r\nfirst_disconnect = (mac->link_state < MAC80211_LINKED) &&\r\n(dm_digtable->media_connect_0);\r\ndm_dig_max = 0x5A;\r\nif (rtlhal->hw_type != HARDWARE_TYPE_RTL8821AE)\r\ndm_dig_min = DM_DIG_MIN;\r\nelse\r\ndm_dig_min = 0x1C;\r\ndig_max_of_min = DM_DIG_MAX_AP;\r\nif (mac->link_state >= MAC80211_LINKED) {\r\nif (rtlhal->hw_type != HARDWARE_TYPE_RTL8821AE)\r\noffset = 20;\r\nelse\r\noffset = 10;\r\nif ((dm_digtable->rssi_val_min + offset) > dm_dig_max)\r\ndm_digtable->rx_gain_max = dm_dig_max;\r\nelse if ((dm_digtable->rssi_val_min + offset) < dm_dig_min)\r\ndm_digtable->rx_gain_max = dm_dig_min;\r\nelse\r\ndm_digtable->rx_gain_max =\r\ndm_digtable->rssi_val_min + offset;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"dm_digtable->rssi_val_min=0x%x,dm_digtable->rx_gain_max = 0x%x\n",\r\ndm_digtable->rssi_val_min,\r\ndm_digtable->rx_gain_max);\r\nif (rtlpriv->dm.one_entry_only) {\r\noffset = 0;\r\nif (dm_digtable->rssi_val_min - offset < dm_dig_min)\r\ndig_min_0 = dm_dig_min;\r\nelse if (dm_digtable->rssi_val_min -\r\noffset > dig_max_of_min)\r\ndig_min_0 = dig_max_of_min;\r\nelse\r\ndig_min_0 =\r\ndm_digtable->rssi_val_min - offset;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"bOneEntryOnly=TRUE, dig_min_0=0x%x\n",\r\ndig_min_0);\r\n} else {\r\ndig_min_0 = dm_dig_min;\r\n}\r\n} else {\r\ndm_digtable->rx_gain_max = dm_dig_max;\r\ndig_min_0 = dm_dig_min;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"No Link\n");\r\n}\r\nif (rtlpriv->falsealm_cnt.cnt_all > 10000) {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Abnormally false alarm case.\n");\r\nif (dm_digtable->large_fa_hit != 3)\r\ndm_digtable->large_fa_hit++;\r\nif (dm_digtable->forbidden_igi < current_igi) {\r\ndm_digtable->forbidden_igi = current_igi;\r\ndm_digtable->large_fa_hit = 1;\r\n}\r\nif (dm_digtable->large_fa_hit >= 3) {\r\nif ((dm_digtable->forbidden_igi + 1) >\r\ndm_digtable->rx_gain_max)\r\ndm_digtable->rx_gain_min =\r\ndm_digtable->rx_gain_max;\r\nelse\r\ndm_digtable->rx_gain_min =\r\n(dm_digtable->forbidden_igi + 1);\r\ndm_digtable->recover_cnt = 3600;\r\n}\r\n} else {\r\nif (dm_digtable->recover_cnt != 0) {\r\ndm_digtable->recover_cnt--;\r\n} else {\r\nif (dm_digtable->large_fa_hit < 3) {\r\nif ((dm_digtable->forbidden_igi - 1) <\r\ndig_min_0) {\r\ndm_digtable->forbidden_igi =\r\ndig_min_0;\r\ndm_digtable->rx_gain_min =\r\ndig_min_0;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Normal Case: At Lower Bound\n");\r\n} else {\r\ndm_digtable->forbidden_igi--;\r\ndm_digtable->rx_gain_min =\r\n(dm_digtable->forbidden_igi + 1);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Normal Case: Approach Lower Bound\n");\r\n}\r\n} else {\r\ndm_digtable->large_fa_hit = 0;\r\n}\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"pDM_DigTable->LargeFAHit=%d\n",\r\ndm_digtable->large_fa_hit);\r\nif (rtlpriv->dm.dbginfo.num_qry_beacon_pkt < 10)\r\ndm_digtable->rx_gain_min = dm_dig_min;\r\nif (dm_digtable->rx_gain_min > dm_digtable->rx_gain_max)\r\ndm_digtable->rx_gain_min = dm_digtable->rx_gain_max;\r\nif (mac->link_state >= MAC80211_LINKED) {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"DIG AfterLink\n");\r\nif (first_connect) {\r\nif (dm_digtable->rssi_val_min <= dig_max_of_min)\r\ncurrent_igi = dm_digtable->rssi_val_min;\r\nelse\r\ncurrent_igi = dig_max_of_min;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"First Connect\n");\r\n} else {\r\nif (rtlpriv->falsealm_cnt.cnt_all > DM_DIG_FA_TH2)\r\ncurrent_igi = current_igi + 4;\r\nelse if (rtlpriv->falsealm_cnt.cnt_all > DM_DIG_FA_TH1)\r\ncurrent_igi = current_igi + 2;\r\nelse if (rtlpriv->falsealm_cnt.cnt_all < DM_DIG_FA_TH0)\r\ncurrent_igi = current_igi - 2;\r\nif ((rtlpriv->dm.dbginfo.num_qry_beacon_pkt < 10) &&\r\n(rtlpriv->falsealm_cnt.cnt_all < DM_DIG_FA_TH1)) {\r\ncurrent_igi = dm_digtable->rx_gain_min;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Beacon is less than 10 and FA is less than 768, IGI GOES TO 0x1E!!!!!!!!!!!!\n");\r\n}\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"DIG BeforeLink\n");\r\nif (first_disconnect) {\r\ncurrent_igi = dm_digtable->rx_gain_min;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"First DisConnect\n");\r\n} else {\r\nif (rtlpriv->falsealm_cnt.cnt_all > 2000)\r\ncurrent_igi = current_igi + 4;\r\nelse if (rtlpriv->falsealm_cnt.cnt_all > 600)\r\ncurrent_igi = current_igi + 2;\r\nelse if (rtlpriv->falsealm_cnt.cnt_all < 300)\r\ncurrent_igi = current_igi - 2;\r\nif (current_igi >= 0x3e)\r\ncurrent_igi = 0x3e;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "England DIG\n");\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"DIG End Adjust IGI\n");\r\nif (current_igi > dm_digtable->rx_gain_max)\r\ncurrent_igi = dm_digtable->rx_gain_max;\r\nif (current_igi < dm_digtable->rx_gain_min)\r\ncurrent_igi = dm_digtable->rx_gain_min;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"rx_gain_max=0x%x, rx_gain_min=0x%x\n",\r\ndm_digtable->rx_gain_max, dm_digtable->rx_gain_min);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"TotalFA=%d\n", rtlpriv->falsealm_cnt.cnt_all);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"CurIGValue=0x%x\n", current_igi);\r\nrtl8821ae_dm_write_dig(hw, current_igi);\r\ndm_digtable->media_connect_0 =\r\n((mac->link_state >= MAC80211_LINKED) ? true : false);\r\ndm_digtable->dig_min_0 = dig_min_0;\r\n}\r\nstatic void rtl8821ae_dm_common_info_self_update(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 cnt = 0;\r\nstruct rtl_sta_info *drv_priv;\r\nrtlpriv->dm.tx_rate = 0xff;\r\nrtlpriv->dm.one_entry_only = false;\r\nif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_STATION &&\r\nrtlpriv->mac80211.link_state >= MAC80211_LINKED) {\r\nrtlpriv->dm.one_entry_only = true;\r\nreturn;\r\n}\r\nif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_AP ||\r\nrtlpriv->mac80211.opmode == NL80211_IFTYPE_ADHOC ||\r\nrtlpriv->mac80211.opmode == NL80211_IFTYPE_MESH_POINT) {\r\nspin_lock_bh(&rtlpriv->locks.entry_list_lock);\r\nlist_for_each_entry(drv_priv, &rtlpriv->entry_list, list)\r\ncnt++;\r\nspin_unlock_bh(&rtlpriv->locks.entry_list_lock);\r\nif (cnt == 1)\r\nrtlpriv->dm.one_entry_only = true;\r\n}\r\n}\r\nstatic void rtl8821ae_dm_false_alarm_counter_statistics(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct false_alarm_statistics *falsealm_cnt = &rtlpriv->falsealm_cnt;\r\nu32 cck_enable = 0;\r\nfalsealm_cnt->cnt_ofdm_fail =\r\nrtl_get_bbreg(hw, ODM_REG_OFDM_FA_11AC, BMASKLWORD);\r\nfalsealm_cnt->cnt_cck_fail =\r\nrtl_get_bbreg(hw, ODM_REG_CCK_FA_11AC, BMASKLWORD);\r\ncck_enable = rtl_get_bbreg(hw, ODM_REG_BB_RX_PATH_11AC, BIT(28));\r\nif (cck_enable)\r\nfalsealm_cnt->cnt_all = falsealm_cnt->cnt_ofdm_fail +\r\nfalsealm_cnt->cnt_cck_fail;\r\nelse\r\nfalsealm_cnt->cnt_all = falsealm_cnt->cnt_ofdm_fail;\r\nrtl_set_bbreg(hw, ODM_REG_OFDM_FA_RST_11AC, BIT(17), 1);\r\nrtl_set_bbreg(hw, ODM_REG_OFDM_FA_RST_11AC, BIT(17), 0);\r\nrtl_set_bbreg(hw, ODM_REG_CCK_FA_RST_11AC, BIT(15), 0);\r\nrtl_set_bbreg(hw, ODM_REG_CCK_FA_RST_11AC, BIT(15), 1);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "Cnt_Cck_fail=%d\n",\r\nfalsealm_cnt->cnt_cck_fail);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "cnt_ofdm_fail=%d\n",\r\nfalsealm_cnt->cnt_ofdm_fail);\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "Total False Alarm=%d\n",\r\nfalsealm_cnt->cnt_all);\r\n}\r\nstatic void rtl8812ae_dm_check_txpower_tracking_thermalmeter(\r\nstruct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (!rtlpriv->dm.tm_trigger) {\r\nrtl_set_rfreg(hw, RF90_PATH_A, RF_T_METER_88E,\r\nBIT(17) | BIT(16), 0x03);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Trigger 8812 Thermal Meter!!\n");\r\nrtlpriv->dm.tm_trigger = 1;\r\nreturn;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Schedule TxPowerTracking direct call!!\n");\r\nrtl8812ae_dm_txpower_tracking_callback_thermalmeter(hw);\r\n}\r\nstatic void rtl8821ae_dm_iq_calibrate(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nif (mac->link_state >= MAC80211_LINKED) {\r\nif (rtldm->linked_interval < 3)\r\nrtldm->linked_interval++;\r\nif (rtldm->linked_interval == 2) {\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl8812ae_phy_iq_calibrate(hw, false);\r\nelse\r\nrtl8821ae_phy_iq_calibrate(hw, false);\r\n}\r\n} else {\r\nrtldm->linked_interval = 0;\r\n}\r\n}\r\nstatic void rtl8812ae_get_delta_swing_table(struct ieee80211_hw *hw,\r\nu8 **up_a, u8 **down_a,\r\nu8 **up_b, u8 **down_b)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nu8 channel = rtlphy->current_channel;\r\nu8 rate = rtldm->tx_rate;\r\nif (1 <= channel && channel <= 14) {\r\nif (RTL8821AE_RX_HAL_IS_CCK_RATE(rate)) {\r\n*up_a = rtl8812ae_delta_swing_table_idx_24gccka_p;\r\n*down_a = rtl8812ae_delta_swing_table_idx_24gccka_n;\r\n*up_b = rtl8812ae_delta_swing_table_idx_24gcckb_p;\r\n*down_b = rtl8812ae_delta_swing_table_idx_24gcckb_n;\r\n} else {\r\n*up_a = rtl8812ae_delta_swing_table_idx_24ga_p;\r\n*down_a = rtl8812ae_delta_swing_table_idx_24ga_n;\r\n*up_b = rtl8812ae_delta_swing_table_idx_24gb_p;\r\n*down_b = rtl8812ae_delta_swing_table_idx_24gb_n;\r\n}\r\n} else if (36 <= channel && channel <= 64) {\r\n*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[0];\r\n*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[0];\r\n*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[0];\r\n*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[0];\r\n} else if (100 <= channel && channel <= 140) {\r\n*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[1];\r\n*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[1];\r\n*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[1];\r\n*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[1];\r\n} else if (149 <= channel && channel <= 173) {\r\n*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[2];\r\n*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[2];\r\n*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[2];\r\n*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[2];\r\n} else {\r\n*up_a = (u8 *)rtl8818e_delta_swing_table_idx_24gb_p;\r\n*down_a = (u8 *)rtl8818e_delta_swing_table_idx_24gb_n;\r\n*up_b = (u8 *)rtl8818e_delta_swing_table_idx_24gb_p;\r\n*down_b = (u8 *)rtl8818e_delta_swing_table_idx_24gb_n;\r\n}\r\n}\r\nvoid rtl8821ae_dm_update_init_rate(struct ieee80211_hw *hw, u8 rate)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu8 p = 0;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Get C2H Command! Rate=0x%x\n", rate);\r\nrtldm->tx_rate = rate;\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\r\nrtl8821ae_dm_txpwr_track_set_pwr(hw, MIX_MODE, RF90_PATH_A, 0);\r\n} else {\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\r\nrtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE, p, 0);\r\n}\r\n}\r\nu8 rtl8821ae_hw_rate_to_mrate(struct ieee80211_hw *hw, u8 rate)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 ret_rate = MGN_1M;\r\nswitch (rate) {\r\ncase DESC_RATE1M:\r\nret_rate = MGN_1M;\r\nbreak;\r\ncase DESC_RATE2M:\r\nret_rate = MGN_2M;\r\nbreak;\r\ncase DESC_RATE5_5M:\r\nret_rate = MGN_5_5M;\r\nbreak;\r\ncase DESC_RATE11M:\r\nret_rate = MGN_11M;\r\nbreak;\r\ncase DESC_RATE6M:\r\nret_rate = MGN_6M;\r\nbreak;\r\ncase DESC_RATE9M:\r\nret_rate = MGN_9M;\r\nbreak;\r\ncase DESC_RATE12M:\r\nret_rate = MGN_12M;\r\nbreak;\r\ncase DESC_RATE18M:\r\nret_rate = MGN_18M;\r\nbreak;\r\ncase DESC_RATE24M:\r\nret_rate = MGN_24M;\r\nbreak;\r\ncase DESC_RATE36M:\r\nret_rate = MGN_36M;\r\nbreak;\r\ncase DESC_RATE48M:\r\nret_rate = MGN_48M;\r\nbreak;\r\ncase DESC_RATE54M:\r\nret_rate = MGN_54M;\r\nbreak;\r\ncase DESC_RATEMCS0:\r\nret_rate = MGN_MCS0;\r\nbreak;\r\ncase DESC_RATEMCS1:\r\nret_rate = MGN_MCS1;\r\nbreak;\r\ncase DESC_RATEMCS2:\r\nret_rate = MGN_MCS2;\r\nbreak;\r\ncase DESC_RATEMCS3:\r\nret_rate = MGN_MCS3;\r\nbreak;\r\ncase DESC_RATEMCS4:\r\nret_rate = MGN_MCS4;\r\nbreak;\r\ncase DESC_RATEMCS5:\r\nret_rate = MGN_MCS5;\r\nbreak;\r\ncase DESC_RATEMCS6:\r\nret_rate = MGN_MCS6;\r\nbreak;\r\ncase DESC_RATEMCS7:\r\nret_rate = MGN_MCS7;\r\nbreak;\r\ncase DESC_RATEMCS8:\r\nret_rate = MGN_MCS8;\r\nbreak;\r\ncase DESC_RATEMCS9:\r\nret_rate = MGN_MCS9;\r\nbreak;\r\ncase DESC_RATEMCS10:\r\nret_rate = MGN_MCS10;\r\nbreak;\r\ncase DESC_RATEMCS11:\r\nret_rate = MGN_MCS11;\r\nbreak;\r\ncase DESC_RATEMCS12:\r\nret_rate = MGN_MCS12;\r\nbreak;\r\ncase DESC_RATEMCS13:\r\nret_rate = MGN_MCS13;\r\nbreak;\r\ncase DESC_RATEMCS14:\r\nret_rate = MGN_MCS14;\r\nbreak;\r\ncase DESC_RATEMCS15:\r\nret_rate = MGN_MCS15;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS0:\r\nret_rate = MGN_VHT1SS_MCS0;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS1:\r\nret_rate = MGN_VHT1SS_MCS1;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS2:\r\nret_rate = MGN_VHT1SS_MCS2;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS3:\r\nret_rate = MGN_VHT1SS_MCS3;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS4:\r\nret_rate = MGN_VHT1SS_MCS4;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS5:\r\nret_rate = MGN_VHT1SS_MCS5;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS6:\r\nret_rate = MGN_VHT1SS_MCS6;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS7:\r\nret_rate = MGN_VHT1SS_MCS7;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS8:\r\nret_rate = MGN_VHT1SS_MCS8;\r\nbreak;\r\ncase DESC_RATEVHT1SS_MCS9:\r\nret_rate = MGN_VHT1SS_MCS9;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS0:\r\nret_rate = MGN_VHT2SS_MCS0;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS1:\r\nret_rate = MGN_VHT2SS_MCS1;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS2:\r\nret_rate = MGN_VHT2SS_MCS2;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS3:\r\nret_rate = MGN_VHT2SS_MCS3;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS4:\r\nret_rate = MGN_VHT2SS_MCS4;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS5:\r\nret_rate = MGN_VHT2SS_MCS5;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS6:\r\nret_rate = MGN_VHT2SS_MCS6;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS7:\r\nret_rate = MGN_VHT2SS_MCS7;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS8:\r\nret_rate = MGN_VHT2SS_MCS8;\r\nbreak;\r\ncase DESC_RATEVHT2SS_MCS9:\r\nret_rate = MGN_VHT2SS_MCS9;\r\nbreak;\r\ndefault:\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"HwRateToMRate8812(): Non supported Rate [%x]!!!\n",\r\nrate);\r\nbreak;\r\n}\r\nreturn ret_rate;\r\n}\r\nvoid rtl8812ae_dm_txpwr_track_set_pwr(struct ieee80211_hw *hw,\r\nenum pwr_track_control_method method,\r\nu8 rf_path, u8 channel_mapped_index)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nu32 final_swing_idx[2];\r\nu8 pwr_tracking_limit = 26;\r\nu8 tx_rate = 0xFF;\r\ns8 final_ofdm_swing_index = 0;\r\nif (rtldm->tx_rate != 0xFF)\r\ntx_rate =\r\nrtl8821ae_hw_rate_to_mrate(hw, rtldm->tx_rate);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"===>rtl8812ae_dm_txpwr_track_set_pwr\n");\r\nif (tx_rate != 0xFF) {\r\nif ((tx_rate >= MGN_1M) && (tx_rate <= MGN_11M))\r\npwr_tracking_limit = 32;\r\nelse if ((tx_rate >= MGN_6M) && (tx_rate <= MGN_48M))\r\npwr_tracking_limit = 30;\r\nelse if (tx_rate == MGN_54M)\r\npwr_tracking_limit = 28;\r\nelse if ((tx_rate >= MGN_MCS0) && (tx_rate <= MGN_MCS2))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_MCS3) && (tx_rate <= MGN_MCS4))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_MCS5) && (tx_rate <= MGN_MCS7))\r\npwr_tracking_limit = 28;\r\nelse if ((tx_rate >= MGN_MCS8) && (tx_rate <= MGN_MCS10))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_MCS11) && (tx_rate <= MGN_MCS12))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_MCS13) && (tx_rate <= MGN_MCS15))\r\npwr_tracking_limit = 28;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS0) &&\r\n(tx_rate <= MGN_VHT1SS_MCS2))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS3) &&\r\n(tx_rate <= MGN_VHT1SS_MCS4))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS5) &&\r\n(tx_rate <= MGN_VHT1SS_MCS6))\r\npwr_tracking_limit = 28;\r\nelse if (tx_rate == MGN_VHT1SS_MCS7)\r\npwr_tracking_limit = 26;\r\nelse if (tx_rate == MGN_VHT1SS_MCS8)\r\npwr_tracking_limit = 24;\r\nelse if (tx_rate == MGN_VHT1SS_MCS9)\r\npwr_tracking_limit = 22;\r\nelse if ((tx_rate >= MGN_VHT2SS_MCS0) &&\r\n(tx_rate <= MGN_VHT2SS_MCS2))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_VHT2SS_MCS3) &&\r\n(tx_rate <= MGN_VHT2SS_MCS4))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_VHT2SS_MCS5) &&\r\n(tx_rate <= MGN_VHT2SS_MCS6))\r\npwr_tracking_limit = 28;\r\nelse if (tx_rate == MGN_VHT2SS_MCS7)\r\npwr_tracking_limit = 26;\r\nelse if (tx_rate == MGN_VHT2SS_MCS8)\r\npwr_tracking_limit = 24;\r\nelse if (tx_rate == MGN_VHT2SS_MCS9)\r\npwr_tracking_limit = 22;\r\nelse\r\npwr_tracking_limit = 24;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxRate=0x%x, PwrTrackingLimit=%d\n",\r\ntx_rate, pwr_tracking_limit);\r\nif (method == BBSWING) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"===>rtl8812ae_dm_txpwr_track_set_pwr\n");\r\nif (rf_path == RF90_PATH_A) {\r\nu32 tmp;\r\nfinal_swing_idx[RF90_PATH_A] =\r\n(rtldm->ofdm_index[RF90_PATH_A] >\r\npwr_tracking_limit) ?\r\npwr_tracking_limit :\r\nrtldm->ofdm_index[RF90_PATH_A];\r\ntmp = final_swing_idx[RF90_PATH_A];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_A]=%d,pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_A]=%d\n",\r\nrtldm->ofdm_index[RF90_PATH_A],\r\nfinal_swing_idx[RF90_PATH_A]);\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[tmp]);\r\n} else {\r\nu32 tmp;\r\nfinal_swing_idx[RF90_PATH_B] =\r\nrtldm->ofdm_index[RF90_PATH_B] >\r\npwr_tracking_limit ?\r\npwr_tracking_limit :\r\nrtldm->ofdm_index[RF90_PATH_B];\r\ntmp = final_swing_idx[RF90_PATH_B];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_B]=%d, pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_B]=%d\n",\r\nrtldm->ofdm_index[RF90_PATH_B],\r\nfinal_swing_idx[RF90_PATH_B]);\r\nrtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[tmp]);\r\n}\r\n} else if (method == MIX_MODE) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->DefaultOfdmIndex=%d, pDM_Odm->Aboslute_OFDMSwingIdx[RFPath]=%d, RF_Path = %d\n",\r\nrtldm->default_ofdm_index,\r\nrtldm->absolute_ofdm_swing_idx[rf_path],\r\nrf_path);\r\nfinal_ofdm_swing_index = rtldm->default_ofdm_index +\r\nrtldm->absolute_ofdm_swing_idx[rf_path];\r\nif (rf_path == RF90_PATH_A) {\r\nif (final_ofdm_swing_index > pwr_tracking_limit) {\r\nrtldm->remnant_cck_idx =\r\nfinal_ofdm_swing_index -\r\npwr_tracking_limit;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index -\r\npwr_tracking_limit;\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[pwr_tracking_limit]);\r\nrtldm->modify_txagc_flag_path_a = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel,\r\nRF90_PATH_A);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_A Over BBSwing Limit ,PwrTrackingLimit = %d ,Remnant TxAGC Value = %d\n",\r\npwr_tracking_limit,\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else if (final_ofdm_swing_index < 0) {\r\nrtldm->remnant_cck_idx = final_ofdm_swing_index;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index;\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[0]);\r\nrtldm->modify_txagc_flag_path_a = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_A);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_A Lower then BBSwing lower bound 0 , Remnant TxAGC Value = %d\n",\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else {\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[(u8)final_ofdm_swing_index]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_A Compensate with BBSwing, Final_OFDM_Swing_Index = %d\n",\r\nfinal_ofdm_swing_index);\r\nif (rtldm->modify_txagc_flag_path_a) {\r\nrtldm->remnant_cck_idx = 0;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] = 0;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_A);\r\nrtldm->modify_txagc_flag_path_a = false;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING,\r\nDBG_LOUD,\r\n"******Path_A pDM_Odm->Modify_TxAGC_Flag = FALSE\n");\r\n}\r\n}\r\n}\r\nif (rf_path == RF90_PATH_B) {\r\nif (final_ofdm_swing_index > pwr_tracking_limit) {\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index -\r\npwr_tracking_limit;\r\nrtl_set_bbreg(hw, RB_TXSCALE,\r\n0xFFE00000,\r\ntxscaling_tbl[pwr_tracking_limit]);\r\nrtldm->modify_txagc_flag_path_b = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_B);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_B Over BBSwing Limit , PwrTrackingLimit = %d , Remnant TxAGC Value = %d\n",\r\npwr_tracking_limit,\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else if (final_ofdm_swing_index < 0) {\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index;\r\nrtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[0]);\r\nrtldm->modify_txagc_flag_path_b = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_B);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_B Lower then BBSwing lower bound 0 , Remnant TxAGC Value = %d\n",\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else {\r\nrtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[(u8)final_ofdm_swing_index]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_B Compensate with BBSwing ,Final_OFDM_Swing_Index = %d\n",\r\nfinal_ofdm_swing_index);\r\nif (rtldm->modify_txagc_flag_path_b) {\r\nrtldm->remnant_ofdm_swing_idx[rf_path] = 0;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_B);\r\nrtldm->modify_txagc_flag_path_b =\r\nfalse;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_B pDM_Odm->Modify_TxAGC_Flag = FALSE\n");\r\n}\r\n}\r\n}\r\n} else {\r\nreturn;\r\n}\r\n}\r\nvoid rtl8812ae_dm_txpower_tracking_callback_thermalmeter(\r\nstruct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu8 thermal_value = 0, delta, delta_lck, delta_iqk, p = 0, i = 0;\r\nu8 thermal_value_avg_count = 0;\r\nu32 thermal_value_avg = 0;\r\nu8 ofdm_min_index = 6;\r\nu8 index_for_channel = 0;\r\nu8 *delta_swing_table_idx_tup_a;\r\nu8 *delta_swing_table_idx_tdown_a;\r\nu8 *delta_swing_table_idx_tup_b;\r\nu8 *delta_swing_table_idx_tdown_b;\r\nrtl8812ae_get_delta_swing_table(hw,\r\n(u8 **)&delta_swing_table_idx_tup_a,\r\n(u8 **)&delta_swing_table_idx_tdown_a,\r\n(u8 **)&delta_swing_table_idx_tup_b,\r\n(u8 **)&delta_swing_table_idx_tdown_b);\r\nrtldm->txpower_trackinginit = true;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->BbSwingIdxCckBase: %d, pDM_Odm->BbSwingIdxOfdmBase[A]:%d, pDM_Odm->DefaultOfdmIndex: %d\n",\r\nrtldm->swing_idx_cck_base,\r\nrtldm->swing_idx_ofdm_base[RF90_PATH_A],\r\nrtldm->default_ofdm_index);\r\nthermal_value = (u8)rtl_get_rfreg(hw, RF90_PATH_A,\r\nRF_T_METER_8812A, 0xfc00);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\nif (!rtldm->txpower_track_control ||\r\nrtlefuse->eeprom_thermalmeter == 0 ||\r\nrtlefuse->eeprom_thermalmeter == 0xFF)\r\nreturn;\r\nif (rtlhal->reloadtxpowerindex)\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"reload ofdm index for band switch\n");\r\nrtldm->thermalvalue_avg[rtldm->thermalvalue_avg_index] = thermal_value;\r\nrtldm->thermalvalue_avg_index++;\r\nif (rtldm->thermalvalue_avg_index == AVG_THERMAL_NUM_8812A)\r\nrtldm->thermalvalue_avg_index = 0;\r\nfor (i = 0; i < AVG_THERMAL_NUM_8812A; i++) {\r\nif (rtldm->thermalvalue_avg[i]) {\r\nthermal_value_avg += rtldm->thermalvalue_avg[i];\r\nthermal_value_avg_count++;\r\n}\r\n}\r\nif (thermal_value_avg_count) {\r\nthermal_value = (u8)(thermal_value_avg /\r\nthermal_value_avg_count);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"AVG Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\n}\r\ndelta = (thermal_value > rtldm->thermalvalue) ?\r\n(thermal_value - rtldm->thermalvalue) :\r\n(rtldm->thermalvalue - thermal_value);\r\ndelta_lck = (thermal_value > rtldm->thermalvalue_lck) ?\r\n(thermal_value - rtldm->thermalvalue_lck) :\r\n(rtldm->thermalvalue_lck - thermal_value);\r\ndelta_iqk = (thermal_value > rtldm->thermalvalue_iqk) ?\r\n(thermal_value - rtldm->thermalvalue_iqk) :\r\n(rtldm->thermalvalue_iqk - thermal_value);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"(delta, delta_LCK, delta_IQK) = (%d, %d, %d)\n",\r\ndelta, delta_lck, delta_iqk);\r\nif (delta_lck >= IQK_THRESHOLD) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_LCK(%d) >= Threshold_IQK(%d)\n",\r\ndelta_lck, IQK_THRESHOLD);\r\nrtldm->thermalvalue_lck = thermal_value;\r\nrtl8821ae_phy_lc_calibrate(hw);\r\n}\r\nif (delta > 0 && rtldm->txpower_track_control) {\r\ndelta = thermal_value > rtlefuse->eeprom_thermalmeter ?\r\n(thermal_value - rtlefuse->eeprom_thermalmeter) :\r\n(rtlefuse->eeprom_thermalmeter - thermal_value);\r\nif (delta >= TXPWR_TRACK_TABLE_SIZE)\r\ndelta = TXPWR_TRACK_TABLE_SIZE - 1;\r\nif (thermal_value > rtlefuse->eeprom_thermalmeter) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_swing_table_idx_tup_a[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tup_a[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_A] =\r\nrtldm->delta_power_index[RF90_PATH_A];\r\nrtldm->delta_power_index[RF90_PATH_A] =\r\ndelta_swing_table_idx_tup_a[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\r\ndelta_swing_table_idx_tup_a[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is higher and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_swing_table_idx_tup_b[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tup_b[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_B] =\r\nrtldm->delta_power_index[RF90_PATH_B];\r\nrtldm->delta_power_index[RF90_PATH_B] =\r\ndelta_swing_table_idx_tup_b[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_B] =\r\ndelta_swing_table_idx_tup_b[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is higher and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_B] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_B]);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_swing_table_idx_tdown_a[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tdown_a[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_A] =\r\nrtldm->delta_power_index[RF90_PATH_A];\r\nrtldm->delta_power_index[RF90_PATH_A] =\r\n-1 * delta_swing_table_idx_tdown_a[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\r\n-1 * delta_swing_table_idx_tdown_a[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is lower and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"deltaSwingTableIdx_TDOWN_B[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tdown_b[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_B] =\r\nrtldm->delta_power_index[RF90_PATH_B];\r\nrtldm->delta_power_index[RF90_PATH_B] =\r\n-1 * delta_swing_table_idx_tdown_b[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_B] =\r\n-1 * delta_swing_table_idx_tdown_b[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is lower and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_B] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_B]);\r\n}\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"============================= [Path-%c]Calculating PowerIndexOffset =============================\n",\r\n(p == RF90_PATH_A ? 'A' : 'B'));\r\nif (rtldm->delta_power_index[p] ==\r\nrtldm->delta_power_index_last[p])\r\nrtldm->power_index_offset[p] = 0;\r\nelse\r\nrtldm->power_index_offset[p] =\r\nrtldm->delta_power_index[p] -\r\nrtldm->delta_power_index_last[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"[Path-%c] PowerIndexOffset(%d) =DeltaPowerIndex(%d) -DeltaPowerIndexLast(%d)\n",\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->power_index_offset[p],\r\nrtldm->delta_power_index[p] ,\r\nrtldm->delta_power_index_last[p]);\r\nrtldm->ofdm_index[p] =\r\nrtldm->swing_idx_ofdm_base[p] +\r\nrtldm->power_index_offset[p];\r\nrtldm->cck_index =\r\nrtldm->swing_idx_cck_base +\r\nrtldm->power_index_offset[p];\r\nrtldm->swing_idx_cck = rtldm->cck_index;\r\nrtldm->swing_idx_ofdm[p] = rtldm->ofdm_index[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The 'CCK' final index(%d) = BaseIndex(%d) + PowerIndexOffset(%d)\n",\r\nrtldm->swing_idx_cck,\r\nrtldm->swing_idx_cck_base,\r\nrtldm->power_index_offset[p]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The 'OFDM' final index(%d) = BaseIndex[%c](%d) + PowerIndexOffset(%d)\n",\r\nrtldm->swing_idx_ofdm[p],\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->swing_idx_ofdm_base[p],\r\nrtldm->power_index_offset[p]);\r\nif (rtldm->ofdm_index[p] > TXSCALE_TABLE_SIZE - 1)\r\nrtldm->ofdm_index[p] = TXSCALE_TABLE_SIZE - 1;\r\nelse if (rtldm->ofdm_index[p] < ofdm_min_index)\r\nrtldm->ofdm_index[p] = ofdm_min_index;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"\n\n====================================================================================\n");\r\nif (rtldm->cck_index > TXSCALE_TABLE_SIZE - 1)\r\nrtldm->cck_index = TXSCALE_TABLE_SIZE - 1;\r\nelse if (rtldm->cck_index < 0)\r\nrtldm->cck_index = 0;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The thermal meter is unchanged or TxPowerTracking OFF(%d): ThermalValue: %d , pDM_Odm->RFCalibrateInfo.ThermalValue: %d\n",\r\nrtldm->txpower_track_control,\r\nthermal_value,\r\nrtldm->thermalvalue);\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\r\nrtldm->power_index_offset[p] = 0;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxPowerTracking: [CCK] Swing Current Index: %d,Swing Base Index: %d\n",\r\nrtldm->cck_index, rtldm->swing_idx_cck_base);\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxPowerTracking: [OFDM] Swing Current Index: %d,Swing Base Index[%c]: %d\n",\r\nrtldm->ofdm_index[p],\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->swing_idx_ofdm_base[p]);\r\n}\r\nif ((rtldm->power_index_offset[RF90_PATH_A] != 0 ||\r\nrtldm->power_index_offset[RF90_PATH_B] != 0) &&\r\nrtldm->txpower_track_control) {\r\nif (thermal_value > rtldm->thermalvalue) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Increasing(A): delta_pi: %d , delta_t: %d, Now_t: %d,EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_A],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Increasing(B): delta_pi: %d ,delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_B],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\n} else if (thermal_value < rtldm->thermalvalue) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Decreasing(A): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_A],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Decreasing(B): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_B],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\n}\r\nif (thermal_value > rtlefuse->eeprom_thermalmeter) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature(%d) higher than PG value(%d)\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"**********Enter POWER Tracking MIX_MODE**********\n");\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\r\nrtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE,\r\np, 0);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature(%d) lower than PG value(%d)\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"**********Enter POWER Tracking MIX_MODE**********\n");\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\r\nrtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE,\r\np, index_for_channel);\r\n}\r\nrtldm->swing_idx_cck_base = rtldm->swing_idx_cck;\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\r\nrtldm->swing_idx_ofdm_base[p] =\r\nrtldm->swing_idx_ofdm[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->RFCalibrateInfo.ThermalValue =%d ThermalValue= %d\n",\r\nrtldm->thermalvalue, thermal_value);\r\nrtldm->thermalvalue = thermal_value;\r\n}\r\nif (delta_iqk >= IQK_THRESHOLD)\r\nrtl8812ae_do_iqk(hw, delta_iqk, thermal_value, 8);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"<===rtl8812ae_dm_txpower_tracking_callback_thermalmeter\n");\r\n}\r\nstatic void rtl8821ae_get_delta_swing_table(struct ieee80211_hw *hw, u8 **up_a,\r\nu8 **down_a, u8 **up_b, u8 **down_b)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nu8 channel = rtlphy->current_channel;\r\nu8 rate = rtldm->tx_rate;\r\nif (1 <= channel && channel <= 14) {\r\nif (RTL8821AE_RX_HAL_IS_CCK_RATE(rate)) {\r\n*up_a = rtl8821ae_delta_swing_table_idx_24gccka_p;\r\n*down_a = rtl8821ae_delta_swing_table_idx_24gccka_n;\r\n*up_b = rtl8821ae_delta_swing_table_idx_24gcckb_p;\r\n*down_b = rtl8821ae_delta_swing_table_idx_24gcckb_n;\r\n} else {\r\n*up_a = rtl8821ae_delta_swing_table_idx_24ga_p;\r\n*down_a = rtl8821ae_delta_swing_table_idx_24ga_n;\r\n*up_b = rtl8821ae_delta_swing_table_idx_24gb_p;\r\n*down_b = rtl8821ae_delta_swing_table_idx_24gb_n;\r\n}\r\n} else if (36 <= channel && channel <= 64) {\r\n*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[0];\r\n*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[0];\r\n*up_b = rtl8821ae_delta_swing_table_idx_5gb_p[0];\r\n*down_b = rtl8821ae_delta_swing_table_idx_5gb_n[0];\r\n} else if (100 <= channel && channel <= 140) {\r\n*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[1];\r\n*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[1];\r\n*up_b = rtl8821ae_delta_swing_table_idx_5gb_p[1];\r\n*down_b = rtl8821ae_delta_swing_table_idx_5gb_n[1];\r\n} else if (149 <= channel && channel <= 173) {\r\n*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[2];\r\n*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[2];\r\n*up_b = rtl8821ae_delta_swing_table_idx_5gb_p[2];\r\n*down_b = rtl8821ae_delta_swing_table_idx_5gb_n[2];\r\n} else {\r\n*up_a = (u8 *)rtl8818e_delta_swing_table_idx_24gb_p;\r\n*down_a = (u8 *)rtl8818e_delta_swing_table_idx_24gb_n;\r\n*up_b = (u8 *)rtl8818e_delta_swing_table_idx_24gb_p;\r\n*down_b = (u8 *)rtl8818e_delta_swing_table_idx_24gb_n;\r\n}\r\nreturn;\r\n}\r\nvoid rtl8821ae_dm_txpwr_track_set_pwr(struct ieee80211_hw *hw,\r\nenum pwr_track_control_method method,\r\nu8 rf_path, u8 channel_mapped_index)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nu32 final_swing_idx[1];\r\nu8 pwr_tracking_limit = 26;\r\nu8 tx_rate = 0xFF;\r\ns8 final_ofdm_swing_index = 0;\r\nif (rtldm->tx_rate != 0xFF)\r\ntx_rate = rtl8821ae_hw_rate_to_mrate(hw, rtldm->tx_rate);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD, "===>%s\n", __func__);\r\nif (tx_rate != 0xFF) {\r\nif ((tx_rate >= MGN_1M) && (tx_rate <= MGN_11M))\r\npwr_tracking_limit = 32;\r\nelse if ((tx_rate >= MGN_6M) && (tx_rate <= MGN_48M))\r\npwr_tracking_limit = 30;\r\nelse if (tx_rate == MGN_54M)\r\npwr_tracking_limit = 28;\r\nelse if ((tx_rate >= MGN_MCS0) && (tx_rate <= MGN_MCS2))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_MCS3) && (tx_rate <= MGN_MCS4))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_MCS5) && (tx_rate <= MGN_MCS7))\r\npwr_tracking_limit = 28;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS0) &&\r\n(tx_rate <= MGN_VHT1SS_MCS2))\r\npwr_tracking_limit = 34;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS3) &&\r\n(tx_rate <= MGN_VHT1SS_MCS4))\r\npwr_tracking_limit = 30;\r\nelse if ((tx_rate >= MGN_VHT1SS_MCS5) &&\r\n(tx_rate <= MGN_VHT1SS_MCS6))\r\npwr_tracking_limit = 28;\r\nelse if (tx_rate == MGN_VHT1SS_MCS7)\r\npwr_tracking_limit = 26;\r\nelse if (tx_rate == MGN_VHT1SS_MCS8)\r\npwr_tracking_limit = 24;\r\nelse if (tx_rate == MGN_VHT1SS_MCS9)\r\npwr_tracking_limit = 22;\r\nelse\r\npwr_tracking_limit = 24;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxRate=0x%x, PwrTrackingLimit=%d\n",\r\ntx_rate, pwr_tracking_limit);\r\nif (method == BBSWING) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"===>%s\n", __func__);\r\nif (rf_path == RF90_PATH_A) {\r\nfinal_swing_idx[RF90_PATH_A] =\r\n(rtldm->ofdm_index[RF90_PATH_A] >\r\npwr_tracking_limit) ?\r\npwr_tracking_limit :\r\nrtldm->ofdm_index[RF90_PATH_A];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_A]=%d,pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_A]=%d\n",\r\nrtldm->ofdm_index[RF90_PATH_A],\r\nfinal_swing_idx[RF90_PATH_A]);\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[final_swing_idx[RF90_PATH_A]]);\r\n}\r\n} else if (method == MIX_MODE) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->DefaultOfdmIndex=%d,pDM_Odm->Aboslute_OFDMSwingIdx[RFPath]=%d, RF_Path = %d\n",\r\nrtldm->default_ofdm_index,\r\nrtldm->absolute_ofdm_swing_idx[rf_path],\r\nrf_path);\r\nfinal_ofdm_swing_index =\r\nrtldm->default_ofdm_index +\r\nrtldm->absolute_ofdm_swing_idx[rf_path];\r\nif (rf_path == RF90_PATH_A) {\r\nif (final_ofdm_swing_index > pwr_tracking_limit) {\r\nrtldm->remnant_cck_idx =\r\nfinal_ofdm_swing_index -\r\npwr_tracking_limit;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index -\r\npwr_tracking_limit;\r\nrtl_set_bbreg(hw, RA_TXSCALE,\r\n0xFFE00000,\r\ntxscaling_tbl[pwr_tracking_limit]);\r\nrtldm->modify_txagc_flag_path_a = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel,\r\nRF90_PATH_A);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n" ******Path_A Over BBSwing Limit , PwrTrackingLimit = %d , Remnant TxAGC Value = %d\n",\r\npwr_tracking_limit,\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else if (final_ofdm_swing_index < 0) {\r\nrtldm->remnant_cck_idx = final_ofdm_swing_index;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] =\r\nfinal_ofdm_swing_index;\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[0]);\r\nrtldm->modify_txagc_flag_path_a = true;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_A);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_A Lower then BBSwing lower bound 0 , Remnant TxAGC Value = %d\n",\r\nrtldm->remnant_ofdm_swing_idx[rf_path]);\r\n} else {\r\nrtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\r\ntxscaling_tbl[(u8)final_ofdm_swing_index]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Path_A Compensate with BBSwing ,Final_OFDM_Swing_Index = %d\n",\r\nfinal_ofdm_swing_index);\r\nif (rtldm->modify_txagc_flag_path_a) {\r\nrtldm->remnant_cck_idx = 0;\r\nrtldm->remnant_ofdm_swing_idx[rf_path] = 0;\r\nrtl8821ae_phy_set_txpower_level_by_path(hw,\r\nrtlphy->current_channel, RF90_PATH_A);\r\nrtldm->modify_txagc_flag_path_a = false;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING,\r\nDBG_LOUD,\r\n"******Path_A pDM_Odm->Modify_TxAGC_Flag= FALSE\n");\r\n}\r\n}\r\n}\r\n} else {\r\nreturn;\r\n}\r\n}\r\nvoid rtl8821ae_dm_txpower_tracking_callback_thermalmeter(\r\nstruct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nstruct rtl_phy *rtlphy = &rtlpriv->phy;\r\nu8 thermal_value = 0, delta, delta_lck, delta_iqk, p = 0, i = 0;\r\nu8 thermal_value_avg_count = 0;\r\nu32 thermal_value_avg = 0;\r\nu8 ofdm_min_index = 6;\r\nu8 index_for_channel = 0;\r\nu8 *delta_swing_table_idx_tup_a;\r\nu8 *delta_swing_table_idx_tdown_a;\r\nu8 *delta_swing_table_idx_tup_b;\r\nu8 *delta_swing_table_idx_tdown_b;\r\nrtl8821ae_get_delta_swing_table(hw, (u8 **)&delta_swing_table_idx_tup_a,\r\n(u8 **)&delta_swing_table_idx_tdown_a,\r\n(u8 **)&delta_swing_table_idx_tup_b,\r\n(u8 **)&delta_swing_table_idx_tdown_b);\r\nrtldm->txpower_trackinginit = true;\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"===>%s,\n pDM_Odm->BbSwingIdxCckBase: %d,pDM_Odm->BbSwingIdxOfdmBase[A]:%d, pDM_Odm->DefaultOfdmIndex: %d\n",\r\n__func__,\r\nrtldm->swing_idx_cck_base,\r\nrtldm->swing_idx_ofdm_base[RF90_PATH_A],\r\nrtldm->default_ofdm_index);\r\nthermal_value = (u8)rtl_get_rfreg(hw,\r\nRF90_PATH_A, RF_T_METER_8812A, 0xfc00);\r\nif (!rtldm->txpower_track_control ||\r\nrtlefuse->eeprom_thermalmeter == 0 ||\r\nrtlefuse->eeprom_thermalmeter == 0xFF)\r\nreturn;\r\nif (rtlhal->reloadtxpowerindex) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"reload ofdm index for band switch\n");\r\n}\r\nrtldm->thermalvalue_avg[rtldm->thermalvalue_avg_index] = thermal_value;\r\nrtldm->thermalvalue_avg_index++;\r\nif (rtldm->thermalvalue_avg_index == AVG_THERMAL_NUM_8812A)\r\nrtldm->thermalvalue_avg_index = 0;\r\nfor (i = 0; i < AVG_THERMAL_NUM_8812A; i++) {\r\nif (rtldm->thermalvalue_avg[i]) {\r\nthermal_value_avg += rtldm->thermalvalue_avg[i];\r\nthermal_value_avg_count++;\r\n}\r\n}\r\nif (thermal_value_avg_count) {\r\nthermal_value = (u8)(thermal_value_avg /\r\nthermal_value_avg_count);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"AVG Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\n}\r\ndelta = (thermal_value > rtldm->thermalvalue) ?\r\n(thermal_value - rtldm->thermalvalue) :\r\n(rtldm->thermalvalue - thermal_value);\r\ndelta_lck = (thermal_value > rtldm->thermalvalue_lck) ?\r\n(thermal_value - rtldm->thermalvalue_lck) :\r\n(rtldm->thermalvalue_lck - thermal_value);\r\ndelta_iqk = (thermal_value > rtldm->thermalvalue_iqk) ?\r\n(thermal_value - rtldm->thermalvalue_iqk) :\r\n(rtldm->thermalvalue_iqk - thermal_value);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"(delta, delta_LCK, delta_IQK) = (%d, %d, %d)\n",\r\ndelta, delta_lck, delta_iqk);\r\nif (delta_lck >= IQK_THRESHOLD) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_LCK(%d) >= Threshold_IQK(%d)\n",\r\ndelta_lck, IQK_THRESHOLD);\r\nrtldm->thermalvalue_lck = thermal_value;\r\nrtl8821ae_phy_lc_calibrate(hw);\r\n}\r\nif (delta > 0 && rtldm->txpower_track_control) {\r\ndelta = thermal_value > rtlefuse->eeprom_thermalmeter ?\r\n(thermal_value - rtlefuse->eeprom_thermalmeter) :\r\n(rtlefuse->eeprom_thermalmeter - thermal_value);\r\nif (delta >= TXSCALE_TABLE_SIZE)\r\ndelta = TXSCALE_TABLE_SIZE - 1;\r\nif (thermal_value > rtlefuse->eeprom_thermalmeter) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_swing_table_idx_tup_a[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tup_a[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_A] =\r\nrtldm->delta_power_index[RF90_PATH_A];\r\nrtldm->delta_power_index[RF90_PATH_A] =\r\ndelta_swing_table_idx_tup_a[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\r\ndelta_swing_table_idx_tup_a[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is higher and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"delta_swing_table_idx_tdown_a[%d] = %d\n",\r\ndelta, delta_swing_table_idx_tdown_a[delta]);\r\nrtldm->delta_power_index_last[RF90_PATH_A] =\r\nrtldm->delta_power_index[RF90_PATH_A];\r\nrtldm->delta_power_index[RF90_PATH_A] =\r\n-1 * delta_swing_table_idx_tdown_a[delta];\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\r\n-1 * delta_swing_table_idx_tdown_a[delta];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"******Temp is lower and pDM_Odm->Aboslute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\n",\r\nrtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\r\n}\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"\n\n================================ [Path-%c]Calculating PowerIndexOffset ================================\n",\r\n(p == RF90_PATH_A ? 'A' : 'B'));\r\nif (rtldm->delta_power_index[p] ==\r\nrtldm->delta_power_index_last[p])\r\nrtldm->power_index_offset[p] = 0;\r\nelse\r\nrtldm->power_index_offset[p] =\r\nrtldm->delta_power_index[p] -\r\nrtldm->delta_power_index_last[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"[Path-%c] PowerIndexOffset(%d) = DeltaPowerIndex(%d) - DeltaPowerIndexLast(%d)\n",\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->power_index_offset[p],\r\nrtldm->delta_power_index[p] ,\r\nrtldm->delta_power_index_last[p]);\r\nrtldm->ofdm_index[p] =\r\nrtldm->swing_idx_ofdm_base[p] +\r\nrtldm->power_index_offset[p];\r\nrtldm->cck_index =\r\nrtldm->swing_idx_cck_base +\r\nrtldm->power_index_offset[p];\r\nrtldm->swing_idx_cck = rtldm->cck_index;\r\nrtldm->swing_idx_ofdm[p] = rtldm->ofdm_index[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The 'CCK' final index(%d) = BaseIndex(%d) + PowerIndexOffset(%d)\n",\r\nrtldm->swing_idx_cck,\r\nrtldm->swing_idx_cck_base,\r\nrtldm->power_index_offset[p]);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The 'OFDM' final index(%d) = BaseIndex[%c](%d) + PowerIndexOffset(%d)\n",\r\nrtldm->swing_idx_ofdm[p],\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->swing_idx_ofdm_base[p],\r\nrtldm->power_index_offset[p]);\r\nif (rtldm->ofdm_index[p] > TXSCALE_TABLE_SIZE - 1)\r\nrtldm->ofdm_index[p] = TXSCALE_TABLE_SIZE - 1;\r\nelse if (rtldm->ofdm_index[p] < ofdm_min_index)\r\nrtldm->ofdm_index[p] = ofdm_min_index;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"\n\n========================================================================================================\n");\r\nif (rtldm->cck_index > TXSCALE_TABLE_SIZE - 1)\r\nrtldm->cck_index = TXSCALE_TABLE_SIZE - 1;\r\nelse if (rtldm->cck_index < 0)\r\nrtldm->cck_index = 0;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"The thermal meter is unchanged or TxPowerTracking OFF(%d):ThermalValue: %d , pDM_Odm->RFCalibrateInfo.ThermalValue: %d\n",\r\nrtldm->txpower_track_control,\r\nthermal_value,\r\nrtldm->thermalvalue);\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\r\nrtldm->power_index_offset[p] = 0;\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxPowerTracking: [CCK] Swing Current Index: %d, Swing Base Index: %d\n",\r\nrtldm->cck_index, rtldm->swing_idx_cck_base);\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"TxPowerTracking: [OFDM] Swing Current Index: %d, Swing Base Index[%c]: %d\n",\r\nrtldm->ofdm_index[p],\r\n(p == RF90_PATH_A ? 'A' : 'B'),\r\nrtldm->swing_idx_ofdm_base[p]);\r\n}\r\nif ((rtldm->power_index_offset[RF90_PATH_A] != 0 ||\r\nrtldm->power_index_offset[RF90_PATH_B] != 0) &&\r\nrtldm->txpower_track_control) {\r\nif (thermal_value > rtldm->thermalvalue) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Increasing(A): delta_pi: %d , delta_t: %d,Now_t: %d, EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_A],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\n} else if (thermal_value < rtldm->thermalvalue) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature Decreasing(A): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\n",\r\nrtldm->power_index_offset[RF90_PATH_A],\r\ndelta, thermal_value,\r\nrtlefuse->eeprom_thermalmeter,\r\nrtldm->thermalvalue);\r\n}\r\nif (thermal_value > rtlefuse->eeprom_thermalmeter) {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature(%d) higher than PG value(%d)\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"****Enter POWER Tracking MIX_MODE****\n");\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\r\nrtl8821ae_dm_txpwr_track_set_pwr(hw,\r\nMIX_MODE, p, index_for_channel);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Temperature(%d) lower than PG value(%d)\n",\r\nthermal_value, rtlefuse->eeprom_thermalmeter);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"*****Enter POWER Tracking MIX_MODE*****\n");\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\r\nrtl8812ae_dm_txpwr_track_set_pwr(hw,\r\nMIX_MODE, p, index_for_channel);\r\n}\r\nrtldm->swing_idx_cck_base = rtldm->swing_idx_cck;\r\nfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\r\nrtldm->swing_idx_ofdm_base[p] = rtldm->swing_idx_ofdm[p];\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"pDM_Odm->RFCalibrateInfo.ThermalValue = %d ThermalValue= %d\n",\r\nrtldm->thermalvalue, thermal_value);\r\nrtldm->thermalvalue = thermal_value;\r\n}\r\nif (delta_iqk >= IQK_THRESHOLD) {\r\nif (!rtlphy->lck_inprogress) {\r\nspin_lock(&rtlpriv->locks.iqk_lock);\r\nrtlphy->lck_inprogress = true;\r\nspin_unlock(&rtlpriv->locks.iqk_lock);\r\nrtl8821ae_do_iqk(hw, delta_iqk, thermal_value, 8);\r\nspin_lock(&rtlpriv->locks.iqk_lock);\r\nrtlphy->lck_inprogress = false;\r\nspin_unlock(&rtlpriv->locks.iqk_lock);\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD, "<===%s\n", __func__);\r\n}\r\nvoid rtl8821ae_dm_check_txpower_tracking_thermalmeter(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (!rtlpriv->dm.tm_trigger) {\r\nrtl_set_rfreg(hw, RF90_PATH_A, RF_T_METER_88E, BIT(17)|BIT(16),\r\n0x03);\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Trigger 8821ae Thermal Meter!!\n");\r\nrtlpriv->dm.tm_trigger = 1;\r\nreturn;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\r\n"Schedule TxPowerTracking !!\n");\r\nrtl8821ae_dm_txpower_tracking_callback_thermalmeter(hw);\r\nrtlpriv->dm.tm_trigger = 0;\r\n}\r\n}\r\nstatic void rtl8821ae_dm_refresh_rate_adaptive_mask(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rate_adaptive *p_ra = &rtlpriv->ra;\r\nu32 low_rssithresh_for_ra = p_ra->low2high_rssi_thresh_for_ra40m;\r\nu32 high_rssithresh_for_ra = p_ra->high_rssi_thresh_for_ra;\r\nu8 go_up_gap = 5;\r\nstruct ieee80211_sta *sta = NULL;\r\nif (is_hal_stop(rtlhal)) {\r\nRT_TRACE(rtlpriv, COMP_RATE, DBG_LOUD,\r\n"driver is going to unload\n");\r\nreturn;\r\n}\r\nif (!rtlpriv->dm.useramask) {\r\nRT_TRACE(rtlpriv, COMP_RATE, DBG_LOUD,\r\n"driver does not control rate adaptive mask\n");\r\nreturn;\r\n}\r\nif (mac->link_state == MAC80211_LINKED &&\r\nmac->opmode == NL80211_IFTYPE_STATION) {\r\nswitch (p_ra->pre_ratr_state) {\r\ncase DM_RATR_STA_MIDDLE:\r\nhigh_rssithresh_for_ra += go_up_gap;\r\nbreak;\r\ncase DM_RATR_STA_LOW:\r\nhigh_rssithresh_for_ra += go_up_gap;\r\nlow_rssithresh_for_ra += go_up_gap;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (rtlpriv->dm.undec_sm_pwdb >\r\n(long)high_rssithresh_for_ra)\r\np_ra->ratr_state = DM_RATR_STA_HIGH;\r\nelse if (rtlpriv->dm.undec_sm_pwdb >\r\n(long)low_rssithresh_for_ra)\r\np_ra->ratr_state = DM_RATR_STA_MIDDLE;\r\nelse\r\np_ra->ratr_state = DM_RATR_STA_LOW;\r\nif (p_ra->pre_ratr_state != p_ra->ratr_state) {\r\nRT_TRACE(rtlpriv, COMP_RATE, DBG_LOUD,\r\n"RSSI = %ld\n",\r\nrtlpriv->dm.undec_sm_pwdb);\r\nRT_TRACE(rtlpriv, COMP_RATE, DBG_LOUD,\r\n"RSSI_LEVEL = %d\n", p_ra->ratr_state);\r\nRT_TRACE(rtlpriv, COMP_RATE, DBG_LOUD,\r\n"PreState = %d, CurState = %d\n",\r\np_ra->pre_ratr_state, p_ra->ratr_state);\r\nrcu_read_lock();\r\nsta = rtl_find_sta(hw, mac->bssid);\r\nif (sta)\r\nrtlpriv->cfg->ops->update_rate_tbl(hw,\r\nsta, p_ra->ratr_state);\r\nrcu_read_unlock();\r\np_ra->pre_ratr_state = p_ra->ratr_state;\r\n}\r\n}\r\n}\r\nstatic void rtl8821ae_dm_refresh_basic_rate_mask(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nstruct rtl_mac *mac = &rtlpriv->mac80211;\r\nstatic u8 stage;\r\nu8 cur_stage = 0;\r\nu16 basic_rate = RRSR_1M | RRSR_2M | RRSR_5_5M | RRSR_11M | RRSR_6M;\r\nif (mac->link_state < MAC80211_LINKED)\r\ncur_stage = 0;\r\nelse if (dm_digtable->rssi_val_min < 25)\r\ncur_stage = 1;\r\nelse if (dm_digtable->rssi_val_min > 30)\r\ncur_stage = 3;\r\nelse\r\ncur_stage = 2;\r\nif (cur_stage != stage) {\r\nif (cur_stage == 1) {\r\nbasic_rate &= (!(basic_rate ^ mac->basic_rates));\r\nrtlpriv->cfg->ops->set_hw_reg(hw,\r\nHW_VAR_BASIC_RATE, (u8 *)&basic_rate);\r\n} else if (cur_stage == 3 && (stage == 1 || stage == 2)) {\r\nrtlpriv->cfg->ops->set_hw_reg(hw,\r\nHW_VAR_BASIC_RATE, (u8 *)&mac->basic_rates);\r\n}\r\n}\r\nstage = cur_stage;\r\n}\r\nstatic void rtl8821ae_dm_edca_choose_traffic_idx(\r\nstruct ieee80211_hw *hw, u64 cur_tx_bytes,\r\nu64 cur_rx_bytes, bool b_bias_on_rx,\r\nbool *pb_is_cur_rdl_state)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (b_bias_on_rx) {\r\nif (cur_tx_bytes > (cur_rx_bytes*4)) {\r\n*pb_is_cur_rdl_state = false;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"Uplink Traffic\n ");\r\n} else {\r\n*pb_is_cur_rdl_state = true;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"Balance Traffic\n");\r\n}\r\n} else {\r\nif (cur_rx_bytes > (cur_tx_bytes*4)) {\r\n*pb_is_cur_rdl_state = true;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"Downlink Traffic\n");\r\n} else {\r\n*pb_is_cur_rdl_state = false;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"Balance Traffic\n");\r\n}\r\n}\r\nreturn;\r\n}\r\nstatic void rtl8821ae_dm_check_edca_turbo(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nu64 cur_tx_ok_cnt = 0;\r\nu64 cur_rx_ok_cnt = 0;\r\nu32 edca_be_ul = 0x5ea42b;\r\nu32 edca_be_dl = 0x5ea42b;\r\nu32 edca_be = 0x5ea42b;\r\nu8 iot_peer = 0;\r\nbool *pb_is_cur_rdl_state = NULL;\r\nbool b_last_is_cur_rdl_state = false;\r\nbool b_bias_on_rx = false;\r\nbool b_edca_turbo_on = false;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"rtl8821ae_dm_check_edca_turbo=====>\n");\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"Original BE PARAM: 0x%x\n",\r\nrtl_read_dword(rtlpriv, DM_REG_EDCA_BE_11N));\r\nif (rtlpriv->dm.dbginfo.num_non_be_pkt > 0x100)\r\nrtlpriv->dm.is_any_nonbepkts = true;\r\nrtlpriv->dm.dbginfo.num_non_be_pkt = 0;\r\nb_last_is_cur_rdl_state = rtlpriv->dm.is_cur_rdlstate;\r\npb_is_cur_rdl_state = &rtlpriv->dm.is_cur_rdlstate;\r\ncur_tx_ok_cnt = rtlpriv->stats.txbytesunicast - rtldm->last_tx_ok_cnt;\r\ncur_rx_ok_cnt = rtlpriv->stats.rxbytesunicast - rtldm->last_rx_ok_cnt;\r\nrtldm->last_tx_ok_cnt = rtlpriv->stats.txbytesunicast;\r\nrtldm->last_rx_ok_cnt = rtlpriv->stats.rxbytesunicast;\r\niot_peer = rtlpriv->mac80211.vendor;\r\nb_bias_on_rx = false;\r\nb_edca_turbo_on = ((!rtlpriv->dm.is_any_nonbepkts) &&\r\n(!rtlpriv->dm.disable_framebursting)) ?\r\ntrue : false;\r\nif (rtlpriv->rtlhal.hw_type != HARDWARE_TYPE_RTL8812AE) {\r\nif ((iot_peer == PEER_CISCO) &&\r\n(mac->mode == WIRELESS_MODE_N_24G)) {\r\nedca_be_dl = edca_setting_dl[iot_peer];\r\nedca_be_ul = edca_setting_ul[iot_peer];\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"bIsAnyNonBEPkts : 0x%x bDisableFrameBursting : 0x%x\n",\r\nrtlpriv->dm.is_any_nonbepkts,\r\nrtlpriv->dm.disable_framebursting);\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"bEdcaTurboOn : 0x%x bBiasOnRx : 0x%x\n",\r\nb_edca_turbo_on, b_bias_on_rx);\r\nif (b_edca_turbo_on) {\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"curTxOkCnt : 0x%llx\n", cur_tx_ok_cnt);\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"curRxOkCnt : 0x%llx\n", cur_rx_ok_cnt);\r\nif (b_bias_on_rx)\r\nrtl8821ae_dm_edca_choose_traffic_idx(hw, cur_tx_ok_cnt,\r\ncur_rx_ok_cnt, true, pb_is_cur_rdl_state);\r\nelse\r\nrtl8821ae_dm_edca_choose_traffic_idx(hw, cur_tx_ok_cnt,\r\ncur_rx_ok_cnt, false, pb_is_cur_rdl_state);\r\nedca_be = (*pb_is_cur_rdl_state) ? edca_be_dl : edca_be_ul;\r\nrtl_write_dword(rtlpriv, DM_REG_EDCA_BE_11N, edca_be);\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"EDCA Turbo on: EDCA_BE:0x%x\n", edca_be);\r\nrtlpriv->dm.current_turbo_edca = true;\r\nRT_TRACE(rtlpriv, COMP_TURBO, DBG_LOUD,\r\n"EDCA_BE_DL : 0x%x EDCA_BE_UL : 0x%x EDCA_BE : 0x%x\n",\r\nedca_be_dl, edca_be_ul, edca_be);\r\n} else {\r\nif (rtlpriv->dm.current_turbo_edca) {\r\nu8 tmp = AC0_BE;\r\nrtlpriv->cfg->ops->set_hw_reg(hw, HW_VAR_AC_PARAM,\r\n(u8 *)(&tmp));\r\n}\r\nrtlpriv->dm.current_turbo_edca = false;\r\n}\r\nrtlpriv->dm.is_any_nonbepkts = false;\r\nrtldm->last_tx_ok_cnt = rtlpriv->stats.txbytesunicast;\r\nrtldm->last_rx_ok_cnt = rtlpriv->stats.rxbytesunicast;\r\n}\r\nstatic void rtl8821ae_dm_cck_packet_detection_thresh(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\r\nu8 cur_cck_cca_thresh;\r\nif (rtlpriv->mac80211.link_state >= MAC80211_LINKED) {\r\nif (dm_digtable->rssi_val_min > 25) {\r\ncur_cck_cca_thresh = 0xcd;\r\n} else if ((dm_digtable->rssi_val_min <= 25) &&\r\n(dm_digtable->rssi_val_min > 10)) {\r\ncur_cck_cca_thresh = 0x83;\r\n} else {\r\nif (rtlpriv->falsealm_cnt.cnt_cck_fail > 1000)\r\ncur_cck_cca_thresh = 0x83;\r\nelse\r\ncur_cck_cca_thresh = 0x40;\r\n}\r\n} else {\r\nif (rtlpriv->falsealm_cnt.cnt_cck_fail > 1000)\r\ncur_cck_cca_thresh = 0x83;\r\nelse\r\ncur_cck_cca_thresh = 0x40;\r\n}\r\nif (dm_digtable->cur_cck_cca_thres != cur_cck_cca_thresh)\r\nrtl_write_byte(rtlpriv, ODM_REG_CCK_CCA_11AC,\r\ncur_cck_cca_thresh);\r\ndm_digtable->pre_cck_cca_thres = dm_digtable->cur_cck_cca_thres;\r\ndm_digtable->cur_cck_cca_thres = cur_cck_cca_thresh;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_TRACE,\r\n"CCK cca thresh hold =%x\n", dm_digtable->cur_cck_cca_thres);\r\n}\r\nstatic void rtl8821ae_dm_dynamic_atc_switch(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nu8 crystal_cap;\r\nu32 packet_count;\r\nint cfo_khz_a, cfo_khz_b, cfo_ave = 0, adjust_xtal = 0;\r\nint cfo_ave_diff;\r\nif (rtlpriv->mac80211.link_state < MAC80211_LINKED) {\r\nif (rtldm->atc_status == ATC_STATUS_OFF) {\r\nrtl_set_bbreg(hw, RFC_AREA, BIT(14), ATC_STATUS_ON);\r\nrtldm->atc_status = ATC_STATUS_ON;\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "No link!!\n");\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"atc_status = %d\n", rtldm->atc_status);\r\nif (rtldm->crystal_cap != rtlpriv->efuse.crystalcap) {\r\nrtldm->crystal_cap = rtlpriv->efuse.crystalcap;\r\ncrystal_cap = rtldm->crystal_cap & 0x3f;\r\ncrystal_cap = crystal_cap & 0x3f;\r\nif (rtlpriv->rtlhal.hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\r\n0x7ff80000, (crystal_cap |\r\n(crystal_cap << 6)));\r\nelse\r\nrtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\r\n0xfff000, (crystal_cap |\r\n(crystal_cap << 6)));\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD, "crystal_cap = 0x%x\n",\r\nrtldm->crystal_cap);\r\n} else{\r\ncfo_khz_a = (int)(rtldm->cfo_tail[0] * 3125) / 1280;\r\ncfo_khz_b = (int)(rtldm->cfo_tail[1] * 3125) / 1280;\r\npacket_count = rtldm->packet_count;\r\nif (packet_count == rtldm->packet_count_pre) {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"packet counter doesn't change\n");\r\nreturn;\r\n}\r\nrtldm->packet_count_pre = packet_count;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"packet counter = %d\n",\r\nrtldm->packet_count);\r\nif (rtlpriv->phy.rf_type == RF_1T1R)\r\ncfo_ave = cfo_khz_a;\r\nelse\r\ncfo_ave = (cfo_khz_a + cfo_khz_b) >> 1;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"cfo_khz_a = %dkHz, cfo_khz_b = %dkHz, cfo_ave = %dkHz\n",\r\ncfo_khz_a, cfo_khz_b, cfo_ave);\r\ncfo_ave_diff = (rtldm->cfo_ave_pre >= cfo_ave) ?\r\n(rtldm->cfo_ave_pre - cfo_ave) :\r\n(cfo_ave - rtldm->cfo_ave_pre);\r\nif (cfo_ave_diff > 20 && rtldm->large_cfo_hit == 0) {\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"first large CFO hit\n");\r\nrtldm->large_cfo_hit = 1;\r\nreturn;\r\n} else\r\nrtldm->large_cfo_hit = 0;\r\nrtldm->cfo_ave_pre = cfo_ave;\r\nif (cfo_ave >= -rtldm->cfo_threshold &&\r\ncfo_ave <= rtldm->cfo_threshold &&\r\nrtldm->is_freeze == 0) {\r\nif (rtldm->cfo_threshold == CFO_THRESHOLD_XTAL) {\r\nrtldm->cfo_threshold = CFO_THRESHOLD_XTAL + 10;\r\nrtldm->is_freeze = 1;\r\n} else {\r\nrtldm->cfo_threshold = CFO_THRESHOLD_XTAL;\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Dynamic threshold = %d\n",\r\nrtldm->cfo_threshold);\r\nif (cfo_ave > rtldm->cfo_threshold && rtldm->crystal_cap < 0x3f)\r\nadjust_xtal = ((cfo_ave - CFO_THRESHOLD_XTAL) >> 2) + 1;\r\nelse if ((cfo_ave < -rtlpriv->dm.cfo_threshold) &&\r\nrtlpriv->dm.crystal_cap > 0)\r\nadjust_xtal = ((cfo_ave + CFO_THRESHOLD_XTAL) >> 2) - 1;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"Crystal cap = 0x%x, Crystal cap offset = %d\n",\r\nrtldm->crystal_cap, adjust_xtal);\r\nif (adjust_xtal != 0) {\r\nrtldm->is_freeze = 0;\r\nrtldm->crystal_cap += adjust_xtal;\r\nif (rtldm->crystal_cap > 0x3f)\r\nrtldm->crystal_cap = 0x3f;\r\nelse if (rtldm->crystal_cap < 0)\r\nrtldm->crystal_cap = 0;\r\ncrystal_cap = rtldm->crystal_cap & 0x3f;\r\ncrystal_cap = crystal_cap & 0x3f;\r\nif (rtlpriv->rtlhal.hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\r\n0x7ff80000, (crystal_cap |\r\n(crystal_cap << 6)));\r\nelse\r\nrtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\r\n0xfff000, (crystal_cap |\r\n(crystal_cap << 6)));\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_LOUD,\r\n"New crystal cap = 0x%x\n",\r\nrtldm->crystal_cap);\r\n}\r\n}\r\n}\r\nvoid rtl8821ae_dm_watchdog(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nbool fw_current_inpsmode = false;\r\nbool fw_ps_awake = true;\r\nrtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FW_PSMODE_STATUS,\r\n(u8 *)(&fw_current_inpsmode));\r\nrtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FWLPS_RF_ON,\r\n(u8 *)(&fw_ps_awake));\r\nif (ppsc->p2p_ps_info.p2p_ps_mode)\r\nfw_ps_awake = false;\r\nspin_lock(&rtlpriv->locks.rf_ps_lock);\r\nif ((ppsc->rfpwr_state == ERFON) &&\r\n((!fw_current_inpsmode) && fw_ps_awake) &&\r\n(!ppsc->rfchange_inprogress)) {\r\nrtl8821ae_dm_common_info_self_update(hw);\r\nrtl8821ae_dm_false_alarm_counter_statistics(hw);\r\nrtl8821ae_dm_check_rssi_monitor(hw);\r\nrtl8821ae_dm_dig(hw);\r\nrtl8821ae_dm_cck_packet_detection_thresh(hw);\r\nrtl8821ae_dm_refresh_rate_adaptive_mask(hw);\r\nrtl8821ae_dm_refresh_basic_rate_mask(hw);\r\nrtl8821ae_dm_check_edca_turbo(hw);\r\nrtl8821ae_dm_dynamic_atc_switch(hw);\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\r\nrtl8812ae_dm_check_txpower_tracking_thermalmeter(hw);\r\nelse\r\nrtl8821ae_dm_check_txpower_tracking_thermalmeter(hw);\r\nrtl8821ae_dm_iq_calibrate(hw);\r\n}\r\nspin_unlock(&rtlpriv->locks.rf_ps_lock);\r\nrtlpriv->dm.dbginfo.num_qry_beacon_pkt = 0;\r\nRT_TRACE(rtlpriv, COMP_DIG, DBG_DMESG, "\n");\r\n}\r\nvoid rtl8821ae_dm_set_tx_ant_by_tx_info(struct ieee80211_hw *hw,\r\nu8 *pdesc, u32 mac_id)\r\n{\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\r\nstruct fast_ant_training *pfat_table = &rtldm->fat_table;\r\nif (rtlhal->hw_type != HARDWARE_TYPE_RTL8812AE)\r\nreturn;\r\nif (rtlefuse->antenna_div_type == CG_TRX_HW_ANTDIV)\r\nSET_TX_DESC_TX_ANT(pdesc, pfat_table->antsel_a[mac_id]);\r\n}

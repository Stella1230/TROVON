static void i915_save_display(struct drm_i915_private *dev_priv)\r\n{\r\nif (INTEL_GEN(dev_priv) <= 4)\r\ndev_priv->regfile.saveDSPARB = I915_READ(DSPARB);\r\nif (HAS_FBC(dev_priv) && INTEL_GEN(dev_priv) <= 4 && !IS_G4X(dev_priv))\r\ndev_priv->regfile.saveFBC_CONTROL = I915_READ(FBC_CONTROL);\r\n}\r\nstatic void i915_restore_display(struct drm_i915_private *dev_priv)\r\n{\r\nif (INTEL_GEN(dev_priv) <= 4)\r\nI915_WRITE(DSPARB, dev_priv->regfile.saveDSPARB);\r\nintel_fbc_global_disable(dev_priv);\r\nif (HAS_FBC(dev_priv) && INTEL_GEN(dev_priv) <= 4 && !IS_G4X(dev_priv))\r\nI915_WRITE(FBC_CONTROL, dev_priv->regfile.saveFBC_CONTROL);\r\ni915_redisable_vga(dev_priv);\r\n}\r\nint i915_save_state(struct drm_i915_private *dev_priv)\r\n{\r\nstruct pci_dev *pdev = dev_priv->drm.pdev;\r\nint i;\r\nmutex_lock(&dev_priv->drm.struct_mutex);\r\ni915_save_display(dev_priv);\r\nif (IS_GEN4(dev_priv))\r\npci_read_config_word(pdev, GCDGMBUS,\r\n&dev_priv->regfile.saveGCDGMBUS);\r\nif (INTEL_GEN(dev_priv) < 7)\r\ndev_priv->regfile.saveCACHE_MODE_0 = I915_READ(CACHE_MODE_0);\r\ndev_priv->regfile.saveMI_ARB_STATE = I915_READ(MI_ARB_STATE);\r\nif (IS_GEN2(dev_priv) && IS_MOBILE(dev_priv)) {\r\nfor (i = 0; i < 7; i++) {\r\ndev_priv->regfile.saveSWF0[i] = I915_READ(SWF0(i));\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n}\r\nfor (i = 0; i < 3; i++)\r\ndev_priv->regfile.saveSWF3[i] = I915_READ(SWF3(i));\r\n} else if (IS_GEN2(dev_priv)) {\r\nfor (i = 0; i < 7; i++)\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n} else if (HAS_GMCH_DISPLAY(dev_priv)) {\r\nfor (i = 0; i < 16; i++) {\r\ndev_priv->regfile.saveSWF0[i] = I915_READ(SWF0(i));\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n}\r\nfor (i = 0; i < 3; i++)\r\ndev_priv->regfile.saveSWF3[i] = I915_READ(SWF3(i));\r\n}\r\nmutex_unlock(&dev_priv->drm.struct_mutex);\r\nreturn 0;\r\n}\r\nint i915_restore_state(struct drm_i915_private *dev_priv)\r\n{\r\nstruct pci_dev *pdev = dev_priv->drm.pdev;\r\nint i;\r\nmutex_lock(&dev_priv->drm.struct_mutex);\r\ni915_gem_restore_fences(dev_priv);\r\nif (IS_GEN4(dev_priv))\r\npci_write_config_word(pdev, GCDGMBUS,\r\ndev_priv->regfile.saveGCDGMBUS);\r\ni915_restore_display(dev_priv);\r\nif (INTEL_GEN(dev_priv) < 7)\r\nI915_WRITE(CACHE_MODE_0, dev_priv->regfile.saveCACHE_MODE_0 |\r\n0xffff0000);\r\nI915_WRITE(MI_ARB_STATE, dev_priv->regfile.saveMI_ARB_STATE | 0xffff0000);\r\nif (IS_GEN2(dev_priv) && IS_MOBILE(dev_priv)) {\r\nfor (i = 0; i < 7; i++) {\r\nI915_WRITE(SWF0(i), dev_priv->regfile.saveSWF0[i]);\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n}\r\nfor (i = 0; i < 3; i++)\r\nI915_WRITE(SWF3(i), dev_priv->regfile.saveSWF3[i]);\r\n} else if (IS_GEN2(dev_priv)) {\r\nfor (i = 0; i < 7; i++)\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n} else if (HAS_GMCH_DISPLAY(dev_priv)) {\r\nfor (i = 0; i < 16; i++) {\r\nI915_WRITE(SWF0(i), dev_priv->regfile.saveSWF0[i]);\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n}\r\nfor (i = 0; i < 3; i++)\r\nI915_WRITE(SWF3(i), dev_priv->regfile.saveSWF3[i]);\r\n}\r\nmutex_unlock(&dev_priv->drm.struct_mutex);\r\nintel_i2c_reset(dev_priv);\r\nreturn 0;\r\n}

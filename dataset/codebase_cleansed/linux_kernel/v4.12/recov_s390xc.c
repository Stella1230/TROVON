static inline void xor_block(u8 *p1, u8 *p2)\r\n{\r\ntypedef struct { u8 _[256]; } addrtype;\r\nasm volatile(\r\n" xc 0(256,%[p1]),0(%[p2])\n"\r\n: "+m" (*(addrtype *) p1) : "m" (*(addrtype *) p2),\r\n[p1] "a" (p1), [p2] "a" (p2) : "cc");\r\n}\r\nstatic void raid6_2data_recov_s390xc(int disks, size_t bytes, int faila,\r\nint failb, void **ptrs)\r\n{\r\nu8 *p, *q, *dp, *dq;\r\nconst u8 *pbmul;\r\nconst u8 *qmul;\r\nint i;\r\np = (u8 *)ptrs[disks-2];\r\nq = (u8 *)ptrs[disks-1];\r\ndp = (u8 *)ptrs[faila];\r\nptrs[faila] = (void *)raid6_empty_zero_page;\r\nptrs[disks-2] = dp;\r\ndq = (u8 *)ptrs[failb];\r\nptrs[failb] = (void *)raid6_empty_zero_page;\r\nptrs[disks-1] = dq;\r\nraid6_call.gen_syndrome(disks, bytes, ptrs);\r\nptrs[faila] = dp;\r\nptrs[failb] = dq;\r\nptrs[disks-2] = p;\r\nptrs[disks-1] = q;\r\npbmul = raid6_gfmul[raid6_gfexi[failb-faila]];\r\nqmul = raid6_gfmul[raid6_gfinv[raid6_gfexp[faila]^raid6_gfexp[failb]]];\r\nwhile (bytes) {\r\nxor_block(dp, p);\r\nxor_block(dq, q);\r\nfor (i = 0; i < 256; i++)\r\ndq[i] = pbmul[dp[i]] ^ qmul[dq[i]];\r\nxor_block(dp, dq);\r\np += 256;\r\nq += 256;\r\ndp += 256;\r\ndq += 256;\r\nbytes -= 256;\r\n}\r\n}\r\nstatic void raid6_datap_recov_s390xc(int disks, size_t bytes, int faila,\r\nvoid **ptrs)\r\n{\r\nu8 *p, *q, *dq;\r\nconst u8 *qmul;\r\nint i;\r\np = (u8 *)ptrs[disks-2];\r\nq = (u8 *)ptrs[disks-1];\r\ndq = (u8 *)ptrs[faila];\r\nptrs[faila] = (void *)raid6_empty_zero_page;\r\nptrs[disks-1] = dq;\r\nraid6_call.gen_syndrome(disks, bytes, ptrs);\r\nptrs[faila] = dq;\r\nptrs[disks-1] = q;\r\nqmul = raid6_gfmul[raid6_gfinv[raid6_gfexp[faila]]];\r\nwhile (bytes) {\r\nxor_block(dq, q);\r\nfor (i = 0; i < 256; i++)\r\ndq[i] = qmul[dq[i]];\r\nxor_block(p, dq);\r\np += 256;\r\nq += 256;\r\ndq += 256;\r\nbytes -= 256;\r\n}\r\n}

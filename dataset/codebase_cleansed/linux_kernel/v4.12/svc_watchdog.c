static int svc_watchdog_pm_notifier(struct notifier_block *notifier,\r\nunsigned long pm_event, void *unused)\r\n{\r\nstruct gb_svc_watchdog *watchdog =\r\ncontainer_of(notifier, struct gb_svc_watchdog, pm_notifier);\r\nswitch (pm_event) {\r\ncase PM_SUSPEND_PREPARE:\r\ngb_svc_watchdog_disable(watchdog->svc);\r\nbreak;\r\ncase PM_POST_SUSPEND:\r\ngb_svc_watchdog_enable(watchdog->svc);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void greybus_reset(struct work_struct *work)\r\n{\r\nstatic char const start_path[] = "/system/bin/start";\r\nstatic char *envp[] = {\r\n"HOME=/",\r\n"PATH=/sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin",\r\nNULL,\r\n};\r\nstatic char *argv[] = {\r\n(char *)start_path,\r\n"unipro_reset",\r\nNULL,\r\n};\r\npr_err("svc_watchdog: calling \"%s %s\" to reset greybus network!\n",\r\nargv[0], argv[1]);\r\ncall_usermodehelper(start_path, argv, envp, UMH_WAIT_EXEC);\r\n}\r\nstatic void do_work(struct work_struct *work)\r\n{\r\nstruct gb_svc_watchdog *watchdog;\r\nstruct gb_svc *svc;\r\nint retval;\r\nwatchdog = container_of(work, struct gb_svc_watchdog, work.work);\r\nsvc = watchdog->svc;\r\ndev_dbg(&svc->dev, "%s: ping.\n", __func__);\r\nretval = gb_svc_ping(svc);\r\nif (retval) {\r\ndev_err(&svc->dev,\r\n"SVC ping has returned %d, something is wrong!!!\n",\r\nretval);\r\nif (svc->action == GB_SVC_WATCHDOG_BITE_PANIC_KERNEL) {\r\npanic("SVC is not responding\n");\r\n} else if (svc->action == GB_SVC_WATCHDOG_BITE_RESET_UNIPRO) {\r\ndev_err(&svc->dev, "Resetting the greybus network, watch out!!!\n");\r\nINIT_DELAYED_WORK(&reset_work, greybus_reset);\r\nschedule_delayed_work(&reset_work, HZ / 2);\r\nwatchdog->enabled = false;\r\n}\r\n}\r\nif (watchdog->enabled)\r\nschedule_delayed_work(&watchdog->work, SVC_WATCHDOG_PERIOD);\r\n}\r\nint gb_svc_watchdog_create(struct gb_svc *svc)\r\n{\r\nstruct gb_svc_watchdog *watchdog;\r\nint retval;\r\nif (svc->watchdog)\r\nreturn 0;\r\nwatchdog = kmalloc(sizeof(*watchdog), GFP_KERNEL);\r\nif (!watchdog)\r\nreturn -ENOMEM;\r\nwatchdog->enabled = false;\r\nwatchdog->svc = svc;\r\nINIT_DELAYED_WORK(&watchdog->work, do_work);\r\nsvc->watchdog = watchdog;\r\nwatchdog->pm_notifier.notifier_call = svc_watchdog_pm_notifier;\r\nretval = register_pm_notifier(&watchdog->pm_notifier);\r\nif (retval) {\r\ndev_err(&svc->dev, "error registering pm notifier(%d)\n",\r\nretval);\r\ngoto svc_watchdog_create_err;\r\n}\r\nretval = gb_svc_watchdog_enable(svc);\r\nif (retval) {\r\ndev_err(&svc->dev, "error enabling watchdog (%d)\n", retval);\r\nunregister_pm_notifier(&watchdog->pm_notifier);\r\ngoto svc_watchdog_create_err;\r\n}\r\nreturn retval;\r\nsvc_watchdog_create_err:\r\nsvc->watchdog = NULL;\r\nkfree(watchdog);\r\nreturn retval;\r\n}\r\nvoid gb_svc_watchdog_destroy(struct gb_svc *svc)\r\n{\r\nstruct gb_svc_watchdog *watchdog = svc->watchdog;\r\nif (!watchdog)\r\nreturn;\r\nunregister_pm_notifier(&watchdog->pm_notifier);\r\ngb_svc_watchdog_disable(svc);\r\nsvc->watchdog = NULL;\r\nkfree(watchdog);\r\n}\r\nbool gb_svc_watchdog_enabled(struct gb_svc *svc)\r\n{\r\nif (!svc || !svc->watchdog)\r\nreturn false;\r\nreturn svc->watchdog->enabled;\r\n}\r\nint gb_svc_watchdog_enable(struct gb_svc *svc)\r\n{\r\nstruct gb_svc_watchdog *watchdog;\r\nif (!svc->watchdog)\r\nreturn -ENODEV;\r\nwatchdog = svc->watchdog;\r\nif (watchdog->enabled)\r\nreturn 0;\r\nwatchdog->enabled = true;\r\nschedule_delayed_work(&watchdog->work, SVC_WATCHDOG_PERIOD);\r\nreturn 0;\r\n}\r\nint gb_svc_watchdog_disable(struct gb_svc *svc)\r\n{\r\nstruct gb_svc_watchdog *watchdog;\r\nif (!svc->watchdog)\r\nreturn -ENODEV;\r\nwatchdog = svc->watchdog;\r\nif (!watchdog->enabled)\r\nreturn 0;\r\nwatchdog->enabled = false;\r\ncancel_delayed_work_sync(&watchdog->work);\r\nreturn 0;\r\n}

static int clk_sysctrl_prepare(struct clk_hw *hw)\r\n{\r\nint ret;\r\nstruct clk_sysctrl *clk = to_clk_sysctrl(hw);\r\nret = ab8500_sysctrl_write(clk->reg_sel[0], clk->reg_mask[0],\r\nclk->reg_bits[0]);\r\nif (!ret && clk->enable_delay_us)\r\nusleep_range(clk->enable_delay_us, clk->enable_delay_us);\r\nreturn ret;\r\n}\r\nstatic void clk_sysctrl_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_sysctrl *clk = to_clk_sysctrl(hw);\r\nif (ab8500_sysctrl_clear(clk->reg_sel[0], clk->reg_mask[0]))\r\ndev_err(clk->dev, "clk_sysctrl: %s fail to clear %s.\n",\r\n__func__, clk_hw_get_name(hw));\r\n}\r\nstatic unsigned long clk_sysctrl_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_sysctrl *clk = to_clk_sysctrl(hw);\r\nreturn clk->rate;\r\n}\r\nstatic int clk_sysctrl_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct clk_sysctrl *clk = to_clk_sysctrl(hw);\r\nu8 old_index = clk->parent_index;\r\nint ret = 0;\r\nif (clk->reg_sel[old_index]) {\r\nret = ab8500_sysctrl_clear(clk->reg_sel[old_index],\r\nclk->reg_mask[old_index]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (clk->reg_sel[index]) {\r\nret = ab8500_sysctrl_write(clk->reg_sel[index],\r\nclk->reg_mask[index],\r\nclk->reg_bits[index]);\r\nif (ret) {\r\nif (clk->reg_sel[old_index])\r\nab8500_sysctrl_write(clk->reg_sel[old_index],\r\nclk->reg_mask[old_index],\r\nclk->reg_bits[old_index]);\r\nreturn ret;\r\n}\r\n}\r\nclk->parent_index = index;\r\nreturn ret;\r\n}\r\nstatic u8 clk_sysctrl_get_parent(struct clk_hw *hw)\r\n{\r\nstruct clk_sysctrl *clk = to_clk_sysctrl(hw);\r\nreturn clk->parent_index;\r\n}\r\nstatic struct clk *clk_reg_sysctrl(struct device *dev,\r\nconst char *name,\r\nconst char **parent_names,\r\nu8 num_parents,\r\nu16 *reg_sel,\r\nu8 *reg_mask,\r\nu8 *reg_bits,\r\nunsigned long rate,\r\nunsigned long enable_delay_us,\r\nunsigned long flags,\r\nstruct clk_ops *clk_sysctrl_ops)\r\n{\r\nstruct clk_sysctrl *clk;\r\nstruct clk_init_data clk_sysctrl_init;\r\nstruct clk *clk_reg;\r\nint i;\r\nif (!dev)\r\nreturn ERR_PTR(-EINVAL);\r\nif (!name || (num_parents > SYSCTRL_MAX_NUM_PARENTS)) {\r\ndev_err(dev, "clk_sysctrl: invalid arguments passed\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nclk = devm_kzalloc(dev, sizeof(struct clk_sysctrl), GFP_KERNEL);\r\nif (!clk) {\r\ndev_err(dev, "clk_sysctrl: could not allocate clk\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nclk->reg_sel[0] = reg_sel[0];\r\nclk->reg_bits[0] = reg_bits[0];\r\nclk->reg_mask[0] = reg_mask[0];\r\nfor (i = 1; i < num_parents; i++) {\r\nclk->reg_sel[i] = reg_sel[i];\r\nclk->reg_bits[i] = reg_bits[i];\r\nclk->reg_mask[i] = reg_mask[i];\r\n}\r\nclk->parent_index = 0;\r\nclk->rate = rate;\r\nclk->enable_delay_us = enable_delay_us;\r\nclk->dev = dev;\r\nclk_sysctrl_init.name = name;\r\nclk_sysctrl_init.ops = clk_sysctrl_ops;\r\nclk_sysctrl_init.flags = flags;\r\nclk_sysctrl_init.parent_names = parent_names;\r\nclk_sysctrl_init.num_parents = num_parents;\r\nclk->hw.init = &clk_sysctrl_init;\r\nclk_reg = devm_clk_register(clk->dev, &clk->hw);\r\nif (IS_ERR(clk_reg))\r\ndev_err(dev, "clk_sysctrl: clk_register failed\n");\r\nreturn clk_reg;\r\n}\r\nstruct clk *clk_reg_sysctrl_gate(struct device *dev,\r\nconst char *name,\r\nconst char *parent_name,\r\nu16 reg_sel,\r\nu8 reg_mask,\r\nu8 reg_bits,\r\nunsigned long enable_delay_us,\r\nunsigned long flags)\r\n{\r\nconst char **parent_names = (parent_name ? &parent_name : NULL);\r\nu8 num_parents = (parent_name ? 1 : 0);\r\nreturn clk_reg_sysctrl(dev, name, parent_names, num_parents,\r\n&reg_sel, &reg_mask, &reg_bits, 0, enable_delay_us,\r\nflags, &clk_sysctrl_gate_ops);\r\n}\r\nstruct clk *clk_reg_sysctrl_gate_fixed_rate(struct device *dev,\r\nconst char *name,\r\nconst char *parent_name,\r\nu16 reg_sel,\r\nu8 reg_mask,\r\nu8 reg_bits,\r\nunsigned long rate,\r\nunsigned long enable_delay_us,\r\nunsigned long flags)\r\n{\r\nconst char **parent_names = (parent_name ? &parent_name : NULL);\r\nu8 num_parents = (parent_name ? 1 : 0);\r\nreturn clk_reg_sysctrl(dev, name, parent_names, num_parents,\r\n&reg_sel, &reg_mask, &reg_bits,\r\nrate, enable_delay_us, flags,\r\n&clk_sysctrl_gate_fixed_rate_ops);\r\n}\r\nstruct clk *clk_reg_sysctrl_set_parent(struct device *dev,\r\nconst char *name,\r\nconst char **parent_names,\r\nu8 num_parents,\r\nu16 *reg_sel,\r\nu8 *reg_mask,\r\nu8 *reg_bits,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_sysctrl(dev, name, parent_names, num_parents,\r\nreg_sel, reg_mask, reg_bits, 0, 0, flags,\r\n&clk_sysctrl_set_parent_ops);\r\n}

void obdo_set_parent_fid(struct obdo *dst, const struct lu_fid *parent)\r\n{\r\ndst->o_parent_oid = fid_oid(parent);\r\ndst->o_parent_seq = fid_seq(parent);\r\ndst->o_parent_ver = fid_ver(parent);\r\ndst->o_valid |= OBD_MD_FLGENER | OBD_MD_FLFID;\r\n}\r\nvoid obdo_from_inode(struct obdo *dst, struct inode *src, u32 valid)\r\n{\r\nu32 newvalid = 0;\r\nif (valid & (OBD_MD_FLCTIME | OBD_MD_FLMTIME))\r\nCDEBUG(D_INODE, "valid %x, new time %lu/%lu\n",\r\nvalid, LTIME_S(src->i_mtime),\r\nLTIME_S(src->i_ctime));\r\nif (valid & OBD_MD_FLATIME) {\r\ndst->o_atime = LTIME_S(src->i_atime);\r\nnewvalid |= OBD_MD_FLATIME;\r\n}\r\nif (valid & OBD_MD_FLMTIME) {\r\ndst->o_mtime = LTIME_S(src->i_mtime);\r\nnewvalid |= OBD_MD_FLMTIME;\r\n}\r\nif (valid & OBD_MD_FLCTIME) {\r\ndst->o_ctime = LTIME_S(src->i_ctime);\r\nnewvalid |= OBD_MD_FLCTIME;\r\n}\r\nif (valid & OBD_MD_FLSIZE) {\r\ndst->o_size = i_size_read(src);\r\nnewvalid |= OBD_MD_FLSIZE;\r\n}\r\nif (valid & OBD_MD_FLBLOCKS) {\r\ndst->o_blocks = src->i_blocks;\r\nnewvalid |= OBD_MD_FLBLOCKS;\r\n}\r\nif (valid & OBD_MD_FLBLKSZ) {\r\ndst->o_blksize = 1 << src->i_blkbits;\r\nnewvalid |= OBD_MD_FLBLKSZ;\r\n}\r\nif (valid & OBD_MD_FLTYPE) {\r\ndst->o_mode = (dst->o_mode & S_IALLUGO) |\r\n(src->i_mode & S_IFMT);\r\nnewvalid |= OBD_MD_FLTYPE;\r\n}\r\nif (valid & OBD_MD_FLMODE) {\r\ndst->o_mode = (dst->o_mode & S_IFMT) |\r\n(src->i_mode & S_IALLUGO);\r\nnewvalid |= OBD_MD_FLMODE;\r\n}\r\nif (valid & OBD_MD_FLUID) {\r\ndst->o_uid = from_kuid(&init_user_ns, src->i_uid);\r\nnewvalid |= OBD_MD_FLUID;\r\n}\r\nif (valid & OBD_MD_FLGID) {\r\ndst->o_gid = from_kgid(&init_user_ns, src->i_gid);\r\nnewvalid |= OBD_MD_FLGID;\r\n}\r\nif (valid & OBD_MD_FLFLAGS) {\r\ndst->o_flags = src->i_flags;\r\nnewvalid |= OBD_MD_FLFLAGS;\r\n}\r\ndst->o_valid |= newvalid;\r\n}\r\nvoid obdo_to_ioobj(const struct obdo *oa, struct obd_ioobj *ioobj)\r\n{\r\nioobj->ioo_oid = oa->o_oi;\r\nif (unlikely(!(oa->o_valid & OBD_MD_FLGROUP)))\r\nostid_set_seq_mdt0(&ioobj->ioo_oid);\r\nioobj->ioo_max_brw = 0;\r\n}\r\nvoid lustre_set_wire_obdo(const struct obd_connect_data *ocd,\r\nstruct obdo *wobdo, const struct obdo *lobdo)\r\n{\r\n*wobdo = *lobdo;\r\nwobdo->o_flags &= ~OBD_FL_LOCAL_MASK;\r\nif (!ocd)\r\nreturn;\r\nif (unlikely(!(ocd->ocd_connect_flags & OBD_CONNECT_FID)) &&\r\nfid_seq_is_echo(ostid_seq(&lobdo->o_oi))) {\r\nwobdo->o_oi.oi.oi_id = fid_oid(&lobdo->o_oi.oi_fid);\r\nwobdo->o_oi.oi.oi_seq = fid_seq(&lobdo->o_oi.oi_fid);\r\n}\r\n}\r\nvoid lustre_get_wire_obdo(const struct obd_connect_data *ocd,\r\nstruct obdo *lobdo, const struct obdo *wobdo)\r\n{\r\nu32 local_flags = 0;\r\nif (lobdo->o_valid & OBD_MD_FLFLAGS)\r\nlocal_flags = lobdo->o_flags & OBD_FL_LOCAL_MASK;\r\n*lobdo = *wobdo;\r\nif (local_flags) {\r\nlobdo->o_valid |= OBD_MD_FLFLAGS;\r\nlobdo->o_flags &= ~OBD_FL_LOCAL_MASK;\r\nlobdo->o_flags |= local_flags;\r\n}\r\nif (!ocd)\r\nreturn;\r\nif (unlikely(!(ocd->ocd_connect_flags & OBD_CONNECT_FID)) &&\r\nfid_seq_is_echo(wobdo->o_oi.oi.oi_seq)) {\r\nlobdo->o_oi.oi_fid.f_seq = wobdo->o_oi.oi.oi_seq;\r\nlobdo->o_oi.oi_fid.f_oid = wobdo->o_oi.oi.oi_id;\r\nlobdo->o_oi.oi_fid.f_ver = 0;\r\n}\r\n}

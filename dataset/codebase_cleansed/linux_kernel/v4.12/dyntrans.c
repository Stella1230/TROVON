static int kvm_mips_trans_replace(struct kvm_vcpu *vcpu, u32 *opc,\r\nunion mips_instruction replace)\r\n{\r\nunsigned long vaddr = (unsigned long)opc;\r\nint err;\r\nretry:\r\nkvm_trap_emul_gva_lockless_begin(vcpu);\r\nerr = put_user(replace.word, opc);\r\nkvm_trap_emul_gva_lockless_end(vcpu);\r\nif (unlikely(err)) {\r\nerr = kvm_trap_emul_gva_fault(vcpu, vaddr, true);\r\nif (unlikely(err)) {\r\nkvm_info("%s: Address unwriteable: %p\n",\r\n__func__, opc);\r\nreturn -EFAULT;\r\n}\r\ngoto retry;\r\n}\r\n__local_flush_icache_user_range(vaddr, vaddr + 4);\r\nreturn 0;\r\n}\r\nint kvm_mips_trans_cache_index(union mips_instruction inst, u32 *opc,\r\nstruct kvm_vcpu *vcpu)\r\n{\r\nunion mips_instruction nop_inst = { 0 };\r\nreturn kvm_mips_trans_replace(vcpu, opc, nop_inst);\r\n}\r\nint kvm_mips_trans_cache_va(union mips_instruction inst, u32 *opc,\r\nstruct kvm_vcpu *vcpu)\r\n{\r\nunion mips_instruction synci_inst = { 0 };\r\nsynci_inst.i_format.opcode = bcond_op;\r\nsynci_inst.i_format.rs = inst.i_format.rs;\r\nsynci_inst.i_format.rt = synci_op;\r\nif (cpu_has_mips_r6)\r\nsynci_inst.i_format.simmediate = inst.spec3_format.simmediate;\r\nelse\r\nsynci_inst.i_format.simmediate = inst.i_format.simmediate;\r\nreturn kvm_mips_trans_replace(vcpu, opc, synci_inst);\r\n}\r\nint kvm_mips_trans_mfc0(union mips_instruction inst, u32 *opc,\r\nstruct kvm_vcpu *vcpu)\r\n{\r\nunion mips_instruction mfc0_inst = { 0 };\r\nu32 rd, sel;\r\nrd = inst.c0r_format.rd;\r\nsel = inst.c0r_format.sel;\r\nif (rd == MIPS_CP0_ERRCTL && sel == 0) {\r\nmfc0_inst.r_format.opcode = spec_op;\r\nmfc0_inst.r_format.rd = inst.c0r_format.rt;\r\nmfc0_inst.r_format.func = add_op;\r\n} else {\r\nmfc0_inst.i_format.opcode = lw_op;\r\nmfc0_inst.i_format.rt = inst.c0r_format.rt;\r\nmfc0_inst.i_format.simmediate = KVM_GUEST_COMMPAGE_ADDR |\r\noffsetof(struct kvm_mips_commpage, cop0.reg[rd][sel]);\r\n#ifdef CONFIG_CPU_BIG_ENDIAN\r\nif (sizeof(vcpu->arch.cop0->reg[0][0]) == 8)\r\nmfc0_inst.i_format.simmediate |= 4;\r\n#endif\r\n}\r\nreturn kvm_mips_trans_replace(vcpu, opc, mfc0_inst);\r\n}\r\nint kvm_mips_trans_mtc0(union mips_instruction inst, u32 *opc,\r\nstruct kvm_vcpu *vcpu)\r\n{\r\nunion mips_instruction mtc0_inst = { 0 };\r\nu32 rd, sel;\r\nrd = inst.c0r_format.rd;\r\nsel = inst.c0r_format.sel;\r\nmtc0_inst.i_format.opcode = sw_op;\r\nmtc0_inst.i_format.rt = inst.c0r_format.rt;\r\nmtc0_inst.i_format.simmediate = KVM_GUEST_COMMPAGE_ADDR |\r\noffsetof(struct kvm_mips_commpage, cop0.reg[rd][sel]);\r\n#ifdef CONFIG_CPU_BIG_ENDIAN\r\nif (sizeof(vcpu->arch.cop0->reg[0][0]) == 8)\r\nmtc0_inst.i_format.simmediate |= 4;\r\n#endif\r\nreturn kvm_mips_trans_replace(vcpu, opc, mtc0_inst);\r\n}

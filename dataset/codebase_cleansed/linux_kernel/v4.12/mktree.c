int main(int argc, char *argv[])\r\n{\r\nint in_fd, out_fd;\r\nint nblks, i;\r\nunsigned int cksum, *cp;\r\nstruct stat st;\r\nboot_block_t bt;\r\nif (argc < 5) {\r\nfprintf(stderr, "usage: %s <zImage-file> <boot-image> <load address> <entry point>\n",argv[0]);\r\nexit(1);\r\n}\r\nif (stat(argv[1], &st) < 0) {\r\nperror("stat");\r\nexit(2);\r\n}\r\nnblks = (st.st_size + IMGBLK) / IMGBLK;\r\nbt.bb_magic = htonl(0x0052504F);\r\nbt.bb_dest = htonl(strtoul(argv[3], NULL, 0));\r\nbt.bb_entry_point = htonl(strtoul(argv[4], NULL, 0));\r\nbt.bb_num_512blocks = htonl(nblks);\r\nbt.bb_debug_flag = 0;\r\nbt.bb_checksum = 0;\r\nbt.reserved[0] = 0;\r\nbt.reserved[1] = 0;\r\nif ((in_fd = open(argv[1], O_RDONLY)) < 0) {\r\nperror("zImage open");\r\nexit(3);\r\n}\r\nif ((out_fd = open(argv[2], (O_RDWR | O_CREAT | O_TRUNC), 0666)) < 0) {\r\nperror("bootfile open");\r\nexit(3);\r\n}\r\ncksum = 0;\r\ncp = (void *)&bt;\r\nfor (i = 0; i < sizeof(bt) / sizeof(unsigned int); i++)\r\ncksum += *cp++;\r\nif (read(in_fd, tmpbuf, sizeof(tmpbuf)) != sizeof(tmpbuf)) {\r\nfprintf(stderr, "%s is too small to be an ELF image\n",\r\nargv[1]);\r\nexit(4);\r\n}\r\nif (tmpbuf[0] != htonl(0x7f454c46)) {\r\nfprintf(stderr, "%s is not an ELF image\n", argv[1]);\r\nexit(4);\r\n}\r\nif (lseek(in_fd, (64 * 1024), SEEK_SET) < 0) {\r\nfprintf(stderr, "%s failed to seek in ELF image\n", argv[1]);\r\nexit(4);\r\n}\r\nnblks -= (64 * 1024) / IMGBLK;\r\nif (write(out_fd, &bt, sizeof(bt)) != sizeof(bt)) {\r\nperror("boot-image write");\r\nexit(5);\r\n}\r\nwhile (nblks-- > 0) {\r\nif (read(in_fd, tmpbuf, sizeof(tmpbuf)) < 0) {\r\nperror("zImage read");\r\nexit(5);\r\n}\r\ncp = tmpbuf;\r\nfor (i = 0; i < sizeof(tmpbuf) / sizeof(unsigned int); i++)\r\ncksum += *cp++;\r\nif (write(out_fd, tmpbuf, sizeof(tmpbuf)) != sizeof(tmpbuf)) {\r\nperror("boot-image write");\r\nexit(5);\r\n}\r\n}\r\nbt.bb_checksum = htonl(cksum);\r\nif (lseek(out_fd, 0, SEEK_SET) < 0) {\r\nperror("rewrite seek");\r\nexit(1);\r\n}\r\nif (write(out_fd, &bt, sizeof(bt)) != sizeof(bt)) {\r\nperror("boot-image rewrite");\r\nexit(1);\r\n}\r\nexit(0);\r\n}

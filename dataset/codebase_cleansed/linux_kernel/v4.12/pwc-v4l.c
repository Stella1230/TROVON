int pwc_init_controls(struct pwc_device *pdev)\r\n{\r\nstruct v4l2_ctrl_handler *hdl;\r\nstruct v4l2_ctrl_config cfg;\r\nint r, def;\r\nhdl = &pdev->ctrl_handler;\r\nr = v4l2_ctrl_handler_init(hdl, 20);\r\nif (r)\r\nreturn r;\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, BRIGHTNESS_FORMATTER, &def);\r\nif (r || def > 127)\r\ndef = 63;\r\npdev->brightness = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_BRIGHTNESS, 0, 127, 1, def);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, CONTRAST_FORMATTER, &def);\r\nif (r || def > 63)\r\ndef = 31;\r\npdev->contrast = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_CONTRAST, 0, 63, 1, def);\r\nif (pdev->type >= 675) {\r\nif (pdev->type < 730)\r\npdev->saturation_fmt = SATURATION_MODE_FORMATTER2;\r\nelse\r\npdev->saturation_fmt = SATURATION_MODE_FORMATTER1;\r\nr = pwc_get_s8_ctrl(pdev, GET_CHROM_CTL, pdev->saturation_fmt,\r\n&def);\r\nif (r || def < -100 || def > 100)\r\ndef = 0;\r\npdev->saturation = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_SATURATION, -100, 100, 1, def);\r\n}\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, GAMMA_FORMATTER, &def);\r\nif (r || def > 31)\r\ndef = 15;\r\npdev->gamma = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_GAMMA, 0, 31, 1, def);\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL, WB_MODE_FORMATTER, &def);\r\nif (r || def > awb_auto)\r\ndef = awb_auto;\r\ncfg = pwc_auto_white_balance_cfg;\r\ncfg.name = v4l2_ctrl_get_name(cfg.id);\r\ncfg.def = def;\r\npdev->auto_white_balance = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nif (!pdev->auto_white_balance)\r\nreturn hdl->error;\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL,\r\nPRESET_MANUAL_RED_GAIN_FORMATTER, &def);\r\nif (r)\r\ndef = 127;\r\npdev->red_balance = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_RED_BALANCE, 0, 255, 1, def);\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL,\r\nPRESET_MANUAL_BLUE_GAIN_FORMATTER, &def);\r\nif (r)\r\ndef = 127;\r\npdev->blue_balance = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_BLUE_BALANCE, 0, 255, 1, def);\r\nv4l2_ctrl_auto_cluster(3, &pdev->auto_white_balance, awb_manual, true);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, AGC_MODE_FORMATTER, &def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0;\r\npdev->autogain = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_AUTOGAIN, 0, 1, 1, def == 0);\r\nif (!pdev->autogain)\r\nreturn hdl->error;\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, PRESET_AGC_FORMATTER, &def);\r\nif (r || def > 63)\r\ndef = 31;\r\npdev->gain = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_GAIN, 0, 63, 1, def);\r\nif (DEVICE_USE_CODEC2(pdev->type)) {\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, SHUTTER_MODE_FORMATTER,\r\n&def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0;\r\npdev->exposure_auto = v4l2_ctrl_new_std_menu(hdl,\r\n&pwc_ctrl_ops,\r\nV4L2_CID_EXPOSURE_AUTO,\r\n1, 0, def != 0);\r\nif (!pdev->exposure_auto)\r\nreturn hdl->error;\r\nr = pwc_get_u16_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_SHUTTER_FORMATTER, &def);\r\nif (r || def > 655)\r\ndef = 655;\r\npdev->exposure = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_EXPOSURE, 0, 655, 1, def);\r\nv4l2_ctrl_auto_cluster(2, &pdev->autogain, 0, true);\r\nv4l2_ctrl_auto_cluster(2, &pdev->exposure_auto,\r\nV4L2_EXPOSURE_MANUAL, true);\r\n} else if (DEVICE_USE_CODEC3(pdev->type)) {\r\nr = pwc_get_u16_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_SHUTTER_FORMATTER, &def);\r\nif (r || def > 255)\r\ndef = 255;\r\npdev->exposure = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_EXPOSURE, 0, 255, 1, def);\r\npdev->autogain_expo_cluster[0] = pdev->autogain;\r\npdev->autogain_expo_cluster[1] = pdev->gain;\r\npdev->autogain_expo_cluster[2] = pdev->exposure;\r\nv4l2_ctrl_auto_cluster(3, pdev->autogain_expo_cluster,\r\n0, true);\r\n}\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL, COLOUR_MODE_FORMATTER,\r\n&def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0xff;\r\npdev->colorfx = v4l2_ctrl_new_std_menu(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_COLORFX, 1, 0, def == 0);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, AUTO_CONTOUR_FORMATTER, &def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0;\r\ncfg = pwc_autocontour_cfg;\r\ncfg.def = def == 0;\r\npdev->autocontour = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nif (!pdev->autocontour)\r\nreturn hdl->error;\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL, PRESET_CONTOUR_FORMATTER, &def);\r\nif (r || def > 63)\r\ndef = 31;\r\ncfg = pwc_contour_cfg;\r\ncfg.def = def;\r\npdev->contour = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nv4l2_ctrl_auto_cluster(2, &pdev->autocontour, 0, false);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL,\r\nBACK_LIGHT_COMPENSATION_FORMATTER, &def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0;\r\ncfg = pwc_backlight_cfg;\r\ncfg.name = v4l2_ctrl_get_name(cfg.id);\r\ncfg.def = def == 0;\r\npdev->backlight = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL,\r\nFLICKERLESS_MODE_FORMATTER, &def);\r\nif (r || (def != 0 && def != 0xff))\r\ndef = 0;\r\ncfg = pwc_flicker_cfg;\r\ncfg.name = v4l2_ctrl_get_name(cfg.id);\r\ncfg.def = def == 0;\r\npdev->flicker = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nr = pwc_get_u8_ctrl(pdev, GET_LUM_CTL,\r\nDYNAMIC_NOISE_CONTROL_FORMATTER, &def);\r\nif (r || def > 3)\r\ndef = 2;\r\ncfg = pwc_noise_reduction_cfg;\r\ncfg.def = def;\r\npdev->noise_reduction = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\npdev->save_user = v4l2_ctrl_new_custom(hdl, &pwc_save_user_cfg, NULL);\r\npdev->restore_user = v4l2_ctrl_new_custom(hdl, &pwc_restore_user_cfg,\r\nNULL);\r\nif (pdev->restore_user)\r\npdev->restore_user->flags |= V4L2_CTRL_FLAG_UPDATE;\r\npdev->restore_factory = v4l2_ctrl_new_custom(hdl,\r\n&pwc_restore_factory_cfg,\r\nNULL);\r\nif (pdev->restore_factory)\r\npdev->restore_factory->flags |= V4L2_CTRL_FLAG_UPDATE;\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL,\r\nAWB_CONTROL_SPEED_FORMATTER, &def);\r\nif (r || def < 1 || def > 32)\r\ndef = 1;\r\ncfg = pwc_awb_speed_cfg;\r\ncfg.def = def;\r\npdev->awb_speed = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nr = pwc_get_u8_ctrl(pdev, GET_CHROM_CTL,\r\nAWB_CONTROL_DELAY_FORMATTER, &def);\r\nif (r || def > 63)\r\ndef = 0;\r\ncfg = pwc_awb_delay_cfg;\r\ncfg.def = def;\r\npdev->awb_delay = v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\nif (!(pdev->features & FEATURE_MOTOR_PANTILT))\r\nreturn hdl->error;\r\npdev->motor_pan = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_PAN_RELATIVE, -4480, 4480, 64, 0);\r\nif (!pdev->motor_pan)\r\nreturn hdl->error;\r\npdev->motor_tilt = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_TILT_RELATIVE, -1920, 1920, 64, 0);\r\npdev->motor_pan_reset = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_PAN_RESET, 0, 0, 0, 0);\r\npdev->motor_tilt_reset = v4l2_ctrl_new_std(hdl, &pwc_ctrl_ops,\r\nV4L2_CID_TILT_RESET, 0, 0, 0, 0);\r\nv4l2_ctrl_cluster(4, &pdev->motor_pan);\r\nreturn hdl->error;\r\n}\r\nstatic void pwc_vidioc_fill_fmt(struct v4l2_format *f,\r\nint width, int height, u32 pixfmt)\r\n{\r\nmemset(&f->fmt.pix, 0, sizeof(struct v4l2_pix_format));\r\nf->fmt.pix.width = width;\r\nf->fmt.pix.height = height;\r\nf->fmt.pix.field = V4L2_FIELD_NONE;\r\nf->fmt.pix.pixelformat = pixfmt;\r\nf->fmt.pix.bytesperline = f->fmt.pix.width;\r\nf->fmt.pix.sizeimage = f->fmt.pix.height * f->fmt.pix.width * 3 / 2;\r\nf->fmt.pix.colorspace = V4L2_COLORSPACE_SRGB;\r\nPWC_DEBUG_IOCTL("pwc_vidioc_fill_fmt() width=%d, height=%d, bytesperline=%d, sizeimage=%d, pixelformat=%c%c%c%c\n",\r\nf->fmt.pix.width,\r\nf->fmt.pix.height,\r\nf->fmt.pix.bytesperline,\r\nf->fmt.pix.sizeimage,\r\n(f->fmt.pix.pixelformat)&255,\r\n(f->fmt.pix.pixelformat>>8)&255,\r\n(f->fmt.pix.pixelformat>>16)&255,\r\n(f->fmt.pix.pixelformat>>24)&255);\r\n}\r\nstatic int pwc_vidioc_try_fmt(struct pwc_device *pdev, struct v4l2_format *f)\r\n{\r\nint size;\r\nif (f->type != V4L2_BUF_TYPE_VIDEO_CAPTURE) {\r\nPWC_DEBUG_IOCTL("Bad video type must be V4L2_BUF_TYPE_VIDEO_CAPTURE\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (f->fmt.pix.pixelformat) {\r\ncase V4L2_PIX_FMT_YUV420:\r\nbreak;\r\ncase V4L2_PIX_FMT_PWC1:\r\nif (DEVICE_USE_CODEC23(pdev->type)) {\r\nPWC_DEBUG_IOCTL("codec1 is only supported for old pwc webcam\n");\r\nf->fmt.pix.pixelformat = V4L2_PIX_FMT_YUV420;\r\n}\r\nbreak;\r\ncase V4L2_PIX_FMT_PWC2:\r\nif (DEVICE_USE_CODEC1(pdev->type)) {\r\nPWC_DEBUG_IOCTL("codec23 is only supported for new pwc webcam\n");\r\nf->fmt.pix.pixelformat = V4L2_PIX_FMT_YUV420;\r\n}\r\nbreak;\r\ndefault:\r\nPWC_DEBUG_IOCTL("Unsupported pixel format\n");\r\nf->fmt.pix.pixelformat = V4L2_PIX_FMT_YUV420;\r\n}\r\nsize = pwc_get_size(pdev, f->fmt.pix.width, f->fmt.pix.height);\r\npwc_vidioc_fill_fmt(f,\r\npwc_image_sizes[size][0],\r\npwc_image_sizes[size][1],\r\nf->fmt.pix.pixelformat);\r\nreturn 0;\r\n}\r\nstatic int pwc_s_fmt_vid_cap(struct file *file, void *fh, struct v4l2_format *f)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nint ret, pixelformat, compression = 0;\r\nret = pwc_vidioc_try_fmt(pdev, f);\r\nif (ret < 0)\r\nreturn ret;\r\nif (vb2_is_busy(&pdev->vb_queue))\r\nreturn -EBUSY;\r\npixelformat = f->fmt.pix.pixelformat;\r\nPWC_DEBUG_IOCTL("Trying to set format to: width=%d height=%d fps=%d format=%c%c%c%c\n",\r\nf->fmt.pix.width, f->fmt.pix.height, pdev->vframes,\r\n(pixelformat)&255,\r\n(pixelformat>>8)&255,\r\n(pixelformat>>16)&255,\r\n(pixelformat>>24)&255);\r\nret = pwc_set_video_mode(pdev, f->fmt.pix.width, f->fmt.pix.height,\r\npixelformat, 30, &compression, 0);\r\nPWC_DEBUG_IOCTL("pwc_set_video_mode(), return=%d\n", ret);\r\npwc_vidioc_fill_fmt(f, pdev->width, pdev->height, pdev->pixfmt);\r\nreturn ret;\r\n}\r\nstatic int pwc_querycap(struct file *file, void *fh, struct v4l2_capability *cap)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nstrcpy(cap->driver, PWC_NAME);\r\nstrlcpy(cap->card, pdev->vdev.name, sizeof(cap->card));\r\nusb_make_path(pdev->udev, cap->bus_info, sizeof(cap->bus_info));\r\ncap->device_caps = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_STREAMING |\r\nV4L2_CAP_READWRITE;\r\ncap->capabilities = cap->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int pwc_enum_input(struct file *file, void *fh, struct v4l2_input *i)\r\n{\r\nif (i->index)\r\nreturn -EINVAL;\r\nstrlcpy(i->name, "Camera", sizeof(i->name));\r\ni->type = V4L2_INPUT_TYPE_CAMERA;\r\nreturn 0;\r\n}\r\nstatic int pwc_g_input(struct file *file, void *fh, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int pwc_s_input(struct file *file, void *fh, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int pwc_g_volatile_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct pwc_device *pdev =\r\ncontainer_of(ctrl->handler, struct pwc_device, ctrl_handler);\r\nint ret = 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUTO_WHITE_BALANCE:\r\nif (pdev->color_bal_valid &&\r\n(pdev->auto_white_balance->val != awb_auto ||\r\ntime_before(jiffies,\r\npdev->last_color_bal_update + HZ / 4))) {\r\npdev->red_balance->val = pdev->last_red_balance;\r\npdev->blue_balance->val = pdev->last_blue_balance;\r\nbreak;\r\n}\r\nret = pwc_get_u8_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_RED_GAIN_FORMATTER,\r\n&pdev->red_balance->val);\r\nif (ret)\r\nbreak;\r\nret = pwc_get_u8_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_BLUE_GAIN_FORMATTER,\r\n&pdev->blue_balance->val);\r\nif (ret)\r\nbreak;\r\npdev->last_red_balance = pdev->red_balance->val;\r\npdev->last_blue_balance = pdev->blue_balance->val;\r\npdev->last_color_bal_update = jiffies;\r\npdev->color_bal_valid = true;\r\nbreak;\r\ncase V4L2_CID_AUTOGAIN:\r\nif (pdev->gain_valid && time_before(jiffies,\r\npdev->last_gain_update + HZ / 4)) {\r\npdev->gain->val = pdev->last_gain;\r\nbreak;\r\n}\r\nret = pwc_get_u8_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_AGC_FORMATTER, &pdev->gain->val);\r\nif (ret)\r\nbreak;\r\npdev->last_gain = pdev->gain->val;\r\npdev->last_gain_update = jiffies;\r\npdev->gain_valid = true;\r\nif (!DEVICE_USE_CODEC3(pdev->type))\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_AUTO:\r\nif (pdev->exposure_valid && time_before(jiffies,\r\npdev->last_exposure_update + HZ / 4)) {\r\npdev->exposure->val = pdev->last_exposure;\r\nbreak;\r\n}\r\nret = pwc_get_u16_ctrl(pdev, GET_STATUS_CTL,\r\nREAD_SHUTTER_FORMATTER,\r\n&pdev->exposure->val);\r\nif (ret)\r\nbreak;\r\npdev->last_exposure = pdev->exposure->val;\r\npdev->last_exposure_update = jiffies;\r\npdev->exposure_valid = true;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nif (ret)\r\nPWC_ERROR("g_ctrl %s error %d\n", ctrl->name, ret);\r\nreturn ret;\r\n}\r\nstatic int pwc_set_awb(struct pwc_device *pdev)\r\n{\r\nint ret;\r\nif (pdev->auto_white_balance->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nWB_MODE_FORMATTER,\r\npdev->auto_white_balance->val);\r\nif (ret)\r\nreturn ret;\r\nif (pdev->auto_white_balance->val != awb_manual)\r\npdev->color_bal_valid = false;\r\nif (pdev->auto_white_balance->val == awb_indoor ||\r\npdev->auto_white_balance->val == awb_outdoor ||\r\npdev->auto_white_balance->val == awb_fl)\r\npwc_g_volatile_ctrl(pdev->auto_white_balance);\r\n}\r\nif (pdev->auto_white_balance->val != awb_manual)\r\nreturn 0;\r\nif (pdev->red_balance->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nPRESET_MANUAL_RED_GAIN_FORMATTER,\r\npdev->red_balance->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (pdev->blue_balance->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nPRESET_MANUAL_BLUE_GAIN_FORMATTER,\r\npdev->blue_balance->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_set_autogain(struct pwc_device *pdev)\r\n{\r\nint ret;\r\nif (pdev->autogain->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nAGC_MODE_FORMATTER,\r\npdev->autogain->val ? 0 : 0xff);\r\nif (ret)\r\nreturn ret;\r\nif (pdev->autogain->val)\r\npdev->gain_valid = false;\r\n}\r\nif (pdev->autogain->val)\r\nreturn 0;\r\nif (pdev->gain->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nPRESET_AGC_FORMATTER,\r\npdev->gain->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_set_exposure_auto(struct pwc_device *pdev)\r\n{\r\nint ret;\r\nint is_auto = pdev->exposure_auto->val == V4L2_EXPOSURE_AUTO;\r\nif (pdev->exposure_auto->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nSHUTTER_MODE_FORMATTER,\r\nis_auto ? 0 : 0xff);\r\nif (ret)\r\nreturn ret;\r\nif (is_auto)\r\npdev->exposure_valid = false;\r\n}\r\nif (is_auto)\r\nreturn 0;\r\nif (pdev->exposure->is_new) {\r\nret = pwc_set_u16_ctrl(pdev, SET_LUM_CTL,\r\nPRESET_SHUTTER_FORMATTER,\r\npdev->exposure->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_set_autogain_expo(struct pwc_device *pdev)\r\n{\r\nint ret;\r\nif (pdev->autogain->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nAGC_MODE_FORMATTER,\r\npdev->autogain->val ? 0 : 0xff);\r\nif (ret)\r\nreturn ret;\r\nif (pdev->autogain->val) {\r\npdev->gain_valid = false;\r\npdev->exposure_valid = false;\r\n}\r\n}\r\nif (pdev->autogain->val)\r\nreturn 0;\r\nif (pdev->gain->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nPRESET_AGC_FORMATTER,\r\npdev->gain->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (pdev->exposure->is_new) {\r\nret = pwc_set_u16_ctrl(pdev, SET_LUM_CTL,\r\nPRESET_SHUTTER_FORMATTER,\r\npdev->exposure->val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_set_motor(struct pwc_device *pdev)\r\n{\r\nint ret;\r\npdev->ctrl_buf[0] = 0;\r\nif (pdev->motor_pan_reset->is_new)\r\npdev->ctrl_buf[0] |= 0x01;\r\nif (pdev->motor_tilt_reset->is_new)\r\npdev->ctrl_buf[0] |= 0x02;\r\nif (pdev->motor_pan_reset->is_new || pdev->motor_tilt_reset->is_new) {\r\nret = send_control_msg(pdev, SET_MPT_CTL,\r\nPT_RESET_CONTROL_FORMATTER,\r\npdev->ctrl_buf, 1);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nmemset(pdev->ctrl_buf, 0, 4);\r\nif (pdev->motor_pan->is_new) {\r\npdev->ctrl_buf[0] = pdev->motor_pan->val & 0xFF;\r\npdev->ctrl_buf[1] = (pdev->motor_pan->val >> 8);\r\n}\r\nif (pdev->motor_tilt->is_new) {\r\npdev->ctrl_buf[2] = pdev->motor_tilt->val & 0xFF;\r\npdev->ctrl_buf[3] = (pdev->motor_tilt->val >> 8);\r\n}\r\nif (pdev->motor_pan->is_new || pdev->motor_tilt->is_new) {\r\nret = send_control_msg(pdev, SET_MPT_CTL,\r\nPT_RELATIVE_CONTROL_FORMATTER,\r\npdev->ctrl_buf, 4);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct pwc_device *pdev =\r\ncontainer_of(ctrl->handler, struct pwc_device, ctrl_handler);\r\nint ret = 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_BRIGHTNESS:\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nBRIGHTNESS_FORMATTER, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nCONTRAST_FORMATTER, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nret = pwc_set_s8_ctrl(pdev, SET_CHROM_CTL,\r\npdev->saturation_fmt, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_GAMMA:\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nGAMMA_FORMATTER, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUTO_WHITE_BALANCE:\r\nret = pwc_set_awb(pdev);\r\nbreak;\r\ncase V4L2_CID_AUTOGAIN:\r\nif (DEVICE_USE_CODEC2(pdev->type))\r\nret = pwc_set_autogain(pdev);\r\nelse if (DEVICE_USE_CODEC3(pdev->type))\r\nret = pwc_set_autogain_expo(pdev);\r\nelse\r\nret = -EINVAL;\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_AUTO:\r\nif (DEVICE_USE_CODEC2(pdev->type))\r\nret = pwc_set_exposure_auto(pdev);\r\nelse\r\nret = -EINVAL;\r\nbreak;\r\ncase V4L2_CID_COLORFX:\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nCOLOUR_MODE_FORMATTER,\r\nctrl->val ? 0 : 0xff);\r\nbreak;\r\ncase PWC_CID_CUSTOM(autocontour):\r\nif (pdev->autocontour->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nAUTO_CONTOUR_FORMATTER,\r\npdev->autocontour->val ? 0 : 0xff);\r\n}\r\nif (ret == 0 && pdev->contour->is_new) {\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nPRESET_CONTOUR_FORMATTER,\r\npdev->contour->val);\r\n}\r\nbreak;\r\ncase V4L2_CID_BACKLIGHT_COMPENSATION:\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nBACK_LIGHT_COMPENSATION_FORMATTER,\r\nctrl->val ? 0 : 0xff);\r\nbreak;\r\ncase V4L2_CID_BAND_STOP_FILTER:\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nFLICKERLESS_MODE_FORMATTER,\r\nctrl->val ? 0 : 0xff);\r\nbreak;\r\ncase PWC_CID_CUSTOM(noise_reduction):\r\nret = pwc_set_u8_ctrl(pdev, SET_LUM_CTL,\r\nDYNAMIC_NOISE_CONTROL_FORMATTER,\r\nctrl->val);\r\nbreak;\r\ncase PWC_CID_CUSTOM(save_user):\r\nret = pwc_button_ctrl(pdev, SAVE_USER_DEFAULTS_FORMATTER);\r\nbreak;\r\ncase PWC_CID_CUSTOM(restore_user):\r\nret = pwc_button_ctrl(pdev, RESTORE_USER_DEFAULTS_FORMATTER);\r\nbreak;\r\ncase PWC_CID_CUSTOM(restore_factory):\r\nret = pwc_button_ctrl(pdev,\r\nRESTORE_FACTORY_DEFAULTS_FORMATTER);\r\nbreak;\r\ncase PWC_CID_CUSTOM(awb_speed):\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nAWB_CONTROL_SPEED_FORMATTER,\r\nctrl->val);\r\nbreak;\r\ncase PWC_CID_CUSTOM(awb_delay):\r\nret = pwc_set_u8_ctrl(pdev, SET_CHROM_CTL,\r\nAWB_CONTROL_DELAY_FORMATTER,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_PAN_RELATIVE:\r\nret = pwc_set_motor(pdev);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nif (ret)\r\nPWC_ERROR("s_ctrl %s error %d\n", ctrl->name, ret);\r\nreturn ret;\r\n}\r\nstatic int pwc_enum_fmt_vid_cap(struct file *file, void *fh, struct v4l2_fmtdesc *f)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nswitch (f->index) {\r\ncase 0:\r\nf->pixelformat = pdev->type <= 646 ? V4L2_PIX_FMT_PWC1 : V4L2_PIX_FMT_PWC2;\r\nf->flags = V4L2_FMT_FLAG_COMPRESSED;\r\nstrlcpy(f->description, "Raw Philips Webcam", sizeof(f->description));\r\nbreak;\r\ncase 1:\r\nf->pixelformat = V4L2_PIX_FMT_YUV420;\r\nstrlcpy(f->description, "4:2:0, planar, Y-Cb-Cr", sizeof(f->description));\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwc_g_fmt_vid_cap(struct file *file, void *fh, struct v4l2_format *f)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nif (f->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)\r\nreturn -EINVAL;\r\nPWC_DEBUG_IOCTL("ioctl(VIDIOC_G_FMT) return size %dx%d\n",\r\npdev->width, pdev->height);\r\npwc_vidioc_fill_fmt(f, pdev->width, pdev->height, pdev->pixfmt);\r\nreturn 0;\r\n}\r\nstatic int pwc_try_fmt_vid_cap(struct file *file, void *fh, struct v4l2_format *f)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nreturn pwc_vidioc_try_fmt(pdev, f);\r\n}\r\nstatic int pwc_enum_framesizes(struct file *file, void *fh,\r\nstruct v4l2_frmsizeenum *fsize)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nunsigned int i = 0, index = fsize->index;\r\nif (fsize->pixel_format == V4L2_PIX_FMT_YUV420 ||\r\n(fsize->pixel_format == V4L2_PIX_FMT_PWC1 &&\r\nDEVICE_USE_CODEC1(pdev->type)) ||\r\n(fsize->pixel_format == V4L2_PIX_FMT_PWC2 &&\r\nDEVICE_USE_CODEC23(pdev->type))) {\r\nfor (i = 0; i < PSZ_MAX; i++) {\r\nif (!(pdev->image_mask & (1UL << i)))\r\ncontinue;\r\nif (!index--) {\r\nfsize->type = V4L2_FRMSIZE_TYPE_DISCRETE;\r\nfsize->discrete.width = pwc_image_sizes[i][0];\r\nfsize->discrete.height = pwc_image_sizes[i][1];\r\nreturn 0;\r\n}\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int pwc_enum_frameintervals(struct file *file, void *fh,\r\nstruct v4l2_frmivalenum *fival)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nint size = -1;\r\nunsigned int i;\r\nfor (i = 0; i < PSZ_MAX; i++) {\r\nif (pwc_image_sizes[i][0] == fival->width &&\r\npwc_image_sizes[i][1] == fival->height) {\r\nsize = i;\r\nbreak;\r\n}\r\n}\r\nif (size < 0 || fival->pixel_format != V4L2_PIX_FMT_YUV420)\r\nreturn -EINVAL;\r\ni = pwc_get_fps(pdev, fival->index, size);\r\nif (!i)\r\nreturn -EINVAL;\r\nfival->type = V4L2_FRMIVAL_TYPE_DISCRETE;\r\nfival->discrete.numerator = 1;\r\nfival->discrete.denominator = i;\r\nreturn 0;\r\n}\r\nstatic int pwc_g_parm(struct file *file, void *fh,\r\nstruct v4l2_streamparm *parm)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nif (parm->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)\r\nreturn -EINVAL;\r\nmemset(parm, 0, sizeof(*parm));\r\nparm->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nparm->parm.capture.readbuffers = MIN_FRAMES;\r\nparm->parm.capture.capability |= V4L2_CAP_TIMEPERFRAME;\r\nparm->parm.capture.timeperframe.denominator = pdev->vframes;\r\nparm->parm.capture.timeperframe.numerator = 1;\r\nreturn 0;\r\n}\r\nstatic int pwc_s_parm(struct file *file, void *fh,\r\nstruct v4l2_streamparm *parm)\r\n{\r\nstruct pwc_device *pdev = video_drvdata(file);\r\nint compression = 0;\r\nint ret, fps;\r\nif (parm->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)\r\nreturn -EINVAL;\r\nif (parm->parm.capture.timeperframe.numerator == 0 ||\r\nparm->parm.capture.timeperframe.denominator == 0)\r\nfps = 30;\r\nelse\r\nfps = parm->parm.capture.timeperframe.denominator /\r\nparm->parm.capture.timeperframe.numerator;\r\nif (vb2_is_busy(&pdev->vb_queue))\r\nreturn -EBUSY;\r\nret = pwc_set_video_mode(pdev, pdev->width, pdev->height, pdev->pixfmt,\r\nfps, &compression, 0);\r\npwc_g_parm(file, fh, parm);\r\nreturn ret;\r\n}

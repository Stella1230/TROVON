void hwt_start(struct s_smc *smc, u_long time)\r\n{\r\nu_short cnt ;\r\nif (time > HWT_MAX)\r\ntime = HWT_MAX ;\r\nsmc->hw.t_start = time ;\r\nsmc->hw.t_stop = 0L ;\r\ncnt = (u_short)time ;\r\nif (!cnt)\r\ncnt++ ;\r\noutpd(ADDR(B2_TI_INI), (u_long) cnt * 200) ;\r\noutpw(ADDR(B2_TI_CRTL), TIM_START) ;\r\nsmc->hw.timer_activ = TRUE ;\r\n}\r\nvoid hwt_stop(struct s_smc *smc)\r\n{\r\noutpw(ADDR(B2_TI_CRTL), TIM_STOP) ;\r\noutpw(ADDR(B2_TI_CRTL), TIM_CL_IRQ) ;\r\nsmc->hw.timer_activ = FALSE ;\r\n}\r\nvoid hwt_init(struct s_smc *smc)\r\n{\r\nsmc->hw.t_start = 0 ;\r\nsmc->hw.t_stop = 0 ;\r\nsmc->hw.timer_activ = FALSE ;\r\nhwt_restart(smc) ;\r\n}\r\nvoid hwt_restart(struct s_smc *smc)\r\n{\r\nhwt_stop(smc) ;\r\n}\r\nu_long hwt_read(struct s_smc *smc)\r\n{\r\nu_short tr ;\r\nu_long is ;\r\nif (smc->hw.timer_activ) {\r\nhwt_stop(smc) ;\r\ntr = (u_short)((inpd(ADDR(B2_TI_VAL))/200) & 0xffff) ;\r\nis = GET_ISR() ;\r\nif ((tr > smc->hw.t_start) || (is & IS_TIMINT)) {\r\nhwt_restart(smc) ;\r\nsmc->hw.t_stop = smc->hw.t_start ;\r\n}\r\nelse\r\nsmc->hw.t_stop = smc->hw.t_start - tr ;\r\n}\r\nreturn smc->hw.t_stop;\r\n}\r\nu_long hwt_quick_read(struct s_smc *smc)\r\n{\r\nu_long interval ;\r\nu_long time ;\r\ninterval = inpd(ADDR(B2_TI_INI)) ;\r\noutpw(ADDR(B2_TI_CRTL), TIM_STOP) ;\r\ntime = inpd(ADDR(B2_TI_VAL)) ;\r\noutpd(ADDR(B2_TI_INI),time) ;\r\noutpw(ADDR(B2_TI_CRTL), TIM_START) ;\r\noutpd(ADDR(B2_TI_INI),interval) ;\r\nreturn time;\r\n}\r\nvoid hwt_wait_time(struct s_smc *smc, u_long start, long int duration)\r\n{\r\nlong diff ;\r\nlong interval ;\r\nint wrapped ;\r\nif (smc->hw.timer_activ == FALSE ||\r\nhwt_quick_read(smc) == hwt_quick_read(smc)) {\r\nreturn ;\r\n}\r\ninterval = inpd(ADDR(B2_TI_INI)) ;\r\nif (interval > duration) {\r\ndo {\r\ndiff = (long)(start - hwt_quick_read(smc)) ;\r\nif (diff < 0) {\r\ndiff += interval ;\r\n}\r\n} while (diff <= duration) ;\r\n}\r\nelse {\r\ndiff = interval ;\r\nwrapped = 0 ;\r\ndo {\r\nif (!wrapped) {\r\nif (hwt_quick_read(smc) >= start) {\r\ndiff += interval ;\r\nwrapped = 1 ;\r\n}\r\n}\r\nelse {\r\nif (hwt_quick_read(smc) < start) {\r\nwrapped = 0 ;\r\n}\r\n}\r\n} while (diff <= duration) ;\r\n}\r\n}

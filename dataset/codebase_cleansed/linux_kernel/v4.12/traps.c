void __init trap_init(void)\r\n{\r\nCSYNC();\r\nbfin_write_EVT3(trap);\r\nCSYNC();\r\n}\r\nstatic int kernel_mode_regs(struct pt_regs *regs)\r\n{\r\nreturn regs->ipend & 0xffc0;\r\n}\r\nasmlinkage notrace void trap_c(struct pt_regs *fp)\r\n{\r\n#ifdef CONFIG_DEBUG_BFIN_HWTRACE_ON\r\nint j;\r\n#endif\r\n#ifdef CONFIG_BFIN_PSEUDODBG_INSNS\r\nint opcode;\r\n#endif\r\nunsigned int cpu = raw_smp_processor_id();\r\nconst char *strerror = NULL;\r\nint sig = 0;\r\nsiginfo_t info;\r\nunsigned long trapnr = fp->seqstat & SEQSTAT_EXCAUSE;\r\ntrace_buffer_save(j);\r\n#if defined(CONFIG_DEBUG_MMRS) || defined(CONFIG_DEBUG_MMRS_MODULE)\r\nlast_seqstat = (u32)fp->seqstat;\r\n#endif\r\nfp->orig_pc = fp->retx;\r\nswitch (trapnr) {\r\ncase VEC_EXCPT01:\r\ninfo.si_code = TRAP_ILLTRAP;\r\nsig = SIGTRAP;\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nif (kernel_mode_regs(fp))\r\ngoto traps_done;\r\nelse\r\nbreak;\r\ncase VEC_EXCPT03:\r\ninfo.si_code = SEGV_STACKFLOW;\r\nsig = SIGSEGV;\r\nstrerror = KERN_NOTICE EXC_0x03(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_EXCPT02:\r\n#ifdef CONFIG_KGDB\r\ninfo.si_code = TRAP_ILLTRAP;\r\nsig = SIGTRAP;\r\nCHK_DEBUGGER_TRAP();\r\ngoto traps_done;\r\n#endif\r\ncase VEC_EXCPT04 ... VEC_EXCPT15:\r\ninfo.si_code = ILL_ILLPARAOP;\r\nsig = SIGILL;\r\nstrerror = KERN_NOTICE EXC_0x04(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_STEP:\r\ninfo.si_code = TRAP_STEP;\r\nsig = SIGTRAP;\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nif (kernel_mode_regs(fp))\r\ngoto traps_done;\r\nelse\r\nbreak;\r\ncase VEC_OVFLOW:\r\ninfo.si_code = TRAP_TRACEFLOW;\r\nsig = SIGTRAP;\r\nstrerror = KERN_NOTICE EXC_0x11(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_UNDEF_I:\r\n#ifdef CONFIG_BUG\r\nif (kernel_mode_regs(fp)) {\r\nswitch (report_bug(fp->pc, fp)) {\r\ncase BUG_TRAP_TYPE_NONE:\r\nbreak;\r\ncase BUG_TRAP_TYPE_WARN:\r\ndump_bfin_trace_buffer();\r\nfp->pc += 2;\r\ngoto traps_done;\r\ncase BUG_TRAP_TYPE_BUG:\r\npanic("BUG()");\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_BFIN_PSEUDODBG_INSNS\r\nif (!kernel_mode_regs(fp) && get_instruction(&opcode, (unsigned short *)fp->pc)) {\r\nif (execute_pseudodbg_assert(fp, opcode))\r\ngoto traps_done;\r\nif (execute_pseudodbg(fp, opcode))\r\ngoto traps_done;\r\n}\r\n#endif\r\ninfo.si_code = ILL_ILLOPC;\r\nsig = SIGILL;\r\nstrerror = KERN_NOTICE EXC_0x21(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_ILGAL_I:\r\ninfo.si_code = ILL_ILLPARAOP;\r\nsig = SIGILL;\r\nstrerror = KERN_NOTICE EXC_0x22(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_CPLB_VL:\r\ninfo.si_code = ILL_CPLB_VI;\r\nsig = SIGSEGV;\r\nstrerror = KERN_NOTICE EXC_0x23(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_MISALI_D:\r\ninfo.si_code = BUS_ADRALN;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE EXC_0x24(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_UNCOV:\r\ninfo.si_code = ILL_ILLEXCPT;\r\nsig = SIGILL;\r\nstrerror = KERN_NOTICE EXC_0x25(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_CPLB_M:\r\ninfo.si_code = BUS_ADRALN;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE EXC_0x26(KERN_NOTICE);\r\nbreak;\r\ncase VEC_CPLB_MHIT:\r\ninfo.si_code = ILL_CPLB_MULHIT;\r\nsig = SIGSEGV;\r\n#ifdef CONFIG_DEBUG_HUNT_FOR_ZERO\r\nif (cpu_pda[cpu].dcplb_fault_addr < FIXED_CODE_START)\r\nstrerror = KERN_NOTICE "NULL pointer access\n";\r\nelse\r\n#endif\r\nstrerror = KERN_NOTICE EXC_0x27(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_WATCH:\r\ninfo.si_code = TRAP_WATCHPT;\r\nsig = SIGTRAP;\r\npr_debug(EXC_0x28(KERN_DEBUG));\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nif (kernel_mode_regs(fp))\r\ngoto traps_done;\r\nelse\r\nbreak;\r\n#ifdef CONFIG_BF535\r\ncase VEC_ISTRU_VL:\r\ninfo.si_code = BUS_OPFETCH;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE "BF535: VEC_ISTRU_VL\n";\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\n#else\r\n#endif\r\ncase VEC_MISALI_I:\r\ninfo.si_code = BUS_ADRALN;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE EXC_0x2A(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_CPLB_I_VL:\r\ninfo.si_code = ILL_CPLB_VI;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE EXC_0x2B(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_CPLB_I_M:\r\ninfo.si_code = ILL_CPLB_MISS;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE EXC_0x2C(KERN_NOTICE);\r\nbreak;\r\ncase VEC_CPLB_I_MHIT:\r\ninfo.si_code = ILL_CPLB_MULHIT;\r\nsig = SIGSEGV;\r\n#ifdef CONFIG_DEBUG_HUNT_FOR_ZERO\r\nif (cpu_pda[cpu].icplb_fault_addr < FIXED_CODE_START)\r\nstrerror = KERN_NOTICE "Jump to NULL address\n";\r\nelse\r\n#endif\r\nstrerror = KERN_NOTICE EXC_0x2D(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_ILL_RES:\r\ninfo.si_code = ILL_PRVOPC;\r\nsig = SIGILL;\r\nstrerror = KERN_NOTICE EXC_0x2E(KERN_NOTICE);\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ncase VEC_HWERR:\r\ninfo.si_code = BUS_ADRALN;\r\nsig = SIGBUS;\r\nswitch (fp->seqstat & SEQSTAT_HWERRCAUSE) {\r\ncase (SEQSTAT_HWERRCAUSE_SYSTEM_MMR):\r\ninfo.si_code = BUS_ADRALN;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE HWC_x2(KERN_NOTICE);\r\nbreak;\r\ncase (SEQSTAT_HWERRCAUSE_EXTERN_ADDR):\r\nif (ANOMALY_05000310) {\r\nstatic unsigned long anomaly_rets;\r\nif ((fp->pc >= (L1_CODE_START + L1_CODE_LENGTH - 512)) &&\r\n(fp->pc < (L1_CODE_START + L1_CODE_LENGTH))) {\r\nanomaly_rets = fp->rets;\r\ngoto traps_done;\r\n} else if (fp->rets == anomaly_rets) {\r\ngoto traps_done;\r\n} else if ((fp->rets >= (L1_CODE_START + L1_CODE_LENGTH - 512)) &&\r\n(fp->rets < (L1_CODE_START + L1_CODE_LENGTH))) {\r\ngoto traps_done;\r\n} else\r\nanomaly_rets = 0;\r\n}\r\ninfo.si_code = BUS_ADRERR;\r\nsig = SIGBUS;\r\nstrerror = KERN_NOTICE HWC_x3(KERN_NOTICE);\r\nbreak;\r\ncase (SEQSTAT_HWERRCAUSE_PERF_FLOW):\r\nstrerror = KERN_NOTICE HWC_x12(KERN_NOTICE);\r\nbreak;\r\ncase (SEQSTAT_HWERRCAUSE_RAISE_5):\r\nprintk(KERN_NOTICE HWC_x18(KERN_NOTICE));\r\nbreak;\r\ndefault:\r\nprintk(KERN_NOTICE HWC_default(KERN_NOTICE));\r\nbreak;\r\n}\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\ndefault:\r\ninfo.si_code = ILL_ILLPARAOP;\r\nsig = SIGILL;\r\nverbose_printk(KERN_EMERG "Caught Unhandled Exception, code = %08lx\n",\r\n(fp->seqstat & SEQSTAT_EXCAUSE));\r\nCHK_DEBUGGER_TRAP_MAYBE();\r\nbreak;\r\n}\r\nBUG_ON(sig == 0);\r\nif (kernel_mode_regs(fp) || (current && !current->mm)) {\r\nconsole_verbose();\r\noops_in_progress = 1;\r\n}\r\nif (sig != SIGTRAP) {\r\nif (strerror)\r\nverbose_printk(strerror);\r\ndump_bfin_process(fp);\r\ndump_bfin_mem(fp);\r\nshow_regs(fp);\r\n#ifndef CONFIG_DEBUG_BFIN_NO_KERN_HWTRACE\r\nif (trapnr == VEC_CPLB_I_M || trapnr == VEC_CPLB_M)\r\nverbose_printk(KERN_NOTICE "No trace since you do not have "\r\n"CONFIG_DEBUG_BFIN_NO_KERN_HWTRACE enabled\n\n");\r\nelse\r\n#endif\r\ndump_bfin_trace_buffer();\r\nif (oops_in_progress) {\r\nverbose_printk(KERN_NOTICE "Kernel Stack\n");\r\nshow_stack(current, NULL);\r\nprint_modules();\r\n#ifndef CONFIG_ACCESS_CHECK\r\nverbose_printk(KERN_EMERG "Please turn on "\r\n"CONFIG_ACCESS_CHECK\n");\r\n#endif\r\npanic("Kernel exception");\r\n} else {\r\n#ifdef CONFIG_DEBUG_VERBOSE\r\nunsigned long *stack;\r\nstack = (unsigned long *)rdusp();\r\nverbose_printk(KERN_NOTICE "Userspace Stack\n");\r\nshow_stack(NULL, stack);\r\n#endif\r\n}\r\n}\r\n#ifdef CONFIG_IPIPE\r\nif (!ipipe_trap_notify(fp->seqstat & 0x3f, fp))\r\n#endif\r\n{\r\ninfo.si_signo = sig;\r\ninfo.si_errno = 0;\r\nswitch (trapnr) {\r\ncase VEC_CPLB_VL:\r\ncase VEC_MISALI_D:\r\ncase VEC_CPLB_M:\r\ncase VEC_CPLB_MHIT:\r\ninfo.si_addr = (void __user *)cpu_pda[cpu].dcplb_fault_addr;\r\nbreak;\r\ndefault:\r\ninfo.si_addr = (void __user *)fp->pc;\r\nbreak;\r\n}\r\nforce_sig_info(sig, &info, current);\r\n}\r\nif ((ANOMALY_05000461 && trapnr == VEC_HWERR && !access_ok(VERIFY_READ, fp->pc, 8)) ||\r\n(ANOMALY_05000281 && trapnr == VEC_HWERR) ||\r\n(ANOMALY_05000189 && (trapnr == VEC_CPLB_I_VL || trapnr == VEC_CPLB_VL)))\r\nfp->pc = SAFE_USER_INSTRUCTION;\r\ntraps_done:\r\ntrace_buffer_restore(j);\r\n}\r\nasmlinkage void double_fault_c(struct pt_regs *fp)\r\n{\r\n#ifdef CONFIG_DEBUG_BFIN_HWTRACE_ON\r\nint j;\r\ntrace_buffer_save(j);\r\n#endif\r\nconsole_verbose();\r\noops_in_progress = 1;\r\n#ifdef CONFIG_DEBUG_VERBOSE\r\nprintk(KERN_EMERG "Double Fault\n");\r\n#ifdef CONFIG_DEBUG_DOUBLEFAULT_PRINT\r\nif (((long)fp->seqstat & SEQSTAT_EXCAUSE) == VEC_UNCOV) {\r\nunsigned int cpu = raw_smp_processor_id();\r\nchar buf[150];\r\ndecode_address(buf, cpu_pda[cpu].retx_doublefault);\r\nprintk(KERN_EMERG "While handling exception (EXCAUSE = 0x%x) at %s:\n",\r\n(unsigned int)cpu_pda[cpu].seqstat_doublefault & SEQSTAT_EXCAUSE, buf);\r\ndecode_address(buf, cpu_pda[cpu].dcplb_doublefault_addr);\r\nprintk(KERN_NOTICE " DCPLB_FAULT_ADDR: %s\n", buf);\r\ndecode_address(buf, cpu_pda[cpu].icplb_doublefault_addr);\r\nprintk(KERN_NOTICE " ICPLB_FAULT_ADDR: %s\n", buf);\r\ndecode_address(buf, fp->retx);\r\nprintk(KERN_NOTICE "The instruction at %s caused a double exception\n", buf);\r\n} else\r\n#endif\r\n{\r\ndump_bfin_process(fp);\r\ndump_bfin_mem(fp);\r\nshow_regs(fp);\r\ndump_bfin_trace_buffer();\r\n}\r\n#endif\r\npanic("Double Fault - unrecoverable event");\r\n}\r\nvoid panic_cplb_error(int cplb_panic, struct pt_regs *fp)\r\n{\r\nswitch (cplb_panic) {\r\ncase CPLB_NO_UNLOCKED:\r\nprintk(KERN_EMERG "All CPLBs are locked\n");\r\nbreak;\r\ncase CPLB_PROT_VIOL:\r\nreturn;\r\ncase CPLB_NO_ADDR_MATCH:\r\nreturn;\r\ncase CPLB_UNKNOWN_ERR:\r\nprintk(KERN_EMERG "Unknown CPLB Exception\n");\r\nbreak;\r\n}\r\noops_in_progress = 1;\r\ndump_bfin_process(fp);\r\ndump_bfin_mem(fp);\r\nshow_regs(fp);\r\ndump_stack();\r\npanic("Unrecoverable event");\r\n}\r\nint is_valid_bugaddr(unsigned long addr)\r\n{\r\nunsigned int opcode;\r\nif (!get_instruction(&opcode, (unsigned short *)addr))\r\nreturn 0;\r\nreturn opcode == BFIN_BUG_OPCODE;\r\n}\r\nvoid show_regs(struct pt_regs *fp)\r\n{\r\n}

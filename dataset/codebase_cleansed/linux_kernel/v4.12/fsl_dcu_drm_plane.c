static int fsl_dcu_drm_plane_index(struct drm_plane *plane)\r\n{\r\nstruct fsl_dcu_drm_device *fsl_dev = plane->dev->dev_private;\r\nunsigned int total_layer = fsl_dev->soc->total_layer;\r\nunsigned int index;\r\nindex = drm_plane_index(plane);\r\nif (index < total_layer)\r\nreturn total_layer - index - 1;\r\ndev_err(fsl_dev->dev, "No more layer left\n");\r\nreturn -EINVAL;\r\n}\r\nstatic int fsl_dcu_drm_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct drm_framebuffer *fb = state->fb;\r\nif (!state->fb || !state->crtc)\r\nreturn 0;\r\nswitch (fb->format->format) {\r\ncase DRM_FORMAT_RGB565:\r\ncase DRM_FORMAT_RGB888:\r\ncase DRM_FORMAT_XRGB8888:\r\ncase DRM_FORMAT_ARGB8888:\r\ncase DRM_FORMAT_XRGB4444:\r\ncase DRM_FORMAT_ARGB4444:\r\ncase DRM_FORMAT_XRGB1555:\r\ncase DRM_FORMAT_ARGB1555:\r\ncase DRM_FORMAT_YUV422:\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic void fsl_dcu_drm_plane_atomic_disable(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct fsl_dcu_drm_device *fsl_dev = plane->dev->dev_private;\r\nunsigned int value;\r\nint index;\r\nindex = fsl_dcu_drm_plane_index(plane);\r\nif (index < 0)\r\nreturn;\r\nregmap_read(fsl_dev->regmap, DCU_CTRLDESCLN(index, 4), &value);\r\nvalue &= ~DCU_LAYER_EN;\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 4), value);\r\n}\r\nstatic void fsl_dcu_drm_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct fsl_dcu_drm_device *fsl_dev = plane->dev->dev_private;\r\nstruct drm_plane_state *state = plane->state;\r\nstruct drm_framebuffer *fb = plane->state->fb;\r\nstruct drm_gem_cma_object *gem;\r\nunsigned int alpha = DCU_LAYER_AB_NONE, bpp;\r\nint index;\r\nif (!fb)\r\nreturn;\r\nindex = fsl_dcu_drm_plane_index(plane);\r\nif (index < 0)\r\nreturn;\r\ngem = drm_fb_cma_get_gem_obj(fb, 0);\r\nswitch (fb->format->format) {\r\ncase DRM_FORMAT_RGB565:\r\nbpp = FSL_DCU_RGB565;\r\nbreak;\r\ncase DRM_FORMAT_RGB888:\r\nbpp = FSL_DCU_RGB888;\r\nbreak;\r\ncase DRM_FORMAT_ARGB8888:\r\nalpha = DCU_LAYER_AB_WHOLE_FRAME;\r\ncase DRM_FORMAT_XRGB8888:\r\nbpp = FSL_DCU_ARGB8888;\r\nbreak;\r\ncase DRM_FORMAT_ARGB4444:\r\nalpha = DCU_LAYER_AB_WHOLE_FRAME;\r\ncase DRM_FORMAT_XRGB4444:\r\nbpp = FSL_DCU_ARGB4444;\r\nbreak;\r\ncase DRM_FORMAT_ARGB1555:\r\nalpha = DCU_LAYER_AB_WHOLE_FRAME;\r\ncase DRM_FORMAT_XRGB1555:\r\nbpp = FSL_DCU_ARGB1555;\r\nbreak;\r\ncase DRM_FORMAT_YUV422:\r\nbpp = FSL_DCU_YUV422;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 1),\r\nDCU_LAYER_HEIGHT(state->crtc_h) |\r\nDCU_LAYER_WIDTH(state->crtc_w));\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 2),\r\nDCU_LAYER_POSY(state->crtc_y) |\r\nDCU_LAYER_POSX(state->crtc_x));\r\nregmap_write(fsl_dev->regmap,\r\nDCU_CTRLDESCLN(index, 3), gem->paddr);\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 4),\r\nDCU_LAYER_EN |\r\nDCU_LAYER_TRANS(0xff) |\r\nDCU_LAYER_BPP(bpp) |\r\nalpha);\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 5),\r\nDCU_LAYER_CKMAX_R(0xFF) |\r\nDCU_LAYER_CKMAX_G(0xFF) |\r\nDCU_LAYER_CKMAX_B(0xFF));\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 6),\r\nDCU_LAYER_CKMIN_R(0) |\r\nDCU_LAYER_CKMIN_G(0) |\r\nDCU_LAYER_CKMIN_B(0));\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 7), 0);\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 8),\r\nDCU_LAYER_FG_FCOLOR(0));\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 9),\r\nDCU_LAYER_BG_BCOLOR(0));\r\nif (!strcmp(fsl_dev->soc->name, "ls1021a")) {\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(index, 10),\r\nDCU_LAYER_POST_SKIP(0) |\r\nDCU_LAYER_PRE_SKIP(0));\r\n}\r\nreturn;\r\n}\r\nstatic void fsl_dcu_drm_plane_destroy(struct drm_plane *plane)\r\n{\r\ndrm_plane_cleanup(plane);\r\nkfree(plane);\r\n}\r\nvoid fsl_dcu_drm_init_planes(struct drm_device *dev)\r\n{\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nint i, j;\r\nfor (i = 0; i < fsl_dev->soc->total_layer; i++) {\r\nfor (j = 1; j <= fsl_dev->soc->layer_regs; j++)\r\nregmap_write(fsl_dev->regmap, DCU_CTRLDESCLN(i, j), 0);\r\n}\r\n}\r\nstruct drm_plane *fsl_dcu_drm_primary_create_plane(struct drm_device *dev)\r\n{\r\nstruct drm_plane *primary;\r\nint ret;\r\nprimary = kzalloc(sizeof(*primary), GFP_KERNEL);\r\nif (!primary) {\r\nDRM_DEBUG_KMS("Failed to allocate primary plane\n");\r\nreturn NULL;\r\n}\r\nret = drm_universal_plane_init(dev, primary, 0,\r\n&fsl_dcu_drm_plane_funcs,\r\nfsl_dcu_drm_plane_formats,\r\nARRAY_SIZE(fsl_dcu_drm_plane_formats),\r\nDRM_PLANE_TYPE_PRIMARY, NULL);\r\nif (ret) {\r\nkfree(primary);\r\nprimary = NULL;\r\n}\r\ndrm_plane_helper_add(primary, &fsl_dcu_drm_plane_helper_funcs);\r\nreturn primary;\r\n}

int saa7164_bus_setup(struct saa7164_dev *dev)\r\n{\r\nstruct tmComResBusInfo *b = &dev->bus;\r\nmutex_init(&b->lock);\r\nb->Type = TYPE_BUS_PCIe;\r\nb->m_wMaxReqSize = SAA_DEVICE_MAXREQUESTSIZE;\r\nb->m_pdwSetRing = (u8 __iomem *)(dev->bmmio +\r\n((u32)dev->busdesc.CommandRing));\r\nb->m_dwSizeSetRing = SAA_DEVICE_BUFFERBLOCKSIZE;\r\nb->m_pdwGetRing = (u8 __iomem *)(dev->bmmio +\r\n((u32)dev->busdesc.ResponseRing));\r\nb->m_dwSizeGetRing = SAA_DEVICE_BUFFERBLOCKSIZE;\r\nb->m_dwSetWritePos = ((u32)dev->intfdesc.BARLocation) +\r\n(2 * sizeof(u64));\r\nb->m_dwSetReadPos = b->m_dwSetWritePos + (1 * sizeof(u32));\r\nb->m_dwGetWritePos = b->m_dwSetWritePos + (2 * sizeof(u32));\r\nb->m_dwGetReadPos = b->m_dwSetWritePos + (3 * sizeof(u32));\r\nreturn 0;\r\n}\r\nvoid saa7164_bus_dump(struct saa7164_dev *dev)\r\n{\r\nstruct tmComResBusInfo *b = &dev->bus;\r\ndprintk(DBGLVL_BUS, "Dumping the bus structure:\n");\r\ndprintk(DBGLVL_BUS, " .type = %d\n", b->Type);\r\ndprintk(DBGLVL_BUS, " .dev->bmmio = 0x%p\n", dev->bmmio);\r\ndprintk(DBGLVL_BUS, " .m_wMaxReqSize = 0x%x\n", b->m_wMaxReqSize);\r\ndprintk(DBGLVL_BUS, " .m_pdwSetRing = 0x%p\n", b->m_pdwSetRing);\r\ndprintk(DBGLVL_BUS, " .m_dwSizeSetRing = 0x%x\n", b->m_dwSizeSetRing);\r\ndprintk(DBGLVL_BUS, " .m_pdwGetRing = 0x%p\n", b->m_pdwGetRing);\r\ndprintk(DBGLVL_BUS, " .m_dwSizeGetRing = 0x%x\n", b->m_dwSizeGetRing);\r\ndprintk(DBGLVL_BUS, " .m_dwSetReadPos = 0x%x (0x%08x)\n",\r\nb->m_dwSetReadPos, saa7164_readl(b->m_dwSetReadPos));\r\ndprintk(DBGLVL_BUS, " .m_dwSetWritePos = 0x%x (0x%08x)\n",\r\nb->m_dwSetWritePos, saa7164_readl(b->m_dwSetWritePos));\r\ndprintk(DBGLVL_BUS, " .m_dwGetReadPos = 0x%x (0x%08x)\n",\r\nb->m_dwGetReadPos, saa7164_readl(b->m_dwGetReadPos));\r\ndprintk(DBGLVL_BUS, " .m_dwGetWritePos = 0x%x (0x%08x)\n",\r\nb->m_dwGetWritePos, saa7164_readl(b->m_dwGetWritePos));\r\n}\r\nstatic void saa7164_bus_verify(struct saa7164_dev *dev)\r\n{\r\nstruct tmComResBusInfo *b = &dev->bus;\r\nint bug = 0;\r\nif (saa7164_readl(b->m_dwSetReadPos) > b->m_dwSizeSetRing)\r\nbug++;\r\nif (saa7164_readl(b->m_dwSetWritePos) > b->m_dwSizeSetRing)\r\nbug++;\r\nif (saa7164_readl(b->m_dwGetReadPos) > b->m_dwSizeGetRing)\r\nbug++;\r\nif (saa7164_readl(b->m_dwGetWritePos) > b->m_dwSizeGetRing)\r\nbug++;\r\nif (bug) {\r\nsaa_debug = 0xffff;\r\nsaa7164_bus_dump(dev);\r\nsaa_debug = 1024;\r\nBUG();\r\n}\r\n}\r\nstatic void saa7164_bus_dumpmsg(struct saa7164_dev *dev, struct tmComResInfo *m,\r\nvoid *buf)\r\n{\r\ndprintk(DBGLVL_BUS, "Dumping msg structure:\n");\r\ndprintk(DBGLVL_BUS, " .id = %d\n", m->id);\r\ndprintk(DBGLVL_BUS, " .flags = 0x%x\n", m->flags);\r\ndprintk(DBGLVL_BUS, " .size = 0x%x\n", m->size);\r\ndprintk(DBGLVL_BUS, " .command = 0x%x\n", m->command);\r\ndprintk(DBGLVL_BUS, " .controlselector = 0x%x\n", m->controlselector);\r\ndprintk(DBGLVL_BUS, " .seqno = %d\n", m->seqno);\r\nif (buf)\r\ndprintk(DBGLVL_BUS, " .buffer (ignored)\n");\r\n}\r\nint saa7164_bus_set(struct saa7164_dev *dev, struct tmComResInfo* msg,\r\nvoid *buf)\r\n{\r\nstruct tmComResBusInfo *bus = &dev->bus;\r\nu32 bytes_to_write, free_write_space, timeout, curr_srp, curr_swp;\r\nu32 new_swp, space_rem;\r\nint ret = SAA_ERR_BAD_PARAMETER;\r\nu16 size;\r\nif (!msg) {\r\nprintk(KERN_ERR "%s() !msg\n", __func__);\r\nreturn SAA_ERR_BAD_PARAMETER;\r\n}\r\ndprintk(DBGLVL_BUS, "%s()\n", __func__);\r\nsaa7164_bus_verify(dev);\r\nif (msg->size > dev->bus.m_wMaxReqSize) {\r\nprintk(KERN_ERR "%s() Exceeded dev->bus.m_wMaxReqSize\n",\r\n__func__);\r\nreturn SAA_ERR_BAD_PARAMETER;\r\n}\r\nif ((msg->size > 0) && (buf == NULL)) {\r\nprintk(KERN_ERR "%s() Missing message buffer\n", __func__);\r\nreturn SAA_ERR_BAD_PARAMETER;\r\n}\r\nmutex_lock(&bus->lock);\r\nbytes_to_write = sizeof(*msg) + msg->size;\r\nfree_write_space = 0;\r\ntimeout = SAA_BUS_TIMEOUT;\r\ncurr_srp = saa7164_readl(bus->m_dwSetReadPos);\r\ncurr_swp = saa7164_readl(bus->m_dwSetWritePos);\r\nif (curr_srp > curr_swp)\r\nfree_write_space = curr_srp - curr_swp;\r\nelse\r\nfree_write_space = (curr_srp + bus->m_dwSizeSetRing) - curr_swp;\r\ndprintk(DBGLVL_BUS, "%s() bytes_to_write = %d\n", __func__,\r\nbytes_to_write);\r\ndprintk(DBGLVL_BUS, "%s() free_write_space = %d\n", __func__,\r\nfree_write_space);\r\ndprintk(DBGLVL_BUS, "%s() curr_srp = %x\n", __func__, curr_srp);\r\ndprintk(DBGLVL_BUS, "%s() curr_swp = %x\n", __func__, curr_swp);\r\nwhile (bytes_to_write >= free_write_space) {\r\nif (timeout-- == 0) {\r\nprintk(KERN_ERR "%s() bus timeout\n", __func__);\r\nret = SAA_ERR_NO_RESOURCES;\r\ngoto out;\r\n}\r\nmdelay(1);\r\ncurr_srp = saa7164_readl(bus->m_dwSetReadPos);\r\nif (curr_srp > curr_swp)\r\nfree_write_space = curr_srp - curr_swp;\r\nelse\r\nfree_write_space = (curr_srp + bus->m_dwSizeSetRing) -\r\ncurr_swp;\r\n}\r\nnew_swp = curr_swp + bytes_to_write;\r\ndprintk(DBGLVL_BUS, "%s() new_swp = %x\n", __func__, new_swp);\r\ndprintk(DBGLVL_BUS, "%s() bus->m_dwSizeSetRing = %x\n", __func__,\r\nbus->m_dwSizeSetRing);\r\nsize = msg->size;\r\nmsg->size = (__force u16)cpu_to_le16(msg->size);\r\nmsg->command = (__force u32)cpu_to_le32(msg->command);\r\nmsg->controlselector = (__force u16)cpu_to_le16(msg->controlselector);\r\nif (new_swp > bus->m_dwSizeSetRing) {\r\nnew_swp -= bus->m_dwSizeSetRing;\r\nspace_rem = bus->m_dwSizeSetRing - curr_swp;\r\ndprintk(DBGLVL_BUS, "%s() space_rem = %x\n", __func__,\r\nspace_rem);\r\ndprintk(DBGLVL_BUS, "%s() sizeof(*msg) = %d\n", __func__,\r\n(u32)sizeof(*msg));\r\nif (space_rem < sizeof(*msg)) {\r\ndprintk(DBGLVL_BUS, "%s() tr4\n", __func__);\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp, msg, space_rem);\r\nmemcpy_toio(bus->m_pdwSetRing, (u8 *)msg + space_rem,\r\nsizeof(*msg) - space_rem);\r\nmemcpy_toio(bus->m_pdwSetRing + sizeof(*msg) - space_rem,\r\nbuf, size);\r\n} else if (space_rem == sizeof(*msg)) {\r\ndprintk(DBGLVL_BUS, "%s() tr5\n", __func__);\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp, msg, sizeof(*msg));\r\nmemcpy_toio(bus->m_pdwSetRing, buf, size);\r\n} else {\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp, msg, sizeof(*msg));\r\nif (size > 0) {\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp +\r\nsizeof(*msg), buf, space_rem -\r\nsizeof(*msg));\r\nmemcpy_toio(bus->m_pdwSetRing, (u8 *)buf +\r\nspace_rem - sizeof(*msg),\r\nbytes_to_write - space_rem);\r\n}\r\n}\r\n}\r\nelse {\r\ndprintk(DBGLVL_BUS, "%s() tr6\n", __func__);\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp, msg, sizeof(*msg));\r\nmemcpy_toio(bus->m_pdwSetRing + curr_swp + sizeof(*msg), buf,\r\nsize);\r\n}\r\ndprintk(DBGLVL_BUS, "%s() new_swp = %x\n", __func__, new_swp);\r\nsaa7164_writel(bus->m_dwSetWritePos, new_swp);\r\nmsg->size = le16_to_cpu((__force __le16)msg->size);\r\nmsg->command = le32_to_cpu((__force __le32)msg->command);\r\nmsg->controlselector = le16_to_cpu((__force __le16)msg->controlselector);\r\nret = SAA_OK;\r\nout:\r\nsaa7164_bus_dump(dev);\r\nmutex_unlock(&bus->lock);\r\nsaa7164_bus_verify(dev);\r\nreturn ret;\r\n}\r\nint saa7164_bus_get(struct saa7164_dev *dev, struct tmComResInfo* msg,\r\nvoid *buf, int peekonly)\r\n{\r\nstruct tmComResBusInfo *bus = &dev->bus;\r\nu32 bytes_to_read, write_distance, curr_grp, curr_gwp,\r\nnew_grp, buf_size, space_rem;\r\nstruct tmComResInfo msg_tmp;\r\nint ret = SAA_ERR_BAD_PARAMETER;\r\nsaa7164_bus_verify(dev);\r\nif (msg == NULL)\r\nreturn ret;\r\nif (msg->size > dev->bus.m_wMaxReqSize) {\r\nprintk(KERN_ERR "%s() Exceeded dev->bus.m_wMaxReqSize\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nif ((peekonly == 0) && (msg->size > 0) && (buf == NULL)) {\r\nprintk(KERN_ERR\r\n"%s() Missing msg buf, size should be %d bytes\n",\r\n__func__, msg->size);\r\nreturn ret;\r\n}\r\nmutex_lock(&bus->lock);\r\ncurr_gwp = saa7164_readl(bus->m_dwGetWritePos);\r\ncurr_grp = saa7164_readl(bus->m_dwGetReadPos);\r\nif (curr_gwp == curr_grp) {\r\nret = SAA_ERR_EMPTY;\r\ngoto out;\r\n}\r\nbytes_to_read = sizeof(*msg);\r\nwrite_distance = 0;\r\nif (curr_gwp >= curr_grp)\r\nwrite_distance = curr_gwp - curr_grp;\r\nelse\r\nwrite_distance = curr_gwp + bus->m_dwSizeGetRing - curr_grp;\r\nif (bytes_to_read > write_distance) {\r\nprintk(KERN_ERR "%s() No message/response found\n", __func__);\r\nret = SAA_ERR_INVALID_COMMAND;\r\ngoto out;\r\n}\r\nnew_grp = curr_grp + bytes_to_read;\r\nif (new_grp > bus->m_dwSizeGetRing) {\r\nnew_grp -= bus->m_dwSizeGetRing;\r\nspace_rem = bus->m_dwSizeGetRing - curr_grp;\r\nmemcpy_fromio(&msg_tmp, bus->m_pdwGetRing + curr_grp, space_rem);\r\nmemcpy_fromio((u8 *)&msg_tmp + space_rem, bus->m_pdwGetRing,\r\nbytes_to_read - space_rem);\r\n} else {\r\nmemcpy_fromio(&msg_tmp, bus->m_pdwGetRing + curr_grp, bytes_to_read);\r\n}\r\nmsg_tmp.size = le16_to_cpu((__force __le16)msg_tmp.size);\r\nmsg_tmp.command = le32_to_cpu((__force __le32)msg_tmp.command);\r\nmsg_tmp.controlselector = le16_to_cpu((__force __le16)msg_tmp.controlselector);\r\nif (peekonly) {\r\nmemcpy(msg, &msg_tmp, sizeof(*msg));\r\ngoto peekout;\r\n}\r\nif ((msg_tmp.id != msg->id) || (msg_tmp.command != msg->command) ||\r\n(msg_tmp.controlselector != msg->controlselector) ||\r\n(msg_tmp.seqno != msg->seqno) || (msg_tmp.size != msg->size)) {\r\nprintk(KERN_ERR "%s() Unexpected msg miss-match\n", __func__);\r\nsaa7164_bus_dumpmsg(dev, msg, buf);\r\nsaa7164_bus_dumpmsg(dev, &msg_tmp, NULL);\r\nret = SAA_ERR_INVALID_COMMAND;\r\ngoto out;\r\n}\r\nbuf_size = msg->size;\r\nbytes_to_read = sizeof(*msg) + msg->size;\r\nwrite_distance = 0;\r\nif (curr_gwp >= curr_grp)\r\nwrite_distance = curr_gwp - curr_grp;\r\nelse\r\nwrite_distance = curr_gwp + bus->m_dwSizeGetRing - curr_grp;\r\nif (bytes_to_read > write_distance) {\r\nprintk(KERN_ERR "%s() Invalid bus state, missing msg or mangled ring, faulty H/W / bad code?\n",\r\n__func__);\r\nret = SAA_ERR_INVALID_COMMAND;\r\ngoto out;\r\n}\r\nnew_grp = curr_grp + bytes_to_read;\r\nif (new_grp > bus->m_dwSizeGetRing) {\r\nnew_grp -= bus->m_dwSizeGetRing;\r\nspace_rem = bus->m_dwSizeGetRing - curr_grp;\r\nif (space_rem < sizeof(*msg)) {\r\nmemcpy_fromio(msg, bus->m_pdwGetRing + curr_grp, space_rem);\r\nmemcpy_fromio((u8 *)msg + space_rem, bus->m_pdwGetRing,\r\nsizeof(*msg) - space_rem);\r\nif (buf)\r\nmemcpy_fromio(buf, bus->m_pdwGetRing + sizeof(*msg) -\r\nspace_rem, buf_size);\r\n} else if (space_rem == sizeof(*msg)) {\r\nmemcpy_fromio(msg, bus->m_pdwGetRing + curr_grp, sizeof(*msg));\r\nif (buf)\r\nmemcpy_fromio(buf, bus->m_pdwGetRing, buf_size);\r\n} else {\r\nmemcpy_fromio(msg, bus->m_pdwGetRing + curr_grp, sizeof(*msg));\r\nif (buf) {\r\nmemcpy_fromio(buf, bus->m_pdwGetRing + curr_grp +\r\nsizeof(*msg), space_rem - sizeof(*msg));\r\nmemcpy_fromio(buf + space_rem - sizeof(*msg),\r\nbus->m_pdwGetRing, bytes_to_read -\r\nspace_rem);\r\n}\r\n}\r\n} else {\r\nmemcpy_fromio(msg, bus->m_pdwGetRing + curr_grp, sizeof(*msg));\r\nif (buf)\r\nmemcpy_fromio(buf, bus->m_pdwGetRing + curr_grp + sizeof(*msg),\r\nbuf_size);\r\n}\r\nmsg->size = le16_to_cpu((__force __le16)msg->size);\r\nmsg->command = le32_to_cpu((__force __le32)msg->command);\r\nmsg->controlselector = le16_to_cpu((__force __le16)msg->controlselector);\r\nsaa7164_writel(bus->m_dwGetReadPos, new_grp);\r\npeekout:\r\nret = SAA_OK;\r\nout:\r\nmutex_unlock(&bus->lock);\r\nsaa7164_bus_verify(dev);\r\nreturn ret;\r\n}

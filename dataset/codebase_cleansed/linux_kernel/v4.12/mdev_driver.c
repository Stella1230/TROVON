static int mdev_attach_iommu(struct mdev_device *mdev)\r\n{\r\nint ret;\r\nstruct iommu_group *group;\r\ngroup = iommu_group_alloc();\r\nif (IS_ERR(group))\r\nreturn PTR_ERR(group);\r\nret = iommu_group_add_device(group, &mdev->dev);\r\nif (!ret)\r\ndev_info(&mdev->dev, "MDEV: group_id = %d\n",\r\niommu_group_id(group));\r\niommu_group_put(group);\r\nreturn ret;\r\n}\r\nstatic void mdev_detach_iommu(struct mdev_device *mdev)\r\n{\r\niommu_group_remove_device(&mdev->dev);\r\ndev_info(&mdev->dev, "MDEV: detaching iommu\n");\r\n}\r\nstatic int mdev_probe(struct device *dev)\r\n{\r\nstruct mdev_driver *drv = to_mdev_driver(dev->driver);\r\nstruct mdev_device *mdev = to_mdev_device(dev);\r\nint ret;\r\nret = mdev_attach_iommu(mdev);\r\nif (ret)\r\nreturn ret;\r\nif (drv && drv->probe) {\r\nret = drv->probe(dev);\r\nif (ret)\r\nmdev_detach_iommu(mdev);\r\n}\r\nreturn ret;\r\n}\r\nstatic int mdev_remove(struct device *dev)\r\n{\r\nstruct mdev_driver *drv = to_mdev_driver(dev->driver);\r\nstruct mdev_device *mdev = to_mdev_device(dev);\r\nif (drv && drv->remove)\r\ndrv->remove(dev);\r\nmdev_detach_iommu(mdev);\r\nreturn 0;\r\n}\r\nint mdev_register_driver(struct mdev_driver *drv, struct module *owner)\r\n{\r\ndrv->driver.name = drv->name;\r\ndrv->driver.bus = &mdev_bus_type;\r\ndrv->driver.owner = owner;\r\nreturn driver_register(&drv->driver);\r\n}\r\nvoid mdev_unregister_driver(struct mdev_driver *drv)\r\n{\r\ndriver_unregister(&drv->driver);\r\n}\r\nint mdev_bus_register(void)\r\n{\r\nreturn bus_register(&mdev_bus_type);\r\n}\r\nvoid mdev_bus_unregister(void)\r\n{\r\nbus_unregister(&mdev_bus_type);\r\n}

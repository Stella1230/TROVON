static void audit_cb(struct audit_buffer *ab, void *va)\r\n{\r\nstruct common_audit_data *sa = va;\r\naudit_log_format(ab, " peer=");\r\naudit_log_untrustedstring(ab, aad(sa)->peer->base.hname);\r\n}\r\nstatic int aa_audit_ptrace(struct aa_profile *profile,\r\nstruct aa_profile *target, int error)\r\n{\r\nDEFINE_AUDIT_DATA(sa, LSM_AUDIT_DATA_NONE, OP_PTRACE);\r\naad(&sa)->peer = target;\r\naad(&sa)->error = error;\r\nreturn aa_audit(AUDIT_APPARMOR_AUTO, profile, &sa, audit_cb);\r\n}\r\nint aa_may_ptrace(struct aa_profile *tracer, struct aa_profile *tracee,\r\nunsigned int mode)\r\n{\r\nif (unconfined(tracer) || tracer == tracee)\r\nreturn 0;\r\nreturn aa_capable(tracer, CAP_SYS_PTRACE, 1);\r\n}\r\nint aa_ptrace(struct task_struct *tracer, struct task_struct *tracee,\r\nunsigned int mode)\r\n{\r\nstruct aa_profile *tracer_p = aa_get_task_profile(tracer);\r\nint error = 0;\r\nif (!unconfined(tracer_p)) {\r\nstruct aa_profile *tracee_p = aa_get_task_profile(tracee);\r\nerror = aa_may_ptrace(tracer_p, tracee_p, mode);\r\nerror = aa_audit_ptrace(tracer_p, tracee_p, error);\r\naa_put_profile(tracee_p);\r\n}\r\naa_put_profile(tracer_p);\r\nreturn error;\r\n}

static void rtl8723bu_write_btreg(struct rtl8xxxu_priv *priv, u8 reg, u8 data)\r\n{\r\nstruct h2c_cmd h2c;\r\nint reqnum = 0;\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.bt_mp_oper.cmd = H2C_8723B_BT_MP_OPER;\r\nh2c.bt_mp_oper.operreq = 0 | (reqnum << 4);\r\nh2c.bt_mp_oper.opcode = BT_MP_OP_WRITE_REG_VALUE;\r\nh2c.bt_mp_oper.data = data;\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.bt_mp_oper));\r\nreqnum++;\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.bt_mp_oper.cmd = H2C_8723B_BT_MP_OPER;\r\nh2c.bt_mp_oper.operreq = 0 | (reqnum << 4);\r\nh2c.bt_mp_oper.opcode = BT_MP_OP_WRITE_REG_VALUE;\r\nh2c.bt_mp_oper.addr = reg;\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.bt_mp_oper));\r\n}\r\nstatic void rtl8723bu_reset_8051(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu16 sys_func;\r\nval8 = rtl8xxxu_read8(priv, REG_RSV_CTRL);\r\nval8 &= ~BIT(1);\r\nrtl8xxxu_write8(priv, REG_RSV_CTRL, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_RSV_CTRL + 1);\r\nval8 &= ~BIT(0);\r\nrtl8xxxu_write8(priv, REG_RSV_CTRL + 1, val8);\r\nsys_func = rtl8xxxu_read16(priv, REG_SYS_FUNC);\r\nsys_func &= ~SYS_FUNC_CPU_ENABLE;\r\nrtl8xxxu_write16(priv, REG_SYS_FUNC, sys_func);\r\nval8 = rtl8xxxu_read8(priv, REG_RSV_CTRL);\r\nval8 &= ~BIT(1);\r\nrtl8xxxu_write8(priv, REG_RSV_CTRL, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_RSV_CTRL + 1);\r\nval8 |= BIT(0);\r\nrtl8xxxu_write8(priv, REG_RSV_CTRL + 1, val8);\r\nsys_func |= SYS_FUNC_CPU_ENABLE;\r\nrtl8xxxu_write16(priv, REG_SYS_FUNC, sys_func);\r\n}\r\nstatic void\r\nrtl8723b_set_tx_power(struct rtl8xxxu_priv *priv, int channel, bool ht40)\r\n{\r\nu32 val32, ofdm, mcs;\r\nu8 cck, ofdmbase, mcsbase;\r\nint group, tx_idx;\r\ntx_idx = 0;\r\ngroup = rtl8xxxu_gen2_channel_to_group(channel);\r\ncck = priv->cck_tx_power_index_B[group];\r\nval32 = rtl8xxxu_read32(priv, REG_TX_AGC_A_CCK1_MCS32);\r\nval32 &= 0xffff00ff;\r\nval32 |= (cck << 8);\r\nrtl8xxxu_write32(priv, REG_TX_AGC_A_CCK1_MCS32, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_TX_AGC_B_CCK11_A_CCK2_11);\r\nval32 &= 0xff;\r\nval32 |= ((cck << 8) | (cck << 16) | (cck << 24));\r\nrtl8xxxu_write32(priv, REG_TX_AGC_B_CCK11_A_CCK2_11, val32);\r\nofdmbase = priv->ht40_1s_tx_power_index_B[group];\r\nofdmbase += priv->ofdm_tx_power_diff[tx_idx].b;\r\nofdm = ofdmbase | ofdmbase << 8 | ofdmbase << 16 | ofdmbase << 24;\r\nrtl8xxxu_write32(priv, REG_TX_AGC_A_RATE18_06, ofdm);\r\nrtl8xxxu_write32(priv, REG_TX_AGC_A_RATE54_24, ofdm);\r\nmcsbase = priv->ht40_1s_tx_power_index_B[group];\r\nif (ht40)\r\nmcsbase += priv->ht40_tx_power_diff[tx_idx++].b;\r\nelse\r\nmcsbase += priv->ht20_tx_power_diff[tx_idx++].b;\r\nmcs = mcsbase | mcsbase << 8 | mcsbase << 16 | mcsbase << 24;\r\nrtl8xxxu_write32(priv, REG_TX_AGC_A_MCS03_MCS00, mcs);\r\nrtl8xxxu_write32(priv, REG_TX_AGC_A_MCS07_MCS04, mcs);\r\n}\r\nstatic int rtl8723bu_parse_efuse(struct rtl8xxxu_priv *priv)\r\n{\r\nstruct rtl8723bu_efuse *efuse = &priv->efuse_wifi.efuse8723bu;\r\nint i;\r\nif (efuse->rtl_id != cpu_to_le16(0x8129))\r\nreturn -EINVAL;\r\nether_addr_copy(priv->mac_addr, efuse->mac_addr);\r\nmemcpy(priv->cck_tx_power_index_A, efuse->tx_power_index_A.cck_base,\r\nsizeof(efuse->tx_power_index_A.cck_base));\r\nmemcpy(priv->cck_tx_power_index_B, efuse->tx_power_index_B.cck_base,\r\nsizeof(efuse->tx_power_index_B.cck_base));\r\nmemcpy(priv->ht40_1s_tx_power_index_A,\r\nefuse->tx_power_index_A.ht40_base,\r\nsizeof(efuse->tx_power_index_A.ht40_base));\r\nmemcpy(priv->ht40_1s_tx_power_index_B,\r\nefuse->tx_power_index_B.ht40_base,\r\nsizeof(efuse->tx_power_index_B.ht40_base));\r\npriv->ofdm_tx_power_diff[0].a =\r\nefuse->tx_power_index_A.ht20_ofdm_1s_diff.a;\r\npriv->ofdm_tx_power_diff[0].b =\r\nefuse->tx_power_index_B.ht20_ofdm_1s_diff.a;\r\npriv->ht20_tx_power_diff[0].a =\r\nefuse->tx_power_index_A.ht20_ofdm_1s_diff.b;\r\npriv->ht20_tx_power_diff[0].b =\r\nefuse->tx_power_index_B.ht20_ofdm_1s_diff.b;\r\npriv->ht40_tx_power_diff[0].a = 0;\r\npriv->ht40_tx_power_diff[0].b = 0;\r\nfor (i = 1; i < RTL8723B_TX_COUNT; i++) {\r\npriv->ofdm_tx_power_diff[i].a =\r\nefuse->tx_power_index_A.pwr_diff[i - 1].ofdm;\r\npriv->ofdm_tx_power_diff[i].b =\r\nefuse->tx_power_index_B.pwr_diff[i - 1].ofdm;\r\npriv->ht20_tx_power_diff[i].a =\r\nefuse->tx_power_index_A.pwr_diff[i - 1].ht20;\r\npriv->ht20_tx_power_diff[i].b =\r\nefuse->tx_power_index_B.pwr_diff[i - 1].ht20;\r\npriv->ht40_tx_power_diff[i].a =\r\nefuse->tx_power_index_A.pwr_diff[i - 1].ht40;\r\npriv->ht40_tx_power_diff[i].b =\r\nefuse->tx_power_index_B.pwr_diff[i - 1].ht40;\r\n}\r\npriv->has_xtalk = 1;\r\npriv->xtalk = priv->efuse_wifi.efuse8723bu.xtal_k & 0x3f;\r\ndev_info(&priv->udev->dev, "Vendor: %.7s\n", efuse->vendor_name);\r\ndev_info(&priv->udev->dev, "Product: %.41s\n", efuse->device_name);\r\nif (rtl8xxxu_debug & RTL8XXXU_DEBUG_EFUSE) {\r\nint i;\r\nunsigned char *raw = priv->efuse_wifi.raw;\r\ndev_info(&priv->udev->dev,\r\n"%s: dumping efuse (0x%02zx bytes):\n",\r\n__func__, sizeof(struct rtl8723bu_efuse));\r\nfor (i = 0; i < sizeof(struct rtl8723bu_efuse); i += 8)\r\ndev_info(&priv->udev->dev, "%02x: %8ph\n", i, &raw[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rtl8723bu_load_firmware(struct rtl8xxxu_priv *priv)\r\n{\r\nchar *fw_name;\r\nint ret;\r\nif (priv->enable_bluetooth)\r\nfw_name = "rtlwifi/rtl8723bu_bt.bin";\r\nelse\r\nfw_name = "rtlwifi/rtl8723bu_nic.bin";\r\nret = rtl8xxxu_load_firmware(priv, fw_name);\r\nreturn ret;\r\n}\r\nstatic void rtl8723bu_init_phy_bb(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu16 val16;\r\nval16 = rtl8xxxu_read16(priv, REG_SYS_FUNC);\r\nval16 |= SYS_FUNC_BB_GLB_RSTN | SYS_FUNC_BBRSTB | SYS_FUNC_DIO_RF;\r\nrtl8xxxu_write16(priv, REG_SYS_FUNC, val16);\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00);\r\nval8 = RF_ENABLE | RF_RSTB | RF_SDMRSTB;\r\nrtl8xxxu_write8(priv, REG_RF_CTRL, val8);\r\nrtl8xxxu_write8(priv, REG_SYS_FUNC, 0xe3);\r\nrtl8xxxu_write8(priv, REG_AFE_XTAL_CTRL + 1, 0x80);\r\nrtl8xxxu_init_phy_regs(priv, rtl8723b_phy_1t_init_table);\r\nrtl8xxxu_init_phy_regs(priv, rtl8xxx_agc_8723bu_table);\r\n}\r\nstatic int rtl8723bu_init_phy_rf(struct rtl8xxxu_priv *priv)\r\n{\r\nint ret;\r\nret = rtl8xxxu_init_phy_rf(priv, rtl8723bu_radioa_1t_init_table, RF_A);\r\nrtl8xxxu_write_rfreg(priv, RF_A, 0xb0, 0xdfbe0);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_MODE_AG, 0x8c01);\r\nmsleep(200);\r\nrtl8xxxu_write_rfreg(priv, RF_A, 0xb0, 0xdffe0);\r\nreturn ret;\r\n}\r\nstatic void rtl8723bu_phy_init_antenna_selection(struct rtl8xxxu_priv *priv)\r\n{\r\nu32 val32;\r\nval32 = rtl8xxxu_read32(priv, REG_PAD_CTRL1);\r\nval32 &= ~(BIT(20) | BIT(24));\r\nrtl8xxxu_write32(priv, REG_PAD_CTRL1, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_GPIO_MUXCFG);\r\nval32 &= ~BIT(4);\r\nrtl8xxxu_write32(priv, REG_GPIO_MUXCFG, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_GPIO_MUXCFG);\r\nval32 |= BIT(3);\r\nrtl8xxxu_write32(priv, REG_GPIO_MUXCFG, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_LEDCFG0);\r\nval32 |= BIT(24);\r\nrtl8xxxu_write32(priv, REG_LEDCFG0, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_LEDCFG0);\r\nval32 &= ~BIT(23);\r\nrtl8xxxu_write32(priv, REG_LEDCFG0, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_RFE_BUFFER);\r\nval32 |= (BIT(0) | BIT(1));\r\nrtl8xxxu_write32(priv, REG_RFE_BUFFER, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_RFE_CTRL_ANTA_SRC);\r\nval32 &= 0xffffff00;\r\nval32 |= 0x77;\r\nrtl8xxxu_write32(priv, REG_RFE_CTRL_ANTA_SRC, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_PWR_DATA);\r\nval32 |= PWR_DATA_EEPRPAD_RFE_CTRL_EN;\r\nrtl8xxxu_write32(priv, REG_PWR_DATA, val32);\r\n}\r\nstatic int rtl8723bu_iqk_path_a(struct rtl8xxxu_priv *priv)\r\n{\r\nu32 reg_eac, reg_e94, reg_e9c, path_sel, val32;\r\nint result = 0;\r\npath_sel = rtl8xxxu_read32(priv, REG_S0S1_PATH_SWITCH);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_WE_LUT);\r\nval32 |= 0x80000;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_WE_LUT, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_RCK_OS, 0x20000);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G1, 0x0003f);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G2, 0xc7f87);\r\nrtl8xxxu_write32(priv, REG_TX_IQK, 0x01007c00);\r\nrtl8xxxu_write32(priv, REG_RX_IQK, 0x01004800);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_A, 0x18008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_A, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_A, 0x821403ea);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_A, 0x28110000);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_B, 0x82110000);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_B, 0x28110000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_RSP, 0x00462911);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nval32 |= 0x80800000;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nif (priv->rf_paths > 1)\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000000);\r\nelse\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000280);\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00000800);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf9000000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf8000000);\r\nmdelay(1);\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, path_sel);\r\n#ifdef RTL8723BU_BT\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00001800);\r\n#endif\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nreg_eac = rtl8xxxu_read32(priv, REG_RX_POWER_AFTER_IQK_A_2);\r\nreg_e94 = rtl8xxxu_read32(priv, REG_TX_POWER_BEFORE_IQK_A);\r\nreg_e9c = rtl8xxxu_read32(priv, REG_TX_POWER_AFTER_IQK_A);\r\nval32 = (reg_e9c >> 16) & 0x3ff;\r\nif (val32 & 0x200)\r\nval32 = 0x400 - val32;\r\nif (!(reg_eac & BIT(28)) &&\r\n((reg_e94 & 0x03ff0000) != 0x01420000) &&\r\n((reg_e9c & 0x03ff0000) != 0x00420000) &&\r\n((reg_e94 & 0x03ff0000) < 0x01100000) &&\r\n((reg_e94 & 0x03ff0000) > 0x00f00000) &&\r\nval32 < 0xf)\r\nresult |= 0x01;\r\nelse\r\ngoto out;\r\nout:\r\nreturn result;\r\n}\r\nstatic int rtl8723bu_rx_iqk_path_a(struct rtl8xxxu_priv *priv)\r\n{\r\nu32 reg_ea4, reg_eac, reg_e94, reg_e9c, path_sel, val32;\r\nint result = 0;\r\npath_sel = rtl8xxxu_read32(priv, REG_S0S1_PATH_SWITCH);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_WE_LUT);\r\nval32 |= 0x80000;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_WE_LUT, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_RCK_OS, 0x30000);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G1, 0x0001f);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G2, 0xf7fb7);\r\nrtl8xxxu_write32(priv, REG_TX_IQK, 0x01007c00);\r\nrtl8xxxu_write32(priv, REG_RX_IQK, 0x01004800);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_A, 0x18008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_A, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_A, 0x82160ff0);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_A, 0x28110000);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_B, 0x82110000);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_B, 0x28110000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_RSP, 0x0046a911);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nval32 |= 0x80800000;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nif (priv->rf_paths > 1)\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000000);\r\nelse\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000280);\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00000800);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf9000000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf8000000);\r\nmdelay(1);\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, path_sel);\r\n#ifdef RTL8723BU_BT\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00001800);\r\n#endif\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nreg_eac = rtl8xxxu_read32(priv, REG_RX_POWER_AFTER_IQK_A_2);\r\nreg_e94 = rtl8xxxu_read32(priv, REG_TX_POWER_BEFORE_IQK_A);\r\nreg_e9c = rtl8xxxu_read32(priv, REG_TX_POWER_AFTER_IQK_A);\r\nval32 = (reg_e9c >> 16) & 0x3ff;\r\nif (val32 & 0x200)\r\nval32 = 0x400 - val32;\r\nif (!(reg_eac & BIT(28)) &&\r\n((reg_e94 & 0x03ff0000) != 0x01420000) &&\r\n((reg_e9c & 0x03ff0000) != 0x00420000) &&\r\n((reg_e94 & 0x03ff0000) < 0x01100000) &&\r\n((reg_e94 & 0x03ff0000) > 0x00f00000) &&\r\nval32 < 0xf)\r\nresult |= 0x01;\r\nelse\r\ngoto out;\r\nval32 = 0x80007c00 | (reg_e94 &0x3ff0000) |\r\n((reg_e9c & 0x3ff0000) >> 16);\r\nrtl8xxxu_write32(priv, REG_TX_IQK, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_WE_LUT);\r\nval32 |= 0x80000;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_WE_LUT, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_RCK_OS, 0x30000);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G1, 0x0001f);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G2, 0xf7d77);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_DF, 0xf80);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_55, 0x4021f);\r\nrtl8xxxu_write32(priv, REG_RX_IQK, 0x01004800);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_A, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_A, 0x18008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_B, 0x38008c1c);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_A, 0x82110000);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_A, 0x2816001f);\r\nrtl8xxxu_write32(priv, REG_TX_IQK_PI_B, 0x82110000);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_PI_B, 0x28110000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_RSP, 0x0046a8d1);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nval32 |= 0x80800000;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nif (priv->rf_paths > 1)\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000000);\r\nelse\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00000280);\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00000800);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf9000000);\r\nrtl8xxxu_write32(priv, REG_IQK_AGC_PTS, 0xf8000000);\r\nmdelay(1);\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, path_sel);\r\n#ifdef RTL8723BU_BT\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, 0x00001800);\r\n#endif\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nreg_eac = rtl8xxxu_read32(priv, REG_RX_POWER_AFTER_IQK_A_2);\r\nreg_ea4 = rtl8xxxu_read32(priv, REG_RX_POWER_BEFORE_IQK_A_2);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_DF, 0x780);\r\nval32 = (reg_eac >> 16) & 0x3ff;\r\nif (val32 & 0x200)\r\nval32 = 0x400 - val32;\r\nif (!(reg_eac & BIT(27)) &&\r\n((reg_ea4 & 0x03ff0000) != 0x01320000) &&\r\n((reg_eac & 0x03ff0000) != 0x00360000) &&\r\n((reg_ea4 & 0x03ff0000) < 0x01100000) &&\r\n((reg_ea4 & 0x03ff0000) > 0x00f00000) &&\r\nval32 < 0xf)\r\nresult |= 0x02;\r\nelse\r\ngoto out;\r\nout:\r\nreturn result;\r\n}\r\nstatic void rtl8723bu_phy_iqcalibrate(struct rtl8xxxu_priv *priv,\r\nint result[][8], int t)\r\n{\r\nstruct device *dev = &priv->udev->dev;\r\nu32 i, val32;\r\nint path_a_ok ;\r\nint retry = 2;\r\nconst u32 adda_regs[RTL8XXXU_ADDA_REGS] = {\r\nREG_FPGA0_XCD_SWITCH_CTRL, REG_BLUETOOTH,\r\nREG_RX_WAIT_CCA, REG_TX_CCK_RFON,\r\nREG_TX_CCK_BBON, REG_TX_OFDM_RFON,\r\nREG_TX_OFDM_BBON, REG_TX_TO_RX,\r\nREG_TX_TO_TX, REG_RX_CCK,\r\nREG_RX_OFDM, REG_RX_WAIT_RIFS,\r\nREG_RX_TO_RX, REG_STANDBY,\r\nREG_SLEEP, REG_PMPD_ANAEN\r\n};\r\nconst u32 iqk_mac_regs[RTL8XXXU_MAC_REGS] = {\r\nREG_TXPAUSE, REG_BEACON_CTRL,\r\nREG_BEACON_CTRL_1, REG_GPIO_MUXCFG\r\n};\r\nconst u32 iqk_bb_regs[RTL8XXXU_BB_REGS] = {\r\nREG_OFDM0_TRX_PATH_ENABLE, REG_OFDM0_TR_MUX_PAR,\r\nREG_FPGA0_XCD_RF_SW_CTRL, REG_CONFIG_ANT_A, REG_CONFIG_ANT_B,\r\nREG_FPGA0_XAB_RF_SW_CTRL, REG_FPGA0_XA_RF_INT_OE,\r\nREG_FPGA0_XB_RF_INT_OE, REG_FPGA0_RF_MODE\r\n};\r\nu8 xa_agc = rtl8xxxu_read32(priv, REG_OFDM0_XA_AGC_CORE1) & 0xff;\r\nu8 xb_agc = rtl8xxxu_read32(priv, REG_OFDM0_XB_AGC_CORE1) & 0xff;\r\nif (t == 0) {\r\nrtl8xxxu_save_regs(priv, adda_regs, priv->adda_backup,\r\nRTL8XXXU_ADDA_REGS);\r\nrtl8xxxu_save_mac_regs(priv, iqk_mac_regs, priv->mac_backup);\r\nrtl8xxxu_save_regs(priv, iqk_bb_regs,\r\npriv->bb_backup, RTL8XXXU_BB_REGS);\r\n}\r\nrtl8xxxu_path_adda_on(priv, adda_regs, true);\r\nrtl8xxxu_mac_calibration(priv, iqk_mac_regs, priv->mac_backup);\r\nval32 = rtl8xxxu_read32(priv, REG_CCK0_AFE_SETTING);\r\nval32 |= 0x0f000000;\r\nrtl8xxxu_write32(priv, REG_CCK0_AFE_SETTING, val32);\r\nrtl8xxxu_write32(priv, REG_OFDM0_TRX_PATH_ENABLE, 0x03a05600);\r\nrtl8xxxu_write32(priv, REG_OFDM0_TR_MUX_PAR, 0x000800e4);\r\nrtl8xxxu_write32(priv, REG_FPGA0_XCD_RF_SW_CTRL, 0x22204000);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_WE_LUT);\r\nval32 |= 0x80000;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_WE_LUT, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_RCK_OS, 0x30000);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G1, 0x0001f);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G2, 0xf7fb7);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_ED);\r\nval32 |= 0x20;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_ED, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_43, 0x60fbd);\r\nfor (i = 0; i < retry; i++) {\r\npath_a_ok = rtl8723bu_iqk_path_a(priv);\r\nif (path_a_ok == 0x01) {\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_TX_POWER_BEFORE_IQK_A);\r\nresult[t][0] = (val32 >> 16) & 0x3ff;\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_TX_POWER_AFTER_IQK_A);\r\nresult[t][1] = (val32 >> 16) & 0x3ff;\r\nbreak;\r\n}\r\n}\r\nif (!path_a_ok)\r\ndev_dbg(dev, "%s: Path A TX IQK failed!\n", __func__);\r\nfor (i = 0; i < retry; i++) {\r\npath_a_ok = rtl8723bu_rx_iqk_path_a(priv);\r\nif (path_a_ok == 0x03) {\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_RX_POWER_BEFORE_IQK_A_2);\r\nresult[t][2] = (val32 >> 16) & 0x3ff;\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_RX_POWER_AFTER_IQK_A_2);\r\nresult[t][3] = (val32 >> 16) & 0x3ff;\r\nbreak;\r\n}\r\n}\r\nif (!path_a_ok)\r\ndev_dbg(dev, "%s: Path A RX IQK failed!\n", __func__);\r\nif (priv->tx_paths > 1) {\r\n#if 1\r\ndev_warn(dev, "%s: Path B not supported\n", __func__);\r\n#else\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_AC, 0x10000);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nval32 |= 0x80800000;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nrtl8xxxu_path_adda_on(priv, adda_regs, false);\r\nfor (i = 0; i < retry; i++) {\r\npath_b_ok = rtl8xxxu_iqk_path_b(priv);\r\nif (path_b_ok == 0x03) {\r\nval32 = rtl8xxxu_read32(priv, REG_TX_POWER_BEFORE_IQK_B);\r\nresult[t][4] = (val32 >> 16) & 0x3ff;\r\nval32 = rtl8xxxu_read32(priv, REG_TX_POWER_AFTER_IQK_B);\r\nresult[t][5] = (val32 >> 16) & 0x3ff;\r\nbreak;\r\n}\r\n}\r\nif (!path_b_ok)\r\ndev_dbg(dev, "%s: Path B IQK failed!\n", __func__);\r\nfor (i = 0; i < retry; i++) {\r\npath_b_ok = rtl8723bu_rx_iqk_path_b(priv);\r\nif (path_a_ok == 0x03) {\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_RX_POWER_BEFORE_IQK_B_2);\r\nresult[t][6] = (val32 >> 16) & 0x3ff;\r\nval32 = rtl8xxxu_read32(priv,\r\nREG_RX_POWER_AFTER_IQK_B_2);\r\nresult[t][7] = (val32 >> 16) & 0x3ff;\r\nbreak;\r\n}\r\n}\r\nif (!path_b_ok)\r\ndev_dbg(dev, "%s: Path B RX IQK failed!\n", __func__);\r\n#endif\r\n}\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 &= 0x000000ff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nif (t) {\r\nrtl8xxxu_restore_regs(priv, adda_regs, priv->adda_backup,\r\nRTL8XXXU_ADDA_REGS);\r\nrtl8xxxu_restore_mac_regs(priv, iqk_mac_regs, priv->mac_backup);\r\nrtl8xxxu_restore_regs(priv, iqk_bb_regs,\r\npriv->bb_backup, RTL8XXXU_BB_REGS);\r\nval32 = rtl8xxxu_read32(priv, REG_OFDM0_XA_AGC_CORE1);\r\nval32 &= 0xffffff00;\r\nrtl8xxxu_write32(priv, REG_OFDM0_XA_AGC_CORE1, val32 | 0x50);\r\nrtl8xxxu_write32(priv, REG_OFDM0_XA_AGC_CORE1, val32 | xa_agc);\r\nif (priv->tx_paths > 1) {\r\nval32 = rtl8xxxu_read32(priv, REG_OFDM0_XB_AGC_CORE1);\r\nval32 &= 0xffffff00;\r\nrtl8xxxu_write32(priv, REG_OFDM0_XB_AGC_CORE1,\r\nval32 | 0x50);\r\nrtl8xxxu_write32(priv, REG_OFDM0_XB_AGC_CORE1,\r\nval32 | xb_agc);\r\n}\r\nrtl8xxxu_write32(priv, REG_TX_IQK_TONE_A, 0x01008c00);\r\nrtl8xxxu_write32(priv, REG_RX_IQK_TONE_A, 0x01008c00);\r\n}\r\n}\r\nstatic void rtl8723bu_phy_iq_calibrate(struct rtl8xxxu_priv *priv)\r\n{\r\nstruct device *dev = &priv->udev->dev;\r\nint result[4][8];\r\nint i, candidate;\r\nbool path_a_ok, path_b_ok;\r\nu32 reg_e94, reg_e9c, reg_ea4, reg_eac;\r\nu32 reg_eb4, reg_ebc, reg_ec4, reg_ecc;\r\nu32 val32, bt_control;\r\ns32 reg_tmp = 0;\r\nbool simu;\r\nrtl8xxxu_gen2_prepare_calibrate(priv, 1);\r\nmemset(result, 0, sizeof(result));\r\ncandidate = -1;\r\npath_a_ok = false;\r\npath_b_ok = false;\r\nbt_control = rtl8xxxu_read32(priv, REG_BT_CONTROL_8723BU);\r\nfor (i = 0; i < 3; i++) {\r\nrtl8723bu_phy_iqcalibrate(priv, result, i);\r\nif (i == 1) {\r\nsimu = rtl8xxxu_gen2_simularity_compare(priv,\r\nresult, 0, 1);\r\nif (simu) {\r\ncandidate = 0;\r\nbreak;\r\n}\r\n}\r\nif (i == 2) {\r\nsimu = rtl8xxxu_gen2_simularity_compare(priv,\r\nresult, 0, 2);\r\nif (simu) {\r\ncandidate = 0;\r\nbreak;\r\n}\r\nsimu = rtl8xxxu_gen2_simularity_compare(priv,\r\nresult, 1, 2);\r\nif (simu) {\r\ncandidate = 1;\r\n} else {\r\nfor (i = 0; i < 8; i++)\r\nreg_tmp += result[3][i];\r\nif (reg_tmp)\r\ncandidate = 3;\r\nelse\r\ncandidate = -1;\r\n}\r\n}\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nreg_e94 = result[i][0];\r\nreg_e9c = result[i][1];\r\nreg_ea4 = result[i][2];\r\nreg_eac = result[i][3];\r\nreg_eb4 = result[i][4];\r\nreg_ebc = result[i][5];\r\nreg_ec4 = result[i][6];\r\nreg_ecc = result[i][7];\r\n}\r\nif (candidate >= 0) {\r\nreg_e94 = result[candidate][0];\r\npriv->rege94 = reg_e94;\r\nreg_e9c = result[candidate][1];\r\npriv->rege9c = reg_e9c;\r\nreg_ea4 = result[candidate][2];\r\nreg_eac = result[candidate][3];\r\nreg_eb4 = result[candidate][4];\r\npriv->regeb4 = reg_eb4;\r\nreg_ebc = result[candidate][5];\r\npriv->regebc = reg_ebc;\r\nreg_ec4 = result[candidate][6];\r\nreg_ecc = result[candidate][7];\r\ndev_dbg(dev, "%s: candidate is %x\n", __func__, candidate);\r\ndev_dbg(dev,\r\n"%s: e94 =%x e9c=%x ea4=%x eac=%x eb4=%x ebc=%x ec4=%x "\r\n"ecc=%x\n ", __func__, reg_e94, reg_e9c,\r\nreg_ea4, reg_eac, reg_eb4, reg_ebc, reg_ec4, reg_ecc);\r\npath_a_ok = true;\r\npath_b_ok = true;\r\n} else {\r\nreg_e94 = reg_eb4 = priv->rege94 = priv->regeb4 = 0x100;\r\nreg_e9c = reg_ebc = priv->rege9c = priv->regebc = 0x0;\r\n}\r\nif (reg_e94 && candidate >= 0)\r\nrtl8xxxu_fill_iqk_matrix_a(priv, path_a_ok, result,\r\ncandidate, (reg_ea4 == 0));\r\nif (priv->tx_paths > 1 && reg_eb4)\r\nrtl8xxxu_fill_iqk_matrix_b(priv, path_b_ok, result,\r\ncandidate, (reg_ec4 == 0));\r\nrtl8xxxu_save_regs(priv, rtl8xxxu_iqk_phy_iq_bb_reg,\r\npriv->bb_recovery_backup, RTL8XXXU_BB_REGS);\r\nrtl8xxxu_write32(priv, REG_BT_CONTROL_8723BU, bt_control);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_WE_LUT);\r\nval32 |= 0x80000;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_WE_LUT, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_RCK_OS, 0x18000);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G1, 0x0001f);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_TXPA_G2, 0xe6177);\r\nval32 = rtl8xxxu_read_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_ED);\r\nval32 |= 0x20;\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_UNKNOWN_ED, val32);\r\nrtl8xxxu_write_rfreg(priv, RF_A, 0x43, 0x300bd);\r\nif (priv->rf_paths > 1)\r\ndev_dbg(dev, "%s: 8723BU 2T not supported\n", __func__);\r\nrtl8xxxu_gen2_prepare_calibrate(priv, 0);\r\n}\r\nstatic int rtl8723bu_active_to_emu(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu16 val16;\r\nu32 val32;\r\nint count, ret = 0;\r\nrtl8xxxu_write8(priv, REG_RF_CTRL, 0);\r\nval16 = rtl8xxxu_read16(priv, REG_GPIO_INTM);\r\nval16 &= ~GPIO_INTM_EDGE_TRIG_IRQ;\r\nrtl8xxxu_write16(priv, REG_GPIO_INTM, val16);\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nval32 |= APS_FSMCO_WLON_RESET;\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nval8 = rtl8xxxu_read8(priv, REG_APS_FSMCO + 1);\r\nval8 |= BIT(1);\r\nrtl8xxxu_write8(priv, REG_APS_FSMCO + 1, val8);\r\nfor (count = RTL8XXXU_MAX_REG_POLL; count; count--) {\r\nval8 = rtl8xxxu_read8(priv, REG_APS_FSMCO + 1);\r\nif ((val8 & BIT(1)) == 0)\r\nbreak;\r\nudelay(10);\r\n}\r\nif (!count) {\r\ndev_warn(&priv->udev->dev, "%s: Disabling MAC timed out\n",\r\n__func__);\r\nret = -EBUSY;\r\ngoto exit;\r\n}\r\nval8 = rtl8xxxu_read8(priv, REG_AFE_MISC);\r\nval8 &= ~AFE_MISC_WL_XTAL_CTRL;\r\nrtl8xxxu_write8(priv, REG_AFE_MISC, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_SYS_ISO_CTRL);\r\nval8 |= SYS_ISO_ANALOG_IPS;\r\nrtl8xxxu_write8(priv, REG_SYS_ISO_CTRL, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_LDOA15_CTRL);\r\nval8 &= ~LDOA15_ENABLE;\r\nrtl8xxxu_write8(priv, REG_LDOA15_CTRL, val8);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic int rtl8723b_emu_to_active(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu32 val32;\r\nint count, ret = 0;\r\nval8 = rtl8xxxu_read8(priv, REG_LDOA15_CTRL);\r\nval8 |= LDOA15_ENABLE;\r\nrtl8xxxu_write8(priv, REG_LDOA15_CTRL, val8);\r\nval8 = rtl8xxxu_read8(priv, 0x0067);\r\nval8 &= ~BIT(4);\r\nrtl8xxxu_write8(priv, 0x0067, val8);\r\nmdelay(1);\r\nval8 = rtl8xxxu_read8(priv, REG_SYS_ISO_CTRL);\r\nval8 &= ~SYS_ISO_ANALOG_IPS;\r\nrtl8xxxu_write8(priv, REG_SYS_ISO_CTRL, val8);\r\nval32 = rtl8xxxu_read8(priv, REG_APS_FSMCO);\r\nval32 &= ~APS_FSMCO_SW_LPS;\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nfor (count = RTL8XXXU_MAX_REG_POLL; count; count--) {\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nif (val32 & BIT(17))\r\nbreak;\r\nudelay(10);\r\n}\r\nif (!count) {\r\nret = -EBUSY;\r\ngoto exit;\r\n}\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nval32 |= APS_FSMCO_WLON_RESET;\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nval32 &= ~APS_FSMCO_HW_POWERDOWN;\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nval32 &= ~(APS_FSMCO_HW_SUSPEND | APS_FSMCO_PCIE);\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nval32 |= APS_FSMCO_MAC_ENABLE;\r\nrtl8xxxu_write32(priv, REG_APS_FSMCO, val32);\r\nfor (count = RTL8XXXU_MAX_REG_POLL; count; count--) {\r\nval32 = rtl8xxxu_read32(priv, REG_APS_FSMCO);\r\nif ((val32 & APS_FSMCO_MAC_ENABLE) == 0) {\r\nret = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nif (!count) {\r\nret = -EBUSY;\r\ngoto exit;\r\n}\r\nval8 = rtl8xxxu_read8(priv, REG_AFE_MISC);\r\nval8 |= AFE_MISC_WL_XTAL_CTRL;\r\nrtl8xxxu_write8(priv, REG_AFE_MISC, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_GPIO_INTM + 1);\r\nval8 |= BIT(1);\r\nrtl8xxxu_write8(priv, REG_GPIO_INTM + 1, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_GPIO_IO_SEL_2 + 1);\r\nval8 |= BIT(1);\r\nrtl8xxxu_write8(priv, REG_GPIO_IO_SEL_2 + 1, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_GPIO_IO_SEL_2);\r\nval8 &= ~BIT(1);\r\nrtl8xxxu_write8(priv, REG_GPIO_IO_SEL_2, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_HSIMR);\r\nval8 |= BIT(0);\r\nrtl8xxxu_write8(priv, REG_HSIMR, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_HSIMR + 2);\r\nval8 |= BIT(1);\r\nrtl8xxxu_write8(priv, REG_HSIMR + 2, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_MULTI_FUNC_CTRL);\r\nval8 |= MULTI_WIFI_HW_ROF_EN;\r\nrtl8xxxu_write8(priv, REG_MULTI_FUNC_CTRL, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_MULTI_FUNC_CTRL + 1);\r\nval8 |= BIT(6);\r\nrtl8xxxu_write8(priv, REG_MULTI_FUNC_CTRL + 1, val8);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic int rtl8723bu_power_on(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu16 val16;\r\nu32 val32;\r\nint ret;\r\nrtl8xxxu_disabled_to_emu(priv);\r\nret = rtl8723b_emu_to_active(priv);\r\nif (ret)\r\ngoto exit;\r\nval16 = rtl8xxxu_read16(priv, REG_CR);\r\nval16 |= (CR_HCI_TXDMA_ENABLE | CR_HCI_RXDMA_ENABLE |\r\nCR_TXDMA_ENABLE | CR_RXDMA_ENABLE |\r\nCR_PROTOCOL_ENABLE | CR_SCHEDULE_ENABLE |\r\nCR_MAC_TX_ENABLE | CR_MAC_RX_ENABLE |\r\nCR_SECURITY_ENABLE | CR_CALTIMER_ENABLE);\r\nrtl8xxxu_write16(priv, REG_CR, val16);\r\nrtl8xxxu_write8(priv, REG_PAD_CTRL1 + 3, 0x20);\r\nval16 = rtl8xxxu_read16(priv, REG_SYS_FUNC);\r\nval16 |= SYS_FUNC_BBRSTB | SYS_FUNC_BB_GLB_RSTN;\r\nrtl8xxxu_write16(priv, REG_SYS_FUNC, val16);\r\nrtl8xxxu_write8(priv, REG_BT_CONTROL_8723BU + 1, 0x18);\r\nrtl8xxxu_write8(priv, REG_WLAN_ACT_CONTROL_8723B, 0x04);\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00);\r\nrtl8xxxu_write8(priv, 0xfe08, 0x01);\r\nval16 = rtl8xxxu_read16(priv, REG_PWR_DATA);\r\nval16 |= PWR_DATA_EEPRPAD_RFE_CTRL_EN;\r\nrtl8xxxu_write16(priv, REG_PWR_DATA, val16);\r\nval32 = rtl8xxxu_read32(priv, REG_LEDCFG0);\r\nval32 |= LEDCFG0_DPDT_SELECT;\r\nrtl8xxxu_write32(priv, REG_LEDCFG0, val32);\r\nval8 = rtl8xxxu_read8(priv, REG_PAD_CTRL1);\r\nval8 &= ~PAD_CTRL1_SW_DPDT_SEL_DATA;\r\nrtl8xxxu_write8(priv, REG_PAD_CTRL1, val8);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic void rtl8723bu_power_off(struct rtl8xxxu_priv *priv)\r\n{\r\nu8 val8;\r\nu16 val16;\r\nrtl8xxxu_flush_fifo(priv);\r\nval8 = rtl8xxxu_read8(priv, REG_TX_REPORT_CTRL);\r\nval8 &= ~TX_REPORT_CTRL_TIMER_ENABLE;\r\nrtl8xxxu_write8(priv, REG_TX_REPORT_CTRL, val8);\r\nrtl8xxxu_write8(priv, REG_CR, 0x0000);\r\nrtl8xxxu_active_to_lps(priv);\r\nif (rtl8xxxu_read8(priv, REG_MCU_FW_DL) & MCU_FW_RAM_SEL)\r\nrtl8xxxu_firmware_self_reset(priv);\r\nval16 = rtl8xxxu_read16(priv, REG_SYS_FUNC);\r\nval16 &= ~SYS_FUNC_CPU_ENABLE;\r\nrtl8xxxu_write16(priv, REG_SYS_FUNC, val16);\r\nrtl8xxxu_write8(priv, REG_MCU_FW_DL, 0x00);\r\nrtl8723bu_active_to_emu(priv);\r\nval8 = rtl8xxxu_read8(priv, REG_APS_FSMCO + 1);\r\nval8 |= BIT(3);\r\nrtl8xxxu_write8(priv, REG_APS_FSMCO + 1, val8);\r\nval8 = rtl8xxxu_read8(priv, REG_GPIO_INTM + 2);\r\nval8 |= BIT(0);\r\nrtl8xxxu_write8(priv, REG_GPIO_INTM + 2, val8);\r\n}\r\nstatic void rtl8723b_enable_rf(struct rtl8xxxu_priv *priv)\r\n{\r\nstruct h2c_cmd h2c;\r\nu32 val32;\r\nu8 val8;\r\nval32 = rtl8xxxu_read32(priv, REG_RX_WAIT_CCA);\r\nval32 |= (BIT(22) | BIT(23));\r\nrtl8xxxu_write32(priv, REG_RX_WAIT_CCA, val32);\r\nrtl8xxxu_write8(priv, 0x0790, 0x05);\r\nrtl8xxxu_write8(priv, 0x0778, 0x01);\r\nval8 = rtl8xxxu_read8(priv, REG_GPIO_MUXCFG);\r\nval8 |= BIT(5);\r\nrtl8xxxu_write8(priv, REG_GPIO_MUXCFG, val8);\r\nrtl8xxxu_write_rfreg(priv, RF_A, RF6052_REG_IQADJ_G1, 0x780);\r\nrtl8723bu_write_btreg(priv, 0x3c, 0x15);\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.bt_grant.cmd = H2C_8723B_BT_GRANT;\r\nh2c.bt_grant.data = 0;\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.bt_grant));\r\nrtl8xxxu_write8(priv, REG_WLAN_ACT_CONTROL_8723B, 0x04);\r\nval8 = rtl8xxxu_read8(priv, 0x0067);\r\nval8 |= BIT(5);\r\nrtl8xxxu_write8(priv, 0x0067, val8);\r\nval32 = rtl8xxxu_read32(priv, REG_PWR_DATA);\r\nval32 |= PWR_DATA_EEPRPAD_RFE_CTRL_EN;\r\nrtl8xxxu_write32(priv, REG_PWR_DATA, val32);\r\nrtl8xxxu_write8(priv, 0x0974, 0xff);\r\nval32 = rtl8xxxu_read32(priv, REG_RFE_BUFFER);\r\nval32 |= (BIT(0) | BIT(1));\r\nrtl8xxxu_write32(priv, REG_RFE_BUFFER, val32);\r\nrtl8xxxu_write8(priv, REG_RFE_CTRL_ANTA_SRC, 0x77);\r\nval32 = rtl8xxxu_read32(priv, REG_LEDCFG0);\r\nval32 &= ~BIT(24);\r\nval32 |= BIT(23);\r\nrtl8xxxu_write32(priv, REG_LEDCFG0, val32);\r\nval8 = rtl8xxxu_read8(priv, REG_PAD_CTRL1);\r\nval8 &= ~BIT(0);\r\nrtl8xxxu_write8(priv, REG_PAD_CTRL1, val8);\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.ant_sel_rsv.cmd = H2C_8723B_ANT_SEL_RSV;\r\nh2c.ant_sel_rsv.ant_inverse = 1;\r\nh2c.ant_sel_rsv.int_switch_type = 0;\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.ant_sel_rsv));\r\nrtl8xxxu_write32(priv, REG_S0S1_PATH_SWITCH, 0x00);\r\n#ifdef NEED_PS_TDMA\r\nrtl8723bu_set_ps_tdma(priv, 0x08, 0x00, 0x00, 0x00, 0x00);\r\n#endif\r\nrtl8xxxu_write32(priv, REG_BT_COEX_TABLE1, 0x55555555);\r\nrtl8xxxu_write32(priv, REG_BT_COEX_TABLE2, 0x55555555);\r\nrtl8xxxu_write32(priv, REG_BT_COEX_TABLE3, 0x00ffffff);\r\nrtl8xxxu_write8(priv, REG_BT_COEX_TABLE4, 0x03);\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.bt_info.cmd = H2C_8723B_BT_INFO;\r\nh2c.bt_info.data = BIT(0);\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.bt_info));\r\nmemset(&h2c, 0, sizeof(struct h2c_cmd));\r\nh2c.ignore_wlan.cmd = H2C_8723B_BT_IGNORE_WLANACT;\r\nh2c.ignore_wlan.data = 0;\r\nrtl8xxxu_gen2_h2c_cmd(priv, &h2c, sizeof(h2c.ignore_wlan));\r\n}\r\nstatic void rtl8723bu_init_aggregation(struct rtl8xxxu_priv *priv)\r\n{\r\nu32 agg_rx;\r\nu8 agg_ctrl;\r\nagg_ctrl = rtl8xxxu_read8(priv, REG_TRXDMA_CTRL);\r\nagg_ctrl &= ~TRXDMA_CTRL_RXDMA_AGG_EN;\r\nagg_rx = rtl8xxxu_read32(priv, REG_RXDMA_AGG_PG_TH);\r\nagg_rx &= ~RXDMA_USB_AGG_ENABLE;\r\nagg_rx &= ~0xff0f;\r\nrtl8xxxu_write8(priv, REG_TRXDMA_CTRL, agg_ctrl);\r\nrtl8xxxu_write32(priv, REG_RXDMA_AGG_PG_TH, agg_rx);\r\n}\r\nstatic void rtl8723bu_init_statistics(struct rtl8xxxu_priv *priv)\r\n{\r\nu32 val32;\r\nrtl8xxxu_write16(priv, REG_NHM_TIMER_8723B + 2, 0x2710);\r\nrtl8xxxu_write16(priv, REG_NHM_TH9_TH10_8723B + 2, 0xffff);\r\nrtl8xxxu_write32(priv, REG_NHM_TH3_TO_TH0_8723B, 0xffffff52);\r\nrtl8xxxu_write32(priv, REG_NHM_TH7_TO_TH4_8723B, 0xffffffff);\r\nval32 = rtl8xxxu_read32(priv, REG_FPGA0_IQK);\r\nval32 |= 0xff;\r\nrtl8xxxu_write32(priv, REG_FPGA0_IQK, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_NHM_TH9_TH10_8723B);\r\nval32 |= BIT(8) | BIT(9) | BIT(10);\r\nrtl8xxxu_write32(priv, REG_NHM_TH9_TH10_8723B, val32);\r\nval32 = rtl8xxxu_read32(priv, REG_OFDM0_FA_RSTC);\r\nval32 |= BIT(7);\r\nrtl8xxxu_write32(priv, REG_OFDM0_FA_RSTC, val32);\r\n}

static int max77620_irq_global_mask(void *irq_drv_data)\r\n{\r\nstruct max77620_chip *chip = irq_drv_data;\r\nint ret;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_INTENLBT,\r\nMAX77620_GLBLM_MASK, MAX77620_GLBLM_MASK);\r\nif (ret < 0)\r\ndev_err(chip->dev, "Failed to set GLBLM: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_irq_global_unmask(void *irq_drv_data)\r\n{\r\nstruct max77620_chip *chip = irq_drv_data;\r\nint ret;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_INTENLBT,\r\nMAX77620_GLBLM_MASK, 0);\r\nif (ret < 0)\r\ndev_err(chip->dev, "Failed to reset GLBLM: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_get_fps_period_reg_value(struct max77620_chip *chip,\r\nint tperiod)\r\n{\r\nint fps_min_period;\r\nint i;\r\nswitch (chip->chip_id) {\r\ncase MAX20024:\r\nfps_min_period = MAX20024_FPS_PERIOD_MIN_US;\r\nbreak;\r\ncase MAX77620:\r\nfps_min_period = MAX77620_FPS_PERIOD_MIN_US;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < 7; i++) {\r\nif (fps_min_period >= tperiod)\r\nreturn i;\r\nfps_min_period *= 2;\r\n}\r\nreturn i;\r\n}\r\nstatic int max77620_config_fps(struct max77620_chip *chip,\r\nstruct device_node *fps_np)\r\n{\r\nstruct device *dev = chip->dev;\r\nunsigned int mask = 0, config = 0;\r\nu32 fps_max_period;\r\nu32 param_val;\r\nint tperiod, fps_id;\r\nint ret;\r\nchar fps_name[10];\r\nswitch (chip->chip_id) {\r\ncase MAX20024:\r\nfps_max_period = MAX20024_FPS_PERIOD_MAX_US;\r\nbreak;\r\ncase MAX77620:\r\nfps_max_period = MAX77620_FPS_PERIOD_MAX_US;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nfor (fps_id = 0; fps_id < MAX77620_FPS_COUNT; fps_id++) {\r\nsprintf(fps_name, "fps%d", fps_id);\r\nif (!strcmp(fps_np->name, fps_name))\r\nbreak;\r\n}\r\nif (fps_id == MAX77620_FPS_COUNT) {\r\ndev_err(dev, "FPS node name %s is not valid\n", fps_np->name);\r\nreturn -EINVAL;\r\n}\r\nret = of_property_read_u32(fps_np, "maxim,shutdown-fps-time-period-us",\r\n&param_val);\r\nif (!ret) {\r\nmask |= MAX77620_FPS_TIME_PERIOD_MASK;\r\nchip->shutdown_fps_period[fps_id] = min(param_val,\r\nfps_max_period);\r\ntperiod = max77620_get_fps_period_reg_value(chip,\r\nchip->shutdown_fps_period[fps_id]);\r\nconfig |= tperiod << MAX77620_FPS_TIME_PERIOD_SHIFT;\r\n}\r\nret = of_property_read_u32(fps_np, "maxim,suspend-fps-time-period-us",\r\n&param_val);\r\nif (!ret)\r\nchip->suspend_fps_period[fps_id] = min(param_val,\r\nfps_max_period);\r\nret = of_property_read_u32(fps_np, "maxim,fps-event-source",\r\n&param_val);\r\nif (!ret) {\r\nif (param_val > 2) {\r\ndev_err(dev, "FPS%d event-source invalid\n", fps_id);\r\nreturn -EINVAL;\r\n}\r\nmask |= MAX77620_FPS_EN_SRC_MASK;\r\nconfig |= param_val << MAX77620_FPS_EN_SRC_SHIFT;\r\nif (param_val == 2) {\r\nmask |= MAX77620_FPS_ENFPS_SW_MASK;\r\nconfig |= MAX77620_FPS_ENFPS_SW;\r\n}\r\n}\r\nif (!chip->sleep_enable && !chip->enable_global_lpm) {\r\nret = of_property_read_u32(fps_np,\r\n"maxim,device-state-on-disabled-event",\r\n&param_val);\r\nif (!ret) {\r\nif (param_val == 0)\r\nchip->sleep_enable = true;\r\nelse if (param_val == 1)\r\nchip->enable_global_lpm = true;\r\n}\r\n}\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_FPS_CFG0 + fps_id,\r\nmask, config);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to update FPS CFG: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_initialise_fps(struct max77620_chip *chip)\r\n{\r\nstruct device *dev = chip->dev;\r\nstruct device_node *fps_np, *fps_child;\r\nu8 config;\r\nint fps_id;\r\nint ret;\r\nfor (fps_id = 0; fps_id < MAX77620_FPS_COUNT; fps_id++) {\r\nchip->shutdown_fps_period[fps_id] = -1;\r\nchip->suspend_fps_period[fps_id] = -1;\r\n}\r\nfps_np = of_get_child_by_name(dev->of_node, "fps");\r\nif (!fps_np)\r\ngoto skip_fps;\r\nfor_each_child_of_node(fps_np, fps_child) {\r\nret = max77620_config_fps(chip, fps_child);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nconfig = chip->enable_global_lpm ? MAX77620_ONOFFCNFG2_SLP_LPM_MSK : 0;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG2,\r\nMAX77620_ONOFFCNFG2_SLP_LPM_MSK, config);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to update SLP_LPM: %d\n", ret);\r\nreturn ret;\r\n}\r\nskip_fps:\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG2,\r\nMAX77620_ONOFFCNFG2_WK_EN0,\r\nMAX77620_ONOFFCNFG2_WK_EN0);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to update WK_EN0: %d\n", ret);\r\nreturn ret;\r\n}\r\nif ((chip->chip_id == MAX20024) && chip->sleep_enable) {\r\nconfig = MAX77620_ONOFFCNFG1_SLPEN | MAX20024_ONOFFCNFG1_CLRSE;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG1,\r\nconfig, config);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to update SLPEN: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_read_es_version(struct max77620_chip *chip)\r\n{\r\nunsigned int val;\r\nu8 cid_val[6];\r\nint i;\r\nint ret;\r\nfor (i = MAX77620_REG_CID0; i <= MAX77620_REG_CID5; i++) {\r\nret = regmap_read(chip->rmap, i, &val);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to read CID: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_dbg(chip->dev, "CID%d: 0x%02x\n",\r\ni - MAX77620_REG_CID0, val);\r\ncid_val[i - MAX77620_REG_CID0] = val;\r\n}\r\ndev_info(chip->dev, "PMIC Version OTP:0x%02X and ES:0x%X\n",\r\ncid_val[4], MAX77620_CID5_DIDM(cid_val[5]));\r\nreturn ret;\r\n}\r\nstatic int max77620_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nconst struct regmap_config *rmap_config;\r\nstruct max77620_chip *chip;\r\nconst struct mfd_cell *mfd_cells;\r\nint n_mfd_cells;\r\nint ret;\r\nchip = devm_kzalloc(&client->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, chip);\r\nchip->dev = &client->dev;\r\nchip->irq_base = -1;\r\nchip->chip_irq = client->irq;\r\nchip->chip_id = (enum max77620_chip_id)id->driver_data;\r\nswitch (chip->chip_id) {\r\ncase MAX77620:\r\nmfd_cells = max77620_children;\r\nn_mfd_cells = ARRAY_SIZE(max77620_children);\r\nrmap_config = &max77620_regmap_config;\r\nbreak;\r\ncase MAX20024:\r\nmfd_cells = max20024_children;\r\nn_mfd_cells = ARRAY_SIZE(max20024_children);\r\nrmap_config = &max20024_regmap_config;\r\nbreak;\r\ndefault:\r\ndev_err(chip->dev, "ChipID is invalid %d\n", chip->chip_id);\r\nreturn -EINVAL;\r\n}\r\nchip->rmap = devm_regmap_init_i2c(client, rmap_config);\r\nif (IS_ERR(chip->rmap)) {\r\nret = PTR_ERR(chip->rmap);\r\ndev_err(chip->dev, "Failed to initialise regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = max77620_read_es_version(chip);\r\nif (ret < 0)\r\nreturn ret;\r\nmax77620_top_irq_chip.irq_drv_data = chip;\r\nret = devm_regmap_add_irq_chip(chip->dev, chip->rmap, client->irq,\r\nIRQF_ONESHOT | IRQF_SHARED,\r\nchip->irq_base, &max77620_top_irq_chip,\r\n&chip->top_irq_data);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to add regmap irq: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = max77620_initialise_fps(chip);\r\nif (ret < 0)\r\nreturn ret;\r\nret = devm_mfd_add_devices(chip->dev, PLATFORM_DEVID_NONE,\r\nmfd_cells, n_mfd_cells, NULL, 0,\r\nregmap_irq_get_domain(chip->top_irq_data));\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to add MFD children: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_set_fps_period(struct max77620_chip *chip,\r\nint fps_id, int time_period)\r\n{\r\nint period = max77620_get_fps_period_reg_value(chip, time_period);\r\nint ret;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_FPS_CFG0 + fps_id,\r\nMAX77620_FPS_TIME_PERIOD_MASK,\r\nperiod << MAX77620_FPS_TIME_PERIOD_SHIFT);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to update FPS period: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_i2c_suspend(struct device *dev)\r\n{\r\nstruct max77620_chip *chip = dev_get_drvdata(dev);\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned int config;\r\nint fps;\r\nint ret;\r\nfor (fps = 0; fps < MAX77620_FPS_COUNT; fps++) {\r\nif (chip->suspend_fps_period[fps] < 0)\r\ncontinue;\r\nret = max77620_set_fps_period(chip, fps,\r\nchip->suspend_fps_period[fps]);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (chip->chip_id == MAX20024)\r\ngoto out;\r\nconfig = (chip->sleep_enable) ? MAX77620_ONOFFCNFG1_SLPEN : 0;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG1,\r\nMAX77620_ONOFFCNFG1_SLPEN,\r\nconfig);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to configure sleep in suspend: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG2,\r\nMAX77620_ONOFFCNFG2_WK_EN0, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to configure WK_EN in suspend: %d\n", ret);\r\nreturn ret;\r\n}\r\nout:\r\ndisable_irq(client->irq);\r\nreturn 0;\r\n}\r\nstatic int max77620_i2c_resume(struct device *dev)\r\n{\r\nstruct max77620_chip *chip = dev_get_drvdata(dev);\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nint ret;\r\nint fps;\r\nfor (fps = 0; fps < MAX77620_FPS_COUNT; fps++) {\r\nif (chip->shutdown_fps_period[fps] < 0)\r\ncontinue;\r\nret = max77620_set_fps_period(chip, fps,\r\nchip->shutdown_fps_period[fps]);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (chip->chip_id == MAX20024)\r\ngoto out;\r\nret = regmap_update_bits(chip->rmap, MAX77620_REG_ONOFFCNFG2,\r\nMAX77620_ONOFFCNFG2_WK_EN0,\r\nMAX77620_ONOFFCNFG2_WK_EN0);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to configure WK_EN0 n resume: %d\n", ret);\r\nreturn ret;\r\n}\r\nout:\r\nenable_irq(client->irq);\r\nreturn 0;\r\n}

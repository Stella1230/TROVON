static int mcb_lpc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct priv *priv;\r\nint ret = 0;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!priv->mem) {\r\ndev_err(&pdev->dev, "No Memory resource\n");\r\nreturn -ENODEV;\r\n}\r\nres = devm_request_mem_region(&pdev->dev, priv->mem->start,\r\nresource_size(priv->mem),\r\nKBUILD_MODNAME);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to request IO memory\n");\r\nreturn -EBUSY;\r\n}\r\npriv->base = devm_ioremap(&pdev->dev, priv->mem->start,\r\nresource_size(priv->mem));\r\nif (!priv->base) {\r\ndev_err(&pdev->dev, "Cannot ioremap\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\npriv->bus = mcb_alloc_bus(&pdev->dev);\r\nif (IS_ERR(priv->bus))\r\nreturn PTR_ERR(priv->bus);\r\nret = chameleon_parse_cells(priv->bus, priv->mem->start, priv->base);\r\nif (ret < 0) {\r\nmcb_release_bus(priv->bus);\r\nreturn ret;\r\n}\r\ndev_dbg(&pdev->dev, "Found %d cells\n", ret);\r\nmcb_bus_add_devices(priv->bus);\r\nreturn 0;\r\n}\r\nstatic int mcb_lpc_remove(struct platform_device *pdev)\r\n{\r\nstruct priv *priv = platform_get_drvdata(pdev);\r\nmcb_release_bus(priv->bus);\r\nreturn 0;\r\n}\r\nstatic int mcb_lpc_create_platform_device(const struct dmi_system_id *id)\r\n{\r\nstruct resource *res = id->driver_data;\r\nint ret;\r\nmcb_lpc_pdev = platform_device_alloc("mcb-lpc", -1);\r\nif (!mcb_lpc_pdev)\r\nreturn -ENOMEM;\r\nret = platform_device_add_resources(mcb_lpc_pdev, res, 1);\r\nif (ret)\r\ngoto out_put;\r\nret = platform_device_add(mcb_lpc_pdev);\r\nif (ret)\r\ngoto out_put;\r\nreturn 0;\r\nout_put:\r\nplatform_device_put(mcb_lpc_pdev);\r\nreturn ret;\r\n}\r\nstatic int __init mcb_lpc_init(void)\r\n{\r\nif (!dmi_check_system(mcb_lpc_dmi_table))\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&mcb_lpc_driver);\r\n}\r\nstatic void __exit mcb_lpc_exit(void)\r\n{\r\nplatform_device_unregister(mcb_lpc_pdev);\r\nplatform_driver_unregister(&mcb_lpc_driver);\r\n}

static u8 clk_sam9260_slow_get_parent(struct clk_hw *hw)\r\n{\r\nstruct clk_sam9260_slow *slowck = to_clk_sam9260_slow(hw);\r\nunsigned int status;\r\nregmap_read(slowck->regmap, AT91_PMC_SR, &status);\r\nreturn status & AT91_PMC_OSCSEL ? 1 : 0;\r\n}\r\nstatic struct clk_hw * __init\r\nat91_clk_register_sam9260_slow(struct regmap *regmap,\r\nconst char *name,\r\nconst char **parent_names,\r\nint num_parents)\r\n{\r\nstruct clk_sam9260_slow *slowck;\r\nstruct clk_hw *hw;\r\nstruct clk_init_data init;\r\nint ret;\r\nif (!name)\r\nreturn ERR_PTR(-EINVAL);\r\nif (!parent_names || !num_parents)\r\nreturn ERR_PTR(-EINVAL);\r\nslowck = kzalloc(sizeof(*slowck), GFP_KERNEL);\r\nif (!slowck)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &sam9260_slow_ops;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num_parents;\r\ninit.flags = 0;\r\nslowck->hw.init = &init;\r\nslowck->regmap = regmap;\r\nhw = &slowck->hw;\r\nret = clk_hw_register(NULL, &slowck->hw);\r\nif (ret) {\r\nkfree(slowck);\r\nhw = ERR_PTR(ret);\r\n}\r\nreturn hw;\r\n}\r\nstatic void __init of_at91sam9260_clk_slow_setup(struct device_node *np)\r\n{\r\nstruct clk_hw *hw;\r\nconst char *parent_names[2];\r\nunsigned int num_parents;\r\nconst char *name = np->name;\r\nstruct regmap *regmap;\r\nnum_parents = of_clk_get_parent_count(np);\r\nif (num_parents != 2)\r\nreturn;\r\nof_clk_parent_fill(np, parent_names, num_parents);\r\nregmap = syscon_node_to_regmap(of_get_parent(np));\r\nif (IS_ERR(regmap))\r\nreturn;\r\nof_property_read_string(np, "clock-output-names", &name);\r\nhw = at91_clk_register_sam9260_slow(regmap, name, parent_names,\r\nnum_parents);\r\nif (IS_ERR(hw))\r\nreturn;\r\nof_clk_add_hw_provider(np, of_clk_hw_simple_get, hw);\r\n}

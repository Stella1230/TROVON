static int snd_card_emu10k1_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nstruct snd_emu10k1 *emu;\r\n#ifdef ENABLE_SYNTH\r\nstruct snd_seq_device *wave = NULL;\r\n#endif\r\nint err;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_new(&pci->dev, index[dev], id[dev], THIS_MODULE,\r\n0, &card);\r\nif (err < 0)\r\nreturn err;\r\nif (max_buffer_size[dev] < 32)\r\nmax_buffer_size[dev] = 32;\r\nelse if (max_buffer_size[dev] > 1024)\r\nmax_buffer_size[dev] = 1024;\r\nif ((err = snd_emu10k1_create(card, pci, extin[dev], extout[dev],\r\n(long)max_buffer_size[dev] * 1024 * 1024,\r\nenable_ir[dev], subsystem[dev],\r\n&emu)) < 0)\r\ngoto error;\r\ncard->private_data = emu;\r\nemu->delay_pcm_irq = delay_pcm_irq[dev] & 0x1f;\r\nif ((err = snd_emu10k1_pcm(emu, 0)) < 0)\r\ngoto error;\r\nif ((err = snd_emu10k1_pcm_mic(emu, 1)) < 0)\r\ngoto error;\r\nif ((err = snd_emu10k1_pcm_efx(emu, 2)) < 0)\r\ngoto error;\r\nif (emu->card_capabilities->ca0151_chip) {\r\nif ((err = snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\n1024, &emu->p16v_buffer)) < 0)\r\ngoto error;\r\n}\r\nif ((err = snd_emu10k1_mixer(emu, 0, 3)) < 0)\r\ngoto error;\r\nif ((err = snd_emu10k1_timer(emu, 0)) < 0)\r\ngoto error;\r\nif ((err = snd_emu10k1_pcm_multi(emu, 3)) < 0)\r\ngoto error;\r\nif (emu->card_capabilities->ca0151_chip) {\r\nif ((err = snd_p16v_pcm(emu, 4)) < 0)\r\ngoto error;\r\n}\r\nif (emu->audigy) {\r\nif ((err = snd_emu10k1_audigy_midi(emu)) < 0)\r\ngoto error;\r\n} else {\r\nif ((err = snd_emu10k1_midi(emu)) < 0)\r\ngoto error;\r\n}\r\nif ((err = snd_emu10k1_fx8010_new(emu, 0)) < 0)\r\ngoto error;\r\n#ifdef ENABLE_SYNTH\r\nif (snd_seq_device_new(card, 1, SNDRV_SEQ_DEV_ID_EMU10K1_SYNTH,\r\nsizeof(struct snd_emu10k1_synth_arg), &wave) < 0 ||\r\nwave == NULL) {\r\ndev_warn(emu->card->dev,\r\n"can't initialize Emu10k1 wavetable synth\n");\r\n} else {\r\nstruct snd_emu10k1_synth_arg *arg;\r\narg = SNDRV_SEQ_DEVICE_ARGPTR(wave);\r\nstrcpy(wave->name, "Emu-10k1 Synth");\r\narg->hwptr = emu;\r\narg->index = 1;\r\narg->seq_ports = seq_ports[dev];\r\narg->max_voices = max_synth_voices[dev];\r\n}\r\n#endif\r\nstrlcpy(card->driver, emu->card_capabilities->driver,\r\nsizeof(card->driver));\r\nstrlcpy(card->shortname, emu->card_capabilities->name,\r\nsizeof(card->shortname));\r\nsnprintf(card->longname, sizeof(card->longname),\r\n"%s (rev.%d, serial:0x%x) at 0x%lx, irq %i",\r\ncard->shortname, emu->revision, emu->serial, emu->port, emu->irq);\r\nif ((err = snd_card_register(card)) < 0)\r\ngoto error;\r\nif (emu->card_capabilities->emu_model)\r\nschedule_delayed_work(&emu->emu1010.firmware_work, 0);\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\nerror:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic void snd_card_emu10k1_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\n}\r\nstatic int snd_emu10k1_suspend(struct device *dev)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_emu10k1 *emu = card->private_data;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nemu->suspend = 1;\r\ncancel_delayed_work_sync(&emu->emu1010.firmware_work);\r\nsnd_pcm_suspend_all(emu->pcm);\r\nsnd_pcm_suspend_all(emu->pcm_mic);\r\nsnd_pcm_suspend_all(emu->pcm_efx);\r\nsnd_pcm_suspend_all(emu->pcm_multi);\r\nsnd_pcm_suspend_all(emu->pcm_p16v);\r\nsnd_ac97_suspend(emu->ac97);\r\nsnd_emu10k1_efx_suspend(emu);\r\nsnd_emu10k1_suspend_regs(emu);\r\nif (emu->card_capabilities->ca0151_chip)\r\nsnd_p16v_suspend(emu);\r\nsnd_emu10k1_done(emu);\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_resume(struct device *dev)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_emu10k1 *emu = card->private_data;\r\nsnd_emu10k1_resume_init(emu);\r\nsnd_emu10k1_efx_resume(emu);\r\nsnd_ac97_resume(emu->ac97);\r\nsnd_emu10k1_resume_regs(emu);\r\nif (emu->card_capabilities->ca0151_chip)\r\nsnd_p16v_resume(emu);\r\nemu->suspend = 0;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nif (emu->card_capabilities->emu_model)\r\nschedule_delayed_work(&emu->emu1010.firmware_work, 0);\r\nreturn 0;\r\n}

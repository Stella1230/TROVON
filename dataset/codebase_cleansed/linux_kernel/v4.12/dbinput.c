static u8\r\nacpi_db_match_command_help(const char *command,\r\nconst struct acpi_db_command_help *help)\r\n{\r\nchar *invocation = help->invocation;\r\nu32 line_count;\r\nif (*invocation != ' ') {\r\nreturn (FALSE);\r\n}\r\nwhile (*invocation == ' ') {\r\ninvocation++;\r\n}\r\nwhile ((*command) && (*invocation) && (*invocation != ' ')) {\r\nif (tolower((int)*command) != tolower((int)*invocation)) {\r\nreturn (FALSE);\r\n}\r\ninvocation++;\r\ncommand++;\r\n}\r\nline_count = help->line_count;\r\nwhile (line_count) {\r\nacpi_os_printf("%-38s : %s", help->invocation,\r\nhelp->description);\r\nhelp++;\r\nline_count--;\r\n}\r\nreturn (TRUE);\r\n}\r\nstatic void acpi_db_display_command_info(const char *command, u8 display_all)\r\n{\r\nconst struct acpi_db_command_help *next;\r\nu8 matched;\r\nnext = acpi_gbl_db_command_help;\r\nwhile (next->invocation) {\r\nmatched = acpi_db_match_command_help(command, next);\r\nif (!display_all && matched) {\r\nreturn;\r\n}\r\nnext++;\r\n}\r\n}\r\nstatic void acpi_db_display_help(char *command)\r\n{\r\nconst struct acpi_db_command_help *next = acpi_gbl_db_command_help;\r\nif (!command) {\r\nwhile (next->invocation) {\r\nacpi_os_printf("%-38s%s", next->invocation,\r\nnext->description);\r\nnext++;\r\n}\r\n} else {\r\nacpi_db_display_command_info(command, TRUE);\r\n}\r\n}\r\nchar *acpi_db_get_next_token(char *string,\r\nchar **next, acpi_object_type *return_type)\r\n{\r\nchar *start;\r\nu32 depth;\r\nacpi_object_type type = ACPI_TYPE_INTEGER;\r\nif (!string || !(*string)) {\r\nreturn (NULL);\r\n}\r\nif (*string == ' ') {\r\nwhile (*string && (*string == ' ')) {\r\nstring++;\r\n}\r\nif (!(*string)) {\r\nreturn (NULL);\r\n}\r\n}\r\nswitch (*string) {\r\ncase '"':\r\nstring++;\r\nstart = string;\r\ntype = ACPI_TYPE_STRING;\r\nwhile (*string && (*string != '"')) {\r\nstring++;\r\n}\r\nbreak;\r\ncase '(':\r\nstring++;\r\nstart = string;\r\ntype = ACPI_TYPE_BUFFER;\r\nwhile (*string && (*string != ')')) {\r\nstring++;\r\n}\r\nbreak;\r\ncase '[':\r\nstring++;\r\ndepth = 1;\r\nstart = string;\r\ntype = ACPI_TYPE_PACKAGE;\r\nwhile (*string) {\r\nif (*string == '"') {\r\nstring++;\r\nwhile (*string && (*string != '"')) {\r\nstring++;\r\n}\r\nif (!(*string)) {\r\nbreak;\r\n}\r\n} else if (*string == '[') {\r\ndepth++;\r\n} else if (*string == ']') {\r\ndepth--;\r\nif (depth == 0) {\r\nbreak;\r\n}\r\n}\r\nstring++;\r\n}\r\nbreak;\r\ndefault:\r\nstart = string;\r\nwhile (*string && (*string != ' ')) {\r\nstring++;\r\n}\r\nbreak;\r\n}\r\nif (!(*string)) {\r\n*next = NULL;\r\n} else {\r\n*string = 0;\r\n*next = string + 1;\r\n}\r\n*return_type = type;\r\nreturn (start);\r\n}\r\nstatic u32 acpi_db_get_line(char *input_buffer)\r\n{\r\nu32 i;\r\nu32 count;\r\nchar *next;\r\nchar *this;\r\nif (acpi_ut_safe_strcpy\r\n(acpi_gbl_db_parsed_buf, sizeof(acpi_gbl_db_parsed_buf),\r\ninput_buffer)) {\r\nacpi_os_printf\r\n("Buffer overflow while parsing input line (max %u characters)\n",\r\nsizeof(acpi_gbl_db_parsed_buf));\r\nreturn (0);\r\n}\r\nthis = acpi_gbl_db_parsed_buf;\r\nfor (i = 0; i < ACPI_DEBUGGER_MAX_ARGS; i++) {\r\nacpi_gbl_db_args[i] = acpi_db_get_next_token(this, &next,\r\n&acpi_gbl_db_arg_types\r\n[i]);\r\nif (!acpi_gbl_db_args[i]) {\r\nbreak;\r\n}\r\nthis = next;\r\n}\r\nacpi_ut_strupr(acpi_gbl_db_args[0]);\r\ncount = i;\r\nif (count) {\r\ncount--;\r\n}\r\nreturn (count);\r\n}\r\nstatic u32 acpi_db_match_command(char *user_command)\r\n{\r\nu32 i;\r\nif (!user_command || user_command[0] == 0) {\r\nreturn (CMD_NULL);\r\n}\r\nfor (i = CMD_FIRST_VALID; acpi_gbl_db_commands[i].name; i++) {\r\nif (strstr\r\n(ACPI_CAST_PTR(char, acpi_gbl_db_commands[i].name),\r\nuser_command) == acpi_gbl_db_commands[i].name) {\r\nreturn (i);\r\n}\r\n}\r\nreturn (CMD_NOT_FOUND);\r\n}\r\nacpi_status\r\nacpi_db_command_dispatch(char *input_buffer,\r\nstruct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nu32 temp;\r\nu32 command_index;\r\nu32 param_count;\r\nchar *command_line;\r\nacpi_status status = AE_CTRL_TRUE;\r\nif (acpi_gbl_db_terminate_loop) {\r\nreturn (AE_CTRL_TERMINATE);\r\n}\r\nparam_count = acpi_db_get_line(input_buffer);\r\ncommand_index = acpi_db_match_command(acpi_gbl_db_args[0]);\r\ntemp = 0;\r\nif (command_index != CMD_HISTORY_LAST) {\r\nacpi_db_add_to_history(input_buffer);\r\n}\r\nif (param_count < acpi_gbl_db_commands[command_index].min_args) {\r\nacpi_os_printf\r\n("%u parameters entered, [%s] requires %u parameters\n",\r\nparam_count, acpi_gbl_db_commands[command_index].name,\r\nacpi_gbl_db_commands[command_index].min_args);\r\nacpi_db_display_command_info(acpi_gbl_db_commands\r\n[command_index].name, FALSE);\r\nreturn (AE_CTRL_TRUE);\r\n}\r\nswitch (command_index) {\r\ncase CMD_NULL:\r\nif (op) {\r\nreturn (AE_OK);\r\n}\r\nbreak;\r\ncase CMD_ALLOCATIONS:\r\n#ifdef ACPI_DBG_TRACK_ALLOCATIONS\r\nacpi_ut_dump_allocations((u32)-1, NULL);\r\n#endif\r\nbreak;\r\ncase CMD_ARGS:\r\ncase CMD_ARGUMENTS:\r\nacpi_db_display_arguments();\r\nbreak;\r\ncase CMD_BREAKPOINT:\r\nacpi_db_set_method_breakpoint(acpi_gbl_db_args[1], walk_state,\r\nop);\r\nbreak;\r\ncase CMD_BUSINFO:\r\nacpi_db_get_bus_info();\r\nbreak;\r\ncase CMD_CALL:\r\nacpi_db_set_method_call_breakpoint(op);\r\nstatus = AE_OK;\r\nbreak;\r\ncase CMD_DEBUG:\r\nacpi_db_execute(acpi_gbl_db_args[1],\r\n&acpi_gbl_db_args[2], &acpi_gbl_db_arg_types[2],\r\nEX_SINGLE_STEP);\r\nbreak;\r\ncase CMD_DISASSEMBLE:\r\ncase CMD_DISASM:\r\n(void)acpi_db_disassemble_method(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_DUMP:\r\nacpi_db_decode_and_display_object(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_EVALUATE:\r\ncase CMD_EXECUTE:\r\nacpi_db_execute(acpi_gbl_db_args[1],\r\n&acpi_gbl_db_args[2], &acpi_gbl_db_arg_types[2],\r\nEX_NO_SINGLE_STEP);\r\nbreak;\r\ncase CMD_FIND:\r\nstatus = acpi_db_find_name_in_namespace(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_GO:\r\nacpi_gbl_cm_single_step = FALSE;\r\nreturn (AE_OK);\r\ncase CMD_HANDLERS:\r\nacpi_db_display_handlers();\r\nbreak;\r\ncase CMD_HELP:\r\ncase CMD_HELP2:\r\nacpi_db_display_help(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_HISTORY:\r\nacpi_db_display_history();\r\nbreak;\r\ncase CMD_HISTORY_EXE:\r\ncommand_line = acpi_db_get_from_history(acpi_gbl_db_args[1]);\r\nif (!command_line) {\r\nreturn (AE_CTRL_TRUE);\r\n}\r\nstatus = acpi_db_command_dispatch(command_line, walk_state, op);\r\nreturn (status);\r\ncase CMD_HISTORY_LAST:\r\ncommand_line = acpi_db_get_from_history(NULL);\r\nif (!command_line) {\r\nreturn (AE_CTRL_TRUE);\r\n}\r\nstatus = acpi_db_command_dispatch(command_line, walk_state, op);\r\nreturn (status);\r\ncase CMD_INFORMATION:\r\nacpi_db_display_method_info(op);\r\nbreak;\r\ncase CMD_INTEGRITY:\r\nacpi_db_check_integrity();\r\nbreak;\r\ncase CMD_INTO:\r\nif (op) {\r\nacpi_gbl_cm_single_step = TRUE;\r\nreturn (AE_OK);\r\n}\r\nbreak;\r\ncase CMD_LEVEL:\r\nif (param_count == 0) {\r\nacpi_os_printf\r\n("Current debug level for file output is: %8.8lX\n",\r\nacpi_gbl_db_debug_level);\r\nacpi_os_printf\r\n("Current debug level for console output is: %8.8lX\n",\r\nacpi_gbl_db_console_debug_level);\r\n} else if (param_count == 2) {\r\ntemp = acpi_gbl_db_console_debug_level;\r\nacpi_gbl_db_console_debug_level =\r\nstrtoul(acpi_gbl_db_args[1], NULL, 16);\r\nacpi_os_printf\r\n("Debug Level for console output was %8.8lX, now %8.8lX\n",\r\ntemp, acpi_gbl_db_console_debug_level);\r\n} else {\r\ntemp = acpi_gbl_db_debug_level;\r\nacpi_gbl_db_debug_level =\r\nstrtoul(acpi_gbl_db_args[1], NULL, 16);\r\nacpi_os_printf\r\n("Debug Level for file output was %8.8lX, now %8.8lX\n",\r\ntemp, acpi_gbl_db_debug_level);\r\n}\r\nbreak;\r\ncase CMD_LIST:\r\nacpi_db_disassemble_aml(acpi_gbl_db_args[1], op);\r\nbreak;\r\ncase CMD_LOCKS:\r\nacpi_db_display_locks();\r\nbreak;\r\ncase CMD_LOCALS:\r\nacpi_db_display_locals();\r\nbreak;\r\ncase CMD_METHODS:\r\nstatus = acpi_db_display_objects("METHOD", acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_NAMESPACE:\r\nacpi_db_dump_namespace(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_NOTIFY:\r\ntemp = strtoul(acpi_gbl_db_args[2], NULL, 0);\r\nacpi_db_send_notify(acpi_gbl_db_args[1], temp);\r\nbreak;\r\ncase CMD_OBJECTS:\r\nacpi_ut_strupr(acpi_gbl_db_args[1]);\r\nstatus =\r\nacpi_db_display_objects(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_OSI:\r\nacpi_db_display_interfaces(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_OWNER:\r\nacpi_db_dump_namespace_by_owner(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_PATHS:\r\nacpi_db_dump_namespace_paths();\r\nbreak;\r\ncase CMD_PREFIX:\r\nacpi_db_set_scope(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_REFERENCES:\r\nacpi_db_find_references(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_RESOURCES:\r\nacpi_db_display_resources(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_RESULTS:\r\nacpi_db_display_results();\r\nbreak;\r\ncase CMD_SET:\r\nacpi_db_set_method_data(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2],\r\nacpi_gbl_db_args[3]);\r\nbreak;\r\ncase CMD_STATS:\r\nstatus = acpi_db_display_statistics(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_STOP:\r\nreturn (AE_NOT_IMPLEMENTED);\r\ncase CMD_TABLES:\r\nacpi_db_display_table_info(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_TEMPLATE:\r\nacpi_db_display_template(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_TRACE:\r\nacpi_db_trace(acpi_gbl_db_args[1], acpi_gbl_db_args[2],\r\nacpi_gbl_db_args[3]);\r\nbreak;\r\ncase CMD_TREE:\r\nacpi_db_display_calling_tree();\r\nbreak;\r\ncase CMD_TYPE:\r\nacpi_db_display_object_type(acpi_gbl_db_args[1]);\r\nbreak;\r\n#ifdef ACPI_APPLICATION\r\ncase CMD_ENABLEACPI:\r\n#if (!ACPI_REDUCED_HARDWARE)\r\nstatus = acpi_enable();\r\nif (ACPI_FAILURE(status)) {\r\nacpi_os_printf("AcpiEnable failed (Status=%X)\n",\r\nstatus);\r\nreturn (status);\r\n}\r\n#endif\r\nbreak;\r\ncase CMD_EVENT:\r\nacpi_os_printf("Event command not implemented\n");\r\nbreak;\r\ncase CMD_GPE:\r\nacpi_db_generate_gpe(acpi_gbl_db_args[1], acpi_gbl_db_args[2]);\r\nbreak;\r\ncase CMD_GPES:\r\nacpi_db_display_gpes();\r\nbreak;\r\ncase CMD_SCI:\r\nacpi_db_generate_sci();\r\nbreak;\r\ncase CMD_SLEEP:\r\nstatus = acpi_db_sleep(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_CLOSE:\r\nacpi_db_close_debug_file();\r\nbreak;\r\ncase CMD_LOAD:{\r\nstruct acpi_new_table_desc *list_head = NULL;\r\nstatus =\r\nac_get_all_tables_from_file(acpi_gbl_db_args[1],\r\nACPI_GET_ALL_TABLES,\r\n&list_head);\r\nif (ACPI_SUCCESS(status)) {\r\nacpi_db_load_tables(list_head);\r\n}\r\n}\r\nbreak;\r\ncase CMD_OPEN:\r\nacpi_db_open_debug_file(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_TERMINATE:\r\nacpi_db_set_output_destination(ACPI_DB_REDIRECTABLE_OUTPUT);\r\nacpi_ut_subsystem_shutdown();\r\nacpi_gbl_db_terminate_loop = TRUE;\r\nbreak;\r\ncase CMD_THREADS:\r\nacpi_db_create_execution_threads(acpi_gbl_db_args[1],\r\nacpi_gbl_db_args[2],\r\nacpi_gbl_db_args[3]);\r\nbreak;\r\ncase CMD_PREDEFINED:\r\nacpi_db_check_predefined_names();\r\nbreak;\r\ncase CMD_TEST:\r\nacpi_db_execute_test(acpi_gbl_db_args[1]);\r\nbreak;\r\ncase CMD_UNLOAD:\r\nacpi_db_unload_acpi_table(acpi_gbl_db_args[1]);\r\nbreak;\r\n#endif\r\ncase CMD_EXIT:\r\ncase CMD_QUIT:\r\nif (op) {\r\nacpi_os_printf("Method execution terminated\n");\r\nreturn (AE_CTRL_TERMINATE);\r\n}\r\nif (!acpi_gbl_db_output_to_file) {\r\nacpi_dbg_level = ACPI_DEBUG_DEFAULT;\r\n}\r\n#ifdef ACPI_APPLICATION\r\nacpi_db_close_debug_file();\r\n#endif\r\nacpi_gbl_db_terminate_loop = TRUE;\r\nreturn (AE_CTRL_TERMINATE);\r\ncase CMD_NOT_FOUND:\r\ndefault:\r\nacpi_os_printf("%s: unknown command\n", acpi_gbl_db_args[0]);\r\nreturn (AE_CTRL_TRUE);\r\n}\r\nif (ACPI_SUCCESS(status)) {\r\nstatus = AE_CTRL_TRUE;\r\n}\r\nreturn (status);\r\n}\r\nvoid ACPI_SYSTEM_XFACE acpi_db_execute_thread(void *context)\r\n{\r\n(void)acpi_db_user_commands();\r\nacpi_gbl_db_threads_terminated = TRUE;\r\n}\r\nacpi_status acpi_db_user_commands(void)\r\n{\r\nacpi_status status = AE_OK;\r\nacpi_os_printf("\n");\r\nwhile (!acpi_gbl_db_terminate_loop) {\r\nstatus = acpi_os_wait_command_ready();\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\nacpi_gbl_method_executing = FALSE;\r\nacpi_gbl_step_to_next_call = FALSE;\r\n(void)acpi_db_command_dispatch(acpi_gbl_db_line_buf, NULL,\r\nNULL);\r\nstatus = acpi_os_notify_command_complete();\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\n}\r\nif (ACPI_FAILURE(status) && status != AE_CTRL_TERMINATE) {\r\nACPI_EXCEPTION((AE_INFO, status, "While parsing command line"));\r\n}\r\nreturn (status);\r\n}

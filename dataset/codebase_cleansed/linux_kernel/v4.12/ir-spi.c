static int ir_spi_tx(struct rc_dev *dev,\r\nunsigned int *buffer, unsigned int count)\r\n{\r\nint i;\r\nint ret;\r\nunsigned int len = 0;\r\nstruct ir_spi_data *idata = dev->priv;\r\nstruct spi_transfer xfer;\r\nfor (i = 0; i < count; i++) {\r\nint j;\r\nu16 val = ((i + 1) % 2) ? idata->pulse : idata->space;\r\nif (len + buffer[i] >= IR_SPI_MAX_BUFSIZE)\r\nreturn -EINVAL;\r\nval = (i % 2) ? idata->space : idata->pulse;\r\nfor (j = 0; j < buffer[i]; j++)\r\nidata->tx_buf[len++] = val;\r\n}\r\nmemset(&xfer, 0, sizeof(xfer));\r\nxfer.speed_hz = idata->freq;\r\nxfer.len = len * sizeof(*idata->tx_buf);\r\nxfer.tx_buf = idata->tx_buf;\r\nret = regulator_enable(idata->regulator);\r\nif (ret)\r\nreturn ret;\r\nret = spi_sync_transfer(idata->spi, &xfer, 1);\r\nif (ret)\r\ndev_err(&idata->spi->dev, "unable to deliver the signal\n");\r\nregulator_disable(idata->regulator);\r\nreturn ret ? ret : count;\r\n}\r\nstatic int ir_spi_set_tx_carrier(struct rc_dev *dev, u32 carrier)\r\n{\r\nstruct ir_spi_data *idata = dev->priv;\r\nif (!carrier)\r\nreturn -EINVAL;\r\nidata->freq = carrier;\r\nreturn 0;\r\n}\r\nstatic int ir_spi_set_duty_cycle(struct rc_dev *dev, u32 duty_cycle)\r\n{\r\nstruct ir_spi_data *idata = dev->priv;\r\nif (duty_cycle >= 90)\r\nidata->pulse = IR_SPI_PULSE_DC_90;\r\nelse if (duty_cycle >= 80)\r\nidata->pulse = IR_SPI_PULSE_DC_80;\r\nelse if (duty_cycle >= 75)\r\nidata->pulse = IR_SPI_PULSE_DC_75;\r\nelse if (duty_cycle >= 70)\r\nidata->pulse = IR_SPI_PULSE_DC_70;\r\nelse if (duty_cycle >= 60)\r\nidata->pulse = IR_SPI_PULSE_DC_60;\r\nelse\r\nidata->pulse = IR_SPI_PULSE_DC_50;\r\nif (idata->negated) {\r\nidata->pulse = ~idata->pulse;\r\nidata->space = 0xffff;\r\n} else {\r\nidata->space = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ir_spi_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nu8 dc;\r\nstruct ir_spi_data *idata;\r\nidata = devm_kzalloc(&spi->dev, sizeof(*idata), GFP_KERNEL);\r\nif (!idata)\r\nreturn -ENOMEM;\r\nidata->regulator = devm_regulator_get(&spi->dev, "irda_regulator");\r\nif (IS_ERR(idata->regulator))\r\nreturn PTR_ERR(idata->regulator);\r\nidata->rc = devm_rc_allocate_device(&spi->dev, RC_DRIVER_IR_RAW_TX);\r\nif (!idata->rc)\r\nreturn -ENOMEM;\r\nidata->rc->tx_ir = ir_spi_tx;\r\nidata->rc->s_tx_carrier = ir_spi_set_tx_carrier;\r\nidata->rc->s_tx_duty_cycle = ir_spi_set_duty_cycle;\r\nidata->rc->driver_name = IR_SPI_DRIVER_NAME;\r\nidata->rc->priv = idata;\r\nidata->spi = spi;\r\nidata->negated = of_property_read_bool(spi->dev.of_node,\r\n"led-active-low");\r\nret = of_property_read_u8(spi->dev.of_node, "duty-cycle", &dc);\r\nif (ret)\r\ndc = 50;\r\nir_spi_set_duty_cycle(idata->rc, dc);\r\nidata->freq = IR_SPI_DEFAULT_FREQUENCY;\r\nreturn devm_rc_register_device(&spi->dev, idata->rc);\r\n}\r\nstatic int ir_spi_remove(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}

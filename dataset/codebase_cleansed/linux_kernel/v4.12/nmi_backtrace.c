void nmi_trigger_cpumask_backtrace(const cpumask_t *mask,\r\nbool exclude_self,\r\nvoid (*raise)(cpumask_t *mask))\r\n{\r\nint i, this_cpu = get_cpu();\r\nif (test_and_set_bit(0, &backtrace_flag)) {\r\nput_cpu();\r\nreturn;\r\n}\r\ncpumask_copy(to_cpumask(backtrace_mask), mask);\r\nif (exclude_self)\r\ncpumask_clear_cpu(this_cpu, to_cpumask(backtrace_mask));\r\nif (cpumask_test_cpu(this_cpu, to_cpumask(backtrace_mask)))\r\nnmi_cpu_backtrace(NULL);\r\nif (!cpumask_empty(to_cpumask(backtrace_mask))) {\r\npr_info("Sending NMI from CPU %d to CPUs %*pbl:\n",\r\nthis_cpu, nr_cpumask_bits, to_cpumask(backtrace_mask));\r\nraise(to_cpumask(backtrace_mask));\r\n}\r\nfor (i = 0; i < 10 * 1000; i++) {\r\nif (cpumask_empty(to_cpumask(backtrace_mask)))\r\nbreak;\r\nmdelay(1);\r\ntouch_softlockup_watchdog();\r\n}\r\nprintk_safe_flush();\r\nclear_bit_unlock(0, &backtrace_flag);\r\nput_cpu();\r\n}\r\nbool nmi_cpu_backtrace(struct pt_regs *regs)\r\n{\r\nint cpu = smp_processor_id();\r\nif (cpumask_test_cpu(cpu, to_cpumask(backtrace_mask))) {\r\nif (regs && cpu_in_idle(instruction_pointer(regs))) {\r\npr_warn("NMI backtrace for cpu %d skipped: idling at pc %#lx\n",\r\ncpu, instruction_pointer(regs));\r\n} else {\r\npr_warn("NMI backtrace for cpu %d\n", cpu);\r\nif (regs)\r\nshow_regs(regs);\r\nelse\r\ndump_stack();\r\n}\r\ncpumask_clear_cpu(cpu, to_cpumask(backtrace_mask));\r\nreturn true;\r\n}\r\nreturn false;\r\n}

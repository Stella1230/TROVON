static void dsi_14nm_dphy_set_timing(struct msm_dsi_phy *phy,\r\nstruct msm_dsi_dphy_timing *timing,\r\nint lane_idx)\r\n{\r\nvoid __iomem *base = phy->lane_base;\r\nbool clk_ln = (lane_idx == PHY_14NM_CKLN_IDX);\r\nu32 zero = clk_ln ? timing->clk_zero : timing->hs_zero;\r\nu32 prepare = clk_ln ? timing->clk_prepare : timing->hs_prepare;\r\nu32 trail = clk_ln ? timing->clk_trail : timing->hs_trail;\r\nu32 rqst = clk_ln ? timing->hs_rqst_ckln : timing->hs_rqst;\r\nu32 prep_dly = clk_ln ? timing->hs_prep_dly_ckln : timing->hs_prep_dly;\r\nu32 halfbyte_en = clk_ln ? timing->hs_halfbyte_en_ckln :\r\ntiming->hs_halfbyte_en;\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_4(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_4_HS_EXIT(timing->hs_exit));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_5(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_5_HS_ZERO(zero));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_6(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_6_HS_PREPARE(prepare));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_7(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_7_HS_TRAIL(trail));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_8(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_8_HS_RQST(rqst));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_CFG0(lane_idx),\r\nDSI_14nm_PHY_LN_CFG0_PREPARE_DLY(prep_dly));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_CFG1(lane_idx),\r\nhalfbyte_en ? DSI_14nm_PHY_LN_CFG1_HALFBYTECLK_EN : 0);\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_9(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_9_TA_GO(timing->ta_go) |\r\nDSI_14nm_PHY_LN_TIMING_CTRL_9_TA_SURE(timing->ta_sure));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_10(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_10_TA_GET(timing->ta_get));\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_LN_TIMING_CTRL_11(lane_idx),\r\nDSI_14nm_PHY_LN_TIMING_CTRL_11_TRIG3_CMD(0xa0));\r\n}\r\nstatic int dsi_14nm_phy_enable(struct msm_dsi_phy *phy, int src_pll_id,\r\nstruct msm_dsi_phy_clk_request *clk_req)\r\n{\r\nstruct msm_dsi_dphy_timing *timing = &phy->timing;\r\nu32 data;\r\nint i;\r\nint ret;\r\nvoid __iomem *base = phy->base;\r\nvoid __iomem *lane_base = phy->lane_base;\r\nif (msm_dsi_dphy_timing_calc_v2(timing, clk_req)) {\r\ndev_err(&phy->pdev->dev,\r\n"%s: D-PHY timing calculation failed\n", __func__);\r\nreturn -EINVAL;\r\n}\r\ndata = 0x1c;\r\nif (phy->usecase != MSM_DSI_PHY_STANDALONE)\r\ndata |= DSI_14nm_PHY_CMN_LDO_CNTRL_VREG_CTRL(32);\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_LDO_CNTRL, data);\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_GLBL_TEST_CTRL, 0x1);\r\nfor (i = 0; i < 5; i++) {\r\ndsi_phy_write(lane_base + REG_DSI_14nm_PHY_LN_VREG_CNTRL(i),\r\n0x1d);\r\ndsi_phy_write(lane_base +\r\nREG_DSI_14nm_PHY_LN_STRENGTH_CTRL_0(i), 0xff);\r\ndsi_phy_write(lane_base +\r\nREG_DSI_14nm_PHY_LN_STRENGTH_CTRL_1(i),\r\n(i == PHY_14NM_CKLN_IDX) ? 0x00 : 0x06);\r\ndsi_phy_write(lane_base + REG_DSI_14nm_PHY_LN_CFG3(i),\r\n(i == PHY_14NM_CKLN_IDX) ? 0x8f : 0x0f);\r\ndsi_phy_write(lane_base + REG_DSI_14nm_PHY_LN_CFG2(i), 0x10);\r\ndsi_phy_write(lane_base + REG_DSI_14nm_PHY_LN_TEST_DATAPATH(i),\r\n0);\r\ndsi_phy_write(lane_base + REG_DSI_14nm_PHY_LN_TEST_STR(i),\r\n0x88);\r\ndsi_14nm_dphy_set_timing(phy, timing, i);\r\n}\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_PLL_CNTRL, 0x00);\r\nwmb();\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_CTRL_1, 0x80);\r\nwmb();\r\nudelay(100);\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_CTRL_1, 0x00);\r\nmsm_dsi_phy_set_src_pll(phy, src_pll_id,\r\nREG_DSI_14nm_PHY_CMN_GLBL_TEST_CTRL,\r\nDSI_14nm_PHY_CMN_GLBL_TEST_CTRL_BITCLK_HS_SEL);\r\nret = msm_dsi_pll_set_usecase(phy->pll, phy->usecase);\r\nif (ret) {\r\ndev_err(&phy->pdev->dev, "%s: set pll usecase failed, %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\ndsi_phy_write(base + REG_DSI_14nm_PHY_CMN_CTRL_0, 0xff);\r\nreturn 0;\r\n}\r\nstatic void dsi_14nm_phy_disable(struct msm_dsi_phy *phy)\r\n{\r\ndsi_phy_write(phy->base + REG_DSI_14nm_PHY_CMN_GLBL_TEST_CTRL, 0);\r\ndsi_phy_write(phy->base + REG_DSI_14nm_PHY_CMN_CTRL_0, 0);\r\nwmb();\r\n}\r\nstatic int dsi_14nm_phy_init(struct msm_dsi_phy *phy)\r\n{\r\nstruct platform_device *pdev = phy->pdev;\r\nphy->lane_base = msm_ioremap(pdev, "dsi_phy_lane",\r\n"DSI_PHY_LANE");\r\nif (IS_ERR(phy->lane_base)) {\r\ndev_err(&pdev->dev, "%s: failed to map phy lane base\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

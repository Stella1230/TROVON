static int\r\nwrite_reg(struct thermostat* th, int reg, u8 data)\r\n{\r\nu8 tmp[2];\r\nint rc;\r\ntmp[0] = reg;\r\ntmp[1] = data;\r\nrc = i2c_master_send(th->clt, (const char *)tmp, 2);\r\nif (rc < 0)\r\nreturn rc;\r\nif (rc != 2)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int\r\nread_reg(struct thermostat* th, int reg)\r\n{\r\nu8 reg_addr, data;\r\nint rc;\r\nreg_addr = (u8)reg;\r\nrc = i2c_master_send(th->clt, &reg_addr, 1);\r\nif (rc < 0)\r\nreturn rc;\r\nif (rc != 1)\r\nreturn -ENODEV;\r\nrc = i2c_master_recv(th->clt, (char *)&data, 1);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn data;\r\n}\r\nstatic int read_fan_speed(struct thermostat *th, u8 addr)\r\n{\r\nu8 tmp[2];\r\nu16 res;\r\ntmp[1] = read_reg(th, addr);\r\ntmp[0] = read_reg(th, addr + 1);\r\nres = tmp[1] + (tmp[0] << 8);\r\nreturn (res == 0xffff ? 0 : (90000*60)/res);\r\n}\r\nstatic void write_both_fan_speed(struct thermostat *th, int speed)\r\n{\r\nwrite_fan_speed(th, speed, 0);\r\nif (th->type == ADT7460)\r\nwrite_fan_speed(th, speed, 1);\r\n}\r\nstatic void write_fan_speed(struct thermostat *th, int speed, int fan)\r\n{\r\nu8 manual;\r\nif (speed > 0xff)\r\nspeed = 0xff;\r\nelse if (speed < -1)\r\nspeed = 0;\r\nif (th->type == ADT7467 && fan == 1)\r\nreturn;\r\nif (th->last_speed[fan] != speed) {\r\nif (verbose) {\r\nif (speed == -1)\r\nprintk(KERN_DEBUG "adt746x: Setting speed to automatic "\r\n"for %s fan.\n", sensor_location[fan+1]);\r\nelse\r\nprintk(KERN_DEBUG "adt746x: Setting speed to %d "\r\n"for %s fan.\n", speed, sensor_location[fan+1]);\r\n}\r\n} else\r\nreturn;\r\nif (speed >= 0) {\r\nmanual = read_reg(th, MANUAL_MODE[fan]);\r\nmanual &= ~INVERT_MASK;\r\nwrite_reg(th, MANUAL_MODE[fan],\r\nmanual | MANUAL_MASK | th->pwm_inv[fan]);\r\nwrite_reg(th, FAN_SPD_SET[fan], speed);\r\n} else {\r\nif(th->type == ADT7460) {\r\nmanual = read_reg(th,\r\nMANUAL_MODE[fan]) & (~MANUAL_MASK);\r\nmanual &= ~INVERT_MASK;\r\nmanual |= th->pwm_inv[fan];\r\nwrite_reg(th,\r\nMANUAL_MODE[fan], manual|REM_CONTROL[fan]);\r\n} else {\r\nmanual = read_reg(th, MANUAL_MODE[fan]);\r\nmanual &= ~INVERT_MASK;\r\nmanual |= th->pwm_inv[fan];\r\nwrite_reg(th, MANUAL_MODE[fan], manual&(~AUTO_MASK));\r\n}\r\n}\r\nth->last_speed[fan] = speed;\r\n}\r\nstatic void read_sensors(struct thermostat *th)\r\n{\r\nint i = 0;\r\nfor (i = 0; i < 3; i++)\r\nth->temps[i] = read_reg(th, TEMP_REG[i]);\r\n}\r\nstatic void display_stats(struct thermostat *th)\r\n{\r\nif (th->temps[0] != th->cached_temp[0]\r\n|| th->temps[1] != th->cached_temp[1]\r\n|| th->temps[2] != th->cached_temp[2]) {\r\nprintk(KERN_INFO "adt746x: Temperature infos:"\r\n" thermostats: %d,%d,%d;"\r\n" limits: %d,%d,%d;"\r\n" fan speed: %d RPM\n",\r\nth->temps[0], th->temps[1], th->temps[2],\r\nth->limits[0], th->limits[1], th->limits[2],\r\nread_fan_speed(th, FAN_SPEED[0]));\r\n}\r\nth->cached_temp[0] = th->temps[0];\r\nth->cached_temp[1] = th->temps[1];\r\nth->cached_temp[2] = th->temps[2];\r\n}\r\nstatic void update_fans_speed (struct thermostat *th)\r\n{\r\nint lastvar = 0;\r\nint i = 0;\r\nfor (i = 1; i < 3; i++) {\r\nint started = 0;\r\nint fan_number = (th->type == ADT7460 && i == 2);\r\nint var = th->temps[i] - th->limits[i];\r\nif (var > -1) {\r\nint step = (255 - fan_speed) / 7;\r\nint new_speed = 0;\r\nif (abs(var - th->last_var[fan_number]) < 2)\r\ncontinue;\r\nstarted = 1;\r\nnew_speed = fan_speed + ((var-1)*step);\r\nif (new_speed < fan_speed)\r\nnew_speed = fan_speed;\r\nif (new_speed > 255)\r\nnew_speed = 255;\r\nif (verbose)\r\nprintk(KERN_DEBUG "adt746x: Setting fans speed to %d "\r\n"(limit exceeded by %d on %s)\n",\r\nnew_speed, var,\r\nsensor_location[fan_number+1]);\r\nwrite_both_fan_speed(th, new_speed);\r\nth->last_var[fan_number] = var;\r\n} else if (var < -2) {\r\nif (i == 2 && lastvar < -1) {\r\nif (th->last_speed[fan_number] != 0)\r\nif (verbose)\r\nprintk(KERN_DEBUG "adt746x: Stopping "\r\n"fans.\n");\r\nwrite_both_fan_speed(th, 0);\r\n}\r\n}\r\nlastvar = var;\r\nif (started)\r\nreturn;\r\n}\r\n}\r\nstatic int monitor_task(void *arg)\r\n{\r\nstruct thermostat* th = arg;\r\nset_freezable();\r\nwhile(!kthread_should_stop()) {\r\ntry_to_freeze();\r\nmsleep_interruptible(2000);\r\n#ifndef DEBUG\r\nif (fan_speed != -1)\r\nread_sensors(th);\r\n#else\r\nread_sensors(th);\r\n#endif\r\nif (fan_speed != -1)\r\nupdate_fans_speed(th);\r\n#ifdef DEBUG\r\ndisplay_stats(th);\r\n#endif\r\n}\r\nreturn 0;\r\n}\r\nstatic void set_limit(struct thermostat *th, int i)\r\n{\r\nth->limits[i] = default_limits_chip[i] + limit_adjust;\r\nwrite_reg(th, LIMIT_REG[i], th->limits[i]);\r\nth->limits[i] = default_limits_local[i] + limit_adjust;\r\n}\r\nstatic void thermostat_create_files(struct thermostat *th)\r\n{\r\nstruct device_node *np = th->clt->dev.of_node;\r\nstruct device *dev;\r\nint err;\r\nth->pdev = of_platform_device_create(np, "temperatures", NULL);\r\nif (!th->pdev)\r\nreturn;\r\ndev = &th->pdev->dev;\r\ndev_set_drvdata(dev, th);\r\nerr = device_create_file(dev, &dev_attr_sensor1_temperature);\r\nerr |= device_create_file(dev, &dev_attr_sensor2_temperature);\r\nerr |= device_create_file(dev, &dev_attr_sensor1_limit);\r\nerr |= device_create_file(dev, &dev_attr_sensor2_limit);\r\nerr |= device_create_file(dev, &dev_attr_sensor1_location);\r\nerr |= device_create_file(dev, &dev_attr_sensor2_location);\r\nerr |= device_create_file(dev, &dev_attr_limit_adjust);\r\nerr |= device_create_file(dev, &dev_attr_specified_fan_speed);\r\nerr |= device_create_file(dev, &dev_attr_sensor1_fan_speed);\r\nif(th->type == ADT7460)\r\nerr |= device_create_file(dev, &dev_attr_sensor2_fan_speed);\r\nif (err)\r\nprintk(KERN_WARNING\r\n"Failed to create temperature attribute file(s).\n");\r\n}\r\nstatic void thermostat_remove_files(struct thermostat *th)\r\n{\r\nstruct device *dev;\r\nif (!th->pdev)\r\nreturn;\r\ndev = &th->pdev->dev;\r\ndevice_remove_file(dev, &dev_attr_sensor1_temperature);\r\ndevice_remove_file(dev, &dev_attr_sensor2_temperature);\r\ndevice_remove_file(dev, &dev_attr_sensor1_limit);\r\ndevice_remove_file(dev, &dev_attr_sensor2_limit);\r\ndevice_remove_file(dev, &dev_attr_sensor1_location);\r\ndevice_remove_file(dev, &dev_attr_sensor2_location);\r\ndevice_remove_file(dev, &dev_attr_limit_adjust);\r\ndevice_remove_file(dev, &dev_attr_specified_fan_speed);\r\ndevice_remove_file(dev, &dev_attr_sensor1_fan_speed);\r\nif (th->type == ADT7460)\r\ndevice_remove_file(dev, &dev_attr_sensor2_fan_speed);\r\nof_device_unregister(th->pdev);\r\n}\r\nstatic int probe_thermostat(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device_node *np = client->dev.of_node;\r\nstruct thermostat* th;\r\nconst __be32 *prop;\r\nint i, rc, vers, offset = 0;\r\nif (!np)\r\nreturn -ENXIO;\r\nprop = of_get_property(np, "hwsensor-params-version", NULL);\r\nif (!prop)\r\nreturn -ENXIO;\r\nvers = be32_to_cpup(prop);\r\nprintk(KERN_INFO "adt746x: version %d (%ssupported)\n",\r\nvers, vers == 1 ? "" : "un");\r\nif (vers != 1)\r\nreturn -ENXIO;\r\nif (of_get_property(np, "hwsensor-location", NULL)) {\r\nfor (i = 0; i < 3; i++) {\r\nsensor_location[i] = of_get_property(np,\r\n"hwsensor-location", NULL) + offset;\r\nif (sensor_location[i] == NULL)\r\nsensor_location[i] = "";\r\nprintk(KERN_INFO "sensor %d: %s\n", i, sensor_location[i]);\r\noffset += strlen(sensor_location[i]) + 1;\r\n}\r\n}\r\nth = kzalloc(sizeof(struct thermostat), GFP_KERNEL);\r\nif (!th)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, th);\r\nth->clt = client;\r\nth->type = id->driver_data;\r\nrc = read_reg(th, CONFIG_REG);\r\nif (rc < 0) {\r\ndev_err(&client->dev, "Thermostat failed to read config!\n");\r\nkfree(th);\r\nreturn -ENODEV;\r\n}\r\nif (fan_speed == -1)\r\nfan_speed = 64;\r\nif (th->type == ADT7460) {\r\nprintk(KERN_INFO "adt746x: ADT7460 initializing\n");\r\nwrite_reg(th, CONFIG_REG, 1);\r\n} else\r\nprintk(KERN_INFO "adt746x: ADT7467 initializing\n");\r\nfor (i = 0; i < 3; i++) {\r\nth->initial_limits[i] = read_reg(th, LIMIT_REG[i]);\r\nset_limit(th, i);\r\n}\r\nprintk(KERN_INFO "adt746x: Lowering max temperatures from %d, %d, %d"\r\n" to %d, %d, %d\n",\r\nth->initial_limits[0], th->initial_limits[1],\r\nth->initial_limits[2], th->limits[0], th->limits[1],\r\nth->limits[2]);\r\nth->pwm_inv[0] = read_reg(th, MANUAL_MODE[0]) & INVERT_MASK;\r\nth->pwm_inv[1] = read_reg(th, MANUAL_MODE[1]) & INVERT_MASK;\r\nth->last_speed[0] = -2;\r\nth->last_speed[1] = -2;\r\nth->last_var[0] = -80;\r\nth->last_var[1] = -80;\r\nif (fan_speed != -1) {\r\nwrite_both_fan_speed(th, 0);\r\n} else {\r\nwrite_both_fan_speed(th, -1);\r\n}\r\nth->thread = kthread_run(monitor_task, th, "kfand");\r\nif (th->thread == ERR_PTR(-ENOMEM)) {\r\nprintk(KERN_INFO "adt746x: Kthread creation failed\n");\r\nth->thread = NULL;\r\nreturn -ENOMEM;\r\n}\r\nthermostat_create_files(th);\r\nreturn 0;\r\n}\r\nstatic int remove_thermostat(struct i2c_client *client)\r\n{\r\nstruct thermostat *th = i2c_get_clientdata(client);\r\nint i;\r\nthermostat_remove_files(th);\r\nif (th->thread != NULL)\r\nkthread_stop(th->thread);\r\nprintk(KERN_INFO "adt746x: Putting max temperatures back from "\r\n"%d, %d, %d to %d, %d, %d\n",\r\nth->limits[0], th->limits[1], th->limits[2],\r\nth->initial_limits[0], th->initial_limits[1],\r\nth->initial_limits[2]);\r\nfor (i = 0; i < 3; i++)\r\nwrite_reg(th, LIMIT_REG[i], th->initial_limits[i]);\r\nwrite_both_fan_speed(th, -1);\r\nkfree(th);\r\nreturn 0;\r\n}\r\nstatic int __init thermostat_init(void)\r\n{\r\n#ifndef CONFIG_I2C_POWERMAC\r\nrequest_module("i2c-powermac");\r\n#endif\r\nreturn i2c_add_driver(&thermostat_driver);\r\n}\r\nstatic void __exit thermostat_exit(void)\r\n{\r\ni2c_del_driver(&thermostat_driver);\r\n}

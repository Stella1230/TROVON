static unsigned sch_gpio_offset(struct sch_gpio *sch, unsigned gpio,\r\nunsigned reg)\r\n{\r\nunsigned base = 0;\r\nif (gpio >= sch->resume_base) {\r\ngpio -= sch->resume_base;\r\nbase += 0x20;\r\n}\r\nreturn base + reg + gpio / 8;\r\n}\r\nstatic unsigned sch_gpio_bit(struct sch_gpio *sch, unsigned gpio)\r\n{\r\nif (gpio >= sch->resume_base)\r\ngpio -= sch->resume_base;\r\nreturn gpio % 8;\r\n}\r\nstatic int sch_gpio_reg_get(struct sch_gpio *sch, unsigned gpio, unsigned reg)\r\n{\r\nunsigned short offset, bit;\r\nu8 reg_val;\r\noffset = sch_gpio_offset(sch, gpio, reg);\r\nbit = sch_gpio_bit(sch, gpio);\r\nreg_val = !!(inb(sch->iobase + offset) & BIT(bit));\r\nreturn reg_val;\r\n}\r\nstatic void sch_gpio_reg_set(struct sch_gpio *sch, unsigned gpio, unsigned reg,\r\nint val)\r\n{\r\nunsigned short offset, bit;\r\nu8 reg_val;\r\noffset = sch_gpio_offset(sch, gpio, reg);\r\nbit = sch_gpio_bit(sch, gpio);\r\nreg_val = inb(sch->iobase + offset);\r\nif (val)\r\noutb(reg_val | BIT(bit), sch->iobase + offset);\r\nelse\r\noutb((reg_val & ~BIT(bit)), sch->iobase + offset);\r\n}\r\nstatic int sch_gpio_direction_in(struct gpio_chip *gc, unsigned gpio_num)\r\n{\r\nstruct sch_gpio *sch = gpiochip_get_data(gc);\r\nspin_lock(&sch->lock);\r\nsch_gpio_reg_set(sch, gpio_num, GIO, 1);\r\nspin_unlock(&sch->lock);\r\nreturn 0;\r\n}\r\nstatic int sch_gpio_get(struct gpio_chip *gc, unsigned gpio_num)\r\n{\r\nstruct sch_gpio *sch = gpiochip_get_data(gc);\r\nreturn sch_gpio_reg_get(sch, gpio_num, GLV);\r\n}\r\nstatic void sch_gpio_set(struct gpio_chip *gc, unsigned gpio_num, int val)\r\n{\r\nstruct sch_gpio *sch = gpiochip_get_data(gc);\r\nspin_lock(&sch->lock);\r\nsch_gpio_reg_set(sch, gpio_num, GLV, val);\r\nspin_unlock(&sch->lock);\r\n}\r\nstatic int sch_gpio_direction_out(struct gpio_chip *gc, unsigned gpio_num,\r\nint val)\r\n{\r\nstruct sch_gpio *sch = gpiochip_get_data(gc);\r\nspin_lock(&sch->lock);\r\nsch_gpio_reg_set(sch, gpio_num, GIO, 0);\r\nspin_unlock(&sch->lock);\r\nsch_gpio_set(gc, gpio_num, val);\r\nreturn 0;\r\n}\r\nstatic int sch_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct sch_gpio *sch;\r\nstruct resource *res;\r\nsch = devm_kzalloc(&pdev->dev, sizeof(*sch), GFP_KERNEL);\r\nif (!sch)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res)\r\nreturn -EBUSY;\r\nif (!devm_request_region(&pdev->dev, res->start, resource_size(res),\r\npdev->name))\r\nreturn -EBUSY;\r\nspin_lock_init(&sch->lock);\r\nsch->iobase = res->start;\r\nsch->chip = sch_gpio_chip;\r\nsch->chip.label = dev_name(&pdev->dev);\r\nsch->chip.parent = &pdev->dev;\r\nswitch (pdev->id) {\r\ncase PCI_DEVICE_ID_INTEL_SCH_LPC:\r\nsch->core_base = 0;\r\nsch->resume_base = 10;\r\nsch->chip.ngpio = 14;\r\nsch_gpio_reg_set(sch, 8, GEN, 1);\r\nsch_gpio_reg_set(sch, 9, GEN, 1);\r\nsch_gpio_reg_set(sch, 13, GEN, 1);\r\nbreak;\r\ncase PCI_DEVICE_ID_INTEL_ITC_LPC:\r\nsch->core_base = 0;\r\nsch->resume_base = 5;\r\nsch->chip.ngpio = 14;\r\nbreak;\r\ncase PCI_DEVICE_ID_INTEL_CENTERTON_ILB:\r\nsch->core_base = 0;\r\nsch->resume_base = 21;\r\nsch->chip.ngpio = 30;\r\nbreak;\r\ncase PCI_DEVICE_ID_INTEL_QUARK_X1000_ILB:\r\nsch->core_base = 0;\r\nsch->resume_base = 2;\r\nsch->chip.ngpio = 8;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nplatform_set_drvdata(pdev, sch);\r\nreturn devm_gpiochip_add_data(&pdev->dev, &sch->chip, sch);\r\n}

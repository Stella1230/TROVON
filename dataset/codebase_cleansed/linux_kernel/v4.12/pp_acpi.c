bool acpi_atcs_functions_supported(void *device, uint32_t index)\r\n{\r\nint32_t result;\r\nstruct atcs_verify_interface output_buf = {0};\r\nint32_t temp_buffer = 1;\r\nresult = cgs_call_acpi_method(device, CGS_ACPI_METHOD_ATCS,\r\nATCS_FUNCTION_VERIFY_INTERFACE,\r\n&temp_buffer,\r\n&output_buf,\r\n1,\r\nsizeof(temp_buffer),\r\nsizeof(output_buf));\r\nreturn result == 0 ? (output_buf.function_bits & (1 << (index - 1))) != 0 : false;\r\n}\r\nbool acpi_atcs_notify_pcie_device_ready(void *device)\r\n{\r\nint32_t temp_buffer = 1;\r\nreturn cgs_call_acpi_method(device, CGS_ACPI_METHOD_ATCS,\r\nATCS_FUNCTION_PCIE_DEVICE_READY_NOTIFICATION,\r\n&temp_buffer,\r\nNULL,\r\n0,\r\nsizeof(temp_buffer),\r\n0);\r\n}\r\nint acpi_pcie_perf_request(void *device, uint8_t perf_req, bool advertise)\r\n{\r\nstruct atcs_pref_req_input atcs_input;\r\nstruct atcs_pref_req_output atcs_output;\r\nu32 retry = 3;\r\nint result;\r\nstruct cgs_system_info info = {0};\r\nif (acpi_atcs_notify_pcie_device_ready(device))\r\nreturn -EINVAL;\r\ninfo.size = sizeof(struct cgs_system_info);\r\ninfo.info_id = CGS_SYSTEM_INFO_ADAPTER_BDF_ID;\r\nresult = cgs_query_system_info(device, &info);\r\nif (result != 0)\r\nreturn -EINVAL;\r\natcs_input.client_id = (uint16_t)info.value;\r\natcs_input.size = sizeof(struct atcs_pref_req_input);\r\natcs_input.valid_flags_mask = ATCS_VALID_FLAGS_MASK;\r\natcs_input.flags = ATCS_WAIT_FOR_COMPLETION;\r\nif (advertise)\r\natcs_input.flags |= ATCS_ADVERTISE_CAPS;\r\natcs_input.req_type = ATCS_PCIE_LINK_SPEED;\r\natcs_input.perf_req = perf_req;\r\natcs_output.size = sizeof(struct atcs_pref_req_input);\r\nwhile (retry--) {\r\nresult = cgs_call_acpi_method(device,\r\nCGS_ACPI_METHOD_ATCS,\r\nATCS_FUNCTION_PCIE_PERFORMANCE_REQUEST,\r\n&atcs_input,\r\n&atcs_output,\r\n1,\r\nsizeof(atcs_input),\r\nsizeof(atcs_output));\r\nif (result != 0)\r\nreturn -EIO;\r\nswitch (atcs_output.ret_val) {\r\ncase ATCS_REQUEST_REFUSED:\r\ndefault:\r\nreturn -EINVAL;\r\ncase ATCS_REQUEST_COMPLETE:\r\nreturn 0;\r\ncase ATCS_REQUEST_IN_PROGRESS:\r\nudelay(10);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}

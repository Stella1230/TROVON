static int mga_i2c_read_gpio(struct mga_device *mdev)\r\n{\r\nWREG8(DAC_INDEX, MGA1064_GEN_IO_DATA);\r\nreturn RREG8(DAC_DATA);\r\n}\r\nstatic void mga_i2c_set_gpio(struct mga_device *mdev, int mask, int val)\r\n{\r\nint tmp;\r\nWREG8(DAC_INDEX, MGA1064_GEN_IO_CTL);\r\ntmp = (RREG8(DAC_DATA) & mask) | val;\r\nWREG_DAC(MGA1064_GEN_IO_CTL, tmp);\r\nWREG_DAC(MGA1064_GEN_IO_DATA, 0);\r\n}\r\nstatic inline void mga_i2c_set(struct mga_device *mdev, int mask, int state)\r\n{\r\nif (state)\r\nstate = 0;\r\nelse\r\nstate = mask;\r\nmga_i2c_set_gpio(mdev, ~mask, state);\r\n}\r\nstatic void mga_gpio_setsda(void *data, int state)\r\n{\r\nstruct mga_i2c_chan *i2c = data;\r\nstruct mga_device *mdev = i2c->dev->dev_private;\r\nmga_i2c_set(mdev, i2c->data, state);\r\n}\r\nstatic void mga_gpio_setscl(void *data, int state)\r\n{\r\nstruct mga_i2c_chan *i2c = data;\r\nstruct mga_device *mdev = i2c->dev->dev_private;\r\nmga_i2c_set(mdev, i2c->clock, state);\r\n}\r\nstatic int mga_gpio_getsda(void *data)\r\n{\r\nstruct mga_i2c_chan *i2c = data;\r\nstruct mga_device *mdev = i2c->dev->dev_private;\r\nreturn (mga_i2c_read_gpio(mdev) & i2c->data) ? 1 : 0;\r\n}\r\nstatic int mga_gpio_getscl(void *data)\r\n{\r\nstruct mga_i2c_chan *i2c = data;\r\nstruct mga_device *mdev = i2c->dev->dev_private;\r\nreturn (mga_i2c_read_gpio(mdev) & i2c->clock) ? 1 : 0;\r\n}\r\nstruct mga_i2c_chan *mgag200_i2c_create(struct drm_device *dev)\r\n{\r\nstruct mga_device *mdev = dev->dev_private;\r\nstruct mga_i2c_chan *i2c;\r\nint ret;\r\nint data, clock;\r\nWREG_DAC(MGA1064_GEN_IO_CTL2, 1);\r\nWREG_DAC(MGA1064_GEN_IO_DATA, 0xff);\r\nWREG_DAC(MGA1064_GEN_IO_CTL, 0);\r\nswitch (mdev->type) {\r\ncase G200_SE_A:\r\ncase G200_SE_B:\r\ncase G200_EV:\r\ncase G200_WB:\r\ncase G200_EW3:\r\ndata = 1;\r\nclock = 2;\r\nbreak;\r\ncase G200_EH:\r\ncase G200_EH3:\r\ncase G200_ER:\r\ndata = 2;\r\nclock = 1;\r\nbreak;\r\ndefault:\r\ndata = 2;\r\nclock = 8;\r\nbreak;\r\n}\r\ni2c = kzalloc(sizeof(struct mga_i2c_chan), GFP_KERNEL);\r\nif (!i2c)\r\nreturn NULL;\r\ni2c->data = data;\r\ni2c->clock = clock;\r\ni2c->adapter.owner = THIS_MODULE;\r\ni2c->adapter.class = I2C_CLASS_DDC;\r\ni2c->adapter.dev.parent = &dev->pdev->dev;\r\ni2c->dev = dev;\r\ni2c_set_adapdata(&i2c->adapter, i2c);\r\nsnprintf(i2c->adapter.name, sizeof(i2c->adapter.name), "mga i2c");\r\ni2c->adapter.algo_data = &i2c->bit;\r\ni2c->bit.udelay = 10;\r\ni2c->bit.timeout = 2;\r\ni2c->bit.data = i2c;\r\ni2c->bit.setsda = mga_gpio_setsda;\r\ni2c->bit.setscl = mga_gpio_setscl;\r\ni2c->bit.getsda = mga_gpio_getsda;\r\ni2c->bit.getscl = mga_gpio_getscl;\r\nret = i2c_bit_add_bus(&i2c->adapter);\r\nif (ret) {\r\nkfree(i2c);\r\ni2c = NULL;\r\n}\r\nreturn i2c;\r\n}\r\nvoid mgag200_i2c_destroy(struct mga_i2c_chan *i2c)\r\n{\r\nif (!i2c)\r\nreturn;\r\ni2c_del_adapter(&i2c->adapter);\r\nkfree(i2c);\r\n}

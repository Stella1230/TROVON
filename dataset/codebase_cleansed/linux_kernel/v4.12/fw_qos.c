int mlx4_SET_PORT_PRIO2TC(struct mlx4_dev *dev, u8 port, u8 *prio2tc)\r\n{\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_set_port_prio2tc_context *context;\r\nint err;\r\nu32 in_mod;\r\nint i;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\ncontext = mailbox->buf;\r\nfor (i = 0; i < MLX4_NUM_UP; i += 2)\r\ncontext->prio2tc[i >> 1] = prio2tc[i] << 4 | prio2tc[i + 1];\r\nin_mod = MLX4_SET_PORT_PRIO2TC << 8 | port;\r\nerr = mlx4_cmd(dev, mailbox->dma, in_mod, 1, MLX4_CMD_SET_PORT,\r\nMLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_SET_PORT_SCHEDULER(struct mlx4_dev *dev, u8 port, u8 *tc_tx_bw,\r\nu8 *pg, u16 *ratelimit)\r\n{\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_set_port_scheduler_context *context;\r\nint err;\r\nu32 in_mod;\r\nint i;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\ncontext = mailbox->buf;\r\nfor (i = 0; i < MLX4_NUM_TC; i++) {\r\nstruct mlx4_port_scheduler_tc_cfg_be *tc = &context->tc[i];\r\nu16 r;\r\nif (ratelimit && ratelimit[i]) {\r\nif (ratelimit[i] <= MLX4_MAX_100M_UNITS_VAL) {\r\nr = ratelimit[i];\r\ntc->max_bw_units =\r\nhtons(MLX4_RATELIMIT_100M_UNITS);\r\n} else {\r\nr = ratelimit[i] / 10;\r\ntc->max_bw_units =\r\nhtons(MLX4_RATELIMIT_1G_UNITS);\r\n}\r\ntc->max_bw_value = htons(r);\r\n} else {\r\ntc->max_bw_value = htons(MLX4_RATELIMIT_DEFAULT);\r\ntc->max_bw_units = htons(MLX4_RATELIMIT_1G_UNITS);\r\n}\r\ntc->pg = htons(pg[i]);\r\ntc->bw_precentage = htons(tc_tx_bw[i]);\r\n}\r\nin_mod = MLX4_SET_PORT_SCHEDULER << 8 | port;\r\nerr = mlx4_cmd(dev, mailbox->dma, in_mod, 1, MLX4_CMD_SET_PORT,\r\nMLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_ALLOCATE_VPP_get(struct mlx4_dev *dev, u8 port,\r\nu16 *availible_vpp, u8 *vpp_p_up)\r\n{\r\nint i;\r\nint err;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_alloc_vpp_param *out_param;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nout_param = mailbox->buf;\r\nerr = mlx4_cmd_box(dev, 0, mailbox->dma, port,\r\nMLX4_ALLOCATE_VPP_QUERY,\r\nMLX4_CMD_ALLOCATE_VPP,\r\nMLX4_CMD_TIME_CLASS_A,\r\nMLX4_CMD_NATIVE);\r\nif (err)\r\ngoto out;\r\n*availible_vpp = (u16)be32_to_cpu(out_param->availible_vpp);\r\nfor (i = 0; i < MLX4_NUM_UP; i++)\r\nvpp_p_up[i] = (u8)be32_to_cpu(out_param->vpp_p_up[i]);\r\nout:\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_ALLOCATE_VPP_set(struct mlx4_dev *dev, u8 port, u8 *vpp_p_up)\r\n{\r\nint i;\r\nint err;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_alloc_vpp_param *in_param;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nin_param = mailbox->buf;\r\nfor (i = 0; i < MLX4_NUM_UP; i++)\r\nin_param->vpp_p_up[i] = cpu_to_be32(vpp_p_up[i]);\r\nerr = mlx4_cmd(dev, mailbox->dma, port,\r\nMLX4_ALLOCATE_VPP_ALLOCATE,\r\nMLX4_CMD_ALLOCATE_VPP,\r\nMLX4_CMD_TIME_CLASS_A,\r\nMLX4_CMD_NATIVE);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_SET_VPORT_QOS_get(struct mlx4_dev *dev, u8 port, u8 vport,\r\nstruct mlx4_vport_qos_param *out_param)\r\n{\r\nint i;\r\nint err;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_set_vport_context *ctx;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nctx = mailbox->buf;\r\nerr = mlx4_cmd_box(dev, 0, mailbox->dma, (vport << 8) | port,\r\nMLX4_SET_VPORT_QOS_QUERY,\r\nMLX4_CMD_SET_VPORT_QOS,\r\nMLX4_CMD_TIME_CLASS_A,\r\nMLX4_CMD_NATIVE);\r\nif (err)\r\ngoto out;\r\nfor (i = 0; i < MLX4_NUM_UP; i++) {\r\nout_param[i].bw_share = be32_to_cpu(ctx->qos_p_up[i].bw_share);\r\nout_param[i].max_avg_bw =\r\nbe32_to_cpu(ctx->qos_p_up[i].max_avg_bw);\r\nout_param[i].enable =\r\n!!(be32_to_cpu(ctx->qos_p_up[i].enable) & 31);\r\n}\r\nout:\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_SET_VPORT_QOS_set(struct mlx4_dev *dev, u8 port, u8 vport,\r\nstruct mlx4_vport_qos_param *in_param)\r\n{\r\nint i;\r\nint err;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_set_vport_context *ctx;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nctx = mailbox->buf;\r\nfor (i = 0; i < MLX4_NUM_UP; i++) {\r\nctx->qos_p_up[i].bw_share = cpu_to_be32(in_param[i].bw_share);\r\nctx->qos_p_up[i].max_avg_bw =\r\ncpu_to_be32(in_param[i].max_avg_bw);\r\nctx->qos_p_up[i].enable =\r\ncpu_to_be32(in_param[i].enable << 31);\r\n}\r\nerr = mlx4_cmd(dev, mailbox->dma, (vport << 8) | port,\r\nMLX4_SET_VPORT_QOS_SET,\r\nMLX4_CMD_SET_VPORT_QOS,\r\nMLX4_CMD_TIME_CLASS_A,\r\nMLX4_CMD_NATIVE);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}

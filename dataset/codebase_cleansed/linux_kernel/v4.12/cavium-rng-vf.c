static int cavium_rng_read(struct hwrng *rng, void *dat, size_t max, bool wait)\r\n{\r\nstruct cavium_rng *p = container_of(rng, struct cavium_rng, ops);\r\nunsigned int size = max;\r\nwhile (size >= 8) {\r\n*((u64 *)dat) = readq(p->result);\r\nsize -= 8;\r\ndat += 8;\r\n}\r\nwhile (size > 0) {\r\n*((u8 *)dat) = readb(p->result);\r\nsize--;\r\ndat++;\r\n}\r\nreturn max;\r\n}\r\nstatic int cavium_rng_probe_vf(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct cavium_rng *rng;\r\nint ret;\r\nrng = devm_kzalloc(&pdev->dev, sizeof(*rng), GFP_KERNEL);\r\nif (!rng)\r\nreturn -ENOMEM;\r\nrng->result = pcim_iomap(pdev, 0, 0);\r\nif (!rng->result) {\r\ndev_err(&pdev->dev, "Error iomap failed retrieving result.\n");\r\nreturn -ENOMEM;\r\n}\r\nrng->ops.name = devm_kasprintf(&pdev->dev, GFP_KERNEL,\r\n"cavium-rng-%s", dev_name(&pdev->dev));\r\nif (!rng->ops.name)\r\nreturn -ENOMEM;\r\nrng->ops.read = cavium_rng_read;\r\nrng->ops.quality = 1000;\r\npci_set_drvdata(pdev, rng);\r\nret = hwrng_register(&rng->ops);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Error registering device as HWRNG.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid cavium_rng_remove_vf(struct pci_dev *pdev)\r\n{\r\nstruct cavium_rng *rng;\r\nrng = pci_get_drvdata(pdev);\r\nhwrng_unregister(&rng->ops);\r\n}

void udf_free_inode(struct inode *inode)\r\n{\r\nstruct super_block *sb = inode->i_sb;\r\nstruct udf_sb_info *sbi = UDF_SB(sb);\r\nstruct logicalVolIntegrityDescImpUse *lvidiu = udf_sb_lvidiu(sb);\r\nif (lvidiu) {\r\nmutex_lock(&sbi->s_alloc_mutex);\r\nif (S_ISDIR(inode->i_mode))\r\nle32_add_cpu(&lvidiu->numDirs, -1);\r\nelse\r\nle32_add_cpu(&lvidiu->numFiles, -1);\r\nudf_updated_lvid(sb);\r\nmutex_unlock(&sbi->s_alloc_mutex);\r\n}\r\nudf_free_blocks(sb, NULL, &UDF_I(inode)->i_location, 0, 1);\r\n}\r\nstruct inode *udf_new_inode(struct inode *dir, umode_t mode)\r\n{\r\nstruct super_block *sb = dir->i_sb;\r\nstruct udf_sb_info *sbi = UDF_SB(sb);\r\nstruct inode *inode;\r\nint block;\r\nuint32_t start = UDF_I(dir)->i_location.logicalBlockNum;\r\nstruct udf_inode_info *iinfo;\r\nstruct udf_inode_info *dinfo = UDF_I(dir);\r\nstruct logicalVolIntegrityDescImpUse *lvidiu;\r\nint err;\r\ninode = new_inode(sb);\r\nif (!inode)\r\nreturn ERR_PTR(-ENOMEM);\r\niinfo = UDF_I(inode);\r\nif (UDF_QUERY_FLAG(inode->i_sb, UDF_FLAG_USE_EXTENDED_FE)) {\r\niinfo->i_efe = 1;\r\nif (UDF_VERS_USE_EXTENDED_FE > sbi->s_udfrev)\r\nsbi->s_udfrev = UDF_VERS_USE_EXTENDED_FE;\r\niinfo->i_ext.i_data = kzalloc(inode->i_sb->s_blocksize -\r\nsizeof(struct extendedFileEntry),\r\nGFP_KERNEL);\r\n} else {\r\niinfo->i_efe = 0;\r\niinfo->i_ext.i_data = kzalloc(inode->i_sb->s_blocksize -\r\nsizeof(struct fileEntry),\r\nGFP_KERNEL);\r\n}\r\nif (!iinfo->i_ext.i_data) {\r\niput(inode);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nerr = -ENOSPC;\r\nblock = udf_new_block(dir->i_sb, NULL,\r\ndinfo->i_location.partitionReferenceNum,\r\nstart, &err);\r\nif (err) {\r\niput(inode);\r\nreturn ERR_PTR(err);\r\n}\r\nlvidiu = udf_sb_lvidiu(sb);\r\nif (lvidiu) {\r\niinfo->i_unique = lvid_get_unique_id(sb);\r\ninode->i_generation = iinfo->i_unique;\r\nmutex_lock(&sbi->s_alloc_mutex);\r\nif (S_ISDIR(mode))\r\nle32_add_cpu(&lvidiu->numDirs, 1);\r\nelse\r\nle32_add_cpu(&lvidiu->numFiles, 1);\r\nudf_updated_lvid(sb);\r\nmutex_unlock(&sbi->s_alloc_mutex);\r\n}\r\ninode_init_owner(inode, dir, mode);\r\niinfo->i_location.logicalBlockNum = block;\r\niinfo->i_location.partitionReferenceNum =\r\ndinfo->i_location.partitionReferenceNum;\r\ninode->i_ino = udf_get_lb_pblock(sb, &iinfo->i_location, 0);\r\ninode->i_blocks = 0;\r\niinfo->i_lenEAttr = 0;\r\niinfo->i_lenAlloc = 0;\r\niinfo->i_use = 0;\r\niinfo->i_checkpoint = 1;\r\nif (UDF_QUERY_FLAG(inode->i_sb, UDF_FLAG_USE_AD_IN_ICB))\r\niinfo->i_alloc_type = ICBTAG_FLAG_AD_IN_ICB;\r\nelse if (UDF_QUERY_FLAG(inode->i_sb, UDF_FLAG_USE_SHORT_AD))\r\niinfo->i_alloc_type = ICBTAG_FLAG_AD_SHORT;\r\nelse\r\niinfo->i_alloc_type = ICBTAG_FLAG_AD_LONG;\r\ninode->i_mtime = inode->i_atime = inode->i_ctime =\r\niinfo->i_crtime = current_time(inode);\r\nif (unlikely(insert_inode_locked(inode) < 0)) {\r\nmake_bad_inode(inode);\r\niput(inode);\r\nreturn ERR_PTR(-EIO);\r\n}\r\nmark_inode_dirty(inode);\r\nreturn inode;\r\n}

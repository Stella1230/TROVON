static int exynos4x12_rate_to_clk(unsigned long rate, u32 *reg)\r\n{\r\nswitch (rate) {\r\ncase 9600 * KHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_9MHZ6;\r\nbreak;\r\ncase 10 * MHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_10MHZ;\r\nbreak;\r\ncase 12 * MHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_12MHZ;\r\nbreak;\r\ncase 19200 * KHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_19MHZ2;\r\nbreak;\r\ncase 20 * MHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_20MHZ;\r\nbreak;\r\ncase 24 * MHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_24MHZ;\r\nbreak;\r\ncase 50 * MHZ:\r\n*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_50MHZ;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void exynos4x12_isol(struct samsung_usb2_phy_instance *inst, bool on)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 offset;\r\nu32 mask;\r\nswitch (inst->cfg->id) {\r\ncase EXYNOS4x12_DEVICE:\r\ncase EXYNOS4x12_HOST:\r\noffset = EXYNOS_4x12_USB_ISOL_OFFSET;\r\nmask = EXYNOS_4x12_USB_ISOL_OTG;\r\nbreak;\r\ncase EXYNOS4x12_HSIC0:\r\noffset = EXYNOS_4x12_USB_ISOL_HSIC0_OFFSET;\r\nmask = EXYNOS_4x12_USB_ISOL_HSIC0;\r\nbreak;\r\ncase EXYNOS4x12_HSIC1:\r\noffset = EXYNOS_4x12_USB_ISOL_HSIC1_OFFSET;\r\nmask = EXYNOS_4x12_USB_ISOL_HSIC1;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nregmap_update_bits(drv->reg_pmu, offset, mask, on ? 0 : mask);\r\n}\r\nstatic void exynos4x12_setup_clk(struct samsung_usb2_phy_instance *inst)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 clk;\r\nclk = readl(drv->reg_phy + EXYNOS_4x12_UPHYCLK);\r\nclk &= ~EXYNOS_4x12_UPHYCLK_PHYFSEL_MASK;\r\nif (drv->cfg->has_refclk_sel)\r\nclk = EXYNOS_3250_UPHYCLK_REFCLKSEL;\r\nclk |= drv->ref_reg_val << EXYNOS_4x12_UPHYCLK_PHYFSEL_OFFSET;\r\nclk |= EXYNOS_4x12_UPHYCLK_PHY1_COMMON_ON;\r\nwritel(clk, drv->reg_phy + EXYNOS_4x12_UPHYCLK);\r\n}\r\nstatic void exynos4x12_phy_pwr(struct samsung_usb2_phy_instance *inst, bool on)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 rstbits = 0;\r\nu32 phypwr = 0;\r\nu32 rst;\r\nu32 pwr;\r\nswitch (inst->cfg->id) {\r\ncase EXYNOS4x12_DEVICE:\r\nphypwr = EXYNOS_4x12_UPHYPWR_PHY0;\r\nrstbits = EXYNOS_4x12_URSTCON_PHY0;\r\nbreak;\r\ncase EXYNOS4x12_HOST:\r\nphypwr = EXYNOS_4x12_UPHYPWR_PHY1;\r\nrstbits = EXYNOS_4x12_URSTCON_HOST_PHY |\r\nEXYNOS_4x12_URSTCON_PHY1 |\r\nEXYNOS_4x12_URSTCON_HOST_LINK_P0;\r\nbreak;\r\ncase EXYNOS4x12_HSIC0:\r\nphypwr = EXYNOS_4x12_UPHYPWR_HSIC0;\r\nrstbits = EXYNOS_4x12_URSTCON_HSIC0 |\r\nEXYNOS_4x12_URSTCON_HOST_LINK_P1;\r\nbreak;\r\ncase EXYNOS4x12_HSIC1:\r\nphypwr = EXYNOS_4x12_UPHYPWR_HSIC1;\r\nrstbits = EXYNOS_4x12_URSTCON_HSIC1 |\r\nEXYNOS_4x12_URSTCON_HOST_LINK_P1;\r\nbreak;\r\n}\r\nif (on) {\r\npwr = readl(drv->reg_phy + EXYNOS_4x12_UPHYPWR);\r\npwr &= ~phypwr;\r\nwritel(pwr, drv->reg_phy + EXYNOS_4x12_UPHYPWR);\r\nrst = readl(drv->reg_phy + EXYNOS_4x12_UPHYRST);\r\nrst |= rstbits;\r\nwritel(rst, drv->reg_phy + EXYNOS_4x12_UPHYRST);\r\nudelay(10);\r\nrst &= ~rstbits;\r\nwritel(rst, drv->reg_phy + EXYNOS_4x12_UPHYRST);\r\nudelay(80);\r\n} else {\r\npwr = readl(drv->reg_phy + EXYNOS_4x12_UPHYPWR);\r\npwr |= phypwr;\r\nwritel(pwr, drv->reg_phy + EXYNOS_4x12_UPHYPWR);\r\n}\r\n}\r\nstatic void exynos4x12_power_on_int(struct samsung_usb2_phy_instance *inst)\r\n{\r\nif (inst->int_cnt++ > 0)\r\nreturn;\r\nexynos4x12_setup_clk(inst);\r\nexynos4x12_isol(inst, 0);\r\nexynos4x12_phy_pwr(inst, 1);\r\n}\r\nstatic int exynos4x12_power_on(struct samsung_usb2_phy_instance *inst)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nif (inst->ext_cnt++ > 0)\r\nreturn 0;\r\nif (inst->cfg->id == EXYNOS4x12_HOST) {\r\nregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\r\nEXYNOS_4x12_MODE_SWITCH_MASK,\r\nEXYNOS_4x12_MODE_SWITCH_HOST);\r\nexynos4x12_power_on_int(&drv->instances[EXYNOS4x12_DEVICE]);\r\n}\r\nif (inst->cfg->id == EXYNOS4x12_DEVICE && drv->cfg->has_mode_switch)\r\nregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\r\nEXYNOS_4x12_MODE_SWITCH_MASK,\r\nEXYNOS_4x12_MODE_SWITCH_DEVICE);\r\nif (inst->cfg->id == EXYNOS4x12_HSIC0 ||\r\ninst->cfg->id == EXYNOS4x12_HSIC1) {\r\nexynos4x12_power_on_int(&drv->instances[EXYNOS4x12_DEVICE]);\r\nexynos4x12_power_on_int(&drv->instances[EXYNOS4x12_HOST]);\r\n}\r\nexynos4x12_power_on_int(inst);\r\nreturn 0;\r\n}\r\nstatic void exynos4x12_power_off_int(struct samsung_usb2_phy_instance *inst)\r\n{\r\nif (inst->int_cnt-- > 1)\r\nreturn;\r\nexynos4x12_isol(inst, 1);\r\nexynos4x12_phy_pwr(inst, 0);\r\n}\r\nstatic int exynos4x12_power_off(struct samsung_usb2_phy_instance *inst)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nif (inst->ext_cnt-- > 1)\r\nreturn 0;\r\nif (inst->cfg->id == EXYNOS4x12_DEVICE && drv->cfg->has_mode_switch)\r\nregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\r\nEXYNOS_4x12_MODE_SWITCH_MASK,\r\nEXYNOS_4x12_MODE_SWITCH_HOST);\r\nif (inst->cfg->id == EXYNOS4x12_HOST)\r\nexynos4x12_power_off_int(&drv->instances[EXYNOS4x12_DEVICE]);\r\nif (inst->cfg->id == EXYNOS4x12_HSIC0 ||\r\ninst->cfg->id == EXYNOS4x12_HSIC1) {\r\nexynos4x12_power_off_int(&drv->instances[EXYNOS4x12_DEVICE]);\r\nexynos4x12_power_off_int(&drv->instances[EXYNOS4x12_HOST]);\r\n}\r\nexynos4x12_power_off_int(inst);\r\nreturn 0;\r\n}

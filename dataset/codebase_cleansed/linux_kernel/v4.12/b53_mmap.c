static int b53_mmap_read8(struct b53_device *dev, u8 page, u8 reg, u8 *val)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\n*val = readb(regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_read16(struct b53_device *dev, u8 page, u8 reg, u16 *val)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nif (WARN_ON(reg % 2))\r\nreturn -EINVAL;\r\nif (dev->pdata && dev->pdata->big_endian)\r\n*val = ioread16be(regs + (page << 8) + reg);\r\nelse\r\n*val = readw(regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_read32(struct b53_device *dev, u8 page, u8 reg, u32 *val)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nif (WARN_ON(reg % 4))\r\nreturn -EINVAL;\r\nif (dev->pdata && dev->pdata->big_endian)\r\n*val = ioread32be(regs + (page << 8) + reg);\r\nelse\r\n*val = readl(regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_read48(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nif (WARN_ON(reg % 2))\r\nreturn -EINVAL;\r\nif (reg % 4) {\r\nu16 lo;\r\nu32 hi;\r\nif (dev->pdata && dev->pdata->big_endian) {\r\nlo = ioread16be(regs + (page << 8) + reg);\r\nhi = ioread32be(regs + (page << 8) + reg + 2);\r\n} else {\r\nlo = readw(regs + (page << 8) + reg);\r\nhi = readl(regs + (page << 8) + reg + 2);\r\n}\r\n*val = ((u64)hi << 16) | lo;\r\n} else {\r\nu32 lo;\r\nu16 hi;\r\nif (dev->pdata && dev->pdata->big_endian) {\r\nlo = ioread32be(regs + (page << 8) + reg);\r\nhi = ioread16be(regs + (page << 8) + reg + 4);\r\n} else {\r\nlo = readl(regs + (page << 8) + reg);\r\nhi = readw(regs + (page << 8) + reg + 4);\r\n}\r\n*val = ((u64)hi << 32) | lo;\r\n}\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_read64(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nu32 hi, lo;\r\nif (WARN_ON(reg % 4))\r\nreturn -EINVAL;\r\nif (dev->pdata && dev->pdata->big_endian) {\r\nlo = ioread32be(regs + (page << 8) + reg);\r\nhi = ioread32be(regs + (page << 8) + reg + 4);\r\n} else {\r\nlo = readl(regs + (page << 8) + reg);\r\nhi = readl(regs + (page << 8) + reg + 4);\r\n}\r\n*val = ((u64)hi << 32) | lo;\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_write8(struct b53_device *dev, u8 page, u8 reg, u8 value)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nwriteb(value, regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_write16(struct b53_device *dev, u8 page, u8 reg,\r\nu16 value)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nif (WARN_ON(reg % 2))\r\nreturn -EINVAL;\r\nif (dev->pdata && dev->pdata->big_endian)\r\niowrite16be(value, regs + (page << 8) + reg);\r\nelse\r\nwritew(value, regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_write32(struct b53_device *dev, u8 page, u8 reg,\r\nu32 value)\r\n{\r\nu8 __iomem *regs = dev->priv;\r\nif (WARN_ON(reg % 4))\r\nreturn -EINVAL;\r\nif (dev->pdata && dev->pdata->big_endian)\r\niowrite32be(value, regs + (page << 8) + reg);\r\nelse\r\nwritel(value, regs + (page << 8) + reg);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_write48(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nif (WARN_ON(reg % 2))\r\nreturn -EINVAL;\r\nif (reg % 4) {\r\nu32 hi = (u32)(value >> 16);\r\nu16 lo = (u16)value;\r\nb53_mmap_write16(dev, page, reg, lo);\r\nb53_mmap_write32(dev, page, reg + 2, hi);\r\n} else {\r\nu16 hi = (u16)(value >> 32);\r\nu32 lo = (u32)value;\r\nb53_mmap_write32(dev, page, reg, lo);\r\nb53_mmap_write16(dev, page, reg + 4, hi);\r\n}\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_write64(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nu32 hi, lo;\r\nhi = upper_32_bits(value);\r\nlo = lower_32_bits(value);\r\nif (WARN_ON(reg % 4))\r\nreturn -EINVAL;\r\nb53_mmap_write32(dev, page, reg, lo);\r\nb53_mmap_write32(dev, page, reg + 4, hi);\r\nreturn 0;\r\n}\r\nstatic int b53_mmap_probe(struct platform_device *pdev)\r\n{\r\nstruct b53_platform_data *pdata = pdev->dev.platform_data;\r\nstruct b53_device *dev;\r\nif (!pdata)\r\nreturn -EINVAL;\r\ndev = b53_switch_alloc(&pdev->dev, &b53_mmap_ops, pdata->regs);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->pdata = pdata;\r\nplatform_set_drvdata(pdev, dev);\r\nreturn b53_switch_register(dev);\r\n}\r\nstatic int b53_mmap_remove(struct platform_device *pdev)\r\n{\r\nstruct b53_device *dev = platform_get_drvdata(pdev);\r\nif (dev)\r\nb53_switch_remove(dev);\r\nreturn 0;\r\n}

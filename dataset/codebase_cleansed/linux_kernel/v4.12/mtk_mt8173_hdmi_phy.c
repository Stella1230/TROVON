static void mtk_hdmi_phy_clear_bits(struct mtk_hdmi_phy *hdmi_phy, u32 offset,\r\nu32 bits)\r\n{\r\nvoid __iomem *reg = hdmi_phy->regs + offset;\r\nu32 tmp;\r\ntmp = readl(reg);\r\ntmp &= ~bits;\r\nwritel(tmp, reg);\r\n}\r\nstatic void mtk_hdmi_phy_set_bits(struct mtk_hdmi_phy *hdmi_phy, u32 offset,\r\nu32 bits)\r\n{\r\nvoid __iomem *reg = hdmi_phy->regs + offset;\r\nu32 tmp;\r\ntmp = readl(reg);\r\ntmp |= bits;\r\nwritel(tmp, reg);\r\n}\r\nstatic void mtk_hdmi_phy_mask(struct mtk_hdmi_phy *hdmi_phy, u32 offset,\r\nu32 val, u32 mask)\r\n{\r\nvoid __iomem *reg = hdmi_phy->regs + offset;\r\nu32 tmp;\r\ntmp = readl(reg);\r\ntmp = (tmp & ~mask) | (val & mask);\r\nwritel(tmp, reg);\r\n}\r\nstatic inline struct mtk_hdmi_phy *to_mtk_hdmi_phy(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct mtk_hdmi_phy, pll_hw);\r\n}\r\nstatic int mtk_hdmi_pll_prepare(struct clk_hw *hw)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\r\ndev_dbg(hdmi_phy->dev, "%s\n", __func__);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_AUTOK_EN);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON0, RG_HDMITX_PLL_POSDIV);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON3, RG_HDMITX_MHLCK_EN);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_BIAS_EN);\r\nusleep_range(100, 150);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON0, RG_HDMITX_PLL_EN);\r\nusleep_range(100, 150);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_BIAS_LPF_EN);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_TXDIV_EN);\r\nreturn 0;\r\n}\r\nstatic void mtk_hdmi_pll_unprepare(struct clk_hw *hw)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\r\ndev_dbg(hdmi_phy->dev, "%s\n", __func__);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_TXDIV_EN);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_BIAS_LPF_EN);\r\nusleep_range(100, 150);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON0, RG_HDMITX_PLL_EN);\r\nusleep_range(100, 150);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_BIAS_EN);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON0, RG_HDMITX_PLL_POSDIV);\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON1, RG_HDMITX_PLL_AUTOK_EN);\r\nusleep_range(100, 150);\r\n}\r\nstatic int mtk_hdmi_pll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\r\nunsigned int pre_div;\r\nunsigned int div;\r\nunsigned int pre_ibias;\r\nunsigned int hdmi_ibias;\r\nunsigned int imp_en;\r\ndev_dbg(hdmi_phy->dev, "%s: %lu Hz, parent: %lu Hz\n", __func__,\r\nrate, parent_rate);\r\nif (rate <= 27000000) {\r\npre_div = 0;\r\ndiv = 3;\r\n} else if (rate <= 74250000) {\r\npre_div = 1;\r\ndiv = 2;\r\n} else {\r\npre_div = 1;\r\ndiv = 1;\r\n}\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON0,\r\n(pre_div << PREDIV_SHIFT), RG_HDMITX_PLL_PREDIV);\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON0, RG_HDMITX_PLL_POSDIV);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON0,\r\n(0x1 << PLL_IC_SHIFT) | (0x1 << PLL_IR_SHIFT),\r\nRG_HDMITX_PLL_IC | RG_HDMITX_PLL_IR);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON1,\r\n(div << PLL_TXDIV_SHIFT), RG_HDMITX_PLL_TXDIV);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON0,\r\n(0x1 << PLL_FBKSEL_SHIFT) | (19 << PLL_FBKDIV_SHIFT),\r\nRG_HDMITX_PLL_FBKSEL | RG_HDMITX_PLL_FBKDIV);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON1,\r\n(0x2 << PLL_DIVEN_SHIFT), RG_HDMITX_PLL_DIVEN);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON0,\r\n(0xc << PLL_BP_SHIFT) | (0x2 << PLL_BC_SHIFT) |\r\n(0x1 << PLL_BR_SHIFT),\r\nRG_HDMITX_PLL_BP | RG_HDMITX_PLL_BC |\r\nRG_HDMITX_PLL_BR);\r\nif (rate < 165000000) {\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON3,\r\nRG_HDMITX_PRD_IMP_EN);\r\npre_ibias = 0x3;\r\nimp_en = 0x0;\r\nhdmi_ibias = hdmi_phy->ibias;\r\n} else {\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON3,\r\nRG_HDMITX_PRD_IMP_EN);\r\npre_ibias = 0x6;\r\nimp_en = 0xf;\r\nhdmi_ibias = hdmi_phy->ibias_up;\r\n}\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON4,\r\n(pre_ibias << PRD_IBIAS_CLK_SHIFT) |\r\n(pre_ibias << PRD_IBIAS_D2_SHIFT) |\r\n(pre_ibias << PRD_IBIAS_D1_SHIFT) |\r\n(pre_ibias << PRD_IBIAS_D0_SHIFT),\r\nRG_HDMITX_PRD_IBIAS_CLK |\r\nRG_HDMITX_PRD_IBIAS_D2 |\r\nRG_HDMITX_PRD_IBIAS_D1 |\r\nRG_HDMITX_PRD_IBIAS_D0);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON3,\r\n(imp_en << DRV_IMP_EN_SHIFT),\r\nRG_HDMITX_DRV_IMP_EN);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON6,\r\n(hdmi_phy->drv_imp_clk << DRV_IMP_CLK_SHIFT) |\r\n(hdmi_phy->drv_imp_d2 << DRV_IMP_D2_SHIFT) |\r\n(hdmi_phy->drv_imp_d1 << DRV_IMP_D1_SHIFT) |\r\n(hdmi_phy->drv_imp_d0 << DRV_IMP_D0_SHIFT),\r\nRG_HDMITX_DRV_IMP_CLK | RG_HDMITX_DRV_IMP_D2 |\r\nRG_HDMITX_DRV_IMP_D1 | RG_HDMITX_DRV_IMP_D0);\r\nmtk_hdmi_phy_mask(hdmi_phy, HDMI_CON5,\r\n(hdmi_ibias << DRV_IBIAS_CLK_SHIFT) |\r\n(hdmi_ibias << DRV_IBIAS_D2_SHIFT) |\r\n(hdmi_ibias << DRV_IBIAS_D1_SHIFT) |\r\n(hdmi_ibias << DRV_IBIAS_D0_SHIFT),\r\nRG_HDMITX_DRV_IBIAS_CLK |\r\nRG_HDMITX_DRV_IBIAS_D2 |\r\nRG_HDMITX_DRV_IBIAS_D1 |\r\nRG_HDMITX_DRV_IBIAS_D0);\r\nreturn 0;\r\n}\r\nstatic long mtk_hdmi_pll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\r\nhdmi_phy->pll_rate = rate;\r\nif (rate <= 74250000)\r\n*parent_rate = rate;\r\nelse\r\n*parent_rate = rate / 2;\r\nreturn rate;\r\n}\r\nstatic unsigned long mtk_hdmi_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\r\nreturn hdmi_phy->pll_rate;\r\n}\r\nstatic void mtk_hdmi_phy_enable_tmds(struct mtk_hdmi_phy *hdmi_phy)\r\n{\r\nmtk_hdmi_phy_set_bits(hdmi_phy, HDMI_CON3,\r\nRG_HDMITX_SER_EN | RG_HDMITX_PRD_EN |\r\nRG_HDMITX_DRV_EN);\r\nusleep_range(100, 150);\r\n}\r\nstatic void mtk_hdmi_phy_disable_tmds(struct mtk_hdmi_phy *hdmi_phy)\r\n{\r\nmtk_hdmi_phy_clear_bits(hdmi_phy, HDMI_CON3,\r\nRG_HDMITX_DRV_EN | RG_HDMITX_PRD_EN |\r\nRG_HDMITX_SER_EN);\r\n}\r\nstatic int mtk_hdmi_phy_power_on(struct phy *phy)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_prepare_enable(hdmi_phy->pll);\r\nif (ret < 0)\r\nreturn ret;\r\nmtk_hdmi_phy_enable_tmds(hdmi_phy);\r\nreturn 0;\r\n}\r\nstatic int mtk_hdmi_phy_power_off(struct phy *phy)\r\n{\r\nstruct mtk_hdmi_phy *hdmi_phy = phy_get_drvdata(phy);\r\nmtk_hdmi_phy_disable_tmds(hdmi_phy);\r\nclk_disable_unprepare(hdmi_phy->pll);\r\nreturn 0;\r\n}\r\nstatic int mtk_hdmi_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct mtk_hdmi_phy *hdmi_phy;\r\nstruct resource *mem;\r\nstruct clk *ref_clk;\r\nconst char *ref_clk_name;\r\nstruct clk_init_data clk_init = {\r\n.ops = &mtk_hdmi_pll_ops,\r\n.num_parents = 1,\r\n.parent_names = (const char * const *)&ref_clk_name,\r\n.flags = CLK_SET_RATE_PARENT | CLK_SET_RATE_GATE,\r\n};\r\nstruct phy *phy;\r\nstruct phy_provider *phy_provider;\r\nint ret;\r\nhdmi_phy = devm_kzalloc(dev, sizeof(*hdmi_phy), GFP_KERNEL);\r\nif (!hdmi_phy)\r\nreturn -ENOMEM;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhdmi_phy->regs = devm_ioremap_resource(dev, mem);\r\nif (IS_ERR(hdmi_phy->regs)) {\r\nret = PTR_ERR(hdmi_phy->regs);\r\ndev_err(dev, "Failed to get memory resource: %d\n", ret);\r\nreturn ret;\r\n}\r\nref_clk = devm_clk_get(dev, "pll_ref");\r\nif (IS_ERR(ref_clk)) {\r\nret = PTR_ERR(ref_clk);\r\ndev_err(&pdev->dev, "Failed to get PLL reference clock: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nref_clk_name = __clk_get_name(ref_clk);\r\nret = of_property_read_string(dev->of_node, "clock-output-names",\r\n&clk_init.name);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read clock-output-names: %d\n", ret);\r\nreturn ret;\r\n}\r\nhdmi_phy->pll_hw.init = &clk_init;\r\nhdmi_phy->pll = devm_clk_register(dev, &hdmi_phy->pll_hw);\r\nif (IS_ERR(hdmi_phy->pll)) {\r\nret = PTR_ERR(hdmi_phy->pll);\r\ndev_err(dev, "Failed to register PLL: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(dev->of_node, "mediatek,ibias",\r\n&hdmi_phy->ibias);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to get ibias: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(dev->of_node, "mediatek,ibias_up",\r\n&hdmi_phy->ibias_up);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to get ibias up: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_info(dev, "Using default TX DRV impedance: 4.2k/36\n");\r\nhdmi_phy->drv_imp_clk = 0x30;\r\nhdmi_phy->drv_imp_d2 = 0x30;\r\nhdmi_phy->drv_imp_d1 = 0x30;\r\nhdmi_phy->drv_imp_d0 = 0x30;\r\nphy = devm_phy_create(dev, NULL, &mtk_hdmi_phy_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(dev, "Failed to create HDMI PHY\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nphy_set_drvdata(phy, hdmi_phy);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nif (IS_ERR(phy_provider))\r\nreturn PTR_ERR(phy_provider);\r\nhdmi_phy->dev = dev;\r\nreturn of_clk_add_provider(dev->of_node, of_clk_src_simple_get,\r\nhdmi_phy->pll);\r\n}\r\nstatic int mtk_hdmi_phy_remove(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}

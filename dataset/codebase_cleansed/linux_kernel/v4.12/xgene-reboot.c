static int xgene_restart_handler(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct xgene_reboot_context *ctx =\r\ncontainer_of(this, struct xgene_reboot_context,\r\nrestart_handler);\r\nwritel(ctx->mask, ctx->csr);\r\nmdelay(1000);\r\ndev_emerg(ctx->dev, "Unable to restart system\n");\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int xgene_reboot_probe(struct platform_device *pdev)\r\n{\r\nstruct xgene_reboot_context *ctx;\r\nstruct device *dev = &pdev->dev;\r\nint err;\r\nctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->csr = of_iomap(dev->of_node, 0);\r\nif (!ctx->csr) {\r\ndev_err(dev, "can not map resource\n");\r\nreturn -ENODEV;\r\n}\r\nif (of_property_read_u32(dev->of_node, "mask", &ctx->mask))\r\nctx->mask = 0xFFFFFFFF;\r\nctx->dev = dev;\r\nctx->restart_handler.notifier_call = xgene_restart_handler;\r\nctx->restart_handler.priority = 128;\r\nerr = register_restart_handler(&ctx->restart_handler);\r\nif (err) {\r\niounmap(ctx->csr);\r\ndev_err(dev, "cannot register restart handler (err=%d)\n", err);\r\n}\r\nreturn err;\r\n}\r\nstatic int __init xgene_reboot_init(void)\r\n{\r\nreturn platform_driver_register(&xgene_reboot_driver);\r\n}

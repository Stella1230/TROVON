static inline u32 ipu_vdi_read(struct ipu_vdi *vdi, unsigned int offset)\r\n{\r\nreturn readl(vdi->base + offset);\r\n}\r\nstatic inline void ipu_vdi_write(struct ipu_vdi *vdi, u32 value,\r\nunsigned int offset)\r\n{\r\nwritel(value, vdi->base + offset);\r\n}\r\nvoid ipu_vdi_set_field_order(struct ipu_vdi *vdi, v4l2_std_id std, u32 field)\r\n{\r\nbool top_field_0 = false;\r\nunsigned long flags;\r\nu32 reg;\r\nswitch (field) {\r\ncase V4L2_FIELD_INTERLACED_TB:\r\ncase V4L2_FIELD_SEQ_TB:\r\ncase V4L2_FIELD_TOP:\r\ntop_field_0 = true;\r\nbreak;\r\ncase V4L2_FIELD_INTERLACED_BT:\r\ncase V4L2_FIELD_SEQ_BT:\r\ncase V4L2_FIELD_BOTTOM:\r\ntop_field_0 = false;\r\nbreak;\r\ndefault:\r\ntop_field_0 = (std & V4L2_STD_525_60) ? true : false;\r\nbreak;\r\n}\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nreg = ipu_vdi_read(vdi, VDI_C);\r\nif (top_field_0)\r\nreg &= ~VDI_C_TOP_FIELD_MAN_1;\r\nelse\r\nreg |= VDI_C_TOP_FIELD_MAN_1;\r\nipu_vdi_write(vdi, reg, VDI_C);\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\n}\r\nvoid ipu_vdi_set_motion(struct ipu_vdi *vdi, enum ipu_motion_sel motion_sel)\r\n{\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nreg = ipu_vdi_read(vdi, VDI_C);\r\nreg &= ~VDI_C_MOT_SEL_MASK;\r\nswitch (motion_sel) {\r\ncase MED_MOTION:\r\nreg |= VDI_C_MOT_SEL_MED;\r\nbreak;\r\ncase HIGH_MOTION:\r\nreg |= VDI_C_MOT_SEL_FULL;\r\nbreak;\r\ndefault:\r\nreg |= VDI_C_MOT_SEL_LOW;\r\nbreak;\r\n}\r\nipu_vdi_write(vdi, reg, VDI_C);\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\n}\r\nvoid ipu_vdi_setup(struct ipu_vdi *vdi, u32 code, int xres, int yres)\r\n{\r\nunsigned long flags;\r\nu32 pixel_fmt, reg;\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nreg = ((yres - 1) << 16) | (xres - 1);\r\nipu_vdi_write(vdi, reg, VDI_FSIZE);\r\nif (code == MEDIA_BUS_FMT_UYVY8_2X8 ||\r\ncode == MEDIA_BUS_FMT_UYVY8_1X16 ||\r\ncode == MEDIA_BUS_FMT_YUYV8_2X8 ||\r\ncode == MEDIA_BUS_FMT_YUYV8_1X16)\r\npixel_fmt = VDI_C_CH_422;\r\nelse\r\npixel_fmt = VDI_C_CH_420;\r\nreg = ipu_vdi_read(vdi, VDI_C);\r\nreg |= pixel_fmt;\r\nreg |= VDI_C_BURST_SIZE2_4;\r\nreg |= VDI_C_BURST_SIZE1_4 | VDI_C_VWM1_CLR_2;\r\nreg |= VDI_C_BURST_SIZE3_4 | VDI_C_VWM3_CLR_2;\r\nipu_vdi_write(vdi, reg, VDI_C);\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\n}\r\nvoid ipu_vdi_unsetup(struct ipu_vdi *vdi)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nipu_vdi_write(vdi, 0, VDI_FSIZE);\r\nipu_vdi_write(vdi, 0, VDI_C);\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\n}\r\nint ipu_vdi_enable(struct ipu_vdi *vdi)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nif (!vdi->use_count)\r\nipu_module_enable(vdi->ipu, vdi->module);\r\nvdi->use_count++;\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\nreturn 0;\r\n}\r\nint ipu_vdi_disable(struct ipu_vdi *vdi)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&vdi->lock, flags);\r\nif (vdi->use_count) {\r\nif (!--vdi->use_count)\r\nipu_module_disable(vdi->ipu, vdi->module);\r\n}\r\nspin_unlock_irqrestore(&vdi->lock, flags);\r\nreturn 0;\r\n}\r\nstruct ipu_vdi *ipu_vdi_get(struct ipu_soc *ipu)\r\n{\r\nreturn ipu->vdi_priv;\r\n}\r\nvoid ipu_vdi_put(struct ipu_vdi *vdi)\r\n{\r\n}\r\nint ipu_vdi_init(struct ipu_soc *ipu, struct device *dev,\r\nunsigned long base, u32 module)\r\n{\r\nstruct ipu_vdi *vdi;\r\nvdi = devm_kzalloc(dev, sizeof(*vdi), GFP_KERNEL);\r\nif (!vdi)\r\nreturn -ENOMEM;\r\nipu->vdi_priv = vdi;\r\nspin_lock_init(&vdi->lock);\r\nvdi->module = module;\r\nvdi->base = devm_ioremap(dev, base, PAGE_SIZE);\r\nif (!vdi->base)\r\nreturn -ENOMEM;\r\ndev_dbg(dev, "VDI base: 0x%08lx remapped to %p\n", base, vdi->base);\r\nvdi->ipu = ipu;\r\nreturn 0;\r\n}\r\nvoid ipu_vdi_exit(struct ipu_soc *ipu)\r\n{\r\n}

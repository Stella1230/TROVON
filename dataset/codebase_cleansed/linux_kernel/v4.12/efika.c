static int rtas_read_config(struct pci_bus *bus, unsigned int devfn, int offset,\r\nint len, u32 * val)\r\n{\r\nstruct pci_controller *hose = pci_bus_to_host(bus);\r\nunsigned long addr = (offset & 0xff) | ((devfn & 0xff) << 8)\r\n| (((bus->number - hose->first_busno) & 0xff) << 16)\r\n| (hose->global_number << 24);\r\nint ret = -1;\r\nint rval;\r\nrval = rtas_call(rtas_token("read-pci-config"), 2, 2, &ret, addr, len);\r\n*val = ret;\r\nreturn rval ? PCIBIOS_DEVICE_NOT_FOUND : PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int rtas_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint offset, int len, u32 val)\r\n{\r\nstruct pci_controller *hose = pci_bus_to_host(bus);\r\nunsigned long addr = (offset & 0xff) | ((devfn & 0xff) << 8)\r\n| (((bus->number - hose->first_busno) & 0xff) << 16)\r\n| (hose->global_number << 24);\r\nint rval;\r\nrval = rtas_call(rtas_token("write-pci-config"), 3, 1, NULL,\r\naddr, len, val);\r\nreturn rval ? PCIBIOS_DEVICE_NOT_FOUND : PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic void __init efika_pcisetup(void)\r\n{\r\nconst int *bus_range;\r\nint len;\r\nstruct pci_controller *hose;\r\nstruct device_node *root;\r\nstruct device_node *pcictrl;\r\nroot = of_find_node_by_path("/");\r\nif (root == NULL) {\r\nprintk(KERN_WARNING EFIKA_PLATFORM_NAME\r\n": Unable to find the root node\n");\r\nreturn;\r\n}\r\nfor (pcictrl = NULL;;) {\r\npcictrl = of_get_next_child(root, pcictrl);\r\nif ((pcictrl == NULL) || (strcmp(pcictrl->name, "pci") == 0))\r\nbreak;\r\n}\r\nof_node_put(root);\r\nif (pcictrl == NULL) {\r\nprintk(KERN_WARNING EFIKA_PLATFORM_NAME\r\n": Unable to find the PCI bridge node\n");\r\nreturn;\r\n}\r\nbus_range = of_get_property(pcictrl, "bus-range", &len);\r\nif (bus_range == NULL || len < 2 * sizeof(int)) {\r\nprintk(KERN_WARNING EFIKA_PLATFORM_NAME\r\n": Can't get bus-range for %s\n", pcictrl->full_name);\r\ngoto out_put;\r\n}\r\nif (bus_range[1] == bus_range[0])\r\nprintk(KERN_INFO EFIKA_PLATFORM_NAME ": PCI bus %d",\r\nbus_range[0]);\r\nelse\r\nprintk(KERN_INFO EFIKA_PLATFORM_NAME ": PCI buses %d..%d",\r\nbus_range[0], bus_range[1]);\r\nprintk(" controlled by %s\n", pcictrl->full_name);\r\nprintk("\n");\r\nhose = pcibios_alloc_controller(pcictrl);\r\nif (!hose) {\r\nprintk(KERN_WARNING EFIKA_PLATFORM_NAME\r\n": Can't allocate PCI controller structure for %s\n",\r\npcictrl->full_name);\r\ngoto out_put;\r\n}\r\nhose->first_busno = bus_range[0];\r\nhose->last_busno = bus_range[1];\r\nhose->ops = &rtas_pci_ops;\r\npci_process_bridge_OF_ranges(hose, pcictrl, 0);\r\nreturn;\r\nout_put:\r\nof_node_put(pcictrl);\r\n}\r\nstatic void __init efika_pcisetup(void)\r\n{}\r\nstatic void efika_show_cpuinfo(struct seq_file *m)\r\n{\r\nstruct device_node *root;\r\nconst char *revision;\r\nconst char *codegendescription;\r\nconst char *codegenvendor;\r\nroot = of_find_node_by_path("/");\r\nif (!root)\r\nreturn;\r\nrevision = of_get_property(root, "revision", NULL);\r\ncodegendescription = of_get_property(root, "CODEGEN,description", NULL);\r\ncodegenvendor = of_get_property(root, "CODEGEN,vendor", NULL);\r\nif (codegendescription)\r\nseq_printf(m, "machine\t\t: %s\n", codegendescription);\r\nelse\r\nseq_printf(m, "machine\t\t: Efika\n");\r\nif (revision)\r\nseq_printf(m, "revision\t: %s\n", revision);\r\nif (codegenvendor)\r\nseq_printf(m, "vendor\t\t: %s\n", codegenvendor);\r\nof_node_put(root);\r\n}\r\nstatic void efika_suspend_prepare(void __iomem *mbar)\r\n{\r\nu8 pin = 4;\r\nu8 level = 1;\r\nmpc52xx_set_wakeup_gpio(pin, level);\r\n}\r\nstatic void __init efika_setup_arch(void)\r\n{\r\nrtas_initialize();\r\nmpc52xx_map_common_devices();\r\nefika_pcisetup();\r\n#ifdef CONFIG_PM\r\nmpc52xx_suspend.board_suspend_prepare = efika_suspend_prepare;\r\nmpc52xx_pm_init();\r\n#endif\r\nif (ppc_md.progress)\r\nppc_md.progress("Linux/PPC " UTS_RELEASE " running on Efika ;-)\n", 0x0);\r\n}\r\nstatic int __init efika_probe(void)\r\n{\r\nconst char *model = of_get_property(of_root, "model", NULL);\r\nif (model == NULL)\r\nreturn 0;\r\nif (strcmp(model, "EFIKA5K2"))\r\nreturn 0;\r\nISA_DMA_THRESHOLD = ~0L;\r\nDMA_MODE_READ = 0x44;\r\nDMA_MODE_WRITE = 0x48;\r\npm_power_off = rtas_power_off;\r\nreturn 1;\r\n}

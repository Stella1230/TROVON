static int sq905c_command(struct gspca_dev *gspca_dev, u16 command, u16 index)\r\n{\r\nint ret;\r\nret = usb_control_msg(gspca_dev->dev,\r\nusb_sndctrlpipe(gspca_dev->dev, 0),\r\nUSB_REQ_SYNCH_FRAME,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\ncommand, index, NULL, 0,\r\nSQ905C_CMD_TIMEOUT);\r\nif (ret < 0) {\r\npr_err("%s: usb_control_msg failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sq905c_read(struct gspca_dev *gspca_dev, u16 command, u16 index,\r\nint size)\r\n{\r\nint ret;\r\nret = usb_control_msg(gspca_dev->dev,\r\nusb_rcvctrlpipe(gspca_dev->dev, 0),\r\nUSB_REQ_SYNCH_FRAME,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\ncommand, index, gspca_dev->usb_buf, size,\r\nSQ905C_CMD_TIMEOUT);\r\nif (ret < 0) {\r\npr_err("%s: usb_control_msg failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void sq905c_dostream(struct work_struct *work)\r\n{\r\nstruct sd *dev = container_of(work, struct sd, work_struct);\r\nstruct gspca_dev *gspca_dev = &dev->gspca_dev;\r\nint bytes_left;\r\nint data_len;\r\nint act_len;\r\nint packet_type;\r\nint ret;\r\nu8 *buffer;\r\nbuffer = kmalloc(SQ905C_MAX_TRANSFER, GFP_KERNEL | GFP_DMA);\r\nif (!buffer) {\r\npr_err("Couldn't allocate USB buffer\n");\r\ngoto quit_stream;\r\n}\r\nwhile (gspca_dev->present && gspca_dev->streaming) {\r\n#ifdef CONFIG_PM\r\nif (gspca_dev->frozen)\r\nbreak;\r\n#endif\r\nret = usb_bulk_msg(gspca_dev->dev,\r\nusb_rcvbulkpipe(gspca_dev->dev, 0x81),\r\nbuffer, FRAME_HEADER_LEN, &act_len,\r\nSQ905C_DATA_TIMEOUT);\r\nPDEBUG(D_STREAM,\r\n"Got %d bytes out of %d for header",\r\nact_len, FRAME_HEADER_LEN);\r\nif (ret < 0 || act_len < FRAME_HEADER_LEN)\r\ngoto quit_stream;\r\nbytes_left = buffer[0x40]|(buffer[0x41]<<8)|(buffer[0x42]<<16)\r\n|(buffer[0x43]<<24);\r\nPDEBUG(D_STREAM, "bytes_left = 0x%x", bytes_left);\r\npacket_type = FIRST_PACKET;\r\ngspca_frame_add(gspca_dev, packet_type,\r\nbuffer, FRAME_HEADER_LEN);\r\nwhile (bytes_left > 0 && gspca_dev->present) {\r\ndata_len = bytes_left > SQ905C_MAX_TRANSFER ?\r\nSQ905C_MAX_TRANSFER : bytes_left;\r\nret = usb_bulk_msg(gspca_dev->dev,\r\nusb_rcvbulkpipe(gspca_dev->dev, 0x81),\r\nbuffer, data_len, &act_len,\r\nSQ905C_DATA_TIMEOUT);\r\nif (ret < 0 || act_len < data_len)\r\ngoto quit_stream;\r\nPDEBUG(D_STREAM,\r\n"Got %d bytes out of %d for frame",\r\ndata_len, bytes_left);\r\nbytes_left -= data_len;\r\nif (bytes_left == 0)\r\npacket_type = LAST_PACKET;\r\nelse\r\npacket_type = INTER_PACKET;\r\ngspca_frame_add(gspca_dev, packet_type,\r\nbuffer, data_len);\r\n}\r\n}\r\nquit_stream:\r\nif (gspca_dev->present) {\r\nmutex_lock(&gspca_dev->usb_lock);\r\nsq905c_command(gspca_dev, SQ905C_CLEAR, 0);\r\nmutex_unlock(&gspca_dev->usb_lock);\r\n}\r\nkfree(buffer);\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct cam *cam = &gspca_dev->cam;\r\nstruct sd *dev = (struct sd *) gspca_dev;\r\nint ret;\r\nPDEBUG(D_PROBE,\r\n"SQ9050 camera detected (vid/pid 0x%04X:0x%04X)",\r\nid->idVendor, id->idProduct);\r\nret = sq905c_command(gspca_dev, SQ905C_GET_ID, 0);\r\nif (ret < 0) {\r\nPERR("Get version command failed");\r\nreturn ret;\r\n}\r\nret = sq905c_read(gspca_dev, 0xf5, 0, 20);\r\nif (ret < 0) {\r\nPERR("Reading version command failed");\r\nreturn ret;\r\n}\r\nPDEBUG(D_PROBE,\r\n"SQ9050 ID string: %02x - %*ph",\r\ngspca_dev->usb_buf[3], 6, gspca_dev->usb_buf + 14);\r\ncam->cam_mode = sq905c_mode;\r\ncam->nmodes = 2;\r\nif (gspca_dev->usb_buf[15] == 0)\r\ncam->nmodes = 1;\r\ncam->bulk_size = 32;\r\ncam->bulk = 1;\r\nINIT_WORK(&dev->work_struct, sq905c_dostream);\r\nreturn 0;\r\n}\r\nstatic void sd_stop0(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *dev = (struct sd *) gspca_dev;\r\nmutex_unlock(&gspca_dev->usb_lock);\r\ndestroy_workqueue(dev->work_thread);\r\ndev->work_thread = NULL;\r\nmutex_lock(&gspca_dev->usb_lock);\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nreturn sq905c_command(gspca_dev, SQ905C_CLEAR, 0);\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *dev = (struct sd *) gspca_dev;\r\nint ret;\r\ndev->cap_mode = gspca_dev->cam.cam_mode;\r\nswitch (gspca_dev->pixfmt.width) {\r\ncase 640:\r\nPDEBUG(D_STREAM, "Start streaming at high resolution");\r\ndev->cap_mode++;\r\nret = sq905c_command(gspca_dev, SQ905C_CAPTURE_HI,\r\nSQ905C_CAPTURE_INDEX);\r\nbreak;\r\ndefault:\r\nPDEBUG(D_STREAM, "Start streaming at medium resolution");\r\nret = sq905c_command(gspca_dev, SQ905C_CAPTURE_MED,\r\nSQ905C_CAPTURE_INDEX);\r\n}\r\nif (ret < 0) {\r\nPERR("Start streaming command failed");\r\nreturn ret;\r\n}\r\ndev->work_thread = create_singlethread_workqueue(MODULE_NAME);\r\nqueue_work(dev->work_thread, &dev->work_struct);\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id,\r\n&sd_desc,\r\nsizeof(struct sd),\r\nTHIS_MODULE);\r\n}

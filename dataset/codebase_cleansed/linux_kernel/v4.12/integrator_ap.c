static void __init ap_map_io(void)\r\n{\r\niotable_init(ap_io_desc, ARRAY_SIZE(ap_io_desc));\r\npci_v3_early_init();\r\n}\r\nstatic int irq_suspend(void)\r\n{\r\nic_irq_enable = readl(VA_IC_BASE + IRQ_ENABLE);\r\nreturn 0;\r\n}\r\nstatic void irq_resume(void)\r\n{\r\ncm_clear_irqs();\r\nwritel(-1, VA_IC_BASE + IRQ_ENABLE_CLEAR);\r\nwritel(-1, VA_IC_BASE + FIQ_ENABLE_CLEAR);\r\nwritel(ic_irq_enable, VA_IC_BASE + IRQ_ENABLE_SET);\r\n}\r\nstatic int __init irq_syscore_init(void)\r\n{\r\nregister_syscore_ops(&irq_syscore_ops);\r\nreturn 0;\r\n}\r\nstatic void integrator_uart_set_mctrl(struct amba_device *dev,\r\nvoid __iomem *base, unsigned int mctrl)\r\n{\r\nunsigned int ctrls = 0, ctrlc = 0, rts_mask, dtr_mask;\r\nu32 phybase = dev->res.start;\r\nint ret;\r\nif (phybase == INTEGRATOR_UART0_BASE) {\r\nrts_mask = 1 << 4;\r\ndtr_mask = 1 << 5;\r\n} else {\r\nrts_mask = 1 << 6;\r\ndtr_mask = 1 << 7;\r\n}\r\nif (mctrl & TIOCM_RTS)\r\nctrlc |= rts_mask;\r\nelse\r\nctrls |= rts_mask;\r\nif (mctrl & TIOCM_DTR)\r\nctrlc |= dtr_mask;\r\nelse\r\nctrls |= dtr_mask;\r\nret = regmap_write(ap_syscon_map,\r\nINTEGRATOR_SC_CTRLS_OFFSET,\r\nctrls);\r\nif (ret)\r\npr_err("MODEM: unable to write PL010 UART CTRLS\n");\r\nret = regmap_write(ap_syscon_map,\r\nINTEGRATOR_SC_CTRLC_OFFSET,\r\nctrlc);\r\nif (ret)\r\npr_err("MODEM: unable to write PL010 UART CRTLC\n");\r\n}\r\nvoid __init ap_init_early(void)\r\n{\r\n}\r\nstatic void __init ap_init_irq_of(void)\r\n{\r\ncm_init();\r\nirqchip_init();\r\n}\r\nstatic void __init ap_init_of(void)\r\n{\r\nu32 sc_dec;\r\nstruct device_node *syscon;\r\nint ret;\r\nint i;\r\nof_platform_default_populate(NULL, ap_auxdata_lookup, NULL);\r\nsyscon = of_find_matching_node(NULL, ap_syscon_match);\r\nif (!syscon)\r\nreturn;\r\nap_syscon_map = syscon_node_to_regmap(syscon);\r\nif (IS_ERR(ap_syscon_map)) {\r\npr_crit("could not find Integrator/AP system controller\n");\r\nreturn;\r\n}\r\nret = regmap_read(ap_syscon_map,\r\nINTEGRATOR_SC_DEC_OFFSET,\r\n&sc_dec);\r\nif (ret) {\r\npr_crit("could not read from Integrator/AP syscon\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nstruct lm_device *lmdev;\r\nif ((sc_dec & (16 << i)) == 0)\r\ncontinue;\r\nlmdev = kzalloc(sizeof(struct lm_device), GFP_KERNEL);\r\nif (!lmdev)\r\ncontinue;\r\nlmdev->resource.start = 0xc0000000 + 0x10000000 * i;\r\nlmdev->resource.end = lmdev->resource.start + 0x0fffffff;\r\nlmdev->resource.flags = IORESOURCE_MEM;\r\nlmdev->irq = irq_of_parse_and_map(syscon, i);\r\nlmdev->id = i;\r\nlm_device_register(lmdev);\r\n}\r\n}

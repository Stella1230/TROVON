static int __init ptdump_init(void)\r\n{\r\nreturn ptdump_debugfs_register(&efi_ptdump_info, "efi_page_tables");\r\n}\r\nstatic bool __init efi_virtmap_init(void)\r\n{\r\nefi_memory_desc_t *md;\r\nbool systab_found;\r\nefi_mm.pgd = pgd_alloc(&efi_mm);\r\nmm_init_cpumask(&efi_mm);\r\ninit_new_context(NULL, &efi_mm);\r\nsystab_found = false;\r\nfor_each_efi_memory_desc(md) {\r\nphys_addr_t phys = md->phys_addr;\r\nint ret;\r\nif (!(md->attribute & EFI_MEMORY_RUNTIME))\r\ncontinue;\r\nif (md->virt_addr == 0)\r\nreturn false;\r\nret = efi_create_mapping(&efi_mm, md);\r\nif (!ret) {\r\npr_info(" EFI remap %pa => %p\n",\r\n&phys, (void *)(unsigned long)md->virt_addr);\r\n} else {\r\npr_warn(" EFI remap %pa: failed to create mapping (%d)\n",\r\n&phys, ret);\r\nreturn false;\r\n}\r\nif (efi_system_table >= phys &&\r\nefi_system_table < phys + (md->num_pages * EFI_PAGE_SIZE)) {\r\nefi.systab = (void *)(unsigned long)(efi_system_table -\r\nphys + md->virt_addr);\r\nsystab_found = true;\r\n}\r\n}\r\nif (!systab_found) {\r\npr_err("No virtual mapping found for the UEFI System Table\n");\r\nreturn false;\r\n}\r\nif (efi_memattr_apply_permissions(&efi_mm, efi_set_mapping_permissions))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic int __init arm_enable_runtime_services(void)\r\n{\r\nu64 mapsize;\r\nif (!efi_enabled(EFI_BOOT)) {\r\npr_info("EFI services will not be available.\n");\r\nreturn 0;\r\n}\r\nif (efi_runtime_disabled()) {\r\npr_info("EFI runtime services will be disabled.\n");\r\nreturn 0;\r\n}\r\nif (efi_enabled(EFI_RUNTIME_SERVICES)) {\r\npr_info("EFI runtime services access via paravirt.\n");\r\nreturn 0;\r\n}\r\npr_info("Remapping and enabling EFI services.\n");\r\nmapsize = efi.memmap.desc_size * efi.memmap.nr_map;\r\nif (efi_memmap_init_late(efi.memmap.phys_map, mapsize)) {\r\npr_err("Failed to remap EFI memory map\n");\r\nreturn -ENOMEM;\r\n}\r\nif (!efi_virtmap_init()) {\r\npr_err("UEFI virtual mapping missing or invalid -- runtime services will not be available\n");\r\nreturn -ENOMEM;\r\n}\r\nefi_native_runtime_setup();\r\nset_bit(EFI_RUNTIME_SERVICES, &efi.flags);\r\nreturn 0;\r\n}\r\nvoid efi_virtmap_load(void)\r\n{\r\npreempt_disable();\r\nefi_set_pgd(&efi_mm);\r\n}\r\nvoid efi_virtmap_unload(void)\r\n{\r\nefi_set_pgd(current->active_mm);\r\npreempt_enable();\r\n}

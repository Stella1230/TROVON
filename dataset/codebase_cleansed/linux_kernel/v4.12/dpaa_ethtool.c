static int dpaa_get_link_ksettings(struct net_device *net_dev,\r\nstruct ethtool_link_ksettings *cmd)\r\n{\r\nint err;\r\nif (!net_dev->phydev) {\r\nnetdev_dbg(net_dev, "phy device not initialized\n");\r\nreturn 0;\r\n}\r\nerr = phy_ethtool_ksettings_get(net_dev->phydev, cmd);\r\nreturn err;\r\n}\r\nstatic int dpaa_set_link_ksettings(struct net_device *net_dev,\r\nconst struct ethtool_link_ksettings *cmd)\r\n{\r\nint err;\r\nif (!net_dev->phydev) {\r\nnetdev_err(net_dev, "phy device not initialized\n");\r\nreturn -ENODEV;\r\n}\r\nerr = phy_ethtool_ksettings_set(net_dev->phydev, cmd);\r\nif (err < 0)\r\nnetdev_err(net_dev, "phy_ethtool_ksettings_set() = %d\n", err);\r\nreturn err;\r\n}\r\nstatic void dpaa_get_drvinfo(struct net_device *net_dev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nint len;\r\nstrlcpy(drvinfo->driver, KBUILD_MODNAME,\r\nsizeof(drvinfo->driver));\r\nlen = snprintf(drvinfo->version, sizeof(drvinfo->version),\r\n"%X", 0);\r\nlen = snprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\r\n"%X", 0);\r\nif (len >= sizeof(drvinfo->fw_version)) {\r\nnetdev_notice(net_dev, "snprintf() = %d\n", len);\r\n}\r\nstrlcpy(drvinfo->bus_info, dev_name(net_dev->dev.parent->parent),\r\nsizeof(drvinfo->bus_info));\r\n}\r\nstatic u32 dpaa_get_msglevel(struct net_device *net_dev)\r\n{\r\nreturn ((struct dpaa_priv *)netdev_priv(net_dev))->msg_enable;\r\n}\r\nstatic void dpaa_set_msglevel(struct net_device *net_dev,\r\nu32 msg_enable)\r\n{\r\n((struct dpaa_priv *)netdev_priv(net_dev))->msg_enable = msg_enable;\r\n}\r\nstatic int dpaa_nway_reset(struct net_device *net_dev)\r\n{\r\nint err;\r\nif (!net_dev->phydev) {\r\nnetdev_err(net_dev, "phy device not initialized\n");\r\nreturn -ENODEV;\r\n}\r\nerr = 0;\r\nif (net_dev->phydev->autoneg) {\r\nerr = phy_start_aneg(net_dev->phydev);\r\nif (err < 0)\r\nnetdev_err(net_dev, "phy_start_aneg() = %d\n",\r\nerr);\r\n}\r\nreturn err;\r\n}\r\nstatic void dpaa_get_pauseparam(struct net_device *net_dev,\r\nstruct ethtool_pauseparam *epause)\r\n{\r\nstruct mac_device *mac_dev;\r\nstruct dpaa_priv *priv;\r\npriv = netdev_priv(net_dev);\r\nmac_dev = priv->mac_dev;\r\nif (!net_dev->phydev) {\r\nnetdev_err(net_dev, "phy device not initialized\n");\r\nreturn;\r\n}\r\nepause->autoneg = mac_dev->autoneg_pause;\r\nepause->rx_pause = mac_dev->rx_pause_active;\r\nepause->tx_pause = mac_dev->tx_pause_active;\r\n}\r\nstatic int dpaa_set_pauseparam(struct net_device *net_dev,\r\nstruct ethtool_pauseparam *epause)\r\n{\r\nstruct mac_device *mac_dev;\r\nstruct phy_device *phydev;\r\nbool rx_pause, tx_pause;\r\nstruct dpaa_priv *priv;\r\nu32 newadv, oldadv;\r\nint err;\r\npriv = netdev_priv(net_dev);\r\nmac_dev = priv->mac_dev;\r\nphydev = net_dev->phydev;\r\nif (!phydev) {\r\nnetdev_err(net_dev, "phy device not initialized\n");\r\nreturn -ENODEV;\r\n}\r\nif (!(phydev->supported & SUPPORTED_Pause) ||\r\n(!(phydev->supported & SUPPORTED_Asym_Pause) &&\r\n(epause->rx_pause != epause->tx_pause)))\r\nreturn -EINVAL;\r\nmac_dev->autoneg_pause = !!epause->autoneg;\r\nmac_dev->rx_pause_req = !!epause->rx_pause;\r\nmac_dev->tx_pause_req = !!epause->tx_pause;\r\nnewadv = 0;\r\nif (epause->rx_pause)\r\nnewadv = ADVERTISED_Pause | ADVERTISED_Asym_Pause;\r\nif (epause->tx_pause)\r\nnewadv |= ADVERTISED_Asym_Pause;\r\noldadv = phydev->advertising &\r\n(ADVERTISED_Pause | ADVERTISED_Asym_Pause);\r\nif (oldadv != newadv) {\r\nphydev->advertising &= ~(ADVERTISED_Pause\r\n| ADVERTISED_Asym_Pause);\r\nphydev->advertising |= newadv;\r\nif (phydev->autoneg) {\r\nerr = phy_start_aneg(phydev);\r\nif (err < 0)\r\nnetdev_err(net_dev, "phy_start_aneg() = %d\n",\r\nerr);\r\n}\r\n}\r\nfman_get_pause_cfg(mac_dev, &rx_pause, &tx_pause);\r\nerr = fman_set_mac_active_pause(mac_dev, rx_pause, tx_pause);\r\nif (err < 0)\r\nnetdev_err(net_dev, "set_mac_active_pause() = %d\n", err);\r\nreturn err;\r\n}\r\nstatic int dpaa_get_sset_count(struct net_device *net_dev, int type)\r\n{\r\nunsigned int total_stats, num_stats;\r\nnum_stats = num_online_cpus() + 1;\r\ntotal_stats = num_stats * (DPAA_STATS_PERCPU_LEN + DPAA_BPS_NUM) +\r\nDPAA_STATS_GLOBAL_LEN;\r\nswitch (type) {\r\ncase ETH_SS_STATS:\r\nreturn total_stats;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic void copy_stats(struct dpaa_percpu_priv *percpu_priv, int num_cpus,\r\nint crr_cpu, u64 *bp_count, u64 *data)\r\n{\r\nint num_values = num_cpus + 1;\r\nint crr = 0, j;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->in_interrupt;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->in_interrupt;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->stats.rx_packets;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->stats.rx_packets;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->stats.tx_packets;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->stats.tx_packets;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->tx_confirm;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->tx_confirm;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->tx_frag_skbuffs;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->tx_frag_skbuffs;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->stats.tx_errors;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->stats.tx_errors;\r\ndata[crr * num_values + crr_cpu] = percpu_priv->stats.rx_errors;\r\ndata[crr++ * num_values + num_cpus] += percpu_priv->stats.rx_errors;\r\nfor (j = 0; j < DPAA_BPS_NUM; j++) {\r\ndata[crr * num_values + crr_cpu] = bp_count[j];\r\ndata[crr++ * num_values + num_cpus] += bp_count[j];\r\n}\r\n}\r\nstatic void dpaa_get_ethtool_stats(struct net_device *net_dev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nu64 bp_count[DPAA_BPS_NUM], cg_time, cg_num;\r\nstruct dpaa_percpu_priv *percpu_priv;\r\nstruct dpaa_rx_errors rx_errors;\r\nunsigned int num_cpus, offset;\r\nstruct dpaa_ern_cnt ern_cnt;\r\nstruct dpaa_bp *dpaa_bp;\r\nstruct dpaa_priv *priv;\r\nint total_stats, i, j;\r\nbool cg_status;\r\ntotal_stats = dpaa_get_sset_count(net_dev, ETH_SS_STATS);\r\npriv = netdev_priv(net_dev);\r\nnum_cpus = num_online_cpus();\r\nmemset(&bp_count, 0, sizeof(bp_count));\r\nmemset(&rx_errors, 0, sizeof(struct dpaa_rx_errors));\r\nmemset(&ern_cnt, 0, sizeof(struct dpaa_ern_cnt));\r\nmemset(data, 0, total_stats * sizeof(u64));\r\nfor_each_online_cpu(i) {\r\npercpu_priv = per_cpu_ptr(priv->percpu_priv, i);\r\nfor (j = 0; j < DPAA_BPS_NUM; j++) {\r\ndpaa_bp = priv->dpaa_bps[j];\r\nif (!dpaa_bp->percpu_count)\r\ncontinue;\r\nbp_count[j] = *(per_cpu_ptr(dpaa_bp->percpu_count, i));\r\n}\r\nrx_errors.dme += percpu_priv->rx_errors.dme;\r\nrx_errors.fpe += percpu_priv->rx_errors.fpe;\r\nrx_errors.fse += percpu_priv->rx_errors.fse;\r\nrx_errors.phe += percpu_priv->rx_errors.phe;\r\nern_cnt.cg_tdrop += percpu_priv->ern_cnt.cg_tdrop;\r\nern_cnt.wred += percpu_priv->ern_cnt.wred;\r\nern_cnt.err_cond += percpu_priv->ern_cnt.err_cond;\r\nern_cnt.early_window += percpu_priv->ern_cnt.early_window;\r\nern_cnt.late_window += percpu_priv->ern_cnt.late_window;\r\nern_cnt.fq_tdrop += percpu_priv->ern_cnt.fq_tdrop;\r\nern_cnt.fq_retired += percpu_priv->ern_cnt.fq_retired;\r\nern_cnt.orp_zero += percpu_priv->ern_cnt.orp_zero;\r\ncopy_stats(percpu_priv, num_cpus, i, bp_count, data);\r\n}\r\noffset = (num_cpus + 1) * (DPAA_STATS_PERCPU_LEN + DPAA_BPS_NUM);\r\nmemcpy(data + offset, &rx_errors, sizeof(struct dpaa_rx_errors));\r\noffset += sizeof(struct dpaa_rx_errors) / sizeof(u64);\r\nmemcpy(data + offset, &ern_cnt, sizeof(struct dpaa_ern_cnt));\r\ncg_num = 0;\r\ncg_status = 0;\r\ncg_time = jiffies_to_msecs(priv->cgr_data.congested_jiffies);\r\nif (qman_query_cgr_congested(&priv->cgr_data.cgr, &cg_status) == 0) {\r\ncg_num = priv->cgr_data.cgr_congested_count;\r\npriv->cgr_data.congested_jiffies = 0;\r\npriv->cgr_data.cgr_congested_count = 0;\r\n}\r\noffset += sizeof(struct dpaa_ern_cnt) / sizeof(u64);\r\ndata[offset++] = cg_time;\r\ndata[offset++] = cg_num;\r\ndata[offset++] = cg_status;\r\n}\r\nstatic void dpaa_get_strings(struct net_device *net_dev, u32 stringset,\r\nu8 *data)\r\n{\r\nunsigned int i, j, num_cpus, size;\r\nchar string_cpu[ETH_GSTRING_LEN];\r\nu8 *strings;\r\nmemset(string_cpu, 0, sizeof(string_cpu));\r\nstrings = data;\r\nnum_cpus = num_online_cpus();\r\nsize = DPAA_STATS_GLOBAL_LEN * ETH_GSTRING_LEN;\r\nfor (i = 0; i < DPAA_STATS_PERCPU_LEN; i++) {\r\nfor (j = 0; j < num_cpus; j++) {\r\nsnprintf(string_cpu, ETH_GSTRING_LEN, "%s [CPU %d]",\r\ndpaa_stats_percpu[i], j);\r\nmemcpy(strings, string_cpu, ETH_GSTRING_LEN);\r\nstrings += ETH_GSTRING_LEN;\r\n}\r\nsnprintf(string_cpu, ETH_GSTRING_LEN, "%s [TOTAL]",\r\ndpaa_stats_percpu[i]);\r\nmemcpy(strings, string_cpu, ETH_GSTRING_LEN);\r\nstrings += ETH_GSTRING_LEN;\r\n}\r\nfor (i = 0; i < DPAA_BPS_NUM; i++) {\r\nfor (j = 0; j < num_cpus; j++) {\r\nsnprintf(string_cpu, ETH_GSTRING_LEN,\r\n"bpool %c [CPU %d]", 'a' + i, j);\r\nmemcpy(strings, string_cpu, ETH_GSTRING_LEN);\r\nstrings += ETH_GSTRING_LEN;\r\n}\r\nsnprintf(string_cpu, ETH_GSTRING_LEN, "bpool %c [TOTAL]",\r\n'a' + i);\r\nmemcpy(strings, string_cpu, ETH_GSTRING_LEN);\r\nstrings += ETH_GSTRING_LEN;\r\n}\r\nmemcpy(strings, dpaa_stats_global, size);\r\n}

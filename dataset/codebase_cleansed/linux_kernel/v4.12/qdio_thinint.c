static u32 *get_indicator(void)\r\n{\r\nint i;\r\nfor (i = 0; i < TIQDIO_NR_NONSHARED_IND; i++)\r\nif (!atomic_read(&q_indicators[i].count)) {\r\natomic_set(&q_indicators[i].count, 1);\r\nreturn &q_indicators[i].ind;\r\n}\r\natomic_inc(&q_indicators[TIQDIO_SHARED_IND].count);\r\nreturn &q_indicators[TIQDIO_SHARED_IND].ind;\r\n}\r\nstatic void put_indicator(u32 *addr)\r\n{\r\nint i;\r\nif (!addr)\r\nreturn;\r\ni = ((unsigned long)addr - (unsigned long)q_indicators) /\r\nsizeof(struct indicator_t);\r\natomic_dec(&q_indicators[i].count);\r\n}\r\nvoid tiqdio_add_input_queues(struct qdio_irq *irq_ptr)\r\n{\r\nmutex_lock(&tiq_list_lock);\r\nlist_add_rcu(&irq_ptr->input_qs[0]->entry, &tiq_list);\r\nmutex_unlock(&tiq_list_lock);\r\nxchg(irq_ptr->dsci, 1 << 7);\r\n}\r\nvoid tiqdio_remove_input_queues(struct qdio_irq *irq_ptr)\r\n{\r\nstruct qdio_q *q;\r\nq = irq_ptr->input_qs[0];\r\nif (!q || !q->entry.prev || !q->entry.next)\r\nreturn;\r\nmutex_lock(&tiq_list_lock);\r\nlist_del_rcu(&q->entry);\r\nmutex_unlock(&tiq_list_lock);\r\nsynchronize_rcu();\r\n}\r\nstatic inline int has_multiple_inq_on_dsci(struct qdio_irq *irq_ptr)\r\n{\r\nreturn irq_ptr->nr_input_qs > 1;\r\n}\r\nstatic inline int references_shared_dsci(struct qdio_irq *irq_ptr)\r\n{\r\nreturn irq_ptr->dsci == &q_indicators[TIQDIO_SHARED_IND].ind;\r\n}\r\nstatic inline int shared_ind(struct qdio_irq *irq_ptr)\r\n{\r\nreturn references_shared_dsci(irq_ptr) ||\r\nhas_multiple_inq_on_dsci(irq_ptr);\r\n}\r\nvoid clear_nonshared_ind(struct qdio_irq *irq_ptr)\r\n{\r\nif (!is_thinint_irq(irq_ptr))\r\nreturn;\r\nif (shared_ind(irq_ptr))\r\nreturn;\r\nxchg(irq_ptr->dsci, 0);\r\n}\r\nint test_nonshared_ind(struct qdio_irq *irq_ptr)\r\n{\r\nif (!is_thinint_irq(irq_ptr))\r\nreturn 0;\r\nif (shared_ind(irq_ptr))\r\nreturn 0;\r\nif (*irq_ptr->dsci)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic inline u32 clear_shared_ind(void)\r\n{\r\nif (!atomic_read(&q_indicators[TIQDIO_SHARED_IND].count))\r\nreturn 0;\r\nreturn xchg(&q_indicators[TIQDIO_SHARED_IND].ind, 0);\r\n}\r\nstatic inline void tiqdio_call_inq_handlers(struct qdio_irq *irq)\r\n{\r\nstruct qdio_q *q;\r\nint i;\r\nif (!references_shared_dsci(irq) &&\r\nhas_multiple_inq_on_dsci(irq))\r\nxchg(irq->dsci, 0);\r\nfor_each_input_queue(irq, q, i) {\r\nif (q->u.in.queue_start_poll) {\r\nif (test_and_set_bit(QDIO_QUEUE_IRQS_DISABLED,\r\n&q->u.in.queue_irq_state)) {\r\nqperf_inc(q, int_discarded);\r\ncontinue;\r\n}\r\nq->u.in.queue_start_poll(irq->cdev, q->nr,\r\nirq->int_parm);\r\n} else {\r\nif (!shared_ind(irq))\r\nxchg(irq->dsci, 0);\r\ntasklet_schedule(&q->tasklet);\r\n}\r\n}\r\n}\r\nstatic void tiqdio_thinint_handler(struct airq_struct *airq)\r\n{\r\nu32 si_used = clear_shared_ind();\r\nstruct qdio_q *q;\r\nlast_ai_time = S390_lowcore.int_clock;\r\ninc_irq_stat(IRQIO_QAI);\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(q, &tiq_list, entry) {\r\nstruct qdio_irq *irq;\r\nirq = q->irq_ptr;\r\nif (unlikely(references_shared_dsci(irq))) {\r\nif (!si_used)\r\ncontinue;\r\n} else if (!*irq->dsci)\r\ncontinue;\r\ntiqdio_call_inq_handlers(irq);\r\nqperf_inc(q, adapter_int);\r\n}\r\nrcu_read_unlock();\r\n}\r\nstatic int set_subchannel_ind(struct qdio_irq *irq_ptr, int reset)\r\n{\r\nstruct chsc_scssc_area *scssc = (void *)irq_ptr->chsc_page;\r\nu64 summary_indicator_addr, subchannel_indicator_addr;\r\nint rc;\r\nif (reset) {\r\nsummary_indicator_addr = 0;\r\nsubchannel_indicator_addr = 0;\r\n} else {\r\nsummary_indicator_addr = virt_to_phys(tiqdio_airq.lsi_ptr);\r\nsubchannel_indicator_addr = virt_to_phys(irq_ptr->dsci);\r\n}\r\nrc = chsc_sadc(irq_ptr->schid, scssc, summary_indicator_addr,\r\nsubchannel_indicator_addr);\r\nif (rc) {\r\nDBF_ERROR("%4x SSI r:%4x", irq_ptr->schid.sch_no,\r\nscssc->response.code);\r\ngoto out;\r\n}\r\nDBF_EVENT("setscind");\r\nDBF_HEX(&summary_indicator_addr, sizeof(summary_indicator_addr));\r\nDBF_HEX(&subchannel_indicator_addr, sizeof(subchannel_indicator_addr));\r\nout:\r\nreturn rc;\r\n}\r\nint __init tiqdio_allocate_memory(void)\r\n{\r\nq_indicators = kzalloc(sizeof(struct indicator_t) * TIQDIO_NR_INDICATORS,\r\nGFP_KERNEL);\r\nif (!q_indicators)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid tiqdio_free_memory(void)\r\n{\r\nkfree(q_indicators);\r\n}\r\nint __init tiqdio_register_thinints(void)\r\n{\r\nint rc;\r\nrc = register_adapter_interrupt(&tiqdio_airq);\r\nif (rc) {\r\nDBF_EVENT("RTI:%x", rc);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nint qdio_establish_thinint(struct qdio_irq *irq_ptr)\r\n{\r\nif (!is_thinint_irq(irq_ptr))\r\nreturn 0;\r\nreturn set_subchannel_ind(irq_ptr, 0);\r\n}\r\nvoid qdio_setup_thinint(struct qdio_irq *irq_ptr)\r\n{\r\nif (!is_thinint_irq(irq_ptr))\r\nreturn;\r\nirq_ptr->dsci = get_indicator();\r\nDBF_HEX(&irq_ptr->dsci, sizeof(void *));\r\n}\r\nvoid qdio_shutdown_thinint(struct qdio_irq *irq_ptr)\r\n{\r\nif (!is_thinint_irq(irq_ptr))\r\nreturn;\r\nset_subchannel_ind(irq_ptr, 1);\r\nput_indicator(irq_ptr->dsci);\r\n}\r\nvoid __exit tiqdio_unregister_thinints(void)\r\n{\r\nWARN_ON(!list_empty(&tiq_list));\r\nunregister_adapter_interrupt(&tiqdio_airq);\r\n}

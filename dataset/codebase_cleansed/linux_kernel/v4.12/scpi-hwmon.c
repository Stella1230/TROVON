static int scpi_read_temp(void *dev, int *temp)\r\n{\r\nstruct scpi_thermal_zone *zone = dev;\r\nstruct scpi_sensors *scpi_sensors = zone->scpi_sensors;\r\nstruct scpi_ops *scpi_ops = scpi_sensors->scpi_ops;\r\nstruct sensor_data *sensor = &scpi_sensors->data[zone->sensor_id];\r\nu64 value;\r\nint ret;\r\nret = scpi_ops->sensor_get_value(sensor->info.sensor_id, &value);\r\nif (ret)\r\nreturn ret;\r\n*temp = value;\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nscpi_show_sensor(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct scpi_sensors *scpi_sensors = dev_get_drvdata(dev);\r\nstruct scpi_ops *scpi_ops = scpi_sensors->scpi_ops;\r\nstruct sensor_data *sensor;\r\nu64 value;\r\nint ret;\r\nsensor = container_of(attr, struct sensor_data, dev_attr_input);\r\nret = scpi_ops->sensor_get_value(sensor->info.sensor_id, &value);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%llu\n", value);\r\n}\r\nstatic ssize_t\r\nscpi_show_label(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct sensor_data *sensor;\r\nsensor = container_of(attr, struct sensor_data, dev_attr_label);\r\nreturn sprintf(buf, "%s\n", sensor->info.name);\r\n}\r\nstatic int scpi_hwmon_probe(struct platform_device *pdev)\r\n{\r\nu16 nr_sensors, i;\r\nint num_temp = 0, num_volt = 0, num_current = 0, num_power = 0;\r\nint num_energy = 0;\r\nstruct scpi_ops *scpi_ops;\r\nstruct device *hwdev, *dev = &pdev->dev;\r\nstruct scpi_sensors *scpi_sensors;\r\nint idx, ret;\r\nscpi_ops = get_scpi_ops();\r\nif (!scpi_ops)\r\nreturn -EPROBE_DEFER;\r\nret = scpi_ops->sensor_get_capability(&nr_sensors);\r\nif (ret)\r\nreturn ret;\r\nif (!nr_sensors)\r\nreturn -ENODEV;\r\nscpi_sensors = devm_kzalloc(dev, sizeof(*scpi_sensors), GFP_KERNEL);\r\nif (!scpi_sensors)\r\nreturn -ENOMEM;\r\nscpi_sensors->data = devm_kcalloc(dev, nr_sensors,\r\nsizeof(*scpi_sensors->data), GFP_KERNEL);\r\nif (!scpi_sensors->data)\r\nreturn -ENOMEM;\r\nscpi_sensors->attrs = devm_kcalloc(dev, (nr_sensors * 2) + 1,\r\nsizeof(*scpi_sensors->attrs), GFP_KERNEL);\r\nif (!scpi_sensors->attrs)\r\nreturn -ENOMEM;\r\nscpi_sensors->scpi_ops = scpi_ops;\r\nfor (i = 0, idx = 0; i < nr_sensors; i++) {\r\nstruct sensor_data *sensor = &scpi_sensors->data[idx];\r\nret = scpi_ops->sensor_get_info(i, &sensor->info);\r\nif (ret)\r\nreturn ret;\r\nswitch (sensor->info.class) {\r\ncase TEMPERATURE:\r\nsnprintf(sensor->input, sizeof(sensor->input),\r\n"temp%d_input", num_temp + 1);\r\nsnprintf(sensor->label, sizeof(sensor->input),\r\n"temp%d_label", num_temp + 1);\r\nnum_temp++;\r\nbreak;\r\ncase VOLTAGE:\r\nsnprintf(sensor->input, sizeof(sensor->input),\r\n"in%d_input", num_volt);\r\nsnprintf(sensor->label, sizeof(sensor->input),\r\n"in%d_label", num_volt);\r\nnum_volt++;\r\nbreak;\r\ncase CURRENT:\r\nsnprintf(sensor->input, sizeof(sensor->input),\r\n"curr%d_input", num_current + 1);\r\nsnprintf(sensor->label, sizeof(sensor->input),\r\n"curr%d_label", num_current + 1);\r\nnum_current++;\r\nbreak;\r\ncase POWER:\r\nsnprintf(sensor->input, sizeof(sensor->input),\r\n"power%d_input", num_power + 1);\r\nsnprintf(sensor->label, sizeof(sensor->input),\r\n"power%d_label", num_power + 1);\r\nnum_power++;\r\nbreak;\r\ncase ENERGY:\r\nsnprintf(sensor->input, sizeof(sensor->input),\r\n"energy%d_input", num_energy + 1);\r\nsnprintf(sensor->label, sizeof(sensor->input),\r\n"energy%d_label", num_energy + 1);\r\nnum_energy++;\r\nbreak;\r\ndefault:\r\ncontinue;\r\n}\r\nsensor->dev_attr_input.attr.mode = S_IRUGO;\r\nsensor->dev_attr_input.show = scpi_show_sensor;\r\nsensor->dev_attr_input.attr.name = sensor->input;\r\nsensor->dev_attr_label.attr.mode = S_IRUGO;\r\nsensor->dev_attr_label.show = scpi_show_label;\r\nsensor->dev_attr_label.attr.name = sensor->label;\r\nscpi_sensors->attrs[idx << 1] = &sensor->dev_attr_input.attr;\r\nscpi_sensors->attrs[(idx << 1) + 1] = &sensor->dev_attr_label.attr;\r\nsysfs_attr_init(scpi_sensors->attrs[idx << 1]);\r\nsysfs_attr_init(scpi_sensors->attrs[(idx << 1) + 1]);\r\nidx++;\r\n}\r\nscpi_sensors->group.attrs = scpi_sensors->attrs;\r\nscpi_sensors->groups[0] = &scpi_sensors->group;\r\nplatform_set_drvdata(pdev, scpi_sensors);\r\nhwdev = devm_hwmon_device_register_with_groups(dev,\r\n"scpi_sensors", scpi_sensors, scpi_sensors->groups);\r\nif (IS_ERR(hwdev))\r\nreturn PTR_ERR(hwdev);\r\nINIT_LIST_HEAD(&scpi_sensors->thermal_zones);\r\nfor (i = 0; i < nr_sensors; i++) {\r\nstruct sensor_data *sensor = &scpi_sensors->data[i];\r\nstruct thermal_zone_device *z;\r\nstruct scpi_thermal_zone *zone;\r\nif (sensor->info.class != TEMPERATURE)\r\ncontinue;\r\nzone = devm_kzalloc(dev, sizeof(*zone), GFP_KERNEL);\r\nif (!zone)\r\nreturn -ENOMEM;\r\nzone->sensor_id = i;\r\nzone->scpi_sensors = scpi_sensors;\r\nz = devm_thermal_zone_of_sensor_register(dev,\r\nsensor->info.sensor_id,\r\nzone,\r\n&scpi_sensor_ops);\r\nif (IS_ERR(z)) {\r\ndevm_kfree(dev, zone);\r\ncontinue;\r\n}\r\n}\r\nreturn 0;\r\n}

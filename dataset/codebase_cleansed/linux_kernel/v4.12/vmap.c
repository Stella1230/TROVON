u32\r\nnvbios_vmap_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct bit_entry bit_P;\r\nu32 vmap = 0;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2) {\r\nvmap = nvbios_rd32(bios, bit_P.offset + 0x20);\r\nif (vmap) {\r\n*ver = nvbios_rd08(bios, vmap + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\ncase 0x20:\r\n*hdr = nvbios_rd08(bios, vmap + 1);\r\n*cnt = nvbios_rd08(bios, vmap + 3);\r\n*len = nvbios_rd08(bios, vmap + 2);\r\nreturn vmap;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_vmap_parse(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_vmap *info)\r\n{\r\nu32 vmap = nvbios_vmap_table(bios, ver, hdr, cnt, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!vmap * *ver) {\r\ncase 0x10:\r\ninfo->max0 = 0xff;\r\ninfo->max1 = 0xff;\r\ninfo->max2 = 0xff;\r\nbreak;\r\ncase 0x20:\r\ninfo->max0 = nvbios_rd08(bios, vmap + 0x7);\r\ninfo->max1 = nvbios_rd08(bios, vmap + 0x8);\r\nif (*len >= 0xc)\r\ninfo->max2 = nvbios_rd08(bios, vmap + 0xc);\r\nelse\r\ninfo->max2 = 0xff;\r\nbreak;\r\n}\r\nreturn vmap;\r\n}\r\nu32\r\nnvbios_vmap_entry(struct nvkm_bios *bios, int idx, u8 *ver, u8 *len)\r\n{\r\nu8 hdr, cnt;\r\nu32 vmap = nvbios_vmap_table(bios, ver, &hdr, &cnt, len);\r\nif (vmap && idx < cnt) {\r\nvmap = vmap + hdr + (idx * *len);\r\nreturn vmap;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_vmap_entry_parse(struct nvkm_bios *bios, int idx, u8 *ver, u8 *len,\r\nstruct nvbios_vmap_entry *info)\r\n{\r\nu32 vmap = nvbios_vmap_entry(bios, idx, ver, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!vmap * *ver) {\r\ncase 0x10:\r\ninfo->link = 0xff;\r\ninfo->min = nvbios_rd32(bios, vmap + 0x00);\r\ninfo->max = nvbios_rd32(bios, vmap + 0x04);\r\ninfo->arg[0] = nvbios_rd32(bios, vmap + 0x08);\r\ninfo->arg[1] = nvbios_rd32(bios, vmap + 0x0c);\r\ninfo->arg[2] = nvbios_rd32(bios, vmap + 0x10);\r\nbreak;\r\ncase 0x20:\r\ninfo->mode = nvbios_rd08(bios, vmap + 0x00);\r\ninfo->link = nvbios_rd08(bios, vmap + 0x01);\r\ninfo->min = nvbios_rd32(bios, vmap + 0x02);\r\ninfo->max = nvbios_rd32(bios, vmap + 0x06);\r\ninfo->arg[0] = nvbios_rd32(bios, vmap + 0x0a);\r\ninfo->arg[1] = nvbios_rd32(bios, vmap + 0x0e);\r\ninfo->arg[2] = nvbios_rd32(bios, vmap + 0x12);\r\ninfo->arg[3] = nvbios_rd32(bios, vmap + 0x16);\r\ninfo->arg[4] = nvbios_rd32(bios, vmap + 0x1a);\r\ninfo->arg[5] = nvbios_rd32(bios, vmap + 0x1e);\r\nbreak;\r\n}\r\nreturn vmap;\r\n}

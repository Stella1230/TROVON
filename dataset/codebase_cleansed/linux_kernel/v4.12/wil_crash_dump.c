static int wil_fw_get_crash_dump_bounds(struct wil6210_priv *wil,\r\nu32 *out_dump_size, u32 *out_host_min)\r\n{\r\nint i;\r\nconst struct fw_map *map;\r\nu32 host_min, host_max, tmp_max;\r\nif (!out_dump_size)\r\nreturn -EINVAL;\r\nBUILD_BUG_ON(ARRAY_SIZE(fw_mapping) == 0);\r\nmap = &fw_mapping[0];\r\nhost_min = map->host;\r\nhost_max = map->host + (map->to - map->from);\r\nfor (i = 1; i < ARRAY_SIZE(fw_mapping); i++) {\r\nmap = &fw_mapping[i];\r\nif (!map->fw)\r\ncontinue;\r\nif (map->host < host_min)\r\nhost_min = map->host;\r\ntmp_max = map->host + (map->to - map->from);\r\nif (tmp_max > host_max)\r\nhost_max = tmp_max;\r\n}\r\n*out_dump_size = host_max - host_min;\r\nif (out_host_min)\r\n*out_host_min = host_min;\r\nreturn 0;\r\n}\r\nint wil_fw_copy_crash_dump(struct wil6210_priv *wil, void *dest, u32 size)\r\n{\r\nint i;\r\nconst struct fw_map *map;\r\nvoid *data;\r\nu32 host_min, dump_size, offset, len;\r\nif (wil_fw_get_crash_dump_bounds(wil, &dump_size, &host_min)) {\r\nwil_err(wil, "fail to obtain crash dump size\n");\r\nreturn -EINVAL;\r\n}\r\nif (dump_size > size) {\r\nwil_err(wil, "not enough space for dump. Need %d have %d\n",\r\ndump_size, size);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(fw_mapping); i++) {\r\nmap = &fw_mapping[i];\r\nif (!map->fw)\r\ncontinue;\r\ndata = (void * __force)wil->csr + HOSTADDR(map->host);\r\nlen = map->to - map->from;\r\noffset = map->host - host_min;\r\nwil_dbg_misc(wil,\r\n"fw_copy_crash_dump: - dump %s, size %d, offset %d\n",\r\nfw_mapping[i].name, len, offset);\r\nwil_memcpy_fromio_32((void * __force)(dest + offset),\r\n(const void __iomem * __force)data, len);\r\n}\r\nreturn 0;\r\n}\r\nvoid wil_fw_core_dump(struct wil6210_priv *wil)\r\n{\r\nvoid *fw_dump_data;\r\nu32 fw_dump_size;\r\nif (wil_fw_get_crash_dump_bounds(wil, &fw_dump_size, NULL)) {\r\nwil_err(wil, "fail to get fw dump size\n");\r\nreturn;\r\n}\r\nfw_dump_data = vzalloc(fw_dump_size);\r\nif (!fw_dump_data)\r\nreturn;\r\nif (wil_fw_copy_crash_dump(wil, fw_dump_data, fw_dump_size)) {\r\nvfree(fw_dump_data);\r\nreturn;\r\n}\r\ndev_coredumpv(wil_to_dev(wil), fw_dump_data, fw_dump_size, GFP_KERNEL);\r\nwil_info(wil, "fw core dumped, size %d bytes\n", fw_dump_size);\r\n}

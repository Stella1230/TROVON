const char *rnc_state_name(enum scis_sds_remote_node_context_states state)\r\n{\r\nstatic const char * const strings[] = RNC_STATES;\r\nif (state >= ARRAY_SIZE(strings))\r\nreturn "UNKNOWN";\r\nreturn strings[state];\r\n}\r\nbool sci_remote_node_context_is_ready(\r\nstruct sci_remote_node_context *sci_rnc)\r\n{\r\nu32 current_state = sci_rnc->sm.current_state_id;\r\nif (current_state == SCI_RNC_READY) {\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nbool sci_remote_node_context_is_suspended(struct sci_remote_node_context *sci_rnc)\r\n{\r\nu32 current_state = sci_rnc->sm.current_state_id;\r\nif (current_state == SCI_RNC_TX_RX_SUSPENDED)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic union scu_remote_node_context *sci_rnc_by_id(struct isci_host *ihost, u16 id)\r\n{\r\nif (id < ihost->remote_node_entries &&\r\nihost->device_table[id])\r\nreturn &ihost->remote_node_context_table[id];\r\nreturn NULL;\r\n}\r\nstatic void sci_remote_node_context_construct_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct domain_device *dev = idev->domain_dev;\r\nint rni = sci_rnc->remote_node_index;\r\nunion scu_remote_node_context *rnc;\r\nstruct isci_host *ihost;\r\n__le64 sas_addr;\r\nihost = idev->owning_port->owning_controller;\r\nrnc = sci_rnc_by_id(ihost, rni);\r\nmemset(rnc, 0, sizeof(union scu_remote_node_context)\r\n* sci_remote_device_node_count(idev));\r\nrnc->ssp.remote_node_index = rni;\r\nrnc->ssp.remote_node_port_width = idev->device_port_width;\r\nrnc->ssp.logical_port_index = idev->owning_port->physical_port_index;\r\nsas_addr = cpu_to_le64(SAS_ADDR(dev->sas_addr));\r\nrnc->ssp.remote_sas_address_hi = upper_32_bits(sas_addr);\r\nrnc->ssp.remote_sas_address_lo = lower_32_bits(sas_addr);\r\nrnc->ssp.nexus_loss_timer_enable = true;\r\nrnc->ssp.check_bit = false;\r\nrnc->ssp.is_valid = false;\r\nrnc->ssp.is_remote_node_context = true;\r\nrnc->ssp.function_number = 0;\r\nrnc->ssp.arbitration_wait_time = 0;\r\nif (dev_is_sata(dev)) {\r\nrnc->ssp.connection_occupancy_timeout =\r\nihost->user_parameters.stp_max_occupancy_timeout;\r\nrnc->ssp.connection_inactivity_timeout =\r\nihost->user_parameters.stp_inactivity_timeout;\r\n} else {\r\nrnc->ssp.connection_occupancy_timeout =\r\nihost->user_parameters.ssp_max_occupancy_timeout;\r\nrnc->ssp.connection_inactivity_timeout =\r\nihost->user_parameters.ssp_inactivity_timeout;\r\n}\r\nrnc->ssp.initial_arbitration_wait_time = 0;\r\nrnc->ssp.oaf_connection_rate = idev->connection_rate;\r\nrnc->ssp.oaf_features = 0;\r\nrnc->ssp.oaf_source_zone_group = 0;\r\nrnc->ssp.oaf_more_compatibility_features = 0;\r\n}\r\nstatic void sci_remote_node_context_setup_to_resume(\r\nstruct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback callback,\r\nvoid *callback_parameter,\r\nenum sci_remote_node_context_destination_state dest_param)\r\n{\r\nif (sci_rnc->destination_state != RNC_DEST_FINAL) {\r\nsci_rnc->destination_state = dest_param;\r\nif (callback != NULL) {\r\nsci_rnc->user_callback = callback;\r\nsci_rnc->user_cookie = callback_parameter;\r\n}\r\n}\r\n}\r\nstatic void sci_remote_node_context_setup_to_destroy(\r\nstruct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback callback,\r\nvoid *callback_parameter)\r\n{\r\nstruct isci_host *ihost = idev_to_ihost(rnc_to_dev(sci_rnc));\r\nsci_rnc->destination_state = RNC_DEST_FINAL;\r\nsci_rnc->user_callback = callback;\r\nsci_rnc->user_cookie = callback_parameter;\r\nwake_up(&ihost->eventq);\r\n}\r\nstatic void sci_remote_node_context_notify_user(\r\nstruct sci_remote_node_context *rnc)\r\n{\r\nif (rnc->user_callback != NULL) {\r\n(*rnc->user_callback)(rnc->user_cookie);\r\nrnc->user_callback = NULL;\r\nrnc->user_cookie = NULL;\r\n}\r\n}\r\nstatic void sci_remote_node_context_continue_state_transitions(struct sci_remote_node_context *rnc)\r\n{\r\nswitch (rnc->destination_state) {\r\ncase RNC_DEST_READY:\r\ncase RNC_DEST_SUSPENDED_RESUME:\r\nrnc->destination_state = RNC_DEST_READY;\r\ncase RNC_DEST_FINAL:\r\nsci_remote_node_context_resume(rnc, rnc->user_callback,\r\nrnc->user_cookie);\r\nbreak;\r\ndefault:\r\nrnc->destination_state = RNC_DEST_UNSPECIFIED;\r\nbreak;\r\n}\r\n}\r\nstatic void sci_remote_node_context_validate_context_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nunion scu_remote_node_context *rnc_buffer;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct domain_device *dev = idev->domain_dev;\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nrnc_buffer = sci_rnc_by_id(ihost, sci_rnc->remote_node_index);\r\nrnc_buffer->ssp.is_valid = true;\r\nif (dev_is_sata(dev) && dev->parent) {\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_96);\r\n} else {\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_32);\r\nif (!dev->parent)\r\nsci_port_setup_transports(idev->owning_port,\r\nsci_rnc->remote_node_index);\r\n}\r\n}\r\nstatic void sci_remote_node_context_invalidate_context_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nunion scu_remote_node_context *rnc_buffer;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nrnc_buffer = sci_rnc_by_id(ihost, sci_rnc->remote_node_index);\r\nrnc_buffer->ssp.is_valid = false;\r\nsci_remote_device_post_request(rnc_to_dev(sci_rnc),\r\nSCU_CONTEXT_COMMAND_POST_RNC_INVALIDATE);\r\n}\r\nstatic void sci_remote_node_context_initial_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nstruct isci_remote_device *idev = rnc_to_dev(rnc);\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nif (sm->previous_state_id == SCI_RNC_INVALIDATING) {\r\nrnc->destination_state = RNC_DEST_UNSPECIFIED;\r\nsci_remote_node_context_notify_user(rnc);\r\nsmp_wmb();\r\nwake_up(&ihost->eventq);\r\n}\r\n}\r\nstatic void sci_remote_node_context_posting_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *sci_rnc = container_of(sm, typeof(*sci_rnc), sm);\r\nsci_remote_node_context_validate_context_buffer(sci_rnc);\r\n}\r\nstatic void sci_remote_node_context_invalidating_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nsci_remote_device_terminate_requests(rnc_to_dev(rnc));\r\nsci_remote_node_context_invalidate_context_buffer(rnc);\r\n}\r\nstatic void sci_remote_node_context_resuming_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nstruct isci_remote_device *idev;\r\nstruct domain_device *dev;\r\nidev = rnc_to_dev(rnc);\r\ndev = idev->domain_dev;\r\nif (dev_is_sata(dev) && !dev->parent)\r\nsci_port_setup_transports(idev->owning_port, rnc->remote_node_index);\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_RESUME);\r\n}\r\nstatic void sci_remote_node_context_ready_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nenum sci_remote_node_context_destination_state dest_select;\r\nint tell_user = 1;\r\ndest_select = rnc->destination_state;\r\nrnc->destination_state = RNC_DEST_UNSPECIFIED;\r\nif ((dest_select == RNC_DEST_SUSPENDED) ||\r\n(dest_select == RNC_DEST_SUSPENDED_RESUME)) {\r\nsci_remote_node_context_suspend(\r\nrnc, rnc->suspend_reason,\r\nSCI_SOFTWARE_SUSPEND_EXPECTED_EVENT);\r\nif (dest_select == RNC_DEST_SUSPENDED_RESUME)\r\ntell_user = 0;\r\n}\r\nif (tell_user)\r\nsci_remote_node_context_notify_user(rnc);\r\n}\r\nstatic void sci_remote_node_context_tx_suspended_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nsci_remote_node_context_continue_state_transitions(rnc);\r\n}\r\nstatic void sci_remote_node_context_tx_rx_suspended_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nstruct isci_remote_device *idev = rnc_to_dev(rnc);\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nu32 new_count = rnc->suspend_count + 1;\r\nif (new_count == 0)\r\nrnc->suspend_count = 1;\r\nelse\r\nrnc->suspend_count = new_count;\r\nsmp_wmb();\r\nsci_remote_device_abort_requests_pending_abort(idev);\r\nwake_up(&ihost->eventq);\r\nsci_remote_node_context_continue_state_transitions(rnc);\r\n}\r\nstatic void sci_remote_node_context_await_suspend_state_exit(\r\nstruct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc\r\n= container_of(sm, typeof(*rnc), sm);\r\nstruct isci_remote_device *idev = rnc_to_dev(rnc);\r\nif (dev_is_sata(idev->domain_dev))\r\nisci_dev_set_hang_detection_timeout(idev, 0);\r\n}\r\nvoid sci_remote_node_context_construct(struct sci_remote_node_context *rnc,\r\nu16 remote_node_index)\r\n{\r\nmemset(rnc, 0, sizeof(struct sci_remote_node_context));\r\nrnc->remote_node_index = remote_node_index;\r\nrnc->destination_state = RNC_DEST_UNSPECIFIED;\r\nsci_init_sm(&rnc->sm, sci_remote_node_context_state_table, SCI_RNC_INITIAL);\r\n}\r\nenum sci_status sci_remote_node_context_event_handler(struct sci_remote_node_context *sci_rnc,\r\nu32 event_code)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nu32 next_state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_POSTING:\r\nswitch (scu_get_event_code(event_code)) {\r\ncase SCU_EVENT_POST_RNC_COMPLETE:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_READY);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nbreak;\r\ncase SCI_RNC_INVALIDATING:\r\nif (scu_get_event_code(event_code) == SCU_EVENT_POST_RNC_INVALIDATE_COMPLETE) {\r\nif (sci_rnc->destination_state == RNC_DEST_FINAL)\r\nnext_state = SCI_RNC_INITIAL;\r\nelse\r\nnext_state = SCI_RNC_POSTING;\r\nsci_change_state(&sci_rnc->sm, next_state);\r\n} else {\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX:\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX_RX:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: SCIC Remote Node Context 0x%p was "\r\n"suspended by hardware while being "\r\n"invalidated.\n", __func__, sci_rnc);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\n}\r\nbreak;\r\ncase SCI_RNC_RESUMING:\r\nif (scu_get_event_code(event_code) == SCU_EVENT_POST_RCN_RELEASE) {\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_READY);\r\n} else {\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX:\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX_RX:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: SCIC Remote Node Context 0x%p was "\r\n"suspended by hardware while being resumed.\n",\r\n__func__, sci_rnc);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\n}\r\nbreak;\r\ncase SCI_RNC_READY:\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_SUSPENDED);\r\nsci_rnc->suspend_type = scu_get_event_type(event_code);\r\nbreak;\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX_RX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_RX_SUSPENDED);\r\nsci_rnc->suspend_type = scu_get_event_type(event_code);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nbreak;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX:\r\nnext_state = SCI_RNC_TX_SUSPENDED;\r\nbreak;\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX_RX:\r\nnext_state = SCI_RNC_TX_RX_SUSPENDED;\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nif (sci_rnc->suspend_type == scu_get_event_type(event_code))\r\nsci_change_state(&sci_rnc->sm, next_state);\r\nbreak;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state: %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\nreturn SCI_SUCCESS;\r\nout:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: code: %#x state: %s\n", __func__, event_code,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE;\r\n}\r\nenum sci_status sci_remote_node_context_destruct(struct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_INVALIDATING:\r\nsci_remote_node_context_setup_to_destroy(sci_rnc, cb_fn, cb_p);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_POSTING:\r\ncase SCI_RNC_RESUMING:\r\ncase SCI_RNC_READY:\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\nsci_remote_node_context_setup_to_destroy(sci_rnc, cb_fn, cb_p);\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_INVALIDATING);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nsci_remote_node_context_setup_to_destroy(sci_rnc, cb_fn, cb_p);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_INITIAL:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state: %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_SUCCESS;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}\r\nenum sci_status sci_remote_node_context_suspend(\r\nstruct sci_remote_node_context *sci_rnc,\r\nenum sci_remote_node_suspension_reasons suspend_reason,\r\nu32 suspend_type)\r\n{\r\nenum scis_sds_remote_node_context_states state\r\n= sci_rnc->sm.current_state_id;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nenum sci_status status = SCI_FAILURE_INVALID_STATE;\r\nenum sci_remote_node_context_destination_state dest_param =\r\nRNC_DEST_UNSPECIFIED;\r\ndev_dbg(scirdev_to_dev(idev),\r\n"%s: current state %s, current suspend_type %x dest state %d,"\r\n" arg suspend_reason %d, arg suspend_type %x",\r\n__func__, rnc_state_name(state), sci_rnc->suspend_type,\r\nsci_rnc->destination_state, suspend_reason,\r\nsuspend_type);\r\nif ((suspend_reason == SCI_HW_SUSPEND) ||\r\n(sci_rnc->destination_state == RNC_DEST_FINAL))\r\ndest_param = sci_rnc->destination_state;\r\nswitch (state) {\r\ncase SCI_RNC_READY:\r\nbreak;\r\ncase SCI_RNC_INVALIDATING:\r\nif (sci_rnc->destination_state == RNC_DEST_FINAL) {\r\ndev_warn(scirdev_to_dev(idev),\r\n"%s: already destroying %p\n",\r\n__func__, sci_rnc);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\ncase SCI_RNC_RESUMING:\r\ncase SCI_RNC_POSTING:\r\nif (sci_rnc->destination_state != RNC_DEST_FINAL)\r\nsci_rnc->destination_state = RNC_DEST_SUSPENDED;\r\nsci_rnc->suspend_type = suspend_type;\r\nsci_rnc->suspend_reason = suspend_reason;\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED:\r\nif (suspend_type == SCU_EVENT_TL_RNC_SUSPEND_TX)\r\nstatus = SCI_SUCCESS;\r\nbreak;\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\nif (suspend_type == SCU_EVENT_TL_RNC_SUSPEND_TX_RX)\r\nstatus = SCI_SUCCESS;\r\nbreak;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nif ((sci_rnc->suspend_type == SCU_EVENT_TL_RNC_SUSPEND_TX_RX)\r\n|| (suspend_type == sci_rnc->suspend_type))\r\nreturn SCI_SUCCESS;\r\nbreak;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\nsci_rnc->destination_state = dest_param;\r\nsci_rnc->suspend_type = suspend_type;\r\nsci_rnc->suspend_reason = suspend_reason;\r\nif (status == SCI_SUCCESS) {\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nwake_up_all(&ihost->eventq);\r\nreturn SCI_SUCCESS;\r\n}\r\nif ((suspend_reason == SCI_SW_SUSPEND_NORMAL) ||\r\n(suspend_reason == SCI_SW_SUSPEND_LINKHANG_DETECT)) {\r\nif (suspend_reason == SCI_SW_SUSPEND_LINKHANG_DETECT)\r\nisci_dev_set_hang_detection_timeout(idev, 0x00000001);\r\nsci_remote_device_post_request(\r\nidev, SCI_SOFTWARE_SUSPEND_CMD);\r\n}\r\nif (state != SCI_RNC_AWAIT_SUSPENSION)\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_AWAIT_SUSPENSION);\r\nreturn SCI_SUCCESS;\r\n}\r\nenum sci_status sci_remote_node_context_resume(struct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstate = sci_rnc->sm.current_state_id;\r\ndev_dbg(scirdev_to_dev(idev),\r\n"%s: state %s, cb_fn = %p, cb_p = %p; dest_state = %d; "\r\n"dev resume path %s\n",\r\n__func__, rnc_state_name(state), cb_fn, cb_p,\r\nsci_rnc->destination_state,\r\ntest_bit(IDEV_ABORT_PATH_ACTIVE, &idev->flags)\r\n? "<abort active>" : "<normal>");\r\nswitch (state) {\r\ncase SCI_RNC_INITIAL:\r\nif (sci_rnc->remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX)\r\nreturn SCI_FAILURE_INVALID_STATE;\r\nsci_remote_node_context_setup_to_resume(sci_rnc, cb_fn, cb_p,\r\nRNC_DEST_READY);\r\nif (!test_bit(IDEV_ABORT_PATH_ACTIVE, &idev->flags)) {\r\nsci_remote_node_context_construct_buffer(sci_rnc);\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_POSTING);\r\n}\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_POSTING:\r\ncase SCI_RNC_INVALIDATING:\r\ncase SCI_RNC_RESUMING:\r\nswitch (sci_rnc->destination_state) {\r\ncase RNC_DEST_SUSPENDED:\r\ncase RNC_DEST_SUSPENDED_RESUME:\r\nsci_remote_node_context_setup_to_resume(\r\nsci_rnc, cb_fn, cb_p,\r\nRNC_DEST_SUSPENDED_RESUME);\r\nbreak;\r\ndefault:\r\nsci_remote_node_context_setup_to_resume(\r\nsci_rnc, cb_fn, cb_p,\r\nRNC_DEST_READY);\r\nbreak;\r\n}\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\n{\r\nstruct domain_device *dev = idev->domain_dev;\r\nsci_remote_node_context_setup_to_resume(\r\nsci_rnc, cb_fn, cb_p, RNC_DEST_READY);\r\nif (!test_bit(IDEV_ABORT_PATH_ACTIVE, &idev->flags)) {\r\nif ((dev_is_sata(dev) && dev->parent) ||\r\n(sci_rnc->destination_state == RNC_DEST_FINAL))\r\nsci_change_state(&sci_rnc->sm,\r\nSCI_RNC_INVALIDATING);\r\nelse\r\nsci_change_state(&sci_rnc->sm,\r\nSCI_RNC_RESUMING);\r\n}\r\n}\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nsci_remote_node_context_setup_to_resume(\r\nsci_rnc, cb_fn, cb_p, RNC_DEST_SUSPENDED_RESUME);\r\nreturn SCI_SUCCESS;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}\r\nenum sci_status sci_remote_node_context_start_io(struct sci_remote_node_context *sci_rnc,\r\nstruct isci_request *ireq)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_READY:\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED;\r\ndefault:\r\ndev_dbg(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %s\n", __func__,\r\nrnc_state_name(state));\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}\r\nenum sci_status sci_remote_node_context_start_task(\r\nstruct sci_remote_node_context *sci_rnc,\r\nstruct isci_request *ireq,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum sci_status status = sci_remote_node_context_resume(sci_rnc,\r\ncb_fn, cb_p);\r\nif (status != SCI_SUCCESS)\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: resume failed: %d\n", __func__, status);\r\nreturn status;\r\n}\r\nint sci_remote_node_context_is_safe_to_abort(\r\nstruct sci_remote_node_context *sci_rnc)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_INVALIDATING:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\nreturn 1;\r\ncase SCI_RNC_POSTING:\r\ncase SCI_RNC_RESUMING:\r\ncase SCI_RNC_READY:\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\ncase SCI_RNC_INITIAL:\r\nreturn 0;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn 0;\r\n}\r\n}

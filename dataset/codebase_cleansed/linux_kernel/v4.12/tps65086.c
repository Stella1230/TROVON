static int tps65086_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *ids)\r\n{\r\nstruct tps65086 *tps;\r\nunsigned int version;\r\nint ret;\r\ntps = devm_kzalloc(&client->dev, sizeof(*tps), GFP_KERNEL);\r\nif (!tps)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, tps);\r\ntps->dev = &client->dev;\r\ntps->irq = client->irq;\r\ntps->regmap = devm_regmap_init_i2c(client, &tps65086_regmap_config);\r\nif (IS_ERR(tps->regmap)) {\r\ndev_err(tps->dev, "Failed to initialize register map\n");\r\nreturn PTR_ERR(tps->regmap);\r\n}\r\nret = regmap_read(tps->regmap, TPS65086_DEVICEID, &version);\r\nif (ret) {\r\ndev_err(tps->dev, "Failed to read revision register\n");\r\nreturn ret;\r\n}\r\ndev_info(tps->dev, "Device: TPS65086%01lX, OTP: %c, Rev: %ld\n",\r\n(version & TPS65086_DEVICEID_PART_MASK),\r\n(char)((version & TPS65086_DEVICEID_OTP_MASK) >> 4) + 'A',\r\n(version & TPS65086_DEVICEID_REV_MASK) >> 6);\r\nret = regmap_add_irq_chip(tps->regmap, tps->irq, IRQF_ONESHOT, 0,\r\n&tps65086_irq_chip, &tps->irq_data);\r\nif (ret) {\r\ndev_err(tps->dev, "Failed to register IRQ chip\n");\r\nreturn ret;\r\n}\r\nret = mfd_add_devices(tps->dev, PLATFORM_DEVID_AUTO, tps65086_cells,\r\nARRAY_SIZE(tps65086_cells), NULL, 0,\r\nregmap_irq_get_domain(tps->irq_data));\r\nif (ret) {\r\nregmap_del_irq_chip(tps->irq, tps->irq_data);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65086_remove(struct i2c_client *client)\r\n{\r\nstruct tps65086 *tps = i2c_get_clientdata(client);\r\nregmap_del_irq_chip(tps->irq, tps->irq_data);\r\nreturn 0;\r\n}

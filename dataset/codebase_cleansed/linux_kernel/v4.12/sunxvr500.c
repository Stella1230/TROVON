static int e3d_get_props(struct e3d_info *ep)\r\n{\r\nep->width = of_getintprop_default(ep->of_node, "width", 0);\r\nep->height = of_getintprop_default(ep->of_node, "height", 0);\r\nep->depth = of_getintprop_default(ep->of_node, "depth", 8);\r\nif (!ep->width || !ep->height) {\r\nprintk(KERN_ERR "e3d: Critical properties missing for %s\n",\r\npci_name(ep->pdev));\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void e3d_clut_write(struct e3d_info *ep, int index, u32 val)\r\n{\r\nvoid __iomem *ramdac = ep->ramdac;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ep->lock, flags);\r\nwritel(index, ramdac + RAMDAC_INDEX);\r\nwritel(val, ramdac + RAMDAC_DATA);\r\nspin_unlock_irqrestore(&ep->lock, flags);\r\n}\r\nstatic int e3d_setcolreg(unsigned regno,\r\nunsigned red, unsigned green, unsigned blue,\r\nunsigned transp, struct fb_info *info)\r\n{\r\nstruct e3d_info *ep = info->par;\r\nu32 red_8, green_8, blue_8;\r\nu32 red_10, green_10, blue_10;\r\nu32 value;\r\nif (regno >= 256)\r\nreturn 1;\r\nred_8 = red >> 8;\r\ngreen_8 = green >> 8;\r\nblue_8 = blue >> 8;\r\nvalue = (blue_8 << 24) | (green_8 << 16) | (red_8 << 8);\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR && regno < 16)\r\n((u32 *)info->pseudo_palette)[regno] = value;\r\nred_10 = red >> 6;\r\ngreen_10 = green >> 6;\r\nblue_10 = blue >> 6;\r\nvalue = (blue_10 << 20) | (green_10 << 10) | (red_10 << 0);\r\ne3d_clut_write(ep, regno, value);\r\nreturn 0;\r\n}\r\nstatic void e3d_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct e3d_info *ep = info->par;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ep->lock, flags);\r\ncfb_imageblit(info, image);\r\ninfo->screen_base += ep->fb8_buf_diff;\r\ncfb_imageblit(info, image);\r\ninfo->screen_base -= ep->fb8_buf_diff;\r\nspin_unlock_irqrestore(&ep->lock, flags);\r\n}\r\nstatic void e3d_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct e3d_info *ep = info->par;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ep->lock, flags);\r\ncfb_fillrect(info, rect);\r\ninfo->screen_base += ep->fb8_buf_diff;\r\ncfb_fillrect(info, rect);\r\ninfo->screen_base -= ep->fb8_buf_diff;\r\nspin_unlock_irqrestore(&ep->lock, flags);\r\n}\r\nstatic void e3d_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nstruct e3d_info *ep = info->par;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ep->lock, flags);\r\ncfb_copyarea(info, area);\r\ninfo->screen_base += ep->fb8_buf_diff;\r\ncfb_copyarea(info, area);\r\ninfo->screen_base -= ep->fb8_buf_diff;\r\nspin_unlock_irqrestore(&ep->lock, flags);\r\n}\r\nstatic int e3d_set_fbinfo(struct e3d_info *ep)\r\n{\r\nstruct fb_info *info = ep->info;\r\nstruct fb_var_screeninfo *var = &info->var;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &e3d_ops;\r\ninfo->screen_base = ep->fb_base;\r\ninfo->screen_size = ep->fb_size;\r\ninfo->pseudo_palette = ep->pseudo_palette;\r\nstrlcpy(info->fix.id, "e3d", sizeof(info->fix.id));\r\ninfo->fix.smem_start = ep->fb_base_phys;\r\ninfo->fix.smem_len = ep->fb_size;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\nif (ep->depth == 32 || ep->depth == 24)\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nelse\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nvar->xres = ep->width;\r\nvar->yres = ep->height;\r\nvar->xres_virtual = var->xres;\r\nvar->yres_virtual = var->yres;\r\nvar->bits_per_pixel = ep->depth;\r\nvar->red.offset = 8;\r\nvar->red.length = 8;\r\nvar->green.offset = 16;\r\nvar->green.length = 8;\r\nvar->blue.offset = 24;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nif (fb_alloc_cmap(&info->cmap, 256, 0)) {\r\nprintk(KERN_ERR "e3d: Cannot allocate color map.\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int e3d_pci_register(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct device_node *of_node;\r\nconst char *device_type;\r\nstruct fb_info *info;\r\nstruct e3d_info *ep;\r\nunsigned int line_length;\r\nint err;\r\nof_node = pci_device_to_OF_node(pdev);\r\nif (!of_node) {\r\nprintk(KERN_ERR "e3d: Cannot find OF node of %s\n",\r\npci_name(pdev));\r\nreturn -ENODEV;\r\n}\r\ndevice_type = of_get_property(of_node, "device_type", NULL);\r\nif (!device_type) {\r\nprintk(KERN_INFO "e3d: Ignoring secondary output device "\r\n"at %s\n", pci_name(pdev));\r\nreturn -ENODEV;\r\n}\r\nerr = pci_enable_device(pdev);\r\nif (err < 0) {\r\nprintk(KERN_ERR "e3d: Cannot enable PCI device %s\n",\r\npci_name(pdev));\r\ngoto err_out;\r\n}\r\ninfo = framebuffer_alloc(sizeof(struct e3d_info), &pdev->dev);\r\nif (!info) {\r\nprintk(KERN_ERR "e3d: Cannot allocate fb_info\n");\r\nerr = -ENOMEM;\r\ngoto err_disable;\r\n}\r\nep = info->par;\r\nep->info = info;\r\nep->pdev = pdev;\r\nspin_lock_init(&ep->lock);\r\nep->of_node = of_node;\r\npci_read_config_dword(pdev, PCI_BASE_ADDRESS_0,\r\n&ep->fb_base_reg);\r\nep->fb_base_reg &= PCI_BASE_ADDRESS_MEM_MASK;\r\nep->regs_base_phys = pci_resource_start (pdev, 1);\r\nerr = pci_request_region(pdev, 1, "e3d regs");\r\nif (err < 0) {\r\nprintk("e3d: Cannot request region 1 for %s\n",\r\npci_name(pdev));\r\ngoto err_release_fb;\r\n}\r\nep->ramdac = ioremap(ep->regs_base_phys + 0x8000, 0x1000);\r\nif (!ep->ramdac) {\r\nerr = -ENOMEM;\r\ngoto err_release_pci1;\r\n}\r\nep->fb8_0_off = readl(ep->ramdac + RAMDAC_VID_8FB_0);\r\nep->fb8_0_off -= ep->fb_base_reg;\r\nep->fb8_1_off = readl(ep->ramdac + RAMDAC_VID_8FB_1);\r\nep->fb8_1_off -= ep->fb_base_reg;\r\nep->fb8_buf_diff = ep->fb8_1_off - ep->fb8_0_off;\r\nep->fb_base_phys = pci_resource_start (pdev, 0);\r\nep->fb_base_phys += ep->fb8_0_off;\r\nerr = pci_request_region(pdev, 0, "e3d framebuffer");\r\nif (err < 0) {\r\nprintk("e3d: Cannot request region 0 for %s\n",\r\npci_name(pdev));\r\ngoto err_unmap_ramdac;\r\n}\r\nerr = e3d_get_props(ep);\r\nif (err)\r\ngoto err_release_pci0;\r\nline_length = (readl(ep->ramdac + RAMDAC_VID_CFG) >> 16) & 0xff;\r\nline_length = 1 << line_length;\r\nswitch (ep->depth) {\r\ncase 8:\r\ninfo->fix.line_length = line_length;\r\nbreak;\r\ncase 16:\r\ninfo->fix.line_length = line_length * 2;\r\nbreak;\r\ncase 24:\r\ninfo->fix.line_length = line_length * 3;\r\nbreak;\r\ncase 32:\r\ninfo->fix.line_length = line_length * 4;\r\nbreak;\r\n}\r\nep->fb_size = info->fix.line_length * ep->height;\r\nep->fb_base = ioremap(ep->fb_base_phys, ep->fb_size);\r\nif (!ep->fb_base) {\r\nerr = -ENOMEM;\r\ngoto err_release_pci0;\r\n}\r\nerr = e3d_set_fbinfo(ep);\r\nif (err)\r\ngoto err_unmap_fb;\r\npci_set_drvdata(pdev, info);\r\nprintk("e3d: Found device at %s\n", pci_name(pdev));\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nprintk(KERN_ERR "e3d: Could not register framebuffer %s\n",\r\npci_name(pdev));\r\ngoto err_free_cmap;\r\n}\r\nreturn 0;\r\nerr_free_cmap:\r\nfb_dealloc_cmap(&info->cmap);\r\nerr_unmap_fb:\r\niounmap(ep->fb_base);\r\nerr_release_pci0:\r\npci_release_region(pdev, 0);\r\nerr_unmap_ramdac:\r\niounmap(ep->ramdac);\r\nerr_release_pci1:\r\npci_release_region(pdev, 1);\r\nerr_release_fb:\r\nframebuffer_release(info);\r\nerr_disable:\r\npci_disable_device(pdev);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int __init e3d_init(void)\r\n{\r\nif (fb_get_options("e3d", NULL))\r\nreturn -ENODEV;\r\nreturn pci_register_driver(&e3d_driver);\r\n}

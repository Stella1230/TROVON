static ssize_t firmware_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct rproc *rproc = to_rproc(dev);\r\nreturn sprintf(buf, "%s\n", rproc->firmware);\r\n}\r\nstatic ssize_t firmware_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct rproc *rproc = to_rproc(dev);\r\nchar *p;\r\nint err, len = count;\r\nerr = mutex_lock_interruptible(&rproc->lock);\r\nif (err) {\r\ndev_err(dev, "can't lock rproc %s: %d\n", rproc->name, err);\r\nreturn -EINVAL;\r\n}\r\nif (rproc->state != RPROC_OFFLINE) {\r\ndev_err(dev, "can't change firmware while running\n");\r\nerr = -EBUSY;\r\ngoto out;\r\n}\r\nlen = strcspn(buf, "\n");\r\np = kstrndup(buf, len, GFP_KERNEL);\r\nif (!p) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nkfree(rproc->firmware);\r\nrproc->firmware = p;\r\nout:\r\nmutex_unlock(&rproc->lock);\r\nreturn err ? err : count;\r\n}\r\nstatic ssize_t state_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct rproc *rproc = to_rproc(dev);\r\nunsigned int state;\r\nstate = rproc->state > RPROC_LAST ? RPROC_LAST : rproc->state;\r\nreturn sprintf(buf, "%s\n", rproc_state_string[state]);\r\n}\r\nstatic ssize_t state_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct rproc *rproc = to_rproc(dev);\r\nint ret = 0;\r\nif (sysfs_streq(buf, "start")) {\r\nif (rproc->state == RPROC_RUNNING)\r\nreturn -EBUSY;\r\nret = rproc_boot(rproc);\r\nif (ret)\r\ndev_err(&rproc->dev, "Boot failed: %d\n", ret);\r\n} else if (sysfs_streq(buf, "stop")) {\r\nif (rproc->state != RPROC_RUNNING)\r\nreturn -EINVAL;\r\nrproc_shutdown(rproc);\r\n} else {\r\ndev_err(&rproc->dev, "Unrecognised option: %s\n", buf);\r\nret = -EINVAL;\r\n}\r\nreturn ret ? ret : count;\r\n}\r\nint __init rproc_init_sysfs(void)\r\n{\r\nint err = class_register(&rproc_class);\r\nif (err)\r\npr_err("remoteproc: unable to register class\n");\r\nreturn err;\r\n}\r\nvoid __exit rproc_exit_sysfs(void)\r\n{\r\nclass_unregister(&rproc_class);\r\n}

static void dm_InitGPIOSetting(struct adapter *Adapter)\r\n{\r\nu8 tmp1byte;\r\ntmp1byte = usb_read8(Adapter, REG_GPIO_MUXCFG);\r\ntmp1byte &= (GPIOSEL_GPIO | ~GPIOSEL_ENBT);\r\nusb_write8(Adapter, REG_GPIO_MUXCFG, tmp1byte);\r\n}\r\nstatic void Init_ODM_ComInfo_88E(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *hal_data = Adapter->HalData;\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nstruct odm_dm_struct *dm_odm = &(hal_data->odmpriv);\r\nmemset(dm_odm, 0, sizeof(*dm_odm));\r\ndm_odm->Adapter = Adapter;\r\ndm_odm->SupportPlatform = ODM_CE;\r\ndm_odm->SupportICType = ODM_RTL8188E;\r\ndm_odm->CutVersion = ODM_CUT_A;\r\ndm_odm->bIsMPChip = hal_data->VersionID.ChipType == NORMAL_CHIP;\r\ndm_odm->PatchID = hal_data->CustomerID;\r\ndm_odm->bWIFITest = Adapter->registrypriv.wifi_spec;\r\ndm_odm->AntDivType = hal_data->TRxAntDivType;\r\ndm_odm->BbSwingIdxOfdm = 12;\r\ndm_odm->BbSwingIdxOfdmCurrent = 12;\r\ndm_odm->BbSwingFlagOfdm = false;\r\npdmpriv->InitODMFlag = ODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\ndm_odm->SupportAbility = pdmpriv->InitODMFlag;\r\n}\r\nstatic void Update_ODM_ComInfo_88E(struct adapter *Adapter)\r\n{\r\nstruct mlme_ext_priv *pmlmeext = &Adapter->mlmeextpriv;\r\nstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\r\nstruct pwrctrl_priv *pwrctrlpriv = &Adapter->pwrctrlpriv;\r\nstruct hal_data_8188e *hal_data = Adapter->HalData;\r\nstruct odm_dm_struct *dm_odm = &(hal_data->odmpriv);\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nint i;\r\npdmpriv->InitODMFlag = ODM_BB_DIG |\r\nODM_BB_RA_MASK |\r\nODM_BB_DYNAMIC_TXPWR |\r\nODM_BB_FA_CNT |\r\nODM_BB_RSSI_MONITOR |\r\nODM_BB_CCK_PD |\r\nODM_BB_PWR_SAVE |\r\nODM_MAC_EDCA_TURBO |\r\nODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\nif (hal_data->AntDivCfg)\r\npdmpriv->InitODMFlag |= ODM_BB_ANT_DIV;\r\nif (Adapter->registrypriv.mp_mode == 1) {\r\npdmpriv->InitODMFlag = ODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\n}\r\ndm_odm->SupportAbility = pdmpriv->InitODMFlag;\r\ndm_odm->pNumTxBytesUnicast = &Adapter->xmitpriv.tx_bytes;\r\ndm_odm->pNumRxBytesUnicast = &Adapter->recvpriv.rx_bytes;\r\ndm_odm->pWirelessMode = &pmlmeext->cur_wireless_mode;\r\ndm_odm->pSecChOffset = &hal_data->nCur40MhzPrimeSC;\r\ndm_odm->pSecurity = (u8 *)&Adapter->securitypriv.dot11PrivacyAlgrthm;\r\ndm_odm->pBandWidth = (u8 *)&hal_data->CurrentChannelBW;\r\ndm_odm->pChannel = &hal_data->CurrentChannel;\r\ndm_odm->pbNet_closed = (bool *)&Adapter->net_closed;\r\ndm_odm->mp_mode = &Adapter->registrypriv.mp_mode;\r\ndm_odm->pbScanInProcess = (bool *)&pmlmepriv->bScanInProcess;\r\ndm_odm->pbPowerSaving = (bool *)&pwrctrlpriv->bpower_saving;\r\ndm_odm->AntDivType = hal_data->TRxAntDivType;\r\ndm_odm->BbSwingIdxOfdm = 12;\r\ndm_odm->BbSwingIdxOfdmCurrent = 12;\r\ndm_odm->BbSwingFlagOfdm = false;\r\nfor (i = 0; i < NUM_STA; i++)\r\nODM_CmnInfoPtrArrayHook(dm_odm, ODM_CMNINFO_STA_STATUS, i, NULL);\r\n}\r\nvoid rtl8188e_InitHalDm(struct adapter *Adapter)\r\n{\r\nstruct dm_priv *pdmpriv = &Adapter->HalData->dmpriv;\r\nstruct odm_dm_struct *dm_odm = &(Adapter->HalData->odmpriv);\r\ndm_InitGPIOSetting(Adapter);\r\npdmpriv->DM_Type = DM_Type_ByDriver;\r\npdmpriv->DMFlag = DYNAMIC_FUNC_DISABLE;\r\nUpdate_ODM_ComInfo_88E(Adapter);\r\nODM_DMInit(dm_odm);\r\n}\r\nvoid rtw_hal_dm_watchdog(struct adapter *Adapter)\r\n{\r\nu8 hw_init_completed = false;\r\nstruct mlme_priv *pmlmepriv = NULL;\r\nu8 bLinked = false;\r\nhw_init_completed = Adapter->hw_init_completed;\r\nif (!hw_init_completed)\r\ngoto skip_dm;\r\npmlmepriv = &Adapter->mlmepriv;\r\nif ((check_fwstate(pmlmepriv, WIFI_AP_STATE)) ||\r\n(check_fwstate(pmlmepriv, WIFI_ADHOC_STATE |\r\nWIFI_ADHOC_MASTER_STATE))) {\r\nif (Adapter->stapriv.asoc_sta_count > 2)\r\nbLinked = true;\r\n} else {\r\nif (check_fwstate(pmlmepriv, _FW_LINKED))\r\nbLinked = true;\r\n}\r\nAdapter->HalData->odmpriv.bLinked = bLinked;\r\nODM_DMWatchdog(&Adapter->HalData->odmpriv);\r\nskip_dm:\r\nreturn;\r\n}\r\nvoid rtw_hal_dm_init(struct adapter *Adapter)\r\n{\r\nstruct dm_priv *pdmpriv = &Adapter->HalData->dmpriv;\r\nstruct odm_dm_struct *podmpriv = &Adapter->HalData->odmpriv;\r\nmemset(pdmpriv, 0, sizeof(struct dm_priv));\r\nInit_ODM_ComInfo_88E(Adapter);\r\nODM_InitDebugSetting(podmpriv);\r\n}\r\nvoid rtw_hal_antdiv_rssi_compared(struct adapter *Adapter, struct wlan_bssid_ex *dst, struct wlan_bssid_ex *src)\r\n{\r\nif (0 != Adapter->HalData->AntDivCfg) {\r\nif (dst->Rssi >= src->Rssi) {\r\nsrc->Rssi = dst->Rssi;\r\nsrc->PhyInfo.Optimum_antenna = dst->PhyInfo.Optimum_antenna;\r\n}\r\n}\r\n}\r\nu8 rtw_hal_antdiv_before_linked(struct adapter *Adapter)\r\n{\r\nstruct odm_dm_struct *dm_odm = &Adapter->HalData->odmpriv;\r\nstruct sw_ant_switch *dm_swat_tbl = &dm_odm->DM_SWAT_Table;\r\nstruct mlme_priv *pmlmepriv = &(Adapter->mlmepriv);\r\nif (Adapter->HalData->AntDivCfg == 0)\r\nreturn false;\r\nif (check_fwstate(pmlmepriv, _FW_LINKED))\r\nreturn false;\r\nif (dm_swat_tbl->SWAS_NoLink_State == 0) {\r\ndm_swat_tbl->SWAS_NoLink_State = 1;\r\ndm_swat_tbl->CurAntenna = (dm_swat_tbl->CurAntenna == Antenna_A) ? Antenna_B : Antenna_A;\r\nrtw_antenna_select_cmd(Adapter, dm_swat_tbl->CurAntenna, false);\r\nreturn true;\r\n} else {\r\ndm_swat_tbl->SWAS_NoLink_State = 0;\r\nreturn false;\r\n}\r\n}

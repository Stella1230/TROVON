int __init tegra_osc_clk_init(void __iomem *clk_base, struct tegra_clk *clks,\r\nunsigned long *input_freqs, unsigned int num,\r\nunsigned int clk_m_div, unsigned long *osc_freq,\r\nunsigned long *pll_ref_freq)\r\n{\r\nstruct clk *clk, *osc;\r\nstruct clk **dt_clk;\r\nu32 val, pll_ref_div;\r\nunsigned osc_idx;\r\nval = readl_relaxed(clk_base + OSC_CTRL);\r\nosc_idx = val >> OSC_CTRL_OSC_FREQ_SHIFT;\r\nif (osc_idx < num)\r\n*osc_freq = input_freqs[osc_idx];\r\nelse\r\n*osc_freq = 0;\r\nif (!*osc_freq) {\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nosc = clk_register_fixed_rate(NULL, "osc", NULL, 0, *osc_freq);\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_clk_m, clks);\r\nif (!dt_clk)\r\nreturn 0;\r\nclk = clk_register_fixed_factor(NULL, "clk_m", "osc",\r\n0, 1, clk_m_div);\r\n*dt_clk = clk;\r\nval = (val >> OSC_CTRL_PLL_REF_DIV_SHIFT) & 3;\r\npll_ref_div = 1 << val;\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_ref, clks);\r\nif (!dt_clk)\r\nreturn 0;\r\nclk = clk_register_fixed_factor(NULL, "pll_ref", "osc",\r\n0, 1, pll_ref_div);\r\n*dt_clk = clk;\r\nif (pll_ref_freq)\r\n*pll_ref_freq = *osc_freq / pll_ref_div;\r\nreturn 0;\r\n}\r\nvoid __init tegra_fixed_clk_init(struct tegra_clk *tegra_clks)\r\n{\r\nstruct clk *clk;\r\nstruct clk **dt_clk;\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_clk_32k, tegra_clks);\r\nif (dt_clk) {\r\nclk = clk_register_fixed_rate(NULL, "clk_32k", NULL, 0, 32768);\r\n*dt_clk = clk;\r\n}\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_clk_m_div2, tegra_clks);\r\nif (dt_clk) {\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div2", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\n*dt_clk = clk;\r\n}\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_clk_m_div4, tegra_clks);\r\nif (dt_clk) {\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div4", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 4);\r\n*dt_clk = clk;\r\n}\r\n}

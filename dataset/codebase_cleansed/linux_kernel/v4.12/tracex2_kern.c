int bpf_prog2(struct pt_regs *ctx)\r\n{\r\nlong loc = 0;\r\nlong init_val = 1;\r\nlong *value;\r\nBPF_KPROBE_READ_RET_IP(loc, ctx);\r\nvalue = bpf_map_lookup_elem(&my_map, &loc);\r\nif (value)\r\n*value += 1;\r\nelse\r\nbpf_map_update_elem(&my_map, &loc, &init_val, BPF_ANY);\r\nreturn 0;\r\n}\r\nstatic unsigned int log2(unsigned int v)\r\n{\r\nunsigned int r;\r\nunsigned int shift;\r\nr = (v > 0xFFFF) << 4; v >>= r;\r\nshift = (v > 0xFF) << 3; v >>= shift; r |= shift;\r\nshift = (v > 0xF) << 2; v >>= shift; r |= shift;\r\nshift = (v > 0x3) << 1; v >>= shift; r |= shift;\r\nr |= (v >> 1);\r\nreturn r;\r\n}\r\nstatic unsigned int log2l(unsigned long v)\r\n{\r\nunsigned int hi = v >> 32;\r\nif (hi)\r\nreturn log2(hi) + 32;\r\nelse\r\nreturn log2(v);\r\n}\r\nint bpf_prog3(struct pt_regs *ctx)\r\n{\r\nlong write_size = PT_REGS_PARM3(ctx);\r\nlong init_val = 1;\r\nlong *value;\r\nstruct hist_key key;\r\nkey.index = log2l(write_size);\r\nkey.pid_tgid = bpf_get_current_pid_tgid();\r\nkey.uid_gid = bpf_get_current_uid_gid();\r\nbpf_get_current_comm(&key.comm, sizeof(key.comm));\r\nvalue = bpf_map_lookup_elem(&my_hist_map, &key);\r\nif (value)\r\n__sync_fetch_and_add(value, 1);\r\nelse\r\nbpf_map_update_elem(&my_hist_map, &key, &init_val, BPF_ANY);\r\nreturn 0;\r\n}

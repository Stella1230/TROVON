static void usage(void)\r\n{\r\nprintf("Usage: tc_l2_ipip_redirect [...]\n");\r\nprintf(" -U <file> Update an already pinned BPF array\n");\r\nprintf(" -i <ifindex> Interface index\n");\r\nprintf(" -h Display this help\n");\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nconst char *pinned_file = NULL;\r\nint ifindex = -1;\r\nint array_key = 0;\r\nint array_fd = -1;\r\nint ret = -1;\r\nint opt;\r\nwhile ((opt = getopt(argc, argv, "F:U:i:")) != -1) {\r\nswitch (opt) {\r\ncase 'U':\r\npinned_file = optarg;\r\nbreak;\r\ncase 'i':\r\nifindex = atoi(optarg);\r\nbreak;\r\ndefault:\r\nusage();\r\ngoto out;\r\n}\r\n}\r\nif (ifindex < 0 || !pinned_file) {\r\nusage();\r\ngoto out;\r\n}\r\narray_fd = bpf_obj_get(pinned_file);\r\nif (array_fd < 0) {\r\nfprintf(stderr, "bpf_obj_get(%s): %s(%d)\n",\r\npinned_file, strerror(errno), errno);\r\ngoto out;\r\n}\r\nret = bpf_map_update_elem(array_fd, &array_key, &ifindex, 0);\r\nif (ret) {\r\nperror("bpf_map_update_elem");\r\ngoto out;\r\n}\r\nout:\r\nif (array_fd != -1)\r\nclose(array_fd);\r\nreturn ret;\r\n}

static void smartq_usb_host_powercontrol(int port, int to)\r\n{\r\npr_debug("%s(%d, %d)\n", __func__, port, to);\r\nif (port == 0) {\r\ngpio_set_value(S3C64XX_GPL(0), to);\r\ngpio_set_value(S3C64XX_GPL(1), to);\r\n}\r\n}\r\nstatic irqreturn_t smartq_usb_host_ocirq(int irq, void *pw)\r\n{\r\nstruct s3c2410_hcd_info *info = pw;\r\nif (gpio_get_value(S3C64XX_GPL(10)) == 0) {\r\npr_debug("%s: over-current irq (oc detected)\n", __func__);\r\ns3c2410_usb_report_oc(info, 3);\r\n} else {\r\npr_debug("%s: over-current irq (oc cleared)\n", __func__);\r\ns3c2410_usb_report_oc(info, 0);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void smartq_usb_host_enableoc(struct s3c2410_hcd_info *info, int on)\r\n{\r\nint ret;\r\nif (machine_is_smartq5())\r\nreturn;\r\nif (on) {\r\nret = request_irq(gpio_to_irq(S3C64XX_GPL(10)),\r\nsmartq_usb_host_ocirq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"USB host overcurrent", info);\r\nif (ret != 0)\r\npr_err("failed to request usb oc irq: %d\n", ret);\r\n} else {\r\nfree_irq(gpio_to_irq(S3C64XX_GPL(10)), info);\r\n}\r\n}\r\nstatic int smartq_bl_init(struct device *dev)\r\n{\r\ns3c_gpio_cfgpin(S3C64XX_GPF(15), S3C_GPIO_SFN(2));\r\nreturn 0;\r\n}\r\nstatic int __init smartq_lcd_setup_gpio(void)\r\n{\r\nint ret;\r\nret = gpio_request(S3C64XX_GPM(3), "LCD power");\r\nif (ret < 0)\r\nreturn ret;\r\ngpio_direction_output(S3C64XX_GPM(3), 0);\r\nreturn 0;\r\n}\r\nstatic void smartq_lcd_power_set(struct plat_lcd_data *pd, unsigned int power)\r\n{\r\ngpio_direction_output(S3C64XX_GPM(3), power);\r\n}\r\nstatic void __init smartq_lcd_mode_set(void)\r\n{\r\nu32 tmp;\r\ntmp = __raw_readl(S3C64XX_SPCON);\r\ntmp &= ~S3C64XX_SPCON_LCD_SEL_MASK;\r\ntmp |= S3C64XX_SPCON_LCD_SEL_RGB;\r\n__raw_writel(tmp, S3C64XX_SPCON);\r\ntmp = __raw_readl(S3C64XX_MODEM_MIFPCON);\r\ntmp &= ~MIFPCON_LCD_BYPASS;\r\n__raw_writel(tmp, S3C64XX_MODEM_MIFPCON);\r\n}\r\nstatic void smartq_power_off(void)\r\n{\r\ngpio_direction_output(S3C64XX_GPK(15), 1);\r\n}\r\nstatic int __init smartq_power_off_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(S3C64XX_GPK(15), "Power control");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPK15\n", __func__);\r\nreturn ret;\r\n}\r\ngpio_direction_output(S3C64XX_GPK(15), 0);\r\npm_power_off = smartq_power_off;\r\nreturn ret;\r\n}\r\nstatic int __init smartq_usb_host_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(S3C64XX_GPL(0), "USB power control");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPL0\n", __func__);\r\nreturn ret;\r\n}\r\nret = gpio_request(S3C64XX_GPL(1), "USB host power control");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPL1\n", __func__);\r\ngoto err;\r\n}\r\nif (!machine_is_smartq5()) {\r\nret = gpio_request(S3C64XX_GPL(10), "USB host overcurrent");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPL10\n", __func__);\r\ngoto err2;\r\n}\r\n}\r\ngpio_direction_output(S3C64XX_GPL(0), 0);\r\ngpio_direction_output(S3C64XX_GPL(1), 0);\r\nif (!machine_is_smartq5())\r\ngpio_direction_input(S3C64XX_GPL(10));\r\ns3c_device_ohci.dev.platform_data = &smartq_usb_host_info;\r\nreturn 0;\r\nerr2:\r\ngpio_free(S3C64XX_GPL(1));\r\nerr:\r\ngpio_free(S3C64XX_GPL(0));\r\nreturn ret;\r\n}\r\nstatic int __init smartq_wifi_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(S3C64XX_GPK(1), "wifi control");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPK1\n", __func__);\r\nreturn ret;\r\n}\r\nret = gpio_request(S3C64XX_GPK(2), "wifi reset");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPK2\n", __func__);\r\ngpio_free(S3C64XX_GPK(1));\r\nreturn ret;\r\n}\r\ngpio_direction_output(S3C64XX_GPK(1), 1);\r\ngpio_direction_output(S3C64XX_GPK(2), 0);\r\nmdelay(100);\r\ngpio_set_value(S3C64XX_GPK(2), 1);\r\ngpio_direction_input(S3C64XX_GPK(2));\r\nreturn 0;\r\n}\r\nvoid __init smartq_map_io(void)\r\n{\r\ns3c64xx_init_io(smartq_iodesc, ARRAY_SIZE(smartq_iodesc));\r\ns3c64xx_set_xtal_freq(12000000);\r\ns3c64xx_set_xusbxti_freq(12000000);\r\ns3c24xx_init_uarts(smartq_uartcfgs, ARRAY_SIZE(smartq_uartcfgs));\r\nsamsung_set_timer_source(SAMSUNG_PWM3, SAMSUNG_PWM4);\r\nsmartq_lcd_mode_set();\r\n}\r\nvoid __init smartq_machine_init(void)\r\n{\r\ns3c_i2c0_set_platdata(NULL);\r\ndwc2_hsotg_set_platdata(&smartq_hsotg_pdata);\r\ns3c_hwmon_set_platdata(&smartq_hwmon_pdata);\r\ns3c_sdhci1_set_platdata(&smartq_internal_hsmmc_pdata);\r\ns3c_sdhci2_set_platdata(&smartq_internal_hsmmc_pdata);\r\ns3c64xx_ts_set_platdata(&smartq_touchscreen_pdata);\r\ni2c_register_board_info(0, smartq_i2c_devs,\r\nARRAY_SIZE(smartq_i2c_devs));\r\nWARN_ON(smartq_lcd_setup_gpio());\r\nWARN_ON(smartq_power_off_init());\r\nWARN_ON(smartq_usb_host_init());\r\nWARN_ON(smartq_wifi_init());\r\npwm_add_table(smartq_pwm_lookup, ARRAY_SIZE(smartq_pwm_lookup));\r\nplatform_add_devices(smartq_devices, ARRAY_SIZE(smartq_devices));\r\ngpiod_add_lookup_table(&smartq_audio_gpios);\r\nplatform_device_register_simple("smartq-audio", -1, NULL, 0);\r\n}

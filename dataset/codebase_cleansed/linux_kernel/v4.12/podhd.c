static ssize_t serial_number_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct snd_card *card = dev_to_snd_card(dev);\r\nstruct usb_line6_podhd *pod = card->private_data;\r\nreturn sprintf(buf, "%u\n", pod->serial_number);\r\n}\r\nstatic ssize_t firmware_version_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct snd_card *card = dev_to_snd_card(dev);\r\nstruct usb_line6_podhd *pod = card->private_data;\r\nreturn sprintf(buf, "%06x\n", pod->firmware_version);\r\n}\r\nstatic void podhd_startup(struct usb_line6_podhd *pod)\r\n{\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, PODHD_STARTUP_INIT);\r\nline6_start_timer(&pod->startup_timer, PODHD_STARTUP_DELAY,\r\npodhd_startup_start_workqueue, (unsigned long)pod);\r\n}\r\nstatic void podhd_startup_start_workqueue(unsigned long data)\r\n{\r\nstruct usb_line6_podhd *pod = (struct usb_line6_podhd *)data;\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress,\r\nPODHD_STARTUP_SCHEDULE_WORKQUEUE);\r\nschedule_work(&pod->startup_work);\r\n}\r\nstatic int podhd_dev_start(struct usb_line6_podhd *pod)\r\n{\r\nint ret;\r\nu8 init_bytes[8];\r\nint i;\r\nstruct usb_device *usbdev = pod->line6.usbdev;\r\nret = usb_control_msg(usbdev, usb_sndctrlpipe(usbdev, 0),\r\n0x67, USB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_OUT,\r\n0x11, 0,\r\nNULL, 0, LINE6_TIMEOUT * HZ);\r\nif (ret < 0) {\r\ndev_err(pod->line6.ifcdev, "read request failed (error %d)\n", ret);\r\nreturn ret;\r\n}\r\nret = usb_control_msg(usbdev, usb_rcvctrlpipe(usbdev, 0), 0x67,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x11, 0x0,\r\n&init_bytes, 3, LINE6_TIMEOUT * HZ);\r\nif (ret < 0) {\r\ndev_err(pod->line6.ifcdev,\r\n"receive length failed (error %d)\n", ret);\r\nreturn ret;\r\n}\r\npod->firmware_version =\r\n(init_bytes[0] << 16) | (init_bytes[1] << 8) | (init_bytes[2] << 0);\r\nfor (i = 0; i <= 16; i++) {\r\nret = line6_read_data(&pod->line6, 0xf000 + 0x08 * i, init_bytes, 8);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = usb_control_msg(usbdev, usb_sndctrlpipe(usbdev, 0),\r\nUSB_REQ_SET_FEATURE,\r\nUSB_TYPE_STANDARD | USB_RECIP_DEVICE | USB_DIR_OUT,\r\n1, 0,\r\nNULL, 0, LINE6_TIMEOUT * HZ);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void podhd_startup_workqueue(struct work_struct *work)\r\n{\r\nstruct usb_line6_podhd *pod =\r\ncontainer_of(work, struct usb_line6_podhd, startup_work);\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, PODHD_STARTUP_SETUP);\r\npodhd_dev_start(pod);\r\nline6_read_serial_number(&pod->line6, &pod->serial_number);\r\npodhd_startup_finalize(pod);\r\n}\r\nstatic int podhd_startup_finalize(struct usb_line6_podhd *pod)\r\n{\r\nstruct usb_line6 *line6 = &pod->line6;\r\nreturn snd_card_register(line6->card);\r\n}\r\nstatic void podhd_disconnect(struct usb_line6 *line6)\r\n{\r\nstruct usb_line6_podhd *pod = (struct usb_line6_podhd *)line6;\r\nif (pod->line6.properties->capabilities & LINE6_CAP_CONTROL) {\r\nstruct usb_interface *intf;\r\ndel_timer_sync(&pod->startup_timer);\r\ncancel_work_sync(&pod->startup_work);\r\nintf = usb_ifnum_to_if(line6->usbdev,\r\npod->line6.properties->ctrl_if);\r\nusb_driver_release_interface(&podhd_driver, intf);\r\n}\r\n}\r\nstatic int podhd_init(struct usb_line6 *line6,\r\nconst struct usb_device_id *id)\r\n{\r\nint err;\r\nstruct usb_line6_podhd *pod = (struct usb_line6_podhd *) line6;\r\nstruct usb_interface *intf;\r\nline6->disconnect = podhd_disconnect;\r\nif (pod->line6.properties->capabilities & LINE6_CAP_CONTROL) {\r\nintf = usb_ifnum_to_if(line6->usbdev,\r\npod->line6.properties->ctrl_if);\r\nif (!intf) {\r\ndev_err(pod->line6.ifcdev, "interface %d not found\n",\r\npod->line6.properties->ctrl_if);\r\nreturn -ENODEV;\r\n}\r\nerr = usb_driver_claim_interface(&podhd_driver, intf, NULL);\r\nif (err != 0) {\r\ndev_err(pod->line6.ifcdev, "can't claim interface %d, error %d\n",\r\npod->line6.properties->ctrl_if, err);\r\nreturn err;\r\n}\r\nerr = snd_card_add_dev_attr(line6->card, &podhd_dev_attr_group);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (pod->line6.properties->capabilities & LINE6_CAP_PCM) {\r\nerr = line6_init_pcm(line6,\r\n(id->driver_info == LINE6_PODX3 ||\r\nid->driver_info == LINE6_PODX3LIVE) ? &podx3_pcm_properties :\r\n&podhd_pcm_properties);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (!(pod->line6.properties->capabilities & LINE6_CAP_CONTROL)) {\r\nreturn podhd_startup_finalize(pod);\r\n}\r\ninit_timer(&pod->startup_timer);\r\nINIT_WORK(&pod->startup_work, podhd_startup_workqueue);\r\npodhd_startup(pod);\r\nreturn 0;\r\n}\r\nstatic int podhd_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn line6_probe(interface, id, "Line6-PODHD",\r\n&podhd_properties_table[id->driver_info],\r\npodhd_init, sizeof(struct usb_line6_podhd));\r\n}

void b2062_upload_init_table(struct b43_wldev *dev)\r\n{\r\nconst struct b206x_init_tab_entry *e;\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(b2062_init_tab); i++) {\r\ne = &b2062_init_tab[i];\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif (!(e->flags & B206X_FLAG_G))\r\ncontinue;\r\nb43_radio_write(dev, e->offset, e->value_g);\r\n} else {\r\nif (!(e->flags & B206X_FLAG_A))\r\ncontinue;\r\nb43_radio_write(dev, e->offset, e->value_a);\r\n}\r\n}\r\n}\r\nvoid b2063_upload_init_table(struct b43_wldev *dev)\r\n{\r\nconst struct b206x_init_tab_entry *e;\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(b2063_init_tab); i++) {\r\ne = &b2063_init_tab[i];\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif (!(e->flags & B206X_FLAG_G))\r\ncontinue;\r\nb43_radio_write(dev, e->offset, e->value_g);\r\n} else {\r\nif (!(e->flags & B206X_FLAG_A))\r\ncontinue;\r\nb43_radio_write(dev, e->offset, e->value_a);\r\n}\r\n}\r\n}\r\nu32 b43_lptab_read(struct b43_wldev *dev, u32 offset)\r\n{\r\nu32 type, value;\r\ntype = offset & B43_LPTAB_TYPEMASK;\r\noffset &= ~B43_LPTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nswitch (type) {\r\ncase B43_LPTAB_8BIT:\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_LPPHY_TABLEDATALO) & 0xFF;\r\nbreak;\r\ncase B43_LPTAB_16BIT:\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_LPPHY_TABLEDATALO);\r\nbreak;\r\ncase B43_LPTAB_32BIT:\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_LPPHY_TABLEDATAHI);\r\nvalue <<= 16;\r\nvalue |= b43_phy_read(dev, B43_LPPHY_TABLEDATALO);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\nvalue = 0;\r\n}\r\nreturn value;\r\n}\r\nvoid b43_lptab_read_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, void *_data)\r\n{\r\nu32 type;\r\nu8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_LPTAB_TYPEMASK;\r\noffset &= ~B43_LPTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nswitch (type) {\r\ncase B43_LPTAB_8BIT:\r\n*data = b43_phy_read(dev, B43_LPPHY_TABLEDATALO) & 0xFF;\r\ndata++;\r\nbreak;\r\ncase B43_LPTAB_16BIT:\r\n*((u16 *)data) = b43_phy_read(dev, B43_LPPHY_TABLEDATALO);\r\ndata += 2;\r\nbreak;\r\ncase B43_LPTAB_32BIT:\r\n*((u32 *)data) = b43_phy_read(dev, B43_LPPHY_TABLEDATAHI);\r\n*((u32 *)data) <<= 16;\r\n*((u32 *)data) |= b43_phy_read(dev, B43_LPPHY_TABLEDATALO);\r\ndata += 4;\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nvoid b43_lptab_write(struct b43_wldev *dev, u32 offset, u32 value)\r\n{\r\nu32 type;\r\ntype = offset & B43_LPTAB_TYPEMASK;\r\noffset &= ~B43_LPTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nswitch (type) {\r\ncase B43_LPTAB_8BIT:\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ncase B43_LPTAB_16BIT:\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ncase B43_LPTAB_32BIT:\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATAHI, value >> 16);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\nvoid b43_lptab_write_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, const void *_data)\r\n{\r\nu32 type, value;\r\nconst u8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_LPTAB_TYPEMASK;\r\noffset &= ~B43_LPTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nswitch (type) {\r\ncase B43_LPTAB_8BIT:\r\nvalue = *data;\r\ndata++;\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ncase B43_LPTAB_16BIT:\r\nvalue = *((u16 *)data);\r\ndata += 2;\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ncase B43_LPTAB_32BIT:\r\nvalue = *((u32 *)data);\r\ndata += 4;\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATAHI, value >> 16);\r\nb43_phy_write(dev, B43_LPPHY_TABLEDATALO, value);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nvoid lpphy_rev0_1_table_init(struct b43_wldev *dev)\r\n{\r\nB43_WARN_ON(dev->phy.rev >= 2);\r\nb43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),\r\nARRAY_SIZE(lpphy_min_sig_sq_table), lpphy_min_sig_sq_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),\r\nARRAY_SIZE(lpphy_rev01_noise_scale_table), lpphy_rev01_noise_scale_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),\r\nARRAY_SIZE(lpphy_crs_gain_nft_table), lpphy_crs_gain_nft_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(8, 0),\r\nARRAY_SIZE(lpphy_rev01_filter_control_table), lpphy_rev01_filter_control_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),\r\nARRAY_SIZE(lpphy_rev01_ps_control_table), lpphy_rev01_ps_control_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),\r\nARRAY_SIZE(lpphy_pll_fraction_table), lpphy_pll_fraction_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),\r\nARRAY_SIZE(lpphy_iqlo_cal_table), lpphy_iqlo_cal_table);\r\nif (dev->phy.rev == 0) {\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(13, 0),\r\nARRAY_SIZE(lpphy_rev0_ofdm_cck_gain_table), lpphy_rev0_ofdm_cck_gain_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(12, 0),\r\nARRAY_SIZE(lpphy_rev0_ofdm_cck_gain_table), lpphy_rev0_ofdm_cck_gain_table);\r\n} else {\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(13, 0),\r\nARRAY_SIZE(lpphy_rev1_ofdm_cck_gain_table), lpphy_rev1_ofdm_cck_gain_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(12, 0),\r\nARRAY_SIZE(lpphy_rev1_ofdm_cck_gain_table), lpphy_rev1_ofdm_cck_gain_table);\r\n}\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),\r\nARRAY_SIZE(lpphy_gain_delta_table), lpphy_gain_delta_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),\r\nARRAY_SIZE(lpphy_tx_power_control_table), lpphy_tx_power_control_table);\r\n}\r\nvoid lpphy_rev2plus_table_init(struct b43_wldev *dev)\r\n{\r\nint i;\r\nB43_WARN_ON(dev->phy.rev < 2);\r\nfor (i = 0; i < 704; i++)\r\nb43_lptab_write(dev, B43_LPTAB32(7, i), 0);\r\nb43_lptab_write_bulk(dev, B43_LPTAB8(2, 0),\r\nARRAY_SIZE(lpphy_min_sig_sq_table), lpphy_min_sig_sq_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(1, 0),\r\nARRAY_SIZE(lpphy_rev2plus_noise_scale_table), lpphy_rev2plus_noise_scale_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(11, 0),\r\nARRAY_SIZE(lpphy_rev2plus_filter_control_table), lpphy_rev2plus_filter_control_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(12, 0),\r\nARRAY_SIZE(lpphy_rev2plus_ps_control_table), lpphy_rev2plus_ps_control_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),\r\nARRAY_SIZE(lpphy_gain_idx_table), lpphy_gain_idx_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),\r\nARRAY_SIZE(lpphy_aux_gain_idx_table), lpphy_aux_gain_idx_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(15, 0),\r\nARRAY_SIZE(lpphy_sw_control_table), lpphy_sw_control_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB8(16, 0),\r\nARRAY_SIZE(lpphy_hf_table), lpphy_hf_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),\r\nARRAY_SIZE(lpphy_gain_value_table), lpphy_gain_value_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),\r\nARRAY_SIZE(lpphy_gain_table), lpphy_gain_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB8(6, 0),\r\nARRAY_SIZE(lpphy_pll_fraction_table), lpphy_pll_fraction_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(0, 0),\r\nARRAY_SIZE(lpphy_iqlo_cal_table), lpphy_iqlo_cal_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(9, 0),\r\nARRAY_SIZE(lpphy_papd_eps_table), lpphy_papd_eps_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(10, 0),\r\nARRAY_SIZE(lpphy_papd_mult_table), lpphy_papd_mult_table);\r\nif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(13, 0),\r\nARRAY_SIZE(lpphy_a0_gain_idx_table), lpphy_a0_gain_idx_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(14, 0),\r\nARRAY_SIZE(lpphy_a0_aux_gain_idx_table), lpphy_a0_aux_gain_idx_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(17, 0),\r\nARRAY_SIZE(lpphy_a0_gain_value_table), lpphy_a0_gain_value_table);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(18, 0),\r\nARRAY_SIZE(lpphy_a0_gain_table), lpphy_a0_gain_table);\r\n}\r\n}\r\nstatic void lpphy_rev0_1_write_gain_table(struct b43_wldev *dev, int offset,\r\nstruct lpphy_tx_gain_table_entry data)\r\n{\r\nu32 tmp;\r\nB43_WARN_ON(dev->phy.rev >= 2);\r\ntmp = data.pad << 11;\r\ntmp |= data.pga << 7;\r\ntmp |= data.gm << 4;\r\ntmp |= data.dac;\r\nb43_lptab_write(dev, B43_LPTAB32(10, 0xC0 + offset), tmp);\r\ntmp = data.bb_mult << 20;\r\nb43_lptab_write(dev, B43_LPTAB32(10, 0x140 + offset), tmp);\r\n}\r\nstatic void lpphy_rev2plus_write_gain_table(struct b43_wldev *dev, int offset,\r\nstruct lpphy_tx_gain_table_entry data)\r\n{\r\nu32 tmp;\r\nB43_WARN_ON(dev->phy.rev < 2);\r\ntmp = data.pad << 16;\r\ntmp |= data.pga << 8;\r\ntmp |= data.gm;\r\nif (dev->phy.rev >= 3) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\ntmp |= 0x10 << 24;\r\nelse\r\ntmp |= 0x70 << 24;\r\n} else {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\ntmp |= 0x14 << 24;\r\nelse\r\ntmp |= 0x7F << 24;\r\n}\r\nb43_lptab_write(dev, B43_LPTAB32(7, 0xC0 + offset), tmp);\r\ntmp = data.bb_mult << 20;\r\ntmp |= data.dac << 28;\r\nb43_lptab_write(dev, B43_LPTAB32(7, 0x140 + offset), tmp);\r\n}\r\nvoid lpphy_write_gain_table(struct b43_wldev *dev, int offset,\r\nstruct lpphy_tx_gain_table_entry data)\r\n{\r\nif (dev->phy.rev >= 2)\r\nlpphy_rev2plus_write_gain_table(dev, offset, data);\r\nelse\r\nlpphy_rev0_1_write_gain_table(dev, offset, data);\r\n}\r\nvoid lpphy_write_gain_table_bulk(struct b43_wldev *dev, int offset, int count,\r\nstruct lpphy_tx_gain_table_entry *table)\r\n{\r\nint i;\r\nfor (i = offset; i < count; i++)\r\nlpphy_write_gain_table(dev, i, table[i]);\r\n}\r\nvoid lpphy_init_tx_gain_table(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nswitch (dev->phy.rev) {\r\ncase 0:\r\nif ((sprom->boardflags_hi & B43_BFH_NOPA) ||\r\n(sprom->boardflags_lo & B43_BFL_HGPA))\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev0_nopa_tx_gain_table);\r\nelse if (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev0_2ghz_tx_gain_table);\r\nelse\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev0_5ghz_tx_gain_table);\r\nbreak;\r\ncase 1:\r\nif ((sprom->boardflags_hi & B43_BFH_NOPA) ||\r\n(sprom->boardflags_lo & B43_BFL_HGPA))\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev1_nopa_tx_gain_table);\r\nelse if (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev1_2ghz_tx_gain_table);\r\nelse\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev1_5ghz_tx_gain_table);\r\nbreak;\r\ndefault:\r\nif (sprom->boardflags_hi & B43_BFH_NOPA)\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev2_nopa_tx_gain_table);\r\nelse if (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev2_2ghz_tx_gain_table);\r\nelse\r\nlpphy_write_gain_table_bulk(dev, 0, 128,\r\nlpphy_rev2_5ghz_tx_gain_table);\r\n}\r\n}

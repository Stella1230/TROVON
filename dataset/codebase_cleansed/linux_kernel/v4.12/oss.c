void __init oss_init(void)\r\n{\r\nint i;\r\nif (!oss_present) return;\r\noss = (struct mac_oss *) OSS_BASE;\r\nfor (i = 0; i < OSS_NUM_SOURCES; i++)\r\noss->irq_level[i] = 0;\r\n}\r\nvoid __init oss_nubus_init(void)\r\n{\r\n}\r\nstatic void oss_irq(struct irq_desc *desc)\r\n{\r\nint events = oss->irq_pending &\r\n(OSS_IP_IOPSCC | OSS_IP_SCSI | OSS_IP_IOPISM);\r\nif (events & OSS_IP_IOPSCC) {\r\noss->irq_pending &= ~OSS_IP_IOPSCC;\r\ngeneric_handle_irq(IRQ_MAC_SCC);\r\n}\r\nif (events & OSS_IP_SCSI) {\r\noss->irq_pending &= ~OSS_IP_SCSI;\r\ngeneric_handle_irq(IRQ_MAC_SCSI);\r\n}\r\nif (events & OSS_IP_IOPISM) {\r\noss->irq_pending &= ~OSS_IP_IOPISM;\r\ngeneric_handle_irq(IRQ_MAC_ADB);\r\n}\r\n}\r\nstatic void oss_nubus_irq(struct irq_desc *desc)\r\n{\r\nint events, irq_bit, i;\r\nevents = oss->irq_pending & OSS_IP_NUBUS;\r\nif (!events)\r\nreturn;\r\ni = 6;\r\nirq_bit = 0x40;\r\ndo {\r\n--i;\r\nirq_bit >>= 1;\r\nif (events & irq_bit) {\r\noss->irq_pending &= ~irq_bit;\r\ngeneric_handle_irq(NUBUS_SOURCE_BASE + i);\r\n}\r\n} while(events & (irq_bit - 1));\r\n}\r\nvoid __init oss_register_interrupts(void)\r\n{\r\nirq_set_chained_handler(OSS_IRQLEV_IOPISM, oss_irq);\r\nirq_set_chained_handler(OSS_IRQLEV_SCSI, oss_irq);\r\nirq_set_chained_handler(OSS_IRQLEV_NUBUS, oss_nubus_irq);\r\nirq_set_chained_handler(OSS_IRQLEV_IOPSCC, oss_irq);\r\nirq_set_chained_handler(OSS_IRQLEV_VIA1, via1_irq);\r\noss->irq_level[OSS_VIA1] = IRQ_AUTO_6;\r\n}\r\nvoid oss_irq_enable(int irq) {\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\noss->irq_level[OSS_IOPSCC] = OSS_IRQLEV_IOPSCC;\r\nreturn;\r\ncase IRQ_MAC_ADB:\r\noss->irq_level[OSS_IOPISM] = OSS_IRQLEV_IOPISM;\r\nreturn;\r\ncase IRQ_MAC_SCSI:\r\noss->irq_level[OSS_SCSI] = OSS_IRQLEV_SCSI;\r\nreturn;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\noss->irq_level[irq] = OSS_IRQLEV_NUBUS;\r\nreturn;\r\n}\r\nif (IRQ_SRC(irq) == 1)\r\nvia_irq_enable(irq);\r\n}\r\nvoid oss_irq_disable(int irq) {\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\noss->irq_level[OSS_IOPSCC] = 0;\r\nreturn;\r\ncase IRQ_MAC_ADB:\r\noss->irq_level[OSS_IOPISM] = 0;\r\nreturn;\r\ncase IRQ_MAC_SCSI:\r\noss->irq_level[OSS_SCSI] = 0;\r\nreturn;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\noss->irq_level[irq] = 0;\r\nreturn;\r\n}\r\nif (IRQ_SRC(irq) == 1)\r\nvia_irq_disable(irq);\r\n}

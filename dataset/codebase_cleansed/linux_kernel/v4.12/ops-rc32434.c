static inline int config_access(unsigned char access_type,\r\nstruct pci_bus *bus, unsigned int devfn,\r\nunsigned char where, u32 *data)\r\n{\r\nunsigned int slot = PCI_SLOT(devfn);\r\nu8 func = PCI_FUNC(devfn);\r\nPCI_CFG_SET(bus->number, slot, func, where);\r\nrc32434_sync();\r\nif (access_type == PCI_ACCESS_WRITE)\r\nrc32434_pci->pcicfgd = *data;\r\nelse\r\n*data = rc32434_pci->pcicfgd;\r\nrc32434_sync();\r\nreturn 0;\r\n}\r\nstatic int read_config_byte(struct pci_bus *bus, unsigned int devfn,\r\nint where, u8 *val)\r\n{\r\nu32 data;\r\nint ret;\r\nret = config_access(PCI_ACCESS_READ, bus, devfn, where, &data);\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nreturn ret;\r\n}\r\nstatic int read_config_word(struct pci_bus *bus, unsigned int devfn,\r\nint where, u16 *val)\r\n{\r\nu32 data;\r\nint ret;\r\nret = config_access(PCI_ACCESS_READ, bus, devfn, where, &data);\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nreturn ret;\r\n}\r\nstatic int read_config_dword(struct pci_bus *bus, unsigned int devfn,\r\nint where, u32 *val)\r\n{\r\nint ret;\r\nint delay = 1;\r\nif (bus->number == 0 && PCI_SLOT(devfn) > 21)\r\nreturn 0;\r\nretry:\r\nret = config_access(PCI_ACCESS_READ, bus, devfn, where, val);\r\nif (where == PCI_VENDOR_ID) {\r\nif (ret == 0xffffffff || ret == 0x00000000 ||\r\nret == 0x0000ffff || ret == 0xffff0000) {\r\nif (delay > 4)\r\nreturn 0;\r\ndelay *= 2;\r\nmsleep(delay);\r\ngoto retry;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nwrite_config_byte(struct pci_bus *bus, unsigned int devfn, int where,\r\nu8 val)\r\n{\r\nu32 data = 0;\r\nif (config_access(PCI_ACCESS_READ, bus, devfn, where, &data))\r\nreturn -1;\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nif (config_access(PCI_ACCESS_WRITE, bus, devfn, where, &data))\r\nreturn -1;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\nwrite_config_word(struct pci_bus *bus, unsigned int devfn, int where,\r\nu16 val)\r\n{\r\nu32 data = 0;\r\nif (config_access(PCI_ACCESS_READ, bus, devfn, where, &data))\r\nreturn -1;\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nif (config_access(PCI_ACCESS_WRITE, bus, devfn, where, &data))\r\nreturn -1;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\nwrite_config_dword(struct pci_bus *bus, unsigned int devfn, int where,\r\nu32 val)\r\n{\r\nif (config_access(PCI_ACCESS_WRITE, bus, devfn, where, &val))\r\nreturn -1;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pci_config_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nswitch (size) {\r\ncase 1:\r\nreturn read_config_byte(bus, devfn, where, (u8 *) val);\r\ncase 2:\r\nreturn read_config_word(bus, devfn, where, (u16 *) val);\r\ndefault:\r\nreturn read_config_dword(bus, devfn, where, val);\r\n}\r\n}\r\nstatic int pci_config_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nswitch (size) {\r\ncase 1:\r\nreturn write_config_byte(bus, devfn, where, (u8) val);\r\ncase 2:\r\nreturn write_config_word(bus, devfn, where, (u16) val);\r\ndefault:\r\nreturn write_config_dword(bus, devfn, where, val);\r\n}\r\n}

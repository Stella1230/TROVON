int altera_jinit(struct altera_state *astate)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\njs->jtag_state = ILLEGAL_JTAG_STATE;\r\njs->drstop_state = IDLE;\r\njs->irstop_state = IDLE;\r\njs->dr_pre = 0;\r\njs->dr_post = 0;\r\njs->ir_pre = 0;\r\njs->ir_post = 0;\r\njs->dr_length = 0;\r\njs->ir_length = 0;\r\njs->dr_pre_data = NULL;\r\njs->dr_post_data = NULL;\r\njs->ir_pre_data = NULL;\r\njs->ir_post_data = NULL;\r\njs->dr_buffer = NULL;\r\njs->ir_buffer = NULL;\r\nreturn 0;\r\n}\r\nint altera_set_drstop(struct altera_jtag *js, enum altera_jtag_state state)\r\n{\r\njs->drstop_state = state;\r\nreturn 0;\r\n}\r\nint altera_set_irstop(struct altera_jtag *js, enum altera_jtag_state state)\r\n{\r\njs->irstop_state = state;\r\nreturn 0;\r\n}\r\nint altera_set_dr_pre(struct altera_jtag *js,\r\nu32 count, u32 start_index,\r\nu8 *preamble_data)\r\n{\r\nint status = 0;\r\nu32 i;\r\nu32 j;\r\nif (count > js->dr_pre) {\r\nkfree(js->dr_pre_data);\r\njs->dr_pre_data = (u8 *)alt_malloc((count + 7) >> 3);\r\nif (js->dr_pre_data == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->dr_pre = count;\r\n} else\r\njs->dr_pre = count;\r\nif (status == 0) {\r\nfor (i = 0; i < count; ++i) {\r\nj = i + start_index;\r\nif (preamble_data == NULL)\r\njs->dr_pre_data[i >> 3] |= (1 << (i & 7));\r\nelse {\r\nif (preamble_data[j >> 3] & (1 << (j & 7)))\r\njs->dr_pre_data[i >> 3] |=\r\n(1 << (i & 7));\r\nelse\r\njs->dr_pre_data[i >> 3] &=\r\n~(u32)(1 << (i & 7));\r\n}\r\n}\r\n}\r\nreturn status;\r\n}\r\nint altera_set_ir_pre(struct altera_jtag *js, u32 count, u32 start_index,\r\nu8 *preamble_data)\r\n{\r\nint status = 0;\r\nu32 i;\r\nu32 j;\r\nif (count > js->ir_pre) {\r\nkfree(js->ir_pre_data);\r\njs->ir_pre_data = (u8 *)alt_malloc((count + 7) >> 3);\r\nif (js->ir_pre_data == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->ir_pre = count;\r\n} else\r\njs->ir_pre = count;\r\nif (status == 0) {\r\nfor (i = 0; i < count; ++i) {\r\nj = i + start_index;\r\nif (preamble_data == NULL)\r\njs->ir_pre_data[i >> 3] |= (1 << (i & 7));\r\nelse {\r\nif (preamble_data[j >> 3] & (1 << (j & 7)))\r\njs->ir_pre_data[i >> 3] |=\r\n(1 << (i & 7));\r\nelse\r\njs->ir_pre_data[i >> 3] &=\r\n~(u32)(1 << (i & 7));\r\n}\r\n}\r\n}\r\nreturn status;\r\n}\r\nint altera_set_dr_post(struct altera_jtag *js, u32 count, u32 start_index,\r\nu8 *postamble_data)\r\n{\r\nint status = 0;\r\nu32 i;\r\nu32 j;\r\nif (count > js->dr_post) {\r\nkfree(js->dr_post_data);\r\njs->dr_post_data = (u8 *)alt_malloc((count + 7) >> 3);\r\nif (js->dr_post_data == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->dr_post = count;\r\n} else\r\njs->dr_post = count;\r\nif (status == 0) {\r\nfor (i = 0; i < count; ++i) {\r\nj = i + start_index;\r\nif (postamble_data == NULL)\r\njs->dr_post_data[i >> 3] |= (1 << (i & 7));\r\nelse {\r\nif (postamble_data[j >> 3] & (1 << (j & 7)))\r\njs->dr_post_data[i >> 3] |=\r\n(1 << (i & 7));\r\nelse\r\njs->dr_post_data[i >> 3] &=\r\n~(u32)(1 << (i & 7));\r\n}\r\n}\r\n}\r\nreturn status;\r\n}\r\nint altera_set_ir_post(struct altera_jtag *js, u32 count, u32 start_index,\r\nu8 *postamble_data)\r\n{\r\nint status = 0;\r\nu32 i;\r\nu32 j;\r\nif (count > js->ir_post) {\r\nkfree(js->ir_post_data);\r\njs->ir_post_data = (u8 *)alt_malloc((count + 7) >> 3);\r\nif (js->ir_post_data == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->ir_post = count;\r\n} else\r\njs->ir_post = count;\r\nif (status != 0)\r\nreturn status;\r\nfor (i = 0; i < count; ++i) {\r\nj = i + start_index;\r\nif (postamble_data == NULL)\r\njs->ir_post_data[i >> 3] |= (1 << (i & 7));\r\nelse {\r\nif (postamble_data[j >> 3] & (1 << (j & 7)))\r\njs->ir_post_data[i >> 3] |= (1 << (i & 7));\r\nelse\r\njs->ir_post_data[i >> 3] &=\r\n~(u32)(1 << (i & 7));\r\n}\r\n}\r\nreturn status;\r\n}\r\nstatic void altera_jreset_idle(struct altera_state *astate)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint i;\r\nfor (i = 0; i < 5; ++i)\r\nalt_jtag_io(TMS_HIGH, TDI_LOW, IGNORE_TDO);\r\nalt_jtag_io(TMS_LOW, TDI_LOW, IGNORE_TDO);\r\njs->jtag_state = IDLE;\r\n}\r\nint altera_goto_jstate(struct altera_state *astate,\r\nenum altera_jtag_state state)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint tms;\r\nint count = 0;\r\nint status = 0;\r\nif (js->jtag_state == ILLEGAL_JTAG_STATE)\r\naltera_jreset_idle(astate);\r\nif (js->jtag_state == state) {\r\nif ((state == IDLE) || (state == DRSHIFT) ||\r\n(state == DRPAUSE) || (state == IRSHIFT) ||\r\n(state == IRPAUSE)) {\r\nalt_jtag_io(TMS_LOW, TDI_LOW, IGNORE_TDO);\r\n} else if (state == RESET)\r\nalt_jtag_io(TMS_HIGH, TDI_LOW, IGNORE_TDO);\r\n} else {\r\nwhile ((js->jtag_state != state) && (count < 9)) {\r\ntms = (altera_jtag_path_map[js->jtag_state] &\r\n(1 << state))\r\n? TMS_HIGH : TMS_LOW;\r\nalt_jtag_io(tms, TDI_LOW, IGNORE_TDO);\r\nif (tms)\r\njs->jtag_state =\r\naltera_transitions[js->jtag_state].tms_high;\r\nelse\r\njs->jtag_state =\r\naltera_transitions[js->jtag_state].tms_low;\r\n++count;\r\n}\r\n}\r\nif (js->jtag_state != state)\r\nstatus = -EREMOTEIO;\r\nreturn status;\r\n}\r\nint altera_wait_cycles(struct altera_state *astate,\r\ns32 cycles,\r\nenum altera_jtag_state wait_state)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint tms;\r\ns32 count;\r\nint status = 0;\r\nif (js->jtag_state != wait_state)\r\nstatus = altera_goto_jstate(astate, wait_state);\r\nif (status == 0) {\r\ntms = (wait_state == RESET) ? TMS_HIGH : TMS_LOW;\r\nfor (count = 0L; count < cycles; count++)\r\nalt_jtag_io(tms, TDI_LOW, IGNORE_TDO);\r\n}\r\nreturn status;\r\n}\r\nint altera_wait_msecs(struct altera_state *astate,\r\ns32 microseconds, enum altera_jtag_state wait_state)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint status = 0;\r\nif ((js->jtag_state != ILLEGAL_JTAG_STATE) &&\r\n(js->jtag_state != wait_state))\r\nstatus = altera_goto_jstate(astate, wait_state);\r\nif (status == 0)\r\nudelay(microseconds);\r\nreturn status;\r\n}\r\nstatic void altera_concatenate_data(u8 *buffer,\r\nu8 *preamble_data,\r\nu32 preamble_count,\r\nu8 *target_data,\r\nu32 start_index,\r\nu32 target_count,\r\nu8 *postamble_data,\r\nu32 postamble_count)\r\n{\r\nu32 i, j, k;\r\nfor (i = 0L; i < preamble_count; ++i) {\r\nif (preamble_data[i >> 3L] & (1L << (i & 7L)))\r\nbuffer[i >> 3L] |= (1L << (i & 7L));\r\nelse\r\nbuffer[i >> 3L] &= ~(u32)(1L << (i & 7L));\r\n}\r\nj = start_index;\r\nk = preamble_count + target_count;\r\nfor (; i < k; ++i, ++j) {\r\nif (target_data[j >> 3L] & (1L << (j & 7L)))\r\nbuffer[i >> 3L] |= (1L << (i & 7L));\r\nelse\r\nbuffer[i >> 3L] &= ~(u32)(1L << (i & 7L));\r\n}\r\nj = 0L;\r\nk = preamble_count + target_count + postamble_count;\r\nfor (; i < k; ++i, ++j) {\r\nif (postamble_data[j >> 3L] & (1L << (j & 7L)))\r\nbuffer[i >> 3L] |= (1L << (i & 7L));\r\nelse\r\nbuffer[i >> 3L] &= ~(u32)(1L << (i & 7L));\r\n}\r\n}\r\nstatic int alt_jtag_drscan(struct altera_state *astate,\r\nint start_state,\r\nint count,\r\nu8 *tdi,\r\nu8 *tdo)\r\n{\r\nint i = 0;\r\nint tdo_bit = 0;\r\nint status = 1;\r\nswitch (start_state) {\r\ncase 0:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ncase 1:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ncase 2:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ndefault:\r\nstatus = 0;\r\n}\r\nif (status) {\r\nfor (i = 0; i < count; i++) {\r\ntdo_bit = alt_jtag_io(\r\n(i == count - 1),\r\ntdi[i >> 3] & (1 << (i & 7)),\r\n(tdo != NULL));\r\nif (tdo != NULL) {\r\nif (tdo_bit)\r\ntdo[i >> 3] |= (1 << (i & 7));\r\nelse\r\ntdo[i >> 3] &= ~(u32)(1 << (i & 7));\r\n}\r\n}\r\nalt_jtag_io(0, 0, 0);\r\n}\r\nreturn status;\r\n}\r\nstatic int alt_jtag_irscan(struct altera_state *astate,\r\nint start_state,\r\nint count,\r\nu8 *tdi,\r\nu8 *tdo)\r\n{\r\nint i = 0;\r\nint tdo_bit = 0;\r\nint status = 1;\r\nswitch (start_state) {\r\ncase 0:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ncase 1:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ncase 2:\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(1, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nalt_jtag_io(0, 0, 0);\r\nbreak;\r\ndefault:\r\nstatus = 0;\r\n}\r\nif (status) {\r\nfor (i = 0; i < count; i++) {\r\ntdo_bit = alt_jtag_io(\r\n(i == count - 1),\r\ntdi[i >> 3] & (1 << (i & 7)),\r\n(tdo != NULL));\r\nif (tdo != NULL) {\r\nif (tdo_bit)\r\ntdo[i >> 3] |= (1 << (i & 7));\r\nelse\r\ntdo[i >> 3] &= ~(u32)(1 << (i & 7));\r\n}\r\n}\r\nalt_jtag_io(0, 0, 0);\r\n}\r\nreturn status;\r\n}\r\nstatic void altera_extract_target_data(u8 *buffer,\r\nu8 *target_data,\r\nu32 start_index,\r\nu32 preamble_count,\r\nu32 target_count)\r\n{\r\nu32 i;\r\nu32 j;\r\nu32 k;\r\nj = preamble_count;\r\nk = start_index + target_count;\r\nfor (i = start_index; i < k; ++i, ++j) {\r\nif (buffer[j >> 3] & (1 << (j & 7)))\r\ntarget_data[i >> 3] |= (1 << (i & 7));\r\nelse\r\ntarget_data[i >> 3] &= ~(u32)(1 << (i & 7));\r\n}\r\n}\r\nint altera_irscan(struct altera_state *astate,\r\nu32 count,\r\nu8 *tdi_data,\r\nu32 start_index)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint start_code = 0;\r\nu32 alloc_chars = 0;\r\nu32 shift_count = js->ir_pre + count + js->ir_post;\r\nint status = 0;\r\nenum altera_jtag_state start_state = ILLEGAL_JTAG_STATE;\r\nswitch (js->jtag_state) {\r\ncase ILLEGAL_JTAG_STATE:\r\ncase RESET:\r\ncase IDLE:\r\nstart_code = 0;\r\nstart_state = IDLE;\r\nbreak;\r\ncase DRSELECT:\r\ncase DRCAPTURE:\r\ncase DRSHIFT:\r\ncase DREXIT1:\r\ncase DRPAUSE:\r\ncase DREXIT2:\r\ncase DRUPDATE:\r\nstart_code = 1;\r\nstart_state = DRPAUSE;\r\nbreak;\r\ncase IRSELECT:\r\ncase IRCAPTURE:\r\ncase IRSHIFT:\r\ncase IREXIT1:\r\ncase IRPAUSE:\r\ncase IREXIT2:\r\ncase IRUPDATE:\r\nstart_code = 2;\r\nstart_state = IRPAUSE;\r\nbreak;\r\ndefault:\r\nstatus = -EREMOTEIO;\r\nbreak;\r\n}\r\nif (status == 0)\r\nif (js->jtag_state != start_state)\r\nstatus = altera_goto_jstate(astate, start_state);\r\nif (status == 0) {\r\nif (shift_count > js->ir_length) {\r\nalloc_chars = (shift_count + 7) >> 3;\r\nkfree(js->ir_buffer);\r\njs->ir_buffer = (u8 *)alt_malloc(alloc_chars);\r\nif (js->ir_buffer == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->ir_length = alloc_chars * 8;\r\n}\r\n}\r\nif (status == 0) {\r\naltera_concatenate_data(js->ir_buffer,\r\njs->ir_pre_data,\r\njs->ir_pre,\r\ntdi_data,\r\nstart_index,\r\ncount,\r\njs->ir_post_data,\r\njs->ir_post);\r\nalt_jtag_irscan(astate,\r\nstart_code,\r\nshift_count,\r\njs->ir_buffer,\r\nNULL);\r\njs->jtag_state = IRPAUSE;\r\n}\r\nif (status == 0)\r\nif (js->irstop_state != IRPAUSE)\r\nstatus = altera_goto_jstate(astate, js->irstop_state);\r\nreturn status;\r\n}\r\nint altera_swap_ir(struct altera_state *astate,\r\nu32 count,\r\nu8 *in_data,\r\nu32 in_index,\r\nu8 *out_data,\r\nu32 out_index)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint start_code = 0;\r\nu32 alloc_chars = 0;\r\nu32 shift_count = js->ir_pre + count + js->ir_post;\r\nint status = 0;\r\nenum altera_jtag_state start_state = ILLEGAL_JTAG_STATE;\r\nswitch (js->jtag_state) {\r\ncase ILLEGAL_JTAG_STATE:\r\ncase RESET:\r\ncase IDLE:\r\nstart_code = 0;\r\nstart_state = IDLE;\r\nbreak;\r\ncase DRSELECT:\r\ncase DRCAPTURE:\r\ncase DRSHIFT:\r\ncase DREXIT1:\r\ncase DRPAUSE:\r\ncase DREXIT2:\r\ncase DRUPDATE:\r\nstart_code = 1;\r\nstart_state = DRPAUSE;\r\nbreak;\r\ncase IRSELECT:\r\ncase IRCAPTURE:\r\ncase IRSHIFT:\r\ncase IREXIT1:\r\ncase IRPAUSE:\r\ncase IREXIT2:\r\ncase IRUPDATE:\r\nstart_code = 2;\r\nstart_state = IRPAUSE;\r\nbreak;\r\ndefault:\r\nstatus = -EREMOTEIO;\r\nbreak;\r\n}\r\nif (status == 0)\r\nif (js->jtag_state != start_state)\r\nstatus = altera_goto_jstate(astate, start_state);\r\nif (status == 0) {\r\nif (shift_count > js->ir_length) {\r\nalloc_chars = (shift_count + 7) >> 3;\r\nkfree(js->ir_buffer);\r\njs->ir_buffer = (u8 *)alt_malloc(alloc_chars);\r\nif (js->ir_buffer == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->ir_length = alloc_chars * 8;\r\n}\r\n}\r\nif (status == 0) {\r\naltera_concatenate_data(js->ir_buffer,\r\njs->ir_pre_data,\r\njs->ir_pre,\r\nin_data,\r\nin_index,\r\ncount,\r\njs->ir_post_data,\r\njs->ir_post);\r\nalt_jtag_irscan(astate,\r\nstart_code,\r\nshift_count,\r\njs->ir_buffer,\r\njs->ir_buffer);\r\njs->jtag_state = IRPAUSE;\r\n}\r\nif (status == 0)\r\nif (js->irstop_state != IRPAUSE)\r\nstatus = altera_goto_jstate(astate, js->irstop_state);\r\nif (status == 0)\r\naltera_extract_target_data(js->ir_buffer,\r\nout_data, out_index,\r\njs->ir_pre, count);\r\nreturn status;\r\n}\r\nint altera_drscan(struct altera_state *astate,\r\nu32 count,\r\nu8 *tdi_data,\r\nu32 start_index)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint start_code = 0;\r\nu32 alloc_chars = 0;\r\nu32 shift_count = js->dr_pre + count + js->dr_post;\r\nint status = 0;\r\nenum altera_jtag_state start_state = ILLEGAL_JTAG_STATE;\r\nswitch (js->jtag_state) {\r\ncase ILLEGAL_JTAG_STATE:\r\ncase RESET:\r\ncase IDLE:\r\nstart_code = 0;\r\nstart_state = IDLE;\r\nbreak;\r\ncase DRSELECT:\r\ncase DRCAPTURE:\r\ncase DRSHIFT:\r\ncase DREXIT1:\r\ncase DRPAUSE:\r\ncase DREXIT2:\r\ncase DRUPDATE:\r\nstart_code = 1;\r\nstart_state = DRPAUSE;\r\nbreak;\r\ncase IRSELECT:\r\ncase IRCAPTURE:\r\ncase IRSHIFT:\r\ncase IREXIT1:\r\ncase IRPAUSE:\r\ncase IREXIT2:\r\ncase IRUPDATE:\r\nstart_code = 2;\r\nstart_state = IRPAUSE;\r\nbreak;\r\ndefault:\r\nstatus = -EREMOTEIO;\r\nbreak;\r\n}\r\nif (status == 0)\r\nif (js->jtag_state != start_state)\r\nstatus = altera_goto_jstate(astate, start_state);\r\nif (status == 0) {\r\nif (shift_count > js->dr_length) {\r\nalloc_chars = (shift_count + 7) >> 3;\r\nkfree(js->dr_buffer);\r\njs->dr_buffer = (u8 *)alt_malloc(alloc_chars);\r\nif (js->dr_buffer == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->dr_length = alloc_chars * 8;\r\n}\r\n}\r\nif (status == 0) {\r\naltera_concatenate_data(js->dr_buffer,\r\njs->dr_pre_data,\r\njs->dr_pre,\r\ntdi_data,\r\nstart_index,\r\ncount,\r\njs->dr_post_data,\r\njs->dr_post);\r\nalt_jtag_drscan(astate, start_code, shift_count,\r\njs->dr_buffer, NULL);\r\njs->jtag_state = DRPAUSE;\r\n}\r\nif (status == 0)\r\nif (js->drstop_state != DRPAUSE)\r\nstatus = altera_goto_jstate(astate, js->drstop_state);\r\nreturn status;\r\n}\r\nint altera_swap_dr(struct altera_state *astate, u32 count,\r\nu8 *in_data, u32 in_index,\r\nu8 *out_data, u32 out_index)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nint start_code = 0;\r\nu32 alloc_chars = 0;\r\nu32 shift_count = js->dr_pre + count + js->dr_post;\r\nint status = 0;\r\nenum altera_jtag_state start_state = ILLEGAL_JTAG_STATE;\r\nswitch (js->jtag_state) {\r\ncase ILLEGAL_JTAG_STATE:\r\ncase RESET:\r\ncase IDLE:\r\nstart_code = 0;\r\nstart_state = IDLE;\r\nbreak;\r\ncase DRSELECT:\r\ncase DRCAPTURE:\r\ncase DRSHIFT:\r\ncase DREXIT1:\r\ncase DRPAUSE:\r\ncase DREXIT2:\r\ncase DRUPDATE:\r\nstart_code = 1;\r\nstart_state = DRPAUSE;\r\nbreak;\r\ncase IRSELECT:\r\ncase IRCAPTURE:\r\ncase IRSHIFT:\r\ncase IREXIT1:\r\ncase IRPAUSE:\r\ncase IREXIT2:\r\ncase IRUPDATE:\r\nstart_code = 2;\r\nstart_state = IRPAUSE;\r\nbreak;\r\ndefault:\r\nstatus = -EREMOTEIO;\r\nbreak;\r\n}\r\nif (status == 0)\r\nif (js->jtag_state != start_state)\r\nstatus = altera_goto_jstate(astate, start_state);\r\nif (status == 0) {\r\nif (shift_count > js->dr_length) {\r\nalloc_chars = (shift_count + 7) >> 3;\r\nkfree(js->dr_buffer);\r\njs->dr_buffer = (u8 *)alt_malloc(alloc_chars);\r\nif (js->dr_buffer == NULL)\r\nstatus = -ENOMEM;\r\nelse\r\njs->dr_length = alloc_chars * 8;\r\n}\r\n}\r\nif (status == 0) {\r\naltera_concatenate_data(js->dr_buffer,\r\njs->dr_pre_data,\r\njs->dr_pre,\r\nin_data,\r\nin_index,\r\ncount,\r\njs->dr_post_data,\r\njs->dr_post);\r\nalt_jtag_drscan(astate,\r\nstart_code,\r\nshift_count,\r\njs->dr_buffer,\r\njs->dr_buffer);\r\njs->jtag_state = DRPAUSE;\r\n}\r\nif (status == 0)\r\nif (js->drstop_state != DRPAUSE)\r\nstatus = altera_goto_jstate(astate, js->drstop_state);\r\nif (status == 0)\r\naltera_extract_target_data(js->dr_buffer,\r\nout_data,\r\nout_index,\r\njs->dr_pre,\r\ncount);\r\nreturn status;\r\n}\r\nvoid altera_free_buffers(struct altera_state *astate)\r\n{\r\nstruct altera_jtag *js = &astate->js;\r\nif (js->jtag_state != ILLEGAL_JTAG_STATE)\r\naltera_jreset_idle(astate);\r\nkfree(js->dr_pre_data);\r\njs->dr_pre_data = NULL;\r\nkfree(js->dr_post_data);\r\njs->dr_post_data = NULL;\r\nkfree(js->dr_buffer);\r\njs->dr_buffer = NULL;\r\nkfree(js->ir_pre_data);\r\njs->ir_pre_data = NULL;\r\nkfree(js->ir_post_data);\r\njs->ir_post_data = NULL;\r\nkfree(js->ir_buffer);\r\njs->ir_buffer = NULL;\r\n}

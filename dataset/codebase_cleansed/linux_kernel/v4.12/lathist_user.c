static void stars(char *str, long val, long max, int width)\r\n{\r\nint i;\r\nfor (i = 0; i < (width * val / max) - 1 && i < width - 1; i++)\r\nstr[i] = '*';\r\nif (val > max)\r\nstr[i - 1] = '+';\r\nstr[i] = '\0';\r\n}\r\nstatic void print_hist(void)\r\n{\r\nchar starstr[MAX_STARS];\r\nstruct cpu_hist *hist;\r\nint i, j;\r\nprintf("\033[2J");\r\nfor (j = 0; j < MAX_CPU; j++) {\r\nhist = &cpu_hist[j];\r\nif (hist->max == 0)\r\ncontinue;\r\nprintf("CPU %d\n", j);\r\nprintf(" latency : count distribution\n");\r\nfor (i = 1; i <= MAX_ENTRIES; i++) {\r\nstars(starstr, hist->data[i - 1], hist->max, MAX_STARS);\r\nprintf("%8ld -> %-8ld : %-8ld |%-*s|\n",\r\n(1l << i) >> 1, (1l << i) - 1,\r\nhist->data[i - 1], MAX_STARS, starstr);\r\n}\r\n}\r\n}\r\nstatic void get_data(int fd)\r\n{\r\nlong key, value;\r\nint c, i;\r\nfor (i = 0; i < MAX_CPU; i++)\r\ncpu_hist[i].max = 0;\r\nfor (c = 0; c < MAX_CPU; c++) {\r\nfor (i = 0; i < MAX_ENTRIES; i++) {\r\nkey = c * MAX_ENTRIES + i;\r\nbpf_map_lookup_elem(fd, &key, &value);\r\ncpu_hist[c].data[i] = value;\r\nif (value > cpu_hist[c].max)\r\ncpu_hist[c].max = value;\r\n}\r\n}\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nchar filename[256];\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nwhile (1) {\r\nget_data(map_fd[1]);\r\nprint_hist();\r\nsleep(5);\r\n}\r\nreturn 0;\r\n}

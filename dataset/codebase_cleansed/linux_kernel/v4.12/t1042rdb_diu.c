static void t1042rdb_set_monitor_port(enum fsl_diu_monitor_port port)\r\n{\r\nstatic void __iomem *cpld_base;\r\ncpld_base = of_iomap(cpld_node, 0);\r\nif (!cpld_base) {\r\npr_err("%s: Could not map cpld registers\n", __func__);\r\ngoto exit;\r\n}\r\nswitch (port) {\r\ncase FSL_DIU_PORT_DVI:\r\nclrbits8(cpld_base + CPLD_DIUCSR, CPLD_DIUCSR_DVIEN);\r\nbreak;\r\ncase FSL_DIU_PORT_LVDS:\r\nsetbits8(cpld_base + CPLD_DIUCSR, 0x01 << 8);\r\nsetbits8(cpld_base + CPLD_DIUCSR, 0x01 << 4);\r\nsetbits8(cpld_base + CPLD_DIUCSR, CPLD_DIUCSR_BACKLIGHT);\r\nbreak;\r\ndefault:\r\npr_err("%s: Unsupported monitor port %i\n", __func__, port);\r\n}\r\niounmap(cpld_base);\r\nexit:\r\nof_node_put(cpld_node);\r\n}\r\nstatic void t1042rdb_set_pixel_clock(unsigned int pixclock)\r\n{\r\nstruct device_node *scfg_np;\r\nvoid __iomem *scfg;\r\nunsigned long freq;\r\nu64 temp;\r\nu32 pxclk;\r\nscfg_np = of_find_compatible_node(NULL, NULL, "fsl,t1040-scfg");\r\nif (!scfg_np) {\r\npr_err("%s: Missing scfg node. Can not display video.\n",\r\n__func__);\r\nreturn;\r\n}\r\nscfg = of_iomap(scfg_np, 0);\r\nof_node_put(scfg_np);\r\nif (!scfg) {\r\npr_err("%s: Could not map device. Can not display video.\n",\r\n__func__);\r\nreturn;\r\n}\r\ntemp = 1000000000000ULL;\r\ndo_div(temp, pixclock);\r\nfreq = temp;\r\npxclk = DIV_ROUND_CLOSEST(fsl_get_sys_freq(), freq);\r\npxclk = clamp_t(u32, pxclk, 2, 255);\r\nclrbits32(scfg + CCSR_SCFG_PIXCLKCR,\r\nPIXCLKCR_PXCKEN | PIXCLKCR_PXCKDLY | PIXCLKCR_PXCLK_MASK);\r\nsetbits32(scfg + CCSR_SCFG_PIXCLKCR, PIXCLKCR_PXCKEN | (pxclk << 16));\r\niounmap(scfg);\r\n}\r\nstatic enum fsl_diu_monitor_port\r\nt1042rdb_valid_monitor_port(enum fsl_diu_monitor_port port)\r\n{\r\nswitch (port) {\r\ncase FSL_DIU_PORT_DVI:\r\ncase FSL_DIU_PORT_LVDS:\r\nreturn port;\r\ndefault:\r\nreturn FSL_DIU_PORT_DVI;\r\n}\r\n}\r\nstatic int __init t1042rdb_diu_init(void)\r\n{\r\ncpld_node = of_find_compatible_node(NULL, NULL, "fsl,t1042rdb-cpld");\r\nif (!cpld_node)\r\nreturn 0;\r\ndiu_ops.set_monitor_port = t1042rdb_set_monitor_port;\r\ndiu_ops.set_pixel_clock = t1042rdb_set_pixel_clock;\r\ndiu_ops.valid_monitor_port = t1042rdb_valid_monitor_port;\r\nreturn 0;\r\n}

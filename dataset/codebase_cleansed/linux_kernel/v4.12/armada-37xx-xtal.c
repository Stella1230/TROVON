static int armada_3700_xtal_clock_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst char *xtal_name = "xtal";\r\nstruct device_node *parent;\r\nstruct regmap *regmap;\r\nstruct clk_hw *xtal_hw;\r\nunsigned int rate;\r\nu32 reg;\r\nint ret;\r\nxtal_hw = devm_kzalloc(&pdev->dev, sizeof(*xtal_hw), GFP_KERNEL);\r\nif (!xtal_hw)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, xtal_hw);\r\nparent = np->parent;\r\nif (!parent) {\r\ndev_err(&pdev->dev, "no parent\n");\r\nreturn -ENODEV;\r\n}\r\nregmap = syscon_node_to_regmap(parent);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&pdev->dev, "cannot get regmap\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nret = regmap_read(regmap, NB_GPIO1_LATCH, &reg);\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot read from regmap\n");\r\nreturn ret;\r\n}\r\nif (reg & XTAL_MODE)\r\nrate = 40000000;\r\nelse\r\nrate = 25000000;\r\nof_property_read_string_index(np, "clock-output-names", 0, &xtal_name);\r\nxtal_hw = clk_hw_register_fixed_rate(NULL, xtal_name, NULL, 0, rate);\r\nif (IS_ERR(xtal_hw))\r\nreturn PTR_ERR(xtal_hw);\r\nret = of_clk_add_hw_provider(np, of_clk_hw_simple_get, xtal_hw);\r\nreturn ret;\r\n}\r\nstatic int armada_3700_xtal_clock_remove(struct platform_device *pdev)\r\n{\r\nof_clk_del_provider(pdev->dev.of_node);\r\nreturn 0;\r\n}

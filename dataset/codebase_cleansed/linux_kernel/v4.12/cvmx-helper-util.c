const char *cvmx_helper_interface_mode_to_string(cvmx_helper_interface_mode_t\r\nmode)\r\n{\r\nswitch (mode) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\nreturn "DISABLED";\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\nreturn "RGMII";\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\nreturn "GMII";\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\nreturn "SPI";\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\nreturn "PCIE";\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nreturn "XAUI";\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\nreturn "SGMII";\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\nreturn "PICMG";\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\nreturn "NPI";\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\nreturn "LOOP";\r\n}\r\nreturn "UNKNOWN";\r\n}\r\nint cvmx_helper_dump_packet(cvmx_wqe_t *work)\r\n{\r\nuint64_t count;\r\nuint64_t remaining_bytes;\r\nunion cvmx_buf_ptr buffer_ptr;\r\nuint64_t start_of_buffer;\r\nuint8_t *data_address;\r\nuint8_t *end_of_data;\r\ncvmx_dprintf("Packet Length: %u\n", work->word1.len);\r\ncvmx_dprintf(" Input Port: %u\n", cvmx_wqe_get_port(work));\r\ncvmx_dprintf(" QoS: %u\n", cvmx_wqe_get_qos(work));\r\ncvmx_dprintf(" Buffers: %u\n", work->word2.s.bufs);\r\nif (work->word2.s.bufs == 0) {\r\nunion cvmx_ipd_wqe_fpa_queue wqe_pool;\r\nwqe_pool.u64 = cvmx_read_csr(CVMX_IPD_WQE_FPA_QUEUE);\r\nbuffer_ptr.u64 = 0;\r\nbuffer_ptr.s.pool = wqe_pool.s.wqe_pool;\r\nbuffer_ptr.s.size = 128;\r\nbuffer_ptr.s.addr = cvmx_ptr_to_phys(work->packet_data);\r\nif (likely(!work->word2.s.not_IP)) {\r\nunion cvmx_pip_ip_offset pip_ip_offset;\r\npip_ip_offset.u64 = cvmx_read_csr(CVMX_PIP_IP_OFFSET);\r\nbuffer_ptr.s.addr +=\r\n(pip_ip_offset.s.offset << 3) -\r\nwork->word2.s.ip_offset;\r\nbuffer_ptr.s.addr += (work->word2.s.is_v6 ^ 1) << 2;\r\n} else {\r\nunion cvmx_pip_gbl_cfg pip_gbl_cfg;\r\npip_gbl_cfg.u64 = cvmx_read_csr(CVMX_PIP_GBL_CFG);\r\nbuffer_ptr.s.addr += pip_gbl_cfg.s.nip_shf;\r\n}\r\n} else\r\nbuffer_ptr = work->packet_ptr;\r\nremaining_bytes = work->word1.len;\r\nwhile (remaining_bytes) {\r\nstart_of_buffer =\r\n((buffer_ptr.s.addr >> 7) - buffer_ptr.s.back) << 7;\r\ncvmx_dprintf(" Buffer Start:%llx\n",\r\n(unsigned long long)start_of_buffer);\r\ncvmx_dprintf(" Buffer I : %u\n", buffer_ptr.s.i);\r\ncvmx_dprintf(" Buffer Back: %u\n", buffer_ptr.s.back);\r\ncvmx_dprintf(" Buffer Pool: %u\n", buffer_ptr.s.pool);\r\ncvmx_dprintf(" Buffer Data: %llx\n",\r\n(unsigned long long)buffer_ptr.s.addr);\r\ncvmx_dprintf(" Buffer Size: %u\n", buffer_ptr.s.size);\r\ncvmx_dprintf("\t\t");\r\ndata_address = (uint8_t *) cvmx_phys_to_ptr(buffer_ptr.s.addr);\r\nend_of_data = data_address + buffer_ptr.s.size;\r\ncount = 0;\r\nwhile (data_address < end_of_data) {\r\nif (remaining_bytes == 0)\r\nbreak;\r\nelse\r\nremaining_bytes--;\r\ncvmx_dprintf("%02x", (unsigned int)*data_address);\r\ndata_address++;\r\nif (remaining_bytes && (count == 7)) {\r\ncvmx_dprintf("\n\t\t");\r\ncount = 0;\r\n} else\r\ncount++;\r\n}\r\ncvmx_dprintf("\n");\r\nif (remaining_bytes)\r\nbuffer_ptr = *(union cvmx_buf_ptr *)\r\ncvmx_phys_to_ptr(buffer_ptr.s.addr - 8);\r\n}\r\nreturn 0;\r\n}\r\nint cvmx_helper_setup_red_queue(int queue, int pass_thresh, int drop_thresh)\r\n{\r\nunion cvmx_ipd_qosx_red_marks red_marks;\r\nunion cvmx_ipd_red_quex_param red_param;\r\nred_marks.u64 = 0;\r\nred_marks.s.drop = drop_thresh;\r\nred_marks.s.pass = pass_thresh;\r\ncvmx_write_csr(CVMX_IPD_QOSX_RED_MARKS(queue), red_marks.u64);\r\nred_param.u64 = 0;\r\nred_param.s.prb_con =\r\n(255ul << 24) / (red_marks.s.pass - red_marks.s.drop);\r\nred_param.s.avg_con = 1;\r\nred_param.s.new_con = 255;\r\nred_param.s.use_pcnt = 1;\r\ncvmx_write_csr(CVMX_IPD_RED_QUEX_PARAM(queue), red_param.u64);\r\nreturn 0;\r\n}\r\nint cvmx_helper_setup_red(int pass_thresh, int drop_thresh)\r\n{\r\nunion cvmx_ipd_portx_bp_page_cnt page_cnt;\r\nunion cvmx_ipd_bp_prt_red_end ipd_bp_prt_red_end;\r\nunion cvmx_ipd_red_port_enable red_port_enable;\r\nint queue;\r\nint interface;\r\nint port;\r\npage_cnt.u64 = 0;\r\npage_cnt.s.bp_enb = 0;\r\npage_cnt.s.page_cnt = 100;\r\nfor (interface = 0; interface < 2; interface++) {\r\nfor (port = cvmx_helper_get_first_ipd_port(interface);\r\nport < cvmx_helper_get_last_ipd_port(interface); port++)\r\ncvmx_write_csr(CVMX_IPD_PORTX_BP_PAGE_CNT(port),\r\npage_cnt.u64);\r\n}\r\nfor (queue = 0; queue < 8; queue++)\r\ncvmx_helper_setup_red_queue(queue, pass_thresh, drop_thresh);\r\nipd_bp_prt_red_end.u64 = 0;\r\nipd_bp_prt_red_end.s.prt_enb = 0;\r\ncvmx_write_csr(CVMX_IPD_BP_PRT_RED_END, ipd_bp_prt_red_end.u64);\r\nred_port_enable.u64 = 0;\r\nred_port_enable.s.prt_enb = 0xfffffffffull;\r\nred_port_enable.s.avg_dly = 10000;\r\nred_port_enable.s.prb_dly = 10000;\r\ncvmx_write_csr(CVMX_IPD_RED_PORT_ENABLE, red_port_enable.u64);\r\nreturn 0;\r\n}\r\nint __cvmx_helper_setup_gmx(int interface, int num_ports)\r\n{\r\nunion cvmx_gmxx_tx_prts gmx_tx_prts;\r\nunion cvmx_gmxx_rx_prts gmx_rx_prts;\r\nunion cvmx_pko_reg_gmx_port_mode pko_mode;\r\nunion cvmx_gmxx_txx_thresh gmx_tx_thresh;\r\nint index;\r\ngmx_tx_prts.u64 = cvmx_read_csr(CVMX_GMXX_TX_PRTS(interface));\r\ngmx_tx_prts.s.prts = num_ports;\r\ncvmx_write_csr(CVMX_GMXX_TX_PRTS(interface), gmx_tx_prts.u64);\r\nif (cvmx_helper_interface_get_mode(interface) ==\r\nCVMX_HELPER_INTERFACE_MODE_RGMII\r\n|| cvmx_helper_interface_get_mode(interface) ==\r\nCVMX_HELPER_INTERFACE_MODE_SGMII\r\n|| cvmx_helper_interface_get_mode(interface) ==\r\nCVMX_HELPER_INTERFACE_MODE_GMII\r\n|| cvmx_helper_interface_get_mode(interface) ==\r\nCVMX_HELPER_INTERFACE_MODE_XAUI) {\r\nif (num_ports > 4) {\r\ncvmx_dprintf("__cvmx_helper_setup_gmx: Illegal "\r\n"num_ports\n");\r\nreturn -1;\r\n}\r\ngmx_rx_prts.u64 = cvmx_read_csr(CVMX_GMXX_RX_PRTS(interface));\r\ngmx_rx_prts.s.prts = num_ports;\r\ncvmx_write_csr(CVMX_GMXX_RX_PRTS(interface), gmx_rx_prts.u64);\r\n}\r\nif (!OCTEON_IS_MODEL(OCTEON_CN30XX) && !OCTEON_IS_MODEL(OCTEON_CN31XX)\r\n&& !OCTEON_IS_MODEL(OCTEON_CN50XX)) {\r\npko_mode.u64 = cvmx_read_csr(CVMX_PKO_REG_GMX_PORT_MODE);\r\nif (interface == 0) {\r\nif (num_ports == 1)\r\npko_mode.s.mode0 = 4;\r\nelse if (num_ports == 2)\r\npko_mode.s.mode0 = 3;\r\nelse if (num_ports <= 4)\r\npko_mode.s.mode0 = 2;\r\nelse if (num_ports <= 8)\r\npko_mode.s.mode0 = 1;\r\nelse\r\npko_mode.s.mode0 = 0;\r\n} else {\r\nif (num_ports == 1)\r\npko_mode.s.mode1 = 4;\r\nelse if (num_ports == 2)\r\npko_mode.s.mode1 = 3;\r\nelse if (num_ports <= 4)\r\npko_mode.s.mode1 = 2;\r\nelse if (num_ports <= 8)\r\npko_mode.s.mode1 = 1;\r\nelse\r\npko_mode.s.mode1 = 0;\r\n}\r\ncvmx_write_csr(CVMX_PKO_REG_GMX_PORT_MODE, pko_mode.u64);\r\n}\r\ngmx_tx_thresh.u64 = cvmx_read_csr(CVMX_GMXX_TXX_THRESH(0, interface));\r\nif (OCTEON_IS_MODEL(OCTEON_CN30XX) || OCTEON_IS_MODEL(OCTEON_CN31XX)\r\n|| OCTEON_IS_MODEL(OCTEON_CN50XX)) {\r\ngmx_tx_thresh.s.cnt = 0x40;\r\n} else {\r\nif (num_ports <= 1)\r\ngmx_tx_thresh.s.cnt = 0x100 / 1;\r\nelse if (num_ports == 2)\r\ngmx_tx_thresh.s.cnt = 0x100 / 2;\r\nelse\r\ngmx_tx_thresh.s.cnt = 0x100 / 4;\r\n}\r\nif (num_ports > 4)\r\nnum_ports = 4;\r\nfor (index = 0; index < num_ports; index++)\r\ncvmx_write_csr(CVMX_GMXX_TXX_THRESH(index, interface),\r\ngmx_tx_thresh.u64);\r\nreturn 0;\r\n}\r\nint cvmx_helper_get_ipd_port(int interface, int port)\r\n{\r\nswitch (interface) {\r\ncase 0:\r\nreturn port;\r\ncase 1:\r\nreturn port + 16;\r\ncase 2:\r\nreturn port + 32;\r\ncase 3:\r\nreturn port + 36;\r\ncase 4:\r\nreturn port + 40;\r\ncase 5:\r\nreturn port + 44;\r\n}\r\nreturn -1;\r\n}\r\nint cvmx_helper_get_interface_num(int ipd_port)\r\n{\r\nif (ipd_port < 16)\r\nreturn 0;\r\nelse if (ipd_port < 32)\r\nreturn 1;\r\nelse if (ipd_port < 36)\r\nreturn 2;\r\nelse if (ipd_port < 40)\r\nreturn 3;\r\nelse if (ipd_port < 44)\r\nreturn 4;\r\nelse if (ipd_port < 48)\r\nreturn 5;\r\nelse\r\ncvmx_dprintf("cvmx_helper_get_interface_num: Illegal IPD "\r\n"port number\n");\r\nreturn -1;\r\n}\r\nint cvmx_helper_get_interface_index_num(int ipd_port)\r\n{\r\nif (ipd_port < 32)\r\nreturn ipd_port & 15;\r\nelse if (ipd_port < 36)\r\nreturn ipd_port & 3;\r\nelse if (ipd_port < 40)\r\nreturn ipd_port & 3;\r\nelse if (ipd_port < 44)\r\nreturn ipd_port & 3;\r\nelse if (ipd_port < 48)\r\nreturn ipd_port & 3;\r\nelse\r\ncvmx_dprintf("cvmx_helper_get_interface_index_num: "\r\n"Illegal IPD port number\n");\r\nreturn -1;\r\n}

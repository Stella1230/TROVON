static int comp_threshold_set(struct tps65910 *tps65910, int id, int voltage)\r\n{\r\nstruct comparator tps_comp = tps_comparators[id];\r\nint curr_voltage = 0;\r\nint ret;\r\nu8 index = 0, val;\r\nif (id == COMP)\r\nreturn 0;\r\nwhile (curr_voltage < tps_comp.uV_max) {\r\ncurr_voltage = tps_comp.vsel_table[index];\r\nif (curr_voltage >= voltage)\r\nbreak;\r\nelse if (curr_voltage < voltage)\r\nindex ++;\r\n}\r\nif (curr_voltage > tps_comp.uV_max)\r\nreturn -EINVAL;\r\nval = index << 1;\r\nret = tps65910->write(tps65910, tps_comp.reg, 1, &val);\r\nreturn ret;\r\n}\r\nstatic int comp_threshold_get(struct tps65910 *tps65910, int id)\r\n{\r\nstruct comparator tps_comp = tps_comparators[id];\r\nint ret;\r\nu8 val;\r\nif (id == COMP)\r\nreturn 0;\r\nret = tps65910->read(tps65910, tps_comp.reg, 1, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval >>= 1;\r\nreturn tps_comp.vsel_table[val];\r\n}\r\nstatic ssize_t comp_threshold_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct tps65910 *tps65910 = dev_get_drvdata(dev->parent);\r\nstruct attribute comp_attr = attr->attr;\r\nint id, uVolt;\r\nif (!strcmp(comp_attr.name, "comp1_threshold"))\r\nid = COMP1;\r\nelse if (!strcmp(comp_attr.name, "comp2_threshold"))\r\nid = COMP2;\r\nelse\r\nreturn -EINVAL;\r\nuVolt = comp_threshold_get(tps65910, id);\r\nreturn sprintf(buf, "%d\n", uVolt);\r\n}\r\nstatic int tps65911_comparator_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65910 *tps65910 = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65910_board *pdata = dev_get_platdata(tps65910->dev);\r\nint ret;\r\nret = comp_threshold_set(tps65910, COMP1, pdata->vmbch_threshold);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "cannot set COMP1 threshold\n");\r\nreturn ret;\r\n}\r\nret = comp_threshold_set(tps65910, COMP2, pdata->vmbch2_threshold);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "cannot set COMP2 threshold\n");\r\nreturn ret;\r\n}\r\nret = device_create_file(&pdev->dev, &dev_attr_comp1_threshold);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "failed to add COMP1 sysfs file\n");\r\nret = device_create_file(&pdev->dev, &dev_attr_comp2_threshold);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "failed to add COMP2 sysfs file\n");\r\nreturn ret;\r\n}\r\nstatic int tps65911_comparator_remove(struct platform_device *pdev)\r\n{\r\nstruct tps65910 *tps65910;\r\ntps65910 = dev_get_drvdata(pdev->dev.parent);\r\ndevice_remove_file(&pdev->dev, &dev_attr_comp2_threshold);\r\ndevice_remove_file(&pdev->dev, &dev_attr_comp1_threshold);\r\nreturn 0;\r\n}\r\nstatic int __init tps65911_comparator_init(void)\r\n{\r\nreturn platform_driver_register(&tps65911_comparator_driver);\r\n}\r\nstatic void __exit tps65911_comparator_exit(void)\r\n{\r\nplatform_driver_unregister(&tps65911_comparator_driver);\r\n}

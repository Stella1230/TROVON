static int __init storcenter_device_probe(void)\r\n{\r\nof_platform_bus_probe(NULL, storcenter_of_bus, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init storcenter_add_bridge(struct device_node *dev)\r\n{\r\n#ifdef CONFIG_PCI\r\nint len;\r\nstruct pci_controller *hose;\r\nconst int *bus_range;\r\nprintk("Adding PCI host bridge %s\n", dev->full_name);\r\nhose = pcibios_alloc_controller(dev);\r\nif (hose == NULL)\r\nreturn -ENOMEM;\r\nbus_range = of_get_property(dev, "bus-range", &len);\r\nhose->first_busno = bus_range ? bus_range[0] : 0;\r\nhose->last_busno = bus_range ? bus_range[1] : 0xff;\r\nsetup_indirect_pci(hose, MPC10X_MAPB_CNFG_ADDR, MPC10X_MAPB_CNFG_DATA, 0);\r\npci_process_bridge_OF_ranges(hose, dev, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __init storcenter_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_compatible_node(np, "pci", "mpc10x-pci")\r\nstorcenter_add_bridge(np);\r\nprintk(KERN_INFO "IOMEGA StorCenter\n");\r\n}\r\nstatic void __init storcenter_init_IRQ(void)\r\n{\r\nstruct mpic *mpic;\r\nmpic = mpic_alloc(NULL, 0, 0, 16, 0, " OpenPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_assign_isu(mpic, 0, mpic->paddr + 0x10200);\r\nmpic_assign_isu(mpic, 1, mpic->paddr + 0x11000);\r\nmpic_init(mpic);\r\n}\r\nstatic void __noreturn storcenter_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\n_nmask_and_or_msr(0, MSR_IP);\r\nfor (;;) ;\r\n}\r\nstatic int __init storcenter_probe(void)\r\n{\r\nreturn of_machine_is_compatible("iomega,storcenter");\r\n}

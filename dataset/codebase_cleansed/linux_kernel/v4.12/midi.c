void line6_midi_receive(struct usb_line6 *line6, unsigned char *data,\r\nint length)\r\n{\r\nif (line6->line6midi->substream_receive)\r\nsnd_rawmidi_receive(line6->line6midi->substream_receive,\r\ndata, length);\r\n}\r\nstatic void line6_midi_transmit(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct usb_line6 *line6 =\r\nline6_rawmidi_substream_midi(substream)->line6;\r\nstruct snd_line6_midi *line6midi = line6->line6midi;\r\nstruct midi_buffer *mb = &line6midi->midibuf_out;\r\nunsigned char chunk[LINE6_FALLBACK_MAXPACKETSIZE];\r\nint req, done;\r\nfor (;;) {\r\nreq = min(line6_midibuf_bytes_free(mb), line6->max_packet_size);\r\ndone = snd_rawmidi_transmit_peek(substream, chunk, req);\r\nif (done == 0)\r\nbreak;\r\nline6_midibuf_write(mb, chunk, done);\r\nsnd_rawmidi_transmit_ack(substream, done);\r\n}\r\nfor (;;) {\r\ndone = line6_midibuf_read(mb, chunk,\r\nLINE6_FALLBACK_MAXPACKETSIZE);\r\nif (done == 0)\r\nbreak;\r\nsend_midi_async(line6, chunk, done);\r\n}\r\n}\r\nstatic void midi_sent(struct urb *urb)\r\n{\r\nunsigned long flags;\r\nint status;\r\nint num;\r\nstruct usb_line6 *line6 = (struct usb_line6 *)urb->context;\r\nstatus = urb->status;\r\nkfree(urb->transfer_buffer);\r\nusb_free_urb(urb);\r\nif (status == -ESHUTDOWN)\r\nreturn;\r\nspin_lock_irqsave(&line6->line6midi->lock, flags);\r\nnum = --line6->line6midi->num_active_send_urbs;\r\nif (num == 0) {\r\nline6_midi_transmit(line6->line6midi->substream_transmit);\r\nnum = line6->line6midi->num_active_send_urbs;\r\n}\r\nif (num == 0)\r\nwake_up(&line6->line6midi->send_wait);\r\nspin_unlock_irqrestore(&line6->line6midi->lock, flags);\r\n}\r\nstatic int send_midi_async(struct usb_line6 *line6, unsigned char *data,\r\nint length)\r\n{\r\nstruct urb *urb;\r\nint retval;\r\nunsigned char *transfer_buffer;\r\nurb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (urb == NULL)\r\nreturn -ENOMEM;\r\ntransfer_buffer = kmemdup(data, length, GFP_ATOMIC);\r\nif (transfer_buffer == NULL) {\r\nusb_free_urb(urb);\r\nreturn -ENOMEM;\r\n}\r\nusb_fill_int_urb(urb, line6->usbdev,\r\nusb_sndbulkpipe(line6->usbdev,\r\nline6->properties->ep_ctrl_w),\r\ntransfer_buffer, length, midi_sent, line6,\r\nline6->interval);\r\nurb->actual_length = 0;\r\nretval = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (retval < 0) {\r\ndev_err(line6->ifcdev, "usb_submit_urb failed\n");\r\nusb_free_urb(urb);\r\nreturn retval;\r\n}\r\n++line6->line6midi->num_active_send_urbs;\r\nreturn 0;\r\n}\r\nstatic int line6_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int line6_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic void line6_midi_output_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nunsigned long flags;\r\nstruct usb_line6 *line6 =\r\nline6_rawmidi_substream_midi(substream)->line6;\r\nline6->line6midi->substream_transmit = substream;\r\nspin_lock_irqsave(&line6->line6midi->lock, flags);\r\nif (line6->line6midi->num_active_send_urbs == 0)\r\nline6_midi_transmit(substream);\r\nspin_unlock_irqrestore(&line6->line6midi->lock, flags);\r\n}\r\nstatic void line6_midi_output_drain(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct usb_line6 *line6 =\r\nline6_rawmidi_substream_midi(substream)->line6;\r\nstruct snd_line6_midi *midi = line6->line6midi;\r\nwait_event_interruptible(midi->send_wait,\r\nmidi->num_active_send_urbs == 0);\r\n}\r\nstatic int line6_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int line6_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic void line6_midi_input_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct usb_line6 *line6 =\r\nline6_rawmidi_substream_midi(substream)->line6;\r\nif (up)\r\nline6->line6midi->substream_receive = substream;\r\nelse\r\nline6->line6midi->substream_receive = NULL;\r\n}\r\nstatic int snd_line6_new_midi(struct usb_line6 *line6,\r\nstruct snd_rawmidi **rmidi_ret)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nerr = snd_rawmidi_new(line6->card, "Line 6 MIDI", 0, 1, 1, rmidi_ret);\r\nif (err < 0)\r\nreturn err;\r\nrmidi = *rmidi_ret;\r\nstrcpy(rmidi->id, line6->properties->id);\r\nstrcpy(rmidi->name, line6->properties->name);\r\nrmidi->info_flags =\r\nSNDRV_RAWMIDI_INFO_OUTPUT |\r\nSNDRV_RAWMIDI_INFO_INPUT | SNDRV_RAWMIDI_INFO_DUPLEX;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&line6_midi_output_ops);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&line6_midi_input_ops);\r\nreturn 0;\r\n}\r\nstatic void snd_line6_midi_free(struct snd_rawmidi *rmidi)\r\n{\r\nstruct snd_line6_midi *line6midi = rmidi->private_data;\r\nline6_midibuf_destroy(&line6midi->midibuf_in);\r\nline6_midibuf_destroy(&line6midi->midibuf_out);\r\nkfree(line6midi);\r\n}\r\nint line6_init_midi(struct usb_line6 *line6)\r\n{\r\nint err;\r\nstruct snd_rawmidi *rmidi;\r\nstruct snd_line6_midi *line6midi;\r\nif (!(line6->properties->capabilities & LINE6_CAP_CONTROL_MIDI)) {\r\nreturn 0;\r\n}\r\nerr = snd_line6_new_midi(line6, &rmidi);\r\nif (err < 0)\r\nreturn err;\r\nline6midi = kzalloc(sizeof(struct snd_line6_midi), GFP_KERNEL);\r\nif (!line6midi)\r\nreturn -ENOMEM;\r\nrmidi->private_data = line6midi;\r\nrmidi->private_free = snd_line6_midi_free;\r\ninit_waitqueue_head(&line6midi->send_wait);\r\nspin_lock_init(&line6midi->lock);\r\nline6midi->line6 = line6;\r\nerr = line6_midibuf_init(&line6midi->midibuf_in, MIDI_BUFFER_SIZE, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_midibuf_init(&line6midi->midibuf_out, MIDI_BUFFER_SIZE, 1);\r\nif (err < 0)\r\nreturn err;\r\nline6->line6midi = line6midi;\r\nreturn 0;\r\n}

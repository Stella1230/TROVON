static void __init berlin2q_clock_setup(struct device_node *np)\r\n{\r\nstruct device_node *parent_np = of_get_parent(np);\r\nconst char *parent_names[9];\r\nstruct clk *clk;\r\nstruct clk_hw **hws;\r\nint n, ret;\r\nclk_data = kzalloc(sizeof(*clk_data) +\r\nsizeof(*clk_data->hws) * MAX_CLKS, GFP_KERNEL);\r\nif (!clk_data)\r\nreturn;\r\nclk_data->num = MAX_CLKS;\r\nhws = clk_data->hws;\r\ngbase = of_iomap(parent_np, 0);\r\nif (!gbase) {\r\npr_err("%s: Unable to map global base\n", np->full_name);\r\nreturn;\r\n}\r\ncpupll_base = of_iomap(parent_np, 1);\r\nif (!cpupll_base) {\r\npr_err("%s: Unable to map cpupll base\n", np->full_name);\r\niounmap(gbase);\r\nreturn;\r\n}\r\nclk = of_clk_get_by_name(np, clk_names[REFCLK]);\r\nif (!IS_ERR(clk)) {\r\nclk_names[REFCLK] = __clk_get_name(clk);\r\nclk_put(clk);\r\n}\r\nret = berlin2_pll_register(&bg2q_pll_map, gbase + REG_SYSPLLCTL0,\r\nclk_names[SYSPLL], clk_names[REFCLK], 0);\r\nif (ret)\r\ngoto bg2q_fail;\r\nret = berlin2_pll_register(&bg2q_pll_map, cpupll_base,\r\nclk_names[CPUPLL], clk_names[REFCLK], 0);\r\nif (ret)\r\ngoto bg2q_fail;\r\nfor (n = 0; n < ARRAY_SIZE(bg2q_divs); n++) {\r\nconst struct berlin2_div_data *dd = &bg2q_divs[n];\r\nint k;\r\nfor (k = 0; k < dd->num_parents; k++)\r\nparent_names[k] = clk_names[dd->parent_ids[k]];\r\nhws[CLKID_SYS + n] = berlin2_div_register(&dd->map, gbase,\r\ndd->name, dd->div_flags, parent_names,\r\ndd->num_parents, dd->flags, &lock);\r\n}\r\nfor (n = 0; n < ARRAY_SIZE(bg2q_gates); n++) {\r\nconst struct berlin2_gate_data *gd = &bg2q_gates[n];\r\nhws[CLKID_GFX2DAXI + n] = clk_hw_register_gate(NULL, gd->name,\r\ngd->parent_name, gd->flags, gbase + REG_CLKENABLE,\r\ngd->bit_idx, 0, &lock);\r\n}\r\nhws[CLKID_CPU] =\r\nclk_hw_register_fixed_factor(NULL, "cpu", clk_names[CPUPLL],\r\n0, 1, 1);\r\nhws[CLKID_TWD] =\r\nclk_hw_register_fixed_factor(NULL, "twd", "cpu", 0, 1, 3);\r\nfor (n = 0; n < MAX_CLKS; n++) {\r\nif (!IS_ERR(hws[n]))\r\ncontinue;\r\npr_err("%s: Unable to register leaf clock %d\n",\r\nnp->full_name, n);\r\ngoto bg2q_fail;\r\n}\r\nof_clk_add_hw_provider(np, of_clk_hw_onecell_get, clk_data);\r\nreturn;\r\nbg2q_fail:\r\niounmap(cpupll_base);\r\niounmap(gbase);\r\n}

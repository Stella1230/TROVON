static void led_turn_on(struct work_struct *work)\r\n{\r\nu8 reg;\r\nstruct rtl8187_priv *priv = container_of(work, struct rtl8187_priv,\r\nled_on.work);\r\nstruct rtl8187_led *led = &priv->led_tx;\r\nif (!priv->vif || priv->vif->type == NL80211_IFTYPE_UNSPECIFIED)\r\nreturn ;\r\nif (!led->dev)\r\nreturn;\r\nmutex_lock(&priv->conf_mutex);\r\nswitch (led->ledpin) {\r\ncase LED_PIN_GPIO0:\r\nrtl818x_iowrite8(priv, &priv->map->GPIO0, 0x01);\r\nrtl818x_iowrite8(priv, &priv->map->GP_ENABLE, 0x00);\r\nbreak;\r\ncase LED_PIN_LED0:\r\nreg = rtl818x_ioread8(priv, &priv->map->PGSELECT) & ~(1 << 4);\r\nrtl818x_iowrite8(priv, &priv->map->PGSELECT, reg);\r\nbreak;\r\ncase LED_PIN_LED1:\r\nreg = rtl818x_ioread8(priv, &priv->map->PGSELECT) & ~(1 << 5);\r\nrtl818x_iowrite8(priv, &priv->map->PGSELECT, reg);\r\nbreak;\r\ncase LED_PIN_HW:\r\ndefault:\r\nbreak;\r\n}\r\nmutex_unlock(&priv->conf_mutex);\r\n}\r\nstatic void led_turn_off(struct work_struct *work)\r\n{\r\nu8 reg;\r\nstruct rtl8187_priv *priv = container_of(work, struct rtl8187_priv,\r\nled_off.work);\r\nstruct rtl8187_led *led = &priv->led_tx;\r\nif (!priv->vif || priv->vif->type == NL80211_IFTYPE_UNSPECIFIED)\r\nreturn ;\r\nif (!led->dev)\r\nreturn;\r\nmutex_lock(&priv->conf_mutex);\r\nswitch (led->ledpin) {\r\ncase LED_PIN_GPIO0:\r\nrtl818x_iowrite8(priv, &priv->map->GPIO0, 0x01);\r\nrtl818x_iowrite8(priv, &priv->map->GP_ENABLE, 0x01);\r\nbreak;\r\ncase LED_PIN_LED0:\r\nreg = rtl818x_ioread8(priv, &priv->map->PGSELECT) | (1 << 4);\r\nrtl818x_iowrite8(priv, &priv->map->PGSELECT, reg);\r\nbreak;\r\ncase LED_PIN_LED1:\r\nreg = rtl818x_ioread8(priv, &priv->map->PGSELECT) | (1 << 5);\r\nrtl818x_iowrite8(priv, &priv->map->PGSELECT, reg);\r\nbreak;\r\ncase LED_PIN_HW:\r\ndefault:\r\nbreak;\r\n}\r\nmutex_unlock(&priv->conf_mutex);\r\n}\r\nstatic void rtl8187_led_brightness_set(struct led_classdev *led_dev,\r\nenum led_brightness brightness)\r\n{\r\nstruct rtl8187_led *led = container_of(led_dev, struct rtl8187_led,\r\nled_dev);\r\nstruct ieee80211_hw *hw = led->dev;\r\nstruct rtl8187_priv *priv;\r\nstatic bool radio_on;\r\nif (!hw)\r\nreturn;\r\npriv = hw->priv;\r\nif (led->is_radio) {\r\nif (brightness == LED_FULL) {\r\nieee80211_queue_delayed_work(hw, &priv->led_on, 0);\r\nradio_on = true;\r\n} else if (radio_on) {\r\nradio_on = false;\r\ncancel_delayed_work(&priv->led_on);\r\nieee80211_queue_delayed_work(hw, &priv->led_off, 0);\r\n}\r\n} else if (radio_on) {\r\nif (brightness == LED_OFF) {\r\nieee80211_queue_delayed_work(hw, &priv->led_off, 0);\r\nieee80211_queue_delayed_work(hw, &priv->led_on,\r\nHZ / 20);\r\n} else\r\nieee80211_queue_delayed_work(hw, &priv->led_on, 0);\r\n}\r\n}\r\nstatic int rtl8187_register_led(struct ieee80211_hw *dev,\r\nstruct rtl8187_led *led, const char *name,\r\nconst char *default_trigger, u8 ledpin,\r\nbool is_radio)\r\n{\r\nint err;\r\nstruct rtl8187_priv *priv = dev->priv;\r\nif (led->dev)\r\nreturn -EEXIST;\r\nif (!default_trigger)\r\nreturn -EINVAL;\r\nled->dev = dev;\r\nled->ledpin = ledpin;\r\nled->is_radio = is_radio;\r\nstrncpy(led->name, name, sizeof(led->name));\r\nled->led_dev.name = led->name;\r\nled->led_dev.default_trigger = default_trigger;\r\nled->led_dev.brightness_set = rtl8187_led_brightness_set;\r\nerr = led_classdev_register(&priv->udev->dev, &led->led_dev);\r\nif (err) {\r\nprintk(KERN_INFO "LEDs: Failed to register %s\n", name);\r\nled->dev = NULL;\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rtl8187_unregister_led(struct rtl8187_led *led)\r\n{\r\nstruct ieee80211_hw *hw = led->dev;\r\nstruct rtl8187_priv *priv = hw->priv;\r\nled_classdev_unregister(&led->led_dev);\r\nflush_delayed_work(&priv->led_off);\r\nled->dev = NULL;\r\n}\r\nvoid rtl8187_leds_init(struct ieee80211_hw *dev, u16 custid)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nchar name[RTL8187_LED_MAX_NAME_LEN + 1];\r\nu8 ledpin;\r\nint err;\r\nprintk(KERN_INFO "rtl8187: Customer ID is 0x%02X\n", custid);\r\nswitch (custid) {\r\ncase EEPROM_CID_RSVD0:\r\ncase EEPROM_CID_RSVD1:\r\ncase EEPROM_CID_SERCOMM_PS:\r\ncase EEPROM_CID_QMI:\r\ncase EEPROM_CID_DELL:\r\ncase EEPROM_CID_TOSHIBA:\r\nledpin = LED_PIN_GPIO0;\r\nbreak;\r\ncase EEPROM_CID_ALPHA0:\r\nledpin = LED_PIN_LED0;\r\nbreak;\r\ncase EEPROM_CID_HW:\r\nledpin = LED_PIN_HW;\r\nbreak;\r\ndefault:\r\nledpin = LED_PIN_GPIO0;\r\n}\r\nINIT_DELAYED_WORK(&priv->led_on, led_turn_on);\r\nINIT_DELAYED_WORK(&priv->led_off, led_turn_off);\r\nsnprintf(name, sizeof(name),\r\n"rtl8187-%s::radio", wiphy_name(dev->wiphy));\r\nerr = rtl8187_register_led(dev, &priv->led_radio, name,\r\nieee80211_get_radio_led_name(dev), ledpin, true);\r\nif (err)\r\nreturn;\r\nsnprintf(name, sizeof(name),\r\n"rtl8187-%s::tx", wiphy_name(dev->wiphy));\r\nerr = rtl8187_register_led(dev, &priv->led_tx, name,\r\nieee80211_get_tx_led_name(dev), ledpin, false);\r\nif (err)\r\ngoto err_tx;\r\nsnprintf(name, sizeof(name),\r\n"rtl8187-%s::rx", wiphy_name(dev->wiphy));\r\nerr = rtl8187_register_led(dev, &priv->led_rx, name,\r\nieee80211_get_rx_led_name(dev), ledpin, false);\r\nif (!err)\r\nreturn;\r\nrtl8187_unregister_led(&priv->led_tx);\r\nerr_tx:\r\nrtl8187_unregister_led(&priv->led_radio);\r\n}\r\nvoid rtl8187_leds_exit(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nrtl8187_unregister_led(&priv->led_radio);\r\nrtl8187_unregister_led(&priv->led_rx);\r\nrtl8187_unregister_led(&priv->led_tx);\r\ncancel_delayed_work_sync(&priv->led_off);\r\ncancel_delayed_work_sync(&priv->led_on);\r\n}

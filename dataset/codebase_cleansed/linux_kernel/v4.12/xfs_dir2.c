unsigned char xfs_mode_to_ftype(int mode)\r\n{\r\nswitch (mode & S_IFMT) {\r\ncase S_IFREG:\r\nreturn XFS_DIR3_FT_REG_FILE;\r\ncase S_IFDIR:\r\nreturn XFS_DIR3_FT_DIR;\r\ncase S_IFCHR:\r\nreturn XFS_DIR3_FT_CHRDEV;\r\ncase S_IFBLK:\r\nreturn XFS_DIR3_FT_BLKDEV;\r\ncase S_IFIFO:\r\nreturn XFS_DIR3_FT_FIFO;\r\ncase S_IFSOCK:\r\nreturn XFS_DIR3_FT_SOCK;\r\ncase S_IFLNK:\r\nreturn XFS_DIR3_FT_SYMLINK;\r\ndefault:\r\nreturn XFS_DIR3_FT_UNKNOWN;\r\n}\r\n}\r\nSTATIC xfs_dahash_t\r\nxfs_ascii_ci_hashname(\r\nstruct xfs_name *name)\r\n{\r\nxfs_dahash_t hash;\r\nint i;\r\nfor (i = 0, hash = 0; i < name->len; i++)\r\nhash = tolower(name->name[i]) ^ rol32(hash, 7);\r\nreturn hash;\r\n}\r\nSTATIC enum xfs_dacmp\r\nxfs_ascii_ci_compname(\r\nstruct xfs_da_args *args,\r\nconst unsigned char *name,\r\nint len)\r\n{\r\nenum xfs_dacmp result;\r\nint i;\r\nif (args->namelen != len)\r\nreturn XFS_CMP_DIFFERENT;\r\nresult = XFS_CMP_EXACT;\r\nfor (i = 0; i < len; i++) {\r\nif (args->name[i] == name[i])\r\ncontinue;\r\nif (tolower(args->name[i]) != tolower(name[i]))\r\nreturn XFS_CMP_DIFFERENT;\r\nresult = XFS_CMP_CASE;\r\n}\r\nreturn result;\r\n}\r\nint\r\nxfs_da_mount(\r\nstruct xfs_mount *mp)\r\n{\r\nstruct xfs_da_geometry *dageo;\r\nint nodehdr_size;\r\nASSERT(mp->m_sb.sb_versionnum & XFS_SB_VERSION_DIRV2BIT);\r\nASSERT((1 << (mp->m_sb.sb_blocklog + mp->m_sb.sb_dirblklog)) <=\r\nXFS_MAX_BLOCKSIZE);\r\nmp->m_dir_inode_ops = xfs_dir_get_ops(mp, NULL);\r\nmp->m_nondir_inode_ops = xfs_nondir_get_ops(mp, NULL);\r\nnodehdr_size = mp->m_dir_inode_ops->node_hdr_size;\r\nmp->m_dir_geo = kmem_zalloc(sizeof(struct xfs_da_geometry),\r\nKM_SLEEP | KM_MAYFAIL);\r\nmp->m_attr_geo = kmem_zalloc(sizeof(struct xfs_da_geometry),\r\nKM_SLEEP | KM_MAYFAIL);\r\nif (!mp->m_dir_geo || !mp->m_attr_geo) {\r\nkmem_free(mp->m_dir_geo);\r\nkmem_free(mp->m_attr_geo);\r\nreturn -ENOMEM;\r\n}\r\ndageo = mp->m_dir_geo;\r\ndageo->blklog = mp->m_sb.sb_blocklog + mp->m_sb.sb_dirblklog;\r\ndageo->fsblog = mp->m_sb.sb_blocklog;\r\ndageo->blksize = 1 << dageo->blklog;\r\ndageo->fsbcount = 1 << mp->m_sb.sb_dirblklog;\r\ndageo->datablk = xfs_dir2_byte_to_da(dageo, XFS_DIR2_DATA_OFFSET);\r\ndageo->leafblk = xfs_dir2_byte_to_da(dageo, XFS_DIR2_LEAF_OFFSET);\r\ndageo->freeblk = xfs_dir2_byte_to_da(dageo, XFS_DIR2_FREE_OFFSET);\r\ndageo->node_ents = (dageo->blksize - nodehdr_size) /\r\n(uint)sizeof(xfs_da_node_entry_t);\r\ndageo->magicpct = (dageo->blksize * 37) / 100;\r\ndageo = mp->m_attr_geo;\r\ndageo->blklog = mp->m_sb.sb_blocklog;\r\ndageo->fsblog = mp->m_sb.sb_blocklog;\r\ndageo->blksize = 1 << dageo->blklog;\r\ndageo->fsbcount = 1;\r\ndageo->node_ents = (dageo->blksize - nodehdr_size) /\r\n(uint)sizeof(xfs_da_node_entry_t);\r\ndageo->magicpct = (dageo->blksize * 37) / 100;\r\nif (xfs_sb_version_hasasciici(&mp->m_sb))\r\nmp->m_dirnameops = &xfs_ascii_ci_nameops;\r\nelse\r\nmp->m_dirnameops = &xfs_default_nameops;\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_da_unmount(\r\nstruct xfs_mount *mp)\r\n{\r\nkmem_free(mp->m_dir_geo);\r\nkmem_free(mp->m_attr_geo);\r\n}\r\nint\r\nxfs_dir_isempty(\r\nxfs_inode_t *dp)\r\n{\r\nxfs_dir2_sf_hdr_t *sfp;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nif (dp->i_d.di_size == 0)\r\nreturn 1;\r\nif (dp->i_d.di_size > XFS_IFORK_DSIZE(dp))\r\nreturn 0;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nreturn !sfp->count;\r\n}\r\nint\r\nxfs_dir_ino_validate(\r\nxfs_mount_t *mp,\r\nxfs_ino_t ino)\r\n{\r\nxfs_agblock_t agblkno;\r\nxfs_agino_t agino;\r\nxfs_agnumber_t agno;\r\nint ino_ok;\r\nint ioff;\r\nagno = XFS_INO_TO_AGNO(mp, ino);\r\nagblkno = XFS_INO_TO_AGBNO(mp, ino);\r\nioff = XFS_INO_TO_OFFSET(mp, ino);\r\nagino = XFS_OFFBNO_TO_AGINO(mp, agblkno, ioff);\r\nino_ok =\r\nagno < mp->m_sb.sb_agcount &&\r\nagblkno < mp->m_sb.sb_agblocks &&\r\nagblkno != 0 &&\r\nioff < (1 << mp->m_sb.sb_inopblog) &&\r\nXFS_AGINO_TO_INO(mp, agno, agino) == ino;\r\nif (unlikely(XFS_TEST_ERROR(!ino_ok, mp, XFS_ERRTAG_DIR_INO_VALIDATE,\r\nXFS_RANDOM_DIR_INO_VALIDATE))) {\r\nxfs_warn(mp, "Invalid inode number 0x%Lx",\r\n(unsigned long long) ino);\r\nXFS_ERROR_REPORT("xfs_dir_ino_validate", XFS_ERRLEVEL_LOW, mp);\r\nreturn -EFSCORRUPTED;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir_init(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nxfs_inode_t *pdp)\r\n{\r\nstruct xfs_da_args *args;\r\nint error;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nerror = xfs_dir_ino_validate(tp->t_mountp, pdp->i_ino);\r\nif (error)\r\nreturn error;\r\nargs = kmem_zalloc(sizeof(*args), KM_SLEEP | KM_NOFS);\r\nif (!args)\r\nreturn -ENOMEM;\r\nargs->geo = dp->i_mount->m_dir_geo;\r\nargs->dp = dp;\r\nargs->trans = tp;\r\nerror = xfs_dir2_sf_create(args, pdp->i_ino);\r\nkmem_free(args);\r\nreturn error;\r\n}\r\nint\r\nxfs_dir_createname(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nstruct xfs_name *name,\r\nxfs_ino_t inum,\r\nxfs_fsblock_t *first,\r\nstruct xfs_defer_ops *dfops,\r\nxfs_extlen_t total)\r\n{\r\nstruct xfs_da_args *args;\r\nint rval;\r\nint v;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nif (inum) {\r\nrval = xfs_dir_ino_validate(tp->t_mountp, inum);\r\nif (rval)\r\nreturn rval;\r\nXFS_STATS_INC(dp->i_mount, xs_dir_create);\r\n}\r\nargs = kmem_zalloc(sizeof(*args), KM_SLEEP | KM_NOFS);\r\nif (!args)\r\nreturn -ENOMEM;\r\nargs->geo = dp->i_mount->m_dir_geo;\r\nargs->name = name->name;\r\nargs->namelen = name->len;\r\nargs->filetype = name->type;\r\nargs->hashval = dp->i_mount->m_dirnameops->hashname(name);\r\nargs->inumber = inum;\r\nargs->dp = dp;\r\nargs->firstblock = first;\r\nargs->dfops = dfops;\r\nargs->total = total;\r\nargs->whichfork = XFS_DATA_FORK;\r\nargs->trans = tp;\r\nargs->op_flags = XFS_DA_OP_ADDNAME | XFS_DA_OP_OKNOENT;\r\nif (!inum)\r\nargs->op_flags |= XFS_DA_OP_JUSTCHECK;\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL) {\r\nrval = xfs_dir2_sf_addname(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isblock(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v) {\r\nrval = xfs_dir2_block_addname(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isleaf(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v)\r\nrval = xfs_dir2_leaf_addname(args);\r\nelse\r\nrval = xfs_dir2_node_addname(args);\r\nout_free:\r\nkmem_free(args);\r\nreturn rval;\r\n}\r\nint\r\nxfs_dir_cilookup_result(\r\nstruct xfs_da_args *args,\r\nconst unsigned char *name,\r\nint len)\r\n{\r\nif (args->cmpresult == XFS_CMP_DIFFERENT)\r\nreturn -ENOENT;\r\nif (args->cmpresult != XFS_CMP_CASE ||\r\n!(args->op_flags & XFS_DA_OP_CILOOKUP))\r\nreturn -EEXIST;\r\nargs->value = kmem_alloc(len, KM_NOFS | KM_MAYFAIL);\r\nif (!args->value)\r\nreturn -ENOMEM;\r\nmemcpy(args->value, name, len);\r\nargs->valuelen = len;\r\nreturn -EEXIST;\r\n}\r\nint\r\nxfs_dir_lookup(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nstruct xfs_name *name,\r\nxfs_ino_t *inum,\r\nstruct xfs_name *ci_name)\r\n{\r\nstruct xfs_da_args *args;\r\nint rval;\r\nint v;\r\nint lock_mode;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nXFS_STATS_INC(dp->i_mount, xs_dir_lookup);\r\nargs = kmem_zalloc(sizeof(*args), KM_SLEEP | KM_NOFS);\r\nargs->geo = dp->i_mount->m_dir_geo;\r\nargs->name = name->name;\r\nargs->namelen = name->len;\r\nargs->filetype = name->type;\r\nargs->hashval = dp->i_mount->m_dirnameops->hashname(name);\r\nargs->dp = dp;\r\nargs->whichfork = XFS_DATA_FORK;\r\nargs->trans = tp;\r\nargs->op_flags = XFS_DA_OP_OKNOENT;\r\nif (ci_name)\r\nargs->op_flags |= XFS_DA_OP_CILOOKUP;\r\nlock_mode = xfs_ilock_data_map_shared(dp);\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL) {\r\nrval = xfs_dir2_sf_lookup(args);\r\ngoto out_check_rval;\r\n}\r\nrval = xfs_dir2_isblock(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v) {\r\nrval = xfs_dir2_block_lookup(args);\r\ngoto out_check_rval;\r\n}\r\nrval = xfs_dir2_isleaf(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v)\r\nrval = xfs_dir2_leaf_lookup(args);\r\nelse\r\nrval = xfs_dir2_node_lookup(args);\r\nout_check_rval:\r\nif (rval == -EEXIST)\r\nrval = 0;\r\nif (!rval) {\r\n*inum = args->inumber;\r\nif (ci_name) {\r\nci_name->name = args->value;\r\nci_name->len = args->valuelen;\r\n}\r\n}\r\nout_free:\r\nxfs_iunlock(dp, lock_mode);\r\nkmem_free(args);\r\nreturn rval;\r\n}\r\nint\r\nxfs_dir_removename(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nstruct xfs_name *name,\r\nxfs_ino_t ino,\r\nxfs_fsblock_t *first,\r\nstruct xfs_defer_ops *dfops,\r\nxfs_extlen_t total)\r\n{\r\nstruct xfs_da_args *args;\r\nint rval;\r\nint v;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nXFS_STATS_INC(dp->i_mount, xs_dir_remove);\r\nargs = kmem_zalloc(sizeof(*args), KM_SLEEP | KM_NOFS);\r\nif (!args)\r\nreturn -ENOMEM;\r\nargs->geo = dp->i_mount->m_dir_geo;\r\nargs->name = name->name;\r\nargs->namelen = name->len;\r\nargs->filetype = name->type;\r\nargs->hashval = dp->i_mount->m_dirnameops->hashname(name);\r\nargs->inumber = ino;\r\nargs->dp = dp;\r\nargs->firstblock = first;\r\nargs->dfops = dfops;\r\nargs->total = total;\r\nargs->whichfork = XFS_DATA_FORK;\r\nargs->trans = tp;\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL) {\r\nrval = xfs_dir2_sf_removename(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isblock(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v) {\r\nrval = xfs_dir2_block_removename(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isleaf(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v)\r\nrval = xfs_dir2_leaf_removename(args);\r\nelse\r\nrval = xfs_dir2_node_removename(args);\r\nout_free:\r\nkmem_free(args);\r\nreturn rval;\r\n}\r\nint\r\nxfs_dir_replace(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nstruct xfs_name *name,\r\nxfs_ino_t inum,\r\nxfs_fsblock_t *first,\r\nstruct xfs_defer_ops *dfops,\r\nxfs_extlen_t total)\r\n{\r\nstruct xfs_da_args *args;\r\nint rval;\r\nint v;\r\nASSERT(S_ISDIR(VFS_I(dp)->i_mode));\r\nrval = xfs_dir_ino_validate(tp->t_mountp, inum);\r\nif (rval)\r\nreturn rval;\r\nargs = kmem_zalloc(sizeof(*args), KM_SLEEP | KM_NOFS);\r\nif (!args)\r\nreturn -ENOMEM;\r\nargs->geo = dp->i_mount->m_dir_geo;\r\nargs->name = name->name;\r\nargs->namelen = name->len;\r\nargs->filetype = name->type;\r\nargs->hashval = dp->i_mount->m_dirnameops->hashname(name);\r\nargs->inumber = inum;\r\nargs->dp = dp;\r\nargs->firstblock = first;\r\nargs->dfops = dfops;\r\nargs->total = total;\r\nargs->whichfork = XFS_DATA_FORK;\r\nargs->trans = tp;\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL) {\r\nrval = xfs_dir2_sf_replace(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isblock(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v) {\r\nrval = xfs_dir2_block_replace(args);\r\ngoto out_free;\r\n}\r\nrval = xfs_dir2_isleaf(args, &v);\r\nif (rval)\r\ngoto out_free;\r\nif (v)\r\nrval = xfs_dir2_leaf_replace(args);\r\nelse\r\nrval = xfs_dir2_node_replace(args);\r\nout_free:\r\nkmem_free(args);\r\nreturn rval;\r\n}\r\nint\r\nxfs_dir_canenter(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *dp,\r\nstruct xfs_name *name)\r\n{\r\nreturn xfs_dir_createname(tp, dp, name, 0, NULL, NULL, 0);\r\n}\r\nint\r\nxfs_dir2_grow_inode(\r\nstruct xfs_da_args *args,\r\nint space,\r\nxfs_dir2_db_t *dbp)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_mount *mp = dp->i_mount;\r\nxfs_fileoff_t bno;\r\nint count;\r\nint error;\r\ntrace_xfs_dir2_grow_inode(args, space);\r\nbno = XFS_B_TO_FSBT(mp, space * XFS_DIR2_SPACE_SIZE);\r\ncount = args->geo->fsbcount;\r\nerror = xfs_da_grow_inode_int(args, &bno, count);\r\nif (error)\r\nreturn error;\r\n*dbp = xfs_dir2_da_to_db(args->geo, (xfs_dablk_t)bno);\r\nif (space == XFS_DIR2_DATA_SPACE) {\r\nxfs_fsize_t size;\r\nsize = XFS_FSB_TO_B(mp, bno + count);\r\nif (size > dp->i_d.di_size) {\r\ndp->i_d.di_size = size;\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_isblock(\r\nstruct xfs_da_args *args,\r\nint *vp)\r\n{\r\nxfs_fileoff_t last;\r\nint rval;\r\nif ((rval = xfs_bmap_last_offset(args->dp, &last, XFS_DATA_FORK)))\r\nreturn rval;\r\nrval = XFS_FSB_TO_B(args->dp->i_mount, last) == args->geo->blksize;\r\nif (rval != 0 && args->dp->i_d.di_size != args->geo->blksize)\r\nreturn -EFSCORRUPTED;\r\n*vp = rval;\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_isleaf(\r\nstruct xfs_da_args *args,\r\nint *vp)\r\n{\r\nxfs_fileoff_t last;\r\nint rval;\r\nif ((rval = xfs_bmap_last_offset(args->dp, &last, XFS_DATA_FORK)))\r\nreturn rval;\r\n*vp = last == args->geo->leafblk + args->geo->fsbcount;\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_shrink_inode(\r\nxfs_da_args_t *args,\r\nxfs_dir2_db_t db,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_fileoff_t bno;\r\nxfs_dablk_t da;\r\nint done;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_shrink_inode(args, db);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nda = xfs_dir2_db_to_da(args->geo, db);\r\nerror = xfs_bunmapi(tp, dp, da, args->geo->fsbcount, 0, 0,\r\nargs->firstblock, args->dfops, &done);\r\nif (error) {\r\nreturn error;\r\n}\r\nASSERT(done);\r\nxfs_trans_binval(tp, bp);\r\nif (db >= xfs_dir2_byte_to_db(args->geo, XFS_DIR2_LEAF_OFFSET))\r\nreturn 0;\r\nif (dp->i_d.di_size > xfs_dir2_db_off_to_byte(args->geo, db + 1, 0))\r\nreturn 0;\r\nbno = da;\r\nif ((error = xfs_bmap_last_before(tp, dp, &bno, XFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nif (db == args->geo->datablk)\r\nASSERT(bno == 0);\r\nelse\r\nASSERT(bno > 0);\r\ndp->i_d.di_size = XFS_FSB_TO_B(mp, bno);\r\nxfs_trans_log_inode(tp, dp, XFS_ILOG_CORE);\r\nreturn 0;\r\n}

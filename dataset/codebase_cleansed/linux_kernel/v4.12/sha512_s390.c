static int sha512_init(struct shash_desc *desc)\r\n{\r\nstruct s390_sha_ctx *ctx = shash_desc_ctx(desc);\r\n*(__u64 *)&ctx->state[0] = 0x6a09e667f3bcc908ULL;\r\n*(__u64 *)&ctx->state[2] = 0xbb67ae8584caa73bULL;\r\n*(__u64 *)&ctx->state[4] = 0x3c6ef372fe94f82bULL;\r\n*(__u64 *)&ctx->state[6] = 0xa54ff53a5f1d36f1ULL;\r\n*(__u64 *)&ctx->state[8] = 0x510e527fade682d1ULL;\r\n*(__u64 *)&ctx->state[10] = 0x9b05688c2b3e6c1fULL;\r\n*(__u64 *)&ctx->state[12] = 0x1f83d9abfb41bd6bULL;\r\n*(__u64 *)&ctx->state[14] = 0x5be0cd19137e2179ULL;\r\nctx->count = 0;\r\nctx->func = CPACF_KIMD_SHA_512;\r\nreturn 0;\r\n}\r\nstatic int sha512_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nstruct sha512_state *octx = out;\r\noctx->count[0] = sctx->count;\r\noctx->count[1] = 0;\r\nmemcpy(octx->state, sctx->state, sizeof(octx->state));\r\nmemcpy(octx->buf, sctx->buf, sizeof(octx->buf));\r\nreturn 0;\r\n}\r\nstatic int sha512_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nconst struct sha512_state *ictx = in;\r\nif (unlikely(ictx->count[1]))\r\nreturn -ERANGE;\r\nsctx->count = ictx->count[0];\r\nmemcpy(sctx->state, ictx->state, sizeof(ictx->state));\r\nmemcpy(sctx->buf, ictx->buf, sizeof(ictx->buf));\r\nsctx->func = CPACF_KIMD_SHA_512;\r\nreturn 0;\r\n}\r\nstatic int sha384_init(struct shash_desc *desc)\r\n{\r\nstruct s390_sha_ctx *ctx = shash_desc_ctx(desc);\r\n*(__u64 *)&ctx->state[0] = 0xcbbb9d5dc1059ed8ULL;\r\n*(__u64 *)&ctx->state[2] = 0x629a292a367cd507ULL;\r\n*(__u64 *)&ctx->state[4] = 0x9159015a3070dd17ULL;\r\n*(__u64 *)&ctx->state[6] = 0x152fecd8f70e5939ULL;\r\n*(__u64 *)&ctx->state[8] = 0x67332667ffc00b31ULL;\r\n*(__u64 *)&ctx->state[10] = 0x8eb44a8768581511ULL;\r\n*(__u64 *)&ctx->state[12] = 0xdb0c2e0d64f98fa7ULL;\r\n*(__u64 *)&ctx->state[14] = 0x47b5481dbefa4fa4ULL;\r\nctx->count = 0;\r\nctx->func = CPACF_KIMD_SHA_512;\r\nreturn 0;\r\n}\r\nstatic int __init init(void)\r\n{\r\nint ret;\r\nif (!cpacf_query_func(CPACF_KIMD, CPACF_KIMD_SHA_512))\r\nreturn -EOPNOTSUPP;\r\nif ((ret = crypto_register_shash(&sha512_alg)) < 0)\r\ngoto out;\r\nif ((ret = crypto_register_shash(&sha384_alg)) < 0)\r\ncrypto_unregister_shash(&sha512_alg);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void __exit fini(void)\r\n{\r\ncrypto_unregister_shash(&sha512_alg);\r\ncrypto_unregister_shash(&sha384_alg);\r\n}

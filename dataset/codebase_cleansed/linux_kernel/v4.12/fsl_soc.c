phys_addr_t get_immrbase(void)\r\n{\r\nstruct device_node *soc;\r\nif (immrbase != -1)\r\nreturn immrbase;\r\nsoc = of_find_node_by_type(NULL, "soc");\r\nif (soc) {\r\nint size;\r\nu32 naddr;\r\nconst __be32 *prop = of_get_property(soc, "#address-cells", &size);\r\nif (prop && size == 4)\r\nnaddr = be32_to_cpup(prop);\r\nelse\r\nnaddr = 2;\r\nprop = of_get_property(soc, "ranges", &size);\r\nif (prop)\r\nimmrbase = of_translate_address(soc, prop + naddr);\r\nof_node_put(soc);\r\n}\r\nreturn immrbase;\r\n}\r\nu32 fsl_get_sys_freq(void)\r\n{\r\nstatic u32 sysfreq = -1;\r\nstruct device_node *soc;\r\nif (sysfreq != -1)\r\nreturn sysfreq;\r\nsoc = of_find_node_by_type(NULL, "soc");\r\nif (!soc)\r\nreturn -1;\r\nof_property_read_u32(soc, "clock-frequency", &sysfreq);\r\nif (sysfreq == -1 || !sysfreq)\r\nof_property_read_u32(soc, "bus-frequency", &sysfreq);\r\nof_node_put(soc);\r\nreturn sysfreq;\r\n}\r\nu32 get_brgfreq(void)\r\n{\r\nstatic u32 brgfreq = -1;\r\nstruct device_node *node;\r\nif (brgfreq != -1)\r\nreturn brgfreq;\r\nnode = of_find_compatible_node(NULL, NULL, "fsl,cpm-brg");\r\nif (node) {\r\nof_property_read_u32(node, "clock-frequency", &brgfreq);\r\nof_node_put(node);\r\nreturn brgfreq;\r\n}\r\nnode = of_find_node_by_type(NULL, "cpm");\r\nif (!node)\r\nnode = of_find_compatible_node(NULL, NULL, "fsl,qe");\r\nif (!node)\r\nnode = of_find_node_by_type(NULL, "qe");\r\nif (node) {\r\nof_property_read_u32(node, "brg-frequency", &brgfreq);\r\nif (brgfreq == -1 || !brgfreq)\r\nif (!of_property_read_u32(node, "bus-frequency",\r\n&brgfreq))\r\nbrgfreq /= 2;\r\nof_node_put(node);\r\n}\r\nreturn brgfreq;\r\n}\r\nu32 get_baudrate(void)\r\n{\r\nstatic u32 fs_baudrate = -1;\r\nstruct device_node *node;\r\nif (fs_baudrate != -1)\r\nreturn fs_baudrate;\r\nnode = of_find_node_by_type(NULL, "serial");\r\nif (node) {\r\nof_property_read_u32(node, "current-speed", &fs_baudrate);\r\nof_node_put(node);\r\n}\r\nreturn fs_baudrate;\r\n}\r\nstatic int fsl_rstcr_restart(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nlocal_irq_disable();\r\nout_be32(rstcr, 0x2);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init setup_rstcr(void)\r\n{\r\nstruct device_node *np;\r\nstatic struct notifier_block restart_handler = {\r\n.notifier_call = fsl_rstcr_restart,\r\n.priority = 128,\r\n};\r\nfor_each_node_by_name(np, "global-utilities") {\r\nif ((of_get_property(np, "fsl,has-rstcr", NULL))) {\r\nrstcr = of_iomap(np, 0) + 0xb0;\r\nif (!rstcr) {\r\nprintk (KERN_ERR "Error: reset control "\r\n"register not mapped!\n");\r\n} else {\r\nregister_restart_handler(&restart_handler);\r\n}\r\nbreak;\r\n}\r\n}\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nvoid __noreturn fsl_hv_restart(char *cmd)\r\n{\r\npr_info("hv restart\n");\r\nfh_partition_restart(-1);\r\nwhile (1) ;\r\n}\r\nvoid __noreturn fsl_hv_halt(void)\r\n{\r\npr_info("hv exit\n");\r\nfh_partition_stop(-1);\r\nwhile (1) ;\r\n}

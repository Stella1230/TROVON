static int zcrypt_pcixcc_rng_supported(struct ap_queue *aq)\r\n{\r\nstruct ap_message ap_msg;\r\nunsigned long long psmid;\r\nunsigned int domain;\r\nstruct {\r\nstruct type86_hdr hdr;\r\nstruct type86_fmt2_ext fmt2;\r\nstruct CPRBX cprbx;\r\n} __attribute__((packed)) *reply;\r\nstruct {\r\nstruct type6_hdr hdr;\r\nstruct CPRBX cprbx;\r\nchar function_code[2];\r\nshort int rule_length;\r\nchar rule[8];\r\nshort int verb_length;\r\nshort int key_length;\r\n} __packed * msg;\r\nint rc, i;\r\nap_init_message(&ap_msg);\r\nap_msg.message = (void *) get_zeroed_page(GFP_KERNEL);\r\nif (!ap_msg.message)\r\nreturn -ENOMEM;\r\nrng_type6CPRB_msgX(&ap_msg, 4, &domain);\r\nmsg = ap_msg.message;\r\nmsg->cprbx.domain = AP_QID_QUEUE(aq->qid);\r\nrc = ap_send(aq->qid, 0x0102030405060708ULL, ap_msg.message,\r\nap_msg.length);\r\nif (rc)\r\ngoto out_free;\r\nfor (i = 0; i < 2 * HZ; i++) {\r\nmsleep(1000 / HZ);\r\nrc = ap_recv(aq->qid, &psmid, ap_msg.message, 4096);\r\nif (rc == 0 && psmid == 0x0102030405060708ULL)\r\nbreak;\r\n}\r\nif (i >= 2 * HZ) {\r\nrc = -ENODEV;\r\ngoto out_free;\r\n}\r\nreply = ap_msg.message;\r\nif (reply->cprbx.ccp_rtcode == 0 && reply->cprbx.ccp_rscode == 0)\r\nrc = 1;\r\nelse\r\nrc = 0;\r\nout_free:\r\nfree_page((unsigned long) ap_msg.message);\r\nreturn rc;\r\n}\r\nstatic int zcrypt_pcixcc_card_probe(struct ap_device *ap_dev)\r\n{\r\nstatic const int CEX2C_SPEED_IDX[] = {\r\n1000, 1400, 2400, 1100, 1500, 2600, 100, 12};\r\nstatic const int CEX3C_SPEED_IDX[] = {\r\n500, 700, 1400, 550, 800, 1500, 80, 10};\r\nstruct ap_card *ac = to_ap_card(&ap_dev->device);\r\nstruct zcrypt_card *zc;\r\nint rc = 0;\r\nzc = zcrypt_card_alloc();\r\nif (!zc)\r\nreturn -ENOMEM;\r\nzc->card = ac;\r\nac->private = zc;\r\nswitch (ac->ap_dev.device_type) {\r\ncase AP_DEVICE_TYPE_CEX2C:\r\nzc->user_space_type = ZCRYPT_CEX2C;\r\nzc->type_string = "CEX2C";\r\nmemcpy(zc->speed_rating, CEX2C_SPEED_IDX,\r\nsizeof(CEX2C_SPEED_IDX));\r\nzc->min_mod_size = PCIXCC_MIN_MOD_SIZE;\r\nzc->max_mod_size = PCIXCC_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = PCIXCC_MAX_MOD_SIZE;\r\nbreak;\r\ncase AP_DEVICE_TYPE_CEX3C:\r\nzc->user_space_type = ZCRYPT_CEX3C;\r\nzc->type_string = "CEX3C";\r\nmemcpy(zc->speed_rating, CEX3C_SPEED_IDX,\r\nsizeof(CEX3C_SPEED_IDX));\r\nzc->min_mod_size = CEX3C_MIN_MOD_SIZE;\r\nzc->max_mod_size = CEX3C_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = CEX3C_MAX_MOD_SIZE;\r\nbreak;\r\ndefault:\r\nzcrypt_card_free(zc);\r\nreturn -ENODEV;\r\n}\r\nzc->online = 1;\r\nrc = zcrypt_card_register(zc);\r\nif (rc) {\r\nac->private = NULL;\r\nzcrypt_card_free(zc);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_pcixcc_card_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(&ap_dev->device)->private;\r\nif (zc)\r\nzcrypt_card_unregister(zc);\r\n}\r\nstatic int zcrypt_pcixcc_queue_probe(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq;\r\nint rc;\r\nzq = zcrypt_queue_alloc(PCIXCC_MAX_XCRB_MESSAGE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nzq->queue = aq;\r\nzq->online = 1;\r\natomic_set(&zq->load, 0);\r\nrc = zcrypt_pcixcc_rng_supported(aq);\r\nif (rc < 0) {\r\nzcrypt_queue_free(zq);\r\nreturn rc;\r\n}\r\nif (rc)\r\nzq->ops = zcrypt_msgtype(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_DEFAULT);\r\nelse\r\nzq->ops = zcrypt_msgtype(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_NORNG);\r\nap_queue_init_reply(aq, &zq->reply);\r\naq->request_timeout = PCIXCC_CLEANUP_TIME,\r\naq->private = zq;\r\nrc = zcrypt_queue_register(zq);\r\nif (rc) {\r\naq->private = NULL;\r\nzcrypt_queue_free(zq);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_pcixcc_queue_remove(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq = aq->private;\r\nap_queue_remove(aq);\r\nif (zq)\r\nzcrypt_queue_unregister(zq);\r\n}\r\nint __init zcrypt_pcixcc_init(void)\r\n{\r\nint rc;\r\nrc = ap_driver_register(&zcrypt_pcixcc_card_driver,\r\nTHIS_MODULE, "pcixcccard");\r\nif (rc)\r\nreturn rc;\r\nrc = ap_driver_register(&zcrypt_pcixcc_queue_driver,\r\nTHIS_MODULE, "pcixccqueue");\r\nif (rc)\r\nap_driver_unregister(&zcrypt_pcixcc_card_driver);\r\nreturn rc;\r\n}\r\nvoid zcrypt_pcixcc_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_pcixcc_queue_driver);\r\nap_driver_unregister(&zcrypt_pcixcc_card_driver);\r\n}

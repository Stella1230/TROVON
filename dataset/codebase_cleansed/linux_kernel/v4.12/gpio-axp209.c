static int axp20x_gpio_get_reg(unsigned offset)\r\n{\r\nswitch (offset) {\r\ncase 0:\r\nreturn AXP20X_GPIO0_CTRL;\r\ncase 1:\r\nreturn AXP20X_GPIO1_CTRL;\r\ncase 2:\r\nreturn AXP20X_GPIO2_CTRL;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int axp20x_gpio_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct axp20x_gpio *gpio = gpiochip_get_data(chip);\r\nint reg;\r\nreg = axp20x_gpio_get_reg(offset);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn regmap_update_bits(gpio->regmap, reg,\r\nAXP20X_GPIO_FUNCTIONS,\r\nAXP20X_GPIO_FUNCTION_INPUT);\r\n}\r\nstatic int axp20x_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct axp20x_gpio *gpio = gpiochip_get_data(chip);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(gpio->regmap, AXP20X_GPIO20_SS, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(val & BIT(offset + 4));\r\n}\r\nstatic int axp20x_gpio_get_direction(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct axp20x_gpio *gpio = gpiochip_get_data(chip);\r\nunsigned int val;\r\nint reg, ret;\r\nreg = axp20x_gpio_get_reg(offset);\r\nif (reg < 0)\r\nreturn reg;\r\nret = regmap_read(gpio->regmap, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nif ((val & AXP20X_GPIO_FUNCTIONS) > 2)\r\nreturn 0;\r\nreturn val & 2;\r\n}\r\nstatic int axp20x_gpio_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nstruct axp20x_gpio *gpio = gpiochip_get_data(chip);\r\nint reg;\r\nreg = axp20x_gpio_get_reg(offset);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn regmap_update_bits(gpio->regmap, reg,\r\nAXP20X_GPIO_FUNCTIONS,\r\nvalue ? AXP20X_GPIO_FUNCTION_OUT_HIGH\r\n: AXP20X_GPIO_FUNCTION_OUT_LOW);\r\n}\r\nstatic void axp20x_gpio_set(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\naxp20x_gpio_output(chip, offset, value);\r\n}\r\nstatic int axp20x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct axp20x_dev *axp20x = dev_get_drvdata(pdev->dev.parent);\r\nstruct axp20x_gpio *gpio;\r\nint ret;\r\nif (!of_device_is_available(pdev->dev.of_node))\r\nreturn -ENODEV;\r\nif (!axp20x) {\r\ndev_err(&pdev->dev, "Parent drvdata not set\n");\r\nreturn -EINVAL;\r\n}\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio)\r\nreturn -ENOMEM;\r\ngpio->chip.base = -1;\r\ngpio->chip.can_sleep = true;\r\ngpio->chip.parent = &pdev->dev;\r\ngpio->chip.label = dev_name(&pdev->dev);\r\ngpio->chip.owner = THIS_MODULE;\r\ngpio->chip.get = axp20x_gpio_get;\r\ngpio->chip.get_direction = axp20x_gpio_get_direction;\r\ngpio->chip.set = axp20x_gpio_set;\r\ngpio->chip.direction_input = axp20x_gpio_input;\r\ngpio->chip.direction_output = axp20x_gpio_output;\r\ngpio->chip.ngpio = 3;\r\ngpio->regmap = axp20x->regmap;\r\nret = devm_gpiochip_add_data(&pdev->dev, &gpio->chip, gpio);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register GPIO chip\n");\r\nreturn ret;\r\n}\r\ndev_info(&pdev->dev, "AXP209 GPIO driver loaded\n");\r\nreturn 0;\r\n}

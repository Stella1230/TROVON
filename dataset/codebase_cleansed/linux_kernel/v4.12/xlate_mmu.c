static void xen_for_each_gfn(struct page **pages, unsigned nr_gfn,\r\nxen_gfn_fn_t fn, void *data)\r\n{\r\nunsigned long xen_pfn = 0;\r\nstruct page *page;\r\nint i;\r\nfor (i = 0; i < nr_gfn; i++) {\r\nif ((i % XEN_PFN_PER_PAGE) == 0) {\r\npage = pages[i / XEN_PFN_PER_PAGE];\r\nxen_pfn = page_to_xen_pfn(page);\r\n}\r\nfn(pfn_to_gfn(xen_pfn++), data);\r\n}\r\n}\r\nstatic void setup_hparams(unsigned long gfn, void *data)\r\n{\r\nstruct remap_data *info = data;\r\ninfo->h_idxs[info->h_iter] = *info->fgfn;\r\ninfo->h_gpfns[info->h_iter] = gfn;\r\ninfo->h_errs[info->h_iter] = 0;\r\ninfo->h_iter++;\r\ninfo->fgfn++;\r\n}\r\nstatic int remap_pte_fn(pte_t *ptep, pgtable_t token, unsigned long addr,\r\nvoid *data)\r\n{\r\nstruct remap_data *info = data;\r\nstruct page *page = info->pages[info->index++];\r\npte_t pte = pte_mkspecial(pfn_pte(page_to_pfn(page), info->prot));\r\nint rc, nr_gfn;\r\nuint32_t i;\r\nstruct xen_add_to_physmap_range xatp = {\r\n.domid = DOMID_SELF,\r\n.foreign_domid = info->domid,\r\n.space = XENMAPSPACE_gmfn_foreign,\r\n};\r\nnr_gfn = min_t(typeof(info->nr_fgfn), XEN_PFN_PER_PAGE, info->nr_fgfn);\r\ninfo->nr_fgfn -= nr_gfn;\r\ninfo->h_iter = 0;\r\nxen_for_each_gfn(&page, nr_gfn, setup_hparams, info);\r\nBUG_ON(info->h_iter != nr_gfn);\r\nset_xen_guest_handle(xatp.idxs, info->h_idxs);\r\nset_xen_guest_handle(xatp.gpfns, info->h_gpfns);\r\nset_xen_guest_handle(xatp.errs, info->h_errs);\r\nxatp.size = nr_gfn;\r\nrc = HYPERVISOR_memory_op(XENMEM_add_to_physmap_range, &xatp);\r\nfor (i = 0; i < nr_gfn; i++) {\r\nint err = (rc < 0) ? rc : info->h_errs[i];\r\n*(info->err_ptr++) = err;\r\nif (!err)\r\ninfo->mapped++;\r\n}\r\nif (!rc)\r\nset_pte_at(info->vma->vm_mm, addr, ptep, pte);\r\nreturn 0;\r\n}\r\nint xen_xlate_remap_gfn_array(struct vm_area_struct *vma,\r\nunsigned long addr,\r\nxen_pfn_t *gfn, int nr,\r\nint *err_ptr, pgprot_t prot,\r\nunsigned domid,\r\nstruct page **pages)\r\n{\r\nint err;\r\nstruct remap_data data;\r\nunsigned long range = DIV_ROUND_UP(nr, XEN_PFN_PER_PAGE) << PAGE_SHIFT;\r\nBUG_ON(!((vma->vm_flags & (VM_PFNMAP | VM_IO)) == (VM_PFNMAP | VM_IO)));\r\ndata.fgfn = gfn;\r\ndata.nr_fgfn = nr;\r\ndata.prot = prot;\r\ndata.domid = domid;\r\ndata.vma = vma;\r\ndata.pages = pages;\r\ndata.index = 0;\r\ndata.err_ptr = err_ptr;\r\ndata.mapped = 0;\r\nerr = apply_to_page_range(vma->vm_mm, addr, range,\r\nremap_pte_fn, &data);\r\nreturn err < 0 ? err : data.mapped;\r\n}\r\nstatic void unmap_gfn(unsigned long gfn, void *data)\r\n{\r\nstruct xen_remove_from_physmap xrp;\r\nxrp.domid = DOMID_SELF;\r\nxrp.gpfn = gfn;\r\n(void)HYPERVISOR_memory_op(XENMEM_remove_from_physmap, &xrp);\r\n}\r\nint xen_xlate_unmap_gfn_range(struct vm_area_struct *vma,\r\nint nr, struct page **pages)\r\n{\r\nxen_for_each_gfn(pages, nr, unmap_gfn, NULL);\r\nreturn 0;\r\n}\r\nstatic void setup_balloon_gfn(unsigned long gfn, void *data)\r\n{\r\nstruct map_balloon_pages *info = data;\r\ninfo->pfns[info->idx++] = gfn;\r\n}\r\nint __init xen_xlate_map_ballooned_pages(xen_pfn_t **gfns, void **virt,\r\nunsigned long nr_grant_frames)\r\n{\r\nstruct page **pages;\r\nxen_pfn_t *pfns;\r\nvoid *vaddr;\r\nstruct map_balloon_pages data;\r\nint rc;\r\nunsigned long nr_pages;\r\nBUG_ON(nr_grant_frames == 0);\r\nnr_pages = DIV_ROUND_UP(nr_grant_frames, XEN_PFN_PER_PAGE);\r\npages = kcalloc(nr_pages, sizeof(pages[0]), GFP_KERNEL);\r\nif (!pages)\r\nreturn -ENOMEM;\r\npfns = kcalloc(nr_grant_frames, sizeof(pfns[0]), GFP_KERNEL);\r\nif (!pfns) {\r\nkfree(pages);\r\nreturn -ENOMEM;\r\n}\r\nrc = alloc_xenballooned_pages(nr_pages, pages);\r\nif (rc) {\r\npr_warn("%s Couldn't balloon alloc %ld pages rc:%d\n", __func__,\r\nnr_pages, rc);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn rc;\r\n}\r\ndata.pfns = pfns;\r\ndata.idx = 0;\r\nxen_for_each_gfn(pages, nr_grant_frames, setup_balloon_gfn, &data);\r\nvaddr = vmap(pages, nr_pages, 0, PAGE_KERNEL);\r\nif (!vaddr) {\r\npr_warn("%s Couldn't map %ld pages rc:%d\n", __func__,\r\nnr_pages, rc);\r\nfree_xenballooned_pages(nr_pages, pages);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn -ENOMEM;\r\n}\r\nkfree(pages);\r\n*gfns = pfns;\r\n*virt = vaddr;\r\nreturn 0;\r\n}

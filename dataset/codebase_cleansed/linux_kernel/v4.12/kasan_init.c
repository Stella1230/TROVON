static void __init kasan_early_pte_populate(pmd_t *pmd, unsigned long addr,\r\nunsigned long end)\r\n{\r\npte_t *pte;\r\nunsigned long next;\r\nif (pmd_none(*pmd))\r\n__pmd_populate(pmd, __pa_symbol(kasan_zero_pte), PMD_TYPE_TABLE);\r\npte = pte_offset_kimg(pmd, addr);\r\ndo {\r\nnext = addr + PAGE_SIZE;\r\nset_pte(pte, pfn_pte(sym_to_pfn(kasan_zero_page),\r\nPAGE_KERNEL));\r\n} while (pte++, addr = next, addr != end && pte_none(*pte));\r\n}\r\nstatic void __init kasan_early_pmd_populate(pud_t *pud,\r\nunsigned long addr,\r\nunsigned long end)\r\n{\r\npmd_t *pmd;\r\nunsigned long next;\r\nif (pud_none(*pud))\r\n__pud_populate(pud, __pa_symbol(kasan_zero_pmd), PMD_TYPE_TABLE);\r\npmd = pmd_offset_kimg(pud, addr);\r\ndo {\r\nnext = pmd_addr_end(addr, end);\r\nkasan_early_pte_populate(pmd, addr, next);\r\n} while (pmd++, addr = next, addr != end && pmd_none(*pmd));\r\n}\r\nstatic void __init kasan_early_pud_populate(pgd_t *pgd,\r\nunsigned long addr,\r\nunsigned long end)\r\n{\r\npud_t *pud;\r\nunsigned long next;\r\nif (pgd_none(*pgd))\r\n__pgd_populate(pgd, __pa_symbol(kasan_zero_pud), PUD_TYPE_TABLE);\r\npud = pud_offset_kimg(pgd, addr);\r\ndo {\r\nnext = pud_addr_end(addr, end);\r\nkasan_early_pmd_populate(pud, addr, next);\r\n} while (pud++, addr = next, addr != end && pud_none(*pud));\r\n}\r\nstatic void __init kasan_map_early_shadow(void)\r\n{\r\nunsigned long addr = KASAN_SHADOW_START;\r\nunsigned long end = KASAN_SHADOW_END;\r\nunsigned long next;\r\npgd_t *pgd;\r\npgd = pgd_offset_k(addr);\r\ndo {\r\nnext = pgd_addr_end(addr, end);\r\nkasan_early_pud_populate(pgd, addr, next);\r\n} while (pgd++, addr = next, addr != end);\r\n}\r\nasmlinkage void __init kasan_early_init(void)\r\n{\r\nBUILD_BUG_ON(KASAN_SHADOW_OFFSET != KASAN_SHADOW_END - (1UL << 61));\r\nBUILD_BUG_ON(!IS_ALIGNED(KASAN_SHADOW_START, PGDIR_SIZE));\r\nBUILD_BUG_ON(!IS_ALIGNED(KASAN_SHADOW_END, PGDIR_SIZE));\r\nkasan_map_early_shadow();\r\n}\r\nvoid __init kasan_copy_shadow(pgd_t *pgdir)\r\n{\r\npgd_t *pgd, *pgd_new, *pgd_end;\r\npgd = pgd_offset_k(KASAN_SHADOW_START);\r\npgd_end = pgd_offset_k(KASAN_SHADOW_END);\r\npgd_new = pgd_offset_raw(pgdir, KASAN_SHADOW_START);\r\ndo {\r\nset_pgd(pgd_new, *pgd);\r\n} while (pgd++, pgd_new++, pgd != pgd_end);\r\n}\r\nstatic void __init clear_pgds(unsigned long start,\r\nunsigned long end)\r\n{\r\nfor (; start < end; start += PGDIR_SIZE)\r\nset_pgd(pgd_offset_k(start), __pgd(0));\r\n}\r\nvoid __init kasan_init(void)\r\n{\r\nu64 kimg_shadow_start, kimg_shadow_end;\r\nu64 mod_shadow_start, mod_shadow_end;\r\nstruct memblock_region *reg;\r\nint i;\r\nkimg_shadow_start = (u64)kasan_mem_to_shadow(_text);\r\nkimg_shadow_end = (u64)kasan_mem_to_shadow(_end);\r\nmod_shadow_start = (u64)kasan_mem_to_shadow((void *)MODULES_VADDR);\r\nmod_shadow_end = (u64)kasan_mem_to_shadow((void *)MODULES_END);\r\nmemcpy(tmp_pg_dir, swapper_pg_dir, sizeof(tmp_pg_dir));\r\ndsb(ishst);\r\ncpu_replace_ttbr1(lm_alias(tmp_pg_dir));\r\nclear_pgds(KASAN_SHADOW_START, KASAN_SHADOW_END);\r\nvmemmap_populate(kimg_shadow_start, kimg_shadow_end,\r\npfn_to_nid(virt_to_pfn(lm_alias(_text))));\r\nkimg_shadow_start = round_down(kimg_shadow_start, SWAPPER_BLOCK_SIZE);\r\nkimg_shadow_end = round_up(kimg_shadow_end, SWAPPER_BLOCK_SIZE);\r\nkasan_populate_zero_shadow((void *)KASAN_SHADOW_START,\r\n(void *)mod_shadow_start);\r\nkasan_populate_zero_shadow((void *)kimg_shadow_end,\r\nkasan_mem_to_shadow((void *)PAGE_OFFSET));\r\nif (kimg_shadow_start > mod_shadow_end)\r\nkasan_populate_zero_shadow((void *)mod_shadow_end,\r\n(void *)kimg_shadow_start);\r\nfor_each_memblock(memory, reg) {\r\nvoid *start = (void *)__phys_to_virt(reg->base);\r\nvoid *end = (void *)__phys_to_virt(reg->base + reg->size);\r\nif (start >= end)\r\nbreak;\r\nvmemmap_populate((unsigned long)kasan_mem_to_shadow(start),\r\n(unsigned long)kasan_mem_to_shadow(end) + 1,\r\npfn_to_nid(virt_to_pfn(start)));\r\n}\r\nfor (i = 0; i < PTRS_PER_PTE; i++)\r\nset_pte(&kasan_zero_pte[i],\r\npfn_pte(sym_to_pfn(kasan_zero_page), PAGE_KERNEL_RO));\r\nmemset(kasan_zero_page, 0, PAGE_SIZE);\r\ncpu_replace_ttbr1(lm_alias(swapper_pg_dir));\r\ninit_task.kasan_depth = 0;\r\npr_info("KernelAddressSanitizer initialized\n");\r\n}

static void ivtv_alsa_announce_pcm_data(struct snd_ivtv_card *itvsc,\r\nu8 *pcm_data,\r\nsize_t num_bytes)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_pcm_runtime *runtime;\r\nunsigned int oldptr;\r\nunsigned int stride;\r\nint period_elapsed = 0;\r\nint length;\r\ndprintk("ivtv alsa announce ptr=%p data=%p num_bytes=%zu\n", itvsc,\r\npcm_data, num_bytes);\r\nsubstream = itvsc->capture_pcm_substream;\r\nif (substream == NULL) {\r\ndprintk("substream was NULL\n");\r\nreturn;\r\n}\r\nruntime = substream->runtime;\r\nif (runtime == NULL) {\r\ndprintk("runtime was NULL\n");\r\nreturn;\r\n}\r\nstride = runtime->frame_bits >> 3;\r\nif (stride == 0) {\r\ndprintk("stride is zero\n");\r\nreturn;\r\n}\r\nlength = num_bytes / stride;\r\nif (length == 0) {\r\ndprintk("%s: length was zero\n", __func__);\r\nreturn;\r\n}\r\nif (runtime->dma_area == NULL) {\r\ndprintk("dma area was NULL - ignoring\n");\r\nreturn;\r\n}\r\noldptr = itvsc->hwptr_done_capture;\r\nif (oldptr + length >= runtime->buffer_size) {\r\nunsigned int cnt =\r\nruntime->buffer_size - oldptr;\r\nmemcpy(runtime->dma_area + oldptr * stride, pcm_data,\r\ncnt * stride);\r\nmemcpy(runtime->dma_area, pcm_data + cnt * stride,\r\nlength * stride - cnt * stride);\r\n} else {\r\nmemcpy(runtime->dma_area + oldptr * stride, pcm_data,\r\nlength * stride);\r\n}\r\nsnd_pcm_stream_lock(substream);\r\nitvsc->hwptr_done_capture += length;\r\nif (itvsc->hwptr_done_capture >=\r\nruntime->buffer_size)\r\nitvsc->hwptr_done_capture -=\r\nruntime->buffer_size;\r\nitvsc->capture_transfer_done += length;\r\nif (itvsc->capture_transfer_done >=\r\nruntime->period_size) {\r\nitvsc->capture_transfer_done -=\r\nruntime->period_size;\r\nperiod_elapsed = 1;\r\n}\r\nsnd_pcm_stream_unlock(substream);\r\nif (period_elapsed)\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\nstatic int snd_ivtv_pcm_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct v4l2_device *v4l2_dev = itvsc->v4l2_dev;\r\nstruct ivtv *itv = to_ivtv(v4l2_dev);\r\nstruct ivtv_stream *s;\r\nstruct ivtv_open_id item;\r\nint ret;\r\nsnd_ivtv_lock(itvsc);\r\nif (ivtv_init_on_first_open(itv)) {\r\nsnd_ivtv_unlock(itvsc);\r\nreturn -ENXIO;\r\n}\r\ns = &itv->streams[IVTV_ENC_STREAM_TYPE_PCM];\r\nv4l2_fh_init(&item.fh, &s->vdev);\r\nitem.itv = itv;\r\nitem.type = s->type;\r\nif (ivtv_claim_stream(&item, item.type)) {\r\nv4l2_fh_exit(&item.fh);\r\nsnd_ivtv_unlock(itvsc);\r\nreturn -EBUSY;\r\n}\r\nif (test_bit(IVTV_F_S_STREAMOFF, &s->s_flags) ||\r\ntest_and_set_bit(IVTV_F_S_STREAMING, &s->s_flags)) {\r\nsnd_ivtv_unlock(itvsc);\r\nreturn 0;\r\n}\r\nruntime->hw = snd_ivtv_hw_capture;\r\nsnd_pcm_hw_constraint_integer(runtime, SNDRV_PCM_HW_PARAM_PERIODS);\r\nitvsc->capture_pcm_substream = substream;\r\nruntime->private_data = itv;\r\nitv->pcm_announce_callback = ivtv_alsa_announce_pcm_data;\r\nset_bit(IVTV_F_S_STREAMING, &s->s_flags);\r\nret = ivtv_start_v4l2_encode_stream(s);\r\nsnd_ivtv_unlock(itvsc);\r\nreturn ret;\r\n}\r\nstatic int snd_ivtv_pcm_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nstruct v4l2_device *v4l2_dev = itvsc->v4l2_dev;\r\nstruct ivtv *itv = to_ivtv(v4l2_dev);\r\nstruct ivtv_stream *s;\r\nsnd_ivtv_lock(itvsc);\r\ns = &itv->streams[IVTV_ENC_STREAM_TYPE_PCM];\r\nivtv_stop_v4l2_encode_stream(s, 0);\r\nclear_bit(IVTV_F_S_STREAMING, &s->s_flags);\r\nivtv_release_stream(s);\r\nitv->pcm_announce_callback = NULL;\r\nsnd_ivtv_unlock(itvsc);\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_pcm_ioctl(struct snd_pcm_substream *substream,\r\nunsigned int cmd, void *arg)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nint ret;\r\nsnd_ivtv_lock(itvsc);\r\nret = snd_pcm_lib_ioctl(substream, cmd, arg);\r\nsnd_ivtv_unlock(itvsc);\r\nreturn ret;\r\n}\r\nstatic int snd_pcm_alloc_vmalloc_buffer(struct snd_pcm_substream *subs,\r\nsize_t size)\r\n{\r\nstruct snd_pcm_runtime *runtime = subs->runtime;\r\ndprintk("Allocating vbuffer\n");\r\nif (runtime->dma_area) {\r\nif (runtime->dma_bytes > size)\r\nreturn 0;\r\nvfree(runtime->dma_area);\r\n}\r\nruntime->dma_area = vmalloc(size);\r\nif (!runtime->dma_area)\r\nreturn -ENOMEM;\r\nruntime->dma_bytes = size;\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\ndprintk("%s called\n", __func__);\r\nreturn snd_pcm_alloc_vmalloc_buffer(substream,\r\nparams_buffer_bytes(params));\r\n}\r\nstatic int snd_ivtv_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nunsigned long flags;\r\nspin_lock_irqsave(&itvsc->slock, flags);\r\nif (substream->runtime->dma_area) {\r\ndprintk("freeing pcm capture region\n");\r\nvfree(substream->runtime->dma_area);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nspin_unlock_irqrestore(&itvsc->slock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nitvsc->hwptr_done_capture = 0;\r\nitvsc->capture_transfer_done = 0;\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nreturn 0;\r\n}\r\nstatic\r\nsnd_pcm_uframes_t snd_ivtv_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_pcm_uframes_t hwptr_done;\r\nstruct snd_ivtv_card *itvsc = snd_pcm_substream_chip(substream);\r\nspin_lock_irqsave(&itvsc->slock, flags);\r\nhwptr_done = itvsc->hwptr_done_capture;\r\nspin_unlock_irqrestore(&itvsc->slock, flags);\r\nreturn hwptr_done;\r\n}\r\nstatic struct page *snd_pcm_get_vmalloc_page(struct snd_pcm_substream *subs,\r\nunsigned long offset)\r\n{\r\nvoid *pageptr = subs->runtime->dma_area + offset;\r\nreturn vmalloc_to_page(pageptr);\r\n}\r\nint snd_ivtv_pcm_create(struct snd_ivtv_card *itvsc)\r\n{\r\nstruct snd_pcm *sp;\r\nstruct snd_card *sc = itvsc->sc;\r\nstruct v4l2_device *v4l2_dev = itvsc->v4l2_dev;\r\nstruct ivtv *itv = to_ivtv(v4l2_dev);\r\nint ret;\r\nret = snd_pcm_new(sc, "CX2341[56] PCM",\r\n0,\r\n0,\r\n1,\r\n&sp);\r\nif (ret) {\r\nIVTV_ALSA_ERR("%s: snd_ivtv_pcm_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit;\r\n}\r\nspin_lock_init(&itvsc->slock);\r\nsnd_pcm_set_ops(sp, SNDRV_PCM_STREAM_CAPTURE,\r\n&snd_ivtv_pcm_capture_ops);\r\nsp->info_flags = 0;\r\nsp->private_data = itvsc;\r\nstrlcpy(sp->name, itv->card_name, sizeof(sp->name));\r\nreturn 0;\r\nerr_exit:\r\nreturn ret;\r\n}

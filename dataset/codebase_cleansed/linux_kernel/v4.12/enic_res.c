int enic_get_vnic_config(struct enic *enic)\r\n{\r\nstruct vnic_enet_config *c = &enic->config;\r\nint err;\r\nerr = vnic_dev_get_mac_addr(enic->vdev, enic->mac_addr);\r\nif (err) {\r\ndev_err(enic_get_dev(enic),\r\n"Error getting MAC addr, %d\n", err);\r\nreturn err;\r\n}\r\n#define GET_CONFIG(m) \\r\ndo { \\r\nerr = vnic_dev_spec(enic->vdev, \\r\noffsetof(struct vnic_enet_config, m), \\r\nsizeof(c->m), &c->m); \\r\nif (err) { \\r\ndev_err(enic_get_dev(enic), \\r\n"Error getting %s, %d\n", #m, err); \\r\nreturn err; \\r\n} \\r\n} while (0)\r\nGET_CONFIG(flags);\r\nGET_CONFIG(wq_desc_count);\r\nGET_CONFIG(rq_desc_count);\r\nGET_CONFIG(mtu);\r\nGET_CONFIG(intr_timer_type);\r\nGET_CONFIG(intr_mode);\r\nGET_CONFIG(intr_timer_usec);\r\nGET_CONFIG(loop_tag);\r\nGET_CONFIG(num_arfs);\r\nc->wq_desc_count =\r\nmin_t(u32, ENIC_MAX_WQ_DESCS,\r\nmax_t(u32, ENIC_MIN_WQ_DESCS,\r\nc->wq_desc_count));\r\nc->wq_desc_count &= 0xffffffe0;\r\nc->rq_desc_count =\r\nmin_t(u32, ENIC_MAX_RQ_DESCS,\r\nmax_t(u32, ENIC_MIN_RQ_DESCS,\r\nc->rq_desc_count));\r\nc->rq_desc_count &= 0xffffffe0;\r\nif (c->mtu == 0)\r\nc->mtu = 1500;\r\nc->mtu = min_t(u16, ENIC_MAX_MTU,\r\nmax_t(u16, ENIC_MIN_MTU,\r\nc->mtu));\r\nc->intr_timer_usec = min_t(u32, c->intr_timer_usec,\r\nvnic_dev_get_intr_coal_timer_max(enic->vdev));\r\ndev_info(enic_get_dev(enic),\r\n"vNIC MAC addr %pM wq/rq %d/%d mtu %d\n",\r\nenic->mac_addr, c->wq_desc_count, c->rq_desc_count, c->mtu);\r\ndev_info(enic_get_dev(enic), "vNIC csum tx/rx %s/%s "\r\n"tso/lro %s/%s rss %s intr mode %s type %s timer %d usec "\r\n"loopback tag 0x%04x\n",\r\nENIC_SETTING(enic, TXCSUM) ? "yes" : "no",\r\nENIC_SETTING(enic, RXCSUM) ? "yes" : "no",\r\nENIC_SETTING(enic, TSO) ? "yes" : "no",\r\nENIC_SETTING(enic, LRO) ? "yes" : "no",\r\nENIC_SETTING(enic, RSS) ? "yes" : "no",\r\nc->intr_mode == VENET_INTR_MODE_INTX ? "INTx" :\r\nc->intr_mode == VENET_INTR_MODE_MSI ? "MSI" :\r\nc->intr_mode == VENET_INTR_MODE_ANY ? "any" :\r\n"unknown",\r\nc->intr_timer_type == VENET_INTR_TYPE_MIN ? "min" :\r\nc->intr_timer_type == VENET_INTR_TYPE_IDLE ? "idle" :\r\n"unknown",\r\nc->intr_timer_usec,\r\nc->loop_tag);\r\nreturn 0;\r\n}\r\nint enic_add_vlan(struct enic *enic, u16 vlanid)\r\n{\r\nu64 a0 = vlanid, a1 = 0;\r\nint wait = 1000;\r\nint err;\r\nerr = vnic_dev_cmd(enic->vdev, CMD_VLAN_ADD, &a0, &a1, wait);\r\nif (err)\r\ndev_err(enic_get_dev(enic), "Can't add vlan id, %d\n", err);\r\nreturn err;\r\n}\r\nint enic_del_vlan(struct enic *enic, u16 vlanid)\r\n{\r\nu64 a0 = vlanid, a1 = 0;\r\nint wait = 1000;\r\nint err;\r\nerr = vnic_dev_cmd(enic->vdev, CMD_VLAN_DEL, &a0, &a1, wait);\r\nif (err)\r\ndev_err(enic_get_dev(enic), "Can't delete vlan id, %d\n", err);\r\nreturn err;\r\n}\r\nint enic_set_nic_cfg(struct enic *enic, u8 rss_default_cpu, u8 rss_hash_type,\r\nu8 rss_hash_bits, u8 rss_base_cpu, u8 rss_enable, u8 tso_ipid_split_en,\r\nu8 ig_vlan_strip_en)\r\n{\r\nu64 a0, a1;\r\nu32 nic_cfg;\r\nint wait = 1000;\r\nvnic_set_nic_cfg(&nic_cfg, rss_default_cpu,\r\nrss_hash_type, rss_hash_bits, rss_base_cpu,\r\nrss_enable, tso_ipid_split_en, ig_vlan_strip_en);\r\na0 = nic_cfg;\r\na1 = 0;\r\nreturn vnic_dev_cmd(enic->vdev, CMD_NIC_CFG, &a0, &a1, wait);\r\n}\r\nint enic_set_rss_key(struct enic *enic, dma_addr_t key_pa, u64 len)\r\n{\r\nu64 a0 = (u64)key_pa, a1 = len;\r\nint wait = 1000;\r\nreturn vnic_dev_cmd(enic->vdev, CMD_RSS_KEY, &a0, &a1, wait);\r\n}\r\nint enic_set_rss_cpu(struct enic *enic, dma_addr_t cpu_pa, u64 len)\r\n{\r\nu64 a0 = (u64)cpu_pa, a1 = len;\r\nint wait = 1000;\r\nreturn vnic_dev_cmd(enic->vdev, CMD_RSS_CPU, &a0, &a1, wait);\r\n}\r\nvoid enic_free_vnic_resources(struct enic *enic)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < enic->wq_count; i++)\r\nvnic_wq_free(&enic->wq[i]);\r\nfor (i = 0; i < enic->rq_count; i++)\r\nvnic_rq_free(&enic->rq[i]);\r\nfor (i = 0; i < enic->cq_count; i++)\r\nvnic_cq_free(&enic->cq[i]);\r\nfor (i = 0; i < enic->intr_count; i++)\r\nvnic_intr_free(&enic->intr[i]);\r\n}\r\nvoid enic_get_res_counts(struct enic *enic)\r\n{\r\nenic->wq_count = vnic_dev_get_res_count(enic->vdev, RES_TYPE_WQ);\r\nenic->rq_count = vnic_dev_get_res_count(enic->vdev, RES_TYPE_RQ);\r\nenic->cq_count = vnic_dev_get_res_count(enic->vdev, RES_TYPE_CQ);\r\nenic->intr_count = vnic_dev_get_res_count(enic->vdev,\r\nRES_TYPE_INTR_CTRL);\r\ndev_info(enic_get_dev(enic),\r\n"vNIC resources avail: wq %d rq %d cq %d intr %d\n",\r\nenic->wq_count, enic->rq_count,\r\nenic->cq_count, enic->intr_count);\r\n}\r\nvoid enic_init_vnic_resources(struct enic *enic)\r\n{\r\nenum vnic_dev_intr_mode intr_mode;\r\nunsigned int mask_on_assertion;\r\nunsigned int interrupt_offset;\r\nunsigned int error_interrupt_enable;\r\nunsigned int error_interrupt_offset;\r\nunsigned int cq_index;\r\nunsigned int i;\r\nintr_mode = vnic_dev_get_intr_mode(enic->vdev);\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_INTX:\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nerror_interrupt_enable = 1;\r\nerror_interrupt_offset = enic->intr_count - 2;\r\nbreak;\r\ndefault:\r\nerror_interrupt_enable = 0;\r\nerror_interrupt_offset = 0;\r\nbreak;\r\n}\r\nfor (i = 0; i < enic->rq_count; i++) {\r\ncq_index = i;\r\nvnic_rq_init(&enic->rq[i],\r\ncq_index,\r\nerror_interrupt_enable,\r\nerror_interrupt_offset);\r\n}\r\nfor (i = 0; i < enic->wq_count; i++) {\r\ncq_index = enic->rq_count + i;\r\nvnic_wq_init(&enic->wq[i],\r\ncq_index,\r\nerror_interrupt_enable,\r\nerror_interrupt_offset);\r\n}\r\nfor (i = 0; i < enic->cq_count; i++) {\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\ninterrupt_offset = i;\r\nbreak;\r\ndefault:\r\ninterrupt_offset = 0;\r\nbreak;\r\n}\r\nvnic_cq_init(&enic->cq[i],\r\n0 ,\r\n1 ,\r\n0 ,\r\n0 ,\r\n1 ,\r\n1 ,\r\n1 ,\r\n0 ,\r\ninterrupt_offset,\r\n0 );\r\n}\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nmask_on_assertion = 1;\r\nbreak;\r\ndefault:\r\nmask_on_assertion = 0;\r\nbreak;\r\n}\r\nfor (i = 0; i < enic->intr_count; i++) {\r\nvnic_intr_init(&enic->intr[i],\r\nenic->config.intr_timer_usec,\r\nenic->config.intr_timer_type,\r\nmask_on_assertion);\r\n}\r\n}\r\nint enic_alloc_vnic_resources(struct enic *enic)\r\n{\r\nenum vnic_dev_intr_mode intr_mode;\r\nunsigned int i;\r\nint err;\r\nintr_mode = vnic_dev_get_intr_mode(enic->vdev);\r\ndev_info(enic_get_dev(enic), "vNIC resources used: "\r\n"wq %d rq %d cq %d intr %d intr mode %s\n",\r\nenic->wq_count, enic->rq_count,\r\nenic->cq_count, enic->intr_count,\r\nintr_mode == VNIC_DEV_INTR_MODE_INTX ? "legacy PCI INTx" :\r\nintr_mode == VNIC_DEV_INTR_MODE_MSI ? "MSI" :\r\nintr_mode == VNIC_DEV_INTR_MODE_MSIX ? "MSI-X" :\r\n"unknown");\r\nfor (i = 0; i < enic->wq_count; i++) {\r\nerr = vnic_wq_alloc(enic->vdev, &enic->wq[i], i,\r\nenic->config.wq_desc_count,\r\nsizeof(struct wq_enet_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < enic->rq_count; i++) {\r\nerr = vnic_rq_alloc(enic->vdev, &enic->rq[i], i,\r\nenic->config.rq_desc_count,\r\nsizeof(struct rq_enet_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < enic->cq_count; i++) {\r\nif (i < enic->rq_count)\r\nerr = vnic_cq_alloc(enic->vdev, &enic->cq[i], i,\r\nenic->config.rq_desc_count,\r\nsizeof(struct cq_enet_rq_desc));\r\nelse\r\nerr = vnic_cq_alloc(enic->vdev, &enic->cq[i], i,\r\nenic->config.wq_desc_count,\r\nsizeof(struct cq_enet_wq_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < enic->intr_count; i++) {\r\nerr = vnic_intr_alloc(enic->vdev, &enic->intr[i], i);\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nenic->legacy_pba = vnic_dev_get_res(enic->vdev,\r\nRES_TYPE_INTR_PBA_LEGACY, 0);\r\nif (!enic->legacy_pba && intr_mode == VNIC_DEV_INTR_MODE_INTX) {\r\ndev_err(enic_get_dev(enic),\r\n"Failed to hook legacy pba resource\n");\r\nerr = -ENODEV;\r\ngoto err_out_cleanup;\r\n}\r\nreturn 0;\r\nerr_out_cleanup:\r\nenic_free_vnic_resources(enic);\r\nreturn err;\r\n}

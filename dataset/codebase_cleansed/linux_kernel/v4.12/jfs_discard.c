void jfs_issue_discard(struct inode *ip, u64 blkno, u64 nblocks)\r\n{\r\nstruct super_block *sb = ip->i_sb;\r\nint r = 0;\r\nr = sb_issue_discard(sb, blkno, nblocks, GFP_NOFS, 0);\r\nif (unlikely(r != 0)) {\r\njfs_err("JFS: sb_issue_discard(%p, %llu, %llu, GFP_NOFS, 0) = %d => failed!",\r\nsb, (unsigned long long)blkno,\r\n(unsigned long long)nblocks, r);\r\n}\r\njfs_info("JFS: sb_issue_discard(%p, %llu, %llu, GFP_NOFS, 0) = %d",\r\nsb, (unsigned long long)blkno,\r\n(unsigned long long)nblocks, r);\r\nreturn;\r\n}\r\nint jfs_ioc_trim(struct inode *ip, struct fstrim_range *range)\r\n{\r\nstruct inode *ipbmap = JFS_SBI(ip->i_sb)->ipbmap;\r\nstruct bmap *bmp = JFS_SBI(ip->i_sb)->bmap;\r\nstruct super_block *sb = ipbmap->i_sb;\r\nint agno, agno_end;\r\nu64 start, end, minlen;\r\nu64 trimmed = 0;\r\nstart = range->start >> sb->s_blocksize_bits;\r\nend = start + (range->len >> sb->s_blocksize_bits) - 1;\r\nminlen = range->minlen >> sb->s_blocksize_bits;\r\nif (minlen == 0)\r\nminlen = 1;\r\nif (minlen > bmp->db_agsize ||\r\nstart >= bmp->db_mapsize ||\r\nrange->len < sb->s_blocksize)\r\nreturn -EINVAL;\r\nif (end >= bmp->db_mapsize)\r\nend = bmp->db_mapsize - 1;\r\nagno = BLKTOAG(start, JFS_SBI(ip->i_sb));\r\nagno_end = BLKTOAG(end, JFS_SBI(ip->i_sb));\r\nwhile (agno <= agno_end) {\r\ntrimmed += dbDiscardAG(ip, agno, minlen);\r\nagno++;\r\n}\r\nrange->len = trimmed << sb->s_blocksize_bits;\r\nreturn 0;\r\n}

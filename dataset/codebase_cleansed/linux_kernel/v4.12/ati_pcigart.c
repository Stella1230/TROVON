static int drm_ati_alloc_pcigart_table(struct drm_device *dev,\r\nstruct drm_ati_pcigart_info *gart_info)\r\n{\r\ngart_info->table_handle = drm_pci_alloc(dev, gart_info->table_size,\r\nPAGE_SIZE);\r\nif (gart_info->table_handle == NULL)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void drm_ati_free_pcigart_table(struct drm_device *dev,\r\nstruct drm_ati_pcigart_info *gart_info)\r\n{\r\ndrm_pci_free(dev, gart_info->table_handle);\r\ngart_info->table_handle = NULL;\r\n}\r\nint drm_ati_pcigart_cleanup(struct drm_device *dev, struct drm_ati_pcigart_info *gart_info)\r\n{\r\nstruct drm_sg_mem *entry = dev->sg;\r\nunsigned long pages;\r\nint i;\r\nint max_pages;\r\nif (!entry) {\r\nDRM_ERROR("no scatter/gather memory!\n");\r\nreturn 0;\r\n}\r\nif (gart_info->bus_addr) {\r\nmax_pages = (gart_info->table_size / sizeof(u32));\r\npages = (entry->pages <= max_pages)\r\n? entry->pages : max_pages;\r\nfor (i = 0; i < pages; i++) {\r\nif (!entry->busaddr[i])\r\nbreak;\r\npci_unmap_page(dev->pdev, entry->busaddr[i],\r\nPAGE_SIZE, PCI_DMA_BIDIRECTIONAL);\r\n}\r\nif (gart_info->gart_table_location == DRM_ATI_GART_MAIN)\r\ngart_info->bus_addr = 0;\r\n}\r\nif (gart_info->gart_table_location == DRM_ATI_GART_MAIN &&\r\ngart_info->table_handle) {\r\ndrm_ati_free_pcigart_table(dev, gart_info);\r\n}\r\nreturn 1;\r\n}\r\nint drm_ati_pcigart_init(struct drm_device *dev, struct drm_ati_pcigart_info *gart_info)\r\n{\r\nstruct drm_local_map *map = &gart_info->mapping;\r\nstruct drm_sg_mem *entry = dev->sg;\r\nvoid *address = NULL;\r\nunsigned long pages;\r\nu32 *pci_gart = NULL, page_base, gart_idx;\r\ndma_addr_t bus_address = 0;\r\nint i, j, ret = 0;\r\nint max_ati_pages, max_real_pages;\r\nif (!entry) {\r\nDRM_ERROR("no scatter/gather memory!\n");\r\ngoto done;\r\n}\r\nif (gart_info->gart_table_location == DRM_ATI_GART_MAIN) {\r\nDRM_DEBUG("PCI: no table in VRAM: using normal RAM\n");\r\nif (pci_set_dma_mask(dev->pdev, gart_info->table_mask)) {\r\nDRM_ERROR("fail to set dma mask to 0x%Lx\n",\r\n(unsigned long long)gart_info->table_mask);\r\nret = 1;\r\ngoto done;\r\n}\r\nret = drm_ati_alloc_pcigart_table(dev, gart_info);\r\nif (ret) {\r\nDRM_ERROR("cannot allocate PCI GART page!\n");\r\ngoto done;\r\n}\r\npci_gart = gart_info->table_handle->vaddr;\r\naddress = gart_info->table_handle->vaddr;\r\nbus_address = gart_info->table_handle->busaddr;\r\n} else {\r\naddress = gart_info->addr;\r\nbus_address = gart_info->bus_addr;\r\nDRM_DEBUG("PCI: Gart Table: VRAM %08LX mapped at %08lX\n",\r\n(unsigned long long)bus_address,\r\n(unsigned long)address);\r\n}\r\nmax_ati_pages = (gart_info->table_size / sizeof(u32));\r\nmax_real_pages = max_ati_pages / (PAGE_SIZE / ATI_PCIGART_PAGE_SIZE);\r\npages = (entry->pages <= max_real_pages)\r\n? entry->pages : max_real_pages;\r\nif (gart_info->gart_table_location == DRM_ATI_GART_MAIN) {\r\nmemset(pci_gart, 0, max_ati_pages * sizeof(u32));\r\n} else {\r\nmemset_io((void __iomem *)map->handle, 0, max_ati_pages * sizeof(u32));\r\n}\r\ngart_idx = 0;\r\nfor (i = 0; i < pages; i++) {\r\nentry->busaddr[i] = pci_map_page(dev->pdev, entry->pagelist[i],\r\n0, PAGE_SIZE, PCI_DMA_BIDIRECTIONAL);\r\nif (pci_dma_mapping_error(dev->pdev, entry->busaddr[i])) {\r\nDRM_ERROR("unable to map PCIGART pages!\n");\r\ndrm_ati_pcigart_cleanup(dev, gart_info);\r\naddress = NULL;\r\nbus_address = 0;\r\ngoto done;\r\n}\r\npage_base = (u32) entry->busaddr[i];\r\nfor (j = 0; j < (PAGE_SIZE / ATI_PCIGART_PAGE_SIZE); j++) {\r\nu32 val;\r\nswitch(gart_info->gart_reg_if) {\r\ncase DRM_ATI_GART_IGP:\r\nval = page_base | 0xc;\r\nbreak;\r\ncase DRM_ATI_GART_PCIE:\r\nval = (page_base >> 8) | 0xc;\r\nbreak;\r\ndefault:\r\ncase DRM_ATI_GART_PCI:\r\nval = page_base;\r\nbreak;\r\n}\r\nif (gart_info->gart_table_location ==\r\nDRM_ATI_GART_MAIN)\r\npci_gart[gart_idx] = cpu_to_le32(val);\r\nelse\r\nDRM_WRITE32(map, gart_idx * sizeof(u32), val);\r\ngart_idx++;\r\npage_base += ATI_PCIGART_PAGE_SIZE;\r\n}\r\n}\r\nret = 1;\r\n#if defined(__i386__) || defined(__x86_64__)\r\nwbinvd();\r\n#else\r\nmb();\r\n#endif\r\ndone:\r\ngart_info->addr = address;\r\ngart_info->bus_addr = bus_address;\r\nreturn ret;\r\n}

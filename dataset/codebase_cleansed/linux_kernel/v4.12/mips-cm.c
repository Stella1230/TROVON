phys_addr_t __mips_cm_phys_base(void)\r\n{\r\nu32 config3 = read_c0_config3();\r\nunsigned long cmgcr;\r\nif (!(config3 & MIPS_CONF3_CMGCR))\r\nreturn 0;\r\ncmgcr = read_c0_cmgcrbase();\r\nreturn (cmgcr & MIPS_CMGCRF_BASE) << (36 - 32);\r\n}\r\nphys_addr_t __mips_cm_l2sync_phys_base(void)\r\n{\r\nu32 base_reg;\r\nbase_reg = read_gcr_l2_only_sync_base();\r\nif (base_reg & CM_GCR_L2_ONLY_SYNC_BASE_SYNCEN_MSK)\r\nreturn base_reg & CM_GCR_L2_ONLY_SYNC_BASE_SYNCBASE_MSK;\r\nreturn mips_cm_phys_base() + MIPS_CM_GCR_SIZE;\r\n}\r\nstatic void mips_cm_probe_l2sync(void)\r\n{\r\nunsigned major_rev;\r\nphys_addr_t addr;\r\nmajor_rev = (read_gcr_rev() & CM_GCR_REV_MAJOR_MSK) >>\r\nCM_GCR_REV_MAJOR_SHF;\r\nif (major_rev < 6)\r\nreturn;\r\naddr = mips_cm_l2sync_phys_base();\r\nBUG_ON((addr & CM_GCR_L2_ONLY_SYNC_BASE_SYNCBASE_MSK) != addr);\r\nif (!addr)\r\nreturn;\r\nwrite_gcr_l2_only_sync_base(addr | CM_GCR_L2_ONLY_SYNC_BASE_SYNCEN_MSK);\r\nmips_cm_l2sync_base = ioremap_nocache(addr, MIPS_CM_L2SYNC_SIZE);\r\n}\r\nint mips_cm_probe(void)\r\n{\r\nphys_addr_t addr;\r\nu32 base_reg;\r\nunsigned cpu;\r\nif (mips_cm_base)\r\nreturn 0;\r\naddr = mips_cm_phys_base();\r\nBUG_ON((addr & CM_GCR_BASE_GCRBASE_MSK) != addr);\r\nif (!addr)\r\nreturn -ENODEV;\r\nmips_cm_base = ioremap_nocache(addr, MIPS_CM_GCR_SIZE);\r\nif (!mips_cm_base)\r\nreturn -ENXIO;\r\nbase_reg = read_gcr_base();\r\nif ((base_reg & CM_GCR_BASE_GCRBASE_MSK) != addr) {\r\npr_err("GCRs appear to have been moved (expected them at 0x%08lx)!\n",\r\n(unsigned long)addr);\r\nmips_cm_base = NULL;\r\nreturn -ENODEV;\r\n}\r\nbase_reg &= ~CM_GCR_BASE_CMDEFTGT_MSK;\r\nbase_reg |= CM_GCR_BASE_CMDEFTGT_MEM;\r\nwrite_gcr_base(base_reg);\r\nwrite_gcr_reg0_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg0_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg1_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg1_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg2_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg2_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg3_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg3_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nmips_cm_probe_l2sync();\r\nmips_cm_is64 = IS_ENABLED(CONFIG_64BIT) && (mips_cm_revision() >= CM_REV_CM3);\r\nfor_each_possible_cpu(cpu)\r\nspin_lock_init(&per_cpu(cm_core_lock, cpu));\r\nreturn 0;\r\n}\r\nvoid mips_cm_lock_other(unsigned int core, unsigned int vp)\r\n{\r\nunsigned curr_core;\r\nu32 val;\r\npreempt_disable();\r\ncurr_core = current_cpu_data.core;\r\nspin_lock_irqsave(&per_cpu(cm_core_lock, curr_core),\r\nper_cpu(cm_core_lock_flags, curr_core));\r\nif (mips_cm_revision() >= CM_REV_CM3) {\r\nval = core << CM3_GCR_Cx_OTHER_CORE_SHF;\r\nval |= vp << CM3_GCR_Cx_OTHER_VP_SHF;\r\n} else {\r\nBUG_ON(vp != 0);\r\nval = core << CM_GCR_Cx_OTHER_CORENUM_SHF;\r\n}\r\nwrite_gcr_cl_other(val);\r\nmb();\r\n}\r\nvoid mips_cm_unlock_other(void)\r\n{\r\nunsigned curr_core = current_cpu_data.core;\r\nspin_unlock_irqrestore(&per_cpu(cm_core_lock, curr_core),\r\nper_cpu(cm_core_lock_flags, curr_core));\r\npreempt_enable();\r\n}\r\nvoid mips_cm_error_report(void)\r\n{\r\nu64 cm_error, cm_addr, cm_other;\r\nunsigned long revision;\r\nint ocause, cause;\r\nchar buf[256];\r\nif (!mips_cm_present())\r\nreturn;\r\nrevision = mips_cm_revision();\r\nif (revision < CM_REV_CM3) {\r\ncm_error = read_gcr_error_cause();\r\ncm_addr = read_gcr_error_addr();\r\ncm_other = read_gcr_error_mult();\r\ncause = cm_error >> CM_GCR_ERROR_CAUSE_ERRTYPE_SHF;\r\nocause = cm_other >> CM_GCR_ERROR_MULT_ERR2ND_SHF;\r\nif (!cause)\r\nreturn;\r\nif (cause < 16) {\r\nunsigned long cca_bits = (cm_error >> 15) & 7;\r\nunsigned long tr_bits = (cm_error >> 12) & 7;\r\nunsigned long cmd_bits = (cm_error >> 7) & 0x1f;\r\nunsigned long stag_bits = (cm_error >> 3) & 15;\r\nunsigned long sport_bits = (cm_error >> 0) & 7;\r\nsnprintf(buf, sizeof(buf),\r\n"CCA=%lu TR=%s MCmd=%s STag=%lu "\r\n"SPort=%lu\n", cca_bits, cm2_tr[tr_bits],\r\ncm2_cmd[cmd_bits], stag_bits, sport_bits);\r\n} else {\r\nunsigned long c3_bits = (cm_error >> 18) & 7;\r\nunsigned long c2_bits = (cm_error >> 15) & 7;\r\nunsigned long c1_bits = (cm_error >> 12) & 7;\r\nunsigned long c0_bits = (cm_error >> 9) & 7;\r\nunsigned long sc_bit = (cm_error >> 8) & 1;\r\nunsigned long cmd_bits = (cm_error >> 3) & 0x1f;\r\nunsigned long sport_bits = (cm_error >> 0) & 7;\r\nsnprintf(buf, sizeof(buf),\r\n"C3=%s C2=%s C1=%s C0=%s SC=%s "\r\n"MCmd=%s SPort=%lu\n",\r\ncm2_core[c3_bits], cm2_core[c2_bits],\r\ncm2_core[c1_bits], cm2_core[c0_bits],\r\nsc_bit ? "True" : "False",\r\ncm2_cmd[cmd_bits], sport_bits);\r\n}\r\npr_err("CM_ERROR=%08llx %s <%s>\n", cm_error,\r\ncm2_causes[cause], buf);\r\npr_err("CM_ADDR =%08llx\n", cm_addr);\r\npr_err("CM_OTHER=%08llx %s\n", cm_other, cm2_causes[ocause]);\r\n} else {\r\nulong core_id_bits, vp_id_bits, cmd_bits, cmd_group_bits;\r\nulong cm3_cca_bits, mcp_bits, cm3_tr_bits, sched_bit;\r\ncm_error = read64_gcr_error_cause();\r\ncm_addr = read64_gcr_error_addr();\r\ncm_other = read64_gcr_error_mult();\r\ncause = cm_error >> CM3_GCR_ERROR_CAUSE_ERRTYPE_SHF;\r\nocause = cm_other >> CM_GCR_ERROR_MULT_ERR2ND_SHF;\r\nif (!cause)\r\nreturn;\r\ncore_id_bits = (cm_error >> 22) & 0xf;\r\nvp_id_bits = (cm_error >> 18) & 0xf;\r\ncmd_bits = (cm_error >> 14) & 0xf;\r\ncmd_group_bits = (cm_error >> 11) & 0xf;\r\ncm3_cca_bits = (cm_error >> 8) & 7;\r\nmcp_bits = (cm_error >> 5) & 0xf;\r\ncm3_tr_bits = (cm_error >> 1) & 0xf;\r\nsched_bit = cm_error & 0x1;\r\nif (cause == 1 || cause == 3) {\r\nunsigned long tag_ecc = (cm_error >> 57) & 0x1;\r\nunsigned long tag_way_bits = (cm_error >> 29) & 0xffff;\r\nunsigned long dword_bits = (cm_error >> 49) & 0xff;\r\nunsigned long data_way_bits = (cm_error >> 45) & 0xf;\r\nunsigned long data_sets_bits = (cm_error >> 29) & 0xfff;\r\nunsigned long bank_bit = (cm_error >> 28) & 0x1;\r\nsnprintf(buf, sizeof(buf),\r\n"%s ECC Error: Way=%lu (DWORD=%lu, Sets=%lu)"\r\n"Bank=%lu CoreID=%lu VPID=%lu Command=%s"\r\n"Command Group=%s CCA=%lu MCP=%d"\r\n"Transaction type=%s Scheduler=%lu\n",\r\ntag_ecc ? "TAG" : "DATA",\r\ntag_ecc ? (unsigned long)ffs(tag_way_bits) - 1 :\r\ndata_way_bits, bank_bit, dword_bits,\r\ndata_sets_bits,\r\ncore_id_bits, vp_id_bits,\r\ncm3_cmd[cmd_bits],\r\ncm3_cmd_group[cmd_group_bits],\r\ncm3_cca_bits, 1 << mcp_bits,\r\ncm3_tr[cm3_tr_bits], sched_bit);\r\n} else if (cause == 2) {\r\nunsigned long data_error_type = (cm_error >> 41) & 0xfff;\r\nunsigned long data_decode_cmd = (cm_error >> 37) & 0xf;\r\nunsigned long data_decode_group = (cm_error >> 34) & 0x7;\r\nunsigned long data_decode_destination_id = (cm_error >> 28) & 0x3f;\r\nsnprintf(buf, sizeof(buf),\r\n"Decode Request Error: Type=%lu, Command=%lu"\r\n"Command Group=%lu Destination ID=%lu"\r\n"CoreID=%lu VPID=%lu Command=%s"\r\n"Command Group=%s CCA=%lu MCP=%d"\r\n"Transaction type=%s Scheduler=%lu\n",\r\ndata_error_type, data_decode_cmd,\r\ndata_decode_group, data_decode_destination_id,\r\ncore_id_bits, vp_id_bits,\r\ncm3_cmd[cmd_bits],\r\ncm3_cmd_group[cmd_group_bits],\r\ncm3_cca_bits, 1 << mcp_bits,\r\ncm3_tr[cm3_tr_bits], sched_bit);\r\n} else {\r\nbuf[0] = 0;\r\n}\r\npr_err("CM_ERROR=%llx %s <%s>\n", cm_error,\r\ncm3_causes[cause], buf);\r\npr_err("CM_ADDR =%llx\n", cm_addr);\r\npr_err("CM_OTHER=%llx %s\n", cm_other, cm3_causes[ocause]);\r\n}\r\nwrite_gcr_error_cause(0);\r\n}

char *acpi_ns_get_external_pathname(struct acpi_namespace_node *node)\r\n{\r\nchar *name_buffer;\r\nACPI_FUNCTION_TRACE_PTR(ns_get_external_pathname, node);\r\nname_buffer = acpi_ns_get_normalized_pathname(node, FALSE);\r\nreturn_PTR(name_buffer);\r\n}\r\nacpi_size acpi_ns_get_pathname_length(struct acpi_namespace_node *node)\r\n{\r\nacpi_size size;\r\nACPI_FUNCTION_ENTRY();\r\nsize = acpi_ns_build_normalized_path(node, NULL, 0, FALSE);\r\nreturn (size);\r\n}\r\nacpi_status\r\nacpi_ns_handle_to_name(acpi_handle target_handle, struct acpi_buffer *buffer)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nconst char *node_name;\r\nACPI_FUNCTION_TRACE_PTR(ns_handle_to_name, target_handle);\r\nnode = acpi_ns_validate_handle(target_handle);\r\nif (!node) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ut_initialize_buffer(buffer, ACPI_PATH_SEGMENT_LENGTH);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nnode_name = acpi_ut_get_node_name(node);\r\nACPI_MOVE_NAME(buffer->pointer, node_name);\r\n((char *)buffer->pointer)[ACPI_NAME_SIZE] = 0;\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "%4.4s\n", (char *)buffer->pointer));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ns_handle_to_pathname(acpi_handle target_handle,\r\nstruct acpi_buffer *buffer, u8 no_trailing)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nacpi_size required_size;\r\nACPI_FUNCTION_TRACE_PTR(ns_handle_to_pathname, target_handle);\r\nnode = acpi_ns_validate_handle(target_handle);\r\nif (!node) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nrequired_size =\r\nacpi_ns_build_normalized_path(node, NULL, 0, no_trailing);\r\nif (!required_size) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ut_initialize_buffer(buffer, required_size);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n(void)acpi_ns_build_normalized_path(node, buffer->pointer,\r\nrequired_size, no_trailing);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "%s [%X]\n",\r\n(char *)buffer->pointer, (u32) required_size));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nu32\r\nacpi_ns_build_normalized_path(struct acpi_namespace_node *node,\r\nchar *full_path, u32 path_size, u8 no_trailing)\r\n{\r\nu32 length = 0, i;\r\nchar name[ACPI_NAME_SIZE];\r\nu8 do_no_trailing;\r\nchar c, *left, *right;\r\nstruct acpi_namespace_node *next_node;\r\nACPI_FUNCTION_TRACE_PTR(ns_build_normalized_path, node);\r\n#define ACPI_PATH_PUT8(path, size, byte, length) \\r\ndo { \\r\nif ((length) < (size)) \\r\n{ \\r\n(path)[(length)] = (byte); \\r\n} \\r\n(length)++; \\r\n} while (0)\r\nif (!full_path) {\r\npath_size = 0;\r\n}\r\nif (!node) {\r\ngoto build_trailing_null;\r\n}\r\nnext_node = node;\r\nwhile (next_node && next_node != acpi_gbl_root_node) {\r\nif (next_node != node) {\r\nACPI_PATH_PUT8(full_path, path_size,\r\nAML_DUAL_NAME_PREFIX, length);\r\n}\r\nACPI_MOVE_32_TO_32(name, &next_node->name);\r\ndo_no_trailing = no_trailing;\r\nfor (i = 0; i < 4; i++) {\r\nc = name[4 - i - 1];\r\nif (do_no_trailing && c != '_') {\r\ndo_no_trailing = FALSE;\r\n}\r\nif (!do_no_trailing) {\r\nACPI_PATH_PUT8(full_path, path_size, c, length);\r\n}\r\n}\r\nnext_node = next_node->parent;\r\n}\r\nACPI_PATH_PUT8(full_path, path_size, AML_ROOT_PREFIX, length);\r\nif (length <= path_size) {\r\nleft = full_path;\r\nright = full_path + length - 1;\r\nwhile (left < right) {\r\nc = *left;\r\n*left++ = *right;\r\n*right-- = c;\r\n}\r\n}\r\nbuild_trailing_null:\r\nACPI_PATH_PUT8(full_path, path_size, '\0', length);\r\n#undef ACPI_PATH_PUT8\r\nreturn_UINT32(length);\r\n}\r\nchar *acpi_ns_get_normalized_pathname(struct acpi_namespace_node *node,\r\nu8 no_trailing)\r\n{\r\nchar *name_buffer;\r\nacpi_size size;\r\nACPI_FUNCTION_TRACE_PTR(ns_get_normalized_pathname, node);\r\nsize = acpi_ns_build_normalized_path(node, NULL, 0, no_trailing);\r\nif (!size) {\r\nreturn_PTR(NULL);\r\n}\r\nname_buffer = ACPI_ALLOCATE_ZEROED(size);\r\nif (!name_buffer) {\r\nACPI_ERROR((AE_INFO, "Could not allocate %u bytes", (u32)size));\r\nreturn_PTR(NULL);\r\n}\r\n(void)acpi_ns_build_normalized_path(node, name_buffer, size,\r\nno_trailing);\r\nreturn_PTR(name_buffer);\r\n}

int jfs_extendfs(struct super_block *sb, s64 newLVSize, int newLogSize)\r\n{\r\nint rc = 0;\r\nstruct jfs_sb_info *sbi = JFS_SBI(sb);\r\nstruct inode *ipbmap = sbi->ipbmap;\r\nstruct inode *ipbmap2;\r\nstruct inode *ipimap = sbi->ipimap;\r\nstruct jfs_log *log = sbi->log;\r\nstruct bmap *bmp = sbi->bmap;\r\ns64 newLogAddress, newFSCKAddress;\r\nint newFSCKSize;\r\ns64 newMapSize = 0, mapSize;\r\ns64 XAddress, XSize, nblocks, xoff, xaddr, t64;\r\ns64 oldLVSize;\r\ns64 newFSSize;\r\ns64 VolumeSize;\r\nint newNpages = 0, nPages, newPage, xlen, t32;\r\nint tid;\r\nint log_formatted = 0;\r\nstruct inode *iplist[1];\r\nstruct jfs_superblock *j_sb, *j_sb2;\r\ns64 old_agsize;\r\nint agsizechanged = 0;\r\nstruct buffer_head *bh, *bh2;\r\nif (sbi->mntflag & JFS_INLINELOG)\r\noldLVSize = addressPXD(&sbi->logpxd) + lengthPXD(&sbi->logpxd);\r\nelse\r\noldLVSize = addressPXD(&sbi->fsckpxd) +\r\nlengthPXD(&sbi->fsckpxd);\r\nif (oldLVSize >= newLVSize) {\r\nprintk(KERN_WARNING\r\n"jfs_extendfs: volume hasn't grown, returning\n");\r\ngoto out;\r\n}\r\nVolumeSize = sb->s_bdev->bd_inode->i_size >> sb->s_blocksize_bits;\r\nif (VolumeSize) {\r\nif (newLVSize > VolumeSize) {\r\nprintk(KERN_WARNING "jfs_extendfs: invalid size\n");\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\n} else {\r\nbh = sb_bread(sb, newLVSize - 1);\r\nif (!bh) {\r\nprintk(KERN_WARNING "jfs_extendfs: invalid size\n");\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nbforget(bh);\r\n}\r\nif (isReadOnly(ipbmap)) {\r\nprintk(KERN_WARNING "jfs_extendfs: read-only file system\n");\r\nrc = -EROFS;\r\ngoto out;\r\n}\r\nif ((sbi->mntflag & JFS_INLINELOG)) {\r\nif (newLogSize == 0) {\r\nnewLogSize = newLVSize >> 8;\r\nt32 = (1 << (20 - sbi->l2bsize)) - 1;\r\nnewLogSize = (newLogSize + t32) & ~t32;\r\nnewLogSize =\r\nmin(newLogSize, MEGABYTE32 >> sbi->l2bsize);\r\n} else {\r\nnewLogSize = (newLogSize * MEGABYTE) >> sbi->l2bsize;\r\n}\r\n} else\r\nnewLogSize = 0;\r\nnewLogAddress = newLVSize - newLogSize;\r\nt64 = ((newLVSize - newLogSize + BPERDMAP - 1) >> L2BPERDMAP)\r\n<< L2BPERDMAP;\r\nt32 = DIV_ROUND_UP(t64, BITSPERPAGE) + 1 + 50;\r\nnewFSCKSize = t32 << sbi->l2nbperpage;\r\nnewFSCKAddress = newLogAddress - newFSCKSize;\r\nnewFSSize = newLVSize - newLogSize - newFSCKSize;\r\nif (newFSSize < bmp->db_mapsize) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nif ((sbi->mntflag & JFS_INLINELOG) && (newLogAddress > oldLVSize)) {\r\nif ((rc = lmLogFormat(log, newLogAddress, newLogSize)))\r\ngoto out;\r\nlog_formatted = 1;\r\n}\r\ntxQuiesce(sb);\r\nsbi->direct_inode->i_size = sb->s_bdev->bd_inode->i_size;\r\nif (sbi->mntflag & JFS_INLINELOG) {\r\nlmLogShutdown(log);\r\nif ((rc = readSuper(sb, &bh)))\r\ngoto error_out;\r\nj_sb = (struct jfs_superblock *)bh->b_data;\r\nj_sb->s_state |= cpu_to_le32(FM_EXTENDFS);\r\nj_sb->s_xsize = cpu_to_le64(newFSSize);\r\nPXDaddress(&j_sb->s_xfsckpxd, newFSCKAddress);\r\nPXDlength(&j_sb->s_xfsckpxd, newFSCKSize);\r\nPXDaddress(&j_sb->s_xlogpxd, newLogAddress);\r\nPXDlength(&j_sb->s_xlogpxd, newLogSize);\r\nmark_buffer_dirty(bh);\r\nsync_dirty_buffer(bh);\r\nbrelse(bh);\r\nif (!log_formatted)\r\nif ((rc = lmLogFormat(log, newLogAddress, newLogSize)))\r\ngoto error_out;\r\nlog->base = newLogAddress;\r\nlog->size = newLogSize >> (L2LOGPSIZE - sb->s_blocksize_bits);\r\nif ((rc = lmLogInit(log)))\r\ngoto error_out;\r\n}\r\nnewMapSize = newFSSize;\r\nt64 = (newMapSize - 1) + BPERDMAP;\r\nnewNpages = BLKTODMAPN(t64) + 1;\r\nextendBmap:\r\nmapSize = bmp->db_mapsize;\r\nXAddress = mapSize;\r\nXSize = newMapSize - mapSize;\r\nold_agsize = bmp->db_agsize;\r\nt64 = dbMapFileSizeToMapSize(ipbmap);\r\nif (mapSize > t64) {\r\nprintk(KERN_ERR "jfs_extendfs: mapSize (0x%Lx) > t64 (0x%Lx)\n",\r\n(long long) mapSize, (long long) t64);\r\nrc = -EIO;\r\ngoto error_out;\r\n}\r\nnblocks = min(t64 - mapSize, XSize);\r\nif ((rc = dbExtendFS(ipbmap, XAddress, nblocks)))\r\ngoto error_out;\r\nagsizechanged |= (bmp->db_agsize != old_agsize);\r\nXSize -= nblocks;\r\nnPages = ipbmap->i_size >> L2PSIZE;\r\nif (nPages == newNpages)\r\ngoto finalizeBmap;\r\nrc = filemap_fdatawait(ipbmap->i_mapping);\r\nif (rc)\r\ngoto error_out;\r\nrc = filemap_write_and_wait(ipbmap->i_mapping);\r\nif (rc)\r\ngoto error_out;\r\ndiWriteSpecial(ipbmap, 0);\r\nnewPage = nPages;\r\nxoff = newPage << sbi->l2nbperpage;\r\nxlen = (newNpages - nPages) << sbi->l2nbperpage;\r\nxlen = min(xlen, (int) nblocks) & ~(sbi->nbperpage - 1);\r\nxaddr = XAddress;\r\ntid = txBegin(sb, COMMIT_FORCE);\r\nif ((rc = xtAppend(tid, ipbmap, 0, xoff, nblocks, &xlen, &xaddr, 0))) {\r\ntxEnd(tid);\r\ngoto error_out;\r\n}\r\nipbmap->i_size += xlen << sbi->l2bsize;\r\ninode_add_bytes(ipbmap, xlen << sbi->l2bsize);\r\niplist[0] = ipbmap;\r\nrc = txCommit(tid, 1, &iplist[0], COMMIT_FORCE);\r\ntxEnd(tid);\r\nif (rc)\r\ngoto error_out;\r\nif (XSize)\r\ngoto extendBmap;\r\nfinalizeBmap:\r\ndbFinalizeBmap(ipbmap);\r\nif (agsizechanged) {\r\nif ((rc = diExtendFS(ipimap, ipbmap)))\r\ngoto error_out;\r\nif ((rc = diSync(ipimap)))\r\ngoto error_out;\r\n}\r\nif ((rc = dbSync(ipbmap)))\r\ngoto error_out;\r\nipbmap2 = diReadSpecial(sb, BMAP_I, 1);\r\nif (ipbmap2 == NULL) {\r\nprintk(KERN_ERR "jfs_extendfs: diReadSpecial(bmap) failed\n");\r\ngoto error_out;\r\n}\r\nmemcpy(&JFS_IP(ipbmap2)->i_xtroot, &JFS_IP(ipbmap)->i_xtroot, 288);\r\nipbmap2->i_size = ipbmap->i_size;\r\nipbmap2->i_blocks = ipbmap->i_blocks;\r\ndiWriteSpecial(ipbmap2, 1);\r\ndiFreeSpecial(ipbmap2);\r\nif ((rc = readSuper(sb, &bh)))\r\ngoto error_out;\r\nj_sb = (struct jfs_superblock *)bh->b_data;\r\nj_sb->s_state &= cpu_to_le32(~FM_EXTENDFS);\r\nj_sb->s_size = cpu_to_le64(bmp->db_mapsize <<\r\nle16_to_cpu(j_sb->s_l2bfactor));\r\nj_sb->s_agsize = cpu_to_le32(bmp->db_agsize);\r\nif (sbi->mntflag & JFS_INLINELOG) {\r\nPXDaddress(&(j_sb->s_logpxd), newLogAddress);\r\nPXDlength(&(j_sb->s_logpxd), newLogSize);\r\n}\r\nj_sb->s_logserial = cpu_to_le32(log->serial);\r\nPXDaddress(&(j_sb->s_fsckpxd), newFSCKAddress);\r\nPXDlength(&(j_sb->s_fsckpxd), newFSCKSize);\r\nj_sb->s_fscklog = 1;\r\nbh2 = sb_bread(sb, SUPER2_OFF >> sb->s_blocksize_bits);\r\nif (bh2) {\r\nj_sb2 = (struct jfs_superblock *)bh2->b_data;\r\nmemcpy(j_sb2, j_sb, sizeof (struct jfs_superblock));\r\nmark_buffer_dirty(bh);\r\nsync_dirty_buffer(bh2);\r\nbrelse(bh2);\r\n}\r\nmark_buffer_dirty(bh);\r\nsync_dirty_buffer(bh);\r\nbrelse(bh);\r\ngoto resume;\r\nerror_out:\r\njfs_error(sb, "\n");\r\nresume:\r\ntxResume(sb);\r\nout:\r\nreturn rc;\r\n}

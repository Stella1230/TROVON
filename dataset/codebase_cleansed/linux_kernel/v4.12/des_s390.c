static int des_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 tmp[DES_EXPKEY_WORDS];\r\nif (!des_ekey(tmp, key) &&\r\n(tfm->crt_flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des_encrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_DEA, ctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic void des_decrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_DEA | CPACF_DECRYPT,\r\nctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_desall_crypt(struct blkcipher_desc *desc, unsigned long fc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nunsigned int nbytes, n;\r\nint ret;\r\nret = blkcipher_walk_virt(desc, walk);\r\nwhile ((nbytes = walk->nbytes) >= DES_BLOCK_SIZE) {\r\nn = nbytes & ~(DES_BLOCK_SIZE - 1);\r\ncpacf_km(fc, ctx->key, walk->dst.virt.addr,\r\nwalk->src.virt.addr, n);\r\nret = blkcipher_walk_done(desc, walk, nbytes - n);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cbc_desall_crypt(struct blkcipher_desc *desc, unsigned long fc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nunsigned int nbytes, n;\r\nint ret;\r\nstruct {\r\nu8 iv[DES_BLOCK_SIZE];\r\nu8 key[DES3_KEY_SIZE];\r\n} param;\r\nret = blkcipher_walk_virt(desc, walk);\r\nmemcpy(param.iv, walk->iv, DES_BLOCK_SIZE);\r\nmemcpy(param.key, ctx->key, DES3_KEY_SIZE);\r\nwhile ((nbytes = walk->nbytes) >= DES_BLOCK_SIZE) {\r\nn = nbytes & ~(DES_BLOCK_SIZE - 1);\r\ncpacf_kmc(fc, &param, walk->dst.virt.addr,\r\nwalk->src.virt.addr, n);\r\nret = blkcipher_walk_done(desc, walk, nbytes - n);\r\n}\r\nmemcpy(walk->iv, param.iv, DES_BLOCK_SIZE);\r\nreturn ret;\r\n}\r\nstatic int ecb_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_DEA, &walk);\r\n}\r\nstatic int ecb_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_DEA | CPACF_DECRYPT, &walk);\r\n}\r\nstatic int cbc_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_DEA, &walk);\r\n}\r\nstatic int cbc_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_DEA | CPACF_DECRYPT, &walk);\r\n}\r\nstatic int des3_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (!(crypto_memneq(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&\r\ncrypto_memneq(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],\r\nDES_KEY_SIZE)) &&\r\n(tfm->crt_flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nif (fips_enabled &&\r\n!(crypto_memneq(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&\r\ncrypto_memneq(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],\r\nDES_KEY_SIZE) &&\r\ncrypto_memneq(key, &key[DES_KEY_SIZE * 2], DES_KEY_SIZE))) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des3_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_TDEA_192, ctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic void des3_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_TDEA_192 | CPACF_DECRYPT,\r\nctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_TDEA_192, &walk);\r\n}\r\nstatic int ecb_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_TDEA_192 | CPACF_DECRYPT,\r\n&walk);\r\n}\r\nstatic int cbc_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_TDEA_192, &walk);\r\n}\r\nstatic int cbc_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_TDEA_192 | CPACF_DECRYPT,\r\n&walk);\r\n}\r\nstatic unsigned int __ctrblk_init(u8 *ctrptr, u8 *iv, unsigned int nbytes)\r\n{\r\nunsigned int i, n;\r\nn = (nbytes > PAGE_SIZE) ? PAGE_SIZE : nbytes & ~(DES_BLOCK_SIZE - 1);\r\nmemcpy(ctrptr, iv, DES_BLOCK_SIZE);\r\nfor (i = (n / DES_BLOCK_SIZE) - 1; i > 0; i--) {\r\nmemcpy(ctrptr + DES_BLOCK_SIZE, ctrptr, DES_BLOCK_SIZE);\r\ncrypto_inc(ctrptr + DES_BLOCK_SIZE, DES_BLOCK_SIZE);\r\nctrptr += DES_BLOCK_SIZE;\r\n}\r\nreturn n;\r\n}\r\nstatic int ctr_desall_crypt(struct blkcipher_desc *desc, unsigned long fc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nu8 buf[DES_BLOCK_SIZE], *ctrptr;\r\nunsigned int n, nbytes;\r\nint ret, locked;\r\nlocked = spin_trylock(&ctrblk_lock);\r\nret = blkcipher_walk_virt_block(desc, walk, DES_BLOCK_SIZE);\r\nwhile ((nbytes = walk->nbytes) >= DES_BLOCK_SIZE) {\r\nn = DES_BLOCK_SIZE;\r\nif (nbytes >= 2*DES_BLOCK_SIZE && locked)\r\nn = __ctrblk_init(ctrblk, walk->iv, nbytes);\r\nctrptr = (n > DES_BLOCK_SIZE) ? ctrblk : walk->iv;\r\ncpacf_kmctr(fc, ctx->key, walk->dst.virt.addr,\r\nwalk->src.virt.addr, n, ctrptr);\r\nif (ctrptr == ctrblk)\r\nmemcpy(walk->iv, ctrptr + n - DES_BLOCK_SIZE,\r\nDES_BLOCK_SIZE);\r\ncrypto_inc(walk->iv, DES_BLOCK_SIZE);\r\nret = blkcipher_walk_done(desc, walk, nbytes - n);\r\n}\r\nif (locked)\r\nspin_unlock(&ctrblk_lock);\r\nif (nbytes) {\r\ncpacf_kmctr(fc, ctx->key, buf, walk->src.virt.addr,\r\nDES_BLOCK_SIZE, walk->iv);\r\nmemcpy(walk->dst.virt.addr, buf, nbytes);\r\ncrypto_inc(walk->iv, DES_BLOCK_SIZE);\r\nret = blkcipher_walk_done(desc, walk, 0);\r\n}\r\nreturn ret;\r\n}\r\nstatic int ctr_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_DEA, &walk);\r\n}\r\nstatic int ctr_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_DEA | CPACF_DECRYPT, &walk);\r\n}\r\nstatic int ctr_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_TDEA_192, &walk);\r\n}\r\nstatic int ctr_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_TDEA_192 | CPACF_DECRYPT,\r\n&walk);\r\n}\r\nstatic int des_s390_register_alg(struct crypto_alg *alg)\r\n{\r\nint ret;\r\nret = crypto_register_alg(alg);\r\nif (!ret)\r\ndes_s390_algs_ptr[des_s390_algs_num++] = alg;\r\nreturn ret;\r\n}\r\nstatic void des_s390_exit(void)\r\n{\r\nwhile (des_s390_algs_num--)\r\ncrypto_unregister_alg(des_s390_algs_ptr[des_s390_algs_num]);\r\nif (ctrblk)\r\nfree_page((unsigned long) ctrblk);\r\n}\r\nstatic int __init des_s390_init(void)\r\n{\r\nint ret;\r\ncpacf_query(CPACF_KM, &km_functions);\r\ncpacf_query(CPACF_KMC, &kmc_functions);\r\ncpacf_query(CPACF_KMCTR, &kmctr_functions);\r\nif (cpacf_test_func(&km_functions, CPACF_KM_DEA)) {\r\nret = des_s390_register_alg(&des_alg);\r\nif (ret)\r\ngoto out_err;\r\nret = des_s390_register_alg(&ecb_des_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nif (cpacf_test_func(&kmc_functions, CPACF_KMC_DEA)) {\r\nret = des_s390_register_alg(&cbc_des_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nif (cpacf_test_func(&km_functions, CPACF_KM_TDEA_192)) {\r\nret = des_s390_register_alg(&des3_alg);\r\nif (ret)\r\ngoto out_err;\r\nret = des_s390_register_alg(&ecb_des3_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nif (cpacf_test_func(&kmc_functions, CPACF_KMC_TDEA_192)) {\r\nret = des_s390_register_alg(&cbc_des3_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nif (cpacf_test_func(&kmctr_functions, CPACF_KMCTR_DEA) ||\r\ncpacf_test_func(&kmctr_functions, CPACF_KMCTR_TDEA_192)) {\r\nctrblk = (u8 *) __get_free_page(GFP_KERNEL);\r\nif (!ctrblk) {\r\nret = -ENOMEM;\r\ngoto out_err;\r\n}\r\n}\r\nif (cpacf_test_func(&kmctr_functions, CPACF_KMCTR_DEA)) {\r\nret = des_s390_register_alg(&ctr_des_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nif (cpacf_test_func(&kmctr_functions, CPACF_KMCTR_TDEA_192)) {\r\nret = des_s390_register_alg(&ctr_des3_alg);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nreturn 0;\r\nout_err:\r\ndes_s390_exit();\r\nreturn ret;\r\n}

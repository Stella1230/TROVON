static void xgene_get_drvinfo(struct net_device *ndev,\r\nstruct ethtool_drvinfo *info)\r\n{\r\nstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\r\nstruct platform_device *pdev = pdata->pdev;\r\nstrcpy(info->driver, "xgene_enet");\r\nstrcpy(info->version, XGENE_DRV_VERSION);\r\nsnprintf(info->fw_version, ETHTOOL_FWVERS_LEN, "N/A");\r\nsprintf(info->bus_info, "%s", pdev->name);\r\n}\r\nstatic int xgene_get_link_ksettings(struct net_device *ndev,\r\nstruct ethtool_link_ksettings *cmd)\r\n{\r\nstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\r\nstruct phy_device *phydev = ndev->phydev;\r\nu32 supported;\r\nif (pdata->phy_mode == PHY_INTERFACE_MODE_RGMII) {\r\nif (phydev == NULL)\r\nreturn -ENODEV;\r\nreturn phy_ethtool_ksettings_get(phydev, cmd);\r\n} else if (pdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\r\nif (pdata->mdio_driver) {\r\nif (!phydev)\r\nreturn -ENODEV;\r\nreturn phy_ethtool_ksettings_get(phydev, cmd);\r\n}\r\nsupported = SUPPORTED_1000baseT_Full | SUPPORTED_Autoneg |\r\nSUPPORTED_MII;\r\nethtool_convert_legacy_u32_to_link_mode(\r\ncmd->link_modes.supported,\r\nsupported);\r\nethtool_convert_legacy_u32_to_link_mode(\r\ncmd->link_modes.advertising,\r\nsupported);\r\ncmd->base.speed = SPEED_1000;\r\ncmd->base.duplex = DUPLEX_FULL;\r\ncmd->base.port = PORT_MII;\r\ncmd->base.autoneg = AUTONEG_ENABLE;\r\n} else {\r\nsupported = SUPPORTED_10000baseT_Full | SUPPORTED_FIBRE;\r\nethtool_convert_legacy_u32_to_link_mode(\r\ncmd->link_modes.supported,\r\nsupported);\r\nethtool_convert_legacy_u32_to_link_mode(\r\ncmd->link_modes.advertising,\r\nsupported);\r\ncmd->base.speed = SPEED_10000;\r\ncmd->base.duplex = DUPLEX_FULL;\r\ncmd->base.port = PORT_FIBRE;\r\ncmd->base.autoneg = AUTONEG_DISABLE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xgene_set_link_ksettings(struct net_device *ndev,\r\nconst struct ethtool_link_ksettings *cmd)\r\n{\r\nstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\r\nstruct phy_device *phydev = ndev->phydev;\r\nif (pdata->phy_mode == PHY_INTERFACE_MODE_RGMII) {\r\nif (!phydev)\r\nreturn -ENODEV;\r\nreturn phy_ethtool_ksettings_set(phydev, cmd);\r\n}\r\nif (pdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\r\nif (pdata->mdio_driver) {\r\nif (!phydev)\r\nreturn -ENODEV;\r\nreturn phy_ethtool_ksettings_set(phydev, cmd);\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void xgene_get_strings(struct net_device *ndev, u32 stringset, u8 *data)\r\n{\r\nint i;\r\nu8 *p = data;\r\nif (stringset != ETH_SS_STATS)\r\nreturn;\r\nfor (i = 0; i < XGENE_STATS_LEN; i++) {\r\nmemcpy(p, gstrings_stats[i].name, ETH_GSTRING_LEN);\r\np += ETH_GSTRING_LEN;\r\n}\r\n}\r\nstatic int xgene_get_sset_count(struct net_device *ndev, int sset)\r\n{\r\nif (sset != ETH_SS_STATS)\r\nreturn -EINVAL;\r\nreturn XGENE_STATS_LEN;\r\n}\r\nstatic void xgene_get_ethtool_stats(struct net_device *ndev,\r\nstruct ethtool_stats *dummy,\r\nu64 *data)\r\n{\r\nvoid *pdata = netdev_priv(ndev);\r\nint i;\r\nfor (i = 0; i < XGENE_STATS_LEN; i++)\r\n*data++ = *(u64 *)(pdata + gstrings_stats[i].offset);\r\n}\r\nstatic void xgene_get_pauseparam(struct net_device *ndev,\r\nstruct ethtool_pauseparam *pp)\r\n{\r\nstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\r\npp->autoneg = pdata->pause_autoneg;\r\npp->tx_pause = pdata->tx_pause;\r\npp->rx_pause = pdata->rx_pause;\r\n}\r\nstatic int xgene_set_pauseparam(struct net_device *ndev,\r\nstruct ethtool_pauseparam *pp)\r\n{\r\nstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\r\nstruct phy_device *phydev = ndev->phydev;\r\nu32 oldadv, newadv;\r\nif (pdata->phy_mode == PHY_INTERFACE_MODE_RGMII ||\r\npdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\r\nif (!phydev)\r\nreturn -EINVAL;\r\nif (!(phydev->supported & SUPPORTED_Pause) ||\r\n(!(phydev->supported & SUPPORTED_Asym_Pause) &&\r\npp->rx_pause != pp->tx_pause))\r\nreturn -EINVAL;\r\npdata->pause_autoneg = pp->autoneg;\r\npdata->tx_pause = pp->tx_pause;\r\npdata->rx_pause = pp->rx_pause;\r\noldadv = phydev->advertising;\r\nnewadv = oldadv & ~(ADVERTISED_Pause | ADVERTISED_Asym_Pause);\r\nif (pp->rx_pause)\r\nnewadv |= ADVERTISED_Pause | ADVERTISED_Asym_Pause;\r\nif (pp->tx_pause)\r\nnewadv ^= ADVERTISED_Asym_Pause;\r\nif (oldadv ^ newadv) {\r\nphydev->advertising = newadv;\r\nif (phydev->autoneg)\r\nreturn phy_start_aneg(phydev);\r\nif (!pp->autoneg) {\r\npdata->mac_ops->flowctl_tx(pdata,\r\npdata->tx_pause);\r\npdata->mac_ops->flowctl_rx(pdata,\r\npdata->rx_pause);\r\n}\r\n}\r\n} else {\r\nif (pp->autoneg)\r\nreturn -EINVAL;\r\npdata->tx_pause = pp->tx_pause;\r\npdata->rx_pause = pp->rx_pause;\r\npdata->mac_ops->flowctl_tx(pdata, pdata->tx_pause);\r\npdata->mac_ops->flowctl_rx(pdata, pdata->rx_pause);\r\n}\r\nreturn 0;\r\n}\r\nvoid xgene_enet_set_ethtool_ops(struct net_device *ndev)\r\n{\r\nndev->ethtool_ops = &xgene_ethtool_ops;\r\n}

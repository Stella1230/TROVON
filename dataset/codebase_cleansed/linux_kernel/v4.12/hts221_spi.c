static int hts221_spi_read(struct device *dev, u8 addr, int len, u8 *data)\r\n{\r\nint err;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct iio_dev *iio_dev = spi_get_drvdata(spi);\r\nstruct hts221_hw *hw = iio_priv(iio_dev);\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = hw->tb.tx_buf,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n},\r\n{\r\n.rx_buf = hw->tb.rx_buf,\r\n.bits_per_word = 8,\r\n.len = len,\r\n}\r\n};\r\nif (len > 1)\r\naddr |= SPI_AUTO_INCREMENT;\r\nhw->tb.tx_buf[0] = addr | SENSORS_SPI_READ;\r\nerr = spi_sync_transfer(spi, xfers, ARRAY_SIZE(xfers));\r\nif (err < 0)\r\nreturn err;\r\nmemcpy(data, hw->tb.rx_buf, len * sizeof(u8));\r\nreturn len;\r\n}\r\nstatic int hts221_spi_write(struct device *dev, u8 addr, int len, u8 *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct iio_dev *iio_dev = spi_get_drvdata(spi);\r\nstruct hts221_hw *hw = iio_priv(iio_dev);\r\nstruct spi_transfer xfers = {\r\n.tx_buf = hw->tb.tx_buf,\r\n.bits_per_word = 8,\r\n.len = len + 1,\r\n};\r\nif (len >= HTS221_TX_MAX_LENGTH)\r\nreturn -ENOMEM;\r\nif (len > 1)\r\naddr |= SPI_AUTO_INCREMENT;\r\nhw->tb.tx_buf[0] = addr;\r\nmemcpy(&hw->tb.tx_buf[1], data, len);\r\nreturn spi_sync_transfer(spi, &xfers, 1);\r\n}\r\nstatic int hts221_spi_probe(struct spi_device *spi)\r\n{\r\nstruct hts221_hw *hw;\r\nstruct iio_dev *iio_dev;\r\niio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*hw));\r\nif (!iio_dev)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, iio_dev);\r\nhw = iio_priv(iio_dev);\r\nhw->name = spi->modalias;\r\nhw->dev = &spi->dev;\r\nhw->irq = spi->irq;\r\nhw->tf = &hts221_transfer_fn;\r\nreturn hts221_probe(iio_dev);\r\n}

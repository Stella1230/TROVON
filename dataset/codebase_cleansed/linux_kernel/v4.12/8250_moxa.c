static int moxa8250_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct uart_8250_port uart;\r\nstruct moxa8250_board *brd;\r\nvoid __iomem *ioaddr;\r\nresource_size_t baseaddr;\r\nunsigned int i, nr_ports;\r\nunsigned int offset;\r\nint ret;\r\nbrd = &moxa8250_boards[id->driver_data];\r\nnr_ports = brd->num_ports;\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nbrd = devm_kzalloc(&pdev->dev, sizeof(struct moxa8250_board) +\r\nsizeof(unsigned int) * nr_ports, GFP_KERNEL);\r\nif (!brd)\r\nreturn -ENOMEM;\r\nbrd->num_ports = nr_ports;\r\nmemset(&uart, 0, sizeof(struct uart_8250_port));\r\nuart.port.dev = &pdev->dev;\r\nuart.port.irq = pdev->irq;\r\nuart.port.uartclk = MOXA_BASE_BAUD * 16;\r\nuart.port.flags = UPF_SKIP_TEST | UPF_BOOT_AUTOCONF | UPF_SHARE_IRQ;\r\nbaseaddr = pci_resource_start(pdev, MOXA_BASE_BAR);\r\nioaddr = pcim_iomap(pdev, MOXA_BASE_BAR, 0);\r\nif (!ioaddr)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < nr_ports; i++) {\r\nif (nr_ports == 4 && i == 3)\r\noffset = 7 * MOXA_UART_OFFSET;\r\nelse\r\noffset = i * MOXA_UART_OFFSET;\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.iobase = 0;\r\nuart.port.mapbase = baseaddr + offset;\r\nuart.port.membase = ioaddr + offset;\r\nuart.port.regshift = 0;\r\ndev_dbg(&pdev->dev, "Setup PCI port: port %lx, irq %d, type %d\n",\r\nuart.port.iobase, uart.port.irq, uart.port.iotype);\r\nbrd->line[i] = serial8250_register_8250_port(&uart);\r\nif (brd->line[i] < 0) {\r\ndev_err(&pdev->dev,\r\n"Couldn't register serial port %lx, irq %d, type %d, error %d\n",\r\nuart.port.iobase, uart.port.irq,\r\nuart.port.iotype, brd->line[i]);\r\nbreak;\r\n}\r\n}\r\npci_set_drvdata(pdev, brd);\r\nreturn 0;\r\n}\r\nstatic void moxa8250_remove(struct pci_dev *pdev)\r\n{\r\nstruct moxa8250_board *brd = pci_get_drvdata(pdev);\r\nunsigned int i;\r\nfor (i = 0; i < brd->num_ports; i++)\r\nserial8250_unregister_port(brd->line[i]);\r\n}

int rds_rdma_cm_event_handler(struct rdma_cm_id *cm_id,\r\nstruct rdma_cm_event *event)\r\n{\r\nstruct rds_connection *conn = cm_id->context;\r\nstruct rds_transport *trans;\r\nint ret = 0;\r\nrdsdebug("conn %p id %p handling event %u (%s)\n", conn, cm_id,\r\nevent->event, rdma_event_msg(event->event));\r\nif (cm_id->device->node_type == RDMA_NODE_IB_CA)\r\ntrans = &rds_ib_transport;\r\nif (conn) {\r\nmutex_lock(&conn->c_cm_lock);\r\nif (rds_conn_state(conn) == RDS_CONN_DISCONNECTING) {\r\nif (event->event == RDMA_CM_EVENT_CONNECT_REQUEST)\r\nret = 1;\r\ngoto out;\r\n}\r\n}\r\nswitch (event->event) {\r\ncase RDMA_CM_EVENT_CONNECT_REQUEST:\r\nret = trans->cm_handle_connect(cm_id, event);\r\nbreak;\r\ncase RDMA_CM_EVENT_ADDR_RESOLVED:\r\nret = rdma_resolve_route(cm_id,\r\nRDS_RDMA_RESOLVE_TIMEOUT_MS);\r\nbreak;\r\ncase RDMA_CM_EVENT_ROUTE_RESOLVED:\r\nif (conn) {\r\nstruct rds_ib_connection *ibic;\r\nibic = conn->c_transport_data;\r\nif (ibic && ibic->i_cm_id == cm_id)\r\nret = trans->cm_initiate_connect(cm_id);\r\nelse\r\nrds_conn_drop(conn);\r\n}\r\nbreak;\r\ncase RDMA_CM_EVENT_ESTABLISHED:\r\ntrans->cm_connect_complete(conn, event);\r\nbreak;\r\ncase RDMA_CM_EVENT_REJECTED:\r\nrdsdebug("Connection rejected: %s\n",\r\nrdma_reject_msg(cm_id, event->status));\r\ncase RDMA_CM_EVENT_ADDR_ERROR:\r\ncase RDMA_CM_EVENT_ROUTE_ERROR:\r\ncase RDMA_CM_EVENT_CONNECT_ERROR:\r\ncase RDMA_CM_EVENT_UNREACHABLE:\r\ncase RDMA_CM_EVENT_DEVICE_REMOVAL:\r\ncase RDMA_CM_EVENT_ADDR_CHANGE:\r\nif (conn)\r\nrds_conn_drop(conn);\r\nbreak;\r\ncase RDMA_CM_EVENT_DISCONNECTED:\r\nrdsdebug("DISCONNECT event - dropping connection "\r\n"%pI4->%pI4\n", &conn->c_laddr,\r\n&conn->c_faddr);\r\nrds_conn_drop(conn);\r\nbreak;\r\ncase RDMA_CM_EVENT_TIMEWAIT_EXIT:\r\nif (conn) {\r\npr_info("RDS: RDMA_CM_EVENT_TIMEWAIT_EXIT event: dropping connection %pI4->%pI4\n",\r\n&conn->c_laddr, &conn->c_faddr);\r\nrds_conn_drop(conn);\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "RDS: unknown event %u (%s)!\n",\r\nevent->event, rdma_event_msg(event->event));\r\nbreak;\r\n}\r\nout:\r\nif (conn)\r\nmutex_unlock(&conn->c_cm_lock);\r\nrdsdebug("id %p event %u (%s) handling ret %d\n", cm_id, event->event,\r\nrdma_event_msg(event->event), ret);\r\nreturn ret;\r\n}\r\nstatic int rds_rdma_listen_init(void)\r\n{\r\nstruct sockaddr_in sin;\r\nstruct rdma_cm_id *cm_id;\r\nint ret;\r\ncm_id = rdma_create_id(&init_net, rds_rdma_cm_event_handler, NULL,\r\nRDMA_PS_TCP, IB_QPT_RC);\r\nif (IS_ERR(cm_id)) {\r\nret = PTR_ERR(cm_id);\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_create_id() returned %d\n", ret);\r\nreturn ret;\r\n}\r\nsin.sin_family = AF_INET;\r\nsin.sin_addr.s_addr = (__force u32)htonl(INADDR_ANY);\r\nsin.sin_port = (__force u16)htons(RDS_PORT);\r\nret = rdma_bind_addr(cm_id, (struct sockaddr *)&sin);\r\nif (ret) {\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_bind_addr() returned %d\n", ret);\r\ngoto out;\r\n}\r\nret = rdma_listen(cm_id, 128);\r\nif (ret) {\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_listen() returned %d\n", ret);\r\ngoto out;\r\n}\r\nrdsdebug("cm %p listening on port %u\n", cm_id, RDS_PORT);\r\nrds_rdma_listen_id = cm_id;\r\ncm_id = NULL;\r\nout:\r\nif (cm_id)\r\nrdma_destroy_id(cm_id);\r\nreturn ret;\r\n}\r\nstatic void rds_rdma_listen_stop(void)\r\n{\r\nif (rds_rdma_listen_id) {\r\nrdsdebug("cm %p\n", rds_rdma_listen_id);\r\nrdma_destroy_id(rds_rdma_listen_id);\r\nrds_rdma_listen_id = NULL;\r\n}\r\n}\r\nstatic int rds_rdma_init(void)\r\n{\r\nint ret;\r\nret = rds_ib_init();\r\nif (ret)\r\ngoto out;\r\nret = rds_rdma_listen_init();\r\nif (ret)\r\nrds_ib_exit();\r\nout:\r\nreturn ret;\r\n}\r\nstatic void rds_rdma_exit(void)\r\n{\r\nrds_rdma_listen_stop();\r\nrds_ib_exit();\r\n}

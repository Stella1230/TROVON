int button_add_callback (void (*callback) (void), int count)\r\n{\r\nint lp = 0;\r\nif (callback_count == 32) {\r\nreturn -ENOMEM;\r\n}\r\nif (!callback) {\r\nreturn -EINVAL;\r\n}\r\ncallback_count++;\r\nfor (; (button_callback_list [lp].callback); lp++);\r\nbutton_callback_list [lp].callback = callback;\r\nbutton_callback_list [lp].count = count;\r\nreturn 0;\r\n}\r\nint button_del_callback (void (*callback) (void))\r\n{\r\nint lp = 31;\r\nif (!callback) {\r\nreturn -EINVAL;\r\n}\r\nwhile (lp >= 0) {\r\nif ((button_callback_list [lp].callback) == callback) {\r\nbutton_callback_list [lp].callback = NULL;\r\nbutton_callback_list [lp].count = 0;\r\ncallback_count--;\r\nreturn 0;\r\n}\r\nlp--;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void button_consume_callbacks (int bpcount)\r\n{\r\nint lp = 0;\r\nfor (; lp <= 31; lp++) {\r\nif ((button_callback_list [lp].count) == bpcount) {\r\nif (button_callback_list [lp].callback) {\r\nbutton_callback_list[lp].callback();\r\n}\r\n}\r\n}\r\n}\r\nstatic void button_sequence_finished (unsigned long parameters)\r\n{\r\nif (IS_ENABLED(CONFIG_NWBUTTON_REBOOT) &&\r\nbutton_press_count == reboot_count)\r\nkill_cad_pid(SIGINT, 1);\r\nbutton_consume_callbacks (button_press_count);\r\nbcount = sprintf (button_output_buffer, "%d\n", button_press_count);\r\nbutton_press_count = 0;\r\nwake_up_interruptible (&button_wait_queue);\r\n}\r\nstatic irqreturn_t button_handler (int irq, void *dev_id)\r\n{\r\nbutton_press_count++;\r\nmod_timer(&button_timer, jiffies + bdelay);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int button_read (struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nDEFINE_WAIT(wait);\r\nprepare_to_wait(&button_wait_queue, &wait, TASK_INTERRUPTIBLE);\r\nschedule();\r\nfinish_wait(&button_wait_queue, &wait);\r\nreturn (copy_to_user (buffer, &button_output_buffer, bcount))\r\n? -EFAULT : bcount;\r\n}\r\nstatic int __init nwbutton_init(void)\r\n{\r\nif (!machine_is_netwinder())\r\nreturn -ENODEV;\r\nprintk (KERN_INFO "NetWinder Button Driver Version %s (C) Alex Holden "\r\n"<alex@linuxhacker.org> 1998.\n", VERSION);\r\nif (misc_register (&button_misc_device)) {\r\nprintk (KERN_WARNING "nwbutton: Couldn't register device 10, "\r\n"%d.\n", BUTTON_MINOR);\r\nreturn -EBUSY;\r\n}\r\nif (request_irq (IRQ_NETWINDER_BUTTON, button_handler, 0,\r\n"nwbutton", NULL)) {\r\nprintk (KERN_WARNING "nwbutton: IRQ %d is not free.\n",\r\nIRQ_NETWINDER_BUTTON);\r\nmisc_deregister (&button_misc_device);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit nwbutton_exit (void)\r\n{\r\nfree_irq (IRQ_NETWINDER_BUTTON, NULL);\r\nmisc_deregister (&button_misc_device);\r\n}

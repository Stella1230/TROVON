static void max77686_rtc_data_to_tm(u8 *data, struct rtc_time *tm,\r\nstruct max77686_rtc_info *info)\r\n{\r\nu8 mask = info->drv_data->mask;\r\ntm->tm_sec = data[RTC_SEC] & mask;\r\ntm->tm_min = data[RTC_MIN] & mask;\r\nif (info->rtc_24hr_mode) {\r\ntm->tm_hour = data[RTC_HOUR] & 0x1f;\r\n} else {\r\ntm->tm_hour = data[RTC_HOUR] & 0x0f;\r\nif (data[RTC_HOUR] & HOUR_PM_MASK)\r\ntm->tm_hour += 12;\r\n}\r\ntm->tm_wday = ffs(data[RTC_WEEKDAY] & mask) - 1;\r\ntm->tm_mday = data[RTC_DATE] & 0x1f;\r\ntm->tm_mon = (data[RTC_MONTH] & 0x0f) - 1;\r\ntm->tm_year = data[RTC_YEAR] & mask;\r\ntm->tm_yday = 0;\r\ntm->tm_isdst = 0;\r\nif (!info->drv_data->alarm_enable_reg)\r\ntm->tm_year += 100;\r\n}\r\nstatic int max77686_rtc_tm_to_data(struct rtc_time *tm, u8 *data,\r\nstruct max77686_rtc_info *info)\r\n{\r\ndata[RTC_SEC] = tm->tm_sec;\r\ndata[RTC_MIN] = tm->tm_min;\r\ndata[RTC_HOUR] = tm->tm_hour;\r\ndata[RTC_WEEKDAY] = 1 << tm->tm_wday;\r\ndata[RTC_DATE] = tm->tm_mday;\r\ndata[RTC_MONTH] = tm->tm_mon + 1;\r\nif (info->drv_data->alarm_enable_reg) {\r\ndata[RTC_YEAR] = tm->tm_year;\r\nreturn 0;\r\n}\r\ndata[RTC_YEAR] = tm->tm_year > 100 ? (tm->tm_year - 100) : 0;\r\nif (tm->tm_year < 100) {\r\ndev_err(info->dev, "RTC cannot handle the year %d.\n",\r\n1900 + tm->tm_year);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77686_rtc_update(struct max77686_rtc_info *info,\r\nenum MAX77686_RTC_OP op)\r\n{\r\nint ret;\r\nunsigned int data;\r\nunsigned long delay = info->drv_data->delay;\r\nif (op == MAX77686_RTC_WRITE)\r\ndata = 1 << RTC_UDR_SHIFT;\r\nelse\r\ndata = 1 << RTC_RBUDR_SHIFT;\r\nret = regmap_update_bits(info->rtc_regmap,\r\ninfo->drv_data->map[REG_RTC_UPDATE0],\r\ndata, data);\r\nif (ret < 0)\r\ndev_err(info->dev, "Fail to write update reg(ret=%d, data=0x%x)\n",\r\nret, data);\r\nelse {\r\nusleep_range(delay, delay * 2);\r\n}\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nmutex_lock(&info->lock);\r\nret = max77686_rtc_update(info, MAX77686_RTC_READ);\r\nif (ret < 0)\r\ngoto out;\r\nret = regmap_bulk_read(info->rtc_regmap,\r\ninfo->drv_data->map[REG_RTC_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to read time reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nmax77686_rtc_data_to_tm(data, tm, info);\r\nret = rtc_valid_tm(tm);\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nret = max77686_rtc_tm_to_data(tm, data, info);\r\nif (ret < 0)\r\nreturn ret;\r\nmutex_lock(&info->lock);\r\nret = regmap_bulk_write(info->rtc_regmap,\r\ninfo->drv_data->map[REG_RTC_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to write time reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = max77686_rtc_update(info, MAX77686_RTC_WRITE);\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nunsigned int val;\r\nconst unsigned int *map = info->drv_data->map;\r\nint i, ret;\r\nmutex_lock(&info->lock);\r\nret = max77686_rtc_update(info, MAX77686_RTC_READ);\r\nif (ret < 0)\r\ngoto out;\r\nret = regmap_bulk_read(info->rtc_regmap, map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to read alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nmax77686_rtc_data_to_tm(data, &alrm->time, info);\r\nalrm->enabled = 0;\r\nif (info->drv_data->alarm_enable_reg) {\r\nif (map[REG_RTC_AE1] == REG_RTC_NONE) {\r\nret = -EINVAL;\r\ndev_err(info->dev,\r\n"alarm enable register not set(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = regmap_read(info->rtc_regmap, map[REG_RTC_AE1], &val);\r\nif (ret < 0) {\r\ndev_err(info->dev,\r\n"fail to read alarm enable(%d)\n", ret);\r\ngoto out;\r\n}\r\nif (val)\r\nalrm->enabled = 1;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(data); i++) {\r\nif (data[i] & ALARM_ENABLE_MASK) {\r\nalrm->enabled = 1;\r\nbreak;\r\n}\r\n}\r\n}\r\nalrm->pending = 0;\r\nif (info->drv_data->alarm_pending_status_reg == MAX77686_INVALID_REG)\r\ngoto out;\r\nret = regmap_read(info->regmap,\r\ninfo->drv_data->alarm_pending_status_reg, &val);\r\nif (ret < 0) {\r\ndev_err(info->dev,\r\n"Fail to read alarm pending status reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nif (val & (1 << 4))\r\nalrm->pending = 1;\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_stop_alarm(struct max77686_rtc_info *info)\r\n{\r\nu8 data[RTC_NR_TIME];\r\nint ret, i;\r\nstruct rtc_time tm;\r\nconst unsigned int *map = info->drv_data->map;\r\nif (!mutex_is_locked(&info->lock))\r\ndev_warn(info->dev, "%s: should have mutex locked\n", __func__);\r\nret = max77686_rtc_update(info, MAX77686_RTC_READ);\r\nif (ret < 0)\r\ngoto out;\r\nif (info->drv_data->alarm_enable_reg) {\r\nif (map[REG_RTC_AE1] == REG_RTC_NONE) {\r\nret = -EINVAL;\r\ndev_err(info->dev,\r\n"alarm enable register not set(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = regmap_write(info->rtc_regmap, map[REG_RTC_AE1], 0);\r\n} else {\r\nret = regmap_bulk_read(info->rtc_regmap, map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to read alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nmax77686_rtc_data_to_tm(data, &tm, info);\r\nfor (i = 0; i < ARRAY_SIZE(data); i++)\r\ndata[i] &= ~ALARM_ENABLE_MASK;\r\nret = regmap_bulk_write(info->rtc_regmap, map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\n}\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to write alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = max77686_rtc_update(info, MAX77686_RTC_WRITE);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_start_alarm(struct max77686_rtc_info *info)\r\n{\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nstruct rtc_time tm;\r\nconst unsigned int *map = info->drv_data->map;\r\nif (!mutex_is_locked(&info->lock))\r\ndev_warn(info->dev, "%s: should have mutex locked\n", __func__);\r\nret = max77686_rtc_update(info, MAX77686_RTC_READ);\r\nif (ret < 0)\r\ngoto out;\r\nif (info->drv_data->alarm_enable_reg) {\r\nret = regmap_write(info->rtc_regmap, map[REG_RTC_AE1],\r\nMAX77802_ALARM_ENABLE_VALUE);\r\n} else {\r\nret = regmap_bulk_read(info->rtc_regmap, map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to read alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nmax77686_rtc_data_to_tm(data, &tm, info);\r\ndata[RTC_SEC] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_MIN] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_HOUR] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_WEEKDAY] &= ~ALARM_ENABLE_MASK;\r\nif (data[RTC_MONTH] & 0xf)\r\ndata[RTC_MONTH] |= (1 << ALARM_ENABLE_SHIFT);\r\nif (data[RTC_YEAR] & info->drv_data->mask)\r\ndata[RTC_YEAR] |= (1 << ALARM_ENABLE_SHIFT);\r\nif (data[RTC_DATE] & 0x1f)\r\ndata[RTC_DATE] |= (1 << ALARM_ENABLE_SHIFT);\r\nret = regmap_bulk_write(info->rtc_regmap, map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\n}\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to write alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = max77686_rtc_update(info, MAX77686_RTC_WRITE);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nret = max77686_rtc_tm_to_data(&alrm->time, data, info);\r\nif (ret < 0)\r\nreturn ret;\r\nmutex_lock(&info->lock);\r\nret = max77686_rtc_stop_alarm(info);\r\nif (ret < 0)\r\ngoto out;\r\nret = regmap_bulk_write(info->rtc_regmap,\r\ninfo->drv_data->map[REG_ALARM1_SEC],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to write alarm reg(%d)\n", ret);\r\ngoto out;\r\n}\r\nret = max77686_rtc_update(info, MAX77686_RTC_WRITE);\r\nif (ret < 0)\r\ngoto out;\r\nif (alrm->enabled)\r\nret = max77686_rtc_start_alarm(info);\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nint ret;\r\nmutex_lock(&info->lock);\r\nif (enabled)\r\nret = max77686_rtc_start_alarm(info);\r\nelse\r\nret = max77686_rtc_stop_alarm(info);\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t max77686_rtc_alarm_irq(int irq, void *data)\r\n{\r\nstruct max77686_rtc_info *info = data;\r\ndev_dbg(info->dev, "RTC alarm IRQ: %d\n", irq);\r\nrtc_update_irq(info->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int max77686_rtc_init_reg(struct max77686_rtc_info *info)\r\n{\r\nu8 data[2];\r\nint ret;\r\ndata[0] = (1 << BCD_EN_SHIFT) | (1 << MODEL24_SHIFT);\r\ndata[1] = (0 << BCD_EN_SHIFT) | (1 << MODEL24_SHIFT);\r\ninfo->rtc_24hr_mode = 1;\r\nret = regmap_bulk_write(info->rtc_regmap,\r\ninfo->drv_data->map[REG_RTC_CONTROLM],\r\ndata, ARRAY_SIZE(data));\r\nif (ret < 0) {\r\ndev_err(info->dev, "Fail to write controlm reg(%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = max77686_rtc_update(info, MAX77686_RTC_WRITE);\r\nreturn ret;\r\n}\r\nstatic int max77686_init_rtc_regmap(struct max77686_rtc_info *info)\r\n{\r\nstruct device *parent = info->dev->parent;\r\nstruct i2c_client *parent_i2c = to_i2c_client(parent);\r\nint ret;\r\nif (info->drv_data->rtc_irq_from_platform) {\r\nstruct platform_device *pdev = to_platform_device(info->dev);\r\ninfo->rtc_irq = platform_get_irq(pdev, 0);\r\nif (info->rtc_irq < 0) {\r\ndev_err(info->dev, "Failed to get rtc interrupts: %d\n",\r\ninfo->rtc_irq);\r\nreturn info->rtc_irq;\r\n}\r\n} else {\r\ninfo->rtc_irq = parent_i2c->irq;\r\n}\r\ninfo->regmap = dev_get_regmap(parent, NULL);\r\nif (!info->regmap) {\r\ndev_err(info->dev, "Failed to get rtc regmap\n");\r\nreturn -ENODEV;\r\n}\r\nif (info->drv_data->rtc_i2c_addr == MAX77686_INVALID_I2C_ADDR) {\r\ninfo->rtc_regmap = info->regmap;\r\ngoto add_rtc_irq;\r\n}\r\ninfo->rtc = i2c_new_dummy(parent_i2c->adapter,\r\ninfo->drv_data->rtc_i2c_addr);\r\nif (!info->rtc) {\r\ndev_err(info->dev, "Failed to allocate I2C device for RTC\n");\r\nreturn -ENODEV;\r\n}\r\ninfo->rtc_regmap = devm_regmap_init_i2c(info->rtc,\r\n&max77686_rtc_regmap_config);\r\nif (IS_ERR(info->rtc_regmap)) {\r\nret = PTR_ERR(info->rtc_regmap);\r\ndev_err(info->dev, "Failed to allocate RTC regmap: %d\n", ret);\r\ngoto err_unregister_i2c;\r\n}\r\nadd_rtc_irq:\r\nret = regmap_add_irq_chip(info->rtc_regmap, info->rtc_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT |\r\nIRQF_SHARED, 0, info->drv_data->rtc_irq_chip,\r\n&info->rtc_irq_data);\r\nif (ret < 0) {\r\ndev_err(info->dev, "Failed to add RTC irq chip: %d\n", ret);\r\ngoto err_unregister_i2c;\r\n}\r\nreturn 0;\r\nerr_unregister_i2c:\r\nif (info->rtc)\r\ni2c_unregister_device(info->rtc);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct max77686_rtc_info *info;\r\nconst struct platform_device_id *id = platform_get_device_id(pdev);\r\nint ret;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(struct max77686_rtc_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nmutex_init(&info->lock);\r\ninfo->dev = &pdev->dev;\r\ninfo->drv_data = (const struct max77686_rtc_driver_data *)\r\nid->driver_data;\r\nret = max77686_init_rtc_regmap(info);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, info);\r\nret = max77686_rtc_init_reg(info);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to initialize RTC reg:%d\n", ret);\r\ngoto err_rtc;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\ninfo->rtc_dev = devm_rtc_device_register(&pdev->dev, id->name,\r\n&max77686_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(info->rtc_dev)) {\r\nret = PTR_ERR(info->rtc_dev);\r\ndev_err(&pdev->dev, "Failed to register RTC device: %d\n", ret);\r\nif (ret == 0)\r\nret = -EINVAL;\r\ngoto err_rtc;\r\n}\r\ninfo->virq = regmap_irq_get_virq(info->rtc_irq_data,\r\nMAX77686_RTCIRQ_RTCA1);\r\nif (info->virq <= 0) {\r\nret = -ENXIO;\r\ngoto err_rtc;\r\n}\r\nret = request_threaded_irq(info->virq, NULL, max77686_rtc_alarm_irq, 0,\r\n"rtc-alarm1", info);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ: %d: %d\n",\r\ninfo->virq, ret);\r\ngoto err_rtc;\r\n}\r\nreturn 0;\r\nerr_rtc:\r\nregmap_del_irq_chip(info->rtc_irq, info->rtc_irq_data);\r\nif (info->rtc)\r\ni2c_unregister_device(info->rtc);\r\nreturn ret;\r\n}\r\nstatic int max77686_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct max77686_rtc_info *info = platform_get_drvdata(pdev);\r\nfree_irq(info->virq, info);\r\nregmap_del_irq_chip(info->rtc_irq, info->rtc_irq_data);\r\nif (info->rtc)\r\ni2c_unregister_device(info->rtc);\r\nreturn 0;\r\n}\r\nstatic int max77686_rtc_suspend(struct device *dev)\r\n{\r\nif (device_may_wakeup(dev)) {\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nreturn enable_irq_wake(info->virq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77686_rtc_resume(struct device *dev)\r\n{\r\nif (device_may_wakeup(dev)) {\r\nstruct max77686_rtc_info *info = dev_get_drvdata(dev);\r\nreturn disable_irq_wake(info->virq);\r\n}\r\nreturn 0;\r\n}

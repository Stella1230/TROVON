static void usb4604_reset(struct usb4604 *hub, int state)\r\n{\r\ngpiod_set_value_cansleep(hub->gpio_reset, state);\r\nif (state)\r\nmsleep(250);\r\n}\r\nstatic int usb4604_connect(struct usb4604 *hub)\r\n{\r\nstruct device *dev = hub->dev;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nint err;\r\nu8 connect_cmd[] = { 0xaa, 0x55, 0x00 };\r\nusb4604_reset(hub, 1);\r\nerr = i2c_master_send(client, connect_cmd, ARRAY_SIZE(connect_cmd));\r\nif (err < 0) {\r\nusb4604_reset(hub, 0);\r\nreturn err;\r\n}\r\nhub->mode = USB4604_MODE_HUB;\r\ndev_dbg(dev, "switched to HUB mode\n");\r\nreturn 0;\r\n}\r\nstatic int usb4604_switch_mode(struct usb4604 *hub, enum usb4604_mode mode)\r\n{\r\nstruct device *dev = hub->dev;\r\nint err = 0;\r\nswitch (mode) {\r\ncase USB4604_MODE_HUB:\r\nerr = usb4604_connect(hub);\r\nbreak;\r\ncase USB4604_MODE_STANDBY:\r\nusb4604_reset(hub, 0);\r\ndev_dbg(dev, "switched to STANDBY mode\n");\r\nbreak;\r\ndefault:\r\ndev_err(dev, "unknown mode is requested\n");\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int usb4604_probe(struct usb4604 *hub)\r\n{\r\nstruct device *dev = hub->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct gpio_desc *gpio;\r\nu32 mode = USB4604_MODE_HUB;\r\ngpio = devm_gpiod_get_optional(dev, "reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(gpio))\r\nreturn PTR_ERR(gpio);\r\nhub->gpio_reset = gpio;\r\nif (of_property_read_u32(np, "initial-mode", &hub->mode))\r\nhub->mode = mode;\r\nreturn usb4604_switch_mode(hub, hub->mode);\r\n}\r\nstatic int usb4604_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct usb4604 *hub;\r\nhub = devm_kzalloc(&i2c->dev, sizeof(*hub), GFP_KERNEL);\r\nif (!hub)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, hub);\r\nhub->dev = &i2c->dev;\r\nreturn usb4604_probe(hub);\r\n}\r\nstatic int usb4604_i2c_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct usb4604 *hub = i2c_get_clientdata(client);\r\nusb4604_switch_mode(hub, USB4604_MODE_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int usb4604_i2c_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct usb4604 *hub = i2c_get_clientdata(client);\r\nusb4604_switch_mode(hub, hub->mode);\r\nreturn 0;\r\n}

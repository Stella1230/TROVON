static void sc520cdp_setup_par(void)\r\n{\r\nunsigned long __iomem *mmcr;\r\nunsigned long mmcr_val;\r\nint i, j;\r\nmmcr = ioremap_nocache(SC520_MMCR_BASE, SC520_MMCR_EXTENT);\r\nif(!mmcr) {\r\nfor(i = 0; i < NUM_FLASH_BANKS; i++)\r\nsc520cdp_map[i].phys = par_table[i].default_address;\r\nreturn;\r\n}\r\nfor(i = 0; i < NUM_FLASH_BANKS; i++) {\r\nfor(j = 0; j < NUM_SC520_PAR; j++) {\r\nmmcr_val = readl(&mmcr[SC520_PAR(j)]);\r\nif((mmcr_val & SC520_PAR_TRGDEV) == par_table[i].trgdev)\r\n{\r\nwritel(par_table[i].new_par, &mmcr[SC520_PAR(j)]);\r\nbreak;\r\n}\r\n}\r\nif(j == NUM_SC520_PAR)\r\n{\r\nprintk(KERN_NOTICE "Could not find PAR responsible for %s\n",\r\nsc520cdp_map[i].name);\r\nprintk(KERN_NOTICE "Trying default address 0x%lx\n",\r\npar_table[i].default_address);\r\nsc520cdp_map[i].phys = par_table[i].default_address;\r\n}\r\n}\r\niounmap(mmcr);\r\n}\r\nstatic int __init init_sc520cdp(void)\r\n{\r\nint i, j, devices_found = 0;\r\n#ifdef REPROGRAM_PAR\r\nsc520cdp_setup_par();\r\n#endif\r\nfor (i = 0; i < NUM_FLASH_BANKS; i++) {\r\nprintk(KERN_NOTICE "SC520 CDP flash device: 0x%Lx at 0x%Lx\n",\r\n(unsigned long long)sc520cdp_map[i].size,\r\n(unsigned long long)sc520cdp_map[i].phys);\r\nsc520cdp_map[i].virt = ioremap_nocache(sc520cdp_map[i].phys, sc520cdp_map[i].size);\r\nif (!sc520cdp_map[i].virt) {\r\nprintk("Failed to ioremap_nocache\n");\r\nfor (j = 0; j < i; j++) {\r\nif (mymtd[j]) {\r\nmap_destroy(mymtd[j]);\r\niounmap(sc520cdp_map[j].virt);\r\n}\r\n}\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&sc520cdp_map[i]);\r\nmymtd[i] = do_map_probe("cfi_probe", &sc520cdp_map[i]);\r\nif(!mymtd[i])\r\nmymtd[i] = do_map_probe("jedec_probe", &sc520cdp_map[i]);\r\nif(!mymtd[i])\r\nmymtd[i] = do_map_probe("map_rom", &sc520cdp_map[i]);\r\nif (mymtd[i]) {\r\nmymtd[i]->owner = THIS_MODULE;\r\n++devices_found;\r\n}\r\nelse {\r\niounmap(sc520cdp_map[i].virt);\r\n}\r\n}\r\nif(devices_found >= 2) {\r\nmerged_mtd = mtd_concat_create(mymtd, 2, "SC520CDP Flash Banks #0 and #1");\r\nif(merged_mtd)\r\nmtd_device_register(merged_mtd, NULL, 0);\r\n}\r\nif(devices_found == 3)\r\nmtd_device_register(mymtd[2], NULL, 0);\r\nreturn(devices_found ? 0 : -ENXIO);\r\n}\r\nstatic void __exit cleanup_sc520cdp(void)\r\n{\r\nint i;\r\nif (merged_mtd) {\r\nmtd_device_unregister(merged_mtd);\r\nmtd_concat_destroy(merged_mtd);\r\n}\r\nif (mymtd[2])\r\nmtd_device_unregister(mymtd[2]);\r\nfor (i = 0; i < NUM_FLASH_BANKS; i++) {\r\nif (mymtd[i])\r\nmap_destroy(mymtd[i]);\r\nif (sc520cdp_map[i].virt) {\r\niounmap(sc520cdp_map[i].virt);\r\nsc520cdp_map[i].virt = NULL;\r\n}\r\n}\r\n}

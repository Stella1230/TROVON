static void dove_load_divider(void __iomem *base, u32 val, u32 mask, u32 load)\r\n{\r\nu32 v;\r\nv = readl_relaxed(base + DIV_CTRL1) | DIV_CTRL1_N_RESET_MASK;\r\nwritel_relaxed(v, base + DIV_CTRL1);\r\nv = (readl_relaxed(base + DIV_CTRL0) & ~(mask | load)) | val;\r\nwritel_relaxed(v, base + DIV_CTRL0);\r\nwritel_relaxed(v | load, base + DIV_CTRL0);\r\nndelay(250);\r\nwritel_relaxed(v, base + DIV_CTRL0);\r\n}\r\nstatic unsigned int dove_get_divider(struct dove_clk *dc)\r\n{\r\nunsigned int divider;\r\nu32 val;\r\nval = readl_relaxed(dc->base + DIV_CTRL0);\r\nval >>= dc->div_bit_start;\r\ndivider = val & ~(~0 << dc->div_bit_size);\r\nif (dc->divider_table)\r\ndivider = dc->divider_table[divider];\r\nreturn divider;\r\n}\r\nstatic int dove_calc_divider(const struct dove_clk *dc, unsigned long rate,\r\nunsigned long parent_rate, bool set)\r\n{\r\nunsigned int divider, max;\r\ndivider = DIV_ROUND_CLOSEST(parent_rate, rate);\r\nif (dc->divider_table) {\r\nunsigned int i;\r\nfor (i = 0; dc->divider_table[i]; i++)\r\nif (divider == dc->divider_table[i]) {\r\ndivider = i;\r\nbreak;\r\n}\r\nif (!dc->divider_table[i])\r\nreturn -EINVAL;\r\n} else {\r\nmax = 1 << dc->div_bit_size;\r\nif (set && (divider == 0 || divider >= max))\r\nreturn -EINVAL;\r\nif (divider >= max)\r\ndivider = max - 1;\r\nelse if (divider == 0)\r\ndivider = 1;\r\n}\r\nreturn divider;\r\n}\r\nstatic unsigned long dove_recalc_rate(struct clk_hw *hw, unsigned long parent)\r\n{\r\nstruct dove_clk *dc = to_dove_clk(hw);\r\nunsigned int divider = dove_get_divider(dc);\r\nunsigned long rate = DIV_ROUND_CLOSEST(parent, divider);\r\npr_debug("%s(): %s divider=%u parent=%lu rate=%lu\n",\r\n__func__, dc->name, divider, parent, rate);\r\nreturn rate;\r\n}\r\nstatic long dove_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent)\r\n{\r\nstruct dove_clk *dc = to_dove_clk(hw);\r\nunsigned long parent_rate = *parent;\r\nint divider;\r\ndivider = dove_calc_divider(dc, rate, parent_rate, false);\r\nif (divider < 0)\r\nreturn divider;\r\nrate = DIV_ROUND_CLOSEST(parent_rate, divider);\r\npr_debug("%s(): %s divider=%u parent=%lu rate=%lu\n",\r\n__func__, dc->name, divider, parent_rate, rate);\r\nreturn rate;\r\n}\r\nstatic int dove_set_clock(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct dove_clk *dc = to_dove_clk(hw);\r\nu32 mask, load, div;\r\nint divider;\r\ndivider = dove_calc_divider(dc, rate, parent_rate, true);\r\nif (divider < 0)\r\nreturn divider;\r\npr_debug("%s(): %s divider=%u parent=%lu rate=%lu\n",\r\n__func__, dc->name, divider, parent_rate, rate);\r\ndiv = (u32)divider << dc->div_bit_start;\r\nmask = ~(~0 << dc->div_bit_size) << dc->div_bit_start;\r\nload = BIT(dc->div_bit_load);\r\nspin_lock(dc->lock);\r\ndove_load_divider(dc->base, div, mask, load);\r\nspin_unlock(dc->lock);\r\nreturn 0;\r\n}\r\nstatic struct clk *clk_register_dove_divider(struct device *dev,\r\nstruct dove_clk *dc, const char **parent_names, size_t num_parents,\r\nvoid __iomem *base)\r\n{\r\nchar name[32];\r\nstruct clk_init_data init = {\r\n.name = name,\r\n.ops = &dove_divider_ops,\r\n.parent_names = parent_names,\r\n.num_parents = num_parents,\r\n};\r\nstrlcpy(name, dc->name, sizeof(name));\r\ndc->hw.init = &init;\r\ndc->base = base;\r\ndc->div_bit_size = dc->div_bit_end - dc->div_bit_start + 1;\r\nreturn clk_register(dev, &dc->hw);\r\n}\r\nstatic int dove_divider_init(struct device *dev, void __iomem *base,\r\nstruct clk **clks)\r\n{\r\nstruct clk *clk;\r\nint i;\r\nclk = clk_register_fixed_rate(dev, core_pll[0], NULL, 0, 2000000000UL);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nfor (i = 0; i < ARRAY_SIZE(dove_hw_clocks); i++)\r\nclks[i] = clk_register_dove_divider(dev, &dove_hw_clocks[i],\r\ncore_pll,\r\nARRAY_SIZE(core_pll), base);\r\nreturn 0;\r\n}\r\nvoid __init dove_divider_clk_init(struct device_node *np)\r\n{\r\nvoid __iomem *base;\r\nbase = of_iomap(np, 0);\r\nif (WARN_ON(!base))\r\nreturn;\r\nif (WARN_ON(dove_divider_init(NULL, base, dove_divider_clocks))) {\r\niounmap(base);\r\nreturn;\r\n}\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &dove_divider_data);\r\n}

int hw_alloc(struct delta_ctx *ctx, u32 size, const char *name,\r\nstruct delta_buf *buf)\r\n{\r\nstruct delta_dev *delta = ctx->dev;\r\ndma_addr_t dma_addr;\r\nvoid *addr;\r\nunsigned long attrs = DMA_ATTR_WRITE_COMBINE;\r\naddr = dma_alloc_attrs(delta->dev, size, &dma_addr,\r\nGFP_KERNEL | __GFP_NOWARN, attrs);\r\nif (!addr) {\r\ndev_err(delta->dev,\r\n"%s hw_alloc:dma_alloc_coherent failed for %s (size=%d)\n",\r\nctx->name, name, size);\r\nctx->sys_errors++;\r\nreturn -ENOMEM;\r\n}\r\nbuf->size = size;\r\nbuf->paddr = dma_addr;\r\nbuf->vaddr = addr;\r\nbuf->name = name;\r\nbuf->attrs = attrs;\r\ndev_dbg(delta->dev,\r\n"%s allocate %d bytes of HW memory @(virt=0x%p, phy=0x%pad): %s\n",\r\nctx->name, size, buf->vaddr, &buf->paddr, buf->name);\r\nreturn 0;\r\n}\r\nvoid hw_free(struct delta_ctx *ctx, struct delta_buf *buf)\r\n{\r\nstruct delta_dev *delta = ctx->dev;\r\ndev_dbg(delta->dev,\r\n"%s free %d bytes of HW memory @(virt=0x%p, phy=0x%pad): %s\n",\r\nctx->name, buf->size, buf->vaddr, &buf->paddr, buf->name);\r\ndma_free_attrs(delta->dev, buf->size,\r\nbuf->vaddr, buf->paddr, buf->attrs);\r\n}

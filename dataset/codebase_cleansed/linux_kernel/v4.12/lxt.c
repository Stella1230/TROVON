static int lxt970_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_read(phydev, MII_BMSR);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_read(phydev, MII_LXT970_ISR);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int lxt970_config_intr(struct phy_device *phydev)\r\n{\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreturn phy_write(phydev, MII_LXT970_IER, MII_LXT970_IER_IEN);\r\nelse\r\nreturn phy_write(phydev, MII_LXT970_IER, 0);\r\n}\r\nstatic int lxt970_config_init(struct phy_device *phydev)\r\n{\r\nreturn phy_write(phydev, MII_LXT970_CONFIG, 0);\r\n}\r\nstatic int lxt971_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err = phy_read(phydev, MII_LXT971_ISR);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int lxt971_config_intr(struct phy_device *phydev)\r\n{\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreturn phy_write(phydev, MII_LXT971_IER, MII_LXT971_IER_IEN);\r\nelse\r\nreturn phy_write(phydev, MII_LXT971_IER, 0);\r\n}\r\nstatic int lxt973a2_update_link(struct phy_device *phydev)\r\n{\r\nint status;\r\nint control;\r\nint retry = 8;\r\nstatus = phy_read(phydev, MII_BMSR);\r\nif (status < 0)\r\nreturn status;\r\ncontrol = phy_read(phydev, MII_BMCR);\r\nif (control < 0)\r\nreturn control;\r\ndo {\r\nstatus = phy_read(phydev, MII_BMSR);\r\n} while (status >= 0 && retry-- && status == control);\r\nif (status < 0)\r\nreturn status;\r\nif ((status & BMSR_LSTATUS) == 0)\r\nphydev->link = 0;\r\nelse\r\nphydev->link = 1;\r\nreturn 0;\r\n}\r\nstatic int lxt973a2_read_status(struct phy_device *phydev)\r\n{\r\nint adv;\r\nint err;\r\nint lpa;\r\nint lpagb = 0;\r\nerr = lxt973a2_update_link(phydev);\r\nif (err)\r\nreturn err;\r\nif (AUTONEG_ENABLE == phydev->autoneg) {\r\nint retry = 1;\r\nadv = phy_read(phydev, MII_ADVERTISE);\r\nif (adv < 0)\r\nreturn adv;\r\ndo {\r\nlpa = phy_read(phydev, MII_LPA);\r\nif (lpa < 0)\r\nreturn lpa;\r\n} while (lpa == adv && retry--);\r\nlpa &= adv;\r\nphydev->speed = SPEED_10;\r\nphydev->duplex = DUPLEX_HALF;\r\nphydev->pause = phydev->asym_pause = 0;\r\nif (lpagb & (LPA_1000FULL | LPA_1000HALF)) {\r\nphydev->speed = SPEED_1000;\r\nif (lpagb & LPA_1000FULL)\r\nphydev->duplex = DUPLEX_FULL;\r\n} else if (lpa & (LPA_100FULL | LPA_100HALF)) {\r\nphydev->speed = SPEED_100;\r\nif (lpa & LPA_100FULL)\r\nphydev->duplex = DUPLEX_FULL;\r\n} else {\r\nif (lpa & LPA_10FULL)\r\nphydev->duplex = DUPLEX_FULL;\r\n}\r\nif (phydev->duplex == DUPLEX_FULL) {\r\nphydev->pause = lpa & LPA_PAUSE_CAP ? 1 : 0;\r\nphydev->asym_pause = lpa & LPA_PAUSE_ASYM ? 1 : 0;\r\n}\r\n} else {\r\nint bmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nif (bmcr & BMCR_FULLDPLX)\r\nphydev->duplex = DUPLEX_FULL;\r\nelse\r\nphydev->duplex = DUPLEX_HALF;\r\nif (bmcr & BMCR_SPEED1000)\r\nphydev->speed = SPEED_1000;\r\nelse if (bmcr & BMCR_SPEED100)\r\nphydev->speed = SPEED_100;\r\nelse\r\nphydev->speed = SPEED_10;\r\nphydev->pause = phydev->asym_pause = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lxt973_probe(struct phy_device *phydev)\r\n{\r\nint val = phy_read(phydev, MII_LXT973_PCR);\r\nif (val & PCR_FIBER_SELECT) {\r\nval = phy_read(phydev, MII_BMCR);\r\nval |= (BMCR_SPEED100 | BMCR_FULLDPLX);\r\nval &= ~BMCR_ANENABLE;\r\nphy_write(phydev, MII_BMCR, val);\r\nphydev->priv = lxt973_probe;\r\n} else {\r\nphydev->priv = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lxt973_config_aneg(struct phy_device *phydev)\r\n{\r\nreturn phydev->priv ? 0 : genphy_config_aneg(phydev);\r\n}

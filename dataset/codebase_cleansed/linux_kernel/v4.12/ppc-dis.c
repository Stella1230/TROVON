static long\r\noperand_value_powerpc (const struct powerpc_operand *operand,\r\nunsigned long insn, ppc_cpu_t dialect)\r\n{\r\nlong value;\r\nint invalid;\r\nif (operand->extract)\r\nvalue = (*operand->extract) (insn, dialect, &invalid);\r\nelse\r\n{\r\nif (operand->shift >= 0)\r\nvalue = (insn >> operand->shift) & operand->bitm;\r\nelse\r\nvalue = (insn << -operand->shift) & operand->bitm;\r\nif ((operand->flags & PPC_OPERAND_SIGNED) != 0)\r\n{\r\nunsigned long top = operand->bitm;\r\ntop |= (top & -top) - 1;\r\ntop &= ~(top >> 1);\r\nvalue = (value ^ top) - top;\r\n}\r\n}\r\nreturn value;\r\n}\r\nstatic int\r\nskip_optional_operands (const unsigned char *opindex,\r\nunsigned long insn, ppc_cpu_t dialect)\r\n{\r\nconst struct powerpc_operand *operand;\r\nfor (; *opindex != 0; opindex++)\r\n{\r\noperand = &powerpc_operands[*opindex];\r\nif ((operand->flags & PPC_OPERAND_NEXT) != 0\r\n|| ((operand->flags & PPC_OPERAND_OPTIONAL) != 0\r\n&& operand_value_powerpc (operand, insn, dialect) !=\r\nppc_optional_operand_value (operand)))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic const struct powerpc_opcode *\r\nlookup_powerpc (unsigned long insn, ppc_cpu_t dialect)\r\n{\r\nconst struct powerpc_opcode *opcode;\r\nconst struct powerpc_opcode *opcode_end;\r\nunsigned long op;\r\nop = PPC_OP (insn);\r\nopcode_end = powerpc_opcodes + powerpc_num_opcodes;\r\nfor (opcode = powerpc_opcodes; opcode < opcode_end; ++opcode)\r\n{\r\nconst unsigned char *opindex;\r\nconst struct powerpc_operand *operand;\r\nint invalid;\r\nif ((insn & opcode->mask) != opcode->opcode\r\n|| (dialect != (ppc_cpu_t) -1\r\n&& ((opcode->flags & dialect) == 0\r\n|| (opcode->deprecated & dialect) != 0)))\r\ncontinue;\r\ninvalid = 0;\r\nfor (opindex = opcode->operands; *opindex != 0; opindex++)\r\n{\r\noperand = powerpc_operands + *opindex;\r\nif (operand->extract)\r\n(*operand->extract) (insn, dialect, &invalid);\r\n}\r\nif (invalid)\r\ncontinue;\r\nreturn opcode;\r\n}\r\nreturn NULL;\r\n}\r\nint print_insn_powerpc (unsigned long insn, unsigned long memaddr)\r\n{\r\nconst struct powerpc_opcode *opcode;\r\nbool insn_is_short;\r\nppc_cpu_t dialect;\r\ndialect = PPC_OPCODE_PPC | PPC_OPCODE_COMMON\r\n| PPC_OPCODE_64 | PPC_OPCODE_POWER4 | PPC_OPCODE_ALTIVEC;\r\nif (cpu_has_feature(CPU_FTRS_POWER5))\r\ndialect |= PPC_OPCODE_POWER5;\r\nif (cpu_has_feature(CPU_FTRS_CELL))\r\ndialect |= (PPC_OPCODE_CELL | PPC_OPCODE_ALTIVEC);\r\nif (cpu_has_feature(CPU_FTRS_POWER6))\r\ndialect |= (PPC_OPCODE_POWER5 | PPC_OPCODE_POWER6 | PPC_OPCODE_ALTIVEC);\r\nif (cpu_has_feature(CPU_FTRS_POWER7))\r\ndialect |= (PPC_OPCODE_POWER5 | PPC_OPCODE_POWER6 | PPC_OPCODE_POWER7\r\n| PPC_OPCODE_ALTIVEC | PPC_OPCODE_VSX);\r\nif (cpu_has_feature(CPU_FTRS_POWER8))\r\ndialect |= (PPC_OPCODE_POWER5 | PPC_OPCODE_POWER6 | PPC_OPCODE_POWER7\r\n| PPC_OPCODE_POWER8 | PPC_OPCODE_HTM\r\n| PPC_OPCODE_ALTIVEC | PPC_OPCODE_ALTIVEC2 | PPC_OPCODE_VSX);\r\nif (cpu_has_feature(CPU_FTRS_POWER9))\r\ndialect |= (PPC_OPCODE_POWER5 | PPC_OPCODE_POWER6 | PPC_OPCODE_POWER7\r\n| PPC_OPCODE_POWER8 | PPC_OPCODE_POWER9 | PPC_OPCODE_HTM\r\n| PPC_OPCODE_ALTIVEC | PPC_OPCODE_ALTIVEC2\r\n| PPC_OPCODE_VSX | PPC_OPCODE_VSX3),\r\nopcode = NULL;\r\ninsn_is_short = false;\r\nif (opcode == NULL)\r\nopcode = lookup_powerpc (insn, dialect);\r\nif (opcode == NULL && (dialect & PPC_OPCODE_ANY) != 0)\r\nopcode = lookup_powerpc (insn, (ppc_cpu_t) -1);\r\nif (opcode != NULL)\r\n{\r\nconst unsigned char *opindex;\r\nconst struct powerpc_operand *operand;\r\nint need_comma;\r\nint need_paren;\r\nint skip_optional;\r\nif (opcode->operands[0] != 0)\r\nprintf("%-7s ", opcode->name);\r\nelse\r\nprintf("%s", opcode->name);\r\nif (insn_is_short)\r\ninsn >>= 16;\r\nneed_comma = 0;\r\nneed_paren = 0;\r\nskip_optional = -1;\r\nfor (opindex = opcode->operands; *opindex != 0; opindex++)\r\n{\r\nlong value;\r\noperand = powerpc_operands + *opindex;\r\nif ((operand->flags & PPC_OPERAND_FAKE) != 0)\r\ncontinue;\r\nif ((operand->flags & PPC_OPERAND_OPTIONAL) != 0)\r\n{\r\nif (skip_optional < 0)\r\nskip_optional = skip_optional_operands (opindex, insn,\r\ndialect);\r\nif (skip_optional)\r\ncontinue;\r\n}\r\nvalue = operand_value_powerpc (operand, insn, dialect);\r\nif (need_comma)\r\n{\r\nprintf(",");\r\nneed_comma = 0;\r\n}\r\nif ((operand->flags & PPC_OPERAND_GPR) != 0\r\n|| ((operand->flags & PPC_OPERAND_GPR_0) != 0 && value != 0))\r\nprintf("r%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_FPR) != 0)\r\nprintf("f%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_VR) != 0)\r\nprintf("v%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_VSR) != 0)\r\nprintf("vs%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_RELATIVE) != 0)\r\nprint_address(memaddr + value);\r\nelse if ((operand->flags & PPC_OPERAND_ABSOLUTE) != 0)\r\nprint_address(value & 0xffffffff);\r\nelse if ((operand->flags & PPC_OPERAND_FSL) != 0)\r\nprintf("fsl%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_FCR) != 0)\r\nprintf("fcr%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_UDI) != 0)\r\nprintf("%ld", value);\r\nelse if ((operand->flags & PPC_OPERAND_CR_REG) != 0\r\n&& (((dialect & PPC_OPCODE_PPC) != 0)\r\n|| ((dialect & PPC_OPCODE_VLE) != 0)))\r\nprintf("cr%ld", value);\r\nelse if (((operand->flags & PPC_OPERAND_CR_BIT) != 0)\r\n&& (((dialect & PPC_OPCODE_PPC) != 0)\r\n|| ((dialect & PPC_OPCODE_VLE) != 0)))\r\n{\r\nstatic const char *cbnames[4] = { "lt", "gt", "eq", "so" };\r\nint cr;\r\nint cc;\r\ncr = value >> 2;\r\nif (cr != 0)\r\nprintf("4*cr%d+", cr);\r\ncc = value & 3;\r\nprintf("%s", cbnames[cc]);\r\n}\r\nelse\r\nprintf("%d", (int) value);\r\nif (need_paren)\r\n{\r\nprintf(")");\r\nneed_paren = 0;\r\n}\r\nif ((operand->flags & PPC_OPERAND_PARENS) == 0)\r\nneed_comma = 1;\r\nelse\r\n{\r\nprintf("(");\r\nneed_paren = 1;\r\n}\r\n}\r\nif (insn_is_short)\r\n{\r\nmemaddr += 2;\r\nreturn 2;\r\n}\r\nelse\r\nreturn 4;\r\n}\r\nprintf(".long 0x%lx", insn);\r\nreturn 4;\r\n}

static u64 jiffies_read(struct clocksource *cs)\r\n{\r\nreturn (u64) jiffies;\r\n}\r\nu64 get_jiffies_64(void)\r\n{\r\nunsigned long seq;\r\nu64 ret;\r\ndo {\r\nseq = read_seqbegin(&jiffies_lock);\r\nret = jiffies_64;\r\n} while (read_seqretry(&jiffies_lock, seq));\r\nreturn ret;\r\n}\r\nstatic int __init init_jiffies_clocksource(void)\r\n{\r\nreturn __clocksource_register(&clocksource_jiffies);\r\n}\r\nstruct clocksource * __init __weak clocksource_default_clock(void)\r\n{\r\nreturn &clocksource_jiffies;\r\n}\r\nint register_refined_jiffies(long cycles_per_second)\r\n{\r\nu64 nsec_per_tick, shift_hz;\r\nlong cycles_per_tick;\r\nrefined_jiffies = clocksource_jiffies;\r\nrefined_jiffies.name = "refined-jiffies";\r\nrefined_jiffies.rating++;\r\ncycles_per_tick = (cycles_per_second + HZ/2)/HZ;\r\nshift_hz = (u64)cycles_per_second << 8;\r\nshift_hz += cycles_per_tick/2;\r\ndo_div(shift_hz, cycles_per_tick);\r\nnsec_per_tick = (u64)NSEC_PER_SEC << 8;\r\nnsec_per_tick += (u32)shift_hz/2;\r\ndo_div(nsec_per_tick, (u32)shift_hz);\r\nrefined_jiffies.mult = ((u32)nsec_per_tick) << JIFFIES_SHIFT;\r\n__clocksource_register(&refined_jiffies);\r\nreturn 0;\r\n}

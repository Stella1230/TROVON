static inline int oakscsi_pwrite(struct NCR5380_hostdata *hostdata,\r\nunsigned char *addr, int len)\r\n{\r\nu8 __iomem *base = hostdata->io;\r\nprintk("writing %p len %d\n",addr, len);\r\nwhile(1)\r\n{\r\nint status;\r\nwhile (((status = readw(base + STAT)) & 0x100)==0);\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int oakscsi_pread(struct NCR5380_hostdata *hostdata,\r\nunsigned char *addr, int len)\r\n{\r\nu8 __iomem *base = hostdata->io;\r\nprintk("reading %p len %d\n", addr, len);\r\nwhile(len > 0)\r\n{\r\nunsigned int status, timeout;\r\nunsigned long b;\r\ntimeout = 0x01FFFFFF;\r\nwhile (((status = readw(base + STAT)) & 0x100)==0)\r\n{\r\ntimeout--;\r\nif(status & 0x200 || !timeout)\r\n{\r\nprintk("status = %08X\n", status);\r\nreturn -1;\r\n}\r\n}\r\nif(len >= 128)\r\n{\r\nreadsw(base + DATA, addr, 128);\r\naddr += 128;\r\nlen -= 128;\r\n}\r\nelse\r\n{\r\nb = (unsigned long) readw(base + DATA);\r\n*addr ++ = b;\r\nlen -= 1;\r\nif(len)\r\n*addr ++ = b>>8;\r\nlen -= 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int oakscsi_probe(struct expansion_card *ec, const struct ecard_id *id)\r\n{\r\nstruct Scsi_Host *host;\r\nint ret = -ENOMEM;\r\nret = ecard_request_resources(ec);\r\nif (ret)\r\ngoto out;\r\nhost = scsi_host_alloc(&oakscsi_template, sizeof(struct NCR5380_hostdata));\r\nif (!host) {\r\nret = -ENOMEM;\r\ngoto release;\r\n}\r\npriv(host)->io = ioremap(ecard_resource_start(ec, ECARD_RES_MEMC),\r\necard_resource_len(ec, ECARD_RES_MEMC));\r\nif (!priv(host)->io) {\r\nret = -ENOMEM;\r\ngoto unreg;\r\n}\r\nhost->irq = NO_IRQ;\r\nret = NCR5380_init(host, FLAG_DMA_FIXUP | FLAG_LATE_DMA_SETUP);\r\nif (ret)\r\ngoto out_unmap;\r\nNCR5380_maybe_reset_bus(host);\r\nret = scsi_add_host(host, &ec->dev);\r\nif (ret)\r\ngoto out_exit;\r\nscsi_scan_host(host);\r\ngoto out;\r\nout_exit:\r\nNCR5380_exit(host);\r\nout_unmap:\r\niounmap(priv(host)->io);\r\nunreg:\r\nscsi_host_put(host);\r\nrelease:\r\necard_release_resources(ec);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void oakscsi_remove(struct expansion_card *ec)\r\n{\r\nstruct Scsi_Host *host = ecard_get_drvdata(ec);\r\nvoid __iomem *base = priv(host)->io;\r\necard_set_drvdata(ec, NULL);\r\nscsi_remove_host(host);\r\nNCR5380_exit(host);\r\nscsi_host_put(host);\r\niounmap(base);\r\necard_release_resources(ec);\r\n}\r\nstatic int __init oakscsi_init(void)\r\n{\r\nreturn ecard_register_driver(&oakscsi_driver);\r\n}\r\nstatic void __exit oakscsi_exit(void)\r\n{\r\necard_remove_driver(&oakscsi_driver);\r\n}

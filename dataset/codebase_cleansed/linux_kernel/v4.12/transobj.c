int mlx5_core_alloc_transport_domain(struct mlx5_core_dev *dev, u32 *tdn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(alloc_transport_domain_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(alloc_transport_domain_out)] = {0};\r\nint err;\r\nMLX5_SET(alloc_transport_domain_in, in, opcode,\r\nMLX5_CMD_OP_ALLOC_TRANSPORT_DOMAIN);\r\nerr = mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\nif (!err)\r\n*tdn = MLX5_GET(alloc_transport_domain_out, out,\r\ntransport_domain);\r\nreturn err;\r\n}\r\nvoid mlx5_core_dealloc_transport_domain(struct mlx5_core_dev *dev, u32 tdn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(dealloc_transport_domain_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(dealloc_transport_domain_out)] = {0};\r\nMLX5_SET(dealloc_transport_domain_in, in, opcode,\r\nMLX5_CMD_OP_DEALLOC_TRANSPORT_DOMAIN);\r\nMLX5_SET(dealloc_transport_domain_in, in, transport_domain, tdn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_create_rq(struct mlx5_core_dev *dev, u32 *in, int inlen, u32 *rqn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_rq_out)] = {0};\r\nint err;\r\nMLX5_SET(create_rq_in, in, opcode, MLX5_CMD_OP_CREATE_RQ);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*rqn = MLX5_GET(create_rq_out, out, rqn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_rq(struct mlx5_core_dev *dev, u32 rqn, u32 *in, int inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_rq_out)];\r\nMLX5_SET(modify_rq_in, in, rqn, rqn);\r\nMLX5_SET(modify_rq_in, in, opcode, MLX5_CMD_OP_MODIFY_RQ);\r\nmemset(out, 0, sizeof(out));\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nvoid mlx5_core_destroy_rq(struct mlx5_core_dev *dev, u32 rqn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_rq_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_rq_out)] = {0};\r\nMLX5_SET(destroy_rq_in, in, opcode, MLX5_CMD_OP_DESTROY_RQ);\r\nMLX5_SET(destroy_rq_in, in, rqn, rqn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_query_rq(struct mlx5_core_dev *dev, u32 rqn, u32 *out)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(query_rq_in)] = {0};\r\nint outlen = MLX5_ST_SZ_BYTES(query_rq_out);\r\nMLX5_SET(query_rq_in, in, opcode, MLX5_CMD_OP_QUERY_RQ);\r\nMLX5_SET(query_rq_in, in, rqn, rqn);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, outlen);\r\n}\r\nint mlx5_core_create_sq(struct mlx5_core_dev *dev, u32 *in, int inlen, u32 *sqn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_sq_out)] = {0};\r\nint err;\r\nMLX5_SET(create_sq_in, in, opcode, MLX5_CMD_OP_CREATE_SQ);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*sqn = MLX5_GET(create_sq_out, out, sqn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_sq(struct mlx5_core_dev *dev, u32 sqn, u32 *in, int inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_sq_out)] = {0};\r\nMLX5_SET(modify_sq_in, in, sqn, sqn);\r\nMLX5_SET(modify_sq_in, in, opcode, MLX5_CMD_OP_MODIFY_SQ);\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nvoid mlx5_core_destroy_sq(struct mlx5_core_dev *dev, u32 sqn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_sq_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_sq_out)] = {0};\r\nMLX5_SET(destroy_sq_in, in, opcode, MLX5_CMD_OP_DESTROY_SQ);\r\nMLX5_SET(destroy_sq_in, in, sqn, sqn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_query_sq(struct mlx5_core_dev *dev, u32 sqn, u32 *out)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(query_sq_in)] = {0};\r\nint outlen = MLX5_ST_SZ_BYTES(query_sq_out);\r\nMLX5_SET(query_sq_in, in, opcode, MLX5_CMD_OP_QUERY_SQ);\r\nMLX5_SET(query_sq_in, in, sqn, sqn);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, outlen);\r\n}\r\nint mlx5_core_create_tir(struct mlx5_core_dev *dev, u32 *in, int inlen,\r\nu32 *tirn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_tir_out)] = {0};\r\nint err;\r\nMLX5_SET(create_tir_in, in, opcode, MLX5_CMD_OP_CREATE_TIR);\r\nmemset(out, 0, sizeof(out));\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*tirn = MLX5_GET(create_tir_out, out, tirn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_tir(struct mlx5_core_dev *dev, u32 tirn, u32 *in,\r\nint inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_tir_out)] = {0};\r\nMLX5_SET(modify_tir_in, in, tirn, tirn);\r\nMLX5_SET(modify_tir_in, in, opcode, MLX5_CMD_OP_MODIFY_TIR);\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nvoid mlx5_core_destroy_tir(struct mlx5_core_dev *dev, u32 tirn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_tir_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_tir_out)] = {0};\r\nMLX5_SET(destroy_tir_in, in, opcode, MLX5_CMD_OP_DESTROY_TIR);\r\nMLX5_SET(destroy_tir_in, in, tirn, tirn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_create_tis(struct mlx5_core_dev *dev, u32 *in, int inlen,\r\nu32 *tisn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_tis_out)] = {0};\r\nint err;\r\nMLX5_SET(create_tis_in, in, opcode, MLX5_CMD_OP_CREATE_TIS);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*tisn = MLX5_GET(create_tis_out, out, tisn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_tis(struct mlx5_core_dev *dev, u32 tisn, u32 *in,\r\nint inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_tis_out)] = {0};\r\nMLX5_SET(modify_tis_in, in, tisn, tisn);\r\nMLX5_SET(modify_tis_in, in, opcode, MLX5_CMD_OP_MODIFY_TIS);\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nvoid mlx5_core_destroy_tis(struct mlx5_core_dev *dev, u32 tisn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_tis_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_tis_out)] = {0};\r\nMLX5_SET(destroy_tis_in, in, opcode, MLX5_CMD_OP_DESTROY_TIS);\r\nMLX5_SET(destroy_tis_in, in, tisn, tisn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_create_rmp(struct mlx5_core_dev *dev, u32 *in, int inlen,\r\nu32 *rmpn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_rmp_out)] = {0};\r\nint err;\r\nMLX5_SET(create_rmp_in, in, opcode, MLX5_CMD_OP_CREATE_RMP);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*rmpn = MLX5_GET(create_rmp_out, out, rmpn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_rmp(struct mlx5_core_dev *dev, u32 *in, int inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_rmp_out)] = {0};\r\nMLX5_SET(modify_rmp_in, in, opcode, MLX5_CMD_OP_MODIFY_RMP);\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nint mlx5_core_destroy_rmp(struct mlx5_core_dev *dev, u32 rmpn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_rmp_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_rmp_out)] = {0};\r\nMLX5_SET(destroy_rmp_in, in, opcode, MLX5_CMD_OP_DESTROY_RMP);\r\nMLX5_SET(destroy_rmp_in, in, rmpn, rmpn);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out,\r\nsizeof(out));\r\n}\r\nint mlx5_core_query_rmp(struct mlx5_core_dev *dev, u32 rmpn, u32 *out)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(query_rmp_in)] = {0};\r\nint outlen = MLX5_ST_SZ_BYTES(query_rmp_out);\r\nMLX5_SET(query_rmp_in, in, opcode, MLX5_CMD_OP_QUERY_RMP);\r\nMLX5_SET(query_rmp_in, in, rmpn, rmpn);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, outlen);\r\n}\r\nint mlx5_core_arm_rmp(struct mlx5_core_dev *dev, u32 rmpn, u16 lwm)\r\n{\r\nvoid *in;\r\nvoid *rmpc;\r\nvoid *wq;\r\nvoid *bitmask;\r\nint err;\r\nin = mlx5_vzalloc(MLX5_ST_SZ_BYTES(modify_rmp_in));\r\nif (!in)\r\nreturn -ENOMEM;\r\nrmpc = MLX5_ADDR_OF(modify_rmp_in, in, ctx);\r\nbitmask = MLX5_ADDR_OF(modify_rmp_in, in, bitmask);\r\nwq = MLX5_ADDR_OF(rmpc, rmpc, wq);\r\nMLX5_SET(modify_rmp_in, in, rmp_state, MLX5_RMPC_STATE_RDY);\r\nMLX5_SET(modify_rmp_in, in, rmpn, rmpn);\r\nMLX5_SET(wq, wq, lwm, lwm);\r\nMLX5_SET(rmp_bitmask, bitmask, lwm, 1);\r\nMLX5_SET(rmpc, rmpc, state, MLX5_RMPC_STATE_RDY);\r\nerr = mlx5_core_modify_rmp(dev, in, MLX5_ST_SZ_BYTES(modify_rmp_in));\r\nkvfree(in);\r\nreturn err;\r\n}\r\nint mlx5_core_create_xsrq(struct mlx5_core_dev *dev, u32 *in, int inlen,\r\nu32 *xsrqn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_xrc_srq_out)] = {0};\r\nint err;\r\nMLX5_SET(create_xrc_srq_in, in, opcode, MLX5_CMD_OP_CREATE_XRC_SRQ);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*xsrqn = MLX5_GET(create_xrc_srq_out, out, xrc_srqn);\r\nreturn err;\r\n}\r\nint mlx5_core_destroy_xsrq(struct mlx5_core_dev *dev, u32 xsrqn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_xrc_srq_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_xrc_srq_out)] = {0};\r\nMLX5_SET(destroy_xrc_srq_in, in, opcode, MLX5_CMD_OP_DESTROY_XRC_SRQ);\r\nMLX5_SET(destroy_xrc_srq_in, in, xrc_srqn, xsrqn);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_query_xsrq(struct mlx5_core_dev *dev, u32 xsrqn, u32 *out)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(query_xrc_srq_in)] = {0};\r\nvoid *srqc;\r\nvoid *xrc_srqc;\r\nint err;\r\nMLX5_SET(query_xrc_srq_in, in, opcode, MLX5_CMD_OP_QUERY_XRC_SRQ);\r\nMLX5_SET(query_xrc_srq_in, in, xrc_srqn, xsrqn);\r\nerr = mlx5_cmd_exec(dev, in, sizeof(in), out,\r\nMLX5_ST_SZ_BYTES(query_xrc_srq_out));\r\nif (!err) {\r\nxrc_srqc = MLX5_ADDR_OF(query_xrc_srq_out, out,\r\nxrc_srq_context_entry);\r\nsrqc = MLX5_ADDR_OF(query_srq_out, out, srq_context_entry);\r\nmemcpy(srqc, xrc_srqc, MLX5_ST_SZ_BYTES(srqc));\r\n}\r\nreturn err;\r\n}\r\nint mlx5_core_arm_xsrq(struct mlx5_core_dev *dev, u32 xsrqn, u16 lwm)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(arm_xrc_srq_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(arm_xrc_srq_out)] = {0};\r\nMLX5_SET(arm_xrc_srq_in, in, opcode, MLX5_CMD_OP_ARM_XRC_SRQ);\r\nMLX5_SET(arm_xrc_srq_in, in, xrc_srqn, xsrqn);\r\nMLX5_SET(arm_xrc_srq_in, in, lwm, lwm);\r\nMLX5_SET(arm_xrc_srq_in, in, op_mod,\r\nMLX5_ARM_XRC_SRQ_IN_OP_MOD_XRC_SRQ);\r\nreturn mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}\r\nint mlx5_core_create_rqt(struct mlx5_core_dev *dev, u32 *in, int inlen,\r\nu32 *rqtn)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(create_rqt_out)] = {0};\r\nint err;\r\nMLX5_SET(create_rqt_in, in, opcode, MLX5_CMD_OP_CREATE_RQT);\r\nerr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\nif (!err)\r\n*rqtn = MLX5_GET(create_rqt_out, out, rqtn);\r\nreturn err;\r\n}\r\nint mlx5_core_modify_rqt(struct mlx5_core_dev *dev, u32 rqtn, u32 *in,\r\nint inlen)\r\n{\r\nu32 out[MLX5_ST_SZ_DW(modify_rqt_out)] = {0};\r\nMLX5_SET(modify_rqt_in, in, rqtn, rqtn);\r\nMLX5_SET(modify_rqt_in, in, opcode, MLX5_CMD_OP_MODIFY_RQT);\r\nreturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\r\n}\r\nvoid mlx5_core_destroy_rqt(struct mlx5_core_dev *dev, u32 rqtn)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(destroy_rqt_in)] = {0};\r\nu32 out[MLX5_ST_SZ_DW(destroy_rqt_out)] = {0};\r\nMLX5_SET(destroy_rqt_in, in, opcode, MLX5_CMD_OP_DESTROY_RQT);\r\nMLX5_SET(destroy_rqt_in, in, rqtn, rqtn);\r\nmlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\r\n}

static int act8945a_get_charger_state(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_PRE:\r\ncase APCH_STATE_CSTATE_FAST:\r\n*val = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase APCH_STATE_CSTATE_EOC:\r\nif (status & APCH_STATUS_CHGDAT)\r\n*val = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\n*val = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase APCH_STATE_CSTATE_DISABLED:\r\ndefault:\r\nif (!(status & APCH_STATUS_INDAT))\r\n*val = POWER_SUPPLY_STATUS_DISCHARGING;\r\nelse\r\n*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_charge_type(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_PRE:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ncase APCH_STATE_CSTATE_FAST:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ncase APCH_STATE_CSTATE_EOC:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\ncase APCH_STATE_CSTATE_DISABLED:\r\ndefault:\r\nif (!(status & APCH_STATUS_INDAT))\r\n*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nelse\r\n*val = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_battery_health(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state, config;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_CFG, &config);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_DISABLED:\r\nif (config & APCH_CFG_SUSCHG) {\r\n*val = POWER_SUPPLY_HEALTH_UNKNOWN;\r\n} else if (status & APCH_STATUS_INDAT) {\r\nif (!(status & APCH_STATUS_TEMPDAT))\r\n*val = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nelse if (status & APCH_STATUS_TIMRDAT)\r\n*val = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\r\nelse\r\n*val = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\n} else {\r\n*val = POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\nbreak;\r\ncase APCH_STATE_CSTATE_PRE:\r\ncase APCH_STATE_CSTATE_FAST:\r\ncase APCH_STATE_CSTATE_EOC:\r\ndefault:\r\n*val = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_capacity_level(struct act8945a_charger *charger,\r\nstruct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state, config;\r\nint lbo_level = gpiod_get_value(charger->lbo_gpio);\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_CFG, &config);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_PRE:\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\r\nbreak;\r\ncase APCH_STATE_CSTATE_FAST:\r\nif (lbo_level)\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_HIGH;\r\nelse\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\r\nbreak;\r\ncase APCH_STATE_CSTATE_EOC:\r\nif (status & APCH_STATUS_CHGDAT)\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\r\nelse\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\r\nbreak;\r\ncase APCH_STATE_CSTATE_DISABLED:\r\ndefault:\r\nif (config & APCH_CFG_SUSCHG) {\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_UNKNOWN;\r\n} else {\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\r\nif (!(status & APCH_STATUS_INDAT)) {\r\nif (!lbo_level)\r\n*val = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\r\n}\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_current_max(struct act8945a_charger *charger,\r\nstruct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state;\r\nunsigned int acin_state;\r\nint chgin_level = gpiod_get_value(charger->chglev_gpio);\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nacin_state = (state & APCH_STATE_ACINSTAT) >> 1;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_PRE:\r\nif (acin_state) {\r\nif (chgin_level)\r\n*val = MAX_CURRENT_AC_HIGH_PRE;\r\nelse\r\n*val = MAX_CURRENT_AC_LOW_PRE;\r\n} else {\r\n*val = MAX_CURRENT_USB_PRE;\r\n}\r\nbreak;\r\ncase APCH_STATE_CSTATE_FAST:\r\nif (acin_state) {\r\nif (chgin_level)\r\n*val = MAX_CURRENT_AC_HIGH;\r\nelse\r\n*val = MAX_CURRENT_AC_LOW;\r\n} else {\r\nif (chgin_level)\r\n*val = MAX_CURRENT_USB_HIGH;\r\nelse\r\n*val = MAX_CURRENT_USB_LOW;\r\n}\r\nbreak;\r\ncase APCH_STATE_CSTATE_EOC:\r\ncase APCH_STATE_CSTATE_DISABLED:\r\ndefault:\r\n*val = 0;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property prop,\r\nunion power_supply_propval *val)\r\n{\r\nstruct act8945a_charger *charger = power_supply_get_drvdata(psy);\r\nstruct regmap *regmap = charger->regmap;\r\nint ret = 0;\r\nswitch (prop) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = act8945a_get_charger_state(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = act8945a_get_charge_type(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = act8945a_get_battery_health(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\r\nret = act8945a_get_capacity_level(charger,\r\nregmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_MAX:\r\nret = act8945a_get_current_max(charger,\r\nregmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = act8945a_charger_model;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = act8945a_charger_manufacturer;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int act8945a_enable_interrupt(struct act8945a_charger *charger)\r\n{\r\nstruct regmap *regmap = charger->regmap;\r\nunsigned char ctrl;\r\nint ret;\r\nctrl = APCH_CTRL_CHGEOCOUT | APCH_CTRL_CHGEOCIN |\r\nAPCH_CTRL_INDIS | APCH_CTRL_INCON |\r\nAPCH_CTRL_TEMPOUT | APCH_CTRL_TEMPIN |\r\nAPCH_CTRL_TIMRPRE | APCH_CTRL_TIMRTOT;\r\nret = regmap_write(regmap, ACT8945A_APCH_CTRL, ctrl);\r\nif (ret)\r\nreturn ret;\r\nctrl = APCH_STATUS_CHGSTAT | APCH_STATUS_INSTAT |\r\nAPCH_STATUS_TEMPSTAT | APCH_STATUS_TIMRSTAT;\r\nret = regmap_write(regmap, ACT8945A_APCH_STATUS, ctrl);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic unsigned int act8945a_set_supply_type(struct act8945a_charger *charger,\r\nunsigned int *type)\r\n{\r\nunsigned int status, state;\r\nint ret;\r\nret = regmap_read(charger->regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(charger->regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nif (status & APCH_STATUS_INDAT) {\r\nif (state & APCH_STATE_ACINSTAT)\r\n*type = POWER_SUPPLY_TYPE_MAINS;\r\nelse\r\n*type = POWER_SUPPLY_TYPE_USB;\r\n} else {\r\n*type = POWER_SUPPLY_TYPE_BATTERY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void act8945a_work(struct work_struct *work)\r\n{\r\nstruct act8945a_charger *charger =\r\ncontainer_of(work, struct act8945a_charger, work);\r\nact8945a_set_supply_type(charger, &charger->desc.type);\r\npower_supply_changed(charger->psy);\r\n}\r\nstatic irqreturn_t act8945a_status_changed(int irq, void *dev_id)\r\n{\r\nstruct act8945a_charger *charger = dev_id;\r\nif (charger->init_done)\r\nschedule_work(&charger->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int act8945a_charger_config(struct device *dev,\r\nstruct act8945a_charger *charger)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct regmap *regmap = charger->regmap;\r\nu32 total_time_out;\r\nu32 pre_time_out;\r\nu32 input_voltage_threshold;\r\nint err, ret;\r\nunsigned int tmp;\r\nunsigned int value = 0;\r\nif (!np) {\r\ndev_err(dev, "no charger of node\n");\r\nreturn -EINVAL;\r\n}\r\nret = regmap_read(regmap, ACT8945A_APCH_CFG, &tmp);\r\nif (ret)\r\nreturn ret;\r\nif (tmp & APCH_CFG_SUSCHG) {\r\nvalue |= APCH_CFG_SUSCHG;\r\ndev_info(dev, "have been suspended\n");\r\n}\r\ncharger->lbo_gpio = devm_gpiod_get_optional(dev, "active-semi,lbo",\r\nGPIOD_IN);\r\nif (IS_ERR(charger->lbo_gpio)) {\r\nerr = PTR_ERR(charger->lbo_gpio);\r\ndev_err(dev, "unable to claim gpio \"lbo\": %d\n", err);\r\nreturn err;\r\n}\r\nret = devm_request_irq(dev, gpiod_to_irq(charger->lbo_gpio),\r\nact8945a_status_changed,\r\n(IRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING),\r\n"act8945a_lbo_detect", charger);\r\nif (ret)\r\ndev_info(dev, "failed to request gpio \"lbo\" IRQ\n");\r\ncharger->chglev_gpio = devm_gpiod_get_optional(dev,\r\n"active-semi,chglev",\r\nGPIOD_IN);\r\nif (IS_ERR(charger->chglev_gpio)) {\r\nerr = PTR_ERR(charger->chglev_gpio);\r\ndev_err(dev, "unable to claim gpio \"chglev\": %d\n", err);\r\nreturn err;\r\n}\r\nif (of_property_read_u32(np,\r\n"active-semi,input-voltage-threshold-microvolt",\r\n&input_voltage_threshold))\r\ninput_voltage_threshold = DEFAULT_INPUT_OVP_THRESHOLD;\r\nif (of_property_read_u32(np,\r\n"active-semi,precondition-timeout",\r\n&pre_time_out))\r\npre_time_out = DEFAULT_PRE_TIME_OUT;\r\nif (of_property_read_u32(np, "active-semi,total-timeout",\r\n&total_time_out))\r\ntotal_time_out = DEFAULT_TOTAL_TIME_OUT;\r\nswitch (input_voltage_threshold) {\r\ncase 8000:\r\nvalue |= APCH_CFG_OVPSET_8V;\r\nbreak;\r\ncase 7500:\r\nvalue |= APCH_CFG_OVPSET_7V5;\r\nbreak;\r\ncase 7000:\r\nvalue |= APCH_CFG_OVPSET_7V;\r\nbreak;\r\ncase 6600:\r\ndefault:\r\nvalue |= APCH_CFG_OVPSET_6V6;\r\nbreak;\r\n}\r\nswitch (pre_time_out) {\r\ncase 60:\r\nvalue |= APCH_CFG_PRETIMO_60_MIN;\r\nbreak;\r\ncase 80:\r\nvalue |= APCH_CFG_PRETIMO_80_MIN;\r\nbreak;\r\ncase 0:\r\nvalue |= APCH_CFG_PRETIMO_DISABLED;\r\nbreak;\r\ncase 40:\r\ndefault:\r\nvalue |= APCH_CFG_PRETIMO_40_MIN;\r\nbreak;\r\n}\r\nswitch (total_time_out) {\r\ncase 4:\r\nvalue |= APCH_CFG_TOTTIMO_4_HOUR;\r\nbreak;\r\ncase 5:\r\nvalue |= APCH_CFG_TOTTIMO_5_HOUR;\r\nbreak;\r\ncase 0:\r\nvalue |= APCH_CFG_TOTTIMO_DISABLED;\r\nbreak;\r\ncase 3:\r\ndefault:\r\nvalue |= APCH_CFG_TOTTIMO_3_HOUR;\r\nbreak;\r\n}\r\nreturn regmap_write(regmap, ACT8945A_APCH_CFG, value);\r\n}\r\nstatic int act8945a_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct act8945a_charger *charger;\r\nstruct power_supply_config psy_cfg = {};\r\nint irq, ret;\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\r\nif (!charger)\r\nreturn -ENOMEM;\r\ncharger->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!charger->regmap) {\r\ndev_err(&pdev->dev, "Parent did not provide regmap\n");\r\nreturn -EINVAL;\r\n}\r\nret = act8945a_charger_config(&pdev->dev, charger);\r\nif (ret)\r\nreturn ret;\r\nirq = of_irq_get(pdev->dev.of_node, 0);\r\nif (irq == -EPROBE_DEFER) {\r\ndev_err(&pdev->dev, "failed to find IRQ number\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nret = devm_request_irq(&pdev->dev, irq, act8945a_status_changed,\r\nIRQF_TRIGGER_FALLING, "act8945a_interrupt",\r\ncharger);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request nIRQ pin IRQ\n");\r\nreturn ret;\r\n}\r\ncharger->desc.name = "act8945a-charger";\r\ncharger->desc.get_property = act8945a_charger_get_property;\r\ncharger->desc.properties = act8945a_charger_props;\r\ncharger->desc.num_properties = ARRAY_SIZE(act8945a_charger_props);\r\nret = act8945a_set_supply_type(charger, &charger->desc.type);\r\nif (ret)\r\nreturn -EINVAL;\r\npsy_cfg.of_node = pdev->dev.of_node;\r\npsy_cfg.drv_data = charger;\r\ncharger->psy = devm_power_supply_register(&pdev->dev,\r\n&charger->desc,\r\n&psy_cfg);\r\nif (IS_ERR(charger->psy)) {\r\ndev_err(&pdev->dev, "failed to register power supply\n");\r\nreturn PTR_ERR(charger->psy);\r\n}\r\nplatform_set_drvdata(pdev, charger);\r\nINIT_WORK(&charger->work, act8945a_work);\r\nret = act8945a_enable_interrupt(charger);\r\nif (ret)\r\nreturn -EIO;\r\ncharger->init_done = true;\r\nreturn 0;\r\n}\r\nstatic int act8945a_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct act8945a_charger *charger = platform_get_drvdata(pdev);\r\ncharger->init_done = false;\r\ncancel_work_sync(&charger->work);\r\nreturn 0;\r\n}

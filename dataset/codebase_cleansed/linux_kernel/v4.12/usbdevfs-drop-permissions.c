void drop_privileges(int fd, uint32_t mask)\r\n{\r\nint res;\r\nres = ioctl(fd, USBDEVFS_DROP_PRIVILEGES, &mask);\r\nif (res)\r\nprintf("ERROR: USBDEVFS_DROP_PRIVILEGES returned %d\n", res);\r\nelse\r\nprintf("OK: privileges dropped!\n");\r\n}\r\nvoid reset_device(int fd)\r\n{\r\nint res;\r\nres = ioctl(fd, USBDEVFS_RESET);\r\nif (!res)\r\nprintf("OK: USBDEVFS_RESET succeeded\n");\r\nelse\r\nprintf("ERROR: reset failed! (%d - %s)\n",\r\n-res, strerror(-res));\r\n}\r\nvoid claim_some_intf(int fd)\r\n{\r\nint i, res;\r\nfor (i = 0; i < 4; i++) {\r\nres = ioctl(fd, USBDEVFS_CLAIMINTERFACE, &i);\r\nif (!res)\r\nprintf("OK: claimed if %d\n", i);\r\nelse\r\nprintf("ERROR claiming if %d (%d - %s)\n",\r\ni, -res, strerror(-res));\r\n}\r\n}\r\nint main(int argc, char *argv[])\r\n{\r\nuint32_t mask, caps;\r\nint c, fd;\r\nfd = open(argv[1], O_RDWR);\r\nif (fd < 0) {\r\nprintf("Failed to open file\n");\r\ngoto err_fd;\r\n}\r\nioctl(fd, USBDEVFS_GET_CAPABILITIES, &caps);\r\nif (!(caps & USBDEVFS_CAP_DROP_PRIVILEGES)) {\r\nprintf("DROP_PRIVILEGES not supported\n");\r\ngoto err;\r\n}\r\ndrop_privileges(fd, -1U);\r\nprintf("Available options:\n"\r\n"[0] Exit now\n"\r\n"[1] Reset device. Should fail if device is in use\n"\r\n"[2] Claim 4 interfaces. Should succeed where not in use\n"\r\n"[3] Narrow interface permission mask\n"\r\n"Which option shall I run?: ");\r\nwhile (scanf("%d", &c) == 1) {\r\nswitch (c) {\r\ncase 0:\r\ngoto exit;\r\ncase 1:\r\nreset_device(fd);\r\nbreak;\r\ncase 2:\r\nclaim_some_intf(fd);\r\nbreak;\r\ncase 3:\r\nprintf("Insert new mask: ");\r\nscanf("%x", &mask);\r\ndrop_privileges(fd, mask);\r\nbreak;\r\ndefault:\r\nprintf("I don't recognize that\n");\r\n}\r\nprintf("Which test shall I run next?: ");\r\n}\r\nexit:\r\nclose(fd);\r\nreturn 0;\r\nerr:\r\nclose(fd);\r\nerr_fd:\r\nreturn 1;\r\n}

static int ep93xx_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct ep93xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwritel(0xaaaa, priv->mmio + EP93XX_WATCHDOG);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct ep93xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwritel(0xaa55, priv->mmio + EP93XX_WATCHDOG);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct ep93xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nwritel(0x5555, priv->mmio + EP93XX_WATCHDOG);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_wdt_priv *priv;\r\nstruct watchdog_device *wdd;\r\nstruct resource *res;\r\nunsigned long val;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->mmio = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->mmio))\r\nreturn PTR_ERR(priv->mmio);\r\nval = readl(priv->mmio + EP93XX_WATCHDOG);\r\nwdd = &priv->wdd;\r\nwdd->bootstatus = (val & 0x01) ? WDIOF_CARDRESET : 0;\r\nwdd->info = &ep93xx_wdt_ident;\r\nwdd->ops = &ep93xx_wdt_ops;\r\nwdd->min_timeout = 1;\r\nwdd->max_hw_heartbeat_ms = 200;\r\nwdd->parent = &pdev->dev;\r\nwatchdog_set_nowayout(wdd, nowayout);\r\nwdd->timeout = WDT_TIMEOUT;\r\nwatchdog_init_timeout(wdd, timeout, &pdev->dev);\r\nwatchdog_set_drvdata(wdd, priv);\r\nret = devm_watchdog_register_device(&pdev->dev, wdd);\r\nif (ret)\r\nreturn ret;\r\ndev_info(&pdev->dev, "EP93XX watchdog driver %s\n",\r\n(val & 0x08) ? " (nCS1 disable detected)" : "");\r\nreturn 0;\r\n}

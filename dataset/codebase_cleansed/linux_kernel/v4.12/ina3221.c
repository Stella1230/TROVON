static int ina3221_read_value(struct ina3221_data *ina, unsigned int reg,\r\nint *val)\r\n{\r\nunsigned int regval;\r\nint ret;\r\nret = regmap_read(ina->regmap, reg, &regval);\r\nif (ret)\r\nreturn ret;\r\n*val = sign_extend32(regval >> 3, 12);\r\nreturn 0;\r\n}\r\nstatic ssize_t ina3221_show_bus_voltage(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int reg = sd_attr->index;\r\nint val, voltage_mv, ret;\r\nret = ina3221_read_value(ina, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nvoltage_mv = val * 8;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", voltage_mv);\r\n}\r\nstatic ssize_t ina3221_show_shunt_voltage(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int reg = sd_attr->index;\r\nint val, voltage_uv, ret;\r\nret = ina3221_read_value(ina, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nvoltage_uv = val * 40;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", voltage_uv);\r\n}\r\nstatic ssize_t ina3221_show_current(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int reg = sd_attr->index;\r\nunsigned int channel = register_channel[reg];\r\nint resistance_uo = ina->shunt_resistors[channel];\r\nint val, current_ma, voltage_nv, ret;\r\nret = ina3221_read_value(ina, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nvoltage_nv = val * 40000;\r\ncurrent_ma = DIV_ROUND_CLOSEST(voltage_nv, resistance_uo);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", current_ma);\r\n}\r\nstatic ssize_t ina3221_set_current(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int reg = sd_attr->index;\r\nunsigned int channel = register_channel[reg];\r\nint resistance_uo = ina->shunt_resistors[channel];\r\nint val, current_ma, voltage_uv, ret;\r\nret = kstrtoint(buf, 0, &current_ma);\r\nif (ret)\r\nreturn ret;\r\ncurrent_ma = clamp_val(current_ma,\r\nINT_MIN / resistance_uo,\r\nINT_MAX / resistance_uo);\r\nvoltage_uv = DIV_ROUND_CLOSEST(current_ma * resistance_uo, 1000);\r\nvoltage_uv = clamp_val(voltage_uv, -163800, 163800);\r\nval = DIV_ROUND_CLOSEST(voltage_uv, 5) & 0xfff8;\r\nret = regmap_write(ina->regmap, reg, val);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t ina3221_show_shunt(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int channel = sd_attr->index;\r\nunsigned int resistance_uo;\r\nresistance_uo = ina->shunt_resistors[channel];\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", resistance_uo);\r\n}\r\nstatic ssize_t ina3221_set_shunt(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int channel = sd_attr->index;\r\nint val;\r\nint ret;\r\nret = kstrtoint(buf, 0, &val);\r\nif (ret)\r\nreturn ret;\r\nval = clamp_val(val, 1, INT_MAX);\r\nina->shunt_resistors[channel] = val;\r\nreturn count;\r\n}\r\nstatic ssize_t ina3221_show_alert(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *sd_attr = to_sensor_dev_attr(attr);\r\nstruct ina3221_data *ina = dev_get_drvdata(dev);\r\nunsigned int field = sd_attr->index;\r\nunsigned int regval;\r\nint ret;\r\nret = regmap_field_read(ina->fields[field], &regval);\r\nif (ret)\r\nreturn ret;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", regval);\r\n}\r\nstatic int ina3221_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct ina3221_data *ina;\r\nstruct device *hwmon_dev;\r\nint i, ret;\r\nina = devm_kzalloc(dev, sizeof(*ina), GFP_KERNEL);\r\nif (!ina)\r\nreturn -ENOMEM;\r\nina->regmap = devm_regmap_init_i2c(client, &ina3221_regmap_config);\r\nif (IS_ERR(ina->regmap)) {\r\ndev_err(dev, "Unable to allocate register map\n");\r\nreturn PTR_ERR(ina->regmap);\r\n}\r\nfor (i = 0; i < F_MAX_FIELDS; i++) {\r\nina->fields[i] = devm_regmap_field_alloc(dev,\r\nina->regmap,\r\nina3221_reg_fields[i]);\r\nif (IS_ERR(ina->fields[i])) {\r\ndev_err(dev, "Unable to allocate regmap fields\n");\r\nreturn PTR_ERR(ina->fields[i]);\r\n}\r\n}\r\nfor (i = 0; i < INA3221_NUM_CHANNELS; i++)\r\nina->shunt_resistors[i] = INA3221_RSHUNT_DEFAULT;\r\nret = regmap_field_write(ina->fields[F_RST], true);\r\nif (ret) {\r\ndev_err(dev, "Unable to reset device\n");\r\nreturn ret;\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev,\r\nclient->name,\r\nina, ina3221_groups);\r\nif (IS_ERR(hwmon_dev)) {\r\ndev_err(dev, "Unable to register hwmon device\n");\r\nreturn PTR_ERR(hwmon_dev);\r\n}\r\nreturn 0;\r\n}

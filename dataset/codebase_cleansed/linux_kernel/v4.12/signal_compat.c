static inline void signal_compat_build_tests(void)\r\n{\r\nint _sifields_offset = offsetof(compat_siginfo_t, _sifields);\r\nBUILD_BUG_ON(NSIGILL != 8);\r\nBUILD_BUG_ON(NSIGFPE != 8);\r\nBUILD_BUG_ON(NSIGSEGV != 4);\r\nBUILD_BUG_ON(NSIGBUS != 5);\r\nBUILD_BUG_ON(NSIGTRAP != 4);\r\nBUILD_BUG_ON(NSIGCHLD != 6);\r\nBUILD_BUG_ON(NSIGSYS != 1);\r\nBUILD_BUG_ON(sizeof(compat_siginfo_t) != 128);\r\nBUILD_BUG_ON(offsetof(compat_siginfo_t, _sifields) != 3 * sizeof(int));\r\n#define CHECK_CSI_OFFSET(name) BUILD_BUG_ON(_sifields_offset != offsetof(compat_siginfo_t, _sifields.name))\r\n#define CHECK_CSI_SIZE(name, size) BUILD_BUG_ON(size != sizeof(((compat_siginfo_t *)0)->_sifields.name))\r\n#define CHECK_SI_SIZE(name, size) BUILD_BUG_ON(size != sizeof(((siginfo_t *)0)->_sifields.name))\r\nCHECK_CSI_OFFSET(_kill);\r\nCHECK_CSI_SIZE (_kill, 2*sizeof(int));\r\nCHECK_SI_SIZE (_kill, 2*sizeof(int));\r\nCHECK_CSI_OFFSET(_timer);\r\nCHECK_CSI_SIZE (_timer, 5*sizeof(int));\r\nCHECK_SI_SIZE (_timer, 6*sizeof(int));\r\nCHECK_CSI_OFFSET(_rt);\r\nCHECK_CSI_SIZE (_rt, 3*sizeof(int));\r\nCHECK_SI_SIZE (_rt, 4*sizeof(int));\r\nCHECK_CSI_OFFSET(_sigchld);\r\nCHECK_CSI_SIZE (_sigchld, 5*sizeof(int));\r\nCHECK_SI_SIZE (_sigchld, 8*sizeof(int));\r\nCHECK_CSI_OFFSET(_sigchld_x32);\r\nCHECK_CSI_SIZE (_sigchld_x32, 7*sizeof(int));\r\nCHECK_CSI_OFFSET(_sigfault);\r\nCHECK_CSI_SIZE (_sigfault, 4*sizeof(int));\r\nCHECK_SI_SIZE (_sigfault, 8*sizeof(int));\r\nCHECK_CSI_OFFSET(_sigpoll);\r\nCHECK_CSI_SIZE (_sigpoll, 2*sizeof(int));\r\nCHECK_SI_SIZE (_sigpoll, 4*sizeof(int));\r\nCHECK_CSI_OFFSET(_sigsys);\r\nCHECK_CSI_SIZE (_sigsys, 3*sizeof(int));\r\nCHECK_SI_SIZE (_sigsys, 4*sizeof(int));\r\n}\r\nvoid sigaction_compat_abi(struct k_sigaction *act, struct k_sigaction *oact)\r\n{\r\nif (oact)\r\noact->sa.sa_flags &= ~(SA_IA32_ABI | SA_X32_ABI);\r\nif (!act)\r\nreturn;\r\nact->sa.sa_flags &= ~(SA_IA32_ABI | SA_X32_ABI);\r\nif (in_ia32_syscall())\r\nact->sa.sa_flags |= SA_IA32_ABI;\r\nif (in_x32_syscall())\r\nact->sa.sa_flags |= SA_X32_ABI;\r\n}\r\nint __copy_siginfo_to_user32(compat_siginfo_t __user *to, const siginfo_t *from,\r\nbool x32_ABI)\r\n{\r\nint err = 0;\r\nsignal_compat_build_tests();\r\nif (!access_ok(VERIFY_WRITE, to, sizeof(compat_siginfo_t)))\r\nreturn -EFAULT;\r\nput_user_try {\r\nput_user_ex(from->si_signo, &to->si_signo);\r\nput_user_ex(from->si_errno, &to->si_errno);\r\nput_user_ex((short)from->si_code, &to->si_code);\r\nif (from->si_code < 0) {\r\nput_user_ex(from->si_pid, &to->si_pid);\r\nput_user_ex(from->si_uid, &to->si_uid);\r\nput_user_ex(ptr_to_compat(from->si_ptr), &to->si_ptr);\r\n} else {\r\nput_user_ex(from->_sifields._pad[0],\r\n&to->_sifields._pad[0]);\r\nswitch (from->si_code >> 16) {\r\ncase __SI_FAULT >> 16:\r\nif (from->si_signo == SIGBUS &&\r\n(from->si_code == BUS_MCEERR_AR ||\r\nfrom->si_code == BUS_MCEERR_AO))\r\nput_user_ex(from->si_addr_lsb, &to->si_addr_lsb);\r\nif (from->si_signo == SIGSEGV) {\r\nif (from->si_code == SEGV_BNDERR) {\r\ncompat_uptr_t lower = (unsigned long)from->si_lower;\r\ncompat_uptr_t upper = (unsigned long)from->si_upper;\r\nput_user_ex(lower, &to->si_lower);\r\nput_user_ex(upper, &to->si_upper);\r\n}\r\nif (from->si_code == SEGV_PKUERR)\r\nput_user_ex(from->si_pkey, &to->si_pkey);\r\n}\r\nbreak;\r\ncase __SI_SYS >> 16:\r\nput_user_ex(from->si_syscall, &to->si_syscall);\r\nput_user_ex(from->si_arch, &to->si_arch);\r\nbreak;\r\ncase __SI_CHLD >> 16:\r\nif (!x32_ABI) {\r\nput_user_ex(from->si_utime, &to->si_utime);\r\nput_user_ex(from->si_stime, &to->si_stime);\r\n} else {\r\nput_user_ex(from->si_utime, &to->_sifields._sigchld_x32._utime);\r\nput_user_ex(from->si_stime, &to->_sifields._sigchld_x32._stime);\r\n}\r\nput_user_ex(from->si_status, &to->si_status);\r\ndefault:\r\ncase __SI_KILL >> 16:\r\nput_user_ex(from->si_uid, &to->si_uid);\r\nbreak;\r\ncase __SI_POLL >> 16:\r\nput_user_ex(from->si_fd, &to->si_fd);\r\nbreak;\r\ncase __SI_TIMER >> 16:\r\nput_user_ex(from->si_overrun, &to->si_overrun);\r\nput_user_ex(ptr_to_compat(from->si_ptr),\r\n&to->si_ptr);\r\nbreak;\r\ncase __SI_RT >> 16:\r\ncase __SI_MESGQ >> 16:\r\nput_user_ex(from->si_uid, &to->si_uid);\r\nput_user_ex(from->si_int, &to->si_int);\r\nbreak;\r\n}\r\n}\r\n} put_user_catch(err);\r\nreturn err;\r\n}\r\nint copy_siginfo_to_user32(compat_siginfo_t __user *to, const siginfo_t *from)\r\n{\r\nreturn __copy_siginfo_to_user32(to, from, in_x32_syscall());\r\n}\r\nint copy_siginfo_from_user32(siginfo_t *to, compat_siginfo_t __user *from)\r\n{\r\nint err = 0;\r\nu32 ptr32;\r\nif (!access_ok(VERIFY_READ, from, sizeof(compat_siginfo_t)))\r\nreturn -EFAULT;\r\nget_user_try {\r\nget_user_ex(to->si_signo, &from->si_signo);\r\nget_user_ex(to->si_errno, &from->si_errno);\r\nget_user_ex(to->si_code, &from->si_code);\r\nget_user_ex(to->si_pid, &from->si_pid);\r\nget_user_ex(to->si_uid, &from->si_uid);\r\nget_user_ex(ptr32, &from->si_ptr);\r\nto->si_ptr = compat_ptr(ptr32);\r\n} get_user_catch(err);\r\nreturn err;\r\n}

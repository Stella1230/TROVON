static void __init htcherald_lcd_init(void)\r\n{\r\nu32 reg;\r\nunsigned int tries = 200;\r\nreg = omap_readl(OMAP_LCDC_CONTROL);\r\nif (reg & OMAP_LCDC_CTRL_LCD_EN) {\r\nreg &= ~OMAP_LCDC_CTRL_LCD_EN;\r\nomap_writel(reg, OMAP_LCDC_CONTROL);\r\nwhile (!(omap_readl(OMAP_LCDC_STATUS) & OMAP_LCDC_STAT_DONE)) {\r\ntries--;\r\nif (!tries)\r\nbreak;\r\n}\r\nif (!tries)\r\npr_err("Timeout waiting for end of frame -- LCD may not be available\n");\r\nreg = omap_readw(OMAP_DMA_LCD_CCR);\r\nreg &= ~(1 << 7);\r\nomap_writew(reg, OMAP_DMA_LCD_CCR);\r\nreg = omap_readw(OMAP_DMA_LCD_CTRL);\r\nreg &= ~(1 << 8);\r\nomap_writew(reg, OMAP_DMA_LCD_CTRL);\r\n}\r\n}\r\nstatic void __init htcherald_map_io(void)\r\n{\r\nomap7xx_map_io();\r\nhtcherald_lcd_init();\r\nprintk(KERN_INFO "htcherald_map_io done.\n");\r\n}\r\nstatic void __init htcherald_disable_watchdog(void)\r\n{\r\nif (omap_readl(OMAP_WDT_TIMER_MODE) & 0x8000) {\r\nprintk(KERN_WARNING "OMAP850 Watchdog seems to be activated, disabling it for now.\n");\r\nomap_writel(0xF5, OMAP_WDT_TIMER_MODE);\r\nomap_writel(0xA0, OMAP_WDT_TIMER_MODE);\r\n}\r\n}\r\nstatic void __init htcherald_usb_enable(void)\r\n{\r\nunsigned int tries = 20;\r\nunsigned int value = 0;\r\nif (gpio_request(HTCHERALD_GPIO_USB_EN1, "herald_usb") < 0)\r\ngoto err1;\r\nif (gpio_request(HTCHERALD_GPIO_USB_EN2, "herald_usb") < 0)\r\ngoto err2;\r\nif (gpio_request(HTCHERALD_GPIO_USB_DM, "herald_usb") < 0)\r\ngoto err3;\r\nif (gpio_request(HTCHERALD_GPIO_USB_DP, "herald_usb") < 0)\r\ngoto err4;\r\ndo {\r\ngpio_direction_output(HTCHERALD_GPIO_USB_EN1, 0);\r\n} while ((value = gpio_get_value(HTCHERALD_GPIO_USB_EN1)) == 1 &&\r\n--tries);\r\nif (value == 1)\r\nprintk(KERN_WARNING "Unable to reset USB, trying to continue\n");\r\ngpio_direction_output(HTCHERALD_GPIO_USB_EN2, 0);\r\ngpio_direction_input(HTCHERALD_GPIO_USB_DM);\r\ngpio_direction_input(HTCHERALD_GPIO_USB_DP);\r\ngoto done;\r\nerr4:\r\ngpio_free(HTCHERALD_GPIO_USB_DM);\r\nerr3:\r\ngpio_free(HTCHERALD_GPIO_USB_EN2);\r\nerr2:\r\ngpio_free(HTCHERALD_GPIO_USB_EN1);\r\nerr1:\r\nprintk(KERN_ERR "Unabled to request GPIO for USB\n");\r\ndone:\r\nprintk(KERN_INFO "USB setup complete.\n");\r\n}\r\nstatic void __init htcherald_init(void)\r\n{\r\nprintk(KERN_INFO "HTC Herald init.\n");\r\nhtcpld_resources[0].start = gpio_to_irq(HTCHERALD_GIRQ_BTNS);\r\nhtcpld_resources[0].end = gpio_to_irq(HTCHERALD_GIRQ_BTNS);\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nhtcherald_disable_watchdog();\r\nhtcherald_usb_enable();\r\nomap1_usb_init(&htcherald_usb_config);\r\nhtcherald_spi_board_info[0].irq = gpio_to_irq(HTCHERALD_GPIO_TS);\r\nspi_register_board_info(htcherald_spi_board_info,\r\nARRAY_SIZE(htcherald_spi_board_info));\r\nomap_register_i2c_bus(1, 100, NULL, 0);\r\n#if IS_ENABLED(CONFIG_MMC_OMAP)\r\nhtc_mmc_data[0] = &htc_mmc1_data;\r\nomap1_init_mmc(htc_mmc_data, 1);\r\n#endif\r\nomapfb_set_lcd_config(&htcherald_lcd_config);\r\n}

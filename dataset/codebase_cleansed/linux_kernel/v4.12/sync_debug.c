void sync_timeline_debug_add(struct sync_timeline *obj)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sync_timeline_list_lock, flags);\r\nlist_add_tail(&obj->sync_timeline_list, &sync_timeline_list_head);\r\nspin_unlock_irqrestore(&sync_timeline_list_lock, flags);\r\n}\r\nvoid sync_timeline_debug_remove(struct sync_timeline *obj)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sync_timeline_list_lock, flags);\r\nlist_del(&obj->sync_timeline_list);\r\nspin_unlock_irqrestore(&sync_timeline_list_lock, flags);\r\n}\r\nvoid sync_file_debug_add(struct sync_file *sync_file)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sync_file_list_lock, flags);\r\nlist_add_tail(&sync_file->sync_file_list, &sync_file_list_head);\r\nspin_unlock_irqrestore(&sync_file_list_lock, flags);\r\n}\r\nvoid sync_file_debug_remove(struct sync_file *sync_file)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sync_file_list_lock, flags);\r\nlist_del(&sync_file->sync_file_list);\r\nspin_unlock_irqrestore(&sync_file_list_lock, flags);\r\n}\r\nstatic const char *sync_status_str(int status)\r\n{\r\nif (status < 0)\r\nreturn "error";\r\nif (status > 0)\r\nreturn "signaled";\r\nreturn "active";\r\n}\r\nstatic void sync_print_fence(struct seq_file *s,\r\nstruct dma_fence *fence, bool show)\r\n{\r\nstruct sync_timeline *parent = dma_fence_parent(fence);\r\nint status;\r\nstatus = dma_fence_get_status_locked(fence);\r\nseq_printf(s, " %s%sfence %s",\r\nshow ? parent->name : "",\r\nshow ? "_" : "",\r\nsync_status_str(status));\r\nif (status) {\r\nstruct timespec64 ts64 =\r\nktime_to_timespec64(fence->timestamp);\r\nseq_printf(s, "@%lld.%09ld", (s64)ts64.tv_sec, ts64.tv_nsec);\r\n}\r\nif (fence->ops->timeline_value_str &&\r\nfence->ops->fence_value_str) {\r\nchar value[64];\r\nbool success;\r\nfence->ops->fence_value_str(fence, value, sizeof(value));\r\nsuccess = strlen(value);\r\nif (success) {\r\nseq_printf(s, ": %s", value);\r\nfence->ops->timeline_value_str(fence, value,\r\nsizeof(value));\r\nif (strlen(value))\r\nseq_printf(s, " / %s", value);\r\n}\r\n}\r\nseq_puts(s, "\n");\r\n}\r\nstatic void sync_print_obj(struct seq_file *s, struct sync_timeline *obj)\r\n{\r\nstruct list_head *pos;\r\nunsigned long flags;\r\nseq_printf(s, "%s: %d\n", obj->name, obj->value);\r\nspin_lock_irqsave(&obj->child_list_lock, flags);\r\nlist_for_each(pos, &obj->child_list_head) {\r\nstruct sync_pt *pt =\r\ncontainer_of(pos, struct sync_pt, child_list);\r\nsync_print_fence(s, &pt->base, false);\r\n}\r\nspin_unlock_irqrestore(&obj->child_list_lock, flags);\r\n}\r\nstatic void sync_print_sync_file(struct seq_file *s,\r\nstruct sync_file *sync_file)\r\n{\r\nint i;\r\nseq_printf(s, "[%p] %s: %s\n", sync_file, sync_file->name,\r\nsync_status_str(dma_fence_get_status(sync_file->fence)));\r\nif (dma_fence_is_array(sync_file->fence)) {\r\nstruct dma_fence_array *array = to_dma_fence_array(sync_file->fence);\r\nfor (i = 0; i < array->num_fences; ++i)\r\nsync_print_fence(s, array->fences[i], true);\r\n} else {\r\nsync_print_fence(s, sync_file->fence, true);\r\n}\r\n}\r\nstatic int sync_debugfs_show(struct seq_file *s, void *unused)\r\n{\r\nunsigned long flags;\r\nstruct list_head *pos;\r\nseq_puts(s, "objs:\n--------------\n");\r\nspin_lock_irqsave(&sync_timeline_list_lock, flags);\r\nlist_for_each(pos, &sync_timeline_list_head) {\r\nstruct sync_timeline *obj =\r\ncontainer_of(pos, struct sync_timeline,\r\nsync_timeline_list);\r\nsync_print_obj(s, obj);\r\nseq_puts(s, "\n");\r\n}\r\nspin_unlock_irqrestore(&sync_timeline_list_lock, flags);\r\nseq_puts(s, "fences:\n--------------\n");\r\nspin_lock_irqsave(&sync_file_list_lock, flags);\r\nlist_for_each(pos, &sync_file_list_head) {\r\nstruct sync_file *sync_file =\r\ncontainer_of(pos, struct sync_file, sync_file_list);\r\nsync_print_sync_file(s, sync_file);\r\nseq_puts(s, "\n");\r\n}\r\nspin_unlock_irqrestore(&sync_file_list_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int sync_info_debugfs_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, sync_debugfs_show, inode->i_private);\r\n}\r\nstatic __init int sync_debugfs_init(void)\r\n{\r\ndbgfs = debugfs_create_dir("sync", NULL);\r\ndebugfs_create_file_unsafe("info", 0444, dbgfs, NULL,\r\n&sync_info_debugfs_fops);\r\ndebugfs_create_file_unsafe("sw_sync", 0644, dbgfs, NULL,\r\n&sw_sync_debugfs_fops);\r\nreturn 0;\r\n}\r\nvoid sync_dump(void)\r\n{\r\nstruct seq_file s = {\r\n.buf = sync_dump_buf,\r\n.size = sizeof(sync_dump_buf) - 1,\r\n};\r\nint i;\r\nsync_debugfs_show(&s, NULL);\r\nfor (i = 0; i < s.count; i += DUMP_CHUNK) {\r\nif ((s.count - i) > DUMP_CHUNK) {\r\nchar c = s.buf[i + DUMP_CHUNK];\r\ns.buf[i + DUMP_CHUNK] = 0;\r\npr_cont("%s", s.buf + i);\r\ns.buf[i + DUMP_CHUNK] = c;\r\n} else {\r\ns.buf[s.count] = 0;\r\npr_cont("%s", s.buf + i);\r\n}\r\n}\r\n}

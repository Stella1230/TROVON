static int exynos_plane_get_size(int start, unsigned length, unsigned last)\r\n{\r\nint end = start + length;\r\nint size = 0;\r\nif (start <= 0) {\r\nif (end > 0)\r\nsize = min_t(unsigned, end, last);\r\n} else if (start <= last) {\r\nsize = min_t(unsigned, last - start, length);\r\n}\r\nreturn size;\r\n}\r\nstatic void exynos_plane_mode_set(struct exynos_drm_plane_state *exynos_state)\r\n{\r\nstruct drm_plane_state *state = &exynos_state->base;\r\nstruct drm_crtc *crtc = state->crtc;\r\nstruct drm_crtc_state *crtc_state =\r\ndrm_atomic_get_existing_crtc_state(state->state, crtc);\r\nstruct drm_display_mode *mode = &crtc_state->adjusted_mode;\r\nint crtc_x, crtc_y;\r\nunsigned int crtc_w, crtc_h;\r\nunsigned int src_x, src_y;\r\nunsigned int src_w, src_h;\r\nunsigned int actual_w;\r\nunsigned int actual_h;\r\ncrtc_x = state->crtc_x;\r\ncrtc_y = state->crtc_y;\r\ncrtc_w = state->crtc_w;\r\ncrtc_h = state->crtc_h;\r\nsrc_x = state->src_x >> 16;\r\nsrc_y = state->src_y >> 16;\r\nsrc_w = state->src_w >> 16;\r\nsrc_h = state->src_h >> 16;\r\nexynos_state->h_ratio = (src_w << 16) / crtc_w;\r\nexynos_state->v_ratio = (src_h << 16) / crtc_h;\r\nactual_w = exynos_plane_get_size(crtc_x, crtc_w, mode->hdisplay);\r\nactual_h = exynos_plane_get_size(crtc_y, crtc_h, mode->vdisplay);\r\nif (crtc_x < 0) {\r\nif (actual_w)\r\nsrc_x += ((-crtc_x) * exynos_state->h_ratio) >> 16;\r\ncrtc_x = 0;\r\n}\r\nif (crtc_y < 0) {\r\nif (actual_h)\r\nsrc_y += ((-crtc_y) * exynos_state->v_ratio) >> 16;\r\ncrtc_y = 0;\r\n}\r\nexynos_state->src.x = src_x;\r\nexynos_state->src.y = src_y;\r\nexynos_state->src.w = (actual_w * exynos_state->h_ratio) >> 16;\r\nexynos_state->src.h = (actual_h * exynos_state->v_ratio) >> 16;\r\nexynos_state->crtc.x = crtc_x;\r\nexynos_state->crtc.y = crtc_y;\r\nexynos_state->crtc.w = actual_w;\r\nexynos_state->crtc.h = actual_h;\r\nDRM_DEBUG_KMS("plane : offset_x/y(%d,%d), width/height(%d,%d)",\r\nexynos_state->crtc.x, exynos_state->crtc.y,\r\nexynos_state->crtc.w, exynos_state->crtc.h);\r\n}\r\nstatic void exynos_drm_plane_reset(struct drm_plane *plane)\r\n{\r\nstruct exynos_drm_plane *exynos_plane = to_exynos_plane(plane);\r\nstruct exynos_drm_plane_state *exynos_state;\r\nif (plane->state) {\r\nexynos_state = to_exynos_plane_state(plane->state);\r\nif (exynos_state->base.fb)\r\ndrm_framebuffer_unreference(exynos_state->base.fb);\r\nkfree(exynos_state);\r\nplane->state = NULL;\r\n}\r\nexynos_state = kzalloc(sizeof(*exynos_state), GFP_KERNEL);\r\nif (exynos_state) {\r\nplane->state = &exynos_state->base;\r\nplane->state->plane = plane;\r\nplane->state->zpos = exynos_plane->config->zpos;\r\n}\r\n}\r\nstatic struct drm_plane_state *\r\nexynos_drm_plane_duplicate_state(struct drm_plane *plane)\r\n{\r\nstruct exynos_drm_plane_state *exynos_state;\r\nstruct exynos_drm_plane_state *copy;\r\nexynos_state = to_exynos_plane_state(plane->state);\r\ncopy = kzalloc(sizeof(*exynos_state), GFP_KERNEL);\r\nif (!copy)\r\nreturn NULL;\r\n__drm_atomic_helper_plane_duplicate_state(plane, &copy->base);\r\nreturn &copy->base;\r\n}\r\nstatic void exynos_drm_plane_destroy_state(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct exynos_drm_plane_state *old_exynos_state =\r\nto_exynos_plane_state(old_state);\r\n__drm_atomic_helper_plane_destroy_state(old_state);\r\nkfree(old_exynos_state);\r\n}\r\nstatic int\r\nexynos_drm_plane_check_size(const struct exynos_drm_plane_config *config,\r\nstruct exynos_drm_plane_state *state)\r\n{\r\nbool width_ok = false, height_ok = false;\r\nif (config->capabilities & EXYNOS_DRM_PLANE_CAP_SCALE)\r\nreturn 0;\r\nif (state->src.w == state->crtc.w)\r\nwidth_ok = true;\r\nif (state->src.h == state->crtc.h)\r\nheight_ok = true;\r\nif ((config->capabilities & EXYNOS_DRM_PLANE_CAP_DOUBLE) &&\r\nstate->h_ratio == (1 << 15))\r\nwidth_ok = true;\r\nif ((config->capabilities & EXYNOS_DRM_PLANE_CAP_DOUBLE) &&\r\nstate->v_ratio == (1 << 15))\r\nheight_ok = true;\r\nif (width_ok && height_ok)\r\nreturn 0;\r\nDRM_DEBUG_KMS("scaling mode is not supported");\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int exynos_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct exynos_drm_plane *exynos_plane = to_exynos_plane(plane);\r\nstruct exynos_drm_plane_state *exynos_state =\r\nto_exynos_plane_state(state);\r\nint ret = 0;\r\nif (!state->crtc || !state->fb)\r\nreturn 0;\r\nexynos_plane_mode_set(exynos_state);\r\nret = exynos_drm_plane_check_size(exynos_plane->config, exynos_state);\r\nreturn ret;\r\n}\r\nstatic void exynos_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct drm_plane_state *state = plane->state;\r\nstruct exynos_drm_crtc *exynos_crtc = to_exynos_crtc(state->crtc);\r\nstruct exynos_drm_plane *exynos_plane = to_exynos_plane(plane);\r\nif (!state->crtc)\r\nreturn;\r\nplane->crtc = state->crtc;\r\nif (exynos_crtc->ops->update_plane)\r\nexynos_crtc->ops->update_plane(exynos_crtc, exynos_plane);\r\n}\r\nstatic void exynos_plane_atomic_disable(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct exynos_drm_plane *exynos_plane = to_exynos_plane(plane);\r\nstruct exynos_drm_crtc *exynos_crtc = to_exynos_crtc(old_state->crtc);\r\nif (!old_state->crtc)\r\nreturn;\r\nif (exynos_crtc->ops->disable_plane)\r\nexynos_crtc->ops->disable_plane(exynos_crtc, exynos_plane);\r\n}\r\nstatic void exynos_plane_attach_zpos_property(struct drm_plane *plane,\r\nbool immutable)\r\n{\r\nif (immutable)\r\ndrm_plane_create_zpos_immutable_property(plane, 0);\r\nelse\r\ndrm_plane_create_zpos_property(plane, 0, 0, MAX_PLANE - 1);\r\n}\r\nint exynos_plane_init(struct drm_device *dev,\r\nstruct exynos_drm_plane *exynos_plane,\r\nunsigned int index, unsigned long possible_crtcs,\r\nconst struct exynos_drm_plane_config *config)\r\n{\r\nint err;\r\nerr = drm_universal_plane_init(dev, &exynos_plane->base,\r\npossible_crtcs,\r\n&exynos_plane_funcs,\r\nconfig->pixel_formats,\r\nconfig->num_pixel_formats,\r\nconfig->type, NULL);\r\nif (err) {\r\nDRM_ERROR("failed to initialize plane\n");\r\nreturn err;\r\n}\r\ndrm_plane_helper_add(&exynos_plane->base, &plane_helper_funcs);\r\nexynos_plane->index = index;\r\nexynos_plane->config = config;\r\nexynos_plane_attach_zpos_property(&exynos_plane->base,\r\n!(config->capabilities & EXYNOS_DRM_PLANE_CAP_ZPOS));\r\nreturn 0;\r\n}

static void stars(char *str, long val, long max, int width)\r\n{\r\nint i;\r\nfor (i = 0; i < (width * val / max) - 1 && i < width - 1; i++)\r\nstr[i] = '*';\r\nif (val > max)\r\nstr[i - 1] = '+';\r\nstr[i] = '\0';\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nunsigned int nr_cpus = bpf_num_possible_cpus();\r\nconst char *map_filename = "/sys/fs/bpf/tc/globals/lwt_len_hist_map";\r\nuint64_t values[nr_cpus], sum, max_value = 0, data[MAX_INDEX] = {};\r\nuint64_t key = 0, next_key, max_key = 0;\r\nchar starstr[MAX_STARS];\r\nint i, map_fd;\r\nmap_fd = bpf_obj_get(map_filename);\r\nif (map_fd < 0) {\r\nfprintf(stderr, "bpf_obj_get(%s): %s(%d)\n",\r\nmap_filename, strerror(errno), errno);\r\nreturn -1;\r\n}\r\nwhile (bpf_map_get_next_key(map_fd, &key, &next_key) == 0) {\r\nif (next_key >= MAX_INDEX) {\r\nfprintf(stderr, "Key %lu out of bounds\n", next_key);\r\ncontinue;\r\n}\r\nbpf_map_lookup_elem(map_fd, &next_key, values);\r\nsum = 0;\r\nfor (i = 0; i < nr_cpus; i++)\r\nsum += values[i];\r\ndata[next_key] = sum;\r\nif (sum && next_key > max_key)\r\nmax_key = next_key;\r\nif (sum > max_value)\r\nmax_value = sum;\r\nkey = next_key;\r\n}\r\nfor (i = 1; i <= max_key + 1; i++) {\r\nstars(starstr, data[i - 1], max_value, MAX_STARS);\r\nprintf("%8ld -> %-8ld : %-8ld |%-*s|\n",\r\n(1l << i) >> 1, (1l << i) - 1, data[i - 1],\r\nMAX_STARS, starstr);\r\n}\r\nclose(map_fd);\r\nreturn 0;\r\n}

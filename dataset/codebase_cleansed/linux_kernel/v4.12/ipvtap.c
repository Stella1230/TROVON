static const void *ipvtap_net_namespace(struct device *d)\r\n{\r\nstruct net_device *dev = to_net_dev(d->parent);\r\nreturn dev_net(dev);\r\n}\r\nstatic void ipvtap_count_tx_dropped(struct tap_dev *tap)\r\n{\r\nstruct ipvtap_dev *vlantap = container_of(tap, struct ipvtap_dev, tap);\r\nstruct ipvl_dev *vlan = &vlantap->vlan;\r\nthis_cpu_inc(vlan->pcpu_stats->tx_drps);\r\n}\r\nstatic void ipvtap_count_rx_dropped(struct tap_dev *tap)\r\n{\r\nstruct ipvtap_dev *vlantap = container_of(tap, struct ipvtap_dev, tap);\r\nstruct ipvl_dev *vlan = &vlantap->vlan;\r\nipvlan_count_rx(vlan, 0, 0, 0);\r\n}\r\nstatic void ipvtap_update_features(struct tap_dev *tap,\r\nnetdev_features_t features)\r\n{\r\nstruct ipvtap_dev *vlantap = container_of(tap, struct ipvtap_dev, tap);\r\nstruct ipvl_dev *vlan = &vlantap->vlan;\r\nvlan->sfeatures = features;\r\nnetdev_update_features(vlan->dev);\r\n}\r\nstatic int ipvtap_newlink(struct net *src_net,\r\nstruct net_device *dev,\r\nstruct nlattr *tb[],\r\nstruct nlattr *data[])\r\n{\r\nstruct ipvtap_dev *vlantap = netdev_priv(dev);\r\nint err;\r\nINIT_LIST_HEAD(&vlantap->tap.queue_list);\r\nvlantap->tap.tap_features = TUN_OFFLOADS;\r\nvlantap->tap.count_tx_dropped = ipvtap_count_tx_dropped;\r\nvlantap->tap.update_features = ipvtap_update_features;\r\nvlantap->tap.count_rx_dropped = ipvtap_count_rx_dropped;\r\nerr = netdev_rx_handler_register(dev, tap_handle_frame, &vlantap->tap);\r\nif (err)\r\nreturn err;\r\nerr = ipvlan_link_new(src_net, dev, tb, data);\r\nif (err) {\r\nnetdev_rx_handler_unregister(dev);\r\nreturn err;\r\n}\r\nvlantap->tap.dev = vlantap->vlan.dev;\r\nreturn err;\r\n}\r\nstatic void ipvtap_dellink(struct net_device *dev,\r\nstruct list_head *head)\r\n{\r\nstruct ipvtap_dev *vlan = netdev_priv(dev);\r\nnetdev_rx_handler_unregister(dev);\r\ntap_del_queues(&vlan->tap);\r\nipvlan_link_delete(dev, head);\r\n}\r\nstatic void ipvtap_setup(struct net_device *dev)\r\n{\r\nipvlan_link_setup(dev);\r\ndev->tx_queue_len = TUN_READQ_SIZE;\r\ndev->priv_flags &= ~IFF_NO_QUEUE;\r\n}\r\nstatic int ipvtap_device_event(struct notifier_block *unused,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct ipvtap_dev *vlantap;\r\nstruct device *classdev;\r\ndev_t devt;\r\nint err;\r\nchar tap_name[IFNAMSIZ];\r\nif (dev->rtnl_link_ops != &ipvtap_link_ops)\r\nreturn NOTIFY_DONE;\r\nsnprintf(tap_name, IFNAMSIZ, "tap%d", dev->ifindex);\r\nvlantap = netdev_priv(dev);\r\nswitch (event) {\r\ncase NETDEV_REGISTER:\r\nerr = tap_get_minor(ipvtap_major, &vlantap->tap);\r\nif (err)\r\nreturn notifier_from_errno(err);\r\ndevt = MKDEV(MAJOR(ipvtap_major), vlantap->tap.minor);\r\nclassdev = device_create(&ipvtap_class, &dev->dev, devt,\r\ndev, tap_name);\r\nif (IS_ERR(classdev)) {\r\ntap_free_minor(ipvtap_major, &vlantap->tap);\r\nreturn notifier_from_errno(PTR_ERR(classdev));\r\n}\r\nerr = sysfs_create_link(&dev->dev.kobj, &classdev->kobj,\r\ntap_name);\r\nif (err)\r\nreturn notifier_from_errno(err);\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nif (vlantap->tap.minor == 0)\r\nbreak;\r\nsysfs_remove_link(&dev->dev.kobj, tap_name);\r\ndevt = MKDEV(MAJOR(ipvtap_major), vlantap->tap.minor);\r\ndevice_destroy(&ipvtap_class, devt);\r\ntap_free_minor(ipvtap_major, &vlantap->tap);\r\nbreak;\r\ncase NETDEV_CHANGE_TX_QUEUE_LEN:\r\nif (tap_queue_resize(&vlantap->tap))\r\nreturn NOTIFY_BAD;\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int ipvtap_init(void)\r\n{\r\nint err;\r\nerr = tap_create_cdev(&ipvtap_cdev, &ipvtap_major, "ipvtap");\r\nif (err)\r\ngoto out1;\r\nerr = class_register(&ipvtap_class);\r\nif (err)\r\ngoto out2;\r\nerr = register_netdevice_notifier(&ipvtap_notifier_block);\r\nif (err)\r\ngoto out3;\r\nerr = ipvlan_link_register(&ipvtap_link_ops);\r\nif (err)\r\ngoto out4;\r\nreturn 0;\r\nout4:\r\nunregister_netdevice_notifier(&ipvtap_notifier_block);\r\nout3:\r\nclass_unregister(&ipvtap_class);\r\nout2:\r\ntap_destroy_cdev(ipvtap_major, &ipvtap_cdev);\r\nout1:\r\nreturn err;\r\n}\r\nstatic void ipvtap_exit(void)\r\n{\r\nrtnl_link_unregister(&ipvtap_link_ops);\r\nunregister_netdevice_notifier(&ipvtap_notifier_block);\r\nclass_unregister(&ipvtap_class);\r\ntap_destroy_cdev(ipvtap_major, &ipvtap_cdev);\r\n}

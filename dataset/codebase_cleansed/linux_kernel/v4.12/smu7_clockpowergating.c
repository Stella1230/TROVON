static int smu7_enable_disable_uvd_dpm(struct pp_hwmgr *hwmgr, bool enable)\r\n{\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, enable ?\r\nPPSMC_MSG_UVDDPM_Enable :\r\nPPSMC_MSG_UVDDPM_Disable);\r\n}\r\nstatic int smu7_enable_disable_vce_dpm(struct pp_hwmgr *hwmgr, bool enable)\r\n{\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, enable ?\r\nPPSMC_MSG_VCEDPM_Enable :\r\nPPSMC_MSG_VCEDPM_Disable);\r\n}\r\nstatic int smu7_enable_disable_samu_dpm(struct pp_hwmgr *hwmgr, bool enable)\r\n{\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr, enable ?\r\nPPSMC_MSG_SAMUDPM_Enable :\r\nPPSMC_MSG_SAMUDPM_Disable);\r\n}\r\nstatic int smu7_update_uvd_dpm(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nif (!bgate)\r\nsmum_update_smc_table(hwmgr, SMU_UVD_TABLE);\r\nreturn smu7_enable_disable_uvd_dpm(hwmgr, !bgate);\r\n}\r\nstatic int smu7_update_vce_dpm(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nif (!bgate)\r\nsmum_update_smc_table(hwmgr, SMU_VCE_TABLE);\r\nreturn smu7_enable_disable_vce_dpm(hwmgr, !bgate);\r\n}\r\nstatic int smu7_update_samu_dpm(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nif (!bgate)\r\nsmum_update_smc_table(hwmgr, SMU_SAMU_TABLE);\r\nreturn smu7_enable_disable_samu_dpm(hwmgr, !bgate);\r\n}\r\nint smu7_powerdown_uvd(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_uvd_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerOFF);\r\nreturn 0;\r\n}\r\nstatic int smu7_powerup_uvd(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_uvd_power_gating(hwmgr)) {\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_UVDDynamicPowerGating)) {\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerON, 1);\r\n} else {\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerON, 0);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int smu7_powerdown_vce(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_vce_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_VCEPowerOFF);\r\nreturn 0;\r\n}\r\nstatic int smu7_powerup_vce(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_vce_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_VCEPowerON);\r\nreturn 0;\r\n}\r\nstatic int smu7_powerdown_samu(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_SamuPowerGating))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_SAMPowerOFF);\r\nreturn 0;\r\n}\r\nstatic int smu7_powerup_samu(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_SamuPowerGating))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_SAMPowerON);\r\nreturn 0;\r\n}\r\nint smu7_disable_clock_power_gating(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\r\ndata->uvd_power_gated = false;\r\ndata->vce_power_gated = false;\r\ndata->samu_power_gated = false;\r\nsmu7_powerup_uvd(hwmgr);\r\nsmu7_powerup_vce(hwmgr);\r\nsmu7_powerup_samu(hwmgr);\r\nreturn 0;\r\n}\r\nint smu7_powergate_uvd(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\r\ndata->uvd_power_gated = bgate;\r\nif (bgate) {\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_PG_STATE_GATE);\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_CG_STATE_GATE);\r\nsmu7_update_uvd_dpm(hwmgr, true);\r\nsmu7_powerdown_uvd(hwmgr);\r\n} else {\r\nsmu7_powerup_uvd(hwmgr);\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_CG_STATE_UNGATE);\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_CG_STATE_UNGATE);\r\nsmu7_update_uvd_dpm(hwmgr, false);\r\n}\r\nreturn 0;\r\n}\r\nint smu7_powergate_vce(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\r\ndata->vce_power_gated = bgate;\r\nif (bgate) {\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_PG_STATE_GATE);\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_CG_STATE_GATE);\r\nsmu7_update_vce_dpm(hwmgr, true);\r\nsmu7_powerdown_vce(hwmgr);\r\n} else {\r\nsmu7_powerup_vce(hwmgr);\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_CG_STATE_UNGATE);\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_PG_STATE_UNGATE);\r\nsmu7_update_vce_dpm(hwmgr, false);\r\n}\r\nreturn 0;\r\n}\r\nint smu7_powergate_samu(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\r\nif (data->samu_power_gated == bgate)\r\nreturn 0;\r\ndata->samu_power_gated = bgate;\r\nif (bgate) {\r\nsmu7_update_samu_dpm(hwmgr, true);\r\nsmu7_powerdown_samu(hwmgr);\r\n} else {\r\nsmu7_powerup_samu(hwmgr);\r\nsmu7_update_samu_dpm(hwmgr, false);\r\n}\r\nreturn 0;\r\n}\r\nint smu7_update_clock_gatings(struct pp_hwmgr *hwmgr,\r\nconst uint32_t *msg_id)\r\n{\r\nPPSMC_Msg msg;\r\nuint32_t value;\r\nif (!(hwmgr->feature_mask & PP_ENABLE_GFX_CG_THRU_SMU))\r\nreturn 0;\r\nswitch ((*msg_id & PP_GROUP_MASK) >> PP_GROUP_SHIFT) {\r\ncase PP_GROUP_GFX:\r\nswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\r\ncase PP_BLOCK_GFX_CG:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_CGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_CGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_GFX_3D:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_3DCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_3DLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_GFX_RLC:\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_RLC_LS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_GFX_CP:\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_CP_LS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_GFX_MG:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = (CG_CPF_MGCG_MASK | CG_RLC_MGCG_MASK |\r\nCG_GFX_OTHERS_MGCG_MASK);\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_GROUP_SYS:\r\nswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\r\ncase PP_BLOCK_SYS_BIF:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_CG ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_BIF_MGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_BIF_MGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_MC:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_MC_MGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_MC_MGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_DRM:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_CG ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_DRM_MGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_DRM_MGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_HDP:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_HDP_MGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_HDP_MGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_SDMA:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_SDMA_MGCG_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_SDMA_MGLS_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_ROM:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\r\nPPSMC_MSG_EnableClockGatingFeature :\r\nPPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_ROM_MASK;\r\nif (smum_send_msg_to_smc_with_parameter(\r\nhwmgr->smumgr, msg, value))\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint smu7_enable_per_cu_power_gating(struct pp_hwmgr *hwmgr, bool enable)\r\n{\r\nstruct cgs_system_info sys_info = {0};\r\nuint32_t active_cus;\r\nint result;\r\nsys_info.size = sizeof(struct cgs_system_info);\r\nsys_info.info_id = CGS_SYSTEM_INFO_GFX_CU_INFO;\r\nresult = cgs_query_system_info(hwmgr->device, &sys_info);\r\nif (result)\r\nreturn -EINVAL;\r\nactive_cus = sys_info.value;\r\nif (enable)\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_GFX_CU_PG_ENABLE, active_cus);\r\nelse\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_GFX_CU_PG_DISABLE);\r\n}

static int s5c73m3_get_af_status(struct s5c73m3 *state, struct v4l2_ctrl *ctrl)\r\n{\r\nu16 reg = REG_AF_STATUS_UNFOCUSED;\r\nint ret = s5c73m3_read(state, REG_AF_STATUS, &reg);\r\nswitch (reg) {\r\ncase REG_CAF_STATUS_FIND_SEARCH_DIR:\r\ncase REG_AF_STATUS_FOCUSING:\r\ncase REG_CAF_STATUS_FOCUSING:\r\nctrl->val = V4L2_AUTO_FOCUS_STATUS_BUSY;\r\nbreak;\r\ncase REG_CAF_STATUS_FOCUSED:\r\ncase REG_AF_STATUS_FOCUSED:\r\nctrl->val = V4L2_AUTO_FOCUS_STATUS_REACHED;\r\nbreak;\r\ndefault:\r\nv4l2_info(&state->sensor_sd, "Unknown AF status %#x\n", reg);\r\ncase REG_CAF_STATUS_UNFOCUSED:\r\ncase REG_AF_STATUS_UNFOCUSED:\r\ncase REG_AF_STATUS_INVALID:\r\nctrl->val = V4L2_AUTO_FOCUS_STATUS_FAILED;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int s5c73m3_g_volatile_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = ctrl_to_sensor_sd(ctrl);\r\nstruct s5c73m3 *state = sensor_sd_to_s5c73m3(sd);\r\nint ret;\r\nif (state->power == 0)\r\nreturn -EBUSY;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_FOCUS_AUTO:\r\nret = s5c73m3_get_af_status(state, state->ctrls.af_status);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s5c73m3_set_colorfx(struct s5c73m3 *state, int val)\r\n{\r\nstatic const unsigned short colorfx[][2] = {\r\n{ V4L2_COLORFX_NONE, COMM_IMAGE_EFFECT_NONE },\r\n{ V4L2_COLORFX_BW, COMM_IMAGE_EFFECT_MONO },\r\n{ V4L2_COLORFX_SEPIA, COMM_IMAGE_EFFECT_SEPIA },\r\n{ V4L2_COLORFX_NEGATIVE, COMM_IMAGE_EFFECT_NEGATIVE },\r\n{ V4L2_COLORFX_AQUA, COMM_IMAGE_EFFECT_AQUA },\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(colorfx); i++) {\r\nif (colorfx[i][0] != val)\r\ncontinue;\r\nv4l2_dbg(1, s5c73m3_dbg, &state->sensor_sd,\r\n"Setting %s color effect\n",\r\nv4l2_ctrl_get_menu(state->ctrls.colorfx->id)[i]);\r\nreturn s5c73m3_isp_command(state, COMM_IMAGE_EFFECT,\r\ncolorfx[i][1]);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int s5c73m3_set_exposure(struct s5c73m3 *state, int auto_exp)\r\n{\r\nstruct v4l2_subdev *sd = &state->sensor_sd;\r\nstruct s5c73m3_ctrls *ctrls = &state->ctrls;\r\nint ret = 0;\r\nif (ctrls->exposure_metering->is_new) {\r\nu16 metering;\r\nswitch (ctrls->exposure_metering->val) {\r\ncase V4L2_EXPOSURE_METERING_CENTER_WEIGHTED:\r\nmetering = COMM_METERING_CENTER;\r\nbreak;\r\ncase V4L2_EXPOSURE_METERING_SPOT:\r\nmetering = COMM_METERING_SPOT;\r\nbreak;\r\ndefault:\r\nmetering = COMM_METERING_AVERAGE;\r\nbreak;\r\n}\r\nret = s5c73m3_isp_command(state, COMM_METERING, metering);\r\n}\r\nif (!ret && ctrls->exposure_bias->is_new) {\r\nu16 exp_bias = ctrls->exposure_bias->val;\r\nret = s5c73m3_isp_command(state, COMM_EV, exp_bias);\r\n}\r\nv4l2_dbg(1, s5c73m3_dbg, sd,\r\n"%s: exposure bias: %#x, metering: %#x (%d)\n", __func__,\r\nctrls->exposure_bias->val, ctrls->exposure_metering->val, ret);\r\nreturn ret;\r\n}\r\nstatic int s5c73m3_set_white_balance(struct s5c73m3 *state, int val)\r\n{\r\nstatic const unsigned short wb[][2] = {\r\n{ V4L2_WHITE_BALANCE_INCANDESCENT, COMM_AWB_MODE_INCANDESCENT},\r\n{ V4L2_WHITE_BALANCE_FLUORESCENT, COMM_AWB_MODE_FLUORESCENT1},\r\n{ V4L2_WHITE_BALANCE_FLUORESCENT_H, COMM_AWB_MODE_FLUORESCENT2},\r\n{ V4L2_WHITE_BALANCE_CLOUDY, COMM_AWB_MODE_CLOUDY},\r\n{ V4L2_WHITE_BALANCE_DAYLIGHT, COMM_AWB_MODE_DAYLIGHT},\r\n{ V4L2_WHITE_BALANCE_AUTO, COMM_AWB_MODE_AUTO},\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wb); i++) {\r\nif (wb[i][0] != val)\r\ncontinue;\r\nv4l2_dbg(1, s5c73m3_dbg, &state->sensor_sd,\r\n"Setting white balance to: %s\n",\r\nv4l2_ctrl_get_menu(state->ctrls.auto_wb->id)[i]);\r\nreturn s5c73m3_isp_command(state, COMM_AWB_MODE, wb[i][1]);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int s5c73m3_af_run(struct s5c73m3 *state, bool on)\r\n{\r\nstruct s5c73m3_ctrls *c = &state->ctrls;\r\nif (!on)\r\nreturn s5c73m3_isp_command(state, COMM_AF_CON,\r\nCOMM_AF_CON_STOP);\r\nif (c->focus_auto->val)\r\nreturn s5c73m3_isp_command(state, COMM_AF_MODE,\r\nCOMM_AF_MODE_PREVIEW_CAF_START);\r\nreturn s5c73m3_isp_command(state, COMM_AF_CON, COMM_AF_CON_START);\r\n}\r\nstatic int s5c73m3_3a_lock(struct s5c73m3 *state, struct v4l2_ctrl *ctrl)\r\n{\r\nbool awb_lock = ctrl->val & V4L2_LOCK_WHITE_BALANCE;\r\nbool ae_lock = ctrl->val & V4L2_LOCK_EXPOSURE;\r\nbool af_lock = ctrl->val & V4L2_LOCK_FOCUS;\r\nint ret = 0;\r\nif ((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_EXPOSURE) {\r\nret = s5c73m3_isp_command(state, COMM_AE_CON,\r\nae_lock ? COMM_AE_STOP : COMM_AE_START);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_WHITE_BALANCE)\r\n&& state->ctrls.auto_wb->val) {\r\nret = s5c73m3_isp_command(state, COMM_AWB_CON,\r\nawb_lock ? COMM_AWB_STOP : COMM_AWB_START);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_FOCUS)\r\nret = s5c73m3_af_run(state, !af_lock);\r\nreturn ret;\r\n}\r\nstatic int s5c73m3_set_auto_focus(struct s5c73m3 *state, int caf)\r\n{\r\nstruct s5c73m3_ctrls *c = &state->ctrls;\r\nint ret = 1;\r\nif (c->af_distance->is_new) {\r\nu16 mode = (c->af_distance->val == V4L2_AUTO_FOCUS_RANGE_MACRO)\r\n? COMM_AF_MODE_MACRO : COMM_AF_MODE_NORMAL;\r\nret = s5c73m3_isp_command(state, COMM_AF_MODE, mode);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nif (!ret || (c->focus_auto->is_new && c->focus_auto->val) ||\r\nc->af_start->is_new)\r\nret = s5c73m3_af_run(state, 1);\r\nelse if ((c->focus_auto->is_new && !c->focus_auto->val) ||\r\nc->af_stop->is_new)\r\nret = s5c73m3_af_run(state, 0);\r\nelse\r\nret = 0;\r\nreturn ret;\r\n}\r\nstatic int s5c73m3_set_contrast(struct s5c73m3 *state, int val)\r\n{\r\nu16 reg = (val < 0) ? -val + 2 : val;\r\nreturn s5c73m3_isp_command(state, COMM_CONTRAST, reg);\r\n}\r\nstatic int s5c73m3_set_saturation(struct s5c73m3 *state, int val)\r\n{\r\nu16 reg = (val < 0) ? -val + 2 : val;\r\nreturn s5c73m3_isp_command(state, COMM_SATURATION, reg);\r\n}\r\nstatic int s5c73m3_set_sharpness(struct s5c73m3 *state, int val)\r\n{\r\nu16 reg = (val < 0) ? -val + 2 : val;\r\nreturn s5c73m3_isp_command(state, COMM_SHARPNESS, reg);\r\n}\r\nstatic int s5c73m3_set_iso(struct s5c73m3 *state, int val)\r\n{\r\nu32 iso;\r\nif (val == V4L2_ISO_SENSITIVITY_MANUAL)\r\niso = state->ctrls.iso->val + 1;\r\nelse\r\niso = 0;\r\nreturn s5c73m3_isp_command(state, COMM_ISO, iso);\r\n}\r\nstatic int s5c73m3_set_stabilization(struct s5c73m3 *state, int val)\r\n{\r\nstruct v4l2_subdev *sd = &state->sensor_sd;\r\nv4l2_dbg(1, s5c73m3_dbg, sd, "Image stabilization: %d\n", val);\r\nreturn s5c73m3_isp_command(state, COMM_FRAME_RATE, val ?\r\nCOMM_FRAME_RATE_ANTI_SHAKE : COMM_FRAME_RATE_AUTO_SET);\r\n}\r\nstatic int s5c73m3_set_jpeg_quality(struct s5c73m3 *state, int quality)\r\n{\r\nint reg;\r\nif (quality <= 65)\r\nreg = COMM_IMAGE_QUALITY_NORMAL;\r\nelse if (quality <= 75)\r\nreg = COMM_IMAGE_QUALITY_FINE;\r\nelse\r\nreg = COMM_IMAGE_QUALITY_SUPERFINE;\r\nreturn s5c73m3_isp_command(state, COMM_IMAGE_QUALITY, reg);\r\n}\r\nstatic int s5c73m3_set_scene_program(struct s5c73m3 *state, int val)\r\n{\r\nstatic const unsigned short scene_lookup[] = {\r\nCOMM_SCENE_MODE_NONE,\r\nCOMM_SCENE_MODE_AGAINST_LIGHT,\r\nCOMM_SCENE_MODE_BEACH,\r\nCOMM_SCENE_MODE_CANDLE,\r\nCOMM_SCENE_MODE_DAWN,\r\nCOMM_SCENE_MODE_FALL,\r\nCOMM_SCENE_MODE_FIRE,\r\nCOMM_SCENE_MODE_LANDSCAPE,\r\nCOMM_SCENE_MODE_NIGHT,\r\nCOMM_SCENE_MODE_INDOOR,\r\nCOMM_SCENE_MODE_PORTRAIT,\r\nCOMM_SCENE_MODE_SPORTS,\r\nCOMM_SCENE_MODE_SUNSET,\r\nCOMM_SCENE_MODE_TEXT,\r\n};\r\nv4l2_dbg(1, s5c73m3_dbg, &state->sensor_sd, "Setting %s scene mode\n",\r\nv4l2_ctrl_get_menu(state->ctrls.scene_mode->id)[val]);\r\nreturn s5c73m3_isp_command(state, COMM_SCENE_MODE, scene_lookup[val]);\r\n}\r\nstatic int s5c73m3_set_power_line_freq(struct s5c73m3 *state, int val)\r\n{\r\nunsigned int pwr_line_freq = COMM_FLICKER_NONE;\r\nswitch (val) {\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_DISABLED:\r\npwr_line_freq = COMM_FLICKER_NONE;\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_50HZ:\r\npwr_line_freq = COMM_FLICKER_AUTO_50HZ;\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_60HZ:\r\npwr_line_freq = COMM_FLICKER_AUTO_60HZ;\r\nbreak;\r\ndefault:\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_AUTO:\r\npwr_line_freq = COMM_FLICKER_NONE;\r\n}\r\nreturn s5c73m3_isp_command(state, COMM_FLICKER_MODE, pwr_line_freq);\r\n}\r\nstatic int s5c73m3_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = ctrl_to_sensor_sd(ctrl);\r\nstruct s5c73m3 *state = sensor_sd_to_s5c73m3(sd);\r\nint ret = 0;\r\nv4l2_dbg(1, s5c73m3_dbg, sd, "set_ctrl: %s, value: %d\n",\r\nctrl->name, ctrl->val);\r\nmutex_lock(&state->lock);\r\nif (state->power == 0)\r\ngoto unlock;\r\nif (ctrl->flags & V4L2_CTRL_FLAG_INACTIVE) {\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_3A_LOCK:\r\nret = s5c73m3_3a_lock(state, ctrl);\r\nbreak;\r\ncase V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE:\r\nret = s5c73m3_set_white_balance(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\nret = s5c73m3_set_contrast(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_COLORFX:\r\nret = s5c73m3_set_colorfx(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_AUTO:\r\nret = s5c73m3_set_exposure(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_FOCUS_AUTO:\r\nret = s5c73m3_set_auto_focus(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_IMAGE_STABILIZATION:\r\nret = s5c73m3_set_stabilization(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_ISO_SENSITIVITY:\r\nret = s5c73m3_set_iso(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_JPEG_COMPRESSION_QUALITY:\r\nret = s5c73m3_set_jpeg_quality(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY:\r\nret = s5c73m3_set_power_line_freq(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nret = s5c73m3_set_saturation(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SCENE_MODE:\r\nret = s5c73m3_set_scene_program(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SHARPNESS:\r\nret = s5c73m3_set_sharpness(state, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_WIDE_DYNAMIC_RANGE:\r\nret = s5c73m3_isp_command(state, COMM_WDR, !!ctrl->val);\r\nbreak;\r\ncase V4L2_CID_ZOOM_ABSOLUTE:\r\nret = s5c73m3_isp_command(state, COMM_ZOOM_STEP, ctrl->val);\r\nbreak;\r\n}\r\nunlock:\r\nmutex_unlock(&state->lock);\r\nreturn ret;\r\n}\r\nint s5c73m3_init_controls(struct s5c73m3 *state)\r\n{\r\nconst struct v4l2_ctrl_ops *ops = &s5c73m3_ctrl_ops;\r\nstruct s5c73m3_ctrls *ctrls = &state->ctrls;\r\nstruct v4l2_ctrl_handler *hdl = &ctrls->handler;\r\nint ret = v4l2_ctrl_handler_init(hdl, 22);\r\nif (ret)\r\nreturn ret;\r\nctrls->auto_wb = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_AUTO_N_PRESET_WHITE_BALANCE,\r\n9, ~0x15e, V4L2_WHITE_BALANCE_AUTO);\r\nctrls->auto_exposure = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_EXPOSURE_AUTO, 0, ~0x01, V4L2_EXPOSURE_AUTO);\r\nctrls->exposure_bias = v4l2_ctrl_new_int_menu(hdl, ops,\r\nV4L2_CID_AUTO_EXPOSURE_BIAS,\r\nARRAY_SIZE(ev_bias_qmenu) - 1,\r\nARRAY_SIZE(ev_bias_qmenu)/2 - 1,\r\nev_bias_qmenu);\r\nctrls->exposure_metering = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_EXPOSURE_METERING,\r\n2, ~0x7, V4L2_EXPOSURE_METERING_AVERAGE);\r\nctrls->focus_auto = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_FOCUS_AUTO, 0, 1, 1, 0);\r\nctrls->af_start = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_AUTO_FOCUS_START, 0, 1, 1, 0);\r\nctrls->af_stop = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_AUTO_FOCUS_STOP, 0, 1, 1, 0);\r\nctrls->af_status = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_AUTO_FOCUS_STATUS, 0,\r\n(V4L2_AUTO_FOCUS_STATUS_BUSY |\r\nV4L2_AUTO_FOCUS_STATUS_REACHED |\r\nV4L2_AUTO_FOCUS_STATUS_FAILED),\r\n0, V4L2_AUTO_FOCUS_STATUS_IDLE);\r\nctrls->af_distance = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_AUTO_FOCUS_RANGE,\r\nV4L2_AUTO_FOCUS_RANGE_MACRO,\r\n~(1 << V4L2_AUTO_FOCUS_RANGE_NORMAL |\r\n1 << V4L2_AUTO_FOCUS_RANGE_MACRO),\r\nV4L2_AUTO_FOCUS_RANGE_NORMAL);\r\nctrls->auto_iso = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_ISO_SENSITIVITY_AUTO, 1, 0,\r\nV4L2_ISO_SENSITIVITY_AUTO);\r\nctrls->iso = v4l2_ctrl_new_int_menu(hdl, ops,\r\nV4L2_CID_ISO_SENSITIVITY, ARRAY_SIZE(iso_qmenu) - 1,\r\nARRAY_SIZE(iso_qmenu)/2 - 1, iso_qmenu);\r\nctrls->contrast = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_CONTRAST, -2, 2, 1, 0);\r\nctrls->saturation = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_SATURATION, -2, 2, 1, 0);\r\nctrls->sharpness = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_SHARPNESS, -2, 2, 1, 0);\r\nctrls->zoom = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_ZOOM_ABSOLUTE, 0, 30, 1, 0);\r\nctrls->colorfx = v4l2_ctrl_new_std_menu(hdl, ops, V4L2_CID_COLORFX,\r\nV4L2_COLORFX_AQUA, ~0x40f, V4L2_COLORFX_NONE);\r\nctrls->wdr = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_WIDE_DYNAMIC_RANGE, 0, 1, 1, 0);\r\nctrls->stabilization = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_IMAGE_STABILIZATION, 0, 1, 1, 0);\r\nv4l2_ctrl_new_std_menu(hdl, ops, V4L2_CID_POWER_LINE_FREQUENCY,\r\nV4L2_CID_POWER_LINE_FREQUENCY_AUTO, 0,\r\nV4L2_CID_POWER_LINE_FREQUENCY_AUTO);\r\nctrls->jpeg_quality = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_JPEG_COMPRESSION_QUALITY, 1, 100, 1, 80);\r\nctrls->scene_mode = v4l2_ctrl_new_std_menu(hdl, ops,\r\nV4L2_CID_SCENE_MODE, V4L2_SCENE_MODE_TEXT, ~0x3fff,\r\nV4L2_SCENE_MODE_NONE);\r\nctrls->aaa_lock = v4l2_ctrl_new_std(hdl, ops,\r\nV4L2_CID_3A_LOCK, 0, 0x7, 0, 0);\r\nif (hdl->error) {\r\nret = hdl->error;\r\nv4l2_ctrl_handler_free(hdl);\r\nreturn ret;\r\n}\r\nv4l2_ctrl_auto_cluster(3, &ctrls->auto_exposure, 0, false);\r\nctrls->auto_iso->flags |= V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_UPDATE;\r\nv4l2_ctrl_auto_cluster(2, &ctrls->auto_iso, 0, false);\r\nctrls->af_status->flags |= V4L2_CTRL_FLAG_VOLATILE;\r\nv4l2_ctrl_cluster(6, &ctrls->focus_auto);\r\nstate->sensor_sd.ctrl_handler = hdl;\r\nreturn 0;\r\n}

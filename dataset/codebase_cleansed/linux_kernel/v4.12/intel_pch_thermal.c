static void pch_wpt_add_acpi_psv_trip(struct pch_thermal_device *ptd,\r\nint *nr_trips)\r\n{\r\nstruct acpi_device *adev;\r\nptd->psv_trip_id = -1;\r\nadev = ACPI_COMPANION(&ptd->pdev->dev);\r\nif (adev) {\r\nunsigned long long r;\r\nacpi_status status;\r\nstatus = acpi_evaluate_integer(adev->handle, "_PSV", NULL,\r\n&r);\r\nif (ACPI_SUCCESS(status)) {\r\nunsigned long trip_temp;\r\ntrip_temp = DECI_KELVIN_TO_MILLICELSIUS(r);\r\nif (trip_temp) {\r\nptd->psv_temp = trip_temp;\r\nptd->psv_trip_id = *nr_trips;\r\n++(*nr_trips);\r\n}\r\n}\r\n}\r\n}\r\nstatic void pch_wpt_add_acpi_psv_trip(struct pch_thermal_device *ptd,\r\nint *nr_trips)\r\n{\r\nptd->psv_trip_id = -1;\r\n}\r\nstatic int pch_wpt_init(struct pch_thermal_device *ptd, int *nr_trips)\r\n{\r\nu8 tsel;\r\nu16 trip_temp;\r\n*nr_trips = 0;\r\nif (WPT_TSS_TSDSS & readb(ptd->hw_base + WPT_TSS)) {\r\nptd->bios_enabled = true;\r\ngoto read_trips;\r\n}\r\ntsel = readb(ptd->hw_base + WPT_TSEL);\r\nif (tsel & WPT_TSEL_PLDB) {\r\ndev_err(&ptd->pdev->dev, "Sensor can't be enabled\n");\r\nreturn -ENODEV;\r\n}\r\nwriteb(tsel|WPT_TSEL_ETS, ptd->hw_base + WPT_TSEL);\r\nif (!(WPT_TSS_TSDSS & readb(ptd->hw_base + WPT_TSS))) {\r\ndev_err(&ptd->pdev->dev, "Sensor can't be enabled\n");\r\nreturn -ENODEV;\r\n}\r\nread_trips:\r\nptd->crt_trip_id = -1;\r\ntrip_temp = readw(ptd->hw_base + WPT_CTT);\r\ntrip_temp &= 0x1FF;\r\nif (trip_temp) {\r\nptd->crt_temp = trip_temp * 1000 / 2 - 50000;\r\nptd->crt_trip_id = 0;\r\n++(*nr_trips);\r\n}\r\nptd->hot_trip_id = -1;\r\ntrip_temp = readw(ptd->hw_base + WPT_PHL);\r\ntrip_temp &= 0x1FF;\r\nif (trip_temp) {\r\nptd->hot_temp = trip_temp * 1000 / 2 - 50000;\r\nptd->hot_trip_id = *nr_trips;\r\n++(*nr_trips);\r\n}\r\npch_wpt_add_acpi_psv_trip(ptd, nr_trips);\r\nreturn 0;\r\n}\r\nstatic int pch_wpt_get_temp(struct pch_thermal_device *ptd, int *temp)\r\n{\r\nu8 wpt_temp;\r\nwpt_temp = WPT_TEMP_TSR & readl(ptd->hw_base + WPT_TEMP);\r\n*temp = (wpt_temp * 1000 / 2 - 50000);\r\nreturn 0;\r\n}\r\nstatic int pch_wpt_suspend(struct pch_thermal_device *ptd)\r\n{\r\nu8 tsel;\r\nif (ptd->bios_enabled)\r\nreturn 0;\r\ntsel = readb(ptd->hw_base + WPT_TSEL);\r\nwriteb(tsel & 0xFE, ptd->hw_base + WPT_TSEL);\r\nreturn 0;\r\n}\r\nstatic int pch_wpt_resume(struct pch_thermal_device *ptd)\r\n{\r\nu8 tsel;\r\nif (ptd->bios_enabled)\r\nreturn 0;\r\ntsel = readb(ptd->hw_base + WPT_TSEL);\r\nwriteb(tsel | WPT_TSEL_ETS, ptd->hw_base + WPT_TSEL);\r\nreturn 0;\r\n}\r\nstatic int pch_thermal_get_temp(struct thermal_zone_device *tzd, int *temp)\r\n{\r\nstruct pch_thermal_device *ptd = tzd->devdata;\r\nreturn ptd->ops->get_temp(ptd, temp);\r\n}\r\nstatic int pch_get_trip_type(struct thermal_zone_device *tzd, int trip,\r\nenum thermal_trip_type *type)\r\n{\r\nstruct pch_thermal_device *ptd = tzd->devdata;\r\nif (ptd->crt_trip_id == trip)\r\n*type = THERMAL_TRIP_CRITICAL;\r\nelse if (ptd->hot_trip_id == trip)\r\n*type = THERMAL_TRIP_HOT;\r\nelse if (ptd->psv_trip_id == trip)\r\n*type = THERMAL_TRIP_PASSIVE;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int pch_get_trip_temp(struct thermal_zone_device *tzd, int trip, int *temp)\r\n{\r\nstruct pch_thermal_device *ptd = tzd->devdata;\r\nif (ptd->crt_trip_id == trip)\r\n*temp = ptd->crt_temp;\r\nelse if (ptd->hot_trip_id == trip)\r\n*temp = ptd->hot_temp;\r\nelse if (ptd->psv_trip_id == trip)\r\n*temp = ptd->psv_temp;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int intel_pch_thermal_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nenum board_ids board_id = id->driver_data;\r\nconst struct board_info *bi = &board_info[board_id];\r\nstruct pch_thermal_device *ptd;\r\nint err;\r\nint nr_trips;\r\nptd = devm_kzalloc(&pdev->dev, sizeof(*ptd), GFP_KERNEL);\r\nif (!ptd)\r\nreturn -ENOMEM;\r\nptd->ops = bi->ops;\r\npci_set_drvdata(pdev, ptd);\r\nptd->pdev = pdev;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to enable pci device\n");\r\nreturn err;\r\n}\r\nerr = pci_request_regions(pdev, driver_name);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to request pci region\n");\r\ngoto error_disable;\r\n}\r\nptd->hw_base = pci_ioremap_bar(pdev, 0);\r\nif (!ptd->hw_base) {\r\nerr = -ENOMEM;\r\ndev_err(&pdev->dev, "failed to map mem base\n");\r\ngoto error_release;\r\n}\r\nerr = ptd->ops->hw_init(ptd, &nr_trips);\r\nif (err)\r\ngoto error_cleanup;\r\nptd->tzd = thermal_zone_device_register(bi->name, nr_trips, 0, ptd,\r\n&tzd_ops, NULL, 0, 0);\r\nif (IS_ERR(ptd->tzd)) {\r\ndev_err(&pdev->dev, "Failed to register thermal zone %s\n",\r\nbi->name);\r\nerr = PTR_ERR(ptd->tzd);\r\ngoto error_cleanup;\r\n}\r\nreturn 0;\r\nerror_cleanup:\r\niounmap(ptd->hw_base);\r\nerror_release:\r\npci_release_regions(pdev);\r\nerror_disable:\r\npci_disable_device(pdev);\r\ndev_err(&pdev->dev, "pci device failed to probe\n");\r\nreturn err;\r\n}\r\nstatic void intel_pch_thermal_remove(struct pci_dev *pdev)\r\n{\r\nstruct pch_thermal_device *ptd = pci_get_drvdata(pdev);\r\nthermal_zone_device_unregister(ptd->tzd);\r\niounmap(ptd->hw_base);\r\npci_set_drvdata(pdev, NULL);\r\npci_release_region(pdev, 0);\r\npci_disable_device(pdev);\r\n}\r\nstatic int intel_pch_thermal_suspend(struct device *device)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(device);\r\nstruct pch_thermal_device *ptd = pci_get_drvdata(pdev);\r\nreturn ptd->ops->suspend(ptd);\r\n}\r\nstatic int intel_pch_thermal_resume(struct device *device)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(device);\r\nstruct pch_thermal_device *ptd = pci_get_drvdata(pdev);\r\nreturn ptd->ops->resume(ptd);\r\n}

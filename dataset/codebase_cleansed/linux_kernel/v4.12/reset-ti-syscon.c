static int ti_syscon_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct ti_syscon_reset_data *data = to_ti_syscon_reset_data(rcdev);\r\nstruct ti_syscon_reset_control *control;\r\nunsigned int mask, value;\r\nif (id >= data->nr_controls)\r\nreturn -EINVAL;\r\ncontrol = &data->controls[id];\r\nif (control->flags & ASSERT_NONE)\r\nreturn -ENOTSUPP;\r\nmask = BIT(control->assert_bit);\r\nvalue = (control->flags & ASSERT_SET) ? mask : 0x0;\r\nreturn regmap_update_bits(data->regmap, control->assert_offset, mask, value);\r\n}\r\nstatic int ti_syscon_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct ti_syscon_reset_data *data = to_ti_syscon_reset_data(rcdev);\r\nstruct ti_syscon_reset_control *control;\r\nunsigned int mask, value;\r\nif (id >= data->nr_controls)\r\nreturn -EINVAL;\r\ncontrol = &data->controls[id];\r\nif (control->flags & DEASSERT_NONE)\r\nreturn -ENOTSUPP;\r\nmask = BIT(control->deassert_bit);\r\nvalue = (control->flags & DEASSERT_SET) ? mask : 0x0;\r\nreturn regmap_update_bits(data->regmap, control->deassert_offset, mask, value);\r\n}\r\nstatic int ti_syscon_reset_status(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct ti_syscon_reset_data *data = to_ti_syscon_reset_data(rcdev);\r\nstruct ti_syscon_reset_control *control;\r\nunsigned int reset_state;\r\nint ret;\r\nif (id >= data->nr_controls)\r\nreturn -EINVAL;\r\ncontrol = &data->controls[id];\r\nif (control->flags & STATUS_NONE)\r\nreturn -ENOTSUPP;\r\nret = regmap_read(data->regmap, control->status_offset, &reset_state);\r\nif (ret)\r\nreturn ret;\r\nreturn !(reset_state & BIT(control->status_bit)) ==\r\n!(control->flags & STATUS_SET);\r\n}\r\nstatic int ti_syscon_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct ti_syscon_reset_data *data;\r\nstruct regmap *regmap;\r\nconst __be32 *list;\r\nstruct ti_syscon_reset_control *controls;\r\nint size, nr_controls, i;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nregmap = syscon_node_to_regmap(np->parent);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nlist = of_get_property(np, "ti,reset-bits", &size);\r\nif (!list || (size / sizeof(*list)) % 7 != 0) {\r\ndev_err(dev, "invalid DT reset description\n");\r\nreturn -EINVAL;\r\n}\r\nnr_controls = (size / sizeof(*list)) / 7;\r\ncontrols = devm_kzalloc(dev, nr_controls * sizeof(*controls), GFP_KERNEL);\r\nif (!controls)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < nr_controls; i++) {\r\ncontrols[i].assert_offset = be32_to_cpup(list++);\r\ncontrols[i].assert_bit = be32_to_cpup(list++);\r\ncontrols[i].deassert_offset = be32_to_cpup(list++);\r\ncontrols[i].deassert_bit = be32_to_cpup(list++);\r\ncontrols[i].status_offset = be32_to_cpup(list++);\r\ncontrols[i].status_bit = be32_to_cpup(list++);\r\ncontrols[i].flags = be32_to_cpup(list++);\r\n}\r\ndata->rcdev.ops = &ti_syscon_reset_ops;\r\ndata->rcdev.owner = THIS_MODULE;\r\ndata->rcdev.of_node = np;\r\ndata->rcdev.nr_resets = nr_controls;\r\ndata->regmap = regmap;\r\ndata->controls = controls;\r\ndata->nr_controls = nr_controls;\r\nplatform_set_drvdata(pdev, data);\r\nreturn devm_reset_controller_register(dev, &data->rcdev);\r\n}

static void no_printf(unsigned char *x, ...)\r\n{\r\n}\r\nvoid diva_get_vserial_number(PISDN_ADAPTER IoAdapter, char *buf)\r\n{\r\nint contr = 0;\r\nif ((contr = ((IoAdapter->serialNo & 0xff000000) >> 24))) {\r\nsprintf(buf, "%d-%d",\r\nIoAdapter->serialNo & 0x00ffffff, contr + 1);\r\n} else {\r\nsprintf(buf, "%d", IoAdapter->serialNo);\r\n}\r\n}\r\nvoid diva_xdi_didd_register_adapter(int card)\r\n{\r\nDESCRIPTOR d;\r\nIDI_SYNC_REQ req;\r\nif (card && ((card - 1) < MAX_ADAPTER) &&\r\nIoAdapters[card - 1] && Requests[card - 1]) {\r\nd.type = IoAdapters[card - 1]->Properties.DescType;\r\nd.request = Requests[card - 1];\r\nd.channels = IoAdapters[card - 1]->Properties.Channels;\r\nd.features = IoAdapters[card - 1]->Properties.Features;\r\nDBG_TRC(("DIDD register A(%d) channels=%d", card,\r\nd.channels))\r\nstrlcpy(IoAdapters[card - 1]->Name,\r\nIoAdapters[card - 1]->Properties.Name,\r\nsizeof(IoAdapters[card - 1]->Name));\r\nreq.didd_remove_adapter.e.Req = 0;\r\nreq.didd_add_adapter.e.Rc = IDI_SYNC_REQ_DIDD_ADD_ADAPTER;\r\nreq.didd_add_adapter.info.descriptor = (void *) &d;\r\nDAdapter.request((ENTITY *)&req);\r\nif (req.didd_add_adapter.e.Rc != 0xff) {\r\nDBG_ERR(("DIDD register A(%d) failed !", card))\r\n}\r\nIoAdapters[card - 1]->os_trap_nfy_Fnc = NULL;\r\n}\r\n}\r\nvoid diva_xdi_didd_remove_adapter(int card)\r\n{\r\nIDI_SYNC_REQ req;\r\nADAPTER *a = &IoAdapters[card - 1]->a;\r\nIoAdapters[card - 1]->os_trap_nfy_Fnc = NULL;\r\nDBG_TRC(("DIDD de-register A(%d)", card))\r\nreq.didd_remove_adapter.e.Req = 0;\r\nreq.didd_remove_adapter.e.Rc = IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER;\r\nreq.didd_remove_adapter.info.p_request =\r\n(IDI_CALL) Requests[card - 1];\r\nDAdapter.request((ENTITY *)&req);\r\nmemset(&(a->IdTable), 0x00, 256);\r\n}\r\nstatic void start_dbg(void)\r\n{\r\nDbgRegister("DIVAS", DRIVERRELEASE_DIVAS, (debugmask) ? debugmask : DBG_DEFAULT);\r\nDBG_LOG(("DIVA ISDNXDI BUILD (%s[%s])",\r\nDIVA_BUILD, diva_xdi_common_code_build))\r\n}\r\nstatic void stop_dbg(void)\r\n{\r\nDbgDeregister();\r\nmemset(&MAdapter, 0, sizeof(MAdapter));\r\ndprintf = no_printf;\r\n}\r\nstatic void *didd_callback(void *context, DESCRIPTOR *adapter,\r\nint removal)\r\n{\r\nif (adapter->type == IDI_DADAPTER) {\r\nDBG_ERR(("Notification about IDI_DADAPTER change ! Oops."));\r\nreturn (NULL);\r\n}\r\nif (adapter->type == IDI_DIMAINT) {\r\nif (removal) {\r\nstop_dbg();\r\n} else {\r\nmemcpy(&MAdapter, adapter, sizeof(MAdapter));\r\ndprintf = (DIVA_DI_PRINTF) MAdapter.request;\r\nstart_dbg();\r\n}\r\n}\r\nreturn (NULL);\r\n}\r\nstatic int __init connect_didd(void)\r\n{\r\nint x = 0;\r\nint dadapter = 0;\r\nIDI_SYNC_REQ req;\r\nDESCRIPTOR DIDD_Table[MAX_DESCRIPTORS];\r\nDIVA_DIDD_Read(DIDD_Table, sizeof(DIDD_Table));\r\nfor (x = 0; x < MAX_DESCRIPTORS; x++) {\r\nif (DIDD_Table[x].type == IDI_DADAPTER) {\r\ndadapter = 1;\r\nmemcpy(&DAdapter, &DIDD_Table[x], sizeof(DAdapter));\r\nreq.didd_notify.e.Req = 0;\r\nreq.didd_notify.e.Rc =\r\nIDI_SYNC_REQ_DIDD_REGISTER_ADAPTER_NOTIFY;\r\nreq.didd_notify.info.callback = (void *)didd_callback;\r\nreq.didd_notify.info.context = NULL;\r\nDAdapter.request((ENTITY *)&req);\r\nif (req.didd_notify.e.Rc != 0xff) {\r\nstop_dbg();\r\nreturn (0);\r\n}\r\nnotify_handle = req.didd_notify.info.handle;\r\n} else if (DIDD_Table[x].type == IDI_DIMAINT) {\r\nmemcpy(&MAdapter, &DIDD_Table[x], sizeof(DAdapter));\r\ndprintf = (DIVA_DI_PRINTF) MAdapter.request;\r\nstart_dbg();\r\n}\r\n}\r\nif (!dadapter) {\r\nstop_dbg();\r\n}\r\nreturn (dadapter);\r\n}\r\nstatic void disconnect_didd(void)\r\n{\r\nIDI_SYNC_REQ req;\r\nstop_dbg();\r\nreq.didd_notify.e.Req = 0;\r\nreq.didd_notify.e.Rc = IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER_NOTIFY;\r\nreq.didd_notify.info.handle = notify_handle;\r\nDAdapter.request((ENTITY *)&req);\r\n}\r\nint __init divasfunc_init(int dbgmask)\r\n{\r\nchar *version;\r\ndebugmask = dbgmask;\r\nif (!connect_didd()) {\r\nDBG_ERR(("divasfunc: failed to connect to DIDD."))\r\nreturn (0);\r\n}\r\nversion = diva_xdi_common_code_build;\r\ndivasa_xdi_driver_entry();\r\nreturn (1);\r\n}\r\nvoid divasfunc_exit(void)\r\n{\r\ndivasa_xdi_driver_unload();\r\ndisconnect_didd();\r\n}

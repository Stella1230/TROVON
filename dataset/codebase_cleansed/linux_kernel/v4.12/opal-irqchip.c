void opal_handle_events(uint64_t events)\r\n{\r\nint virq, hwirq = 0;\r\nu64 mask = opal_event_irqchip.mask;\r\nif (!in_irq() && (events & mask)) {\r\nlast_outstanding_events = events;\r\nirq_work_queue(&opal_event_irq_work);\r\nreturn;\r\n}\r\nwhile (events & mask) {\r\nhwirq = fls64(events) - 1;\r\nif (BIT_ULL(hwirq) & mask) {\r\nvirq = irq_find_mapping(opal_event_irqchip.domain,\r\nhwirq);\r\nif (virq)\r\ngeneric_handle_irq(virq);\r\n}\r\nevents &= ~BIT_ULL(hwirq);\r\n}\r\n}\r\nstatic void opal_event_mask(struct irq_data *d)\r\n{\r\nclear_bit(d->hwirq, &opal_event_irqchip.mask);\r\n}\r\nstatic void opal_event_unmask(struct irq_data *d)\r\n{\r\n__be64 events;\r\nset_bit(d->hwirq, &opal_event_irqchip.mask);\r\nopal_poll_events(&events);\r\nlast_outstanding_events = be64_to_cpu(events);\r\nif (last_outstanding_events & opal_event_irqchip.mask)\r\nirq_work_queue(&opal_event_irq_work);\r\n}\r\nstatic int opal_event_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nif (flow_type != IRQ_TYPE_LEVEL_HIGH)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int opal_event_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hwirq)\r\n{\r\nirq_set_chip_data(irq, &opal_event_irqchip);\r\nirq_set_chip_and_handler(irq, &opal_event_irqchip.irqchip,\r\nhandle_level_irq);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t opal_interrupt(int irq, void *data)\r\n{\r\n__be64 events;\r\nopal_handle_interrupt(virq_to_hw(irq), &events);\r\nopal_handle_events(be64_to_cpu(events));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void opal_handle_irq_work(struct irq_work *work)\r\n{\r\nopal_handle_events(last_outstanding_events);\r\n}\r\nstatic int opal_event_match(struct irq_domain *h, struct device_node *node,\r\nenum irq_domain_bus_token bus_token)\r\n{\r\nreturn irq_domain_get_of_node(h) == node;\r\n}\r\nstatic int opal_event_xlate(struct irq_domain *h, struct device_node *np,\r\nconst u32 *intspec, unsigned int intsize,\r\nirq_hw_number_t *out_hwirq, unsigned int *out_flags)\r\n{\r\n*out_hwirq = intspec[0];\r\n*out_flags = IRQ_TYPE_LEVEL_HIGH;\r\nreturn 0;\r\n}\r\nvoid opal_event_shutdown(void)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < opal_irq_count; i++) {\r\nif (opal_irqs[i])\r\nfree_irq(opal_irqs[i], NULL);\r\nopal_irqs[i] = 0;\r\n}\r\n}\r\nint __init opal_event_init(void)\r\n{\r\nstruct device_node *dn, *opal_node;\r\nconst char **names;\r\nu32 *irqs;\r\nint i, rc;\r\nopal_node = of_find_node_by_path("/ibm,opal");\r\nif (!opal_node) {\r\npr_warn("opal: Node not found\n");\r\nreturn -ENODEV;\r\n}\r\ndn = of_find_compatible_node(NULL, NULL, "ibm,opal-event");\r\nopal_event_irqchip.domain = irq_domain_add_linear(dn, MAX_NUM_EVENTS,\r\n&opal_event_domain_ops, &opal_event_irqchip);\r\nof_node_put(dn);\r\nif (!opal_event_irqchip.domain) {\r\npr_warn("opal: Unable to create irq domain\n");\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nrc = of_property_count_u32_elems(opal_node, "opal-interrupts");\r\nif (rc < 0)\r\ngoto out;\r\nopal_irq_count = rc;\r\npr_debug("Found %d interrupts reserved for OPAL\n", opal_irq_count);\r\nirqs = kcalloc(opal_irq_count, sizeof(*irqs), GFP_KERNEL);\r\nnames = kcalloc(opal_irq_count, sizeof(*names), GFP_KERNEL);\r\nopal_irqs = kcalloc(opal_irq_count, sizeof(*opal_irqs), GFP_KERNEL);\r\nif (WARN_ON(!irqs || !names || !opal_irqs))\r\ngoto out_free;\r\nrc = of_property_read_u32_array(opal_node, "opal-interrupts",\r\nirqs, opal_irq_count);\r\nif (rc < 0) {\r\npr_err("Error %d reading opal-interrupts array\n", rc);\r\ngoto out_free;\r\n}\r\nof_property_read_string_array(opal_node, "opal-interrupts-names",\r\nnames, opal_irq_count);\r\nfor (i = 0; i < opal_irq_count; i++) {\r\nunsigned int virq;\r\nchar *name;\r\nvirq = irq_create_mapping(NULL, irqs[i]);\r\nif (!virq) {\r\npr_warn("Failed to map irq 0x%x\n", irqs[i]);\r\ncontinue;\r\n}\r\nif (names[i] && strlen(names[i]))\r\nname = kasprintf(GFP_KERNEL, "opal-%s", names[i]);\r\nelse\r\nname = kasprintf(GFP_KERNEL, "opal");\r\nrc = request_irq(virq, opal_interrupt, IRQF_TRIGGER_LOW,\r\nname, NULL);\r\nif (rc) {\r\nirq_dispose_mapping(virq);\r\npr_warn("Error %d requesting irq %d (0x%x)\n",\r\nrc, virq, irqs[i]);\r\ncontinue;\r\n}\r\nopal_irqs[i] = virq;\r\n}\r\nout_free:\r\nkfree(irqs);\r\nkfree(names);\r\nout:\r\nof_node_put(opal_node);\r\nreturn rc;\r\n}\r\nint opal_event_request(unsigned int opal_event_nr)\r\n{\r\nif (WARN_ON_ONCE(!opal_event_irqchip.domain))\r\nreturn 0;\r\nreturn irq_create_mapping(opal_event_irqchip.domain, opal_event_nr);\r\n}

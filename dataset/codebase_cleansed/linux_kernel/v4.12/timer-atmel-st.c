static inline unsigned long read_CRTR(void)\r\n{\r\nunsigned int x1, x2;\r\nregmap_read(regmap_st, AT91_ST_CRTR, &x1);\r\ndo {\r\nregmap_read(regmap_st, AT91_ST_CRTR, &x2);\r\nif (x1 == x2)\r\nbreak;\r\nx1 = x2;\r\n} while (1);\r\nreturn x1;\r\n}\r\nstatic irqreturn_t at91rm9200_timer_interrupt(int irq, void *dev_id)\r\n{\r\nu32 sr;\r\nregmap_read(regmap_st, AT91_ST_SR, &sr);\r\nsr &= irqmask;\r\nWARN_ON_ONCE(!irqs_disabled());\r\nif (sr & AT91_ST_ALMS) {\r\nclkevt.event_handler(&clkevt);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (sr & AT91_ST_PITS) {\r\nu32 crtr = read_CRTR();\r\nwhile (((crtr - last_crtr) & AT91_ST_CRTV) >= timer_latch) {\r\nlast_crtr += timer_latch;\r\nclkevt.event_handler(&clkevt);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic u64 read_clk32k(struct clocksource *cs)\r\n{\r\nreturn read_CRTR();\r\n}\r\nstatic void clkdev32k_disable_and_flush_irq(void)\r\n{\r\nunsigned int val;\r\nregmap_write(regmap_st, AT91_ST_IDR, AT91_ST_PITS | AT91_ST_ALMS);\r\nregmap_read(regmap_st, AT91_ST_SR, &val);\r\nlast_crtr = read_CRTR();\r\n}\r\nstatic int clkevt32k_shutdown(struct clock_event_device *evt)\r\n{\r\nclkdev32k_disable_and_flush_irq();\r\nirqmask = 0;\r\nregmap_write(regmap_st, AT91_ST_IER, irqmask);\r\nreturn 0;\r\n}\r\nstatic int clkevt32k_set_oneshot(struct clock_event_device *dev)\r\n{\r\nclkdev32k_disable_and_flush_irq();\r\nirqmask = AT91_ST_ALMS;\r\nregmap_write(regmap_st, AT91_ST_RTAR, last_crtr);\r\nregmap_write(regmap_st, AT91_ST_IER, irqmask);\r\nreturn 0;\r\n}\r\nstatic int clkevt32k_set_periodic(struct clock_event_device *dev)\r\n{\r\nclkdev32k_disable_and_flush_irq();\r\nirqmask = AT91_ST_PITS;\r\nregmap_write(regmap_st, AT91_ST_PIMR, timer_latch);\r\nregmap_write(regmap_st, AT91_ST_IER, irqmask);\r\nreturn 0;\r\n}\r\nstatic int\r\nclkevt32k_next_event(unsigned long delta, struct clock_event_device *dev)\r\n{\r\nu32 alm;\r\nint status = 0;\r\nunsigned int val;\r\nBUG_ON(delta < 2);\r\nalm = read_CRTR();\r\nregmap_write(regmap_st, AT91_ST_RTAR, alm);\r\nregmap_read(regmap_st, AT91_ST_SR, &val);\r\nalm += delta;\r\nregmap_write(regmap_st, AT91_ST_RTAR, alm);\r\nreturn status;\r\n}\r\nstatic int __init atmel_st_timer_init(struct device_node *node)\r\n{\r\nstruct clk *sclk;\r\nunsigned int sclk_rate, val;\r\nint irq, ret;\r\nregmap_st = syscon_node_to_regmap(node);\r\nif (IS_ERR(regmap_st)) {\r\npr_err("Unable to get regmap\n");\r\nreturn PTR_ERR(regmap_st);\r\n}\r\nregmap_write(regmap_st, AT91_ST_IDR,\r\nAT91_ST_PITS | AT91_ST_WDOVF | AT91_ST_RTTINC | AT91_ST_ALMS);\r\nregmap_read(regmap_st, AT91_ST_SR, &val);\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (!irq) {\r\npr_err("Unable to get IRQ from DT\n");\r\nreturn -EINVAL;\r\n}\r\nret = request_irq(irq, at91rm9200_timer_interrupt,\r\nIRQF_SHARED | IRQF_TIMER | IRQF_IRQPOLL,\r\n"at91_tick", regmap_st);\r\nif (ret) {\r\npr_err("Unable to setup IRQ\n");\r\nreturn ret;\r\n}\r\nsclk = of_clk_get(node, 0);\r\nif (IS_ERR(sclk)) {\r\npr_err("Unable to get slow clock\n");\r\nreturn PTR_ERR(sclk);\r\n}\r\nret = clk_prepare_enable(sclk);\r\nif (ret) {\r\npr_err("Could not enable slow clock\n");\r\nreturn ret;\r\n}\r\nsclk_rate = clk_get_rate(sclk);\r\nif (!sclk_rate) {\r\npr_err("Invalid slow clock rate\n");\r\nreturn -EINVAL;\r\n}\r\ntimer_latch = (sclk_rate + HZ / 2) / HZ;\r\nregmap_write(regmap_st, AT91_ST_RTMR, 1);\r\nclkevt.cpumask = cpumask_of(0);\r\nclockevents_config_and_register(&clkevt, sclk_rate,\r\n2, AT91_ST_ALMV);\r\nreturn clocksource_register_hz(&clk32k, sclk_rate);\r\n}

static int __init is_memory(efi_memory_desc_t *md)\r\n{\r\nif (md->attribute & (EFI_MEMORY_WB|EFI_MEMORY_WT|EFI_MEMORY_WC))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic phys_addr_t efi_to_phys(unsigned long addr)\r\n{\r\nefi_memory_desc_t *md;\r\nfor_each_efi_memory_desc(md) {\r\nif (!(md->attribute & EFI_MEMORY_RUNTIME))\r\ncontinue;\r\nif (md->virt_addr == 0)\r\nbreak;\r\nif (md->virt_addr <= addr &&\r\n(addr - md->virt_addr) < (md->num_pages << EFI_PAGE_SHIFT))\r\nreturn md->phys_addr + addr - md->virt_addr;\r\n}\r\nreturn addr;\r\n}\r\nstatic void __init init_screen_info(void)\r\n{\r\nstruct screen_info *si;\r\nif (screen_info_table != EFI_INVALID_TABLE_ADDR) {\r\nsi = early_memremap_ro(screen_info_table, sizeof(*si));\r\nif (!si) {\r\npr_err("Could not map screen_info config table\n");\r\nreturn;\r\n}\r\nscreen_info = *si;\r\nearly_memunmap(si, sizeof(*si));\r\nscreen_info.orig_video_cols = 80;\r\nscreen_info.orig_video_lines = 25;\r\n}\r\nif (screen_info.orig_video_isVGA == VIDEO_TYPE_EFI &&\r\nmemblock_is_map_memory(screen_info.lfb_base))\r\nmemblock_mark_nomap(screen_info.lfb_base, screen_info.lfb_size);\r\n}\r\nstatic int __init uefi_init(void)\r\n{\r\nefi_char16_t *c16;\r\nvoid *config_tables;\r\nsize_t table_size;\r\nchar vendor[100] = "unknown";\r\nint i, retval;\r\nefi.systab = early_memremap_ro(efi_system_table,\r\nsizeof(efi_system_table_t));\r\nif (efi.systab == NULL) {\r\npr_warn("Unable to map EFI system table.\n");\r\nreturn -ENOMEM;\r\n}\r\nset_bit(EFI_BOOT, &efi.flags);\r\nif (IS_ENABLED(CONFIG_64BIT))\r\nset_bit(EFI_64BIT, &efi.flags);\r\nif (efi.systab->hdr.signature != EFI_SYSTEM_TABLE_SIGNATURE) {\r\npr_err("System table signature incorrect\n");\r\nretval = -EINVAL;\r\ngoto out;\r\n}\r\nif ((efi.systab->hdr.revision >> 16) < 2)\r\npr_warn("Warning: EFI system table version %d.%02d, expected 2.00 or greater\n",\r\nefi.systab->hdr.revision >> 16,\r\nefi.systab->hdr.revision & 0xffff);\r\nefi.runtime_version = efi.systab->hdr.revision;\r\nc16 = early_memremap_ro(efi_to_phys(efi.systab->fw_vendor),\r\nsizeof(vendor) * sizeof(efi_char16_t));\r\nif (c16) {\r\nfor (i = 0; i < (int) sizeof(vendor) - 1 && *c16; ++i)\r\nvendor[i] = c16[i];\r\nvendor[i] = '\0';\r\nearly_memunmap(c16, sizeof(vendor) * sizeof(efi_char16_t));\r\n}\r\npr_info("EFI v%u.%.02u by %s\n",\r\nefi.systab->hdr.revision >> 16,\r\nefi.systab->hdr.revision & 0xffff, vendor);\r\ntable_size = sizeof(efi_config_table_64_t) * efi.systab->nr_tables;\r\nconfig_tables = early_memremap_ro(efi_to_phys(efi.systab->tables),\r\ntable_size);\r\nif (config_tables == NULL) {\r\npr_warn("Unable to map EFI config table array.\n");\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\nretval = efi_config_parse_tables(config_tables, efi.systab->nr_tables,\r\nsizeof(efi_config_table_t),\r\narch_tables);\r\nearly_memunmap(config_tables, table_size);\r\nout:\r\nearly_memunmap(efi.systab, sizeof(efi_system_table_t));\r\nreturn retval;\r\n}\r\nstatic __init int is_usable_memory(efi_memory_desc_t *md)\r\n{\r\nswitch (md->type) {\r\ncase EFI_LOADER_CODE:\r\ncase EFI_LOADER_DATA:\r\ncase EFI_BOOT_SERVICES_CODE:\r\ncase EFI_BOOT_SERVICES_DATA:\r\ncase EFI_CONVENTIONAL_MEMORY:\r\ncase EFI_PERSISTENT_MEMORY:\r\nreturn (md->attribute & EFI_MEMORY_WB);\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}\r\nstatic __init void reserve_regions(void)\r\n{\r\nefi_memory_desc_t *md;\r\nu64 paddr, npages, size;\r\nif (efi_enabled(EFI_DBG))\r\npr_info("Processing EFI memory map:\n");\r\nmemblock_dump_all();\r\nmemblock_remove(0, (phys_addr_t)ULLONG_MAX);\r\nfor_each_efi_memory_desc(md) {\r\npaddr = md->phys_addr;\r\nnpages = md->num_pages;\r\nif (efi_enabled(EFI_DBG)) {\r\nchar buf[64];\r\npr_info(" 0x%012llx-0x%012llx %s\n",\r\npaddr, paddr + (npages << EFI_PAGE_SHIFT) - 1,\r\nefi_md_typeattr_format(buf, sizeof(buf), md));\r\n}\r\nmemrange_efi_to_native(&paddr, &npages);\r\nsize = npages << PAGE_SHIFT;\r\nif (is_memory(md)) {\r\nearly_init_dt_add_memory_arch(paddr, size);\r\nif (!is_usable_memory(md))\r\nmemblock_mark_nomap(paddr, size);\r\n}\r\n}\r\n}\r\nvoid __init efi_init(void)\r\n{\r\nstruct efi_memory_map_data data;\r\nstruct efi_fdt_params params;\r\nif (!efi_get_fdt_params(&params))\r\nreturn;\r\nefi_system_table = params.system_table;\r\ndata.desc_version = params.desc_ver;\r\ndata.desc_size = params.desc_size;\r\ndata.size = params.mmap_size;\r\ndata.phys_map = params.mmap;\r\nif (efi_memmap_init_early(&data) < 0) {\r\npanic("Unable to map EFI memory map.\n");\r\n}\r\nWARN(efi.memmap.desc_version != 1,\r\n"Unexpected EFI_MEMORY_DESCRIPTOR version %ld",\r\nefi.memmap.desc_version);\r\nif (uefi_init() < 0) {\r\nefi_memmap_unmap();\r\nreturn;\r\n}\r\nreserve_regions();\r\nefi_esrt_init();\r\nefi_memmap_unmap();\r\nmemblock_reserve(params.mmap & PAGE_MASK,\r\nPAGE_ALIGN(params.mmap_size +\r\n(params.mmap & ~PAGE_MASK)));\r\ninit_screen_info();\r\n}\r\nstatic int __init register_gop_device(void)\r\n{\r\nvoid *pd;\r\nif (screen_info.orig_video_isVGA != VIDEO_TYPE_EFI)\r\nreturn 0;\r\npd = platform_device_register_data(NULL, "efi-framebuffer", 0,\r\n&screen_info, sizeof(screen_info));\r\nreturn PTR_ERR_OR_ZERO(pd);\r\n}

static struct resource *get_platform_resource(struct vfio_platform_device *vdev,\r\nint num)\r\n{\r\nstruct platform_device *dev = (struct platform_device *) vdev->opaque;\r\nint i;\r\nfor (i = 0; i < dev->num_resources; i++) {\r\nstruct resource *r = &dev->resource[i];\r\nif (resource_type(r) & (IORESOURCE_MEM|IORESOURCE_IO)) {\r\nif (!num)\r\nreturn r;\r\nnum--;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic int get_platform_irq(struct vfio_platform_device *vdev, int i)\r\n{\r\nstruct platform_device *pdev = (struct platform_device *) vdev->opaque;\r\nreturn platform_get_irq(pdev, i);\r\n}\r\nstatic int vfio_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct vfio_platform_device *vdev;\r\nint ret;\r\nvdev = kzalloc(sizeof(*vdev), GFP_KERNEL);\r\nif (!vdev)\r\nreturn -ENOMEM;\r\nvdev->opaque = (void *) pdev;\r\nvdev->name = pdev->name;\r\nvdev->flags = VFIO_DEVICE_FLAGS_PLATFORM;\r\nvdev->get_resource = get_platform_resource;\r\nvdev->get_irq = get_platform_irq;\r\nvdev->parent_module = THIS_MODULE;\r\nvdev->reset_required = reset_required;\r\nret = vfio_platform_probe_common(vdev, &pdev->dev);\r\nif (ret)\r\nkfree(vdev);\r\nreturn ret;\r\n}\r\nstatic int vfio_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct vfio_platform_device *vdev;\r\nvdev = vfio_platform_remove_common(&pdev->dev);\r\nif (vdev) {\r\nkfree(vdev);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}

static enum i40iw_status_code i40iw_nop_1(struct i40iw_qp_uk *qp)\r\n{\r\nu64 header, *wqe;\r\nu64 *wqe_0 = NULL;\r\nu32 wqe_idx, peek_head;\r\nbool signaled = false;\r\nif (!qp->sq_ring.head)\r\nreturn I40IW_ERR_PARAM;\r\nwqe_idx = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nwqe = qp->sq_base[wqe_idx].elem;\r\nqp->sq_wrtrk_array[wqe_idx].wqe_size = I40IW_QP_WQE_MIN_SIZE;\r\npeek_head = (qp->sq_ring.head + 1) % qp->sq_ring.size;\r\nwqe_0 = qp->sq_base[peek_head].elem;\r\nif (peek_head)\r\nwqe_0[3] = LS_64(!qp->swqe_polarity, I40IWQPSQ_VALID);\r\nelse\r\nwqe_0[3] = LS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8, 0);\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_NOP, I40IWQPSQ_OPCODE) |\r\nLS_64(signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID) | nop_signature++;\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nreturn 0;\r\n}\r\nvoid i40iw_qp_post_wr(struct i40iw_qp_uk *qp)\r\n{\r\nu64 temp;\r\nu32 hw_sq_tail;\r\nu32 sw_sq_head;\r\nmb();\r\nget_64bit_val(qp->shadow_area, 0, &temp);\r\nhw_sq_tail = (u32)RS_64(temp, I40IW_QP_DBSA_HW_SQ_TAIL);\r\nsw_sq_head = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nif (sw_sq_head != hw_sq_tail) {\r\nif (sw_sq_head > qp->initial_ring.head) {\r\nif ((hw_sq_tail >= qp->initial_ring.head) &&\r\n(hw_sq_tail < sw_sq_head)) {\r\nwritel(qp->qp_id, qp->wqe_alloc_reg);\r\n}\r\n} else if (sw_sq_head != qp->initial_ring.head) {\r\nif ((hw_sq_tail >= qp->initial_ring.head) ||\r\n(hw_sq_tail < sw_sq_head)) {\r\nwritel(qp->qp_id, qp->wqe_alloc_reg);\r\n}\r\n}\r\n}\r\nqp->initial_ring.head = qp->sq_ring.head;\r\n}\r\nstatic void i40iw_qp_ring_push_db(struct i40iw_qp_uk *qp, u32 wqe_idx)\r\n{\r\nset_32bit_val(qp->push_db, 0, LS_32((wqe_idx >> 2), I40E_PFPE_WQEALLOC_WQE_DESC_INDEX) | qp->qp_id);\r\nqp->initial_ring.head = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\n}\r\nu64 *i40iw_qp_get_next_send_wqe(struct i40iw_qp_uk *qp,\r\nu32 *wqe_idx,\r\nu8 wqe_size,\r\nu32 total_size,\r\nu64 wr_id\r\n)\r\n{\r\nu64 *wqe = NULL;\r\nu64 wqe_ptr;\r\nu32 peek_head = 0;\r\nu16 offset;\r\nenum i40iw_status_code ret_code = 0;\r\nu8 nop_wqe_cnt = 0, i;\r\nu64 *wqe_0 = NULL;\r\n*wqe_idx = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nif (!*wqe_idx)\r\nqp->swqe_polarity = !qp->swqe_polarity;\r\nwqe_ptr = (uintptr_t)qp->sq_base[*wqe_idx].elem;\r\noffset = (u16)(wqe_ptr) & 0x7F;\r\nif ((offset + wqe_size) > I40IW_QP_WQE_MAX_SIZE) {\r\nnop_wqe_cnt = (u8)(I40IW_QP_WQE_MAX_SIZE - offset) / I40IW_QP_WQE_MIN_SIZE;\r\nfor (i = 0; i < nop_wqe_cnt; i++) {\r\ni40iw_nop_1(qp);\r\nI40IW_RING_MOVE_HEAD(qp->sq_ring, ret_code);\r\nif (ret_code)\r\nreturn NULL;\r\n}\r\n*wqe_idx = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nif (!*wqe_idx)\r\nqp->swqe_polarity = !qp->swqe_polarity;\r\n}\r\nif (((*wqe_idx & 3) == 1) && (wqe_size == I40IW_WQE_SIZE_64)) {\r\ni40iw_nop_1(qp);\r\nI40IW_RING_MOVE_HEAD(qp->sq_ring, ret_code);\r\nif (ret_code)\r\nreturn NULL;\r\n*wqe_idx = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nif (!*wqe_idx)\r\nqp->swqe_polarity = !qp->swqe_polarity;\r\n}\r\nI40IW_RING_MOVE_HEAD_BY_COUNT(qp->sq_ring,\r\nwqe_size / I40IW_QP_WQE_MIN_SIZE, ret_code);\r\nif (ret_code)\r\nreturn NULL;\r\nwqe = qp->sq_base[*wqe_idx].elem;\r\npeek_head = I40IW_RING_GETCURRENT_HEAD(qp->sq_ring);\r\nwqe_0 = qp->sq_base[peek_head].elem;\r\nif (((peek_head & 3) == 1) || ((peek_head & 3) == 3)) {\r\nif (RS_64(wqe_0[3], I40IWQPSQ_VALID) != !qp->swqe_polarity)\r\nwqe_0[3] = LS_64(!qp->swqe_polarity, I40IWQPSQ_VALID);\r\n}\r\nqp->sq_wrtrk_array[*wqe_idx].wrid = wr_id;\r\nqp->sq_wrtrk_array[*wqe_idx].wr_len = total_size;\r\nqp->sq_wrtrk_array[*wqe_idx].wqe_size = wqe_size;\r\nreturn wqe;\r\n}\r\nstatic void i40iw_set_fragment(u64 *wqe, u32 offset, struct i40iw_sge *sge)\r\n{\r\nif (sge) {\r\nset_64bit_val(wqe, offset, LS_64(sge->tag_off, I40IWQPSQ_FRAG_TO));\r\nset_64bit_val(wqe, (offset + 8),\r\n(LS_64(sge->len, I40IWQPSQ_FRAG_LEN) |\r\nLS_64(sge->stag, I40IWQPSQ_FRAG_STAG)));\r\n}\r\n}\r\nu64 *i40iw_qp_get_next_recv_wqe(struct i40iw_qp_uk *qp, u32 *wqe_idx)\r\n{\r\nu64 *wqe = NULL;\r\nenum i40iw_status_code ret_code;\r\nif (I40IW_RING_FULL_ERR(qp->rq_ring))\r\nreturn NULL;\r\nI40IW_ATOMIC_RING_MOVE_HEAD(qp->rq_ring, *wqe_idx, ret_code);\r\nif (ret_code)\r\nreturn NULL;\r\nif (!*wqe_idx)\r\nqp->rwqe_polarity = !qp->rwqe_polarity;\r\nwqe = qp->rq_base[*wqe_idx * (qp->rq_wqe_size_multiplier >> 2)].elem;\r\nreturn wqe;\r\n}\r\nstatic enum i40iw_status_code i40iw_rdma_write(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nbool post_sq)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nstruct i40iw_rdma_write *op_info;\r\nu32 i, wqe_idx;\r\nu32 total_size = 0, byte_off;\r\nenum i40iw_status_code ret_code;\r\nbool read_fence = false;\r\nu8 wqe_size;\r\nop_info = &info->op.rdma_write;\r\nif (op_info->num_lo_sges > qp->max_sq_frag_cnt)\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\nfor (i = 0; i < op_info->num_lo_sges; i++)\r\ntotal_size += op_info->lo_sg_list[i].len;\r\nif (total_size > I40IW_MAX_OUTBOUND_MESSAGE_SIZE)\r\nreturn I40IW_ERR_QP_INVALID_MSG_SIZE;\r\nread_fence |= info->read_fence;\r\nret_code = i40iw_fragcnt_to_wqesize_sq(op_info->num_lo_sges, &wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, wqe_size, total_size, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nset_64bit_val(wqe, 16,\r\nLS_64(op_info->rem_addr.tag_off, I40IWQPSQ_FRAG_TO));\r\nif (!op_info->rem_addr.stag)\r\nreturn I40IW_ERR_BAD_STAG;\r\nheader = LS_64(op_info->rem_addr.stag, I40IWQPSQ_REMSTAG) |\r\nLS_64(I40IWQP_OP_RDMA_WRITE, I40IWQPSQ_OPCODE) |\r\nLS_64((op_info->num_lo_sges > 1 ? (op_info->num_lo_sges - 1) : 0), I40IWQPSQ_ADDFRAGCNT) |\r\nLS_64(read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(info->local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_set_fragment(wqe, 0, op_info->lo_sg_list);\r\nfor (i = 1, byte_off = 32; i < op_info->num_lo_sges; i++) {\r\ni40iw_set_fragment(wqe, byte_off, &op_info->lo_sg_list[i]);\r\nbyte_off += 16;\r\n}\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_rdma_read(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nbool inv_stag,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_rdma_read *op_info;\r\nu64 header;\r\nu32 wqe_idx;\r\nenum i40iw_status_code ret_code;\r\nu8 wqe_size;\r\nbool local_fence = false;\r\nop_info = &info->op.rdma_read;\r\nret_code = i40iw_fragcnt_to_wqesize_sq(1, &wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, wqe_size, op_info->lo_addr.len, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nlocal_fence |= info->local_fence;\r\nset_64bit_val(wqe, 16, LS_64(op_info->rem_addr.tag_off, I40IWQPSQ_FRAG_TO));\r\nheader = LS_64(op_info->rem_addr.stag, I40IWQPSQ_REMSTAG) |\r\nLS_64((inv_stag ? I40IWQP_OP_RDMA_READ_LOC_INV : I40IWQP_OP_RDMA_READ), I40IWQPSQ_OPCODE) |\r\nLS_64(info->read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_set_fragment(wqe, 0, &op_info->lo_addr);\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_send(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nu32 stag_to_inv,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_post_send *op_info;\r\nu64 header;\r\nu32 i, wqe_idx, total_size = 0, byte_off;\r\nenum i40iw_status_code ret_code;\r\nbool read_fence = false;\r\nu8 wqe_size;\r\nop_info = &info->op.send;\r\nif (qp->max_sq_frag_cnt < op_info->num_sges)\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\nfor (i = 0; i < op_info->num_sges; i++)\r\ntotal_size += op_info->sg_list[i].len;\r\nret_code = i40iw_fragcnt_to_wqesize_sq(op_info->num_sges, &wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, wqe_size, total_size, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nread_fence |= info->read_fence;\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(stag_to_inv, I40IWQPSQ_REMSTAG) |\r\nLS_64(info->op_type, I40IWQPSQ_OPCODE) |\r\nLS_64((op_info->num_sges > 1 ? (op_info->num_sges - 1) : 0),\r\nI40IWQPSQ_ADDFRAGCNT) |\r\nLS_64(read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(info->local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_set_fragment(wqe, 0, op_info->sg_list);\r\nfor (i = 1, byte_off = 32; i < op_info->num_sges; i++) {\r\ni40iw_set_fragment(wqe, byte_off, &op_info->sg_list[i]);\r\nbyte_off += 16;\r\n}\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_inline_rdma_write(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu8 *dest, *src;\r\nstruct i40iw_inline_rdma_write *op_info;\r\nu64 *push;\r\nu64 header = 0;\r\nu32 wqe_idx;\r\nenum i40iw_status_code ret_code;\r\nbool read_fence = false;\r\nu8 wqe_size;\r\nop_info = &info->op.inline_rdma_write;\r\nif (op_info->len > I40IW_MAX_INLINE_DATA_SIZE)\r\nreturn I40IW_ERR_INVALID_IMM_DATA_SIZE;\r\nret_code = i40iw_inline_data_size_to_wqesize(op_info->len, &wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, wqe_size, op_info->len, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nread_fence |= info->read_fence;\r\nset_64bit_val(wqe, 16,\r\nLS_64(op_info->rem_addr.tag_off, I40IWQPSQ_FRAG_TO));\r\nheader = LS_64(op_info->rem_addr.stag, I40IWQPSQ_REMSTAG) |\r\nLS_64(I40IWQP_OP_RDMA_WRITE, I40IWQPSQ_OPCODE) |\r\nLS_64(op_info->len, I40IWQPSQ_INLINEDATALEN) |\r\nLS_64(1, I40IWQPSQ_INLINEDATAFLAG) |\r\nLS_64((qp->push_db ? 1 : 0), I40IWQPSQ_PUSHWQE) |\r\nLS_64(read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(info->local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\ndest = (u8 *)wqe;\r\nsrc = (u8 *)(op_info->data);\r\nif (op_info->len <= 16) {\r\nmemcpy(dest, src, op_info->len);\r\n} else {\r\nmemcpy(dest, src, 16);\r\nsrc += 16;\r\ndest = (u8 *)wqe + 32;\r\nmemcpy(dest, src, op_info->len - 16);\r\n}\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (qp->push_db) {\r\npush = (u64 *)((uintptr_t)qp->push_wqe + (wqe_idx & 0x3) * 0x20);\r\nmemcpy(push, wqe, (op_info->len > 16) ? op_info->len + 16 : 32);\r\ni40iw_qp_ring_push_db(qp, wqe_idx);\r\n} else {\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\n}\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_inline_send(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nu32 stag_to_inv,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu8 *dest, *src;\r\nstruct i40iw_post_inline_send *op_info;\r\nu64 header;\r\nu32 wqe_idx;\r\nenum i40iw_status_code ret_code;\r\nbool read_fence = false;\r\nu8 wqe_size;\r\nu64 *push;\r\nop_info = &info->op.inline_send;\r\nif (op_info->len > I40IW_MAX_INLINE_DATA_SIZE)\r\nreturn I40IW_ERR_INVALID_IMM_DATA_SIZE;\r\nret_code = i40iw_inline_data_size_to_wqesize(op_info->len, &wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, wqe_size, op_info->len, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nread_fence |= info->read_fence;\r\nheader = LS_64(stag_to_inv, I40IWQPSQ_REMSTAG) |\r\nLS_64(info->op_type, I40IWQPSQ_OPCODE) |\r\nLS_64(op_info->len, I40IWQPSQ_INLINEDATALEN) |\r\nLS_64(1, I40IWQPSQ_INLINEDATAFLAG) |\r\nLS_64((qp->push_db ? 1 : 0), I40IWQPSQ_PUSHWQE) |\r\nLS_64(read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(info->local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\ndest = (u8 *)wqe;\r\nsrc = (u8 *)(op_info->data);\r\nif (op_info->len <= 16) {\r\nmemcpy(dest, src, op_info->len);\r\n} else {\r\nmemcpy(dest, src, 16);\r\nsrc += 16;\r\ndest = (u8 *)wqe + 32;\r\nmemcpy(dest, src, op_info->len - 16);\r\n}\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (qp->push_db) {\r\npush = (u64 *)((uintptr_t)qp->push_wqe + (wqe_idx & 0x3) * 0x20);\r\nmemcpy(push, wqe, (op_info->len > 16) ? op_info->len + 16 : 32);\r\ni40iw_qp_ring_push_db(qp, wqe_idx);\r\n} else {\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\n}\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_stag_local_invalidate(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_inv_local_stag *op_info;\r\nu64 header;\r\nu32 wqe_idx;\r\nbool local_fence = false;\r\nop_info = &info->op.inv_local_stag;\r\nlocal_fence = info->local_fence;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, I40IW_QP_WQE_MIN_SIZE, 0, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8,\r\nLS_64(op_info->target_stag, I40IWQPSQ_LOCSTAG));\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IW_OP_TYPE_INV_STAG, I40IWQPSQ_OPCODE) |\r\nLS_64(info->read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_mw_bind(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_sq_info *info,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_bind_window *op_info;\r\nu64 header;\r\nu32 wqe_idx;\r\nbool local_fence = false;\r\nop_info = &info->op.bind_window;\r\nlocal_fence |= info->local_fence;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, I40IW_QP_WQE_MIN_SIZE, 0, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nset_64bit_val(wqe, 0, (uintptr_t)op_info->va);\r\nset_64bit_val(wqe, 8,\r\nLS_64(op_info->mr_stag, I40IWQPSQ_PARENTMRSTAG) |\r\nLS_64(op_info->mw_stag, I40IWQPSQ_MWSTAG));\r\nset_64bit_val(wqe, 16, op_info->bind_length);\r\nheader = LS_64(I40IW_OP_TYPE_BIND_MW, I40IWQPSQ_OPCODE) |\r\nLS_64(((op_info->enable_reads << 2) |\r\n(op_info->enable_writes << 3)),\r\nI40IWQPSQ_STAGRIGHTS) |\r\nLS_64((op_info->addressing_type == I40IW_ADDR_TYPE_VA_BASED ? 1 : 0),\r\nI40IWQPSQ_VABASEDTO) |\r\nLS_64(info->read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_post_receive(struct i40iw_qp_uk *qp,\r\nstruct i40iw_post_rq_info *info)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nu32 total_size = 0, wqe_idx, i, byte_off;\r\nif (qp->max_rq_frag_cnt < info->num_sges)\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\nfor (i = 0; i < info->num_sges; i++)\r\ntotal_size += info->sg_list[i].len;\r\nwqe = i40iw_qp_get_next_recv_wqe(qp, &wqe_idx);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nqp->rq_wrid_array[wqe_idx] = info->wr_id;\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64((info->num_sges > 1 ? (info->num_sges - 1) : 0),\r\nI40IWQPSQ_ADDFRAGCNT) |\r\nLS_64(qp->rwqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_set_fragment(wqe, 0, info->sg_list);\r\nfor (i = 1, byte_off = 32; i < info->num_sges; i++) {\r\ni40iw_set_fragment(wqe, byte_off, &info->sg_list[i]);\r\nbyte_off += 16;\r\n}\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nreturn 0;\r\n}\r\nstatic void i40iw_cq_request_notification(struct i40iw_cq_uk *cq,\r\nenum i40iw_completion_notify cq_notify)\r\n{\r\nu64 temp_val;\r\nu16 sw_cq_sel;\r\nu8 arm_next_se = 0;\r\nu8 arm_next = 0;\r\nu8 arm_seq_num;\r\nget_64bit_val(cq->shadow_area, 32, &temp_val);\r\narm_seq_num = (u8)RS_64(temp_val, I40IW_CQ_DBSA_ARM_SEQ_NUM);\r\narm_seq_num++;\r\nsw_cq_sel = (u16)RS_64(temp_val, I40IW_CQ_DBSA_SW_CQ_SELECT);\r\narm_next_se = (u8)RS_64(temp_val, I40IW_CQ_DBSA_ARM_NEXT_SE);\r\narm_next_se |= 1;\r\nif (cq_notify == IW_CQ_COMPL_EVENT)\r\narm_next = 1;\r\ntemp_val = LS_64(arm_seq_num, I40IW_CQ_DBSA_ARM_SEQ_NUM) |\r\nLS_64(sw_cq_sel, I40IW_CQ_DBSA_SW_CQ_SELECT) |\r\nLS_64(arm_next_se, I40IW_CQ_DBSA_ARM_NEXT_SE) |\r\nLS_64(arm_next, I40IW_CQ_DBSA_ARM_NEXT);\r\nset_64bit_val(cq->shadow_area, 32, temp_val);\r\nwmb();\r\nwritel(cq->cq_id, cq->cqe_alloc_reg);\r\n}\r\nstatic enum i40iw_status_code i40iw_cq_post_entries(struct i40iw_cq_uk *cq,\r\nu8 count)\r\n{\r\nI40IW_RING_MOVE_TAIL_BY_COUNT(cq->cq_ring, count);\r\nset_64bit_val(cq->shadow_area, 0,\r\nI40IW_RING_GETCURRENT_HEAD(cq->cq_ring));\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_cq_poll_completion(struct i40iw_cq_uk *cq,\r\nstruct i40iw_cq_poll_info *info)\r\n{\r\nu64 comp_ctx, qword0, qword2, qword3, wqe_qword;\r\nu64 *cqe, *sw_wqe;\r\nstruct i40iw_qp_uk *qp;\r\nstruct i40iw_ring *pring = NULL;\r\nu32 wqe_idx, q_type, array_idx = 0;\r\nenum i40iw_status_code ret_code = 0;\r\nbool move_cq_head = true;\r\nu8 polarity;\r\nu8 addl_wqes = 0;\r\nif (cq->avoid_mem_cflct)\r\ncqe = (u64 *)I40IW_GET_CURRENT_EXTENDED_CQ_ELEMENT(cq);\r\nelse\r\ncqe = (u64 *)I40IW_GET_CURRENT_CQ_ELEMENT(cq);\r\nget_64bit_val(cqe, 24, &qword3);\r\npolarity = (u8)RS_64(qword3, I40IW_CQ_VALID);\r\nif (polarity != cq->polarity)\r\nreturn I40IW_ERR_QUEUE_EMPTY;\r\nq_type = (u8)RS_64(qword3, I40IW_CQ_SQ);\r\ninfo->error = (bool)RS_64(qword3, I40IW_CQ_ERROR);\r\ninfo->push_dropped = (bool)RS_64(qword3, I40IWCQ_PSHDROP);\r\nif (info->error) {\r\ninfo->comp_status = I40IW_COMPL_STATUS_FLUSHED;\r\ninfo->major_err = (bool)RS_64(qword3, I40IW_CQ_MAJERR);\r\ninfo->minor_err = (bool)RS_64(qword3, I40IW_CQ_MINERR);\r\n} else {\r\ninfo->comp_status = I40IW_COMPL_STATUS_SUCCESS;\r\n}\r\nget_64bit_val(cqe, 0, &qword0);\r\nget_64bit_val(cqe, 16, &qword2);\r\ninfo->tcp_seq_num = (u8)RS_64(qword0, I40IWCQ_TCPSEQNUM);\r\ninfo->qp_id = (u32)RS_64(qword2, I40IWCQ_QPID);\r\nget_64bit_val(cqe, 8, &comp_ctx);\r\ninfo->solicited_event = (bool)RS_64(qword3, I40IWCQ_SOEVENT);\r\ninfo->is_srq = (bool)RS_64(qword3, I40IWCQ_SRQ);\r\nqp = (struct i40iw_qp_uk *)(unsigned long)comp_ctx;\r\nif (!qp) {\r\nret_code = I40IW_ERR_QUEUE_DESTROYED;\r\ngoto exit;\r\n}\r\nwqe_idx = (u32)RS_64(qword3, I40IW_CQ_WQEIDX);\r\ninfo->qp_handle = (i40iw_qp_handle)(unsigned long)qp;\r\nif (q_type == I40IW_CQE_QTYPE_RQ) {\r\narray_idx = (wqe_idx * 4) / qp->rq_wqe_size_multiplier;\r\nif (info->comp_status == I40IW_COMPL_STATUS_FLUSHED) {\r\ninfo->wr_id = qp->rq_wrid_array[qp->rq_ring.tail];\r\narray_idx = qp->rq_ring.tail;\r\n} else {\r\ninfo->wr_id = qp->rq_wrid_array[array_idx];\r\n}\r\ninfo->op_type = I40IW_OP_TYPE_REC;\r\nif (qword3 & I40IWCQ_STAG_MASK) {\r\ninfo->stag_invalid_set = true;\r\ninfo->inv_stag = (u32)RS_64(qword2, I40IWCQ_INVSTAG);\r\n} else {\r\ninfo->stag_invalid_set = false;\r\n}\r\ninfo->bytes_xfered = (u32)RS_64(qword0, I40IWCQ_PAYLDLEN);\r\nI40IW_RING_SET_TAIL(qp->rq_ring, array_idx + 1);\r\npring = &qp->rq_ring;\r\n} else {\r\nif (info->comp_status != I40IW_COMPL_STATUS_FLUSHED) {\r\ninfo->wr_id = qp->sq_wrtrk_array[wqe_idx].wrid;\r\ninfo->bytes_xfered = qp->sq_wrtrk_array[wqe_idx].wr_len;\r\ninfo->op_type = (u8)RS_64(qword3, I40IWCQ_OP);\r\nsw_wqe = qp->sq_base[wqe_idx].elem;\r\nget_64bit_val(sw_wqe, 24, &wqe_qword);\r\naddl_wqes = qp->sq_wrtrk_array[wqe_idx].wqe_size / I40IW_QP_WQE_MIN_SIZE;\r\nI40IW_RING_SET_TAIL(qp->sq_ring, (wqe_idx + addl_wqes));\r\n} else {\r\ndo {\r\nu8 op_type;\r\nu32 tail;\r\ntail = qp->sq_ring.tail;\r\nsw_wqe = qp->sq_base[tail].elem;\r\nget_64bit_val(sw_wqe, 24, &wqe_qword);\r\nop_type = (u8)RS_64(wqe_qword, I40IWQPSQ_OPCODE);\r\ninfo->op_type = op_type;\r\naddl_wqes = qp->sq_wrtrk_array[tail].wqe_size / I40IW_QP_WQE_MIN_SIZE;\r\nI40IW_RING_SET_TAIL(qp->sq_ring, (tail + addl_wqes));\r\nif (op_type != I40IWQP_OP_NOP) {\r\ninfo->wr_id = qp->sq_wrtrk_array[tail].wrid;\r\ninfo->bytes_xfered = qp->sq_wrtrk_array[tail].wr_len;\r\nbreak;\r\n}\r\n} while (1);\r\n}\r\npring = &qp->sq_ring;\r\n}\r\nret_code = 0;\r\nexit:\r\nif (!ret_code &&\r\n(info->comp_status == I40IW_COMPL_STATUS_FLUSHED))\r\nif (pring && (I40IW_RING_MORE_WORK(*pring)))\r\nmove_cq_head = false;\r\nif (move_cq_head) {\r\nI40IW_RING_MOVE_HEAD_NOCHECK(cq->cq_ring);\r\nif (I40IW_RING_GETCURRENT_HEAD(cq->cq_ring) == 0)\r\ncq->polarity ^= 1;\r\nI40IW_RING_MOVE_TAIL(cq->cq_ring);\r\nset_64bit_val(cq->shadow_area, 0,\r\nI40IW_RING_GETCURRENT_HEAD(cq->cq_ring));\r\n} else {\r\nif (info->is_srq)\r\nreturn ret_code;\r\nqword3 &= ~I40IW_CQ_WQEIDX_MASK;\r\nqword3 |= LS_64(pring->tail, I40IW_CQ_WQEIDX);\r\nset_64bit_val(cqe, 24, qword3);\r\n}\r\nreturn ret_code;\r\n}\r\nenum i40iw_status_code i40iw_get_wqe_shift(u32 wqdepth, u32 sge, u32 inline_data, u8 *shift)\r\n{\r\nu32 size;\r\n*shift = 0;\r\nif (sge > 1 || inline_data > 16)\r\n*shift = (sge < 4 && inline_data <= 48) ? 1 : 2;\r\nif ((wqdepth < I40IWQP_SW_MIN_WQSIZE) || (wqdepth & (wqdepth - 1)))\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nsize = wqdepth << *shift;\r\nif (size > I40IWQP_SW_MAX_WQSIZE)\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_qp_uk_init(struct i40iw_qp_uk *qp,\r\nstruct i40iw_qp_uk_init_info *info)\r\n{\r\nenum i40iw_status_code ret_code = 0;\r\nu32 sq_ring_size;\r\nu8 sqshift, rqshift;\r\nif (info->max_sq_frag_cnt > I40IW_MAX_WQ_FRAGMENT_COUNT)\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\nif (info->max_rq_frag_cnt > I40IW_MAX_WQ_FRAGMENT_COUNT)\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\nret_code = i40iw_get_wqe_shift(info->sq_size, info->max_sq_frag_cnt, info->max_inline_data, &sqshift);\r\nif (ret_code)\r\nreturn ret_code;\r\nqp->sq_base = info->sq;\r\nqp->rq_base = info->rq;\r\nqp->shadow_area = info->shadow_area;\r\nqp->sq_wrtrk_array = info->sq_wrtrk_array;\r\nqp->rq_wrid_array = info->rq_wrid_array;\r\nqp->wqe_alloc_reg = info->wqe_alloc_reg;\r\nqp->qp_id = info->qp_id;\r\nqp->sq_size = info->sq_size;\r\nqp->push_db = info->push_db;\r\nqp->push_wqe = info->push_wqe;\r\nqp->max_sq_frag_cnt = info->max_sq_frag_cnt;\r\nsq_ring_size = qp->sq_size << sqshift;\r\nI40IW_RING_INIT(qp->sq_ring, sq_ring_size);\r\nI40IW_RING_INIT(qp->initial_ring, sq_ring_size);\r\nI40IW_RING_MOVE_HEAD(qp->sq_ring, ret_code);\r\nI40IW_RING_MOVE_TAIL(qp->sq_ring);\r\nI40IW_RING_MOVE_HEAD(qp->initial_ring, ret_code);\r\nqp->swqe_polarity = 1;\r\nqp->swqe_polarity_deferred = 1;\r\nqp->rwqe_polarity = 0;\r\nif (!qp->use_srq) {\r\nqp->rq_size = info->rq_size;\r\nqp->max_rq_frag_cnt = info->max_rq_frag_cnt;\r\nI40IW_RING_INIT(qp->rq_ring, qp->rq_size);\r\nswitch (info->abi_ver) {\r\ncase 4:\r\nret_code = i40iw_get_wqe_shift(info->rq_size, info->max_rq_frag_cnt, 0, &rqshift);\r\nif (ret_code)\r\nreturn ret_code;\r\nbreak;\r\ncase 5:\r\ndefault:\r\nrqshift = I40IW_MAX_RQ_WQE_SHIFT;\r\nbreak;\r\n}\r\nqp->rq_wqe_size = rqshift;\r\nqp->rq_wqe_size_multiplier = 4 << rqshift;\r\n}\r\nqp->ops = iw_qp_uk_ops;\r\nreturn ret_code;\r\n}\r\nenum i40iw_status_code i40iw_cq_uk_init(struct i40iw_cq_uk *cq,\r\nstruct i40iw_cq_uk_init_info *info)\r\n{\r\nif ((info->cq_size < I40IW_MIN_CQ_SIZE) ||\r\n(info->cq_size > I40IW_MAX_CQ_SIZE))\r\nreturn I40IW_ERR_INVALID_SIZE;\r\ncq->cq_base = (struct i40iw_cqe *)info->cq_base;\r\ncq->cq_id = info->cq_id;\r\ncq->cq_size = info->cq_size;\r\ncq->cqe_alloc_reg = info->cqe_alloc_reg;\r\ncq->shadow_area = info->shadow_area;\r\ncq->avoid_mem_cflct = info->avoid_mem_cflct;\r\nI40IW_RING_INIT(cq->cq_ring, cq->cq_size);\r\ncq->polarity = 1;\r\ncq->ops = iw_cq_ops;\r\nreturn 0;\r\n}\r\nvoid i40iw_device_init_uk(struct i40iw_dev_uk *dev)\r\n{\r\ndev->ops_uk = iw_device_uk_ops;\r\n}\r\nvoid i40iw_clean_cq(void *queue, struct i40iw_cq_uk *cq)\r\n{\r\nu64 *cqe;\r\nu64 qword3, comp_ctx;\r\nu32 cq_head;\r\nu8 polarity, temp;\r\ncq_head = cq->cq_ring.head;\r\ntemp = cq->polarity;\r\ndo {\r\nif (cq->avoid_mem_cflct)\r\ncqe = (u64 *)&(((struct i40iw_extended_cqe *)cq->cq_base)[cq_head]);\r\nelse\r\ncqe = (u64 *)&cq->cq_base[cq_head];\r\nget_64bit_val(cqe, 24, &qword3);\r\npolarity = (u8)RS_64(qword3, I40IW_CQ_VALID);\r\nif (polarity != temp)\r\nbreak;\r\nget_64bit_val(cqe, 8, &comp_ctx);\r\nif ((void *)(unsigned long)comp_ctx == queue)\r\nset_64bit_val(cqe, 8, 0);\r\ncq_head = (cq_head + 1) % cq->cq_ring.size;\r\nif (!cq_head)\r\ntemp ^= 1;\r\n} while (true);\r\n}\r\nenum i40iw_status_code i40iw_nop(struct i40iw_qp_uk *qp,\r\nu64 wr_id,\r\nbool signaled,\r\nbool post_sq)\r\n{\r\nu64 header, *wqe;\r\nu32 wqe_idx;\r\nwqe = i40iw_qp_get_next_send_wqe(qp, &wqe_idx, I40IW_QP_WQE_MIN_SIZE, 0, wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8, 0);\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_NOP, I40IWQPSQ_OPCODE) |\r\nLS_64(signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->swqe_polarity, I40IWQPSQ_VALID);\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\nif (post_sq)\r\ni40iw_qp_post_wr(qp);\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_fragcnt_to_wqesize_sq(u32 frag_cnt, u8 *wqe_size)\r\n{\r\nswitch (frag_cnt) {\r\ncase 0:\r\ncase 1:\r\n*wqe_size = I40IW_QP_WQE_MIN_SIZE;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\n*wqe_size = 64;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\n*wqe_size = 96;\r\nbreak;\r\ncase 6:\r\ncase 7:\r\n*wqe_size = 128;\r\nbreak;\r\ndefault:\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\n}\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_fragcnt_to_wqesize_rq(u32 frag_cnt, u8 *wqe_size)\r\n{\r\nswitch (frag_cnt) {\r\ncase 0:\r\ncase 1:\r\n*wqe_size = 32;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\n*wqe_size = 64;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\n*wqe_size = 128;\r\nbreak;\r\ndefault:\r\nreturn I40IW_ERR_INVALID_FRAG_COUNT;\r\n}\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_inline_data_size_to_wqesize(u32 data_size,\r\nu8 *wqe_size)\r\n{\r\nif (data_size > I40IW_MAX_INLINE_DATA_SIZE)\r\nreturn I40IW_ERR_INVALID_IMM_DATA_SIZE;\r\nif (data_size <= 16)\r\n*wqe_size = I40IW_QP_WQE_MIN_SIZE;\r\nelse\r\n*wqe_size = 64;\r\nreturn 0;\r\n}

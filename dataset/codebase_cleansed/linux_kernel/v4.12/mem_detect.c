static inline void memblock_physmem_add(phys_addr_t start, phys_addr_t size)\r\n{\r\nmemblock_dbg("memblock_physmem_add: [%#016llx-%#016llx]\n",\r\nstart, start + size - 1);\r\nmemblock_add_range(&memblock.memory, start, size, 0, 0);\r\nmemblock_add_range(&memblock.physmem, start, size, 0, 0);\r\n}\r\nvoid __init detect_memory_memblock(void)\r\n{\r\nunsigned long memsize, rnmax, rzm, addr, size;\r\nint type;\r\nrzm = sclp.rzm;\r\nrnmax = sclp.rnmax;\r\nmemsize = rzm * rnmax;\r\nif (!rzm)\r\nrzm = 1UL << 17;\r\nmax_physmem_end = memsize;\r\naddr = 0;\r\nmemblock_set_bottom_up(true);\r\ndo {\r\nsize = 0;\r\ntype = addr ? tprot(addr) : CHUNK_READ_WRITE;\r\ndo {\r\nsize += rzm;\r\nif (max_physmem_end && addr + size >= max_physmem_end)\r\nbreak;\r\n} while (type == tprot(addr + size));\r\nif (type == CHUNK_READ_WRITE || type == CHUNK_READ_ONLY) {\r\nif (max_physmem_end && (addr + size > max_physmem_end))\r\nsize = max_physmem_end - addr;\r\nmemblock_physmem_add(addr, size);\r\n}\r\naddr += size;\r\n} while (addr < max_physmem_end);\r\nmemblock_set_bottom_up(false);\r\nif (!max_physmem_end)\r\nmax_physmem_end = memblock_end_of_DRAM();\r\nmemblock_dump_all();\r\n}

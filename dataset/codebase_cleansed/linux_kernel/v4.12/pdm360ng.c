static int pdm360ng_get_pendown_state(void)\r\n{\r\nu32 reg;\r\nreg = in_be32(pdm360ng_gpio_base + 0xc);\r\nif (reg & 0x40)\r\nsetbits32(pdm360ng_gpio_base + 0xc, 0x40);\r\nreg = in_be32(pdm360ng_gpio_base + 0x8);\r\nreturn (reg & 0x40) == 0;\r\n}\r\nstatic int __init pdm360ng_penirq_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,mpc5121-gpio");\r\nif (!np) {\r\npr_err("%s: Can't find 'mpc5121-gpio' node\n", __func__);\r\nreturn -ENODEV;\r\n}\r\npdm360ng_gpio_base = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!pdm360ng_gpio_base) {\r\npr_err("%s: Can't map gpio regs.\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nout_be32(pdm360ng_gpio_base + 0xc, 0xffffffff);\r\nsetbits32(pdm360ng_gpio_base + 0x18, 0x2000);\r\nsetbits32(pdm360ng_gpio_base + 0x10, 0x40);\r\nreturn 0;\r\n}\r\nstatic int pdm360ng_touchscreen_notifier_call(struct notifier_block *nb,\r\nunsigned long event, void *__dev)\r\n{\r\nstruct device *dev = __dev;\r\nif ((event == BUS_NOTIFY_ADD_DEVICE) &&\r\nof_device_is_compatible(dev->of_node, "ti,ads7846")) {\r\ndev->platform_data = &pdm360ng_ads7846_pdata;\r\nreturn NOTIFY_OK;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void __init pdm360ng_touchscreen_init(void)\r\n{\r\nif (pdm360ng_penirq_init())\r\nreturn;\r\nbus_register_notifier(&spi_bus_type, &pdm360ng_touchscreen_nb);\r\n}\r\nstatic inline void __init pdm360ng_touchscreen_init(void)\r\n{\r\n}\r\nvoid __init pdm360ng_init(void)\r\n{\r\nmpc512x_init();\r\npdm360ng_touchscreen_init();\r\n}\r\nstatic int __init pdm360ng_probe(void)\r\n{\r\nif (!of_machine_is_compatible("ifm,pdm360ng"))\r\nreturn 0;\r\nmpc512x_init_early();\r\nreturn 1;\r\n}

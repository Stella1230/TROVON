static int shmob_drm_backlight_update(struct backlight_device *bdev)\r\n{\r\nstruct shmob_drm_connector *scon = bl_get_data(bdev);\r\nstruct shmob_drm_device *sdev = scon->connector.dev->dev_private;\r\nconst struct shmob_drm_backlight_data *bdata = &sdev->pdata->backlight;\r\nint brightness = bdev->props.brightness;\r\nif (bdev->props.power != FB_BLANK_UNBLANK ||\r\nbdev->props.state & BL_CORE_SUSPENDED)\r\nbrightness = 0;\r\nreturn bdata->set_brightness(brightness);\r\n}\r\nstatic int shmob_drm_backlight_get_brightness(struct backlight_device *bdev)\r\n{\r\nstruct shmob_drm_connector *scon = bl_get_data(bdev);\r\nstruct shmob_drm_device *sdev = scon->connector.dev->dev_private;\r\nconst struct shmob_drm_backlight_data *bdata = &sdev->pdata->backlight;\r\nreturn bdata->get_brightness();\r\n}\r\nvoid shmob_drm_backlight_dpms(struct shmob_drm_connector *scon, int mode)\r\n{\r\nif (scon->backlight == NULL)\r\nreturn;\r\nscon->backlight->props.power = mode == DRM_MODE_DPMS_ON\r\n? FB_BLANK_UNBLANK : FB_BLANK_POWERDOWN;\r\nbacklight_update_status(scon->backlight);\r\n}\r\nint shmob_drm_backlight_init(struct shmob_drm_connector *scon)\r\n{\r\nstruct shmob_drm_device *sdev = scon->connector.dev->dev_private;\r\nconst struct shmob_drm_backlight_data *bdata = &sdev->pdata->backlight;\r\nstruct drm_connector *connector = &scon->connector;\r\nstruct drm_device *dev = connector->dev;\r\nstruct backlight_device *backlight;\r\nif (!bdata->max_brightness)\r\nreturn 0;\r\nbacklight = backlight_device_register(bdata->name, dev->dev, scon,\r\n&shmob_drm_backlight_ops, NULL);\r\nif (IS_ERR(backlight)) {\r\ndev_err(dev->dev, "unable to register backlight device: %ld\n",\r\nPTR_ERR(backlight));\r\nreturn PTR_ERR(backlight);\r\n}\r\nbacklight->props.max_brightness = bdata->max_brightness;\r\nbacklight->props.brightness = bdata->max_brightness;\r\nbacklight->props.power = FB_BLANK_POWERDOWN;\r\nbacklight_update_status(backlight);\r\nscon->backlight = backlight;\r\nreturn 0;\r\n}\r\nvoid shmob_drm_backlight_exit(struct shmob_drm_connector *scon)\r\n{\r\nbacklight_device_unregister(scon->backlight);\r\n}

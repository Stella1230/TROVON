static int storm_ops_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *soc_runtime = substream->private_data;\r\nstruct snd_soc_card *card = soc_runtime->card;\r\nsnd_pcm_format_t format = params_format(params);\r\nunsigned int rate = params_rate(params);\r\nunsigned int sysclk_freq;\r\nint bitwidth, ret;\r\nbitwidth = snd_pcm_format_width(format);\r\nif (bitwidth < 0) {\r\ndev_err(card->dev, "invalid bit width given: %d\n", bitwidth);\r\nreturn bitwidth;\r\n}\r\nsysclk_freq = rate * bitwidth * 2 * STORM_SYSCLK_MULT;\r\nret = snd_soc_dai_set_sysclk(soc_runtime->cpu_dai, 0, sysclk_freq, 0);\r\nif (ret) {\r\ndev_err(card->dev, "error setting sysclk to %u: %d\n",\r\nsysclk_freq, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int storm_parse_of(struct snd_soc_card *card)\r\n{\r\nstruct snd_soc_dai_link *dai_link = card->dai_link;\r\nstruct device_node *np = card->dev->of_node;\r\ndai_link->cpu_of_node = of_parse_phandle(np, "cpu", 0);\r\nif (!dai_link->cpu_of_node) {\r\ndev_err(card->dev, "error getting cpu phandle\n");\r\nreturn -EINVAL;\r\n}\r\ndai_link->platform_of_node = dai_link->cpu_of_node;\r\ndai_link->codec_of_node = of_parse_phandle(np, "codec", 0);\r\nif (!dai_link->codec_of_node) {\r\ndev_err(card->dev, "error getting codec phandle\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int storm_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card;\r\nint ret;\r\ncard = devm_kzalloc(&pdev->dev, sizeof(*card), GFP_KERNEL);\r\nif (!card)\r\nreturn -ENOMEM;\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nret = snd_soc_of_parse_card_name(card, "qcom,model");\r\nif (ret) {\r\ndev_err(&pdev->dev, "error parsing card name: %d\n", ret);\r\nreturn ret;\r\n}\r\ncard->dai_link = &storm_dai_link;\r\ncard->num_links = 1;\r\nret = storm_parse_of(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "error resolving dai links: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "error registering soundcard: %d\n", ret);\r\nreturn ret;\r\n}

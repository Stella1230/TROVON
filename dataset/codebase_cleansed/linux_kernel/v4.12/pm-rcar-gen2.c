static inline u32 phys_to_sbar(phys_addr_t addr)\r\n{\r\nreturn (addr >> 8) & 0xfffffc00;\r\n}\r\nstatic void __init rcar_gen2_sysc_init(u32 syscier)\r\n{\r\nrcar_sysc_init(0xe6180000, syscier);\r\n}\r\nstatic inline void rcar_gen2_sysc_init(u32 syscier) {}\r\nvoid __init rcar_gen2_pm_init(void)\r\n{\r\nvoid __iomem *p;\r\nu32 bar;\r\nstatic int once;\r\nstruct device_node *np, *cpus;\r\nbool has_a7 = false;\r\nbool has_a15 = false;\r\nphys_addr_t boot_vector_addr = ICRAM1;\r\nu32 syscier = 0;\r\nif (once++)\r\nreturn;\r\ncpus = of_find_node_by_path("/cpus");\r\nif (!cpus)\r\nreturn;\r\nfor_each_child_of_node(cpus, np) {\r\nif (of_device_is_compatible(np, "arm,cortex-a15"))\r\nhas_a15 = true;\r\nelse if (of_device_is_compatible(np, "arm,cortex-a7"))\r\nhas_a7 = true;\r\n}\r\nif (of_machine_is_compatible("renesas,r8a7790"))\r\nsyscier = 0x013111ef;\r\nelse if (of_machine_is_compatible("renesas,r8a7791"))\r\nsyscier = 0x00111003;\r\np = ioremap_nocache(boot_vector_addr, shmobile_boot_size);\r\nmemcpy_toio(p, shmobile_boot_vector, shmobile_boot_size);\r\niounmap(p);\r\np = ioremap_nocache(RST, 0x63);\r\nbar = phys_to_sbar(boot_vector_addr);\r\nif (has_a15) {\r\nwritel_relaxed(bar, p + CA15BAR);\r\nwritel_relaxed(bar | SBAR_BAREN, p + CA15BAR);\r\nwritel_relaxed((readl_relaxed(p + CA15RESCNT) &\r\n~CA15RESCNT_CPUS) | CA15RESCNT_CODE,\r\np + CA15RESCNT);\r\n}\r\nif (has_a7) {\r\nwritel_relaxed(bar, p + CA7BAR);\r\nwritel_relaxed(bar | SBAR_BAREN, p + CA7BAR);\r\nwritel_relaxed((readl_relaxed(p + CA7RESCNT) &\r\n~CA7RESCNT_CPUS) | CA7RESCNT_CODE,\r\np + CA7RESCNT);\r\n}\r\niounmap(p);\r\nrcar_gen2_sysc_init(syscier);\r\nshmobile_smp_apmu_suspend_init();\r\n}

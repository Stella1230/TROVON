static void xgbe_default_config(struct xgbe_prv_data *pdata)\r\n{\r\nDBGPR("-->xgbe_default_config\n");\r\npdata->pblx8 = DMA_PBL_X8_ENABLE;\r\npdata->tx_sf_mode = MTL_TSF_ENABLE;\r\npdata->tx_threshold = MTL_TX_THRESHOLD_64;\r\npdata->tx_pbl = DMA_PBL_16;\r\npdata->tx_osp_mode = DMA_OSP_ENABLE;\r\npdata->rx_sf_mode = MTL_RSF_DISABLE;\r\npdata->rx_threshold = MTL_RX_THRESHOLD_64;\r\npdata->rx_pbl = DMA_PBL_16;\r\npdata->pause_autoneg = 1;\r\npdata->tx_pause = 1;\r\npdata->rx_pause = 1;\r\npdata->phy_speed = SPEED_UNKNOWN;\r\npdata->power_down = 0;\r\nDBGPR("<--xgbe_default_config\n");\r\n}\r\nstatic void xgbe_init_all_fptrs(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_init_function_ptrs_dev(&pdata->hw_if);\r\nxgbe_init_function_ptrs_phy(&pdata->phy_if);\r\nxgbe_init_function_ptrs_i2c(&pdata->i2c_if);\r\nxgbe_init_function_ptrs_desc(&pdata->desc_if);\r\npdata->vdata->init_function_ptrs_phy_impl(&pdata->phy_if);\r\n}\r\nstruct xgbe_prv_data *xgbe_alloc_pdata(struct device *dev)\r\n{\r\nstruct xgbe_prv_data *pdata;\r\nstruct net_device *netdev;\r\nnetdev = alloc_etherdev_mq(sizeof(struct xgbe_prv_data),\r\nXGBE_MAX_DMA_CHANNELS);\r\nif (!netdev) {\r\ndev_err(dev, "alloc_etherdev_mq failed\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nSET_NETDEV_DEV(netdev, dev);\r\npdata = netdev_priv(netdev);\r\npdata->netdev = netdev;\r\npdata->dev = dev;\r\nspin_lock_init(&pdata->lock);\r\nspin_lock_init(&pdata->xpcs_lock);\r\nmutex_init(&pdata->rss_mutex);\r\nspin_lock_init(&pdata->tstamp_lock);\r\nmutex_init(&pdata->i2c_mutex);\r\ninit_completion(&pdata->i2c_complete);\r\ninit_completion(&pdata->mdio_complete);\r\npdata->msg_enable = netif_msg_init(debug, default_msg_level);\r\nset_bit(XGBE_DOWN, &pdata->dev_state);\r\nset_bit(XGBE_STOPPED, &pdata->dev_state);\r\nreturn pdata;\r\n}\r\nvoid xgbe_free_pdata(struct xgbe_prv_data *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nfree_netdev(netdev);\r\n}\r\nvoid xgbe_set_counts(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_init_all_fptrs(pdata);\r\nxgbe_get_all_hw_features(pdata);\r\nif (!pdata->tx_max_channel_count)\r\npdata->tx_max_channel_count = pdata->hw_feat.tx_ch_cnt;\r\nif (!pdata->rx_max_channel_count)\r\npdata->rx_max_channel_count = pdata->hw_feat.rx_ch_cnt;\r\nif (!pdata->tx_max_q_count)\r\npdata->tx_max_q_count = pdata->hw_feat.tx_q_cnt;\r\nif (!pdata->rx_max_q_count)\r\npdata->rx_max_q_count = pdata->hw_feat.rx_q_cnt;\r\npdata->tx_ring_count = min_t(unsigned int, num_online_cpus(),\r\npdata->hw_feat.tx_ch_cnt);\r\npdata->tx_ring_count = min_t(unsigned int, pdata->tx_ring_count,\r\npdata->tx_max_channel_count);\r\npdata->tx_ring_count = min_t(unsigned int, pdata->tx_ring_count,\r\npdata->tx_max_q_count);\r\npdata->tx_q_count = pdata->tx_ring_count;\r\npdata->rx_ring_count = min_t(unsigned int, num_online_cpus(),\r\npdata->hw_feat.rx_ch_cnt);\r\npdata->rx_ring_count = min_t(unsigned int, pdata->rx_ring_count,\r\npdata->rx_max_channel_count);\r\npdata->rx_q_count = min_t(unsigned int, pdata->hw_feat.rx_q_cnt,\r\npdata->rx_max_q_count);\r\nif (netif_msg_probe(pdata)) {\r\ndev_dbg(pdata->dev, "TX/RX DMA channel count = %u/%u\n",\r\npdata->tx_ring_count, pdata->rx_ring_count);\r\ndev_dbg(pdata->dev, "TX/RX hardware queue count = %u/%u\n",\r\npdata->tx_q_count, pdata->rx_q_count);\r\n}\r\n}\r\nint xgbe_config_netdev(struct xgbe_prv_data *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nstruct device *dev = pdata->dev;\r\nunsigned int i;\r\nint ret;\r\nnetdev->irq = pdata->dev_irq;\r\nnetdev->base_addr = (unsigned long)pdata->xgmac_regs;\r\nmemcpy(netdev->dev_addr, pdata->mac_addr, netdev->addr_len);\r\npdata->tx_sec_period = jiffies;\r\npdata->tx_ded_period = jiffies;\r\npdata->rx_sec_period = jiffies;\r\npdata->rx_ded_period = jiffies;\r\npdata->desc_sec_period = jiffies;\r\npdata->desc_ded_period = jiffies;\r\npdata->hw_if.exit(pdata);\r\nxgbe_default_config(pdata);\r\nret = dma_set_mask_and_coherent(dev,\r\nDMA_BIT_MASK(pdata->hw_feat.dma_width));\r\nif (ret) {\r\ndev_err(dev, "dma_set_mask_and_coherent failed\n");\r\nreturn ret;\r\n}\r\nif (!pdata->tx_max_fifo_size)\r\npdata->tx_max_fifo_size = pdata->hw_feat.tx_fifo_size;\r\nif (!pdata->rx_max_fifo_size)\r\npdata->rx_max_fifo_size = pdata->hw_feat.rx_fifo_size;\r\nBUILD_BUG_ON_NOT_POWER_OF_2(XGBE_TX_DESC_CNT);\r\npdata->tx_desc_count = XGBE_TX_DESC_CNT;\r\nBUILD_BUG_ON_NOT_POWER_OF_2(XGBE_RX_DESC_CNT);\r\npdata->rx_desc_count = XGBE_RX_DESC_CNT;\r\nif (pdata->channel_irq_count) {\r\npdata->tx_ring_count = min_t(unsigned int, pdata->tx_ring_count,\r\npdata->channel_irq_count);\r\npdata->rx_ring_count = min_t(unsigned int, pdata->rx_ring_count,\r\npdata->channel_irq_count);\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(pdata->dev,\r\n"adjusted TX/RX DMA channel count = %u/%u\n",\r\npdata->tx_ring_count, pdata->rx_ring_count);\r\n}\r\nret = netif_set_real_num_tx_queues(netdev, pdata->tx_ring_count);\r\nif (ret) {\r\ndev_err(dev, "error setting real tx queue count\n");\r\nreturn ret;\r\n}\r\nret = netif_set_real_num_rx_queues(netdev, pdata->rx_ring_count);\r\nif (ret) {\r\ndev_err(dev, "error setting real rx queue count\n");\r\nreturn ret;\r\n}\r\nnetdev_rss_key_fill(pdata->rss_key, sizeof(pdata->rss_key));\r\nfor (i = 0; i < XGBE_RSS_MAX_TABLE_SIZE; i++)\r\nXGMAC_SET_BITS(pdata->rss_table[i], MAC_RSSDR, DMCH,\r\ni % pdata->rx_ring_count);\r\nXGMAC_SET_BITS(pdata->rss_options, MAC_RSSCR, IP2TE, 1);\r\nXGMAC_SET_BITS(pdata->rss_options, MAC_RSSCR, TCP4TE, 1);\r\nXGMAC_SET_BITS(pdata->rss_options, MAC_RSSCR, UDP4TE, 1);\r\nret = pdata->phy_if.phy_init(pdata);\r\nif (ret)\r\nreturn ret;\r\nnetdev->netdev_ops = xgbe_get_netdev_ops();\r\nnetdev->ethtool_ops = xgbe_get_ethtool_ops();\r\n#ifdef CONFIG_AMD_XGBE_DCB\r\nnetdev->dcbnl_ops = xgbe_get_dcbnl_ops();\r\n#endif\r\nnetdev->hw_features = NETIF_F_SG |\r\nNETIF_F_IP_CSUM |\r\nNETIF_F_IPV6_CSUM |\r\nNETIF_F_RXCSUM |\r\nNETIF_F_TSO |\r\nNETIF_F_TSO6 |\r\nNETIF_F_GRO |\r\nNETIF_F_HW_VLAN_CTAG_RX |\r\nNETIF_F_HW_VLAN_CTAG_TX |\r\nNETIF_F_HW_VLAN_CTAG_FILTER;\r\nif (pdata->hw_feat.rss)\r\nnetdev->hw_features |= NETIF_F_RXHASH;\r\nnetdev->vlan_features |= NETIF_F_SG |\r\nNETIF_F_IP_CSUM |\r\nNETIF_F_IPV6_CSUM |\r\nNETIF_F_TSO |\r\nNETIF_F_TSO6;\r\nnetdev->features |= netdev->hw_features;\r\npdata->netdev_features = netdev->features;\r\nnetdev->priv_flags |= IFF_UNICAST_FLT;\r\nnetdev->min_mtu = 0;\r\nnetdev->max_mtu = XGMAC_JUMBO_PACKET_MTU;\r\nnetdev->watchdog_timeo = 0;\r\nxgbe_init_rx_coalesce(pdata);\r\nxgbe_init_tx_coalesce(pdata);\r\nnetif_carrier_off(netdev);\r\nret = register_netdev(netdev);\r\nif (ret) {\r\ndev_err(dev, "net device registration failed\n");\r\nreturn ret;\r\n}\r\nsnprintf(pdata->an_name, sizeof(pdata->an_name) - 1, "%s-pcs",\r\nnetdev_name(netdev));\r\nsnprintf(pdata->ecc_name, sizeof(pdata->ecc_name) - 1, "%s-ecc",\r\nnetdev_name(netdev));\r\nsnprintf(pdata->i2c_name, sizeof(pdata->i2c_name) - 1, "%s-i2c",\r\nnetdev_name(netdev));\r\npdata->dev_workqueue =\r\ncreate_singlethread_workqueue(netdev_name(netdev));\r\nif (!pdata->dev_workqueue) {\r\nnetdev_err(netdev, "device workqueue creation failed\n");\r\nret = -ENOMEM;\r\ngoto err_netdev;\r\n}\r\npdata->an_workqueue =\r\ncreate_singlethread_workqueue(pdata->an_name);\r\nif (!pdata->an_workqueue) {\r\nnetdev_err(netdev, "phy workqueue creation failed\n");\r\nret = -ENOMEM;\r\ngoto err_wq;\r\n}\r\nif (IS_REACHABLE(CONFIG_PTP_1588_CLOCK))\r\nxgbe_ptp_register(pdata);\r\nxgbe_debugfs_init(pdata);\r\nnetif_dbg(pdata, drv, pdata->netdev, "%u Tx software queues\n",\r\npdata->tx_ring_count);\r\nnetif_dbg(pdata, drv, pdata->netdev, "%u Rx software queues\n",\r\npdata->rx_ring_count);\r\nreturn 0;\r\nerr_wq:\r\ndestroy_workqueue(pdata->dev_workqueue);\r\nerr_netdev:\r\nunregister_netdev(netdev);\r\nreturn ret;\r\n}\r\nvoid xgbe_deconfig_netdev(struct xgbe_prv_data *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nxgbe_debugfs_exit(pdata);\r\nif (IS_REACHABLE(CONFIG_PTP_1588_CLOCK))\r\nxgbe_ptp_unregister(pdata);\r\npdata->phy_if.phy_exit(pdata);\r\nflush_workqueue(pdata->an_workqueue);\r\ndestroy_workqueue(pdata->an_workqueue);\r\nflush_workqueue(pdata->dev_workqueue);\r\ndestroy_workqueue(pdata->dev_workqueue);\r\nunregister_netdev(netdev);\r\n}\r\nstatic int __init xgbe_mod_init(void)\r\n{\r\nint ret;\r\nret = xgbe_platform_init();\r\nif (ret)\r\nreturn ret;\r\nret = xgbe_pci_init();\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void __exit xgbe_mod_exit(void)\r\n{\r\nxgbe_pci_exit();\r\nxgbe_platform_exit();\r\n}

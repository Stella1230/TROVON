static int counter_val(struct xfsstats __percpu *stats, int idx)\r\n{\r\nint val = 0, cpu;\r\nfor_each_possible_cpu(cpu)\r\nval += *(((__u32 *)per_cpu_ptr(stats, cpu) + idx));\r\nreturn val;\r\n}\r\nint xfs_stats_format(struct xfsstats __percpu *stats, char *buf)\r\n{\r\nint i, j;\r\nint len = 0;\r\n__uint64_t xs_xstrat_bytes = 0;\r\n__uint64_t xs_write_bytes = 0;\r\n__uint64_t xs_read_bytes = 0;\r\nstatic const struct xstats_entry {\r\nchar *desc;\r\nint endpoint;\r\n} xstats[] = {\r\n{ "extent_alloc", XFSSTAT_END_EXTENT_ALLOC },\r\n{ "abt", XFSSTAT_END_ALLOC_BTREE },\r\n{ "blk_map", XFSSTAT_END_BLOCK_MAPPING },\r\n{ "bmbt", XFSSTAT_END_BLOCK_MAP_BTREE },\r\n{ "dir", XFSSTAT_END_DIRECTORY_OPS },\r\n{ "trans", XFSSTAT_END_TRANSACTIONS },\r\n{ "ig", XFSSTAT_END_INODE_OPS },\r\n{ "log", XFSSTAT_END_LOG_OPS },\r\n{ "push_ail", XFSSTAT_END_TAIL_PUSHING },\r\n{ "xstrat", XFSSTAT_END_WRITE_CONVERT },\r\n{ "rw", XFSSTAT_END_READ_WRITE_OPS },\r\n{ "attr", XFSSTAT_END_ATTRIBUTE_OPS },\r\n{ "icluster", XFSSTAT_END_INODE_CLUSTER },\r\n{ "vnodes", XFSSTAT_END_VNODE_OPS },\r\n{ "buf", XFSSTAT_END_BUF },\r\n{ "abtb2", XFSSTAT_END_ABTB_V2 },\r\n{ "abtc2", XFSSTAT_END_ABTC_V2 },\r\n{ "bmbt2", XFSSTAT_END_BMBT_V2 },\r\n{ "ibt2", XFSSTAT_END_IBT_V2 },\r\n{ "fibt2", XFSSTAT_END_FIBT_V2 },\r\n{ "rmapbt", XFSSTAT_END_RMAP_V2 },\r\n{ "refcntbt", XFSSTAT_END_REFCOUNT },\r\n{ "qm", XFSSTAT_END_QM },\r\n};\r\nfor (i = j = 0; i < ARRAY_SIZE(xstats); i++) {\r\nlen += snprintf(buf + len, PATH_MAX - len, "%s",\r\nxstats[i].desc);\r\nfor (; j < xstats[i].endpoint; j++)\r\nlen += snprintf(buf + len, PATH_MAX - len, " %u",\r\ncounter_val(stats, j));\r\nlen += snprintf(buf + len, PATH_MAX - len, "\n");\r\n}\r\nfor_each_possible_cpu(i) {\r\nxs_xstrat_bytes += per_cpu_ptr(stats, i)->s.xs_xstrat_bytes;\r\nxs_write_bytes += per_cpu_ptr(stats, i)->s.xs_write_bytes;\r\nxs_read_bytes += per_cpu_ptr(stats, i)->s.xs_read_bytes;\r\n}\r\nlen += snprintf(buf + len, PATH_MAX-len, "xpc %Lu %Lu %Lu\n",\r\nxs_xstrat_bytes, xs_write_bytes, xs_read_bytes);\r\nlen += snprintf(buf + len, PATH_MAX-len, "debug %u\n",\r\n#if defined(DEBUG)\r\n1);\r\n#else\r\n0);\r\nstatic int xqm_proc_show(struct seq_file *m, void *v)\r\n{\r\nseq_printf(m, "%d\t%d\t%d\t%u\n",\r\n0, counter_val(xfsstats.xs_stats, XFSSTAT_END_XQMSTAT),\r\n0, counter_val(xfsstats.xs_stats, XFSSTAT_END_XQMSTAT + 1));\r\nreturn 0;\r\n}\r\nstatic int xqm_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, xqm_proc_show, NULL);\r\n}\r\nstatic int xqmstat_proc_show(struct seq_file *m, void *v)\r\n{\r\nint j;\r\nseq_printf(m, "qm");\r\nfor (j = XFSSTAT_END_IBT_V2; j < XFSSTAT_END_XQMSTAT; j++)\r\nseq_printf(m, " %u", counter_val(xfsstats.xs_stats, j));\r\nseq_putc(m, '\n');\r\nreturn 0;\r\n}\r\nstatic int xqmstat_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, xqmstat_proc_show, NULL);\r\n}\r\nint\r\nxfs_init_procfs(void)\r\n{\r\nif (!proc_mkdir("fs/xfs", NULL))\r\nreturn -ENOMEM;\r\nif (!proc_symlink("fs/xfs/stat", NULL,\r\n"/sys/fs/xfs/stats/stats"))\r\ngoto out;\r\n#ifdef CONFIG_XFS_QUOTA\r\nif (!proc_create("fs/xfs/xqmstat", 0, NULL,\r\n&xqmstat_proc_fops))\r\ngoto out;\r\nif (!proc_create("fs/xfs/xqm", 0, NULL,\r\n&xqm_proc_fops))\r\ngoto out;\r\n#endif\r\nreturn 0;\r\nout:\r\nremove_proc_subtree("fs/xfs", NULL);\r\nreturn -ENOMEM;\r\n}\r\nvoid\r\nxfs_cleanup_procfs(void)\r\n{\r\nremove_proc_subtree("fs/xfs", NULL);\r\n}

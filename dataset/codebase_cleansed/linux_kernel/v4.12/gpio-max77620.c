static int max77620_gpio_dir_input(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nint ret;\r\nret = regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_DIR_MASK,\r\nMAX77620_CNFG_GPIO_DIR_INPUT);\r\nif (ret < 0)\r\ndev_err(mgpio->dev, "CNFG_GPIOx dir update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_gpio_get(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(mgpio->rmap, GPIO_REG_ADDR(offset), &val);\r\nif (ret < 0) {\r\ndev_err(mgpio->dev, "CNFG_GPIOx read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (val & MAX77620_CNFG_GPIO_DIR_MASK)\r\nreturn !!(val & MAX77620_CNFG_GPIO_INPUT_VAL_MASK);\r\nelse\r\nreturn !!(val & MAX77620_CNFG_GPIO_OUTPUT_VAL_MASK);\r\n}\r\nstatic int max77620_gpio_dir_output(struct gpio_chip *gc, unsigned int offset,\r\nint value)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nu8 val;\r\nint ret;\r\nval = (value) ? MAX77620_CNFG_GPIO_OUTPUT_VAL_HIGH :\r\nMAX77620_CNFG_GPIO_OUTPUT_VAL_LOW;\r\nret = regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_OUTPUT_VAL_MASK, val);\r\nif (ret < 0) {\r\ndev_err(mgpio->dev, "CNFG_GPIOx val update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_DIR_MASK,\r\nMAX77620_CNFG_GPIO_DIR_OUTPUT);\r\nif (ret < 0)\r\ndev_err(mgpio->dev, "CNFG_GPIOx dir update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_gpio_set_debounce(struct max77620_gpio *mgpio,\r\nunsigned int offset,\r\nunsigned int debounce)\r\n{\r\nu8 val;\r\nint ret;\r\nswitch (debounce) {\r\ncase 0:\r\nval = MAX77620_CNFG_GPIO_DBNC_None;\r\nbreak;\r\ncase 1 ... 8:\r\nval = MAX77620_CNFG_GPIO_DBNC_8ms;\r\nbreak;\r\ncase 9 ... 16:\r\nval = MAX77620_CNFG_GPIO_DBNC_16ms;\r\nbreak;\r\ncase 17 ... 32:\r\nval = MAX77620_CNFG_GPIO_DBNC_32ms;\r\nbreak;\r\ndefault:\r\ndev_err(mgpio->dev, "Illegal value %u\n", debounce);\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_DBNC_MASK, val);\r\nif (ret < 0)\r\ndev_err(mgpio->dev, "CNFG_GPIOx_DBNC update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void max77620_gpio_set(struct gpio_chip *gc, unsigned int offset,\r\nint value)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nu8 val;\r\nint ret;\r\nval = (value) ? MAX77620_CNFG_GPIO_OUTPUT_VAL_HIGH :\r\nMAX77620_CNFG_GPIO_OUTPUT_VAL_LOW;\r\nret = regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_OUTPUT_VAL_MASK, val);\r\nif (ret < 0)\r\ndev_err(mgpio->dev, "CNFG_GPIO_OUT update failed: %d\n", ret);\r\n}\r\nstatic int max77620_gpio_set_config(struct gpio_chip *gc, unsigned int offset,\r\nunsigned long config)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nswitch (pinconf_to_config_param(config)) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\nreturn regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_DRV_MASK,\r\nMAX77620_CNFG_GPIO_DRV_OPENDRAIN);\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nreturn regmap_update_bits(mgpio->rmap, GPIO_REG_ADDR(offset),\r\nMAX77620_CNFG_GPIO_DRV_MASK,\r\nMAX77620_CNFG_GPIO_DRV_PUSHPULL);\r\ncase PIN_CONFIG_INPUT_DEBOUNCE:\r\nreturn max77620_gpio_set_debounce(mgpio, offset,\r\npinconf_to_config_argument(config));\r\ndefault:\r\nbreak;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int max77620_gpio_to_irq(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct max77620_gpio *mgpio = gpiochip_get_data(gc);\r\nstruct max77620_chip *chip = dev_get_drvdata(mgpio->dev->parent);\r\nreturn regmap_irq_get_virq(chip->gpio_irq_data, offset);\r\n}\r\nstatic int max77620_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct max77620_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77620_gpio *mgpio;\r\nint gpio_irq;\r\nint ret;\r\ngpio_irq = platform_get_irq(pdev, 0);\r\nif (gpio_irq <= 0) {\r\ndev_err(&pdev->dev, "GPIO irq not available %d\n", gpio_irq);\r\nreturn -ENODEV;\r\n}\r\nmgpio = devm_kzalloc(&pdev->dev, sizeof(*mgpio), GFP_KERNEL);\r\nif (!mgpio)\r\nreturn -ENOMEM;\r\nmgpio->rmap = chip->rmap;\r\nmgpio->dev = &pdev->dev;\r\nmgpio->gpio_chip.label = pdev->name;\r\nmgpio->gpio_chip.parent = &pdev->dev;\r\nmgpio->gpio_chip.direction_input = max77620_gpio_dir_input;\r\nmgpio->gpio_chip.get = max77620_gpio_get;\r\nmgpio->gpio_chip.direction_output = max77620_gpio_dir_output;\r\nmgpio->gpio_chip.set = max77620_gpio_set;\r\nmgpio->gpio_chip.set_config = max77620_gpio_set_config;\r\nmgpio->gpio_chip.to_irq = max77620_gpio_to_irq;\r\nmgpio->gpio_chip.ngpio = MAX77620_GPIO_NR;\r\nmgpio->gpio_chip.can_sleep = 1;\r\nmgpio->gpio_chip.base = -1;\r\n#ifdef CONFIG_OF_GPIO\r\nmgpio->gpio_chip.of_node = pdev->dev.parent->of_node;\r\n#endif\r\nplatform_set_drvdata(pdev, mgpio);\r\nret = devm_gpiochip_add_data(&pdev->dev, &mgpio->gpio_chip, mgpio);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "gpio_init: Failed to add max77620_gpio\n");\r\nreturn ret;\r\n}\r\nret = devm_regmap_add_irq_chip(&pdev->dev, chip->rmap, gpio_irq,\r\nIRQF_ONESHOT, -1,\r\n&max77620_gpio_irq_chip,\r\n&chip->gpio_irq_data);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to add gpio irq_chip %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

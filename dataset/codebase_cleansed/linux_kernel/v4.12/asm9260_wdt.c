static int asm9260_wdt_feed(struct watchdog_device *wdd)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\niowrite32(0xaa, priv->iobase + HW_WDFEED);\r\niowrite32(0x55, priv->iobase + HW_WDFEED);\r\nreturn 0;\r\n}\r\nstatic unsigned int asm9260_wdt_gettimeleft(struct watchdog_device *wdd)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nu32 counter;\r\ncounter = ioread32(priv->iobase + HW_WDTV);\r\nreturn DIV_ROUND_CLOSEST(counter, priv->wdt_freq);\r\n}\r\nstatic int asm9260_wdt_updatetimeout(struct watchdog_device *wdd)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nu32 counter;\r\ncounter = wdd->timeout * priv->wdt_freq;\r\niowrite32(counter, priv->iobase + HW_WDTC);\r\nreturn 0;\r\n}\r\nstatic int asm9260_wdt_enable(struct watchdog_device *wdd)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nu32 mode = 0;\r\nif (priv->mode == HW_RESET)\r\nmode = BM_MOD_WDRESET;\r\niowrite32(BM_MOD_WDEN | mode, priv->iobase + HW_WDMOD);\r\nasm9260_wdt_updatetimeout(wdd);\r\nasm9260_wdt_feed(wdd);\r\nreturn 0;\r\n}\r\nstatic int asm9260_wdt_disable(struct watchdog_device *wdd)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nreset_control_assert(priv->rst);\r\nreset_control_deassert(priv->rst);\r\nreturn 0;\r\n}\r\nstatic int asm9260_wdt_settimeout(struct watchdog_device *wdd, unsigned int to)\r\n{\r\nwdd->timeout = to;\r\nasm9260_wdt_updatetimeout(wdd);\r\nreturn 0;\r\n}\r\nstatic void asm9260_wdt_sys_reset(struct asm9260_wdt_priv *priv)\r\n{\r\niowrite32(BM_MOD_WDEN | BM_MOD_WDRESET, priv->iobase + HW_WDMOD);\r\niowrite32(0xff, priv->iobase + HW_WDTC);\r\nasm9260_wdt_feed(&priv->wdd);\r\niowrite32(0xff, priv->iobase + HW_WDFEED);\r\nmdelay(1000);\r\n}\r\nstatic irqreturn_t asm9260_wdt_irq(int irq, void *devid)\r\n{\r\nstruct asm9260_wdt_priv *priv = devid;\r\nu32 stat;\r\nstat = ioread32(priv->iobase + HW_WDMOD);\r\nif (!(stat & BM_MOD_WDINT))\r\nreturn IRQ_NONE;\r\nif (priv->mode == DEBUG) {\r\ndev_info(priv->dev, "Watchdog Timeout. Do nothing.\n");\r\n} else {\r\ndev_info(priv->dev, "Watchdog Timeout. Doing SW Reset.\n");\r\nasm9260_wdt_sys_reset(priv);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int asm9260_restart(struct watchdog_device *wdd, unsigned long action,\r\nvoid *data)\r\n{\r\nstruct asm9260_wdt_priv *priv = watchdog_get_drvdata(wdd);\r\nasm9260_wdt_sys_reset(priv);\r\nreturn 0;\r\n}\r\nstatic int asm9260_wdt_get_dt_clks(struct asm9260_wdt_priv *priv)\r\n{\r\nint err;\r\nunsigned long clk;\r\npriv->clk = devm_clk_get(priv->dev, "mod");\r\nif (IS_ERR(priv->clk)) {\r\ndev_err(priv->dev, "Failed to get \"mod\" clk\n");\r\nreturn PTR_ERR(priv->clk);\r\n}\r\npriv->clk_ahb = devm_clk_get(priv->dev, "ahb");\r\nif (IS_ERR(priv->clk_ahb)) {\r\ndev_err(priv->dev, "Failed to get \"ahb\" clk\n");\r\nreturn PTR_ERR(priv->clk_ahb);\r\n}\r\nerr = clk_prepare_enable(priv->clk_ahb);\r\nif (err) {\r\ndev_err(priv->dev, "Failed to enable ahb_clk!\n");\r\nreturn err;\r\n}\r\nerr = clk_set_rate(priv->clk, CLOCK_FREQ);\r\nif (err) {\r\nclk_disable_unprepare(priv->clk_ahb);\r\ndev_err(priv->dev, "Failed to set rate!\n");\r\nreturn err;\r\n}\r\nerr = clk_prepare_enable(priv->clk);\r\nif (err) {\r\nclk_disable_unprepare(priv->clk_ahb);\r\ndev_err(priv->dev, "Failed to enable clk!\n");\r\nreturn err;\r\n}\r\nclk = clk_get_rate(priv->clk);\r\nif (!clk) {\r\nclk_disable_unprepare(priv->clk);\r\nclk_disable_unprepare(priv->clk_ahb);\r\ndev_err(priv->dev, "Failed, clk is 0!\n");\r\nreturn -EINVAL;\r\n}\r\npriv->wdt_freq = clk / 2;\r\nreturn 0;\r\n}\r\nstatic void asm9260_wdt_get_dt_mode(struct asm9260_wdt_priv *priv)\r\n{\r\nconst char *tmp;\r\nint ret;\r\npriv->mode = HW_RESET;\r\nret = of_property_read_string(priv->dev->of_node,\r\n"alphascale,mode", &tmp);\r\nif (ret < 0)\r\nreturn;\r\nif (!strcmp(tmp, "hw"))\r\npriv->mode = HW_RESET;\r\nelse if (!strcmp(tmp, "sw"))\r\npriv->mode = SW_RESET;\r\nelse if (!strcmp(tmp, "debug"))\r\npriv->mode = DEBUG;\r\nelse\r\ndev_warn(priv->dev, "unknown reset-type: %s. Using default \"hw\" mode.",\r\ntmp);\r\n}\r\nstatic int asm9260_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct asm9260_wdt_priv *priv;\r\nstruct watchdog_device *wdd;\r\nstruct resource *res;\r\nint ret;\r\nconst char * const mode_name[] = { "hw", "sw", "debug", };\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct asm9260_wdt_priv),\r\nGFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->iobase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->iobase))\r\nreturn PTR_ERR(priv->iobase);\r\nret = asm9260_wdt_get_dt_clks(priv);\r\nif (ret)\r\nreturn ret;\r\npriv->rst = devm_reset_control_get(&pdev->dev, "wdt_rst");\r\nif (IS_ERR(priv->rst))\r\nreturn PTR_ERR(priv->rst);\r\nwdd = &priv->wdd;\r\nwdd->info = &asm9260_wdt_ident;\r\nwdd->ops = &asm9260_wdt_ops;\r\nwdd->min_timeout = 1;\r\nwdd->max_timeout = BM_WDTC_MAX(priv->wdt_freq);\r\nwdd->parent = &pdev->dev;\r\nwatchdog_set_drvdata(wdd, priv);\r\nwdd->timeout = ASM9260_WDT_DEFAULT_TIMEOUT;\r\nwatchdog_init_timeout(wdd, 0, &pdev->dev);\r\nasm9260_wdt_get_dt_mode(priv);\r\nif (priv->mode != HW_RESET)\r\npriv->irq = platform_get_irq(pdev, 0);\r\nif (priv->irq > 0) {\r\nret = devm_request_irq(&pdev->dev, priv->irq,\r\nasm9260_wdt_irq, 0, pdev->name, priv);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "failed to request IRQ\n");\r\n}\r\nwatchdog_set_restart_priority(wdd, 128);\r\nret = watchdog_register_device(wdd);\r\nif (ret)\r\ngoto clk_off;\r\nplatform_set_drvdata(pdev, priv);\r\ndev_info(&pdev->dev, "Watchdog enabled (timeout: %d sec, mode: %s)\n",\r\nwdd->timeout, mode_name[priv->mode]);\r\nreturn 0;\r\nclk_off:\r\nclk_disable_unprepare(priv->clk);\r\nclk_disable_unprepare(priv->clk_ahb);\r\nreturn ret;\r\n}\r\nstatic void asm9260_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct asm9260_wdt_priv *priv = platform_get_drvdata(pdev);\r\nasm9260_wdt_disable(&priv->wdd);\r\n}\r\nstatic int asm9260_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct asm9260_wdt_priv *priv = platform_get_drvdata(pdev);\r\nasm9260_wdt_disable(&priv->wdd);\r\nwatchdog_unregister_device(&priv->wdd);\r\nclk_disable_unprepare(priv->clk);\r\nclk_disable_unprepare(priv->clk_ahb);\r\nreturn 0;\r\n}

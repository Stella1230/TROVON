static int __bpf_mt_check_bytecode(struct sock_filter *insns, __u16 len,\r\nstruct bpf_prog **ret)\r\n{\r\nstruct sock_fprog_kern program;\r\nprogram.len = len;\r\nprogram.filter = insns;\r\nif (bpf_prog_create(ret, &program)) {\r\npr_info("bpf: check failed: parse error\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __bpf_mt_check_fd(int fd, struct bpf_prog **ret)\r\n{\r\nstruct bpf_prog *prog;\r\nprog = bpf_prog_get_type(fd, BPF_PROG_TYPE_SOCKET_FILTER);\r\nif (IS_ERR(prog))\r\nreturn PTR_ERR(prog);\r\n*ret = prog;\r\nreturn 0;\r\n}\r\nstatic int bpf_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_bpf_info *info = par->matchinfo;\r\nreturn __bpf_mt_check_bytecode(info->bpf_program,\r\ninfo->bpf_program_num_elem,\r\n&info->filter);\r\n}\r\nstatic int bpf_mt_check_v1(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_bpf_info_v1 *info = par->matchinfo;\r\nif (info->mode == XT_BPF_MODE_BYTECODE)\r\nreturn __bpf_mt_check_bytecode(info->bpf_program,\r\ninfo->bpf_program_num_elem,\r\n&info->filter);\r\nelse if (info->mode == XT_BPF_MODE_FD_PINNED ||\r\ninfo->mode == XT_BPF_MODE_FD_ELF)\r\nreturn __bpf_mt_check_fd(info->fd, &info->filter);\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic bool bpf_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_bpf_info *info = par->matchinfo;\r\nreturn BPF_PROG_RUN(info->filter, skb);\r\n}\r\nstatic bool bpf_mt_v1(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_bpf_info_v1 *info = par->matchinfo;\r\nreturn !!bpf_prog_run_save_cb(info->filter, (struct sk_buff *) skb);\r\n}\r\nstatic void bpf_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nconst struct xt_bpf_info *info = par->matchinfo;\r\nbpf_prog_destroy(info->filter);\r\n}\r\nstatic void bpf_mt_destroy_v1(const struct xt_mtdtor_param *par)\r\n{\r\nconst struct xt_bpf_info_v1 *info = par->matchinfo;\r\nbpf_prog_destroy(info->filter);\r\n}\r\nstatic int __init bpf_mt_init(void)\r\n{\r\nreturn xt_register_matches(bpf_mt_reg, ARRAY_SIZE(bpf_mt_reg));\r\n}\r\nstatic void __exit bpf_mt_exit(void)\r\n{\r\nxt_unregister_matches(bpf_mt_reg, ARRAY_SIZE(bpf_mt_reg));\r\n}

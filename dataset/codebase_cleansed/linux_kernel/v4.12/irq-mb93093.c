static void frv_fpga_mask(struct irq_data *d)\r\n{\r\nuint16_t imr = __get_IMR();\r\nimr |= 1 << (d->irq - IRQ_BASE_FPGA);\r\n__set_IMR(imr);\r\n}\r\nstatic void frv_fpga_ack(struct irq_data *d)\r\n{\r\n__clr_IFR(1 << (d->irq - IRQ_BASE_FPGA));\r\n}\r\nstatic void frv_fpga_mask_ack(struct irq_data *d)\r\n{\r\nuint16_t imr = __get_IMR();\r\nimr |= 1 << (d->irq - IRQ_BASE_FPGA);\r\n__set_IMR(imr);\r\n__clr_IFR(1 << (d->irq - IRQ_BASE_FPGA));\r\n}\r\nstatic void frv_fpga_unmask(struct irq_data *d)\r\n{\r\nuint16_t imr = __get_IMR();\r\nimr &= ~(1 << (d->irq - IRQ_BASE_FPGA));\r\n__set_IMR(imr);\r\n}\r\nstatic irqreturn_t fpga_interrupt(int irq, void *_mask)\r\n{\r\nuint16_t imr, mask = (unsigned long) _mask;\r\nimr = __get_IMR();\r\nmask = mask & ~imr & __get_IFR();\r\nwhile (mask) {\r\nint irq;\r\nasm("scan %1,gr0,%0" : "=r"(irq) : "r"(mask));\r\nirq = 31 - irq;\r\nmask &= ~(1 << irq);\r\ngeneric_handle_irq(IRQ_BASE_FPGA + irq);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init fpga_init(void)\r\n{\r\nint irq;\r\n__set_IMR(0x0700);\r\n__clr_IFR(0x0000);\r\nfor (irq = IRQ_BASE_FPGA + 8; irq <= IRQ_BASE_FPGA + 10; irq++)\r\nirq_set_chip_and_handler(irq, &frv_fpga_pic, handle_edge_irq);\r\nsetup_irq(IRQ_CPU_EXTERNAL2, &fpga_irq[0]);\r\n}

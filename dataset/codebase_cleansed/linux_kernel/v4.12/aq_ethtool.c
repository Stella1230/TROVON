static void aq_ethtool_get_regs(struct net_device *ndev,\r\nstruct ethtool_regs *regs, void *p)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nu32 regs_count = aq_nic_get_regs_count(aq_nic);\r\nmemset(p, 0, regs_count * sizeof(u32));\r\naq_nic_get_regs(aq_nic, regs, p);\r\n}\r\nstatic int aq_ethtool_get_regs_len(struct net_device *ndev)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nu32 regs_count = aq_nic_get_regs_count(aq_nic);\r\nreturn regs_count * sizeof(u32);\r\n}\r\nstatic u32 aq_ethtool_get_link(struct net_device *ndev)\r\n{\r\nreturn ethtool_op_get_link(ndev);\r\n}\r\nstatic int aq_ethtool_get_link_ksettings(struct net_device *ndev,\r\nstruct ethtool_link_ksettings *cmd)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\naq_nic_get_link_ksettings(aq_nic, cmd);\r\ncmd->base.speed = netif_carrier_ok(ndev) ?\r\naq_nic_get_link_speed(aq_nic) : 0U;\r\nreturn 0;\r\n}\r\nstatic int\r\naq_ethtool_set_link_ksettings(struct net_device *ndev,\r\nconst struct ethtool_link_ksettings *cmd)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nreturn aq_nic_set_link_ksettings(aq_nic, cmd);\r\n}\r\nstatic void aq_ethtool_stats(struct net_device *ndev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nBUILD_BUG_ON(AQ_CFG_VECS_MAX > 8);\r\nmemset(data, 0, ARRAY_SIZE(aq_ethtool_stat_names) * sizeof(u64));\r\naq_nic_get_stats(aq_nic, data);\r\n}\r\nstatic void aq_ethtool_get_drvinfo(struct net_device *ndev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nstruct pci_dev *pdev = to_pci_dev(ndev->dev.parent);\r\nu32 firmware_version = aq_nic_get_fw_version(aq_nic);\r\nu32 regs_count = aq_nic_get_regs_count(aq_nic);\r\nstrlcat(drvinfo->driver, AQ_CFG_DRV_NAME, sizeof(drvinfo->driver));\r\nstrlcat(drvinfo->version, AQ_CFG_DRV_VERSION, sizeof(drvinfo->version));\r\nsnprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\r\n"%u.%u.%u", firmware_version >> 24,\r\n(firmware_version >> 16) & 0xFFU, firmware_version & 0xFFFFU);\r\nstrlcpy(drvinfo->bus_info, pdev ? pci_name(pdev) : "",\r\nsizeof(drvinfo->bus_info));\r\ndrvinfo->n_stats = ARRAY_SIZE(aq_ethtool_stat_names) -\r\n(AQ_CFG_VECS_MAX - cfg->vecs) * aq_ethtool_stat_queue_lines;\r\ndrvinfo->testinfo_len = 0;\r\ndrvinfo->regdump_len = regs_count;\r\ndrvinfo->eedump_len = 0;\r\n}\r\nstatic void aq_ethtool_get_strings(struct net_device *ndev,\r\nu32 stringset, u8 *data)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nif (stringset == ETH_SS_STATS)\r\nmemcpy(data, *aq_ethtool_stat_names,\r\nsizeof(aq_ethtool_stat_names) -\r\n(AQ_CFG_VECS_MAX - cfg->vecs) *\r\naq_ethtool_stat_queue_chars);\r\n}\r\nstatic int aq_ethtool_get_sset_count(struct net_device *ndev, int stringset)\r\n{\r\nint ret = 0;\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nswitch (stringset) {\r\ncase ETH_SS_STATS:\r\nret = ARRAY_SIZE(aq_ethtool_stat_names) -\r\n(AQ_CFG_VECS_MAX - cfg->vecs) *\r\naq_ethtool_stat_queue_lines;\r\nbreak;\r\ndefault:\r\nret = -EOPNOTSUPP;\r\n}\r\nreturn ret;\r\n}\r\nstatic u32 aq_ethtool_get_rss_indir_size(struct net_device *ndev)\r\n{\r\nreturn AQ_CFG_RSS_INDIRECTION_TABLE_MAX;\r\n}\r\nstatic u32 aq_ethtool_get_rss_key_size(struct net_device *ndev)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nreturn sizeof(cfg->aq_rss.hash_secret_key);\r\n}\r\nstatic int aq_ethtool_get_rss(struct net_device *ndev, u32 *indir, u8 *key,\r\nu8 *hfunc)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nunsigned int i = 0U;\r\nif (hfunc)\r\n*hfunc = ETH_RSS_HASH_TOP;\r\nif (indir) {\r\nfor (i = 0; i < AQ_CFG_RSS_INDIRECTION_TABLE_MAX; i++)\r\nindir[i] = cfg->aq_rss.indirection_table[i];\r\n}\r\nif (key)\r\nmemcpy(key, cfg->aq_rss.hash_secret_key,\r\nsizeof(cfg->aq_rss.hash_secret_key));\r\nreturn 0;\r\n}\r\nstatic int aq_ethtool_get_rxnfc(struct net_device *ndev,\r\nstruct ethtool_rxnfc *cmd,\r\nu32 *rule_locs)\r\n{\r\nstruct aq_nic_s *aq_nic = netdev_priv(ndev);\r\nstruct aq_nic_cfg_s *cfg = aq_nic_get_cfg(aq_nic);\r\nint err = 0;\r\nswitch (cmd->cmd) {\r\ncase ETHTOOL_GRXRINGS:\r\ncmd->data = cfg->vecs;\r\nbreak;\r\ndefault:\r\nerr = -EOPNOTSUPP;\r\nbreak;\r\n}\r\nreturn err;\r\n}

void libcfs_run_debug_log_upcall(char *file)\r\n{\r\nchar *argv[3];\r\nint rc;\r\nstatic const char * const envp[] = {\r\n"HOME=/",\r\n"PATH=/sbin:/bin:/usr/sbin:/usr/bin",\r\nNULL\r\n};\r\nargv[0] = lnet_debug_log_upcall;\r\nLASSERTF(file, "called on a null filename\n");\r\nargv[1] = file;\r\nargv[2] = NULL;\r\nrc = call_usermodehelper(argv[0], argv, (char **)envp, 1);\r\nif (rc < 0 && rc != -ENOENT) {\r\nCERROR("Error %d invoking LNET debug log upcall %s %s; check /sys/kernel/debug/lnet/debug_log_upcall\n",\r\nrc, argv[0], argv[1]);\r\n} else {\r\nCDEBUG(D_HA, "Invoked LNET debug log upcall %s %s\n",\r\nargv[0], argv[1]);\r\n}\r\n}\r\nvoid __noreturn lbug_with_loc(struct libcfs_debug_msg_data *msgdata)\r\n{\r\nlibcfs_catastrophe = 1;\r\nlibcfs_debug_msg(msgdata, "LBUG\n");\r\nif (in_interrupt()) {\r\npanic("LBUG in interrupt.\n");\r\n}\r\ndump_stack();\r\nif (!libcfs_panic_on_lbug)\r\nlibcfs_debug_dumplog();\r\nif (libcfs_panic_on_lbug)\r\npanic("LBUG");\r\nset_current_state(TASK_UNINTERRUPTIBLE);\r\nwhile (1)\r\nschedule();\r\n}\r\nstatic int panic_notifier(struct notifier_block *self, unsigned long unused1,\r\nvoid *unused2)\r\n{\r\nif (libcfs_panic_in_progress)\r\nreturn 0;\r\nlibcfs_panic_in_progress = 1;\r\nmb();\r\nreturn 0;\r\n}\r\nvoid libcfs_register_panic_notifier(void)\r\n{\r\natomic_notifier_chain_register(&panic_notifier_list,\r\n&libcfs_panic_notifier);\r\n}\r\nvoid libcfs_unregister_panic_notifier(void)\r\n{\r\natomic_notifier_chain_unregister(&panic_notifier_list,\r\n&libcfs_panic_notifier);\r\n}

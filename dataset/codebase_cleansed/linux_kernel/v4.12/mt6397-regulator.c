static int mt6397_regulator_set_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nstruct mt6397_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret, val;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\nval = MT6397_BUCK_MODE_FORCE_PWM;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\nval = MT6397_BUCK_MODE_AUTO;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto err_mode;\r\n}\r\ndev_dbg(&rdev->dev, "mt6397 buck set_mode %#x, %#x, %#x, %#x\n",\r\ninfo->modeset_reg, info->modeset_mask,\r\ninfo->modeset_shift, val);\r\nval <<= info->modeset_shift;\r\nret = regmap_update_bits(rdev->regmap, info->modeset_reg,\r\ninfo->modeset_mask, val);\r\nerr_mode:\r\nif (ret != 0) {\r\ndev_err(&rdev->dev,\r\n"Failed to set mt6397 buck mode: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int mt6397_regulator_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct mt6397_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret, regval;\r\nret = regmap_read(rdev->regmap, info->modeset_reg, &regval);\r\nif (ret != 0) {\r\ndev_err(&rdev->dev,\r\n"Failed to get mt6397 buck mode: %d\n", ret);\r\nreturn ret;\r\n}\r\nswitch ((regval & info->modeset_mask) >> info->modeset_shift) {\r\ncase MT6397_BUCK_MODE_AUTO:\r\nreturn REGULATOR_MODE_NORMAL;\r\ncase MT6397_BUCK_MODE_FORCE_PWM:\r\nreturn REGULATOR_MODE_FAST;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int mt6397_get_status(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nu32 regval;\r\nstruct mt6397_regulator_info *info = rdev_get_drvdata(rdev);\r\nret = regmap_read(rdev->regmap, info->desc.enable_reg, &regval);\r\nif (ret != 0) {\r\ndev_err(&rdev->dev, "Failed to get enable reg: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn (regval & info->qi) ? REGULATOR_STATUS_ON : REGULATOR_STATUS_OFF;\r\n}\r\nstatic int mt6397_set_buck_vosel_reg(struct platform_device *pdev)\r\n{\r\nstruct mt6397_chip *mt6397 = dev_get_drvdata(pdev->dev.parent);\r\nint i;\r\nu32 regval;\r\nfor (i = 0; i < MT6397_MAX_REGULATOR; i++) {\r\nif (mt6397_regulators[i].vselctrl_reg) {\r\nif (regmap_read(mt6397->regmap,\r\nmt6397_regulators[i].vselctrl_reg,\r\n&regval) < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to read buck ctrl\n");\r\nreturn -EIO;\r\n}\r\nif (regval & mt6397_regulators[i].vselctrl_mask) {\r\nmt6397_regulators[i].desc.vsel_reg =\r\nmt6397_regulators[i].vselon_reg;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt6397_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct mt6397_chip *mt6397 = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_config config = {};\r\nstruct regulator_dev *rdev;\r\nint i;\r\nu32 reg_value, version;\r\nif (mt6397_set_buck_vosel_reg(pdev))\r\nreturn -EIO;\r\nif (regmap_read(mt6397->regmap, MT6397_CID, &reg_value) < 0) {\r\ndev_err(&pdev->dev, "Failed to read Chip ID\n");\r\nreturn -EIO;\r\n}\r\ndev_info(&pdev->dev, "Chip ID = 0x%x\n", reg_value);\r\nversion = (reg_value & 0xFF);\r\nswitch (version) {\r\ncase MT6397_REGULATOR_ID91:\r\nmt6397_regulators[MT6397_ID_VGP2].desc.volt_table =\r\nldo_volt_table5_v2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nfor (i = 0; i < MT6397_MAX_REGULATOR; i++) {\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = &mt6397_regulators[i];\r\nconfig.regmap = mt6397->regmap;\r\nrdev = devm_regulator_register(&pdev->dev,\r\n&mt6397_regulators[i].desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register %s\n",\r\nmt6397_regulators[i].desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}

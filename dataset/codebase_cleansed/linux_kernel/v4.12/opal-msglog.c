ssize_t opal_msglog_copy(char *to, loff_t pos, size_t count)\r\n{\r\nconst char *conbuf;\r\nssize_t ret;\r\nsize_t first_read = 0;\r\nuint32_t out_pos, avail;\r\nif (!opal_memcons)\r\nreturn -ENODEV;\r\nout_pos = be32_to_cpu(ACCESS_ONCE(opal_memcons->out_pos));\r\nsmp_rmb();\r\nconbuf = phys_to_virt(be64_to_cpu(opal_memcons->obuf_phys));\r\nif (out_pos & MEMCONS_OUT_POS_WRAP) {\r\nout_pos &= MEMCONS_OUT_POS_MASK;\r\navail = be32_to_cpu(opal_memcons->obuf_size) - out_pos;\r\nret = memory_read_from_buffer(to, count, &pos,\r\nconbuf + out_pos, avail);\r\nif (ret < 0)\r\ngoto out;\r\nfirst_read = ret;\r\nto += first_read;\r\ncount -= first_read;\r\npos -= avail;\r\nif (count <= 0)\r\ngoto out;\r\n}\r\nif (out_pos > be32_to_cpu(opal_memcons->obuf_size)) {\r\npr_err("OPAL: memory console corruption. Aborting read.\n");\r\nreturn -EINVAL;\r\n}\r\nret = memory_read_from_buffer(to, count, &pos, conbuf, out_pos);\r\nif (ret < 0)\r\ngoto out;\r\nret += first_read;\r\nout:\r\nreturn ret;\r\n}\r\nstatic ssize_t opal_msglog_read(struct file *file, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr, char *to,\r\nloff_t pos, size_t count)\r\n{\r\nreturn opal_msglog_copy(to, pos, count);\r\n}\r\nvoid __init opal_msglog_init(void)\r\n{\r\nu64 mcaddr;\r\nstruct memcons *mc;\r\nif (of_property_read_u64(opal_node, "ibm,opal-memcons", &mcaddr)) {\r\npr_warn("OPAL: Property ibm,opal-memcons not found, no message log\n");\r\nreturn;\r\n}\r\nmc = phys_to_virt(mcaddr);\r\nif (!mc) {\r\npr_warn("OPAL: memory console address is invalid\n");\r\nreturn;\r\n}\r\nif (be64_to_cpu(mc->magic) != MEMCONS_MAGIC) {\r\npr_warn("OPAL: memory console version is invalid\n");\r\nreturn;\r\n}\r\nopal_msglog_attr.size = be32_to_cpu(mc->ibuf_size) +\r\nbe32_to_cpu(mc->obuf_size);\r\nopal_memcons = mc;\r\n}\r\nvoid __init opal_msglog_sysfs_init(void)\r\n{\r\nif (!opal_memcons) {\r\npr_warn("OPAL: message log initialisation failed, not creating sysfs entry\n");\r\nreturn;\r\n}\r\nif (sysfs_create_bin_file(opal_kobj, &opal_msglog_attr) != 0)\r\npr_warn("OPAL: sysfs file creation failed\n");\r\n}

static bool __init processor_physically_present(acpi_handle handle)\r\n{\r\nint cpuid, type;\r\nu32 acpi_id;\r\nacpi_status status;\r\nacpi_object_type acpi_type;\r\nunsigned long long tmp;\r\nunion acpi_object object = { 0 };\r\nstruct acpi_buffer buffer = { sizeof(union acpi_object), &object };\r\nstatus = acpi_get_type(handle, &acpi_type);\r\nif (ACPI_FAILURE(status))\r\nreturn false;\r\nswitch (acpi_type) {\r\ncase ACPI_TYPE_PROCESSOR:\r\nstatus = acpi_evaluate_object(handle, NULL, NULL, &buffer);\r\nif (ACPI_FAILURE(status))\r\nreturn false;\r\nacpi_id = object.processor.proc_id;\r\nbreak;\r\ncase ACPI_TYPE_DEVICE:\r\nstatus = acpi_evaluate_integer(handle, "_UID", NULL, &tmp);\r\nif (ACPI_FAILURE(status))\r\nreturn false;\r\nacpi_id = tmp;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\ntype = (acpi_type == ACPI_TYPE_DEVICE) ? 1 : 0;\r\ncpuid = acpi_get_cpuid(handle, type, acpi_id);\r\nreturn !invalid_logical_cpuid(cpuid);\r\n}\r\nstatic void acpi_set_pdc_bits(u32 *buf)\r\n{\r\nbuf[0] = ACPI_PDC_REVISION_ID;\r\nbuf[1] = 1;\r\nbuf[2] = ACPI_PDC_SMP_T_SWCOORD;\r\narch_acpi_set_pdc_bits(buf);\r\n}\r\nstatic struct acpi_object_list *acpi_processor_alloc_pdc(void)\r\n{\r\nstruct acpi_object_list *obj_list;\r\nunion acpi_object *obj;\r\nu32 *buf;\r\nobj_list = kmalloc(sizeof(struct acpi_object_list), GFP_KERNEL);\r\nif (!obj_list)\r\ngoto out;\r\nobj = kmalloc(sizeof(union acpi_object), GFP_KERNEL);\r\nif (!obj) {\r\nkfree(obj_list);\r\ngoto out;\r\n}\r\nbuf = kmalloc(12, GFP_KERNEL);\r\nif (!buf) {\r\nkfree(obj);\r\nkfree(obj_list);\r\ngoto out;\r\n}\r\nacpi_set_pdc_bits(buf);\r\nobj->type = ACPI_TYPE_BUFFER;\r\nobj->buffer.length = 12;\r\nobj->buffer.pointer = (u8 *) buf;\r\nobj_list->count = 1;\r\nobj_list->pointer = obj;\r\nreturn obj_list;\r\nout:\r\npr_err("Memory allocation error\n");\r\nreturn NULL;\r\n}\r\nstatic acpi_status\r\nacpi_processor_eval_pdc(acpi_handle handle, struct acpi_object_list *pdc_in)\r\n{\r\nacpi_status status = AE_OK;\r\nif (boot_option_idle_override == IDLE_NOMWAIT) {\r\nunion acpi_object *obj;\r\nu32 *buffer = NULL;\r\nobj = pdc_in->pointer;\r\nbuffer = (u32 *)(obj->buffer.pointer);\r\nbuffer[2] &= ~(ACPI_PDC_C_C2C3_FFH | ACPI_PDC_C_C1_FFH);\r\n}\r\nstatus = acpi_evaluate_object(handle, "_PDC", pdc_in, NULL);\r\nif (ACPI_FAILURE(status))\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Could not evaluate _PDC, using legacy perf. control.\n"));\r\nreturn status;\r\n}\r\nvoid acpi_processor_set_pdc(acpi_handle handle)\r\n{\r\nstruct acpi_object_list *obj_list;\r\nif (arch_has_acpi_pdc() == false)\r\nreturn;\r\nobj_list = acpi_processor_alloc_pdc();\r\nif (!obj_list)\r\nreturn;\r\nacpi_processor_eval_pdc(handle, obj_list);\r\nkfree(obj_list->pointer->buffer.pointer);\r\nkfree(obj_list->pointer);\r\nkfree(obj_list);\r\n}\r\nstatic acpi_status __init\r\nearly_init_pdc(acpi_handle handle, u32 lvl, void *context, void **rv)\r\n{\r\nif (processor_physically_present(handle) == false)\r\nreturn AE_OK;\r\nacpi_processor_set_pdc(handle);\r\nreturn AE_OK;\r\n}\r\nstatic int __init set_no_mwait(const struct dmi_system_id *id)\r\n{\r\npr_notice("%s detected - disabling mwait for CPU C-states\n",\r\nid->ident);\r\nboot_option_idle_override = IDLE_NOMWAIT;\r\nreturn 0;\r\n}\r\nstatic void __init processor_dmi_check(void)\r\n{\r\ndmi_check_system(processor_idle_dmi_table);\r\n}\r\nvoid __init acpi_early_processor_set_pdc(void)\r\n{\r\nprocessor_dmi_check();\r\nacpi_walk_namespace(ACPI_TYPE_PROCESSOR, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX,\r\nearly_init_pdc, NULL, NULL, NULL);\r\nacpi_get_devices(ACPI_PROCESSOR_DEVICE_HID, early_init_pdc, NULL, NULL);\r\n}

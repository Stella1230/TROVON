static irqreturn_t bq27xxx_battery_irq_handler_thread(int irq, void *data)\r\n{\r\nstruct bq27xxx_device_info *di = data;\r\nbq27xxx_battery_update(di);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int bq27xxx_battery_i2c_read(struct bq27xxx_device_info *di, u8 reg,\r\nbool single)\r\n{\r\nstruct i2c_client *client = to_i2c_client(di->dev);\r\nstruct i2c_msg msg[2];\r\nunsigned char data[2];\r\nint ret;\r\nif (!client->adapter)\r\nreturn -ENODEV;\r\nmsg[0].addr = client->addr;\r\nmsg[0].flags = 0;\r\nmsg[0].buf = &reg;\r\nmsg[0].len = sizeof(reg);\r\nmsg[1].addr = client->addr;\r\nmsg[1].flags = I2C_M_RD;\r\nmsg[1].buf = data;\r\nif (single)\r\nmsg[1].len = 1;\r\nelse\r\nmsg[1].len = 2;\r\nret = i2c_transfer(client->adapter, msg, ARRAY_SIZE(msg));\r\nif (ret < 0)\r\nreturn ret;\r\nif (!single)\r\nret = get_unaligned_le16(data);\r\nelse\r\nret = data[0];\r\nreturn ret;\r\n}\r\nstatic int bq27xxx_battery_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct bq27xxx_device_info *di;\r\nint ret;\r\nchar *name;\r\nint num;\r\nmutex_lock(&battery_mutex);\r\nnum = idr_alloc(&battery_id, client, 0, 0, GFP_KERNEL);\r\nmutex_unlock(&battery_mutex);\r\nif (num < 0)\r\nreturn num;\r\nname = devm_kasprintf(&client->dev, GFP_KERNEL, "%s-%d", id->name, num);\r\nif (!name)\r\ngoto err_mem;\r\ndi = devm_kzalloc(&client->dev, sizeof(*di), GFP_KERNEL);\r\nif (!di)\r\ngoto err_mem;\r\ndi->id = num;\r\ndi->dev = &client->dev;\r\ndi->chip = id->driver_data;\r\ndi->name = name;\r\ndi->bus.read = bq27xxx_battery_i2c_read;\r\nret = bq27xxx_battery_setup(di);\r\nif (ret)\r\ngoto err_failed;\r\nschedule_delayed_work(&di->work, 60 * HZ);\r\ni2c_set_clientdata(client, di);\r\nif (client->irq) {\r\nret = devm_request_threaded_irq(&client->dev, client->irq,\r\nNULL, bq27xxx_battery_irq_handler_thread,\r\nIRQF_ONESHOT,\r\ndi->name, di);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"Unable to register IRQ %d error %d\n",\r\nclient->irq, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\nerr_mem:\r\nret = -ENOMEM;\r\nerr_failed:\r\nmutex_lock(&battery_mutex);\r\nidr_remove(&battery_id, num);\r\nmutex_unlock(&battery_mutex);\r\nreturn ret;\r\n}\r\nstatic int bq27xxx_battery_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct bq27xxx_device_info *di = i2c_get_clientdata(client);\r\nbq27xxx_battery_teardown(di);\r\nmutex_lock(&battery_mutex);\r\nidr_remove(&battery_id, di->id);\r\nmutex_unlock(&battery_mutex);\r\nreturn 0;\r\n}

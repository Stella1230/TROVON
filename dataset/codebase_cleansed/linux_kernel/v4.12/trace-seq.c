void trace_seq_init(struct trace_seq *s)\r\n{\r\ns->len = 0;\r\ns->readpos = 0;\r\ns->buffer_size = TRACE_SEQ_BUF_SIZE;\r\ns->buffer = malloc(s->buffer_size);\r\nif (s->buffer != NULL)\r\ns->state = TRACE_SEQ__GOOD;\r\nelse\r\ns->state = TRACE_SEQ__MEM_ALLOC_FAILED;\r\n}\r\nvoid trace_seq_reset(struct trace_seq *s)\r\n{\r\nif (!s)\r\nreturn;\r\nTRACE_SEQ_CHECK(s);\r\ns->len = 0;\r\ns->readpos = 0;\r\n}\r\nvoid trace_seq_destroy(struct trace_seq *s)\r\n{\r\nif (!s)\r\nreturn;\r\nTRACE_SEQ_CHECK_RET(s);\r\nfree(s->buffer);\r\ns->buffer = TRACE_SEQ_POISON;\r\n}\r\nstatic void expand_buffer(struct trace_seq *s)\r\n{\r\nchar *buf;\r\nbuf = realloc(s->buffer, s->buffer_size + TRACE_SEQ_BUF_SIZE);\r\nif (WARN_ONCE(!buf, "Can't allocate trace_seq buffer memory")) {\r\ns->state = TRACE_SEQ__MEM_ALLOC_FAILED;\r\nreturn;\r\n}\r\ns->buffer = buf;\r\ns->buffer_size += TRACE_SEQ_BUF_SIZE;\r\n}\r\nint\r\ntrace_seq_printf(struct trace_seq *s, const char *fmt, ...)\r\n{\r\nva_list ap;\r\nint len;\r\nint ret;\r\ntry_again:\r\nTRACE_SEQ_CHECK_RET0(s);\r\nlen = (s->buffer_size - 1) - s->len;\r\nva_start(ap, fmt);\r\nret = vsnprintf(s->buffer + s->len, len, fmt, ap);\r\nva_end(ap);\r\nif (ret >= len) {\r\nexpand_buffer(s);\r\ngoto try_again;\r\n}\r\ns->len += ret;\r\nreturn 1;\r\n}\r\nint\r\ntrace_seq_vprintf(struct trace_seq *s, const char *fmt, va_list args)\r\n{\r\nint len;\r\nint ret;\r\ntry_again:\r\nTRACE_SEQ_CHECK_RET0(s);\r\nlen = (s->buffer_size - 1) - s->len;\r\nret = vsnprintf(s->buffer + s->len, len, fmt, args);\r\nif (ret >= len) {\r\nexpand_buffer(s);\r\ngoto try_again;\r\n}\r\ns->len += ret;\r\nreturn len;\r\n}\r\nint trace_seq_puts(struct trace_seq *s, const char *str)\r\n{\r\nint len;\r\nTRACE_SEQ_CHECK_RET0(s);\r\nlen = strlen(str);\r\nwhile (len > ((s->buffer_size - 1) - s->len))\r\nexpand_buffer(s);\r\nTRACE_SEQ_CHECK_RET0(s);\r\nmemcpy(s->buffer + s->len, str, len);\r\ns->len += len;\r\nreturn len;\r\n}\r\nint trace_seq_putc(struct trace_seq *s, unsigned char c)\r\n{\r\nTRACE_SEQ_CHECK_RET0(s);\r\nwhile (s->len >= (s->buffer_size - 1))\r\nexpand_buffer(s);\r\nTRACE_SEQ_CHECK_RET0(s);\r\ns->buffer[s->len++] = c;\r\nreturn 1;\r\n}\r\nvoid trace_seq_terminate(struct trace_seq *s)\r\n{\r\nTRACE_SEQ_CHECK_RET(s);\r\ns->buffer[s->len] = 0;\r\n}\r\nint trace_seq_do_fprintf(struct trace_seq *s, FILE *fp)\r\n{\r\nTRACE_SEQ_CHECK(s);\r\nswitch (s->state) {\r\ncase TRACE_SEQ__GOOD:\r\nreturn fprintf(fp, "%.*s", s->len, s->buffer);\r\ncase TRACE_SEQ__BUFFER_POISONED:\r\nfprintf(fp, "%s\n", "Usage of trace_seq after it was destroyed");\r\nbreak;\r\ncase TRACE_SEQ__MEM_ALLOC_FAILED:\r\nfprintf(fp, "%s\n", "Can't allocate trace_seq buffer memory");\r\nbreak;\r\n}\r\nreturn -1;\r\n}\r\nint trace_seq_do_printf(struct trace_seq *s)\r\n{\r\nreturn trace_seq_do_fprintf(s, stdout);\r\n}

static int\r\ntsi57x_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 route_port)\r\n{\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_DESTID, route_destid);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_PORT, route_port);\r\n} else {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table), route_destid);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table), route_port);\r\n}\r\nudelay(10);\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi57x_route_get_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 *route_port)\r\n{\r\nint ret = 0;\r\nu32 result;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_SWP_INFO_CAR, &result);\r\ntable = (result & RIO_SWP_INFO_PORT_NUM_MASK);\r\n}\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table), route_destid);\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table), &result);\r\n*route_port = (u8)result;\r\nif (*route_port > 15)\r\nret = -1;\r\nreturn ret;\r\n}\r\nstatic int\r\ntsi57x_route_clr_table(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table)\r\n{\r\nu32 route_idx;\r\nu32 lut_size;\r\nlut_size = (mport->sys_size) ? 0x1ff : 0xff;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_DESTID, 0x80000000);\r\nfor (route_idx = 0; route_idx <= lut_size; route_idx++)\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_PORT,\r\nRIO_INVALID_ROUTE);\r\n} else {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table), 0x80000000);\r\nfor (route_idx = 0; route_idx <= lut_size; route_idx++)\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table) , RIO_INVALID_ROUTE);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi57x_set_domain(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu8 sw_domain)\r\n{\r\nu32 regval;\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nTSI578_SP_MODE_GLBL, &regval);\r\nrio_mport_write_config_32(mport, destid, hopcount, TSI578_SP_MODE_GLBL,\r\nregval & ~TSI578_SP_MODE_LUT_512);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nTSI578_GLBL_ROUTE_BASE,\r\n(u32)(sw_domain << 24));\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi57x_get_domain(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu8 *sw_domain)\r\n{\r\nu32 regval;\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nTSI578_GLBL_ROUTE_BASE, &regval);\r\n*sw_domain = (u8)(regval >> 24);\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi57x_em_init(struct rio_dev *rdev)\r\n{\r\nu32 regval;\r\nint portnum;\r\npr_debug("TSI578 %s [%d:%d]\n", __func__, rdev->destid, rdev->hopcount);\r\nfor (portnum = 0;\r\nportnum < RIO_GET_TOTAL_PORTS(rdev->swpinfo); portnum++) {\r\nrio_read_config_32(rdev,\r\nTSI578_SP_MODE(portnum), &regval);\r\nrio_write_config_32(rdev,\r\nTSI578_SP_MODE(portnum),\r\nregval & ~TSI578_SP_MODE_PW_DIS);\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_ERR_STS_CSR(rdev, portnum),\r\n&regval);\r\nrio_write_config_32(rdev,\r\nRIO_DEV_PORT_N_ERR_STS_CSR(rdev, portnum),\r\nregval & 0x07120214);\r\nrio_read_config_32(rdev,\r\nTSI578_SP_INT_STATUS(portnum), &regval);\r\nrio_write_config_32(rdev,\r\nTSI578_SP_INT_STATUS(portnum),\r\nregval & 0x000700bd);\r\nrio_read_config_32(rdev,\r\nTSI578_SP_CTL_INDEP(portnum), &regval);\r\nrio_write_config_32(rdev,\r\nTSI578_SP_CTL_INDEP(portnum),\r\nregval | 0x000b0000);\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_CTL_CSR(rdev, portnum),\r\n&regval);\r\nif ((regval & RIO_PORT_N_CTL_PWIDTH) == RIO_PORT_N_CTL_PWIDTH_4)\r\nportnum++;\r\n}\r\nrio_write_config_32(rdev,\r\nrdev->phys_efptr + RIO_PORT_LINKTO_CTL_CSR, 0x9a << 8);\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi57x_em_handler(struct rio_dev *rdev, u8 portnum)\r\n{\r\nstruct rio_mport *mport = rdev->net->hport;\r\nu32 intstat, err_status;\r\nint sendcount, checkcount;\r\nu8 route_port;\r\nu32 regval;\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_ERR_STS_CSR(rdev, portnum),\r\n&err_status);\r\nif ((err_status & RIO_PORT_N_ERR_STS_PORT_OK) &&\r\n(err_status & (RIO_PORT_N_ERR_STS_OUT_ES |\r\nRIO_PORT_N_ERR_STS_INP_ES))) {\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_CTL_CSR(rdev, portnum),\r\n&regval);\r\nif (!(regval & RIO_PORT_N_CTL_LOCKOUT)) {\r\nrio_write_config_32(rdev,\r\nRIO_DEV_PORT_N_CTL_CSR(rdev, portnum),\r\nregval | RIO_PORT_N_CTL_LOCKOUT);\r\nudelay(50);\r\nrio_write_config_32(rdev,\r\nRIO_DEV_PORT_N_CTL_CSR(rdev, portnum),\r\nregval);\r\n}\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_MNT_RSP_CSR(rdev, portnum),\r\n&regval);\r\nsendcount = 3;\r\nwhile (sendcount) {\r\nrio_write_config_32(rdev,\r\nTSI578_SP_CS_TX(portnum), 0x40fc8000);\r\ncheckcount = 3;\r\nwhile (checkcount--) {\r\nudelay(50);\r\nrio_read_config_32(rdev,\r\nRIO_DEV_PORT_N_MNT_RSP_CSR(rdev,\r\nportnum),\r\n&regval);\r\nif (regval & RIO_PORT_N_MNT_RSP_RVAL)\r\ngoto exit_es;\r\n}\r\nsendcount--;\r\n}\r\n}\r\nexit_es:\r\nrio_read_config_32(rdev, TSI578_SP_INT_STATUS(portnum), &intstat);\r\npr_debug("TSI578[%x:%x] SP%d_INT_STATUS=0x%08x\n",\r\nrdev->destid, rdev->hopcount, portnum, intstat);\r\nif (intstat & 0x10000) {\r\nrio_read_config_32(rdev,\r\nTSI578_SP_LUT_PEINF(portnum), &regval);\r\nregval = (mport->sys_size) ? (regval >> 16) : (regval >> 24);\r\nroute_port = rdev->rswitch->route_table[regval];\r\npr_debug("RIO: TSI578[%s] P%d LUT Parity Error (destID=%d)\n",\r\nrio_name(rdev), portnum, regval);\r\ntsi57x_route_add_entry(mport, rdev->destid, rdev->hopcount,\r\nRIO_GLOBAL_TABLE, regval, route_port);\r\n}\r\nrio_write_config_32(rdev, TSI578_SP_INT_STATUS(portnum),\r\nintstat & 0x000700bd);\r\nreturn 0;\r\n}\r\nstatic int tsi57x_probe(struct rio_dev *rdev, const struct rio_device_id *id)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nspin_lock(&rdev->rswitch->lock);\r\nif (rdev->rswitch->ops) {\r\nspin_unlock(&rdev->rswitch->lock);\r\nreturn -EINVAL;\r\n}\r\nrdev->rswitch->ops = &tsi57x_switch_ops;\r\nif (rdev->do_enum) {\r\nrio_write_config_32(rdev, RIO_STD_RTE_DEFAULT_PORT,\r\nRIO_INVALID_ROUTE);\r\n}\r\nspin_unlock(&rdev->rswitch->lock);\r\nreturn 0;\r\n}\r\nstatic void tsi57x_remove(struct rio_dev *rdev)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nspin_lock(&rdev->rswitch->lock);\r\nif (rdev->rswitch->ops != &tsi57x_switch_ops) {\r\nspin_unlock(&rdev->rswitch->lock);\r\nreturn;\r\n}\r\nrdev->rswitch->ops = NULL;\r\nspin_unlock(&rdev->rswitch->lock);\r\n}\r\nstatic int __init tsi57x_init(void)\r\n{\r\nreturn rio_register_driver(&tsi57x_driver);\r\n}\r\nstatic void __exit tsi57x_exit(void)\r\n{\r\nrio_unregister_driver(&tsi57x_driver);\r\n}

static int mcp4131_read(struct spi_device *spi, void *buf, size_t len)\r\n{\r\nstruct spi_transfer t = {\r\n.tx_buf = buf,\r\n.rx_buf = buf,\r\n.len = len,\r\n};\r\nstruct spi_message m;\r\nspi_message_init(&m);\r\nspi_message_add_tail(&t, &m);\r\nreturn spi_sync(spi, &m);\r\n}\r\nstatic int mcp4131_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nint err;\r\nstruct mcp4131_data *data = iio_priv(indio_dev);\r\nint address = chan->channel;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&data->lock);\r\ndata->buf[0] = (address << MCP4131_WIPER_SHIFT) | MCP4131_READ;\r\ndata->buf[1] = 0;\r\nerr = mcp4131_read(data->spi, data->buf, 2);\r\nif (err) {\r\nmutex_unlock(&data->lock);\r\nreturn err;\r\n}\r\nif (!MCP4131_CMDERR(data->buf)) {\r\nmutex_unlock(&data->lock);\r\nreturn -EIO;\r\n}\r\n*val = MCP4131_RAW(data->buf);\r\nmutex_unlock(&data->lock);\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 1000 * data->cfg->kohms;\r\n*val2 = data->cfg->max_pos;\r\nreturn IIO_VAL_FRACTIONAL;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int mcp4131_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val, int val2, long mask)\r\n{\r\nint err;\r\nstruct mcp4131_data *data = iio_priv(indio_dev);\r\nint address = chan->channel << MCP4131_WIPER_SHIFT;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (val > data->cfg->max_pos || val < 0)\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&data->lock);\r\ndata->buf[0] = address << MCP4131_WIPER_SHIFT;\r\ndata->buf[0] |= MCP4131_WRITE | (val >> 8);\r\ndata->buf[1] = val & 0xFF;\r\nerr = spi_write(data->spi, data->buf, 2);\r\nmutex_unlock(&data->lock);\r\nreturn err;\r\n}\r\nstatic int mcp4131_probe(struct spi_device *spi)\r\n{\r\nint err;\r\nstruct device *dev = &spi->dev;\r\nunsigned long devid = spi_get_device_id(spi)->driver_data;\r\nstruct mcp4131_data *data;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(*data));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\ndata = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\ndata->spi = spi;\r\ndata->cfg = &mcp4131_cfg[devid];\r\nmutex_init(&data->lock);\r\nindio_dev->dev.parent = dev;\r\nindio_dev->info = &mcp4131_info;\r\nindio_dev->channels = mcp4131_channels;\r\nindio_dev->num_channels = data->cfg->wipers;\r\nindio_dev->name = spi_get_device_id(spi)->name;\r\nerr = devm_iio_device_register(dev, indio_dev);\r\nif (err) {\r\ndev_info(&spi->dev, "Unable to register %s\n", indio_dev->name);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

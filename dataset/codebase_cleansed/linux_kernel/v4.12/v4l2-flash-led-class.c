static enum led_brightness __intensity_to_led_brightness(\r\nstruct v4l2_ctrl *ctrl, s32 intensity)\r\n{\r\nintensity -= ctrl->minimum;\r\nintensity /= (u32) ctrl->step;\r\nif (ctrl->minimum)\r\n++intensity;\r\nreturn intensity;\r\n}\r\nstatic s32 __led_brightness_to_intensity(struct v4l2_ctrl *ctrl,\r\nenum led_brightness brightness)\r\n{\r\nif (ctrl->id != V4L2_CID_FLASH_INDICATOR_INTENSITY)\r\n--brightness;\r\nreturn (brightness * ctrl->step) + ctrl->minimum;\r\n}\r\nstatic void v4l2_flash_set_led_brightness(struct v4l2_flash *v4l2_flash,\r\nstruct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\r\nenum led_brightness brightness;\r\nif (has_flash_op(v4l2_flash, intensity_to_led_brightness))\r\nbrightness = call_flash_op(v4l2_flash,\r\nintensity_to_led_brightness,\r\nctrl->val);\r\nelse\r\nbrightness = __intensity_to_led_brightness(ctrl, ctrl->val);\r\nif (has_flash_op(v4l2_flash, led_brightness_to_intensity))\r\nctrl->val = call_flash_op(v4l2_flash,\r\nled_brightness_to_intensity,\r\nbrightness);\r\nif (ctrl == ctrls[TORCH_INTENSITY]) {\r\nif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\r\nreturn;\r\nled_set_brightness_sync(&v4l2_flash->fled_cdev->led_cdev,\r\nbrightness);\r\n} else {\r\nled_set_brightness_sync(&v4l2_flash->iled_cdev->led_cdev,\r\nbrightness);\r\n}\r\n}\r\nstatic int v4l2_flash_update_led_brightness(struct v4l2_flash *v4l2_flash,\r\nstruct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\r\nstruct led_classdev *led_cdev;\r\nint ret;\r\nif (ctrl == ctrls[TORCH_INTENSITY]) {\r\nif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\r\nreturn 0;\r\nled_cdev = &v4l2_flash->fled_cdev->led_cdev;\r\n} else {\r\nled_cdev = &v4l2_flash->iled_cdev->led_cdev;\r\n}\r\nret = led_update_brightness(led_cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nif (has_flash_op(v4l2_flash, led_brightness_to_intensity))\r\nctrl->val = call_flash_op(v4l2_flash,\r\nled_brightness_to_intensity,\r\nled_cdev->brightness);\r\nelse\r\nctrl->val = __led_brightness_to_intensity(ctrl,\r\nled_cdev->brightness);\r\nreturn 0;\r\n}\r\nstatic int v4l2_flash_g_volatile_ctrl(struct v4l2_ctrl *c)\r\n{\r\nstruct v4l2_flash *v4l2_flash = v4l2_ctrl_to_v4l2_flash(c);\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nbool is_strobing;\r\nint ret;\r\nswitch (c->id) {\r\ncase V4L2_CID_FLASH_TORCH_INTENSITY:\r\ncase V4L2_CID_FLASH_INDICATOR_INTENSITY:\r\nreturn v4l2_flash_update_led_brightness(v4l2_flash, c);\r\ncase V4L2_CID_FLASH_INTENSITY:\r\nret = led_update_flash_brightness(fled_cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nc->val = fled_cdev->brightness.val;\r\nreturn 0;\r\ncase V4L2_CID_FLASH_STROBE_STATUS:\r\nret = led_get_flash_strobe(fled_cdev, &is_strobing);\r\nif (ret < 0)\r\nreturn ret;\r\nc->val = is_strobing;\r\nreturn 0;\r\ncase V4L2_CID_FLASH_FAULT:\r\nreturn led_get_flash_fault(fled_cdev, &c->val);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic bool __software_strobe_mode_inactive(struct v4l2_ctrl **ctrls)\r\n{\r\nreturn ((ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_FLASH) ||\r\n(ctrls[STROBE_SOURCE] && (ctrls[STROBE_SOURCE]->val !=\r\nV4L2_FLASH_STROBE_SOURCE_SOFTWARE)));\r\n}\r\nstatic int v4l2_flash_s_ctrl(struct v4l2_ctrl *c)\r\n{\r\nstruct v4l2_flash *v4l2_flash = v4l2_ctrl_to_v4l2_flash(c);\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\r\nbool external_strobe;\r\nint ret = 0;\r\nswitch (c->id) {\r\ncase V4L2_CID_FLASH_LED_MODE:\r\nswitch (c->val) {\r\ncase V4L2_FLASH_LED_MODE_NONE:\r\nled_set_brightness_sync(led_cdev, LED_OFF);\r\nreturn led_set_flash_strobe(fled_cdev, false);\r\ncase V4L2_FLASH_LED_MODE_FLASH:\r\nled_set_brightness_sync(led_cdev, LED_OFF);\r\nif (ctrls[STROBE_SOURCE]) {\r\nexternal_strobe = (ctrls[STROBE_SOURCE]->val ==\r\nV4L2_FLASH_STROBE_SOURCE_EXTERNAL);\r\nret = call_flash_op(v4l2_flash,\r\nexternal_strobe_set,\r\nexternal_strobe);\r\n}\r\nreturn ret;\r\ncase V4L2_FLASH_LED_MODE_TORCH:\r\nif (ctrls[STROBE_SOURCE]) {\r\nret = call_flash_op(v4l2_flash,\r\nexternal_strobe_set,\r\nfalse);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = led_set_flash_strobe(fled_cdev, false);\r\nif (ret < 0)\r\nreturn ret;\r\nv4l2_flash_set_led_brightness(v4l2_flash,\r\nctrls[TORCH_INTENSITY]);\r\nreturn 0;\r\n}\r\nbreak;\r\ncase V4L2_CID_FLASH_STROBE_SOURCE:\r\nexternal_strobe = (c->val == V4L2_FLASH_STROBE_SOURCE_EXTERNAL);\r\nif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_FLASH)\r\nreturn 0;\r\nreturn call_flash_op(v4l2_flash, external_strobe_set,\r\nexternal_strobe);\r\ncase V4L2_CID_FLASH_STROBE:\r\nif (__software_strobe_mode_inactive(ctrls))\r\nreturn -EBUSY;\r\nreturn led_set_flash_strobe(fled_cdev, true);\r\ncase V4L2_CID_FLASH_STROBE_STOP:\r\nif (__software_strobe_mode_inactive(ctrls))\r\nreturn -EBUSY;\r\nreturn led_set_flash_strobe(fled_cdev, false);\r\ncase V4L2_CID_FLASH_TIMEOUT:\r\nreturn led_set_flash_timeout(fled_cdev, c->val);\r\ncase V4L2_CID_FLASH_INTENSITY:\r\nreturn led_set_flash_brightness(fled_cdev, c->val);\r\ncase V4L2_CID_FLASH_TORCH_INTENSITY:\r\ncase V4L2_CID_FLASH_INDICATOR_INTENSITY:\r\nv4l2_flash_set_led_brightness(v4l2_flash, c);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void __lfs_to_v4l2_ctrl_config(struct led_flash_setting *s,\r\nstruct v4l2_ctrl_config *c)\r\n{\r\nc->min = s->min;\r\nc->max = s->max;\r\nc->step = s->step;\r\nc->def = s->val;\r\n}\r\nstatic void __fill_ctrl_init_data(struct v4l2_flash *v4l2_flash,\r\nstruct v4l2_flash_config *flash_cfg,\r\nstruct v4l2_flash_ctrl_data *ctrl_init_data)\r\n{\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nconst struct led_flash_ops *fled_cdev_ops = fled_cdev->ops;\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct v4l2_ctrl_config *ctrl_cfg;\r\nu32 mask;\r\nif (flash_cfg->flash_faults) {\r\nctrl_init_data[FLASH_FAULT].cid = V4L2_CID_FLASH_FAULT;\r\nctrl_cfg = &ctrl_init_data[FLASH_FAULT].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_FAULT;\r\nctrl_cfg->max = flash_cfg->flash_faults;\r\nctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_READ_ONLY;\r\n}\r\nmask = 1 << V4L2_FLASH_LED_MODE_NONE |\r\n1 << V4L2_FLASH_LED_MODE_TORCH;\r\nif (led_cdev->flags & LED_DEV_CAP_FLASH)\r\nmask |= 1 << V4L2_FLASH_LED_MODE_FLASH;\r\nctrl_init_data[LED_MODE].cid = V4L2_CID_FLASH_LED_MODE;\r\nctrl_cfg = &ctrl_init_data[LED_MODE].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_LED_MODE;\r\nctrl_cfg->max = V4L2_FLASH_LED_MODE_TORCH;\r\nctrl_cfg->menu_skip_mask = ~mask;\r\nctrl_cfg->def = V4L2_FLASH_LED_MODE_NONE;\r\nctrl_cfg->flags = 0;\r\nctrl_init_data[TORCH_INTENSITY].cid = V4L2_CID_FLASH_TORCH_INTENSITY;\r\nctrl_cfg = &ctrl_init_data[TORCH_INTENSITY].config;\r\n__lfs_to_v4l2_ctrl_config(&flash_cfg->torch_intensity, ctrl_cfg);\r\nctrl_cfg->id = V4L2_CID_FLASH_TORCH_INTENSITY;\r\nctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\r\nif (v4l2_flash->iled_cdev) {\r\nctrl_init_data[INDICATOR_INTENSITY].cid =\r\nV4L2_CID_FLASH_INDICATOR_INTENSITY;\r\nctrl_cfg = &ctrl_init_data[INDICATOR_INTENSITY].config;\r\n__lfs_to_v4l2_ctrl_config(&flash_cfg->indicator_intensity,\r\nctrl_cfg);\r\nctrl_cfg->id = V4L2_CID_FLASH_INDICATOR_INTENSITY;\r\nctrl_cfg->min = 0;\r\nctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\r\n}\r\nif (!(led_cdev->flags & LED_DEV_CAP_FLASH))\r\nreturn;\r\nctrl_init_data[FLASH_STROBE].cid = V4L2_CID_FLASH_STROBE;\r\nctrl_cfg = &ctrl_init_data[FLASH_STROBE].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_STROBE;\r\nctrl_init_data[STROBE_STOP].cid = V4L2_CID_FLASH_STROBE_STOP;\r\nctrl_cfg = &ctrl_init_data[STROBE_STOP].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_STROBE_STOP;\r\nif (flash_cfg->has_external_strobe) {\r\nmask = (1 << V4L2_FLASH_STROBE_SOURCE_SOFTWARE) |\r\n(1 << V4L2_FLASH_STROBE_SOURCE_EXTERNAL);\r\nctrl_init_data[STROBE_SOURCE].cid =\r\nV4L2_CID_FLASH_STROBE_SOURCE;\r\nctrl_cfg = &ctrl_init_data[STROBE_SOURCE].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_STROBE_SOURCE;\r\nctrl_cfg->max = V4L2_FLASH_STROBE_SOURCE_EXTERNAL;\r\nctrl_cfg->menu_skip_mask = ~mask;\r\nctrl_cfg->def = V4L2_FLASH_STROBE_SOURCE_SOFTWARE;\r\n}\r\nif (fled_cdev_ops->strobe_get) {\r\nctrl_init_data[STROBE_STATUS].cid =\r\nV4L2_CID_FLASH_STROBE_STATUS;\r\nctrl_cfg = &ctrl_init_data[STROBE_STATUS].config;\r\nctrl_cfg->id = V4L2_CID_FLASH_STROBE_STATUS;\r\nctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_READ_ONLY;\r\n}\r\nif (fled_cdev_ops->timeout_set) {\r\nctrl_init_data[FLASH_TIMEOUT].cid = V4L2_CID_FLASH_TIMEOUT;\r\nctrl_cfg = &ctrl_init_data[FLASH_TIMEOUT].config;\r\n__lfs_to_v4l2_ctrl_config(&fled_cdev->timeout, ctrl_cfg);\r\nctrl_cfg->id = V4L2_CID_FLASH_TIMEOUT;\r\n}\r\nif (fled_cdev_ops->flash_brightness_set) {\r\nctrl_init_data[FLASH_INTENSITY].cid = V4L2_CID_FLASH_INTENSITY;\r\nctrl_cfg = &ctrl_init_data[FLASH_INTENSITY].config;\r\n__lfs_to_v4l2_ctrl_config(&fled_cdev->brightness, ctrl_cfg);\r\nctrl_cfg->id = V4L2_CID_FLASH_INTENSITY;\r\nctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\r\n}\r\n}\r\nstatic int v4l2_flash_init_controls(struct v4l2_flash *v4l2_flash,\r\nstruct v4l2_flash_config *flash_cfg)\r\n{\r\nstruct v4l2_flash_ctrl_data *ctrl_init_data;\r\nstruct v4l2_ctrl *ctrl;\r\nstruct v4l2_ctrl_config *ctrl_cfg;\r\nint i, ret, num_ctrls = 0;\r\nv4l2_flash->ctrls = devm_kzalloc(v4l2_flash->sd.dev,\r\nsizeof(*v4l2_flash->ctrls) *\r\n(STROBE_SOURCE + 1), GFP_KERNEL);\r\nif (!v4l2_flash->ctrls)\r\nreturn -ENOMEM;\r\nctrl_init_data = kcalloc(NUM_FLASH_CTRLS, sizeof(*ctrl_init_data),\r\nGFP_KERNEL);\r\nif (!ctrl_init_data)\r\nreturn -ENOMEM;\r\n__fill_ctrl_init_data(v4l2_flash, flash_cfg, ctrl_init_data);\r\nfor (i = 0; i < NUM_FLASH_CTRLS; ++i)\r\nif (ctrl_init_data[i].cid)\r\n++num_ctrls;\r\nv4l2_ctrl_handler_init(&v4l2_flash->hdl, num_ctrls);\r\nfor (i = 0; i < NUM_FLASH_CTRLS; ++i) {\r\nctrl_cfg = &ctrl_init_data[i].config;\r\nif (!ctrl_init_data[i].cid)\r\ncontinue;\r\nif (ctrl_cfg->id == V4L2_CID_FLASH_LED_MODE ||\r\nctrl_cfg->id == V4L2_CID_FLASH_STROBE_SOURCE)\r\nctrl = v4l2_ctrl_new_std_menu(&v4l2_flash->hdl,\r\n&v4l2_flash_ctrl_ops,\r\nctrl_cfg->id,\r\nctrl_cfg->max,\r\nctrl_cfg->menu_skip_mask,\r\nctrl_cfg->def);\r\nelse\r\nctrl = v4l2_ctrl_new_std(&v4l2_flash->hdl,\r\n&v4l2_flash_ctrl_ops,\r\nctrl_cfg->id,\r\nctrl_cfg->min,\r\nctrl_cfg->max,\r\nctrl_cfg->step,\r\nctrl_cfg->def);\r\nif (ctrl)\r\nctrl->flags |= ctrl_cfg->flags;\r\nif (i <= STROBE_SOURCE)\r\nv4l2_flash->ctrls[i] = ctrl;\r\n}\r\nkfree(ctrl_init_data);\r\nif (v4l2_flash->hdl.error) {\r\nret = v4l2_flash->hdl.error;\r\ngoto error_free_handler;\r\n}\r\nv4l2_ctrl_handler_setup(&v4l2_flash->hdl);\r\nv4l2_flash->sd.ctrl_handler = &v4l2_flash->hdl;\r\nreturn 0;\r\nerror_free_handler:\r\nv4l2_ctrl_handler_free(&v4l2_flash->hdl);\r\nreturn ret;\r\n}\r\nstatic int __sync_device_with_v4l2_controls(struct v4l2_flash *v4l2_flash)\r\n{\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\r\nint ret = 0;\r\nv4l2_flash_set_led_brightness(v4l2_flash, ctrls[TORCH_INTENSITY]);\r\nif (ctrls[INDICATOR_INTENSITY])\r\nv4l2_flash_set_led_brightness(v4l2_flash,\r\nctrls[INDICATOR_INTENSITY]);\r\nif (ctrls[FLASH_TIMEOUT]) {\r\nret = led_set_flash_timeout(fled_cdev,\r\nctrls[FLASH_TIMEOUT]->val);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (ctrls[FLASH_INTENSITY]) {\r\nret = led_set_flash_brightness(fled_cdev,\r\nctrls[FLASH_INTENSITY]->val);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (ctrls[STROBE_SOURCE] &&\r\nctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\r\nret = call_flash_op(v4l2_flash, external_strobe_set,\r\nctrls[STROBE_SOURCE]->val);\r\nreturn ret;\r\n}\r\nstatic int v4l2_flash_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)\r\n{\r\nstruct v4l2_flash *v4l2_flash = v4l2_subdev_to_v4l2_flash(sd);\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct led_classdev_flash *iled_cdev = v4l2_flash->iled_cdev;\r\nstruct led_classdev *led_cdev_ind = NULL;\r\nint ret = 0;\r\nif (!v4l2_fh_is_singular(&fh->vfh))\r\nreturn 0;\r\nmutex_lock(&led_cdev->led_access);\r\nled_sysfs_disable(led_cdev);\r\nled_trigger_remove(led_cdev);\r\nmutex_unlock(&led_cdev->led_access);\r\nif (iled_cdev) {\r\nled_cdev_ind = &iled_cdev->led_cdev;\r\nmutex_lock(&led_cdev_ind->led_access);\r\nled_sysfs_disable(led_cdev_ind);\r\nled_trigger_remove(led_cdev_ind);\r\nmutex_unlock(&led_cdev_ind->led_access);\r\n}\r\nret = __sync_device_with_v4l2_controls(v4l2_flash);\r\nif (ret < 0)\r\ngoto out_sync_device;\r\nreturn 0;\r\nout_sync_device:\r\nmutex_lock(&led_cdev->led_access);\r\nled_sysfs_enable(led_cdev);\r\nmutex_unlock(&led_cdev->led_access);\r\nif (led_cdev_ind) {\r\nmutex_lock(&led_cdev_ind->led_access);\r\nled_sysfs_enable(led_cdev_ind);\r\nmutex_unlock(&led_cdev_ind->led_access);\r\n}\r\nreturn ret;\r\n}\r\nstatic int v4l2_flash_close(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)\r\n{\r\nstruct v4l2_flash *v4l2_flash = v4l2_subdev_to_v4l2_flash(sd);\r\nstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct led_classdev_flash *iled_cdev = v4l2_flash->iled_cdev;\r\nint ret = 0;\r\nif (!v4l2_fh_is_singular(&fh->vfh))\r\nreturn 0;\r\nmutex_lock(&led_cdev->led_access);\r\nif (v4l2_flash->ctrls[STROBE_SOURCE])\r\nret = v4l2_ctrl_s_ctrl(v4l2_flash->ctrls[STROBE_SOURCE],\r\nV4L2_FLASH_STROBE_SOURCE_SOFTWARE);\r\nled_sysfs_enable(led_cdev);\r\nmutex_unlock(&led_cdev->led_access);\r\nif (iled_cdev) {\r\nstruct led_classdev *led_cdev_ind = &iled_cdev->led_cdev;\r\nmutex_lock(&led_cdev_ind->led_access);\r\nled_sysfs_enable(led_cdev_ind);\r\nmutex_unlock(&led_cdev_ind->led_access);\r\n}\r\nreturn ret;\r\n}\r\nstruct v4l2_flash *v4l2_flash_init(\r\nstruct device *dev, struct device_node *of_node,\r\nstruct led_classdev_flash *fled_cdev,\r\nstruct led_classdev_flash *iled_cdev,\r\nconst struct v4l2_flash_ops *ops,\r\nstruct v4l2_flash_config *config)\r\n{\r\nstruct v4l2_flash *v4l2_flash;\r\nstruct led_classdev *led_cdev;\r\nstruct v4l2_subdev *sd;\r\nint ret;\r\nif (!fled_cdev || !ops || !config)\r\nreturn ERR_PTR(-EINVAL);\r\nled_cdev = &fled_cdev->led_cdev;\r\nv4l2_flash = devm_kzalloc(led_cdev->dev, sizeof(*v4l2_flash),\r\nGFP_KERNEL);\r\nif (!v4l2_flash)\r\nreturn ERR_PTR(-ENOMEM);\r\nsd = &v4l2_flash->sd;\r\nv4l2_flash->fled_cdev = fled_cdev;\r\nv4l2_flash->iled_cdev = iled_cdev;\r\nv4l2_flash->ops = ops;\r\nsd->dev = dev;\r\nsd->of_node = of_node ? of_node : led_cdev->dev->of_node;\r\nv4l2_subdev_init(sd, &v4l2_flash_subdev_ops);\r\nsd->internal_ops = &v4l2_flash_subdev_internal_ops;\r\nsd->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nstrlcpy(sd->name, config->dev_name, sizeof(sd->name));\r\nret = media_entity_pads_init(&sd->entity, 0, NULL);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsd->entity.function = MEDIA_ENT_F_FLASH;\r\nret = v4l2_flash_init_controls(v4l2_flash, config);\r\nif (ret < 0)\r\ngoto err_init_controls;\r\nof_node_get(sd->of_node);\r\nret = v4l2_async_register_subdev(sd);\r\nif (ret < 0)\r\ngoto err_async_register_sd;\r\nreturn v4l2_flash;\r\nerr_async_register_sd:\r\nof_node_put(sd->of_node);\r\nv4l2_ctrl_handler_free(sd->ctrl_handler);\r\nerr_init_controls:\r\nmedia_entity_cleanup(&sd->entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid v4l2_flash_release(struct v4l2_flash *v4l2_flash)\r\n{\r\nstruct v4l2_subdev *sd;\r\nif (IS_ERR_OR_NULL(v4l2_flash))\r\nreturn;\r\nsd = &v4l2_flash->sd;\r\nv4l2_async_unregister_subdev(sd);\r\nof_node_put(sd->of_node);\r\nv4l2_ctrl_handler_free(sd->ctrl_handler);\r\nmedia_entity_cleanup(&sd->entity);\r\n}

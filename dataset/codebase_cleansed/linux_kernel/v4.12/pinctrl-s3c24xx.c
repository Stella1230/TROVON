static int s3c24xx_eint_get_trigger(unsigned int type)\r\n{\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\nreturn EINT_EDGE_RISING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nreturn EINT_EDGE_FALLING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\nreturn EINT_EDGE_BOTH;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nreturn EINT_LEVEL_HIGH;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nreturn EINT_LEVEL_LOW;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic void s3c24xx_eint_set_handler(struct irq_data *d, unsigned int type)\r\n{\r\nif (type & IRQ_TYPE_EDGE_BOTH)\r\nirq_set_handler_locked(d, handle_edge_irq);\r\nelse\r\nirq_set_handler_locked(d, handle_level_irq);\r\n}\r\nstatic void s3c24xx_eint_set_function(struct samsung_pinctrl_drv_data *d,\r\nstruct samsung_pin_bank *bank, int pin)\r\n{\r\nconst struct samsung_pin_bank_type *bank_type = bank->type;\r\nunsigned long flags;\r\nvoid __iomem *reg;\r\nu8 shift;\r\nu32 mask;\r\nu32 val;\r\nreg = bank->pctl_base + bank->pctl_offset;\r\nshift = pin * bank_type->fld_width[PINCFG_TYPE_FUNC];\r\nmask = (1 << bank_type->fld_width[PINCFG_TYPE_FUNC]) - 1;\r\nspin_lock_irqsave(&bank->slock, flags);\r\nval = readl(reg);\r\nval &= ~(mask << shift);\r\nval |= bank->eint_func << shift;\r\nwritel(val, reg);\r\nspin_unlock_irqrestore(&bank->slock, flags);\r\n}\r\nstatic int s3c24xx_eint_type(struct irq_data *data, unsigned int type)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nstruct samsung_pinctrl_drv_data *d = bank->drvdata;\r\nint index = bank->eint_offset + data->hwirq;\r\nvoid __iomem *reg;\r\nint trigger;\r\nu8 shift;\r\nu32 val;\r\ntrigger = s3c24xx_eint_get_trigger(type);\r\nif (trigger < 0) {\r\ndev_err(d->dev, "unsupported external interrupt type\n");\r\nreturn -EINVAL;\r\n}\r\ns3c24xx_eint_set_handler(data, type);\r\nreg = bank->eint_base + EINT_REG(index);\r\nshift = EINT_OFFS(index);\r\nval = readl(reg);\r\nval &= ~(EINT_MASK << shift);\r\nval |= trigger << shift;\r\nwritel(val, reg);\r\ns3c24xx_eint_set_function(d, bank, data->hwirq);\r\nreturn 0;\r\n}\r\nstatic void s3c2410_eint0_3_ack(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nstruct s3c24xx_eint_domain_data *ddata = bank->irq_domain->host_data;\r\nstruct s3c24xx_eint_data *eint_data = ddata->eint_data;\r\nint parent_irq = eint_data->parents[data->hwirq];\r\nstruct irq_chip *parent_chip = irq_get_chip(parent_irq);\r\nparent_chip->irq_ack(irq_get_irq_data(parent_irq));\r\n}\r\nstatic void s3c2410_eint0_3_mask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nstruct s3c24xx_eint_domain_data *ddata = bank->irq_domain->host_data;\r\nstruct s3c24xx_eint_data *eint_data = ddata->eint_data;\r\nint parent_irq = eint_data->parents[data->hwirq];\r\nstruct irq_chip *parent_chip = irq_get_chip(parent_irq);\r\nparent_chip->irq_mask(irq_get_irq_data(parent_irq));\r\n}\r\nstatic void s3c2410_eint0_3_unmask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nstruct s3c24xx_eint_domain_data *ddata = bank->irq_domain->host_data;\r\nstruct s3c24xx_eint_data *eint_data = ddata->eint_data;\r\nint parent_irq = eint_data->parents[data->hwirq];\r\nstruct irq_chip *parent_chip = irq_get_chip(parent_irq);\r\nparent_chip->irq_unmask(irq_get_irq_data(parent_irq));\r\n}\r\nstatic void s3c2410_demux_eint0_3(struct irq_desc *desc)\r\n{\r\nstruct irq_data *data = irq_desc_get_irq_data(desc);\r\nstruct s3c24xx_eint_data *eint_data = irq_desc_get_handler_data(desc);\r\nunsigned int virq;\r\nvirq = irq_linear_revmap(eint_data->domains[data->hwirq], data->hwirq);\r\nBUG_ON(!virq);\r\ngeneric_handle_irq(virq);\r\n}\r\nstatic void s3c2412_eint0_3_ack(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned long bitval = 1UL << data->hwirq;\r\nwritel(bitval, bank->eint_base + EINTPEND_REG);\r\n}\r\nstatic void s3c2412_eint0_3_mask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned long mask;\r\nmask = readl(bank->eint_base + EINTMASK_REG);\r\nmask |= (1UL << data->hwirq);\r\nwritel(mask, bank->eint_base + EINTMASK_REG);\r\n}\r\nstatic void s3c2412_eint0_3_unmask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned long mask;\r\nmask = readl(bank->eint_base + EINTMASK_REG);\r\nmask &= ~(1UL << data->hwirq);\r\nwritel(mask, bank->eint_base + EINTMASK_REG);\r\n}\r\nstatic void s3c2412_demux_eint0_3(struct irq_desc *desc)\r\n{\r\nstruct s3c24xx_eint_data *eint_data = irq_desc_get_handler_data(desc);\r\nstruct irq_data *data = irq_desc_get_irq_data(desc);\r\nstruct irq_chip *chip = irq_data_get_irq_chip(data);\r\nunsigned int virq;\r\nchained_irq_enter(chip, desc);\r\nvirq = irq_linear_revmap(eint_data->domains[data->hwirq], data->hwirq);\r\nBUG_ON(!virq);\r\ngeneric_handle_irq(virq);\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic void s3c24xx_eint_ack(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned char index = bank->eint_offset + data->hwirq;\r\nwritel(1UL << index, bank->eint_base + EINTPEND_REG);\r\n}\r\nstatic void s3c24xx_eint_mask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned char index = bank->eint_offset + data->hwirq;\r\nunsigned long mask;\r\nmask = readl(bank->eint_base + EINTMASK_REG);\r\nmask |= (1UL << index);\r\nwritel(mask, bank->eint_base + EINTMASK_REG);\r\n}\r\nstatic void s3c24xx_eint_unmask(struct irq_data *data)\r\n{\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(data);\r\nunsigned char index = bank->eint_offset + data->hwirq;\r\nunsigned long mask;\r\nmask = readl(bank->eint_base + EINTMASK_REG);\r\nmask &= ~(1UL << index);\r\nwritel(mask, bank->eint_base + EINTMASK_REG);\r\n}\r\nstatic inline void s3c24xx_demux_eint(struct irq_desc *desc,\r\nu32 offset, u32 range)\r\n{\r\nstruct s3c24xx_eint_data *data = irq_desc_get_handler_data(desc);\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nstruct irq_data *irqd = irq_desc_get_irq_data(desc);\r\nstruct samsung_pin_bank *bank = irq_data_get_irq_chip_data(irqd);\r\nunsigned int pend, mask;\r\nchained_irq_enter(chip, desc);\r\npend = readl(bank->eint_base + EINTPEND_REG);\r\nmask = readl(bank->eint_base + EINTMASK_REG);\r\npend &= ~mask;\r\npend &= range;\r\nwhile (pend) {\r\nunsigned int virq, irq;\r\nirq = __ffs(pend);\r\npend &= ~(1 << irq);\r\nvirq = irq_linear_revmap(data->domains[irq], irq - offset);\r\nBUG_ON(!virq);\r\ngeneric_handle_irq(virq);\r\n}\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic void s3c24xx_demux_eint4_7(struct irq_desc *desc)\r\n{\r\ns3c24xx_demux_eint(desc, 0, 0xf0);\r\n}\r\nstatic void s3c24xx_demux_eint8_23(struct irq_desc *desc)\r\n{\r\ns3c24xx_demux_eint(desc, 8, 0xffff00);\r\n}\r\nstatic int s3c24xx_gpf_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct s3c24xx_eint_domain_data *ddata = h->host_data;\r\nstruct samsung_pin_bank *bank = ddata->bank;\r\nif (!(bank->eint_mask & (1 << (bank->eint_offset + hw))))\r\nreturn -EINVAL;\r\nif (hw <= 3) {\r\nif (ddata->eint0_3_parent_only)\r\nirq_set_chip_and_handler(virq, &s3c2410_eint0_3_chip,\r\nhandle_edge_irq);\r\nelse\r\nirq_set_chip_and_handler(virq, &s3c2412_eint0_3_chip,\r\nhandle_edge_irq);\r\n} else {\r\nirq_set_chip_and_handler(virq, &s3c24xx_eint_chip,\r\nhandle_edge_irq);\r\n}\r\nirq_set_chip_data(virq, bank);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_gpg_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct s3c24xx_eint_domain_data *ddata = h->host_data;\r\nstruct samsung_pin_bank *bank = ddata->bank;\r\nif (!(bank->eint_mask & (1 << (bank->eint_offset + hw))))\r\nreturn -EINVAL;\r\nirq_set_chip_and_handler(virq, &s3c24xx_eint_chip, handle_edge_irq);\r\nirq_set_chip_data(virq, bank);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_eint_init(struct samsung_pinctrl_drv_data *d)\r\n{\r\nstruct device *dev = d->dev;\r\nconst struct of_device_id *match;\r\nstruct device_node *eint_np = NULL;\r\nstruct device_node *np;\r\nstruct samsung_pin_bank *bank;\r\nstruct s3c24xx_eint_data *eint_data;\r\nconst struct irq_domain_ops *ops;\r\nunsigned int i;\r\nbool eint0_3_parent_only;\r\nirq_flow_handler_t *handlers;\r\nfor_each_child_of_node(dev->of_node, np) {\r\nmatch = of_match_node(s3c24xx_eint_irq_ids, np);\r\nif (match) {\r\neint_np = np;\r\neint0_3_parent_only = (bool)match->data;\r\nbreak;\r\n}\r\n}\r\nif (!eint_np)\r\nreturn -ENODEV;\r\neint_data = devm_kzalloc(dev, sizeof(*eint_data), GFP_KERNEL);\r\nif (!eint_data)\r\nreturn -ENOMEM;\r\neint_data->drvdata = d;\r\nhandlers = eint0_3_parent_only ? s3c2410_eint_handlers\r\n: s3c2412_eint_handlers;\r\nfor (i = 0; i < NUM_EINT_IRQ; ++i) {\r\nunsigned int irq;\r\nirq = irq_of_parse_and_map(eint_np, i);\r\nif (!irq) {\r\ndev_err(dev, "failed to get wakeup EINT IRQ %d\n", i);\r\nreturn -ENXIO;\r\n}\r\neint_data->parents[i] = irq;\r\nirq_set_chained_handler_and_data(irq, handlers[i], eint_data);\r\n}\r\nbank = d->pin_banks;\r\nfor (i = 0; i < d->nr_banks; ++i, ++bank) {\r\nstruct s3c24xx_eint_domain_data *ddata;\r\nunsigned int mask;\r\nunsigned int irq;\r\nunsigned int pin;\r\nif (bank->eint_type != EINT_TYPE_WKUP)\r\ncontinue;\r\nddata = devm_kzalloc(dev, sizeof(*ddata), GFP_KERNEL);\r\nif (!ddata)\r\nreturn -ENOMEM;\r\nddata->bank = bank;\r\nddata->eint_data = eint_data;\r\nddata->eint0_3_parent_only = eint0_3_parent_only;\r\nops = (bank->eint_offset == 0) ? &s3c24xx_gpf_irq_ops\r\n: &s3c24xx_gpg_irq_ops;\r\nbank->irq_domain = irq_domain_add_linear(bank->of_node,\r\nbank->nr_pins, ops, ddata);\r\nif (!bank->irq_domain) {\r\ndev_err(dev, "wkup irq domain add failed\n");\r\nreturn -ENXIO;\r\n}\r\nirq = bank->eint_offset;\r\nmask = bank->eint_mask;\r\nfor (pin = 0; mask; ++pin, mask >>= 1) {\r\nif (irq >= NUM_EINT)\r\nbreak;\r\nif (!(mask & 1))\r\ncontinue;\r\neint_data->domains[irq] = bank->irq_domain;\r\n++irq;\r\n}\r\n}\r\nreturn 0;\r\n}

bool seg6_validate_srh(struct ipv6_sr_hdr *srh, int len)\r\n{\r\nint trailing;\r\nunsigned int tlv_offset;\r\nif (srh->type != IPV6_SRCRT_TYPE_4)\r\nreturn false;\r\nif (((srh->hdrlen + 1) << 3) != len)\r\nreturn false;\r\nif (srh->segments_left != srh->first_segment)\r\nreturn false;\r\ntlv_offset = sizeof(*srh) + ((srh->first_segment + 1) << 4);\r\ntrailing = len - tlv_offset;\r\nif (trailing < 0)\r\nreturn false;\r\nwhile (trailing) {\r\nstruct sr6_tlv *tlv;\r\nunsigned int tlv_len;\r\nif (trailing < sizeof(*tlv))\r\nreturn false;\r\ntlv = (struct sr6_tlv *)((unsigned char *)srh + tlv_offset);\r\ntlv_len = sizeof(*tlv) + tlv->len;\r\ntrailing -= tlv_len;\r\nif (trailing < 0)\r\nreturn false;\r\ntlv_offset += tlv_len;\r\n}\r\nreturn true;\r\n}\r\nstatic int seg6_genl_sethmac(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net *net = genl_info_net(info);\r\nstruct seg6_pernet_data *sdata;\r\nstruct seg6_hmac_info *hinfo;\r\nu32 hmackeyid;\r\nchar *secret;\r\nint err = 0;\r\nu8 algid;\r\nu8 slen;\r\nsdata = seg6_pernet(net);\r\nif (!info->attrs[SEG6_ATTR_HMACKEYID] ||\r\n!info->attrs[SEG6_ATTR_SECRETLEN] ||\r\n!info->attrs[SEG6_ATTR_ALGID])\r\nreturn -EINVAL;\r\nhmackeyid = nla_get_u32(info->attrs[SEG6_ATTR_HMACKEYID]);\r\nslen = nla_get_u8(info->attrs[SEG6_ATTR_SECRETLEN]);\r\nalgid = nla_get_u8(info->attrs[SEG6_ATTR_ALGID]);\r\nif (hmackeyid == 0)\r\nreturn -EINVAL;\r\nif (slen > SEG6_HMAC_SECRET_LEN)\r\nreturn -EINVAL;\r\nmutex_lock(&sdata->lock);\r\nhinfo = seg6_hmac_info_lookup(net, hmackeyid);\r\nif (!slen) {\r\nif (!hinfo)\r\nerr = -ENOENT;\r\nerr = seg6_hmac_info_del(net, hmackeyid);\r\ngoto out_unlock;\r\n}\r\nif (!info->attrs[SEG6_ATTR_SECRET]) {\r\nerr = -EINVAL;\r\ngoto out_unlock;\r\n}\r\nif (hinfo) {\r\nerr = seg6_hmac_info_del(net, hmackeyid);\r\nif (err)\r\ngoto out_unlock;\r\n}\r\nsecret = (char *)nla_data(info->attrs[SEG6_ATTR_SECRET]);\r\nhinfo = kzalloc(sizeof(*hinfo), GFP_KERNEL);\r\nif (!hinfo) {\r\nerr = -ENOMEM;\r\ngoto out_unlock;\r\n}\r\nmemcpy(hinfo->secret, secret, slen);\r\nhinfo->slen = slen;\r\nhinfo->alg_id = algid;\r\nhinfo->hmackeyid = hmackeyid;\r\nerr = seg6_hmac_info_add(net, hmackeyid, hinfo);\r\nif (err)\r\nkfree(hinfo);\r\nout_unlock:\r\nmutex_unlock(&sdata->lock);\r\nreturn err;\r\n}\r\nstatic int seg6_genl_sethmac(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int seg6_genl_set_tunsrc(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net *net = genl_info_net(info);\r\nstruct in6_addr *val, *t_old, *t_new;\r\nstruct seg6_pernet_data *sdata;\r\nsdata = seg6_pernet(net);\r\nif (!info->attrs[SEG6_ATTR_DST])\r\nreturn -EINVAL;\r\nval = nla_data(info->attrs[SEG6_ATTR_DST]);\r\nt_new = kmemdup(val, sizeof(*val), GFP_KERNEL);\r\nif (!t_new)\r\nreturn -ENOMEM;\r\nmutex_lock(&sdata->lock);\r\nt_old = sdata->tun_src;\r\nrcu_assign_pointer(sdata->tun_src, t_new);\r\nmutex_unlock(&sdata->lock);\r\nsynchronize_net();\r\nkfree(t_old);\r\nreturn 0;\r\n}\r\nstatic int seg6_genl_get_tunsrc(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net *net = genl_info_net(info);\r\nstruct in6_addr *tun_src;\r\nstruct sk_buff *msg;\r\nvoid *hdr;\r\nmsg = genlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!msg)\r\nreturn -ENOMEM;\r\nhdr = genlmsg_put(msg, info->snd_portid, info->snd_seq,\r\n&seg6_genl_family, 0, SEG6_CMD_GET_TUNSRC);\r\nif (!hdr)\r\ngoto free_msg;\r\nrcu_read_lock();\r\ntun_src = rcu_dereference(seg6_pernet(net)->tun_src);\r\nif (nla_put(msg, SEG6_ATTR_DST, sizeof(struct in6_addr), tun_src))\r\ngoto nla_put_failure;\r\nrcu_read_unlock();\r\ngenlmsg_end(msg, hdr);\r\ngenlmsg_reply(msg, info);\r\nreturn 0;\r\nnla_put_failure:\r\nrcu_read_unlock();\r\ngenlmsg_cancel(msg, hdr);\r\nfree_msg:\r\nnlmsg_free(msg);\r\nreturn -ENOMEM;\r\n}\r\nstatic int __seg6_hmac_fill_info(struct seg6_hmac_info *hinfo,\r\nstruct sk_buff *msg)\r\n{\r\nif (nla_put_u32(msg, SEG6_ATTR_HMACKEYID, hinfo->hmackeyid) ||\r\nnla_put_u8(msg, SEG6_ATTR_SECRETLEN, hinfo->slen) ||\r\nnla_put(msg, SEG6_ATTR_SECRET, hinfo->slen, hinfo->secret) ||\r\nnla_put_u8(msg, SEG6_ATTR_ALGID, hinfo->alg_id))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __seg6_genl_dumphmac_element(struct seg6_hmac_info *hinfo,\r\nu32 portid, u32 seq, u32 flags,\r\nstruct sk_buff *skb, u8 cmd)\r\n{\r\nvoid *hdr;\r\nhdr = genlmsg_put(skb, portid, seq, &seg6_genl_family, flags, cmd);\r\nif (!hdr)\r\nreturn -ENOMEM;\r\nif (__seg6_hmac_fill_info(hinfo, skb) < 0)\r\ngoto nla_put_failure;\r\ngenlmsg_end(skb, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(skb, hdr);\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int seg6_genl_dumphmac_start(struct netlink_callback *cb)\r\n{\r\nstruct net *net = sock_net(cb->skb->sk);\r\nstruct seg6_pernet_data *sdata;\r\nstruct rhashtable_iter *iter;\r\nsdata = seg6_pernet(net);\r\niter = (struct rhashtable_iter *)cb->args[0];\r\nif (!iter) {\r\niter = kmalloc(sizeof(*iter), GFP_KERNEL);\r\nif (!iter)\r\nreturn -ENOMEM;\r\ncb->args[0] = (long)iter;\r\n}\r\nrhashtable_walk_enter(&sdata->hmac_infos, iter);\r\nreturn 0;\r\n}\r\nstatic int seg6_genl_dumphmac_done(struct netlink_callback *cb)\r\n{\r\nstruct rhashtable_iter *iter = (struct rhashtable_iter *)cb->args[0];\r\nrhashtable_walk_exit(iter);\r\nkfree(iter);\r\nreturn 0;\r\n}\r\nstatic int seg6_genl_dumphmac(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct rhashtable_iter *iter = (struct rhashtable_iter *)cb->args[0];\r\nstruct net *net = sock_net(skb->sk);\r\nstruct seg6_pernet_data *sdata;\r\nstruct seg6_hmac_info *hinfo;\r\nint ret;\r\nsdata = seg6_pernet(net);\r\nret = rhashtable_walk_start(iter);\r\nif (ret && ret != -EAGAIN)\r\ngoto done;\r\nfor (;;) {\r\nhinfo = rhashtable_walk_next(iter);\r\nif (IS_ERR(hinfo)) {\r\nif (PTR_ERR(hinfo) == -EAGAIN)\r\ncontinue;\r\nret = PTR_ERR(hinfo);\r\ngoto done;\r\n} else if (!hinfo) {\r\nbreak;\r\n}\r\nret = __seg6_genl_dumphmac_element(hinfo,\r\nNETLINK_CB(cb->skb).portid,\r\ncb->nlh->nlmsg_seq,\r\nNLM_F_MULTI,\r\nskb, SEG6_CMD_DUMPHMAC);\r\nif (ret)\r\ngoto done;\r\n}\r\nret = skb->len;\r\ndone:\r\nrhashtable_walk_stop(iter);\r\nreturn ret;\r\n}\r\nstatic int seg6_genl_dumphmac_start(struct netlink_callback *cb)\r\n{\r\nreturn 0;\r\n}\r\nstatic int seg6_genl_dumphmac_done(struct netlink_callback *cb)\r\n{\r\nreturn 0;\r\n}\r\nstatic int seg6_genl_dumphmac(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int __net_init seg6_net_init(struct net *net)\r\n{\r\nstruct seg6_pernet_data *sdata;\r\nsdata = kzalloc(sizeof(*sdata), GFP_KERNEL);\r\nif (!sdata)\r\nreturn -ENOMEM;\r\nmutex_init(&sdata->lock);\r\nsdata->tun_src = kzalloc(sizeof(*sdata->tun_src), GFP_KERNEL);\r\nif (!sdata->tun_src) {\r\nkfree(sdata);\r\nreturn -ENOMEM;\r\n}\r\nnet->ipv6.seg6_data = sdata;\r\n#ifdef CONFIG_IPV6_SEG6_HMAC\r\nseg6_hmac_net_init(net);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __net_exit seg6_net_exit(struct net *net)\r\n{\r\nstruct seg6_pernet_data *sdata = seg6_pernet(net);\r\n#ifdef CONFIG_IPV6_SEG6_HMAC\r\nseg6_hmac_net_exit(net);\r\n#endif\r\nkfree(sdata->tun_src);\r\nkfree(sdata);\r\n}\r\nint __init seg6_init(void)\r\n{\r\nint err = -ENOMEM;\r\nerr = genl_register_family(&seg6_genl_family);\r\nif (err)\r\ngoto out;\r\nerr = register_pernet_subsys(&ip6_segments_ops);\r\nif (err)\r\ngoto out_unregister_genl;\r\n#ifdef CONFIG_IPV6_SEG6_LWTUNNEL\r\nerr = seg6_iptunnel_init();\r\nif (err)\r\ngoto out_unregister_pernet;\r\n#endif\r\n#ifdef CONFIG_IPV6_SEG6_HMAC\r\nerr = seg6_hmac_init();\r\nif (err)\r\ngoto out_unregister_iptun;\r\n#endif\r\npr_info("Segment Routing with IPv6\n");\r\nout:\r\nreturn err;\r\n#ifdef CONFIG_IPV6_SEG6_HMAC\r\nout_unregister_iptun:\r\n#ifdef CONFIG_IPV6_SEG6_LWTUNNEL\r\nseg6_iptunnel_exit();\r\n#endif\r\n#endif\r\n#ifdef CONFIG_IPV6_SEG6_LWTUNNEL\r\nout_unregister_pernet:\r\nunregister_pernet_subsys(&ip6_segments_ops);\r\n#endif\r\nout_unregister_genl:\r\ngenl_unregister_family(&seg6_genl_family);\r\ngoto out;\r\n}\r\nvoid seg6_exit(void)\r\n{\r\n#ifdef CONFIG_IPV6_SEG6_HMAC\r\nseg6_hmac_exit();\r\n#endif\r\n#ifdef CONFIG_IPV6_SEG6_LWTUNNEL\r\nseg6_iptunnel_exit();\r\n#endif\r\nunregister_pernet_subsys(&ip6_segments_ops);\r\ngenl_unregister_family(&seg6_genl_family);\r\n}

void __init_swait_queue_head(struct swait_queue_head *q, const char *name,\r\nstruct lock_class_key *key)\r\n{\r\nraw_spin_lock_init(&q->lock);\r\nlockdep_set_class_and_name(&q->lock, key, name);\r\nINIT_LIST_HEAD(&q->task_list);\r\n}\r\nvoid swake_up_locked(struct swait_queue_head *q)\r\n{\r\nstruct swait_queue *curr;\r\nif (list_empty(&q->task_list))\r\nreturn;\r\ncurr = list_first_entry(&q->task_list, typeof(*curr), task_list);\r\nwake_up_process(curr->task);\r\nlist_del_init(&curr->task_list);\r\n}\r\nvoid swake_up(struct swait_queue_head *q)\r\n{\r\nunsigned long flags;\r\nif (!swait_active(q))\r\nreturn;\r\nraw_spin_lock_irqsave(&q->lock, flags);\r\nswake_up_locked(q);\r\nraw_spin_unlock_irqrestore(&q->lock, flags);\r\n}\r\nvoid swake_up_all(struct swait_queue_head *q)\r\n{\r\nstruct swait_queue *curr;\r\nLIST_HEAD(tmp);\r\nif (!swait_active(q))\r\nreturn;\r\nraw_spin_lock_irq(&q->lock);\r\nlist_splice_init(&q->task_list, &tmp);\r\nwhile (!list_empty(&tmp)) {\r\ncurr = list_first_entry(&tmp, typeof(*curr), task_list);\r\nwake_up_state(curr->task, TASK_NORMAL);\r\nlist_del_init(&curr->task_list);\r\nif (list_empty(&tmp))\r\nbreak;\r\nraw_spin_unlock_irq(&q->lock);\r\nraw_spin_lock_irq(&q->lock);\r\n}\r\nraw_spin_unlock_irq(&q->lock);\r\n}\r\nvoid __prepare_to_swait(struct swait_queue_head *q, struct swait_queue *wait)\r\n{\r\nwait->task = current;\r\nif (list_empty(&wait->task_list))\r\nlist_add(&wait->task_list, &q->task_list);\r\n}\r\nvoid prepare_to_swait(struct swait_queue_head *q, struct swait_queue *wait, int state)\r\n{\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&q->lock, flags);\r\n__prepare_to_swait(q, wait);\r\nset_current_state(state);\r\nraw_spin_unlock_irqrestore(&q->lock, flags);\r\n}\r\nlong prepare_to_swait_event(struct swait_queue_head *q, struct swait_queue *wait, int state)\r\n{\r\nif (signal_pending_state(state, current))\r\nreturn -ERESTARTSYS;\r\nprepare_to_swait(q, wait, state);\r\nreturn 0;\r\n}\r\nvoid __finish_swait(struct swait_queue_head *q, struct swait_queue *wait)\r\n{\r\n__set_current_state(TASK_RUNNING);\r\nif (!list_empty(&wait->task_list))\r\nlist_del_init(&wait->task_list);\r\n}\r\nvoid finish_swait(struct swait_queue_head *q, struct swait_queue *wait)\r\n{\r\nunsigned long flags;\r\n__set_current_state(TASK_RUNNING);\r\nif (!list_empty_careful(&wait->task_list)) {\r\nraw_spin_lock_irqsave(&q->lock, flags);\r\nlist_del_init(&wait->task_list);\r\nraw_spin_unlock_irqrestore(&q->lock, flags);\r\n}\r\n}

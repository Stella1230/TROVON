static unsigned char m48t86_readb(struct device *dev, unsigned long addr)\r\n{\r\nstruct m48t86_rtc_info *info = dev_get_drvdata(dev);\r\nunsigned char value;\r\nwriteb(addr, info->index_reg);\r\nvalue = readb(info->data_reg);\r\nreturn value;\r\n}\r\nstatic void m48t86_writeb(struct device *dev,\r\nunsigned char value, unsigned long addr)\r\n{\r\nstruct m48t86_rtc_info *info = dev_get_drvdata(dev);\r\nwriteb(addr, info->index_reg);\r\nwriteb(value, info->data_reg);\r\n}\r\nstatic int m48t86_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char reg;\r\nreg = m48t86_readb(dev, M48T86_B);\r\nif (reg & M48T86_B_DM) {\r\ntm->tm_sec = m48t86_readb(dev, M48T86_SEC);\r\ntm->tm_min = m48t86_readb(dev, M48T86_MIN);\r\ntm->tm_hour = m48t86_readb(dev, M48T86_HOUR) & 0x3f;\r\ntm->tm_mday = m48t86_readb(dev, M48T86_DOM);\r\ntm->tm_mon = m48t86_readb(dev, M48T86_MONTH) - 1;\r\ntm->tm_year = m48t86_readb(dev, M48T86_YEAR) + 100;\r\ntm->tm_wday = m48t86_readb(dev, M48T86_DOW);\r\n} else {\r\ntm->tm_sec = bcd2bin(m48t86_readb(dev, M48T86_SEC));\r\ntm->tm_min = bcd2bin(m48t86_readb(dev, M48T86_MIN));\r\ntm->tm_hour = bcd2bin(m48t86_readb(dev, M48T86_HOUR) &\r\n0x3f);\r\ntm->tm_mday = bcd2bin(m48t86_readb(dev, M48T86_DOM));\r\ntm->tm_mon = bcd2bin(m48t86_readb(dev, M48T86_MONTH)) - 1;\r\ntm->tm_year = bcd2bin(m48t86_readb(dev, M48T86_YEAR)) + 100;\r\ntm->tm_wday = bcd2bin(m48t86_readb(dev, M48T86_DOW));\r\n}\r\nif (!(reg & M48T86_B_H24))\r\nif (m48t86_readb(dev, M48T86_HOUR) & 0x80)\r\ntm->tm_hour += 12;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int m48t86_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char reg;\r\nreg = m48t86_readb(dev, M48T86_B);\r\nreg |= M48T86_B_SET | M48T86_B_H24;\r\nm48t86_writeb(dev, reg, M48T86_B);\r\nif (reg & M48T86_B_DM) {\r\nm48t86_writeb(dev, tm->tm_sec, M48T86_SEC);\r\nm48t86_writeb(dev, tm->tm_min, M48T86_MIN);\r\nm48t86_writeb(dev, tm->tm_hour, M48T86_HOUR);\r\nm48t86_writeb(dev, tm->tm_mday, M48T86_DOM);\r\nm48t86_writeb(dev, tm->tm_mon + 1, M48T86_MONTH);\r\nm48t86_writeb(dev, tm->tm_year % 100, M48T86_YEAR);\r\nm48t86_writeb(dev, tm->tm_wday, M48T86_DOW);\r\n} else {\r\nm48t86_writeb(dev, bin2bcd(tm->tm_sec), M48T86_SEC);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_min), M48T86_MIN);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_hour), M48T86_HOUR);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_mday), M48T86_DOM);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_mon + 1), M48T86_MONTH);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_year % 100), M48T86_YEAR);\r\nm48t86_writeb(dev, bin2bcd(tm->tm_wday), M48T86_DOW);\r\n}\r\nreg &= ~M48T86_B_SET;\r\nm48t86_writeb(dev, reg, M48T86_B);\r\nreturn 0;\r\n}\r\nstatic int m48t86_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nunsigned char reg;\r\nreg = m48t86_readb(dev, M48T86_B);\r\nseq_printf(seq, "mode\t\t: %s\n",\r\n(reg & M48T86_B_DM) ? "binary" : "bcd");\r\nreg = m48t86_readb(dev, M48T86_D);\r\nseq_printf(seq, "battery\t\t: %s\n",\r\n(reg & M48T86_D_VRT) ? "ok" : "exhausted");\r\nreturn 0;\r\n}\r\nstatic ssize_t m48t86_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev = kobj_to_dev(kobj);\r\nunsigned int i;\r\nfor (i = 0; i < count; i++)\r\nbuf[i] = m48t86_readb(dev, M48T86_NVRAM(off + i));\r\nreturn count;\r\n}\r\nstatic ssize_t m48t86_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev = kobj_to_dev(kobj);\r\nunsigned int i;\r\nfor (i = 0; i < count; i++)\r\nm48t86_writeb(dev, buf[i], M48T86_NVRAM(off + i));\r\nreturn count;\r\n}\r\nstatic bool m48t86_verify_chip(struct platform_device *pdev)\r\n{\r\nunsigned int offset0 = M48T86_NVRAM(M48T86_NVRAM_LEN - 2);\r\nunsigned int offset1 = M48T86_NVRAM(M48T86_NVRAM_LEN - 1);\r\nunsigned char tmp0, tmp1;\r\ntmp0 = m48t86_readb(&pdev->dev, offset0);\r\ntmp1 = m48t86_readb(&pdev->dev, offset1);\r\nm48t86_writeb(&pdev->dev, 0x00, offset0);\r\nm48t86_writeb(&pdev->dev, 0x55, offset1);\r\nif (m48t86_readb(&pdev->dev, offset1) == 0x55) {\r\nm48t86_writeb(&pdev->dev, 0xaa, offset1);\r\nif (m48t86_readb(&pdev->dev, offset1) == 0xaa &&\r\nm48t86_readb(&pdev->dev, offset0) == 0x00) {\r\nm48t86_writeb(&pdev->dev, tmp0, offset0);\r\nm48t86_writeb(&pdev->dev, tmp1, offset1);\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic int m48t86_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct m48t86_rtc_info *info;\r\nstruct resource *res;\r\nunsigned char reg;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ninfo->index_reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(info->index_reg))\r\nreturn PTR_ERR(info->index_reg);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res)\r\nreturn -ENODEV;\r\ninfo->data_reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(info->data_reg))\r\nreturn PTR_ERR(info->data_reg);\r\ndev_set_drvdata(&pdev->dev, info);\r\nif (!m48t86_verify_chip(pdev)) {\r\ndev_info(&pdev->dev, "RTC not present\n");\r\nreturn -ENODEV;\r\n}\r\ninfo->rtc = devm_rtc_device_register(&pdev->dev, "m48t86",\r\n&m48t86_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(info->rtc))\r\nreturn PTR_ERR(info->rtc);\r\nreg = m48t86_readb(&pdev->dev, M48T86_D);\r\ndev_info(&pdev->dev, "battery %s\n",\r\n(reg & M48T86_D_VRT) ? "ok" : "exhausted");\r\nif (device_create_bin_file(&pdev->dev, &bin_attr_nvram))\r\ndev_err(&pdev->dev, "failed to create nvram sysfs entry\n");\r\nreturn 0;\r\n}\r\nstatic int m48t86_rtc_remove(struct platform_device *pdev)\r\n{\r\ndevice_remove_bin_file(&pdev->dev, &bin_attr_nvram);\r\nreturn 0;\r\n}

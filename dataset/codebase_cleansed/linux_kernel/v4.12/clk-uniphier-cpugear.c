static int uniphier_clk_cpugear_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct uniphier_clk_cpugear *gear = to_uniphier_clk_cpugear(hw);\r\nint ret;\r\nunsigned int val;\r\nret = regmap_write_bits(gear->regmap,\r\ngear->regbase + UNIPHIER_CLK_CPUGEAR_SET,\r\ngear->mask, index);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write_bits(gear->regmap,\r\ngear->regbase + UNIPHIER_CLK_CPUGEAR_SET,\r\nUNIPHIER_CLK_CPUGEAR_UPD_BIT,\r\nUNIPHIER_CLK_CPUGEAR_UPD_BIT);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_read_poll_timeout(gear->regmap,\r\ngear->regbase + UNIPHIER_CLK_CPUGEAR_UPD,\r\nval, !(val & UNIPHIER_CLK_CPUGEAR_UPD_BIT),\r\n0, 1);\r\n}\r\nstatic u8 uniphier_clk_cpugear_get_parent(struct clk_hw *hw)\r\n{\r\nstruct uniphier_clk_cpugear *gear = to_uniphier_clk_cpugear(hw);\r\nint num_parents = clk_hw_get_num_parents(hw);\r\nint ret;\r\nunsigned int val;\r\nret = regmap_read(gear->regmap,\r\ngear->regbase + UNIPHIER_CLK_CPUGEAR_STAT, &val);\r\nif (ret)\r\nreturn ret;\r\nval &= gear->mask;\r\nreturn val < num_parents ? val : -EINVAL;\r\n}\r\nstruct clk_hw *uniphier_clk_register_cpugear(struct device *dev,\r\nstruct regmap *regmap,\r\nconst char *name,\r\nconst struct uniphier_clk_cpugear_data *data)\r\n{\r\nstruct uniphier_clk_cpugear *gear;\r\nstruct clk_init_data init;\r\nint ret;\r\ngear = devm_kzalloc(dev, sizeof(*gear), GFP_KERNEL);\r\nif (!gear)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &uniphier_clk_cpugear_ops;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\ninit.parent_names = data->parent_names;\r\ninit.num_parents = data->num_parents,\r\ngear->regmap = regmap;\r\ngear->regbase = data->regbase;\r\ngear->mask = data->mask;\r\ngear->hw.init = &init;\r\nret = devm_clk_hw_register(dev, &gear->hw);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn &gear->hw;\r\n}

int iwpm_valid_pid(void)\r\n{\r\nreturn iwpm_user_pid > 0;\r\n}\r\nint iwpm_register_pid(struct iwpm_dev_data *pm_msg, u8 nl_client)\r\n{\r\nstruct sk_buff *skb = NULL;\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlmsghdr *nlh;\r\nu32 msg_seq;\r\nconst char *err_str = "";\r\nint ret = -EINVAL;\r\nif (!iwpm_valid_client(nl_client)) {\r\nerr_str = "Invalid port mapper client";\r\ngoto pid_query_error;\r\n}\r\nif (iwpm_check_registration(nl_client, IWPM_REG_VALID) ||\r\niwpm_user_pid == IWPM_PID_UNAVAILABLE)\r\nreturn 0;\r\nskb = iwpm_create_nlmsg(RDMA_NL_IWPM_REG_PID, &nlh, nl_client);\r\nif (!skb) {\r\nerr_str = "Unable to create a nlmsg";\r\ngoto pid_query_error;\r\n}\r\nnlh->nlmsg_seq = iwpm_get_nlmsg_seq();\r\nnlmsg_request = iwpm_get_nlmsg_request(nlh->nlmsg_seq, nl_client, GFP_KERNEL);\r\nif (!nlmsg_request) {\r\nerr_str = "Unable to allocate netlink request";\r\ngoto pid_query_error;\r\n}\r\nmsg_seq = atomic_read(&echo_nlmsg_seq);\r\nerr_str = "Unable to put attribute of the nlmsg";\r\nret = ibnl_put_attr(skb, nlh, sizeof(u32), &msg_seq, IWPM_NLA_REG_PID_SEQ);\r\nif (ret)\r\ngoto pid_query_error;\r\nret = ibnl_put_attr(skb, nlh, IFNAMSIZ,\r\npm_msg->if_name, IWPM_NLA_REG_IF_NAME);\r\nif (ret)\r\ngoto pid_query_error;\r\nret = ibnl_put_attr(skb, nlh, IWPM_DEVNAME_SIZE,\r\npm_msg->dev_name, IWPM_NLA_REG_IBDEV_NAME);\r\nif (ret)\r\ngoto pid_query_error;\r\nret = ibnl_put_attr(skb, nlh, IWPM_ULIBNAME_SIZE,\r\n(char *)iwpm_ulib_name, IWPM_NLA_REG_ULIB_NAME);\r\nif (ret)\r\ngoto pid_query_error;\r\npr_debug("%s: Multicasting a nlmsg (dev = %s ifname = %s iwpm = %s)\n",\r\n__func__, pm_msg->dev_name, pm_msg->if_name, iwpm_ulib_name);\r\nret = ibnl_multicast(skb, nlh, RDMA_NL_GROUP_IWPM, GFP_KERNEL);\r\nif (ret) {\r\nskb = NULL;\r\niwpm_user_pid = IWPM_PID_UNAVAILABLE;\r\nerr_str = "Unable to send a nlmsg";\r\ngoto pid_query_error;\r\n}\r\nnlmsg_request->req_buffer = pm_msg;\r\nret = iwpm_wait_complete_req(nlmsg_request);\r\nreturn ret;\r\npid_query_error:\r\npr_info("%s: %s (client = %d)\n", __func__, err_str, nl_client);\r\nif (skb)\r\ndev_kfree_skb(skb);\r\nif (nlmsg_request)\r\niwpm_free_nlmsg_request(&nlmsg_request->kref);\r\nreturn ret;\r\n}\r\nint iwpm_add_mapping(struct iwpm_sa_data *pm_msg, u8 nl_client)\r\n{\r\nstruct sk_buff *skb = NULL;\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlmsghdr *nlh;\r\nu32 msg_seq;\r\nconst char *err_str = "";\r\nint ret = -EINVAL;\r\nif (!iwpm_valid_client(nl_client)) {\r\nerr_str = "Invalid port mapper client";\r\ngoto add_mapping_error;\r\n}\r\nif (!iwpm_valid_pid())\r\nreturn 0;\r\nif (!iwpm_check_registration(nl_client, IWPM_REG_VALID)) {\r\nerr_str = "Unregistered port mapper client";\r\ngoto add_mapping_error;\r\n}\r\nskb = iwpm_create_nlmsg(RDMA_NL_IWPM_ADD_MAPPING, &nlh, nl_client);\r\nif (!skb) {\r\nerr_str = "Unable to create a nlmsg";\r\ngoto add_mapping_error;\r\n}\r\nnlh->nlmsg_seq = iwpm_get_nlmsg_seq();\r\nnlmsg_request = iwpm_get_nlmsg_request(nlh->nlmsg_seq, nl_client, GFP_KERNEL);\r\nif (!nlmsg_request) {\r\nerr_str = "Unable to allocate netlink request";\r\ngoto add_mapping_error;\r\n}\r\nmsg_seq = atomic_read(&echo_nlmsg_seq);\r\nerr_str = "Unable to put attribute of the nlmsg";\r\nret = ibnl_put_attr(skb, nlh, sizeof(u32), &msg_seq,\r\nIWPM_NLA_MANAGE_MAPPING_SEQ);\r\nif (ret)\r\ngoto add_mapping_error;\r\nret = ibnl_put_attr(skb, nlh, sizeof(struct sockaddr_storage),\r\n&pm_msg->loc_addr, IWPM_NLA_MANAGE_ADDR);\r\nif (ret)\r\ngoto add_mapping_error;\r\nnlmsg_request->req_buffer = pm_msg;\r\nret = ibnl_unicast(skb, nlh, iwpm_user_pid);\r\nif (ret) {\r\nskb = NULL;\r\niwpm_user_pid = IWPM_PID_UNDEFINED;\r\nerr_str = "Unable to send a nlmsg";\r\ngoto add_mapping_error;\r\n}\r\nret = iwpm_wait_complete_req(nlmsg_request);\r\nreturn ret;\r\nadd_mapping_error:\r\npr_info("%s: %s (client = %d)\n", __func__, err_str, nl_client);\r\nif (skb)\r\ndev_kfree_skb(skb);\r\nif (nlmsg_request)\r\niwpm_free_nlmsg_request(&nlmsg_request->kref);\r\nreturn ret;\r\n}\r\nint iwpm_add_and_query_mapping(struct iwpm_sa_data *pm_msg, u8 nl_client)\r\n{\r\nstruct sk_buff *skb = NULL;\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlmsghdr *nlh;\r\nu32 msg_seq;\r\nconst char *err_str = "";\r\nint ret = -EINVAL;\r\nif (!iwpm_valid_client(nl_client)) {\r\nerr_str = "Invalid port mapper client";\r\ngoto query_mapping_error;\r\n}\r\nif (!iwpm_valid_pid())\r\nreturn 0;\r\nif (!iwpm_check_registration(nl_client, IWPM_REG_VALID)) {\r\nerr_str = "Unregistered port mapper client";\r\ngoto query_mapping_error;\r\n}\r\nret = -ENOMEM;\r\nskb = iwpm_create_nlmsg(RDMA_NL_IWPM_QUERY_MAPPING, &nlh, nl_client);\r\nif (!skb) {\r\nerr_str = "Unable to create a nlmsg";\r\ngoto query_mapping_error;\r\n}\r\nnlh->nlmsg_seq = iwpm_get_nlmsg_seq();\r\nnlmsg_request = iwpm_get_nlmsg_request(nlh->nlmsg_seq,\r\nnl_client, GFP_KERNEL);\r\nif (!nlmsg_request) {\r\nerr_str = "Unable to allocate netlink request";\r\ngoto query_mapping_error;\r\n}\r\nmsg_seq = atomic_read(&echo_nlmsg_seq);\r\nerr_str = "Unable to put attribute of the nlmsg";\r\nret = ibnl_put_attr(skb, nlh, sizeof(u32), &msg_seq,\r\nIWPM_NLA_QUERY_MAPPING_SEQ);\r\nif (ret)\r\ngoto query_mapping_error;\r\nret = ibnl_put_attr(skb, nlh, sizeof(struct sockaddr_storage),\r\n&pm_msg->loc_addr, IWPM_NLA_QUERY_LOCAL_ADDR);\r\nif (ret)\r\ngoto query_mapping_error;\r\nret = ibnl_put_attr(skb, nlh, sizeof(struct sockaddr_storage),\r\n&pm_msg->rem_addr, IWPM_NLA_QUERY_REMOTE_ADDR);\r\nif (ret)\r\ngoto query_mapping_error;\r\nnlmsg_request->req_buffer = pm_msg;\r\nret = ibnl_unicast(skb, nlh, iwpm_user_pid);\r\nif (ret) {\r\nskb = NULL;\r\nerr_str = "Unable to send a nlmsg";\r\ngoto query_mapping_error;\r\n}\r\nret = iwpm_wait_complete_req(nlmsg_request);\r\nreturn ret;\r\nquery_mapping_error:\r\npr_info("%s: %s (client = %d)\n", __func__, err_str, nl_client);\r\nif (skb)\r\ndev_kfree_skb(skb);\r\nif (nlmsg_request)\r\niwpm_free_nlmsg_request(&nlmsg_request->kref);\r\nreturn ret;\r\n}\r\nint iwpm_remove_mapping(struct sockaddr_storage *local_addr, u8 nl_client)\r\n{\r\nstruct sk_buff *skb = NULL;\r\nstruct nlmsghdr *nlh;\r\nu32 msg_seq;\r\nconst char *err_str = "";\r\nint ret = -EINVAL;\r\nif (!iwpm_valid_client(nl_client)) {\r\nerr_str = "Invalid port mapper client";\r\ngoto remove_mapping_error;\r\n}\r\nif (!iwpm_valid_pid())\r\nreturn 0;\r\nif (iwpm_check_registration(nl_client, IWPM_REG_UNDEF)) {\r\nerr_str = "Unregistered port mapper client";\r\ngoto remove_mapping_error;\r\n}\r\nskb = iwpm_create_nlmsg(RDMA_NL_IWPM_REMOVE_MAPPING, &nlh, nl_client);\r\nif (!skb) {\r\nret = -ENOMEM;\r\nerr_str = "Unable to create a nlmsg";\r\ngoto remove_mapping_error;\r\n}\r\nmsg_seq = atomic_read(&echo_nlmsg_seq);\r\nnlh->nlmsg_seq = iwpm_get_nlmsg_seq();\r\nerr_str = "Unable to put attribute of the nlmsg";\r\nret = ibnl_put_attr(skb, nlh, sizeof(u32), &msg_seq,\r\nIWPM_NLA_MANAGE_MAPPING_SEQ);\r\nif (ret)\r\ngoto remove_mapping_error;\r\nret = ibnl_put_attr(skb, nlh, sizeof(struct sockaddr_storage),\r\nlocal_addr, IWPM_NLA_MANAGE_ADDR);\r\nif (ret)\r\ngoto remove_mapping_error;\r\nret = ibnl_unicast(skb, nlh, iwpm_user_pid);\r\nif (ret) {\r\nskb = NULL;\r\niwpm_user_pid = IWPM_PID_UNDEFINED;\r\nerr_str = "Unable to send a nlmsg";\r\ngoto remove_mapping_error;\r\n}\r\niwpm_print_sockaddr(local_addr,\r\n"remove_mapping: Local sockaddr:");\r\nreturn 0;\r\nremove_mapping_error:\r\npr_info("%s: %s (client = %d)\n", __func__, err_str, nl_client);\r\nif (skb)\r\ndev_kfree_skb_any(skb);\r\nreturn ret;\r\n}\r\nint iwpm_register_pid_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlattr *nltb[IWPM_NLA_RREG_PID_MAX];\r\nstruct iwpm_dev_data *pm_msg;\r\nchar *dev_name, *iwpm_name;\r\nu32 msg_seq;\r\nu8 nl_client;\r\nu16 iwpm_version;\r\nconst char *msg_type = "Register Pid response";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_RREG_PID_MAX,\r\nresp_reg_policy, nltb, msg_type))\r\nreturn -EINVAL;\r\nmsg_seq = nla_get_u32(nltb[IWPM_NLA_RREG_PID_SEQ]);\r\nnlmsg_request = iwpm_find_nlmsg_request(msg_seq);\r\nif (!nlmsg_request) {\r\npr_info("%s: Could not find a matching request (seq = %u)\n",\r\n__func__, msg_seq);\r\nreturn -EINVAL;\r\n}\r\npm_msg = nlmsg_request->req_buffer;\r\nnl_client = nlmsg_request->nl_client;\r\ndev_name = (char *)nla_data(nltb[IWPM_NLA_RREG_IBDEV_NAME]);\r\niwpm_name = (char *)nla_data(nltb[IWPM_NLA_RREG_ULIB_NAME]);\r\niwpm_version = nla_get_u16(nltb[IWPM_NLA_RREG_ULIB_VER]);\r\nif (strcmp(pm_msg->dev_name, dev_name) ||\r\nstrcmp(iwpm_ulib_name, iwpm_name) ||\r\niwpm_version != iwpm_ulib_version) {\r\npr_info("%s: Incorrect info (dev = %s name = %s version = %d)\n",\r\n__func__, dev_name, iwpm_name, iwpm_version);\r\nnlmsg_request->err_code = IWPM_USER_LIB_INFO_ERR;\r\ngoto register_pid_response_exit;\r\n}\r\niwpm_user_pid = cb->nlh->nlmsg_pid;\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\npr_debug("%s: iWarp Port Mapper (pid = %d) is available!\n",\r\n__func__, iwpm_user_pid);\r\nif (iwpm_valid_client(nl_client))\r\niwpm_set_registration(nl_client, IWPM_REG_VALID);\r\nregister_pid_response_exit:\r\nnlmsg_request->request_done = 1;\r\nkref_put(&nlmsg_request->kref, iwpm_free_nlmsg_request);\r\nbarrier();\r\nup(&nlmsg_request->sem);\r\nreturn 0;\r\n}\r\nint iwpm_add_mapping_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct iwpm_sa_data *pm_msg;\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlattr *nltb[IWPM_NLA_RMANAGE_MAPPING_MAX];\r\nstruct sockaddr_storage *local_sockaddr;\r\nstruct sockaddr_storage *mapped_sockaddr;\r\nconst char *msg_type;\r\nu32 msg_seq;\r\nmsg_type = "Add Mapping response";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_RMANAGE_MAPPING_MAX,\r\nresp_add_policy, nltb, msg_type))\r\nreturn -EINVAL;\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\nmsg_seq = nla_get_u32(nltb[IWPM_NLA_MANAGE_MAPPING_SEQ]);\r\nnlmsg_request = iwpm_find_nlmsg_request(msg_seq);\r\nif (!nlmsg_request) {\r\npr_info("%s: Could not find a matching request (seq = %u)\n",\r\n__func__, msg_seq);\r\nreturn -EINVAL;\r\n}\r\npm_msg = nlmsg_request->req_buffer;\r\nlocal_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_MANAGE_ADDR]);\r\nmapped_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_MANAGE_MAPPED_LOC_ADDR]);\r\nif (iwpm_compare_sockaddr(local_sockaddr, &pm_msg->loc_addr)) {\r\nnlmsg_request->err_code = IWPM_USER_LIB_INFO_ERR;\r\ngoto add_mapping_response_exit;\r\n}\r\nif (mapped_sockaddr->ss_family != local_sockaddr->ss_family) {\r\npr_info("%s: Sockaddr family doesn't match the requested one\n",\r\n__func__);\r\nnlmsg_request->err_code = IWPM_USER_LIB_INFO_ERR;\r\ngoto add_mapping_response_exit;\r\n}\r\nmemcpy(&pm_msg->mapped_loc_addr, mapped_sockaddr,\r\nsizeof(*mapped_sockaddr));\r\niwpm_print_sockaddr(&pm_msg->loc_addr,\r\n"add_mapping: Local sockaddr:");\r\niwpm_print_sockaddr(&pm_msg->mapped_loc_addr,\r\n"add_mapping: Mapped local sockaddr:");\r\nadd_mapping_response_exit:\r\nnlmsg_request->request_done = 1;\r\nkref_put(&nlmsg_request->kref, iwpm_free_nlmsg_request);\r\nbarrier();\r\nup(&nlmsg_request->sem);\r\nreturn 0;\r\n}\r\nint iwpm_add_and_query_mapping_cb(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nstruct iwpm_sa_data *pm_msg;\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nstruct nlattr *nltb[IWPM_NLA_RQUERY_MAPPING_MAX];\r\nstruct sockaddr_storage *local_sockaddr, *remote_sockaddr;\r\nstruct sockaddr_storage *mapped_loc_sockaddr, *mapped_rem_sockaddr;\r\nconst char *msg_type;\r\nu32 msg_seq;\r\nu16 err_code;\r\nmsg_type = "Query Mapping response";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_RQUERY_MAPPING_MAX,\r\nresp_query_policy, nltb, msg_type))\r\nreturn -EINVAL;\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\nmsg_seq = nla_get_u32(nltb[IWPM_NLA_QUERY_MAPPING_SEQ]);\r\nnlmsg_request = iwpm_find_nlmsg_request(msg_seq);\r\nif (!nlmsg_request) {\r\npr_info("%s: Could not find a matching request (seq = %u)\n",\r\n__func__, msg_seq);\r\nreturn -EINVAL;\r\n}\r\npm_msg = nlmsg_request->req_buffer;\r\nlocal_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_QUERY_LOCAL_ADDR]);\r\nremote_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_QUERY_REMOTE_ADDR]);\r\nmapped_loc_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_RQUERY_MAPPED_LOC_ADDR]);\r\nmapped_rem_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_RQUERY_MAPPED_REM_ADDR]);\r\nerr_code = nla_get_u16(nltb[IWPM_NLA_RQUERY_MAPPING_ERR]);\r\nif (err_code == IWPM_REMOTE_QUERY_REJECT) {\r\npr_info("%s: Received a Reject (pid = %u, echo seq = %u)\n",\r\n__func__, cb->nlh->nlmsg_pid, msg_seq);\r\nnlmsg_request->err_code = IWPM_REMOTE_QUERY_REJECT;\r\n}\r\nif (iwpm_compare_sockaddr(local_sockaddr, &pm_msg->loc_addr) ||\r\niwpm_compare_sockaddr(remote_sockaddr, &pm_msg->rem_addr)) {\r\npr_info("%s: Incorrect local sockaddr\n", __func__);\r\nnlmsg_request->err_code = IWPM_USER_LIB_INFO_ERR;\r\ngoto query_mapping_response_exit;\r\n}\r\nif (mapped_loc_sockaddr->ss_family != local_sockaddr->ss_family ||\r\nmapped_rem_sockaddr->ss_family != remote_sockaddr->ss_family) {\r\npr_info("%s: Sockaddr family doesn't match the requested one\n",\r\n__func__);\r\nnlmsg_request->err_code = IWPM_USER_LIB_INFO_ERR;\r\ngoto query_mapping_response_exit;\r\n}\r\nmemcpy(&pm_msg->mapped_loc_addr, mapped_loc_sockaddr,\r\nsizeof(*mapped_loc_sockaddr));\r\nmemcpy(&pm_msg->mapped_rem_addr, mapped_rem_sockaddr,\r\nsizeof(*mapped_rem_sockaddr));\r\niwpm_print_sockaddr(&pm_msg->loc_addr,\r\n"query_mapping: Local sockaddr:");\r\niwpm_print_sockaddr(&pm_msg->mapped_loc_addr,\r\n"query_mapping: Mapped local sockaddr:");\r\niwpm_print_sockaddr(&pm_msg->rem_addr,\r\n"query_mapping: Remote sockaddr:");\r\niwpm_print_sockaddr(&pm_msg->mapped_rem_addr,\r\n"query_mapping: Mapped remote sockaddr:");\r\nquery_mapping_response_exit:\r\nnlmsg_request->request_done = 1;\r\nkref_put(&nlmsg_request->kref, iwpm_free_nlmsg_request);\r\nbarrier();\r\nup(&nlmsg_request->sem);\r\nreturn 0;\r\n}\r\nint iwpm_remote_info_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct nlattr *nltb[IWPM_NLA_RQUERY_MAPPING_MAX];\r\nstruct sockaddr_storage *local_sockaddr, *remote_sockaddr;\r\nstruct sockaddr_storage *mapped_loc_sockaddr, *mapped_rem_sockaddr;\r\nstruct iwpm_remote_info *rem_info;\r\nconst char *msg_type;\r\nu8 nl_client;\r\nint ret = -EINVAL;\r\nmsg_type = "Remote Mapping info";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_RQUERY_MAPPING_MAX,\r\nresp_query_policy, nltb, msg_type))\r\nreturn ret;\r\nnl_client = RDMA_NL_GET_CLIENT(cb->nlh->nlmsg_type);\r\nif (!iwpm_valid_client(nl_client)) {\r\npr_info("%s: Invalid port mapper client = %d\n",\r\n__func__, nl_client);\r\nreturn ret;\r\n}\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\nlocal_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_QUERY_LOCAL_ADDR]);\r\nremote_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_QUERY_REMOTE_ADDR]);\r\nmapped_loc_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_RQUERY_MAPPED_LOC_ADDR]);\r\nmapped_rem_sockaddr = (struct sockaddr_storage *)\r\nnla_data(nltb[IWPM_NLA_RQUERY_MAPPED_REM_ADDR]);\r\nif (mapped_loc_sockaddr->ss_family != local_sockaddr->ss_family ||\r\nmapped_rem_sockaddr->ss_family != remote_sockaddr->ss_family) {\r\npr_info("%s: Sockaddr family doesn't match the requested one\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nrem_info = kzalloc(sizeof(struct iwpm_remote_info), GFP_ATOMIC);\r\nif (!rem_info) {\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nmemcpy(&rem_info->mapped_loc_sockaddr, mapped_loc_sockaddr,\r\nsizeof(struct sockaddr_storage));\r\nmemcpy(&rem_info->remote_sockaddr, remote_sockaddr,\r\nsizeof(struct sockaddr_storage));\r\nmemcpy(&rem_info->mapped_rem_sockaddr, mapped_rem_sockaddr,\r\nsizeof(struct sockaddr_storage));\r\nrem_info->nl_client = nl_client;\r\niwpm_add_remote_info(rem_info);\r\niwpm_print_sockaddr(local_sockaddr,\r\n"remote_info: Local sockaddr:");\r\niwpm_print_sockaddr(mapped_loc_sockaddr,\r\n"remote_info: Mapped local sockaddr:");\r\niwpm_print_sockaddr(remote_sockaddr,\r\n"remote_info: Remote sockaddr:");\r\niwpm_print_sockaddr(mapped_rem_sockaddr,\r\n"remote_info: Mapped remote sockaddr:");\r\nreturn ret;\r\n}\r\nint iwpm_mapping_info_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct nlattr *nltb[IWPM_NLA_MAPINFO_REQ_MAX];\r\nconst char *msg_type = "Mapping Info response";\r\nu8 nl_client;\r\nchar *iwpm_name;\r\nu16 iwpm_version;\r\nint ret = -EINVAL;\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_MAPINFO_REQ_MAX,\r\nresp_mapinfo_policy, nltb, msg_type)) {\r\npr_info("%s: Unable to parse nlmsg\n", __func__);\r\nreturn ret;\r\n}\r\niwpm_name = (char *)nla_data(nltb[IWPM_NLA_MAPINFO_ULIB_NAME]);\r\niwpm_version = nla_get_u16(nltb[IWPM_NLA_MAPINFO_ULIB_VER]);\r\nif (strcmp(iwpm_ulib_name, iwpm_name) ||\r\niwpm_version != iwpm_ulib_version) {\r\npr_info("%s: Invalid port mapper name = %s version = %d\n",\r\n__func__, iwpm_name, iwpm_version);\r\nreturn ret;\r\n}\r\nnl_client = RDMA_NL_GET_CLIENT(cb->nlh->nlmsg_type);\r\nif (!iwpm_valid_client(nl_client)) {\r\npr_info("%s: Invalid port mapper client = %d\n",\r\n__func__, nl_client);\r\nreturn ret;\r\n}\r\niwpm_set_registration(nl_client, IWPM_REG_INCOMPL);\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\niwpm_user_pid = cb->nlh->nlmsg_pid;\r\nif (!iwpm_mapinfo_available())\r\nreturn 0;\r\npr_debug("%s: iWarp Port Mapper (pid = %d) is available!\n",\r\n__func__, iwpm_user_pid);\r\nret = iwpm_send_mapinfo(nl_client, iwpm_user_pid);\r\nreturn ret;\r\n}\r\nint iwpm_ack_mapping_info_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct nlattr *nltb[IWPM_NLA_MAPINFO_NUM_MAX];\r\nu32 mapinfo_send, mapinfo_ack;\r\nconst char *msg_type = "Mapping Info Ack";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_MAPINFO_NUM_MAX,\r\nack_mapinfo_policy, nltb, msg_type))\r\nreturn -EINVAL;\r\nmapinfo_send = nla_get_u32(nltb[IWPM_NLA_MAPINFO_SEND_NUM]);\r\nmapinfo_ack = nla_get_u32(nltb[IWPM_NLA_MAPINFO_ACK_NUM]);\r\nif (mapinfo_ack != mapinfo_send)\r\npr_info("%s: Invalid mapinfo number (sent = %u ack-ed = %u)\n",\r\n__func__, mapinfo_send, mapinfo_ack);\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\nreturn 0;\r\n}\r\nint iwpm_mapping_error_cb(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct iwpm_nlmsg_request *nlmsg_request = NULL;\r\nint nl_client = RDMA_NL_GET_CLIENT(cb->nlh->nlmsg_type);\r\nstruct nlattr *nltb[IWPM_NLA_ERR_MAX];\r\nu32 msg_seq;\r\nu16 err_code;\r\nconst char *msg_type = "Mapping Error Msg";\r\nif (iwpm_parse_nlmsg(cb, IWPM_NLA_ERR_MAX,\r\nmap_error_policy, nltb, msg_type))\r\nreturn -EINVAL;\r\nmsg_seq = nla_get_u32(nltb[IWPM_NLA_ERR_SEQ]);\r\nerr_code = nla_get_u16(nltb[IWPM_NLA_ERR_CODE]);\r\npr_info("%s: Received msg seq = %u err code = %u client = %d\n",\r\n__func__, msg_seq, err_code, nl_client);\r\nnlmsg_request = iwpm_find_nlmsg_request(msg_seq);\r\nif (!nlmsg_request) {\r\npr_debug("Could not find matching req (seq = %u)\n", msg_seq);\r\nreturn 0;\r\n}\r\natomic_set(&echo_nlmsg_seq, cb->nlh->nlmsg_seq);\r\nnlmsg_request->err_code = err_code;\r\nnlmsg_request->request_done = 1;\r\nkref_put(&nlmsg_request->kref, iwpm_free_nlmsg_request);\r\nbarrier();\r\nup(&nlmsg_request->sem);\r\nreturn 0;\r\n}

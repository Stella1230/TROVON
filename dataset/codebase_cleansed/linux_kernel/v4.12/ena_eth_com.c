static inline struct ena_eth_io_rx_cdesc_base *ena_com_get_next_rx_cdesc(\r\nstruct ena_com_io_cq *io_cq)\r\n{\r\nstruct ena_eth_io_rx_cdesc_base *cdesc;\r\nu16 expected_phase, head_masked;\r\nu16 desc_phase;\r\nhead_masked = io_cq->head & (io_cq->q_depth - 1);\r\nexpected_phase = io_cq->phase;\r\ncdesc = (struct ena_eth_io_rx_cdesc_base *)(io_cq->cdesc_addr.virt_addr\r\n+ (head_masked * io_cq->cdesc_entry_size_in_bytes));\r\ndesc_phase = (READ_ONCE(cdesc->status) & ENA_ETH_IO_RX_CDESC_BASE_PHASE_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_PHASE_SHIFT;\r\nif (desc_phase != expected_phase)\r\nreturn NULL;\r\nreturn cdesc;\r\n}\r\nstatic inline void ena_com_cq_inc_head(struct ena_com_io_cq *io_cq)\r\n{\r\nio_cq->head++;\r\nif (unlikely((io_cq->head & (io_cq->q_depth - 1)) == 0))\r\nio_cq->phase ^= 1;\r\n}\r\nstatic inline void *get_sq_desc(struct ena_com_io_sq *io_sq)\r\n{\r\nu16 tail_masked;\r\nu32 offset;\r\ntail_masked = io_sq->tail & (io_sq->q_depth - 1);\r\noffset = tail_masked * io_sq->desc_entry_size;\r\nreturn (void *)((uintptr_t)io_sq->desc_addr.virt_addr + offset);\r\n}\r\nstatic inline void ena_com_copy_curr_sq_desc_to_dev(struct ena_com_io_sq *io_sq)\r\n{\r\nu16 tail_masked = io_sq->tail & (io_sq->q_depth - 1);\r\nu32 offset = tail_masked * io_sq->desc_entry_size;\r\nif (io_sq->mem_queue_type == ENA_ADMIN_PLACEMENT_POLICY_HOST)\r\nreturn;\r\nmemcpy_toio(io_sq->desc_addr.pbuf_dev_addr + offset,\r\nio_sq->desc_addr.virt_addr + offset,\r\nio_sq->desc_entry_size);\r\n}\r\nstatic inline void ena_com_sq_update_tail(struct ena_com_io_sq *io_sq)\r\n{\r\nio_sq->tail++;\r\nif (unlikely((io_sq->tail & (io_sq->q_depth - 1)) == 0))\r\nio_sq->phase ^= 1;\r\n}\r\nstatic inline int ena_com_write_header(struct ena_com_io_sq *io_sq,\r\nu8 *head_src, u16 header_len)\r\n{\r\nu16 tail_masked = io_sq->tail & (io_sq->q_depth - 1);\r\nu8 __iomem *dev_head_addr =\r\nio_sq->header_addr + (tail_masked * io_sq->tx_max_header_size);\r\nif (io_sq->mem_queue_type == ENA_ADMIN_PLACEMENT_POLICY_HOST)\r\nreturn 0;\r\nif (unlikely(!io_sq->header_addr)) {\r\npr_err("Push buffer header ptr is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nmemcpy_toio(dev_head_addr, head_src, header_len);\r\nreturn 0;\r\n}\r\nstatic inline struct ena_eth_io_rx_cdesc_base *\r\nena_com_rx_cdesc_idx_to_ptr(struct ena_com_io_cq *io_cq, u16 idx)\r\n{\r\nidx &= (io_cq->q_depth - 1);\r\nreturn (struct ena_eth_io_rx_cdesc_base *)\r\n((uintptr_t)io_cq->cdesc_addr.virt_addr +\r\nidx * io_cq->cdesc_entry_size_in_bytes);\r\n}\r\nstatic inline u16 ena_com_cdesc_rx_pkt_get(struct ena_com_io_cq *io_cq,\r\nu16 *first_cdesc_idx)\r\n{\r\nstruct ena_eth_io_rx_cdesc_base *cdesc;\r\nu16 count = 0, head_masked;\r\nu32 last = 0;\r\ndo {\r\ncdesc = ena_com_get_next_rx_cdesc(io_cq);\r\nif (!cdesc)\r\nbreak;\r\nena_com_cq_inc_head(io_cq);\r\ncount++;\r\nlast = (READ_ONCE(cdesc->status) & ENA_ETH_IO_RX_CDESC_BASE_LAST_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_LAST_SHIFT;\r\n} while (!last);\r\nif (last) {\r\n*first_cdesc_idx = io_cq->cur_rx_pkt_cdesc_start_idx;\r\ncount += io_cq->cur_rx_pkt_cdesc_count;\r\nhead_masked = io_cq->head & (io_cq->q_depth - 1);\r\nio_cq->cur_rx_pkt_cdesc_count = 0;\r\nio_cq->cur_rx_pkt_cdesc_start_idx = head_masked;\r\npr_debug("ena q_id: %d packets were completed. first desc idx %u descs# %d\n",\r\nio_cq->qid, *first_cdesc_idx, count);\r\n} else {\r\nio_cq->cur_rx_pkt_cdesc_count += count;\r\ncount = 0;\r\n}\r\nreturn count;\r\n}\r\nstatic inline bool ena_com_meta_desc_changed(struct ena_com_io_sq *io_sq,\r\nstruct ena_com_tx_ctx *ena_tx_ctx)\r\n{\r\nint rc;\r\nif (ena_tx_ctx->meta_valid) {\r\nrc = memcmp(&io_sq->cached_tx_meta,\r\n&ena_tx_ctx->ena_meta,\r\nsizeof(struct ena_com_tx_meta));\r\nif (unlikely(rc != 0))\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic inline void ena_com_create_and_store_tx_meta_desc(struct ena_com_io_sq *io_sq,\r\nstruct ena_com_tx_ctx *ena_tx_ctx)\r\n{\r\nstruct ena_eth_io_tx_meta_desc *meta_desc = NULL;\r\nstruct ena_com_tx_meta *ena_meta = &ena_tx_ctx->ena_meta;\r\nmeta_desc = get_sq_desc(io_sq);\r\nmemset(meta_desc, 0x0, sizeof(struct ena_eth_io_tx_meta_desc));\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_META_DESC_MASK;\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_EXT_VALID_MASK;\r\nmeta_desc->word2 |= (ena_meta->mss <<\r\nENA_ETH_IO_TX_META_DESC_MSS_LO_SHIFT) &\r\nENA_ETH_IO_TX_META_DESC_MSS_LO_MASK;\r\nmeta_desc->len_ctrl |= ((ena_meta->mss >> 10) <<\r\nENA_ETH_IO_TX_META_DESC_MSS_HI_SHIFT) &\r\nENA_ETH_IO_TX_META_DESC_MSS_HI_MASK;\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_ETH_META_TYPE_MASK;\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_META_STORE_MASK;\r\nmeta_desc->len_ctrl |= (io_sq->phase <<\r\nENA_ETH_IO_TX_META_DESC_PHASE_SHIFT) &\r\nENA_ETH_IO_TX_META_DESC_PHASE_MASK;\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_FIRST_MASK;\r\nmeta_desc->word2 |= ena_meta->l3_hdr_len &\r\nENA_ETH_IO_TX_META_DESC_L3_HDR_LEN_MASK;\r\nmeta_desc->word2 |= (ena_meta->l3_hdr_offset <<\r\nENA_ETH_IO_TX_META_DESC_L3_HDR_OFF_SHIFT) &\r\nENA_ETH_IO_TX_META_DESC_L3_HDR_OFF_MASK;\r\nmeta_desc->word2 |= (ena_meta->l4_hdr_len <<\r\nENA_ETH_IO_TX_META_DESC_L4_HDR_LEN_IN_WORDS_SHIFT) &\r\nENA_ETH_IO_TX_META_DESC_L4_HDR_LEN_IN_WORDS_MASK;\r\nmeta_desc->len_ctrl |= ENA_ETH_IO_TX_META_DESC_META_STORE_MASK;\r\nmemcpy(&io_sq->cached_tx_meta, ena_meta,\r\nsizeof(struct ena_com_tx_meta));\r\nena_com_copy_curr_sq_desc_to_dev(io_sq);\r\nena_com_sq_update_tail(io_sq);\r\n}\r\nstatic inline void ena_com_rx_set_flags(struct ena_com_rx_ctx *ena_rx_ctx,\r\nstruct ena_eth_io_rx_cdesc_base *cdesc)\r\n{\r\nena_rx_ctx->l3_proto = cdesc->status &\r\nENA_ETH_IO_RX_CDESC_BASE_L3_PROTO_IDX_MASK;\r\nena_rx_ctx->l4_proto =\r\n(cdesc->status & ENA_ETH_IO_RX_CDESC_BASE_L4_PROTO_IDX_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_L4_PROTO_IDX_SHIFT;\r\nena_rx_ctx->l3_csum_err =\r\n(cdesc->status & ENA_ETH_IO_RX_CDESC_BASE_L3_CSUM_ERR_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_L3_CSUM_ERR_SHIFT;\r\nena_rx_ctx->l4_csum_err =\r\n(cdesc->status & ENA_ETH_IO_RX_CDESC_BASE_L4_CSUM_ERR_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_L4_CSUM_ERR_SHIFT;\r\nena_rx_ctx->hash = cdesc->hash;\r\nena_rx_ctx->frag =\r\n(cdesc->status & ENA_ETH_IO_RX_CDESC_BASE_IPV4_FRAG_MASK) >>\r\nENA_ETH_IO_RX_CDESC_BASE_IPV4_FRAG_SHIFT;\r\npr_debug("ena_rx_ctx->l3_proto %d ena_rx_ctx->l4_proto %d\nena_rx_ctx->l3_csum_err %d ena_rx_ctx->l4_csum_err %d\nhash frag %d frag: %d cdesc_status: %x\n",\r\nena_rx_ctx->l3_proto, ena_rx_ctx->l4_proto,\r\nena_rx_ctx->l3_csum_err, ena_rx_ctx->l4_csum_err,\r\nena_rx_ctx->hash, ena_rx_ctx->frag, cdesc->status);\r\n}\r\nint ena_com_prepare_tx(struct ena_com_io_sq *io_sq,\r\nstruct ena_com_tx_ctx *ena_tx_ctx,\r\nint *nb_hw_desc)\r\n{\r\nstruct ena_eth_io_tx_desc *desc = NULL;\r\nstruct ena_com_buf *ena_bufs = ena_tx_ctx->ena_bufs;\r\nvoid *push_header = ena_tx_ctx->push_header;\r\nu16 header_len = ena_tx_ctx->header_len;\r\nu16 num_bufs = ena_tx_ctx->num_bufs;\r\nint total_desc, i, rc;\r\nbool have_meta;\r\nu64 addr_hi;\r\nWARN(io_sq->direction != ENA_COM_IO_QUEUE_DIRECTION_TX, "wrong Q type");\r\nif (ena_com_sq_empty_space(io_sq) < (num_bufs + 1)) {\r\npr_err("Not enough space in the tx queue\n");\r\nreturn -ENOMEM;\r\n}\r\nif (unlikely(header_len > io_sq->tx_max_header_size)) {\r\npr_err("header size is too large %d max header: %d\n",\r\nheader_len, io_sq->tx_max_header_size);\r\nreturn -EINVAL;\r\n}\r\nrc = ena_com_write_header(io_sq, push_header, header_len);\r\nif (unlikely(rc))\r\nreturn rc;\r\nhave_meta = ena_tx_ctx->meta_valid && ena_com_meta_desc_changed(io_sq,\r\nena_tx_ctx);\r\nif (have_meta)\r\nena_com_create_and_store_tx_meta_desc(io_sq, ena_tx_ctx);\r\nif (unlikely(!num_bufs && !header_len)) {\r\n*nb_hw_desc = have_meta ? 0 : 1;\r\nreturn 0;\r\n}\r\ndesc = get_sq_desc(io_sq);\r\nmemset(desc, 0x0, sizeof(struct ena_eth_io_tx_desc));\r\nif (!have_meta)\r\ndesc->len_ctrl |= ENA_ETH_IO_TX_DESC_FIRST_MASK;\r\ndesc->buff_addr_hi_hdr_sz |= (header_len <<\r\nENA_ETH_IO_TX_DESC_HEADER_LENGTH_SHIFT) &\r\nENA_ETH_IO_TX_DESC_HEADER_LENGTH_MASK;\r\ndesc->len_ctrl |= (io_sq->phase << ENA_ETH_IO_TX_DESC_PHASE_SHIFT) &\r\nENA_ETH_IO_TX_DESC_PHASE_MASK;\r\ndesc->len_ctrl |= ENA_ETH_IO_TX_DESC_COMP_REQ_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->req_id <<\r\nENA_ETH_IO_TX_DESC_REQ_ID_LO_SHIFT) &\r\nENA_ETH_IO_TX_DESC_REQ_ID_LO_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->df <<\r\nENA_ETH_IO_TX_DESC_DF_SHIFT) &\r\nENA_ETH_IO_TX_DESC_DF_MASK;\r\ndesc->len_ctrl |= ((ena_tx_ctx->req_id >> 10) <<\r\nENA_ETH_IO_TX_DESC_REQ_ID_HI_SHIFT) &\r\nENA_ETH_IO_TX_DESC_REQ_ID_HI_MASK;\r\nif (ena_tx_ctx->meta_valid) {\r\ndesc->meta_ctrl |= (ena_tx_ctx->tso_enable <<\r\nENA_ETH_IO_TX_DESC_TSO_EN_SHIFT) &\r\nENA_ETH_IO_TX_DESC_TSO_EN_MASK;\r\ndesc->meta_ctrl |= ena_tx_ctx->l3_proto &\r\nENA_ETH_IO_TX_DESC_L3_PROTO_IDX_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->l4_proto <<\r\nENA_ETH_IO_TX_DESC_L4_PROTO_IDX_SHIFT) &\r\nENA_ETH_IO_TX_DESC_L4_PROTO_IDX_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->l3_csum_enable <<\r\nENA_ETH_IO_TX_DESC_L3_CSUM_EN_SHIFT) &\r\nENA_ETH_IO_TX_DESC_L3_CSUM_EN_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->l4_csum_enable <<\r\nENA_ETH_IO_TX_DESC_L4_CSUM_EN_SHIFT) &\r\nENA_ETH_IO_TX_DESC_L4_CSUM_EN_MASK;\r\ndesc->meta_ctrl |= (ena_tx_ctx->l4_csum_partial <<\r\nENA_ETH_IO_TX_DESC_L4_CSUM_PARTIAL_SHIFT) &\r\nENA_ETH_IO_TX_DESC_L4_CSUM_PARTIAL_MASK;\r\n}\r\nfor (i = 0; i < num_bufs; i++) {\r\nif (likely(i != 0)) {\r\nena_com_copy_curr_sq_desc_to_dev(io_sq);\r\nena_com_sq_update_tail(io_sq);\r\ndesc = get_sq_desc(io_sq);\r\nmemset(desc, 0x0, sizeof(struct ena_eth_io_tx_desc));\r\ndesc->len_ctrl |= (io_sq->phase <<\r\nENA_ETH_IO_TX_DESC_PHASE_SHIFT) &\r\nENA_ETH_IO_TX_DESC_PHASE_MASK;\r\n}\r\ndesc->len_ctrl |= ena_bufs->len &\r\nENA_ETH_IO_TX_DESC_LENGTH_MASK;\r\naddr_hi = ((ena_bufs->paddr &\r\nGENMASK_ULL(io_sq->dma_addr_bits - 1, 32)) >> 32);\r\ndesc->buff_addr_lo = (u32)ena_bufs->paddr;\r\ndesc->buff_addr_hi_hdr_sz |= addr_hi &\r\nENA_ETH_IO_TX_DESC_ADDR_HI_MASK;\r\nena_bufs++;\r\n}\r\ndesc->len_ctrl |= ENA_ETH_IO_TX_DESC_LAST_MASK;\r\nena_com_copy_curr_sq_desc_to_dev(io_sq);\r\nena_com_sq_update_tail(io_sq);\r\ntotal_desc = max_t(u16, num_bufs, 1);\r\ntotal_desc += have_meta ? 1 : 0;\r\n*nb_hw_desc = total_desc;\r\nreturn 0;\r\n}\r\nint ena_com_rx_pkt(struct ena_com_io_cq *io_cq,\r\nstruct ena_com_io_sq *io_sq,\r\nstruct ena_com_rx_ctx *ena_rx_ctx)\r\n{\r\nstruct ena_com_rx_buf_info *ena_buf = &ena_rx_ctx->ena_bufs[0];\r\nstruct ena_eth_io_rx_cdesc_base *cdesc = NULL;\r\nu16 cdesc_idx = 0;\r\nu16 nb_hw_desc;\r\nu16 i;\r\nWARN(io_cq->direction != ENA_COM_IO_QUEUE_DIRECTION_RX, "wrong Q type");\r\nnb_hw_desc = ena_com_cdesc_rx_pkt_get(io_cq, &cdesc_idx);\r\nif (nb_hw_desc == 0) {\r\nena_rx_ctx->descs = nb_hw_desc;\r\nreturn 0;\r\n}\r\npr_debug("fetch rx packet: queue %d completed desc: %d\n", io_cq->qid,\r\nnb_hw_desc);\r\nif (unlikely(nb_hw_desc > ena_rx_ctx->max_bufs)) {\r\npr_err("Too many RX cdescs (%d) > MAX(%d)\n", nb_hw_desc,\r\nena_rx_ctx->max_bufs);\r\nreturn -ENOSPC;\r\n}\r\nfor (i = 0; i < nb_hw_desc; i++) {\r\ncdesc = ena_com_rx_cdesc_idx_to_ptr(io_cq, cdesc_idx + i);\r\nena_buf->len = cdesc->length;\r\nena_buf->req_id = cdesc->req_id;\r\nena_buf++;\r\n}\r\nio_sq->next_to_comp += nb_hw_desc;\r\npr_debug("[%s][QID#%d] Updating SQ head to: %d\n", __func__, io_sq->qid,\r\nio_sq->next_to_comp);\r\nena_com_rx_set_flags(ena_rx_ctx, cdesc);\r\nena_rx_ctx->descs = nb_hw_desc;\r\nreturn 0;\r\n}\r\nint ena_com_add_single_rx_desc(struct ena_com_io_sq *io_sq,\r\nstruct ena_com_buf *ena_buf,\r\nu16 req_id)\r\n{\r\nstruct ena_eth_io_rx_desc *desc;\r\nWARN(io_sq->direction != ENA_COM_IO_QUEUE_DIRECTION_RX, "wrong Q type");\r\nif (unlikely(ena_com_sq_empty_space(io_sq) == 0))\r\nreturn -ENOSPC;\r\ndesc = get_sq_desc(io_sq);\r\nmemset(desc, 0x0, sizeof(struct ena_eth_io_rx_desc));\r\ndesc->length = ena_buf->len;\r\ndesc->ctrl |= ENA_ETH_IO_RX_DESC_FIRST_MASK;\r\ndesc->ctrl |= ENA_ETH_IO_RX_DESC_LAST_MASK;\r\ndesc->ctrl |= io_sq->phase & ENA_ETH_IO_RX_DESC_PHASE_MASK;\r\ndesc->ctrl |= ENA_ETH_IO_RX_DESC_COMP_REQ_MASK;\r\ndesc->req_id = req_id;\r\ndesc->buff_addr_lo = (u32)ena_buf->paddr;\r\ndesc->buff_addr_hi =\r\n((ena_buf->paddr & GENMASK_ULL(io_sq->dma_addr_bits - 1, 32)) >> 32);\r\nena_com_sq_update_tail(io_sq);\r\nreturn 0;\r\n}\r\nint ena_com_tx_comp_req_id_get(struct ena_com_io_cq *io_cq, u16 *req_id)\r\n{\r\nu8 expected_phase, cdesc_phase;\r\nstruct ena_eth_io_tx_cdesc *cdesc;\r\nu16 masked_head;\r\nmasked_head = io_cq->head & (io_cq->q_depth - 1);\r\nexpected_phase = io_cq->phase;\r\ncdesc = (struct ena_eth_io_tx_cdesc *)\r\n((uintptr_t)io_cq->cdesc_addr.virt_addr +\r\n(masked_head * io_cq->cdesc_entry_size_in_bytes));\r\ncdesc_phase = READ_ONCE(cdesc->flags) & ENA_ETH_IO_TX_CDESC_PHASE_MASK;\r\nif (cdesc_phase != expected_phase)\r\nreturn -EAGAIN;\r\nena_com_cq_inc_head(io_cq);\r\n*req_id = READ_ONCE(cdesc->req_id);\r\nreturn 0;\r\n}

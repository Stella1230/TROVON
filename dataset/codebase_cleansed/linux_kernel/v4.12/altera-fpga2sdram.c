static int alt_fpga2sdram_enable_show(struct fpga_bridge *bridge)\r\n{\r\nstruct alt_fpga2sdram_data *priv = bridge->priv;\r\nint value;\r\nregmap_read(priv->sdrctl, ALT_SDR_CTL_FPGAPORTRST_OFST, &value);\r\nreturn (value & priv->mask) == priv->mask;\r\n}\r\nstatic inline int _alt_fpga2sdram_enable_set(struct alt_fpga2sdram_data *priv,\r\nbool enable)\r\n{\r\nreturn regmap_update_bits(priv->sdrctl, ALT_SDR_CTL_FPGAPORTRST_OFST,\r\npriv->mask, enable ? priv->mask : 0);\r\n}\r\nstatic int alt_fpga2sdram_enable_set(struct fpga_bridge *bridge, bool enable)\r\n{\r\nreturn _alt_fpga2sdram_enable_set(bridge->priv, enable);\r\n}\r\nstatic int alt_fpga_bridge_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct alt_fpga2sdram_data *priv;\r\nu32 enable;\r\nstruct regmap *sysmgr;\r\nint ret = 0;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->dev = dev;\r\npriv->sdrctl = syscon_regmap_lookup_by_compatible("altr,sdr-ctl");\r\nif (IS_ERR(priv->sdrctl)) {\r\ndev_err(dev, "regmap for altr,sdr-ctl lookup failed.\n");\r\nreturn PTR_ERR(priv->sdrctl);\r\n}\r\nsysmgr = syscon_regmap_lookup_by_compatible("altr,sys-mgr");\r\nif (IS_ERR(sysmgr)) {\r\ndev_err(dev, "regmap for altr,sys-mgr lookup failed.\n");\r\nreturn PTR_ERR(sysmgr);\r\n}\r\nregmap_read(sysmgr, SYSMGR_ISWGRP_HANDOFF3, &priv->mask);\r\nret = fpga_bridge_register(dev, F2S_BRIDGE_NAME,\r\n&altera_fpga2sdram_br_ops, priv);\r\nif (ret)\r\nreturn ret;\r\ndev_info(dev, "driver initialized with handoff %08x\n", priv->mask);\r\nif (!of_property_read_u32(dev->of_node, "bridge-enable", &enable)) {\r\nif (enable > 1) {\r\ndev_warn(dev, "invalid bridge-enable %u > 1\n", enable);\r\n} else {\r\ndev_info(dev, "%s bridge\n",\r\n(enable ? "enabling" : "disabling"));\r\nret = _alt_fpga2sdram_enable_set(priv, enable);\r\nif (ret) {\r\nfpga_bridge_unregister(&pdev->dev);\r\nreturn ret;\r\n}\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int alt_fpga_bridge_remove(struct platform_device *pdev)\r\n{\r\nfpga_bridge_unregister(&pdev->dev);\r\nreturn 0;\r\n}

static int zet6223_start(struct input_dev *dev)\r\n{\r\nstruct zet6223_ts *ts = input_get_drvdata(dev);\r\nenable_irq(ts->client->irq);\r\nreturn 0;\r\n}\r\nstatic void zet6223_stop(struct input_dev *dev)\r\n{\r\nstruct zet6223_ts *ts = input_get_drvdata(dev);\r\ndisable_irq(ts->client->irq);\r\n}\r\nstatic irqreturn_t zet6223_irq(int irq, void *dev_id)\r\n{\r\nstruct zet6223_ts *ts = dev_id;\r\nu16 finger_bits;\r\nu8 bufsize = 3 + 4 * ts->fingernum;\r\nu8 buf[ZET6223_MAX_PKT_SIZE];\r\nint i;\r\nint ret;\r\nint error;\r\nret = i2c_master_recv(ts->client, buf, bufsize);\r\nif (ret != bufsize) {\r\nerror = ret < 0 ? ret : -EIO;\r\ndev_err_ratelimited(&ts->client->dev,\r\n"Error reading input data: %d\n", error);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (buf[0] != ZET6223_VALID_PACKET)\r\nreturn IRQ_HANDLED;\r\nfinger_bits = get_unaligned_be16(buf + 1);\r\nfor (i = 0; i < ts->fingernum; i++) {\r\nif (!(finger_bits & BIT(15 - i)))\r\ncontinue;\r\ninput_mt_slot(ts->input, i);\r\ninput_mt_report_slot_state(ts->input, MT_TOOL_FINGER, true);\r\ninput_event(ts->input, EV_ABS, ABS_MT_POSITION_X,\r\n((buf[i + 3] >> 4) << 8) + buf[i + 4]);\r\ninput_event(ts->input, EV_ABS, ABS_MT_POSITION_Y,\r\n((buf[i + 3] & 0xF) << 8) + buf[i + 5]);\r\n}\r\ninput_mt_sync_frame(ts->input);\r\ninput_sync(ts->input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void zet6223_power_off(void *_ts)\r\n{\r\nstruct zet6223_ts *ts = _ts;\r\nregulator_bulk_disable(ARRAY_SIZE(ts->supplies), ts->supplies);\r\n}\r\nstatic int zet6223_power_on(struct zet6223_ts *ts)\r\n{\r\nstruct device *dev = &ts->client->dev;\r\nint error;\r\nts->supplies[0].supply = "vio";\r\nts->supplies[1].supply = "vcc";\r\nerror = devm_regulator_bulk_get(dev, ARRAY_SIZE(ts->supplies),\r\nts->supplies);\r\nif (error)\r\nreturn error;\r\nerror = regulator_bulk_enable(ARRAY_SIZE(ts->supplies), ts->supplies);\r\nif (error)\r\nreturn error;\r\nmsleep(ZET6223_POWER_ON_DELAY_MSEC);\r\nerror = devm_add_action_or_reset(dev, zet6223_power_off, ts);\r\nif (error) {\r\ndev_err(dev, "failed to install poweroff action: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int zet6223_query_device(struct zet6223_ts *ts)\r\n{\r\nu8 buf[ZET6223_CMD_INFO_LENGTH];\r\nu8 cmd = ZET6223_CMD_INFO;\r\nint ret;\r\nint error;\r\nret = i2c_master_send(ts->client, &cmd, sizeof(cmd));\r\nif (ret != sizeof(cmd)) {\r\nerror = ret < 0 ? ret : -EIO;\r\ndev_err(&ts->client->dev,\r\n"touchpanel info cmd failed: %d\n", error);\r\nreturn error;\r\n}\r\nret = i2c_master_recv(ts->client, buf, sizeof(buf));\r\nif (ret != sizeof(buf)) {\r\nerror = ret < 0 ? ret : -EIO;\r\ndev_err(&ts->client->dev,\r\n"failed to retrieve touchpanel info: %d\n", error);\r\nreturn error;\r\n}\r\nts->fingernum = buf[15] & 0x7F;\r\nif (ts->fingernum > ZET6223_MAX_FINGERS) {\r\ndev_warn(&ts->client->dev,\r\n"touchpanel reports %d fingers, limiting to %d\n",\r\nts->fingernum, ZET6223_MAX_FINGERS);\r\nts->fingernum = ZET6223_MAX_FINGERS;\r\n}\r\nts->max_x = get_unaligned_le16(&buf[8]);\r\nts->max_y = get_unaligned_le16(&buf[10]);\r\nreturn 0;\r\n}\r\nstatic int zet6223_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct zet6223_ts *ts;\r\nstruct input_dev *input;\r\nint error;\r\nif (!client->irq) {\r\ndev_err(dev, "no irq specified\n");\r\nreturn -EINVAL;\r\n}\r\nts = devm_kzalloc(dev, sizeof(*ts), GFP_KERNEL);\r\nif (!ts)\r\nreturn -ENOMEM;\r\nts->client = client;\r\nerror = zet6223_power_on(ts);\r\nif (error)\r\nreturn error;\r\nerror = zet6223_query_device(ts);\r\nif (error)\r\nreturn error;\r\nts->input = input = devm_input_allocate_device(dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ninput_set_drvdata(input, ts);\r\ninput->name = client->name;\r\ninput->id.bustype = BUS_I2C;\r\ninput->open = zet6223_start;\r\ninput->close = zet6223_stop;\r\ninput_set_abs_params(input, ABS_MT_POSITION_X, 0, ts->max_x, 0, 0);\r\ninput_set_abs_params(input, ABS_MT_POSITION_Y, 0, ts->max_y, 0, 0);\r\ntouchscreen_parse_properties(input, true, &ts->prop);\r\nerror = input_mt_init_slots(input, ts->fingernum,\r\nINPUT_MT_DIRECT | INPUT_MT_DROP_UNUSED);\r\nif (error)\r\nreturn error;\r\nerror = devm_request_threaded_irq(dev, client->irq, NULL, zet6223_irq,\r\nIRQF_ONESHOT, client->name, ts);\r\nif (error) {\r\ndev_err(dev, "failed to request irq %d: %d\n",\r\nclient->irq, error);\r\nreturn error;\r\n}\r\nzet6223_stop(input);\r\nerror = input_register_device(input);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}

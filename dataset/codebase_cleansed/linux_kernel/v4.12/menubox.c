static void do_print_item(WINDOW * win, const char *item, int line_y,\r\nint selected, int hotkey)\r\n{\r\nint j;\r\nchar *menu_item = malloc(menu_width + 1);\r\nstrncpy(menu_item, item, menu_width - item_x);\r\nmenu_item[menu_width - item_x] = '\0';\r\nj = first_alpha(menu_item, "YyNnMmHh");\r\nwattrset(win, dlg.menubox.atr);\r\nwmove(win, line_y, 0);\r\n#if OLD_NCURSES\r\n{\r\nint i;\r\nfor (i = 0; i < menu_width; i++)\r\nwaddch(win, ' ');\r\n}\r\n#else\r\nwclrtoeol(win);\r\n#endif\r\nwattrset(win, selected ? dlg.item_selected.atr : dlg.item.atr);\r\nmvwaddstr(win, line_y, item_x, menu_item);\r\nif (hotkey) {\r\nwattrset(win, selected ? dlg.tag_key_selected.atr\r\n: dlg.tag_key.atr);\r\nmvwaddch(win, line_y, item_x + j, menu_item[j]);\r\n}\r\nif (selected) {\r\nwmove(win, line_y, item_x + 1);\r\n}\r\nfree(menu_item);\r\nwrefresh(win);\r\n}\r\nstatic void print_arrows(WINDOW * win, int item_no, int scroll, int y, int x,\r\nint height)\r\n{\r\nint cur_y, cur_x;\r\ngetyx(win, cur_y, cur_x);\r\nwmove(win, y, x);\r\nif (scroll > 0) {\r\nwattrset(win, dlg.uarrow.atr);\r\nwaddch(win, ACS_UARROW);\r\nwaddstr(win, "(-)");\r\n} else {\r\nwattrset(win, dlg.menubox.atr);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\n}\r\ny = y + height + 1;\r\nwmove(win, y, x);\r\nwrefresh(win);\r\nif ((height < item_no) && (scroll + height < item_no)) {\r\nwattrset(win, dlg.darrow.atr);\r\nwaddch(win, ACS_DARROW);\r\nwaddstr(win, "(+)");\r\n} else {\r\nwattrset(win, dlg.menubox_border.atr);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\n}\r\nwmove(win, cur_y, cur_x);\r\nwrefresh(win);\r\n}\r\nstatic void print_buttons(WINDOW * win, int height, int width, int selected)\r\n{\r\nint x = width / 2 - 28;\r\nint y = height - 2;\r\nprint_button(win, gettext("Select"), y, x, selected == 0);\r\nprint_button(win, gettext(" Exit "), y, x + 12, selected == 1);\r\nprint_button(win, gettext(" Help "), y, x + 24, selected == 2);\r\nprint_button(win, gettext(" Save "), y, x + 36, selected == 3);\r\nprint_button(win, gettext(" Load "), y, x + 48, selected == 4);\r\nwmove(win, y, x + 1 + 12 * selected);\r\nwrefresh(win);\r\n}\r\nstatic void do_scroll(WINDOW *win, int *scroll, int n)\r\n{\r\nscrollok(win, TRUE);\r\nwscrl(win, n);\r\nscrollok(win, FALSE);\r\n*scroll = *scroll + n;\r\nwrefresh(win);\r\n}\r\nint dialog_menu(const char *title, const char *prompt,\r\nconst void *selected, int *s_scroll)\r\n{\r\nint i, j, x, y, box_x, box_y;\r\nint height, width, menu_height;\r\nint key = 0, button = 0, scroll = 0, choice = 0;\r\nint first_item = 0, max_choice;\r\nWINDOW *dialog, *menu;\r\ndo_resize:\r\nheight = getmaxy(stdscr);\r\nwidth = getmaxx(stdscr);\r\nif (height < MENUBOX_HEIGTH_MIN || width < MENUBOX_WIDTH_MIN)\r\nreturn -ERRDISPLAYTOOSMALL;\r\nheight -= 4;\r\nwidth -= 5;\r\nmenu_height = height - 10;\r\nmax_choice = MIN(menu_height, item_count());\r\nx = (getmaxx(stdscr) - width) / 2;\r\ny = (getmaxy(stdscr) - height) / 2;\r\ndraw_shadow(stdscr, y, x, height, width);\r\ndialog = newwin(height, width, y, x);\r\nkeypad(dialog, TRUE);\r\ndraw_box(dialog, 0, 0, height, width,\r\ndlg.dialog.atr, dlg.border.atr);\r\nwattrset(dialog, dlg.border.atr);\r\nmvwaddch(dialog, height - 3, 0, ACS_LTEE);\r\nfor (i = 0; i < width - 2; i++)\r\nwaddch(dialog, ACS_HLINE);\r\nwattrset(dialog, dlg.dialog.atr);\r\nwbkgdset(dialog, dlg.dialog.atr & A_COLOR);\r\nwaddch(dialog, ACS_RTEE);\r\nprint_title(dialog, title, width);\r\nwattrset(dialog, dlg.dialog.atr);\r\nprint_autowrap(dialog, prompt, width - 2, 1, 3);\r\nmenu_width = width - 6;\r\nbox_y = height - menu_height - 5;\r\nbox_x = (width - menu_width) / 2 - 1;\r\nmenu = subwin(dialog, menu_height, menu_width,\r\ny + box_y + 1, x + box_x + 1);\r\nkeypad(menu, TRUE);\r\ndraw_box(dialog, box_y, box_x, menu_height + 2, menu_width + 2,\r\ndlg.menubox_border.atr, dlg.menubox.atr);\r\nif (menu_width >= 80)\r\nitem_x = (menu_width - 70) / 2;\r\nelse\r\nitem_x = 4;\r\nitem_foreach()\r\nif (selected && (selected == item_data()))\r\nchoice = item_n();\r\nscroll = *s_scroll;\r\nif ((scroll <= choice) && (scroll + max_choice > choice) &&\r\n(scroll >= 0) && (scroll + max_choice <= item_count())) {\r\nfirst_item = scroll;\r\nchoice = choice - scroll;\r\n} else {\r\nscroll = 0;\r\n}\r\nif ((choice >= max_choice)) {\r\nif (choice >= item_count() - max_choice / 2)\r\nscroll = first_item = item_count() - max_choice;\r\nelse\r\nscroll = first_item = choice - max_choice / 2;\r\nchoice = choice - scroll;\r\n}\r\nfor (i = 0; i < max_choice; i++) {\r\nprint_item(first_item + i, i, i == choice);\r\n}\r\nwnoutrefresh(menu);\r\nprint_arrows(dialog, item_count(), scroll,\r\nbox_y, box_x + item_x + 1, menu_height);\r\nprint_buttons(dialog, height, width, 0);\r\nwmove(menu, choice, item_x + 1);\r\nwrefresh(menu);\r\nwhile (key != KEY_ESC) {\r\nkey = wgetch(menu);\r\nif (key < 256 && isalpha(key))\r\nkey = tolower(key);\r\nif (strchr("ynmh", key))\r\ni = max_choice;\r\nelse {\r\nfor (i = choice + 1; i < max_choice; i++) {\r\nitem_set(scroll + i);\r\nj = first_alpha(item_str(), "YyNnMmHh");\r\nif (key == tolower(item_str()[j]))\r\nbreak;\r\n}\r\nif (i == max_choice)\r\nfor (i = 0; i < max_choice; i++) {\r\nitem_set(scroll + i);\r\nj = first_alpha(item_str(), "YyNnMmHh");\r\nif (key == tolower(item_str()[j]))\r\nbreak;\r\n}\r\n}\r\nif (item_count() != 0 &&\r\n(i < max_choice ||\r\nkey == KEY_UP || key == KEY_DOWN ||\r\nkey == '-' || key == '+' ||\r\nkey == KEY_PPAGE || key == KEY_NPAGE)) {\r\nprint_item(scroll + choice, choice, FALSE);\r\nif (key == KEY_UP || key == '-') {\r\nif (choice < 2 && scroll) {\r\ndo_scroll(menu, &scroll, -1);\r\nprint_item(scroll, 0, FALSE);\r\n} else\r\nchoice = MAX(choice - 1, 0);\r\n} else if (key == KEY_DOWN || key == '+') {\r\nprint_item(scroll+choice, choice, FALSE);\r\nif ((choice > max_choice - 3) &&\r\n(scroll + max_choice < item_count())) {\r\ndo_scroll(menu, &scroll, 1);\r\nprint_item(scroll+max_choice - 1,\r\nmax_choice - 1, FALSE);\r\n} else\r\nchoice = MIN(choice + 1, max_choice - 1);\r\n} else if (key == KEY_PPAGE) {\r\nscrollok(menu, TRUE);\r\nfor (i = 0; (i < max_choice); i++) {\r\nif (scroll > 0) {\r\ndo_scroll(menu, &scroll, -1);\r\nprint_item(scroll, 0, FALSE);\r\n} else {\r\nif (choice > 0)\r\nchoice--;\r\n}\r\n}\r\n} else if (key == KEY_NPAGE) {\r\nfor (i = 0; (i < max_choice); i++) {\r\nif (scroll + max_choice < item_count()) {\r\ndo_scroll(menu, &scroll, 1);\r\nprint_item(scroll+max_choice-1,\r\nmax_choice - 1, FALSE);\r\n} else {\r\nif (choice + 1 < max_choice)\r\nchoice++;\r\n}\r\n}\r\n} else\r\nchoice = i;\r\nprint_item(scroll + choice, choice, TRUE);\r\nprint_arrows(dialog, item_count(), scroll,\r\nbox_y, box_x + item_x + 1, menu_height);\r\nwnoutrefresh(dialog);\r\nwrefresh(menu);\r\ncontinue;\r\n}\r\nswitch (key) {\r\ncase KEY_LEFT:\r\ncase TAB:\r\ncase KEY_RIGHT:\r\nbutton = ((key == KEY_LEFT ? --button : ++button) < 0)\r\n? 4 : (button > 4 ? 0 : button);\r\nprint_buttons(dialog, height, width, button);\r\nwrefresh(menu);\r\nbreak;\r\ncase ' ':\r\ncase 's':\r\ncase 'y':\r\ncase 'n':\r\ncase 'm':\r\ncase '/':\r\ncase 'h':\r\ncase '?':\r\ncase 'z':\r\ncase '\n':\r\n*s_scroll = scroll;\r\ndelwin(menu);\r\ndelwin(dialog);\r\nitem_set(scroll + choice);\r\nitem_set_selected(1);\r\nswitch (key) {\r\ncase 'h':\r\ncase '?':\r\nreturn 2;\r\ncase 's':\r\ncase 'y':\r\nreturn 5;\r\ncase 'n':\r\nreturn 6;\r\ncase 'm':\r\nreturn 7;\r\ncase ' ':\r\nreturn 8;\r\ncase '/':\r\nreturn 9;\r\ncase 'z':\r\nreturn 10;\r\ncase '\n':\r\nreturn button;\r\n}\r\nreturn 0;\r\ncase 'e':\r\ncase 'x':\r\nkey = KEY_ESC;\r\nbreak;\r\ncase KEY_ESC:\r\nkey = on_key_esc(menu);\r\nbreak;\r\ncase KEY_RESIZE:\r\non_key_resize();\r\ndelwin(menu);\r\ndelwin(dialog);\r\ngoto do_resize;\r\n}\r\n}\r\ndelwin(menu);\r\ndelwin(dialog);\r\nreturn key;\r\n}

void b43_ppr_clear(struct b43_wldev *dev, struct b43_ppr *ppr)\r\n{\r\nmemset(ppr, 0, sizeof(*ppr));\r\nBUILD_BUG_ON(sizeof(struct b43_ppr) != B43_PPR_RATES_NUM * sizeof(u8));\r\n}\r\nvoid b43_ppr_add(struct b43_wldev *dev, struct b43_ppr *ppr, int diff)\r\n{\r\nint i;\r\nu8 *rate;\r\nppr_for_each_entry(ppr, i, rate) {\r\n*rate = clamp_val(*rate + diff, 0, 127);\r\n}\r\n}\r\nvoid b43_ppr_apply_max(struct b43_wldev *dev, struct b43_ppr *ppr, u8 max)\r\n{\r\nint i;\r\nu8 *rate;\r\nppr_for_each_entry(ppr, i, rate) {\r\n*rate = min(*rate, max);\r\n}\r\n}\r\nvoid b43_ppr_apply_min(struct b43_wldev *dev, struct b43_ppr *ppr, u8 min)\r\n{\r\nint i;\r\nu8 *rate;\r\nppr_for_each_entry(ppr, i, rate) {\r\n*rate = max(*rate, min);\r\n}\r\n}\r\nu8 b43_ppr_get_max(struct b43_wldev *dev, struct b43_ppr *ppr)\r\n{\r\nu8 res = 0;\r\nint i;\r\nu8 *rate;\r\nppr_for_each_entry(ppr, i, rate) {\r\nres = max(*rate, res);\r\n}\r\nreturn res;\r\n}\r\nbool b43_ppr_load_max_from_sprom(struct b43_wldev *dev, struct b43_ppr *ppr,\r\nenum b43_band band)\r\n{\r\nstruct b43_ppr_rates *rates = &ppr->rates;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy *phy = &dev->phy;\r\nu8 maxpwr, off;\r\nu32 sprom_ofdm_po;\r\nu16 *sprom_mcs_po;\r\nu8 extra_cdd_po, extra_stbc_po;\r\nint i;\r\nswitch (band) {\r\ncase B43_BAND_2G:\r\nmaxpwr = min(sprom->core_pwr_info[0].maxpwr_2g,\r\nsprom->core_pwr_info[1].maxpwr_2g);\r\nsprom_ofdm_po = sprom->ofdm2gpo;\r\nsprom_mcs_po = sprom->mcs2gpo;\r\nextra_cdd_po = (sprom->cddpo >> 0) & 0xf;\r\nextra_stbc_po = (sprom->stbcpo >> 0) & 0xf;\r\nbreak;\r\ncase B43_BAND_5G_LO:\r\nmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5gl,\r\nsprom->core_pwr_info[1].maxpwr_5gl);\r\nsprom_ofdm_po = sprom->ofdm5glpo;\r\nsprom_mcs_po = sprom->mcs5glpo;\r\nextra_cdd_po = (sprom->cddpo >> 8) & 0xf;\r\nextra_stbc_po = (sprom->stbcpo >> 8) & 0xf;\r\nbreak;\r\ncase B43_BAND_5G_MI:\r\nmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5g,\r\nsprom->core_pwr_info[1].maxpwr_5g);\r\nsprom_ofdm_po = sprom->ofdm5gpo;\r\nsprom_mcs_po = sprom->mcs5gpo;\r\nextra_cdd_po = (sprom->cddpo >> 4) & 0xf;\r\nextra_stbc_po = (sprom->stbcpo >> 4) & 0xf;\r\nbreak;\r\ncase B43_BAND_5G_HI:\r\nmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5gh,\r\nsprom->core_pwr_info[1].maxpwr_5gh);\r\nsprom_ofdm_po = sprom->ofdm5ghpo;\r\nsprom_mcs_po = sprom->mcs5ghpo;\r\nextra_cdd_po = (sprom->cddpo >> 12) & 0xf;\r\nextra_stbc_po = (sprom->stbcpo >> 12) & 0xf;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nreturn false;\r\n}\r\nif (band == B43_BAND_2G) {\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom->cck2gpo >> (i * 4)) & 0xf) * 2;\r\nrates->cck[i] = maxpwr - off;\r\n}\r\n}\r\nfor (i = 0; i < 8; i++) {\r\noff = ((sprom_ofdm_po >> (i * 4)) & 0xf) * 2;\r\nrates->ofdm[i] = maxpwr - off;\r\n}\r\nrates->mcs_20[0] = rates->ofdm[0];\r\nrates->mcs_20[1] = rates->ofdm[2];\r\nrates->mcs_20[2] = rates->ofdm[3];\r\nrates->mcs_20[3] = rates->ofdm[4];\r\nrates->mcs_20[4] = rates->ofdm[5];\r\nrates->mcs_20[5] = rates->ofdm[6];\r\nrates->mcs_20[6] = rates->ofdm[7];\r\nrates->mcs_20[7] = rates->ofdm[7];\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[0] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_cdd[i] = maxpwr - off;\r\nif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\r\nrates->mcs_20_cdd[i] -= extra_cdd_po;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[1] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_cdd[4 + i] = maxpwr - off;\r\nif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\r\nrates->mcs_20_cdd[4 + i] -= extra_cdd_po;\r\n}\r\nrates->ofdm_20_cdd[0] = rates->mcs_20_cdd[0];\r\nrates->ofdm_20_cdd[1] = rates->mcs_20_cdd[0];\r\nrates->ofdm_20_cdd[2] = rates->mcs_20_cdd[1];\r\nrates->ofdm_20_cdd[3] = rates->mcs_20_cdd[2];\r\nrates->ofdm_20_cdd[4] = rates->mcs_20_cdd[3];\r\nrates->ofdm_20_cdd[5] = rates->mcs_20_cdd[4];\r\nrates->ofdm_20_cdd[6] = rates->mcs_20_cdd[5];\r\nrates->ofdm_20_cdd[7] = rates->mcs_20_cdd[6];\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[0] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_stbc[i] = maxpwr - off;\r\nif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\r\nrates->mcs_20_stbc[i] -= extra_stbc_po;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[1] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_stbc[4 + i] = maxpwr - off;\r\nif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\r\nrates->mcs_20_stbc[4 + i] -= extra_stbc_po;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[2] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_sdm[i] = maxpwr - off;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\noff = ((sprom_mcs_po[3] >> (i * 4)) & 0xf) * 2;\r\nrates->mcs_20_sdm[4 + i] = maxpwr - off;\r\n}\r\nreturn true;\r\n}

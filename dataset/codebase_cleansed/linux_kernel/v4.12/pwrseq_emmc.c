static void __mmc_pwrseq_emmc_reset(struct mmc_pwrseq_emmc *pwrseq)\r\n{\r\ngpiod_set_value(pwrseq->reset_gpio, 1);\r\nudelay(1);\r\ngpiod_set_value(pwrseq->reset_gpio, 0);\r\nudelay(200);\r\n}\r\nstatic void mmc_pwrseq_emmc_reset(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = to_pwrseq_emmc(host->pwrseq);\r\n__mmc_pwrseq_emmc_reset(pwrseq);\r\n}\r\nstatic int mmc_pwrseq_emmc_reset_nb(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = container_of(this,\r\nstruct mmc_pwrseq_emmc, reset_nb);\r\n__mmc_pwrseq_emmc_reset(pwrseq);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int mmc_pwrseq_emmc_probe(struct platform_device *pdev)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq;\r\nstruct device *dev = &pdev->dev;\r\npwrseq = devm_kzalloc(dev, sizeof(*pwrseq), GFP_KERNEL);\r\nif (!pwrseq)\r\nreturn -ENOMEM;\r\npwrseq->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(pwrseq->reset_gpio))\r\nreturn PTR_ERR(pwrseq->reset_gpio);\r\npwrseq->reset_nb.notifier_call = mmc_pwrseq_emmc_reset_nb;\r\npwrseq->reset_nb.priority = 255;\r\nregister_restart_handler(&pwrseq->reset_nb);\r\npwrseq->pwrseq.ops = &mmc_pwrseq_emmc_ops;\r\npwrseq->pwrseq.dev = dev;\r\npwrseq->pwrseq.owner = THIS_MODULE;\r\nplatform_set_drvdata(pdev, pwrseq);\r\nreturn mmc_pwrseq_register(&pwrseq->pwrseq);\r\n}\r\nstatic int mmc_pwrseq_emmc_remove(struct platform_device *pdev)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = platform_get_drvdata(pdev);\r\nunregister_restart_handler(&pwrseq->reset_nb);\r\nmmc_pwrseq_unregister(&pwrseq->pwrseq);\r\nreturn 0;\r\n}

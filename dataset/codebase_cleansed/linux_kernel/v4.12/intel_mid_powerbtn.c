static int mid_pbstat(struct mid_pb_ddata *ddata, int *value)\r\n{\r\nstruct input_dev *input = ddata->input;\r\nint ret;\r\nu8 pbstat;\r\nret = intel_scu_ipc_ioread8(ddata->pbstat_addr, &pbstat);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(input->dev.parent, "PB_INT status= %d\n", pbstat);\r\n*value = !(pbstat & ddata->pbstat_mask);\r\nreturn 0;\r\n}\r\nstatic int mid_irq_ack(struct mid_pb_ddata *ddata)\r\n{\r\nreturn intel_scu_ipc_update_register(ddata->mirqlvl1_addr, 0, MSIC_PWRBTNM);\r\n}\r\nstatic int mrfld_setup(struct mid_pb_ddata *ddata)\r\n{\r\nintel_scu_ipc_update_register(BCOVE_PBIRQ, 0, MSIC_PWRBTNM);\r\nintel_scu_ipc_update_register(BCOVE_PBIRQMASK, 0, MSIC_PWRBTNM);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t mid_pb_isr(int irq, void *dev_id)\r\n{\r\nstruct mid_pb_ddata *ddata = dev_id;\r\nstruct input_dev *input = ddata->input;\r\nint value = 0;\r\nint ret;\r\nret = mid_pbstat(ddata, &value);\r\nif (ret < 0) {\r\ndev_err(input->dev.parent,\r\n"Read error %d while reading MSIC_PB_STATUS\n", ret);\r\n} else {\r\ninput_event(input, EV_KEY, KEY_POWER, value);\r\ninput_sync(input);\r\n}\r\nmid_irq_ack(ddata);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mid_pb_probe(struct platform_device *pdev)\r\n{\r\nconst struct x86_cpu_id *id;\r\nstruct mid_pb_ddata *ddata;\r\nstruct input_dev *input;\r\nint irq = platform_get_irq(pdev, 0);\r\nint error;\r\nid = x86_match_cpu(mid_pb_cpu_ids);\r\nif (!id)\r\nreturn -ENODEV;\r\nif (irq < 0)\r\nreturn -EINVAL;\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ninput->name = pdev->name;\r\ninput->phys = "power-button/input0";\r\ninput->id.bustype = BUS_HOST;\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_capability(input, EV_KEY, KEY_POWER);\r\nddata = (struct mid_pb_ddata *)id->driver_data;\r\nif (!ddata)\r\nreturn -ENODATA;\r\nddata->dev = &pdev->dev;\r\nddata->irq = irq;\r\nddata->input = input;\r\nif (ddata->setup) {\r\nerror = ddata->setup(ddata);\r\nif (error)\r\nreturn error;\r\n}\r\nerror = devm_request_threaded_irq(&pdev->dev, irq, NULL, mid_pb_isr,\r\nIRQF_ONESHOT, DRIVER_NAME, ddata);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Unable to request irq %d for MID power button\n", irq);\r\nreturn error;\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Unable to register input dev, error %d\n", error);\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, ddata);\r\nerror = mid_irq_ack(ddata);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Unable to clear power button interrupt, error: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\ndevice_init_wakeup(&pdev->dev, true);\r\ndev_pm_set_wake_irq(&pdev->dev, irq);\r\nreturn 0;\r\n}\r\nstatic int mid_pb_remove(struct platform_device *pdev)\r\n{\r\ndev_pm_clear_wake_irq(&pdev->dev);\r\ndevice_init_wakeup(&pdev->dev, false);\r\nreturn 0;\r\n}

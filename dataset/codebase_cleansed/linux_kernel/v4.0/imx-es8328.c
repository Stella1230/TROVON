static int imx_es8328_dai_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct imx_es8328_data *data = container_of(rtd->card,\r\nstruct imx_es8328_data, card);\r\nint ret = 0;\r\nif (gpio_is_valid(data->jack_gpio)) {\r\nret = snd_soc_jack_new(rtd->codec, "Headphone",\r\nSND_JACK_HEADPHONE | SND_JACK_BTN_0,\r\n&headset_jack);\r\nif (ret)\r\nreturn ret;\r\nheadset_jack_gpios[0].gpio = data->jack_gpio;\r\nret = snd_soc_jack_add_gpios(&headset_jack,\r\nARRAY_SIZE(headset_jack_gpios),\r\nheadset_jack_gpios);\r\n}\r\nreturn ret;\r\n}\r\nstatic int imx_es8328_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *ssi_np = NULL, *codec_np = NULL;\r\nstruct platform_device *ssi_pdev;\r\nstruct imx_es8328_data *data;\r\nu32 int_port, ext_port;\r\nint ret;\r\nstruct device *dev = &pdev->dev;\r\nret = of_property_read_u32(np, "mux-int-port", &int_port);\r\nif (ret) {\r\ndev_err(dev, "mux-int-port missing or invalid\n");\r\ngoto fail;\r\n}\r\nif (int_port > MUX_PORT_MAX || int_port == 0) {\r\ndev_err(dev, "mux-int-port: hardware only has %d mux ports\n",\r\nMUX_PORT_MAX);\r\ngoto fail;\r\n}\r\nret = of_property_read_u32(np, "mux-ext-port", &ext_port);\r\nif (ret) {\r\ndev_err(dev, "mux-ext-port missing or invalid\n");\r\ngoto fail;\r\n}\r\nif (ext_port > MUX_PORT_MAX || ext_port == 0) {\r\ndev_err(dev, "mux-ext-port: hardware only has %d mux ports\n",\r\nMUX_PORT_MAX);\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nint_port--;\r\next_port--;\r\nret = imx_audmux_v2_configure_port(int_port,\r\nIMX_AUDMUX_V2_PTCR_SYN |\r\nIMX_AUDMUX_V2_PTCR_TFSEL(ext_port) |\r\nIMX_AUDMUX_V2_PTCR_TCSEL(ext_port) |\r\nIMX_AUDMUX_V2_PTCR_TFSDIR |\r\nIMX_AUDMUX_V2_PTCR_TCLKDIR,\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(ext_port));\r\nif (ret) {\r\ndev_err(dev, "audmux internal port setup failed\n");\r\nreturn ret;\r\n}\r\nret = imx_audmux_v2_configure_port(ext_port,\r\nIMX_AUDMUX_V2_PTCR_SYN,\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(int_port));\r\nif (ret) {\r\ndev_err(dev, "audmux external port setup failed\n");\r\nreturn ret;\r\n}\r\nssi_np = of_parse_phandle(pdev->dev.of_node, "ssi-controller", 0);\r\ncodec_np = of_parse_phandle(pdev->dev.of_node, "audio-codec", 0);\r\nif (!ssi_np || !codec_np) {\r\ndev_err(dev, "phandle missing or invalid\n");\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nssi_pdev = of_find_device_by_node(ssi_np);\r\nif (!ssi_pdev) {\r\ndev_err(dev, "failed to find SSI platform device\n");\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\ndata->dev = dev;\r\ndata->jack_gpio = of_get_named_gpio(pdev->dev.of_node, "jack-gpio", 0);\r\ndata->dai.name = "hifi";\r\ndata->dai.stream_name = "hifi";\r\ndata->dai.codec_dai_name = "es8328-hifi-analog";\r\ndata->dai.codec_of_node = codec_np;\r\ndata->dai.cpu_of_node = ssi_np;\r\ndata->dai.platform_of_node = ssi_np;\r\ndata->dai.init = &imx_es8328_dai_init;\r\ndata->dai.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM;\r\ndata->card.dev = dev;\r\ndata->card.dapm_widgets = imx_es8328_dapm_widgets;\r\ndata->card.num_dapm_widgets = ARRAY_SIZE(imx_es8328_dapm_widgets);\r\nret = snd_soc_of_parse_card_name(&data->card, "model");\r\nif (ret) {\r\ndev_err(dev, "Unable to parse card name\n");\r\ngoto fail;\r\n}\r\nret = snd_soc_of_parse_audio_routing(&data->card, "audio-routing");\r\nif (ret) {\r\ndev_err(dev, "Unable to parse routing: %d\n", ret);\r\ngoto fail;\r\n}\r\ndata->card.num_links = 1;\r\ndata->card.owner = THIS_MODULE;\r\ndata->card.dai_link = &data->dai;\r\nret = snd_soc_register_card(&data->card);\r\nif (ret) {\r\ndev_err(dev, "Unable to register: %d\n", ret);\r\ngoto fail;\r\n}\r\nplatform_set_drvdata(pdev, data);\r\nfail:\r\nof_node_put(ssi_np);\r\nof_node_put(codec_np);\r\nreturn ret;\r\n}\r\nstatic int imx_es8328_remove(struct platform_device *pdev)\r\n{\r\nstruct imx_es8328_data *data = platform_get_drvdata(pdev);\r\nsnd_soc_jack_free_gpios(&headset_jack, ARRAY_SIZE(headset_jack_gpios),\r\nheadset_jack_gpios);\r\nsnd_soc_unregister_card(&data->card);\r\nreturn 0;\r\n}

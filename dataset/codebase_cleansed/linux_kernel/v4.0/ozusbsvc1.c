static int oz_usb_submit_elt(struct oz_elt_buf *eb, struct oz_elt_info *ei,\r\nstruct oz_usb_ctx *usb_ctx, u8 strid, u8 isoc)\r\n{\r\nint ret;\r\nstruct oz_elt *elt = (struct oz_elt *)ei->data;\r\nstruct oz_app_hdr *app_hdr = (struct oz_app_hdr *)(elt+1);\r\nelt->type = OZ_ELT_APP_DATA;\r\nei->app_id = OZ_APPID_USB;\r\nei->length = elt->length + sizeof(struct oz_elt);\r\napp_hdr->app_id = OZ_APPID_USB;\r\nspin_lock_bh(&eb->lock);\r\nif (isoc == 0) {\r\napp_hdr->elt_seq_num = usb_ctx->tx_seq_num++;\r\nif (usb_ctx->tx_seq_num == 0)\r\nusb_ctx->tx_seq_num = 1;\r\n}\r\nret = oz_queue_elt_info(eb, isoc, strid, ei);\r\nif (ret)\r\noz_elt_info_free(eb, ei);\r\nspin_unlock_bh(&eb->lock);\r\nreturn ret;\r\n}\r\nint oz_usb_get_desc_req(void *hpd, u8 req_id, u8 req_type, u8 desc_type,\r\nu8 index, __le16 windex, int offset, int len)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt *elt;\r\nstruct oz_get_desc_req *body;\r\nstruct oz_elt_buf *eb = &pd->elt_buff;\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(&pd->elt_buff);\r\noz_dbg(ON, " req_type = 0x%x\n", req_type);\r\noz_dbg(ON, " desc_type = 0x%x\n", desc_type);\r\noz_dbg(ON, " index = 0x%x\n", index);\r\noz_dbg(ON, " windex = 0x%x\n", windex);\r\noz_dbg(ON, " offset = 0x%x\n", offset);\r\noz_dbg(ON, " len = 0x%x\n", len);\r\nif (len > 200)\r\nlen = 200;\r\nif (ei == NULL)\r\nreturn -1;\r\nelt = (struct oz_elt *)ei->data;\r\nelt->length = sizeof(struct oz_get_desc_req);\r\nbody = (struct oz_get_desc_req *)(elt+1);\r\nbody->type = OZ_GET_DESC_REQ;\r\nbody->req_id = req_id;\r\nput_unaligned(cpu_to_le16(offset), &body->offset);\r\nput_unaligned(cpu_to_le16(len), &body->size);\r\nbody->req_type = req_type;\r\nbody->desc_type = desc_type;\r\nbody->w_index = windex;\r\nbody->index = index;\r\nreturn oz_usb_submit_elt(eb, ei, usb_ctx, 0, 0);\r\n}\r\nstatic int oz_usb_set_config_req(void *hpd, u8 req_id, u8 index)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt *elt;\r\nstruct oz_elt_buf *eb = &pd->elt_buff;\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(&pd->elt_buff);\r\nstruct oz_set_config_req *body;\r\nif (ei == NULL)\r\nreturn -1;\r\nelt = (struct oz_elt *)ei->data;\r\nelt->length = sizeof(struct oz_set_config_req);\r\nbody = (struct oz_set_config_req *)(elt+1);\r\nbody->type = OZ_SET_CONFIG_REQ;\r\nbody->req_id = req_id;\r\nbody->index = index;\r\nreturn oz_usb_submit_elt(eb, ei, usb_ctx, 0, 0);\r\n}\r\nstatic int oz_usb_set_interface_req(void *hpd, u8 req_id, u8 index, u8 alt)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt *elt;\r\nstruct oz_elt_buf *eb = &pd->elt_buff;\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(&pd->elt_buff);\r\nstruct oz_set_interface_req *body;\r\nif (ei == NULL)\r\nreturn -1;\r\nelt = (struct oz_elt *)ei->data;\r\nelt->length = sizeof(struct oz_set_interface_req);\r\nbody = (struct oz_set_interface_req *)(elt+1);\r\nbody->type = OZ_SET_INTERFACE_REQ;\r\nbody->req_id = req_id;\r\nbody->index = index;\r\nbody->alternative = alt;\r\nreturn oz_usb_submit_elt(eb, ei, usb_ctx, 0, 0);\r\n}\r\nstatic int oz_usb_set_clear_feature_req(void *hpd, u8 req_id, u8 type,\r\nu8 recipient, u8 index, __le16 feature)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt *elt;\r\nstruct oz_elt_buf *eb = &pd->elt_buff;\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(&pd->elt_buff);\r\nstruct oz_feature_req *body;\r\nif (ei == NULL)\r\nreturn -1;\r\nelt = (struct oz_elt *)ei->data;\r\nelt->length = sizeof(struct oz_feature_req);\r\nbody = (struct oz_feature_req *)(elt+1);\r\nbody->type = type;\r\nbody->req_id = req_id;\r\nbody->recipient = recipient;\r\nbody->index = index;\r\nput_unaligned(feature, &body->feature);\r\nreturn oz_usb_submit_elt(eb, ei, usb_ctx, 0, 0);\r\n}\r\nstatic int oz_usb_vendor_class_req(void *hpd, u8 req_id, u8 req_type,\r\nu8 request, __le16 value, __le16 index, const u8 *data, int data_len)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt *elt;\r\nstruct oz_elt_buf *eb = &pd->elt_buff;\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(&pd->elt_buff);\r\nstruct oz_vendor_class_req *body;\r\nif (ei == NULL)\r\nreturn -1;\r\nelt = (struct oz_elt *)ei->data;\r\nelt->length = sizeof(struct oz_vendor_class_req) - 1 + data_len;\r\nbody = (struct oz_vendor_class_req *)(elt+1);\r\nbody->type = OZ_VENDOR_CLASS_REQ;\r\nbody->req_id = req_id;\r\nbody->req_type = req_type;\r\nbody->request = request;\r\nput_unaligned(value, &body->value);\r\nput_unaligned(index, &body->index);\r\nif (data_len)\r\nmemcpy(body->data, data, data_len);\r\nreturn oz_usb_submit_elt(eb, ei, usb_ctx, 0, 0);\r\n}\r\nint oz_usb_control_req(void *hpd, u8 req_id, struct usb_ctrlrequest *setup,\r\nconst u8 *data, int data_len)\r\n{\r\nunsigned wvalue = le16_to_cpu(setup->wValue);\r\nunsigned windex = le16_to_cpu(setup->wIndex);\r\nunsigned wlength = le16_to_cpu(setup->wLength);\r\nint rc = 0;\r\nif ((setup->bRequestType & USB_TYPE_MASK) == USB_TYPE_STANDARD) {\r\nswitch (setup->bRequest) {\r\ncase USB_REQ_GET_DESCRIPTOR:\r\nrc = oz_usb_get_desc_req(hpd, req_id,\r\nsetup->bRequestType, (u8)(wvalue>>8),\r\n(u8)wvalue, setup->wIndex, 0, wlength);\r\nbreak;\r\ncase USB_REQ_SET_CONFIGURATION:\r\nrc = oz_usb_set_config_req(hpd, req_id, (u8)wvalue);\r\nbreak;\r\ncase USB_REQ_SET_INTERFACE: {\r\nu8 if_num = (u8)windex;\r\nu8 alt = (u8)wvalue;\r\nrc = oz_usb_set_interface_req(hpd, req_id,\r\nif_num, alt);\r\n}\r\nbreak;\r\ncase USB_REQ_SET_FEATURE:\r\nrc = oz_usb_set_clear_feature_req(hpd, req_id,\r\nOZ_SET_FEATURE_REQ,\r\nsetup->bRequestType & 0xf, (u8)windex,\r\nsetup->wValue);\r\nbreak;\r\ncase USB_REQ_CLEAR_FEATURE:\r\nrc = oz_usb_set_clear_feature_req(hpd, req_id,\r\nOZ_CLEAR_FEATURE_REQ,\r\nsetup->bRequestType & 0xf,\r\n(u8)windex, setup->wValue);\r\nbreak;\r\n}\r\n} else {\r\nrc = oz_usb_vendor_class_req(hpd, req_id, setup->bRequestType,\r\nsetup->bRequest, setup->wValue, setup->wIndex,\r\ndata, data_len);\r\n}\r\nreturn rc;\r\n}\r\nint oz_usb_send_isoc(void *hpd, u8 ep_num, struct urb *urb)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nstruct oz_elt_buf *eb;\r\nint i;\r\nint hdr_size;\r\nu8 *data;\r\nstruct usb_iso_packet_descriptor *desc;\r\nif (pd->mode & OZ_F_ISOC_NO_ELTS) {\r\nfor (i = 0; i < urb->number_of_packets; i++) {\r\nu8 *data;\r\ndesc = &urb->iso_frame_desc[i];\r\ndata = ((u8 *)urb->transfer_buffer)+desc->offset;\r\noz_send_isoc_unit(pd, ep_num, data, desc->length);\r\n}\r\nreturn 0;\r\n}\r\nhdr_size = sizeof(struct oz_isoc_fixed) - 1;\r\neb = &pd->elt_buff;\r\ni = 0;\r\nwhile (i < urb->number_of_packets) {\r\nstruct oz_elt_info *ei = oz_elt_info_alloc(eb);\r\nstruct oz_elt *elt;\r\nstruct oz_isoc_fixed *body;\r\nint unit_count;\r\nint unit_size;\r\nint rem;\r\nif (ei == NULL)\r\nreturn -1;\r\nrem = MAX_ISOC_FIXED_DATA;\r\nelt = (struct oz_elt *)ei->data;\r\nbody = (struct oz_isoc_fixed *)(elt + 1);\r\nbody->type = OZ_USB_ENDPOINT_DATA;\r\nbody->endpoint = ep_num;\r\nbody->format = OZ_DATA_F_ISOC_FIXED;\r\nunit_size = urb->iso_frame_desc[i].length;\r\nbody->unit_size = (u8)unit_size;\r\ndata = ((u8 *)(elt+1)) + hdr_size;\r\nunit_count = 0;\r\nwhile (i < urb->number_of_packets) {\r\ndesc = &urb->iso_frame_desc[i];\r\nif ((unit_size == desc->length) &&\r\n(desc->length <= rem)) {\r\nmemcpy(data, ((u8 *)urb->transfer_buffer) +\r\ndesc->offset, unit_size);\r\ndata += unit_size;\r\nrem -= unit_size;\r\nunit_count++;\r\ndesc->status = 0;\r\ndesc->actual_length = desc->length;\r\ni++;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nelt->length = hdr_size + MAX_ISOC_FIXED_DATA - rem;\r\nbody->frame_number = (u8)unit_count;\r\noz_usb_submit_elt(eb, ei, usb_ctx, ep_num,\r\npd->mode & OZ_F_ISOC_ANYTIME);\r\n}\r\nreturn 0;\r\n}\r\nstatic void oz_usb_handle_ep_data(struct oz_usb_ctx *usb_ctx,\r\nstruct oz_usb_hdr *usb_hdr, int len)\r\n{\r\nstruct oz_data *data_hdr = (struct oz_data *)usb_hdr;\r\nswitch (data_hdr->format) {\r\ncase OZ_DATA_F_MULTIPLE_FIXED: {\r\nstruct oz_multiple_fixed *body =\r\n(struct oz_multiple_fixed *)data_hdr;\r\nu8 *data = body->data;\r\nint n = (len - sizeof(struct oz_multiple_fixed)+1)\r\n/ body->unit_size;\r\nwhile (n--) {\r\noz_hcd_data_ind(usb_ctx->hport, body->endpoint,\r\ndata, body->unit_size);\r\ndata += body->unit_size;\r\n}\r\n}\r\nbreak;\r\ncase OZ_DATA_F_ISOC_FIXED: {\r\nstruct oz_isoc_fixed *body =\r\n(struct oz_isoc_fixed *)data_hdr;\r\nint data_len = len-sizeof(struct oz_isoc_fixed)+1;\r\nint unit_size = body->unit_size;\r\nu8 *data = body->data;\r\nint count;\r\nint i;\r\nif (!unit_size)\r\nbreak;\r\ncount = data_len/unit_size;\r\nfor (i = 0; i < count; i++) {\r\noz_hcd_data_ind(usb_ctx->hport,\r\nbody->endpoint, data, unit_size);\r\ndata += unit_size;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\nvoid oz_usb_rx(struct oz_pd *pd, struct oz_elt *elt)\r\n{\r\nstruct oz_usb_hdr *usb_hdr = (struct oz_usb_hdr *)(elt + 1);\r\nstruct oz_usb_ctx *usb_ctx;\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB]);\r\nusb_ctx = (struct oz_usb_ctx *)pd->app_ctx[OZ_APPID_USB];\r\nif (usb_ctx)\r\noz_usb_get(usb_ctx);\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB]);\r\nif (usb_ctx == NULL)\r\nreturn;\r\nif (usb_ctx->stopped)\r\ngoto done;\r\nif (usb_hdr->elt_seq_num != 0) {\r\nif (((usb_ctx->rx_seq_num - usb_hdr->elt_seq_num) & 0x80) == 0)\r\ngoto done;\r\n}\r\nusb_ctx->rx_seq_num = usb_hdr->elt_seq_num;\r\nswitch (usb_hdr->type) {\r\ncase OZ_GET_DESC_RSP: {\r\nstruct oz_get_desc_rsp *body =\r\n(struct oz_get_desc_rsp *)usb_hdr;\r\nint data_len = elt->length -\r\nsizeof(struct oz_get_desc_rsp) + 1;\r\nu16 offs = le16_to_cpu(get_unaligned(&body->offset));\r\nu16 total_size =\r\nle16_to_cpu(get_unaligned(&body->total_size));\r\noz_dbg(ON, "USB_REQ_GET_DESCRIPTOR - cnf\n");\r\noz_hcd_get_desc_cnf(usb_ctx->hport, body->req_id,\r\nbody->rcode, body->data,\r\ndata_len, offs, total_size);\r\n}\r\nbreak;\r\ncase OZ_SET_CONFIG_RSP: {\r\nstruct oz_set_config_rsp *body =\r\n(struct oz_set_config_rsp *)usb_hdr;\r\noz_hcd_control_cnf(usb_ctx->hport, body->req_id,\r\nbody->rcode, NULL, 0);\r\n}\r\nbreak;\r\ncase OZ_SET_INTERFACE_RSP: {\r\nstruct oz_set_interface_rsp *body =\r\n(struct oz_set_interface_rsp *)usb_hdr;\r\noz_hcd_control_cnf(usb_ctx->hport,\r\nbody->req_id, body->rcode, NULL, 0);\r\n}\r\nbreak;\r\ncase OZ_VENDOR_CLASS_RSP: {\r\nstruct oz_vendor_class_rsp *body =\r\n(struct oz_vendor_class_rsp *)usb_hdr;\r\noz_hcd_control_cnf(usb_ctx->hport, body->req_id,\r\nbody->rcode, body->data, elt->length-\r\nsizeof(struct oz_vendor_class_rsp)+1);\r\n}\r\nbreak;\r\ncase OZ_USB_ENDPOINT_DATA:\r\noz_usb_handle_ep_data(usb_ctx, usb_hdr, elt->length);\r\nbreak;\r\n}\r\ndone:\r\noz_usb_put(usb_ctx);\r\n}\r\nvoid oz_usb_farewell(struct oz_pd *pd, u8 ep_num, u8 *data, u8 len)\r\n{\r\nstruct oz_usb_ctx *usb_ctx;\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB]);\r\nusb_ctx = (struct oz_usb_ctx *)pd->app_ctx[OZ_APPID_USB];\r\nif (usb_ctx)\r\noz_usb_get(usb_ctx);\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB]);\r\nif (usb_ctx == NULL)\r\nreturn;\r\nif (!usb_ctx->stopped) {\r\noz_dbg(ON, "Farewell indicated ep = 0x%x\n", ep_num);\r\noz_hcd_data_ind(usb_ctx->hport, ep_num, data, len);\r\n}\r\noz_usb_put(usb_ctx);\r\n}

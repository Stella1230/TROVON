static inline bool mfn_is_negative(unsigned int mfn)\r\n{\r\nreturn !cpu_is_mx1() && !cpu_is_mx21() && (mfn & MFN_SIGN);\r\n}\r\nstatic unsigned long clk_pllv1_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_pllv1 *pll = to_clk_pllv1(hw);\r\nlong long ll;\r\nint mfn_abs;\r\nunsigned int mfi, mfn, mfd, pd;\r\nu32 reg;\r\nunsigned long rate;\r\nreg = readl(pll->base);\r\nmfi = (reg >> 10) & 0xf;\r\nmfn = reg & 0x3ff;\r\nmfd = (reg >> 16) & 0x3ff;\r\npd = (reg >> 26) & 0xf;\r\nmfi = mfi <= 5 ? 5 : mfi;\r\nmfn_abs = mfn;\r\nif (mfn_is_negative(mfn)) {\r\nif (cpu_is_mx27())\r\nmfn_abs = mfn & MFN_MASK;\r\nelse\r\nmfn_abs = BIT(MFN_BITS) - mfn;\r\n}\r\nrate = parent_rate * 2;\r\nrate /= pd + 1;\r\nll = (unsigned long long)rate * mfn_abs;\r\ndo_div(ll, mfd + 1);\r\nif (mfn_is_negative(mfn))\r\nll = -ll;\r\nll = (rate * mfi) + ll;\r\nreturn ll;\r\n}\r\nstruct clk *imx_clk_pllv1(const char *name, const char *parent,\r\nvoid __iomem *base)\r\n{\r\nstruct clk_pllv1 *pll;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\npll = kmalloc(sizeof(*pll), GFP_KERNEL);\r\nif (!pll)\r\nreturn ERR_PTR(-ENOMEM);\r\npll->base = base;\r\ninit.name = name;\r\ninit.ops = &clk_pllv1_ops;\r\ninit.flags = 0;\r\ninit.parent_names = &parent;\r\ninit.num_parents = 1;\r\npll->hw.init = &init;\r\nclk = clk_register(NULL, &pll->hw);\r\nif (IS_ERR(clk))\r\nkfree(pll);\r\nreturn clk;\r\n}

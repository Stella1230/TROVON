int cx23885_vbi_fmt(struct file *file, void *priv,\r\nstruct v4l2_format *f)\r\n{\r\nstruct cx23885_dev *dev = video_drvdata(file);\r\nf->fmt.vbi.sampling_rate = 27000000;\r\nf->fmt.vbi.samples_per_line = VBI_LINE_LENGTH;\r\nf->fmt.vbi.sample_format = V4L2_PIX_FMT_GREY;\r\nf->fmt.vbi.offset = 0;\r\nf->fmt.vbi.flags = 0;\r\nif (dev->tvnorm & V4L2_STD_525_60) {\r\nf->fmt.vbi.start[0] = V4L2_VBI_ITU_525_F1_START + 9;\r\nf->fmt.vbi.start[1] = V4L2_VBI_ITU_525_F2_START + 9;\r\nf->fmt.vbi.count[0] = VBI_NTSC_LINE_COUNT;\r\nf->fmt.vbi.count[1] = VBI_NTSC_LINE_COUNT;\r\n} else if (dev->tvnorm & V4L2_STD_625_50) {\r\nf->fmt.vbi.start[0] = V4L2_VBI_ITU_625_F1_START + 5;\r\nf->fmt.vbi.start[1] = V4L2_VBI_ITU_625_F2_START + 5;\r\nf->fmt.vbi.count[0] = VBI_PAL_LINE_COUNT;\r\nf->fmt.vbi.count[1] = VBI_PAL_LINE_COUNT;\r\n}\r\nreturn 0;\r\n}\r\nint cx23885_vbi_irq(struct cx23885_dev *dev, u32 status)\r\n{\r\nu32 count;\r\nint handled = 0;\r\nif (status & VID_BC_MSK_VBI_RISCI1) {\r\ndprintk(1, "%s() VID_BC_MSK_VBI_RISCI1\n", __func__);\r\nspin_lock(&dev->slock);\r\ncount = cx_read(VID_A_GPCNT);\r\ncx23885_video_wakeup(dev, &dev->vbiq, count);\r\nspin_unlock(&dev->slock);\r\nhandled++;\r\n}\r\nreturn handled;\r\n}\r\nstatic int cx23885_start_vbi_dma(struct cx23885_dev *dev,\r\nstruct cx23885_dmaqueue *q,\r\nstruct cx23885_buffer *buf)\r\n{\r\ndprintk(1, "%s()\n", __func__);\r\ncx23885_sram_channel_setup(dev, &dev->sram_channels[SRAM_CH02],\r\nVBI_LINE_LENGTH, buf->risc.dma);\r\ncx_write(VID_A_GPCNT_CTL, 3);\r\ncx_write(VID_A_VBI_CTRL, 3);\r\ncx_write(VBI_A_GPCNT_CTL, 3);\r\nq->count = 0;\r\ncx23885_irq_add_enable(dev, 0x01);\r\ncx_set(VID_A_INT_MSK, 0x000022);\r\ncx_set(DEV_CNTRL2, (1<<5));\r\ncx_set(VID_A_DMA_CTL, 0x22);\r\nreturn 0;\r\n}\r\nstatic int queue_setup(struct vb2_queue *q, const struct v4l2_format *fmt,\r\nunsigned int *num_buffers, unsigned int *num_planes,\r\nunsigned int sizes[], void *alloc_ctxs[])\r\n{\r\nstruct cx23885_dev *dev = q->drv_priv;\r\nunsigned lines = VBI_PAL_LINE_COUNT;\r\nif (dev->tvnorm & V4L2_STD_525_60)\r\nlines = VBI_NTSC_LINE_COUNT;\r\n*num_planes = 1;\r\nsizes[0] = lines * VBI_LINE_LENGTH * 2;\r\nalloc_ctxs[0] = dev->alloc_ctx;\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct cx23885_dev *dev = vb->vb2_queue->drv_priv;\r\nstruct cx23885_buffer *buf = container_of(vb,\r\nstruct cx23885_buffer, vb);\r\nstruct sg_table *sgt = vb2_dma_sg_plane_desc(vb, 0);\r\nunsigned lines = VBI_PAL_LINE_COUNT;\r\nif (dev->tvnorm & V4L2_STD_525_60)\r\nlines = VBI_NTSC_LINE_COUNT;\r\nif (vb2_plane_size(vb, 0) < lines * VBI_LINE_LENGTH * 2)\r\nreturn -EINVAL;\r\nvb2_set_plane_payload(vb, 0, lines * VBI_LINE_LENGTH * 2);\r\ncx23885_risc_vbibuffer(dev->pci, &buf->risc,\r\nsgt->sgl,\r\n0, VBI_LINE_LENGTH * lines,\r\nVBI_LINE_LENGTH, 0,\r\nlines);\r\nreturn 0;\r\n}\r\nstatic void buffer_finish(struct vb2_buffer *vb)\r\n{\r\nstruct cx23885_buffer *buf = container_of(vb,\r\nstruct cx23885_buffer, vb);\r\ncx23885_free_buffer(vb->vb2_queue->drv_priv, buf);\r\n}\r\nstatic void buffer_queue(struct vb2_buffer *vb)\r\n{\r\nstruct cx23885_dev *dev = vb->vb2_queue->drv_priv;\r\nstruct cx23885_buffer *buf = container_of(vb, struct cx23885_buffer, vb);\r\nstruct cx23885_buffer *prev;\r\nstruct cx23885_dmaqueue *q = &dev->vbiq;\r\nunsigned long flags;\r\nbuf->risc.cpu[1] = cpu_to_le32(buf->risc.dma + 12);\r\nbuf->risc.jmp[0] = cpu_to_le32(RISC_JUMP | RISC_CNT_INC);\r\nbuf->risc.jmp[1] = cpu_to_le32(buf->risc.dma + 12);\r\nbuf->risc.jmp[2] = cpu_to_le32(0);\r\nif (list_empty(&q->active)) {\r\nspin_lock_irqsave(&dev->slock, flags);\r\nlist_add_tail(&buf->queue, &q->active);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\ndprintk(2, "[%p/%d] vbi_queue - first active\n",\r\nbuf, buf->vb.v4l2_buf.index);\r\n} else {\r\nbuf->risc.cpu[0] |= cpu_to_le32(RISC_IRQ1);\r\nprev = list_entry(q->active.prev, struct cx23885_buffer,\r\nqueue);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nlist_add_tail(&buf->queue, &q->active);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\nprev->risc.jmp[1] = cpu_to_le32(buf->risc.dma);\r\ndprintk(2, "[%p/%d] buffer_queue - append to active\n",\r\nbuf, buf->vb.v4l2_buf.index);\r\n}\r\n}\r\nstatic int cx23885_start_streaming(struct vb2_queue *q, unsigned int count)\r\n{\r\nstruct cx23885_dev *dev = q->drv_priv;\r\nstruct cx23885_dmaqueue *dmaq = &dev->vbiq;\r\nstruct cx23885_buffer *buf = list_entry(dmaq->active.next,\r\nstruct cx23885_buffer, queue);\r\ncx23885_start_vbi_dma(dev, dmaq, buf);\r\nreturn 0;\r\n}\r\nstatic void cx23885_stop_streaming(struct vb2_queue *q)\r\n{\r\nstruct cx23885_dev *dev = q->drv_priv;\r\nstruct cx23885_dmaqueue *dmaq = &dev->vbiq;\r\nunsigned long flags;\r\ncx_clear(VID_A_DMA_CTL, 0x22);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nwhile (!list_empty(&dmaq->active)) {\r\nstruct cx23885_buffer *buf = list_entry(dmaq->active.next,\r\nstruct cx23885_buffer, queue);\r\nlist_del(&buf->queue);\r\nvb2_buffer_done(&buf->vb, VB2_BUF_STATE_ERROR);\r\n}\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}

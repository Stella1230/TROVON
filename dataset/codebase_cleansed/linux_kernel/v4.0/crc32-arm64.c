static u32 crc32_arm64_le_hw(u32 crc, const u8 *p, unsigned int len)\r\n{\r\ns64 length = len;\r\nwhile ((length -= sizeof(u64)) >= 0) {\r\nCRC32X(crc, get_unaligned_le64(p));\r\np += sizeof(u64);\r\n}\r\nif (length & sizeof(u32)) {\r\nCRC32W(crc, get_unaligned_le32(p));\r\np += sizeof(u32);\r\n}\r\nif (length & sizeof(u16)) {\r\nCRC32H(crc, get_unaligned_le16(p));\r\np += sizeof(u16);\r\n}\r\nif (length & sizeof(u8))\r\nCRC32B(crc, *p);\r\nreturn crc;\r\n}\r\nstatic u32 crc32c_arm64_le_hw(u32 crc, const u8 *p, unsigned int len)\r\n{\r\ns64 length = len;\r\nwhile ((length -= sizeof(u64)) >= 0) {\r\nCRC32CX(crc, get_unaligned_le64(p));\r\np += sizeof(u64);\r\n}\r\nif (length & sizeof(u32)) {\r\nCRC32CW(crc, get_unaligned_le32(p));\r\np += sizeof(u32);\r\n}\r\nif (length & sizeof(u16)) {\r\nCRC32CH(crc, get_unaligned_le16(p));\r\np += sizeof(u16);\r\n}\r\nif (length & sizeof(u8))\r\nCRC32CB(crc, *p);\r\nreturn crc;\r\n}\r\nstatic int chksum_init(struct shash_desc *desc)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(desc->tfm);\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nctx->crc = mctx->key;\r\nreturn 0;\r\n}\r\nstatic int chksum_setkey(struct crypto_shash *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(tfm);\r\nif (keylen != sizeof(mctx->key)) {\r\ncrypto_shash_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);\r\nreturn -EINVAL;\r\n}\r\nmctx->key = get_unaligned_le32(key);\r\nreturn 0;\r\n}\r\nstatic int chksum_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int length)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nctx->crc = crc32_arm64_le_hw(ctx->crc, data, length);\r\nreturn 0;\r\n}\r\nstatic int chksumc_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int length)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nctx->crc = crc32c_arm64_le_hw(ctx->crc, data, length);\r\nreturn 0;\r\n}\r\nstatic int chksum_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nput_unaligned_le32(~ctx->crc, out);\r\nreturn 0;\r\n}\r\nstatic int __chksum_finup(u32 crc, const u8 *data, unsigned int len, u8 *out)\r\n{\r\nput_unaligned_le32(~crc32_arm64_le_hw(crc, data, len), out);\r\nreturn 0;\r\n}\r\nstatic int __chksumc_finup(u32 crc, const u8 *data, unsigned int len, u8 *out)\r\n{\r\nput_unaligned_le32(~crc32c_arm64_le_hw(crc, data, len), out);\r\nreturn 0;\r\n}\r\nstatic int chksum_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nreturn __chksum_finup(ctx->crc, data, len, out);\r\n}\r\nstatic int chksumc_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nstruct chksum_desc_ctx *ctx = shash_desc_ctx(desc);\r\nreturn __chksumc_finup(ctx->crc, data, len, out);\r\n}\r\nstatic int chksum_digest(struct shash_desc *desc, const u8 *data,\r\nunsigned int length, u8 *out)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(desc->tfm);\r\nreturn __chksum_finup(mctx->key, data, length, out);\r\n}\r\nstatic int chksumc_digest(struct shash_desc *desc, const u8 *data,\r\nunsigned int length, u8 *out)\r\n{\r\nstruct chksum_ctx *mctx = crypto_shash_ctx(desc->tfm);\r\nreturn __chksumc_finup(mctx->key, data, length, out);\r\n}\r\nstatic int crc32_cra_init(struct crypto_tfm *tfm)\r\n{\r\nstruct chksum_ctx *mctx = crypto_tfm_ctx(tfm);\r\nmctx->key = ~0;\r\nreturn 0;\r\n}\r\nstatic int __init crc32_mod_init(void)\r\n{\r\nint err;\r\nerr = crypto_register_shash(&crc32_alg);\r\nif (err)\r\nreturn err;\r\nerr = crypto_register_shash(&crc32c_alg);\r\nif (err) {\r\ncrypto_unregister_shash(&crc32_alg);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit crc32_mod_exit(void)\r\n{\r\ncrypto_unregister_shash(&crc32_alg);\r\ncrypto_unregister_shash(&crc32c_alg);\r\n}

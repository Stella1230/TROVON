static int pm8xxx_read_block_irq(struct pm_irq_chip *chip, unsigned int bp,\r\nunsigned int *ip)\r\n{\r\nint rc;\r\nspin_lock(&chip->pm_irq_lock);\r\nrc = regmap_write(chip->regmap, SSBI_REG_ADDR_IRQ_BLK_SEL, bp);\r\nif (rc) {\r\npr_err("Failed Selecting Block %d rc=%d\n", bp, rc);\r\ngoto bail;\r\n}\r\nrc = regmap_read(chip->regmap, SSBI_REG_ADDR_IRQ_IT_STATUS, ip);\r\nif (rc)\r\npr_err("Failed Reading Status rc=%d\n", rc);\r\nbail:\r\nspin_unlock(&chip->pm_irq_lock);\r\nreturn rc;\r\n}\r\nstatic int\r\npm8xxx_config_irq(struct pm_irq_chip *chip, unsigned int bp, unsigned int cp)\r\n{\r\nint rc;\r\nspin_lock(&chip->pm_irq_lock);\r\nrc = regmap_write(chip->regmap, SSBI_REG_ADDR_IRQ_BLK_SEL, bp);\r\nif (rc) {\r\npr_err("Failed Selecting Block %d rc=%d\n", bp, rc);\r\ngoto bail;\r\n}\r\ncp |= PM_IRQF_WRITE;\r\nrc = regmap_write(chip->regmap, SSBI_REG_ADDR_IRQ_CONFIG, cp);\r\nif (rc)\r\npr_err("Failed Configuring IRQ rc=%d\n", rc);\r\nbail:\r\nspin_unlock(&chip->pm_irq_lock);\r\nreturn rc;\r\n}\r\nstatic int pm8xxx_irq_block_handler(struct pm_irq_chip *chip, int block)\r\n{\r\nint pmirq, irq, i, ret = 0;\r\nunsigned int bits;\r\nret = pm8xxx_read_block_irq(chip, block, &bits);\r\nif (ret) {\r\npr_err("Failed reading %d block ret=%d", block, ret);\r\nreturn ret;\r\n}\r\nif (!bits) {\r\npr_err("block bit set in master but no irqs: %d", block);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nif (bits & (1 << i)) {\r\npmirq = block * 8 + i;\r\nirq = irq_find_mapping(chip->irqdomain, pmirq);\r\ngeneric_handle_irq(irq);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_irq_master_handler(struct pm_irq_chip *chip, int master)\r\n{\r\nunsigned int blockbits;\r\nint block_number, i, ret = 0;\r\nret = regmap_read(chip->regmap, SSBI_REG_ADDR_IRQ_M_STATUS1 + master,\r\n&blockbits);\r\nif (ret) {\r\npr_err("Failed to read master %d ret=%d\n", master, ret);\r\nreturn ret;\r\n}\r\nif (!blockbits) {\r\npr_err("master bit set in root but no blocks: %d", master);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < 8; i++)\r\nif (blockbits & (1 << i)) {\r\nblock_number = master * 8 + i;\r\nret |= pm8xxx_irq_block_handler(chip, block_number);\r\n}\r\nreturn ret;\r\n}\r\nstatic void pm8xxx_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct pm_irq_chip *chip = irq_desc_get_handler_data(desc);\r\nstruct irq_chip *irq_chip = irq_desc_get_chip(desc);\r\nunsigned int root;\r\nint i, ret, masters = 0;\r\nchained_irq_enter(irq_chip, desc);\r\nret = regmap_read(chip->regmap, SSBI_REG_ADDR_IRQ_ROOT, &root);\r\nif (ret) {\r\npr_err("Can't read root status ret=%d\n", ret);\r\nreturn;\r\n}\r\nmasters = root >> 1;\r\nfor (i = 0; i < chip->num_masters; i++)\r\nif (masters & (1 << i))\r\npm8xxx_irq_master_handler(chip, i);\r\nchained_irq_exit(irq_chip, desc);\r\n}\r\nstatic void pm8xxx_irq_mask_ack(struct irq_data *d)\r\n{\r\nstruct pm_irq_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned int pmirq = irqd_to_hwirq(d);\r\nu8 block, config;\r\nblock = pmirq / 8;\r\nconfig = chip->config[pmirq] | PM_IRQF_MASK_ALL | PM_IRQF_CLR;\r\npm8xxx_config_irq(chip, block, config);\r\n}\r\nstatic void pm8xxx_irq_unmask(struct irq_data *d)\r\n{\r\nstruct pm_irq_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned int pmirq = irqd_to_hwirq(d);\r\nu8 block, config;\r\nblock = pmirq / 8;\r\nconfig = chip->config[pmirq];\r\npm8xxx_config_irq(chip, block, config);\r\n}\r\nstatic int pm8xxx_irq_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nstruct pm_irq_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned int pmirq = irqd_to_hwirq(d);\r\nint irq_bit;\r\nu8 block, config;\r\nblock = pmirq / 8;\r\nirq_bit = pmirq % 8;\r\nchip->config[pmirq] = (irq_bit << PM_IRQF_BITS_SHIFT)\r\n| PM_IRQF_MASK_ALL;\r\nif (flow_type & (IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING)) {\r\nif (flow_type & IRQF_TRIGGER_RISING)\r\nchip->config[pmirq] &= ~PM_IRQF_MASK_RE;\r\nif (flow_type & IRQF_TRIGGER_FALLING)\r\nchip->config[pmirq] &= ~PM_IRQF_MASK_FE;\r\n} else {\r\nchip->config[pmirq] |= PM_IRQF_LVL_SEL;\r\nif (flow_type & IRQF_TRIGGER_HIGH)\r\nchip->config[pmirq] &= ~PM_IRQF_MASK_RE;\r\nelse\r\nchip->config[pmirq] &= ~PM_IRQF_MASK_FE;\r\n}\r\nconfig = chip->config[pmirq] | PM_IRQF_CLR;\r\nreturn pm8xxx_config_irq(chip, block, config);\r\n}\r\nstatic int pm8xxx_irq_domain_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hwirq)\r\n{\r\nstruct pm_irq_chip *chip = d->host_data;\r\nirq_set_chip_and_handler(irq, &pm8xxx_irq_chip, handle_level_irq);\r\nirq_set_chip_data(irq, chip);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(irq);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int pm8921_probe(struct platform_device *pdev)\r\n{\r\nstruct regmap *regmap;\r\nint irq, rc;\r\nunsigned int val;\r\nu32 rev;\r\nstruct pm_irq_chip *chip;\r\nunsigned int nirqs = PM8921_NR_IRQS;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\nregmap = devm_regmap_init(&pdev->dev, NULL, pdev->dev.parent,\r\n&ssbi_regmap_config);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nrc = regmap_read(regmap, REG_HWREV, &val);\r\nif (rc) {\r\npr_err("Failed to read hw rev reg %d:rc=%d\n", REG_HWREV, rc);\r\nreturn rc;\r\n}\r\npr_info("PMIC revision 1: %02X\n", val);\r\nrev = val;\r\nrc = regmap_read(regmap, REG_HWREV_2, &val);\r\nif (rc) {\r\npr_err("Failed to read hw rev 2 reg %d:rc=%d\n",\r\nREG_HWREV_2, rc);\r\nreturn rc;\r\n}\r\npr_info("PMIC revision 2: %02X\n", val);\r\nrev |= val << BITS_PER_BYTE;\r\nchip = devm_kzalloc(&pdev->dev, sizeof(*chip) +\r\nsizeof(chip->config[0]) * nirqs,\r\nGFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, chip);\r\nchip->regmap = regmap;\r\nchip->num_irqs = nirqs;\r\nchip->num_blocks = DIV_ROUND_UP(chip->num_irqs, 8);\r\nchip->num_masters = DIV_ROUND_UP(chip->num_blocks, 8);\r\nspin_lock_init(&chip->pm_irq_lock);\r\nchip->irqdomain = irq_domain_add_linear(pdev->dev.of_node, nirqs,\r\n&pm8xxx_irq_domain_ops,\r\nchip);\r\nif (!chip->irqdomain)\r\nreturn -ENODEV;\r\nirq_set_handler_data(irq, chip);\r\nirq_set_chained_handler(irq, pm8xxx_irq_handler);\r\nirq_set_irq_wake(irq, 1);\r\nrc = of_platform_populate(pdev->dev.of_node, NULL, NULL, &pdev->dev);\r\nif (rc) {\r\nirq_set_chained_handler(irq, NULL);\r\nirq_set_handler_data(irq, NULL);\r\nirq_domain_remove(chip->irqdomain);\r\n}\r\nreturn rc;\r\n}\r\nstatic int pm8921_remove_child(struct device *dev, void *unused)\r\n{\r\nplatform_device_unregister(to_platform_device(dev));\r\nreturn 0;\r\n}\r\nstatic int pm8921_remove(struct platform_device *pdev)\r\n{\r\nint irq = platform_get_irq(pdev, 0);\r\nstruct pm_irq_chip *chip = platform_get_drvdata(pdev);\r\ndevice_for_each_child(&pdev->dev, NULL, pm8921_remove_child);\r\nirq_set_chained_handler(irq, NULL);\r\nirq_set_handler_data(irq, NULL);\r\nirq_domain_remove(chip->irqdomain);\r\nreturn 0;\r\n}\r\nstatic int __init pm8921_init(void)\r\n{\r\nreturn platform_driver_register(&pm8921_driver);\r\n}\r\nstatic void __exit pm8921_exit(void)\r\n{\r\nplatform_driver_unregister(&pm8921_driver);\r\n}

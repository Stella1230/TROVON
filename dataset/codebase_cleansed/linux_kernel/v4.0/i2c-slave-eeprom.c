static int i2c_slave_eeprom_slave_cb(struct i2c_client *client,\r\nenum i2c_slave_event event, u8 *val)\r\n{\r\nstruct eeprom_data *eeprom = i2c_get_clientdata(client);\r\nswitch (event) {\r\ncase I2C_SLAVE_REQ_WRITE_END:\r\nif (eeprom->first_write) {\r\neeprom->buffer_idx = *val;\r\neeprom->first_write = false;\r\n} else {\r\nspin_lock(&eeprom->buffer_lock);\r\neeprom->buffer[eeprom->buffer_idx++] = *val;\r\nspin_unlock(&eeprom->buffer_lock);\r\n}\r\nbreak;\r\ncase I2C_SLAVE_REQ_READ_START:\r\nspin_lock(&eeprom->buffer_lock);\r\n*val = eeprom->buffer[eeprom->buffer_idx];\r\nspin_unlock(&eeprom->buffer_lock);\r\nbreak;\r\ncase I2C_SLAVE_REQ_READ_END:\r\neeprom->buffer_idx++;\r\nbreak;\r\ncase I2C_SLAVE_STOP:\r\neeprom->first_write = true;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t i2c_slave_eeprom_bin_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf, loff_t off, size_t count)\r\n{\r\nstruct eeprom_data *eeprom;\r\nunsigned long flags;\r\nif (off + count > attr->size)\r\nreturn -EFBIG;\r\neeprom = dev_get_drvdata(container_of(kobj, struct device, kobj));\r\nspin_lock_irqsave(&eeprom->buffer_lock, flags);\r\nmemcpy(buf, &eeprom->buffer[off], count);\r\nspin_unlock_irqrestore(&eeprom->buffer_lock, flags);\r\nreturn count;\r\n}\r\nstatic ssize_t i2c_slave_eeprom_bin_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf, loff_t off, size_t count)\r\n{\r\nstruct eeprom_data *eeprom;\r\nunsigned long flags;\r\nif (off + count > attr->size)\r\nreturn -EFBIG;\r\neeprom = dev_get_drvdata(container_of(kobj, struct device, kobj));\r\nspin_lock_irqsave(&eeprom->buffer_lock, flags);\r\nmemcpy(&eeprom->buffer[off], buf, count);\r\nspin_unlock_irqrestore(&eeprom->buffer_lock, flags);\r\nreturn count;\r\n}\r\nstatic int i2c_slave_eeprom_probe(struct i2c_client *client, const struct i2c_device_id *id)\r\n{\r\nstruct eeprom_data *eeprom;\r\nint ret;\r\nunsigned size = id->driver_data;\r\neeprom = devm_kzalloc(&client->dev, sizeof(struct eeprom_data) + size, GFP_KERNEL);\r\nif (!eeprom)\r\nreturn -ENOMEM;\r\neeprom->first_write = true;\r\nspin_lock_init(&eeprom->buffer_lock);\r\ni2c_set_clientdata(client, eeprom);\r\nsysfs_bin_attr_init(&eeprom->bin);\r\neeprom->bin.attr.name = "slave-eeprom";\r\neeprom->bin.attr.mode = S_IRUSR | S_IWUSR;\r\neeprom->bin.read = i2c_slave_eeprom_bin_read;\r\neeprom->bin.write = i2c_slave_eeprom_bin_write;\r\neeprom->bin.size = size;\r\nret = sysfs_create_bin_file(&client->dev.kobj, &eeprom->bin);\r\nif (ret)\r\nreturn ret;\r\nret = i2c_slave_register(client, i2c_slave_eeprom_slave_cb);\r\nif (ret) {\r\nsysfs_remove_bin_file(&client->dev.kobj, &eeprom->bin);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int i2c_slave_eeprom_remove(struct i2c_client *client)\r\n{\r\nstruct eeprom_data *eeprom = i2c_get_clientdata(client);\r\ni2c_slave_unregister(client);\r\nsysfs_remove_bin_file(&client->dev.kobj, &eeprom->bin);\r\nreturn 0;\r\n}

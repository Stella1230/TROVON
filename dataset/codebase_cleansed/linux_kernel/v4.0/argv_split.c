static int count_argc(const char *str)\r\n{\r\nint count = 0;\r\nbool was_space;\r\nfor (was_space = true; *str; str++) {\r\nif (isspace(*str)) {\r\nwas_space = true;\r\n} else if (was_space) {\r\nwas_space = false;\r\ncount++;\r\n}\r\n}\r\nreturn count;\r\n}\r\nvoid argv_free(char **argv)\r\n{\r\nargv--;\r\nkfree(argv[0]);\r\nkfree(argv);\r\n}\r\nchar **argv_split(gfp_t gfp, const char *str, int *argcp)\r\n{\r\nchar *argv_str;\r\nbool was_space;\r\nchar **argv, **argv_ret;\r\nint argc;\r\nargv_str = kstrndup(str, KMALLOC_MAX_SIZE - 1, gfp);\r\nif (!argv_str)\r\nreturn NULL;\r\nargc = count_argc(argv_str);\r\nargv = kmalloc(sizeof(*argv) * (argc + 2), gfp);\r\nif (!argv) {\r\nkfree(argv_str);\r\nreturn NULL;\r\n}\r\n*argv = argv_str;\r\nargv_ret = ++argv;\r\nfor (was_space = true; *argv_str; argv_str++) {\r\nif (isspace(*argv_str)) {\r\nwas_space = true;\r\n*argv_str = 0;\r\n} else if (was_space) {\r\nwas_space = false;\r\n*argv++ = argv_str;\r\n}\r\n}\r\n*argv = NULL;\r\nif (argcp)\r\n*argcp = argc;\r\nreturn argv_ret;\r\n}

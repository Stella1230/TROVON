static inline u32 dra7xx_pcie_readl(struct dra7xx_pcie *pcie, u32 offset)\r\n{\r\nreturn readl(pcie->base + offset);\r\n}\r\nstatic inline void dra7xx_pcie_writel(struct dra7xx_pcie *pcie, u32 offset,\r\nu32 value)\r\n{\r\nwritel(value, pcie->base + offset);\r\n}\r\nstatic int dra7xx_pcie_link_up(struct pcie_port *pp)\r\n{\r\nstruct dra7xx_pcie *dra7xx = to_dra7xx_pcie(pp);\r\nu32 reg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_PHY_CS);\r\nreturn !!(reg & LINK_UP);\r\n}\r\nstatic int dra7xx_pcie_establish_link(struct pcie_port *pp)\r\n{\r\nu32 reg;\r\nunsigned int retries = 1000;\r\nstruct dra7xx_pcie *dra7xx = to_dra7xx_pcie(pp);\r\nif (dw_pcie_link_up(pp)) {\r\ndev_err(pp->dev, "link is already up\n");\r\nreturn 0;\r\n}\r\nreg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_DEVICE_CMD);\r\nreg |= LTSSM_EN;\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_DEVICE_CMD, reg);\r\nwhile (retries--) {\r\nreg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_PHY_CS);\r\nif (reg & LINK_UP)\r\nbreak;\r\nusleep_range(10, 20);\r\n}\r\nif (retries == 0) {\r\ndev_err(pp->dev, "link is not up\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void dra7xx_pcie_enable_interrupts(struct pcie_port *pp)\r\n{\r\nstruct dra7xx_pcie *dra7xx = to_dra7xx_pcie(pp);\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MAIN,\r\n~INTERRUPTS);\r\ndra7xx_pcie_writel(dra7xx,\r\nPCIECTRL_DRA7XX_CONF_IRQENABLE_SET_MAIN, INTERRUPTS);\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MSI,\r\n~LEG_EP_INTERRUPTS & ~MSI);\r\nif (IS_ENABLED(CONFIG_PCI_MSI))\r\ndra7xx_pcie_writel(dra7xx,\r\nPCIECTRL_DRA7XX_CONF_IRQENABLE_SET_MSI, MSI);\r\nelse\r\ndra7xx_pcie_writel(dra7xx,\r\nPCIECTRL_DRA7XX_CONF_IRQENABLE_SET_MSI,\r\nLEG_EP_INTERRUPTS);\r\n}\r\nstatic void dra7xx_pcie_host_init(struct pcie_port *pp)\r\n{\r\ndw_pcie_setup_rc(pp);\r\ndra7xx_pcie_establish_link(pp);\r\nif (IS_ENABLED(CONFIG_PCI_MSI))\r\ndw_pcie_msi_init(pp);\r\ndra7xx_pcie_enable_interrupts(pp);\r\n}\r\nstatic int dra7xx_pcie_intx_map(struct irq_domain *domain, unsigned int irq,\r\nirq_hw_number_t hwirq)\r\n{\r\nirq_set_chip_and_handler(irq, &dummy_irq_chip, handle_simple_irq);\r\nirq_set_chip_data(irq, domain->host_data);\r\nset_irq_flags(irq, IRQF_VALID);\r\nreturn 0;\r\n}\r\nstatic int dra7xx_pcie_init_irq_domain(struct pcie_port *pp)\r\n{\r\nstruct device *dev = pp->dev;\r\nstruct device_node *node = dev->of_node;\r\nstruct device_node *pcie_intc_node = of_get_next_child(node, NULL);\r\nif (!pcie_intc_node) {\r\ndev_err(dev, "No PCIe Intc node found\n");\r\nreturn PTR_ERR(pcie_intc_node);\r\n}\r\npp->irq_domain = irq_domain_add_linear(pcie_intc_node, 4,\r\n&intx_domain_ops, pp);\r\nif (!pp->irq_domain) {\r\ndev_err(dev, "Failed to get a INTx IRQ domain\n");\r\nreturn PTR_ERR(pp->irq_domain);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t dra7xx_pcie_msi_irq_handler(int irq, void *arg)\r\n{\r\nstruct pcie_port *pp = arg;\r\nstruct dra7xx_pcie *dra7xx = to_dra7xx_pcie(pp);\r\nu32 reg;\r\nreg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MSI);\r\nswitch (reg) {\r\ncase MSI:\r\ndw_handle_msi_irq(pp);\r\nbreak;\r\ncase INTA:\r\ncase INTB:\r\ncase INTC:\r\ncase INTD:\r\ngeneric_handle_irq(irq_find_mapping(pp->irq_domain, ffs(reg)));\r\nbreak;\r\n}\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MSI, reg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t dra7xx_pcie_irq_handler(int irq, void *arg)\r\n{\r\nstruct dra7xx_pcie *dra7xx = arg;\r\nu32 reg;\r\nreg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MAIN);\r\nif (reg & ERR_SYS)\r\ndev_dbg(dra7xx->dev, "System Error\n");\r\nif (reg & ERR_FATAL)\r\ndev_dbg(dra7xx->dev, "Fatal Error\n");\r\nif (reg & ERR_NONFATAL)\r\ndev_dbg(dra7xx->dev, "Non Fatal Error\n");\r\nif (reg & ERR_COR)\r\ndev_dbg(dra7xx->dev, "Correctable Error\n");\r\nif (reg & ERR_AXI)\r\ndev_dbg(dra7xx->dev, "AXI tag lookup fatal Error\n");\r\nif (reg & ERR_ECRC)\r\ndev_dbg(dra7xx->dev, "ECRC Error\n");\r\nif (reg & PME_TURN_OFF)\r\ndev_dbg(dra7xx->dev,\r\n"Power Management Event Turn-Off message received\n");\r\nif (reg & PME_TO_ACK)\r\ndev_dbg(dra7xx->dev,\r\n"Power Management Turn-Off Ack message received\n");\r\nif (reg & PM_PME)\r\ndev_dbg(dra7xx->dev,\r\n"PM Power Management Event message received\n");\r\nif (reg & LINK_REQ_RST)\r\ndev_dbg(dra7xx->dev, "Link Request Reset\n");\r\nif (reg & LINK_UP_EVT)\r\ndev_dbg(dra7xx->dev, "Link-up state change\n");\r\nif (reg & CFG_BME_EVT)\r\ndev_dbg(dra7xx->dev, "CFG 'Bus Master Enable' change\n");\r\nif (reg & CFG_MSE_EVT)\r\ndev_dbg(dra7xx->dev, "CFG 'Memory Space Enable' change\n");\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_IRQSTATUS_MAIN, reg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init dra7xx_add_pcie_port(struct dra7xx_pcie *dra7xx,\r\nstruct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct pcie_port *pp;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\npp = &dra7xx->pp;\r\npp->dev = dev;\r\npp->ops = &dra7xx_pcie_host_ops;\r\npp->irq = platform_get_irq(pdev, 1);\r\nif (pp->irq < 0) {\r\ndev_err(dev, "missing IRQ resource\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_request_irq(&pdev->dev, pp->irq,\r\ndra7xx_pcie_msi_irq_handler, IRQF_SHARED,\r\n"dra7-pcie-msi", pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request irq\n");\r\nreturn ret;\r\n}\r\nif (!IS_ENABLED(CONFIG_PCI_MSI)) {\r\nret = dra7xx_pcie_init_irq_domain(pp);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "rc_dbics");\r\npp->dbi_base = devm_ioremap(dev, res->start, resource_size(res));\r\nif (!pp->dbi_base)\r\nreturn -ENOMEM;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(dra7xx->dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init dra7xx_pcie_probe(struct platform_device *pdev)\r\n{\r\nu32 reg;\r\nint ret;\r\nint irq;\r\nint i;\r\nint phy_count;\r\nstruct phy **phy;\r\nvoid __iomem *base;\r\nstruct resource *res;\r\nstruct dra7xx_pcie *dra7xx;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nchar name[10];\r\ndra7xx = devm_kzalloc(dev, sizeof(*dra7xx), GFP_KERNEL);\r\nif (!dra7xx)\r\nreturn -ENOMEM;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "missing IRQ resource\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_request_irq(dev, irq, dra7xx_pcie_irq_handler,\r\nIRQF_SHARED, "dra7xx-pcie-main", dra7xx);\r\nif (ret) {\r\ndev_err(dev, "failed to request irq\n");\r\nreturn ret;\r\n}\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "ti_conf");\r\nbase = devm_ioremap_nocache(dev, res->start, resource_size(res));\r\nif (!base)\r\nreturn -ENOMEM;\r\nphy_count = of_property_count_strings(np, "phy-names");\r\nif (phy_count < 0) {\r\ndev_err(dev, "unable to find the strings\n");\r\nreturn phy_count;\r\n}\r\nphy = devm_kzalloc(dev, sizeof(*phy) * phy_count, GFP_KERNEL);\r\nif (!phy)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < phy_count; i++) {\r\nsnprintf(name, sizeof(name), "pcie-phy%d", i);\r\nphy[i] = devm_phy_get(dev, name);\r\nif (IS_ERR(phy[i]))\r\nreturn PTR_ERR(phy[i]);\r\nret = phy_init(phy[i]);\r\nif (ret < 0)\r\ngoto err_phy;\r\nret = phy_power_on(phy[i]);\r\nif (ret < 0) {\r\nphy_exit(phy[i]);\r\ngoto err_phy;\r\n}\r\n}\r\ndra7xx->base = base;\r\ndra7xx->phy = phy;\r\ndra7xx->dev = dev;\r\ndra7xx->phy_count = phy_count;\r\npm_runtime_enable(dev);\r\nret = pm_runtime_get_sync(dev);\r\nif (IS_ERR_VALUE(ret)) {\r\ndev_err(dev, "pm_runtime_get_sync failed\n");\r\ngoto err_phy;\r\n}\r\nreg = dra7xx_pcie_readl(dra7xx, PCIECTRL_DRA7XX_CONF_DEVICE_CMD);\r\nreg &= ~LTSSM_EN;\r\ndra7xx_pcie_writel(dra7xx, PCIECTRL_DRA7XX_CONF_DEVICE_CMD, reg);\r\nplatform_set_drvdata(pdev, dra7xx);\r\nret = dra7xx_add_pcie_port(dra7xx, pdev);\r\nif (ret < 0)\r\ngoto err_add_port;\r\nreturn 0;\r\nerr_add_port:\r\npm_runtime_put(dev);\r\npm_runtime_disable(dev);\r\nerr_phy:\r\nwhile (--i >= 0) {\r\nphy_power_off(phy[i]);\r\nphy_exit(phy[i]);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __exit dra7xx_pcie_remove(struct platform_device *pdev)\r\n{\r\nstruct dra7xx_pcie *dra7xx = platform_get_drvdata(pdev);\r\nstruct pcie_port *pp = &dra7xx->pp;\r\nstruct device *dev = &pdev->dev;\r\nint count = dra7xx->phy_count;\r\nif (pp->irq_domain)\r\nirq_domain_remove(pp->irq_domain);\r\npm_runtime_put(dev);\r\npm_runtime_disable(dev);\r\nwhile (count--) {\r\nphy_power_off(dra7xx->phy[count]);\r\nphy_exit(dra7xx->phy[count]);\r\n}\r\nreturn 0;\r\n}

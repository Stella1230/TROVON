static inline int dt_type(struct p9_wstat *mistat)\r\n{\r\nunsigned long perm = mistat->mode;\r\nint rettype = DT_REG;\r\nif (perm & P9_DMDIR)\r\nrettype = DT_DIR;\r\nif (perm & P9_DMSYMLINK)\r\nrettype = DT_LNK;\r\nreturn rettype;\r\n}\r\nstatic void p9stat_init(struct p9_wstat *stbuf)\r\n{\r\nstbuf->name = NULL;\r\nstbuf->uid = NULL;\r\nstbuf->gid = NULL;\r\nstbuf->muid = NULL;\r\nstbuf->extension = NULL;\r\n}\r\nstatic struct p9_rdir *v9fs_alloc_rdir_buf(struct file *filp, int buflen)\r\n{\r\nstruct p9_fid *fid = filp->private_data;\r\nif (!fid->rdir)\r\nfid->rdir = kzalloc(sizeof(struct p9_rdir) + buflen, GFP_KERNEL);\r\nreturn fid->rdir;\r\n}\r\nstatic int v9fs_dir_readdir(struct file *file, struct dir_context *ctx)\r\n{\r\nbool over;\r\nstruct p9_wstat st;\r\nint err = 0;\r\nstruct p9_fid *fid;\r\nint buflen;\r\nint reclen = 0;\r\nstruct p9_rdir *rdir;\r\np9_debug(P9_DEBUG_VFS, "name %pD\n", file);\r\nfid = file->private_data;\r\nbuflen = fid->clnt->msize - P9_IOHDRSZ;\r\nrdir = v9fs_alloc_rdir_buf(file, buflen);\r\nif (!rdir)\r\nreturn -ENOMEM;\r\nwhile (1) {\r\nif (rdir->tail == rdir->head) {\r\nerr = v9fs_file_readn(file, rdir->buf, NULL,\r\nbuflen, ctx->pos);\r\nif (err <= 0)\r\nreturn err;\r\nrdir->head = 0;\r\nrdir->tail = err;\r\n}\r\nwhile (rdir->head < rdir->tail) {\r\np9stat_init(&st);\r\nerr = p9stat_read(fid->clnt, rdir->buf + rdir->head,\r\nrdir->tail - rdir->head, &st);\r\nif (err) {\r\np9_debug(P9_DEBUG_VFS, "returned %d\n", err);\r\np9stat_free(&st);\r\nreturn -EIO;\r\n}\r\nreclen = st.size+2;\r\nover = !dir_emit(ctx, st.name, strlen(st.name),\r\nv9fs_qid2ino(&st.qid), dt_type(&st));\r\np9stat_free(&st);\r\nif (over)\r\nreturn 0;\r\nrdir->head += reclen;\r\nctx->pos += reclen;\r\n}\r\n}\r\n}\r\nstatic int v9fs_dir_readdir_dotl(struct file *file, struct dir_context *ctx)\r\n{\r\nint err = 0;\r\nstruct p9_fid *fid;\r\nint buflen;\r\nstruct p9_rdir *rdir;\r\nstruct p9_dirent curdirent;\r\np9_debug(P9_DEBUG_VFS, "name %pD\n", file);\r\nfid = file->private_data;\r\nbuflen = fid->clnt->msize - P9_READDIRHDRSZ;\r\nrdir = v9fs_alloc_rdir_buf(file, buflen);\r\nif (!rdir)\r\nreturn -ENOMEM;\r\nwhile (1) {\r\nif (rdir->tail == rdir->head) {\r\nerr = p9_client_readdir(fid, rdir->buf, buflen,\r\nctx->pos);\r\nif (err <= 0)\r\nreturn err;\r\nrdir->head = 0;\r\nrdir->tail = err;\r\n}\r\nwhile (rdir->head < rdir->tail) {\r\nerr = p9dirent_read(fid->clnt, rdir->buf + rdir->head,\r\nrdir->tail - rdir->head,\r\n&curdirent);\r\nif (err < 0) {\r\np9_debug(P9_DEBUG_VFS, "returned %d\n", err);\r\nreturn -EIO;\r\n}\r\nif (!dir_emit(ctx, curdirent.d_name,\r\nstrlen(curdirent.d_name),\r\nv9fs_qid2ino(&curdirent.qid),\r\ncurdirent.d_type))\r\nreturn 0;\r\nctx->pos = curdirent.d_off;\r\nrdir->head += err;\r\n}\r\n}\r\n}\r\nint v9fs_dir_release(struct inode *inode, struct file *filp)\r\n{\r\nstruct p9_fid *fid;\r\nfid = filp->private_data;\r\np9_debug(P9_DEBUG_VFS, "inode: %p filp: %p fid: %d\n",\r\ninode, filp, fid ? fid->fid : -1);\r\nif (fid)\r\np9_client_clunk(fid);\r\nreturn 0;\r\n}

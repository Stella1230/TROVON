static void exynos4210_set_clkdiv(unsigned int div_index)\r\n{\r\nunsigned int tmp;\r\ntmp = apll_freq_4210[div_index].clk_div_cpu0;\r\n__raw_writel(tmp, cpufreq->cmu_regs + EXYNOS4_CLKDIV_CPU);\r\ndo {\r\ntmp = __raw_readl(cpufreq->cmu_regs + EXYNOS4_CLKDIV_STATCPU);\r\n} while (tmp & 0x1111111);\r\ntmp = apll_freq_4210[div_index].clk_div_cpu1;\r\n__raw_writel(tmp, cpufreq->cmu_regs + EXYNOS4_CLKDIV_CPU1);\r\ndo {\r\ntmp = __raw_readl(cpufreq->cmu_regs + EXYNOS4_CLKDIV_STATCPU1);\r\n} while (tmp & 0x11);\r\n}\r\nstatic void exynos4210_set_apll(unsigned int index)\r\n{\r\nunsigned int tmp, freq = apll_freq_4210[index].freq;\r\nclk_set_parent(moutcore, mout_mpll);\r\ndo {\r\ntmp = (__raw_readl(cpufreq->cmu_regs + EXYNOS4_CLKMUX_STATCPU)\r\n>> EXYNOS4_CLKSRC_CPU_MUXCORE_SHIFT);\r\ntmp &= 0x7;\r\n} while (tmp != 0x2);\r\nclk_set_rate(mout_apll, freq * 1000);\r\nclk_set_parent(moutcore, mout_apll);\r\ndo {\r\ntmp = __raw_readl(cpufreq->cmu_regs + EXYNOS4_CLKMUX_STATCPU);\r\ntmp &= EXYNOS4_CLKMUX_STATCPU_MUXCORE_MASK;\r\n} while (tmp != (0x1 << EXYNOS4_CLKSRC_CPU_MUXCORE_SHIFT));\r\n}\r\nstatic void exynos4210_set_frequency(unsigned int old_index,\r\nunsigned int new_index)\r\n{\r\nif (old_index > new_index) {\r\nexynos4210_set_clkdiv(new_index);\r\nexynos4210_set_apll(new_index);\r\n} else if (old_index < new_index) {\r\nexynos4210_set_apll(new_index);\r\nexynos4210_set_clkdiv(new_index);\r\n}\r\n}\r\nint exynos4210_cpufreq_init(struct exynos_dvfs_info *info)\r\n{\r\nstruct device_node *np;\r\nunsigned long rate;\r\nnp = of_find_compatible_node(NULL, NULL, "samsung,exynos4210-clock");\r\nif (!np) {\r\npr_err("%s: failed to find clock controller DT node\n",\r\n__func__);\r\nreturn -ENODEV;\r\n}\r\ninfo->cmu_regs = of_iomap(np, 0);\r\nif (!info->cmu_regs) {\r\npr_err("%s: failed to map CMU registers\n", __func__);\r\nreturn -EFAULT;\r\n}\r\ncpu_clk = clk_get(NULL, "armclk");\r\nif (IS_ERR(cpu_clk))\r\nreturn PTR_ERR(cpu_clk);\r\nmoutcore = clk_get(NULL, "moutcore");\r\nif (IS_ERR(moutcore))\r\ngoto err_moutcore;\r\nmout_mpll = clk_get(NULL, "mout_mpll");\r\nif (IS_ERR(mout_mpll))\r\ngoto err_mout_mpll;\r\nrate = clk_get_rate(mout_mpll) / 1000;\r\nmout_apll = clk_get(NULL, "mout_apll");\r\nif (IS_ERR(mout_apll))\r\ngoto err_mout_apll;\r\ninfo->mpll_freq_khz = rate;\r\ninfo->pll_safe_idx = L2;\r\ninfo->cpu_clk = cpu_clk;\r\ninfo->volt_table = exynos4210_volt_table;\r\ninfo->freq_table = exynos4210_freq_table;\r\ninfo->set_freq = exynos4210_set_frequency;\r\ncpufreq = info;\r\nreturn 0;\r\nerr_mout_apll:\r\nclk_put(mout_mpll);\r\nerr_mout_mpll:\r\nclk_put(moutcore);\r\nerr_moutcore:\r\nclk_put(cpu_clk);\r\npr_debug("%s: failed initialization\n", __func__);\r\nreturn -EINVAL;\r\n}

void mic_set_shutdown_status(struct mic_device *mdev, u8 shutdown_status)\r\n{\r\ndev_dbg(mdev->sdev->parent, "Shutdown Status %s -> %s\n",\r\nmic_shutdown_status_string[mdev->shutdown_status],\r\nmic_shutdown_status_string[shutdown_status]);\r\nmdev->shutdown_status = shutdown_status;\r\n}\r\nvoid mic_set_state(struct mic_device *mdev, u8 state)\r\n{\r\ndev_dbg(mdev->sdev->parent, "State %s -> %s\n",\r\nmic_state_string[mdev->state],\r\nmic_state_string[state]);\r\nmdev->state = state;\r\nsysfs_notify_dirent(mdev->state_sysfs);\r\n}\r\nstatic ssize_t\r\nfamily_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstatic const char x100[] = "x100";\r\nstatic const char unknown[] = "Unknown";\r\nconst char *card = NULL;\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nswitch (mdev->family) {\r\ncase MIC_FAMILY_X100:\r\ncard = x100;\r\nbreak;\r\ndefault:\r\ncard = unknown;\r\nbreak;\r\n}\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", card);\r\n}\r\nstatic ssize_t\r\nstepping_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nchar *string = "??";\r\nif (!mdev)\r\nreturn -EINVAL;\r\nswitch (mdev->stepping) {\r\ncase MIC_A0_STEP:\r\nstring = "A0";\r\nbreak;\r\ncase MIC_B0_STEP:\r\nstring = "B0";\r\nbreak;\r\ncase MIC_B1_STEP:\r\nstring = "B1";\r\nbreak;\r\ncase MIC_C0_STEP:\r\nstring = "C0";\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", string);\r\n}\r\nstatic ssize_t\r\nstate_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev || mdev->state >= MIC_LAST)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n",\r\nmic_state_string[mdev->state]);\r\n}\r\nstatic ssize_t\r\nstate_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint rc = 0;\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nif (sysfs_streq(buf, "boot")) {\r\nrc = mic_start(mdev, buf);\r\nif (rc) {\r\ndev_err(mdev->sdev->parent,\r\n"mic_boot failed rc %d\n", rc);\r\ncount = rc;\r\n}\r\ngoto done;\r\n}\r\nif (sysfs_streq(buf, "reset")) {\r\nschedule_work(&mdev->reset_trigger_work);\r\ngoto done;\r\n}\r\nif (sysfs_streq(buf, "shutdown")) {\r\nmic_shutdown(mdev);\r\ngoto done;\r\n}\r\nif (sysfs_streq(buf, "suspend")) {\r\nmic_suspend(mdev);\r\ngoto done;\r\n}\r\ncount = -EINVAL;\r\ndone:\r\nreturn count;\r\n}\r\nstatic ssize_t shutdown_status_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev || mdev->shutdown_status >= MIC_STATUS_LAST)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n",\r\nmic_shutdown_status_string[mdev->shutdown_status]);\r\n}\r\nstatic ssize_t\r\ncmdline_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nchar *cmdline;\r\nif (!mdev)\r\nreturn -EINVAL;\r\ncmdline = mdev->cmdline;\r\nif (cmdline)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", cmdline);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\ncmdline_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nmutex_lock(&mdev->mic_mutex);\r\nkfree(mdev->cmdline);\r\nmdev->cmdline = kmalloc(count + 1, GFP_KERNEL);\r\nif (!mdev->cmdline) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(mdev->cmdline, buf, count);\r\nif (mdev->cmdline[count - 1] == '\n')\r\nmdev->cmdline[count - 1] = '\0';\r\nelse\r\nmdev->cmdline[count] = '\0';\r\nunlock:\r\nmutex_unlock(&mdev->mic_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nfirmware_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nchar *firmware;\r\nif (!mdev)\r\nreturn -EINVAL;\r\nfirmware = mdev->firmware;\r\nif (firmware)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", firmware);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nfirmware_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nmutex_lock(&mdev->mic_mutex);\r\nkfree(mdev->firmware);\r\nmdev->firmware = kmalloc(count + 1, GFP_KERNEL);\r\nif (!mdev->firmware) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(mdev->firmware, buf, count);\r\nif (mdev->firmware[count - 1] == '\n')\r\nmdev->firmware[count - 1] = '\0';\r\nelse\r\nmdev->firmware[count] = '\0';\r\nunlock:\r\nmutex_unlock(&mdev->mic_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nramdisk_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nchar *ramdisk;\r\nif (!mdev)\r\nreturn -EINVAL;\r\nramdisk = mdev->ramdisk;\r\nif (ramdisk)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", ramdisk);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nramdisk_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nmutex_lock(&mdev->mic_mutex);\r\nkfree(mdev->ramdisk);\r\nmdev->ramdisk = kmalloc(count + 1, GFP_KERNEL);\r\nif (!mdev->ramdisk) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(mdev->ramdisk, buf, count);\r\nif (mdev->ramdisk[count - 1] == '\n')\r\nmdev->ramdisk[count - 1] = '\0';\r\nelse\r\nmdev->ramdisk[count] = '\0';\r\nunlock:\r\nmutex_unlock(&mdev->mic_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nbootmode_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nchar *bootmode;\r\nif (!mdev)\r\nreturn -EINVAL;\r\nbootmode = mdev->bootmode;\r\nif (bootmode)\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", bootmode);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nbootmode_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nif (!sysfs_streq(buf, "linux") && !sysfs_streq(buf, "elf"))\r\nreturn -EINVAL;\r\nmutex_lock(&mdev->mic_mutex);\r\nkfree(mdev->bootmode);\r\nmdev->bootmode = kmalloc(count + 1, GFP_KERNEL);\r\nif (!mdev->bootmode) {\r\ncount = -ENOMEM;\r\ngoto unlock;\r\n}\r\nstrncpy(mdev->bootmode, buf, count);\r\nif (mdev->bootmode[count - 1] == '\n')\r\nmdev->bootmode[count - 1] = '\0';\r\nelse\r\nmdev->bootmode[count] = '\0';\r\nunlock:\r\nmutex_unlock(&mdev->mic_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nlog_buf_addr_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%p\n", mdev->log_buf_addr);\r\n}\r\nstatic ssize_t\r\nlog_buf_addr_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nint ret;\r\nunsigned long addr;\r\nif (!mdev)\r\nreturn -EINVAL;\r\nret = kstrtoul(buf, 16, &addr);\r\nif (ret)\r\ngoto exit;\r\nmdev->log_buf_addr = (void *)addr;\r\nret = count;\r\nexit:\r\nreturn ret;\r\n}\r\nstatic ssize_t\r\nlog_buf_len_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nif (!mdev)\r\nreturn -EINVAL;\r\nreturn scnprintf(buf, PAGE_SIZE, "%p\n", mdev->log_buf_len);\r\n}\r\nstatic ssize_t\r\nlog_buf_len_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nint ret;\r\nunsigned long addr;\r\nif (!mdev)\r\nreturn -EINVAL;\r\nret = kstrtoul(buf, 16, &addr);\r\nif (ret)\r\ngoto exit;\r\nmdev->log_buf_len = (int *)addr;\r\nret = count;\r\nexit:\r\nreturn ret;\r\n}\r\nvoid mic_sysfs_init(struct mic_device *mdev)\r\n{\r\nmdev->attr_group = mic_default_groups;\r\n}

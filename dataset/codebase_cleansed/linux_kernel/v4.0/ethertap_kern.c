static void etap_init(struct net_device *dev, void *data)\r\n{\r\nstruct uml_net_private *pri;\r\nstruct ethertap_data *epri;\r\nstruct ethertap_init *init = data;\r\npri = netdev_priv(dev);\r\nepri = (struct ethertap_data *) pri->user;\r\nepri->dev_name = init->dev_name;\r\nepri->gate_addr = init->gate_addr;\r\nepri->data_fd = -1;\r\nepri->control_fd = -1;\r\nepri->dev = dev;\r\nprintk(KERN_INFO "ethertap backend - %s", epri->dev_name);\r\nif (epri->gate_addr != NULL)\r\nprintk(KERN_CONT ", IP = %s", epri->gate_addr);\r\nprintk(KERN_CONT "\n");\r\n}\r\nstatic int etap_read(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nint len;\r\nlen = net_recvfrom(fd, skb_mac_header(skb),\r\nskb->dev->mtu + 2 + ETH_HEADER_ETHERTAP);\r\nif (len <= 0)\r\nreturn(len);\r\nskb_pull(skb, 2);\r\nlen -= 2;\r\nreturn len;\r\n}\r\nstatic int etap_write(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nskb_push(skb, 2);\r\nreturn net_send(fd, skb->data, skb->len);\r\n}\r\nint ethertap_setup(char *str, char **mac_out, void *data)\r\n{\r\nstruct ethertap_init *init = data;\r\n*init = ((struct ethertap_init)\r\n{ .dev_name = NULL,\r\n.gate_addr = NULL });\r\nif (tap_setup_common(str, "ethertap", &init->dev_name, mac_out,\r\n&init->gate_addr))\r\nreturn 0;\r\nif (init->dev_name == NULL) {\r\nprintk(KERN_ERR "ethertap_setup : Missing tap device name\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int register_ethertap(void)\r\n{\r\nregister_transport(&ethertap_transport);\r\nreturn 0;\r\n}

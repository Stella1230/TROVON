static const char *fit_type_name(unsigned char type)\r\n{\r\nstruct fit_type_map_t const *mapp;\r\nfor (mapp = fit_entry_types; mapp->type != 0xff; mapp++)\r\nif (type == mapp->type)\r\nreturn mapp->name;\r\nif ((type > FIT_ENTRY_PAL_A) && (type < FIT_ENTRY_UNUSED))\r\nreturn "OEM type";\r\nif ((type > FIT_ENTRY_PAL_B) && (type < FIT_ENTRY_PAL_A))\r\nreturn "Reserved";\r\nreturn "Unknown type";\r\n}\r\nstatic int\r\nget_fit_entry(unsigned long nasid, int index, unsigned long *fentry,\r\nchar *banner, int banlen)\r\n{\r\nreturn ia64_sn_get_fit_compt(nasid, index, fentry, banner, banlen);\r\n}\r\nstatic void dump_fit_entry(struct seq_file *m, unsigned long *fentry)\r\n{\r\nunsigned type;\r\ntype = FIT_TYPE(fentry[1]);\r\nseq_printf(m, "%02x %-25s %x.%02x %016lx %u\n",\r\ntype,\r\nfit_type_name(type),\r\nFIT_MAJOR(fentry[1]), FIT_MINOR(fentry[1]),\r\nfentry[0],\r\n(unsigned)(fentry[1] & 0xffffff) * 16);\r\n}\r\nstatic int proc_fit_show(struct seq_file *m, void *v)\r\n{\r\nunsigned long nasid = (unsigned long)m->private;\r\nunsigned long fentry[2];\r\nint index;\r\nfor (index=0;;index++) {\r\nBUG_ON(index * 60 > PAGE_SIZE);\r\nif (get_fit_entry(nasid, index, fentry, NULL, 0))\r\nbreak;\r\ndump_fit_entry(m, fentry);\r\n}\r\nreturn 0;\r\n}\r\nstatic int proc_fit_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, proc_fit_show, PDE_DATA(inode));\r\n}\r\nstatic int proc_version_show(struct seq_file *m, void *v)\r\n{\r\nunsigned long nasid = (unsigned long)m->private;\r\nunsigned long fentry[2];\r\nchar banner[128];\r\nint index;\r\nfor (index = 0; ; index++) {\r\nif (get_fit_entry(nasid, index, fentry, banner,\r\nsizeof(banner)))\r\nreturn 0;\r\nif (FIT_TYPE(fentry[1]) == FIT_ENTRY_SAL_A)\r\nbreak;\r\n}\r\nseq_printf(m, "%x.%02x\n", FIT_MAJOR(fentry[1]), FIT_MINOR(fentry[1]));\r\nif (banner[0])\r\nseq_printf(m, "%s\n", banner);\r\nreturn 0;\r\n}\r\nstatic int proc_version_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, proc_version_show, PDE_DATA(inode));\r\n}\r\nint __init prominfo_init(void)\r\n{\r\nstruct proc_dir_entry *sgi_prominfo_entry;\r\ncnodeid_t cnodeid;\r\nif (!ia64_platform_is("sn2"))\r\nreturn 0;\r\nsgi_prominfo_entry = proc_mkdir("sgi_prominfo", NULL);\r\nif (!sgi_prominfo_entry)\r\nreturn -ENOMEM;\r\nfor_each_online_node(cnodeid) {\r\nstruct proc_dir_entry *dir;\r\nunsigned long nasid;\r\nchar name[NODE_NAME_LEN];\r\nsprintf(name, "node%d", cnodeid);\r\ndir = proc_mkdir(name, sgi_prominfo_entry);\r\nif (!dir)\r\ncontinue;\r\nnasid = cnodeid_to_nasid(cnodeid);\r\nproc_create_data("fit", 0, dir,\r\n&proc_fit_fops, (void *)nasid);\r\nproc_create_data("version", 0, dir,\r\n&proc_version_fops, (void *)nasid);\r\n}\r\nreturn 0;\r\n}\r\nvoid __exit prominfo_exit(void)\r\n{\r\nremove_proc_subtree("sgi_prominfo", NULL);\r\n}

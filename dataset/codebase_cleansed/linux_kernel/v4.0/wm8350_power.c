static int wm8350_read_battery_uvolts(struct wm8350 *wm8350)\r\n{\r\nreturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_BATT, 0, 0)\r\n* WM8350_AUX_COEFF;\r\n}\r\nstatic int wm8350_read_line_uvolts(struct wm8350 *wm8350)\r\n{\r\nreturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_LINE, 0, 0)\r\n* WM8350_AUX_COEFF;\r\n}\r\nstatic int wm8350_read_usb_uvolts(struct wm8350 *wm8350)\r\n{\r\nreturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_USB, 0, 0)\r\n* WM8350_AUX_COEFF;\r\n}\r\nstatic inline int wm8350_charge_time_min(struct wm8350 *wm8350, int min)\r\n{\r\nif (!wm8350->power.rev_g_coeff)\r\nreturn (((min - 30) / 15) & 0xf) << 8;\r\nelse\r\nreturn (((min - 30) / 30) & 0xf) << 8;\r\n}\r\nstatic int wm8350_get_supplies(struct wm8350 *wm8350)\r\n{\r\nu16 sm, ov, co, chrg;\r\nint supplies = 0;\r\nsm = wm8350_reg_read(wm8350, WM8350_STATE_MACHINE_STATUS);\r\nov = wm8350_reg_read(wm8350, WM8350_MISC_OVERRIDES);\r\nco = wm8350_reg_read(wm8350, WM8350_COMPARATOR_OVERRIDES);\r\nchrg = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2);\r\nsm = (sm & WM8350_USB_SM_MASK) >> WM8350_USB_SM_SHIFT;\r\nchrg &= WM8350_CHG_ISEL_MASK;\r\nif (((sm == WM8350_USB_SM_100_SLV) ||\r\n(sm == WM8350_USB_SM_500_SLV) ||\r\n(sm == WM8350_USB_SM_STDBY_SLV))\r\n&& !(ov & WM8350_USB_LIMIT_OVRDE))\r\nsupplies = WM8350_USB_SUPPLY;\r\nelse if (((sm == WM8350_USB_SM_100_SLV) ||\r\n(sm == WM8350_USB_SM_500_SLV) ||\r\n(sm == WM8350_USB_SM_STDBY_SLV))\r\n&& (ov & WM8350_USB_LIMIT_OVRDE) && (chrg == 0))\r\nsupplies = WM8350_USB_SUPPLY | WM8350_BATT_SUPPLY;\r\nelse if (co & WM8350_WALL_FB_OVRDE)\r\nsupplies = WM8350_LINE_SUPPLY;\r\nelse\r\nsupplies = WM8350_BATT_SUPPLY;\r\nreturn supplies;\r\n}\r\nstatic int wm8350_charger_config(struct wm8350 *wm8350,\r\nstruct wm8350_charger_policy *policy)\r\n{\r\nu16 reg, eoc_mA, fast_limit_mA;\r\nif (!policy) {\r\ndev_warn(wm8350->dev,\r\n"No charger policy, charger not configured.\n");\r\nreturn -EINVAL;\r\n}\r\nif (policy->fast_limit_USB_mA > 500) {\r\ndev_err(wm8350->dev, "USB fast charge > 500mA\n");\r\nreturn -EINVAL;\r\n}\r\neoc_mA = WM8350_CHG_EOC_mA(policy->eoc_mA);\r\nwm8350_reg_unlock(wm8350);\r\nreg = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1)\r\n& WM8350_CHG_ENA_R168;\r\nwm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1,\r\nreg | eoc_mA | policy->trickle_start_mV |\r\nWM8350_CHG_TRICKLE_TEMP_CHOKE |\r\nWM8350_CHG_TRICKLE_USB_CHOKE |\r\nWM8350_CHG_FAST_USB_THROTTLE);\r\nif (wm8350_get_supplies(wm8350) & WM8350_USB_SUPPLY) {\r\nfast_limit_mA =\r\nWM8350_CHG_FAST_LIMIT_mA(policy->fast_limit_USB_mA);\r\nwm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2,\r\npolicy->charge_mV | policy->trickle_charge_USB_mA |\r\nfast_limit_mA | wm8350_charge_time_min(wm8350,\r\npolicy->charge_timeout));\r\n} else {\r\nfast_limit_mA =\r\nWM8350_CHG_FAST_LIMIT_mA(policy->fast_limit_mA);\r\nwm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2,\r\npolicy->charge_mV | policy->trickle_charge_mA |\r\nfast_limit_mA | wm8350_charge_time_min(wm8350,\r\npolicy->charge_timeout));\r\n}\r\nwm8350_reg_lock(wm8350);\r\nreturn 0;\r\n}\r\nstatic int wm8350_batt_status(struct wm8350 *wm8350)\r\n{\r\nu16 state;\r\nstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2);\r\nstate &= WM8350_CHG_STS_MASK;\r\nswitch (state) {\r\ncase WM8350_CHG_STS_OFF:\r\nreturn POWER_SUPPLY_STATUS_DISCHARGING;\r\ncase WM8350_CHG_STS_TRICKLE:\r\ncase WM8350_CHG_STS_FAST:\r\nreturn POWER_SUPPLY_STATUS_CHARGING;\r\ndefault:\r\nreturn POWER_SUPPLY_STATUS_UNKNOWN;\r\n}\r\n}\r\nstatic ssize_t charger_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct wm8350 *wm8350 = dev_get_drvdata(dev);\r\nchar *charge;\r\nint state;\r\nstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2) &\r\nWM8350_CHG_STS_MASK;\r\nswitch (state) {\r\ncase WM8350_CHG_STS_OFF:\r\ncharge = "Charger Off";\r\nbreak;\r\ncase WM8350_CHG_STS_TRICKLE:\r\ncharge = "Trickle Charging";\r\nbreak;\r\ncase WM8350_CHG_STS_FAST:\r\ncharge = "Fast Charging";\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn sprintf(buf, "%s\n", charge);\r\n}\r\nstatic irqreturn_t wm8350_charger_handler(int irq, void *data)\r\n{\r\nstruct wm8350 *wm8350 = data;\r\nstruct wm8350_power *power = &wm8350->power;\r\nstruct wm8350_charger_policy *policy = power->policy;\r\nswitch (irq - wm8350->irq_base) {\r\ncase WM8350_IRQ_CHG_BAT_FAIL:\r\ndev_err(wm8350->dev, "battery failed\n");\r\nbreak;\r\ncase WM8350_IRQ_CHG_TO:\r\ndev_err(wm8350->dev, "charger timeout\n");\r\npower_supply_changed(&power->battery);\r\nbreak;\r\ncase WM8350_IRQ_CHG_BAT_HOT:\r\ncase WM8350_IRQ_CHG_BAT_COLD:\r\ncase WM8350_IRQ_CHG_START:\r\ncase WM8350_IRQ_CHG_END:\r\npower_supply_changed(&power->battery);\r\nbreak;\r\ncase WM8350_IRQ_CHG_FAST_RDY:\r\ndev_dbg(wm8350->dev, "fast charger ready\n");\r\nwm8350_charger_config(wm8350, policy);\r\nwm8350_reg_unlock(wm8350);\r\nwm8350_set_bits(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1,\r\nWM8350_CHG_FAST);\r\nwm8350_reg_lock(wm8350);\r\nbreak;\r\ncase WM8350_IRQ_CHG_VBATT_LT_3P9:\r\ndev_warn(wm8350->dev, "battery < 3.9V\n");\r\nbreak;\r\ncase WM8350_IRQ_CHG_VBATT_LT_3P1:\r\ndev_warn(wm8350->dev, "battery < 3.1V\n");\r\nbreak;\r\ncase WM8350_IRQ_CHG_VBATT_LT_2P85:\r\ndev_warn(wm8350->dev, "battery < 2.85V\n");\r\nbreak;\r\ncase WM8350_IRQ_EXT_USB_FB:\r\ncase WM8350_IRQ_EXT_WALL_FB:\r\nwm8350_charger_config(wm8350, policy);\r\ncase WM8350_IRQ_EXT_BAT_FB:\r\npower_supply_changed(&power->battery);\r\npower_supply_changed(&power->usb);\r\npower_supply_changed(&power->ac);\r\nbreak;\r\ndefault:\r\ndev_err(wm8350->dev, "Unknown interrupt %d\n", irq);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm8350_ac_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev->parent);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = !!(wm8350_get_supplies(wm8350) &\r\nWM8350_LINE_SUPPLY);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = wm8350_read_line_uvolts(wm8350);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int wm8350_usb_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev->parent);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = !!(wm8350_get_supplies(wm8350) &\r\nWM8350_USB_SUPPLY);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = wm8350_read_usb_uvolts(wm8350);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int wm8350_bat_check_health(struct wm8350 *wm8350)\r\n{\r\nu16 reg;\r\nif (wm8350_read_battery_uvolts(wm8350) < 2850000)\r\nreturn POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nreg = wm8350_reg_read(wm8350, WM8350_CHARGER_OVERRIDES);\r\nif (reg & WM8350_CHG_BATT_HOT_OVRDE)\r\nreturn POWER_SUPPLY_HEALTH_OVERHEAT;\r\nif (reg & WM8350_CHG_BATT_COLD_OVRDE)\r\nreturn POWER_SUPPLY_HEALTH_COLD;\r\nreturn POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\nstatic int wm8350_bat_get_charge_type(struct wm8350 *wm8350)\r\n{\r\nint state;\r\nstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2) &\r\nWM8350_CHG_STS_MASK;\r\nswitch (state) {\r\ncase WM8350_CHG_STS_OFF:\r\nreturn POWER_SUPPLY_CHARGE_TYPE_NONE;\r\ncase WM8350_CHG_STS_TRICKLE:\r\nreturn POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\ncase WM8350_CHG_STS_FAST:\r\nreturn POWER_SUPPLY_CHARGE_TYPE_FAST;\r\ndefault:\r\nreturn POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\r\n}\r\n}\r\nstatic int wm8350_bat_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev->parent);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = wm8350_batt_status(wm8350);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = !!(wm8350_get_supplies(wm8350) &\r\nWM8350_BATT_SUPPLY);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = wm8350_read_battery_uvolts(wm8350);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = wm8350_bat_check_health(wm8350);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nval->intval = wm8350_bat_get_charge_type(wm8350);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void wm8350_init_charger(struct wm8350 *wm8350)\r\n{\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_HOT,\r\nwm8350_charger_handler, 0, "Battery hot", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_COLD,\r\nwm8350_charger_handler, 0, "Battery cold", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_FAIL,\r\nwm8350_charger_handler, 0, "Battery fail", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_TO,\r\nwm8350_charger_handler, 0,\r\n"Charger timeout", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_END,\r\nwm8350_charger_handler, 0,\r\n"Charge end", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_START,\r\nwm8350_charger_handler, 0,\r\n"Charge start", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_FAST_RDY,\r\nwm8350_charger_handler, 0,\r\n"Fast charge ready", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P9,\r\nwm8350_charger_handler, 0,\r\n"Battery <3.9V", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P1,\r\nwm8350_charger_handler, 0,\r\n"Battery <3.1V", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_2P85,\r\nwm8350_charger_handler, 0,\r\n"Battery <2.85V", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_EXT_USB_FB,\r\nwm8350_charger_handler, 0, "USB", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_EXT_WALL_FB,\r\nwm8350_charger_handler, 0, "Wall", wm8350);\r\nwm8350_register_irq(wm8350, WM8350_IRQ_EXT_BAT_FB,\r\nwm8350_charger_handler, 0, "Battery", wm8350);\r\n}\r\nstatic void free_charger_irq(struct wm8350 *wm8350)\r\n{\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_HOT, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_COLD, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_FAIL, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_TO, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_END, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_START, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P9, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P1, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_2P85, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_EXT_USB_FB, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_EXT_WALL_FB, wm8350);\r\nwm8350_free_irq(wm8350, WM8350_IRQ_EXT_BAT_FB, wm8350);\r\n}\r\nstatic int wm8350_power_probe(struct platform_device *pdev)\r\n{\r\nstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\r\nstruct wm8350_power *power = &wm8350->power;\r\nstruct wm8350_charger_policy *policy = power->policy;\r\nstruct power_supply *usb = &power->usb;\r\nstruct power_supply *battery = &power->battery;\r\nstruct power_supply *ac = &power->ac;\r\nint ret;\r\nac->name = "wm8350-ac";\r\nac->type = POWER_SUPPLY_TYPE_MAINS;\r\nac->properties = wm8350_ac_props;\r\nac->num_properties = ARRAY_SIZE(wm8350_ac_props);\r\nac->get_property = wm8350_ac_get_prop;\r\nret = power_supply_register(&pdev->dev, ac);\r\nif (ret)\r\nreturn ret;\r\nbattery->name = "wm8350-battery";\r\nbattery->properties = wm8350_bat_props;\r\nbattery->num_properties = ARRAY_SIZE(wm8350_bat_props);\r\nbattery->get_property = wm8350_bat_get_property;\r\nbattery->use_for_apm = 1;\r\nret = power_supply_register(&pdev->dev, battery);\r\nif (ret)\r\ngoto battery_failed;\r\nusb->name = "wm8350-usb",\r\nusb->type = POWER_SUPPLY_TYPE_USB;\r\nusb->properties = wm8350_usb_props;\r\nusb->num_properties = ARRAY_SIZE(wm8350_usb_props);\r\nusb->get_property = wm8350_usb_get_prop;\r\nret = power_supply_register(&pdev->dev, usb);\r\nif (ret)\r\ngoto usb_failed;\r\nret = device_create_file(&pdev->dev, &dev_attr_charger_state);\r\nif (ret < 0)\r\ndev_warn(wm8350->dev, "failed to add charge sysfs: %d\n", ret);\r\nret = 0;\r\nwm8350_init_charger(wm8350);\r\nif (wm8350_charger_config(wm8350, policy) == 0) {\r\nwm8350_reg_unlock(wm8350);\r\nwm8350_set_bits(wm8350, WM8350_POWER_MGMT_5, WM8350_CHG_ENA);\r\nwm8350_reg_lock(wm8350);\r\n}\r\nreturn ret;\r\nusb_failed:\r\npower_supply_unregister(battery);\r\nbattery_failed:\r\npower_supply_unregister(ac);\r\nreturn ret;\r\n}\r\nstatic int wm8350_power_remove(struct platform_device *pdev)\r\n{\r\nstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\r\nstruct wm8350_power *power = &wm8350->power;\r\nfree_charger_irq(wm8350);\r\ndevice_remove_file(&pdev->dev, &dev_attr_charger_state);\r\npower_supply_unregister(&power->battery);\r\npower_supply_unregister(&power->ac);\r\npower_supply_unregister(&power->usb);\r\nreturn 0;\r\n}

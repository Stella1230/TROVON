static int extend_netdev_table(struct net_device *dev, u32 target_idx)\r\n{\r\nstruct netprio_map *old, *new;\r\nsize_t new_sz, new_len;\r\nold = rtnl_dereference(dev->priomap);\r\nif (old && old->priomap_len > target_idx)\r\nreturn 0;\r\nnew_sz = PRIOMAP_MIN_SZ;\r\nwhile (true) {\r\nnew_len = (new_sz - offsetof(struct netprio_map, priomap)) /\r\nsizeof(new->priomap[0]);\r\nif (new_len > target_idx)\r\nbreak;\r\nnew_sz *= 2;\r\nif (WARN_ON(new_sz < PRIOMAP_MIN_SZ))\r\nreturn -ENOSPC;\r\n}\r\nnew = kzalloc(new_sz, GFP_KERNEL);\r\nif (!new)\r\nreturn -ENOMEM;\r\nif (old)\r\nmemcpy(new->priomap, old->priomap,\r\nold->priomap_len * sizeof(old->priomap[0]));\r\nnew->priomap_len = new_len;\r\nrcu_assign_pointer(dev->priomap, new);\r\nif (old)\r\nkfree_rcu(old, rcu);\r\nreturn 0;\r\n}\r\nstatic u32 netprio_prio(struct cgroup_subsys_state *css, struct net_device *dev)\r\n{\r\nstruct netprio_map *map = rcu_dereference_rtnl(dev->priomap);\r\nint id = css->cgroup->id;\r\nif (map && id < map->priomap_len)\r\nreturn map->priomap[id];\r\nreturn 0;\r\n}\r\nstatic int netprio_set_prio(struct cgroup_subsys_state *css,\r\nstruct net_device *dev, u32 prio)\r\n{\r\nstruct netprio_map *map;\r\nint id = css->cgroup->id;\r\nint ret;\r\nmap = rtnl_dereference(dev->priomap);\r\nif (!prio && (!map || map->priomap_len <= id))\r\nreturn 0;\r\nret = extend_netdev_table(dev, id);\r\nif (ret)\r\nreturn ret;\r\nmap = rtnl_dereference(dev->priomap);\r\nmap->priomap[id] = prio;\r\nreturn 0;\r\n}\r\nstatic struct cgroup_subsys_state *\r\ncgrp_css_alloc(struct cgroup_subsys_state *parent_css)\r\n{\r\nstruct cgroup_subsys_state *css;\r\ncss = kzalloc(sizeof(*css), GFP_KERNEL);\r\nif (!css)\r\nreturn ERR_PTR(-ENOMEM);\r\nreturn css;\r\n}\r\nstatic int cgrp_css_online(struct cgroup_subsys_state *css)\r\n{\r\nstruct cgroup_subsys_state *parent_css = css->parent;\r\nstruct net_device *dev;\r\nint ret = 0;\r\nif (!parent_css)\r\nreturn 0;\r\nrtnl_lock();\r\nfor_each_netdev(&init_net, dev) {\r\nu32 prio = netprio_prio(parent_css, dev);\r\nret = netprio_set_prio(css, dev, prio);\r\nif (ret)\r\nbreak;\r\n}\r\nrtnl_unlock();\r\nreturn ret;\r\n}\r\nstatic void cgrp_css_free(struct cgroup_subsys_state *css)\r\n{\r\nkfree(css);\r\n}\r\nstatic u64 read_prioidx(struct cgroup_subsys_state *css, struct cftype *cft)\r\n{\r\nreturn css->cgroup->id;\r\n}\r\nstatic int read_priomap(struct seq_file *sf, void *v)\r\n{\r\nstruct net_device *dev;\r\nrcu_read_lock();\r\nfor_each_netdev_rcu(&init_net, dev)\r\nseq_printf(sf, "%s %u\n", dev->name,\r\nnetprio_prio(seq_css(sf), dev));\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\nstatic ssize_t write_priomap(struct kernfs_open_file *of,\r\nchar *buf, size_t nbytes, loff_t off)\r\n{\r\nchar devname[IFNAMSIZ + 1];\r\nstruct net_device *dev;\r\nu32 prio;\r\nint ret;\r\nif (sscanf(buf, "%"__stringify(IFNAMSIZ)"s %u", devname, &prio) != 2)\r\nreturn -EINVAL;\r\ndev = dev_get_by_name(&init_net, devname);\r\nif (!dev)\r\nreturn -ENODEV;\r\nrtnl_lock();\r\nret = netprio_set_prio(of_css(of), dev, prio);\r\nrtnl_unlock();\r\ndev_put(dev);\r\nreturn ret ?: nbytes;\r\n}\r\nstatic int update_netprio(const void *v, struct file *file, unsigned n)\r\n{\r\nint err;\r\nstruct socket *sock = sock_from_file(file, &err);\r\nif (sock)\r\nsock->sk->sk_cgrp_prioidx = (u32)(unsigned long)v;\r\nreturn 0;\r\n}\r\nstatic void net_prio_attach(struct cgroup_subsys_state *css,\r\nstruct cgroup_taskset *tset)\r\n{\r\nstruct task_struct *p;\r\nvoid *v = (void *)(unsigned long)css->cgroup->id;\r\ncgroup_taskset_for_each(p, tset) {\r\ntask_lock(p);\r\niterate_fd(p->files, 0, update_netprio, v);\r\ntask_unlock(p);\r\n}\r\n}\r\nstatic int netprio_device_event(struct notifier_block *unused,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct netprio_map *old;\r\nswitch (event) {\r\ncase NETDEV_UNREGISTER:\r\nold = rtnl_dereference(dev->priomap);\r\nRCU_INIT_POINTER(dev->priomap, NULL);\r\nif (old)\r\nkfree_rcu(old, rcu);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init init_cgroup_netprio(void)\r\n{\r\nregister_netdevice_notifier(&netprio_device_notifier);\r\nreturn 0;\r\n}

static phandle __init olpc_dt_getsibling(phandle node)\r\n{\r\nconst void *args[] = { (void *)node };\r\nvoid *res[] = { &node };\r\nif ((s32)node == -1)\r\nreturn 0;\r\nif (olpc_ofw("peer", args, res) || (s32)node == -1)\r\nreturn 0;\r\nreturn node;\r\n}\r\nstatic phandle __init olpc_dt_getchild(phandle node)\r\n{\r\nconst void *args[] = { (void *)node };\r\nvoid *res[] = { &node };\r\nif ((s32)node == -1)\r\nreturn 0;\r\nif (olpc_ofw("child", args, res) || (s32)node == -1) {\r\npr_err("PROM: %s: fetching child failed!\n", __func__);\r\nreturn 0;\r\n}\r\nreturn node;\r\n}\r\nstatic int __init olpc_dt_getproplen(phandle node, const char *prop)\r\n{\r\nconst void *args[] = { (void *)node, prop };\r\nint len;\r\nvoid *res[] = { &len };\r\nif ((s32)node == -1)\r\nreturn -1;\r\nif (olpc_ofw("getproplen", args, res)) {\r\npr_err("PROM: %s: getproplen failed!\n", __func__);\r\nreturn -1;\r\n}\r\nreturn len;\r\n}\r\nstatic int __init olpc_dt_getproperty(phandle node, const char *prop,\r\nchar *buf, int bufsize)\r\n{\r\nint plen;\r\nplen = olpc_dt_getproplen(node, prop);\r\nif (plen > bufsize || plen < 1) {\r\nreturn -1;\r\n} else {\r\nconst void *args[] = { (void *)node, prop, buf, (void *)plen };\r\nvoid *res[] = { &plen };\r\nif (olpc_ofw("getprop", args, res)) {\r\npr_err("PROM: %s: getprop failed!\n", __func__);\r\nreturn -1;\r\n}\r\n}\r\nreturn plen;\r\n}\r\nstatic int __init olpc_dt_nextprop(phandle node, char *prev, char *buf)\r\n{\r\nconst void *args[] = { (void *)node, prev, buf };\r\nint success;\r\nvoid *res[] = { &success };\r\nbuf[0] = '\0';\r\nif ((s32)node == -1)\r\nreturn -1;\r\nif (olpc_ofw("nextprop", args, res) || success != 1)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __init olpc_dt_pkg2path(phandle node, char *buf,\r\nconst int buflen, int *len)\r\n{\r\nconst void *args[] = { (void *)node, buf, (void *)buflen };\r\nvoid *res[] = { len };\r\nif ((s32)node == -1)\r\nreturn -1;\r\nif (olpc_ofw("package-to-path", args, res) || *len < 1)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nvoid * __init prom_early_alloc(unsigned long size)\r\n{\r\nstatic u8 *mem;\r\nstatic size_t free_mem;\r\nvoid *res;\r\nif (free_mem < size) {\r\nconst size_t chunk_size = max(PAGE_SIZE, size);\r\nres = alloc_bootmem(chunk_size);\r\nBUG_ON(!res);\r\nprom_early_allocated += chunk_size;\r\nmemset(res, 0, chunk_size);\r\nfree_mem = chunk_size;\r\nmem = res;\r\n}\r\nfree_mem -= size;\r\nres = mem;\r\nmem += size;\r\nreturn res;\r\n}\r\nstatic phandle __init olpc_dt_finddevice(const char *path)\r\n{\r\nphandle node;\r\nconst void *args[] = { path };\r\nvoid *res[] = { &node };\r\nif (olpc_ofw("finddevice", args, res)) {\r\npr_err("olpc_dt: finddevice failed!\n");\r\nreturn 0;\r\n}\r\nif ((s32) node == -1)\r\nreturn 0;\r\nreturn node;\r\n}\r\nstatic int __init olpc_dt_interpret(const char *words)\r\n{\r\nint result;\r\nconst void *args[] = { words };\r\nvoid *res[] = { &result };\r\nif (olpc_ofw("interpret", args, res)) {\r\npr_err("olpc_dt: interpret failed!\n");\r\nreturn -1;\r\n}\r\nreturn result;\r\n}\r\nstatic u32 __init olpc_dt_get_board_revision(void)\r\n{\r\nphandle node;\r\n__be32 rev;\r\nint r;\r\nnode = olpc_dt_finddevice("/");\r\nif (!node)\r\nreturn 0;\r\nr = olpc_dt_getproperty(node, "board-revision-int",\r\n(char *) &rev, sizeof(rev));\r\nif (r < 0)\r\nreturn 0;\r\nreturn be32_to_cpu(rev);\r\n}\r\nvoid __init olpc_dt_fixup(void)\r\n{\r\nint r;\r\nchar buf[64];\r\nphandle node;\r\nu32 board_rev;\r\nnode = olpc_dt_finddevice("/battery@0");\r\nif (!node)\r\nreturn;\r\nr = olpc_dt_getproperty(node, "compatible", buf, sizeof(buf));\r\nif (r > 0)\r\nreturn;\r\npr_info("PROM DT: Old firmware detected, applying fixes\n");\r\nolpc_dt_interpret("\" /battery@0\" find-device"\r\n" \" olpc,xo1-battery\" +compatible"\r\n" device-end");\r\nboard_rev = olpc_dt_get_board_revision();\r\nif (!board_rev)\r\nreturn;\r\nif (board_rev >= olpc_board_pre(0xd0)) {\r\nolpc_dt_interpret("\" /pci/display@1\" find-device"\r\n" new-device"\r\n" \" dcon\" device-name \" olpc,xo1-dcon\" +compatible"\r\n" finish-device device-end");\r\n} else {\r\nolpc_dt_interpret("\" /pci/display@1,1\" find-device"\r\n" new-device"\r\n" \" dcon\" device-name \" olpc,xo1-dcon\" +compatible"\r\n" finish-device device-end"\r\n" \" /rtc\" find-device"\r\n" \" olpc,xo1-rtc\" +compatible"\r\n" device-end");\r\n}\r\n}\r\nvoid __init olpc_dt_build_devicetree(void)\r\n{\r\nphandle root;\r\nif (!olpc_ofw_is_installed())\r\nreturn;\r\nolpc_dt_fixup();\r\nroot = olpc_dt_getsibling(0);\r\nif (!root) {\r\npr_err("PROM: unable to get root node from OFW!\n");\r\nreturn;\r\n}\r\nof_pdt_build_devicetree(root, &prom_olpc_ops);\r\npr_info("PROM DT: Built device tree with %u bytes of memory.\n",\r\nprom_early_allocated);\r\n}\r\nstatic int __init olpc_create_platform_devices(void)\r\n{\r\nif (machine_is_olpc())\r\nreturn of_platform_bus_probe(NULL, of_ids, NULL);\r\nelse\r\nreturn 0;\r\n}

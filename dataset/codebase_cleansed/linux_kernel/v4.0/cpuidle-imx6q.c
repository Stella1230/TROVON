static int imx6q_enter_wait(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv, int index)\r\n{\r\nif (atomic_inc_return(&master) == num_online_cpus()) {\r\nif (!spin_trylock(&master_lock))\r\ngoto idle;\r\nimx6q_set_lpm(WAIT_UNCLOCKED);\r\ncpu_do_idle();\r\nimx6q_set_lpm(WAIT_CLOCKED);\r\nspin_unlock(&master_lock);\r\ngoto done;\r\n}\r\nidle:\r\ncpu_do_idle();\r\ndone:\r\natomic_dec(&master);\r\nreturn index;\r\n}\r\nint __init imx6q_cpuidle_init(void)\r\n{\r\nimx6q_set_int_mem_clk_lpm(true);\r\nreturn cpuidle_register(&imx6q_cpuidle_driver, NULL);\r\n}

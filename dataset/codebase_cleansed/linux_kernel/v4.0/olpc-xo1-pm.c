void olpc_xo1_pm_wakeup_set(u16 value)\r\n{\r\nwakeup_mask |= value;\r\n}\r\nvoid olpc_xo1_pm_wakeup_clear(u16 value)\r\n{\r\nwakeup_mask &= ~value;\r\n}\r\nstatic int xo1_power_state_enter(suspend_state_t pm_state)\r\n{\r\nunsigned long saved_sci_mask;\r\nif (pm_state != PM_SUSPEND_MEM)\r\nreturn -EINVAL;\r\nsaved_sci_mask = inl(acpi_base + CS5536_PM1_STS);\r\nsaved_sci_mask &= 0xffff0000;\r\ndo_olpc_suspend_lowlevel();\r\noutl(saved_sci_mask, acpi_base + CS5536_PM1_STS);\r\nreturn 0;\r\n}\r\nasmlinkage __visible int xo1_do_sleep(u8 sleep_state)\r\n{\r\nvoid *pgd_addr = __va(read_cr3());\r\noutl(wakeup_mask << 16, acpi_base + CS5536_PM1_STS);\r\n__asm__("movl %0,%%eax" : : "r" (pgd_addr));\r\n__asm__("call *(%%edi); cld"\r\n: : "D" (&ofw_bios_entry));\r\n__asm__("movb $0x34, %al\n\t"\r\n"outb %al, $0x70\n\t"\r\n"movb $0x30, %al\n\t"\r\n"outb %al, $0x71\n\t");\r\nreturn 0;\r\n}\r\nstatic void xo1_power_off(void)\r\n{\r\nprintk(KERN_INFO "OLPC XO-1 power off sequence...\n");\r\noutl(0x40000000, pms_base + CS5536_PM_SCLK);\r\noutl(0x40000000, pms_base + CS5536_PM_IN_SLPCTL);\r\noutl(0x40000000, pms_base + CS5536_PM_WKXD);\r\noutl(0x40000000, pms_base + CS5536_PM_WKD);\r\noutl(0x0002ffff, pms_base + CS5536_PM_SSC);\r\noutl(0xffffffff, acpi_base + CS5536_PM_GPE0_STS);\r\noutl(0x00002000, acpi_base + CS5536_PM1_CNT);\r\n}\r\nstatic int xo1_power_state_valid(suspend_state_t pm_state)\r\n{\r\nreturn pm_state == PM_SUSPEND_MEM;\r\n}\r\nstatic int xo1_pm_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint err;\r\nif (!machine_is_olpc())\r\nreturn -ENODEV;\r\nerr = mfd_cell_enable(pdev);\r\nif (err)\r\nreturn err;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "can't fetch device resource info\n");\r\nreturn -EIO;\r\n}\r\nif (strcmp(pdev->name, "cs5535-pms") == 0)\r\npms_base = res->start;\r\nelse if (strcmp(pdev->name, "olpc-xo1-pm-acpi") == 0)\r\nacpi_base = res->start;\r\nif (pms_base && acpi_base) {\r\nsuspend_set_ops(&xo1_suspend_ops);\r\npm_power_off = xo1_power_off;\r\nprintk(KERN_INFO "OLPC XO-1 support registered\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int xo1_pm_remove(struct platform_device *pdev)\r\n{\r\nmfd_cell_disable(pdev);\r\nif (strcmp(pdev->name, "cs5535-pms") == 0)\r\npms_base = 0;\r\nelse if (strcmp(pdev->name, "olpc-xo1-pm-acpi") == 0)\r\nacpi_base = 0;\r\npm_power_off = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init xo1_pm_init(void)\r\n{\r\nint r;\r\nr = platform_driver_register(&cs5535_pms_driver);\r\nif (r)\r\nreturn r;\r\nr = platform_driver_register(&cs5535_acpi_driver);\r\nif (r)\r\nplatform_driver_unregister(&cs5535_pms_driver);\r\nreturn r;\r\n}

static int ci_hdrc_usb2_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ci_hdrc_usb2_priv *priv;\r\nstruct ci_hdrc_platform_data *ci_pdata = dev_get_platdata(dev);\r\nint ret;\r\nif (!ci_pdata)\r\nci_pdata = &ci_default_pdata;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->clk = devm_clk_get(dev, NULL);\r\nif (!IS_ERR(priv->clk)) {\r\nret = clk_prepare_enable(priv->clk);\r\nif (ret) {\r\ndev_err(dev, "failed to enable the clock: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = dma_set_mask_and_coherent(dev, DMA_BIT_MASK(32));\r\nif (ret)\r\ngoto clk_err;\r\nci_pdata->name = dev_name(dev);\r\npriv->ci_pdev = ci_hdrc_add_device(dev, pdev->resource,\r\npdev->num_resources, ci_pdata);\r\nif (IS_ERR(priv->ci_pdev)) {\r\nret = PTR_ERR(priv->ci_pdev);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev,\r\n"failed to register ci_hdrc platform device: %d\n",\r\nret);\r\ngoto clk_err;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\npm_runtime_no_callbacks(dev);\r\npm_runtime_enable(dev);\r\nreturn 0;\r\nclk_err:\r\nif (!IS_ERR(priv->clk))\r\nclk_disable_unprepare(priv->clk);\r\nreturn ret;\r\n}\r\nstatic int ci_hdrc_usb2_remove(struct platform_device *pdev)\r\n{\r\nstruct ci_hdrc_usb2_priv *priv = platform_get_drvdata(pdev);\r\npm_runtime_disable(&pdev->dev);\r\nci_hdrc_remove_device(priv->ci_pdev);\r\nclk_disable_unprepare(priv->clk);\r\nreturn 0;\r\n}

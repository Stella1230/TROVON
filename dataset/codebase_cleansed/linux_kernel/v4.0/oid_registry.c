enum OID look_up_OID(const void *data, size_t datasize)\r\n{\r\nconst unsigned char *octets = data;\r\nenum OID oid;\r\nunsigned char xhash;\r\nunsigned i, j, k, hash;\r\nsize_t len;\r\nhash = datasize - 1;\r\nfor (i = 0; i < datasize; i++)\r\nhash += octets[i] * 33;\r\nhash = (hash >> 24) ^ (hash >> 16) ^ (hash >> 8) ^ hash;\r\nhash &= 0xff;\r\ni = 0;\r\nk = OID__NR;\r\nwhile (i < k) {\r\nj = (i + k) / 2;\r\nxhash = oid_search_table[j].hash;\r\nif (xhash > hash) {\r\nk = j;\r\ncontinue;\r\n}\r\nif (xhash < hash) {\r\ni = j + 1;\r\ncontinue;\r\n}\r\noid = oid_search_table[j].oid;\r\nlen = oid_index[oid + 1] - oid_index[oid];\r\nif (len > datasize) {\r\nk = j;\r\ncontinue;\r\n}\r\nif (len < datasize) {\r\ni = j + 1;\r\ncontinue;\r\n}\r\nwhile (len > 0) {\r\nunsigned char a = oid_data[oid_index[oid] + --len];\r\nunsigned char b = octets[len];\r\nif (a > b) {\r\nk = j;\r\ngoto next;\r\n}\r\nif (a < b) {\r\ni = j + 1;\r\ngoto next;\r\n}\r\n}\r\nreturn oid;\r\nnext:\r\n;\r\n}\r\nreturn OID__NR;\r\n}\r\nint sprint_oid(const void *data, size_t datasize, char *buffer, size_t bufsize)\r\n{\r\nconst unsigned char *v = data, *end = v + datasize;\r\nunsigned long num;\r\nunsigned char n;\r\nsize_t ret;\r\nint count;\r\nif (v >= end)\r\nreturn -EBADMSG;\r\nn = *v++;\r\nret = count = snprintf(buffer, bufsize, "%u.%u", n / 40, n % 40);\r\nbuffer += count;\r\nbufsize -= count;\r\nif (bufsize == 0)\r\nreturn -ENOBUFS;\r\nwhile (v < end) {\r\nnum = 0;\r\nn = *v++;\r\nif (!(n & 0x80)) {\r\nnum = n;\r\n} else {\r\nnum = n & 0x7f;\r\ndo {\r\nif (v >= end)\r\nreturn -EBADMSG;\r\nn = *v++;\r\nnum <<= 7;\r\nnum |= n & 0x7f;\r\n} while (n & 0x80);\r\n}\r\nret += count = snprintf(buffer, bufsize, ".%lu", num);\r\nbuffer += count;\r\nbufsize -= count;\r\nif (bufsize == 0)\r\nreturn -ENOBUFS;\r\n}\r\nreturn ret;\r\n}\r\nint sprint_OID(enum OID oid, char *buffer, size_t bufsize)\r\n{\r\nint ret;\r\nBUG_ON(oid >= OID__NR);\r\nret = sprint_oid(oid_data + oid_index[oid],\r\noid_index[oid + 1] - oid_index[oid],\r\nbuffer, bufsize);\r\nBUG_ON(ret == -EBADMSG);\r\nreturn ret;\r\n}

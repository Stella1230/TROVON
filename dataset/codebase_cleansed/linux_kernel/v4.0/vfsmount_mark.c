void fsnotify_clear_marks_by_mount(struct vfsmount *mnt)\r\n{\r\nstruct fsnotify_mark *mark;\r\nstruct hlist_node *n;\r\nstruct mount *m = real_mount(mnt);\r\nLIST_HEAD(free_list);\r\nspin_lock(&mnt->mnt_root->d_lock);\r\nhlist_for_each_entry_safe(mark, n, &m->mnt_fsnotify_marks, obj_list) {\r\nlist_add(&mark->free_list, &free_list);\r\nhlist_del_init_rcu(&mark->obj_list);\r\nfsnotify_get_mark(mark);\r\n}\r\nspin_unlock(&mnt->mnt_root->d_lock);\r\nfsnotify_destroy_marks(&free_list);\r\n}\r\nvoid fsnotify_clear_vfsmount_marks_by_group(struct fsnotify_group *group)\r\n{\r\nfsnotify_clear_marks_by_group_flags(group, FSNOTIFY_MARK_FLAG_VFSMOUNT);\r\n}\r\nvoid fsnotify_recalc_vfsmount_mask(struct vfsmount *mnt)\r\n{\r\nstruct mount *m = real_mount(mnt);\r\nspin_lock(&mnt->mnt_root->d_lock);\r\nm->mnt_fsnotify_mask = fsnotify_recalc_mask(&m->mnt_fsnotify_marks);\r\nspin_unlock(&mnt->mnt_root->d_lock);\r\n}\r\nvoid fsnotify_destroy_vfsmount_mark(struct fsnotify_mark *mark)\r\n{\r\nstruct vfsmount *mnt = mark->mnt;\r\nstruct mount *m = real_mount(mnt);\r\nBUG_ON(!mutex_is_locked(&mark->group->mark_mutex));\r\nassert_spin_locked(&mark->lock);\r\nspin_lock(&mnt->mnt_root->d_lock);\r\nhlist_del_init_rcu(&mark->obj_list);\r\nmark->mnt = NULL;\r\nm->mnt_fsnotify_mask = fsnotify_recalc_mask(&m->mnt_fsnotify_marks);\r\nspin_unlock(&mnt->mnt_root->d_lock);\r\n}\r\nstruct fsnotify_mark *fsnotify_find_vfsmount_mark(struct fsnotify_group *group,\r\nstruct vfsmount *mnt)\r\n{\r\nstruct mount *m = real_mount(mnt);\r\nstruct fsnotify_mark *mark;\r\nspin_lock(&mnt->mnt_root->d_lock);\r\nmark = fsnotify_find_mark(&m->mnt_fsnotify_marks, group);\r\nspin_unlock(&mnt->mnt_root->d_lock);\r\nreturn mark;\r\n}\r\nint fsnotify_add_vfsmount_mark(struct fsnotify_mark *mark,\r\nstruct fsnotify_group *group, struct vfsmount *mnt,\r\nint allow_dups)\r\n{\r\nstruct mount *m = real_mount(mnt);\r\nint ret;\r\nmark->flags |= FSNOTIFY_MARK_FLAG_VFSMOUNT;\r\nBUG_ON(!mutex_is_locked(&group->mark_mutex));\r\nassert_spin_locked(&mark->lock);\r\nspin_lock(&mnt->mnt_root->d_lock);\r\nmark->mnt = mnt;\r\nret = fsnotify_add_mark_list(&m->mnt_fsnotify_marks, mark, allow_dups);\r\nm->mnt_fsnotify_mask = fsnotify_recalc_mask(&m->mnt_fsnotify_marks);\r\nspin_unlock(&mnt->mnt_root->d_lock);\r\nreturn ret;\r\n}

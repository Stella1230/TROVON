static int wl1273_fm_write_fw(struct wl1273_core *core,\r\n__u8 *fw, int len)\r\n{\r\nstruct i2c_client *client = core->client;\r\nstruct i2c_msg msg;\r\nint i, r = 0;\r\nmsg.addr = client->addr;\r\nmsg.flags = 0;\r\nfor (i = 0; i <= len; i++) {\r\nmsg.len = fw[0];\r\nmsg.buf = fw + 1;\r\nfw += msg.len + 1;\r\ndev_dbg(&client->dev, "%s:len[%d]: %d\n", __func__, i, msg.len);\r\nr = i2c_transfer(client->adapter, &msg, 1);\r\nif (r < 0 && i < len + 1)\r\nbreak;\r\n}\r\ndev_dbg(&client->dev, "%s: i: %d\n", __func__, i);\r\ndev_dbg(&client->dev, "%s: len + 1: %d\n", __func__, len + 1);\r\nif (i == len || r == 1)\r\nr = 0;\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_rds(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nstruct i2c_client *client = core->client;\r\nu16 val;\r\nu8 b0 = WL1273_RDS_DATA_GET, status;\r\nstruct v4l2_rds_data rds = { 0, 0, 0 };\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.buf = &b0,\r\n.len = 1,\r\n},\r\n{\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.buf = (u8 *) &rds,\r\n.len = sizeof(rds),\r\n}\r\n};\r\nint r;\r\nif (core->mode != WL1273_MODE_RX)\r\nreturn 0;\r\nr = core->read(core, WL1273_RDS_SYNC_GET, &val);\r\nif (r)\r\nreturn r;\r\nif ((val & 0x01) == 0) {\r\nreturn -EAGAIN;\r\n}\r\ndo {\r\nr = i2c_transfer(client->adapter, msg, ARRAY_SIZE(msg));\r\nif (r != ARRAY_SIZE(msg)) {\r\ndev_err(radio->dev, WL1273_FM_DRIVER_NAME\r\n": %s: read_rds error r == %i)\n",\r\n__func__, r);\r\n}\r\nstatus = rds.block;\r\nif (!WL1273_FIFO_HAS_DATA(status))\r\nbreak;\r\nrds.block = V4L2_RDS_BLOCK_MSK & status;\r\nrds.block |= rds.block << 3;\r\nif (WL1273_RDS_UNCORRECTABLE_ERROR & status) {\r\nrds.block |= V4L2_RDS_BLOCK_ERROR;\r\nrds.block &= ~V4L2_RDS_BLOCK_CORRECTED;\r\n} else if (WL1273_RDS_CORRECTABLE_ERROR & status) {\r\nrds.block &= ~V4L2_RDS_BLOCK_ERROR;\r\nrds.block |= V4L2_RDS_BLOCK_CORRECTED;\r\n}\r\nmemcpy(&radio->buffer[radio->wr_index], &rds, RDS_BLOCK_SIZE);\r\nradio->wr_index += 3;\r\nif (radio->wr_index >= radio->buf_size)\r\nradio->wr_index = 0;\r\nif (radio->wr_index == radio->rd_index) {\r\ndev_dbg(radio->dev, "RDS OVERFLOW");\r\nradio->rd_index = 0;\r\nradio->wr_index = 0;\r\nbreak;\r\n}\r\n} while (WL1273_FIFO_HAS_DATA(status));\r\nif (radio->wr_index != radio->rd_index)\r\nwake_up_interruptible(&radio->read_queue);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t wl1273_fm_irq_thread_handler(int irq, void *dev_id)\r\n{\r\nstruct wl1273_device *radio = dev_id;\r\nstruct wl1273_core *core = radio->core;\r\nu16 flags;\r\nint r;\r\nr = core->read(core, WL1273_FLAG_GET, &flags);\r\nif (r)\r\ngoto out;\r\nif (flags & WL1273_BL_EVENT) {\r\nradio->irq_received = flags;\r\ndev_dbg(radio->dev, "IRQ: BL\n");\r\n}\r\nif (flags & WL1273_RDS_EVENT) {\r\nmsleep(200);\r\nwl1273_fm_rds(radio);\r\n}\r\nif (flags & WL1273_BBLK_EVENT)\r\ndev_dbg(radio->dev, "IRQ: BBLK\n");\r\nif (flags & WL1273_LSYNC_EVENT)\r\ndev_dbg(radio->dev, "IRQ: LSYNC\n");\r\nif (flags & WL1273_LEV_EVENT) {\r\nu16 level;\r\nr = core->read(core, WL1273_RSSI_LVL_GET, &level);\r\nif (r)\r\ngoto out;\r\nif (level > 14)\r\ndev_dbg(radio->dev, "IRQ: LEV: 0x%x04\n", level);\r\n}\r\nif (flags & WL1273_IFFR_EVENT)\r\ndev_dbg(radio->dev, "IRQ: IFFR\n");\r\nif (flags & WL1273_PI_EVENT)\r\ndev_dbg(radio->dev, "IRQ: PI\n");\r\nif (flags & WL1273_PD_EVENT)\r\ndev_dbg(radio->dev, "IRQ: PD\n");\r\nif (flags & WL1273_STIC_EVENT)\r\ndev_dbg(radio->dev, "IRQ: STIC\n");\r\nif (flags & WL1273_MAL_EVENT)\r\ndev_dbg(radio->dev, "IRQ: MAL\n");\r\nif (flags & WL1273_POW_ENB_EVENT) {\r\ncomplete(&radio->busy);\r\ndev_dbg(radio->dev, "NOT BUSY\n");\r\ndev_dbg(radio->dev, "IRQ: POW_ENB\n");\r\n}\r\nif (flags & WL1273_SCAN_OVER_EVENT)\r\ndev_dbg(radio->dev, "IRQ: SCAN_OVER\n");\r\nif (flags & WL1273_ERROR_EVENT)\r\ndev_dbg(radio->dev, "IRQ: ERROR\n");\r\nif (flags & WL1273_FR_EVENT) {\r\nu16 freq;\r\ndev_dbg(radio->dev, "IRQ: FR:\n");\r\nif (core->mode == WL1273_MODE_RX) {\r\nr = core->write(core, WL1273_TUNER_MODE_SET,\r\nTUNER_MODE_STOP_SEARCH);\r\nif (r) {\r\ndev_err(radio->dev,\r\n"%s: TUNER_MODE_SET fails: %d\n",\r\n__func__, r);\r\ngoto out;\r\n}\r\nr = core->read(core, WL1273_FREQ_SET, &freq);\r\nif (r)\r\ngoto out;\r\nif (radio->band == WL1273_BAND_JAPAN)\r\nradio->rx_frequency = WL1273_BAND_JAPAN_LOW +\r\nfreq * 50;\r\nelse\r\nradio->rx_frequency = WL1273_BAND_OTHER_LOW +\r\nfreq * 50;\r\nusleep_range(10000, 15000);\r\ndev_dbg(radio->dev, "%dkHz\n", radio->rx_frequency);\r\n} else {\r\nr = core->read(core, WL1273_CHANL_SET, &freq);\r\nif (r)\r\ngoto out;\r\ndev_dbg(radio->dev, "%dkHz\n", freq);\r\n}\r\ndev_dbg(radio->dev, "%s: NOT BUSY\n", __func__);\r\n}\r\nout:\r\ncore->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\r\ncomplete(&radio->busy);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wl1273_fm_set_tx_freq(struct wl1273_device *radio, unsigned int freq)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\nif (freq < WL1273_BAND_TX_LOW) {\r\ndev_err(radio->dev,\r\n"Frequency out of range: %d < %d\n", freq,\r\nWL1273_BAND_TX_LOW);\r\nreturn -ERANGE;\r\n}\r\nif (freq > WL1273_BAND_TX_HIGH) {\r\ndev_err(radio->dev,\r\n"Frequency out of range: %d > %d\n", freq,\r\nWL1273_BAND_TX_HIGH);\r\nreturn -ERANGE;\r\n}\r\nusleep_range(5000, 10000);\r\ndev_dbg(radio->dev, "%s: freq: %d kHz\n", __func__, freq);\r\nr = core->write(core, WL1273_CHANL_SET, freq / 10);\r\nif (r)\r\nreturn r;\r\nreinit_completion(&radio->busy);\r\nr = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(2000));\r\nif (!r)\r\nreturn -ETIMEDOUT;\r\ndev_dbg(radio->dev, "WL1273_CHANL_SET: %d\n", r);\r\nr = core->write(core, WL1273_POWER_ENB_SET, 1);\r\nif (r)\r\nreturn r;\r\nreinit_completion(&radio->busy);\r\nr = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000));\r\nif (!r)\r\nreturn -ETIMEDOUT;\r\nradio->tx_frequency = freq;\r\ndev_dbg(radio->dev, "WL1273_POWER_ENB_SET: %d\n", r);\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_set_rx_freq(struct wl1273_device *radio, unsigned int freq)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r, f;\r\nif (freq < radio->rangelow) {\r\ndev_err(radio->dev,\r\n"Frequency out of range: %d < %d\n", freq,\r\nradio->rangelow);\r\nr = -ERANGE;\r\ngoto err;\r\n}\r\nif (freq > radio->rangehigh) {\r\ndev_err(radio->dev,\r\n"Frequency out of range: %d > %d\n", freq,\r\nradio->rangehigh);\r\nr = -ERANGE;\r\ngoto err;\r\n}\r\ndev_dbg(radio->dev, "%s: %dkHz\n", __func__, freq);\r\ncore->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\r\nif (radio->band == WL1273_BAND_JAPAN)\r\nf = (freq - WL1273_BAND_JAPAN_LOW) / 50;\r\nelse\r\nf = (freq - WL1273_BAND_OTHER_LOW) / 50;\r\nr = core->write(core, WL1273_FREQ_SET, f);\r\nif (r) {\r\ndev_err(radio->dev, "FREQ_SET fails\n");\r\ngoto err;\r\n}\r\nr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_PRESET);\r\nif (r) {\r\ndev_err(radio->dev, "TUNER_MODE_SET fails\n");\r\ngoto err;\r\n}\r\nreinit_completion(&radio->busy);\r\nr = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(2000));\r\nif (!r) {\r\ndev_err(radio->dev, "%s: TIMEOUT\n", __func__);\r\nreturn -ETIMEDOUT;\r\n}\r\nradio->rd_index = 0;\r\nradio->wr_index = 0;\r\nradio->rx_frequency = freq;\r\nreturn 0;\r\nerr:\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_get_freq(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nunsigned int freq;\r\nu16 f;\r\nint r;\r\nif (core->mode == WL1273_MODE_RX) {\r\nr = core->read(core, WL1273_FREQ_SET, &f);\r\nif (r)\r\nreturn r;\r\ndev_dbg(radio->dev, "Freq get: 0x%04x\n", f);\r\nif (radio->band == WL1273_BAND_JAPAN)\r\nfreq = WL1273_BAND_JAPAN_LOW + 50 * f;\r\nelse\r\nfreq = WL1273_BAND_OTHER_LOW + 50 * f;\r\n} else {\r\nr = core->read(core, WL1273_CHANL_SET, &f);\r\nif (r)\r\nreturn r;\r\nfreq = f * 10;\r\n}\r\nreturn freq;\r\n}\r\nstatic int wl1273_fm_upload_firmware_patch(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nunsigned int packet_num;\r\nconst struct firmware *fw_p;\r\nconst char *fw_name = "radio-wl1273-fw.bin";\r\nstruct device *dev = radio->dev;\r\n__u8 *ptr;\r\nint r;\r\ndev_dbg(dev, "%s:\n", __func__);\r\nif (request_firmware(&fw_p, fw_name, dev)) {\r\ndev_info(dev, "%s - %s not found\n", __func__, fw_name);\r\nreturn 0;\r\n}\r\nptr = (__u8 *) fw_p->data;\r\npacket_num = ptr[0];\r\ndev_dbg(dev, "%s: packets: %d\n", __func__, packet_num);\r\nr = wl1273_fm_write_fw(core, ptr + 1, packet_num);\r\nif (r) {\r\ndev_err(dev, "FW upload error: %d\n", r);\r\ngoto out;\r\n}\r\ncore->write(core, WL1273_RESET, 0);\r\ndev_dbg(dev, "%s - download OK, r: %d\n", __func__, r);\r\nout:\r\nrelease_firmware(fw_p);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_stop(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nif (core->mode == WL1273_MODE_RX) {\r\nint r = core->write(core, WL1273_POWER_SET,\r\nWL1273_POWER_SET_OFF);\r\nif (r)\r\ndev_err(radio->dev, "%s: POWER_SET fails: %d\n",\r\n__func__, r);\r\n} else if (core->mode == WL1273_MODE_TX) {\r\nint r = core->write(core, WL1273_PUPD_SET,\r\nWL1273_PUPD_SET_OFF);\r\nif (r)\r\ndev_err(radio->dev,\r\n"%s: PUPD_SET fails: %d\n", __func__, r);\r\n}\r\nif (core->pdata->disable) {\r\ncore->pdata->disable();\r\ndev_dbg(radio->dev, "Back to reset\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_start(struct wl1273_device *radio, int new_mode)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nstruct wl1273_fm_platform_data *pdata = core->pdata;\r\nstruct device *dev = radio->dev;\r\nint r = -EINVAL;\r\nif (pdata->enable && core->mode == WL1273_MODE_OFF) {\r\ndev_dbg(radio->dev, "Out of reset\n");\r\npdata->enable();\r\nmsleep(250);\r\n}\r\nif (new_mode == WL1273_MODE_RX) {\r\nu16 val = WL1273_POWER_SET_FM;\r\nif (radio->rds_on)\r\nval |= WL1273_POWER_SET_RDS;\r\nr = core->write(core, WL1273_POWER_SET, val);\r\nif (r) {\r\nmsleep(100);\r\nr = core->write(core, WL1273_POWER_SET, val);\r\nif (r) {\r\ndev_err(dev, "%s: POWER_SET fails\n", __func__);\r\ngoto fail;\r\n}\r\n}\r\nradio->wr_index = 0;\r\nradio->rd_index = 0;\r\n} else if (new_mode == WL1273_MODE_TX) {\r\nr = core->write(core, WL1273_PUPD_SET, WL1273_PUPD_SET_ON);\r\nif (r) {\r\nmsleep(100);\r\nr = core->write(core, WL1273_PUPD_SET,\r\nWL1273_PUPD_SET_ON);\r\nif (r) {\r\ndev_err(dev, "%s: PUPD_SET fails\n", __func__);\r\ngoto fail;\r\n}\r\n}\r\nif (radio->rds_on)\r\nr = core->write(core, WL1273_RDS_DATA_ENB, 1);\r\nelse\r\nr = core->write(core, WL1273_RDS_DATA_ENB, 0);\r\n} else {\r\ndev_warn(dev, "%s: Illegal mode.\n", __func__);\r\n}\r\nif (core->mode == WL1273_MODE_OFF) {\r\nr = wl1273_fm_upload_firmware_patch(radio);\r\nif (r)\r\ndev_warn(dev, "Firmware upload failed.\n");\r\nif (new_mode == WL1273_MODE_RX) {\r\nu16 val = WL1273_POWER_SET_FM;\r\nif (radio->rds_on)\r\nval |= WL1273_POWER_SET_RDS;\r\nr = core->write(core, WL1273_POWER_SET, val);\r\nif (r) {\r\ndev_err(dev, "%s: POWER_SET fails\n", __func__);\r\ngoto fail;\r\n}\r\n} else if (new_mode == WL1273_MODE_TX) {\r\nr = core->write(core, WL1273_PUPD_SET,\r\nWL1273_PUPD_SET_ON);\r\nif (r) {\r\ndev_err(dev, "%s: PUPD_SET fails\n", __func__);\r\ngoto fail;\r\n}\r\n}\r\n}\r\nreturn 0;\r\nfail:\r\nif (pdata->disable)\r\npdata->disable();\r\ndev_dbg(dev, "%s: return: %d\n", __func__, r);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_suspend(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\nif (core->mode == WL1273_MODE_RX)\r\nr = core->write(core, WL1273_POWER_SET,\r\nWL1273_POWER_SET_RETENTION);\r\nelse if (core->mode == WL1273_MODE_TX)\r\nr = core->write(core, WL1273_PUPD_SET,\r\nWL1273_PUPD_SET_RETENTION);\r\nelse\r\nr = -EINVAL;\r\nif (r) {\r\ndev_err(radio->dev, "%s: POWER_SET fails: %d\n", __func__, r);\r\ngoto out;\r\n}\r\nout:\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_set_mode(struct wl1273_device *radio, int mode)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nstruct device *dev = radio->dev;\r\nint old_mode;\r\nint r;\r\ndev_dbg(dev, "%s\n", __func__);\r\ndev_dbg(dev, "Forbidden modes: 0x%02x\n", radio->forbidden);\r\nold_mode = core->mode;\r\nif (mode & radio->forbidden) {\r\nr = -EPERM;\r\ngoto out;\r\n}\r\nswitch (mode) {\r\ncase WL1273_MODE_RX:\r\ncase WL1273_MODE_TX:\r\nr = wl1273_fm_start(radio, mode);\r\nif (r) {\r\ndev_err(dev, "%s: Cannot start.\n", __func__);\r\nwl1273_fm_stop(radio);\r\ngoto out;\r\n}\r\ncore->mode = mode;\r\nr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\r\nif (r) {\r\ndev_err(dev, "INT_MASK_SET fails.\n");\r\ngoto out;\r\n}\r\nif (mode == WL1273_MODE_RX) {\r\nr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\r\nif (r) {\r\ndev_err(dev, "set freq fails: %d.\n", r);\r\ngoto out;\r\n}\r\nr = core->set_volume(core, core->volume);\r\nif (r) {\r\ndev_err(dev, "set volume fails: %d.\n", r);\r\ngoto out;\r\n}\r\ndev_dbg(dev, "%s: Set vol: %d.\n", __func__,\r\ncore->volume);\r\n} else {\r\nr = wl1273_fm_set_tx_freq(radio, radio->tx_frequency);\r\nif (r) {\r\ndev_err(dev, "set freq fails: %d.\n", r);\r\ngoto out;\r\n}\r\n}\r\ndev_dbg(radio->dev, "%s: Set audio mode.\n", __func__);\r\nr = core->set_audio(core, core->audio_mode);\r\nif (r)\r\ndev_err(dev, "Cannot set audio mode.\n");\r\nbreak;\r\ncase WL1273_MODE_OFF:\r\nr = wl1273_fm_stop(radio);\r\nif (r)\r\ndev_err(dev, "%s: Off fails: %d\n", __func__, r);\r\nelse\r\ncore->mode = WL1273_MODE_OFF;\r\nbreak;\r\ncase WL1273_MODE_SUSPENDED:\r\nr = wl1273_fm_suspend(radio);\r\nif (r)\r\ndev_err(dev, "%s: Suspend fails: %d\n", __func__, r);\r\nelse\r\ncore->mode = WL1273_MODE_SUSPENDED;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "%s: Unknown mode: %d\n", __func__, mode);\r\nr = -EINVAL;\r\nbreak;\r\n}\r\nout:\r\nif (r)\r\ncore->mode = old_mode;\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_set_seek(struct wl1273_device *radio,\r\nunsigned int wrap_around,\r\nunsigned int seek_upward,\r\nint level)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\nunsigned int dir = (seek_upward == 0) ? 0 : 1;\r\nunsigned int f;\r\nf = radio->rx_frequency;\r\ndev_dbg(radio->dev, "rx_frequency: %d\n", f);\r\nif (dir && f + radio->spacing <= radio->rangehigh)\r\nr = wl1273_fm_set_rx_freq(radio, f + radio->spacing);\r\nelse if (dir && wrap_around)\r\nr = wl1273_fm_set_rx_freq(radio, radio->rangelow);\r\nelse if (f - radio->spacing >= radio->rangelow)\r\nr = wl1273_fm_set_rx_freq(radio, f - radio->spacing);\r\nelse if (wrap_around)\r\nr = wl1273_fm_set_rx_freq(radio, radio->rangehigh);\r\nif (r)\r\ngoto out;\r\nif (level < SCHAR_MIN || level > SCHAR_MAX)\r\nreturn -EINVAL;\r\nreinit_completion(&radio->busy);\r\ndev_dbg(radio->dev, "%s: BUSY\n", __func__);\r\nr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\r\nif (r)\r\ngoto out;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nr = core->write(core, WL1273_SEARCH_LVL_SET, level);\r\nif (r)\r\ngoto out;\r\nr = core->write(core, WL1273_SEARCH_DIR_SET, dir);\r\nif (r)\r\ngoto out;\r\nr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_AUTO_SEEK);\r\nif (r)\r\ngoto out;\r\nwait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000));\r\nif (!(radio->irq_received & WL1273_BL_EVENT))\r\ngoto out;\r\nradio->irq_received &= ~WL1273_BL_EVENT;\r\nif (!wrap_around)\r\ngoto out;\r\ndev_dbg(radio->dev, "Wrap around in HW seek.\n");\r\nif (seek_upward)\r\nf = radio->rangelow;\r\nelse\r\nf = radio->rangehigh;\r\nr = wl1273_fm_set_rx_freq(radio, f);\r\nif (r)\r\ngoto out;\r\nreinit_completion(&radio->busy);\r\ndev_dbg(radio->dev, "%s: BUSY\n", __func__);\r\nr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_AUTO_SEEK);\r\nif (r)\r\ngoto out;\r\nwait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000));\r\nout:\r\ndev_dbg(radio->dev, "%s: Err: %d\n", __func__, r);\r\nreturn r;\r\n}\r\nstatic unsigned int wl1273_fm_get_tx_ctune(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nstruct device *dev = radio->dev;\r\nu16 val;\r\nint r;\r\nif (core->mode == WL1273_MODE_OFF ||\r\ncore->mode == WL1273_MODE_SUSPENDED)\r\nreturn -EPERM;\r\nr = core->read(core, WL1273_READ_FMANT_TUNE_VALUE, &val);\r\nif (r) {\r\ndev_err(dev, "%s: read error: %d\n", __func__, r);\r\ngoto out;\r\n}\r\nout:\r\nreturn val;\r\n}\r\nstatic int wl1273_fm_set_preemphasis(struct wl1273_device *radio,\r\nunsigned int preemphasis)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\nu16 em;\r\nif (core->mode == WL1273_MODE_OFF ||\r\ncore->mode == WL1273_MODE_SUSPENDED)\r\nreturn -EPERM;\r\nmutex_lock(&core->lock);\r\nswitch (preemphasis) {\r\ncase V4L2_PREEMPHASIS_DISABLED:\r\nem = 1;\r\nbreak;\r\ncase V4L2_PREEMPHASIS_50_uS:\r\nem = 0;\r\nbreak;\r\ncase V4L2_PREEMPHASIS_75_uS:\r\nem = 2;\r\nbreak;\r\ndefault:\r\nr = -EINVAL;\r\ngoto out;\r\n}\r\nr = core->write(core, WL1273_PREMPH_SET, em);\r\nif (r)\r\ngoto out;\r\nradio->preemphasis = preemphasis;\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_rds_on(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (radio->rds_on)\r\nreturn 0;\r\nr = core->write(core, WL1273_POWER_SET,\r\nWL1273_POWER_SET_FM | WL1273_POWER_SET_RDS);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\r\nif (r)\r\ndev_err(radio->dev, "set freq fails: %d.\n", r);\r\nout:\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_rds_off(struct wl1273_device *radio)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\nif (!radio->rds_on)\r\nreturn 0;\r\nradio->irq_flags &= ~WL1273_RDS_EVENT;\r\nr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\r\nif (r)\r\ngoto out;\r\nwake_up_interruptible(&radio->read_queue);\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nr = core->write(core, WL1273_POWER_SET, WL1273_POWER_SET_FM);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\r\nif (r)\r\ndev_err(radio->dev, "set freq fails: %d.\n", r);\r\nout:\r\ndev_dbg(radio->dev, "%s: exiting...\n", __func__);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_set_rds(struct wl1273_device *radio, unsigned int new_mode)\r\n{\r\nint r = 0;\r\nstruct wl1273_core *core = radio->core;\r\nif (core->mode == WL1273_MODE_OFF ||\r\ncore->mode == WL1273_MODE_SUSPENDED)\r\nreturn -EPERM;\r\nif (new_mode == WL1273_RDS_RESET) {\r\nr = core->write(core, WL1273_RDS_CNTRL_SET, 1);\r\nreturn r;\r\n}\r\nif (core->mode == WL1273_MODE_TX && new_mode == WL1273_RDS_OFF) {\r\nr = core->write(core, WL1273_RDS_DATA_ENB, 0);\r\n} else if (core->mode == WL1273_MODE_TX && new_mode == WL1273_RDS_ON) {\r\nr = core->write(core, WL1273_RDS_DATA_ENB, 1);\r\n} else if (core->mode == WL1273_MODE_RX && new_mode == WL1273_RDS_OFF) {\r\nr = wl1273_fm_rds_off(radio);\r\n} else if (core->mode == WL1273_MODE_RX && new_mode == WL1273_RDS_ON) {\r\nr = wl1273_fm_rds_on(radio);\r\n} else {\r\ndev_err(radio->dev, "%s: Unknown mode: %d\n",\r\n__func__, new_mode);\r\nr = -EINVAL;\r\n}\r\nif (!r)\r\nradio->rds_on = (new_mode == WL1273_RDS_ON) ? true : false;\r\nreturn r;\r\n}\r\nstatic ssize_t wl1273_fm_fops_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nu16 val;\r\nint r;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (core->mode != WL1273_MODE_TX)\r\nreturn count;\r\nif (radio->rds_users == 0) {\r\ndev_warn(radio->dev, "%s: RDS not on.\n", __func__);\r\nreturn 0;\r\n}\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nif (radio->owner && radio->owner != file) {\r\nr = -EBUSY;\r\ngoto out;\r\n}\r\nradio->owner = file;\r\nif (count > 255)\r\nval = 255;\r\nelse\r\nval = count;\r\ncore->write(core, WL1273_RDS_CONFIG_DATA_SET, val);\r\nif (copy_from_user(radio->write_buf + 1, buf, val)) {\r\nr = -EFAULT;\r\ngoto out;\r\n}\r\ndev_dbg(radio->dev, "Count: %d\n", val);\r\ndev_dbg(radio->dev, "From user: \"%s\"\n", radio->write_buf);\r\nradio->write_buf[0] = WL1273_RDS_DATA_SET;\r\ncore->write_data(core, radio->write_buf, val + 1);\r\nr = val;\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic unsigned int wl1273_fm_fops_poll(struct file *file,\r\nstruct poll_table_struct *pts)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nif (radio->owner && radio->owner != file)\r\nreturn -EBUSY;\r\nradio->owner = file;\r\nif (core->mode == WL1273_MODE_RX) {\r\npoll_wait(file, &radio->read_queue, pts);\r\nif (radio->rd_index != radio->wr_index)\r\nreturn POLLIN | POLLRDNORM;\r\n} else if (core->mode == WL1273_MODE_TX) {\r\nreturn POLLOUT | POLLWRNORM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_fops_open(struct file *file)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (core->mode == WL1273_MODE_RX && radio->rds_on &&\r\n!radio->rds_users) {\r\ndev_dbg(radio->dev, "%s: Mode: %d\n", __func__, core->mode);\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nradio->irq_flags |= WL1273_RDS_EVENT;\r\nr = core->write(core, WL1273_INT_MASK_SET,\r\nradio->irq_flags);\r\nif (r) {\r\nmutex_unlock(&core->lock);\r\ngoto out;\r\n}\r\nradio->rds_users++;\r\nmutex_unlock(&core->lock);\r\n}\r\nout:\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_fops_release(struct file *file)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (radio->rds_users > 0) {\r\nradio->rds_users--;\r\nif (radio->rds_users == 0) {\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nradio->irq_flags &= ~WL1273_RDS_EVENT;\r\nif (core->mode == WL1273_MODE_RX) {\r\nr = core->write(core,\r\nWL1273_INT_MASK_SET,\r\nradio->irq_flags);\r\nif (r) {\r\nmutex_unlock(&core->lock);\r\ngoto out;\r\n}\r\n}\r\nmutex_unlock(&core->lock);\r\n}\r\n}\r\nif (file == radio->owner)\r\nradio->owner = NULL;\r\nout:\r\nreturn r;\r\n}\r\nstatic ssize_t wl1273_fm_fops_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint r = 0;\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nunsigned int block_count = 0;\r\nu16 val;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (core->mode != WL1273_MODE_RX)\r\nreturn 0;\r\nif (radio->rds_users == 0) {\r\ndev_warn(radio->dev, "%s: RDS not on.\n", __func__);\r\nreturn 0;\r\n}\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nif (radio->owner && radio->owner != file) {\r\nr = -EBUSY;\r\ngoto out;\r\n}\r\nradio->owner = file;\r\nr = core->read(core, WL1273_RDS_SYNC_GET, &val);\r\nif (r) {\r\ndev_err(radio->dev, "%s: Get RDS_SYNC fails.\n", __func__);\r\ngoto out;\r\n} else if (val == 0) {\r\ndev_info(radio->dev, "RDS_SYNC: Not synchronized\n");\r\nr = -ENODATA;\r\ngoto out;\r\n}\r\nwhile (radio->wr_index == radio->rd_index) {\r\nif (file->f_flags & O_NONBLOCK) {\r\nr = -EWOULDBLOCK;\r\ngoto out;\r\n}\r\ndev_dbg(radio->dev, "%s: Wait for RDS data.\n", __func__);\r\nif (wait_event_interruptible(radio->read_queue,\r\nradio->wr_index !=\r\nradio->rd_index) < 0) {\r\nr = -EINTR;\r\ngoto out;\r\n}\r\n}\r\ncount /= RDS_BLOCK_SIZE;\r\nwhile (block_count < count) {\r\nif (radio->rd_index == radio->wr_index)\r\nbreak;\r\nif (copy_to_user(buf, &radio->buffer[radio->rd_index],\r\nRDS_BLOCK_SIZE))\r\nbreak;\r\nradio->rd_index += RDS_BLOCK_SIZE;\r\nif (radio->rd_index >= radio->buf_size)\r\nradio->rd_index = 0;\r\nblock_count++;\r\nbuf += RDS_BLOCK_SIZE;\r\nr += RDS_BLOCK_SIZE;\r\n}\r\nout:\r\ndev_dbg(radio->dev, "%s: exit\n", __func__);\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *capability)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nstrlcpy(capability->driver, WL1273_FM_DRIVER_NAME,\r\nsizeof(capability->driver));\r\nstrlcpy(capability->card, "Texas Instruments Wl1273 FM Radio",\r\nsizeof(capability->card));\r\nstrlcpy(capability->bus_info, radio->bus_type,\r\nsizeof(capability->bus_info));\r\ncapability->device_caps = V4L2_CAP_HW_FREQ_SEEK |\r\nV4L2_CAP_TUNER | V4L2_CAP_RADIO | V4L2_CAP_AUDIO |\r\nV4L2_CAP_RDS_CAPTURE | V4L2_CAP_MODULATOR |\r\nV4L2_CAP_RDS_OUTPUT;\r\ncapability->capabilities = capability->device_caps |\r\nV4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_g_input(struct file *file, void *priv,\r\nunsigned int *i)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_s_input(struct file *file, void *priv,\r\nunsigned int i)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (i != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_set_tx_power(struct wl1273_device *radio, u16 power)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\nif (core->mode == WL1273_MODE_OFF ||\r\ncore->mode == WL1273_MODE_SUSPENDED)\r\nreturn -EPERM;\r\nmutex_lock(&core->lock);\r\nr = core->write(core, WL1273_POWER_LEV_SET, 122 - power);\r\nif (r)\r\ngoto out;\r\nradio->tx_power = power;\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_tx_set_spacing(struct wl1273_device *radio,\r\nunsigned int spacing)\r\n{\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\nif (spacing == 0) {\r\nr = core->write(core, WL1273_SCAN_SPACING_SET,\r\nWL1273_SPACING_100kHz);\r\nradio->spacing = 100;\r\n} else if (spacing - 50000 < 25000) {\r\nr = core->write(core, WL1273_SCAN_SPACING_SET,\r\nWL1273_SPACING_50kHz);\r\nradio->spacing = 50;\r\n} else if (spacing - 100000 < 50000) {\r\nr = core->write(core, WL1273_SCAN_SPACING_SET,\r\nWL1273_SPACING_100kHz);\r\nradio->spacing = 100;\r\n} else {\r\nr = core->write(core, WL1273_SCAN_SPACING_SET,\r\nWL1273_SPACING_200kHz);\r\nradio->spacing = 200;\r\n}\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_g_volatile_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct wl1273_device *radio = ctrl->priv;\r\nstruct wl1273_core *core = radio->core;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_TUNE_ANTENNA_CAPACITOR:\r\nctrl->val = wl1273_fm_get_tx_ctune(radio);\r\nbreak;\r\ndefault:\r\ndev_warn(radio->dev, "%s: Unknown IOCTL: %d\n",\r\n__func__, ctrl->id);\r\nbreak;\r\n}\r\nmutex_unlock(&core->lock);\r\nreturn 0;\r\n}\r\nstatic inline struct wl1273_device *to_radio(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn container_of(ctrl->handler, struct wl1273_device, ctrl_handler);\r\n}\r\nstatic int wl1273_fm_vidioc_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct wl1273_device *radio = to_radio(ctrl);\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nif (core->mode == WL1273_MODE_RX && ctrl->val)\r\nr = core->write(core,\r\nWL1273_MUTE_STATUS_SET,\r\nWL1273_MUTE_HARD_LEFT |\r\nWL1273_MUTE_HARD_RIGHT);\r\nelse if (core->mode == WL1273_MODE_RX)\r\nr = core->write(core,\r\nWL1273_MUTE_STATUS_SET, 0x0);\r\nelse if (core->mode == WL1273_MODE_TX && ctrl->val)\r\nr = core->write(core, WL1273_MUTE, 1);\r\nelse if (core->mode == WL1273_MODE_TX)\r\nr = core->write(core, WL1273_MUTE, 0);\r\nmutex_unlock(&core->lock);\r\nbreak;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nif (ctrl->val == 0)\r\nr = wl1273_fm_set_mode(radio, WL1273_MODE_OFF);\r\nelse\r\nr = core->set_volume(core, core->volume);\r\nbreak;\r\ncase V4L2_CID_TUNE_PREEMPHASIS:\r\nr = wl1273_fm_set_preemphasis(radio, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_TUNE_POWER_LEVEL:\r\nr = wl1273_fm_set_tx_power(radio, ctrl->val);\r\nbreak;\r\ndefault:\r\ndev_warn(radio->dev, "%s: Unknown IOCTL: %d\n",\r\n__func__, ctrl->id);\r\nbreak;\r\n}\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *audio)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (audio->index > 1)\r\nreturn -EINVAL;\r\nstrlcpy(audio->name, "Radio", sizeof(audio->name));\r\naudio->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_s_audio(struct file *file, void *priv,\r\nconst struct v4l2_audio *audio)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (audio->index != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *tuner)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nu16 val;\r\nint r;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (tuner->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(tuner->name, WL1273_FM_DRIVER_NAME, sizeof(tuner->name));\r\ntuner->type = V4L2_TUNER_RADIO;\r\ntuner->rangelow = WL1273_FREQ(WL1273_BAND_JAPAN_LOW);\r\ntuner->rangehigh = WL1273_FREQ(WL1273_BAND_OTHER_HIGH);\r\ntuner->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_RDS |\r\nV4L2_TUNER_CAP_STEREO | V4L2_TUNER_CAP_RDS_BLOCK_IO |\r\nV4L2_TUNER_CAP_HWSEEK_BOUNDED | V4L2_TUNER_CAP_HWSEEK_WRAP;\r\nif (radio->stereo)\r\ntuner->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\ntuner->audmode = V4L2_TUNER_MODE_MONO;\r\nif (core->mode != WL1273_MODE_RX)\r\nreturn 0;\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nr = core->read(core, WL1273_STEREO_GET, &val);\r\nif (r)\r\ngoto out;\r\nif (val == 1)\r\ntuner->rxsubchans = V4L2_TUNER_SUB_STEREO;\r\nelse\r\ntuner->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nr = core->read(core, WL1273_RSSI_LVL_GET, &val);\r\nif (r)\r\ngoto out;\r\ntuner->signal = (s16) val;\r\ndev_dbg(radio->dev, "Signal: %d\n", tuner->signal);\r\ntuner->afc = 0;\r\nr = core->read(core, WL1273_RDS_SYNC_GET, &val);\r\nif (r)\r\ngoto out;\r\nif (val == WL1273_RDS_SYNCHRONIZED)\r\ntuner->rxsubchans |= V4L2_TUNER_SUB_RDS;\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *tuner)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\ndev_dbg(radio->dev, "tuner->index: %d\n", tuner->index);\r\ndev_dbg(radio->dev, "tuner->name: %s\n", tuner->name);\r\ndev_dbg(radio->dev, "tuner->capability: 0x%04x\n", tuner->capability);\r\ndev_dbg(radio->dev, "tuner->rxsubchans: 0x%04x\n", tuner->rxsubchans);\r\ndev_dbg(radio->dev, "tuner->rangelow: %d\n", tuner->rangelow);\r\ndev_dbg(radio->dev, "tuner->rangehigh: %d\n", tuner->rangehigh);\r\nif (tuner->index > 0)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nr = wl1273_fm_set_mode(radio, WL1273_MODE_RX);\r\nif (r)\r\ngoto out;\r\nif (tuner->rxsubchans & V4L2_TUNER_SUB_RDS)\r\nr = wl1273_fm_set_rds(radio, WL1273_RDS_ON);\r\nelse\r\nr = wl1273_fm_set_rds(radio, WL1273_RDS_OFF);\r\nif (r)\r\ndev_warn(radio->dev, "%s: RDS fails: %d\n", __func__, r);\r\nif (tuner->audmode == V4L2_TUNER_MODE_MONO) {\r\nr = core->write(core, WL1273_MOST_MODE_SET, WL1273_RX_MONO);\r\nif (r < 0) {\r\ndev_warn(radio->dev, "%s: MOST_MODE fails: %d\n",\r\n__func__, r);\r\ngoto out;\r\n}\r\nradio->stereo = false;\r\n} else if (tuner->audmode == V4L2_TUNER_MODE_STEREO) {\r\nr = core->write(core, WL1273_MOST_MODE_SET, WL1273_RX_STEREO);\r\nif (r < 0) {\r\ndev_warn(radio->dev, "%s: MOST_MODE fails: %d\n",\r\n__func__, r);\r\ngoto out;\r\n}\r\nradio->stereo = true;\r\n} else {\r\ndev_err(radio->dev, "%s: tuner->audmode: %d\n",\r\n__func__, tuner->audmode);\r\nr = -EINVAL;\r\ngoto out;\r\n}\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *freq)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nfreq->type = V4L2_TUNER_RADIO;\r\nfreq->frequency = WL1273_FREQ(wl1273_fm_get_freq(radio));\r\nmutex_unlock(&core->lock);\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *freq)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\ndev_dbg(radio->dev, "%s: %d\n", __func__, freq->frequency);\r\nif (freq->type != V4L2_TUNER_RADIO) {\r\ndev_dbg(radio->dev,\r\n"freq->type != V4L2_TUNER_RADIO: %d\n", freq->type);\r\nreturn -EINVAL;\r\n}\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nif (core->mode == WL1273_MODE_RX) {\r\ndev_dbg(radio->dev, "freq: %d\n", freq->frequency);\r\nr = wl1273_fm_set_rx_freq(radio,\r\nWL1273_INV_FREQ(freq->frequency));\r\nif (r)\r\ndev_warn(radio->dev, WL1273_FM_DRIVER_NAME\r\n": set frequency failed with %d\n", r);\r\n} else {\r\nr = wl1273_fm_set_tx_freq(radio,\r\nWL1273_INV_FREQ(freq->frequency));\r\nif (r)\r\ndev_warn(radio->dev, WL1273_FM_DRIVER_NAME\r\n": set frequency failed with %d\n", r);\r\n}\r\nmutex_unlock(&core->lock);\r\ndev_dbg(radio->dev, "wl1273_vidioc_s_frequency: DONE\n");\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_s_hw_freq_seek(struct file *file, void *priv,\r\nconst struct v4l2_hw_freq_seek *seek)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (seek->tuner != 0 || seek->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (file->f_flags & O_NONBLOCK)\r\nreturn -EWOULDBLOCK;\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nr = wl1273_fm_set_mode(radio, WL1273_MODE_RX);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_tx_set_spacing(radio, seek->spacing);\r\nif (r)\r\ndev_warn(radio->dev, "HW seek failed: %d\n", r);\r\nr = wl1273_fm_set_seek(radio, seek->wrap_around, seek->seek_upward,\r\nWL1273_DEFAULT_SEEK_LEVEL);\r\nif (r)\r\ndev_warn(radio->dev, "HW seek failed: %d\n", r);\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_s_modulator(struct file *file, void *priv,\r\nconst struct v4l2_modulator *modulator)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nint r = 0;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nif (modulator->index > 0)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nr = wl1273_fm_set_mode(radio, WL1273_MODE_TX);\r\nif (r)\r\ngoto out;\r\nif (modulator->txsubchans & V4L2_TUNER_SUB_RDS)\r\nr = wl1273_fm_set_rds(radio, WL1273_RDS_ON);\r\nelse\r\nr = wl1273_fm_set_rds(radio, WL1273_RDS_OFF);\r\nif (modulator->txsubchans & V4L2_TUNER_SUB_MONO)\r\nr = core->write(core, WL1273_MONO_SET, WL1273_TX_MONO);\r\nelse\r\nr = core->write(core, WL1273_MONO_SET,\r\nWL1273_RX_STEREO);\r\nif (r < 0)\r\ndev_warn(radio->dev, WL1273_FM_DRIVER_NAME\r\n"MONO_SET fails: %d\n", r);\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_vidioc_g_modulator(struct file *file, void *priv,\r\nstruct v4l2_modulator *modulator)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nu16 val;\r\nint r;\r\ndev_dbg(radio->dev, "%s\n", __func__);\r\nstrlcpy(modulator->name, WL1273_FM_DRIVER_NAME,\r\nsizeof(modulator->name));\r\nmodulator->rangelow = WL1273_FREQ(WL1273_BAND_JAPAN_LOW);\r\nmodulator->rangehigh = WL1273_FREQ(WL1273_BAND_OTHER_HIGH);\r\nmodulator->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_RDS |\r\nV4L2_TUNER_CAP_STEREO | V4L2_TUNER_CAP_RDS_BLOCK_IO;\r\nif (core->mode != WL1273_MODE_TX)\r\nreturn 0;\r\nif (mutex_lock_interruptible(&core->lock))\r\nreturn -EINTR;\r\nr = core->read(core, WL1273_MONO_SET, &val);\r\nif (r)\r\ngoto out;\r\nif (val == WL1273_TX_STEREO)\r\nmodulator->txsubchans = V4L2_TUNER_SUB_STEREO;\r\nelse\r\nmodulator->txsubchans = V4L2_TUNER_SUB_MONO;\r\nif (radio->rds_on)\r\nmodulator->txsubchans |= V4L2_TUNER_SUB_RDS;\r\nout:\r\nmutex_unlock(&core->lock);\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_vidioc_log_status(struct file *file, void *priv)\r\n{\r\nstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\r\nstruct wl1273_core *core = radio->core;\r\nstruct device *dev = radio->dev;\r\nu16 val;\r\nint r;\r\ndev_info(dev, DRIVER_DESC);\r\nif (core->mode == WL1273_MODE_OFF) {\r\ndev_info(dev, "Mode: Off\n");\r\nreturn 0;\r\n}\r\nif (core->mode == WL1273_MODE_SUSPENDED) {\r\ndev_info(dev, "Mode: Suspended\n");\r\nreturn 0;\r\n}\r\nr = core->read(core, WL1273_ASIC_ID_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get ASIC_ID fails.\n", __func__);\r\nelse\r\ndev_info(dev, "ASIC_ID: 0x%04x\n", val);\r\nr = core->read(core, WL1273_ASIC_VER_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get ASIC_VER fails.\n", __func__);\r\nelse\r\ndev_info(dev, "ASIC Version: 0x%04x\n", val);\r\nr = core->read(core, WL1273_FIRM_VER_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get FIRM_VER fails.\n", __func__);\r\nelse\r\ndev_info(dev, "FW version: %d(0x%04x)\n", val, val);\r\nr = core->read(core, WL1273_BAND_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get BAND fails.\n", __func__);\r\nelse\r\ndev_info(dev, "BAND: %d\n", val);\r\nif (core->mode == WL1273_MODE_TX) {\r\nr = core->read(core, WL1273_PUPD_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get PUPD fails.\n", __func__);\r\nelse\r\ndev_info(dev, "PUPD: 0x%04x\n", val);\r\nr = core->read(core, WL1273_CHANL_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get CHANL fails.\n", __func__);\r\nelse\r\ndev_info(dev, "Tx frequency: %dkHz\n", val*10);\r\n} else if (core->mode == WL1273_MODE_RX) {\r\nint bf = radio->rangelow;\r\nr = core->read(core, WL1273_FREQ_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get FREQ fails.\n", __func__);\r\nelse\r\ndev_info(dev, "RX Frequency: %dkHz\n", bf + val*50);\r\nr = core->read(core, WL1273_MOST_MODE_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get MOST_MODE fails.\n",\r\n__func__);\r\nelse if (val == 0)\r\ndev_info(dev, "MOST_MODE: Stereo according to blend\n");\r\nelse if (val == 1)\r\ndev_info(dev, "MOST_MODE: Force mono output\n");\r\nelse\r\ndev_info(dev, "MOST_MODE: Unexpected value: %d\n", val);\r\nr = core->read(core, WL1273_MOST_BLEND_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get MOST_BLEND fails.\n", __func__);\r\nelse if (val == 0)\r\ndev_info(dev,\r\n"MOST_BLEND: Switched blend & hysteresis.\n");\r\nelse if (val == 1)\r\ndev_info(dev, "MOST_BLEND: Soft blend.\n");\r\nelse\r\ndev_info(dev, "MOST_BLEND: Unexpected val: %d\n", val);\r\nr = core->read(core, WL1273_STEREO_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get STEREO fails.\n", __func__);\r\nelse if (val == 0)\r\ndev_info(dev, "STEREO: Not detected\n");\r\nelse if (val == 1)\r\ndev_info(dev, "STEREO: Detected\n");\r\nelse\r\ndev_info(dev, "STEREO: Unexpected value: %d\n", val);\r\nr = core->read(core, WL1273_RSSI_LVL_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get RSSI_LVL fails.\n", __func__);\r\nelse\r\ndev_info(dev, "RX signal strength: %d\n", (s16) val);\r\nr = core->read(core, WL1273_POWER_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get POWER fails.\n", __func__);\r\nelse\r\ndev_info(dev, "POWER: 0x%04x\n", val);\r\nr = core->read(core, WL1273_INT_MASK_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get INT_MASK fails.\n", __func__);\r\nelse\r\ndev_info(dev, "INT_MASK: 0x%04x\n", val);\r\nr = core->read(core, WL1273_RDS_SYNC_GET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get RDS_SYNC fails.\n",\r\n__func__);\r\nelse if (val == 0)\r\ndev_info(dev, "RDS_SYNC: Not synchronized\n");\r\nelse if (val == 1)\r\ndev_info(dev, "RDS_SYNC: Synchronized\n");\r\nelse\r\ndev_info(dev, "RDS_SYNC: Unexpected value: %d\n", val);\r\nr = core->read(core, WL1273_I2S_MODE_CONFIG_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get I2S_MODE_CONFIG fails.\n",\r\n__func__);\r\nelse\r\ndev_info(dev, "I2S_MODE_CONFIG: 0x%04x\n", val);\r\nr = core->read(core, WL1273_VOLUME_SET, &val);\r\nif (r)\r\ndev_err(dev, "%s: Get VOLUME fails.\n", __func__);\r\nelse\r\ndev_info(dev, "VOLUME: 0x%04x\n", val);\r\n}\r\nreturn 0;\r\n}\r\nstatic void wl1273_vdev_release(struct video_device *dev)\r\n{\r\n}\r\nstatic int wl1273_fm_radio_remove(struct platform_device *pdev)\r\n{\r\nstruct wl1273_device *radio = platform_get_drvdata(pdev);\r\nstruct wl1273_core *core = radio->core;\r\ndev_info(&pdev->dev, "%s.\n", __func__);\r\nfree_irq(core->client->irq, radio);\r\ncore->pdata->free_resources();\r\nv4l2_ctrl_handler_free(&radio->ctrl_handler);\r\nvideo_unregister_device(&radio->videodev);\r\nv4l2_device_unregister(&radio->v4l2dev);\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_radio_probe(struct platform_device *pdev)\r\n{\r\nstruct wl1273_core **core = pdev->dev.platform_data;\r\nstruct wl1273_device *radio;\r\nstruct v4l2_ctrl *ctrl;\r\nint r = 0;\r\npr_debug("%s\n", __func__);\r\nif (!core) {\r\ndev_err(&pdev->dev, "No platform data.\n");\r\nr = -EINVAL;\r\ngoto pdata_err;\r\n}\r\nradio = devm_kzalloc(&pdev->dev, sizeof(*radio), GFP_KERNEL);\r\nif (!radio) {\r\nr = -ENOMEM;\r\ngoto pdata_err;\r\n}\r\nradio->buf_size = rds_buf * RDS_BLOCK_SIZE;\r\nradio->buffer = devm_kzalloc(&pdev->dev, radio->buf_size, GFP_KERNEL);\r\nif (!radio->buffer) {\r\npr_err("Cannot allocate memory for RDS buffer.\n");\r\nr = -ENOMEM;\r\ngoto pdata_err;\r\n}\r\nradio->core = *core;\r\nradio->irq_flags = WL1273_IRQ_MASK;\r\nradio->dev = &radio->core->client->dev;\r\nradio->rds_on = false;\r\nradio->core->mode = WL1273_MODE_OFF;\r\nradio->tx_power = 118;\r\nradio->core->audio_mode = WL1273_AUDIO_ANALOG;\r\nradio->band = WL1273_BAND_OTHER;\r\nradio->core->i2s_mode = WL1273_I2S_DEF_MODE;\r\nradio->core->channel_number = 2;\r\nradio->core->volume = WL1273_DEFAULT_VOLUME;\r\nradio->rx_frequency = WL1273_BAND_OTHER_LOW;\r\nradio->tx_frequency = WL1273_BAND_OTHER_HIGH;\r\nradio->rangelow = WL1273_BAND_OTHER_LOW;\r\nradio->rangehigh = WL1273_BAND_OTHER_HIGH;\r\nradio->stereo = true;\r\nradio->bus_type = "I2C";\r\nif (radio->core->pdata->request_resources) {\r\nr = radio->core->pdata->request_resources(radio->core->client);\r\nif (r) {\r\ndev_err(radio->dev, WL1273_FM_DRIVER_NAME\r\n": Cannot get platform data\n");\r\ngoto pdata_err;\r\n}\r\ndev_dbg(radio->dev, "irq: %d\n", radio->core->client->irq);\r\nr = request_threaded_irq(radio->core->client->irq, NULL,\r\nwl1273_fm_irq_thread_handler,\r\nIRQF_ONESHOT | IRQF_TRIGGER_FALLING,\r\n"wl1273-fm", radio);\r\nif (r < 0) {\r\ndev_err(radio->dev, WL1273_FM_DRIVER_NAME\r\n": Unable to register IRQ handler: %d\n", r);\r\ngoto err_request_irq;\r\n}\r\n} else {\r\ndev_err(radio->dev, WL1273_FM_DRIVER_NAME ": Core WL1273 IRQ"\r\n" not configured");\r\nr = -EINVAL;\r\ngoto pdata_err;\r\n}\r\ninit_completion(&radio->busy);\r\ninit_waitqueue_head(&radio->read_queue);\r\nradio->write_buf = devm_kzalloc(&pdev->dev, 256, GFP_KERNEL);\r\nif (!radio->write_buf) {\r\nr = -ENOMEM;\r\ngoto write_buf_err;\r\n}\r\nradio->dev = &pdev->dev;\r\nradio->v4l2dev.ctrl_handler = &radio->ctrl_handler;\r\nradio->rds_users = 0;\r\nr = v4l2_device_register(&pdev->dev, &radio->v4l2dev);\r\nif (r) {\r\ndev_err(&pdev->dev, "Cannot register v4l2_device.\n");\r\ngoto write_buf_err;\r\n}\r\nradio->videodev = wl1273_viddev_template;\r\nradio->videodev.v4l2_dev = &radio->v4l2dev;\r\nv4l2_ctrl_handler_init(&radio->ctrl_handler, 6);\r\nv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\r\nV4L2_CID_AUDIO_VOLUME, 0, WL1273_MAX_VOLUME, 1,\r\nWL1273_DEFAULT_VOLUME);\r\nv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\r\nV4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\r\nv4l2_ctrl_new_std_menu(&radio->ctrl_handler, &wl1273_ctrl_ops,\r\nV4L2_CID_TUNE_PREEMPHASIS,\r\nV4L2_PREEMPHASIS_75_uS, 0x03,\r\nV4L2_PREEMPHASIS_50_uS);\r\nv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\r\nV4L2_CID_TUNE_POWER_LEVEL, 91, 122, 1, 118);\r\nctrl = v4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\r\nV4L2_CID_TUNE_ANTENNA_CAPACITOR,\r\n0, 255, 1, 255);\r\nif (ctrl)\r\nctrl->flags |= V4L2_CTRL_FLAG_VOLATILE;\r\nif (radio->ctrl_handler.error) {\r\nr = radio->ctrl_handler.error;\r\ndev_err(&pdev->dev, "Ctrl handler error: %d\n", r);\r\ngoto handler_init_err;\r\n}\r\nvideo_set_drvdata(&radio->videodev, radio);\r\nplatform_set_drvdata(pdev, radio);\r\nr = video_register_device(&radio->videodev, VFL_TYPE_RADIO, radio_nr);\r\nif (r) {\r\ndev_err(&pdev->dev, WL1273_FM_DRIVER_NAME\r\n": Could not register video device\n");\r\ngoto handler_init_err;\r\n}\r\nreturn 0;\r\nhandler_init_err:\r\nv4l2_ctrl_handler_free(&radio->ctrl_handler);\r\nv4l2_device_unregister(&radio->v4l2dev);\r\nwrite_buf_err:\r\nfree_irq(radio->core->client->irq, radio);\r\nerr_request_irq:\r\nradio->core->pdata->free_resources();\r\npdata_err:\r\nreturn r;\r\n}

static void\r\nusb_simtec_powercontrol(int port, int to)\r\n{\r\npr_debug("usb_simtec_powercontrol(%d,%d)\n", port, to);\r\npower_state[port] = to;\r\nif (power_state[0] && power_state[1])\r\ngpio_set_value(S3C2410_GPB(4), 0);\r\nelse\r\ngpio_set_value(S3C2410_GPB(4), 1);\r\n}\r\nstatic irqreturn_t\r\nusb_simtec_ocirq(int irq, void *pw)\r\n{\r\nstruct s3c2410_hcd_info *info = pw;\r\nif (gpio_get_value(S3C2410_GPG(10)) == 0) {\r\npr_debug("usb_simtec: over-current irq (oc detected)\n");\r\ns3c2410_usb_report_oc(info, 3);\r\n} else {\r\npr_debug("usb_simtec: over-current irq (oc cleared)\n");\r\ns3c2410_usb_report_oc(info, 0);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void usb_simtec_enableoc(struct s3c2410_hcd_info *info, int on)\r\n{\r\nint ret;\r\nif (on) {\r\nret = request_irq(BAST_IRQ_USBOC, usb_simtec_ocirq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"USB Over-current", info);\r\nif (ret != 0) {\r\nprintk(KERN_ERR "failed to request usb oc irq\n");\r\n}\r\n} else {\r\nfree_irq(BAST_IRQ_USBOC, info);\r\n}\r\n}\r\nint __init usb_simtec_init(void)\r\n{\r\nint ret;\r\nprintk("USB Power Control, Copyright 2004 Simtec Electronics\n");\r\nret = gpio_request(S3C2410_GPB(4), "USB power control");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPB4\n", __func__);\r\nreturn ret;\r\n}\r\nret = gpio_request(S3C2410_GPG(10), "USB overcurrent");\r\nif (ret < 0) {\r\npr_err("%s: failed to get GPG10\n", __func__);\r\ngpio_free(S3C2410_GPB(4));\r\nreturn ret;\r\n}\r\ngpio_direction_output(S3C2410_GPB(4), 1);\r\ngpio_direction_input(S3C2410_GPG(10));\r\ns3c_ohci_set_platdata(&usb_simtec_info);\r\nreturn 0;\r\n}

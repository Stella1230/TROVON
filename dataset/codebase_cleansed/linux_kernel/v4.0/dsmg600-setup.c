static void dsmg600_power_off(void)\r\n{\r\ngpio_direction_output(DSMG600_PO_GPIO, 1);\r\n}\r\nstatic void dsmg600_power_handler(unsigned long data)\r\n{\r\nif (gpio_get_value(DSMG600_PB_GPIO)) {\r\nif (power_button_countdown > 0)\r\npower_button_countdown--;\r\n} else {\r\nif (power_button_countdown == 0) {\r\nctrl_alt_del();\r\ngpio_set_value(DSMG600_LED_PWR_GPIO, 0);\r\n} else {\r\npower_button_countdown = PBUTTON_HOLDDOWN_COUNT;\r\n}\r\n}\r\nmod_timer(&dsmg600_power_timer, jiffies + msecs_to_jiffies(500));\r\n}\r\nstatic irqreturn_t dsmg600_reset_handler(int irq, void *dev_id)\r\n{\r\nmachine_power_off();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init dsmg600_timer_init(void)\r\n{\r\nixp4xx_timer_freq = DSMG600_FREQ;\r\nixp4xx_timer_init();\r\n}\r\nstatic int __init dsmg600_gpio_init(void)\r\n{\r\nif (!machine_is_dsmg600())\r\nreturn 0;\r\ngpio_request(DSMG600_RB_GPIO, "reset button");\r\nif (request_irq(gpio_to_irq(DSMG600_RB_GPIO), &dsmg600_reset_handler,\r\nIRQF_TRIGGER_LOW, "DSM-G600 reset button", NULL) < 0) {\r\nprintk(KERN_DEBUG "Reset Button IRQ %d not available\n",\r\ngpio_to_irq(DSMG600_RB_GPIO));\r\n}\r\ngpio_request(DSMG600_PB_GPIO, "power button");\r\ngpio_direction_input(DSMG600_PB_GPIO);\r\ngpio_request(DSMG600_PO_GPIO, "power off button");\r\npower_button_countdown = PBUTTON_HOLDDOWN_COUNT;\r\nmod_timer(&dsmg600_power_timer, jiffies + msecs_to_jiffies(500));\r\nreturn 0;\r\n}\r\nstatic void __init dsmg600_init(void)\r\n{\r\nixp4xx_sys_init();\r\n*IXP4XX_GPIO_GPCLKR = 0;\r\ndsmg600_flash_resource.start = IXP4XX_EXP_BUS_BASE(0);\r\ndsmg600_flash_resource.end =\r\nIXP4XX_EXP_BUS_BASE(0) + ixp4xx_exp_bus_size - 1;\r\ni2c_register_board_info(0, dsmg600_i2c_board_info,\r\nARRAY_SIZE(dsmg600_i2c_board_info));\r\n(void)platform_device_register(&dsmg600_uart);\r\nplatform_add_devices(dsmg600_devices, ARRAY_SIZE(dsmg600_devices));\r\npm_power_off = dsmg600_power_off;\r\n}

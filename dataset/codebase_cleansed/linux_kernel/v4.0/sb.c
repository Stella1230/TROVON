static int create_default_filesystem(struct ubifs_info *c)\r\n{\r\nstruct ubifs_sb_node *sup;\r\nstruct ubifs_mst_node *mst;\r\nstruct ubifs_idx_node *idx;\r\nstruct ubifs_branch *br;\r\nstruct ubifs_ino_node *ino;\r\nstruct ubifs_cs_node *cs;\r\nunion ubifs_key key;\r\nint err, tmp, jnl_lebs, log_lebs, max_buds, main_lebs, main_first;\r\nint lpt_lebs, lpt_first, orph_lebs, big_lpt, ino_waste, sup_flags = 0;\r\nint min_leb_cnt = UBIFS_MIN_LEB_CNT;\r\nlong long tmp64, main_bytes;\r\n__le64 tmp_le64;\r\nc->key_len = UBIFS_SK_LEN;\r\nif (c->leb_cnt < 0x7FFFFFFF / DEFAULT_JNL_PERCENT)\r\njnl_lebs = c->leb_cnt * DEFAULT_JNL_PERCENT / 100;\r\nelse\r\njnl_lebs = (c->leb_cnt / 100) * DEFAULT_JNL_PERCENT;\r\nif (jnl_lebs < UBIFS_MIN_JNL_LEBS)\r\njnl_lebs = UBIFS_MIN_JNL_LEBS;\r\nif (jnl_lebs * c->leb_size > DEFAULT_MAX_JNL)\r\njnl_lebs = DEFAULT_MAX_JNL / c->leb_size;\r\ntmp = 2 * (c->ref_node_alsz * jnl_lebs) + c->leb_size - 1;\r\nlog_lebs = tmp / c->leb_size;\r\nlog_lebs += 1;\r\nif (c->leb_cnt - min_leb_cnt > 8) {\r\nlog_lebs += 1;\r\nmin_leb_cnt += 1;\r\n}\r\nmax_buds = jnl_lebs - log_lebs;\r\nif (max_buds < UBIFS_MIN_BUD_LEBS)\r\nmax_buds = UBIFS_MIN_BUD_LEBS;\r\norph_lebs = UBIFS_MIN_ORPH_LEBS;\r\nif (c->leb_cnt - min_leb_cnt > 1)\r\norph_lebs += 1;\r\nmain_lebs = c->leb_cnt - UBIFS_SB_LEBS - UBIFS_MST_LEBS - log_lebs;\r\nmain_lebs -= orph_lebs;\r\nlpt_first = UBIFS_LOG_LNUM + log_lebs;\r\nc->lsave_cnt = DEFAULT_LSAVE_CNT;\r\nc->max_leb_cnt = c->leb_cnt;\r\nerr = ubifs_create_dflt_lpt(c, &main_lebs, lpt_first, &lpt_lebs,\r\n&big_lpt);\r\nif (err)\r\nreturn err;\r\ndbg_gen("LEB Properties Tree created (LEBs %d-%d)", lpt_first,\r\nlpt_first + lpt_lebs - 1);\r\nmain_first = c->leb_cnt - main_lebs;\r\ntmp = ALIGN(UBIFS_SB_NODE_SZ, c->min_io_size);\r\nsup = kzalloc(tmp, GFP_KERNEL);\r\nif (!sup)\r\nreturn -ENOMEM;\r\ntmp64 = (long long)max_buds * c->leb_size;\r\nif (big_lpt)\r\nsup_flags |= UBIFS_FLG_BIGLPT;\r\nsup->ch.node_type = UBIFS_SB_NODE;\r\nsup->key_hash = UBIFS_KEY_HASH_R5;\r\nsup->flags = cpu_to_le32(sup_flags);\r\nsup->min_io_size = cpu_to_le32(c->min_io_size);\r\nsup->leb_size = cpu_to_le32(c->leb_size);\r\nsup->leb_cnt = cpu_to_le32(c->leb_cnt);\r\nsup->max_leb_cnt = cpu_to_le32(c->max_leb_cnt);\r\nsup->max_bud_bytes = cpu_to_le64(tmp64);\r\nsup->log_lebs = cpu_to_le32(log_lebs);\r\nsup->lpt_lebs = cpu_to_le32(lpt_lebs);\r\nsup->orph_lebs = cpu_to_le32(orph_lebs);\r\nsup->jhead_cnt = cpu_to_le32(DEFAULT_JHEADS_CNT);\r\nsup->fanout = cpu_to_le32(DEFAULT_FANOUT);\r\nsup->lsave_cnt = cpu_to_le32(c->lsave_cnt);\r\nsup->fmt_version = cpu_to_le32(UBIFS_FORMAT_VERSION);\r\nsup->time_gran = cpu_to_le32(DEFAULT_TIME_GRAN);\r\nif (c->mount_opts.override_compr)\r\nsup->default_compr = cpu_to_le16(c->mount_opts.compr_type);\r\nelse\r\nsup->default_compr = cpu_to_le16(UBIFS_COMPR_LZO);\r\ngenerate_random_uuid(sup->uuid);\r\nmain_bytes = (long long)main_lebs * c->leb_size;\r\ntmp64 = div_u64(main_bytes * DEFAULT_RP_PERCENT, 100);\r\nif (tmp64 > DEFAULT_MAX_RP_SIZE)\r\ntmp64 = DEFAULT_MAX_RP_SIZE;\r\nsup->rp_size = cpu_to_le64(tmp64);\r\nsup->ro_compat_version = cpu_to_le32(UBIFS_RO_COMPAT_VERSION);\r\nerr = ubifs_write_node(c, sup, UBIFS_SB_NODE_SZ, 0, 0);\r\nkfree(sup);\r\nif (err)\r\nreturn err;\r\ndbg_gen("default superblock created at LEB 0:0");\r\nmst = kzalloc(c->mst_node_alsz, GFP_KERNEL);\r\nif (!mst)\r\nreturn -ENOMEM;\r\nmst->ch.node_type = UBIFS_MST_NODE;\r\nmst->log_lnum = cpu_to_le32(UBIFS_LOG_LNUM);\r\nmst->highest_inum = cpu_to_le64(UBIFS_FIRST_INO);\r\nmst->cmt_no = 0;\r\nmst->root_lnum = cpu_to_le32(main_first + DEFAULT_IDX_LEB);\r\nmst->root_offs = 0;\r\ntmp = ubifs_idx_node_sz(c, 1);\r\nmst->root_len = cpu_to_le32(tmp);\r\nmst->gc_lnum = cpu_to_le32(main_first + DEFAULT_GC_LEB);\r\nmst->ihead_lnum = cpu_to_le32(main_first + DEFAULT_IDX_LEB);\r\nmst->ihead_offs = cpu_to_le32(ALIGN(tmp, c->min_io_size));\r\nmst->index_size = cpu_to_le64(ALIGN(tmp, 8));\r\nmst->lpt_lnum = cpu_to_le32(c->lpt_lnum);\r\nmst->lpt_offs = cpu_to_le32(c->lpt_offs);\r\nmst->nhead_lnum = cpu_to_le32(c->nhead_lnum);\r\nmst->nhead_offs = cpu_to_le32(c->nhead_offs);\r\nmst->ltab_lnum = cpu_to_le32(c->ltab_lnum);\r\nmst->ltab_offs = cpu_to_le32(c->ltab_offs);\r\nmst->lsave_lnum = cpu_to_le32(c->lsave_lnum);\r\nmst->lsave_offs = cpu_to_le32(c->lsave_offs);\r\nmst->lscan_lnum = cpu_to_le32(main_first);\r\nmst->empty_lebs = cpu_to_le32(main_lebs - 2);\r\nmst->idx_lebs = cpu_to_le32(1);\r\nmst->leb_cnt = cpu_to_le32(c->leb_cnt);\r\ntmp64 = main_bytes;\r\ntmp64 -= ALIGN(ubifs_idx_node_sz(c, 1), c->min_io_size);\r\ntmp64 -= ALIGN(UBIFS_INO_NODE_SZ, c->min_io_size);\r\nmst->total_free = cpu_to_le64(tmp64);\r\ntmp64 = ALIGN(ubifs_idx_node_sz(c, 1), c->min_io_size);\r\nino_waste = ALIGN(UBIFS_INO_NODE_SZ, c->min_io_size) -\r\nUBIFS_INO_NODE_SZ;\r\ntmp64 += ino_waste;\r\ntmp64 -= ALIGN(ubifs_idx_node_sz(c, 1), 8);\r\nmst->total_dirty = cpu_to_le64(tmp64);\r\ntmp64 = ((long long)(c->main_lebs - 1) * c->dark_wm);\r\nmst->total_dark = cpu_to_le64(tmp64);\r\nmst->total_used = cpu_to_le64(UBIFS_INO_NODE_SZ);\r\nerr = ubifs_write_node(c, mst, UBIFS_MST_NODE_SZ, UBIFS_MST_LNUM, 0);\r\nif (err) {\r\nkfree(mst);\r\nreturn err;\r\n}\r\nerr = ubifs_write_node(c, mst, UBIFS_MST_NODE_SZ, UBIFS_MST_LNUM + 1,\r\n0);\r\nkfree(mst);\r\nif (err)\r\nreturn err;\r\ndbg_gen("default master node created at LEB %d:0", UBIFS_MST_LNUM);\r\ntmp = ubifs_idx_node_sz(c, 1);\r\nidx = kzalloc(ALIGN(tmp, c->min_io_size), GFP_KERNEL);\r\nif (!idx)\r\nreturn -ENOMEM;\r\nc->key_fmt = UBIFS_SIMPLE_KEY_FMT;\r\nc->key_hash = key_r5_hash;\r\nidx->ch.node_type = UBIFS_IDX_NODE;\r\nidx->child_cnt = cpu_to_le16(1);\r\nino_key_init(c, &key, UBIFS_ROOT_INO);\r\nbr = ubifs_idx_branch(c, idx, 0);\r\nkey_write_idx(c, &key, &br->key);\r\nbr->lnum = cpu_to_le32(main_first + DEFAULT_DATA_LEB);\r\nbr->len = cpu_to_le32(UBIFS_INO_NODE_SZ);\r\nerr = ubifs_write_node(c, idx, tmp, main_first + DEFAULT_IDX_LEB, 0);\r\nkfree(idx);\r\nif (err)\r\nreturn err;\r\ndbg_gen("default root indexing node created LEB %d:0",\r\nmain_first + DEFAULT_IDX_LEB);\r\ntmp = ALIGN(UBIFS_INO_NODE_SZ, c->min_io_size);\r\nino = kzalloc(tmp, GFP_KERNEL);\r\nif (!ino)\r\nreturn -ENOMEM;\r\nino_key_init_flash(c, &ino->key, UBIFS_ROOT_INO);\r\nino->ch.node_type = UBIFS_INO_NODE;\r\nino->creat_sqnum = cpu_to_le64(++c->max_sqnum);\r\nino->nlink = cpu_to_le32(2);\r\ntmp_le64 = cpu_to_le64(CURRENT_TIME_SEC.tv_sec);\r\nino->atime_sec = tmp_le64;\r\nino->ctime_sec = tmp_le64;\r\nino->mtime_sec = tmp_le64;\r\nino->atime_nsec = 0;\r\nino->ctime_nsec = 0;\r\nino->mtime_nsec = 0;\r\nino->mode = cpu_to_le32(S_IFDIR | S_IRUGO | S_IWUSR | S_IXUGO);\r\nino->size = cpu_to_le64(UBIFS_INO_NODE_SZ);\r\nino->flags = cpu_to_le32(UBIFS_COMPR_FL);\r\nerr = ubifs_write_node(c, ino, UBIFS_INO_NODE_SZ,\r\nmain_first + DEFAULT_DATA_LEB, 0);\r\nkfree(ino);\r\nif (err)\r\nreturn err;\r\ndbg_gen("root inode created at LEB %d:0",\r\nmain_first + DEFAULT_DATA_LEB);\r\ntmp = ALIGN(UBIFS_CS_NODE_SZ, c->min_io_size);\r\ncs = kzalloc(tmp, GFP_KERNEL);\r\nif (!cs)\r\nreturn -ENOMEM;\r\ncs->ch.node_type = UBIFS_CS_NODE;\r\nerr = ubifs_write_node(c, cs, UBIFS_CS_NODE_SZ, UBIFS_LOG_LNUM, 0);\r\nkfree(cs);\r\nif (err)\r\nreturn err;\r\nubifs_msg("default file-system created");\r\nreturn 0;\r\n}\r\nstatic int validate_sb(struct ubifs_info *c, struct ubifs_sb_node *sup)\r\n{\r\nlong long max_bytes;\r\nint err = 1, min_leb_cnt;\r\nif (!c->key_hash) {\r\nerr = 2;\r\ngoto failed;\r\n}\r\nif (sup->key_fmt != UBIFS_SIMPLE_KEY_FMT) {\r\nerr = 3;\r\ngoto failed;\r\n}\r\nif (le32_to_cpu(sup->min_io_size) != c->min_io_size) {\r\nubifs_err("min. I/O unit mismatch: %d in superblock, %d real",\r\nle32_to_cpu(sup->min_io_size), c->min_io_size);\r\ngoto failed;\r\n}\r\nif (le32_to_cpu(sup->leb_size) != c->leb_size) {\r\nubifs_err("LEB size mismatch: %d in superblock, %d real",\r\nle32_to_cpu(sup->leb_size), c->leb_size);\r\ngoto failed;\r\n}\r\nif (c->log_lebs < UBIFS_MIN_LOG_LEBS ||\r\nc->lpt_lebs < UBIFS_MIN_LPT_LEBS ||\r\nc->orph_lebs < UBIFS_MIN_ORPH_LEBS ||\r\nc->main_lebs < UBIFS_MIN_MAIN_LEBS) {\r\nerr = 4;\r\ngoto failed;\r\n}\r\nmin_leb_cnt = UBIFS_SB_LEBS + UBIFS_MST_LEBS + c->log_lebs;\r\nmin_leb_cnt += c->lpt_lebs + c->orph_lebs + c->jhead_cnt + 6;\r\nif (c->leb_cnt < min_leb_cnt || c->leb_cnt > c->vi.size) {\r\nubifs_err("bad LEB count: %d in superblock, %d on UBI volume, %d minimum required",\r\nc->leb_cnt, c->vi.size, min_leb_cnt);\r\ngoto failed;\r\n}\r\nif (c->max_leb_cnt < c->leb_cnt) {\r\nubifs_err("max. LEB count %d less than LEB count %d",\r\nc->max_leb_cnt, c->leb_cnt);\r\ngoto failed;\r\n}\r\nif (c->main_lebs < UBIFS_MIN_MAIN_LEBS) {\r\nubifs_err("too few main LEBs count %d, must be at least %d",\r\nc->main_lebs, UBIFS_MIN_MAIN_LEBS);\r\ngoto failed;\r\n}\r\nmax_bytes = (long long)c->leb_size * UBIFS_MIN_BUD_LEBS;\r\nif (c->max_bud_bytes < max_bytes) {\r\nubifs_err("too small journal (%lld bytes), must be at least %lld bytes",\r\nc->max_bud_bytes, max_bytes);\r\ngoto failed;\r\n}\r\nmax_bytes = (long long)c->leb_size * c->main_lebs;\r\nif (c->max_bud_bytes > max_bytes) {\r\nubifs_err("too large journal size (%lld bytes), only %lld bytes available in the main area",\r\nc->max_bud_bytes, max_bytes);\r\ngoto failed;\r\n}\r\nif (c->jhead_cnt < NONDATA_JHEADS_CNT + 1 ||\r\nc->jhead_cnt > NONDATA_JHEADS_CNT + UBIFS_MAX_JHEADS) {\r\nerr = 9;\r\ngoto failed;\r\n}\r\nif (c->fanout < UBIFS_MIN_FANOUT ||\r\nubifs_idx_node_sz(c, c->fanout) > c->leb_size) {\r\nerr = 10;\r\ngoto failed;\r\n}\r\nif (c->lsave_cnt < 0 || (c->lsave_cnt > DEFAULT_LSAVE_CNT &&\r\nc->lsave_cnt > c->max_leb_cnt - UBIFS_SB_LEBS - UBIFS_MST_LEBS -\r\nc->log_lebs - c->lpt_lebs - c->orph_lebs)) {\r\nerr = 11;\r\ngoto failed;\r\n}\r\nif (UBIFS_SB_LEBS + UBIFS_MST_LEBS + c->log_lebs + c->lpt_lebs +\r\nc->orph_lebs + c->main_lebs != c->leb_cnt) {\r\nerr = 12;\r\ngoto failed;\r\n}\r\nif (c->default_compr >= UBIFS_COMPR_TYPES_CNT) {\r\nerr = 13;\r\ngoto failed;\r\n}\r\nif (c->rp_size < 0 || max_bytes < c->rp_size) {\r\nerr = 14;\r\ngoto failed;\r\n}\r\nif (le32_to_cpu(sup->time_gran) > 1000000000 ||\r\nle32_to_cpu(sup->time_gran) < 1) {\r\nerr = 15;\r\ngoto failed;\r\n}\r\nreturn 0;\r\nfailed:\r\nubifs_err("bad superblock, error %d", err);\r\nubifs_dump_node(c, sup);\r\nreturn -EINVAL;\r\n}\r\nstruct ubifs_sb_node *ubifs_read_sb_node(struct ubifs_info *c)\r\n{\r\nstruct ubifs_sb_node *sup;\r\nint err;\r\nsup = kmalloc(ALIGN(UBIFS_SB_NODE_SZ, c->min_io_size), GFP_NOFS);\r\nif (!sup)\r\nreturn ERR_PTR(-ENOMEM);\r\nerr = ubifs_read_node(c, sup, UBIFS_SB_NODE, UBIFS_SB_NODE_SZ,\r\nUBIFS_SB_LNUM, 0);\r\nif (err) {\r\nkfree(sup);\r\nreturn ERR_PTR(err);\r\n}\r\nreturn sup;\r\n}\r\nint ubifs_write_sb_node(struct ubifs_info *c, struct ubifs_sb_node *sup)\r\n{\r\nint len = ALIGN(UBIFS_SB_NODE_SZ, c->min_io_size);\r\nubifs_prepare_node(c, sup, UBIFS_SB_NODE_SZ, 1);\r\nreturn ubifs_leb_change(c, UBIFS_SB_LNUM, sup, len);\r\n}\r\nint ubifs_read_superblock(struct ubifs_info *c)\r\n{\r\nint err, sup_flags;\r\nstruct ubifs_sb_node *sup;\r\nif (c->empty) {\r\nerr = create_default_filesystem(c);\r\nif (err)\r\nreturn err;\r\n}\r\nsup = ubifs_read_sb_node(c);\r\nif (IS_ERR(sup))\r\nreturn PTR_ERR(sup);\r\nc->fmt_version = le32_to_cpu(sup->fmt_version);\r\nc->ro_compat_version = le32_to_cpu(sup->ro_compat_version);\r\nif (c->fmt_version > UBIFS_FORMAT_VERSION) {\r\nubifs_assert(!c->ro_media || c->ro_mount);\r\nif (!c->ro_mount ||\r\nc->ro_compat_version > UBIFS_RO_COMPAT_VERSION) {\r\nubifs_err("on-flash format version is w%d/r%d, but software only supports up to version w%d/r%d",\r\nc->fmt_version, c->ro_compat_version,\r\nUBIFS_FORMAT_VERSION,\r\nUBIFS_RO_COMPAT_VERSION);\r\nif (c->ro_compat_version <= UBIFS_RO_COMPAT_VERSION) {\r\nubifs_msg("only R/O mounting is possible");\r\nerr = -EROFS;\r\n} else\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\nc->rw_incompat = 1;\r\n}\r\nif (c->fmt_version < 3) {\r\nubifs_err("on-flash format version %d is not supported",\r\nc->fmt_version);\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\nswitch (sup->key_hash) {\r\ncase UBIFS_KEY_HASH_R5:\r\nc->key_hash = key_r5_hash;\r\nc->key_hash_type = UBIFS_KEY_HASH_R5;\r\nbreak;\r\ncase UBIFS_KEY_HASH_TEST:\r\nc->key_hash = key_test_hash;\r\nc->key_hash_type = UBIFS_KEY_HASH_TEST;\r\nbreak;\r\n};\r\nc->key_fmt = sup->key_fmt;\r\nswitch (c->key_fmt) {\r\ncase UBIFS_SIMPLE_KEY_FMT:\r\nc->key_len = UBIFS_SK_LEN;\r\nbreak;\r\ndefault:\r\nubifs_err("unsupported key format");\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\nc->leb_cnt = le32_to_cpu(sup->leb_cnt);\r\nc->max_leb_cnt = le32_to_cpu(sup->max_leb_cnt);\r\nc->max_bud_bytes = le64_to_cpu(sup->max_bud_bytes);\r\nc->log_lebs = le32_to_cpu(sup->log_lebs);\r\nc->lpt_lebs = le32_to_cpu(sup->lpt_lebs);\r\nc->orph_lebs = le32_to_cpu(sup->orph_lebs);\r\nc->jhead_cnt = le32_to_cpu(sup->jhead_cnt) + NONDATA_JHEADS_CNT;\r\nc->fanout = le32_to_cpu(sup->fanout);\r\nc->lsave_cnt = le32_to_cpu(sup->lsave_cnt);\r\nc->rp_size = le64_to_cpu(sup->rp_size);\r\nc->rp_uid = make_kuid(&init_user_ns, le32_to_cpu(sup->rp_uid));\r\nc->rp_gid = make_kgid(&init_user_ns, le32_to_cpu(sup->rp_gid));\r\nsup_flags = le32_to_cpu(sup->flags);\r\nif (!c->mount_opts.override_compr)\r\nc->default_compr = le16_to_cpu(sup->default_compr);\r\nc->vfs_sb->s_time_gran = le32_to_cpu(sup->time_gran);\r\nmemcpy(&c->uuid, &sup->uuid, 16);\r\nc->big_lpt = !!(sup_flags & UBIFS_FLG_BIGLPT);\r\nc->space_fixup = !!(sup_flags & UBIFS_FLG_SPACE_FIXUP);\r\nc->old_leb_cnt = c->leb_cnt;\r\nif (c->leb_cnt < c->vi.size && c->leb_cnt < c->max_leb_cnt) {\r\nc->leb_cnt = min_t(int, c->max_leb_cnt, c->vi.size);\r\nif (c->ro_mount)\r\ndbg_mnt("Auto resizing (ro) from %d LEBs to %d LEBs",\r\nc->old_leb_cnt, c->leb_cnt);\r\nelse {\r\ndbg_mnt("Auto resizing (sb) from %d LEBs to %d LEBs",\r\nc->old_leb_cnt, c->leb_cnt);\r\nsup->leb_cnt = cpu_to_le32(c->leb_cnt);\r\nerr = ubifs_write_sb_node(c, sup);\r\nif (err)\r\ngoto out;\r\nc->old_leb_cnt = c->leb_cnt;\r\n}\r\n}\r\nc->log_bytes = (long long)c->log_lebs * c->leb_size;\r\nc->log_last = UBIFS_LOG_LNUM + c->log_lebs - 1;\r\nc->lpt_first = UBIFS_LOG_LNUM + c->log_lebs;\r\nc->lpt_last = c->lpt_first + c->lpt_lebs - 1;\r\nc->orph_first = c->lpt_last + 1;\r\nc->orph_last = c->orph_first + c->orph_lebs - 1;\r\nc->main_lebs = c->leb_cnt - UBIFS_SB_LEBS - UBIFS_MST_LEBS;\r\nc->main_lebs -= c->log_lebs + c->lpt_lebs + c->orph_lebs;\r\nc->main_first = c->leb_cnt - c->main_lebs;\r\nerr = validate_sb(c, sup);\r\nout:\r\nkfree(sup);\r\nreturn err;\r\n}\r\nstatic int fixup_leb(struct ubifs_info *c, int lnum, int len)\r\n{\r\nint err;\r\nubifs_assert(len >= 0);\r\nubifs_assert(len % c->min_io_size == 0);\r\nubifs_assert(len < c->leb_size);\r\nif (len == 0) {\r\ndbg_mnt("unmap empty LEB %d", lnum);\r\nreturn ubifs_leb_unmap(c, lnum);\r\n}\r\ndbg_mnt("fixup LEB %d, data len %d", lnum, len);\r\nerr = ubifs_leb_read(c, lnum, c->sbuf, 0, len, 1);\r\nif (err)\r\nreturn err;\r\nreturn ubifs_leb_change(c, lnum, c->sbuf, len);\r\n}\r\nstatic int fixup_free_space(struct ubifs_info *c)\r\n{\r\nint lnum, err = 0;\r\nstruct ubifs_lprops *lprops;\r\nubifs_get_lprops(c);\r\nfor (lnum = UBIFS_MST_LNUM; lnum < UBIFS_LOG_LNUM; lnum++) {\r\nerr = fixup_leb(c, lnum, c->mst_offs + c->mst_node_alsz);\r\nif (err)\r\ngoto out;\r\n}\r\nlnum = ubifs_next_log_lnum(c, c->lhead_lnum);\r\nwhile (lnum != c->ltail_lnum) {\r\nerr = fixup_leb(c, lnum, 0);\r\nif (err)\r\ngoto out;\r\nlnum = ubifs_next_log_lnum(c, lnum);\r\n}\r\nerr = fixup_leb(c, c->lhead_lnum,\r\nALIGN(UBIFS_CS_NODE_SZ, c->min_io_size));\r\nif (err)\r\ngoto out;\r\nfor (lnum = c->lpt_first; lnum <= c->lpt_last; lnum++) {\r\nint free = c->ltab[lnum - c->lpt_first].free;\r\nif (free > 0) {\r\nerr = fixup_leb(c, lnum, c->leb_size - free);\r\nif (err)\r\ngoto out;\r\n}\r\n}\r\nfor (lnum = c->orph_first; lnum <= c->orph_last; lnum++) {\r\nerr = fixup_leb(c, lnum, 0);\r\nif (err)\r\ngoto out;\r\n}\r\nfor (lnum = c->main_first; lnum < c->leb_cnt; lnum++) {\r\nlprops = ubifs_lpt_lookup(c, lnum);\r\nif (IS_ERR(lprops)) {\r\nerr = PTR_ERR(lprops);\r\ngoto out;\r\n}\r\nif (lprops->free > 0) {\r\nerr = fixup_leb(c, lnum, c->leb_size - lprops->free);\r\nif (err)\r\ngoto out;\r\n}\r\n}\r\nout:\r\nubifs_release_lprops(c);\r\nreturn err;\r\n}\r\nint ubifs_fixup_free_space(struct ubifs_info *c)\r\n{\r\nint err;\r\nstruct ubifs_sb_node *sup;\r\nubifs_assert(c->space_fixup);\r\nubifs_assert(!c->ro_mount);\r\nubifs_msg("start fixing up free space");\r\nerr = fixup_free_space(c);\r\nif (err)\r\nreturn err;\r\nsup = ubifs_read_sb_node(c);\r\nif (IS_ERR(sup))\r\nreturn PTR_ERR(sup);\r\nc->space_fixup = 0;\r\nsup->flags &= cpu_to_le32(~UBIFS_FLG_SPACE_FIXUP);\r\nerr = ubifs_write_sb_node(c, sup);\r\nkfree(sup);\r\nif (err)\r\nreturn err;\r\nubifs_msg("free space fixup complete");\r\nreturn err;\r\n}

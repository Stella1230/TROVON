static int apci1564_timer_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\ndevpriv->tsk_current = current;\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nctrl &= 0xfffff9fe;\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nif (data[1] == 1) {\r\noutl(0x02, devpriv->timer + ADDI_TCW_CTRL_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\r\noutl(0x0, dev->iobase + APCI1564_DO_IRQ_REG);\r\noutl(0x0, dev->iobase + APCI1564_WDOG_IRQ_REG);\r\nif (devpriv->counters) {\r\nunsigned long iobase;\r\niobase = devpriv->counters + ADDI_TCW_IRQ_REG;\r\noutl(0x0, iobase + APCI1564_COUNTER(0));\r\noutl(0x0, iobase + APCI1564_COUNTER(1));\r\noutl(0x0, iobase + APCI1564_COUNTER(2));\r\n}\r\n} else {\r\noutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\r\n}\r\noutl(data[2], devpriv->timer + ADDI_TCW_TIMEBASE_REG);\r\noutl(data[3], devpriv->timer + ADDI_TCW_RELOAD_REG);\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nctrl &= 0xfff719e2;\r\nctrl |= (2 << 13) | 0x10;\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nswitch (data[1]) {\r\ncase 0:\r\nctrl &= 0xfffff9fe;\r\nbreak;\r\ncase 1:\r\nctrl &= 0xfffff9ff;\r\nctrl |= 0x1;\r\nbreak;\r\n}\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\ndata[0] = inl(devpriv->timer + ADDI_TCW_STATUS_REG) & 0x1;\r\ndata[1] = inl(devpriv->timer + ADDI_TCW_VAL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int ctrl;\r\ndevpriv->tsk_current = current;\r\nctrl = inl(iobase + ADDI_TCW_CTRL_REG);\r\nctrl &= 0xfffff9fe;\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\noutl(data[3], iobase + ADDI_TCW_RELOAD_REG);\r\nctrl &= 0xfffc19e2;\r\nctrl |= 0x80000 | (data[4] << 16);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nctrl &= 0xfffff9fd;\r\nctrl |= (data[1] << 1);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nctrl &= 0xfffbf9ff;\r\nctrl |= (data[6] << 18);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int ctrl;\r\nctrl = inl(iobase + ADDI_TCW_CTRL_REG);\r\nswitch (data[1]) {\r\ncase 0:\r\nctrl = 0;\r\nbreak;\r\ncase 1:\r\nctrl &= 0xfffff9ff;\r\nctrl |= 0x1;\r\nbreak;\r\ncase 2:\r\nctrl &= 0xfffff9ff;\r\nctrl |= 0x400;\r\nbreak;\r\n}\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int status;\r\ndata[0] = inl(iobase + ADDI_TCW_VAL_REG);\r\nstatus = inl(iobase + ADDI_TCW_STATUS_REG);\r\ndata[1] = (status >> 1) & 1;\r\ndata[2] = (status >> 2) & 1;\r\ndata[3] = (status >> 3) & 1;\r\ndata[4] = (status >> 0) & 1;\r\nreturn insn->n;\r\n}

static int tpo_td043_write(struct spi_device *spi, u8 addr, u8 data)\r\n{\r\nstruct spi_message m;\r\nstruct spi_transfer xfer;\r\nu16 w;\r\nint r;\r\nspi_message_init(&m);\r\nmemset(&xfer, 0, sizeof(xfer));\r\nw = ((u16)addr << 10) | (1 << 8) | data;\r\nxfer.tx_buf = &w;\r\nxfer.bits_per_word = 16;\r\nxfer.len = 2;\r\nspi_message_add_tail(&xfer, &m);\r\nr = spi_sync(spi, &m);\r\nif (r < 0)\r\ndev_warn(&spi->dev, "failed to write to LCD reg (%d)\n", r);\r\nreturn r;\r\n}\r\nstatic void tpo_td043_write_gamma(struct spi_device *spi, u16 gamma[12])\r\n{\r\nu8 i, val;\r\nfor (val = i = 0; i < 4; i++)\r\nval |= (gamma[i] & 0x300) >> ((i + 1) * 2);\r\ntpo_td043_write(spi, 0x11, val);\r\nfor (val = i = 0; i < 4; i++)\r\nval |= (gamma[i+4] & 0x300) >> ((i + 1) * 2);\r\ntpo_td043_write(spi, 0x12, val);\r\nfor (val = i = 0; i < 4; i++)\r\nval |= (gamma[i+8] & 0x300) >> ((i + 1) * 2);\r\ntpo_td043_write(spi, 0x13, val);\r\nfor (val = i = 0; i < 12; i++)\r\ntpo_td043_write(spi, 0x14 + i, gamma[i] & 0xff);\r\n}\r\nstatic int tpo_td043_write_mirror(struct spi_device *spi, bool h, bool v)\r\n{\r\nu8 reg4 = TPO_R04_NFLIP_H | TPO_R04_NFLIP_V |\r\nTPO_R04_CP_CLK_FREQ_1H | TPO_R04_VGL_FREQ_1H;\r\nif (h)\r\nreg4 &= ~TPO_R04_NFLIP_H;\r\nif (v)\r\nreg4 &= ~TPO_R04_NFLIP_V;\r\nreturn tpo_td043_write(spi, 4, reg4);\r\n}\r\nstatic int tpo_td043_set_hmirror(struct omap_dss_device *dssdev, bool enable)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dssdev->dev);\r\nddata->hmirror = enable;\r\nreturn tpo_td043_write_mirror(ddata->spi, ddata->hmirror,\r\nddata->vmirror);\r\n}\r\nstatic bool tpo_td043_get_hmirror(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dssdev->dev);\r\nreturn ddata->hmirror;\r\n}\r\nstatic ssize_t tpo_td043_vmirror_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", ddata->vmirror);\r\n}\r\nstatic ssize_t tpo_td043_vmirror_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nint val;\r\nint ret;\r\nret = kstrtoint(buf, 0, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval = !!val;\r\nret = tpo_td043_write_mirror(ddata->spi, ddata->hmirror, val);\r\nif (ret < 0)\r\nreturn ret;\r\nddata->vmirror = val;\r\nreturn count;\r\n}\r\nstatic ssize_t tpo_td043_mode_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", ddata->mode);\r\n}\r\nstatic ssize_t tpo_td043_mode_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nlong val;\r\nint ret;\r\nret = kstrtol(buf, 0, &val);\r\nif (ret != 0 || val & ~7)\r\nreturn -EINVAL;\r\nddata->mode = val;\r\nval |= TPO_R02_NCLK_RISING;\r\ntpo_td043_write(ddata->spi, 2, val);\r\nreturn count;\r\n}\r\nstatic ssize_t tpo_td043_gamma_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nssize_t len = 0;\r\nint ret;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ddata->gamma); i++) {\r\nret = snprintf(buf + len, PAGE_SIZE - len, "%u ",\r\nddata->gamma[i]);\r\nif (ret < 0)\r\nreturn ret;\r\nlen += ret;\r\n}\r\nbuf[len - 1] = '\n';\r\nreturn len;\r\n}\r\nstatic ssize_t tpo_td043_gamma_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nunsigned int g[12];\r\nint ret;\r\nint i;\r\nret = sscanf(buf, "%u %u %u %u %u %u %u %u %u %u %u %u",\r\n&g[0], &g[1], &g[2], &g[3], &g[4], &g[5],\r\n&g[6], &g[7], &g[8], &g[9], &g[10], &g[11]);\r\nif (ret != 12)\r\nreturn -EINVAL;\r\nfor (i = 0; i < 12; i++)\r\nddata->gamma[i] = g[i];\r\ntpo_td043_write_gamma(ddata->spi, ddata->gamma);\r\nreturn count;\r\n}\r\nstatic int tpo_td043_power_on(struct panel_drv_data *ddata)\r\n{\r\nint r;\r\nif (ddata->powered_on)\r\nreturn 0;\r\nr = regulator_enable(ddata->vcc_reg);\r\nif (r != 0)\r\nreturn r;\r\nmsleep(160);\r\nif (gpio_is_valid(ddata->nreset_gpio))\r\ngpio_set_value(ddata->nreset_gpio, 1);\r\ntpo_td043_write(ddata->spi, 2,\r\nTPO_R02_MODE(ddata->mode) | TPO_R02_NCLK_RISING);\r\ntpo_td043_write(ddata->spi, 3, TPO_R03_VAL_NORMAL);\r\ntpo_td043_write(ddata->spi, 0x20, 0xf0);\r\ntpo_td043_write(ddata->spi, 0x21, 0xf0);\r\ntpo_td043_write_mirror(ddata->spi, ddata->hmirror,\r\nddata->vmirror);\r\ntpo_td043_write_gamma(ddata->spi, ddata->gamma);\r\nddata->powered_on = 1;\r\nreturn 0;\r\n}\r\nstatic void tpo_td043_power_off(struct panel_drv_data *ddata)\r\n{\r\nif (!ddata->powered_on)\r\nreturn;\r\ntpo_td043_write(ddata->spi, 3,\r\nTPO_R03_VAL_STANDBY | TPO_R03_EN_PWM);\r\nif (gpio_is_valid(ddata->nreset_gpio))\r\ngpio_set_value(ddata->nreset_gpio, 0);\r\nmsleep(50);\r\ntpo_td043_write(ddata->spi, 3, TPO_R03_VAL_STANDBY);\r\nregulator_disable(ddata->vcc_reg);\r\nddata->powered_on = 0;\r\n}\r\nstatic int tpo_td043_connect(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nint r;\r\nif (omapdss_device_is_connected(dssdev))\r\nreturn 0;\r\nr = in->ops.dpi->connect(in, dssdev);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nstatic void tpo_td043_disconnect(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nif (!omapdss_device_is_connected(dssdev))\r\nreturn;\r\nin->ops.dpi->disconnect(in, dssdev);\r\n}\r\nstatic int tpo_td043_enable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nint r;\r\nif (!omapdss_device_is_connected(dssdev))\r\nreturn -ENODEV;\r\nif (omapdss_device_is_enabled(dssdev))\r\nreturn 0;\r\nif (ddata->data_lines)\r\nin->ops.dpi->set_data_lines(in, ddata->data_lines);\r\nin->ops.dpi->set_timings(in, &ddata->videomode);\r\nr = in->ops.dpi->enable(in);\r\nif (r)\r\nreturn r;\r\nif (!ddata->spi_suspended) {\r\nr = tpo_td043_power_on(ddata);\r\nif (r) {\r\nin->ops.dpi->disable(in);\r\nreturn r;\r\n}\r\n}\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nreturn 0;\r\n}\r\nstatic void tpo_td043_disable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nif (!omapdss_device_is_enabled(dssdev))\r\nreturn;\r\nin->ops.dpi->disable(in);\r\nif (!ddata->spi_suspended)\r\ntpo_td043_power_off(ddata);\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\n}\r\nstatic void tpo_td043_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nddata->videomode = *timings;\r\ndssdev->panel.timings = *timings;\r\nin->ops.dpi->set_timings(in, timings);\r\n}\r\nstatic void tpo_td043_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\n*timings = ddata->videomode;\r\n}\r\nstatic int tpo_td043_check_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = to_panel_data(dssdev);\r\nstruct omap_dss_device *in = ddata->in;\r\nreturn in->ops.dpi->check_timings(in, timings);\r\n}\r\nstatic int tpo_td043_probe_pdata(struct spi_device *spi)\r\n{\r\nconst struct panel_tpo_td043mtea1_platform_data *pdata;\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&spi->dev);\r\nstruct omap_dss_device *dssdev, *in;\r\npdata = dev_get_platdata(&spi->dev);\r\nddata->nreset_gpio = pdata->nreset_gpio;\r\nin = omap_dss_find_output(pdata->source);\r\nif (in == NULL) {\r\ndev_err(&spi->dev, "failed to find video source '%s'\n",\r\npdata->source);\r\nreturn -EPROBE_DEFER;\r\n}\r\nddata->in = in;\r\nddata->data_lines = pdata->data_lines;\r\ndssdev = &ddata->dssdev;\r\ndssdev->name = pdata->name;\r\nreturn 0;\r\n}\r\nstatic int tpo_td043_probe_of(struct spi_device *spi)\r\n{\r\nstruct device_node *node = spi->dev.of_node;\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&spi->dev);\r\nstruct omap_dss_device *in;\r\nint gpio;\r\ngpio = of_get_named_gpio(node, "reset-gpios", 0);\r\nif (!gpio_is_valid(gpio)) {\r\ndev_err(&spi->dev, "failed to parse enable gpio\n");\r\nreturn gpio;\r\n}\r\nddata->nreset_gpio = gpio;\r\nin = omapdss_of_find_source_for_first_ep(node);\r\nif (IS_ERR(in)) {\r\ndev_err(&spi->dev, "failed to find video source\n");\r\nreturn PTR_ERR(in);\r\n}\r\nddata->in = in;\r\nreturn 0;\r\n}\r\nstatic int tpo_td043_probe(struct spi_device *spi)\r\n{\r\nstruct panel_drv_data *ddata;\r\nstruct omap_dss_device *dssdev;\r\nint r;\r\ndev_dbg(&spi->dev, "%s\n", __func__);\r\nspi->bits_per_word = 16;\r\nspi->mode = SPI_MODE_0;\r\nr = spi_setup(spi);\r\nif (r < 0) {\r\ndev_err(&spi->dev, "spi_setup failed: %d\n", r);\r\nreturn r;\r\n}\r\nddata = devm_kzalloc(&spi->dev, sizeof(*ddata), GFP_KERNEL);\r\nif (ddata == NULL)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&spi->dev, ddata);\r\nddata->spi = spi;\r\nif (dev_get_platdata(&spi->dev)) {\r\nr = tpo_td043_probe_pdata(spi);\r\nif (r)\r\nreturn r;\r\n} else if (spi->dev.of_node) {\r\nr = tpo_td043_probe_of(spi);\r\nif (r)\r\nreturn r;\r\n} else {\r\nreturn -ENODEV;\r\n}\r\nddata->mode = TPO_R02_MODE_800x480;\r\nmemcpy(ddata->gamma, tpo_td043_def_gamma, sizeof(ddata->gamma));\r\nddata->vcc_reg = devm_regulator_get(&spi->dev, "vcc");\r\nif (IS_ERR(ddata->vcc_reg)) {\r\ndev_err(&spi->dev, "failed to get LCD VCC regulator\n");\r\nr = PTR_ERR(ddata->vcc_reg);\r\ngoto err_regulator;\r\n}\r\nif (gpio_is_valid(ddata->nreset_gpio)) {\r\nr = devm_gpio_request_one(&spi->dev,\r\nddata->nreset_gpio, GPIOF_OUT_INIT_LOW,\r\n"lcd reset");\r\nif (r < 0) {\r\ndev_err(&spi->dev, "couldn't request reset GPIO\n");\r\ngoto err_gpio_req;\r\n}\r\n}\r\nr = sysfs_create_group(&spi->dev.kobj, &tpo_td043_attr_group);\r\nif (r) {\r\ndev_err(&spi->dev, "failed to create sysfs files\n");\r\ngoto err_sysfs;\r\n}\r\nddata->videomode = tpo_td043_timings;\r\ndssdev = &ddata->dssdev;\r\ndssdev->dev = &spi->dev;\r\ndssdev->driver = &tpo_td043_ops;\r\ndssdev->type = OMAP_DISPLAY_TYPE_DPI;\r\ndssdev->owner = THIS_MODULE;\r\ndssdev->panel.timings = ddata->videomode;\r\nr = omapdss_register_display(dssdev);\r\nif (r) {\r\ndev_err(&spi->dev, "Failed to register panel\n");\r\ngoto err_reg;\r\n}\r\nreturn 0;\r\nerr_reg:\r\nsysfs_remove_group(&spi->dev.kobj, &tpo_td043_attr_group);\r\nerr_sysfs:\r\nerr_gpio_req:\r\nerr_regulator:\r\nomap_dss_put_device(ddata->in);\r\nreturn r;\r\n}\r\nstatic int tpo_td043_remove(struct spi_device *spi)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&spi->dev);\r\nstruct omap_dss_device *dssdev = &ddata->dssdev;\r\nstruct omap_dss_device *in = ddata->in;\r\ndev_dbg(&ddata->spi->dev, "%s\n", __func__);\r\nomapdss_unregister_display(dssdev);\r\ntpo_td043_disable(dssdev);\r\ntpo_td043_disconnect(dssdev);\r\nomap_dss_put_device(in);\r\nsysfs_remove_group(&spi->dev.kobj, &tpo_td043_attr_group);\r\nreturn 0;\r\n}\r\nstatic int tpo_td043_spi_suspend(struct device *dev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\ndev_dbg(dev, "tpo_td043_spi_suspend, tpo %p\n", ddata);\r\nddata->power_on_resume = ddata->powered_on;\r\ntpo_td043_power_off(ddata);\r\nddata->spi_suspended = 1;\r\nreturn 0;\r\n}\r\nstatic int tpo_td043_spi_resume(struct device *dev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(dev);\r\nint ret;\r\ndev_dbg(dev, "tpo_td043_spi_resume\n");\r\nif (ddata->power_on_resume) {\r\nret = tpo_td043_power_on(ddata);\r\nif (ret)\r\nreturn ret;\r\n}\r\nddata->spi_suspended = 0;\r\nreturn 0;\r\n}

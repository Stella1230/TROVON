static ssize_t set_pwm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nunsigned long pwm, duty;\r\nssize_t ret;\r\nif (kstrtoul(buf, 10, &pwm) || pwm > MAX_PWM)\r\nreturn -EINVAL;\r\nmutex_lock(&ctx->lock);\r\nif (ctx->pwm_value == pwm)\r\ngoto exit_set_pwm_no_change;\r\nif (pwm == 0) {\r\npwm_disable(ctx->pwm);\r\ngoto exit_set_pwm;\r\n}\r\nduty = DIV_ROUND_UP(pwm * (ctx->pwm->period - 1), MAX_PWM);\r\nret = pwm_config(ctx->pwm, duty, ctx->pwm->period);\r\nif (ret)\r\ngoto exit_set_pwm_err;\r\nif (ctx->pwm_value == 0) {\r\nret = pwm_enable(ctx->pwm);\r\nif (ret)\r\ngoto exit_set_pwm_err;\r\n}\r\nexit_set_pwm:\r\nctx->pwm_value = pwm;\r\nexit_set_pwm_no_change:\r\nret = count;\r\nexit_set_pwm_err:\r\nmutex_unlock(&ctx->lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_pwm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ctx->pwm_value);\r\n}\r\nstatic int pwm_fan_probe(struct platform_device *pdev)\r\n{\r\nstruct device *hwmon;\r\nstruct pwm_fan_ctx *ctx;\r\nint duty_cycle;\r\nint ret;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nmutex_init(&ctx->lock);\r\nctx->pwm = devm_of_pwm_get(&pdev->dev, pdev->dev.of_node, NULL);\r\nif (IS_ERR(ctx->pwm)) {\r\ndev_err(&pdev->dev, "Could not get PWM\n");\r\nreturn PTR_ERR(ctx->pwm);\r\n}\r\nplatform_set_drvdata(pdev, ctx);\r\nduty_cycle = ctx->pwm->period - 1;\r\nctx->pwm_value = MAX_PWM;\r\nret = pwm_config(ctx->pwm, duty_cycle, ctx->pwm->period);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to configure PWM\n");\r\nreturn ret;\r\n}\r\nret = pwm_enable(ctx->pwm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to enable PWM\n");\r\nreturn ret;\r\n}\r\nhwmon = devm_hwmon_device_register_with_groups(&pdev->dev, "pwmfan",\r\nctx, pwm_fan_groups);\r\nif (IS_ERR(hwmon)) {\r\ndev_err(&pdev->dev, "Failed to register hwmon device\n");\r\npwm_disable(ctx->pwm);\r\nreturn PTR_ERR(hwmon);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_remove(struct platform_device *pdev)\r\n{\r\nstruct pwm_fan_ctx *ctx = platform_get_drvdata(pdev);\r\nif (ctx->pwm_value)\r\npwm_disable(ctx->pwm);\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_suspend(struct device *dev)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nif (ctx->pwm_value)\r\npwm_disable(ctx->pwm);\r\nreturn 0;\r\n}\r\nstatic int pwm_fan_resume(struct device *dev)\r\n{\r\nstruct pwm_fan_ctx *ctx = dev_get_drvdata(dev);\r\nunsigned long duty;\r\nint ret;\r\nif (ctx->pwm_value == 0)\r\nreturn 0;\r\nduty = DIV_ROUND_UP(ctx->pwm_value * (ctx->pwm->period - 1), MAX_PWM);\r\nret = pwm_config(ctx->pwm, duty, ctx->pwm->period);\r\nif (ret)\r\nreturn ret;\r\nreturn pwm_enable(ctx->pwm);\r\n}

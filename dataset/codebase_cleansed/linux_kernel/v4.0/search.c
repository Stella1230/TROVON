int pci_for_each_dma_alias(struct pci_dev *pdev,\r\nint (*fn)(struct pci_dev *pdev,\r\nu16 alias, void *data), void *data)\r\n{\r\nstruct pci_bus *bus;\r\nint ret;\r\nret = fn(pdev, PCI_DEVID(pdev->bus->number, pdev->devfn), data);\r\nif (ret)\r\nreturn ret;\r\nif (unlikely(pdev->dev_flags & PCI_DEV_FLAGS_DMA_ALIAS_DEVFN)) {\r\nret = fn(pdev, PCI_DEVID(pdev->bus->number,\r\npdev->dma_alias_devfn), data);\r\nif (ret)\r\nreturn ret;\r\n}\r\nfor (bus = pdev->bus; !pci_is_root_bus(bus); bus = bus->parent) {\r\nstruct pci_dev *tmp;\r\nif (!bus->self)\r\ncontinue;\r\ntmp = bus->self;\r\nif (pci_is_pcie(tmp)) {\r\nswitch (pci_pcie_type(tmp)) {\r\ncase PCI_EXP_TYPE_ROOT_PORT:\r\ncase PCI_EXP_TYPE_UPSTREAM:\r\ncase PCI_EXP_TYPE_DOWNSTREAM:\r\ncontinue;\r\ncase PCI_EXP_TYPE_PCI_BRIDGE:\r\nret = fn(tmp,\r\nPCI_DEVID(tmp->subordinate->number,\r\nPCI_DEVFN(0, 0)), data);\r\nif (ret)\r\nreturn ret;\r\ncontinue;\r\ncase PCI_EXP_TYPE_PCIE_BRIDGE:\r\nret = fn(tmp,\r\nPCI_DEVID(tmp->bus->number,\r\ntmp->devfn), data);\r\nif (ret)\r\nreturn ret;\r\ncontinue;\r\n}\r\n} else {\r\nif (tmp->dev_flags & PCI_DEV_FLAG_PCIE_BRIDGE_ALIAS)\r\nret = fn(tmp,\r\nPCI_DEVID(tmp->subordinate->number,\r\nPCI_DEVFN(0, 0)), data);\r\nelse\r\nret = fn(tmp,\r\nPCI_DEVID(tmp->bus->number,\r\ntmp->devfn), data);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic struct pci_bus *pci_do_find_bus(struct pci_bus *bus, unsigned char busnr)\r\n{\r\nstruct pci_bus *child;\r\nstruct pci_bus *tmp;\r\nif (bus->number == busnr)\r\nreturn bus;\r\nlist_for_each_entry(tmp, &bus->children, node) {\r\nchild = pci_do_find_bus(tmp, busnr);\r\nif (child)\r\nreturn child;\r\n}\r\nreturn NULL;\r\n}\r\nstruct pci_bus *pci_find_bus(int domain, int busnr)\r\n{\r\nstruct pci_bus *bus = NULL;\r\nstruct pci_bus *tmp_bus;\r\nwhile ((bus = pci_find_next_bus(bus)) != NULL) {\r\nif (pci_domain_nr(bus) != domain)\r\ncontinue;\r\ntmp_bus = pci_do_find_bus(bus, busnr);\r\nif (tmp_bus)\r\nreturn tmp_bus;\r\n}\r\nreturn NULL;\r\n}\r\nstruct pci_bus *pci_find_next_bus(const struct pci_bus *from)\r\n{\r\nstruct list_head *n;\r\nstruct pci_bus *b = NULL;\r\nWARN_ON(in_interrupt());\r\ndown_read(&pci_bus_sem);\r\nn = from ? from->node.next : pci_root_buses.next;\r\nif (n != &pci_root_buses)\r\nb = list_entry(n, struct pci_bus, node);\r\nup_read(&pci_bus_sem);\r\nreturn b;\r\n}\r\nstruct pci_dev *pci_get_slot(struct pci_bus *bus, unsigned int devfn)\r\n{\r\nstruct pci_dev *dev;\r\nWARN_ON(in_interrupt());\r\ndown_read(&pci_bus_sem);\r\nlist_for_each_entry(dev, &bus->devices, bus_list) {\r\nif (dev->devfn == devfn)\r\ngoto out;\r\n}\r\ndev = NULL;\r\nout:\r\npci_dev_get(dev);\r\nup_read(&pci_bus_sem);\r\nreturn dev;\r\n}\r\nstruct pci_dev *pci_get_domain_bus_and_slot(int domain, unsigned int bus,\r\nunsigned int devfn)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nfor_each_pci_dev(dev) {\r\nif (pci_domain_nr(dev->bus) == domain &&\r\n(dev->bus->number == bus && dev->devfn == devfn))\r\nreturn dev;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int match_pci_dev_by_id(struct device *dev, void *data)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct pci_device_id *id = data;\r\nif (pci_match_one_device(id, pdev))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic struct pci_dev *pci_get_dev_by_id(const struct pci_device_id *id,\r\nstruct pci_dev *from)\r\n{\r\nstruct device *dev;\r\nstruct device *dev_start = NULL;\r\nstruct pci_dev *pdev = NULL;\r\nWARN_ON(in_interrupt());\r\nif (from)\r\ndev_start = &from->dev;\r\ndev = bus_find_device(&pci_bus_type, dev_start, (void *)id,\r\nmatch_pci_dev_by_id);\r\nif (dev)\r\npdev = to_pci_dev(dev);\r\npci_dev_put(from);\r\nreturn pdev;\r\n}\r\nstruct pci_dev *pci_get_subsys(unsigned int vendor, unsigned int device,\r\nunsigned int ss_vendor, unsigned int ss_device,\r\nstruct pci_dev *from)\r\n{\r\nstruct pci_device_id id = {\r\n.vendor = vendor,\r\n.device = device,\r\n.subvendor = ss_vendor,\r\n.subdevice = ss_device,\r\n};\r\nreturn pci_get_dev_by_id(&id, from);\r\n}\r\nstruct pci_dev *pci_get_device(unsigned int vendor, unsigned int device,\r\nstruct pci_dev *from)\r\n{\r\nreturn pci_get_subsys(vendor, device, PCI_ANY_ID, PCI_ANY_ID, from);\r\n}\r\nstruct pci_dev *pci_get_class(unsigned int class, struct pci_dev *from)\r\n{\r\nstruct pci_device_id id = {\r\n.vendor = PCI_ANY_ID,\r\n.device = PCI_ANY_ID,\r\n.subvendor = PCI_ANY_ID,\r\n.subdevice = PCI_ANY_ID,\r\n.class_mask = PCI_ANY_ID,\r\n.class = class,\r\n};\r\nreturn pci_get_dev_by_id(&id, from);\r\n}\r\nint pci_dev_present(const struct pci_device_id *ids)\r\n{\r\nstruct pci_dev *found = NULL;\r\nWARN_ON(in_interrupt());\r\nwhile (ids->vendor || ids->subvendor || ids->class_mask) {\r\nfound = pci_get_dev_by_id(ids, NULL);\r\nif (found) {\r\npci_dev_put(found);\r\nreturn 1;\r\n}\r\nids++;\r\n}\r\nreturn 0;\r\n}

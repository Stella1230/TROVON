static inline cycles_t get_cycles_inline(void)\r\n{\r\nunsigned int high = __insn_mfspr(SPR_CYCLE_HIGH);\r\nunsigned int low = __insn_mfspr(SPR_CYCLE_LOW);\r\nunsigned int high2 = __insn_mfspr(SPR_CYCLE_HIGH);\r\nwhile (unlikely(high != high2)) {\r\nlow = __insn_mfspr(SPR_CYCLE_LOW);\r\nhigh = high2;\r\nhigh2 = __insn_mfspr(SPR_CYCLE_HIGH);\r\n}\r\nreturn (((cycles_t)high) << 32) | low;\r\n}\r\ninline unsigned long get_datapage(void)\r\n{\r\nunsigned long ret;\r\nasm volatile ("lnk %0" : "=r"(ret));\r\nret &= ~(PAGE_SIZE - 1);\r\nret += PAGE_SIZE;\r\nreturn ret;\r\n}\r\nstatic inline u64 vgetsns(struct vdso_data *vdso)\r\n{\r\nreturn ((get_cycles() - vdso->cycle_last) & vdso->mask) * vdso->mult;\r\n}\r\nstatic inline int do_realtime(struct vdso_data *vdso, struct timespec *ts)\r\n{\r\nunsigned count;\r\nu64 ns;\r\ndo {\r\ncount = read_seqcount_begin(&vdso->tb_seq);\r\nts->tv_sec = vdso->wall_time_sec;\r\nns = vdso->wall_time_snsec;\r\nns += vgetsns(vdso);\r\nns >>= vdso->shift;\r\n} while (unlikely(read_seqcount_retry(&vdso->tb_seq, count)));\r\nts->tv_sec += __iter_div_u64_rem(ns, NSEC_PER_SEC, &ns);\r\nts->tv_nsec = ns;\r\nreturn 0;\r\n}\r\nstatic inline int do_monotonic(struct vdso_data *vdso, struct timespec *ts)\r\n{\r\nunsigned count;\r\nu64 ns;\r\ndo {\r\ncount = read_seqcount_begin(&vdso->tb_seq);\r\nts->tv_sec = vdso->monotonic_time_sec;\r\nns = vdso->monotonic_time_snsec;\r\nns += vgetsns(vdso);\r\nns >>= vdso->shift;\r\n} while (unlikely(read_seqcount_retry(&vdso->tb_seq, count)));\r\nts->tv_sec += __iter_div_u64_rem(ns, NSEC_PER_SEC, &ns);\r\nts->tv_nsec = ns;\r\nreturn 0;\r\n}\r\nstatic inline int do_realtime_coarse(struct vdso_data *vdso,\r\nstruct timespec *ts)\r\n{\r\nunsigned count;\r\ndo {\r\ncount = read_seqcount_begin(&vdso->tb_seq);\r\nts->tv_sec = vdso->wall_time_coarse_sec;\r\nts->tv_nsec = vdso->wall_time_coarse_nsec;\r\n} while (unlikely(read_seqcount_retry(&vdso->tb_seq, count)));\r\nreturn 0;\r\n}\r\nstatic inline int do_monotonic_coarse(struct vdso_data *vdso,\r\nstruct timespec *ts)\r\n{\r\nunsigned count;\r\ndo {\r\ncount = read_seqcount_begin(&vdso->tb_seq);\r\nts->tv_sec = vdso->monotonic_time_coarse_sec;\r\nts->tv_nsec = vdso->monotonic_time_coarse_nsec;\r\n} while (unlikely(read_seqcount_retry(&vdso->tb_seq, count)));\r\nreturn 0;\r\n}\r\nstruct syscall_return_value __vdso_gettimeofday(struct timeval *tv,\r\nstruct timezone *tz)\r\n{\r\nstruct syscall_return_value ret = { 0, 0 };\r\nunsigned count;\r\nstruct vdso_data *vdso = (struct vdso_data *)get_datapage();\r\nif (unlikely(tz != NULL)) {\r\ndo {\r\ncount = read_seqcount_begin(&vdso->tz_seq);\r\ntz->tz_minuteswest = vdso->tz_minuteswest;\r\ntz->tz_dsttime = vdso->tz_dsttime;\r\n} while (unlikely(read_seqcount_retry(&vdso->tz_seq, count)));\r\n}\r\nif (unlikely(tv == NULL))\r\nreturn ret;\r\ndo_realtime(vdso, (struct timespec *)tv);\r\ntv->tv_usec /= 1000;\r\nreturn ret;\r\n}\r\nstatic struct syscall_return_value vdso_fallback_gettime(long clock,\r\nstruct timespec *ts)\r\n{\r\nstruct syscall_return_value ret;\r\n__asm__ __volatile__ (\r\n"swint1"\r\n: "=R00" (ret.value), "=R01" (ret.error)\r\n: "R10" (__NR_clock_gettime), "R00" (clock), "R01" (ts)\r\n: "r2", "r3", "r4", "r5", "r6", "r7",\r\n"r8", "r9", "r11", "r12", "r13", "r14", "r15",\r\n"r16", "r17", "r18", "r19", "r20", "r21", "r22", "r23",\r\n"r24", "r25", "r26", "r27", "r28", "r29", "memory");\r\nreturn ret;\r\n}\r\nstruct syscall_return_value __vdso_clock_gettime(clockid_t clock,\r\nstruct timespec *ts)\r\n{\r\nstruct vdso_data *vdso = (struct vdso_data *)get_datapage();\r\nstruct syscall_return_value ret = { 0, 0 };\r\nswitch (clock) {\r\ncase CLOCK_REALTIME:\r\ndo_realtime(vdso, ts);\r\nreturn ret;\r\ncase CLOCK_MONOTONIC:\r\ndo_monotonic(vdso, ts);\r\nreturn ret;\r\ncase CLOCK_REALTIME_COARSE:\r\ndo_realtime_coarse(vdso, ts);\r\nreturn ret;\r\ncase CLOCK_MONOTONIC_COARSE:\r\ndo_monotonic_coarse(vdso, ts);\r\nreturn ret;\r\ndefault:\r\nreturn vdso_fallback_gettime(clock, ts);\r\n}\r\n}

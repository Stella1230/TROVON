static int ryos_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct roccat_common2_device *ryos;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= RYOS_USB_INTERFACE_PROTOCOL) {\r\nhid_set_drvdata(hdev, NULL);\r\nreturn 0;\r\n}\r\nryos = kzalloc(sizeof(*ryos), GFP_KERNEL);\r\nif (!ryos) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, ryos);\r\nretval = roccat_common2_device_init_struct(usb_dev, ryos);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init Ryos device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(ryos_class, hdev,\r\nsizeof(struct ryos_report_special));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nryos->chrdev_minor = retval;\r\nryos->roccat_claimed = 1;\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(ryos);\r\nreturn retval;\r\n}\r\nstatic void ryos_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *ryos;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= RYOS_USB_INTERFACE_PROTOCOL)\r\nreturn;\r\nryos = hid_get_drvdata(hdev);\r\nif (ryos->roccat_claimed)\r\nroccat_disconnect(ryos->chrdev_minor);\r\nkfree(ryos);\r\n}\r\nstatic int ryos_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = ryos_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void ryos_remove(struct hid_device *hdev)\r\n{\r\nryos_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic int ryos_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *ryos = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= RYOS_USB_INTERFACE_PROTOCOL)\r\nreturn 0;\r\nif (data[0] != RYOS_REPORT_NUMBER_SPECIAL)\r\nreturn 0;\r\nif (ryos != NULL && ryos->roccat_claimed)\r\nroccat_report_event(ryos->chrdev_minor, data);\r\nreturn 0;\r\n}\r\nstatic int __init ryos_init(void)\r\n{\r\nint retval;\r\nryos_class = class_create(THIS_MODULE, "ryos");\r\nif (IS_ERR(ryos_class))\r\nreturn PTR_ERR(ryos_class);\r\nryos_class->dev_groups = ryos_groups;\r\nretval = hid_register_driver(&ryos_driver);\r\nif (retval)\r\nclass_destroy(ryos_class);\r\nreturn retval;\r\n}\r\nstatic void __exit ryos_exit(void)\r\n{\r\nhid_unregister_driver(&ryos_driver);\r\nclass_destroy(ryos_class);\r\n}

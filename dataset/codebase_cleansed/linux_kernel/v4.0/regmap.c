unsigned long *vcpu_reg32(const struct kvm_vcpu *vcpu, u8 reg_num)\r\n{\r\nunsigned long *reg_array = (unsigned long *)&vcpu->arch.ctxt.gp_regs.regs;\r\nunsigned long mode = *vcpu_cpsr(vcpu) & COMPAT_PSR_MODE_MASK;\r\nswitch (mode) {\r\ncase COMPAT_PSR_MODE_USR ... COMPAT_PSR_MODE_SVC:\r\nmode &= ~PSR_MODE32_BIT;\r\nbreak;\r\ncase COMPAT_PSR_MODE_ABT:\r\nmode = 4;\r\nbreak;\r\ncase COMPAT_PSR_MODE_UND:\r\nmode = 5;\r\nbreak;\r\ncase COMPAT_PSR_MODE_SYS:\r\nmode = 0;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn reg_array + vcpu_reg_offsets[mode][reg_num];\r\n}\r\nunsigned long *vcpu_spsr32(const struct kvm_vcpu *vcpu)\r\n{\r\nunsigned long mode = *vcpu_cpsr(vcpu) & COMPAT_PSR_MODE_MASK;\r\nswitch (mode) {\r\ncase COMPAT_PSR_MODE_SVC:\r\nmode = KVM_SPSR_SVC;\r\nbreak;\r\ncase COMPAT_PSR_MODE_ABT:\r\nmode = KVM_SPSR_ABT;\r\nbreak;\r\ncase COMPAT_PSR_MODE_UND:\r\nmode = KVM_SPSR_UND;\r\nbreak;\r\ncase COMPAT_PSR_MODE_IRQ:\r\nmode = KVM_SPSR_IRQ;\r\nbreak;\r\ncase COMPAT_PSR_MODE_FIQ:\r\nmode = KVM_SPSR_FIQ;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn (unsigned long *)&vcpu_gp_regs(vcpu)->spsr[mode];\r\n}

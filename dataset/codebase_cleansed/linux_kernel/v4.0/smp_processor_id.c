notrace static unsigned int check_preemption_disabled(const char *what1,\r\nconst char *what2)\r\n{\r\nint this_cpu = raw_smp_processor_id();\r\nif (likely(preempt_count()))\r\ngoto out;\r\nif (irqs_disabled())\r\ngoto out;\r\nif (cpumask_equal(tsk_cpus_allowed(current), cpumask_of(this_cpu)))\r\ngoto out;\r\nif (system_state != SYSTEM_RUNNING)\r\ngoto out;\r\npreempt_disable_notrace();\r\nif (!printk_ratelimit())\r\ngoto out_enable;\r\nprintk(KERN_ERR "BUG: using %s%s() in preemptible [%08x] code: %s/%d\n",\r\nwhat1, what2, preempt_count() - 1, current->comm, current->pid);\r\nprint_symbol("caller is %s\n", (long)__builtin_return_address(0));\r\ndump_stack();\r\nout_enable:\r\npreempt_enable_no_resched_notrace();\r\nout:\r\nreturn this_cpu;\r\n}\r\nnotrace unsigned int debug_smp_processor_id(void)\r\n{\r\nreturn check_preemption_disabled("smp_processor_id", "");\r\n}\r\nnotrace void __this_cpu_preempt_check(const char *op)\r\n{\r\ncheck_preemption_disabled("__this_cpu_", op);\r\n}

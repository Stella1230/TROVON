static void\r\ndefault_handler(int segment, struct pt_regs *regp)\r\n{\r\nset_personality(0);\r\nif (current_thread_info()->exec_domain->handler != default_handler)\r\ncurrent_thread_info()->exec_domain->handler(segment, regp);\r\nelse\r\nsend_sig(SIGSEGV, current, 1);\r\n}\r\nstatic struct exec_domain *\r\nlookup_exec_domain(unsigned int personality)\r\n{\r\nunsigned int pers = personality(personality);\r\nstruct exec_domain *ep;\r\nread_lock(&exec_domains_lock);\r\nfor (ep = exec_domains; ep; ep = ep->next) {\r\nif (pers >= ep->pers_low && pers <= ep->pers_high)\r\nif (try_module_get(ep->module))\r\ngoto out;\r\n}\r\n#ifdef CONFIG_MODULES\r\nread_unlock(&exec_domains_lock);\r\nrequest_module("personality-%d", pers);\r\nread_lock(&exec_domains_lock);\r\nfor (ep = exec_domains; ep; ep = ep->next) {\r\nif (pers >= ep->pers_low && pers <= ep->pers_high)\r\nif (try_module_get(ep->module))\r\ngoto out;\r\n}\r\n#endif\r\nep = &default_exec_domain;\r\nout:\r\nread_unlock(&exec_domains_lock);\r\nreturn ep;\r\n}\r\nint\r\nregister_exec_domain(struct exec_domain *ep)\r\n{\r\nstruct exec_domain *tmp;\r\nint err = -EBUSY;\r\nif (ep == NULL)\r\nreturn -EINVAL;\r\nif (ep->next != NULL)\r\nreturn -EBUSY;\r\nwrite_lock(&exec_domains_lock);\r\nfor (tmp = exec_domains; tmp; tmp = tmp->next) {\r\nif (tmp == ep)\r\ngoto out;\r\n}\r\nep->next = exec_domains;\r\nexec_domains = ep;\r\nerr = 0;\r\nout:\r\nwrite_unlock(&exec_domains_lock);\r\nreturn err;\r\n}\r\nint\r\nunregister_exec_domain(struct exec_domain *ep)\r\n{\r\nstruct exec_domain **epp;\r\nepp = &exec_domains;\r\nwrite_lock(&exec_domains_lock);\r\nfor (epp = &exec_domains; *epp; epp = &(*epp)->next) {\r\nif (ep == *epp)\r\ngoto unregister;\r\n}\r\nwrite_unlock(&exec_domains_lock);\r\nreturn -EINVAL;\r\nunregister:\r\n*epp = ep->next;\r\nep->next = NULL;\r\nwrite_unlock(&exec_domains_lock);\r\nreturn 0;\r\n}\r\nint __set_personality(unsigned int personality)\r\n{\r\nstruct exec_domain *oep = current_thread_info()->exec_domain;\r\ncurrent_thread_info()->exec_domain = lookup_exec_domain(personality);\r\ncurrent->personality = personality;\r\nmodule_put(oep->module);\r\nreturn 0;\r\n}\r\nstatic int execdomains_proc_show(struct seq_file *m, void *v)\r\n{\r\nstruct exec_domain *ep;\r\nread_lock(&exec_domains_lock);\r\nfor (ep = exec_domains; ep; ep = ep->next)\r\nseq_printf(m, "%d-%d\t%-16s\t[%s]\n",\r\nep->pers_low, ep->pers_high, ep->name,\r\nmodule_name(ep->module));\r\nread_unlock(&exec_domains_lock);\r\nreturn 0;\r\n}\r\nstatic int execdomains_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, execdomains_proc_show, NULL);\r\n}\r\nstatic int __init proc_execdomains_init(void)\r\n{\r\nproc_create("execdomains", 0, NULL, &execdomains_proc_fops);\r\nreturn 0;\r\n}

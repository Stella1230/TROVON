static void scm_notify(struct scm_device *scmdev, enum scm_event event)\r\n{\r\nstruct scm_blk_dev *bdev = dev_get_drvdata(&scmdev->dev);\r\nswitch (event) {\r\ncase SCM_CHANGE:\r\npr_info("%lx: The capabilities of the SCM increment changed\n",\r\n(unsigned long) scmdev->address);\r\nSCM_LOG(2, "State changed");\r\nSCM_LOG_STATE(2, scmdev);\r\nbreak;\r\ncase SCM_AVAIL:\r\nSCM_LOG(2, "Increment available");\r\nSCM_LOG_STATE(2, scmdev);\r\nscm_blk_set_available(bdev);\r\nbreak;\r\n}\r\n}\r\nstatic int scm_probe(struct scm_device *scmdev)\r\n{\r\nstruct scm_blk_dev *bdev;\r\nint ret;\r\nSCM_LOG(2, "probe");\r\nSCM_LOG_STATE(2, scmdev);\r\nif (scmdev->attrs.oper_state != OP_STATE_GOOD)\r\nreturn -EINVAL;\r\nbdev = kzalloc(sizeof(*bdev), GFP_KERNEL);\r\nif (!bdev)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&scmdev->dev, bdev);\r\nret = scm_blk_dev_setup(bdev, scmdev);\r\nif (ret) {\r\ndev_set_drvdata(&scmdev->dev, NULL);\r\nkfree(bdev);\r\ngoto out;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int scm_remove(struct scm_device *scmdev)\r\n{\r\nstruct scm_blk_dev *bdev = dev_get_drvdata(&scmdev->dev);\r\nscm_blk_dev_cleanup(bdev);\r\ndev_set_drvdata(&scmdev->dev, NULL);\r\nkfree(bdev);\r\nreturn 0;\r\n}\r\nint __init scm_drv_init(void)\r\n{\r\nreturn scm_driver_register(&scm_drv);\r\n}\r\nvoid scm_drv_cleanup(void)\r\n{\r\nscm_driver_unregister(&scm_drv);\r\n}

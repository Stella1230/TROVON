int pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nint pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nreturn ((pin + slot) % 4)+ MIPS_IRQ_PCIA;\r\n}\r\nstatic void pci_virtio_guest_write_config_addr(struct pci_bus *bus,\r\nunsigned int devfn, int reg)\r\n{\r\nunion pci_config_address pca = { .w = 0 };\r\npca.register_number = reg;\r\npca.devfn_number = devfn;\r\npca.bus_number = bus->number;\r\npca.enable_bit = 1;\r\noutl(pca.w, PCI_CONFIG_ADDRESS);\r\n}\r\nstatic int pci_virtio_guest_write_config(struct pci_bus *bus,\r\nunsigned int devfn, int reg, int size, u32 val)\r\n{\r\npci_virtio_guest_write_config_addr(bus, devfn, reg);\r\nswitch (size) {\r\ncase 1:\r\noutb(val, PCI_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\noutw(val, PCI_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\noutl(val, PCI_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pci_virtio_guest_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 *val)\r\n{\r\npci_virtio_guest_write_config_addr(bus, devfn, reg);\r\nswitch (size) {\r\ncase 1:\r\n*val = inb(PCI_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\n*val = inw(PCI_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\n*val = inl(PCI_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int __init pci_virtio_guest_setup(void)\r\n{\r\npr_err("pci_virtio_guest_setup\n");\r\npci_set_flags(PCI_PROBE_ONLY);\r\npci_virtio_guest_controller.io_map_base = mips_io_port_base;\r\nregister_pci_controller(&pci_virtio_guest_controller);\r\nreturn 0;\r\n}

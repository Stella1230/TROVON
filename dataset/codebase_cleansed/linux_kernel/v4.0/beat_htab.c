static inline unsigned int beat_read_mask(unsigned hpte_group)\r\n{\r\nunsigned long rmask = 0;\r\nu64 hpte_v[5];\r\nbeat_read_htab_entries(0, hpte_group + 0, hpte_v);\r\nif (!(hpte_v[0] & HPTE_V_BOLTED))\r\nrmask |= 0x8000;\r\nif (!(hpte_v[1] & HPTE_V_BOLTED))\r\nrmask |= 0x4000;\r\nif (!(hpte_v[2] & HPTE_V_BOLTED))\r\nrmask |= 0x2000;\r\nif (!(hpte_v[3] & HPTE_V_BOLTED))\r\nrmask |= 0x1000;\r\nbeat_read_htab_entries(0, hpte_group + 4, hpte_v);\r\nif (!(hpte_v[0] & HPTE_V_BOLTED))\r\nrmask |= 0x0800;\r\nif (!(hpte_v[1] & HPTE_V_BOLTED))\r\nrmask |= 0x0400;\r\nif (!(hpte_v[2] & HPTE_V_BOLTED))\r\nrmask |= 0x0200;\r\nif (!(hpte_v[3] & HPTE_V_BOLTED))\r\nrmask |= 0x0100;\r\nhpte_group = ~hpte_group & (htab_hash_mask * HPTES_PER_GROUP);\r\nbeat_read_htab_entries(0, hpte_group + 0, hpte_v);\r\nif (!(hpte_v[0] & HPTE_V_BOLTED))\r\nrmask |= 0x80;\r\nif (!(hpte_v[1] & HPTE_V_BOLTED))\r\nrmask |= 0x40;\r\nif (!(hpte_v[2] & HPTE_V_BOLTED))\r\nrmask |= 0x20;\r\nif (!(hpte_v[3] & HPTE_V_BOLTED))\r\nrmask |= 0x10;\r\nbeat_read_htab_entries(0, hpte_group + 4, hpte_v);\r\nif (!(hpte_v[0] & HPTE_V_BOLTED))\r\nrmask |= 0x08;\r\nif (!(hpte_v[1] & HPTE_V_BOLTED))\r\nrmask |= 0x04;\r\nif (!(hpte_v[2] & HPTE_V_BOLTED))\r\nrmask |= 0x02;\r\nif (!(hpte_v[3] & HPTE_V_BOLTED))\r\nrmask |= 0x01;\r\nreturn rmask;\r\n}\r\nstatic long beat_lpar_hpte_insert(unsigned long hpte_group,\r\nunsigned long vpn, unsigned long pa,\r\nunsigned long rflags, unsigned long vflags,\r\nint psize, int apsize, int ssize)\r\n{\r\nunsigned long lpar_rc;\r\nu64 hpte_v, hpte_r, slot;\r\nif (vflags & HPTE_V_SECONDARY)\r\nreturn -1;\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW("hpte_insert(group=%lx, va=%016lx, pa=%016lx, "\r\n"rflags=%lx, vflags=%lx, psize=%d)\n",\r\nhpte_group, va, pa, rflags, vflags, psize);\r\nhpte_v = hpte_encode_v(vpn, psize, apsize, MMU_SEGSIZE_256M) |\r\nvflags | HPTE_V_VALID;\r\nhpte_r = hpte_encode_r(pa, psize, apsize) | rflags;\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" hpte_v=%016lx, hpte_r=%016lx\n", hpte_v, hpte_r);\r\nif (rflags & _PAGE_NO_CACHE)\r\nhpte_r &= ~HPTE_R_M;\r\nraw_spin_lock(&beat_htab_lock);\r\nlpar_rc = beat_read_mask(hpte_group);\r\nif (lpar_rc == 0) {\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" full\n");\r\nraw_spin_unlock(&beat_htab_lock);\r\nreturn -1;\r\n}\r\nlpar_rc = beat_insert_htab_entry(0, hpte_group, lpar_rc << 48,\r\nhpte_v, hpte_r, &slot);\r\nraw_spin_unlock(&beat_htab_lock);\r\nif (unlikely(lpar_rc != 0)) {\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" lpar err %lx\n", lpar_rc);\r\nreturn -2;\r\n}\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" -> slot: %lx\n", slot);\r\nreturn (slot ^ hpte_group) & 15;\r\n}\r\nstatic long beat_lpar_hpte_remove(unsigned long hpte_group)\r\n{\r\nDBG_LOW("hpte_remove(group=%lx)\n", hpte_group);\r\nreturn -1;\r\n}\r\nstatic unsigned long beat_lpar_hpte_getword0(unsigned long slot)\r\n{\r\nunsigned long dword0;\r\nunsigned long lpar_rc;\r\nu64 dword[5];\r\nlpar_rc = beat_read_htab_entries(0, slot & ~3UL, dword);\r\ndword0 = dword[slot&3];\r\nBUG_ON(lpar_rc != 0);\r\nreturn dword0;\r\n}\r\nstatic void beat_lpar_hptab_clear(void)\r\n{\r\nunsigned long size_bytes = 1UL << ppc64_pft_size;\r\nunsigned long hpte_count = size_bytes >> 4;\r\nint i;\r\nu64 dummy0, dummy1;\r\nfor (i = 0; i < hpte_count; i++)\r\nbeat_write_htab_entry(0, i, 0, 0, -1UL, -1UL, &dummy0, &dummy1);\r\n}\r\nstatic long beat_lpar_hpte_updatepp(unsigned long slot,\r\nunsigned long newpp,\r\nunsigned long vpn,\r\nint psize, int apsize,\r\nint ssize, unsigned long flags)\r\n{\r\nunsigned long lpar_rc;\r\nu64 dummy0, dummy1;\r\nunsigned long want_v;\r\nwant_v = hpte_encode_avpn(vpn, psize, MMU_SEGSIZE_256M);\r\nDBG_LOW(" update: "\r\n"avpnv=%016lx, slot=%016lx, psize: %d, newpp %016lx ... ",\r\nwant_v & HPTE_V_AVPN, slot, psize, newpp);\r\nraw_spin_lock(&beat_htab_lock);\r\ndummy0 = beat_lpar_hpte_getword0(slot);\r\nif ((dummy0 & ~0x7FUL) != (want_v & ~0x7FUL)) {\r\nDBG_LOW("not found !\n");\r\nraw_spin_unlock(&beat_htab_lock);\r\nreturn -1;\r\n}\r\nlpar_rc = beat_write_htab_entry(0, slot, 0, newpp, 0, 7, &dummy0,\r\n&dummy1);\r\nraw_spin_unlock(&beat_htab_lock);\r\nif (lpar_rc != 0 || dummy0 == 0) {\r\nDBG_LOW("not found !\n");\r\nreturn -1;\r\n}\r\nDBG_LOW("ok %lx %lx\n", dummy0, dummy1);\r\nBUG_ON(lpar_rc != 0);\r\nreturn 0;\r\n}\r\nstatic long beat_lpar_hpte_find(unsigned long vpn, int psize)\r\n{\r\nunsigned long hash;\r\nunsigned long i, j;\r\nlong slot;\r\nunsigned long want_v, hpte_v;\r\nhash = hpt_hash(vpn, mmu_psize_defs[psize].shift, MMU_SEGSIZE_256M);\r\nwant_v = hpte_encode_avpn(vpn, psize, MMU_SEGSIZE_256M);\r\nfor (j = 0; j < 2; j++) {\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nfor (i = 0; i < HPTES_PER_GROUP; i++) {\r\nhpte_v = beat_lpar_hpte_getword0(slot);\r\nif (HPTE_V_COMPARE(hpte_v, want_v)\r\n&& (hpte_v & HPTE_V_VALID)\r\n&& (!!(hpte_v & HPTE_V_SECONDARY) == j)) {\r\nif (j)\r\nslot = -slot;\r\nreturn slot;\r\n}\r\n++slot;\r\n}\r\nhash = ~hash;\r\n}\r\nreturn -1;\r\n}\r\nstatic void beat_lpar_hpte_updateboltedpp(unsigned long newpp,\r\nunsigned long ea,\r\nint psize, int ssize)\r\n{\r\nunsigned long vpn;\r\nunsigned long lpar_rc, slot, vsid;\r\nu64 dummy0, dummy1;\r\nvsid = get_kernel_vsid(ea, MMU_SEGSIZE_256M);\r\nvpn = hpt_vpn(ea, vsid, MMU_SEGSIZE_256M);\r\nraw_spin_lock(&beat_htab_lock);\r\nslot = beat_lpar_hpte_find(vpn, psize);\r\nBUG_ON(slot == -1);\r\nlpar_rc = beat_write_htab_entry(0, slot, 0, newpp, 0, 7,\r\n&dummy0, &dummy1);\r\nraw_spin_unlock(&beat_htab_lock);\r\nBUG_ON(lpar_rc != 0);\r\n}\r\nstatic void beat_lpar_hpte_invalidate(unsigned long slot, unsigned long vpn,\r\nint psize, int apsize,\r\nint ssize, int local)\r\n{\r\nunsigned long want_v;\r\nunsigned long lpar_rc;\r\nu64 dummy1, dummy2;\r\nunsigned long flags;\r\nDBG_LOW(" inval : slot=%lx, va=%016lx, psize: %d, local: %d\n",\r\nslot, va, psize, local);\r\nwant_v = hpte_encode_avpn(vpn, psize, MMU_SEGSIZE_256M);\r\nraw_spin_lock_irqsave(&beat_htab_lock, flags);\r\ndummy1 = beat_lpar_hpte_getword0(slot);\r\nif ((dummy1 & ~0x7FUL) != (want_v & ~0x7FUL)) {\r\nDBG_LOW("not found !\n");\r\nraw_spin_unlock_irqrestore(&beat_htab_lock, flags);\r\nreturn;\r\n}\r\nlpar_rc = beat_write_htab_entry(0, slot, 0, 0, HPTE_V_VALID, 0,\r\n&dummy1, &dummy2);\r\nraw_spin_unlock_irqrestore(&beat_htab_lock, flags);\r\nBUG_ON(lpar_rc != 0);\r\n}\r\nvoid __init hpte_init_beat(void)\r\n{\r\nppc_md.hpte_invalidate = beat_lpar_hpte_invalidate;\r\nppc_md.hpte_updatepp = beat_lpar_hpte_updatepp;\r\nppc_md.hpte_updateboltedpp = beat_lpar_hpte_updateboltedpp;\r\nppc_md.hpte_insert = beat_lpar_hpte_insert;\r\nppc_md.hpte_remove = beat_lpar_hpte_remove;\r\nppc_md.hpte_clear_all = beat_lpar_hptab_clear;\r\n}\r\nstatic long beat_lpar_hpte_insert_v3(unsigned long hpte_group,\r\nunsigned long vpn, unsigned long pa,\r\nunsigned long rflags, unsigned long vflags,\r\nint psize, int apsize, int ssize)\r\n{\r\nunsigned long lpar_rc;\r\nu64 hpte_v, hpte_r, slot;\r\nif (vflags & HPTE_V_SECONDARY)\r\nreturn -1;\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW("hpte_insert(group=%lx, vpn=%016lx, pa=%016lx, "\r\n"rflags=%lx, vflags=%lx, psize=%d)\n",\r\nhpte_group, vpn, pa, rflags, vflags, psize);\r\nhpte_v = hpte_encode_v(vpn, psize, apsize, MMU_SEGSIZE_256M) |\r\nvflags | HPTE_V_VALID;\r\nhpte_r = hpte_encode_r(pa, psize, apsize) | rflags;\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" hpte_v=%016lx, hpte_r=%016lx\n", hpte_v, hpte_r);\r\nif (rflags & _PAGE_NO_CACHE)\r\nhpte_r &= ~HPTE_R_M;\r\nlpar_rc = beat_insert_htab_entry3(0, hpte_group, hpte_v, hpte_r,\r\nHPTE_V_BOLTED, 0, &slot);\r\nif (unlikely(lpar_rc != 0)) {\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" lpar err %lx\n", lpar_rc);\r\nreturn -2;\r\n}\r\nif (!(vflags & HPTE_V_BOLTED))\r\nDBG_LOW(" -> slot: %lx\n", slot);\r\nreturn (slot ^ hpte_group) & 15;\r\n}\r\nstatic long beat_lpar_hpte_updatepp_v3(unsigned long slot,\r\nunsigned long newpp,\r\nunsigned long vpn,\r\nint psize, int apsize,\r\nint ssize, unsigned long flags)\r\n{\r\nunsigned long lpar_rc;\r\nunsigned long want_v;\r\nunsigned long pss;\r\nwant_v = hpte_encode_avpn(vpn, psize, MMU_SEGSIZE_256M);\r\npss = (psize == MMU_PAGE_4K) ? -1UL : mmu_psize_defs[psize].penc[psize];\r\nDBG_LOW(" update: "\r\n"avpnv=%016lx, slot=%016lx, psize: %d, newpp %016lx ... ",\r\nwant_v & HPTE_V_AVPN, slot, psize, newpp);\r\nlpar_rc = beat_update_htab_permission3(0, slot, want_v, pss, 7, newpp);\r\nif (lpar_rc == 0xfffffff7) {\r\nDBG_LOW("not found !\n");\r\nreturn -1;\r\n}\r\nDBG_LOW("ok\n");\r\nBUG_ON(lpar_rc != 0);\r\nreturn 0;\r\n}\r\nstatic void beat_lpar_hpte_invalidate_v3(unsigned long slot, unsigned long vpn,\r\nint psize, int apsize,\r\nint ssize, int local)\r\n{\r\nunsigned long want_v;\r\nunsigned long lpar_rc;\r\nunsigned long pss;\r\nDBG_LOW(" inval : slot=%lx, vpn=%016lx, psize: %d, local: %d\n",\r\nslot, vpn, psize, local);\r\nwant_v = hpte_encode_avpn(vpn, psize, MMU_SEGSIZE_256M);\r\npss = (psize == MMU_PAGE_4K) ? -1UL : mmu_psize_defs[psize].penc[psize];\r\nlpar_rc = beat_invalidate_htab_entry3(0, slot, want_v, pss);\r\nBUG_ON(lpar_rc != 0 && lpar_rc != 0xfffffff7);\r\n}\r\nstatic int64_t _beat_lpar_hptab_clear_v3(void)\r\n{\r\nreturn beat_clear_htab3(0);\r\n}\r\nstatic void beat_lpar_hptab_clear_v3(void)\r\n{\r\n_beat_lpar_hptab_clear_v3();\r\n}\r\nvoid __init hpte_init_beat_v3(void)\r\n{\r\nif (_beat_lpar_hptab_clear_v3() == 0) {\r\nppc_md.hpte_invalidate = beat_lpar_hpte_invalidate_v3;\r\nppc_md.hpte_updatepp = beat_lpar_hpte_updatepp_v3;\r\nppc_md.hpte_updateboltedpp = beat_lpar_hpte_updateboltedpp;\r\nppc_md.hpte_insert = beat_lpar_hpte_insert_v3;\r\nppc_md.hpte_remove = beat_lpar_hpte_remove;\r\nppc_md.hpte_clear_all = beat_lpar_hptab_clear_v3;\r\n} else {\r\nppc_md.hpte_invalidate = beat_lpar_hpte_invalidate;\r\nppc_md.hpte_updatepp = beat_lpar_hpte_updatepp;\r\nppc_md.hpte_updateboltedpp = beat_lpar_hpte_updateboltedpp;\r\nppc_md.hpte_insert = beat_lpar_hpte_insert;\r\nppc_md.hpte_remove = beat_lpar_hpte_remove;\r\nppc_md.hpte_clear_all = beat_lpar_hptab_clear;\r\n}\r\n}

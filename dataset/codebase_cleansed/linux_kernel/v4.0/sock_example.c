static int test_sock(void)\r\n{\r\nint sock = -1, map_fd, prog_fd, i, key;\r\nlong long value = 0, tcp_cnt, udp_cnt, icmp_cnt;\r\nmap_fd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(key), sizeof(value),\r\n256);\r\nif (map_fd < 0) {\r\nprintf("failed to create map '%s'\n", strerror(errno));\r\ngoto cleanup;\r\n}\r\nstruct bpf_insn prog[] = {\r\nBPF_MOV64_REG(BPF_REG_6, BPF_REG_1),\r\nBPF_LD_ABS(BPF_B, ETH_HLEN + offsetof(struct iphdr, protocol) ),\r\nBPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),\r\nBPF_MOV64_REG(BPF_REG_2, BPF_REG_10),\r\nBPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),\r\nBPF_LD_MAP_FD(BPF_REG_1, map_fd),\r\nBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),\r\nBPF_JMP_IMM(BPF_JEQ, BPF_REG_0, 0, 2),\r\nBPF_MOV64_IMM(BPF_REG_1, 1),\r\nBPF_RAW_INSN(BPF_STX | BPF_XADD | BPF_DW, BPF_REG_0, BPF_REG_1, 0, 0),\r\nBPF_MOV64_IMM(BPF_REG_0, 0),\r\nBPF_EXIT_INSN(),\r\n};\r\nprog_fd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, prog, sizeof(prog),\r\n"GPL");\r\nif (prog_fd < 0) {\r\nprintf("failed to load prog '%s'\n", strerror(errno));\r\ngoto cleanup;\r\n}\r\nsock = open_raw_sock("lo");\r\nif (setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, &prog_fd,\r\nsizeof(prog_fd)) < 0) {\r\nprintf("setsockopt %s\n", strerror(errno));\r\ngoto cleanup;\r\n}\r\nfor (i = 0; i < 10; i++) {\r\nkey = IPPROTO_TCP;\r\nassert(bpf_lookup_elem(map_fd, &key, &tcp_cnt) == 0);\r\nkey = IPPROTO_UDP;\r\nassert(bpf_lookup_elem(map_fd, &key, &udp_cnt) == 0);\r\nkey = IPPROTO_ICMP;\r\nassert(bpf_lookup_elem(map_fd, &key, &icmp_cnt) == 0);\r\nprintf("TCP %lld UDP %lld ICMP %lld packets\n",\r\ntcp_cnt, udp_cnt, icmp_cnt);\r\nsleep(1);\r\n}\r\ncleanup:\r\nreturn 0;\r\n}\r\nint main(void)\r\n{\r\nFILE *f;\r\nf = popen("ping -c5 localhost", "r");\r\n(void)f;\r\nreturn test_sock();\r\n}

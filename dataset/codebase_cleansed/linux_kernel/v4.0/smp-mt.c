static void __init smvp_copy_vpe_config(void)\r\n{\r\nwrite_vpe_c0_status(\r\n(read_c0_status() & ~(ST0_IM | ST0_IE | ST0_KSU)) | ST0_CU0);\r\nwrite_vpe_c0_config( read_c0_config());\r\nwrite_vpe_c0_cause(0);\r\nwrite_vpe_c0_config7(read_c0_config7());\r\nwrite_vpe_c0_count(read_c0_count());\r\n}\r\nstatic unsigned int __init smvp_vpe_init(unsigned int tc, unsigned int mvpconf0,\r\nunsigned int ncpu)\r\n{\r\nif (tc > ((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT))\r\nreturn ncpu;\r\nif (tc != 0) {\r\nunsigned long tmp = read_vpe_c0_vpeconf0();\r\ntmp &= ~VPECONF0_VPA;\r\ntmp |= VPECONF0_MVP;\r\nwrite_vpe_c0_vpeconf0(tmp);\r\nset_cpu_possible(tc, true);\r\nset_cpu_present(tc, true);\r\n__cpu_number_map[tc] = ++ncpu;\r\n__cpu_logical_map[ncpu] = tc;\r\n}\r\nwrite_vpe_c0_vpecontrol(read_vpe_c0_vpecontrol() & ~VPECONTROL_TE);\r\nif (tc != 0)\r\nsmvp_copy_vpe_config();\r\nreturn ncpu;\r\n}\r\nstatic void __init smvp_tc_init(unsigned int tc, unsigned int mvpconf0)\r\n{\r\nunsigned long tmp;\r\nif (!tc)\r\nreturn;\r\nif (tc >= (((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT)+1))\r\nwrite_tc_c0_tcbind(read_tc_c0_tcbind() | ((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT));\r\nelse {\r\nwrite_tc_c0_tcbind(read_tc_c0_tcbind() | tc);\r\nwrite_vpe_c0_vpeconf0(read_vpe_c0_vpeconf0() | (tc << VPECONF0_XTC_SHIFT));\r\n}\r\ntmp = read_tc_c0_tcstatus();\r\ntmp &= ~(TCSTATUS_A | TCSTATUS_DA);\r\ntmp |= TCSTATUS_IXMT;\r\nwrite_tc_c0_tcstatus(tmp);\r\nwrite_tc_c0_tchalt(TCHALT_H);\r\n}\r\nstatic void vsmp_send_ipi_single(int cpu, unsigned int action)\r\n{\r\nint i;\r\nunsigned long flags;\r\nint vpflags;\r\n#ifdef CONFIG_MIPS_GIC\r\nif (gic_present) {\r\ngic_send_ipi_single(cpu, action);\r\nreturn;\r\n}\r\n#endif\r\nlocal_irq_save(flags);\r\nvpflags = dvpe();\r\nswitch (action) {\r\ncase SMP_CALL_FUNCTION:\r\ni = C_SW1;\r\nbreak;\r\ncase SMP_RESCHEDULE_YOURSELF:\r\ndefault:\r\ni = C_SW0;\r\nbreak;\r\n}\r\nsettc(cpu);\r\nwrite_vpe_c0_cause(read_vpe_c0_cause() | i);\r\nevpe(vpflags);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void vsmp_send_ipi_mask(const struct cpumask *mask, unsigned int action)\r\n{\r\nunsigned int i;\r\nfor_each_cpu(i, mask)\r\nvsmp_send_ipi_single(i, action);\r\n}\r\nstatic void vsmp_init_secondary(void)\r\n{\r\n#ifdef CONFIG_MIPS_GIC\r\nif (gic_present)\r\nchange_c0_status(ST0_IM, STATUSF_IP2 | STATUSF_IP3 |\r\nSTATUSF_IP4 | STATUSF_IP5 |\r\nSTATUSF_IP6 | STATUSF_IP7);\r\nelse\r\n#endif\r\nchange_c0_status(ST0_IM, STATUSF_IP0 | STATUSF_IP1 |\r\nSTATUSF_IP6 | STATUSF_IP7);\r\n}\r\nstatic void vsmp_smp_finish(void)\r\n{\r\nwrite_c0_compare(read_c0_count() + (8* mips_hpt_frequency/HZ));\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(smp_processor_id(), mt_fpu_cpumask);\r\n#endif\r\nlocal_irq_enable();\r\n}\r\nstatic void vsmp_boot_secondary(int cpu, struct task_struct *idle)\r\n{\r\nstruct thread_info *gp = task_thread_info(idle);\r\ndvpe();\r\nset_c0_mvpcontrol(MVPCONTROL_VPC);\r\nsettc(cpu);\r\nwrite_tc_c0_tcrestart((unsigned long)&smp_bootstrap);\r\nwrite_tc_c0_tcstatus((read_tc_c0_tcstatus() & ~TCSTATUS_IXMT) | TCSTATUS_A);\r\nwrite_tc_c0_tchalt(0);\r\nwrite_vpe_c0_vpeconf0(read_vpe_c0_vpeconf0() | VPECONF0_VPA);\r\nwrite_tc_gpr_sp( __KSTK_TOS(idle));\r\nwrite_tc_gpr_gp((unsigned long)gp);\r\nflush_icache_range((unsigned long)gp,\r\n(unsigned long)(gp + sizeof(struct thread_info)));\r\nclear_c0_mvpcontrol(MVPCONTROL_VPC);\r\nevpe(EVPE_ENABLE);\r\n}\r\nstatic void __init vsmp_smp_setup(void)\r\n{\r\nunsigned int mvpconf0, ntc, tc, ncpu = 0;\r\nunsigned int nvpe;\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(0, mt_fpu_cpumask);\r\n#endif\r\nif (!cpu_has_mipsmt)\r\nreturn;\r\ndvpe();\r\ndmt();\r\nset_c0_mvpcontrol(MVPCONTROL_VPC);\r\nmvpconf0 = read_c0_mvpconf0();\r\nntc = (mvpconf0 & MVPCONF0_PTC) >> MVPCONF0_PTC_SHIFT;\r\nnvpe = ((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT) + 1;\r\nsmp_num_siblings = nvpe;\r\nfor (tc = 0; tc <= ntc; tc++) {\r\nsettc(tc);\r\nsmvp_tc_init(tc, mvpconf0);\r\nncpu = smvp_vpe_init(tc, mvpconf0, ncpu);\r\n}\r\nclear_c0_mvpcontrol(MVPCONTROL_VPC);\r\nprintk(KERN_INFO "Detected %i available secondary CPU(s)\n", ncpu);\r\n}\r\nstatic void __init vsmp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nmips_mt_set_cpuoptions();\r\n}\r\nstatic int proc_cpuinfo_chain_call(struct notifier_block *nfb,\r\nunsigned long action_unused, void *data)\r\n{\r\nstruct proc_cpuinfo_notifier_args *pcn = data;\r\nstruct seq_file *m = pcn->m;\r\nunsigned long n = pcn->n;\r\nif (!cpu_has_mipsmt)\r\nreturn NOTIFY_OK;\r\nseq_printf(m, "VPE\t\t\t: %d\n", cpu_data[n].vpe_id);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init proc_cpuinfo_notifier_init(void)\r\n{\r\nreturn proc_cpuinfo_notifier(proc_cpuinfo_chain_call, 0);\r\n}

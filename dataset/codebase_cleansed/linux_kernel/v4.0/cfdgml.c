struct cflayer *cfdgml_create(u8 channel_id, struct dev_info *dev_info)\r\n{\r\nstruct cfsrvl *dgm = kzalloc(sizeof(struct cfsrvl), GFP_ATOMIC);\r\nif (!dgm)\r\nreturn NULL;\r\ncaif_assert(offsetof(struct cfsrvl, layer) == 0);\r\ncfsrvl_init(dgm, channel_id, dev_info, true);\r\ndgm->layer.receive = cfdgml_receive;\r\ndgm->layer.transmit = cfdgml_transmit;\r\nsnprintf(dgm->layer.name, CAIF_LAYER_NAME_SZ - 1, "dgm%d", channel_id);\r\ndgm->layer.name[CAIF_LAYER_NAME_SZ - 1] = '\0';\r\nreturn &dgm->layer;\r\n}\r\nstatic int cfdgml_receive(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 cmd = -1;\r\nu8 dgmhdr[3];\r\nint ret;\r\ncaif_assert(layr->up != NULL);\r\ncaif_assert(layr->receive != NULL);\r\ncaif_assert(layr->ctrlcmd != NULL);\r\nif (cfpkt_extr_head(pkt, &cmd, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\nif ((cmd & DGM_CMD_BIT) == 0) {\r\nif (cfpkt_extr_head(pkt, &dgmhdr, 3) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\nret = layr->up->receive(layr->up, pkt);\r\nreturn ret;\r\n}\r\nswitch (cmd) {\r\ncase DGM_FLOW_OFF:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_OFF_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ncase DGM_FLOW_ON:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_ON_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ndefault:\r\ncfpkt_destroy(pkt);\r\npr_info("Unknown datagram control %d (0x%x)\n", cmd, cmd);\r\nreturn -EPROTO;\r\n}\r\n}\r\nstatic int cfdgml_transmit(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 packet_type;\r\nu32 zero = 0;\r\nstruct caif_payload_info *info;\r\nstruct cfsrvl *service = container_obj(layr);\r\nint ret;\r\nif (!cfsrvl_ready(service, &ret)) {\r\ncfpkt_destroy(pkt);\r\nreturn ret;\r\n}\r\nif (cfpkt_getlen(pkt) > DGM_MTU) {\r\ncfpkt_destroy(pkt);\r\nreturn -EMSGSIZE;\r\n}\r\ncfpkt_add_head(pkt, &zero, 3);\r\npacket_type = 0x08;\r\ncfpkt_add_head(pkt, &packet_type, 1);\r\ninfo = cfpkt_info(pkt);\r\ninfo->channel_id = service->layer.id;\r\ninfo->hdr_len = 4;\r\ninfo->dev_info = &service->dev_info;\r\nreturn layr->dn->transmit(layr->dn, pkt);\r\n}

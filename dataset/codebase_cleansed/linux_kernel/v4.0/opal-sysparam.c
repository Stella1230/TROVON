static ssize_t opal_get_sys_param(u32 param_id, u32 length, void *buffer)\r\n{\r\nstruct opal_msg msg;\r\nssize_t ret;\r\nint token;\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\nif (token != -ERESTARTSYS)\r\npr_err("%s: Couldn't get the token, returning\n",\r\n__func__);\r\nret = token;\r\ngoto out;\r\n}\r\nret = opal_get_param(token, param_id, (u64)buffer, length);\r\nif (ret != OPAL_ASYNC_COMPLETION)\r\ngoto out_token;\r\nret = opal_async_wait_response(token, &msg);\r\nif (ret) {\r\npr_err("%s: Failed to wait for the async response, %zd\n",\r\n__func__, ret);\r\ngoto out_token;\r\n}\r\nret = be64_to_cpu(msg.params[1]);\r\nout_token:\r\nopal_async_release_token(token);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int opal_set_sys_param(u32 param_id, u32 length, void *buffer)\r\n{\r\nstruct opal_msg msg;\r\nint ret, token;\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\nif (token != -ERESTARTSYS)\r\npr_err("%s: Couldn't get the token, returning\n",\r\n__func__);\r\nret = token;\r\ngoto out;\r\n}\r\nret = opal_set_param(token, param_id, (u64)buffer, length);\r\nif (ret != OPAL_ASYNC_COMPLETION)\r\ngoto out_token;\r\nret = opal_async_wait_response(token, &msg);\r\nif (ret) {\r\npr_err("%s: Failed to wait for the async response, %d\n",\r\n__func__, ret);\r\ngoto out_token;\r\n}\r\nret = be64_to_cpu(msg.params[1]);\r\nout_token:\r\nopal_async_release_token(token);\r\nout:\r\nreturn ret;\r\n}\r\nstatic ssize_t sys_param_show(struct kobject *kobj,\r\nstruct kobj_attribute *kobj_attr, char *buf)\r\n{\r\nstruct param_attr *attr = container_of(kobj_attr, struct param_attr,\r\nkobj_attr);\r\nssize_t ret;\r\nmutex_lock(&opal_sysparam_mutex);\r\nret = opal_get_sys_param(attr->param_id, attr->param_size,\r\nparam_data_buf);\r\nif (ret)\r\ngoto out;\r\nmemcpy(buf, param_data_buf, attr->param_size);\r\nret = attr->param_size;\r\nout:\r\nmutex_unlock(&opal_sysparam_mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t sys_param_store(struct kobject *kobj,\r\nstruct kobj_attribute *kobj_attr, const char *buf, size_t count)\r\n{\r\nstruct param_attr *attr = container_of(kobj_attr, struct param_attr,\r\nkobj_attr);\r\nssize_t ret;\r\nif (count > MAX_PARAM_DATA_LEN)\r\ncount = MAX_PARAM_DATA_LEN;\r\nmutex_lock(&opal_sysparam_mutex);\r\nmemcpy(param_data_buf, buf, count);\r\nret = opal_set_sys_param(attr->param_id, attr->param_size,\r\nparam_data_buf);\r\nmutex_unlock(&opal_sysparam_mutex);\r\nif (!ret)\r\nret = count;\r\nreturn ret;\r\n}\r\nvoid __init opal_sys_param_init(void)\r\n{\r\nstruct device_node *sysparam;\r\nstruct param_attr *attr;\r\nu32 *id, *size;\r\nint count, i;\r\nu8 *perm;\r\nif (!opal_kobj) {\r\npr_warn("SYSPARAM: opal kobject is not available\n");\r\ngoto out;\r\n}\r\nsysparam_kobj = kobject_create_and_add("sysparams", opal_kobj);\r\nif (!sysparam_kobj) {\r\npr_err("SYSPARAM: Failed to create sysparam kobject\n");\r\ngoto out;\r\n}\r\nparam_data_buf = kzalloc(MAX_PARAM_DATA_LEN, GFP_KERNEL);\r\nif (!param_data_buf) {\r\npr_err("SYSPARAM: Failed to allocate memory for param data "\r\n"buf\n");\r\ngoto out_kobj_put;\r\n}\r\nsysparam = of_find_node_by_path("/ibm,opal/sysparams");\r\nif (!sysparam) {\r\npr_err("SYSPARAM: Opal sysparam node not found\n");\r\ngoto out_param_buf;\r\n}\r\nif (!of_device_is_compatible(sysparam, "ibm,opal-sysparams")) {\r\npr_err("SYSPARAM: Opal sysparam node not compatible\n");\r\ngoto out_node_put;\r\n}\r\ncount = of_property_count_strings(sysparam, "param-name");\r\nif (count < 0) {\r\npr_err("SYSPARAM: No string found of property param-name in "\r\n"the node %s\n", sysparam->name);\r\ngoto out_node_put;\r\n}\r\nid = kzalloc(sizeof(*id) * count, GFP_KERNEL);\r\nif (!id) {\r\npr_err("SYSPARAM: Failed to allocate memory to read parameter "\r\n"id\n");\r\ngoto out_node_put;\r\n}\r\nsize = kzalloc(sizeof(*size) * count, GFP_KERNEL);\r\nif (!size) {\r\npr_err("SYSPARAM: Failed to allocate memory to read parameter "\r\n"size\n");\r\ngoto out_free_id;\r\n}\r\nperm = kzalloc(sizeof(*perm) * count, GFP_KERNEL);\r\nif (!perm) {\r\npr_err("SYSPARAM: Failed to allocate memory to read supported "\r\n"action on the parameter");\r\ngoto out_free_size;\r\n}\r\nif (of_property_read_u32_array(sysparam, "param-id", id, count)) {\r\npr_err("SYSPARAM: Missing property param-id in the DT\n");\r\ngoto out_free_perm;\r\n}\r\nif (of_property_read_u32_array(sysparam, "param-len", size, count)) {\r\npr_err("SYSPARAM: Missing property param-len in the DT\n");\r\ngoto out_free_perm;\r\n}\r\nif (of_property_read_u8_array(sysparam, "param-perm", perm, count)) {\r\npr_err("SYSPARAM: Missing property param-perm in the DT\n");\r\ngoto out_free_perm;\r\n}\r\nattr = kzalloc(sizeof(*attr) * count, GFP_KERNEL);\r\nif (!attr) {\r\npr_err("SYSPARAM: Failed to allocate memory for parameter "\r\n"attributes\n");\r\ngoto out_free_perm;\r\n}\r\nfor (i = 0; i < count; i++) {\r\nif (size[i] > MAX_PARAM_DATA_LEN) {\r\npr_warn("SYSPARAM: Not creating parameter %d as size "\r\n"exceeds buffer length\n", i);\r\ncontinue;\r\n}\r\nsysfs_attr_init(&attr[i].kobj_attr.attr);\r\nattr[i].param_id = id[i];\r\nattr[i].param_size = size[i];\r\nif (of_property_read_string_index(sysparam, "param-name", i,\r\n&attr[i].kobj_attr.attr.name))\r\ncontinue;\r\nswitch (perm[i] & 3) {\r\ncase OPAL_SYSPARAM_READ:\r\nattr[i].kobj_attr.attr.mode = S_IRUGO;\r\nbreak;\r\ncase OPAL_SYSPARAM_WRITE:\r\nattr[i].kobj_attr.attr.mode = S_IWUSR;\r\nbreak;\r\ncase OPAL_SYSPARAM_RW:\r\nattr[i].kobj_attr.attr.mode = S_IRUGO | S_IWUSR;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nattr[i].kobj_attr.show = sys_param_show;\r\nattr[i].kobj_attr.store = sys_param_store;\r\nif (sysfs_create_file(sysparam_kobj, &attr[i].kobj_attr.attr)) {\r\npr_err("SYSPARAM: Failed to create sysfs file %s\n",\r\nattr[i].kobj_attr.attr.name);\r\ngoto out_free_attr;\r\n}\r\n}\r\nkfree(perm);\r\nkfree(size);\r\nkfree(id);\r\nof_node_put(sysparam);\r\nreturn;\r\nout_free_attr:\r\nkfree(attr);\r\nout_free_perm:\r\nkfree(perm);\r\nout_free_size:\r\nkfree(size);\r\nout_free_id:\r\nkfree(id);\r\nout_node_put:\r\nof_node_put(sysparam);\r\nout_param_buf:\r\nkfree(param_data_buf);\r\nout_kobj_put:\r\nkobject_put(sysparam_kobj);\r\nout:\r\nreturn;\r\n}

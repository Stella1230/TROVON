static void ar9003_hw_rx_enable(struct ath_hw *hw)\r\n{\r\nREG_WRITE(hw, AR_CR, 0);\r\n}\r\nstatic void\r\nar9003_set_txdesc(struct ath_hw *ah, void *ds, struct ath_tx_info *i)\r\n{\r\nstruct ar9003_txc *ads = ds;\r\nint checksum = 0;\r\nu32 val, ctl12, ctl17;\r\nu8 desc_len;\r\ndesc_len = ((AR_SREV_9462(ah) || AR_SREV_9565(ah)) ? 0x18 : 0x17);\r\nval = (ATHEROS_VENDOR_ID << AR_DescId_S) |\r\n(1 << AR_TxRxDesc_S) |\r\n(1 << AR_CtrlStat_S) |\r\n(i->qcu << AR_TxQcuNum_S) | desc_len;\r\nchecksum += val;\r\nACCESS_ONCE(ads->info) = val;\r\nchecksum += i->link;\r\nACCESS_ONCE(ads->link) = i->link;\r\nchecksum += i->buf_addr[0];\r\nACCESS_ONCE(ads->data0) = i->buf_addr[0];\r\nchecksum += i->buf_addr[1];\r\nACCESS_ONCE(ads->data1) = i->buf_addr[1];\r\nchecksum += i->buf_addr[2];\r\nACCESS_ONCE(ads->data2) = i->buf_addr[2];\r\nchecksum += i->buf_addr[3];\r\nACCESS_ONCE(ads->data3) = i->buf_addr[3];\r\nchecksum += (val = (i->buf_len[0] << AR_BufLen_S) & AR_BufLen);\r\nACCESS_ONCE(ads->ctl3) = val;\r\nchecksum += (val = (i->buf_len[1] << AR_BufLen_S) & AR_BufLen);\r\nACCESS_ONCE(ads->ctl5) = val;\r\nchecksum += (val = (i->buf_len[2] << AR_BufLen_S) & AR_BufLen);\r\nACCESS_ONCE(ads->ctl7) = val;\r\nchecksum += (val = (i->buf_len[3] << AR_BufLen_S) & AR_BufLen);\r\nACCESS_ONCE(ads->ctl9) = val;\r\nchecksum = (u16) (((checksum & 0xffff) + (checksum >> 16)) & 0xffff);\r\nACCESS_ONCE(ads->ctl10) = checksum;\r\nif (i->is_first || i->is_last) {\r\nACCESS_ONCE(ads->ctl13) = set11nTries(i->rates, 0)\r\n| set11nTries(i->rates, 1)\r\n| set11nTries(i->rates, 2)\r\n| set11nTries(i->rates, 3)\r\n| (i->dur_update ? AR_DurUpdateEna : 0)\r\n| SM(0, AR_BurstDur);\r\nACCESS_ONCE(ads->ctl14) = set11nRate(i->rates, 0)\r\n| set11nRate(i->rates, 1)\r\n| set11nRate(i->rates, 2)\r\n| set11nRate(i->rates, 3);\r\n} else {\r\nACCESS_ONCE(ads->ctl13) = 0;\r\nACCESS_ONCE(ads->ctl14) = 0;\r\n}\r\nads->ctl20 = 0;\r\nads->ctl21 = 0;\r\nads->ctl22 = 0;\r\nads->ctl23 = 0;\r\nctl17 = SM(i->keytype, AR_EncrType);\r\nif (!i->is_first) {\r\nACCESS_ONCE(ads->ctl11) = 0;\r\nACCESS_ONCE(ads->ctl12) = i->is_last ? 0 : AR_TxMore;\r\nACCESS_ONCE(ads->ctl15) = 0;\r\nACCESS_ONCE(ads->ctl16) = 0;\r\nACCESS_ONCE(ads->ctl17) = ctl17;\r\nACCESS_ONCE(ads->ctl18) = 0;\r\nACCESS_ONCE(ads->ctl19) = 0;\r\nreturn;\r\n}\r\nACCESS_ONCE(ads->ctl11) = (i->pkt_len & AR_FrameLen)\r\n| (i->flags & ATH9K_TXDESC_VMF ? AR_VirtMoreFrag : 0)\r\n| SM(i->txpower[0], AR_XmitPower0)\r\n| (i->flags & ATH9K_TXDESC_VEOL ? AR_VEOL : 0)\r\n| (i->keyix != ATH9K_TXKEYIX_INVALID ? AR_DestIdxValid : 0)\r\n| (i->flags & ATH9K_TXDESC_LOWRXCHAIN ? AR_LowRxChain : 0)\r\n| (i->flags & ATH9K_TXDESC_CLRDMASK ? AR_ClrDestMask : 0)\r\n| (i->flags & ATH9K_TXDESC_RTSENA ? AR_RTSEnable :\r\n(i->flags & ATH9K_TXDESC_CTSENA ? AR_CTSEnable : 0));\r\nctl12 = (i->keyix != ATH9K_TXKEYIX_INVALID ?\r\nSM(i->keyix, AR_DestIdx) : 0)\r\n| SM(i->type, AR_FrameType)\r\n| (i->flags & ATH9K_TXDESC_NOACK ? AR_NoAck : 0)\r\n| (i->flags & ATH9K_TXDESC_EXT_ONLY ? AR_ExtOnly : 0)\r\n| (i->flags & ATH9K_TXDESC_EXT_AND_CTL ? AR_ExtAndCtl : 0);\r\nctl17 |= (i->flags & ATH9K_TXDESC_LDPC ? AR_LDPC : 0);\r\nswitch (i->aggr) {\r\ncase AGGR_BUF_FIRST:\r\nctl17 |= SM(i->aggr_len, AR_AggrLen);\r\ncase AGGR_BUF_MIDDLE:\r\nctl12 |= AR_IsAggr | AR_MoreAggr;\r\nctl17 |= SM(i->ndelim, AR_PadDelim);\r\nbreak;\r\ncase AGGR_BUF_LAST:\r\nctl12 |= AR_IsAggr;\r\nbreak;\r\ncase AGGR_BUF_NONE:\r\nbreak;\r\n}\r\nval = (i->flags & ATH9K_TXDESC_PAPRD) >> ATH9K_TXDESC_PAPRD_S;\r\nctl12 |= SM(val, AR_PAPRDChainMask);\r\nACCESS_ONCE(ads->ctl12) = ctl12;\r\nACCESS_ONCE(ads->ctl17) = ctl17;\r\nACCESS_ONCE(ads->ctl15) = set11nPktDurRTSCTS(i->rates, 0)\r\n| set11nPktDurRTSCTS(i->rates, 1);\r\nACCESS_ONCE(ads->ctl16) = set11nPktDurRTSCTS(i->rates, 2)\r\n| set11nPktDurRTSCTS(i->rates, 3);\r\nACCESS_ONCE(ads->ctl18) = set11nRateFlags(i->rates, 0)\r\n| set11nRateFlags(i->rates, 1)\r\n| set11nRateFlags(i->rates, 2)\r\n| set11nRateFlags(i->rates, 3)\r\n| SM(i->rtscts_rate, AR_RTSCTSRate);\r\nACCESS_ONCE(ads->ctl19) = AR_Not_Sounding;\r\nACCESS_ONCE(ads->ctl20) = SM(i->txpower[1], AR_XmitPower1);\r\nACCESS_ONCE(ads->ctl21) = SM(i->txpower[2], AR_XmitPower2);\r\nACCESS_ONCE(ads->ctl22) = SM(i->txpower[3], AR_XmitPower3);\r\n}\r\nstatic u16 ar9003_calc_ptr_chksum(struct ar9003_txc *ads)\r\n{\r\nint checksum;\r\nchecksum = ads->info + ads->link\r\n+ ads->data0 + ads->ctl3\r\n+ ads->data1 + ads->ctl5\r\n+ ads->data2 + ads->ctl7\r\n+ ads->data3 + ads->ctl9;\r\nreturn ((checksum & 0xffff) + (checksum >> 16)) & AR_TxPtrChkSum;\r\n}\r\nstatic void ar9003_hw_set_desc_link(void *ds, u32 ds_link)\r\n{\r\nstruct ar9003_txc *ads = ds;\r\nads->link = ds_link;\r\nads->ctl10 &= ~AR_TxPtrChkSum;\r\nads->ctl10 |= ar9003_calc_ptr_chksum(ads);\r\n}\r\nstatic bool ar9003_hw_get_isr(struct ath_hw *ah, enum ath9k_int *masked,\r\nu32 *sync_cause_p)\r\n{\r\nu32 isr = 0;\r\nu32 mask2 = 0;\r\nstruct ath9k_hw_capabilities *pCap = &ah->caps;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 sync_cause = 0, async_cause, async_mask = AR_INTR_MAC_IRQ;\r\nbool fatal_int;\r\nif (ath9k_hw_mci_is_enabled(ah))\r\nasync_mask |= AR_INTR_ASYNC_MASK_MCI;\r\nasync_cause = REG_READ(ah, AR_INTR_ASYNC_CAUSE);\r\nif (async_cause & async_mask) {\r\nif ((REG_READ(ah, AR_RTC_STATUS) & AR_RTC_STATUS_M)\r\n== AR_RTC_STATUS_ON)\r\nisr = REG_READ(ah, AR_ISR);\r\n}\r\nsync_cause = REG_READ(ah, AR_INTR_SYNC_CAUSE) & AR_INTR_SYNC_DEFAULT;\r\n*masked = 0;\r\nif (!isr && !sync_cause && !async_cause)\r\nreturn false;\r\nif (isr) {\r\nif (isr & AR_ISR_BCNMISC) {\r\nu32 isr2;\r\nisr2 = REG_READ(ah, AR_ISR_S2);\r\nmask2 |= ((isr2 & AR_ISR_S2_TIM) >>\r\nMAP_ISR_S2_TIM);\r\nmask2 |= ((isr2 & AR_ISR_S2_DTIM) >>\r\nMAP_ISR_S2_DTIM);\r\nmask2 |= ((isr2 & AR_ISR_S2_DTIMSYNC) >>\r\nMAP_ISR_S2_DTIMSYNC);\r\nmask2 |= ((isr2 & AR_ISR_S2_CABEND) >>\r\nMAP_ISR_S2_CABEND);\r\nmask2 |= ((isr2 & AR_ISR_S2_GTT) <<\r\nMAP_ISR_S2_GTT);\r\nmask2 |= ((isr2 & AR_ISR_S2_CST) <<\r\nMAP_ISR_S2_CST);\r\nmask2 |= ((isr2 & AR_ISR_S2_TSFOOR) >>\r\nMAP_ISR_S2_TSFOOR);\r\nmask2 |= ((isr2 & AR_ISR_S2_BB_WATCHDOG) >>\r\nMAP_ISR_S2_BB_WATCHDOG);\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR_S2, isr2);\r\nisr &= ~AR_ISR_BCNMISC;\r\n}\r\n}\r\nif ((pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED))\r\nisr = REG_READ(ah, AR_ISR_RAC);\r\nif (isr == 0xffffffff) {\r\n*masked = 0;\r\nreturn false;\r\n}\r\n*masked = isr & ATH9K_INT_COMMON;\r\nif (ah->config.rx_intr_mitigation)\r\nif (isr & (AR_ISR_RXMINTR | AR_ISR_RXINTM))\r\n*masked |= ATH9K_INT_RXLP;\r\nif (ah->config.tx_intr_mitigation)\r\nif (isr & (AR_ISR_TXMINTR | AR_ISR_TXINTM))\r\n*masked |= ATH9K_INT_TX;\r\nif (isr & (AR_ISR_LP_RXOK | AR_ISR_RXERR))\r\n*masked |= ATH9K_INT_RXLP;\r\nif (isr & AR_ISR_HP_RXOK)\r\n*masked |= ATH9K_INT_RXHP;\r\nif (isr & (AR_ISR_TXOK | AR_ISR_TXERR | AR_ISR_TXEOL)) {\r\n*masked |= ATH9K_INT_TX;\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nu32 s0, s1;\r\ns0 = REG_READ(ah, AR_ISR_S0);\r\nREG_WRITE(ah, AR_ISR_S0, s0);\r\ns1 = REG_READ(ah, AR_ISR_S1);\r\nREG_WRITE(ah, AR_ISR_S1, s1);\r\nisr &= ~(AR_ISR_TXOK | AR_ISR_TXERR |\r\nAR_ISR_TXEOL);\r\n}\r\n}\r\nif (isr & AR_ISR_GENTMR) {\r\nu32 s5;\r\nif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)\r\ns5 = REG_READ(ah, AR_ISR_S5_S);\r\nelse\r\ns5 = REG_READ(ah, AR_ISR_S5);\r\nah->intr_gen_timer_trigger =\r\nMS(s5, AR_ISR_S5_GENTIMER_TRIG);\r\nah->intr_gen_timer_thresh =\r\nMS(s5, AR_ISR_S5_GENTIMER_THRESH);\r\nif (ah->intr_gen_timer_trigger)\r\n*masked |= ATH9K_INT_GENTIMER;\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR_S5, s5);\r\nisr &= ~AR_ISR_GENTMR;\r\n}\r\n}\r\n*masked |= mask2;\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR, isr);\r\n(void) REG_READ(ah, AR_ISR);\r\n}\r\nif (*masked & ATH9K_INT_BB_WATCHDOG)\r\nar9003_hw_bb_watchdog_read(ah);\r\n}\r\nif (async_cause & AR_INTR_ASYNC_MASK_MCI)\r\nar9003_mci_get_isr(ah, masked);\r\nif (sync_cause) {\r\nif (sync_cause_p)\r\n*sync_cause_p = sync_cause;\r\nfatal_int =\r\n(sync_cause &\r\n(AR_INTR_SYNC_HOST1_FATAL | AR_INTR_SYNC_HOST1_PERR))\r\n? true : false;\r\nif (fatal_int) {\r\nif (sync_cause & AR_INTR_SYNC_HOST1_FATAL) {\r\nath_dbg(common, ANY,\r\n"received PCI FATAL interrupt\n");\r\n}\r\nif (sync_cause & AR_INTR_SYNC_HOST1_PERR) {\r\nath_dbg(common, ANY,\r\n"received PCI PERR interrupt\n");\r\n}\r\n*masked |= ATH9K_INT_FATAL;\r\n}\r\nif (sync_cause & AR_INTR_SYNC_RADM_CPL_TIMEOUT) {\r\nREG_WRITE(ah, AR_RC, AR_RC_HOSTIF);\r\nREG_WRITE(ah, AR_RC, 0);\r\n*masked |= ATH9K_INT_FATAL;\r\n}\r\nif (sync_cause & AR_INTR_SYNC_LOCAL_TIMEOUT)\r\nath_dbg(common, INTERRUPT,\r\n"AR_INTR_SYNC_LOCAL_TIMEOUT\n");\r\nREG_WRITE(ah, AR_INTR_SYNC_CAUSE_CLR, sync_cause);\r\n(void) REG_READ(ah, AR_INTR_SYNC_CAUSE_CLR);\r\n}\r\nreturn true;\r\n}\r\nstatic int ar9003_hw_proc_txdesc(struct ath_hw *ah, void *ds,\r\nstruct ath_tx_status *ts)\r\n{\r\nstruct ar9003_txs *ads;\r\nu32 status;\r\nads = &ah->ts_ring[ah->ts_tail];\r\nstatus = ACCESS_ONCE(ads->status8);\r\nif ((status & AR_TxDone) == 0)\r\nreturn -EINPROGRESS;\r\nah->ts_tail = (ah->ts_tail + 1) % ah->ts_size;\r\nif ((MS(ads->ds_info, AR_DescId) != ATHEROS_VENDOR_ID) ||\r\n(MS(ads->ds_info, AR_TxRxDesc) != 1)) {\r\nath_dbg(ath9k_hw_common(ah), XMIT,\r\n"Tx Descriptor error %x\n", ads->ds_info);\r\nmemset(ads, 0, sizeof(*ads));\r\nreturn -EIO;\r\n}\r\nts->ts_rateindex = MS(status, AR_FinalTxIdx);\r\nts->ts_seqnum = MS(status, AR_SeqNum);\r\nts->tid = MS(status, AR_TxTid);\r\nts->qid = MS(ads->ds_info, AR_TxQcuNum);\r\nts->desc_id = MS(ads->status1, AR_TxDescId);\r\nts->ts_tstamp = ads->status4;\r\nts->ts_status = 0;\r\nts->ts_flags = 0;\r\nif (status & AR_TxOpExceeded)\r\nts->ts_status |= ATH9K_TXERR_XTXOP;\r\nstatus = ACCESS_ONCE(ads->status2);\r\nts->ts_rssi_ctl0 = MS(status, AR_TxRSSIAnt00);\r\nts->ts_rssi_ctl1 = MS(status, AR_TxRSSIAnt01);\r\nts->ts_rssi_ctl2 = MS(status, AR_TxRSSIAnt02);\r\nif (status & AR_TxBaStatus) {\r\nts->ts_flags |= ATH9K_TX_BA;\r\nts->ba_low = ads->status5;\r\nts->ba_high = ads->status6;\r\n}\r\nstatus = ACCESS_ONCE(ads->status3);\r\nif (status & AR_ExcessiveRetries)\r\nts->ts_status |= ATH9K_TXERR_XRETRY;\r\nif (status & AR_Filtered)\r\nts->ts_status |= ATH9K_TXERR_FILT;\r\nif (status & AR_FIFOUnderrun) {\r\nts->ts_status |= ATH9K_TXERR_FIFO;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\nif (status & AR_TxTimerExpired)\r\nts->ts_status |= ATH9K_TXERR_TIMER_EXPIRED;\r\nif (status & AR_DescCfgErr)\r\nts->ts_flags |= ATH9K_TX_DESC_CFG_ERR;\r\nif (status & AR_TxDataUnderrun) {\r\nts->ts_flags |= ATH9K_TX_DATA_UNDERRUN;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\nif (status & AR_TxDelimUnderrun) {\r\nts->ts_flags |= ATH9K_TX_DELIM_UNDERRUN;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\nts->ts_shortretry = MS(status, AR_RTSFailCnt);\r\nts->ts_longretry = MS(status, AR_DataFailCnt);\r\nts->ts_virtcol = MS(status, AR_VirtRetryCnt);\r\nstatus = ACCESS_ONCE(ads->status7);\r\nts->ts_rssi = MS(status, AR_TxRSSICombined);\r\nts->ts_rssi_ext0 = MS(status, AR_TxRSSIAnt10);\r\nts->ts_rssi_ext1 = MS(status, AR_TxRSSIAnt11);\r\nts->ts_rssi_ext2 = MS(status, AR_TxRSSIAnt12);\r\nmemset(ads, 0, sizeof(*ads));\r\nreturn 0;\r\n}\r\nstatic int ar9003_hw_get_duration(struct ath_hw *ah, const void *ds, int index)\r\n{\r\nconst struct ar9003_txc *adc = ds;\r\nswitch (index) {\r\ncase 0:\r\nreturn MS(ACCESS_ONCE(adc->ctl15), AR_PacketDur0);\r\ncase 1:\r\nreturn MS(ACCESS_ONCE(adc->ctl15), AR_PacketDur1);\r\ncase 2:\r\nreturn MS(ACCESS_ONCE(adc->ctl16), AR_PacketDur2);\r\ncase 3:\r\nreturn MS(ACCESS_ONCE(adc->ctl16), AR_PacketDur3);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nvoid ar9003_hw_attach_mac_ops(struct ath_hw *hw)\r\n{\r\nstruct ath_hw_ops *ops = ath9k_hw_ops(hw);\r\nops->rx_enable = ar9003_hw_rx_enable;\r\nops->set_desc_link = ar9003_hw_set_desc_link;\r\nops->get_isr = ar9003_hw_get_isr;\r\nops->set_txdesc = ar9003_set_txdesc;\r\nops->proc_txdesc = ar9003_hw_proc_txdesc;\r\nops->get_duration = ar9003_hw_get_duration;\r\n}\r\nvoid ath9k_hw_set_rx_bufsize(struct ath_hw *ah, u16 buf_size)\r\n{\r\nREG_WRITE(ah, AR_DATABUF_SIZE, buf_size & AR_DATABUF_SIZE_MASK);\r\n}\r\nvoid ath9k_hw_addrxbuf_edma(struct ath_hw *ah, u32 rxdp,\r\nenum ath9k_rx_qtype qtype)\r\n{\r\nif (qtype == ATH9K_RX_QUEUE_HP)\r\nREG_WRITE(ah, AR_HP_RXDP, rxdp);\r\nelse\r\nREG_WRITE(ah, AR_LP_RXDP, rxdp);\r\n}\r\nint ath9k_hw_process_rxdesc_edma(struct ath_hw *ah, struct ath_rx_status *rxs,\r\nvoid *buf_addr)\r\n{\r\nstruct ar9003_rxs *rxsp = (struct ar9003_rxs *) buf_addr;\r\nunsigned int phyerr;\r\nif ((rxsp->status11 & AR_RxDone) == 0)\r\nreturn -EINPROGRESS;\r\nif (MS(rxsp->ds_info, AR_DescId) != 0x168c)\r\nreturn -EINVAL;\r\nif ((rxsp->ds_info & (AR_TxRxDesc | AR_CtrlStat)) != 0)\r\nreturn -EINPROGRESS;\r\nrxs->rs_status = 0;\r\nrxs->rs_flags = 0;\r\nrxs->flag = 0;\r\nrxs->rs_datalen = rxsp->status2 & AR_DataLen;\r\nrxs->rs_tstamp = rxsp->status3;\r\nrxs->rs_rssi = MS(rxsp->status5, AR_RxRSSICombined);\r\nrxs->rs_rssi_ctl[0] = MS(rxsp->status1, AR_RxRSSIAnt00);\r\nrxs->rs_rssi_ctl[1] = MS(rxsp->status1, AR_RxRSSIAnt01);\r\nrxs->rs_rssi_ctl[2] = MS(rxsp->status1, AR_RxRSSIAnt02);\r\nrxs->rs_rssi_ext[0] = MS(rxsp->status5, AR_RxRSSIAnt10);\r\nrxs->rs_rssi_ext[1] = MS(rxsp->status5, AR_RxRSSIAnt11);\r\nrxs->rs_rssi_ext[2] = MS(rxsp->status5, AR_RxRSSIAnt12);\r\nif (rxsp->status11 & AR_RxKeyIdxValid)\r\nrxs->rs_keyix = MS(rxsp->status11, AR_KeyIdx);\r\nelse\r\nrxs->rs_keyix = ATH9K_RXKEYIX_INVALID;\r\nrxs->rs_rate = MS(rxsp->status1, AR_RxRate);\r\nrxs->rs_more = (rxsp->status2 & AR_RxMore) ? 1 : 0;\r\nrxs->rs_firstaggr = (rxsp->status11 & AR_RxFirstAggr) ? 1 : 0;\r\nrxs->rs_isaggr = (rxsp->status11 & AR_RxAggr) ? 1 : 0;\r\nrxs->rs_moreaggr = (rxsp->status11 & AR_RxMoreAggr) ? 1 : 0;\r\nrxs->rs_antenna = (MS(rxsp->status4, AR_RxAntenna) & 0x7);\r\nrxs->flag |= (rxsp->status4 & AR_GI) ? RX_FLAG_SHORT_GI : 0;\r\nrxs->flag |= (rxsp->status4 & AR_2040) ? RX_FLAG_40MHZ : 0;\r\nrxs->evm0 = rxsp->status6;\r\nrxs->evm1 = rxsp->status7;\r\nrxs->evm2 = rxsp->status8;\r\nrxs->evm3 = rxsp->status9;\r\nrxs->evm4 = (rxsp->status10 & 0xffff);\r\nif (rxsp->status11 & AR_PreDelimCRCErr)\r\nrxs->rs_flags |= ATH9K_RX_DELIM_CRC_PRE;\r\nif (rxsp->status11 & AR_PostDelimCRCErr)\r\nrxs->rs_flags |= ATH9K_RX_DELIM_CRC_POST;\r\nif (rxsp->status11 & AR_DecryptBusyErr)\r\nrxs->rs_flags |= ATH9K_RX_DECRYPT_BUSY;\r\nif ((rxsp->status11 & AR_RxFrameOK) == 0) {\r\nif (rxsp->status11 & AR_CRCErr)\r\nrxs->rs_status |= ATH9K_RXERR_CRC;\r\nelse if (rxsp->status11 & AR_DecryptCRCErr)\r\nrxs->rs_status |= ATH9K_RXERR_DECRYPT;\r\nelse if (rxsp->status11 & AR_MichaelErr)\r\nrxs->rs_status |= ATH9K_RXERR_MIC;\r\nif (rxsp->status11 & AR_PHYErr) {\r\nphyerr = MS(rxsp->status11, AR_PHYErrCode);\r\nif ((phyerr == ATH9K_PHYERR_OFDM_RESTART) &&\r\n(rxsp->status11 & AR_PostDelimCRCErr)) {\r\nrxs->rs_phyerr = 0;\r\n} else {\r\nrxs->rs_status |= ATH9K_RXERR_PHY;\r\nrxs->rs_phyerr = phyerr;\r\n}\r\n}\r\n}\r\nif (rxsp->status11 & AR_KeyMiss)\r\nrxs->rs_status |= ATH9K_RXERR_KEYMISS;\r\nreturn 0;\r\n}\r\nvoid ath9k_hw_reset_txstatus_ring(struct ath_hw *ah)\r\n{\r\nah->ts_tail = 0;\r\nmemset((void *) ah->ts_ring, 0,\r\nah->ts_size * sizeof(struct ar9003_txs));\r\nath_dbg(ath9k_hw_common(ah), XMIT,\r\n"TS Start 0x%x End 0x%x Virt %p, Size %d\n",\r\nah->ts_paddr_start, ah->ts_paddr_end,\r\nah->ts_ring, ah->ts_size);\r\nREG_WRITE(ah, AR_Q_STATUS_RING_START, ah->ts_paddr_start);\r\nREG_WRITE(ah, AR_Q_STATUS_RING_END, ah->ts_paddr_end);\r\n}\r\nvoid ath9k_hw_setup_statusring(struct ath_hw *ah, void *ts_start,\r\nu32 ts_paddr_start,\r\nu16 size)\r\n{\r\nah->ts_paddr_start = ts_paddr_start;\r\nah->ts_paddr_end = ts_paddr_start + (size * sizeof(struct ar9003_txs));\r\nah->ts_size = size;\r\nah->ts_ring = (struct ar9003_txs *) ts_start;\r\nath9k_hw_reset_txstatus_ring(ah);\r\n}

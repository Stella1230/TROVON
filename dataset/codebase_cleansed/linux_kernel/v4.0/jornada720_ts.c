static void jornada720_ts_collect_data(struct jornada_ts *jornada_ts)\r\n{\r\njornada_ts->x_data[0] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->x_data[1] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->x_data[2] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->y_data[0] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->y_data[1] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->y_data[2] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->x_data[3] = jornada_ssp_byte(TXDUMMY);\r\njornada_ts->y_data[3] = jornada_ssp_byte(TXDUMMY);\r\n}\r\nstatic int jornada720_ts_average(int coords[4])\r\n{\r\nint coord, high_bits = coords[3];\r\ncoord = coords[0] | ((high_bits & 0x03) << 8);\r\ncoord += coords[1] | ((high_bits & 0x0c) << 6);\r\ncoord += coords[2] | ((high_bits & 0x30) << 4);\r\nreturn coord / 3;\r\n}\r\nstatic irqreturn_t jornada720_ts_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct jornada_ts *jornada_ts = platform_get_drvdata(pdev);\r\nstruct input_dev *input = jornada_ts->dev;\r\nint x, y;\r\nif (GPLR & GPIO_GPIO(9)) {\r\ninput_report_key(input, BTN_TOUCH, 0);\r\ninput_sync(input);\r\n} else {\r\njornada_ssp_start();\r\nif (jornada_ssp_inout(GETTOUCHSAMPLES) == TXDUMMY) {\r\njornada720_ts_collect_data(jornada_ts);\r\nx = jornada720_ts_average(jornada_ts->x_data);\r\ny = jornada720_ts_average(jornada_ts->y_data);\r\ninput_report_key(input, BTN_TOUCH, 1);\r\ninput_report_abs(input, ABS_X, x);\r\ninput_report_abs(input, ABS_Y, y);\r\ninput_sync(input);\r\n}\r\njornada_ssp_end();\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int jornada720_ts_probe(struct platform_device *pdev)\r\n{\r\nstruct jornada_ts *jornada_ts;\r\nstruct input_dev *input_dev;\r\nint error;\r\njornada_ts = devm_kzalloc(&pdev->dev, sizeof(*jornada_ts), GFP_KERNEL);\r\nif (!jornada_ts)\r\nreturn -ENOMEM;\r\ninput_dev = devm_input_allocate_device(&pdev->dev);\r\nif (!input_dev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, jornada_ts);\r\njornada_ts->dev = input_dev;\r\ninput_dev->name = "HP Jornada 7xx Touchscreen";\r\ninput_dev->phys = "jornadats/input0";\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->dev.parent = &pdev->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X, 270, 3900, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 180, 3700, 0, 0);\r\nerror = devm_request_irq(&pdev->dev, IRQ_GPIO9,\r\njornada720_ts_interrupt,\r\nIRQF_TRIGGER_RISING,\r\n"HP7XX Touchscreen driver", pdev);\r\nif (error) {\r\ndev_err(&pdev->dev, "HP7XX TS : Unable to acquire irq!\n");\r\nreturn error;\r\n}\r\nerror = input_register_device(jornada_ts->dev);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}

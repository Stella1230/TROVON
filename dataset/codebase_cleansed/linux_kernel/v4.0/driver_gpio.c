static struct ssb_bus *ssb_gpio_get_bus(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct ssb_bus, gpio);\r\n}\r\nstatic int ssb_gpio_to_irq(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nreturn irq_find_mapping(bus->irq_domain, gpio);\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int ssb_gpio_chipco_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nreturn !!ssb_chipco_gpio_in(&bus->chipco, 1 << gpio);\r\n}\r\nstatic void ssb_gpio_chipco_set_value(struct gpio_chip *chip, unsigned gpio,\r\nint value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_out(&bus->chipco, 1 << gpio, value ? 1 << gpio : 0);\r\n}\r\nstatic int ssb_gpio_chipco_direction_input(struct gpio_chip *chip,\r\nunsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_outen(&bus->chipco, 1 << gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_chipco_direction_output(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_outen(&bus->chipco, 1 << gpio, 1 << gpio);\r\nssb_chipco_gpio_out(&bus->chipco, 1 << gpio, value ? 1 << gpio : 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_chipco_request(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_control(&bus->chipco, 1 << gpio, 0);\r\nssb_chipco_gpio_pulldown(&bus->chipco, 1 << gpio, 0);\r\nssb_chipco_gpio_pullup(&bus->chipco, 1 << gpio, 1 << gpio);\r\nreturn 0;\r\n}\r\nstatic void ssb_gpio_chipco_free(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_pullup(&bus->chipco, 1 << gpio, 0);\r\n}\r\nstatic void ssb_gpio_irq_chipco_mask(struct irq_data *d)\r\n{\r\nstruct ssb_bus *bus = irq_data_get_irq_chip_data(d);\r\nint gpio = irqd_to_hwirq(d);\r\nssb_chipco_gpio_intmask(&bus->chipco, BIT(gpio), 0);\r\n}\r\nstatic void ssb_gpio_irq_chipco_unmask(struct irq_data *d)\r\n{\r\nstruct ssb_bus *bus = irq_data_get_irq_chip_data(d);\r\nint gpio = irqd_to_hwirq(d);\r\nu32 val = ssb_chipco_gpio_in(&bus->chipco, BIT(gpio));\r\nssb_chipco_gpio_polarity(&bus->chipco, BIT(gpio), val);\r\nssb_chipco_gpio_intmask(&bus->chipco, BIT(gpio), BIT(gpio));\r\n}\r\nstatic irqreturn_t ssb_gpio_irq_chipco_handler(int irq, void *dev_id)\r\n{\r\nstruct ssb_bus *bus = dev_id;\r\nstruct ssb_chipcommon *chipco = &bus->chipco;\r\nu32 val = chipco_read32(chipco, SSB_CHIPCO_GPIOIN);\r\nu32 mask = chipco_read32(chipco, SSB_CHIPCO_GPIOIRQ);\r\nu32 pol = chipco_read32(chipco, SSB_CHIPCO_GPIOPOL);\r\nunsigned long irqs = (val ^ pol) & mask;\r\nint gpio;\r\nif (!irqs)\r\nreturn IRQ_NONE;\r\nfor_each_set_bit(gpio, &irqs, bus->gpio.ngpio)\r\ngeneric_handle_irq(ssb_gpio_to_irq(&bus->gpio, gpio));\r\nssb_chipco_gpio_polarity(chipco, irqs, val & irqs);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ssb_gpio_irq_chipco_domain_init(struct ssb_bus *bus)\r\n{\r\nstruct ssb_chipcommon *chipco = &bus->chipco;\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint gpio, hwirq, err;\r\nif (bus->bustype != SSB_BUSTYPE_SSB)\r\nreturn 0;\r\nbus->irq_domain = irq_domain_add_linear(NULL, chip->ngpio,\r\n&irq_domain_simple_ops, chipco);\r\nif (!bus->irq_domain) {\r\nerr = -ENODEV;\r\ngoto err_irq_domain;\r\n}\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_create_mapping(bus->irq_domain, gpio);\r\nirq_set_chip_data(irq, bus);\r\nirq_set_chip_and_handler(irq, &ssb_gpio_irq_chipco_chip,\r\nhandle_simple_irq);\r\n}\r\nhwirq = ssb_mips_irq(bus->chipco.dev) + 2;\r\nerr = request_irq(hwirq, ssb_gpio_irq_chipco_handler, IRQF_SHARED,\r\n"gpio", bus);\r\nif (err)\r\ngoto err_req_irq;\r\nssb_chipco_gpio_intmask(&bus->chipco, ~0, 0);\r\nchipco_set32(chipco, SSB_CHIPCO_IRQMASK, SSB_CHIPCO_IRQ_GPIO);\r\nreturn 0;\r\nerr_req_irq:\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_find_mapping(bus->irq_domain, gpio);\r\nirq_dispose_mapping(irq);\r\n}\r\nirq_domain_remove(bus->irq_domain);\r\nerr_irq_domain:\r\nreturn err;\r\n}\r\nstatic void ssb_gpio_irq_chipco_domain_exit(struct ssb_bus *bus)\r\n{\r\nstruct ssb_chipcommon *chipco = &bus->chipco;\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint gpio;\r\nif (bus->bustype != SSB_BUSTYPE_SSB)\r\nreturn;\r\nchipco_mask32(chipco, SSB_CHIPCO_IRQMASK, ~SSB_CHIPCO_IRQ_GPIO);\r\nfree_irq(ssb_mips_irq(bus->chipco.dev) + 2, chipco);\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_find_mapping(bus->irq_domain, gpio);\r\nirq_dispose_mapping(irq);\r\n}\r\nirq_domain_remove(bus->irq_domain);\r\n}\r\nstatic int ssb_gpio_irq_chipco_domain_init(struct ssb_bus *bus)\r\n{\r\nreturn 0;\r\n}\r\nstatic void ssb_gpio_irq_chipco_domain_exit(struct ssb_bus *bus)\r\n{\r\n}\r\nstatic int ssb_gpio_chipco_init(struct ssb_bus *bus)\r\n{\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint err;\r\nchip->label = "ssb_chipco_gpio";\r\nchip->owner = THIS_MODULE;\r\nchip->request = ssb_gpio_chipco_request;\r\nchip->free = ssb_gpio_chipco_free;\r\nchip->get = ssb_gpio_chipco_get_value;\r\nchip->set = ssb_gpio_chipco_set_value;\r\nchip->direction_input = ssb_gpio_chipco_direction_input;\r\nchip->direction_output = ssb_gpio_chipco_direction_output;\r\n#if IS_ENABLED(CONFIG_SSB_EMBEDDED)\r\nchip->to_irq = ssb_gpio_to_irq;\r\n#endif\r\nchip->ngpio = 16;\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nchip->base = 0;\r\nelse\r\nchip->base = -1;\r\nerr = ssb_gpio_irq_chipco_domain_init(bus);\r\nif (err)\r\nreturn err;\r\nerr = gpiochip_add(chip);\r\nif (err) {\r\nssb_gpio_irq_chipco_domain_exit(bus);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_extif_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nreturn !!ssb_extif_gpio_in(&bus->extif, 1 << gpio);\r\n}\r\nstatic void ssb_gpio_extif_set_value(struct gpio_chip *chip, unsigned gpio,\r\nint value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_out(&bus->extif, 1 << gpio, value ? 1 << gpio : 0);\r\n}\r\nstatic int ssb_gpio_extif_direction_input(struct gpio_chip *chip,\r\nunsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_outen(&bus->extif, 1 << gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_extif_direction_output(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_outen(&bus->extif, 1 << gpio, 1 << gpio);\r\nssb_extif_gpio_out(&bus->extif, 1 << gpio, value ? 1 << gpio : 0);\r\nreturn 0;\r\n}\r\nstatic void ssb_gpio_irq_extif_mask(struct irq_data *d)\r\n{\r\nstruct ssb_bus *bus = irq_data_get_irq_chip_data(d);\r\nint gpio = irqd_to_hwirq(d);\r\nssb_extif_gpio_intmask(&bus->extif, BIT(gpio), 0);\r\n}\r\nstatic void ssb_gpio_irq_extif_unmask(struct irq_data *d)\r\n{\r\nstruct ssb_bus *bus = irq_data_get_irq_chip_data(d);\r\nint gpio = irqd_to_hwirq(d);\r\nu32 val = ssb_extif_gpio_in(&bus->extif, BIT(gpio));\r\nssb_extif_gpio_polarity(&bus->extif, BIT(gpio), val);\r\nssb_extif_gpio_intmask(&bus->extif, BIT(gpio), BIT(gpio));\r\n}\r\nstatic irqreturn_t ssb_gpio_irq_extif_handler(int irq, void *dev_id)\r\n{\r\nstruct ssb_bus *bus = dev_id;\r\nstruct ssb_extif *extif = &bus->extif;\r\nu32 val = ssb_read32(extif->dev, SSB_EXTIF_GPIO_IN);\r\nu32 mask = ssb_read32(extif->dev, SSB_EXTIF_GPIO_INTMASK);\r\nu32 pol = ssb_read32(extif->dev, SSB_EXTIF_GPIO_INTPOL);\r\nunsigned long irqs = (val ^ pol) & mask;\r\nint gpio;\r\nif (!irqs)\r\nreturn IRQ_NONE;\r\nfor_each_set_bit(gpio, &irqs, bus->gpio.ngpio)\r\ngeneric_handle_irq(ssb_gpio_to_irq(&bus->gpio, gpio));\r\nssb_extif_gpio_polarity(extif, irqs, val & irqs);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ssb_gpio_irq_extif_domain_init(struct ssb_bus *bus)\r\n{\r\nstruct ssb_extif *extif = &bus->extif;\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint gpio, hwirq, err;\r\nif (bus->bustype != SSB_BUSTYPE_SSB)\r\nreturn 0;\r\nbus->irq_domain = irq_domain_add_linear(NULL, chip->ngpio,\r\n&irq_domain_simple_ops, extif);\r\nif (!bus->irq_domain) {\r\nerr = -ENODEV;\r\ngoto err_irq_domain;\r\n}\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_create_mapping(bus->irq_domain, gpio);\r\nirq_set_chip_data(irq, bus);\r\nirq_set_chip_and_handler(irq, &ssb_gpio_irq_extif_chip,\r\nhandle_simple_irq);\r\n}\r\nhwirq = ssb_mips_irq(bus->extif.dev) + 2;\r\nerr = request_irq(hwirq, ssb_gpio_irq_extif_handler, IRQF_SHARED,\r\n"gpio", bus);\r\nif (err)\r\ngoto err_req_irq;\r\nssb_extif_gpio_intmask(&bus->extif, ~0, 0);\r\nreturn 0;\r\nerr_req_irq:\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_find_mapping(bus->irq_domain, gpio);\r\nirq_dispose_mapping(irq);\r\n}\r\nirq_domain_remove(bus->irq_domain);\r\nerr_irq_domain:\r\nreturn err;\r\n}\r\nstatic void ssb_gpio_irq_extif_domain_exit(struct ssb_bus *bus)\r\n{\r\nstruct ssb_extif *extif = &bus->extif;\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint gpio;\r\nif (bus->bustype != SSB_BUSTYPE_SSB)\r\nreturn;\r\nfree_irq(ssb_mips_irq(bus->extif.dev) + 2, extif);\r\nfor (gpio = 0; gpio < chip->ngpio; gpio++) {\r\nint irq = irq_find_mapping(bus->irq_domain, gpio);\r\nirq_dispose_mapping(irq);\r\n}\r\nirq_domain_remove(bus->irq_domain);\r\n}\r\nstatic int ssb_gpio_irq_extif_domain_init(struct ssb_bus *bus)\r\n{\r\nreturn 0;\r\n}\r\nstatic void ssb_gpio_irq_extif_domain_exit(struct ssb_bus *bus)\r\n{\r\n}\r\nstatic int ssb_gpio_extif_init(struct ssb_bus *bus)\r\n{\r\nstruct gpio_chip *chip = &bus->gpio;\r\nint err;\r\nchip->label = "ssb_extif_gpio";\r\nchip->owner = THIS_MODULE;\r\nchip->get = ssb_gpio_extif_get_value;\r\nchip->set = ssb_gpio_extif_set_value;\r\nchip->direction_input = ssb_gpio_extif_direction_input;\r\nchip->direction_output = ssb_gpio_extif_direction_output;\r\n#if IS_ENABLED(CONFIG_SSB_EMBEDDED)\r\nchip->to_irq = ssb_gpio_to_irq;\r\n#endif\r\nchip->ngpio = 5;\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nchip->base = 0;\r\nelse\r\nchip->base = -1;\r\nerr = ssb_gpio_irq_extif_domain_init(bus);\r\nif (err)\r\nreturn err;\r\nerr = gpiochip_add(chip);\r\nif (err) {\r\nssb_gpio_irq_extif_domain_exit(bus);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_extif_init(struct ssb_bus *bus)\r\n{\r\nreturn -ENOTSUPP;\r\n}\r\nint ssb_gpio_init(struct ssb_bus *bus)\r\n{\r\nif (ssb_chipco_available(&bus->chipco))\r\nreturn ssb_gpio_chipco_init(bus);\r\nelse if (ssb_extif_available(&bus->extif))\r\nreturn ssb_gpio_extif_init(bus);\r\nelse\r\nSSB_WARN_ON(1);\r\nreturn -1;\r\n}\r\nint ssb_gpio_unregister(struct ssb_bus *bus)\r\n{\r\nif (ssb_chipco_available(&bus->chipco) ||\r\nssb_extif_available(&bus->extif)) {\r\ngpiochip_remove(&bus->gpio);\r\nreturn 0;\r\n} else {\r\nSSB_WARN_ON(1);\r\n}\r\nreturn -1;\r\n}

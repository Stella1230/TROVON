static int sigmadsp_write_i2c(void *control_data,\r\nunsigned int addr, const uint8_t data[], size_t len)\r\n{\r\nuint8_t *buf;\r\nint ret;\r\nbuf = kzalloc(2 + len, GFP_KERNEL | GFP_DMA);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nput_unaligned_be16(addr, buf);\r\nmemcpy(buf + 2, data, len);\r\nret = i2c_master_send(control_data, buf, len + 2);\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic int sigmadsp_read_i2c(void *control_data,\r\nunsigned int addr, uint8_t data[], size_t len)\r\n{\r\nstruct i2c_client *client = control_data;\r\nstruct i2c_msg msgs[2];\r\nuint8_t buf[2];\r\nint ret;\r\nput_unaligned_be16(addr, buf);\r\nmsgs[0].addr = client->addr;\r\nmsgs[0].len = sizeof(buf);\r\nmsgs[0].buf = buf;\r\nmsgs[0].flags = 0;\r\nmsgs[1].addr = client->addr;\r\nmsgs[1].len = len;\r\nmsgs[1].buf = data;\r\nmsgs[1].flags = I2C_M_RD;\r\nret = i2c_transfer(client->adapter, msgs, ARRAY_SIZE(msgs));\r\nif (ret < 0)\r\nreturn ret;\r\nelse if (ret != ARRAY_SIZE(msgs))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstruct sigmadsp *devm_sigmadsp_init_i2c(struct i2c_client *client,\r\nconst struct sigmadsp_ops *ops, const char *firmware_name)\r\n{\r\nstruct sigmadsp *sigmadsp;\r\nsigmadsp = devm_sigmadsp_init(&client->dev, ops, firmware_name);\r\nif (IS_ERR(sigmadsp))\r\nreturn sigmadsp;\r\nsigmadsp->control_data = client;\r\nsigmadsp->write = sigmadsp_write_i2c;\r\nsigmadsp->read = sigmadsp_read_i2c;\r\nreturn sigmadsp;\r\n}

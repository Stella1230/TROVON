static irqreturn_t ad7606_trigger_handler_th_bh(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct ad7606_state *st = iio_priv(pf->indio_dev);\r\ngpio_set_value(st->pdata->gpio_convst, 1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ad7606_poll_bh_to_ring(struct work_struct *work_s)\r\n{\r\nstruct ad7606_state *st = container_of(work_s, struct ad7606_state,\r\npoll_work);\r\nstruct iio_dev *indio_dev = iio_priv_to_dev(st);\r\n__u8 *buf;\r\nint ret;\r\nbuf = kzalloc(indio_dev->scan_bytes, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn;\r\nif (gpio_is_valid(st->pdata->gpio_frstdata)) {\r\nret = st->bops->read_block(st->dev, 1, buf);\r\nif (ret)\r\ngoto done;\r\nif (!gpio_get_value(st->pdata->gpio_frstdata)) {\r\nad7606_reset(st);\r\ngoto done;\r\n}\r\nret = st->bops->read_block(st->dev,\r\nst->chip_info->num_channels - 1, buf + 2);\r\nif (ret)\r\ngoto done;\r\n} else {\r\nret = st->bops->read_block(st->dev,\r\nst->chip_info->num_channels, buf);\r\nif (ret)\r\ngoto done;\r\n}\r\niio_push_to_buffers_with_timestamp(indio_dev, buf, iio_get_time_ns());\r\ndone:\r\ngpio_set_value(st->pdata->gpio_convst, 0);\r\niio_trigger_notify_done(indio_dev->trig);\r\nkfree(buf);\r\n}\r\nint ad7606_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nstruct ad7606_state *st = iio_priv(indio_dev);\r\nINIT_WORK(&st->poll_work, &ad7606_poll_bh_to_ring);\r\nreturn iio_triggered_buffer_setup(indio_dev,\r\n&ad7606_trigger_handler_th_bh, &ad7606_trigger_handler_th_bh,\r\nNULL);\r\n}\r\nvoid ad7606_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

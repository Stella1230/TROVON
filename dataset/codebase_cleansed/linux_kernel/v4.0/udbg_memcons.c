void memcons_putc(char c)\r\n{\r\nchar *new_output_pos;\r\n*memcons.output_pos = c;\r\nwmb();\r\nnew_output_pos = memcons.output_pos + 1;\r\nif (new_output_pos >= memcons.output_end)\r\nnew_output_pos = memcons.output_start;\r\nmemcons.output_pos = new_output_pos;\r\n}\r\nint memcons_getc_poll(void)\r\n{\r\nchar c;\r\nchar *new_input_pos;\r\nif (*memcons.input_pos) {\r\nc = *memcons.input_pos;\r\nnew_input_pos = memcons.input_pos + 1;\r\nif (new_input_pos >= memcons.input_end)\r\nnew_input_pos = memcons.input_start;\r\nelse if (*new_input_pos == '\0')\r\nnew_input_pos = memcons.input_start;\r\n*memcons.input_pos = '\0';\r\nwmb();\r\nmemcons.input_pos = new_input_pos;\r\nreturn c;\r\n}\r\nreturn -1;\r\n}\r\nint memcons_getc(void)\r\n{\r\nint c;\r\nwhile (1) {\r\nc = memcons_getc_poll();\r\nif (c == -1)\r\ncpu_relax();\r\nelse\r\nbreak;\r\n}\r\nreturn c;\r\n}\r\nvoid udbg_init_memcons(void)\r\n{\r\nudbg_putc = memcons_putc;\r\nudbg_getc = memcons_getc;\r\nudbg_getc_poll = memcons_getc_poll;\r\n}

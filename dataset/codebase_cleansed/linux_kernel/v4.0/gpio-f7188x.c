static inline int superio_inb(int base, int reg)\r\n{\r\noutb(reg, base);\r\nreturn inb(base + 1);\r\n}\r\nstatic int superio_inw(int base, int reg)\r\n{\r\nint val;\r\noutb(reg++, base);\r\nval = inb(base + 1) << 8;\r\noutb(reg, base);\r\nval |= inb(base + 1);\r\nreturn val;\r\n}\r\nstatic inline void superio_outb(int base, int reg, int val)\r\n{\r\noutb(reg, base);\r\noutb(val, base + 1);\r\n}\r\nstatic inline int superio_enter(int base)\r\n{\r\nif (!request_muxed_region(base, 2, DRVNAME)) {\r\npr_err(DRVNAME "I/O address 0x%04x already in use\n", base);\r\nreturn -EBUSY;\r\n}\r\noutb(SIO_UNLOCK_KEY, base);\r\noutb(SIO_UNLOCK_KEY, base);\r\nreturn 0;\r\n}\r\nstatic inline void superio_select(int base, int ld)\r\n{\r\noutb(SIO_LDSEL, base);\r\noutb(ld, base + 1);\r\n}\r\nstatic inline void superio_exit(int base)\r\n{\r\noutb(SIO_LOCK_KEY, base);\r\nrelease_region(base, 2);\r\n}\r\nstatic int f7188x_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nint err;\r\nstruct f7188x_gpio_bank *bank =\r\ncontainer_of(chip, struct f7188x_gpio_bank, chip);\r\nstruct f7188x_sio *sio = bank->data->sio;\r\nu8 dir;\r\nerr = superio_enter(sio->addr);\r\nif (err)\r\nreturn err;\r\nsuperio_select(sio->addr, SIO_LD_GPIO);\r\ndir = superio_inb(sio->addr, gpio_dir(bank->regbase));\r\ndir &= ~(1 << offset);\r\nsuperio_outb(sio->addr, gpio_dir(bank->regbase), dir);\r\nsuperio_exit(sio->addr);\r\nreturn 0;\r\n}\r\nstatic int f7188x_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nint err;\r\nstruct f7188x_gpio_bank *bank =\r\ncontainer_of(chip, struct f7188x_gpio_bank, chip);\r\nstruct f7188x_sio *sio = bank->data->sio;\r\nu8 dir, data;\r\nerr = superio_enter(sio->addr);\r\nif (err)\r\nreturn err;\r\nsuperio_select(sio->addr, SIO_LD_GPIO);\r\ndir = superio_inb(sio->addr, gpio_dir(bank->regbase));\r\ndir = !!(dir & (1 << offset));\r\nif (dir)\r\ndata = superio_inb(sio->addr, gpio_data_out(bank->regbase));\r\nelse\r\ndata = superio_inb(sio->addr, gpio_data_in(bank->regbase));\r\nsuperio_exit(sio->addr);\r\nreturn !!(data & 1 << offset);\r\n}\r\nstatic int f7188x_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nint err;\r\nstruct f7188x_gpio_bank *bank =\r\ncontainer_of(chip, struct f7188x_gpio_bank, chip);\r\nstruct f7188x_sio *sio = bank->data->sio;\r\nu8 dir, data_out;\r\nerr = superio_enter(sio->addr);\r\nif (err)\r\nreturn err;\r\nsuperio_select(sio->addr, SIO_LD_GPIO);\r\ndata_out = superio_inb(sio->addr, gpio_data_out(bank->regbase));\r\nif (value)\r\ndata_out |= (1 << offset);\r\nelse\r\ndata_out &= ~(1 << offset);\r\nsuperio_outb(sio->addr, gpio_data_out(bank->regbase), data_out);\r\ndir = superio_inb(sio->addr, gpio_dir(bank->regbase));\r\ndir |= (1 << offset);\r\nsuperio_outb(sio->addr, gpio_dir(bank->regbase), dir);\r\nsuperio_exit(sio->addr);\r\nreturn 0;\r\n}\r\nstatic void f7188x_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nint err;\r\nstruct f7188x_gpio_bank *bank =\r\ncontainer_of(chip, struct f7188x_gpio_bank, chip);\r\nstruct f7188x_sio *sio = bank->data->sio;\r\nu8 data_out;\r\nerr = superio_enter(sio->addr);\r\nif (err)\r\nreturn;\r\nsuperio_select(sio->addr, SIO_LD_GPIO);\r\ndata_out = superio_inb(sio->addr, gpio_data_out(bank->regbase));\r\nif (value)\r\ndata_out |= (1 << offset);\r\nelse\r\ndata_out &= ~(1 << offset);\r\nsuperio_outb(sio->addr, gpio_data_out(bank->regbase), data_out);\r\nsuperio_exit(sio->addr);\r\n}\r\nstatic int f7188x_gpio_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nint i;\r\nstruct f7188x_sio *sio = pdev->dev.platform_data;\r\nstruct f7188x_gpio_data *data;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nswitch (sio->type) {\r\ncase f71882fg:\r\ndata->nr_bank = ARRAY_SIZE(f71882_gpio_bank);\r\ndata->bank = f71882_gpio_bank;\r\nbreak;\r\ncase f71889f:\r\ndata->nr_bank = ARRAY_SIZE(f71889_gpio_bank);\r\ndata->bank = f71889_gpio_bank;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\ndata->sio = sio;\r\nplatform_set_drvdata(pdev, data);\r\nfor (i = 0; i < data->nr_bank; i++) {\r\nstruct f7188x_gpio_bank *bank = &data->bank[i];\r\nbank->chip.dev = &pdev->dev;\r\nbank->data = data;\r\nerr = gpiochip_add(&bank->chip);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"Failed to register gpiochip %d: %d\n",\r\ni, err);\r\ngoto err_gpiochip;\r\n}\r\n}\r\nreturn 0;\r\nerr_gpiochip:\r\nfor (i = i - 1; i >= 0; i--) {\r\nstruct f7188x_gpio_bank *bank = &data->bank[i];\r\ngpiochip_remove(&bank->chip);\r\n}\r\nreturn err;\r\n}\r\nstatic int f7188x_gpio_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nstruct f7188x_gpio_data *data = platform_get_drvdata(pdev);\r\nfor (i = 0; i < data->nr_bank; i++) {\r\nstruct f7188x_gpio_bank *bank = &data->bank[i];\r\ngpiochip_remove(&bank->chip);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init f7188x_find(int addr, struct f7188x_sio *sio)\r\n{\r\nint err;\r\nu16 devid;\r\nerr = superio_enter(addr);\r\nif (err)\r\nreturn err;\r\nerr = -ENODEV;\r\ndevid = superio_inw(addr, SIO_MANID);\r\nif (devid != SIO_FINTEK_ID) {\r\npr_debug(DRVNAME ": Not a Fintek device at 0x%08x\n", addr);\r\ngoto err;\r\n}\r\ndevid = superio_inw(addr, SIO_DEVID);\r\nswitch (devid) {\r\ncase SIO_F71882_ID:\r\nsio->type = f71882fg;\r\nbreak;\r\ncase SIO_F71889_ID:\r\nsio->type = f71889f;\r\nbreak;\r\ndefault:\r\npr_info(DRVNAME ": Unsupported Fintek device 0x%04x\n", devid);\r\ngoto err;\r\n}\r\nsio->addr = addr;\r\nerr = 0;\r\npr_info(DRVNAME ": Found %s at %#x, revision %d\n",\r\nf7188x_names[sio->type],\r\n(unsigned int) addr,\r\n(int) superio_inb(addr, SIO_DEVREV));\r\nerr:\r\nsuperio_exit(addr);\r\nreturn err;\r\n}\r\nstatic int __init\r\nf7188x_gpio_device_add(const struct f7188x_sio *sio)\r\n{\r\nint err;\r\nf7188x_gpio_pdev = platform_device_alloc(DRVNAME, -1);\r\nif (!f7188x_gpio_pdev)\r\nreturn -ENOMEM;\r\nerr = platform_device_add_data(f7188x_gpio_pdev,\r\nsio, sizeof(*sio));\r\nif (err) {\r\npr_err(DRVNAME "Platform data allocation failed\n");\r\ngoto err;\r\n}\r\nerr = platform_device_add(f7188x_gpio_pdev);\r\nif (err) {\r\npr_err(DRVNAME "Device addition failed\n");\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nplatform_device_put(f7188x_gpio_pdev);\r\nreturn err;\r\n}\r\nstatic int __init f7188x_gpio_init(void)\r\n{\r\nint err;\r\nstruct f7188x_sio sio;\r\nif (f7188x_find(0x2e, &sio) &&\r\nf7188x_find(0x4e, &sio))\r\nreturn -ENODEV;\r\nerr = platform_driver_register(&f7188x_gpio_driver);\r\nif (!err) {\r\nerr = f7188x_gpio_device_add(&sio);\r\nif (err)\r\nplatform_driver_unregister(&f7188x_gpio_driver);\r\n}\r\nreturn err;\r\n}\r\nstatic void __exit f7188x_gpio_exit(void)\r\n{\r\nplatform_device_unregister(f7188x_gpio_pdev);\r\nplatform_driver_unregister(&f7188x_gpio_driver);\r\n}

static int ir_nec_decode(struct rc_dev *dev, struct ir_raw_event ev)\r\n{\r\nstruct nec_dec *data = &dev->raw->nec;\r\nu32 scancode;\r\nu8 address, not_address, command, not_command;\r\nbool send_32bits = false;\r\nif (!(dev->enabled_protocols & RC_BIT_NEC))\r\nreturn 0;\r\nif (!is_timing_event(ev)) {\r\nif (ev.reset)\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nIR_dprintk(2, "NEC decode started at state %d (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\nswitch (data->state) {\r\ncase STATE_INACTIVE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (eq_margin(ev.duration, NEC_HEADER_PULSE, NEC_UNIT * 2)) {\r\ndata->is_nec_x = false;\r\ndata->necx_repeat = false;\r\n} else if (eq_margin(ev.duration, NECX_HEADER_PULSE, NEC_UNIT / 2))\r\ndata->is_nec_x = true;\r\nelse\r\nbreak;\r\ndata->count = 0;\r\ndata->state = STATE_HEADER_SPACE;\r\nreturn 0;\r\ncase STATE_HEADER_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (eq_margin(ev.duration, NEC_HEADER_SPACE, NEC_UNIT)) {\r\ndata->state = STATE_BIT_PULSE;\r\nreturn 0;\r\n} else if (eq_margin(ev.duration, NEC_REPEAT_SPACE, NEC_UNIT / 2)) {\r\nif (!dev->keypressed) {\r\nIR_dprintk(1, "Discarding last key repeat: event after key up\n");\r\n} else {\r\nrc_repeat(dev);\r\nIR_dprintk(1, "Repeat last key\n");\r\ndata->state = STATE_TRAILER_PULSE;\r\n}\r\nreturn 0;\r\n}\r\nbreak;\r\ncase STATE_BIT_PULSE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, NEC_BIT_PULSE, NEC_UNIT / 2))\r\nbreak;\r\ndata->state = STATE_BIT_SPACE;\r\nreturn 0;\r\ncase STATE_BIT_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (data->necx_repeat && data->count == NECX_REPEAT_BITS &&\r\ngeq_margin(ev.duration,\r\nNEC_TRAILER_SPACE, NEC_UNIT / 2)) {\r\nIR_dprintk(1, "Repeat last key\n");\r\nrc_repeat(dev);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n} else if (data->count > NECX_REPEAT_BITS)\r\ndata->necx_repeat = false;\r\ndata->bits <<= 1;\r\nif (eq_margin(ev.duration, NEC_BIT_1_SPACE, NEC_UNIT / 2))\r\ndata->bits |= 1;\r\nelse if (!eq_margin(ev.duration, NEC_BIT_0_SPACE, NEC_UNIT / 2))\r\nbreak;\r\ndata->count++;\r\nif (data->count == NEC_NBITS)\r\ndata->state = STATE_TRAILER_PULSE;\r\nelse\r\ndata->state = STATE_BIT_PULSE;\r\nreturn 0;\r\ncase STATE_TRAILER_PULSE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, NEC_TRAILER_PULSE, NEC_UNIT / 2))\r\nbreak;\r\ndata->state = STATE_TRAILER_SPACE;\r\nreturn 0;\r\ncase STATE_TRAILER_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (!geq_margin(ev.duration, NEC_TRAILER_SPACE, NEC_UNIT / 2))\r\nbreak;\r\naddress = bitrev8((data->bits >> 24) & 0xff);\r\nnot_address = bitrev8((data->bits >> 16) & 0xff);\r\ncommand = bitrev8((data->bits >> 8) & 0xff);\r\nnot_command = bitrev8((data->bits >> 0) & 0xff);\r\nif ((command ^ not_command) != 0xff) {\r\nIR_dprintk(1, "NEC checksum error: received 0x%08x\n",\r\ndata->bits);\r\nsend_32bits = true;\r\n}\r\nif (send_32bits) {\r\nscancode = data->bits;\r\nIR_dprintk(1, "NEC (modified) scancode 0x%08x\n", scancode);\r\n} else if ((address ^ not_address) != 0xff) {\r\nscancode = address << 16 |\r\nnot_address << 8 |\r\ncommand;\r\nIR_dprintk(1, "NEC (Ext) scancode 0x%06x\n", scancode);\r\n} else {\r\nscancode = address << 8 | command;\r\nIR_dprintk(1, "NEC scancode 0x%04x\n", scancode);\r\n}\r\nif (data->is_nec_x)\r\ndata->necx_repeat = true;\r\nrc_keydown(dev, RC_TYPE_NEC, scancode, 0);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nIR_dprintk(1, "NEC decode failed at count %d state %d (%uus %s)\n",\r\ndata->count, data->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\ndata->state = STATE_INACTIVE;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init ir_nec_decode_init(void)\r\n{\r\nir_raw_handler_register(&nec_handler);\r\nprintk(KERN_INFO "IR NEC protocol handler initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ir_nec_decode_exit(void)\r\n{\r\nir_raw_handler_unregister(&nec_handler);\r\n}

void mctrl_gpio_set(struct mctrl_gpios *gpios, unsigned int mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nstruct gpio_desc *desc_array[UART_GPIO_MAX];\r\nint value_array[UART_GPIO_MAX];\r\nunsigned int count = 0;\r\nif (IS_ERR_OR_NULL(gpios))\r\nreturn;\r\nfor (i = 0; i < UART_GPIO_MAX; i++)\r\nif (!IS_ERR_OR_NULL(gpios->gpio[i]) &&\r\nmctrl_gpios_desc[i].dir_out) {\r\ndesc_array[count] = gpios->gpio[i];\r\nvalue_array[count] = !!(mctrl & mctrl_gpios_desc[i].mctrl);\r\ncount++;\r\n}\r\ngpiod_set_array(count, desc_array, value_array);\r\n}\r\nstruct gpio_desc *mctrl_gpio_to_gpiod(struct mctrl_gpios *gpios,\r\nenum mctrl_gpio_idx gidx)\r\n{\r\nif (!IS_ERR_OR_NULL(gpios) && !IS_ERR_OR_NULL(gpios->gpio[gidx]))\r\nreturn gpios->gpio[gidx];\r\nelse\r\nreturn NULL;\r\n}\r\nunsigned int mctrl_gpio_get(struct mctrl_gpios *gpios, unsigned int *mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (IS_ERR_OR_NULL(gpios))\r\nreturn *mctrl;\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nif (!IS_ERR_OR_NULL(gpios->gpio[i]) &&\r\n!mctrl_gpios_desc[i].dir_out) {\r\nif (gpiod_get_value(gpios->gpio[i]))\r\n*mctrl |= mctrl_gpios_desc[i].mctrl;\r\nelse\r\n*mctrl &= ~mctrl_gpios_desc[i].mctrl;\r\n}\r\n}\r\nreturn *mctrl;\r\n}\r\nstruct mctrl_gpios *mctrl_gpio_init(struct device *dev, unsigned int idx)\r\n{\r\nstruct mctrl_gpios *gpios;\r\nenum mctrl_gpio_idx i;\r\nint err;\r\ngpios = devm_kzalloc(dev, sizeof(*gpios), GFP_KERNEL);\r\nif (!gpios)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\ngpios->gpio[i] = devm_gpiod_get_index(dev,\r\nmctrl_gpios_desc[i].name,\r\nidx);\r\nif (IS_ERR_OR_NULL(gpios->gpio[i]))\r\ncontinue;\r\nif (mctrl_gpios_desc[i].dir_out)\r\nerr = gpiod_direction_output(gpios->gpio[i], 0);\r\nelse\r\nerr = gpiod_direction_input(gpios->gpio[i]);\r\nif (err) {\r\ndev_dbg(dev, "Unable to set direction for %s GPIO",\r\nmctrl_gpios_desc[i].name);\r\ndevm_gpiod_put(dev, gpios->gpio[i]);\r\ngpios->gpio[i] = NULL;\r\n}\r\n}\r\nreturn gpios;\r\n}\r\nvoid mctrl_gpio_free(struct device *dev, struct mctrl_gpios *gpios)\r\n{\r\nenum mctrl_gpio_idx i;\r\nif (IS_ERR_OR_NULL(gpios))\r\nreturn;\r\nfor (i = 0; i < UART_GPIO_MAX; i++)\r\nif (!IS_ERR_OR_NULL(gpios->gpio[i]))\r\ndevm_gpiod_put(dev, gpios->gpio[i]);\r\ndevm_kfree(dev, gpios);\r\n}

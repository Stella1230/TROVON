static u32 sci_remote_node_table_get_group_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_table_index)\r\n{\r\nu32 dword_index;\r\nu32 *group_table;\r\nu32 bit_index;\r\ngroup_table = remote_node_table->remote_node_groups[group_table_index];\r\nfor (dword_index = 0; dword_index < remote_node_table->group_array_size; dword_index++) {\r\nif (group_table[dword_index] != 0) {\r\nfor (bit_index = 0; bit_index < 32; bit_index++) {\r\nif ((group_table[dword_index] & (1 << bit_index)) != 0) {\r\nreturn (dword_index * 32) + bit_index;\r\n}\r\n}\r\n}\r\n}\r\nreturn SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX;\r\n}\r\nstatic void sci_remote_node_table_clear_group_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_table_index,\r\nu32 group_index)\r\n{\r\nu32 dword_index;\r\nu32 bit_index;\r\nu32 *group_table;\r\nBUG_ON(group_table_index >= SCU_STP_REMOTE_NODE_COUNT);\r\nBUG_ON(group_index >= (u32)(remote_node_table->group_array_size * 32));\r\ndword_index = group_index / 32;\r\nbit_index = group_index % 32;\r\ngroup_table = remote_node_table->remote_node_groups[group_table_index];\r\ngroup_table[dword_index] = group_table[dword_index] & ~(1 << bit_index);\r\n}\r\nstatic void sci_remote_node_table_set_group_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_table_index,\r\nu32 group_index)\r\n{\r\nu32 dword_index;\r\nu32 bit_index;\r\nu32 *group_table;\r\nBUG_ON(group_table_index >= SCU_STP_REMOTE_NODE_COUNT);\r\nBUG_ON(group_index >= (u32)(remote_node_table->group_array_size * 32));\r\ndword_index = group_index / 32;\r\nbit_index = group_index % 32;\r\ngroup_table = remote_node_table->remote_node_groups[group_table_index];\r\ngroup_table[dword_index] = group_table[dword_index] | (1 << bit_index);\r\n}\r\nstatic void sci_remote_node_table_set_node_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 remote_node_index)\r\n{\r\nu32 dword_location;\r\nu32 dword_remainder;\r\nu32 slot_normalized;\r\nu32 slot_position;\r\nBUG_ON(\r\n(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\r\n<= (remote_node_index / SCU_STP_REMOTE_NODE_COUNT)\r\n);\r\ndword_location = remote_node_index / SCIC_SDS_REMOTE_NODES_PER_DWORD;\r\ndword_remainder = remote_node_index % SCIC_SDS_REMOTE_NODES_PER_DWORD;\r\nslot_normalized = (dword_remainder / SCU_STP_REMOTE_NODE_COUNT) * sizeof(u32);\r\nslot_position = remote_node_index % SCU_STP_REMOTE_NODE_COUNT;\r\nremote_node_table->available_remote_nodes[dword_location] |=\r\n1 << (slot_normalized + slot_position);\r\n}\r\nstatic void sci_remote_node_table_clear_node_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 remote_node_index)\r\n{\r\nu32 dword_location;\r\nu32 dword_remainder;\r\nu32 slot_position;\r\nu32 slot_normalized;\r\nBUG_ON(\r\n(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\r\n<= (remote_node_index / SCU_STP_REMOTE_NODE_COUNT)\r\n);\r\ndword_location = remote_node_index / SCIC_SDS_REMOTE_NODES_PER_DWORD;\r\ndword_remainder = remote_node_index % SCIC_SDS_REMOTE_NODES_PER_DWORD;\r\nslot_normalized = (dword_remainder / SCU_STP_REMOTE_NODE_COUNT) * sizeof(u32);\r\nslot_position = remote_node_index % SCU_STP_REMOTE_NODE_COUNT;\r\nremote_node_table->available_remote_nodes[dword_location] &=\r\n~(1 << (slot_normalized + slot_position));\r\n}\r\nstatic void sci_remote_node_table_clear_group(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_index)\r\n{\r\nu32 dword_location;\r\nu32 dword_remainder;\r\nu32 dword_value;\r\nBUG_ON(\r\n(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\r\n<= (group_index / SCU_STP_REMOTE_NODE_COUNT)\r\n);\r\ndword_location = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_value = remote_node_table->available_remote_nodes[dword_location];\r\ndword_value &= ~(SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\r\nremote_node_table->available_remote_nodes[dword_location] = dword_value;\r\n}\r\nstatic void sci_remote_node_table_set_group(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_index)\r\n{\r\nu32 dword_location;\r\nu32 dword_remainder;\r\nu32 dword_value;\r\nBUG_ON(\r\n(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\r\n<= (group_index / SCU_STP_REMOTE_NODE_COUNT)\r\n);\r\ndword_location = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_value = remote_node_table->available_remote_nodes[dword_location];\r\ndword_value |= (SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\r\nremote_node_table->available_remote_nodes[dword_location] = dword_value;\r\n}\r\nstatic u8 sci_remote_node_table_get_group_value(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_index)\r\n{\r\nu32 dword_location;\r\nu32 dword_remainder;\r\nu32 dword_value;\r\ndword_location = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\r\ndword_value = remote_node_table->available_remote_nodes[dword_location];\r\ndword_value &= (SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\r\ndword_value = dword_value >> (dword_remainder * 4);\r\nreturn (u8)dword_value;\r\n}\r\nvoid sci_remote_node_table_initialize(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 remote_node_entries)\r\n{\r\nu32 index;\r\nmemset(\r\nremote_node_table->available_remote_nodes,\r\n0x00,\r\nsizeof(remote_node_table->available_remote_nodes)\r\n);\r\nmemset(\r\nremote_node_table->remote_node_groups,\r\n0x00,\r\nsizeof(remote_node_table->remote_node_groups)\r\n);\r\nremote_node_table->available_nodes_array_size = (u16)\r\n(remote_node_entries / SCIC_SDS_REMOTE_NODES_PER_DWORD)\r\n+ ((remote_node_entries % SCIC_SDS_REMOTE_NODES_PER_DWORD) != 0);\r\nfor (index = 0; index < remote_node_entries; index++) {\r\nsci_remote_node_table_set_node_index(remote_node_table, index);\r\n}\r\nremote_node_table->group_array_size = (u16)\r\n(remote_node_entries / (SCU_STP_REMOTE_NODE_COUNT * 32))\r\n+ ((remote_node_entries % (SCU_STP_REMOTE_NODE_COUNT * 32)) != 0);\r\nfor (index = 0; index < (remote_node_entries / SCU_STP_REMOTE_NODE_COUNT); index++) {\r\nsci_remote_node_table_set_group_index(remote_node_table, 2, index);\r\n}\r\nif ((remote_node_entries % SCU_STP_REMOTE_NODE_COUNT) == 2) {\r\nsci_remote_node_table_set_group_index(remote_node_table, 1, index);\r\n} else if ((remote_node_entries % SCU_STP_REMOTE_NODE_COUNT) == 1) {\r\nsci_remote_node_table_set_group_index(remote_node_table, 0, index);\r\n}\r\n}\r\nstatic u16 sci_remote_node_table_allocate_single_remote_node(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_table_index)\r\n{\r\nu8 index;\r\nu8 group_value;\r\nu32 group_index;\r\nu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\r\ngroup_index = sci_remote_node_table_get_group_index(\r\nremote_node_table, group_table_index);\r\nif (group_index != SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX) {\r\ngroup_value = sci_remote_node_table_get_group_value(\r\nremote_node_table, group_index);\r\nfor (index = 0; index < SCU_STP_REMOTE_NODE_COUNT; index++) {\r\nif (((1 << index) & group_value) != 0) {\r\nremote_node_index = (u16)(group_index * SCU_STP_REMOTE_NODE_COUNT\r\n+ index);\r\nsci_remote_node_table_clear_group_index(\r\nremote_node_table, group_table_index, group_index\r\n);\r\nsci_remote_node_table_clear_node_index(\r\nremote_node_table, remote_node_index\r\n);\r\nif (group_table_index > 0) {\r\nsci_remote_node_table_set_group_index(\r\nremote_node_table, group_table_index - 1, group_index\r\n);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn remote_node_index;\r\n}\r\nstatic u16 sci_remote_node_table_allocate_triple_remote_node(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 group_table_index)\r\n{\r\nu32 group_index;\r\nu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\r\ngroup_index = sci_remote_node_table_get_group_index(\r\nremote_node_table, group_table_index);\r\nif (group_index != SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX) {\r\nremote_node_index = (u16)group_index * SCU_STP_REMOTE_NODE_COUNT;\r\nsci_remote_node_table_clear_group_index(\r\nremote_node_table, group_table_index, group_index\r\n);\r\nsci_remote_node_table_clear_group(\r\nremote_node_table, group_index\r\n);\r\n}\r\nreturn remote_node_index;\r\n}\r\nu16 sci_remote_node_table_allocate_remote_node(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 remote_node_count)\r\n{\r\nu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\r\nif (remote_node_count == SCU_SSP_REMOTE_NODE_COUNT) {\r\nremote_node_index =\r\nsci_remote_node_table_allocate_single_remote_node(\r\nremote_node_table, 0);\r\nif (remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX) {\r\nremote_node_index =\r\nsci_remote_node_table_allocate_single_remote_node(\r\nremote_node_table, 1);\r\n}\r\nif (remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX) {\r\nremote_node_index =\r\nsci_remote_node_table_allocate_single_remote_node(\r\nremote_node_table, 2);\r\n}\r\n} else if (remote_node_count == SCU_STP_REMOTE_NODE_COUNT) {\r\nremote_node_index =\r\nsci_remote_node_table_allocate_triple_remote_node(\r\nremote_node_table, 2);\r\n}\r\nreturn remote_node_index;\r\n}\r\nstatic void sci_remote_node_table_release_single_remote_node(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu16 remote_node_index)\r\n{\r\nu32 group_index;\r\nu8 group_value;\r\ngroup_index = remote_node_index / SCU_STP_REMOTE_NODE_COUNT;\r\ngroup_value = sci_remote_node_table_get_group_value(remote_node_table, group_index);\r\nBUG_ON(group_value == SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE);\r\nif (group_value == 0x00) {\r\nsci_remote_node_table_set_group_index(remote_node_table, 0, group_index);\r\n} else if ((group_value & (group_value - 1)) == 0) {\r\nsci_remote_node_table_clear_group_index(remote_node_table, 0, group_index);\r\nsci_remote_node_table_set_group_index(remote_node_table, 1, group_index);\r\n} else {\r\nsci_remote_node_table_clear_group_index(remote_node_table, 1, group_index);\r\nsci_remote_node_table_set_group_index(remote_node_table, 2, group_index);\r\n}\r\nsci_remote_node_table_set_node_index(remote_node_table, remote_node_index);\r\n}\r\nstatic void sci_remote_node_table_release_triple_remote_node(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu16 remote_node_index)\r\n{\r\nu32 group_index;\r\ngroup_index = remote_node_index / SCU_STP_REMOTE_NODE_COUNT;\r\nsci_remote_node_table_set_group_index(\r\nremote_node_table, 2, group_index\r\n);\r\nsci_remote_node_table_set_group(remote_node_table, group_index);\r\n}\r\nvoid sci_remote_node_table_release_remote_node_index(\r\nstruct sci_remote_node_table *remote_node_table,\r\nu32 remote_node_count,\r\nu16 remote_node_index)\r\n{\r\nif (remote_node_count == SCU_SSP_REMOTE_NODE_COUNT) {\r\nsci_remote_node_table_release_single_remote_node(\r\nremote_node_table, remote_node_index);\r\n} else if (remote_node_count == SCU_STP_REMOTE_NODE_COUNT) {\r\nsci_remote_node_table_release_triple_remote_node(\r\nremote_node_table, remote_node_index);\r\n}\r\n}

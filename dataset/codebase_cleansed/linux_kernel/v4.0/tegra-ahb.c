static inline u32 gizmo_readl(struct tegra_ahb *ahb, u32 offset)\r\n{\r\nreturn readl(ahb->regs + offset);\r\n}\r\nstatic inline void gizmo_writel(struct tegra_ahb *ahb, u32 value, u32 offset)\r\n{\r\nwritel(value, ahb->regs + offset);\r\n}\r\nstatic int tegra_ahb_match_by_smmu(struct device *dev, void *data)\r\n{\r\nstruct tegra_ahb *ahb = dev_get_drvdata(dev);\r\nstruct device_node *dn = data;\r\nreturn (ahb->dev->of_node == dn) ? 1 : 0;\r\n}\r\nint tegra_ahb_enable_smmu(struct device_node *dn)\r\n{\r\nstruct device *dev;\r\nu32 val;\r\nstruct tegra_ahb *ahb;\r\ndev = driver_find_device(&tegra_ahb_driver.driver, NULL, dn,\r\ntegra_ahb_match_by_smmu);\r\nif (!dev)\r\nreturn -EPROBE_DEFER;\r\nahb = dev_get_drvdata(dev);\r\nval = gizmo_readl(ahb, AHB_ARBITRATION_XBAR_CTRL);\r\nval |= AHB_ARBITRATION_XBAR_CTRL_SMMU_INIT_DONE;\r\ngizmo_writel(ahb, val, AHB_ARBITRATION_XBAR_CTRL);\r\nreturn 0;\r\n}\r\nstatic int tegra_ahb_suspend(struct device *dev)\r\n{\r\nint i;\r\nstruct tegra_ahb *ahb = dev_get_drvdata(dev);\r\nfor (i = 0; i < ARRAY_SIZE(tegra_ahb_gizmo); i++)\r\nahb->ctx[i] = gizmo_readl(ahb, tegra_ahb_gizmo[i]);\r\nreturn 0;\r\n}\r\nstatic int tegra_ahb_resume(struct device *dev)\r\n{\r\nint i;\r\nstruct tegra_ahb *ahb = dev_get_drvdata(dev);\r\nfor (i = 0; i < ARRAY_SIZE(tegra_ahb_gizmo); i++)\r\ngizmo_writel(ahb, ahb->ctx[i], tegra_ahb_gizmo[i]);\r\nreturn 0;\r\n}\r\nstatic void tegra_ahb_gizmo_init(struct tegra_ahb *ahb)\r\n{\r\nu32 val;\r\nval = gizmo_readl(ahb, AHB_GIZMO_AHB_MEM);\r\nval |= ENB_FAST_REARBITRATE | IMMEDIATE | DONT_SPLIT_AHB_WR;\r\ngizmo_writel(ahb, val, AHB_GIZMO_AHB_MEM);\r\nval = gizmo_readl(ahb, AHB_GIZMO_USB);\r\nval |= IMMEDIATE;\r\ngizmo_writel(ahb, val, AHB_GIZMO_USB);\r\nval = gizmo_readl(ahb, AHB_GIZMO_USB2);\r\nval |= IMMEDIATE;\r\ngizmo_writel(ahb, val, AHB_GIZMO_USB2);\r\nval = gizmo_readl(ahb, AHB_GIZMO_USB3);\r\nval |= IMMEDIATE;\r\ngizmo_writel(ahb, val, AHB_GIZMO_USB3);\r\nval = gizmo_readl(ahb, AHB_ARBITRATION_PRIORITY_CTRL);\r\nval |= PRIORITY_SELECT_USB |\r\nPRIORITY_SELECT_USB2 |\r\nPRIORITY_SELECT_USB3 |\r\nAHB_PRIORITY_WEIGHT(7);\r\ngizmo_writel(ahb, val, AHB_ARBITRATION_PRIORITY_CTRL);\r\nval = gizmo_readl(ahb, AHB_MEM_PREFETCH_CFG1);\r\nval &= ~MST_ID(~0);\r\nval |= PREFETCH_ENB |\r\nAHBDMA_MST_ID |\r\nADDR_BNDRY(0xc) |\r\nINACTIVITY_TIMEOUT(0x1000);\r\ngizmo_writel(ahb, val, AHB_MEM_PREFETCH_CFG1);\r\nval = gizmo_readl(ahb, AHB_MEM_PREFETCH_CFG2);\r\nval &= ~MST_ID(~0);\r\nval |= PREFETCH_ENB |\r\nUSB_MST_ID |\r\nADDR_BNDRY(0xc) |\r\nINACTIVITY_TIMEOUT(0x1000);\r\ngizmo_writel(ahb, val, AHB_MEM_PREFETCH_CFG2);\r\nval = gizmo_readl(ahb, AHB_MEM_PREFETCH_CFG3);\r\nval &= ~MST_ID(~0);\r\nval |= PREFETCH_ENB |\r\nUSB3_MST_ID |\r\nADDR_BNDRY(0xc) |\r\nINACTIVITY_TIMEOUT(0x1000);\r\ngizmo_writel(ahb, val, AHB_MEM_PREFETCH_CFG3);\r\nval = gizmo_readl(ahb, AHB_MEM_PREFETCH_CFG4);\r\nval &= ~MST_ID(~0);\r\nval |= PREFETCH_ENB |\r\nUSB2_MST_ID |\r\nADDR_BNDRY(0xc) |\r\nINACTIVITY_TIMEOUT(0x1000);\r\ngizmo_writel(ahb, val, AHB_MEM_PREFETCH_CFG4);\r\n}\r\nstatic int tegra_ahb_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct tegra_ahb *ahb;\r\nsize_t bytes;\r\nbytes = sizeof(*ahb) + sizeof(u32) * ARRAY_SIZE(tegra_ahb_gizmo);\r\nahb = devm_kzalloc(&pdev->dev, bytes, GFP_KERNEL);\r\nif (!ahb)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nahb->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ahb->regs))\r\nreturn PTR_ERR(ahb->regs);\r\nahb->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, ahb);\r\ntegra_ahb_gizmo_init(ahb);\r\nreturn 0;\r\n}

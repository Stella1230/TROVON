struct vmw_resource *\r\nvmw_cmdbuf_res_lookup(struct vmw_cmdbuf_res_manager *man,\r\nenum vmw_cmdbuf_res_type res_type,\r\nu32 user_key)\r\n{\r\nstruct drm_hash_item *hash;\r\nint ret;\r\nunsigned long key = user_key | (res_type << 24);\r\nret = drm_ht_find_item(&man->resources, key, &hash);\r\nif (unlikely(ret != 0))\r\nreturn ERR_PTR(ret);\r\nreturn vmw_resource_reference\r\n(drm_hash_entry(hash, struct vmw_cmdbuf_res, hash)->res);\r\n}\r\nstatic void vmw_cmdbuf_res_free(struct vmw_cmdbuf_res_manager *man,\r\nstruct vmw_cmdbuf_res *entry)\r\n{\r\nlist_del(&entry->head);\r\nWARN_ON(drm_ht_remove_item(&man->resources, &entry->hash));\r\nvmw_resource_unreference(&entry->res);\r\nkfree(entry);\r\n}\r\nvoid vmw_cmdbuf_res_commit(struct list_head *list)\r\n{\r\nstruct vmw_cmdbuf_res *entry, *next;\r\nlist_for_each_entry_safe(entry, next, list, head) {\r\nlist_del(&entry->head);\r\nswitch (entry->state) {\r\ncase VMW_CMDBUF_RES_ADD:\r\nentry->state = VMW_CMDBUF_RES_COMMITED;\r\nlist_add_tail(&entry->head, &entry->man->list);\r\nbreak;\r\ncase VMW_CMDBUF_RES_DEL:\r\nvmw_resource_unreference(&entry->res);\r\nkfree(entry);\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid vmw_cmdbuf_res_revert(struct list_head *list)\r\n{\r\nstruct vmw_cmdbuf_res *entry, *next;\r\nint ret;\r\nlist_for_each_entry_safe(entry, next, list, head) {\r\nswitch (entry->state) {\r\ncase VMW_CMDBUF_RES_ADD:\r\nvmw_cmdbuf_res_free(entry->man, entry);\r\nbreak;\r\ncase VMW_CMDBUF_RES_DEL:\r\nret = drm_ht_insert_item(&entry->man->resources,\r\n&entry->hash);\r\nlist_del(&entry->head);\r\nlist_add_tail(&entry->head, &entry->man->list);\r\nentry->state = VMW_CMDBUF_RES_COMMITED;\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\n}\r\n}\r\nint vmw_cmdbuf_res_add(struct vmw_cmdbuf_res_manager *man,\r\nenum vmw_cmdbuf_res_type res_type,\r\nu32 user_key,\r\nstruct vmw_resource *res,\r\nstruct list_head *list)\r\n{\r\nstruct vmw_cmdbuf_res *cres;\r\nint ret;\r\ncres = kzalloc(sizeof(*cres), GFP_KERNEL);\r\nif (unlikely(cres == NULL))\r\nreturn -ENOMEM;\r\ncres->hash.key = user_key | (res_type << 24);\r\nret = drm_ht_insert_item(&man->resources, &cres->hash);\r\nif (unlikely(ret != 0))\r\ngoto out_invalid_key;\r\ncres->state = VMW_CMDBUF_RES_ADD;\r\ncres->res = vmw_resource_reference(res);\r\ncres->man = man;\r\nlist_add_tail(&cres->head, list);\r\nout_invalid_key:\r\nreturn ret;\r\n}\r\nint vmw_cmdbuf_res_remove(struct vmw_cmdbuf_res_manager *man,\r\nenum vmw_cmdbuf_res_type res_type,\r\nu32 user_key,\r\nstruct list_head *list)\r\n{\r\nstruct vmw_cmdbuf_res *entry;\r\nstruct drm_hash_item *hash;\r\nint ret;\r\nret = drm_ht_find_item(&man->resources, user_key | (res_type << 24),\r\n&hash);\r\nif (likely(ret != 0))\r\nreturn -EINVAL;\r\nentry = drm_hash_entry(hash, struct vmw_cmdbuf_res, hash);\r\nswitch (entry->state) {\r\ncase VMW_CMDBUF_RES_ADD:\r\nvmw_cmdbuf_res_free(man, entry);\r\nbreak;\r\ncase VMW_CMDBUF_RES_COMMITED:\r\n(void) drm_ht_remove_item(&man->resources, &entry->hash);\r\nlist_del(&entry->head);\r\nentry->state = VMW_CMDBUF_RES_DEL;\r\nlist_add_tail(&entry->head, list);\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstruct vmw_cmdbuf_res_manager *\r\nvmw_cmdbuf_res_man_create(struct vmw_private *dev_priv)\r\n{\r\nstruct vmw_cmdbuf_res_manager *man;\r\nint ret;\r\nman = kzalloc(sizeof(*man), GFP_KERNEL);\r\nif (man == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nman->dev_priv = dev_priv;\r\nINIT_LIST_HEAD(&man->list);\r\nret = drm_ht_create(&man->resources, VMW_CMDBUF_RES_MAN_HT_ORDER);\r\nif (ret == 0)\r\nreturn man;\r\nkfree(man);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid vmw_cmdbuf_res_man_destroy(struct vmw_cmdbuf_res_manager *man)\r\n{\r\nstruct vmw_cmdbuf_res *entry, *next;\r\nlist_for_each_entry_safe(entry, next, &man->list, head)\r\nvmw_cmdbuf_res_free(man, entry);\r\nkfree(man);\r\n}\r\nsize_t vmw_cmdbuf_res_man_size(void)\r\n{\r\nstatic size_t res_man_size;\r\nif (unlikely(res_man_size == 0))\r\nres_man_size =\r\nttm_round_pot(sizeof(struct vmw_cmdbuf_res_manager)) +\r\nttm_round_pot(sizeof(struct hlist_head) <<\r\nVMW_CMDBUF_RES_MAN_HT_ORDER);\r\nreturn res_man_size;\r\n}

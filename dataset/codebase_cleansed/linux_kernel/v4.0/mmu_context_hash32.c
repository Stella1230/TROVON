unsigned long __init_new_context(void)\r\n{\r\nunsigned long ctx = next_mmu_context;\r\nwhile (test_and_set_bit(ctx, context_map)) {\r\nctx = find_next_zero_bit(context_map, LAST_CONTEXT+1, ctx);\r\nif (ctx > LAST_CONTEXT)\r\nctx = 0;\r\n}\r\nnext_mmu_context = (ctx + 1) & LAST_CONTEXT;\r\nreturn ctx;\r\n}\r\nint init_new_context(struct task_struct *t, struct mm_struct *mm)\r\n{\r\nmm->context.id = __init_new_context();\r\nreturn 0;\r\n}\r\nvoid __destroy_context(unsigned long ctx)\r\n{\r\nclear_bit(ctx, context_map);\r\n}\r\nvoid destroy_context(struct mm_struct *mm)\r\n{\r\npreempt_disable();\r\nif (mm->context.id != NO_CONTEXT) {\r\n__destroy_context(mm->context.id);\r\nmm->context.id = NO_CONTEXT;\r\n}\r\npreempt_enable();\r\n}\r\nvoid __init mmu_context_init(void)\r\n{\r\ncontext_map[0] = (1 << FIRST_CONTEXT) - 1;\r\nnext_mmu_context = FIRST_CONTEXT;\r\n}

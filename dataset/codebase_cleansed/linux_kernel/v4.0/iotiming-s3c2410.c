static void s3c2410_print_timing(const char *pfx,\r\nstruct s3c_iotimings *timings)\r\n{\r\nstruct s3c2410_iobank_timing *bt;\r\nint bank;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbt = timings->bank[bank].io_2410;\r\nif (!bt)\r\ncontinue;\r\nprintk(KERN_DEBUG "%s %d: Tacs=%d.%d, Tcos=%d.%d, Tacc=%d.%d, "\r\n"Tcoh=%d.%d, Tcah=%d.%d\n", pfx, bank,\r\nprint_ns(bt->tacs),\r\nprint_ns(bt->tcos),\r\nprint_ns(bt->tacc),\r\nprint_ns(bt->tcoh),\r\nprint_ns(bt->tcah));\r\n}\r\n}\r\nstatic inline void __iomem *bank_reg(unsigned int bank)\r\n{\r\nreturn S3C2410_BANKCON0 + (bank << 2);\r\n}\r\nstatic inline int bank_is_io(unsigned long bankcon)\r\n{\r\nreturn !(bankcon & S3C2410_BANKCON_SDRAM);\r\n}\r\nstatic inline unsigned int to_div(unsigned int cyc, unsigned int hclk_tns)\r\n{\r\nif (cyc == 0)\r\nreturn 0;\r\nreturn DIV_ROUND_UP(cyc, hclk_tns);\r\n}\r\nstatic unsigned int calc_0124(unsigned int cyc, unsigned long hclk_tns,\r\nunsigned long *v, int shift)\r\n{\r\nunsigned int div = to_div(cyc, hclk_tns);\r\nunsigned long val;\r\ns3c_freq_iodbg("%s: cyc=%d, hclk=%lu, shift=%d => div %d\n",\r\n__func__, cyc, hclk_tns, shift, div);\r\nswitch (div) {\r\ncase 0:\r\nval = 0;\r\nbreak;\r\ncase 1:\r\nval = 1;\r\nbreak;\r\ncase 2:\r\nval = 2;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\nval = 3;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\n*v |= val << shift;\r\nreturn 0;\r\n}\r\nint calc_tacp(unsigned int cyc, unsigned long hclk, unsigned long *v)\r\n{\r\nreturn 0;\r\n}\r\nstatic int calc_tacc(unsigned int cyc, int nwait_en,\r\nunsigned long hclk_tns, unsigned long *v)\r\n{\r\nunsigned int div = to_div(cyc, hclk_tns);\r\nunsigned long val;\r\ns3c_freq_iodbg("%s: cyc=%u, nwait=%d, hclk=%lu => div=%u\n",\r\n__func__, cyc, nwait_en, hclk_tns, div);\r\nif (nwait_en && div < 4)\r\ndiv = 4;\r\nswitch (div) {\r\ncase 0:\r\nval = 0;\r\nbreak;\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\nval = div - 1;\r\nbreak;\r\ncase 5:\r\ncase 6:\r\nval = 4;\r\nbreak;\r\ncase 7:\r\ncase 8:\r\nval = 5;\r\nbreak;\r\ncase 9:\r\ncase 10:\r\nval = 6;\r\nbreak;\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\ncase 14:\r\nval = 7;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\n*v |= val << 8;\r\nreturn 0;\r\n}\r\nstatic int s3c2410_calc_bank(struct s3c_cpufreq_config *cfg,\r\nstruct s3c2410_iobank_timing *bt)\r\n{\r\nunsigned long hclk = cfg->freq.hclk_tns;\r\nunsigned long res;\r\nint ret;\r\nres = bt->bankcon;\r\nres &= (S3C2410_BANKCON_SDRAM | S3C2410_BANKCON_PMC16);\r\nret = calc_0124(bt->tacs, hclk, &res, S3C2410_BANKCON_Tacs_SHIFT);\r\nret |= calc_0124(bt->tcos, hclk, &res, S3C2410_BANKCON_Tcos_SHIFT);\r\nret |= calc_0124(bt->tcah, hclk, &res, S3C2410_BANKCON_Tcah_SHIFT);\r\nret |= calc_0124(bt->tcoh, hclk, &res, S3C2410_BANKCON_Tcoh_SHIFT);\r\nif (ret)\r\nreturn -EINVAL;\r\nret |= calc_tacp(bt->tacp, hclk, &res);\r\nret |= calc_tacc(bt->tacc, bt->nwait_en, hclk, &res);\r\nif (ret)\r\nreturn -EINVAL;\r\nbt->bankcon = res;\r\nreturn 0;\r\n}\r\nstatic unsigned int get_tacc(unsigned long hclk_tns,\r\nunsigned long val)\r\n{\r\nval &= 7;\r\nreturn hclk_tns * tacc_tab[val];\r\n}\r\nstatic unsigned int get_0124(unsigned long hclk_tns,\r\nunsigned long val)\r\n{\r\nval &= 3;\r\nreturn hclk_tns * ((val == 3) ? 4 : val);\r\n}\r\nvoid s3c2410_iotiming_getbank(struct s3c_cpufreq_config *cfg,\r\nstruct s3c2410_iobank_timing *bt)\r\n{\r\nunsigned long bankcon = bt->bankcon;\r\nunsigned long hclk = cfg->freq.hclk_tns;\r\nbt->tcah = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcah_SHIFT);\r\nbt->tcoh = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcoh_SHIFT);\r\nbt->tcos = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcos_SHIFT);\r\nbt->tacs = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tacs_SHIFT);\r\nbt->tacc = get_tacc(hclk, bankcon >> S3C2410_BANKCON_Tacc_SHIFT);\r\n}\r\nvoid s3c2410_iotiming_debugfs(struct seq_file *seq,\r\nstruct s3c_cpufreq_config *cfg,\r\nunion s3c_iobank *iob)\r\n{\r\nstruct s3c2410_iobank_timing *bt = iob->io_2410;\r\nunsigned long bankcon = bt->bankcon;\r\nunsigned long hclk = cfg->freq.hclk_tns;\r\nunsigned int tacs;\r\nunsigned int tcos;\r\nunsigned int tacc;\r\nunsigned int tcoh;\r\nunsigned int tcah;\r\nseq_printf(seq, "BANKCON=0x%08lx\n", bankcon);\r\ntcah = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcah_SHIFT);\r\ntcoh = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcoh_SHIFT);\r\ntcos = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tcos_SHIFT);\r\ntacs = get_0124(hclk, bankcon >> S3C2410_BANKCON_Tacs_SHIFT);\r\ntacc = get_tacc(hclk, bankcon >> S3C2410_BANKCON_Tacc_SHIFT);\r\nseq_printf(seq,\r\n"\tRead: Tacs=%d.%d, Tcos=%d.%d, Tacc=%d.%d, Tcoh=%d.%d, Tcah=%d.%d\n",\r\nprint_ns(bt->tacs),\r\nprint_ns(bt->tcos),\r\nprint_ns(bt->tacc),\r\nprint_ns(bt->tcoh),\r\nprint_ns(bt->tcah));\r\nseq_printf(seq,\r\n"\t Set: Tacs=%d.%d, Tcos=%d.%d, Tacc=%d.%d, Tcoh=%d.%d, Tcah=%d.%d\n",\r\nprint_ns(tacs),\r\nprint_ns(tcos),\r\nprint_ns(tacc),\r\nprint_ns(tcoh),\r\nprint_ns(tcah));\r\n}\r\nint s3c2410_iotiming_calc(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *iot)\r\n{\r\nstruct s3c2410_iobank_timing *bt;\r\nunsigned long bankcon;\r\nint bank;\r\nint ret;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbankcon = __raw_readl(bank_reg(bank));\r\nbt = iot->bank[bank].io_2410;\r\nif (!bt)\r\ncontinue;\r\nbt->bankcon = bankcon;\r\nret = s3c2410_calc_bank(cfg, bt);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: cannot calculate bank %d io\n",\r\n__func__, bank);\r\ngoto err;\r\n}\r\ns3c_freq_iodbg("%s: bank %d: con=%08lx\n",\r\n__func__, bank, bt->bankcon);\r\n}\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nvoid s3c2410_iotiming_set(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *iot)\r\n{\r\nstruct s3c2410_iobank_timing *bt;\r\nint bank;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbt = iot->bank[bank].io_2410;\r\nif (!bt)\r\ncontinue;\r\n__raw_writel(bt->bankcon, bank_reg(bank));\r\n}\r\n}\r\nint s3c2410_iotiming_get(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *timings)\r\n{\r\nstruct s3c2410_iobank_timing *bt;\r\nunsigned long bankcon;\r\nunsigned long bwscon;\r\nint bank;\r\nbwscon = __raw_readl(S3C2410_BWSCON);\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbankcon = __raw_readl(bank_reg(bank));\r\nif (!bank_is_io(bankcon))\r\ncontinue;\r\ns3c_freq_iodbg("%s: bank %d: con %08lx\n",\r\n__func__, bank, bankcon);\r\nbt = kzalloc(sizeof(struct s3c2410_iobank_timing), GFP_KERNEL);\r\nif (!bt) {\r\nprintk(KERN_ERR "%s: no memory for bank\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nif (bank != 0) {\r\nunsigned long tmp = S3C2410_BWSCON_GET(bwscon, bank);\r\nif (tmp & S3C2410_BWSCON_WS)\r\nbt->nwait_en = 1;\r\n}\r\ntimings->bank[bank].io_2410 = bt;\r\nbt->bankcon = bankcon;\r\ns3c2410_iotiming_getbank(cfg, bt);\r\n}\r\ns3c2410_print_timing("get", timings);\r\nreturn 0;\r\n}

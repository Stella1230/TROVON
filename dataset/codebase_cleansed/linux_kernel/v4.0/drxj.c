static u32 frac28(u32 N, u32 D)\r\n{\r\nint i = 0;\r\nu32 Q1 = 0;\r\nu32 R0 = 0;\r\nR0 = (N % D) << 4;\r\nQ1 = N / D;\r\nfor (i = 0; i < 7; i++) {\r\nQ1 = (Q1 << 4) | R0 / D;\r\nR0 = (R0 % D) << 4;\r\n}\r\nif ((R0 >> 3) >= D)\r\nQ1++;\r\nreturn Q1;\r\n}\r\nstatic u32 log1_times100(u32 x)\r\n{\r\nstatic const u8 scale = 15;\r\nstatic const u8 index_width = 5;\r\nstatic const u32 log2lut[] = {\r\n0,\r\n290941,\r\n573196,\r\n847269,\r\n1113620,\r\n1372674,\r\n1624818,\r\n1870412,\r\n2109788,\r\n2343253,\r\n2571091,\r\n2793569,\r\n3010931,\r\n3223408,\r\n3431216,\r\n3634553,\r\n3833610,\r\n4028562,\r\n4219576,\r\n4406807,\r\n4590402,\r\n4770499,\r\n4947231,\r\n5120719,\r\n5291081,\r\n5458428,\r\n5622864,\r\n5784489,\r\n5943398,\r\n6099680,\r\n6253421,\r\n6404702,\r\n6553600,\r\n};\r\nu8 i = 0;\r\nu32 y = 0;\r\nu32 d = 0;\r\nu32 k = 0;\r\nu32 r = 0;\r\nif (x == 0)\r\nreturn 0;\r\nif ((x & (((u32) (-1)) << (scale + 1))) == 0) {\r\nfor (k = scale; k > 0; k--) {\r\nif (x & (((u32) 1) << scale))\r\nbreak;\r\nx <<= 1;\r\n}\r\n} else {\r\nfor (k = scale; k < 31; k++) {\r\nif ((x & (((u32) (-1)) << (scale + 1))) == 0)\r\nbreak;\r\nx >>= 1;\r\n}\r\n}\r\ny = k * ((((u32) 1) << scale) * 200);\r\nx &= ((((u32) 1) << scale) - 1);\r\ni = (u8) (x >> (scale - index_width));\r\nd = x & ((((u32) 1) << (scale - index_width)) - 1);\r\ny += log2lut[i] +\r\n((d * (log2lut[i + 1] - log2lut[i])) >> (scale - index_width));\r\ny /= 108853;\r\nr = (y >> 1);\r\nif (y & ((u32)1))\r\nr++;\r\nreturn r;\r\n}\r\nstatic u32 frac_times1e6(u32 N, u32 D)\r\n{\r\nu32 remainder = 0;\r\nu32 frac = 0;\r\nfrac = (((u32) N) * (1000000 >> 4)) / D;\r\nfrac <<= 4;\r\nremainder = (((u32) N) * (1000000 >> 4)) % D;\r\nremainder <<= 4;\r\nfrac += remainder / D;\r\nremainder = remainder % D;\r\nif ((remainder * 2) > D)\r\nfrac++;\r\nreturn frac;\r\n}\r\nstatic\r\nbool is_handled_by_aud_tr_if(u32 addr)\r\n{\r\nbool retval = false;\r\nif ((DRXDAP_FASI_ADDR2BLOCK(addr) == 4) &&\r\n(DRXDAP_FASI_ADDR2BANK(addr) > 1) &&\r\n(DRXDAP_FASI_ADDR2BANK(addr) < 6)) {\r\nretval = true;\r\n}\r\nreturn retval;\r\n}\r\nint drxbsp_i2c_write_read(struct i2c_device_addr *w_dev_addr,\r\nu16 w_count,\r\nu8 *wData,\r\nstruct i2c_device_addr *r_dev_addr,\r\nu16 r_count, u8 *r_data)\r\n{\r\nstruct drx39xxj_state *state;\r\nstruct i2c_msg msg[2];\r\nunsigned int num_msgs;\r\nif (w_dev_addr == NULL) {\r\nstate = r_dev_addr->user_data;\r\nmsg[0].addr = r_dev_addr->i2c_addr >> 1;\r\nmsg[0].flags = I2C_M_RD;\r\nmsg[0].buf = r_data;\r\nmsg[0].len = r_count;\r\nnum_msgs = 1;\r\n} else if (r_dev_addr == NULL) {\r\nstate = w_dev_addr->user_data;\r\nmsg[0].addr = w_dev_addr->i2c_addr >> 1;\r\nmsg[0].flags = 0;\r\nmsg[0].buf = wData;\r\nmsg[0].len = w_count;\r\nnum_msgs = 1;\r\n} else {\r\nstate = w_dev_addr->user_data;\r\nmsg[0].addr = w_dev_addr->i2c_addr >> 1;\r\nmsg[0].flags = 0;\r\nmsg[0].buf = wData;\r\nmsg[0].len = w_count;\r\nmsg[1].addr = r_dev_addr->i2c_addr >> 1;\r\nmsg[1].flags = I2C_M_RD;\r\nmsg[1].buf = r_data;\r\nmsg[1].len = r_count;\r\nnum_msgs = 2;\r\n}\r\nif (state->i2c == NULL) {\r\npr_err("i2c was zero, aborting\n");\r\nreturn 0;\r\n}\r\nif (i2c_transfer(state->i2c, msg, num_msgs) != num_msgs) {\r\npr_warn("drx3933: I2C write/read failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\n#ifdef DJH_DEBUG\r\nif (w_dev_addr == NULL || r_dev_addr == NULL)\r\nreturn 0;\r\nstate = w_dev_addr->user_data;\r\nif (state->i2c == NULL)\r\nreturn 0;\r\nmsg[0].addr = w_dev_addr->i2c_addr;\r\nmsg[0].flags = 0;\r\nmsg[0].buf = wData;\r\nmsg[0].len = w_count;\r\nmsg[1].addr = r_dev_addr->i2c_addr;\r\nmsg[1].flags = I2C_M_RD;\r\nmsg[1].buf = r_data;\r\nmsg[1].len = r_count;\r\nnum_msgs = 2;\r\npr_debug("drx3933 i2c operation addr=%x i2c=%p, wc=%x rc=%x\n",\r\nw_dev_addr->i2c_addr, state->i2c, w_count, r_count);\r\nif (i2c_transfer(state->i2c, msg, 2) != 2) {\r\npr_warn("drx3933: I2C write/read failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int drxdap_fasi_read_block(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 datasize,\r\nu8 *data, u32 flags)\r\n{\r\nu8 buf[4];\r\nu16 bufx;\r\nint rc;\r\nu16 overhead_size = 0;\r\nif (dev_addr == NULL)\r\nreturn -EINVAL;\r\noverhead_size = (IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1) +\r\n(DRXDAP_FASI_LONG_FORMAT(addr) ? 4 : 2);\r\nif ((DRXDAP_FASI_OFFSET_TOO_LARGE(addr)) ||\r\n((!(DRXDAPFASI_LONG_ADDR_ALLOWED)) &&\r\nDRXDAP_FASI_LONG_FORMAT(addr)) ||\r\n(overhead_size > (DRXDAP_MAX_WCHUNKSIZE)) ||\r\n((datasize != 0) && (data == NULL)) || ((datasize & 1) == 1)) {\r\nreturn -EINVAL;\r\n}\r\nflags &= (~DRXDAP_FASI_RMW & ~DRXDAP_FASI_MODEFLAGS);\r\n#if DRXDAP_SINGLE_MASTER\r\nflags |= DRXDAP_FASI_SINGLE_MASTER;\r\n#endif\r\ndo {\r\nu16 todo = (datasize < DRXDAP_MAX_RCHUNKSIZE ?\r\ndatasize : DRXDAP_MAX_RCHUNKSIZE);\r\nbufx = 0;\r\naddr &= ~DRXDAP_FASI_FLAGS;\r\naddr |= flags;\r\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\r\nif (DRXDAP_FASI_LONG_FORMAT(addr)) {\r\n#endif\r\n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\r\nbuf[bufx++] = (u8) (((addr << 1) & 0xFF) | 0x01);\r\nbuf[bufx++] = (u8) ((addr >> 16) & 0xFF);\r\nbuf[bufx++] = (u8) ((addr >> 24) & 0xFF);\r\nbuf[bufx++] = (u8) ((addr >> 7) & 0xFF);\r\n#endif\r\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\r\n} else {\r\n#endif\r\n#if (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1)\r\nbuf[bufx++] = (u8) ((addr << 1) & 0xFF);\r\nbuf[bufx++] =\r\n(u8) (((addr >> 16) & 0x0F) |\r\n((addr >> 18) & 0xF0));\r\n#endif\r\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\r\n}\r\n#endif\r\n#if DRXDAP_SINGLE_MASTER\r\nrc = drxbsp_i2c_write_read(dev_addr, bufx, buf,\r\nNULL, 0, NULL);\r\nif (rc == 0)\r\nrc = drxbsp_i2c_write_read(NULL, 0, NULL, dev_addr, todo, data);\r\n#else\r\nrc = drxbsp_i2c_write_read(dev_addr, bufx, buf, dev_addr, todo,\r\ndata);\r\n#endif\r\ndata += todo;\r\naddr += (todo >> 1);\r\ndatasize -= todo;\r\n} while (datasize && rc == 0);\r\nreturn rc;\r\n}\r\nstatic int drxdap_fasi_read_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 *data, u32 flags)\r\n{\r\nu8 buf[sizeof(*data)];\r\nint rc;\r\nif (!data)\r\nreturn -EINVAL;\r\nrc = drxdap_fasi_read_block(dev_addr, addr, sizeof(*data), buf, flags);\r\n*data = buf[0] + (((u16) buf[1]) << 8);\r\nreturn rc;\r\n}\r\nstatic int drxdap_fasi_read_reg32(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu32 *data, u32 flags)\r\n{\r\nu8 buf[sizeof(*data)];\r\nint rc;\r\nif (!data)\r\nreturn -EINVAL;\r\nrc = drxdap_fasi_read_block(dev_addr, addr, sizeof(*data), buf, flags);\r\n*data = (((u32) buf[0]) << 0) +\r\n(((u32) buf[1]) << 8) +\r\n(((u32) buf[2]) << 16) + (((u32) buf[3]) << 24);\r\nreturn rc;\r\n}\r\nstatic int drxdap_fasi_write_block(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 datasize,\r\nu8 *data, u32 flags)\r\n{\r\nu8 buf[DRXDAP_MAX_WCHUNKSIZE];\r\nint st = -EIO;\r\nint first_err = 0;\r\nu16 overhead_size = 0;\r\nu16 block_size = 0;\r\nif (dev_addr == NULL)\r\nreturn -EINVAL;\r\noverhead_size = (IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1) +\r\n(DRXDAP_FASI_LONG_FORMAT(addr) ? 4 : 2);\r\nif ((DRXDAP_FASI_OFFSET_TOO_LARGE(addr)) ||\r\n((!(DRXDAPFASI_LONG_ADDR_ALLOWED)) &&\r\nDRXDAP_FASI_LONG_FORMAT(addr)) ||\r\n(overhead_size > (DRXDAP_MAX_WCHUNKSIZE)) ||\r\n((datasize != 0) && (data == NULL)) || ((datasize & 1) == 1))\r\nreturn -EINVAL;\r\nflags &= DRXDAP_FASI_FLAGS;\r\nflags &= ~DRXDAP_FASI_MODEFLAGS;\r\n#if DRXDAP_SINGLE_MASTER\r\nflags |= DRXDAP_FASI_SINGLE_MASTER;\r\n#endif\r\nblock_size = ((DRXDAP_MAX_WCHUNKSIZE) - overhead_size) & ~1;\r\ndo {\r\nu16 todo = 0;\r\nu16 bufx = 0;\r\naddr &= ~DRXDAP_FASI_FLAGS;\r\naddr |= flags;\r\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\r\nif (DRXDAP_FASI_LONG_FORMAT(addr)) {\r\n#endif\r\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1)\r\nbuf[bufx++] = (u8) (((addr << 1) & 0xFF) | 0x01);\r\nbuf[bufx++] = (u8) ((addr >> 16) & 0xFF);\r\nbuf[bufx++] = (u8) ((addr >> 24) & 0xFF);\r\nbuf[bufx++] = (u8) ((addr >> 7) & 0xFF);\r\n#endif\r\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\r\n} else {\r\n#endif\r\n#if ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1)\r\nbuf[bufx++] = (u8) ((addr << 1) & 0xFF);\r\nbuf[bufx++] =\r\n(u8) (((addr >> 16) & 0x0F) |\r\n((addr >> 18) & 0xF0));\r\n#endif\r\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\r\n}\r\n#endif\r\ntodo = (block_size < datasize ? block_size : datasize);\r\nif (todo == 0) {\r\nu16 overhead_size_i2c_addr = 0;\r\nu16 data_block_size = 0;\r\noverhead_size_i2c_addr =\r\n(IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1);\r\ndata_block_size =\r\n(DRXDAP_MAX_WCHUNKSIZE - overhead_size_i2c_addr) & ~1;\r\nst = drxbsp_i2c_write_read(dev_addr,\r\n(u16) (bufx),\r\nbuf,\r\n(struct i2c_device_addr *)(NULL),\r\n0, (u8 *)(NULL));\r\nif ((st != 0) && (first_err == 0)) {\r\nfirst_err = st;\r\n}\r\nbufx = 0;\r\ntodo =\r\n(data_block_size <\r\ndatasize ? data_block_size : datasize);\r\n}\r\nmemcpy(&buf[bufx], data, todo);\r\nst = drxbsp_i2c_write_read(dev_addr,\r\n(u16) (bufx + todo),\r\nbuf,\r\n(struct i2c_device_addr *)(NULL),\r\n0, (u8 *)(NULL));\r\nif ((st != 0) && (first_err == 0)) {\r\nfirst_err = st;\r\n}\r\ndatasize -= todo;\r\ndata += todo;\r\naddr += (todo >> 1);\r\n} while (datasize);\r\nreturn first_err;\r\n}\r\nstatic int drxdap_fasi_write_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 data, u32 flags)\r\n{\r\nu8 buf[sizeof(data)];\r\nbuf[0] = (u8) ((data >> 0) & 0xFF);\r\nbuf[1] = (u8) ((data >> 8) & 0xFF);\r\nreturn drxdap_fasi_write_block(dev_addr, addr, sizeof(data), buf, flags);\r\n}\r\nstatic int drxdap_fasi_read_modify_write_reg16(struct i2c_device_addr *dev_addr,\r\nu32 waddr,\r\nu32 raddr,\r\nu16 wdata, u16 *rdata)\r\n{\r\nint rc = -EIO;\r\n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\r\nif (rdata == NULL)\r\nreturn -EINVAL;\r\nrc = drxdap_fasi_write_reg16(dev_addr, waddr, wdata, DRXDAP_FASI_RMW);\r\nif (rc == 0)\r\nrc = drxdap_fasi_read_reg16(dev_addr, raddr, rdata, 0);\r\n#endif\r\nreturn rc;\r\n}\r\nstatic int drxdap_fasi_write_reg32(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu32 data, u32 flags)\r\n{\r\nu8 buf[sizeof(data)];\r\nbuf[0] = (u8) ((data >> 0) & 0xFF);\r\nbuf[1] = (u8) ((data >> 8) & 0xFF);\r\nbuf[2] = (u8) ((data >> 16) & 0xFF);\r\nbuf[3] = (u8) ((data >> 24) & 0xFF);\r\nreturn drxdap_fasi_write_block(dev_addr, addr, sizeof(data), buf, flags);\r\n}\r\nstatic int drxj_dap_rm_write_reg16short(struct i2c_device_addr *dev_addr,\r\nu32 waddr,\r\nu32 raddr,\r\nu16 wdata, u16 *rdata)\r\n{\r\nint rc;\r\nif (rdata == NULL)\r\nreturn -EINVAL;\r\nrc = drxdap_fasi_write_reg16(dev_addr,\r\nSIO_HI_RA_RAM_S0_FLG_ACC__A,\r\nSIO_HI_RA_RAM_S0_FLG_ACC_S0_RWM__M,\r\n0x0000);\r\nif (rc == 0) {\r\nrc = drxdap_fasi_write_reg16(dev_addr, waddr, wdata,\r\n0x0000);\r\n}\r\nif (rc == 0) {\r\nrc = drxdap_fasi_read_reg16(dev_addr, raddr, rdata,\r\n0x0000);\r\n}\r\nif (rc == 0) {\r\nrc = drxdap_fasi_write_reg16(dev_addr,\r\nSIO_HI_RA_RAM_S0_FLG_ACC__A,\r\n0, 0x0000);\r\n}\r\nreturn rc;\r\n}\r\nstatic int drxj_dap_read_modify_write_reg16(struct i2c_device_addr *dev_addr,\r\nu32 waddr,\r\nu32 raddr,\r\nu16 wdata, u16 *rdata)\r\n{\r\n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\r\nreturn drxdap_fasi_read_modify_write_reg16(dev_addr,\r\nwaddr,\r\nraddr, wdata, rdata);\r\n#else\r\nreturn drxj_dap_rm_write_reg16short(dev_addr, waddr, raddr, wdata, rdata);\r\n#endif\r\n}\r\nstatic int drxj_dap_read_aud_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr, u16 *data)\r\n{\r\nu32 start_timer = 0;\r\nu32 current_timer = 0;\r\nu32 delta_timer = 0;\r\nu16 tr_status = 0;\r\nint stat = -EIO;\r\nif (DRXDAP_FASI_ADDR2BANK(addr) == 3) {\r\nstat = -EINVAL;\r\n} else {\r\nconst u32 write_bit = ((dr_xaddr_t) 1) << 16;\r\naddr &= (~write_bit);\r\nstart_timer = jiffies_to_msecs(jiffies);\r\ndo {\r\nstat = drxj_dap_read_modify_write_reg16(dev_addr,\r\naddr,\r\nSIO_HI_RA_RAM_S0_RMWBUF__A,\r\n0x0000, &tr_status);\r\nif (stat != 0)\r\nbreak;\r\ncurrent_timer = jiffies_to_msecs(jiffies);\r\ndelta_timer = current_timer - start_timer;\r\nif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\r\nstat = -EIO;\r\nbreak;\r\n}\r\n} while (((tr_status & AUD_TOP_TR_CTR_FIFO_LOCK__M) ==\r\nAUD_TOP_TR_CTR_FIFO_LOCK_LOCKED) ||\r\n((tr_status & AUD_TOP_TR_CTR_FIFO_FULL__M) ==\r\nAUD_TOP_TR_CTR_FIFO_FULL_FULL));\r\n}\r\nif (stat == 0) {\r\nstart_timer = jiffies_to_msecs(jiffies);\r\nwhile ((tr_status & AUD_TOP_TR_CTR_FIFO_RD_RDY__M) !=\r\nAUD_TOP_TR_CTR_FIFO_RD_RDY_READY) {\r\nstat = drxj_dap_read_reg16(dev_addr,\r\nAUD_TOP_TR_CTR__A,\r\n&tr_status, 0x0000);\r\nif (stat != 0)\r\nbreak;\r\ncurrent_timer = jiffies_to_msecs(jiffies);\r\ndelta_timer = current_timer - start_timer;\r\nif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\r\nstat = -EIO;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (stat == 0)\r\nstat = drxj_dap_read_modify_write_reg16(dev_addr,\r\nAUD_TOP_TR_RD_REG__A,\r\nSIO_HI_RA_RAM_S0_RMWBUF__A,\r\n0x0000, data);\r\nreturn stat;\r\n}\r\nstatic int drxj_dap_read_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 *data, u32 flags)\r\n{\r\nint stat = -EIO;\r\nif ((dev_addr == NULL) || (data == NULL))\r\nreturn -EINVAL;\r\nif (is_handled_by_aud_tr_if(addr))\r\nstat = drxj_dap_read_aud_reg16(dev_addr, addr, data);\r\nelse\r\nstat = drxdap_fasi_read_reg16(dev_addr, addr, data, flags);\r\nreturn stat;\r\n}\r\nstatic int drxj_dap_write_aud_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr, u16 data)\r\n{\r\nint stat = -EIO;\r\nif (DRXDAP_FASI_ADDR2BANK(addr) == 2) {\r\nstat = -EINVAL;\r\n} else {\r\nu32 start_timer = 0;\r\nu32 current_timer = 0;\r\nu32 delta_timer = 0;\r\nu16 tr_status = 0;\r\nconst u32 write_bit = ((dr_xaddr_t) 1) << 16;\r\naddr |= write_bit;\r\nstart_timer = jiffies_to_msecs(jiffies);\r\ndo {\r\nstat = drxj_dap_read_modify_write_reg16(dev_addr,\r\naddr,\r\nSIO_HI_RA_RAM_S0_RMWBUF__A,\r\ndata, &tr_status);\r\nif (stat != 0)\r\nbreak;\r\ncurrent_timer = jiffies_to_msecs(jiffies);\r\ndelta_timer = current_timer - start_timer;\r\nif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\r\nstat = -EIO;\r\nbreak;\r\n}\r\n} while (((tr_status & AUD_TOP_TR_CTR_FIFO_LOCK__M) ==\r\nAUD_TOP_TR_CTR_FIFO_LOCK_LOCKED) ||\r\n((tr_status & AUD_TOP_TR_CTR_FIFO_FULL__M) ==\r\nAUD_TOP_TR_CTR_FIFO_FULL_FULL));\r\n}\r\nreturn stat;\r\n}\r\nstatic int drxj_dap_write_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 data, u32 flags)\r\n{\r\nint stat = -EIO;\r\nif (dev_addr == NULL)\r\nreturn -EINVAL;\r\nif (is_handled_by_aud_tr_if(addr))\r\nstat = drxj_dap_write_aud_reg16(dev_addr, addr, data);\r\nelse\r\nstat = drxdap_fasi_write_reg16(dev_addr,\r\naddr, data, flags);\r\nreturn stat;\r\n}\r\nstatic\r\nint drxj_dap_atomic_read_write_block(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 datasize,\r\nu8 *data, bool read_flag)\r\n{\r\nstruct drxj_hi_cmd hi_cmd;\r\nint rc;\r\nu16 word;\r\nu16 dummy = 0;\r\nu16 i = 0;\r\nif (!data || !dev_addr || ((datasize % 2)) || ((datasize / 2) > 8))\r\nreturn -EINVAL;\r\nhi_cmd.cmd = SIO_HI_RA_RAM_CMD_ATOMIC_COPY;\r\nhi_cmd.param1 =\r\n(u16) ((DRXDAP_FASI_ADDR2BLOCK(DRXJ_HI_ATOMIC_BUF_START) << 6) +\r\nDRXDAP_FASI_ADDR2BANK(DRXJ_HI_ATOMIC_BUF_START));\r\nhi_cmd.param2 =\r\n(u16) DRXDAP_FASI_ADDR2OFFSET(DRXJ_HI_ATOMIC_BUF_START);\r\nhi_cmd.param3 = (u16) ((datasize / 2) - 1);\r\nif (!read_flag)\r\nhi_cmd.param3 |= DRXJ_HI_ATOMIC_WRITE;\r\nelse\r\nhi_cmd.param3 |= DRXJ_HI_ATOMIC_READ;\r\nhi_cmd.param4 = (u16) ((DRXDAP_FASI_ADDR2BLOCK(addr) << 6) +\r\nDRXDAP_FASI_ADDR2BANK(addr));\r\nhi_cmd.param5 = (u16) DRXDAP_FASI_ADDR2OFFSET(addr);\r\nif (!read_flag) {\r\nfor (i = 0; i < (datasize / 2); i++) {\r\nword = ((u16) data[2 * i]);\r\nword += (((u16) data[(2 * i) + 1]) << 8);\r\ndrxj_dap_write_reg16(dev_addr,\r\n(DRXJ_HI_ATOMIC_BUF_START + i),\r\nword, 0);\r\n}\r\n}\r\nrc = hi_command(dev_addr, &hi_cmd, &dummy);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (read_flag) {\r\nfor (i = 0; i < (datasize / 2); i++) {\r\ndrxj_dap_read_reg16(dev_addr,\r\n(DRXJ_HI_ATOMIC_BUF_START + i),\r\n&word, 0);\r\ndata[2 * i] = (u8) (word & 0xFF);\r\ndata[(2 * i) + 1] = (u8) (word >> 8);\r\n}\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic\r\nint drxj_dap_atomic_read_reg32(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu32 *data, u32 flags)\r\n{\r\nu8 buf[sizeof(*data)] = { 0 };\r\nint rc = -EIO;\r\nu32 word = 0;\r\nif (!data)\r\nreturn -EINVAL;\r\nrc = drxj_dap_atomic_read_write_block(dev_addr, addr,\r\nsizeof(*data), buf, true);\r\nif (rc < 0)\r\nreturn 0;\r\nword = (u32) buf[3];\r\nword <<= 8;\r\nword |= (u32) buf[2];\r\nword <<= 8;\r\nword |= (u32) buf[1];\r\nword <<= 8;\r\nword |= (u32) buf[0];\r\n*data = word;\r\nreturn rc;\r\n}\r\nstatic int hi_cfg_command(const struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct drxj_hi_cmd hi_cmd;\r\nu16 result = 0;\r\nint rc;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nhi_cmd.cmd = SIO_HI_RA_RAM_CMD_CONFIG;\r\nhi_cmd.param1 = SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY;\r\nhi_cmd.param2 = ext_attr->hi_cfg_timing_div;\r\nhi_cmd.param3 = ext_attr->hi_cfg_bridge_delay;\r\nhi_cmd.param4 = ext_attr->hi_cfg_wake_up_key;\r\nhi_cmd.param5 = ext_attr->hi_cfg_ctrl;\r\nhi_cmd.param6 = ext_attr->hi_cfg_transmit;\r\nrc = hi_command(demod->my_i2c_dev_addr, &hi_cmd, &result);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->hi_cfg_ctrl &= (~(SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ));\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nhi_command(struct i2c_device_addr *dev_addr, const struct drxj_hi_cmd *cmd, u16 *result)\r\n{\r\nu16 wait_cmd = 0;\r\nu16 nr_retries = 0;\r\nbool powerdown_cmd = false;\r\nint rc;\r\nswitch (cmd->cmd) {\r\ncase SIO_HI_RA_RAM_CMD_CONFIG:\r\ncase SIO_HI_RA_RAM_CMD_ATOMIC_COPY:\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_6__A, cmd->param6, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_5__A, cmd->param5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_4__A, cmd->param4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_3__A, cmd->param3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase SIO_HI_RA_RAM_CMD_BRDCTRL:\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_2__A, cmd->param2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_1__A, cmd->param1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase SIO_HI_RA_RAM_CMD_NULL:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_CMD__A, cmd->cmd, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif ((cmd->cmd) == SIO_HI_RA_RAM_CMD_RESET)\r\nmsleep(1);\r\npowerdown_cmd = (bool) ((cmd->cmd == SIO_HI_RA_RAM_CMD_CONFIG) &&\r\n(((cmd->\r\nparam5) & SIO_HI_RA_RAM_PAR_5_CFG_SLEEP__M)\r\n== SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ));\r\nif (!powerdown_cmd) {\r\ndo {\r\nnr_retries++;\r\nif (nr_retries > DRXJ_MAX_RETRIES) {\r\npr_err("timeout\n");\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SIO_HI_RA_RAM_CMD__A, &wait_cmd, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} while (wait_cmd != 0);\r\nrc = drxj_dap_read_reg16(dev_addr, SIO_HI_RA_RAM_RES__A, result, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int init_hi(const struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nint rc;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxj_dap_write_reg16(dev_addr, 0x4301D7, 0x801, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->hi_cfg_timing_div =\r\n(u16) ((common_attr->sys_clock_freq / 1000) * HI_I2C_DELAY) / 1000;\r\nif ((ext_attr->hi_cfg_timing_div) > SIO_HI_RA_RAM_PAR_2_CFG_DIV__M)\r\next_attr->hi_cfg_timing_div = SIO_HI_RA_RAM_PAR_2_CFG_DIV__M;\r\next_attr->hi_cfg_bridge_delay =\r\n(u16) ((common_attr->osc_clock_freq / 1000) * HI_I2C_BRIDGE_DELAY) /\r\n1000;\r\nif ((ext_attr->hi_cfg_bridge_delay) > SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M)\r\next_attr->hi_cfg_bridge_delay = SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M;\r\next_attr->hi_cfg_bridge_delay += ((ext_attr->hi_cfg_bridge_delay) <<\r\nSIO_HI_RA_RAM_PAR_3_CFG_DBL_SCL__B);\r\next_attr->hi_cfg_wake_up_key = DRXJ_WAKE_UP_KEY;\r\next_attr->hi_cfg_ctrl = (SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE);\r\next_attr->hi_cfg_transmit = SIO_HI_RA_RAM_PAR_6__PRE;\r\nrc = hi_cfg_command(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_device_capabilities(struct drx_demod_instance *demod)\r\n{\r\nstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\r\nstruct drxj_data *ext_attr = (struct drxj_data *) NULL;\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nu16 sio_pdr_ohw_cfg = 0;\r\nu32 sio_top_jtagid_lo = 0;\r\nu16 bid = 0;\r\nint rc;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SIO_PDR_OHW_CFG__A, &sio_pdr_ohw_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch ((sio_pdr_ohw_cfg & SIO_PDR_OHW_CFG_FREF_SEL__M)) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\ncommon_attr->osc_clock_freq = 27000;\r\nbreak;\r\ncase 2:\r\ncommon_attr->osc_clock_freq = 20250;\r\nbreak;\r\ncase 3:\r\ncommon_attr->osc_clock_freq = 4000;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nrc = drxdap_fasi_read_reg32(dev_addr, SIO_TOP_JTAGID_LO__A, &sio_top_jtagid_lo, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->mfx = (u8) ((sio_top_jtagid_lo >> 29) & 0xF);\r\nswitch ((sio_top_jtagid_lo >> 12) & 0xFF) {\r\ncase 0x31:\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SIO_PDR_UIO_IN_HI__A, &bid, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbid = (bid >> 10) & 0xf;\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->has_lna = true;\r\next_attr->has_ntsc = false;\r\next_attr->has_btsc = false;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = false;\r\next_attr->has_gpio = false;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x33:\r\next_attr->has_lna = false;\r\next_attr->has_ntsc = false;\r\next_attr->has_btsc = false;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = false;\r\next_attr->has_gpio = false;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x45:\r\next_attr->has_lna = true;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = false;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x46:\r\next_attr->has_lna = false;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = false;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x41:\r\next_attr->has_lna = true;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = true;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x43:\r\next_attr->has_lna = false;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = true;\r\next_attr->has_oob = false;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = false;\r\nbreak;\r\ncase 0x32:\r\next_attr->has_lna = true;\r\next_attr->has_ntsc = false;\r\next_attr->has_btsc = false;\r\next_attr->has_oob = true;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = true;\r\nbreak;\r\ncase 0x34:\r\next_attr->has_lna = false;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = true;\r\next_attr->has_oob = true;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = true;\r\nbreak;\r\ncase 0x42:\r\next_attr->has_lna = true;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = true;\r\next_attr->has_oob = true;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = true;\r\nbreak;\r\ncase 0x44:\r\next_attr->has_lna = false;\r\next_attr->has_ntsc = true;\r\next_attr->has_btsc = true;\r\next_attr->has_oob = true;\r\next_attr->has_smatx = true;\r\next_attr->has_smarx = true;\r\next_attr->has_gpio = true;\r\next_attr->has_irqn = true;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\nbreak;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int power_up_device(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nu8 data = 0;\r\nu16 retry_count = 0;\r\nstruct i2c_device_addr wake_up_addr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nwake_up_addr.i2c_addr = DRXJ_WAKE_UP_KEY;\r\nwake_up_addr.i2c_dev_id = dev_addr->i2c_dev_id;\r\nwake_up_addr.user_data = dev_addr->user_data;\r\ndo {\r\ndata = 0;\r\ndrxbsp_i2c_write_read(&wake_up_addr, 1, &data,\r\n(struct i2c_device_addr *)(NULL), 0,\r\n(u8 *)(NULL));\r\nmsleep(10);\r\nretry_count++;\r\n} while ((drxbsp_i2c_write_read\r\n((struct i2c_device_addr *) (NULL), 0, (u8 *)(NULL), dev_addr, 1,\r\n&data)\r\n!= 0) && (retry_count < DRXJ_MAX_RETRIES_POWERUP));\r\nmsleep(10);\r\nif (retry_count == DRXJ_MAX_RETRIES_POWERUP)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int\r\nctrl_set_cfg_mpeg_output(struct drx_demod_instance *demod, struct drx_cfg_mpeg_output *cfg_data)\r\n{\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\r\nint rc;\r\nu16 fec_oc_reg_mode = 0;\r\nu16 fec_oc_reg_ipr_mode = 0;\r\nu16 fec_oc_reg_ipr_invert = 0;\r\nu32 max_bit_rate = 0;\r\nu32 rcn_rate = 0;\r\nu32 nr_bits = 0;\r\nu16 sio_pdr_md_cfg = 0;\r\nu16 invert_data_mask =\r\nFEC_OC_IPR_INVERT_MD7__M | FEC_OC_IPR_INVERT_MD6__M |\r\nFEC_OC_IPR_INVERT_MD5__M | FEC_OC_IPR_INVERT_MD4__M |\r\nFEC_OC_IPR_INVERT_MD3__M | FEC_OC_IPR_INVERT_MD2__M |\r\nFEC_OC_IPR_INVERT_MD1__M | FEC_OC_IPR_INVERT_MD0__M;\r\nif ((demod == NULL) || (cfg_data == NULL))\r\nreturn -EINVAL;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\nif (cfg_data->enable_mpeg_output == true) {\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_OCR_INVERT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_USAGE__A, 7, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_CTL_UPD_RATE__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_INT_UPD_RATE__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_A__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_B__A, 7, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_LWM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_HWM__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\nswitch (ext_attr->constellation) {\r\ncase DRX_CONSTELLATION_QAM256:\r\nnr_bits = 8;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM128:\r\nnr_bits = 7;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nnr_bits = 6;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\nnr_bits = 5;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM16:\r\nnr_bits = 4;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nmax_bit_rate =\r\n(ext_attr->curr_symbol_rate / 8) * nr_bits * 188;\r\ncase DRX_STANDARD_ITU_B:\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_USAGE__A, FEC_OC_FCT_USAGE__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_CTL_UPD_RATE__A, FEC_OC_TMD_CTL_UPD_RATE__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_INT_UPD_RATE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_A__A, FEC_OC_AVR_PARM_A__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_B__A, FEC_OC_AVR_PARM_B__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cfg_data->static_clk == true) {\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, 0xD, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, FEC_OC_RCN_GAIN__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_LWM__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_HWM__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_MODE__A, &fec_oc_reg_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_IPR_MODE__A, &fec_oc_reg_ipr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cfg_data->insert_rs_byte == true) {\r\nfec_oc_reg_mode |= FEC_OC_MODE_PARITY__M;\r\nfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_MVAL_DIS_PAR__M;\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\nrcn_rate = 0x004854D3;\r\nbreak;\r\ncase DRX_STANDARD_ITU_B:\r\nfec_oc_reg_mode |= FEC_OC_MODE_TRANSPARENT__M;\r\nswitch (ext_attr->constellation) {\r\ncase DRX_CONSTELLATION_QAM256:\r\nrcn_rate = 0x008945E7;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nrcn_rate = 0x005F64D4;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\nrcn_rate =\r\n(frac28\r\n(max_bit_rate,\r\n(u32) (common_attr->sys_clock_freq / 8))) /\r\n188;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n} else {\r\nfec_oc_reg_mode &= (~FEC_OC_MODE_PARITY__M);\r\nfec_oc_reg_ipr_mode &= (~FEC_OC_IPR_MODE_MVAL_DIS_PAR__M);\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\nrcn_rate = 0x0041605C;\r\nbreak;\r\ncase DRX_STANDARD_ITU_B:\r\nfec_oc_reg_mode &= (~FEC_OC_MODE_TRANSPARENT__M);\r\nswitch (ext_attr->constellation) {\r\ncase DRX_CONSTELLATION_QAM256:\r\nrcn_rate = 0x0082D6A0;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nrcn_rate = 0x005AEC1A;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\nrcn_rate =\r\n(frac28\r\n(max_bit_rate,\r\n(u32) (common_attr->sys_clock_freq / 8))) /\r\n204;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n}\r\nif (cfg_data->enable_parallel == true) {\r\nfec_oc_reg_ipr_mode &= (~(FEC_OC_IPR_MODE_SERIAL__M));\r\n} else {\r\nfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_SERIAL__M;\r\n}\r\nif (cfg_data->invert_data == true)\r\nfec_oc_reg_ipr_invert |= invert_data_mask;\r\nelse\r\nfec_oc_reg_ipr_invert &= (~(invert_data_mask));\r\nif (cfg_data->invert_err == true)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MERR__M;\r\nelse\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MERR__M));\r\nif (cfg_data->invert_str == true)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MSTRT__M;\r\nelse\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MSTRT__M));\r\nif (cfg_data->invert_val == true)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MVAL__M;\r\nelse\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MVAL__M));\r\nif (cfg_data->invert_clk == true)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MCLK__M;\r\nelse\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MCLK__M));\r\nif (cfg_data->static_clk == true) {\r\nu32 dto_rate = 0;\r\nu32 bit_rate = 0;\r\nu16 fec_oc_dto_burst_len = 0;\r\nu16 fec_oc_dto_period = 0;\r\nfec_oc_dto_burst_len = FEC_OC_DTO_BURST_LEN__PRE;\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\nfec_oc_dto_period = 4;\r\nif (cfg_data->insert_rs_byte == true)\r\nfec_oc_dto_burst_len = 208;\r\nbreak;\r\ncase DRX_STANDARD_ITU_A:\r\n{\r\nu32 symbol_rate_th = 6400000;\r\nif (cfg_data->insert_rs_byte == true) {\r\nfec_oc_dto_burst_len = 204;\r\nsymbol_rate_th = 5900000;\r\n}\r\nif (ext_attr->curr_symbol_rate >=\r\nsymbol_rate_th) {\r\nfec_oc_dto_period = 0;\r\n} else {\r\nfec_oc_dto_period = 1;\r\n}\r\n}\r\nbreak;\r\ncase DRX_STANDARD_ITU_B:\r\nfec_oc_dto_period = 1;\r\nif (cfg_data->insert_rs_byte == true)\r\nfec_oc_dto_burst_len = 128;\r\nbreak;\r\ncase DRX_STANDARD_ITU_C:\r\nfec_oc_dto_period = 1;\r\nif (cfg_data->insert_rs_byte == true)\r\nfec_oc_dto_burst_len = 204;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nbit_rate =\r\ncommon_attr->sys_clock_freq * 1000 / (fec_oc_dto_period +\r\n2);\r\ndto_rate =\r\nfrac28(bit_rate, common_attr->sys_clock_freq * 1000);\r\ndto_rate >>= 3;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_RATE_HI__A, (u16)((dto_rate >> 16) & FEC_OC_DTO_RATE_HI__M), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_RATE_LO__A, (u16)(dto_rate & FEC_OC_DTO_RATE_LO_RATE_LO__M), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_MODE__A, FEC_OC_DTO_MODE_DYNAMIC__M | FEC_OC_DTO_MODE_OFFSET_ENABLE__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_MODE__A, FEC_OC_FCT_MODE_RAT_ENA__M | FEC_OC_FCT_MODE_VIRT_ENA__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_BURST_LEN__A, fec_oc_dto_burst_len, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (ext_attr->mpeg_output_clock_rate != DRXJ_MPEGOUTPUT_CLOCK_RATE_AUTO)\r\nfec_oc_dto_period = ext_attr->mpeg_output_clock_rate - 1;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_PERIOD__A, fec_oc_dto_period, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_MODE__A, FEC_OC_DTO_MODE_DYNAMIC__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_MODE__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxdap_fasi_write_reg32(dev_addr, FEC_OC_RCN_CTL_RATE_LO__A, rcn_rate, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_MODE__A, fec_oc_reg_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_MODE__A, fec_oc_reg_ipr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_INVERT__A, fec_oc_reg_ipr_invert, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MSTRT_CFG__A, 0x0013, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MERR_CFG__A, 0x0013, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MCLK_CFG__A, MPEG_OUTPUT_CLK_DRIVE_STRENGTH << SIO_PDR_MCLK_CFG_DRIVE__B | 0x03 << SIO_PDR_MCLK_CFG_MODE__B, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MVAL_CFG__A, 0x0013, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nsio_pdr_md_cfg =\r\nMPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH <<\r\nSIO_PDR_MD0_CFG_DRIVE__B | 0x03 << SIO_PDR_MD0_CFG_MODE__B;\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cfg_data->enable_parallel == true) {\r\nsio_pdr_md_cfg =\r\nMPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH <<\r\nSIO_PDR_MD0_CFG_DRIVE__B | 0x03 <<\r\nSIO_PDR_MD0_CFG_MODE__B;\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, sio_pdr_md_cfg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MON_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MSTRT_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MERR_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MCLK_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MVAL_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MON_CFG__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\ncommon_attr->mpeg_cfg.enable_mpeg_output = cfg_data->enable_mpeg_output;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_mpegtei_handling(struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nint rc;\r\nu16 fec_oc_dpr_mode = 0;\r\nu16 fec_oc_snc_mode = 0;\r\nu16 fec_oc_ems_mode = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_DPR_MODE__A, &fec_oc_dpr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_EMS_MODE__A, &fec_oc_ems_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfec_oc_dpr_mode &= (~FEC_OC_DPR_MODE_ERR_DISABLE__M);\r\nfec_oc_snc_mode &= (~(FEC_OC_SNC_MODE_ERROR_CTL__M |\r\nFEC_OC_SNC_MODE_CORR_DISABLE__M));\r\nfec_oc_ems_mode &= (~FEC_OC_EMS_MODE_MODE__M);\r\nif (ext_attr->disable_te_ihandling) {\r\nfec_oc_dpr_mode |= FEC_OC_DPR_MODE_ERR_DISABLE__M;\r\nfec_oc_snc_mode |= FEC_OC_SNC_MODE_CORR_DISABLE__M |\r\n((0x2) << (FEC_OC_SNC_MODE_ERROR_CTL__B));\r\nfec_oc_ems_mode |= ((0x01) << (FEC_OC_EMS_MODE_MODE__B));\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_DPR_MODE__A, fec_oc_dpr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_MODE__A, fec_oc_snc_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_EMS_MODE__A, fec_oc_ems_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int bit_reverse_mpeg_output(struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nint rc;\r\nu16 fec_oc_ipr_mode = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_IPR_MODE__A, &fec_oc_ipr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfec_oc_ipr_mode &= (~FEC_OC_IPR_MODE_REVERSE_ORDER__M);\r\nif (ext_attr->bit_reverse_mpeg_outout)\r\nfec_oc_ipr_mode |= FEC_OC_IPR_MODE_REVERSE_ORDER__M;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_MODE__A, fec_oc_ipr_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_mpeg_start_width(struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\r\nstruct drx_common_attr *common_attr = (struct drx_common_attr *) NULL;\r\nint rc;\r\nu16 fec_oc_comm_mb = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ncommon_attr = demod->my_common_attr;\r\nif ((common_attr->mpeg_cfg.static_clk == true)\r\n&& (common_attr->mpeg_cfg.enable_parallel == false)) {\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_COMM_MB__A, &fec_oc_comm_mb, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfec_oc_comm_mb &= ~FEC_OC_COMM_MB_CTL_ON;\r\nif (ext_attr->mpeg_start_width == DRXJ_MPEG_START_WIDTH_8CLKCYC)\r\nfec_oc_comm_mb |= FEC_OC_COMM_MB_CTL_ON;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_COMM_MB__A, fec_oc_comm_mb, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int ctrl_set_uio_cfg(struct drx_demod_instance *demod, struct drxuio_cfg *uio_cfg)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nint rc;\r\nif ((uio_cfg == NULL) || (demod == NULL))\r\nreturn -EINVAL;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch (uio_cfg->uio) {\r\ncase DRX_UIO1:\r\nif (!ext_attr->has_smatx)\r\nreturn -EIO;\r\nswitch (uio_cfg->mode) {\r\ncase DRX_UIO_MODE_FIRMWARE_SMA:\r\ncase DRX_UIO_MODE_FIRMWARE_SAW:\r\ncase DRX_UIO_MODE_READWRITE:\r\next_attr->uio_sma_tx_mode = uio_cfg->mode;\r\nbreak;\r\ncase DRX_UIO_MODE_DISABLE:\r\next_attr->uio_sma_tx_mode = uio_cfg->mode;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase DRX_UIO2:\r\nif (!ext_attr->has_smarx)\r\nreturn -EIO;\r\nswitch (uio_cfg->mode) {\r\ncase DRX_UIO_MODE_FIRMWARE0:\r\ncase DRX_UIO_MODE_READWRITE:\r\next_attr->uio_sma_rx_mode = uio_cfg->mode;\r\nbreak;\r\ncase DRX_UIO_MODE_DISABLE:\r\next_attr->uio_sma_rx_mode = uio_cfg->mode;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_RX_CFG__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase DRX_UIO3:\r\nif (!ext_attr->has_gpio)\r\nreturn -EIO;\r\nswitch (uio_cfg->mode) {\r\ncase DRX_UIO_MODE_FIRMWARE0:\r\ncase DRX_UIO_MODE_READWRITE:\r\next_attr->uio_gpio_mode = uio_cfg->mode;\r\nbreak;\r\ncase DRX_UIO_MODE_DISABLE:\r\next_attr->uio_gpio_mode = uio_cfg->mode;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_GPIO_CFG__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase DRX_UIO4:\r\nif (!ext_attr->has_irqn)\r\nreturn -EIO;\r\nswitch (uio_cfg->mode) {\r\ncase DRX_UIO_MODE_READWRITE:\r\next_attr->uio_irqn_mode = uio_cfg->mode;\r\nbreak;\r\ncase DRX_UIO_MODE_DISABLE:\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_IRQN_CFG__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->uio_irqn_mode = uio_cfg->mode;\r\nbreak;\r\ncase DRX_UIO_MODE_FIRMWARE0:\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_uio_write(struct drx_demod_instance *demod, struct drxuio_data *uio_data)\r\n{\r\nstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\r\nint rc;\r\nu16 pin_cfg_value = 0;\r\nu16 value = 0;\r\nif ((uio_data == NULL) || (demod == NULL))\r\nreturn -EINVAL;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch (uio_data->uio) {\r\ncase DRX_UIO1:\r\nif (!ext_attr->has_smatx)\r\nreturn -EIO;\r\nif ((ext_attr->uio_sma_tx_mode != DRX_UIO_MODE_READWRITE)\r\n&& (ext_attr->uio_sma_tx_mode != DRX_UIO_MODE_FIRMWARE_SAW)) {\r\nreturn -EIO;\r\n}\r\npin_cfg_value = 0;\r\npin_cfg_value |= 0x0113;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, pin_cfg_value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!uio_data->value)\r\nvalue &= 0x7FFF;\r\nelse\r\nvalue |= 0x8000;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_UIO2:\r\nif (!ext_attr->has_smarx)\r\nreturn -EIO;\r\nif (ext_attr->uio_sma_rx_mode != DRX_UIO_MODE_READWRITE)\r\nreturn -EIO;\r\npin_cfg_value = 0;\r\npin_cfg_value |= 0x0113;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_RX_CFG__A, pin_cfg_value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!uio_data->value)\r\nvalue &= 0xBFFF;\r\nelse\r\nvalue |= 0x4000;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_UIO3:\r\nif (!ext_attr->has_gpio)\r\nreturn -EIO;\r\nif (ext_attr->uio_gpio_mode != DRX_UIO_MODE_READWRITE)\r\nreturn -EIO;\r\npin_cfg_value = 0;\r\npin_cfg_value |= 0x0113;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_GPIO_CFG__A, pin_cfg_value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_HI__A, &value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!uio_data->value)\r\nvalue &= 0xFFFB;\r\nelse\r\nvalue |= 0x0004;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_HI__A, value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_UIO4:\r\nif (!ext_attr->has_irqn)\r\nreturn -EIO;\r\nif (ext_attr->uio_irqn_mode != DRX_UIO_MODE_READWRITE)\r\nreturn -EIO;\r\npin_cfg_value = 0;\r\npin_cfg_value |= 0x0113;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_IRQN_CFG__A, pin_cfg_value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (uio_data->value == false)\r\nvalue &= 0xEFFF;\r\nelse\r\nvalue |= 0x1000;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_i2c_bridge(struct drx_demod_instance *demod, bool *bridge_closed)\r\n{\r\nstruct drxj_hi_cmd hi_cmd;\r\nu16 result = 0;\r\nif (bridge_closed == NULL)\r\nreturn -EINVAL;\r\nhi_cmd.cmd = SIO_HI_RA_RAM_CMD_BRDCTRL;\r\nhi_cmd.param1 = SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY;\r\nif (*bridge_closed)\r\nhi_cmd.param2 = SIO_HI_RA_RAM_PAR_2_BRD_CFG_CLOSED;\r\nelse\r\nhi_cmd.param2 = SIO_HI_RA_RAM_PAR_2_BRD_CFG_OPEN;\r\nreturn hi_command(demod->my_i2c_dev_addr, &hi_cmd, &result);\r\n}\r\nstatic int smart_ant_init(struct drx_demod_instance *demod)\r\n{\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxuio_cfg uio_cfg = { DRX_UIO1, DRX_UIO_MODE_FIRMWARE_SMA };\r\nint rc;\r\nu16 data = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SIO_SA_TX_COMMAND__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (ext_attr->smart_ant_inverted) {\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_SA_TX_COMMAND__A, (data | SIO_SA_TX_COMMAND_TX_INVERT__M) | SIO_SA_TX_COMMAND_TX_ENABLE__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_SA_TX_COMMAND__A, (data & (~SIO_SA_TX_COMMAND_TX_INVERT__M)) | SIO_SA_TX_COMMAND_TX_ENABLE__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = ctrl_set_uio_cfg(demod, &uio_cfg);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, 0x13, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_GPIO_FNC__A, 0x03, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int scu_command(struct i2c_device_addr *dev_addr, struct drxjscu_cmd *cmd)\r\n{\r\nint rc;\r\nu16 cur_cmd = 0;\r\nunsigned long timeout;\r\nif (cmd == NULL)\r\nreturn -EINVAL;\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_COMMAND__A, &cur_cmd, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cur_cmd != DRX_SCU_READY)\r\nreturn -EIO;\r\nswitch (cmd->parameter_len) {\r\ncase 5:\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_4__A, *(cmd->parameter + 4), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 4:\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_3__A, *(cmd->parameter + 3), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 3:\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_2__A, *(cmd->parameter + 2), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 2:\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_1__A, *(cmd->parameter + 1), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 1:\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_0__A, *(cmd->parameter + 0), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 0:\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_COMMAND__A, cmd->command, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ntimeout = jiffies + msecs_to_jiffies(DRXJ_MAX_WAITTIME);\r\nwhile (time_is_after_jiffies(timeout)) {\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_COMMAND__A, &cur_cmd, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cur_cmd == DRX_SCU_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (cur_cmd != DRX_SCU_READY)\r\nreturn -EIO;\r\nif ((cmd->result_len > 0) && (cmd->result != NULL)) {\r\ns16 err;\r\nswitch (cmd->result_len) {\r\ncase 4:\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_3__A, cmd->result + 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 3:\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_2__A, cmd->result + 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 2:\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_1__A, cmd->result + 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 1:\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_0__A, cmd->result + 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncase 0:\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nerr = cmd->result[0];\r\nif ((err == (s16) SCU_RAM_PARAM_0_RESULT_UNKSTD)\r\n|| (err == (s16) SCU_RAM_PARAM_0_RESULT_UNKCMD)\r\n|| (err == (s16) SCU_RAM_PARAM_0_RESULT_INVPAR)\r\n|| (err == (s16) SCU_RAM_PARAM_0_RESULT_SIZE)\r\n) {\r\nreturn -EINVAL;\r\n}\r\nelse if (err < 0)\r\nreturn -EIO;\r\nelse\r\nreturn 0;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic\r\nint drxj_dap_scu_atomic_read_write_block(struct i2c_device_addr *dev_addr, u32 addr, u16 datasize,\r\nu8 *data, bool read_flag)\r\n{\r\nstruct drxjscu_cmd scu_cmd;\r\nint rc;\r\nu16 set_param_parameters[15];\r\nu16 cmd_result[15];\r\nif (!data || !dev_addr || (datasize % 2) || ((datasize / 2) > 16))\r\nreturn -EINVAL;\r\nset_param_parameters[1] = (u16) ADDR_AT_SCU_SPACE(addr);\r\nif (read_flag) {\r\nset_param_parameters[0] = ((~(0x0080)) & datasize);\r\nscu_cmd.parameter_len = 2;\r\nscu_cmd.result_len = datasize / 2 + 2;\r\n} else {\r\nint i = 0;\r\nset_param_parameters[0] = 0x0080 | datasize;\r\nfor (i = 0; i < (datasize / 2); i++) {\r\nset_param_parameters[i + 2] =\r\n(data[2 * i] | (data[(2 * i) + 1] << 8));\r\n}\r\nscu_cmd.parameter_len = datasize / 2 + 2;\r\nscu_cmd.result_len = 1;\r\n}\r\nscu_cmd.command =\r\nSCU_RAM_COMMAND_STANDARD_TOP |\r\nSCU_RAM_COMMAND_CMD_AUX_SCU_ATOMIC_ACCESS;\r\nscu_cmd.result = cmd_result;\r\nscu_cmd.parameter = set_param_parameters;\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (read_flag) {\r\nint i = 0;\r\nfor (i = 0; i < (datasize / 2); i++) {\r\ndata[2 * i] = (u8) (scu_cmd.result[i + 2] & 0xFF);\r\ndata[(2 * i) + 1] = (u8) (scu_cmd.result[i + 2] >> 8);\r\n}\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic\r\nint drxj_dap_scu_atomic_read_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 *data, u32 flags)\r\n{\r\nu8 buf[2] = { 0 };\r\nint rc = -EIO;\r\nu16 word = 0;\r\nif (!data)\r\nreturn -EINVAL;\r\nrc = drxj_dap_scu_atomic_read_write_block(dev_addr, addr, 2, buf, true);\r\nif (rc < 0)\r\nreturn rc;\r\nword = (u16) (buf[0] + (buf[1] << 8));\r\n*data = word;\r\nreturn rc;\r\n}\r\nstatic\r\nint drxj_dap_scu_atomic_write_reg16(struct i2c_device_addr *dev_addr,\r\nu32 addr,\r\nu16 data, u32 flags)\r\n{\r\nu8 buf[2];\r\nint rc = -EIO;\r\nbuf[0] = (u8) (data & 0xff);\r\nbuf[1] = (u8) ((data >> 8) & 0xff);\r\nrc = drxj_dap_scu_atomic_read_write_block(dev_addr, addr, 2, buf, false);\r\nreturn rc;\r\n}\r\nstatic int adc_sync_measurement(struct drx_demod_instance *demod, u16 *count)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nint rc;\r\nu16 data = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_COMM_EXEC__A, IQM_AF_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_START_LOCK__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nmsleep(1);\r\n*count = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE0__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (data == 127)\r\n*count = *count + 1;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE1__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (data == 127)\r\n*count = *count + 1;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE2__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (data == 127)\r\n*count = *count + 1;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int adc_synchronization(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nint rc;\r\nu16 count = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = adc_sync_measurement(demod, &count);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (count == 1) {\r\nu16 clk_neg = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_CLKNEG__A, &clk_neg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nclk_neg ^= IQM_AF_CLKNEG_CLKNEGDATA__M;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLKNEG__A, clk_neg, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = adc_sync_measurement(demod, &count);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif (count < 2)\r\nreturn -EIO;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int init_agc(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drx_common_attr *common_attr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct drxj_cfg_agc *p_agc_rf_settings = NULL;\r\nstruct drxj_cfg_agc *p_agc_if_settings = NULL;\r\nint rc;\r\nu16 ingain_tgt_max = 0;\r\nu16 clp_dir_to = 0;\r\nu16 sns_sum_max = 0;\r\nu16 clp_sum_max = 0;\r\nu16 sns_dir_to = 0;\r\nu16 ki_innergain_min = 0;\r\nu16 agc_ki = 0;\r\nu16 ki_max = 0;\r\nu16 if_iaccu_hi_tgt_min = 0;\r\nu16 data = 0;\r\nu16 agc_ki_dgain = 0;\r\nu16 ki_min = 0;\r\nu16 clp_ctrl_mode = 0;\r\nu16 agc_rf = 0;\r\nu16 agc_if = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_8VSB:\r\nclp_sum_max = 1023;\r\nclp_dir_to = (u16) (-9);\r\nsns_sum_max = 1023;\r\nsns_dir_to = (u16) (-9);\r\nki_innergain_min = (u16) (-32768);\r\nki_max = 0x032C;\r\nagc_ki_dgain = 0xC;\r\nif_iaccu_hi_tgt_min = 2047;\r\nki_min = 0x0117;\r\ningain_tgt_max = 16383;\r\nclp_ctrl_mode = 0;\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MINGAIN__A, 0x7fff, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXGAIN__A, 0x0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCCNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_WD__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_STP__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCCNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_WD__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_STP__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN__A, 1024, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_VSB_AGC_POW_TGT__A, 22600, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT__A, 13200, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\np_agc_if_settings = &(ext_attr->vsb_if_agc_cfg);\r\np_agc_rf_settings = &(ext_attr->vsb_rf_agc_cfg);\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\ncase DRX_STANDARD_ITU_B:\r\ningain_tgt_max = 5119;\r\nclp_sum_max = 1023;\r\nclp_dir_to = (u16) (-5);\r\nsns_sum_max = 127;\r\nsns_dir_to = (u16) (-3);\r\nki_innergain_min = 0;\r\nki_max = 0x0657;\r\nif_iaccu_hi_tgt_min = 2047;\r\nagc_ki_dgain = 0x7;\r\nki_min = 0x0117;\r\nclp_ctrl_mode = 0;\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MINGAIN__A, 0x7fff, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXGAIN__A, 0x0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCCNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_WD__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_STP__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCCNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_WD__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_STP__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\np_agc_if_settings = &(ext_attr->qam_if_agc_cfg);\r\np_agc_rf_settings = &(ext_attr->qam_rf_agc_cfg);\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT__A, p_agc_if_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_AGC_KI__A, &agc_ki, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nagc_ki &= 0xf000;\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI__A, agc_ki, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT_MIN__A, p_agc_if_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN__A, p_agc_if_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT_MAX__A, ingain_tgt_max, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MIN__A, if_iaccu_hi_tgt_min, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_HI__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_LO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_IACCU_HI__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_IACCU_LO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_MAX__A, 32767, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM_MAX__A, clp_sum_max, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM_MAX__A, sns_sum_max, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_INNERGAIN_MIN__A, ki_innergain_min, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_FAST_SNS_CTRL_DELAY__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_CYCLEN__A, 500, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCLEN__A, 500, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXMINGAIN_TH__A, 20, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MIN__A, ki_min, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAX__A, ki_max, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_RED__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM_MIN__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCLEN__A, 500, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_TO__A, clp_dir_to, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM_MIN__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_TO__A, sns_dir_to, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CTRL_MODE__A, clp_ctrl_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nagc_rf = 0x800 + p_agc_rf_settings->cut_off_current;\r\nif (common_attr->tuner_rf_agc_pol == true)\r\nagc_rf = 0x87ff - agc_rf;\r\nagc_if = 0x800;\r\nif (common_attr->tuner_if_agc_pol == true)\r\nagc_rf = 0x87ff - agc_rf;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_AGC_RF__A, agc_rf, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_AGC_IF__A, agc_if, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_DGAIN__M;\r\ndata |= (agc_ki_dgain << SCU_RAM_AGC_KI_DGAIN__B);\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_frequency(struct drx_demod_instance *demod,\r\nstruct drx_channel *channel, s32 tuner_freq_offset)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nint rc;\r\ns32 sampling_frequency = 0;\r\ns32 frequency_shift = 0;\r\ns32 if_freq_actual = 0;\r\ns32 rf_freq_residual = -1 * tuner_freq_offset;\r\ns32 adc_freq = 0;\r\ns32 intermediate_freq = 0;\r\nu32 iqm_fs_rate_ofs = 0;\r\nbool adc_flip = true;\r\nbool select_pos_image = false;\r\nbool rf_mirror;\r\nbool tuner_mirror;\r\nbool image_to_select = true;\r\ns32 fm_frequency_shift = 0;\r\nrf_mirror = (ext_attr->mirror == DRX_MIRROR_YES) ? true : false;\r\ntuner_mirror = demod->my_common_attr->mirror_freq_spect ? false : true;\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\ncase DRX_STANDARD_PAL_SECAM_LP:\r\ncase DRX_STANDARD_8VSB:\r\nselect_pos_image = true;\r\nbreak;\r\ncase DRX_STANDARD_FM:\r\nfm_frequency_shift = 1000;\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_NTSC:\r\ncase DRX_STANDARD_PAL_SECAM_BG:\r\ncase DRX_STANDARD_PAL_SECAM_DK:\r\ncase DRX_STANDARD_PAL_SECAM_I:\r\ncase DRX_STANDARD_PAL_SECAM_L:\r\nselect_pos_image = false;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nintermediate_freq = demod->my_common_attr->intermediate_freq;\r\nsampling_frequency = demod->my_common_attr->sys_clock_freq / 3;\r\nif (tuner_mirror)\r\nif_freq_actual = intermediate_freq + rf_freq_residual + fm_frequency_shift;\r\nelse\r\nif_freq_actual = intermediate_freq - rf_freq_residual - fm_frequency_shift;\r\nif (if_freq_actual > sampling_frequency / 2) {\r\nadc_freq = sampling_frequency - if_freq_actual;\r\nadc_flip = true;\r\n} else {\r\nadc_freq = if_freq_actual;\r\nadc_flip = false;\r\n}\r\nfrequency_shift = adc_freq;\r\nimage_to_select =\r\n(bool) (rf_mirror ^ tuner_mirror ^ adc_flip ^ select_pos_image);\r\niqm_fs_rate_ofs = frac28(frequency_shift, sampling_frequency);\r\nif (image_to_select)\r\niqm_fs_rate_ofs = ~iqm_fs_rate_ofs + 1;\r\nrc = drxdap_fasi_write_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, iqm_fs_rate_ofs, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->iqm_fs_rate_ofs = iqm_fs_rate_ofs;\r\next_attr->pos_image = (bool) (rf_mirror ^ tuner_mirror ^ select_pos_image);\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_acc_pkt_err(struct drx_demod_instance *demod, u16 *packet_err)\r\n{\r\nint rc;\r\nstatic u16 pkt_err;\r\nstatic u16 last_pkt_err;\r\nu16 data = 0;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (ext_attr->reset_pkt_err_acc) {\r\nlast_pkt_err = data;\r\npkt_err = 0;\r\next_attr->reset_pkt_err_acc = false;\r\n}\r\nif (data < last_pkt_err) {\r\npkt_err += 0xffff - last_pkt_err;\r\npkt_err += data;\r\n} else {\r\npkt_err += (data - last_pkt_err);\r\n}\r\n*packet_err = pkt_err;\r\nlast_pkt_err = data;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_agc_rf(struct drx_demod_instance *demod, struct drxj_cfg_agc *agc_settings, bool atomic)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct drxj_cfg_agc *p_agc_settings = NULL;\r\nstruct drx_common_attr *common_attr = NULL;\r\nint rc;\r\ndrx_write_reg16func_t scu_wr16 = NULL;\r\ndrx_read_reg16func_t scu_rr16 = NULL;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nif (atomic) {\r\nscu_rr16 = drxj_dap_scu_atomic_read_reg16;\r\nscu_wr16 = drxj_dap_scu_atomic_write_reg16;\r\n} else {\r\nscu_rr16 = drxj_dap_read_reg16;\r\nscu_wr16 = drxj_dap_write_reg16;\r\n}\r\nif ((ext_attr->standard == agc_settings->standard) ||\r\n(DRXJ_ISQAMSTD(ext_attr->standard) &&\r\nDRXJ_ISQAMSTD(agc_settings->standard)) ||\r\n(DRXJ_ISATVSTD(ext_attr->standard) &&\r\nDRXJ_ISATVSTD(agc_settings->standard))) {\r\nu16 data = 0;\r\nswitch (agc_settings->ctrl_mode) {\r\ncase DRX_AGC_CTRL_AUTO:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_RF__M;\r\nif (ext_attr->standard == DRX_STANDARD_8VSB)\r\ndata |= (2 << SCU_RAM_AGC_KI_RF__B);\r\nelse if (DRXJ_ISQAMSTD(ext_attr->standard))\r\ndata |= (5 << SCU_RAM_AGC_KI_RF__B);\r\nelse\r\ndata |= (4 << SCU_RAM_AGC_KI_RF__B);\r\nif (common_attr->tuner_rf_agc_pol)\r\ndata |= SCU_RAM_AGC_KI_INV_RF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_KI_INV_RF_POL__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_RED_RAGC_RED__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, (~(agc_settings->speed << SCU_RAM_AGC_KI_RED_RAGC_RED__B) & SCU_RAM_AGC_KI_RED_RAGC_RED__M) | data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (agc_settings->standard == DRX_STANDARD_8VSB)\r\np_agc_settings = &(ext_attr->vsb_if_agc_cfg);\r\nelse if (DRXJ_ISQAMSTD(agc_settings->standard))\r\np_agc_settings = &(ext_attr->qam_if_agc_cfg);\r\nelse if (DRXJ_ISATVSTD(agc_settings->standard))\r\np_agc_settings = &(ext_attr->atv_if_agc_cfg);\r\nelse\r\nreturn -EINVAL;\r\nif (p_agc_settings->ctrl_mode == DRX_AGC_CTRL_AUTO) {\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, agc_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, agc_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_RF_IACCU_HI_CO__A, agc_settings->cut_off_current, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_AGC_CTRL_USER:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_RF__M;\r\nif (common_attr->tuner_rf_agc_pol)\r\ndata |= SCU_RAM_AGC_KI_INV_RF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_KI_INV_RF_POL__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_RF_IACCU_HI__A, agc_settings->output_level, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_AGC_CTRL_OFF:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= (~IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE);\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_RF__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nswitch (agc_settings->standard) {\r\ncase DRX_STANDARD_8VSB:\r\next_attr->vsb_rf_agc_cfg = *agc_settings;\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\next_attr->qam_rf_agc_cfg = *agc_settings;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_agc_if(struct drx_demod_instance *demod, struct drxj_cfg_agc *agc_settings, bool atomic)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct drxj_cfg_agc *p_agc_settings = NULL;\r\nstruct drx_common_attr *common_attr = NULL;\r\ndrx_write_reg16func_t scu_wr16 = NULL;\r\ndrx_read_reg16func_t scu_rr16 = NULL;\r\nint rc;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nif (atomic) {\r\nscu_rr16 = drxj_dap_scu_atomic_read_reg16;\r\nscu_wr16 = drxj_dap_scu_atomic_write_reg16;\r\n} else {\r\nscu_rr16 = drxj_dap_read_reg16;\r\nscu_wr16 = drxj_dap_write_reg16;\r\n}\r\nif ((ext_attr->standard == agc_settings->standard) ||\r\n(DRXJ_ISQAMSTD(ext_attr->standard) &&\r\nDRXJ_ISQAMSTD(agc_settings->standard)) ||\r\n(DRXJ_ISATVSTD(ext_attr->standard) &&\r\nDRXJ_ISATVSTD(agc_settings->standard))) {\r\nu16 data = 0;\r\nswitch (agc_settings->ctrl_mode) {\r\ncase DRX_AGC_CTRL_AUTO:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\r\ndata &= ~SCU_RAM_AGC_KI_IF__M;\r\nif (ext_attr->standard == DRX_STANDARD_8VSB)\r\ndata |= (3 << SCU_RAM_AGC_KI_IF__B);\r\nelse if (DRXJ_ISQAMSTD(ext_attr->standard))\r\ndata |= (6 << SCU_RAM_AGC_KI_IF__B);\r\nelse\r\ndata |= (5 << SCU_RAM_AGC_KI_IF__B);\r\nif (common_attr->tuner_if_agc_pol)\r\ndata |= SCU_RAM_AGC_KI_INV_IF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_KI_INV_IF_POL__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_RED_IAGC_RED__M;\r\nrc = (*scu_wr16) (dev_addr, SCU_RAM_AGC_KI_RED__A, (~(agc_settings->speed << SCU_RAM_AGC_KI_RED_IAGC_RED__B) & SCU_RAM_AGC_KI_RED_IAGC_RED__M) | data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (agc_settings->standard == DRX_STANDARD_8VSB)\r\np_agc_settings = &(ext_attr->vsb_rf_agc_cfg);\r\nelse if (DRXJ_ISQAMSTD(agc_settings->standard))\r\np_agc_settings = &(ext_attr->qam_rf_agc_cfg);\r\nelse if (DRXJ_ISATVSTD(agc_settings->standard))\r\np_agc_settings = &(ext_attr->atv_rf_agc_cfg);\r\nelse\r\nreturn -EINVAL;\r\nif (p_agc_settings->ctrl_mode == DRX_AGC_CTRL_AUTO) {\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, p_agc_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, p_agc_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nbreak;\r\ncase DRX_AGC_CTRL_USER:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE;\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\r\ndata |= SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\r\nif (common_attr->tuner_if_agc_pol)\r\ndata |= SCU_RAM_AGC_KI_INV_IF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_KI_INV_IF_POL__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, agc_settings->output_level, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_AGC_CTRL_OFF:\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= (~IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE);\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\r\ndata |= SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\r\nrc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = (*scu_wr16) (dev_addr, SCU_RAM_AGC_INGAIN_TGT_MIN__A, agc_settings->top, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nswitch (agc_settings->standard) {\r\ncase DRX_STANDARD_8VSB:\r\next_attr->vsb_if_agc_cfg = *agc_settings;\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\next_attr->qam_if_agc_cfg = *agc_settings;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_iqm_af(struct drx_demod_instance *demod, bool active)\r\n{\r\nu16 data = 0;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nint rc;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!active)\r\ndata &= ((~IQM_AF_STDBY_STDBY_ADC_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_AMP_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_PD_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE));\r\nelse\r\ndata |= (IQM_AF_STDBY_STDBY_ADC_A2_ACTIVE | IQM_AF_STDBY_STDBY_AMP_A2_ACTIVE | IQM_AF_STDBY_STDBY_PD_A2_ACTIVE | IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE | IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE);\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int power_down_vsb(struct drx_demod_instance *demod, bool primary)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxjscu_cmd cmd_scu = { 0,\r\n0,\r\n0,\r\nNULL,\r\nNULL\r\n};\r\nstruct drx_cfg_mpeg_output cfg_mpeg_output;\r\nint rc;\r\nu16 cmd_result = 0;\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB |\r\nSCU_RAM_COMMAND_CMD_DEMOD_STOP;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (primary) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_iqm_af(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\ncfg_mpeg_output.enable_mpeg_output = false;\r\nrc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_vsb_leak_n_gain(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nint rc;\r\nconst u8 vsb_ffe_leak_gain_ram0[] = {\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0xf),\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0x8),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x20),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x10),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x0e),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x07),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x0c),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x06),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x4040),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010)\r\n};\r\nconst u8 vsb_ffe_leak_gain_ram1[] = {\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0808),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0606),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0505),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x0303),\r\nDRXJ_16TO8(0x001f),\r\nDRXJ_16TO8(0x01ff),\r\nDRXJ_16TO8(0x01ff),\r\nDRXJ_16TO8(0x004f),\r\nDRXJ_16TO8(0x004f),\r\nDRXJ_16TO8(0x01ff),\r\nDRXJ_16TO8(0x01ff),\r\nDRXJ_16TO8(0x0352),\r\nDRXJ_16TO8(0x0352),\r\nDRXJ_16TO8(0x0000),\r\nDRXJ_16TO8(0x2020),\r\nDRXJ_16TO8(0x1010),\r\nDRXJ_16TO8(0x1818),\r\nDRXJ_16TO8(0x1212)\r\n};\r\ndev_addr = demod->my_i2c_dev_addr;\r\nrc = drxdap_fasi_write_block(dev_addr, VSB_SYSCTRL_RAM0_FFETRAINLKRATIO1__A, sizeof(vsb_ffe_leak_gain_ram0), ((u8 *)vsb_ffe_leak_gain_ram0), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, VSB_SYSCTRL_RAM1_FIRRCA1GAIN9__A, sizeof(vsb_ffe_leak_gain_ram1), ((u8 *)vsb_ffe_leak_gain_ram1), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_vsb(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nint rc;\r\nstruct drx_common_attr *common_attr = NULL;\r\nstruct drxjscu_cmd cmd_scu;\r\nstruct drxj_data *ext_attr = NULL;\r\nu16 cmd_result = 0;\r\nu16 cmd_param = 0;\r\nconst u8 vsb_taps_re[] = {\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(-3),\r\nDRXJ_16TO8(-3),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-9),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(12),\r\nDRXJ_16TO8(-9),\r\nDRXJ_16TO8(-15),\r\nDRXJ_16TO8(17),\r\nDRXJ_16TO8(19),\r\nDRXJ_16TO8(-29),\r\nDRXJ_16TO8(-22),\r\nDRXJ_16TO8(45),\r\nDRXJ_16TO8(25),\r\nDRXJ_16TO8(-70),\r\nDRXJ_16TO8(-28),\r\nDRXJ_16TO8(111),\r\nDRXJ_16TO8(30),\r\nDRXJ_16TO8(-201),\r\nDRXJ_16TO8(-31),\r\nDRXJ_16TO8(629)\r\n};\r\ndev_addr = demod->my_i2c_dev_addr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_RESET;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_DCF_BYPASS__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_ADJ_SEL__A, IQM_FS_ADJ_SEL_B_VSB, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_ADJ_SEL__A, IQM_RC_ADJ_SEL_B_VSB, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->iqm_rc_rate_ofs = 0x00AD0D79;\r\nrc = drxdap_fasi_write_reg32(dev_addr, IQM_RC_RATE_OFS_LO__A, ext_attr->iqm_rc_rate_ofs, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CFAGC_GAINSHIFT__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1TRK__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_CROUT_ENA__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_STRETCH__A, 28, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_ACTIVE__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SYMMETRIC__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_MIDTAP__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_OUT_ENA__A, IQM_CF_OUT_ENA_VSB__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE__A, 1393, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(vsb_taps_re), ((u8 *)vsb_taps_re), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(vsb_taps_re), ((u8 *)vsb_taps_re), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BNTHRESH__A, 330, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CLPLASTNUM__A, 90, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_RCA1__A, 0x0042, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_RCA2__A, 0x0053, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_EQCTRL__A, 0x1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_GPIO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_TOP_ANNEX__A, FEC_TOP_ANNEX_D, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nu16 fec_oc_snc_mode = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_MODE__A, fec_oc_snc_mode | FEC_OC_SNC_MODE_UNLOCK_ENABLE__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_LEN__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_TH__A, 470, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_SNS_LEN__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_PT__A, 0xD4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nu16 fec_oc_reg_mode = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_MODE__A, &fec_oc_reg_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_MODE__A, fec_oc_reg_mode & (~(FEC_OC_MODE_TRANSPARENT__M | FEC_OC_MODE_CLEAR__M | FEC_OC_MODE_RETAIN_FRAMING__M)), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_DI_TIMEOUT_LO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_DI_TIMEOUT_HI__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_RS_MODE__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PERIOD__A, FEC_RS_MEASUREMENT_PERIOD, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PRESCALE__A, FEC_RS_MEASUREMENT_PRESCALE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_MEASUREMENT_PERIOD__A, VSB_TOP_MEASUREMENT_PERIOD, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_reg32(dev_addr, SCU_RAM_FEC_ACCUM_CW_CORRECTED_LO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_MEAS_COUNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CKGN1TRK__A, 128, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!ext_attr->has_lna) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_AMUX__A, 0x02, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = set_iqm_af(demod, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = adc_synchronization(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = init_agc(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_agc_if(demod, &(ext_attr->vsb_if_agc_cfg), false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_agc_rf(demod, &(ext_attr->vsb_rf_agc_cfg), false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nstruct drxj_cfg_afe_gain vsb_pga_cfg = { DRX_STANDARD_8VSB, 0 };\r\nvsb_pga_cfg.gain = ext_attr->vsb_pga_cfg;\r\nrc = ctrl_set_cfg_afe_gain(demod, &vsb_pga_cfg);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = ctrl_set_cfg_pre_saw(demod, &(ext_attr->vsb_pre_saw_cfg));\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_mpegtei_handling(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = bit_reverse_mpeg_output(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_mpeg_start_width(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nstruct drx_cfg_mpeg_output cfg_mpeg_output;\r\nmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\r\ncfg_mpeg_output.enable_mpeg_output = true;\r\nrc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\ncmd_param = 0x00;\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM;\r\ncmd_scu.parameter_len = 1;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = &cmd_param;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BEAGC_GAINSHIFT__A, 0x0004, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_PT__A, 0x00D2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SYSSMTRNCTRL__A, VSB_TOP_SYSSMTRNCTRL__PRE | VSB_TOP_SYSSMTRNCTRL_NCOTIMEOUTCNTEN__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BEDETCTRL__A, 0x142, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_LBAGCREFLVL__A, 640, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1ACQ__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1TRK__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN2TRK__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_START;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_vsb_post_rs_pck_err(struct i2c_device_addr *dev_addr,\r\nu32 *pck_errs, u32 *pck_count)\r\n{\r\nint rc;\r\nu16 data = 0;\r\nu16 period = 0;\r\nu16 prescale = 0;\r\nu16 packet_errors_mant = 0;\r\nu16 packet_errors_exp = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_FAILURES__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\npacket_errors_mant = data & FEC_RS_NR_FAILURES_FIXED_MANT__M;\r\npacket_errors_exp = (data & FEC_RS_NR_FAILURES_EXP__M)\r\n>> FEC_RS_NR_FAILURES_EXP__B;\r\nperiod = FEC_RS_MEASUREMENT_PERIOD;\r\nprescale = FEC_RS_MEASUREMENT_PRESCALE;\r\nif (period * prescale == 0) {\r\npr_err("error: period and/or prescale is zero!\n");\r\nreturn -EIO;\r\n}\r\n*pck_errs = packet_errors_mant * (1 << packet_errors_exp);\r\n*pck_count = period * prescale * 77;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_vs_bpost_viterbi_ber(struct i2c_device_addr *dev_addr,\r\nu32 *ber, u32 *cnt)\r\n{\r\nint rc;\r\nu16 data = 0;\r\nu16 period = 0;\r\nu16 prescale = 0;\r\nu16 bit_errors_mant = 0;\r\nu16 bit_errors_exp = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_BIT_ERRORS__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nperiod = FEC_RS_MEASUREMENT_PERIOD;\r\nprescale = FEC_RS_MEASUREMENT_PRESCALE;\r\nbit_errors_mant = data & FEC_RS_NR_BIT_ERRORS_FIXED_MANT__M;\r\nbit_errors_exp = (data & FEC_RS_NR_BIT_ERRORS_EXP__M)\r\n>> FEC_RS_NR_BIT_ERRORS_EXP__B;\r\n*cnt = period * prescale * 207 * ((bit_errors_exp > 2) ? 1 : 8);\r\nif (((bit_errors_mant << bit_errors_exp) >> 3) > 68700)\r\n*ber = (*cnt) * 26570;\r\nelse {\r\nif (period * prescale == 0) {\r\npr_err("error: period and/or prescale is zero!\n");\r\nreturn -EIO;\r\n}\r\n*ber = bit_errors_mant << ((bit_errors_exp > 2) ?\r\n(bit_errors_exp - 3) : bit_errors_exp);\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_vs_bpre_viterbi_ber(struct i2c_device_addr *dev_addr,\r\nu32 *ber, u32 *cnt)\r\n{\r\nu16 data = 0;\r\nint rc;\r\nrc = drxj_dap_read_reg16(dev_addr, VSB_TOP_NR_SYM_ERRS__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\nreturn -EIO;\r\n}\r\n*ber = data;\r\n*cnt = VSB_TOP_MEASUREMENT_PERIOD * SYMBOLS_PER_SEGMENT;\r\nreturn 0;\r\n}\r\nstatic int get_vsbmer(struct i2c_device_addr *dev_addr, u16 *mer)\r\n{\r\nint rc;\r\nu16 data_hi = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, VSB_TOP_ERR_ENERGY_H__A, &data_hi, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n*mer =\r\n(u16) (log1_times100(21504) - log1_times100((data_hi << 6) / 52));\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int power_down_qam(struct drx_demod_instance *demod, bool primary)\r\n{\r\nstruct drxjscu_cmd cmd_scu = { 0,\r\n0,\r\n0,\r\nNULL,\r\nNULL\r\n};\r\nint rc;\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drx_cfg_mpeg_output cfg_mpeg_output;\r\nstruct drx_common_attr *common_attr = demod->my_common_attr;\r\nu16 cmd_result = 0;\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_STOP;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (primary) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_iqm_af(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\r\ncfg_mpeg_output.enable_mpeg_output = false;\r\nrc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_qam_measurement(struct drx_demod_instance *demod,\r\nenum drx_modulation constellation, u32 symbol_rate)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\nu32 fec_bits_desired = 0;\r\nu16 fec_rs_plen = 0;\r\nu16 fec_rs_prescale = 0;\r\nu32 fec_rs_period = 0;\r\nu32 fec_rs_bit_cnt = 0;\r\nu32 fec_oc_snc_fail_period = 0;\r\nu32 qam_vd_period = 0;\r\nu32 qam_vd_bit_cnt = 0;\r\nu16 fec_vd_plen = 0;\r\nu16 qam_vd_prescale = 0;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nfec_bits_desired = ext_attr->fec_bits_desired;\r\nfec_rs_prescale = ext_attr->fec_rs_prescale;\r\nswitch (constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\nfec_bits_desired = 4 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\nfec_bits_desired = 5 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nfec_bits_desired = 6 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM128:\r\nfec_bits_desired = 7 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nfec_bits_desired = 8 * symbol_rate;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\nfec_rs_plen = 204 * 8;\r\nbreak;\r\ncase DRX_STANDARD_ITU_B:\r\nfec_rs_plen = 128 * 7;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\next_attr->fec_rs_plen = fec_rs_plen;\r\nfec_rs_bit_cnt = fec_rs_prescale * fec_rs_plen;\r\nif (fec_rs_bit_cnt == 0) {\r\npr_err("error: fec_rs_bit_cnt is zero!\n");\r\nreturn -EIO;\r\n}\r\nfec_rs_period = fec_bits_desired / fec_rs_bit_cnt + 1;\r\nif (ext_attr->standard != DRX_STANDARD_ITU_B)\r\nfec_oc_snc_fail_period = fec_rs_period;\r\nif (fec_rs_period > 0xFFFF)\r\nfec_rs_period = 0xFFFF;\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_C:\r\nbreak;\r\ncase DRX_STANDARD_ITU_B:\r\nswitch (constellation) {\r\ncase DRX_CONSTELLATION_QAM64:\r\nfec_rs_period = 31581;\r\nfec_oc_snc_fail_period = 17932;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nfec_rs_period = 45446;\r\nfec_oc_snc_fail_period = 25805;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_FAIL_PERIOD__A, (u16)fec_oc_snc_fail_period, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PERIOD__A, (u16)fec_rs_period, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PRESCALE__A, fec_rs_prescale, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->fec_rs_period = (u16) fec_rs_period;\r\next_attr->fec_rs_prescale = fec_rs_prescale;\r\nrc = drxdap_fasi_write_reg32(dev_addr, SCU_RAM_FEC_ACCUM_CW_CORRECTED_LO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_MEAS_COUNT__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nfec_vd_plen = ext_attr->fec_vd_plen;\r\nqam_vd_prescale = ext_attr->qam_vd_prescale;\r\nqam_vd_bit_cnt = qam_vd_prescale * fec_vd_plen;\r\nswitch (constellation) {\r\ncase DRX_CONSTELLATION_QAM64:\r\nqam_vd_period =\r\nqam_vd_bit_cnt * (QAM_TOP_CONSTELLATION_QAM64 + 1)\r\n* (QAM_TOP_CONSTELLATION_QAM64 + 1);\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nqam_vd_period =\r\nqam_vd_bit_cnt * (QAM_TOP_CONSTELLATION_QAM256 + 1)\r\n* (QAM_TOP_CONSTELLATION_QAM256 + 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (qam_vd_period == 0) {\r\npr_err("error: qam_vd_period is zero!\n");\r\nreturn -EIO;\r\n}\r\nqam_vd_period = fec_bits_desired / qam_vd_period;\r\nif (qam_vd_period > 0xFFFF)\r\nqam_vd_period = 0xFFFF;\r\nqam_vd_bit_cnt *= qam_vd_period;\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_VD_MEASUREMENT_PERIOD__A, (u16)qam_vd_period, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_VD_MEASUREMENT_PRESCALE__A, qam_vd_prescale, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->qam_vd_period = (u16) qam_vd_period;\r\next_attr->qam_vd_prescale = qam_vd_prescale;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_qam16(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nconst u8 qam_dq_qual_fun[] = {\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(3),\r\n};\r\nconst u8 qam_eq_cma_rad[] = {\r\nDRXJ_16TO8(13517),\r\nDRXJ_16TO8(13517),\r\nDRXJ_16TO8(13517),\r\nDRXJ_16TO8(13517),\r\nDRXJ_16TO8(13517),\r\nDRXJ_16TO8(13517),\r\n};\r\nrc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 140, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 120, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 230, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 95, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 105, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 56, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 220, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 25, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 6, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-24), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-65), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-127), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 240, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 40960, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_qam32(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nconst u8 qam_dq_qual_fun[] = {\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(4),\r\n};\r\nconst u8 qam_eq_cma_rad[] = {\r\nDRXJ_16TO8(6707),\r\nDRXJ_16TO8(6707),\r\nDRXJ_16TO8(6707),\r\nDRXJ_16TO8(6707),\r\nDRXJ_16TO8(6707),\r\nDRXJ_16TO8(6707),\r\n};\r\nrc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 90, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 170, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 56, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 140, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16)(-16), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-26), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-56), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-86), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 176, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 20480, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_qam64(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nconst u8 qam_dq_qual_fun[] = {\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(6),\r\n};\r\nconst u8 qam_eq_cma_rad[] = {\r\nDRXJ_16TO8(13336),\r\nDRXJ_16TO8(12618),\r\nDRXJ_16TO8(11988),\r\nDRXJ_16TO8(13809),\r\nDRXJ_16TO8(13809),\r\nDRXJ_16TO8(15609),\r\n};\r\nrc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 105, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 195, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 84, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 141, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 7, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-15), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-45), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-80), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 30, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 48, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 160, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 43008, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_qam128(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nconst u8 qam_dq_qual_fun[] = {\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(9),\r\nDRXJ_16TO8(9),\r\n};\r\nconst u8 qam_eq_cma_rad[] = {\r\nDRXJ_16TO8(6164),\r\nDRXJ_16TO8(6598),\r\nDRXJ_16TO8(6394),\r\nDRXJ_16TO8(6409),\r\nDRXJ_16TO8(6656),\r\nDRXJ_16TO8(7238),\r\n};\r\nrc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 140, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 65, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-1), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-23), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 20, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 144, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 20992, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_qam256(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nconst u8 qam_dq_qual_fun[] = {\r\nDRXJ_16TO8(8),\r\nDRXJ_16TO8(8),\r\nDRXJ_16TO8(8),\r\nDRXJ_16TO8(8),\r\nDRXJ_16TO8(12),\r\nDRXJ_16TO8(12),\r\n};\r\nconst u8 qam_eq_cma_rad[] = {\r\nDRXJ_16TO8(12345),\r\nDRXJ_16TO8(12345),\r\nDRXJ_16TO8(13626),\r\nDRXJ_16TO8(12931),\r\nDRXJ_16TO8(14719),\r\nDRXJ_16TO8(15356),\r\n};\r\nrc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 150, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 110, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 74, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 18, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 13, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, 7, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 50, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 25, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 48, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 80, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 16, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 43520, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_qam(struct drx_demod_instance *demod,\r\nstruct drx_channel *channel, s32 tuner_freq_offset, u32 op)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct drx_common_attr *common_attr = NULL;\r\nint rc;\r\nu32 adc_frequency = 0;\r\nu32 iqm_rc_rate = 0;\r\nu16 cmd_result = 0;\r\nu16 lc_symbol_freq = 0;\r\nu16 iqm_rc_stretch = 0;\r\nu16 set_env_parameters = 0;\r\nu16 set_param_parameters[2] = { 0 };\r\nstruct drxjscu_cmd cmd_scu = { 0,\r\n0,\r\n0,\r\nNULL,\r\nNULL\r\n};\r\nconst u8 qam_a_taps[] = {\r\nDRXJ_16TO8(-1),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-1),\r\nDRXJ_16TO8(-1),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(-1),\r\nDRXJ_16TO8(-3),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-8),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(13),\r\nDRXJ_16TO8(-13),\r\nDRXJ_16TO8(-19),\r\nDRXJ_16TO8(28),\r\nDRXJ_16TO8(25),\r\nDRXJ_16TO8(-53),\r\nDRXJ_16TO8(-31),\r\nDRXJ_16TO8(96),\r\nDRXJ_16TO8(37),\r\nDRXJ_16TO8(-190),\r\nDRXJ_16TO8(-40),\r\nDRXJ_16TO8(619)\r\n};\r\nconst u8 qam_b64_taps[] = {\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(-6),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(6),\r\nDRXJ_16TO8(-5),\r\nDRXJ_16TO8(-3),\r\nDRXJ_16TO8(11),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(-19),\r\nDRXJ_16TO8(19),\r\nDRXJ_16TO8(28),\r\nDRXJ_16TO8(-45),\r\nDRXJ_16TO8(-36),\r\nDRXJ_16TO8(90),\r\nDRXJ_16TO8(42),\r\nDRXJ_16TO8(-185),\r\nDRXJ_16TO8(-46),\r\nDRXJ_16TO8(614)\r\n};\r\nconst u8 qam_b256_taps[] = {\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(1),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(-2),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(5),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(-8),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(11),\r\nDRXJ_16TO8(-8),\r\nDRXJ_16TO8(-15),\r\nDRXJ_16TO8(16),\r\nDRXJ_16TO8(19),\r\nDRXJ_16TO8(-27),\r\nDRXJ_16TO8(-22),\r\nDRXJ_16TO8(44),\r\nDRXJ_16TO8(26),\r\nDRXJ_16TO8(-69),\r\nDRXJ_16TO8(-28),\r\nDRXJ_16TO8(110),\r\nDRXJ_16TO8(31),\r\nDRXJ_16TO8(-201),\r\nDRXJ_16TO8(-32),\r\nDRXJ_16TO8(628)\r\n};\r\nconst u8 qam_c_taps[] = {\r\nDRXJ_16TO8(-3),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(2),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(4),\r\nDRXJ_16TO8(-1),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(3),\r\nDRXJ_16TO8(-5),\r\nDRXJ_16TO8(0),\r\nDRXJ_16TO8(9),\r\nDRXJ_16TO8(-4),\r\nDRXJ_16TO8(-12),\r\nDRXJ_16TO8(10),\r\nDRXJ_16TO8(16),\r\nDRXJ_16TO8(-21),\r\nDRXJ_16TO8(-20),\r\nDRXJ_16TO8(37),\r\nDRXJ_16TO8(25),\r\nDRXJ_16TO8(-62),\r\nDRXJ_16TO8(-28),\r\nDRXJ_16TO8(105),\r\nDRXJ_16TO8(31),\r\nDRXJ_16TO8(-197),\r\nDRXJ_16TO8(-33),\r\nDRXJ_16TO8(626)\r\n};\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\r\nif (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM256:\r\niqm_rc_rate = 0x00AE3562;\r\nlc_symbol_freq =\r\nQAM_LC_SYMBOL_FREQ_FREQ_QAM_B_256;\r\nchannel->symbolrate = 5360537;\r\niqm_rc_stretch = IQM_RC_STRETCH_QAM_B_256;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\niqm_rc_rate = 0x00C05A0E;\r\nlc_symbol_freq = 409;\r\nchannel->symbolrate = 5056941;\r\niqm_rc_stretch = IQM_RC_STRETCH_QAM_B_64;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nadc_frequency = (common_attr->sys_clock_freq * 1000) / 3;\r\nif (channel->symbolrate == 0) {\r\npr_err("error: channel symbolrate is zero!\n");\r\nreturn -EIO;\r\n}\r\niqm_rc_rate =\r\n(adc_frequency / channel->symbolrate) * (1 << 21) +\r\n(frac28\r\n((adc_frequency % channel->symbolrate),\r\nchannel->symbolrate) >> 7) - (1 << 23);\r\nlc_symbol_freq =\r\n(u16) (frac28\r\n(channel->symbolrate +\r\n(adc_frequency >> 13),\r\nadc_frequency) >> 16);\r\nif (lc_symbol_freq > 511)\r\nlc_symbol_freq = 511;\r\niqm_rc_stretch = 21;\r\n}\r\nif (ext_attr->standard == DRX_STANDARD_ITU_A) {\r\nset_env_parameters = QAM_TOP_ANNEX_A;\r\nset_param_parameters[0] = channel->constellation;\r\nset_param_parameters[1] = DRX_INTERLEAVEMODE_I12_J17;\r\n} else if (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nset_env_parameters = QAM_TOP_ANNEX_B;\r\nset_param_parameters[0] = channel->constellation;\r\nset_param_parameters[1] = channel->interleavemode;\r\n} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\r\nset_env_parameters = QAM_TOP_ANNEX_C;\r\nset_param_parameters[0] = channel->constellation;\r\nset_param_parameters[1] = DRX_INTERLEAVEMODE_I12_J17;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (op & QAM_SET_OP_ALL) {\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_RESET;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_SET_ENV;\r\ncmd_scu.parameter_len = 1;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = &set_env_parameters;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM;\r\ncmd_scu.parameter_len = 2;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = set_param_parameters;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_reg32(dev_addr, IQM_RC_RATE_OFS_LO__A, iqm_rc_rate, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->iqm_rc_rate_ofs = iqm_rc_rate;\r\nrc = set_qam_measurement(demod, channel->constellation, channel->symbolrate);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_SPECTRUM)) {\r\nrc = set_frequency(demod, channel, tuner_freq_offset);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_SYMBOL_FREQ__A, lc_symbol_freq, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_STRETCH__A, iqm_rc_stretch, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif (op & QAM_SET_OP_ALL) {\r\nif (!ext_attr->has_lna) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_AMUX__A, 0x02, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SYMMETRIC__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_MIDTAP__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_OUT_ENA__A, IQM_CF_OUT_ENA_QAM__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_WR_RSV_0__A, 0x5f, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_SYNC_SEL__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_LEN__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_TH__A, 448, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_SNS_LEN__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_PDREF__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, 0x10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_PGA_GAIN__A, 11, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, IQM_CF_SCALE_SH__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_TIMEOUT__A, QAM_SY_TIMEOUT__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, QAM_SY_SYNC_LWM__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, QAM_SY_SYNC_AWM__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, QAM_SY_SYNC_HWM__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\ncase DRX_CONSTELLATION_QAM64:\r\ncase DRX_CONSTELLATION_QAM256:\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, 0x03, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, 0x04, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, QAM_SY_SYNC_HWM__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\ncase DRX_CONSTELLATION_QAM128:\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, 0x03, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, 0x05, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, 0x06, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_MODE__A, QAM_LC_MODE__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_RATE_LIMIT__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_LPF_FACTORP__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_LPF_FACTORI__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_MODE__A, 7, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB0__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB1__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB2__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB3__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB4__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB5__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB6__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB8__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB9__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB10__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB12__A, 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB15__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB16__A, 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB20__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB25__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_ADJ_SEL__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_ADJ_SEL__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_ADJ_SEL__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_GPIO__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_iqm_af(demod, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = adc_synchronization(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = init_agc(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_agc_if(demod, &(ext_attr->qam_if_agc_cfg), false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_agc_rf(demod, &(ext_attr->qam_rf_agc_cfg), false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nstruct drxj_cfg_afe_gain qam_pga_cfg = { DRX_STANDARD_ITU_B, 0 };\r\nqam_pga_cfg.gain = ext_attr->qam_pga_cfg;\r\nrc = ctrl_set_cfg_afe_gain(demod, &qam_pga_cfg);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = ctrl_set_cfg_pre_saw(demod, &(ext_attr->qam_pre_saw_cfg));\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\r\nif (ext_attr->standard == DRX_STANDARD_ITU_A) {\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_a_taps), ((u8 *)qam_a_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_a_taps), ((u8 *)qam_a_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else if (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM64:\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_b64_taps), ((u8 *)qam_b64_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_b64_taps), ((u8 *)qam_b64_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_b256_taps), ((u8 *)qam_b256_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_b256_taps), ((u8 *)qam_b256_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_c_taps), ((u8 *)qam_c_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_c_taps), ((u8 *)qam_c_taps), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\nrc = set_qam16(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\nrc = set_qam32(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nrc = set_qam64(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM128:\r\nrc = set_qam128(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nrc = set_qam256(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL)) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_mpegtei_handling(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = bit_reverse_mpeg_output(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_mpeg_start_width(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n{\r\nstruct drx_cfg_mpeg_output cfg_mpeg_output;\r\nmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\r\ncfg_mpeg_output.enable_mpeg_output = true;\r\nrc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\n}\r\nif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_START;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int qam_flip_spec(struct drx_demod_instance *demod, struct drx_channel *channel)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nint rc;\r\nu32 iqm_fs_rate_ofs = 0;\r\nu32 iqm_fs_rate_lo = 0;\r\nu16 qam_ctl_ena = 0;\r\nu16 data = 0;\r\nu16 equ_mode = 0;\r\nu16 fsm_state = 0;\r\nint i = 0;\r\nint ofsofs = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, &qam_ctl_ena, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, qam_ctl_ena & ~(SCU_RAM_QAM_CTL_ENA_ACQ__M | SCU_RAM_QAM_CTL_ENA_EQU__M | SCU_RAM_QAM_CTL_ENA_LC__M), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_CF__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_CF1__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_atomic_read_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, &iqm_fs_rate_ofs, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_atomic_read_reg32(dev_addr, IQM_FS_RATE_LO__A, &iqm_fs_rate_lo, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nofsofs = iqm_fs_rate_lo - iqm_fs_rate_ofs;\r\niqm_fs_rate_ofs = ~iqm_fs_rate_ofs + 1;\r\niqm_fs_rate_ofs -= 2 * ofsofs;\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_DQ_MODE__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndata = (data & 0xfff9);\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_CI__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_LC_EP__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_FQ_LA_FACTOR__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, iqm_fs_rate_ofs, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->iqm_fs_rate_ofs = iqm_fs_rate_ofs;\r\next_attr->pos_image = (ext_attr->pos_image) ? false : true;\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_DQ_MODE__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nequ_mode = data;\r\ndata = (data & 0xfff9);\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfor (i = 0; i < 28; i++) {\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_DQ_TAP_IM_EL0__A + (2 * i), &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_DQ_TAP_IM_EL0__A + (2 * i), -data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nfor (i = 0; i < 24; i++) {\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_FQ_TAP_IM_EL0__A + (2 * i), &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_FQ_TAP_IM_EL0__A + (2 * i), -data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\ndata = equ_mode;\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_STATE_TGT__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ni = 0;\r\nwhile ((fsm_state != 4) && (i++ < 100)) {\r\nrc = drxj_dap_read_reg16(dev_addr, SCU_RAM_QAM_FSM_STATE__A, &fsm_state, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, (qam_ctl_ena | 0x0016), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nqam64auto(struct drx_demod_instance *demod,\r\nstruct drx_channel *channel,\r\ns32 tuner_freq_offset, enum drx_lock_status *lock_status)\r\n{\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drx39xxj_state *state = dev_addr->user_data;\r\nstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\r\nint rc;\r\nu32 lck_state = NO_LOCK;\r\nu32 start_time = 0;\r\nu32 d_locked_time = 0;\r\nu32 timeout_ofs = 0;\r\nu16 data = 0;\r\n*lock_status = DRX_NOT_LOCKED;\r\nstart_time = jiffies_to_msecs(jiffies);\r\nlck_state = NO_LOCK;\r\ndo {\r\nrc = ctrl_lock_status(demod, lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch (lck_state) {\r\ncase NO_LOCK:\r\nif (*lock_status == DRXJ_DEMOD_LOCK) {\r\nrc = ctrl_get_qam_sig_quality(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (p->cnr.stat[0].svalue > 20800) {\r\nlck_state = DEMOD_LOCKED;\r\ntimeout_ofs += DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\r\nd_locked_time = jiffies_to_msecs(jiffies);\r\n}\r\n}\r\nbreak;\r\ncase DEMOD_LOCKED:\r\nif ((*lock_status == DRXJ_DEMOD_LOCK) &&\r\n((jiffies_to_msecs(jiffies) - d_locked_time) >\r\nDRXJ_QAM_FEC_LOCK_WAITTIME)) {\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data | 0x1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nlck_state = SYNC_FLIPPED;\r\nmsleep(10);\r\n}\r\nbreak;\r\ncase SYNC_FLIPPED:\r\nif (*lock_status == DRXJ_DEMOD_LOCK) {\r\nif (channel->mirror == DRX_MIRROR_AUTO) {\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data & 0xFFFE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->mirror = DRX_MIRROR_YES;\r\nrc = qam_flip_spec(demod, channel);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nlck_state = SPEC_MIRRORED;\r\nstart_time = d_locked_time =\r\njiffies_to_msecs(jiffies);\r\ntimeout_ofs = 0;\r\n} else {\r\nstart_time =\r\njiffies_to_msecs(jiffies) -\r\nDRXJ_QAM_MAX_WAITTIME - timeout_ofs;\r\n}\r\n}\r\nbreak;\r\ncase SPEC_MIRRORED:\r\nif ((*lock_status == DRXJ_DEMOD_LOCK) &&\r\n((jiffies_to_msecs(jiffies) - d_locked_time) >\r\nDRXJ_QAM_FEC_LOCK_WAITTIME)) {\r\nrc = ctrl_get_qam_sig_quality(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (p->cnr.stat[0].svalue > 20800) {\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data | 0x1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nstart_time =\r\njiffies_to_msecs(jiffies) -\r\nDRXJ_QAM_MAX_WAITTIME - timeout_ofs;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nmsleep(10);\r\n} while\r\n((*lock_status != DRX_LOCKED) &&\r\n(*lock_status != DRX_NEVER_LOCK) &&\r\n((jiffies_to_msecs(jiffies) - start_time) <\r\n(DRXJ_QAM_MAX_WAITTIME + timeout_ofs))\r\n);\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nqam256auto(struct drx_demod_instance *demod,\r\nstruct drx_channel *channel,\r\ns32 tuner_freq_offset, enum drx_lock_status *lock_status)\r\n{\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drx39xxj_state *state = dev_addr->user_data;\r\nstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\r\nint rc;\r\nu32 lck_state = NO_LOCK;\r\nu32 start_time = 0;\r\nu32 d_locked_time = 0;\r\nu32 timeout_ofs = DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\r\n*lock_status = DRX_NOT_LOCKED;\r\nstart_time = jiffies_to_msecs(jiffies);\r\nlck_state = NO_LOCK;\r\ndo {\r\nrc = ctrl_lock_status(demod, lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nswitch (lck_state) {\r\ncase NO_LOCK:\r\nif (*lock_status == DRXJ_DEMOD_LOCK) {\r\nrc = ctrl_get_qam_sig_quality(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (p->cnr.stat[0].svalue > 26800) {\r\nlck_state = DEMOD_LOCKED;\r\ntimeout_ofs += DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\r\nd_locked_time = jiffies_to_msecs(jiffies);\r\n}\r\n}\r\nbreak;\r\ncase DEMOD_LOCKED:\r\nif (*lock_status == DRXJ_DEMOD_LOCK) {\r\nif ((channel->mirror == DRX_MIRROR_AUTO) &&\r\n((jiffies_to_msecs(jiffies) - d_locked_time) >\r\nDRXJ_QAM_FEC_LOCK_WAITTIME)) {\r\next_attr->mirror = DRX_MIRROR_YES;\r\nrc = qam_flip_spec(demod, channel);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nlck_state = SPEC_MIRRORED;\r\nstart_time = jiffies_to_msecs(jiffies);\r\ntimeout_ofs = -DRXJ_QAM_MAX_WAITTIME / 2;\r\n}\r\n}\r\nbreak;\r\ncase SPEC_MIRRORED:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nmsleep(10);\r\n} while\r\n((*lock_status < DRX_LOCKED) &&\r\n(*lock_status != DRX_NEVER_LOCK) &&\r\n((jiffies_to_msecs(jiffies) - start_time) <\r\n(DRXJ_QAM_MAX_WAITTIME + timeout_ofs)));\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nset_qam_channel(struct drx_demod_instance *demod,\r\nstruct drx_channel *channel, s32 tuner_freq_offset)\r\n{\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\nenum drx_lock_status lock_status = DRX_NOT_LOCKED;\r\nbool auto_flag = false;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\ncase DRX_CONSTELLATION_QAM32:\r\ncase DRX_CONSTELLATION_QAM128:\r\nreturn -EINVAL;\r\ncase DRX_CONSTELLATION_QAM64:\r\ncase DRX_CONSTELLATION_QAM256:\r\nif (ext_attr->standard != DRX_STANDARD_ITU_B)\r\nreturn -EINVAL;\r\next_attr->constellation = channel->constellation;\r\nif (channel->mirror == DRX_MIRROR_AUTO)\r\next_attr->mirror = DRX_MIRROR_NO;\r\nelse\r\next_attr->mirror = channel->mirror;\r\nrc = set_qam(demod, channel, tuner_freq_offset, QAM_SET_OP_ALL);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (channel->constellation == DRX_CONSTELLATION_QAM64)\r\nrc = qam64auto(demod, channel, tuner_freq_offset,\r\n&lock_status);\r\nelse\r\nrc = qam256auto(demod, channel, tuner_freq_offset,\r\n&lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_CONSTELLATION_AUTO:\r\nif (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\nu16 qam_ctl_ena = 0;\r\nauto_flag = true;\r\nchannel->constellation = DRX_CONSTELLATION_QAM256;\r\next_attr->constellation = DRX_CONSTELLATION_QAM256;\r\nif (channel->mirror == DRX_MIRROR_AUTO)\r\next_attr->mirror = DRX_MIRROR_NO;\r\nelse\r\next_attr->mirror = channel->mirror;\r\nrc = set_qam(demod, channel, tuner_freq_offset,\r\nQAM_SET_OP_ALL);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = qam256auto(demod, channel, tuner_freq_offset,\r\n&lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (lock_status >= DRX_LOCKED) {\r\nchannel->constellation = DRX_CONSTELLATION_AUTO;\r\nbreak;\r\n}\r\nchannel->constellation = DRX_CONSTELLATION_QAM64;\r\next_attr->constellation = DRX_CONSTELLATION_QAM64;\r\nif (channel->mirror == DRX_MIRROR_AUTO)\r\next_attr->mirror = DRX_MIRROR_NO;\r\nelse\r\next_attr->mirror = channel->mirror;\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\n&qam_ctl_ena, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\nqam_ctl_ena & ~SCU_RAM_QAM_CTL_ENA_ACQ__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_FSM_STATE_TGT__A,\r\n0x2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_qam(demod, channel, tuner_freq_offset,\r\nQAM_SET_OP_CONSTELLATION);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\nqam_ctl_ena, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = qam64auto(demod, channel, tuner_freq_offset,\r\n&lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nchannel->constellation = DRX_CONSTELLATION_AUTO;\r\n} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\r\nu16 qam_ctl_ena = 0;\r\nchannel->constellation = DRX_CONSTELLATION_QAM64;\r\next_attr->constellation = DRX_CONSTELLATION_QAM64;\r\nauto_flag = true;\r\nif (channel->mirror == DRX_MIRROR_AUTO)\r\next_attr->mirror = DRX_MIRROR_NO;\r\nelse\r\next_attr->mirror = channel->mirror;\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\n&qam_ctl_ena, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\nqam_ctl_ena & ~SCU_RAM_QAM_CTL_ENA_ACQ__M, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_FSM_STATE_TGT__A,\r\n0x2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_qam(demod, channel, tuner_freq_offset,\r\nQAM_SET_OP_CONSTELLATION);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\r\nSCU_RAM_QAM_CTL_ENA__A,\r\nqam_ctl_ena, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = qam64auto(demod, channel, tuner_freq_offset,\r\n&lock_status);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nchannel->constellation = DRX_CONSTELLATION_AUTO;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\nrw_error:\r\nif (auto_flag)\r\nchannel->constellation = DRX_CONSTELLATION_AUTO;\r\nreturn rc;\r\n}\r\nstatic int\r\nget_qamrs_err_count(struct i2c_device_addr *dev_addr,\r\nstruct drxjrs_errors *rs_errors)\r\n{\r\nint rc;\r\nu16 nr_bit_errors = 0,\r\nnr_symbol_errors = 0,\r\nnr_packet_errors = 0, nr_failures = 0, nr_snc_par_fail_count = 0;\r\nif (dev_addr == NULL)\r\nreturn -EINVAL;\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_BIT_ERRORS__A, &nr_bit_errors, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_SYMBOL_ERRORS__A, &nr_symbol_errors, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_PACKET_ERRORS__A, &nr_packet_errors, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_FAILURES__A, &nr_failures, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_FAIL_COUNT__A, &nr_snc_par_fail_count, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrs_errors->nr_bit_errors = nr_bit_errors & FEC_RS_NR_BIT_ERRORS__M;\r\nrs_errors->nr_symbol_errors = nr_symbol_errors & FEC_RS_NR_SYMBOL_ERRORS__M;\r\nrs_errors->nr_packet_errors = nr_packet_errors & FEC_RS_NR_PACKET_ERRORS__M;\r\nrs_errors->nr_failures = nr_failures & FEC_RS_NR_FAILURES__M;\r\nrs_errors->nr_snc_par_fail_count =\r\nnr_snc_par_fail_count & FEC_OC_SNC_FAIL_COUNT__M;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int get_sig_strength(struct drx_demod_instance *demod, u16 *sig_strength)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nu16 rf_gain = 0;\r\nu16 if_gain = 0;\r\nu16 if_agc_sns = 0;\r\nu16 if_agc_top = 0;\r\nu16 rf_agc_max = 0;\r\nu16 rf_agc_min = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_AGC_IF__A, &if_gain, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif_gain &= IQM_AF_AGC_IF__M;\r\nrc = drxj_dap_read_reg16(dev_addr, IQM_AF_AGC_RF__A, &rf_gain, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrf_gain &= IQM_AF_AGC_RF__M;\r\nif_agc_sns = DRXJ_AGC_SNS;\r\nif_agc_top = DRXJ_AGC_TOP;\r\nrf_agc_max = DRXJ_RFAGC_MAX;\r\nrf_agc_min = DRXJ_RFAGC_MIN;\r\nif (if_gain > if_agc_top) {\r\nif (rf_gain > rf_agc_max)\r\n*sig_strength = 100;\r\nelse if (rf_gain > rf_agc_min) {\r\nif (rf_agc_max == rf_agc_min) {\r\npr_err("error: rf_agc_max == rf_agc_min\n");\r\nreturn -EIO;\r\n}\r\n*sig_strength =\r\n75 + 25 * (rf_gain - rf_agc_min) / (rf_agc_max -\r\nrf_agc_min);\r\n} else\r\n*sig_strength = 75;\r\n} else if (if_gain > if_agc_sns) {\r\nif (if_agc_top == if_agc_sns) {\r\npr_err("error: if_agc_top == if_agc_sns\n");\r\nreturn -EIO;\r\n}\r\n*sig_strength =\r\n20 + 55 * (if_gain - if_agc_sns) / (if_agc_top - if_agc_sns);\r\n} else {\r\nif (!if_agc_sns) {\r\npr_err("error: if_agc_sns is zero!\n");\r\nreturn -EIO;\r\n}\r\n*sig_strength = (20 * if_gain / if_agc_sns);\r\n}\r\nif (*sig_strength <= 7)\r\n*sig_strength = 0;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_get_qam_sig_quality(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nstruct drx39xxj_state *state = dev_addr->user_data;\r\nstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\r\nstruct drxjrs_errors measuredrs_errors = { 0, 0, 0, 0, 0 };\r\nenum drx_modulation constellation = ext_attr->constellation;\r\nint rc;\r\nu32 pre_bit_err_rs = 0;\r\nu32 post_bit_err_rs = 0;\r\nu32 pkt_errs = 0;\r\nu16 qam_sl_err_power = 0;\r\nu16 qsym_err_vd = 0;\r\nu16 fec_oc_period = 0;\r\nu16 fec_rs_prescale = 0;\r\nu16 fec_rs_period = 0;\r\nu32 rs_bit_cnt = 0;\r\nu32 qam_sl_sig_power = 0;\r\nu32 e = 0;\r\nu32 m = 0;\r\nu32 ber_cnt = 0;\r\nu32 qam_sl_mer = 0;\r\nu32 qam_pre_rs_ber = 0;\r\nu32 qam_post_rs_ber = 0;\r\nu32 qam_vd_ser = 0;\r\nu16 qam_vd_prescale = 0;\r\nu16 qam_vd_period = 0;\r\nu32 vd_bit_cnt = 0;\r\np->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nrc = get_qamrs_err_count(dev_addr, &measuredrs_errors);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_SL_ERR_POWER__A, &qam_sl_err_power, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_FAIL_PERIOD__A, &fec_oc_period, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfec_rs_period = ext_attr->fec_rs_period;\r\nfec_rs_prescale = ext_attr->fec_rs_prescale;\r\nrs_bit_cnt = fec_rs_period * fec_rs_prescale * ext_attr->fec_rs_plen;\r\nqam_vd_period = ext_attr->qam_vd_period;\r\nqam_vd_prescale = ext_attr->qam_vd_prescale;\r\nvd_bit_cnt = qam_vd_period * qam_vd_prescale * ext_attr->fec_vd_plen;\r\nswitch (constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\nqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM16 << 2;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\nqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM32 << 2;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM64 << 2;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM128:\r\nqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM128 << 2;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM256 << 2;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nif (qam_sl_err_power == 0)\r\nqam_sl_mer = 0;\r\nelse\r\nqam_sl_mer = log1_times100(qam_sl_sig_power) - log1_times100((u32)qam_sl_err_power);\r\nrc = drxj_dap_read_reg16(dev_addr, QAM_VD_NR_QSYM_ERRORS__A, &qsym_err_vd, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ne = (qsym_err_vd & QAM_VD_NR_QSYM_ERRORS_EXP__M) >>\r\nQAM_VD_NR_QSYM_ERRORS_EXP__B;\r\nm = (qsym_err_vd & QAM_VD_NR_SYMBOL_ERRORS_FIXED_MANT__M) >>\r\nQAM_VD_NR_SYMBOL_ERRORS_FIXED_MANT__B;\r\nif ((m << e) >> 3 > 549752)\r\nqam_vd_ser = 500000 * vd_bit_cnt * ((e > 2) ? 1 : 8) / 8;\r\nelse\r\nqam_vd_ser = m << ((e > 2) ? (e - 3) : e);\r\npre_bit_err_rs = (u32) measuredrs_errors.nr_bit_errors;\r\npkt_errs = post_bit_err_rs = (u32) measuredrs_errors.nr_snc_par_fail_count;\r\ne = (pre_bit_err_rs & FEC_RS_NR_BIT_ERRORS_EXP__M) >>\r\nFEC_RS_NR_BIT_ERRORS_EXP__B;\r\nm = (pre_bit_err_rs & FEC_RS_NR_BIT_ERRORS_FIXED_MANT__M) >>\r\nFEC_RS_NR_BIT_ERRORS_FIXED_MANT__B;\r\nber_cnt = m << e;\r\nif (m > (rs_bit_cnt >> (e + 1)) || (rs_bit_cnt >> e) == 0)\r\nqam_pre_rs_ber = 500000 * rs_bit_cnt >> e;\r\nelse\r\nqam_pre_rs_ber = ber_cnt;\r\ne = post_bit_err_rs * 742686;\r\nm = fec_oc_period * 100;\r\nif (fec_oc_period == 0)\r\nqam_post_rs_ber = 0xFFFFFFFF;\r\nelse\r\nqam_post_rs_ber = e / m;\r\np->pre_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\np->post_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->post_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->block_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->cnr.stat[0].scale = FE_SCALE_DECIBEL;\r\np->cnr.stat[0].svalue = ((u16) qam_sl_mer) * 100;\r\nif (ext_attr->standard == DRX_STANDARD_ITU_B) {\r\np->pre_bit_error.stat[0].uvalue += qam_vd_ser;\r\np->pre_bit_count.stat[0].uvalue += vd_bit_cnt * ((e > 2) ? 1 : 8) / 8;\r\n} else {\r\np->pre_bit_error.stat[0].uvalue += qam_pre_rs_ber;\r\np->pre_bit_count.stat[0].uvalue += rs_bit_cnt >> e;\r\n}\r\np->post_bit_error.stat[0].uvalue += qam_post_rs_ber;\r\np->post_bit_count.stat[0].uvalue += rs_bit_cnt >> e;\r\np->block_error.stat[0].uvalue += pkt_errs;\r\n#ifdef DRXJ_SIGNAL_ACCUM_ERR\r\nrc = get_acc_pkt_err(demod, &sig_quality->packet_error);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n#endif\r\nreturn 0;\r\nrw_error:\r\np->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nreturn rc;\r\n}\r\nstatic int\r\npower_down_atv(struct drx_demod_instance *demod, enum drx_standard standard, bool primary)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxjscu_cmd cmd_scu = { 0,\r\n0,\r\n0,\r\nNULL,\r\nNULL\r\n};\r\nint rc;\r\nu16 cmd_result = 0;\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_ATV |\r\nSCU_RAM_COMMAND_CMD_DEMOD_STOP;\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 1;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = &cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ATV_TOP_STDBY__A, (ATV_TOP_STDBY_SIF_STDBY_STANDBY & (~ATV_TOP_STDBY_CVBS_STDBY_A2_ACTIVE)), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ATV_COMM_EXEC__A, ATV_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (primary) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_iqm_af(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} else {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = power_down_aud(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int power_down_aud(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\ndev_addr = (struct i2c_device_addr *)demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nrc = drxj_dap_write_reg16(dev_addr, AUD_COMM_EXEC__A, AUD_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->aud_data.audio_is_active = false;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int set_orx_nsu_aox(struct drx_demod_instance *demod, bool active)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nu16 data = 0;\r\nrc = drxj_dap_read_reg16(dev_addr, ORX_NSU_AOX_STDBY_W__A, &data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (!active)\r\ndata &= ((~ORX_NSU_AOX_STDBY_W_STDBYADC_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYAMP_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYBIAS_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYPLL_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYPD_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYTAGC_IF_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYTAGC_RF_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYFLT_A2_ON));\r\nelse\r\ndata |= (ORX_NSU_AOX_STDBY_W_STDBYADC_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYAMP_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYBIAS_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYPLL_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYPD_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYTAGC_IF_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYTAGC_RF_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYFLT_A2_ON);\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_STDBY_W__A, data, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int ctrl_set_oob(struct drx_demod_instance *demod, struct drxoob *oob_param)\r\n{\r\nint rc;\r\ns32 freq = 0;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nu16 i = 0;\r\nbool mirror_freq_spect_oob = false;\r\nu16 trk_filter_value = 0;\r\nstruct drxjscu_cmd scu_cmd;\r\nu16 set_param_parameters[3];\r\nu16 cmd_result[2] = { 0, 0 };\r\ns16 nyquist_coeffs[4][(NYQFILTERLEN + 1) / 2] = {\r\nIMPULSE_COSINE_ALPHA_0_3,\r\nIMPULSE_COSINE_ALPHA_0_3,\r\nIMPULSE_COSINE_ALPHA_0_5,\r\nIMPULSE_COSINE_ALPHA_RO_0_5\r\n};\r\nu8 mode_val[4] = { 2, 2, 0, 1 };\r\nu8 pfi_coeffs[4][6] = {\r\n{DRXJ_16TO8(-92), DRXJ_16TO8(-108), DRXJ_16TO8(100)},\r\n{DRXJ_16TO8(-64), DRXJ_16TO8(-80), DRXJ_16TO8(80)},\r\n{DRXJ_16TO8(-80), DRXJ_16TO8(-98), DRXJ_16TO8(92)},\r\n{DRXJ_16TO8(-80), DRXJ_16TO8(-98), DRXJ_16TO8(92)}\r\n};\r\nu16 mode_index;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nmirror_freq_spect_oob = ext_attr->mirror_freq_spect_oob;\r\nif (oob_param == NULL) {\r\nscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_STOP;\r\nscu_cmd.parameter_len = 0;\r\nscu_cmd.result_len = 1;\r\nscu_cmd.result = cmd_result;\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_orx_nsu_aox(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->oob_power_on = false;\r\nreturn 0;\r\n}\r\nfreq = oob_param->frequency;\r\nif ((freq < 70000) || (freq > 130000))\r\nreturn -EIO;\r\nfreq = (freq - 50000) / 50;\r\n{\r\nu16 index = 0;\r\nu16 remainder = 0;\r\nu16 *trk_filtercfg = ext_attr->oob_trk_filter_cfg;\r\nindex = (u16) ((freq - 400) / 200);\r\nremainder = (u16) ((freq - 400) % 200);\r\ntrk_filter_value =\r\ntrk_filtercfg[index] - (trk_filtercfg[index] -\r\ntrk_filtercfg[index +\r\n1]) / 10 * remainder /\r\n20;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_STOP;\r\nscu_cmd.parameter_len = 0;\r\nscu_cmd.result_len = 1;\r\nscu_cmd.result = cmd_result;\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_RESET;\r\nscu_cmd.parameter_len = 0;\r\nscu_cmd.result_len = 1;\r\nscu_cmd.result = cmd_result;\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV;\r\nscu_cmd.parameter_len = 3;\r\nswitch (oob_param->standard) {\r\ncase DRX_OOB_MODE_A:\r\nif (\r\n((oob_param->spectrum_inverted == true) &&\r\n(!mirror_freq_spect_oob)) |\r\n((oob_param->spectrum_inverted == false) &&\r\n(mirror_freq_spect_oob))\r\n)\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_2048KBPS_INVSPEC;\r\nelse\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_2048KBPS_REGSPEC;\r\nbreak;\r\ncase DRX_OOB_MODE_B_GRADE_A:\r\nif (\r\n((oob_param->spectrum_inverted == true) &&\r\n(!mirror_freq_spect_oob)) |\r\n((oob_param->spectrum_inverted == false) &&\r\n(mirror_freq_spect_oob))\r\n)\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_1544KBPS_INVSPEC;\r\nelse\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_1544KBPS_REGSPEC;\r\nbreak;\r\ncase DRX_OOB_MODE_B_GRADE_B:\r\ndefault:\r\nif (\r\n((oob_param->spectrum_inverted == true) &&\r\n(!mirror_freq_spect_oob)) |\r\n((oob_param->spectrum_inverted == false) &&\r\n(mirror_freq_spect_oob))\r\n)\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_3088KBPS_INVSPEC;\r\nelse\r\nset_param_parameters[0] =\r\nSCU_RAM_ORX_RF_RX_DATA_RATE_3088KBPS_REGSPEC;\r\nbreak;\r\n}\r\nset_param_parameters[1] = (u16) (freq & 0xFFFF);\r\nset_param_parameters[2] = trk_filter_value;\r\nscu_cmd.parameter = set_param_parameters;\r\nscu_cmd.result_len = 1;\r\nscu_cmd.result = cmd_result;\r\nmode_index = mode_val[(set_param_parameters[0] & 0xC0) >> 6];\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_OOB_CRX_CFG__A, OOB_CRX_DRIVE_STRENGTH << SIO_PDR_OOB_CRX_CFG_DRIVE__B | 0x03 << SIO_PDR_OOB_CRX_CFG_MODE__B, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_PDR_OOB_DRX_CFG__A, OOB_DRX_DRIVE_STRENGTH << SIO_PDR_OOB_DRX_CFG_DRIVE__B | 0x03 << SIO_PDR_OOB_DRX_CFG_MODE__B, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_TOP_COMM_KEY__A, 0, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_FWP_AAG_LEN_W__A, 16000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_FWP_AAG_THR_W__A, 40, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_DDC_OFO_SET_W__A, ORX_DDC_OFO_SET_W__PRE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_LOPOW_W__A, ext_attr->oob_lo_pow, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TARGET_MODE__A, SCU_RAM_ORX_TARGET_MODE_2048KBPS_SQRT, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FREQ_GAIN_CORR__A, SCU_RAM_ORX_FREQ_GAIN_CORR_2048KBPS, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_CPH__A, 0x0001, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_CTI__A, 0x0002, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_KRN__A, 0x0004, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_KRP__A, 0x0008, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_TH__A, 2048 >> 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_ONLOCK_TTH__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_UNLOCK_TTH__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_MASK__A, 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_TH__A, 10, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_ONLOCK_TTH__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_UNLOCK_TTH__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_MASK__A, 1 << 1, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_TH__A, 17, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_ONLOCK_TTH__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_UNLOCK_TTH__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_MASK__A, 1 << 2, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_TH__A, 3000, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_ONLOCK_TTH__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_UNLOCK_TTH__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_MASK__A, 1 << 3, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_TH__A, 400, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_ONLOCK_TTH__A, 8, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_UNLOCK_TTH__A, (u16)(-8), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_MASK__A, 1 << 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_TH__A, 20, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_TOTH__A, (u16)(-2048), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_ONLOCK_TTH__A, 4, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_UNLOCK_TTH__A, (u16)(-4), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_MASK__A, 1 << 5, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxdap_fasi_write_block(dev_addr, ORX_FWP_PFI_A_W__A, sizeof(pfi_coeffs[mode_index]), ((u8 *)pfi_coeffs[mode_index]), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_TOP_MDE_W__A, mode_index, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nfor (i = 0; i < (NYQFILTERLEN + 1) / 2; i++) {\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_ADR_W__A, i, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_COF_RW__A, nyquist_coeffs[mode_index][i], 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_ADR_W__A, 31, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\r\n| SCU_RAM_COMMAND_CMD_DEMOD_START;\r\nscu_cmd.parameter_len = 0;\r\nscu_cmd.result_len = 1;\r\nscu_cmd.result = cmd_result;\r\nrc = scu_command(dev_addr, &scu_cmd);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_orx_nsu_aox(demod, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_STHR_W__A, ext_attr->oob_pre_saw, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->oob_power_on = true;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_set_channel(struct drx_demod_instance *demod, struct drx_channel *channel)\r\n{\r\nint rc;\r\ns32 tuner_freq_offset = 0;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nenum drx_standard standard = DRX_STANDARD_UNKNOWN;\r\n#ifndef DRXJ_VSB_ONLY\r\nu32 min_symbol_rate = 0;\r\nu32 max_symbol_rate = 0;\r\nint bandwidth_temp = 0;\r\nint bandwidth = 0;\r\n#endif\r\nif ((demod == NULL) || (channel == NULL))\r\nreturn -EINVAL;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nstandard = ext_attr->standard;\r\nswitch (standard) {\r\ncase DRX_STANDARD_8VSB:\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\n#endif\r\nbreak;\r\ncase DRX_STANDARD_UNKNOWN:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif ((standard == DRX_STANDARD_ITU_B) ||\r\n(standard == DRX_STANDARD_8VSB) ||\r\n(standard == DRX_STANDARD_NTSC)) {\r\nswitch (channel->bandwidth) {\r\ncase DRX_BANDWIDTH_6MHZ:\r\ncase DRX_BANDWIDTH_UNKNOWN:\r\nchannel->bandwidth = DRX_BANDWIDTH_6MHZ;\r\nbreak;\r\ncase DRX_BANDWIDTH_8MHZ:\r\ncase DRX_BANDWIDTH_7MHZ:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\n#ifndef DRXJ_VSB_ONLY\r\nif ((standard == DRX_STANDARD_ITU_A) ||\r\n(standard == DRX_STANDARD_ITU_C)) {\r\nstruct drxuio_cfg uio_cfg = { DRX_UIO1, DRX_UIO_MODE_FIRMWARE_SAW };\r\nint bw_rolloff_factor = 0;\r\nbw_rolloff_factor = (standard == DRX_STANDARD_ITU_A) ? 115 : 113;\r\nmin_symbol_rate = DRXJ_QAM_SYMBOLRATE_MIN;\r\nmax_symbol_rate = DRXJ_QAM_SYMBOLRATE_MAX;\r\nrc = ctrl_set_uio_cfg(demod, &uio_cfg);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (channel->symbolrate < min_symbol_rate ||\r\nchannel->symbolrate > max_symbol_rate) {\r\nreturn -EINVAL;\r\n}\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\ncase DRX_CONSTELLATION_QAM32:\r\ncase DRX_CONSTELLATION_QAM64:\r\ncase DRX_CONSTELLATION_QAM128:\r\ncase DRX_CONSTELLATION_QAM256:\r\nbandwidth_temp = channel->symbolrate * bw_rolloff_factor;\r\nbandwidth = bandwidth_temp / 100;\r\nif ((bandwidth_temp % 100) >= 50)\r\nbandwidth++;\r\nif (bandwidth <= 6100000) {\r\nchannel->bandwidth = DRX_BANDWIDTH_6MHZ;\r\n} else if ((bandwidth > 6100000)\r\n&& (bandwidth <= 7100000)) {\r\nchannel->bandwidth = DRX_BANDWIDTH_7MHZ;\r\n} else if (bandwidth > 7100000) {\r\nchannel->bandwidth = DRX_BANDWIDTH_8MHZ;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (standard == DRX_STANDARD_ITU_B) {\r\nswitch (channel->constellation) {\r\ncase DRX_CONSTELLATION_AUTO:\r\ncase DRX_CONSTELLATION_QAM256:\r\ncase DRX_CONSTELLATION_QAM64:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (channel->interleavemode) {\r\ncase DRX_INTERLEAVEMODE_I128_J1:\r\ncase DRX_INTERLEAVEMODE_I128_J1_V2:\r\ncase DRX_INTERLEAVEMODE_I128_J2:\r\ncase DRX_INTERLEAVEMODE_I64_J2:\r\ncase DRX_INTERLEAVEMODE_I128_J3:\r\ncase DRX_INTERLEAVEMODE_I32_J4:\r\ncase DRX_INTERLEAVEMODE_I128_J4:\r\ncase DRX_INTERLEAVEMODE_I16_J8:\r\ncase DRX_INTERLEAVEMODE_I128_J5:\r\ncase DRX_INTERLEAVEMODE_I8_J16:\r\ncase DRX_INTERLEAVEMODE_I128_J6:\r\ncase DRX_INTERLEAVEMODE_I128_J7:\r\ncase DRX_INTERLEAVEMODE_I128_J8:\r\ncase DRX_INTERLEAVEMODE_I12_J17:\r\ncase DRX_INTERLEAVEMODE_I5_J4:\r\ncase DRX_INTERLEAVEMODE_B52_M240:\r\ncase DRX_INTERLEAVEMODE_B52_M720:\r\ncase DRX_INTERLEAVEMODE_UNKNOWN:\r\ncase DRX_INTERLEAVEMODE_AUTO:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nif ((ext_attr->uio_sma_tx_mode) == DRX_UIO_MODE_FIRMWARE_SAW) {\r\nstruct drxuio_data uio1 = { DRX_UIO1, false };\r\nswitch (channel->bandwidth) {\r\ncase DRX_BANDWIDTH_8MHZ:\r\nuio1.value = true;\r\nbreak;\r\ncase DRX_BANDWIDTH_7MHZ:\r\nuio1.value = false;\r\nbreak;\r\ncase DRX_BANDWIDTH_6MHZ:\r\nuio1.value = false;\r\nbreak;\r\ncase DRX_BANDWIDTH_UNKNOWN:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrc = ctrl_uio_write(demod, &uio1);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\n#endif\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ntuner_freq_offset = 0;\r\nswitch (standard) {\r\ncase DRX_STANDARD_8VSB:\r\nif (channel->mirror == DRX_MIRROR_AUTO)\r\next_attr->mirror = DRX_MIRROR_NO;\r\nelse\r\next_attr->mirror = channel->mirror;\r\nrc = set_vsb(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_frequency(demod, channel, tuner_freq_offset);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\nrc = set_qam_channel(demod, channel, tuner_freq_offset);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\n#endif\r\ncase DRX_STANDARD_UNKNOWN:\r\ndefault:\r\nreturn -EIO;\r\n}\r\next_attr->reset_pkt_err_acc = true;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_sig_quality(struct drx_demod_instance *demod,\r\nenum drx_lock_status lock_status)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nstruct drx39xxj_state *state = dev_addr->user_data;\r\nstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\r\nenum drx_standard standard = ext_attr->standard;\r\nint rc;\r\nu32 ber, cnt, err, pkt;\r\nu16 mer, strength = 0;\r\nrc = get_sig_strength(demod, &strength);\r\nif (rc < 0) {\r\npr_err("error getting signal strength %d\n", rc);\r\np->strength.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\np->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\np->strength.stat[0].uvalue = 65535UL * strength/ 100;\r\n}\r\nswitch (standard) {\r\ncase DRX_STANDARD_8VSB:\r\n#ifdef DRXJ_SIGNAL_ACCUM_ERR\r\nrc = get_acc_pkt_err(demod, &pkt);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n#endif\r\nif (lock_status != DRXJ_DEMOD_LOCK && lock_status != DRX_LOCKED) {\r\np->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\nrc = get_vsb_post_rs_pck_err(dev_addr, &err, &pkt);\r\nif (rc != 0) {\r\npr_err("error %d getting UCB\n", rc);\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\np->block_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->block_error.stat[0].uvalue += err;\r\np->block_count.stat[0].scale = FE_SCALE_COUNTER;\r\np->block_count.stat[0].uvalue += pkt;\r\n}\r\nrc = get_vs_bpre_viterbi_ber(dev_addr, &ber, &cnt);\r\nif (rc != 0) {\r\npr_err("error %d getting pre-ber\n", rc);\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\np->pre_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->pre_bit_error.stat[0].uvalue += ber;\r\np->pre_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\np->pre_bit_count.stat[0].uvalue += cnt;\r\n}\r\nrc = get_vs_bpost_viterbi_ber(dev_addr, &ber, &cnt);\r\nif (rc != 0) {\r\npr_err("error %d getting post-ber\n", rc);\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\np->post_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\np->post_bit_error.stat[0].uvalue += ber;\r\np->post_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\np->post_bit_count.stat[0].uvalue += cnt;\r\n}\r\nrc = get_vsbmer(dev_addr, &mer);\r\nif (rc != 0) {\r\npr_err("error %d getting MER\n", rc);\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n} else {\r\np->cnr.stat[0].svalue = mer * 100;\r\np->cnr.stat[0].scale = FE_SCALE_DECIBEL;\r\n}\r\n}\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\nrc = ctrl_get_qam_sig_quality(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_lock_status(struct drx_demod_instance *demod, enum drx_lock_status *lock_stat)\r\n{\r\nenum drx_standard standard = DRX_STANDARD_UNKNOWN;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxjscu_cmd cmd_scu = { 0,\r\n0,\r\n0,\r\nNULL,\r\nNULL\r\n};\r\nint rc;\r\nu16 cmd_result[2] = { 0, 0 };\r\nu16 demod_lock = SCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_DEMOD_LOCKED;\r\nif ((demod == NULL) || (lock_stat == NULL))\r\nreturn -EINVAL;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nstandard = ext_attr->standard;\r\n*lock_stat = DRX_NOT_LOCKED;\r\nswitch (standard) {\r\ncase DRX_STANDARD_8VSB:\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB |\r\nSCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK;\r\ndemod_lock |= 0x6;\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\ncmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK;\r\nbreak;\r\n#endif\r\ncase DRX_STANDARD_UNKNOWN:\r\ndefault:\r\nreturn -EIO;\r\n}\r\ncmd_scu.parameter_len = 0;\r\ncmd_scu.result_len = 2;\r\ncmd_scu.parameter = NULL;\r\ncmd_scu.result = cmd_result;\r\nrc = scu_command(dev_addr, &cmd_scu);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (cmd_scu.result[1] < demod_lock) {\r\n*lock_stat = DRX_NOT_LOCKED;\r\n} else if (cmd_scu.result[1] < SCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_LOCKED) {\r\n*lock_stat = DRXJ_DEMOD_LOCK;\r\n} else if (cmd_scu.result[1] <\r\nSCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_NEVER_LOCK) {\r\n*lock_stat = DRX_LOCKED;\r\n} else {\r\n*lock_stat = DRX_NEVER_LOCK;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_set_standard(struct drx_demod_instance *demod, enum drx_standard *standard)\r\n{\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\nenum drx_standard prev_standard;\r\nif ((standard == NULL) || (demod == NULL))\r\nreturn -EINVAL;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nprev_standard = ext_attr->standard;\r\nswitch (prev_standard) {\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\nrc = power_down_qam(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\n#endif\r\ncase DRX_STANDARD_8VSB:\r\nrc = power_down_vsb(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_UNKNOWN:\r\nbreak;\r\ncase DRX_STANDARD_AUTO:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\next_attr->standard = *standard;\r\nswitch (*standard) {\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\ndo {\r\nu16 dummy;\r\nrc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SCU_RAM_VERSION_HI__A, &dummy, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n} while (0);\r\nbreak;\r\n#endif\r\ncase DRX_STANDARD_8VSB:\r\nrc = set_vsb_leak_n_gain(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ndefault:\r\next_attr->standard = DRX_STANDARD_UNKNOWN;\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nreturn 0;\r\nrw_error:\r\next_attr->standard = DRX_STANDARD_UNKNOWN;\r\nreturn rc;\r\n}\r\nstatic void drxj_reset_mode(struct drxj_data *ext_attr)\r\n{\r\nif (ext_attr->has_lna) {\r\n#ifndef DRXJ_VSB_ONLY\r\next_attr->qam_if_agc_cfg.standard = DRX_STANDARD_ITU_B;\r\next_attr->qam_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_OFF;\r\next_attr->qam_pga_cfg = 140 + (11 * 13);\r\n#endif\r\next_attr->vsb_if_agc_cfg.standard = DRX_STANDARD_8VSB;\r\next_attr->vsb_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_OFF;\r\next_attr->vsb_pga_cfg = 140 + (11 * 13);\r\n} else {\r\n#ifndef DRXJ_VSB_ONLY\r\next_attr->qam_if_agc_cfg.standard = DRX_STANDARD_ITU_B;\r\next_attr->qam_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\r\next_attr->qam_if_agc_cfg.min_output_level = 0;\r\next_attr->qam_if_agc_cfg.max_output_level = 0x7FFF;\r\next_attr->qam_if_agc_cfg.speed = 3;\r\next_attr->qam_if_agc_cfg.top = 1297;\r\next_attr->qam_pga_cfg = 140;\r\n#endif\r\next_attr->vsb_if_agc_cfg.standard = DRX_STANDARD_8VSB;\r\next_attr->vsb_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\r\next_attr->vsb_if_agc_cfg.min_output_level = 0;\r\next_attr->vsb_if_agc_cfg.max_output_level = 0x7FFF;\r\next_attr->vsb_if_agc_cfg.speed = 3;\r\next_attr->vsb_if_agc_cfg.top = 1024;\r\next_attr->vsb_pga_cfg = 140;\r\n}\r\n#ifndef DRXJ_VSB_ONLY\r\next_attr->qam_rf_agc_cfg.standard = DRX_STANDARD_ITU_B;\r\next_attr->qam_rf_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\r\next_attr->qam_rf_agc_cfg.min_output_level = 0;\r\next_attr->qam_rf_agc_cfg.max_output_level = 0x7FFF;\r\next_attr->qam_rf_agc_cfg.speed = 3;\r\next_attr->qam_rf_agc_cfg.top = 9500;\r\next_attr->qam_rf_agc_cfg.cut_off_current = 4000;\r\next_attr->qam_pre_saw_cfg.standard = DRX_STANDARD_ITU_B;\r\next_attr->qam_pre_saw_cfg.reference = 0x07;\r\next_attr->qam_pre_saw_cfg.use_pre_saw = true;\r\n#endif\r\next_attr->vsb_rf_agc_cfg.standard = DRX_STANDARD_8VSB;\r\next_attr->vsb_rf_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\r\next_attr->vsb_rf_agc_cfg.min_output_level = 0;\r\next_attr->vsb_rf_agc_cfg.max_output_level = 0x7FFF;\r\next_attr->vsb_rf_agc_cfg.speed = 3;\r\next_attr->vsb_rf_agc_cfg.top = 9500;\r\next_attr->vsb_rf_agc_cfg.cut_off_current = 4000;\r\next_attr->vsb_pre_saw_cfg.standard = DRX_STANDARD_8VSB;\r\next_attr->vsb_pre_saw_cfg.reference = 0x07;\r\next_attr->vsb_pre_saw_cfg.use_pre_saw = true;\r\n}\r\nstatic int\r\nctrl_power_mode(struct drx_demod_instance *demod, enum drx_power_mode *mode)\r\n{\r\nstruct drx_common_attr *common_attr = (struct drx_common_attr *) NULL;\r\nstruct drxj_data *ext_attr = (struct drxj_data *) NULL;\r\nstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)NULL;\r\nint rc;\r\nu16 sio_cc_pwd_mode = 0;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ndev_addr = demod->my_i2c_dev_addr;\r\nif (mode == NULL)\r\nreturn -EINVAL;\r\nif (common_attr->current_power_mode == *mode)\r\nreturn 0;\r\nswitch (*mode) {\r\ncase DRX_POWER_UP:\r\ncase DRXJ_POWER_DOWN_MAIN_PATH:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_NONE;\r\nbreak;\r\ncase DRXJ_POWER_DOWN_CORE:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_CLOCK;\r\nbreak;\r\ncase DRXJ_POWER_DOWN_PLL:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_PLL;\r\nbreak;\r\ncase DRX_POWER_DOWN:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_OSC;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nif ((common_attr->current_power_mode != DRX_POWER_UP)) {\r\nrc = power_up_device(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nif ((*mode == DRX_POWER_UP)) {\r\ndrxj_reset_mode(ext_attr);\r\n} else {\r\nswitch (ext_attr->standard) {\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\nrc = power_down_qam(demod, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_8VSB:\r\nrc = power_down_vsb(demod, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_PAL_SECAM_BG:\r\ncase DRX_STANDARD_PAL_SECAM_DK:\r\ncase DRX_STANDARD_PAL_SECAM_I:\r\ncase DRX_STANDARD_PAL_SECAM_L:\r\ncase DRX_STANDARD_PAL_SECAM_LP:\r\ncase DRX_STANDARD_NTSC:\r\ncase DRX_STANDARD_FM:\r\nrc = power_down_atv(demod, ext_attr->standard, true);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nbreak;\r\ncase DRX_STANDARD_UNKNOWN:\r\nbreak;\r\ncase DRX_STANDARD_AUTO:\r\ndefault:\r\nreturn -EIO;\r\n}\r\next_attr->standard = DRX_STANDARD_UNKNOWN;\r\n}\r\nif (*mode != DRXJ_POWER_DOWN_MAIN_PATH) {\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_CC_PWD_MODE__A, sio_cc_pwd_mode, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif ((*mode != DRX_POWER_UP)) {\r\nrc = init_hi(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->hi_cfg_ctrl |= SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ;\r\nrc = hi_cfg_command(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\n}\r\ncommon_attr->current_power_mode = *mode;\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_set_cfg_pre_saw(struct drx_demod_instance *demod, struct drxj_cfg_pre_saw *pre_saw)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nif ((pre_saw == NULL) || (pre_saw->reference > IQM_AF_PDREF__M)\r\n) {\r\nreturn -EINVAL;\r\n}\r\nif ((ext_attr->standard == pre_saw->standard) ||\r\n(DRXJ_ISQAMSTD(ext_attr->standard) &&\r\nDRXJ_ISQAMSTD(pre_saw->standard)) ||\r\n(DRXJ_ISATVSTD(ext_attr->standard) &&\r\nDRXJ_ISATVSTD(pre_saw->standard))) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_PDREF__A, pre_saw->reference, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nswitch (pre_saw->standard) {\r\ncase DRX_STANDARD_8VSB:\r\next_attr->vsb_pre_saw_cfg = *pre_saw;\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\next_attr->qam_pre_saw_cfg = *pre_saw;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int\r\nctrl_set_cfg_afe_gain(struct drx_demod_instance *demod, struct drxj_cfg_afe_gain *afe_gain)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nint rc;\r\nu8 gain = 0;\r\nif (afe_gain == NULL)\r\nreturn -EINVAL;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\nswitch (afe_gain->standard) {\r\ncase DRX_STANDARD_8VSB:\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\n#endif\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (afe_gain->gain >= 329)\r\ngain = 15;\r\nelse if (afe_gain->gain <= 147)\r\ngain = 0;\r\nelse\r\ngain = (afe_gain->gain - 140 + 6) / 13;\r\nif (ext_attr->standard == afe_gain->standard) {\r\nrc = drxj_dap_write_reg16(dev_addr, IQM_AF_PGA_GAIN__A, gain, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\n}\r\nswitch (afe_gain->standard) {\r\ncase DRX_STANDARD_8VSB:\r\next_attr->vsb_pga_cfg = gain * 13 + 140;\r\nbreak;\r\n#ifndef DRXJ_VSB_ONLY\r\ncase DRX_STANDARD_ITU_A:\r\ncase DRX_STANDARD_ITU_B:\r\ncase DRX_STANDARD_ITU_C:\r\next_attr->qam_pga_cfg = gain * 13 + 140;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\nrw_error:\r\nreturn rc;\r\n}\r\nstatic int drxj_open(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = NULL;\r\nstruct drxj_data *ext_attr = NULL;\r\nstruct drx_common_attr *common_attr = NULL;\r\nu32 driver_version = 0;\r\nstruct drxu_code_info ucode_info;\r\nstruct drx_cfg_mpeg_output cfg_mpeg_output;\r\nint rc;\r\nenum drx_power_mode power_mode = DRX_POWER_UP;\r\nif ((demod == NULL) ||\r\n(demod->my_common_attr == NULL) ||\r\n(demod->my_ext_attr == NULL) ||\r\n(demod->my_i2c_dev_addr == NULL) ||\r\n(demod->my_common_attr->is_opened)) {\r\nreturn -EINVAL;\r\n}\r\nif (demod->my_ext_attr == NULL)\r\nreturn -EINVAL;\r\ndev_addr = demod->my_i2c_dev_addr;\r\next_attr = (struct drxj_data *) demod->my_ext_attr;\r\ncommon_attr = (struct drx_common_attr *) demod->my_common_attr;\r\nrc = ctrl_power_mode(demod, &power_mode);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (power_mode != DRX_POWER_UP) {\r\nrc = -EINVAL;\r\npr_err("failed to powerup device\n");\r\ngoto rw_error;\r\n}\r\nrc = get_device_capabilities(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_CC_SOFT_RST__A, (0x04 | SIO_CC_SOFT_RST_SYS__M | SIO_CC_SOFT_RST_OSC__M), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nmsleep(1);\r\nrc = drxj_dap_write_reg16(dev_addr, ATV_TOP_STDBY__A, (~ATV_TOP_STDBY_CVBS_STDBY_A2_ACTIVE) | ATV_TOP_STDBY_SIF_STDBY_STANDBY, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_iqm_af(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = set_orx_nsu_aox(demod, false);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = init_hi(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\r\ncfg_mpeg_output.enable_mpeg_output = false;\r\nrc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = power_down_aud(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_STOP, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nif (common_attr->microcode_file != NULL) {\r\ncommon_attr->is_opened = true;\r\nucode_info.mc_file = common_attr->microcode_file;\r\nif (DRX_ISPOWERDOWNMODE(demod->my_common_attr->current_power_mode)) {\r\npr_err("Should powerup before loading the firmware.");\r\nreturn -EINVAL;\r\n}\r\nrc = drx_ctrl_u_code(demod, &ucode_info, UCODE_UPLOAD);\r\nif (rc != 0) {\r\npr_err("error %d while uploading the firmware\n", rc);\r\ngoto rw_error;\r\n}\r\nif (common_attr->verify_microcode == true) {\r\nrc = drx_ctrl_u_code(demod, &ucode_info, UCODE_VERIFY);\r\nif (rc != 0) {\r\npr_err("error %d while verifying the firmware\n",\r\nrc);\r\ngoto rw_error;\r\n}\r\n}\r\ncommon_attr->is_opened = false;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ncommon_attr->scan_demod_lock_timeout = DRXJ_SCAN_TIMEOUT;\r\ncommon_attr->scan_desired_lock = DRX_LOCKED;\r\ndrxj_reset_mode(ext_attr);\r\next_attr->standard = DRX_STANDARD_UNKNOWN;\r\nrc = smart_ant_init(demod);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\ndriver_version = (VERSION_MAJOR / 100) % 10;\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_MAJOR / 10) % 10;\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_MAJOR % 10);\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_MINOR % 10);\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_PATCH / 1000) % 10;\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_PATCH / 100) % 10;\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_PATCH / 10) % 10;\r\ndriver_version <<= 4;\r\ndriver_version += (VERSION_PATCH % 10);\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_DRIVER_VER_HI__A, (u16)(driver_version >> 16), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_RAM_DRIVER_VER_LO__A, (u16)(driver_version & 0xFFFF), 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = ctrl_set_oob(demod, NULL);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\next_attr->aud_data = drxj_default_aud_data_g;\r\ndemod->my_common_attr->is_opened = true;\r\ndrxj_set_lna_state(demod, false);\r\nreturn 0;\r\nrw_error:\r\ncommon_attr->is_opened = false;\r\nreturn rc;\r\n}\r\nstatic int drxj_close(struct drx_demod_instance *demod)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nenum drx_power_mode power_mode = DRX_POWER_UP;\r\nif ((demod->my_common_attr == NULL) ||\r\n(demod->my_ext_attr == NULL) ||\r\n(demod->my_i2c_dev_addr == NULL) ||\r\n(!demod->my_common_attr->is_opened)) {\r\nreturn -EINVAL;\r\n}\r\nrc = ctrl_power_mode(demod, &power_mode);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nrc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\npower_mode = DRX_POWER_DOWN;\r\nrc = ctrl_power_mode(demod, &power_mode);\r\nif (rc != 0) {\r\npr_err("error %d\n", rc);\r\ngoto rw_error;\r\n}\r\nDRX_ATTR_ISOPENED(demod) = false;\r\nreturn 0;\r\nrw_error:\r\nDRX_ATTR_ISOPENED(demod) = false;\r\nreturn rc;\r\n}\r\nstatic u16 drx_u_code_compute_crc(u8 *block_data, u16 nr_words)\r\n{\r\nu16 i = 0;\r\nu16 j = 0;\r\nu32 crc_word = 0;\r\nu32 carry = 0;\r\nwhile (i < nr_words) {\r\ncrc_word |= (u32)be16_to_cpu(*(__be16 *)(block_data));\r\nfor (j = 0; j < 16; j++) {\r\ncrc_word <<= 1;\r\nif (carry != 0)\r\ncrc_word ^= 0x80050000UL;\r\ncarry = crc_word & 0x80000000UL;\r\n}\r\ni++;\r\nblock_data += (sizeof(u16));\r\n}\r\nreturn (u16)(crc_word >> 16);\r\n}\r\nstatic int drx_check_firmware(struct drx_demod_instance *demod, u8 *mc_data,\r\nunsigned size)\r\n{\r\nstruct drxu_code_block_hdr block_hdr;\r\nint i;\r\nunsigned count = 2 * sizeof(u16);\r\nu32 mc_dev_type, mc_version, mc_base_version;\r\nu16 mc_nr_of_blks = be16_to_cpu(*(__be16 *)(mc_data + sizeof(u16)));\r\nDRX_ATTR_MCRECORD(demod).aux_type = 0;\r\nDRX_ATTR_MCRECORD(demod).mc_dev_type = 0;\r\nDRX_ATTR_MCRECORD(demod).mc_version = 0;\r\nDRX_ATTR_MCRECORD(demod).mc_base_version = 0;\r\nfor (i = 0; i < mc_nr_of_blks; i++) {\r\nif (count + 3 * sizeof(u16) + sizeof(u32) > size)\r\ngoto eof;\r\nblock_hdr.addr = be32_to_cpu(*(__be32 *)(mc_data + count));\r\ncount += sizeof(u32);\r\nblock_hdr.size = be16_to_cpu(*(__be16 *)(mc_data + count));\r\ncount += sizeof(u16);\r\nblock_hdr.flags = be16_to_cpu(*(__be16 *)(mc_data + count));\r\ncount += sizeof(u16);\r\nblock_hdr.CRC = be16_to_cpu(*(__be16 *)(mc_data + count));\r\ncount += sizeof(u16);\r\npr_debug("%u: addr %u, size %u, flags 0x%04x, CRC 0x%04x\n",\r\ncount, block_hdr.addr, block_hdr.size, block_hdr.flags,\r\nblock_hdr.CRC);\r\nif (block_hdr.flags & 0x8) {\r\nu8 *auxblk = ((void *)mc_data) + block_hdr.addr;\r\nu16 auxtype;\r\nif (block_hdr.addr + sizeof(u16) > size)\r\ngoto eof;\r\nauxtype = be16_to_cpu(*(__be16 *)(auxblk));\r\nif (DRX_ISMCVERTYPE(auxtype)) {\r\nif (block_hdr.addr + 2 * sizeof(u16) + 2 * sizeof (u32) > size)\r\ngoto eof;\r\nauxblk += sizeof(u16);\r\nmc_dev_type = be32_to_cpu(*(__be32 *)(auxblk));\r\nauxblk += sizeof(u32);\r\nmc_version = be32_to_cpu(*(__be32 *)(auxblk));\r\nauxblk += sizeof(u32);\r\nmc_base_version = be32_to_cpu(*(__be32 *)(auxblk));\r\nDRX_ATTR_MCRECORD(demod).aux_type = auxtype;\r\nDRX_ATTR_MCRECORD(demod).mc_dev_type = mc_dev_type;\r\nDRX_ATTR_MCRECORD(demod).mc_version = mc_version;\r\nDRX_ATTR_MCRECORD(demod).mc_base_version = mc_base_version;\r\npr_info("Firmware dev %x, ver %x, base ver %x\n",\r\nmc_dev_type, mc_version, mc_base_version);\r\n}\r\n} else if (count + block_hdr.size * sizeof(u16) > size)\r\ngoto eof;\r\ncount += block_hdr.size * sizeof(u16);\r\n}\r\nreturn 0;\r\neof:\r\npr_err("Firmware is truncated at pos %u/%u\n", count, size);\r\nreturn -EINVAL;\r\n}\r\nstatic int drx_ctrl_u_code(struct drx_demod_instance *demod,\r\nstruct drxu_code_info *mc_info,\r\nenum drxu_code_action action)\r\n{\r\nstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\r\nint rc;\r\nu16 i = 0;\r\nu16 mc_nr_of_blks = 0;\r\nu16 mc_magic_word = 0;\r\nconst u8 *mc_data_init = NULL;\r\nu8 *mc_data = NULL;\r\nunsigned size;\r\nchar *mc_file;\r\nif (!mc_info || !mc_info->mc_file)\r\nreturn -EINVAL;\r\nmc_file = mc_info->mc_file;\r\nif (!demod->firmware) {\r\nconst struct firmware *fw = NULL;\r\nrc = request_firmware(&fw, mc_file, demod->i2c->dev.parent);\r\nif (rc < 0) {\r\npr_err("Couldn't read firmware %s\n", mc_file);\r\nreturn rc;\r\n}\r\ndemod->firmware = fw;\r\nif (demod->firmware->size < 2 * sizeof(u16)) {\r\nrc = -EINVAL;\r\npr_err("Firmware is too short!\n");\r\ngoto release;\r\n}\r\npr_info("Firmware %s, size %zu\n",\r\nmc_file, demod->firmware->size);\r\n}\r\nmc_data_init = demod->firmware->data;\r\nsize = demod->firmware->size;\r\nmc_data = (void *)mc_data_init;\r\nmc_magic_word = be16_to_cpu(*(__be16 *)(mc_data));\r\nmc_data += sizeof(u16);\r\nmc_nr_of_blks = be16_to_cpu(*(__be16 *)(mc_data));\r\nmc_data += sizeof(u16);\r\nif ((mc_magic_word != DRX_UCODE_MAGIC_WORD) || (mc_nr_of_blks == 0)) {\r\nrc = -EINVAL;\r\npr_err("Firmware magic word doesn't match\n");\r\ngoto release;\r\n}\r\nif (action == UCODE_UPLOAD) {\r\nrc = drx_check_firmware(demod, (u8 *)mc_data_init, size);\r\nif (rc)\r\ngoto release;\r\npr_info("Uploading firmware %s\n", mc_file);\r\n} else {\r\npr_info("Verifying if firmware upload was ok.\n");\r\n}\r\nfor (i = 0; i < mc_nr_of_blks; i++) {\r\nstruct drxu_code_block_hdr block_hdr;\r\nu16 mc_block_nr_bytes = 0;\r\nblock_hdr.addr = be32_to_cpu(*(__be32 *)(mc_data));\r\nmc_data += sizeof(u32);\r\nblock_hdr.size = be16_to_cpu(*(__be16 *)(mc_data));\r\nmc_data += sizeof(u16);\r\nblock_hdr.flags = be16_to_cpu(*(__be16 *)(mc_data));\r\nmc_data += sizeof(u16);\r\nblock_hdr.CRC = be16_to_cpu(*(__be16 *)(mc_data));\r\nmc_data += sizeof(u16);\r\npr_debug("%u: addr %u, size %u, flags 0x%04x, CRC 0x%04x\n",\r\n(unsigned)(mc_data - mc_data_init), block_hdr.addr,\r\nblock_hdr.size, block_hdr.flags, block_hdr.CRC);\r\nif ((block_hdr.size > 0x7FFF) ||\r\n(((block_hdr.flags & DRX_UCODE_CRC_FLAG) != 0) &&\r\n(block_hdr.CRC != drx_u_code_compute_crc(mc_data, block_hdr.size)))\r\n) {\r\nrc = -EINVAL;\r\npr_err("firmware CRC is wrong\n");\r\ngoto release;\r\n}\r\nif (!block_hdr.size)\r\ncontinue;\r\nmc_block_nr_bytes = block_hdr.size * ((u16) sizeof(u16));\r\nswitch (action) {\r\ncase UCODE_UPLOAD:\r\nif (drxdap_fasi_write_block(dev_addr,\r\nblock_hdr.addr,\r\nmc_block_nr_bytes,\r\nmc_data, 0x0000)) {\r\nrc = -EIO;\r\npr_err("error writing firmware at pos %u\n",\r\n(unsigned)(mc_data - mc_data_init));\r\ngoto release;\r\n}\r\nbreak;\r\ncase UCODE_VERIFY: {\r\nint result = 0;\r\nu8 mc_data_buffer[DRX_UCODE_MAX_BUF_SIZE];\r\nu32 bytes_to_comp = 0;\r\nu32 bytes_left = mc_block_nr_bytes;\r\nu32 curr_addr = block_hdr.addr;\r\nu8 *curr_ptr = mc_data;\r\nwhile (bytes_left != 0) {\r\nif (bytes_left > DRX_UCODE_MAX_BUF_SIZE)\r\nbytes_to_comp = DRX_UCODE_MAX_BUF_SIZE;\r\nelse\r\nbytes_to_comp = bytes_left;\r\nif (drxdap_fasi_read_block(dev_addr,\r\ncurr_addr,\r\n(u16)bytes_to_comp,\r\n(u8 *)mc_data_buffer,\r\n0x0000)) {\r\npr_err("error reading firmware at pos %u\n",\r\n(unsigned)(mc_data - mc_data_init));\r\nreturn -EIO;\r\n}\r\nresult = memcmp(curr_ptr, mc_data_buffer,\r\nbytes_to_comp);\r\nif (result) {\r\npr_err("error verifying firmware at pos %u\n",\r\n(unsigned)(mc_data - mc_data_init));\r\nreturn -EIO;\r\n}\r\ncurr_addr += ((dr_xaddr_t)(bytes_to_comp / 2));\r\ncurr_ptr =&(curr_ptr[bytes_to_comp]);\r\nbytes_left -=((u32) bytes_to_comp);\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nmc_data += mc_block_nr_bytes;\r\n}\r\nreturn 0;\r\nrelease:\r\nrelease_firmware(demod->firmware);\r\ndemod->firmware = NULL;\r\nreturn rc;\r\n}\r\nstatic int drxj_set_lna_state(struct drx_demod_instance *demod, bool state)\r\n{\r\nstruct drxuio_cfg uio_cfg;\r\nstruct drxuio_data uio_data;\r\nint result;\r\nuio_cfg.uio = DRX_UIO1;\r\nuio_cfg.mode = DRX_UIO_MODE_READWRITE;\r\nresult = ctrl_set_uio_cfg(demod, &uio_cfg);\r\nif (result) {\r\npr_err("Failed to setup LNA GPIO!\n");\r\nreturn result;\r\n}\r\nuio_data.uio = DRX_UIO1;\r\nuio_data.value = state;\r\nresult = ctrl_uio_write(demod, &uio_data);\r\nif (result != 0) {\r\npr_err("Failed to %sable LNA!\n",\r\nstate ? "en" : "dis");\r\nreturn result;\r\n}\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_set_powerstate(struct dvb_frontend *fe, int enable)\r\n{\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nint result;\r\nenum drx_power_mode power_mode;\r\nif (enable)\r\npower_mode = DRX_POWER_UP;\r\nelse\r\npower_mode = DRX_POWER_DOWN;\r\nresult = ctrl_power_mode(demod, &power_mode);\r\nif (result != 0) {\r\npr_err("Power state change failed\n");\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nint result;\r\nenum drx_lock_status lock_status;\r\n*status = 0;\r\nresult = ctrl_lock_status(demod, &lock_status);\r\nif (result != 0) {\r\npr_err("drx39xxj: could not get lock status!\n");\r\n*status = 0;\r\n}\r\nswitch (lock_status) {\r\ncase DRX_NEVER_LOCK:\r\n*status = 0;\r\npr_err("drx says NEVER_LOCK\n");\r\nbreak;\r\ncase DRX_NOT_LOCKED:\r\n*status = 0;\r\nbreak;\r\ncase DRX_LOCK_STATE_1:\r\ncase DRX_LOCK_STATE_2:\r\ncase DRX_LOCK_STATE_3:\r\ncase DRX_LOCK_STATE_4:\r\ncase DRX_LOCK_STATE_5:\r\ncase DRX_LOCK_STATE_6:\r\ncase DRX_LOCK_STATE_7:\r\ncase DRX_LOCK_STATE_8:\r\ncase DRX_LOCK_STATE_9:\r\n*status = FE_HAS_SIGNAL\r\n| FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC;\r\nbreak;\r\ncase DRX_LOCKED:\r\n*status = FE_HAS_SIGNAL\r\n| FE_HAS_CARRIER\r\n| FE_HAS_VITERBI | FE_HAS_SYNC | FE_HAS_LOCK;\r\nbreak;\r\ndefault:\r\npr_err("Lock state unknown %d\n", lock_status);\r\n}\r\nctrl_sig_quality(demod, lock_status);\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nif (p->pre_bit_error.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\r\n*ber = 0;\r\nreturn 0;\r\n}\r\nif (!p->pre_bit_count.stat[0].uvalue) {\r\nif (!p->pre_bit_error.stat[0].uvalue)\r\n*ber = 0;\r\nelse\r\n*ber = 1000000;\r\n} else {\r\n*ber = frac_times1e6(p->pre_bit_error.stat[0].uvalue,\r\np->pre_bit_count.stat[0].uvalue);\r\n}\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_read_signal_strength(struct dvb_frontend *fe,\r\nu16 *strength)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nif (p->strength.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\r\n*strength = 0;\r\nreturn 0;\r\n}\r\n*strength = p->strength.stat[0].uvalue;\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nu64 tmp64;\r\nif (p->cnr.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\r\n*snr = 0;\r\nreturn 0;\r\n}\r\ntmp64 = p->cnr.stat[0].svalue;\r\ndo_div(tmp64, 10);\r\n*snr = tmp64;\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_read_ucblocks(struct dvb_frontend *fe, u32 *ucb)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nif (p->block_error.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\r\n*ucb = 0;\r\nreturn 0;\r\n}\r\n*ucb = p->block_error.stat[0].uvalue;\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_set_frontend(struct dvb_frontend *fe)\r\n{\r\n#ifdef DJH_DEBUG\r\nint i;\r\n#endif\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nenum drx_standard standard = DRX_STANDARD_8VSB;\r\nstruct drx_channel channel;\r\nint result;\r\nstatic const struct drx_channel def_channel = {\r\n0,\r\nDRX_BANDWIDTH_6MHZ,\r\nDRX_MIRROR_NO,\r\nDRX_CONSTELLATION_AUTO,\r\nDRX_HIERARCHY_UNKNOWN,\r\nDRX_PRIORITY_UNKNOWN,\r\nDRX_CODERATE_UNKNOWN,\r\nDRX_GUARD_UNKNOWN,\r\nDRX_FFTMODE_UNKNOWN,\r\nDRX_CLASSIFICATION_AUTO,\r\n5057000,\r\nDRX_INTERLEAVEMODE_UNKNOWN,\r\nDRX_LDPC_UNKNOWN,\r\nDRX_CARRIER_UNKNOWN,\r\nDRX_FRAMEMODE_UNKNOWN\r\n};\r\nu32 constellation = DRX_CONSTELLATION_AUTO;\r\ndrx39xxj_set_powerstate(fe, 1);\r\nif (fe->ops.tuner_ops.set_params) {\r\nu32 int_freq;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.tuner_ops.get_if_frequency) {\r\nfe->ops.tuner_ops.get_if_frequency(fe, &int_freq);\r\ndemod->my_common_attr->intermediate_freq = int_freq / 1000;\r\n}\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\nswitch (p->delivery_system) {\r\ncase SYS_ATSC:\r\nstandard = DRX_STANDARD_8VSB;\r\nbreak;\r\ncase SYS_DVBC_ANNEX_B:\r\nstandard = DRX_STANDARD_ITU_B;\r\nswitch (p->modulation) {\r\ncase QAM_64:\r\nconstellation = DRX_CONSTELLATION_QAM64;\r\nbreak;\r\ncase QAM_256:\r\nconstellation = DRX_CONSTELLATION_QAM256;\r\nbreak;\r\ndefault:\r\nconstellation = DRX_CONSTELLATION_AUTO;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nresult = ctrl_set_standard(demod, &standard);\r\nif (result != 0) {\r\npr_err("Failed to set standard! result=%02x\n",\r\nresult);\r\nreturn -EINVAL;\r\n}\r\nchannel = def_channel;\r\nchannel.frequency = p->frequency / 1000;\r\nchannel.bandwidth = DRX_BANDWIDTH_6MHZ;\r\nchannel.constellation = constellation;\r\nresult = ctrl_set_channel(demod, &channel);\r\nif (result != 0) {\r\npr_err("Failed to set channel!\n");\r\nreturn -EINVAL;\r\n}\r\ndrxj_set_lna_state(demod, false);\r\np->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_sleep(struct dvb_frontend *fe)\r\n{\r\nreturn drx39xxj_set_powerstate(fe, 0);\r\n}\r\nstatic int drx39xxj_i2c_gate_ctrl(struct dvb_frontend *fe, int enable)\r\n{\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nbool i2c_gate_state;\r\nint result;\r\n#ifdef DJH_DEBUG\r\npr_debug("i2c gate call: enable=%d state=%d\n", enable,\r\nstate->i2c_gate_open);\r\n#endif\r\nif (enable)\r\ni2c_gate_state = true;\r\nelse\r\ni2c_gate_state = false;\r\nif (state->i2c_gate_open == enable) {\r\nreturn 0;\r\n}\r\nresult = ctrl_i2c_bridge(demod, &i2c_gate_state);\r\nif (result != 0) {\r\npr_err("drx39xxj: could not open i2c gate [%d]\n",\r\nresult);\r\ndump_stack();\r\n} else {\r\nstate->i2c_gate_open = enable;\r\n}\r\nreturn 0;\r\n}\r\nstatic int drx39xxj_init(struct dvb_frontend *fe)\r\n{\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nint rc = 0;\r\nif (fe->exit == DVB_FE_DEVICE_RESUME) {\r\ndemod->my_common_attr->is_opened = false;\r\nrc = drxj_open(demod);\r\nif (rc != 0)\r\npr_err("drx39xxj_init(): DRX open failed rc=%d!\n", rc);\r\n} else\r\ndrx39xxj_set_powerstate(fe, 1);\r\nreturn rc;\r\n}\r\nstatic int drx39xxj_set_lna(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nstruct drxj_data *ext_attr = demod->my_ext_attr;\r\nif (c->lna) {\r\nif (!ext_attr->has_lna) {\r\npr_err("LNA is not supported on this device!\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn drxj_set_lna_state(demod, c->lna);\r\n}\r\nstatic int drx39xxj_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings *tune)\r\n{\r\ntune->min_delay_ms = 1000;\r\nreturn 0;\r\n}\r\nstatic void drx39xxj_release(struct dvb_frontend *fe)\r\n{\r\nstruct drx39xxj_state *state = fe->demodulator_priv;\r\nstruct drx_demod_instance *demod = state->demod;\r\nif (fe->exit != DVB_FE_DEVICE_REMOVED)\r\ndrxj_close(demod);\r\nkfree(demod->my_ext_attr);\r\nkfree(demod->my_common_attr);\r\nkfree(demod->my_i2c_dev_addr);\r\nrelease_firmware(demod->firmware);\r\nkfree(demod);\r\nkfree(state);\r\n}\r\nstruct dvb_frontend *drx39xxj_attach(struct i2c_adapter *i2c)\r\n{\r\nstruct drx39xxj_state *state = NULL;\r\nstruct i2c_device_addr *demod_addr = NULL;\r\nstruct drx_common_attr *demod_comm_attr = NULL;\r\nstruct drxj_data *demod_ext_attr = NULL;\r\nstruct drx_demod_instance *demod = NULL;\r\nstruct dtv_frontend_properties *p;\r\nint result;\r\nstate = kzalloc(sizeof(struct drx39xxj_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\ndemod = kmalloc(sizeof(struct drx_demod_instance), GFP_KERNEL);\r\nif (demod == NULL)\r\ngoto error;\r\ndemod_addr = kmemdup(&drxj_default_addr_g,\r\nsizeof(struct i2c_device_addr), GFP_KERNEL);\r\nif (demod_addr == NULL)\r\ngoto error;\r\ndemod_comm_attr = kmemdup(&drxj_default_comm_attr_g,\r\nsizeof(struct drx_common_attr), GFP_KERNEL);\r\nif (demod_comm_attr == NULL)\r\ngoto error;\r\ndemod_ext_attr = kmemdup(&drxj_data_g, sizeof(struct drxj_data),\r\nGFP_KERNEL);\r\nif (demod_ext_attr == NULL)\r\ngoto error;\r\nstate->i2c = i2c;\r\nstate->demod = demod;\r\nmemcpy(demod, &drxj_default_demod_g, sizeof(struct drx_demod_instance));\r\ndemod->my_i2c_dev_addr = demod_addr;\r\ndemod->my_common_attr = demod_comm_attr;\r\ndemod->my_i2c_dev_addr->user_data = state;\r\ndemod->my_common_attr->microcode_file = DRX39XX_MAIN_FIRMWARE;\r\ndemod->my_common_attr->verify_microcode = true;\r\ndemod->my_common_attr->intermediate_freq = 5000;\r\ndemod->my_common_attr->current_power_mode = DRX_POWER_DOWN;\r\ndemod->my_ext_attr = demod_ext_attr;\r\n((struct drxj_data *)demod_ext_attr)->uio_sma_tx_mode = DRX_UIO_MODE_READWRITE;\r\ndemod->i2c = i2c;\r\nresult = drxj_open(demod);\r\nif (result != 0) {\r\npr_err("DRX open failed! Aborting\n");\r\ngoto error;\r\n}\r\nmemcpy(&state->frontend.ops, &drx39xxj_ops,\r\nsizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\np = &state->frontend.dtv_property_cache;\r\np->strength.len = 1;\r\np->pre_bit_count.len = 1;\r\np->pre_bit_error.len = 1;\r\np->post_bit_count.len = 1;\r\np->post_bit_error.len = 1;\r\np->block_count.len = 1;\r\np->block_error.len = 1;\r\np->cnr.len = 1;\r\np->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\np->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nreturn &state->frontend;\r\nerror:\r\nkfree(demod_ext_attr);\r\nkfree(demod_comm_attr);\r\nkfree(demod_addr);\r\nkfree(demod);\r\nkfree(state);\r\nreturn NULL;\r\n}

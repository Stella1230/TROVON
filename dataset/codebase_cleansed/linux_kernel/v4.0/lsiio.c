static inline int check_prefix(const char *str, const char *prefix)\r\n{\r\nreturn strlen(str) > strlen(prefix) &&\r\nstrncmp(str, prefix, strlen(prefix)) == 0;\r\n}\r\nstatic inline int check_postfix(const char *str, const char *postfix)\r\n{\r\nreturn strlen(str) > strlen(postfix) &&\r\nstrcmp(str + strlen(str) - strlen(postfix), postfix) == 0;\r\n}\r\nstatic int dump_channels(const char *dev_dir_name)\r\n{\r\nDIR *dp;\r\nconst struct dirent *ent;\r\ndp = opendir(dev_dir_name);\r\nif (dp == NULL)\r\nreturn -errno;\r\nwhile (ent = readdir(dp), ent != NULL)\r\nif (check_prefix(ent->d_name, "in_") &&\r\ncheck_postfix(ent->d_name, "_raw")) {\r\nprintf(" %-10s\n", ent->d_name);\r\n}\r\nreturn 0;\r\n}\r\nstatic int dump_one_device(const char *dev_dir_name)\r\n{\r\nchar name[IIO_MAX_NAME_LENGTH];\r\nint dev_idx;\r\nint retval;\r\nretval = sscanf(dev_dir_name + strlen(iio_dir) + strlen(type_device),\r\n"%i", &dev_idx);\r\nif (retval != 1)\r\nreturn -EINVAL;\r\nread_sysfs_string("name", dev_dir_name, name);\r\nprintf("Device %03d: %s\n", dev_idx, name);\r\nif (verblevel >= VERBLEVEL_SENSORS)\r\nreturn dump_channels(dev_dir_name);\r\nreturn 0;\r\n}\r\nstatic int dump_one_trigger(const char *dev_dir_name)\r\n{\r\nchar name[IIO_MAX_NAME_LENGTH];\r\nint dev_idx;\r\nint retval;\r\nretval = sscanf(dev_dir_name + strlen(iio_dir) + strlen(type_trigger),\r\n"%i", &dev_idx);\r\nif (retval != 1)\r\nreturn -EINVAL;\r\nread_sysfs_string("name", dev_dir_name, name);\r\nprintf("Trigger %03d: %s\n", dev_idx, name);\r\nreturn 0;\r\n}\r\nstatic void dump_devices(void)\r\n{\r\nconst struct dirent *ent;\r\nint number, numstrlen;\r\nFILE *nameFile;\r\nDIR *dp;\r\nchar thisname[IIO_MAX_NAME_LENGTH];\r\nchar *filename;\r\ndp = opendir(iio_dir);\r\nif (dp == NULL) {\r\nprintf("No industrial I/O devices available\n");\r\nreturn;\r\n}\r\nwhile (ent = readdir(dp), ent != NULL) {\r\nif (check_prefix(ent->d_name, type_device)) {\r\nchar *dev_dir_name;\r\nasprintf(&dev_dir_name, "%s%s", iio_dir, ent->d_name);\r\ndump_one_device(dev_dir_name);\r\nfree(dev_dir_name);\r\nif (verblevel >= VERBLEVEL_SENSORS)\r\nprintf("\n");\r\n}\r\n}\r\nrewinddir(dp);\r\nwhile (ent = readdir(dp), ent != NULL) {\r\nif (check_prefix(ent->d_name, type_trigger)) {\r\nchar *dev_dir_name;\r\nasprintf(&dev_dir_name, "%s%s", iio_dir, ent->d_name);\r\ndump_one_trigger(dev_dir_name);\r\nfree(dev_dir_name);\r\n}\r\n}\r\nclosedir(dp);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint c, err = 0;\r\nwhile ((c = getopt(argc, argv, "d:D:v")) != EOF) {\r\nswitch (c) {\r\ncase 'v':\r\nverblevel++;\r\nbreak;\r\ncase '?':\r\ndefault:\r\nerr++;\r\nbreak;\r\n}\r\n}\r\nif (err || argc > optind) {\r\nfprintf(stderr, "Usage: lsiio [options]...\n"\r\n"List industrial I/O devices\n"\r\n" -v, --verbose\n"\r\n" Increase verbosity (may be given multiple times)\n"\r\n);\r\nexit(1);\r\n}\r\ndump_devices();\r\nreturn 0;\r\n}

int slip_proto_read(int fd, void *buf, int len, struct slip_proto *slip)\r\n{\r\nint i, n, size, start;\r\nif(slip->more > 0){\r\ni = 0;\r\nwhile(i < slip->more){\r\nsize = slip_unesc(slip->ibuf[i++], slip->ibuf,\r\n&slip->pos, &slip->esc);\r\nif(size){\r\nmemcpy(buf, slip->ibuf, size);\r\nmemmove(slip->ibuf, &slip->ibuf[i],\r\nslip->more - i);\r\nslip->more = slip->more - i;\r\nreturn size;\r\n}\r\n}\r\nslip->more = 0;\r\n}\r\nn = net_read(fd, &slip->ibuf[slip->pos],\r\nsizeof(slip->ibuf) - slip->pos);\r\nif(n <= 0)\r\nreturn n;\r\nstart = slip->pos;\r\nfor(i = 0; i < n; i++){\r\nsize = slip_unesc(slip->ibuf[start + i], slip->ibuf,&slip->pos,\r\n&slip->esc);\r\nif(size){\r\nmemcpy(buf, slip->ibuf, size);\r\nmemmove(slip->ibuf, &slip->ibuf[start+i+1],\r\nn - (i + 1));\r\nslip->more = n - (i + 1);\r\nreturn size;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint slip_proto_write(int fd, void *buf, int len, struct slip_proto *slip)\r\n{\r\nint actual, n;\r\nactual = slip_esc(buf, slip->obuf, len);\r\nn = net_write(fd, slip->obuf, actual);\r\nif(n < 0)\r\nreturn n;\r\nelse return len;\r\n}

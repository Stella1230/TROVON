static void xlp2xx_usb_ack(struct irq_data *data)\r\n{\r\nu64 port_addr;\r\nswitch (data->irq) {\r\ncase PIC_2XX_XHCI_0_IRQ:\r\nport_addr = nlm_xlpii_get_usb_regbase(0, 1);\r\nbreak;\r\ncase PIC_2XX_XHCI_1_IRQ:\r\nport_addr = nlm_xlpii_get_usb_regbase(0, 2);\r\nbreak;\r\ncase PIC_2XX_XHCI_2_IRQ:\r\nport_addr = nlm_xlpii_get_usb_regbase(0, 3);\r\nbreak;\r\ndefault:\r\npr_err("No matching USB irq!\n");\r\nreturn;\r\n}\r\nnlm_write_usb_reg(port_addr, XLPII_USB3_INT_REG, 0xffffffff);\r\n}\r\nstatic void xlp9xx_usb_ack(struct irq_data *data)\r\n{\r\nu64 port_addr;\r\nint node, irq;\r\nirq = data->irq % NLM_IRQS_PER_NODE;\r\nnode = data->irq / NLM_IRQS_PER_NODE;\r\nswitch (irq) {\r\ncase PIC_9XX_XHCI_0_IRQ:\r\nport_addr = nlm_xlpii_get_usb_regbase(node, 1);\r\nbreak;\r\ncase PIC_9XX_XHCI_1_IRQ:\r\nport_addr = nlm_xlpii_get_usb_regbase(node, 2);\r\nbreak;\r\ndefault:\r\npr_err("No matching USB irq %d node %d!\n", irq, node);\r\nreturn;\r\n}\r\nnlm_write_usb_reg(port_addr, XLPII_USB3_INT_REG, 0xffffffff);\r\n}\r\nstatic void nlm_xlpii_usb_hw_reset(int node, int port)\r\n{\r\nu64 port_addr, xhci_base, pci_base;\r\nvoid __iomem *corebase;\r\nu32 val;\r\nport_addr = nlm_xlpii_get_usb_regbase(node, port);\r\nval = nlm_read_usb_reg(port_addr, XLPII_USB_PHY_LOS_LV);\r\nval &= ~(0x3f << XLPII_FSEL);\r\nval |= (0x27 << XLPII_FSEL);\r\nnlm_write_usb_reg(port_addr, XLPII_USB_PHY_LOS_LV, val);\r\nval = nlm_read_usb_reg(port_addr, XLPII_USB_RFCLK_REG);\r\nval |= (1 << XLPII_VVLD);\r\nnlm_write_usb_reg(port_addr, XLPII_USB_RFCLK_REG, val);\r\nval = nlm_read_usb_reg(port_addr, XLPII_USB_PHY_TEST);\r\nval &= (XLPII_ATERESET | XLPII_LOOPEN | XLPII_TESTPDHSP\r\n| XLPII_TESTPDSSP | XLPII_TESTBURNIN);\r\nnlm_write_usb_reg(port_addr, XLPII_USB_PHY_TEST, val);\r\nval = XLPII_VAUXRST | XLPII_VCCRST | (1 << XLPII_NUM2PORT)\r\n| (1 << XLPII_NUM3PORT) | XLPII_MS_CSYSREQ | XLPII_XS_CSYSREQ\r\n| XLPII_RETENABLEN | XLPII_XHCIREV;\r\nnlm_write_usb_reg(port_addr, XLPII_USB3_CTL_0, val);\r\nnlm_write_usb_reg(port_addr, XLPII_USB3_INT_MASK, 0x00000001);\r\nnlm_write_usb_reg(port_addr, XLPII_USB3_INT_REG, 0xffffffff);\r\nudelay(2000);\r\npci_base = nlm_xlpii_get_usb_pcibase(node, port);\r\nxhci_base = nlm_read_usb_reg(pci_base, 0x4) & ~0xf;\r\ncorebase = ioremap(xhci_base, 0x10000);\r\nif (!corebase)\r\nreturn;\r\nwritel(0x240002, corebase + 0xc2c0);\r\nval = readl(corebase + 0xc110);\r\nval &= ~(0x3 << 12);\r\nval |= (1 << 12);\r\nwritel(val, corebase + 0xc110);\r\nudelay(100);\r\nval = readl(corebase + 0xc200);\r\nval &= ~(1 << 6);\r\nwritel(val, corebase + 0xc200);\r\nudelay(100);\r\nval = readl(corebase + 0xc2c0);\r\nval &= ~(1 << 17);\r\nwritel(val, corebase + 0xc2c0);\r\niounmap(corebase);\r\n}\r\nstatic int __init nlm_platform_xlpii_usb_init(void)\r\n{\r\nint node;\r\nif (!cpu_is_xlpii())\r\nreturn 0;\r\nif (!cpu_is_xlp9xx()) {\r\npr_info("Initializing 2XX USB Interface\n");\r\nnlm_xlpii_usb_hw_reset(0, 1);\r\nnlm_xlpii_usb_hw_reset(0, 2);\r\nnlm_xlpii_usb_hw_reset(0, 3);\r\nnlm_set_pic_extra_ack(0, PIC_2XX_XHCI_0_IRQ, xlp2xx_usb_ack);\r\nnlm_set_pic_extra_ack(0, PIC_2XX_XHCI_1_IRQ, xlp2xx_usb_ack);\r\nnlm_set_pic_extra_ack(0, PIC_2XX_XHCI_2_IRQ, xlp2xx_usb_ack);\r\nreturn 0;\r\n}\r\npr_info("Initializing 9XX USB Interface\n");\r\nfor (node = 0; node < NLM_NR_NODES; node++) {\r\nif (!nlm_node_present(node))\r\ncontinue;\r\nnlm_xlpii_usb_hw_reset(node, 1);\r\nnlm_xlpii_usb_hw_reset(node, 2);\r\nnlm_set_pic_extra_ack(node, PIC_9XX_XHCI_0_IRQ, xlp9xx_usb_ack);\r\nnlm_set_pic_extra_ack(node, PIC_9XX_XHCI_1_IRQ, xlp9xx_usb_ack);\r\n}\r\nreturn 0;\r\n}\r\nstatic void nlm_xlp9xx_usb_fixup_final(struct pci_dev *dev)\r\n{\r\nint node;\r\nnode = xlp_socdev_to_node(dev);\r\ndev->dev.dma_mask = &xlp_usb_dmamask;\r\ndev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\nswitch (dev->devfn) {\r\ncase 0x21:\r\ndev->irq = nlm_irq_to_xirq(node, PIC_9XX_XHCI_0_IRQ);\r\nbreak;\r\ncase 0x22:\r\ndev->irq = nlm_irq_to_xirq(node, PIC_9XX_XHCI_1_IRQ);\r\nbreak;\r\n}\r\n}\r\nstatic void nlm_xlp2xx_usb_fixup_final(struct pci_dev *dev)\r\n{\r\ndev->dev.dma_mask = &xlp_usb_dmamask;\r\ndev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\nswitch (dev->devfn) {\r\ncase 0x21:\r\ndev->irq = PIC_2XX_XHCI_0_IRQ;\r\nbreak;\r\ncase 0x22:\r\ndev->irq = PIC_2XX_XHCI_1_IRQ;\r\nbreak;\r\ncase 0x23:\r\ndev->irq = PIC_2XX_XHCI_2_IRQ;\r\nbreak;\r\n}\r\n}

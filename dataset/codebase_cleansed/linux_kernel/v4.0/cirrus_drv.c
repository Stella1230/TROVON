static int cirrus_kick_out_firmware_fb(struct pci_dev *pdev)\r\n{\r\nstruct apertures_struct *ap;\r\nbool primary = false;\r\nap = alloc_apertures(1);\r\nif (!ap)\r\nreturn -ENOMEM;\r\nap->ranges[0].base = pci_resource_start(pdev, 0);\r\nap->ranges[0].size = pci_resource_len(pdev, 0);\r\n#ifdef CONFIG_X86\r\nprimary = pdev->resource[PCI_ROM_RESOURCE].flags & IORESOURCE_ROM_SHADOW;\r\n#endif\r\nremove_conflicting_framebuffers(ap, "cirrusdrmfb", primary);\r\nkfree(ap);\r\nreturn 0;\r\n}\r\nstatic int cirrus_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint ret;\r\nret = cirrus_kick_out_firmware_fb(pdev);\r\nif (ret)\r\nreturn ret;\r\nreturn drm_get_pci_dev(pdev, ent, &driver);\r\n}\r\nstatic void cirrus_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\ndrm_put_dev(dev);\r\n}\r\nstatic int cirrus_pm_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *drm_dev = pci_get_drvdata(pdev);\r\nstruct cirrus_device *cdev = drm_dev->dev_private;\r\ndrm_kms_helper_poll_disable(drm_dev);\r\nif (cdev->mode_info.gfbdev) {\r\nconsole_lock();\r\nfb_set_suspend(cdev->mode_info.gfbdev->helper.fbdev, 1);\r\nconsole_unlock();\r\n}\r\nreturn 0;\r\n}\r\nstatic int cirrus_pm_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *drm_dev = pci_get_drvdata(pdev);\r\nstruct cirrus_device *cdev = drm_dev->dev_private;\r\ndrm_helper_resume_force_mode(drm_dev);\r\nif (cdev->mode_info.gfbdev) {\r\nconsole_lock();\r\nfb_set_suspend(cdev->mode_info.gfbdev->helper.fbdev, 0);\r\nconsole_unlock();\r\n}\r\ndrm_kms_helper_poll_enable(drm_dev);\r\nreturn 0;\r\n}\r\nstatic int __init cirrus_init(void)\r\n{\r\n#ifdef CONFIG_VGA_CONSOLE\r\nif (vgacon_text_force() && cirrus_modeset == -1)\r\nreturn -EINVAL;\r\n#endif\r\nif (cirrus_modeset == 0)\r\nreturn -EINVAL;\r\nreturn drm_pci_init(&driver, &cirrus_pci_driver);\r\n}\r\nstatic void __exit cirrus_exit(void)\r\n{\r\ndrm_pci_exit(&driver, &cirrus_pci_driver);\r\n}

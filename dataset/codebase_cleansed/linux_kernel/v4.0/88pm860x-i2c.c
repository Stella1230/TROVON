int pm860x_reg_read(struct i2c_client *i2c, int reg)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nstruct regmap *map = (i2c == chip->client) ? chip->regmap\r\n: chip->regmap_companion;\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(map, reg, &data);\r\nif (ret < 0)\r\nreturn ret;\r\nelse\r\nreturn (int)data;\r\n}\r\nint pm860x_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nstruct regmap *map = (i2c == chip->client) ? chip->regmap\r\n: chip->regmap_companion;\r\nint ret;\r\nret = regmap_write(map, reg, data);\r\nreturn ret;\r\n}\r\nint pm860x_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nstruct regmap *map = (i2c == chip->client) ? chip->regmap\r\n: chip->regmap_companion;\r\nint ret;\r\nret = regmap_raw_read(map, reg, buf, count);\r\nreturn ret;\r\n}\r\nint pm860x_bulk_write(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nstruct regmap *map = (i2c == chip->client) ? chip->regmap\r\n: chip->regmap_companion;\r\nint ret;\r\nret = regmap_raw_write(map, reg, buf, count);\r\nreturn ret;\r\n}\r\nint pm860x_set_bits(struct i2c_client *i2c, int reg,\r\nunsigned char mask, unsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nstruct regmap *map = (i2c == chip->client) ? chip->regmap\r\n: chip->regmap_companion;\r\nint ret;\r\nret = regmap_update_bits(map, reg, mask, data);\r\nreturn ret;\r\n}\r\nstatic int read_device(struct i2c_client *i2c, int reg,\r\nint bytes, void *dest)\r\n{\r\nunsigned char msgbuf0[I2C_SMBUS_BLOCK_MAX + 3];\r\nunsigned char msgbuf1[I2C_SMBUS_BLOCK_MAX + 2];\r\nstruct i2c_adapter *adap = i2c->adapter;\r\nstruct i2c_msg msg[2] = {\r\n{\r\n.addr = i2c->addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = msgbuf0\r\n},\r\n{ .addr = i2c->addr,\r\n.flags = I2C_M_RD,\r\n.len = 0,\r\n.buf = msgbuf1\r\n},\r\n};\r\nint num = 1, ret = 0;\r\nif (dest == NULL)\r\nreturn -EINVAL;\r\nmsgbuf0[0] = (unsigned char)reg;\r\nmsg[1].len = bytes;\r\nif (bytes > 0)\r\nnum = 2;\r\nret = adap->algo->master_xfer(adap, msg, num);\r\nmemcpy(dest, msgbuf1, bytes);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int write_device(struct i2c_client *i2c, int reg,\r\nint bytes, void *src)\r\n{\r\nunsigned char buf[2];\r\nstruct i2c_adapter *adap = i2c->adapter;\r\nstruct i2c_msg msg;\r\nint ret;\r\nbuf[0] = (unsigned char)reg;\r\nmemcpy(&buf[1], src, bytes);\r\nmsg.addr = i2c->addr;\r\nmsg.flags = 0;\r\nmsg.len = bytes + 1;\r\nmsg.buf = buf;\r\nret = adap->algo->master_xfer(adap, &msg, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint pm860x_page_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nunsigned char zero;\r\nint ret;\r\ni2c_lock_adapter(i2c->adapter);\r\nread_device(i2c, 0xFA, 0, &zero);\r\nread_device(i2c, 0xFB, 0, &zero);\r\nread_device(i2c, 0xFF, 0, &zero);\r\nret = write_device(i2c, reg, 1, &data);\r\nread_device(i2c, 0xFE, 0, &zero);\r\nread_device(i2c, 0xFC, 0, &zero);\r\ni2c_unlock_adapter(i2c->adapter);\r\nreturn ret;\r\n}\r\nint pm860x_page_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nunsigned char zero = 0;\r\nint ret;\r\ni2c_lock_adapter(i2c->adapter);\r\nread_device(i2c, 0xfa, 0, &zero);\r\nread_device(i2c, 0xfb, 0, &zero);\r\nread_device(i2c, 0xff, 0, &zero);\r\nret = read_device(i2c, reg, count, buf);\r\nread_device(i2c, 0xFE, 0, &zero);\r\nread_device(i2c, 0xFC, 0, &zero);\r\ni2c_unlock_adapter(i2c->adapter);\r\nreturn ret;\r\n}

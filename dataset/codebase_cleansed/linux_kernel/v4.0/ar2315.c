static inline u32 ar2315_rst_reg_read(u32 reg)\r\n{\r\nreturn __raw_readl(ar2315_rst_base + reg);\r\n}\r\nstatic inline void ar2315_rst_reg_write(u32 reg, u32 val)\r\n{\r\n__raw_writel(val, ar2315_rst_base + reg);\r\n}\r\nstatic inline void ar2315_rst_reg_mask(u32 reg, u32 mask, u32 val)\r\n{\r\nu32 ret = ar2315_rst_reg_read(reg);\r\nret &= ~mask;\r\nret |= val;\r\nar2315_rst_reg_write(reg, ret);\r\n}\r\nstatic irqreturn_t ar2315_ahb_err_handler(int cpl, void *dev_id)\r\n{\r\nar2315_rst_reg_write(AR2315_AHB_ERR0, AR2315_AHB_ERROR_DET);\r\nar2315_rst_reg_read(AR2315_AHB_ERR1);\r\npr_emerg("AHB fatal error\n");\r\nmachine_restart("AHB error");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ar2315_misc_irq_handler(unsigned irq, struct irq_desc *desc)\r\n{\r\nu32 pending = ar2315_rst_reg_read(AR2315_ISR) &\r\nar2315_rst_reg_read(AR2315_IMR);\r\nunsigned nr, misc_irq = 0;\r\nif (pending) {\r\nstruct irq_domain *domain = irq_get_handler_data(irq);\r\nnr = __ffs(pending);\r\nmisc_irq = irq_find_mapping(domain, nr);\r\n}\r\nif (misc_irq) {\r\nif (nr == AR2315_MISC_IRQ_GPIO)\r\nar2315_rst_reg_write(AR2315_ISR, AR2315_ISR_GPIO);\r\nelse if (nr == AR2315_MISC_IRQ_WATCHDOG)\r\nar2315_rst_reg_write(AR2315_ISR, AR2315_ISR_WD);\r\ngeneric_handle_irq(misc_irq);\r\n} else {\r\nspurious_interrupt();\r\n}\r\n}\r\nstatic void ar2315_misc_irq_unmask(struct irq_data *d)\r\n{\r\nar2315_rst_reg_mask(AR2315_IMR, 0, BIT(d->hwirq));\r\n}\r\nstatic void ar2315_misc_irq_mask(struct irq_data *d)\r\n{\r\nar2315_rst_reg_mask(AR2315_IMR, BIT(d->hwirq), 0);\r\n}\r\nstatic int ar2315_misc_irq_map(struct irq_domain *d, unsigned irq,\r\nirq_hw_number_t hw)\r\n{\r\nirq_set_chip_and_handler(irq, &ar2315_misc_irq_chip, handle_level_irq);\r\nreturn 0;\r\n}\r\nstatic void ar2315_irq_dispatch(void)\r\n{\r\nu32 pending = read_c0_status() & read_c0_cause();\r\nif (pending & CAUSEF_IP3)\r\ndo_IRQ(AR2315_IRQ_WLAN0);\r\n#ifdef CONFIG_PCI_AR2315\r\nelse if (pending & CAUSEF_IP5)\r\ndo_IRQ(AR2315_IRQ_LCBUS_PCI);\r\n#endif\r\nelse if (pending & CAUSEF_IP2)\r\ndo_IRQ(AR2315_IRQ_MISC);\r\nelse if (pending & CAUSEF_IP7)\r\ndo_IRQ(ATH25_IRQ_CPU_CLOCK);\r\nelse\r\nspurious_interrupt();\r\n}\r\nvoid __init ar2315_arch_init_irq(void)\r\n{\r\nstruct irq_domain *domain;\r\nunsigned irq;\r\nath25_irq_dispatch = ar2315_irq_dispatch;\r\ndomain = irq_domain_add_linear(NULL, AR2315_MISC_IRQ_COUNT,\r\n&ar2315_misc_irq_domain_ops, NULL);\r\nif (!domain)\r\npanic("Failed to add IRQ domain");\r\nirq = irq_create_mapping(domain, AR2315_MISC_IRQ_AHB);\r\nsetup_irq(irq, &ar2315_ahb_err_interrupt);\r\nirq_set_chained_handler(AR2315_IRQ_MISC, ar2315_misc_irq_handler);\r\nirq_set_handler_data(AR2315_IRQ_MISC, domain);\r\nar2315_misc_irq_domain = domain;\r\n}\r\nvoid __init ar2315_init_devices(void)\r\n{\r\nath25_find_config(AR2315_SPI_READ_BASE, AR2315_SPI_READ_SIZE);\r\nath25_add_wmac(0, AR2315_WLAN0_BASE, AR2315_IRQ_WLAN0);\r\n}\r\nstatic void ar2315_restart(char *command)\r\n{\r\nvoid (*mips_reset_vec)(void) = (void *)0xbfc00000;\r\nlocal_irq_disable();\r\nar2315_rst_reg_write(AR2315_COLD_RESET, AR2317_RESET_SYSTEM);\r\nmips_reset_vec();\r\n}\r\nstatic unsigned __init ar2315_sys_clk(u32 clock_ctl)\r\n{\r\nunsigned int pllc_ctrl, cpu_div;\r\nunsigned int pllc_out, refdiv, fdiv, divby2;\r\nunsigned int clk_div;\r\npllc_ctrl = ar2315_rst_reg_read(AR2315_PLLC_CTL);\r\nrefdiv = ATH25_REG_MS(pllc_ctrl, AR2315_PLLC_REF_DIV);\r\nrefdiv = clockctl1_predivide_table[refdiv];\r\nfdiv = ATH25_REG_MS(pllc_ctrl, AR2315_PLLC_FDBACK_DIV);\r\ndivby2 = ATH25_REG_MS(pllc_ctrl, AR2315_PLLC_ADD_FDBACK_DIV) + 1;\r\npllc_out = (40000000 / refdiv) * (2 * divby2) * fdiv;\r\nswitch (clock_ctl & AR2315_CPUCLK_CLK_SEL_M) {\r\ncase 0:\r\ncase 1:\r\nclk_div = ATH25_REG_MS(pllc_ctrl, AR2315_PLLC_CLKM_DIV);\r\nclk_div = pllc_divide_table[clk_div];\r\nbreak;\r\ncase 2:\r\nclk_div = ATH25_REG_MS(pllc_ctrl, AR2315_PLLC_CLKC_DIV);\r\nclk_div = pllc_divide_table[clk_div];\r\nbreak;\r\ndefault:\r\npllc_out = 40000000;\r\nclk_div = 1;\r\nbreak;\r\n}\r\ncpu_div = ATH25_REG_MS(clock_ctl, AR2315_CPUCLK_CLK_DIV);\r\ncpu_div = cpu_div * 2 ?: 1;\r\nreturn pllc_out / (clk_div * cpu_div);\r\n}\r\nstatic inline unsigned ar2315_cpu_frequency(void)\r\n{\r\nreturn ar2315_sys_clk(ar2315_rst_reg_read(AR2315_CPUCLK));\r\n}\r\nstatic inline unsigned ar2315_apb_frequency(void)\r\n{\r\nreturn ar2315_sys_clk(ar2315_rst_reg_read(AR2315_AMBACLK));\r\n}\r\nvoid __init ar2315_plat_time_init(void)\r\n{\r\nmips_hpt_frequency = ar2315_cpu_frequency() / 2;\r\n}\r\nvoid __init ar2315_plat_mem_setup(void)\r\n{\r\nvoid __iomem *sdram_base;\r\nu32 memsize, memcfg;\r\nu32 devid;\r\nu32 config;\r\nsdram_base = ioremap_nocache(AR2315_SDRAMCTL_BASE,\r\nAR2315_SDRAMCTL_SIZE);\r\nmemcfg = __raw_readl(sdram_base + AR2315_MEM_CFG);\r\nmemsize = 1 + ATH25_REG_MS(memcfg, AR2315_MEM_CFG_DATA_WIDTH);\r\nmemsize <<= 1 + ATH25_REG_MS(memcfg, AR2315_MEM_CFG_COL_WIDTH);\r\nmemsize <<= 1 + ATH25_REG_MS(memcfg, AR2315_MEM_CFG_ROW_WIDTH);\r\nmemsize <<= 3;\r\nadd_memory_region(0, memsize, BOOT_MEM_RAM);\r\niounmap(sdram_base);\r\nar2315_rst_base = ioremap_nocache(AR2315_RST_BASE, AR2315_RST_SIZE);\r\ndevid = ar2315_rst_reg_read(AR2315_SREV) & AR2315_REV_CHIP;\r\nswitch (devid) {\r\ncase 0x91:\r\nath25_soc = ATH25_SOC_AR2318;\r\nbreak;\r\ncase 0x90:\r\nath25_soc = ATH25_SOC_AR2317;\r\nbreak;\r\ncase 0x87:\r\nath25_soc = ATH25_SOC_AR2316;\r\nbreak;\r\ncase 0x86:\r\ndefault:\r\nath25_soc = ATH25_SOC_AR2315;\r\nbreak;\r\n}\r\nath25_board.devid = devid;\r\nconfig = read_c0_config();\r\nwrite_c0_config(config & ~0x3);\r\nar2315_rst_reg_write(AR2315_AHB_ERR0, AR2315_AHB_ERROR_DET);\r\nar2315_rst_reg_read(AR2315_AHB_ERR1);\r\nar2315_rst_reg_write(AR2315_WDT_CTRL, AR2315_WDT_CTRL_IGNORE);\r\n_machine_restart = ar2315_restart;\r\n}\r\nvoid __init ar2315_arch_init(void)\r\n{\r\nunsigned irq = irq_create_mapping(ar2315_misc_irq_domain,\r\nAR2315_MISC_IRQ_UART0);\r\nath25_serial_setup(AR2315_UART0_BASE, irq, ar2315_apb_frequency());\r\n#ifdef CONFIG_PCI_AR2315\r\nif (ath25_soc == ATH25_SOC_AR2315) {\r\nar2315_rst_reg_mask(AR2315_RESET, 0, AR2315_RESET_PCIDMA);\r\nmsleep(20);\r\nar2315_rst_reg_mask(AR2315_RESET, AR2315_RESET_PCIDMA, 0);\r\nmsleep(20);\r\nar2315_rst_reg_mask(AR2315_ENDIAN_CTL, 0, AR2315_CONFIG_PCIAHB |\r\nAR2315_CONFIG_PCIAHB_BRIDGE);\r\nar2315_rst_reg_write(AR2315_PCICLK, AR2315_PCICLK_PLLC_CLKM |\r\n(AR2315_PCICLK_IN_FREQ_DIV_6 <<\r\nAR2315_PCICLK_DIV_S));\r\nar2315_rst_reg_mask(AR2315_AHB_ARB_CTL, 0, AR2315_ARB_PCI);\r\nar2315_rst_reg_mask(AR2315_IF_CTL, AR2315_IF_PCI_CLK_MASK |\r\nAR2315_IF_MASK, AR2315_IF_PCI |\r\nAR2315_IF_PCI_HOST | AR2315_IF_PCI_INTR |\r\n(AR2315_IF_PCI_CLK_OUTPUT_CLK <<\r\nAR2315_IF_PCI_CLK_SHIFT));\r\nplatform_device_register_simple("ar2315-pci", -1,\r\nar2315_pci_res,\r\nARRAY_SIZE(ar2315_pci_res));\r\n}\r\n#endif\r\n}

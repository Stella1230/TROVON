int opal_get_sensor_data(u32 sensor_hndl, u32 *sensor_data)\r\n{\r\nint ret, token;\r\nstruct opal_msg msg;\r\n__be32 data;\r\ntoken = opal_async_get_token_interruptible();\r\nif (token < 0) {\r\npr_err("%s: Couldn't get the token, returning\n", __func__);\r\nret = token;\r\ngoto out;\r\n}\r\nmutex_lock(&opal_sensor_mutex);\r\nret = opal_sensor_read(sensor_hndl, token, &data);\r\nif (ret != OPAL_ASYNC_COMPLETION)\r\ngoto out_token;\r\nret = opal_async_wait_response(token, &msg);\r\nif (ret) {\r\npr_err("%s: Failed to wait for the async response, %d\n",\r\n__func__, ret);\r\ngoto out_token;\r\n}\r\n*sensor_data = be32_to_cpu(data);\r\nret = be64_to_cpu(msg.params[1]);\r\nout_token:\r\nmutex_unlock(&opal_sensor_mutex);\r\nopal_async_release_token(token);\r\nout:\r\nreturn ret;\r\n}\r\nstatic __init int opal_sensor_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nstruct device_node *sensor;\r\nsensor = of_find_node_by_path("/ibm,opal/sensors");\r\nif (!sensor) {\r\npr_err("Opal node 'sensors' not found\n");\r\nreturn -ENODEV;\r\n}\r\npdev = of_platform_device_create(sensor, "opal-sensor", NULL);\r\nof_node_put(sensor);\r\nreturn PTR_ERR_OR_ZERO(pdev);\r\n}

void mi2020_init_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->vcur.backlight = 0;\r\nsd->vcur.brightness = 70;\r\nsd->vcur.sharpness = 20;\r\nsd->vcur.contrast = 0;\r\nsd->vcur.gamma = 0;\r\nsd->vcur.hue = 0;\r\nsd->vcur.saturation = 60;\r\nsd->vcur.whitebal = 0;\r\nsd->vcur.mirror = 0;\r\nsd->vcur.flip = 0;\r\nsd->vcur.AC50Hz = 1;\r\nsd->vmax.backlight = 64;\r\nsd->vmax.brightness = 128;\r\nsd->vmax.sharpness = 40;\r\nsd->vmax.contrast = 3;\r\nsd->vmax.gamma = 2;\r\nsd->vmax.hue = 0 + 1;\r\nsd->vmax.saturation = 0;\r\nsd->vmax.whitebal = 2;\r\nsd->vmax.mirror = 1;\r\nsd->vmax.flip = 1;\r\nsd->vmax.AC50Hz = 1;\r\nsd->dev_camera_settings = mi2020_camera_settings;\r\nsd->dev_init_at_startup = mi2020_init_at_startup;\r\nsd->dev_configure_alt = mi2020_configure_alt;\r\nsd->dev_init_pre_alt = mi2020_init_pre_alt;\r\nsd->dev_post_unset_alt = mi2020_post_unset_alt;\r\n}\r\nstatic void common(struct gspca_dev *gspca_dev)\r\n{\r\nfetch_validx(gspca_dev, tbl_common_0B, ARRAY_SIZE(tbl_common_0B));\r\nfetch_idxdata(gspca_dev, tbl_common_3B, ARRAY_SIZE(tbl_common_3B));\r\nctrl_out(gspca_dev, 0x40, 1, 0x0041, 0x0000, 0, NULL);\r\n}\r\nstatic int mi2020_init_at_startup(struct gspca_dev *gspca_dev)\r\n{\r\nu8 c;\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0004, 1, &c);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0004, 1, &c);\r\nfetch_validx(gspca_dev, tbl_init_at_startup,\r\nARRAY_SIZE(tbl_init_at_startup));\r\nctrl_out(gspca_dev, 0x40, 1, 0x7a00, 0x8030, 0, NULL);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x7a00, 0x8030, 1, &c);\r\ncommon(gspca_dev);\r\nmsleep(61);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0001, 0x0000, 0, NULL);\r\nreturn 0;\r\n}\r\nstatic int mi2020_init_pre_alt(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->mirrorMask = 0;\r\nsd->vold.hue = -1;\r\nsd->vold.brightness = -1;\r\nsd->vold.sharpness = -1;\r\nsd->vold.contrast = 0;\r\nsd->vold.gamma = 0;\r\nsd->vold.backlight = 0;\r\nmi2020_init_post_alt(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int mi2020_init_post_alt(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\ns32 mirror = (((sd->vcur.mirror > 0) ^ sd->mirrorMask) > 0);\r\ns32 flip = (((sd->vcur.flip > 0) ^ sd->mirrorMask) > 0);\r\ns32 freq = (sd->vcur.AC50Hz > 0);\r\ns32 wbal = sd->vcur.whitebal;\r\nu8 dat_freq2[] = {0x90, 0x00, 0x80};\r\nu8 dat_multi1[] = {0x8c, 0xa7, 0x00};\r\nu8 dat_multi2[] = {0x90, 0x00, 0x00};\r\nu8 dat_multi3[] = {0x8c, 0xa7, 0x00};\r\nu8 dat_multi4[] = {0x90, 0x00, 0x00};\r\nu8 dat_hvflip2[] = {0x90, 0x04, 0x6c};\r\nu8 dat_hvflip4[] = {0x90, 0x00, 0x24};\r\nu8 dat_wbal2[] = {0x90, 0x00, 0x00};\r\nu8 c;\r\nsd->nbIm = -1;\r\ndat_freq2[2] = freq ? 0xc0 : 0x80;\r\ndat_multi1[2] = 0x9d;\r\ndat_multi3[2] = dat_multi1[2] + 1;\r\nif (wbal == 0) {\r\ndat_multi4[2] = dat_multi2[2] = 0;\r\ndat_wbal2[2] = 0x17;\r\n} else if (wbal == 1) {\r\ndat_multi4[2] = dat_multi2[2] = 0;\r\ndat_wbal2[2] = 0x35;\r\n} else if (wbal == 2) {\r\ndat_multi4[2] = dat_multi2[2] = 0x20;\r\ndat_wbal2[2] = 0x17;\r\n}\r\ndat_hvflip2[2] = 0x6c + 2 * (1 - flip) + (1 - mirror);\r\ndat_hvflip4[2] = 0x24 + 2 * (1 - flip) + (1 - mirror);\r\nmsleep(200);\r\nctrl_out(gspca_dev, 0x40, 5, 0x0001, 0x0000, 0, NULL);\r\nmsleep(2);\r\ncommon(gspca_dev);\r\nmsleep(142);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0010, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0003, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0042, 0x00c2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x006a, 0x000d, 0, NULL);\r\nswitch (reso) {\r\ncase IMAGE_640:\r\ncase IMAGE_800:\r\nif (reso != IMAGE_800)\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_640);\r\nelse\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_800);\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_low1,\r\nARRAY_SIZE(tbl_init_post_alt_low1));\r\nif (reso == IMAGE_800)\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_low2,\r\nARRAY_SIZE(tbl_init_post_alt_low2));\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_low3,\r\nARRAY_SIZE(tbl_init_post_alt_low3));\r\nctrl_out(gspca_dev, 0x40, 1, 0x0010, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0000, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0041, 0x00c2, 0, NULL);\r\nmsleep(120);\r\nbreak;\r\ncase IMAGE_1280:\r\ncase IMAGE_1600:\r\nif (reso == IMAGE_1280) {\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_1280);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x8c\x27\x07");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x90\x05\x04");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x8c\x27\x09");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x90\x04\x02");\r\n} else {\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_1600);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x8c\x27\x07");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x90\x06\x40");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x8c\x27\x09");\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033,\r\n3, "\x90\x04\xb0");\r\n}\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_big,\r\nARRAY_SIZE(tbl_init_post_alt_big));\r\nctrl_out(gspca_dev, 0x40, 1, 0x0001, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0000, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0041, 0x00c2, 0, NULL);\r\nmsleep(1850);\r\n}\r\nctrl_out(gspca_dev, 0x40, 1, 0x0040, 0x0000, 0, NULL);\r\nmsleep(40);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_freq1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_freq2);\r\nmsleep(33);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_wbal1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_wbal2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi6);\r\nmsleep(7);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0000, 1, &c);\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_3B,\r\nARRAY_SIZE(tbl_init_post_alt_3B));\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip6);\r\nmsleep(250);\r\nif (reso == IMAGE_640 || reso == IMAGE_800)\r\nfetch_idxdata(gspca_dev, tbl_middle_hvflip_low,\r\nARRAY_SIZE(tbl_middle_hvflip_low));\r\nelse\r\nfetch_idxdata(gspca_dev, tbl_middle_hvflip_big,\r\nARRAY_SIZE(tbl_middle_hvflip_big));\r\nfetch_idxdata(gspca_dev, tbl_end_hvflip,\r\nARRAY_SIZE(tbl_end_hvflip));\r\nsd->nbIm = 0;\r\nsd->vold.mirror = mirror;\r\nsd->vold.flip = flip;\r\nsd->vold.AC50Hz = freq;\r\nsd->vold.whitebal = wbal;\r\nmi2020_camera_settings(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int mi2020_configure_alt(struct gspca_dev *gspca_dev)\r\n{\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\nswitch (reso) {\r\ncase IMAGE_640:\r\ngspca_dev->alt = 3 + 1;\r\nbreak;\r\ncase IMAGE_800:\r\ncase IMAGE_1280:\r\ncase IMAGE_1600:\r\ngspca_dev->alt = 1 + 1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mi2020_camera_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\ns32 backlight = sd->vcur.backlight;\r\ns32 bright = sd->vcur.brightness;\r\ns32 sharp = sd->vcur.sharpness;\r\ns32 cntr = sd->vcur.contrast;\r\ns32 gam = sd->vcur.gamma;\r\ns32 hue = (sd->vcur.hue > 0);\r\ns32 mirror = (((sd->vcur.mirror > 0) ^ sd->mirrorMask) > 0);\r\ns32 flip = (((sd->vcur.flip > 0) ^ sd->mirrorMask) > 0);\r\ns32 freq = (sd->vcur.AC50Hz > 0);\r\ns32 wbal = sd->vcur.whitebal;\r\nu8 dat_sharp[] = {0x6c, 0x00, 0x08};\r\nu8 dat_bright2[] = {0x90, 0x00, 0x00};\r\nu8 dat_freq2[] = {0x90, 0x00, 0x80};\r\nu8 dat_multi1[] = {0x8c, 0xa7, 0x00};\r\nu8 dat_multi2[] = {0x90, 0x00, 0x00};\r\nu8 dat_multi3[] = {0x8c, 0xa7, 0x00};\r\nu8 dat_multi4[] = {0x90, 0x00, 0x00};\r\nu8 dat_hvflip2[] = {0x90, 0x04, 0x6c};\r\nu8 dat_hvflip4[] = {0x90, 0x00, 0x24};\r\nu8 dat_wbal2[] = {0x90, 0x00, 0x00};\r\nif (sd->nbIm < 4) {\r\nsd->waitSet = 1;\r\nreturn 0;\r\n}\r\nsd->waitSet = 0;\r\nif (freq != sd->vold.AC50Hz) {\r\nsd->vold.AC50Hz = freq;\r\ndat_freq2[2] = freq ? 0xc0 : 0x80;\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_freq1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_freq2);\r\nmsleep(20);\r\n}\r\nif (wbal != sd->vold.whitebal) {\r\nsd->vold.whitebal = wbal;\r\nif (wbal < 0 || wbal > sd->vmax.whitebal)\r\nwbal = 0;\r\ndat_multi1[2] = 0x9d;\r\ndat_multi3[2] = dat_multi1[2] + 1;\r\nif (wbal == 0) {\r\ndat_multi4[2] = dat_multi2[2] = 0;\r\ndat_wbal2[2] = 0x17;\r\n} else if (wbal == 1) {\r\ndat_multi4[2] = dat_multi2[2] = 0;\r\ndat_wbal2[2] = 0x35;\r\n} else if (wbal == 2) {\r\ndat_multi4[2] = dat_multi2[2] = 0x20;\r\ndat_wbal2[2] = 0x17;\r\n}\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_wbal1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_wbal2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi6);\r\n}\r\nif (mirror != sd->vold.mirror || flip != sd->vold.flip) {\r\nsd->vold.mirror = mirror;\r\nsd->vold.flip = flip;\r\ndat_hvflip2[2] = 0x6c + 2 * (1 - flip) + (1 - mirror);\r\ndat_hvflip4[2] = 0x24 + 2 * (1 - flip) + (1 - mirror);\r\nfetch_idxdata(gspca_dev, tbl_init_post_alt_3B,\r\nARRAY_SIZE(tbl_init_post_alt_3B));\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_hvflip6);\r\nmsleep(40);\r\nif (reso == IMAGE_640 || reso == IMAGE_800)\r\nfetch_idxdata(gspca_dev, tbl_middle_hvflip_low,\r\nARRAY_SIZE(tbl_middle_hvflip_low));\r\nelse\r\nfetch_idxdata(gspca_dev, tbl_middle_hvflip_big,\r\nARRAY_SIZE(tbl_middle_hvflip_big));\r\nfetch_idxdata(gspca_dev, tbl_end_hvflip,\r\nARRAY_SIZE(tbl_end_hvflip));\r\n}\r\nif (bright != sd->vold.brightness) {\r\nsd->vold.brightness = bright;\r\nif (bright < 0 || bright > sd->vmax.brightness)\r\nbright = 0;\r\ndat_bright2[2] = bright;\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_bright6);\r\n}\r\nif (cntr != sd->vold.contrast || gam != sd->vold.gamma) {\r\nsd->vold.contrast = cntr;\r\nif (cntr < 0 || cntr > sd->vmax.contrast)\r\ncntr = 0;\r\nsd->vold.gamma = gam;\r\nif (gam < 0 || gam > sd->vmax.gamma)\r\ngam = 0;\r\ndat_multi1[2] = 0x6d;\r\ndat_multi3[2] = dat_multi1[2] + 1;\r\nif (cntr == 0)\r\ncntr = 4;\r\ndat_multi4[2] = dat_multi2[2] = cntr * 0x10 + 2 - gam;\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi6);\r\n}\r\nif (backlight != sd->vold.backlight) {\r\nsd->vold.backlight = backlight;\r\nif (backlight < 0 || backlight > sd->vmax.backlight)\r\nbacklight = 0;\r\ndat_multi1[2] = 0x9d;\r\ndat_multi3[2] = dat_multi1[2] + 1;\r\ndat_multi4[2] = dat_multi2[2] = backlight;\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi1);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi2);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi3);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi4);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi5);\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0033, 3, dat_multi6);\r\n}\r\nif (sharp != sd->vold.sharpness) {\r\nsd->vold.sharpness = sharp;\r\nif (sharp < 0 || sharp > sd->vmax.sharpness)\r\nsharp = 0;\r\ndat_sharp[1] = sharp;\r\nctrl_out(gspca_dev, 0x40, 3, 0x7a00, 0x0032, 3, dat_sharp);\r\n}\r\nif (hue != sd->vold.hue) {\r\nsd->swapRB = hue;\r\nsd->vold.hue = hue;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mi2020_post_unset_alt(struct gspca_dev *gspca_dev)\r\n{\r\nctrl_out(gspca_dev, 0x40, 5, 0x0000, 0x0000, 0, NULL);\r\nmsleep(40);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0001, 0x0000, 0, NULL);\r\n}

int main(int ac, char **argv)\r\n{\r\nchar filename[256];\r\nFILE *f;\r\nint i, sock;\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nsock = open_raw_sock("lo");\r\nassert(setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, prog_fd,\r\nsizeof(prog_fd[0])) == 0);\r\nf = popen("ping -c5 localhost", "r");\r\n(void) f;\r\nfor (i = 0; i < 5; i++) {\r\nlong long tcp_cnt, udp_cnt, icmp_cnt;\r\nint key;\r\nkey = IPPROTO_TCP;\r\nassert(bpf_lookup_elem(map_fd[0], &key, &tcp_cnt) == 0);\r\nkey = IPPROTO_UDP;\r\nassert(bpf_lookup_elem(map_fd[0], &key, &udp_cnt) == 0);\r\nkey = IPPROTO_ICMP;\r\nassert(bpf_lookup_elem(map_fd[0], &key, &icmp_cnt) == 0);\r\nprintf("TCP %lld UDP %lld ICMP %lld packets\n",\r\ntcp_cnt, udp_cnt, icmp_cnt);\r\nsleep(1);\r\n}\r\nreturn 0;\r\n}

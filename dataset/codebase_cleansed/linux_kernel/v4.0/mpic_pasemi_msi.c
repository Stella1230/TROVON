static void mpic_pasemi_msi_mask_irq(struct irq_data *data)\r\n{\r\npr_debug("mpic_pasemi_msi_mask_irq %d\n", data->irq);\r\npci_msi_mask_irq(data);\r\nmpic_mask_irq(data);\r\n}\r\nstatic void mpic_pasemi_msi_unmask_irq(struct irq_data *data)\r\n{\r\npr_debug("mpic_pasemi_msi_unmask_irq %d\n", data->irq);\r\nmpic_unmask_irq(data);\r\npci_msi_unmask_irq(data);\r\n}\r\nstatic void pasemi_msi_teardown_msi_irqs(struct pci_dev *pdev)\r\n{\r\nstruct msi_desc *entry;\r\npr_debug("pasemi_msi_teardown_msi_irqs, pdev %p\n", pdev);\r\nlist_for_each_entry(entry, &pdev->msi_list, list) {\r\nif (entry->irq == NO_IRQ)\r\ncontinue;\r\nirq_set_msi_desc(entry->irq, NULL);\r\nmsi_bitmap_free_hwirqs(&msi_mpic->msi_bitmap,\r\nvirq_to_hw(entry->irq), ALLOC_CHUNK);\r\nirq_dispose_mapping(entry->irq);\r\n}\r\nreturn;\r\n}\r\nstatic int pasemi_msi_setup_msi_irqs(struct pci_dev *pdev, int nvec, int type)\r\n{\r\nunsigned int virq;\r\nstruct msi_desc *entry;\r\nstruct msi_msg msg;\r\nint hwirq;\r\nif (type == PCI_CAP_ID_MSIX)\r\npr_debug("pasemi_msi: MSI-X untested, trying anyway\n");\r\npr_debug("pasemi_msi_setup_msi_irqs, pdev %p nvec %d type %d\n",\r\npdev, nvec, type);\r\nmsg.address_hi = 0;\r\nmsg.address_lo = PASEMI_MSI_ADDR;\r\nlist_for_each_entry(entry, &pdev->msi_list, list) {\r\nhwirq = msi_bitmap_alloc_hwirqs(&msi_mpic->msi_bitmap,\r\nALLOC_CHUNK);\r\nif (hwirq < 0) {\r\npr_debug("pasemi_msi: failed allocating hwirq\n");\r\nreturn hwirq;\r\n}\r\nvirq = irq_create_mapping(msi_mpic->irqhost, hwirq);\r\nif (virq == NO_IRQ) {\r\npr_debug("pasemi_msi: failed mapping hwirq 0x%x\n",\r\nhwirq);\r\nmsi_bitmap_free_hwirqs(&msi_mpic->msi_bitmap, hwirq,\r\nALLOC_CHUNK);\r\nreturn -ENOSPC;\r\n}\r\nmpic_set_vector(virq, 0);\r\nirq_set_msi_desc(virq, entry);\r\nirq_set_chip(virq, &mpic_pasemi_msi_chip);\r\nirq_set_irq_type(virq, IRQ_TYPE_EDGE_RISING);\r\npr_debug("pasemi_msi: allocated virq 0x%x (hw 0x%x) " \\r\n"addr 0x%x\n", virq, hwirq, msg.address_lo);\r\nmsg.data = hwirq-0x200;\r\npci_write_msi_msg(virq, &msg);\r\n}\r\nreturn 0;\r\n}\r\nint mpic_pasemi_msi_init(struct mpic *mpic)\r\n{\r\nint rc;\r\nif (!mpic->irqhost->of_node ||\r\n!of_device_is_compatible(mpic->irqhost->of_node,\r\n"pasemi,pwrficient-openpic"))\r\nreturn -ENODEV;\r\nrc = mpic_msi_init_allocator(mpic);\r\nif (rc) {\r\npr_debug("pasemi_msi: Error allocating bitmap!\n");\r\nreturn rc;\r\n}\r\npr_debug("pasemi_msi: Registering PA Semi MPIC MSI callbacks\n");\r\nmsi_mpic = mpic;\r\nWARN_ON(ppc_md.setup_msi_irqs);\r\nppc_md.setup_msi_irqs = pasemi_msi_setup_msi_irqs;\r\nppc_md.teardown_msi_irqs = pasemi_msi_teardown_msi_irqs;\r\nreturn 0;\r\n}

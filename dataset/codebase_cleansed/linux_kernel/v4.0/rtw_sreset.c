void rtw_sreset_init(struct rtw_adapter *padapter)\r\n{\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(padapter);\r\nstruct sreset_priv *psrtpriv = &pHalData->srestpriv;\r\nmutex_init(&psrtpriv->silentreset_mutex);\r\npsrtpriv->silent_reset_inprogress = false;\r\npsrtpriv->last_tx_time = 0;\r\npsrtpriv->last_tx_complete_time = 0;\r\n}\r\nvoid rtw_sreset_reset_value(struct rtw_adapter *padapter)\r\n{\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(padapter);\r\nstruct sreset_priv *psrtpriv = &pHalData->srestpriv;\r\npsrtpriv->silent_reset_inprogress = false;\r\npsrtpriv->last_tx_time = 0;\r\npsrtpriv->last_tx_complete_time = 0;\r\n}\r\nbool rtw_sreset_inprogress(struct rtw_adapter *padapter)\r\n{\r\nstruct rtw_adapter *primary_adapter = GET_PRIMARY_ADAPTER(padapter);\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(primary_adapter);\r\nreturn pHalData->srestpriv.silent_reset_inprogress;\r\n}\r\nstatic void sreset_restore_security_station(struct rtw_adapter *padapter)\r\n{\r\nstruct mlme_priv *mlmepriv = &padapter->mlmepriv;\r\nstruct sta_priv *pstapriv = &padapter->stapriv;\r\nstruct sta_info *psta;\r\nstruct mlme_ext_info *pmlmeinfo = &padapter->mlmeextpriv.mlmext_info;\r\nu8 val8;\r\nif (pmlmeinfo->auth_algo == dot11AuthAlgrthm_8021X)\r\nval8 = 0xcc;\r\nelse\r\nval8 = 0xcf;\r\nrtl8723a_set_sec_cfg(padapter, val8);\r\nif (padapter->securitypriv.dot11PrivacyAlgrthm ==\r\nWLAN_CIPHER_SUITE_TKIP ||\r\npadapter->securitypriv.dot11PrivacyAlgrthm ==\r\nWLAN_CIPHER_SUITE_CCMP) {\r\npsta = rtw_get_stainfo23a(pstapriv, get_bssid(mlmepriv));\r\nif (psta == NULL) {\r\n} else {\r\nrtw_setstakey_cmd23a(padapter, (unsigned char *)psta, true);\r\nrtw_set_key23a(padapter,&padapter->securitypriv, padapter->securitypriv.dot118021XGrpKeyid, 0);\r\n}\r\n}\r\n}\r\nstatic void sreset_restore_network_station(struct rtw_adapter *padapter)\r\n{\r\nstruct mlme_priv *mlmepriv = &padapter->mlmepriv;\r\nstruct mlme_ext_priv *pmlmeext = &padapter->mlmeextpriv;\r\nstruct mlme_ext_info *pmlmeinfo = &pmlmeext->mlmext_info;\r\nu8 threshold;\r\nrtw_setopmode_cmd23a(padapter, NL80211_IFTYPE_STATION);\r\nif (mlmepriv->htpriv.ht_option) {\r\nif (padapter->registrypriv.wifi_spec == 1)\r\nthreshold = 1;\r\nelse\r\nthreshold = 0;\r\n} else\r\nthreshold = 1;\r\nrtl8723a_set_rxdma_agg_pg_th(padapter, threshold);\r\nset_channel_bwmode23a(padapter, pmlmeext->cur_channel,\r\npmlmeext->cur_ch_offset, pmlmeext->cur_bwmode);\r\nhw_var_set_bssid(padapter, pmlmeinfo->network.MacAddress);\r\nhw_var_set_mlme_join(padapter, 0);\r\nrtl8723a_set_media_status(padapter, pmlmeinfo->state & 0x3);\r\nmlmeext_joinbss_event_callback23a(padapter, 1);\r\nrtl8723au_write8(padapter, REG_NQOS_SEQ, padapter->xmitpriv.nqos_ssn);\r\nsreset_restore_security_station(padapter);\r\n}\r\nstatic void sreset_restore_network_status(struct rtw_adapter *padapter)\r\n{\r\nstruct mlme_priv *mlmepriv = &padapter->mlmepriv;\r\nif (check_fwstate(mlmepriv, WIFI_STATION_STATE)) {\r\nDBG_8723A("%s(%s): fwstate:0x%08x - WIFI_STATION_STATE\n",\r\n__func__, padapter->pnetdev->name,\r\nget_fwstate(mlmepriv));\r\nsreset_restore_network_station(padapter);\r\n#ifdef CONFIG_8723AU_AP_MODE\r\n} else if (check_fwstate(mlmepriv, WIFI_AP_STATE)) {\r\nDBG_8723A("%s(%s): fwstate:0x%08x - WIFI_AP_STATE\n",\r\n__func__, padapter->pnetdev->name,\r\nget_fwstate(mlmepriv));\r\nrtw_ap_restore_network(padapter);\r\n#endif\r\n} else if (check_fwstate(mlmepriv, WIFI_ADHOC_STATE)) {\r\nDBG_8723A("%s(%s): fwstate:0x%08x - WIFI_ADHOC_STATE\n",\r\n__func__, padapter->pnetdev->name,\r\nget_fwstate(mlmepriv));\r\n} else {\r\nDBG_8723A("%s(%s): fwstate:0x%08x - ???\n", __func__,\r\npadapter->pnetdev->name, get_fwstate(mlmepriv));\r\n}\r\n}\r\nstatic void sreset_stop_adapter(struct rtw_adapter *padapter)\r\n{\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nif (padapter == NULL)\r\nreturn;\r\nDBG_8723A("%s(%s)\n", __func__, padapter->pnetdev->name);\r\nif (!rtw_netif_queue_stopped(padapter->pnetdev))\r\nnetif_tx_stop_all_queues(padapter->pnetdev);\r\nrtw_cancel_all_timer23a(padapter);\r\ntasklet_kill(&pxmitpriv->xmit_tasklet);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY))\r\nrtw_scan_abort23a(padapter);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_LINKING))\r\nrtw23a_join_to_handler((unsigned long)padapter);\r\n}\r\nstatic void sreset_start_adapter(struct rtw_adapter *padapter)\r\n{\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nif (padapter == NULL)\r\nreturn;\r\nDBG_8723A("%s(%s)\n", __func__, padapter->pnetdev->name);\r\nif (check_fwstate(pmlmepriv, _FW_LINKED))\r\nsreset_restore_network_status(padapter);\r\ntasklet_hi_schedule(&pxmitpriv->xmit_tasklet);\r\nmod_timer(&padapter->mlmepriv.dynamic_chk_timer,\r\njiffies + msecs_to_jiffies(2000));\r\nif (rtw_netif_queue_stopped(padapter->pnetdev))\r\nnetif_tx_wake_all_queues(padapter->pnetdev);\r\n}\r\nvoid rtw_sreset_reset(struct rtw_adapter *active_adapter)\r\n{\r\nstruct rtw_adapter *padapter = GET_PRIMARY_ADAPTER(active_adapter);\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(padapter);\r\nstruct sreset_priv *psrtpriv = &pHalData->srestpriv;\r\nstruct pwrctrl_priv *pwrpriv = &padapter->pwrctrlpriv;\r\nunsigned long start = jiffies;\r\nDBG_8723A("%s\n", __func__);\r\nmutex_lock(&psrtpriv->silentreset_mutex);\r\npsrtpriv->silent_reset_inprogress = true;\r\npwrpriv->change_rfpwrstate = rf_off;\r\nsreset_stop_adapter(padapter);\r\nips_enter23a(padapter);\r\nips_leave23a(padapter);\r\nsreset_start_adapter(padapter);\r\npsrtpriv->silent_reset_inprogress = false;\r\nmutex_unlock(&psrtpriv->silentreset_mutex);\r\nDBG_8723A("%s done in %d ms\n", __func__,\r\njiffies_to_msecs(jiffies - start));\r\n}

static void gpio_extcon_work(struct work_struct *work)\r\n{\r\nint state;\r\nstruct gpio_extcon_data *data =\r\ncontainer_of(to_delayed_work(work), struct gpio_extcon_data,\r\nwork);\r\nstate = gpio_get_value(data->gpio);\r\nif (data->gpio_active_low)\r\nstate = !state;\r\nextcon_set_state(data->edev, state);\r\n}\r\nstatic irqreturn_t gpio_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct gpio_extcon_data *extcon_data = dev_id;\r\nqueue_delayed_work(system_power_efficient_wq, &extcon_data->work,\r\nextcon_data->debounce_jiffies);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t extcon_gpio_print_state(struct extcon_dev *edev, char *buf)\r\n{\r\nstruct device *dev = edev->dev.parent;\r\nstruct gpio_extcon_data *extcon_data = dev_get_drvdata(dev);\r\nconst char *state;\r\nif (extcon_get_state(edev))\r\nstate = extcon_data->state_on;\r\nelse\r\nstate = extcon_data->state_off;\r\nif (state)\r\nreturn sprintf(buf, "%s\n", state);\r\nreturn -EINVAL;\r\n}\r\nstatic int gpio_extcon_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_extcon_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct gpio_extcon_data *extcon_data;\r\nint ret;\r\nif (!pdata)\r\nreturn -EBUSY;\r\nif (!pdata->irq_flags) {\r\ndev_err(&pdev->dev, "IRQ flag is not specified.\n");\r\nreturn -EINVAL;\r\n}\r\nextcon_data = devm_kzalloc(&pdev->dev, sizeof(struct gpio_extcon_data),\r\nGFP_KERNEL);\r\nif (!extcon_data)\r\nreturn -ENOMEM;\r\nextcon_data->edev = devm_extcon_dev_allocate(&pdev->dev, NULL);\r\nif (IS_ERR(extcon_data->edev)) {\r\ndev_err(&pdev->dev, "failed to allocate extcon device\n");\r\nreturn -ENOMEM;\r\n}\r\nextcon_data->edev->name = pdata->name;\r\nextcon_data->gpio = pdata->gpio;\r\nextcon_data->gpio_active_low = pdata->gpio_active_low;\r\nextcon_data->state_on = pdata->state_on;\r\nextcon_data->state_off = pdata->state_off;\r\nextcon_data->check_on_resume = pdata->check_on_resume;\r\nif (pdata->state_on && pdata->state_off)\r\nextcon_data->edev->print_state = extcon_gpio_print_state;\r\nret = devm_gpio_request_one(&pdev->dev, extcon_data->gpio, GPIOF_DIR_IN,\r\npdev->name);\r\nif (ret < 0)\r\nreturn ret;\r\nif (pdata->debounce) {\r\nret = gpio_set_debounce(extcon_data->gpio,\r\npdata->debounce * 1000);\r\nif (ret < 0)\r\nextcon_data->debounce_jiffies =\r\nmsecs_to_jiffies(pdata->debounce);\r\n}\r\nret = devm_extcon_dev_register(&pdev->dev, extcon_data->edev);\r\nif (ret < 0)\r\nreturn ret;\r\nINIT_DELAYED_WORK(&extcon_data->work, gpio_extcon_work);\r\nextcon_data->irq = gpio_to_irq(extcon_data->gpio);\r\nif (extcon_data->irq < 0)\r\nreturn extcon_data->irq;\r\nret = request_any_context_irq(extcon_data->irq, gpio_irq_handler,\r\npdata->irq_flags, pdev->name,\r\nextcon_data);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, extcon_data);\r\ngpio_extcon_work(&extcon_data->work.work);\r\nreturn 0;\r\n}\r\nstatic int gpio_extcon_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_extcon_data *extcon_data = platform_get_drvdata(pdev);\r\ncancel_delayed_work_sync(&extcon_data->work);\r\nfree_irq(extcon_data->irq, extcon_data);\r\nreturn 0;\r\n}\r\nstatic int gpio_extcon_resume(struct device *dev)\r\n{\r\nstruct gpio_extcon_data *extcon_data;\r\nextcon_data = dev_get_drvdata(dev);\r\nif (extcon_data->check_on_resume)\r\nqueue_delayed_work(system_power_efficient_wq,\r\n&extcon_data->work, extcon_data->debounce_jiffies);\r\nreturn 0;\r\n}

static int jornada_bl_get_brightness(struct backlight_device *bd)\r\n{\r\nint ret;\r\nif (!(PPSR & PPC_LDD1))\r\nreturn 0;\r\njornada_ssp_start();\r\nret = jornada_ssp_byte(GETBRIGHTNESS);\r\nif (jornada_ssp_byte(GETBRIGHTNESS) != TXDUMMY) {\r\ndev_err(&bd->dev, "get brightness timeout\n");\r\njornada_ssp_end();\r\nreturn -ETIMEDOUT;\r\n}\r\nret = jornada_ssp_byte(TXDUMMY);\r\njornada_ssp_end();\r\nreturn BL_MAX_BRIGHT - ret;\r\n}\r\nstatic int jornada_bl_update_status(struct backlight_device *bd)\r\n{\r\nint ret = 0;\r\njornada_ssp_start();\r\nif ((bd->props.power != FB_BLANK_UNBLANK) || (bd->props.fb_blank != FB_BLANK_UNBLANK)) {\r\nret = jornada_ssp_byte(BRIGHTNESSOFF);\r\nif (ret != TXDUMMY) {\r\ndev_info(&bd->dev, "brightness off timeout\n");\r\nPPSR &= ~PPC_LDD1;\r\nPPDR |= PPC_LDD1;\r\nret = -ETIMEDOUT;\r\n}\r\n} else\r\nPPSR |= PPC_LDD1;\r\nif (jornada_ssp_byte(SETBRIGHTNESS) != TXDUMMY) {\r\ndev_info(&bd->dev, "failed to set brightness\n");\r\nret = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nif (jornada_ssp_byte(BL_MAX_BRIGHT - bd->props.brightness)\r\n!= TXDUMMY) {\r\ndev_err(&bd->dev, "set brightness failed\n");\r\nret = -ETIMEDOUT;\r\n}\r\nout:\r\njornada_ssp_end();\r\nreturn ret;\r\n}\r\nstatic int jornada_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nint ret;\r\nstruct backlight_device *bd;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = BL_MAX_BRIGHT;\r\nbd = devm_backlight_device_register(&pdev->dev, S1D_DEVICENAME,\r\n&pdev->dev, NULL, &jornada_bl_ops,\r\n&props);\r\nif (IS_ERR(bd)) {\r\nret = PTR_ERR(bd);\r\ndev_err(&pdev->dev, "failed to register device, err=%x\n", ret);\r\nreturn ret;\r\n}\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbd->props.brightness = BL_DEF_BRIGHT;\r\njornada_bl_update_status(bd);\r\nplatform_set_drvdata(pdev, bd);\r\ndev_info(&pdev->dev, "HP Jornada 700 series backlight driver\n");\r\nreturn 0;\r\n}

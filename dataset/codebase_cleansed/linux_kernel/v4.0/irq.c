static inline void rt_intc_w32(u32 val, unsigned reg)\r\n{\r\n__raw_writel(val, rt_intc_membase + rt_intc_regs[reg]);\r\n}\r\nstatic inline u32 rt_intc_r32(unsigned reg)\r\n{\r\nreturn __raw_readl(rt_intc_membase + rt_intc_regs[reg]);\r\n}\r\nstatic void ralink_intc_irq_unmask(struct irq_data *d)\r\n{\r\nrt_intc_w32(BIT(d->hwirq), INTC_REG_ENABLE);\r\n}\r\nstatic void ralink_intc_irq_mask(struct irq_data *d)\r\n{\r\nrt_intc_w32(BIT(d->hwirq), INTC_REG_DISABLE);\r\n}\r\nint get_c0_perfcount_int(void)\r\n{\r\nreturn rt_perfcount_irq;\r\n}\r\nunsigned int get_c0_compare_int(void)\r\n{\r\nreturn CP0_LEGACY_COMPARE_IRQ;\r\n}\r\nstatic void ralink_intc_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nu32 pending = rt_intc_r32(INTC_REG_STATUS0);\r\nif (pending) {\r\nstruct irq_domain *domain = irq_get_handler_data(irq);\r\ngeneric_handle_irq(irq_find_mapping(domain, __ffs(pending)));\r\n} else {\r\nspurious_interrupt();\r\n}\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned long pending;\r\npending = read_c0_status() & read_c0_cause() & ST0_IM;\r\nif (pending & STATUSF_IP7)\r\ndo_IRQ(RALINK_CPU_IRQ_COUNTER);\r\nelse if (pending & STATUSF_IP5)\r\ndo_IRQ(RALINK_CPU_IRQ_FE);\r\nelse if (pending & STATUSF_IP6)\r\ndo_IRQ(RALINK_CPU_IRQ_WIFI);\r\nelse if (pending & STATUSF_IP4)\r\ndo_IRQ(RALINK_CPU_IRQ_PCI);\r\nelse if (pending & STATUSF_IP2)\r\ndo_IRQ(RALINK_CPU_IRQ_INTC);\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic int intc_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hw)\r\n{\r\nirq_set_chip_and_handler(irq, &ralink_intc_irq_chip, handle_level_irq);\r\nreturn 0;\r\n}\r\nstatic int __init intc_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nstruct resource res;\r\nstruct irq_domain *domain;\r\nint irq;\r\nif (!of_property_read_u32_array(node, "ralink,intc-registers",\r\nrt_intc_regs, 6))\r\npr_info("intc: using register map from devicetree\n");\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (!irq)\r\npanic("Failed to get INTC IRQ");\r\nif (of_address_to_resource(node, 0, &res))\r\npanic("Failed to get intc memory range");\r\nif (request_mem_region(res.start, resource_size(&res),\r\nres.name) < 0)\r\npr_err("Failed to request intc memory");\r\nrt_intc_membase = ioremap_nocache(res.start,\r\nresource_size(&res));\r\nif (!rt_intc_membase)\r\npanic("Failed to remap intc memory");\r\nrt_intc_w32(~0, INTC_REG_DISABLE);\r\nrt_intc_w32(0, INTC_REG_TYPE);\r\ndomain = irq_domain_add_legacy(node, RALINK_INTC_IRQ_COUNT,\r\nRALINK_INTC_IRQ_BASE, 0, &irq_domain_ops, NULL);\r\nif (!domain)\r\npanic("Failed to add irqdomain");\r\nrt_intc_w32(INTC_INT_GLOBAL, INTC_REG_ENABLE);\r\nirq_set_chained_handler(irq, ralink_intc_irq_handler);\r\nirq_set_handler_data(irq, domain);\r\nrt_perfcount_irq = irq_create_mapping(domain, 9);\r\nreturn 0;\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nof_irq_init(of_irq_ids);\r\n}

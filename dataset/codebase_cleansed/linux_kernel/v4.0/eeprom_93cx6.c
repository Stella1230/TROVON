static inline void eeprom_93cx6_pulse_high(struct eeprom_93cx6 *eeprom)\r\n{\r\neeprom->reg_data_clock = 1;\r\neeprom->register_write(eeprom);\r\nndelay(450);\r\n}\r\nstatic inline void eeprom_93cx6_pulse_low(struct eeprom_93cx6 *eeprom)\r\n{\r\neeprom->reg_data_clock = 0;\r\neeprom->register_write(eeprom);\r\nndelay(450);\r\n}\r\nstatic void eeprom_93cx6_startup(struct eeprom_93cx6 *eeprom)\r\n{\r\neeprom->register_read(eeprom);\r\neeprom->reg_data_in = 0;\r\neeprom->reg_data_out = 0;\r\neeprom->reg_data_clock = 0;\r\neeprom->reg_chip_select = 1;\r\neeprom->drive_data = 1;\r\neeprom->register_write(eeprom);\r\neeprom_93cx6_pulse_high(eeprom);\r\neeprom_93cx6_pulse_low(eeprom);\r\n}\r\nstatic void eeprom_93cx6_cleanup(struct eeprom_93cx6 *eeprom)\r\n{\r\neeprom->register_read(eeprom);\r\neeprom->reg_data_in = 0;\r\neeprom->reg_chip_select = 0;\r\neeprom->register_write(eeprom);\r\neeprom_93cx6_pulse_high(eeprom);\r\neeprom_93cx6_pulse_low(eeprom);\r\n}\r\nstatic void eeprom_93cx6_write_bits(struct eeprom_93cx6 *eeprom,\r\nconst u16 data, const u16 count)\r\n{\r\nunsigned int i;\r\neeprom->register_read(eeprom);\r\neeprom->reg_data_in = 0;\r\neeprom->reg_data_out = 0;\r\neeprom->drive_data = 1;\r\nfor (i = count; i > 0; i--) {\r\neeprom->reg_data_in = !!(data & (1 << (i - 1)));\r\neeprom->register_write(eeprom);\r\neeprom_93cx6_pulse_high(eeprom);\r\neeprom_93cx6_pulse_low(eeprom);\r\n}\r\neeprom->reg_data_in = 0;\r\neeprom->register_write(eeprom);\r\n}\r\nstatic void eeprom_93cx6_read_bits(struct eeprom_93cx6 *eeprom,\r\nu16 *data, const u16 count)\r\n{\r\nunsigned int i;\r\nu16 buf = 0;\r\neeprom->register_read(eeprom);\r\neeprom->reg_data_in = 0;\r\neeprom->reg_data_out = 0;\r\neeprom->drive_data = 0;\r\nfor (i = count; i > 0; i--) {\r\neeprom_93cx6_pulse_high(eeprom);\r\neeprom->register_read(eeprom);\r\neeprom->reg_data_in = 0;\r\nif (eeprom->reg_data_out)\r\nbuf |= (1 << (i - 1));\r\neeprom_93cx6_pulse_low(eeprom);\r\n}\r\n*data = buf;\r\n}\r\nvoid eeprom_93cx6_read(struct eeprom_93cx6 *eeprom, const u8 word,\r\nu16 *data)\r\n{\r\nu16 command;\r\neeprom_93cx6_startup(eeprom);\r\ncommand = (PCI_EEPROM_READ_OPCODE << eeprom->width) | word;\r\neeprom_93cx6_write_bits(eeprom, command,\r\nPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\r\neeprom_93cx6_read_bits(eeprom, data, 16);\r\neeprom_93cx6_cleanup(eeprom);\r\n}\r\nvoid eeprom_93cx6_multiread(struct eeprom_93cx6 *eeprom, const u8 word,\r\n__le16 *data, const u16 words)\r\n{\r\nunsigned int i;\r\nu16 tmp;\r\nfor (i = 0; i < words; i++) {\r\ntmp = 0;\r\neeprom_93cx6_read(eeprom, word + i, &tmp);\r\ndata[i] = cpu_to_le16(tmp);\r\n}\r\n}\r\nvoid eeprom_93cx6_readb(struct eeprom_93cx6 *eeprom, const u8 byte,\r\nu8 *data)\r\n{\r\nu16 command;\r\nu16 tmp;\r\neeprom_93cx6_startup(eeprom);\r\ncommand = (PCI_EEPROM_READ_OPCODE << (eeprom->width + 1)) | byte;\r\neeprom_93cx6_write_bits(eeprom, command,\r\nPCI_EEPROM_WIDTH_OPCODE + eeprom->width + 1);\r\neeprom_93cx6_read_bits(eeprom, &tmp, 8);\r\n*data = tmp & 0xff;\r\neeprom_93cx6_cleanup(eeprom);\r\n}\r\nvoid eeprom_93cx6_multireadb(struct eeprom_93cx6 *eeprom, const u8 byte,\r\nu8 *data, const u16 bytes)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < bytes; i++)\r\neeprom_93cx6_readb(eeprom, byte + i, &data[i]);\r\n}\r\nvoid eeprom_93cx6_wren(struct eeprom_93cx6 *eeprom, bool enable)\r\n{\r\nu16 command;\r\neeprom_93cx6_startup(eeprom);\r\ncommand = enable ? PCI_EEPROM_EWEN_OPCODE : PCI_EEPROM_EWDS_OPCODE;\r\ncommand <<= (eeprom->width - 2);\r\neeprom_93cx6_write_bits(eeprom, command,\r\nPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\r\neeprom_93cx6_cleanup(eeprom);\r\n}\r\nvoid eeprom_93cx6_write(struct eeprom_93cx6 *eeprom, u8 addr, u16 data)\r\n{\r\nint timeout = 100;\r\nu16 command;\r\neeprom_93cx6_startup(eeprom);\r\ncommand = PCI_EEPROM_WRITE_OPCODE << eeprom->width;\r\ncommand |= addr;\r\neeprom_93cx6_write_bits(eeprom, command,\r\nPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\r\neeprom_93cx6_write_bits(eeprom, data, 16);\r\neeprom->drive_data = 0;\r\neeprom->reg_chip_select = 1;\r\neeprom->register_write(eeprom);\r\nusleep_range(1000, 2000);\r\nwhile (true) {\r\neeprom->register_read(eeprom);\r\nif (eeprom->reg_data_out)\r\nbreak;\r\nusleep_range(1000, 2000);\r\nif (--timeout <= 0) {\r\nprintk(KERN_ERR "%s: timeout\n", __func__);\r\nbreak;\r\n}\r\n}\r\neeprom_93cx6_cleanup(eeprom);\r\n}

long kvmppc_h_put_tce(struct kvm_vcpu *vcpu, unsigned long liobn,\r\nunsigned long ioba, unsigned long tce)\r\n{\r\nstruct kvm *kvm = vcpu->kvm;\r\nstruct kvmppc_spapr_tce_table *stt;\r\nlist_for_each_entry(stt, &kvm->arch.spapr_tce_tables, list) {\r\nif (stt->liobn == liobn) {\r\nunsigned long idx = ioba >> SPAPR_TCE_SHIFT;\r\nstruct page *page;\r\nu64 *tbl;\r\nif (ioba >= stt->window_size)\r\nreturn H_PARAMETER;\r\npage = stt->pages[idx / TCES_PER_PAGE];\r\ntbl = (u64 *)page_address(page);\r\ntbl[idx % TCES_PER_PAGE] = tce;\r\nreturn H_SUCCESS;\r\n}\r\n}\r\nreturn H_TOO_HARD;\r\n}\r\nlong kvmppc_h_get_tce(struct kvm_vcpu *vcpu, unsigned long liobn,\r\nunsigned long ioba)\r\n{\r\nstruct kvm *kvm = vcpu->kvm;\r\nstruct kvmppc_spapr_tce_table *stt;\r\nlist_for_each_entry(stt, &kvm->arch.spapr_tce_tables, list) {\r\nif (stt->liobn == liobn) {\r\nunsigned long idx = ioba >> SPAPR_TCE_SHIFT;\r\nstruct page *page;\r\nu64 *tbl;\r\nif (ioba >= stt->window_size)\r\nreturn H_PARAMETER;\r\npage = stt->pages[idx / TCES_PER_PAGE];\r\ntbl = (u64 *)page_address(page);\r\nvcpu->arch.gpr[4] = tbl[idx % TCES_PER_PAGE];\r\nreturn H_SUCCESS;\r\n}\r\n}\r\nreturn H_TOO_HARD;\r\n}

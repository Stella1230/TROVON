void brcmf_debugfs_init(void)\r\n{\r\nroot_folder = debugfs_create_dir(KBUILD_MODNAME, NULL);\r\nif (IS_ERR(root_folder))\r\nroot_folder = NULL;\r\n}\r\nvoid brcmf_debugfs_exit(void)\r\n{\r\nif (!root_folder)\r\nreturn;\r\ndebugfs_remove_recursive(root_folder);\r\nroot_folder = NULL;\r\n}\r\nstatic int brcmf_debugfs_chipinfo_read(struct seq_file *seq, void *data)\r\n{\r\nstruct brcmf_bus *bus = dev_get_drvdata(seq->private);\r\nseq_printf(seq, "chip: %x(%u) rev %u\n",\r\nbus->chip, bus->chip, bus->chiprev);\r\nreturn 0;\r\n}\r\nint brcmf_debugfs_attach(struct brcmf_pub *drvr)\r\n{\r\nstruct device *dev = drvr->bus_if->dev;\r\nif (!root_folder)\r\nreturn -ENODEV;\r\ndrvr->dbgfs_dir = debugfs_create_dir(dev_name(dev), root_folder);\r\nbrcmf_debugfs_add_entry(drvr, "chipinfo", brcmf_debugfs_chipinfo_read);\r\nreturn PTR_ERR_OR_ZERO(drvr->dbgfs_dir);\r\n}\r\nvoid brcmf_debugfs_detach(struct brcmf_pub *drvr)\r\n{\r\nif (!IS_ERR_OR_NULL(drvr->dbgfs_dir))\r\ndebugfs_remove_recursive(drvr->dbgfs_dir);\r\n}\r\nstruct dentry *brcmf_debugfs_get_devdir(struct brcmf_pub *drvr)\r\n{\r\nreturn drvr->dbgfs_dir;\r\n}\r\nstatic int brcmf_debugfs_entry_open(struct inode *inode, struct file *f)\r\n{\r\nstruct brcmf_debugfs_entry *entry = inode->i_private;\r\nreturn single_open(f, entry->read, entry->drvr->bus_if->dev);\r\n}\r\nint brcmf_debugfs_add_entry(struct brcmf_pub *drvr, const char *fn,\r\nint (*read_fn)(struct seq_file *seq, void *data))\r\n{\r\nstruct dentry *dentry = drvr->dbgfs_dir;\r\nstruct brcmf_debugfs_entry *entry;\r\nif (IS_ERR_OR_NULL(dentry))\r\nreturn -ENOENT;\r\nentry = devm_kzalloc(drvr->bus_if->dev, sizeof(*entry), GFP_KERNEL);\r\nif (!entry)\r\nreturn -ENOMEM;\r\nentry->read = read_fn;\r\nentry->drvr = drvr;\r\ndentry = debugfs_create_file(fn, S_IRUGO, dentry, entry,\r\n&brcmf_debugfs_def_ops);\r\nreturn PTR_ERR_OR_ZERO(dentry);\r\n}

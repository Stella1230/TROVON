static void nft_immediate_eval(const struct nft_expr *expr,\r\nstruct nft_data data[NFT_REG_MAX + 1],\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nconst struct nft_immediate_expr *priv = nft_expr_priv(expr);\r\nnft_data_copy(&data[priv->dreg], &priv->data);\r\n}\r\nstatic int nft_immediate_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_immediate_expr *priv = nft_expr_priv(expr);\r\nstruct nft_data_desc desc;\r\nint err;\r\nif (tb[NFTA_IMMEDIATE_DREG] == NULL ||\r\ntb[NFTA_IMMEDIATE_DATA] == NULL)\r\nreturn -EINVAL;\r\npriv->dreg = ntohl(nla_get_be32(tb[NFTA_IMMEDIATE_DREG]));\r\nerr = nft_validate_output_register(priv->dreg);\r\nif (err < 0)\r\nreturn err;\r\nerr = nft_data_init(ctx, &priv->data, &desc, tb[NFTA_IMMEDIATE_DATA]);\r\nif (err < 0)\r\nreturn err;\r\npriv->dlen = desc.len;\r\nerr = nft_validate_data_load(ctx, priv->dreg, &priv->data, desc.type);\r\nif (err < 0)\r\ngoto err1;\r\nreturn 0;\r\nerr1:\r\nnft_data_uninit(&priv->data, desc.type);\r\nreturn err;\r\n}\r\nstatic void nft_immediate_destroy(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr)\r\n{\r\nconst struct nft_immediate_expr *priv = nft_expr_priv(expr);\r\nreturn nft_data_uninit(&priv->data, nft_dreg_to_type(priv->dreg));\r\n}\r\nstatic int nft_immediate_dump(struct sk_buff *skb, const struct nft_expr *expr)\r\n{\r\nconst struct nft_immediate_expr *priv = nft_expr_priv(expr);\r\nif (nla_put_be32(skb, NFTA_IMMEDIATE_DREG, htonl(priv->dreg)))\r\ngoto nla_put_failure;\r\nreturn nft_data_dump(skb, NFTA_IMMEDIATE_DATA, &priv->data,\r\nnft_dreg_to_type(priv->dreg), priv->dlen);\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int nft_immediate_validate(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nft_data **data)\r\n{\r\nconst struct nft_immediate_expr *priv = nft_expr_priv(expr);\r\nif (priv->dreg == NFT_REG_VERDICT)\r\n*data = &priv->data;\r\nreturn 0;\r\n}\r\nint __init nft_immediate_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_imm_type);\r\n}\r\nvoid nft_immediate_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_imm_type);\r\n}

static int __init parity(u8 v)\r\n{\r\nint x = 0;\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nx ^= (v & 1);\r\nv >>= 1;\r\n}\r\nreturn x;\r\n}\r\nstatic void __init sbf_write(u8 v)\r\n{\r\nunsigned long flags;\r\nif (sbf_port != -1) {\r\nv &= ~SBF_PARITY;\r\nif (!parity(v))\r\nv |= SBF_PARITY;\r\nprintk(KERN_INFO "Simple Boot Flag at 0x%x set to 0x%x\n",\r\nsbf_port, v);\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nCMOS_WRITE(v, sbf_port);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\n}\r\n}\r\nstatic u8 __init sbf_read(void)\r\n{\r\nunsigned long flags;\r\nu8 v;\r\nif (sbf_port == -1)\r\nreturn 0;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nv = CMOS_READ(sbf_port);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn v;\r\n}\r\nstatic int __init sbf_value_valid(u8 v)\r\n{\r\nif (v & SBF_RESERVED)\r\nreturn 0;\r\nif (!parity(v))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int __init sbf_init(void)\r\n{\r\nu8 v;\r\nif (sbf_port == -1)\r\nreturn 0;\r\nv = sbf_read();\r\nif (!sbf_value_valid(v)) {\r\nprintk(KERN_WARNING "Simple Boot Flag value 0x%x read from "\r\n"CMOS RAM was invalid\n", v);\r\n}\r\nv &= ~SBF_RESERVED;\r\nv &= ~SBF_BOOTING;\r\nv &= ~SBF_DIAG;\r\n#if defined(CONFIG_ISAPNP)\r\nv |= SBF_PNPOS;\r\n#endif\r\nsbf_write(v);\r\nreturn 0;\r\n}

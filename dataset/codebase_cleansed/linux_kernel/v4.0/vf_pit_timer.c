static inline void pit_timer_enable(void)\r\n{\r\n__raw_writel(PITTCTRL_TEN | PITTCTRL_TIE, clkevt_base + PITTCTRL);\r\n}\r\nstatic inline void pit_timer_disable(void)\r\n{\r\n__raw_writel(0, clkevt_base + PITTCTRL);\r\n}\r\nstatic inline void pit_irq_acknowledge(void)\r\n{\r\n__raw_writel(PITTFLG_TIF, clkevt_base + PITTFLG);\r\n}\r\nstatic u64 pit_read_sched_clock(void)\r\n{\r\nreturn ~__raw_readl(clksrc_base + PITCVAL);\r\n}\r\nstatic int __init pit_clocksource_init(unsigned long rate)\r\n{\r\n__raw_writel(0, clksrc_base + PITTCTRL);\r\n__raw_writel(~0UL, clksrc_base + PITLDVAL);\r\n__raw_writel(PITTCTRL_TEN, clksrc_base + PITTCTRL);\r\nsched_clock_register(pit_read_sched_clock, 32, rate);\r\nreturn clocksource_mmio_init(clksrc_base + PITCVAL, "vf-pit", rate,\r\n300, 32, clocksource_mmio_readl_down);\r\n}\r\nstatic int pit_set_next_event(unsigned long delta,\r\nstruct clock_event_device *unused)\r\n{\r\npit_timer_disable();\r\n__raw_writel(delta - 1, clkevt_base + PITLDVAL);\r\npit_timer_enable();\r\nreturn 0;\r\n}\r\nstatic void pit_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\npit_set_next_event(cycle_per_jiffy, evt);\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\npit_timer_disable();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t pit_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\npit_irq_acknowledge();\r\nif (likely(evt->mode == CLOCK_EVT_MODE_ONESHOT))\r\npit_timer_disable();\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init pit_clockevent_init(unsigned long rate, int irq)\r\n{\r\n__raw_writel(0, clkevt_base + PITTCTRL);\r\n__raw_writel(PITTFLG_TIF, clkevt_base + PITTFLG);\r\nBUG_ON(setup_irq(irq, &pit_timer_irq));\r\nclockevent_pit.cpumask = cpumask_of(0);\r\nclockevent_pit.irq = irq;\r\nclockevents_config_and_register(&clockevent_pit, rate, 2, 0xffffffff);\r\nreturn 0;\r\n}\r\nstatic void __init pit_timer_init(struct device_node *np)\r\n{\r\nstruct clk *pit_clk;\r\nvoid __iomem *timer_base;\r\nunsigned long clk_rate;\r\nint irq;\r\ntimer_base = of_iomap(np, 0);\r\nBUG_ON(!timer_base);\r\nclksrc_base = timer_base + PITn_OFFSET(2);\r\nclkevt_base = timer_base + PITn_OFFSET(3);\r\nirq = irq_of_parse_and_map(np, 0);\r\nBUG_ON(irq <= 0);\r\npit_clk = of_clk_get(np, 0);\r\nBUG_ON(IS_ERR(pit_clk));\r\nBUG_ON(clk_prepare_enable(pit_clk));\r\nclk_rate = clk_get_rate(pit_clk);\r\ncycle_per_jiffy = clk_rate / (HZ);\r\n__raw_writel(~PITMCR_MDIS, timer_base + PITMCR);\r\nBUG_ON(pit_clocksource_init(clk_rate));\r\npit_clockevent_init(clk_rate, irq);\r\n}

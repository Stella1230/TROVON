static struct sk_buff **tcp6_gro_receive(struct sk_buff **head,\r\nstruct sk_buff *skb)\r\n{\r\nif (!NAPI_GRO_CB(skb)->flush &&\r\nskb_gro_checksum_validate(skb, IPPROTO_TCP,\r\nip6_gro_compute_pseudo)) {\r\nNAPI_GRO_CB(skb)->flush = 1;\r\nreturn NULL;\r\n}\r\nreturn tcp_gro_receive(head, skb);\r\n}\r\nstatic int tcp6_gro_complete(struct sk_buff *skb, int thoff)\r\n{\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nstruct tcphdr *th = tcp_hdr(skb);\r\nth->check = ~tcp_v6_check(skb->len - thoff, &iph->saddr,\r\n&iph->daddr, 0);\r\nskb_shinfo(skb)->gso_type |= SKB_GSO_TCPV6;\r\nreturn tcp_gro_complete(skb);\r\n}\r\nstruct sk_buff *tcp6_gso_segment(struct sk_buff *skb,\r\nnetdev_features_t features)\r\n{\r\nstruct tcphdr *th;\r\nif (!pskb_may_pull(skb, sizeof(*th)))\r\nreturn ERR_PTR(-EINVAL);\r\nif (unlikely(skb->ip_summed != CHECKSUM_PARTIAL)) {\r\nconst struct ipv6hdr *ipv6h = ipv6_hdr(skb);\r\nstruct tcphdr *th = tcp_hdr(skb);\r\nth->check = 0;\r\nskb->ip_summed = CHECKSUM_PARTIAL;\r\n__tcp_v6_send_check(skb, &ipv6h->saddr, &ipv6h->daddr);\r\n}\r\nreturn tcp_gso_segment(skb, features);\r\n}\r\nint __init tcpv6_offload_init(void)\r\n{\r\nreturn inet6_add_offload(&tcpv6_offload, IPPROTO_TCP);\r\n}

void vfio_spapr_pci_eeh_open(struct pci_dev *pdev)\r\n{\r\neeh_dev_open(pdev);\r\n}\r\nvoid vfio_spapr_pci_eeh_release(struct pci_dev *pdev)\r\n{\r\neeh_dev_release(pdev);\r\n}\r\nlong vfio_spapr_iommu_eeh_ioctl(struct iommu_group *group,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct eeh_pe *pe;\r\nstruct vfio_eeh_pe_op op;\r\nunsigned long minsz;\r\nlong ret = -EINVAL;\r\nswitch (cmd) {\r\ncase VFIO_CHECK_EXTENSION:\r\nif (arg == VFIO_EEH)\r\nret = eeh_enabled() ? 1 : 0;\r\nelse\r\nret = 0;\r\nbreak;\r\ncase VFIO_EEH_PE_OP:\r\npe = eeh_iommu_group_to_pe(group);\r\nif (!pe)\r\nreturn -ENODEV;\r\nminsz = offsetofend(struct vfio_eeh_pe_op, op);\r\nif (copy_from_user(&op, (void __user *)arg, minsz))\r\nreturn -EFAULT;\r\nif (op.argsz < minsz || op.flags)\r\nreturn -EINVAL;\r\nswitch (op.op) {\r\ncase VFIO_EEH_PE_DISABLE:\r\nret = eeh_pe_set_option(pe, EEH_OPT_DISABLE);\r\nbreak;\r\ncase VFIO_EEH_PE_ENABLE:\r\nret = eeh_pe_set_option(pe, EEH_OPT_ENABLE);\r\nbreak;\r\ncase VFIO_EEH_PE_UNFREEZE_IO:\r\nret = eeh_pe_set_option(pe, EEH_OPT_THAW_MMIO);\r\nbreak;\r\ncase VFIO_EEH_PE_UNFREEZE_DMA:\r\nret = eeh_pe_set_option(pe, EEH_OPT_THAW_DMA);\r\nbreak;\r\ncase VFIO_EEH_PE_GET_STATE:\r\nret = eeh_pe_get_state(pe);\r\nbreak;\r\ncase VFIO_EEH_PE_RESET_DEACTIVATE:\r\nret = eeh_pe_reset(pe, EEH_RESET_DEACTIVATE);\r\nbreak;\r\ncase VFIO_EEH_PE_RESET_HOT:\r\nret = eeh_pe_reset(pe, EEH_RESET_HOT);\r\nbreak;\r\ncase VFIO_EEH_PE_RESET_FUNDAMENTAL:\r\nret = eeh_pe_reset(pe, EEH_RESET_FUNDAMENTAL);\r\nbreak;\r\ncase VFIO_EEH_PE_CONFIGURE:\r\nret = eeh_pe_configure(pe);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\n}\r\nreturn ret;\r\n}

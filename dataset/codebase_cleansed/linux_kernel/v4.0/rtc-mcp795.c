static int mcp795_rtcc_read(struct device *dev, u8 addr, u8 *buf, u8 count)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\nu8 tx[2];\r\ntx[0] = MCP795_READ;\r\ntx[1] = addr;\r\nret = spi_write_then_read(spi, tx, sizeof(tx), buf, count);\r\nif (ret)\r\ndev_err(dev, "Failed reading %d bytes from address %x.\n",\r\ncount, addr);\r\nreturn ret;\r\n}\r\nstatic int mcp795_rtcc_write(struct device *dev, u8 addr, u8 *data, u8 count)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\nu8 tx[2 + count];\r\ntx[0] = MCP795_WRITE;\r\ntx[1] = addr;\r\nmemcpy(&tx[2], data, count);\r\nret = spi_write(spi, tx, 2 + count);\r\nif (ret)\r\ndev_err(dev, "Failed to write %d bytes to address %x.\n",\r\ncount, addr);\r\nreturn ret;\r\n}\r\nstatic int mcp795_rtcc_set_bits(struct device *dev, u8 addr, u8 mask, u8 state)\r\n{\r\nint ret;\r\nu8 tmp;\r\nret = mcp795_rtcc_read(dev, addr, &tmp, 1);\r\nif (ret)\r\nreturn ret;\r\nif ((tmp & mask) != state) {\r\ntmp = (tmp & ~mask) | state;\r\nret = mcp795_rtcc_write(dev, addr, &tmp, 1);\r\n}\r\nreturn ret;\r\n}\r\nstatic int mcp795_set_time(struct device *dev, struct rtc_time *tim)\r\n{\r\nint ret;\r\nu8 data[7];\r\nret = mcp795_rtcc_read(dev, 0x01, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\ndata[0] = (data[0] & 0x80) | ((tim->tm_sec / 10) << 4) | (tim->tm_sec % 10);\r\ndata[1] = (data[1] & 0x80) | ((tim->tm_min / 10) << 4) | (tim->tm_min % 10);\r\ndata[2] = ((tim->tm_hour / 10) << 4) | (tim->tm_hour % 10);\r\ndata[4] = ((tim->tm_mday / 10) << 4) | ((tim->tm_mday) % 10);\r\ndata[5] = (data[5] & 0x10) | (tim->tm_mon / 10) | (tim->tm_mon % 10);\r\nif (tim->tm_year > 100)\r\ntim->tm_year -= 100;\r\ndata[6] = ((tim->tm_year / 10) << 4) | (tim->tm_year % 10);\r\nret = mcp795_rtcc_write(dev, 0x01, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(dev, "Set mcp795: %04d-%02d-%02d %02d:%02d:%02d\n",\r\ntim->tm_year + 1900, tim->tm_mon, tim->tm_mday,\r\ntim->tm_hour, tim->tm_min, tim->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int mcp795_read_time(struct device *dev, struct rtc_time *tim)\r\n{\r\nint ret;\r\nu8 data[7];\r\nret = mcp795_rtcc_read(dev, 0x01, data, sizeof(data));\r\nif (ret)\r\nreturn ret;\r\ntim->tm_sec = ((data[0] & 0x70) >> 4) * 10 + (data[0] & 0x0f);\r\ntim->tm_min = ((data[1] & 0x70) >> 4) * 10 + (data[1] & 0x0f);\r\ntim->tm_hour = ((data[2] & 0x30) >> 4) * 10 + (data[2] & 0x0f);\r\ntim->tm_mday = ((data[4] & 0x30) >> 4) * 10 + (data[4] & 0x0f);\r\ntim->tm_mon = ((data[5] & 0x10) >> 4) * 10 + (data[5] & 0x0f);\r\ntim->tm_year = ((data[6] & 0xf0) >> 4) * 10 + (data[6] & 0x0f) + 100;\r\ndev_dbg(dev, "Read from mcp795: %04d-%02d-%02d %02d:%02d:%02d\n",\r\ntim->tm_year + 1900, tim->tm_mon, tim->tm_mday,\r\ntim->tm_hour, tim->tm_min, tim->tm_sec);\r\nreturn rtc_valid_tm(tim);\r\n}\r\nstatic int mcp795_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nint ret;\r\nspi->mode = SPI_MODE_0;\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret) {\r\ndev_err(&spi->dev, "Unable to setup SPI\n");\r\nreturn ret;\r\n}\r\nmcp795_rtcc_set_bits(&spi->dev, 0x01, MCP795_ST_BIT, MCP795_ST_BIT);\r\nmcp795_rtcc_set_bits(&spi->dev, 0x03, MCP795_24_BIT, 0);\r\nrtc = devm_rtc_device_register(&spi->dev, "rtc-mcp795",\r\n&mcp795_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nspi_set_drvdata(spi, rtc);\r\nreturn 0;\r\n}

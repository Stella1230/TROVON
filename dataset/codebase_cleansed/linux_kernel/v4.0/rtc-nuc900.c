static irqreturn_t nuc900_rtc_interrupt(int irq, void *_rtc)\r\n{\r\nstruct nuc900_rtc *rtc = _rtc;\r\nunsigned long events = 0, rtc_irq;\r\nrtc_irq = __raw_readl(rtc->rtc_reg + REG_RTC_RIIR);\r\nif (rtc_irq & ALARMINTENB) {\r\nrtc_irq &= ~ALARMINTENB;\r\n__raw_writel(rtc_irq, rtc->rtc_reg + REG_RTC_RIIR);\r\nevents |= RTC_AF | RTC_IRQF;\r\n}\r\nif (rtc_irq & TICKINTENB) {\r\nrtc_irq &= ~TICKINTENB;\r\n__raw_writel(rtc_irq, rtc->rtc_reg + REG_RTC_RIIR);\r\nevents |= RTC_UF | RTC_IRQF;\r\n}\r\nrtc_update_irq(rtc->rtcdev, 1, events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int *check_rtc_access_enable(struct nuc900_rtc *nuc900_rtc)\r\n{\r\nunsigned int timeout = 0x1000;\r\n__raw_writel(INIRRESET, nuc900_rtc->rtc_reg + REG_RTC_INIR);\r\nmdelay(10);\r\n__raw_writel(AERPOWERON, nuc900_rtc->rtc_reg + REG_RTC_AER);\r\nwhile (!(__raw_readl(nuc900_rtc->rtc_reg + REG_RTC_AER) & AERRWENB)\r\n&& timeout--)\r\nmdelay(1);\r\nif (!timeout)\r\nreturn ERR_PTR(-EPERM);\r\nreturn NULL;\r\n}\r\nstatic int nuc900_rtc_bcd2bin(unsigned int timereg,\r\nunsigned int calreg, struct rtc_time *tm)\r\n{\r\ntm->tm_mday = bcd2bin(calreg >> 0);\r\ntm->tm_mon = bcd2bin(calreg >> 8);\r\ntm->tm_year = bcd2bin(calreg >> 16) + 100;\r\ntm->tm_sec = bcd2bin(timereg >> 0);\r\ntm->tm_min = bcd2bin(timereg >> 8);\r\ntm->tm_hour = bcd2bin(timereg >> 16);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic void nuc900_rtc_bin2bcd(struct device *dev, struct rtc_time *settm,\r\nstruct nuc900_bcd_time *gettm)\r\n{\r\ngettm->bcd_mday = bin2bcd(settm->tm_mday) << 0;\r\ngettm->bcd_mon = bin2bcd(settm->tm_mon) << 8;\r\nif (settm->tm_year < 100) {\r\ndev_warn(dev, "The year will be between 1970-1999, right?\n");\r\ngettm->bcd_year = bin2bcd(settm->tm_year) << 16;\r\n} else {\r\ngettm->bcd_year = bin2bcd(settm->tm_year - 100) << 16;\r\n}\r\ngettm->bcd_sec = bin2bcd(settm->tm_sec) << 0;\r\ngettm->bcd_min = bin2bcd(settm->tm_min) << 8;\r\ngettm->bcd_hour = bin2bcd(settm->tm_hour) << 16;\r\n}\r\nstatic int nuc900_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct nuc900_rtc *rtc = dev_get_drvdata(dev);\r\nif (enabled)\r\n__raw_writel(__raw_readl(rtc->rtc_reg + REG_RTC_RIER)|\r\n(ALARMINTENB), rtc->rtc_reg + REG_RTC_RIER);\r\nelse\r\n__raw_writel(__raw_readl(rtc->rtc_reg + REG_RTC_RIER)&\r\n(~ALARMINTENB), rtc->rtc_reg + REG_RTC_RIER);\r\nreturn 0;\r\n}\r\nstatic int nuc900_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct nuc900_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned int timeval, clrval;\r\ntimeval = __raw_readl(rtc->rtc_reg + REG_RTC_TLR);\r\nclrval = __raw_readl(rtc->rtc_reg + REG_RTC_CLR);\r\nreturn nuc900_rtc_bcd2bin(timeval, clrval, tm);\r\n}\r\nstatic int nuc900_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct nuc900_rtc *rtc = dev_get_drvdata(dev);\r\nstruct nuc900_bcd_time gettm;\r\nunsigned long val;\r\nint *err;\r\nnuc900_rtc_bin2bcd(dev, tm, &gettm);\r\nerr = check_rtc_access_enable(rtc);\r\nif (IS_ERR(err))\r\nreturn PTR_ERR(err);\r\nval = gettm.bcd_mday | gettm.bcd_mon | gettm.bcd_year;\r\n__raw_writel(val, rtc->rtc_reg + REG_RTC_CLR);\r\nval = gettm.bcd_sec | gettm.bcd_min | gettm.bcd_hour;\r\n__raw_writel(val, rtc->rtc_reg + REG_RTC_TLR);\r\nreturn 0;\r\n}\r\nstatic int nuc900_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct nuc900_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned int timeval, carval;\r\ntimeval = __raw_readl(rtc->rtc_reg + REG_RTC_TAR);\r\ncarval = __raw_readl(rtc->rtc_reg + REG_RTC_CAR);\r\nreturn nuc900_rtc_bcd2bin(timeval, carval, &alrm->time);\r\n}\r\nstatic int nuc900_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct nuc900_rtc *rtc = dev_get_drvdata(dev);\r\nstruct nuc900_bcd_time tm;\r\nunsigned long val;\r\nint *err;\r\nnuc900_rtc_bin2bcd(dev, &alrm->time, &tm);\r\nerr = check_rtc_access_enable(rtc);\r\nif (IS_ERR(err))\r\nreturn PTR_ERR(err);\r\nval = tm.bcd_mday | tm.bcd_mon | tm.bcd_year;\r\n__raw_writel(val, rtc->rtc_reg + REG_RTC_CAR);\r\nval = tm.bcd_sec | tm.bcd_min | tm.bcd_hour;\r\n__raw_writel(val, rtc->rtc_reg + REG_RTC_TAR);\r\nreturn 0;\r\n}\r\nstatic int __init nuc900_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct nuc900_rtc *nuc900_rtc;\r\nnuc900_rtc = devm_kzalloc(&pdev->dev, sizeof(struct nuc900_rtc),\r\nGFP_KERNEL);\r\nif (!nuc900_rtc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nnuc900_rtc->rtc_reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(nuc900_rtc->rtc_reg))\r\nreturn PTR_ERR(nuc900_rtc->rtc_reg);\r\nplatform_set_drvdata(pdev, nuc900_rtc);\r\nnuc900_rtc->rtcdev = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&nuc900_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(nuc900_rtc->rtcdev)) {\r\ndev_err(&pdev->dev, "rtc device register failed\n");\r\nreturn PTR_ERR(nuc900_rtc->rtcdev);\r\n}\r\n__raw_writel(__raw_readl(nuc900_rtc->rtc_reg + REG_RTC_TSSR) | MODE24,\r\nnuc900_rtc->rtc_reg + REG_RTC_TSSR);\r\nnuc900_rtc->irq_num = platform_get_irq(pdev, 0);\r\nif (devm_request_irq(&pdev->dev, nuc900_rtc->irq_num,\r\nnuc900_rtc_interrupt, 0, "nuc900rtc", nuc900_rtc)) {\r\ndev_err(&pdev->dev, "NUC900 RTC request irq failed\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}

static inline struct device *to_da903x_dev(struct regulator_dev *rdev)\r\n{\r\nreturn rdev_get_dev(rdev)->parent->parent;\r\n}\r\nstatic inline int check_range(struct da903x_regulator_info *info,\r\nint min_uV, int max_uV)\r\n{\r\nif (min_uV < info->desc.min_uV || min_uV > info->max_uV)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int da903x_set_voltage_sel(struct regulator_dev *rdev, unsigned selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nif (rdev->desc->n_voltages == 1)\r\nreturn -EINVAL;\r\nval = selector << info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nreturn da903x_update(da9034_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da903x_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nif (rdev->desc->n_voltages == 1)\r\nreturn 0;\r\nret = da903x_read(da9034_dev, info->vol_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval = (val & mask) >> info->vol_shift;\r\nreturn val;\r\n}\r\nstatic int da903x_enable(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nreturn da903x_set_bits(da9034_dev, info->enable_reg,\r\n1 << info->enable_bit);\r\n}\r\nstatic int da903x_disable(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nreturn da903x_clr_bits(da9034_dev, info->enable_reg,\r\n1 << info->enable_bit);\r\n}\r\nstatic int da903x_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t reg_val;\r\nint ret;\r\nret = da903x_read(da9034_dev, info->enable_reg, &reg_val);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(reg_val & (1 << info->enable_bit));\r\n}\r\nstatic int da9030_set_ldo1_15_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da903x_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nval = selector << info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval |= DA9030_LDO_UNLOCK;\r\nmask |= DA9030_LDO_UNLOCK_MASK;\r\nret = da903x_update(da903x_dev, info->vol_reg, val, mask);\r\nif (ret)\r\nreturn ret;\r\nreturn da903x_update(da903x_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da9030_map_ldo14_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nint thresh, sel;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nthresh = (info->max_uV + info->desc.min_uV) / 2;\r\nif (min_uV < thresh) {\r\nsel = DIV_ROUND_UP(thresh - min_uV, info->desc.uV_step);\r\nsel |= 0x4;\r\n} else {\r\nsel = DIV_ROUND_UP(min_uV - thresh, info->desc.uV_step);\r\n}\r\nreturn sel;\r\n}\r\nstatic int da9030_list_ldo14_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nint volt;\r\nif (selector & 0x4)\r\nvolt = rdev->desc->min_uV +\r\nrdev->desc->uV_step * (3 - (selector & ~0x4));\r\nelse\r\nvolt = (info->max_uV + rdev->desc->min_uV) / 2 +\r\nrdev->desc->uV_step * (selector & ~0x4);\r\nif (volt > info->max_uV)\r\nreturn -EINVAL;\r\nreturn volt;\r\n}\r\nstatic int da9034_set_dvc_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nval = selector << info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nret = da903x_update(da9034_dev, info->vol_reg, val, mask);\r\nif (ret)\r\nreturn ret;\r\nret = da903x_set_bits(da9034_dev, info->update_reg,\r\n1 << info->update_bit);\r\nreturn ret;\r\n}\r\nstatic inline struct da903x_regulator_info *find_regulator_info(int id)\r\n{\r\nstruct da903x_regulator_info *ri;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(da903x_regulator_info); i++) {\r\nri = &da903x_regulator_info[i];\r\nif (ri->desc.id == id)\r\nreturn ri;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int da903x_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct da903x_regulator_info *ri = NULL;\r\nstruct regulator_dev *rdev;\r\nstruct regulator_config config = { };\r\nri = find_regulator_info(pdev->id);\r\nif (ri == NULL) {\r\ndev_err(&pdev->dev, "invalid regulator ID specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (ri->desc.id == DA9034_ID_LDO12) {\r\nri->desc.ops = &da9034_regulator_ldo12_ops;\r\nri->desc.n_voltages = 16;\r\nri->desc.linear_ranges = da9034_ldo12_ranges;\r\nri->desc.n_linear_ranges = ARRAY_SIZE(da9034_ldo12_ranges);\r\n}\r\nif (ri->desc.id == DA9030_ID_LDO14)\r\nri->desc.ops = &da9030_regulator_ldo14_ops;\r\nif (ri->desc.id == DA9030_ID_LDO1 || ri->desc.id == DA9030_ID_LDO15)\r\nri->desc.ops = &da9030_regulator_ldo1_15_ops;\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = dev_get_platdata(&pdev->dev);\r\nconfig.driver_data = ri;\r\nrdev = devm_regulator_register(&pdev->dev, &ri->desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __init da903x_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&da903x_regulator_driver);\r\n}\r\nstatic void __exit da903x_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&da903x_regulator_driver);\r\n}

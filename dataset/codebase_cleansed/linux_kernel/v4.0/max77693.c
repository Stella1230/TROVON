static int max77693_chg_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nunsigned int val;\r\nret = regmap_read(rdev->regmap, rdev->desc->enable_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & rdev->desc->enable_mask) == rdev->desc->enable_mask;\r\n}\r\nstatic int max77693_chg_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nunsigned int chg_min_uA = rdev->constraints->min_uA;\r\nunsigned int chg_max_uA = rdev->constraints->max_uA;\r\nunsigned int reg, sel;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(rdev->regmap, MAX77693_CHG_REG_CHG_CNFG_09, &reg);\r\nif (ret < 0)\r\nreturn ret;\r\nsel = reg & CHG_CNFG_09_CHGIN_ILIM_MASK;\r\nif (sel <= 3)\r\nsel = 0;\r\nelse\r\nsel -= 3;\r\nval = chg_min_uA + CHGIN_ILIM_STEP_20mA * sel;\r\nif (val > chg_max_uA)\r\nreturn -EINVAL;\r\nreturn val;\r\n}\r\nstatic int max77693_chg_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nunsigned int chg_min_uA = rdev->constraints->min_uA;\r\nint sel = 0;\r\nwhile (chg_min_uA + CHGIN_ILIM_STEP_20mA * sel < min_uA)\r\nsel++;\r\nif (chg_min_uA + CHGIN_ILIM_STEP_20mA * sel > max_uA)\r\nreturn -EINVAL;\r\nsel += 3;\r\nreturn regmap_write(rdev->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_09, sel);\r\n}\r\nstatic int max77693_pmic_dt_parse_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nstruct device_node *np;\r\nstruct of_regulator_match *rmatch;\r\nstruct max77693_regulator_data *tmp;\r\nint i, matched = 0;\r\nnp = of_get_child_by_name(dev->parent->of_node, "regulators");\r\nif (!np)\r\nreturn -EINVAL;\r\nrmatch = devm_kzalloc(dev,\r\nsizeof(*rmatch) * ARRAY_SIZE(regulators), GFP_KERNEL);\r\nif (!rmatch) {\r\nof_node_put(np);\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(regulators); i++)\r\nrmatch[i].name = regulators[i].name;\r\nmatched = of_regulator_match(dev, np, rmatch, ARRAY_SIZE(regulators));\r\nof_node_put(np);\r\nif (matched <= 0)\r\nreturn matched;\r\n*rdata = devm_kzalloc(dev, sizeof(**rdata) * matched, GFP_KERNEL);\r\nif (!(*rdata))\r\nreturn -ENOMEM;\r\ntmp = *rdata;\r\nfor (i = 0; i < matched; i++) {\r\ntmp->initdata = rmatch[i].init_data;\r\ntmp->of_node = rmatch[i].of_node;\r\ntmp->id = regulators[i].id;\r\ntmp++;\r\n}\r\nreturn matched;\r\n}\r\nstatic int max77693_pmic_dt_parse_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic int max77693_pmic_init_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nstruct max77693_platform_data *pdata;\r\nint num_regulators = 0;\r\npdata = dev_get_platdata(dev->parent);\r\nif (pdata) {\r\n*rdata = pdata->regulators;\r\nnum_regulators = pdata->num_regulators;\r\n}\r\nif (!(*rdata) && dev->parent->of_node)\r\nnum_regulators = max77693_pmic_dt_parse_rdata(dev, rdata);\r\nreturn num_regulators;\r\n}\r\nstatic int max77693_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct max77693_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77693_regulator_data *rdata = NULL;\r\nint num_rdata, i;\r\nstruct regulator_config config = { };\r\nnum_rdata = max77693_pmic_init_rdata(&pdev->dev, &rdata);\r\nif (!rdata || num_rdata <= 0) {\r\ndev_err(&pdev->dev, "No init data supplied.\n");\r\nreturn -ENODEV;\r\n}\r\nconfig.dev = &pdev->dev;\r\nconfig.regmap = iodev->regmap;\r\nfor (i = 0; i < num_rdata; i++) {\r\nint id = rdata[i].id;\r\nstruct regulator_dev *rdev;\r\nconfig.init_data = rdata[i].initdata;\r\nconfig.of_node = rdata[i].of_node;\r\nrdev = devm_regulator_register(&pdev->dev,\r\n&regulators[id], &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev,\r\n"Failed to initialize regulator-%d\n", id);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}

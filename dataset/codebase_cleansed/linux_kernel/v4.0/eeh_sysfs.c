static ssize_t eeh_pe_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(pdev);\r\nint state;\r\nif (!edev || !edev->pe)\r\nreturn -ENODEV;\r\nstate = eeh_ops->get_state(edev->pe, NULL);\r\nreturn sprintf(buf, "0x%08x 0x%08x\n",\r\nstate, edev->pe->state);\r\n}\r\nstatic ssize_t eeh_pe_state_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(pdev);\r\nif (!edev || !edev->pe)\r\nreturn -ENODEV;\r\nif (!(edev->pe->state & EEH_PE_ISOLATED))\r\nreturn count;\r\nif (eeh_unfreeze_pe(edev->pe, true))\r\nreturn -EIO;\r\nreturn count;\r\n}\r\nvoid eeh_sysfs_add_device(struct pci_dev *pdev)\r\n{\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(pdev);\r\nint rc=0;\r\nif (!eeh_enabled())\r\nreturn;\r\nif (edev && (edev->mode & EEH_DEV_SYSFS))\r\nreturn;\r\nrc += device_create_file(&pdev->dev, &dev_attr_eeh_mode);\r\nrc += device_create_file(&pdev->dev, &dev_attr_eeh_config_addr);\r\nrc += device_create_file(&pdev->dev, &dev_attr_eeh_pe_config_addr);\r\nrc += device_create_file(&pdev->dev, &dev_attr_eeh_pe_state);\r\nif (rc)\r\npr_warn("EEH: Unable to create sysfs entries\n");\r\nelse if (edev)\r\nedev->mode |= EEH_DEV_SYSFS;\r\n}\r\nvoid eeh_sysfs_remove_device(struct pci_dev *pdev)\r\n{\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(pdev);\r\nif (!pdev->dev.kobj.sd) {\r\nif (edev)\r\nedev->mode &= ~EEH_DEV_SYSFS;\r\nreturn;\r\n}\r\ndevice_remove_file(&pdev->dev, &dev_attr_eeh_mode);\r\ndevice_remove_file(&pdev->dev, &dev_attr_eeh_config_addr);\r\ndevice_remove_file(&pdev->dev, &dev_attr_eeh_pe_config_addr);\r\ndevice_remove_file(&pdev->dev, &dev_attr_eeh_pe_state);\r\nif (edev)\r\nedev->mode &= ~EEH_DEV_SYSFS;\r\n}

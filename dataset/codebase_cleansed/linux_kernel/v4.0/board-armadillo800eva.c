static int usbhsf_get_id(struct platform_device *pdev)\r\n{\r\nreturn USBHS_GADGET;\r\n}\r\nstatic int usbhsf_power_ctrl(struct platform_device *pdev,\r\nvoid __iomem *base, int enable)\r\n{\r\nstruct usbhsf_private *priv = usbhsf_get_priv(pdev);\r\nif (enable) {\r\nclk_enable(priv->usb24);\r\nclk_enable(priv->pci);\r\nclk_enable(priv->host);\r\nclk_enable(priv->func);\r\nclk_enable(priv->phy);\r\n__raw_writew(0xd750, USBCR1);\r\nmdelay(1);\r\n__raw_writel(0x0000000c, priv->usbh_base + USBH_USBCTR);\r\n__raw_writel(0x00000008, priv->usbh_base + USBH_USBCTR);\r\nmdelay(10);\r\n__raw_writew(0xd770, USBCR1);\r\n__raw_writew(0x4000, base + 0x102);\r\n} else {\r\n__raw_writel(0x0000010f, priv->usbh_base + USBH_USBCTR);\r\n__raw_writew(0xd7c0, USBCR1);\r\nclk_disable(priv->phy);\r\nclk_disable(priv->func);\r\nclk_disable(priv->host);\r\nclk_disable(priv->pci);\r\nclk_disable(priv->usb24);\r\n}\r\nreturn 0;\r\n}\r\nstatic int usbhsf_get_vbus(struct platform_device *pdev)\r\n{\r\nreturn gpio_get_value(209);\r\n}\r\nstatic irqreturn_t usbhsf_interrupt(int irq, void *data)\r\n{\r\nstruct platform_device *pdev = data;\r\nrenesas_usbhs_call_notify_hotplug(pdev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int usbhsf_hardware_exit(struct platform_device *pdev)\r\n{\r\nstruct usbhsf_private *priv = usbhsf_get_priv(pdev);\r\nif (!IS_ERR(priv->phy))\r\nclk_put(priv->phy);\r\nif (!IS_ERR(priv->usb24))\r\nclk_put(priv->usb24);\r\nif (!IS_ERR(priv->pci))\r\nclk_put(priv->pci);\r\nif (!IS_ERR(priv->host))\r\nclk_put(priv->host);\r\nif (!IS_ERR(priv->func))\r\nclk_put(priv->func);\r\nif (priv->usbh_base)\r\niounmap(priv->usbh_base);\r\npriv->phy = NULL;\r\npriv->usb24 = NULL;\r\npriv->pci = NULL;\r\npriv->host = NULL;\r\npriv->func = NULL;\r\npriv->usbh_base = NULL;\r\nfree_irq(IRQ7, pdev);\r\nreturn 0;\r\n}\r\nstatic int usbhsf_hardware_init(struct platform_device *pdev)\r\n{\r\nstruct usbhsf_private *priv = usbhsf_get_priv(pdev);\r\nint ret;\r\npriv->phy = clk_get(&pdev->dev, "phy");\r\npriv->usb24 = clk_get(&pdev->dev, "usb24");\r\npriv->pci = clk_get(&pdev->dev, "pci");\r\npriv->func = clk_get(&pdev->dev, "func");\r\npriv->host = clk_get(&pdev->dev, "host");\r\npriv->usbh_base = ioremap_nocache(USBH, 0x20000);\r\nif (IS_ERR(priv->phy) ||\r\nIS_ERR(priv->usb24) ||\r\nIS_ERR(priv->pci) ||\r\nIS_ERR(priv->host) ||\r\nIS_ERR(priv->func) ||\r\n!priv->usbh_base) {\r\ndev_err(&pdev->dev, "USB clock setting failed\n");\r\nusbhsf_hardware_exit(pdev);\r\nreturn -EIO;\r\n}\r\nret = request_irq(IRQ7, usbhsf_interrupt, IRQF_TRIGGER_NONE,\r\ndev_name(&pdev->dev), pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "request_irq err\n");\r\nreturn ret;\r\n}\r\nirq_set_irq_type(IRQ7, IRQ_TYPE_EDGE_BOTH);\r\nclk_set_rate(priv->usb24,\r\nclk_get_rate(clk_get_parent(priv->usb24)));\r\nreturn 0;\r\n}\r\nstatic int mt9t111_power(struct device *dev, int mode)\r\n{\r\nstruct clk *mclk = clk_get(NULL, "video1");\r\nif (IS_ERR(mclk)) {\r\ndev_err(dev, "can't get video1 clock\n");\r\nreturn -EINVAL;\r\n}\r\nif (mode) {\r\nclk_set_rate(mclk, clk_round_rate(mclk, 24000000));\r\nclk_enable(mclk);\r\ngpio_set_value(158, 1);\r\n} else {\r\ngpio_set_value(158, 0);\r\nclk_disable(mclk);\r\n}\r\nclk_put(mclk);\r\nreturn 0;\r\n}\r\nstatic void __init eva_clock_init(void)\r\n{\r\nstruct clk *system = clk_get(NULL, "system_clk");\r\nstruct clk *xtal1 = clk_get(NULL, "extal1");\r\nstruct clk *usb24s = clk_get(NULL, "usb24s");\r\nstruct clk *fsibck = clk_get(NULL, "fsibck");\r\nif (IS_ERR(system) ||\r\nIS_ERR(xtal1) ||\r\nIS_ERR(usb24s) ||\r\nIS_ERR(fsibck)) {\r\npr_err("armadillo800eva board clock init failed\n");\r\ngoto clock_error;\r\n}\r\nclk_set_rate(xtal1, 24000000);\r\nclk_set_parent(usb24s, system);\r\nclk_set_rate(fsibck, 12288000);\r\nclock_error:\r\nif (!IS_ERR(system))\r\nclk_put(system);\r\nif (!IS_ERR(xtal1))\r\nclk_put(xtal1);\r\nif (!IS_ERR(usb24s))\r\nclk_put(usb24s);\r\nif (!IS_ERR(fsibck))\r\nclk_put(fsibck);\r\n}\r\nstatic void __init eva_init(void)\r\n{\r\nstatic struct pm_domain_device domain_devices[] __initdata = {\r\n{ "A4LC", &lcdc0_device },\r\n{ "A4LC", &hdmi_lcdc_device },\r\n{ "A4MP", &hdmi_device },\r\n{ "A4MP", &fsi_device },\r\n{ "A4R", &ceu0_device },\r\n{ "A4S", &sh_eth_device },\r\n{ "A3SP", &pwm_device },\r\n{ "A3SP", &sdhi0_device },\r\n{ "A3SP", &sh_mmcif_device },\r\n};\r\nstruct platform_device *usb = NULL, *sdhi1 = NULL;\r\nregulator_register_always_on(0, "fixed-3.3V", fixed3v3_power_consumers,\r\nARRAY_SIZE(fixed3v3_power_consumers), 3300000);\r\nregulator_register_always_on(3, "fixed-5.0V", fixed5v0_power_consumers,\r\nARRAY_SIZE(fixed5v0_power_consumers), 5000000);\r\npinctrl_register_mappings(eva_pinctrl_map, ARRAY_SIZE(eva_pinctrl_map));\r\npwm_add_table(pwm_lookup, ARRAY_SIZE(pwm_lookup));\r\nr8a7740_pinmux_init();\r\nr8a7740_meram_workaround();\r\ngpio_request_one(18, GPIOF_OUT_INIT_HIGH, NULL);\r\ngpio_request_one(159, GPIOF_IN, NULL);\r\nif (gpio_get_value(159)) {\r\n} else {\r\ngpio_request_one(209, GPIOF_IN, NULL);\r\nplatform_device_register(&usbhsf_device);\r\nusb = &usbhsf_device;\r\n}\r\ngpio_request_one(173, GPIOF_OUT_INIT_LOW, NULL);\r\ngpio_request_one(172, GPIOF_OUT_INIT_HIGH, NULL);\r\ngpio_request_one(158, GPIOF_OUT_INIT_LOW, NULL);\r\ngpio_request(7, NULL);\r\ngpio_request(8, NULL);\r\ngpio_direction_none(GPIO_PORT7CR);\r\ngpio_direction_none(GPIO_PORT8CR);\r\ngpio_request_one(176, GPIOF_OUT_INIT_HIGH, NULL);\r\ngpio_request_one(6, GPIOF_IN, NULL);\r\nif (gpio_get_value(6)) {\r\n} else {\r\npinctrl_register_mappings(eva_sdhi1_pinctrl_map,\r\nARRAY_SIZE(eva_sdhi1_pinctrl_map));\r\nplatform_device_register(&vcc_sdhi1);\r\nplatform_device_register(&sdhi1_device);\r\nsdhi1 = &sdhi1_device;\r\n}\r\n#ifdef CONFIG_CACHE_L2X0\r\nl2x0_init(IOMEM(0xf0002000), 0x00400000, 0xc20f0fff);\r\n#endif\r\ni2c_register_board_info(0, i2c0_devices, ARRAY_SIZE(i2c0_devices));\r\ni2c_register_board_info(2, i2c2_devices, ARRAY_SIZE(i2c2_devices));\r\nr8a7740_add_standard_devices();\r\nplatform_add_devices(eva_devices,\r\nARRAY_SIZE(eva_devices));\r\nrmobile_add_devices_to_domains(domain_devices,\r\nARRAY_SIZE(domain_devices));\r\nif (usb)\r\nrmobile_add_device_to_domain("A3SP", usb);\r\nif (sdhi1)\r\nrmobile_add_device_to_domain("A3SP", sdhi1);\r\nr8a7740_pm_init();\r\n}\r\nstatic void __init eva_earlytimer_init(void)\r\n{\r\nr8a7740_clock_init(MD_CK0 | MD_CK2);\r\nshmobile_earlytimer_init();\r\neva_clock_init();\r\n}\r\nstatic void eva_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nwritel((1 << 31), RESCNT2);\r\n}

static void rts5227_fill_driving(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nu8 driving_3v3[4][3] = {\r\n{0x13, 0x13, 0x13},\r\n{0x96, 0x96, 0x96},\r\n{0x7F, 0x7F, 0x7F},\r\n{0x96, 0x96, 0x96},\r\n};\r\nu8 driving_1v8[4][3] = {\r\n{0x99, 0x99, 0x99},\r\n{0xAA, 0xAA, 0xAA},\r\n{0xFE, 0xFE, 0xFE},\r\n{0xB3, 0xB3, 0xB3},\r\n};\r\nu8 (*driving)[3], drive_sel;\r\nif (voltage == OUTPUT_3V3) {\r\ndriving = driving_3v3;\r\ndrive_sel = pcr->sd30_drive_sel_3v3;\r\n} else {\r\ndriving = driving_1v8;\r\ndrive_sel = pcr->sd30_drive_sel_1v8;\r\n}\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CLK_DRIVE_SEL,\r\n0xFF, driving[drive_sel][0]);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CMD_DRIVE_SEL,\r\n0xFF, driving[drive_sel][1]);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DAT_DRIVE_SEL,\r\n0xFF, driving[drive_sel][2]);\r\n}\r\nstatic void rts5227_fetch_vendor_settings(struct rtsx_pcr *pcr)\r\n{\r\nu32 reg;\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG1, &reg);\r\ndev_dbg(&(pcr->pci->dev), "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG1, reg);\r\nif (!rtsx_vendor_setting_valid(reg))\r\nreturn;\r\npcr->aspm_en = rtsx_reg_to_aspm(reg);\r\npcr->sd30_drive_sel_1v8 = rtsx_reg_to_sd30_drive_sel_1v8(reg);\r\npcr->card_drive_sel &= 0x3F;\r\npcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG2, &reg);\r\ndev_dbg(&(pcr->pci->dev), "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG2, reg);\r\npcr->sd30_drive_sel_3v3 = rtsx_reg_to_sd30_drive_sel_3v3(reg);\r\nif (rtsx_reg_check_reverse_socket(reg))\r\npcr->flags |= PCR_REVERSE_SOCKET;\r\n}\r\nstatic void rts5227_force_power_down(struct rtsx_pcr *pcr, u8 pm_state)\r\n{\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 1, 0xFF, 0);\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 2, 0xFF, 0);\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 3, 0x01, 0);\r\nif (pm_state == HOST_ENTER_S3)\r\nrtsx_pci_write_register(pcr, PM_CTRL3, 0x10, 0x10);\r\nrtsx_pci_write_register(pcr, FPDCTL, 0x03, 0x03);\r\n}\r\nstatic int rts5227_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nu16 cap;\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\r\npcie_capability_read_word(pcr->pci, PCI_EXP_DEVCTL2, &cap);\r\nif (cap & PCI_EXP_DEVCTL2_LTR_EN)\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LTR_CTL, 0xFF, 0xA3);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OBFF_CFG, 0x03, 0x03);\r\nrts5227_fill_driving(pcr, OUTPUT_3V3);\r\nif (pcr->flags & PCR_REVERSE_SOCKET)\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nAUTOLOAD_CFG_BASE + 3, 0xB8, 0xB8);\r\nelse\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nAUTOLOAD_CFG_BASE + 3, 0xB8, 0x88);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PM_CTRL3, 0x10, 0x00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5227_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nint err;\r\nerr = rtsx_gops_pm_reset(pcr);\r\nif (err < 0)\r\nreturn err;\r\nreturn rtsx_pci_write_phy_register(pcr, 0x00, 0xBA42);\r\n}\r\nstatic int rts5227_turn_on_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\r\n}\r\nstatic int rts5227_turn_off_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\r\n}\r\nstatic int rts5227_enable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\r\n}\r\nstatic int rts5227_disable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\r\n}\r\nstatic int rts5227_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_PARTIAL_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x02);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nudelay(150);\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x06);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int rts5227_card_power_off(struct rtsx_pcr *pcr, int card)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK | PMOS_STRG_MASK,\r\nSD_POWER_OFF | PMOS_STRG_400mA);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0X00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5227_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nint err;\r\nif (voltage == OUTPUT_3V3) {\r\nerr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4FC0 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\n} else if (voltage == OUTPUT_1V8) {\r\nerr = rtsx_pci_write_phy_register(pcr, 0x11, 0x3C02);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4C80 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrts5227_fill_driving(pcr, voltage);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nvoid rts5227_init_params(struct rtsx_pcr *pcr)\r\n{\r\npcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\r\npcr->num_slots = 2;\r\npcr->ops = &rts5227_pcr_ops;\r\npcr->flags = 0;\r\npcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\r\npcr->sd30_drive_sel_1v8 = CFG_DRIVER_TYPE_B;\r\npcr->sd30_drive_sel_3v3 = CFG_DRIVER_TYPE_B;\r\npcr->aspm_en = ASPM_L1_EN;\r\npcr->tx_initial_phase = SET_CLOCK_PHASE(27, 27, 15);\r\npcr->rx_initial_phase = SET_CLOCK_PHASE(30, 7, 7);\r\npcr->sd_pull_ctl_enable_tbl = rts5227_sd_pull_ctl_enable_tbl;\r\npcr->sd_pull_ctl_disable_tbl = rts5227_sd_pull_ctl_disable_tbl;\r\npcr->ms_pull_ctl_enable_tbl = rts5227_ms_pull_ctl_enable_tbl;\r\npcr->ms_pull_ctl_disable_tbl = rts5227_ms_pull_ctl_disable_tbl;\r\n}

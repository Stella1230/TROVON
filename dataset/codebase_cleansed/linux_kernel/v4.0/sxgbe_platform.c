static int sxgbe_probe_config_dt(struct platform_device *pdev,\r\nstruct sxgbe_plat_data *plat,\r\nconst char **mac)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct sxgbe_dma_cfg *dma_cfg;\r\nif (!np)\r\nreturn -ENODEV;\r\n*mac = of_get_mac_address(np);\r\nplat->interface = of_get_phy_mode(np);\r\nplat->bus_id = of_alias_get_id(np, "ethernet");\r\nif (plat->bus_id < 0)\r\nplat->bus_id = 0;\r\nplat->mdio_bus_data = devm_kzalloc(&pdev->dev,\r\nsizeof(*plat->mdio_bus_data),\r\nGFP_KERNEL);\r\ndma_cfg = devm_kzalloc(&pdev->dev, sizeof(*dma_cfg), GFP_KERNEL);\r\nif (!dma_cfg)\r\nreturn -ENOMEM;\r\nplat->dma_cfg = dma_cfg;\r\nof_property_read_u32(np, "samsung,pbl", &dma_cfg->pbl);\r\nif (of_property_read_u32(np, "samsung,burst-map", &dma_cfg->burst_map) == 0)\r\ndma_cfg->fixed_burst = true;\r\nreturn 0;\r\n}\r\nstatic int sxgbe_probe_config_dt(struct platform_device *pdev,\r\nstruct sxgbe_plat_data *plat,\r\nconst char **mac)\r\n{\r\nreturn -ENOSYS;\r\n}\r\nstatic int sxgbe_platform_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nint i, chan;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nvoid __iomem *addr;\r\nstruct sxgbe_priv_data *priv = NULL;\r\nstruct sxgbe_plat_data *plat_dat = NULL;\r\nconst char *mac = NULL;\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nstruct device_node *node = dev->of_node;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\naddr = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(addr))\r\nreturn PTR_ERR(addr);\r\nif (pdev->dev.of_node) {\r\nplat_dat = devm_kzalloc(&pdev->dev,\r\nsizeof(struct sxgbe_plat_data),\r\nGFP_KERNEL);\r\nif (!plat_dat)\r\nreturn -ENOMEM;\r\nret = sxgbe_probe_config_dt(pdev, plat_dat, &mac);\r\nif (ret) {\r\npr_err("%s: main dt probe failed\n", __func__);\r\nreturn ret;\r\n}\r\n}\r\npriv = sxgbe_drv_probe(&(pdev->dev), plat_dat, addr);\r\nif (!priv) {\r\npr_err("%s: main driver probe failed\n", __func__);\r\ngoto err_out;\r\n}\r\npriv->irq = irq_of_parse_and_map(node, 0);\r\nif (priv->irq <= 0) {\r\ndev_err(dev, "sxgbe common irq parsing failed\n");\r\ngoto err_drv_remove;\r\n}\r\nif (mac)\r\nether_addr_copy(priv->dev->dev_addr, mac);\r\nfor (i = 0, chan = 1; i < SXGBE_TX_QUEUES; i++) {\r\npriv->txq[i]->irq_no = irq_of_parse_and_map(node, chan++);\r\nif (priv->txq[i]->irq_no <= 0) {\r\ndev_err(dev, "sxgbe tx irq parsing failed\n");\r\ngoto err_tx_irq_unmap;\r\n}\r\n}\r\nfor (i = 0; i < SXGBE_RX_QUEUES; i++) {\r\npriv->rxq[i]->irq_no = irq_of_parse_and_map(node, chan++);\r\nif (priv->rxq[i]->irq_no <= 0) {\r\ndev_err(dev, "sxgbe rx irq parsing failed\n");\r\ngoto err_rx_irq_unmap;\r\n}\r\n}\r\npriv->lpi_irq = irq_of_parse_and_map(node, chan);\r\nif (priv->lpi_irq <= 0) {\r\ndev_err(dev, "sxgbe lpi irq parsing failed\n");\r\ngoto err_rx_irq_unmap;\r\n}\r\nplatform_set_drvdata(pdev, priv->dev);\r\npr_debug("platform driver registration completed\n");\r\nreturn 0;\r\nerr_rx_irq_unmap:\r\nwhile (--i)\r\nirq_dispose_mapping(priv->rxq[i]->irq_no);\r\ni = SXGBE_TX_QUEUES;\r\nerr_tx_irq_unmap:\r\nwhile (--i)\r\nirq_dispose_mapping(priv->txq[i]->irq_no);\r\nirq_dispose_mapping(priv->irq);\r\nerr_drv_remove:\r\nsxgbe_drv_remove(ndev);\r\nerr_out:\r\nreturn -ENODEV;\r\n}\r\nstatic int sxgbe_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *ndev = platform_get_drvdata(pdev);\r\nint ret = sxgbe_drv_remove(ndev);\r\nreturn ret;\r\n}\r\nstatic int sxgbe_platform_suspend(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nreturn sxgbe_suspend(ndev);\r\n}\r\nstatic int sxgbe_platform_resume(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nreturn sxgbe_resume(ndev);\r\n}\r\nstatic int sxgbe_platform_freeze(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nreturn sxgbe_freeze(ndev);\r\n}\r\nstatic int sxgbe_platform_restore(struct device *dev)\r\n{\r\nstruct net_device *ndev = dev_get_drvdata(dev);\r\nreturn sxgbe_restore(ndev);\r\n}\r\nint sxgbe_register_platform(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&sxgbe_platform_driver);\r\nif (err)\r\npr_err("failed to register the platform driver\n");\r\nreturn err;\r\n}\r\nvoid sxgbe_unregister_platform(void)\r\n{\r\nplatform_driver_unregister(&sxgbe_platform_driver);\r\n}

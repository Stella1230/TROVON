int r8a7778_usb_phy_power(bool enable)\r\n{\r\nstatic struct usb_phy *phy = NULL;\r\nint ret = 0;\r\nif (!phy)\r\nphy = usb_get_phy(USB_PHY_TYPE_USB2);\r\nif (IS_ERR(phy)) {\r\npr_err("kernel doesn't have usb phy driver\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nif (enable)\r\nret = usb_phy_init(phy);\r\nelse\r\nusb_phy_shutdown(phy);\r\nreturn ret;\r\n}\r\nstatic int usb_power_on(struct platform_device *pdev)\r\n{\r\nint ret = r8a7778_usb_phy_power(true);\r\nif (ret)\r\nreturn ret;\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_get_sync(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic void usb_power_off(struct platform_device *pdev)\r\n{\r\nif (r8a7778_usb_phy_power(false))\r\nreturn;\r\npm_runtime_put_sync(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\n}\r\nstatic int ehci_init_internal_buffer(struct usb_hcd *hcd)\r\n{\r\niowrite32(0x00ff0040, hcd->regs + 0x0094);\r\niowrite32(0x00000001, hcd->regs + 0x009C);\r\nreturn 0;\r\n}\r\nvoid __init r8a7778_pinmux_init(void)\r\n{\r\nplatform_device_register_simple(\r\n"pfc-r8a7778", -1,\r\npfc_resources,\r\nARRAY_SIZE(pfc_resources));\r\nr8a7778_register_gpio(0);\r\nr8a7778_register_gpio(1);\r\nr8a7778_register_gpio(2);\r\nr8a7778_register_gpio(3);\r\nr8a7778_register_gpio(4);\r\n}\r\nstatic void __init r8a7778_register_i2c(int id)\r\n{\r\nBUG_ON(id < 0 || id > 3);\r\nplatform_device_register_simple(\r\n"i2c-rcar", id,\r\ni2c_resources + (2 * id), 2);\r\n}\r\nstatic void __init r8a7778_register_hspi(int id)\r\n{\r\nBUG_ON(id < 0 || id > 2);\r\nplatform_device_register_simple(\r\n"sh-hspi", id,\r\nhspi_resources + (2 * id), 2);\r\n}\r\nvoid __init r8a7778_add_dt_devices(void)\r\n{\r\n#ifdef CONFIG_CACHE_L2X0\r\nvoid __iomem *base = ioremap_nocache(0xf0100000, 0x1000);\r\nif (base) {\r\nl2x0_init(base, 0x00400000, 0xc20f0fff);\r\n}\r\n#endif\r\n}\r\nstatic void __init r8a7778_register_hpb_dmae(void)\r\n{\r\nplatform_device_register_resndata(NULL, "hpb-dma-engine",\r\n-1, hpb_dmae_resources,\r\nARRAY_SIZE(hpb_dmae_resources),\r\n&dma_platform_data,\r\nsizeof(dma_platform_data));\r\n}\r\nvoid __init r8a7778_add_standard_devices(void)\r\n{\r\nr8a7778_add_dt_devices();\r\nr8a7778_register_tmu(0);\r\nr8a7778_register_scif(0);\r\nr8a7778_register_scif(1);\r\nr8a7778_register_scif(2);\r\nr8a7778_register_scif(3);\r\nr8a7778_register_scif(4);\r\nr8a7778_register_scif(5);\r\nr8a7778_register_i2c(0);\r\nr8a7778_register_i2c(1);\r\nr8a7778_register_i2c(2);\r\nr8a7778_register_i2c(3);\r\nr8a7778_register_hspi(0);\r\nr8a7778_register_hspi(1);\r\nr8a7778_register_hspi(2);\r\nr8a7778_register_hpb_dmae();\r\n}\r\nvoid __init r8a7778_init_late(void)\r\n{\r\nshmobile_init_late();\r\nplatform_device_register_full(&ehci_info);\r\nplatform_device_register_full(&ohci_info);\r\n}\r\nvoid __init r8a7778_init_irq_extpin_dt(int irlm)\r\n{\r\nvoid __iomem *icr0 = ioremap_nocache(0xfe780000, PAGE_SIZE);\r\nunsigned long tmp;\r\nif (!icr0) {\r\npr_warn("r8a7778: unable to setup external irq pin mode\n");\r\nreturn;\r\n}\r\ntmp = ioread32(icr0);\r\nif (irlm)\r\ntmp |= 1 << 23;\r\nelse\r\ntmp &= ~(1 << 23);\r\ntmp |= (1 << 21);\r\niowrite32(tmp, icr0);\r\niounmap(icr0);\r\n}\r\nvoid __init r8a7778_init_irq_extpin(int irlm)\r\n{\r\nr8a7778_init_irq_extpin_dt(irlm);\r\nif (irlm)\r\nplatform_device_register_resndata(\r\nNULL, "renesas_intc_irqpin", -1,\r\nirqpin_resources, ARRAY_SIZE(irqpin_resources),\r\n&irqpin_platform_data, sizeof(irqpin_platform_data));\r\n}\r\nvoid __init r8a7778_init_irq_dt(void)\r\n{\r\nvoid __iomem *base = ioremap_nocache(0xfe700000, 0x00100000);\r\n#ifdef CONFIG_ARCH_SHMOBILE_LEGACY\r\nvoid __iomem *gic_dist_base = ioremap_nocache(0xfe438000, 0x1000);\r\nvoid __iomem *gic_cpu_base = ioremap_nocache(0xfe430000, 0x1000);\r\n#endif\r\nBUG_ON(!base);\r\n#ifdef CONFIG_ARCH_SHMOBILE_LEGACY\r\ngic_init(0, 29, gic_dist_base, gic_cpu_base);\r\n#else\r\nirqchip_init();\r\n#endif\r\n__raw_writel(0x73ffffff, base + INT2NTSR0);\r\n__raw_writel(0xffffffff, base + INT2NTSR1);\r\n__raw_writel(0x08330773, base + INT2SMSKCR0);\r\n__raw_writel(0x00311110, base + INT2SMSKCR1);\r\niounmap(base);\r\n}

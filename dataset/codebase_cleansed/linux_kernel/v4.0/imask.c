static inline void set_interrupt_registers(int ip)\r\n{\r\nunsigned long __dummy;\r\nasm volatile(\r\n#ifdef CONFIG_CPU_HAS_SR_RB\r\n"ldc %2, r6_bank\n\t"\r\n#endif\r\n"stc sr, %0\n\t"\r\n"and #0xf0, %0\n\t"\r\n"shlr2 %0\n\t"\r\n"cmp/eq #0x3c, %0\n\t"\r\n"bt/s 1f ! CLI-ed\n\t"\r\n" stc sr, %0\n\t"\r\n"and %1, %0\n\t"\r\n"or %2, %0\n\t"\r\n"ldc %0, sr\n"\r\n"1:"\r\n: "=&z" (__dummy)\r\n: "r" (~0xf0), "r" (ip << 4)\r\n: "t");\r\n}\r\nstatic void mask_imask_irq(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nclear_bit(irq, imask_mask);\r\nif (interrupt_priority < IMASK_PRIORITY - irq)\r\ninterrupt_priority = IMASK_PRIORITY - irq;\r\nset_interrupt_registers(interrupt_priority);\r\n}\r\nstatic void unmask_imask_irq(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nset_bit(irq, imask_mask);\r\ninterrupt_priority = IMASK_PRIORITY -\r\nfind_first_zero_bit(imask_mask, IMASK_PRIORITY);\r\nset_interrupt_registers(interrupt_priority);\r\n}\r\nvoid make_imask_irq(unsigned int irq)\r\n{\r\nirq_set_chip_and_handler_name(irq, &imask_irq_chip, handle_level_irq,\r\n"level");\r\n}

static int dln2_i2c_enable(struct dln2_i2c *dln2, bool enable)\r\n{\r\nu16 cmd;\r\nstruct {\r\nu8 port;\r\n} tx;\r\ntx.port = dln2->port;\r\nif (enable)\r\ncmd = DLN2_I2C_ENABLE;\r\nelse\r\ncmd = DLN2_I2C_DISABLE;\r\nreturn dln2_transfer_tx(dln2->pdev, cmd, &tx, sizeof(tx));\r\n}\r\nstatic int dln2_i2c_write(struct dln2_i2c *dln2, u8 addr,\r\nu8 *data, u16 data_len)\r\n{\r\nint ret;\r\nstruct {\r\nu8 port;\r\nu8 addr;\r\nu8 mem_addr_len;\r\n__le32 mem_addr;\r\n__le16 buf_len;\r\nu8 buf[DLN2_I2C_MAX_XFER_SIZE];\r\n} __packed *tx = dln2->buf;\r\nunsigned len;\r\nBUILD_BUG_ON(sizeof(*tx) > DLN2_I2C_BUF_SIZE);\r\ntx->port = dln2->port;\r\ntx->addr = addr;\r\ntx->mem_addr_len = 0;\r\ntx->mem_addr = 0;\r\ntx->buf_len = cpu_to_le16(data_len);\r\nmemcpy(tx->buf, data, data_len);\r\nlen = sizeof(*tx) + data_len - DLN2_I2C_MAX_XFER_SIZE;\r\nret = dln2_transfer_tx(dln2->pdev, DLN2_I2C_WRITE, tx, len);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn data_len;\r\n}\r\nstatic int dln2_i2c_read(struct dln2_i2c *dln2, u16 addr, u8 *data,\r\nu16 data_len)\r\n{\r\nint ret;\r\nstruct {\r\nu8 port;\r\nu8 addr;\r\nu8 mem_addr_len;\r\n__le32 mem_addr;\r\n__le16 buf_len;\r\n} __packed tx;\r\nstruct {\r\n__le16 buf_len;\r\nu8 buf[DLN2_I2C_MAX_XFER_SIZE];\r\n} __packed *rx = dln2->buf;\r\nunsigned rx_len = sizeof(*rx);\r\nBUILD_BUG_ON(sizeof(*rx) > DLN2_I2C_BUF_SIZE);\r\ntx.port = dln2->port;\r\ntx.addr = addr;\r\ntx.mem_addr_len = 0;\r\ntx.mem_addr = 0;\r\ntx.buf_len = cpu_to_le16(data_len);\r\nret = dln2_transfer(dln2->pdev, DLN2_I2C_READ, &tx, sizeof(tx),\r\nrx, &rx_len);\r\nif (ret < 0)\r\nreturn ret;\r\nif (rx_len < sizeof(rx->buf_len) + data_len)\r\nreturn -EPROTO;\r\nif (le16_to_cpu(rx->buf_len) != data_len)\r\nreturn -EPROTO;\r\nmemcpy(data, rx->buf, data_len);\r\nreturn data_len;\r\n}\r\nstatic int dln2_i2c_xfer(struct i2c_adapter *adapter,\r\nstruct i2c_msg *msgs, int num)\r\n{\r\nstruct dln2_i2c *dln2 = i2c_get_adapdata(adapter);\r\nstruct i2c_msg *pmsg;\r\nstruct device *dev = &dln2->adapter.dev;\r\nint i;\r\nfor (i = 0; i < num; i++) {\r\nint ret;\r\npmsg = &msgs[i];\r\nif (pmsg->len > DLN2_I2C_MAX_XFER_SIZE) {\r\ndev_warn(dev, "maximum transfer size exceeded\n");\r\nreturn -EOPNOTSUPP;\r\n}\r\nif (pmsg->flags & I2C_M_RD) {\r\nret = dln2_i2c_read(dln2, pmsg->addr, pmsg->buf,\r\npmsg->len);\r\nif (ret < 0)\r\nreturn ret;\r\npmsg->len = ret;\r\n} else {\r\nret = dln2_i2c_write(dln2, pmsg->addr, pmsg->buf,\r\npmsg->len);\r\nif (ret != pmsg->len)\r\nreturn -EPROTO;\r\n}\r\n}\r\nreturn num;\r\n}\r\nstatic u32 dln2_i2c_func(struct i2c_adapter *a)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_BYTE | I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA | I2C_FUNC_SMBUS_BLOCK_PROC_CALL |\r\nI2C_FUNC_SMBUS_I2C_BLOCK;\r\n}\r\nstatic int dln2_i2c_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct dln2_i2c *dln2;\r\nstruct device *dev = &pdev->dev;\r\nstruct dln2_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\ndln2 = devm_kzalloc(dev, sizeof(*dln2), GFP_KERNEL);\r\nif (!dln2)\r\nreturn -ENOMEM;\r\ndln2->buf = devm_kmalloc(dev, DLN2_I2C_BUF_SIZE, GFP_KERNEL);\r\nif (!dln2->buf)\r\nreturn -ENOMEM;\r\ndln2->pdev = pdev;\r\ndln2->port = pdata->port;\r\ndln2->adapter.owner = THIS_MODULE;\r\ndln2->adapter.class = I2C_CLASS_HWMON;\r\ndln2->adapter.algo = &dln2_i2c_usb_algorithm;\r\ndln2->adapter.dev.parent = dev;\r\ni2c_set_adapdata(&dln2->adapter, dln2);\r\nsnprintf(dln2->adapter.name, sizeof(dln2->adapter.name), "%s-%s-%d",\r\n"dln2-i2c", dev_name(pdev->dev.parent), dln2->port);\r\nplatform_set_drvdata(pdev, dln2);\r\nret = dln2_i2c_enable(dln2, true);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to initialize adapter: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = i2c_add_adapter(&dln2->adapter);\r\nif (ret < 0) {\r\ndev_err(dev, "failed to add I2C adapter: %d\n", ret);\r\ngoto out_disable;\r\n}\r\nreturn 0;\r\nout_disable:\r\ndln2_i2c_enable(dln2, false);\r\nreturn ret;\r\n}\r\nstatic int dln2_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct dln2_i2c *dln2 = platform_get_drvdata(pdev);\r\ni2c_del_adapter(&dln2->adapter);\r\ndln2_i2c_enable(dln2, false);\r\nreturn 0;\r\n}

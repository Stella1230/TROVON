static int stih41x_usb_phy_init(struct phy *phy)\r\n{\r\nstruct stih41x_usb_phy *phy_dev = phy_get_drvdata(phy);\r\nreturn regmap_update_bits(phy_dev->regmap, phy_dev->cfg->syscfg,\r\nphy_dev->cfg->cfg_mask, phy_dev->cfg->cfg);\r\n}\r\nstatic int stih41x_usb_phy_power_on(struct phy *phy)\r\n{\r\nstruct stih41x_usb_phy *phy_dev = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_prepare_enable(phy_dev->clk);\r\nif (ret) {\r\ndev_err(phy_dev->dev, "Failed to enable osc_phy clock\n");\r\nreturn ret;\r\n}\r\nreturn regmap_update_bits(phy_dev->regmap, phy_dev->cfg->syscfg,\r\nphy_dev->cfg->oscok, phy_dev->cfg->oscok);\r\n}\r\nstatic int stih41x_usb_phy_power_off(struct phy *phy)\r\n{\r\nstruct stih41x_usb_phy *phy_dev = phy_get_drvdata(phy);\r\nint ret;\r\nret = regmap_update_bits(phy_dev->regmap, phy_dev->cfg->syscfg,\r\nphy_dev->cfg->oscok, 0);\r\nif (ret) {\r\ndev_err(phy_dev->dev, "Failed to clear oscok bit\n");\r\nreturn ret;\r\n}\r\nclk_disable_unprepare(phy_dev->clk);\r\nreturn 0;\r\n}\r\nstatic int stih41x_usb_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst struct of_device_id *match;\r\nstruct stih41x_usb_phy *phy_dev;\r\nstruct device *dev = &pdev->dev;\r\nstruct phy_provider *phy_provider;\r\nstruct phy *phy;\r\nphy_dev = devm_kzalloc(dev, sizeof(*phy_dev), GFP_KERNEL);\r\nif (!phy_dev)\r\nreturn -ENOMEM;\r\nmatch = of_match_device(stih41x_usb_phy_of_match, &pdev->dev);\r\nif (!match)\r\nreturn -ENODEV;\r\nphy_dev->cfg = match->data;\r\nphy_dev->regmap = syscon_regmap_lookup_by_phandle(np, "st,syscfg");\r\nif (IS_ERR(phy_dev->regmap)) {\r\ndev_err(dev, "No syscfg phandle specified\n");\r\nreturn PTR_ERR(phy_dev->regmap);\r\n}\r\nphy_dev->clk = devm_clk_get(dev, "osc_phy");\r\nif (IS_ERR(phy_dev->clk)) {\r\ndev_err(dev, "osc_phy clk not found\n");\r\nreturn PTR_ERR(phy_dev->clk);\r\n}\r\nphy = devm_phy_create(dev, NULL, &stih41x_usb_phy_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(dev, "failed to create phy\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nphy_dev->dev = dev;\r\nphy_set_drvdata(phy, phy_dev);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

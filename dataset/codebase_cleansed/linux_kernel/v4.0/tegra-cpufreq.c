static unsigned int tegra_get_intermediate(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nunsigned int ifreq = clk_get_rate(pll_p_clk) / 1000;\r\nif ((freq_table[index].frequency == ifreq) || (policy->cur == ifreq))\r\nreturn 0;\r\nreturn ifreq;\r\n}\r\nstatic int tegra_target_intermediate(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nint ret;\r\nclk_prepare_enable(pll_x_clk);\r\nret = clk_set_parent(cpu_clk, pll_p_clk);\r\nif (ret)\r\nclk_disable_unprepare(pll_x_clk);\r\nelse\r\npll_x_prepared = true;\r\nreturn ret;\r\n}\r\nstatic int tegra_target(struct cpufreq_policy *policy, unsigned int index)\r\n{\r\nunsigned long rate = freq_table[index].frequency;\r\nunsigned int ifreq = clk_get_rate(pll_p_clk) / 1000;\r\nint ret = 0;\r\nif (rate >= 816000)\r\nclk_set_rate(emc_clk, 600000000);\r\nelse if (rate >= 456000)\r\nclk_set_rate(emc_clk, 300000000);\r\nelse\r\nclk_set_rate(emc_clk, 100000000);\r\nif (rate == ifreq)\r\nreturn clk_set_parent(cpu_clk, pll_p_clk);\r\nret = clk_set_rate(pll_x_clk, rate * 1000);\r\nif (ret)\r\npr_err("Failed to change pll_x to %lu\n", rate);\r\nret = clk_set_parent(cpu_clk, pll_x_clk);\r\nWARN_ON(ret);\r\nif (pll_x_prepared) {\r\nclk_disable_unprepare(pll_x_clk);\r\npll_x_prepared = false;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tegra_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nint ret;\r\nif (policy->cpu >= NUM_CPUS)\r\nreturn -EINVAL;\r\nclk_prepare_enable(emc_clk);\r\nclk_prepare_enable(cpu_clk);\r\nret = cpufreq_generic_init(policy, freq_table, 300 * 1000);\r\nif (ret) {\r\nclk_disable_unprepare(cpu_clk);\r\nclk_disable_unprepare(emc_clk);\r\nreturn ret;\r\n}\r\npolicy->clk = cpu_clk;\r\npolicy->suspend_freq = freq_table[0].frequency;\r\nreturn 0;\r\n}\r\nstatic int tegra_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\nclk_disable_unprepare(cpu_clk);\r\nclk_disable_unprepare(emc_clk);\r\nreturn 0;\r\n}\r\nstatic int __init tegra_cpufreq_init(void)\r\n{\r\ncpu_clk = clk_get_sys(NULL, "cclk");\r\nif (IS_ERR(cpu_clk))\r\nreturn PTR_ERR(cpu_clk);\r\npll_x_clk = clk_get_sys(NULL, "pll_x");\r\nif (IS_ERR(pll_x_clk))\r\nreturn PTR_ERR(pll_x_clk);\r\npll_p_clk = clk_get_sys(NULL, "pll_p");\r\nif (IS_ERR(pll_p_clk))\r\nreturn PTR_ERR(pll_p_clk);\r\nemc_clk = clk_get_sys("cpu", "emc");\r\nif (IS_ERR(emc_clk)) {\r\nclk_put(cpu_clk);\r\nreturn PTR_ERR(emc_clk);\r\n}\r\nreturn cpufreq_register_driver(&tegra_cpufreq_driver);\r\n}\r\nstatic void __exit tegra_cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&tegra_cpufreq_driver);\r\nclk_put(emc_clk);\r\nclk_put(cpu_clk);\r\n}

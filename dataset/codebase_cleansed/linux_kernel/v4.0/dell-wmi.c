static void dell_wmi_process_key(int reported_key)\r\n{\r\nconst struct key_entry *key;\r\nkey = sparse_keymap_entry_from_scancode(dell_wmi_input_dev,\r\nreported_key);\r\nif (!key) {\r\npr_info("Unknown key %x pressed\n", reported_key);\r\nreturn;\r\n}\r\npr_debug("Key %x pressed\n", reported_key);\r\nif ((key->keycode == KEY_BRIGHTNESSUP ||\r\nkey->keycode == KEY_BRIGHTNESSDOWN) && acpi_video)\r\nreturn;\r\nsparse_keymap_report_entry(dell_wmi_input_dev, key, 1, true);\r\n}\r\nstatic void dell_wmi_notify(u32 value, void *context)\r\n{\r\nstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nacpi_size buffer_size;\r\nu16 *buffer_entry, *buffer_end;\r\nint len, i;\r\nstatus = wmi_get_event_data(value, &response);\r\nif (status != AE_OK) {\r\npr_warn("bad event status 0x%x\n", status);\r\nreturn;\r\n}\r\nobj = (union acpi_object *)response.pointer;\r\nif (!obj) {\r\npr_warn("no response\n");\r\nreturn;\r\n}\r\nif (obj->type != ACPI_TYPE_BUFFER) {\r\npr_warn("bad response type %x\n", obj->type);\r\nkfree(obj);\r\nreturn;\r\n}\r\npr_debug("Received WMI event (%*ph)\n",\r\nobj->buffer.length, obj->buffer.pointer);\r\nbuffer_entry = (u16 *)obj->buffer.pointer;\r\nbuffer_size = obj->buffer.length/2;\r\nif (!dell_new_hk_type) {\r\nif (buffer_size >= 3 && buffer_entry[1] == 0x0)\r\ndell_wmi_process_key(buffer_entry[2]);\r\nelse if (buffer_size >= 2)\r\ndell_wmi_process_key(buffer_entry[1]);\r\nelse\r\npr_info("Received unknown WMI event\n");\r\nkfree(obj);\r\nreturn;\r\n}\r\nbuffer_end = buffer_entry + buffer_size;\r\nwhile (buffer_entry < buffer_end) {\r\nlen = buffer_entry[0];\r\nif (len == 0)\r\nbreak;\r\nlen++;\r\nif (buffer_entry + len > buffer_end) {\r\npr_warn("Invalid length of WMI event\n");\r\nbreak;\r\n}\r\npr_debug("Process buffer (%*ph)\n", len*2, buffer_entry);\r\nswitch (buffer_entry[1]) {\r\ncase 0x00:\r\nfor (i = 2; i < len; ++i) {\r\nswitch (buffer_entry[i]) {\r\ncase 0xe043:\r\npr_debug("NIC Link is Up\n");\r\nbreak;\r\ncase 0xe044:\r\npr_debug("NIC Link is Down\n");\r\nbreak;\r\ncase 0xe045:\r\ndefault:\r\npr_info("Unknown WMI event type 0x00: "\r\n"0x%x\n", (int)buffer_entry[i]);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase 0x10:\r\nfor (i = 2; i < len; ++i)\r\ndell_wmi_process_key(buffer_entry[i]);\r\nbreak;\r\ncase 0x11:\r\nfor (i = 2; i < len; ++i) {\r\nswitch (buffer_entry[i]) {\r\ncase 0xfff0:\r\npr_debug("Battery unplugged\n");\r\nbreak;\r\ncase 0xfff1:\r\npr_debug("Battery inserted\n");\r\nbreak;\r\ncase 0x01e1:\r\ncase 0x02ea:\r\ncase 0x02eb:\r\ncase 0x02ec:\r\ncase 0x02f6:\r\npr_debug("Keyboard backlight level "\r\n"changed\n");\r\nbreak;\r\ndefault:\r\npr_info("Unknown WMI event type 0x11: "\r\n"0x%x\n", (int)buffer_entry[i]);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\npr_info("Unknown WMI event type 0x%x\n",\r\n(int)buffer_entry[1]);\r\nbreak;\r\n}\r\nbuffer_entry += len;\r\n}\r\nkfree(obj);\r\n}\r\nstatic const struct key_entry * __init dell_wmi_prepare_new_keymap(void)\r\n{\r\nint hotkey_num = (dell_bios_hotkey_table->header.length - 4) /\r\nsizeof(struct dell_bios_keymap_entry);\r\nstruct key_entry *keymap;\r\nint i;\r\nkeymap = kcalloc(hotkey_num + 1, sizeof(struct key_entry), GFP_KERNEL);\r\nif (!keymap)\r\nreturn NULL;\r\nfor (i = 0; i < hotkey_num; i++) {\r\nconst struct dell_bios_keymap_entry *bios_entry =\r\n&dell_bios_hotkey_table->keymap[i];\r\nu16 keycode = bios_entry->keycode < 256 ?\r\nbios_to_linux_keycode[bios_entry->keycode] :\r\nKEY_RESERVED;\r\nif (keycode == KEY_KBDILLUMTOGGLE)\r\nkeymap[i].type = KE_IGNORE;\r\nelse\r\nkeymap[i].type = KE_KEY;\r\nkeymap[i].code = bios_entry->scancode;\r\nkeymap[i].keycode = keycode;\r\n}\r\nkeymap[hotkey_num].type = KE_END;\r\nreturn keymap;\r\n}\r\nstatic int __init dell_wmi_input_setup(void)\r\n{\r\nint err;\r\ndell_wmi_input_dev = input_allocate_device();\r\nif (!dell_wmi_input_dev)\r\nreturn -ENOMEM;\r\ndell_wmi_input_dev->name = "Dell WMI hotkeys";\r\ndell_wmi_input_dev->phys = "wmi/input0";\r\ndell_wmi_input_dev->id.bustype = BUS_HOST;\r\nif (dell_new_hk_type) {\r\nconst struct key_entry *keymap = dell_wmi_prepare_new_keymap();\r\nif (!keymap) {\r\nerr = -ENOMEM;\r\ngoto err_free_dev;\r\n}\r\nerr = sparse_keymap_setup(dell_wmi_input_dev, keymap, NULL);\r\nkfree(keymap);\r\n} else {\r\nerr = sparse_keymap_setup(dell_wmi_input_dev,\r\ndell_wmi_legacy_keymap, NULL);\r\n}\r\nif (err)\r\ngoto err_free_dev;\r\nerr = input_register_device(dell_wmi_input_dev);\r\nif (err)\r\ngoto err_free_keymap;\r\nreturn 0;\r\nerr_free_keymap:\r\nsparse_keymap_free(dell_wmi_input_dev);\r\nerr_free_dev:\r\ninput_free_device(dell_wmi_input_dev);\r\nreturn err;\r\n}\r\nstatic void dell_wmi_input_destroy(void)\r\n{\r\nsparse_keymap_free(dell_wmi_input_dev);\r\ninput_unregister_device(dell_wmi_input_dev);\r\n}\r\nstatic void __init find_hk_type(const struct dmi_header *dm, void *dummy)\r\n{\r\nif (dm->type == 0xb2 && dm->length > 6) {\r\ndell_new_hk_type = true;\r\ndell_bios_hotkey_table =\r\ncontainer_of(dm, struct dell_bios_hotkey_table, header);\r\n}\r\n}\r\nstatic int __init dell_wmi_init(void)\r\n{\r\nint err;\r\nacpi_status status;\r\nif (!wmi_has_guid(DELL_EVENT_GUID)) {\r\npr_warn("No known WMI GUID found\n");\r\nreturn -ENODEV;\r\n}\r\ndmi_walk(find_hk_type, NULL);\r\nacpi_video = acpi_video_backlight_support();\r\nerr = dell_wmi_input_setup();\r\nif (err)\r\nreturn err;\r\nstatus = wmi_install_notify_handler(DELL_EVENT_GUID,\r\ndell_wmi_notify, NULL);\r\nif (ACPI_FAILURE(status)) {\r\ndell_wmi_input_destroy();\r\npr_err("Unable to register notify handler - %d\n", status);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit dell_wmi_exit(void)\r\n{\r\nwmi_remove_notify_handler(DELL_EVENT_GUID);\r\ndell_wmi_input_destroy();\r\n}

static struct proc_dir_entry *\r\ncreateProcDir(char *name, struct proc_dir_entry *parent)\r\n{\r\nstruct proc_dir_entry *p = proc_mkdir_mode(name, S_IFDIR, parent);\r\nif (p == NULL)\r\nERRDRV("failed to create /proc directory %s", name);\r\nreturn p;\r\n}\r\nstatic int proc_open_driver(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, seq_show_driver, PDE_DATA(inode));\r\n}\r\nstatic int proc_open_device(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, seq_show_device, PDE_DATA(inode));\r\n}\r\nstatic int proc_open_device_property(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, seq_show_device_property, PDE_DATA(inode));\r\n}\r\nvoid visor_easyproc_InitDriver(struct easyproc_driver_info *pdriver,\r\nchar *procId,\r\nvoid (*show_driver_info)(struct seq_file *),\r\nvoid (*show_device_info)(struct seq_file *,\r\nvoid *))\r\n{\r\nmemset(pdriver, 0, sizeof(struct easyproc_driver_info));\r\npdriver->ProcId = procId;\r\nif (pdriver->ProcId == NULL)\r\nERRDRV("ProcId cannot be NULL (trouble ahead)!");\r\npdriver->Show_driver_info = show_driver_info;\r\npdriver->Show_device_info = show_device_info;\r\nif (pdriver->ProcDir == NULL)\r\npdriver->ProcDir = createProcDir(pdriver->ProcId, NULL);\r\nif ((pdriver->ProcDir != NULL) && (pdriver->ProcDriverDir == NULL))\r\npdriver->ProcDriverDir = createProcDir("driver",\r\npdriver->ProcDir);\r\nif ((pdriver->ProcDir != NULL) && (pdriver->ProcDeviceDir == NULL))\r\npdriver->ProcDeviceDir = createProcDir("device",\r\npdriver->ProcDir);\r\nif ((pdriver->ProcDriverDir != NULL) &&\r\n(pdriver->ProcDriverDiagFile == NULL)) {\r\npdriver->ProcDriverDiagFile =\r\nproc_create_data("diag", 0,\r\npdriver->ProcDriverDir,\r\n&proc_fops_driver, pdriver);\r\nif (pdriver->ProcDriverDiagFile == NULL)\r\nERRDRV("failed to register /proc/%s/driver/diag entry",\r\npdriver->ProcId);\r\n}\r\n}\r\nvoid visor_easyproc_InitDriverEx(struct easyproc_driver_info *pdriver,\r\nchar *procId,\r\nvoid (*show_driver_info)(struct seq_file *),\r\nvoid (*show_device_info)(struct seq_file *,\r\nvoid *),\r\nvoid (*write_driver_info)(char *buf,\r\nsize_t count,\r\nloff_t *ppos),\r\nvoid (*write_device_info)(char *buf,\r\nsize_t count,\r\nloff_t *ppos,\r\nvoid *p))\r\n{\r\nvisor_easyproc_InitDriver(pdriver, procId,\r\nshow_driver_info, show_device_info);\r\npdriver->Write_driver_info = write_driver_info;\r\npdriver->Write_device_info = write_device_info;\r\n}\r\nvoid visor_easyproc_DeInitDriver(struct easyproc_driver_info *pdriver)\r\n{\r\nif (pdriver->ProcDriverDiagFile != NULL) {\r\nremove_proc_entry("diag", pdriver->ProcDriverDir);\r\npdriver->ProcDriverDiagFile = NULL;\r\n}\r\nif (pdriver->ProcDriverDir != NULL) {\r\nremove_proc_entry("driver", pdriver->ProcDir);\r\npdriver->ProcDriverDir = NULL;\r\n}\r\nif (pdriver->ProcDeviceDir != NULL) {\r\nremove_proc_entry("device", pdriver->ProcDir);\r\npdriver->ProcDeviceDir = NULL;\r\n}\r\nif (pdriver->ProcDir != NULL) {\r\nremove_proc_entry(pdriver->ProcId, NULL);\r\npdriver->ProcDir = NULL;\r\n}\r\npdriver->ProcId = NULL;\r\npdriver->Show_driver_info = NULL;\r\npdriver->Show_device_info = NULL;\r\npdriver->Write_driver_info = NULL;\r\npdriver->Write_device_info = NULL;\r\n}\r\nvoid visor_easyproc_InitDevice(struct easyproc_driver_info *pdriver,\r\nstruct easyproc_device_info *p, int devno,\r\nvoid *devdata)\r\n{\r\nif ((pdriver->ProcDeviceDir != NULL) && (p->procDevicexDir == NULL)) {\r\nchar s[29];\r\nsprintf(s, "%d", devno);\r\np->procDevicexDir = createProcDir(s, pdriver->ProcDeviceDir);\r\np->devno = devno;\r\n}\r\np->devdata = devdata;\r\np->pdriver = pdriver;\r\np->devno = devno;\r\nif ((p->procDevicexDir != NULL) && (p->procDevicexDiagFile == NULL)) {\r\np->procDevicexDiagFile =\r\nproc_create_data("diag", 0, p->procDevicexDir,\r\n&proc_fops_device, p);\r\nif (p->procDevicexDiagFile == NULL)\r\nERRDEVX(devno, "failed to register /proc/%s/device/%d/diag entry",\r\npdriver->ProcId, devno\r\n);\r\n}\r\nmemset(&(p->device_property_info[0]), 0,\r\nsizeof(p->device_property_info));\r\n}\r\nvoid visor_easyproc_CreateDeviceProperty(struct easyproc_device_info *p,\r\nvoid (*show_property_info)\r\n(struct seq_file *, void *),\r\nchar *property_name)\r\n{\r\nsize_t i;\r\nstruct easyproc_device_property_info *px = NULL;\r\nif (p->procDevicexDir == NULL) {\r\nERRDRV("state error");\r\nreturn;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(p->device_property_info); i++) {\r\nif (p->device_property_info[i].procEntry == NULL) {\r\npx = &(p->device_property_info[i]);\r\nbreak;\r\n}\r\n}\r\nif (!px) {\r\nERRDEVX(p->devno, "too many device properties");\r\nreturn;\r\n}\r\npx->devdata = p->devdata;\r\npx->pdriver = p->pdriver;\r\npx->procEntry = proc_create_data(property_name, 0, p->procDevicexDir,\r\n&proc_fops_device_property, px);\r\nif (strlen(property_name)+1 > sizeof(px->property_name)) {\r\nERRDEVX(p->devno, "device property name %s too long",\r\nproperty_name);\r\nreturn;\r\n}\r\nstrcpy(px->property_name, property_name);\r\nif (px->procEntry == NULL) {\r\nERRDEVX(p->devno,\r\n"failed to register /proc/%s/device/%d/%s entry",\r\np->pdriver->ProcId, p->devno, property_name);\r\nreturn;\r\n}\r\npx->show_device_property_info = show_property_info;\r\n}\r\nvoid visor_easyproc_DeInitDevice(struct easyproc_driver_info *pdriver,\r\nstruct easyproc_device_info *p, int devno)\r\n{\r\nsize_t i;\r\nfor (i = 0; i < ARRAY_SIZE(p->device_property_info); i++) {\r\nif (p->device_property_info[i].procEntry != NULL) {\r\nstruct easyproc_device_property_info *px =\r\n&(p->device_property_info[i]);\r\nremove_proc_entry(px->property_name, p->procDevicexDir);\r\npx->procEntry = NULL;\r\n}\r\n}\r\nif (p->procDevicexDiagFile != NULL) {\r\nremove_proc_entry("diag", p->procDevicexDir);\r\np->procDevicexDiagFile = NULL;\r\n}\r\nif (p->procDevicexDir != NULL) {\r\nchar s[29];\r\nsprintf(s, "%d", devno);\r\nremove_proc_entry(s, pdriver->ProcDeviceDir);\r\np->procDevicexDir = NULL;\r\n}\r\np->devdata = NULL;\r\np->pdriver = NULL;\r\n}\r\nstatic int seq_show_driver(struct seq_file *seq, void *offset)\r\n{\r\nstruct easyproc_driver_info *p =\r\n(struct easyproc_driver_info *)(seq->private);\r\nif (!p)\r\nreturn 0;\r\n(*(p->Show_driver_info))(seq);\r\nreturn 0;\r\n}\r\nstatic int seq_show_device(struct seq_file *seq, void *offset)\r\n{\r\nstruct easyproc_device_info *p =\r\n(struct easyproc_device_info *)(seq->private);\r\nif ((!p) || (!(p->pdriver)))\r\nreturn 0;\r\n(*(p->pdriver->Show_device_info))(seq, p->devdata);\r\nreturn 0;\r\n}\r\nstatic int seq_show_device_property(struct seq_file *seq, void *offset)\r\n{\r\nstruct easyproc_device_property_info *p =\r\n(struct easyproc_device_property_info *)(seq->private);\r\nif ((!p) || (!(p->show_device_property_info)))\r\nreturn 0;\r\n(*(p->show_device_property_info))(seq, p->devdata);\r\nreturn 0;\r\n}\r\nstatic ssize_t proc_write_driver(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct seq_file *seq = (struct seq_file *)file->private_data;\r\nstruct easyproc_driver_info *p = NULL;\r\nchar local_buf[256];\r\nif (seq == NULL)\r\nreturn 0;\r\np = (struct easyproc_driver_info *)(seq->private);\r\nif ((!p) || (!(p->Write_driver_info)))\r\nreturn 0;\r\nif (count >= sizeof(local_buf))\r\nreturn -ENOMEM;\r\nif (copy_from_user(local_buf, buffer, count))\r\nreturn -EFAULT;\r\nlocal_buf[count] = '\0';\r\n(*(p->Write_driver_info))(local_buf, count, ppos);\r\nreturn count;\r\n}\r\nstatic ssize_t proc_write_device(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct seq_file *seq = (struct seq_file *)file->private_data;\r\nstruct easyproc_device_info *p = NULL;\r\nchar local_buf[256];\r\nif (seq == NULL)\r\nreturn 0;\r\np = (struct easyproc_device_info *)(seq->private);\r\nif ((!p) || (!(p->pdriver)) || (!(p->pdriver->Write_device_info)))\r\nreturn 0;\r\nif (count >= sizeof(local_buf))\r\nreturn -ENOMEM;\r\nif (copy_from_user(local_buf, buffer, count))\r\nreturn -EFAULT;\r\nlocal_buf[count] = '\0';\r\n(*(p->pdriver->Write_device_info))(local_buf, count, ppos, p->devdata);\r\nreturn count;\r\n}

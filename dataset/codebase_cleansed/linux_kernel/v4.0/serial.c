static int __init serial_init(void)\r\n{\r\nint i;\r\nunsigned char iotype;\r\niotype = uart8250_data[mips_machtype][0].iotype;\r\nif (UPIO_MEM == iotype) {\r\nuart8250_data[mips_machtype][0].mapbase =\r\nloongson_uart_base[0];\r\nuart8250_data[mips_machtype][0].membase =\r\n(void __iomem *)_loongson_uart_base[0];\r\n}\r\nelse if (UPIO_PORT == iotype)\r\nuart8250_data[mips_machtype][0].iobase =\r\nloongson_uart_base[0] - LOONGSON_PCIIO_BASE;\r\nif (loongson_sysconf.uarts[0].uartclk)\r\nuart8250_data[mips_machtype][0].uartclk =\r\nloongson_sysconf.uarts[0].uartclk;\r\nfor (i = 1; i < loongson_sysconf.nr_uarts; i++) {\r\niotype = loongson_sysconf.uarts[i].iotype;\r\nuart8250_data[mips_machtype][i].iotype = iotype;\r\nloongson_uart_base[i] = loongson_sysconf.uarts[i].uart_base;\r\nif (UPIO_MEM == iotype) {\r\nuart8250_data[mips_machtype][i].irq =\r\nMIPS_CPU_IRQ_BASE + loongson_sysconf.uarts[i].int_offset;\r\nuart8250_data[mips_machtype][i].mapbase =\r\nloongson_uart_base[i];\r\nuart8250_data[mips_machtype][i].membase =\r\nioremap_nocache(loongson_uart_base[i], 8);\r\n} else if (UPIO_PORT == iotype) {\r\nuart8250_data[mips_machtype][i].irq =\r\nloongson_sysconf.uarts[i].int_offset;\r\nuart8250_data[mips_machtype][i].iobase =\r\nloongson_uart_base[i] - LOONGSON_PCIIO_BASE;\r\n}\r\nuart8250_data[mips_machtype][i].uartclk =\r\nloongson_sysconf.uarts[i].uartclk;\r\nuart8250_data[mips_machtype][i].flags =\r\nUPF_BOOT_AUTOCONF | UPF_SKIP_TEST;\r\n}\r\nmemset(&uart8250_data[mips_machtype][loongson_sysconf.nr_uarts],\r\n0, sizeof(struct plat_serial8250_port));\r\nuart8250_device.dev.platform_data = uart8250_data[mips_machtype];\r\nreturn platform_device_register(&uart8250_device);\r\n}

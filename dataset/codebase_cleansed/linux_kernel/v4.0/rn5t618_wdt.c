static int rn5t618_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int t)\r\n{\r\nstruct rn5t618_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nint ret, i;\r\nfor (i = 0; i < ARRAY_SIZE(rn5t618_wdt_map); i++) {\r\nif (rn5t618_wdt_map[i].time + 1 >= t)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(rn5t618_wdt_map))\r\nreturn -EINVAL;\r\nret = regmap_update_bits(wdt->rn5t618->regmap, RN5T618_WATCHDOG,\r\nRN5T618_WATCHDOG_WDOGTIM_M,\r\nrn5t618_wdt_map[i].reg_val);\r\nif (!ret)\r\nwdt_dev->timeout = rn5t618_wdt_map[i].time;\r\nreturn ret;\r\n}\r\nstatic int rn5t618_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct rn5t618_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nint ret;\r\nret = rn5t618_wdt_set_timeout(wdt_dev, wdt_dev->timeout);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_update_bits(wdt->rn5t618->regmap, RN5T618_REPCNT,\r\nRN5T618_REPCNT_REPWRON,\r\nRN5T618_REPCNT_REPWRON);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_update_bits(wdt->rn5t618->regmap, RN5T618_WATCHDOG,\r\nRN5T618_WATCHDOG_WDOGEN,\r\nRN5T618_WATCHDOG_WDOGEN);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_update_bits(wdt->rn5t618->regmap, RN5T618_PWRIREN,\r\nRN5T618_PWRIRQ_IR_WDOG,\r\nRN5T618_PWRIRQ_IR_WDOG);\r\n}\r\nstatic int rn5t618_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct rn5t618_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nreturn regmap_update_bits(wdt->rn5t618->regmap, RN5T618_WATCHDOG,\r\nRN5T618_WATCHDOG_WDOGEN, 0);\r\n}\r\nstatic int rn5t618_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct rn5t618_wdt *wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(wdt->rn5t618->regmap, RN5T618_WATCHDOG, &val);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(wdt->rn5t618->regmap, RN5T618_WATCHDOG, val);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_update_bits(wdt->rn5t618->regmap, RN5T618_PWRIRQ,\r\nRN5T618_PWRIRQ_IR_WDOG, 0);\r\n}\r\nstatic int rn5t618_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct rn5t618 *rn5t618 = dev_get_drvdata(pdev->dev.parent);\r\nstruct rn5t618_wdt *wdt;\r\nint min_timeout, max_timeout;\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(struct rn5t618_wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nmin_timeout = rn5t618_wdt_map[0].time;\r\nmax_timeout = rn5t618_wdt_map[ARRAY_SIZE(rn5t618_wdt_map) - 1].time;\r\nwdt->rn5t618 = rn5t618;\r\nwdt->wdt_dev.info = &rn5t618_wdt_info;\r\nwdt->wdt_dev.ops = &rn5t618_wdt_ops;\r\nwdt->wdt_dev.min_timeout = min_timeout;\r\nwdt->wdt_dev.max_timeout = max_timeout;\r\nwdt->wdt_dev.timeout = max_timeout;\r\nwdt->wdt_dev.parent = &pdev->dev;\r\nwatchdog_set_drvdata(&wdt->wdt_dev, wdt);\r\nwatchdog_init_timeout(&wdt->wdt_dev, timeout, &pdev->dev);\r\nwatchdog_set_nowayout(&wdt->wdt_dev, nowayout);\r\nplatform_set_drvdata(pdev, wdt);\r\nreturn watchdog_register_device(&wdt->wdt_dev);\r\n}\r\nstatic int rn5t618_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct rn5t618_wdt *wdt = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&wdt->wdt_dev);\r\nreturn 0;\r\n}

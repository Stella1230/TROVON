static void nft_exthdr_eval(const struct nft_expr *expr,\r\nstruct nft_data data[NFT_REG_MAX + 1],\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nstruct nft_exthdr *priv = nft_expr_priv(expr);\r\nstruct nft_data *dest = &data[priv->dreg];\r\nunsigned int offset = 0;\r\nint err;\r\nerr = ipv6_find_hdr(pkt->skb, &offset, priv->type, NULL, NULL);\r\nif (err < 0)\r\ngoto err;\r\noffset += priv->offset;\r\nif (skb_copy_bits(pkt->skb, offset, dest->data, priv->len) < 0)\r\ngoto err;\r\nreturn;\r\nerr:\r\ndata[NFT_REG_VERDICT].verdict = NFT_BREAK;\r\n}\r\nstatic int nft_exthdr_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_exthdr *priv = nft_expr_priv(expr);\r\nint err;\r\nif (tb[NFTA_EXTHDR_DREG] == NULL ||\r\ntb[NFTA_EXTHDR_TYPE] == NULL ||\r\ntb[NFTA_EXTHDR_OFFSET] == NULL ||\r\ntb[NFTA_EXTHDR_LEN] == NULL)\r\nreturn -EINVAL;\r\npriv->type = nla_get_u8(tb[NFTA_EXTHDR_TYPE]);\r\npriv->offset = ntohl(nla_get_be32(tb[NFTA_EXTHDR_OFFSET]));\r\npriv->len = ntohl(nla_get_be32(tb[NFTA_EXTHDR_LEN]));\r\nif (priv->len == 0 ||\r\npriv->len > FIELD_SIZEOF(struct nft_data, data))\r\nreturn -EINVAL;\r\npriv->dreg = ntohl(nla_get_be32(tb[NFTA_EXTHDR_DREG]));\r\nerr = nft_validate_output_register(priv->dreg);\r\nif (err < 0)\r\nreturn err;\r\nreturn nft_validate_data_load(ctx, priv->dreg, NULL, NFT_DATA_VALUE);\r\n}\r\nstatic int nft_exthdr_dump(struct sk_buff *skb, const struct nft_expr *expr)\r\n{\r\nconst struct nft_exthdr *priv = nft_expr_priv(expr);\r\nif (nla_put_be32(skb, NFTA_EXTHDR_DREG, htonl(priv->dreg)))\r\ngoto nla_put_failure;\r\nif (nla_put_u8(skb, NFTA_EXTHDR_TYPE, priv->type))\r\ngoto nla_put_failure;\r\nif (nla_put_be32(skb, NFTA_EXTHDR_OFFSET, htonl(priv->offset)))\r\ngoto nla_put_failure;\r\nif (nla_put_be32(skb, NFTA_EXTHDR_LEN, htonl(priv->len)))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int __init nft_exthdr_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_exthdr_type);\r\n}\r\nstatic void __exit nft_exthdr_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_exthdr_type);\r\n}

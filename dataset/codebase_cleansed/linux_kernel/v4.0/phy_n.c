bool wlc_phy_bist_check_phy(struct brcms_phy_pub *pih)\r\n{\r\nstruct brcms_phy *pi = container_of(pih, struct brcms_phy, pubpi_ro);\r\nu32 phybist0, phybist1, phybist2, phybist3, phybist4;\r\nif (NREV_GE(pi->pubpi.phy_rev, 16))\r\nreturn true;\r\nphybist0 = read_phy_reg(pi, 0x0e);\r\nphybist1 = read_phy_reg(pi, 0x0f);\r\nphybist2 = read_phy_reg(pi, 0xea);\r\nphybist3 = read_phy_reg(pi, 0xeb);\r\nphybist4 = read_phy_reg(pi, 0x156);\r\nif ((phybist0 == 0) && (phybist1 == 0x4000) && (phybist2 == 0x1fe0) &&\r\n(phybist3 == 0) && (phybist4 == 0))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic void wlc_phy_bphy_init_nphy(struct brcms_phy *pi)\r\n{\r\nu16 addr, val;\r\nval = 0x1e1f;\r\nfor (addr = (NPHY_TO_BPHY_OFF + BPHY_RSSI_LUT);\r\naddr <= (NPHY_TO_BPHY_OFF + BPHY_RSSI_LUT_END); addr++) {\r\nwrite_phy_reg(pi, addr, val);\r\nif (addr == (NPHY_TO_BPHY_OFF + 0x97))\r\nval = 0x3e3f;\r\nelse\r\nval -= 0x0202;\r\n}\r\nwrite_phy_reg(pi, NPHY_TO_BPHY_OFF + BPHY_STEP, 0x668);\r\n}\r\nvoid\r\nwlc_phy_table_write_nphy(struct brcms_phy *pi, u32 id, u32 len, u32 offset,\r\nu32 width, const void *data)\r\n{\r\nstruct phytbl_info tbl;\r\ntbl.tbl_id = id;\r\ntbl.tbl_len = len;\r\ntbl.tbl_offset = offset;\r\ntbl.tbl_width = width;\r\ntbl.tbl_ptr = data;\r\nwlc_phy_write_table_nphy(pi, &tbl);\r\n}\r\nvoid\r\nwlc_phy_table_read_nphy(struct brcms_phy *pi, u32 id, u32 len, u32 offset,\r\nu32 width, void *data)\r\n{\r\nstruct phytbl_info tbl;\r\ntbl.tbl_id = id;\r\ntbl.tbl_len = len;\r\ntbl.tbl_offset = offset;\r\ntbl.tbl_width = width;\r\ntbl.tbl_ptr = data;\r\nwlc_phy_read_table_nphy(pi, &tbl);\r\n}\r\nstatic void\r\nwlc_phy_static_table_download_nphy(struct brcms_phy *pi)\r\n{\r\nuint idx;\r\nif (NREV_GE(pi->pubpi.phy_rev, 16)) {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev16; idx++)\r\nwlc_phy_write_table_nphy(pi,\r\n&mimophytbl_info_rev16[idx]);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev7; idx++)\r\nwlc_phy_write_table_nphy(pi,\r\n&mimophytbl_info_rev7[idx]);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev3; idx++)\r\nwlc_phy_write_table_nphy(pi,\r\n&mimophytbl_info_rev3[idx]);\r\n} else {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev0; idx++)\r\nwlc_phy_write_table_nphy(pi,\r\n&mimophytbl_info_rev0[idx]);\r\n}\r\n}\r\nstatic void wlc_phy_tbl_init_nphy(struct brcms_phy *pi)\r\n{\r\nuint idx = 0;\r\nu8 antswctrllut;\r\nif (pi->phy_init_por)\r\nwlc_phy_static_table_download_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nantswctrllut = CHSPEC_IS2G(pi->radio_chanspec) ?\r\npi->srom_fem2g.antswctrllut : pi->srom_fem5g.\r\nantswctrllut;\r\nswitch (antswctrllut) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nif (pi->aa2g == 7)\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x21, 8,\r\n&ant_sw_ctrl_tbl_rev8_2o3[0]);\r\nelse\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x21, 8,\r\n&ant_sw_ctrl_tbl_rev8\r\n[0]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x25, 8,\r\n&ant_sw_ctrl_tbl_rev8[2]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x29, 8,\r\n&ant_sw_ctrl_tbl_rev8[4]);\r\nbreak;\r\ncase 2:\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x1, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core0[0]);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x5, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core0[2]);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x9, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core0[4]);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x21, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core1[0]);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x25, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core1[2]);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n2, 0x29, 8,\r\n&ant_sw_ctrl_tbl_rev8_2057v7_core1[4]);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev3_volatile; idx++) {\r\nif (idx == ANT_SWCTRL_TBL_REV3_IDX) {\r\nantswctrllut =\r\nCHSPEC_IS2G(pi->radio_chanspec) ?\r\npi->srom_fem2g.antswctrllut :\r\npi->srom_fem5g.antswctrllut;\r\nswitch (antswctrllut) {\r\ncase 0:\r\nwlc_phy_write_table_nphy(\r\npi,\r\n&mimophytbl_info_rev3_volatile\r\n[idx]);\r\nbreak;\r\ncase 1:\r\nwlc_phy_write_table_nphy(\r\npi,\r\n&mimophytbl_info_rev3_volatile1\r\n[idx]);\r\nbreak;\r\ncase 2:\r\nwlc_phy_write_table_nphy(\r\npi,\r\n&mimophytbl_info_rev3_volatile2\r\n[idx]);\r\nbreak;\r\ncase 3:\r\nwlc_phy_write_table_nphy(\r\npi,\r\n&mimophytbl_info_rev3_volatile3\r\n[idx]);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nwlc_phy_write_table_nphy(\r\npi,\r\n&mimophytbl_info_rev3_volatile[idx]);\r\n}\r\n}\r\n} else {\r\nfor (idx = 0; idx < mimophytbl_info_sz_rev0_volatile; idx++)\r\nwlc_phy_write_table_nphy(pi,\r\n&mimophytbl_info_rev0_volatile\r\n[idx]);\r\n}\r\n}\r\nstatic void\r\nwlc_phy_write_txmacreg_nphy(struct brcms_phy *pi, u16 holdoff, u16 delay)\r\n{\r\nwrite_phy_reg(pi, 0x77, holdoff);\r\nwrite_phy_reg(pi, 0xb4, delay);\r\n}\r\nvoid wlc_phy_nphy_tkip_rifs_war(struct brcms_phy *pi, u8 rifs)\r\n{\r\nu16 holdoff, delay;\r\nif (rifs) {\r\nholdoff = 0x10;\r\ndelay = 0x258;\r\n} else {\r\nholdoff = 0x15;\r\ndelay = 0x320;\r\n}\r\nwlc_phy_write_txmacreg_nphy(pi, holdoff, delay);\r\nif (pi->sh && (pi->sh->_rifs_phy != rifs))\r\npi->sh->_rifs_phy = rifs;\r\n}\r\nstatic void wlc_phy_txpwrctrl_config_nphy(struct brcms_phy *pi)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->nphy_txpwrctrl = PHY_TPC_HW_ON;\r\npi->phy_5g_pwrgain = true;\r\nreturn;\r\n}\r\npi->nphy_txpwrctrl = PHY_TPC_HW_OFF;\r\npi->phy_5g_pwrgain = false;\r\nif ((pi->sh->boardflags2 & BFL2_TXPWRCTRL_EN) &&\r\nNREV_GE(pi->pubpi.phy_rev, 2) && (pi->sh->sromrev >= 4))\r\npi->nphy_txpwrctrl = PHY_TPC_HW_ON;\r\nelse if ((pi->sh->sromrev >= 4)\r\n&& (pi->sh->boardflags2 & BFL2_5G_PWRGAIN))\r\npi->phy_5g_pwrgain = true;\r\n}\r\nstatic void wlc_phy_txpwr_srom_read_ppr_nphy(struct brcms_phy *pi)\r\n{\r\nu16 bw40po, cddpo, stbcpo, bwduppo;\r\nuint band_num;\r\nstruct ssb_sprom *sprom = &pi->d11core->bus->sprom;\r\nif (pi->sh->sromrev >= 9)\r\nreturn;\r\nbw40po = sprom->bw40po;\r\npi->bw402gpo = bw40po & 0xf;\r\npi->bw405gpo = (bw40po & 0xf0) >> 4;\r\npi->bw405glpo = (bw40po & 0xf00) >> 8;\r\npi->bw405ghpo = (bw40po & 0xf000) >> 12;\r\ncddpo = sprom->cddpo;\r\npi->cdd2gpo = cddpo & 0xf;\r\npi->cdd5gpo = (cddpo & 0xf0) >> 4;\r\npi->cdd5glpo = (cddpo & 0xf00) >> 8;\r\npi->cdd5ghpo = (cddpo & 0xf000) >> 12;\r\nstbcpo = sprom->stbcpo;\r\npi->stbc2gpo = stbcpo & 0xf;\r\npi->stbc5gpo = (stbcpo & 0xf0) >> 4;\r\npi->stbc5glpo = (stbcpo & 0xf00) >> 8;\r\npi->stbc5ghpo = (stbcpo & 0xf000) >> 12;\r\nbwduppo = sprom->bwduppo;\r\npi->bwdup2gpo = bwduppo & 0xf;\r\npi->bwdup5gpo = (bwduppo & 0xf0) >> 4;\r\npi->bwdup5glpo = (bwduppo & 0xf00) >> 8;\r\npi->bwdup5ghpo = (bwduppo & 0xf000) >> 12;\r\nfor (band_num = 0; band_num < (CH_2G_GROUP + CH_5G_GROUP);\r\nband_num++) {\r\nswitch (band_num) {\r\ncase 0:\r\npi->nphy_pwrctrl_info[PHY_CORE_0].max_pwr_2g =\r\nsprom->core_pwr_info[0].maxpwr_2g;\r\npi->nphy_pwrctrl_info[PHY_CORE_1].max_pwr_2g =\r\nsprom->core_pwr_info[1].maxpwr_2g;\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_2g_a1 =\r\nsprom->core_pwr_info[0].pa_2g[0];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_2g_a1 =\r\nsprom->core_pwr_info[1].pa_2g[0];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_2g_b0 =\r\nsprom->core_pwr_info[0].pa_2g[1];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_2g_b0 =\r\nsprom->core_pwr_info[1].pa_2g[1];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_2g_b1 =\r\nsprom->core_pwr_info[0].pa_2g[2];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_2g_b1 =\r\nsprom->core_pwr_info[1].pa_2g[2];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_targ_2g =\r\nsprom->core_pwr_info[0].itssi_2g;\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_targ_2g =\r\nsprom->core_pwr_info[1].itssi_2g;\r\npi->cck2gpo = sprom->cck2gpo;\r\npi->ofdm2gpo = sprom->ofdm2gpo;\r\npi->mcs2gpo[0] = sprom->mcs2gpo[0];\r\npi->mcs2gpo[1] = sprom->mcs2gpo[1];\r\npi->mcs2gpo[2] = sprom->mcs2gpo[2];\r\npi->mcs2gpo[3] = sprom->mcs2gpo[3];\r\npi->mcs2gpo[4] = sprom->mcs2gpo[4];\r\npi->mcs2gpo[5] = sprom->mcs2gpo[5];\r\npi->mcs2gpo[6] = sprom->mcs2gpo[6];\r\npi->mcs2gpo[7] = sprom->mcs2gpo[7];\r\nbreak;\r\ncase 1:\r\npi->nphy_pwrctrl_info[PHY_CORE_0].max_pwr_5gm =\r\nsprom->core_pwr_info[0].maxpwr_5g;\r\npi->nphy_pwrctrl_info[PHY_CORE_1].max_pwr_5gm =\r\nsprom->core_pwr_info[1].maxpwr_5g;\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_5gm_a1 =\r\nsprom->core_pwr_info[0].pa_5g[0];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_5gm_a1 =\r\nsprom->core_pwr_info[1].pa_5g[0];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_5gm_b0 =\r\nsprom->core_pwr_info[0].pa_5g[1];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_5gm_b0 =\r\nsprom->core_pwr_info[1].pa_5g[1];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].pwrdet_5gm_b1 =\r\nsprom->core_pwr_info[0].pa_5g[2];\r\npi->nphy_pwrctrl_info[PHY_CORE_1].pwrdet_5gm_b1 =\r\nsprom->core_pwr_info[1].pa_5g[2];\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_targ_5gm =\r\nsprom->core_pwr_info[0].itssi_5g;\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_targ_5gm =\r\nsprom->core_pwr_info[1].itssi_5g;\r\npi->ofdm5gpo = sprom->ofdm5gpo;\r\npi->mcs5gpo[0] = sprom->mcs5gpo[0];\r\npi->mcs5gpo[1] = sprom->mcs5gpo[1];\r\npi->mcs5gpo[2] = sprom->mcs5gpo[2];\r\npi->mcs5gpo[3] = sprom->mcs5gpo[3];\r\npi->mcs5gpo[4] = sprom->mcs5gpo[4];\r\npi->mcs5gpo[5] = sprom->mcs5gpo[5];\r\npi->mcs5gpo[6] = sprom->mcs5gpo[6];\r\npi->mcs5gpo[7] = sprom->mcs5gpo[7];\r\nbreak;\r\ncase 2:\r\npi->nphy_pwrctrl_info[0].max_pwr_5gl =\r\nsprom->core_pwr_info[0].maxpwr_5gl;\r\npi->nphy_pwrctrl_info[1].max_pwr_5gl =\r\nsprom->core_pwr_info[1].maxpwr_5gl;\r\npi->nphy_pwrctrl_info[0].pwrdet_5gl_a1 =\r\nsprom->core_pwr_info[0].pa_5gl[0];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gl_a1 =\r\nsprom->core_pwr_info[1].pa_5gl[0];\r\npi->nphy_pwrctrl_info[0].pwrdet_5gl_b0 =\r\nsprom->core_pwr_info[0].pa_5gl[1];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gl_b0 =\r\nsprom->core_pwr_info[1].pa_5gl[1];\r\npi->nphy_pwrctrl_info[0].pwrdet_5gl_b1 =\r\nsprom->core_pwr_info[0].pa_5gl[2];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gl_b1 =\r\nsprom->core_pwr_info[1].pa_5gl[2];\r\npi->nphy_pwrctrl_info[0].idle_targ_5gl = 0;\r\npi->nphy_pwrctrl_info[1].idle_targ_5gl = 0;\r\npi->ofdm5glpo = sprom->ofdm5glpo;\r\npi->mcs5glpo[0] = sprom->mcs5glpo[0];\r\npi->mcs5glpo[1] = sprom->mcs5glpo[1];\r\npi->mcs5glpo[2] = sprom->mcs5glpo[2];\r\npi->mcs5glpo[3] = sprom->mcs5glpo[3];\r\npi->mcs5glpo[4] = sprom->mcs5glpo[4];\r\npi->mcs5glpo[5] = sprom->mcs5glpo[5];\r\npi->mcs5glpo[6] = sprom->mcs5glpo[6];\r\npi->mcs5glpo[7] = sprom->mcs5glpo[7];\r\nbreak;\r\ncase 3:\r\npi->nphy_pwrctrl_info[0].max_pwr_5gh =\r\nsprom->core_pwr_info[0].maxpwr_5gh;\r\npi->nphy_pwrctrl_info[1].max_pwr_5gh =\r\nsprom->core_pwr_info[1].maxpwr_5gh;\r\npi->nphy_pwrctrl_info[0].pwrdet_5gh_a1 =\r\nsprom->core_pwr_info[0].pa_5gh[0];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gh_a1 =\r\nsprom->core_pwr_info[1].pa_5gh[0];\r\npi->nphy_pwrctrl_info[0].pwrdet_5gh_b0 =\r\nsprom->core_pwr_info[0].pa_5gh[1];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gh_b0 =\r\nsprom->core_pwr_info[1].pa_5gh[1];\r\npi->nphy_pwrctrl_info[0].pwrdet_5gh_b1 =\r\nsprom->core_pwr_info[0].pa_5gh[2];\r\npi->nphy_pwrctrl_info[1].pwrdet_5gh_b1 =\r\nsprom->core_pwr_info[1].pa_5gh[2];\r\npi->nphy_pwrctrl_info[0].idle_targ_5gh = 0;\r\npi->nphy_pwrctrl_info[1].idle_targ_5gh = 0;\r\npi->ofdm5ghpo = sprom->ofdm5ghpo;\r\npi->mcs5ghpo[0] = sprom->mcs5ghpo[0];\r\npi->mcs5ghpo[1] = sprom->mcs5ghpo[1];\r\npi->mcs5ghpo[2] = sprom->mcs5ghpo[2];\r\npi->mcs5ghpo[3] = sprom->mcs5ghpo[3];\r\npi->mcs5ghpo[4] = sprom->mcs5ghpo[4];\r\npi->mcs5ghpo[5] = sprom->mcs5ghpo[5];\r\npi->mcs5ghpo[6] = sprom->mcs5ghpo[6];\r\npi->mcs5ghpo[7] = sprom->mcs5ghpo[7];\r\nbreak;\r\n}\r\n}\r\nwlc_phy_txpwr_apply_nphy(pi);\r\n}\r\nstatic bool wlc_phy_txpwr_srom_read_nphy(struct brcms_phy *pi)\r\n{\r\nstruct ssb_sprom *sprom = &pi->d11core->bus->sprom;\r\npi->antswitch = sprom->antswitch;\r\npi->aa2g = sprom->ant_available_bg;\r\npi->aa5g = sprom->ant_available_a;\r\npi->srom_fem2g.tssipos = sprom->fem.ghz2.tssipos;\r\npi->srom_fem2g.extpagain = sprom->fem.ghz2.extpa_gain;\r\npi->srom_fem2g.pdetrange = sprom->fem.ghz2.pdet_range;\r\npi->srom_fem2g.triso = sprom->fem.ghz2.tr_iso;\r\npi->srom_fem2g.antswctrllut = sprom->fem.ghz2.antswlut;\r\npi->srom_fem5g.tssipos = sprom->fem.ghz5.tssipos;\r\npi->srom_fem5g.extpagain = sprom->fem.ghz5.extpa_gain;\r\npi->srom_fem5g.pdetrange = sprom->fem.ghz5.pdet_range;\r\npi->srom_fem5g.triso = sprom->fem.ghz5.tr_iso;\r\nif (sprom->fem.ghz5.antswlut)\r\npi->srom_fem5g.antswctrllut = sprom->fem.ghz5.antswlut;\r\nelse\r\npi->srom_fem5g.antswctrllut = sprom->fem.ghz2.antswlut;\r\nwlc_phy_txpower_ipa_upd(pi);\r\npi->phy_txcore_disable_temp = sprom->tempthresh;\r\nif (pi->phy_txcore_disable_temp == 0)\r\npi->phy_txcore_disable_temp = PHY_CHAIN_TX_DISABLE_TEMP;\r\npi->phy_tempsense_offset = sprom->tempoffset;\r\nif (pi->phy_tempsense_offset != 0) {\r\nif (pi->phy_tempsense_offset >\r\n(NPHY_SROM_TEMPSHIFT + NPHY_SROM_MAXTEMPOFFSET))\r\npi->phy_tempsense_offset = NPHY_SROM_MAXTEMPOFFSET;\r\nelse if (pi->phy_tempsense_offset < (NPHY_SROM_TEMPSHIFT +\r\nNPHY_SROM_MINTEMPOFFSET))\r\npi->phy_tempsense_offset = NPHY_SROM_MINTEMPOFFSET;\r\nelse\r\npi->phy_tempsense_offset -= NPHY_SROM_TEMPSHIFT;\r\n}\r\npi->phy_txcore_enable_temp =\r\npi->phy_txcore_disable_temp - PHY_HYSTERESIS_DELTATEMP;\r\npi->phycal_tempdelta = sprom->phycal_tempdelta;\r\nif (pi->phycal_tempdelta > NPHY_CAL_MAXTEMPDELTA)\r\npi->phycal_tempdelta = 0;\r\nwlc_phy_txpwr_srom_read_ppr_nphy(pi);\r\nreturn true;\r\n}\r\nbool wlc_phy_attach_nphy(struct brcms_phy *pi)\r\n{\r\nuint i;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LT(pi->pubpi.phy_rev, 6))\r\npi->phyhang_avoid = true;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LT(pi->pubpi.phy_rev, 7)) {\r\npi->nphy_gband_spurwar_en = true;\r\nif (pi->sh->boardflags2 & BFL2_SPUR_WAR)\r\npi->nphy_aband_spurwar_en = true;\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 6) && NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nif (pi->sh->boardflags2 & BFL2_2G_SPUR_WAR)\r\npi->nphy_gband_spurwar2_en = true;\r\n}\r\npi->n_preamble_override = AUTO;\r\nif (NREV_IS(pi->pubpi.phy_rev, 3) || NREV_IS(pi->pubpi.phy_rev, 4))\r\npi->n_preamble_override = BRCMS_N_PREAMBLE_MIXEDMODE;\r\npi->nphy_txrx_chain = AUTO;\r\npi->phy_scraminit = AUTO;\r\npi->nphy_rxcalparams = 0x010100B5;\r\npi->nphy_perical = PHY_PERICAL_MPHASE;\r\npi->mphase_cal_phase_id = MPHASE_CAL_STATE_IDLE;\r\npi->mphase_txcal_numcmds = MPHASE_TXCAL_NUMCMDS;\r\npi->nphy_gain_boost = true;\r\npi->nphy_elna_gain_config = false;\r\npi->radio_is_on = false;\r\nfor (i = 0; i < pi->pubpi.phy_corenum; i++)\r\npi->nphy_txpwrindex[i].index = AUTO;\r\nwlc_phy_txpwrctrl_config_nphy(pi);\r\nif (pi->nphy_txpwrctrl == PHY_TPC_HW_ON)\r\npi->hwpwrctrl_capable = true;\r\npi->pi_fptr.init = wlc_phy_init_nphy;\r\npi->pi_fptr.calinit = wlc_phy_cal_init_nphy;\r\npi->pi_fptr.chanset = wlc_phy_chanspec_set_nphy;\r\npi->pi_fptr.txpwrrecalc = wlc_phy_txpower_recalc_target_nphy;\r\nif (!wlc_phy_txpwr_srom_read_nphy(pi))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic s32 get_rf_pwr_offset(struct brcms_phy *pi, s16 pga_gn, s16 pad_gn)\r\n{\r\ns32 rfpwr_offset = 0;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\nrfpwr_offset = (s16)\r\nnphy_papd_padgain_dlt_2g_2057rev3n4\r\n[pad_gn];\r\nelse if (pi->pubpi.radiorev == 5)\r\nrfpwr_offset = (s16)\r\nnphy_papd_padgain_dlt_2g_2057rev5\r\n[pad_gn];\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev ==\r\n8))\r\nrfpwr_offset = (s16)\r\nnphy_papd_padgain_dlt_2g_2057rev7\r\n[pad_gn];\r\n} else {\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\nrfpwr_offset = (s16)\r\nnphy_papd_pgagain_dlt_5g_2057\r\n[pga_gn];\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev ==\r\n8))\r\nrfpwr_offset = (s16)\r\nnphy_papd_pgagain_dlt_5g_2057rev7\r\n[pga_gn];\r\n}\r\nreturn rfpwr_offset;\r\n}\r\nstatic void wlc_phy_update_mimoconfig_nphy(struct brcms_phy *pi, s32 preamble)\r\n{\r\nbool gf_preamble = false;\r\nu16 val;\r\nif (preamble == BRCMS_N_PREAMBLE_GF)\r\ngf_preamble = true;\r\nval = read_phy_reg(pi, 0xed);\r\nval |= RX_GF_MM_AUTO;\r\nval &= ~RX_GF_OR_MM;\r\nif (gf_preamble)\r\nval |= RX_GF_OR_MM;\r\nwrite_phy_reg(pi, 0xed, val);\r\n}\r\nstatic void wlc_phy_ipa_set_tx_digi_filts_nphy(struct brcms_phy *pi)\r\n{\r\nint j, type;\r\nu16 addr_offset[] = { 0x186, 0x195, 0x2c5};\r\nfor (type = 0; type < 3; type++) {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, addr_offset[type] + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[type][j]);\r\n}\r\nif (pi->bw == WL_CHANSPEC_BW_40) {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, 0x186 + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[3][j]);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, 0x186 + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[5][j]);\r\n}\r\nif (CHSPEC_CHANNEL(pi->radio_chanspec) == 14) {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, 0x2c5 + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[6][j]);\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_ipa_restore_tx_digi_filts_nphy(struct brcms_phy *pi)\r\n{\r\nint j;\r\nif (pi->bw == WL_CHANSPEC_BW_40) {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, 0x195 + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[4][j]);\r\n} else {\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, 0x186 + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[3][j]);\r\n}\r\n}\r\nstatic void\r\nwlc_phy_set_rfseq_nphy(struct brcms_phy *pi, u8 cmd, u8 *events, u8 *dlys,\r\nu8 len)\r\n{\r\nu32 t1_offset, t2_offset;\r\nu8 ctr;\r\nu8 end_event =\r\nNREV_GE(pi->pubpi.phy_rev,\r\n3) ? NPHY_REV3_RFSEQ_CMD_END : NPHY_RFSEQ_CMD_END;\r\nu8 end_dly = 1;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nt1_offset = cmd << 4;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, len, t1_offset, 8,\r\nevents);\r\nt2_offset = t1_offset + 0x080;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, len, t2_offset, 8,\r\ndlys);\r\nfor (ctr = len; ctr < 16; ctr++) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 1,\r\nt1_offset + ctr, 8, &end_event);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 1,\r\nt2_offset + ctr, 8, &end_dly);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic u16 wlc_phy_read_lpf_bw_ctl_nphy(struct brcms_phy *pi, u16 offset)\r\n{\r\nu16 lpf_bw_ctl_val = 0;\r\nu16 rx2tx_lpf_rc_lut_offset = 0;\r\nif (offset == 0) {\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\nrx2tx_lpf_rc_lut_offset = 0x159;\r\nelse\r\nrx2tx_lpf_rc_lut_offset = 0x154;\r\n} else {\r\nrx2tx_lpf_rc_lut_offset = offset;\r\n}\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 1,\r\n(u32) rx2tx_lpf_rc_lut_offset, 16,\r\n&lpf_bw_ctl_val);\r\nlpf_bw_ctl_val = lpf_bw_ctl_val & 0x7;\r\nreturn lpf_bw_ctl_val;\r\n}\r\nstatic void\r\nwlc_phy_rfctrl_override_nphy_rev7(struct brcms_phy *pi, u16 field, u16 value,\r\nu8 core_mask, u8 off, u8 override_id)\r\n{\r\nu8 core_num;\r\nu16 addr = 0, en_addr = 0, val_addr = 0, en_mask = 0, val_mask = 0;\r\nu8 val_shift = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nen_mask = field;\r\nfor (core_num = 0; core_num < 2; core_num++) {\r\nif (override_id == NPHY_REV7_RFCTRLOVERRIDE_ID0) {\r\nswitch (field) {\r\ncase (0x1 << 2):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 1);\r\nval_shift = 1;\r\nbreak;\r\ncase (0x1 << 3):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 2);\r\nval_shift = 2;\r\nbreak;\r\ncase (0x1 << 4):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 4);\r\nval_shift = 4;\r\nbreak;\r\ncase (0x1 << 5):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 5);\r\nval_shift = 5;\r\nbreak;\r\ncase (0x1 << 6):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 6);\r\nval_shift = 6;\r\nbreak;\r\ncase (0x1 << 7):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a :\r\n0x7d;\r\nval_mask = (0x1 << 7);\r\nval_shift = 7;\r\nbreak;\r\ncase (0x1 << 10):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0xf8 :\r\n0xfa;\r\nval_mask = (0x7 << 4);\r\nval_shift = 4;\r\nbreak;\r\ncase (0x1 << 11):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7b :\r\n0x7e;\r\nval_mask = (0xffff << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 12):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7c :\r\n0x7f;\r\nval_mask = (0xffff << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x3 << 13):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x348 :\r\n0x349;\r\nval_mask = (0xff << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 13):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x348 :\r\n0x349;\r\nval_mask = (0xf << 0);\r\nval_shift = 0;\r\nbreak;\r\ndefault:\r\naddr = 0xffff;\r\nbreak;\r\n}\r\n} else if (override_id ==\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1) {\r\nswitch (field) {\r\ncase (0x1 << 1):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 1);\r\nval_shift = 1;\r\nbreak;\r\ncase (0x1 << 3):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 3);\r\nval_shift = 3;\r\nbreak;\r\ncase (0x1 << 5):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 5);\r\nval_shift = 5;\r\nbreak;\r\ncase (0x1 << 4):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 4);\r\nval_shift = 4;\r\nbreak;\r\ncase (0x1 << 2):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 2);\r\nval_shift = 2;\r\nbreak;\r\ncase (0x1 << 7):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x7 << 8);\r\nval_shift = 8;\r\nbreak;\r\ncase (0x1 << 11):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 14);\r\nval_shift = 14;\r\nbreak;\r\ncase (0x1 << 10):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 13);\r\nval_shift = 13;\r\nbreak;\r\ncase (0x1 << 9):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 12);\r\nval_shift = 12;\r\nbreak;\r\ncase (0x1 << 8):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 11);\r\nval_shift = 11;\r\nbreak;\r\ncase (0x1 << 6):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 6);\r\nval_shift = 6;\r\nbreak;\r\ncase (0x1 << 0):\r\nen_addr = (core_num == 0) ? 0x342 :\r\n0x343;\r\nval_addr = (core_num == 0) ? 0x340 :\r\n0x341;\r\nval_mask = (0x1 << 0);\r\nval_shift = 0;\r\nbreak;\r\ndefault:\r\naddr = 0xffff;\r\nbreak;\r\n}\r\n} else if (override_id ==\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2) {\r\nswitch (field) {\r\ncase (0x1 << 3):\r\nen_addr = (core_num == 0) ? 0x346 :\r\n0x347;\r\nval_addr = (core_num == 0) ? 0x344 :\r\n0x345;\r\nval_mask = (0x1 << 3);\r\nval_shift = 3;\r\nbreak;\r\ncase (0x1 << 1):\r\nen_addr = (core_num == 0) ? 0x346 :\r\n0x347;\r\nval_addr = (core_num == 0) ? 0x344 :\r\n0x345;\r\nval_mask = (0x1 << 1);\r\nval_shift = 1;\r\nbreak;\r\ncase (0x1 << 0):\r\nen_addr = (core_num == 0) ? 0x346 :\r\n0x347;\r\nval_addr = (core_num == 0) ? 0x344 :\r\n0x345;\r\nval_mask = (0x1 << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 2):\r\nen_addr = (core_num == 0) ? 0x346 :\r\n0x347;\r\nval_addr = (core_num == 0) ? 0x344 :\r\n0x345;\r\nval_mask = (0x1 << 2);\r\nval_shift = 2;\r\nbreak;\r\ncase (0x1 << 4):\r\nen_addr = (core_num == 0) ? 0x346 :\r\n0x347;\r\nval_addr = (core_num == 0) ? 0x344 :\r\n0x345;\r\nval_mask = (0x1 << 4);\r\nval_shift = 4;\r\nbreak;\r\ndefault:\r\naddr = 0xffff;\r\nbreak;\r\n}\r\n}\r\nif (off) {\r\nand_phy_reg(pi, en_addr, ~en_mask);\r\nand_phy_reg(pi, val_addr, ~val_mask);\r\n} else {\r\nif ((core_mask == 0)\r\n|| (core_mask & (1 << core_num))) {\r\nor_phy_reg(pi, en_addr, en_mask);\r\nif (addr != 0xffff)\r\nmod_phy_reg(pi, val_addr,\r\nval_mask,\r\n(value <<\r\nval_shift));\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_adjust_lnagaintbl_nphy(struct brcms_phy *pi)\r\n{\r\nuint core;\r\nint ctr;\r\ns16 gain_delta[2];\r\nu8 curr_channel;\r\nu16 minmax_gain[2];\r\nu16 regval[4];\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (pi->nphy_gain_boost) {\r\nif ((CHSPEC_IS2G(pi->radio_chanspec))) {\r\ngain_delta[0] = 6;\r\ngain_delta[1] = 6;\r\n} else {\r\ncurr_channel = CHSPEC_CHANNEL(pi->radio_chanspec);\r\ngain_delta[0] =\r\n(s16)\r\nPHY_HW_ROUND(((nphy_lnagain_est0[0] *\r\ncurr_channel) +\r\nnphy_lnagain_est0[1]), 13);\r\ngain_delta[1] =\r\n(s16)\r\nPHY_HW_ROUND(((nphy_lnagain_est1[0] *\r\ncurr_channel) +\r\nnphy_lnagain_est1[1]), 13);\r\n}\r\n} else {\r\ngain_delta[0] = 0;\r\ngain_delta[1] = 0;\r\n}\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (pi->nphy_elna_gain_config) {\r\nregval[0] = nphy_def_lnagains[2] + gain_delta[core];\r\nregval[1] = nphy_def_lnagains[3] + gain_delta[core];\r\nregval[2] = nphy_def_lnagains[3] + gain_delta[core];\r\nregval[3] = nphy_def_lnagains[3] + gain_delta[core];\r\n} else {\r\nfor (ctr = 0; ctr < 4; ctr++)\r\nregval[ctr] =\r\nnphy_def_lnagains[ctr] +\r\ngain_delta[core];\r\n}\r\nwlc_phy_table_write_nphy(pi, core, 4, 8, 16, regval);\r\nminmax_gain[core] =\r\n(u16) (nphy_def_lnagains[2] + gain_delta[core] + 4);\r\n}\r\nmod_phy_reg(pi, 0x1e, (0xff << 0), (minmax_gain[0] << 0));\r\nmod_phy_reg(pi, 0x34, (0xff << 0), (minmax_gain[1] << 0));\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void\r\nwlc_phy_war_force_trsw_to_R_cliplo_nphy(struct brcms_phy *pi, u8 core)\r\n{\r\nif (core == PHY_CORE_0) {\r\nwrite_phy_reg(pi, 0x38, 0x4);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwrite_phy_reg(pi, 0x37, 0x0060);\r\nelse\r\nwrite_phy_reg(pi, 0x37, 0x1080);\r\n} else if (core == PHY_CORE_1) {\r\nwrite_phy_reg(pi, 0x2ae, 0x4);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwrite_phy_reg(pi, 0x2ad, 0x0060);\r\nelse\r\nwrite_phy_reg(pi, 0x2ad, 0x1080);\r\n}\r\n}\r\nstatic void wlc_phy_war_txchain_upd_nphy(struct brcms_phy *pi, u8 txchain)\r\n{\r\nu8 txchain0, txchain1;\r\ntxchain0 = txchain & 0x1;\r\ntxchain1 = (txchain & 0x2) >> 1;\r\nif (!txchain0)\r\nwlc_phy_war_force_trsw_to_R_cliplo_nphy(pi, PHY_CORE_0);\r\nif (!txchain1)\r\nwlc_phy_war_force_trsw_to_R_cliplo_nphy(pi, PHY_CORE_1);\r\n}\r\nstatic void wlc_phy_workarounds_nphy_gainctrl_2057_rev5(struct brcms_phy *pi)\r\n{\r\ns8 lna1_gain_db[] = { 8, 13, 17, 22 };\r\ns8 lna2_gain_db[] = { -2, 7, 11, 15 };\r\ns8 tia_gain_db[] = { -4, -1, 2, 5, 5, 5, 5, 5, 5, 5 };\r\ns8 tia_gainbits[] = {\r\n0x0, 0x01, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03 };\r\nmod_phy_reg(pi, 0x1c, (0x1 << 13), (1 << 13));\r\nmod_phy_reg(pi, 0x32, (0x1 << 13), (1 << 13));\r\nmod_phy_reg(pi, 0x289, (0xff << 0), (0x46 << 0));\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (0x3c << 0));\r\nmod_phy_reg(pi, 0x280, (0xff << 0), (0x3c << 0));\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 0x8, 8,\r\nlna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 0x8, 8,\r\nlna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 0x10, 8,\r\nlna2_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 0x10, 8,\r\nlna2_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 10, 0x20, 8,\r\ntia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 10, 0x20, 8,\r\ntia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS1, 10, 0x20, 8,\r\ntia_gainbits);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS2, 10, 0x20, 8,\r\ntia_gainbits);\r\nwrite_phy_reg(pi, 0x37, 0x74);\r\nwrite_phy_reg(pi, 0x2ad, 0x74);\r\nwrite_phy_reg(pi, 0x38, 0x18);\r\nwrite_phy_reg(pi, 0x2ae, 0x18);\r\nwrite_phy_reg(pi, 0x2b, 0xe8);\r\nwrite_phy_reg(pi, 0x41, 0xe8);\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x300, (0x3f << 0), (0x12 << 0));\r\nmod_phy_reg(pi, 0x301, (0x3f << 0), (0x12 << 0));\r\n} else {\r\nmod_phy_reg(pi, 0x300, (0x3f << 0), (0x10 << 0));\r\nmod_phy_reg(pi, 0x301, (0x3f << 0), (0x10 << 0));\r\n}\r\n}\r\nstatic void wlc_phy_workarounds_nphy_gainctrl_2057_rev6(struct brcms_phy *pi)\r\n{\r\nu16 currband;\r\ns8 lna1G_gain_db_rev7[] = { 9, 14, 19, 24 };\r\ns8 *lna1_gain_db = NULL;\r\ns8 *lna1_gain_db_2 = NULL;\r\ns8 *lna2_gain_db = NULL;\r\ns8 tiaA_gain_db_rev7[] = { -9, -6, -3, 0, 3, 3, 3, 3, 3, 3 };\r\ns8 *tia_gain_db;\r\ns8 tiaA_gainbits_rev7[] = { 0, 1, 2, 3, 4, 4, 4, 4, 4, 4 };\r\ns8 *tia_gainbits;\r\nu16 rfseqA_init_gain_rev7[] = { 0x624f, 0x624f };\r\nu16 *rfseq_init_gain;\r\nu16 init_gaincode;\r\nu16 clip1hi_gaincode;\r\nu16 clip1md_gaincode = 0;\r\nu16 clip1md_gaincode_B;\r\nu16 clip1lo_gaincode;\r\nu16 clip1lo_gaincode_B;\r\nu8 crsminl_th = 0;\r\nu8 crsminu_th;\r\nu16 nbclip_th = 0;\r\nu8 w1clip_th;\r\nu16 freq;\r\ns8 nvar_baseline_offset0 = 0, nvar_baseline_offset1 = 0;\r\nu8 chg_nbclip_th = 0;\r\nmod_phy_reg(pi, 0x1c, (0x1 << 13), (1 << 13));\r\nmod_phy_reg(pi, 0x32, (0x1 << 13), (1 << 13));\r\ncurrband = read_phy_reg(pi, 0x09) & NPHY_BandControl_currentBand;\r\nif (currband == 0) {\r\nlna1_gain_db = lna1G_gain_db_rev7;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 8, 8,\r\nlna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 8, 8,\r\nlna1_gain_db);\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (0x40 << 0));\r\nif (CHSPEC_IS40(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x280, (0xff << 0), (0x3e << 0));\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (0x3e << 0));\r\n}\r\nmod_phy_reg(pi, 0x289, (0xff << 0), (0x46 << 0));\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x300, (0x3f << 0), (13 << 0));\r\nmod_phy_reg(pi, 0x301, (0x3f << 0), (13 << 0));\r\n}\r\n} else {\r\ninit_gaincode = 0x9e;\r\nclip1hi_gaincode = 0x9e;\r\nclip1md_gaincode_B = 0x24;\r\nclip1lo_gaincode = 0x8a;\r\nclip1lo_gaincode_B = 8;\r\nrfseq_init_gain = rfseqA_init_gain_rev7;\r\ntia_gain_db = tiaA_gain_db_rev7;\r\ntia_gainbits = tiaA_gainbits_rev7;\r\nfreq = CHAN5G_FREQ(CHSPEC_CHANNEL(pi->radio_chanspec));\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nw1clip_th = 25;\r\nclip1md_gaincode = 0x82;\r\nif ((freq <= 5080) || (freq == 5825)) {\r\ns8 lna1A_gain_db_rev7[] = { 11, 16, 20, 24 };\r\ns8 lna1A_gain_db_2_rev7[] = {\r\n11, 17, 22, 25};\r\ns8 lna2A_gain_db_rev7[] = { -1, 6, 10, 14 };\r\ncrsminu_th = 0x3e;\r\nlna1_gain_db = lna1A_gain_db_rev7;\r\nlna1_gain_db_2 = lna1A_gain_db_2_rev7;\r\nlna2_gain_db = lna2A_gain_db_rev7;\r\n} else if ((freq >= 5500) && (freq <= 5700)) {\r\ns8 lna1A_gain_db_rev7[] = { 11, 17, 21, 25 };\r\ns8 lna1A_gain_db_2_rev7[] = {\r\n12, 18, 22, 26};\r\ns8 lna2A_gain_db_rev7[] = { 1, 8, 12, 16 };\r\ncrsminu_th = 0x45;\r\nclip1md_gaincode_B = 0x14;\r\nnbclip_th = 0xff;\r\nchg_nbclip_th = 1;\r\nlna1_gain_db = lna1A_gain_db_rev7;\r\nlna1_gain_db_2 = lna1A_gain_db_2_rev7;\r\nlna2_gain_db = lna2A_gain_db_rev7;\r\n} else {\r\ns8 lna1A_gain_db_rev7[] = { 12, 18, 22, 26 };\r\ns8 lna1A_gain_db_2_rev7[] = {\r\n12, 18, 22, 26};\r\ns8 lna2A_gain_db_rev7[] = { -1, 6, 10, 14 };\r\ncrsminu_th = 0x41;\r\nlna1_gain_db = lna1A_gain_db_rev7;\r\nlna1_gain_db_2 = lna1A_gain_db_2_rev7;\r\nlna2_gain_db = lna2A_gain_db_rev7;\r\n}\r\nif (freq <= 4920) {\r\nnvar_baseline_offset0 = 5;\r\nnvar_baseline_offset1 = 5;\r\n} else if ((freq > 4920) && (freq <= 5320)) {\r\nnvar_baseline_offset0 = 3;\r\nnvar_baseline_offset1 = 5;\r\n} else if ((freq > 5320) && (freq <= 5700)) {\r\nnvar_baseline_offset0 = 3;\r\nnvar_baseline_offset1 = 2;\r\n} else {\r\nnvar_baseline_offset0 = 4;\r\nnvar_baseline_offset1 = 0;\r\n}\r\n} else {\r\ncrsminu_th = 0x3a;\r\ncrsminl_th = 0x3a;\r\nw1clip_th = 20;\r\nif ((freq >= 4920) && (freq <= 5320)) {\r\nnvar_baseline_offset0 = 4;\r\nnvar_baseline_offset1 = 5;\r\n} else if ((freq > 5320) && (freq <= 5550)) {\r\nnvar_baseline_offset0 = 4;\r\nnvar_baseline_offset1 = 2;\r\n} else {\r\nnvar_baseline_offset0 = 5;\r\nnvar_baseline_offset1 = 3;\r\n}\r\n}\r\nwrite_phy_reg(pi, 0x20, init_gaincode);\r\nwrite_phy_reg(pi, 0x2a7, init_gaincode);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\npi->pubpi.phy_corenum, 0x106, 16,\r\nrfseq_init_gain);\r\nwrite_phy_reg(pi, 0x22, clip1hi_gaincode);\r\nwrite_phy_reg(pi, 0x2a9, clip1hi_gaincode);\r\nwrite_phy_reg(pi, 0x36, clip1md_gaincode_B);\r\nwrite_phy_reg(pi, 0x2ac, clip1md_gaincode_B);\r\nwrite_phy_reg(pi, 0x37, clip1lo_gaincode);\r\nwrite_phy_reg(pi, 0x2ad, clip1lo_gaincode);\r\nwrite_phy_reg(pi, 0x38, clip1lo_gaincode_B);\r\nwrite_phy_reg(pi, 0x2ae, clip1lo_gaincode_B);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 10, 0x20, 8,\r\ntia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 10, 0x20, 8,\r\ntia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS1, 10, 0x20, 8,\r\ntia_gainbits);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS2, 10, 0x20, 8,\r\ntia_gainbits);\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (crsminu_th << 0));\r\nif (chg_nbclip_th == 1) {\r\nwrite_phy_reg(pi, 0x2b, nbclip_th);\r\nwrite_phy_reg(pi, 0x41, nbclip_th);\r\n}\r\nmod_phy_reg(pi, 0x300, (0x3f << 0), (w1clip_th << 0));\r\nmod_phy_reg(pi, 0x301, (0x3f << 0), (w1clip_th << 0));\r\nmod_phy_reg(pi, 0x2e4,\r\n(0x3f << 0), (nvar_baseline_offset0 << 0));\r\nmod_phy_reg(pi, 0x2e4,\r\n(0x3f << 6), (nvar_baseline_offset1 << 6));\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 8, 8,\r\nlna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 8, 8,\r\nlna1_gain_db_2);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 0x10,\r\n8, lna2_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 0x10,\r\n8, lna2_gain_db);\r\nwrite_phy_reg(pi, 0x24, clip1md_gaincode);\r\nwrite_phy_reg(pi, 0x2ab, clip1md_gaincode);\r\n} else {\r\nmod_phy_reg(pi, 0x280, (0xff << 0), (crsminl_th << 0));\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_workarounds_nphy_gainctrl(struct brcms_phy *pi)\r\n{\r\nu16 w1th, hpf_code, currband;\r\nint ctr;\r\nu8 rfseq_updategainu_events[] = {\r\nNPHY_RFSEQ_CMD_RX_GAIN,\r\nNPHY_RFSEQ_CMD_CLR_HIQ_DIS,\r\nNPHY_RFSEQ_CMD_SET_HPF_BW\r\n};\r\nu8 rfseq_updategainu_dlys[] = { 10, 30, 1 };\r\ns8 lna1G_gain_db[] = { 7, 11, 16, 23 };\r\ns8 lna1G_gain_db_rev4[] = { 8, 12, 17, 25 };\r\ns8 lna1G_gain_db_rev5[] = { 9, 13, 18, 26 };\r\ns8 lna1G_gain_db_rev6[] = { 8, 13, 18, 25 };\r\ns8 lna1G_gain_db_rev6_224B0[] = { 10, 14, 19, 27 };\r\ns8 lna1A_gain_db[] = { 7, 11, 17, 23 };\r\ns8 lna1A_gain_db_rev4[] = { 8, 12, 18, 23 };\r\ns8 lna1A_gain_db_rev5[] = { 6, 10, 16, 21 };\r\ns8 lna1A_gain_db_rev6[] = { 6, 10, 16, 21 };\r\ns8 *lna1_gain_db = NULL;\r\ns8 lna2G_gain_db[] = { -5, 6, 10, 14 };\r\ns8 lna2G_gain_db_rev5[] = { -3, 7, 11, 16 };\r\ns8 lna2G_gain_db_rev6[] = { -5, 6, 10, 14 };\r\ns8 lna2G_gain_db_rev6_224B0[] = { -5, 6, 10, 15 };\r\ns8 lna2A_gain_db[] = { -6, 2, 6, 10 };\r\ns8 lna2A_gain_db_rev4[] = { -5, 2, 6, 10 };\r\ns8 lna2A_gain_db_rev5[] = { -7, 0, 4, 8 };\r\ns8 lna2A_gain_db_rev6[] = { -7, 0, 4, 8 };\r\ns8 *lna2_gain_db = NULL;\r\ns8 tiaG_gain_db[] = {\r\n0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A };\r\ns8 tiaA_gain_db[] = {\r\n0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13 };\r\ns8 tiaA_gain_db_rev4[] = {\r\n0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d };\r\ns8 tiaA_gain_db_rev5[] = {\r\n0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d };\r\ns8 tiaA_gain_db_rev6[] = {\r\n0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d, 0x0d };\r\ns8 *tia_gain_db;\r\ns8 tiaG_gainbits[] = {\r\n0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03 };\r\ns8 tiaA_gainbits[] = {\r\n0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06 };\r\ns8 tiaA_gainbits_rev4[] = {\r\n0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 };\r\ns8 tiaA_gainbits_rev5[] = {\r\n0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 };\r\ns8 tiaA_gainbits_rev6[] = {\r\n0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 };\r\ns8 *tia_gainbits;\r\ns8 lpf_gain_db[] = { 0x00, 0x06, 0x0c, 0x12, 0x12, 0x12 };\r\ns8 lpf_gainbits[] = { 0x00, 0x01, 0x02, 0x03, 0x03, 0x03 };\r\nu16 rfseqG_init_gain[] = { 0x613f, 0x613f, 0x613f, 0x613f };\r\nu16 rfseqG_init_gain_rev4[] = { 0x513f, 0x513f, 0x513f, 0x513f };\r\nu16 rfseqG_init_gain_rev5[] = { 0x413f, 0x413f, 0x413f, 0x413f };\r\nu16 rfseqG_init_gain_rev5_elna[] = {\r\n0x013f, 0x013f, 0x013f, 0x013f };\r\nu16 rfseqG_init_gain_rev6[] = { 0x513f, 0x513f };\r\nu16 rfseqG_init_gain_rev6_224B0[] = { 0x413f, 0x413f };\r\nu16 rfseqG_init_gain_rev6_elna[] = { 0x113f, 0x113f };\r\nu16 rfseqA_init_gain[] = { 0x516f, 0x516f, 0x516f, 0x516f };\r\nu16 rfseqA_init_gain_rev4[] = { 0x614f, 0x614f, 0x614f, 0x614f };\r\nu16 rfseqA_init_gain_rev4_elna[] = {\r\n0x314f, 0x314f, 0x314f, 0x314f };\r\nu16 rfseqA_init_gain_rev5[] = { 0x714f, 0x714f, 0x714f, 0x714f };\r\nu16 rfseqA_init_gain_rev6[] = { 0x714f, 0x714f };\r\nu16 *rfseq_init_gain;\r\nu16 initG_gaincode = 0x627e;\r\nu16 initG_gaincode_rev4 = 0x527e;\r\nu16 initG_gaincode_rev5 = 0x427e;\r\nu16 initG_gaincode_rev5_elna = 0x027e;\r\nu16 initG_gaincode_rev6 = 0x527e;\r\nu16 initG_gaincode_rev6_224B0 = 0x427e;\r\nu16 initG_gaincode_rev6_elna = 0x127e;\r\nu16 initA_gaincode = 0x52de;\r\nu16 initA_gaincode_rev4 = 0x629e;\r\nu16 initA_gaincode_rev4_elna = 0x329e;\r\nu16 initA_gaincode_rev5 = 0x729e;\r\nu16 initA_gaincode_rev6 = 0x729e;\r\nu16 init_gaincode;\r\nu16 clip1hiG_gaincode = 0x107e;\r\nu16 clip1hiG_gaincode_rev4 = 0x007e;\r\nu16 clip1hiG_gaincode_rev5 = 0x1076;\r\nu16 clip1hiG_gaincode_rev6 = 0x007e;\r\nu16 clip1hiA_gaincode = 0x00de;\r\nu16 clip1hiA_gaincode_rev4 = 0x029e;\r\nu16 clip1hiA_gaincode_rev5 = 0x029e;\r\nu16 clip1hiA_gaincode_rev6 = 0x029e;\r\nu16 clip1hi_gaincode;\r\nu16 clip1mdG_gaincode = 0x0066;\r\nu16 clip1mdA_gaincode = 0x00ca;\r\nu16 clip1mdA_gaincode_rev4 = 0x1084;\r\nu16 clip1mdA_gaincode_rev5 = 0x2084;\r\nu16 clip1mdA_gaincode_rev6 = 0x2084;\r\nu16 clip1md_gaincode = 0;\r\nu16 clip1loG_gaincode = 0x0074;\r\nu16 clip1loG_gaincode_rev5[] = {\r\n0x0062, 0x0064, 0x006a, 0x106a, 0x106c, 0x1074, 0x107c, 0x207c\r\n};\r\nu16 clip1loG_gaincode_rev6[] = {\r\n0x106a, 0x106c, 0x1074, 0x107c, 0x007e, 0x107e, 0x207e, 0x307e\r\n};\r\nu16 clip1loG_gaincode_rev6_224B0 = 0x1074;\r\nu16 clip1loA_gaincode = 0x00cc;\r\nu16 clip1loA_gaincode_rev4 = 0x0086;\r\nu16 clip1loA_gaincode_rev5 = 0x2086;\r\nu16 clip1loA_gaincode_rev6 = 0x2086;\r\nu16 clip1lo_gaincode;\r\nu8 crsminG_th = 0x18;\r\nu8 crsminG_th_rev5 = 0x18;\r\nu8 crsminG_th_rev6 = 0x18;\r\nu8 crsminA_th = 0x1e;\r\nu8 crsminA_th_rev4 = 0x24;\r\nu8 crsminA_th_rev5 = 0x24;\r\nu8 crsminA_th_rev6 = 0x24;\r\nu8 crsmin_th;\r\nu8 crsminlG_th = 0x18;\r\nu8 crsminlG_th_rev5 = 0x18;\r\nu8 crsminlG_th_rev6 = 0x18;\r\nu8 crsminlA_th = 0x1e;\r\nu8 crsminlA_th_rev4 = 0x24;\r\nu8 crsminlA_th_rev5 = 0x24;\r\nu8 crsminlA_th_rev6 = 0x24;\r\nu8 crsminl_th = 0;\r\nu8 crsminuG_th = 0x18;\r\nu8 crsminuG_th_rev5 = 0x18;\r\nu8 crsminuG_th_rev6 = 0x18;\r\nu8 crsminuA_th = 0x1e;\r\nu8 crsminuA_th_rev4 = 0x24;\r\nu8 crsminuA_th_rev5 = 0x24;\r\nu8 crsminuA_th_rev6 = 0x24;\r\nu8 crsminuA_th_rev6_224B0 = 0x2d;\r\nu8 crsminu_th;\r\nu16 nbclipG_th = 0x20d;\r\nu16 nbclipG_th_rev4 = 0x1a1;\r\nu16 nbclipG_th_rev5 = 0x1d0;\r\nu16 nbclipG_th_rev6 = 0x1d0;\r\nu16 nbclipA_th = 0x1a1;\r\nu16 nbclipA_th_rev4 = 0x107;\r\nu16 nbclipA_th_rev5 = 0x0a9;\r\nu16 nbclipA_th_rev6 = 0x0f0;\r\nu16 nbclip_th = 0;\r\nu8 w1clipG_th = 5;\r\nu8 w1clipG_th_rev5 = 9;\r\nu8 w1clipG_th_rev6 = 5;\r\nu8 w1clipA_th = 25, w1clip_th;\r\nu8 rssi_gain_default = 0x50;\r\nu8 rssiG_gain_rev6_224B0 = 0x50;\r\nu8 rssiA_gain_rev5 = 0x90;\r\nu8 rssiA_gain_rev6 = 0x90;\r\nu8 rssi_gain;\r\nu16 regval[21];\r\nu8 triso;\r\ntriso = (CHSPEC_IS5G(pi->radio_chanspec)) ? pi->srom_fem5g.triso :\r\npi->srom_fem2g.triso;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (pi->pubpi.radiorev == 5) {\r\nwlc_phy_workarounds_nphy_gainctrl_2057_rev5(pi);\r\n} else if (pi->pubpi.radiorev == 7) {\r\nwlc_phy_workarounds_nphy_gainctrl_2057_rev6(pi);\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (0x44 << 0));\r\nmod_phy_reg(pi, 0x280, (0xff << 0), (0x44 << 0));\r\n} else if ((pi->pubpi.radiorev == 3)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nwlc_phy_workarounds_nphy_gainctrl_2057_rev6(pi);\r\nif (pi->pubpi.radiorev == 8) {\r\nmod_phy_reg(pi, 0x283,\r\n(0xff << 0), (0x44 << 0));\r\nmod_phy_reg(pi, 0x280,\r\n(0xff << 0), (0x44 << 0));\r\n}\r\n} else {\r\nwlc_phy_workarounds_nphy_gainctrl_2057_rev6(pi);\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nmod_phy_reg(pi, 0xa0, (0x1 << 6), (1 << 6));\r\nmod_phy_reg(pi, 0x1c, (0x1 << 13), (1 << 13));\r\nmod_phy_reg(pi, 0x32, (0x1 << 13), (1 << 13));\r\ncurrband =\r\nread_phy_reg(pi, 0x09) & NPHY_BandControl_currentBand;\r\nif (currband == 0) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nif (pi->pubpi.radiorev == 11) {\r\nlna1_gain_db = lna1G_gain_db_rev6_224B0;\r\nlna2_gain_db = lna2G_gain_db_rev6_224B0;\r\nrfseq_init_gain =\r\nrfseqG_init_gain_rev6_224B0;\r\ninit_gaincode =\r\ninitG_gaincode_rev6_224B0;\r\nclip1hi_gaincode =\r\nclip1hiG_gaincode_rev6;\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6_224B0;\r\nnbclip_th = nbclipG_th_rev6;\r\nw1clip_th = w1clipG_th_rev6;\r\ncrsmin_th = crsminG_th_rev6;\r\ncrsminl_th = crsminlG_th_rev6;\r\ncrsminu_th = crsminuG_th_rev6;\r\nrssi_gain = rssiG_gain_rev6_224B0;\r\n} else {\r\nlna1_gain_db = lna1G_gain_db_rev6;\r\nlna2_gain_db = lna2G_gain_db_rev6;\r\nif (pi->sh->boardflags & BFL_EXTLNA) {\r\nrfseq_init_gain =\r\nrfseqG_init_gain_rev6_elna;\r\ninit_gaincode =\r\ninitG_gaincode_rev6_elna;\r\n} else {\r\nrfseq_init_gain =\r\nrfseqG_init_gain_rev6;\r\ninit_gaincode =\r\ninitG_gaincode_rev6;\r\n}\r\nclip1hi_gaincode =\r\nclip1hiG_gaincode_rev6;\r\nswitch (triso) {\r\ncase 0:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[0];\r\nbreak;\r\ncase 1:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[1];\r\nbreak;\r\ncase 2:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[2];\r\nbreak;\r\ncase 3:\r\ndefault:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[3];\r\nbreak;\r\ncase 4:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[4];\r\nbreak;\r\ncase 5:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[5];\r\nbreak;\r\ncase 6:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[6];\r\nbreak;\r\ncase 7:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev6\r\n[7];\r\nbreak;\r\n}\r\nnbclip_th = nbclipG_th_rev6;\r\nw1clip_th = w1clipG_th_rev6;\r\ncrsmin_th = crsminG_th_rev6;\r\ncrsminl_th = crsminlG_th_rev6;\r\ncrsminu_th = crsminuG_th_rev6;\r\nrssi_gain = rssi_gain_default;\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\nlna1_gain_db = lna1G_gain_db_rev5;\r\nlna2_gain_db = lna2G_gain_db_rev5;\r\nif (pi->sh->boardflags & BFL_EXTLNA) {\r\nrfseq_init_gain =\r\nrfseqG_init_gain_rev5_elna;\r\ninit_gaincode =\r\ninitG_gaincode_rev5_elna;\r\n} else {\r\nrfseq_init_gain = rfseqG_init_gain_rev5;\r\ninit_gaincode = initG_gaincode_rev5;\r\n}\r\nclip1hi_gaincode = clip1hiG_gaincode_rev5;\r\nswitch (triso) {\r\ncase 0:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[0];\r\nbreak;\r\ncase 1:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[1];\r\nbreak;\r\ncase 2:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[2];\r\nbreak;\r\ncase 3:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[3];\r\nbreak;\r\ncase 4:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[4];\r\nbreak;\r\ncase 5:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[5];\r\nbreak;\r\ncase 6:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[6];\r\nbreak;\r\ncase 7:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[7];\r\nbreak;\r\ndefault:\r\nclip1lo_gaincode =\r\nclip1loG_gaincode_rev5[3];\r\nbreak;\r\n}\r\nnbclip_th = nbclipG_th_rev5;\r\nw1clip_th = w1clipG_th_rev5;\r\ncrsmin_th = crsminG_th_rev5;\r\ncrsminl_th = crsminlG_th_rev5;\r\ncrsminu_th = crsminuG_th_rev5;\r\nrssi_gain = rssi_gain_default;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 4)) {\r\nlna1_gain_db = lna1G_gain_db_rev4;\r\nlna2_gain_db = lna2G_gain_db;\r\nrfseq_init_gain = rfseqG_init_gain_rev4;\r\ninit_gaincode = initG_gaincode_rev4;\r\nclip1hi_gaincode = clip1hiG_gaincode_rev4;\r\nclip1lo_gaincode = clip1loG_gaincode;\r\nnbclip_th = nbclipG_th_rev4;\r\nw1clip_th = w1clipG_th;\r\ncrsmin_th = crsminG_th;\r\ncrsminl_th = crsminlG_th;\r\ncrsminu_th = crsminuG_th;\r\nrssi_gain = rssi_gain_default;\r\n} else {\r\nlna1_gain_db = lna1G_gain_db;\r\nlna2_gain_db = lna2G_gain_db;\r\nrfseq_init_gain = rfseqG_init_gain;\r\ninit_gaincode = initG_gaincode;\r\nclip1hi_gaincode = clip1hiG_gaincode;\r\nclip1lo_gaincode = clip1loG_gaincode;\r\nnbclip_th = nbclipG_th;\r\nw1clip_th = w1clipG_th;\r\ncrsmin_th = crsminG_th;\r\ncrsminl_th = crsminlG_th;\r\ncrsminu_th = crsminuG_th;\r\nrssi_gain = rssi_gain_default;\r\n}\r\ntia_gain_db = tiaG_gain_db;\r\ntia_gainbits = tiaG_gainbits;\r\nclip1md_gaincode = clip1mdG_gaincode;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nlna1_gain_db = lna1A_gain_db_rev6;\r\nlna2_gain_db = lna2A_gain_db_rev6;\r\ntia_gain_db = tiaA_gain_db_rev6;\r\ntia_gainbits = tiaA_gainbits_rev6;\r\nrfseq_init_gain = rfseqA_init_gain_rev6;\r\ninit_gaincode = initA_gaincode_rev6;\r\nclip1hi_gaincode = clip1hiA_gaincode_rev6;\r\nclip1md_gaincode = clip1mdA_gaincode_rev6;\r\nclip1lo_gaincode = clip1loA_gaincode_rev6;\r\ncrsmin_th = crsminA_th_rev6;\r\ncrsminl_th = crsminlA_th_rev6;\r\nif ((pi->pubpi.radiorev == 11) &&\r\n(CHSPEC_IS40(pi->radio_chanspec) == 0))\r\ncrsminu_th = crsminuA_th_rev6_224B0;\r\nelse\r\ncrsminu_th = crsminuA_th_rev6;\r\nnbclip_th = nbclipA_th_rev6;\r\nrssi_gain = rssiA_gain_rev6;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\nlna1_gain_db = lna1A_gain_db_rev5;\r\nlna2_gain_db = lna2A_gain_db_rev5;\r\ntia_gain_db = tiaA_gain_db_rev5;\r\ntia_gainbits = tiaA_gainbits_rev5;\r\nrfseq_init_gain = rfseqA_init_gain_rev5;\r\ninit_gaincode = initA_gaincode_rev5;\r\nclip1hi_gaincode = clip1hiA_gaincode_rev5;\r\nclip1md_gaincode = clip1mdA_gaincode_rev5;\r\nclip1lo_gaincode = clip1loA_gaincode_rev5;\r\ncrsmin_th = crsminA_th_rev5;\r\ncrsminl_th = crsminlA_th_rev5;\r\ncrsminu_th = crsminuA_th_rev5;\r\nnbclip_th = nbclipA_th_rev5;\r\nrssi_gain = rssiA_gain_rev5;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 4)) {\r\nlna1_gain_db = lna1A_gain_db_rev4;\r\nlna2_gain_db = lna2A_gain_db_rev4;\r\ntia_gain_db = tiaA_gain_db_rev4;\r\ntia_gainbits = tiaA_gainbits_rev4;\r\nif (pi->sh->boardflags & BFL_EXTLNA_5GHz) {\r\nrfseq_init_gain =\r\nrfseqA_init_gain_rev4_elna;\r\ninit_gaincode =\r\ninitA_gaincode_rev4_elna;\r\n} else {\r\nrfseq_init_gain = rfseqA_init_gain_rev4;\r\ninit_gaincode = initA_gaincode_rev4;\r\n}\r\nclip1hi_gaincode = clip1hiA_gaincode_rev4;\r\nclip1md_gaincode = clip1mdA_gaincode_rev4;\r\nclip1lo_gaincode = clip1loA_gaincode_rev4;\r\ncrsmin_th = crsminA_th_rev4;\r\ncrsminl_th = crsminlA_th_rev4;\r\ncrsminu_th = crsminuA_th_rev4;\r\nnbclip_th = nbclipA_th_rev4;\r\nrssi_gain = rssi_gain_default;\r\n} else {\r\nlna1_gain_db = lna1A_gain_db;\r\nlna2_gain_db = lna2A_gain_db;\r\ntia_gain_db = tiaA_gain_db;\r\ntia_gainbits = tiaA_gainbits;\r\nrfseq_init_gain = rfseqA_init_gain;\r\ninit_gaincode = initA_gaincode;\r\nclip1hi_gaincode = clip1hiA_gaincode;\r\nclip1md_gaincode = clip1mdA_gaincode;\r\nclip1lo_gaincode = clip1loA_gaincode;\r\ncrsmin_th = crsminA_th;\r\ncrsminl_th = crsminlA_th;\r\ncrsminu_th = crsminuA_th;\r\nnbclip_th = nbclipA_th;\r\nrssi_gain = rssi_gain_default;\r\n}\r\nw1clip_th = w1clipA_th;\r\n}\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_BIASPOLE_LNAG1_IDAC |\r\nRADIO_2056_RX0), 0x17);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_BIASPOLE_LNAG1_IDAC |\r\nRADIO_2056_RX1), 0x17);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_LNAG2_IDAC | RADIO_2056_RX0),\r\n0xf0);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_LNAG2_IDAC | RADIO_2056_RX1),\r\n0xf0);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_RSSI_POLE | RADIO_2056_RX0),\r\n0x0);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_RSSI_POLE | RADIO_2056_RX1),\r\n0x0);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_RSSI_GAIN | RADIO_2056_RX0),\r\nrssi_gain);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_RSSI_GAIN | RADIO_2056_RX1),\r\nrssi_gain);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_BIASPOLE_LNAA1_IDAC |\r\nRADIO_2056_RX0), 0x17);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_BIASPOLE_LNAA1_IDAC |\r\nRADIO_2056_RX1), 0x17);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_LNAA2_IDAC | RADIO_2056_RX0),\r\n0xFF);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_LNAA2_IDAC | RADIO_2056_RX1),\r\n0xFF);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 8,\r\n8, lna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 8,\r\n8, lna1_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 4, 0x10,\r\n8, lna2_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 4, 0x10,\r\n8, lna2_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 10, 0x20,\r\n8, tia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 10, 0x20,\r\n8, tia_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS1, 10, 0x20,\r\n8, tia_gainbits);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS2, 10, 0x20,\r\n8, tia_gainbits);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN1, 6, 0x40,\r\n8, &lpf_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAIN2, 6, 0x40,\r\n8, &lpf_gain_db);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS1, 6, 0x40,\r\n8, &lpf_gainbits);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_GAINBITS2, 6, 0x40,\r\n8, &lpf_gainbits);\r\nwrite_phy_reg(pi, 0x20, init_gaincode);\r\nwrite_phy_reg(pi, 0x2a7, init_gaincode);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\npi->pubpi.phy_corenum, 0x106, 16,\r\nrfseq_init_gain);\r\nwrite_phy_reg(pi, 0x22, clip1hi_gaincode);\r\nwrite_phy_reg(pi, 0x2a9, clip1hi_gaincode);\r\nwrite_phy_reg(pi, 0x24, clip1md_gaincode);\r\nwrite_phy_reg(pi, 0x2ab, clip1md_gaincode);\r\nwrite_phy_reg(pi, 0x37, clip1lo_gaincode);\r\nwrite_phy_reg(pi, 0x2ad, clip1lo_gaincode);\r\nmod_phy_reg(pi, 0x27d, (0xff << 0), (crsmin_th << 0));\r\nmod_phy_reg(pi, 0x280, (0xff << 0), (crsminl_th << 0));\r\nmod_phy_reg(pi, 0x283, (0xff << 0), (crsminu_th << 0));\r\nwrite_phy_reg(pi, 0x2b, nbclip_th);\r\nwrite_phy_reg(pi, 0x41, nbclip_th);\r\nmod_phy_reg(pi, 0x27, (0x3f << 0), (w1clip_th << 0));\r\nmod_phy_reg(pi, 0x3d, (0x3f << 0), (w1clip_th << 0));\r\nwrite_phy_reg(pi, 0x150, 0x809c);\r\n} else {\r\nmod_phy_reg(pi, 0x1c, (0x1 << 13), (1 << 13));\r\nmod_phy_reg(pi, 0x32, (0x1 << 13), (1 << 13));\r\nwrite_phy_reg(pi, 0x2b, 0x84);\r\nwrite_phy_reg(pi, 0x41, 0x84);\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nwrite_phy_reg(pi, 0x6b, 0x2b);\r\nwrite_phy_reg(pi, 0x6c, 0x2b);\r\nwrite_phy_reg(pi, 0x6d, 0x9);\r\nwrite_phy_reg(pi, 0x6e, 0x9);\r\n}\r\nw1th = NPHY_RSSICAL_W1_TARGET - 4;\r\nmod_phy_reg(pi, 0x27, (0x3f << 0), (w1th << 0));\r\nmod_phy_reg(pi, 0x3d, (0x3f << 0), (w1th << 0));\r\nif (CHSPEC_IS20(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x1c, (0x1f << 0), (0x1 << 0));\r\nmod_phy_reg(pi, 0x32, (0x1f << 0), (0x1 << 0));\r\nmod_phy_reg(pi, 0x1d, (0x1f << 0), (0x1 << 0));\r\nmod_phy_reg(pi, 0x33, (0x1f << 0), (0x1 << 0));\r\n}\r\nwrite_phy_reg(pi, 0x150, 0x809c);\r\nif (pi->nphy_gain_boost)\r\nif ((CHSPEC_IS2G(pi->radio_chanspec)) &&\r\n(CHSPEC_IS40(pi->radio_chanspec)))\r\nhpf_code = 4;\r\nelse\r\nhpf_code = 5;\r\nelse if (CHSPEC_IS40(pi->radio_chanspec))\r\nhpf_code = 6;\r\nelse\r\nhpf_code = 7;\r\nmod_phy_reg(pi, 0x20, (0x1f << 7), (hpf_code << 7));\r\nmod_phy_reg(pi, 0x36, (0x1f << 7), (hpf_code << 7));\r\nfor (ctr = 0; ctr < 4; ctr++)\r\nregval[ctr] = (hpf_code << 8) | 0x7c;\r\nwlc_phy_table_write_nphy(pi, 7, 4, 0x106, 16, regval);\r\nwlc_phy_adjust_lnagaintbl_nphy(pi);\r\nif (pi->nphy_elna_gain_config) {\r\nregval[0] = 0;\r\nregval[1] = 1;\r\nregval[2] = 1;\r\nregval[3] = 1;\r\nwlc_phy_table_write_nphy(pi, 2, 4, 8, 16, regval);\r\nwlc_phy_table_write_nphy(pi, 3, 4, 8, 16, regval);\r\nfor (ctr = 0; ctr < 4; ctr++)\r\nregval[ctr] = (hpf_code << 8) | 0x74;\r\nwlc_phy_table_write_nphy(pi, 7, 4, 0x106, 16, regval);\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 2)) {\r\nfor (ctr = 0; ctr < 21; ctr++)\r\nregval[ctr] = 3 * ctr;\r\nwlc_phy_table_write_nphy(pi, 0, 21, 32, 16, regval);\r\nwlc_phy_table_write_nphy(pi, 1, 21, 32, 16, regval);\r\nfor (ctr = 0; ctr < 21; ctr++)\r\nregval[ctr] = (u16) ctr;\r\nwlc_phy_table_write_nphy(pi, 2, 21, 32, 16, regval);\r\nwlc_phy_table_write_nphy(pi, 3, 21, 32, 16, regval);\r\n}\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_UPDATEGAINU,\r\nrfseq_updategainu_events,\r\nrfseq_updategainu_dlys,\r\nsizeof(rfseq_updategainu_events) /\r\nsizeof(rfseq_updategainu_events[0]));\r\nmod_phy_reg(pi, 0x153, (0xff << 8), (90 << 8));\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nmod_phy_reg(pi,\r\n(NPHY_TO_BPHY_OFF + BPHY_OPTIONAL_MODES),\r\n0x7f, 0x4);\r\n}\r\n}\r\nstatic void wlc_phy_workarounds_nphy(struct brcms_phy *pi)\r\n{\r\nu8 rfseq_rx2tx_events[] = {\r\nNPHY_RFSEQ_CMD_NOP,\r\nNPHY_RFSEQ_CMD_RXG_FBW,\r\nNPHY_RFSEQ_CMD_TR_SWITCH,\r\nNPHY_RFSEQ_CMD_CLR_HIQ_DIS,\r\nNPHY_RFSEQ_CMD_RXPD_TXPD,\r\nNPHY_RFSEQ_CMD_TX_GAIN,\r\nNPHY_RFSEQ_CMD_EXT_PA\r\n};\r\nu8 rfseq_rx2tx_dlys[] = { 8, 6, 6, 2, 4, 60, 1 };\r\nu8 rfseq_tx2rx_events[] = {\r\nNPHY_RFSEQ_CMD_NOP,\r\nNPHY_RFSEQ_CMD_EXT_PA,\r\nNPHY_RFSEQ_CMD_TX_GAIN,\r\nNPHY_RFSEQ_CMD_RXPD_TXPD,\r\nNPHY_RFSEQ_CMD_TR_SWITCH,\r\nNPHY_RFSEQ_CMD_RXG_FBW,\r\nNPHY_RFSEQ_CMD_CLR_HIQ_DIS\r\n};\r\nu8 rfseq_tx2rx_dlys[] = { 8, 6, 2, 4, 4, 6, 1 };\r\nu8 rfseq_tx2rx_events_rev3[] = {\r\nNPHY_REV3_RFSEQ_CMD_EXT_PA,\r\nNPHY_REV3_RFSEQ_CMD_INT_PA_PU,\r\nNPHY_REV3_RFSEQ_CMD_TX_GAIN,\r\nNPHY_REV3_RFSEQ_CMD_RXPD_TXPD,\r\nNPHY_REV3_RFSEQ_CMD_TR_SWITCH,\r\nNPHY_REV3_RFSEQ_CMD_RXG_FBW,\r\nNPHY_REV3_RFSEQ_CMD_CLR_HIQ_DIS,\r\nNPHY_REV3_RFSEQ_CMD_END\r\n};\r\nu8 rfseq_tx2rx_dlys_rev3[] = { 8, 4, 2, 2, 4, 4, 6, 1 };\r\nu8 rfseq_rx2tx_events_rev3[] = {\r\nNPHY_REV3_RFSEQ_CMD_NOP,\r\nNPHY_REV3_RFSEQ_CMD_RXG_FBW,\r\nNPHY_REV3_RFSEQ_CMD_TR_SWITCH,\r\nNPHY_REV3_RFSEQ_CMD_CLR_HIQ_DIS,\r\nNPHY_REV3_RFSEQ_CMD_RXPD_TXPD,\r\nNPHY_REV3_RFSEQ_CMD_TX_GAIN,\r\nNPHY_REV3_RFSEQ_CMD_INT_PA_PU,\r\nNPHY_REV3_RFSEQ_CMD_EXT_PA,\r\nNPHY_REV3_RFSEQ_CMD_END\r\n};\r\nu8 rfseq_rx2tx_dlys_rev3[] = { 8, 6, 6, 4, 4, 18, 42, 1, 1 };\r\nu8 rfseq_rx2tx_events_rev3_ipa[] = {\r\nNPHY_REV3_RFSEQ_CMD_NOP,\r\nNPHY_REV3_RFSEQ_CMD_RXG_FBW,\r\nNPHY_REV3_RFSEQ_CMD_TR_SWITCH,\r\nNPHY_REV3_RFSEQ_CMD_CLR_HIQ_DIS,\r\nNPHY_REV3_RFSEQ_CMD_RXPD_TXPD,\r\nNPHY_REV3_RFSEQ_CMD_TX_GAIN,\r\nNPHY_REV3_RFSEQ_CMD_CLR_RXRX_BIAS,\r\nNPHY_REV3_RFSEQ_CMD_INT_PA_PU,\r\nNPHY_REV3_RFSEQ_CMD_END\r\n};\r\nu8 rfseq_rx2tx_dlys_rev3_ipa[] = { 8, 6, 6, 4, 4, 16, 43, 1, 1 };\r\nu16 rfseq_rx2tx_dacbufpu_rev7[] = { 0x10f, 0x10f };\r\ns16 alpha0, alpha1, alpha2;\r\ns16 beta0, beta1, beta2;\r\nu32 leg_data_weights, ht_data_weights, nss1_data_weights,\r\nstbc_data_weights;\r\nu8 chan_freq_range = 0;\r\nu16 dac_control = 0x0002;\r\nu16 aux_adc_vmid_rev7_core0[] = { 0x8e, 0x96, 0x96, 0x96 };\r\nu16 aux_adc_vmid_rev7_core1[] = { 0x8f, 0x9f, 0x9f, 0x96 };\r\nu16 aux_adc_vmid_rev4[] = { 0xa2, 0xb4, 0xb4, 0x89 };\r\nu16 aux_adc_vmid_rev3[] = { 0xa2, 0xb4, 0xb4, 0x89 };\r\nu16 *aux_adc_vmid;\r\nu16 aux_adc_gain_rev7[] = { 0x02, 0x02, 0x02, 0x02 };\r\nu16 aux_adc_gain_rev4[] = { 0x02, 0x02, 0x02, 0x00 };\r\nu16 aux_adc_gain_rev3[] = { 0x02, 0x02, 0x02, 0x00 };\r\nu16 *aux_adc_gain;\r\nu16 sk_adc_vmid[] = { 0xb4, 0xb4, 0xb4, 0x24 };\r\nu16 sk_adc_gain[] = { 0x02, 0x02, 0x02, 0x02 };\r\ns32 min_nvar_val = 0x18d;\r\ns32 min_nvar_offset_6mbps = 20;\r\nu8 pdetrange;\r\nu8 triso;\r\nu16 regval;\r\nu16 afectrl_adc_ctrl1_rev7 = 0x20;\r\nu16 afectrl_adc_ctrl2_rev7 = 0x0;\r\nu16 rfseq_rx2tx_lpf_h_hpc_rev7 = 0x77;\r\nu16 rfseq_tx2rx_lpf_h_hpc_rev7 = 0x77;\r\nu16 rfseq_pktgn_lpf_h_hpc_rev7 = 0x77;\r\nu16 rfseq_htpktgn_lpf_hpc_rev7[] = { 0x77, 0x11, 0x11 };\r\nu16 rfseq_pktgn_lpf_hpc_rev7[] = { 0x11, 0x11 };\r\nu16 rfseq_cckpktgn_lpf_hpc_rev7[] = { 0x11, 0x11 };\r\nu16 ipalvlshift_3p3_war_en = 0;\r\nu16 rccal_bcap_val, rccal_scap_val;\r\nu16 rccal_tx20_11b_bcap = 0;\r\nu16 rccal_tx20_11b_scap = 0;\r\nu16 rccal_tx20_11n_bcap = 0;\r\nu16 rccal_tx20_11n_scap = 0;\r\nu16 rccal_tx40_11n_bcap = 0;\r\nu16 rccal_tx40_11n_scap = 0;\r\nu16 rx2tx_lpf_rc_lut_tx20_11b = 0;\r\nu16 rx2tx_lpf_rc_lut_tx20_11n = 0;\r\nu16 rx2tx_lpf_rc_lut_tx40_11n = 0;\r\nu16 tx_lpf_bw_ofdm_20mhz = 0;\r\nu16 tx_lpf_bw_ofdm_40mhz = 0;\r\nu16 tx_lpf_bw_11b = 0;\r\nu16 ipa2g_mainbias, ipa2g_casconv, ipa2g_biasfilt;\r\nu16 txgm_idac_bleed = 0;\r\nbool rccal_ovrd = false;\r\nu16 freq;\r\nint coreNum;\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nwlc_phy_classifier_nphy(pi, NPHY_ClassifierCtrl_cck_en, 0);\r\nelse\r\nwlc_phy_classifier_nphy(pi, NPHY_ClassifierCtrl_cck_en, 1);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nor_phy_reg(pi, 0xb1, NPHY_IQFlip_ADC1 | NPHY_IQFlip_ADC2);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)) {\r\nmod_phy_reg(pi, 0x221, (0x1 << 4), (1 << 4));\r\nmod_phy_reg(pi, 0x160, (0x7f << 0), (32 << 0));\r\nmod_phy_reg(pi, 0x160, (0x7f << 8), (39 << 8));\r\nmod_phy_reg(pi, 0x161, (0x7f << 0), (46 << 0));\r\nmod_phy_reg(pi, 0x161, (0x7f << 8), (51 << 8));\r\nmod_phy_reg(pi, 0x162, (0x7f << 0), (55 << 0));\r\nmod_phy_reg(pi, 0x162, (0x7f << 8), (58 << 8));\r\nmod_phy_reg(pi, 0x163, (0x7f << 0), (60 << 0));\r\nmod_phy_reg(pi, 0x163, (0x7f << 8), (62 << 8));\r\nmod_phy_reg(pi, 0x164, (0x7f << 0), (62 << 0));\r\nmod_phy_reg(pi, 0x164, (0x7f << 8), (63 << 8));\r\nmod_phy_reg(pi, 0x165, (0x7f << 0), (63 << 0));\r\nmod_phy_reg(pi, 0x165, (0x7f << 8), (64 << 8));\r\nmod_phy_reg(pi, 0x166, (0x7f << 0), (64 << 0));\r\nmod_phy_reg(pi, 0x166, (0x7f << 8), (64 << 8));\r\nmod_phy_reg(pi, 0x167, (0x7f << 0), (64 << 0));\r\nmod_phy_reg(pi, 0x167, (0x7f << 8), (64 << 8));\r\n}\r\nif (NREV_LE(pi->pubpi.phy_rev, 8)) {\r\nwrite_phy_reg(pi, 0x23f, 0x1b0);\r\nwrite_phy_reg(pi, 0x240, 0x1b0);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 8))\r\nmod_phy_reg(pi, 0xbd, (0xff << 0), (114 << 0));\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x00, 16,\r\n&dac_control);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x10, 16,\r\n&dac_control);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 0, 32, &leg_data_weights);\r\nleg_data_weights = leg_data_weights & 0xffffff;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 0, 32, &leg_data_weights);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\n2, 0x15e, 16,\r\nrfseq_rx2tx_dacbufpu_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x16e, 16,\r\nrfseq_rx2tx_dacbufpu_rev7);\r\nif (PHY_IPA(pi))\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_RX2TX,\r\nrfseq_rx2tx_events_rev3_ipa,\r\nrfseq_rx2tx_dlys_rev3_ipa,\r\nARRAY_SIZE(rfseq_rx2tx_events_rev3_ipa));\r\nmod_phy_reg(pi, 0x299, (0x3 << 14), (0x1 << 14));\r\nmod_phy_reg(pi, 0x29d, (0x3 << 14), (0x1 << 14));\r\ntx_lpf_bw_ofdm_20mhz = wlc_phy_read_lpf_bw_ctl_nphy(pi, 0x154);\r\ntx_lpf_bw_ofdm_40mhz = wlc_phy_read_lpf_bw_ctl_nphy(pi, 0x159);\r\ntx_lpf_bw_11b = wlc_phy_read_lpf_bw_ctl_nphy(pi, 0x152);\r\nif (PHY_IPA(pi)) {\r\nif (((pi->pubpi.radiorev == 5)\r\n&& (CHSPEC_IS40(pi->radio_chanspec) == 1))\r\n|| (pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nrccal_bcap_val =\r\nread_radio_reg(\r\npi,\r\nRADIO_2057_RCCAL_BCAP_VAL);\r\nrccal_scap_val =\r\nread_radio_reg(\r\npi,\r\nRADIO_2057_RCCAL_SCAP_VAL);\r\nrccal_tx20_11b_bcap = rccal_bcap_val;\r\nrccal_tx20_11b_scap = rccal_scap_val;\r\nif ((pi->pubpi.radiorev == 5) &&\r\n(CHSPEC_IS40(pi->radio_chanspec) == 1)) {\r\nrccal_tx20_11n_bcap = rccal_bcap_val;\r\nrccal_tx20_11n_scap = rccal_scap_val;\r\nrccal_tx40_11n_bcap = 0xc;\r\nrccal_tx40_11n_scap = 0xc;\r\nrccal_ovrd = true;\r\n} else if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\ntx_lpf_bw_ofdm_20mhz = 4;\r\ntx_lpf_bw_11b = 1;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nrccal_tx20_11n_bcap = 0xc;\r\nrccal_tx20_11n_scap = 0xc;\r\nrccal_tx40_11n_bcap = 0xa;\r\nrccal_tx40_11n_scap = 0xa;\r\n} else {\r\nrccal_tx20_11n_bcap = 0x14;\r\nrccal_tx20_11n_scap = 0x14;\r\nrccal_tx40_11n_bcap = 0xf;\r\nrccal_tx40_11n_scap = 0xf;\r\n}\r\nrccal_ovrd = true;\r\n}\r\n}\r\n} else {\r\nif (pi->pubpi.radiorev == 5) {\r\ntx_lpf_bw_ofdm_20mhz = 1;\r\ntx_lpf_bw_ofdm_40mhz = 3;\r\nrccal_bcap_val =\r\nread_radio_reg(\r\npi,\r\nRADIO_2057_RCCAL_BCAP_VAL);\r\nrccal_scap_val =\r\nread_radio_reg(\r\npi,\r\nRADIO_2057_RCCAL_SCAP_VAL);\r\nrccal_tx20_11b_bcap = rccal_bcap_val;\r\nrccal_tx20_11b_scap = rccal_scap_val;\r\nrccal_tx20_11n_bcap = 0x13;\r\nrccal_tx20_11n_scap = 0x11;\r\nrccal_tx40_11n_bcap = 0x13;\r\nrccal_tx40_11n_scap = 0x11;\r\nrccal_ovrd = true;\r\n}\r\n}\r\nif (rccal_ovrd) {\r\nrx2tx_lpf_rc_lut_tx20_11b =\r\n(rccal_tx20_11b_bcap << 8) |\r\n(rccal_tx20_11b_scap << 3) |\r\ntx_lpf_bw_11b;\r\nrx2tx_lpf_rc_lut_tx20_11n =\r\n(rccal_tx20_11n_bcap << 8) |\r\n(rccal_tx20_11n_scap << 3) |\r\ntx_lpf_bw_ofdm_20mhz;\r\nrx2tx_lpf_rc_lut_tx40_11n =\r\n(rccal_tx40_11n_bcap << 8) |\r\n(rccal_tx40_11n_scap << 3) |\r\ntx_lpf_bw_ofdm_40mhz;\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x152 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx20_11b);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x153 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx20_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x154 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx20_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x155 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx40_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x156 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx40_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x157 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx40_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x158 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx40_11n);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_RFSEQ,\r\n1,\r\n0x159 + coreNum * 0x10,\r\n16,\r\n&rx2tx_lpf_rc_lut_tx40_11n);\r\n}\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 4),\r\n1, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\n}\r\nwrite_phy_reg(pi, 0x32f, 0x3);\r\nif ((pi->pubpi.radiorev == 4) || (pi->pubpi.radiorev == 6))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2),\r\n1, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nif ((pi->pubpi.radiorev == 3) || (pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6)) {\r\nif ((pi->sh->sromrev >= 8)\r\n&& (pi->sh->boardflags2 & BFL2_IPALVLSHIFT_3P3))\r\nipalvlshift_3p3_war_en = 1;\r\nif (ipalvlshift_3p3_war_en) {\r\nwrite_radio_reg(pi, RADIO_2057_GPAIO_CONFIG,\r\n0x5);\r\nwrite_radio_reg(pi, RADIO_2057_GPAIO_SEL1,\r\n0x30);\r\nwrite_radio_reg(pi, RADIO_2057_GPAIO_SEL0, 0x0);\r\nor_radio_reg(pi,\r\nRADIO_2057_RXTXBIAS_CONFIG_CORE0,\r\n0x1);\r\nor_radio_reg(pi,\r\nRADIO_2057_RXTXBIAS_CONFIG_CORE1,\r\n0x1);\r\nipa2g_mainbias = 0x1f;\r\nipa2g_casconv = 0x6f;\r\nipa2g_biasfilt = 0xaa;\r\n} else {\r\nipa2g_mainbias = 0x2b;\r\nipa2g_casconv = 0x7f;\r\nipa2g_biasfilt = 0xee;\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\ncoreNum, IPA2G_IMAIN,\r\nipa2g_mainbias);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\ncoreNum, IPA2G_CASCONV,\r\nipa2g_casconv);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\ncoreNum,\r\nIPA2G_BIAS_FILTER,\r\nipa2g_biasfilt);\r\n}\r\n}\r\n}\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((pi->pubpi.radiorev == 3)\r\n|| (pi->pubpi.radiorev == 4)\r\n|| (pi->pubpi.radiorev == 6))\r\ntxgm_idac_bleed = 0x7f;\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nif (txgm_idac_bleed != 0)\r\nWRITE_RADIO_REG4(\r\npi, RADIO_2057,\r\nCORE, coreNum,\r\nTXGM_IDAC_BLEED,\r\ntxgm_idac_bleed);\r\n}\r\nif (pi->pubpi.radiorev == 5) {\r\nfor (coreNum = 0; coreNum <= 1;\r\ncoreNum++) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, coreNum,\r\nIPA2G_CASCONV,\r\n0x13);\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, coreNum,\r\nIPA2G_IMAIN,\r\n0x1f);\r\nWRITE_RADIO_REG4(\r\npi, RADIO_2057,\r\nCORE, coreNum,\r\nIPA2G_BIAS_FILTER,\r\n0xee);\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, coreNum,\r\nPAD2G_IDACS,\r\n0x8a);\r\nWRITE_RADIO_REG4(\r\npi, RADIO_2057,\r\nCORE, coreNum,\r\nPAD_BIAS_FILTER_BWS,\r\n0x3e);\r\n}\r\n} else if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nif (CHSPEC_IS40(pi->radio_chanspec) ==\r\n0) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, 0,\r\nIPA2G_IMAIN,\r\n0x14);\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, 1,\r\nIPA2G_IMAIN,\r\n0x12);\r\n} else {\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, 0,\r\nIPA2G_IMAIN,\r\n0x16);\r\nWRITE_RADIO_REG4(pi, RADIO_2057,\r\nCORE, 1,\r\nIPA2G_IMAIN,\r\n0x16);\r\n}\r\n}\r\n} else {\r\nfreq = CHAN5G_FREQ(CHSPEC_CHANNEL(\r\npi->radio_chanspec));\r\nif (((freq >= 5180) && (freq <= 5230))\r\n|| ((freq >= 5745) && (freq <= 5805))) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\n0, IPA5G_BIAS_FILTER,\r\n0xff);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\n1, IPA5G_BIAS_FILTER,\r\n0xff);\r\n}\r\n}\r\n} else {\r\nif (pi->pubpi.radiorev != 5) {\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\ncoreNum,\r\nTXMIX2G_TUNE_BOOST_PU,\r\n0x61);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE,\r\ncoreNum,\r\nTXGM_IDAC_BLEED, 0x70);\r\n}\r\n}\r\n}\r\nif (pi->pubpi.radiorev == 4) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1,\r\n0x05, 16,\r\n&afectrl_adc_ctrl1_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1,\r\n0x15, 16,\r\n&afectrl_adc_ctrl1_rev7);\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE, coreNum,\r\nAFE_VCM_CAL_MASTER, 0x0);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE, coreNum,\r\nAFE_SET_VCM_I, 0x3f);\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE, coreNum,\r\nAFE_SET_VCM_Q, 0x3f);\r\n}\r\n} else {\r\nmod_phy_reg(pi, 0xa6, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0x8f, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0xa7, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0xa5, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0xa6, (0x1 << 0), 0);\r\nmod_phy_reg(pi, 0x8f, (0x1 << 0), (0x1 << 0));\r\nmod_phy_reg(pi, 0xa7, (0x1 << 0), 0);\r\nmod_phy_reg(pi, 0xa5, (0x1 << 0), (0x1 << 0));\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1,\r\n0x05, 16,\r\n&afectrl_adc_ctrl2_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1,\r\n0x15, 16,\r\n&afectrl_adc_ctrl2_rev7);\r\nmod_phy_reg(pi, 0xa6, (0x1 << 2), 0);\r\nmod_phy_reg(pi, 0x8f, (0x1 << 2), 0);\r\nmod_phy_reg(pi, 0xa7, (0x1 << 2), 0);\r\nmod_phy_reg(pi, 0xa5, (0x1 << 2), 0);\r\n}\r\nwrite_phy_reg(pi, 0x6a, 0x2);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1, 256, 32,\r\n&min_nvar_offset_6mbps);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x138, 16,\r\n&rfseq_pktgn_lpf_hpc_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 1, 0x141, 16,\r\n&rfseq_pktgn_lpf_h_hpc_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 3, 0x133, 16,\r\n&rfseq_htpktgn_lpf_hpc_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x146, 16,\r\n&rfseq_cckpktgn_lpf_hpc_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 1, 0x123, 16,\r\n&rfseq_tx2rx_lpf_h_hpc_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 1, 0x12A, 16,\r\n&rfseq_rx2tx_lpf_h_hpc_rev7);\r\nif (CHSPEC_IS40(pi->radio_chanspec) == 0) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1, 3,\r\n32, &min_nvar_val);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\n127, 32, &min_nvar_val);\r\n} else {\r\nmin_nvar_val = noise_var_tbl_rev7[3];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1, 3,\r\n32, &min_nvar_val);\r\nmin_nvar_val = noise_var_tbl_rev7[127];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\n127, 32, &min_nvar_val);\r\n}\r\nwlc_phy_workarounds_nphy_gainctrl(pi);\r\npdetrange =\r\n(CHSPEC_IS5G(pi->radio_chanspec)) ? pi->srom_fem5g.\r\npdetrange : pi->srom_fem2g.pdetrange;\r\nif (pdetrange == 0) {\r\nchan_freq_range =\r\nwlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\naux_adc_vmid_rev7_core0[3] = 0x70;\r\naux_adc_vmid_rev7_core1[3] = 0x70;\r\naux_adc_gain_rev7[3] = 2;\r\n} else {\r\naux_adc_vmid_rev7_core0[3] = 0x80;\r\naux_adc_vmid_rev7_core1[3] = 0x80;\r\naux_adc_gain_rev7[3] = 3;\r\n}\r\n} else if (pdetrange == 1) {\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\naux_adc_vmid_rev7_core0[3] = 0x7c;\r\naux_adc_vmid_rev7_core1[3] = 0x7c;\r\naux_adc_gain_rev7[3] = 2;\r\n} else {\r\naux_adc_vmid_rev7_core0[3] = 0x8c;\r\naux_adc_vmid_rev7_core1[3] = 0x8c;\r\naux_adc_gain_rev7[3] = 1;\r\n}\r\n} else if (pdetrange == 2) {\r\nif (pi->pubpi.radioid == BCM2057_ID) {\r\nif ((pi->pubpi.radiorev == 5)\r\n|| (pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nif (chan_freq_range ==\r\nWL_CHAN_FREQ_RANGE_2G) {\r\naux_adc_vmid_rev7_core0[3] =\r\n0x8c;\r\naux_adc_vmid_rev7_core1[3] =\r\n0x8c;\r\naux_adc_gain_rev7[3] = 0;\r\n} else {\r\naux_adc_vmid_rev7_core0[3] =\r\n0x96;\r\naux_adc_vmid_rev7_core1[3] =\r\n0x96;\r\naux_adc_gain_rev7[3] = 0;\r\n}\r\n}\r\n}\r\n} else if (pdetrange == 3) {\r\nif (chan_freq_range == WL_CHAN_FREQ_RANGE_2G) {\r\naux_adc_vmid_rev7_core0[3] = 0x89;\r\naux_adc_vmid_rev7_core1[3] = 0x89;\r\naux_adc_gain_rev7[3] = 0;\r\n}\r\n} else if (pdetrange == 5) {\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\naux_adc_vmid_rev7_core0[3] = 0x80;\r\naux_adc_vmid_rev7_core1[3] = 0x80;\r\naux_adc_gain_rev7[3] = 3;\r\n} else {\r\naux_adc_vmid_rev7_core0[3] = 0x70;\r\naux_adc_vmid_rev7_core1[3] = 0x70;\r\naux_adc_gain_rev7[3] = 2;\r\n}\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4, 0x08, 16,\r\n&aux_adc_vmid_rev7_core0);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4, 0x18, 16,\r\n&aux_adc_vmid_rev7_core1);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4, 0x0c, 16,\r\n&aux_adc_gain_rev7);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4, 0x1c, 16,\r\n&aux_adc_gain_rev7);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_phy_reg(pi, 0x23f, 0x1f8);\r\nwrite_phy_reg(pi, 0x240, 0x1f8);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 0, 32, &leg_data_weights);\r\nleg_data_weights = leg_data_weights & 0xffffff;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 0, 32, &leg_data_weights);\r\nalpha0 = 293;\r\nalpha1 = 435;\r\nalpha2 = 261;\r\nbeta0 = 366;\r\nbeta1 = 205;\r\nbeta2 = 32;\r\nwrite_phy_reg(pi, 0x145, alpha0);\r\nwrite_phy_reg(pi, 0x146, alpha1);\r\nwrite_phy_reg(pi, 0x147, alpha2);\r\nwrite_phy_reg(pi, 0x148, beta0);\r\nwrite_phy_reg(pi, 0x149, beta1);\r\nwrite_phy_reg(pi, 0x14a, beta2);\r\nwrite_phy_reg(pi, 0x38, 0xC);\r\nwrite_phy_reg(pi, 0x2ae, 0xC);\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_TX2RX,\r\nrfseq_tx2rx_events_rev3,\r\nrfseq_tx2rx_dlys_rev3,\r\nARRAY_SIZE(rfseq_tx2rx_events_rev3));\r\nif (PHY_IPA(pi))\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_RX2TX,\r\nrfseq_rx2tx_events_rev3_ipa,\r\nrfseq_rx2tx_dlys_rev3_ipa,\r\nARRAY_SIZE(rfseq_rx2tx_events_rev3_ipa));\r\nif ((pi->sh->hw_phyrxchain != 0x3) &&\r\n(pi->sh->hw_phyrxchain != pi->sh->hw_phytxchain)) {\r\nif (PHY_IPA(pi)) {\r\nrfseq_rx2tx_dlys_rev3[5] = 59;\r\nrfseq_rx2tx_dlys_rev3[6] = 1;\r\nrfseq_rx2tx_events_rev3[7] =\r\nNPHY_REV3_RFSEQ_CMD_END;\r\n}\r\nwlc_phy_set_rfseq_nphy(\r\npi, NPHY_RFSEQ_RX2TX,\r\nrfseq_rx2tx_events_rev3,\r\nrfseq_rx2tx_dlys_rev3,\r\nARRAY_SIZE(rfseq_rx2tx_events_rev3));\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwrite_phy_reg(pi, 0x6a, 0x2);\r\nelse\r\nwrite_phy_reg(pi, 0x6a, 0x9c40);\r\nmod_phy_reg(pi, 0x294, (0xf << 8), (7 << 8));\r\nif (CHSPEC_IS40(pi->radio_chanspec) == 0) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1, 3,\r\n32, &min_nvar_val);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\n127, 32, &min_nvar_val);\r\n} else {\r\nmin_nvar_val = noise_var_tbl_rev3[3];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1, 3,\r\n32, &min_nvar_val);\r\nmin_nvar_val = noise_var_tbl_rev3[127];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\n127, 32, &min_nvar_val);\r\n}\r\nwlc_phy_workarounds_nphy_gainctrl(pi);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x00, 16,\r\n&dac_control);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x10, 16,\r\n&dac_control);\r\npdetrange =\r\n(CHSPEC_IS5G(pi->radio_chanspec)) ? pi->srom_fem5g.\r\npdetrange : pi->srom_fem2g.pdetrange;\r\nif (pdetrange == 0) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 4)) {\r\naux_adc_vmid = aux_adc_vmid_rev4;\r\naux_adc_gain = aux_adc_gain_rev4;\r\n} else {\r\naux_adc_vmid = aux_adc_vmid_rev3;\r\naux_adc_gain = aux_adc_gain_rev3;\r\n}\r\nchan_freq_range =\r\nwlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\nswitch (chan_freq_range) {\r\ncase WL_CHAN_FREQ_RANGE_5GL:\r\naux_adc_vmid[3] = 0x89;\r\naux_adc_gain[3] = 0;\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GM:\r\naux_adc_vmid[3] = 0x89;\r\naux_adc_gain[3] = 0;\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GH:\r\naux_adc_vmid[3] = 0x89;\r\naux_adc_gain[3] = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x08, 16, aux_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x18, 16, aux_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x0c, 16, aux_adc_gain);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x1c, 16, aux_adc_gain);\r\n} else if (pdetrange == 1) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x08, 16, sk_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x18, 16, sk_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x0c, 16, sk_adc_gain);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x1c, 16, sk_adc_gain);\r\n} else if (pdetrange == 2) {\r\nu16 bcm_adc_vmid[] = { 0xa2, 0xb4, 0xb4, 0x74 };\r\nu16 bcm_adc_gain[] = { 0x02, 0x02, 0x02, 0x04 };\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nchan_freq_range =\r\nwlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\nbcm_adc_vmid[3] = 0x8e;\r\nbcm_adc_gain[3] = 0x03;\r\n} else {\r\nbcm_adc_vmid[3] = 0x94;\r\nbcm_adc_gain[3] = 0x03;\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\nbcm_adc_vmid[3] = 0x84;\r\nbcm_adc_gain[3] = 0x02;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x08, 16, bcm_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x18, 16, bcm_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x0c, 16, bcm_adc_gain);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x1c, 16, bcm_adc_gain);\r\n} else if (pdetrange == 3) {\r\nchan_freq_range =\r\nwlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nif ((NREV_GE(pi->pubpi.phy_rev, 4))\r\n&& (chan_freq_range == WL_CHAN_FREQ_RANGE_2G)) {\r\nu16 auxadc_vmid[] = {\r\n0xa2, 0xb4, 0xb4, 0x270\r\n};\r\nu16 auxadc_gain[] = {\r\n0x02, 0x02, 0x02, 0x00\r\n};\r\nwlc_phy_table_write_nphy(pi,\r\nNPHY_TBL_ID_AFECTRL, 4,\r\n0x08, 16, auxadc_vmid);\r\nwlc_phy_table_write_nphy(pi,\r\nNPHY_TBL_ID_AFECTRL, 4,\r\n0x18, 16, auxadc_vmid);\r\nwlc_phy_table_write_nphy(pi,\r\nNPHY_TBL_ID_AFECTRL, 4,\r\n0x0c, 16, auxadc_gain);\r\nwlc_phy_table_write_nphy(pi,\r\nNPHY_TBL_ID_AFECTRL, 4,\r\n0x1c, 16, auxadc_gain);\r\n}\r\n} else if ((pdetrange == 4) || (pdetrange == 5)) {\r\nu16 bcm_adc_vmid[] = { 0xa2, 0xb4, 0xb4, 0x0 };\r\nu16 bcm_adc_gain[] = { 0x02, 0x02, 0x02, 0x0 };\r\nu16 Vmid[2], Av[2];\r\nchan_freq_range =\r\nwlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nif (chan_freq_range != WL_CHAN_FREQ_RANGE_2G) {\r\nVmid[0] = (pdetrange == 4) ? 0x8e : 0x89;\r\nVmid[1] = (pdetrange == 4) ? 0x96 : 0x89;\r\nAv[0] = (pdetrange == 4) ? 2 : 0;\r\nAv[1] = (pdetrange == 4) ? 2 : 0;\r\n} else {\r\nVmid[0] = (pdetrange == 4) ? 0x89 : 0x74;\r\nVmid[1] = (pdetrange == 4) ? 0x8b : 0x70;\r\nAv[0] = (pdetrange == 4) ? 2 : 0;\r\nAv[1] = (pdetrange == 4) ? 2 : 0;\r\n}\r\nbcm_adc_vmid[3] = Vmid[0];\r\nbcm_adc_gain[3] = Av[0];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x08, 16, bcm_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x0c, 16, bcm_adc_gain);\r\nbcm_adc_vmid[3] = Vmid[1];\r\nbcm_adc_gain[3] = Av[1];\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x18, 16, bcm_adc_vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 4,\r\n0x1c, 16, bcm_adc_gain);\r\n}\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_MAST_BIAS | RADIO_2056_RX0),\r\n0x0);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_MAST_BIAS | RADIO_2056_RX1),\r\n0x0);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_BIAS_MAIN | RADIO_2056_RX0),\r\n0x6);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_BIAS_MAIN | RADIO_2056_RX1),\r\n0x6);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_BIAS_AUX | RADIO_2056_RX0),\r\n0x7);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_BIAS_AUX | RADIO_2056_RX1),\r\n0x7);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_LOB_BIAS | RADIO_2056_RX0),\r\n0x88);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_LOB_BIAS | RADIO_2056_RX1),\r\n0x88);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_CMFB_IDAC | RADIO_2056_RX0),\r\n0x0);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXA_CMFB_IDAC | RADIO_2056_RX1),\r\n0x0);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXG_CMFB_IDAC | RADIO_2056_RX0),\r\n0x0);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_MIXG_CMFB_IDAC | RADIO_2056_RX1),\r\n0x0);\r\ntriso =\r\n(CHSPEC_IS5G(pi->radio_chanspec)) ? pi->srom_fem5g.\r\ntriso : pi->srom_fem2g.triso;\r\nif (triso == 7) {\r\nwlc_phy_war_force_trsw_to_R_cliplo_nphy(pi, PHY_CORE_0);\r\nwlc_phy_war_force_trsw_to_R_cliplo_nphy(pi, PHY_CORE_1);\r\n}\r\nwlc_phy_war_txchain_upd_nphy(pi, pi->sh->hw_phytxchain);\r\nif (((pi->sh->boardflags2 & BFL2_APLL_WAR) &&\r\n(CHSPEC_IS5G(pi->radio_chanspec))) ||\r\n(((pi->sh->boardflags2 & BFL2_GPLL_WAR) ||\r\n(pi->sh->boardflags2 & BFL2_GPLL_WAR2)) &&\r\n(CHSPEC_IS2G(pi->radio_chanspec)))) {\r\nnss1_data_weights = 0x00088888;\r\nht_data_weights = 0x00088888;\r\nstbc_data_weights = 0x00088888;\r\n} else {\r\nnss1_data_weights = 0x88888888;\r\nht_data_weights = 0x88888888;\r\nstbc_data_weights = 0x88888888;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 1, 32, &nss1_data_weights);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 2, 32, &ht_data_weights);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CMPMETRICDATAWEIGHTTBL,\r\n1, 3, 32, &stbc_data_weights);\r\nif (NREV_IS(pi->pubpi.phy_rev, 4)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_GMBB_IDAC |\r\nRADIO_2056_TX0, 0x70);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_GMBB_IDAC |\r\nRADIO_2056_TX1, 0x70);\r\n}\r\n}\r\nif (!pi->edcrs_threshold_lock) {\r\nwrite_phy_reg(pi, 0x224, 0x3eb);\r\nwrite_phy_reg(pi, 0x225, 0x3eb);\r\nwrite_phy_reg(pi, 0x226, 0x341);\r\nwrite_phy_reg(pi, 0x227, 0x341);\r\nwrite_phy_reg(pi, 0x228, 0x42b);\r\nwrite_phy_reg(pi, 0x229, 0x42b);\r\nwrite_phy_reg(pi, 0x22a, 0x381);\r\nwrite_phy_reg(pi, 0x22b, 0x381);\r\nwrite_phy_reg(pi, 0x22c, 0x42b);\r\nwrite_phy_reg(pi, 0x22d, 0x42b);\r\nwrite_phy_reg(pi, 0x22e, 0x381);\r\nwrite_phy_reg(pi, 0x22f, 0x381);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nif (pi->sh->boardflags2 & BFL2_SINGLEANT_CCK)\r\nwlapi_bmac_mhf(pi->sh->physhim, MHF4,\r\nMHF4_BPHY_TXCORE0,\r\nMHF4_BPHY_TXCORE0, BRCM_BAND_ALL);\r\n}\r\n} else {\r\nif (pi->sh->boardflags2 & BFL2_SKWRKFEM_BRD ||\r\n(pi->sh->boardtype == 0x8b)) {\r\nuint i;\r\nu8 war_dlys[] = { 1, 6, 6, 2, 4, 20, 1 };\r\nfor (i = 0; i < ARRAY_SIZE(rfseq_rx2tx_dlys); i++)\r\nrfseq_rx2tx_dlys[i] = war_dlys[i];\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec) && pi->phy_5g_pwrgain) {\r\nand_radio_reg(pi, RADIO_2055_CORE1_TX_RF_SPARE, 0xf7);\r\nand_radio_reg(pi, RADIO_2055_CORE2_TX_RF_SPARE, 0xf7);\r\n} else {\r\nor_radio_reg(pi, RADIO_2055_CORE1_TX_RF_SPARE, 0x8);\r\nor_radio_reg(pi, RADIO_2055_CORE2_TX_RF_SPARE, 0x8);\r\n}\r\nregval = 0x000a;\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0, 16, &regval);\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x10, 16, &regval);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3)) {\r\nregval = 0xcdaa;\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x02, 16, &regval);\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x12, 16, &regval);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nregval = 0x0000;\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x08, 16, &regval);\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x18, 16, &regval);\r\nregval = 0x7aab;\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x07, 16, &regval);\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x17, 16, &regval);\r\nregval = 0x0800;\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x06, 16, &regval);\r\nwlc_phy_table_write_nphy(pi, 8, 1, 0x16, 16, &regval);\r\n}\r\nwrite_phy_reg(pi, 0xf8, 0x02d8);\r\nwrite_phy_reg(pi, 0xf9, 0x0301);\r\nwrite_phy_reg(pi, 0xfa, 0x02d8);\r\nwrite_phy_reg(pi, 0xfb, 0x0301);\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_RX2TX, rfseq_rx2tx_events,\r\nrfseq_rx2tx_dlys,\r\nARRAY_SIZE(rfseq_rx2tx_events));\r\nwlc_phy_set_rfseq_nphy(pi, NPHY_RFSEQ_TX2RX, rfseq_tx2rx_events,\r\nrfseq_tx2rx_dlys,\r\nARRAY_SIZE(rfseq_tx2rx_events));\r\nwlc_phy_workarounds_nphy_gainctrl(pi);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nif (read_phy_reg(pi, 0xa0) & NPHY_MLenable)\r\nwlapi_bmac_mhf(pi->sh->physhim, MHF3,\r\nMHF3_NPHY_MLADV_WAR,\r\nMHF3_NPHY_MLADV_WAR,\r\nBRCM_BAND_ALL);\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 2)) {\r\nwrite_phy_reg(pi, 0x1e3, 0x0);\r\nwrite_phy_reg(pi, 0x1e4, 0x0);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0x90, (0x1 << 7), 0);\r\nalpha0 = 293;\r\nalpha1 = 435;\r\nalpha2 = 261;\r\nbeta0 = 366;\r\nbeta1 = 205;\r\nbeta2 = 32;\r\nwrite_phy_reg(pi, 0x145, alpha0);\r\nwrite_phy_reg(pi, 0x146, alpha1);\r\nwrite_phy_reg(pi, 0x147, alpha2);\r\nwrite_phy_reg(pi, 0x148, beta0);\r\nwrite_phy_reg(pi, 0x149, beta1);\r\nwrite_phy_reg(pi, 0x14a, beta2);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3)) {\r\nmod_phy_reg(pi, 0x142, (0xf << 12), 0);\r\nwrite_phy_reg(pi, 0x192, 0xb5);\r\nwrite_phy_reg(pi, 0x193, 0xa4);\r\nwrite_phy_reg(pi, 0x194, 0x0);\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0x221,\r\nNPHY_FORCESIG_DECODEGATEDCLKS,\r\nNPHY_FORCESIG_DECODEGATEDCLKS);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void wlc_phy_extpa_set_tx_digi_filts_nphy(struct brcms_phy *pi)\r\n{\r\nint j, type = 2;\r\nu16 addr_offset = 0x2c5;\r\nfor (j = 0; j < NPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, addr_offset + j,\r\nNPHY_IPA_REV4_txdigi_filtcoeffs[type][j]);\r\n}\r\nstatic void wlc_phy_clip_det_nphy(struct brcms_phy *pi, u8 write, u16 *vals)\r\n{\r\nif (write == 0) {\r\nvals[0] = read_phy_reg(pi, 0x2c);\r\nvals[1] = read_phy_reg(pi, 0x42);\r\n} else {\r\nwrite_phy_reg(pi, 0x2c, vals[0]);\r\nwrite_phy_reg(pi, 0x42, vals[1]);\r\n}\r\n}\r\nstatic void wlc_phy_ipa_internal_tssi_setup_nphy(struct brcms_phy *pi)\r\n{\r\nu8 core;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER, 0x5);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MUX, 0xe);\r\nif (pi->pubpi.radiorev != 5)\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TSSIA, 0);\r\nif (!NREV_IS(pi->pubpi.phy_rev, 7))\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TSSIG, 0x1);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TSSIG, 0x31);\r\n} else {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER, 0x9);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MUX, 0xc);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSIG, 0);\r\nif (pi->pubpi.radiorev != 5) {\r\nif (!NREV_IS(pi->pubpi.phy_rev, 7))\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIA, 0x1);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIA, 0x31);\r\n}\r\n}\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, IQCAL_VCM_HG,\r\n0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, IQCAL_IDAC,\r\n0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TSSI_VCM,\r\n0x3);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TSSI_MISC1,\r\n0x0);\r\n}\r\n} else {\r\nWRITE_RADIO_SYN(pi, RADIO_2056, RESERVED_ADDR31,\r\n(CHSPEC_IS2G(pi->radio_chanspec)) ? 0x128 :\r\n0x80);\r\nWRITE_RADIO_SYN(pi, RADIO_2056, RESERVED_ADDR30, 0x0);\r\nWRITE_RADIO_SYN(pi, RADIO_2056, GPIO_MASTER1, 0x29);\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, IQCAL_VCM_HG,\r\n0x0);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, IQCAL_IDAC,\r\n0x0);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, TSSI_VCM,\r\n0x3);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, TX_AMP_DET,\r\n0x0);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, TSSI_MISC1,\r\n0x8);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, TSSI_MISC2,\r\n0x0);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, TSSI_MISC3,\r\n0x0);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTX_SSI_MASTER, 0x5);\r\nif (pi->pubpi.radiorev != 5)\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX,\r\ncore, TSSIA, 0x0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 5))\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX,\r\ncore, TSSIG, 0x31);\r\nelse\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX,\r\ncore, TSSIG, 0x11);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTX_SSI_MUX, 0xe);\r\n} else {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTX_SSI_MASTER, 0x9);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTSSIA, 0x31);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTSSIG, 0x0);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTX_SSI_MUX, 0xc);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_phy_rfctrl_override_nphy(struct brcms_phy *pi, u16 field, u16 value,\r\nu8 core_mask, u8 off)\r\n{\r\nu8 core_num;\r\nu16 addr = 0, mask = 0, en_addr = 0, val_addr = 0, en_mask =\r\n0, val_mask = 0;\r\nu8 shift = 0, val_shift = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nen_mask = field;\r\nfor (core_num = 0; core_num < 2; core_num++) {\r\nswitch (field) {\r\ncase (0x1 << 1):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 2):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 1);\r\nval_shift = 1;\r\nbreak;\r\ncase (0x1 << 3):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 2);\r\nval_shift = 2;\r\nbreak;\r\ncase (0x1 << 4):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 4);\r\nval_shift = 4;\r\nbreak;\r\ncase (0x1 << 5):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 5);\r\nval_shift = 5;\r\nbreak;\r\ncase (0x1 << 6):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 6);\r\nval_shift = 6;\r\nbreak;\r\ncase (0x1 << 7):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x1 << 7);\r\nval_shift = 7;\r\nbreak;\r\ncase (0x1 << 8):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x7 << 8);\r\nval_shift = 8;\r\nbreak;\r\ncase (0x1 << 11):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7a : 0x7d;\r\nval_mask = (0x7 << 13);\r\nval_shift = 13;\r\nbreak;\r\ncase (0x1 << 9):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0xf8 : 0xfa;\r\nval_mask = (0x7 << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 10):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0xf8 : 0xfa;\r\nval_mask = (0x7 << 4);\r\nval_shift = 4;\r\nbreak;\r\ncase (0x1 << 12):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7b : 0x7e;\r\nval_mask = (0xffff << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 13):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0x7c : 0x7f;\r\nval_mask = (0xffff << 0);\r\nval_shift = 0;\r\nbreak;\r\ncase (0x1 << 14):\r\nen_addr = (core_num == 0) ? 0xe7 : 0xec;\r\nval_addr = (core_num == 0) ? 0xf9 : 0xfb;\r\nval_mask = (0x3 << 6);\r\nval_shift = 6;\r\nbreak;\r\ncase (0x1 << 0):\r\nen_addr = (core_num == 0) ? 0xe5 : 0xe6;\r\nval_addr = (core_num == 0) ? 0xf9 : 0xfb;\r\nval_mask = (0x1 << 15);\r\nval_shift = 15;\r\nbreak;\r\ndefault:\r\naddr = 0xffff;\r\nbreak;\r\n}\r\nif (off) {\r\nand_phy_reg(pi, en_addr, ~en_mask);\r\nand_phy_reg(pi, val_addr, ~val_mask);\r\n} else {\r\nif ((core_mask == 0)\r\n|| (core_mask & (1 << core_num))) {\r\nor_phy_reg(pi, en_addr, en_mask);\r\nif (addr != 0xffff)\r\nmod_phy_reg(pi, val_addr,\r\nval_mask,\r\n(value <<\r\nval_shift));\r\n}\r\n}\r\n}\r\n} else {\r\nif (off) {\r\nand_phy_reg(pi, 0xec, ~field);\r\nvalue = 0x0;\r\n} else {\r\nor_phy_reg(pi, 0xec, field);\r\n}\r\nfor (core_num = 0; core_num < 2; core_num++) {\r\nswitch (field) {\r\ncase (0x1 << 1):\r\ncase (0x1 << 9):\r\ncase (0x1 << 12):\r\ncase (0x1 << 13):\r\ncase (0x1 << 14):\r\naddr = 0x78;\r\ncore_mask = 0x1;\r\nbreak;\r\ncase (0x1 << 2):\r\ncase (0x1 << 3):\r\ncase (0x1 << 4):\r\ncase (0x1 << 5):\r\ncase (0x1 << 6):\r\ncase (0x1 << 7):\r\ncase (0x1 << 8):\r\naddr = (core_num == 0) ? 0x7a : 0x7d;\r\nbreak;\r\ncase (0x1 << 10):\r\naddr = (core_num == 0) ? 0x7b : 0x7e;\r\nbreak;\r\ncase (0x1 << 11):\r\naddr = (core_num == 0) ? 0x7c : 0x7f;\r\nbreak;\r\ndefault:\r\naddr = 0xffff;\r\n}\r\nswitch (field) {\r\ncase (0x1 << 1):\r\nmask = (0x7 << 3);\r\nshift = 3;\r\nbreak;\r\ncase (0x1 << 9):\r\nmask = (0x1 << 2);\r\nshift = 2;\r\nbreak;\r\ncase (0x1 << 12):\r\nmask = (0x1 << 8);\r\nshift = 8;\r\nbreak;\r\ncase (0x1 << 13):\r\nmask = (0x1 << 9);\r\nshift = 9;\r\nbreak;\r\ncase (0x1 << 14):\r\nmask = (0xf << 12);\r\nshift = 12;\r\nbreak;\r\ncase (0x1 << 2):\r\nmask = (0x1 << 0);\r\nshift = 0;\r\nbreak;\r\ncase (0x1 << 3):\r\nmask = (0x1 << 1);\r\nshift = 1;\r\nbreak;\r\ncase (0x1 << 4):\r\nmask = (0x1 << 2);\r\nshift = 2;\r\nbreak;\r\ncase (0x1 << 5):\r\nmask = (0x3 << 4);\r\nshift = 4;\r\nbreak;\r\ncase (0x1 << 6):\r\nmask = (0x3 << 6);\r\nshift = 6;\r\nbreak;\r\ncase (0x1 << 7):\r\nmask = (0x1 << 8);\r\nshift = 8;\r\nbreak;\r\ncase (0x1 << 8):\r\nmask = (0x1 << 9);\r\nshift = 9;\r\nbreak;\r\ncase (0x1 << 10):\r\nmask = 0x1fff;\r\nshift = 0x0;\r\nbreak;\r\ncase (0x1 << 11):\r\nmask = 0x1fff;\r\nshift = 0x0;\r\nbreak;\r\ndefault:\r\nmask = 0x0;\r\nshift = 0x0;\r\nbreak;\r\n}\r\nif ((addr != 0xffff) && (core_mask & (1 << core_num)))\r\nmod_phy_reg(pi, addr, mask, (value << shift));\r\n}\r\nor_phy_reg(pi, 0xec, (0x1 << 0));\r\nor_phy_reg(pi, 0x78, (0x1 << 0));\r\nudelay(1);\r\nand_phy_reg(pi, 0xec, ~(0x1 << 0));\r\n}\r\n}\r\nstatic void wlc_phy_txpwrctrl_idle_tssi_nphy(struct brcms_phy *pi)\r\n{\r\ns32 rssi_buf[4];\r\ns32 int_val;\r\nif (SCAN_RM_IN_PROGRESS(pi) || PLT_INPROG_PHY(pi) || PHY_MUTED(pi))\r\nreturn;\r\nif (PHY_IPA(pi))\r\nwlc_phy_ipa_internal_tssi_setup_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 12),\r\n0, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nelse if (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 13), 0, 3, 0);\r\nwlc_phy_stopplayback_nphy(pi);\r\nwlc_phy_tx_tone_nphy(pi, 4000, 0, 0, 0, false);\r\nudelay(20);\r\nint_val =\r\nwlc_phy_poll_rssi_nphy(pi, (u8) NPHY_RSSI_SEL_TSSI_2G, rssi_buf,\r\n1);\r\nwlc_phy_stopplayback_nphy(pi);\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_OFF, 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 12),\r\n0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nelse if (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 13), 0, 3, 1);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_tssi_2g =\r\n(u8) ((int_val >> 24) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_tssi_5g =\r\n(u8) ((int_val >> 24) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_tssi_2g =\r\n(u8) ((int_val >> 8) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_tssi_5g =\r\n(u8) ((int_val >> 8) & 0xff);\r\n} else {\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_tssi_2g =\r\n(u8) ((int_val >> 24) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_tssi_2g =\r\n(u8) ((int_val >> 8) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_0].idle_tssi_5g =\r\n(u8) ((int_val >> 16) & 0xff);\r\npi->nphy_pwrctrl_info[PHY_CORE_1].idle_tssi_5g =\r\n(u8) ((int_val) & 0xff);\r\n}\r\n}\r\nstatic void wlc_phy_txpwr_limit_to_tbl_nphy(struct brcms_phy *pi)\r\n{\r\nu8 idx, idx2, i, delta_ind;\r\nfor (idx = TXP_FIRST_CCK; idx <= TXP_LAST_CCK; idx++)\r\npi->adj_pwr_tbl_nphy[idx] = pi->tx_power_offset[idx];\r\nfor (i = 0; i < 4; i++) {\r\nidx2 = 0;\r\ndelta_ind = 0;\r\nswitch (i) {\r\ncase 0:\r\nif (CHSPEC_IS40(pi->radio_chanspec)\r\n&& NPHY_IS_SROM_REINTERPRET) {\r\nidx = TXP_FIRST_MCS_40_SISO;\r\n} else {\r\nidx = (CHSPEC_IS40(pi->radio_chanspec)) ?\r\nTXP_FIRST_OFDM_40_SISO : TXP_FIRST_OFDM;\r\ndelta_ind = 1;\r\n}\r\nbreak;\r\ncase 1:\r\nidx = (CHSPEC_IS40(pi->radio_chanspec)) ?\r\nTXP_FIRST_MCS_40_CDD : TXP_FIRST_MCS_20_CDD;\r\nbreak;\r\ncase 2:\r\nidx = (CHSPEC_IS40(pi->radio_chanspec)) ?\r\nTXP_FIRST_MCS_40_STBC : TXP_FIRST_MCS_20_STBC;\r\nbreak;\r\ncase 3:\r\nidx = (CHSPEC_IS40(pi->radio_chanspec)) ?\r\nTXP_FIRST_MCS_40_SDM : TXP_FIRST_MCS_20_SDM;\r\nbreak;\r\n}\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\nidx = idx + delta_ind;\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx++];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\nidx = idx + 1 - delta_ind;\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\npi->adj_pwr_tbl_nphy[4 + 4 * (idx2++) + i] =\r\npi->tx_power_offset[idx];\r\n}\r\n}\r\nstatic void wlc_phy_txpwrctrl_pwr_setup_nphy(struct brcms_phy *pi)\r\n{\r\nu32 idx;\r\ns16 a1[2], b0[2], b1[2];\r\ns8 target_pwr_qtrdbm[2];\r\ns32 num, den, pwr_est;\r\nu8 chan_freq_range;\r\nu8 idle_tssi[2];\r\nu32 tbl_id, tbl_len, tbl_offset;\r\nu32 regval[64];\r\nu8 core;\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12)) {\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, MCTL_PHYLOCK);\r\n(void)bcma_read32(pi->d11core, D11REGOFFS(maccontrol));\r\nudelay(1);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nor_phy_reg(pi, 0x122, (0x1 << 0));\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nand_phy_reg(pi, 0x1e7, (u16) (~(0x1 << 15)));\r\nelse\r\nor_phy_reg(pi, 0x1e7, (0x1 << 15));\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12))\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, 0);\r\nif (pi->sh->sromrev < 4) {\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_2g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_2g;\r\na1[0] = -424;\r\na1[1] = -424;\r\nb0[0] = 5612;\r\nb0[1] = 5612;\r\nb1[1] = -1393;\r\nb1[0] = -1393;\r\n} else {\r\nchan_freq_range = wlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nswitch (chan_freq_range) {\r\ncase WL_CHAN_FREQ_RANGE_2G:\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_2g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_2g;\r\na1[0] = pi->nphy_pwrctrl_info[0].pwrdet_2g_a1;\r\na1[1] = pi->nphy_pwrctrl_info[1].pwrdet_2g_a1;\r\nb0[0] = pi->nphy_pwrctrl_info[0].pwrdet_2g_b0;\r\nb0[1] = pi->nphy_pwrctrl_info[1].pwrdet_2g_b0;\r\nb1[0] = pi->nphy_pwrctrl_info[0].pwrdet_2g_b1;\r\nb1[1] = pi->nphy_pwrctrl_info[1].pwrdet_2g_b1;\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GL:\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_5g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_5g;\r\na1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gl_a1;\r\na1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gl_a1;\r\nb0[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gl_b0;\r\nb0[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gl_b0;\r\nb1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gl_b1;\r\nb1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gl_b1;\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GM:\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_5g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_5g;\r\na1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gm_a1;\r\na1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gm_a1;\r\nb0[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gm_b0;\r\nb0[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gm_b0;\r\nb1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gm_b1;\r\nb1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gm_b1;\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GH:\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_5g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_5g;\r\na1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gh_a1;\r\na1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gh_a1;\r\nb0[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gh_b0;\r\nb0[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gh_b0;\r\nb1[0] = pi->nphy_pwrctrl_info[0].pwrdet_5gh_b1;\r\nb1[1] = pi->nphy_pwrctrl_info[1].pwrdet_5gh_b1;\r\nbreak;\r\ndefault:\r\nidle_tssi[0] = pi->nphy_pwrctrl_info[0].idle_tssi_2g;\r\nidle_tssi[1] = pi->nphy_pwrctrl_info[1].idle_tssi_2g;\r\na1[0] = -424;\r\na1[1] = -424;\r\nb0[0] = 5612;\r\nb0[1] = 5612;\r\nb1[1] = -1393;\r\nb1[0] = -1393;\r\nbreak;\r\n}\r\n}\r\ntarget_pwr_qtrdbm[0] = (s8) pi->tx_power_max;\r\ntarget_pwr_qtrdbm[1] = (s8) pi->tx_power_max;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (pi->srom_fem2g.tssipos)\r\nor_phy_reg(pi, 0x1e9, (0x1 << 14));\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (core = 0; core <= 1; core++) {\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTX_SSI_MUX,\r\n0xe);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTX_SSI_MUX,\r\n0xc);\r\n}\r\n}\r\n} else {\r\nif (PHY_IPA(pi)) {\r\nwrite_radio_reg(pi, RADIO_2056_TX_TX_SSI_MUX |\r\nRADIO_2056_TX0,\r\n(CHSPEC_IS5G\r\n(pi->radio_chanspec)) ?\r\n0xc : 0xe);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MUX |\r\nRADIO_2056_TX1,\r\n(CHSPEC_IS5G\r\n(pi->radio_chanspec)) ?\r\n0xc : 0xe);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2056_TX_TX_SSI_MUX |\r\nRADIO_2056_TX0, 0x11);\r\nwrite_radio_reg(pi, RADIO_2056_TX_TX_SSI_MUX |\r\nRADIO_2056_TX1, 0x11);\r\n}\r\n}\r\n}\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12)) {\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, MCTL_PHYLOCK);\r\n(void)bcma_read32(pi->d11core, D11REGOFFS(maccontrol));\r\nudelay(1);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nmod_phy_reg(pi, 0x1e7, (0x7f << 0),\r\n(NPHY_TxPwrCtrlCmd_pwrIndex_init_rev7 << 0));\r\nelse\r\nmod_phy_reg(pi, 0x1e7, (0x7f << 0),\r\n(NPHY_TxPwrCtrlCmd_pwrIndex_init << 0));\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nmod_phy_reg(pi, 0x222, (0xff << 0),\r\n(NPHY_TxPwrCtrlCmd_pwrIndex_init_rev7 << 0));\r\nelse if (NREV_GT(pi->pubpi.phy_rev, 1))\r\nmod_phy_reg(pi, 0x222, (0xff << 0),\r\n(NPHY_TxPwrCtrlCmd_pwrIndex_init << 0));\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12))\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, 0);\r\nwrite_phy_reg(pi, 0x1e8, (0x3 << 8) | (240 << 0));\r\nwrite_phy_reg(pi, 0x1e9,\r\n(1 << 15) | (idle_tssi[0] << 0) | (idle_tssi[1] << 8));\r\nwrite_phy_reg(pi, 0x1ea,\r\n(target_pwr_qtrdbm[0] << 0) |\r\n(target_pwr_qtrdbm[1] << 8));\r\ntbl_len = 64;\r\ntbl_offset = 0;\r\nfor (tbl_id = NPHY_TBL_ID_CORE1TXPWRCTL;\r\ntbl_id <= NPHY_TBL_ID_CORE2TXPWRCTL; tbl_id++) {\r\nfor (idx = 0; idx < tbl_len; idx++) {\r\nnum = 8 *\r\n(16 * b0[tbl_id - 26] + b1[tbl_id - 26] * idx);\r\nden = 32768 + a1[tbl_id - 26] * idx;\r\npwr_est = max(((4 * num + den / 2) / den), -8);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3)) {\r\nif (idx <=\r\n(uint) (31 - idle_tssi[tbl_id - 26] + 1))\r\npwr_est =\r\nmax(pwr_est,\r\ntarget_pwr_qtrdbm\r\n[tbl_id - 26] + 1);\r\n}\r\nregval[idx] = (u32) pwr_est;\r\n}\r\nwlc_phy_table_write_nphy(pi, tbl_id, tbl_len, tbl_offset, 32,\r\nregval);\r\n}\r\nwlc_phy_txpwr_limit_to_tbl_nphy(pi);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE1TXPWRCTL, 84, 64, 8,\r\npi->adj_pwr_tbl_nphy);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE2TXPWRCTL, 84, 64, 8,\r\npi->adj_pwr_tbl_nphy);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic u32 *wlc_phy_get_ipa_gaintbl_nphy(struct brcms_phy *pi)\r\n{\r\nu32 *tx_pwrctrl_tbl = NULL;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif ((pi->pubpi.radiorev == 4)\r\n|| (pi->pubpi.radiorev == 6))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_ipa_2g_2057rev4n6;\r\nelse if (pi->pubpi.radiorev == 3)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_ipa_2g_2057rev3;\r\nelse if (pi->pubpi.radiorev == 5)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_ipa_2g_2057rev5;\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_ipa_2g_2057rev7;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 6)) {\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa_rev6;\r\nif (pi->sh->chip == BCMA_CHIP_ID_BCM47162)\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa_rev5;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa_rev5;\r\n} else {\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa;\r\n}\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa_5g_2057;\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_ipa_5g_2057rev7;\r\n} else {\r\ntx_pwrctrl_tbl = nphy_tpc_txgain_ipa_5g;\r\n}\r\n}\r\nreturn tx_pwrctrl_tbl;\r\n}\r\nstatic void wlc_phy_restore_rssical_nphy(struct brcms_phy *pi)\r\n{\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->nphy_rssical_chanspec_2G == 0)\r\nreturn;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmod_radio_reg(pi, RADIO_2057_NB_MASTER_CORE0,\r\nRADIO_2057_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_2G[0]);\r\nmod_radio_reg(pi, RADIO_2057_NB_MASTER_CORE1,\r\nRADIO_2057_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_2G[1]);\r\n} else {\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC | RADIO_2056_RX0,\r\nRADIO_2056_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_2G[0]);\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC | RADIO_2056_RX1,\r\nRADIO_2056_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_2G[1]);\r\n}\r\nwrite_phy_reg(pi, 0x1a6,\r\npi->rssical_cache.rssical_phyregs_2G[0]);\r\nwrite_phy_reg(pi, 0x1ac,\r\npi->rssical_cache.rssical_phyregs_2G[1]);\r\nwrite_phy_reg(pi, 0x1b2,\r\npi->rssical_cache.rssical_phyregs_2G[2]);\r\nwrite_phy_reg(pi, 0x1b8,\r\npi->rssical_cache.rssical_phyregs_2G[3]);\r\nwrite_phy_reg(pi, 0x1a4,\r\npi->rssical_cache.rssical_phyregs_2G[4]);\r\nwrite_phy_reg(pi, 0x1aa,\r\npi->rssical_cache.rssical_phyregs_2G[5]);\r\nwrite_phy_reg(pi, 0x1b0,\r\npi->rssical_cache.rssical_phyregs_2G[6]);\r\nwrite_phy_reg(pi, 0x1b6,\r\npi->rssical_cache.rssical_phyregs_2G[7]);\r\nwrite_phy_reg(pi, 0x1a5,\r\npi->rssical_cache.rssical_phyregs_2G[8]);\r\nwrite_phy_reg(pi, 0x1ab,\r\npi->rssical_cache.rssical_phyregs_2G[9]);\r\nwrite_phy_reg(pi, 0x1b1,\r\npi->rssical_cache.rssical_phyregs_2G[10]);\r\nwrite_phy_reg(pi, 0x1b7,\r\npi->rssical_cache.rssical_phyregs_2G[11]);\r\n} else {\r\nif (pi->nphy_rssical_chanspec_5G == 0)\r\nreturn;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmod_radio_reg(pi, RADIO_2057_NB_MASTER_CORE0,\r\nRADIO_2057_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_5G[0]);\r\nmod_radio_reg(pi, RADIO_2057_NB_MASTER_CORE1,\r\nRADIO_2057_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_5G[1]);\r\n} else {\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC | RADIO_2056_RX0,\r\nRADIO_2056_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_5G[0]);\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC | RADIO_2056_RX1,\r\nRADIO_2056_VCM_MASK,\r\npi->rssical_cache.\r\nrssical_radio_regs_5G[1]);\r\n}\r\nwrite_phy_reg(pi, 0x1a6,\r\npi->rssical_cache.rssical_phyregs_5G[0]);\r\nwrite_phy_reg(pi, 0x1ac,\r\npi->rssical_cache.rssical_phyregs_5G[1]);\r\nwrite_phy_reg(pi, 0x1b2,\r\npi->rssical_cache.rssical_phyregs_5G[2]);\r\nwrite_phy_reg(pi, 0x1b8,\r\npi->rssical_cache.rssical_phyregs_5G[3]);\r\nwrite_phy_reg(pi, 0x1a4,\r\npi->rssical_cache.rssical_phyregs_5G[4]);\r\nwrite_phy_reg(pi, 0x1aa,\r\npi->rssical_cache.rssical_phyregs_5G[5]);\r\nwrite_phy_reg(pi, 0x1b0,\r\npi->rssical_cache.rssical_phyregs_5G[6]);\r\nwrite_phy_reg(pi, 0x1b6,\r\npi->rssical_cache.rssical_phyregs_5G[7]);\r\nwrite_phy_reg(pi, 0x1a5,\r\npi->rssical_cache.rssical_phyregs_5G[8]);\r\nwrite_phy_reg(pi, 0x1ab,\r\npi->rssical_cache.rssical_phyregs_5G[9]);\r\nwrite_phy_reg(pi, 0x1b1,\r\npi->rssical_cache.rssical_phyregs_5G[10]);\r\nwrite_phy_reg(pi, 0x1b7,\r\npi->rssical_cache.rssical_phyregs_5G[11]);\r\n}\r\n}\r\nstatic void wlc_phy_internal_cal_txgain_nphy(struct brcms_phy *pi)\r\n{\r\nu16 txcal_gain[2];\r\npi->nphy_txcal_pwr_idx[0] = pi->nphy_cal_orig_pwr_idx[0];\r\npi->nphy_txcal_pwr_idx[1] = pi->nphy_cal_orig_pwr_idx[0];\r\nwlc_phy_txpwr_index_nphy(pi, 1, pi->nphy_cal_orig_pwr_idx[0], true);\r\nwlc_phy_txpwr_index_nphy(pi, 2, pi->nphy_cal_orig_pwr_idx[1], true);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ntxcal_gain);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\ntxcal_gain[0] = (txcal_gain[0] & 0xF000) | 0x0F40;\r\ntxcal_gain[1] = (txcal_gain[1] & 0xF000) | 0x0F40;\r\n} else {\r\ntxcal_gain[0] = (txcal_gain[0] & 0xF000) | 0x0F60;\r\ntxcal_gain[1] = (txcal_gain[1] & 0xF000) | 0x0F60;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ntxcal_gain);\r\n}\r\nstatic void wlc_phy_precal_txgain_nphy(struct brcms_phy *pi)\r\n{\r\nbool save_bbmult = false;\r\nu8 txcal_index_2057_rev5n7 = 0;\r\nu8 txcal_index_2057_rev3n4n6 = 10;\r\nif (pi->use_int_tx_iqlo_cal_nphy) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6)) {\r\npi->nphy_txcal_pwr_idx[0] =\r\ntxcal_index_2057_rev3n4n6;\r\npi->nphy_txcal_pwr_idx[1] =\r\ntxcal_index_2057_rev3n4n6;\r\nwlc_phy_txpwr_index_nphy(\r\npi, 3,\r\ntxcal_index_2057_rev3n4n6,\r\nfalse);\r\n} else {\r\npi->nphy_txcal_pwr_idx[0] =\r\ntxcal_index_2057_rev5n7;\r\npi->nphy_txcal_pwr_idx[1] =\r\ntxcal_index_2057_rev5n7;\r\nwlc_phy_txpwr_index_nphy(\r\npi, 3,\r\ntxcal_index_2057_rev5n7,\r\nfalse);\r\n}\r\nsave_bbmult = true;\r\n} else if (NREV_LT(pi->pubpi.phy_rev, 5)) {\r\nwlc_phy_cal_txgainctrl_nphy(pi, 11, false);\r\nif (pi->sh->hw_phytxchain != 3) {\r\npi->nphy_txcal_pwr_idx[1] =\r\npi->nphy_txcal_pwr_idx[0];\r\nwlc_phy_txpwr_index_nphy(pi, 3,\r\npi->\r\nnphy_txcal_pwr_idx[0],\r\ntrue);\r\nsave_bbmult = true;\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nwlc_phy_cal_txgainctrl_nphy(pi, 12,\r\nfalse);\r\n} else {\r\npi->nphy_txcal_pwr_idx[0] = 80;\r\npi->nphy_txcal_pwr_idx[1] = 80;\r\nwlc_phy_txpwr_index_nphy(pi, 3, 80,\r\nfalse);\r\nsave_bbmult = true;\r\n}\r\n} else {\r\nwlc_phy_internal_cal_txgain_nphy(pi);\r\nsave_bbmult = true;\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 6)) {\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwlc_phy_cal_txgainctrl_nphy(pi, 12,\r\nfalse);\r\nelse\r\nwlc_phy_cal_txgainctrl_nphy(pi, 14,\r\nfalse);\r\n} else {\r\nwlc_phy_internal_cal_txgain_nphy(pi);\r\nsave_bbmult = true;\r\n}\r\n}\r\n} else {\r\nwlc_phy_cal_txgainctrl_nphy(pi, 10, false);\r\n}\r\nif (save_bbmult)\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16,\r\n&pi->nphy_txcal_bbmult);\r\n}\r\nstatic void\r\nwlc_phy_rfctrlintc_override_nphy(struct brcms_phy *pi, u8 field, u16 value,\r\nu8 core_code)\r\n{\r\nu16 mask;\r\nu16 val;\r\nu8 core;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (core_code == RADIO_MIMO_CORESEL_CORE1\r\n&& core == PHY_CORE_1)\r\ncontinue;\r\nelse if (core_code == RADIO_MIMO_CORESEL_CORE2\r\n&& core == PHY_CORE_0)\r\ncontinue;\r\nif (NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nmask = (0x1 << 10);\r\nval = 1 << 10;\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x91 :\r\n0x92, mask, val);\r\n}\r\nif (field == NPHY_RfctrlIntc_override_OFF) {\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ? 0x91 :\r\n0x92, 0);\r\nwlc_phy_force_rfseq_nphy(pi,\r\nNPHY_RFSEQ_RESET2RX);\r\n} else if (field == NPHY_RfctrlIntc_override_TRSW) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmask = (0x1 << 6) | (0x1 << 7);\r\nval = value << 6;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\nor_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\n(0x1 << 10));\r\nand_phy_reg(pi, 0x2ff, (u16)\r\n~(0x3 << 14));\r\nor_phy_reg(pi, 0x2ff, (0x1 << 13));\r\nor_phy_reg(pi, 0x2ff, (0x1 << 0));\r\n} else {\r\nmask = (0x1 << 6) |\r\n(0x1 << 7) |\r\n(0x1 << 8) | (0x1 << 9);\r\nval = value << 6;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\nmask = (0x1 << 0);\r\nval = 1 << 0;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xe7 : 0xec,\r\nmask, val);\r\nmask = (core == PHY_CORE_0) ?\r\n(0x1 << 0) : (0x1 << 1);\r\nval = 1 << ((core == PHY_CORE_0) ?\r\n0 : 1);\r\nmod_phy_reg(pi, 0x78, mask, val);\r\nSPINWAIT(((read_phy_reg(pi, 0x78) & val)\r\n!= 0), 10000);\r\nif (WARN(read_phy_reg(pi, 0x78) & val,\r\n"HW error: override failed"))\r\nreturn;\r\nmask = (0x1 << 0);\r\nval = 0 << 0;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xe7 : 0xec,\r\nmask, val);\r\n}\r\n} else if (field == NPHY_RfctrlIntc_override_PA) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmask = (0x1 << 4) | (0x1 << 5);\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nval = value << 5;\r\nelse\r\nval = value << 4;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\nor_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\n(0x1 << 12));\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmask = (0x1 << 5);\r\nval = value << 5;\r\n} else {\r\nmask = (0x1 << 4);\r\nval = value << 4;\r\n}\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\n}\r\n} else if (field ==\r\nNPHY_RfctrlIntc_override_EXT_LNA_PU) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmask = (0x1 << 0);\r\nval = value << 0;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, val);\r\nmask = (0x1 << 2);\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, 0);\r\n} else {\r\nmask = (0x1 << 2);\r\nval = value << 2;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, val);\r\nmask = (0x1 << 0);\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, 0);\r\n}\r\nmask = (0x1 << 11);\r\nval = 1 << 11;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmask = (0x1 << 0);\r\nval = value << 0;\r\n} else {\r\nmask = (0x1 << 2);\r\nval = value << 2;\r\n}\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\n}\r\n} else if (field ==\r\nNPHY_RfctrlIntc_override_EXT_LNA_GAIN) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmask = (0x1 << 1);\r\nval = value << 1;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, val);\r\nmask = (0x1 << 3);\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, 0);\r\n} else {\r\nmask = (0x1 << 3);\r\nval = value << 3;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, val);\r\nmask = (0x1 << 1);\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91\r\n: 0x92, mask, 0);\r\n}\r\nmask = (0x1 << 11);\r\nval = 1 << 11;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmask = (0x1 << 1);\r\nval = value << 1;\r\n} else {\r\nmask = (0x1 << 3);\r\nval = value << 3;\r\n}\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x91 : 0x92,\r\nmask, val);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\nwlc_phy_cal_txgainctrl_nphy(struct brcms_phy *pi, s32 dBm_targetpower,\r\nbool debug)\r\n{\r\nint gainctrl_loopidx;\r\nuint core;\r\nu16 m0m1, curr_m0m1;\r\ns32 delta_power;\r\ns32 txpwrindex;\r\ns32 qdBm_power[2];\r\nu16 orig_BBConfig;\r\nu16 phy_saveregs[4];\r\nu32 freq_test;\r\nu16 ampl_test = 250;\r\nuint stepsize;\r\nbool phyhang_avoid_state = false;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nstepsize = 2;\r\nelse\r\nstepsize = 1;\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\nfreq_test = 5000;\r\nelse\r\nfreq_test = 2500;\r\nwlc_phy_txpwr_index_nphy(pi, 1, pi->nphy_cal_orig_pwr_idx[0], true);\r\nwlc_phy_txpwr_index_nphy(pi, 2, pi->nphy_cal_orig_pwr_idx[1], true);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nphyhang_avoid_state = pi->phyhang_avoid;\r\npi->phyhang_avoid = false;\r\nphy_saveregs[0] = read_phy_reg(pi, 0x91);\r\nphy_saveregs[1] = read_phy_reg(pi, 0x92);\r\nphy_saveregs[2] = read_phy_reg(pi, 0xe7);\r\nphy_saveregs[3] = read_phy_reg(pi, 0xec);\r\nwlc_phy_rfctrlintc_override_nphy(pi, NPHY_RfctrlIntc_override_PA, 1,\r\nRADIO_MIMO_CORESEL_CORE1 |\r\nRADIO_MIMO_CORESEL_CORE2);\r\nif (!debug) {\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x2, RADIO_MIMO_CORESEL_CORE1);\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x8, RADIO_MIMO_CORESEL_CORE2);\r\n} else {\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x1, RADIO_MIMO_CORESEL_CORE1);\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x7, RADIO_MIMO_CORESEL_CORE2);\r\n}\r\norig_BBConfig = read_phy_reg(pi, 0x01);\r\nmod_phy_reg(pi, 0x01, (0x1 << 15), 0);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &m0m1);\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\ntxpwrindex = (s32) pi->nphy_cal_orig_pwr_idx[core];\r\nfor (gainctrl_loopidx = 0; gainctrl_loopidx < 2;\r\ngainctrl_loopidx++) {\r\nwlc_phy_tx_tone_nphy(pi, freq_test, ampl_test, 0, 0,\r\nfalse);\r\nif (core == PHY_CORE_0)\r\ncurr_m0m1 = m0m1 & 0xff00;\r\nelse\r\ncurr_m0m1 = m0m1 & 0x00ff;\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &curr_m0m1);\r\nwlc_phy_table_write_nphy(pi, 15, 1, 95, 16, &curr_m0m1);\r\nudelay(50);\r\nwlc_phy_est_tonepwr_nphy(pi, qdBm_power,\r\nNPHY_CAL_TSSISAMPS);\r\npi->nphy_bb_mult_save = 0;\r\nwlc_phy_stopplayback_nphy(pi);\r\ndelta_power = (dBm_targetpower * 4) - qdBm_power[core];\r\ntxpwrindex -= stepsize * delta_power;\r\nif (txpwrindex < 0)\r\ntxpwrindex = 0;\r\nelse if (txpwrindex > 127)\r\ntxpwrindex = 127;\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 4) &&\r\n(pi->srom_fem5g.extpagain == 3)) {\r\nif (txpwrindex < 30)\r\ntxpwrindex = 30;\r\n}\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 5) &&\r\n(pi->srom_fem2g.extpagain == 3)) {\r\nif (txpwrindex < 50)\r\ntxpwrindex = 50;\r\n}\r\n}\r\nwlc_phy_txpwr_index_nphy(pi, (1 << core),\r\n(u8) txpwrindex, true);\r\n}\r\npi->nphy_txcal_pwr_idx[core] = (u8) txpwrindex;\r\nif (debug) {\r\nu16 radio_gain;\r\nu16 dbg_m0m1;\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &dbg_m0m1);\r\nwlc_phy_tx_tone_nphy(pi, freq_test, ampl_test, 0, 0,\r\nfalse);\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &dbg_m0m1);\r\nwlc_phy_table_write_nphy(pi, 15, 1, 95, 16, &dbg_m0m1);\r\nudelay(100);\r\nwlc_phy_est_tonepwr_nphy(pi, qdBm_power,\r\nNPHY_CAL_TSSISAMPS);\r\nwlc_phy_table_read_nphy(pi, 7, 1, (0x110 + core), 16,\r\n&radio_gain);\r\nmdelay(4000);\r\npi->nphy_bb_mult_save = 0;\r\nwlc_phy_stopplayback_nphy(pi);\r\n}\r\n}\r\nwlc_phy_txpwr_index_nphy(pi, 1, pi->nphy_txcal_pwr_idx[0], true);\r\nwlc_phy_txpwr_index_nphy(pi, 2, pi->nphy_txcal_pwr_idx[1], true);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &pi->nphy_txcal_bbmult);\r\nwrite_phy_reg(pi, 0x01, orig_BBConfig);\r\nwrite_phy_reg(pi, 0x91, phy_saveregs[0]);\r\nwrite_phy_reg(pi, 0x92, phy_saveregs[1]);\r\nwrite_phy_reg(pi, 0xe7, phy_saveregs[2]);\r\nwrite_phy_reg(pi, 0xec, phy_saveregs[3]);\r\npi->phyhang_avoid = phyhang_avoid_state;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void wlc_phy_savecal_nphy(struct brcms_phy *pi)\r\n{\r\nvoid *tbl_ptr;\r\nint coreNum;\r\nu16 *txcal_radio_regs = NULL;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 0,\r\n&pi->calibration_cache.\r\nrxcal_coeffs_2G);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\ntxcal_radio_regs =\r\npi->calibration_cache.txcal_radio_regs_2G;\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->calibration_cache.txcal_radio_regs_2G[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_2G[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_2G[2] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_2G[3] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_2G[4] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_2G[5] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_2G[6] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_2G[7] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX1);\r\n} else {\r\npi->calibration_cache.txcal_radio_regs_2G[0] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TX_VOS_CNCL);\r\npi->calibration_cache.txcal_radio_regs_2G[1] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TX_VOS_CNCL);\r\npi->calibration_cache.txcal_radio_regs_2G[2] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM);\r\npi->calibration_cache.txcal_radio_regs_2G[3] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM);\r\n}\r\npi->nphy_iqcal_chanspec_2G = pi->radio_chanspec;\r\ntbl_ptr = pi->calibration_cache.txcal_coeffs_2G;\r\n} else {\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 0,\r\n&pi->calibration_cache.\r\nrxcal_coeffs_5G);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\ntxcal_radio_regs =\r\npi->calibration_cache.txcal_radio_regs_5G;\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->calibration_cache.txcal_radio_regs_5G[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_5G[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_5G[2] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_5G[3] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_5G[4] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_5G[5] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX0);\r\npi->calibration_cache.txcal_radio_regs_5G[6] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX1);\r\npi->calibration_cache.txcal_radio_regs_5G[7] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX1);\r\n} else {\r\npi->calibration_cache.txcal_radio_regs_5G[0] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TX_VOS_CNCL);\r\npi->calibration_cache.txcal_radio_regs_5G[1] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TX_VOS_CNCL);\r\npi->calibration_cache.txcal_radio_regs_5G[2] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM);\r\npi->calibration_cache.txcal_radio_regs_5G[3] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM);\r\n}\r\npi->nphy_iqcal_chanspec_5G = pi->radio_chanspec;\r\ntbl_ptr = pi->calibration_cache.txcal_coeffs_5G;\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\ntxcal_radio_regs[2 * coreNum] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_FINE_I);\r\ntxcal_radio_regs[2 * coreNum + 1] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_FINE_Q);\r\ntxcal_radio_regs[2 * coreNum + 4] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_COARSE_I);\r\ntxcal_radio_regs[2 * coreNum + 5] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_COARSE_Q);\r\n}\r\n}\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL, 8, 80, 16, tbl_ptr);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void wlc_phy_tx_iq_war_nphy(struct brcms_phy *pi)\r\n{\r\nstruct nphy_iq_comp tx_comp;\r\nwlc_phy_table_read_nphy(pi, 15, 4, 0x50, 16, &tx_comp);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_20IN40_IQ, tx_comp.a0);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_20IN40_IQ + 2, tx_comp.b0);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_20IN40_IQ + 4, tx_comp.a1);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_20IN40_IQ + 6, tx_comp.b1);\r\n}\r\nstatic void wlc_phy_restorecal_nphy(struct brcms_phy *pi)\r\n{\r\nu16 *loft_comp;\r\nu16 txcal_coeffs_bphy[4];\r\nu16 *tbl_ptr;\r\nint coreNum;\r\nu16 *txcal_radio_regs = NULL;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->nphy_iqcal_chanspec_2G == 0)\r\nreturn;\r\ntbl_ptr = pi->calibration_cache.txcal_coeffs_2G;\r\nloft_comp = &pi->calibration_cache.txcal_coeffs_2G[5];\r\n} else {\r\nif (pi->nphy_iqcal_chanspec_5G == 0)\r\nreturn;\r\ntbl_ptr = pi->calibration_cache.txcal_coeffs_5G;\r\nloft_comp = &pi->calibration_cache.txcal_coeffs_5G[5];\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 80, 16, tbl_ptr);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\ntxcal_coeffs_bphy[0] = tbl_ptr[0];\r\ntxcal_coeffs_bphy[1] = tbl_ptr[1];\r\ntxcal_coeffs_bphy[2] = tbl_ptr[2];\r\ntxcal_coeffs_bphy[3] = tbl_ptr[3];\r\n} else {\r\ntxcal_coeffs_bphy[0] = 0;\r\ntxcal_coeffs_bphy[1] = 0;\r\ntxcal_coeffs_bphy[2] = 0;\r\ntxcal_coeffs_bphy[3] = 0;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 88, 16,\r\ntxcal_coeffs_bphy);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 85, 16, loft_comp);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 93, 16, loft_comp);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2))\r\nwlc_phy_tx_iq_war_nphy(pi);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\ntxcal_radio_regs =\r\npi->calibration_cache.txcal_radio_regs_2G;\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[0]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[1]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[2]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[3]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[4]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[5]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[6]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[7]);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_VOS_CNCL,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[0]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_VOS_CNCL,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[1]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[2]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM,\r\npi->calibration_cache.\r\ntxcal_radio_regs_2G[3]);\r\n}\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1,\r\n&pi->calibration_cache.\r\nrxcal_coeffs_2G);\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\ntxcal_radio_regs =\r\npi->calibration_cache.txcal_radio_regs_5G;\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[0]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[1]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_I |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[2]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_FINE_Q |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[3]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[4]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX0,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[5]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_I |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[6]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_LOFT_COARSE_Q |\r\nRADIO_2056_TX1,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[7]);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_VOS_CNCL,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[0]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_VOS_CNCL,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[1]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[2]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM,\r\npi->calibration_cache.\r\ntxcal_radio_regs_5G[3]);\r\n}\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1,\r\n&pi->calibration_cache.\r\nrxcal_coeffs_5G);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_FINE_I,\r\ntxcal_radio_regs[2 * coreNum]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_FINE_Q,\r\ntxcal_radio_regs[2 * coreNum + 1]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_COARSE_I,\r\ntxcal_radio_regs[2 * coreNum + 4]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, coreNum,\r\nLOFT_COARSE_Q,\r\ntxcal_radio_regs[2 * coreNum + 5]);\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_txpwrctrl_coeff_setup_nphy(struct brcms_phy *pi)\r\n{\r\nu32 idx;\r\nu16 iqloCalbuf[7];\r\nu32 iqcomp, locomp, curr_locomp;\r\ns8 locomp_i, locomp_q;\r\ns8 curr_locomp_i, curr_locomp_q;\r\nu32 tbl_id, tbl_len, tbl_offset;\r\nu32 regval[128];\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nwlc_phy_table_read_nphy(pi, 15, 7, 80, 16, iqloCalbuf);\r\ntbl_len = 128;\r\ntbl_offset = 320;\r\nfor (tbl_id = NPHY_TBL_ID_CORE1TXPWRCTL;\r\ntbl_id <= NPHY_TBL_ID_CORE2TXPWRCTL; tbl_id++) {\r\niqcomp =\r\n(tbl_id ==\r\n26) ? (((u32) (iqloCalbuf[0] & 0x3ff)) << 10) |\r\n(iqloCalbuf[1] & 0x3ff)\r\n: (((u32) (iqloCalbuf[2] & 0x3ff)) << 10) |\r\n(iqloCalbuf[3] & 0x3ff);\r\nfor (idx = 0; idx < tbl_len; idx++)\r\nregval[idx] = iqcomp;\r\nwlc_phy_table_write_nphy(pi, tbl_id, tbl_len, tbl_offset, 32,\r\nregval);\r\n}\r\ntbl_offset = 448;\r\nfor (tbl_id = NPHY_TBL_ID_CORE1TXPWRCTL;\r\ntbl_id <= NPHY_TBL_ID_CORE2TXPWRCTL; tbl_id++) {\r\nlocomp =\r\n(u32) ((tbl_id == 26) ? iqloCalbuf[5] : iqloCalbuf[6]);\r\nlocomp_i = (s8) ((locomp >> 8) & 0xff);\r\nlocomp_q = (s8) ((locomp) & 0xff);\r\nfor (idx = 0; idx < tbl_len; idx++) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\ncurr_locomp_i = locomp_i;\r\ncurr_locomp_q = locomp_q;\r\n} else {\r\ncurr_locomp_i = (s8) ((locomp_i *\r\nnphy_tpc_loscale[idx] +\r\n128) >> 8);\r\ncurr_locomp_q =\r\n(s8) ((locomp_q *\r\nnphy_tpc_loscale[idx] +\r\n128) >> 8);\r\n}\r\ncurr_locomp = (u32) ((curr_locomp_i & 0xff) << 8);\r\ncurr_locomp |= (u32) (curr_locomp_q & 0xff);\r\nregval[idx] = curr_locomp;\r\n}\r\nwlc_phy_table_write_nphy(pi, tbl_id, tbl_len, tbl_offset, 32,\r\nregval);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_CURR_IDX1, 0xFFFF);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_CURR_IDX2, 0xFFFF);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void wlc_phy_txlpfbw_nphy(struct brcms_phy *pi)\r\n{\r\nu8 tx_lpf_bw = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\ntx_lpf_bw = 3;\r\nelse\r\ntx_lpf_bw = 1;\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\ntx_lpf_bw = 5;\r\nelse\r\ntx_lpf_bw = 4;\r\n}\r\nwrite_phy_reg(pi, 0xe8,\r\n(tx_lpf_bw << 0) |\r\n(tx_lpf_bw << 3) |\r\n(tx_lpf_bw << 6) | (tx_lpf_bw << 9));\r\nif (PHY_IPA(pi)) {\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\ntx_lpf_bw = 4;\r\nelse\r\ntx_lpf_bw = 1;\r\nwrite_phy_reg(pi, 0xe9,\r\n(tx_lpf_bw << 0) |\r\n(tx_lpf_bw << 3) |\r\n(tx_lpf_bw << 6) | (tx_lpf_bw << 9));\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_phy_adjust_rx_analpfbw_nphy(struct brcms_phy *pi, u16 reduction_factr)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nif ((CHSPEC_CHANNEL(pi->radio_chanspec) == 11) &&\r\nCHSPEC_IS40(pi->radio_chanspec)) {\r\nif (!pi->nphy_anarxlpf_adjusted) {\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_LPC |\r\nRADIO_2056_RX0),\r\n((pi->nphy_rccal_value +\r\nreduction_factr) | 0x80));\r\npi->nphy_anarxlpf_adjusted = true;\r\n}\r\n} else {\r\nif (pi->nphy_anarxlpf_adjusted) {\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_LPC |\r\nRADIO_2056_RX0),\r\n(pi->nphy_rccal_value | 0x80));\r\npi->nphy_anarxlpf_adjusted = false;\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_phy_adjust_min_noisevar_nphy(struct brcms_phy *pi, int ntones,\r\nint *tone_id_buf, u32 *noise_var_buf)\r\n{\r\nint i;\r\nu32 offset;\r\nint tone_id;\r\nint tbllen =\r\nCHSPEC_IS40(pi->radio_chanspec) ?\r\nNPHY_NOISEVAR_TBLLEN40 : NPHY_NOISEVAR_TBLLEN20;\r\nif (pi->nphy_noisevars_adjusted) {\r\nfor (i = 0; i < pi->nphy_saved_noisevars.bufcount; i++) {\r\ntone_id = pi->nphy_saved_noisevars.tone_id[i];\r\noffset = (tone_id >= 0) ?\r\n((tone_id *\r\n2) + 1) : (tbllen + (tone_id * 2) + 1);\r\nwlc_phy_table_write_nphy(\r\npi, NPHY_TBL_ID_NOISEVAR, 1,\r\noffset, 32,\r\n&pi->nphy_saved_noisevars.min_noise_vars[i]);\r\n}\r\npi->nphy_saved_noisevars.bufcount = 0;\r\npi->nphy_noisevars_adjusted = false;\r\n}\r\nif ((noise_var_buf != NULL) && (tone_id_buf != NULL)) {\r\npi->nphy_saved_noisevars.bufcount = 0;\r\nfor (i = 0; i < ntones; i++) {\r\ntone_id = tone_id_buf[i];\r\noffset = (tone_id >= 0) ?\r\n((tone_id * 2) + 1) :\r\n(tbllen + (tone_id * 2) + 1);\r\npi->nphy_saved_noisevars.tone_id[i] = tone_id;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\noffset, 32,\r\n&pi->nphy_saved_noisevars.\r\nmin_noise_vars[i]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_NOISEVAR, 1,\r\noffset, 32, &noise_var_buf[i]);\r\npi->nphy_saved_noisevars.bufcount++;\r\n}\r\npi->nphy_noisevars_adjusted = true;\r\n}\r\n}\r\nstatic void wlc_phy_adjust_crsminpwr_nphy(struct brcms_phy *pi, u8 minpwr)\r\n{\r\nu16 regval;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif ((CHSPEC_CHANNEL(pi->radio_chanspec) == 11) &&\r\nCHSPEC_IS40(pi->radio_chanspec)) {\r\nif (!pi->nphy_crsminpwr_adjusted) {\r\nregval = read_phy_reg(pi, 0x27d);\r\npi->nphy_crsminpwr[0] = regval & 0xff;\r\nregval &= 0xff00;\r\nregval |= (u16) minpwr;\r\nwrite_phy_reg(pi, 0x27d, regval);\r\nregval = read_phy_reg(pi, 0x280);\r\npi->nphy_crsminpwr[1] = regval & 0xff;\r\nregval &= 0xff00;\r\nregval |= (u16) minpwr;\r\nwrite_phy_reg(pi, 0x280, regval);\r\nregval = read_phy_reg(pi, 0x283);\r\npi->nphy_crsminpwr[2] = regval & 0xff;\r\nregval &= 0xff00;\r\nregval |= (u16) minpwr;\r\nwrite_phy_reg(pi, 0x283, regval);\r\npi->nphy_crsminpwr_adjusted = true;\r\n}\r\n} else {\r\nif (pi->nphy_crsminpwr_adjusted) {\r\nregval = read_phy_reg(pi, 0x27d);\r\nregval &= 0xff00;\r\nregval |= pi->nphy_crsminpwr[0];\r\nwrite_phy_reg(pi, 0x27d, regval);\r\nregval = read_phy_reg(pi, 0x280);\r\nregval &= 0xff00;\r\nregval |= pi->nphy_crsminpwr[1];\r\nwrite_phy_reg(pi, 0x280, regval);\r\nregval = read_phy_reg(pi, 0x283);\r\nregval &= 0xff00;\r\nregval |= pi->nphy_crsminpwr[2];\r\nwrite_phy_reg(pi, 0x283, regval);\r\npi->nphy_crsminpwr_adjusted = false;\r\n}\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_spurwar_nphy(struct brcms_phy *pi)\r\n{\r\nu16 cur_channel = 0;\r\nint nphy_adj_tone_id_buf[] = { 57, 58 };\r\nu32 nphy_adj_noise_var_buf[] = { 0x3ff, 0x3ff };\r\nbool isAdjustNoiseVar = false;\r\nuint numTonesAdjust = 0;\r\nu32 tempval = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\ncur_channel = CHSPEC_CHANNEL(pi->radio_chanspec);\r\nif (pi->nphy_gband_spurwar_en) {\r\nwlc_phy_adjust_rx_analpfbw_nphy(\r\npi,\r\nNPHY_ANARXLPFBW_REDUCTIONFACT);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((cur_channel == 11)\r\n&& CHSPEC_IS40(pi->radio_chanspec))\r\nwlc_phy_adjust_min_noisevar_nphy(\r\npi, 2,\r\nnphy_adj_tone_id_buf,\r\nnphy_adj_noise_var_buf);\r\nelse\r\nwlc_phy_adjust_min_noisevar_nphy(pi, 0,\r\nNULL,\r\nNULL);\r\n}\r\nwlc_phy_adjust_crsminpwr_nphy(pi,\r\nNPHY_ADJUSTED_MINCRSPOWER);\r\n}\r\nif ((pi->nphy_gband_spurwar2_en)\r\n&& CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (CHSPEC_IS40(pi->radio_chanspec)) {\r\nswitch (cur_channel) {\r\ncase 3:\r\nnphy_adj_tone_id_buf[0] = 57;\r\nnphy_adj_tone_id_buf[1] = 58;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x25f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 4:\r\nnphy_adj_tone_id_buf[0] = 41;\r\nnphy_adj_tone_id_buf[1] = 42;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x25f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 5:\r\nnphy_adj_tone_id_buf[0] = 25;\r\nnphy_adj_tone_id_buf[1] = 26;\r\nnphy_adj_noise_var_buf[0] = 0x24f;\r\nnphy_adj_noise_var_buf[1] = 0x25f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 6:\r\nnphy_adj_tone_id_buf[0] = 9;\r\nnphy_adj_tone_id_buf[1] = 10;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x24f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 7:\r\nnphy_adj_tone_id_buf[0] = 121;\r\nnphy_adj_tone_id_buf[1] = 122;\r\nnphy_adj_noise_var_buf[0] = 0x18f;\r\nnphy_adj_noise_var_buf[1] = 0x24f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 8:\r\nnphy_adj_tone_id_buf[0] = 105;\r\nnphy_adj_tone_id_buf[1] = 106;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x25f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 9:\r\nnphy_adj_tone_id_buf[0] = 89;\r\nnphy_adj_tone_id_buf[1] = 90;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x24f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ncase 10:\r\nnphy_adj_tone_id_buf[0] = 73;\r\nnphy_adj_tone_id_buf[1] = 74;\r\nnphy_adj_noise_var_buf[0] = 0x22f;\r\nnphy_adj_noise_var_buf[1] = 0x24f;\r\nisAdjustNoiseVar = true;\r\nbreak;\r\ndefault:\r\nisAdjustNoiseVar = false;\r\nbreak;\r\n}\r\n}\r\nif (isAdjustNoiseVar) {\r\nnumTonesAdjust = ARRAY_SIZE(nphy_adj_tone_id_buf);\r\nwlc_phy_adjust_min_noisevar_nphy(\r\npi,\r\nnumTonesAdjust,\r\nnphy_adj_tone_id_buf,\r\nnphy_adj_noise_var_buf);\r\ntempval = 0;\r\n} else {\r\nwlc_phy_adjust_min_noisevar_nphy(pi, 0, NULL,\r\nNULL);\r\n}\r\n}\r\nif ((pi->nphy_aband_spurwar_en) &&\r\n(CHSPEC_IS5G(pi->radio_chanspec))) {\r\nswitch (cur_channel) {\r\ncase 54:\r\nnphy_adj_tone_id_buf[0] = 32;\r\nnphy_adj_noise_var_buf[0] = 0x25f;\r\nbreak;\r\ncase 38:\r\ncase 102:\r\ncase 118:\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM4716) &&\r\n(pi->sh->chippkg == BCMA_PKG_ID_BCM4717)) {\r\nnphy_adj_tone_id_buf[0] = 32;\r\nnphy_adj_noise_var_buf[0] = 0x21f;\r\n} else {\r\nnphy_adj_tone_id_buf[0] = 0;\r\nnphy_adj_noise_var_buf[0] = 0x0;\r\n}\r\nbreak;\r\ncase 134:\r\nnphy_adj_tone_id_buf[0] = 32;\r\nnphy_adj_noise_var_buf[0] = 0x21f;\r\nbreak;\r\ncase 151:\r\nnphy_adj_tone_id_buf[0] = 16;\r\nnphy_adj_noise_var_buf[0] = 0x23f;\r\nbreak;\r\ncase 153:\r\ncase 161:\r\nnphy_adj_tone_id_buf[0] = 48;\r\nnphy_adj_noise_var_buf[0] = 0x23f;\r\nbreak;\r\ndefault:\r\nnphy_adj_tone_id_buf[0] = 0;\r\nnphy_adj_noise_var_buf[0] = 0x0;\r\nbreak;\r\n}\r\nif (nphy_adj_tone_id_buf[0]\r\n&& nphy_adj_noise_var_buf[0])\r\nwlc_phy_adjust_min_noisevar_nphy(\r\npi, 1,\r\nnphy_adj_tone_id_buf,\r\nnphy_adj_noise_var_buf);\r\nelse\r\nwlc_phy_adjust_min_noisevar_nphy(pi, 0, NULL,\r\nNULL);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\n}\r\nvoid wlc_phy_init_nphy(struct brcms_phy *pi)\r\n{\r\nu16 val;\r\nu16 clip1_ths[2];\r\nstruct nphy_txgains target_gain;\r\nu8 tx_pwr_ctrl_state;\r\nbool do_nphy_cal = false;\r\nuint core;\r\nu32 d11_clk_ctl_st;\r\nbool do_rssi_cal = false;\r\ncore = 0;\r\nif (!(pi->measure_hold & PHY_HOLD_FOR_SCAN))\r\npi->measure_hold |= PHY_HOLD_FOR_NOT_ASSOC;\r\nif ((ISNPHY(pi)) && (NREV_GE(pi->pubpi.phy_rev, 5)) &&\r\n((pi->sh->chippkg == BCMA_PKG_ID_BCM4717) ||\r\n(pi->sh->chippkg == BCMA_PKG_ID_BCM4718))) {\r\nif ((pi->sh->boardflags & BFL_EXTLNA) &&\r\n(CHSPEC_IS2G(pi->radio_chanspec)))\r\nbcma_cc_set32(&pi->d11core->bus->drv_cc,\r\nBCMA_CC_CHIPCTL, 0x40);\r\n}\r\nif ((!PHY_IPA(pi)) && (pi->sh->chip == BCMA_CHIP_ID_BCM5357))\r\nbcma_chipco_chipctl_maskset(&pi->d11core->bus->drv_cc, 1,\r\n~CCTRL5357_EXTPA, CCTRL5357_EXTPA);\r\nif ((pi->nphy_gband_spurwar2_en) && CHSPEC_IS2G(pi->radio_chanspec) &&\r\nCHSPEC_IS40(pi->radio_chanspec)) {\r\nd11_clk_ctl_st = bcma_read32(pi->d11core,\r\nD11REGOFFS(clk_ctl_st));\r\nbcma_mask32(pi->d11core, D11REGOFFS(clk_ctl_st),\r\n~(CCS_FORCEHT | CCS_HTAREQ));\r\nbcma_write32(pi->d11core, D11REGOFFS(clk_ctl_st),\r\nd11_clk_ctl_st);\r\n}\r\npi->use_int_tx_iqlo_cal_nphy =\r\n(PHY_IPA(pi) ||\r\n(NREV_GE(pi->pubpi.phy_rev, 7) ||\r\n(NREV_GE(pi->pubpi.phy_rev, 5)\r\n&& pi->sh->boardflags2 & BFL2_INTERNDET_TXIQCAL)));\r\npi->internal_tx_iqlo_cal_tapoff_intpa_nphy = false;\r\npi->nphy_deaf_count = 0;\r\nwlc_phy_tbl_init_nphy(pi);\r\npi->nphy_crsminpwr_adjusted = false;\r\npi->nphy_noisevars_adjusted = false;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_phy_reg(pi, 0xe7, 0);\r\nwrite_phy_reg(pi, 0xec, 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwrite_phy_reg(pi, 0x342, 0);\r\nwrite_phy_reg(pi, 0x343, 0);\r\nwrite_phy_reg(pi, 0x346, 0);\r\nwrite_phy_reg(pi, 0x347, 0);\r\n}\r\nwrite_phy_reg(pi, 0xe5, 0);\r\nwrite_phy_reg(pi, 0xe6, 0);\r\n} else {\r\nwrite_phy_reg(pi, 0xec, 0);\r\n}\r\nwrite_phy_reg(pi, 0x91, 0);\r\nwrite_phy_reg(pi, 0x92, 0);\r\nif (NREV_LT(pi->pubpi.phy_rev, 6)) {\r\nwrite_phy_reg(pi, 0x93, 0);\r\nwrite_phy_reg(pi, 0x94, 0);\r\n}\r\nand_phy_reg(pi, 0xa1, ~3);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_phy_reg(pi, 0x8f, 0);\r\nwrite_phy_reg(pi, 0xa5, 0);\r\n} else {\r\nwrite_phy_reg(pi, 0xa5, 0);\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x3b);\r\nelse if (NREV_LT(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x40);\r\nwrite_phy_reg(pi, 0x203, 32);\r\nwrite_phy_reg(pi, 0x201, 32);\r\nif (pi->sh->boardflags2 & BFL2_SKWRKFEM_BRD)\r\nwrite_phy_reg(pi, 0x20d, 160);\r\nelse\r\nwrite_phy_reg(pi, 0x20d, 184);\r\nwrite_phy_reg(pi, 0x13a, 200);\r\nwrite_phy_reg(pi, 0x70, 80);\r\nwrite_phy_reg(pi, 0x1ff, 48);\r\nif (NREV_LT(pi->pubpi.phy_rev, 8))\r\nwlc_phy_update_mimoconfig_nphy(pi, pi->n_preamble_override);\r\nwlc_phy_stf_chain_upd_nphy(pi);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nwrite_phy_reg(pi, 0x180, 0xaa8);\r\nwrite_phy_reg(pi, 0x181, 0x9a4);\r\n}\r\nif (PHY_IPA(pi)) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x298 :\r\n0x29c, (0x1ff << 7),\r\n(pi->nphy_papd_epsilon_offset[core]) << 7);\r\n}\r\nwlc_phy_ipa_set_tx_digi_filts_nphy(pi);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 5)) {\r\nwlc_phy_extpa_set_tx_digi_filts_nphy(pi);\r\n}\r\nwlc_phy_workarounds_nphy(pi);\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, ON);\r\nval = read_phy_reg(pi, 0x01);\r\nwrite_phy_reg(pi, 0x01, val | BBCFG_RESETCCA);\r\nwrite_phy_reg(pi, 0x01, val & (~BBCFG_RESETCCA));\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, OFF);\r\nwlapi_bmac_macphyclk_set(pi->sh->physhim, ON);\r\nwlc_phy_pa_override_nphy(pi, OFF);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RX2TX);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nwlc_phy_pa_override_nphy(pi, ON);\r\nwlc_phy_classifier_nphy(pi, 0, 0);\r\nwlc_phy_clip_det_nphy(pi, 0, clip1_ths);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwlc_phy_bphy_init_nphy(pi);\r\ntx_pwr_ctrl_state = pi->nphy_txpwrctrl;\r\nwlc_phy_txpwrctrl_enable_nphy(pi, PHY_TPC_HW_OFF);\r\nwlc_phy_txpwr_fixpower_nphy(pi);\r\nwlc_phy_txpwrctrl_idle_tssi_nphy(pi);\r\nwlc_phy_txpwrctrl_pwr_setup_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nu32 *tx_pwrctrl_tbl = NULL;\r\nu16 idx;\r\ns16 pga_gn = 0;\r\ns16 pad_gn = 0;\r\ns32 rfpwr_offset;\r\nif (PHY_IPA(pi)) {\r\ntx_pwrctrl_tbl = wlc_phy_get_ipa_gaintbl_nphy(pi);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 3))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_5GHz_txgain_rev3;\r\nelse if (NREV_IS(pi->pubpi.phy_rev, 4))\r\ntx_pwrctrl_tbl =\r\n(pi->srom_fem5g.extpagain ==\r\n3) ?\r\nnphy_tpc_5GHz_txgain_HiPwrEPA :\r\nnphy_tpc_5GHz_txgain_rev4;\r\nelse\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_5GHz_txgain_rev5;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (pi->pubpi.radiorev == 5)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_epa_2057rev5;\r\nelse if (pi->pubpi.radiorev == 3)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_epa_2057rev3;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 5) &&\r\n(pi->srom_fem2g.extpagain == 3))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_HiPwrEPA;\r\nelse\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_rev3;\r\n}\r\n}\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE1TXPWRCTL, 128,\r\n192, 32, tx_pwrctrl_tbl);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE2TXPWRCTL, 128,\r\n192, 32, tx_pwrctrl_tbl);\r\npi->nphy_gmval = (u16) ((*tx_pwrctrl_tbl >> 16) & 0x7000);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (idx = 0; idx < 128; idx++) {\r\npga_gn = (tx_pwrctrl_tbl[idx] >> 24) & 0xf;\r\npad_gn = (tx_pwrctrl_tbl[idx] >> 19) & 0x1f;\r\nrfpwr_offset = get_rf_pwr_offset(pi, pga_gn,\r\npad_gn);\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_CORE1TXPWRCTL,\r\n1, 576 + idx, 32,\r\n&rfpwr_offset);\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_CORE2TXPWRCTL,\r\n1, 576 + idx, 32,\r\n&rfpwr_offset);\r\n}\r\n} else {\r\nfor (idx = 0; idx < 128; idx++) {\r\npga_gn = (tx_pwrctrl_tbl[idx] >> 24) & 0xf;\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nrfpwr_offset = (s16)\r\nnphy_papd_pga_gain_delta_ipa_2g\r\n[pga_gn];\r\nelse\r\nrfpwr_offset = (s16)\r\nnphy_papd_pga_gain_delta_ipa_5g\r\n[pga_gn];\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_CORE1TXPWRCTL,\r\n1, 576 + idx, 32,\r\n&rfpwr_offset);\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_CORE2TXPWRCTL,\r\n1, 576 + idx, 32,\r\n&rfpwr_offset);\r\n}\r\n}\r\n} else {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE1TXPWRCTL, 128,\r\n192, 32, nphy_tpc_txgain);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE2TXPWRCTL, 128,\r\n192, 32, nphy_tpc_txgain);\r\n}\r\nif (pi->sh->phyrxchain != 0x3)\r\nwlc_phy_rxcore_setstate_nphy((struct brcms_phy_pub *) pi,\r\npi->sh->phyrxchain);\r\nif (PHY_PERICAL_MPHASE_PENDING(pi))\r\nwlc_phy_cal_perical_mphase_restart(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\ndo_rssi_cal = (CHSPEC_IS2G(pi->radio_chanspec)) ?\r\n(pi->nphy_rssical_chanspec_2G == 0) :\r\n(pi->nphy_rssical_chanspec_5G == 0);\r\nif (do_rssi_cal)\r\nwlc_phy_rssi_cal_nphy(pi);\r\nelse\r\nwlc_phy_restore_rssical_nphy(pi);\r\n} else {\r\nwlc_phy_rssi_cal_nphy(pi);\r\n}\r\nif (!SCAN_RM_IN_PROGRESS(pi))\r\ndo_nphy_cal = (CHSPEC_IS2G(pi->radio_chanspec)) ?\r\n(pi->nphy_iqcal_chanspec_2G == 0) :\r\n(pi->nphy_iqcal_chanspec_5G == 0);\r\nif (!pi->do_initcal)\r\ndo_nphy_cal = false;\r\nif (do_nphy_cal) {\r\ntarget_gain = wlc_phy_get_tx_gain_nphy(pi);\r\nif (pi->antsel_type == ANTSEL_2x3)\r\nwlc_phy_antsel_init((struct brcms_phy_pub *) pi,\r\ntrue);\r\nif (pi->nphy_perical != PHY_PERICAL_MPHASE) {\r\nwlc_phy_rssi_cal_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->nphy_cal_orig_pwr_idx[0] =\r\npi->nphy_txpwrindex[PHY_CORE_0]\r\n.\r\nindex_internal;\r\npi->nphy_cal_orig_pwr_idx[1] =\r\npi->nphy_txpwrindex[PHY_CORE_1]\r\n.\r\nindex_internal;\r\nwlc_phy_precal_txgain_nphy(pi);\r\ntarget_gain =\r\nwlc_phy_get_tx_gain_nphy(pi);\r\n}\r\nif (wlc_phy_cal_txiqlo_nphy\r\n(pi, target_gain, true,\r\nfalse) == 0) {\r\nif (wlc_phy_cal_rxiq_nphy\r\n(pi, target_gain, 2,\r\nfalse) == 0)\r\nwlc_phy_savecal_nphy(pi);\r\n}\r\n} else if (pi->mphase_cal_phase_id ==\r\nMPHASE_CAL_STATE_IDLE) {\r\nwlc_phy_cal_perical((struct brcms_phy_pub *) pi,\r\nPHY_PERICAL_PHYINIT);\r\n}\r\n} else {\r\nwlc_phy_restorecal_nphy(pi);\r\n}\r\nwlc_phy_txpwrctrl_coeff_setup_nphy(pi);\r\nwlc_phy_txpwrctrl_enable_nphy(pi, tx_pwr_ctrl_state);\r\nwlc_phy_nphy_tkip_rifs_war(pi, pi->sh->_rifs_phy);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3) && NREV_LE(pi->pubpi.phy_rev, 6))\r\nwrite_phy_reg(pi, 0x70, 50);\r\nwlc_phy_txlpfbw_nphy(pi);\r\nwlc_phy_spurwar_nphy(pi);\r\n}\r\nstatic void wlc_phy_resetcca_nphy(struct brcms_phy *pi)\r\n{\r\nu16 val;\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, ON);\r\nval = read_phy_reg(pi, 0x01);\r\nwrite_phy_reg(pi, 0x01, val | BBCFG_RESETCCA);\r\nudelay(1);\r\nwrite_phy_reg(pi, 0x01, val & (~BBCFG_RESETCCA));\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, OFF);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\n}\r\nvoid wlc_phy_pa_override_nphy(struct brcms_phy *pi, bool en)\r\n{\r\nu16 rfctrlintc_override_val;\r\nif (!en) {\r\npi->rfctrlIntc1_save = read_phy_reg(pi, 0x91);\r\npi->rfctrlIntc2_save = read_phy_reg(pi, 0x92);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nrfctrlintc_override_val = 0x1480;\r\nelse if (NREV_GE(pi->pubpi.phy_rev, 3))\r\nrfctrlintc_override_val =\r\nCHSPEC_IS5G(pi->radio_chanspec) ? 0x600 : 0x480;\r\nelse\r\nrfctrlintc_override_val =\r\nCHSPEC_IS5G(pi->radio_chanspec) ? 0x180 : 0x120;\r\nwrite_phy_reg(pi, 0x91, rfctrlintc_override_val);\r\nwrite_phy_reg(pi, 0x92, rfctrlintc_override_val);\r\n} else {\r\nwrite_phy_reg(pi, 0x91, pi->rfctrlIntc1_save);\r\nwrite_phy_reg(pi, 0x92, pi->rfctrlIntc2_save);\r\n}\r\n}\r\nvoid wlc_phy_stf_chain_upd_nphy(struct brcms_phy *pi)\r\n{\r\nu16 txrx_chain =\r\n(NPHY_RfseqCoreActv_TxRxChain0 | NPHY_RfseqCoreActv_TxRxChain1);\r\nbool CoreActv_override = false;\r\nif (pi->nphy_txrx_chain == BRCMS_N_TXRX_CHAIN0) {\r\ntxrx_chain = NPHY_RfseqCoreActv_TxRxChain0;\r\nCoreActv_override = true;\r\nif (NREV_LE(pi->pubpi.phy_rev, 2))\r\nand_phy_reg(pi, 0xa0, ~0x20);\r\n} else if (pi->nphy_txrx_chain == BRCMS_N_TXRX_CHAIN1) {\r\ntxrx_chain = NPHY_RfseqCoreActv_TxRxChain1;\r\nCoreActv_override = true;\r\nif (NREV_LE(pi->pubpi.phy_rev, 2))\r\nor_phy_reg(pi, 0xa0, 0x20);\r\n}\r\nmod_phy_reg(pi, 0xa2, ((0xf << 0) | (0xf << 4)), txrx_chain);\r\nif (CoreActv_override) {\r\npi->nphy_perical = PHY_PERICAL_DISABLE;\r\nor_phy_reg(pi, 0xa1, NPHY_RfseqMode_CoreActv_override);\r\n} else {\r\npi->nphy_perical = PHY_PERICAL_MPHASE;\r\nand_phy_reg(pi, 0xa1, ~NPHY_RfseqMode_CoreActv_override);\r\n}\r\n}\r\nvoid wlc_phy_rxcore_setstate_nphy(struct brcms_phy_pub *pih, u8 rxcore_bitmask)\r\n{\r\nu16 regval;\r\nu16 tbl_buf[16];\r\nuint i;\r\nstruct brcms_phy *pi = container_of(pih, struct brcms_phy, pubpi_ro);\r\nu16 tbl_opcode;\r\nbool suspend;\r\npi->sh->phyrxchain = rxcore_bitmask;\r\nif (!pi->sh->clk)\r\nreturn;\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nregval = read_phy_reg(pi, 0xa2);\r\nregval &= ~(0xf << 4);\r\nregval |= ((u16) (rxcore_bitmask & 0x3)) << 4;\r\nwrite_phy_reg(pi, 0xa2, regval);\r\nif ((rxcore_bitmask & 0x3) != 0x3) {\r\nwrite_phy_reg(pi, 0x20e, 1);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (pi->rx2tx_biasentry == -1) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\nARRAY_SIZE(tbl_buf), 80,\r\n16, tbl_buf);\r\nfor (i = 0; i < ARRAY_SIZE(tbl_buf); i++) {\r\nif (tbl_buf[i] ==\r\nNPHY_REV3_RFSEQ_CMD_CLR_RXRX_BIAS) {\r\npi->rx2tx_biasentry = (u8) i;\r\ntbl_opcode =\r\nNPHY_REV3_RFSEQ_CMD_NOP;\r\nwlc_phy_table_write_nphy(\r\npi,\r\nNPHY_TBL_ID_RFSEQ,\r\n1, i,\r\n16,\r\n&tbl_opcode);\r\nbreak;\r\n} else if (tbl_buf[i] ==\r\nNPHY_REV3_RFSEQ_CMD_END)\r\nbreak;\r\n}\r\n}\r\n}\r\n} else {\r\nwrite_phy_reg(pi, 0x20e, 30);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (pi->rx2tx_biasentry != -1) {\r\ntbl_opcode = NPHY_REV3_RFSEQ_CMD_CLR_RXRX_BIAS;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\n1, pi->rx2tx_biasentry,\r\n16, &tbl_opcode);\r\npi->rx2tx_biasentry = -1;\r\n}\r\n}\r\n}\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nu8 wlc_phy_rxcore_getstate_nphy(struct brcms_phy_pub *pih)\r\n{\r\nu16 regval, rxen_bits;\r\nstruct brcms_phy *pi = container_of(pih, struct brcms_phy, pubpi_ro);\r\nregval = read_phy_reg(pi, 0xa2);\r\nrxen_bits = (regval >> 4) & 0xf;\r\nreturn (u8) rxen_bits;\r\n}\r\nbool wlc_phy_n_txpower_ipa_ison(struct brcms_phy *pi)\r\n{\r\nreturn PHY_IPA(pi);\r\n}\r\nvoid wlc_phy_cal_init_nphy(struct brcms_phy *pi)\r\n{\r\n}\r\nstatic void wlc_phy_radio_preinit_205x(struct brcms_phy *pi)\r\n{\r\nand_phy_reg(pi, 0x78, ~RFCC_CHIP0_PU);\r\nand_phy_reg(pi, 0x78, RFCC_OE_POR_FORCE);\r\nor_phy_reg(pi, 0x78, ~RFCC_OE_POR_FORCE);\r\nor_phy_reg(pi, 0x78, RFCC_CHIP0_PU);\r\n}\r\nstatic void wlc_phy_radio_init_2057(struct brcms_phy *pi)\r\n{\r\nstruct radio_20xx_regs *regs_2057_ptr = NULL;\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)) {\r\nregs_2057_ptr = regs_2057_rev4;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 8)\r\n|| NREV_IS(pi->pubpi.phy_rev, 9)) {\r\nswitch (pi->pubpi.radiorev) {\r\ncase 5:\r\nif (NREV_IS(pi->pubpi.phy_rev, 8))\r\nregs_2057_ptr = regs_2057_rev5;\r\nelse if (NREV_IS(pi->pubpi.phy_rev, 9))\r\nregs_2057_ptr = regs_2057_rev5v1;\r\nbreak;\r\ncase 7:\r\nregs_2057_ptr = regs_2057_rev7;\r\nbreak;\r\ncase 8:\r\nregs_2057_ptr = regs_2057_rev8;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nwlc_phy_init_radio_regs_allbands(pi, regs_2057_ptr);\r\n}\r\nstatic u16 wlc_phy_radio205x_rcal(struct brcms_phy *pi)\r\n{\r\nu16 rcal_reg = 0;\r\nint i;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (pi->pubpi.radiorev == 5) {\r\nand_phy_reg(pi, 0x342, ~(0x1 << 1));\r\nudelay(10);\r\nmod_radio_reg(pi, RADIO_2057_IQTEST_SEL_PU, 0x1, 0x1);\r\nmod_radio_reg(pi, RADIO_2057v7_IQTEST_SEL_PU2, 0x2,\r\n0x1);\r\n}\r\nmod_radio_reg(pi, RADIO_2057_RCAL_CONFIG, 0x1, 0x1);\r\nudelay(10);\r\nmod_radio_reg(pi, RADIO_2057_RCAL_CONFIG, 0x3, 0x3);\r\nfor (i = 0; i < MAX_205x_RCAL_WAITLOOPS; i++) {\r\nrcal_reg = read_radio_reg(pi, RADIO_2057_RCAL_STATUS);\r\nif (rcal_reg & 0x1)\r\nbreak;\r\nudelay(100);\r\n}\r\nif (WARN(i == MAX_205x_RCAL_WAITLOOPS,\r\n"HW error: radio calib2"))\r\nreturn 0;\r\nmod_radio_reg(pi, RADIO_2057_RCAL_CONFIG, 0x2, 0x0);\r\nrcal_reg = read_radio_reg(pi, RADIO_2057_RCAL_STATUS) & 0x3e;\r\nmod_radio_reg(pi, RADIO_2057_RCAL_CONFIG, 0x1, 0x0);\r\nif (pi->pubpi.radiorev == 5) {\r\nmod_radio_reg(pi, RADIO_2057_IQTEST_SEL_PU, 0x1, 0x0);\r\nmod_radio_reg(pi, RADIO_2057v7_IQTEST_SEL_PU2, 0x2,\r\n0x0);\r\n}\r\nif ((pi->pubpi.radiorev <= 4) || (pi->pubpi.radiorev == 6)) {\r\nmod_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG, 0x3c,\r\nrcal_reg);\r\nmod_radio_reg(pi, RADIO_2057_BANDGAP_RCAL_TRIM, 0xf0,\r\nrcal_reg << 2);\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 3)) {\r\nu16 savereg;\r\nsavereg =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_SYN_PLL_MAST2 |\r\nRADIO_2056_SYN);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST2 | RADIO_2056_SYN,\r\nsavereg | 0x7);\r\nudelay(10);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RCAL_MASTER | RADIO_2056_SYN,\r\n0x1);\r\nudelay(10);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RCAL_MASTER | RADIO_2056_SYN,\r\n0x9);\r\nfor (i = 0; i < MAX_205x_RCAL_WAITLOOPS; i++) {\r\nrcal_reg = read_radio_reg(\r\npi,\r\nRADIO_2056_SYN_RCAL_CODE_OUT |\r\nRADIO_2056_SYN);\r\nif (rcal_reg & 0x80)\r\nbreak;\r\nudelay(100);\r\n}\r\nif (WARN(i == MAX_205x_RCAL_WAITLOOPS,\r\n"HW error: radio calib3"))\r\nreturn 0;\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RCAL_MASTER | RADIO_2056_SYN,\r\n0x1);\r\nrcal_reg =\r\nread_radio_reg(pi,\r\nRADIO_2056_SYN_RCAL_CODE_OUT |\r\nRADIO_2056_SYN);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RCAL_MASTER | RADIO_2056_SYN,\r\n0x0);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST2 | RADIO_2056_SYN,\r\nsavereg);\r\nreturn rcal_reg & 0x1f;\r\n}\r\nreturn rcal_reg & 0x3e;\r\n}\r\nstatic u16 wlc_phy_radio2057_rccal(struct brcms_phy *pi)\r\n{\r\nu16 rccal_valid;\r\nint i;\r\nbool chip43226_6362A0;\r\nchip43226_6362A0 = ((pi->pubpi.radiorev == 3)\r\n|| (pi->pubpi.radiorev == 4)\r\n|| (pi->pubpi.radiorev == 6));\r\nrccal_valid = 0;\r\nif (chip43226_6362A0) {\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_MASTER, 0x61);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0xc0);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2057v7_RCCAL_MASTER, 0x61);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0xe9);\r\n}\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_X1, 0x6e);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nfor (i = 0; i < MAX_205x_RCAL_WAITLOOPS; i++) {\r\nrccal_valid = read_radio_reg(pi, RADIO_2057_RCCAL_DONE_OSCCAP);\r\nif (rccal_valid & 0x2)\r\nbreak;\r\nudelay(500);\r\n}\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nrccal_valid = 0;\r\nif (chip43226_6362A0) {\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_MASTER, 0x69);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0xb0);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2057v7_RCCAL_MASTER, 0x69);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0xd5);\r\n}\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_X1, 0x6e);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nfor (i = 0; i < MAX_205x_RCAL_WAITLOOPS; i++) {\r\nrccal_valid = read_radio_reg(pi, RADIO_2057_RCCAL_DONE_OSCCAP);\r\nif (rccal_valid & 0x2)\r\nbreak;\r\nudelay(500);\r\n}\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nrccal_valid = 0;\r\nif (chip43226_6362A0) {\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_MASTER, 0x73);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_X1, 0x28);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0xb0);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2057v7_RCCAL_MASTER, 0x73);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_X1, 0x6e);\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_TRC0, 0x99);\r\n}\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nfor (i = 0; i < MAX_205x_RCAL_WAITLOOPS; i++) {\r\nrccal_valid = read_radio_reg(pi, RADIO_2057_RCCAL_DONE_OSCCAP);\r\nif (rccal_valid & 0x2)\r\nbreak;\r\nudelay(500);\r\n}\r\nif (WARN(!(rccal_valid & 0x2), "HW error: radio calib4"))\r\nreturn 0;\r\nwrite_radio_reg(pi, RADIO_2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nreturn rccal_valid;\r\n}\r\nstatic void wlc_phy_radio_postinit_2057(struct brcms_phy *pi)\r\n{\r\nmod_radio_reg(pi, RADIO_2057_XTALPUOVR_PINCTRL, 0x1, 0x1);\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_CAL_RESETN, 0x78, 0x78);\r\nmod_radio_reg(pi, RADIO_2057_XTAL_CONFIG2, 0x80, 0x80);\r\nmdelay(2);\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_CAL_RESETN, 0x78, 0x0);\r\nmod_radio_reg(pi, RADIO_2057_XTAL_CONFIG2, 0x80, 0x0);\r\nif (pi->phy_init_por) {\r\nwlc_phy_radio205x_rcal(pi);\r\nwlc_phy_radio2057_rccal(pi);\r\n}\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MASTER, 0x8, 0x0);\r\n}\r\nstatic void wlc_phy_radio_init_2056(struct brcms_phy *pi)\r\n{\r\nconst struct radio_regs *regs_SYN_2056_ptr = NULL;\r\nconst struct radio_regs *regs_TX_2056_ptr = NULL;\r\nconst struct radio_regs *regs_RX_2056_ptr = NULL;\r\nif (NREV_IS(pi->pubpi.phy_rev, 3)) {\r\nregs_SYN_2056_ptr = regs_SYN_2056;\r\nregs_TX_2056_ptr = regs_TX_2056;\r\nregs_RX_2056_ptr = regs_RX_2056;\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 4)) {\r\nregs_SYN_2056_ptr = regs_SYN_2056_A1;\r\nregs_TX_2056_ptr = regs_TX_2056_A1;\r\nregs_RX_2056_ptr = regs_RX_2056_A1;\r\n} else {\r\nswitch (pi->pubpi.radiorev) {\r\ncase 5:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev5;\r\nregs_TX_2056_ptr = regs_TX_2056_rev5;\r\nregs_RX_2056_ptr = regs_RX_2056_rev5;\r\nbreak;\r\ncase 6:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev6;\r\nregs_TX_2056_ptr = regs_TX_2056_rev6;\r\nregs_RX_2056_ptr = regs_RX_2056_rev6;\r\nbreak;\r\ncase 7:\r\ncase 9:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev7;\r\nregs_TX_2056_ptr = regs_TX_2056_rev7;\r\nregs_RX_2056_ptr = regs_RX_2056_rev7;\r\nbreak;\r\ncase 8:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev8;\r\nregs_TX_2056_ptr = regs_TX_2056_rev8;\r\nregs_RX_2056_ptr = regs_RX_2056_rev8;\r\nbreak;\r\ncase 11:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev11;\r\nregs_TX_2056_ptr = regs_TX_2056_rev11;\r\nregs_RX_2056_ptr = regs_RX_2056_rev11;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nwlc_phy_init_radio_regs(pi, regs_SYN_2056_ptr, (u16) RADIO_2056_SYN);\r\nwlc_phy_init_radio_regs(pi, regs_TX_2056_ptr, (u16) RADIO_2056_TX0);\r\nwlc_phy_init_radio_regs(pi, regs_TX_2056_ptr, (u16) RADIO_2056_TX1);\r\nwlc_phy_init_radio_regs(pi, regs_RX_2056_ptr, (u16) RADIO_2056_RX0);\r\nwlc_phy_init_radio_regs(pi, regs_RX_2056_ptr, (u16) RADIO_2056_RX1);\r\n}\r\nstatic void wlc_phy_radio_postinit_2056(struct brcms_phy *pi)\r\n{\r\nmod_radio_reg(pi, RADIO_2056_SYN_COM_CTRL, 0xb, 0xb);\r\nmod_radio_reg(pi, RADIO_2056_SYN_COM_PU, 0x2, 0x2);\r\nmod_radio_reg(pi, RADIO_2056_SYN_COM_RESET, 0x2, 0x2);\r\nudelay(1000);\r\nmod_radio_reg(pi, RADIO_2056_SYN_COM_RESET, 0x2, 0x0);\r\nif ((pi->sh->boardflags2 & BFL2_LEGACY)\r\n|| (pi->sh->boardflags2 & BFL2_XTALBUFOUTEN))\r\nmod_radio_reg(pi, RADIO_2056_SYN_PLL_MAST2, 0xf4, 0x0);\r\nelse\r\nmod_radio_reg(pi, RADIO_2056_SYN_PLL_MAST2, 0xfc, 0x0);\r\nmod_radio_reg(pi, RADIO_2056_SYN_RCCAL_CTRL0, 0x1, 0x0);\r\nif (pi->phy_init_por)\r\nwlc_phy_radio205x_rcal(pi);\r\n}\r\nstatic void wlc_phy_radio_preinit_2055(struct brcms_phy *pi)\r\n{\r\nand_phy_reg(pi, 0x78, ~RFCC_POR_FORCE);\r\nor_phy_reg(pi, 0x78, RFCC_CHIP0_PU | RFCC_OE_POR_FORCE);\r\nor_phy_reg(pi, 0x78, RFCC_POR_FORCE);\r\n}\r\nstatic void wlc_phy_radio_init_2055(struct brcms_phy *pi)\r\n{\r\nwlc_phy_init_radio_regs(pi, regs_2055, RADIO_DEFAULT_CORE);\r\n}\r\nstatic void wlc_phy_radio_postinit_2055(struct brcms_phy *pi)\r\n{\r\nand_radio_reg(pi, RADIO_2055_MASTER_CNTRL1,\r\n~(RADIO_2055_JTAGCTRL_MASK | RADIO_2055_JTAGSYNC_MASK));\r\nif (((pi->sh->sromrev >= 4)\r\n&& !(pi->sh->boardflags2 & BFL2_RXBB_INT_REG_DIS))\r\n|| ((pi->sh->sromrev < 4))) {\r\nand_radio_reg(pi, RADIO_2055_CORE1_RXBB_REGULATOR, 0x7F);\r\nand_radio_reg(pi, RADIO_2055_CORE2_RXBB_REGULATOR, 0x7F);\r\n}\r\nmod_radio_reg(pi, RADIO_2055_RRCCAL_N_OPT_SEL, 0x3F, 0x2C);\r\nwrite_radio_reg(pi, RADIO_2055_CAL_MISC, 0x3C);\r\nand_radio_reg(pi, RADIO_2055_CAL_MISC,\r\n~(RADIO_2055_RRCAL_START | RADIO_2055_RRCAL_RST_N));\r\nor_radio_reg(pi, RADIO_2055_CAL_LPO_CNTRL, RADIO_2055_CAL_LPO_ENABLE);\r\nor_radio_reg(pi, RADIO_2055_CAL_MISC, RADIO_2055_RRCAL_RST_N);\r\nudelay(1000);\r\nor_radio_reg(pi, RADIO_2055_CAL_MISC, RADIO_2055_RRCAL_START);\r\nSPINWAIT(((read_radio_reg(pi, RADIO_2055_CAL_COUNTER_OUT2) &\r\nRADIO_2055_RCAL_DONE) != RADIO_2055_RCAL_DONE), 2000);\r\nif (WARN((read_radio_reg(pi, RADIO_2055_CAL_COUNTER_OUT2) &\r\nRADIO_2055_RCAL_DONE) != RADIO_2055_RCAL_DONE,\r\n"HW error: radio calibration1\n"))\r\nreturn;\r\nand_radio_reg(pi, RADIO_2055_CAL_LPO_CNTRL,\r\n~(RADIO_2055_CAL_LPO_ENABLE));\r\nwlc_phy_chanspec_set((struct brcms_phy_pub *) pi, pi->radio_chanspec);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_RXBB_LPF, 9);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_RXBB_LPF, 9);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_RXBB_MIDAC_HIPAS, 0x83);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_RXBB_MIDAC_HIPAS, 0x83);\r\nmod_radio_reg(pi, RADIO_2055_CORE1_LNA_GAINBST,\r\nRADIO_2055_GAINBST_VAL_MASK, RADIO_2055_GAINBST_CODE);\r\nmod_radio_reg(pi, RADIO_2055_CORE2_LNA_GAINBST,\r\nRADIO_2055_GAINBST_VAL_MASK, RADIO_2055_GAINBST_CODE);\r\nif (pi->nphy_gain_boost) {\r\nand_radio_reg(pi, RADIO_2055_CORE1_RXRF_SPC1,\r\n~(RADIO_2055_GAINBST_DISABLE));\r\nand_radio_reg(pi, RADIO_2055_CORE2_RXRF_SPC1,\r\n~(RADIO_2055_GAINBST_DISABLE));\r\n} else {\r\nor_radio_reg(pi, RADIO_2055_CORE1_RXRF_SPC1,\r\nRADIO_2055_GAINBST_DISABLE);\r\nor_radio_reg(pi, RADIO_2055_CORE2_RXRF_SPC1,\r\nRADIO_2055_GAINBST_DISABLE);\r\n}\r\nudelay(2);\r\n}\r\nvoid wlc_phy_switch_radio_nphy(struct brcms_phy *pi, bool on)\r\n{\r\nif (on) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (!pi->radio_is_on) {\r\nwlc_phy_radio_preinit_205x(pi);\r\nwlc_phy_radio_init_2057(pi);\r\nwlc_phy_radio_postinit_2057(pi);\r\n}\r\nwlc_phy_chanspec_set((struct brcms_phy_pub *) pi,\r\npi->radio_chanspec);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwlc_phy_radio_preinit_205x(pi);\r\nwlc_phy_radio_init_2056(pi);\r\nwlc_phy_radio_postinit_2056(pi);\r\nwlc_phy_chanspec_set((struct brcms_phy_pub *) pi,\r\npi->radio_chanspec);\r\n} else {\r\nwlc_phy_radio_preinit_2055(pi);\r\nwlc_phy_radio_init_2055(pi);\r\nwlc_phy_radio_postinit_2055(pi);\r\n}\r\npi->radio_is_on = true;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)\r\n&& NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nand_phy_reg(pi, 0x78, ~RFCC_CHIP0_PU);\r\nmod_radio_reg(pi, RADIO_2056_SYN_COM_PU, 0x2, 0x0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PADA_BOOST_TUNE |\r\nRADIO_2056_TX0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PADG_BOOST_TUNE |\r\nRADIO_2056_TX0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PGAA_BOOST_TUNE |\r\nRADIO_2056_TX0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PGAG_BOOST_TUNE |\r\nRADIO_2056_TX0, 0);\r\nmod_radio_reg(pi,\r\nRADIO_2056_TX_MIXA_BOOST_TUNE |\r\nRADIO_2056_TX0, 0xf0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_MIXG_BOOST_TUNE |\r\nRADIO_2056_TX0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PADA_BOOST_TUNE |\r\nRADIO_2056_TX1, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PADG_BOOST_TUNE |\r\nRADIO_2056_TX1, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PGAA_BOOST_TUNE |\r\nRADIO_2056_TX1, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_PGAG_BOOST_TUNE |\r\nRADIO_2056_TX1, 0);\r\nmod_radio_reg(pi,\r\nRADIO_2056_TX_MIXA_BOOST_TUNE |\r\nRADIO_2056_TX1, 0xf0, 0);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_MIXG_BOOST_TUNE |\r\nRADIO_2056_TX1, 0);\r\npi->radio_is_on = false;\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 8)) {\r\nand_phy_reg(pi, 0x78, ~RFCC_CHIP0_PU);\r\npi->radio_is_on = false;\r\n}\r\n}\r\n}\r\nstatic bool\r\nwlc_phy_chan2freq_nphy(struct brcms_phy *pi, uint channel, int *f,\r\nconst struct chan_info_nphy_radio2057 **t0,\r\nconst struct chan_info_nphy_radio205x **t1,\r\nconst struct chan_info_nphy_radio2057_rev5 **t2,\r\nconst struct chan_info_nphy_2055 **t3)\r\n{\r\nuint i;\r\nconst struct chan_info_nphy_radio2057 *chan_info_tbl_p_0 = NULL;\r\nconst struct chan_info_nphy_radio205x *chan_info_tbl_p_1 = NULL;\r\nconst struct chan_info_nphy_radio2057_rev5 *chan_info_tbl_p_2 = NULL;\r\nu32 tbl_len = 0;\r\nint freq = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)) {\r\nchan_info_tbl_p_0 = chan_info_nphyrev7_2057_rev4;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev7_2057_rev4);\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 8)\r\n|| NREV_IS(pi->pubpi.phy_rev, 9)) {\r\nswitch (pi->pubpi.radiorev) {\r\ncase 5:\r\nif (pi->pubpi.radiover == 0x0) {\r\nchan_info_tbl_p_2 =\r\nchan_info_nphyrev8_2057_rev5;\r\ntbl_len = ARRAY_SIZE(\r\nchan_info_nphyrev8_2057_rev5);\r\n} else if (pi->pubpi.radiover == 0x1) {\r\nchan_info_tbl_p_2 =\r\nchan_info_nphyrev9_2057_rev5v1;\r\ntbl_len = ARRAY_SIZE(\r\nchan_info_nphyrev9_2057_rev5v1);\r\n}\r\nbreak;\r\ncase 7:\r\nchan_info_tbl_p_0 =\r\nchan_info_nphyrev8_2057_rev7;\r\ntbl_len = ARRAY_SIZE(\r\nchan_info_nphyrev8_2057_rev7);\r\nbreak;\r\ncase 8:\r\nchan_info_tbl_p_0 =\r\nchan_info_nphyrev8_2057_rev8;\r\ntbl_len = ARRAY_SIZE(\r\nchan_info_nphyrev8_2057_rev8);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 16)) {\r\nchan_info_tbl_p_0 = chan_info_nphyrev8_2057_rev8;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev8_2057_rev8);\r\n} else {\r\ngoto fail;\r\n}\r\nfor (i = 0; i < tbl_len; i++) {\r\nif (pi->pubpi.radiorev == 5) {\r\nif (chan_info_tbl_p_2[i].chan == channel)\r\nbreak;\r\n} else {\r\nif (chan_info_tbl_p_0[i].chan == channel)\r\nbreak;\r\n}\r\n}\r\nif (i >= tbl_len)\r\ngoto fail;\r\nif (pi->pubpi.radiorev == 5) {\r\n*t2 = &chan_info_tbl_p_2[i];\r\nfreq = chan_info_tbl_p_2[i].freq;\r\n} else {\r\n*t0 = &chan_info_tbl_p_0[i];\r\nfreq = chan_info_tbl_p_0[i].freq;\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 3)) {\r\nchan_info_tbl_p_1 = chan_info_nphyrev3_2056;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev3_2056);\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 4)) {\r\nchan_info_tbl_p_1 = chan_info_nphyrev4_2056_A1;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev4_2056_A1);\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)\r\n|| NREV_IS(pi->pubpi.phy_rev, 6)) {\r\nswitch (pi->pubpi.radiorev) {\r\ncase 5:\r\nchan_info_tbl_p_1 = chan_info_nphyrev5_2056v5;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev5_2056v5);\r\nbreak;\r\ncase 6:\r\nchan_info_tbl_p_1 = chan_info_nphyrev6_2056v6;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev6_2056v6);\r\nbreak;\r\ncase 7:\r\ncase 9:\r\nchan_info_tbl_p_1 = chan_info_nphyrev5n6_2056v7;\r\ntbl_len =\r\nARRAY_SIZE(chan_info_nphyrev5n6_2056v7);\r\nbreak;\r\ncase 8:\r\nchan_info_tbl_p_1 = chan_info_nphyrev6_2056v8;\r\ntbl_len = ARRAY_SIZE(chan_info_nphyrev6_2056v8);\r\nbreak;\r\ncase 11:\r\nchan_info_tbl_p_1 = chan_info_nphyrev6_2056v11;\r\ntbl_len = ARRAY_SIZE(\r\nchan_info_nphyrev6_2056v11);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nfor (i = 0; i < tbl_len; i++) {\r\nif (chan_info_tbl_p_1[i].chan == channel)\r\nbreak;\r\n}\r\nif (i >= tbl_len)\r\ngoto fail;\r\n*t1 = &chan_info_tbl_p_1[i];\r\nfreq = chan_info_tbl_p_1[i].freq;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(chan_info_nphy_2055); i++)\r\nif (chan_info_nphy_2055[i].chan == channel)\r\nbreak;\r\nif (i >= ARRAY_SIZE(chan_info_nphy_2055))\r\ngoto fail;\r\n*t3 = &chan_info_nphy_2055[i];\r\nfreq = chan_info_nphy_2055[i].freq;\r\n}\r\n*f = freq;\r\nreturn true;\r\nfail:\r\n*f = WL_CHAN_FREQ_RANGE_2G;\r\nreturn false;\r\n}\r\nu8 wlc_phy_get_chan_freq_range_nphy(struct brcms_phy *pi, uint channel)\r\n{\r\nint freq;\r\nconst struct chan_info_nphy_radio2057 *t0 = NULL;\r\nconst struct chan_info_nphy_radio205x *t1 = NULL;\r\nconst struct chan_info_nphy_radio2057_rev5 *t2 = NULL;\r\nconst struct chan_info_nphy_2055 *t3 = NULL;\r\nif (channel == 0)\r\nchannel = CHSPEC_CHANNEL(pi->radio_chanspec);\r\nwlc_phy_chan2freq_nphy(pi, channel, &freq, &t0, &t1, &t2, &t3);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nreturn WL_CHAN_FREQ_RANGE_2G;\r\nif ((freq >= BASE_LOW_5G_CHAN) && (freq < BASE_MID_5G_CHAN))\r\nreturn WL_CHAN_FREQ_RANGE_5GL;\r\nelse if ((freq >= BASE_MID_5G_CHAN) && (freq < BASE_HIGH_5G_CHAN))\r\nreturn WL_CHAN_FREQ_RANGE_5GM;\r\nelse\r\nreturn WL_CHAN_FREQ_RANGE_5GH;\r\n}\r\nstatic void\r\nwlc_phy_chanspec_radio2055_setup(struct brcms_phy *pi,\r\nconst struct chan_info_nphy_2055 *ci)\r\n{\r\nwrite_radio_reg(pi, RADIO_2055_PLL_REF, ci->RF_pll_ref);\r\nwrite_radio_reg(pi, RADIO_2055_RF_PLL_MOD0, ci->RF_rf_pll_mod0);\r\nwrite_radio_reg(pi, RADIO_2055_RF_PLL_MOD1, ci->RF_rf_pll_mod1);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAP_TAIL, ci->RF_vco_cap_tail);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAL1, ci->RF_vco_cal1);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAL2, ci->RF_vco_cal2);\r\nwrite_radio_reg(pi, RADIO_2055_PLL_LF_C1, ci->RF_pll_lf_c1);\r\nwrite_radio_reg(pi, RADIO_2055_PLL_LF_R1, ci->RF_pll_lf_r1);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_PLL_LF_C2, ci->RF_pll_lf_c2);\r\nwrite_radio_reg(pi, RADIO_2055_LGBUF_CEN_BUF, ci->RF_lgbuf_cen_buf);\r\nwrite_radio_reg(pi, RADIO_2055_LGEN_TUNE1, ci->RF_lgen_tune1);\r\nwrite_radio_reg(pi, RADIO_2055_LGEN_TUNE2, ci->RF_lgen_tune2);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_LGBUF_A_TUNE,\r\nci->RF_core1_lgbuf_a_tune);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_LGBUF_G_TUNE,\r\nci->RF_core1_lgbuf_g_tune);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_RXRF_REG1, ci->RF_core1_rxrf_reg1);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_PGA_PAD_TN,\r\nci->RF_core1_tx_pga_pad_tn);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TX_MX_BGTRIM,\r\nci->RF_core1_tx_mx_bgtrim);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_LGBUF_A_TUNE,\r\nci->RF_core2_lgbuf_a_tune);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_LGBUF_G_TUNE,\r\nci->RF_core2_lgbuf_g_tune);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_RXRF_REG1, ci->RF_core2_rxrf_reg1);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_PGA_PAD_TN,\r\nci->RF_core2_tx_pga_pad_tn);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TX_MX_BGTRIM,\r\nci->RF_core2_tx_mx_bgtrim);\r\nudelay(50);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAL10, 0x05);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAL10, 0x45);\r\nBRCMS_PHY_WAR_PR51571(pi);\r\nwrite_radio_reg(pi, RADIO_2055_VCO_CAL10, 0x65);\r\nudelay(300);\r\n}\r\nstatic void\r\nwlc_phy_chanspec_radio2056_setup(struct brcms_phy *pi,\r\nconst struct chan_info_nphy_radio205x *ci)\r\n{\r\nconst struct radio_regs *regs_SYN_2056_ptr = NULL;\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_VCOCAL1 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_vcocal1);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_VCOCAL2 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_vcocal2);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_REFDIV | RADIO_2056_SYN,\r\nci->RF_SYN_pll_refdiv);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MMD2 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_mmd2);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MMD1 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_mmd1);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER1 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_loopfilter1);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER2 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_loopfilter2);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER3 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_loopfilter3);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER4 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_loopfilter4);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER5 | RADIO_2056_SYN,\r\nci->RF_SYN_pll_loopfilter5);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RESERVED_ADDR27 | RADIO_2056_SYN,\r\nci->RF_SYN_reserved_addr27);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RESERVED_ADDR28 | RADIO_2056_SYN,\r\nci->RF_SYN_reserved_addr28);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_RESERVED_ADDR29 | RADIO_2056_SYN,\r\nci->RF_SYN_reserved_addr29);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_LOGEN_VCOBUF1 | RADIO_2056_SYN,\r\nci->RF_SYN_logen_VCOBUF1);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_LOGEN_MIXER2 | RADIO_2056_SYN,\r\nci->RF_SYN_logen_MIXER2);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_LOGEN_BUF3 | RADIO_2056_SYN,\r\nci->RF_SYN_logen_BUF3);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_LOGEN_BUF4 | RADIO_2056_SYN,\r\nci->RF_SYN_logen_BUF4);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_TUNE | RADIO_2056_RX0,\r\nci->RF_RX0_lnaa_tune);\r\nwrite_radio_reg(pi, RADIO_2056_RX_LNAG_TUNE | RADIO_2056_RX0,\r\nci->RF_RX0_lnag_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_INTPAA_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_intpaa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_INTPAG_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_intpag_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PADA_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_pada_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PADG_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_padg_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PGAA_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_pgaa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PGAG_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_pgag_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_MIXA_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_mixa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_MIXG_BOOST_TUNE | RADIO_2056_TX0,\r\nci->RF_TX0_mixg_boost_tune);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_TUNE | RADIO_2056_RX1,\r\nci->RF_RX1_lnaa_tune);\r\nwrite_radio_reg(pi, RADIO_2056_RX_LNAG_TUNE | RADIO_2056_RX1,\r\nci->RF_RX1_lnag_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_INTPAA_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_intpaa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_INTPAG_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_intpag_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PADA_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_pada_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PADG_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_padg_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PGAA_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_pgaa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_PGAG_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_pgag_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_MIXA_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_mixa_boost_tune);\r\nwrite_radio_reg(pi, RADIO_2056_TX_MIXG_BOOST_TUNE | RADIO_2056_TX1,\r\nci->RF_TX1_mixg_boost_tune);\r\nif (NREV_IS(pi->pubpi.phy_rev, 3))\r\nregs_SYN_2056_ptr = regs_SYN_2056;\r\nelse if (NREV_IS(pi->pubpi.phy_rev, 4))\r\nregs_SYN_2056_ptr = regs_SYN_2056_A1;\r\nelse {\r\nswitch (pi->pubpi.radiorev) {\r\ncase 5:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev5;\r\nbreak;\r\ncase 6:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev6;\r\nbreak;\r\ncase 7:\r\ncase 9:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev7;\r\nbreak;\r\ncase 8:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev8;\r\nbreak;\r\ncase 11:\r\nregs_SYN_2056_ptr = regs_SYN_2056_rev11;\r\nbreak;\r\n}\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_CP2 |\r\nRADIO_2056_SYN,\r\n(u16) regs_SYN_2056_ptr[0x49 - 2].init_g);\r\nelse\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_CP2 |\r\nRADIO_2056_SYN,\r\n(u16) regs_SYN_2056_ptr[0x49 - 2].init_a);\r\nif (pi->sh->boardflags2 & BFL2_GPLL_WAR) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER1 |\r\nRADIO_2056_SYN, 0x1f);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER2 |\r\nRADIO_2056_SYN, 0x1f);\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM4716) ||\r\n(pi->sh->chip == BCMA_CHIP_ID_BCM47162)) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_LOOPFILTER4 |\r\nRADIO_2056_SYN, 0x14);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_CP2 |\r\nRADIO_2056_SYN, 0x00);\r\n} else {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_LOOPFILTER4 |\r\nRADIO_2056_SYN, 0xb);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_CP2 |\r\nRADIO_2056_SYN, 0x14);\r\n}\r\n}\r\n}\r\nif ((pi->sh->boardflags2 & BFL2_GPLL_WAR2) &&\r\n(CHSPEC_IS2G(pi->radio_chanspec))) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_LOOPFILTER1 | RADIO_2056_SYN,\r\n0x1f);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_LOOPFILTER2 | RADIO_2056_SYN,\r\n0x1f);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_SYN_PLL_LOOPFILTER4 | RADIO_2056_SYN,\r\n0xb);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_CP2 | RADIO_2056_SYN,\r\n0x20);\r\n}\r\nif (pi->sh->boardflags2 & BFL2_APLL_WAR) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER1 |\r\nRADIO_2056_SYN, 0x1f);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER2 |\r\nRADIO_2056_SYN, 0x1f);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_LOOPFILTER4 |\r\nRADIO_2056_SYN, 0x5);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_CP2 |\r\nRADIO_2056_SYN, 0xc);\r\n}\r\n}\r\nif (PHY_IPA(pi) && CHSPEC_IS2G(pi->radio_chanspec)) {\r\nu16 pag_boost_tune;\r\nu16 padg_boost_tune;\r\nu16 pgag_boost_tune;\r\nu16 mixg_boost_tune;\r\nu16 bias, cascbias;\r\nuint core;\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 5)) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPADG_IDAC, 0xcc);\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM4716) ||\r\n(pi->sh->chip == BCMA_CHIP_ID_BCM47162)) {\r\nbias = 0x40;\r\ncascbias = 0x45;\r\npag_boost_tune = 0x5;\r\npgag_boost_tune = 0x33;\r\npadg_boost_tune = 0x77;\r\nmixg_boost_tune = 0x55;\r\n} else {\r\nbias = 0x25;\r\ncascbias = 0x20;\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM43224 ||\r\npi->sh->chip == BCMA_CHIP_ID_BCM43225) &&\r\npi->sh->chippkg == BCMA_PKG_ID_BCM43224_FAB_SMIC) {\r\nbias = 0x2a;\r\ncascbias = 0x38;\r\n}\r\npag_boost_tune = 0x4;\r\npgag_boost_tune = 0x03;\r\npadg_boost_tune = 0x77;\r\nmixg_boost_tune = 0x65;\r\n}\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_IMAIN_STAT, bias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_IAUX_STAT, bias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_CASCBIAS, cascbias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_BOOST_TUNE,\r\npag_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPGAG_BOOST_TUNE,\r\npgag_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPADG_BOOST_TUNE,\r\npadg_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nMIXG_BOOST_TUNE,\r\nmixg_boost_tune);\r\n} else {\r\nbias = (pi->bw == WL_CHANSPEC_BW_40) ?\r\n0x40 : 0x20;\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_IMAIN_STAT, bias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_IAUX_STAT, bias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_CASCBIAS, 0x30);\r\n}\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core, PA_SPARE1,\r\n0xee);\r\n}\r\n}\r\nif (PHY_IPA(pi) && NREV_IS(pi->pubpi.phy_rev, 6)\r\n&& CHSPEC_IS5G(pi->radio_chanspec)) {\r\nu16 paa_boost_tune;\r\nu16 pada_boost_tune;\r\nu16 pgaa_boost_tune;\r\nu16 mixa_boost_tune;\r\nu16 freq, pabias, cascbias;\r\nuint core;\r\nfreq = CHAN5G_FREQ(CHSPEC_CHANNEL(pi->radio_chanspec));\r\nif (freq < 5150) {\r\npaa_boost_tune = 0xa;\r\npada_boost_tune = 0x77;\r\npgaa_boost_tune = 0xf;\r\nmixa_boost_tune = 0xf;\r\n} else if (freq < 5340) {\r\npaa_boost_tune = 0x8;\r\npada_boost_tune = 0x77;\r\npgaa_boost_tune = 0xfb;\r\nmixa_boost_tune = 0xf;\r\n} else if (freq < 5650) {\r\npaa_boost_tune = 0x0;\r\npada_boost_tune = 0x77;\r\npgaa_boost_tune = 0xb;\r\nmixa_boost_tune = 0xf;\r\n} else {\r\npaa_boost_tune = 0x0;\r\npada_boost_tune = 0x77;\r\nif (freq != 5825)\r\npgaa_boost_tune = -(int)(freq - 18) / 36 + 168;\r\nelse\r\npgaa_boost_tune = 6;\r\nmixa_boost_tune = 0xf;\r\n}\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_BOOST_TUNE, paa_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPADA_BOOST_TUNE, pada_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPGAA_BOOST_TUNE, pgaa_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nMIXA_BOOST_TUNE, mixa_boost_tune);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nTXSPARE1, 0x30);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPA_SPARE2, 0xee);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nPADA_CASCBIAS, 0x3);\r\ncascbias = 0x30;\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM43224 ||\r\npi->sh->chip == BCMA_CHIP_ID_BCM43225) &&\r\npi->sh->chippkg == BCMA_PKG_ID_BCM43224_FAB_SMIC)\r\ncascbias = 0x35;\r\npabias = (pi->phy_pabias == 0) ? 0x30 : pi->phy_pabias;\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_IAUX_STAT, pabias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_IMAIN_STAT, pabias);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_CASCBIAS, cascbias);\r\n}\r\n}\r\nudelay(50);\r\nwlc_phy_radio205x_vcocal_nphy(pi);\r\n}\r\nvoid wlc_phy_radio205x_vcocal_nphy(struct brcms_phy *pi)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_EN, 0x01, 0x0);\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_CAL_RESETN, 0x04, 0x0);\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_CAL_RESETN, 0x04,\r\n(1 << 2));\r\nmod_radio_reg(pi, RADIO_2057_RFPLL_MISC_EN, 0x01, 0x01);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_VCOCAL12, 0x0);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST3, 0x38);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST3, 0x18);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST3, 0x38);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_PLL_MAST3, 0x39);\r\n}\r\nudelay(300);\r\n}\r\nstatic void\r\nwlc_phy_chanspec_radio2057_setup(\r\nstruct brcms_phy *pi,\r\nconst struct chan_info_nphy_radio2057 *ci,\r\nconst struct chan_info_nphy_radio2057_rev5 *\r\nci2)\r\n{\r\nint coreNum;\r\nu16 txmix2g_tune_boost_pu = 0;\r\nu16 pad2g_tune_pus = 0;\r\nif (pi->pubpi.radiorev == 5) {\r\nwrite_radio_reg(pi,\r\nRADIO_2057_VCOCAL_COUNTVAL0,\r\nci2->RF_vcocal_countval0);\r\nwrite_radio_reg(pi, RADIO_2057_VCOCAL_COUNTVAL1,\r\nci2->RF_vcocal_countval1);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_REFMASTER_SPAREXTALSIZE,\r\nci2->RF_rfpll_refmaster_sparextalsize);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\nci2->RF_rfpll_loopfilter_r1);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\nci2->RF_rfpll_loopfilter_c2);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\nci2->RF_rfpll_loopfilter_c1);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC,\r\nci2->RF_cp_kpd_idac);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_MMD0, ci2->RF_rfpll_mmd0);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_MMD1, ci2->RF_rfpll_mmd1);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_VCOBUF_TUNE, ci2->RF_vcobuf_tune);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_LOGEN_MX2G_TUNE,\r\nci2->RF_logen_mx2g_tune);\r\nwrite_radio_reg(pi, RADIO_2057_LOGEN_INDBUF2G_TUNE,\r\nci2->RF_logen_indbuf2g_tune);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TXMIX2G_TUNE_BOOST_PU_CORE0,\r\nci2->RF_txmix2g_tune_boost_pu_core0);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE0,\r\nci2->RF_pad2g_tune_pus_core0);\r\nwrite_radio_reg(pi, RADIO_2057_LNA2G_TUNE_CORE0,\r\nci2->RF_lna2g_tune_core0);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TXMIX2G_TUNE_BOOST_PU_CORE1,\r\nci2->RF_txmix2g_tune_boost_pu_core1);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE1,\r\nci2->RF_pad2g_tune_pus_core1);\r\nwrite_radio_reg(pi, RADIO_2057_LNA2G_TUNE_CORE1,\r\nci2->RF_lna2g_tune_core1);\r\n} else {\r\nwrite_radio_reg(pi,\r\nRADIO_2057_VCOCAL_COUNTVAL0,\r\nci->RF_vcocal_countval0);\r\nwrite_radio_reg(pi, RADIO_2057_VCOCAL_COUNTVAL1,\r\nci->RF_vcocal_countval1);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_REFMASTER_SPAREXTALSIZE,\r\nci->RF_rfpll_refmaster_sparextalsize);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\nci->RF_rfpll_loopfilter_r1);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\nci->RF_rfpll_loopfilter_c2);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\nci->RF_rfpll_loopfilter_c1);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC, ci->RF_cp_kpd_idac);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_MMD0, ci->RF_rfpll_mmd0);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_MMD1, ci->RF_rfpll_mmd1);\r\nwrite_radio_reg(pi, RADIO_2057_VCOBUF_TUNE, ci->RF_vcobuf_tune);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_LOGEN_MX2G_TUNE,\r\nci->RF_logen_mx2g_tune);\r\nwrite_radio_reg(pi, RADIO_2057_LOGEN_MX5G_TUNE,\r\nci->RF_logen_mx5g_tune);\r\nwrite_radio_reg(pi, RADIO_2057_LOGEN_INDBUF2G_TUNE,\r\nci->RF_logen_indbuf2g_tune);\r\nwrite_radio_reg(pi, RADIO_2057_LOGEN_INDBUF5G_TUNE,\r\nci->RF_logen_indbuf5g_tune);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TXMIX2G_TUNE_BOOST_PU_CORE0,\r\nci->RF_txmix2g_tune_boost_pu_core0);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE0,\r\nci->RF_pad2g_tune_pus_core0);\r\nwrite_radio_reg(pi, RADIO_2057_PGA_BOOST_TUNE_CORE0,\r\nci->RF_pga_boost_tune_core0);\r\nwrite_radio_reg(pi, RADIO_2057_TXMIX5G_BOOST_TUNE_CORE0,\r\nci->RF_txmix5g_boost_tune_core0);\r\nwrite_radio_reg(pi, RADIO_2057_PAD5G_TUNE_MISC_PUS_CORE0,\r\nci->RF_pad5g_tune_misc_pus_core0);\r\nwrite_radio_reg(pi, RADIO_2057_LNA2G_TUNE_CORE0,\r\nci->RF_lna2g_tune_core0);\r\nwrite_radio_reg(pi, RADIO_2057_LNA5G_TUNE_CORE0,\r\nci->RF_lna5g_tune_core0);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TXMIX2G_TUNE_BOOST_PU_CORE1,\r\nci->RF_txmix2g_tune_boost_pu_core1);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE1,\r\nci->RF_pad2g_tune_pus_core1);\r\nwrite_radio_reg(pi, RADIO_2057_PGA_BOOST_TUNE_CORE1,\r\nci->RF_pga_boost_tune_core1);\r\nwrite_radio_reg(pi, RADIO_2057_TXMIX5G_BOOST_TUNE_CORE1,\r\nci->RF_txmix5g_boost_tune_core1);\r\nwrite_radio_reg(pi, RADIO_2057_PAD5G_TUNE_MISC_PUS_CORE1,\r\nci->RF_pad5g_tune_misc_pus_core1);\r\nwrite_radio_reg(pi, RADIO_2057_LNA2G_TUNE_CORE1,\r\nci->RF_lna2g_tune_core1);\r\nwrite_radio_reg(pi, RADIO_2057_LNA5G_TUNE_CORE1,\r\nci->RF_lna5g_tune_core1);\r\n}\r\nif ((pi->pubpi.radiorev <= 4) || (pi->pubpi.radiorev == 6)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\n0x3f);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC, 0x3f);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\n0x8);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\n0x8);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\n0x1f);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC, 0x3f);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\n0x8);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\n0x8);\r\n}\r\n} else if ((pi->pubpi.radiorev == 5) || (pi->pubpi.radiorev == 7) ||\r\n(pi->pubpi.radiorev == 8)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\n0x1b);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC, 0x30);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\n0xa);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\n0xa);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_R1,\r\n0x1f);\r\nwrite_radio_reg(pi, RADIO_2057_CP_KPD_IDAC, 0x3f);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C1,\r\n0x8);\r\nwrite_radio_reg(pi, RADIO_2057_RFPLL_LOOPFILTER_C2,\r\n0x8);\r\n}\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (PHY_IPA(pi)) {\r\nif (pi->pubpi.radiorev == 3)\r\ntxmix2g_tune_boost_pu = 0x6b;\r\nif (pi->pubpi.radiorev == 5)\r\npad2g_tune_pus = 0x73;\r\n} else {\r\nif (pi->pubpi.radiorev != 5) {\r\npad2g_tune_pus = 0x3;\r\ntxmix2g_tune_boost_pu = 0x61;\r\n}\r\n}\r\nfor (coreNum = 0; coreNum <= 1; coreNum++) {\r\nif (txmix2g_tune_boost_pu != 0)\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE, coreNum,\r\nTXMIX2G_TUNE_BOOST_PU,\r\ntxmix2g_tune_boost_pu);\r\nif (pad2g_tune_pus != 0)\r\nWRITE_RADIO_REG4(pi, RADIO_2057, CORE, coreNum,\r\nPAD2G_TUNE_PUS,\r\npad2g_tune_pus);\r\n}\r\n}\r\nudelay(50);\r\nwlc_phy_radio205x_vcocal_nphy(pi);\r\n}\r\nstatic void\r\nwlc_phy_chanspec_nphy_setup(struct brcms_phy *pi, u16 chanspec,\r\nconst struct nphy_sfo_cfg *ci)\r\n{\r\nu16 val;\r\nval = read_phy_reg(pi, 0x09) & NPHY_BandControl_currentBand;\r\nif (CHSPEC_IS5G(chanspec) && !val) {\r\nval = bcma_read16(pi->d11core, D11REGOFFS(psm_phy_hdr_param));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param),\r\n(val | MAC_PHY_FORCE_CLK));\r\nor_phy_reg(pi, (NPHY_TO_BPHY_OFF + BPHY_BB_CONFIG),\r\n(BBCFG_RESETCCA | BBCFG_RESETRX));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), val);\r\nor_phy_reg(pi, 0x09, NPHY_BandControl_currentBand);\r\n} else if (!CHSPEC_IS5G(chanspec) && val) {\r\nand_phy_reg(pi, 0x09, ~NPHY_BandControl_currentBand);\r\nval = bcma_read16(pi->d11core, D11REGOFFS(psm_phy_hdr_param));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param),\r\n(val | MAC_PHY_FORCE_CLK));\r\nand_phy_reg(pi, (NPHY_TO_BPHY_OFF + BPHY_BB_CONFIG),\r\n(u16) (~(BBCFG_RESETCCA | BBCFG_RESETRX)));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), val);\r\n}\r\nwrite_phy_reg(pi, 0x1ce, ci->PHY_BW1a);\r\nwrite_phy_reg(pi, 0x1cf, ci->PHY_BW2);\r\nwrite_phy_reg(pi, 0x1d0, ci->PHY_BW3);\r\nwrite_phy_reg(pi, 0x1d1, ci->PHY_BW4);\r\nwrite_phy_reg(pi, 0x1d2, ci->PHY_BW5);\r\nwrite_phy_reg(pi, 0x1d3, ci->PHY_BW6);\r\nif (CHSPEC_CHANNEL(pi->radio_chanspec) == 14) {\r\nwlc_phy_classifier_nphy(pi, NPHY_ClassifierCtrl_ofdm_en, 0);\r\nor_phy_reg(pi, NPHY_TO_BPHY_OFF + BPHY_TEST, 0x800);\r\n} else {\r\nwlc_phy_classifier_nphy(pi, NPHY_ClassifierCtrl_ofdm_en,\r\nNPHY_ClassifierCtrl_ofdm_en);\r\nif (CHSPEC_IS2G(chanspec))\r\nand_phy_reg(pi, NPHY_TO_BPHY_OFF + BPHY_TEST, ~0x840);\r\n}\r\nif (pi->nphy_txpwrctrl == PHY_TPC_HW_OFF)\r\nwlc_phy_txpwr_fixpower_nphy(pi);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\nwlc_phy_adjust_lnagaintbl_nphy(pi);\r\nwlc_phy_txlpfbw_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)\r\n&& (pi->phy_spuravoid != SPURAVOID_DISABLE)) {\r\nu8 spuravoid = 0;\r\nval = CHSPEC_CHANNEL(chanspec);\r\nif (!CHSPEC_IS40(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif ((val == 13) || (val == 14) || (val == 153))\r\nspuravoid = 1;\r\n} else if (((val >= 5) && (val <= 8)) || (val == 13)\r\n|| (val == 14)) {\r\nspuravoid = 1;\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (val == 54)\r\nspuravoid = 1;\r\n} else if (pi->nphy_aband_spurwar_en &&\r\n((val == 38) || (val == 102) || (val == 118))) {\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM4716)\r\n&& (pi->sh->chippkg == BCMA_PKG_ID_BCM4717)) {\r\nspuravoid = 0;\r\n} else {\r\nspuravoid = 1;\r\n}\r\n}\r\nif (pi->phy_spuravoid == SPURAVOID_FORCEON)\r\nspuravoid = 1;\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM4716) ||\r\n(pi->sh->chip == BCMA_CHIP_ID_BCM43225)) {\r\nbcma_pmu_spuravoid_pllupdate(&pi->d11core->bus->drv_cc,\r\nspuravoid);\r\n} else {\r\nwlapi_bmac_core_phypll_ctl(pi->sh->physhim, false);\r\nbcma_pmu_spuravoid_pllupdate(&pi->d11core->bus->drv_cc,\r\nspuravoid);\r\nwlapi_bmac_core_phypll_ctl(pi->sh->physhim, true);\r\n}\r\nif ((pi->sh->chip == BCMA_CHIP_ID_BCM43224) ||\r\n(pi->sh->chip == BCMA_CHIP_ID_BCM43225)) {\r\nif (spuravoid == 1) {\r\nbcma_write16(pi->d11core,\r\nD11REGOFFS(tsf_clk_frac_l),\r\n0x5341);\r\nbcma_write16(pi->d11core,\r\nD11REGOFFS(tsf_clk_frac_h), 0x8);\r\n} else {\r\nbcma_write16(pi->d11core,\r\nD11REGOFFS(tsf_clk_frac_l),\r\n0x8889);\r\nbcma_write16(pi->d11core,\r\nD11REGOFFS(tsf_clk_frac_h), 0x8);\r\n}\r\n}\r\nif (!((pi->sh->chip == BCMA_CHIP_ID_BCM4716) ||\r\n(pi->sh->chip == BCMA_CHIP_ID_BCM47162)))\r\nwlapi_bmac_core_phypll_reset(pi->sh->physhim);\r\nmod_phy_reg(pi, 0x01, (0x1 << 15),\r\n((spuravoid > 0) ? (0x1 << 15) : 0));\r\nwlc_phy_resetcca_nphy(pi);\r\npi->phy_isspuravoid = (spuravoid > 0);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 7))\r\nwrite_phy_reg(pi, 0x17e, 0x3830);\r\nwlc_phy_spurwar_nphy(pi);\r\n}\r\nvoid wlc_phy_chanspec_set_nphy(struct brcms_phy *pi, u16 chanspec)\r\n{\r\nint freq;\r\nconst struct chan_info_nphy_radio2057 *t0 = NULL;\r\nconst struct chan_info_nphy_radio205x *t1 = NULL;\r\nconst struct chan_info_nphy_radio2057_rev5 *t2 = NULL;\r\nconst struct chan_info_nphy_2055 *t3 = NULL;\r\nif (!wlc_phy_chan2freq_nphy\r\n(pi, CHSPEC_CHANNEL(chanspec), &freq, &t0, &t1, &t2, &t3))\r\nreturn;\r\nwlc_phy_chanspec_radio_set((struct brcms_phy_pub *) pi, chanspec);\r\nif (CHSPEC_BW(chanspec) != pi->bw)\r\nwlapi_bmac_bw_set(pi->sh->physhim, CHSPEC_BW(chanspec));\r\nif (CHSPEC_IS40(chanspec)) {\r\nif (CHSPEC_SB_UPPER(chanspec)) {\r\nor_phy_reg(pi, 0xa0, BPHY_BAND_SEL_UP20);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nor_phy_reg(pi, 0x310, PRIM_SEL_UP20);\r\n} else {\r\nand_phy_reg(pi, 0xa0, ~BPHY_BAND_SEL_UP20);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nand_phy_reg(pi, 0x310,\r\n(~PRIM_SEL_UP20 & 0xffff));\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif ((pi->pubpi.radiorev <= 4)\r\n|| (pi->pubpi.radiorev == 6)) {\r\nmod_radio_reg(pi, RADIO_2057_TIA_CONFIG_CORE0,\r\n0x2,\r\n(CHSPEC_IS5G(chanspec) ? (1 << 1)\r\n: 0));\r\nmod_radio_reg(pi, RADIO_2057_TIA_CONFIG_CORE1,\r\n0x2,\r\n(CHSPEC_IS5G(chanspec) ? (1 << 1)\r\n: 0));\r\n}\r\nwlc_phy_chanspec_radio2057_setup(pi, t0, t2);\r\nwlc_phy_chanspec_nphy_setup(pi, chanspec,\r\n(pi->pubpi.radiorev == 5) ?\r\n(const struct nphy_sfo_cfg *)&(t2->PHY_BW1a) :\r\n(const struct nphy_sfo_cfg *)&(t0->PHY_BW1a));\r\n} else {\r\nmod_radio_reg(pi,\r\nRADIO_2056_SYN_COM_CTRL | RADIO_2056_SYN,\r\n0x4,\r\n(CHSPEC_IS5G(chanspec) ? (0x1 << 2) : 0));\r\nwlc_phy_chanspec_radio2056_setup(pi, t1);\r\nwlc_phy_chanspec_nphy_setup(pi, chanspec,\r\n(const struct nphy_sfo_cfg *) &(t1->PHY_BW1a));\r\n}\r\n} else {\r\nmod_radio_reg(pi, RADIO_2055_MASTER_CNTRL1, 0x70,\r\n(CHSPEC_IS5G(chanspec) ? (0x02 << 4)\r\n: (0x05 << 4)));\r\nwlc_phy_chanspec_radio2055_setup(pi, t3);\r\nwlc_phy_chanspec_nphy_setup(pi, chanspec,\r\n(const struct nphy_sfo_cfg *)\r\n&(t3->PHY_BW1a));\r\n}\r\n}\r\nvoid wlc_phy_antsel_init(struct brcms_phy_pub *ppi, bool lut_init)\r\n{\r\nstruct brcms_phy *pi = container_of(ppi, struct brcms_phy, pubpi_ro);\r\nu16 mask = 0xfc00;\r\nu32 mc = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nreturn;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nu16 v0 = 0x211, v1 = 0x222, v2 = 0x144, v3 = 0x188;\r\nif (!lut_init)\r\nreturn;\r\nif (pi->srom_fem2g.antswctrllut == 0) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x02, 16, &v0);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x03, 16, &v1);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x08, 16, &v2);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x0C, 16, &v3);\r\n}\r\nif (pi->srom_fem5g.antswctrllut == 0) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x12, 16, &v0);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x13, 16, &v1);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x18, 16, &v2);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_ANTSWCTRLLUT,\r\n1, 0x1C, 16, &v3);\r\n}\r\n} else {\r\nwrite_phy_reg(pi, 0xc8, 0x0);\r\nwrite_phy_reg(pi, 0xc9, 0x0);\r\nbcma_chipco_gpio_control(&pi->d11core->bus->drv_cc, mask, mask);\r\nmc = bcma_read32(pi->d11core, D11REGOFFS(maccontrol));\r\nmc &= ~MCTL_GPOUT_SEL_MASK;\r\nbcma_write32(pi->d11core, D11REGOFFS(maccontrol), mc);\r\nbcma_set16(pi->d11core, D11REGOFFS(psm_gpio_oe), mask);\r\nbcma_mask16(pi->d11core, D11REGOFFS(psm_gpio_out), ~mask);\r\nif (lut_init) {\r\nwrite_phy_reg(pi, 0xf8, 0x02d8);\r\nwrite_phy_reg(pi, 0xf9, 0x0301);\r\nwrite_phy_reg(pi, 0xfa, 0x02d8);\r\nwrite_phy_reg(pi, 0xfb, 0x0301);\r\n}\r\n}\r\n}\r\nu16 wlc_phy_classifier_nphy(struct brcms_phy *pi, u16 mask, u16 val)\r\n{\r\nu16 curr_ctl, new_ctl;\r\nbool suspended = false;\r\nif (D11REV_IS(pi->sh->corerev, 16)) {\r\nsuspended = (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC) ? false : true;\r\nif (!suspended)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\n}\r\ncurr_ctl = read_phy_reg(pi, 0xb0) & (0x7 << 0);\r\nnew_ctl = (curr_ctl & (~mask)) | (val & mask);\r\nmod_phy_reg(pi, 0xb0, (0x7 << 0), new_ctl);\r\nif (D11REV_IS(pi->sh->corerev, 16) && !suspended)\r\nwlapi_enable_mac(pi->sh->physhim);\r\nreturn new_ctl;\r\n}\r\nvoid wlc_phy_force_rfseq_nphy(struct brcms_phy *pi, u8 cmd)\r\n{\r\nu16 trigger_mask, status_mask;\r\nu16 orig_RfseqCoreActv;\r\nswitch (cmd) {\r\ncase NPHY_RFSEQ_RX2TX:\r\ntrigger_mask = NPHY_RfseqTrigger_rx2tx;\r\nstatus_mask = NPHY_RfseqStatus_rx2tx;\r\nbreak;\r\ncase NPHY_RFSEQ_TX2RX:\r\ntrigger_mask = NPHY_RfseqTrigger_tx2rx;\r\nstatus_mask = NPHY_RfseqStatus_tx2rx;\r\nbreak;\r\ncase NPHY_RFSEQ_RESET2RX:\r\ntrigger_mask = NPHY_RfseqTrigger_reset2rx;\r\nstatus_mask = NPHY_RfseqStatus_reset2rx;\r\nbreak;\r\ncase NPHY_RFSEQ_UPDATEGAINH:\r\ntrigger_mask = NPHY_RfseqTrigger_updategainh;\r\nstatus_mask = NPHY_RfseqStatus_updategainh;\r\nbreak;\r\ncase NPHY_RFSEQ_UPDATEGAINL:\r\ntrigger_mask = NPHY_RfseqTrigger_updategainl;\r\nstatus_mask = NPHY_RfseqStatus_updategainl;\r\nbreak;\r\ncase NPHY_RFSEQ_UPDATEGAINU:\r\ntrigger_mask = NPHY_RfseqTrigger_updategainu;\r\nstatus_mask = NPHY_RfseqStatus_updategainu;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\norig_RfseqCoreActv = read_phy_reg(pi, 0xa1);\r\nor_phy_reg(pi, 0xa1,\r\n(NPHY_RfseqMode_CoreActv_override |\r\nNPHY_RfseqMode_Trigger_override));\r\nor_phy_reg(pi, 0xa3, trigger_mask);\r\nSPINWAIT((read_phy_reg(pi, 0xa4) & status_mask), 200000);\r\nwrite_phy_reg(pi, 0xa1, orig_RfseqCoreActv);\r\nWARN(read_phy_reg(pi, 0xa4) & status_mask, "HW error in rf");\r\n}\r\nstatic void\r\nwlc_phy_rfctrl_override_1tomany_nphy(struct brcms_phy *pi, u16 cmd, u16 value,\r\nu8 core_mask, u8 off)\r\n{\r\nu16 rfmxgain = 0, lpfgain = 0;\r\nu16 tgain = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nswitch (cmd) {\r\ncase NPHY_REV7_RfctrlOverride_cmd_rxrf_pu:\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 5),\r\nvalue, core_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 4), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 3), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nbreak;\r\ncase NPHY_REV7_RfctrlOverride_cmd_rx_pu:\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2),\r\nvalue, core_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 1), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 0), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 1), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 11), 0,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nbreak;\r\ncase NPHY_REV7_RfctrlOverride_cmd_tx_pu:\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2),\r\nvalue, core_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 1), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 0), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2), value,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 11), 1,\r\ncore_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nbreak;\r\ncase NPHY_REV7_RfctrlOverride_cmd_rxgain:\r\nrfmxgain = value & 0x000ff;\r\nlpfgain = value & 0x0ff00;\r\nlpfgain = lpfgain >> 8;\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 11),\r\nrfmxgain, core_mask,\r\noff,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x3 << 13),\r\nlpfgain, core_mask,\r\noff,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nbreak;\r\ncase NPHY_REV7_RfctrlOverride_cmd_txgain:\r\ntgain = value & 0x7fff;\r\nlpfgain = value & 0x8000;\r\nlpfgain = lpfgain >> 14;\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 12),\r\ntgain, core_mask, off,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 13),\r\nlpfgain, core_mask,\r\noff,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_phy_scale_offset_rssi_nphy(struct brcms_phy *pi, u16 scale, s8 offset,\r\nu8 coresel, u8 rail, u8 rssi_type)\r\n{\r\nu16 valuetostuff;\r\noffset = (offset > NPHY_RSSICAL_MAXREAD) ?\r\nNPHY_RSSICAL_MAXREAD : offset;\r\noffset = (offset < (-NPHY_RSSICAL_MAXREAD - 1)) ?\r\n-NPHY_RSSICAL_MAXREAD - 1 : offset;\r\nvaluetostuff = ((scale & 0x3f) << 8) | (offset & 0x3f);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_NB))\r\nwrite_phy_reg(pi, 0x1a6, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_NB))\r\nwrite_phy_reg(pi, 0x1ac, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_NB))\r\nwrite_phy_reg(pi, 0x1b2, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_NB))\r\nwrite_phy_reg(pi, 0x1b8, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_W1))\r\nwrite_phy_reg(pi, 0x1a4, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_W1))\r\nwrite_phy_reg(pi, 0x1aa, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_W1))\r\nwrite_phy_reg(pi, 0x1b0, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_W1))\r\nwrite_phy_reg(pi, 0x1b6, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_W2))\r\nwrite_phy_reg(pi, 0x1a5, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_W2))\r\nwrite_phy_reg(pi, 0x1ab, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_W2))\r\nwrite_phy_reg(pi, 0x1b1, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_W2))\r\nwrite_phy_reg(pi, 0x1b7, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_TBD))\r\nwrite_phy_reg(pi, 0x1a7, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_TBD))\r\nwrite_phy_reg(pi, 0x1ad, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_TBD))\r\nwrite_phy_reg(pi, 0x1b3, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_TBD))\r\nwrite_phy_reg(pi, 0x1b9, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_IQ))\r\nwrite_phy_reg(pi, 0x1a8, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_IQ))\r\nwrite_phy_reg(pi, 0x1ae, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_I) && (rssi_type == NPHY_RSSI_SEL_IQ))\r\nwrite_phy_reg(pi, 0x1b4, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rail == NPHY_RAIL_Q) && (rssi_type == NPHY_RSSI_SEL_IQ))\r\nwrite_phy_reg(pi, 0x1ba, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rssi_type == NPHY_RSSI_SEL_TSSI_2G))\r\nwrite_phy_reg(pi, 0x1a9, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rssi_type == NPHY_RSSI_SEL_TSSI_2G))\r\nwrite_phy_reg(pi, 0x1b5, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE1) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rssi_type == NPHY_RSSI_SEL_TSSI_5G))\r\nwrite_phy_reg(pi, 0x1af, valuetostuff);\r\nif (((coresel == RADIO_MIMO_CORESEL_CORE2) ||\r\n(coresel == RADIO_MIMO_CORESEL_ALLRX)) &&\r\n(rssi_type == NPHY_RSSI_SEL_TSSI_5G))\r\nwrite_phy_reg(pi, 0x1bb, valuetostuff);\r\n}\r\nstatic void brcms_phy_wr_tx_mux(struct brcms_phy *pi, u8 core)\r\n{\r\nif (PHY_IPA(pi)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwrite_radio_reg(pi,\r\n((core == PHY_CORE_0) ?\r\nRADIO_2057_TX0_TX_SSI_MUX :\r\nRADIO_2057_TX1_TX_SSI_MUX),\r\n(CHSPEC_IS5G(pi->radio_chanspec) ?\r\n0xc : 0xe));\r\nelse\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MUX |\r\n((core == PHY_CORE_0) ?\r\nRADIO_2056_TX0 : RADIO_2056_TX1),\r\n(CHSPEC_IS5G(pi->radio_chanspec) ?\r\n0xc : 0xe));\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwrite_radio_reg(pi,\r\n((core == PHY_CORE_0) ?\r\nRADIO_2057_TX0_TX_SSI_MUX :\r\nRADIO_2057_TX1_TX_SSI_MUX),\r\n0x11);\r\nif (pi->pubpi.radioid == BCM2057_ID)\r\nwrite_radio_reg(pi,\r\nRADIO_2057_IQTEST_SEL_PU, 0x1);\r\n} else {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MUX |\r\n((core == PHY_CORE_0) ?\r\nRADIO_2056_TX0 : RADIO_2056_TX1),\r\n0x11);\r\n}\r\n}\r\n}\r\nvoid wlc_phy_rssisel_nphy(struct brcms_phy *pi, u8 core_code, u8 rssi_type)\r\n{\r\nu16 mask, val;\r\nu16 afectrlovr_rssi_val, rfctrlcmd_rxen_val, rfctrlcmd_coresel_val,\r\nstartseq;\r\nu16 rfctrlovr_rssi_val, rfctrlovr_rxen_val, rfctrlovr_coresel_val,\r\nrfctrlovr_trigger_val;\r\nu16 afectrlovr_rssi_mask, rfctrlcmd_mask, rfctrlovr_mask;\r\nu16 rfctrlcmd_val, rfctrlovr_val;\r\nu8 core;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (core_code == RADIO_MIMO_CORESEL_OFF) {\r\nmod_phy_reg(pi, 0x8f, (0x1 << 9), 0);\r\nmod_phy_reg(pi, 0xa5, (0x1 << 9), 0);\r\nmod_phy_reg(pi, 0xa6, (0x3 << 8), 0);\r\nmod_phy_reg(pi, 0xa7, (0x3 << 8), 0);\r\nmod_phy_reg(pi, 0xe5, (0x1 << 5), 0);\r\nmod_phy_reg(pi, 0xe6, (0x1 << 5), 0);\r\nmask = (0x1 << 2) |\r\n(0x1 << 3) | (0x1 << 4) | (0x1 << 5);\r\nmod_phy_reg(pi, 0xf9, mask, 0);\r\nmod_phy_reg(pi, 0xfb, mask, 0);\r\n} else {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (core_code == RADIO_MIMO_CORESEL_CORE1\r\n&& core == PHY_CORE_1)\r\ncontinue;\r\nelse if (core_code == RADIO_MIMO_CORESEL_CORE2\r\n&& core == PHY_CORE_0)\r\ncontinue;\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0x8f : 0xa5, (0x1 << 9), 1 << 9);\r\nif (rssi_type == NPHY_RSSI_SEL_W1 ||\r\nrssi_type == NPHY_RSSI_SEL_W2 ||\r\nrssi_type == NPHY_RSSI_SEL_NB) {\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6 : 0xa7,\r\n(0x3 << 8), 0);\r\nmask = (0x1 << 2) |\r\n(0x1 << 3) |\r\n(0x1 << 4) | (0x1 << 5);\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xf9 : 0xfb,\r\nmask, 0);\r\nif (rssi_type == NPHY_RSSI_SEL_W1) {\r\nif (CHSPEC_IS5G(\r\npi->radio_chanspec)) {\r\nmask = (0x1 << 2);\r\nval = 1 << 2;\r\n} else {\r\nmask = (0x1 << 3);\r\nval = 1 << 3;\r\n}\r\n} else if (rssi_type ==\r\nNPHY_RSSI_SEL_W2) {\r\nmask = (0x1 << 4);\r\nval = 1 << 4;\r\n} else {\r\nmask = (0x1 << 5);\r\nval = 1 << 5;\r\n}\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xf9 : 0xfb,\r\nmask, val);\r\nmask = (0x1 << 5);\r\nval = 1 << 5;\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xe5 : 0xe6, mask, val);\r\n} else {\r\nif (rssi_type == NPHY_RSSI_SEL_TBD) {\r\nmask = (0x3 << 8);\r\nval = 1 << 8;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\nmask = (0x3 << 10);\r\nval = 1 << 10;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\n} else if (rssi_type ==\r\nNPHY_RSSI_SEL_IQ) {\r\nmask = (0x3 << 8);\r\nval = 2 << 8;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\nmask = (0x3 << 10);\r\nval = 2 << 10;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\n} else {\r\nmask = (0x3 << 8);\r\nval = 3 << 8;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\nmask = (0x3 << 10);\r\nval = 3 << 10;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0xa6\r\n: 0xa7, mask, val);\r\nbrcms_phy_wr_tx_mux(pi, core);\r\nafectrlovr_rssi_val = 1 << 9;\r\nmod_phy_reg(pi,\r\n(core ==\r\nPHY_CORE_0) ? 0x8f\r\n: 0xa5, (0x1 << 9),\r\nafectrlovr_rssi_val);\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nif ((rssi_type == NPHY_RSSI_SEL_W1) ||\r\n(rssi_type == NPHY_RSSI_SEL_W2) ||\r\n(rssi_type == NPHY_RSSI_SEL_NB))\r\nval = 0x0;\r\nelse if (rssi_type == NPHY_RSSI_SEL_TBD)\r\nval = 0x1;\r\nelse if (rssi_type == NPHY_RSSI_SEL_IQ)\r\nval = 0x2;\r\nelse\r\nval = 0x3;\r\nmask = ((0x3 << 12) | (0x3 << 14));\r\nval = (val << 12) | (val << 14);\r\nmod_phy_reg(pi, 0xa6, mask, val);\r\nmod_phy_reg(pi, 0xa7, mask, val);\r\nif ((rssi_type == NPHY_RSSI_SEL_W1) ||\r\n(rssi_type == NPHY_RSSI_SEL_W2) ||\r\n(rssi_type == NPHY_RSSI_SEL_NB)) {\r\nif (rssi_type == NPHY_RSSI_SEL_W1)\r\nval = 0x1;\r\nif (rssi_type == NPHY_RSSI_SEL_W2)\r\nval = 0x2;\r\nif (rssi_type == NPHY_RSSI_SEL_NB)\r\nval = 0x3;\r\nmask = (0x3 << 4);\r\nval = (val << 4);\r\nmod_phy_reg(pi, 0x7a, mask, val);\r\nmod_phy_reg(pi, 0x7d, mask, val);\r\n}\r\nif (core_code == RADIO_MIMO_CORESEL_OFF) {\r\nafectrlovr_rssi_val = 0;\r\nrfctrlcmd_rxen_val = 0;\r\nrfctrlcmd_coresel_val = 0;\r\nrfctrlovr_rssi_val = 0;\r\nrfctrlovr_rxen_val = 0;\r\nrfctrlovr_coresel_val = 0;\r\nrfctrlovr_trigger_val = 0;\r\nstartseq = 0;\r\n} else {\r\nafectrlovr_rssi_val = 1;\r\nrfctrlcmd_rxen_val = 1;\r\nrfctrlcmd_coresel_val = core_code;\r\nrfctrlovr_rssi_val = 1;\r\nrfctrlovr_rxen_val = 1;\r\nrfctrlovr_coresel_val = 1;\r\nrfctrlovr_trigger_val = 1;\r\nstartseq = 1;\r\n}\r\nafectrlovr_rssi_mask = ((0x1 << 12) | (0x1 << 13));\r\nafectrlovr_rssi_val = (afectrlovr_rssi_val <<\r\n12) | (afectrlovr_rssi_val << 13);\r\nmod_phy_reg(pi, 0xa5, afectrlovr_rssi_mask,\r\nafectrlovr_rssi_val);\r\nif ((rssi_type == NPHY_RSSI_SEL_W1) ||\r\n(rssi_type == NPHY_RSSI_SEL_W2) ||\r\n(rssi_type == NPHY_RSSI_SEL_NB)) {\r\nrfctrlcmd_mask = ((0x1 << 8) | (0x7 << 3));\r\nrfctrlcmd_val = (rfctrlcmd_rxen_val << 8) |\r\n(rfctrlcmd_coresel_val << 3);\r\nrfctrlovr_mask = ((0x1 << 5) |\r\n(0x1 << 12) |\r\n(0x1 << 1) | (0x1 << 0));\r\nrfctrlovr_val = (rfctrlovr_rssi_val <<\r\n5) |\r\n(rfctrlovr_rxen_val << 12) |\r\n(rfctrlovr_coresel_val << 1) |\r\n(rfctrlovr_trigger_val << 0);\r\nmod_phy_reg(pi, 0x78, rfctrlcmd_mask, rfctrlcmd_val);\r\nmod_phy_reg(pi, 0xec, rfctrlovr_mask, rfctrlovr_val);\r\nmod_phy_reg(pi, 0x78, (0x1 << 0), (startseq << 0));\r\nudelay(20);\r\nmod_phy_reg(pi, 0xec, (0x1 << 0), 0);\r\n}\r\n}\r\n}\r\nint\r\nwlc_phy_poll_rssi_nphy(struct brcms_phy *pi, u8 rssi_type, s32 *rssi_buf,\r\nu8 nsamps)\r\n{\r\ns16 rssi0, rssi1;\r\nu16 afectrlCore1_save = 0;\r\nu16 afectrlCore2_save = 0;\r\nu16 afectrlOverride1_save = 0;\r\nu16 afectrlOverride2_save = 0;\r\nu16 rfctrlOverrideAux0_save = 0;\r\nu16 rfctrlOverrideAux1_save = 0;\r\nu16 rfctrlMiscReg1_save = 0;\r\nu16 rfctrlMiscReg2_save = 0;\r\nu16 rfctrlcmd_save = 0;\r\nu16 rfctrloverride_save = 0;\r\nu16 rfctrlrssiothers1_save = 0;\r\nu16 rfctrlrssiothers2_save = 0;\r\ns8 tmp_buf[4];\r\nu8 ctr = 0, samp = 0;\r\ns32 rssi_out_val;\r\nu16 gpiosel_orig;\r\nafectrlCore1_save = read_phy_reg(pi, 0xa6);\r\nafectrlCore2_save = read_phy_reg(pi, 0xa7);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nrfctrlMiscReg1_save = read_phy_reg(pi, 0xf9);\r\nrfctrlMiscReg2_save = read_phy_reg(pi, 0xfb);\r\nafectrlOverride1_save = read_phy_reg(pi, 0x8f);\r\nafectrlOverride2_save = read_phy_reg(pi, 0xa5);\r\nrfctrlOverrideAux0_save = read_phy_reg(pi, 0xe5);\r\nrfctrlOverrideAux1_save = read_phy_reg(pi, 0xe6);\r\n} else {\r\nafectrlOverride1_save = read_phy_reg(pi, 0xa5);\r\nrfctrlcmd_save = read_phy_reg(pi, 0x78);\r\nrfctrloverride_save = read_phy_reg(pi, 0xec);\r\nrfctrlrssiothers1_save = read_phy_reg(pi, 0x7a);\r\nrfctrlrssiothers2_save = read_phy_reg(pi, 0x7d);\r\n}\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_ALLRX, rssi_type);\r\ngpiosel_orig = read_phy_reg(pi, 0xca);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2))\r\nwrite_phy_reg(pi, 0xca, 5);\r\nfor (ctr = 0; ctr < 4; ctr++)\r\nrssi_buf[ctr] = 0;\r\nfor (samp = 0; samp < nsamps; samp++) {\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nrssi0 = read_phy_reg(pi, 0x1c9);\r\nrssi1 = read_phy_reg(pi, 0x1ca);\r\n} else {\r\nrssi0 = read_phy_reg(pi, 0x219);\r\nrssi1 = read_phy_reg(pi, 0x21a);\r\n}\r\nctr = 0;\r\ntmp_buf[ctr++] = ((s8) ((rssi0 & 0x3f) << 2)) >> 2;\r\ntmp_buf[ctr++] = ((s8) (((rssi0 >> 8) & 0x3f) << 2)) >> 2;\r\ntmp_buf[ctr++] = ((s8) ((rssi1 & 0x3f) << 2)) >> 2;\r\ntmp_buf[ctr++] = ((s8) (((rssi1 >> 8) & 0x3f) << 2)) >> 2;\r\nfor (ctr = 0; ctr < 4; ctr++)\r\nrssi_buf[ctr] += tmp_buf[ctr];\r\n}\r\nrssi_out_val = rssi_buf[3] & 0xff;\r\nrssi_out_val |= (rssi_buf[2] & 0xff) << 8;\r\nrssi_out_val |= (rssi_buf[1] & 0xff) << 16;\r\nrssi_out_val |= (rssi_buf[0] & 0xff) << 24;\r\nif (NREV_LT(pi->pubpi.phy_rev, 2))\r\nwrite_phy_reg(pi, 0xca, gpiosel_orig);\r\nwrite_phy_reg(pi, 0xa6, afectrlCore1_save);\r\nwrite_phy_reg(pi, 0xa7, afectrlCore2_save);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_phy_reg(pi, 0xf9, rfctrlMiscReg1_save);\r\nwrite_phy_reg(pi, 0xfb, rfctrlMiscReg2_save);\r\nwrite_phy_reg(pi, 0x8f, afectrlOverride1_save);\r\nwrite_phy_reg(pi, 0xa5, afectrlOverride2_save);\r\nwrite_phy_reg(pi, 0xe5, rfctrlOverrideAux0_save);\r\nwrite_phy_reg(pi, 0xe6, rfctrlOverrideAux1_save);\r\n} else {\r\nwrite_phy_reg(pi, 0xa5, afectrlOverride1_save);\r\nwrite_phy_reg(pi, 0x78, rfctrlcmd_save);\r\nwrite_phy_reg(pi, 0xec, rfctrloverride_save);\r\nwrite_phy_reg(pi, 0x7a, rfctrlrssiothers1_save);\r\nwrite_phy_reg(pi, 0x7d, rfctrlrssiothers2_save);\r\n}\r\nreturn rssi_out_val;\r\n}\r\ns16 wlc_phy_tempsense_nphy(struct brcms_phy *pi)\r\n{\r\nu16 core1_txrf_iqcal1_save, core1_txrf_iqcal2_save;\r\nu16 core2_txrf_iqcal1_save, core2_txrf_iqcal2_save;\r\nu16 pwrdet_rxtx_core1_save;\r\nu16 pwrdet_rxtx_core2_save;\r\nu16 afectrlCore1_save;\r\nu16 afectrlCore2_save;\r\nu16 afectrlOverride_save;\r\nu16 afectrlOverride2_save;\r\nu16 pd_pll_ts_save;\r\nu16 gpioSel_save;\r\ns32 radio_temp[4];\r\ns32 radio_temp2[4];\r\nu16 syn_tempprocsense_save;\r\ns16 offset = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nu16 auxADC_Vmid, auxADC_Av, auxADC_Vmid_save, auxADC_Av_save;\r\nu16 auxADC_rssi_ctrlL_save, auxADC_rssi_ctrlH_save;\r\nu16 auxADC_rssi_ctrlL, auxADC_rssi_ctrlH;\r\ns32 auxADC_Vl;\r\nu16 RfctrlOverride5_save, RfctrlOverride6_save;\r\nu16 RfctrlMiscReg5_save, RfctrlMiscReg6_save;\r\nu16 RSSIMultCoef0QPowerDet_save;\r\nu16 tempsense_Rcal;\r\nsyn_tempprocsense_save =\r\nread_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG);\r\nafectrlCore1_save = read_phy_reg(pi, 0xa6);\r\nafectrlCore2_save = read_phy_reg(pi, 0xa7);\r\nafectrlOverride_save = read_phy_reg(pi, 0x8f);\r\nafectrlOverride2_save = read_phy_reg(pi, 0xa5);\r\nRSSIMultCoef0QPowerDet_save = read_phy_reg(pi, 0x1ae);\r\nRfctrlOverride5_save = read_phy_reg(pi, 0x346);\r\nRfctrlOverride6_save = read_phy_reg(pi, 0x347);\r\nRfctrlMiscReg5_save = read_phy_reg(pi, 0x344);\r\nRfctrlMiscReg6_save = read_phy_reg(pi, 0x345);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0A, 16,\r\n&auxADC_Vmid_save);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0E, 16,\r\n&auxADC_Av_save);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x02, 16,\r\n&auxADC_rssi_ctrlL_save);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x03, 16,\r\n&auxADC_rssi_ctrlH_save);\r\nwrite_phy_reg(pi, 0x1ae, 0x0);\r\nauxADC_rssi_ctrlL = 0x0;\r\nauxADC_rssi_ctrlH = 0x20;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x02, 16,\r\n&auxADC_rssi_ctrlL);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x03, 16,\r\n&auxADC_rssi_ctrlH);\r\ntempsense_Rcal = syn_tempprocsense_save & 0x1c;\r\nwrite_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG,\r\ntempsense_Rcal | 0x01);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 1),\r\n1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nmod_phy_reg(pi, 0xa6, (0x1 << 7), 0);\r\nmod_phy_reg(pi, 0xa7, (0x1 << 7), 0);\r\nmod_phy_reg(pi, 0x8f, (0x1 << 7), (0x1 << 7));\r\nmod_phy_reg(pi, 0xa5, (0x1 << 7), (0x1 << 7));\r\nmod_phy_reg(pi, 0xa6, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0xa7, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0x8f, (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, 0xa5, (0x1 << 2), (0x1 << 2));\r\nudelay(5);\r\nmod_phy_reg(pi, 0xa6, (0x1 << 2), 0);\r\nmod_phy_reg(pi, 0xa7, (0x1 << 2), 0);\r\nmod_phy_reg(pi, 0xa6, (0x1 << 3), 0);\r\nmod_phy_reg(pi, 0xa7, (0x1 << 3), 0);\r\nmod_phy_reg(pi, 0x8f, (0x1 << 3), (0x1 << 3));\r\nmod_phy_reg(pi, 0xa5, (0x1 << 3), (0x1 << 3));\r\nmod_phy_reg(pi, 0xa6, (0x1 << 6), 0);\r\nmod_phy_reg(pi, 0xa7, (0x1 << 6), 0);\r\nmod_phy_reg(pi, 0x8f, (0x1 << 6), (0x1 << 6));\r\nmod_phy_reg(pi, 0xa5, (0x1 << 6), (0x1 << 6));\r\nauxADC_Vmid = 0xA3;\r\nauxADC_Av = 0x0;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0A, 16,\r\n&auxADC_Vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0E, 16,\r\n&auxADC_Av);\r\nudelay(3);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp, 1);\r\nwrite_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG,\r\ntempsense_Rcal | 0x03);\r\nudelay(5);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp2, 1);\r\nauxADC_Av = 0x7;\r\nif (radio_temp[1] + radio_temp2[1] < -30) {\r\nauxADC_Vmid = 0x45;\r\nauxADC_Vl = 263;\r\n} else if (radio_temp[1] + radio_temp2[1] < -9) {\r\nauxADC_Vmid = 0x200;\r\nauxADC_Vl = 467;\r\n} else if (radio_temp[1] + radio_temp2[1] < 11) {\r\nauxADC_Vmid = 0x266;\r\nauxADC_Vl = 634;\r\n} else {\r\nauxADC_Vmid = 0x2D5;\r\nauxADC_Vl = 816;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0A, 16,\r\n&auxADC_Vmid);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0E, 16,\r\n&auxADC_Av);\r\nudelay(3);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp2, 1);\r\nwrite_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG,\r\ntempsense_Rcal | 0x01);\r\nudelay(5);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp, 1);\r\nwrite_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG,\r\nsyn_tempprocsense_save);\r\nwrite_phy_reg(pi, 0xa6, afectrlCore1_save);\r\nwrite_phy_reg(pi, 0xa7, afectrlCore2_save);\r\nwrite_phy_reg(pi, 0x8f, afectrlOverride_save);\r\nwrite_phy_reg(pi, 0xa5, afectrlOverride2_save);\r\nwrite_phy_reg(pi, 0x1ae, RSSIMultCoef0QPowerDet_save);\r\nwrite_phy_reg(pi, 0x346, RfctrlOverride5_save);\r\nwrite_phy_reg(pi, 0x347, RfctrlOverride6_save);\r\nwrite_phy_reg(pi, 0x344, RfctrlMiscReg5_save);\r\nwrite_phy_reg(pi, 0x345, RfctrlMiscReg5_save);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0A, 16,\r\n&auxADC_Vmid_save);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x0E, 16,\r\n&auxADC_Av_save);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x02, 16,\r\n&auxADC_rssi_ctrlL_save);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 0x03, 16,\r\n&auxADC_rssi_ctrlH_save);\r\nif (pi->sh->chip == BCMA_CHIP_ID_BCM5357) {\r\nradio_temp[0] = (193 * (radio_temp[1] + radio_temp2[1])\r\n+ 88 * (auxADC_Vl) - 27111 +\r\n128) / 256;\r\n} else {\r\nradio_temp[0] = (179 * (radio_temp[1] + radio_temp2[1])\r\n+ 82 * (auxADC_Vl) - 28861 +\r\n128) / 256;\r\n}\r\noffset = (s16) pi->phy_tempsense_offset;\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nsyn_tempprocsense_save =\r\nread_radio_reg(pi, RADIO_2056_SYN_TEMPPROCSENSE);\r\nafectrlCore1_save = read_phy_reg(pi, 0xa6);\r\nafectrlCore2_save = read_phy_reg(pi, 0xa7);\r\nafectrlOverride_save = read_phy_reg(pi, 0x8f);\r\nafectrlOverride2_save = read_phy_reg(pi, 0xa5);\r\ngpioSel_save = read_phy_reg(pi, 0xca);\r\nwrite_radio_reg(pi, RADIO_2056_SYN_TEMPPROCSENSE, 0x01);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp, 1);\r\nif (NREV_LT(pi->pubpi.phy_rev, 7))\r\nwrite_radio_reg(pi, RADIO_2056_SYN_TEMPPROCSENSE, 0x05);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp2, 1);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwrite_radio_reg(pi, RADIO_2057_TEMPSENSE_CONFIG, 0x01);\r\nelse\r\nwrite_radio_reg(pi, RADIO_2056_SYN_TEMPPROCSENSE, 0x01);\r\nradio_temp[0] =\r\n(126 * (radio_temp[1] + radio_temp2[1]) + 3987) / 64;\r\nwrite_radio_reg(pi, RADIO_2056_SYN_TEMPPROCSENSE,\r\nsyn_tempprocsense_save);\r\nwrite_phy_reg(pi, 0xca, gpioSel_save);\r\nwrite_phy_reg(pi, 0xa6, afectrlCore1_save);\r\nwrite_phy_reg(pi, 0xa7, afectrlCore2_save);\r\nwrite_phy_reg(pi, 0x8f, afectrlOverride_save);\r\nwrite_phy_reg(pi, 0xa5, afectrlOverride2_save);\r\noffset = (s16) pi->phy_tempsense_offset;\r\n} else {\r\npwrdet_rxtx_core1_save =\r\nread_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1);\r\npwrdet_rxtx_core2_save =\r\nread_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2);\r\ncore1_txrf_iqcal1_save =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1);\r\ncore1_txrf_iqcal2_save =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2);\r\ncore2_txrf_iqcal1_save =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1);\r\ncore2_txrf_iqcal2_save =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2);\r\npd_pll_ts_save = read_radio_reg(pi, RADIO_2055_PD_PLL_TS);\r\nafectrlCore1_save = read_phy_reg(pi, 0xa6);\r\nafectrlCore2_save = read_phy_reg(pi, 0xa7);\r\nafectrlOverride_save = read_phy_reg(pi, 0xa5);\r\ngpioSel_save = read_phy_reg(pi, 0xca);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1, 0x01);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1, 0x01);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2, 0x08);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2, 0x08);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1, 0x04);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2, 0x04);\r\nwrite_radio_reg(pi, RADIO_2055_PD_PLL_TS, 0x00);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp, 1);\r\nxor_radio_reg(pi, RADIO_2055_CAL_TS, 0x80);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp, 1);\r\nxor_radio_reg(pi, RADIO_2055_CAL_TS, 0x80);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_IQ, radio_temp2, 1);\r\nxor_radio_reg(pi, RADIO_2055_CAL_TS, 0x80);\r\nradio_temp[0] = (radio_temp[0] + radio_temp2[0]);\r\nradio_temp[1] = (radio_temp[1] + radio_temp2[1]);\r\nradio_temp[2] = (radio_temp[2] + radio_temp2[2]);\r\nradio_temp[3] = (radio_temp[3] + radio_temp2[3]);\r\nradio_temp[0] =\r\n(radio_temp[0] + radio_temp[1] + radio_temp[2] +\r\nradio_temp[3]);\r\nradio_temp[0] =\r\n(radio_temp[0] +\r\n(8 * 32)) * (950 - 350) / 63 + (350 * 8);\r\nradio_temp[0] = (radio_temp[0] - (8 * 420)) / 38;\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1,\r\npwrdet_rxtx_core1_save);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2,\r\npwrdet_rxtx_core2_save);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1,\r\ncore1_txrf_iqcal1_save);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1,\r\ncore2_txrf_iqcal1_save);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2,\r\ncore1_txrf_iqcal2_save);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2,\r\ncore2_txrf_iqcal2_save);\r\nwrite_radio_reg(pi, RADIO_2055_PD_PLL_TS, pd_pll_ts_save);\r\nwrite_phy_reg(pi, 0xca, gpioSel_save);\r\nwrite_phy_reg(pi, 0xa6, afectrlCore1_save);\r\nwrite_phy_reg(pi, 0xa7, afectrlCore2_save);\r\nwrite_phy_reg(pi, 0xa5, afectrlOverride_save);\r\n}\r\nreturn (s16) radio_temp[0] + offset;\r\n}\r\nstatic void\r\nwlc_phy_set_rssi_2055_vcm(struct brcms_phy *pi, u8 rssi_type, u8 *vcm_buf)\r\n{\r\nu8 core;\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (rssi_type == NPHY_RSSI_SEL_NB) {\r\nif (core == PHY_CORE_0) {\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE1_B0_NBRSSI_VCM,\r\nRADIO_2055_NBRSSI_VCM_I_MASK,\r\nvcm_buf[2 *\r\ncore] <<\r\nRADIO_2055_NBRSSI_VCM_I_SHIFT);\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE1_RXBB_RSSI_CTRL5,\r\nRADIO_2055_NBRSSI_VCM_Q_MASK,\r\nvcm_buf[2 * core +\r\n1] <<\r\nRADIO_2055_NBRSSI_VCM_Q_SHIFT);\r\n} else {\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE2_B0_NBRSSI_VCM,\r\nRADIO_2055_NBRSSI_VCM_I_MASK,\r\nvcm_buf[2 *\r\ncore] <<\r\nRADIO_2055_NBRSSI_VCM_I_SHIFT);\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE2_RXBB_RSSI_CTRL5,\r\nRADIO_2055_NBRSSI_VCM_Q_MASK,\r\nvcm_buf[2 * core +\r\n1] <<\r\nRADIO_2055_NBRSSI_VCM_Q_SHIFT);\r\n}\r\n} else {\r\nif (core == PHY_CORE_0)\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE1_RXBB_RSSI_CTRL5,\r\nRADIO_2055_WBRSSI_VCM_IQ_MASK,\r\nvcm_buf[2 *\r\ncore] <<\r\nRADIO_2055_WBRSSI_VCM_IQ_SHIFT);\r\nelse\r\nmod_radio_reg(pi,\r\nRADIO_2055_CORE2_RXBB_RSSI_CTRL5,\r\nRADIO_2055_WBRSSI_VCM_IQ_MASK,\r\nvcm_buf[2 *\r\ncore] <<\r\nRADIO_2055_WBRSSI_VCM_IQ_SHIFT);\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_rssi_cal_nphy_rev3(struct brcms_phy *pi)\r\n{\r\nu16 classif_state;\r\nu16 clip_state[2];\r\nu16 clip_off[] = { 0xffff, 0xffff };\r\ns32 target_code;\r\nu8 vcm, min_vcm;\r\nu8 vcm_final = 0;\r\nu8 result_idx;\r\ns32 poll_results[8][4] = {\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0}\r\n};\r\ns32 poll_result_core[4] = { 0, 0, 0, 0 };\r\ns32 min_d = NPHY_RSSICAL_MAXD, curr_d;\r\ns32 fine_digital_offset[4];\r\ns32 poll_results_min[4] = { 0, 0, 0, 0 };\r\ns32 min_poll;\r\nu8 vcm_level_max;\r\nu8 core;\r\nu8 wb_cnt;\r\nu8 rssi_type;\r\nu16 NPHY_Rfctrlintc1_save, NPHY_Rfctrlintc2_save;\r\nu16 NPHY_AfectrlOverride1_save, NPHY_AfectrlOverride2_save;\r\nu16 NPHY_AfectrlCore1_save, NPHY_AfectrlCore2_save;\r\nu16 NPHY_RfctrlOverride0_save, NPHY_RfctrlOverride1_save;\r\nu16 NPHY_RfctrlOverrideAux0_save, NPHY_RfctrlOverrideAux1_save;\r\nu16 NPHY_RfctrlCmd_save;\r\nu16 NPHY_RfctrlMiscReg1_save, NPHY_RfctrlMiscReg2_save;\r\nu16 NPHY_RfctrlRSSIOTHERS1_save, NPHY_RfctrlRSSIOTHERS2_save;\r\nu8 rxcore_state;\r\nu16 NPHY_REV7_RfctrlOverride3_save, NPHY_REV7_RfctrlOverride4_save;\r\nu16 NPHY_REV7_RfctrlOverride5_save, NPHY_REV7_RfctrlOverride6_save;\r\nu16 NPHY_REV7_RfctrlMiscReg3_save, NPHY_REV7_RfctrlMiscReg4_save;\r\nu16 NPHY_REV7_RfctrlMiscReg5_save, NPHY_REV7_RfctrlMiscReg6_save;\r\nNPHY_REV7_RfctrlOverride3_save =\r\nNPHY_REV7_RfctrlOverride4_save =\r\nNPHY_REV7_RfctrlOverride5_save =\r\nNPHY_REV7_RfctrlOverride6_save =\r\nNPHY_REV7_RfctrlMiscReg3_save =\r\nNPHY_REV7_RfctrlMiscReg4_save =\r\nNPHY_REV7_RfctrlMiscReg5_save =\r\nNPHY_REV7_RfctrlMiscReg6_save = 0;\r\nclassif_state = wlc_phy_classifier_nphy(pi, 0, 0);\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0), 4);\r\nwlc_phy_clip_det_nphy(pi, 0, clip_state);\r\nwlc_phy_clip_det_nphy(pi, 1, clip_off);\r\nNPHY_Rfctrlintc1_save = read_phy_reg(pi, 0x91);\r\nNPHY_Rfctrlintc2_save = read_phy_reg(pi, 0x92);\r\nNPHY_AfectrlOverride1_save = read_phy_reg(pi, 0x8f);\r\nNPHY_AfectrlOverride2_save = read_phy_reg(pi, 0xa5);\r\nNPHY_AfectrlCore1_save = read_phy_reg(pi, 0xa6);\r\nNPHY_AfectrlCore2_save = read_phy_reg(pi, 0xa7);\r\nNPHY_RfctrlOverride0_save = read_phy_reg(pi, 0xe7);\r\nNPHY_RfctrlOverride1_save = read_phy_reg(pi, 0xec);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nNPHY_REV7_RfctrlOverride3_save = read_phy_reg(pi, 0x342);\r\nNPHY_REV7_RfctrlOverride4_save = read_phy_reg(pi, 0x343);\r\nNPHY_REV7_RfctrlOverride5_save = read_phy_reg(pi, 0x346);\r\nNPHY_REV7_RfctrlOverride6_save = read_phy_reg(pi, 0x347);\r\n}\r\nNPHY_RfctrlOverrideAux0_save = read_phy_reg(pi, 0xe5);\r\nNPHY_RfctrlOverrideAux1_save = read_phy_reg(pi, 0xe6);\r\nNPHY_RfctrlCmd_save = read_phy_reg(pi, 0x78);\r\nNPHY_RfctrlMiscReg1_save = read_phy_reg(pi, 0xf9);\r\nNPHY_RfctrlMiscReg2_save = read_phy_reg(pi, 0xfb);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nNPHY_REV7_RfctrlMiscReg3_save = read_phy_reg(pi, 0x340);\r\nNPHY_REV7_RfctrlMiscReg4_save = read_phy_reg(pi, 0x341);\r\nNPHY_REV7_RfctrlMiscReg5_save = read_phy_reg(pi, 0x344);\r\nNPHY_REV7_RfctrlMiscReg6_save = read_phy_reg(pi, 0x345);\r\n}\r\nNPHY_RfctrlRSSIOTHERS1_save = read_phy_reg(pi, 0x7a);\r\nNPHY_RfctrlRSSIOTHERS2_save = read_phy_reg(pi, 0x7d);\r\nwlc_phy_rfctrlintc_override_nphy(pi, NPHY_RfctrlIntc_override_OFF, 0,\r\nRADIO_MIMO_CORESEL_ALLRXTX);\r\nwlc_phy_rfctrlintc_override_nphy(pi, NPHY_RfctrlIntc_override_TRSW, 1,\r\nRADIO_MIMO_CORESEL_ALLRXTX);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_rxrf_pu,\r\n0, 0, 0);\r\nelse\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 0), 0, 0, 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_rx_pu,\r\n1, 0, 0);\r\nelse\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 1), 1, 0, 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 7),\r\n1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 6), 1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 7), 1, 0, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 6), 1, 0, 0);\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 5),\r\n0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 4), 1, 0,\r\n0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 5), 0, 0, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 4), 1, 0, 0);\r\n}\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 4),\r\n0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 5), 1, 0,\r\n0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 4), 0, 0, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 5), 1, 0, 0);\r\n}\r\n}\r\nrxcore_state = wlc_phy_rxcore_getstate_nphy(\r\n(struct brcms_phy_pub *) pi);\r\nvcm_level_max = 8;\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif ((rxcore_state & (1 << core)) == 0)\r\ncontinue;\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0,\r\ncore ==\r\nPHY_CORE_0 ?\r\nRADIO_MIMO_CORESEL_CORE1 :\r\nRADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RAIL_I, NPHY_RSSI_SEL_NB);\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0,\r\ncore ==\r\nPHY_CORE_0 ?\r\nRADIO_MIMO_CORESEL_CORE1 :\r\nRADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RAIL_Q, NPHY_RSSI_SEL_NB);\r\nfor (vcm = 0; vcm < vcm_level_max; vcm++) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nmod_radio_reg(pi, (core == PHY_CORE_0) ?\r\nRADIO_2057_NB_MASTER_CORE0 :\r\nRADIO_2057_NB_MASTER_CORE1,\r\nRADIO_2057_VCM_MASK, vcm);\r\nelse\r\nmod_radio_reg(pi, RADIO_2056_RX_RSSI_MISC |\r\n((core ==\r\nPHY_CORE_0) ? RADIO_2056_RX0 :\r\nRADIO_2056_RX1),\r\nRADIO_2056_VCM_MASK,\r\nvcm << RADIO_2056_RSSI_VCM_SHIFT);\r\nwlc_phy_poll_rssi_nphy(pi, NPHY_RSSI_SEL_NB,\r\n&poll_results[vcm][0],\r\nNPHY_RSSICAL_NPOLL);\r\n}\r\nfor (result_idx = 0; result_idx < 4; result_idx++) {\r\nif ((core == result_idx / 2) &&\r\n(result_idx % 2 == 0)) {\r\nmin_d = NPHY_RSSICAL_MAXD;\r\nmin_vcm = 0;\r\nmin_poll =\r\nNPHY_RSSICAL_MAXREAD *\r\nNPHY_RSSICAL_NPOLL + 1;\r\nfor (vcm = 0; vcm < vcm_level_max; vcm++) {\r\ncurr_d =\r\npoll_results[vcm][result_idx] *\r\npoll_results[vcm][result_idx] +\r\npoll_results[vcm][result_idx +\r\n1] *\r\npoll_results[vcm][result_idx +\r\n1];\r\nif (curr_d < min_d) {\r\nmin_d = curr_d;\r\nmin_vcm = vcm;\r\n}\r\nif (poll_results[vcm][result_idx] <\r\nmin_poll)\r\nmin_poll =\r\npoll_results[vcm]\r\n[result_idx];\r\n}\r\nvcm_final = min_vcm;\r\npoll_results_min[result_idx] = min_poll;\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nmod_radio_reg(pi, (core == PHY_CORE_0) ?\r\nRADIO_2057_NB_MASTER_CORE0 :\r\nRADIO_2057_NB_MASTER_CORE1,\r\nRADIO_2057_VCM_MASK, vcm_final);\r\nelse\r\nmod_radio_reg(pi, RADIO_2056_RX_RSSI_MISC |\r\n((core ==\r\nPHY_CORE_0) ? RADIO_2056_RX0 :\r\nRADIO_2056_RX1), RADIO_2056_VCM_MASK,\r\nvcm_final << RADIO_2056_RSSI_VCM_SHIFT);\r\nfor (result_idx = 0; result_idx < 4; result_idx++) {\r\nif (core == result_idx / 2) {\r\nfine_digital_offset[result_idx] =\r\n(NPHY_RSSICAL_NB_TARGET *\r\nNPHY_RSSICAL_NPOLL) -\r\npoll_results[vcm_final][result_idx];\r\nif (fine_digital_offset[result_idx] < 0) {\r\nfine_digital_offset[result_idx] =\r\nabs(fine_digital_offset\r\n[result_idx]);\r\nfine_digital_offset[result_idx] +=\r\n(NPHY_RSSICAL_NPOLL / 2);\r\nfine_digital_offset[result_idx] /=\r\nNPHY_RSSICAL_NPOLL;\r\nfine_digital_offset[result_idx] =\r\n-fine_digital_offset[\r\nresult_idx];\r\n} else {\r\nfine_digital_offset[result_idx] +=\r\n(NPHY_RSSICAL_NPOLL / 2);\r\nfine_digital_offset[result_idx] /=\r\nNPHY_RSSICAL_NPOLL;\r\n}\r\nif (poll_results_min[result_idx] ==\r\nNPHY_RSSICAL_MAXREAD * NPHY_RSSICAL_NPOLL)\r\nfine_digital_offset[result_idx] =\r\n(NPHY_RSSICAL_NB_TARGET -\r\nNPHY_RSSICAL_MAXREAD - 1);\r\nwlc_phy_scale_offset_rssi_nphy(\r\npi, 0x0,\r\n(s8)\r\nfine_digital_offset\r\n[result_idx],\r\n(result_idx / 2 == 0) ?\r\nRADIO_MIMO_CORESEL_CORE1 :\r\nRADIO_MIMO_CORESEL_CORE2,\r\n(result_idx % 2 == 0) ?\r\nNPHY_RAIL_I : NPHY_RAIL_Q,\r\nNPHY_RSSI_SEL_NB);\r\n}\r\n}\r\n}\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif ((rxcore_state & (1 << core)) == 0)\r\ncontinue;\r\nfor (wb_cnt = 0; wb_cnt < 2; wb_cnt++) {\r\nif (wb_cnt == 0) {\r\nrssi_type = NPHY_RSSI_SEL_W1;\r\ntarget_code = NPHY_RSSICAL_W1_TARGET_REV3;\r\n} else {\r\nrssi_type = NPHY_RSSI_SEL_W2;\r\ntarget_code = NPHY_RSSICAL_W2_TARGET_REV3;\r\n}\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0,\r\ncore ==\r\nPHY_CORE_0 ?\r\nRADIO_MIMO_CORESEL_CORE1\r\n:\r\nRADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RAIL_I, rssi_type);\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0,\r\ncore ==\r\nPHY_CORE_0 ?\r\nRADIO_MIMO_CORESEL_CORE1\r\n:\r\nRADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RAIL_Q, rssi_type);\r\nwlc_phy_poll_rssi_nphy(pi, rssi_type, poll_result_core,\r\nNPHY_RSSICAL_NPOLL);\r\nfor (result_idx = 0; result_idx < 4; result_idx++) {\r\nif (core == result_idx / 2) {\r\nfine_digital_offset[result_idx] =\r\n(target_code *\r\nNPHY_RSSICAL_NPOLL) -\r\npoll_result_core[result_idx];\r\nif (fine_digital_offset[result_idx] <\r\n0) {\r\nfine_digital_offset[result_idx]\r\n= abs(\r\nfine_digital_offset\r\n[result_idx]);\r\nfine_digital_offset[result_idx]\r\n+= (NPHY_RSSICAL_NPOLL\r\n/ 2);\r\nfine_digital_offset[result_idx]\r\n/= NPHY_RSSICAL_NPOLL;\r\nfine_digital_offset[result_idx]\r\n= -fine_digital_offset\r\n[result_idx];\r\n} else {\r\nfine_digital_offset[result_idx]\r\n+= (NPHY_RSSICAL_NPOLL\r\n/ 2);\r\nfine_digital_offset[result_idx]\r\n/= NPHY_RSSICAL_NPOLL;\r\n}\r\nwlc_phy_scale_offset_rssi_nphy(\r\npi, 0x0,\r\n(s8)\r\nfine_digital_offset\r\n[core *\r\n2],\r\n(core == PHY_CORE_0) ?\r\nRADIO_MIMO_CORESEL_CORE1 :\r\nRADIO_MIMO_CORESEL_CORE2,\r\n(result_idx % 2 == 0) ?\r\nNPHY_RAIL_I :\r\nNPHY_RAIL_Q,\r\nrssi_type);\r\n}\r\n}\r\n}\r\n}\r\nwrite_phy_reg(pi, 0x91, NPHY_Rfctrlintc1_save);\r\nwrite_phy_reg(pi, 0x92, NPHY_Rfctrlintc2_save);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nmod_phy_reg(pi, 0xe7, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x78, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0xe7, (0x1 << 0), 0);\r\nmod_phy_reg(pi, 0xec, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x78, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0xec, (0x1 << 0), 0);\r\nwrite_phy_reg(pi, 0x8f, NPHY_AfectrlOverride1_save);\r\nwrite_phy_reg(pi, 0xa5, NPHY_AfectrlOverride2_save);\r\nwrite_phy_reg(pi, 0xa6, NPHY_AfectrlCore1_save);\r\nwrite_phy_reg(pi, 0xa7, NPHY_AfectrlCore2_save);\r\nwrite_phy_reg(pi, 0xe7, NPHY_RfctrlOverride0_save);\r\nwrite_phy_reg(pi, 0xec, NPHY_RfctrlOverride1_save);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwrite_phy_reg(pi, 0x342, NPHY_REV7_RfctrlOverride3_save);\r\nwrite_phy_reg(pi, 0x343, NPHY_REV7_RfctrlOverride4_save);\r\nwrite_phy_reg(pi, 0x346, NPHY_REV7_RfctrlOverride5_save);\r\nwrite_phy_reg(pi, 0x347, NPHY_REV7_RfctrlOverride6_save);\r\n}\r\nwrite_phy_reg(pi, 0xe5, NPHY_RfctrlOverrideAux0_save);\r\nwrite_phy_reg(pi, 0xe6, NPHY_RfctrlOverrideAux1_save);\r\nwrite_phy_reg(pi, 0x78, NPHY_RfctrlCmd_save);\r\nwrite_phy_reg(pi, 0xf9, NPHY_RfctrlMiscReg1_save);\r\nwrite_phy_reg(pi, 0xfb, NPHY_RfctrlMiscReg2_save);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwrite_phy_reg(pi, 0x340, NPHY_REV7_RfctrlMiscReg3_save);\r\nwrite_phy_reg(pi, 0x341, NPHY_REV7_RfctrlMiscReg4_save);\r\nwrite_phy_reg(pi, 0x344, NPHY_REV7_RfctrlMiscReg5_save);\r\nwrite_phy_reg(pi, 0x345, NPHY_REV7_RfctrlMiscReg6_save);\r\n}\r\nwrite_phy_reg(pi, 0x7a, NPHY_RfctrlRSSIOTHERS1_save);\r\nwrite_phy_reg(pi, 0x7d, NPHY_RfctrlRSSIOTHERS2_save);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\npi->rssical_cache.rssical_radio_regs_2G[0] =\r\nread_radio_reg(pi, RADIO_2057_NB_MASTER_CORE0);\r\npi->rssical_cache.rssical_radio_regs_2G[1] =\r\nread_radio_reg(pi, RADIO_2057_NB_MASTER_CORE1);\r\n} else {\r\npi->rssical_cache.rssical_radio_regs_2G[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC |\r\nRADIO_2056_RX0);\r\npi->rssical_cache.rssical_radio_regs_2G[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC |\r\nRADIO_2056_RX1);\r\n}\r\npi->rssical_cache.rssical_phyregs_2G[0] =\r\nread_phy_reg(pi, 0x1a6);\r\npi->rssical_cache.rssical_phyregs_2G[1] =\r\nread_phy_reg(pi, 0x1ac);\r\npi->rssical_cache.rssical_phyregs_2G[2] =\r\nread_phy_reg(pi, 0x1b2);\r\npi->rssical_cache.rssical_phyregs_2G[3] =\r\nread_phy_reg(pi, 0x1b8);\r\npi->rssical_cache.rssical_phyregs_2G[4] =\r\nread_phy_reg(pi, 0x1a4);\r\npi->rssical_cache.rssical_phyregs_2G[5] =\r\nread_phy_reg(pi, 0x1aa);\r\npi->rssical_cache.rssical_phyregs_2G[6] =\r\nread_phy_reg(pi, 0x1b0);\r\npi->rssical_cache.rssical_phyregs_2G[7] =\r\nread_phy_reg(pi, 0x1b6);\r\npi->rssical_cache.rssical_phyregs_2G[8] =\r\nread_phy_reg(pi, 0x1a5);\r\npi->rssical_cache.rssical_phyregs_2G[9] =\r\nread_phy_reg(pi, 0x1ab);\r\npi->rssical_cache.rssical_phyregs_2G[10] =\r\nread_phy_reg(pi, 0x1b1);\r\npi->rssical_cache.rssical_phyregs_2G[11] =\r\nread_phy_reg(pi, 0x1b7);\r\npi->nphy_rssical_chanspec_2G = pi->radio_chanspec;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\npi->rssical_cache.rssical_radio_regs_5G[0] =\r\nread_radio_reg(pi, RADIO_2057_NB_MASTER_CORE0);\r\npi->rssical_cache.rssical_radio_regs_5G[1] =\r\nread_radio_reg(pi, RADIO_2057_NB_MASTER_CORE1);\r\n} else {\r\npi->rssical_cache.rssical_radio_regs_5G[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC |\r\nRADIO_2056_RX0);\r\npi->rssical_cache.rssical_radio_regs_5G[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RSSI_MISC |\r\nRADIO_2056_RX1);\r\n}\r\npi->rssical_cache.rssical_phyregs_5G[0] =\r\nread_phy_reg(pi, 0x1a6);\r\npi->rssical_cache.rssical_phyregs_5G[1] =\r\nread_phy_reg(pi, 0x1ac);\r\npi->rssical_cache.rssical_phyregs_5G[2] =\r\nread_phy_reg(pi, 0x1b2);\r\npi->rssical_cache.rssical_phyregs_5G[3] =\r\nread_phy_reg(pi, 0x1b8);\r\npi->rssical_cache.rssical_phyregs_5G[4] =\r\nread_phy_reg(pi, 0x1a4);\r\npi->rssical_cache.rssical_phyregs_5G[5] =\r\nread_phy_reg(pi, 0x1aa);\r\npi->rssical_cache.rssical_phyregs_5G[6] =\r\nread_phy_reg(pi, 0x1b0);\r\npi->rssical_cache.rssical_phyregs_5G[7] =\r\nread_phy_reg(pi, 0x1b6);\r\npi->rssical_cache.rssical_phyregs_5G[8] =\r\nread_phy_reg(pi, 0x1a5);\r\npi->rssical_cache.rssical_phyregs_5G[9] =\r\nread_phy_reg(pi, 0x1ab);\r\npi->rssical_cache.rssical_phyregs_5G[10] =\r\nread_phy_reg(pi, 0x1b1);\r\npi->rssical_cache.rssical_phyregs_5G[11] =\r\nread_phy_reg(pi, 0x1b7);\r\npi->nphy_rssical_chanspec_5G = pi->radio_chanspec;\r\n}\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0), classif_state);\r\nwlc_phy_clip_det_nphy(pi, 1, clip_state);\r\n}\r\nstatic void wlc_phy_rssi_cal_nphy_rev2(struct brcms_phy *pi, u8 rssi_type)\r\n{\r\ns32 target_code;\r\nu16 classif_state;\r\nu16 clip_state[2];\r\nu16 rssi_ctrl_state[2], pd_state[2];\r\nu16 rfctrlintc_state[2], rfpdcorerxtx_state[2];\r\nu16 rfctrlintc_override_val;\r\nu16 clip_off[] = { 0xffff, 0xffff };\r\nu16 rf_pd_val, pd_mask, rssi_ctrl_mask;\r\nu8 vcm, min_vcm, vcm_tmp[4];\r\nu8 vcm_final[4] = { 0, 0, 0, 0 };\r\nu8 result_idx, ctr;\r\ns32 poll_results[4][4] = {\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0},\r\n{0, 0, 0, 0}\r\n};\r\ns32 poll_miniq[4][2] = {\r\n{0, 0},\r\n{0, 0},\r\n{0, 0},\r\n{0, 0}\r\n};\r\ns32 min_d, curr_d;\r\ns32 fine_digital_offset[4];\r\ns32 poll_results_min[4] = { 0, 0, 0, 0 };\r\ns32 min_poll;\r\nswitch (rssi_type) {\r\ncase NPHY_RSSI_SEL_NB:\r\ntarget_code = NPHY_RSSICAL_NB_TARGET;\r\nbreak;\r\ncase NPHY_RSSI_SEL_W1:\r\ntarget_code = NPHY_RSSICAL_W1_TARGET;\r\nbreak;\r\ncase NPHY_RSSI_SEL_W2:\r\ntarget_code = NPHY_RSSICAL_W2_TARGET;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nclassif_state = wlc_phy_classifier_nphy(pi, 0, 0);\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0), 4);\r\nwlc_phy_clip_det_nphy(pi, 0, clip_state);\r\nwlc_phy_clip_det_nphy(pi, 1, clip_off);\r\nrf_pd_val = (rssi_type == NPHY_RSSI_SEL_NB) ? 0x6 : 0x4;\r\nrfctrlintc_override_val =\r\nCHSPEC_IS5G(pi->radio_chanspec) ? 0x140 : 0x110;\r\nrfctrlintc_state[0] = read_phy_reg(pi, 0x91);\r\nrfpdcorerxtx_state[0] = read_radio_reg(pi, RADIO_2055_PD_CORE1_RXTX);\r\nwrite_phy_reg(pi, 0x91, rfctrlintc_override_val);\r\nwrite_radio_reg(pi, RADIO_2055_PD_CORE1_RXTX, rf_pd_val);\r\nrfctrlintc_state[1] = read_phy_reg(pi, 0x92);\r\nrfpdcorerxtx_state[1] = read_radio_reg(pi, RADIO_2055_PD_CORE2_RXTX);\r\nwrite_phy_reg(pi, 0x92, rfctrlintc_override_val);\r\nwrite_radio_reg(pi, RADIO_2055_PD_CORE2_RXTX, rf_pd_val);\r\npd_mask = RADIO_2055_NBRSSI_PD | RADIO_2055_WBRSSI_G1_PD |\r\nRADIO_2055_WBRSSI_G2_PD;\r\npd_state[0] =\r\nread_radio_reg(pi, RADIO_2055_PD_CORE1_RSSI_MISC) & pd_mask;\r\npd_state[1] =\r\nread_radio_reg(pi, RADIO_2055_PD_CORE2_RSSI_MISC) & pd_mask;\r\nmod_radio_reg(pi, RADIO_2055_PD_CORE1_RSSI_MISC, pd_mask, 0);\r\nmod_radio_reg(pi, RADIO_2055_PD_CORE2_RSSI_MISC, pd_mask, 0);\r\nrssi_ctrl_mask = RADIO_2055_NBRSSI_SEL | RADIO_2055_WBRSSI_G1_SEL |\r\nRADIO_2055_WBRSSI_G2_SEL;\r\nrssi_ctrl_state[0] =\r\nread_radio_reg(pi, RADIO_2055_SP_RSSI_CORE1) & rssi_ctrl_mask;\r\nrssi_ctrl_state[1] =\r\nread_radio_reg(pi, RADIO_2055_SP_RSSI_CORE2) & rssi_ctrl_mask;\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_ALLRX, rssi_type);\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0, RADIO_MIMO_CORESEL_ALLRX,\r\nNPHY_RAIL_I, rssi_type);\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0, 0x0, RADIO_MIMO_CORESEL_ALLRX,\r\nNPHY_RAIL_Q, rssi_type);\r\nfor (vcm = 0; vcm < 4; vcm++) {\r\nvcm_tmp[0] = vcm_tmp[1] = vcm_tmp[2] = vcm_tmp[3] = vcm;\r\nif (rssi_type != NPHY_RSSI_SEL_W2)\r\nwlc_phy_set_rssi_2055_vcm(pi, rssi_type, vcm_tmp);\r\nwlc_phy_poll_rssi_nphy(pi, rssi_type, &poll_results[vcm][0],\r\nNPHY_RSSICAL_NPOLL);\r\nif ((rssi_type == NPHY_RSSI_SEL_W1)\r\n|| (rssi_type == NPHY_RSSI_SEL_W2)) {\r\nfor (ctr = 0; ctr < 2; ctr++)\r\npoll_miniq[vcm][ctr] =\r\nmin(poll_results[vcm][ctr * 2 + 0],\r\npoll_results[vcm][ctr * 2 + 1]);\r\n}\r\n}\r\nfor (result_idx = 0; result_idx < 4; result_idx++) {\r\nmin_d = NPHY_RSSICAL_MAXD;\r\nmin_vcm = 0;\r\nmin_poll = NPHY_RSSICAL_MAXREAD * NPHY_RSSICAL_NPOLL + 1;\r\nfor (vcm = 0; vcm < 4; vcm++) {\r\ncurr_d = abs(((rssi_type == NPHY_RSSI_SEL_NB) ?\r\npoll_results[vcm][result_idx] :\r\npoll_miniq[vcm][result_idx / 2]) -\r\n(target_code * NPHY_RSSICAL_NPOLL));\r\nif (curr_d < min_d) {\r\nmin_d = curr_d;\r\nmin_vcm = vcm;\r\n}\r\nif (poll_results[vcm][result_idx] < min_poll)\r\nmin_poll = poll_results[vcm][result_idx];\r\n}\r\nvcm_final[result_idx] = min_vcm;\r\npoll_results_min[result_idx] = min_poll;\r\n}\r\nif (rssi_type != NPHY_RSSI_SEL_W2)\r\nwlc_phy_set_rssi_2055_vcm(pi, rssi_type, vcm_final);\r\nfor (result_idx = 0; result_idx < 4; result_idx++) {\r\nfine_digital_offset[result_idx] =\r\n(target_code * NPHY_RSSICAL_NPOLL) -\r\npoll_results[vcm_final[result_idx]][result_idx];\r\nif (fine_digital_offset[result_idx] < 0) {\r\nfine_digital_offset[result_idx] =\r\nabs(fine_digital_offset[result_idx]);\r\nfine_digital_offset[result_idx] +=\r\n(NPHY_RSSICAL_NPOLL / 2);\r\nfine_digital_offset[result_idx] /= NPHY_RSSICAL_NPOLL;\r\nfine_digital_offset[result_idx] =\r\n-fine_digital_offset[result_idx];\r\n} else {\r\nfine_digital_offset[result_idx] +=\r\n(NPHY_RSSICAL_NPOLL / 2);\r\nfine_digital_offset[result_idx] /= NPHY_RSSICAL_NPOLL;\r\n}\r\nif (poll_results_min[result_idx] ==\r\nNPHY_RSSICAL_MAXREAD * NPHY_RSSICAL_NPOLL)\r\nfine_digital_offset[result_idx] =\r\n(target_code - NPHY_RSSICAL_MAXREAD - 1);\r\nwlc_phy_scale_offset_rssi_nphy(pi, 0x0,\r\n(s8)\r\nfine_digital_offset[result_idx],\r\n(result_idx / 2 ==\r\n0) ? RADIO_MIMO_CORESEL_CORE1 :\r\nRADIO_MIMO_CORESEL_CORE2,\r\n(result_idx % 2 ==\r\n0) ? NPHY_RAIL_I : NPHY_RAIL_Q,\r\nrssi_type);\r\n}\r\nmod_radio_reg(pi, RADIO_2055_PD_CORE1_RSSI_MISC, pd_mask, pd_state[0]);\r\nmod_radio_reg(pi, RADIO_2055_PD_CORE2_RSSI_MISC, pd_mask, pd_state[1]);\r\nif (rssi_ctrl_state[0] == RADIO_2055_NBRSSI_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE1,\r\nNPHY_RSSI_SEL_NB);\r\nelse if (rssi_ctrl_state[0] == RADIO_2055_WBRSSI_G1_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE1,\r\nNPHY_RSSI_SEL_W1);\r\nelse if (rssi_ctrl_state[0] == RADIO_2055_WBRSSI_G2_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE1,\r\nNPHY_RSSI_SEL_W2);\r\nelse\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE1,\r\nNPHY_RSSI_SEL_W2);\r\nif (rssi_ctrl_state[1] == RADIO_2055_NBRSSI_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RSSI_SEL_NB);\r\nelse if (rssi_ctrl_state[1] == RADIO_2055_WBRSSI_G1_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RSSI_SEL_W1);\r\nelse if (rssi_ctrl_state[1] == RADIO_2055_WBRSSI_G2_SEL)\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RSSI_SEL_W2);\r\nelse\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_CORE2,\r\nNPHY_RSSI_SEL_W2);\r\nwlc_phy_rssisel_nphy(pi, RADIO_MIMO_CORESEL_OFF, rssi_type);\r\nwrite_phy_reg(pi, 0x91, rfctrlintc_state[0]);\r\nwrite_radio_reg(pi, RADIO_2055_PD_CORE1_RXTX, rfpdcorerxtx_state[0]);\r\nwrite_phy_reg(pi, 0x92, rfctrlintc_state[1]);\r\nwrite_radio_reg(pi, RADIO_2055_PD_CORE2_RXTX, rfpdcorerxtx_state[1]);\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0), classif_state);\r\nwlc_phy_clip_det_nphy(pi, 1, clip_state);\r\nwlc_phy_resetcca_nphy(pi);\r\n}\r\nvoid wlc_phy_rssi_cal_nphy(struct brcms_phy *pi)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwlc_phy_rssi_cal_nphy_rev3(pi);\r\n} else {\r\nwlc_phy_rssi_cal_nphy_rev2(pi, NPHY_RSSI_SEL_NB);\r\nwlc_phy_rssi_cal_nphy_rev2(pi, NPHY_RSSI_SEL_W1);\r\nwlc_phy_rssi_cal_nphy_rev2(pi, NPHY_RSSI_SEL_W2);\r\n}\r\n}\r\nint\r\nwlc_phy_rssi_compute_nphy(struct brcms_phy *pi, struct d11rxhdr *rxh)\r\n{\r\ns16 rxpwr, rxpwr0, rxpwr1;\r\ns16 phyRx0_l, phyRx2_l;\r\nrxpwr = 0;\r\nrxpwr0 = rxh->PhyRxStatus_1 & PRXS1_nphy_PWR0_MASK;\r\nrxpwr1 = (rxh->PhyRxStatus_1 & PRXS1_nphy_PWR1_MASK) >> 8;\r\nif (rxpwr0 > 127)\r\nrxpwr0 -= 256;\r\nif (rxpwr1 > 127)\r\nrxpwr1 -= 256;\r\nphyRx0_l = rxh->PhyRxStatus_0 & 0x00ff;\r\nphyRx2_l = rxh->PhyRxStatus_2 & 0x00ff;\r\nif (phyRx2_l > 127)\r\nphyRx2_l -= 256;\r\nif (((rxpwr0 == 16) || (rxpwr0 == 32))) {\r\nrxpwr0 = rxpwr1;\r\nrxpwr1 = phyRx2_l;\r\n}\r\nif (pi->sh->rssi_mode == RSSI_ANT_MERGE_MAX)\r\nrxpwr = (rxpwr0 > rxpwr1) ? rxpwr0 : rxpwr1;\r\nelse if (pi->sh->rssi_mode == RSSI_ANT_MERGE_MIN)\r\nrxpwr = (rxpwr0 < rxpwr1) ? rxpwr0 : rxpwr1;\r\nelse if (pi->sh->rssi_mode == RSSI_ANT_MERGE_AVG)\r\nrxpwr = (rxpwr0 + rxpwr1) >> 1;\r\nreturn rxpwr;\r\n}\r\nstatic void\r\nwlc_phy_loadsampletable_nphy(struct brcms_phy *pi, struct cordic_iq *tone_buf,\r\nu16 num_samps)\r\n{\r\nu16 t;\r\nu32 *data_buf = NULL;\r\ndata_buf = kmalloc(sizeof(u32) * num_samps, GFP_ATOMIC);\r\nif (data_buf == NULL)\r\nreturn;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nfor (t = 0; t < num_samps; t++)\r\ndata_buf[t] = ((((unsigned int)tone_buf[t].i) & 0x3ff) << 10) |\r\n(((unsigned int)tone_buf[t].q) & 0x3ff);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_SAMPLEPLAY, num_samps, 0, 32,\r\ndata_buf);\r\nkfree(data_buf);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic u16\r\nwlc_phy_gen_load_samples_nphy(struct brcms_phy *pi, u32 f_kHz, u16 max_val,\r\nu8 dac_test_mode)\r\n{\r\nu8 phy_bw, is_phybw40;\r\nu16 num_samps, t, spur;\r\ns32 theta = 0, rot = 0;\r\nu32 tbl_len;\r\nstruct cordic_iq *tone_buf = NULL;\r\nis_phybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\nphy_bw = (is_phybw40 == 1) ? 40 : 20;\r\ntbl_len = (phy_bw << 3);\r\nif (dac_test_mode == 1) {\r\nspur = read_phy_reg(pi, 0x01);\r\nspur = (spur >> 15) & 1;\r\nphy_bw = (spur == 1) ? 82 : 80;\r\nphy_bw = (is_phybw40 == 1) ? (phy_bw << 1) : phy_bw;\r\ntbl_len = (phy_bw << 1);\r\n}\r\ntone_buf = kmalloc(sizeof(struct cordic_iq) * tbl_len, GFP_ATOMIC);\r\nif (tone_buf == NULL)\r\nreturn 0;\r\nnum_samps = (u16) tbl_len;\r\nrot = ((f_kHz * 36) / phy_bw) / 100;\r\ntheta = 0;\r\nfor (t = 0; t < num_samps; t++) {\r\ntone_buf[t] = cordic_calc_iq(theta);\r\ntheta += rot;\r\ntone_buf[t].q = (s32) FLOAT(tone_buf[t].q * max_val);\r\ntone_buf[t].i = (s32) FLOAT(tone_buf[t].i * max_val);\r\n}\r\nwlc_phy_loadsampletable_nphy(pi, tone_buf, num_samps);\r\nkfree(tone_buf);\r\nreturn num_samps;\r\n}\r\nstatic void\r\nwlc_phy_runsamples_nphy(struct brcms_phy *pi, u16 num_samps, u16 loops,\r\nu16 wait, u8 iqmode, u8 dac_test_mode,\r\nbool modify_bbmult)\r\n{\r\nu16 bb_mult;\r\nu8 phy_bw, sample_cmd;\r\nu16 orig_RfseqCoreActv;\r\nu16 lpf_bw_ctl_override3, lpf_bw_ctl_override4, lpf_bw_ctl_miscreg3,\r\nlpf_bw_ctl_miscreg4;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nphy_bw = 20;\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\nphy_bw = 40;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nlpf_bw_ctl_override3 = read_phy_reg(pi, 0x342) & (0x1 << 7);\r\nlpf_bw_ctl_override4 = read_phy_reg(pi, 0x343) & (0x1 << 7);\r\nif (lpf_bw_ctl_override3 | lpf_bw_ctl_override4) {\r\nlpf_bw_ctl_miscreg3 = read_phy_reg(pi, 0x340) &\r\n(0x7 << 8);\r\nlpf_bw_ctl_miscreg4 = read_phy_reg(pi, 0x341) &\r\n(0x7 << 8);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 7),\r\nwlc_phy_read_lpf_bw_ctl_nphy\r\n(pi,\r\n0), 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\npi->nphy_sample_play_lpf_bw_ctl_ovr = true;\r\nlpf_bw_ctl_miscreg3 = read_phy_reg(pi, 0x340) &\r\n(0x7 << 8);\r\nlpf_bw_ctl_miscreg4 = read_phy_reg(pi, 0x341) &\r\n(0x7 << 8);\r\n}\r\n}\r\nif ((pi->nphy_bb_mult_save & BB_MULT_VALID_MASK) == 0) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL, 1, 87, 16,\r\n&bb_mult);\r\npi->nphy_bb_mult_save =\r\nBB_MULT_VALID_MASK | (bb_mult & BB_MULT_MASK);\r\n}\r\nif (modify_bbmult) {\r\nbb_mult = (phy_bw == 20) ? 100 : 71;\r\nbb_mult = (bb_mult << 8) + bb_mult;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 1, 87, 16,\r\n&bb_mult);\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nwrite_phy_reg(pi, 0xc6, num_samps - 1);\r\nif (loops != 0xffff)\r\nwrite_phy_reg(pi, 0xc4, loops - 1);\r\nelse\r\nwrite_phy_reg(pi, 0xc4, loops);\r\nwrite_phy_reg(pi, 0xc5, wait);\r\norig_RfseqCoreActv = read_phy_reg(pi, 0xa1);\r\nor_phy_reg(pi, 0xa1, NPHY_RfseqMode_CoreActv_override);\r\nif (iqmode) {\r\nand_phy_reg(pi, 0xc2, 0x7FFF);\r\nor_phy_reg(pi, 0xc2, 0x8000);\r\n} else {\r\nsample_cmd = (dac_test_mode == 1) ? 0x5 : 0x1;\r\nwrite_phy_reg(pi, 0xc3, sample_cmd);\r\n}\r\nSPINWAIT(((read_phy_reg(pi, 0xa4) & 0x1) == 1), 1000);\r\nwrite_phy_reg(pi, 0xa1, orig_RfseqCoreActv);\r\n}\r\nint\r\nwlc_phy_tx_tone_nphy(struct brcms_phy *pi, u32 f_kHz, u16 max_val,\r\nu8 iqmode, u8 dac_test_mode, bool modify_bbmult)\r\n{\r\nu16 num_samps;\r\nu16 loops = 0xffff;\r\nu16 wait = 0;\r\nnum_samps = wlc_phy_gen_load_samples_nphy(pi, f_kHz, max_val,\r\ndac_test_mode);\r\nif (num_samps == 0)\r\nreturn -EBADE;\r\nwlc_phy_runsamples_nphy(pi, num_samps, loops, wait, iqmode,\r\ndac_test_mode, modify_bbmult);\r\nreturn 0;\r\n}\r\nvoid wlc_phy_stopplayback_nphy(struct brcms_phy *pi)\r\n{\r\nu16 playback_status;\r\nu16 bb_mult;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nplayback_status = read_phy_reg(pi, 0xc7);\r\nif (playback_status & 0x1)\r\nor_phy_reg(pi, 0xc3, NPHY_sampleCmd_STOP);\r\nelse if (playback_status & 0x2)\r\nand_phy_reg(pi, 0xc2,\r\n(u16) ~NPHY_iqloCalCmdGctl_IQLO_CAL_EN);\r\nand_phy_reg(pi, 0xc3, (u16) ~(0x1 << 2));\r\nif ((pi->nphy_bb_mult_save & BB_MULT_VALID_MASK) != 0) {\r\nbb_mult = pi->nphy_bb_mult_save & BB_MULT_MASK;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 1, 87, 16,\r\n&bb_mult);\r\npi->nphy_bb_mult_save = 0;\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 7) || NREV_GE(pi->pubpi.phy_rev, 8)) {\r\nif (pi->nphy_sample_play_lpf_bw_ctl_ovr) {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 7),\r\n0, 0, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\npi->nphy_sample_play_lpf_bw_ctl_ovr = false;\r\n}\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic u32 *brcms_phy_get_tx_pwrctrl_tbl(struct brcms_phy *pi)\r\n{\r\nu32 *tx_pwrctrl_tbl = NULL;\r\nuint phyrev = pi->pubpi.phy_rev;\r\nif (PHY_IPA(pi)) {\r\ntx_pwrctrl_tbl =\r\nwlc_phy_get_ipa_gaintbl_nphy(pi);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_IS(phyrev, 3))\r\ntx_pwrctrl_tbl = nphy_tpc_5GHz_txgain_rev3;\r\nelse if (NREV_IS(phyrev, 4))\r\ntx_pwrctrl_tbl =\r\n(pi->srom_fem5g.extpagain == 3) ?\r\nnphy_tpc_5GHz_txgain_HiPwrEPA :\r\nnphy_tpc_5GHz_txgain_rev4;\r\nelse\r\ntx_pwrctrl_tbl = nphy_tpc_5GHz_txgain_rev5;\r\n} else {\r\nif (NREV_GE(phyrev, 7)) {\r\nif (pi->pubpi.radiorev == 3)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_epa_2057rev3;\r\nelse if (pi->pubpi.radiorev == 5)\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_epa_2057rev5;\r\n} else {\r\nif (NREV_GE(phyrev, 5) &&\r\n(pi->srom_fem2g.extpagain == 3))\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_HiPwrEPA;\r\nelse\r\ntx_pwrctrl_tbl =\r\nnphy_tpc_txgain_rev3;\r\n}\r\n}\r\n}\r\nreturn tx_pwrctrl_tbl;\r\n}\r\nstruct nphy_txgains wlc_phy_get_tx_gain_nphy(struct brcms_phy *pi)\r\n{\r\nu16 base_idx[2], curr_gain[2];\r\nu8 core_no;\r\nstruct nphy_txgains target_gain;\r\nu32 *tx_pwrctrl_tbl = NULL;\r\nif (pi->nphy_txpwrctrl == PHY_TPC_HW_OFF) {\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ncurr_gain);\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nfor (core_no = 0; core_no < 2; core_no++) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\ntarget_gain.ipa[core_no] =\r\ncurr_gain[core_no] & 0x0007;\r\ntarget_gain.pad[core_no] =\r\n((curr_gain[core_no] & 0x00F8) >> 3);\r\ntarget_gain.pga[core_no] =\r\n((curr_gain[core_no] & 0x0F00) >> 8);\r\ntarget_gain.txgm[core_no] =\r\n((curr_gain[core_no] & 0x7000) >> 12);\r\ntarget_gain.txlpf[core_no] =\r\n((curr_gain[core_no] & 0x8000) >> 15);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\ntarget_gain.ipa[core_no] =\r\ncurr_gain[core_no] & 0x000F;\r\ntarget_gain.pad[core_no] =\r\n((curr_gain[core_no] & 0x00F0) >> 4);\r\ntarget_gain.pga[core_no] =\r\n((curr_gain[core_no] & 0x0F00) >> 8);\r\ntarget_gain.txgm[core_no] =\r\n((curr_gain[core_no] & 0x7000) >> 12);\r\n} else {\r\ntarget_gain.ipa[core_no] =\r\ncurr_gain[core_no] & 0x0003;\r\ntarget_gain.pad[core_no] =\r\n((curr_gain[core_no] & 0x000C) >> 2);\r\ntarget_gain.pga[core_no] =\r\n((curr_gain[core_no] & 0x0070) >> 4);\r\ntarget_gain.txgm[core_no] =\r\n((curr_gain[core_no] & 0x0380) >> 7);\r\n}\r\n}\r\n} else {\r\nuint phyrev = pi->pubpi.phy_rev;\r\nbase_idx[0] = (read_phy_reg(pi, 0x1ed) >> 8) & 0x7f;\r\nbase_idx[1] = (read_phy_reg(pi, 0x1ee) >> 8) & 0x7f;\r\nfor (core_no = 0; core_no < 2; core_no++) {\r\nif (NREV_GE(phyrev, 3)) {\r\ntx_pwrctrl_tbl =\r\nbrcms_phy_get_tx_pwrctrl_tbl(pi);\r\nif (NREV_GE(phyrev, 7)) {\r\ntarget_gain.ipa[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 16) & 0x7;\r\ntarget_gain.pad[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 19) & 0x1f;\r\ntarget_gain.pga[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 24) & 0xf;\r\ntarget_gain.txgm[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 28) & 0x7;\r\ntarget_gain.txlpf[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 31) & 0x1;\r\n} else {\r\ntarget_gain.ipa[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 16) & 0xf;\r\ntarget_gain.pad[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 20) & 0xf;\r\ntarget_gain.pga[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 24) & 0xf;\r\ntarget_gain.txgm[core_no] =\r\n(tx_pwrctrl_tbl\r\n[base_idx[core_no]]\r\n>> 28) & 0x7;\r\n}\r\n} else {\r\ntarget_gain.ipa[core_no] =\r\n(nphy_tpc_txgain[base_idx[core_no]] >>\r\n16) & 0x3;\r\ntarget_gain.pad[core_no] =\r\n(nphy_tpc_txgain[base_idx[core_no]] >>\r\n18) & 0x3;\r\ntarget_gain.pga[core_no] =\r\n(nphy_tpc_txgain[base_idx[core_no]] >>\r\n20) & 0x7;\r\ntarget_gain.txgm[core_no] =\r\n(nphy_tpc_txgain[base_idx[core_no]] >>\r\n23) & 0x7;\r\n}\r\n}\r\n}\r\nreturn target_gain;\r\n}\r\nstatic void\r\nwlc_phy_iqcal_gainparams_nphy(struct brcms_phy *pi, u16 core_no,\r\nstruct nphy_txgains target_gain,\r\nstruct nphy_iqcal_params *params)\r\n{\r\nu8 k;\r\nint idx;\r\nu16 gain_index;\r\nu8 band_idx = (CHSPEC_IS5G(pi->radio_chanspec) ? 1 : 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nparams->txlpf = target_gain.txlpf[core_no];\r\nparams->txgm = target_gain.txgm[core_no];\r\nparams->pga = target_gain.pga[core_no];\r\nparams->pad = target_gain.pad[core_no];\r\nparams->ipa = target_gain.ipa[core_no];\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nparams->cal_gain =\r\n((params->txlpf << 15) | (params->txgm << 12) |\r\n(params->pga << 8) |\r\n(params->pad << 3) | (params->ipa));\r\nelse\r\nparams->cal_gain =\r\n((params->txgm << 12) | (params->pga << 8) |\r\n(params->pad << 4) | (params->ipa));\r\nparams->ncorr[0] = 0x79;\r\nparams->ncorr[1] = 0x79;\r\nparams->ncorr[2] = 0x79;\r\nparams->ncorr[3] = 0x79;\r\nparams->ncorr[4] = 0x79;\r\n} else {\r\ngain_index = ((target_gain.pad[core_no] << 0) |\r\n(target_gain.pga[core_no] << 4) |\r\n(target_gain.txgm[core_no] << 8));\r\nidx = -1;\r\nfor (k = 0; k < NPHY_IQCAL_NUMGAINS; k++) {\r\nif (tbl_iqcal_gainparams_nphy[band_idx][k][0] ==\r\ngain_index) {\r\nidx = k;\r\nbreak;\r\n}\r\n}\r\nparams->txgm = tbl_iqcal_gainparams_nphy[band_idx][k][1];\r\nparams->pga = tbl_iqcal_gainparams_nphy[band_idx][k][2];\r\nparams->pad = tbl_iqcal_gainparams_nphy[band_idx][k][3];\r\nparams->cal_gain = ((params->txgm << 7) | (params->pga << 4) |\r\n(params->pad << 2));\r\nparams->ncorr[0] = tbl_iqcal_gainparams_nphy[band_idx][k][4];\r\nparams->ncorr[1] = tbl_iqcal_gainparams_nphy[band_idx][k][5];\r\nparams->ncorr[2] = tbl_iqcal_gainparams_nphy[band_idx][k][6];\r\nparams->ncorr[3] = tbl_iqcal_gainparams_nphy[band_idx][k][7];\r\n}\r\n}\r\nstatic void wlc_phy_txcal_radio_setup_nphy(struct brcms_phy *pi)\r\n{\r\nu16 jtag_core, core;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (core = 0; core <= 1; core++) {\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 0] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 1] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_VCM_HG);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 2] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_IDAC);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 3] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_VCM);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 4] = 0;\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 5] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MUX);\r\nif (pi->pubpi.radiorev != 5)\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 6] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore,\r\nTSSIA);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 7] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core, TSSIG);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 8] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_MISC1);\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER, 0x0a);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_VCM_HG, 0x43);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_IDAC, 0x55);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_VCM, 0x00);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSIG, 0x00);\r\nif (pi->use_int_tx_iqlo_cal_nphy) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TX_SSI_MUX, 0x4);\r\nif (!(pi->\r\ninternal_tx_iqlo_cal_tapoff_intpa_nphy))\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIA, 0x31);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIA, 0x21);\r\n}\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_MISC1, 0x00);\r\n} else {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER, 0x06);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_VCM_HG, 0x43);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nIQCAL_IDAC, 0x55);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_VCM, 0x00);\r\nif (pi->pubpi.radiorev != 5)\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TSSIA, 0x00);\r\nif (pi->use_int_tx_iqlo_cal_nphy) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX,\r\ncore, TX_SSI_MUX,\r\n0x06);\r\nif (!(pi->\r\ninternal_tx_iqlo_cal_tapoff_intpa_nphy))\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIG, 0x31);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057,\r\nTX, core,\r\nTSSIG, 0x21);\r\n}\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSI_MISC1, 0x00);\r\n}\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nfor (core = 0; core <= 1; core++) {\r\njtag_core =\r\n(core ==\r\nPHY_CORE_0) ? RADIO_2056_TX0 : RADIO_2056_TX1;\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MASTER |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_VCM_HG |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 2] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_IDAC |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 3] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_TX_TSSI_VCM |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 4] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TX_AMP_DET |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 5] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MUX |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 6] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TSSIA | jtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 7] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TSSIG | jtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 8] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC1 |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 9] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC2 |\r\njtag_core);\r\npi->tx_rx_cal_radio_saveregs[(core * 11) + 10] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC3 |\r\njtag_core);\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MASTER |\r\njtag_core, 0x0a);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_VCM_HG |\r\njtag_core, 0x40);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_IDAC |\r\njtag_core, 0x55);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_VCM |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_AMP_DET |\r\njtag_core, 0x00);\r\nif (PHY_IPA(pi)) {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TX_SSI_MUX\r\n| jtag_core, 0x4);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSIA |\r\njtag_core, 0x1);\r\n} else {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TX_SSI_MUX\r\n| jtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSIA |\r\njtag_core, 0x2f);\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSIG | jtag_core,\r\n0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC1 |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC2 |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC3 |\r\njtag_core, 0x00);\r\n} else {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MASTER |\r\njtag_core, 0x06);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_VCM_HG |\r\njtag_core, 0x40);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_IDAC |\r\njtag_core, 0x55);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_VCM |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_AMP_DET |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSIA | jtag_core,\r\n0x00);\r\nif (PHY_IPA(pi)) {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TX_SSI_MUX\r\n| jtag_core, 0x06);\r\nif (NREV_LT(pi->pubpi.phy_rev, 5))\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TSSIG\r\n| jtag_core,\r\n0x11);\r\nelse\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TSSIG\r\n| jtag_core,\r\n0x1);\r\n} else {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TX_SSI_MUX\r\n| jtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSIG |\r\njtag_core, 0x20);\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC1 |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC2 |\r\njtag_core, 0x00);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC3 |\r\njtag_core, 0x00);\r\n}\r\n}\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1, 0x29);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2, 0x54);\r\npi->tx_rx_cal_radio_saveregs[2] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1, 0x29);\r\npi->tx_rx_cal_radio_saveregs[3] =\r\nread_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2, 0x54);\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1);\r\npi->tx_rx_cal_radio_saveregs[5] =\r\nread_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2);\r\nif ((read_phy_reg(pi, 0x09) & NPHY_BandControl_currentBand) ==\r\n0) {\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1, 0x04);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2, 0x04);\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1, 0x20);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2, 0x20);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nor_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM, 0x20);\r\nor_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM, 0x20);\r\n} else {\r\nand_radio_reg(pi, RADIO_2055_CORE1_TX_BB_MXGM, 0xdf);\r\nand_radio_reg(pi, RADIO_2055_CORE2_TX_BB_MXGM, 0xdf);\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_txcal_radio_cleanup_nphy(struct brcms_phy *pi)\r\n{\r\nu16 jtag_core, core;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (core = 0; core <= 1; core++) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTX_SSI_MASTER,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n0]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, IQCAL_VCM_HG,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n1]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, IQCAL_IDAC,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n2]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TSSI_VCM,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n3]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TX_SSI_MUX,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n5]);\r\nif (pi->pubpi.radiorev != 5)\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTSSIA,\r\npi->tx_rx_cal_radio_saveregs\r\n[(core * 11) + 6]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TSSIG,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n7]);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core, TSSI_MISC1,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n8]);\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nfor (core = 0; core <= 1; core++) {\r\njtag_core = (core == PHY_CORE_0) ?\r\nRADIO_2056_TX0 : RADIO_2056_TX1;\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MASTER | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n0]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_VCM_HG | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n1]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_IQCAL_IDAC | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n2]);\r\nwrite_radio_reg(pi, RADIO_2056_TX_TSSI_VCM | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n3]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_AMP_DET | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n4]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TX_SSI_MUX | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n5]);\r\nwrite_radio_reg(pi, RADIO_2056_TX_TSSIA | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n6]);\r\nwrite_radio_reg(pi, RADIO_2056_TX_TSSIG | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n7]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC1 | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n8]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC2 | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n9]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TSSI_MISC3 | jtag_core,\r\npi->\r\ntx_rx_cal_radio_saveregs[(core * 11) +\r\n10]);\r\n}\r\n} else {\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL1,\r\npi->tx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE1_TXRF_IQCAL2,\r\npi->tx_rx_cal_radio_saveregs[1]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL1,\r\npi->tx_rx_cal_radio_saveregs[2]);\r\nwrite_radio_reg(pi, RADIO_2055_CORE2_TXRF_IQCAL2,\r\npi->tx_rx_cal_radio_saveregs[3]);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE1,\r\npi->tx_rx_cal_radio_saveregs[4]);\r\nwrite_radio_reg(pi, RADIO_2055_PWRDET_RXTX_CORE2,\r\npi->tx_rx_cal_radio_saveregs[5]);\r\n}\r\n}\r\nstatic void wlc_phy_txcal_physetup_nphy(struct brcms_phy *pi)\r\n{\r\nu16 val, mask;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\npi->tx_rx_cal_phy_saveregs[0] = read_phy_reg(pi, 0xa6);\r\npi->tx_rx_cal_phy_saveregs[1] = read_phy_reg(pi, 0xa7);\r\nmask = ((0x3 << 8) | (0x3 << 10));\r\nval = (0x2 << 8);\r\nval |= (0x2 << 10);\r\nmod_phy_reg(pi, 0xa6, mask, val);\r\nmod_phy_reg(pi, 0xa7, mask, val);\r\nval = read_phy_reg(pi, 0x8f);\r\npi->tx_rx_cal_phy_saveregs[2] = val;\r\nval |= ((0x1 << 9) | (0x1 << 10));\r\nwrite_phy_reg(pi, 0x8f, val);\r\nval = read_phy_reg(pi, 0xa5);\r\npi->tx_rx_cal_phy_saveregs[3] = val;\r\nval |= ((0x1 << 9) | (0x1 << 10));\r\nwrite_phy_reg(pi, 0xa5, val);\r\npi->tx_rx_cal_phy_saveregs[4] = read_phy_reg(pi, 0x01);\r\nmod_phy_reg(pi, 0x01, (0x1 << 15), 0);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 3, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[5] = val;\r\nval = 0;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 3, 16,\r\n&val);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 19, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[6] = val;\r\nval = 0;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 19, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[7] = read_phy_reg(pi, 0x91);\r\npi->tx_rx_cal_phy_saveregs[8] = read_phy_reg(pi, 0x92);\r\nif (!(pi->use_int_tx_iqlo_cal_nphy))\r\nwlc_phy_rfctrlintc_override_nphy(\r\npi,\r\nNPHY_RfctrlIntc_override_PA,\r\n1,\r\nRADIO_MIMO_CORESEL_CORE1\r\n|\r\nRADIO_MIMO_CORESEL_CORE2);\r\nelse\r\nwlc_phy_rfctrlintc_override_nphy(\r\npi,\r\nNPHY_RfctrlIntc_override_PA,\r\n0,\r\nRADIO_MIMO_CORESEL_CORE1\r\n|\r\nRADIO_MIMO_CORESEL_CORE2);\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x2, RADIO_MIMO_CORESEL_CORE1);\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x8, RADIO_MIMO_CORESEL_CORE2);\r\npi->tx_rx_cal_phy_saveregs[9] = read_phy_reg(pi, 0x297);\r\npi->tx_rx_cal_phy_saveregs[10] = read_phy_reg(pi, 0x29b);\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)\r\n|| NREV_GE(pi->pubpi.phy_rev, 8))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 7),\r\nwlc_phy_read_lpf_bw_ctl_nphy\r\n(pi,\r\n0), 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nif (pi->use_int_tx_iqlo_cal_nphy\r\n&& !(pi->internal_tx_iqlo_cal_tapoff_intpa_nphy)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)) {\r\nmod_radio_reg(pi, RADIO_2057_OVR_REG0, 1 << 4,\r\n1 << 4);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE0,\r\n1, 0);\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE1,\r\n1, 0);\r\n} else {\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_IPA5G_CASCOFFV_PU_CORE0,\r\n1, 0);\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_IPA5G_CASCOFFV_PU_CORE1,\r\n1, 0);\r\n}\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 8)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 3), 0,\r\n0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\n}\r\n}\r\n} else {\r\npi->tx_rx_cal_phy_saveregs[0] = read_phy_reg(pi, 0xa6);\r\npi->tx_rx_cal_phy_saveregs[1] = read_phy_reg(pi, 0xa7);\r\nmask = ((0x3 << 12) | (0x3 << 14));\r\nval = (0x2 << 12);\r\nval |= (0x2 << 14);\r\nmod_phy_reg(pi, 0xa6, mask, val);\r\nmod_phy_reg(pi, 0xa7, mask, val);\r\nval = read_phy_reg(pi, 0xa5);\r\npi->tx_rx_cal_phy_saveregs[2] = val;\r\nval |= ((0x1 << 12) | (0x1 << 13));\r\nwrite_phy_reg(pi, 0xa5, val);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 2, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[3] = val;\r\nval |= 0x2000;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 2, 16,\r\n&val);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 18, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[4] = val;\r\nval |= 0x2000;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 18, 16,\r\n&val);\r\npi->tx_rx_cal_phy_saveregs[5] = read_phy_reg(pi, 0x91);\r\npi->tx_rx_cal_phy_saveregs[6] = read_phy_reg(pi, 0x92);\r\nval = CHSPEC_IS5G(pi->radio_chanspec) ? 0x180 : 0x120;\r\nwrite_phy_reg(pi, 0x91, val);\r\nwrite_phy_reg(pi, 0x92, val);\r\n}\r\n}\r\nstatic void wlc_phy_txcal_phycleanup_nphy(struct brcms_phy *pi)\r\n{\r\nu16 mask;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwrite_phy_reg(pi, 0xa6, pi->tx_rx_cal_phy_saveregs[0]);\r\nwrite_phy_reg(pi, 0xa7, pi->tx_rx_cal_phy_saveregs[1]);\r\nwrite_phy_reg(pi, 0x8f, pi->tx_rx_cal_phy_saveregs[2]);\r\nwrite_phy_reg(pi, 0xa5, pi->tx_rx_cal_phy_saveregs[3]);\r\nwrite_phy_reg(pi, 0x01, pi->tx_rx_cal_phy_saveregs[4]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 3, 16,\r\n&pi->tx_rx_cal_phy_saveregs[5]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 19, 16,\r\n&pi->tx_rx_cal_phy_saveregs[6]);\r\nwrite_phy_reg(pi, 0x91, pi->tx_rx_cal_phy_saveregs[7]);\r\nwrite_phy_reg(pi, 0x92, pi->tx_rx_cal_phy_saveregs[8]);\r\nwrite_phy_reg(pi, 0x297, pi->tx_rx_cal_phy_saveregs[9]);\r\nwrite_phy_reg(pi, 0x29b, pi->tx_rx_cal_phy_saveregs[10]);\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)\r\n|| NREV_GE(pi->pubpi.phy_rev, 8))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 7), 0, 0,\r\n1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_resetcca_nphy(pi);\r\nif (pi->use_int_tx_iqlo_cal_nphy\r\n&& !(pi->internal_tx_iqlo_cal_tapoff_intpa_nphy)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE0,\r\n1, 1);\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_PAD2G_TUNE_PUS_CORE1,\r\n1, 1);\r\n} else {\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_IPA5G_CASCOFFV_PU_CORE0,\r\n1, 1);\r\nmod_radio_reg(\r\npi,\r\nRADIO_2057_IPA5G_CASCOFFV_PU_CORE1,\r\n1, 1);\r\n}\r\nmod_radio_reg(pi, RADIO_2057_OVR_REG0, 1 << 4,\r\n0);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 8)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 3), 0,\r\n0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\n}\r\n}\r\n} else {\r\nmask = ((0x3 << 12) | (0x3 << 14));\r\nmod_phy_reg(pi, 0xa6, mask, pi->tx_rx_cal_phy_saveregs[0]);\r\nmod_phy_reg(pi, 0xa7, mask, pi->tx_rx_cal_phy_saveregs[1]);\r\nwrite_phy_reg(pi, 0xa5, pi->tx_rx_cal_phy_saveregs[2]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 2, 16,\r\n&pi->tx_rx_cal_phy_saveregs[3]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_AFECTRL, 1, 18, 16,\r\n&pi->tx_rx_cal_phy_saveregs[4]);\r\nwrite_phy_reg(pi, 0x91, pi->tx_rx_cal_phy_saveregs[5]);\r\nwrite_phy_reg(pi, 0x92, pi->tx_rx_cal_phy_saveregs[6]);\r\n}\r\n}\r\nvoid\r\nwlc_phy_est_tonepwr_nphy(struct brcms_phy *pi, s32 *qdBm_pwrbuf, u8 num_samps)\r\n{\r\nu16 tssi_reg;\r\ns32 temp, pwrindex[2];\r\ns32 idle_tssi[2];\r\ns32 rssi_buf[4];\r\ns32 tssival[2];\r\nu8 tssi_type;\r\ntssi_reg = read_phy_reg(pi, 0x1e9);\r\ntemp = (s32) (tssi_reg & 0x3f);\r\nidle_tssi[0] = (temp <= 31) ? temp : (temp - 64);\r\ntemp = (s32) ((tssi_reg >> 8) & 0x3f);\r\nidle_tssi[1] = (temp <= 31) ? temp : (temp - 64);\r\ntssi_type =\r\nCHSPEC_IS5G(pi->radio_chanspec) ?\r\n(u8)NPHY_RSSI_SEL_TSSI_5G : (u8)NPHY_RSSI_SEL_TSSI_2G;\r\nwlc_phy_poll_rssi_nphy(pi, tssi_type, rssi_buf, num_samps);\r\ntssival[0] = rssi_buf[0] / ((s32) num_samps);\r\ntssival[1] = rssi_buf[2] / ((s32) num_samps);\r\npwrindex[0] = idle_tssi[0] - tssival[0] + 64;\r\npwrindex[1] = idle_tssi[1] - tssival[1] + 64;\r\nif (pwrindex[0] < 0)\r\npwrindex[0] = 0;\r\nelse if (pwrindex[0] > 63)\r\npwrindex[0] = 63;\r\nif (pwrindex[1] < 0)\r\npwrindex[1] = 0;\r\nelse if (pwrindex[1] > 63)\r\npwrindex[1] = 63;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_CORE1TXPWRCTL, 1,\r\n(u32) pwrindex[0], 32, &qdBm_pwrbuf[0]);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_CORE2TXPWRCTL, 1,\r\n(u32) pwrindex[1], 32, &qdBm_pwrbuf[1]);\r\n}\r\nstatic void wlc_phy_update_txcal_ladder_nphy(struct brcms_phy *pi, u16 core)\r\n{\r\nint index;\r\nu32 bbmult_scale;\r\nu16 bbmult;\r\nu16 tblentry;\r\nstruct nphy_txiqcal_ladder ladder_lo[] = {\r\n{3, 0}, {4, 0}, {6, 0}, {9, 0}, {13, 0}, {18, 0},\r\n{25, 0}, {25, 1}, {25, 2}, {25, 3}, {25, 4}, {25, 5},\r\n{25, 6}, {25, 7}, {35, 7}, {50, 7}, {71, 7}, {100, 7}\r\n};\r\nstruct nphy_txiqcal_ladder ladder_iq[] = {\r\n{3, 0}, {4, 0}, {6, 0}, {9, 0}, {13, 0}, {18, 0},\r\n{25, 0}, {35, 0}, {50, 0}, {71, 0}, {100, 0}, {100, 1},\r\n{100, 2}, {100, 3}, {100, 4}, {100, 5}, {100, 6}, {100, 7}\r\n};\r\nbbmult = (core == PHY_CORE_0) ?\r\n((pi->nphy_txcal_bbmult >> 8) & 0xff) :\r\n(pi->nphy_txcal_bbmult & 0xff);\r\nfor (index = 0; index < 18; index++) {\r\nbbmult_scale = ladder_lo[index].percent * bbmult;\r\nbbmult_scale /= 100;\r\ntblentry =\r\n((bbmult_scale & 0xff) << 8) | ladder_lo[index].g_env;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 1, index, 16,\r\n&tblentry);\r\nbbmult_scale = ladder_iq[index].percent * bbmult;\r\nbbmult_scale /= 100;\r\ntblentry =\r\n((bbmult_scale & 0xff) << 8) | ladder_iq[index].g_env;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 1, index + 32,\r\n16, &tblentry);\r\n}\r\n}\r\nstatic u8 wlc_phy_txpwr_idx_cur_get_nphy(struct brcms_phy *pi, u8 core)\r\n{\r\nu16 tmp;\r\ntmp = read_phy_reg(pi, ((core == PHY_CORE_0) ? 0x1ed : 0x1ee));\r\ntmp = (tmp & (0x7f << 8)) >> 8;\r\nreturn (u8) tmp;\r\n}\r\nstatic void\r\nwlc_phy_txpwr_idx_cur_set_nphy(struct brcms_phy *pi, u8 idx0, u8 idx1)\r\n{\r\nmod_phy_reg(pi, 0x1e7, (0x7f << 0), idx0);\r\nif (NREV_GT(pi->pubpi.phy_rev, 1))\r\nmod_phy_reg(pi, 0x222, (0xff << 0), idx1);\r\n}\r\nstatic u16 wlc_phy_ipa_get_bbmult_nphy(struct brcms_phy *pi)\r\n{\r\nu16 m0m1;\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &m0m1);\r\nreturn m0m1;\r\n}\r\nstatic void wlc_phy_ipa_set_bbmult_nphy(struct brcms_phy *pi, u8 m0, u8 m1)\r\n{\r\nu16 m0m1 = (u16) ((m0 << 8) | m1);\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &m0m1);\r\nwlc_phy_table_write_nphy(pi, 15, 1, 95, 16, &m0m1);\r\n}\r\nstatic void\r\nwlc_phy_papd_cal_setup_nphy(struct brcms_phy *pi,\r\nstruct nphy_papd_restore_state *state, u8 core)\r\n{\r\ns32 tone_freq;\r\nu8 off_core;\r\nu16 mixgain = 0;\r\noff_core = core ^ 0x1;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)\r\n|| NREV_GE(pi->pubpi.phy_rev, 8))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 7),\r\nwlc_phy_read_lpf_bw_ctl_nphy\r\n(pi,\r\n0), 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev == 5)\r\nmixgain = (core == 0) ? 0x20 : 0x00;\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\nmixgain = 0x00;\r\nelse if ((pi->pubpi.radiorev <= 4)\r\n|| (pi->pubpi.radiorev == 6))\r\nmixgain = 0x00;\r\n} else {\r\nif ((pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\nmixgain = 0x50;\r\nelse if ((pi->pubpi.radiorev == 3)\r\n|| (pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\nmixgain = 0x0;\r\n}\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 11),\r\nmixgain, (1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_tx_pu,\r\n1, (1 << core), 0);\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_tx_pu,\r\n0, (1 << off_core), 0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3),\r\n0, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 2), 1,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 0), 0,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 1), 1,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 8), 0,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 9), 1,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 10), 0,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3), 1,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 5),\r\n0, (1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 4), 0,\r\n(1 << core), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nstate->afectrl[core] = read_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xa6 : 0xa7);\r\nstate->afeoverride[core] =\r\nread_phy_reg(pi, (core == PHY_CORE_0) ? 0x8f : 0xa5);\r\nstate->afectrl[off_core] =\r\nread_phy_reg(pi, (core == PHY_CORE_0) ? 0xa7 : 0xa6);\r\nstate->afeoverride[off_core] =\r\nread_phy_reg(pi, (core == PHY_CORE_0) ? 0xa5 : 0x8f);\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0xa6 : 0xa7),\r\n(0x1 << 2), 0);\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0x8f :\r\n0xa5), (0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0xa7 : 0xa6),\r\n(0x1 << 2), (0x1 << 2));\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0xa5 :\r\n0x8f), (0x1 << 2), (0x1 << 2));\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nstate->pwrup[core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_PWRUP);\r\nstate->atten[core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_ATTEN);\r\nstate->pwrup[off_core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_2G_PWRUP);\r\nstate->atten[off_core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_2G_ATTEN);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_PWRUP, 0xc);\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_ATTEN, 0xf0);\r\nelse if (pi->pubpi.radiorev == 5)\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_ATTEN,\r\n(core == 0) ? 0xf7 : 0xf2);\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_ATTEN, 0xf0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_2G_PWRUP, 0x0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_2G_ATTEN, 0xff);\r\n} else {\r\nstate->pwrup[core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_PWRUP);\r\nstate->atten[core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_ATTEN);\r\nstate->pwrup[off_core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_5G_PWRUP);\r\nstate->atten[off_core] =\r\nREAD_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_5G_ATTEN);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_PWRUP, 0xc);\r\nif ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_ATTEN, 0xf4);\r\nelse\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_ATTEN, 0xf0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_5G_PWRUP, 0x0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, off_core,\r\nTXRXCOUPLE_5G_ATTEN, 0xff);\r\n}\r\ntone_freq = 4000;\r\nwlc_phy_tx_tone_nphy(pi, tone_freq, 181, 0, 0, false);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (NPHY_PAPD_COMP_ON) << 0);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (1) << 13);\r\nmod_phy_reg(pi, (off_core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (NPHY_PAPD_COMP_OFF) << 0);\r\nmod_phy_reg(pi, (off_core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (0) << 13);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 12), 0, 0x3, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 1, 0, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 0), 0, 0x3, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 2), 1, 0x3, 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 1), 1, 0x3, 0);\r\nstate->afectrl[core] = read_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xa6 : 0xa7);\r\nstate->afeoverride[core] =\r\nread_phy_reg(pi, (core == PHY_CORE_0) ? 0x8f : 0xa5);\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0xa6 : 0xa7),\r\n(0x1 << 0) | (0x1 << 1) | (0x1 << 2), 0);\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0x8f :\r\n0xa5),\r\n(0x1 << 0) |\r\n(0x1 << 1) |\r\n(0x1 << 2), (0x1 << 0) | (0x1 << 1) | (0x1 << 2));\r\nstate->vga_master[core] =\r\nREAD_RADIO_REG2(pi, RADIO_2056, RX, core, VGA_MASTER);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core, VGA_MASTER, 0x2b);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nstate->fbmix[core] =\r\nREAD_RADIO_REG2(pi, RADIO_2056, RX, core,\r\nTXFBMIX_G);\r\nstate->intpa_master[core] =\r\nREAD_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_MASTER);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core, TXFBMIX_G,\r\n0x03);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_MASTER, 0x04);\r\n} else {\r\nstate->fbmix[core] =\r\nREAD_RADIO_REG2(pi, RADIO_2056, RX, core,\r\nTXFBMIX_A);\r\nstate->intpa_master[core] =\r\nREAD_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_MASTER);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core, TXFBMIX_A,\r\n0x03);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_MASTER, 0x04);\r\n}\r\ntone_freq = 4000;\r\nwlc_phy_tx_tone_nphy(pi, tone_freq, 181, 0, 0, false);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, (off_core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 0, 0x3, 0);\r\n}\r\n}\r\nstatic void\r\nwlc_phy_papd_cal_cleanup_nphy(struct brcms_phy *pi,\r\nstruct nphy_papd_restore_state *state)\r\n{\r\nu8 core;\r\nwlc_phy_stopplayback_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_PWRUP, 0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_2G_ATTEN,\r\nstate->atten[core]);\r\n} else {\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_PWRUP, 0);\r\nWRITE_RADIO_REG3(pi, RADIO_2057, TX, core,\r\nTXRXCOUPLE_5G_ATTEN,\r\nstate->atten[core]);\r\n}\r\n}\r\nif ((pi->pubpi.radiorev == 4) || (pi->pubpi.radiorev == 6))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2),\r\n1, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nelse\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 2),\r\n0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 1),\r\n0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 0), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 2), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 11), 1, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 11), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 12), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 2), 1, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 0), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 1), 1, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 8), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 9), 1, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 10), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3), 1, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 5), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 4), 0, 0x3, 1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xa6 : 0xa7, state->afectrl[core]);\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ? 0x8f :\r\n0xa5, state->afeoverride[core]);\r\n}\r\nwlc_phy_ipa_set_bbmult_nphy(pi, (state->mm >> 8) & 0xff,\r\n(state->mm & 0xff));\r\nif (NREV_IS(pi->pubpi.phy_rev, 7)\r\n|| NREV_GE(pi->pubpi.phy_rev, 8))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi, (0x1 << 7), 0, 0,\r\n1,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 12), 0, 0x3, 1);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 13), 0, 0x3, 1);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 0), 0, 0x3, 1);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 2), 0, 0x3, 1);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 1), 0, 0x3, 1);\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core, VGA_MASTER,\r\nstate->vga_master[core]);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core,\r\nTXFBMIX_G, state->fbmix[core]);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAG_MASTER,\r\nstate->intpa_master[core]);\r\n} else {\r\nWRITE_RADIO_REG2(pi, RADIO_2056, RX, core,\r\nTXFBMIX_A, state->fbmix[core]);\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, core,\r\nINTPAA_MASTER,\r\nstate->intpa_master[core]);\r\n}\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xa6 : 0xa7, state->afectrl[core]);\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ? 0x8f :\r\n0xa5, state->afeoverride[core]);\r\n}\r\nwlc_phy_ipa_set_bbmult_nphy(pi, (state->mm >> 8) & 0xff,\r\n(state->mm & 0xff));\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 0, 0x3, 1);\r\n}\r\n}\r\nstatic void\r\nwlc_phy_a1_nphy(struct brcms_phy *pi, u8 core, u32 winsz, u32 start,\r\nu32 end)\r\n{\r\nu32 *buf, *src, *dst, sz;\r\nsz = end - start + 1;\r\nbuf = kmalloc(2 * sizeof(u32) * NPHY_PAPD_EPS_TBL_SIZE, GFP_ATOMIC);\r\nif (NULL == buf)\r\nreturn;\r\nsrc = buf;\r\ndst = buf + NPHY_PAPD_EPS_TBL_SIZE;\r\nwlc_phy_table_read_nphy(pi,\r\n(core ==\r\nPHY_CORE_0 ? NPHY_TBL_ID_EPSILONTBL0 :\r\nNPHY_TBL_ID_EPSILONTBL1),\r\nNPHY_PAPD_EPS_TBL_SIZE, 0, 32, src);\r\ndo {\r\nu32 phy_a1, phy_a2;\r\ns32 phy_a3, phy_a4, phy_a5, phy_a6, phy_a7;\r\nphy_a1 = end - min(end, (winsz >> 1));\r\nphy_a2 = min_t(u32, NPHY_PAPD_EPS_TBL_SIZE - 1,\r\nend + (winsz >> 1));\r\nphy_a3 = phy_a2 - phy_a1 + 1;\r\nphy_a6 = 0;\r\nphy_a7 = 0;\r\ndo {\r\nwlc_phy_papd_decode_epsilon(src[phy_a2], &phy_a4,\r\n&phy_a5);\r\nphy_a6 += phy_a4;\r\nphy_a7 += phy_a5;\r\n} while (phy_a2-- != phy_a1);\r\nphy_a6 /= phy_a3;\r\nphy_a7 /= phy_a3;\r\ndst[end] = ((u32) phy_a7 << 13) | ((u32) phy_a6 & 0x1fff);\r\n} while (end-- != start);\r\nwlc_phy_table_write_nphy(pi,\r\n(core ==\r\nPHY_CORE_0) ? NPHY_TBL_ID_EPSILONTBL0 :\r\nNPHY_TBL_ID_EPSILONTBL1, sz, start, 32, dst);\r\nkfree(buf);\r\n}\r\nstatic void\r\nwlc_phy_a2_nphy(struct brcms_phy *pi, struct nphy_ipa_txcalgains *txgains,\r\nenum phy_cal_mode cal_mode, u8 core)\r\n{\r\nu16 phy_a1, phy_a2, phy_a3;\r\nu16 phy_a4, phy_a5;\r\nbool phy_a6;\r\nu8 phy_a7, m[2];\r\nu32 phy_a8 = 0;\r\nstruct nphy_txgains phy_a9;\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\nreturn;\r\nphy_a7 = (core == PHY_CORE_0) ? 1 : 0;\r\nphy_a6 = ((cal_mode == CAL_GCTRL)\r\n|| (cal_mode == CAL_SOFT)) ? true : false;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nphy_a9 = wlc_phy_get_tx_gain_nphy(pi);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nphy_a5 = ((phy_a9.txlpf[core] << 15) |\r\n(phy_a9.txgm[core] << 12) |\r\n(phy_a9.pga[core] << 8) |\r\n(txgains->gains.pad[core] << 3) |\r\n(phy_a9.ipa[core]));\r\nelse\r\nphy_a5 = ((phy_a9.txlpf[core] << 15) |\r\n(phy_a9.txgm[core] << 12) |\r\n(txgains->gains.pga[core] << 8) |\r\n(phy_a9.pad[core] << 3) | (phy_a9.ipa[core]));\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_txgain,\r\nphy_a5, (1 << core), 0);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((pi->pubpi.radiorev <= 4)\r\n|| (pi->pubpi.radiorev == 6))\r\nm[core] = (pi->bw == WL_CHANSPEC_BW_40) ?\r\n60 : 79;\r\nelse\r\nm[core] = (pi->bw == WL_CHANSPEC_BW_40) ?\r\n45 : 64;\r\n} else {\r\nm[core] = (pi->bw == WL_CHANSPEC_BW_40) ? 75 : 107;\r\n}\r\nm[phy_a7] = 0;\r\nwlc_phy_ipa_set_bbmult_nphy(pi, m[0], m[1]);\r\nphy_a2 = 63;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((pi->pubpi.radiorev == 4)\r\n|| (pi->pubpi.radiorev == 6)) {\r\nphy_a1 = 30;\r\nphy_a3 = 30;\r\n} else {\r\nphy_a1 = 25;\r\nphy_a3 = 25;\r\n}\r\n} else {\r\nif ((pi->pubpi.radiorev == 5)\r\n|| (pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nphy_a1 = 25;\r\nphy_a3 = 25;\r\n} else {\r\nphy_a1 = 35;\r\nphy_a3 = 35;\r\n}\r\n}\r\nif (cal_mode == CAL_GCTRL) {\r\nif ((pi->pubpi.radiorev == 5)\r\n&& (CHSPEC_IS2G(pi->radio_chanspec)))\r\nphy_a1 = 55;\r\nelse if (((pi->pubpi.radiorev == 7) &&\r\n(CHSPEC_IS2G(pi->radio_chanspec))) ||\r\n((pi->pubpi.radiorev == 8) &&\r\n(CHSPEC_IS2G(pi->radio_chanspec))))\r\nphy_a1 = 60;\r\nelse\r\nphy_a1 = 63;\r\n} else if ((cal_mode != CAL_FULL) && (cal_mode != CAL_SOFT)) {\r\nphy_a1 = 35;\r\nphy_a3 = 35;\r\n}\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, (phy_a7 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (1) << 13);\r\nmod_phy_reg(pi, (phy_a7 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (0) << 13);\r\nwrite_phy_reg(pi, 0x2a1, 0x80);\r\nwrite_phy_reg(pi, 0x2a2, 0x100);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 4), (11) << 4);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 8), (11) << 8);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 0), (0x3) << 0);\r\nwrite_phy_reg(pi, 0x2e5, 0x20);\r\nmod_phy_reg(pi, 0x2a0, (0x3f << 0), (phy_a3) << 0);\r\nmod_phy_reg(pi, 0x29f, (0x3f << 0), (phy_a1) << 0);\r\nmod_phy_reg(pi, 0x29f, (0x3f << 8), (phy_a2) << 8);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3),\r\n1, ((core == 0) ? 1 : 2), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3),\r\n0, ((core == 0) ? 2 : 1), 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwrite_phy_reg(pi, 0x2be, 1);\r\nSPINWAIT(read_phy_reg(pi, 0x2be), 10 * 1000 * 1000);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3),\r\n0, 0x3, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_table_write_nphy(pi,\r\n(core ==\r\nPHY_CORE_0) ? NPHY_TBL_ID_EPSILONTBL0\r\n: NPHY_TBL_ID_EPSILONTBL1, 1, phy_a3,\r\n32, &phy_a8);\r\nif (cal_mode != CAL_GCTRL) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nwlc_phy_a1_nphy(pi, core, 5, 0, 35);\r\n}\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_txgain,\r\nphy_a5, (1 << core), 1);\r\n} else {\r\nif (txgains) {\r\nif (txgains->useindex) {\r\nphy_a4 = 15 - ((txgains->index) >> 3);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 6) &&\r\npi->sh->chip == BCMA_CHIP_ID_BCM47162) {\r\nphy_a5 = 0x10f7 | (phy_a4 << 8);\r\n} else if (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nphy_a5 = 0x00f7 | (phy_a4 << 8);\r\n} else if (NREV_IS(pi->pubpi.phy_rev, 5)) {\r\nphy_a5 = 0x10f7 | (phy_a4 << 8);\r\n} else {\r\nphy_a5 = 0x50f7 | (phy_a4 << 8);\r\n}\r\n} else {\r\nphy_a5 = 0x70f7 | (phy_a4 << 8);\r\n}\r\nwlc_phy_rfctrl_override_nphy(pi,\r\n(0x1 << 13),\r\nphy_a5,\r\n(1 << core), 0);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi,\r\n(0x1 << 13),\r\n0x5bf7,\r\n(1 << core), 0);\r\n}\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nm[core] = (pi->bw == WL_CHANSPEC_BW_40) ? 45 : 64;\r\nelse\r\nm[core] = (pi->bw == WL_CHANSPEC_BW_40) ? 75 : 107;\r\nm[phy_a7] = 0;\r\nwlc_phy_ipa_set_bbmult_nphy(pi, m[0], m[1]);\r\nphy_a2 = 63;\r\nif (cal_mode == CAL_FULL) {\r\nphy_a1 = 25;\r\nphy_a3 = 25;\r\n} else if (cal_mode == CAL_SOFT) {\r\nphy_a1 = 25;\r\nphy_a3 = 25;\r\n} else if (cal_mode == CAL_GCTRL) {\r\nphy_a1 = 63;\r\nphy_a3 = 25;\r\n} else {\r\nphy_a1 = 25;\r\nphy_a3 = 25;\r\n}\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, (phy_a7 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (1) << 13);\r\nmod_phy_reg(pi, (phy_a7 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (0) << 13);\r\nwrite_phy_reg(pi, 0x2a1, 0x20);\r\nwrite_phy_reg(pi, 0x2a2, 0x60);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0xf << 4), (9) << 4);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0xf << 8), (9) << 8);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0xf << 0), (0x2) << 0);\r\nwrite_phy_reg(pi, 0x2e5, 0x20);\r\n} else {\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 11), (1) << 11);\r\nmod_phy_reg(pi, (phy_a7 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 11), (0) << 11);\r\nwrite_phy_reg(pi, 0x2a1, 0x80);\r\nwrite_phy_reg(pi, 0x2a2, 0x600);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 4), (0) << 4);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 8), (0) << 8);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x7 << 0), (0x3) << 0);\r\nmod_phy_reg(pi, 0x2a0, (0x3f << 8), (0x20) << 8);\r\n}\r\nmod_phy_reg(pi, 0x2a0, (0x3f << 0), (phy_a3) << 0);\r\nmod_phy_reg(pi, 0x29f, (0x3f << 0), (phy_a1) << 0);\r\nmod_phy_reg(pi, 0x29f, (0x3f << 8), (phy_a2) << 8);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 1, 0x3, 0);\r\nwrite_phy_reg(pi, 0x2be, 1);\r\nSPINWAIT(read_phy_reg(pi, 0x2be), 10 * 1000 * 1000);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 0, 0x3, 0);\r\nwlc_phy_table_write_nphy(pi,\r\n(core ==\r\nPHY_CORE_0) ? NPHY_TBL_ID_EPSILONTBL0\r\n: NPHY_TBL_ID_EPSILONTBL1, 1, phy_a3,\r\n32, &phy_a8);\r\nif (cal_mode != CAL_GCTRL)\r\nwlc_phy_a1_nphy(pi, core, 5, 0, 40);\r\n}\r\n}\r\nstatic u8 wlc_phy_a3_nphy(struct brcms_phy *pi, u8 start_gain, u8 core)\r\n{\r\nint phy_a1;\r\nint phy_a2;\r\nbool phy_a3;\r\nstruct nphy_ipa_txcalgains phy_a4;\r\nbool phy_a5 = false;\r\nbool phy_a6 = true;\r\ns32 phy_a7, phy_a8;\r\nu32 phy_a9;\r\nint phy_a10;\r\nbool phy_a11 = false;\r\nint phy_a12;\r\nu8 phy_a13 = 0;\r\nu8 phy_a14;\r\nu8 *phy_a15 = NULL;\r\nphy_a4.useindex = true;\r\nphy_a12 = start_gain;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nphy_a2 = 20;\r\nphy_a1 = 1;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev == 5) {\r\nphy_a15 = pad_gain_codes_used_2057rev5;\r\nphy_a13 =\r\nARRAY_SIZE(pad_gain_codes_used_2057rev5) - 1;\r\n} else if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\nphy_a15 = pad_gain_codes_used_2057rev7;\r\nphy_a13 =\r\nARRAY_SIZE(pad_gain_codes_used_2057rev7) - 1;\r\n} else {\r\nphy_a15 = pad_all_gain_codes_2057;\r\nphy_a13 = ARRAY_SIZE(pad_all_gain_codes_2057) -\r\n1;\r\n}\r\n} else {\r\nphy_a15 = pga_all_gain_codes_2057;\r\nphy_a13 = ARRAY_SIZE(pga_all_gain_codes_2057) - 1;\r\n}\r\nphy_a14 = 0;\r\nfor (phy_a10 = 0; phy_a10 < phy_a2; phy_a10++) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nphy_a4.gains.pad[core] =\r\n(u16) phy_a15[phy_a12];\r\nelse\r\nphy_a4.gains.pga[core] =\r\n(u16) phy_a15[phy_a12];\r\nwlc_phy_a2_nphy(pi, &phy_a4, CAL_GCTRL, core);\r\nwlc_phy_table_read_nphy(pi,\r\n(core ==\r\nPHY_CORE_0 ?\r\nNPHY_TBL_ID_EPSILONTBL0 :\r\nNPHY_TBL_ID_EPSILONTBL1), 1,\r\n63, 32, &phy_a9);\r\nwlc_phy_papd_decode_epsilon(phy_a9, &phy_a7, &phy_a8);\r\nphy_a3 = ((phy_a7 == 4095) || (phy_a7 == -4096) ||\r\n(phy_a8 == 4095) || (phy_a8 == -4096));\r\nif (!phy_a6 && (phy_a3 != phy_a5)) {\r\nif (!phy_a3)\r\nphy_a12 -= (u8) phy_a1;\r\nphy_a11 = true;\r\nbreak;\r\n}\r\nif (phy_a3)\r\nphy_a12 += (u8) phy_a1;\r\nelse\r\nphy_a12 -= (u8) phy_a1;\r\nif ((phy_a12 < phy_a14) || (phy_a12 > phy_a13)) {\r\nif (phy_a12 < phy_a14)\r\nphy_a12 = phy_a14;\r\nelse\r\nphy_a12 = phy_a13;\r\nphy_a11 = true;\r\nbreak;\r\n}\r\nphy_a6 = false;\r\nphy_a5 = phy_a3;\r\n}\r\n} else {\r\nphy_a2 = 10;\r\nphy_a1 = 8;\r\nfor (phy_a10 = 0; phy_a10 < phy_a2; phy_a10++) {\r\nphy_a4.index = (u8) phy_a12;\r\nwlc_phy_a2_nphy(pi, &phy_a4, CAL_GCTRL, core);\r\nwlc_phy_table_read_nphy(pi,\r\n(core ==\r\nPHY_CORE_0 ?\r\nNPHY_TBL_ID_EPSILONTBL0 :\r\nNPHY_TBL_ID_EPSILONTBL1), 1,\r\n63, 32, &phy_a9);\r\nwlc_phy_papd_decode_epsilon(phy_a9, &phy_a7, &phy_a8);\r\nphy_a3 = ((phy_a7 == 4095) || (phy_a7 == -4096) ||\r\n(phy_a8 == 4095) || (phy_a8 == -4096));\r\nif (!phy_a6 && (phy_a3 != phy_a5)) {\r\nif (!phy_a3)\r\nphy_a12 -= (u8) phy_a1;\r\nphy_a11 = true;\r\nbreak;\r\n}\r\nif (phy_a3)\r\nphy_a12 += (u8) phy_a1;\r\nelse\r\nphy_a12 -= (u8) phy_a1;\r\nif ((phy_a12 < 0) || (phy_a12 > 127)) {\r\nif (phy_a12 < 0)\r\nphy_a12 = 0;\r\nelse\r\nphy_a12 = 127;\r\nphy_a11 = true;\r\nbreak;\r\n}\r\nphy_a6 = false;\r\nphy_a5 = phy_a3;\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nreturn (u8) phy_a15[phy_a12];\r\nelse\r\nreturn (u8) phy_a12;\r\n}\r\nstatic void wlc_phy_a4(struct brcms_phy *pi, bool full_cal)\r\n{\r\nstruct nphy_ipa_txcalgains phy_b1[2];\r\nstruct nphy_papd_restore_state phy_b2;\r\nbool phy_b3;\r\nu8 phy_b4;\r\nu8 phy_b5;\r\ns16 phy_b6, phy_b7, phy_b8;\r\nu16 phy_b9;\r\ns16 phy_b10, phy_b11, phy_b12;\r\nphy_b11 = 0;\r\nphy_b12 = 0;\r\nphy_b7 = 0;\r\nphy_b8 = 0;\r\nphy_b6 = 0;\r\nif (pi->nphy_papd_skip == 1)\r\nreturn;\r\nphy_b3 = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!phy_b3)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\npi->nphy_force_papd_cal = false;\r\nfor (phy_b5 = 0; phy_b5 < pi->pubpi.phy_corenum; phy_b5++)\r\npi->nphy_papd_tx_gain_at_last_cal[phy_b5] =\r\nwlc_phy_txpwr_idx_cur_get_nphy(pi, phy_b5);\r\npi->nphy_papd_last_cal = pi->sh->now;\r\npi->nphy_papd_recal_counter++;\r\nphy_b4 = pi->nphy_txpwrctrl;\r\nwlc_phy_txpwrctrl_enable_nphy(pi, PHY_TPC_HW_OFF);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_SCALARTBL0, 64, 0, 32,\r\nnphy_papd_scaltbl);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_SCALARTBL1, 64, 0, 32,\r\nnphy_papd_scaltbl);\r\nphy_b9 = read_phy_reg(pi, 0x01);\r\nmod_phy_reg(pi, 0x01, (0x1 << 15), 0);\r\nfor (phy_b5 = 0; phy_b5 < pi->pubpi.phy_corenum; phy_b5++) {\r\ns32 i, val = 0;\r\nfor (i = 0; i < 64; i++)\r\nwlc_phy_table_write_nphy(pi,\r\n((phy_b5 ==\r\nPHY_CORE_0) ?\r\nNPHY_TBL_ID_EPSILONTBL0 :\r\nNPHY_TBL_ID_EPSILONTBL1), 1,\r\ni, 32, &val);\r\n}\r\nwlc_phy_ipa_restore_tx_digi_filts_nphy(pi);\r\nphy_b2.mm = wlc_phy_ipa_get_bbmult_nphy(pi);\r\nfor (phy_b5 = 0; phy_b5 < pi->pubpi.phy_corenum; phy_b5++) {\r\nwlc_phy_papd_cal_setup_nphy(pi, &phy_b2, phy_b5);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif ((pi->pubpi.radiorev == 3)\r\n|| (pi->pubpi.radiorev == 4)\r\n|| (pi->pubpi.radiorev == 6)) {\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\n23;\r\n} else if (pi->pubpi.radiorev == 5) {\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\n0;\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\nwlc_phy_a3_nphy(\r\npi,\r\npi->\r\nnphy_papd_cal_gain_index\r\n[phy_b5],\r\nphy_b5);\r\n} else if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8)) {\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\n0;\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\nwlc_phy_a3_nphy(\r\npi,\r\npi->\r\nnphy_papd_cal_gain_index\r\n[phy_b5],\r\nphy_b5);\r\n}\r\nphy_b1[phy_b5].gains.pad[phy_b5] =\r\npi->nphy_papd_cal_gain_index[phy_b5];\r\n} else {\r\npi->nphy_papd_cal_gain_index[phy_b5] = 0;\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\nwlc_phy_a3_nphy(\r\npi,\r\npi->\r\nnphy_papd_cal_gain_index\r\n[phy_b5], phy_b5);\r\nphy_b1[phy_b5].gains.pga[phy_b5] =\r\npi->nphy_papd_cal_gain_index[phy_b5];\r\n}\r\n} else {\r\nphy_b1[phy_b5].useindex = true;\r\nphy_b1[phy_b5].index = 16;\r\nphy_b1[phy_b5].index =\r\nwlc_phy_a3_nphy(pi, phy_b1[phy_b5].index,\r\nphy_b5);\r\npi->nphy_papd_cal_gain_index[phy_b5] =\r\n15 - ((phy_b1[phy_b5].index) >> 3);\r\n}\r\nswitch (pi->nphy_papd_cal_type) {\r\ncase 0:\r\nwlc_phy_a2_nphy(pi, &phy_b1[phy_b5], CAL_FULL, phy_b5);\r\nbreak;\r\ncase 1:\r\nwlc_phy_a2_nphy(pi, &phy_b1[phy_b5], CAL_SOFT, phy_b5);\r\nbreak;\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_papd_cal_cleanup_nphy(pi, &phy_b2);\r\n}\r\nif (NREV_LT(pi->pubpi.phy_rev, 7))\r\nwlc_phy_papd_cal_cleanup_nphy(pi, &phy_b2);\r\nfor (phy_b5 = 0; phy_b5 < pi->pubpi.phy_corenum; phy_b5++) {\r\nint eps_offset = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev == 3)\r\neps_offset = -2;\r\nelse if (pi->pubpi.radiorev == 5)\r\neps_offset = 3;\r\nelse\r\neps_offset = -1;\r\n} else {\r\neps_offset = 2;\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nphy_b8 = phy_b1[phy_b5].gains.pad[phy_b5];\r\nphy_b10 = 0;\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6)) {\r\nphy_b12 = -(\r\nnphy_papd_padgain_dlt_2g_2057rev3n4\r\n[phy_b8] + 1) / 2;\r\nphy_b10 = -1;\r\n} else if (pi->pubpi.radiorev == 5) {\r\nphy_b12 = -(\r\nnphy_papd_padgain_dlt_2g_2057rev5\r\n[phy_b8] + 1) / 2;\r\n} else if ((pi->pubpi.radiorev == 7) ||\r\n(pi->pubpi.radiorev == 8)) {\r\nphy_b12 = -(\r\nnphy_papd_padgain_dlt_2g_2057rev7\r\n[phy_b8] + 1) / 2;\r\n}\r\n} else {\r\nphy_b7 = phy_b1[phy_b5].gains.pga[phy_b5];\r\nif ((pi->pubpi.radiorev == 3) ||\r\n(pi->pubpi.radiorev == 4) ||\r\n(pi->pubpi.radiorev == 6))\r\nphy_b11 =\r\n-(nphy_papd_pgagain_dlt_5g_2057\r\n[phy_b7]\r\n+ 1) / 2;\r\nelse if ((pi->pubpi.radiorev == 7)\r\n|| (pi->pubpi.radiorev == 8))\r\nphy_b11 = -(\r\nnphy_papd_pgagain_dlt_5g_2057rev7\r\n[phy_b7] + 1) / 2;\r\nphy_b10 = -9;\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nphy_b6 =\r\n-60 + 27 + eps_offset + phy_b12 +\r\nphy_b10;\r\nelse\r\nphy_b6 =\r\n-60 + 27 + eps_offset + phy_b11 +\r\nphy_b10;\r\nmod_phy_reg(pi, (phy_b5 == PHY_CORE_0) ? 0x298 :\r\n0x29c, (0x1ff << 7), (phy_b6) << 7);\r\npi->nphy_papd_epsilon_offset[phy_b5] = phy_b6;\r\n} else {\r\nif (NREV_LT(pi->pubpi.phy_rev, 5))\r\neps_offset = 4;\r\nelse\r\neps_offset = 2;\r\nphy_b7 = 15 - ((phy_b1[phy_b5].index) >> 3);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nphy_b11 =\r\n-(nphy_papd_pga_gain_delta_ipa_2g[\r\nphy_b7] +\r\n1) / 2;\r\nphy_b10 = 0;\r\n} else {\r\nphy_b11 =\r\n-(nphy_papd_pga_gain_delta_ipa_5g[\r\nphy_b7] +\r\n1) / 2;\r\nphy_b10 = -9;\r\n}\r\nphy_b6 = -60 + 27 + eps_offset + phy_b11 + phy_b10;\r\nmod_phy_reg(pi, (phy_b5 == PHY_CORE_0) ? 0x298 :\r\n0x29c, (0x1ff << 7), (phy_b6) << 7);\r\npi->nphy_papd_epsilon_offset[phy_b5] = phy_b6;\r\n}\r\n}\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (NPHY_PAPD_COMP_ON) << 0);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (NPHY_PAPD_COMP_ON) << 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 6)) {\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (0) << 13);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 13), (0) << 13);\r\n} else {\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 11), (0) << 11);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x2a3 :\r\n0x2a4, (0x1 << 11), (0) << 11);\r\n}\r\npi->nphy_papdcomp = NPHY_PAPD_COMP_ON;\r\nwrite_phy_reg(pi, 0x01, phy_b9);\r\nwlc_phy_ipa_set_tx_digi_filts_nphy(pi);\r\nwlc_phy_txpwrctrl_enable_nphy(pi, phy_b4);\r\nif (phy_b4 == PHY_TPC_HW_OFF) {\r\nwlc_phy_txpwr_index_nphy(pi, (1 << 0),\r\n(s8) (pi->nphy_txpwrindex[0].\r\nindex_internal), false);\r\nwlc_phy_txpwr_index_nphy(pi, (1 << 1),\r\n(s8) (pi->nphy_txpwrindex[1].\r\nindex_internal), false);\r\n}\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nif (!phy_b3)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nvoid wlc_phy_cal_perical_nphy_run(struct brcms_phy *pi, u8 caltype)\r\n{\r\nstruct nphy_txgains target_gain;\r\nu8 tx_pwr_ctrl_state;\r\nbool fullcal = true;\r\nbool restore_tx_gain = false;\r\nbool mphase;\r\nif (PHY_MUTED(pi))\r\nreturn;\r\nif (caltype == PHY_PERICAL_AUTO)\r\nfullcal = (pi->radio_chanspec != pi->nphy_txiqlocal_chanspec);\r\nelse if (caltype == PHY_PERICAL_PARTIAL)\r\nfullcal = false;\r\nif (pi->cal_type_override != PHY_PERICAL_AUTO)\r\nfullcal =\r\n(pi->cal_type_override ==\r\nPHY_PERICAL_FULL) ? true : false;\r\nif ((pi->mphase_cal_phase_id > MPHASE_CAL_STATE_INIT)) {\r\nif (pi->nphy_txiqlocal_chanspec != pi->radio_chanspec)\r\nwlc_phy_cal_perical_mphase_restart(pi);\r\n}\r\nif ((pi->mphase_cal_phase_id == MPHASE_CAL_STATE_RXCAL))\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_CTS_DURATION, 10000);\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_phyreg_enter((struct brcms_phy_pub *) pi);\r\nif ((pi->mphase_cal_phase_id == MPHASE_CAL_STATE_IDLE) ||\r\n(pi->mphase_cal_phase_id == MPHASE_CAL_STATE_INIT)) {\r\npi->nphy_cal_orig_pwr_idx[0] =\r\n(u8) ((read_phy_reg(pi, 0x1ed) >> 8) & 0x7f);\r\npi->nphy_cal_orig_pwr_idx[1] =\r\n(u8) ((read_phy_reg(pi, 0x1ee) >> 8) & 0x7f);\r\nif (pi->nphy_txpwrctrl != PHY_TPC_HW_OFF) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2,\r\n0x110, 16,\r\npi->nphy_cal_orig_tx_gain);\r\n} else {\r\npi->nphy_cal_orig_tx_gain[0] = 0;\r\npi->nphy_cal_orig_tx_gain[1] = 0;\r\n}\r\n}\r\ntarget_gain = wlc_phy_get_tx_gain_nphy(pi);\r\ntx_pwr_ctrl_state = pi->nphy_txpwrctrl;\r\nwlc_phy_txpwrctrl_enable_nphy(pi, PHY_TPC_HW_OFF);\r\nif (pi->antsel_type == ANTSEL_2x3)\r\nwlc_phy_antsel_init((struct brcms_phy_pub *) pi, true);\r\nmphase = (pi->mphase_cal_phase_id != MPHASE_CAL_STATE_IDLE);\r\nif (!mphase) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nwlc_phy_precal_txgain_nphy(pi);\r\npi->nphy_cal_target_gain = wlc_phy_get_tx_gain_nphy(pi);\r\nrestore_tx_gain = true;\r\ntarget_gain = pi->nphy_cal_target_gain;\r\n}\r\nif (0 ==\r\nwlc_phy_cal_txiqlo_nphy(pi, target_gain, fullcal,\r\nmphase)) {\r\nif (PHY_IPA(pi))\r\nwlc_phy_a4(pi, true);\r\nwlc_phyreg_exit((struct brcms_phy_pub *) pi);\r\nwlapi_enable_mac(pi->sh->physhim);\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_CTS_DURATION,\r\n10000);\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_phyreg_enter((struct brcms_phy_pub *) pi);\r\nif (0 == wlc_phy_cal_rxiq_nphy(pi, target_gain,\r\n(pi->first_cal_after_assoc ||\r\n(pi->cal_type_override ==\r\nPHY_PERICAL_FULL)) ? 2 : 0, false)) {\r\nwlc_phy_savecal_nphy(pi);\r\nwlc_phy_txpwrctrl_coeff_setup_nphy(pi);\r\npi->nphy_perical_last = pi->sh->now;\r\n}\r\n}\r\nif (caltype != PHY_PERICAL_AUTO)\r\nwlc_phy_rssi_cal_nphy(pi);\r\nif (pi->first_cal_after_assoc\r\n|| (pi->cal_type_override == PHY_PERICAL_FULL)) {\r\npi->first_cal_after_assoc = false;\r\nwlc_phy_txpwrctrl_idle_tssi_nphy(pi);\r\nwlc_phy_txpwrctrl_pwr_setup_nphy(pi);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_radio205x_vcocal_nphy(pi);\r\n} else {\r\nswitch (pi->mphase_cal_phase_id) {\r\ncase MPHASE_CAL_STATE_INIT:\r\npi->nphy_perical_last = pi->sh->now;\r\npi->nphy_txiqlocal_chanspec = pi->radio_chanspec;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_precal_txgain_nphy(pi);\r\npi->nphy_cal_target_gain = wlc_phy_get_tx_gain_nphy(pi);\r\npi->mphase_cal_phase_id++;\r\nbreak;\r\ncase MPHASE_CAL_STATE_TXPHASE0:\r\ncase MPHASE_CAL_STATE_TXPHASE1:\r\ncase MPHASE_CAL_STATE_TXPHASE2:\r\ncase MPHASE_CAL_STATE_TXPHASE3:\r\ncase MPHASE_CAL_STATE_TXPHASE4:\r\ncase MPHASE_CAL_STATE_TXPHASE5:\r\nif ((pi->radar_percal_mask & 0x10) != 0)\r\npi->nphy_rxcal_active = true;\r\nif (wlc_phy_cal_txiqlo_nphy\r\n(pi, pi->nphy_cal_target_gain, fullcal,\r\ntrue) != 0) {\r\nwlc_phy_cal_perical_mphase_reset(pi);\r\nbreak;\r\n}\r\nif (NREV_LE(pi->pubpi.phy_rev, 2) &&\r\n(pi->mphase_cal_phase_id ==\r\nMPHASE_CAL_STATE_TXPHASE4))\r\npi->mphase_cal_phase_id += 2;\r\nelse\r\npi->mphase_cal_phase_id++;\r\nbreak;\r\ncase MPHASE_CAL_STATE_PAPDCAL:\r\nif ((pi->radar_percal_mask & 0x2) != 0)\r\npi->nphy_rxcal_active = true;\r\nif (PHY_IPA(pi))\r\nwlc_phy_a4(pi, true);\r\npi->mphase_cal_phase_id++;\r\nbreak;\r\ncase MPHASE_CAL_STATE_RXCAL:\r\nif ((pi->radar_percal_mask & 0x1) != 0)\r\npi->nphy_rxcal_active = true;\r\nif (wlc_phy_cal_rxiq_nphy(pi, target_gain,\r\n(pi->first_cal_after_assoc ||\r\n(pi->cal_type_override ==\r\nPHY_PERICAL_FULL)) ? 2 : 0,\r\nfalse) == 0)\r\nwlc_phy_savecal_nphy(pi);\r\npi->mphase_cal_phase_id++;\r\nbreak;\r\ncase MPHASE_CAL_STATE_RSSICAL:\r\nif ((pi->radar_percal_mask & 0x4) != 0)\r\npi->nphy_rxcal_active = true;\r\nwlc_phy_txpwrctrl_coeff_setup_nphy(pi);\r\nwlc_phy_rssi_cal_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_radio205x_vcocal_nphy(pi);\r\nrestore_tx_gain = true;\r\nif (pi->first_cal_after_assoc)\r\npi->mphase_cal_phase_id++;\r\nelse\r\nwlc_phy_cal_perical_mphase_reset(pi);\r\nbreak;\r\ncase MPHASE_CAL_STATE_IDLETSSI:\r\nif ((pi->radar_percal_mask & 0x8) != 0)\r\npi->nphy_rxcal_active = true;\r\nif (pi->first_cal_after_assoc) {\r\npi->first_cal_after_assoc = false;\r\nwlc_phy_txpwrctrl_idle_tssi_nphy(pi);\r\nwlc_phy_txpwrctrl_pwr_setup_nphy(pi);\r\n}\r\nwlc_phy_cal_perical_mphase_reset(pi);\r\nbreak;\r\ndefault:\r\nwlc_phy_cal_perical_mphase_reset(pi);\r\nbreak;\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (restore_tx_gain) {\r\nif (tx_pwr_ctrl_state != PHY_TPC_HW_OFF) {\r\nwlc_phy_txpwr_index_nphy(pi, 1,\r\npi->\r\nnphy_cal_orig_pwr_idx\r\n[0], false);\r\nwlc_phy_txpwr_index_nphy(pi, 2,\r\npi->\r\nnphy_cal_orig_pwr_idx\r\n[1], false);\r\npi->nphy_txpwrindex[0].index = -1;\r\npi->nphy_txpwrindex[1].index = -1;\r\n} else {\r\nwlc_phy_txpwr_index_nphy(pi, (1 << 0),\r\n(s8) (pi->\r\nnphy_txpwrindex\r\n[0].\r\nindex_internal),\r\nfalse);\r\nwlc_phy_txpwr_index_nphy(pi, (1 << 1),\r\n(s8) (pi->\r\nnphy_txpwrindex\r\n[1].\r\nindex_internal),\r\nfalse);\r\n}\r\n}\r\n}\r\nwlc_phy_txpwrctrl_enable_nphy(pi, tx_pwr_ctrl_state);\r\nwlc_phyreg_exit((struct brcms_phy_pub *) pi);\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nint\r\nwlc_phy_cal_txiqlo_nphy(struct brcms_phy *pi, struct nphy_txgains target_gain,\r\nbool fullcal, bool mphase)\r\n{\r\nu16 val;\r\nu16 tbl_buf[11];\r\nu8 cal_cnt;\r\nu16 cal_cmd;\r\nu8 num_cals, max_cal_cmds;\r\nu16 core_no, cal_type;\r\nu16 diq_start = 0;\r\nu8 phy_bw;\r\nu16 max_val;\r\nu16 tone_freq;\r\nu16 gain_save[2];\r\nu16 cal_gain[2];\r\nstruct nphy_iqcal_params cal_params[2];\r\nu32 tbl_len;\r\nvoid *tbl_ptr;\r\nbool ladder_updated[2];\r\nu8 mphase_cal_lastphase = 0;\r\nint bcmerror = 0;\r\nbool phyhang_avoid_state = false;\r\nu16 tbl_tx_iqlo_cal_loft_ladder_20[] = {\r\n0x0300, 0x0500, 0x0700, 0x0900, 0x0d00, 0x1100, 0x1900, 0x1901,\r\n0x1902,\r\n0x1903, 0x1904, 0x1905, 0x1906, 0x1907, 0x2407, 0x3207, 0x4607,\r\n0x6407\r\n};\r\nu16 tbl_tx_iqlo_cal_iqimb_ladder_20[] = {\r\n0x0200, 0x0300, 0x0600, 0x0900, 0x0d00, 0x1100, 0x1900, 0x2400,\r\n0x3200,\r\n0x4600, 0x6400, 0x6401, 0x6402, 0x6403, 0x6404, 0x6405, 0x6406,\r\n0x6407\r\n};\r\nu16 tbl_tx_iqlo_cal_loft_ladder_40[] = {\r\n0x0200, 0x0300, 0x0400, 0x0700, 0x0900, 0x0c00, 0x1200, 0x1201,\r\n0x1202,\r\n0x1203, 0x1204, 0x1205, 0x1206, 0x1207, 0x1907, 0x2307, 0x3207,\r\n0x4707\r\n};\r\nu16 tbl_tx_iqlo_cal_iqimb_ladder_40[] = {\r\n0x0100, 0x0200, 0x0400, 0x0700, 0x0900, 0x0c00, 0x1200, 0x1900,\r\n0x2300,\r\n0x3200, 0x4700, 0x4701, 0x4702, 0x4703, 0x4704, 0x4705, 0x4706,\r\n0x4707\r\n};\r\nu16 tbl_tx_iqlo_cal_startcoefs[] = {\r\n0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,\r\n0x0000\r\n};\r\nu16 tbl_tx_iqlo_cal_cmds_fullcal[] = {\r\n0x8123, 0x8264, 0x8086, 0x8245, 0x8056,\r\n0x9123, 0x9264, 0x9086, 0x9245, 0x9056\r\n};\r\nu16 tbl_tx_iqlo_cal_cmds_recal[] = {\r\n0x8101, 0x8253, 0x8053, 0x8234, 0x8034,\r\n0x9101, 0x9253, 0x9053, 0x9234, 0x9034\r\n};\r\nu16 tbl_tx_iqlo_cal_startcoefs_nphyrev3[] = {\r\n0x0000, 0x0000, 0x0000, 0x0000, 0x0000,\r\n0x0000, 0x0000, 0x0000, 0x0000, 0x0000,\r\n0x0000\r\n};\r\nu16 tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[] = {\r\n0x8434, 0x8334, 0x8084, 0x8267, 0x8056, 0x8234,\r\n0x9434, 0x9334, 0x9084, 0x9267, 0x9056, 0x9234\r\n};\r\nu16 tbl_tx_iqlo_cal_cmds_recal_nphyrev3[] = {\r\n0x8423, 0x8323, 0x8073, 0x8256, 0x8045, 0x8223,\r\n0x9423, 0x9323, 0x9073, 0x9256, 0x9045, 0x9223\r\n};\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (NREV_GE(pi->pubpi.phy_rev, 4)) {\r\nphyhang_avoid_state = pi->phyhang_avoid;\r\npi->phyhang_avoid = false;\r\n}\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\nphy_bw = 40;\r\nelse\r\nphy_bw = 20;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, gain_save);\r\nfor (core_no = 0; core_no <= 1; core_no++) {\r\nwlc_phy_iqcal_gainparams_nphy(pi, core_no, target_gain,\r\n&cal_params[core_no]);\r\ncal_gain[core_no] = cal_params[core_no].cal_gain;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, cal_gain);\r\nwlc_phy_txcal_radio_setup_nphy(pi);\r\nwlc_phy_txcal_physetup_nphy(pi);\r\nladder_updated[0] = ladder_updated[1] = false;\r\nif (!(NREV_GE(pi->pubpi.phy_rev, 6) ||\r\n(NREV_IS(pi->pubpi.phy_rev, 5) && PHY_IPA(pi)\r\n&& (CHSPEC_IS2G(pi->radio_chanspec))))) {\r\nif (phy_bw == 40) {\r\ntbl_ptr = tbl_tx_iqlo_cal_loft_ladder_40;\r\ntbl_len = ARRAY_SIZE(tbl_tx_iqlo_cal_loft_ladder_40);\r\n} else {\r\ntbl_ptr = tbl_tx_iqlo_cal_loft_ladder_20;\r\ntbl_len = ARRAY_SIZE(tbl_tx_iqlo_cal_loft_ladder_20);\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, tbl_len, 0,\r\n16, tbl_ptr);\r\nif (phy_bw == 40) {\r\ntbl_ptr = tbl_tx_iqlo_cal_iqimb_ladder_40;\r\ntbl_len = ARRAY_SIZE(tbl_tx_iqlo_cal_iqimb_ladder_40);\r\n} else {\r\ntbl_ptr = tbl_tx_iqlo_cal_iqimb_ladder_20;\r\ntbl_len = ARRAY_SIZE(tbl_tx_iqlo_cal_iqimb_ladder_20);\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, tbl_len, 32,\r\n16, tbl_ptr);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwrite_phy_reg(pi, 0xc2, 0x8ad9);\r\nelse\r\nwrite_phy_reg(pi, 0xc2, 0x8aa9);\r\nmax_val = 250;\r\ntone_freq = (phy_bw == 20) ? 2500 : 5000;\r\nif (pi->mphase_cal_phase_id > MPHASE_CAL_STATE_TXPHASE0) {\r\nwlc_phy_runsamples_nphy(pi, phy_bw * 8, 0xffff, 0, 1, 0, false);\r\nbcmerror = 0;\r\n} else {\r\nbcmerror =\r\nwlc_phy_tx_tone_nphy(pi, tone_freq, max_val, 1, 0,\r\nfalse);\r\n}\r\nif (bcmerror == 0) {\r\nif (pi->mphase_cal_phase_id > MPHASE_CAL_STATE_TXPHASE0) {\r\ntbl_ptr = pi->mphase_txcal_bestcoeffs;\r\ntbl_len = ARRAY_SIZE(pi->mphase_txcal_bestcoeffs);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\ntbl_len -= 2;\r\n} else {\r\nif ((!fullcal) && (pi->nphy_txiqlocal_coeffsvalid)) {\r\ntbl_ptr = pi->nphy_txiqlocal_bestc;\r\ntbl_len = ARRAY_SIZE(pi->nphy_txiqlocal_bestc);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\ntbl_len -= 2;\r\n} else {\r\nfullcal = true;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\ntbl_ptr =\r\ntbl_tx_iqlo_cal_startcoefs_nphyrev3;\r\ntbl_len = ARRAY_SIZE(\r\ntbl_tx_iqlo_cal_startcoefs_nphyrev3);\r\n} else {\r\ntbl_ptr = tbl_tx_iqlo_cal_startcoefs;\r\ntbl_len = ARRAY_SIZE(\r\ntbl_tx_iqlo_cal_startcoefs);\r\n}\r\n}\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, tbl_len, 64,\r\n16, tbl_ptr);\r\nif (fullcal) {\r\nmax_cal_cmds = (NREV_GE(pi->pubpi.phy_rev, 3)) ?\r\nARRAY_SIZE(\r\ntbl_tx_iqlo_cal_cmds_fullcal_nphyrev3) :\r\nARRAY_SIZE(tbl_tx_iqlo_cal_cmds_fullcal);\r\n} else {\r\nmax_cal_cmds = (NREV_GE(pi->pubpi.phy_rev, 3)) ?\r\nARRAY_SIZE(\r\ntbl_tx_iqlo_cal_cmds_recal_nphyrev3) :\r\nARRAY_SIZE(tbl_tx_iqlo_cal_cmds_recal);\r\n}\r\nif (mphase) {\r\ncal_cnt = pi->mphase_txcal_cmdidx;\r\nif ((cal_cnt + pi->mphase_txcal_numcmds) < max_cal_cmds)\r\nnum_cals = cal_cnt + pi->mphase_txcal_numcmds;\r\nelse\r\nnum_cals = max_cal_cmds;\r\n} else {\r\ncal_cnt = 0;\r\nnum_cals = max_cal_cmds;\r\n}\r\nfor (; cal_cnt < num_cals; cal_cnt++) {\r\nif (fullcal) {\r\ncal_cmd = (NREV_GE(pi->pubpi.phy_rev, 3)) ?\r\ntbl_tx_iqlo_cal_cmds_fullcal_nphyrev3\r\n[cal_cnt] :\r\ntbl_tx_iqlo_cal_cmds_fullcal[cal_cnt];\r\n} else {\r\ncal_cmd = (NREV_GE(pi->pubpi.phy_rev, 3)) ?\r\ntbl_tx_iqlo_cal_cmds_recal_nphyrev3[\r\ncal_cnt]\r\n: tbl_tx_iqlo_cal_cmds_recal[cal_cnt];\r\n}\r\ncore_no = ((cal_cmd & 0x3000) >> 12);\r\ncal_type = ((cal_cmd & 0x0F00) >> 8);\r\nif (NREV_GE(pi->pubpi.phy_rev, 6) ||\r\n(NREV_IS(pi->pubpi.phy_rev, 5) &&\r\nPHY_IPA(pi)\r\n&& (CHSPEC_IS2G(pi->radio_chanspec)))) {\r\nif (!ladder_updated[core_no]) {\r\nwlc_phy_update_txcal_ladder_nphy(\r\npi,\r\ncore_no);\r\nladder_updated[core_no] = true;\r\n}\r\n}\r\nval =\r\n(cal_params[core_no].\r\nncorr[cal_type] << 8) | NPHY_N_GCTL;\r\nwrite_phy_reg(pi, 0xc1, val);\r\nif ((cal_type == 1) || (cal_type == 3)\r\n|| (cal_type == 4)) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\n1, 69 + core_no, 16,\r\ntbl_buf);\r\ndiq_start = tbl_buf[0];\r\ntbl_buf[0] = 0;\r\nwlc_phy_table_write_nphy(pi,\r\nNPHY_TBL_ID_IQLOCAL, 1,\r\n69 + core_no, 16,\r\ntbl_buf);\r\n}\r\nwrite_phy_reg(pi, 0xc0, cal_cmd);\r\nSPINWAIT(((read_phy_reg(pi, 0xc0) & 0xc000) != 0),\r\n20000);\r\nif (WARN(read_phy_reg(pi, 0xc0) & 0xc000,\r\n"HW error: txiq calib"))\r\nreturn -EIO;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\ntbl_len, 96, 16, tbl_buf);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\ntbl_len, 64, 16, tbl_buf);\r\nif ((cal_type == 1) || (cal_type == 3)\r\n|| (cal_type == 4)) {\r\ntbl_buf[0] = diq_start;\r\n}\r\n}\r\nif (mphase) {\r\npi->mphase_txcal_cmdidx = num_cals;\r\nif (pi->mphase_txcal_cmdidx >= max_cal_cmds)\r\npi->mphase_txcal_cmdidx = 0;\r\n}\r\nmphase_cal_lastphase =\r\n(NREV_LE(pi->pubpi.phy_rev, 2)) ?\r\nMPHASE_CAL_STATE_TXPHASE4 : MPHASE_CAL_STATE_TXPHASE5;\r\nif (!mphase\r\n|| (pi->mphase_cal_phase_id == mphase_cal_lastphase)) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 96,\r\n16, tbl_buf);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 80,\r\n16, tbl_buf);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\ntbl_buf[0] = 0;\r\ntbl_buf[1] = 0;\r\ntbl_buf[2] = 0;\r\ntbl_buf[3] = 0;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 88,\r\n16, tbl_buf);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 101,\r\n16, tbl_buf);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 85,\r\n16, tbl_buf);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 93,\r\n16, tbl_buf);\r\ntbl_len = ARRAY_SIZE(pi->nphy_txiqlocal_bestc);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\ntbl_len -= 2;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\ntbl_len, 96, 16,\r\npi->nphy_txiqlocal_bestc);\r\npi->nphy_txiqlocal_coeffsvalid = true;\r\npi->nphy_txiqlocal_chanspec = pi->radio_chanspec;\r\n} else {\r\ntbl_len = ARRAY_SIZE(pi->mphase_txcal_bestcoeffs);\r\nif (NREV_LT(pi->pubpi.phy_rev, 3))\r\ntbl_len -= 2;\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\ntbl_len, 96, 16,\r\npi->mphase_txcal_bestcoeffs);\r\n}\r\nwlc_phy_stopplayback_nphy(pi);\r\nwrite_phy_reg(pi, 0xc2, 0x0000);\r\n}\r\nwlc_phy_txcal_phycleanup_nphy(pi);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ngain_save);\r\nwlc_phy_txcal_radio_cleanup_nphy(pi);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2)) {\r\nif (!mphase\r\n|| (pi->mphase_cal_phase_id == mphase_cal_lastphase))\r\nwlc_phy_tx_iq_war_nphy(pi);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 4))\r\npi->phyhang_avoid = phyhang_avoid_state;\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nreturn bcmerror;\r\n}\r\nstatic void wlc_phy_reapply_txcal_coeffs_nphy(struct brcms_phy *pi)\r\n{\r\nu16 tbl_buf[7];\r\nif ((pi->nphy_txiqlocal_chanspec == pi->radio_chanspec) &&\r\n(pi->nphy_txiqlocal_coeffsvalid)) {\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_IQLOCAL,\r\nARRAY_SIZE(tbl_buf), 80, 16, tbl_buf);\r\nif ((pi->nphy_txiqlocal_bestc[0] != tbl_buf[0]) ||\r\n(pi->nphy_txiqlocal_bestc[1] != tbl_buf[1]) ||\r\n(pi->nphy_txiqlocal_bestc[2] != tbl_buf[2]) ||\r\n(pi->nphy_txiqlocal_bestc[3] != tbl_buf[3])) {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 80,\r\n16, pi->nphy_txiqlocal_bestc);\r\ntbl_buf[0] = 0;\r\ntbl_buf[1] = 0;\r\ntbl_buf[2] = 0;\r\ntbl_buf[3] = 0;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 4, 88,\r\n16, tbl_buf);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 85,\r\n16,\r\n&pi->nphy_txiqlocal_bestc[5]);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_IQLOCAL, 2, 93,\r\n16,\r\n&pi->nphy_txiqlocal_bestc[5]);\r\n}\r\n}\r\n}\r\nvoid\r\nwlc_phy_rx_iq_coeffs_nphy(struct brcms_phy *pi, u8 write,\r\nstruct nphy_iq_comp *pcomp)\r\n{\r\nif (write) {\r\nwrite_phy_reg(pi, 0x9a, pcomp->a0);\r\nwrite_phy_reg(pi, 0x9b, pcomp->b0);\r\nwrite_phy_reg(pi, 0x9c, pcomp->a1);\r\nwrite_phy_reg(pi, 0x9d, pcomp->b1);\r\n} else {\r\npcomp->a0 = read_phy_reg(pi, 0x9a);\r\npcomp->b0 = read_phy_reg(pi, 0x9b);\r\npcomp->a1 = read_phy_reg(pi, 0x9c);\r\npcomp->b1 = read_phy_reg(pi, 0x9d);\r\n}\r\n}\r\nvoid\r\nwlc_phy_rx_iq_est_nphy(struct brcms_phy *pi, struct phy_iq_est *est,\r\nu16 num_samps, u8 wait_time, u8 wait_for_crs)\r\n{\r\nu8 core;\r\nwrite_phy_reg(pi, 0x12b, num_samps);\r\nmod_phy_reg(pi, 0x12a, (0xff << 0), (wait_time << 0));\r\nmod_phy_reg(pi, 0x129, NPHY_IqestCmd_iqMode,\r\n(wait_for_crs) ? NPHY_IqestCmd_iqMode : 0);\r\nmod_phy_reg(pi, 0x129, NPHY_IqestCmd_iqstart, NPHY_IqestCmd_iqstart);\r\nSPINWAIT(((read_phy_reg(pi, 0x129) & NPHY_IqestCmd_iqstart) != 0),\r\n10000);\r\nif (WARN(read_phy_reg(pi, 0x129) & NPHY_IqestCmd_iqstart,\r\n"HW error: rxiq est"))\r\nreturn;\r\nif ((read_phy_reg(pi, 0x129) & NPHY_IqestCmd_iqstart) == 0) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nest[core].i_pwr =\r\n(read_phy_reg(pi,\r\nNPHY_IqestipwrAccHi(core)) << 16)\r\n| read_phy_reg(pi, NPHY_IqestipwrAccLo(core));\r\nest[core].q_pwr =\r\n(read_phy_reg(pi,\r\nNPHY_IqestqpwrAccHi(core)) << 16)\r\n| read_phy_reg(pi, NPHY_IqestqpwrAccLo(core));\r\nest[core].iq_prod =\r\n(read_phy_reg(pi,\r\nNPHY_IqestIqAccHi(core)) << 16) |\r\nread_phy_reg(pi, NPHY_IqestIqAccLo(core));\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_calc_rx_iq_comp_nphy(struct brcms_phy *pi, u8 core_mask)\r\n{\r\nu8 curr_core;\r\nstruct phy_iq_est est[PHY_CORE_MAX];\r\nstruct nphy_iq_comp old_comp, new_comp;\r\ns32 iq = 0;\r\nu32 ii = 0, qq = 0;\r\ns16 iq_nbits, qq_nbits, brsh, arsh;\r\ns32 a, b, temp;\r\nint bcmerror = 0;\r\nuint cal_retry = 0;\r\nif (core_mask == 0x0)\r\nreturn;\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 0, &old_comp);\r\nnew_comp.a0 = new_comp.b0 = new_comp.a1 = new_comp.b1 = 0x0;\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1, &new_comp);\r\ncal_try:\r\nwlc_phy_rx_iq_est_nphy(pi, est, 0x4000, 32, 0);\r\nnew_comp = old_comp;\r\nfor (curr_core = 0; curr_core < pi->pubpi.phy_corenum; curr_core++) {\r\nif ((curr_core == PHY_CORE_0) && (core_mask & 0x1)) {\r\niq = est[curr_core].iq_prod;\r\nii = est[curr_core].i_pwr;\r\nqq = est[curr_core].q_pwr;\r\n} else if ((curr_core == PHY_CORE_1) && (core_mask & 0x2)) {\r\niq = est[curr_core].iq_prod;\r\nii = est[curr_core].i_pwr;\r\nqq = est[curr_core].q_pwr;\r\n} else {\r\ncontinue;\r\n}\r\nif ((ii + qq) < NPHY_MIN_RXIQ_PWR) {\r\nbcmerror = -EBADE;\r\nbreak;\r\n}\r\niq_nbits = wlc_phy_nbits(iq);\r\nqq_nbits = wlc_phy_nbits(qq);\r\narsh = 10 - (30 - iq_nbits);\r\nif (arsh >= 0) {\r\na = (-(iq << (30 - iq_nbits)) + (ii >> (1 + arsh)));\r\ntemp = (s32) (ii >> arsh);\r\nif (temp == 0) {\r\nbcmerror = -EBADE;\r\nbreak;\r\n}\r\n} else {\r\na = (-(iq << (30 - iq_nbits)) + (ii << (-1 - arsh)));\r\ntemp = (s32) (ii << -arsh);\r\nif (temp == 0) {\r\nbcmerror = -EBADE;\r\nbreak;\r\n}\r\n}\r\na /= temp;\r\nbrsh = qq_nbits - 31 + 20;\r\nif (brsh >= 0) {\r\nb = (qq << (31 - qq_nbits));\r\ntemp = (s32) (ii >> brsh);\r\nif (temp == 0) {\r\nbcmerror = -EBADE;\r\nbreak;\r\n}\r\n} else {\r\nb = (qq << (31 - qq_nbits));\r\ntemp = (s32) (ii << -brsh);\r\nif (temp == 0) {\r\nbcmerror = -EBADE;\r\nbreak;\r\n}\r\n}\r\nb /= temp;\r\nb -= a * a;\r\nb = (s32) int_sqrt((unsigned long) b);\r\nb -= (1 << 10);\r\nif ((curr_core == PHY_CORE_0) && (core_mask & 0x1)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nnew_comp.a0 = (s16) a & 0x3ff;\r\nnew_comp.b0 = (s16) b & 0x3ff;\r\n} else {\r\nnew_comp.a0 = (s16) b & 0x3ff;\r\nnew_comp.b0 = (s16) a & 0x3ff;\r\n}\r\n}\r\nif ((curr_core == PHY_CORE_1) && (core_mask & 0x2)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nnew_comp.a1 = (s16) a & 0x3ff;\r\nnew_comp.b1 = (s16) b & 0x3ff;\r\n} else {\r\nnew_comp.a1 = (s16) b & 0x3ff;\r\nnew_comp.b1 = (s16) a & 0x3ff;\r\n}\r\n}\r\n}\r\nif (bcmerror != 0) {\r\npr_debug("%s: Failed, cnt = %d\n", __func__, cal_retry);\r\nif (cal_retry < CAL_RETRY_CNT) {\r\ncal_retry++;\r\ngoto cal_try;\r\n}\r\nnew_comp = old_comp;\r\n}\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1, &new_comp);\r\n}\r\nstatic void wlc_phy_rxcal_radio_setup_nphy(struct brcms_phy *pi, u8 rx_core)\r\n{\r\nu16 offtune_val;\r\nu16 bias_g = 0;\r\nu16 bias_a = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (rx_core == PHY_CORE_0) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_PWRUP);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_ATTEN);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_PWRUP,\r\n0x3);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_ATTEN,\r\n0xaf);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_PWRUP);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_ATTEN);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_PWRUP,\r\n0x3);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_ATTEN,\r\n0x7f);\r\n}\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_PWRUP);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_ATTEN);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_PWRUP,\r\n0x3);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_ATTEN,\r\n0xaf);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_PWRUP);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_ATTEN);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_PWRUP,\r\n0x3);\r\nwrite_radio_reg(pi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_ATTEN,\r\n0x7f);\r\n}\r\n}\r\n} else {\r\nif (rx_core == PHY_CORE_0) {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX1);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX0);\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[2] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RXSPARE2 |\r\nRADIO_2056_RX0);\r\npi->tx_rx_cal_radio_saveregs[3] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TXSPARE2 |\r\nRADIO_2056_TX1);\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_MASTER\r\n| RADIO_2056_RX0);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_MASTER\r\n| RADIO_2056_RX0, 0x40);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TXSPARE2 |\r\nRADIO_2056_TX1, bias_a);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXSPARE2 |\r\nRADIO_2056_RX0, bias_a);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_TUNE\r\n| RADIO_2056_RX0);\r\nofftune_val =\r\n(pi->tx_rx_cal_radio_saveregs\r\n[2] & 0xF0) >> 8;\r\nofftune_val =\r\n(offtune_val <= 0x7) ? 0xF : 0;\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_TUNE |\r\nRADIO_2056_RX0, 0xF0,\r\n(offtune_val << 8));\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX1, 0x9);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX0, 0x9);\r\n} else {\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX0);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX0, 0x40);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TXSPARE2\r\n|\r\nRADIO_2056_TX1, bias_g);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_RXSPARE2\r\n|\r\nRADIO_2056_RX0, bias_g);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_TUNE\r\n| RADIO_2056_RX0);\r\nofftune_val =\r\n(pi->\r\ntx_rx_cal_radio_saveregs[2] &\r\n0xF0) >> 8;\r\nofftune_val =\r\n(offtune_val <= 0x7) ? 0xF : 0;\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_LNAG_TUNE |\r\nRADIO_2056_RX0, 0xF0,\r\n(offtune_val << 8));\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX1, 0x6);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX0, 0x6);\r\n}\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[0] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX0);\r\npi->tx_rx_cal_radio_saveregs[1] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX1);\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[2] =\r\nread_radio_reg(pi,\r\nRADIO_2056_RX_RXSPARE2 |\r\nRADIO_2056_RX1);\r\npi->tx_rx_cal_radio_saveregs[3] =\r\nread_radio_reg(pi,\r\nRADIO_2056_TX_TXSPARE2 |\r\nRADIO_2056_TX0);\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_MASTER\r\n| RADIO_2056_RX1);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_MASTER |\r\nRADIO_2056_RX1, 0x40);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TXSPARE2\r\n|\r\nRADIO_2056_TX0, bias_a);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_RXSPARE2\r\n|\r\nRADIO_2056_RX1, bias_a);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_TUNE\r\n| RADIO_2056_RX1);\r\nofftune_val =\r\n(pi->\r\ntx_rx_cal_radio_saveregs[2] &\r\n0xF0) >> 8;\r\nofftune_val =\r\n(offtune_val <= 0x7) ? 0xF : 0;\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_LNAA_TUNE |\r\nRADIO_2056_RX1, 0xF0,\r\n(offtune_val << 8));\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX0, 0x9);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX1, 0x9);\r\n} else {\r\nif (pi->pubpi.radiorev >= 5) {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX1);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX1, 0x40);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_TX_TXSPARE2\r\n|\r\nRADIO_2056_TX0, bias_g);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_RXSPARE2\r\n|\r\nRADIO_2056_RX1, bias_g);\r\n} else {\r\npi->tx_rx_cal_radio_saveregs[4] =\r\nread_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_TUNE\r\n| RADIO_2056_RX1);\r\nofftune_val =\r\n(pi->\r\ntx_rx_cal_radio_saveregs[2] &\r\n0xF0) >> 8;\r\nofftune_val =\r\n(offtune_val <= 0x7) ? 0xF : 0;\r\nmod_radio_reg(pi,\r\nRADIO_2056_RX_LNAG_TUNE |\r\nRADIO_2056_RX1, 0xF0,\r\n(offtune_val << 8));\r\n}\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX0, 0x6);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX1, 0x6);\r\n}\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_rxcal_radio_cleanup_nphy(struct brcms_phy *pi, u8 rx_core)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nif (rx_core == PHY_CORE_0) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_PWRUP,\r\npi->\r\ntx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_5G_ATTEN,\r\npi->\r\ntx_rx_cal_radio_saveregs[1]);\r\n} else {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_PWRUP,\r\npi->\r\ntx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX0_TXRXCOUPLE_2G_ATTEN,\r\npi->\r\ntx_rx_cal_radio_saveregs[1]);\r\n}\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_PWRUP,\r\npi->\r\ntx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_5G_ATTEN,\r\npi->\r\ntx_rx_cal_radio_saveregs[1]);\r\n} else {\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_PWRUP,\r\npi->\r\ntx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2057_TX1_TXRXCOUPLE_2G_ATTEN,\r\npi->\r\ntx_rx_cal_radio_saveregs[1]);\r\n}\r\n}\r\n} else {\r\nif (rx_core == PHY_CORE_0) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX1,\r\npi->tx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX0,\r\npi->tx_rx_cal_radio_saveregs[1]);\r\nif (pi->pubpi.radiorev >= 5) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXSPARE2 |\r\nRADIO_2056_RX0,\r\npi->\r\ntx_rx_cal_radio_saveregs[2]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TXSPARE2 |\r\nRADIO_2056_TX1,\r\npi->\r\ntx_rx_cal_radio_saveregs[3]);\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev >= 5)\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_MASTER\r\n| RADIO_2056_RX0,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\nelse\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_TUNE\r\n| RADIO_2056_RX0,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\n} else {\r\nif (pi->pubpi.radiorev >= 5)\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX0,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\nelse\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_TUNE\r\n| RADIO_2056_RX0,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\n}\r\n} else {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_RXIQCAL_TXMUX |\r\nRADIO_2056_TX0,\r\npi->tx_rx_cal_radio_saveregs[0]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXIQCAL_RXMUX |\r\nRADIO_2056_RX1,\r\npi->tx_rx_cal_radio_saveregs[1]);\r\nif (pi->pubpi.radiorev >= 5) {\r\nwrite_radio_reg(pi,\r\nRADIO_2056_RX_RXSPARE2 |\r\nRADIO_2056_RX1,\r\npi->\r\ntx_rx_cal_radio_saveregs[2]);\r\nwrite_radio_reg(pi,\r\nRADIO_2056_TX_TXSPARE2 |\r\nRADIO_2056_TX0,\r\npi->\r\ntx_rx_cal_radio_saveregs[3]);\r\n}\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (pi->pubpi.radiorev >= 5)\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_MASTER\r\n| RADIO_2056_RX1,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\nelse\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAA_TUNE\r\n| RADIO_2056_RX1,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\n} else {\r\nif (pi->pubpi.radiorev >= 5)\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_MASTER\r\n| RADIO_2056_RX1,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\nelse\r\nwrite_radio_reg(\r\npi,\r\nRADIO_2056_RX_LNAG_TUNE\r\n| RADIO_2056_RX1,\r\npi->\r\ntx_rx_cal_radio_saveregs\r\n[4]);\r\n}\r\n}\r\n}\r\n}\r\nstatic void wlc_phy_rxcal_physetup_nphy(struct brcms_phy *pi, u8 rx_core)\r\n{\r\nu8 tx_core;\r\nu16 rx_antval, tx_antval;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\ntx_core = rx_core;\r\nelse\r\ntx_core = (rx_core == PHY_CORE_0) ? 1 : 0;\r\npi->tx_rx_cal_phy_saveregs[0] = read_phy_reg(pi, 0xa2);\r\npi->tx_rx_cal_phy_saveregs[1] =\r\nread_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0xa6 : 0xa7);\r\npi->tx_rx_cal_phy_saveregs[2] =\r\nread_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0x8f : 0xa5);\r\npi->tx_rx_cal_phy_saveregs[3] = read_phy_reg(pi, 0x91);\r\npi->tx_rx_cal_phy_saveregs[4] = read_phy_reg(pi, 0x92);\r\npi->tx_rx_cal_phy_saveregs[5] = read_phy_reg(pi, 0x7a);\r\npi->tx_rx_cal_phy_saveregs[6] = read_phy_reg(pi, 0x7d);\r\npi->tx_rx_cal_phy_saveregs[7] = read_phy_reg(pi, 0xe7);\r\npi->tx_rx_cal_phy_saveregs[8] = read_phy_reg(pi, 0xec);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\npi->tx_rx_cal_phy_saveregs[11] = read_phy_reg(pi, 0x342);\r\npi->tx_rx_cal_phy_saveregs[12] = read_phy_reg(pi, 0x343);\r\npi->tx_rx_cal_phy_saveregs[13] = read_phy_reg(pi, 0x346);\r\npi->tx_rx_cal_phy_saveregs[14] = read_phy_reg(pi, 0x347);\r\n}\r\npi->tx_rx_cal_phy_saveregs[9] = read_phy_reg(pi, 0x297);\r\npi->tx_rx_cal_phy_saveregs[10] = read_phy_reg(pi, 0x29b);\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 0), (0) << 0);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmod_phy_reg(pi, 0xa2, (0xf << 0), (1 << tx_core) << 0);\r\nmod_phy_reg(pi, 0xa2, (0xf << 12), (1 << (1 - rx_core)) << 12);\r\n} else {\r\nmod_phy_reg(pi, 0xa2, (0xf << 12), (1 << tx_core) << 12);\r\nmod_phy_reg(pi, 0xa2, (0xf << 0), (1 << tx_core) << 0);\r\nmod_phy_reg(pi, 0xa2, (0xf << 4), (1 << rx_core) << 4);\r\nmod_phy_reg(pi, 0xa2, (0xf << 8), (1 << rx_core) << 8);\r\n}\r\nmod_phy_reg(pi, ((rx_core == PHY_CORE_0) ? 0xa6 : 0xa7), (0x1 << 2), 0);\r\nmod_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0x8f : 0xa5,\r\n(0x1 << 2), (0x1 << 2));\r\nif (NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nmod_phy_reg(pi, ((rx_core == PHY_CORE_0) ? 0xa6 : 0xa7),\r\n(0x1 << 0) | (0x1 << 1), 0);\r\nmod_phy_reg(pi, (rx_core == PHY_CORE_0) ?\r\n0x8f : 0xa5,\r\n(0x1 << 0) | (0x1 << 1), (0x1 << 0) | (0x1 << 1));\r\n}\r\nwlc_phy_rfctrlintc_override_nphy(pi, NPHY_RfctrlIntc_override_PA, 0,\r\nRADIO_MIMO_CORESEL_CORE1 |\r\nRADIO_MIMO_CORESEL_CORE2);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 3),\r\n0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID0);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 9), 0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 10), 1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 0), 1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 1), 1, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID2);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 11), 0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nif (CHSPEC_IS40(pi->radio_chanspec))\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 7),\r\n2, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nelse\r\nwlc_phy_rfctrl_override_nphy_rev7(\r\npi,\r\n(0x1 << 7),\r\n0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 7),\r\n0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\nwlc_phy_rfctrl_override_nphy_rev7(pi, (0x1 << 5), 0, 0, 0,\r\nNPHY_REV7_RFCTRLOVERRIDE_ID1);\r\n} else {\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 3), 0, 3, 0);\r\n}\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RX2TX);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\n0x1, rx_core + 1);\r\n} else {\r\nif (rx_core == PHY_CORE_0) {\r\nrx_antval = 0x1;\r\ntx_antval = 0x8;\r\n} else {\r\nrx_antval = 0x4;\r\ntx_antval = 0x2;\r\n}\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\nrx_antval, rx_core + 1);\r\nwlc_phy_rfctrlintc_override_nphy(pi,\r\nNPHY_RfctrlIntc_override_TRSW,\r\ntx_antval, tx_core + 1);\r\n}\r\n}\r\nstatic void wlc_phy_rxcal_phycleanup_nphy(struct brcms_phy *pi, u8 rx_core)\r\n{\r\nwrite_phy_reg(pi, 0xa2, pi->tx_rx_cal_phy_saveregs[0]);\r\nwrite_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0xa6 : 0xa7,\r\npi->tx_rx_cal_phy_saveregs[1]);\r\nwrite_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0x8f : 0xa5,\r\npi->tx_rx_cal_phy_saveregs[2]);\r\nwrite_phy_reg(pi, 0x91, pi->tx_rx_cal_phy_saveregs[3]);\r\nwrite_phy_reg(pi, 0x92, pi->tx_rx_cal_phy_saveregs[4]);\r\nwrite_phy_reg(pi, 0x7a, pi->tx_rx_cal_phy_saveregs[5]);\r\nwrite_phy_reg(pi, 0x7d, pi->tx_rx_cal_phy_saveregs[6]);\r\nwrite_phy_reg(pi, 0xe7, pi->tx_rx_cal_phy_saveregs[7]);\r\nwrite_phy_reg(pi, 0xec, pi->tx_rx_cal_phy_saveregs[8]);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nwrite_phy_reg(pi, 0x342, pi->tx_rx_cal_phy_saveregs[11]);\r\nwrite_phy_reg(pi, 0x343, pi->tx_rx_cal_phy_saveregs[12]);\r\nwrite_phy_reg(pi, 0x346, pi->tx_rx_cal_phy_saveregs[13]);\r\nwrite_phy_reg(pi, 0x347, pi->tx_rx_cal_phy_saveregs[14]);\r\n}\r\nwrite_phy_reg(pi, 0x297, pi->tx_rx_cal_phy_saveregs[9]);\r\nwrite_phy_reg(pi, 0x29b, pi->tx_rx_cal_phy_saveregs[10]);\r\n}\r\nstatic void\r\nwlc_phy_rxcal_gainctrl_nphy_rev5(struct brcms_phy *pi, u8 rx_core,\r\nu16 *rxgain, u8 cal_type)\r\n{\r\nu16 num_samps;\r\nstruct phy_iq_est est[PHY_CORE_MAX];\r\nu8 tx_core;\r\nstruct nphy_iq_comp save_comp, zero_comp;\r\nu32 i_pwr, q_pwr, curr_pwr, optim_pwr = 0, prev_pwr = 0,\r\nthresh_pwr = 10000;\r\ns16 desired_log2_pwr, actual_log2_pwr, delta_pwr;\r\nbool gainctrl_done = false;\r\nu8 mix_tia_gain = 3;\r\ns8 optim_gaintbl_index = 0, prev_gaintbl_index = 0;\r\ns8 curr_gaintbl_index = 3;\r\nu8 gainctrl_dirn = NPHY_RXCAL_GAIN_INIT;\r\nconst struct nphy_ipa_txrxgain *nphy_rxcal_gaintbl;\r\nu16 hpvga, lpf_biq1, lpf_biq0, lna2, lna1;\r\nint fine_gain_idx;\r\ns8 txpwrindex;\r\nu16 nphy_rxcal_txgain[2];\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\ntx_core = rx_core;\r\nelse\r\ntx_core = 1 - rx_core;\r\nnum_samps = 1024;\r\ndesired_log2_pwr = (cal_type == 0) ? 13 : 13;\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 0, &save_comp);\r\nzero_comp.a0 = zero_comp.b0 = zero_comp.a1 = zero_comp.b1 = 0x0;\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1, &zero_comp);\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nmix_tia_gain = 3;\r\nelse if (NREV_GE(pi->pubpi.phy_rev, 4))\r\nmix_tia_gain = 4;\r\nelse\r\nmix_tia_gain = 6;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nnphy_rxcal_gaintbl = nphy_ipa_rxcal_gaintbl_5GHz_rev7;\r\nelse\r\nnphy_rxcal_gaintbl = nphy_ipa_rxcal_gaintbl_5GHz;\r\n} else {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nnphy_rxcal_gaintbl = nphy_ipa_rxcal_gaintbl_2GHz_rev7;\r\nelse\r\nnphy_rxcal_gaintbl = nphy_ipa_rxcal_gaintbl_2GHz;\r\n}\r\ndo {\r\nhpvga = (NREV_GE(pi->pubpi.phy_rev, 7)) ?\r\n0 : nphy_rxcal_gaintbl[curr_gaintbl_index].hpvga;\r\nlpf_biq1 = nphy_rxcal_gaintbl[curr_gaintbl_index].lpf_biq1;\r\nlpf_biq0 = nphy_rxcal_gaintbl[curr_gaintbl_index].lpf_biq0;\r\nlna2 = nphy_rxcal_gaintbl[curr_gaintbl_index].lna2;\r\nlna1 = nphy_rxcal_gaintbl[curr_gaintbl_index].lna1;\r\ntxpwrindex = nphy_rxcal_gaintbl[curr_gaintbl_index].txpwrindex;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_rxgain,\r\n((lpf_biq1 << 12) |\r\n(lpf_biq0 << 8) |\r\n(mix_tia_gain << 4) | (lna2 << 2)\r\n| lna1), 0x3, 0);\r\nelse\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 12),\r\n((hpvga << 12) |\r\n(lpf_biq1 << 10) |\r\n(lpf_biq0 << 8) |\r\n(mix_tia_gain << 4) |\r\n(lna2 << 2) | lna1), 0x3,\r\n0);\r\npi->nphy_rxcal_pwr_idx[tx_core] = txpwrindex;\r\nif (txpwrindex == -1) {\r\nnphy_rxcal_txgain[0] = 0x8ff0 | pi->nphy_gmval;\r\nnphy_rxcal_txgain[1] = 0x8ff0 | pi->nphy_gmval;\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ,\r\n2, 0x110, 16,\r\nnphy_rxcal_txgain);\r\n} else {\r\nwlc_phy_txpwr_index_nphy(pi, tx_core + 1, txpwrindex,\r\nfalse);\r\n}\r\nwlc_phy_tx_tone_nphy(pi, (CHSPEC_IS40(pi->radio_chanspec)) ?\r\nNPHY_RXCAL_TONEFREQ_40MHz :\r\nNPHY_RXCAL_TONEFREQ_20MHz,\r\nNPHY_RXCAL_TONEAMP, 0, cal_type, false);\r\nwlc_phy_rx_iq_est_nphy(pi, est, num_samps, 32, 0);\r\ni_pwr = (est[rx_core].i_pwr + num_samps / 2) / num_samps;\r\nq_pwr = (est[rx_core].q_pwr + num_samps / 2) / num_samps;\r\ncurr_pwr = i_pwr + q_pwr;\r\nswitch (gainctrl_dirn) {\r\ncase NPHY_RXCAL_GAIN_INIT:\r\nif (curr_pwr > thresh_pwr) {\r\ngainctrl_dirn = NPHY_RXCAL_GAIN_DOWN;\r\nprev_gaintbl_index = curr_gaintbl_index;\r\ncurr_gaintbl_index--;\r\n} else {\r\ngainctrl_dirn = NPHY_RXCAL_GAIN_UP;\r\nprev_gaintbl_index = curr_gaintbl_index;\r\ncurr_gaintbl_index++;\r\n}\r\nbreak;\r\ncase NPHY_RXCAL_GAIN_UP:\r\nif (curr_pwr > thresh_pwr) {\r\ngainctrl_done = true;\r\noptim_pwr = prev_pwr;\r\noptim_gaintbl_index = prev_gaintbl_index;\r\n} else {\r\nprev_gaintbl_index = curr_gaintbl_index;\r\ncurr_gaintbl_index++;\r\n}\r\nbreak;\r\ncase NPHY_RXCAL_GAIN_DOWN:\r\nif (curr_pwr > thresh_pwr) {\r\nprev_gaintbl_index = curr_gaintbl_index;\r\ncurr_gaintbl_index--;\r\n} else {\r\ngainctrl_done = true;\r\noptim_pwr = curr_pwr;\r\noptim_gaintbl_index = curr_gaintbl_index;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif ((curr_gaintbl_index < 0) ||\r\n(curr_gaintbl_index > NPHY_IPA_RXCAL_MAXGAININDEX)) {\r\ngainctrl_done = true;\r\noptim_pwr = curr_pwr;\r\noptim_gaintbl_index = prev_gaintbl_index;\r\n} else {\r\nprev_pwr = curr_pwr;\r\n}\r\nwlc_phy_stopplayback_nphy(pi);\r\n} while (!gainctrl_done);\r\nhpvga = nphy_rxcal_gaintbl[optim_gaintbl_index].hpvga;\r\nlpf_biq1 = nphy_rxcal_gaintbl[optim_gaintbl_index].lpf_biq1;\r\nlpf_biq0 = nphy_rxcal_gaintbl[optim_gaintbl_index].lpf_biq0;\r\nlna2 = nphy_rxcal_gaintbl[optim_gaintbl_index].lna2;\r\nlna1 = nphy_rxcal_gaintbl[optim_gaintbl_index].lna1;\r\ntxpwrindex = nphy_rxcal_gaintbl[optim_gaintbl_index].txpwrindex;\r\nactual_log2_pwr = wlc_phy_nbits(optim_pwr);\r\ndelta_pwr = desired_log2_pwr - actual_log2_pwr;\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nfine_gain_idx = (int)lpf_biq1 + delta_pwr;\r\nif (fine_gain_idx + (int)lpf_biq0 > 10)\r\nlpf_biq1 = 10 - lpf_biq0;\r\nelse\r\nlpf_biq1 = (u16) max(fine_gain_idx, 0);\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_rxgain,\r\n((lpf_biq1 << 12) |\r\n(lpf_biq0 << 8) |\r\n(mix_tia_gain << 4) |\r\n(lna2 << 2) | lna1), 0x3,\r\n0);\r\n} else {\r\nhpvga = (u16) max(min(((int)hpvga) + delta_pwr, 10), 0);\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 12),\r\n((hpvga << 12) |\r\n(lpf_biq1 << 10) |\r\n(lpf_biq0 << 8) |\r\n(mix_tia_gain << 4) |\r\n(lna2 << 2) |\r\nlna1), 0x3, 0);\r\n}\r\nif (rxgain != NULL) {\r\n*rxgain++ = lna1;\r\n*rxgain++ = lna2;\r\n*rxgain++ = mix_tia_gain;\r\n*rxgain++ = lpf_biq0;\r\n*rxgain++ = lpf_biq1;\r\n*rxgain = hpvga;\r\n}\r\nwlc_phy_rx_iq_coeffs_nphy(pi, 1, &save_comp);\r\n}\r\nstatic void\r\nwlc_phy_rxcal_gainctrl_nphy(struct brcms_phy *pi, u8 rx_core, u16 *rxgain,\r\nu8 cal_type)\r\n{\r\nwlc_phy_rxcal_gainctrl_nphy_rev5(pi, rx_core, rxgain, cal_type);\r\n}\r\nstatic u8\r\nwlc_phy_rc_sweep_nphy(struct brcms_phy *pi, u8 core_idx, u8 loopback_type)\r\n{\r\nu32 target_bws[2] = { 9500, 21000 };\r\nu32 ref_tones[2] = { 3000, 6000 };\r\nu32 target_bw, ref_tone;\r\nu32 target_pwr_ratios[2] = { 28606, 18468 };\r\nu32 target_pwr_ratio, pwr_ratio, last_pwr_ratio = 0;\r\nu16 start_rccal_ovr_val = 128;\r\nu16 txlpf_rccal_lpc_ovr_val = 128;\r\nu16 rxlpf_rccal_hpc_ovr_val = 159;\r\nu16 orig_txlpf_rccal_lpc_ovr_val;\r\nu16 orig_rxlpf_rccal_hpc_ovr_val;\r\nu16 radio_addr_offset_rx;\r\nu16 radio_addr_offset_tx;\r\nu16 orig_dcBypass;\r\nu16 orig_RxStrnFilt40Num[6];\r\nu16 orig_RxStrnFilt40Den[4];\r\nu16 orig_rfctrloverride[2];\r\nu16 orig_rfctrlauxreg[2];\r\nu16 orig_rfctrlrssiothers;\r\nu16 tx_lpf_bw = 4;\r\nu16 rx_lpf_bw, rx_lpf_bws[2] = { 2, 4 };\r\nu16 lpf_hpc = 7, hpvga_hpc = 7;\r\ns8 rccal_stepsize;\r\nu16 rccal_val, last_rccal_val = 0, best_rccal_val = 0;\r\nu32 ref_iq_vals = 0, target_iq_vals = 0;\r\nu16 num_samps, log_num_samps = 10;\r\nstruct phy_iq_est est[PHY_CORE_MAX];\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nreturn 0;\r\nnum_samps = (1 << log_num_samps);\r\nif (CHSPEC_IS40(pi->radio_chanspec)) {\r\ntarget_bw = target_bws[1];\r\ntarget_pwr_ratio = target_pwr_ratios[1];\r\nref_tone = ref_tones[1];\r\nrx_lpf_bw = rx_lpf_bws[1];\r\n} else {\r\ntarget_bw = target_bws[0];\r\ntarget_pwr_ratio = target_pwr_ratios[0];\r\nref_tone = ref_tones[0];\r\nrx_lpf_bw = rx_lpf_bws[0];\r\n}\r\nif (core_idx == 0) {\r\nradio_addr_offset_rx = RADIO_2056_RX0;\r\nradio_addr_offset_tx =\r\n(loopback_type == 0) ? RADIO_2056_TX0 : RADIO_2056_TX1;\r\n} else {\r\nradio_addr_offset_rx = RADIO_2056_RX1;\r\nradio_addr_offset_tx =\r\n(loopback_type == 0) ? RADIO_2056_TX1 : RADIO_2056_TX0;\r\n}\r\norig_txlpf_rccal_lpc_ovr_val =\r\nread_radio_reg(pi,\r\n(RADIO_2056_TX_TXLPF_RCCAL |\r\nradio_addr_offset_tx));\r\norig_rxlpf_rccal_hpc_ovr_val =\r\nread_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_HPC |\r\nradio_addr_offset_rx));\r\norig_dcBypass = ((read_phy_reg(pi, 0x48) >> 8) & 1);\r\norig_RxStrnFilt40Num[0] = read_phy_reg(pi, 0x267);\r\norig_RxStrnFilt40Num[1] = read_phy_reg(pi, 0x268);\r\norig_RxStrnFilt40Num[2] = read_phy_reg(pi, 0x269);\r\norig_RxStrnFilt40Den[0] = read_phy_reg(pi, 0x26a);\r\norig_RxStrnFilt40Den[1] = read_phy_reg(pi, 0x26b);\r\norig_RxStrnFilt40Num[3] = read_phy_reg(pi, 0x26c);\r\norig_RxStrnFilt40Num[4] = read_phy_reg(pi, 0x26d);\r\norig_RxStrnFilt40Num[5] = read_phy_reg(pi, 0x26e);\r\norig_RxStrnFilt40Den[2] = read_phy_reg(pi, 0x26f);\r\norig_RxStrnFilt40Den[3] = read_phy_reg(pi, 0x270);\r\norig_rfctrloverride[0] = read_phy_reg(pi, 0xe7);\r\norig_rfctrloverride[1] = read_phy_reg(pi, 0xec);\r\norig_rfctrlauxreg[0] = read_phy_reg(pi, 0xf8);\r\norig_rfctrlauxreg[1] = read_phy_reg(pi, 0xfa);\r\norig_rfctrlrssiothers = read_phy_reg(pi, (core_idx == 0) ? 0x7a : 0x7d);\r\nwrite_radio_reg(pi, (RADIO_2056_TX_TXLPF_RCCAL | radio_addr_offset_tx),\r\ntxlpf_rccal_lpc_ovr_val);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_HPC | radio_addr_offset_rx),\r\nrxlpf_rccal_hpc_ovr_val);\r\nmod_phy_reg(pi, 0x48, (0x1 << 8), (0x1 << 8));\r\nwrite_phy_reg(pi, 0x267, 0x02d4);\r\nwrite_phy_reg(pi, 0x268, 0x0000);\r\nwrite_phy_reg(pi, 0x269, 0x0000);\r\nwrite_phy_reg(pi, 0x26a, 0x0000);\r\nwrite_phy_reg(pi, 0x26b, 0x0000);\r\nwrite_phy_reg(pi, 0x26c, 0x02d4);\r\nwrite_phy_reg(pi, 0x26d, 0x0000);\r\nwrite_phy_reg(pi, 0x26e, 0x0000);\r\nwrite_phy_reg(pi, 0x26f, 0x0000);\r\nwrite_phy_reg(pi, 0x270, 0x0000);\r\nor_phy_reg(pi, (core_idx == 0) ? 0xe7 : 0xec, (0x1 << 8));\r\nor_phy_reg(pi, (core_idx == 0) ? 0xec : 0xe7, (0x1 << 15));\r\nor_phy_reg(pi, (core_idx == 0) ? 0xe7 : 0xec, (0x1 << 9));\r\nor_phy_reg(pi, (core_idx == 0) ? 0xe7 : 0xec, (0x1 << 10));\r\nmod_phy_reg(pi, (core_idx == 0) ? 0xfa : 0xf8,\r\n(0x7 << 10), (tx_lpf_bw << 10));\r\nmod_phy_reg(pi, (core_idx == 0) ? 0xf8 : 0xfa,\r\n(0x7 << 0), (hpvga_hpc << 0));\r\nmod_phy_reg(pi, (core_idx == 0) ? 0xf8 : 0xfa,\r\n(0x7 << 4), (lpf_hpc << 4));\r\nmod_phy_reg(pi, (core_idx == 0) ? 0x7a : 0x7d,\r\n(0x7 << 8), (rx_lpf_bw << 8));\r\nrccal_stepsize = 16;\r\nrccal_val = start_rccal_ovr_val + rccal_stepsize;\r\nwhile (rccal_stepsize >= 0) {\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_LPC |\r\nradio_addr_offset_rx), rccal_val);\r\nif (rccal_stepsize == 16) {\r\nwlc_phy_tx_tone_nphy(pi, ref_tone, NPHY_RXCAL_TONEAMP,\r\n0, 1, false);\r\nudelay(2);\r\nwlc_phy_rx_iq_est_nphy(pi, est, num_samps, 32, 0);\r\nif (core_idx == 0)\r\nref_iq_vals =\r\nmax_t(u32, (est[0].i_pwr +\r\nest[0].q_pwr) >>\r\n(log_num_samps + 1),\r\n1);\r\nelse\r\nref_iq_vals =\r\nmax_t(u32, (est[1].i_pwr +\r\nest[1].q_pwr) >>\r\n(log_num_samps + 1),\r\n1);\r\nwlc_phy_tx_tone_nphy(pi, target_bw, NPHY_RXCAL_TONEAMP,\r\n0, 1, false);\r\nudelay(2);\r\n}\r\nwlc_phy_rx_iq_est_nphy(pi, est, num_samps, 32, 0);\r\nif (core_idx == 0)\r\ntarget_iq_vals = (est[0].i_pwr + est[0].q_pwr) >>\r\n(log_num_samps + 1);\r\nelse\r\ntarget_iq_vals =\r\n(est[1].i_pwr +\r\nest[1].q_pwr) >> (log_num_samps + 1);\r\npwr_ratio = (uint) ((target_iq_vals << 16) / ref_iq_vals);\r\nif (rccal_stepsize == 0)\r\nrccal_stepsize--;\r\nelse if (rccal_stepsize == 1) {\r\nlast_rccal_val = rccal_val;\r\nrccal_val += (pwr_ratio > target_pwr_ratio) ? 1 : -1;\r\nlast_pwr_ratio = pwr_ratio;\r\nrccal_stepsize--;\r\n} else {\r\nrccal_stepsize = (rccal_stepsize >> 1);\r\nrccal_val += ((pwr_ratio > target_pwr_ratio) ?\r\nrccal_stepsize : (-rccal_stepsize));\r\n}\r\nif (rccal_stepsize == -1) {\r\nbest_rccal_val =\r\n(abs((int)last_pwr_ratio -\r\n(int)target_pwr_ratio) <\r\nabs((int)pwr_ratio -\r\n(int)target_pwr_ratio)) ? last_rccal_val :\r\nrccal_val;\r\nif (CHSPEC_IS40(pi->radio_chanspec)) {\r\nif ((best_rccal_val > 140)\r\n|| (best_rccal_val < 135))\r\nbest_rccal_val = 138;\r\n} else {\r\nif ((best_rccal_val > 142)\r\n|| (best_rccal_val < 137))\r\nbest_rccal_val = 140;\r\n}\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_LPC |\r\nradio_addr_offset_rx), best_rccal_val);\r\n}\r\n}\r\nwlc_phy_stopplayback_nphy(pi);\r\nwrite_radio_reg(pi, (RADIO_2056_TX_TXLPF_RCCAL | radio_addr_offset_tx),\r\norig_txlpf_rccal_lpc_ovr_val);\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_HPC | radio_addr_offset_rx),\r\norig_rxlpf_rccal_hpc_ovr_val);\r\nmod_phy_reg(pi, 0x48, (0x1 << 8), (orig_dcBypass << 8));\r\nwrite_phy_reg(pi, 0x267, orig_RxStrnFilt40Num[0]);\r\nwrite_phy_reg(pi, 0x268, orig_RxStrnFilt40Num[1]);\r\nwrite_phy_reg(pi, 0x269, orig_RxStrnFilt40Num[2]);\r\nwrite_phy_reg(pi, 0x26a, orig_RxStrnFilt40Den[0]);\r\nwrite_phy_reg(pi, 0x26b, orig_RxStrnFilt40Den[1]);\r\nwrite_phy_reg(pi, 0x26c, orig_RxStrnFilt40Num[3]);\r\nwrite_phy_reg(pi, 0x26d, orig_RxStrnFilt40Num[4]);\r\nwrite_phy_reg(pi, 0x26e, orig_RxStrnFilt40Num[5]);\r\nwrite_phy_reg(pi, 0x26f, orig_RxStrnFilt40Den[2]);\r\nwrite_phy_reg(pi, 0x270, orig_RxStrnFilt40Den[3]);\r\nwrite_phy_reg(pi, 0xe7, orig_rfctrloverride[0]);\r\nwrite_phy_reg(pi, 0xec, orig_rfctrloverride[1]);\r\nwrite_phy_reg(pi, 0xf8, orig_rfctrlauxreg[0]);\r\nwrite_phy_reg(pi, 0xfa, orig_rfctrlauxreg[1]);\r\nwrite_phy_reg(pi, (core_idx == 0) ? 0x7a : 0x7d, orig_rfctrlrssiothers);\r\npi->nphy_anarxlpf_adjusted = false;\r\nreturn best_rccal_val - 0x80;\r\n}\r\nstatic int wlc_phy_cal_rxiq_nphy_rev3(struct brcms_phy *pi,\r\nstruct nphy_txgains target_gain,\r\nu8 cal_type, bool debug)\r\n{\r\nu16 orig_BBConfig;\r\nu8 core_no, rx_core;\r\nu8 best_rccal[2];\r\nu16 gain_save[2];\r\nu16 cal_gain[2];\r\nstruct nphy_iqcal_params cal_params[2];\r\nu8 rxcore_state;\r\ns8 rxlpf_rccal_hpc, txlpf_rccal_lpc;\r\ns8 txlpf_idac;\r\nbool phyhang_avoid_state = false;\r\nbool skip_rxiqcal = false;\r\norig_BBConfig = read_phy_reg(pi, 0x01);\r\nmod_phy_reg(pi, 0x01, (0x1 << 15), 0);\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (NREV_GE(pi->pubpi.phy_rev, 4)) {\r\nphyhang_avoid_state = pi->phyhang_avoid;\r\npi->phyhang_avoid = false;\r\n}\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, gain_save);\r\nfor (core_no = 0; core_no <= 1; core_no++) {\r\nwlc_phy_iqcal_gainparams_nphy(pi, core_no, target_gain,\r\n&cal_params[core_no]);\r\ncal_gain[core_no] = cal_params[core_no].cal_gain;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, cal_gain);\r\nrxcore_state = wlc_phy_rxcore_getstate_nphy(\r\n(struct brcms_phy_pub *) pi);\r\nfor (rx_core = 0; rx_core < pi->pubpi.phy_corenum; rx_core++) {\r\nskip_rxiqcal =\r\n((rxcore_state & (1 << rx_core)) == 0) ? true : false;\r\nwlc_phy_rxcal_physetup_nphy(pi, rx_core);\r\nwlc_phy_rxcal_radio_setup_nphy(pi, rx_core);\r\nif ((!skip_rxiqcal) && ((cal_type == 0) || (cal_type == 2))) {\r\nwlc_phy_rxcal_gainctrl_nphy(pi, rx_core, NULL, 0);\r\nwlc_phy_tx_tone_nphy(pi,\r\n(CHSPEC_IS40(\r\npi->radio_chanspec)) ?\r\nNPHY_RXCAL_TONEFREQ_40MHz :\r\nNPHY_RXCAL_TONEFREQ_20MHz,\r\nNPHY_RXCAL_TONEAMP, 0, cal_type,\r\nfalse);\r\nif (debug)\r\nmdelay(WAIT_FOR_SCOPE);\r\nwlc_phy_calc_rx_iq_comp_nphy(pi, rx_core + 1);\r\nwlc_phy_stopplayback_nphy(pi);\r\n}\r\nif (((cal_type == 1) || (cal_type == 2))\r\n&& NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nif (rx_core == PHY_CORE_1) {\r\nif (rxcore_state == 1)\r\nwlc_phy_rxcore_setstate_nphy(\r\n(struct brcms_phy_pub *) pi, 3);\r\nwlc_phy_rxcal_gainctrl_nphy(pi, rx_core, NULL,\r\n1);\r\nbest_rccal[rx_core] =\r\nwlc_phy_rc_sweep_nphy(pi, rx_core, 1);\r\npi->nphy_rccal_value = best_rccal[rx_core];\r\nif (rxcore_state == 1)\r\nwlc_phy_rxcore_setstate_nphy(\r\n(struct brcms_phy_pub *) pi,\r\nrxcore_state);\r\n}\r\n}\r\nwlc_phy_rxcal_radio_cleanup_nphy(pi, rx_core);\r\nwlc_phy_rxcal_phycleanup_nphy(pi, rx_core);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\n}\r\nif ((cal_type == 1) || (cal_type == 2)) {\r\nbest_rccal[0] = best_rccal[1];\r\nwrite_radio_reg(pi,\r\n(RADIO_2056_RX_RXLPF_RCCAL_LPC |\r\nRADIO_2056_RX0), (best_rccal[0] | 0x80));\r\nfor (rx_core = 0; rx_core < pi->pubpi.phy_corenum; rx_core++) {\r\nrxlpf_rccal_hpc =\r\n(((int)best_rccal[rx_core] - 12) >> 1) + 10;\r\ntxlpf_rccal_lpc = ((int)best_rccal[rx_core] - 12) + 10;\r\nif (PHY_IPA(pi)) {\r\ntxlpf_rccal_lpc +=\r\n(pi->bw == WL_CHANSPEC_BW_40) ? 24 : 12;\r\ntxlpf_idac = (pi->bw == WL_CHANSPEC_BW_40) ?\r\n0x0e : 0x13;\r\nWRITE_RADIO_REG2(pi, RADIO_2056, TX, rx_core,\r\nTXLPF_IDAC_4, txlpf_idac);\r\n}\r\nrxlpf_rccal_hpc = max(min_t(u8, rxlpf_rccal_hpc, 31),\r\n0);\r\ntxlpf_rccal_lpc = max(min_t(u8, txlpf_rccal_lpc, 31),\r\n0);\r\nwrite_radio_reg(pi, (RADIO_2056_RX_RXLPF_RCCAL_HPC |\r\n((rx_core ==\r\nPHY_CORE_0) ? RADIO_2056_RX0 :\r\nRADIO_2056_RX1)),\r\n(rxlpf_rccal_hpc | 0x80));\r\nwrite_radio_reg(pi, (RADIO_2056_TX_TXLPF_RCCAL |\r\n((rx_core ==\r\nPHY_CORE_0) ? RADIO_2056_TX0 :\r\nRADIO_2056_TX1)),\r\n(txlpf_rccal_lpc | 0x80));\r\n}\r\n}\r\nwrite_phy_reg(pi, 0x01, orig_BBConfig);\r\nwlc_phy_resetcca_nphy(pi);\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\nwlc_phy_rfctrl_override_1tomany_nphy(\r\npi,\r\nNPHY_REV7_RfctrlOverride_cmd_rxgain,\r\n0, 0x3, 1);\r\nelse\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 12), 0, 0x3, 1);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ngain_save);\r\nif (NREV_GE(pi->pubpi.phy_rev, 4))\r\npi->phyhang_avoid = phyhang_avoid_state;\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nreturn 0;\r\n}\r\nstatic int\r\nwlc_phy_cal_rxiq_nphy_rev2(struct brcms_phy *pi,\r\nstruct nphy_txgains target_gain, bool debug)\r\n{\r\nstruct phy_iq_est est[PHY_CORE_MAX];\r\nu8 core_num, rx_core, tx_core;\r\nu16 lna_vals[] = { 0x3, 0x3, 0x1 };\r\nu16 hpf1_vals[] = { 0x7, 0x2, 0x0 };\r\nu16 hpf2_vals[] = { 0x2, 0x0, 0x0 };\r\ns16 curr_hpf1, curr_hpf2, curr_hpf, curr_lna;\r\ns16 desired_log2_pwr, actual_log2_pwr, hpf_change;\r\nu16 orig_RfseqCoreActv, orig_AfectrlCore, orig_AfectrlOverride;\r\nu16 orig_RfctrlIntcRx, orig_RfctrlIntcTx;\r\nu16 num_samps;\r\nu32 i_pwr, q_pwr, tot_pwr[3];\r\nu8 gain_pass, use_hpf_num;\r\nu16 mask, val1, val2;\r\nu16 core_no;\r\nu16 gain_save[2];\r\nu16 cal_gain[2];\r\nstruct nphy_iqcal_params cal_params[2];\r\nu8 phy_bw;\r\nint bcmerror = 0;\r\nbool first_playtone = true;\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2))\r\nwlc_phy_reapply_txcal_coeffs_nphy(pi);\r\nwlc_phy_table_read_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, gain_save);\r\nfor (core_no = 0; core_no <= 1; core_no++) {\r\nwlc_phy_iqcal_gainparams_nphy(pi, core_no, target_gain,\r\n&cal_params[core_no]);\r\ncal_gain[core_no] = cal_params[core_no].cal_gain;\r\n}\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16, cal_gain);\r\nnum_samps = 1024;\r\ndesired_log2_pwr = 13;\r\nfor (core_num = 0; core_num < 2; core_num++) {\r\nrx_core = core_num;\r\ntx_core = 1 - core_num;\r\norig_RfseqCoreActv = read_phy_reg(pi, 0xa2);\r\norig_AfectrlCore = read_phy_reg(pi, (rx_core == PHY_CORE_0) ?\r\n0xa6 : 0xa7);\r\norig_AfectrlOverride = read_phy_reg(pi, 0xa5);\r\norig_RfctrlIntcRx = read_phy_reg(pi, (rx_core == PHY_CORE_0) ?\r\n0x91 : 0x92);\r\norig_RfctrlIntcTx = read_phy_reg(pi, (tx_core == PHY_CORE_0) ?\r\n0x91 : 0x92);\r\nmod_phy_reg(pi, 0xa2, (0xf << 12), (1 << tx_core) << 12);\r\nmod_phy_reg(pi, 0xa2, (0xf << 0), (1 << tx_core) << 0);\r\nor_phy_reg(pi, ((rx_core == PHY_CORE_0) ? 0xa6 : 0xa7),\r\n((0x1 << 1) | (0x1 << 2)));\r\nor_phy_reg(pi, 0xa5, ((0x1 << 1) | (0x1 << 2)));\r\nif (((pi->nphy_rxcalparams) & 0xff000000))\r\nwrite_phy_reg(pi,\r\n(rx_core == PHY_CORE_0) ? 0x91 : 0x92,\r\n(CHSPEC_IS5G(pi->radio_chanspec) ?\r\n0x140 : 0x110));\r\nelse\r\nwrite_phy_reg(pi,\r\n(rx_core == PHY_CORE_0) ? 0x91 : 0x92,\r\n(CHSPEC_IS5G(pi->radio_chanspec) ?\r\n0x180 : 0x120));\r\nwrite_phy_reg(pi, (tx_core == PHY_CORE_0) ? 0x91 : 0x92,\r\n(CHSPEC_IS5G(pi->radio_chanspec) ? 0x148 :\r\n0x114));\r\nmask = RADIO_2055_COUPLE_RX_MASK | RADIO_2055_COUPLE_TX_MASK;\r\nif (rx_core == PHY_CORE_0) {\r\nval1 = RADIO_2055_COUPLE_RX_MASK;\r\nval2 = RADIO_2055_COUPLE_TX_MASK;\r\n} else {\r\nval1 = RADIO_2055_COUPLE_TX_MASK;\r\nval2 = RADIO_2055_COUPLE_RX_MASK;\r\n}\r\nif ((pi->nphy_rxcalparams & 0x10000)) {\r\nmod_radio_reg(pi, RADIO_2055_CORE1_GEN_SPARE2, mask,\r\nval1);\r\nmod_radio_reg(pi, RADIO_2055_CORE2_GEN_SPARE2, mask,\r\nval2);\r\n}\r\nfor (gain_pass = 0; gain_pass < 4; gain_pass++) {\r\nif (debug)\r\nmdelay(WAIT_FOR_SCOPE);\r\nif (gain_pass < 3) {\r\ncurr_lna = lna_vals[gain_pass];\r\ncurr_hpf1 = hpf1_vals[gain_pass];\r\ncurr_hpf2 = hpf2_vals[gain_pass];\r\n} else {\r\nif (tot_pwr[1] > 10000) {\r\ncurr_lna = lna_vals[2];\r\ncurr_hpf1 = hpf1_vals[2];\r\ncurr_hpf2 = hpf2_vals[2];\r\nuse_hpf_num = 1;\r\ncurr_hpf = curr_hpf1;\r\nactual_log2_pwr =\r\nwlc_phy_nbits(tot_pwr[2]);\r\n} else {\r\nif (tot_pwr[0] > 10000) {\r\ncurr_lna = lna_vals[1];\r\ncurr_hpf1 = hpf1_vals[1];\r\ncurr_hpf2 = hpf2_vals[1];\r\nuse_hpf_num = 1;\r\ncurr_hpf = curr_hpf1;\r\nactual_log2_pwr =\r\nwlc_phy_nbits(\r\ntot_pwr[1]);\r\n} else {\r\ncurr_lna = lna_vals[0];\r\ncurr_hpf1 = hpf1_vals[0];\r\ncurr_hpf2 = hpf2_vals[0];\r\nuse_hpf_num = 2;\r\ncurr_hpf = curr_hpf2;\r\nactual_log2_pwr =\r\nwlc_phy_nbits(\r\ntot_pwr[0]);\r\n}\r\n}\r\nhpf_change = desired_log2_pwr - actual_log2_pwr;\r\ncurr_hpf += hpf_change;\r\ncurr_hpf = max(min_t(u16, curr_hpf, 10), 0);\r\nif (use_hpf_num == 1)\r\ncurr_hpf1 = curr_hpf;\r\nelse\r\ncurr_hpf2 = curr_hpf;\r\n}\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 10),\r\n((curr_hpf2 << 8) |\r\n(curr_hpf1 << 4) |\r\n(curr_lna << 2)), 0x3, 0);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nwlc_phy_stopplayback_nphy(pi);\r\nif (first_playtone) {\r\nbcmerror = wlc_phy_tx_tone_nphy(pi, 4000,\r\n(u16) (pi->nphy_rxcalparams &\r\n0xffff), 0, 0, true);\r\nfirst_playtone = false;\r\n} else {\r\nphy_bw = (CHSPEC_IS40(pi->radio_chanspec)) ?\r\n40 : 20;\r\nwlc_phy_runsamples_nphy(pi, phy_bw * 8, 0xffff,\r\n0, 0, 0, true);\r\n}\r\nif (bcmerror == 0) {\r\nif (gain_pass < 3) {\r\nwlc_phy_rx_iq_est_nphy(pi, est,\r\nnum_samps, 32,\r\n0);\r\ni_pwr = (est[rx_core].i_pwr +\r\nnum_samps / 2) / num_samps;\r\nq_pwr = (est[rx_core].q_pwr +\r\nnum_samps / 2) / num_samps;\r\ntot_pwr[gain_pass] = i_pwr + q_pwr;\r\n} else {\r\nwlc_phy_calc_rx_iq_comp_nphy(pi,\r\n(1 <<\r\nrx_core));\r\n}\r\nwlc_phy_stopplayback_nphy(pi);\r\n}\r\nif (bcmerror != 0)\r\nbreak;\r\n}\r\nand_radio_reg(pi, RADIO_2055_CORE1_GEN_SPARE2, ~mask);\r\nand_radio_reg(pi, RADIO_2055_CORE2_GEN_SPARE2, ~mask);\r\nwrite_phy_reg(pi, (tx_core == PHY_CORE_0) ? 0x91 :\r\n0x92, orig_RfctrlIntcTx);\r\nwrite_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0x91 :\r\n0x92, orig_RfctrlIntcRx);\r\nwrite_phy_reg(pi, 0xa5, orig_AfectrlOverride);\r\nwrite_phy_reg(pi, (rx_core == PHY_CORE_0) ? 0xa6 :\r\n0xa7, orig_AfectrlCore);\r\nwrite_phy_reg(pi, 0xa2, orig_RfseqCoreActv);\r\nif (bcmerror != 0)\r\nbreak;\r\n}\r\nwlc_phy_rfctrl_override_nphy(pi, (0x1 << 10), 0, 0x3, 1);\r\nwlc_phy_force_rfseq_nphy(pi, NPHY_RFSEQ_RESET2RX);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_RFSEQ, 2, 0x110, 16,\r\ngain_save);\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\nreturn bcmerror;\r\n}\r\nint\r\nwlc_phy_cal_rxiq_nphy(struct brcms_phy *pi, struct nphy_txgains target_gain,\r\nu8 cal_type, bool debug)\r\n{\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\ncal_type = 0;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nreturn wlc_phy_cal_rxiq_nphy_rev3(pi, target_gain, cal_type,\r\ndebug);\r\nelse\r\nreturn wlc_phy_cal_rxiq_nphy_rev2(pi, target_gain, debug);\r\n}\r\nvoid wlc_phy_txpwr_fixpower_nphy(struct brcms_phy *pi)\r\n{\r\nuint core;\r\nu32 txgain;\r\nu16 rad_gain, dac_gain, bbmult, m1m2;\r\nu8 txpi[2], chan_freq_range;\r\ns32 rfpwr_offset;\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nif (pi->sh->sromrev < 4) {\r\ntxpi[0] = txpi[1] = 72;\r\n} else {\r\nchan_freq_range = wlc_phy_get_chan_freq_range_nphy(pi, 0);\r\nswitch (chan_freq_range) {\r\ncase WL_CHAN_FREQ_RANGE_2G:\r\ncase WL_CHAN_FREQ_RANGE_5GL:\r\ncase WL_CHAN_FREQ_RANGE_5GM:\r\ncase WL_CHAN_FREQ_RANGE_5GH:\r\ntxpi[0] = 0;\r\ntxpi[1] = 0;\r\nbreak;\r\ndefault:\r\ntxpi[0] = txpi[1] = 91;\r\nbreak;\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 7))\r\ntxpi[0] = txpi[1] = 30;\r\nelse if (NREV_GE(pi->pubpi.phy_rev, 3))\r\ntxpi[0] = txpi[1] = 40;\r\nif (NREV_LT(pi->pubpi.phy_rev, 7)) {\r\nif ((txpi[0] < 40) || (txpi[0] > 100) ||\r\n(txpi[1] < 40) || (txpi[1] > 100))\r\ntxpi[0] = txpi[1] = 91;\r\n}\r\npi->nphy_txpwrindex[PHY_CORE_0].index_internal = txpi[0];\r\npi->nphy_txpwrindex[PHY_CORE_1].index_internal = txpi[1];\r\npi->nphy_txpwrindex[PHY_CORE_0].index_internal_save = txpi[0];\r\npi->nphy_txpwrindex[PHY_CORE_1].index_internal_save = txpi[1];\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nuint phyrev = pi->pubpi.phy_rev;\r\nif (NREV_GE(phyrev, 3)) {\r\nif (PHY_IPA(pi)) {\r\nu32 *tx_gaintbl =\r\nwlc_phy_get_ipa_gaintbl_nphy(pi);\r\ntxgain = tx_gaintbl[txpi[core]];\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_IS(phyrev, 3)) {\r\ntxgain =\r\nnphy_tpc_5GHz_txgain_rev3\r\n[txpi[core]];\r\n} else if (NREV_IS(phyrev, 4)) {\r\ntxgain = (\r\npi->srom_fem5g.extpagain ==\r\n3) ?\r\nnphy_tpc_5GHz_txgain_HiPwrEPA\r\n[txpi[core]] :\r\nnphy_tpc_5GHz_txgain_rev4\r\n[txpi[core]];\r\n} else {\r\ntxgain =\r\nnphy_tpc_5GHz_txgain_rev5\r\n[txpi[core]];\r\n}\r\n} else {\r\nif (NREV_GE(phyrev, 5) &&\r\n(pi->srom_fem2g.extpagain == 3)) {\r\ntxgain =\r\nnphy_tpc_txgain_HiPwrEPA\r\n[txpi[core]];\r\n} else {\r\ntxgain = nphy_tpc_txgain_rev3\r\n[txpi[core]];\r\n}\r\n}\r\n}\r\n} else {\r\ntxgain = nphy_tpc_txgain[txpi[core]];\r\n}\r\nif (NREV_GE(phyrev, 3))\r\nrad_gain = (txgain >> 16) & ((1 << (32 - 16 + 1)) - 1);\r\nelse\r\nrad_gain = (txgain >> 16) & ((1 << (28 - 16 + 1)) - 1);\r\nif (NREV_GE(phyrev, 7))\r\ndac_gain = (txgain >> 8) & ((1 << (10 - 8 + 1)) - 1);\r\nelse\r\ndac_gain = (txgain >> 8) & ((1 << (13 - 8 + 1)) - 1);\r\nbbmult = (txgain >> 0) & ((1 << (7 - 0 + 1)) - 1);\r\nif (NREV_GE(phyrev, 3))\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0x8f :\r\n0xa5), (0x1 << 8), (0x1 << 8));\r\nelse\r\nmod_phy_reg(pi, 0xa5, (0x1 << 14), (0x1 << 14));\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ? 0xaa : 0xab, dac_gain);\r\nwlc_phy_table_write_nphy(pi, 7, 1, (0x110 + core), 16,\r\n&rad_gain);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nm1m2 &= ((core == PHY_CORE_0) ? 0x00ff : 0xff00);\r\nm1m2 |= ((core == PHY_CORE_0) ? (bbmult << 8) : (bbmult << 0));\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nif (PHY_IPA(pi)) {\r\nwlc_phy_table_read_nphy(pi,\r\n(core ==\r\nPHY_CORE_0 ?\r\nNPHY_TBL_ID_CORE1TXPWRCTL :\r\nNPHY_TBL_ID_CORE2TXPWRCTL), 1,\r\n576 + txpi[core], 32,\r\n&rfpwr_offset);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1ff << 4),\r\n((s16) rfpwr_offset) << 4);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 2), (1) << 2);\r\n}\r\n}\r\nand_phy_reg(pi, 0xbf, (u16) (~(0x1f << 0)));\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nstatic void\r\nwlc_phy_txpwr_nphy_srom_convert(u8 *srom_max, u16 *pwr_offset,\r\nu8 tmp_max_pwr, u8 rate_start,\r\nu8 rate_end)\r\n{\r\nu8 rate;\r\nu8 word_num, nibble_num;\r\nu8 tmp_nibble;\r\nfor (rate = rate_start; rate <= rate_end; rate++) {\r\nword_num = (rate - rate_start) >> 2;\r\nnibble_num = (rate - rate_start) & 0x3;\r\ntmp_nibble = (pwr_offset[word_num] >> 4 * nibble_num) & 0xf;\r\nsrom_max[rate] = tmp_max_pwr - 2 * tmp_nibble;\r\n}\r\n}\r\nstatic void\r\nwlc_phy_txpwr_nphy_po_apply(u8 *srom_max, u8 pwr_offset,\r\nu8 rate_start, u8 rate_end)\r\n{\r\nu8 rate;\r\nfor (rate = rate_start; rate <= rate_end; rate++)\r\nsrom_max[rate] -= 2 * pwr_offset;\r\n}\r\nvoid\r\nwlc_phy_ofdm_to_mcs_powers_nphy(u8 *power, u8 rate_mcs_start,\r\nu8 rate_mcs_end, u8 rate_ofdm_start)\r\n{\r\nu8 rate1, rate2;\r\nrate2 = rate_ofdm_start;\r\nfor (rate1 = rate_mcs_start; rate1 <= rate_mcs_end - 1; rate1++) {\r\npower[rate1] = power[rate2];\r\nrate2 += (rate1 == rate_mcs_start) ? 2 : 1;\r\n}\r\npower[rate_mcs_end] = power[rate_mcs_end - 1];\r\n}\r\nvoid\r\nwlc_phy_mcs_to_ofdm_powers_nphy(u8 *power, u8 rate_ofdm_start,\r\nu8 rate_ofdm_end, u8 rate_mcs_start)\r\n{\r\nu8 rate1, rate2;\r\nfor (rate1 = rate_ofdm_start, rate2 = rate_mcs_start;\r\nrate1 <= rate_ofdm_end; rate1++, rate2++) {\r\npower[rate1] = power[rate2];\r\nif (rate1 == rate_ofdm_start)\r\npower[++rate1] = power[rate2];\r\n}\r\n}\r\nvoid wlc_phy_txpwr_apply_nphy(struct brcms_phy *pi)\r\n{\r\nuint rate1, rate2, band_num;\r\nu8 tmp_bw40po = 0, tmp_cddpo = 0, tmp_stbcpo = 0;\r\nu8 tmp_max_pwr = 0;\r\nu16 pwr_offsets1[2], *pwr_offsets2 = NULL;\r\nu8 *tx_srom_max_rate = NULL;\r\nfor (band_num = 0; band_num < (CH_2G_GROUP + CH_5G_GROUP);\r\nband_num++) {\r\nswitch (band_num) {\r\ncase 0:\r\ntmp_max_pwr = min(pi->nphy_pwrctrl_info[0].max_pwr_2g,\r\npi->nphy_pwrctrl_info[1].max_pwr_2g);\r\npwr_offsets1[0] = pi->cck2gpo;\r\nwlc_phy_txpwr_nphy_srom_convert(pi->tx_srom_max_rate_2g,\r\npwr_offsets1,\r\ntmp_max_pwr,\r\nTXP_FIRST_CCK,\r\nTXP_LAST_CCK);\r\npwr_offsets1[0] = (u16) (pi->ofdm2gpo & 0xffff);\r\npwr_offsets1[1] =\r\n(u16) (pi->ofdm2gpo >> 16) & 0xffff;\r\npwr_offsets2 = pi->mcs2gpo;\r\ntmp_cddpo = pi->cdd2gpo;\r\ntmp_stbcpo = pi->stbc2gpo;\r\ntmp_bw40po = pi->bw402gpo;\r\ntx_srom_max_rate = pi->tx_srom_max_rate_2g;\r\nbreak;\r\ncase 1:\r\ntmp_max_pwr = min(pi->nphy_pwrctrl_info[0].max_pwr_5gm,\r\npi->nphy_pwrctrl_info[1].max_pwr_5gm);\r\npwr_offsets1[0] = (u16) (pi->ofdm5gpo & 0xffff);\r\npwr_offsets1[1] =\r\n(u16) (pi->ofdm5gpo >> 16) & 0xffff;\r\npwr_offsets2 = pi->mcs5gpo;\r\ntmp_cddpo = pi->cdd5gpo;\r\ntmp_stbcpo = pi->stbc5gpo;\r\ntmp_bw40po = pi->bw405gpo;\r\ntx_srom_max_rate = pi->tx_srom_max_rate_5g_mid;\r\nbreak;\r\ncase 2:\r\ntmp_max_pwr = min(pi->nphy_pwrctrl_info[0].max_pwr_5gl,\r\npi->nphy_pwrctrl_info[1].max_pwr_5gl);\r\npwr_offsets1[0] = (u16) (pi->ofdm5glpo & 0xffff);\r\npwr_offsets1[1] =\r\n(u16) (pi->ofdm5glpo >> 16) & 0xffff;\r\npwr_offsets2 = pi->mcs5glpo;\r\ntmp_cddpo = pi->cdd5glpo;\r\ntmp_stbcpo = pi->stbc5glpo;\r\ntmp_bw40po = pi->bw405glpo;\r\ntx_srom_max_rate = pi->tx_srom_max_rate_5g_low;\r\nbreak;\r\ncase 3:\r\ntmp_max_pwr = min(pi->nphy_pwrctrl_info[0].max_pwr_5gh,\r\npi->nphy_pwrctrl_info[1].max_pwr_5gh);\r\npwr_offsets1[0] = (u16) (pi->ofdm5ghpo & 0xffff);\r\npwr_offsets1[1] =\r\n(u16) (pi->ofdm5ghpo >> 16) & 0xffff;\r\npwr_offsets2 = pi->mcs5ghpo;\r\ntmp_cddpo = pi->cdd5ghpo;\r\ntmp_stbcpo = pi->stbc5ghpo;\r\ntmp_bw40po = pi->bw405ghpo;\r\ntx_srom_max_rate = pi->tx_srom_max_rate_5g_hi;\r\nbreak;\r\n}\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate, pwr_offsets1,\r\ntmp_max_pwr, TXP_FIRST_OFDM,\r\nTXP_LAST_OFDM);\r\nwlc_phy_ofdm_to_mcs_powers_nphy(tx_srom_max_rate,\r\nTXP_FIRST_MCS_20_SISO,\r\nTXP_LAST_MCS_20_SISO,\r\nTXP_FIRST_OFDM);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate, pwr_offsets2,\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_20_CDD,\r\nTXP_LAST_MCS_20_CDD);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_txpwr_nphy_po_apply(tx_srom_max_rate, tmp_cddpo,\r\nTXP_FIRST_MCS_20_CDD,\r\nTXP_LAST_MCS_20_CDD);\r\nwlc_phy_mcs_to_ofdm_powers_nphy(tx_srom_max_rate,\r\nTXP_FIRST_OFDM_20_CDD,\r\nTXP_LAST_OFDM_20_CDD,\r\nTXP_FIRST_MCS_20_CDD);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate, pwr_offsets2,\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_20_STBC,\r\nTXP_LAST_MCS_20_STBC);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_txpwr_nphy_po_apply(tx_srom_max_rate,\r\ntmp_stbcpo,\r\nTXP_FIRST_MCS_20_STBC,\r\nTXP_LAST_MCS_20_STBC);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate,\r\n&pwr_offsets2[2], tmp_max_pwr,\r\nTXP_FIRST_MCS_20_SDM,\r\nTXP_LAST_MCS_20_SDM);\r\nif (NPHY_IS_SROM_REINTERPRET) {\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate,\r\n&pwr_offsets2[4],\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_40_SISO,\r\nTXP_LAST_MCS_40_SISO);\r\nwlc_phy_mcs_to_ofdm_powers_nphy(tx_srom_max_rate,\r\nTXP_FIRST_OFDM_40_SISO,\r\nTXP_LAST_OFDM_40_SISO,\r\nTXP_FIRST_MCS_40_SISO);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate,\r\n&pwr_offsets2[4],\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_40_CDD,\r\nTXP_LAST_MCS_40_CDD);\r\nwlc_phy_txpwr_nphy_po_apply(tx_srom_max_rate, tmp_cddpo,\r\nTXP_FIRST_MCS_40_CDD,\r\nTXP_LAST_MCS_40_CDD);\r\nwlc_phy_mcs_to_ofdm_powers_nphy(tx_srom_max_rate,\r\nTXP_FIRST_OFDM_40_CDD,\r\nTXP_LAST_OFDM_40_CDD,\r\nTXP_FIRST_MCS_40_CDD);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate,\r\n&pwr_offsets2[4],\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_40_STBC,\r\nTXP_LAST_MCS_40_STBC);\r\nwlc_phy_txpwr_nphy_po_apply(tx_srom_max_rate,\r\ntmp_stbcpo,\r\nTXP_FIRST_MCS_40_STBC,\r\nTXP_LAST_MCS_40_STBC);\r\nwlc_phy_txpwr_nphy_srom_convert(tx_srom_max_rate,\r\n&pwr_offsets2[6],\r\ntmp_max_pwr,\r\nTXP_FIRST_MCS_40_SDM,\r\nTXP_LAST_MCS_40_SDM);\r\n} else {\r\nfor (rate1 = TXP_FIRST_OFDM_40_SISO, rate2 =\r\nTXP_FIRST_OFDM;\r\nrate1 <= TXP_LAST_MCS_40_SDM;\r\nrate1++, rate2++)\r\ntx_srom_max_rate[rate1] =\r\ntx_srom_max_rate[rate2];\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nwlc_phy_txpwr_nphy_po_apply(tx_srom_max_rate,\r\ntmp_bw40po,\r\nTXP_FIRST_OFDM_40_SISO,\r\nTXP_LAST_MCS_40_SDM);\r\ntx_srom_max_rate[TXP_MCS_32] =\r\ntx_srom_max_rate[TXP_FIRST_MCS_40_CDD];\r\n}\r\nreturn;\r\n}\r\nvoid wlc_phy_txpower_recalc_target_nphy(struct brcms_phy *pi)\r\n{\r\nu8 tx_pwr_ctrl_state;\r\nwlc_phy_txpwr_limit_to_tbl_nphy(pi);\r\nwlc_phy_txpwrctrl_pwr_setup_nphy(pi);\r\ntx_pwr_ctrl_state = pi->nphy_txpwrctrl;\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12)) {\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, MCTL_PHYLOCK);\r\n(void)bcma_read32(pi->d11core, D11REGOFFS(maccontrol));\r\nudelay(1);\r\n}\r\nwlc_phy_txpwrctrl_enable_nphy(pi, tx_pwr_ctrl_state);\r\nif (D11REV_IS(pi->sh->corerev, 11) || D11REV_IS(pi->sh->corerev, 12))\r\nwlapi_bmac_mctrl(pi->sh->physhim, MCTL_PHYLOCK, 0);\r\n}\r\nstatic bool wlc_phy_txpwr_ison_nphy(struct brcms_phy *pi)\r\n{\r\nreturn read_phy_reg((pi), 0x1e7) & ((0x1 << 15) |\r\n(0x1 << 14) | (0x1 << 13));\r\n}\r\nu16 wlc_phy_txpwr_idx_get_nphy(struct brcms_phy *pi)\r\n{\r\nu16 tmp;\r\nu16 pwr_idx[2];\r\nif (wlc_phy_txpwr_ison_nphy(pi)) {\r\npwr_idx[0] = wlc_phy_txpwr_idx_cur_get_nphy(pi, PHY_CORE_0);\r\npwr_idx[1] = wlc_phy_txpwr_idx_cur_get_nphy(pi, PHY_CORE_1);\r\ntmp = (pwr_idx[0] << 8) | pwr_idx[1];\r\n} else {\r\ntmp = ((pi->nphy_txpwrindex[PHY_CORE_0].index_internal & 0xff)\r\n<< 8) |\r\n(pi->nphy_txpwrindex[PHY_CORE_1].index_internal & 0xff);\r\n}\r\nreturn tmp;\r\n}\r\nvoid wlc_phy_txpwr_papd_cal_nphy(struct brcms_phy *pi)\r\n{\r\nif (PHY_IPA(pi)\r\n&& (pi->nphy_force_papd_cal\r\n|| (wlc_phy_txpwr_ison_nphy(pi)\r\n&&\r\n(((u32)\r\nabs(wlc_phy_txpwr_idx_cur_get_nphy(pi, 0) -\r\npi->nphy_papd_tx_gain_at_last_cal[0]) >= 4)\r\n|| ((u32)\r\nabs(wlc_phy_txpwr_idx_cur_get_nphy(pi, 1) -\r\npi->nphy_papd_tx_gain_at_last_cal[1]) >= 4)))))\r\nwlc_phy_a4(pi, true);\r\n}\r\nvoid wlc_phy_txpwrctrl_enable_nphy(struct brcms_phy *pi, u8 ctrl_type)\r\n{\r\nu16 mask = 0, val = 0, ishw = 0;\r\nu8 ctr;\r\nuint core;\r\nu32 tbl_offset;\r\nu32 tbl_len;\r\nu16 regval[84];\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\nswitch (ctrl_type) {\r\ncase PHY_TPC_HW_OFF:\r\ncase PHY_TPC_HW_ON:\r\npi->nphy_txpwrctrl = ctrl_type;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (ctrl_type == PHY_TPC_HW_OFF) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif (wlc_phy_txpwr_ison_nphy(pi)) {\r\nfor (core = 0; core < pi->pubpi.phy_corenum;\r\ncore++)\r\npi->nphy_txpwr_idx[core] =\r\nwlc_phy_txpwr_idx_cur_get_nphy(\r\npi,\r\n(u8) core);\r\n}\r\n}\r\ntbl_len = 84;\r\ntbl_offset = 64;\r\nfor (ctr = 0; ctr < tbl_len; ctr++)\r\nregval[ctr] = 0;\r\nwlc_phy_table_write_nphy(pi, 26, tbl_len, tbl_offset, 16,\r\nregval);\r\nwlc_phy_table_write_nphy(pi, 27, tbl_len, tbl_offset, 16,\r\nregval);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nand_phy_reg(pi, 0x1e7,\r\n(u16) (~((0x1 << 15) |\r\n(0x1 << 14) | (0x1 << 13))));\r\nelse\r\nand_phy_reg(pi, 0x1e7,\r\n(u16) (~((0x1 << 14) | (0x1 << 13))));\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nor_phy_reg(pi, 0x8f, (0x1 << 8));\r\nor_phy_reg(pi, 0xa5, (0x1 << 8));\r\n} else {\r\nor_phy_reg(pi, 0xa5, (0x1 << 14));\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x53);\r\nelse if (NREV_LT(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x5a);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2) &&\r\npi->bw == WL_CHANSPEC_BW_40)\r\nwlapi_bmac_mhf(pi->sh->physhim, MHF1, MHF1_IQSWAP_WAR,\r\nMHF1_IQSWAP_WAR, BRCM_BAND_ALL);\r\n} else {\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE1TXPWRCTL, 84, 64,\r\n8, pi->adj_pwr_tbl_nphy);\r\nwlc_phy_table_write_nphy(pi, NPHY_TBL_ID_CORE2TXPWRCTL, 84, 64,\r\n8, pi->adj_pwr_tbl_nphy);\r\nishw = (ctrl_type == PHY_TPC_HW_ON) ? 0x1 : 0x0;\r\nmask = (0x1 << 14) | (0x1 << 13);\r\nval = (ishw << 14) | (ishw << 13);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nmask |= (0x1 << 15);\r\nval |= (ishw << 15);\r\n}\r\nmod_phy_reg(pi, 0x1e7, mask, val);\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 7)) {\r\nmod_phy_reg(pi, 0x1e7, (0x7f << 0), 0x32);\r\nmod_phy_reg(pi, 0x222, (0xff << 0), 0x32);\r\n} else {\r\nmod_phy_reg(pi, 0x1e7, (0x7f << 0), 0x64);\r\nif (NREV_GT(pi->pubpi.phy_rev, 1))\r\nmod_phy_reg(pi, 0x222,\r\n(0xff << 0), 0x64);\r\n}\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nif ((pi->nphy_txpwr_idx[0] != 128)\r\n&& (pi->nphy_txpwr_idx[1] != 128))\r\nwlc_phy_txpwr_idx_cur_set_nphy(pi,\r\npi->\r\nnphy_txpwr_idx\r\n[0],\r\npi->\r\nnphy_txpwr_idx\r\n[1]);\r\n}\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nand_phy_reg(pi, 0x8f, ~(0x1 << 8));\r\nand_phy_reg(pi, 0xa5, ~(0x1 << 8));\r\n} else {\r\nand_phy_reg(pi, 0xa5, ~(0x1 << 14));\r\n}\r\nif (NREV_IS(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x3b);\r\nelse if (NREV_LT(pi->pubpi.phy_rev, 2))\r\nmod_phy_reg(pi, 0xdc, 0x00ff, 0x40);\r\nif (NREV_LT(pi->pubpi.phy_rev, 2) &&\r\npi->bw == WL_CHANSPEC_BW_40)\r\nwlapi_bmac_mhf(pi->sh->physhim, MHF1, MHF1_IQSWAP_WAR,\r\n0x0, BRCM_BAND_ALL);\r\nif (PHY_IPA(pi)) {\r\nmod_phy_reg(pi, (0 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 2), (0) << 2);\r\nmod_phy_reg(pi, (1 == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 2), (0) << 2);\r\n}\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nvoid\r\nwlc_phy_txpwr_index_nphy(struct brcms_phy *pi, u8 core_mask, s8 txpwrindex,\r\nbool restore_cals)\r\n{\r\nu8 core, txpwrctl_tbl;\r\nu16 tx_ind0, iq_ind0, lo_ind0;\r\nu16 m1m2;\r\nu32 txgain;\r\nu16 rad_gain, dac_gain;\r\nu8 bbmult;\r\nu32 iqcomp;\r\nu16 iqcomp_a, iqcomp_b;\r\nu32 locomp;\r\nu16 tmpval;\r\nu8 tx_pwr_ctrl_state;\r\ns32 rfpwr_offset;\r\nu16 regval[2];\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\ntx_ind0 = 192;\r\niq_ind0 = 320;\r\nlo_ind0 = 448;\r\nfor (core = 0; core < pi->pubpi.phy_corenum; core++) {\r\nif ((core_mask & (1 << core)) == 0)\r\ncontinue;\r\ntxpwrctl_tbl = (core == PHY_CORE_0) ? 26 : 27;\r\nif (txpwrindex < 0) {\r\nif (pi->nphy_txpwrindex[core].index < 0)\r\ncontinue;\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nmod_phy_reg(pi, 0x8f,\r\n(0x1 << 8),\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride);\r\nmod_phy_reg(pi, 0xa5, (0x1 << 8),\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride);\r\n} else {\r\nmod_phy_reg(pi, 0xa5,\r\n(0x1 << 14),\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride);\r\n}\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xaa : 0xab,\r\npi->nphy_txpwrindex[core].AfeCtrlDacGain);\r\nwlc_phy_table_write_nphy(pi, 7, 1, (0x110 + core), 16,\r\n&pi->nphy_txpwrindex[core].\r\nrad_gain);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nm1m2 &= ((core == PHY_CORE_0) ? 0x00ff : 0xff00);\r\nm1m2 |= ((core == PHY_CORE_0) ?\r\n(pi->nphy_txpwrindex[core].bbmult << 8) :\r\n(pi->nphy_txpwrindex[core].bbmult << 0));\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nif (restore_cals) {\r\nwlc_phy_table_write_nphy(\r\npi, 15, 2, (80 + 2 * core), 16,\r\n&pi->nphy_txpwrindex[core].iqcomp_a);\r\nwlc_phy_table_write_nphy(\r\npi, 15, 1, (85 + core), 16,\r\n&pi->nphy_txpwrindex[core].locomp);\r\nwlc_phy_table_write_nphy(\r\npi, 15, 1, (93 + core), 16,\r\n&pi->nphy_txpwrindex[core].locomp);\r\n}\r\nwlc_phy_txpwrctrl_enable_nphy(pi, pi->nphy_txpwrctrl);\r\npi->nphy_txpwrindex[core].index_internal =\r\npi->nphy_txpwrindex[core].index_internal_save;\r\n} else {\r\nif (pi->nphy_txpwrindex[core].index < 0) {\r\nif (NREV_GE(pi->pubpi.phy_rev, 3)) {\r\nmod_phy_reg(pi, 0x8f,\r\n(0x1 << 8),\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride);\r\nmod_phy_reg(pi, 0xa5, (0x1 << 8),\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride);\r\n} else {\r\npi->nphy_txpwrindex[core].\r\nAfectrlOverride =\r\nread_phy_reg(pi, 0xa5);\r\n}\r\npi->nphy_txpwrindex[core].AfeCtrlDacGain =\r\nread_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xaa : 0xab);\r\nwlc_phy_table_read_nphy(pi, 7, 1,\r\n(0x110 + core), 16,\r\n&pi->\r\nnphy_txpwrindex[core].\r\nrad_gain);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16,\r\n&tmpval);\r\ntmpval >>= ((core == PHY_CORE_0) ? 8 : 0);\r\ntmpval &= 0xff;\r\npi->nphy_txpwrindex[core].bbmult = (u8) tmpval;\r\nwlc_phy_table_read_nphy(pi, 15, 2,\r\n(80 + 2 * core), 16,\r\n&pi->\r\nnphy_txpwrindex[core].\r\niqcomp_a);\r\nwlc_phy_table_read_nphy(pi, 15, 1, (85 + core),\r\n16,\r\n&pi->\r\nnphy_txpwrindex[core].\r\nlocomp);\r\npi->nphy_txpwrindex[core].index_internal_save =\r\npi->nphy_txpwrindex[core].\r\nindex_internal;\r\n}\r\ntx_pwr_ctrl_state = pi->nphy_txpwrctrl;\r\nwlc_phy_txpwrctrl_enable_nphy(pi, PHY_TPC_HW_OFF);\r\nif (NREV_IS(pi->pubpi.phy_rev, 1))\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, ON);\r\nwlc_phy_table_read_nphy(pi, txpwrctl_tbl, 1,\r\n(tx_ind0 + txpwrindex), 32,\r\n&txgain);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nrad_gain = (txgain >> 16) &\r\n((1 << (32 - 16 + 1)) - 1);\r\nelse\r\nrad_gain = (txgain >> 16) &\r\n((1 << (28 - 16 + 1)) - 1);\r\ndac_gain = (txgain >> 8) & ((1 << (13 - 8 + 1)) - 1);\r\nbbmult = (txgain >> 0) & ((1 << (7 - 0 + 1)) - 1);\r\nif (NREV_GE(pi->pubpi.phy_rev, 3))\r\nmod_phy_reg(pi, ((core == PHY_CORE_0) ? 0x8f :\r\n0xa5), (0x1 << 8), (0x1 << 8));\r\nelse\r\nmod_phy_reg(pi, 0xa5, (0x1 << 14), (0x1 << 14));\r\nwrite_phy_reg(pi, (core == PHY_CORE_0) ?\r\n0xaa : 0xab, dac_gain);\r\nwlc_phy_table_write_nphy(pi, 7, 1, (0x110 + core), 16,\r\n&rad_gain);\r\nwlc_phy_table_read_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nm1m2 &= ((core == PHY_CORE_0) ? 0x00ff : 0xff00);\r\nm1m2 |= ((core == PHY_CORE_0) ?\r\n(bbmult << 8) : (bbmult << 0));\r\nwlc_phy_table_write_nphy(pi, 15, 1, 87, 16, &m1m2);\r\nwlc_phy_table_read_nphy(pi, txpwrctl_tbl, 1,\r\n(iq_ind0 + txpwrindex), 32,\r\n&iqcomp);\r\niqcomp_a = (iqcomp >> 10) & ((1 << (19 - 10 + 1)) - 1);\r\niqcomp_b = (iqcomp >> 0) & ((1 << (9 - 0 + 1)) - 1);\r\nif (restore_cals) {\r\nregval[0] = (u16) iqcomp_a;\r\nregval[1] = (u16) iqcomp_b;\r\nwlc_phy_table_write_nphy(pi, 15, 2,\r\n(80 + 2 * core), 16,\r\nregval);\r\n}\r\nwlc_phy_table_read_nphy(pi, txpwrctl_tbl, 1,\r\n(lo_ind0 + txpwrindex), 32,\r\n&locomp);\r\nif (restore_cals)\r\nwlc_phy_table_write_nphy(pi, 15, 1, (85 + core),\r\n16, &locomp);\r\nif (NREV_IS(pi->pubpi.phy_rev, 1))\r\nwlapi_bmac_phyclk_fgc(pi->sh->physhim, OFF);\r\nif (PHY_IPA(pi)) {\r\nwlc_phy_table_read_nphy(pi,\r\n(core == PHY_CORE_0 ?\r\nNPHY_TBL_ID_CORE1TXPWRCTL :\r\nNPHY_TBL_ID_CORE2TXPWRCTL),\r\n1, 576 + txpwrindex, 32,\r\n&rfpwr_offset);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1ff << 4),\r\n((s16) rfpwr_offset) << 4);\r\nmod_phy_reg(pi, (core == PHY_CORE_0) ? 0x297 :\r\n0x29b, (0x1 << 2), (1) << 2);\r\n}\r\nwlc_phy_txpwrctrl_enable_nphy(pi, tx_pwr_ctrl_state);\r\n}\r\npi->nphy_txpwrindex[core].index = txpwrindex;\r\n}\r\nif (pi->phyhang_avoid)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nvoid\r\nwlc_phy_txpower_sromlimit_get_nphy(struct brcms_phy *pi, uint chan, u8 *max_pwr,\r\nu8 txp_rate_idx)\r\n{\r\nu8 chan_freq_range;\r\nchan_freq_range = wlc_phy_get_chan_freq_range_nphy(pi, chan);\r\nswitch (chan_freq_range) {\r\ncase WL_CHAN_FREQ_RANGE_2G:\r\n*max_pwr = pi->tx_srom_max_rate_2g[txp_rate_idx];\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GM:\r\n*max_pwr = pi->tx_srom_max_rate_5g_mid[txp_rate_idx];\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GL:\r\n*max_pwr = pi->tx_srom_max_rate_5g_low[txp_rate_idx];\r\nbreak;\r\ncase WL_CHAN_FREQ_RANGE_5GH:\r\n*max_pwr = pi->tx_srom_max_rate_5g_hi[txp_rate_idx];\r\nbreak;\r\ndefault:\r\n*max_pwr = pi->tx_srom_max_rate_2g[txp_rate_idx];\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nvoid wlc_phy_stay_in_carriersearch_nphy(struct brcms_phy *pi, bool enable)\r\n{\r\nu16 clip_off[] = { 0xffff, 0xffff };\r\nif (enable) {\r\nif (pi->nphy_deaf_count == 0) {\r\npi->classifier_state =\r\nwlc_phy_classifier_nphy(pi, 0, 0);\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0), 4);\r\nwlc_phy_clip_det_nphy(pi, 0, pi->clip_state);\r\nwlc_phy_clip_det_nphy(pi, 1, clip_off);\r\n}\r\npi->nphy_deaf_count++;\r\nwlc_phy_resetcca_nphy(pi);\r\n} else {\r\npi->nphy_deaf_count--;\r\nif (pi->nphy_deaf_count == 0) {\r\nwlc_phy_classifier_nphy(pi, (0x7 << 0),\r\npi->classifier_state);\r\nwlc_phy_clip_det_nphy(pi, 1, pi->clip_state);\r\n}\r\n}\r\n}\r\nvoid wlc_nphy_deaf_mode(struct brcms_phy *pi, bool mode)\r\n{\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nif (mode) {\r\nif (pi->nphy_deaf_count == 0)\r\nwlc_phy_stay_in_carriersearch_nphy(pi, true);\r\n} else if (pi->nphy_deaf_count > 0) {\r\nwlc_phy_stay_in_carriersearch_nphy(pi, false);\r\n}\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}

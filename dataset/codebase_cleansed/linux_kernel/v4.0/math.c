static void display_emulation_not_implemented(struct pt_regs *regs, char *instr)\r\n{\r\n__u16 *location;\r\n#ifdef CONFIG_SYSCTL\r\nif(sysctl_ieee_emulation_warnings)\r\n#endif\r\n{\r\nlocation = (__u16 *)(regs->psw.addr-S390_lowcore.pgm_ilc);\r\nprintk("%s ieee fpu instruction not emulated "\r\n"process name: %s pid: %d \n",\r\ninstr, current->comm, current->pid);\r\nprintk("%s's PSW: %08lx %08lx\n", instr,\r\n(unsigned long) regs->psw.mask,\r\n(unsigned long) location);\r\n}\r\n}\r\nstatic inline void emu_set_CC (struct pt_regs *regs, int cc)\r\n{\r\nregs->psw.mask = (regs->psw.mask & 0xFFFFCFFF) | ((cc&3) << 12);\r\n}\r\nstatic inline void emu_set_CC_cs(struct pt_regs *regs, int class, int sign)\r\n{\r\nswitch (class) {\r\ncase FP_CLS_NORMAL:\r\ncase FP_CLS_INF:\r\nemu_set_CC(regs, sign ? 1 : 2);\r\nbreak;\r\ncase FP_CLS_ZERO:\r\nemu_set_CC(regs, 0);\r\nbreak;\r\ncase FP_CLS_NAN:\r\nemu_set_CC(regs, 3);\r\nbreak;\r\n}\r\n}\r\nstatic int emu_axbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QB, &cvt.ld);\r\nFP_ADD_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_adbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_ADD_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_adb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_ADD_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_aebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_ADD_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_aeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_ADD_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_cxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB);\r\nmathemu_ldcv cvt;\r\nint IR;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_RAW_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_RAW_QP(QB, &cvt.ld);\r\nFP_CMP_Q(IR, QA, QB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nreturn 0;\r\n}\r\nstatic int emu_cdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB);\r\nint IR;\r\nFP_UNPACK_RAW_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_RAW_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_CMP_D(IR, DA, DB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nreturn 0;\r\n}\r\nstatic int emu_cdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB);\r\nint IR;\r\nFP_UNPACK_RAW_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_RAW_DP(DB, val);\r\nFP_CMP_D(IR, DA, DB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nreturn 0;\r\n}\r\nstatic int emu_cebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB);\r\nint IR;\r\nFP_UNPACK_RAW_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_RAW_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_CMP_S(IR, SA, SB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nreturn 0;\r\n}\r\nstatic int emu_ceb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB);\r\nint IR;\r\nFP_UNPACK_RAW_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_RAW_SP(SB, val);\r\nFP_CMP_S(IR, SA, SB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nreturn 0;\r\n}\r\nstatic int emu_kxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint IR;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_RAW_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QB, &cvt.ld);\r\nFP_CMP_Q(IR, QA, QB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nif (IR == 3)\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nreturn _fex;\r\n}\r\nstatic int emu_kdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB);\r\nFP_DECL_EX;\r\nint IR;\r\nFP_UNPACK_RAW_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_RAW_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_CMP_D(IR, DA, DB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nif (IR == 3)\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nreturn _fex;\r\n}\r\nstatic int emu_kdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB);\r\nFP_DECL_EX;\r\nint IR;\r\nFP_UNPACK_RAW_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_RAW_DP(DB, val);\r\nFP_CMP_D(IR, DA, DB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nif (IR == 3)\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nreturn _fex;\r\n}\r\nstatic int emu_kebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB);\r\nFP_DECL_EX;\r\nint IR;\r\nFP_UNPACK_RAW_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_RAW_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_CMP_S(IR, SA, SB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nif (IR == 3)\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nreturn _fex;\r\n}\r\nstatic int emu_keb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB);\r\nFP_DECL_EX;\r\nint IR;\r\nFP_UNPACK_RAW_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_RAW_SP(SB, val);\r\nFP_CMP_S(IR, SA, SB, 3);\r\nemu_set_CC(regs, (IR == -1) ? 1 : (IR == 1) ? 2 : IR);\r\nif (IR == 3)\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nreturn _fex;\r\n}\r\nstatic int emu_cxfbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\n__s32 si;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nsi = regs->gprs[ry];\r\nFP_FROM_INT_Q(QR, si, 32, int);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_cdfbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DR);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nsi = regs->gprs[ry];\r\nFP_FROM_INT_D(DR, si, 32, int);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_cefbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SR);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nsi = regs->gprs[ry];\r\nFP_FROM_INT_S(SR, si, 32, int);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_cfxbr (struct pt_regs *regs, int rx, int ry, int mask) {\r\nFP_DECL_Q(QA);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = current->thread.fp_regs.fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_TO_INT_ROUND_Q(si, QA, 32, 1);\r\nregs->gprs[rx] = si;\r\nemu_set_CC_cs(regs, QA_c, QA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_cfdbr (struct pt_regs *regs, int rx, int ry, int mask) {\r\nFP_DECL_D(DA);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = current->thread.fp_regs.fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_TO_INT_ROUND_D(si, DA, 32, 1);\r\nregs->gprs[rx] = si;\r\nemu_set_CC_cs(regs, DA_c, DA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_cfebr (struct pt_regs *regs, int rx, int ry, int mask) {\r\nFP_DECL_S(SA);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = current->thread.fp_regs.fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_TO_INT_ROUND_S(si, SA, 32, 1);\r\nregs->gprs[rx] = si;\r\nemu_set_CC_cs(regs, SA_c, SA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_dxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QB, &cvt.ld);\r\nFP_DIV_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_ddbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_DIV_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_ddb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_DIV_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_debr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_DIV_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_deb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_DIV_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_didbr (struct pt_regs *regs, int rx, int ry, int mask) {\r\ndisplay_emulation_not_implemented(regs, "didbr");\r\nreturn 0;\r\n}\r\nstatic int emu_diebr (struct pt_regs *regs, int rx, int ry, int mask) {\r\ndisplay_emulation_not_implemented(regs, "diebr");\r\nreturn 0;\r\n}\r\nstatic int emu_efpc (struct pt_regs *regs, int rx, int ry) {\r\nregs->gprs[rx] = current->thread.fp_regs.fpc;\r\nreturn 0;\r\n}\r\nstatic int emu_ltxbr (struct pt_regs *regs, int rx, int ry) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nmathemu_ldcv cvt;\r\nFP_DECL_Q(QA);\r\nFP_DECL_EX;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nfp_regs->fprs[rx].ui = fp_regs->fprs[ry].ui;\r\nfp_regs->fprs[rx+2].ui = fp_regs->fprs[ry+2].ui;\r\nemu_set_CC_cs(regs, QA_c, QA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_ltdbr (struct pt_regs *regs, int rx, int ry) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nFP_DECL_D(DA);\r\nFP_DECL_EX;\r\nFP_UNPACK_DP(DA, &fp_regs->fprs[ry].d);\r\nfp_regs->fprs[rx].ui = fp_regs->fprs[ry].ui;\r\nemu_set_CC_cs(regs, DA_c, DA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_ltebr (struct pt_regs *regs, int rx, int ry) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nFP_DECL_S(SA);\r\nFP_DECL_EX;\r\nFP_UNPACK_SP(SA, &fp_regs->fprs[ry].f);\r\nfp_regs->fprs[rx].ui = fp_regs->fprs[ry].ui;\r\nemu_set_CC_cs(regs, SA_c, SA_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lcxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_NEG_Q(QR, QA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lcdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_NEG_D(DR, DA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lcebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_NEG_S(SR, SA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_fixbr (struct pt_regs *regs, int rx, int ry, int mask) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nFP_DECL_Q(QA);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = fp_regs->fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\ncvt.w.high = fp_regs->fprs[ry].ui;\r\ncvt.w.low = fp_regs->fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_TO_FPINT_ROUND_Q(QA);\r\nFP_PACK_QP(&cvt.ld, QA);\r\nfp_regs->fprs[rx].ui = cvt.w.high;\r\nfp_regs->fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_fidbr (struct pt_regs *regs, int rx, int ry, int mask) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nFP_DECL_D(DA);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = fp_regs->fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\nFP_UNPACK_DP(DA, &fp_regs->fprs[ry].d);\r\nFP_TO_FPINT_ROUND_D(DA);\r\nFP_PACK_DP(&fp_regs->fprs[rx].d, DA);\r\nreturn _fex;\r\n}\r\nstatic int emu_fiebr (struct pt_regs *regs, int rx, int ry, int mask) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\nFP_DECL_S(SA);\r\nFP_DECL_EX;\r\n__s32 si;\r\nint mode;\r\nif (mask == 0)\r\nmode = fp_regs->fpc & 3;\r\nelse if (mask == 1)\r\nmode = FP_RND_NEAREST;\r\nelse\r\nmode = mask - 4;\r\nFP_UNPACK_SP(SA, &fp_regs->fprs[ry].f);\r\nFP_TO_FPINT_ROUND_S(SA);\r\nFP_PACK_SP(&fp_regs->fprs[rx].f, SA);\r\nreturn _fex;\r\n}\r\nstatic int emu_lxdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_CONV (Q, D, 4, 2, QR, DA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_lxdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, val);\r\nFP_CONV (Q, D, 4, 2, QR, DA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_lxebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_CONV (Q, S, 4, 1, QR, SA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_lxeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, val);\r\nFP_CONV (Q, S, 4, 1, QR, SA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_ldebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_CONV (D, S, 2, 1, DR, SA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_ldeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, val);\r\nFP_CONV (D, S, 2, 1, DR, SA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_lnxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nif (QA_s == 0) {\r\nFP_NEG_Q(QR, QA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\n} else {\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui =\r\ncurrent->thread.fp_regs.fprs[ry+2].ui;\r\n}\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lndbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nif (DA_s == 0) {\r\nFP_NEG_D(DR, DA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\n} else\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lnebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nif (SA_s == 0) {\r\nFP_NEG_S(SR, SA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\n} else\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lpxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nif (QA_s != 0) {\r\nFP_NEG_Q(QR, QA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\n} else{\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui =\r\ncurrent->thread.fp_regs.fprs[ry+2].ui;\r\n}\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lpdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nif (DA_s != 0) {\r\nFP_NEG_D(DR, DA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\n} else\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_lpebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nif (SA_s != 0) {\r\nFP_NEG_S(SR, SA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\n} else\r\ncurrent->thread.fp_regs.fprs[rx].ui =\r\ncurrent->thread.fp_regs.fprs[ry].ui;\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_ldxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_CONV (D, Q, 2, 4, DR, QA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].f, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_lexbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_CONV (S, Q, 1, 4, SR, QA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_ledbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_CONV (S, D, 1, 2, SR, DA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QB, &cvt.ld);\r\nFP_MUL_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_mdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mxdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_CONV (Q, D, 4, 2, QA, DA);\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_CONV (Q, D, 4, 2, QB, DA);\r\nFP_MUL_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_mxdb (struct pt_regs *regs, int rx, long double *val) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_UNPACK_QP(QB, val);\r\nFP_MUL_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nreturn _fex;\r\n}\r\nstatic int emu_meebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_meeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mdebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_CONV (D, S, 2, 1, DA, SA);\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_CONV (D, S, 2, 1, DB, SA);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mdeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_CONV (D, S, 2, 1, DA, SA);\r\nFP_UNPACK_SP(SA, val);\r\nFP_CONV (D, S, 2, 1, DB, SA);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_madbr (struct pt_regs *regs, int rx, int ry, int rz) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DC); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_UNPACK_DP(DC, &current->thread.fp_regs.fprs[rz].d);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_ADD_D(DR, DR, DC);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rz].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_madb (struct pt_regs *regs, int rx, double *val, int rz) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DC); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_UNPACK_DP(DC, &current->thread.fp_regs.fprs[rz].d);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_ADD_D(DR, DR, DC);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rz].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_maebr (struct pt_regs *regs, int rx, int ry, int rz) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SC); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_UNPACK_SP(SC, &current->thread.fp_regs.fprs[rz].f);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_ADD_S(SR, SR, SC);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rz].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_maeb (struct pt_regs *regs, int rx, float *val, int rz) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SC); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_UNPACK_SP(SC, &current->thread.fp_regs.fprs[rz].f);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_ADD_S(SR, SR, SC);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rz].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_msdbr (struct pt_regs *regs, int rx, int ry, int rz) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DC); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_UNPACK_DP(DC, &current->thread.fp_regs.fprs[rz].d);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_SUB_D(DR, DR, DC);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rz].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_msdb (struct pt_regs *regs, int rx, double *val, int rz) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DC); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_UNPACK_DP(DC, &current->thread.fp_regs.fprs[rz].d);\r\nFP_MUL_D(DR, DA, DB);\r\nFP_SUB_D(DR, DR, DC);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rz].d, DR);\r\nreturn _fex;\r\n}\r\nstatic int emu_msebr (struct pt_regs *regs, int rx, int ry, int rz) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SC); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_UNPACK_SP(SC, &current->thread.fp_regs.fprs[rz].f);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_SUB_S(SR, SR, SC);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rz].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_mseb (struct pt_regs *regs, int rx, float *val, int rz) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SC); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_UNPACK_SP(SC, &current->thread.fp_regs.fprs[rz].f);\r\nFP_MUL_S(SR, SA, SB);\r\nFP_SUB_S(SR, SR, SC);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rz].f, SR);\r\nreturn _fex;\r\n}\r\nstatic int emu_sfpc (struct pt_regs *regs, int rx, int ry) {\r\n__u32 temp;\r\ntemp = regs->gprs[rx];\r\nif ((temp & ~FPC_VALID_MASK) != 0)\r\nreturn SIGILL;\r\ncurrent->thread.fp_regs.fpc = temp;\r\nreturn 0;\r\n}\r\nstatic int emu_sqxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\nFP_SQRT_Q(QR, QA);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sqdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[ry].d);\r\nFP_SQRT_D(DR, DA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sqdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, val);\r\nFP_SQRT_D(DR, DA);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sqebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[ry].f);\r\nFP_SQRT_S(SR, SA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sqeb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, val);\r\nFP_SQRT_S(SR, SA);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sxbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nFP_DECL_EX;\r\nmathemu_ldcv cvt;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_QP(QA, &cvt.ld);\r\ncvt.w.high = current->thread.fp_regs.fprs[ry].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[ry+2].ui;\r\nFP_UNPACK_QP(QB, &cvt.ld);\r\nFP_SUB_Q(QR, QA, QB);\r\nFP_PACK_QP(&cvt.ld, QR);\r\ncurrent->thread.fp_regs.fprs[rx].ui = cvt.w.high;\r\ncurrent->thread.fp_regs.fprs[rx+2].ui = cvt.w.low;\r\nemu_set_CC_cs(regs, QR_c, QR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sdbr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, &current->thread.fp_regs.fprs[ry].d);\r\nFP_SUB_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sdb (struct pt_regs *regs, int rx, double *val) {\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nFP_UNPACK_DP(DB, val);\r\nFP_SUB_D(DR, DA, DB);\r\nFP_PACK_DP(&current->thread.fp_regs.fprs[rx].d, DR);\r\nemu_set_CC_cs(regs, DR_c, DR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_sebr (struct pt_regs *regs, int rx, int ry) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, &current->thread.fp_regs.fprs[ry].f);\r\nFP_SUB_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_seb (struct pt_regs *regs, int rx, float *val) {\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_EX;\r\nint mode;\r\nmode = current->thread.fp_regs.fpc & 3;\r\nFP_UNPACK_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nFP_UNPACK_SP(SB, val);\r\nFP_SUB_S(SR, SA, SB);\r\nFP_PACK_SP(&current->thread.fp_regs.fprs[rx].f, SR);\r\nemu_set_CC_cs(regs, SR_c, SR_s);\r\nreturn _fex;\r\n}\r\nstatic int emu_tcxb (struct pt_regs *regs, int rx, long val) {\r\nFP_DECL_Q(QA);\r\nmathemu_ldcv cvt;\r\nint bit;\r\ncvt.w.high = current->thread.fp_regs.fprs[rx].ui;\r\ncvt.w.low = current->thread.fp_regs.fprs[rx+2].ui;\r\nFP_UNPACK_RAW_QP(QA, &cvt.ld);\r\nswitch (QA_e) {\r\ndefault:\r\nbit = 8;\r\nbreak;\r\ncase 0:\r\nif (_FP_FRAC_ZEROP_4(QA))\r\nbit = 10;\r\nelse\r\nbit = 6;\r\nbreak;\r\ncase _FP_EXPMAX_Q:\r\nif (_FP_FRAC_ZEROP_4(QA))\r\nbit = 4;\r\nelse if (_FP_FRAC_HIGH_RAW_Q(QA) & _FP_QNANBIT_Q)\r\nbit = 2;\r\nelse\r\nbit = 0;\r\nbreak;\r\n}\r\nif (!QA_s)\r\nbit++;\r\nemu_set_CC(regs, ((__u32) val >> bit) & 1);\r\nreturn 0;\r\n}\r\nstatic int emu_tcdb (struct pt_regs *regs, int rx, long val) {\r\nFP_DECL_D(DA);\r\nint bit;\r\nFP_UNPACK_RAW_DP(DA, &current->thread.fp_regs.fprs[rx].d);\r\nswitch (DA_e) {\r\ndefault:\r\nbit = 8;\r\nbreak;\r\ncase 0:\r\nif (_FP_FRAC_ZEROP_2(DA))\r\nbit = 10;\r\nelse\r\nbit = 6;\r\nbreak;\r\ncase _FP_EXPMAX_D:\r\nif (_FP_FRAC_ZEROP_2(DA))\r\nbit = 4;\r\nelse if (_FP_FRAC_HIGH_RAW_D(DA) & _FP_QNANBIT_D)\r\nbit = 2;\r\nelse\r\nbit = 0;\r\nbreak;\r\n}\r\nif (!DA_s)\r\nbit++;\r\nemu_set_CC(regs, ((__u32) val >> bit) & 1);\r\nreturn 0;\r\n}\r\nstatic int emu_tceb (struct pt_regs *regs, int rx, long val) {\r\nFP_DECL_S(SA);\r\nint bit;\r\nFP_UNPACK_RAW_SP(SA, &current->thread.fp_regs.fprs[rx].f);\r\nswitch (SA_e) {\r\ndefault:\r\nbit = 8;\r\nbreak;\r\ncase 0:\r\nif (_FP_FRAC_ZEROP_1(SA))\r\nbit = 10;\r\nelse\r\nbit = 6;\r\nbreak;\r\ncase _FP_EXPMAX_S:\r\nif (_FP_FRAC_ZEROP_1(SA))\r\nbit = 4;\r\nelse if (_FP_FRAC_HIGH_RAW_S(SA) & _FP_QNANBIT_S)\r\nbit = 2;\r\nelse\r\nbit = 0;\r\nbreak;\r\n}\r\nif (!SA_s)\r\nbit++;\r\nemu_set_CC(regs, ((__u32) val >> bit) & 1);\r\nreturn 0;\r\n}\r\nstatic inline void emu_load_regd(int reg) {\r\nif ((reg&9) != 0)\r\nreturn;\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" ld 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (reg<<4),"a" (&current->thread.fp_regs.fprs[reg].d)\r\n: "1");\r\n}\r\nstatic inline void emu_load_rege(int reg) {\r\nif ((reg&9) != 0)\r\nreturn;\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" le 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (reg<<4), "a" (&current->thread.fp_regs.fprs[reg].f)\r\n: "1");\r\n}\r\nstatic inline void emu_store_regd(int reg) {\r\nif ((reg&9) != 0)\r\nreturn;\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" std 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (reg<<4), "a" (&current->thread.fp_regs.fprs[reg].d)\r\n: "1");\r\n}\r\nstatic inline void emu_store_rege(int reg) {\r\nif ((reg&9) != 0)\r\nreturn;\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" ste 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (reg<<4), "a" (&current->thread.fp_regs.fprs[reg].f)\r\n: "1");\r\n}\r\nint math_emu_b3(__u8 *opcode, struct pt_regs * regs) {\r\nint _fex = 0;\r\nstatic const __u8 format_table[256] = {\r\n[0x00] = 0x03,[0x01] = 0x03,[0x02] = 0x03,[0x03] = 0x03,\r\n[0x04] = 0x0f,[0x05] = 0x0d,[0x06] = 0x0e,[0x07] = 0x0d,\r\n[0x08] = 0x03,[0x09] = 0x03,[0x0a] = 0x03,[0x0b] = 0x03,\r\n[0x0c] = 0x0f,[0x0d] = 0x03,[0x0e] = 0x06,[0x0f] = 0x06,\r\n[0x10] = 0x02,[0x11] = 0x02,[0x12] = 0x02,[0x13] = 0x02,\r\n[0x14] = 0x03,[0x15] = 0x02,[0x16] = 0x01,[0x17] = 0x03,\r\n[0x18] = 0x02,[0x19] = 0x02,[0x1a] = 0x02,[0x1b] = 0x02,\r\n[0x1c] = 0x02,[0x1d] = 0x02,[0x1e] = 0x05,[0x1f] = 0x05,\r\n[0x40] = 0x01,[0x41] = 0x01,[0x42] = 0x01,[0x43] = 0x01,\r\n[0x44] = 0x12,[0x45] = 0x0d,[0x46] = 0x11,[0x47] = 0x04,\r\n[0x48] = 0x01,[0x49] = 0x01,[0x4a] = 0x01,[0x4b] = 0x01,\r\n[0x4c] = 0x01,[0x4d] = 0x01,[0x53] = 0x06,[0x57] = 0x06,\r\n[0x5b] = 0x05,[0x5f] = 0x05,[0x84] = 0x13,[0x8c] = 0x13,\r\n[0x94] = 0x09,[0x95] = 0x08,[0x96] = 0x07,[0x98] = 0x0c,\r\n[0x99] = 0x0b,[0x9a] = 0x0a\r\n};\r\nstatic const void *jump_table[256]= {\r\n[0x00] = emu_lpebr,[0x01] = emu_lnebr,[0x02] = emu_ltebr,\r\n[0x03] = emu_lcebr,[0x04] = emu_ldebr,[0x05] = emu_lxdbr,\r\n[0x06] = emu_lxebr,[0x07] = emu_mxdbr,[0x08] = emu_kebr,\r\n[0x09] = emu_cebr, [0x0a] = emu_aebr, [0x0b] = emu_sebr,\r\n[0x0c] = emu_mdebr,[0x0d] = emu_debr, [0x0e] = emu_maebr,\r\n[0x0f] = emu_msebr,[0x10] = emu_lpdbr,[0x11] = emu_lndbr,\r\n[0x12] = emu_ltdbr,[0x13] = emu_lcdbr,[0x14] = emu_sqebr,\r\n[0x15] = emu_sqdbr,[0x16] = emu_sqxbr,[0x17] = emu_meebr,\r\n[0x18] = emu_kdbr, [0x19] = emu_cdbr, [0x1a] = emu_adbr,\r\n[0x1b] = emu_sdbr, [0x1c] = emu_mdbr, [0x1d] = emu_ddbr,\r\n[0x1e] = emu_madbr,[0x1f] = emu_msdbr,[0x40] = emu_lpxbr,\r\n[0x41] = emu_lnxbr,[0x42] = emu_ltxbr,[0x43] = emu_lcxbr,\r\n[0x44] = emu_ledbr,[0x45] = emu_ldxbr,[0x46] = emu_lexbr,\r\n[0x47] = emu_fixbr,[0x48] = emu_kxbr, [0x49] = emu_cxbr,\r\n[0x4a] = emu_axbr, [0x4b] = emu_sxbr, [0x4c] = emu_mxbr,\r\n[0x4d] = emu_dxbr, [0x53] = emu_diebr,[0x57] = emu_fiebr,\r\n[0x5b] = emu_didbr,[0x5f] = emu_fidbr,[0x84] = emu_sfpc,\r\n[0x8c] = emu_efpc, [0x94] = emu_cefbr,[0x95] = emu_cdfbr,\r\n[0x96] = emu_cxfbr,[0x98] = emu_cfebr,[0x99] = emu_cfdbr,\r\n[0x9a] = emu_cfxbr\r\n};\r\nswitch (format_table[opcode[1]]) {\r\ncase 1:\r\nif (opcode[3] & 0x22)\r\nreturn SIGILL;\r\nemu_store_regd((opcode[3] >> 4) & 15);\r\nemu_store_regd(((opcode[3] >> 4) & 15) + 2);\r\nemu_store_regd(opcode[3] & 15);\r\nemu_store_regd((opcode[3] & 15) + 2);\r\n_fex = ((int (*)(struct pt_regs *,int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(((opcode[3] >> 4) & 15) + 2);\r\nemu_load_regd(opcode[3] & 15);\r\nemu_load_regd((opcode[3] & 15) + 2);\r\nbreak;\r\ncase 2:\r\nemu_store_regd((opcode[3] >> 4) & 15);\r\nemu_store_regd(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(opcode[3] & 15);\r\nbreak;\r\ncase 3:\r\nemu_store_rege((opcode[3] >> 4) & 15);\r\nemu_store_rege(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_rege((opcode[3] >> 4) & 15);\r\nemu_load_rege(opcode[3] & 15);\r\nbreak;\r\ncase 4:\r\nif (opcode[3] & 0x22)\r\nreturn SIGILL;\r\nemu_store_regd((opcode[3] >> 4) & 15);\r\nemu_store_regd(((opcode[3] >> 4) & 15) + 2);\r\nemu_store_regd(opcode[3] & 15);\r\nemu_store_regd((opcode[3] & 15) + 2);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(((opcode[3] >> 4) & 15) + 2);\r\nemu_load_regd(opcode[3] & 15);\r\nemu_load_regd((opcode[3] & 15) + 2);\r\nbreak;\r\ncase 5:\r\nemu_store_regd((opcode[2] >> 4) & 15);\r\nemu_store_regd((opcode[3] >> 4) & 15);\r\nemu_store_regd(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nemu_load_regd((opcode[2] >> 4) & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(opcode[3] & 15);\r\nbreak;\r\ncase 6:\r\nemu_store_rege((opcode[2] >> 4) & 15);\r\nemu_store_rege((opcode[3] >> 4) & 15);\r\nemu_store_rege(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nemu_load_rege((opcode[2] >> 4) & 15);\r\nemu_load_rege((opcode[3] >> 4) & 15);\r\nemu_load_rege(opcode[3] & 15);\r\nbreak;\r\ncase 7:\r\nif (opcode[3] & 0x20)\r\nreturn SIGILL;\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(((opcode[3] >> 4) & 15) + 2);\r\nbreak;\r\ncase 8:\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 9:\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_rege((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 10:\r\nif ((opcode[2] & 128) == 128 || (opcode[2] & 96) == 32)\r\nreturn SIGILL;\r\nif (opcode[3] & 2)\r\nreturn SIGILL;\r\nemu_store_regd(opcode[3] & 15);\r\nemu_store_regd((opcode[3] & 15) + 2);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nbreak;\r\ncase 11:\r\nif ((opcode[2] & 128) == 128 || (opcode[2] & 96) == 32)\r\nreturn SIGILL;\r\nemu_store_regd(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nbreak;\r\ncase 12:\r\nif ((opcode[2] & 128) == 128 || (opcode[2] & 96) == 32)\r\nreturn SIGILL;\r\nemu_store_rege(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15, opcode[2] >> 4);\r\nbreak;\r\ncase 13:\r\nif (opcode[3] & 0x20)\r\nreturn SIGILL;\r\nemu_store_regd((opcode[3] >> 4) & 15);\r\nemu_store_regd(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(((opcode[3] >> 4) & 15) + 2);\r\nbreak;\r\ncase 14:\r\nif (opcode[3] & 0x20)\r\nreturn SIGILL;\r\nemu_store_rege((opcode[3] >> 4) & 15);\r\nemu_store_rege(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nemu_load_regd(((opcode[3] >> 4) & 15) + 2);\r\nbreak;\r\ncase 15:\r\nemu_store_rege((opcode[3] >> 4) & 15);\r\nemu_store_rege(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 16:\r\nif (opcode[3] & 2)\r\nreturn SIGILL;\r\nemu_store_regd(opcode[3] & 15);\r\nemu_store_regd((opcode[3] & 15) + 2);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_regd((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 17:\r\nif (opcode[3] & 2)\r\nreturn SIGILL;\r\nemu_store_regd(opcode[3] & 15);\r\nemu_store_regd((opcode[3] & 15) + 2);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_rege((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 18:\r\nemu_store_regd(opcode[3] & 15);\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nemu_load_rege((opcode[3] >> 4) & 15);\r\nbreak;\r\ncase 19:\r\n_fex = ((int (*)(struct pt_regs *, int, int))\r\njump_table[opcode[1]])\r\n(regs, opcode[3] >> 4, opcode[3] & 15);\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nif (_fex != 0) {\r\ncurrent->thread.fp_regs.fpc |= _fex;\r\nif (current->thread.fp_regs.fpc & (_fex << 8))\r\nreturn SIGFPE;\r\n}\r\nreturn 0;\r\n}\r\nstatic void* calc_addr(struct pt_regs *regs, int rx, int rb, int disp)\r\n{\r\naddr_t addr;\r\nrx &= 15;\r\nrb &= 15;\r\naddr = disp & 0xfff;\r\naddr += (rx != 0) ? regs->gprs[rx] : 0;\r\naddr += (rb != 0) ? regs->gprs[rb] : 0;\r\nreturn (void*) addr;\r\n}\r\nint math_emu_ed(__u8 *opcode, struct pt_regs * regs) {\r\nint _fex = 0;\r\nstatic const __u8 format_table[256] = {\r\n[0x04] = 0x06,[0x05] = 0x05,[0x06] = 0x07,[0x07] = 0x05,\r\n[0x08] = 0x02,[0x09] = 0x02,[0x0a] = 0x02,[0x0b] = 0x02,\r\n[0x0c] = 0x06,[0x0d] = 0x02,[0x0e] = 0x04,[0x0f] = 0x04,\r\n[0x10] = 0x08,[0x11] = 0x09,[0x12] = 0x0a,[0x14] = 0x02,\r\n[0x15] = 0x01,[0x17] = 0x02,[0x18] = 0x01,[0x19] = 0x01,\r\n[0x1a] = 0x01,[0x1b] = 0x01,[0x1c] = 0x01,[0x1d] = 0x01,\r\n[0x1e] = 0x03,[0x1f] = 0x03,\r\n};\r\nstatic const void *jump_table[]= {\r\n[0x04] = emu_ldeb,[0x05] = emu_lxdb,[0x06] = emu_lxeb,\r\n[0x07] = emu_mxdb,[0x08] = emu_keb, [0x09] = emu_ceb,\r\n[0x0a] = emu_aeb, [0x0b] = emu_seb, [0x0c] = emu_mdeb,\r\n[0x0d] = emu_deb, [0x0e] = emu_maeb,[0x0f] = emu_mseb,\r\n[0x10] = emu_tceb,[0x11] = emu_tcdb,[0x12] = emu_tcxb,\r\n[0x14] = emu_sqeb,[0x15] = emu_sqdb,[0x17] = emu_meeb,\r\n[0x18] = emu_kdb, [0x19] = emu_cdb, [0x1a] = emu_adb,\r\n[0x1b] = emu_sdb, [0x1c] = emu_mdb, [0x1d] = emu_ddb,\r\n[0x1e] = emu_madb,[0x1f] = emu_msdb\r\n};\r\nswitch (format_table[opcode[5]]) {\r\ncase 1: {\r\n__u64 *dxb, temp;\r\n__u32 opc;\r\nemu_store_regd((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_copy_from_user(&temp, dxb, 8);\r\n_fex = ((int (*)(struct pt_regs *, int, double *))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (double *) &temp);\r\nemu_load_regd((opcode[1] >> 4) & 15);\r\nbreak;\r\n}\r\ncase 2: {\r\n__u32 *dxb, temp;\r\n__u32 opc;\r\nemu_store_rege((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_get_user(temp, dxb);\r\n_fex = ((int (*)(struct pt_regs *, int, float *))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (float *) &temp);\r\nemu_load_rege((opcode[1] >> 4) & 15);\r\nbreak;\r\n}\r\ncase 3: {\r\n__u64 *dxb, temp;\r\n__u32 opc;\r\nemu_store_regd((opcode[1] >> 4) & 15);\r\nemu_store_regd((opcode[4] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_copy_from_user(&temp, dxb, 8);\r\n_fex = ((int (*)(struct pt_regs *, int, double *, int))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (double *) &temp, opcode[4] >> 4);\r\nemu_load_regd((opcode[1] >> 4) & 15);\r\nbreak;\r\n}\r\ncase 4: {\r\n__u32 *dxb, temp;\r\n__u32 opc;\r\nemu_store_rege((opcode[1] >> 4) & 15);\r\nemu_store_rege((opcode[4] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_get_user(temp, dxb);\r\n_fex = ((int (*)(struct pt_regs *, int, float *, int))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (float *) &temp, opcode[4] >> 4);\r\nemu_load_rege((opcode[4] >> 4) & 15);\r\nbreak;\r\n}\r\ncase 5:\r\n{\r\n__u64 *dxb, temp;\r\n__u32 opc;\r\nif ((opcode[1] >> 4) & 0x20)\r\nreturn SIGILL;\r\nemu_store_regd((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_copy_from_user(&temp, dxb, 8);\r\n_fex = ((int (*)(struct pt_regs *, int, double *))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (double *) &temp);\r\nemu_load_regd((opcode[1] >> 4) & 15);\r\nemu_load_regd(((opcode[1] >> 4) & 15) + 2);\r\nbreak;\r\n}\r\ncase 6:\r\n{\r\n__u32 *dxb, temp;\r\n__u32 opc;\r\nemu_store_rege((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_get_user(temp, dxb);\r\n_fex = ((int (*)(struct pt_regs *, int, float *))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (float *) &temp);\r\nemu_load_regd((opcode[1] >> 4) & 15);\r\nbreak;\r\n}\r\ncase 7:\r\n{\r\n__u32 *dxb, temp;\r\n__u32 opc;\r\nif ((opcode[1] >> 4) & 0x20)\r\nreturn SIGILL;\r\nemu_store_rege((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_get_user(temp, dxb);\r\n_fex = ((int (*)(struct pt_regs *, int, float *))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, (float *) &temp);\r\nemu_load_regd((opcode[1] >> 4) & 15);\r\nemu_load_regd(((opcode[1] >> 4) & 15) + 2);\r\nbreak;\r\n}\r\ncase 8: {\r\n__u64 dxb;\r\n__u32 opc;\r\nemu_store_rege((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\n_fex = ((int (*)(struct pt_regs *, int, long))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, dxb);\r\nbreak;\r\n}\r\ncase 9: {\r\n__u64 dxb;\r\n__u32 opc;\r\nemu_store_regd((opcode[1] >> 4) & 15);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\n_fex = ((int (*)(struct pt_regs *, int, long))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, dxb);\r\nbreak;\r\n}\r\ncase 10: {\r\n__u64 dxb;\r\n__u32 opc;\r\nif ((opcode[1] >> 4) & 2)\r\nreturn SIGILL;\r\nemu_store_regd((opcode[1] >> 4) & 15);\r\nemu_store_regd(((opcode[1] >> 4) & 15) + 2);\r\nopc = *((__u32 *) opcode);\r\ndxb = (__u64) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\n_fex = ((int (*)(struct pt_regs *, int, long))\r\njump_table[opcode[5]])\r\n(regs, opcode[1] >> 4, dxb);\r\nbreak;\r\n}\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nif (_fex != 0) {\r\ncurrent->thread.fp_regs.fpc |= _fex;\r\nif (current->thread.fp_regs.fpc & (_fex << 8))\r\nreturn SIGFPE;\r\n}\r\nreturn 0;\r\n}\r\nint math_emu_ldr(__u8 *opcode) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u16 opc = *((__u16 *) opcode);\r\nif ((opc & 0x90) == 0) {\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" ld 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (opc & 0xf0), "a" (&fp_regs->fprs[opc & 0xf].d)\r\n: "1");\r\n} else if ((opc & 0x9) == 0) {\r\nasm volatile (\r\n" bras 1,0f\n"\r\n" std 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" ((opc & 0xf) << 4),\r\n"a" (&fp_regs->fprs[(opc & 0xf0)>>4].d)\r\n: "1");\r\n} else\r\nfp_regs->fprs[(opc & 0xf0) >> 4] = fp_regs->fprs[opc & 0xf];\r\nreturn 0;\r\n}\r\nint math_emu_ler(__u8 *opcode) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u16 opc = *((__u16 *) opcode);\r\nif ((opc & 0x90) == 0) {\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" le 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" (opc & 0xf0), "a" (&fp_regs->fprs[opc & 0xf].f)\r\n: "1");\r\n} else if ((opc & 0x9) == 0) {\r\nasm volatile(\r\n" bras 1,0f\n"\r\n" ste 0,0(%1)\n"\r\n"0: ex %0,0(1)"\r\n:\r\n: "a" ((opc & 0xf) << 4),\r\n"a" (&fp_regs->fprs[(opc & 0xf0) >> 4].f)\r\n: "1");\r\n} else\r\nfp_regs->fprs[(opc & 0xf0) >> 4] = fp_regs->fprs[opc & 0xf];\r\nreturn 0;\r\n}\r\nint math_emu_ld(__u8 *opcode, struct pt_regs * regs) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u32 opc = *((__u32 *) opcode);\r\n__u64 *dxb;\r\ndxb = (__u64 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_copy_from_user(&fp_regs->fprs[(opc >> 20) & 0xf].d, dxb, 8);\r\nreturn 0;\r\n}\r\nint math_emu_le(__u8 *opcode, struct pt_regs * regs) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u32 opc = *((__u32 *) opcode);\r\n__u32 *mem, *dxb;\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmem = (__u32 *) (&fp_regs->fprs[(opc >> 20) & 0xf].f);\r\nmathemu_get_user(mem[0], dxb);\r\nreturn 0;\r\n}\r\nint math_emu_std(__u8 *opcode, struct pt_regs * regs) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u32 opc = *((__u32 *) opcode);\r\n__u64 *dxb;\r\ndxb = (__u64 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmathemu_copy_to_user(dxb, &fp_regs->fprs[(opc >> 20) & 0xf].d, 8);\r\nreturn 0;\r\n}\r\nint math_emu_ste(__u8 *opcode, struct pt_regs * regs) {\r\ns390_fp_regs *fp_regs = &current->thread.fp_regs;\r\n__u32 opc = *((__u32 *) opcode);\r\n__u32 *mem, *dxb;\r\ndxb = (__u32 *) calc_addr(regs, opc >> 16, opc >> 12, opc);\r\nmem = (__u32 *) (&fp_regs->fprs[(opc >> 20) & 0xf].f);\r\nmathemu_put_user(mem[0], dxb);\r\nreturn 0;\r\n}\r\nint math_emu_lfpc(__u8 *opcode, struct pt_regs *regs) {\r\n__u32 opc = *((__u32 *) opcode);\r\n__u32 *dxb, temp;\r\ndxb= (__u32 *) calc_addr(regs, 0, opc>>12, opc);\r\nmathemu_get_user(temp, dxb);\r\nif ((temp & ~FPC_VALID_MASK) != 0)\r\nreturn SIGILL;\r\ncurrent->thread.fp_regs.fpc = temp;\r\nreturn 0;\r\n}\r\nint math_emu_stfpc(__u8 *opcode, struct pt_regs *regs) {\r\n__u32 opc = *((__u32 *) opcode);\r\n__u32 *dxb;\r\ndxb= (__u32 *) calc_addr(regs, 0, opc>>12, opc);\r\nmathemu_put_user(current->thread.fp_regs.fpc, dxb);\r\nreturn 0;\r\n}\r\nint math_emu_srnm(__u8 *opcode, struct pt_regs *regs) {\r\n__u32 opc = *((__u32 *) opcode);\r\n__u32 temp;\r\ntemp = calc_addr(regs, 0, opc>>12, opc);\r\ncurrent->thread.fp_regs.fpc &= ~3;\r\ncurrent->thread.fp_regs.fpc |= (temp & 3);\r\nreturn 0;\r\n}\r\nlong long\r\n__negdi2 (long long u)\r\n{\r\nunion lll {\r\nlong long ll;\r\nlong s[2];\r\n};\r\nunion lll w,uu;\r\nuu.ll = u;\r\nw.s[1] = -uu.s[1];\r\nw.s[0] = -uu.s[0] - ((int) w.s[1] != 0);\r\nreturn w.ll;\r\n}

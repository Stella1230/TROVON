static u8 slidebar_pos_get(void)\r\n{\r\nu8 res;\r\nunsigned long flags;\r\nspin_lock_irqsave(&io_lock, flags);\r\noutb(0xf4, 0xff29);\r\noutb(0xbf, 0xff2a);\r\nres = inb(0xff2b);\r\nspin_unlock_irqrestore(&io_lock, flags);\r\nreturn res;\r\n}\r\nstatic u8 slidebar_mode_get(void)\r\n{\r\nu8 res;\r\nunsigned long flags;\r\nspin_lock_irqsave(&io_lock, flags);\r\noutb(0xf7, 0xff29);\r\noutb(0x8b, 0xff2a);\r\nres = inb(0xff2b);\r\nspin_unlock_irqrestore(&io_lock, flags);\r\nreturn res;\r\n}\r\nstatic void slidebar_mode_set(u8 mode)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&io_lock, flags);\r\noutb(0xf7, 0xff29);\r\noutb(0x8b, 0xff2a);\r\noutb(mode, 0xff2b);\r\nspin_unlock_irqrestore(&io_lock, flags);\r\n}\r\nstatic bool slidebar_i8042_filter(unsigned char data, unsigned char str,\r\nstruct serio *port)\r\n{\r\nstatic bool extended = false;\r\nif (str & I8042_STR_AUXDATA)\r\nreturn false;\r\nif (data == 0xe0) {\r\nextended = true;\r\nreturn true;\r\n}\r\nif (!extended)\r\nreturn false;\r\nextended = false;\r\nif (likely((data & 0x7f) != 0x3b)) {\r\nserio_interrupt(port, 0xe0, 0);\r\nreturn false;\r\n}\r\nif (data & 0x80) {\r\ninput_report_key(slidebar_input_dev, BTN_TOUCH, 0);\r\n} else {\r\ninput_report_key(slidebar_input_dev, BTN_TOUCH, 1);\r\ninput_report_abs(slidebar_input_dev, ABS_X, slidebar_pos_get());\r\n}\r\ninput_sync(slidebar_input_dev);\r\nreturn true;\r\n}\r\nstatic ssize_t show_slidebar_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%x\n", slidebar_mode_get());\r\n}\r\nstatic ssize_t store_slidebar_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nu8 mode;\r\nint error;\r\nerror = kstrtou8(buf, 0, &mode);\r\nif (error)\r\nreturn error;\r\nslidebar_mode_set(mode);\r\nreturn count;\r\n}\r\nstatic int __init ideapad_probe(struct platform_device* pdev)\r\n{\r\nint err;\r\nif (!request_region(IDEAPAD_BASE, 3, "ideapad_slidebar")) {\r\ndev_err(&pdev->dev, "IO ports are busy\n");\r\nreturn -EBUSY;\r\n}\r\nslidebar_input_dev = input_allocate_device();\r\nif (!slidebar_input_dev) {\r\ndev_err(&pdev->dev, "Failed to allocate input device\n");\r\nerr = -ENOMEM;\r\ngoto err_release_ports;\r\n}\r\nslidebar_input_dev->name = "IdeaPad Slidebar";\r\nslidebar_input_dev->id.bustype = BUS_HOST;\r\nslidebar_input_dev->dev.parent = &pdev->dev;\r\ninput_set_capability(slidebar_input_dev, EV_KEY, BTN_TOUCH);\r\ninput_set_capability(slidebar_input_dev, EV_ABS, ABS_X);\r\ninput_set_abs_params(slidebar_input_dev, ABS_X, 0, 0xff, 0, 0);\r\nerr = i8042_install_filter(slidebar_i8042_filter);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"Failed to install i8042 filter: %d\n", err);\r\ngoto err_free_dev;\r\n}\r\nerr = input_register_device(slidebar_input_dev);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"Failed to register input device: %d\n", err);\r\ngoto err_remove_filter;\r\n}\r\nreturn 0;\r\nerr_remove_filter:\r\ni8042_remove_filter(slidebar_i8042_filter);\r\nerr_free_dev:\r\ninput_free_device(slidebar_input_dev);\r\nerr_release_ports:\r\nrelease_region(IDEAPAD_BASE, 3);\r\nreturn err;\r\n}\r\nstatic int ideapad_remove(struct platform_device *pdev)\r\n{\r\ni8042_remove_filter(slidebar_i8042_filter);\r\ninput_unregister_device(slidebar_input_dev);\r\nrelease_region(IDEAPAD_BASE, 3);\r\nreturn 0;\r\n}\r\nstatic int __init ideapad_dmi_check(const struct dmi_system_id *id)\r\n{\r\npr_info("Laptop model '%s'\n", id->ident);\r\nreturn 1;\r\n}\r\nstatic int __init slidebar_init(void)\r\n{\r\nint err;\r\nif (!force && !dmi_check_system(ideapad_dmi)) {\r\npr_err("DMI does not match\n");\r\nreturn -ENODEV;\r\n}\r\nslidebar_platform_dev = platform_device_alloc("ideapad_slidebar", -1);\r\nif (!slidebar_platform_dev) {\r\npr_err("Not enough memory\n");\r\nreturn -ENOMEM;\r\n}\r\nslidebar_platform_dev->dev.groups = ideapad_attr_groups;\r\nerr = platform_device_add(slidebar_platform_dev);\r\nif (err) {\r\npr_err("Failed to register platform device\n");\r\ngoto err_free_dev;\r\n}\r\nerr = platform_driver_probe(&slidebar_drv, ideapad_probe);\r\nif (err) {\r\npr_err("Failed to register platform driver\n");\r\ngoto err_delete_dev;\r\n}\r\nreturn 0;\r\nerr_delete_dev:\r\nplatform_device_del(slidebar_platform_dev);\r\nerr_free_dev:\r\nplatform_device_put(slidebar_platform_dev);\r\nreturn err;\r\n}\r\nstatic void __exit slidebar_exit(void)\r\n{\r\nplatform_device_unregister(slidebar_platform_dev);\r\nplatform_driver_unregister(&slidebar_drv);\r\n}

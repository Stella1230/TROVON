void *dma_alloc_coherent(struct device *hwdev, size_t size, dma_addr_t *dma_handle, gfp_t gfp)\r\n{\r\nstruct dma_alloc_record *new;\r\nstruct list_head *this = &dma_alloc_list;\r\nunsigned long flags;\r\nunsigned long start = DMA_SRAM_START;\r\nunsigned long end;\r\nif (!DMA_SRAM_START) {\r\nprintk("%s called without any DMA area reserved!\n", __func__);\r\nreturn NULL;\r\n}\r\nnew = kmalloc(sizeof (*new), GFP_ATOMIC);\r\nif (!new)\r\nreturn NULL;\r\nnew->len = (size + 31) & ~31;\r\nspin_lock_irqsave(&dma_alloc_lock, flags);\r\nlist_for_each (this, &dma_alloc_list) {\r\nstruct dma_alloc_record *this_r = list_entry(this, struct dma_alloc_record, list);\r\nend = this_r->ofs;\r\nif (end - start >= size)\r\ngoto gotone;\r\nstart = this_r->ofs + this_r->len;\r\n}\r\nend = DMA_SRAM_END;\r\nthis = &dma_alloc_list;\r\nif (end - start >= size) {\r\ngotone:\r\nnew->ofs = start;\r\nlist_add_tail(&new->list, this);\r\nspin_unlock_irqrestore(&dma_alloc_lock, flags);\r\n*dma_handle = start;\r\nreturn (void *)start;\r\n}\r\nkfree(new);\r\nspin_unlock_irqrestore(&dma_alloc_lock, flags);\r\nreturn NULL;\r\n}\r\nvoid dma_free_coherent(struct device *hwdev, size_t size, void *vaddr, dma_addr_t dma_handle)\r\n{\r\nstruct dma_alloc_record *rec;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dma_alloc_lock, flags);\r\nlist_for_each_entry(rec, &dma_alloc_list, list) {\r\nif (rec->ofs == dma_handle) {\r\nlist_del(&rec->list);\r\nkfree(rec);\r\nspin_unlock_irqrestore(&dma_alloc_lock, flags);\r\nreturn;\r\n}\r\n}\r\nspin_unlock_irqrestore(&dma_alloc_lock, flags);\r\nBUG();\r\n}\r\ndma_addr_t dma_map_single(struct device *dev, void *ptr, size_t size,\r\nenum dma_data_direction direction)\r\n{\r\nBUG_ON(direction == DMA_NONE);\r\nfrv_cache_wback_inv((unsigned long) ptr, (unsigned long) ptr + size);\r\nreturn virt_to_bus(ptr);\r\n}\r\nint dma_map_sg(struct device *dev, struct scatterlist *sg, int nents,\r\nenum dma_data_direction direction)\r\n{\r\nint i;\r\nfor (i=0; i<nents; i++)\r\nfrv_cache_wback_inv(sg_dma_address(&sg[i]),\r\nsg_dma_address(&sg[i]) + sg_dma_len(&sg[i]));\r\nBUG_ON(direction == DMA_NONE);\r\nreturn nents;\r\n}\r\ndma_addr_t dma_map_page(struct device *dev, struct page *page, unsigned long offset,\r\nsize_t size, enum dma_data_direction direction)\r\n{\r\nBUG_ON(direction == DMA_NONE);\r\nflush_dcache_page(page);\r\nreturn (dma_addr_t) page_to_phys(page) + offset;\r\n}

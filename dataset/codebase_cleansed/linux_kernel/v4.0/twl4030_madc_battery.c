static int madc_read(int index)\r\n{\r\nstruct twl4030_madc_request req;\r\nint val;\r\nreq.channels = index;\r\nreq.method = TWL4030_MADC_SW2;\r\nreq.type = TWL4030_MADC_WAIT;\r\nreq.do_avg = 0;\r\nreq.raw = false;\r\nreq.func_cb = NULL;\r\nval = twl4030_madc_conversion(&req);\r\nif (val < 0)\r\nreturn val;\r\nreturn req.rbuf[ffs(index) - 1];\r\n}\r\nstatic int twl4030_madc_bat_get_charging_status(void)\r\n{\r\nreturn (madc_read(TWL4030_MADC_ICHG) > 0) ? 1 : 0;\r\n}\r\nstatic int twl4030_madc_bat_get_voltage(void)\r\n{\r\nreturn madc_read(TWL4030_MADC_VBAT);\r\n}\r\nstatic int twl4030_madc_bat_get_current(void)\r\n{\r\nreturn madc_read(TWL4030_MADC_ICHG) * 1000;\r\n}\r\nstatic int twl4030_madc_bat_get_temp(void)\r\n{\r\nreturn madc_read(TWL4030_MADC_BTEMP) * 10;\r\n}\r\nstatic int twl4030_madc_bat_voltscale(struct twl4030_madc_battery *bat,\r\nint volt)\r\n{\r\nstruct twl4030_madc_bat_calibration *calibration;\r\nint i, res = 0;\r\nif (twl4030_madc_bat_get_charging_status())\r\ncalibration = bat->pdata->charging;\r\nelse\r\ncalibration = bat->pdata->discharging;\r\nif (volt > calibration[0].voltage) {\r\nres = calibration[0].level;\r\n} else {\r\nfor (i = 0; calibration[i+1].voltage >= 0; i++) {\r\nif (volt <= calibration[i].voltage &&\r\nvolt >= calibration[i+1].voltage) {\r\nres = calibration[i].level -\r\n((calibration[i].voltage - volt) *\r\n(calibration[i].level -\r\ncalibration[i+1].level)) /\r\n(calibration[i].voltage -\r\ncalibration[i+1].voltage);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn res;\r\n}\r\nstatic int twl4030_madc_bat_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct twl4030_madc_battery *bat = container_of(psy,\r\nstruct twl4030_madc_battery, psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage()) > 95)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nelse {\r\nif (twl4030_madc_bat_get_charging_status())\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = twl4030_madc_bat_get_voltage() * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nval->intval = twl4030_madc_bat_get_current();\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW: {\r\nint percent = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage());\r\nval->intval = (percent * bat->pdata->capacity) / 100;\r\nbreak;\r\n}\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage());\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nval->intval = bat->pdata->capacity;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = twl4030_madc_bat_get_temp();\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW: {\r\nint percent = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage());\r\nint chg = (percent * (bat->pdata->capacity/1000))/100;\r\nval->intval = (3600l * chg) / 400;\r\nbreak;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void twl4030_madc_bat_ext_changed(struct power_supply *psy)\r\n{\r\nstruct twl4030_madc_battery *bat = container_of(psy,\r\nstruct twl4030_madc_battery, psy);\r\npower_supply_changed(&bat->psy);\r\n}\r\nstatic int twl4030_cmp(const void *a, const void *b)\r\n{\r\nreturn ((struct twl4030_madc_bat_calibration *)b)->voltage -\r\n((struct twl4030_madc_bat_calibration *)a)->voltage;\r\n}\r\nstatic int twl4030_madc_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct twl4030_madc_battery *twl4030_madc_bat;\r\nstruct twl4030_madc_bat_platform_data *pdata = pdev->dev.platform_data;\r\ntwl4030_madc_bat = kzalloc(sizeof(*twl4030_madc_bat), GFP_KERNEL);\r\nif (!twl4030_madc_bat)\r\nreturn -ENOMEM;\r\ntwl4030_madc_bat->psy.name = "twl4030_battery";\r\ntwl4030_madc_bat->psy.type = POWER_SUPPLY_TYPE_BATTERY;\r\ntwl4030_madc_bat->psy.properties = twl4030_madc_bat_props;\r\ntwl4030_madc_bat->psy.num_properties =\r\nARRAY_SIZE(twl4030_madc_bat_props);\r\ntwl4030_madc_bat->psy.get_property = twl4030_madc_bat_get_property;\r\ntwl4030_madc_bat->psy.external_power_changed =\r\ntwl4030_madc_bat_ext_changed;\r\nsort(pdata->charging, pdata->charging_size,\r\nsizeof(struct twl4030_madc_bat_calibration),\r\ntwl4030_cmp, NULL);\r\nsort(pdata->discharging, pdata->discharging_size,\r\nsizeof(struct twl4030_madc_bat_calibration),\r\ntwl4030_cmp, NULL);\r\ntwl4030_madc_bat->pdata = pdata;\r\nplatform_set_drvdata(pdev, twl4030_madc_bat);\r\npower_supply_register(&pdev->dev, &twl4030_madc_bat->psy);\r\nreturn 0;\r\n}\r\nstatic int twl4030_madc_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct twl4030_madc_battery *bat = platform_get_drvdata(pdev);\r\npower_supply_unregister(&bat->psy);\r\nkfree(bat);\r\nreturn 0;\r\n}

static inline int at91_cf_present(struct at91_cf_socket *cf)\r\n{\r\nreturn !gpio_get_value(cf->board->det_pin);\r\n}\r\nstatic int at91_cf_ss_init(struct pcmcia_socket *s)\r\n{\r\nreturn 0;\r\n}\r\nstatic irqreturn_t at91_cf_irq(int irq, void *_cf)\r\n{\r\nstruct at91_cf_socket *cf = _cf;\r\nif (irq == gpio_to_irq(cf->board->det_pin)) {\r\nunsigned present = at91_cf_present(cf);\r\nif (present != cf->present) {\r\ncf->present = present;\r\ndev_dbg(&cf->pdev->dev, "card %s\n",\r\npresent ? "present" : "gone");\r\npcmcia_parse_events(&cf->socket, SS_DETECT);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int at91_cf_get_status(struct pcmcia_socket *s, u_int *sp)\r\n{\r\nstruct at91_cf_socket *cf;\r\nif (!sp)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nif (at91_cf_present(cf)) {\r\nint rdy = gpio_is_valid(cf->board->irq_pin);\r\nint vcc = gpio_is_valid(cf->board->vcc_pin);\r\n*sp = SS_DETECT | SS_3VCARD;\r\nif (!rdy || gpio_get_value(cf->board->irq_pin))\r\n*sp |= SS_READY;\r\nif (!vcc || gpio_get_value(cf->board->vcc_pin))\r\n*sp |= SS_POWERON;\r\n} else\r\n*sp = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nat91_cf_set_socket(struct pcmcia_socket *sock, struct socket_state_t *s)\r\n{\r\nstruct at91_cf_socket *cf;\r\ncf = container_of(sock, struct at91_cf_socket, socket);\r\nif (gpio_is_valid(cf->board->vcc_pin)) {\r\nswitch (s->Vcc) {\r\ncase 0:\r\ngpio_set_value(cf->board->vcc_pin, 0);\r\nbreak;\r\ncase 33:\r\ngpio_set_value(cf->board->vcc_pin, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\ngpio_set_value(cf->board->rst_pin, s->flags & SS_RESET);\r\ndev_dbg(&cf->pdev->dev, "Vcc %d, io_irq %d, flags %04x csc %04x\n",\r\ns->Vcc, s->io_irq, s->flags, s->csc_mask);\r\nreturn 0;\r\n}\r\nstatic int at91_cf_ss_suspend(struct pcmcia_socket *s)\r\n{\r\nreturn at91_cf_set_socket(s, &dead_socket);\r\n}\r\nstatic int at91_cf_set_io_map(struct pcmcia_socket *s, struct pccard_io_map *io)\r\n{\r\nstruct at91_cf_socket *cf;\r\nu32 csr;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nio->flags &= (MAP_ACTIVE | MAP_16BIT | MAP_AUTOSZ);\r\ncsr = at91_ramc_read(0, AT91_SMC_CSR(cf->board->chipselect)) & ~AT91_SMC_DBW;\r\nif (!(io->flags & (MAP_16BIT | MAP_AUTOSZ))) {\r\ncsr |= AT91_SMC_DBW_8;\r\ndev_dbg(&cf->pdev->dev, "8bit i/o bus\n");\r\n} else {\r\ncsr |= AT91_SMC_DBW_16;\r\ndev_dbg(&cf->pdev->dev, "16bit i/o bus\n");\r\n}\r\nat91_ramc_write(0, AT91_SMC_CSR(cf->board->chipselect), csr);\r\nio->start = cf->socket.io_offset;\r\nio->stop = io->start + SZ_2K - 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nat91_cf_set_mem_map(struct pcmcia_socket *s, struct pccard_mem_map *map)\r\n{\r\nstruct at91_cf_socket *cf;\r\nif (map->card_start)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nmap->flags &= (MAP_ACTIVE | MAP_ATTRIB | MAP_16BIT);\r\nif (map->flags & MAP_ATTRIB)\r\nmap->static_start = cf->phys_baseaddr + CF_ATTR_PHYS;\r\nelse\r\nmap->static_start = cf->phys_baseaddr + CF_MEM_PHYS;\r\nreturn 0;\r\n}\r\nstatic int at91_cf_dt_init(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_data *board;\r\nboard = devm_kzalloc(&pdev->dev, sizeof(*board), GFP_KERNEL);\r\nif (!board)\r\nreturn -ENOMEM;\r\nboard->irq_pin = of_get_gpio(pdev->dev.of_node, 0);\r\nboard->det_pin = of_get_gpio(pdev->dev.of_node, 1);\r\nboard->vcc_pin = of_get_gpio(pdev->dev.of_node, 2);\r\nboard->rst_pin = of_get_gpio(pdev->dev.of_node, 3);\r\npdev->dev.platform_data = board;\r\nreturn 0;\r\n}\r\nstatic int at91_cf_dt_init(struct platform_device *pdev)\r\n{\r\nreturn -ENODEV;\r\n}\r\nstatic int at91_cf_probe(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf;\r\nstruct at91_cf_data *board = pdev->dev.platform_data;\r\nstruct resource *io;\r\nint status;\r\nif (!board) {\r\nstatus = at91_cf_dt_init(pdev);\r\nif (status)\r\nreturn status;\r\nboard = pdev->dev.platform_data;\r\n}\r\nif (!gpio_is_valid(board->det_pin) || !gpio_is_valid(board->rst_pin))\r\nreturn -ENODEV;\r\nio = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!io)\r\nreturn -ENODEV;\r\ncf = devm_kzalloc(&pdev->dev, sizeof(*cf), GFP_KERNEL);\r\nif (!cf)\r\nreturn -ENOMEM;\r\ncf->board = board;\r\ncf->pdev = pdev;\r\ncf->phys_baseaddr = io->start;\r\nplatform_set_drvdata(pdev, cf);\r\nstatus = devm_gpio_request(&pdev->dev, board->det_pin, "cf_det");\r\nif (status < 0)\r\nreturn status;\r\nstatus = devm_request_irq(&pdev->dev, gpio_to_irq(board->det_pin),\r\nat91_cf_irq, 0, "at91_cf detect", cf);\r\nif (status < 0)\r\nreturn status;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nstatus = devm_gpio_request(&pdev->dev, board->rst_pin, "cf_rst");\r\nif (status < 0)\r\ngoto fail0a;\r\nif (gpio_is_valid(board->vcc_pin)) {\r\nstatus = devm_gpio_request(&pdev->dev, board->vcc_pin, "cf_vcc");\r\nif (status < 0)\r\ngoto fail0a;\r\n}\r\nif (gpio_is_valid(board->irq_pin)) {\r\nstatus = devm_gpio_request(&pdev->dev, board->irq_pin, "cf_irq");\r\nif (status < 0)\r\ngoto fail0a;\r\nstatus = devm_request_irq(&pdev->dev, gpio_to_irq(board->irq_pin),\r\nat91_cf_irq, IRQF_SHARED, "at91_cf", cf);\r\nif (status < 0)\r\ngoto fail0a;\r\ncf->socket.pci_irq = gpio_to_irq(board->irq_pin);\r\n} else\r\ncf->socket.pci_irq = nr_irqs + 1;\r\ncf->socket.io_offset = (unsigned long) devm_ioremap(&pdev->dev,\r\ncf->phys_baseaddr + CF_IO_PHYS, SZ_2K);\r\nif (!cf->socket.io_offset) {\r\nstatus = -ENXIO;\r\ngoto fail0a;\r\n}\r\nif (!devm_request_mem_region(&pdev->dev, io->start, resource_size(io), "at91_cf")) {\r\nstatus = -ENXIO;\r\ngoto fail0a;\r\n}\r\ndev_info(&pdev->dev, "irqs det #%d, io #%d\n",\r\ngpio_to_irq(board->det_pin), gpio_to_irq(board->irq_pin));\r\ncf->socket.owner = THIS_MODULE;\r\ncf->socket.dev.parent = &pdev->dev;\r\ncf->socket.ops = &at91_cf_ops;\r\ncf->socket.resource_ops = &pccard_static_ops;\r\ncf->socket.features = SS_CAP_PCCARD | SS_CAP_STATIC_MAP\r\n| SS_CAP_MEM_ALIGN;\r\ncf->socket.map_size = SZ_2K;\r\ncf->socket.io[0].res = io;\r\nstatus = pcmcia_register_socket(&cf->socket);\r\nif (status < 0)\r\ngoto fail0a;\r\nreturn 0;\r\nfail0a:\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nreturn status;\r\n}\r\nstatic int at91_cf_remove(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\npcmcia_unregister_socket(&cf->socket);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int at91_cf_suspend(struct platform_device *pdev, pm_message_t mesg)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\nstruct at91_cf_data *board = cf->board;\r\nif (device_may_wakeup(&pdev->dev)) {\r\nenable_irq_wake(gpio_to_irq(board->det_pin));\r\nif (gpio_is_valid(board->irq_pin))\r\nenable_irq_wake(gpio_to_irq(board->irq_pin));\r\n}\r\nreturn 0;\r\n}\r\nstatic int at91_cf_resume(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\nstruct at91_cf_data *board = cf->board;\r\nif (device_may_wakeup(&pdev->dev)) {\r\ndisable_irq_wake(gpio_to_irq(board->det_pin));\r\nif (gpio_is_valid(board->irq_pin))\r\ndisable_irq_wake(gpio_to_irq(board->irq_pin));\r\n}\r\nreturn 0;\r\n}

static scom_map_t opal_scom_map(struct device_node *dev, u64 reg, u64 count)\r\n{\r\nstruct opal_scom_map *m;\r\nconst __be32 *gcid;\r\nif (!of_get_property(dev, "scom-controller", NULL)) {\r\npr_err("%s: device %s is not a SCOM controller\n",\r\n__func__, dev->full_name);\r\nreturn SCOM_MAP_INVALID;\r\n}\r\ngcid = of_get_property(dev, "ibm,chip-id", NULL);\r\nif (!gcid) {\r\npr_err("%s: device %s has no ibm,chip-id\n",\r\n__func__, dev->full_name);\r\nreturn SCOM_MAP_INVALID;\r\n}\r\nm = kmalloc(sizeof(struct opal_scom_map), GFP_KERNEL);\r\nif (!m)\r\nreturn NULL;\r\nm->chip = be32_to_cpup(gcid);\r\nm->addr = reg;\r\nreturn (scom_map_t)m;\r\n}\r\nstatic void opal_scom_unmap(scom_map_t map)\r\n{\r\nkfree(map);\r\n}\r\nstatic int opal_xscom_err_xlate(int64_t rc)\r\n{\r\nswitch(rc) {\r\ncase 0:\r\nreturn 0;\r\ndefault:\r\nreturn -EIO;\r\n}\r\n}\r\nstatic u64 opal_scom_unmangle(u64 addr)\r\n{\r\nif (addr & (0x1full << 59))\r\naddr = (addr & ~(0xffull << 56)) | (1ull << 63);\r\nreturn addr;\r\n}\r\nstatic int opal_scom_read(scom_map_t map, u64 reg, u64 *value)\r\n{\r\nstruct opal_scom_map *m = map;\r\nint64_t rc;\r\n__be64 v;\r\nreg = opal_scom_unmangle(m->addr + reg);\r\nrc = opal_xscom_read(m->chip, reg, (__be64 *)__pa(&v));\r\n*value = be64_to_cpu(v);\r\nreturn opal_xscom_err_xlate(rc);\r\n}\r\nstatic int opal_scom_write(scom_map_t map, u64 reg, u64 value)\r\n{\r\nstruct opal_scom_map *m = map;\r\nint64_t rc;\r\nreg = opal_scom_unmangle(m->addr + reg);\r\nrc = opal_xscom_write(m->chip, reg, value);\r\nreturn opal_xscom_err_xlate(rc);\r\n}\r\nstatic int opal_xscom_init(void)\r\n{\r\nif (firmware_has_feature(FW_FEATURE_OPALv3))\r\nscom_init(&opal_scom_controller);\r\nreturn 0;\r\n}

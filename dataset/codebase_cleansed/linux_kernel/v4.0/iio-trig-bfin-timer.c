static int iio_bfin_tmr_set_state(struct iio_trigger *trig, bool state)\r\n{\r\nstruct bfin_tmr_state *st = iio_trigger_get_drvdata(trig);\r\nif (get_gptimer_period(st->t->id) == 0)\r\nreturn -EINVAL;\r\nif (state)\r\nenable_gptimers(st->t->bit);\r\nelse\r\ndisable_gptimers(st->t->bit);\r\nreturn 0;\r\n}\r\nstatic ssize_t iio_bfin_tmr_frequency_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct iio_trigger *trig = to_iio_trigger(dev);\r\nstruct bfin_tmr_state *st = iio_trigger_get_drvdata(trig);\r\nunsigned int val;\r\nbool enabled;\r\nint ret;\r\nret = kstrtouint(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val > 100000)\r\nreturn -EINVAL;\r\nenabled = get_enabled_gptimers() & st->t->bit;\r\nif (enabled)\r\ndisable_gptimers(st->t->bit);\r\nif (val == 0)\r\nreturn count;\r\nval = get_sclk() / val;\r\nif (val <= 4 || val <= st->duty)\r\nreturn -EINVAL;\r\nset_gptimer_period(st->t->id, val);\r\nset_gptimer_pwidth(st->t->id, val - st->duty);\r\nif (enabled)\r\nenable_gptimers(st->t->bit);\r\nreturn count;\r\n}\r\nstatic ssize_t iio_bfin_tmr_frequency_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_trigger *trig = to_iio_trigger(dev);\r\nstruct bfin_tmr_state *st = iio_trigger_get_drvdata(trig);\r\nunsigned int period = get_gptimer_period(st->t->id);\r\nunsigned long val;\r\nif (period == 0)\r\nval = 0;\r\nelse\r\nval = get_sclk() / get_gptimer_period(st->t->id);\r\nreturn sprintf(buf, "%lu\n", val);\r\n}\r\nstatic irqreturn_t iio_bfin_tmr_trigger_isr(int irq, void *devid)\r\n{\r\nstruct bfin_tmr_state *st = devid;\r\nclear_gptimer_intr(st->t->id);\r\niio_trigger_poll(st->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int iio_bfin_tmr_get_number(int irq)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_BLACKFIN_GPTIMERS; i++)\r\nif (iio_bfin_timer_code[i].irq == irq)\r\nreturn i;\r\nreturn -ENODEV;\r\n}\r\nstatic int iio_bfin_tmr_trigger_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_bfin_timer_trigger_pdata *pdata = pdev->dev.platform_data;\r\nstruct bfin_tmr_state *st;\r\nunsigned int config;\r\nint ret;\r\nst = devm_kzalloc(&pdev->dev, sizeof(*st), GFP_KERNEL);\r\nif (st == NULL)\r\nreturn -ENOMEM;\r\nst->irq = platform_get_irq(pdev, 0);\r\nif (!st->irq) {\r\ndev_err(&pdev->dev, "No IRQs specified");\r\nreturn -ENODEV;\r\n}\r\nret = iio_bfin_tmr_get_number(st->irq);\r\nif (ret < 0)\r\nreturn ret;\r\nst->timer_num = ret;\r\nst->t = &iio_bfin_timer_code[st->timer_num];\r\nst->trig = iio_trigger_alloc("bfintmr%d", st->timer_num);\r\nif (!st->trig)\r\nreturn -ENOMEM;\r\nst->trig->ops = &iio_bfin_tmr_trigger_ops;\r\nst->trig->dev.groups = iio_bfin_tmr_trigger_attr_groups;\r\niio_trigger_set_drvdata(st->trig, st);\r\nret = iio_trigger_register(st->trig);\r\nif (ret)\r\ngoto out;\r\nret = request_irq(st->irq, iio_bfin_tmr_trigger_isr,\r\n0, st->trig->name, st);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"request IRQ-%d failed", st->irq);\r\ngoto out1;\r\n}\r\nconfig = PWM_OUT | PERIOD_CNT | IRQ_ENA;\r\nif (pdata && pdata->output_enable) {\r\nunsigned long long val;\r\nst->output_enable = true;\r\nret = peripheral_request(st->t->pin, st->trig->name);\r\nif (ret)\r\ngoto out_free_irq;\r\nval = (unsigned long long)get_sclk() * pdata->duty_ns;\r\ndo_div(val, NSEC_PER_SEC);\r\nst->duty = val;\r\nif (pdata->active_low)\r\nconfig |= PULSE_HI;\r\n} else {\r\nst->duty = 1;\r\nconfig |= OUT_DIS;\r\n}\r\nset_gptimer_config(st->t->id, config);\r\ndev_info(&pdev->dev, "iio trigger Blackfin TMR%d, IRQ-%d",\r\nst->timer_num, st->irq);\r\nplatform_set_drvdata(pdev, st);\r\nreturn 0;\r\nout_free_irq:\r\nfree_irq(st->irq, st);\r\nout1:\r\niio_trigger_unregister(st->trig);\r\nout:\r\niio_trigger_put(st->trig);\r\nreturn ret;\r\n}\r\nstatic int iio_bfin_tmr_trigger_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_tmr_state *st = platform_get_drvdata(pdev);\r\ndisable_gptimers(st->t->bit);\r\nif (st->output_enable)\r\nperipheral_free(st->t->pin);\r\nfree_irq(st->irq, st);\r\niio_trigger_unregister(st->trig);\r\niio_trigger_put(st->trig);\r\nreturn 0;\r\n}

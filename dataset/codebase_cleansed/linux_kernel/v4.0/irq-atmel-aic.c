static asmlinkage void __exception_irq_entry\r\naic_handle(struct pt_regs *regs)\r\n{\r\nstruct irq_domain_chip_generic *dgc = aic_domain->gc;\r\nstruct irq_chip_generic *gc = dgc->gc[0];\r\nu32 irqnr;\r\nu32 irqstat;\r\nirqnr = irq_reg_readl(gc, AT91_AIC_IVR);\r\nirqstat = irq_reg_readl(gc, AT91_AIC_ISR);\r\nif (!irqstat)\r\nirq_reg_writel(gc, 0, AT91_AIC_EOICR);\r\nelse\r\nhandle_domain_irq(aic_domain, irqnr, regs);\r\n}\r\nstatic int aic_retrigger(struct irq_data *d)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nirq_gc_lock(gc);\r\nirq_reg_writel(gc, d->mask, AT91_AIC_ISCR);\r\nirq_gc_unlock(gc);\r\nreturn 0;\r\n}\r\nstatic int aic_set_type(struct irq_data *d, unsigned type)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nunsigned int smr;\r\nint ret;\r\nsmr = irq_reg_readl(gc, AT91_AIC_SMR(d->hwirq));\r\nret = aic_common_set_type(d, type, &smr);\r\nif (ret)\r\nreturn ret;\r\nirq_reg_writel(gc, smr, AT91_AIC_SMR(d->hwirq));\r\nreturn 0;\r\n}\r\nstatic void aic_suspend(struct irq_data *d)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nirq_gc_lock(gc);\r\nirq_reg_writel(gc, gc->mask_cache, AT91_AIC_IDCR);\r\nirq_reg_writel(gc, gc->wake_active, AT91_AIC_IECR);\r\nirq_gc_unlock(gc);\r\n}\r\nstatic void aic_resume(struct irq_data *d)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nirq_gc_lock(gc);\r\nirq_reg_writel(gc, gc->wake_active, AT91_AIC_IDCR);\r\nirq_reg_writel(gc, gc->mask_cache, AT91_AIC_IECR);\r\nirq_gc_unlock(gc);\r\n}\r\nstatic void aic_pm_shutdown(struct irq_data *d)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nirq_gc_lock(gc);\r\nirq_reg_writel(gc, 0xffffffff, AT91_AIC_IDCR);\r\nirq_reg_writel(gc, 0xffffffff, AT91_AIC_ICCR);\r\nirq_gc_unlock(gc);\r\n}\r\nstatic void __init aic_hw_init(struct irq_domain *domain)\r\n{\r\nstruct irq_chip_generic *gc = irq_get_domain_generic_chip(domain, 0);\r\nint i;\r\nfor (i = 0; i < 8; i++)\r\nirq_reg_writel(gc, 0, AT91_AIC_EOICR);\r\nirq_reg_writel(gc, 0xffffffff, AT91_AIC_SPU);\r\nirq_reg_writel(gc, 0, AT91_AIC_DCR);\r\nirq_reg_writel(gc, 0xffffffff, AT91_AIC_IDCR);\r\nirq_reg_writel(gc, 0xffffffff, AT91_AIC_ICCR);\r\nfor (i = 0; i < 32; i++)\r\nirq_reg_writel(gc, i, AT91_AIC_SVR(i));\r\n}\r\nstatic int aic_irq_domain_xlate(struct irq_domain *d,\r\nstruct device_node *ctrlr,\r\nconst u32 *intspec, unsigned int intsize,\r\nirq_hw_number_t *out_hwirq,\r\nunsigned int *out_type)\r\n{\r\nstruct irq_domain_chip_generic *dgc = d->gc;\r\nstruct irq_chip_generic *gc;\r\nunsigned smr;\r\nint idx;\r\nint ret;\r\nif (!dgc)\r\nreturn -EINVAL;\r\nret = aic_common_irq_domain_xlate(d, ctrlr, intspec, intsize,\r\nout_hwirq, out_type);\r\nif (ret)\r\nreturn ret;\r\nidx = intspec[0] / dgc->irqs_per_chip;\r\nif (idx >= dgc->num_chips)\r\nreturn -EINVAL;\r\ngc = dgc->gc[idx];\r\nirq_gc_lock(gc);\r\nsmr = irq_reg_readl(gc, AT91_AIC_SMR(*out_hwirq));\r\nret = aic_common_set_priority(intspec[2], &smr);\r\nif (!ret)\r\nirq_reg_writel(gc, smr, AT91_AIC_SMR(*out_hwirq));\r\nirq_gc_unlock(gc);\r\nreturn ret;\r\n}\r\nstatic void __init at91rm9200_aic_irq_fixup(struct device_node *root)\r\n{\r\naic_common_rtc_irq_fixup(root);\r\n}\r\nstatic void __init at91sam9260_aic_irq_fixup(struct device_node *root)\r\n{\r\naic_common_rtt_irq_fixup(root);\r\n}\r\nstatic void __init at91sam9g45_aic_irq_fixup(struct device_node *root)\r\n{\r\naic_common_rtc_irq_fixup(root);\r\naic_common_rtt_irq_fixup(root);\r\n}\r\nstatic int __init aic_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nstruct irq_chip_generic *gc;\r\nstruct irq_domain *domain;\r\nif (aic_domain)\r\nreturn -EEXIST;\r\ndomain = aic_common_of_init(node, &aic_irq_ops, "atmel-aic",\r\nNR_AIC_IRQS);\r\nif (IS_ERR(domain))\r\nreturn PTR_ERR(domain);\r\naic_common_irq_fixup(aic_irq_fixups);\r\naic_domain = domain;\r\ngc = irq_get_domain_generic_chip(domain, 0);\r\ngc->chip_types[0].regs.eoi = AT91_AIC_EOICR;\r\ngc->chip_types[0].regs.enable = AT91_AIC_IECR;\r\ngc->chip_types[0].regs.disable = AT91_AIC_IDCR;\r\ngc->chip_types[0].chip.irq_mask = irq_gc_mask_disable_reg;\r\ngc->chip_types[0].chip.irq_unmask = irq_gc_unmask_enable_reg;\r\ngc->chip_types[0].chip.irq_retrigger = aic_retrigger;\r\ngc->chip_types[0].chip.irq_set_type = aic_set_type;\r\ngc->chip_types[0].chip.irq_suspend = aic_suspend;\r\ngc->chip_types[0].chip.irq_resume = aic_resume;\r\ngc->chip_types[0].chip.irq_pm_shutdown = aic_pm_shutdown;\r\naic_hw_init(domain);\r\nset_handle_irq(aic_handle);\r\nreturn 0;\r\n}

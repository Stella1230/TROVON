static enum max14577_muic_charger_type maxim_get_charger_type(\r\nenum maxim_device_type dev_type, u8 val) {\r\nswitch (val) {\r\ncase MAX14577_CHARGER_TYPE_NONE:\r\ncase MAX14577_CHARGER_TYPE_USB:\r\ncase MAX14577_CHARGER_TYPE_DOWNSTREAM_PORT:\r\ncase MAX14577_CHARGER_TYPE_DEDICATED_CHG:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_500MA:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_1A:\r\nreturn val;\r\ncase MAX14577_CHARGER_TYPE_DEAD_BATTERY:\r\ncase MAX14577_CHARGER_TYPE_RESERVED:\r\nif (dev_type == MAXIM_DEVICE_TYPE_MAX77836)\r\nval |= 0x8;\r\nreturn val;\r\ndefault:\r\nWARN_ONCE(1, "max14577: Unsupported chgtyp register value 0x%02x", val);\r\nreturn val;\r\n}\r\n}\r\nstatic int max14577_get_charger_state(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nint state = POWER_SUPPLY_STATUS_DISCHARGING;\r\nu8 reg_data;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_CHG_CTRL2, &reg_data);\r\nif ((reg_data & CHGCTRL2_MBCHOSTEN_MASK) == 0)\r\ngoto state_set;\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\r\nif (reg_data & STATUS3_CGMBC_MASK) {\r\nif (reg_data & STATUS3_EOC_MASK)\r\nstate = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\nstate = POWER_SUPPLY_STATUS_CHARGING;\r\ngoto state_set;\r\n}\r\nstate_set:\r\nchg->charging_state = state;\r\nreturn state;\r\n}\r\nstatic int max14577_get_charge_type(struct max14577_charger *chg)\r\n{\r\nif (max14577_get_charger_state(chg) == POWER_SUPPLY_STATUS_CHARGING)\r\nreturn POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nreturn POWER_SUPPLY_CHARGE_TYPE_NONE;\r\n}\r\nstatic int max14577_get_online(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nu8 reg_data;\r\nenum max14577_muic_charger_type chg_type;\r\nmax14577_read_reg(rmap, MAX14577_MUIC_REG_STATUS2, &reg_data);\r\nreg_data = ((reg_data & STATUS2_CHGTYP_MASK) >> STATUS2_CHGTYP_SHIFT);\r\nchg_type = maxim_get_charger_type(chg->max14577->dev_type, reg_data);\r\nswitch (chg_type) {\r\ncase MAX14577_CHARGER_TYPE_USB:\r\ncase MAX14577_CHARGER_TYPE_DEDICATED_CHG:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_500MA:\r\ncase MAX14577_CHARGER_TYPE_SPECIAL_1A:\r\ncase MAX14577_CHARGER_TYPE_DEAD_BATTERY:\r\ncase MAX77836_CHARGER_TYPE_SPECIAL_BIAS:\r\nreturn 1;\r\ncase MAX14577_CHARGER_TYPE_NONE:\r\ncase MAX14577_CHARGER_TYPE_DOWNSTREAM_PORT:\r\ncase MAX14577_CHARGER_TYPE_RESERVED:\r\ncase MAX77836_CHARGER_TYPE_RESERVED:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int max14577_get_battery_health(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nint state = POWER_SUPPLY_HEALTH_GOOD;\r\nu8 reg_data;\r\nenum max14577_muic_charger_type chg_type;\r\nmax14577_read_reg(rmap, MAX14577_MUIC_REG_STATUS2, &reg_data);\r\nreg_data = ((reg_data & STATUS2_CHGTYP_MASK) >> STATUS2_CHGTYP_SHIFT);\r\nchg_type = maxim_get_charger_type(chg->max14577->dev_type, reg_data);\r\nif (chg_type == MAX14577_CHARGER_TYPE_DEAD_BATTERY) {\r\nstate = POWER_SUPPLY_HEALTH_DEAD;\r\ngoto state_set;\r\n}\r\nmax14577_read_reg(rmap, MAX14577_CHG_REG_STATUS3, &reg_data);\r\nif (reg_data & STATUS3_OVP_MASK) {\r\nstate = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\ngoto state_set;\r\n}\r\nstate_set:\r\nchg->battery_state = state;\r\nreturn state;\r\n}\r\nstatic int max14577_get_present(struct max14577_charger *chg)\r\n{\r\nreturn 1;\r\n}\r\nstatic int max14577_set_fast_charge_timer(struct max14577_charger *chg,\r\nunsigned long hours)\r\n{\r\nu8 reg_data;\r\nswitch (hours) {\r\ncase 5 ... 7:\r\nreg_data = hours - 3;\r\nbreak;\r\ncase 0:\r\nreg_data = 0x7;\r\nbreak;\r\ndefault:\r\ndev_err(chg->dev, "Wrong value for Fast-Charge Timer: %lu\n",\r\nhours);\r\nreturn -EINVAL;\r\n}\r\nreg_data <<= CHGCTRL1_TCHW_SHIFT;\r\nreturn max14577_update_reg(chg->max14577->regmap,\r\nMAX14577_REG_CHGCTRL1, CHGCTRL1_TCHW_MASK, reg_data);\r\n}\r\nstatic int max14577_init_constant_voltage(struct max14577_charger *chg,\r\nunsigned int uvolt)\r\n{\r\nu8 reg_data;\r\nif (uvolt < MAXIM_CHARGER_CONSTANT_VOLTAGE_MIN ||\r\nuvolt > MAXIM_CHARGER_CONSTANT_VOLTAGE_MAX)\r\nreturn -EINVAL;\r\nif (uvolt == 4200000)\r\nreg_data = 0x0;\r\nelse if (uvolt == MAXIM_CHARGER_CONSTANT_VOLTAGE_MAX)\r\nreg_data = 0x1f;\r\nelse if (uvolt <= 4280000) {\r\nunsigned int val = uvolt;\r\nval -= MAXIM_CHARGER_CONSTANT_VOLTAGE_MIN;\r\nval /= MAXIM_CHARGER_CONSTANT_VOLTAGE_STEP;\r\nif (uvolt <= 4180000)\r\nreg_data = 0x1 + val;\r\nelse\r\nreg_data = val;\r\n} else\r\nreturn -EINVAL;\r\nreg_data <<= CHGCTRL3_MBCCVWRC_SHIFT;\r\nreturn max14577_write_reg(chg->max14577->regmap,\r\nMAX14577_CHG_REG_CHG_CTRL3, reg_data);\r\n}\r\nstatic int max14577_init_eoc(struct max14577_charger *chg,\r\nunsigned int uamp)\r\n{\r\nunsigned int current_bits = 0xf;\r\nu8 reg_data;\r\nswitch (chg->max14577->dev_type) {\r\ncase MAXIM_DEVICE_TYPE_MAX77836:\r\nif (uamp < 5000)\r\nreturn -EINVAL;\r\nif (uamp >= 7500 && uamp < 10000)\r\ncurrent_bits = 0x0;\r\nelse if (uamp <= 50000) {\r\ncurrent_bits = uamp / 5000;\r\n} else {\r\nuamp = min(uamp, 100000U) - 50000U;\r\ncurrent_bits = 0xa + uamp / 10000;\r\n}\r\nbreak;\r\ncase MAXIM_DEVICE_TYPE_MAX14577:\r\ndefault:\r\nif (uamp < MAX14577_CHARGER_EOC_CURRENT_LIMIT_MIN)\r\nreturn -EINVAL;\r\nuamp = min(uamp, MAX14577_CHARGER_EOC_CURRENT_LIMIT_MAX);\r\nuamp -= MAX14577_CHARGER_EOC_CURRENT_LIMIT_MIN;\r\ncurrent_bits = uamp / MAX14577_CHARGER_EOC_CURRENT_LIMIT_STEP;\r\nbreak;\r\n}\r\nreg_data = current_bits << CHGCTRL5_EOCS_SHIFT;\r\nreturn max14577_update_reg(chg->max14577->regmap,\r\nMAX14577_CHG_REG_CHG_CTRL5, CHGCTRL5_EOCS_MASK,\r\nreg_data);\r\n}\r\nstatic int max14577_init_fast_charge(struct max14577_charger *chg,\r\nunsigned int uamp)\r\n{\r\nu8 reg_data;\r\nint ret;\r\nconst struct maxim_charger_current *limits =\r\n&maxim_charger_currents[chg->max14577->dev_type];\r\nret = maxim_charger_calc_reg_current(limits, uamp, uamp, &reg_data);\r\nif (ret) {\r\ndev_err(chg->dev, "Wrong value for fast charge: %u\n", uamp);\r\nreturn ret;\r\n}\r\nreturn max14577_update_reg(chg->max14577->regmap,\r\nMAX14577_CHG_REG_CHG_CTRL4,\r\nCHGCTRL4_MBCICHWRCL_MASK | CHGCTRL4_MBCICHWRCH_MASK,\r\nreg_data);\r\n}\r\nstatic int max14577_charger_reg_init(struct max14577_charger *chg)\r\n{\r\nstruct regmap *rmap = chg->max14577->regmap;\r\nu8 reg_data;\r\nint ret;\r\nreg_data = 0x1 << CDETCTRL1_CHGDETEN_SHIFT;\r\nmax14577_update_reg(rmap, MAX14577_REG_CDETCTRL1,\r\nCDETCTRL1_CHGDETEN_MASK | CDETCTRL1_CHGTYPMAN_MASK,\r\nreg_data);\r\nreg_data = 0x1 << CHGCTRL2_VCHGR_RC_SHIFT;\r\nreg_data |= 0x1 << CHGCTRL2_MBCHOSTEN_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL2, reg_data);\r\nreg_data = 0x0 << CHGCTRL6_AUTOSTOP_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL6, reg_data);\r\nret = max14577_init_constant_voltage(chg, chg->pdata->constant_uvolt);\r\nif (ret)\r\nreturn ret;\r\nret = max14577_init_eoc(chg, chg->pdata->eoc_uamp);\r\nif (ret)\r\nreturn ret;\r\nret = max14577_init_fast_charge(chg, chg->pdata->fast_charge_uamp);\r\nif (ret)\r\nreturn ret;\r\nret = max14577_set_fast_charge_timer(chg,\r\nMAXIM_CHARGER_FAST_CHARGE_TIMER_DEFAULT);\r\nif (ret)\r\nreturn ret;\r\nswitch (chg->pdata->ovp_uvolt) {\r\ncase 7500000:\r\nreg_data = 0x0;\r\nbreak;\r\ncase 6000000:\r\ncase 6500000:\r\ncase 7000000:\r\nreg_data = 0x1 + (chg->pdata->ovp_uvolt - 6000000) / 500000;\r\nbreak;\r\ndefault:\r\ndev_err(chg->dev, "Wrong value for OVP: %u\n",\r\nchg->pdata->ovp_uvolt);\r\nreturn -EINVAL;\r\n}\r\nreg_data <<= CHGCTRL7_OTPCGHCVS_SHIFT;\r\nmax14577_write_reg(rmap, MAX14577_REG_CHGCTRL7, reg_data);\r\nreturn 0;\r\n}\r\nstatic int max14577_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max14577_charger *chg = container_of(psy,\r\nstruct max14577_charger,\r\ncharger);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = max14577_get_charger_state(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nval->intval = max14577_get_charge_type(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = max14577_get_battery_health(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = max14577_get_present(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = max14577_get_online(chg);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nBUILD_BUG_ON(ARRAY_SIZE(model_names) != MAXIM_DEVICE_TYPE_NUM);\r\nval->strval = model_names[chg->max14577->dev_type];\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = manufacturer;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic struct max14577_charger_platform_data *max14577_charger_dt_init(\r\nstruct platform_device *pdev)\r\n{\r\nstruct max14577_charger_platform_data *pdata;\r\nstruct device_node *np = pdev->dev.of_node;\r\nint ret;\r\nif (!np) {\r\ndev_err(&pdev->dev, "No charger OF node\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = of_property_read_u32(np, "maxim,constant-uvolt",\r\n&pdata->constant_uvolt);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Cannot parse maxim,constant-uvolt field from DT\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nret = of_property_read_u32(np, "maxim,fast-charge-uamp",\r\n&pdata->fast_charge_uamp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Cannot parse maxim,fast-charge-uamp field from DT\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nret = of_property_read_u32(np, "maxim,eoc-uamp", &pdata->eoc_uamp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Cannot parse maxim,eoc-uamp field from DT\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nret = of_property_read_u32(np, "maxim,ovp-uvolt", &pdata->ovp_uvolt);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Cannot parse maxim,ovp-uvolt field from DT\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn pdata;\r\n}\r\nstatic struct max14577_charger_platform_data *max14577_charger_dt_init(\r\nstruct platform_device *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic ssize_t show_fast_charge_timer(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct max14577_charger *chg = dev_get_drvdata(dev);\r\nu8 reg_data;\r\nint ret;\r\nunsigned int val;\r\nret = max14577_read_reg(chg->max14577->regmap, MAX14577_REG_CHGCTRL1,\r\n&reg_data);\r\nif (ret)\r\nreturn ret;\r\nreg_data &= CHGCTRL1_TCHW_MASK;\r\nreg_data >>= CHGCTRL1_TCHW_SHIFT;\r\nswitch (reg_data) {\r\ncase 0x2 ... 0x4:\r\nval = reg_data + 3;\r\nbreak;\r\ncase 0x7:\r\nval = 0;\r\nbreak;\r\ndefault:\r\nval = 5;\r\nbreak;\r\n}\r\nreturn scnprintf(buf, PAGE_SIZE, "%u\n", val);\r\n}\r\nstatic ssize_t store_fast_charge_timer(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct max14577_charger *chg = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint ret;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nret = max14577_set_fast_charge_timer(chg, val);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic int max14577_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct max14577_charger *chg;\r\nstruct max14577 *max14577 = dev_get_drvdata(pdev->dev.parent);\r\nint ret;\r\nchg = devm_kzalloc(&pdev->dev, sizeof(*chg), GFP_KERNEL);\r\nif (!chg)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, chg);\r\nchg->dev = &pdev->dev;\r\nchg->max14577 = max14577;\r\nchg->pdata = max14577_charger_dt_init(pdev);\r\nif (IS_ERR_OR_NULL(chg->pdata))\r\nreturn PTR_ERR(chg->pdata);\r\nret = max14577_charger_reg_init(chg);\r\nif (ret)\r\nreturn ret;\r\nchg->charger.name = "max14577-charger",\r\nchg->charger.type = POWER_SUPPLY_TYPE_BATTERY,\r\nchg->charger.properties = max14577_charger_props,\r\nchg->charger.num_properties = ARRAY_SIZE(max14577_charger_props),\r\nchg->charger.get_property = max14577_charger_get_property,\r\nret = device_create_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: create sysfs entry\n");\r\nreturn ret;\r\n}\r\nret = power_supply_register(&pdev->dev, &chg->charger);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\ngoto err;\r\n}\r\nBUILD_BUG_ON(MAX14577_CHARGER_EOC_CURRENT_LIMIT_MIN +\r\nMAX14577_CHARGER_EOC_CURRENT_LIMIT_STEP * 0xf !=\r\nMAX14577_CHARGER_EOC_CURRENT_LIMIT_MAX);\r\nreturn 0;\r\nerr:\r\ndevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\nreturn ret;\r\n}\r\nstatic int max14577_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct max14577_charger *chg = platform_get_drvdata(pdev);\r\ndevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\npower_supply_unregister(&chg->charger);\r\nreturn 0;\r\n}

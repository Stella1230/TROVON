static noinline void\r\nrtc_write(uint8_t val, uint32_t reg)\r\n{\r\nwriteb(val, ds1511_base + (reg * reg_spacing));\r\n}\r\nstatic inline void\r\nrtc_write_alarm(uint8_t val, enum ds1511reg reg)\r\n{\r\nrtc_write((val | 0x80), reg);\r\n}\r\nstatic noinline uint8_t\r\nrtc_read(enum ds1511reg reg)\r\n{\r\nreturn readb(ds1511_base + (reg * reg_spacing));\r\n}\r\nstatic inline void\r\nrtc_disable_update(void)\r\n{\r\nrtc_write((rtc_read(RTC_CMD) & ~RTC_TE), RTC_CMD);\r\n}\r\nstatic void\r\nrtc_enable_update(void)\r\n{\r\nrtc_write((rtc_read(RTC_CMD) | RTC_TE), RTC_CMD);\r\n}\r\nvoid\r\nds1511_wdog_set(unsigned long deciseconds)\r\n{\r\ndeciseconds %= 10000;\r\nrtc_write(bin2bcd(deciseconds % 100), DS1511_WD_MSEC);\r\nrtc_write(bin2bcd(deciseconds / 100), DS1511_WD_SEC);\r\nrtc_write(DS1511_WDE | DS1511_WDS, RTC_CMD);\r\n}\r\nvoid\r\nds1511_wdog_disable(void)\r\n{\r\nrtc_write(rtc_read(RTC_CMD) & ~(DS1511_WDE | DS1511_WDS), RTC_CMD);\r\nrtc_write(0, DS1511_WD_MSEC);\r\nrtc_write(0, DS1511_WD_SEC);\r\n}\r\nstatic int ds1511_rtc_set_time(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nu8 mon, day, dow, hrs, min, sec, yrs, cen;\r\nunsigned long flags;\r\nif (rtc_tm->tm_year < 1900)\r\nrtc_tm->tm_year += 1900;\r\nif (rtc_tm->tm_year < 1970)\r\nreturn -EINVAL;\r\nyrs = rtc_tm->tm_year % 100;\r\ncen = rtc_tm->tm_year / 100;\r\nmon = rtc_tm->tm_mon + 1;\r\nday = rtc_tm->tm_mday;\r\ndow = rtc_tm->tm_wday & 0x7;\r\nhrs = rtc_tm->tm_hour;\r\nmin = rtc_tm->tm_min;\r\nsec = rtc_tm->tm_sec;\r\nif ((mon > 12) || (day == 0))\r\nreturn -EINVAL;\r\nif (day > rtc_month_days(rtc_tm->tm_mon, rtc_tm->tm_year))\r\nreturn -EINVAL;\r\nif ((hrs >= 24) || (min >= 60) || (sec >= 60))\r\nreturn -EINVAL;\r\nsec = bin2bcd(sec) & 0x7f;\r\nmin = bin2bcd(min) & 0x7f;\r\nhrs = bin2bcd(hrs) & 0x3f;\r\nday = bin2bcd(day) & 0x3f;\r\nmon = bin2bcd(mon) & 0x1f;\r\nyrs = bin2bcd(yrs) & 0xff;\r\ncen = bin2bcd(cen) & 0xff;\r\nspin_lock_irqsave(&ds1511_lock, flags);\r\nrtc_disable_update();\r\nrtc_write(cen, RTC_CENTURY);\r\nrtc_write(yrs, RTC_YEAR);\r\nrtc_write((rtc_read(RTC_MON) & 0xe0) | mon, RTC_MON);\r\nrtc_write(day, RTC_DOM);\r\nrtc_write(hrs, RTC_HOUR);\r\nrtc_write(min, RTC_MIN);\r\nrtc_write(sec, RTC_SEC);\r\nrtc_write(dow, RTC_DOW);\r\nrtc_enable_update();\r\nspin_unlock_irqrestore(&ds1511_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ds1511_rtc_read_time(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nunsigned int century;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ds1511_lock, flags);\r\nrtc_disable_update();\r\nrtc_tm->tm_sec = rtc_read(RTC_SEC) & 0x7f;\r\nrtc_tm->tm_min = rtc_read(RTC_MIN) & 0x7f;\r\nrtc_tm->tm_hour = rtc_read(RTC_HOUR) & 0x3f;\r\nrtc_tm->tm_mday = rtc_read(RTC_DOM) & 0x3f;\r\nrtc_tm->tm_wday = rtc_read(RTC_DOW) & 0x7;\r\nrtc_tm->tm_mon = rtc_read(RTC_MON) & 0x1f;\r\nrtc_tm->tm_year = rtc_read(RTC_YEAR) & 0x7f;\r\ncentury = rtc_read(RTC_CENTURY);\r\nrtc_enable_update();\r\nspin_unlock_irqrestore(&ds1511_lock, flags);\r\nrtc_tm->tm_sec = bcd2bin(rtc_tm->tm_sec);\r\nrtc_tm->tm_min = bcd2bin(rtc_tm->tm_min);\r\nrtc_tm->tm_hour = bcd2bin(rtc_tm->tm_hour);\r\nrtc_tm->tm_mday = bcd2bin(rtc_tm->tm_mday);\r\nrtc_tm->tm_wday = bcd2bin(rtc_tm->tm_wday);\r\nrtc_tm->tm_mon = bcd2bin(rtc_tm->tm_mon);\r\nrtc_tm->tm_year = bcd2bin(rtc_tm->tm_year);\r\ncentury = bcd2bin(century) * 100;\r\ncentury += rtc_tm->tm_year;\r\nrtc_tm->tm_year = century - 1900;\r\nrtc_tm->tm_mon--;\r\nif (rtc_valid_tm(rtc_tm) < 0) {\r\ndev_err(dev, "retrieved date/time is not valid.\n");\r\nrtc_time_to_tm(0, rtc_tm);\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nds1511_rtc_update_alarm(struct rtc_plat_data *pdata)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdata->lock, flags);\r\nrtc_write(pdata->alrm_mday < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_mday) & 0x3f,\r\nRTC_ALARM_DATE);\r\nrtc_write(pdata->alrm_hour < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_hour) & 0x3f,\r\nRTC_ALARM_HOUR);\r\nrtc_write(pdata->alrm_min < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_min) & 0x7f,\r\nRTC_ALARM_MIN);\r\nrtc_write(pdata->alrm_sec < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_sec) & 0x7f,\r\nRTC_ALARM_SEC);\r\nrtc_write(rtc_read(RTC_CMD) | (pdata->irqen ? RTC_TIE : 0), RTC_CMD);\r\nrtc_read(RTC_CMD1);\r\nspin_unlock_irqrestore(&pdata->lock, flags);\r\n}\r\nstatic int\r\nds1511_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\npdata->alrm_mday = alrm->time.tm_mday;\r\npdata->alrm_hour = alrm->time.tm_hour;\r\npdata->alrm_min = alrm->time.tm_min;\r\npdata->alrm_sec = alrm->time.tm_sec;\r\nif (alrm->enabled)\r\npdata->irqen |= RTC_AF;\r\nds1511_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic int\r\nds1511_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nalrm->time.tm_mday = pdata->alrm_mday < 0 ? 0 : pdata->alrm_mday;\r\nalrm->time.tm_hour = pdata->alrm_hour < 0 ? 0 : pdata->alrm_hour;\r\nalrm->time.tm_min = pdata->alrm_min < 0 ? 0 : pdata->alrm_min;\r\nalrm->time.tm_sec = pdata->alrm_sec < 0 ? 0 : pdata->alrm_sec;\r\nalrm->enabled = (pdata->irqen & RTC_AF) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t\r\nds1511_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nunsigned long events = 0;\r\nspin_lock(&pdata->lock);\r\nif (rtc_read(RTC_CMD1) & DS1511_IRQF) {\r\nevents = RTC_IRQF;\r\nif (rtc_read(RTC_ALARM_SEC) & 0x80)\r\nevents |= RTC_UF;\r\nelse\r\nevents |= RTC_AF;\r\nrtc_update_irq(pdata->rtc, 1, events);\r\n}\r\nspin_unlock(&pdata->lock);\r\nreturn events ? IRQ_HANDLED : IRQ_NONE;\r\n}\r\nstatic int ds1511_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nif (enabled)\r\npdata->irqen |= RTC_AF;\r\nelse\r\npdata->irqen &= ~RTC_AF;\r\nds1511_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nds1511_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *ba,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nssize_t count;\r\nif (size > 1)\r\nrtc_write((rtc_read(RTC_CMD) | DS1511_BME), RTC_CMD);\r\nif (pos > DS1511_RAM_MAX)\r\npos = DS1511_RAM_MAX;\r\nif (size + pos > DS1511_RAM_MAX + 1)\r\nsize = DS1511_RAM_MAX - pos + 1;\r\nrtc_write(pos, DS1511_RAMADDR_LSB);\r\nfor (count = 0; size > 0; count++, size--)\r\n*buf++ = rtc_read(DS1511_RAMDATA);\r\nif (count > 1)\r\nrtc_write((rtc_read(RTC_CMD) & ~DS1511_BME), RTC_CMD);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nds1511_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nssize_t count;\r\nif (size > 1)\r\nrtc_write((rtc_read(RTC_CMD) | DS1511_BME), RTC_CMD);\r\nif (pos > DS1511_RAM_MAX)\r\npos = DS1511_RAM_MAX;\r\nif (size + pos > DS1511_RAM_MAX + 1)\r\nsize = DS1511_RAM_MAX - pos + 1;\r\nrtc_write(pos, DS1511_RAMADDR_LSB);\r\nfor (count = 0; size > 0; count++, size--)\r\nrtc_write(*buf++, DS1511_RAMDATA);\r\nif (count > 1)\r\nrtc_write((rtc_read(RTC_CMD) & ~DS1511_BME), RTC_CMD);\r\nreturn count;\r\n}\r\nstatic int ds1511_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct rtc_plat_data *pdata;\r\nint ret = 0;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nds1511_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ds1511_base))\r\nreturn PTR_ERR(ds1511_base);\r\npdata->ioaddr = ds1511_base;\r\npdata->irq = platform_get_irq(pdev, 0);\r\nrtc_write(0, RTC_CMD);\r\nrtc_write(0, RTC_CMD1);\r\nrtc_write(0, DS1511_WD_MSEC);\r\nrtc_write(0, DS1511_WD_SEC);\r\nrtc_enable_update();\r\nif (rtc_read(RTC_CMD1) & DS1511_BLF1)\r\ndev_warn(&pdev->dev, "voltage-low detected.\n");\r\nspin_lock_init(&pdata->lock);\r\nplatform_set_drvdata(pdev, pdata);\r\npdata->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&ds1511_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(pdata->rtc))\r\nreturn PTR_ERR(pdata->rtc);\r\nif (pdata->irq > 0) {\r\nrtc_read(RTC_CMD1);\r\nif (devm_request_irq(&pdev->dev, pdata->irq, ds1511_interrupt,\r\nIRQF_SHARED, pdev->name, pdev) < 0) {\r\ndev_warn(&pdev->dev, "interrupt not available.\n");\r\npdata->irq = 0;\r\n}\r\n}\r\nret = sysfs_create_bin_file(&pdev->dev.kobj, &ds1511_nvram_attr);\r\nif (ret)\r\ndev_err(&pdev->dev, "Unable to create sysfs entry: %s\n",\r\nds1511_nvram_attr.attr.name);\r\nreturn 0;\r\n}\r\nstatic int ds1511_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nsysfs_remove_bin_file(&pdev->dev.kobj, &ds1511_nvram_attr);\r\nif (pdata->irq > 0) {\r\nrtc_write(rtc_read(RTC_CMD) & ~RTC_TIE, RTC_CMD);\r\nrtc_read(RTC_CMD1);\r\n}\r\nreturn 0;\r\n}

static inline struct m52790_state *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct m52790_state, sd);\r\n}\r\nstatic int m52790_write(struct v4l2_subdev *sd)\r\n{\r\nstruct m52790_state *state = to_state(sd);\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nu8 sw1 = (state->input | state->output) & 0xff;\r\nu8 sw2 = (state->input | state->output) >> 8;\r\nreturn i2c_smbus_write_byte_data(client, sw1, sw2);\r\n}\r\nstatic int m52790_s_routing(struct v4l2_subdev *sd,\r\nu32 input, u32 output, u32 config)\r\n{\r\nstruct m52790_state *state = to_state(sd);\r\nstate->input = input;\r\nstate->output = output;\r\nm52790_write(sd);\r\nreturn 0;\r\n}\r\nstatic int m52790_g_register(struct v4l2_subdev *sd, struct v4l2_dbg_register *reg)\r\n{\r\nstruct m52790_state *state = to_state(sd);\r\nif (reg->reg != 0)\r\nreturn -EINVAL;\r\nreg->size = 1;\r\nreg->val = state->input | state->output;\r\nreturn 0;\r\n}\r\nstatic int m52790_s_register(struct v4l2_subdev *sd, const struct v4l2_dbg_register *reg)\r\n{\r\nstruct m52790_state *state = to_state(sd);\r\nif (reg->reg != 0)\r\nreturn -EINVAL;\r\nstate->input = reg->val & 0x0303;\r\nstate->output = reg->val & ~0x0303;\r\nm52790_write(sd);\r\nreturn 0;\r\n}\r\nstatic int m52790_log_status(struct v4l2_subdev *sd)\r\n{\r\nstruct m52790_state *state = to_state(sd);\r\nv4l2_info(sd, "Switch 1: %02x\n",\r\n(state->input | state->output) & 0xff);\r\nv4l2_info(sd, "Switch 2: %02x\n",\r\n(state->input | state->output) >> 8);\r\nreturn 0;\r\n}\r\nstatic int m52790_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct m52790_state *state;\r\nstruct v4l2_subdev *sd;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\nv4l_info(client, "chip found @ 0x%x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nstate = devm_kzalloc(&client->dev, sizeof(*state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn -ENOMEM;\r\nsd = &state->sd;\r\nv4l2_i2c_subdev_init(sd, client, &m52790_ops);\r\nstate->input = M52790_IN_TUNER;\r\nstate->output = M52790_OUT_STEREO;\r\nm52790_write(sd);\r\nreturn 0;\r\n}\r\nstatic int m52790_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nv4l2_device_unregister_subdev(sd);\r\nreturn 0;\r\n}

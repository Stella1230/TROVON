static int nfs_superblock_set_dummy_root(struct super_block *sb, struct inode *inode)\r\n{\r\nif (sb->s_root == NULL) {\r\nsb->s_root = d_make_root(inode);\r\nif (sb->s_root == NULL)\r\nreturn -ENOMEM;\r\nihold(inode);\r\nspin_lock(&sb->s_root->d_inode->i_lock);\r\nspin_lock(&sb->s_root->d_lock);\r\nhlist_del_init(&sb->s_root->d_u.d_alias);\r\nspin_unlock(&sb->s_root->d_lock);\r\nspin_unlock(&sb->s_root->d_inode->i_lock);\r\n}\r\nreturn 0;\r\n}\r\nstruct dentry *nfs_get_root(struct super_block *sb, struct nfs_fh *mntfh,\r\nconst char *devname)\r\n{\r\nstruct nfs_server *server = NFS_SB(sb);\r\nstruct nfs_fsinfo fsinfo;\r\nstruct dentry *ret;\r\nstruct inode *inode;\r\nvoid *name = kstrdup(devname, GFP_KERNEL);\r\nint error;\r\nif (!name)\r\nreturn ERR_PTR(-ENOMEM);\r\nfsinfo.fattr = nfs_alloc_fattr();\r\nif (fsinfo.fattr == NULL) {\r\nkfree(name);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nerror = server->nfs_client->rpc_ops->getroot(server, mntfh, &fsinfo);\r\nif (error < 0) {\r\ndprintk("nfs_get_root: getattr error = %d\n", -error);\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\ninode = nfs_fhget(sb, mntfh, fsinfo.fattr, NULL);\r\nif (IS_ERR(inode)) {\r\ndprintk("nfs_get_root: get root inode failed\n");\r\nret = ERR_CAST(inode);\r\ngoto out;\r\n}\r\nerror = nfs_superblock_set_dummy_root(sb, inode);\r\nif (error != 0) {\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\nret = d_obtain_root(inode);\r\nif (IS_ERR(ret)) {\r\ndprintk("nfs_get_root: get root dentry failed\n");\r\ngoto out;\r\n}\r\nsecurity_d_instantiate(ret, inode);\r\nspin_lock(&ret->d_lock);\r\nif (IS_ROOT(ret) && !ret->d_fsdata &&\r\n!(ret->d_flags & DCACHE_NFSFS_RENAMED)) {\r\nret->d_fsdata = name;\r\nname = NULL;\r\n}\r\nspin_unlock(&ret->d_lock);\r\nout:\r\nkfree(name);\r\nnfs_free_fattr(fsinfo.fattr);\r\nreturn ret;\r\n}

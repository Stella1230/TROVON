static int twl4030_write_script_byte(u8 address, u8 byte)\r\n{\r\nint err;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, address, R_MEMORY_ADDRESS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, byte, R_MEMORY_DATA);\r\nout:\r\nreturn err;\r\n}\r\nstatic int twl4030_write_script_ins(u8 address, u16 pmb_message,\r\nu8 delay, u8 next)\r\n{\r\nint err;\r\naddress *= 4;\r\nerr = twl4030_write_script_byte(address++, pmb_message >> 8);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, pmb_message & 0xff);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, delay);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, next);\r\nout:\r\nreturn err;\r\n}\r\nstatic int twl4030_write_script(u8 address, struct twl4030_ins *script,\r\nint len)\r\n{\r\nint err = -EINVAL;\r\nfor (; len; len--, address++, script++) {\r\nif (len == 1) {\r\nerr = twl4030_write_script_ins(address,\r\nscript->pmb_message,\r\nscript->delay,\r\nEND_OF_SCRIPT);\r\nif (err)\r\nbreak;\r\n} else {\r\nerr = twl4030_write_script_ins(address,\r\nscript->pmb_message,\r\nscript->delay,\r\naddress + 1);\r\nif (err)\r\nbreak;\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int twl4030_config_wakeup3_sequence(u8 address)\r\n{\r\nint err;\r\nu8 data;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, address, R_SEQ_ADD_S2A3);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &data, R_P3_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= PWR_LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, data, R_P3_SW_EVENTS);\r\nout:\r\nif (err)\r\npr_err("TWL4030 wakeup sequence for P3 config error\n");\r\nreturn err;\r\n}\r\nstatic int twl4030_config_wakeup12_sequence(u8 address)\r\n{\r\nint err = 0;\r\nu8 data;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, address, R_SEQ_ADD_S2A12);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &data, R_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= PWR_LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, data, R_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &data, R_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= PWR_LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, data, R_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nif (machine_is_omap_3430sdp() || machine_is_omap_ldp()) {\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &data,\r\nR_CFG_P1_TRANSITION);\r\nif (err)\r\ngoto out;\r\ndata &= ~(1<<1);\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, data,\r\nR_CFG_P1_TRANSITION);\r\nif (err)\r\ngoto out;\r\n}\r\nout:\r\nif (err)\r\npr_err("TWL4030 wakeup sequence for P1 and P2" \\r\n"config error\n");\r\nreturn err;\r\n}\r\nstatic int twl4030_config_sleep_sequence(u8 address)\r\n{\r\nint err;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, address, R_SEQ_ADD_A2S);\r\nif (err)\r\npr_err("TWL4030 sleep sequence config error\n");\r\nreturn err;\r\n}\r\nstatic int twl4030_config_warmreset_sequence(u8 address)\r\n{\r\nint err;\r\nu8 rd_data;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, address, R_SEQ_ADD_WARM);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &rd_data, R_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= PWR_ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, rd_data, R_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &rd_data, R_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= PWR_ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, rd_data, R_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &rd_data, R_P3_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= PWR_ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, rd_data, R_P3_SW_EVENTS);\r\nout:\r\nif (err)\r\npr_err("TWL4030 warmreset seq config error\n");\r\nreturn err;\r\n}\r\nstatic int twl4030_configure_resource(struct twl4030_resconfig *rconfig)\r\n{\r\nint rconfig_addr;\r\nint err;\r\nu8 type;\r\nu8 grp;\r\nu8 remap;\r\nif (rconfig->resource > TOTAL_RESOURCES) {\r\npr_err("TWL4030 Resource %d does not exist\n",\r\nrconfig->resource);\r\nreturn -EINVAL;\r\n}\r\nrconfig_addr = res_config_addrs[rconfig->resource];\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_RECEIVER, &grp,\r\nrconfig_addr + DEV_GRP_OFFSET);\r\nif (err) {\r\npr_err("TWL4030 Resource %d group could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->devgroup != TWL4030_RESCONFIG_UNDEF) {\r\ngrp &= ~DEV_GRP_MASK;\r\ngrp |= rconfig->devgroup << DEV_GRP_SHIFT;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER,\r\ngrp, rconfig_addr + DEV_GRP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program devgroup\n");\r\nreturn err;\r\n}\r\n}\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_RECEIVER, &type,\r\nrconfig_addr + TYPE_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 Resource %d type could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->type != TWL4030_RESCONFIG_UNDEF) {\r\ntype &= ~TYPE_MASK;\r\ntype |= rconfig->type << TYPE_SHIFT;\r\n}\r\nif (rconfig->type2 != TWL4030_RESCONFIG_UNDEF) {\r\ntype &= ~TYPE2_MASK;\r\ntype |= rconfig->type2 << TYPE2_SHIFT;\r\n}\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER,\r\ntype, rconfig_addr + TYPE_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program resource type\n");\r\nreturn err;\r\n}\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_RECEIVER, &remap,\r\nrconfig_addr + REMAP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 Resource %d remap could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->remap_off != TWL4030_RESCONFIG_UNDEF) {\r\nremap &= ~OFF_STATE_MASK;\r\nremap |= rconfig->remap_off << OFF_STATE_SHIFT;\r\n}\r\nif (rconfig->remap_sleep != TWL4030_RESCONFIG_UNDEF) {\r\nremap &= ~SLEEP_STATE_MASK;\r\nremap |= rconfig->remap_sleep << SLEEP_STATE_SHIFT;\r\n}\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER,\r\nremap,\r\nrconfig_addr + REMAP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program remap\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int load_twl4030_script(struct twl4030_script *tscript,\r\nu8 address)\r\n{\r\nint err;\r\nstatic int order;\r\nif ((address + tscript->size) > END_OF_SCRIPT) {\r\npr_err("TWL4030 scripts too big error\n");\r\nreturn -EINVAL;\r\n}\r\nerr = twl4030_write_script(address, tscript->script, tscript->size);\r\nif (err)\r\ngoto out;\r\nif (tscript->flags & TWL4030_WRST_SCRIPT) {\r\nerr = twl4030_config_warmreset_sequence(address);\r\nif (err)\r\ngoto out;\r\n}\r\nif (tscript->flags & TWL4030_WAKEUP12_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_A2S);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_config_wakeup12_sequence(address);\r\nif (err)\r\ngoto out;\r\norder = 1;\r\n}\r\nif (tscript->flags & TWL4030_WAKEUP3_SCRIPT) {\r\nerr = twl4030_config_wakeup3_sequence(address);\r\nif (err)\r\ngoto out;\r\n}\r\nif (tscript->flags & TWL4030_SLEEP_SCRIPT) {\r\nif (!order)\r\npr_warning("TWL4030: Bad order of scripts (sleep "\\r\n"script before wakeup) Leads to boot"\\r\n"failure on some boards\n");\r\nerr = twl4030_config_sleep_sequence(address);\r\n}\r\nout:\r\nreturn err;\r\n}\r\nint twl4030_remove_script(u8 flags)\r\n{\r\nint err = 0;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, TWL4030_PM_MASTER_KEY_CFG1,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err) {\r\npr_err("twl4030: unable to unlock PROTECT_KEY\n");\r\nreturn err;\r\n}\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, TWL4030_PM_MASTER_KEY_CFG2,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err) {\r\npr_err("twl4030: unable to unlock PROTECT_KEY\n");\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WRST_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_WARM);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WAKEUP12_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_S2A12);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WAKEUP3_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_S2A3);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_SLEEP_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_A2S);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, 0,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\npr_err("TWL4030 Unable to relock registers\n");\r\nreturn err;\r\n}\r\nstatic int\r\ntwl4030_power_configure_scripts(const struct twl4030_power_data *pdata)\r\n{\r\nint err;\r\nint i;\r\nu8 address = twl4030_start_script_address;\r\nfor (i = 0; i < pdata->num; i++) {\r\nerr = load_twl4030_script(pdata->scripts[i], address);\r\nif (err)\r\nreturn err;\r\naddress += pdata->scripts[i]->size;\r\n}\r\nreturn 0;\r\n}\r\nstatic void twl4030_patch_rconfig(struct twl4030_resconfig *common,\r\nstruct twl4030_resconfig *board)\r\n{\r\nwhile (common->resource) {\r\nstruct twl4030_resconfig *b = board;\r\nwhile (b->resource) {\r\nif (b->resource == common->resource) {\r\n*common = *b;\r\nbreak;\r\n}\r\nb++;\r\n}\r\ncommon++;\r\n}\r\n}\r\nstatic int\r\ntwl4030_power_configure_resources(const struct twl4030_power_data *pdata)\r\n{\r\nstruct twl4030_resconfig *resconfig = pdata->resource_config;\r\nstruct twl4030_resconfig *boardconf = pdata->board_config;\r\nint err;\r\nif (resconfig) {\r\nif (boardconf)\r\ntwl4030_patch_rconfig(resconfig, boardconf);\r\nwhile (resconfig->resource) {\r\nerr = twl4030_configure_resource(resconfig);\r\nif (err)\r\nreturn err;\r\nresconfig++;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int twl4030_starton_mask_and_set(u8 bitmask, u8 bitvalues)\r\n{\r\nu8 regs[3] = { TWL4030_PM_MASTER_CFG_P1_TRANSITION,\r\nTWL4030_PM_MASTER_CFG_P2_TRANSITION,\r\nTWL4030_PM_MASTER_CFG_P3_TRANSITION, };\r\nu8 val;\r\nint i, err;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, TWL4030_PM_MASTER_KEY_CFG1,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\ngoto relock;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG2,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\ngoto relock;\r\nfor (i = 0; i < sizeof(regs); i++) {\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER,\r\n&val, regs[i]);\r\nif (err)\r\nbreak;\r\nval = (~bitmask & val) | (bitmask & bitvalues);\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER,\r\nval, regs[i]);\r\nif (err)\r\nbreak;\r\n}\r\nif (err)\r\npr_err("TWL4030 Register access failed: %i\n", err);\r\nrelock:\r\nreturn twl_i2c_write_u8(TWL_MODULE_PM_MASTER, 0,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\n}\r\nvoid twl4030_power_off(void)\r\n{\r\nint err;\r\nerr = twl4030_starton_mask_and_set(STARTON_VBUS | STARTON_CHG, 0);\r\nif (err)\r\npr_err("TWL4030 Unable to configure start-up\n");\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, PWR_DEVOFF,\r\nTWL4030_PM_MASTER_P1_SW_EVENTS);\r\nif (err)\r\npr_err("TWL4030 Unable to power off\n");\r\n}\r\nstatic bool twl4030_power_use_poweroff(const struct twl4030_power_data *pdata,\r\nstruct device_node *node)\r\n{\r\nif (pdata && pdata->use_poweroff)\r\nreturn true;\r\nif (of_property_read_bool(node, "ti,system-power-controller"))\r\nreturn true;\r\nif (of_property_read_bool(node, "ti,use_poweroff"))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int twl4030_power_probe(struct platform_device *pdev)\r\n{\r\nconst struct twl4030_power_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct device_node *node = pdev->dev.of_node;\r\nconst struct of_device_id *match;\r\nint err = 0;\r\nint err2 = 0;\r\nu8 val;\r\nif (!pdata && !node) {\r\ndev_err(&pdev->dev, "Platform data is missing\n");\r\nreturn -EINVAL;\r\n}\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, TWL4030_PM_MASTER_KEY_CFG1,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nerr |= twl_i2c_write_u8(TWL_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG2,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err) {\r\npr_err("TWL4030 Unable to unlock registers\n");\r\nreturn err;\r\n}\r\nmatch = of_match_device(of_match_ptr(twl4030_power_of_match),\r\n&pdev->dev);\r\nif (match && match->data)\r\npdata = match->data;\r\nif (pdata) {\r\nerr = twl4030_power_configure_scripts(pdata);\r\nif (err) {\r\npr_err("TWL4030 failed to load scripts\n");\r\ngoto relock;\r\n}\r\nerr = twl4030_power_configure_resources(pdata);\r\nif (err) {\r\npr_err("TWL4030 failed to configure resource\n");\r\ngoto relock;\r\n}\r\n}\r\nif (twl4030_power_use_poweroff(pdata, node) && !pm_power_off) {\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &val,\r\nTWL4030_PM_MASTER_CFG_P123_TRANSITION);\r\nif (err) {\r\npr_warning("TWL4030 Unable to read registers\n");\r\n} else if (!(val & SEQ_OFFSYNC)) {\r\nval |= SEQ_OFFSYNC;\r\nerr = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, val,\r\nTWL4030_PM_MASTER_CFG_P123_TRANSITION);\r\nif (err) {\r\npr_err("TWL4030 Unable to setup SEQ_OFFSYNC\n");\r\ngoto relock;\r\n}\r\n}\r\npm_power_off = twl4030_power_off;\r\n}\r\nrelock:\r\nerr2 = twl_i2c_write_u8(TWL_MODULE_PM_MASTER, 0,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err2) {\r\npr_err("TWL4030 Unable to relock registers\n");\r\nreturn err2;\r\n}\r\nreturn err;\r\n}\r\nstatic int twl4030_power_remove(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}

static int smart_enable(ide_drive_t *drive)\r\n{\r\nstruct ide_cmd cmd;\r\nstruct ide_taskfile *tf = &cmd.tf;\r\nmemset(&cmd, 0, sizeof(cmd));\r\ntf->feature = ATA_SMART_ENABLE;\r\ntf->lbam = ATA_SMART_LBAM_PASS;\r\ntf->lbah = ATA_SMART_LBAH_PASS;\r\ntf->command = ATA_CMD_SMART;\r\ncmd.valid.out.tf = IDE_VALID_OUT_TF | IDE_VALID_DEVICE;\r\ncmd.valid.in.tf = IDE_VALID_IN_TF | IDE_VALID_DEVICE;\r\nreturn ide_no_data_taskfile(drive, &cmd);\r\n}\r\nstatic int get_smart_data(ide_drive_t *drive, u8 *buf, u8 sub_cmd)\r\n{\r\nstruct ide_cmd cmd;\r\nstruct ide_taskfile *tf = &cmd.tf;\r\nmemset(&cmd, 0, sizeof(cmd));\r\ntf->feature = sub_cmd;\r\ntf->nsect = 0x01;\r\ntf->lbam = ATA_SMART_LBAM_PASS;\r\ntf->lbah = ATA_SMART_LBAH_PASS;\r\ntf->command = ATA_CMD_SMART;\r\ncmd.valid.out.tf = IDE_VALID_OUT_TF | IDE_VALID_DEVICE;\r\ncmd.valid.in.tf = IDE_VALID_IN_TF | IDE_VALID_DEVICE;\r\ncmd.protocol = ATA_PROT_PIO;\r\nreturn ide_raw_taskfile(drive, &cmd, buf, 1);\r\n}\r\nstatic int idedisk_cache_proc_show(struct seq_file *m, void *v)\r\n{\r\nide_drive_t *drive = (ide_drive_t *) m->private;\r\nif (drive->dev_flags & IDE_DFLAG_ID_READ)\r\nseq_printf(m, "%i\n", drive->id[ATA_ID_BUF_SIZE] / 2);\r\nelse\r\nseq_printf(m, "(none)\n");\r\nreturn 0;\r\n}\r\nstatic int idedisk_cache_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, idedisk_cache_proc_show, PDE_DATA(inode));\r\n}\r\nstatic int idedisk_capacity_proc_show(struct seq_file *m, void *v)\r\n{\r\nide_drive_t*drive = (ide_drive_t *)m->private;\r\nseq_printf(m, "%llu\n", (long long)ide_gd_capacity(drive));\r\nreturn 0;\r\n}\r\nstatic int idedisk_capacity_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, idedisk_capacity_proc_show, PDE_DATA(inode));\r\n}\r\nstatic int __idedisk_proc_show(struct seq_file *m, ide_drive_t *drive, u8 sub_cmd)\r\n{\r\nu8 *buf;\r\nbuf = kmalloc(SECTOR_SIZE, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\n(void)smart_enable(drive);\r\nif (get_smart_data(drive, buf, sub_cmd) == 0) {\r\n__le16 *val = (__le16 *)buf;\r\nint i;\r\nfor (i = 0; i < SECTOR_SIZE / 2; i++) {\r\nseq_printf(m, "%04x%c", le16_to_cpu(val[i]),\r\n(i % 8) == 7 ? '\n' : ' ');\r\n}\r\n}\r\nkfree(buf);\r\nreturn 0;\r\n}\r\nstatic int idedisk_sv_proc_show(struct seq_file *m, void *v)\r\n{\r\nreturn __idedisk_proc_show(m, m->private, ATA_SMART_READ_VALUES);\r\n}\r\nstatic int idedisk_sv_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, idedisk_sv_proc_show, PDE_DATA(inode));\r\n}\r\nstatic int idedisk_st_proc_show(struct seq_file *m, void *v)\r\n{\r\nreturn __idedisk_proc_show(m, m->private, ATA_SMART_READ_THRESHOLDS);\r\n}\r\nstatic int idedisk_st_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, idedisk_st_proc_show, PDE_DATA(inode));\r\n}

static int m5mols_read_rational(struct v4l2_subdev *sd, u32 addr_num,\r\nu32 addr_den, u32 *val)\r\n{\r\nu32 num, den;\r\nint ret = m5mols_read_u32(sd, addr_num, &num);\r\nif (!ret)\r\nret = m5mols_read_u32(sd, addr_den, &den);\r\nif (ret)\r\nreturn ret;\r\n*val = den == 0 ? 0 : num / den;\r\nreturn ret;\r\n}\r\nstatic int m5mols_capture_info(struct m5mols_info *info)\r\n{\r\nstruct m5mols_exif *exif = &info->cap.exif;\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_EXPTIME_NU,\r\nEXIF_INFO_EXPTIME_DE, &exif->exposure_time);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_TV_NU, EXIF_INFO_TV_DE,\r\n&exif->shutter_speed);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_AV_NU, EXIF_INFO_AV_DE,\r\n&exif->aperture);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_BV_NU, EXIF_INFO_BV_DE,\r\n&exif->brightness);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_EBV_NU, EXIF_INFO_EBV_DE,\r\n&exif->exposure_bias);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_u16(sd, EXIF_INFO_ISO, &exif->iso_speed);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_FLASH, &exif->flash);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_SDR, &exif->sdr);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_QVAL, &exif->qval);\r\nif (ret)\r\nreturn ret;\r\nif (!ret)\r\nret = m5mols_read_u32(sd, CAPC_IMAGE_SIZE, &info->cap.main);\r\nif (!ret)\r\nret = m5mols_read_u32(sd, CAPC_THUMB_SIZE, &info->cap.thumb);\r\nif (!ret)\r\ninfo->cap.total = info->cap.main + info->cap.thumb;\r\nreturn ret;\r\n}\r\nint m5mols_start_capture(struct m5mols_info *info)\r\n{\r\nunsigned int framesize = info->cap.buf_size - M5MOLS_JPEG_TAGS_SIZE;\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret;\r\nret = m5mols_set_mode(info, REG_MONITOR);\r\nif (!ret)\r\nret = m5mols_restore_controls(info);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_YUVOUT_MAIN, REG_JPEG);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_MAIN_IMAGE_SIZE, info->resolution);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_JPEG_SIZE_MAX, framesize);\r\nif (!ret)\r\nret = m5mols_set_mode(info, REG_CAPTURE);\r\nif (!ret)\r\nret = m5mols_wait_interrupt(sd, REG_INT_CAPTURE, 2000);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_write(sd, CAPC_SEL_FRAME, 1);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPC_START, REG_CAP_START_MAIN);\r\nif (!ret) {\r\nbool captured = false;\r\nunsigned int size;\r\nret = m5mols_wait_interrupt(sd, REG_INT_CAPTURE, 2000);\r\nif (!ret) {\r\ncaptured = true;\r\nret = m5mols_capture_info(info);\r\n}\r\nsize = captured ? info->cap.main : 0;\r\nv4l2_dbg(1, m5mols_debug, sd, "%s: size: %d, thumb.: %d B\n",\r\n__func__, size, info->cap.thumb);\r\nv4l2_subdev_notify(sd, S5P_FIMC_TX_END_NOTIFY, &size);\r\n}\r\nreturn ret;\r\n}

int gma_blt_wait_idle(struct drm_psb_private *dev_priv)\r\n{\r\nunsigned long stop = jiffies + HZ;\r\nint busy = 1;\r\nif (IS_CDV(dev_priv->dev))\r\nreturn 0;\r\nif ((PSB_RSGX32(PSB_CR_2D_SOCIF) == _PSB_C2_SOCIF_EMPTY) &&\r\n((PSB_RSGX32(PSB_CR_2D_BLIT_STATUS) & _PSB_C2B_STATUS_BUSY) == 0))\r\nreturn 0;\r\ndo {\r\nbusy = (PSB_RSGX32(PSB_CR_2D_SOCIF) != _PSB_C2_SOCIF_EMPTY);\r\n} while (busy && !time_after_eq(jiffies, stop));\r\nif (busy)\r\nreturn -EBUSY;\r\ndo {\r\nbusy = ((PSB_RSGX32(PSB_CR_2D_BLIT_STATUS) &\r\n_PSB_C2B_STATUS_BUSY) != 0);\r\n} while (busy && !time_after_eq(jiffies, stop));\r\nreturn (busy) ? -EBUSY : 0;\r\n}

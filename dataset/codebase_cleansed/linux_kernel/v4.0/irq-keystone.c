static inline u32 keystone_irq_readl(struct keystone_irq_device *kirq)\r\n{\r\nint ret;\r\nu32 val = 0;\r\nret = regmap_read(kirq->devctrl_regs, kirq->devctrl_offset, &val);\r\nif (ret < 0)\r\ndev_dbg(kirq->dev, "irq read failed ret(%d)\n", ret);\r\nreturn val;\r\n}\r\nstatic inline void\r\nkeystone_irq_writel(struct keystone_irq_device *kirq, u32 value)\r\n{\r\nint ret;\r\nret = regmap_write(kirq->devctrl_regs, kirq->devctrl_offset, value);\r\nif (ret < 0)\r\ndev_dbg(kirq->dev, "irq write failed ret(%d)\n", ret);\r\n}\r\nstatic void keystone_irq_setmask(struct irq_data *d)\r\n{\r\nstruct keystone_irq_device *kirq = irq_data_get_irq_chip_data(d);\r\nkirq->mask |= BIT(d->hwirq);\r\ndev_dbg(kirq->dev, "mask %lu [%x]\n", d->hwirq, kirq->mask);\r\n}\r\nstatic void keystone_irq_unmask(struct irq_data *d)\r\n{\r\nstruct keystone_irq_device *kirq = irq_data_get_irq_chip_data(d);\r\nkirq->mask &= ~BIT(d->hwirq);\r\ndev_dbg(kirq->dev, "unmask %lu [%x]\n", d->hwirq, kirq->mask);\r\n}\r\nstatic void keystone_irq_ack(struct irq_data *d)\r\n{\r\n}\r\nstatic void keystone_irq_handler(unsigned irq, struct irq_desc *desc)\r\n{\r\nstruct keystone_irq_device *kirq = irq_desc_get_handler_data(desc);\r\nunsigned long pending;\r\nint src, virq;\r\ndev_dbg(kirq->dev, "start irq %d\n", irq);\r\nchained_irq_enter(irq_desc_get_chip(desc), desc);\r\npending = keystone_irq_readl(kirq);\r\nkeystone_irq_writel(kirq, pending);\r\ndev_dbg(kirq->dev, "pending 0x%lx, mask 0x%x\n", pending, kirq->mask);\r\npending = (pending >> BIT_OFS) & ~kirq->mask;\r\ndev_dbg(kirq->dev, "pending after mask 0x%lx\n", pending);\r\nfor (src = 0; src < KEYSTONE_N_IRQ; src++) {\r\nif (BIT(src) & pending) {\r\nvirq = irq_find_mapping(kirq->irqd, src);\r\ndev_dbg(kirq->dev, "dispatch bit %d, virq %d\n",\r\nsrc, virq);\r\nif (!virq)\r\ndev_warn(kirq->dev, "sporious irq detected hwirq %d, virq %d\n",\r\nsrc, virq);\r\ngeneric_handle_irq(virq);\r\n}\r\n}\r\nchained_irq_exit(irq_desc_get_chip(desc), desc);\r\ndev_dbg(kirq->dev, "end irq %d\n", irq);\r\n}\r\nstatic int keystone_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct keystone_irq_device *kirq = h->host_data;\r\nirq_set_chip_data(virq, kirq);\r\nirq_set_chip_and_handler(virq, &kirq->chip, handle_level_irq);\r\nset_irq_flags(virq, IRQF_VALID | IRQF_PROBE);\r\nreturn 0;\r\n}\r\nstatic int keystone_irq_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct keystone_irq_device *kirq;\r\nint ret;\r\nif (np == NULL)\r\nreturn -EINVAL;\r\nkirq = devm_kzalloc(dev, sizeof(*kirq), GFP_KERNEL);\r\nif (!kirq)\r\nreturn -ENOMEM;\r\nkirq->devctrl_regs =\r\nsyscon_regmap_lookup_by_phandle(np, "ti,syscon-dev");\r\nif (IS_ERR(kirq->devctrl_regs))\r\nreturn PTR_ERR(kirq->devctrl_regs);\r\nret = of_property_read_u32_index(np, "ti,syscon-dev", 1,\r\n&kirq->devctrl_offset);\r\nif (ret) {\r\ndev_err(dev, "couldn't read the devctrl_offset offset!\n");\r\nreturn ret;\r\n}\r\nkirq->irq = platform_get_irq(pdev, 0);\r\nif (kirq->irq < 0) {\r\ndev_err(dev, "no irq resource %d\n", kirq->irq);\r\nreturn kirq->irq;\r\n}\r\nkirq->dev = dev;\r\nkirq->mask = ~0x0;\r\nkirq->chip.name = "keystone-irq";\r\nkirq->chip.irq_ack = keystone_irq_ack;\r\nkirq->chip.irq_mask = keystone_irq_setmask;\r\nkirq->chip.irq_unmask = keystone_irq_unmask;\r\nkirq->irqd = irq_domain_add_linear(np, KEYSTONE_N_IRQ,\r\n&keystone_irq_ops, kirq);\r\nif (!kirq->irqd) {\r\ndev_err(dev, "IRQ domain registration failed\n");\r\nreturn -ENODEV;\r\n}\r\nplatform_set_drvdata(pdev, kirq);\r\nirq_set_chained_handler(kirq->irq, keystone_irq_handler);\r\nirq_set_handler_data(kirq->irq, kirq);\r\nkeystone_irq_writel(kirq, ~0x0);\r\ndev_info(dev, "irqchip registered, nr_irqs %u\n", KEYSTONE_N_IRQ);\r\nreturn 0;\r\n}\r\nstatic int keystone_irq_remove(struct platform_device *pdev)\r\n{\r\nstruct keystone_irq_device *kirq = platform_get_drvdata(pdev);\r\nint hwirq;\r\nfor (hwirq = 0; hwirq < KEYSTONE_N_IRQ; hwirq++)\r\nirq_dispose_mapping(irq_find_mapping(kirq->irqd, hwirq));\r\nirq_domain_remove(kirq->irqd);\r\nreturn 0;\r\n}

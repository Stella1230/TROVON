static inline void fintek_cr_write(struct fintek_dev *fintek, u8 val, u8 reg)\r\n{\r\nfit_dbg("%s: reg 0x%02x, val 0x%02x (ip/dp: %02x/%02x)",\r\n__func__, reg, val, fintek->cr_ip, fintek->cr_dp);\r\noutb(reg, fintek->cr_ip);\r\noutb(val, fintek->cr_dp);\r\n}\r\nstatic inline u8 fintek_cr_read(struct fintek_dev *fintek, u8 reg)\r\n{\r\nu8 val;\r\noutb(reg, fintek->cr_ip);\r\nval = inb(fintek->cr_dp);\r\nfit_dbg("%s: reg 0x%02x, val 0x%02x (ip/dp: %02x/%02x)",\r\n__func__, reg, val, fintek->cr_ip, fintek->cr_dp);\r\nreturn val;\r\n}\r\nstatic inline void fintek_set_reg_bit(struct fintek_dev *fintek, u8 val, u8 reg)\r\n{\r\nu8 tmp = fintek_cr_read(fintek, reg) | val;\r\nfintek_cr_write(fintek, tmp, reg);\r\n}\r\nstatic inline void fintek_clear_reg_bit(struct fintek_dev *fintek, u8 val, u8 reg)\r\n{\r\nu8 tmp = fintek_cr_read(fintek, reg) & ~val;\r\nfintek_cr_write(fintek, tmp, reg);\r\n}\r\nstatic inline void fintek_config_mode_enable(struct fintek_dev *fintek)\r\n{\r\noutb(CONFIG_REG_ENABLE, fintek->cr_ip);\r\noutb(CONFIG_REG_ENABLE, fintek->cr_ip);\r\n}\r\nstatic inline void fintek_config_mode_disable(struct fintek_dev *fintek)\r\n{\r\noutb(CONFIG_REG_DISABLE, fintek->cr_ip);\r\n}\r\nstatic inline void fintek_select_logical_dev(struct fintek_dev *fintek, u8 ldev)\r\n{\r\nfintek_cr_write(fintek, ldev, GCR_LOGICAL_DEV_NO);\r\n}\r\nstatic inline void fintek_cir_reg_write(struct fintek_dev *fintek, u8 val, u8 offset)\r\n{\r\noutb(val, fintek->cir_addr + offset);\r\n}\r\nstatic u8 fintek_cir_reg_read(struct fintek_dev *fintek, u8 offset)\r\n{\r\nu8 val;\r\nval = inb(fintek->cir_addr + offset);\r\nreturn val;\r\n}\r\nstatic void cir_dump_regs(struct fintek_dev *fintek)\r\n{\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\npr_info("%s: Dump CIR logical device registers:\n", FINTEK_DRIVER_NAME);\r\npr_info(" * CR CIR BASE ADDR: 0x%x\n",\r\n(fintek_cr_read(fintek, CIR_CR_BASE_ADDR_HI) << 8) |\r\nfintek_cr_read(fintek, CIR_CR_BASE_ADDR_LO));\r\npr_info(" * CR CIR IRQ NUM: 0x%x\n",\r\nfintek_cr_read(fintek, CIR_CR_IRQ_SEL));\r\nfintek_config_mode_disable(fintek);\r\npr_info("%s: Dump CIR registers:\n", FINTEK_DRIVER_NAME);\r\npr_info(" * STATUS: 0x%x\n",\r\nfintek_cir_reg_read(fintek, CIR_STATUS));\r\npr_info(" * CONTROL: 0x%x\n",\r\nfintek_cir_reg_read(fintek, CIR_CONTROL));\r\npr_info(" * RX_DATA: 0x%x\n",\r\nfintek_cir_reg_read(fintek, CIR_RX_DATA));\r\npr_info(" * TX_CONTROL: 0x%x\n",\r\nfintek_cir_reg_read(fintek, CIR_TX_CONTROL));\r\npr_info(" * TX_DATA: 0x%x\n",\r\nfintek_cir_reg_read(fintek, CIR_TX_DATA));\r\n}\r\nstatic int fintek_hw_detect(struct fintek_dev *fintek)\r\n{\r\nunsigned long flags;\r\nu8 chip_major, chip_minor;\r\nu8 vendor_major, vendor_minor;\r\nu8 portsel, ir_class;\r\nu16 vendor, chip;\r\nfintek_config_mode_enable(fintek);\r\nportsel = fintek_cr_read(fintek, GCR_CONFIG_PORT_SEL);\r\nif (portsel == 0xff) {\r\nfit_pr(KERN_INFO, "first portsel read was bunk, trying alt");\r\nfintek_config_mode_disable(fintek);\r\nfintek->cr_ip = CR_INDEX_PORT2;\r\nfintek->cr_dp = CR_DATA_PORT2;\r\nfintek_config_mode_enable(fintek);\r\nportsel = fintek_cr_read(fintek, GCR_CONFIG_PORT_SEL);\r\n}\r\nfit_dbg("portsel reg: 0x%02x", portsel);\r\nir_class = fintek_cir_reg_read(fintek, CIR_CR_CLASS);\r\nfit_dbg("ir_class reg: 0x%02x", ir_class);\r\nswitch (ir_class) {\r\ncase CLASS_RX_2TX:\r\ncase CLASS_RX_1TX:\r\nfintek->hw_tx_capable = true;\r\nbreak;\r\ncase CLASS_RX_ONLY:\r\ndefault:\r\nfintek->hw_tx_capable = false;\r\nbreak;\r\n}\r\nchip_major = fintek_cr_read(fintek, GCR_CHIP_ID_HI);\r\nchip_minor = fintek_cr_read(fintek, GCR_CHIP_ID_LO);\r\nchip = chip_major << 8 | chip_minor;\r\nvendor_major = fintek_cr_read(fintek, GCR_VENDOR_ID_HI);\r\nvendor_minor = fintek_cr_read(fintek, GCR_VENDOR_ID_LO);\r\nvendor = vendor_major << 8 | vendor_minor;\r\nif (vendor != VENDOR_ID_FINTEK)\r\nfit_pr(KERN_WARNING, "Unknown vendor ID: 0x%04x", vendor);\r\nelse\r\nfit_dbg("Read Fintek vendor ID from chip");\r\nfintek_config_mode_disable(fintek);\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\nfintek->chip_major = chip_major;\r\nfintek->chip_minor = chip_minor;\r\nfintek->chip_vendor = vendor;\r\nif ((chip != 0x0408) && (chip != 0x0804))\r\nfintek->logical_dev_cir = LOGICAL_DEV_CIR_REV2;\r\nelse\r\nfintek->logical_dev_cir = LOGICAL_DEV_CIR_REV1;\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void fintek_cir_ldev_init(struct fintek_dev *fintek)\r\n{\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_cr_write(fintek, LOGICAL_DEV_ENABLE, CIR_CR_DEV_EN);\r\nfintek_cr_write(fintek, fintek->cir_addr >> 8, CIR_CR_BASE_ADDR_HI);\r\nfintek_cr_write(fintek, fintek->cir_addr & 0xff, CIR_CR_BASE_ADDR_LO);\r\nfintek_cr_write(fintek, fintek->cir_irq, CIR_CR_IRQ_SEL);\r\nfit_dbg("CIR initialized, base io address: 0x%lx, irq: %d (len: %d)",\r\nfintek->cir_addr, fintek->cir_irq, fintek->cir_port_len);\r\n}\r\nstatic void fintek_enable_cir_irq(struct fintek_dev *fintek)\r\n{\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_EN, CIR_STATUS);\r\n}\r\nstatic void fintek_cir_regs_init(struct fintek_dev *fintek)\r\n{\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_MASK, CIR_STATUS);\r\nfintek_enable_cir_irq(fintek);\r\n}\r\nstatic void fintek_enable_wake(struct fintek_dev *fintek)\r\n{\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, LOGICAL_DEV_ACPI);\r\nfintek_set_reg_bit(fintek, ACPI_WAKE_EN_CIR_BIT, LDEV_ACPI_WAKE_EN_REG);\r\nfintek_set_reg_bit(fintek, ACPI_PME_CIR_BIT, LDEV_ACPI_PME_EN_REG);\r\nfintek_set_reg_bit(fintek, ACPI_PME_CIR_BIT, LDEV_ACPI_PME_CLR_REG);\r\nfintek_set_reg_bit(fintek, ACPI_STATE_CIR_BIT, LDEV_ACPI_STATE_REG);\r\nfintek_config_mode_disable(fintek);\r\n}\r\nstatic int fintek_cmdsize(u8 cmd, u8 subcmd)\r\n{\r\nint datasize = 0;\r\nswitch (cmd) {\r\ncase BUF_COMMAND_NULL:\r\nif (subcmd == BUF_HW_CMD_HEADER)\r\ndatasize = 1;\r\nbreak;\r\ncase BUF_HW_CMD_HEADER:\r\nif (subcmd == BUF_CMD_G_REVISION)\r\ndatasize = 2;\r\nbreak;\r\ncase BUF_COMMAND_HEADER:\r\nswitch (subcmd) {\r\ncase BUF_CMD_S_CARRIER:\r\ncase BUF_CMD_S_TIMEOUT:\r\ncase BUF_RSP_PULSE_COUNT:\r\ndatasize = 2;\r\nbreak;\r\ncase BUF_CMD_SIG_END:\r\ncase BUF_CMD_S_TXMASK:\r\ncase BUF_CMD_S_RXSENSOR:\r\ndatasize = 1;\r\nbreak;\r\n}\r\n}\r\nreturn datasize;\r\n}\r\nstatic void fintek_process_rx_ir_data(struct fintek_dev *fintek)\r\n{\r\nDEFINE_IR_RAW_EVENT(rawir);\r\nu8 sample;\r\nbool event = false;\r\nint i;\r\nfor (i = 0; i < fintek->pkts; i++) {\r\nsample = fintek->buf[i];\r\nswitch (fintek->parser_state) {\r\ncase CMD_HEADER:\r\nfintek->cmd = sample;\r\nif ((fintek->cmd == BUF_COMMAND_HEADER) ||\r\n((fintek->cmd & BUF_COMMAND_MASK) !=\r\nBUF_PULSE_BIT)) {\r\nfintek->parser_state = SUBCMD;\r\ncontinue;\r\n}\r\nfintek->rem = (fintek->cmd & BUF_LEN_MASK);\r\nfit_dbg("%s: rem: 0x%02x", __func__, fintek->rem);\r\nif (fintek->rem)\r\nfintek->parser_state = PARSE_IRDATA;\r\nelse\r\nir_raw_event_reset(fintek->rdev);\r\nbreak;\r\ncase SUBCMD:\r\nfintek->rem = fintek_cmdsize(fintek->cmd, sample);\r\nfintek->parser_state = CMD_DATA;\r\nbreak;\r\ncase CMD_DATA:\r\nfintek->rem--;\r\nbreak;\r\ncase PARSE_IRDATA:\r\nfintek->rem--;\r\ninit_ir_raw_event(&rawir);\r\nrawir.pulse = ((sample & BUF_PULSE_BIT) != 0);\r\nrawir.duration = US_TO_NS((sample & BUF_SAMPLE_MASK)\r\n* CIR_SAMPLE_PERIOD);\r\nfit_dbg("Storing %s with duration %d",\r\nrawir.pulse ? "pulse" : "space",\r\nrawir.duration);\r\nif (ir_raw_event_store_with_filter(fintek->rdev,\r\n&rawir))\r\nevent = true;\r\nbreak;\r\n}\r\nif ((fintek->parser_state != CMD_HEADER) && !fintek->rem)\r\nfintek->parser_state = CMD_HEADER;\r\n}\r\nfintek->pkts = 0;\r\nif (event) {\r\nfit_dbg("Calling ir_raw_event_handle");\r\nir_raw_event_handle(fintek->rdev);\r\n}\r\n}\r\nstatic void fintek_get_rx_ir_data(struct fintek_dev *fintek, u8 rx_irqs)\r\n{\r\nunsigned long flags;\r\nu8 sample, status;\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\ndo {\r\nsample = fintek_cir_reg_read(fintek, CIR_RX_DATA);\r\nfit_dbg("%s: sample: 0x%02x", __func__, sample);\r\nfintek->buf[fintek->pkts] = sample;\r\nfintek->pkts++;\r\nstatus = fintek_cir_reg_read(fintek, CIR_STATUS);\r\nif (!(status & CIR_STATUS_IRQ_EN))\r\nbreak;\r\n} while (status & rx_irqs);\r\nfintek_process_rx_ir_data(fintek);\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\n}\r\nstatic void fintek_cir_log_irqs(u8 status)\r\n{\r\nfit_pr(KERN_INFO, "IRQ 0x%02x:%s%s%s%s%s", status,\r\nstatus & CIR_STATUS_IRQ_EN ? " IRQEN" : "",\r\nstatus & CIR_STATUS_TX_FINISH ? " TXF" : "",\r\nstatus & CIR_STATUS_TX_UNDERRUN ? " TXU" : "",\r\nstatus & CIR_STATUS_RX_TIMEOUT ? " RXTO" : "",\r\nstatus & CIR_STATUS_RX_RECEIVE ? " RXOK" : "");\r\n}\r\nstatic irqreturn_t fintek_cir_isr(int irq, void *data)\r\n{\r\nstruct fintek_dev *fintek = data;\r\nu8 status, rx_irqs;\r\nfit_dbg_verbose("%s firing", __func__);\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_config_mode_disable(fintek);\r\nstatus = fintek_cir_reg_read(fintek, CIR_STATUS);\r\nif (!(status & CIR_STATUS_IRQ_MASK) || status == 0xff) {\r\nfit_dbg_verbose("%s exiting, IRSTS 0x%02x", __func__, status);\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_MASK, CIR_STATUS);\r\nreturn IRQ_RETVAL(IRQ_NONE);\r\n}\r\nif (debug)\r\nfintek_cir_log_irqs(status);\r\nrx_irqs = status & (CIR_STATUS_RX_RECEIVE | CIR_STATUS_RX_TIMEOUT);\r\nif (rx_irqs)\r\nfintek_get_rx_ir_data(fintek, rx_irqs);\r\nfintek_cir_reg_write(fintek, status, CIR_STATUS);\r\nfit_dbg_verbose("%s done", __func__);\r\nreturn IRQ_RETVAL(IRQ_HANDLED);\r\n}\r\nstatic void fintek_enable_cir(struct fintek_dev *fintek)\r\n{\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_EN, CIR_STATUS);\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_cr_write(fintek, LOGICAL_DEV_ENABLE, CIR_CR_DEV_EN);\r\nfintek_config_mode_disable(fintek);\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_MASK, CIR_STATUS);\r\nfintek_enable_cir_irq(fintek);\r\n}\r\nstatic void fintek_disable_cir(struct fintek_dev *fintek)\r\n{\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_cr_write(fintek, LOGICAL_DEV_DISABLE, CIR_CR_DEV_EN);\r\nfintek_config_mode_disable(fintek);\r\n}\r\nstatic int fintek_open(struct rc_dev *dev)\r\n{\r\nstruct fintek_dev *fintek = dev->priv;\r\nunsigned long flags;\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\nfintek_enable_cir(fintek);\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void fintek_close(struct rc_dev *dev)\r\n{\r\nstruct fintek_dev *fintek = dev->priv;\r\nunsigned long flags;\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\nfintek_disable_cir(fintek);\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\n}\r\nstatic int fintek_probe(struct pnp_dev *pdev, const struct pnp_device_id *dev_id)\r\n{\r\nstruct fintek_dev *fintek;\r\nstruct rc_dev *rdev;\r\nint ret = -ENOMEM;\r\nfintek = kzalloc(sizeof(struct fintek_dev), GFP_KERNEL);\r\nif (!fintek)\r\nreturn ret;\r\nrdev = rc_allocate_device();\r\nif (!rdev)\r\ngoto exit_free_dev_rdev;\r\nret = -ENODEV;\r\nif (!pnp_port_valid(pdev, 0)) {\r\ndev_err(&pdev->dev, "IR PNP Port not valid!\n");\r\ngoto exit_free_dev_rdev;\r\n}\r\nif (!pnp_irq_valid(pdev, 0)) {\r\ndev_err(&pdev->dev, "IR PNP IRQ not valid!\n");\r\ngoto exit_free_dev_rdev;\r\n}\r\nfintek->cir_addr = pnp_port_start(pdev, 0);\r\nfintek->cir_irq = pnp_irq(pdev, 0);\r\nfintek->cir_port_len = pnp_port_len(pdev, 0);\r\nfintek->cr_ip = CR_INDEX_PORT;\r\nfintek->cr_dp = CR_DATA_PORT;\r\nspin_lock_init(&fintek->fintek_lock);\r\npnp_set_drvdata(pdev, fintek);\r\nfintek->pdev = pdev;\r\nret = fintek_hw_detect(fintek);\r\nif (ret)\r\ngoto exit_free_dev_rdev;\r\nfintek_config_mode_enable(fintek);\r\nfintek_cir_ldev_init(fintek);\r\nfintek_config_mode_disable(fintek);\r\nfintek_cir_regs_init(fintek);\r\nrdev->priv = fintek;\r\nrdev->driver_type = RC_DRIVER_IR_RAW;\r\nrdev->allowed_protocols = RC_BIT_ALL;\r\nrdev->open = fintek_open;\r\nrdev->close = fintek_close;\r\nrdev->input_name = FINTEK_DESCRIPTION;\r\nrdev->input_phys = "fintek/cir0";\r\nrdev->input_id.bustype = BUS_HOST;\r\nrdev->input_id.vendor = VENDOR_ID_FINTEK;\r\nrdev->input_id.product = fintek->chip_major;\r\nrdev->input_id.version = fintek->chip_minor;\r\nrdev->dev.parent = &pdev->dev;\r\nrdev->driver_name = FINTEK_DRIVER_NAME;\r\nrdev->map_name = RC_MAP_RC6_MCE;\r\nrdev->timeout = US_TO_NS(1000);\r\nrdev->rx_resolution = US_TO_NS(CIR_SAMPLE_PERIOD);\r\nfintek->rdev = rdev;\r\nret = -EBUSY;\r\nif (!request_region(fintek->cir_addr,\r\nfintek->cir_port_len, FINTEK_DRIVER_NAME))\r\ngoto exit_free_dev_rdev;\r\nif (request_irq(fintek->cir_irq, fintek_cir_isr, IRQF_SHARED,\r\nFINTEK_DRIVER_NAME, (void *)fintek))\r\ngoto exit_free_cir_addr;\r\nret = rc_register_device(rdev);\r\nif (ret)\r\ngoto exit_free_irq;\r\ndevice_init_wakeup(&pdev->dev, true);\r\nfit_pr(KERN_NOTICE, "driver has been successfully loaded\n");\r\nif (debug)\r\ncir_dump_regs(fintek);\r\nreturn 0;\r\nexit_free_irq:\r\nfree_irq(fintek->cir_irq, fintek);\r\nexit_free_cir_addr:\r\nrelease_region(fintek->cir_addr, fintek->cir_port_len);\r\nexit_free_dev_rdev:\r\nrc_free_device(rdev);\r\nkfree(fintek);\r\nreturn ret;\r\n}\r\nstatic void fintek_remove(struct pnp_dev *pdev)\r\n{\r\nstruct fintek_dev *fintek = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\nfintek_disable_cir(fintek);\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_MASK, CIR_STATUS);\r\nfintek_enable_wake(fintek);\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\nfree_irq(fintek->cir_irq, fintek);\r\nrelease_region(fintek->cir_addr, fintek->cir_port_len);\r\nrc_unregister_device(fintek->rdev);\r\nkfree(fintek);\r\n}\r\nstatic int fintek_suspend(struct pnp_dev *pdev, pm_message_t state)\r\n{\r\nstruct fintek_dev *fintek = pnp_get_drvdata(pdev);\r\nunsigned long flags;\r\nfit_dbg("%s called", __func__);\r\nspin_lock_irqsave(&fintek->fintek_lock, flags);\r\nfintek_cir_reg_write(fintek, CIR_STATUS_IRQ_MASK, CIR_STATUS);\r\nspin_unlock_irqrestore(&fintek->fintek_lock, flags);\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_cr_write(fintek, LOGICAL_DEV_DISABLE, CIR_CR_DEV_EN);\r\nfintek_config_mode_disable(fintek);\r\nfintek_enable_wake(fintek);\r\nreturn 0;\r\n}\r\nstatic int fintek_resume(struct pnp_dev *pdev)\r\n{\r\nstruct fintek_dev *fintek = pnp_get_drvdata(pdev);\r\nfit_dbg("%s called", __func__);\r\nfintek_enable_cir_irq(fintek);\r\nfintek_config_mode_enable(fintek);\r\nfintek_select_logical_dev(fintek, fintek->logical_dev_cir);\r\nfintek_cr_write(fintek, LOGICAL_DEV_ENABLE, CIR_CR_DEV_EN);\r\nfintek_config_mode_disable(fintek);\r\nfintek_cir_regs_init(fintek);\r\nreturn 0;\r\n}\r\nstatic void fintek_shutdown(struct pnp_dev *pdev)\r\n{\r\nstruct fintek_dev *fintek = pnp_get_drvdata(pdev);\r\nfintek_enable_wake(fintek);\r\n}\r\nstatic int __init fintek_init(void)\r\n{\r\nreturn pnp_register_driver(&fintek_driver);\r\n}\r\nstatic void __exit fintek_exit(void)\r\n{\r\npnp_unregister_driver(&fintek_driver);\r\n}

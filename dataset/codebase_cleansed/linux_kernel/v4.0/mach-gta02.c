static long gta02_panic_blink(int state)\r\n{\r\nlong delay = 0;\r\nchar led;\r\nled = (state) ? 1 : 0;\r\ngpio_direction_output(GTA02_GPIO_AUX_LED, led);\r\nreturn delay;\r\n}\r\nstatic void\r\ngta02_configure_pmu_for_charger(struct pcf50633 *pcf, void *unused, int res)\r\n{\r\nint ma;\r\nif (res < ((ADC_NOM_CHG_DETECT_USB + ADC_NOM_CHG_DETECT_1A) / 2)) {\r\npcf50633_gpio_set(pcf, PCF50633_GPO, 0);\r\nma = 1000;\r\n} else\r\nma = 100;\r\npcf50633_mbc_usb_curlim_set(pcf, ma);\r\n}\r\nstatic void gta02_charger_worker(struct work_struct *work)\r\n{\r\nif (gta02_usb_vbus_draw) {\r\npcf50633_mbc_usb_curlim_set(gta02_pcf, gta02_usb_vbus_draw);\r\nreturn;\r\n}\r\n#ifdef CONFIG_PCF50633_ADC\r\npcf50633_adc_async_read(gta02_pcf,\r\nPCF50633_ADCC1_MUX_ADCIN1,\r\nPCF50633_ADCC1_AVERAGE_16,\r\ngta02_configure_pmu_for_charger,\r\nNULL);\r\n#else\r\npcf50633_mbc_usb_curlim_set(gta02_pcf, 100);\r\n#endif\r\n}\r\nstatic void gta02_pmu_event_callback(struct pcf50633 *pcf, int irq)\r\n{\r\nif (irq == PCF50633_IRQ_USBINS) {\r\nschedule_delayed_work(&gta02_charger_work,\r\nGTA02_CHARGER_CONFIGURE_TIMEOUT);\r\nreturn;\r\n}\r\nif (irq == PCF50633_IRQ_USBREM) {\r\ncancel_delayed_work_sync(&gta02_charger_work);\r\ngta02_usb_vbus_draw = 0;\r\n}\r\n}\r\nstatic void gta02_udc_vbus_draw(unsigned int ma)\r\n{\r\nif (!gta02_pcf)\r\nreturn;\r\ngta02_usb_vbus_draw = ma;\r\nschedule_delayed_work(&gta02_charger_work,\r\nGTA02_CHARGER_CONFIGURE_TIMEOUT);\r\n}\r\nstatic void __init gta02_map_io(void)\r\n{\r\ns3c24xx_init_io(gta02_iodesc, ARRAY_SIZE(gta02_iodesc));\r\ns3c24xx_init_uarts(gta02_uartcfgs, ARRAY_SIZE(gta02_uartcfgs));\r\nsamsung_set_timer_source(SAMSUNG_PWM3, SAMSUNG_PWM4);\r\n}\r\nstatic void gta02_pmu_attach_child_devices(struct pcf50633 *pcf)\r\n{\r\nint n;\r\ngta02_pcf = pcf;\r\nfor (n = 0; n < ARRAY_SIZE(gta02_devices_pmu_children); n++)\r\ngta02_devices_pmu_children[n]->dev.parent = pcf->dev;\r\nplatform_add_devices(gta02_devices_pmu_children,\r\nARRAY_SIZE(gta02_devices_pmu_children));\r\n}\r\nstatic void gta02_poweroff(void)\r\n{\r\npcf50633_reg_set_bit_mask(gta02_pcf, PCF50633_REG_OOCSHDWN, 1, 1);\r\n}\r\nstatic void __init gta02_machine_init(void)\r\n{\r\npanic_blink = gta02_panic_blink;\r\ns3c_pm_init();\r\n#ifdef CONFIG_CHARGER_PCF50633\r\nINIT_DELAYED_WORK(&gta02_charger_work, gta02_charger_worker);\r\n#endif\r\ns3c24xx_udc_set_platdata(&gta02_udc_cfg);\r\ns3c24xx_ts_set_platdata(&gta02_ts_info);\r\ns3c_ohci_set_platdata(&gta02_usb_info);\r\ns3c_nand_set_platdata(&gta02_nand_info);\r\ns3c_i2c0_set_platdata(NULL);\r\ni2c_register_board_info(0, gta02_i2c_devs, ARRAY_SIZE(gta02_i2c_devs));\r\nplatform_add_devices(gta02_devices, ARRAY_SIZE(gta02_devices));\r\npm_power_off = gta02_poweroff;\r\nregulator_has_full_constraints();\r\n}\r\nstatic void __init gta02_init_time(void)\r\n{\r\ns3c2442_init_clocks(12000000);\r\nsamsung_timer_init();\r\n}

static int sha1_init(struct shash_desc *desc)\r\n{\r\nstruct sha1_state *sctx = shash_desc_ctx(desc);\r\n*sctx = (struct sha1_state){\r\n.state = { SHA1_H0, SHA1_H1, SHA1_H2, SHA1_H3, SHA1_H4 },\r\n};\r\nreturn 0;\r\n}\r\nint crypto_sha1_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct sha1_state *sctx = shash_desc_ctx(desc);\r\nunsigned int partial, done;\r\nconst u8 *src;\r\npartial = sctx->count % SHA1_BLOCK_SIZE;\r\nsctx->count += len;\r\ndone = 0;\r\nsrc = data;\r\nif ((partial + len) >= SHA1_BLOCK_SIZE) {\r\nu32 temp[SHA_WORKSPACE_WORDS];\r\nif (partial) {\r\ndone = -partial;\r\nmemcpy(sctx->buffer + partial, data,\r\ndone + SHA1_BLOCK_SIZE);\r\nsrc = sctx->buffer;\r\n}\r\ndo {\r\nsha_transform(sctx->state, src, temp);\r\ndone += SHA1_BLOCK_SIZE;\r\nsrc = data + done;\r\n} while (done + SHA1_BLOCK_SIZE <= len);\r\nmemzero_explicit(temp, sizeof(temp));\r\npartial = 0;\r\n}\r\nmemcpy(sctx->buffer + partial, src, len - done);\r\nreturn 0;\r\n}\r\nstatic int sha1_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct sha1_state *sctx = shash_desc_ctx(desc);\r\n__be32 *dst = (__be32 *)out;\r\nu32 i, index, padlen;\r\n__be64 bits;\r\nstatic const u8 padding[64] = { 0x80, };\r\nbits = cpu_to_be64(sctx->count << 3);\r\nindex = sctx->count & 0x3f;\r\npadlen = (index < 56) ? (56 - index) : ((64+56) - index);\r\ncrypto_sha1_update(desc, padding, padlen);\r\ncrypto_sha1_update(desc, (const u8 *)&bits, sizeof(bits));\r\nfor (i = 0; i < 5; i++)\r\ndst[i] = cpu_to_be32(sctx->state[i]);\r\nmemset(sctx, 0, sizeof *sctx);\r\nreturn 0;\r\n}\r\nstatic int sha1_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct sha1_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(out, sctx, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int sha1_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct sha1_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(sctx, in, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int __init sha1_generic_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit sha1_generic_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

int ipu_plane_irq(struct ipu_plane *ipu_plane)\r\n{\r\nreturn ipu_idmac_channel_irq(ipu_plane->ipu, ipu_plane->ipu_ch,\r\nIPU_IRQ_EOF);\r\n}\r\nstatic int calc_vref(struct drm_display_mode *mode)\r\n{\r\nunsigned long htotal, vtotal;\r\nhtotal = mode->htotal;\r\nvtotal = mode->vtotal;\r\nif (!htotal || !vtotal)\r\nreturn 60;\r\nreturn DIV_ROUND_UP(mode->clock * 1000, vtotal * htotal);\r\n}\r\nstatic inline int calc_bandwidth(int width, int height, unsigned int vref)\r\n{\r\nreturn width * height * vref;\r\n}\r\nint ipu_plane_set_base(struct ipu_plane *ipu_plane, struct drm_framebuffer *fb,\r\nint x, int y)\r\n{\r\nstruct drm_gem_cma_object *cma_obj;\r\nunsigned long eba;\r\nint active;\r\ncma_obj = drm_fb_cma_get_gem_obj(fb, 0);\r\nif (!cma_obj) {\r\nDRM_DEBUG_KMS("entry is null.\n");\r\nreturn -EFAULT;\r\n}\r\ndev_dbg(ipu_plane->base.dev->dev, "phys = %pad, x = %d, y = %d",\r\n&cma_obj->paddr, x, y);\r\neba = cma_obj->paddr + fb->offsets[0] +\r\nfb->pitches[0] * y + (fb->bits_per_pixel >> 3) * x;\r\nif (ipu_plane->enabled) {\r\nactive = ipu_idmac_get_current_buffer(ipu_plane->ipu_ch);\r\nipu_cpmem_set_buffer(ipu_plane->ipu_ch, !active, eba);\r\nipu_idmac_select_buffer(ipu_plane->ipu_ch, !active);\r\n} else {\r\nipu_cpmem_set_buffer(ipu_plane->ipu_ch, 0, eba);\r\nipu_cpmem_set_buffer(ipu_plane->ipu_ch, 1, eba);\r\n}\r\nipu_plane->x = x;\r\nipu_plane->y = y;\r\nreturn 0;\r\n}\r\nint ipu_plane_mode_set(struct ipu_plane *ipu_plane, struct drm_crtc *crtc,\r\nstruct drm_display_mode *mode,\r\nstruct drm_framebuffer *fb, int crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct device *dev = ipu_plane->base.dev->dev;\r\nint ret;\r\nif (src_w != crtc_w || src_h != crtc_h)\r\nreturn -EINVAL;\r\nif (crtc_x < 0) {\r\nif (-crtc_x > crtc_w)\r\nreturn -EINVAL;\r\nsrc_x += -crtc_x;\r\nsrc_w -= -crtc_x;\r\ncrtc_w -= -crtc_x;\r\ncrtc_x = 0;\r\n}\r\nif (crtc_y < 0) {\r\nif (-crtc_y > crtc_h)\r\nreturn -EINVAL;\r\nsrc_y += -crtc_y;\r\nsrc_h -= -crtc_y;\r\ncrtc_h -= -crtc_y;\r\ncrtc_y = 0;\r\n}\r\nif (crtc_x + crtc_w > mode->hdisplay) {\r\nif (crtc_x > mode->hdisplay)\r\nreturn -EINVAL;\r\ncrtc_w = mode->hdisplay - crtc_x;\r\nsrc_w = crtc_w;\r\n}\r\nif (crtc_y + crtc_h > mode->vdisplay) {\r\nif (crtc_y > mode->vdisplay)\r\nreturn -EINVAL;\r\ncrtc_h = mode->vdisplay - crtc_y;\r\nsrc_h = crtc_h;\r\n}\r\nif (crtc_w < 13 && (ipu_plane->dp_flow != IPU_DP_FLOW_SYNC_FG))\r\nreturn -EINVAL;\r\nif (crtc_h < 2)\r\nreturn -EINVAL;\r\nif (ipu_plane->enabled) {\r\nif (src_w != ipu_plane->w || src_h != ipu_plane->h ||\r\nfb->pixel_format != ipu_plane->base.fb->pixel_format)\r\nreturn -EINVAL;\r\nreturn ipu_plane_set_base(ipu_plane, fb, src_x, src_y);\r\n}\r\nswitch (ipu_plane->dp_flow) {\r\ncase IPU_DP_FLOW_SYNC_BG:\r\nret = ipu_dp_setup_channel(ipu_plane->dp,\r\nIPUV3_COLORSPACE_RGB,\r\nIPUV3_COLORSPACE_RGB);\r\nif (ret) {\r\ndev_err(dev,\r\n"initializing display processor failed with %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nipu_dp_set_global_alpha(ipu_plane->dp, true, 0, true);\r\nbreak;\r\ncase IPU_DP_FLOW_SYNC_FG:\r\nipu_dp_setup_channel(ipu_plane->dp,\r\nipu_drm_fourcc_to_colorspace(fb->pixel_format),\r\nIPUV3_COLORSPACE_UNKNOWN);\r\nipu_dp_set_window_pos(ipu_plane->dp, crtc_x, crtc_y);\r\nswitch (fb->pixel_format) {\r\ncase DRM_FORMAT_ARGB8888:\r\ncase DRM_FORMAT_ABGR8888:\r\nipu_dp_set_global_alpha(ipu_plane->dp, false, 0, false);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nret = ipu_dmfc_init_channel(ipu_plane->dmfc, crtc_w);\r\nif (ret) {\r\ndev_err(dev, "initializing dmfc channel failed with %d\n", ret);\r\nreturn ret;\r\n}\r\nret = ipu_dmfc_alloc_bandwidth(ipu_plane->dmfc,\r\ncalc_bandwidth(crtc_w, crtc_h,\r\ncalc_vref(mode)), 64);\r\nif (ret) {\r\ndev_err(dev, "allocating dmfc bandwidth failed with %d\n", ret);\r\nreturn ret;\r\n}\r\nipu_cpmem_zero(ipu_plane->ipu_ch);\r\nipu_cpmem_set_resolution(ipu_plane->ipu_ch, src_w, src_h);\r\nret = ipu_cpmem_set_fmt(ipu_plane->ipu_ch, fb->pixel_format);\r\nif (ret < 0) {\r\ndev_err(dev, "unsupported pixel format 0x%08x\n",\r\nfb->pixel_format);\r\nreturn ret;\r\n}\r\nipu_cpmem_set_high_priority(ipu_plane->ipu_ch);\r\nipu_idmac_set_double_buffer(ipu_plane->ipu_ch, 1);\r\nipu_cpmem_set_stride(ipu_plane->ipu_ch, fb->pitches[0]);\r\nret = ipu_plane_set_base(ipu_plane, fb, src_x, src_y);\r\nif (ret < 0)\r\nreturn ret;\r\nipu_plane->w = src_w;\r\nipu_plane->h = src_h;\r\nreturn 0;\r\n}\r\nvoid ipu_plane_put_resources(struct ipu_plane *ipu_plane)\r\n{\r\nif (!IS_ERR_OR_NULL(ipu_plane->dp))\r\nipu_dp_put(ipu_plane->dp);\r\nif (!IS_ERR_OR_NULL(ipu_plane->dmfc))\r\nipu_dmfc_put(ipu_plane->dmfc);\r\nif (!IS_ERR_OR_NULL(ipu_plane->ipu_ch))\r\nipu_idmac_put(ipu_plane->ipu_ch);\r\n}\r\nint ipu_plane_get_resources(struct ipu_plane *ipu_plane)\r\n{\r\nint ret;\r\nipu_plane->ipu_ch = ipu_idmac_get(ipu_plane->ipu, ipu_plane->dma);\r\nif (IS_ERR(ipu_plane->ipu_ch)) {\r\nret = PTR_ERR(ipu_plane->ipu_ch);\r\nDRM_ERROR("failed to get idmac channel: %d\n", ret);\r\nreturn ret;\r\n}\r\nipu_plane->dmfc = ipu_dmfc_get(ipu_plane->ipu, ipu_plane->dma);\r\nif (IS_ERR(ipu_plane->dmfc)) {\r\nret = PTR_ERR(ipu_plane->dmfc);\r\nDRM_ERROR("failed to get dmfc: ret %d\n", ret);\r\ngoto err_out;\r\n}\r\nif (ipu_plane->dp_flow >= 0) {\r\nipu_plane->dp = ipu_dp_get(ipu_plane->ipu, ipu_plane->dp_flow);\r\nif (IS_ERR(ipu_plane->dp)) {\r\nret = PTR_ERR(ipu_plane->dp);\r\nDRM_ERROR("failed to get dp flow: %d\n", ret);\r\ngoto err_out;\r\n}\r\n}\r\nreturn 0;\r\nerr_out:\r\nipu_plane_put_resources(ipu_plane);\r\nreturn ret;\r\n}\r\nvoid ipu_plane_enable(struct ipu_plane *ipu_plane)\r\n{\r\nif (ipu_plane->dp)\r\nipu_dp_enable(ipu_plane->ipu);\r\nipu_dmfc_enable_channel(ipu_plane->dmfc);\r\nipu_idmac_enable_channel(ipu_plane->ipu_ch);\r\nif (ipu_plane->dp)\r\nipu_dp_enable_channel(ipu_plane->dp);\r\nipu_plane->enabled = true;\r\n}\r\nvoid ipu_plane_disable(struct ipu_plane *ipu_plane)\r\n{\r\nipu_plane->enabled = false;\r\nipu_idmac_wait_busy(ipu_plane->ipu_ch, 50);\r\nif (ipu_plane->dp)\r\nipu_dp_disable_channel(ipu_plane->dp);\r\nipu_idmac_disable_channel(ipu_plane->ipu_ch);\r\nipu_dmfc_disable_channel(ipu_plane->dmfc);\r\nif (ipu_plane->dp)\r\nipu_dp_disable(ipu_plane->ipu);\r\n}\r\nstatic int ipu_update_plane(struct drm_plane *plane, struct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb, int crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct ipu_plane *ipu_plane = to_ipu_plane(plane);\r\nint ret = 0;\r\nDRM_DEBUG_KMS("plane - %p\n", plane);\r\nif (!ipu_plane->enabled)\r\nret = ipu_plane_get_resources(ipu_plane);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ipu_plane_mode_set(ipu_plane, crtc, &crtc->hwmode, fb,\r\ncrtc_x, crtc_y, crtc_w, crtc_h,\r\nsrc_x >> 16, src_y >> 16, src_w >> 16, src_h >> 16);\r\nif (ret < 0) {\r\nipu_plane_put_resources(ipu_plane);\r\nreturn ret;\r\n}\r\nif (crtc != plane->crtc)\r\ndev_info(plane->dev->dev, "crtc change: %p -> %p\n",\r\nplane->crtc, crtc);\r\nplane->crtc = crtc;\r\nif (!ipu_plane->enabled)\r\nipu_plane_enable(ipu_plane);\r\nreturn 0;\r\n}\r\nstatic int ipu_disable_plane(struct drm_plane *plane)\r\n{\r\nstruct ipu_plane *ipu_plane = to_ipu_plane(plane);\r\nDRM_DEBUG_KMS("[%d] %s\n", __LINE__, __func__);\r\nif (ipu_plane->enabled)\r\nipu_plane_disable(ipu_plane);\r\nipu_plane_put_resources(ipu_plane);\r\nreturn 0;\r\n}\r\nstatic void ipu_plane_destroy(struct drm_plane *plane)\r\n{\r\nstruct ipu_plane *ipu_plane = to_ipu_plane(plane);\r\nDRM_DEBUG_KMS("[%d] %s\n", __LINE__, __func__);\r\nipu_disable_plane(plane);\r\ndrm_plane_cleanup(plane);\r\nkfree(ipu_plane);\r\n}\r\nstruct ipu_plane *ipu_plane_init(struct drm_device *dev, struct ipu_soc *ipu,\r\nint dma, int dp, unsigned int possible_crtcs,\r\nbool priv)\r\n{\r\nstruct ipu_plane *ipu_plane;\r\nint ret;\r\nDRM_DEBUG_KMS("channel %d, dp flow %d, possible_crtcs=0x%x\n",\r\ndma, dp, possible_crtcs);\r\nipu_plane = kzalloc(sizeof(*ipu_plane), GFP_KERNEL);\r\nif (!ipu_plane) {\r\nDRM_ERROR("failed to allocate plane\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nipu_plane->ipu = ipu;\r\nipu_plane->dma = dma;\r\nipu_plane->dp_flow = dp;\r\nret = drm_plane_init(dev, &ipu_plane->base, possible_crtcs,\r\n&ipu_plane_funcs, ipu_plane_formats,\r\nARRAY_SIZE(ipu_plane_formats),\r\npriv);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize plane\n");\r\nkfree(ipu_plane);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn ipu_plane;\r\n}

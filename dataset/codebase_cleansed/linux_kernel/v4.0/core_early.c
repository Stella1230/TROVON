static int x86_vendor(void)\r\n{\r\nu32 eax = 0x00000000;\r\nu32 ebx, ecx = 0, edx;\r\nnative_cpuid(&eax, &ebx, &ecx, &edx);\r\nif (CPUID_IS(CPUID_INTEL1, CPUID_INTEL2, CPUID_INTEL3, ebx, ecx, edx))\r\nreturn X86_VENDOR_INTEL;\r\nif (CPUID_IS(CPUID_AMD1, CPUID_AMD2, CPUID_AMD3, ebx, ecx, edx))\r\nreturn X86_VENDOR_AMD;\r\nreturn X86_VENDOR_UNKNOWN;\r\n}\r\nstatic int x86_family(void)\r\n{\r\nu32 eax = 0x00000001;\r\nu32 ebx, ecx = 0, edx;\r\nint x86;\r\nnative_cpuid(&eax, &ebx, &ecx, &edx);\r\nx86 = (eax >> 8) & 0xf;\r\nif (x86 == 15)\r\nx86 += (eax >> 20) & 0xff;\r\nreturn x86;\r\n}\r\nstatic bool __init check_loader_disabled_bsp(void)\r\n{\r\n#ifdef CONFIG_X86_32\r\nconst char *cmdline = (const char *)__pa_nodebug(boot_command_line);\r\nconst char *opt = "dis_ucode_ldr";\r\nconst char *option = (const char *)__pa_nodebug(opt);\r\nbool *res = (bool *)__pa_nodebug(&dis_ucode_ldr);\r\n#else\r\nconst char *cmdline = boot_command_line;\r\nconst char *option = "dis_ucode_ldr";\r\nbool *res = &dis_ucode_ldr;\r\n#endif\r\nif (cmdline_find_option_bool(cmdline, option))\r\n*res = true;\r\nreturn *res;\r\n}\r\nvoid __init load_ucode_bsp(void)\r\n{\r\nint vendor, x86;\r\nif (check_loader_disabled_bsp())\r\nreturn;\r\nif (!have_cpuid_p())\r\nreturn;\r\nvendor = x86_vendor();\r\nx86 = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (x86 >= 6)\r\nload_ucode_intel_bsp();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (x86 >= 0x10)\r\nload_ucode_amd_bsp();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic bool check_loader_disabled_ap(void)\r\n{\r\n#ifdef CONFIG_X86_32\r\nreturn *((bool *)__pa_nodebug(&dis_ucode_ldr));\r\n#else\r\nreturn dis_ucode_ldr;\r\n#endif\r\n}\r\nvoid load_ucode_ap(void)\r\n{\r\nint vendor, x86;\r\nif (check_loader_disabled_ap())\r\nreturn;\r\nif (!have_cpuid_p())\r\nreturn;\r\nvendor = x86_vendor();\r\nx86 = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (x86 >= 6)\r\nload_ucode_intel_ap();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (x86 >= 0x10)\r\nload_ucode_amd_ap();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint __init save_microcode_in_initrd(void)\r\n{\r\nstruct cpuinfo_x86 *c = &boot_cpu_data;\r\nswitch (c->x86_vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (c->x86 >= 6)\r\nsave_microcode_in_initrd_intel();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (c->x86 >= 0x10)\r\nsave_microcode_in_initrd_amd();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid reload_early_microcode(void)\r\n{\r\nint vendor, x86;\r\nvendor = x86_vendor();\r\nx86 = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (x86 >= 6)\r\nreload_ucode_intel();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (x86 >= 0x10)\r\nreload_ucode_amd();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}

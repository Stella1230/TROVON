static int clk_apbc_prepare(struct clk_hw *hw)\r\n{\r\nstruct clk_apbc *apbc = to_clk_apbc(hw);\r\nunsigned int data;\r\nunsigned long flags = 0;\r\nif (apbc->lock)\r\nspin_lock_irqsave(apbc->lock, flags);\r\ndata = readl_relaxed(apbc->base);\r\nif (apbc->flags & APBC_POWER_CTRL)\r\ndata |= APBC_POWER;\r\ndata |= APBC_FNCLK;\r\nwritel_relaxed(data, apbc->base);\r\nif (apbc->lock)\r\nspin_unlock_irqrestore(apbc->lock, flags);\r\nudelay(apbc->delay);\r\nif (apbc->lock)\r\nspin_lock_irqsave(apbc->lock, flags);\r\ndata = readl_relaxed(apbc->base);\r\ndata |= APBC_APBCLK;\r\nwritel_relaxed(data, apbc->base);\r\nif (apbc->lock)\r\nspin_unlock_irqrestore(apbc->lock, flags);\r\nudelay(apbc->delay);\r\nif (!(apbc->flags & APBC_NO_BUS_CTRL)) {\r\nif (apbc->lock)\r\nspin_lock_irqsave(apbc->lock, flags);\r\ndata = readl_relaxed(apbc->base);\r\ndata &= ~APBC_RST;\r\nwritel_relaxed(data, apbc->base);\r\nif (apbc->lock)\r\nspin_unlock_irqrestore(apbc->lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic void clk_apbc_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_apbc *apbc = to_clk_apbc(hw);\r\nunsigned long data;\r\nunsigned long flags = 0;\r\nif (apbc->lock)\r\nspin_lock_irqsave(apbc->lock, flags);\r\ndata = readl_relaxed(apbc->base);\r\nif (apbc->flags & APBC_POWER_CTRL)\r\ndata &= ~APBC_POWER;\r\ndata &= ~APBC_FNCLK;\r\nwritel_relaxed(data, apbc->base);\r\nif (apbc->lock)\r\nspin_unlock_irqrestore(apbc->lock, flags);\r\nudelay(10);\r\nif (apbc->lock)\r\nspin_lock_irqsave(apbc->lock, flags);\r\ndata = readl_relaxed(apbc->base);\r\ndata &= ~APBC_APBCLK;\r\nwritel_relaxed(data, apbc->base);\r\nif (apbc->lock)\r\nspin_unlock_irqrestore(apbc->lock, flags);\r\n}\r\nstruct clk *mmp_clk_register_apbc(const char *name, const char *parent_name,\r\nvoid __iomem *base, unsigned int delay,\r\nunsigned int apbc_flags, spinlock_t *lock)\r\n{\r\nstruct clk_apbc *apbc;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\napbc = kzalloc(sizeof(*apbc), GFP_KERNEL);\r\nif (!apbc)\r\nreturn NULL;\r\ninit.name = name;\r\ninit.ops = &clk_apbc_ops;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\napbc->base = base;\r\napbc->delay = delay;\r\napbc->flags = apbc_flags;\r\napbc->lock = lock;\r\napbc->hw.init = &init;\r\nclk = clk_register(NULL, &apbc->hw);\r\nif (IS_ERR(clk))\r\nkfree(apbc);\r\nreturn clk;\r\n}

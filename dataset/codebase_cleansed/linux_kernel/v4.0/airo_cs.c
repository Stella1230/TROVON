static int airo_probe(struct pcmcia_device *p_dev)\r\n{\r\nstruct local_info *local;\r\ndev_dbg(&p_dev->dev, "airo_attach()\n");\r\nlocal = kzalloc(sizeof(*local), GFP_KERNEL);\r\nif (!local)\r\nreturn -ENOMEM;\r\np_dev->priv = local;\r\nreturn airo_config(p_dev);\r\n}\r\nstatic void airo_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "airo_detach\n");\r\nairo_release(link);\r\nif (((struct local_info *)link->priv)->eth_dev) {\r\nstop_airo_card(((struct local_info *)link->priv)->eth_dev,\r\n0);\r\n}\r\n((struct local_info *)link->priv)->eth_dev = NULL;\r\nkfree(link->priv);\r\n}\r\nstatic int airo_cs_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int airo_config(struct pcmcia_device *link)\r\n{\r\nstruct local_info *dev;\r\nint ret;\r\ndev = link->priv;\r\ndev_dbg(&link->dev, "airo_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_VPP |\r\nCONF_AUTO_AUDIO | CONF_AUTO_SET_IO;\r\nret = pcmcia_loop_config(link, airo_cs_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\n((struct local_info *)link->priv)->eth_dev =\r\ninit_airo_card(link->irq,\r\nlink->resource[0]->start, 1, &link->dev);\r\nif (!((struct local_info *)link->priv)->eth_dev)\r\ngoto failed;\r\nreturn 0;\r\nfailed:\r\nairo_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void airo_release(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "airo_release\n");\r\npcmcia_disable_device(link);\r\n}\r\nstatic int airo_suspend(struct pcmcia_device *link)\r\n{\r\nstruct local_info *local = link->priv;\r\nnetif_device_detach(local->eth_dev);\r\nreturn 0;\r\n}\r\nstatic int airo_resume(struct pcmcia_device *link)\r\n{\r\nstruct local_info *local = link->priv;\r\nif (link->open) {\r\nreset_airo_card(local->eth_dev);\r\nnetif_device_attach(local->eth_dev);\r\n}\r\nreturn 0;\r\n}

static int setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keysize)\r\n{\r\nstruct salsa20_ctx *ctx = crypto_tfm_ctx(tfm);\r\nsalsa20_keysetup(ctx, key, keysize*8, SALSA20_IV_SIZE*8);\r\nreturn 0;\r\n}\r\nstatic int encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nstruct crypto_blkcipher *tfm = desc->tfm;\r\nstruct salsa20_ctx *ctx = crypto_blkcipher_ctx(tfm);\r\nint err;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt_block(desc, &walk, 64);\r\nsalsa20_ivsetup(ctx, walk.iv);\r\nif (likely(walk.nbytes == nbytes))\r\n{\r\nsalsa20_encrypt_bytes(ctx, walk.src.virt.addr,\r\nwalk.dst.virt.addr, nbytes);\r\nreturn blkcipher_walk_done(desc, &walk, 0);\r\n}\r\nwhile (walk.nbytes >= 64) {\r\nsalsa20_encrypt_bytes(ctx, walk.src.virt.addr,\r\nwalk.dst.virt.addr,\r\nwalk.nbytes - (walk.nbytes % 64));\r\nerr = blkcipher_walk_done(desc, &walk, walk.nbytes % 64);\r\n}\r\nif (walk.nbytes) {\r\nsalsa20_encrypt_bytes(ctx, walk.src.virt.addr,\r\nwalk.dst.virt.addr, walk.nbytes);\r\nerr = blkcipher_walk_done(desc, &walk, 0);\r\n}\r\nreturn err;\r\n}\r\nstatic int __init init(void)\r\n{\r\nreturn crypto_register_alg(&alg);\r\n}\r\nstatic void __exit fini(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\n}

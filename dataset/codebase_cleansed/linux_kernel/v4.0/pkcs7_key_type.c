static int pkcs7_preparse(struct key_preparsed_payload *prep)\r\n{\r\nstruct pkcs7_message *pkcs7;\r\nconst void *data, *saved_prep_data;\r\nsize_t datalen, saved_prep_datalen;\r\nbool trusted;\r\nint ret;\r\nkenter("");\r\nsaved_prep_data = prep->data;\r\nsaved_prep_datalen = prep->datalen;\r\npkcs7 = pkcs7_parse_message(saved_prep_data, saved_prep_datalen);\r\nif (IS_ERR(pkcs7)) {\r\nret = PTR_ERR(pkcs7);\r\ngoto error;\r\n}\r\nret = pkcs7_verify(pkcs7);\r\nif (ret < 0)\r\ngoto error_free;\r\nret = pkcs7_validate_trust(pkcs7, system_trusted_keyring, &trusted);\r\nif (ret < 0)\r\ngoto error_free;\r\nif (!trusted)\r\npr_warn("PKCS#7 message doesn't chain back to a trusted key\n");\r\nret = pkcs7_get_content_data(pkcs7, &data, &datalen, false);\r\nif (ret < 0)\r\ngoto error_free;\r\nprep->data = data;\r\nprep->datalen = datalen;\r\nret = user_preparse(prep);\r\nprep->data = saved_prep_data;\r\nprep->datalen = saved_prep_datalen;\r\nerror_free:\r\npkcs7_free_message(pkcs7);\r\nerror:\r\nkleave(" = %d", ret);\r\nreturn ret;\r\n}\r\nstatic int __init pkcs7_key_init(void)\r\n{\r\nreturn register_key_type(&key_type_pkcs7);\r\n}\r\nstatic void __exit pkcs7_key_cleanup(void)\r\n{\r\nunregister_key_type(&key_type_pkcs7);\r\n}

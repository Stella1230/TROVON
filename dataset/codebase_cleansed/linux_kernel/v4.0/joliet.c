static int\r\nuni16_to_x8(unsigned char *ascii, __be16 *uni, int len, struct nls_table *nls)\r\n{\r\n__be16 *ip, ch;\r\nunsigned char *op;\r\nip = uni;\r\nop = ascii;\r\nwhile ((ch = get_unaligned(ip)) && len) {\r\nint llen;\r\nllen = nls->uni2char(be16_to_cpu(ch), op, NLS_MAX_CHARSET_SIZE);\r\nif (llen > 0)\r\nop += llen;\r\nelse\r\n*op++ = '?';\r\nip++;\r\nlen--;\r\n}\r\n*op = 0;\r\nreturn (op - ascii);\r\n}\r\nint\r\nget_joliet_filename(struct iso_directory_record * de, unsigned char *outname, struct inode * inode)\r\n{\r\nunsigned char utf8;\r\nstruct nls_table *nls;\r\nunsigned char len = 0;\r\nutf8 = ISOFS_SB(inode->i_sb)->s_utf8;\r\nnls = ISOFS_SB(inode->i_sb)->s_nls_iocharset;\r\nif (utf8) {\r\nlen = utf16s_to_utf8s((const wchar_t *) de->name,\r\nde->name_len[0] >> 1, UTF16_BIG_ENDIAN,\r\noutname, PAGE_SIZE);\r\n} else {\r\nlen = uni16_to_x8(outname, (__be16 *) de->name,\r\nde->name_len[0] >> 1, nls);\r\n}\r\nif ((len > 2) && (outname[len-2] == ';') && (outname[len-1] == '1'))\r\nlen -= 2;\r\nwhile (len >= 2 && (outname[len-1] == '.'))\r\nlen--;\r\nreturn len;\r\n}

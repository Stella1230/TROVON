int aa_getprocattr(struct aa_profile *profile, char **string)\r\n{\r\nchar *str;\r\nint len = 0, mode_len = 0, ns_len = 0, name_len;\r\nconst char *mode_str = aa_profile_mode_names[profile->mode];\r\nconst char *ns_name = NULL;\r\nstruct aa_namespace *ns = profile->ns;\r\nstruct aa_namespace *current_ns = __aa_current_profile()->ns;\r\nchar *s;\r\nif (!aa_ns_visible(current_ns, ns))\r\nreturn -EACCES;\r\nns_name = aa_ns_name(current_ns, ns);\r\nns_len = strlen(ns_name);\r\nif (ns_len)\r\nns_len += 4;\r\nif (!unconfined(profile))\r\nmode_len = strlen(mode_str) + 3;\r\nname_len = strlen(profile->base.hname);\r\nlen = mode_len + ns_len + name_len + 1;\r\ns = str = kmalloc(len + 1, GFP_KERNEL);\r\nif (!str)\r\nreturn -ENOMEM;\r\nif (ns_len) {\r\nsprintf(s, ":%s://", ns_name);\r\ns += ns_len;\r\n}\r\nif (unconfined(profile))\r\nsprintf(s, "%s\n", profile->base.hname);\r\nelse\r\nsprintf(s, "%s (%s)\n", profile->base.hname, mode_str);\r\n*string = str;\r\nreturn len;\r\n}\r\nstatic char *split_token_from_name(int op, char *args, u64 * token)\r\n{\r\nchar *name;\r\n*token = simple_strtoull(args, &name, 16);\r\nif ((name == args) || *name != '^') {\r\nAA_ERROR("%s: Invalid input '%s'", op_table[op], args);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nname++;\r\nif (!*name)\r\nname = NULL;\r\nreturn name;\r\n}\r\nint aa_setprocattr_changehat(char *args, size_t size, int test)\r\n{\r\nchar *hat;\r\nu64 token;\r\nconst char *hats[16];\r\nint count = 0;\r\nhat = split_token_from_name(OP_CHANGE_HAT, args, &token);\r\nif (IS_ERR(hat))\r\nreturn PTR_ERR(hat);\r\nif (!hat && !token) {\r\nAA_ERROR("change_hat: Invalid input, NULL hat and NULL magic");\r\nreturn -EINVAL;\r\n}\r\nif (hat) {\r\nchar *end = args + size;\r\nfor (count = 0; (hat < end) && count < 16; ++count) {\r\nchar *next = hat + strlen(hat) + 1;\r\nhats[count] = hat;\r\nhat = next;\r\n}\r\n}\r\nAA_DEBUG("%s: Magic 0x%llx Hat '%s'\n",\r\n__func__, token, hat ? hat : NULL);\r\nreturn aa_change_hat(hats, count, token, test);\r\n}\r\nint aa_setprocattr_changeprofile(char *fqname, bool onexec, int test)\r\n{\r\nchar *name, *ns_name;\r\nname = aa_split_fqname(fqname, &ns_name);\r\nreturn aa_change_profile(ns_name, name, onexec, test);\r\n}

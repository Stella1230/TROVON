static int __init ma600_sir_init(void)\r\n{\r\nreturn irda_register_dongle(&ma600);\r\n}\r\nstatic void __exit ma600_sir_cleanup(void)\r\n{\r\nirda_unregister_dongle(&ma600);\r\n}\r\nstatic int ma600_open(struct sir_dev *dev)\r\n{\r\nstruct qos_info *qos = &dev->qos;\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nqos->baud_rate.bits &= IR_2400|IR_9600|IR_19200|IR_38400\r\n|IR_57600|IR_115200;\r\nqos->min_turn_time.bits = 0x01;\r\nirda_qos_bits_to_value(qos);\r\nreturn 0;\r\n}\r\nstatic int ma600_close(struct sir_dev *dev)\r\n{\r\nsirdev_set_dtr_rts(dev, FALSE, FALSE);\r\nreturn 0;\r\n}\r\nstatic __u8 get_control_byte(__u32 speed)\r\n{\r\n__u8 byte;\r\nswitch (speed) {\r\ndefault:\r\ncase 115200:\r\nbyte = MA600_115200;\r\nbreak;\r\ncase 57600:\r\nbyte = MA600_57600;\r\nbreak;\r\ncase 38400:\r\nbyte = MA600_38400;\r\nbreak;\r\ncase 19200:\r\nbyte = MA600_19200;\r\nbreak;\r\ncase 9600:\r\nbyte = MA600_9600;\r\nbreak;\r\ncase 2400:\r\nbyte = MA600_2400;\r\nbreak;\r\n}\r\nreturn byte;\r\n}\r\nstatic int ma600_change_speed(struct sir_dev *dev, unsigned speed)\r\n{\r\nu8 byte;\r\npr_debug("%s(), speed=%d (was %d)\n", __func__,\r\nspeed, dev->speed);\r\nsirdev_set_dtr_rts(dev, TRUE, FALSE);\r\nmdelay(1);\r\nbyte = get_control_byte(speed);\r\nsirdev_raw_write(dev, &byte, sizeof(byte));\r\nmsleep(15);\r\n#if 1\r\nsirdev_raw_read(dev, &byte, sizeof(byte));\r\nif (byte != get_control_byte(speed)) {\r\nnet_warn_ratelimited("%s(): bad control byte read-back %02x != %02x\n",\r\n__func__, (unsigned)byte,\r\n(unsigned)get_control_byte(speed));\r\nreturn -1;\r\n}\r\nelse\r\npr_debug("%s() control byte write read OK\n", __func__);\r\n#endif\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nmsleep(10);\r\ndev->speed = speed;\r\nreturn 0;\r\n}\r\nstatic int ma600_reset(struct sir_dev *dev)\r\n{\r\nsirdev_set_dtr_rts(dev, FALSE, TRUE);\r\nmsleep(10);\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nmsleep(10);\r\ndev->speed = 9600;\r\nreturn 0;\r\n}

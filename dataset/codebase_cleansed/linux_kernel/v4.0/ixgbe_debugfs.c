static ssize_t ixgbe_dbg_reg_ops_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ixgbe_adapter *adapter = filp->private_data;\r\nchar *buf;\r\nint len;\r\nif (*ppos != 0)\r\nreturn 0;\r\nbuf = kasprintf(GFP_KERNEL, "%s: %s\n",\r\nadapter->netdev->name,\r\nixgbe_dbg_reg_ops_buf);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (count < strlen(buf)) {\r\nkfree(buf);\r\nreturn -ENOSPC;\r\n}\r\nlen = simple_read_from_buffer(buffer, count, ppos, buf, strlen(buf));\r\nkfree(buf);\r\nreturn len;\r\n}\r\nstatic ssize_t ixgbe_dbg_reg_ops_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ixgbe_adapter *adapter = filp->private_data;\r\nint len;\r\nif (*ppos != 0)\r\nreturn 0;\r\nif (count >= sizeof(ixgbe_dbg_reg_ops_buf))\r\nreturn -ENOSPC;\r\nlen = simple_write_to_buffer(ixgbe_dbg_reg_ops_buf,\r\nsizeof(ixgbe_dbg_reg_ops_buf)-1,\r\nppos,\r\nbuffer,\r\ncount);\r\nif (len < 0)\r\nreturn len;\r\nixgbe_dbg_reg_ops_buf[len] = '\0';\r\nif (strncmp(ixgbe_dbg_reg_ops_buf, "write", 5) == 0) {\r\nu32 reg, value;\r\nint cnt;\r\ncnt = sscanf(&ixgbe_dbg_reg_ops_buf[5], "%x %x", &reg, &value);\r\nif (cnt == 2) {\r\nIXGBE_WRITE_REG(&adapter->hw, reg, value);\r\nvalue = IXGBE_READ_REG(&adapter->hw, reg);\r\ne_dev_info("write: 0x%08x = 0x%08x\n", reg, value);\r\n} else {\r\ne_dev_info("write <reg> <value>\n");\r\n}\r\n} else if (strncmp(ixgbe_dbg_reg_ops_buf, "read", 4) == 0) {\r\nu32 reg, value;\r\nint cnt;\r\ncnt = sscanf(&ixgbe_dbg_reg_ops_buf[4], "%x", &reg);\r\nif (cnt == 1) {\r\nvalue = IXGBE_READ_REG(&adapter->hw, reg);\r\ne_dev_info("read 0x%08x = 0x%08x\n", reg, value);\r\n} else {\r\ne_dev_info("read <reg>\n");\r\n}\r\n} else {\r\ne_dev_info("Unknown command %s\n", ixgbe_dbg_reg_ops_buf);\r\ne_dev_info("Available commands:\n");\r\ne_dev_info(" read <reg>\n");\r\ne_dev_info(" write <reg> <value>\n");\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t ixgbe_dbg_netdev_ops_read(struct file *filp,\r\nchar __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ixgbe_adapter *adapter = filp->private_data;\r\nchar *buf;\r\nint len;\r\nif (*ppos != 0)\r\nreturn 0;\r\nbuf = kasprintf(GFP_KERNEL, "%s: %s\n",\r\nadapter->netdev->name,\r\nixgbe_dbg_netdev_ops_buf);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (count < strlen(buf)) {\r\nkfree(buf);\r\nreturn -ENOSPC;\r\n}\r\nlen = simple_read_from_buffer(buffer, count, ppos, buf, strlen(buf));\r\nkfree(buf);\r\nreturn len;\r\n}\r\nstatic ssize_t ixgbe_dbg_netdev_ops_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ixgbe_adapter *adapter = filp->private_data;\r\nint len;\r\nif (*ppos != 0)\r\nreturn 0;\r\nif (count >= sizeof(ixgbe_dbg_netdev_ops_buf))\r\nreturn -ENOSPC;\r\nlen = simple_write_to_buffer(ixgbe_dbg_netdev_ops_buf,\r\nsizeof(ixgbe_dbg_netdev_ops_buf)-1,\r\nppos,\r\nbuffer,\r\ncount);\r\nif (len < 0)\r\nreturn len;\r\nixgbe_dbg_netdev_ops_buf[len] = '\0';\r\nif (strncmp(ixgbe_dbg_netdev_ops_buf, "tx_timeout", 10) == 0) {\r\nadapter->netdev->netdev_ops->ndo_tx_timeout(adapter->netdev);\r\ne_dev_info("tx_timeout called\n");\r\n} else {\r\ne_dev_info("Unknown command: %s\n", ixgbe_dbg_netdev_ops_buf);\r\ne_dev_info("Available commands:\n");\r\ne_dev_info(" tx_timeout\n");\r\n}\r\nreturn count;\r\n}\r\nvoid ixgbe_dbg_adapter_init(struct ixgbe_adapter *adapter)\r\n{\r\nconst char *name = pci_name(adapter->pdev);\r\nstruct dentry *pfile;\r\nadapter->ixgbe_dbg_adapter = debugfs_create_dir(name, ixgbe_dbg_root);\r\nif (adapter->ixgbe_dbg_adapter) {\r\npfile = debugfs_create_file("reg_ops", 0600,\r\nadapter->ixgbe_dbg_adapter, adapter,\r\n&ixgbe_dbg_reg_ops_fops);\r\nif (!pfile)\r\ne_dev_err("debugfs reg_ops for %s failed\n", name);\r\npfile = debugfs_create_file("netdev_ops", 0600,\r\nadapter->ixgbe_dbg_adapter, adapter,\r\n&ixgbe_dbg_netdev_ops_fops);\r\nif (!pfile)\r\ne_dev_err("debugfs netdev_ops for %s failed\n", name);\r\n} else {\r\ne_dev_err("debugfs entry for %s failed\n", name);\r\n}\r\n}\r\nvoid ixgbe_dbg_adapter_exit(struct ixgbe_adapter *adapter)\r\n{\r\ndebugfs_remove_recursive(adapter->ixgbe_dbg_adapter);\r\nadapter->ixgbe_dbg_adapter = NULL;\r\n}\r\nvoid ixgbe_dbg_init(void)\r\n{\r\nixgbe_dbg_root = debugfs_create_dir(ixgbe_driver_name, NULL);\r\nif (ixgbe_dbg_root == NULL)\r\npr_err("init of debugfs failed\n");\r\n}\r\nvoid ixgbe_dbg_exit(void)\r\n{\r\ndebugfs_remove_recursive(ixgbe_dbg_root);\r\n}

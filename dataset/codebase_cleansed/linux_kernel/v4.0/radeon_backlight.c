static int radeon_bl_get_level_brightness(struct radeon_bl_privdata *pdata,\r\nint level)\r\n{\r\nint rlevel;\r\nrlevel = pdata->rinfo->info->bl_curve[level] *\r\nFB_BACKLIGHT_MAX / MAX_RADEON_LEVEL;\r\nif (rlevel < 0)\r\nrlevel = 0;\r\nelse if (rlevel > MAX_RADEON_LEVEL)\r\nrlevel = MAX_RADEON_LEVEL;\r\nif (pdata->negative)\r\nrlevel = MAX_RADEON_LEVEL - rlevel;\r\nreturn rlevel;\r\n}\r\nstatic int radeon_bl_update_status(struct backlight_device *bd)\r\n{\r\nstruct radeon_bl_privdata *pdata = bl_get_data(bd);\r\nstruct radeonfb_info *rinfo = pdata->rinfo;\r\nu32 lvds_gen_cntl, tmpPixclksCntl;\r\nint level;\r\nif (rinfo->mon1_type != MT_LCD)\r\nreturn 0;\r\nif (bd->props.power != FB_BLANK_UNBLANK ||\r\nbd->props.fb_blank != FB_BLANK_UNBLANK)\r\nlevel = 0;\r\nelse\r\nlevel = bd->props.brightness;\r\ndel_timer_sync(&rinfo->lvds_timer);\r\nradeon_engine_idle();\r\nlvds_gen_cntl = INREG(LVDS_GEN_CNTL);\r\nif (level > 0) {\r\nlvds_gen_cntl &= ~LVDS_DISPLAY_DIS;\r\nif (!(lvds_gen_cntl & LVDS_BLON) || !(lvds_gen_cntl & LVDS_ON)) {\r\nlvds_gen_cntl |= (rinfo->init_state.lvds_gen_cntl & LVDS_DIGON);\r\nlvds_gen_cntl |= LVDS_BLON | LVDS_EN;\r\nOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\r\nlvds_gen_cntl &= ~LVDS_BL_MOD_LEVEL_MASK;\r\nlvds_gen_cntl |=\r\n(radeon_bl_get_level_brightness(pdata, level) <<\r\nLVDS_BL_MOD_LEVEL_SHIFT);\r\nlvds_gen_cntl |= LVDS_ON;\r\nlvds_gen_cntl |= (rinfo->init_state.lvds_gen_cntl & LVDS_BL_MOD_EN);\r\nrinfo->pending_lvds_gen_cntl = lvds_gen_cntl;\r\nmod_timer(&rinfo->lvds_timer,\r\njiffies + msecs_to_jiffies(rinfo->panel_info.pwr_delay));\r\n} else {\r\nlvds_gen_cntl &= ~LVDS_BL_MOD_LEVEL_MASK;\r\nlvds_gen_cntl |=\r\n(radeon_bl_get_level_brightness(pdata, level) <<\r\nLVDS_BL_MOD_LEVEL_SHIFT);\r\nOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\r\n}\r\nrinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\r\nrinfo->init_state.lvds_gen_cntl |= rinfo->pending_lvds_gen_cntl\r\n& LVDS_STATE_MASK;\r\n} else {\r\ntmpPixclksCntl = INPLL(PIXCLKS_CNTL);\r\nif (rinfo->is_mobility || rinfo->is_IGP)\r\nOUTPLLP(PIXCLKS_CNTL, 0, ~PIXCLK_LVDS_ALWAYS_ONb);\r\nlvds_gen_cntl &= ~(LVDS_BL_MOD_LEVEL_MASK | LVDS_BL_MOD_EN);\r\nlvds_gen_cntl |= (radeon_bl_get_level_brightness(pdata, 0) <<\r\nLVDS_BL_MOD_LEVEL_SHIFT);\r\nlvds_gen_cntl |= LVDS_DISPLAY_DIS;\r\nOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\r\nudelay(100);\r\nlvds_gen_cntl &= ~(LVDS_ON | LVDS_EN);\r\nOUTREG(LVDS_GEN_CNTL, lvds_gen_cntl);\r\nlvds_gen_cntl &= ~(LVDS_DIGON);\r\nrinfo->pending_lvds_gen_cntl = lvds_gen_cntl;\r\nmod_timer(&rinfo->lvds_timer,\r\njiffies + msecs_to_jiffies(rinfo->panel_info.pwr_delay));\r\nif (rinfo->is_mobility || rinfo->is_IGP)\r\nOUTPLL(PIXCLKS_CNTL, tmpPixclksCntl);\r\n}\r\nrinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\r\nrinfo->init_state.lvds_gen_cntl |= (lvds_gen_cntl & LVDS_STATE_MASK);\r\nreturn 0;\r\n}\r\nvoid radeonfb_bl_init(struct radeonfb_info *rinfo)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bd;\r\nstruct radeon_bl_privdata *pdata;\r\nchar name[12];\r\nif (rinfo->mon1_type != MT_LCD)\r\nreturn;\r\n#ifdef CONFIG_PMAC_BACKLIGHT\r\nif (!pmac_has_backlight_type("ati") &&\r\n!pmac_has_backlight_type("mnca"))\r\nreturn;\r\n#endif\r\npdata = kmalloc(sizeof(struct radeon_bl_privdata), GFP_KERNEL);\r\nif (!pdata) {\r\nprintk("radeonfb: Memory allocation failed\n");\r\ngoto error;\r\n}\r\nsnprintf(name, sizeof(name), "radeonbl%d", rinfo->info->node);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = FB_BACKLIGHT_LEVELS - 1;\r\nbd = backlight_device_register(name, rinfo->info->dev, pdata,\r\n&radeon_bl_data, &props);\r\nif (IS_ERR(bd)) {\r\nrinfo->info->bl_dev = NULL;\r\nprintk("radeonfb: Backlight registration failed\n");\r\ngoto error;\r\n}\r\npdata->rinfo = rinfo;\r\npdata->negative =\r\n(rinfo->family != CHIP_FAMILY_RV200 &&\r\nrinfo->family != CHIP_FAMILY_RV250 &&\r\nrinfo->family != CHIP_FAMILY_RV280 &&\r\nrinfo->family != CHIP_FAMILY_RV350);\r\n#ifdef CONFIG_PMAC_BACKLIGHT\r\npdata->negative = pdata->negative ||\r\nof_machine_is_compatible("PowerBook4,3") ||\r\nof_machine_is_compatible("PowerBook6,3") ||\r\nof_machine_is_compatible("PowerBook6,5");\r\n#endif\r\nrinfo->info->bl_dev = bd;\r\nfb_bl_default_curve(rinfo->info, 0,\r\n63 * FB_BACKLIGHT_MAX / MAX_RADEON_LEVEL,\r\n217 * FB_BACKLIGHT_MAX / MAX_RADEON_LEVEL);\r\nbd->props.brightness = bd->props.max_brightness;\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(bd);\r\nprintk("radeonfb: Backlight initialized (%s)\n", name);\r\nreturn;\r\nerror:\r\nkfree(pdata);\r\nreturn;\r\n}\r\nvoid radeonfb_bl_exit(struct radeonfb_info *rinfo)\r\n{\r\nstruct backlight_device *bd = rinfo->info->bl_dev;\r\nif (bd) {\r\nstruct radeon_bl_privdata *pdata;\r\npdata = bl_get_data(bd);\r\nbacklight_device_unregister(bd);\r\nkfree(pdata);\r\nrinfo->info->bl_dev = NULL;\r\nprintk("radeonfb: Backlight unloaded\n");\r\n}\r\n}

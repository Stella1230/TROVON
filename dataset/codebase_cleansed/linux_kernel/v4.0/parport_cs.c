static int parport_probe(struct pcmcia_device *link)\r\n{\r\nparport_info_t *info;\r\ndev_dbg(&link->dev, "parport_attach()\n");\r\ninfo = kzalloc(sizeof(*info), GFP_KERNEL);\r\nif (!info) return -ENOMEM;\r\nlink->priv = info;\r\ninfo->p_dev = link;\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\nreturn parport_config(link);\r\n}\r\nstatic void parport_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "parport_detach\n");\r\nparport_cs_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int parport_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\np_dev->resource[1]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[1]->flags |= IO_DATA_PATH_WIDTH_8;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int parport_config(struct pcmcia_device *link)\r\n{\r\nparport_info_t *info = link->priv;\r\nstruct parport *p;\r\nint ret;\r\ndev_dbg(&link->dev, "parport_config\n");\r\nif (epp_mode)\r\nlink->config_index |= FORCE_EPP_MODE;\r\nret = pcmcia_loop_config(link, parport_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\np = parport_pc_probe_port(link->resource[0]->start,\r\nlink->resource[1]->start,\r\nlink->irq, PARPORT_DMA_NONE,\r\n&link->dev, IRQF_SHARED);\r\nif (p == NULL) {\r\nprintk(KERN_NOTICE "parport_cs: parport_pc_probe_port() at "\r\n"0x%3x, irq %u failed\n",\r\n(unsigned int) link->resource[0]->start,\r\nlink->irq);\r\ngoto failed;\r\n}\r\np->modes |= PARPORT_MODE_PCSPP;\r\nif (epp_mode)\r\np->modes |= PARPORT_MODE_TRISTATE | PARPORT_MODE_EPP;\r\ninfo->ndev = 1;\r\ninfo->port = p;\r\nreturn 0;\r\nfailed:\r\nparport_cs_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void parport_cs_release(struct pcmcia_device *link)\r\n{\r\nparport_info_t *info = link->priv;\r\ndev_dbg(&link->dev, "parport_release\n");\r\nif (info->ndev) {\r\nstruct parport *p = info->port;\r\nparport_pc_unregister_port(p);\r\n}\r\ninfo->ndev = 0;\r\npcmcia_disable_device(link);\r\n}

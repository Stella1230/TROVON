void __init r8a7779_map_io(void)\r\n{\r\ndebug_ll_io_init();\r\niotable_init(r8a7779_io_desc, ARRAY_SIZE(r8a7779_io_desc));\r\n}\r\nvoid __init r8a7779_init_irq_extpin_dt(int irlm)\r\n{\r\nvoid __iomem *icr0 = ioremap_nocache(0xfe780000, PAGE_SIZE);\r\nu32 tmp;\r\nif (!icr0) {\r\npr_warn("r8a7779: unable to setup external irq pin mode\n");\r\nreturn;\r\n}\r\ntmp = ioread32(icr0);\r\nif (irlm)\r\ntmp |= 1 << 23;\r\nelse\r\ntmp &= ~(1 << 23);\r\ntmp |= (1 << 21);\r\niowrite32(tmp, icr0);\r\niounmap(icr0);\r\n}\r\nvoid __init r8a7779_init_irq_extpin(int irlm)\r\n{\r\nr8a7779_init_irq_extpin_dt(irlm);\r\nif (irlm)\r\nplatform_device_register_resndata(\r\nNULL, "renesas_intc_irqpin", -1,\r\nirqpin0_resources, ARRAY_SIZE(irqpin0_resources),\r\n&irqpin0_platform_data, sizeof(irqpin0_platform_data));\r\n}\r\nvoid __init r8a7779_pinmux_init(void)\r\n{\r\nplatform_add_devices(r8a7779_pinctrl_devices,\r\nARRAY_SIZE(r8a7779_pinctrl_devices));\r\n}\r\nstatic int usb_power_on(struct platform_device *pdev)\r\n{\r\nif (IS_ERR(phy))\r\nreturn PTR_ERR(phy);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_get_sync(&pdev->dev);\r\nusb_phy_init(phy);\r\nreturn 0;\r\n}\r\nstatic void usb_power_off(struct platform_device *pdev)\r\n{\r\nif (IS_ERR(phy))\r\nreturn;\r\nusb_phy_shutdown(phy);\r\npm_runtime_put_sync(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\n}\r\nstatic int ehci_init_internal_buffer(struct usb_hcd *hcd)\r\n{\r\niowrite32(0x00ff0040, hcd->regs + 0x0094);\r\niowrite32(0x00000001, hcd->regs + 0x009C);\r\nreturn 0;\r\n}\r\nstatic void __init r8a7779_register_hpb_dmae(void)\r\n{\r\nplatform_device_register_resndata(NULL, "hpb-dma-engine",\r\n-1, hpb_dmae_resources,\r\nARRAY_SIZE(hpb_dmae_resources),\r\n&dma_platform_data,\r\nsizeof(dma_platform_data));\r\n}\r\nvoid __init r8a7779_add_standard_devices(void)\r\n{\r\n#ifdef CONFIG_CACHE_L2X0\r\nl2x0_init(IOMEM(0xf0100000), 0x00400000, 0xc20f0fff);\r\n#endif\r\nr8a7779_pm_init();\r\nr8a7779_init_pm_domains();\r\nplatform_add_devices(r8a7779_early_devices,\r\nARRAY_SIZE(r8a7779_early_devices));\r\nplatform_add_devices(r8a7779_standard_devices,\r\nARRAY_SIZE(r8a7779_standard_devices));\r\nr8a7779_register_hpb_dmae();\r\n}\r\nvoid __init r8a7779_add_early_devices(void)\r\n{\r\nearly_platform_add_devices(r8a7779_early_devices,\r\nARRAY_SIZE(r8a7779_early_devices));\r\n}\r\nvoid __init r8a7779_init_late(void)\r\n{\r\nphy = usb_get_phy(USB_PHY_TYPE_USB2);\r\nshmobile_init_late();\r\nplatform_add_devices(r8a7779_late_devices,\r\nARRAY_SIZE(r8a7779_late_devices));\r\n}\r\nstatic int r8a7779_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nreturn 0;\r\n}\r\nvoid __init r8a7779_init_irq_dt(void)\r\n{\r\n#ifdef CONFIG_ARCH_SHMOBILE_LEGACY\r\nvoid __iomem *gic_dist_base = ioremap_nocache(0xf0001000, 0x1000);\r\nvoid __iomem *gic_cpu_base = ioremap_nocache(0xf0000100, 0x1000);\r\n#endif\r\ngic_arch_extn.irq_set_wake = r8a7779_set_wake;\r\n#ifdef CONFIG_ARCH_SHMOBILE_LEGACY\r\ngic_init(0, 29, gic_dist_base, gic_cpu_base);\r\n#else\r\nirqchip_init();\r\n#endif\r\n__raw_writel(0xffffffff, INT2NTSR0);\r\n__raw_writel(0x3fffffff, INT2NTSR1);\r\n__raw_writel(0xfffffff0, INT2SMSKCR0);\r\n__raw_writel(0xfff7ffff, INT2SMSKCR1);\r\n__raw_writel(0xfffbffdf, INT2SMSKCR2);\r\n__raw_writel(0xbffffffc, INT2SMSKCR3);\r\n__raw_writel(0x003fee3f, INT2SMSKCR4);\r\n}\r\nu32 __init r8a7779_read_mode_pins(void)\r\n{\r\nstatic u32 mode;\r\nstatic bool mode_valid;\r\nif (!mode_valid) {\r\nvoid __iomem *modemr = ioremap_nocache(MODEMR, PAGE_SIZE);\r\nBUG_ON(!modemr);\r\nmode = ioread32(modemr);\r\niounmap(modemr);\r\nmode_valid = true;\r\n}\r\nreturn mode;\r\n}

static int mdio_mux_gpio_switch_fn(int current_child, int desired_child,\r\nvoid *data)\r\n{\r\nint values[MDIO_MUX_GPIO_MAX_BITS];\r\nunsigned int n;\r\nstruct mdio_mux_gpio_state *s = data;\r\nif (current_child == desired_child)\r\nreturn 0;\r\nfor (n = 0; n < s->num_gpios; n++) {\r\nvalues[n] = (desired_child >> n) & 1;\r\n}\r\ngpiod_set_array_cansleep(s->num_gpios, s->gpio, values);\r\nreturn 0;\r\n}\r\nstatic int mdio_mux_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct mdio_mux_gpio_state *s;\r\nint num_gpios;\r\nunsigned int n;\r\nint r;\r\nif (!pdev->dev.of_node)\r\nreturn -ENODEV;\r\nnum_gpios = of_gpio_count(pdev->dev.of_node);\r\nif (num_gpios <= 0 || num_gpios > MDIO_MUX_GPIO_MAX_BITS)\r\nreturn -ENODEV;\r\ns = devm_kzalloc(&pdev->dev, sizeof(*s), GFP_KERNEL);\r\nif (!s)\r\nreturn -ENOMEM;\r\ns->num_gpios = num_gpios;\r\nfor (n = 0; n < num_gpios; ) {\r\nstruct gpio_desc *gpio = gpiod_get_index(&pdev->dev, NULL, n,\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(gpio)) {\r\nr = PTR_ERR(gpio);\r\ngoto err;\r\n}\r\ns->gpio[n] = gpio;\r\nn++;\r\n}\r\nr = mdio_mux_init(&pdev->dev,\r\nmdio_mux_gpio_switch_fn, &s->mux_handle, s);\r\nif (r == 0) {\r\npdev->dev.platform_data = s;\r\nreturn 0;\r\n}\r\nerr:\r\nwhile (n) {\r\nn--;\r\ngpiod_put(s->gpio[n]);\r\n}\r\nreturn r;\r\n}\r\nstatic int mdio_mux_gpio_remove(struct platform_device *pdev)\r\n{\r\nunsigned int n;\r\nstruct mdio_mux_gpio_state *s = dev_get_platdata(&pdev->dev);\r\nmdio_mux_uninit(s->mux_handle);\r\nfor (n = 0; n < s->num_gpios; n++)\r\ngpiod_put(s->gpio[n]);\r\nreturn 0;\r\n}

STATIC int\r\nxfs_inobt_get_minrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_inobt_mnr[level != 0];\r\n}\r\nSTATIC struct xfs_btree_cur *\r\nxfs_inobt_dup_cursor(\r\nstruct xfs_btree_cur *cur)\r\n{\r\nreturn xfs_inobt_init_cursor(cur->bc_mp, cur->bc_tp,\r\ncur->bc_private.a.agbp, cur->bc_private.a.agno,\r\ncur->bc_btnum);\r\n}\r\nSTATIC void\r\nxfs_inobt_set_root(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *nptr,\r\nint inc)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agi *agi = XFS_BUF_TO_AGI(agbp);\r\nagi->agi_root = nptr->s;\r\nbe32_add_cpu(&agi->agi_level, inc);\r\nxfs_ialloc_log_agi(cur->bc_tp, agbp, XFS_AGI_ROOT | XFS_AGI_LEVEL);\r\n}\r\nSTATIC void\r\nxfs_finobt_set_root(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *nptr,\r\nint inc)\r\n{\r\nstruct xfs_buf *agbp = cur->bc_private.a.agbp;\r\nstruct xfs_agi *agi = XFS_BUF_TO_AGI(agbp);\r\nagi->agi_free_root = nptr->s;\r\nbe32_add_cpu(&agi->agi_free_level, inc);\r\nxfs_ialloc_log_agi(cur->bc_tp, agbp,\r\nXFS_AGI_FREE_ROOT | XFS_AGI_FREE_LEVEL);\r\n}\r\nSTATIC int\r\nxfs_inobt_alloc_block(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *start,\r\nunion xfs_btree_ptr *new,\r\nint *stat)\r\n{\r\nxfs_alloc_arg_t args;\r\nint error;\r\nxfs_agblock_t sbno = be32_to_cpu(start->s);\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ENTRY);\r\nmemset(&args, 0, sizeof(args));\r\nargs.tp = cur->bc_tp;\r\nargs.mp = cur->bc_mp;\r\nargs.fsbno = XFS_AGB_TO_FSB(args.mp, cur->bc_private.a.agno, sbno);\r\nargs.minlen = 1;\r\nargs.maxlen = 1;\r\nargs.prod = 1;\r\nargs.type = XFS_ALLOCTYPE_NEAR_BNO;\r\nerror = xfs_alloc_vextent(&args);\r\nif (error) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ERROR);\r\nreturn error;\r\n}\r\nif (args.fsbno == NULLFSBLOCK) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 0;\r\nreturn 0;\r\n}\r\nASSERT(args.len == 1);\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\nnew->s = cpu_to_be32(XFS_FSB_TO_AGBNO(args.mp, args.fsbno));\r\n*stat = 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_inobt_free_block(\r\nstruct xfs_btree_cur *cur,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_fsblock_t fsbno;\r\nint error;\r\nfsbno = XFS_DADDR_TO_FSB(cur->bc_mp, XFS_BUF_ADDR(bp));\r\nerror = xfs_free_extent(cur->bc_tp, fsbno, 1);\r\nif (error)\r\nreturn error;\r\nxfs_trans_binval(cur->bc_tp, bp);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_inobt_get_maxrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nreturn cur->bc_mp->m_inobt_mxr[level != 0];\r\n}\r\nSTATIC void\r\nxfs_inobt_init_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nkey->inobt.ir_startino = rec->inobt.ir_startino;\r\n}\r\nSTATIC void\r\nxfs_inobt_init_rec_from_key(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nrec->inobt.ir_startino = key->inobt.ir_startino;\r\n}\r\nSTATIC void\r\nxfs_inobt_init_rec_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *rec)\r\n{\r\nrec->inobt.ir_startino = cpu_to_be32(cur->bc_rec.i.ir_startino);\r\nrec->inobt.ir_freecount = cpu_to_be32(cur->bc_rec.i.ir_freecount);\r\nrec->inobt.ir_free = cpu_to_be64(cur->bc_rec.i.ir_free);\r\n}\r\nSTATIC void\r\nxfs_inobt_init_ptr_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr)\r\n{\r\nstruct xfs_agi *agi = XFS_BUF_TO_AGI(cur->bc_private.a.agbp);\r\nASSERT(cur->bc_private.a.agno == be32_to_cpu(agi->agi_seqno));\r\nptr->s = agi->agi_root;\r\n}\r\nSTATIC void\r\nxfs_finobt_init_ptr_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr)\r\n{\r\nstruct xfs_agi *agi = XFS_BUF_TO_AGI(cur->bc_private.a.agbp);\r\nASSERT(cur->bc_private.a.agno == be32_to_cpu(agi->agi_seqno));\r\nptr->s = agi->agi_free_root;\r\n}\r\nSTATIC __int64_t\r\nxfs_inobt_key_diff(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *key)\r\n{\r\nreturn (__int64_t)be32_to_cpu(key->inobt.ir_startino) -\r\ncur->bc_rec.i.ir_startino;\r\n}\r\nstatic int\r\nxfs_inobt_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_btree_block *block = XFS_BUF_TO_BLOCK(bp);\r\nstruct xfs_perag *pag = bp->b_pag;\r\nunsigned int level;\r\nswitch (block->bb_magic) {\r\ncase cpu_to_be32(XFS_IBT_CRC_MAGIC):\r\ncase cpu_to_be32(XFS_FIBT_CRC_MAGIC):\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn false;\r\nif (!uuid_equal(&block->bb_u.s.bb_uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\nif (block->bb_u.s.bb_blkno != cpu_to_be64(bp->b_bn))\r\nreturn false;\r\nif (pag &&\r\nbe32_to_cpu(block->bb_u.s.bb_owner) != pag->pag_agno)\r\nreturn false;\r\ncase cpu_to_be32(XFS_IBT_MAGIC):\r\ncase cpu_to_be32(XFS_FIBT_MAGIC):\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nlevel = be16_to_cpu(block->bb_level);\r\nif (level >= mp->m_in_maxlevels)\r\nreturn false;\r\nif (be16_to_cpu(block->bb_numrecs) > mp->m_inobt_mxr[level != 0])\r\nreturn false;\r\nif (!block->bb_u.s.bb_leftsib ||\r\n(be32_to_cpu(block->bb_u.s.bb_leftsib) >= mp->m_sb.sb_agblocks &&\r\nblock->bb_u.s.bb_leftsib != cpu_to_be32(NULLAGBLOCK)))\r\nreturn false;\r\nif (!block->bb_u.s.bb_rightsib ||\r\n(be32_to_cpu(block->bb_u.s.bb_rightsib) >= mp->m_sb.sb_agblocks &&\r\nblock->bb_u.s.bb_rightsib != cpu_to_be32(NULLAGBLOCK)))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_inobt_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_btree_sblock_verify_crc(bp))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_inobt_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_verifier_error(bp);\r\n}\r\n}\r\nstatic void\r\nxfs_inobt_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_inobt_verify(bp)) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nxfs_btree_sblock_calc_crc(bp);\r\n}\r\nSTATIC int\r\nxfs_inobt_keys_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\nreturn be32_to_cpu(k1->inobt.ir_startino) <\r\nbe32_to_cpu(k2->inobt.ir_startino);\r\n}\r\nSTATIC int\r\nxfs_inobt_recs_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *r1,\r\nunion xfs_btree_rec *r2)\r\n{\r\nreturn be32_to_cpu(r1->inobt.ir_startino) + XFS_INODES_PER_CHUNK <=\r\nbe32_to_cpu(r2->inobt.ir_startino);\r\n}\r\nstruct xfs_btree_cur *\r\nxfs_inobt_init_cursor(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *agbp,\r\nxfs_agnumber_t agno,\r\nxfs_btnum_t btnum)\r\n{\r\nstruct xfs_agi *agi = XFS_BUF_TO_AGI(agbp);\r\nstruct xfs_btree_cur *cur;\r\ncur = kmem_zone_zalloc(xfs_btree_cur_zone, KM_SLEEP);\r\ncur->bc_tp = tp;\r\ncur->bc_mp = mp;\r\ncur->bc_btnum = btnum;\r\nif (btnum == XFS_BTNUM_INO) {\r\ncur->bc_nlevels = be32_to_cpu(agi->agi_level);\r\ncur->bc_ops = &xfs_inobt_ops;\r\n} else {\r\ncur->bc_nlevels = be32_to_cpu(agi->agi_free_level);\r\ncur->bc_ops = &xfs_finobt_ops;\r\n}\r\ncur->bc_blocklog = mp->m_sb.sb_blocklog;\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\ncur->bc_flags |= XFS_BTREE_CRC_BLOCKS;\r\ncur->bc_private.a.agbp = agbp;\r\ncur->bc_private.a.agno = agno;\r\nreturn cur;\r\n}\r\nint\r\nxfs_inobt_maxrecs(\r\nstruct xfs_mount *mp,\r\nint blocklen,\r\nint leaf)\r\n{\r\nblocklen -= XFS_INOBT_BLOCK_LEN(mp);\r\nif (leaf)\r\nreturn blocklen / sizeof(xfs_inobt_rec_t);\r\nreturn blocklen / (sizeof(xfs_inobt_key_t) + sizeof(xfs_inobt_ptr_t));\r\n}

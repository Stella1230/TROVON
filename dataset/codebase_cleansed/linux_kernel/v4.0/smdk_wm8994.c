static int smdk_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nunsigned int pll_out;\r\nint ret;\r\nif (params_width(params) == 24)\r\npll_out = params_rate(params) * 384;\r\nelse if (params_rate(params) == 8000 || params_rate(params) == 11025)\r\npll_out = params_rate(params) * 512;\r\nelse\r\npll_out = params_rate(params) * 256;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8994_FLL1, WM8994_FLL_SRC_MCLK1,\r\nSMDK_WM8994_FREQ, pll_out);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_FLL1,\r\npll_out, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int smdk_wm8994_init_paiftx(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_nc_pin(dapm, "HPOUT2P");\r\nsnd_soc_dapm_nc_pin(dapm, "HPOUT2N");\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTLN");\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTLP");\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTRP");\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTRN");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT1N");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT1P");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT2N");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT2P");\r\nsnd_soc_dapm_nc_pin(dapm, "IN1LP");\r\nsnd_soc_dapm_nc_pin(dapm, "IN2LP:VXRN");\r\nsnd_soc_dapm_nc_pin(dapm, "IN1RP");\r\nsnd_soc_dapm_nc_pin(dapm, "IN2RP:VXRP");\r\nreturn 0;\r\n}\r\nstatic int smdk_audio_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct snd_soc_card *card = &smdk;\r\nstruct smdk_wm8994_data *board;\r\nconst struct of_device_id *id;\r\ncard->dev = &pdev->dev;\r\nboard = devm_kzalloc(&pdev->dev, sizeof(*board), GFP_KERNEL);\r\nif (!board)\r\nreturn -ENOMEM;\r\nif (np) {\r\nsmdk_dai[0].cpu_dai_name = NULL;\r\nsmdk_dai[0].cpu_of_node = of_parse_phandle(np,\r\n"samsung,i2s-controller", 0);\r\nif (!smdk_dai[0].cpu_of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'samsung,i2s-controller' missing or invalid\n");\r\nret = -EINVAL;\r\n}\r\nsmdk_dai[0].platform_name = NULL;\r\nsmdk_dai[0].platform_of_node = smdk_dai[0].cpu_of_node;\r\n}\r\nid = of_match_device(of_match_ptr(samsung_wm8994_of_match), &pdev->dev);\r\nif (id)\r\n*board = *((struct smdk_wm8994_data *)id->data);\r\nplatform_set_drvdata(pdev, board);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "snd_soc_register_card() failed:%d\n", ret);\r\nreturn ret;\r\n}

int irq_set_chip(unsigned int irq, struct irq_chip *chip)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_lock(irq, &flags, 0);\r\nif (!desc)\r\nreturn -EINVAL;\r\nif (!chip)\r\nchip = &no_irq_chip;\r\ndesc->irq_data.chip = chip;\r\nirq_put_desc_unlock(desc, flags);\r\nirq_mark_irq(irq);\r\nreturn 0;\r\n}\r\nint irq_set_irq_type(unsigned int irq, unsigned int type)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_buslock(irq, &flags, IRQ_GET_DESC_CHECK_GLOBAL);\r\nint ret = 0;\r\nif (!desc)\r\nreturn -EINVAL;\r\ntype &= IRQ_TYPE_SENSE_MASK;\r\nret = __irq_set_trigger(desc, irq, type);\r\nirq_put_desc_busunlock(desc, flags);\r\nreturn ret;\r\n}\r\nint irq_set_handler_data(unsigned int irq, void *data)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_lock(irq, &flags, 0);\r\nif (!desc)\r\nreturn -EINVAL;\r\ndesc->irq_data.handler_data = data;\r\nirq_put_desc_unlock(desc, flags);\r\nreturn 0;\r\n}\r\nint irq_set_msi_desc_off(unsigned int irq_base, unsigned int irq_offset,\r\nstruct msi_desc *entry)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_lock(irq_base + irq_offset, &flags, IRQ_GET_DESC_CHECK_GLOBAL);\r\nif (!desc)\r\nreturn -EINVAL;\r\ndesc->irq_data.msi_desc = entry;\r\nif (entry && !irq_offset)\r\nentry->irq = irq_base;\r\nirq_put_desc_unlock(desc, flags);\r\nreturn 0;\r\n}\r\nint irq_set_msi_desc(unsigned int irq, struct msi_desc *entry)\r\n{\r\nreturn irq_set_msi_desc_off(irq, 0, entry);\r\n}\r\nint irq_set_chip_data(unsigned int irq, void *data)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_lock(irq, &flags, 0);\r\nif (!desc)\r\nreturn -EINVAL;\r\ndesc->irq_data.chip_data = data;\r\nirq_put_desc_unlock(desc, flags);\r\nreturn 0;\r\n}\r\nstruct irq_data *irq_get_irq_data(unsigned int irq)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(irq);\r\nreturn desc ? &desc->irq_data : NULL;\r\n}\r\nstatic void irq_state_clr_disabled(struct irq_desc *desc)\r\n{\r\nirqd_clear(&desc->irq_data, IRQD_IRQ_DISABLED);\r\n}\r\nstatic void irq_state_set_disabled(struct irq_desc *desc)\r\n{\r\nirqd_set(&desc->irq_data, IRQD_IRQ_DISABLED);\r\n}\r\nstatic void irq_state_clr_masked(struct irq_desc *desc)\r\n{\r\nirqd_clear(&desc->irq_data, IRQD_IRQ_MASKED);\r\n}\r\nstatic void irq_state_set_masked(struct irq_desc *desc)\r\n{\r\nirqd_set(&desc->irq_data, IRQD_IRQ_MASKED);\r\n}\r\nint irq_startup(struct irq_desc *desc, bool resend)\r\n{\r\nint ret = 0;\r\nirq_state_clr_disabled(desc);\r\ndesc->depth = 0;\r\nirq_domain_activate_irq(&desc->irq_data);\r\nif (desc->irq_data.chip->irq_startup) {\r\nret = desc->irq_data.chip->irq_startup(&desc->irq_data);\r\nirq_state_clr_masked(desc);\r\n} else {\r\nirq_enable(desc);\r\n}\r\nif (resend)\r\ncheck_irq_resend(desc, desc->irq_data.irq);\r\nreturn ret;\r\n}\r\nvoid irq_shutdown(struct irq_desc *desc)\r\n{\r\nirq_state_set_disabled(desc);\r\ndesc->depth = 1;\r\nif (desc->irq_data.chip->irq_shutdown)\r\ndesc->irq_data.chip->irq_shutdown(&desc->irq_data);\r\nelse if (desc->irq_data.chip->irq_disable)\r\ndesc->irq_data.chip->irq_disable(&desc->irq_data);\r\nelse\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\nirq_domain_deactivate_irq(&desc->irq_data);\r\nirq_state_set_masked(desc);\r\n}\r\nvoid irq_enable(struct irq_desc *desc)\r\n{\r\nirq_state_clr_disabled(desc);\r\nif (desc->irq_data.chip->irq_enable)\r\ndesc->irq_data.chip->irq_enable(&desc->irq_data);\r\nelse\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\nirq_state_clr_masked(desc);\r\n}\r\nvoid irq_disable(struct irq_desc *desc)\r\n{\r\nirq_state_set_disabled(desc);\r\nif (desc->irq_data.chip->irq_disable) {\r\ndesc->irq_data.chip->irq_disable(&desc->irq_data);\r\nirq_state_set_masked(desc);\r\n}\r\n}\r\nvoid irq_percpu_enable(struct irq_desc *desc, unsigned int cpu)\r\n{\r\nif (desc->irq_data.chip->irq_enable)\r\ndesc->irq_data.chip->irq_enable(&desc->irq_data);\r\nelse\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\ncpumask_set_cpu(cpu, desc->percpu_enabled);\r\n}\r\nvoid irq_percpu_disable(struct irq_desc *desc, unsigned int cpu)\r\n{\r\nif (desc->irq_data.chip->irq_disable)\r\ndesc->irq_data.chip->irq_disable(&desc->irq_data);\r\nelse\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\ncpumask_clear_cpu(cpu, desc->percpu_enabled);\r\n}\r\nstatic inline void mask_ack_irq(struct irq_desc *desc)\r\n{\r\nif (desc->irq_data.chip->irq_mask_ack)\r\ndesc->irq_data.chip->irq_mask_ack(&desc->irq_data);\r\nelse {\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\nif (desc->irq_data.chip->irq_ack)\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\n}\r\nirq_state_set_masked(desc);\r\n}\r\nvoid mask_irq(struct irq_desc *desc)\r\n{\r\nif (desc->irq_data.chip->irq_mask) {\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\nirq_state_set_masked(desc);\r\n}\r\n}\r\nvoid unmask_irq(struct irq_desc *desc)\r\n{\r\nif (desc->irq_data.chip->irq_unmask) {\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\nirq_state_clr_masked(desc);\r\n}\r\n}\r\nvoid unmask_threaded_irq(struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = desc->irq_data.chip;\r\nif (chip->flags & IRQCHIP_EOI_THREADED)\r\nchip->irq_eoi(&desc->irq_data);\r\nif (chip->irq_unmask) {\r\nchip->irq_unmask(&desc->irq_data);\r\nirq_state_clr_masked(desc);\r\n}\r\n}\r\nvoid handle_nested_irq(unsigned int irq)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(irq);\r\nstruct irqaction *action;\r\nirqreturn_t action_ret;\r\nmight_sleep();\r\nraw_spin_lock_irq(&desc->lock);\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\naction = desc->action;\r\nif (unlikely(!action || irqd_irq_disabled(&desc->irq_data))) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out_unlock;\r\n}\r\nirqd_set(&desc->irq_data, IRQD_IRQ_INPROGRESS);\r\nraw_spin_unlock_irq(&desc->lock);\r\naction_ret = action->thread_fn(action->irq, action->dev_id);\r\nif (!noirqdebug)\r\nnote_interrupt(irq, desc, action_ret);\r\nraw_spin_lock_irq(&desc->lock);\r\nirqd_clear(&desc->irq_data, IRQD_IRQ_INPROGRESS);\r\nout_unlock:\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nstatic bool irq_check_poll(struct irq_desc *desc)\r\n{\r\nif (!(desc->istate & IRQS_POLL_INPROGRESS))\r\nreturn false;\r\nreturn irq_wait_for_poll(desc);\r\n}\r\nstatic bool irq_may_run(struct irq_desc *desc)\r\n{\r\nunsigned int mask = IRQD_IRQ_INPROGRESS | IRQD_WAKEUP_ARMED;\r\nif (!irqd_has_set(&desc->irq_data, mask))\r\nreturn true;\r\nif (irq_pm_check_wakeup(desc))\r\nreturn false;\r\nreturn irq_check_poll(desc);\r\n}\r\nvoid\r\nhandle_simple_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nraw_spin_lock(&desc->lock);\r\nif (!irq_may_run(desc))\r\ngoto out_unlock;\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\nif (unlikely(!desc->action || irqd_irq_disabled(&desc->irq_data))) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out_unlock;\r\n}\r\nhandle_irq_event(desc);\r\nout_unlock:\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nstatic void cond_unmask_irq(struct irq_desc *desc)\r\n{\r\nif (!irqd_irq_disabled(&desc->irq_data) &&\r\nirqd_irq_masked(&desc->irq_data) && !desc->threads_oneshot)\r\nunmask_irq(desc);\r\n}\r\nvoid\r\nhandle_level_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nraw_spin_lock(&desc->lock);\r\nmask_ack_irq(desc);\r\nif (!irq_may_run(desc))\r\ngoto out_unlock;\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\nif (unlikely(!desc->action || irqd_irq_disabled(&desc->irq_data))) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out_unlock;\r\n}\r\nhandle_irq_event(desc);\r\ncond_unmask_irq(desc);\r\nout_unlock:\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nstatic inline void preflow_handler(struct irq_desc *desc)\r\n{\r\nif (desc->preflow_handler)\r\ndesc->preflow_handler(&desc->irq_data);\r\n}\r\nstatic inline void preflow_handler(struct irq_desc *desc) { }\r\nstatic void cond_unmask_eoi_irq(struct irq_desc *desc, struct irq_chip *chip)\r\n{\r\nif (!(desc->istate & IRQS_ONESHOT)) {\r\nchip->irq_eoi(&desc->irq_data);\r\nreturn;\r\n}\r\nif (!irqd_irq_disabled(&desc->irq_data) &&\r\nirqd_irq_masked(&desc->irq_data) && !desc->threads_oneshot) {\r\nchip->irq_eoi(&desc->irq_data);\r\nunmask_irq(desc);\r\n} else if (!(chip->flags & IRQCHIP_EOI_THREADED)) {\r\nchip->irq_eoi(&desc->irq_data);\r\n}\r\n}\r\nvoid\r\nhandle_fasteoi_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = desc->irq_data.chip;\r\nraw_spin_lock(&desc->lock);\r\nif (!irq_may_run(desc))\r\ngoto out;\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\nif (unlikely(!desc->action || irqd_irq_disabled(&desc->irq_data))) {\r\ndesc->istate |= IRQS_PENDING;\r\nmask_irq(desc);\r\ngoto out;\r\n}\r\nif (desc->istate & IRQS_ONESHOT)\r\nmask_irq(desc);\r\npreflow_handler(desc);\r\nhandle_irq_event(desc);\r\ncond_unmask_eoi_irq(desc, chip);\r\nraw_spin_unlock(&desc->lock);\r\nreturn;\r\nout:\r\nif (!(chip->flags & IRQCHIP_EOI_IF_HANDLED))\r\nchip->irq_eoi(&desc->irq_data);\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nvoid\r\nhandle_edge_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nraw_spin_lock(&desc->lock);\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nif (!irq_may_run(desc)) {\r\ndesc->istate |= IRQS_PENDING;\r\nmask_ack_irq(desc);\r\ngoto out_unlock;\r\n}\r\nif (irqd_irq_disabled(&desc->irq_data) || !desc->action) {\r\ndesc->istate |= IRQS_PENDING;\r\nmask_ack_irq(desc);\r\ngoto out_unlock;\r\n}\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\ndo {\r\nif (unlikely(!desc->action)) {\r\nmask_irq(desc);\r\ngoto out_unlock;\r\n}\r\nif (unlikely(desc->istate & IRQS_PENDING)) {\r\nif (!irqd_irq_disabled(&desc->irq_data) &&\r\nirqd_irq_masked(&desc->irq_data))\r\nunmask_irq(desc);\r\n}\r\nhandle_irq_event(desc);\r\n} while ((desc->istate & IRQS_PENDING) &&\r\n!irqd_irq_disabled(&desc->irq_data));\r\nout_unlock:\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nvoid handle_edge_eoi_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nraw_spin_lock(&desc->lock);\r\ndesc->istate &= ~(IRQS_REPLAY | IRQS_WAITING);\r\nif (!irq_may_run(desc)) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out_eoi;\r\n}\r\nif (irqd_irq_disabled(&desc->irq_data) || !desc->action) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out_eoi;\r\n}\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\ndo {\r\nif (unlikely(!desc->action))\r\ngoto out_eoi;\r\nhandle_irq_event(desc);\r\n} while ((desc->istate & IRQS_PENDING) &&\r\n!irqd_irq_disabled(&desc->irq_data));\r\nout_eoi:\r\nchip->irq_eoi(&desc->irq_data);\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nvoid\r\nhandle_percpu_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\nif (chip->irq_ack)\r\nchip->irq_ack(&desc->irq_data);\r\nhandle_irq_event_percpu(desc, desc->action);\r\nif (chip->irq_eoi)\r\nchip->irq_eoi(&desc->irq_data);\r\n}\r\nvoid handle_percpu_devid_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nstruct irqaction *action = desc->action;\r\nvoid *dev_id = raw_cpu_ptr(action->percpu_dev_id);\r\nirqreturn_t res;\r\nkstat_incr_irqs_this_cpu(irq, desc);\r\nif (chip->irq_ack)\r\nchip->irq_ack(&desc->irq_data);\r\ntrace_irq_handler_entry(irq, action);\r\nres = action->handler(irq, dev_id);\r\ntrace_irq_handler_exit(irq, action, res);\r\nif (chip->irq_eoi)\r\nchip->irq_eoi(&desc->irq_data);\r\n}\r\nvoid\r\n__irq_set_handler(unsigned int irq, irq_flow_handler_t handle, int is_chained,\r\nconst char *name)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_buslock(irq, &flags, 0);\r\nif (!desc)\r\nreturn;\r\nif (!handle) {\r\nhandle = handle_bad_irq;\r\n} else {\r\nstruct irq_data *irq_data = &desc->irq_data;\r\n#ifdef CONFIG_IRQ_DOMAIN_HIERARCHY\r\nwhile (irq_data) {\r\nif (irq_data->chip != &no_irq_chip)\r\nbreak;\r\nif (WARN_ON(is_chained))\r\ngoto out;\r\nirq_data = irq_data->parent_data;\r\n}\r\n#endif\r\nif (WARN_ON(!irq_data || irq_data->chip == &no_irq_chip))\r\ngoto out;\r\n}\r\nif (handle == handle_bad_irq) {\r\nif (desc->irq_data.chip != &no_irq_chip)\r\nmask_ack_irq(desc);\r\nirq_state_set_disabled(desc);\r\ndesc->depth = 1;\r\n}\r\ndesc->handle_irq = handle;\r\ndesc->name = name;\r\nif (handle != handle_bad_irq && is_chained) {\r\nirq_settings_set_noprobe(desc);\r\nirq_settings_set_norequest(desc);\r\nirq_settings_set_nothread(desc);\r\nirq_startup(desc, true);\r\n}\r\nout:\r\nirq_put_desc_busunlock(desc, flags);\r\n}\r\nvoid\r\nirq_set_chip_and_handler_name(unsigned int irq, struct irq_chip *chip,\r\nirq_flow_handler_t handle, const char *name)\r\n{\r\nirq_set_chip(irq, chip);\r\n__irq_set_handler(irq, handle, 0, name);\r\n}\r\nvoid irq_modify_status(unsigned int irq, unsigned long clr, unsigned long set)\r\n{\r\nunsigned long flags;\r\nstruct irq_desc *desc = irq_get_desc_lock(irq, &flags, 0);\r\nif (!desc)\r\nreturn;\r\nirq_settings_clr_and_set(desc, clr, set);\r\nirqd_clear(&desc->irq_data, IRQD_NO_BALANCING | IRQD_PER_CPU |\r\nIRQD_TRIGGER_MASK | IRQD_LEVEL | IRQD_MOVE_PCNTXT);\r\nif (irq_settings_has_no_balance_set(desc))\r\nirqd_set(&desc->irq_data, IRQD_NO_BALANCING);\r\nif (irq_settings_is_per_cpu(desc))\r\nirqd_set(&desc->irq_data, IRQD_PER_CPU);\r\nif (irq_settings_can_move_pcntxt(desc))\r\nirqd_set(&desc->irq_data, IRQD_MOVE_PCNTXT);\r\nif (irq_settings_is_level(desc))\r\nirqd_set(&desc->irq_data, IRQD_LEVEL);\r\nirqd_set(&desc->irq_data, irq_settings_get_trigger_mask(desc));\r\nirq_put_desc_unlock(desc, flags);\r\n}\r\nvoid irq_cpu_online(void)\r\n{\r\nstruct irq_desc *desc;\r\nstruct irq_chip *chip;\r\nunsigned long flags;\r\nunsigned int irq;\r\nfor_each_active_irq(irq) {\r\ndesc = irq_to_desc(irq);\r\nif (!desc)\r\ncontinue;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nchip = irq_data_get_irq_chip(&desc->irq_data);\r\nif (chip && chip->irq_cpu_online &&\r\n(!(chip->flags & IRQCHIP_ONOFFLINE_ENABLED) ||\r\n!irqd_irq_disabled(&desc->irq_data)))\r\nchip->irq_cpu_online(&desc->irq_data);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid irq_cpu_offline(void)\r\n{\r\nstruct irq_desc *desc;\r\nstruct irq_chip *chip;\r\nunsigned long flags;\r\nunsigned int irq;\r\nfor_each_active_irq(irq) {\r\ndesc = irq_to_desc(irq);\r\nif (!desc)\r\ncontinue;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nchip = irq_data_get_irq_chip(&desc->irq_data);\r\nif (chip && chip->irq_cpu_offline &&\r\n(!(chip->flags & IRQCHIP_ONOFFLINE_ENABLED) ||\r\n!irqd_irq_disabled(&desc->irq_data)))\r\nchip->irq_cpu_offline(&desc->irq_data);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid irq_chip_ack_parent(struct irq_data *data)\r\n{\r\ndata = data->parent_data;\r\ndata->chip->irq_ack(data);\r\n}\r\nvoid irq_chip_mask_parent(struct irq_data *data)\r\n{\r\ndata = data->parent_data;\r\ndata->chip->irq_mask(data);\r\n}\r\nvoid irq_chip_unmask_parent(struct irq_data *data)\r\n{\r\ndata = data->parent_data;\r\ndata->chip->irq_unmask(data);\r\n}\r\nvoid irq_chip_eoi_parent(struct irq_data *data)\r\n{\r\ndata = data->parent_data;\r\ndata->chip->irq_eoi(data);\r\n}\r\nint irq_chip_set_affinity_parent(struct irq_data *data,\r\nconst struct cpumask *dest, bool force)\r\n{\r\ndata = data->parent_data;\r\nif (data->chip->irq_set_affinity)\r\nreturn data->chip->irq_set_affinity(data, dest, force);\r\nreturn -ENOSYS;\r\n}\r\nint irq_chip_retrigger_hierarchy(struct irq_data *data)\r\n{\r\nfor (data = data->parent_data; data; data = data->parent_data)\r\nif (data->chip && data->chip->irq_retrigger)\r\nreturn data->chip->irq_retrigger(data);\r\nreturn -ENOSYS;\r\n}\r\nint irq_chip_compose_msi_msg(struct irq_data *data, struct msi_msg *msg)\r\n{\r\nstruct irq_data *pos = NULL;\r\n#ifdef CONFIG_IRQ_DOMAIN_HIERARCHY\r\nfor (; data; data = data->parent_data)\r\n#endif\r\nif (data->chip && data->chip->irq_compose_msi_msg)\r\npos = data;\r\nif (!pos)\r\nreturn -ENOSYS;\r\npos->chip->irq_compose_msi_msg(pos, msg);\r\nreturn 0;\r\n}

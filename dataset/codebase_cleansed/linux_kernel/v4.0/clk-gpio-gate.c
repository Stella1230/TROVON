static int clk_gpio_gate_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_gpio *clk = to_clk_gpio(hw);\r\ngpiod_set_value(clk->gpiod, 1);\r\nreturn 0;\r\n}\r\nstatic void clk_gpio_gate_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_gpio *clk = to_clk_gpio(hw);\r\ngpiod_set_value(clk->gpiod, 0);\r\n}\r\nstatic int clk_gpio_gate_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_gpio *clk = to_clk_gpio(hw);\r\nreturn gpiod_get_value(clk->gpiod);\r\n}\r\nstruct clk *clk_register_gpio_gate(struct device *dev, const char *name,\r\nconst char *parent_name, struct gpio_desc *gpiod,\r\nunsigned long flags)\r\n{\r\nstruct clk_gpio *clk_gpio = NULL;\r\nstruct clk *clk = ERR_PTR(-EINVAL);\r\nstruct clk_init_data init = { NULL };\r\nunsigned long gpio_flags;\r\nint err;\r\nif (gpiod_is_active_low(gpiod))\r\ngpio_flags = GPIOF_OUT_INIT_HIGH;\r\nelse\r\ngpio_flags = GPIOF_OUT_INIT_LOW;\r\nif (dev)\r\nerr = devm_gpio_request_one(dev, desc_to_gpio(gpiod),\r\ngpio_flags, name);\r\nelse\r\nerr = gpio_request_one(desc_to_gpio(gpiod), gpio_flags, name);\r\nif (err) {\r\npr_err("%s: %s: Error requesting clock control gpio %u\n",\r\n__func__, name, desc_to_gpio(gpiod));\r\nreturn ERR_PTR(err);\r\n}\r\nif (dev)\r\nclk_gpio = devm_kzalloc(dev, sizeof(struct clk_gpio),\r\nGFP_KERNEL);\r\nelse\r\nclk_gpio = kzalloc(sizeof(struct clk_gpio), GFP_KERNEL);\r\nif (!clk_gpio) {\r\nclk = ERR_PTR(-ENOMEM);\r\ngoto clk_register_gpio_gate_err;\r\n}\r\ninit.name = name;\r\ninit.ops = &clk_gpio_gate_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nclk_gpio->gpiod = gpiod;\r\nclk_gpio->hw.init = &init;\r\nclk = clk_register(dev, &clk_gpio->hw);\r\nif (!IS_ERR(clk))\r\nreturn clk;\r\nif (!dev)\r\nkfree(clk_gpio);\r\nclk_register_gpio_gate_err:\r\ngpiod_put(gpiod);\r\nreturn clk;\r\n}\r\nstatic struct clk *of_clk_gpio_gate_delayed_register_get(\r\nstruct of_phandle_args *clkspec,\r\nvoid *_data)\r\n{\r\nstruct clk_gpio_gate_delayed_register_data *data = _data;\r\nstruct clk *clk;\r\nconst char *clk_name = data->node->name;\r\nconst char *parent_name;\r\nstruct gpio_desc *gpiod;\r\nint gpio;\r\nmutex_lock(&data->lock);\r\nif (data->clk) {\r\nmutex_unlock(&data->lock);\r\nreturn data->clk;\r\n}\r\ngpio = of_get_named_gpio_flags(data->node, "enable-gpios", 0, NULL);\r\nif (gpio < 0) {\r\nmutex_unlock(&data->lock);\r\nif (gpio != -EPROBE_DEFER)\r\npr_err("%s: %s: Can't get 'enable-gpios' DT property\n",\r\n__func__, clk_name);\r\nreturn ERR_PTR(gpio);\r\n}\r\ngpiod = gpio_to_desc(gpio);\r\nparent_name = of_clk_get_parent_name(data->node, 0);\r\nclk = clk_register_gpio_gate(NULL, clk_name, parent_name, gpiod, 0);\r\nif (IS_ERR(clk)) {\r\nmutex_unlock(&data->lock);\r\nreturn clk;\r\n}\r\ndata->clk = clk;\r\nmutex_unlock(&data->lock);\r\nreturn clk;\r\n}\r\nvoid __init of_gpio_gate_clk_setup(struct device_node *node)\r\n{\r\nstruct clk_gpio_gate_delayed_register_data *data;\r\ndata = kzalloc(sizeof(struct clk_gpio_gate_delayed_register_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn;\r\ndata->node = node;\r\nmutex_init(&data->lock);\r\nof_clk_add_provider(node, of_clk_gpio_gate_delayed_register_get, data);\r\n}

static int ttusbdecfe_dvbs_read_status(struct dvb_frontend *fe,\r\nfe_status_t *status)\r\n{\r\n*status = FE_HAS_SIGNAL | FE_HAS_VITERBI |\r\nFE_HAS_SYNC | FE_HAS_CARRIER | FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbt_read_status(struct dvb_frontend *fe,\r\nfe_status_t *status)\r\n{\r\nstruct ttusbdecfe_state* state = fe->demodulator_priv;\r\nu8 b[] = { 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00 };\r\nu8 result[4];\r\nint len, ret;\r\n*status=0;\r\nret=state->config->send_command(fe, 0x73, sizeof(b), b, &len, result);\r\nif(ret)\r\nreturn ret;\r\nif(len != 4) {\r\nprintk(KERN_ERR "%s: unexpected reply\n", __func__);\r\nreturn -EIO;\r\n}\r\nswitch(result[3]) {\r\ncase 1:\r\ncase 2:\r\nbreak;\r\ncase 3:\r\n*status = FE_HAS_SIGNAL | FE_HAS_VITERBI |\r\nFE_HAS_SYNC | FE_HAS_CARRIER | FE_HAS_LOCK;\r\nbreak;\r\ncase 4:\r\n*status = FE_TIMEDOUT;\r\nbreak;\r\ndefault:\r\npr_info("%s: returned unknown value: %d\n",\r\n__func__, result[3]);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbt_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nu8 b[] = { 0x00, 0x00, 0x00, 0x03,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x01,\r\n0x00, 0x00, 0x00, 0xff,\r\n0x00, 0x00, 0x00, 0xff };\r\n__be32 freq = htonl(p->frequency / 1000);\r\nmemcpy(&b[4], &freq, sizeof (u32));\r\nstate->config->send_command(fe, 0x71, sizeof(b), b, NULL, NULL);\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbt_get_tune_settings(struct dvb_frontend* fe,\r\nstruct dvb_frontend_tune_settings* fesettings)\r\n{\r\nfesettings->min_delay_ms = 1500;\r\nfesettings->step_size = 0;\r\nfesettings->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbs_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nu8 b[] = { 0x00, 0x00, 0x00, 0x01,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x01,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00 };\r\n__be32 freq;\r\n__be32 sym_rate;\r\n__be32 band;\r\n__be32 lnb_voltage;\r\nfreq = htonl(p->frequency +\r\n(state->hi_band ? LOF_HI : LOF_LO));\r\nmemcpy(&b[4], &freq, sizeof(u32));\r\nsym_rate = htonl(p->symbol_rate);\r\nmemcpy(&b[12], &sym_rate, sizeof(u32));\r\nband = htonl(state->hi_band ? LOF_HI : LOF_LO);\r\nmemcpy(&b[24], &band, sizeof(u32));\r\nlnb_voltage = htonl(state->voltage);\r\nmemcpy(&b[28], &lnb_voltage, sizeof(u32));\r\nstate->config->send_command(fe, 0x71, sizeof(b), b, NULL, NULL);\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbs_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd *cmd)\r\n{\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nu8 b[] = { 0x00, 0xff, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00 };\r\nif (cmd->msg_len > sizeof(b) - 4)\r\nreturn -EINVAL;\r\nmemcpy(&b[4], cmd->msg, cmd->msg_len);\r\nstate->config->send_command(fe, 0x72,\r\nsizeof(b) - (6 - cmd->msg_len), b,\r\nNULL, NULL);\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbs_set_tone(struct dvb_frontend* fe, fe_sec_tone_mode_t tone)\r\n{\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nstate->hi_band = (SEC_TONE_ON == tone);\r\nreturn 0;\r\n}\r\nstatic int ttusbdecfe_dvbs_set_voltage(struct dvb_frontend* fe, fe_sec_voltage_t voltage)\r\n{\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_13:\r\nstate->voltage = 13;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nstate->voltage = 18;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ttusbdecfe_release(struct dvb_frontend* fe)\r\n{\r\nstruct ttusbdecfe_state* state = (struct ttusbdecfe_state*) fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nstruct dvb_frontend* ttusbdecfe_dvbt_attach(const struct ttusbdecfe_config* config)\r\n{\r\nstruct ttusbdecfe_state* state = NULL;\r\nstate = kmalloc(sizeof(struct ttusbdecfe_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn NULL;\r\nstate->config = config;\r\nmemcpy(&state->frontend.ops, &ttusbdecfe_dvbt_ops, sizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\n}\r\nstruct dvb_frontend* ttusbdecfe_dvbs_attach(const struct ttusbdecfe_config* config)\r\n{\r\nstruct ttusbdecfe_state* state = NULL;\r\nstate = kmalloc(sizeof(struct ttusbdecfe_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->voltage = 0;\r\nstate->hi_band = 0;\r\nmemcpy(&state->frontend.ops, &ttusbdecfe_dvbs_ops, sizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\n}

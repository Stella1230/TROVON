static void omap_rproc_mbox_callback(struct mbox_client *client, void *data)\r\n{\r\nstruct omap_rproc *oproc = container_of(client, struct omap_rproc,\r\nclient);\r\nstruct device *dev = oproc->rproc->dev.parent;\r\nconst char *name = oproc->rproc->name;\r\nu32 msg = (u32)data;\r\ndev_dbg(dev, "mbox msg: 0x%x\n", msg);\r\nswitch (msg) {\r\ncase RP_MBOX_CRASH:\r\ndev_err(dev, "omap rproc %s crashed\n", name);\r\nbreak;\r\ncase RP_MBOX_ECHO_REPLY:\r\ndev_info(dev, "received echo reply from %s\n", name);\r\nbreak;\r\ndefault:\r\nif (rproc_vq_interrupt(oproc->rproc, msg) == IRQ_NONE)\r\ndev_dbg(dev, "no message was found in vqid %d\n", msg);\r\n}\r\n}\r\nstatic void omap_rproc_kick(struct rproc *rproc, int vqid)\r\n{\r\nstruct omap_rproc *oproc = rproc->priv;\r\nstruct device *dev = rproc->dev.parent;\r\nint ret;\r\nret = mbox_send_message(oproc->mbox, (void *)vqid);\r\nif (ret < 0)\r\ndev_err(dev, "omap_mbox_msg_send failed: %d\n", ret);\r\n}\r\nstatic int omap_rproc_start(struct rproc *rproc)\r\n{\r\nstruct omap_rproc *oproc = rproc->priv;\r\nstruct device *dev = rproc->dev.parent;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct omap_rproc_pdata *pdata = pdev->dev.platform_data;\r\nint ret;\r\nstruct mbox_client *client = &oproc->client;\r\nif (pdata->set_bootaddr)\r\npdata->set_bootaddr(rproc->bootaddr);\r\nclient->dev = dev;\r\nclient->tx_done = NULL;\r\nclient->rx_callback = omap_rproc_mbox_callback;\r\nclient->tx_block = false;\r\nclient->knows_txdone = false;\r\noproc->mbox = omap_mbox_request_channel(client, pdata->mbox_name);\r\nif (IS_ERR(oproc->mbox)) {\r\nret = -EBUSY;\r\ndev_err(dev, "mbox_request_channel failed: %ld\n",\r\nPTR_ERR(oproc->mbox));\r\nreturn ret;\r\n}\r\nret = mbox_send_message(oproc->mbox, (void *)RP_MBOX_ECHO_REQUEST);\r\nif (ret < 0) {\r\ndev_err(dev, "mbox_send_message failed: %d\n", ret);\r\ngoto put_mbox;\r\n}\r\nret = pdata->device_enable(pdev);\r\nif (ret) {\r\ndev_err(dev, "omap_device_enable failed: %d\n", ret);\r\ngoto put_mbox;\r\n}\r\nreturn 0;\r\nput_mbox:\r\nmbox_free_channel(oproc->mbox);\r\nreturn ret;\r\n}\r\nstatic int omap_rproc_stop(struct rproc *rproc)\r\n{\r\nstruct device *dev = rproc->dev.parent;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct omap_rproc_pdata *pdata = pdev->dev.platform_data;\r\nstruct omap_rproc *oproc = rproc->priv;\r\nint ret;\r\nret = pdata->device_shutdown(pdev);\r\nif (ret)\r\nreturn ret;\r\nmbox_free_channel(oproc->mbox);\r\nreturn 0;\r\n}\r\nstatic int omap_rproc_probe(struct platform_device *pdev)\r\n{\r\nstruct omap_rproc_pdata *pdata = pdev->dev.platform_data;\r\nstruct omap_rproc *oproc;\r\nstruct rproc *rproc;\r\nint ret;\r\nret = dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(32));\r\nif (ret) {\r\ndev_err(&pdev->dev, "dma_set_coherent_mask: %d\n", ret);\r\nreturn ret;\r\n}\r\nrproc = rproc_alloc(&pdev->dev, pdata->name, &omap_rproc_ops,\r\npdata->firmware, sizeof(*oproc));\r\nif (!rproc)\r\nreturn -ENOMEM;\r\noproc = rproc->priv;\r\noproc->rproc = rproc;\r\nplatform_set_drvdata(pdev, rproc);\r\nret = rproc_add(rproc);\r\nif (ret)\r\ngoto free_rproc;\r\nreturn 0;\r\nfree_rproc:\r\nrproc_put(rproc);\r\nreturn ret;\r\n}\r\nstatic int omap_rproc_remove(struct platform_device *pdev)\r\n{\r\nstruct rproc *rproc = platform_get_drvdata(pdev);\r\nrproc_del(rproc);\r\nrproc_put(rproc);\r\nreturn 0;\r\n}

static int wm8998_asrc_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol,\r\nint event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nunsigned int val;\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nval = snd_soc_read(codec, ARIZONA_ASRC_RATE1);\r\nval &= ARIZONA_ASRC_RATE1_MASK;\r\nval >>= ARIZONA_ASRC_RATE1_SHIFT;\r\nswitch (val) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\nval = snd_soc_read(codec,\r\nARIZONA_SAMPLE_RATE_1 + val);\r\nif (val >= 0x11) {\r\ndev_warn(codec->dev,\r\n"Unsupported ASRC rate1 (%s)\n",\r\narizona_sample_rate_val_to_name(val));\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev,\r\n"Illegal ASRC rate1 selector (0x%x)\n",\r\nval);\r\nreturn -EINVAL;\r\n}\r\nval = snd_soc_read(codec, ARIZONA_ASRC_RATE2);\r\nval &= ARIZONA_ASRC_RATE2_MASK;\r\nval >>= ARIZONA_ASRC_RATE2_SHIFT;\r\nswitch (val) {\r\ncase 8:\r\ncase 9:\r\nval -= 0x8;\r\nval = snd_soc_read(codec,\r\nARIZONA_ASYNC_SAMPLE_RATE_1 + val);\r\nif (val >= 0x11) {\r\ndev_warn(codec->dev,\r\n"Unsupported ASRC rate2 (%s)\n",\r\narizona_sample_rate_val_to_name(val));\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev,\r\n"Illegal ASRC rate2 selector (0x%x)\n",\r\nval);\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm8998_in1mux_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_kcontrol_codec(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct wm8998_priv *wm8998 = snd_soc_codec_get_drvdata(codec);\r\nstruct arizona *arizona = wm8998->core.arizona;\r\nstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\r\nunsigned int mux, inmode;\r\nunsigned int mode_val, src_val;\r\nmux = ucontrol->value.enumerated.item[0];\r\nif (mux > 1)\r\nreturn -EINVAL;\r\ninmode = arizona->pdata.inmode[2 * mux];\r\nsrc_val = mux << ARIZONA_IN1L_SRC_SHIFT;\r\nif (inmode & ARIZONA_INMODE_SE)\r\nsrc_val |= 1 << ARIZONA_IN1L_SRC_SE_SHIFT;\r\nswitch (arizona->pdata.inmode[0]) {\r\ncase ARIZONA_INMODE_DMIC:\r\nif (mux)\r\nmode_val = 0;\r\nelse\r\nmode_val = 1 << ARIZONA_IN1_MODE_SHIFT;\r\nsnd_soc_update_bits(codec, ARIZONA_IN1L_CONTROL,\r\nARIZONA_IN1_MODE_MASK, mode_val);\r\nsnd_soc_update_bits(codec,\r\nARIZONA_ADC_DIGITAL_VOLUME_1L,\r\nARIZONA_IN1L_SRC_MASK |\r\nARIZONA_IN1L_SRC_SE_MASK, src_val);\r\nsnd_soc_update_bits(codec,\r\nARIZONA_ADC_DIGITAL_VOLUME_1R,\r\nARIZONA_IN1R_SRC_MASK |\r\nARIZONA_IN1R_SRC_SE_MASK, src_val);\r\nbreak;\r\ndefault:\r\nsnd_soc_update_bits(codec,\r\ne->reg,\r\nARIZONA_IN1L_SRC_MASK |\r\nARIZONA_IN1L_SRC_SE_MASK,\r\nsrc_val);\r\nbreak;\r\n}\r\nreturn snd_soc_dapm_mux_update_power(dapm, kcontrol,\r\nucontrol->value.enumerated.item[0],\r\ne, NULL);\r\n}\r\nstatic int wm8998_in2mux_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_kcontrol_codec(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct wm8998_priv *wm8998 = snd_soc_codec_get_drvdata(codec);\r\nstruct arizona *arizona = wm8998->core.arizona;\r\nstruct soc_enum *e = (struct soc_enum *)kcontrol->private_value;\r\nunsigned int mux, inmode, src_val, mode_val;\r\nmux = ucontrol->value.enumerated.item[0];\r\nif (mux > 1)\r\nreturn -EINVAL;\r\ninmode = arizona->pdata.inmode[1 + (2 * mux)];\r\nif (inmode & ARIZONA_INMODE_DMIC)\r\nmode_val = 1 << ARIZONA_IN2_MODE_SHIFT;\r\nelse\r\nmode_val = 0;\r\nsrc_val = mux << ARIZONA_IN2L_SRC_SHIFT;\r\nif (inmode & ARIZONA_INMODE_SE)\r\nsrc_val |= 1 << ARIZONA_IN2L_SRC_SE_SHIFT;\r\nsnd_soc_update_bits(codec, ARIZONA_IN2L_CONTROL,\r\nARIZONA_IN2_MODE_MASK, mode_val);\r\nsnd_soc_update_bits(codec, ARIZONA_ADC_DIGITAL_VOLUME_2L,\r\nARIZONA_IN2L_SRC_MASK | ARIZONA_IN2L_SRC_SE_MASK,\r\nsrc_val);\r\nreturn snd_soc_dapm_mux_update_power(dapm, kcontrol,\r\nucontrol->value.enumerated.item[0],\r\ne, NULL);\r\n}\r\nstatic int wm8998_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct wm8998_priv *wm8998 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase WM8998_FLL1:\r\nreturn arizona_set_fll(&wm8998->fll[0], source, Fref, Fout);\r\ncase WM8998_FLL2:\r\nreturn arizona_set_fll(&wm8998->fll[1], source, Fref, Fout);\r\ncase WM8998_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm8998->fll[0], source, Fref,\r\nFout);\r\ncase WM8998_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm8998->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int wm8998_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct wm8998_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\npriv->core.arizona->dapm = dapm;\r\narizona_init_spk(codec);\r\narizona_init_gpio(codec);\r\nsnd_soc_dapm_disable_pin(dapm, "HAPTICS");\r\nreturn 0;\r\n}\r\nstatic int wm8998_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct wm8998_priv *priv = snd_soc_codec_get_drvdata(codec);\r\npriv->core.arizona->dapm = NULL;\r\narizona_free_spk(codec);\r\nreturn 0;\r\n}\r\nstatic struct regmap *wm8998_get_regmap(struct device *dev)\r\n{\r\nstruct wm8998_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int wm8998_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm8998_priv *wm8998;\r\nint i;\r\nwm8998 = devm_kzalloc(&pdev->dev, sizeof(struct wm8998_priv),\r\nGFP_KERNEL);\r\nif (!wm8998)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm8998);\r\nwm8998->core.arizona = arizona;\r\nwm8998->core.num_inputs = 3;\r\nfor (i = 0; i < ARRAY_SIZE(wm8998->fll); i++)\r\nwm8998->fll[i].vco_mult = 1;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&wm8998->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&wm8998->fll[1]);\r\nfor (i = 0; i < ARRAY_SIZE(wm8998_dai); i++)\r\narizona_init_dai(&wm8998->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(wm8998_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, wm8998_digital_vu[i],\r\nWM8998_DIG_VU, WM8998_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nreturn snd_soc_register_codec(&pdev->dev, &soc_codec_dev_wm8998,\r\nwm8998_dai, ARRAY_SIZE(wm8998_dai));\r\n}\r\nstatic int wm8998_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}

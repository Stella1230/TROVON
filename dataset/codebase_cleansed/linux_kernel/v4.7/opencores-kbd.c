static irqreturn_t opencores_kbd_isr(int irq, void *dev_id)\r\n{\r\nstruct opencores_kbd *opencores_kbd = dev_id;\r\nstruct input_dev *input = opencores_kbd->input;\r\nunsigned char c;\r\nc = readb(opencores_kbd->addr);\r\ninput_report_key(input, c & 0x7f, c & 0x80 ? 0 : 1);\r\ninput_sync(input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int opencores_kbd_probe(struct platform_device *pdev)\r\n{\r\nstruct input_dev *input;\r\nstruct opencores_kbd *opencores_kbd;\r\nstruct resource *res;\r\nint irq, i, error;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "missing board memory resource\n");\r\nreturn -EINVAL;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "missing board IRQ resource\n");\r\nreturn -EINVAL;\r\n}\r\nopencores_kbd = devm_kzalloc(&pdev->dev, sizeof(*opencores_kbd),\r\nGFP_KERNEL);\r\nif (!opencores_kbd)\r\nreturn -ENOMEM;\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input) {\r\ndev_err(&pdev->dev, "failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\nopencores_kbd->input = input;\r\nopencores_kbd->addr = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(opencores_kbd->addr))\r\nreturn PTR_ERR(opencores_kbd->addr);\r\ninput->name = pdev->name;\r\ninput->phys = "opencores-kbd/input0";\r\ninput_set_drvdata(input, opencores_kbd);\r\ninput->id.bustype = BUS_HOST;\r\ninput->id.vendor = 0x0001;\r\ninput->id.product = 0x0001;\r\ninput->id.version = 0x0100;\r\ninput->keycode = opencores_kbd->keycodes;\r\ninput->keycodesize = sizeof(opencores_kbd->keycodes[0]);\r\ninput->keycodemax = ARRAY_SIZE(opencores_kbd->keycodes);\r\n__set_bit(EV_KEY, input->evbit);\r\nfor (i = 0; i < ARRAY_SIZE(opencores_kbd->keycodes); i++) {\r\nopencores_kbd->keycodes[i] = i;\r\n__set_bit(opencores_kbd->keycodes[i], input->keybit);\r\n}\r\n__clear_bit(KEY_RESERVED, input->keybit);\r\nerror = devm_request_irq(&pdev->dev, irq, &opencores_kbd_isr,\r\nIRQF_TRIGGER_RISING,\r\npdev->name, opencores_kbd);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to claim irq %d\n", irq);\r\nreturn error;\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to register input device\n");\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, opencores_kbd);\r\nreturn 0;\r\n}

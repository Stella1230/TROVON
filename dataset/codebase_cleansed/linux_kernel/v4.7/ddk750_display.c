static void setDisplayControl(int ctrl, int disp_state)\r\n{\r\nunsigned long reg, val, reserved;\r\nint cnt = 0;\r\nif (!ctrl) {\r\nreg = PANEL_DISPLAY_CTRL;\r\nreserved = PANEL_DISPLAY_CTRL_RESERVED_MASK;\r\n} else {\r\nreg = CRT_DISPLAY_CTRL;\r\nreserved = CRT_DISPLAY_CTRL_RESERVED_MASK;\r\n}\r\nval = PEEK32(reg);\r\nif (disp_state) {\r\nval |= DISPLAY_CTRL_TIMING;\r\nPOKE32(reg, val);\r\nval |= DISPLAY_CTRL_PLANE;\r\ndo {\r\ncnt++;\r\nPOKE32(reg, val);\r\n} while ((PEEK32(reg) & ~reserved) != (val & ~reserved));\r\npr_debug("Set Plane enbit:after tried %d times\n", cnt);\r\n} else {\r\nval &= ~DISPLAY_CTRL_PLANE;\r\nPOKE32(reg, val);\r\nval &= ~DISPLAY_CTRL_TIMING;\r\nPOKE32(reg, val);\r\n}\r\n}\r\nstatic void waitNextVerticalSync(int ctrl, int delay)\r\n{\r\nunsigned int status;\r\nif (!ctrl) {\r\nif (!(PEEK32(PANEL_PLL_CTRL) & PLL_CTRL_POWER) ||\r\n!(PEEK32(PANEL_DISPLAY_CTRL) & DISPLAY_CTRL_TIMING)) {\r\nreturn;\r\n}\r\nwhile (delay-- > 0) {\r\ndo {\r\nstatus = PEEK32(SYSTEM_CTRL);\r\n} while (status & SYSTEM_CTRL_PANEL_VSYNC_ACTIVE);\r\ndo {\r\nstatus = PEEK32(SYSTEM_CTRL);\r\n} while (!(status & SYSTEM_CTRL_PANEL_VSYNC_ACTIVE));\r\n}\r\n} else {\r\nif (!(PEEK32(CRT_PLL_CTRL) & PLL_CTRL_POWER) ||\r\n!(PEEK32(CRT_DISPLAY_CTRL) & DISPLAY_CTRL_TIMING)) {\r\nreturn;\r\n}\r\nwhile (delay-- > 0) {\r\ndo {\r\nstatus = PEEK32(SYSTEM_CTRL);\r\n} while (status & SYSTEM_CTRL_PANEL_VSYNC_ACTIVE);\r\ndo {\r\nstatus = PEEK32(SYSTEM_CTRL);\r\n} while (!(status & SYSTEM_CTRL_PANEL_VSYNC_ACTIVE));\r\n}\r\n}\r\n}\r\nstatic void swPanelPowerSequence(int disp, int delay)\r\n{\r\nunsigned int reg;\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg |= (disp ? PANEL_DISPLAY_CTRL_FPEN : 0);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg |= (disp ? PANEL_DISPLAY_CTRL_DATA : 0);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg |= (disp ? PANEL_DISPLAY_CTRL_VBIASEN : 0);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg |= (disp ? PANEL_DISPLAY_CTRL_FPEN : 0);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\n}\r\nvoid ddk750_setLogicalDispOut(disp_output_t output)\r\n{\r\nunsigned int reg;\r\nif (output & PNL_2_USAGE) {\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg &= ~PANEL_DISPLAY_CTRL_SELECT_MASK;\r\nreg |= (((output & PNL_2_MASK) >> PNL_2_OFFSET) <<\r\nPANEL_DISPLAY_CTRL_SELECT_SHIFT);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\n}\r\nif (output & CRT_2_USAGE) {\r\nreg = PEEK32(CRT_DISPLAY_CTRL);\r\nreg &= ~CRT_DISPLAY_CTRL_SELECT_MASK;\r\nreg |= (((output & CRT_2_MASK) >> CRT_2_OFFSET) <<\r\nCRT_DISPLAY_CTRL_SELECT_SHIFT);\r\nreg &= ~CRT_DISPLAY_CTRL_BLANK;\r\nPOKE32(CRT_DISPLAY_CTRL, reg);\r\n}\r\nif (output & PRI_TP_USAGE) {\r\nsetDisplayControl(0, (output & PRI_TP_MASK) >> PRI_TP_OFFSET);\r\n}\r\nif (output & SEC_TP_USAGE) {\r\nsetDisplayControl(1, (output & SEC_TP_MASK) >> SEC_TP_OFFSET);\r\n}\r\nif (output & PNL_SEQ_USAGE) {\r\nswPanelPowerSequence((output & PNL_SEQ_MASK) >> PNL_SEQ_OFFSET, 4);\r\n}\r\nif (output & DAC_USAGE)\r\nsetDAC((output & DAC_MASK) >> DAC_OFFSET);\r\nif (output & DPMS_USAGE)\r\nddk750_setDPMS((output & DPMS_MASK) >> DPMS_OFFSET);\r\n}

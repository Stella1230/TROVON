static ssize_t show_temp(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev->parent);\r\nlong temp;\r\nu16 tsthrhi;\r\ns8 tsfsc;\r\npci_read_config_word(pdev, REG_TSTHRHI, &tsthrhi);\r\npci_read_config_byte(pdev, REG_TSFSC, &tsfsc);\r\ntemp = ((long)tsthrhi - tsfsc) * 500;\r\nreturn sprintf(buf, "%ld\n", temp);\r\n}\r\nstatic ssize_t show_thresh(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev->parent);\r\nint reg = to_sensor_dev_attr(devattr)->index;\r\nlong temp;\r\nu16 tsthr;\r\npci_read_config_word(pdev, reg, &tsthr);\r\ntemp = tsthr * 500;\r\nreturn sprintf(buf, "%ld\n", temp);\r\n}\r\nstatic ssize_t show_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev->parent);\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nu8 ctsts;\r\npci_read_config_byte(pdev, REG_CTSTS, &ctsts);\r\nreturn sprintf(buf, "%u\n", (unsigned int)ctsts & (1 << nr));\r\n}\r\nstatic int i5500_temp_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nint err;\r\nstruct device *hwmon_dev;\r\nu32 tstimer;\r\ns8 tsfsc;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Failed to enable device\n");\r\nreturn err;\r\n}\r\npci_read_config_byte(pdev, REG_TSFSC, &tsfsc);\r\npci_read_config_dword(pdev, REG_TSTIMER, &tstimer);\r\nif (tsfsc == 0x7F && tstimer == 0x07D30D40) {\r\ndev_notice(&pdev->dev, "Sensor seems to be disabled\n");\r\nreturn -ENODEV;\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_groups(&pdev->dev,\r\n"intel5500", NULL,\r\ni5500_temp_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

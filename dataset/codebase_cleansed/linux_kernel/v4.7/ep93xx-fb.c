static inline unsigned int ep93xxfb_readl(struct ep93xx_fbi *fbi,\r\nunsigned int off)\r\n{\r\nreturn __raw_readl(fbi->mmio_base + off);\r\n}\r\nstatic inline void ep93xxfb_writel(struct ep93xx_fbi *fbi,\r\nunsigned int val, unsigned int off)\r\n{\r\n__raw_writel(val, fbi->mmio_base + off);\r\n}\r\nstatic inline void ep93xxfb_out_locked(struct ep93xx_fbi *fbi,\r\nunsigned int val, unsigned int reg)\r\n{\r\nep93xxfb_writel(fbi, 0xaa, EP93XXFB_SWLOCK);\r\nep93xxfb_writel(fbi, val, reg);\r\n}\r\nstatic void ep93xxfb_set_video_attribs(struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunsigned int attribs;\r\nattribs = EP93XXFB_ENABLE;\r\nattribs |= fbi->mach_info->flags;\r\nep93xxfb_out_locked(fbi, attribs, EP93XXFB_ATTRIBS);\r\n}\r\nstatic int ep93xxfb_set_pixelmode(struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunsigned int val;\r\ninfo->var.transp.offset = 0;\r\ninfo->var.transp.length = 0;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 8:\r\nval = EP93XXFB_PIXELMODE_8BPP | EP93XXFB_PIXELMODE_COLOR_LUT |\r\nEP93XXFB_PIXELMODE_SHIFT_1P_18B;\r\ninfo->var.red.offset = 0;\r\ninfo->var.red.length = 8;\r\ninfo->var.green.offset = 0;\r\ninfo->var.green.length = 8;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = 8;\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nbreak;\r\ncase 16:\r\nval = EP93XXFB_PIXELMODE_16BPP | EP93XXFB_PIXELMODE_COLOR_555 |\r\nEP93XXFB_PIXELMODE_SHIFT_1P_18B;\r\ninfo->var.red.offset = 11;\r\ninfo->var.red.length = 5;\r\ninfo->var.green.offset = 5;\r\ninfo->var.green.length = 6;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = 5;\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nbreak;\r\ncase 24:\r\nval = EP93XXFB_PIXELMODE_24BPP | EP93XXFB_PIXELMODE_COLOR_888 |\r\nEP93XXFB_PIXELMODE_SHIFT_1P_24B;\r\ninfo->var.red.offset = 16;\r\ninfo->var.red.length = 8;\r\ninfo->var.green.offset = 8;\r\ninfo->var.green.length = 8;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = 8;\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nbreak;\r\ncase 32:\r\nval = EP93XXFB_PIXELMODE_32BPP | EP93XXFB_PIXELMODE_COLOR_888 |\r\nEP93XXFB_PIXELMODE_SHIFT_1P_24B;\r\ninfo->var.red.offset = 16;\r\ninfo->var.red.length = 8;\r\ninfo->var.green.offset = 8;\r\ninfo->var.green.length = 8;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = 8;\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nep93xxfb_writel(fbi, val, EP93XXFB_PIXELMODE);\r\nreturn 0;\r\n}\r\nstatic void ep93xxfb_set_timing(struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunsigned int vlines_total, hclks_total, start, stop;\r\nvlines_total = info->var.yres + info->var.upper_margin +\r\ninfo->var.lower_margin + info->var.vsync_len - 1;\r\nhclks_total = info->var.xres + info->var.left_margin +\r\ninfo->var.right_margin + info->var.hsync_len - 1;\r\nep93xxfb_out_locked(fbi, vlines_total, EP93XXFB_VLINES_TOTAL);\r\nep93xxfb_out_locked(fbi, hclks_total, EP93XXFB_HCLKS_TOTAL);\r\nstart = vlines_total;\r\nstop = vlines_total - info->var.vsync_len;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_VSYNC);\r\nstart = vlines_total - info->var.vsync_len - info->var.upper_margin;\r\nstop = info->var.lower_margin - 1;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_VBLANK);\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_VACTIVE);\r\nstart = vlines_total;\r\nstop = vlines_total + 1;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_VCLK);\r\nstart = hclks_total;\r\nstop = hclks_total - info->var.hsync_len;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_HSYNC);\r\nstart = hclks_total - info->var.hsync_len - info->var.left_margin;\r\nstop = info->var.right_margin - 1;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_HBLANK);\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_HACTIVE);\r\nstart = hclks_total;\r\nstop = hclks_total;\r\nep93xxfb_out_locked(fbi, start | (stop << 16), EP93XXFB_HCLK);\r\nep93xxfb_out_locked(fbi, 0x0, EP93XXFB_LINE_CARRY);\r\n}\r\nstatic int ep93xxfb_set_par(struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nclk_set_rate(fbi->clk, 1000 * PICOS2KHZ(info->var.pixclock));\r\nep93xxfb_set_timing(info);\r\ninfo->fix.line_length = info->var.xres_virtual *\r\ninfo->var.bits_per_pixel / 8;\r\nep93xxfb_writel(fbi, info->fix.smem_start, EP93XXFB_SCREEN_PAGE);\r\nep93xxfb_writel(fbi, info->var.yres - 1, EP93XXFB_SCREEN_LINES);\r\nep93xxfb_writel(fbi, ((info->var.xres * info->var.bits_per_pixel)\r\n/ 32) - 1, EP93XXFB_LINE_LENGTH);\r\nep93xxfb_writel(fbi, info->fix.line_length / 4, EP93XXFB_VLINE_STEP);\r\nep93xxfb_set_video_attribs(info);\r\nreturn 0;\r\n}\r\nstatic int ep93xxfb_check_var(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nint err;\r\nerr = ep93xxfb_set_pixelmode(info);\r\nif (err)\r\nreturn err;\r\nvar->xres = max_t(unsigned int, var->xres, EP93XXFB_MIN_XRES);\r\nvar->xres = min_t(unsigned int, var->xres, EP93XXFB_MAX_XRES);\r\nvar->xres_virtual = max(var->xres_virtual, var->xres);\r\nvar->yres = max_t(unsigned int, var->yres, EP93XXFB_MIN_YRES);\r\nvar->yres = min_t(unsigned int, var->yres, EP93XXFB_MAX_YRES);\r\nvar->yres_virtual = max(var->yres_virtual, var->yres);\r\nreturn 0;\r\n}\r\nstatic int ep93xxfb_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nunsigned int offset = vma->vm_pgoff << PAGE_SHIFT;\r\nif (offset < info->fix.smem_len) {\r\nreturn dma_mmap_wc(info->dev, vma, info->screen_base,\r\ninfo->fix.smem_start, info->fix.smem_len);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ep93xxfb_blank(int blank_mode, struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunsigned int attribs = ep93xxfb_readl(fbi, EP93XXFB_ATTRIBS);\r\nif (blank_mode) {\r\nif (fbi->mach_info->blank)\r\nfbi->mach_info->blank(blank_mode, info);\r\nep93xxfb_out_locked(fbi, attribs & ~EP93XXFB_ENABLE,\r\nEP93XXFB_ATTRIBS);\r\nclk_disable(fbi->clk);\r\n} else {\r\nclk_enable(fbi->clk);\r\nep93xxfb_out_locked(fbi, attribs | EP93XXFB_ENABLE,\r\nEP93XXFB_ATTRIBS);\r\nif (fbi->mach_info->blank)\r\nfbi->mach_info->blank(blank_mode, info);\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int ep93xxfb_convert_color(int val, int width)\r\n{\r\nreturn ((val << width) + 0x7fff - val) >> 16;\r\n}\r\nstatic int ep93xxfb_setcolreg(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nunsigned int transp, struct fb_info *info)\r\n{\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunsigned int *pal = info->pseudo_palette;\r\nunsigned int ctrl, i, rgb, lut_current, lut_stat;\r\nswitch (info->fix.visual) {\r\ncase FB_VISUAL_PSEUDOCOLOR:\r\nif (regno > 255)\r\nreturn 1;\r\nrgb = ((red & 0xff00) << 8) | (green & 0xff00) |\r\n((blue & 0xff00) >> 8);\r\npal[regno] = rgb;\r\nep93xxfb_writel(fbi, rgb, (EP93XXFB_COLOR_LUT + (regno << 2)));\r\nctrl = ep93xxfb_readl(fbi, EP93XXFB_LUT_SW_CONTROL);\r\nlut_stat = !!(ctrl & EP93XXFB_LUT_SW_CONTROL_SSTAT);\r\nlut_current = !!(ctrl & EP93XXFB_LUT_SW_CONTROL_SWTCH);\r\nif (lut_stat == lut_current) {\r\nfor (i = 0; i < 256; i++) {\r\nep93xxfb_writel(fbi, pal[i],\r\nEP93XXFB_COLOR_LUT + (i << 2));\r\n}\r\nep93xxfb_writel(fbi,\r\nctrl ^ EP93XXFB_LUT_SW_CONTROL_SWTCH,\r\nEP93XXFB_LUT_SW_CONTROL);\r\n}\r\nbreak;\r\ncase FB_VISUAL_TRUECOLOR:\r\nif (regno > 16)\r\nreturn 1;\r\nred = ep93xxfb_convert_color(red, info->var.red.length);\r\ngreen = ep93xxfb_convert_color(green, info->var.green.length);\r\nblue = ep93xxfb_convert_color(blue, info->var.blue.length);\r\ntransp = ep93xxfb_convert_color(transp,\r\ninfo->var.transp.length);\r\npal[regno] = (red << info->var.red.offset) |\r\n(green << info->var.green.offset) |\r\n(blue << info->var.blue.offset) |\r\n(transp << info->var.transp.offset);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ep93xxfb_alloc_videomem(struct fb_info *info)\r\n{\r\nchar __iomem *virt_addr;\r\ndma_addr_t phys_addr;\r\nunsigned int fb_size;\r\nfb_size = EP93XXFB_MAX_XRES * EP93XXFB_MAX_YRES * 2;\r\nvirt_addr = dma_alloc_wc(info->dev, fb_size, &phys_addr, GFP_KERNEL);\r\nif (!virt_addr)\r\nreturn -ENOMEM;\r\nif (check_screenpage_bug && phys_addr & (1 << 27)) {\r\ndev_err(info->dev, "ep93xx framebuffer bug. phys addr (0x%x) "\r\n"has bit 27 set: cannot init framebuffer\n",\r\nphys_addr);\r\ndma_free_coherent(info->dev, fb_size, virt_addr, phys_addr);\r\nreturn -ENOMEM;\r\n}\r\ninfo->fix.smem_start = phys_addr;\r\ninfo->fix.smem_len = fb_size;\r\ninfo->screen_base = virt_addr;\r\nreturn 0;\r\n}\r\nstatic void ep93xxfb_dealloc_videomem(struct fb_info *info)\r\n{\r\nif (info->screen_base)\r\ndma_free_coherent(info->dev, info->fix.smem_len,\r\ninfo->screen_base, info->fix.smem_start);\r\n}\r\nstatic int ep93xxfb_probe(struct platform_device *pdev)\r\n{\r\nstruct ep93xxfb_mach_info *mach_info = dev_get_platdata(&pdev->dev);\r\nstruct fb_info *info;\r\nstruct ep93xx_fbi *fbi;\r\nstruct resource *res;\r\nchar *video_mode;\r\nint err;\r\nif (!mach_info)\r\nreturn -EINVAL;\r\ninfo = framebuffer_alloc(sizeof(struct ep93xx_fbi), &pdev->dev);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, info);\r\nfbi = info->par;\r\nfbi->mach_info = mach_info;\r\nerr = fb_alloc_cmap(&info->cmap, 256, 0);\r\nif (err)\r\ngoto failed_cmap;\r\nerr = ep93xxfb_alloc_videomem(info);\r\nif (err)\r\ngoto failed_videomem;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nerr = -ENXIO;\r\ngoto failed_resource;\r\n}\r\nfbi->res = res;\r\nfbi->mmio_base = devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!fbi->mmio_base) {\r\nerr = -ENXIO;\r\ngoto failed_resource;\r\n}\r\nstrcpy(info->fix.id, pdev->name);\r\ninfo->fbops = &ep93xxfb_ops;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.accel = FB_ACCEL_NONE;\r\ninfo->var.activate = FB_ACTIVATE_NOW;\r\ninfo->var.vmode = FB_VMODE_NONINTERLACED;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->node = -1;\r\ninfo->state = FBINFO_STATE_RUNNING;\r\ninfo->pseudo_palette = &fbi->pseudo_palette;\r\nfb_get_options("ep93xx-fb", &video_mode);\r\nerr = fb_find_mode(&info->var, info, video_mode,\r\nNULL, 0, NULL, 16);\r\nif (err == 0) {\r\ndev_err(info->dev, "No suitable video mode found\n");\r\nerr = -EINVAL;\r\ngoto failed_resource;\r\n}\r\nif (mach_info->setup) {\r\nerr = mach_info->setup(pdev);\r\nif (err)\r\ngoto failed_resource;\r\n}\r\nerr = ep93xxfb_check_var(&info->var, info);\r\nif (err)\r\ngoto failed_check;\r\nfbi->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(fbi->clk)) {\r\nerr = PTR_ERR(fbi->clk);\r\nfbi->clk = NULL;\r\ngoto failed_check;\r\n}\r\nep93xxfb_set_par(info);\r\nclk_enable(fbi->clk);\r\nerr = register_framebuffer(info);\r\nif (err)\r\ngoto failed_check;\r\ndev_info(info->dev, "registered. Mode = %dx%d-%d\n",\r\ninfo->var.xres, info->var.yres, info->var.bits_per_pixel);\r\nreturn 0;\r\nfailed_check:\r\nif (fbi->mach_info->teardown)\r\nfbi->mach_info->teardown(pdev);\r\nfailed_resource:\r\nep93xxfb_dealloc_videomem(info);\r\nfailed_videomem:\r\nfb_dealloc_cmap(&info->cmap);\r\nfailed_cmap:\r\nkfree(info);\r\nreturn err;\r\n}\r\nstatic int ep93xxfb_remove(struct platform_device *pdev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(pdev);\r\nstruct ep93xx_fbi *fbi = info->par;\r\nunregister_framebuffer(info);\r\nclk_disable(fbi->clk);\r\nep93xxfb_dealloc_videomem(info);\r\nfb_dealloc_cmap(&info->cmap);\r\nif (fbi->mach_info->teardown)\r\nfbi->mach_info->teardown(pdev);\r\nkfree(info);\r\nreturn 0;\r\n}

static void rcar_du_hdmienc_disable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nconst struct drm_encoder_slave_funcs *sfuncs = to_slave_funcs(encoder);\r\nif (sfuncs->dpms)\r\nsfuncs->dpms(encoder, DRM_MODE_DPMS_OFF);\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_enable(hdmienc->renc->lvds, encoder->crtc,\r\nfalse);\r\nhdmienc->enabled = false;\r\n}\r\nstatic void rcar_du_hdmienc_enable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nconst struct drm_encoder_slave_funcs *sfuncs = to_slave_funcs(encoder);\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_enable(hdmienc->renc->lvds, encoder->crtc,\r\ntrue);\r\nif (sfuncs->dpms)\r\nsfuncs->dpms(encoder, DRM_MODE_DPMS_ON);\r\nhdmienc->enabled = true;\r\n}\r\nstatic int rcar_du_hdmienc_atomic_check(struct drm_encoder *encoder,\r\nstruct drm_crtc_state *crtc_state,\r\nstruct drm_connector_state *conn_state)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nconst struct drm_encoder_slave_funcs *sfuncs = to_slave_funcs(encoder);\r\nstruct drm_display_mode *adjusted_mode = &crtc_state->adjusted_mode;\r\nconst struct drm_display_mode *mode = &crtc_state->mode;\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_atomic_check(hdmienc->renc->lvds,\r\nadjusted_mode);\r\nif (sfuncs->mode_fixup == NULL)\r\nreturn 0;\r\nreturn sfuncs->mode_fixup(encoder, mode, adjusted_mode) ? 0 : -EINVAL;\r\n}\r\nstatic void rcar_du_hdmienc_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nconst struct drm_encoder_slave_funcs *sfuncs = to_slave_funcs(encoder);\r\nif (sfuncs->mode_set)\r\nsfuncs->mode_set(encoder, mode, adjusted_mode);\r\nrcar_du_crtc_route_output(encoder->crtc, hdmienc->renc->output);\r\n}\r\nstatic void rcar_du_hdmienc_cleanup(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nif (hdmienc->enabled)\r\nrcar_du_hdmienc_disable(encoder);\r\ndrm_encoder_cleanup(encoder);\r\nput_device(hdmienc->dev);\r\n}\r\nint rcar_du_hdmienc_init(struct rcar_du_device *rcdu,\r\nstruct rcar_du_encoder *renc, struct device_node *np)\r\n{\r\nstruct drm_encoder *encoder = rcar_encoder_to_drm_encoder(renc);\r\nstruct drm_i2c_encoder_driver *driver;\r\nstruct i2c_client *i2c_slave;\r\nstruct rcar_du_hdmienc *hdmienc;\r\nint ret;\r\nhdmienc = devm_kzalloc(rcdu->dev, sizeof(*hdmienc), GFP_KERNEL);\r\nif (hdmienc == NULL)\r\nreturn -ENOMEM;\r\ni2c_slave = of_find_i2c_device_by_node(np);\r\nif (!i2c_slave || !i2c_get_clientdata(i2c_slave)) {\r\ndev_dbg(rcdu->dev,\r\n"can't get I2C slave for %s, deferring probe\n",\r\nof_node_full_name(np));\r\nreturn -EPROBE_DEFER;\r\n}\r\nhdmienc->dev = &i2c_slave->dev;\r\nif (hdmienc->dev->driver == NULL) {\r\ndev_dbg(rcdu->dev,\r\n"I2C slave %s not probed yet, deferring probe\n",\r\ndev_name(hdmienc->dev));\r\nret = -EPROBE_DEFER;\r\ngoto error;\r\n}\r\ndriver = to_drm_i2c_encoder_driver(to_i2c_driver(hdmienc->dev->driver));\r\nret = driver->encoder_init(i2c_slave, rcdu->ddev, &renc->slave);\r\nif (ret < 0)\r\ngoto error;\r\nret = drm_encoder_init(rcdu->ddev, encoder, &encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS, NULL);\r\nif (ret < 0)\r\ngoto error;\r\ndrm_encoder_helper_add(encoder, &encoder_helper_funcs);\r\nrenc->hdmi = hdmienc;\r\nhdmienc->renc = renc;\r\nreturn 0;\r\nerror:\r\nput_device(hdmienc->dev);\r\nreturn ret;\r\n}

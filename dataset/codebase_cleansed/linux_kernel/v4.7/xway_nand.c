static void xway_reset_chip(struct nand_chip *chip)\r\n{\r\nunsigned long nandaddr = (unsigned long) chip->IO_ADDR_W;\r\nunsigned long flags;\r\nnandaddr &= ~NAND_WRITE_ADDR;\r\nnandaddr |= NAND_WRITE_CMD;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nwriteb(NAND_WRITE_CMD_RESET, (void __iomem *) nandaddr);\r\nwhile ((ltq_ebu_r32(EBU_NAND_WAIT) & NAND_WAIT_WR_C) == 0)\r\n;\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic void xway_select_chip(struct mtd_info *mtd, int chip)\r\n{\r\nswitch (chip) {\r\ncase -1:\r\nltq_ebu_w32_mask(NAND_CON_CE, 0, EBU_NAND_CON);\r\nltq_ebu_w32_mask(NAND_CON_NANDM, 0, EBU_NAND_CON);\r\nbreak;\r\ncase 0:\r\nltq_ebu_w32_mask(0, NAND_CON_NANDM, EBU_NAND_CON);\r\nltq_ebu_w32_mask(0, NAND_CON_CE, EBU_NAND_CON);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nstatic void xway_cmd_ctrl(struct mtd_info *mtd, int cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *this = mtd_to_nand(mtd);\r\nunsigned long nandaddr = (unsigned long) this->IO_ADDR_W;\r\nunsigned long flags;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\nnandaddr &= ~(NAND_WRITE_CMD | NAND_WRITE_ADDR);\r\nif (ctrl & NAND_CLE)\r\nnandaddr |= NAND_WRITE_CMD;\r\nelse\r\nnandaddr |= NAND_WRITE_ADDR;\r\nthis->IO_ADDR_W = (void __iomem *) nandaddr;\r\n}\r\nif (cmd != NAND_CMD_NONE) {\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nwriteb(cmd, this->IO_ADDR_W);\r\nwhile ((ltq_ebu_r32(EBU_NAND_WAIT) & NAND_WAIT_WR_C) == 0)\r\n;\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\n}\r\nstatic int xway_dev_ready(struct mtd_info *mtd)\r\n{\r\nreturn ltq_ebu_r32(EBU_NAND_WAIT) & NAND_WAIT_RD;\r\n}\r\nstatic unsigned char xway_read_byte(struct mtd_info *mtd)\r\n{\r\nstruct nand_chip *this = mtd_to_nand(mtd);\r\nunsigned long nandaddr = (unsigned long) this->IO_ADDR_R;\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nret = ltq_r8((void __iomem *)(nandaddr + NAND_READ_DATA));\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int xway_nand_probe(struct platform_device *pdev)\r\n{\r\nstruct nand_chip *this = platform_get_drvdata(pdev);\r\nunsigned long nandaddr = (unsigned long) this->IO_ADDR_W;\r\nconst __be32 *cs = of_get_property(pdev->dev.of_node,\r\n"lantiq,cs", NULL);\r\nu32 cs_flag = 0;\r\nif (cs && (*cs == 1))\r\ncs_flag = NAND_CON_IN_CS1 | NAND_CON_OUT_CS1;\r\nltq_ebu_w32(CPHYSADDR(nandaddr)\r\n| ADDSEL1_MASK(3) | ADDSEL1_REGEN, EBU_ADDSEL1);\r\nltq_ebu_w32(BUSCON1_SETUP | BUSCON1_BCGEN_RES | BUSCON1_WAITWRC2\r\n| BUSCON1_WAITRDC2 | BUSCON1_HOLDC1 | BUSCON1_RECOVC1\r\n| BUSCON1_CMULT4, LTQ_EBU_BUSCON1);\r\nltq_ebu_w32(NAND_CON_NANDM | NAND_CON_CSMUX | NAND_CON_CS_P\r\n| NAND_CON_SE_P | NAND_CON_WP_P | NAND_CON_PRE_P\r\n| cs_flag, EBU_NAND_CON);\r\nxway_reset_chip(this);\r\nreturn 0;\r\n}\r\nstatic int __init xway_register_nand(void)\r\n{\r\nstruct device_node *node;\r\nstruct platform_device *pdev;\r\nnode = of_find_compatible_node(NULL, NULL, "lantiq,nand-xway");\r\nif (!node)\r\nreturn -ENOENT;\r\npdev = of_find_device_by_node(node);\r\nif (!pdev)\r\nreturn -EINVAL;\r\npdev->dev.platform_data = &xway_nand_data;\r\nof_node_put(node);\r\nreturn 0;\r\n}

static int bochs_unload(struct drm_device *dev)\r\n{\r\nstruct bochs_device *bochs = dev->dev_private;\r\nbochs_fbdev_fini(bochs);\r\nbochs_kms_fini(bochs);\r\nbochs_mm_fini(bochs);\r\nbochs_hw_fini(dev);\r\nkfree(bochs);\r\ndev->dev_private = NULL;\r\nreturn 0;\r\n}\r\nstatic int bochs_load(struct drm_device *dev, unsigned long flags)\r\n{\r\nstruct bochs_device *bochs;\r\nint ret;\r\nbochs = kzalloc(sizeof(*bochs), GFP_KERNEL);\r\nif (bochs == NULL)\r\nreturn -ENOMEM;\r\ndev->dev_private = bochs;\r\nbochs->dev = dev;\r\nret = bochs_hw_init(dev, flags);\r\nif (ret)\r\ngoto err;\r\nret = bochs_mm_init(bochs);\r\nif (ret)\r\ngoto err;\r\nret = bochs_kms_init(bochs);\r\nif (ret)\r\ngoto err;\r\nif (enable_fbdev)\r\nbochs_fbdev_init(bochs);\r\nreturn 0;\r\nerr:\r\nbochs_unload(dev);\r\nreturn ret;\r\n}\r\nstatic int bochs_pm_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *drm_dev = pci_get_drvdata(pdev);\r\nstruct bochs_device *bochs = drm_dev->dev_private;\r\ndrm_kms_helper_poll_disable(drm_dev);\r\nif (bochs->fb.initialized) {\r\nconsole_lock();\r\ndrm_fb_helper_set_suspend(&bochs->fb.helper, 1);\r\nconsole_unlock();\r\n}\r\nreturn 0;\r\n}\r\nstatic int bochs_pm_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *drm_dev = pci_get_drvdata(pdev);\r\nstruct bochs_device *bochs = drm_dev->dev_private;\r\ndrm_helper_resume_force_mode(drm_dev);\r\nif (bochs->fb.initialized) {\r\nconsole_lock();\r\ndrm_fb_helper_set_suspend(&bochs->fb.helper, 0);\r\nconsole_unlock();\r\n}\r\ndrm_kms_helper_poll_enable(drm_dev);\r\nreturn 0;\r\n}\r\nstatic int bochs_kick_out_firmware_fb(struct pci_dev *pdev)\r\n{\r\nstruct apertures_struct *ap;\r\nap = alloc_apertures(1);\r\nif (!ap)\r\nreturn -ENOMEM;\r\nap->ranges[0].base = pci_resource_start(pdev, 0);\r\nap->ranges[0].size = pci_resource_len(pdev, 0);\r\nremove_conflicting_framebuffers(ap, "bochsdrmfb", false);\r\nkfree(ap);\r\nreturn 0;\r\n}\r\nstatic int bochs_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint ret;\r\nret = bochs_kick_out_firmware_fb(pdev);\r\nif (ret)\r\nreturn ret;\r\nreturn drm_get_pci_dev(pdev, ent, &bochs_driver);\r\n}\r\nstatic void bochs_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\ndrm_put_dev(dev);\r\n}\r\nstatic int __init bochs_init(void)\r\n{\r\nreturn drm_pci_init(&bochs_driver, &bochs_pci_driver);\r\n}\r\nstatic void __exit bochs_exit(void)\r\n{\r\ndrm_pci_exit(&bochs_driver, &bochs_pci_driver);\r\n}

static int dio200_pcie_board_setup(struct comedi_device *dev)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nvoid __iomem *brbase;\r\nif (pci_resource_len(pcidev, 0) < 0x4000) {\r\ndev_err(dev->class_dev, "error! bad PCI region!\n");\r\nreturn -EINVAL;\r\n}\r\nbrbase = pci_ioremap_bar(pcidev, 0);\r\nif (!brbase) {\r\ndev_err(dev->class_dev, "error! failed to map registers!\n");\r\nreturn -ENOMEM;\r\n}\r\nwritel(0x80, brbase + 0x50);\r\niounmap(brbase);\r\namplc_dio200_set_enhance(dev, 1);\r\nreturn 0;\r\n}\r\nstatic int dio200_pci_auto_attach(struct comedi_device *dev,\r\nunsigned long context_model)\r\n{\r\nstruct pci_dev *pci_dev = comedi_to_pci_dev(dev);\r\nconst struct dio200_board *board = NULL;\r\nunsigned int bar;\r\nint ret;\r\nif (context_model < ARRAY_SIZE(dio200_pci_boards))\r\nboard = &dio200_pci_boards[context_model];\r\nif (!board)\r\nreturn -EINVAL;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\ndev_info(dev->class_dev, "%s: attach pci %s (%s)\n",\r\ndev->driver->driver_name, pci_name(pci_dev), dev->board_name);\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nbar = board->mainbar;\r\nif (pci_resource_flags(pci_dev, bar) & IORESOURCE_MEM) {\r\ndev->mmio = pci_ioremap_bar(pci_dev, bar);\r\nif (!dev->mmio) {\r\ndev_err(dev->class_dev,\r\n"error! cannot remap registers\n");\r\nreturn -ENOMEM;\r\n}\r\n} else {\r\ndev->iobase = pci_resource_start(pci_dev, bar);\r\n}\r\nif (board->is_pcie) {\r\nret = dio200_pcie_board_setup(dev);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn amplc_dio200_common_attach(dev, pci_dev->irq, IRQF_SHARED);\r\n}\r\nstatic int dio200_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &dio200_pci_comedi_driver,\r\nid->driver_data);\r\n}

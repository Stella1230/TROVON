static inline bool _rev_match(uint8_t entry, uint8_t id)\r\n{\r\nreturn (entry == ANY_ID) || (entry == id);\r\n}\r\nconst struct adreno_info *adreno_info(struct adreno_rev rev)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(gpulist); i++) {\r\nconst struct adreno_info *info = &gpulist[i];\r\nif (_rev_match(info->rev.core, rev.core) &&\r\n_rev_match(info->rev.major, rev.major) &&\r\n_rev_match(info->rev.minor, rev.minor) &&\r\n_rev_match(info->rev.patchid, rev.patchid))\r\nreturn info;\r\n}\r\nreturn NULL;\r\n}\r\nstruct msm_gpu *adreno_load_gpu(struct drm_device *dev)\r\n{\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nstruct platform_device *pdev = priv->gpu_pdev;\r\nstruct adreno_platform_config *config;\r\nstruct adreno_rev rev;\r\nconst struct adreno_info *info;\r\nstruct msm_gpu *gpu = NULL;\r\nif (!pdev) {\r\ndev_err(dev->dev, "no adreno device\n");\r\nreturn NULL;\r\n}\r\nconfig = pdev->dev.platform_data;\r\nrev = config->rev;\r\ninfo = adreno_info(config->rev);\r\nif (!info) {\r\ndev_warn(dev->dev, "Unknown GPU revision: %u.%u.%u.%u\n",\r\nrev.core, rev.major, rev.minor, rev.patchid);\r\nreturn NULL;\r\n}\r\nDBG("Found GPU: %u.%u.%u.%u", rev.core, rev.major,\r\nrev.minor, rev.patchid);\r\ngpu = info->init(dev);\r\nif (IS_ERR(gpu)) {\r\ndev_warn(dev->dev, "failed to load adreno gpu\n");\r\ngpu = NULL;\r\n}\r\nif (gpu) {\r\nint ret;\r\nmutex_lock(&dev->struct_mutex);\r\ngpu->funcs->pm_resume(gpu);\r\nmutex_unlock(&dev->struct_mutex);\r\nret = gpu->funcs->hw_init(gpu);\r\nif (ret) {\r\ndev_err(dev->dev, "gpu hw init failed: %d\n", ret);\r\ngpu->funcs->destroy(gpu);\r\ngpu = NULL;\r\n} else {\r\nmsm_gpu_retire(gpu);\r\n}\r\n}\r\nreturn gpu;\r\n}\r\nstatic void set_gpu_pdev(struct drm_device *dev,\r\nstruct platform_device *pdev)\r\n{\r\nstruct msm_drm_private *priv = dev->dev_private;\r\npriv->gpu_pdev = pdev;\r\n}\r\nstatic int adreno_bind(struct device *dev, struct device *master, void *data)\r\n{\r\nstatic struct adreno_platform_config config = {};\r\nstruct device_node *child, *node = dev->of_node;\r\nu32 val;\r\nint ret;\r\nret = of_property_read_u32(node, "qcom,chipid", &val);\r\nif (ret) {\r\ndev_err(dev, "could not find chipid: %d\n", ret);\r\nreturn ret;\r\n}\r\nconfig.rev = ADRENO_REV((val >> 24) & 0xff,\r\n(val >> 16) & 0xff, (val >> 8) & 0xff, val & 0xff);\r\nconfig.fast_rate = 0;\r\nconfig.slow_rate = ~0;\r\nfor_each_child_of_node(node, child) {\r\nif (of_device_is_compatible(child, "qcom,gpu-pwrlevels")) {\r\nstruct device_node *pwrlvl;\r\nfor_each_child_of_node(child, pwrlvl) {\r\nret = of_property_read_u32(pwrlvl, "qcom,gpu-freq", &val);\r\nif (ret) {\r\ndev_err(dev, "could not find gpu-freq: %d\n", ret);\r\nreturn ret;\r\n}\r\nconfig.fast_rate = max(config.fast_rate, val);\r\nconfig.slow_rate = min(config.slow_rate, val);\r\n}\r\n}\r\n}\r\nif (!config.fast_rate) {\r\ndev_err(dev, "could not find clk rates\n");\r\nreturn -ENXIO;\r\n}\r\ndev->platform_data = &config;\r\nset_gpu_pdev(dev_get_drvdata(master), to_platform_device(dev));\r\nreturn 0;\r\n}\r\nstatic void adreno_unbind(struct device *dev, struct device *master,\r\nvoid *data)\r\n{\r\nset_gpu_pdev(dev_get_drvdata(master), NULL);\r\n}\r\nstatic int adreno_probe(struct platform_device *pdev)\r\n{\r\nreturn component_add(&pdev->dev, &a3xx_ops);\r\n}\r\nstatic int adreno_remove(struct platform_device *pdev)\r\n{\r\ncomponent_del(&pdev->dev, &a3xx_ops);\r\nreturn 0;\r\n}\r\nvoid __init adreno_register(void)\r\n{\r\nplatform_driver_register(&adreno_driver);\r\n}\r\nvoid __exit adreno_unregister(void)\r\n{\r\nplatform_driver_unregister(&adreno_driver);\r\n}

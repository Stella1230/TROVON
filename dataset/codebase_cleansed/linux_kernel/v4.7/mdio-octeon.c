static int octeon_mdiobus_probe(struct platform_device *pdev)\r\n{\r\nstruct cavium_mdiobus *bus;\r\nstruct mii_bus *mii_bus;\r\nstruct resource *res_mem;\r\nresource_size_t mdio_phys;\r\nresource_size_t regsize;\r\nunion cvmx_smix_en smi_en;\r\nint err = -ENOENT;\r\nmii_bus = devm_mdiobus_alloc_size(&pdev->dev, sizeof(*bus));\r\nif (!mii_bus)\r\nreturn -ENOMEM;\r\nres_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res_mem == NULL) {\r\ndev_err(&pdev->dev, "found no memory resource\n");\r\nreturn -ENXIO;\r\n}\r\nbus = mii_bus->priv;\r\nbus->mii_bus = mii_bus;\r\nmdio_phys = res_mem->start;\r\nregsize = resource_size(res_mem);\r\nif (!devm_request_mem_region(&pdev->dev, mdio_phys, regsize,\r\nres_mem->name)) {\r\ndev_err(&pdev->dev, "request_mem_region failed\n");\r\nreturn -ENXIO;\r\n}\r\nbus->register_base =\r\n(u64)devm_ioremap(&pdev->dev, mdio_phys, regsize);\r\nif (!bus->register_base) {\r\ndev_err(&pdev->dev, "dev_ioremap failed\n");\r\nreturn -ENOMEM;\r\n}\r\nsmi_en.u64 = 0;\r\nsmi_en.s.en = 1;\r\noct_mdio_writeq(smi_en.u64, bus->register_base + SMI_EN);\r\nbus->mii_bus->name = KBUILD_MODNAME;\r\nsnprintf(bus->mii_bus->id, MII_BUS_ID_SIZE, "%llx", bus->register_base);\r\nbus->mii_bus->parent = &pdev->dev;\r\nbus->mii_bus->read = cavium_mdiobus_read;\r\nbus->mii_bus->write = cavium_mdiobus_write;\r\nplatform_set_drvdata(pdev, bus);\r\nerr = of_mdiobus_register(bus->mii_bus, pdev->dev.of_node);\r\nif (err)\r\ngoto fail_register;\r\ndev_info(&pdev->dev, "Probed\n");\r\nreturn 0;\r\nfail_register:\r\nmdiobus_free(bus->mii_bus);\r\nsmi_en.u64 = 0;\r\noct_mdio_writeq(smi_en.u64, bus->register_base + SMI_EN);\r\nreturn err;\r\n}\r\nstatic int octeon_mdiobus_remove(struct platform_device *pdev)\r\n{\r\nstruct cavium_mdiobus *bus;\r\nunion cvmx_smix_en smi_en;\r\nbus = platform_get_drvdata(pdev);\r\nmdiobus_unregister(bus->mii_bus);\r\nmdiobus_free(bus->mii_bus);\r\nsmi_en.u64 = 0;\r\noct_mdio_writeq(smi_en.u64, bus->register_base + SMI_EN);\r\nreturn 0;\r\n}\r\nvoid octeon_mdiobus_force_mod_depencency(void)\r\n{\r\n}

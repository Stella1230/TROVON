void ubifs_compress(const struct ubifs_info *c, const void *in_buf,\r\nint in_len, void *out_buf, int *out_len, int *compr_type)\r\n{\r\nint err;\r\nstruct ubifs_compressor *compr = ubifs_compressors[*compr_type];\r\nif (*compr_type == UBIFS_COMPR_NONE)\r\ngoto no_compr;\r\nif (in_len < UBIFS_MIN_COMPR_LEN)\r\ngoto no_compr;\r\nif (compr->comp_mutex)\r\nmutex_lock(compr->comp_mutex);\r\nerr = crypto_comp_compress(compr->cc, in_buf, in_len, out_buf,\r\n(unsigned int *)out_len);\r\nif (compr->comp_mutex)\r\nmutex_unlock(compr->comp_mutex);\r\nif (unlikely(err)) {\r\nubifs_warn(c, "cannot compress %d bytes, compressor %s, error %d, leave data uncompressed",\r\nin_len, compr->name, err);\r\ngoto no_compr;\r\n}\r\nif (in_len - *out_len < UBIFS_MIN_COMPRESS_DIFF)\r\ngoto no_compr;\r\nreturn;\r\nno_compr:\r\nmemcpy(out_buf, in_buf, in_len);\r\n*out_len = in_len;\r\n*compr_type = UBIFS_COMPR_NONE;\r\n}\r\nint ubifs_decompress(const struct ubifs_info *c, const void *in_buf,\r\nint in_len, void *out_buf, int *out_len, int compr_type)\r\n{\r\nint err;\r\nstruct ubifs_compressor *compr;\r\nif (unlikely(compr_type < 0 || compr_type >= UBIFS_COMPR_TYPES_CNT)) {\r\nubifs_err(c, "invalid compression type %d", compr_type);\r\nreturn -EINVAL;\r\n}\r\ncompr = ubifs_compressors[compr_type];\r\nif (unlikely(!compr->capi_name)) {\r\nubifs_err(c, "%s compression is not compiled in", compr->name);\r\nreturn -EINVAL;\r\n}\r\nif (compr_type == UBIFS_COMPR_NONE) {\r\nmemcpy(out_buf, in_buf, in_len);\r\n*out_len = in_len;\r\nreturn 0;\r\n}\r\nif (compr->decomp_mutex)\r\nmutex_lock(compr->decomp_mutex);\r\nerr = crypto_comp_decompress(compr->cc, in_buf, in_len, out_buf,\r\n(unsigned int *)out_len);\r\nif (compr->decomp_mutex)\r\nmutex_unlock(compr->decomp_mutex);\r\nif (err)\r\nubifs_err(c, "cannot decompress %d bytes, compressor %s, error %d",\r\nin_len, compr->name, err);\r\nreturn err;\r\n}\r\nstatic int __init compr_init(struct ubifs_compressor *compr)\r\n{\r\nif (compr->capi_name) {\r\ncompr->cc = crypto_alloc_comp(compr->capi_name, 0, 0);\r\nif (IS_ERR(compr->cc)) {\r\npr_err("UBIFS error (pid %d): cannot initialize compressor %s, error %ld",\r\ncurrent->pid, compr->name, PTR_ERR(compr->cc));\r\nreturn PTR_ERR(compr->cc);\r\n}\r\n}\r\nubifs_compressors[compr->compr_type] = compr;\r\nreturn 0;\r\n}\r\nstatic void compr_exit(struct ubifs_compressor *compr)\r\n{\r\nif (compr->capi_name)\r\ncrypto_free_comp(compr->cc);\r\nreturn;\r\n}\r\nint __init ubifs_compressors_init(void)\r\n{\r\nint err;\r\nerr = compr_init(&lzo_compr);\r\nif (err)\r\nreturn err;\r\nerr = compr_init(&zlib_compr);\r\nif (err)\r\ngoto out_lzo;\r\nubifs_compressors[UBIFS_COMPR_NONE] = &none_compr;\r\nreturn 0;\r\nout_lzo:\r\ncompr_exit(&lzo_compr);\r\nreturn err;\r\n}\r\nvoid ubifs_compressors_exit(void)\r\n{\r\ncompr_exit(&lzo_compr);\r\ncompr_exit(&zlib_compr);\r\n}

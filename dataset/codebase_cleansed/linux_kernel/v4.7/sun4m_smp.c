static inline unsigned long\r\nswap_ulong(volatile unsigned long *ptr, unsigned long val)\r\n{\r\n__asm__ __volatile__("swap [%1], %0\n\t" :\r\n"=&r" (val), "=&r" (ptr) :\r\n"0" (val), "1" (ptr));\r\nreturn val;\r\n}\r\nvoid sun4m_cpu_pre_starting(void *arg)\r\n{\r\n}\r\nvoid sun4m_cpu_pre_online(void *arg)\r\n{\r\nint cpuid = hard_smp_processor_id();\r\nswap_ulong(&cpu_callin_map[cpuid], 1);\r\nlocal_ops->cache_all();\r\nlocal_ops->tlb_all();\r\n__asm__ __volatile__("ld [%0], %%g6\n\t"\r\n: : "r" (&current_set[cpuid])\r\n: "memory" );\r\natomic_inc(&init_mm.mm_count);\r\ncurrent->active_mm = &init_mm;\r\nwhile (!cpumask_test_cpu(cpuid, &smp_commenced_mask))\r\nmb();\r\n}\r\nvoid __init smp4m_boot_cpus(void)\r\n{\r\nsun4m_unmask_profile_irq();\r\nlocal_ops->cache_all();\r\n}\r\nint smp4m_boot_one_cpu(int i, struct task_struct *idle)\r\n{\r\nunsigned long *entry = &sun4m_cpu_startup;\r\nint timeout;\r\nint cpu_node;\r\ncpu_find_by_mid(i, &cpu_node);\r\ncurrent_set[i] = task_thread_info(idle);\r\nentry += ((i - 1) * 3);\r\nsmp_penguin_ctable.which_io = 0;\r\nsmp_penguin_ctable.phys_addr = (unsigned int) srmmu_ctx_table_phys;\r\nsmp_penguin_ctable.reg_size = 0;\r\nprintk(KERN_INFO "Starting CPU %d at %p\n", i, entry);\r\nlocal_ops->cache_all();\r\nprom_startcpu(cpu_node, &smp_penguin_ctable, 0, (char *)entry);\r\nfor (timeout = 0; timeout < 10000; timeout++) {\r\nif (cpu_callin_map[i])\r\nbreak;\r\nudelay(200);\r\n}\r\nif (!(cpu_callin_map[i])) {\r\nprintk(KERN_ERR "Processor %d is stuck.\n", i);\r\nreturn -ENODEV;\r\n}\r\nlocal_ops->cache_all();\r\nreturn 0;\r\n}\r\nvoid __init smp4m_smp_done(void)\r\n{\r\nint i, first;\r\nint *prev;\r\nfirst = 0;\r\nprev = &first;\r\nfor_each_online_cpu(i) {\r\n*prev = i;\r\nprev = &cpu_data(i).next;\r\n}\r\n*prev = first;\r\nlocal_ops->cache_all();\r\n}\r\nstatic void sun4m_send_ipi(int cpu, int level)\r\n{\r\nsbus_writel(SUN4M_SOFT_INT(level), &sun4m_irq_percpu[cpu]->set);\r\n}\r\nstatic void sun4m_ipi_resched(int cpu)\r\n{\r\nsun4m_send_ipi(cpu, IRQ_IPI_RESCHED);\r\n}\r\nstatic void sun4m_ipi_single(int cpu)\r\n{\r\nsun4m_send_ipi(cpu, IRQ_IPI_SINGLE);\r\n}\r\nstatic void sun4m_ipi_mask_one(int cpu)\r\n{\r\nsun4m_send_ipi(cpu, IRQ_IPI_MASK);\r\n}\r\nstatic void sun4m_cross_call(smpfunc_t func, cpumask_t mask, unsigned long arg1,\r\nunsigned long arg2, unsigned long arg3,\r\nunsigned long arg4)\r\n{\r\nregister int ncpus = SUN4M_NCPUS;\r\nunsigned long flags;\r\nspin_lock_irqsave(&cross_call_lock, flags);\r\nccall_info.func = func;\r\nccall_info.arg1 = arg1;\r\nccall_info.arg2 = arg2;\r\nccall_info.arg3 = arg3;\r\nccall_info.arg4 = arg4;\r\nccall_info.arg5 = 0;\r\n{\r\nregister int i;\r\ncpumask_clear_cpu(smp_processor_id(), &mask);\r\ncpumask_and(&mask, cpu_online_mask, &mask);\r\nfor (i = 0; i < ncpus; i++) {\r\nif (cpumask_test_cpu(i, &mask)) {\r\nccall_info.processors_in[i] = 0;\r\nccall_info.processors_out[i] = 0;\r\nsun4m_send_ipi(i, IRQ_CROSS_CALL);\r\n} else {\r\nccall_info.processors_in[i] = 1;\r\nccall_info.processors_out[i] = 1;\r\n}\r\n}\r\n}\r\n{\r\nregister int i;\r\ni = 0;\r\ndo {\r\nif (!cpumask_test_cpu(i, &mask))\r\ncontinue;\r\nwhile (!ccall_info.processors_in[i])\r\nbarrier();\r\n} while (++i < ncpus);\r\ni = 0;\r\ndo {\r\nif (!cpumask_test_cpu(i, &mask))\r\ncontinue;\r\nwhile (!ccall_info.processors_out[i])\r\nbarrier();\r\n} while (++i < ncpus);\r\n}\r\nspin_unlock_irqrestore(&cross_call_lock, flags);\r\n}\r\nvoid smp4m_cross_call_irq(void)\r\n{\r\nint i = smp_processor_id();\r\nccall_info.processors_in[i] = 1;\r\nccall_info.func(ccall_info.arg1, ccall_info.arg2, ccall_info.arg3,\r\nccall_info.arg4, ccall_info.arg5);\r\nccall_info.processors_out[i] = 1;\r\n}\r\nvoid smp4m_percpu_timer_interrupt(struct pt_regs *regs)\r\n{\r\nstruct pt_regs *old_regs;\r\nstruct clock_event_device *ce;\r\nint cpu = smp_processor_id();\r\nold_regs = set_irq_regs(regs);\r\nce = &per_cpu(sparc32_clockevent, cpu);\r\nif (clockevent_state_periodic(ce))\r\nsun4m_clear_profile_irq(cpu);\r\nelse\r\nsparc_config.load_profile_irq(cpu, 0);\r\nirq_enter();\r\nce->event_handler(ce);\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}\r\nvoid __init sun4m_init_smp(void)\r\n{\r\nsparc32_ipi_ops = &sun4m_ipi_ops;\r\n}

static void s3c_pm_run_res(struct resource *ptr, run_fn_t fn, u32 *arg)\r\n{\r\nwhile (ptr != NULL) {\r\nif (ptr->child != NULL)\r\ns3c_pm_run_res(ptr->child, fn, arg);\r\nif ((ptr->flags & IORESOURCE_SYSTEM_RAM)\r\n== IORESOURCE_SYSTEM_RAM) {\r\nS3C_PMDBG("Found system RAM at %08lx..%08lx\n",\r\n(unsigned long)ptr->start,\r\n(unsigned long)ptr->end);\r\narg = (fn)(ptr, arg);\r\n}\r\nptr = ptr->sibling;\r\n}\r\n}\r\nstatic void s3c_pm_run_sysram(run_fn_t fn, u32 *arg)\r\n{\r\ns3c_pm_run_res(&iomem_resource, fn, arg);\r\n}\r\nstatic u32 *s3c_pm_countram(struct resource *res, u32 *val)\r\n{\r\nu32 size = (u32)resource_size(res);\r\nsize += CHECK_CHUNKSIZE-1;\r\nsize /= CHECK_CHUNKSIZE;\r\nS3C_PMDBG("Area %08lx..%08lx, %d blocks\n",\r\n(unsigned long)res->start, (unsigned long)res->end, size);\r\n*val += size * sizeof(u32);\r\nreturn val;\r\n}\r\nvoid s3c_pm_check_prepare(void)\r\n{\r\ncrc_size = 0;\r\ns3c_pm_run_sysram(s3c_pm_countram, &crc_size);\r\nS3C_PMDBG("s3c_pm_prepare_check: %u checks needed\n", crc_size);\r\ncrcs = kmalloc(crc_size+4, GFP_KERNEL);\r\nif (crcs == NULL)\r\nprintk(KERN_ERR "Cannot allocated CRC save area\n");\r\n}\r\nstatic u32 *s3c_pm_makecheck(struct resource *res, u32 *val)\r\n{\r\nunsigned long addr, left;\r\nfor (addr = res->start; addr < res->end;\r\naddr += CHECK_CHUNKSIZE) {\r\nleft = res->end - addr;\r\nif (left > CHECK_CHUNKSIZE)\r\nleft = CHECK_CHUNKSIZE;\r\n*val = crc32_le(~0, phys_to_virt(addr), left);\r\nval++;\r\n}\r\nreturn val;\r\n}\r\nvoid s3c_pm_check_store(void)\r\n{\r\nif (crcs != NULL)\r\ns3c_pm_run_sysram(s3c_pm_makecheck, crcs);\r\n}\r\nstatic inline int in_region(void *ptr, int size, void *what, size_t whatsz)\r\n{\r\nif ((what+whatsz) < ptr)\r\nreturn 0;\r\nif (what > (ptr+size))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic u32 *s3c_pm_runcheck(struct resource *res, u32 *val)\r\n{\r\nunsigned long addr;\r\nunsigned long left;\r\nvoid *stkpage;\r\nvoid *ptr;\r\nu32 calc;\r\nstkpage = (void *)((u32)&calc & ~PAGE_MASK);\r\nfor (addr = res->start; addr < res->end;\r\naddr += CHECK_CHUNKSIZE) {\r\nleft = res->end - addr;\r\nif (left > CHECK_CHUNKSIZE)\r\nleft = CHECK_CHUNKSIZE;\r\nptr = phys_to_virt(addr);\r\nif (in_region(ptr, left, stkpage, 4096)) {\r\nS3C_PMDBG("skipping %08lx, has stack in\n", addr);\r\ngoto skip_check;\r\n}\r\nif (in_region(ptr, left, crcs, crc_size)) {\r\nS3C_PMDBG("skipping %08lx, has crc block in\n", addr);\r\ngoto skip_check;\r\n}\r\ncalc = crc32_le(~0, ptr, left);\r\nif (calc != *val) {\r\nprintk(KERN_ERR "Restore CRC error at "\r\n"%08lx (%08x vs %08x)\n", addr, calc, *val);\r\nS3C_PMDBG("Restore CRC error at %08lx (%08x vs %08x)\n",\r\naddr, calc, *val);\r\n}\r\nskip_check:\r\nval++;\r\n}\r\nreturn val;\r\n}\r\nvoid s3c_pm_check_restore(void)\r\n{\r\nif (crcs != NULL)\r\ns3c_pm_run_sysram(s3c_pm_runcheck, crcs);\r\n}\r\nvoid s3c_pm_check_cleanup(void)\r\n{\r\nkfree(crcs);\r\ncrcs = NULL;\r\n}

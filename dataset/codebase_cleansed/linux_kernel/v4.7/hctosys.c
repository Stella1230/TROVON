static int __init rtc_hctosys(void)\r\n{\r\nint err = -ENODEV;\r\nstruct rtc_time tm;\r\nstruct timespec64 tv64 = {\r\n.tv_nsec = NSEC_PER_SEC >> 1,\r\n};\r\nstruct rtc_device *rtc = rtc_class_open(CONFIG_RTC_HCTOSYS_DEVICE);\r\nif (rtc == NULL) {\r\npr_info("unable to open rtc device (%s)\n",\r\nCONFIG_RTC_HCTOSYS_DEVICE);\r\ngoto err_open;\r\n}\r\nerr = rtc_read_time(rtc, &tm);\r\nif (err) {\r\ndev_err(rtc->dev.parent,\r\n"hctosys: unable to read the hardware clock\n");\r\ngoto err_read;\r\n}\r\ntv64.tv_sec = rtc_tm_to_time64(&tm);\r\nerr = do_settimeofday64(&tv64);\r\ndev_info(rtc->dev.parent,\r\n"setting system clock to "\r\n"%d-%02d-%02d %02d:%02d:%02d UTC (%lld)\n",\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday,\r\ntm.tm_hour, tm.tm_min, tm.tm_sec,\r\n(long long) tv64.tv_sec);\r\nerr_read:\r\nrtc_class_close(rtc);\r\nerr_open:\r\nrtc_hctosys_ret = err;\r\nreturn err;\r\n}

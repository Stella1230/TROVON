static void superhyway_device_release(struct device *dev)\r\n{\r\nstruct superhyway_device *sdev = to_superhyway_device(dev);\r\nkfree(sdev->resource);\r\nkfree(sdev);\r\n}\r\nint superhyway_add_device(unsigned long base, struct superhyway_device *sdev,\r\nstruct superhyway_bus *bus)\r\n{\r\nstruct superhyway_device *dev = sdev;\r\nif (!dev) {\r\ndev = kzalloc(sizeof(struct superhyway_device), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\n}\r\ndev->bus = bus;\r\nsuperhyway_read_vcr(dev, base, &dev->vcr);\r\nif (!dev->resource) {\r\ndev->resource = kzalloc(sizeof(struct resource), GFP_KERNEL);\r\nif (!dev->resource) {\r\nkfree(dev);\r\nreturn -ENOMEM;\r\n}\r\ndev->resource->name = dev->name;\r\ndev->resource->start = base;\r\ndev->resource->end = dev->resource->start + 0x01000000;\r\n}\r\ndev->dev.parent = &superhyway_bus_device;\r\ndev->dev.bus = &superhyway_bus_type;\r\ndev->dev.release = superhyway_device_release;\r\ndev->id.id = dev->vcr.mod_id;\r\nsprintf(dev->name, "SuperHyway device %04x", dev->id.id);\r\ndev_set_name(&dev->dev, "%02x", superhyway_devices);\r\nsuperhyway_devices++;\r\nreturn device_register(&dev->dev);\r\n}\r\nint superhyway_add_devices(struct superhyway_bus *bus,\r\nstruct superhyway_device **devices,\r\nint nr_devices)\r\n{\r\nint i, ret = 0;\r\nfor (i = 0; i < nr_devices; i++) {\r\nstruct superhyway_device *dev = devices[i];\r\nret |= superhyway_add_device(dev->resource[0].start, dev, bus);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init superhyway_init(void)\r\n{\r\nstruct superhyway_bus *bus;\r\nint ret;\r\nret = device_register(&superhyway_bus_device);\r\nif (unlikely(ret))\r\nreturn ret;\r\nfor (bus = superhyway_channels; bus->ops; bus++)\r\nret |= superhyway_scan_bus(bus);\r\nreturn ret;\r\n}\r\nstatic const struct superhyway_device_id *\r\nsuperhyway_match_id(const struct superhyway_device_id *ids,\r\nstruct superhyway_device *dev)\r\n{\r\nwhile (ids->id) {\r\nif (ids->id == dev->id.id)\r\nreturn ids;\r\nids++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int superhyway_device_probe(struct device *dev)\r\n{\r\nstruct superhyway_device *shyway_dev = to_superhyway_device(dev);\r\nstruct superhyway_driver *shyway_drv = to_superhyway_driver(dev->driver);\r\nif (shyway_drv && shyway_drv->probe) {\r\nconst struct superhyway_device_id *id;\r\nid = superhyway_match_id(shyway_drv->id_table, shyway_dev);\r\nif (id)\r\nreturn shyway_drv->probe(shyway_dev, id);\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int superhyway_device_remove(struct device *dev)\r\n{\r\nstruct superhyway_device *shyway_dev = to_superhyway_device(dev);\r\nstruct superhyway_driver *shyway_drv = to_superhyway_driver(dev->driver);\r\nif (shyway_drv && shyway_drv->remove) {\r\nshyway_drv->remove(shyway_dev);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint superhyway_register_driver(struct superhyway_driver *drv)\r\n{\r\ndrv->drv.name = drv->name;\r\ndrv->drv.bus = &superhyway_bus_type;\r\nreturn driver_register(&drv->drv);\r\n}\r\nvoid superhyway_unregister_driver(struct superhyway_driver *drv)\r\n{\r\ndriver_unregister(&drv->drv);\r\n}\r\nstatic int superhyway_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct superhyway_device *shyway_dev = to_superhyway_device(dev);\r\nstruct superhyway_driver *shyway_drv = to_superhyway_driver(drv);\r\nconst struct superhyway_device_id *ids = shyway_drv->id_table;\r\nif (!ids)\r\nreturn -EINVAL;\r\nif (superhyway_match_id(ids, shyway_dev))\r\nreturn 1;\r\nreturn -ENODEV;\r\n}\r\nstatic int __init superhyway_bus_init(void)\r\n{\r\nreturn bus_register(&superhyway_bus_type);\r\n}\r\nstatic void __exit superhyway_bus_exit(void)\r\n{\r\ndevice_unregister(&superhyway_bus_device);\r\nbus_unregister(&superhyway_bus_type);\r\n}

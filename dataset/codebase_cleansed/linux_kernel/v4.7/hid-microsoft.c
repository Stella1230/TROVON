static __u8 *ms_report_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nif ((quirks & MS_RDESC) && *rsize == 571 && rdesc[557] == 0x19 &&\r\nrdesc[559] == 0x29) {\r\nhid_info(hdev, "fixing up Microsoft Wireless Receiver Model 1028 report descriptor\n");\r\nrdesc[557] = 0x35;\r\nrdesc[559] = 0x45;\r\n}\r\nif ((quirks & MS_RDESC_3K) && *rsize == 106 && rdesc[94] == 0x19 &&\r\nrdesc[95] == 0x00 && rdesc[96] == 0x29 &&\r\nrdesc[97] == 0xff) {\r\nrdesc[94] = 0x35;\r\nrdesc[96] = 0x45;\r\n}\r\nreturn rdesc;\r\n}\r\nstatic int ms_ergonomy_kb_quirk(struct hid_input *hi, struct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nstruct input_dev *input = hi->input;\r\nif ((usage->hid & HID_USAGE_PAGE) == HID_UP_CONSUMER) {\r\nswitch (usage->hid & HID_USAGE) {\r\ncase 0x29d:\r\nms_map_key_clear(KEY_PROG1);\r\nreturn 1;\r\ncase 0x29e:\r\nms_map_key_clear(KEY_PROG2);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nif ((usage->hid & HID_USAGE_PAGE) != HID_UP_MSVENDOR)\r\nreturn 0;\r\nswitch (usage->hid & HID_USAGE) {\r\ncase 0xfd06: ms_map_key_clear(KEY_CHAT); break;\r\ncase 0xfd07: ms_map_key_clear(KEY_PHONE); break;\r\ncase 0xff00:\r\nms_map_key_clear(KEY_KPEQUAL);\r\nset_bit(KEY_KPLEFTPAREN, input->keybit);\r\nset_bit(KEY_KPRIGHTPAREN, input->keybit);\r\nbreak;\r\ncase 0xff01:\r\nhid_map_usage_clear(hi, usage, bit, max, EV_REL, REL_WHEEL);\r\nbreak;\r\ncase 0xff02:\r\nreturn -1;\r\ncase 0xff05:\r\nset_bit(EV_REP, input->evbit);\r\nms_map_key_clear(KEY_F13);\r\nset_bit(KEY_F14, input->keybit);\r\nset_bit(KEY_F15, input->keybit);\r\nset_bit(KEY_F16, input->keybit);\r\nset_bit(KEY_F17, input->keybit);\r\nset_bit(KEY_F18, input->keybit);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ms_presenter_8k_quirk(struct hid_input *hi, struct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nif ((usage->hid & HID_USAGE_PAGE) != HID_UP_MSVENDOR)\r\nreturn 0;\r\nset_bit(EV_REP, hi->input->evbit);\r\nswitch (usage->hid & HID_USAGE) {\r\ncase 0xfd08: ms_map_key_clear(KEY_FORWARD); break;\r\ncase 0xfd09: ms_map_key_clear(KEY_BACK); break;\r\ncase 0xfd0b: ms_map_key_clear(KEY_PLAYPAUSE); break;\r\ncase 0xfd0e: ms_map_key_clear(KEY_CLOSE); break;\r\ncase 0xfd0f: ms_map_key_clear(KEY_PLAY); break;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ms_input_mapping(struct hid_device *hdev, struct hid_input *hi,\r\nstruct hid_field *field, struct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nif (quirks & MS_ERGONOMY) {\r\nint ret = ms_ergonomy_kb_quirk(hi, usage, bit, max);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((quirks & MS_PRESENTER) &&\r\nms_presenter_8k_quirk(hi, usage, bit, max))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int ms_input_mapped(struct hid_device *hdev, struct hid_input *hi,\r\nstruct hid_field *field, struct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nif (quirks & MS_DUPLICATE_USAGES)\r\nclear_bit(usage->code, *bit);\r\nreturn 0;\r\n}\r\nstatic int ms_event(struct hid_device *hdev, struct hid_field *field,\r\nstruct hid_usage *usage, __s32 value)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nstruct input_dev *input;\r\nif (!(hdev->claimed & HID_CLAIMED_INPUT) || !field->hidinput ||\r\n!usage->type)\r\nreturn 0;\r\ninput = field->hidinput->input;\r\nif (quirks & MS_ERGONOMY && usage->hid == (HID_UP_MSVENDOR | 0xff00)) {\r\ninput_report_key(input, KEY_KPEQUAL, value & 0x01);\r\ninput_report_key(input, KEY_KPLEFTPAREN, value & 0x02);\r\ninput_report_key(input, KEY_KPRIGHTPAREN, value & 0x04);\r\nreturn 1;\r\n}\r\nif (quirks & MS_ERGONOMY && usage->hid == (HID_UP_MSVENDOR | 0xff01)) {\r\nint step = ((value & 0x60) >> 5) + 1;\r\nswitch (value & 0x1f) {\r\ncase 0x01:\r\ninput_report_rel(input, REL_WHEEL, step);\r\nbreak;\r\ncase 0x1f:\r\ninput_report_rel(input, REL_WHEEL, -step);\r\nbreak;\r\n}\r\nreturn 1;\r\n}\r\nif (quirks & MS_ERGONOMY && usage->hid == (HID_UP_MSVENDOR | 0xff05)) {\r\nstatic unsigned int last_key = 0;\r\nunsigned int key = 0;\r\nswitch (value) {\r\ncase 0x01: key = KEY_F14; break;\r\ncase 0x02: key = KEY_F15; break;\r\ncase 0x04: key = KEY_F16; break;\r\ncase 0x08: key = KEY_F17; break;\r\ncase 0x10: key = KEY_F18; break;\r\n}\r\nif (key) {\r\ninput_event(input, usage->type, key, 1);\r\nlast_key = key;\r\n} else\r\ninput_event(input, usage->type, last_key, 0);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ms_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nunsigned long quirks = id->driver_data;\r\nint ret;\r\nhid_set_drvdata(hdev, (void *)quirks);\r\nif (quirks & MS_NOGET)\r\nhdev->quirks |= HID_QUIRK_NOGET;\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto err_free;\r\n}\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT | ((quirks & MS_HIDINPUT) ?\r\nHID_CONNECT_HIDINPUT_FORCE : 0));\r\nif (ret) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto err_free;\r\n}\r\nreturn 0;\r\nerr_free:\r\nreturn ret;\r\n}

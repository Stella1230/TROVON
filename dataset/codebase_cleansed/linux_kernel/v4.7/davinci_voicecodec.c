static int __init davinci_vc_probe(struct platform_device *pdev)\r\n{\r\nstruct davinci_vc *davinci_vc;\r\nstruct resource *res;\r\nstruct mfd_cell *cell = NULL;\r\nint ret;\r\ndavinci_vc = devm_kzalloc(&pdev->dev,\r\nsizeof(struct davinci_vc), GFP_KERNEL);\r\nif (!davinci_vc)\r\nreturn -ENOMEM;\r\ndavinci_vc->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(davinci_vc->clk)) {\r\ndev_dbg(&pdev->dev,\r\n"could not get the clock for voice codec\n");\r\nreturn -ENODEV;\r\n}\r\nclk_enable(davinci_vc->clk);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndavinci_vc->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(davinci_vc->base)) {\r\nret = PTR_ERR(davinci_vc->base);\r\ngoto fail;\r\n}\r\ndavinci_vc->regmap = devm_regmap_init_mmio(&pdev->dev,\r\ndavinci_vc->base,\r\n&davinci_vc_regmap);\r\nif (IS_ERR(davinci_vc->regmap)) {\r\nret = PTR_ERR(davinci_vc->regmap);\r\ngoto fail;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "no DMA resource\n");\r\nret = -ENXIO;\r\ngoto fail;\r\n}\r\ndavinci_vc->davinci_vcif.dma_tx_channel = res->start;\r\ndavinci_vc->davinci_vcif.dma_tx_addr =\r\n(dma_addr_t)(io_v2p(davinci_vc->base) + DAVINCI_VC_WFIFO);\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!res) {\r\ndev_err(&pdev->dev, "no DMA resource\n");\r\nret = -ENXIO;\r\ngoto fail;\r\n}\r\ndavinci_vc->davinci_vcif.dma_rx_channel = res->start;\r\ndavinci_vc->davinci_vcif.dma_rx_addr =\r\n(dma_addr_t)(io_v2p(davinci_vc->base) + DAVINCI_VC_RFIFO);\r\ndavinci_vc->dev = &pdev->dev;\r\ndavinci_vc->pdev = pdev;\r\ncell = &davinci_vc->cells[DAVINCI_VC_VCIF_CELL];\r\ncell->name = "davinci-vcif";\r\ncell->platform_data = davinci_vc;\r\ncell->pdata_size = sizeof(*davinci_vc);\r\ncell = &davinci_vc->cells[DAVINCI_VC_CQ93VC_CELL];\r\ncell->name = "cq93vc-codec";\r\ncell->platform_data = davinci_vc;\r\ncell->pdata_size = sizeof(*davinci_vc);\r\nret = mfd_add_devices(&pdev->dev, pdev->id, davinci_vc->cells,\r\nDAVINCI_VC_CELLS, NULL, 0, NULL);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "fail to register client devices\n");\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nclk_disable(davinci_vc->clk);\r\nreturn ret;\r\n}\r\nstatic int davinci_vc_remove(struct platform_device *pdev)\r\n{\r\nstruct davinci_vc *davinci_vc = platform_get_drvdata(pdev);\r\nmfd_remove_devices(&pdev->dev);\r\nclk_disable(davinci_vc->clk);\r\nreturn 0;\r\n}

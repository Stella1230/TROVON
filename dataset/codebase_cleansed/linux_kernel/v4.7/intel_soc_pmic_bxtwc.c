static int regmap_ipc_byte_reg_read(void *context, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nint ret;\r\nint i2c_addr;\r\nu8 ipc_in[2];\r\nu8 ipc_out[4];\r\nstruct intel_soc_pmic *pmic = context;\r\nif (reg & REG_ADDR_MASK)\r\ni2c_addr = (reg & REG_ADDR_MASK) >> REG_ADDR_SHIFT;\r\nelse {\r\ni2c_addr = BXTWC_DEVICE1_ADDR;\r\nif (!i2c_addr) {\r\ndev_err(pmic->dev, "I2C address not set\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreg &= REG_OFFSET_MASK;\r\nipc_in[0] = reg;\r\nipc_in[1] = i2c_addr;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMIC_ACCESS,\r\nPMC_IPC_PMIC_ACCESS_READ,\r\nipc_in, sizeof(ipc_in), (u32 *)ipc_out, 1);\r\nif (ret) {\r\ndev_err(pmic->dev, "Failed to read from PMIC\n");\r\nreturn ret;\r\n}\r\n*val = ipc_out[0];\r\nreturn 0;\r\n}\r\nstatic int regmap_ipc_byte_reg_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nint ret;\r\nint i2c_addr;\r\nu8 ipc_in[3];\r\nstruct intel_soc_pmic *pmic = context;\r\nif (reg & REG_ADDR_MASK)\r\ni2c_addr = (reg & REG_ADDR_MASK) >> REG_ADDR_SHIFT;\r\nelse {\r\ni2c_addr = BXTWC_DEVICE1_ADDR;\r\nif (!i2c_addr) {\r\ndev_err(pmic->dev, "I2C address not set\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreg &= REG_OFFSET_MASK;\r\nipc_in[0] = reg;\r\nipc_in[1] = i2c_addr;\r\nipc_in[2] = val;\r\nret = intel_pmc_ipc_command(PMC_IPC_PMIC_ACCESS,\r\nPMC_IPC_PMIC_ACCESS_WRITE,\r\nipc_in, sizeof(ipc_in), NULL, 0);\r\nif (ret) {\r\ndev_err(pmic->dev, "Failed to write to PMIC\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t bxtwc_reg_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "0x%lx\n", bxtwc_reg_addr);\r\n}\r\nstatic ssize_t bxtwc_reg_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nif (kstrtoul(buf, 0, &bxtwc_reg_addr)) {\r\ndev_err(dev, "Invalid register address\n");\r\nreturn -EINVAL;\r\n}\r\nreturn (ssize_t)count;\r\n}\r\nstatic ssize_t bxtwc_val_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint ret;\r\nunsigned int val;\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\nret = regmap_read(pmic->regmap, bxtwc_reg_addr, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read 0x%lx\n", bxtwc_reg_addr);\r\nreturn -EIO;\r\n}\r\nreturn sprintf(buf, "0x%02x\n", val);\r\n}\r\nstatic ssize_t bxtwc_val_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nint ret;\r\nunsigned int val;\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\nret = kstrtouint(buf, 0, &val);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(pmic->regmap, bxtwc_reg_addr, val);\r\nif (ret) {\r\ndev_err(dev, "Failed to write value 0x%02x to address 0x%lx",\r\nval, bxtwc_reg_addr);\r\nreturn -EIO;\r\n}\r\nreturn count;\r\n}\r\nstatic int bxtwc_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nacpi_handle handle;\r\nacpi_status status;\r\nunsigned long long hrv;\r\nstruct intel_soc_pmic *pmic;\r\nhandle = ACPI_HANDLE(&pdev->dev);\r\nstatus = acpi_evaluate_integer(handle, "_HRV", NULL, &hrv);\r\nif (ACPI_FAILURE(status)) {\r\ndev_err(&pdev->dev, "Failed to get PMIC hardware revision\n");\r\nreturn -ENODEV;\r\n}\r\nif (hrv != BROXTON_PMIC_WC_HRV) {\r\ndev_err(&pdev->dev, "Invalid PMIC hardware revision: %llu\n",\r\nhrv);\r\nreturn -ENODEV;\r\n}\r\npmic = devm_kzalloc(&pdev->dev, sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic)\r\nreturn -ENOMEM;\r\nret = platform_get_irq(pdev, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Invalid IRQ\n");\r\nreturn ret;\r\n}\r\npmic->irq = ret;\r\ndev_set_drvdata(&pdev->dev, pmic);\r\npmic->dev = &pdev->dev;\r\npmic->regmap = devm_regmap_init(&pdev->dev, NULL, pmic,\r\n&bxtwc_regmap_config);\r\nif (IS_ERR(pmic->regmap)) {\r\nret = PTR_ERR(pmic->regmap);\r\ndev_err(&pdev->dev, "Failed to initialise regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_add_irq_chip(pmic->regmap, pmic->irq,\r\nIRQF_ONESHOT | IRQF_SHARED,\r\n0, &bxtwc_regmap_irq_chip,\r\n&pmic->irq_chip_data);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add IRQ chip\n");\r\nreturn ret;\r\n}\r\nret = regmap_add_irq_chip(pmic->regmap, pmic->irq,\r\nIRQF_ONESHOT | IRQF_SHARED,\r\n0, &bxtwc_regmap_irq_chip_level2,\r\n&pmic->irq_chip_data_level2);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add secondary IRQ chip\n");\r\ngoto err_irq_chip_level2;\r\n}\r\nret = mfd_add_devices(&pdev->dev, PLATFORM_DEVID_NONE, bxt_wc_dev,\r\nARRAY_SIZE(bxt_wc_dev), NULL, 0,\r\nNULL);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add devices\n");\r\ngoto err_mfd;\r\n}\r\nret = sysfs_create_group(&pdev->dev.kobj, &bxtwc_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to create sysfs group %d\n", ret);\r\ngoto err_sysfs;\r\n}\r\nreturn 0;\r\nerr_sysfs:\r\nmfd_remove_devices(&pdev->dev);\r\nerr_mfd:\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data_level2);\r\nerr_irq_chip_level2:\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data);\r\nreturn ret;\r\n}\r\nstatic int bxtwc_remove(struct platform_device *pdev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(&pdev->dev);\r\nsysfs_remove_group(&pdev->dev.kobj, &bxtwc_group);\r\nmfd_remove_devices(&pdev->dev);\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data);\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data_level2);\r\nreturn 0;\r\n}\r\nstatic void bxtwc_shutdown(struct platform_device *pdev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(&pdev->dev);\r\ndisable_irq(pmic->irq);\r\n}\r\nstatic int bxtwc_suspend(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\ndisable_irq(pmic->irq);\r\nreturn 0;\r\n}\r\nstatic int bxtwc_resume(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\nenable_irq(pmic->irq);\r\nreturn 0;\r\n}

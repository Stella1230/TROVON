u32 fc_frame_crc_check(struct fc_frame *fp)\r\n{\r\nu32 crc;\r\nu32 error;\r\nconst u8 *bp;\r\nunsigned int len;\r\nWARN_ON(!fc_frame_is_linear(fp));\r\nfr_flags(fp) &= ~FCPHF_CRC_UNCHECKED;\r\nlen = (fr_len(fp) + 3) & ~3;\r\nbp = (const u8 *) fr_hdr(fp);\r\ncrc = ~crc32(~0, bp, len);\r\nerror = crc ^ fr_crc(fp);\r\nreturn error;\r\n}\r\nstruct fc_frame *_fc_frame_alloc(size_t len)\r\n{\r\nstruct fc_frame *fp;\r\nstruct sk_buff *skb;\r\nWARN_ON((len % sizeof(u32)) != 0);\r\nlen += sizeof(struct fc_frame_header);\r\nskb = alloc_skb_fclone(len + FC_FRAME_HEADROOM + FC_FRAME_TAILROOM +\r\nNET_SKB_PAD, GFP_ATOMIC);\r\nif (!skb)\r\nreturn NULL;\r\nskb_reserve(skb, NET_SKB_PAD + FC_FRAME_HEADROOM);\r\nfp = (struct fc_frame *) skb;\r\nfc_frame_init(fp);\r\nskb_put(skb, len);\r\nreturn fp;\r\n}\r\nstruct fc_frame *fc_frame_alloc_fill(struct fc_lport *lp, size_t payload_len)\r\n{\r\nstruct fc_frame *fp;\r\nsize_t fill;\r\nfill = payload_len % 4;\r\nif (fill != 0)\r\nfill = 4 - fill;\r\nfp = _fc_frame_alloc(payload_len + fill);\r\nif (fp) {\r\nmemset((char *) fr_hdr(fp) + payload_len, 0, fill);\r\nskb_trim(fp_skb(fp),\r\npayload_len + sizeof(struct fc_frame_header));\r\n}\r\nreturn fp;\r\n}

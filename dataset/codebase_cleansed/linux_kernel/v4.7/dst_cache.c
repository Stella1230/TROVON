static void dst_cache_per_cpu_dst_set(struct dst_cache_pcpu *dst_cache,\r\nstruct dst_entry *dst, u32 cookie)\r\n{\r\ndst_release(dst_cache->dst);\r\nif (dst)\r\ndst_hold(dst);\r\ndst_cache->cookie = cookie;\r\ndst_cache->dst = dst;\r\n}\r\nstatic struct dst_entry *dst_cache_per_cpu_get(struct dst_cache *dst_cache,\r\nstruct dst_cache_pcpu *idst)\r\n{\r\nstruct dst_entry *dst;\r\ndst = idst->dst;\r\nif (!dst)\r\ngoto fail;\r\ndst_hold(dst);\r\nif (unlikely(!time_after(idst->refresh_ts, dst_cache->reset_ts) ||\r\n(dst->obsolete && !dst->ops->check(dst, idst->cookie)))) {\r\ndst_cache_per_cpu_dst_set(idst, NULL, 0);\r\ndst_release(dst);\r\ngoto fail;\r\n}\r\nreturn dst;\r\nfail:\r\nidst->refresh_ts = jiffies;\r\nreturn NULL;\r\n}\r\nstruct dst_entry *dst_cache_get(struct dst_cache *dst_cache)\r\n{\r\nif (!dst_cache->cache)\r\nreturn NULL;\r\nreturn dst_cache_per_cpu_get(dst_cache, this_cpu_ptr(dst_cache->cache));\r\n}\r\nstruct rtable *dst_cache_get_ip4(struct dst_cache *dst_cache, __be32 *saddr)\r\n{\r\nstruct dst_cache_pcpu *idst;\r\nstruct dst_entry *dst;\r\nif (!dst_cache->cache)\r\nreturn NULL;\r\nidst = this_cpu_ptr(dst_cache->cache);\r\ndst = dst_cache_per_cpu_get(dst_cache, idst);\r\nif (!dst)\r\nreturn NULL;\r\n*saddr = idst->in_saddr.s_addr;\r\nreturn container_of(dst, struct rtable, dst);\r\n}\r\nvoid dst_cache_set_ip4(struct dst_cache *dst_cache, struct dst_entry *dst,\r\n__be32 saddr)\r\n{\r\nstruct dst_cache_pcpu *idst;\r\nif (!dst_cache->cache)\r\nreturn;\r\nidst = this_cpu_ptr(dst_cache->cache);\r\ndst_cache_per_cpu_dst_set(idst, dst, 0);\r\nidst->in_saddr.s_addr = saddr;\r\n}\r\nvoid dst_cache_set_ip6(struct dst_cache *dst_cache, struct dst_entry *dst,\r\nconst struct in6_addr *addr)\r\n{\r\nstruct dst_cache_pcpu *idst;\r\nif (!dst_cache->cache)\r\nreturn;\r\nidst = this_cpu_ptr(dst_cache->cache);\r\ndst_cache_per_cpu_dst_set(this_cpu_ptr(dst_cache->cache), dst,\r\nrt6_get_cookie((struct rt6_info *)dst));\r\nidst->in6_saddr = *addr;\r\n}\r\nstruct dst_entry *dst_cache_get_ip6(struct dst_cache *dst_cache,\r\nstruct in6_addr *saddr)\r\n{\r\nstruct dst_cache_pcpu *idst;\r\nstruct dst_entry *dst;\r\nif (!dst_cache->cache)\r\nreturn NULL;\r\nidst = this_cpu_ptr(dst_cache->cache);\r\ndst = dst_cache_per_cpu_get(dst_cache, idst);\r\nif (!dst)\r\nreturn NULL;\r\n*saddr = idst->in6_saddr;\r\nreturn dst;\r\n}\r\nint dst_cache_init(struct dst_cache *dst_cache, gfp_t gfp)\r\n{\r\ndst_cache->cache = alloc_percpu_gfp(struct dst_cache_pcpu,\r\ngfp | __GFP_ZERO);\r\nif (!dst_cache->cache)\r\nreturn -ENOMEM;\r\ndst_cache_reset(dst_cache);\r\nreturn 0;\r\n}\r\nvoid dst_cache_destroy(struct dst_cache *dst_cache)\r\n{\r\nint i;\r\nif (!dst_cache->cache)\r\nreturn;\r\nfor_each_possible_cpu(i)\r\ndst_release(per_cpu_ptr(dst_cache->cache, i)->dst);\r\nfree_percpu(dst_cache->cache);\r\n}

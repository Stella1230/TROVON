static void __init st_clksrc_reset(void)\r\n{\r\nwritel_relaxed(0, ddata.base + LPC_LPT_START_OFF);\r\nwritel_relaxed(0, ddata.base + LPC_LPT_MSB_OFF);\r\nwritel_relaxed(0, ddata.base + LPC_LPT_LSB_OFF);\r\nwritel_relaxed(1, ddata.base + LPC_LPT_START_OFF);\r\n}\r\nstatic u64 notrace st_clksrc_sched_clock_read(void)\r\n{\r\nreturn (u64)readl_relaxed(ddata.base + LPC_LPT_LSB_OFF);\r\n}\r\nstatic int __init st_clksrc_init(void)\r\n{\r\nunsigned long rate;\r\nint ret;\r\nst_clksrc_reset();\r\nrate = clk_get_rate(ddata.clk);\r\nsched_clock_register(st_clksrc_sched_clock_read, 32, rate);\r\nret = clocksource_mmio_init(ddata.base + LPC_LPT_LSB_OFF,\r\n"clksrc-st-lpc", rate, 300, 32,\r\nclocksource_mmio_readl_up);\r\nif (ret) {\r\npr_err("clksrc-st-lpc: Failed to register clocksource\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init st_clksrc_setup_clk(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("clksrc-st-lpc: Failed to get LPC clock\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nif (clk_prepare_enable(clk)) {\r\npr_err("clksrc-st-lpc: Failed to enable LPC clock\n");\r\nreturn -EINVAL;\r\n}\r\nif (!clk_get_rate(clk)) {\r\npr_err("clksrc-st-lpc: Failed to get LPC clock rate\n");\r\nclk_disable_unprepare(clk);\r\nreturn -EINVAL;\r\n}\r\nddata.clk = clk;\r\nreturn 0;\r\n}\r\nstatic void __init st_clksrc_of_register(struct device_node *np)\r\n{\r\nint ret;\r\nuint32_t mode;\r\nret = of_property_read_u32(np, "st,lpc-mode", &mode);\r\nif (ret) {\r\npr_err("clksrc-st-lpc: An LPC mode must be provided\n");\r\nreturn;\r\n}\r\nif (mode != ST_LPC_MODE_CLKSRC)\r\nreturn;\r\nddata.base = of_iomap(np, 0);\r\nif (!ddata.base) {\r\npr_err("clksrc-st-lpc: Unable to map iomem\n");\r\nreturn;\r\n}\r\nif (st_clksrc_setup_clk(np)) {\r\niounmap(ddata.base);\r\nreturn;\r\n}\r\nif (st_clksrc_init()) {\r\nclk_disable_unprepare(ddata.clk);\r\nclk_put(ddata.clk);\r\niounmap(ddata.base);\r\nreturn;\r\n}\r\npr_info("clksrc-st-lpc: clocksource initialised - running @ %luHz\n",\r\nclk_get_rate(ddata.clk));\r\n}

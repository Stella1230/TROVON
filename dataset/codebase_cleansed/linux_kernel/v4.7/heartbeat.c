void microblaze_heartbeat(void)\r\n{\r\nstatic unsigned int cnt, period, dist;\r\nif (base_addr) {\r\nif (cnt == 0 || cnt == dist)\r\nout_be32(base_addr, 1);\r\nelse if (cnt == 7 || cnt == dist + 7)\r\nout_be32(base_addr, 0);\r\nif (++cnt > period) {\r\ncnt = 0;\r\nperiod = ((672 << FSHIFT) / (5 * avenrun[0] +\r\n(7 << FSHIFT))) + 30;\r\ndist = period / 4;\r\n}\r\n}\r\n}\r\nvoid microblaze_setup_heartbeat(void)\r\n{\r\nstruct device_node *gpio = NULL;\r\nint *prop;\r\nint j;\r\nconst char * const gpio_list[] = {\r\n"xlnx,xps-gpio-1.00.a",\r\nNULL\r\n};\r\nfor (j = 0; gpio_list[j] != NULL; j++) {\r\ngpio = of_find_compatible_node(NULL, NULL, gpio_list[j]);\r\nif (gpio)\r\nbreak;\r\n}\r\nif (gpio) {\r\nbase_addr = be32_to_cpup(of_get_property(gpio, "reg", NULL));\r\nbase_addr = (unsigned long) ioremap(base_addr, PAGE_SIZE);\r\npr_notice("Heartbeat GPIO at 0x%x\n", base_addr);\r\nprop = (int *) of_get_property(gpio, "xlnx,is-bidir", NULL);\r\nif (prop)\r\nout_be32(base_addr + 4, 0);\r\n}\r\n}

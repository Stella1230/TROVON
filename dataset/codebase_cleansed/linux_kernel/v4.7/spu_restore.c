static inline void fetch_regs_from_mem(addr64 lscsa_ea)\r\n{\r\nunsigned int ls = (unsigned int)&regs_spill[0];\r\nunsigned int size = sizeof(regs_spill);\r\nunsigned int tag_id = 0;\r\nunsigned int cmd = 0x40;\r\nspu_writech(MFC_LSA, ls);\r\nspu_writech(MFC_EAH, lscsa_ea.ui[0]);\r\nspu_writech(MFC_EAL, lscsa_ea.ui[1]);\r\nspu_writech(MFC_Size, size);\r\nspu_writech(MFC_TagID, tag_id);\r\nspu_writech(MFC_Cmd, cmd);\r\n}\r\nstatic inline void restore_upper_240kb(addr64 lscsa_ea)\r\n{\r\nunsigned int ls = 16384;\r\nunsigned int list = (unsigned int)&dma_list[0];\r\nunsigned int size = sizeof(dma_list);\r\nunsigned int tag_id = 0;\r\nunsigned int cmd = 0x44;\r\nspu_writech(MFC_LSA, ls);\r\nspu_writech(MFC_EAH, lscsa_ea.ui[0]);\r\nspu_writech(MFC_EAL, list);\r\nspu_writech(MFC_Size, size);\r\nspu_writech(MFC_TagID, tag_id);\r\nspu_writech(MFC_Cmd, cmd);\r\n}\r\nstatic inline void restore_decr(void)\r\n{\r\nunsigned int offset;\r\nunsigned int decr_running;\r\nunsigned int decr;\r\noffset = LSCSA_QW_OFFSET(decr_status);\r\ndecr_running = regs_spill[offset].slot[0] & SPU_DECR_STATUS_RUNNING;\r\nif (decr_running) {\r\noffset = LSCSA_QW_OFFSET(decr);\r\ndecr = regs_spill[offset].slot[0];\r\nspu_writech(SPU_WrDec, decr);\r\n}\r\n}\r\nstatic inline void write_ppu_mb(void)\r\n{\r\nunsigned int offset;\r\nunsigned int data;\r\noffset = LSCSA_QW_OFFSET(ppu_mb);\r\ndata = regs_spill[offset].slot[0];\r\nspu_writech(SPU_WrOutMbox, data);\r\n}\r\nstatic inline void write_ppuint_mb(void)\r\n{\r\nunsigned int offset;\r\nunsigned int data;\r\noffset = LSCSA_QW_OFFSET(ppuint_mb);\r\ndata = regs_spill[offset].slot[0];\r\nspu_writech(SPU_WrOutIntrMbox, data);\r\n}\r\nstatic inline void restore_fpcr(void)\r\n{\r\nunsigned int offset;\r\nvector unsigned int fpcr;\r\noffset = LSCSA_QW_OFFSET(fpcr);\r\nfpcr = regs_spill[offset].v;\r\nspu_mtfpscr(fpcr);\r\n}\r\nstatic inline void restore_srr0(void)\r\n{\r\nunsigned int offset;\r\nunsigned int srr0;\r\noffset = LSCSA_QW_OFFSET(srr0);\r\nsrr0 = regs_spill[offset].slot[0];\r\nspu_writech(SPU_WrSRR0, srr0);\r\n}\r\nstatic inline void restore_event_mask(void)\r\n{\r\nunsigned int offset;\r\nunsigned int event_mask;\r\noffset = LSCSA_QW_OFFSET(event_mask);\r\nevent_mask = regs_spill[offset].slot[0];\r\nspu_writech(SPU_WrEventMask, event_mask);\r\n}\r\nstatic inline void restore_tag_mask(void)\r\n{\r\nunsigned int offset;\r\nunsigned int tag_mask;\r\noffset = LSCSA_QW_OFFSET(tag_mask);\r\ntag_mask = regs_spill[offset].slot[0];\r\nspu_writech(MFC_WrTagMask, tag_mask);\r\n}\r\nstatic inline void restore_complete(void)\r\n{\r\nextern void exit_fini(void);\r\nunsigned int *exit_instrs = (unsigned int *)exit_fini;\r\nunsigned int offset;\r\nunsigned int stopped_status;\r\nunsigned int stopped_code;\r\noffset = LSCSA_QW_OFFSET(stopped_status);\r\nstopped_status = regs_spill[offset].slot[0];\r\nstopped_code = regs_spill[offset].slot[1];\r\nswitch (stopped_status) {\r\ncase SPU_STOPPED_STATUS_P_I:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = ILLEGAL_INSTR;\r\nexit_instrs[2] = STOP_INSTR | stopped_code;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_P_H:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = HEQ_INSTR;\r\nexit_instrs[2] = STOP_INSTR | stopped_code;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_S_P:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = STOP_INSTR | stopped_code;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_S_I:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = ILLEGAL_INSTR;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_I:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = ILLEGAL_INSTR;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_S:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = NOP_INSTR;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_H:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = HEQ_INSTR;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_P:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = STOP_INSTR | stopped_code;\r\nbreak;\r\ncase SPU_STOPPED_STATUS_R:\r\nexit_instrs[0] = RESTORE_COMPLETE;\r\nexit_instrs[1] = NOP_INSTR;\r\nexit_instrs[2] = NOP_INSTR;\r\nexit_instrs[3] = BR_INSTR;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nspu_sync();\r\n}\r\nint main()\r\n{\r\naddr64 lscsa_ea;\r\nlscsa_ea.ui[0] = spu_readch(SPU_RdSigNotify1);\r\nlscsa_ea.ui[1] = spu_readch(SPU_RdSigNotify2);\r\nfetch_regs_from_mem(lscsa_ea);\r\nset_event_mask();\r\nset_tag_mask();\r\nbuild_dma_list(lscsa_ea);\r\nrestore_upper_240kb(lscsa_ea);\r\nenqueue_putllc(lscsa_ea);\r\nset_tag_update();\r\nread_tag_status();\r\nrestore_decr();\r\nread_llar_status();\r\nwrite_ppu_mb();\r\nwrite_ppuint_mb();\r\nrestore_fpcr();\r\nrestore_srr0();\r\nrestore_event_mask();\r\nrestore_tag_mask();\r\nrestore_complete();\r\nreturn 0;\r\n}

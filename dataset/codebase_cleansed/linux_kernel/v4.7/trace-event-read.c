static int __do_read(int fd, void *buf, int size)\r\n{\r\nint rsize = size;\r\nwhile (size) {\r\nint ret = read(fd, buf, size);\r\nif (ret <= 0)\r\nreturn -1;\r\nif (repipe) {\r\nint retw = write(STDOUT_FILENO, buf, ret);\r\nif (retw <= 0 || retw != ret) {\r\npr_debug("repiping input file");\r\nreturn -1;\r\n}\r\n}\r\nsize -= ret;\r\nbuf += ret;\r\n}\r\nreturn rsize;\r\n}\r\nstatic int do_read(void *data, int size)\r\n{\r\nint r;\r\nr = __do_read(input_fd, data, size);\r\nif (r <= 0) {\r\npr_debug("reading input file (size expected=%d received=%d)",\r\nsize, r);\r\nreturn -1;\r\n}\r\ntrace_data_size += r;\r\nreturn r;\r\n}\r\nstatic void skip(int size)\r\n{\r\nchar buf[BUFSIZ];\r\nint r;\r\nwhile (size) {\r\nr = size > BUFSIZ ? BUFSIZ : size;\r\ndo_read(buf, r);\r\nsize -= r;\r\n};\r\n}\r\nstatic unsigned int read4(struct pevent *pevent)\r\n{\r\nunsigned int data;\r\nif (do_read(&data, 4) < 0)\r\nreturn 0;\r\nreturn __data2host4(pevent, data);\r\n}\r\nstatic unsigned long long read8(struct pevent *pevent)\r\n{\r\nunsigned long long data;\r\nif (do_read(&data, 8) < 0)\r\nreturn 0;\r\nreturn __data2host8(pevent, data);\r\n}\r\nstatic char *read_string(void)\r\n{\r\nchar buf[BUFSIZ];\r\nchar *str = NULL;\r\nint size = 0;\r\noff_t r;\r\nchar c;\r\nfor (;;) {\r\nr = read(input_fd, &c, 1);\r\nif (r < 0) {\r\npr_debug("reading input file");\r\ngoto out;\r\n}\r\nif (!r) {\r\npr_debug("no data");\r\ngoto out;\r\n}\r\nif (repipe) {\r\nint retw = write(STDOUT_FILENO, &c, 1);\r\nif (retw <= 0 || retw != r) {\r\npr_debug("repiping input file string");\r\ngoto out;\r\n}\r\n}\r\nbuf[size++] = c;\r\nif (!c)\r\nbreak;\r\n}\r\ntrace_data_size += size;\r\nstr = malloc(size);\r\nif (str)\r\nmemcpy(str, buf, size);\r\nout:\r\nreturn str;\r\n}\r\nstatic int read_proc_kallsyms(struct pevent *pevent)\r\n{\r\nunsigned int size;\r\nsize = read4(pevent);\r\nif (!size)\r\nreturn 0;\r\nlseek(input_fd, size, SEEK_CUR);\r\ntrace_data_size += size;\r\nreturn 0;\r\n}\r\nstatic int read_ftrace_printk(struct pevent *pevent)\r\n{\r\nunsigned int size;\r\nchar *buf;\r\nsize = read4(pevent);\r\nif (!size)\r\nreturn 0;\r\nbuf = malloc(size);\r\nif (buf == NULL)\r\nreturn -1;\r\nif (do_read(buf, size) < 0) {\r\nfree(buf);\r\nreturn -1;\r\n}\r\nparse_ftrace_printk(pevent, buf, size);\r\nfree(buf);\r\nreturn 0;\r\n}\r\nstatic int read_header_files(struct pevent *pevent)\r\n{\r\nunsigned long long size;\r\nchar *header_page;\r\nchar buf[BUFSIZ];\r\nint ret = 0;\r\nif (do_read(buf, 12) < 0)\r\nreturn -1;\r\nif (memcmp(buf, "header_page", 12) != 0) {\r\npr_debug("did not read header page");\r\nreturn -1;\r\n}\r\nsize = read8(pevent);\r\nheader_page = malloc(size);\r\nif (header_page == NULL)\r\nreturn -1;\r\nif (do_read(header_page, size) < 0) {\r\npr_debug("did not read header page");\r\nfree(header_page);\r\nreturn -1;\r\n}\r\nif (!pevent_parse_header_page(pevent, header_page, size,\r\npevent_get_long_size(pevent))) {\r\npevent_set_long_size(pevent, pevent->header_page_size_size);\r\n}\r\nfree(header_page);\r\nif (do_read(buf, 13) < 0)\r\nreturn -1;\r\nif (memcmp(buf, "header_event", 13) != 0) {\r\npr_debug("did not read header event");\r\nreturn -1;\r\n}\r\nsize = read8(pevent);\r\nskip(size);\r\nreturn ret;\r\n}\r\nstatic int read_ftrace_file(struct pevent *pevent, unsigned long long size)\r\n{\r\nchar *buf;\r\nbuf = malloc(size);\r\nif (buf == NULL)\r\nreturn -1;\r\nif (do_read(buf, size) < 0) {\r\nfree(buf);\r\nreturn -1;\r\n}\r\nparse_ftrace_file(pevent, buf, size);\r\nfree(buf);\r\nreturn 0;\r\n}\r\nstatic int read_event_file(struct pevent *pevent, char *sys,\r\nunsigned long long size)\r\n{\r\nchar *buf;\r\nbuf = malloc(size);\r\nif (buf == NULL)\r\nreturn -1;\r\nif (do_read(buf, size) < 0) {\r\nfree(buf);\r\nreturn -1;\r\n}\r\nparse_event_file(pevent, buf, size, sys);\r\nfree(buf);\r\nreturn 0;\r\n}\r\nstatic int read_ftrace_files(struct pevent *pevent)\r\n{\r\nunsigned long long size;\r\nint count;\r\nint i;\r\nint ret;\r\ncount = read4(pevent);\r\nfor (i = 0; i < count; i++) {\r\nsize = read8(pevent);\r\nret = read_ftrace_file(pevent, size);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int read_event_files(struct pevent *pevent)\r\n{\r\nunsigned long long size;\r\nchar *sys;\r\nint systems;\r\nint count;\r\nint i,x;\r\nint ret;\r\nsystems = read4(pevent);\r\nfor (i = 0; i < systems; i++) {\r\nsys = read_string();\r\nif (sys == NULL)\r\nreturn -1;\r\ncount = read4(pevent);\r\nfor (x=0; x < count; x++) {\r\nsize = read8(pevent);\r\nret = read_event_file(pevent, sys, size);\r\nif (ret)\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nssize_t trace_report(int fd, struct trace_event *tevent, bool __repipe)\r\n{\r\nchar buf[BUFSIZ];\r\nchar test[] = { 23, 8, 68 };\r\nchar *version;\r\nint show_version = 0;\r\nint show_funcs = 0;\r\nint show_printk = 0;\r\nssize_t size = -1;\r\nint file_bigendian;\r\nint host_bigendian;\r\nint file_long_size;\r\nint file_page_size;\r\nstruct pevent *pevent = NULL;\r\nint err;\r\nrepipe = __repipe;\r\ninput_fd = fd;\r\nif (do_read(buf, 3) < 0)\r\nreturn -1;\r\nif (memcmp(buf, test, 3) != 0) {\r\npr_debug("no trace data in the file");\r\nreturn -1;\r\n}\r\nif (do_read(buf, 7) < 0)\r\nreturn -1;\r\nif (memcmp(buf, "tracing", 7) != 0) {\r\npr_debug("not a trace file (missing 'tracing' tag)");\r\nreturn -1;\r\n}\r\nversion = read_string();\r\nif (version == NULL)\r\nreturn -1;\r\nif (show_version)\r\nprintf("version = %s\n", version);\r\nfree(version);\r\nif (do_read(buf, 1) < 0)\r\nreturn -1;\r\nfile_bigendian = buf[0];\r\nhost_bigendian = bigendian();\r\nif (trace_event__init(tevent)) {\r\npr_debug("trace_event__init failed");\r\ngoto out;\r\n}\r\npevent = tevent->pevent;\r\npevent_set_flag(pevent, PEVENT_NSEC_OUTPUT);\r\npevent_set_file_bigendian(pevent, file_bigendian);\r\npevent_set_host_bigendian(pevent, host_bigendian);\r\nif (do_read(buf, 1) < 0)\r\ngoto out;\r\nfile_long_size = buf[0];\r\nfile_page_size = read4(pevent);\r\nif (!file_page_size)\r\ngoto out;\r\npevent_set_long_size(pevent, file_long_size);\r\npevent_set_page_size(pevent, file_page_size);\r\nerr = read_header_files(pevent);\r\nif (err)\r\ngoto out;\r\nerr = read_ftrace_files(pevent);\r\nif (err)\r\ngoto out;\r\nerr = read_event_files(pevent);\r\nif (err)\r\ngoto out;\r\nerr = read_proc_kallsyms(pevent);\r\nif (err)\r\ngoto out;\r\nerr = read_ftrace_printk(pevent);\r\nif (err)\r\ngoto out;\r\nsize = trace_data_size;\r\nrepipe = false;\r\nif (show_funcs) {\r\npevent_print_funcs(pevent);\r\n} else if (show_printk) {\r\npevent_print_printk(pevent);\r\n}\r\npevent = NULL;\r\nout:\r\nif (pevent)\r\ntrace_event__cleanup(tevent);\r\nreturn size;\r\n}

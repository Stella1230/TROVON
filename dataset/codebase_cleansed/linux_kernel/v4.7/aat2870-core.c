static int __aat2870_read(struct aat2870_data *aat2870, u8 addr, u8 *val)\r\n{\r\nint ret;\r\nif (addr >= AAT2870_REG_NUM) {\r\ndev_err(aat2870->dev, "Invalid address, 0x%02x\n", addr);\r\nreturn -EINVAL;\r\n}\r\nif (!aat2870->reg_cache[addr].readable) {\r\n*val = aat2870->reg_cache[addr].value;\r\ngoto out;\r\n}\r\nret = i2c_master_send(aat2870->client, &addr, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != 1)\r\nreturn -EIO;\r\nret = i2c_master_recv(aat2870->client, val, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != 1)\r\nreturn -EIO;\r\nout:\r\ndev_dbg(aat2870->dev, "read: addr=0x%02x, val=0x%02x\n", addr, *val);\r\nreturn 0;\r\n}\r\nstatic int __aat2870_write(struct aat2870_data *aat2870, u8 addr, u8 val)\r\n{\r\nu8 msg[2];\r\nint ret;\r\nif (addr >= AAT2870_REG_NUM) {\r\ndev_err(aat2870->dev, "Invalid address, 0x%02x\n", addr);\r\nreturn -EINVAL;\r\n}\r\nif (!aat2870->reg_cache[addr].writeable) {\r\ndev_err(aat2870->dev, "Address 0x%02x is not writeable\n",\r\naddr);\r\nreturn -EINVAL;\r\n}\r\nmsg[0] = addr;\r\nmsg[1] = val;\r\nret = i2c_master_send(aat2870->client, msg, 2);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != 2)\r\nreturn -EIO;\r\naat2870->reg_cache[addr].value = val;\r\ndev_dbg(aat2870->dev, "write: addr=0x%02x, val=0x%02x\n", addr, val);\r\nreturn 0;\r\n}\r\nstatic int aat2870_read(struct aat2870_data *aat2870, u8 addr, u8 *val)\r\n{\r\nint ret;\r\nmutex_lock(&aat2870->io_lock);\r\nret = __aat2870_read(aat2870, addr, val);\r\nmutex_unlock(&aat2870->io_lock);\r\nreturn ret;\r\n}\r\nstatic int aat2870_write(struct aat2870_data *aat2870, u8 addr, u8 val)\r\n{\r\nint ret;\r\nmutex_lock(&aat2870->io_lock);\r\nret = __aat2870_write(aat2870, addr, val);\r\nmutex_unlock(&aat2870->io_lock);\r\nreturn ret;\r\n}\r\nstatic int aat2870_update(struct aat2870_data *aat2870, u8 addr, u8 mask,\r\nu8 val)\r\n{\r\nint change;\r\nu8 old_val, new_val;\r\nint ret;\r\nmutex_lock(&aat2870->io_lock);\r\nret = __aat2870_read(aat2870, addr, &old_val);\r\nif (ret)\r\ngoto out_unlock;\r\nnew_val = (old_val & ~mask) | (val & mask);\r\nchange = old_val != new_val;\r\nif (change)\r\nret = __aat2870_write(aat2870, addr, new_val);\r\nout_unlock:\r\nmutex_unlock(&aat2870->io_lock);\r\nreturn ret;\r\n}\r\nstatic inline void aat2870_enable(struct aat2870_data *aat2870)\r\n{\r\nif (aat2870->en_pin >= 0)\r\ngpio_set_value(aat2870->en_pin, 1);\r\naat2870->is_enable = 1;\r\n}\r\nstatic inline void aat2870_disable(struct aat2870_data *aat2870)\r\n{\r\nif (aat2870->en_pin >= 0)\r\ngpio_set_value(aat2870->en_pin, 0);\r\naat2870->is_enable = 0;\r\n}\r\nstatic ssize_t aat2870_dump_reg(struct aat2870_data *aat2870, char *buf)\r\n{\r\nu8 addr, val;\r\nssize_t count = 0;\r\nint ret;\r\ncount += sprintf(buf, "aat2870 registers\n");\r\nfor (addr = 0; addr < AAT2870_REG_NUM; addr++) {\r\ncount += sprintf(buf + count, "0x%02x: ", addr);\r\nif (count >= PAGE_SIZE - 1)\r\nbreak;\r\nret = aat2870->read(aat2870, addr, &val);\r\nif (ret == 0)\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"0x%02x", val);\r\nelse\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"<read fail: %d>", ret);\r\nif (count >= PAGE_SIZE - 1)\r\nbreak;\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "\n");\r\nif (count >= PAGE_SIZE - 1)\r\nbreak;\r\n}\r\nif (count >= PAGE_SIZE)\r\ncount = PAGE_SIZE - 1;\r\nreturn count;\r\n}\r\nstatic ssize_t aat2870_reg_read_file(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct aat2870_data *aat2870 = file->private_data;\r\nchar *buf;\r\nssize_t ret;\r\nbuf = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nret = aat2870_dump_reg(aat2870, buf);\r\nif (ret >= 0)\r\nret = simple_read_from_buffer(user_buf, count, ppos, buf, ret);\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic ssize_t aat2870_reg_write_file(struct file *file,\r\nconst char __user *user_buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nstruct aat2870_data *aat2870 = file->private_data;\r\nchar buf[32];\r\nssize_t buf_size;\r\nchar *start = buf;\r\nunsigned long addr, val;\r\nint ret;\r\nbuf_size = min(count, (size_t)(sizeof(buf)-1));\r\nif (copy_from_user(buf, user_buf, buf_size)) {\r\ndev_err(aat2870->dev, "Failed to copy from user\n");\r\nreturn -EFAULT;\r\n}\r\nbuf[buf_size] = 0;\r\nwhile (*start == ' ')\r\nstart++;\r\nret = kstrtoul(start, 16, &addr);\r\nif (ret)\r\nreturn ret;\r\nif (addr >= AAT2870_REG_NUM) {\r\ndev_err(aat2870->dev, "Invalid address, 0x%lx\n", addr);\r\nreturn -EINVAL;\r\n}\r\nwhile (*start == ' ')\r\nstart++;\r\nret = kstrtoul(start, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nret = aat2870->write(aat2870, (u8)addr, (u8)val);\r\nif (ret)\r\nreturn ret;\r\nreturn buf_size;\r\n}\r\nstatic void aat2870_init_debugfs(struct aat2870_data *aat2870)\r\n{\r\naat2870->dentry_root = debugfs_create_dir("aat2870", NULL);\r\nif (!aat2870->dentry_root) {\r\ndev_warn(aat2870->dev,\r\n"Failed to create debugfs root directory\n");\r\nreturn;\r\n}\r\naat2870->dentry_reg = debugfs_create_file("regs", 0644,\r\naat2870->dentry_root,\r\naat2870, &aat2870_reg_fops);\r\nif (!aat2870->dentry_reg)\r\ndev_warn(aat2870->dev,\r\n"Failed to create debugfs register file\n");\r\n}\r\nstatic void aat2870_uninit_debugfs(struct aat2870_data *aat2870)\r\n{\r\ndebugfs_remove_recursive(aat2870->dentry_root);\r\n}\r\nstatic inline void aat2870_init_debugfs(struct aat2870_data *aat2870)\r\n{\r\n}\r\nstatic inline void aat2870_uninit_debugfs(struct aat2870_data *aat2870)\r\n{\r\n}\r\nstatic int aat2870_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct aat2870_platform_data *pdata = dev_get_platdata(&client->dev);\r\nstruct aat2870_data *aat2870;\r\nint i, j;\r\nint ret = 0;\r\naat2870 = devm_kzalloc(&client->dev, sizeof(struct aat2870_data),\r\nGFP_KERNEL);\r\nif (!aat2870)\r\nreturn -ENOMEM;\r\naat2870->dev = &client->dev;\r\ndev_set_drvdata(aat2870->dev, aat2870);\r\naat2870->client = client;\r\ni2c_set_clientdata(client, aat2870);\r\naat2870->reg_cache = aat2870_regs;\r\nif (pdata->en_pin < 0)\r\naat2870->en_pin = -1;\r\nelse\r\naat2870->en_pin = pdata->en_pin;\r\naat2870->init = pdata->init;\r\naat2870->uninit = pdata->uninit;\r\naat2870->read = aat2870_read;\r\naat2870->write = aat2870_write;\r\naat2870->update = aat2870_update;\r\nmutex_init(&aat2870->io_lock);\r\nif (aat2870->init)\r\naat2870->init(aat2870);\r\nif (aat2870->en_pin >= 0) {\r\nret = devm_gpio_request_one(&client->dev, aat2870->en_pin,\r\nGPIOF_OUT_INIT_HIGH, "aat2870-en");\r\nif (ret < 0) {\r\ndev_err(&client->dev,\r\n"Failed to request GPIO %d\n", aat2870->en_pin);\r\nreturn ret;\r\n}\r\n}\r\naat2870_enable(aat2870);\r\nfor (i = 0; i < pdata->num_subdevs; i++) {\r\nfor (j = 0; j < ARRAY_SIZE(aat2870_devs); j++) {\r\nif ((pdata->subdevs[i].id == aat2870_devs[j].id) &&\r\n!strcmp(pdata->subdevs[i].name,\r\naat2870_devs[j].name)) {\r\naat2870_devs[j].platform_data =\r\npdata->subdevs[i].platform_data;\r\nbreak;\r\n}\r\n}\r\n}\r\nret = mfd_add_devices(aat2870->dev, 0, aat2870_devs,\r\nARRAY_SIZE(aat2870_devs), NULL, 0, NULL);\r\nif (ret != 0) {\r\ndev_err(aat2870->dev, "Failed to add subdev: %d\n", ret);\r\ngoto out_disable;\r\n}\r\naat2870_init_debugfs(aat2870);\r\nreturn 0;\r\nout_disable:\r\naat2870_disable(aat2870);\r\nreturn ret;\r\n}\r\nstatic int aat2870_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct aat2870_data *aat2870 = i2c_get_clientdata(client);\r\naat2870_uninit_debugfs(aat2870);\r\nmfd_remove_devices(aat2870->dev);\r\naat2870_disable(aat2870);\r\nif (aat2870->uninit)\r\naat2870->uninit(aat2870);\r\nreturn 0;\r\n}\r\nstatic int aat2870_i2c_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct aat2870_data *aat2870 = i2c_get_clientdata(client);\r\naat2870_disable(aat2870);\r\nreturn 0;\r\n}\r\nstatic int aat2870_i2c_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct aat2870_data *aat2870 = i2c_get_clientdata(client);\r\nstruct aat2870_register *reg = NULL;\r\nint i;\r\naat2870_enable(aat2870);\r\nfor (i = 0; i < AAT2870_REG_NUM; i++) {\r\nreg = &aat2870->reg_cache[i];\r\nif (reg->writeable)\r\naat2870->write(aat2870, i, reg->value);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init aat2870_init(void)\r\n{\r\nreturn i2c_add_driver(&aat2870_i2c_driver);\r\n}\r\nstatic void __exit aat2870_exit(void)\r\n{\r\ni2c_del_driver(&aat2870_i2c_driver);\r\n}

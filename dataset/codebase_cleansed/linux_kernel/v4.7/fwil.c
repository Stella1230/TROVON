static const char *brcmf_fil_get_errstr(u32 err)\r\n{\r\nif (err >= ARRAY_SIZE(brcmf_fil_errstr))\r\nreturn "(unknown)";\r\nreturn brcmf_fil_errstr[err];\r\n}\r\nstatic const char *brcmf_fil_get_errstr(u32 err)\r\n{\r\nreturn "";\r\n}\r\nstatic s32\r\nbrcmf_fil_cmd_data(struct brcmf_if *ifp, u32 cmd, void *data, u32 len, bool set)\r\n{\r\nstruct brcmf_pub *drvr = ifp->drvr;\r\ns32 err;\r\nif (drvr->bus_if->state != BRCMF_BUS_UP) {\r\nbrcmf_err("bus is down. we have nothing to do.\n");\r\nreturn -EIO;\r\n}\r\nif (data != NULL)\r\nlen = min_t(uint, len, BRCMF_DCMD_MAXLEN);\r\nif (set)\r\nerr = brcmf_proto_set_dcmd(drvr, ifp->ifidx, cmd, data, len);\r\nelse\r\nerr = brcmf_proto_query_dcmd(drvr, ifp->ifidx, cmd, data, len);\r\nif (err >= 0)\r\nreturn 0;\r\nbrcmf_dbg(FIL, "Failed: %s (%d)\n",\r\nbrcmf_fil_get_errstr((u32)(-err)), err);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_cmd_data_set(struct brcmf_if *ifp, u32 cmd, void *data, u32 len)\r\n{\r\ns32 err;\r\nmutex_lock(&ifp->drvr->proto_block);\r\nbrcmf_dbg(FIL, "ifidx=%d, cmd=%d, len=%d\n", ifp->ifidx, cmd, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nerr = brcmf_fil_cmd_data(ifp, cmd, data, len, true);\r\nmutex_unlock(&ifp->drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_cmd_data_get(struct brcmf_if *ifp, u32 cmd, void *data, u32 len)\r\n{\r\ns32 err;\r\nmutex_lock(&ifp->drvr->proto_block);\r\nerr = brcmf_fil_cmd_data(ifp, cmd, data, len, false);\r\nbrcmf_dbg(FIL, "ifidx=%d, cmd=%d, len=%d\n", ifp->ifidx, cmd, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nmutex_unlock(&ifp->drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_cmd_int_set(struct brcmf_if *ifp, u32 cmd, u32 data)\r\n{\r\ns32 err;\r\n__le32 data_le = cpu_to_le32(data);\r\nmutex_lock(&ifp->drvr->proto_block);\r\nbrcmf_dbg(FIL, "ifidx=%d, cmd=%d, value=%d\n", ifp->ifidx, cmd, data);\r\nerr = brcmf_fil_cmd_data(ifp, cmd, &data_le, sizeof(data_le), true);\r\nmutex_unlock(&ifp->drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_cmd_int_get(struct brcmf_if *ifp, u32 cmd, u32 *data)\r\n{\r\ns32 err;\r\n__le32 data_le = cpu_to_le32(*data);\r\nmutex_lock(&ifp->drvr->proto_block);\r\nerr = brcmf_fil_cmd_data(ifp, cmd, &data_le, sizeof(data_le), false);\r\nmutex_unlock(&ifp->drvr->proto_block);\r\n*data = le32_to_cpu(data_le);\r\nbrcmf_dbg(FIL, "ifidx=%d, cmd=%d, value=%d\n", ifp->ifidx, cmd, *data);\r\nreturn err;\r\n}\r\nstatic u32\r\nbrcmf_create_iovar(char *name, const char *data, u32 datalen,\r\nchar *buf, u32 buflen)\r\n{\r\nu32 len;\r\nlen = strlen(name) + 1;\r\nif ((len + datalen) > buflen)\r\nreturn 0;\r\nmemcpy(buf, name, len);\r\nif (data && datalen)\r\nmemcpy(&buf[len], data, datalen);\r\nreturn len + datalen;\r\n}\r\ns32\r\nbrcmf_fil_iovar_data_set(struct brcmf_if *ifp, char *name, const void *data,\r\nu32 len)\r\n{\r\nstruct brcmf_pub *drvr = ifp->drvr;\r\ns32 err;\r\nu32 buflen;\r\nmutex_lock(&drvr->proto_block);\r\nbrcmf_dbg(FIL, "ifidx=%d, name=%s, len=%d\n", ifp->ifidx, name, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nbuflen = brcmf_create_iovar(name, data, len, drvr->proto_buf,\r\nsizeof(drvr->proto_buf));\r\nif (buflen) {\r\nerr = brcmf_fil_cmd_data(ifp, BRCMF_C_SET_VAR, drvr->proto_buf,\r\nbuflen, true);\r\n} else {\r\nerr = -EPERM;\r\nbrcmf_err("Creating iovar failed\n");\r\n}\r\nmutex_unlock(&drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_iovar_data_get(struct brcmf_if *ifp, char *name, void *data,\r\nu32 len)\r\n{\r\nstruct brcmf_pub *drvr = ifp->drvr;\r\ns32 err;\r\nu32 buflen;\r\nmutex_lock(&drvr->proto_block);\r\nbuflen = brcmf_create_iovar(name, data, len, drvr->proto_buf,\r\nsizeof(drvr->proto_buf));\r\nif (buflen) {\r\nerr = brcmf_fil_cmd_data(ifp, BRCMF_C_GET_VAR, drvr->proto_buf,\r\nbuflen, false);\r\nif (err == 0)\r\nmemcpy(data, drvr->proto_buf, len);\r\n} else {\r\nerr = -EPERM;\r\nbrcmf_err("Creating iovar failed\n");\r\n}\r\nbrcmf_dbg(FIL, "ifidx=%d, name=%s, len=%d\n", ifp->ifidx, name, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nmutex_unlock(&drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_iovar_int_set(struct brcmf_if *ifp, char *name, u32 data)\r\n{\r\n__le32 data_le = cpu_to_le32(data);\r\nreturn brcmf_fil_iovar_data_set(ifp, name, &data_le, sizeof(data_le));\r\n}\r\ns32\r\nbrcmf_fil_iovar_int_get(struct brcmf_if *ifp, char *name, u32 *data)\r\n{\r\n__le32 data_le = cpu_to_le32(*data);\r\ns32 err;\r\nerr = brcmf_fil_iovar_data_get(ifp, name, &data_le, sizeof(data_le));\r\nif (err == 0)\r\n*data = le32_to_cpu(data_le);\r\nreturn err;\r\n}\r\nstatic u32\r\nbrcmf_create_bsscfg(s32 bsscfgidx, char *name, char *data, u32 datalen,\r\nchar *buf, u32 buflen)\r\n{\r\nconst s8 *prefix = "bsscfg:";\r\ns8 *p;\r\nu32 prefixlen;\r\nu32 namelen;\r\nu32 iolen;\r\n__le32 bsscfgidx_le;\r\nif (bsscfgidx == 0)\r\nreturn brcmf_create_iovar(name, data, datalen, buf, buflen);\r\nprefixlen = strlen(prefix);\r\nnamelen = strlen(name) + 1;\r\niolen = prefixlen + namelen + sizeof(bsscfgidx_le) + datalen;\r\nif (buflen < iolen) {\r\nbrcmf_err("buffer is too short\n");\r\nreturn 0;\r\n}\r\np = buf;\r\nmemcpy(p, prefix, prefixlen);\r\np += prefixlen;\r\nmemcpy(p, name, namelen);\r\np += namelen;\r\nbsscfgidx_le = cpu_to_le32(bsscfgidx);\r\nmemcpy(p, &bsscfgidx_le, sizeof(bsscfgidx_le));\r\np += sizeof(bsscfgidx_le);\r\nif (datalen)\r\nmemcpy(p, data, datalen);\r\nreturn iolen;\r\n}\r\ns32\r\nbrcmf_fil_bsscfg_data_set(struct brcmf_if *ifp, char *name,\r\nvoid *data, u32 len)\r\n{\r\nstruct brcmf_pub *drvr = ifp->drvr;\r\ns32 err;\r\nu32 buflen;\r\nmutex_lock(&drvr->proto_block);\r\nbrcmf_dbg(FIL, "ifidx=%d, bsscfgidx=%d, name=%s, len=%d\n", ifp->ifidx,\r\nifp->bsscfgidx, name, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nbuflen = brcmf_create_bsscfg(ifp->bsscfgidx, name, data, len,\r\ndrvr->proto_buf, sizeof(drvr->proto_buf));\r\nif (buflen) {\r\nerr = brcmf_fil_cmd_data(ifp, BRCMF_C_SET_VAR, drvr->proto_buf,\r\nbuflen, true);\r\n} else {\r\nerr = -EPERM;\r\nbrcmf_err("Creating bsscfg failed\n");\r\n}\r\nmutex_unlock(&drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_bsscfg_data_get(struct brcmf_if *ifp, char *name,\r\nvoid *data, u32 len)\r\n{\r\nstruct brcmf_pub *drvr = ifp->drvr;\r\ns32 err;\r\nu32 buflen;\r\nmutex_lock(&drvr->proto_block);\r\nbuflen = brcmf_create_bsscfg(ifp->bsscfgidx, name, data, len,\r\ndrvr->proto_buf, sizeof(drvr->proto_buf));\r\nif (buflen) {\r\nerr = brcmf_fil_cmd_data(ifp, BRCMF_C_GET_VAR, drvr->proto_buf,\r\nbuflen, false);\r\nif (err == 0)\r\nmemcpy(data, drvr->proto_buf, len);\r\n} else {\r\nerr = -EPERM;\r\nbrcmf_err("Creating bsscfg failed\n");\r\n}\r\nbrcmf_dbg(FIL, "ifidx=%d, bsscfgidx=%d, name=%s, len=%d\n", ifp->ifidx,\r\nifp->bsscfgidx, name, len);\r\nbrcmf_dbg_hex_dump(BRCMF_FIL_ON(), data,\r\nmin_t(uint, len, MAX_HEX_DUMP_LEN), "data\n");\r\nmutex_unlock(&drvr->proto_block);\r\nreturn err;\r\n}\r\ns32\r\nbrcmf_fil_bsscfg_int_set(struct brcmf_if *ifp, char *name, u32 data)\r\n{\r\n__le32 data_le = cpu_to_le32(data);\r\nreturn brcmf_fil_bsscfg_data_set(ifp, name, &data_le,\r\nsizeof(data_le));\r\n}\r\ns32\r\nbrcmf_fil_bsscfg_int_get(struct brcmf_if *ifp, char *name, u32 *data)\r\n{\r\n__le32 data_le = cpu_to_le32(*data);\r\ns32 err;\r\nerr = brcmf_fil_bsscfg_data_get(ifp, name, &data_le,\r\nsizeof(data_le));\r\nif (err == 0)\r\n*data = le32_to_cpu(data_le);\r\nreturn err;\r\n}

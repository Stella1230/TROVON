void poly_sine(FPU_REG *st0_ptr)\r\n{\r\nint exponent, echange;\r\nXsig accumulator, argSqrd, argTo4;\r\nunsigned long fix_up, adj;\r\nunsigned long long fixed_arg;\r\nFPU_REG result;\r\nexponent = exponent(st0_ptr);\r\naccumulator.lsw = accumulator.midw = accumulator.msw = 0;\r\nif ((exponent < -1)\r\n|| ((exponent == -1) && (st0_ptr->sigh <= 0xe21240aa))) {\r\nargSqrd.msw = st0_ptr->sigh;\r\nargSqrd.midw = st0_ptr->sigl;\r\nargSqrd.lsw = 0;\r\nmul64_Xsig(&argSqrd, &significand(st0_ptr));\r\nshr_Xsig(&argSqrd, 2 * (-1 - exponent));\r\nargTo4.msw = argSqrd.msw;\r\nargTo4.midw = argSqrd.midw;\r\nargTo4.lsw = argSqrd.lsw;\r\nmul_Xsig_Xsig(&argTo4, &argTo4);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), neg_terms_l,\r\nN_COEFF_N - 1);\r\nmul_Xsig_Xsig(&accumulator, &argSqrd);\r\nnegate_Xsig(&accumulator);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), pos_terms_l,\r\nN_COEFF_P - 1);\r\nshr_Xsig(&accumulator, 2);\r\naccumulator.msw |= 0x80000000;\r\nmul64_Xsig(&accumulator, &significand(st0_ptr));\r\nmul64_Xsig(&accumulator, &significand(st0_ptr));\r\nmul64_Xsig(&accumulator, &significand(st0_ptr));\r\nexponent = 3 * exponent;\r\nshr_Xsig(&accumulator, exponent(st0_ptr) - exponent);\r\nnegate_Xsig(&accumulator);\r\nXSIG_LL(accumulator) += significand(st0_ptr);\r\nechange = round_Xsig(&accumulator);\r\nsetexponentpos(&result, exponent(st0_ptr) + echange);\r\n} else {\r\nfixed_arg = significand(st0_ptr);\r\nif (exponent == 0) {\r\nfixed_arg <<= 1;\r\n}\r\nfixed_arg = 0x921fb54442d18469LL - fixed_arg;\r\nif (fixed_arg == 0xffffffffffffffffLL)\r\nfixed_arg = 0;\r\nXSIG_LL(argSqrd) = fixed_arg;\r\nargSqrd.lsw = 0;\r\nmul64_Xsig(&argSqrd, &fixed_arg);\r\nXSIG_LL(argTo4) = XSIG_LL(argSqrd);\r\nargTo4.lsw = argSqrd.lsw;\r\nmul_Xsig_Xsig(&argTo4, &argTo4);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), neg_terms_h,\r\nN_COEFF_NH - 1);\r\nmul_Xsig_Xsig(&accumulator, &argSqrd);\r\nnegate_Xsig(&accumulator);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), pos_terms_h,\r\nN_COEFF_PH - 1);\r\nnegate_Xsig(&accumulator);\r\nmul64_Xsig(&accumulator, &fixed_arg);\r\nmul64_Xsig(&accumulator, &fixed_arg);\r\nshr_Xsig(&accumulator, 3);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &argSqrd);\r\nshr_Xsig(&accumulator, 1);\r\naccumulator.lsw |= 1;\r\nnegate_Xsig(&accumulator);\r\nfix_up = 0x898cc517;\r\nif (argSqrd.msw & 0xffc00000) {\r\nfix_up -= mul_32_32(0x898cc517, argSqrd.msw) / 6;\r\n}\r\nfix_up = mul_32_32(fix_up, LL_MSW(fixed_arg));\r\nadj = accumulator.lsw;\r\naccumulator.lsw -= fix_up;\r\nif (accumulator.lsw > adj)\r\nXSIG_LL(accumulator)--;\r\nechange = round_Xsig(&accumulator);\r\nsetexponentpos(&result, echange - 1);\r\n}\r\nsignificand(&result) = XSIG_LL(accumulator);\r\nsetsign(&result, getsign(st0_ptr));\r\nFPU_copy_to_reg0(&result, TAG_Valid);\r\n#ifdef PARANOID\r\nif ((exponent(&result) >= 0)\r\n&& (significand(&result) > 0x8000000000000000LL)) {\r\nEXCEPTION(EX_INTERNAL | 0x150);\r\n}\r\n#endif\r\n}\r\nvoid poly_cos(FPU_REG *st0_ptr)\r\n{\r\nFPU_REG result;\r\nlong int exponent, exp2, echange;\r\nXsig accumulator, argSqrd, fix_up, argTo4;\r\nunsigned long long fixed_arg;\r\n#ifdef PARANOID\r\nif ((exponent(st0_ptr) > 0)\r\n|| ((exponent(st0_ptr) == 0)\r\n&& (significand(st0_ptr) > 0xc90fdaa22168c234LL))) {\r\nEXCEPTION(EX_Invalid);\r\nFPU_copy_to_reg0(&CONST_QNaN, TAG_Special);\r\nreturn;\r\n}\r\n#endif\r\nexponent = exponent(st0_ptr);\r\naccumulator.lsw = accumulator.midw = accumulator.msw = 0;\r\nif ((exponent < -1)\r\n|| ((exponent == -1) && (st0_ptr->sigh <= 0xb00d6f54))) {\r\nargSqrd.msw = st0_ptr->sigh;\r\nargSqrd.midw = st0_ptr->sigl;\r\nargSqrd.lsw = 0;\r\nmul64_Xsig(&argSqrd, &significand(st0_ptr));\r\nif (exponent < -1) {\r\nshr_Xsig(&argSqrd, 2 * (-1 - exponent));\r\n}\r\nargTo4.msw = argSqrd.msw;\r\nargTo4.midw = argSqrd.midw;\r\nargTo4.lsw = argSqrd.lsw;\r\nmul_Xsig_Xsig(&argTo4, &argTo4);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), neg_terms_h,\r\nN_COEFF_NH - 1);\r\nmul_Xsig_Xsig(&accumulator, &argSqrd);\r\nnegate_Xsig(&accumulator);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), pos_terms_h,\r\nN_COEFF_PH - 1);\r\nnegate_Xsig(&accumulator);\r\nmul64_Xsig(&accumulator, &significand(st0_ptr));\r\nmul64_Xsig(&accumulator, &significand(st0_ptr));\r\nshr_Xsig(&accumulator, -2 * (1 + exponent));\r\nshr_Xsig(&accumulator, 3);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &argSqrd);\r\nshr_Xsig(&accumulator, 1);\r\nnegate_Xsig(&accumulator);\r\nif (accumulator.lsw & 0x80000000)\r\nXSIG_LL(accumulator)++;\r\nif (accumulator.msw == 0) {\r\nFPU_copy_to_reg0(&CONST_1, TAG_Valid);\r\nreturn;\r\n} else {\r\nsignificand(&result) = XSIG_LL(accumulator);\r\nsetexponentpos(&result, -1);\r\n}\r\n} else {\r\nfixed_arg = significand(st0_ptr);\r\nif (exponent == 0) {\r\nfixed_arg <<= 1;\r\n}\r\nfixed_arg = 0x921fb54442d18469LL - fixed_arg;\r\nif (fixed_arg == 0xffffffffffffffffLL)\r\nfixed_arg = 0;\r\nexponent = -1;\r\nexp2 = -1;\r\nif (!(LL_MSW(fixed_arg) & 0xffff0000)) {\r\nfixed_arg <<= 16;\r\nexponent -= 16;\r\nexp2 -= 16;\r\n}\r\nXSIG_LL(argSqrd) = fixed_arg;\r\nargSqrd.lsw = 0;\r\nmul64_Xsig(&argSqrd, &fixed_arg);\r\nif (exponent < -1) {\r\nshr_Xsig(&argSqrd, 2 * (-1 - exponent));\r\n}\r\nargTo4.msw = argSqrd.msw;\r\nargTo4.midw = argSqrd.midw;\r\nargTo4.lsw = argSqrd.lsw;\r\nmul_Xsig_Xsig(&argTo4, &argTo4);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), neg_terms_l,\r\nN_COEFF_N - 1);\r\nmul_Xsig_Xsig(&accumulator, &argSqrd);\r\nnegate_Xsig(&accumulator);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argTo4), pos_terms_l,\r\nN_COEFF_P - 1);\r\nshr_Xsig(&accumulator, 2);\r\naccumulator.msw |= 0x80000000;\r\nmul64_Xsig(&accumulator, &fixed_arg);\r\nmul64_Xsig(&accumulator, &fixed_arg);\r\nmul64_Xsig(&accumulator, &fixed_arg);\r\nexponent = 3 * exponent;\r\nshr_Xsig(&accumulator, exp2 - exponent);\r\nnegate_Xsig(&accumulator);\r\nXSIG_LL(accumulator) += fixed_arg;\r\nXSIG_LL(fix_up) = 0x898cc51701b839a2ll;\r\nfix_up.lsw = 0;\r\nif (argSqrd.msw & 0xffc00000) {\r\nfix_up.msw -= mul_32_32(0x898cc517, argSqrd.msw) / 2;\r\nfix_up.msw += mul_32_32(0x898cc517, argTo4.msw) / 24;\r\n}\r\nexp2 += norm_Xsig(&accumulator);\r\nshr_Xsig(&accumulator, 1);\r\nexp2++;\r\nshr_Xsig(&fix_up, 65 + exp2);\r\nadd_Xsig_Xsig(&accumulator, &fix_up);\r\nechange = round_Xsig(&accumulator);\r\nsetexponentpos(&result, exp2 + echange);\r\nsignificand(&result) = XSIG_LL(accumulator);\r\n}\r\nFPU_copy_to_reg0(&result, TAG_Valid);\r\n#ifdef PARANOID\r\nif ((exponent(&result) >= 0)\r\n&& (significand(&result) > 0x8000000000000000LL)) {\r\nEXCEPTION(EX_INTERNAL | 0x151);\r\n}\r\n#endif\r\n}

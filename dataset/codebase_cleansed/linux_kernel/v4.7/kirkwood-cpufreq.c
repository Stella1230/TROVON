static unsigned int kirkwood_cpufreq_get_cpu_frequency(unsigned int cpu)\r\n{\r\nreturn clk_get_rate(priv.powersave_clk) / 1000;\r\n}\r\nstatic int kirkwood_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nunsigned int state = kirkwood_freq_table[index].driver_data;\r\nunsigned long reg;\r\nlocal_irq_disable();\r\nreg = readl_relaxed(priv.base);\r\nreg |= CPU_SW_INT_BLK;\r\nwritel_relaxed(reg, priv.base);\r\nswitch (state) {\r\ncase STATE_CPU_FREQ:\r\nclk_set_parent(priv.powersave_clk, priv.cpu_clk);\r\nbreak;\r\ncase STATE_DDR_FREQ:\r\nclk_set_parent(priv.powersave_clk, priv.ddr_clk);\r\nbreak;\r\n}\r\ncpu_do_idle();\r\nreg = readl_relaxed(priv.base);\r\nreg &= ~CPU_SW_INT_BLK;\r\nwritel_relaxed(reg, priv.base);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int kirkwood_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, kirkwood_freq_table, 5000);\r\n}\r\nstatic int kirkwood_cpufreq_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np;\r\nstruct resource *res;\r\nint err;\r\npriv.dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv.base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv.base))\r\nreturn PTR_ERR(priv.base);\r\nnp = of_cpu_device_node_get(0);\r\nif (!np) {\r\ndev_err(&pdev->dev, "failed to get cpu device node\n");\r\nreturn -ENODEV;\r\n}\r\npriv.cpu_clk = of_clk_get_by_name(np, "cpu_clk");\r\nif (IS_ERR(priv.cpu_clk)) {\r\ndev_err(priv.dev, "Unable to get cpuclk");\r\nreturn PTR_ERR(priv.cpu_clk);\r\n}\r\nclk_prepare_enable(priv.cpu_clk);\r\nkirkwood_freq_table[0].frequency = clk_get_rate(priv.cpu_clk) / 1000;\r\npriv.ddr_clk = of_clk_get_by_name(np, "ddrclk");\r\nif (IS_ERR(priv.ddr_clk)) {\r\ndev_err(priv.dev, "Unable to get ddrclk");\r\nerr = PTR_ERR(priv.ddr_clk);\r\ngoto out_cpu;\r\n}\r\nclk_prepare_enable(priv.ddr_clk);\r\nkirkwood_freq_table[1].frequency = clk_get_rate(priv.ddr_clk) / 1000;\r\npriv.powersave_clk = of_clk_get_by_name(np, "powersave");\r\nif (IS_ERR(priv.powersave_clk)) {\r\ndev_err(priv.dev, "Unable to get powersave");\r\nerr = PTR_ERR(priv.powersave_clk);\r\ngoto out_ddr;\r\n}\r\nclk_prepare_enable(priv.powersave_clk);\r\nof_node_put(np);\r\nnp = NULL;\r\nerr = cpufreq_register_driver(&kirkwood_cpufreq_driver);\r\nif (!err)\r\nreturn 0;\r\ndev_err(priv.dev, "Failed to register cpufreq driver");\r\nclk_disable_unprepare(priv.powersave_clk);\r\nout_ddr:\r\nclk_disable_unprepare(priv.ddr_clk);\r\nout_cpu:\r\nclk_disable_unprepare(priv.cpu_clk);\r\nof_node_put(np);\r\nreturn err;\r\n}\r\nstatic int kirkwood_cpufreq_remove(struct platform_device *pdev)\r\n{\r\ncpufreq_unregister_driver(&kirkwood_cpufreq_driver);\r\nclk_disable_unprepare(priv.powersave_clk);\r\nclk_disable_unprepare(priv.ddr_clk);\r\nclk_disable_unprepare(priv.cpu_clk);\r\nreturn 0;\r\n}

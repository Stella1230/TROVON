static inline unsigned short from32to16(unsigned a)\r\n{\r\nunsigned short b = a >> 16;\r\nasm("addw %w2,%w0\n\t"\r\n"adcw $0,%w0\n"\r\n: "=r" (b)\r\n: "0" (b), "r" (a));\r\nreturn b;\r\n}\r\nstatic unsigned do_csum(const unsigned char *buff, unsigned len)\r\n{\r\nunsigned odd, count;\r\nunsigned long result = 0;\r\nif (unlikely(len == 0))\r\nreturn result;\r\nodd = 1 & (unsigned long) buff;\r\nif (unlikely(odd)) {\r\nresult = *buff << 8;\r\nlen--;\r\nbuff++;\r\n}\r\ncount = len >> 1;\r\nif (count) {\r\nif (2 & (unsigned long) buff) {\r\nresult += *(unsigned short *)buff;\r\ncount--;\r\nlen -= 2;\r\nbuff += 2;\r\n}\r\ncount >>= 1;\r\nif (count) {\r\nunsigned long zero;\r\nunsigned count64;\r\nif (4 & (unsigned long) buff) {\r\nresult += *(unsigned int *) buff;\r\ncount--;\r\nlen -= 4;\r\nbuff += 4;\r\n}\r\ncount >>= 1;\r\nzero = 0;\r\ncount64 = count >> 3;\r\nwhile (count64) {\r\nasm("addq 0*8(%[src]),%[res]\n\t"\r\n"adcq 1*8(%[src]),%[res]\n\t"\r\n"adcq 2*8(%[src]),%[res]\n\t"\r\n"adcq 3*8(%[src]),%[res]\n\t"\r\n"adcq 4*8(%[src]),%[res]\n\t"\r\n"adcq 5*8(%[src]),%[res]\n\t"\r\n"adcq 6*8(%[src]),%[res]\n\t"\r\n"adcq 7*8(%[src]),%[res]\n\t"\r\n"adcq %[zero],%[res]"\r\n: [res] "=r" (result)\r\n: [src] "r" (buff), [zero] "r" (zero),\r\n"[res]" (result));\r\nbuff += 64;\r\ncount64--;\r\n}\r\ncount %= 8;\r\nwhile (count) {\r\nasm("addq %1,%0\n\t"\r\n"adcq %2,%0\n"\r\n: "=r" (result)\r\n: "m" (*(unsigned long *)buff),\r\n"r" (zero), "0" (result));\r\n--count;\r\nbuff += 8;\r\n}\r\nresult = add32_with_carry(result>>32,\r\nresult&0xffffffff);\r\nif (len & 4) {\r\nresult += *(unsigned int *) buff;\r\nbuff += 4;\r\n}\r\n}\r\nif (len & 2) {\r\nresult += *(unsigned short *) buff;\r\nbuff += 2;\r\n}\r\n}\r\nif (len & 1)\r\nresult += *buff;\r\nresult = add32_with_carry(result>>32, result & 0xffffffff);\r\nif (unlikely(odd)) {\r\nresult = from32to16(result);\r\nresult = ((result >> 8) & 0xff) | ((result & 0xff) << 8);\r\n}\r\nreturn result;\r\n}\r\n__wsum csum_partial(const void *buff, int len, __wsum sum)\r\n{\r\nreturn (__force __wsum)add32_with_carry(do_csum(buff, len),\r\n(__force u32)sum);\r\n}\r\n__sum16 ip_compute_csum(const void *buff, int len)\r\n{\r\nreturn csum_fold(csum_partial(buff,len,0));\r\n}

struct fb_info *framebuffer_alloc(size_t size, struct device *dev)\r\n{\r\n#define BYTES_PER_LONG (BITS_PER_LONG/8)\r\n#define PADDING (BYTES_PER_LONG - (sizeof(struct fb_info) % BYTES_PER_LONG))\r\nint fb_info_size = sizeof(struct fb_info);\r\nstruct fb_info *info;\r\nchar *p;\r\nif (size)\r\nfb_info_size += PADDING;\r\np = kzalloc(fb_info_size + size, GFP_KERNEL);\r\nif (!p)\r\nreturn NULL;\r\ninfo = (struct fb_info *) p;\r\nif (size)\r\ninfo->par = p + fb_info_size;\r\ninfo->device = dev;\r\n#ifdef CONFIG_FB_BACKLIGHT\r\nmutex_init(&info->bl_curve_mutex);\r\n#endif\r\nreturn info;\r\n#undef PADDING\r\n#undef BYTES_PER_LONG\r\n}\r\nvoid framebuffer_release(struct fb_info *info)\r\n{\r\nif (!info)\r\nreturn;\r\nkfree(info->apertures);\r\nkfree(info);\r\n}\r\nstatic int activate(struct fb_info *fb_info, struct fb_var_screeninfo *var)\r\n{\r\nint err;\r\nvar->activate |= FB_ACTIVATE_FORCE;\r\nconsole_lock();\r\nfb_info->flags |= FBINFO_MISC_USEREVENT;\r\nerr = fb_set_var(fb_info, var);\r\nfb_info->flags &= ~FBINFO_MISC_USEREVENT;\r\nconsole_unlock();\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int mode_string(char *buf, unsigned int offset,\r\nconst struct fb_videomode *mode)\r\n{\r\nchar m = 'U';\r\nchar v = 'p';\r\nif (mode->flag & FB_MODE_IS_DETAILED)\r\nm = 'D';\r\nif (mode->flag & FB_MODE_IS_VESA)\r\nm = 'V';\r\nif (mode->flag & FB_MODE_IS_STANDARD)\r\nm = 'S';\r\nif (mode->vmode & FB_VMODE_INTERLACED)\r\nv = 'i';\r\nif (mode->vmode & FB_VMODE_DOUBLE)\r\nv = 'd';\r\nreturn snprintf(&buf[offset], PAGE_SIZE - offset, "%c:%dx%d%c-%d\n",\r\nm, mode->xres, mode->yres, v, mode->refresh);\r\n}\r\nstatic ssize_t store_mode(struct device *device, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nchar mstr[100];\r\nstruct fb_var_screeninfo var;\r\nstruct fb_modelist *modelist;\r\nstruct fb_videomode *mode;\r\nstruct list_head *pos;\r\nsize_t i;\r\nint err;\r\nmemset(&var, 0, sizeof(var));\r\nlist_for_each(pos, &fb_info->modelist) {\r\nmodelist = list_entry(pos, struct fb_modelist, list);\r\nmode = &modelist->mode;\r\ni = mode_string(mstr, 0, mode);\r\nif (strncmp(mstr, buf, max(count, i)) == 0) {\r\nvar = fb_info->var;\r\nfb_videomode_to_var(&var, mode);\r\nif ((err = activate(fb_info, &var)))\r\nreturn err;\r\nfb_info->mode = mode;\r\nreturn count;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t show_mode(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nif (!fb_info->mode)\r\nreturn 0;\r\nreturn mode_string(buf, 0, fb_info->mode);\r\n}\r\nstatic ssize_t store_modes(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nLIST_HEAD(old_list);\r\nint i = count / sizeof(struct fb_videomode);\r\nif (i * sizeof(struct fb_videomode) != count)\r\nreturn -EINVAL;\r\nconsole_lock();\r\nif (!lock_fb_info(fb_info)) {\r\nconsole_unlock();\r\nreturn -ENODEV;\r\n}\r\nlist_splice(&fb_info->modelist, &old_list);\r\nfb_videomode_to_modelist((const struct fb_videomode *)buf, i,\r\n&fb_info->modelist);\r\nif (fb_new_modelist(fb_info)) {\r\nfb_destroy_modelist(&fb_info->modelist);\r\nlist_splice(&old_list, &fb_info->modelist);\r\n} else\r\nfb_destroy_modelist(&old_list);\r\nunlock_fb_info(fb_info);\r\nconsole_unlock();\r\nreturn 0;\r\n}\r\nstatic ssize_t show_modes(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nunsigned int i;\r\nstruct list_head *pos;\r\nstruct fb_modelist *modelist;\r\nconst struct fb_videomode *mode;\r\ni = 0;\r\nlist_for_each(pos, &fb_info->modelist) {\r\nmodelist = list_entry(pos, struct fb_modelist, list);\r\nmode = &modelist->mode;\r\ni += mode_string(buf, i, mode);\r\n}\r\nreturn i;\r\n}\r\nstatic ssize_t store_bpp(struct device *device, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fb_var_screeninfo var;\r\nchar ** last = NULL;\r\nint err;\r\nvar = fb_info->var;\r\nvar.bits_per_pixel = simple_strtoul(buf, last, 0);\r\nif ((err = activate(fb_info, &var)))\r\nreturn err;\r\nreturn count;\r\n}\r\nstatic ssize_t show_bpp(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", fb_info->var.bits_per_pixel);\r\n}\r\nstatic ssize_t store_rotate(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fb_var_screeninfo var;\r\nchar **last = NULL;\r\nint err;\r\nvar = fb_info->var;\r\nvar.rotate = simple_strtoul(buf, last, 0);\r\nif ((err = activate(fb_info, &var)))\r\nreturn err;\r\nreturn count;\r\n}\r\nstatic ssize_t show_rotate(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", fb_info->var.rotate);\r\n}\r\nstatic ssize_t store_virtual(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fb_var_screeninfo var;\r\nchar *last = NULL;\r\nint err;\r\nvar = fb_info->var;\r\nvar.xres_virtual = simple_strtoul(buf, &last, 0);\r\nlast++;\r\nif (last - buf >= count)\r\nreturn -EINVAL;\r\nvar.yres_virtual = simple_strtoul(last, &last, 0);\r\nif ((err = activate(fb_info, &var)))\r\nreturn err;\r\nreturn count;\r\n}\r\nstatic ssize_t show_virtual(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d,%d\n", fb_info->var.xres_virtual,\r\nfb_info->var.yres_virtual);\r\n}\r\nstatic ssize_t show_stride(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", fb_info->fix.line_length);\r\n}\r\nstatic ssize_t store_blank(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nchar *last = NULL;\r\nint err;\r\nconsole_lock();\r\nfb_info->flags |= FBINFO_MISC_USEREVENT;\r\nerr = fb_blank(fb_info, simple_strtoul(buf, &last, 0));\r\nfb_info->flags &= ~FBINFO_MISC_USEREVENT;\r\nconsole_unlock();\r\nif (err < 0)\r\nreturn err;\r\nreturn count;\r\n}\r\nstatic ssize_t show_blank(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t store_console(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t show_console(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t store_cursor(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t show_cursor(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t store_pan(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fb_var_screeninfo var;\r\nchar *last = NULL;\r\nint err;\r\nvar = fb_info->var;\r\nvar.xoffset = simple_strtoul(buf, &last, 0);\r\nlast++;\r\nif (last - buf >= count)\r\nreturn -EINVAL;\r\nvar.yoffset = simple_strtoul(last, &last, 0);\r\nconsole_lock();\r\nerr = fb_pan_display(fb_info, &var);\r\nconsole_unlock();\r\nif (err < 0)\r\nreturn err;\r\nreturn count;\r\n}\r\nstatic ssize_t show_pan(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d,%d\n", fb_info->var.xoffset,\r\nfb_info->var.yoffset);\r\n}\r\nstatic ssize_t show_name(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", fb_info->fix.id);\r\n}\r\nstatic ssize_t store_fbstate(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nu32 state;\r\nchar *last = NULL;\r\nstate = simple_strtoul(buf, &last, 0);\r\nconsole_lock();\r\nif (!lock_fb_info(fb_info)) {\r\nconsole_unlock();\r\nreturn -ENODEV;\r\n}\r\nfb_set_suspend(fb_info, (int)state);\r\nunlock_fb_info(fb_info);\r\nconsole_unlock();\r\nreturn count;\r\n}\r\nstatic ssize_t show_fbstate(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", fb_info->state);\r\n}\r\nstatic ssize_t store_bl_curve(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nu8 tmp_curve[FB_BACKLIGHT_LEVELS];\r\nunsigned int i;\r\nif (!fb_info || !fb_info->bl_dev)\r\nreturn -ENODEV;\r\nif (count != (FB_BACKLIGHT_LEVELS / 8 * 24))\r\nreturn -EINVAL;\r\nfor (i = 0; i < (FB_BACKLIGHT_LEVELS / 8); ++i)\r\nif (sscanf(&buf[i * 24],\r\n"%2hhx %2hhx %2hhx %2hhx %2hhx %2hhx %2hhx %2hhx\n",\r\n&tmp_curve[i * 8 + 0],\r\n&tmp_curve[i * 8 + 1],\r\n&tmp_curve[i * 8 + 2],\r\n&tmp_curve[i * 8 + 3],\r\n&tmp_curve[i * 8 + 4],\r\n&tmp_curve[i * 8 + 5],\r\n&tmp_curve[i * 8 + 6],\r\n&tmp_curve[i * 8 + 7]) != 8)\r\nreturn -EINVAL;\r\nmutex_lock(&fb_info->bl_curve_mutex);\r\nfor (i = 0; i < FB_BACKLIGHT_LEVELS; ++i)\r\nfb_info->bl_curve[i] = tmp_curve[i];\r\nmutex_unlock(&fb_info->bl_curve_mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t show_bl_curve(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nssize_t len = 0;\r\nunsigned int i;\r\nif (!fb_info || !fb_info->bl_dev)\r\nreturn -ENODEV;\r\nmutex_lock(&fb_info->bl_curve_mutex);\r\nfor (i = 0; i < FB_BACKLIGHT_LEVELS; i += 8)\r\nlen += scnprintf(&buf[len], PAGE_SIZE - len, "%8ph\n",\r\nfb_info->bl_curve + i);\r\nmutex_unlock(&fb_info->bl_curve_mutex);\r\nreturn len;\r\n}\r\nint fb_init_device(struct fb_info *fb_info)\r\n{\r\nint i, error = 0;\r\ndev_set_drvdata(fb_info->dev, fb_info);\r\nfb_info->class_flag |= FB_SYSFS_FLAG_ATTR;\r\nfor (i = 0; i < ARRAY_SIZE(device_attrs); i++) {\r\nerror = device_create_file(fb_info->dev, &device_attrs[i]);\r\nif (error)\r\nbreak;\r\n}\r\nif (error) {\r\nwhile (--i >= 0)\r\ndevice_remove_file(fb_info->dev, &device_attrs[i]);\r\nfb_info->class_flag &= ~FB_SYSFS_FLAG_ATTR;\r\n}\r\nreturn 0;\r\n}\r\nvoid fb_cleanup_device(struct fb_info *fb_info)\r\n{\r\nunsigned int i;\r\nif (fb_info->class_flag & FB_SYSFS_FLAG_ATTR) {\r\nfor (i = 0; i < ARRAY_SIZE(device_attrs); i++)\r\ndevice_remove_file(fb_info->dev, &device_attrs[i]);\r\nfb_info->class_flag &= ~FB_SYSFS_FLAG_ATTR;\r\n}\r\n}\r\nvoid fb_bl_default_curve(struct fb_info *fb_info, u8 off, u8 min, u8 max)\r\n{\r\nunsigned int i, flat, count, range = (max - min);\r\nmutex_lock(&fb_info->bl_curve_mutex);\r\nfb_info->bl_curve[0] = off;\r\nfor (flat = 1; flat < (FB_BACKLIGHT_LEVELS / 16); ++flat)\r\nfb_info->bl_curve[flat] = min;\r\ncount = FB_BACKLIGHT_LEVELS * 15 / 16;\r\nfor (i = 0; i < count; ++i)\r\nfb_info->bl_curve[flat + i] = min + (range * (i + 1) / count);\r\nmutex_unlock(&fb_info->bl_curve_mutex);\r\n}

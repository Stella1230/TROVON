int sm750_hw_i2c_init(\r\nunsigned char bus_speed_mode\r\n)\r\n{\r\nunsigned int value;\r\nvalue = PEEK32(GPIO_MUX);\r\nvalue |= (GPIO_MUX_30 | GPIO_MUX_31);\r\nPOKE32(GPIO_MUX, value);\r\nenableI2C(1);\r\nvalue = PEEK32(I2C_CTRL) & ~(I2C_CTRL_MODE | I2C_CTRL_EN);\r\nif (bus_speed_mode)\r\nvalue |= I2C_CTRL_MODE;\r\nvalue |= I2C_CTRL_EN;\r\nPOKE32(I2C_CTRL, value);\r\nreturn 0;\r\n}\r\nvoid sm750_hw_i2c_close(void)\r\n{\r\nunsigned int value;\r\nvalue = PEEK32(I2C_CTRL) & ~I2C_CTRL_EN;\r\nPOKE32(I2C_CTRL, value);\r\nenableI2C(0);\r\nvalue = PEEK32(GPIO_MUX);\r\nvalue &= ~GPIO_MUX_30;\r\nvalue &= ~GPIO_MUX_31;\r\nPOKE32(GPIO_MUX, value);\r\n}\r\nstatic long hw_i2c_wait_tx_done(void)\r\n{\r\nunsigned int timeout;\r\ntimeout = HWI2C_WAIT_TIMEOUT;\r\nwhile (!(PEEK32(I2C_STATUS) & I2C_STATUS_TX) && (timeout != 0))\r\ntimeout--;\r\nif (timeout == 0)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic unsigned int hw_i2c_write_data(\r\nunsigned char addr,\r\nunsigned int length,\r\nunsigned char *buf\r\n)\r\n{\r\nunsigned char count, i;\r\nunsigned int total_bytes = 0;\r\nPOKE32(I2C_SLAVE_ADDRESS, addr & ~0x01);\r\ndo {\r\nPOKE32(I2C_RESET, 0);\r\nif (length < MAX_HWI2C_FIFO)\r\ncount = length - 1;\r\nelse\r\ncount = MAX_HWI2C_FIFO - 1;\r\nPOKE32(I2C_BYTE_COUNT, count);\r\nfor (i = 0; i <= count; i++)\r\nPOKE32(I2C_DATA0 + i, *buf++);\r\nPOKE32(I2C_CTRL, PEEK32(I2C_CTRL) | I2C_CTRL_CTRL);\r\nif (hw_i2c_wait_tx_done() != 0)\r\nbreak;\r\nlength -= (count + 1);\r\ntotal_bytes += (count + 1);\r\n} while (length > 0);\r\nreturn total_bytes;\r\n}\r\nstatic unsigned int hw_i2c_read_data(\r\nunsigned char addr,\r\nunsigned int length,\r\nunsigned char *buf\r\n)\r\n{\r\nunsigned char count, i;\r\nunsigned int total_bytes = 0;\r\nPOKE32(I2C_SLAVE_ADDRESS, addr | 0x01);\r\ndo {\r\nPOKE32(I2C_RESET, 0);\r\nif (length <= MAX_HWI2C_FIFO)\r\ncount = length - 1;\r\nelse\r\ncount = MAX_HWI2C_FIFO - 1;\r\nPOKE32(I2C_BYTE_COUNT, count);\r\nPOKE32(I2C_CTRL, PEEK32(I2C_CTRL) | I2C_CTRL_CTRL);\r\nif (hw_i2c_wait_tx_done() != 0)\r\nbreak;\r\nfor (i = 0; i <= count; i++)\r\n*buf++ = PEEK32(I2C_DATA0 + i);\r\nlength -= (count + 1);\r\ntotal_bytes += (count + 1);\r\n} while (length > 0);\r\nreturn total_bytes;\r\n}\r\nunsigned char sm750_hw_i2c_read_reg(\r\nunsigned char addr,\r\nunsigned char reg\r\n)\r\n{\r\nunsigned char value = (0xFF);\r\nif (hw_i2c_write_data(addr, 1, &reg) == 1)\r\nhw_i2c_read_data(addr, 1, &value);\r\nreturn value;\r\n}\r\nint sm750_hw_i2c_write_reg(\r\nunsigned char addr,\r\nunsigned char reg,\r\nunsigned char data\r\n)\r\n{\r\nunsigned char value[2];\r\nvalue[0] = reg;\r\nvalue[1] = data;\r\nif (hw_i2c_write_data(addr, 2, value) == 2)\r\nreturn 0;\r\nreturn -1;\r\n}

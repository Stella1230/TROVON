static int wm8997_sysclk_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nstruct regmap *regmap = arizona->regmap;\r\nconst struct reg_default *patch = NULL;\r\nint i, patch_size;\r\nswitch (arizona->rev) {\r\ncase 0:\r\npatch = wm8997_sysclk_reva_patch;\r\npatch_size = ARRAY_SIZE(wm8997_sysclk_reva_patch);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (patch)\r\nfor (i = 0; i < patch_size; i++)\r\nregmap_write_async(regmap, patch[i].reg,\r\npatch[i].def);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn arizona_dvfs_sysclk_ev(w, kcontrol, event);\r\n}\r\nstatic int wm8997_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct wm8997_priv *wm8997 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase WM8997_FLL1:\r\nreturn arizona_set_fll(&wm8997->fll[0], source, Fref, Fout);\r\ncase WM8997_FLL2:\r\nreturn arizona_set_fll(&wm8997->fll[1], source, Fref, Fout);\r\ncase WM8997_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm8997->fll[0], source, Fref,\r\nFout);\r\ncase WM8997_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm8997->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int wm8997_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct wm8997_priv *priv = snd_soc_codec_get_drvdata(codec);\r\narizona_init_spk(codec);\r\nsnd_soc_dapm_disable_pin(dapm, "HAPTICS");\r\npriv->core.arizona->dapm = dapm;\r\nreturn 0;\r\n}\r\nstatic int wm8997_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct wm8997_priv *priv = snd_soc_codec_get_drvdata(codec);\r\npriv->core.arizona->dapm = NULL;\r\narizona_free_spk(codec);\r\nreturn 0;\r\n}\r\nstatic struct regmap *wm8997_get_regmap(struct device *dev)\r\n{\r\nstruct wm8997_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int wm8997_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm8997_priv *wm8997;\r\nint i;\r\nwm8997 = devm_kzalloc(&pdev->dev, sizeof(struct wm8997_priv),\r\nGFP_KERNEL);\r\nif (wm8997 == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm8997);\r\nwm8997->core.arizona = arizona;\r\nwm8997->core.num_inputs = 4;\r\narizona_init_dvfs(&wm8997->core);\r\nfor (i = 0; i < ARRAY_SIZE(wm8997->fll); i++)\r\nwm8997->fll[i].vco_mult = 1;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&wm8997->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&wm8997->fll[1]);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_2,\r\nARIZONA_SAMPLE_RATE_2_MASK, 0x11);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_3,\r\nARIZONA_SAMPLE_RATE_3_MASK, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(wm8997_dai); i++)\r\narizona_init_dai(&wm8997->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(wm8997_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, wm8997_digital_vu[i],\r\nWM8997_DIG_VU, WM8997_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nreturn snd_soc_register_codec(&pdev->dev, &soc_codec_dev_wm8997,\r\nwm8997_dai, ARRAY_SIZE(wm8997_dai));\r\n}\r\nstatic int wm8997_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}

static int __init init_netsc520(void)\r\n{\r\nprintk(KERN_NOTICE "NetSc520 flash device: 0x%Lx at 0x%Lx\n",\r\n(unsigned long long)netsc520_map.size,\r\n(unsigned long long)netsc520_map.phys);\r\nnetsc520_map.virt = ioremap_nocache(netsc520_map.phys, netsc520_map.size);\r\nif (!netsc520_map.virt) {\r\nprintk("Failed to ioremap_nocache\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&netsc520_map);\r\nmymtd = do_map_probe("cfi_probe", &netsc520_map);\r\nif(!mymtd)\r\nmymtd = do_map_probe("map_ram", &netsc520_map);\r\nif(!mymtd)\r\nmymtd = do_map_probe("map_rom", &netsc520_map);\r\nif (!mymtd) {\r\niounmap(netsc520_map.virt);\r\nreturn -ENXIO;\r\n}\r\nmymtd->owner = THIS_MODULE;\r\nmtd_device_register(mymtd, partition_info, NUM_PARTITIONS);\r\nreturn 0;\r\n}\r\nstatic void __exit cleanup_netsc520(void)\r\n{\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (netsc520_map.virt) {\r\niounmap(netsc520_map.virt);\r\nnetsc520_map.virt = NULL;\r\n}\r\n}

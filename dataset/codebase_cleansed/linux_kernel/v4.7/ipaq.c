static int ipaq_open(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nint result = 0;\r\nint retries = connect_retries;\r\nmsleep(1000*initial_wait);\r\nwhile (retries) {\r\nretries--;\r\nresult = usb_control_msg(serial->dev,\r\nusb_sndctrlpipe(serial->dev, 0), 0x22, 0x21,\r\n0x1, 0, NULL, 0, 100);\r\nif (!result)\r\nbreak;\r\nmsleep(1000);\r\n}\r\nif (!retries && result) {\r\ndev_err(&port->dev, "%s - failed doing control urb, error %d\n",\r\n__func__, result);\r\nreturn result;\r\n}\r\nreturn usb_serial_generic_open(tty, port);\r\n}\r\nstatic int ipaq_calc_num_ports(struct usb_serial *serial)\r\n{\r\nint ipaq_num_ports = 1;\r\ndev_dbg(&serial->dev->dev, "%s - numberofendpoints: %d\n", __func__,\r\n(int)serial->interface->cur_altsetting->desc.bNumEndpoints);\r\nif (serial->interface->cur_altsetting->desc.bNumEndpoints > 3) {\r\nipaq_num_ports = 2;\r\n}\r\nreturn ipaq_num_ports;\r\n}\r\nstatic int ipaq_startup(struct usb_serial *serial)\r\n{\r\nif (serial->num_bulk_in < serial->num_ports ||\r\nserial->num_bulk_out < serial->num_ports)\r\nreturn -ENODEV;\r\nif (serial->dev->actconfig->desc.bConfigurationValue != 1) {\r\ndev_err(&serial->dev->dev, "active config #%d != 1 ??\n",\r\nserial->dev->actconfig->desc.bConfigurationValue);\r\nreturn -ENODEV;\r\n}\r\ndev_dbg(&serial->dev->dev,\r\n"%s - iPAQ module configured for %d ports\n", __func__,\r\nserial->num_ports);\r\nreturn usb_reset_configuration(serial->dev);\r\n}

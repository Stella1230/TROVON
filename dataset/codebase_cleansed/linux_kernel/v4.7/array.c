void fdarray__init(struct fdarray *fda, int nr_autogrow)\r\n{\r\nfda->entries = NULL;\r\nfda->priv = NULL;\r\nfda->nr = fda->nr_alloc = 0;\r\nfda->nr_autogrow = nr_autogrow;\r\n}\r\nint fdarray__grow(struct fdarray *fda, int nr)\r\n{\r\nvoid *priv;\r\nint nr_alloc = fda->nr_alloc + nr;\r\nsize_t psize = sizeof(fda->priv[0]) * nr_alloc;\r\nsize_t size = sizeof(struct pollfd) * nr_alloc;\r\nstruct pollfd *entries = realloc(fda->entries, size);\r\nif (entries == NULL)\r\nreturn -ENOMEM;\r\npriv = realloc(fda->priv, psize);\r\nif (priv == NULL) {\r\nfree(entries);\r\nreturn -ENOMEM;\r\n}\r\nfda->nr_alloc = nr_alloc;\r\nfda->entries = entries;\r\nfda->priv = priv;\r\nreturn 0;\r\n}\r\nstruct fdarray *fdarray__new(int nr_alloc, int nr_autogrow)\r\n{\r\nstruct fdarray *fda = calloc(1, sizeof(*fda));\r\nif (fda != NULL) {\r\nif (fdarray__grow(fda, nr_alloc)) {\r\nfree(fda);\r\nfda = NULL;\r\n} else {\r\nfda->nr_autogrow = nr_autogrow;\r\n}\r\n}\r\nreturn fda;\r\n}\r\nvoid fdarray__exit(struct fdarray *fda)\r\n{\r\nfree(fda->entries);\r\nfree(fda->priv);\r\nfdarray__init(fda, 0);\r\n}\r\nvoid fdarray__delete(struct fdarray *fda)\r\n{\r\nfdarray__exit(fda);\r\nfree(fda);\r\n}\r\nint fdarray__add(struct fdarray *fda, int fd, short revents)\r\n{\r\nint pos = fda->nr;\r\nif (fda->nr == fda->nr_alloc &&\r\nfdarray__grow(fda, fda->nr_autogrow) < 0)\r\nreturn -ENOMEM;\r\nfda->entries[fda->nr].fd = fd;\r\nfda->entries[fda->nr].events = revents;\r\nfda->nr++;\r\nreturn pos;\r\n}\r\nint fdarray__filter(struct fdarray *fda, short revents,\r\nvoid (*entry_destructor)(struct fdarray *fda, int fd))\r\n{\r\nint fd, nr = 0;\r\nif (fda->nr == 0)\r\nreturn 0;\r\nfor (fd = 0; fd < fda->nr; ++fd) {\r\nif (fda->entries[fd].revents & revents) {\r\nif (entry_destructor)\r\nentry_destructor(fda, fd);\r\ncontinue;\r\n}\r\nif (fd != nr) {\r\nfda->entries[nr] = fda->entries[fd];\r\nfda->priv[nr] = fda->priv[fd];\r\n}\r\n++nr;\r\n}\r\nreturn fda->nr = nr;\r\n}\r\nint fdarray__poll(struct fdarray *fda, int timeout)\r\n{\r\nreturn poll(fda->entries, fda->nr, timeout);\r\n}\r\nint fdarray__fprintf(struct fdarray *fda, FILE *fp)\r\n{\r\nint fd, printed = fprintf(fp, "%d [ ", fda->nr);\r\nfor (fd = 0; fd < fda->nr; ++fd)\r\nprinted += fprintf(fp, "%s%d", fd ? ", " : "", fda->entries[fd].fd);\r\nreturn printed + fprintf(fp, " ]");\r\n}

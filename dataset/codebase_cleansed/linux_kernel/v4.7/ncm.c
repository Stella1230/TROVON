static int ncm_do_config(struct usb_configuration *c)\r\n{\r\nint status;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_ncm = usb_get_function(f_ncm_inst);\r\nif (IS_ERR(f_ncm)) {\r\nstatus = PTR_ERR(f_ncm);\r\nreturn status;\r\n}\r\nstatus = usb_add_function(c, f_ncm);\r\nif (status < 0) {\r\nusb_put_function(f_ncm);\r\nreturn status;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gncm_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nstruct f_ncm_opts *ncm_opts;\r\nint status;\r\nf_ncm_inst = usb_get_function_instance("ncm");\r\nif (IS_ERR(f_ncm_inst))\r\nreturn PTR_ERR(f_ncm_inst);\r\nncm_opts = container_of(f_ncm_inst, struct f_ncm_opts, func_inst);\r\ngether_set_qmult(ncm_opts->net, qmult);\r\nif (!gether_set_host_addr(ncm_opts->net, host_addr))\r\npr_info("using host ethernet address: %s", host_addr);\r\nif (!gether_set_dev_addr(ncm_opts->net, dev_addr))\r\npr_info("using self ethernet address: %s", dev_addr);\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto fail;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nif (gadget_is_otg(gadget) && !otg_desc[0]) {\r\nstruct usb_descriptor_header *usb_desc;\r\nusb_desc = usb_otg_descriptor_alloc(gadget);\r\nif (!usb_desc)\r\ngoto fail;\r\nusb_otg_descriptor_init(gadget, usb_desc);\r\notg_desc[0] = usb_desc;\r\notg_desc[1] = NULL;\r\n}\r\nstatus = usb_add_config(cdev, &ncm_config_driver,\r\nncm_do_config);\r\nif (status < 0)\r\ngoto fail1;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s\n", DRIVER_DESC);\r\nreturn 0;\r\nfail1:\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nfail:\r\nusb_put_function_instance(f_ncm_inst);\r\nreturn status;\r\n}\r\nstatic int gncm_unbind(struct usb_composite_dev *cdev)\r\n{\r\nif (!IS_ERR_OR_NULL(f_ncm))\r\nusb_put_function(f_ncm);\r\nif (!IS_ERR_OR_NULL(f_ncm_inst))\r\nusb_put_function_instance(f_ncm_inst);\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nreturn 0;\r\n}

static int amdgpu_i2c_pre_xfer(struct i2c_adapter *i2c_adap)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t temp;\r\nmutex_lock(&i2c->mutex);\r\nif (rec->hw_capable) {\r\ntemp = RREG32(rec->mask_clk_reg);\r\ntemp &= ~(1 << 16);\r\nWREG32(rec->mask_clk_reg, temp);\r\n}\r\ntemp = RREG32(rec->a_clk_reg) & ~rec->a_clk_mask;\r\nWREG32(rec->a_clk_reg, temp);\r\ntemp = RREG32(rec->a_data_reg) & ~rec->a_data_mask;\r\nWREG32(rec->a_data_reg, temp);\r\ntemp = RREG32(rec->en_clk_reg) & ~rec->en_clk_mask;\r\nWREG32(rec->en_clk_reg, temp);\r\ntemp = RREG32(rec->en_data_reg) & ~rec->en_data_mask;\r\nWREG32(rec->en_data_reg, temp);\r\ntemp = RREG32(rec->mask_clk_reg) | rec->mask_clk_mask;\r\nWREG32(rec->mask_clk_reg, temp);\r\ntemp = RREG32(rec->mask_clk_reg);\r\ntemp = RREG32(rec->mask_data_reg) | rec->mask_data_mask;\r\nWREG32(rec->mask_data_reg, temp);\r\ntemp = RREG32(rec->mask_data_reg);\r\nreturn 0;\r\n}\r\nstatic void amdgpu_i2c_post_xfer(struct i2c_adapter *i2c_adap)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t temp;\r\ntemp = RREG32(rec->mask_clk_reg) & ~rec->mask_clk_mask;\r\nWREG32(rec->mask_clk_reg, temp);\r\ntemp = RREG32(rec->mask_clk_reg);\r\ntemp = RREG32(rec->mask_data_reg) & ~rec->mask_data_mask;\r\nWREG32(rec->mask_data_reg, temp);\r\ntemp = RREG32(rec->mask_data_reg);\r\nmutex_unlock(&i2c->mutex);\r\n}\r\nstatic int amdgpu_i2c_get_clock(void *i2c_priv)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_priv;\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t val;\r\nval = RREG32(rec->y_clk_reg);\r\nval &= rec->y_clk_mask;\r\nreturn (val != 0);\r\n}\r\nstatic int amdgpu_i2c_get_data(void *i2c_priv)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_priv;\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t val;\r\nval = RREG32(rec->y_data_reg);\r\nval &= rec->y_data_mask;\r\nreturn (val != 0);\r\n}\r\nstatic void amdgpu_i2c_set_clock(void *i2c_priv, int clock)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_priv;\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t val;\r\nval = RREG32(rec->en_clk_reg) & ~rec->en_clk_mask;\r\nval |= clock ? 0 : rec->en_clk_mask;\r\nWREG32(rec->en_clk_reg, val);\r\n}\r\nstatic void amdgpu_i2c_set_data(void *i2c_priv, int data)\r\n{\r\nstruct amdgpu_i2c_chan *i2c = i2c_priv;\r\nstruct amdgpu_device *adev = i2c->dev->dev_private;\r\nstruct amdgpu_i2c_bus_rec *rec = &i2c->rec;\r\nuint32_t val;\r\nval = RREG32(rec->en_data_reg) & ~rec->en_data_mask;\r\nval |= data ? 0 : rec->en_data_mask;\r\nWREG32(rec->en_data_reg, val);\r\n}\r\nstruct amdgpu_i2c_chan *amdgpu_i2c_create(struct drm_device *dev,\r\nstruct amdgpu_i2c_bus_rec *rec,\r\nconst char *name)\r\n{\r\nstruct amdgpu_i2c_chan *i2c;\r\nint ret;\r\nif (rec->mm_i2c && (amdgpu_hw_i2c == 0))\r\nreturn NULL;\r\ni2c = kzalloc(sizeof(struct amdgpu_i2c_chan), GFP_KERNEL);\r\nif (i2c == NULL)\r\nreturn NULL;\r\ni2c->rec = *rec;\r\ni2c->adapter.owner = THIS_MODULE;\r\ni2c->adapter.class = I2C_CLASS_DDC;\r\ni2c->adapter.dev.parent = &dev->pdev->dev;\r\ni2c->dev = dev;\r\ni2c_set_adapdata(&i2c->adapter, i2c);\r\nmutex_init(&i2c->mutex);\r\nif (rec->hw_capable &&\r\namdgpu_hw_i2c) {\r\nsnprintf(i2c->adapter.name, sizeof(i2c->adapter.name),\r\n"AMDGPU i2c hw bus %s", name);\r\ni2c->adapter.algo = &amdgpu_atombios_i2c_algo;\r\nret = i2c_add_adapter(&i2c->adapter);\r\nif (ret) {\r\nDRM_ERROR("Failed to register hw i2c %s\n", name);\r\ngoto out_free;\r\n}\r\n} else {\r\nsnprintf(i2c->adapter.name, sizeof(i2c->adapter.name),\r\n"AMDGPU i2c bit bus %s", name);\r\ni2c->adapter.algo_data = &i2c->bit;\r\ni2c->bit.pre_xfer = amdgpu_i2c_pre_xfer;\r\ni2c->bit.post_xfer = amdgpu_i2c_post_xfer;\r\ni2c->bit.setsda = amdgpu_i2c_set_data;\r\ni2c->bit.setscl = amdgpu_i2c_set_clock;\r\ni2c->bit.getsda = amdgpu_i2c_get_data;\r\ni2c->bit.getscl = amdgpu_i2c_get_clock;\r\ni2c->bit.udelay = 10;\r\ni2c->bit.timeout = usecs_to_jiffies(2200);\r\ni2c->bit.data = i2c;\r\nret = i2c_bit_add_bus(&i2c->adapter);\r\nif (ret) {\r\nDRM_ERROR("Failed to register bit i2c %s\n", name);\r\ngoto out_free;\r\n}\r\n}\r\nreturn i2c;\r\nout_free:\r\nkfree(i2c);\r\nreturn NULL;\r\n}\r\nvoid amdgpu_i2c_destroy(struct amdgpu_i2c_chan *i2c)\r\n{\r\nif (!i2c)\r\nreturn;\r\ni2c_del_adapter(&i2c->adapter);\r\nkfree(i2c);\r\n}\r\nvoid amdgpu_i2c_init(struct amdgpu_device *adev)\r\n{\r\nif (amdgpu_hw_i2c)\r\nDRM_INFO("hw_i2c forced on, you may experience display detection problems!\n");\r\nif (adev->is_atom_bios)\r\namdgpu_atombios_i2c_init(adev);\r\n}\r\nvoid amdgpu_i2c_fini(struct amdgpu_device *adev)\r\n{\r\nint i;\r\nfor (i = 0; i < AMDGPU_MAX_I2C_BUS; i++) {\r\nif (adev->i2c_bus[i]) {\r\namdgpu_i2c_destroy(adev->i2c_bus[i]);\r\nadev->i2c_bus[i] = NULL;\r\n}\r\n}\r\n}\r\nvoid amdgpu_i2c_add(struct amdgpu_device *adev,\r\nstruct amdgpu_i2c_bus_rec *rec,\r\nconst char *name)\r\n{\r\nstruct drm_device *dev = adev->ddev;\r\nint i;\r\nfor (i = 0; i < AMDGPU_MAX_I2C_BUS; i++) {\r\nif (!adev->i2c_bus[i]) {\r\nadev->i2c_bus[i] = amdgpu_i2c_create(dev, rec, name);\r\nreturn;\r\n}\r\n}\r\n}\r\nstruct amdgpu_i2c_chan *\r\namdgpu_i2c_lookup(struct amdgpu_device *adev,\r\nstruct amdgpu_i2c_bus_rec *i2c_bus)\r\n{\r\nint i;\r\nfor (i = 0; i < AMDGPU_MAX_I2C_BUS; i++) {\r\nif (adev->i2c_bus[i] &&\r\n(adev->i2c_bus[i]->rec.i2c_id == i2c_bus->i2c_id)) {\r\nreturn adev->i2c_bus[i];\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic void amdgpu_i2c_get_byte(struct amdgpu_i2c_chan *i2c_bus,\r\nu8 slave_addr,\r\nu8 addr,\r\nu8 *val)\r\n{\r\nu8 out_buf[2];\r\nu8 in_buf[2];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = out_buf,\r\n},\r\n{\r\n.addr = slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = in_buf,\r\n}\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = 0;\r\nif (i2c_transfer(&i2c_bus->adapter, msgs, 2) == 2) {\r\n*val = in_buf[0];\r\nDRM_DEBUG("val = 0x%02x\n", *val);\r\n} else {\r\nDRM_DEBUG("i2c 0x%02x 0x%02x read failed\n",\r\naddr, *val);\r\n}\r\n}\r\nstatic void amdgpu_i2c_put_byte(struct amdgpu_i2c_chan *i2c_bus,\r\nu8 slave_addr,\r\nu8 addr,\r\nu8 val)\r\n{\r\nuint8_t out_buf[2];\r\nstruct i2c_msg msg = {\r\n.addr = slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = out_buf,\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = val;\r\nif (i2c_transfer(&i2c_bus->adapter, &msg, 1) != 1)\r\nDRM_DEBUG("i2c 0x%02x 0x%02x write failed\n",\r\naddr, val);\r\n}\r\nvoid\r\namdgpu_i2c_router_select_ddc_port(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nu8 val;\r\nif (!amdgpu_connector->router.ddc_valid)\r\nreturn;\r\nif (!amdgpu_connector->router_bus)\r\nreturn;\r\namdgpu_i2c_get_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x3, &val);\r\nval &= ~amdgpu_connector->router.ddc_mux_control_pin;\r\namdgpu_i2c_put_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x3, val);\r\namdgpu_i2c_get_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x1, &val);\r\nval &= ~amdgpu_connector->router.ddc_mux_control_pin;\r\nval |= amdgpu_connector->router.ddc_mux_state;\r\namdgpu_i2c_put_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x1, val);\r\n}\r\nvoid\r\namdgpu_i2c_router_select_cd_port(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nu8 val;\r\nif (!amdgpu_connector->router.cd_valid)\r\nreturn;\r\nif (!amdgpu_connector->router_bus)\r\nreturn;\r\namdgpu_i2c_get_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x3, &val);\r\nval &= ~amdgpu_connector->router.cd_mux_control_pin;\r\namdgpu_i2c_put_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x3, val);\r\namdgpu_i2c_get_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x1, &val);\r\nval &= ~amdgpu_connector->router.cd_mux_control_pin;\r\nval |= amdgpu_connector->router.cd_mux_state;\r\namdgpu_i2c_put_byte(amdgpu_connector->router_bus,\r\namdgpu_connector->router.i2c_addr,\r\n0x1, val);\r\n}

unsigned int ucb1400_adc_read(struct snd_ac97 *ac97, u16 adc_channel,\r\nint adcsync)\r\n{\r\nunsigned int val;\r\nif (adcsync)\r\nadc_channel |= UCB_ADC_SYNC_ENA;\r\nucb1400_reg_write(ac97, UCB_ADC_CR, UCB_ADC_ENA | adc_channel);\r\nucb1400_reg_write(ac97, UCB_ADC_CR, UCB_ADC_ENA | adc_channel |\r\nUCB_ADC_START);\r\nwhile (!((val = ucb1400_reg_read(ac97, UCB_ADC_DATA))\r\n& UCB_ADC_DAT_VALID))\r\nschedule_timeout_uninterruptible(1);\r\nreturn val & UCB_ADC_DAT_MASK;\r\n}\r\nstatic int ucb1400_core_probe(struct device *dev)\r\n{\r\nint err;\r\nstruct ucb1400 *ucb;\r\nstruct ucb1400_ts ucb_ts;\r\nstruct ucb1400_gpio ucb_gpio;\r\nstruct snd_ac97 *ac97;\r\nstruct ucb1400_pdata *pdata = dev_get_platdata(dev);\r\nmemset(&ucb_ts, 0, sizeof(ucb_ts));\r\nmemset(&ucb_gpio, 0, sizeof(ucb_gpio));\r\nucb = kzalloc(sizeof(struct ucb1400), GFP_KERNEL);\r\nif (!ucb) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\ndev_set_drvdata(dev, ucb);\r\nac97 = to_ac97_t(dev);\r\nucb_ts.id = ucb1400_reg_read(ac97, UCB_ID);\r\nif (ucb_ts.id != UCB_ID_1400) {\r\nerr = -ENODEV;\r\ngoto err0;\r\n}\r\nucb_gpio.ac97 = ac97;\r\nif (pdata) {\r\nucb_gpio.gpio_setup = pdata->gpio_setup;\r\nucb_gpio.gpio_teardown = pdata->gpio_teardown;\r\nucb_gpio.gpio_offset = pdata->gpio_offset;\r\n}\r\nucb->ucb1400_gpio = platform_device_alloc("ucb1400_gpio", -1);\r\nif (!ucb->ucb1400_gpio) {\r\nerr = -ENOMEM;\r\ngoto err0;\r\n}\r\nerr = platform_device_add_data(ucb->ucb1400_gpio, &ucb_gpio,\r\nsizeof(ucb_gpio));\r\nif (err)\r\ngoto err1;\r\nerr = platform_device_add(ucb->ucb1400_gpio);\r\nif (err)\r\ngoto err1;\r\nucb_ts.ac97 = ac97;\r\nif (pdata != NULL && pdata->irq >= 0)\r\nucb_ts.irq = pdata->irq;\r\nelse\r\nucb_ts.irq = -1;\r\nucb->ucb1400_ts = platform_device_alloc("ucb1400_ts", -1);\r\nif (!ucb->ucb1400_ts) {\r\nerr = -ENOMEM;\r\ngoto err2;\r\n}\r\nerr = platform_device_add_data(ucb->ucb1400_ts, &ucb_ts,\r\nsizeof(ucb_ts));\r\nif (err)\r\ngoto err3;\r\nerr = platform_device_add(ucb->ucb1400_ts);\r\nif (err)\r\ngoto err3;\r\nreturn 0;\r\nerr3:\r\nplatform_device_put(ucb->ucb1400_ts);\r\nerr2:\r\nplatform_device_del(ucb->ucb1400_gpio);\r\nerr1:\r\nplatform_device_put(ucb->ucb1400_gpio);\r\nerr0:\r\nkfree(ucb);\r\nerr:\r\nreturn err;\r\n}\r\nstatic int ucb1400_core_remove(struct device *dev)\r\n{\r\nstruct ucb1400 *ucb = dev_get_drvdata(dev);\r\nplatform_device_unregister(ucb->ucb1400_ts);\r\nplatform_device_unregister(ucb->ucb1400_gpio);\r\nkfree(ucb);\r\nreturn 0;\r\n}\r\nstatic int __init ucb1400_core_init(void)\r\n{\r\nreturn driver_register(&ucb1400_core_driver);\r\n}\r\nstatic void __exit ucb1400_core_exit(void)\r\n{\r\ndriver_unregister(&ucb1400_core_driver);\r\n}

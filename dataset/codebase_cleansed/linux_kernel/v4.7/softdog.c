static void watchdog_fire(unsigned long data)\r\n{\r\nmodule_put(THIS_MODULE);\r\nif (soft_noboot)\r\npr_crit("Triggered - Reboot ignored\n");\r\nelse if (soft_panic) {\r\npr_crit("Initiating panic\n");\r\npanic("Software Watchdog Timer expired");\r\n} else {\r\npr_crit("Initiating system reboot\n");\r\nemergency_restart();\r\npr_crit("Reboot didn't ?????\n");\r\n}\r\n}\r\nstatic int softdog_ping(struct watchdog_device *w)\r\n{\r\nif (!mod_timer(&watchdog_ticktock, jiffies+(w->timeout*HZ)))\r\n__module_get(THIS_MODULE);\r\nreturn 0;\r\n}\r\nstatic int softdog_stop(struct watchdog_device *w)\r\n{\r\nif (del_timer(&watchdog_ticktock))\r\nmodule_put(THIS_MODULE);\r\nreturn 0;\r\n}\r\nstatic int softdog_set_timeout(struct watchdog_device *w, unsigned int t)\r\n{\r\nw->timeout = t;\r\nreturn 0;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret;\r\nif (soft_margin < 1 || soft_margin > 65535) {\r\npr_info("soft_margin must be 0 < soft_margin < 65536, using %d\n",\r\nTIMER_MARGIN);\r\nreturn -EINVAL;\r\n}\r\nsoftdog_dev.timeout = soft_margin;\r\nwatchdog_set_nowayout(&softdog_dev, nowayout);\r\nwatchdog_stop_on_reboot(&softdog_dev);\r\nret = watchdog_register_device(&softdog_dev);\r\nif (ret)\r\nreturn ret;\r\npr_info("Software Watchdog Timer: 0.08 initialized. soft_noboot=%d soft_margin=%d sec soft_panic=%d (nowayout=%d)\n",\r\nsoft_noboot, soft_margin, soft_panic, nowayout);\r\nreturn 0;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nwatchdog_unregister_device(&softdog_dev);\r\n}

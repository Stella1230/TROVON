static void vt596_dump_regs(const char *msg, u8 size)\r\n{\r\ndev_dbg(&vt596_adapter.dev, "%s: STS=%02x CNT=%02x CMD=%02x ADD=%02x "\r\n"DAT=%02x,%02x\n", msg, inb_p(SMBHSTSTS), inb_p(SMBHSTCNT),\r\ninb_p(SMBHSTCMD), inb_p(SMBHSTADD), inb_p(SMBHSTDAT0),\r\ninb_p(SMBHSTDAT1));\r\nif (size == VT596_BLOCK_DATA\r\n|| size == VT596_I2C_BLOCK_DATA) {\r\nint i;\r\ndev_dbg(&vt596_adapter.dev, "BLK=");\r\nfor (i = 0; i < I2C_SMBUS_BLOCK_MAX / 2; i++)\r\nprintk("%02x,", inb_p(SMBBLKDAT));\r\nprintk("\n");\r\ndev_dbg(&vt596_adapter.dev, " ");\r\nfor (; i < I2C_SMBUS_BLOCK_MAX - 1; i++)\r\nprintk("%02x,", inb_p(SMBBLKDAT));\r\nprintk("%02x\n", inb_p(SMBBLKDAT));\r\n}\r\n}\r\nstatic inline void vt596_dump_regs(const char *msg, u8 size) { }\r\nstatic int vt596_transaction(u8 size)\r\n{\r\nint temp;\r\nint result = 0;\r\nint timeout = 0;\r\nvt596_dump_regs("Transaction (pre)", size);\r\nif ((temp = inb_p(SMBHSTSTS)) & 0x1F) {\r\ndev_dbg(&vt596_adapter.dev, "SMBus busy (0x%02x). "\r\n"Resetting...\n", temp);\r\noutb_p(temp, SMBHSTSTS);\r\nif ((temp = inb_p(SMBHSTSTS)) & 0x1F) {\r\ndev_err(&vt596_adapter.dev, "SMBus reset failed! "\r\n"(0x%02x)\n", temp);\r\nreturn -EBUSY;\r\n}\r\n}\r\noutb_p(0x40 | size, SMBHSTCNT);\r\ndo {\r\nmsleep(1);\r\ntemp = inb_p(SMBHSTSTS);\r\n} while ((temp & 0x01) && (++timeout < MAX_TIMEOUT));\r\nif (timeout == MAX_TIMEOUT) {\r\nresult = -ETIMEDOUT;\r\ndev_err(&vt596_adapter.dev, "SMBus timeout!\n");\r\n}\r\nif (temp & 0x10) {\r\nresult = -EIO;\r\ndev_err(&vt596_adapter.dev, "Transaction failed (0x%02x)\n",\r\nsize);\r\n}\r\nif (temp & 0x08) {\r\nresult = -EIO;\r\ndev_err(&vt596_adapter.dev, "SMBus collision!\n");\r\n}\r\nif (temp & 0x04) {\r\nresult = -ENXIO;\r\ndev_dbg(&vt596_adapter.dev, "No response\n");\r\n}\r\nif (temp & 0x1F)\r\noutb_p(temp, SMBHSTSTS);\r\nvt596_dump_regs("Transaction (post)", size);\r\nreturn result;\r\n}\r\nstatic s32 vt596_access(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write, u8 command,\r\nint size, union i2c_smbus_data *data)\r\n{\r\nint i;\r\nint status;\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\nsize = VT596_QUICK;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(command, SMBHSTCMD);\r\nsize = VT596_BYTE;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(data->byte, SMBHSTDAT0);\r\nsize = VT596_BYTE_DATA;\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\noutb_p(data->word & 0xff, SMBHSTDAT0);\r\noutb_p((data->word & 0xff00) >> 8, SMBHSTDAT1);\r\n}\r\nsize = VT596_WORD_DATA;\r\nbreak;\r\ncase I2C_SMBUS_PROC_CALL:\r\noutb_p(command, SMBHSTCMD);\r\noutb_p(data->word & 0xff, SMBHSTDAT0);\r\noutb_p((data->word & 0xff00) >> 8, SMBHSTDAT1);\r\nsize = VT596_PROC_CALL;\r\nbreak;\r\ncase I2C_SMBUS_I2C_BLOCK_DATA:\r\nif (!(vt596_features & FEATURE_I2CBLOCK))\r\ngoto exit_unsupported;\r\nif (read_write == I2C_SMBUS_READ)\r\noutb_p(data->block[0], SMBHSTDAT0);\r\ncase I2C_SMBUS_BLOCK_DATA:\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nu8 len = data->block[0];\r\nif (len > I2C_SMBUS_BLOCK_MAX)\r\nlen = I2C_SMBUS_BLOCK_MAX;\r\noutb_p(len, SMBHSTDAT0);\r\ninb_p(SMBHSTCNT);\r\nfor (i = 1; i <= len; i++)\r\noutb_p(data->block[i], SMBBLKDAT);\r\n}\r\nsize = (size == I2C_SMBUS_I2C_BLOCK_DATA) ?\r\nVT596_I2C_BLOCK_DATA : VT596_BLOCK_DATA;\r\nbreak;\r\ndefault:\r\ngoto exit_unsupported;\r\n}\r\noutb_p(((addr & 0x7f) << 1) | read_write, SMBHSTADD);\r\nstatus = vt596_transaction(size);\r\nif (status)\r\nreturn status;\r\nif (size == VT596_PROC_CALL)\r\nread_write = I2C_SMBUS_READ;\r\nif ((read_write == I2C_SMBUS_WRITE) || (size == VT596_QUICK))\r\nreturn 0;\r\nswitch (size) {\r\ncase VT596_BYTE:\r\ncase VT596_BYTE_DATA:\r\ndata->byte = inb_p(SMBHSTDAT0);\r\nbreak;\r\ncase VT596_WORD_DATA:\r\ncase VT596_PROC_CALL:\r\ndata->word = inb_p(SMBHSTDAT0) + (inb_p(SMBHSTDAT1) << 8);\r\nbreak;\r\ncase VT596_I2C_BLOCK_DATA:\r\ncase VT596_BLOCK_DATA:\r\ndata->block[0] = inb_p(SMBHSTDAT0);\r\nif (data->block[0] > I2C_SMBUS_BLOCK_MAX)\r\ndata->block[0] = I2C_SMBUS_BLOCK_MAX;\r\ninb_p(SMBHSTCNT);\r\nfor (i = 1; i <= data->block[0]; i++)\r\ndata->block[i] = inb_p(SMBBLKDAT);\r\nbreak;\r\n}\r\nreturn 0;\r\nexit_unsupported:\r\ndev_warn(&vt596_adapter.dev, "Unsupported transaction %d\n",\r\nsize);\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic u32 vt596_func(struct i2c_adapter *adapter)\r\n{\r\nu32 func = I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_SMBUS_PROC_CALL | I2C_FUNC_SMBUS_BLOCK_DATA;\r\nif (vt596_features & FEATURE_I2CBLOCK)\r\nfunc |= I2C_FUNC_SMBUS_I2C_BLOCK;\r\nreturn func;\r\n}\r\nstatic int vt596_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned char temp;\r\nint error;\r\nif (force_addr) {\r\nvt596_smba = force_addr & 0xfff0;\r\nforce = 0;\r\ngoto found;\r\n}\r\nif ((pci_read_config_word(pdev, id->driver_data, &vt596_smba)) ||\r\n!(vt596_smba & 0x0001)) {\r\nif (id->device == PCI_DEVICE_ID_VIA_82C596_3 &&\r\n!pci_read_config_word(pdev, SMBBA2, &vt596_smba) &&\r\n(vt596_smba & 0x0001)) {\r\nSMBHSTCFG = 0x84;\r\n} else {\r\ndev_err(&pdev->dev, "Cannot configure "\r\n"SMBus I/O Base address\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nvt596_smba &= 0xfff0;\r\nif (vt596_smba == 0) {\r\ndev_err(&pdev->dev, "SMBus base address "\r\n"uninitialized - upgrade BIOS or use "\r\n"force_addr=0xaddr\n");\r\nreturn -ENODEV;\r\n}\r\nfound:\r\nerror = acpi_check_region(vt596_smba, 8, vt596_driver.name);\r\nif (error)\r\nreturn -ENODEV;\r\nif (!request_region(vt596_smba, 8, vt596_driver.name)) {\r\ndev_err(&pdev->dev, "SMBus region 0x%x already in use!\n",\r\nvt596_smba);\r\nreturn -ENODEV;\r\n}\r\npci_read_config_byte(pdev, SMBHSTCFG, &temp);\r\nif (force_addr) {\r\npci_write_config_byte(pdev, SMBHSTCFG, temp & 0xfe);\r\npci_write_config_word(pdev, id->driver_data, vt596_smba);\r\npci_write_config_byte(pdev, SMBHSTCFG, temp | 0x01);\r\ndev_warn(&pdev->dev, "WARNING: SMBus interface set to new "\r\n"address 0x%04x!\n", vt596_smba);\r\n} else if (!(temp & 0x01)) {\r\nif (force) {\r\npci_write_config_byte(pdev, SMBHSTCFG, temp | 0x01);\r\ndev_info(&pdev->dev, "Enabling SMBus device\n");\r\n} else {\r\ndev_err(&pdev->dev, "SMBUS: Error: Host SMBus "\r\n"controller not enabled! - upgrade BIOS or "\r\n"use force=1\n");\r\nerror = -ENODEV;\r\ngoto release_region;\r\n}\r\n}\r\ndev_dbg(&pdev->dev, "VT596_smba = 0x%X\n", vt596_smba);\r\nswitch (pdev->device) {\r\ncase PCI_DEVICE_ID_VIA_CX700:\r\ncase PCI_DEVICE_ID_VIA_VX800:\r\ncase PCI_DEVICE_ID_VIA_VX855:\r\ncase PCI_DEVICE_ID_VIA_VX900:\r\ncase PCI_DEVICE_ID_VIA_8251:\r\ncase PCI_DEVICE_ID_VIA_8237:\r\ncase PCI_DEVICE_ID_VIA_8237A:\r\ncase PCI_DEVICE_ID_VIA_8237S:\r\ncase PCI_DEVICE_ID_VIA_8235:\r\ncase PCI_DEVICE_ID_VIA_8233A:\r\ncase PCI_DEVICE_ID_VIA_8233_0:\r\nvt596_features |= FEATURE_I2CBLOCK;\r\nbreak;\r\ncase PCI_DEVICE_ID_VIA_82C686_4:\r\nif (pdev->revision >= 0x40)\r\nvt596_features |= FEATURE_I2CBLOCK;\r\nbreak;\r\n}\r\nvt596_adapter.dev.parent = &pdev->dev;\r\nsnprintf(vt596_adapter.name, sizeof(vt596_adapter.name),\r\n"SMBus Via Pro adapter at %04x", vt596_smba);\r\nvt596_pdev = pci_dev_get(pdev);\r\nerror = i2c_add_adapter(&vt596_adapter);\r\nif (error) {\r\npci_dev_put(vt596_pdev);\r\nvt596_pdev = NULL;\r\ngoto release_region;\r\n}\r\nreturn -ENODEV;\r\nrelease_region:\r\nrelease_region(vt596_smba, 8);\r\nreturn error;\r\n}\r\nstatic int __init i2c_vt596_init(void)\r\n{\r\nreturn pci_register_driver(&vt596_driver);\r\n}\r\nstatic void __exit i2c_vt596_exit(void)\r\n{\r\npci_unregister_driver(&vt596_driver);\r\nif (vt596_pdev != NULL) {\r\ni2c_del_adapter(&vt596_adapter);\r\nrelease_region(vt596_smba, 8);\r\npci_dev_put(vt596_pdev);\r\nvt596_pdev = NULL;\r\n}\r\n}

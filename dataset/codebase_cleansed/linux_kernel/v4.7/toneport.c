static int toneport_send_cmd(struct usb_device *usbdev, int cmd1, int cmd2)\r\n{\r\nint ret;\r\nret = usb_control_msg(usbdev, usb_sndctrlpipe(usbdev, 0), 0x67,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_OUT,\r\ncmd1, cmd2, NULL, 0, LINE6_TIMEOUT * HZ);\r\nif (ret < 0) {\r\ndev_err(&usbdev->dev, "send failed (error %d)\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 256;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = line6pcm->volume_monitor;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nint err;\r\nif (ucontrol->value.integer.value[0] == line6pcm->volume_monitor)\r\nreturn 0;\r\nline6pcm->volume_monitor = ucontrol->value.integer.value[0];\r\nif (line6pcm->volume_monitor > 0) {\r\nerr = line6_pcm_acquire(line6pcm, LINE6_STREAM_MONITOR);\r\nif (err < 0) {\r\nline6pcm->volume_monitor = 0;\r\nline6_pcm_release(line6pcm, LINE6_STREAM_MONITOR);\r\nreturn err;\r\n}\r\n} else {\r\nline6_pcm_release(line6pcm, LINE6_STREAM_MONITOR);\r\n}\r\nreturn 1;\r\n}\r\nstatic int snd_toneport_source_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nconst int size = ARRAY_SIZE(toneport_source_info);\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = size;\r\nif (uinfo->value.enumerated.item >= size)\r\nuinfo->value.enumerated.item = size - 1;\r\nstrcpy(uinfo->value.enumerated.name,\r\ntoneport_source_info[uinfo->value.enumerated.item].name);\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_source_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_toneport *toneport =\r\n(struct usb_line6_toneport *)line6pcm->line6;\r\nucontrol->value.enumerated.item[0] = toneport->source;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_source_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_toneport *toneport =\r\n(struct usb_line6_toneport *)line6pcm->line6;\r\nunsigned int source;\r\nsource = ucontrol->value.enumerated.item[0];\r\nif (source >= ARRAY_SIZE(toneport_source_info))\r\nreturn -EINVAL;\r\nif (source == toneport->source)\r\nreturn 0;\r\ntoneport->source = source;\r\ntoneport_send_cmd(toneport->line6.usbdev,\r\ntoneport_source_info[source].code, 0x0000);\r\nreturn 1;\r\n}\r\nstatic void toneport_start_pcm(unsigned long arg)\r\n{\r\nstruct usb_line6_toneport *toneport = (struct usb_line6_toneport *)arg;\r\nstruct usb_line6 *line6 = &toneport->line6;\r\nline6_pcm_acquire(line6->line6pcm, LINE6_STREAM_MONITOR);\r\n}\r\nstatic bool toneport_has_led(struct usb_line6_toneport *toneport)\r\n{\r\nswitch (toneport->type) {\r\ncase LINE6_GUITARPORT:\r\ncase LINE6_TONEPORT_GX:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic void toneport_update_led(struct usb_line6_toneport *toneport)\r\n{\r\ntoneport_send_cmd(toneport->line6.usbdev,\r\n(toneport->leds[0].dev.brightness << 8) | 0x0002,\r\ntoneport->leds[1].dev.brightness);\r\n}\r\nstatic void toneport_led_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct toneport_led *leds =\r\ncontainer_of(led_cdev, struct toneport_led, dev);\r\ntoneport_update_led(leds->toneport);\r\n}\r\nstatic int toneport_init_leds(struct usb_line6_toneport *toneport)\r\n{\r\nstruct device *dev = &toneport->line6.usbdev->dev;\r\nint i, err;\r\nfor (i = 0; i < 2; i++) {\r\nstruct toneport_led *led = &toneport->leds[i];\r\nstruct led_classdev *leddev = &led->dev;\r\nled->toneport = toneport;\r\nsnprintf(led->name, sizeof(led->name), "%s::%s",\r\ndev_name(dev), led_colors[i]);\r\nleddev->name = led->name;\r\nleddev->brightness = led_init_vals[i];\r\nleddev->max_brightness = 0x26;\r\nleddev->brightness_set = toneport_led_brightness_set;\r\nerr = led_classdev_register(dev, leddev);\r\nif (err)\r\nreturn err;\r\nled->registered = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic void toneport_remove_leds(struct usb_line6_toneport *toneport)\r\n{\r\nstruct toneport_led *led;\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nled = &toneport->leds[i];\r\nif (!led->registered)\r\nbreak;\r\nled_classdev_unregister(&led->dev);\r\nled->registered = false;\r\n}\r\n}\r\nstatic bool toneport_has_source_select(struct usb_line6_toneport *toneport)\r\n{\r\nswitch (toneport->type) {\r\ncase LINE6_TONEPORT_UX1:\r\ncase LINE6_TONEPORT_UX2:\r\ncase LINE6_PODSTUDIO_UX1:\r\ncase LINE6_PODSTUDIO_UX2:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic void toneport_setup(struct usb_line6_toneport *toneport)\r\n{\r\nint ticks;\r\nstruct usb_line6 *line6 = &toneport->line6;\r\nstruct usb_device *usbdev = line6->usbdev;\r\nticks = (int)get_seconds();\r\nline6_write_data(line6, 0x80c6, &ticks, 4);\r\ntoneport_send_cmd(usbdev, 0x0301, 0x0000);\r\nif (toneport_has_source_select(toneport))\r\ntoneport_send_cmd(usbdev,\r\ntoneport_source_info[toneport->source].code,\r\n0x0000);\r\nif (toneport_has_led(toneport))\r\ntoneport_update_led(toneport);\r\nmod_timer(&toneport->timer, jiffies + TONEPORT_PCM_DELAY * HZ);\r\n}\r\nstatic void line6_toneport_disconnect(struct usb_line6 *line6)\r\n{\r\nstruct usb_line6_toneport *toneport =\r\n(struct usb_line6_toneport *)line6;\r\ndel_timer_sync(&toneport->timer);\r\nif (toneport_has_led(toneport))\r\ntoneport_remove_leds(toneport);\r\n}\r\nstatic int toneport_init(struct usb_line6 *line6,\r\nconst struct usb_device_id *id)\r\n{\r\nint err;\r\nstruct usb_line6_toneport *toneport = (struct usb_line6_toneport *) line6;\r\ntoneport->type = id->driver_info;\r\nsetup_timer(&toneport->timer, toneport_start_pcm,\r\n(unsigned long)toneport);\r\nline6->disconnect = line6_toneport_disconnect;\r\nerr = line6_init_pcm(line6, &toneport_pcm_properties);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ctl_add(line6->card,\r\nsnd_ctl_new1(&toneport_control_monitor,\r\nline6->line6pcm));\r\nif (err < 0)\r\nreturn err;\r\nif (toneport_has_source_select(toneport)) {\r\nerr =\r\nsnd_ctl_add(line6->card,\r\nsnd_ctl_new1(&toneport_control_source,\r\nline6->line6pcm));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nline6_read_serial_number(line6, &toneport->serial_number);\r\nline6_read_data(line6, 0x80c2, &toneport->firmware_version, 1);\r\nif (toneport_has_led(toneport)) {\r\nerr = toneport_init_leds(toneport);\r\nif (err < 0)\r\nreturn err;\r\n}\r\ntoneport_setup(toneport);\r\nreturn snd_card_register(line6->card);\r\n}\r\nstatic int toneport_reset_resume(struct usb_interface *interface)\r\n{\r\ntoneport_setup(usb_get_intfdata(interface));\r\nreturn line6_resume(interface);\r\n}\r\nstatic int toneport_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn line6_probe(interface, id, "Line6-TonePort",\r\n&toneport_properties_table[id->driver_info],\r\ntoneport_init, sizeof(struct usb_line6_toneport));\r\n}

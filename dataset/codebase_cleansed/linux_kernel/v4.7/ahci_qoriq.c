static int ahci_qoriq_hardreset(struct ata_link *link, unsigned int *class,\r\nunsigned long deadline)\r\n{\r\nconst unsigned long *timing = sata_ehc_deb_timing(&link->eh_context);\r\nvoid __iomem *port_mmio = ahci_port_base(link->ap);\r\nu32 px_cmd, px_is, px_val;\r\nstruct ata_port *ap = link->ap;\r\nstruct ahci_port_priv *pp = ap->private_data;\r\nstruct ahci_host_priv *hpriv = ap->host->private_data;\r\nstruct ahci_qoriq_priv *qoriq_priv = hpriv->plat_data;\r\nu8 *d2h_fis = pp->rx_fis + RX_FIS_D2H_REG;\r\nstruct ata_taskfile tf;\r\nbool online;\r\nint rc;\r\nbool ls1021a_workaround = (qoriq_priv->type == AHCI_LS1021A);\r\nDPRINTK("ENTER\n");\r\nahci_stop_engine(ap);\r\nif (ls1021a_workaround) {\r\npx_cmd = readl(port_mmio + PORT_CMD);\r\npx_is = readl(port_mmio + PORT_IRQ_STAT);\r\n}\r\nata_tf_init(link->device, &tf);\r\ntf.command = ATA_BUSY;\r\nata_tf_to_fis(&tf, 0, 0, d2h_fis);\r\nrc = sata_link_hardreset(link, timing, deadline, &online,\r\nahci_check_ready);\r\nif (ls1021a_workaround) {\r\npx_val = readl(port_mmio + PORT_CMD);\r\nif (px_val != px_cmd)\r\nwritel(px_cmd, port_mmio + PORT_CMD);\r\npx_val = readl(port_mmio + PORT_IRQ_STAT);\r\nif (px_val != px_is)\r\nwritel(px_is, port_mmio + PORT_IRQ_STAT);\r\n}\r\nhpriv->start_engine(ap);\r\nif (online)\r\n*class = ahci_dev_classify(ap);\r\nDPRINTK("EXIT, rc=%d, class=%u\n", rc, *class);\r\nreturn rc;\r\n}\r\nstatic int ahci_qoriq_phy_init(struct ahci_host_priv *hpriv)\r\n{\r\nstruct ahci_qoriq_priv *qpriv = hpriv->plat_data;\r\nvoid __iomem *reg_base = hpriv->mmio;\r\nswitch (qpriv->type) {\r\ncase AHCI_LS1021A:\r\nwritel(SATA_ECC_DISABLE, qpriv->ecc_addr);\r\nwritel(AHCI_PORT_PHY_1_CFG, reg_base + PORT_PHY1);\r\nwritel(LS1021A_PORT_PHY2, reg_base + PORT_PHY2);\r\nwritel(LS1021A_PORT_PHY3, reg_base + PORT_PHY3);\r\nwritel(LS1021A_PORT_PHY4, reg_base + PORT_PHY4);\r\nwritel(LS1021A_PORT_PHY5, reg_base + PORT_PHY5);\r\nwritel(AHCI_PORT_TRANS_CFG, reg_base + PORT_TRANS);\r\nbreak;\r\ncase AHCI_LS1043A:\r\nwritel(AHCI_PORT_PHY_1_CFG, reg_base + PORT_PHY1);\r\nwritel(LS1043A_PORT_PHY2, reg_base + PORT_PHY2);\r\nwritel(LS1043A_PORT_PHY3, reg_base + PORT_PHY3);\r\nwritel(AHCI_PORT_TRANS_CFG, reg_base + PORT_TRANS);\r\nbreak;\r\ncase AHCI_LS2080A:\r\nwritel(AHCI_PORT_PHY_1_CFG, reg_base + PORT_PHY1);\r\nwritel(AHCI_PORT_TRANS_CFG, reg_base + PORT_TRANS);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ahci_qoriq_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device *dev = &pdev->dev;\r\nstruct ahci_host_priv *hpriv;\r\nstruct ahci_qoriq_priv *qoriq_priv;\r\nconst struct of_device_id *of_id;\r\nstruct resource *res;\r\nint rc;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nof_id = of_match_node(ahci_qoriq_of_match, np);\r\nif (!of_id)\r\nreturn -ENODEV;\r\nqoriq_priv = devm_kzalloc(dev, sizeof(*qoriq_priv), GFP_KERNEL);\r\nif (!qoriq_priv)\r\nreturn -ENOMEM;\r\nqoriq_priv->type = (enum ahci_qoriq_type)of_id->data;\r\nif (qoriq_priv->type == AHCI_LS1021A) {\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\n"sata-ecc");\r\nqoriq_priv->ecc_addr = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(qoriq_priv->ecc_addr))\r\nreturn PTR_ERR(qoriq_priv->ecc_addr);\r\n}\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nhpriv->plat_data = qoriq_priv;\r\nrc = ahci_qoriq_phy_init(hpriv);\r\nif (rc)\r\ngoto disable_resources;\r\nif (qoriq_priv->type == AHCI_LS2080A) {\r\nhpriv->flags |= AHCI_HFLAG_NO_NCQ;\r\nahci_qoriq_port_info.flags &= ~ATA_FLAG_NCQ;\r\n}\r\nrc = ahci_platform_init_host(pdev, hpriv, &ahci_qoriq_port_info,\r\n&ahci_qoriq_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}\r\nstatic int ahci_qoriq_resume(struct device *dev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(dev);\r\nstruct ahci_host_priv *hpriv = host->private_data;\r\nint rc;\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nrc = ahci_qoriq_phy_init(hpriv);\r\nif (rc)\r\ngoto disable_resources;\r\nrc = ahci_platform_resume_host(dev);\r\nif (rc)\r\ngoto disable_resources;\r\npm_runtime_disable(dev);\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

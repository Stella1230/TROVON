int orangefs_debugfs_init(void)\r\n{\r\nint rc = -ENOMEM;\r\ndebug_dir = debugfs_create_dir("orangefs", NULL);\r\nif (!debug_dir) {\r\npr_info("%s: debugfs_create_dir failed.\n", __func__);\r\ngoto out;\r\n}\r\nhelp_file_dentry = debugfs_create_file(ORANGEFS_KMOD_DEBUG_HELP_FILE,\r\n0444,\r\ndebug_dir,\r\ndebug_help_string,\r\n&debug_help_fops);\r\nif (!help_file_dentry) {\r\npr_info("%s: debugfs_create_file failed.\n", __func__);\r\ngoto out;\r\n}\r\norangefs_debug_disabled = 0;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nvoid orangefs_debugfs_cleanup(void)\r\n{\r\ndebugfs_remove_recursive(debug_dir);\r\n}\r\nstatic int orangefs_debug_help_open(struct inode *inode, struct file *file)\r\n{\r\nint rc = -ENODEV;\r\nint ret;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_help_open: start\n");\r\nif (orangefs_debug_disabled)\r\ngoto out;\r\nret = seq_open(file, &help_debug_ops);\r\nif (ret)\r\ngoto out;\r\n((struct seq_file *)(file->private_data))->private = inode->i_private;\r\nrc = 0;\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_help_open: rc:%d:\n",\r\nrc);\r\nreturn rc;\r\n}\r\nstatic void *help_start(struct seq_file *m, loff_t *pos)\r\n{\r\nvoid *payload = NULL;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "help_start: start\n");\r\nif (*pos == 0)\r\npayload = m->private;\r\nreturn payload;\r\n}\r\nstatic void *help_next(struct seq_file *m, void *v, loff_t *pos)\r\n{\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "help_next: start\n");\r\nreturn NULL;\r\n}\r\nstatic void help_stop(struct seq_file *m, void *p)\r\n{\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "help_stop: start\n");\r\n}\r\nstatic int help_show(struct seq_file *m, void *v)\r\n{\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "help_show: start\n");\r\nseq_puts(m, v);\r\nreturn 0;\r\n}\r\nint orangefs_kernel_debug_init(void)\r\n{\r\nint rc = -ENOMEM;\r\nstruct dentry *ret;\r\nchar *k_buffer = NULL;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "%s: start\n", __func__);\r\nk_buffer = kzalloc(ORANGEFS_MAX_DEBUG_STRING_LEN, GFP_KERNEL);\r\nif (!k_buffer)\r\ngoto out;\r\nif (strlen(kernel_debug_string) + 1 < ORANGEFS_MAX_DEBUG_STRING_LEN) {\r\nstrcpy(k_buffer, kernel_debug_string);\r\nstrcat(k_buffer, "\n");\r\n} else {\r\nstrcpy(k_buffer, "none\n");\r\npr_info("%s: overflow 1!\n", __func__);\r\n}\r\nret = debugfs_create_file(ORANGEFS_KMOD_DEBUG_FILE,\r\n0444,\r\ndebug_dir,\r\nk_buffer,\r\n&kernel_debug_fops);\r\nif (!ret) {\r\npr_info("%s: failed to create %s.\n",\r\n__func__,\r\nORANGEFS_KMOD_DEBUG_FILE);\r\ngoto out;\r\n}\r\nrc = 0;\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "%s: rc:%d:\n", __func__, rc);\r\nreturn rc;\r\n}\r\nint orangefs_client_debug_init(void)\r\n{\r\nint rc = -ENOMEM;\r\nchar *c_buffer = NULL;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "%s: start\n", __func__);\r\nc_buffer = kzalloc(ORANGEFS_MAX_DEBUG_STRING_LEN, GFP_KERNEL);\r\nif (!c_buffer)\r\ngoto out;\r\nif (strlen(client_debug_string) + 1 < ORANGEFS_MAX_DEBUG_STRING_LEN) {\r\nstrcpy(c_buffer, client_debug_string);\r\nstrcat(c_buffer, "\n");\r\n} else {\r\nstrcpy(c_buffer, "none\n");\r\npr_info("%s: overflow! 2\n", __func__);\r\n}\r\nclient_debug_dentry = debugfs_create_file(ORANGEFS_CLIENT_DEBUG_FILE,\r\n0444,\r\ndebug_dir,\r\nc_buffer,\r\n&kernel_debug_fops);\r\nif (!client_debug_dentry) {\r\npr_info("%s: failed to create updated %s.\n",\r\n__func__,\r\nORANGEFS_CLIENT_DEBUG_FILE);\r\ngoto out;\r\n}\r\nrc = 0;\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "%s: rc:%d:\n", __func__, rc);\r\nreturn rc;\r\n}\r\nint orangefs_debug_open(struct inode *inode, struct file *file)\r\n{\r\nint rc = -ENODEV;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"%s: orangefs_debug_disabled: %d\n",\r\n__func__,\r\norangefs_debug_disabled);\r\nif (orangefs_debug_disabled)\r\ngoto out;\r\nrc = 0;\r\nmutex_lock(&orangefs_debug_lock);\r\nfile->private_data = inode->i_private;\r\nmutex_unlock(&orangefs_debug_lock);\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_open: rc: %d\n",\r\nrc);\r\nreturn rc;\r\n}\r\nstatic ssize_t orangefs_debug_read(struct file *file,\r\nchar __user *ubuf,\r\nsize_t count,\r\nloff_t *ppos)\r\n{\r\nchar *buf;\r\nint sprintf_ret;\r\nssize_t read_ret = -ENOMEM;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG, "orangefs_debug_read: start\n");\r\nbuf = kmalloc(ORANGEFS_MAX_DEBUG_STRING_LEN, GFP_KERNEL);\r\nif (!buf)\r\ngoto out;\r\nmutex_lock(&orangefs_debug_lock);\r\nsprintf_ret = sprintf(buf, "%s", (char *)file->private_data);\r\nmutex_unlock(&orangefs_debug_lock);\r\nread_ret = simple_read_from_buffer(ubuf, count, ppos, buf, sprintf_ret);\r\nkfree(buf);\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_read: ret: %zu\n",\r\nread_ret);\r\nreturn read_ret;\r\n}\r\nstatic ssize_t orangefs_debug_write(struct file *file,\r\nconst char __user *ubuf,\r\nsize_t count,\r\nloff_t *ppos)\r\n{\r\nchar *buf;\r\nint rc = -EFAULT;\r\nsize_t silly = 0;\r\nchar *debug_string;\r\nstruct orangefs_kernel_op_s *new_op = NULL;\r\nstruct client_debug_mask c_mask = { NULL, 0, 0 };\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_write: %s\n",\r\nfile->f_path.dentry->d_name.name);\r\nif (count > ORANGEFS_MAX_DEBUG_STRING_LEN + 1) {\r\nsilly = count;\r\ncount = ORANGEFS_MAX_DEBUG_STRING_LEN + 1;\r\n}\r\nbuf = kzalloc(ORANGEFS_MAX_DEBUG_STRING_LEN, GFP_KERNEL);\r\nif (!buf)\r\ngoto out;\r\nif (copy_from_user(buf, ubuf, count - 1)) {\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"%s: copy_from_user failed!\n",\r\n__func__);\r\ngoto out;\r\n}\r\nif (!strcmp(file->f_path.dentry->d_name.name,\r\nORANGEFS_KMOD_DEBUG_FILE)) {\r\ndebug_string_to_mask(buf, &gossip_debug_mask, 0);\r\ndebug_mask_to_string(&gossip_debug_mask, 0);\r\ndebug_string = kernel_debug_string;\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"New kernel debug string is %s\n",\r\nkernel_debug_string);\r\n} else {\r\nif (is_daemon_in_service()) {\r\npr_info("%s: Client not running :%d:\n",\r\n__func__,\r\nis_daemon_in_service());\r\ngoto out;\r\n}\r\ndebug_string_to_mask(buf, &c_mask, 1);\r\ndebug_mask_to_string(&c_mask, 1);\r\ndebug_string = client_debug_string;\r\nnew_op = op_alloc(ORANGEFS_VFS_OP_PARAM);\r\nif (!new_op) {\r\npr_info("%s: op_alloc failed!\n", __func__);\r\ngoto out;\r\n}\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_TWO_MASK_VALUES;\r\nnew_op->upcall.req.param.type = ORANGEFS_PARAM_REQUEST_SET;\r\nmemset(new_op->upcall.req.param.s_value,\r\n0,\r\nORANGEFS_MAX_DEBUG_STRING_LEN);\r\nsprintf(new_op->upcall.req.param.s_value,\r\n"%llx %llx\n",\r\nc_mask.mask1,\r\nc_mask.mask2);\r\nrc = service_operation(new_op,\r\n"orangefs_param",\r\nORANGEFS_OP_INTERRUPTIBLE);\r\nif (rc)\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"%s: service_operation failed! rc:%d:\n",\r\n__func__,\r\nrc);\r\nop_release(new_op);\r\n}\r\nmutex_lock(&orangefs_debug_lock);\r\nmemset(file->f_inode->i_private, 0, ORANGEFS_MAX_DEBUG_STRING_LEN);\r\nsprintf((char *)file->f_inode->i_private, "%s\n", debug_string);\r\nmutex_unlock(&orangefs_debug_lock);\r\n*ppos += count;\r\nif (silly)\r\nrc = silly;\r\nelse\r\nrc = count;\r\nout:\r\ngossip_debug(GOSSIP_DEBUGFS_DEBUG,\r\n"orangefs_debug_write: rc: %d\n",\r\nrc);\r\nkfree(buf);\r\nreturn rc;\r\n}

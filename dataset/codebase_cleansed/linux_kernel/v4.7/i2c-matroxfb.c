static int matroxfb_read_gpio(struct matrox_fb_info* minfo) {\r\nunsigned long flags;\r\nint v;\r\nmatroxfb_DAC_lock_irqsave(flags);\r\nv = matroxfb_DAC_in(minfo, DAC_XGENIODATA);\r\nmatroxfb_DAC_unlock_irqrestore(flags);\r\nreturn v;\r\n}\r\nstatic void matroxfb_set_gpio(struct matrox_fb_info* minfo, int mask, int val) {\r\nunsigned long flags;\r\nint v;\r\nmatroxfb_DAC_lock_irqsave(flags);\r\nv = (matroxfb_DAC_in(minfo, DAC_XGENIOCTRL) & mask) | val;\r\nmatroxfb_DAC_out(minfo, DAC_XGENIOCTRL, v);\r\nmatroxfb_DAC_out(minfo, DAC_XGENIODATA, 0x00);\r\nmatroxfb_DAC_unlock_irqrestore(flags);\r\n}\r\nstatic inline void matroxfb_i2c_set(struct matrox_fb_info* minfo, int mask, int state) {\r\nif (state)\r\nstate = 0;\r\nelse\r\nstate = mask;\r\nmatroxfb_set_gpio(minfo, ~mask, state);\r\n}\r\nstatic void matroxfb_gpio_setsda(void* data, int state) {\r\nstruct i2c_bit_adapter* b = data;\r\nmatroxfb_i2c_set(b->minfo, b->mask.data, state);\r\n}\r\nstatic void matroxfb_gpio_setscl(void* data, int state) {\r\nstruct i2c_bit_adapter* b = data;\r\nmatroxfb_i2c_set(b->minfo, b->mask.clock, state);\r\n}\r\nstatic int matroxfb_gpio_getsda(void* data) {\r\nstruct i2c_bit_adapter* b = data;\r\nreturn (matroxfb_read_gpio(b->minfo) & b->mask.data) ? 1 : 0;\r\n}\r\nstatic int matroxfb_gpio_getscl(void* data) {\r\nstruct i2c_bit_adapter* b = data;\r\nreturn (matroxfb_read_gpio(b->minfo) & b->mask.clock) ? 1 : 0;\r\n}\r\nstatic int i2c_bus_reg(struct i2c_bit_adapter* b, struct matrox_fb_info* minfo,\r\nunsigned int data, unsigned int clock, const char *name,\r\nint class)\r\n{\r\nint err;\r\nb->minfo = minfo;\r\nb->mask.data = data;\r\nb->mask.clock = clock;\r\nb->adapter.owner = THIS_MODULE;\r\nsnprintf(b->adapter.name, sizeof(b->adapter.name), name,\r\nminfo->fbcon.node);\r\ni2c_set_adapdata(&b->adapter, b);\r\nb->adapter.class = class;\r\nb->adapter.algo_data = &b->bac;\r\nb->adapter.dev.parent = &minfo->pcidev->dev;\r\nb->bac = matrox_i2c_algo_template;\r\nb->bac.data = b;\r\nerr = i2c_bit_add_bus(&b->adapter);\r\nb->initialized = !err;\r\nreturn err;\r\n}\r\nstatic void i2c_bit_bus_del(struct i2c_bit_adapter* b) {\r\nif (b->initialized) {\r\ni2c_del_adapter(&b->adapter);\r\nb->initialized = 0;\r\n}\r\n}\r\nstatic inline void i2c_maven_done(struct matroxfb_dh_maven_info* minfo2) {\r\ni2c_bit_bus_del(&minfo2->maven);\r\n}\r\nstatic inline void i2c_ddc1_done(struct matroxfb_dh_maven_info* minfo2) {\r\ni2c_bit_bus_del(&minfo2->ddc1);\r\n}\r\nstatic inline void i2c_ddc2_done(struct matroxfb_dh_maven_info* minfo2) {\r\ni2c_bit_bus_del(&minfo2->ddc2);\r\n}\r\nstatic void* i2c_matroxfb_probe(struct matrox_fb_info* minfo) {\r\nint err;\r\nunsigned long flags;\r\nstruct matroxfb_dh_maven_info* m2info;\r\nm2info = kzalloc(sizeof(*m2info), GFP_KERNEL);\r\nif (!m2info)\r\nreturn NULL;\r\nmatroxfb_DAC_lock_irqsave(flags);\r\nmatroxfb_DAC_out(minfo, DAC_XGENIODATA, 0xFF);\r\nmatroxfb_DAC_out(minfo, DAC_XGENIOCTRL, 0x00);\r\nmatroxfb_DAC_unlock_irqrestore(flags);\r\nswitch (minfo->chip) {\r\ncase MGA_2064:\r\ncase MGA_2164:\r\nerr = i2c_bus_reg(&m2info->ddc1, minfo,\r\nDDC1B_DATA, DDC1B_CLK,\r\n"DDC:fb%u #0", I2C_CLASS_DDC);\r\nbreak;\r\ndefault:\r\nerr = i2c_bus_reg(&m2info->ddc1, minfo,\r\nDDC1_DATA, DDC1_CLK,\r\n"DDC:fb%u #0", I2C_CLASS_DDC);\r\nbreak;\r\n}\r\nif (err)\r\ngoto fail_ddc1;\r\nif (minfo->devflags.dualhead) {\r\nerr = i2c_bus_reg(&m2info->ddc2, minfo,\r\nDDC2_DATA, DDC2_CLK,\r\n"DDC:fb%u #1", I2C_CLASS_DDC);\r\nif (err == -ENODEV) {\r\nprintk(KERN_INFO "i2c-matroxfb: VGA->TV plug detected, DDC unavailable.\n");\r\n} else if (err)\r\nprintk(KERN_INFO "i2c-matroxfb: Could not register secondary output i2c bus. Continuing anyway.\n");\r\nerr = i2c_bus_reg(&m2info->maven, minfo,\r\nMAT_DATA, MAT_CLK, "MAVEN:fb%u", 0);\r\nif (err)\r\nprintk(KERN_INFO "i2c-matroxfb: Could not register Maven i2c bus. Continuing anyway.\n");\r\nelse {\r\nstruct i2c_board_info maven_info = {\r\nI2C_BOARD_INFO("maven", 0x1b),\r\n};\r\nunsigned short const addr_list[2] = {\r\n0x1b, I2C_CLIENT_END\r\n};\r\ni2c_new_probed_device(&m2info->maven.adapter,\r\n&maven_info, addr_list, NULL);\r\n}\r\n}\r\nreturn m2info;\r\nfail_ddc1:;\r\nkfree(m2info);\r\nprintk(KERN_ERR "i2c-matroxfb: Could not register primary adapter DDC bus.\n");\r\nreturn NULL;\r\n}\r\nstatic void i2c_matroxfb_remove(struct matrox_fb_info* minfo, void* data) {\r\nstruct matroxfb_dh_maven_info* m2info = data;\r\ni2c_maven_done(m2info);\r\ni2c_ddc2_done(m2info);\r\ni2c_ddc1_done(m2info);\r\nkfree(m2info);\r\n}\r\nstatic int __init i2c_matroxfb_init(void) {\r\nif (matroxfb_register_driver(&i2c_matroxfb)) {\r\nprintk(KERN_ERR "i2c-matroxfb: failed to register driver\n");\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit i2c_matroxfb_exit(void) {\r\nmatroxfb_unregister_driver(&i2c_matroxfb);\r\n}

static int apci1564_timer_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\ndevpriv->tsk_current = current;\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG |\r\nADDI_TCW_CTRL_ENA);\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nif (data[1] == 1) {\r\noutl(ADDI_TCW_CTRL_IRQ_ENA,\r\ndevpriv->timer + ADDI_TCW_CTRL_REG);\r\noutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\r\noutl(0x0, dev->iobase + APCI1564_DO_IRQ_REG);\r\noutl(0x0, dev->iobase + APCI1564_WDOG_IRQ_REG);\r\nif (devpriv->counters) {\r\nunsigned long iobase;\r\niobase = devpriv->counters + ADDI_TCW_IRQ_REG;\r\noutl(0x0, iobase + APCI1564_COUNTER(0));\r\noutl(0x0, iobase + APCI1564_COUNTER(1));\r\noutl(0x0, iobase + APCI1564_COUNTER(2));\r\n}\r\n} else {\r\noutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\r\n}\r\noutl(data[2], devpriv->timer + ADDI_TCW_TIMEBASE_REG);\r\noutl(data[3], devpriv->timer + ADDI_TCW_RELOAD_REG);\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_CNTR_ENA | ADDI_TCW_CTRL_MODE_MASK |\r\nADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG |\r\nADDI_TCW_CTRL_TIMER_ENA | ADDI_TCW_CTRL_RESET_ENA |\r\nADDI_TCW_CTRL_WARN_ENA | ADDI_TCW_CTRL_ENA);\r\nctrl |= ADDI_TCW_CTRL_MODE(2) | ADDI_TCW_CTRL_TIMER_ENA;\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\nctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG);\r\nswitch (data[1]) {\r\ncase 0:\r\nctrl &= ~ADDI_TCW_CTRL_ENA;\r\nbreak;\r\ncase 1:\r\nctrl |= ADDI_TCW_CTRL_ENA;\r\nbreak;\r\n}\r\noutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_timer_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\ndata[0] = inl(devpriv->timer + ADDI_TCW_STATUS_REG) &\r\nADDI_TCW_STATUS_OVERFLOW;\r\ndata[1] = inl(devpriv->timer + ADDI_TCW_VAL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int ctrl;\r\ndevpriv->tsk_current = current;\r\nctrl = inl(iobase + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG |\r\nADDI_TCW_CTRL_ENA);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\noutl(data[3], iobase + ADDI_TCW_RELOAD_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_EXT_CLK_MASK | ADDI_TCW_CTRL_MODE_MASK |\r\nADDI_TCW_CTRL_TIMER_ENA | ADDI_TCW_CTRL_RESET_ENA |\r\nADDI_TCW_CTRL_WARN_ENA);\r\nctrl |= ADDI_TCW_CTRL_CNTR_ENA | ADDI_TCW_CTRL_MODE(data[4]);\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nif (data[1])\r\nctrl |= ADDI_TCW_CTRL_IRQ_ENA;\r\nelse\r\nctrl &= ~ADDI_TCW_CTRL_IRQ_ENA;\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nif (data[6])\r\nctrl |= ADDI_TCW_CTRL_CNT_UP;\r\nelse\r\nctrl &= ~ADDI_TCW_CTRL_CNT_UP;\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int ctrl;\r\nctrl = inl(iobase + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG);\r\nswitch (data[1]) {\r\ncase 0:\r\nctrl = 0;\r\nbreak;\r\ncase 1:\r\nctrl |= ADDI_TCW_CTRL_ENA;\r\nbreak;\r\ncase 2:\r\nctrl |= ADDI_TCW_CTRL_GATE;\r\nbreak;\r\n}\r\noutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1564_counter_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1564_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\r\nunsigned int status;\r\ndata[0] = inl(iobase + ADDI_TCW_VAL_REG);\r\nstatus = inl(iobase + ADDI_TCW_STATUS_REG);\r\ndata[1] = (status & ADDI_TCW_STATUS_SOFT_TRIG) ? 1 : 0;\r\ndata[2] = (status & ADDI_TCW_STATUS_HARDWARE_TRIG) ? 1 : 0;\r\ndata[3] = (status & ADDI_TCW_STATUS_SOFT_CLR) ? 1 : 0;\r\ndata[4] = (status & ADDI_TCW_STATUS_OVERFLOW) ? 1 : 0;\r\nreturn insn->n;\r\n}

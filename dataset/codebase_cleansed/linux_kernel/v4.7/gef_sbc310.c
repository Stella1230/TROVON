static void __init gef_sbc310_init_irq(void)\r\n{\r\nstruct device_node *cascade_node = NULL;\r\nmpc86xx_init_irq();\r\ncascade_node = of_find_compatible_node(NULL, NULL, "gef,fpga-pic");\r\nif (!cascade_node) {\r\nprintk(KERN_WARNING "SBC310: No FPGA PIC\n");\r\nreturn;\r\n}\r\ngef_pic_init(cascade_node);\r\nof_node_put(cascade_node);\r\n}\r\nstatic void __init gef_sbc310_setup_arch(void)\r\n{\r\nstruct device_node *regs;\r\nprintk(KERN_INFO "GE Intelligent Platforms SBC310 6U VPX SBC\n");\r\n#ifdef CONFIG_SMP\r\nmpc86xx_smp_init();\r\n#endif\r\nfsl_pci_assign_primary();\r\nregs = of_find_compatible_node(NULL, NULL, "gef,fpga-regs");\r\nif (regs) {\r\nsbc310_regs = of_iomap(regs, 0);\r\nif (sbc310_regs == NULL)\r\nprintk(KERN_WARNING "Unable to map board registers\n");\r\nof_node_put(regs);\r\n}\r\n#if defined(CONFIG_MMIO_NVRAM)\r\nmmio_nvram_init();\r\n#endif\r\n}\r\nstatic unsigned int gef_sbc310_get_board_id(void)\r\n{\r\nunsigned int reg;\r\nreg = ioread32(sbc310_regs);\r\nreturn reg & 0xff;\r\n}\r\nstatic unsigned int gef_sbc310_get_pcb_rev(void)\r\n{\r\nunsigned int reg;\r\nreg = ioread32(sbc310_regs);\r\nreturn (reg >> 8) & 0xff;\r\n}\r\nstatic unsigned int gef_sbc310_get_board_rev(void)\r\n{\r\nunsigned int reg;\r\nreg = ioread32(sbc310_regs);\r\nreturn (reg >> 16) & 0xff;\r\n}\r\nstatic unsigned int gef_sbc310_get_fpga_rev(void)\r\n{\r\nunsigned int reg;\r\nreg = ioread32(sbc310_regs);\r\nreturn (reg >> 24) & 0xf;\r\n}\r\nstatic void gef_sbc310_show_cpuinfo(struct seq_file *m)\r\n{\r\nuint svid = mfspr(SPRN_SVR);\r\nseq_printf(m, "Vendor\t\t: GE Intelligent Platforms\n");\r\nseq_printf(m, "Board ID\t: 0x%2.2x\n", gef_sbc310_get_board_id());\r\nseq_printf(m, "Revision\t: %u%c\n", gef_sbc310_get_pcb_rev(),\r\n('A' + gef_sbc310_get_board_rev() - 1));\r\nseq_printf(m, "FPGA Revision\t: %u\n", gef_sbc310_get_fpga_rev());\r\nseq_printf(m, "SVR\t\t: 0x%x\n", svid);\r\n}\r\nstatic void gef_sbc310_nec_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned int val;\r\nif (!machine_is(gef_sbc310))\r\nreturn;\r\nprintk(KERN_INFO "Running NEC uPD720101 Fixup\n");\r\npci_read_config_dword(pdev, 0xe0, &val);\r\npci_write_config_dword(pdev, 0xe0, (val & ~7) | 0x2);\r\npci_write_config_dword(pdev, 0xe4, 1 << 5);\r\n}\r\nstatic int __init gef_sbc310_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nif (of_flat_dt_is_compatible(root, "gef,sbc310"))\r\nreturn 1;\r\nreturn 0;\r\n}

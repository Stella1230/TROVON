int kfd_pasid_init(void)\r\n{\r\npasid_limit = KFD_MAX_NUM_OF_PROCESSES;\r\npasid_bitmap = kcalloc(BITS_TO_LONGS(pasid_limit), sizeof(long), GFP_KERNEL);\r\nif (!pasid_bitmap)\r\nreturn -ENOMEM;\r\nset_bit(0, pasid_bitmap);\r\nreturn 0;\r\n}\r\nvoid kfd_pasid_exit(void)\r\n{\r\nkfree(pasid_bitmap);\r\n}\r\nbool kfd_set_pasid_limit(unsigned int new_limit)\r\n{\r\nif (new_limit < pasid_limit) {\r\nbool ok;\r\nmutex_lock(&pasid_mutex);\r\nok = (find_next_bit(pasid_bitmap, pasid_limit, new_limit) ==\r\npasid_limit);\r\nif (ok)\r\npasid_limit = new_limit;\r\nmutex_unlock(&pasid_mutex);\r\nreturn ok;\r\n}\r\nreturn true;\r\n}\r\ninline unsigned int kfd_get_pasid_limit(void)\r\n{\r\nreturn pasid_limit;\r\n}\r\nunsigned int kfd_pasid_alloc(void)\r\n{\r\nunsigned int found;\r\nmutex_lock(&pasid_mutex);\r\nfound = find_first_zero_bit(pasid_bitmap, pasid_limit);\r\nif (found == pasid_limit)\r\nfound = 0;\r\nelse\r\nset_bit(found, pasid_bitmap);\r\nmutex_unlock(&pasid_mutex);\r\nreturn found;\r\n}\r\nvoid kfd_pasid_free(unsigned int pasid)\r\n{\r\nBUG_ON(pasid == 0 || pasid >= pasid_limit);\r\nclear_bit(pasid, pasid_bitmap);\r\n}

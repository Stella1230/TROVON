static int max8903_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max8903_data *data = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\r\nif (data->pdata.chg) {\r\nif (gpio_get_value(data->pdata.chg) == 0)\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse if (data->usb_in || data->ta_in)\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = 0;\r\nif (data->usb_in || data->ta_in)\r\nval->intval = 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nif (data->fault)\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t max8903_dcin(int irq, void *_data)\r\n{\r\nstruct max8903_data *data = _data;\r\nstruct max8903_pdata *pdata = &data->pdata;\r\nbool ta_in;\r\nenum power_supply_type old_type;\r\nta_in = gpio_get_value(pdata->dok) ? false : true;\r\nif (ta_in == data->ta_in)\r\nreturn IRQ_HANDLED;\r\ndata->ta_in = ta_in;\r\nif (pdata->dcm)\r\ngpio_set_value(pdata->dcm, ta_in ? 1 : 0);\r\nif (pdata->cen)\r\ngpio_set_value(pdata->cen, ta_in ? 0 :\r\n(data->usb_in ? 0 : 1));\r\ndev_dbg(data->dev, "TA(DC-IN) Charger %s.\n", ta_in ?\r\n"Connected" : "Disconnected");\r\nold_type = data->psy_desc.type;\r\nif (data->ta_in)\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_MAINS;\r\nelse if (data->usb_in)\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_USB;\r\nelse\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_BATTERY;\r\nif (old_type != data->psy_desc.type)\r\npower_supply_changed(data->psy);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t max8903_usbin(int irq, void *_data)\r\n{\r\nstruct max8903_data *data = _data;\r\nstruct max8903_pdata *pdata = &data->pdata;\r\nbool usb_in;\r\nenum power_supply_type old_type;\r\nusb_in = gpio_get_value(pdata->uok) ? false : true;\r\nif (usb_in == data->usb_in)\r\nreturn IRQ_HANDLED;\r\ndata->usb_in = usb_in;\r\nif (pdata->cen)\r\ngpio_set_value(pdata->cen, usb_in ? 0 :\r\n(data->ta_in ? 0 : 1));\r\ndev_dbg(data->dev, "USB Charger %s.\n", usb_in ?\r\n"Connected" : "Disconnected");\r\nold_type = data->psy_desc.type;\r\nif (data->ta_in)\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_MAINS;\r\nelse if (data->usb_in)\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_USB;\r\nelse\r\ndata->psy_desc.type = POWER_SUPPLY_TYPE_BATTERY;\r\nif (old_type != data->psy_desc.type)\r\npower_supply_changed(data->psy);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t max8903_fault(int irq, void *_data)\r\n{\r\nstruct max8903_data *data = _data;\r\nstruct max8903_pdata *pdata = &data->pdata;\r\nbool fault;\r\nfault = gpio_get_value(pdata->flt) ? false : true;\r\nif (fault == data->fault)\r\nreturn IRQ_HANDLED;\r\ndata->fault = fault;\r\nif (fault)\r\ndev_err(data->dev, "Charger suffers a fault and stops.\n");\r\nelse\r\ndev_err(data->dev, "Charger recovered from a fault.\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int max8903_probe(struct platform_device *pdev)\r\n{\r\nstruct max8903_data *data;\r\nstruct device *dev = &pdev->dev;\r\nstruct max8903_pdata *pdata = pdev->dev.platform_data;\r\nstruct power_supply_config psy_cfg = {};\r\nint ret = 0;\r\nint gpio;\r\nint ta_in = 0;\r\nint usb_in = 0;\r\ndata = devm_kzalloc(dev, sizeof(struct max8903_data), GFP_KERNEL);\r\nif (data == NULL) {\r\ndev_err(dev, "Cannot allocate memory.\n");\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(&data->pdata, pdata, sizeof(struct max8903_pdata));\r\ndata->dev = dev;\r\nplatform_set_drvdata(pdev, data);\r\nif (pdata->dc_valid == false && pdata->usb_valid == false) {\r\ndev_err(dev, "No valid power sources.\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->dc_valid) {\r\nif (pdata->dok && gpio_is_valid(pdata->dok) &&\r\npdata->dcm && gpio_is_valid(pdata->dcm)) {\r\ngpio = pdata->dok;\r\nta_in = gpio_get_value(gpio) ? 0 : 1;\r\ngpio = pdata->dcm;\r\ngpio_set_value(gpio, ta_in);\r\n} else {\r\ndev_err(dev, "When DC is wired, DOK and DCM should"\r\n" be wired as well.\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nif (pdata->dcm) {\r\nif (gpio_is_valid(pdata->dcm))\r\ngpio_set_value(pdata->dcm, 0);\r\nelse {\r\ndev_err(dev, "Invalid pin: dcm.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\nif (pdata->usb_valid) {\r\nif (pdata->uok && gpio_is_valid(pdata->uok)) {\r\ngpio = pdata->uok;\r\nusb_in = gpio_get_value(gpio) ? 0 : 1;\r\n} else {\r\ndev_err(dev, "When USB is wired, UOK should be wired."\r\n"as well.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (pdata->cen) {\r\nif (gpio_is_valid(pdata->cen)) {\r\ngpio_set_value(pdata->cen, (ta_in || usb_in) ? 0 : 1);\r\n} else {\r\ndev_err(dev, "Invalid pin: cen.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (pdata->chg) {\r\nif (!gpio_is_valid(pdata->chg)) {\r\ndev_err(dev, "Invalid pin: chg.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (pdata->flt) {\r\nif (!gpio_is_valid(pdata->flt)) {\r\ndev_err(dev, "Invalid pin: flt.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (pdata->usus) {\r\nif (!gpio_is_valid(pdata->usus)) {\r\ndev_err(dev, "Invalid pin: usus.\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\ndata->fault = false;\r\ndata->ta_in = ta_in;\r\ndata->usb_in = usb_in;\r\ndata->psy_desc.name = "max8903_charger";\r\ndata->psy_desc.type = (ta_in) ? POWER_SUPPLY_TYPE_MAINS :\r\n((usb_in) ? POWER_SUPPLY_TYPE_USB :\r\nPOWER_SUPPLY_TYPE_BATTERY);\r\ndata->psy_desc.get_property = max8903_get_property;\r\ndata->psy_desc.properties = max8903_charger_props;\r\ndata->psy_desc.num_properties = ARRAY_SIZE(max8903_charger_props);\r\npsy_cfg.drv_data = data;\r\ndata->psy = devm_power_supply_register(dev, &data->psy_desc, &psy_cfg);\r\nif (IS_ERR(data->psy)) {\r\ndev_err(dev, "failed: power supply register.\n");\r\nreturn PTR_ERR(data->psy);\r\n}\r\nif (pdata->dc_valid) {\r\nret = devm_request_threaded_irq(dev, gpio_to_irq(pdata->dok),\r\nNULL, max8903_dcin,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\n"MAX8903 DC IN", data);\r\nif (ret) {\r\ndev_err(dev, "Cannot request irq %d for DC (%d)\n",\r\ngpio_to_irq(pdata->dok), ret);\r\nreturn ret;\r\n}\r\n}\r\nif (pdata->usb_valid) {\r\nret = devm_request_threaded_irq(dev, gpio_to_irq(pdata->uok),\r\nNULL, max8903_usbin,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\n"MAX8903 USB IN", data);\r\nif (ret) {\r\ndev_err(dev, "Cannot request irq %d for USB (%d)\n",\r\ngpio_to_irq(pdata->uok), ret);\r\nreturn ret;\r\n}\r\n}\r\nif (pdata->flt) {\r\nret = devm_request_threaded_irq(dev, gpio_to_irq(pdata->flt),\r\nNULL, max8903_fault,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\n"MAX8903 Fault", data);\r\nif (ret) {\r\ndev_err(dev, "Cannot request irq %d for Fault (%d)\n",\r\ngpio_to_irq(pdata->flt), ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

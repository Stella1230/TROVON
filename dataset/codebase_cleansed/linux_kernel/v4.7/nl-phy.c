static int ieee802154_nl_fill_phy(struct sk_buff *msg, u32 portid,\r\nu32 seq, int flags, struct wpan_phy *phy)\r\n{\r\nvoid *hdr;\r\nint i, pages = 0;\r\nuint32_t *buf = kzalloc(32 * sizeof(uint32_t), GFP_KERNEL);\r\npr_debug("%s\n", __func__);\r\nif (!buf)\r\nreturn -EMSGSIZE;\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, flags,\r\nIEEE802154_LIST_PHY);\r\nif (!hdr)\r\ngoto out;\r\nrtnl_lock();\r\nif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_PAGE, phy->current_page) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_CHANNEL, phy->current_channel))\r\ngoto nla_put_failure;\r\nfor (i = 0; i < 32; i++) {\r\nif (phy->supported.channels[i])\r\nbuf[pages++] = phy->supported.channels[i] | (i << 27);\r\n}\r\nif (pages &&\r\nnla_put(msg, IEEE802154_ATTR_CHANNEL_PAGE_LIST,\r\npages * sizeof(uint32_t), buf))\r\ngoto nla_put_failure;\r\nrtnl_unlock();\r\nkfree(buf);\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\nrtnl_unlock();\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nkfree(buf);\r\nreturn -EMSGSIZE;\r\n}\r\nint ieee802154_list_phy(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct wpan_phy *phy;\r\nconst char *name;\r\nint rc = -ENOBUFS;\r\npr_debug("%s\n", __func__);\r\nif (!info->attrs[IEEE802154_ATTR_PHY_NAME])\r\nreturn -EINVAL;\r\nname = nla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\r\nif (name[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1] != '\0')\r\nreturn -EINVAL;\r\nphy = wpan_phy_find(name);\r\nif (!phy)\r\nreturn -ENODEV;\r\nmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!msg)\r\ngoto out_dev;\r\nrc = ieee802154_nl_fill_phy(msg, info->snd_portid, info->snd_seq,\r\n0, phy);\r\nif (rc < 0)\r\ngoto out_free;\r\nwpan_phy_put(phy);\r\nreturn genlmsg_reply(msg, info);\r\nout_free:\r\nnlmsg_free(msg);\r\nout_dev:\r\nwpan_phy_put(phy);\r\nreturn rc;\r\n}\r\nstatic int ieee802154_dump_phy_iter(struct wpan_phy *phy, void *_data)\r\n{\r\nint rc;\r\nstruct dump_phy_data *data = _data;\r\npr_debug("%s\n", __func__);\r\nif (data->idx++ < data->s_idx)\r\nreturn 0;\r\nrc = ieee802154_nl_fill_phy(data->skb,\r\nNETLINK_CB(data->cb->skb).portid,\r\ndata->cb->nlh->nlmsg_seq,\r\nNLM_F_MULTI,\r\nphy);\r\nif (rc < 0) {\r\ndata->idx--;\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nint ieee802154_dump_phy(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct dump_phy_data data = {\r\n.cb = cb,\r\n.skb = skb,\r\n.s_idx = cb->args[0],\r\n.idx = 0,\r\n};\r\npr_debug("%s\n", __func__);\r\nwpan_phy_for_each(ieee802154_dump_phy_iter, &data);\r\ncb->args[0] = data.idx;\r\nreturn skb->len;\r\n}\r\nint ieee802154_add_iface(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct wpan_phy *phy;\r\nconst char *name;\r\nconst char *devname;\r\nint rc = -ENOBUFS;\r\nstruct net_device *dev;\r\nint type = __IEEE802154_DEV_INVALID;\r\nunsigned char name_assign_type;\r\npr_debug("%s\n", __func__);\r\nif (!info->attrs[IEEE802154_ATTR_PHY_NAME])\r\nreturn -EINVAL;\r\nname = nla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\r\nif (name[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1] != '\0')\r\nreturn -EINVAL;\r\nif (info->attrs[IEEE802154_ATTR_DEV_NAME]) {\r\ndevname = nla_data(info->attrs[IEEE802154_ATTR_DEV_NAME]);\r\nif (devname[nla_len(info->attrs[IEEE802154_ATTR_DEV_NAME]) - 1]\r\n!= '\0')\r\nreturn -EINVAL;\r\nname_assign_type = NET_NAME_USER;\r\n} else {\r\ndevname = "wpan%d";\r\nname_assign_type = NET_NAME_ENUM;\r\n}\r\nif (strlen(devname) >= IFNAMSIZ)\r\nreturn -ENAMETOOLONG;\r\nphy = wpan_phy_find(name);\r\nif (!phy)\r\nreturn -ENODEV;\r\nmsg = ieee802154_nl_new_reply(info, 0, IEEE802154_ADD_IFACE);\r\nif (!msg)\r\ngoto out_dev;\r\nif (info->attrs[IEEE802154_ATTR_HW_ADDR] &&\r\nnla_len(info->attrs[IEEE802154_ATTR_HW_ADDR]) !=\r\nIEEE802154_ADDR_LEN) {\r\nrc = -EINVAL;\r\ngoto nla_put_failure;\r\n}\r\nif (info->attrs[IEEE802154_ATTR_DEV_TYPE]) {\r\ntype = nla_get_u8(info->attrs[IEEE802154_ATTR_DEV_TYPE]);\r\nif (type >= __IEEE802154_DEV_MAX) {\r\nrc = -EINVAL;\r\ngoto nla_put_failure;\r\n}\r\n}\r\ndev = rdev_add_virtual_intf_deprecated(wpan_phy_to_rdev(phy), devname,\r\nname_assign_type, type);\r\nif (IS_ERR(dev)) {\r\nrc = PTR_ERR(dev);\r\ngoto nla_put_failure;\r\n}\r\ndev_hold(dev);\r\nif (info->attrs[IEEE802154_ATTR_HW_ADDR]) {\r\nstruct sockaddr addr;\r\naddr.sa_family = ARPHRD_IEEE802154;\r\nnla_memcpy(&addr.sa_data, info->attrs[IEEE802154_ATTR_HW_ADDR],\r\nIEEE802154_ADDR_LEN);\r\nrtnl_lock();\r\nrc = dev_set_mac_address(dev, &addr);\r\nrtnl_unlock();\r\nif (rc)\r\ngoto dev_unregister;\r\n}\r\nif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\r\nnla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name))\r\ngoto nla_put_failure;\r\ndev_put(dev);\r\nwpan_phy_put(phy);\r\nreturn ieee802154_nl_reply(msg, info);\r\ndev_unregister:\r\nrtnl_lock();\r\nrdev_del_virtual_intf_deprecated(wpan_phy_to_rdev(phy), dev);\r\ndev_put(dev);\r\nrtnl_unlock();\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nout_dev:\r\nwpan_phy_put(phy);\r\nreturn rc;\r\n}\r\nint ieee802154_del_iface(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct wpan_phy *phy;\r\nconst char *name;\r\nint rc;\r\nstruct net_device *dev;\r\npr_debug("%s\n", __func__);\r\nif (!info->attrs[IEEE802154_ATTR_DEV_NAME])\r\nreturn -EINVAL;\r\nname = nla_data(info->attrs[IEEE802154_ATTR_DEV_NAME]);\r\nif (name[nla_len(info->attrs[IEEE802154_ATTR_DEV_NAME]) - 1] != '\0')\r\nreturn -EINVAL;\r\ndev = dev_get_by_name(genl_info_net(info), name);\r\nif (!dev)\r\nreturn -ENODEV;\r\nphy = dev->ieee802154_ptr->wpan_phy;\r\nBUG_ON(!phy);\r\nget_device(&phy->dev);\r\nrc = -EINVAL;\r\nif (info->attrs[IEEE802154_ATTR_PHY_NAME]) {\r\nstruct wpan_phy *phy2;\r\nconst char *pname =\r\nnla_data(info->attrs[IEEE802154_ATTR_PHY_NAME]);\r\nif (pname[nla_len(info->attrs[IEEE802154_ATTR_PHY_NAME]) - 1]\r\n!= '\0')\r\ngoto out_dev;\r\nphy2 = wpan_phy_find(pname);\r\nif (!phy2)\r\ngoto out_dev;\r\nif (phy != phy2) {\r\nwpan_phy_put(phy2);\r\ngoto out_dev;\r\n}\r\n}\r\nrc = -ENOBUFS;\r\nmsg = ieee802154_nl_new_reply(info, 0, IEEE802154_DEL_IFACE);\r\nif (!msg)\r\ngoto out_dev;\r\nrtnl_lock();\r\nrdev_del_virtual_intf_deprecated(wpan_phy_to_rdev(phy), dev);\r\ndev_put(dev);\r\ndev = NULL;\r\nrtnl_unlock();\r\nif (nla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\r\nnla_put_string(msg, IEEE802154_ATTR_DEV_NAME, name))\r\ngoto nla_put_failure;\r\nwpan_phy_put(phy);\r\nreturn ieee802154_nl_reply(msg, info);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nout_dev:\r\nwpan_phy_put(phy);\r\nif (dev)\r\ndev_put(dev);\r\nreturn rc;\r\n}

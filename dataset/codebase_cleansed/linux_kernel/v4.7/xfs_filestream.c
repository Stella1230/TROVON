int\r\nxfs_filestream_peek_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\nint ret;\r\npag = xfs_perag_get(mp, agno);\r\nret = atomic_read(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\nreturn ret;\r\n}\r\nstatic int\r\nxfs_filestream_get_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\nint ret;\r\npag = xfs_perag_get(mp, agno);\r\nret = atomic_inc_return(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\nreturn ret;\r\n}\r\nstatic void\r\nxfs_filestream_put_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\npag = xfs_perag_get(mp, agno);\r\natomic_dec(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\n}\r\nstatic void\r\nxfs_fstrm_free_func(\r\nstruct xfs_mru_cache_elem *mru)\r\n{\r\nstruct xfs_fstrm_item *item =\r\ncontainer_of(mru, struct xfs_fstrm_item, mru);\r\nxfs_filestream_put_ag(item->ip->i_mount, item->ag);\r\ntrace_xfs_filestream_free(item->ip, item->ag);\r\nkmem_free(item);\r\n}\r\nstatic int\r\nxfs_filestream_pick_ag(\r\nstruct xfs_inode *ip,\r\nxfs_agnumber_t startag,\r\nxfs_agnumber_t *agp,\r\nint flags,\r\nxfs_extlen_t minlen)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nstruct xfs_fstrm_item *item;\r\nstruct xfs_perag *pag;\r\nxfs_extlen_t longest, free = 0, minfree, maxfree = 0;\r\nxfs_agnumber_t ag, max_ag = NULLAGNUMBER;\r\nint err, trylock, nscan;\r\nASSERT(S_ISDIR(VFS_I(ip)->i_mode));\r\nminfree = mp->m_sb.sb_agblocks / 50;\r\nag = startag;\r\n*agp = NULLAGNUMBER;\r\ntrylock = XFS_ALLOC_FLAG_TRYLOCK;\r\nfor (nscan = 0; 1; nscan++) {\r\ntrace_xfs_filestream_scan(ip, ag);\r\npag = xfs_perag_get(mp, ag);\r\nif (!pag->pagf_init) {\r\nerr = xfs_alloc_pagf_init(mp, NULL, ag, trylock);\r\nif (err && !trylock) {\r\nxfs_perag_put(pag);\r\nreturn err;\r\n}\r\n}\r\nif (!pag->pagf_init)\r\ngoto next_ag;\r\nif (pag->pagf_freeblks > maxfree) {\r\nmaxfree = pag->pagf_freeblks;\r\nmax_ag = ag;\r\n}\r\nif (xfs_filestream_get_ag(mp, ag) > 1) {\r\nxfs_filestream_put_ag(mp, ag);\r\ngoto next_ag;\r\n}\r\nlongest = xfs_alloc_longest_free_extent(mp, pag,\r\nxfs_alloc_min_freelist(mp, pag));\r\nif (((minlen && longest >= minlen) ||\r\n(!minlen && pag->pagf_freeblks >= minfree)) &&\r\n(!pag->pagf_metadata || !(flags & XFS_PICK_USERDATA) ||\r\n(flags & XFS_PICK_LOWSPACE))) {\r\nfree = pag->pagf_freeblks;\r\nxfs_perag_put(pag);\r\n*agp = ag;\r\nbreak;\r\n}\r\nxfs_filestream_put_ag(mp, ag);\r\nnext_ag:\r\nxfs_perag_put(pag);\r\nif (++ag >= mp->m_sb.sb_agcount)\r\nag = 0;\r\nif (ag != startag)\r\ncontinue;\r\nif (trylock != 0) {\r\ntrylock = 0;\r\ncontinue;\r\n}\r\nif (!(flags & XFS_PICK_LOWSPACE)) {\r\nflags |= XFS_PICK_LOWSPACE;\r\ncontinue;\r\n}\r\nif (max_ag != NULLAGNUMBER) {\r\nxfs_filestream_get_ag(mp, max_ag);\r\nfree = maxfree;\r\n*agp = max_ag;\r\nbreak;\r\n}\r\ntrace_xfs_filestream_pick(ip, *agp, free, nscan);\r\n*agp = 0;\r\nreturn 0;\r\n}\r\ntrace_xfs_filestream_pick(ip, *agp, free, nscan);\r\nif (*agp == NULLAGNUMBER)\r\nreturn 0;\r\nerr = -ENOMEM;\r\nitem = kmem_alloc(sizeof(*item), KM_MAYFAIL);\r\nif (!item)\r\ngoto out_put_ag;\r\nitem->ag = *agp;\r\nitem->ip = ip;\r\nerr = xfs_mru_cache_insert(mp->m_filestream, ip->i_ino, &item->mru);\r\nif (err) {\r\nif (err == -EEXIST)\r\nerr = 0;\r\ngoto out_free_item;\r\n}\r\nreturn 0;\r\nout_free_item:\r\nkmem_free(item);\r\nout_put_ag:\r\nxfs_filestream_put_ag(mp, *agp);\r\nreturn err;\r\n}\r\nstatic struct xfs_inode *\r\nxfs_filestream_get_parent(\r\nstruct xfs_inode *ip)\r\n{\r\nstruct inode *inode = VFS_I(ip), *dir = NULL;\r\nstruct dentry *dentry, *parent;\r\ndentry = d_find_alias(inode);\r\nif (!dentry)\r\ngoto out;\r\nparent = dget_parent(dentry);\r\nif (!parent)\r\ngoto out_dput;\r\ndir = igrab(d_inode(parent));\r\ndput(parent);\r\nout_dput:\r\ndput(dentry);\r\nout:\r\nreturn dir ? XFS_I(dir) : NULL;\r\n}\r\nxfs_agnumber_t\r\nxfs_filestream_lookup_ag(\r\nstruct xfs_inode *ip)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nstruct xfs_inode *pip = NULL;\r\nxfs_agnumber_t startag, ag = NULLAGNUMBER;\r\nstruct xfs_mru_cache_elem *mru;\r\nASSERT(S_ISREG(VFS_I(ip)->i_mode));\r\npip = xfs_filestream_get_parent(ip);\r\nif (!pip)\r\nreturn NULLAGNUMBER;\r\nmru = xfs_mru_cache_lookup(mp->m_filestream, pip->i_ino);\r\nif (mru) {\r\nag = container_of(mru, struct xfs_fstrm_item, mru)->ag;\r\nxfs_mru_cache_done(mp->m_filestream);\r\ntrace_xfs_filestream_lookup(ip, ag);\r\ngoto out;\r\n}\r\nif (mp->m_flags & XFS_MOUNT_32BITINODES) {\r\nxfs_agnumber_t rotorstep = xfs_rotorstep;\r\nstartag = (mp->m_agfrotor / rotorstep) % mp->m_sb.sb_agcount;\r\nmp->m_agfrotor = (mp->m_agfrotor + 1) %\r\n(mp->m_sb.sb_agcount * rotorstep);\r\n} else\r\nstartag = XFS_INO_TO_AGNO(mp, pip->i_ino);\r\nif (xfs_filestream_pick_ag(pip, startag, &ag, 0, 0))\r\nag = NULLAGNUMBER;\r\nout:\r\nIRELE(pip);\r\nreturn ag;\r\n}\r\nint\r\nxfs_filestream_new_ag(\r\nstruct xfs_bmalloca *ap,\r\nxfs_agnumber_t *agp)\r\n{\r\nstruct xfs_inode *ip = ap->ip, *pip;\r\nstruct xfs_mount *mp = ip->i_mount;\r\nxfs_extlen_t minlen = ap->length;\r\nxfs_agnumber_t startag = 0;\r\nint flags, err = 0;\r\nstruct xfs_mru_cache_elem *mru;\r\n*agp = NULLAGNUMBER;\r\npip = xfs_filestream_get_parent(ip);\r\nif (!pip)\r\ngoto exit;\r\nmru = xfs_mru_cache_remove(mp->m_filestream, pip->i_ino);\r\nif (mru) {\r\nstruct xfs_fstrm_item *item =\r\ncontainer_of(mru, struct xfs_fstrm_item, mru);\r\nstartag = (item->ag + 1) % mp->m_sb.sb_agcount;\r\n}\r\nflags = (ap->userdata ? XFS_PICK_USERDATA : 0) |\r\n(ap->flist->xbf_low ? XFS_PICK_LOWSPACE : 0);\r\nerr = xfs_filestream_pick_ag(pip, startag, agp, flags, minlen);\r\nif (mru)\r\nxfs_fstrm_free_func(mru);\r\nIRELE(pip);\r\nexit:\r\nif (*agp == NULLAGNUMBER)\r\n*agp = 0;\r\nreturn err;\r\n}\r\nvoid\r\nxfs_filestream_deassociate(\r\nstruct xfs_inode *ip)\r\n{\r\nxfs_mru_cache_delete(ip->i_mount->m_filestream, ip->i_ino);\r\n}\r\nint\r\nxfs_filestream_mount(\r\nxfs_mount_t *mp)\r\n{\r\nreturn xfs_mru_cache_create(&mp->m_filestream, xfs_fstrm_centisecs * 10,\r\n10, xfs_fstrm_free_func);\r\n}\r\nvoid\r\nxfs_filestream_unmount(\r\nxfs_mount_t *mp)\r\n{\r\nxfs_mru_cache_destroy(mp->m_filestream);\r\n}

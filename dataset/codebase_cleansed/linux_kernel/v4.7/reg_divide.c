int FPU_div(int flags, int rm, int control_w)\r\n{\r\nFPU_REG x, y;\r\nFPU_REG const *a, *b, *st0_ptr, *st_ptr;\r\nFPU_REG *dest;\r\nu_char taga, tagb, signa, signb, sign, saved_sign;\r\nint tag, deststnr;\r\nif (flags & DEST_RM)\r\ndeststnr = rm;\r\nelse\r\ndeststnr = 0;\r\nif (flags & REV) {\r\nb = &st(0);\r\nst0_ptr = b;\r\ntagb = FPU_gettag0();\r\nif (flags & LOADED) {\r\na = (FPU_REG *) rm;\r\ntaga = flags & 0x0f;\r\n} else {\r\na = &st(rm);\r\nst_ptr = a;\r\ntaga = FPU_gettagi(rm);\r\n}\r\n} else {\r\na = &st(0);\r\nst0_ptr = a;\r\ntaga = FPU_gettag0();\r\nif (flags & LOADED) {\r\nb = (FPU_REG *) rm;\r\ntagb = flags & 0x0f;\r\n} else {\r\nb = &st(rm);\r\nst_ptr = b;\r\ntagb = FPU_gettagi(rm);\r\n}\r\n}\r\nsigna = getsign(a);\r\nsignb = getsign(b);\r\nsign = signa ^ signb;\r\ndest = &st(deststnr);\r\nsaved_sign = getsign(dest);\r\nif (!(taga | tagb)) {\r\nreg_copy(a, &x);\r\nreg_copy(b, &y);\r\nsetpositive(&x);\r\nsetpositive(&y);\r\ntag = FPU_u_div(&x, &y, dest, control_w, sign);\r\nif (tag < 0)\r\nreturn tag;\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n}\r\nif (taga == TAG_Special)\r\ntaga = FPU_Special(a);\r\nif (tagb == TAG_Special)\r\ntagb = FPU_Special(b);\r\nif (((taga == TAG_Valid) && (tagb == TW_Denormal))\r\n|| ((taga == TW_Denormal) && (tagb == TAG_Valid))\r\n|| ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\r\nif (denormal_operand() < 0)\r\nreturn FPU_Exception;\r\nFPU_to_exp16(a, &x);\r\nFPU_to_exp16(b, &y);\r\ntag = FPU_u_div(&x, &y, dest, control_w, sign);\r\nif (tag < 0)\r\nreturn tag;\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n} else if ((taga <= TW_Denormal) && (tagb <= TW_Denormal)) {\r\nif (tagb != TAG_Zero) {\r\nif (tagb == TW_Denormal) {\r\nif (denormal_operand() < 0)\r\nreturn FPU_Exception;\r\n}\r\nFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\r\nsetsign(dest, sign);\r\nreturn TAG_Zero;\r\n}\r\nif (taga == TAG_Zero) {\r\nreturn arith_invalid(deststnr);\r\n}\r\nreturn FPU_divide_by_zero(deststnr, sign);\r\n}\r\nelse if ((taga == TW_NaN) || (tagb == TW_NaN)) {\r\nif (flags & LOADED)\r\nreturn real_2op_NaN((FPU_REG *) rm, flags & 0x0f, 0,\r\nst0_ptr);\r\nif (flags & DEST_RM) {\r\nint tag;\r\ntag = FPU_gettag0();\r\nif (tag == TAG_Special)\r\ntag = FPU_Special(st0_ptr);\r\nreturn real_2op_NaN(st0_ptr, tag, rm,\r\n(flags & REV) ? st0_ptr : &st(rm));\r\n} else {\r\nint tag;\r\ntag = FPU_gettagi(rm);\r\nif (tag == TAG_Special)\r\ntag = FPU_Special(&st(rm));\r\nreturn real_2op_NaN(&st(rm), tag, 0,\r\n(flags & REV) ? st0_ptr : &st(rm));\r\n}\r\n} else if (taga == TW_Infinity) {\r\nif (tagb == TW_Infinity) {\r\nreturn arith_invalid(deststnr);\r\n} else {\r\nif ((tagb == TW_Denormal) && (denormal_operand() < 0))\r\nreturn FPU_Exception;\r\nFPU_copy_to_regi(a, TAG_Special, deststnr);\r\nsetsign(dest, sign);\r\nreturn taga;\r\n}\r\n} else if (tagb == TW_Infinity) {\r\nif ((taga == TW_Denormal) && (denormal_operand() < 0))\r\nreturn FPU_Exception;\r\nFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\r\nsetsign(dest, sign);\r\nreturn TAG_Zero;\r\n}\r\n#ifdef PARANOID\r\nelse {\r\nEXCEPTION(EX_INTERNAL | 0x102);\r\nreturn FPU_Exception;\r\n}\r\n#endif\r\nreturn 0;\r\n}

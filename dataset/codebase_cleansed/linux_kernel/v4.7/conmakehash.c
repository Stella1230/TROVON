static void usage(char *argv0)\r\n{\r\nfprintf(stderr, "Usage: \n"\r\n" %s chartable [hashsize] [hashstep] [maxhashlevel]\n", argv0);\r\nexit(EX_USAGE);\r\n}\r\nstatic int getunicode(char **p0)\r\n{\r\nchar *p = *p0;\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (*p != 'U' || p[1] != '+' ||\r\n!isxdigit(p[2]) || !isxdigit(p[3]) || !isxdigit(p[4]) ||\r\n!isxdigit(p[5]) || isxdigit(p[6]))\r\nreturn -1;\r\n*p0 = p+6;\r\nreturn strtol(p+2,0,16);\r\n}\r\nstatic void addpair(int fp, int un)\r\n{\r\nint i;\r\nif ( un <= 0xfffe )\r\n{\r\nfor ( i = 0 ; i < unicount[fp] ; i++ )\r\nif ( unitable[fp][i] == un )\r\nreturn;\r\nif ( unicount[fp] > 254 )\r\n{\r\nfprintf(stderr, "ERROR: Only 255 unicodes/glyph permitted!\n");\r\nexit(EX_DATAERR);\r\n}\r\nunitable[fp][unicount[fp]] = un;\r\nunicount[fp]++;\r\n}\r\n}\r\nint main(int argc, char *argv[])\r\n{\r\nFILE *ctbl;\r\nchar *tblname;\r\nchar buffer[65536];\r\nint fontlen;\r\nint i, nuni, nent;\r\nint fp0, fp1, un0, un1;\r\nchar *p, *p1;\r\nif ( argc < 2 || argc > 5 )\r\nusage(argv[0]);\r\nif ( !strcmp(argv[1],"-") )\r\n{\r\nctbl = stdin;\r\ntblname = "stdin";\r\n}\r\nelse\r\n{\r\nctbl = fopen(tblname = argv[1], "r");\r\nif ( !ctbl )\r\n{\r\nperror(tblname);\r\nexit(EX_NOINPUT);\r\n}\r\n}\r\nfontlen = 256;\r\nfor ( i = 0 ; i < fontlen ; i++ )\r\nunicount[i] = 0;\r\nwhile ( fgets(buffer, sizeof(buffer), ctbl) != NULL )\r\n{\r\nif ( (p = strchr(buffer, '\n')) != NULL )\r\n*p = '\0';\r\nelse\r\nfprintf(stderr, "%s: Warning: line too long\n", tblname);\r\np = buffer;\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (!*p || *p == '#')\r\ncontinue;\r\nfp0 = strtol(p, &p1, 0);\r\nif (p1 == p)\r\n{\r\nfprintf(stderr, "Bad input line: %s\n", buffer);\r\nexit(EX_DATAERR);\r\n}\r\np = p1;\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (*p == '-')\r\n{\r\np++;\r\nfp1 = strtol(p, &p1, 0);\r\nif (p1 == p)\r\n{\r\nfprintf(stderr, "Bad input line: %s\n", buffer);\r\nexit(EX_DATAERR);\r\n}\r\np = p1;\r\n}\r\nelse\r\nfp1 = 0;\r\nif ( fp0 < 0 || fp0 >= fontlen )\r\n{\r\nfprintf(stderr,\r\n"%s: Glyph number (0x%x) larger than font length\n",\r\ntblname, fp0);\r\nexit(EX_DATAERR);\r\n}\r\nif ( fp1 && (fp1 < fp0 || fp1 >= fontlen) )\r\n{\r\nfprintf(stderr,\r\n"%s: Bad end of range (0x%x)\n",\r\ntblname, fp1);\r\nexit(EX_DATAERR);\r\n}\r\nif (fp1)\r\n{\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (!strncmp(p, "idem", 4))\r\n{\r\nfor (i=fp0; i<=fp1; i++)\r\naddpair(i,i);\r\np += 4;\r\n}\r\nelse\r\n{\r\nun0 = getunicode(&p);\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (*p != '-')\r\n{\r\nfprintf(stderr,\r\n"%s: Corresponding to a range of font positions, there should be a Unicode range\n",\r\ntblname);\r\nexit(EX_DATAERR);\r\n}\r\np++;\r\nun1 = getunicode(&p);\r\nif (un0 < 0 || un1 < 0)\r\n{\r\nfprintf(stderr,\r\n"%s: Bad Unicode range corresponding to font position range 0x%x-0x%x\n",\r\ntblname, fp0, fp1);\r\nexit(EX_DATAERR);\r\n}\r\nif (un1 - un0 != fp1 - fp0)\r\n{\r\nfprintf(stderr,\r\n"%s: Unicode range U+%x-U+%x not of the same length as font position range 0x%x-0x%x\n",\r\ntblname, un0, un1, fp0, fp1);\r\nexit(EX_DATAERR);\r\n}\r\nfor(i=fp0; i<=fp1; i++)\r\naddpair(i,un0-fp0+i);\r\n}\r\n}\r\nelse\r\n{\r\nwhile ( (un0 = getunicode(&p)) >= 0 )\r\naddpair(fp0, un0);\r\n}\r\nwhile (*p == ' ' || *p == '\t')\r\np++;\r\nif (*p && *p != '#')\r\nfprintf(stderr, "%s: trailing junk (%s) ignored\n", tblname, p);\r\n}\r\nfclose(ctbl);\r\nnuni = 0;\r\nfor ( i = 0 ; i < fontlen ; i++ )\r\nnuni += unicount[i];\r\nprintf("\\r\n/*\n\\r\n* Do not edit this file; it was automatically generated by\n\\r\n*\n\\r\n* conmakehash %s > [this file]\n\\r\n*\n\\r\n*/\n\\r\n\n\\r\n#include <linux/types.h>\n\\r\n\n\\r\nu8 dfont_unicount[%d] = \n\\r\n{\n\t", argv[1], fontlen);\r\nfor ( i = 0 ; i < fontlen ; i++ )\r\n{\r\nprintf("%3d", unicount[i]);\r\nif ( i == fontlen-1 )\r\nprintf("\n};\n");\r\nelse if ( i % 8 == 7 )\r\nprintf(",\n\t");\r\nelse\r\nprintf(", ");\r\n}\r\nprintf("\nu16 dfont_unitable[%d] = \n{\n\t", nuni);\r\nfp0 = 0;\r\nnent = 0;\r\nfor ( i = 0 ; i < nuni ; i++ )\r\n{\r\nwhile ( nent >= unicount[fp0] )\r\n{\r\nfp0++;\r\nnent = 0;\r\n}\r\nprintf("0x%04x", unitable[fp0][nent++]);\r\nif ( i == nuni-1 )\r\nprintf("\n};\n");\r\nelse if ( i % 8 == 7 )\r\nprintf(",\n\t");\r\nelse\r\nprintf(", ");\r\n}\r\nexit(EX_OK);\r\n}

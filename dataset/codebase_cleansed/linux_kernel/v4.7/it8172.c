static void it8172_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu16 drive_enables;\r\nu32 drive_timing;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nstatic const u8 timings[] = { 0x3f, 0x3c, 0x1b, 0x12, 0x0a };\r\npci_read_config_word(dev, 0x40, &drive_enables);\r\npci_read_config_dword(dev, 0x44, &drive_timing);\r\ndrive_enables |= 0x4000;\r\ndrive_enables &= drive->dn ? 0xc006 : 0xc060;\r\nif (drive->media == ide_disk)\r\ndrive_enables |= 0x0004 << (drive->dn * 4);\r\nif (ide_pio_need_iordy(drive, pio))\r\ndrive_enables |= 0x0002 << (drive->dn * 4);\r\ndrive_timing &= drive->dn ? 0x00003f00 : 0x000fc000;\r\ndrive_timing |= timings[pio] << (drive->dn * 6 + 8);\r\npci_write_config_word(dev, 0x40, drive_enables);\r\npci_write_config_dword(dev, 0x44, drive_timing);\r\n}\r\nstatic void it8172_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nint a_speed = 3 << (drive->dn * 4);\r\nint u_flag = 1 << drive->dn;\r\nint u_speed = 0;\r\nu8 reg48, reg4a;\r\nconst u8 speed = drive->dma_mode;\r\npci_read_config_byte(dev, 0x48, &reg48);\r\npci_read_config_byte(dev, 0x4a, &reg4a);\r\nif (speed >= XFER_UDMA_0) {\r\nu8 udma = speed - XFER_UDMA_0;\r\nu_speed = udma << (drive->dn * 4);\r\npci_write_config_byte(dev, 0x48, reg48 | u_flag);\r\nreg4a &= ~a_speed;\r\npci_write_config_byte(dev, 0x4a, reg4a | u_speed);\r\n} else {\r\nconst u8 mwdma_to_pio[] = { 0, 3, 4 };\r\npci_write_config_byte(dev, 0x48, reg48 & ~u_flag);\r\npci_write_config_byte(dev, 0x4a, reg4a & ~a_speed);\r\ndrive->pio_mode =\r\nmwdma_to_pio[speed - XFER_MW_DMA_0] + XFER_PIO_0;\r\nit8172_set_pio_mode(hwif, drive);\r\n}\r\n}\r\nstatic int it8172_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nif ((dev->class >> 8) != PCI_CLASS_STORAGE_IDE)\r\nreturn -ENODEV;\r\nreturn ide_pci_init_one(dev, &it8172_port_info, NULL);\r\n}\r\nstatic int __init it8172_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&it8172_pci_driver);\r\n}\r\nstatic void __exit it8172_ide_exit(void)\r\n{\r\npci_unregister_driver(&it8172_pci_driver);\r\n}

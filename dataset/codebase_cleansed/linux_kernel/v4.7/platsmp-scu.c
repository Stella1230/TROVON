static int shmobile_smp_scu_notifier_call(struct notifier_block *nfb,\r\nunsigned long action, void *hcpu)\r\n{\r\nunsigned int cpu = (long)hcpu;\r\nswitch (action) {\r\ncase CPU_UP_PREPARE:\r\nshmobile_smp_hook(cpu, virt_to_phys(shmobile_boot_scu),\r\nshmobile_scu_base_phys);\r\nbreak;\r\n};\r\nreturn NOTIFY_OK;\r\n}\r\nvoid __init shmobile_smp_scu_prepare_cpus(phys_addr_t scu_base_phys,\r\nunsigned int max_cpus)\r\n{\r\nshmobile_boot_fn = virt_to_phys(shmobile_smp_boot);\r\nshmobile_scu_base_phys = scu_base_phys;\r\nshmobile_scu_base = ioremap(scu_base_phys, PAGE_SIZE);\r\nscu_enable(shmobile_scu_base);\r\nscu_power_mode(shmobile_scu_base, SCU_PM_NORMAL);\r\nregister_cpu_notifier(&shmobile_smp_scu_notifier);\r\n}\r\nvoid shmobile_smp_scu_cpu_die(unsigned int cpu)\r\n{\r\nshmobile_smp_hook(cpu, 0, 0);\r\ndsb();\r\nflush_cache_all();\r\nscu_power_mode(shmobile_scu_base, SCU_PM_POWEROFF);\r\nshmobile_smp_sleep();\r\n}\r\nstatic int shmobile_smp_scu_psr_core_disabled(int cpu)\r\n{\r\nunsigned long mask = SCU_PM_POWEROFF << (cpu * 8);\r\nif ((__raw_readl(shmobile_scu_base + 8) & mask) == mask)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint shmobile_smp_scu_cpu_kill(unsigned int cpu)\r\n{\r\nint k;\r\nfor (k = 0; k < 1000; k++) {\r\nif (shmobile_smp_scu_psr_core_disabled(cpu))\r\nreturn 1;\r\nmdelay(1);\r\n}\r\nreturn 0;\r\n}

static u8 max77693_led_iout_to_reg(u32 ua)\r\n{\r\nif (ua < FLASH_IOUT_MIN)\r\nua = FLASH_IOUT_MIN;\r\nreturn (ua - FLASH_IOUT_MIN) / FLASH_IOUT_STEP;\r\n}\r\nstatic u8 max77693_flash_timeout_to_reg(u32 us)\r\n{\r\nreturn (us - FLASH_TIMEOUT_MIN) / FLASH_TIMEOUT_STEP;\r\n}\r\nstatic inline struct max77693_sub_led *flcdev_to_sub_led(\r\nstruct led_classdev_flash *fled_cdev)\r\n{\r\nreturn container_of(fled_cdev, struct max77693_sub_led, fled_cdev);\r\n}\r\nstatic inline struct max77693_led_device *sub_led_to_led(\r\nstruct max77693_sub_led *sub_led)\r\n{\r\nreturn container_of(sub_led, struct max77693_led_device,\r\nsub_leds[sub_led->fled_id]);\r\n}\r\nstatic inline u8 max77693_led_vsys_to_reg(u32 mv)\r\n{\r\nreturn ((mv - MAX_FLASH1_VSYS_MIN) / MAX_FLASH1_VSYS_STEP) << 2;\r\n}\r\nstatic inline u8 max77693_led_vout_to_reg(u32 mv)\r\n{\r\nreturn (mv - FLASH_VOUT_MIN) / FLASH_VOUT_STEP + FLASH_VOUT_RMIN;\r\n}\r\nstatic inline bool max77693_fled_used(struct max77693_led_device *led,\r\nint fled_id)\r\n{\r\nu8 fled_bit = (fled_id == FLED1) ? FLED1_IOUT : FLED2_IOUT;\r\nreturn led->fled_mask & fled_bit;\r\n}\r\nstatic int max77693_set_mode_reg(struct max77693_led_device *led, u8 mode)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nint ret, v = 0, i;\r\nfor (i = FLED1; i <= FLED2; ++i) {\r\nif (mode & MODE_TORCH(i))\r\nv |= FLASH_EN_ON << TORCH_EN_SHIFT(i);\r\nif (mode & MODE_FLASH(i)) {\r\nv |= FLASH_EN_ON << FLASH_EN_SHIFT(i);\r\n} else if (mode & MODE_FLASH_EXTERNAL(i)) {\r\nv |= FLASH_EN_FLASH << FLASH_EN_SHIFT(i);\r\nv |= FLASH_EN_TORCH << TORCH_EN_SHIFT(i);\r\n}\r\n}\r\nif (mode & ~(MODE_TORCH(FLED1) | MODE_TORCH(FLED2))) {\r\nret = regmap_write(rmap, MAX77693_LED_REG_FLASH_EN, 0);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn regmap_write(rmap, MAX77693_LED_REG_FLASH_EN, v);\r\n}\r\nstatic int max77693_add_mode(struct max77693_led_device *led, u8 mode)\r\n{\r\nu8 new_mode_flags;\r\nint i, ret;\r\nif (led->iout_joint)\r\nmode |= (mode << 1);\r\nfor (i = FLED1; i <= FLED2; ++i)\r\nif (mode & MODE_FLASH_EXTERNAL(i))\r\nled->mode_flags &= (~MODE_TORCH(i) & ~MODE_FLASH(i));\r\nnew_mode_flags = mode | led->mode_flags;\r\nnew_mode_flags &= led->allowed_modes;\r\nif (new_mode_flags ^ led->mode_flags)\r\nled->mode_flags = new_mode_flags;\r\nelse\r\nreturn 0;\r\nret = max77693_set_mode_reg(led, led->mode_flags);\r\nif (ret < 0)\r\nreturn ret;\r\nif (mode & MODE_FLASH_MASK)\r\nled->mode_flags &= ~mode;\r\nreturn ret;\r\n}\r\nstatic int max77693_clear_mode(struct max77693_led_device *led,\r\nu8 mode)\r\n{\r\nif (led->iout_joint)\r\nmode |= (mode << 1);\r\nled->mode_flags &= ~mode;\r\nreturn max77693_set_mode_reg(led, led->mode_flags);\r\n}\r\nstatic void max77693_add_allowed_modes(struct max77693_led_device *led,\r\nint fled_id, enum max77693_led_mode mode)\r\n{\r\nif (mode == FLASH)\r\nled->allowed_modes |= (MODE_FLASH(fled_id) |\r\nMODE_FLASH_EXTERNAL(fled_id));\r\nelse\r\nled->allowed_modes |= MODE_TORCH(fled_id);\r\n}\r\nstatic void max77693_distribute_currents(struct max77693_led_device *led,\r\nint fled_id, enum max77693_led_mode mode,\r\nu32 micro_amp, u32 iout_max[2], u32 iout[2])\r\n{\r\nif (!led->iout_joint) {\r\niout[fled_id] = micro_amp;\r\nmax77693_add_allowed_modes(led, fled_id, mode);\r\nreturn;\r\n}\r\niout[FLED1] = min(micro_amp, iout_max[FLED1]);\r\niout[FLED2] = micro_amp - iout[FLED1];\r\nif (mode == FLASH)\r\nled->allowed_modes &= ~MODE_FLASH_MASK;\r\nelse\r\nled->allowed_modes &= ~MODE_TORCH_MASK;\r\nmax77693_add_allowed_modes(led, FLED1, mode);\r\nif (iout[FLED2])\r\nmax77693_add_allowed_modes(led, FLED2, mode);\r\n}\r\nstatic int max77693_set_torch_current(struct max77693_led_device *led,\r\nint fled_id, u32 micro_amp)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nu8 iout1_reg = 0, iout2_reg = 0;\r\nu32 iout[2];\r\nmax77693_distribute_currents(led, fled_id, TORCH, micro_amp,\r\nled->iout_torch_max, iout);\r\nif (fled_id == FLED1 || led->iout_joint) {\r\niout1_reg = max77693_led_iout_to_reg(iout[FLED1]);\r\nled->torch_iout_reg &= TORCH_IOUT_MASK(TORCH_IOUT2_SHIFT);\r\n}\r\nif (fled_id == FLED2 || led->iout_joint) {\r\niout2_reg = max77693_led_iout_to_reg(iout[FLED2]);\r\nled->torch_iout_reg &= TORCH_IOUT_MASK(TORCH_IOUT1_SHIFT);\r\n}\r\nled->torch_iout_reg |= ((iout1_reg << TORCH_IOUT1_SHIFT) |\r\n(iout2_reg << TORCH_IOUT2_SHIFT));\r\nreturn regmap_write(rmap, MAX77693_LED_REG_ITORCH,\r\nled->torch_iout_reg);\r\n}\r\nstatic int max77693_set_flash_current(struct max77693_led_device *led,\r\nint fled_id,\r\nu32 micro_amp)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nu8 iout1_reg, iout2_reg;\r\nu32 iout[2];\r\nint ret = -EINVAL;\r\nmax77693_distribute_currents(led, fled_id, FLASH, micro_amp,\r\nled->iout_flash_max, iout);\r\nif (fled_id == FLED1 || led->iout_joint) {\r\niout1_reg = max77693_led_iout_to_reg(iout[FLED1]);\r\nret = regmap_write(rmap, MAX77693_LED_REG_IFLASH1,\r\niout1_reg);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (fled_id == FLED2 || led->iout_joint) {\r\niout2_reg = max77693_led_iout_to_reg(iout[FLED2]);\r\nret = regmap_write(rmap, MAX77693_LED_REG_IFLASH2,\r\niout2_reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic int max77693_set_timeout(struct max77693_led_device *led, u32 microsec)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nu8 v;\r\nint ret;\r\nv = max77693_flash_timeout_to_reg(microsec) | FLASH_TMR_LEVEL;\r\nret = regmap_write(rmap, MAX77693_LED_REG_FLASH_TIMER, v);\r\nif (ret < 0)\r\nreturn ret;\r\nled->current_flash_timeout = microsec;\r\nreturn 0;\r\n}\r\nstatic int max77693_get_strobe_status(struct max77693_led_device *led,\r\nbool *state)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nunsigned int v;\r\nint ret;\r\nret = regmap_read(rmap, MAX77693_LED_REG_FLASH_STATUS, &v);\r\nif (ret < 0)\r\nreturn ret;\r\n*state = v & FLASH_STATUS_FLASH_ON;\r\nreturn ret;\r\n}\r\nstatic int max77693_get_flash_faults(struct max77693_sub_led *sub_led)\r\n{\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nstruct regmap *rmap = led->regmap;\r\nunsigned int v;\r\nu8 fault_open_mask, fault_short_mask;\r\nint ret;\r\nsub_led->flash_faults = 0;\r\nif (led->iout_joint) {\r\nfault_open_mask = FLASH_INT_FLED1_OPEN | FLASH_INT_FLED2_OPEN;\r\nfault_short_mask = FLASH_INT_FLED1_SHORT |\r\nFLASH_INT_FLED2_SHORT;\r\n} else {\r\nfault_open_mask = (sub_led->fled_id == FLED1) ?\r\nFLASH_INT_FLED1_OPEN :\r\nFLASH_INT_FLED2_OPEN;\r\nfault_short_mask = (sub_led->fled_id == FLED1) ?\r\nFLASH_INT_FLED1_SHORT :\r\nFLASH_INT_FLED2_SHORT;\r\n}\r\nret = regmap_read(rmap, MAX77693_LED_REG_FLASH_INT, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (v & fault_open_mask)\r\nsub_led->flash_faults |= LED_FAULT_OVER_VOLTAGE;\r\nif (v & fault_short_mask)\r\nsub_led->flash_faults |= LED_FAULT_SHORT_CIRCUIT;\r\nif (v & FLASH_INT_OVER_CURRENT)\r\nsub_led->flash_faults |= LED_FAULT_OVER_CURRENT;\r\nreturn 0;\r\n}\r\nstatic int max77693_setup(struct max77693_led_device *led,\r\nstruct max77693_led_config_data *led_cfg)\r\n{\r\nstruct regmap *rmap = led->regmap;\r\nint i, first_led, last_led, ret;\r\nu32 max_flash_curr[2];\r\nu8 v;\r\nif (led->iout_joint) {\r\nfirst_led = FLED1;\r\nlast_led = FLED1;\r\nmax_flash_curr[FLED1] = led_cfg->iout_flash_max[FLED1] +\r\nled_cfg->iout_flash_max[FLED2];\r\n} else {\r\nfirst_led = max77693_fled_used(led, FLED1) ? FLED1 : FLED2;\r\nlast_led = max77693_fled_used(led, FLED2) ? FLED2 : FLED1;\r\nmax_flash_curr[FLED1] = led_cfg->iout_flash_max[FLED1];\r\nmax_flash_curr[FLED2] = led_cfg->iout_flash_max[FLED2];\r\n}\r\nfor (i = first_led; i <= last_led; ++i) {\r\nret = max77693_set_flash_current(led, i,\r\nmax_flash_curr[i]);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nv = TORCH_TMR_NO_TIMER | MAX77693_LED_TRIG_TYPE_LEVEL;\r\nret = regmap_write(rmap, MAX77693_LED_REG_ITORCHTIMER, v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (led_cfg->low_vsys > 0)\r\nv = max77693_led_vsys_to_reg(led_cfg->low_vsys) |\r\nMAX_FLASH1_MAX_FL_EN;\r\nelse\r\nv = 0;\r\nret = regmap_write(rmap, MAX77693_LED_REG_MAX_FLASH1, v);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(rmap, MAX77693_LED_REG_MAX_FLASH2, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nif (led_cfg->boost_mode == MAX77693_LED_BOOST_FIXED)\r\nv = FLASH_BOOST_FIXED;\r\nelse\r\nv = led_cfg->boost_mode | led_cfg->boost_mode << 1;\r\nif (max77693_fled_used(led, FLED1) && max77693_fled_used(led, FLED2))\r\nv |= FLASH_BOOST_LEDNUM_2;\r\nret = regmap_write(rmap, MAX77693_LED_REG_VOUT_CNTL, v);\r\nif (ret < 0)\r\nreturn ret;\r\nv = max77693_led_vout_to_reg(led_cfg->boost_vout);\r\nret = regmap_write(rmap, MAX77693_LED_REG_VOUT_FLASH1, v);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn max77693_set_mode_reg(led, MODE_OFF);\r\n}\r\nstatic int max77693_led_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint fled_id = sub_led->fled_id, ret;\r\nmutex_lock(&led->lock);\r\nif (value == 0) {\r\nret = max77693_clear_mode(led, MODE_TORCH(fled_id));\r\nif (ret < 0)\r\ndev_dbg(&led->pdev->dev,\r\n"Failed to clear torch mode (%d)\n",\r\nret);\r\ngoto unlock;\r\n}\r\nret = max77693_set_torch_current(led, fled_id, value * TORCH_IOUT_STEP);\r\nif (ret < 0) {\r\ndev_dbg(&led->pdev->dev,\r\n"Failed to set torch current (%d)\n",\r\nret);\r\ngoto unlock;\r\n}\r\nret = max77693_add_mode(led, MODE_TORCH(fled_id));\r\nif (ret < 0)\r\ndev_dbg(&led->pdev->dev,\r\n"Failed to set torch mode (%d)\n",\r\nret);\r\nunlock:\r\nmutex_unlock(&led->lock);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_flash_brightness_set(\r\nstruct led_classdev_flash *fled_cdev,\r\nu32 brightness)\r\n{\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint ret;\r\nmutex_lock(&led->lock);\r\nret = max77693_set_flash_current(led, sub_led->fled_id, brightness);\r\nmutex_unlock(&led->lock);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_flash_strobe_set(\r\nstruct led_classdev_flash *fled_cdev,\r\nbool state)\r\n{\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint fled_id = sub_led->fled_id;\r\nint ret;\r\nmutex_lock(&led->lock);\r\nif (!state) {\r\nret = max77693_clear_mode(led, MODE_FLASH(fled_id));\r\ngoto unlock;\r\n}\r\nif (sub_led->flash_timeout != led->current_flash_timeout) {\r\nret = max77693_set_timeout(led, sub_led->flash_timeout);\r\nif (ret < 0)\r\ngoto unlock;\r\n}\r\nled->strobing_sub_led_id = fled_id;\r\nret = max77693_add_mode(led, MODE_FLASH(fled_id));\r\nif (ret < 0)\r\ngoto unlock;\r\nret = max77693_get_flash_faults(sub_led);\r\nunlock:\r\nmutex_unlock(&led->lock);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_flash_fault_get(\r\nstruct led_classdev_flash *fled_cdev,\r\nu32 *fault)\r\n{\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\n*fault = sub_led->flash_faults;\r\nreturn 0;\r\n}\r\nstatic int max77693_led_flash_strobe_get(\r\nstruct led_classdev_flash *fled_cdev,\r\nbool *state)\r\n{\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint ret;\r\nif (!state)\r\nreturn -EINVAL;\r\nmutex_lock(&led->lock);\r\nret = max77693_get_strobe_status(led, state);\r\n*state = !!(*state && (led->strobing_sub_led_id == sub_led->fled_id));\r\nmutex_unlock(&led->lock);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_flash_timeout_set(\r\nstruct led_classdev_flash *fled_cdev,\r\nu32 timeout)\r\n{\r\nstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nmutex_lock(&led->lock);\r\nsub_led->flash_timeout = timeout;\r\nmutex_unlock(&led->lock);\r\nreturn 0;\r\n}\r\nstatic int max77693_led_parse_dt(struct max77693_led_device *led,\r\nstruct max77693_led_config_data *cfg,\r\nstruct device_node **sub_nodes)\r\n{\r\nstruct device *dev = &led->pdev->dev;\r\nstruct max77693_sub_led *sub_leds = led->sub_leds;\r\nstruct device_node *node = dev->of_node, *child_node;\r\nstruct property *prop;\r\nu32 led_sources[2];\r\nint i, ret, fled_id;\r\nof_property_read_u32(node, "maxim,boost-mode", &cfg->boost_mode);\r\nof_property_read_u32(node, "maxim,boost-mvout", &cfg->boost_vout);\r\nof_property_read_u32(node, "maxim,mvsys-min", &cfg->low_vsys);\r\nfor_each_available_child_of_node(node, child_node) {\r\nprop = of_find_property(child_node, "led-sources", NULL);\r\nif (prop) {\r\nconst __be32 *srcs = NULL;\r\nfor (i = 0; i < ARRAY_SIZE(led_sources); ++i) {\r\nsrcs = of_prop_next_u32(prop, srcs,\r\n&led_sources[i]);\r\nif (!srcs)\r\nbreak;\r\n}\r\n} else {\r\ndev_err(dev,\r\n"led-sources DT property missing\n");\r\nof_node_put(child_node);\r\nreturn -EINVAL;\r\n}\r\nif (i == 2) {\r\nfled_id = FLED1;\r\nled->fled_mask = FLED1_IOUT | FLED2_IOUT;\r\n} else if (led_sources[0] == FLED1) {\r\nfled_id = FLED1;\r\nled->fled_mask |= FLED1_IOUT;\r\n} else if (led_sources[0] == FLED2) {\r\nfled_id = FLED2;\r\nled->fled_mask |= FLED2_IOUT;\r\n} else {\r\ndev_err(dev,\r\n"Wrong led-sources DT property value.\n");\r\nof_node_put(child_node);\r\nreturn -EINVAL;\r\n}\r\nif (sub_nodes[fled_id]) {\r\ndev_err(dev,\r\n"Conflicting \"led-sources\" DT properties\n");\r\nof_node_put(child_node);\r\nreturn -EINVAL;\r\n}\r\nsub_nodes[fled_id] = child_node;\r\nsub_leds[fled_id].fled_id = fled_id;\r\ncfg->label[fled_id] =\r\nof_get_property(child_node, "label", NULL) ? :\r\nchild_node->name;\r\nret = of_property_read_u32(child_node, "led-max-microamp",\r\n&cfg->iout_torch_max[fled_id]);\r\nif (ret < 0) {\r\ncfg->iout_torch_max[fled_id] = TORCH_IOUT_MIN;\r\ndev_warn(dev, "led-max-microamp DT property missing\n");\r\n}\r\nret = of_property_read_u32(child_node, "flash-max-microamp",\r\n&cfg->iout_flash_max[fled_id]);\r\nif (ret < 0) {\r\ncfg->iout_flash_max[fled_id] = FLASH_IOUT_MIN;\r\ndev_warn(dev,\r\n"flash-max-microamp DT property missing\n");\r\n}\r\nret = of_property_read_u32(child_node, "flash-max-timeout-us",\r\n&cfg->flash_timeout_max[fled_id]);\r\nif (ret < 0) {\r\ncfg->flash_timeout_max[fled_id] = FLASH_TIMEOUT_MIN;\r\ndev_warn(dev,\r\n"flash-max-timeout-us DT property missing\n");\r\n}\r\nif (++cfg->num_leds == 2 ||\r\n(max77693_fled_used(led, FLED1) &&\r\nmax77693_fled_used(led, FLED2))) {\r\nof_node_put(child_node);\r\nbreak;\r\n}\r\n}\r\nif (cfg->num_leds == 0) {\r\ndev_err(dev, "No DT child node found for connected LED(s).\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void clamp_align(u32 *v, u32 min, u32 max, u32 step)\r\n{\r\n*v = clamp_val(*v, min, max);\r\nif (step > 1)\r\n*v = (*v - min) / step * step + min;\r\n}\r\nstatic void max77693_align_iout_current(struct max77693_led_device *led,\r\nu32 *iout, u32 min, u32 max, u32 step)\r\n{\r\nint i;\r\nif (led->iout_joint) {\r\nif (iout[FLED1] > min) {\r\niout[FLED1] /= 2;\r\niout[FLED2] = iout[FLED1];\r\n} else {\r\niout[FLED1] = min;\r\niout[FLED2] = 0;\r\nreturn;\r\n}\r\n}\r\nfor (i = FLED1; i <= FLED2; ++i)\r\nif (max77693_fled_used(led, i))\r\nclamp_align(&iout[i], min, max, step);\r\nelse\r\niout[i] = 0;\r\n}\r\nstatic void max77693_led_validate_configuration(struct max77693_led_device *led,\r\nstruct max77693_led_config_data *cfg)\r\n{\r\nu32 flash_iout_max = cfg->boost_mode ? FLASH_IOUT_MAX_2LEDS :\r\nFLASH_IOUT_MAX_1LED;\r\nint i;\r\nif (cfg->num_leds == 1 &&\r\nmax77693_fled_used(led, FLED1) && max77693_fled_used(led, FLED2))\r\nled->iout_joint = true;\r\ncfg->boost_mode = clamp_val(cfg->boost_mode, MAX77693_LED_BOOST_NONE,\r\nMAX77693_LED_BOOST_FIXED);\r\nif ((cfg->boost_mode == MAX77693_LED_BOOST_NONE) && led->iout_joint)\r\ncfg->boost_mode = MAX77693_LED_BOOST_FIXED;\r\nmax77693_align_iout_current(led, cfg->iout_torch_max,\r\nTORCH_IOUT_MIN, TORCH_IOUT_MAX, TORCH_IOUT_STEP);\r\nmax77693_align_iout_current(led, cfg->iout_flash_max,\r\nFLASH_IOUT_MIN, flash_iout_max, FLASH_IOUT_STEP);\r\nfor (i = 0; i < ARRAY_SIZE(cfg->flash_timeout_max); ++i)\r\nclamp_align(&cfg->flash_timeout_max[i], FLASH_TIMEOUT_MIN,\r\nFLASH_TIMEOUT_MAX, FLASH_TIMEOUT_STEP);\r\nclamp_align(&cfg->boost_vout, FLASH_VOUT_MIN, FLASH_VOUT_MAX,\r\nFLASH_VOUT_STEP);\r\nif (cfg->low_vsys)\r\nclamp_align(&cfg->low_vsys, MAX_FLASH1_VSYS_MIN,\r\nMAX_FLASH1_VSYS_MAX, MAX_FLASH1_VSYS_STEP);\r\n}\r\nstatic int max77693_led_get_configuration(struct max77693_led_device *led,\r\nstruct max77693_led_config_data *cfg,\r\nstruct device_node **sub_nodes)\r\n{\r\nint ret;\r\nret = max77693_led_parse_dt(led, cfg, sub_nodes);\r\nif (ret < 0)\r\nreturn ret;\r\nmax77693_led_validate_configuration(led, cfg);\r\nmemcpy(led->iout_torch_max, cfg->iout_torch_max,\r\nsizeof(led->iout_torch_max));\r\nmemcpy(led->iout_flash_max, cfg->iout_flash_max,\r\nsizeof(led->iout_flash_max));\r\nreturn 0;\r\n}\r\nstatic void max77693_init_flash_settings(struct max77693_sub_led *sub_led,\r\nstruct max77693_led_config_data *led_cfg)\r\n{\r\nstruct led_classdev_flash *fled_cdev = &sub_led->fled_cdev;\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint fled_id = sub_led->fled_id;\r\nstruct led_flash_setting *setting;\r\nsetting = &fled_cdev->brightness;\r\nsetting->min = FLASH_IOUT_MIN;\r\nsetting->max = led->iout_joint ?\r\nled_cfg->iout_flash_max[FLED1] +\r\nled_cfg->iout_flash_max[FLED2] :\r\nled_cfg->iout_flash_max[fled_id];\r\nsetting->step = FLASH_IOUT_STEP;\r\nsetting->val = setting->max;\r\nsetting = &fled_cdev->timeout;\r\nsetting->min = FLASH_TIMEOUT_MIN;\r\nsetting->max = led_cfg->flash_timeout_max[fled_id];\r\nsetting->step = FLASH_TIMEOUT_STEP;\r\nsetting->val = setting->max;\r\n}\r\nstatic int max77693_led_external_strobe_set(\r\nstruct v4l2_flash *v4l2_flash,\r\nbool enable)\r\n{\r\nstruct max77693_sub_led *sub_led =\r\nflcdev_to_sub_led(v4l2_flash->fled_cdev);\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint fled_id = sub_led->fled_id;\r\nint ret;\r\nmutex_lock(&led->lock);\r\nif (enable)\r\nret = max77693_add_mode(led, MODE_FLASH_EXTERNAL(fled_id));\r\nelse\r\nret = max77693_clear_mode(led, MODE_FLASH_EXTERNAL(fled_id));\r\nmutex_unlock(&led->lock);\r\nreturn ret;\r\n}\r\nstatic void max77693_init_v4l2_flash_config(struct max77693_sub_led *sub_led,\r\nstruct max77693_led_config_data *led_cfg,\r\nstruct v4l2_flash_config *v4l2_sd_cfg)\r\n{\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nstruct device *dev = &led->pdev->dev;\r\nstruct max77693_dev *iodev = dev_get_drvdata(dev->parent);\r\nstruct i2c_client *i2c = iodev->i2c;\r\nstruct led_flash_setting *s;\r\nsnprintf(v4l2_sd_cfg->dev_name, sizeof(v4l2_sd_cfg->dev_name),\r\n"%s %d-%04x", sub_led->fled_cdev.led_cdev.name,\r\ni2c_adapter_id(i2c->adapter), i2c->addr);\r\ns = &v4l2_sd_cfg->torch_intensity;\r\ns->min = TORCH_IOUT_MIN;\r\ns->max = sub_led->fled_cdev.led_cdev.max_brightness * TORCH_IOUT_STEP;\r\ns->step = TORCH_IOUT_STEP;\r\ns->val = s->max;\r\nv4l2_sd_cfg->flash_faults = LED_FAULT_OVER_VOLTAGE |\r\nLED_FAULT_SHORT_CIRCUIT |\r\nLED_FAULT_OVER_CURRENT;\r\nv4l2_sd_cfg->has_external_strobe = true;\r\n}\r\nstatic inline void max77693_init_v4l2_flash_config(\r\nstruct max77693_sub_led *sub_led,\r\nstruct max77693_led_config_data *led_cfg,\r\nstruct v4l2_flash_config *v4l2_sd_cfg)\r\n{\r\n}\r\nstatic void max77693_init_fled_cdev(struct max77693_sub_led *sub_led,\r\nstruct max77693_led_config_data *led_cfg)\r\n{\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nint fled_id = sub_led->fled_id;\r\nstruct led_classdev_flash *fled_cdev;\r\nstruct led_classdev *led_cdev;\r\nfled_cdev = &sub_led->fled_cdev;\r\nfled_cdev->ops = &flash_ops;\r\nled_cdev = &fled_cdev->led_cdev;\r\nled_cdev->name = led_cfg->label[fled_id];\r\nled_cdev->brightness_set_blocking = max77693_led_brightness_set;\r\nled_cdev->max_brightness = (led->iout_joint ?\r\nled_cfg->iout_torch_max[FLED1] +\r\nled_cfg->iout_torch_max[FLED2] :\r\nled_cfg->iout_torch_max[fled_id]) /\r\nTORCH_IOUT_STEP;\r\nled_cdev->flags |= LED_DEV_CAP_FLASH;\r\nmax77693_init_flash_settings(sub_led, led_cfg);\r\nsub_led->flash_timeout = fled_cdev->timeout.val;\r\n}\r\nstatic int max77693_register_led(struct max77693_sub_led *sub_led,\r\nstruct max77693_led_config_data *led_cfg,\r\nstruct device_node *sub_node)\r\n{\r\nstruct max77693_led_device *led = sub_led_to_led(sub_led);\r\nstruct led_classdev_flash *fled_cdev = &sub_led->fled_cdev;\r\nstruct device *dev = &led->pdev->dev;\r\nstruct v4l2_flash_config v4l2_sd_cfg = {};\r\nint ret;\r\nret = led_classdev_flash_register(dev, fled_cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nmax77693_init_v4l2_flash_config(sub_led, led_cfg, &v4l2_sd_cfg);\r\nsub_led->v4l2_flash = v4l2_flash_init(dev, sub_node, fled_cdev, NULL,\r\n&v4l2_flash_ops, &v4l2_sd_cfg);\r\nif (IS_ERR(sub_led->v4l2_flash)) {\r\nret = PTR_ERR(sub_led->v4l2_flash);\r\ngoto err_v4l2_flash_init;\r\n}\r\nreturn 0;\r\nerr_v4l2_flash_init:\r\nled_classdev_flash_unregister(fled_cdev);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct max77693_dev *iodev = dev_get_drvdata(dev->parent);\r\nstruct max77693_led_device *led;\r\nstruct max77693_sub_led *sub_leds;\r\nstruct device_node *sub_nodes[2] = {};\r\nstruct max77693_led_config_data led_cfg = {};\r\nint init_fled_cdev[2], i, ret;\r\nled = devm_kzalloc(dev, sizeof(*led), GFP_KERNEL);\r\nif (!led)\r\nreturn -ENOMEM;\r\nled->pdev = pdev;\r\nled->regmap = iodev->regmap;\r\nled->allowed_modes = MODE_FLASH_MASK;\r\nsub_leds = led->sub_leds;\r\nplatform_set_drvdata(pdev, led);\r\nret = max77693_led_get_configuration(led, &led_cfg, sub_nodes);\r\nif (ret < 0)\r\nreturn ret;\r\nret = max77693_setup(led, &led_cfg);\r\nif (ret < 0)\r\nreturn ret;\r\nmutex_init(&led->lock);\r\ninit_fled_cdev[FLED1] =\r\nled->iout_joint || max77693_fled_used(led, FLED1);\r\ninit_fled_cdev[FLED2] =\r\n!led->iout_joint && max77693_fled_used(led, FLED2);\r\nfor (i = FLED1; i <= FLED2; ++i) {\r\nif (!init_fled_cdev[i])\r\ncontinue;\r\nmax77693_init_fled_cdev(&sub_leds[i], &led_cfg);\r\nret = max77693_register_led(&sub_leds[i], &led_cfg,\r\nsub_nodes[i]);\r\nif (ret < 0) {\r\nif (i == FLED2)\r\ngoto err_register_led2;\r\nelse\r\ngoto err_register_led1;\r\n}\r\n}\r\nreturn 0;\r\nerr_register_led2:\r\nif (!init_fled_cdev[FLED1])\r\ngoto err_register_led1;\r\nv4l2_flash_release(sub_leds[FLED1].v4l2_flash);\r\nled_classdev_flash_unregister(&sub_leds[FLED1].fled_cdev);\r\nerr_register_led1:\r\nmutex_destroy(&led->lock);\r\nreturn ret;\r\n}\r\nstatic int max77693_led_remove(struct platform_device *pdev)\r\n{\r\nstruct max77693_led_device *led = platform_get_drvdata(pdev);\r\nstruct max77693_sub_led *sub_leds = led->sub_leds;\r\nif (led->iout_joint || max77693_fled_used(led, FLED1)) {\r\nv4l2_flash_release(sub_leds[FLED1].v4l2_flash);\r\nled_classdev_flash_unregister(&sub_leds[FLED1].fled_cdev);\r\n}\r\nif (!led->iout_joint && max77693_fled_used(led, FLED2)) {\r\nv4l2_flash_release(sub_leds[FLED2].v4l2_flash);\r\nled_classdev_flash_unregister(&sub_leds[FLED2].fled_cdev);\r\n}\r\nmutex_destroy(&led->lock);\r\nreturn 0;\r\n}

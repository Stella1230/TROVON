int\r\nsvc_authenticate(struct svc_rqst *rqstp, __be32 *authp)\r\n{\r\nrpc_authflavor_t flavor;\r\nstruct auth_ops *aops;\r\n*authp = rpc_auth_ok;\r\nflavor = svc_getnl(&rqstp->rq_arg.head[0]);\r\ndprintk("svc: svc_authenticate (%d)\n", flavor);\r\nspin_lock(&authtab_lock);\r\nif (flavor >= RPC_AUTH_MAXFLAVOR || !(aops = authtab[flavor]) ||\r\n!try_module_get(aops->owner)) {\r\nspin_unlock(&authtab_lock);\r\n*authp = rpc_autherr_badcred;\r\nreturn SVC_DENIED;\r\n}\r\nspin_unlock(&authtab_lock);\r\nrqstp->rq_auth_slack = 0;\r\ninit_svc_cred(&rqstp->rq_cred);\r\nrqstp->rq_authop = aops;\r\nreturn aops->accept(rqstp, authp);\r\n}\r\nint svc_set_client(struct svc_rqst *rqstp)\r\n{\r\nrqstp->rq_client = NULL;\r\nreturn rqstp->rq_authop->set_client(rqstp);\r\n}\r\nint svc_authorise(struct svc_rqst *rqstp)\r\n{\r\nstruct auth_ops *aops = rqstp->rq_authop;\r\nint rv = 0;\r\nrqstp->rq_authop = NULL;\r\nif (aops) {\r\nrv = aops->release(rqstp);\r\nmodule_put(aops->owner);\r\n}\r\nreturn rv;\r\n}\r\nint\r\nsvc_auth_register(rpc_authflavor_t flavor, struct auth_ops *aops)\r\n{\r\nint rv = -EINVAL;\r\nspin_lock(&authtab_lock);\r\nif (flavor < RPC_AUTH_MAXFLAVOR && authtab[flavor] == NULL) {\r\nauthtab[flavor] = aops;\r\nrv = 0;\r\n}\r\nspin_unlock(&authtab_lock);\r\nreturn rv;\r\n}\r\nvoid\r\nsvc_auth_unregister(rpc_authflavor_t flavor)\r\n{\r\nspin_lock(&authtab_lock);\r\nif (flavor < RPC_AUTH_MAXFLAVOR)\r\nauthtab[flavor] = NULL;\r\nspin_unlock(&authtab_lock);\r\n}\r\nvoid auth_domain_put(struct auth_domain *dom)\r\n{\r\nif (atomic_dec_and_lock(&dom->ref.refcount, &auth_domain_lock)) {\r\nhlist_del(&dom->hash);\r\ndom->flavour->domain_release(dom);\r\nspin_unlock(&auth_domain_lock);\r\n}\r\n}\r\nstruct auth_domain *\r\nauth_domain_lookup(char *name, struct auth_domain *new)\r\n{\r\nstruct auth_domain *hp;\r\nstruct hlist_head *head;\r\nhead = &auth_domain_table[hash_str(name, DN_HASHBITS)];\r\nspin_lock(&auth_domain_lock);\r\nhlist_for_each_entry(hp, head, hash) {\r\nif (strcmp(hp->name, name)==0) {\r\nkref_get(&hp->ref);\r\nspin_unlock(&auth_domain_lock);\r\nreturn hp;\r\n}\r\n}\r\nif (new)\r\nhlist_add_head(&new->hash, head);\r\nspin_unlock(&auth_domain_lock);\r\nreturn new;\r\n}\r\nstruct auth_domain *auth_domain_find(char *name)\r\n{\r\nreturn auth_domain_lookup(name, NULL);\r\n}

static int __init declare_of_platform_devices(void)\r\n{\r\nof_platform_bus_probe(NULL, of_bus_ids, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init linkstation_add_bridge(struct device_node *dev)\r\n{\r\n#ifdef CONFIG_PCI\r\nint len;\r\nstruct pci_controller *hose;\r\nconst int *bus_range;\r\nprintk("Adding PCI host bridge %s\n", dev->full_name);\r\nbus_range = of_get_property(dev, "bus-range", &len);\r\nif (bus_range == NULL || len < 2 * sizeof(int))\r\nprintk(KERN_WARNING "Can't get bus-range for %s, assume"\r\n" bus 0\n", dev->full_name);\r\nhose = pcibios_alloc_controller(dev);\r\nif (hose == NULL)\r\nreturn -ENOMEM;\r\nhose->first_busno = bus_range ? bus_range[0] : 0;\r\nhose->last_busno = bus_range ? bus_range[1] : 0xff;\r\nsetup_indirect_pci(hose, 0xfec00000, 0xfee00000, 0);\r\npci_process_bridge_OF_ranges(hose, dev, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __init linkstation_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_compatible_node(np, "pci", "mpc10x-pci")\r\nlinkstation_add_bridge(np);\r\nprintk(KERN_INFO "BUFFALO Network Attached Storage Series\n");\r\nprintk(KERN_INFO "(C) 2002-2005 BUFFALO INC.\n");\r\n}\r\nstatic void __init linkstation_init_IRQ(void)\r\n{\r\nstruct mpic *mpic;\r\nmpic = mpic_alloc(NULL, 0, 0, 4, 0, " EPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_assign_isu(mpic, 0, mpic->paddr + 0x10200);\r\nmpic_assign_isu(mpic, 1, mpic->paddr + 0x11000);\r\nmpic_assign_isu(mpic, 2, mpic->paddr + 0x11100);\r\nmpic_init(mpic);\r\n}\r\nstatic void linkstation_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\navr_uart_configure();\r\navr_uart_send('C');\r\nfor(;;)\r\navr_uart_send('G');\r\n}\r\nstatic void linkstation_power_off(void)\r\n{\r\nlocal_irq_disable();\r\navr_uart_configure();\r\navr_uart_send('E');\r\nfor(;;)\r\navr_uart_send('G');\r\n}\r\nstatic void linkstation_halt(void)\r\n{\r\nlinkstation_power_off();\r\n}\r\nstatic void linkstation_show_cpuinfo(struct seq_file *m)\r\n{\r\nseq_printf(m, "vendor\t\t: Buffalo Technology\n");\r\nseq_printf(m, "machine\t\t: Linkstation I/Kurobox(HG)\n");\r\n}\r\nstatic int __init linkstation_probe(void)\r\n{\r\nunsigned long root;\r\nroot = of_get_flat_dt_root();\r\nif (!of_flat_dt_is_compatible(root, "linkstation"))\r\nreturn 0;\r\npm_power_off = linkstation_power_off;\r\nreturn 1;\r\n}

static char *\r\n__demangle_java_sym(const char *str, const char *end, char *buf, int maxlen, int mode)\r\n{\r\nint rlen = 0;\r\nint array = 0;\r\nint narg = 0;\r\nconst char *q;\r\nif (!end)\r\nend = str + strlen(str);\r\nfor (q = str; q != end; q++) {\r\nif (rlen == (maxlen - 1))\r\nbreak;\r\nswitch (*q) {\r\ncase 'L':\r\nif (mode == MODE_PREFIX || mode == MODE_CTYPE) {\r\nif (mode == MODE_CTYPE) {\r\nif (narg)\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, ", ");\r\nnarg++;\r\n}\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, "class ");\r\nif (mode == MODE_PREFIX)\r\nmode = MODE_CLASS;\r\n} else\r\nbuf[rlen++] = *q;\r\nbreak;\r\ncase 'B':\r\ncase 'C':\r\ncase 'D':\r\ncase 'F':\r\ncase 'I':\r\ncase 'J':\r\ncase 'S':\r\ncase 'Z':\r\nif (mode == MODE_TYPE) {\r\nif (narg)\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, ", ");\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, "%s", base_types[*q - 'A']);\r\nwhile (array--)\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, "[]");\r\narray = 0;\r\nnarg++;\r\n} else\r\nbuf[rlen++] = *q;\r\nbreak;\r\ncase 'V':\r\nif (mode == MODE_TYPE) {\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, "void");\r\nwhile (array--)\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, "[]");\r\narray = 0;\r\n} else\r\nbuf[rlen++] = *q;\r\nbreak;\r\ncase '[':\r\nif (mode != MODE_TYPE)\r\ngoto error;\r\narray++;\r\nbreak;\r\ncase '(':\r\nif (mode != MODE_FUNC)\r\ngoto error;\r\nbuf[rlen++] = *q;\r\nmode = MODE_TYPE;\r\nbreak;\r\ncase ')':\r\nif (mode != MODE_TYPE)\r\ngoto error;\r\nbuf[rlen++] = *q;\r\nnarg = 0;\r\nbreak;\r\ncase ';':\r\nif (mode != MODE_CLASS && mode != MODE_CTYPE)\r\ngoto error;\r\nif (isalpha(*(q + 1)))\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, ".");\r\nif (mode == MODE_CLASS)\r\nmode = MODE_FUNC;\r\nelse if (mode == MODE_CTYPE)\r\nmode = MODE_TYPE;\r\nbreak;\r\ncase '/':\r\nif (mode != MODE_CLASS && mode != MODE_CTYPE)\r\ngoto error;\r\nrlen += scnprintf(buf + rlen, maxlen - rlen, ".");\r\nbreak;\r\ndefault :\r\nbuf[rlen++] = *q;\r\n}\r\n}\r\nbuf[rlen] = '\0';\r\nreturn buf;\r\nerror:\r\nreturn NULL;\r\n}\r\nchar *\r\njava_demangle_sym(const char *str, int flags)\r\n{\r\nchar *buf, *ptr;\r\nchar *p;\r\nsize_t len, l1 = 0;\r\nif (!str)\r\nreturn NULL;\r\np = strrchr(str, ')');\r\nif (!p)\r\nreturn NULL;\r\nlen = strlen(str) * 3 + 1;\r\nbuf = malloc(len);\r\nif (!buf)\r\nreturn NULL;\r\nbuf[0] = '\0';\r\nif (!(flags & JAVA_DEMANGLE_NORET)) {\r\nptr = __demangle_java_sym(p + 1, NULL, buf, len, MODE_TYPE);\r\nif (!ptr)\r\ngoto error;\r\nl1 = strlen(buf);\r\nbuf[l1++] = ' ';\r\n}\r\nptr = __demangle_java_sym(str, p + 1, buf + l1, len - l1, MODE_PREFIX);\r\nif (!ptr)\r\ngoto error;\r\nreturn buf;\r\nerror:\r\nfree(buf);\r\nreturn NULL;\r\n}

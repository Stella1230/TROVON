mpi_limb_t\r\nmpihelp_divrem(mpi_ptr_t qp, mpi_size_t qextra_limbs,\r\nmpi_ptr_t np, mpi_size_t nsize, mpi_ptr_t dp, mpi_size_t dsize)\r\n{\r\nmpi_limb_t most_significant_q_limb = 0;\r\nswitch (dsize) {\r\ncase 0:\r\nreturn 1 / dsize;\r\ncase 1:\r\n{\r\nmpi_size_t i;\r\nmpi_limb_t n1;\r\nmpi_limb_t d;\r\nd = dp[0];\r\nn1 = np[nsize - 1];\r\nif (n1 >= d) {\r\nn1 -= d;\r\nmost_significant_q_limb = 1;\r\n}\r\nqp += qextra_limbs;\r\nfor (i = nsize - 2; i >= 0; i--)\r\nudiv_qrnnd(qp[i], n1, n1, np[i], d);\r\nqp -= qextra_limbs;\r\nfor (i = qextra_limbs - 1; i >= 0; i--)\r\nudiv_qrnnd(qp[i], n1, n1, 0, d);\r\nnp[0] = n1;\r\n}\r\nbreak;\r\ncase 2:\r\n{\r\nmpi_size_t i;\r\nmpi_limb_t n1, n0, n2;\r\nmpi_limb_t d1, d0;\r\nnp += nsize - 2;\r\nd1 = dp[1];\r\nd0 = dp[0];\r\nn1 = np[1];\r\nn0 = np[0];\r\nif (n1 >= d1 && (n1 > d1 || n0 >= d0)) {\r\nsub_ddmmss(n1, n0, n1, n0, d1, d0);\r\nmost_significant_q_limb = 1;\r\n}\r\nfor (i = qextra_limbs + nsize - 2 - 1; i >= 0; i--) {\r\nmpi_limb_t q;\r\nmpi_limb_t r;\r\nif (i >= qextra_limbs)\r\nnp--;\r\nelse\r\nnp[0] = 0;\r\nif (n1 == d1) {\r\nq = ~(mpi_limb_t) 0;\r\nr = n0 + d1;\r\nif (r < d1) {\r\nadd_ssaaaa(n1, n0, r - d0,\r\nnp[0], 0, d0);\r\nqp[i] = q;\r\ncontinue;\r\n}\r\nn1 = d0 - (d0 != 0 ? 1 : 0);\r\nn0 = -d0;\r\n} else {\r\nudiv_qrnnd(q, r, n1, n0, d1);\r\numul_ppmm(n1, n0, d0, q);\r\n}\r\nn2 = np[0];\r\nq_test:\r\nif (n1 > r || (n1 == r && n0 > n2)) {\r\nq--;\r\nsub_ddmmss(n1, n0, n1, n0, 0, d0);\r\nr += d1;\r\nif (r >= d1)\r\ngoto q_test;\r\n}\r\nqp[i] = q;\r\nsub_ddmmss(n1, n0, r, n2, n1, n0);\r\n}\r\nnp[1] = n1;\r\nnp[0] = n0;\r\n}\r\nbreak;\r\ndefault:\r\n{\r\nmpi_size_t i;\r\nmpi_limb_t dX, d1, n0;\r\nnp += nsize - dsize;\r\ndX = dp[dsize - 1];\r\nd1 = dp[dsize - 2];\r\nn0 = np[dsize - 1];\r\nif (n0 >= dX) {\r\nif (n0 > dX\r\n|| mpihelp_cmp(np, dp, dsize - 1) >= 0) {\r\nmpihelp_sub_n(np, np, dp, dsize);\r\nn0 = np[dsize - 1];\r\nmost_significant_q_limb = 1;\r\n}\r\n}\r\nfor (i = qextra_limbs + nsize - dsize - 1; i >= 0; i--) {\r\nmpi_limb_t q;\r\nmpi_limb_t n1, n2;\r\nmpi_limb_t cy_limb;\r\nif (i >= qextra_limbs) {\r\nnp--;\r\nn2 = np[dsize];\r\n} else {\r\nn2 = np[dsize - 1];\r\nMPN_COPY_DECR(np + 1, np, dsize - 1);\r\nnp[0] = 0;\r\n}\r\nif (n0 == dX) {\r\nq = ~(mpi_limb_t) 0;\r\n} else {\r\nmpi_limb_t r;\r\nudiv_qrnnd(q, r, n0, np[dsize - 1], dX);\r\numul_ppmm(n1, n0, d1, q);\r\nwhile (n1 > r\r\n|| (n1 == r\r\n&& n0 > np[dsize - 2])) {\r\nq--;\r\nr += dX;\r\nif (r < dX)\r\nbreak;\r\nn1 -= n0 < d1;\r\nn0 -= d1;\r\n}\r\n}\r\ncy_limb = mpihelp_submul_1(np, dp, dsize, q);\r\nif (n2 != cy_limb) {\r\nmpihelp_add_n(np, np, dp, dsize);\r\nq--;\r\n}\r\nqp[i] = q;\r\nn0 = np[dsize - 1];\r\n}\r\n}\r\n}\r\nreturn most_significant_q_limb;\r\n}

unsigned int get_dcache_size(void)\r\n{\r\nunsigned int config2 = metag_in32(METAC_CORE_CONFIG2);\r\nunsigned int sz = 0x1000 << ((config2 & METAC_CORECFG2_DCSZ_BITS)\r\n>> METAC_CORECFG2_DCSZ_S);\r\nif (config2 & METAC_CORECFG2_DCSMALL_BIT)\r\nsz >>= 6;\r\nreturn sz;\r\n}\r\nunsigned int get_icache_size(void)\r\n{\r\nunsigned int config2 = metag_in32(METAC_CORE_CONFIG2);\r\nunsigned int sz = 0x1000 << ((config2 & METAC_CORE_C2ICSZ_BITS)\r\n>> METAC_CORE_C2ICSZ_S);\r\nif (config2 & METAC_CORECFG2_ICSMALL_BIT)\r\nsz >>= 6;\r\nreturn sz;\r\n}\r\nunsigned int get_global_dcache_size(void)\r\n{\r\nunsigned int cpart = metag_in32(SYSC_DCPART(hard_processor_id()));\r\nunsigned int temp = cpart & SYSC_xCPARTG_AND_BITS;\r\nreturn (get_dcache_size() * ((temp >> SYSC_xCPARTG_AND_S) + 1)) >> 4;\r\n}\r\nunsigned int get_global_icache_size(void)\r\n{\r\nunsigned int cpart = metag_in32(SYSC_ICPART(hard_processor_id()));\r\nunsigned int temp = cpart & SYSC_xCPARTG_AND_BITS;\r\nreturn (get_icache_size() * ((temp >> SYSC_xCPARTG_AND_S) + 1)) >> 4;\r\n}\r\nstatic int get_thread_cache_size(unsigned int cache, int thread_id)\r\n{\r\nunsigned int cache_size;\r\nunsigned int t_cache_part;\r\nunsigned int isEnabled;\r\nunsigned int offset = 0;\r\nisEnabled = (cache == DCACHE ? metag_in32(MMCU_DCACHE_CTRL_ADDR) & 0x1 :\r\nmetag_in32(MMCU_ICACHE_CTRL_ADDR) & 0x1);\r\nif (!isEnabled)\r\nreturn 0;\r\n#if PAGE_OFFSET >= LINGLOBAL_BASE\r\ncache_size = (cache == DCACHE ? get_global_dcache_size() :\r\nget_global_icache_size());\r\noffset = 8;\r\n#else\r\ncache_size = (cache == DCACHE ? get_dcache_size() :\r\nget_icache_size());\r\n#endif\r\nt_cache_part = (cache == DCACHE ?\r\n(metag_in32(SYSC_DCPART(thread_id)) >> offset) & 0xF :\r\n(metag_in32(SYSC_ICPART(thread_id)) >> offset) & 0xF);\r\nswitch (t_cache_part) {\r\ncase 0xF:\r\nreturn cache_size;\r\ncase 0x7:\r\nreturn cache_size / 2;\r\ncase 0x3:\r\nreturn cache_size / 4;\r\ncase 0x1:\r\nreturn cache_size / 8;\r\ncase 0:\r\nreturn cache_size / 16;\r\n}\r\nreturn -1;\r\n}\r\nvoid check_for_cache_aliasing(int thread_id)\r\n{\r\nint thread_cache_size;\r\nunsigned int cache_type;\r\nfor (cache_type = ICACHE; cache_type <= DCACHE; cache_type++) {\r\nthread_cache_size =\r\nget_thread_cache_size(cache_type, thread_id);\r\nif (thread_cache_size < 0)\r\npr_emerg("Can't read %s cache size\n",\r\ncache_type ? "DCACHE" : "ICACHE");\r\nelse if (thread_cache_size == 0)\r\ncontinue;\r\nif (thread_cache_size / CACHE_ASSOCIATIVITY > PAGE_SIZE) {\r\npr_emerg("Potential cache aliasing detected in %s on Thread %d\n",\r\ncache_type ? "DCACHE" : "ICACHE", thread_id);\r\npr_warn("Total %s size: %u bytes\n",\r\ncache_type ? "DCACHE" : "ICACHE",\r\ncache_type ? get_dcache_size()\r\n: get_icache_size());\r\npr_warn("Thread %s size: %d bytes\n",\r\ncache_type ? "CACHE" : "ICACHE",\r\nthread_cache_size);\r\npr_warn("Page Size: %lu bytes\n", PAGE_SIZE);\r\npanic("Potential cache aliasing detected");\r\n}\r\n}\r\n}\r\nvoid check_for_cache_aliasing(int thread_id)\r\n{\r\nreturn;\r\n}

static u8 fuse_readb(struct tegra_fuse *fuse, unsigned int offset)\r\n{\r\nu32 val;\r\nval = fuse->read(fuse, round_down(offset, 4));\r\nval >>= (offset % 4) * 8;\r\nval &= 0xff;\r\nreturn val;\r\n}\r\nstatic ssize_t fuse_read(struct file *fd, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t pos, size_t size)\r\n{\r\nstruct device *dev = kobj_to_dev(kobj);\r\nstruct tegra_fuse *fuse = dev_get_drvdata(dev);\r\nint i;\r\nif (pos < 0 || pos >= attr->size)\r\nreturn 0;\r\nif (size > attr->size - pos)\r\nsize = attr->size - pos;\r\nfor (i = 0; i < size; i++)\r\nbuf[i] = fuse_readb(fuse, pos + i);\r\nreturn i;\r\n}\r\nstatic int tegra_fuse_create_sysfs(struct device *dev, unsigned int size,\r\nconst struct tegra_fuse_info *info)\r\n{\r\nfuse_bin_attr.size = size;\r\nreturn device_create_bin_file(dev, &fuse_bin_attr);\r\n}\r\nstatic int tegra_fuse_probe(struct platform_device *pdev)\r\n{\r\nvoid __iomem *base = fuse->base;\r\nstruct resource *res;\r\nint err;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nfuse->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(fuse->base))\r\nreturn PTR_ERR(fuse->base);\r\nfuse->clk = devm_clk_get(&pdev->dev, "fuse");\r\nif (IS_ERR(fuse->clk)) {\r\ndev_err(&pdev->dev, "failed to get FUSE clock: %ld",\r\nPTR_ERR(fuse->clk));\r\nreturn PTR_ERR(fuse->clk);\r\n}\r\nplatform_set_drvdata(pdev, fuse);\r\nfuse->dev = &pdev->dev;\r\nif (fuse->soc->probe) {\r\nerr = fuse->soc->probe(fuse);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (tegra_fuse_create_sysfs(&pdev->dev, fuse->soc->info->size,\r\nfuse->soc->info))\r\nreturn -ENODEV;\r\niounmap(base);\r\nreturn 0;\r\n}\r\nbool __init tegra_fuse_read_spare(unsigned int spare)\r\n{\r\nunsigned int offset = fuse->soc->info->spare + spare * 4;\r\nreturn fuse->read_early(fuse, offset) & 1;\r\n}\r\nu32 __init tegra_fuse_read_early(unsigned int offset)\r\n{\r\nreturn fuse->read_early(fuse, offset);\r\n}\r\nint tegra_fuse_readl(unsigned long offset, u32 *value)\r\n{\r\nif (!fuse->read)\r\nreturn -EPROBE_DEFER;\r\n*value = fuse->read(fuse, offset);\r\nreturn 0;\r\n}\r\nstatic void tegra_enable_fuse_clk(void __iomem *base)\r\n{\r\nu32 reg;\r\nreg = readl_relaxed(base + 0x48);\r\nreg |= 1 << 28;\r\nwritel(reg, base + 0x48);\r\nreg = readl(base + 0x14);\r\nreg |= 1 << 7;\r\nwritel(reg, base + 0x14);\r\n}\r\nstatic int __init tegra_init_fuse(void)\r\n{\r\nconst struct of_device_id *match;\r\nstruct device_node *np;\r\nstruct resource regs;\r\ntegra_init_apbmisc();\r\nnp = of_find_matching_node_and_match(NULL, tegra_fuse_match, &match);\r\nif (!np) {\r\nif (IS_ENABLED(CONFIG_ARM) && soc_is_tegra()) {\r\nu8 chip = tegra_get_chip_id();\r\nregs.start = 0x7000f800;\r\nregs.end = 0x7000fbff;\r\nregs.flags = IORESOURCE_MEM;\r\nswitch (chip) {\r\n#ifdef CONFIG_ARCH_TEGRA_2x_SOC\r\ncase TEGRA20:\r\nfuse->soc = &tegra20_fuse_soc;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ARCH_TEGRA_3x_SOC\r\ncase TEGRA30:\r\nfuse->soc = &tegra30_fuse_soc;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ARCH_TEGRA_114_SOC\r\ncase TEGRA114:\r\nfuse->soc = &tegra114_fuse_soc;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ARCH_TEGRA_124_SOC\r\ncase TEGRA124:\r\nfuse->soc = &tegra124_fuse_soc;\r\nbreak;\r\n#endif\r\ndefault:\r\npr_warn("Unsupported SoC: %02x\n", chip);\r\nbreak;\r\n}\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\nif (of_address_to_resource(np, 0, &regs) < 0) {\r\npr_err("failed to get FUSE register\n");\r\nreturn -ENXIO;\r\n}\r\nfuse->soc = match->data;\r\n}\r\nnp = of_find_matching_node(NULL, car_match);\r\nif (np) {\r\nvoid __iomem *base = of_iomap(np, 0);\r\nif (base) {\r\ntegra_enable_fuse_clk(base);\r\niounmap(base);\r\n} else {\r\npr_err("failed to map clock registers\n");\r\nreturn -ENXIO;\r\n}\r\n}\r\nfuse->base = ioremap_nocache(regs.start, resource_size(&regs));\r\nif (!fuse->base) {\r\npr_err("failed to map FUSE registers\n");\r\nreturn -ENXIO;\r\n}\r\nfuse->soc->init(fuse);\r\npr_info("Tegra Revision: %s SKU: %d CPU Process: %d SoC Process: %d\n",\r\ntegra_revision_name[tegra_sku_info.revision],\r\ntegra_sku_info.sku_id, tegra_sku_info.cpu_process_id,\r\ntegra_sku_info.soc_process_id);\r\npr_debug("Tegra CPU Speedo ID %d, SoC Speedo ID %d\n",\r\ntegra_sku_info.cpu_speedo_id, tegra_sku_info.soc_speedo_id);\r\nreturn 0;\r\n}

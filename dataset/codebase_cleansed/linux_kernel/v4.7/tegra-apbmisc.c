u32 tegra_read_chipid(void)\r\n{\r\nreturn readl_relaxed(apbmisc_base + 4);\r\n}\r\nu8 tegra_get_chip_id(void)\r\n{\r\nif (!apbmisc_base) {\r\nWARN(1, "Tegra Chip ID not yet available\n");\r\nreturn 0;\r\n}\r\nreturn (tegra_read_chipid() >> 8) & 0xff;\r\n}\r\nu32 tegra_read_straps(void)\r\n{\r\nif (strapping_base)\r\nreturn readl_relaxed(strapping_base);\r\nelse\r\nreturn 0;\r\n}\r\nu32 tegra_read_ram_code(void)\r\n{\r\nu32 straps = tegra_read_straps();\r\nif (long_ram_code)\r\nstraps &= PMC_STRAPPING_OPT_A_RAM_CODE_MASK_LONG;\r\nelse\r\nstraps &= PMC_STRAPPING_OPT_A_RAM_CODE_MASK_SHORT;\r\nreturn straps >> PMC_STRAPPING_OPT_A_RAM_CODE_SHIFT;\r\n}\r\nvoid __init tegra_init_revision(void)\r\n{\r\nu32 id, chip_id, minor_rev;\r\nint rev;\r\nid = tegra_read_chipid();\r\nchip_id = (id >> 8) & 0xff;\r\nminor_rev = (id >> 16) & 0xf;\r\nswitch (minor_rev) {\r\ncase 1:\r\nrev = TEGRA_REVISION_A01;\r\nbreak;\r\ncase 2:\r\nrev = TEGRA_REVISION_A02;\r\nbreak;\r\ncase 3:\r\nif (chip_id == TEGRA20 && (tegra_fuse_read_spare(18) ||\r\ntegra_fuse_read_spare(19)))\r\nrev = TEGRA_REVISION_A03p;\r\nelse\r\nrev = TEGRA_REVISION_A03;\r\nbreak;\r\ncase 4:\r\nrev = TEGRA_REVISION_A04;\r\nbreak;\r\ndefault:\r\nrev = TEGRA_REVISION_UNKNOWN;\r\n}\r\ntegra_sku_info.revision = rev;\r\ntegra_sku_info.sku_id = tegra_fuse_read_early(FUSE_SKU_INFO);\r\n}\r\nvoid __init tegra_init_apbmisc(void)\r\n{\r\nstruct resource apbmisc, straps;\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, apbmisc_match);\r\nif (!np) {\r\nif (IS_ENABLED(CONFIG_ARM) && soc_is_tegra()) {\r\napbmisc.start = 0x70000800;\r\napbmisc.end = 0x70000863;\r\napbmisc.flags = IORESOURCE_MEM;\r\nif (tegra_get_chip_id() == TEGRA124) {\r\nstraps.start = 0x7000e864;\r\nstraps.end = 0x7000e867;\r\n} else {\r\nstraps.start = 0x70000008;\r\nstraps.end = 0x7000000b;\r\n}\r\nstraps.flags = IORESOURCE_MEM;\r\npr_warn("Using APBMISC region %pR\n", &apbmisc);\r\npr_warn("Using strapping options registers %pR\n",\r\n&straps);\r\n} else {\r\nreturn;\r\n}\r\n} else {\r\nif (of_address_to_resource(np, 0, &apbmisc) < 0) {\r\npr_err("failed to get APBMISC registers\n");\r\nreturn;\r\n}\r\nif (of_address_to_resource(np, 1, &straps) < 0) {\r\npr_err("failed to get strapping options registers\n");\r\nreturn;\r\n}\r\n}\r\napbmisc_base = ioremap_nocache(apbmisc.start, resource_size(&apbmisc));\r\nif (!apbmisc_base)\r\npr_err("failed to map APBMISC registers\n");\r\nstrapping_base = ioremap_nocache(straps.start, resource_size(&straps));\r\nif (!strapping_base)\r\npr_err("failed to map strapping options registers\n");\r\nlong_ram_code = of_property_read_bool(np, "nvidia,long-ram-code");\r\n}

static int power7_get_constraint(u64 event, unsigned long *maskp,\r\nunsigned long *valp)\r\n{\r\nint pmc, sh, unit;\r\nunsigned long mask = 0, value = 0;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc > 6)\r\nreturn -1;\r\nsh = (pmc - 1) * 2;\r\nmask |= 2 << sh;\r\nvalue |= 1 << sh;\r\nif (pmc >= 5 && !(event == 0x500fa || event == 0x600f4))\r\nreturn -1;\r\n}\r\nif (pmc < 5) {\r\nmask |= 0x8000;\r\nvalue |= 0x1000;\r\n}\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nif (unit == 6) {\r\nint l2sel = (event >> PM_L2SEL_SH) & PM_L2SEL_MSK;\r\nmask |= 0x7 << 16;\r\nvalue |= l2sel << 16;\r\n}\r\n*maskp = mask;\r\n*valp = value;\r\nreturn 0;\r\n}\r\nstatic int find_alternative(u64 event)\r\n{\r\nint i, j;\r\nfor (i = 0; i < ARRAY_SIZE(event_alternatives); ++i) {\r\nif (event < event_alternatives[i][0])\r\nbreak;\r\nfor (j = 0; j < MAX_ALT && event_alternatives[i][j]; ++j)\r\nif (event == event_alternatives[i][j])\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nstatic s64 find_alternative_decode(u64 event)\r\n{\r\nint pmc, psel;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\npsel = event & PM_PMCSEL_MSK;\r\nif ((pmc == 2 || pmc == 4) && (psel & ~7) == 0x40)\r\nreturn event - (1 << PM_PMC_SH) + 8;\r\nif ((pmc == 1 || pmc == 3) && (psel & ~7) == 0x48)\r\nreturn event + (1 << PM_PMC_SH) - 8;\r\nreturn -1;\r\n}\r\nstatic int power7_get_alternatives(u64 event, unsigned int flags, u64 alt[])\r\n{\r\nint i, j, nalt = 1;\r\ns64 ae;\r\nalt[0] = event;\r\nnalt = 1;\r\ni = find_alternative(event);\r\nif (i >= 0) {\r\nfor (j = 0; j < MAX_ALT; ++j) {\r\nae = event_alternatives[i][j];\r\nif (ae && ae != event)\r\nalt[nalt++] = ae;\r\n}\r\n} else {\r\nae = find_alternative_decode(event);\r\nif (ae > 0)\r\nalt[nalt++] = ae;\r\n}\r\nif (flags & PPMU_ONLY_COUNT_RUN) {\r\nj = nalt;\r\nfor (i = 0; i < nalt; ++i) {\r\nswitch (alt[i]) {\r\ncase 0x1e:\r\nalt[j++] = 0x600f4;\r\nbreak;\r\ncase 0x600f4:\r\nalt[j++] = 0x1e;\r\nbreak;\r\ncase 0x2:\r\nalt[j++] = 0x500fa;\r\nbreak;\r\ncase 0x500fa:\r\nalt[j++] = 0x2;\r\nbreak;\r\n}\r\n}\r\nnalt = j;\r\n}\r\nreturn nalt;\r\n}\r\nstatic int power7_marked_instr_event(u64 event)\r\n{\r\nint pmc, psel;\r\nint unit;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\npsel = event & PM_PMCSEL_MSK & ~1;\r\nif (pmc >= 5)\r\nreturn 0;\r\nswitch (psel >> 4) {\r\ncase 2:\r\nreturn pmc == 2 || pmc == 4;\r\ncase 3:\r\nif (psel == 0x3c)\r\nreturn pmc == 1;\r\nif (psel == 0x3e)\r\nreturn pmc != 2;\r\nreturn 1;\r\ncase 4:\r\ncase 5:\r\nreturn unit == 0xd;\r\ncase 6:\r\nif (psel == 0x64)\r\nreturn pmc >= 3;\r\ncase 8:\r\nreturn unit == 0xd;\r\n}\r\nreturn 0;\r\n}\r\nstatic int power7_compute_mmcr(u64 event[], int n_ev,\r\nunsigned int hwc[], unsigned long mmcr[], struct perf_event *pevents[])\r\n{\r\nunsigned long mmcr1 = 0;\r\nunsigned long mmcra = MMCRA_SDAR_DCACHE_MISS | MMCRA_SDAR_ERAT_MISS;\r\nunsigned int pmc, unit, combine, l2sel, psel;\r\nunsigned int pmc_inuse = 0;\r\nint i;\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc > 6)\r\nreturn -1;\r\nif (pmc_inuse & (1 << (pmc - 1)))\r\nreturn -1;\r\npmc_inuse |= 1 << (pmc - 1);\r\n}\r\n}\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nunit = (event[i] >> PM_UNIT_SH) & PM_UNIT_MSK;\r\ncombine = (event[i] >> PM_COMBINE_SH) & PM_COMBINE_MSK;\r\nl2sel = (event[i] >> PM_L2SEL_SH) & PM_L2SEL_MSK;\r\npsel = event[i] & PM_PMCSEL_MSK;\r\nif (!pmc) {\r\nfor (pmc = 0; pmc < 4; ++pmc) {\r\nif (!(pmc_inuse & (1 << pmc)))\r\nbreak;\r\n}\r\nif (pmc >= 4)\r\nreturn -1;\r\npmc_inuse |= 1 << pmc;\r\n} else {\r\n--pmc;\r\n}\r\nif (pmc <= 3) {\r\nmmcr1 |= (unsigned long) unit\r\n<< (MMCR1_TTM0SEL_SH - 4 * pmc);\r\nmmcr1 |= (unsigned long) combine\r\n<< (MMCR1_PMC1_COMBINE_SH - pmc);\r\nmmcr1 |= psel << MMCR1_PMCSEL_SH(pmc);\r\nif (unit == 6)\r\nmmcr1 |= (unsigned long) l2sel\r\n<< MMCR1_L2SEL_SH;\r\n}\r\nif (power7_marked_instr_event(event[i]))\r\nmmcra |= MMCRA_SAMPLE_ENABLE;\r\nhwc[i] = pmc;\r\n}\r\nmmcr[0] = 0;\r\nif (pmc_inuse & 1)\r\nmmcr[0] = MMCR0_PMC1CE;\r\nif (pmc_inuse & 0x3e)\r\nmmcr[0] |= MMCR0_PMCjCE;\r\nmmcr[1] = mmcr1;\r\nmmcr[2] = mmcra;\r\nreturn 0;\r\n}\r\nstatic void power7_disable_pmc(unsigned int pmc, unsigned long mmcr[])\r\n{\r\nif (pmc <= 3)\r\nmmcr[1] &= ~(0xffUL << MMCR1_PMCSEL_SH(pmc));\r\n}\r\nstatic int __init init_power7_pmu(void)\r\n{\r\nif (!cur_cpu_spec->oprofile_cpu_type ||\r\nstrcmp(cur_cpu_spec->oprofile_cpu_type, "ppc64/power7"))\r\nreturn -ENODEV;\r\nif (pvr_version_is(PVR_POWER7p))\r\npower7_pmu.flags |= PPMU_SIAR_VALID;\r\nreturn register_power_pmu(&power7_pmu);\r\n}

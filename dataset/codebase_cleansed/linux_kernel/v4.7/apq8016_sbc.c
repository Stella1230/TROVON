static int apq8016_sbc_dai_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_card *card = rtd->card;\r\nstruct apq8016_sbc_data *pdata = snd_soc_card_get_drvdata(card);\r\nint rval = 0;\r\nswitch (cpu_dai->id) {\r\ncase MI2S_PRIMARY:\r\nwritel(readl(pdata->spkr_iomux) | SPKR_CTL_PRI_WS_SLAVE_SEL_11,\r\npdata->spkr_iomux);\r\nbreak;\r\ncase MI2S_QUATERNARY:\r\nwritel(readl(pdata->mic_iomux) | MIC_CTRL_QUA_WS_SLAVE_SEL_10 |\r\nMIC_CTRL_TLMM_SCLK_EN,\r\npdata->mic_iomux);\r\nbreak;\r\ncase MI2S_TERTIARY:\r\nwritel(readl(pdata->mic_iomux) | MIC_CTRL_TER_WS_SLAVE_SEL |\r\nMIC_CTRL_TLMM_SCLK_EN,\r\npdata->mic_iomux);\r\nbreak;\r\ndefault:\r\ndev_err(card->dev, "unsupported cpu dai configuration\n");\r\nrval = -EINVAL;\r\nbreak;\r\n}\r\nreturn rval;\r\n}\r\nstatic struct apq8016_sbc_data *apq8016_sbc_parse_of(struct snd_soc_card *card)\r\n{\r\nstruct device *dev = card->dev;\r\nstruct snd_soc_dai_link *link;\r\nstruct device_node *np, *codec, *cpu, *node = dev->of_node;\r\nstruct apq8016_sbc_data *data;\r\nint ret, num_links;\r\nret = snd_soc_of_parse_card_name(card, "qcom,model");\r\nif (ret) {\r\ndev_err(dev, "Error parsing card name: %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\nnum_links = of_get_child_count(node);\r\ndata = devm_kzalloc(dev, sizeof(*data) + sizeof(*link) * num_links,\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn ERR_PTR(-ENOMEM);\r\ncard->dai_link = &data->dai_link[0];\r\ncard->num_links = num_links;\r\nlink = data->dai_link;\r\nfor_each_child_of_node(node, np) {\r\ncpu = of_get_child_by_name(np, "cpu");\r\ncodec = of_get_child_by_name(np, "codec");\r\nif (!cpu || !codec) {\r\ndev_err(dev, "Can't find cpu/codec DT node\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nlink->cpu_of_node = of_parse_phandle(cpu, "sound-dai", 0);\r\nif (!link->cpu_of_node) {\r\ndev_err(card->dev, "error getting cpu phandle\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nlink->codec_of_node = of_parse_phandle(codec, "sound-dai", 0);\r\nif (!link->codec_of_node) {\r\ndev_err(card->dev, "error getting codec phandle\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nret = snd_soc_of_get_dai_name(cpu, &link->cpu_dai_name);\r\nif (ret) {\r\ndev_err(card->dev, "error getting cpu dai name\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nret = snd_soc_of_get_dai_name(codec, &link->codec_dai_name);\r\nif (ret) {\r\ndev_err(card->dev, "error getting codec dai name\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nlink->platform_of_node = link->cpu_of_node;\r\nret = of_property_read_string(np, "link-name", &link->name);\r\nif (ret) {\r\ndev_err(card->dev, "error getting codec dai_link name\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nlink->stream_name = link->name;\r\nlink->init = apq8016_sbc_dai_init;\r\nlink++;\r\n}\r\nreturn data;\r\n}\r\nstatic int apq8016_sbc_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct snd_soc_card *card;\r\nstruct apq8016_sbc_data *data;\r\nstruct resource *res;\r\ncard = devm_kzalloc(dev, sizeof(*card), GFP_KERNEL);\r\nif (!card)\r\nreturn -ENOMEM;\r\ncard->dev = dev;\r\ndata = apq8016_sbc_parse_of(card);\r\nif (IS_ERR(data)) {\r\ndev_err(&pdev->dev, "Error resolving dai links: %ld\n",\r\nPTR_ERR(data));\r\nreturn PTR_ERR(data);\r\n}\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "mic-iomux");\r\ndata->mic_iomux = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(data->mic_iomux))\r\nreturn PTR_ERR(data->mic_iomux);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "spkr-iomux");\r\ndata->spkr_iomux = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(data->spkr_iomux))\r\nreturn PTR_ERR(data->spkr_iomux);\r\nplatform_set_drvdata(pdev, data);\r\nsnd_soc_card_set_drvdata(card, data);\r\nreturn devm_snd_soc_register_card(&pdev->dev, card);\r\n}

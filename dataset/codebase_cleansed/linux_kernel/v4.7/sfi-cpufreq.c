static int sfi_parse_freq(struct sfi_table_header *table)\r\n{\r\nstruct sfi_table_simple *sb;\r\nstruct sfi_freq_table_entry *pentry;\r\nint totallen;\r\nsb = (struct sfi_table_simple *)table;\r\nnum_freq_table_entries = SFI_GET_NUM_ENTRIES(sb,\r\nstruct sfi_freq_table_entry);\r\nif (num_freq_table_entries <= 1) {\r\npr_err("No p-states discovered\n");\r\nreturn -ENODEV;\r\n}\r\npentry = (struct sfi_freq_table_entry *)sb->pentry;\r\ntotallen = num_freq_table_entries * sizeof(*pentry);\r\nsfi_cpufreq_array = kmemdup(pentry, totallen, GFP_KERNEL);\r\nif (!sfi_cpufreq_array)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic int sfi_cpufreq_target(struct cpufreq_policy *policy, unsigned int index)\r\n{\r\nunsigned int next_perf_state = 0;\r\nu32 lo, hi;\r\nnext_perf_state = policy->freq_table[index].driver_data;\r\nrdmsr_on_cpu(policy->cpu, MSR_IA32_PERF_CTL, &lo, &hi);\r\nlo = (lo & ~INTEL_PERF_CTL_MASK) |\r\n((u32) sfi_cpufreq_array[next_perf_state].ctrl_val &\r\nINTEL_PERF_CTL_MASK);\r\nwrmsr_on_cpu(policy->cpu, MSR_IA32_PERF_CTL, lo, hi);\r\nreturn 0;\r\n}\r\nstatic int sfi_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\npolicy->shared_type = CPUFREQ_SHARED_TYPE_HW;\r\npolicy->cpuinfo.transition_latency = 100000;\r\nreturn cpufreq_table_validate_and_show(policy, freq_table);\r\n}\r\nstatic int __init sfi_cpufreq_init(void)\r\n{\r\nint ret, i;\r\nret = sfi_table_parse(SFI_SIG_FREQ, NULL, NULL, sfi_parse_freq);\r\nif (ret)\r\nreturn ret;\r\nfreq_table = kzalloc(sizeof(*freq_table) *\r\n(num_freq_table_entries + 1), GFP_KERNEL);\r\nif (!freq_table) {\r\nret = -ENOMEM;\r\ngoto err_free_array;\r\n}\r\nfor (i = 0; i < num_freq_table_entries; i++) {\r\nfreq_table[i].driver_data = i;\r\nfreq_table[i].frequency = sfi_cpufreq_array[i].freq_mhz * 1000;\r\n}\r\nfreq_table[i].frequency = CPUFREQ_TABLE_END;\r\nret = cpufreq_register_driver(&sfi_cpufreq_driver);\r\nif (ret)\r\ngoto err_free_tbl;\r\nreturn ret;\r\nerr_free_tbl:\r\nkfree(freq_table);\r\nerr_free_array:\r\nkfree(sfi_cpufreq_array);\r\nreturn ret;\r\n}\r\nstatic void __exit sfi_cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&sfi_cpufreq_driver);\r\nkfree(freq_table);\r\nkfree(sfi_cpufreq_array);\r\n}

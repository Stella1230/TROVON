static int cosm_dev_probe(struct device *d)\r\n{\r\nstruct cosm_device *dev = dev_to_cosm(d);\r\nstruct cosm_driver *drv = drv_to_cosm(dev->dev.driver);\r\nreturn drv->probe(dev);\r\n}\r\nstatic int cosm_dev_remove(struct device *d)\r\n{\r\nstruct cosm_device *dev = dev_to_cosm(d);\r\nstruct cosm_driver *drv = drv_to_cosm(dev->dev.driver);\r\ndrv->remove(dev);\r\nreturn 0;\r\n}\r\nint cosm_register_driver(struct cosm_driver *driver)\r\n{\r\ndriver->driver.bus = &cosm_bus;\r\nreturn driver_register(&driver->driver);\r\n}\r\nvoid cosm_unregister_driver(struct cosm_driver *driver)\r\n{\r\ndriver_unregister(&driver->driver);\r\n}\r\nstatic inline void cosm_release_dev(struct device *d)\r\n{\r\nstruct cosm_device *cdev = dev_to_cosm(d);\r\nkfree(cdev);\r\n}\r\nstruct cosm_device *\r\ncosm_register_device(struct device *pdev, struct cosm_hw_ops *hw_ops)\r\n{\r\nstruct cosm_device *cdev;\r\nint ret;\r\ncdev = kzalloc(sizeof(*cdev), GFP_KERNEL);\r\nif (!cdev)\r\nreturn ERR_PTR(-ENOMEM);\r\ncdev->dev.parent = pdev;\r\ncdev->dev.release = cosm_release_dev;\r\ncdev->hw_ops = hw_ops;\r\ndev_set_drvdata(&cdev->dev, cdev);\r\ncdev->dev.bus = &cosm_bus;\r\nret = ida_simple_get(&cosm_index_ida, 0, 0, GFP_KERNEL);\r\nif (ret < 0)\r\ngoto free_cdev;\r\ncdev->index = ret;\r\ncdev->dev.id = ret;\r\ndev_set_name(&cdev->dev, "cosm-dev%u", cdev->index);\r\nret = device_register(&cdev->dev);\r\nif (ret)\r\ngoto ida_remove;\r\nreturn cdev;\r\nida_remove:\r\nida_simple_remove(&cosm_index_ida, cdev->index);\r\nfree_cdev:\r\nput_device(&cdev->dev);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid cosm_unregister_device(struct cosm_device *dev)\r\n{\r\nint index = dev->index;\r\ndevice_unregister(&dev->dev);\r\nida_simple_remove(&cosm_index_ida, index);\r\n}\r\nstruct cosm_device *cosm_find_cdev_by_id(int id)\r\n{\r\nstruct device *dev = subsys_find_device_by_id(&cosm_bus, id, NULL);\r\nreturn dev ? container_of(dev, struct cosm_device, dev) : NULL;\r\n}\r\nstatic int __init cosm_init(void)\r\n{\r\nreturn bus_register(&cosm_bus);\r\n}\r\nstatic void __exit cosm_exit(void)\r\n{\r\nbus_unregister(&cosm_bus);\r\nida_destroy(&cosm_index_ida);\r\n}

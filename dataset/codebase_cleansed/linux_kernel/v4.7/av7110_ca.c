void CI_handle(struct av7110 *av7110, u8 *data, u16 len)\r\n{\r\ndprintk(8, "av7110:%p\n",av7110);\r\nif (len < 3)\r\nreturn;\r\nswitch (data[0]) {\r\ncase CI_MSG_CI_INFO:\r\nif (data[2] != 1 && data[2] != 2)\r\nbreak;\r\nswitch (data[1]) {\r\ncase 0:\r\nav7110->ci_slot[data[2] - 1].flags = 0;\r\nbreak;\r\ncase 1:\r\nav7110->ci_slot[data[2] - 1].flags |= CA_CI_MODULE_PRESENT;\r\nbreak;\r\ncase 2:\r\nav7110->ci_slot[data[2] - 1].flags |= CA_CI_MODULE_READY;\r\nbreak;\r\n}\r\nbreak;\r\ncase CI_SWITCH_PRG_REPLY:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid ci_get_data(struct dvb_ringbuffer *cibuf, u8 *data, int len)\r\n{\r\nif (dvb_ringbuffer_free(cibuf) < len + 2)\r\nreturn;\r\nDVB_RINGBUFFER_WRITE_BYTE(cibuf, len >> 8);\r\nDVB_RINGBUFFER_WRITE_BYTE(cibuf, len & 0xff);\r\ndvb_ringbuffer_write(cibuf, data, len);\r\nwake_up_interruptible(&cibuf->queue);\r\n}\r\nstatic int ci_ll_init(struct dvb_ringbuffer *cirbuf, struct dvb_ringbuffer *ciwbuf, int size)\r\n{\r\nstruct dvb_ringbuffer *tab[] = { cirbuf, ciwbuf, NULL }, **p;\r\nvoid *data;\r\nfor (p = tab; *p; p++) {\r\ndata = vmalloc(size);\r\nif (!data) {\r\nwhile (p-- != tab) {\r\nvfree(p[0]->data);\r\np[0]->data = NULL;\r\n}\r\nreturn -ENOMEM;\r\n}\r\ndvb_ringbuffer_init(*p, data, size);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ci_ll_flush(struct dvb_ringbuffer *cirbuf, struct dvb_ringbuffer *ciwbuf)\r\n{\r\ndvb_ringbuffer_flush_spinlock_wakeup(cirbuf);\r\ndvb_ringbuffer_flush_spinlock_wakeup(ciwbuf);\r\n}\r\nstatic void ci_ll_release(struct dvb_ringbuffer *cirbuf, struct dvb_ringbuffer *ciwbuf)\r\n{\r\nvfree(cirbuf->data);\r\ncirbuf->data = NULL;\r\nvfree(ciwbuf->data);\r\nciwbuf->data = NULL;\r\n}\r\nstatic int ci_ll_reset(struct dvb_ringbuffer *cibuf, struct file *file,\r\nint slots, ca_slot_info_t *slot)\r\n{\r\nint i;\r\nint len = 0;\r\nu8 msg[8] = { 0x00, 0x06, 0x00, 0x00, 0xff, 0x02, 0x00, 0x00 };\r\nfor (i = 0; i < 2; i++) {\r\nif (slots & (1 << i))\r\nlen += 8;\r\n}\r\nif (dvb_ringbuffer_free(cibuf) < len)\r\nreturn -EBUSY;\r\nfor (i = 0; i < 2; i++) {\r\nif (slots & (1 << i)) {\r\nmsg[2] = i;\r\ndvb_ringbuffer_write(cibuf, msg, 8);\r\nslot[i].flags = 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ci_ll_write(struct dvb_ringbuffer *cibuf, struct file *file,\r\nconst char __user *buf, size_t count, loff_t *ppos)\r\n{\r\nint free;\r\nint non_blocking = file->f_flags & O_NONBLOCK;\r\nu8 *page = (u8 *)__get_free_page(GFP_USER);\r\nint res;\r\nif (!page)\r\nreturn -ENOMEM;\r\nres = -EINVAL;\r\nif (count > 2048)\r\ngoto out;\r\nres = -EFAULT;\r\nif (copy_from_user(page, buf, count))\r\ngoto out;\r\nfree = dvb_ringbuffer_free(cibuf);\r\nif (count + 2 > free) {\r\nres = -EWOULDBLOCK;\r\nif (non_blocking)\r\ngoto out;\r\nres = -ERESTARTSYS;\r\nif (wait_event_interruptible(cibuf->queue,\r\n(dvb_ringbuffer_free(cibuf) >= count + 2)))\r\ngoto out;\r\n}\r\nDVB_RINGBUFFER_WRITE_BYTE(cibuf, count >> 8);\r\nDVB_RINGBUFFER_WRITE_BYTE(cibuf, count & 0xff);\r\nres = dvb_ringbuffer_write(cibuf, page, count);\r\nout:\r\nfree_page((unsigned long)page);\r\nreturn res;\r\n}\r\nstatic ssize_t ci_ll_read(struct dvb_ringbuffer *cibuf, struct file *file,\r\nchar __user *buf, size_t count, loff_t *ppos)\r\n{\r\nint avail;\r\nint non_blocking = file->f_flags & O_NONBLOCK;\r\nssize_t len;\r\nif (!cibuf->data || !count)\r\nreturn 0;\r\nif (non_blocking && (dvb_ringbuffer_empty(cibuf)))\r\nreturn -EWOULDBLOCK;\r\nif (wait_event_interruptible(cibuf->queue,\r\n!dvb_ringbuffer_empty(cibuf)))\r\nreturn -ERESTARTSYS;\r\navail = dvb_ringbuffer_avail(cibuf);\r\nif (avail < 4)\r\nreturn 0;\r\nlen = DVB_RINGBUFFER_PEEK(cibuf, 0) << 8;\r\nlen |= DVB_RINGBUFFER_PEEK(cibuf, 1);\r\nif (avail < len + 2 || count < len)\r\nreturn -EINVAL;\r\nDVB_RINGBUFFER_SKIP(cibuf, 2);\r\nreturn dvb_ringbuffer_read_user(cibuf, buf, len);\r\n}\r\nstatic int dvb_ca_open(struct inode *inode, struct file *file)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct av7110 *av7110 = dvbdev->priv;\r\nint err = dvb_generic_open(inode, file);\r\ndprintk(8, "av7110:%p\n",av7110);\r\nif (err < 0)\r\nreturn err;\r\nci_ll_flush(&av7110->ci_rbuffer, &av7110->ci_wbuffer);\r\nreturn 0;\r\n}\r\nstatic unsigned int dvb_ca_poll (struct file *file, poll_table *wait)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct av7110 *av7110 = dvbdev->priv;\r\nstruct dvb_ringbuffer *rbuf = &av7110->ci_rbuffer;\r\nstruct dvb_ringbuffer *wbuf = &av7110->ci_wbuffer;\r\nunsigned int mask = 0;\r\ndprintk(8, "av7110:%p\n",av7110);\r\npoll_wait(file, &rbuf->queue, wait);\r\npoll_wait(file, &wbuf->queue, wait);\r\nif (!dvb_ringbuffer_empty(rbuf))\r\nmask |= (POLLIN | POLLRDNORM);\r\nif (dvb_ringbuffer_free(wbuf) > 1024)\r\nmask |= (POLLOUT | POLLWRNORM);\r\nreturn mask;\r\n}\r\nstatic int dvb_ca_ioctl(struct file *file, unsigned int cmd, void *parg)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct av7110 *av7110 = dvbdev->priv;\r\nunsigned long arg = (unsigned long) parg;\r\nint ret = 0;\r\ndprintk(8, "av7110:%p\n",av7110);\r\nif (mutex_lock_interruptible(&av7110->ioctl_mutex))\r\nreturn -ERESTARTSYS;\r\nswitch (cmd) {\r\ncase CA_RESET:\r\nret = ci_ll_reset(&av7110->ci_wbuffer, file, arg,\r\n&av7110->ci_slot[0]);\r\nbreak;\r\ncase CA_GET_CAP:\r\n{\r\nca_caps_t cap;\r\ncap.slot_num = 2;\r\ncap.slot_type = (FW_CI_LL_SUPPORT(av7110->arm_app) ?\r\nCA_CI_LINK : CA_CI) | CA_DESCR;\r\ncap.descr_num = 16;\r\ncap.descr_type = CA_ECD;\r\nmemcpy(parg, &cap, sizeof(cap));\r\nbreak;\r\n}\r\ncase CA_GET_SLOT_INFO:\r\n{\r\nca_slot_info_t *info=(ca_slot_info_t *)parg;\r\nif (info->num < 0 || info->num > 1) {\r\nmutex_unlock(&av7110->ioctl_mutex);\r\nreturn -EINVAL;\r\n}\r\nav7110->ci_slot[info->num].num = info->num;\r\nav7110->ci_slot[info->num].type = FW_CI_LL_SUPPORT(av7110->arm_app) ?\r\nCA_CI_LINK : CA_CI;\r\nmemcpy(info, &av7110->ci_slot[info->num], sizeof(ca_slot_info_t));\r\nbreak;\r\n}\r\ncase CA_GET_MSG:\r\nbreak;\r\ncase CA_SEND_MSG:\r\nbreak;\r\ncase CA_GET_DESCR_INFO:\r\n{\r\nca_descr_info_t info;\r\ninfo.num = 16;\r\ninfo.type = CA_ECD;\r\nmemcpy(parg, &info, sizeof (info));\r\nbreak;\r\n}\r\ncase CA_SET_DESCR:\r\n{\r\nca_descr_t *descr = (ca_descr_t*) parg;\r\nif (descr->index >= 16 || descr->parity > 1) {\r\nmutex_unlock(&av7110->ioctl_mutex);\r\nreturn -EINVAL;\r\n}\r\nav7110_fw_cmd(av7110, COMTYPE_PIDFILTER, SetDescr, 5,\r\n(descr->index<<8)|descr->parity,\r\n(descr->cw[0]<<8)|descr->cw[1],\r\n(descr->cw[2]<<8)|descr->cw[3],\r\n(descr->cw[4]<<8)|descr->cw[5],\r\n(descr->cw[6]<<8)|descr->cw[7]);\r\nbreak;\r\n}\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nmutex_unlock(&av7110->ioctl_mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t dvb_ca_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct av7110 *av7110 = dvbdev->priv;\r\ndprintk(8, "av7110:%p\n",av7110);\r\nreturn ci_ll_write(&av7110->ci_wbuffer, file, buf, count, ppos);\r\n}\r\nstatic ssize_t dvb_ca_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct av7110 *av7110 = dvbdev->priv;\r\ndprintk(8, "av7110:%p\n",av7110);\r\nreturn ci_ll_read(&av7110->ci_rbuffer, file, buf, count, ppos);\r\n}\r\nint av7110_ca_register(struct av7110 *av7110)\r\n{\r\nreturn dvb_register_device(&av7110->dvb_adapter, &av7110->ca_dev,\r\n&dvbdev_ca, av7110, DVB_DEVICE_CA, 0);\r\n}\r\nvoid av7110_ca_unregister(struct av7110 *av7110)\r\n{\r\ndvb_unregister_device(av7110->ca_dev);\r\n}\r\nint av7110_ca_init(struct av7110* av7110)\r\n{\r\nreturn ci_ll_init(&av7110->ci_rbuffer, &av7110->ci_wbuffer, 8192);\r\n}\r\nvoid av7110_ca_exit(struct av7110* av7110)\r\n{\r\nci_ll_release(&av7110->ci_rbuffer, &av7110->ci_wbuffer);\r\n}

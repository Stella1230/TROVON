static inline uint64_t cvmx_pcie_get_io_base_address(int pcie_port)\r\n{\r\nunion cvmx_pcie_address pcie_addr;\r\npcie_addr.u64 = 0;\r\npcie_addr.io.upper = 0;\r\npcie_addr.io.io = 1;\r\npcie_addr.io.did = 3;\r\npcie_addr.io.subdid = 2;\r\npcie_addr.io.es = 1;\r\npcie_addr.io.port = pcie_port;\r\nreturn pcie_addr.u64;\r\n}\r\nstatic inline uint64_t cvmx_pcie_get_io_size(int pcie_port)\r\n{\r\nreturn 1ull << 32;\r\n}\r\nstatic inline uint64_t cvmx_pcie_get_mem_base_address(int pcie_port)\r\n{\r\nunion cvmx_pcie_address pcie_addr;\r\npcie_addr.u64 = 0;\r\npcie_addr.mem.upper = 0;\r\npcie_addr.mem.io = 1;\r\npcie_addr.mem.did = 3;\r\npcie_addr.mem.subdid = 3 + pcie_port;\r\nreturn pcie_addr.u64;\r\n}\r\nstatic inline uint64_t cvmx_pcie_get_mem_size(int pcie_port)\r\n{\r\nreturn 1ull << 36;\r\n}\r\nstatic uint32_t cvmx_pcie_cfgx_read(int pcie_port, uint32_t cfg_offset)\r\n{\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI)) {\r\nunion cvmx_pescx_cfg_rd pescx_cfg_rd;\r\npescx_cfg_rd.u64 = 0;\r\npescx_cfg_rd.s.addr = cfg_offset;\r\ncvmx_write_csr(CVMX_PESCX_CFG_RD(pcie_port), pescx_cfg_rd.u64);\r\npescx_cfg_rd.u64 = cvmx_read_csr(CVMX_PESCX_CFG_RD(pcie_port));\r\nreturn pescx_cfg_rd.s.data;\r\n} else {\r\nunion cvmx_pemx_cfg_rd pemx_cfg_rd;\r\npemx_cfg_rd.u64 = 0;\r\npemx_cfg_rd.s.addr = cfg_offset;\r\ncvmx_write_csr(CVMX_PEMX_CFG_RD(pcie_port), pemx_cfg_rd.u64);\r\npemx_cfg_rd.u64 = cvmx_read_csr(CVMX_PEMX_CFG_RD(pcie_port));\r\nreturn pemx_cfg_rd.s.data;\r\n}\r\n}\r\nstatic void cvmx_pcie_cfgx_write(int pcie_port, uint32_t cfg_offset,\r\nuint32_t val)\r\n{\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI)) {\r\nunion cvmx_pescx_cfg_wr pescx_cfg_wr;\r\npescx_cfg_wr.u64 = 0;\r\npescx_cfg_wr.s.addr = cfg_offset;\r\npescx_cfg_wr.s.data = val;\r\ncvmx_write_csr(CVMX_PESCX_CFG_WR(pcie_port), pescx_cfg_wr.u64);\r\n} else {\r\nunion cvmx_pemx_cfg_wr pemx_cfg_wr;\r\npemx_cfg_wr.u64 = 0;\r\npemx_cfg_wr.s.addr = cfg_offset;\r\npemx_cfg_wr.s.data = val;\r\ncvmx_write_csr(CVMX_PEMX_CFG_WR(pcie_port), pemx_cfg_wr.u64);\r\n}\r\n}\r\nstatic inline uint64_t __cvmx_pcie_build_config_addr(int pcie_port, int bus,\r\nint dev, int fn, int reg)\r\n{\r\nunion cvmx_pcie_address pcie_addr;\r\nunion cvmx_pciercx_cfg006 pciercx_cfg006;\r\npciercx_cfg006.u32 =\r\ncvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG006(pcie_port));\r\nif ((bus <= pciercx_cfg006.s.pbnum) && (dev != 0))\r\nreturn 0;\r\npcie_addr.u64 = 0;\r\npcie_addr.config.upper = 2;\r\npcie_addr.config.io = 1;\r\npcie_addr.config.did = 3;\r\npcie_addr.config.subdid = 1;\r\npcie_addr.config.es = 1;\r\npcie_addr.config.port = pcie_port;\r\npcie_addr.config.ty = (bus > pciercx_cfg006.s.pbnum);\r\npcie_addr.config.bus = bus;\r\npcie_addr.config.dev = dev;\r\npcie_addr.config.func = fn;\r\npcie_addr.config.reg = reg;\r\nreturn pcie_addr.u64;\r\n}\r\nstatic uint8_t cvmx_pcie_config_read8(int pcie_port, int bus, int dev,\r\nint fn, int reg)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\nreturn cvmx_read64_uint8(address);\r\nelse\r\nreturn 0xff;\r\n}\r\nstatic uint16_t cvmx_pcie_config_read16(int pcie_port, int bus, int dev,\r\nint fn, int reg)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\nreturn le16_to_cpu(cvmx_read64_uint16(address));\r\nelse\r\nreturn 0xffff;\r\n}\r\nstatic uint32_t cvmx_pcie_config_read32(int pcie_port, int bus, int dev,\r\nint fn, int reg)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\nreturn le32_to_cpu(cvmx_read64_uint32(address));\r\nelse\r\nreturn 0xffffffff;\r\n}\r\nstatic void cvmx_pcie_config_write8(int pcie_port, int bus, int dev, int fn,\r\nint reg, uint8_t val)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\ncvmx_write64_uint8(address, val);\r\n}\r\nstatic void cvmx_pcie_config_write16(int pcie_port, int bus, int dev, int fn,\r\nint reg, uint16_t val)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\ncvmx_write64_uint16(address, cpu_to_le16(val));\r\n}\r\nstatic void cvmx_pcie_config_write32(int pcie_port, int bus, int dev, int fn,\r\nint reg, uint32_t val)\r\n{\r\nuint64_t address =\r\n__cvmx_pcie_build_config_addr(pcie_port, bus, dev, fn, reg);\r\nif (address)\r\ncvmx_write64_uint32(address, cpu_to_le32(val));\r\n}\r\nstatic void __cvmx_pcie_rc_initialize_config_space(int pcie_port)\r\n{\r\nunion cvmx_pciercx_cfg030 pciercx_cfg030;\r\nunion cvmx_pciercx_cfg070 pciercx_cfg070;\r\nunion cvmx_pciercx_cfg001 pciercx_cfg001;\r\nunion cvmx_pciercx_cfg032 pciercx_cfg032;\r\nunion cvmx_pciercx_cfg006 pciercx_cfg006;\r\nunion cvmx_pciercx_cfg008 pciercx_cfg008;\r\nunion cvmx_pciercx_cfg009 pciercx_cfg009;\r\nunion cvmx_pciercx_cfg010 pciercx_cfg010;\r\nunion cvmx_pciercx_cfg011 pciercx_cfg011;\r\nunion cvmx_pciercx_cfg035 pciercx_cfg035;\r\nunion cvmx_pciercx_cfg075 pciercx_cfg075;\r\nunion cvmx_pciercx_cfg034 pciercx_cfg034;\r\npciercx_cfg030.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG030(pcie_port));\r\nif (OCTEON_IS_MODEL(OCTEON_CN5XXX)) {\r\npciercx_cfg030.s.mps = MPS_CN5XXX;\r\npciercx_cfg030.s.mrrs = MRRS_CN5XXX;\r\n} else {\r\npciercx_cfg030.s.mps = MPS_CN6XXX;\r\npciercx_cfg030.s.mrrs = MRRS_CN6XXX;\r\n}\r\npciercx_cfg030.s.ro_en = 1;\r\npciercx_cfg030.s.ns_en = 1;\r\npciercx_cfg030.s.ce_en = 1;\r\npciercx_cfg030.s.nfe_en = 1;\r\npciercx_cfg030.s.fe_en = 1;\r\npciercx_cfg030.s.ur_en = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG030(pcie_port), pciercx_cfg030.u32);\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI)) {\r\nunion cvmx_npei_ctl_status2 npei_ctl_status2;\r\nnpei_ctl_status2.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_CTL_STATUS2);\r\nnpei_ctl_status2.s.mps = MPS_CN5XXX;\r\nnpei_ctl_status2.s.mrrs = MRRS_CN5XXX;\r\nif (pcie_port)\r\nnpei_ctl_status2.s.c1_b1_s = 3;\r\nelse\r\nnpei_ctl_status2.s.c0_b1_s = 3;\r\ncvmx_write_csr(CVMX_PEXP_NPEI_CTL_STATUS2, npei_ctl_status2.u64);\r\n} else {\r\nunion cvmx_dpi_sli_prtx_cfg prt_cfg;\r\nunion cvmx_sli_s2m_portx_ctl sli_s2m_portx_ctl;\r\nprt_cfg.u64 = cvmx_read_csr(CVMX_DPI_SLI_PRTX_CFG(pcie_port));\r\nprt_cfg.s.mps = MPS_CN6XXX;\r\nprt_cfg.s.mrrs = MRRS_CN6XXX;\r\nprt_cfg.s.molr = 32;\r\ncvmx_write_csr(CVMX_DPI_SLI_PRTX_CFG(pcie_port), prt_cfg.u64);\r\nsli_s2m_portx_ctl.u64 = cvmx_read_csr(CVMX_PEXP_SLI_S2M_PORTX_CTL(pcie_port));\r\nsli_s2m_portx_ctl.s.mrrs = MRRS_CN6XXX;\r\ncvmx_write_csr(CVMX_PEXP_SLI_S2M_PORTX_CTL(pcie_port), sli_s2m_portx_ctl.u64);\r\n}\r\npciercx_cfg070.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG070(pcie_port));\r\npciercx_cfg070.s.ge = 1;\r\npciercx_cfg070.s.ce = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG070(pcie_port), pciercx_cfg070.u32);\r\npciercx_cfg001.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG001(pcie_port));\r\npciercx_cfg001.s.msae = 1;\r\npciercx_cfg001.s.me = 1;\r\npciercx_cfg001.s.i_dis = 1;\r\npciercx_cfg001.s.see = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG001(pcie_port), pciercx_cfg001.u32);\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG066(pcie_port), 0);\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG069(pcie_port), 0);\r\npciercx_cfg032.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG032(pcie_port));\r\npciercx_cfg032.s.aslpc = 0;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG032(pcie_port), pciercx_cfg032.u32);\r\npciercx_cfg006.u32 = 0;\r\npciercx_cfg006.s.pbnum = 1;\r\npciercx_cfg006.s.sbnum = 1;\r\npciercx_cfg006.s.subbnum = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG006(pcie_port), pciercx_cfg006.u32);\r\npciercx_cfg008.u32 = 0;\r\npciercx_cfg008.s.mb_addr = 0x100;\r\npciercx_cfg008.s.ml_addr = 0;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG008(pcie_port), pciercx_cfg008.u32);\r\npciercx_cfg009.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG009(pcie_port));\r\npciercx_cfg010.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG010(pcie_port));\r\npciercx_cfg011.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG011(pcie_port));\r\npciercx_cfg009.s.lmem_base = 0x100;\r\npciercx_cfg009.s.lmem_limit = 0;\r\npciercx_cfg010.s.umem_base = 0x100;\r\npciercx_cfg011.s.umem_limit = 0;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG009(pcie_port), pciercx_cfg009.u32);\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG010(pcie_port), pciercx_cfg010.u32);\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG011(pcie_port), pciercx_cfg011.u32);\r\npciercx_cfg035.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG035(pcie_port));\r\npciercx_cfg035.s.secee = 1;\r\npciercx_cfg035.s.sefee = 1;\r\npciercx_cfg035.s.senfee = 1;\r\npciercx_cfg035.s.pmeie = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG035(pcie_port), pciercx_cfg035.u32);\r\npciercx_cfg075.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG075(pcie_port));\r\npciercx_cfg075.s.cere = 1;\r\npciercx_cfg075.s.nfere = 1;\r\npciercx_cfg075.s.fere = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG075(pcie_port), pciercx_cfg075.u32);\r\npciercx_cfg034.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG034(pcie_port));\r\npciercx_cfg034.s.hpint_en = 1;\r\npciercx_cfg034.s.dlls_en = 1;\r\npciercx_cfg034.s.ccint_en = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG034(pcie_port), pciercx_cfg034.u32);\r\n}\r\nstatic int __cvmx_pcie_rc_initialize_link_gen1(int pcie_port)\r\n{\r\nuint64_t start_cycle;\r\nunion cvmx_pescx_ctl_status pescx_ctl_status;\r\nunion cvmx_pciercx_cfg452 pciercx_cfg452;\r\nunion cvmx_pciercx_cfg032 pciercx_cfg032;\r\nunion cvmx_pciercx_cfg448 pciercx_cfg448;\r\npciercx_cfg452.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG452(pcie_port));\r\npescx_ctl_status.u64 = cvmx_read_csr(CVMX_PESCX_CTL_STATUS(pcie_port));\r\nif (pescx_ctl_status.s.qlm_cfg == 0)\r\npciercx_cfg452.s.lme = 0xf;\r\nelse\r\npciercx_cfg452.s.lme = 0x7;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG452(pcie_port), pciercx_cfg452.u32);\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_X)) {\r\nunion cvmx_pciercx_cfg455 pciercx_cfg455;\r\npciercx_cfg455.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG455(pcie_port));\r\npciercx_cfg455.s.m_cpl_len_err = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG455(pcie_port), pciercx_cfg455.u32);\r\n}\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX) && (pcie_port == 1)) {\r\npescx_ctl_status.s.lane_swp = 1;\r\ncvmx_write_csr(CVMX_PESCX_CTL_STATUS(pcie_port), pescx_ctl_status.u64);\r\n}\r\npescx_ctl_status.u64 = cvmx_read_csr(CVMX_PESCX_CTL_STATUS(pcie_port));\r\npescx_ctl_status.s.lnk_enb = 1;\r\ncvmx_write_csr(CVMX_PESCX_CTL_STATUS(pcie_port), pescx_ctl_status.u64);\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_0))\r\n__cvmx_helper_errata_qlm_disable_2nd_order_cdr(0);\r\nstart_cycle = cvmx_get_cycle();\r\ndo {\r\nif (cvmx_get_cycle() - start_cycle > 2 * octeon_get_clock_rate()) {\r\ncvmx_dprintf("PCIe: Port %d link timeout\n", pcie_port);\r\nreturn -1;\r\n}\r\ncvmx_wait(10000);\r\npciercx_cfg032.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG032(pcie_port));\r\n} while (pciercx_cfg032.s.dlla == 0);\r\ncvmx_write_csr(CVMX_PEXP_NPEI_INT_SUM, cvmx_read_csr(CVMX_PEXP_NPEI_INT_SUM));\r\npciercx_cfg448.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG448(pcie_port));\r\nswitch (pciercx_cfg032.s.nlw) {\r\ncase 1:\r\npciercx_cfg448.s.rtl = 1677;\r\nbreak;\r\ncase 2:\r\npciercx_cfg448.s.rtl = 867;\r\nbreak;\r\ncase 4:\r\npciercx_cfg448.s.rtl = 462;\r\nbreak;\r\ncase 8:\r\npciercx_cfg448.s.rtl = 258;\r\nbreak;\r\n}\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG448(pcie_port), pciercx_cfg448.u32);\r\nreturn 0;\r\n}\r\nstatic void __cvmx_increment_ba(union cvmx_sli_mem_access_subidx *pmas)\r\n{\r\nif (OCTEON_IS_MODEL(OCTEON_CN68XX))\r\npmas->cn68xx.ba++;\r\nelse\r\npmas->cn63xx.ba++;\r\n}\r\nstatic int __cvmx_pcie_rc_initialize_gen1(int pcie_port)\r\n{\r\nint i;\r\nint base;\r\nu64 addr_swizzle;\r\nunion cvmx_ciu_soft_prst ciu_soft_prst;\r\nunion cvmx_pescx_bist_status pescx_bist_status;\r\nunion cvmx_pescx_bist_status2 pescx_bist_status2;\r\nunion cvmx_npei_ctl_status npei_ctl_status;\r\nunion cvmx_npei_mem_access_ctl npei_mem_access_ctl;\r\nunion cvmx_npei_mem_access_subidx mem_access_subid;\r\nunion cvmx_npei_dbg_data npei_dbg_data;\r\nunion cvmx_pescx_ctl_status2 pescx_ctl_status2;\r\nunion cvmx_pciercx_cfg032 pciercx_cfg032;\r\nunion cvmx_npei_bar1_indexx bar1_index;\r\nretry:\r\nnpei_ctl_status.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_CTL_STATUS);\r\nif ((pcie_port == 0) && !npei_ctl_status.s.host_mode) {\r\ncvmx_dprintf("PCIe: Port %d in endpoint mode\n", pcie_port);\r\nreturn -1;\r\n}\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX)) {\r\nnpei_dbg_data.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_DBG_DATA);\r\nif ((pcie_port == 1) && npei_dbg_data.cn52xx.qlm0_link_width) {\r\ncvmx_dprintf("PCIe: ERROR: cvmx_pcie_rc_initialize() called on port1, but port1 is disabled\n");\r\nreturn -1;\r\n}\r\n}\r\nnpei_ctl_status.s.arb = 1;\r\nnpei_ctl_status.s.cfg_rtry = 0x20;\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_X)) {\r\nnpei_ctl_status.s.p0_ntags = 0x20;\r\nnpei_ctl_status.s.p1_ntags = 0x20;\r\n}\r\ncvmx_write_csr(CVMX_PEXP_NPEI_CTL_STATUS, npei_ctl_status.u64);\r\nif (cvmx_sysinfo_get()->board_type == CVMX_BOARD_TYPE_EBH5200) {\r\nif (pcie_port == 0) {\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nif (ciu_soft_prst.s.soft_prst == 0) {\r\nciu_soft_prst.s.soft_prst = 1;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nciu_soft_prst.s.soft_prst = 1;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\nudelay(2000);\r\n}\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\n}\r\n} else {\r\nif (pcie_port)\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nelse\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nif (ciu_soft_prst.s.soft_prst == 0) {\r\nciu_soft_prst.s.soft_prst = 1;\r\nif (pcie_port)\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\nelse\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\nudelay(2000);\r\n}\r\nif (pcie_port) {\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\n} else {\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\n}\r\n}\r\ncvmx_wait(400000);\r\nif (!OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_X) && !OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_X)) {\r\npescx_ctl_status2.u64 = cvmx_read_csr(CVMX_PESCX_CTL_STATUS2(pcie_port));\r\npescx_ctl_status2.s.pclk_run = 1;\r\ncvmx_write_csr(CVMX_PESCX_CTL_STATUS2(pcie_port), pescx_ctl_status2.u64);\r\nif (CVMX_WAIT_FOR_FIELD64(CVMX_PESCX_CTL_STATUS2(pcie_port),\r\nunion cvmx_pescx_ctl_status2, pclk_run, ==, 1, 10000)) {\r\ncvmx_dprintf("PCIe: Port %d isn't clocked, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\n}\r\npescx_ctl_status2.u64 = cvmx_read_csr(CVMX_PESCX_CTL_STATUS2(pcie_port));\r\nif (pescx_ctl_status2.s.pcierst) {\r\ncvmx_dprintf("PCIe: Port %d stuck in reset, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\npescx_bist_status2.u64 = cvmx_read_csr(CVMX_PESCX_BIST_STATUS2(pcie_port));\r\nif (pescx_bist_status2.u64) {\r\ncvmx_dprintf("PCIe: Port %d BIST2 failed. Most likely this port isn't hooked up, skipping.\n",\r\npcie_port);\r\nreturn -1;\r\n}\r\npescx_bist_status.u64 = cvmx_read_csr(CVMX_PESCX_BIST_STATUS(pcie_port));\r\nif (pescx_bist_status.u64)\r\ncvmx_dprintf("PCIe: BIST FAILED for port %d (0x%016llx)\n",\r\npcie_port, CAST64(pescx_bist_status.u64));\r\n__cvmx_pcie_rc_initialize_config_space(pcie_port);\r\nif (__cvmx_pcie_rc_initialize_link_gen1(pcie_port)) {\r\ncvmx_dprintf("PCIe: Failed to initialize port %d, probably the slot is empty\n",\r\npcie_port);\r\nreturn -1;\r\n}\r\nnpei_mem_access_ctl.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_MEM_ACCESS_CTL);\r\nnpei_mem_access_ctl.s.max_word = 0;\r\nnpei_mem_access_ctl.s.timer = 127;\r\ncvmx_write_csr(CVMX_PEXP_NPEI_MEM_ACCESS_CTL, npei_mem_access_ctl.u64);\r\nmem_access_subid.u64 = 0;\r\nmem_access_subid.s.port = pcie_port;\r\nmem_access_subid.s.nmerge = 1;\r\nmem_access_subid.s.esr = 1;\r\nmem_access_subid.s.esw = 1;\r\nmem_access_subid.s.nsr = 0;\r\nmem_access_subid.s.nsw = 0;\r\nmem_access_subid.s.ror = 0;\r\nmem_access_subid.s.row = 0;\r\nmem_access_subid.s.ba = 0;\r\nfor (i = 12 + pcie_port * 4; i < 16 + pcie_port * 4; i++) {\r\ncvmx_write_csr(CVMX_PEXP_NPEI_MEM_ACCESS_SUBIDX(i), mem_access_subid.u64);\r\nmem_access_subid.s.ba += 1;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\ncvmx_write_csr(CVMX_PESCX_P2P_BARX_START(i, pcie_port), -1);\r\ncvmx_write_csr(CVMX_PESCX_P2P_BARX_END(i, pcie_port), -1);\r\n}\r\ncvmx_write_csr(CVMX_PESCX_P2N_BAR0_START(pcie_port), 0);\r\ncvmx_write_csr(CVMX_PESCX_P2N_BAR1_START(pcie_port), CVMX_PCIE_BAR1_RC_BASE);\r\nbar1_index.u32 = 0;\r\nbar1_index.s.addr_idx = (CVMX_PCIE_BAR1_PHYS_BASE >> 22);\r\nbar1_index.s.ca = 1;\r\nbar1_index.s.end_swp = 1;\r\nbar1_index.s.addr_v = 1;\r\nbase = pcie_port ? 16 : 0;\r\n#ifdef __MIPSEB__\r\naddr_swizzle = 4;\r\n#else\r\naddr_swizzle = 0;\r\n#endif\r\nfor (i = 0; i < 16; i++) {\r\ncvmx_write64_uint32((CVMX_PEXP_NPEI_BAR1_INDEXX(base) ^ addr_swizzle),\r\nbar1_index.u32);\r\nbase++;\r\nbar1_index.s.addr_idx += (((1ull << 28) / 16ull) >> 22);\r\n}\r\ncvmx_write_csr(CVMX_PESCX_P2N_BAR2_START(pcie_port), 0);\r\nif (pcie_port) {\r\nunion cvmx_npei_ctl_port1 npei_ctl_port;\r\nnpei_ctl_port.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_CTL_PORT1);\r\nnpei_ctl_port.s.bar2_enb = 1;\r\nnpei_ctl_port.s.bar2_esx = 1;\r\nnpei_ctl_port.s.bar2_cax = 0;\r\nnpei_ctl_port.s.ptlp_ro = 1;\r\nnpei_ctl_port.s.ctlp_ro = 1;\r\nnpei_ctl_port.s.wait_com = 0;\r\nnpei_ctl_port.s.waitl_com = 0;\r\ncvmx_write_csr(CVMX_PEXP_NPEI_CTL_PORT1, npei_ctl_port.u64);\r\n} else {\r\nunion cvmx_npei_ctl_port0 npei_ctl_port;\r\nnpei_ctl_port.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_CTL_PORT0);\r\nnpei_ctl_port.s.bar2_enb = 1;\r\nnpei_ctl_port.s.bar2_esx = 1;\r\nnpei_ctl_port.s.bar2_cax = 0;\r\nnpei_ctl_port.s.ptlp_ro = 1;\r\nnpei_ctl_port.s.ctlp_ro = 1;\r\nnpei_ctl_port.s.wait_com = 0;\r\nnpei_ctl_port.s.waitl_com = 0;\r\ncvmx_write_csr(CVMX_PEXP_NPEI_CTL_PORT0, npei_ctl_port.u64);\r\n}\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX_PASS2_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN52XX_PASS2_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_X)) {\r\nunion cvmx_npei_dbg_data dbg_data;\r\nint old_in_fif_p_count;\r\nint in_fif_p_count;\r\nint out_p_count;\r\nint in_p_offset = (OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_X) || OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_X)) ? 4 : 1;\r\nint i;\r\nuint64_t write_address = (cvmx_pcie_get_mem_base_address(pcie_port) + 0x100000) | (1ull<<63);\r\ni = in_p_offset;\r\nwhile (i--) {\r\ncvmx_write64_uint32(write_address, 0);\r\ncvmx_wait(10000);\r\n}\r\ncvmx_write_csr(CVMX_PEXP_NPEI_DBG_SELECT, (pcie_port) ? 0xd7fc : 0xcffc);\r\ncvmx_read_csr(CVMX_PEXP_NPEI_DBG_SELECT);\r\ndo {\r\ndbg_data.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_DBG_DATA);\r\nold_in_fif_p_count = dbg_data.s.data & 0xff;\r\ncvmx_write64_uint32(write_address, 0);\r\ncvmx_wait(10000);\r\ndbg_data.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_DBG_DATA);\r\nin_fif_p_count = dbg_data.s.data & 0xff;\r\n} while (in_fif_p_count != ((old_in_fif_p_count+1) & 0xff));\r\nin_fif_p_count = (in_fif_p_count + in_p_offset) & 0xff;\r\ncvmx_write_csr(CVMX_PEXP_NPEI_DBG_SELECT, (pcie_port) ? 0xd00f : 0xc80f);\r\ncvmx_read_csr(CVMX_PEXP_NPEI_DBG_SELECT);\r\ndbg_data.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_DBG_DATA);\r\nout_p_count = (dbg_data.s.data>>1) & 0xff;\r\nif (out_p_count != in_fif_p_count) {\r\ncvmx_dprintf("PCIe: Port %d aligning TLP counters as workaround to maintain ordering\n", pcie_port);\r\nwhile (in_fif_p_count != 0) {\r\ncvmx_write64_uint32(write_address, 0);\r\ncvmx_wait(10000);\r\nin_fif_p_count = (in_fif_p_count + 1) & 0xff;\r\n}\r\nif ((cvmx_sysinfo_get()->board_type == CVMX_BOARD_TYPE_EBH5200) &&\r\n(pcie_port == 1))\r\ncvmx_pcie_rc_initialize(0);\r\ngoto retry;\r\n}\r\n}\r\npciercx_cfg032.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG032(pcie_port));\r\ncvmx_dprintf("PCIe: Port %d link active, %d lanes\n", pcie_port, pciercx_cfg032.s.nlw);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_pcie_rc_initialize_link_gen2(int pcie_port)\r\n{\r\nuint64_t start_cycle;\r\nunion cvmx_pemx_ctl_status pem_ctl_status;\r\nunion cvmx_pciercx_cfg032 pciercx_cfg032;\r\nunion cvmx_pciercx_cfg448 pciercx_cfg448;\r\npem_ctl_status.u64 = cvmx_read_csr(CVMX_PEMX_CTL_STATUS(pcie_port));\r\npem_ctl_status.s.lnk_enb = 1;\r\ncvmx_write_csr(CVMX_PEMX_CTL_STATUS(pcie_port), pem_ctl_status.u64);\r\nstart_cycle = cvmx_get_cycle();\r\ndo {\r\nif (cvmx_get_cycle() - start_cycle > octeon_get_clock_rate())\r\nreturn -1;\r\ncvmx_wait(10000);\r\npciercx_cfg032.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG032(pcie_port));\r\n} while ((pciercx_cfg032.s.dlla == 0) || (pciercx_cfg032.s.lt == 1));\r\npciercx_cfg448.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG448(pcie_port));\r\nswitch (pciercx_cfg032.s.nlw) {\r\ncase 1:\r\npciercx_cfg448.s.rtl = 1677;\r\nbreak;\r\ncase 2:\r\npciercx_cfg448.s.rtl = 867;\r\nbreak;\r\ncase 4:\r\npciercx_cfg448.s.rtl = 462;\r\nbreak;\r\ncase 8:\r\npciercx_cfg448.s.rtl = 258;\r\nbreak;\r\n}\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG448(pcie_port), pciercx_cfg448.u32);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_pcie_rc_initialize_gen2(int pcie_port)\r\n{\r\nint i;\r\nunion cvmx_ciu_soft_prst ciu_soft_prst;\r\nunion cvmx_mio_rst_ctlx mio_rst_ctl;\r\nunion cvmx_pemx_bar_ctl pemx_bar_ctl;\r\nunion cvmx_pemx_ctl_status pemx_ctl_status;\r\nunion cvmx_pemx_bist_status pemx_bist_status;\r\nunion cvmx_pemx_bist_status2 pemx_bist_status2;\r\nunion cvmx_pciercx_cfg032 pciercx_cfg032;\r\nunion cvmx_pciercx_cfg515 pciercx_cfg515;\r\nunion cvmx_sli_ctl_portx sli_ctl_portx;\r\nunion cvmx_sli_mem_access_ctl sli_mem_access_ctl;\r\nunion cvmx_sli_mem_access_subidx mem_access_subid;\r\nunion cvmx_sriox_status_reg sriox_status_reg;\r\nunion cvmx_pemx_bar1_indexx bar1_index;\r\nif (octeon_has_feature(OCTEON_FEATURE_SRIO)) {\r\nif (OCTEON_IS_MODEL(OCTEON_CN66XX)) {\r\nunion cvmx_mio_qlmx_cfg qlmx_cfg;\r\nqlmx_cfg.u64 = cvmx_read_csr(CVMX_MIO_QLMX_CFG(pcie_port));\r\nif (qlmx_cfg.s.qlm_spd == 15) {\r\npr_notice("PCIe: Port %d is disabled, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\nswitch (qlmx_cfg.s.qlm_spd) {\r\ncase 0x1:\r\ncase 0x3:\r\ncase 0x4:\r\ncase 0x6:\r\npr_notice("PCIe: Port %d is SRIO, skipping.\n", pcie_port);\r\nreturn -1;\r\ncase 0x9:\r\npr_notice("PCIe: Port %d is SGMII, skipping.\n", pcie_port);\r\nreturn -1;\r\ncase 0xb:\r\npr_notice("PCIe: Port %d is XAUI, skipping.\n", pcie_port);\r\nreturn -1;\r\ncase 0x0:\r\ncase 0x8:\r\ncase 0x2:\r\ncase 0xa:\r\nbreak;\r\ndefault:\r\npr_notice("PCIe: Port %d is unknown, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\n} else {\r\nsriox_status_reg.u64 = cvmx_read_csr(CVMX_SRIOX_STATUS_REG(pcie_port));\r\nif (sriox_status_reg.s.srio) {\r\npr_notice("PCIe: Port %d is SRIO, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\n}\r\n}\r\n#if 0\r\npr_notice("PCIE : init for pcie analyzer.\n");\r\ncvmx_helper_qlm_jtag_init();\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 85);\r\ncvmx_helper_qlm_jtag_shift(pcie_port, 1, 1);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 300-86);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 85);\r\ncvmx_helper_qlm_jtag_shift(pcie_port, 1, 1);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 300-86);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 85);\r\ncvmx_helper_qlm_jtag_shift(pcie_port, 1, 1);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 300-86);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 85);\r\ncvmx_helper_qlm_jtag_shift(pcie_port, 1, 1);\r\ncvmx_helper_qlm_jtag_shift_zeros(pcie_port, 300-86);\r\ncvmx_helper_qlm_jtag_update(pcie_port);\r\n#endif\r\nmio_rst_ctl.u64 = cvmx_read_csr(CVMX_MIO_RST_CTLX(pcie_port));\r\nif (!mio_rst_ctl.s.host_mode) {\r\npr_notice("PCIe: Port %d in endpoint mode.\n", pcie_port);\r\nreturn -1;\r\n}\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_0)) {\r\nif (pcie_port) {\r\nunion cvmx_ciu_qlm1 ciu_qlm;\r\nciu_qlm.u64 = cvmx_read_csr(CVMX_CIU_QLM1);\r\nciu_qlm.s.txbypass = 1;\r\nciu_qlm.s.txdeemph = 5;\r\nciu_qlm.s.txmargin = 0x17;\r\ncvmx_write_csr(CVMX_CIU_QLM1, ciu_qlm.u64);\r\n} else {\r\nunion cvmx_ciu_qlm0 ciu_qlm;\r\nciu_qlm.u64 = cvmx_read_csr(CVMX_CIU_QLM0);\r\nciu_qlm.s.txbypass = 1;\r\nciu_qlm.s.txdeemph = 5;\r\nciu_qlm.s.txmargin = 0x17;\r\ncvmx_write_csr(CVMX_CIU_QLM0, ciu_qlm.u64);\r\n}\r\n}\r\nif (pcie_port)\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nelse\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nif (ciu_soft_prst.s.soft_prst == 0) {\r\nciu_soft_prst.s.soft_prst = 1;\r\nif (pcie_port)\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\nelse\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\nudelay(2000);\r\n}\r\nif (pcie_port) {\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST1);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST1, ciu_soft_prst.u64);\r\n} else {\r\nciu_soft_prst.u64 = cvmx_read_csr(CVMX_CIU_SOFT_PRST);\r\nciu_soft_prst.s.soft_prst = 0;\r\ncvmx_write_csr(CVMX_CIU_SOFT_PRST, ciu_soft_prst.u64);\r\n}\r\nudelay(1000);\r\nif (CVMX_WAIT_FOR_FIELD64(CVMX_MIO_RST_CTLX(pcie_port), union cvmx_mio_rst_ctlx, rst_done, ==, 1, 10000)) {\r\npr_notice("PCIe: Port %d stuck in reset, skipping.\n", pcie_port);\r\nreturn -1;\r\n}\r\npemx_bist_status.u64 = cvmx_read_csr(CVMX_PEMX_BIST_STATUS(pcie_port));\r\nif (pemx_bist_status.u64)\r\npr_notice("PCIe: BIST FAILED for port %d (0x%016llx)\n", pcie_port, CAST64(pemx_bist_status.u64));\r\npemx_bist_status2.u64 = cvmx_read_csr(CVMX_PEMX_BIST_STATUS2(pcie_port));\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X))\r\npemx_bist_status2.u64 &= ~0x3full;\r\nif (pemx_bist_status2.u64)\r\npr_notice("PCIe: BIST2 FAILED for port %d (0x%016llx)\n", pcie_port, CAST64(pemx_bist_status2.u64));\r\n__cvmx_pcie_rc_initialize_config_space(pcie_port);\r\npciercx_cfg515.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG515(pcie_port));\r\npciercx_cfg515.s.dsc = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG515(pcie_port), pciercx_cfg515.u32);\r\nif (__cvmx_pcie_rc_initialize_link_gen2(pcie_port)) {\r\nunion cvmx_pciercx_cfg031 pciercx_cfg031;\r\npciercx_cfg031.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG031(pcie_port));\r\npciercx_cfg031.s.mls = 1;\r\ncvmx_pcie_cfgx_write(pcie_port, CVMX_PCIERCX_CFG031(pcie_port), pciercx_cfg031.u32);\r\nif (__cvmx_pcie_rc_initialize_link_gen2(pcie_port)) {\r\npr_notice("PCIe: Link timeout on port %d, probably the slot is empty\n", pcie_port);\r\nreturn -1;\r\n}\r\n}\r\nsli_mem_access_ctl.u64 = cvmx_read_csr(CVMX_PEXP_SLI_MEM_ACCESS_CTL);\r\nsli_mem_access_ctl.s.max_word = 0;\r\nsli_mem_access_ctl.s.timer = 127;\r\ncvmx_write_csr(CVMX_PEXP_SLI_MEM_ACCESS_CTL, sli_mem_access_ctl.u64);\r\nmem_access_subid.u64 = 0;\r\nmem_access_subid.s.port = pcie_port;\r\nmem_access_subid.s.nmerge = 0;\r\nmem_access_subid.s.esr = 1;\r\nmem_access_subid.s.esw = 1;\r\nmem_access_subid.s.wtype = 0;\r\nmem_access_subid.s.rtype = 0;\r\nif (OCTEON_IS_MODEL(OCTEON_CN68XX))\r\nmem_access_subid.cn68xx.ba = 0;\r\nelse\r\nmem_access_subid.cn63xx.ba = 0;\r\nfor (i = 12 + pcie_port * 4; i < 16 + pcie_port * 4; i++) {\r\ncvmx_write_csr(CVMX_PEXP_SLI_MEM_ACCESS_SUBIDX(i), mem_access_subid.u64);\r\n__cvmx_increment_ba(&mem_access_subid);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\ncvmx_write_csr(CVMX_PEMX_P2P_BARX_START(i, pcie_port), -1);\r\ncvmx_write_csr(CVMX_PEMX_P2P_BARX_END(i, pcie_port), -1);\r\n}\r\ncvmx_write_csr(CVMX_PEMX_P2N_BAR0_START(pcie_port), 0);\r\ncvmx_write_csr(CVMX_PEMX_P2N_BAR2_START(pcie_port), 0);\r\npemx_bar_ctl.u64 = cvmx_read_csr(CVMX_PEMX_BAR_CTL(pcie_port));\r\npemx_bar_ctl.s.bar1_siz = 3;\r\npemx_bar_ctl.s.bar2_enb = 1;\r\npemx_bar_ctl.s.bar2_esx = 1;\r\npemx_bar_ctl.s.bar2_cax = 0;\r\ncvmx_write_csr(CVMX_PEMX_BAR_CTL(pcie_port), pemx_bar_ctl.u64);\r\nsli_ctl_portx.u64 = cvmx_read_csr(CVMX_PEXP_SLI_CTL_PORTX(pcie_port));\r\nsli_ctl_portx.s.ptlp_ro = 1;\r\nsli_ctl_portx.s.ctlp_ro = 1;\r\nsli_ctl_portx.s.wait_com = 0;\r\nsli_ctl_portx.s.waitl_com = 0;\r\ncvmx_write_csr(CVMX_PEXP_SLI_CTL_PORTX(pcie_port), sli_ctl_portx.u64);\r\ncvmx_write_csr(CVMX_PEMX_P2N_BAR1_START(pcie_port), CVMX_PCIE_BAR1_RC_BASE);\r\nbar1_index.u64 = 0;\r\nbar1_index.s.addr_idx = (CVMX_PCIE_BAR1_PHYS_BASE >> 22);\r\nbar1_index.s.ca = 1;\r\nbar1_index.s.end_swp = 1;\r\nbar1_index.s.addr_v = 1;\r\nfor (i = 0; i < 16; i++) {\r\ncvmx_write_csr(CVMX_PEMX_BAR1_INDEXX(i, pcie_port), bar1_index.u64);\r\nbar1_index.s.addr_idx += (((1ull << 28) / 16ull) >> 22);\r\n}\r\npemx_ctl_status.u64 = cvmx_read_csr(CVMX_PEMX_CTL_STATUS(pcie_port));\r\npemx_ctl_status.s.cfg_rtry = 250 * 5000000 / 0x10000;\r\ncvmx_write_csr(CVMX_PEMX_CTL_STATUS(pcie_port), pemx_ctl_status.u64);\r\npciercx_cfg032.u32 = cvmx_pcie_cfgx_read(pcie_port, CVMX_PCIERCX_CFG032(pcie_port));\r\npr_notice("PCIe: Port %d link active, %d lanes, speed gen%d\n", pcie_port, pciercx_cfg032.s.nlw, pciercx_cfg032.s.ls);\r\nreturn 0;\r\n}\r\nstatic int cvmx_pcie_rc_initialize(int pcie_port)\r\n{\r\nint result;\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI))\r\nresult = __cvmx_pcie_rc_initialize_gen1(pcie_port);\r\nelse\r\nresult = __cvmx_pcie_rc_initialize_gen2(pcie_port);\r\nreturn result;\r\n}\r\nint __init octeon_pcie_pcibios_map_irq(const struct pci_dev *dev,\r\nu8 slot, u8 pin)\r\n{\r\nif (strstr(octeon_board_type_string(), "EBH5600") &&\r\ndev->bus && dev->bus->parent) {\r\nwhile (dev->bus && dev->bus->parent)\r\ndev = to_pci_dev(dev->bus->bridge);\r\nif ((dev->bus->number == 1) &&\r\n(dev->vendor == 0x10b5) && (dev->device == 0x8114)) {\r\npin = ((pin - 3) & 3) + 1;\r\n}\r\n}\r\nreturn pin - 1 + OCTEON_IRQ_PCI_INT0;\r\n}\r\nstatic void set_cfg_read_retry(u32 retry_cnt)\r\n{\r\nunion cvmx_pemx_ctl_status pemx_ctl;\r\npemx_ctl.u64 = cvmx_read_csr(CVMX_PEMX_CTL_STATUS(1));\r\npemx_ctl.s.cfg_rtry = retry_cnt;\r\ncvmx_write_csr(CVMX_PEMX_CTL_STATUS(1), pemx_ctl.u64);\r\n}\r\nstatic u32 disable_cfg_read_retry(void)\r\n{\r\nu32 retry_cnt;\r\nunion cvmx_pemx_ctl_status pemx_ctl;\r\npemx_ctl.u64 = cvmx_read_csr(CVMX_PEMX_CTL_STATUS(1));\r\nretry_cnt = pemx_ctl.s.cfg_rtry;\r\npemx_ctl.s.cfg_rtry = 0;\r\ncvmx_write_csr(CVMX_PEMX_CTL_STATUS(1), pemx_ctl.u64);\r\nreturn retry_cnt;\r\n}\r\nstatic int is_cfg_retry(void)\r\n{\r\nunion cvmx_pemx_int_sum pemx_int_sum;\r\npemx_int_sum.u64 = cvmx_read_csr(CVMX_PEMX_INT_SUM(1));\r\nif (pemx_int_sum.s.crs_dr)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int octeon_pcie_read_config(unsigned int pcie_port, struct pci_bus *bus,\r\nunsigned int devfn, int reg, int size,\r\nu32 *val)\r\n{\r\nunion octeon_cvmemctl cvmmemctl;\r\nunion octeon_cvmemctl cvmmemctl_save;\r\nint bus_number = bus->number;\r\nint cfg_retry = 0;\r\nint retry_cnt = 0;\r\nint max_retry_cnt = 10;\r\nu32 cfg_retry_cnt = 0;\r\ncvmmemctl_save.u64 = 0;\r\nBUG_ON(pcie_port >= ARRAY_SIZE(enable_pcie_bus_num_war));\r\nif (bus->parent == NULL) {\r\nif (enable_pcie_bus_num_war[pcie_port])\r\nbus_number = 0;\r\nelse {\r\nunion cvmx_pciercx_cfg006 pciercx_cfg006;\r\npciercx_cfg006.u32 = cvmx_pcie_cfgx_read(pcie_port,\r\nCVMX_PCIERCX_CFG006(pcie_port));\r\nif (pciercx_cfg006.s.pbnum != bus_number) {\r\npciercx_cfg006.s.pbnum = bus_number;\r\npciercx_cfg006.s.sbnum = bus_number;\r\npciercx_cfg006.s.subbnum = bus_number;\r\ncvmx_pcie_cfgx_write(pcie_port,\r\nCVMX_PCIERCX_CFG006(pcie_port),\r\npciercx_cfg006.u32);\r\n}\r\n}\r\n}\r\nif ((bus->parent == NULL) && (devfn >> 3 != 0))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1) ||\r\nOCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_1)) {\r\nif ((bus->parent == NULL) && (devfn >= 2))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#if 1\r\nif (bus_number == 2)\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#elif 0\r\nif ((bus_number == 2) && (devfn >> 3 != 2))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#elif 0\r\nif ((bus_number == 2) && (devfn >> 3 != 3))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#elif 0\r\nif ((bus_number == 2) &&\r\n!((devfn == (2 << 3)) || (devfn == (3 << 3))))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#endif\r\n#if 0\r\nif ((bus_number == 4) &&\r\n!((devfn >> 3 >= 1) && (devfn >> 3 <= 4)))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif ((bus_number == 5) && (devfn >> 3 != 0))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif ((bus_number == 6) && (devfn >> 3 != 0))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif ((bus_number == 7) && (devfn >> 3 != 0))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif ((bus_number == 8) && (devfn >> 3 != 0))\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n#endif\r\ncvmmemctl_save.u64 = __read_64bit_c0_register($11, 7);\r\ncvmmemctl.u64 = cvmmemctl_save.u64;\r\ncvmmemctl.s.didtto = 2;\r\n__write_64bit_c0_register($11, 7, cvmmemctl.u64);\r\n}\r\nif ((OCTEON_IS_MODEL(OCTEON_CN63XX)) && (enable_pcie_14459_war))\r\ncfg_retry_cnt = disable_cfg_read_retry();\r\npr_debug("pcie_cfg_rd port=%d b=%d devfn=0x%03x reg=0x%03x"\r\n" size=%d ", pcie_port, bus_number, devfn, reg, size);\r\ndo {\r\nswitch (size) {\r\ncase 4:\r\n*val = cvmx_pcie_config_read32(pcie_port, bus_number,\r\ndevfn >> 3, devfn & 0x7, reg);\r\nbreak;\r\ncase 2:\r\n*val = cvmx_pcie_config_read16(pcie_port, bus_number,\r\ndevfn >> 3, devfn & 0x7, reg);\r\nbreak;\r\ncase 1:\r\n*val = cvmx_pcie_config_read8(pcie_port, bus_number,\r\ndevfn >> 3, devfn & 0x7, reg);\r\nbreak;\r\ndefault:\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX))\r\nset_cfg_read_retry(cfg_retry_cnt);\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nif ((OCTEON_IS_MODEL(OCTEON_CN63XX)) &&\r\n(enable_pcie_14459_war)) {\r\ncfg_retry = is_cfg_retry();\r\nretry_cnt++;\r\nif (retry_cnt > max_retry_cnt) {\r\npr_err(" pcie cfg_read retries failed. retry_cnt=%d\n",\r\nretry_cnt);\r\ncfg_retry = 0;\r\n}\r\n}\r\n} while (cfg_retry);\r\nif ((OCTEON_IS_MODEL(OCTEON_CN63XX)) && (enable_pcie_14459_war))\r\nset_cfg_read_retry(cfg_retry_cnt);\r\npr_debug("val=%08x : tries=%02d\n", *val, retry_cnt);\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1) ||\r\nOCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_1))\r\nwrite_c0_cvmmemctl(cvmmemctl_save.u64);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int octeon_pcie0_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 *val)\r\n{\r\nreturn octeon_pcie_read_config(0, bus, devfn, reg, size, val);\r\n}\r\nstatic int octeon_pcie1_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 *val)\r\n{\r\nreturn octeon_pcie_read_config(1, bus, devfn, reg, size, val);\r\n}\r\nstatic int octeon_dummy_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 *val)\r\n{\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nstatic int octeon_pcie_write_config(unsigned int pcie_port, struct pci_bus *bus,\r\nunsigned int devfn, int reg,\r\nint size, u32 val)\r\n{\r\nint bus_number = bus->number;\r\nBUG_ON(pcie_port >= ARRAY_SIZE(enable_pcie_bus_num_war));\r\nif ((bus->parent == NULL) && (enable_pcie_bus_num_war[pcie_port]))\r\nbus_number = 0;\r\npr_debug("pcie_cfg_wr port=%d b=%d devfn=0x%03x"\r\n" reg=0x%03x size=%d val=%08x\n", pcie_port, bus_number, devfn,\r\nreg, size, val);\r\nswitch (size) {\r\ncase 4:\r\ncvmx_pcie_config_write32(pcie_port, bus_number, devfn >> 3,\r\ndevfn & 0x7, reg, val);\r\nbreak;\r\ncase 2:\r\ncvmx_pcie_config_write16(pcie_port, bus_number, devfn >> 3,\r\ndevfn & 0x7, reg, val);\r\nbreak;\r\ncase 1:\r\ncvmx_pcie_config_write8(pcie_port, bus_number, devfn >> 3,\r\ndevfn & 0x7, reg, val);\r\nbreak;\r\ndefault:\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int octeon_pcie0_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 val)\r\n{\r\nreturn octeon_pcie_write_config(0, bus, devfn, reg, size, val);\r\n}\r\nstatic int octeon_pcie1_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 val)\r\n{\r\nreturn octeon_pcie_write_config(1, bus, devfn, reg, size, val);\r\n}\r\nstatic int octeon_dummy_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 val)\r\n{\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nstatic int device_needs_bus_num_war(uint32_t deviceid)\r\n{\r\n#define IDT_VENDOR_ID 0x111d\r\nif ((deviceid & 0xffff) == IDT_VENDOR_ID)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int __init octeon_pcie_setup(void)\r\n{\r\nint result;\r\nint host_mode;\r\nint srio_war15205 = 0, port;\r\nunion cvmx_sli_ctl_portx sli_ctl_portx;\r\nunion cvmx_sriox_status_reg sriox_status_reg;\r\nif (!octeon_has_feature(OCTEON_FEATURE_PCIE))\r\nreturn 0;\r\nif (octeon_is_simulation())\r\nreturn 0;\r\nif (pcie_disable)\r\nreturn 0;\r\nocteon_pcibios_map_irq = octeon_pcie_pcibios_map_irq;\r\nset_io_port_base(CVMX_ADD_IO_SEG(cvmx_pcie_get_io_base_address(0)));\r\nioport_resource.start = 0;\r\nioport_resource.end =\r\ncvmx_pcie_get_io_base_address(1) -\r\ncvmx_pcie_get_io_base_address(0) + cvmx_pcie_get_io_size(1) - 1;\r\nocteon_dummy_controller.io_map_base = -1;\r\nocteon_dummy_controller.mem_resource->start = (1ull<<48);\r\nocteon_dummy_controller.mem_resource->end = (1ull<<48);\r\nregister_pci_controller(&octeon_dummy_controller);\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI)) {\r\nunion cvmx_npei_ctl_status npei_ctl_status;\r\nnpei_ctl_status.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_CTL_STATUS);\r\nhost_mode = npei_ctl_status.s.host_mode;\r\nocteon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE;\r\n} else {\r\nunion cvmx_mio_rst_ctlx mio_rst_ctl;\r\nmio_rst_ctl.u64 = cvmx_read_csr(CVMX_MIO_RST_CTLX(0));\r\nhost_mode = mio_rst_ctl.s.host_mode;\r\nocteon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE2;\r\n}\r\nif (host_mode) {\r\npr_notice("PCIe: Initializing port 0\n");\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN63XX_PASS2_0)) {\r\nsriox_status_reg.u64 = cvmx_read_csr(CVMX_SRIOX_STATUS_REG(0));\r\nif (sriox_status_reg.s.srio) {\r\nsrio_war15205 += 1;\r\nport = 0;\r\n}\r\n}\r\nresult = cvmx_pcie_rc_initialize(0);\r\nif (result == 0) {\r\nuint32_t device0;\r\nocteon_pcie0_controller.mem_offset =\r\ncvmx_pcie_get_mem_base_address(0);\r\nocteon_pcie0_controller.io_map_base =\r\nCVMX_ADD_IO_SEG(cvmx_pcie_get_io_base_address\r\n(0));\r\nocteon_pcie0_controller.io_offset = 0;\r\nocteon_pcie0_controller.mem_resource->start =\r\ncvmx_pcie_get_mem_base_address(0) +\r\n(4ul << 30) - (OCTEON_PCI_BAR1_HOLE_SIZE << 20);\r\nocteon_pcie0_controller.mem_resource->end =\r\ncvmx_pcie_get_mem_base_address(0) +\r\ncvmx_pcie_get_mem_size(0) - 1;\r\nocteon_pcie0_controller.io_resource->start = 4 << 10;\r\nocteon_pcie0_controller.io_resource->end =\r\ncvmx_pcie_get_io_size(0) - 1;\r\nmsleep(100);\r\nregister_pci_controller(&octeon_pcie0_controller);\r\ndevice0 = cvmx_pcie_config_read32(0, 0, 0, 0, 0);\r\nenable_pcie_bus_num_war[0] =\r\ndevice_needs_bus_num_war(device0);\r\n}\r\n} else {\r\npr_notice("PCIe: Port 0 in endpoint mode, skipping.\n");\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN63XX_PASS2_0)) {\r\nsrio_war15205 += 1;\r\nport = 0;\r\n}\r\n}\r\nif (octeon_has_feature(OCTEON_FEATURE_NPEI)) {\r\nhost_mode = 1;\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX)) {\r\nunion cvmx_npei_dbg_data dbg_data;\r\ndbg_data.u64 = cvmx_read_csr(CVMX_PEXP_NPEI_DBG_DATA);\r\nif (dbg_data.cn52xx.qlm0_link_width)\r\nhost_mode = 0;\r\n}\r\n} else {\r\nunion cvmx_mio_rst_ctlx mio_rst_ctl;\r\nmio_rst_ctl.u64 = cvmx_read_csr(CVMX_MIO_RST_CTLX(1));\r\nhost_mode = mio_rst_ctl.s.host_mode;\r\n}\r\nif (host_mode) {\r\npr_notice("PCIe: Initializing port 1\n");\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN63XX_PASS2_0)) {\r\nsriox_status_reg.u64 = cvmx_read_csr(CVMX_SRIOX_STATUS_REG(1));\r\nif (sriox_status_reg.s.srio) {\r\nsrio_war15205 += 1;\r\nport = 1;\r\n}\r\n}\r\nresult = cvmx_pcie_rc_initialize(1);\r\nif (result == 0) {\r\nuint32_t device0;\r\nocteon_pcie1_controller.mem_offset =\r\ncvmx_pcie_get_mem_base_address(1);\r\nocteon_pcie1_controller.io_map_base =\r\nCVMX_ADD_IO_SEG(cvmx_pcie_get_io_base_address(0));\r\nocteon_pcie1_controller.io_offset =\r\ncvmx_pcie_get_io_base_address(1) -\r\ncvmx_pcie_get_io_base_address(0);\r\nocteon_pcie1_controller.mem_resource->start =\r\ncvmx_pcie_get_mem_base_address(1) + (4ul << 30) -\r\n(OCTEON_PCI_BAR1_HOLE_SIZE << 20);\r\nocteon_pcie1_controller.mem_resource->end =\r\ncvmx_pcie_get_mem_base_address(1) +\r\ncvmx_pcie_get_mem_size(1) - 1;\r\nocteon_pcie1_controller.io_resource->start =\r\ncvmx_pcie_get_io_base_address(1) -\r\ncvmx_pcie_get_io_base_address(0);\r\nocteon_pcie1_controller.io_resource->end =\r\nocteon_pcie1_controller.io_resource->start +\r\ncvmx_pcie_get_io_size(1) - 1;\r\nmsleep(100);\r\nregister_pci_controller(&octeon_pcie1_controller);\r\ndevice0 = cvmx_pcie_config_read32(1, 0, 0, 0, 0);\r\nenable_pcie_bus_num_war[1] =\r\ndevice_needs_bus_num_war(device0);\r\n}\r\n} else {\r\npr_notice("PCIe: Port 1 not in root complex mode, skipping.\n");\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN63XX_PASS2_0)) {\r\nsrio_war15205 += 1;\r\nport = 1;\r\n}\r\n}\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN63XX_PASS2_0)) {\r\nif (srio_war15205 == 1) {\r\nsli_ctl_portx.u64 = cvmx_read_csr(CVMX_PEXP_SLI_CTL_PORTX(port));\r\nsli_ctl_portx.s.inta_map = 1;\r\nsli_ctl_portx.s.intb_map = 1;\r\nsli_ctl_portx.s.intc_map = 1;\r\nsli_ctl_portx.s.intd_map = 1;\r\ncvmx_write_csr(CVMX_PEXP_SLI_CTL_PORTX(port), sli_ctl_portx.u64);\r\nsli_ctl_portx.u64 = cvmx_read_csr(CVMX_PEXP_SLI_CTL_PORTX(!port));\r\nsli_ctl_portx.s.inta_map = 0;\r\nsli_ctl_portx.s.intb_map = 0;\r\nsli_ctl_portx.s.intc_map = 0;\r\nsli_ctl_portx.s.intd_map = 0;\r\ncvmx_write_csr(CVMX_PEXP_SLI_CTL_PORTX(!port), sli_ctl_portx.u64);\r\n}\r\n}\r\nocteon_pci_dma_init();\r\nreturn 0;\r\n}

static struct mdp5_kms *get_kms(struct drm_encoder *encoder)\r\n{\r\nstruct msm_drm_private *priv = encoder->dev->dev_private;\r\nreturn to_mdp5_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void bs_init(struct mdp5_encoder *mdp5_encoder)\r\n{\r\nmdp5_encoder->bsc = msm_bus_scale_register_client(\r\n&mdp_bus_scale_table);\r\nDBG("bus scale client: %08x", mdp5_encoder->bsc);\r\n}\r\nstatic void bs_fini(struct mdp5_encoder *mdp5_encoder)\r\n{\r\nif (mdp5_encoder->bsc) {\r\nmsm_bus_scale_unregister_client(mdp5_encoder->bsc);\r\nmdp5_encoder->bsc = 0;\r\n}\r\n}\r\nstatic void bs_set(struct mdp5_encoder *mdp5_encoder, int idx)\r\n{\r\nif (mdp5_encoder->bsc) {\r\nDBG("set bus scaling: %d", idx);\r\nidx = 1;\r\nmsm_bus_scale_client_update_request(mdp5_encoder->bsc, idx);\r\n}\r\n}\r\nstatic void bs_init(struct mdp5_encoder *mdp5_encoder) {}\r\nstatic void bs_fini(struct mdp5_encoder *mdp5_encoder) {}\r\nstatic void bs_set(struct mdp5_encoder *mdp5_encoder, int idx) {}\r\nstatic void mdp5_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nbs_fini(mdp5_encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(mdp5_encoder);\r\n}\r\nstatic void mdp5_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_kms *mdp5_kms = get_kms(encoder);\r\nstruct drm_device *dev = encoder->dev;\r\nstruct drm_connector *connector;\r\nint intf = mdp5_encoder->intf.num;\r\nuint32_t dtv_hsync_skew, vsync_period, vsync_len, ctrl_pol;\r\nuint32_t display_v_start, display_v_end;\r\nuint32_t hsync_start_x, hsync_end_x;\r\nuint32_t format = 0x2100;\r\nunsigned long flags;\r\nmode = adjusted_mode;\r\nDBG("set mode: %d:\"%s\" %d %d %d %d %d %d %d %d %d %d 0x%x 0x%x",\r\nmode->base.id, mode->name,\r\nmode->vrefresh, mode->clock,\r\nmode->hdisplay, mode->hsync_start,\r\nmode->hsync_end, mode->htotal,\r\nmode->vdisplay, mode->vsync_start,\r\nmode->vsync_end, mode->vtotal,\r\nmode->type, mode->flags);\r\nctrl_pol = 0;\r\nif (mdp5_encoder->intf.type != INTF_DSI) {\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nctrl_pol |= MDP5_INTF_POLARITY_CTL_HSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nctrl_pol |= MDP5_INTF_POLARITY_CTL_VSYNC_LOW;\r\n}\r\ndtv_hsync_skew = 0;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nswitch (connector->display_info.bpc) {\r\ncase 4:\r\nformat |= 0;\r\nbreak;\r\ncase 5:\r\nformat |= 0x15;\r\nbreak;\r\ncase 6:\r\nformat |= 0x2A;\r\nbreak;\r\ncase 8:\r\ndefault:\r\nformat |= 0x3F;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nhsync_start_x = (mode->htotal - mode->hsync_start);\r\nhsync_end_x = mode->htotal - (mode->hsync_start - mode->hdisplay) - 1;\r\nvsync_period = mode->vtotal * mode->htotal;\r\nvsync_len = (mode->vsync_end - mode->vsync_start) * mode->htotal;\r\ndisplay_v_start = (mode->vtotal - mode->vsync_start) * mode->htotal + dtv_hsync_skew;\r\ndisplay_v_end = vsync_period - ((mode->vsync_start - mode->vdisplay) * mode->htotal) + dtv_hsync_skew - 1;\r\nif (mdp5_encoder->intf.type == INTF_eDP) {\r\ndisplay_v_start += mode->htotal - mode->hsync_start;\r\ndisplay_v_end -= mode->hsync_start - mode->hdisplay;\r\n}\r\nspin_lock_irqsave(&mdp5_encoder->intf_lock, flags);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_HSYNC_CTL(intf),\r\nMDP5_INTF_HSYNC_CTL_PULSEW(mode->hsync_end - mode->hsync_start) |\r\nMDP5_INTF_HSYNC_CTL_PERIOD(mode->htotal));\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_VSYNC_PERIOD_F0(intf), vsync_period);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_VSYNC_LEN_F0(intf), vsync_len);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_DISPLAY_HCTL(intf),\r\nMDP5_INTF_DISPLAY_HCTL_START(hsync_start_x) |\r\nMDP5_INTF_DISPLAY_HCTL_END(hsync_end_x));\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_DISPLAY_VSTART_F0(intf), display_v_start);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_DISPLAY_VEND_F0(intf), display_v_end);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_BORDER_COLOR(intf), 0);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_UNDERFLOW_COLOR(intf), 0xff);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_HSYNC_SKEW(intf), dtv_hsync_skew);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_POLARITY_CTL(intf), ctrl_pol);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_ACTIVE_HCTL(intf),\r\nMDP5_INTF_ACTIVE_HCTL_START(0) |\r\nMDP5_INTF_ACTIVE_HCTL_END(0));\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_ACTIVE_VSTART_F0(intf), 0);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_ACTIVE_VEND_F0(intf), 0);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_PANEL_FORMAT(intf), format);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_FRAME_LINE_COUNT_EN(intf), 0x3);\r\nspin_unlock_irqrestore(&mdp5_encoder->intf_lock, flags);\r\nmdp5_crtc_set_pipeline(encoder->crtc, &mdp5_encoder->intf,\r\nmdp5_encoder->ctl);\r\n}\r\nstatic void mdp5_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_kms *mdp5_kms = get_kms(encoder);\r\nstruct mdp5_ctl *ctl = mdp5_encoder->ctl;\r\nint lm = mdp5_crtc_get_lm(encoder->crtc);\r\nstruct mdp5_interface *intf = &mdp5_encoder->intf;\r\nint intfn = mdp5_encoder->intf.num;\r\nunsigned long flags;\r\nif (WARN_ON(!mdp5_encoder->enabled))\r\nreturn;\r\nmdp5_ctl_set_encoder_state(ctl, false);\r\nspin_lock_irqsave(&mdp5_encoder->intf_lock, flags);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_TIMING_ENGINE_EN(intfn), 0);\r\nspin_unlock_irqrestore(&mdp5_encoder->intf_lock, flags);\r\nmdp5_ctl_commit(ctl, mdp_ctl_flush_mask_encoder(intf));\r\nmdp_irq_wait(&mdp5_kms->base, intf2vblank(lm, intf));\r\nbs_set(mdp5_encoder, 0);\r\nmdp5_encoder->enabled = false;\r\n}\r\nstatic void mdp5_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_kms *mdp5_kms = get_kms(encoder);\r\nstruct mdp5_ctl *ctl = mdp5_encoder->ctl;\r\nstruct mdp5_interface *intf = &mdp5_encoder->intf;\r\nint intfn = mdp5_encoder->intf.num;\r\nunsigned long flags;\r\nif (WARN_ON(mdp5_encoder->enabled))\r\nreturn;\r\nbs_set(mdp5_encoder, 1);\r\nspin_lock_irqsave(&mdp5_encoder->intf_lock, flags);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTF_TIMING_ENGINE_EN(intfn), 1);\r\nspin_unlock_irqrestore(&mdp5_encoder->intf_lock, flags);\r\nmdp5_ctl_commit(ctl, mdp_ctl_flush_mask_encoder(intf));\r\nmdp5_ctl_set_encoder_state(ctl, true);\r\nmdp5_encoder->enabled = true;\r\n}\r\nint mdp5_encoder_get_linecount(struct drm_encoder *encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_kms *mdp5_kms = get_kms(encoder);\r\nint intf = mdp5_encoder->intf.num;\r\nreturn mdp5_read(mdp5_kms, REG_MDP5_INTF_LINE_COUNT(intf));\r\n}\r\nu32 mdp5_encoder_get_framecount(struct drm_encoder *encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_kms *mdp5_kms = get_kms(encoder);\r\nint intf = mdp5_encoder->intf.num;\r\nreturn mdp5_read(mdp5_kms, REG_MDP5_INTF_FRAME_COUNT(intf));\r\n}\r\nint mdp5_encoder_set_split_display(struct drm_encoder *encoder,\r\nstruct drm_encoder *slave_encoder)\r\n{\r\nstruct mdp5_encoder *mdp5_encoder = to_mdp5_encoder(encoder);\r\nstruct mdp5_encoder *mdp5_slave_enc = to_mdp5_encoder(slave_encoder);\r\nstruct mdp5_kms *mdp5_kms;\r\nint intf_num;\r\nu32 data = 0;\r\nif (!encoder || !slave_encoder)\r\nreturn -EINVAL;\r\nmdp5_kms = get_kms(encoder);\r\nintf_num = mdp5_encoder->intf.num;\r\nif (intf_num == 1)\r\ndata |= MDP5_MDP_SPLIT_DPL_LOWER_INTF2_TG_SYNC;\r\nelse if (intf_num == 2)\r\ndata |= MDP5_MDP_SPLIT_DPL_LOWER_INTF1_TG_SYNC;\r\nelse\r\nreturn -EINVAL;\r\nmdp5_enable(mdp5_kms);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_SPLIT_DPL_UPPER(0), 0);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_SPLIT_DPL_LOWER(0), data);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_SPLIT_DPL_EN(0), 1);\r\nmdp5_ctl_pair(mdp5_encoder->ctl, mdp5_slave_enc->ctl, true);\r\nmdp5_disable(mdp5_kms);\r\nreturn 0;\r\n}\r\nstruct drm_encoder *mdp5_encoder_init(struct drm_device *dev,\r\nstruct mdp5_interface *intf, struct mdp5_ctl *ctl)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct mdp5_encoder *mdp5_encoder;\r\nint enc_type = (intf->type == INTF_DSI) ?\r\nDRM_MODE_ENCODER_DSI : DRM_MODE_ENCODER_TMDS;\r\nint ret;\r\nmdp5_encoder = kzalloc(sizeof(*mdp5_encoder), GFP_KERNEL);\r\nif (!mdp5_encoder) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nmemcpy(&mdp5_encoder->intf, intf, sizeof(mdp5_encoder->intf));\r\nencoder = &mdp5_encoder->base;\r\nmdp5_encoder->ctl = ctl;\r\nspin_lock_init(&mdp5_encoder->intf_lock);\r\ndrm_encoder_init(dev, encoder, &mdp5_encoder_funcs, enc_type, NULL);\r\ndrm_encoder_helper_add(encoder, &mdp5_encoder_helper_funcs);\r\nbs_init(mdp5_encoder);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nmdp5_encoder_destroy(encoder);\r\nreturn ERR_PTR(ret);\r\n}

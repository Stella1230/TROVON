void purge_waiting_ops(void)\r\n{\r\nstruct orangefs_kernel_op_s *op;\r\nspin_lock(&orangefs_request_list_lock);\r\nlist_for_each_entry(op, &orangefs_request_list, list) {\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"pvfs2-client-core: purging op tag %llu %s\n",\r\nllu(op->tag),\r\nget_opname_string(op));\r\nset_op_state_purged(op);\r\ngossip_debug(GOSSIP_DEV_DEBUG,\r\n"%s: op:%s: op_state:%d: process:%s:\n",\r\n__func__,\r\nget_opname_string(op),\r\nop->op_state,\r\ncurrent->comm);\r\n}\r\nspin_unlock(&orangefs_request_list_lock);\r\n}\r\nint service_operation(struct orangefs_kernel_op_s *op,\r\nconst char *op_name,\r\nint flags)\r\n{\r\nlong timeout = MAX_SCHEDULE_TIMEOUT;\r\nint ret = 0;\r\nDEFINE_WAIT(wait_entry);\r\nop->upcall.tgid = current->tgid;\r\nop->upcall.pid = current->pid;\r\nretry_servicing:\r\nop->downcall.status = 0;\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: %s op:%p: process:%s: pid:%d:\n",\r\n__func__,\r\nop_name,\r\nop,\r\ncurrent->comm,\r\ncurrent->pid);\r\nif (!(flags & ORANGEFS_OP_NO_MUTEX)) {\r\nif (flags & ORANGEFS_OP_INTERRUPTIBLE)\r\nret = mutex_lock_interruptible(&request_mutex);\r\nelse\r\nret = mutex_lock_killable(&request_mutex);\r\nif (ret < 0) {\r\nop->downcall.status = ret;\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: service_operation interrupted.\n",\r\n__func__);\r\nreturn ret;\r\n}\r\n}\r\nspin_lock(&orangefs_request_list_lock);\r\nspin_lock(&op->lock);\r\nset_op_state_waiting(op);\r\ngossip_debug(GOSSIP_DEV_DEBUG,\r\n"%s: op:%s: op_state:%d: process:%s:\n",\r\n__func__,\r\nget_opname_string(op),\r\nop->op_state,\r\ncurrent->comm);\r\nif (flags & ORANGEFS_OP_PRIORITY)\r\nlist_add(&op->list, &orangefs_request_list);\r\nelse\r\nlist_add_tail(&op->list, &orangefs_request_list);\r\nspin_unlock(&op->lock);\r\nwake_up_interruptible(&orangefs_request_list_waitq);\r\nif (!__is_daemon_in_service()) {\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s:client core is NOT in service.\n",\r\n__func__);\r\ntimeout = op_timeout_secs * HZ;\r\n}\r\nspin_unlock(&orangefs_request_list_lock);\r\nif (!(flags & ORANGEFS_OP_NO_MUTEX))\r\nmutex_unlock(&request_mutex);\r\nret = wait_for_matching_downcall(op, timeout,\r\nflags & ORANGEFS_OP_INTERRUPTIBLE);\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: wait_for_matching_downcall returned %d for %p\n",\r\n__func__,\r\nret,\r\nop);\r\nif (!ret) {\r\nspin_unlock(&op->lock);\r\nop->downcall.status =\r\norangefs_normalize_to_errno(op->downcall.status);\r\nret = op->downcall.status;\r\ngoto out;\r\n}\r\nif (ret == -ETIMEDOUT) {\r\ngossip_err("%s: %s -- wait timed out; aborting attempt.\n",\r\n__func__,\r\nop_name);\r\n}\r\norangefs_clean_up_interrupted_operation(op);\r\nop->downcall.status = ret;\r\nif (ret == -EAGAIN) {\r\nop->attempts++;\r\ntimeout = op_timeout_secs * HZ;\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"orangefs: tag %llu (%s)"\r\n" -- operation to be retried (%d attempt)\n",\r\nllu(op->tag),\r\nop_name,\r\nop->attempts);\r\nif (!op->uses_shared_memory)\r\ngoto retry_servicing;\r\n}\r\nout:\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: %s returning: %d for %p.\n",\r\n__func__,\r\nop_name,\r\nret,\r\nop);\r\nreturn ret;\r\n}\r\nbool orangefs_cancel_op_in_progress(struct orangefs_kernel_op_s *op)\r\n{\r\nu64 tag = op->tag;\r\nif (!op_state_in_progress(op))\r\nreturn false;\r\nop->slot_to_free = op->upcall.req.io.buf_index;\r\nmemset(&op->upcall, 0, sizeof(op->upcall));\r\nmemset(&op->downcall, 0, sizeof(op->downcall));\r\nop->upcall.type = ORANGEFS_VFS_OP_CANCEL;\r\nop->upcall.req.cancel.op_tag = tag;\r\nop->downcall.type = ORANGEFS_VFS_OP_INVALID;\r\nop->downcall.status = -1;\r\norangefs_new_tag(op);\r\nspin_lock(&orangefs_request_list_lock);\r\nif (!__is_daemon_in_service()) {\r\nspin_unlock(&orangefs_request_list_lock);\r\nreturn false;\r\n}\r\nspin_lock(&op->lock);\r\nset_op_state_waiting(op);\r\ngossip_debug(GOSSIP_DEV_DEBUG,\r\n"%s: op:%s: op_state:%d: process:%s:\n",\r\n__func__,\r\nget_opname_string(op),\r\nop->op_state,\r\ncurrent->comm);\r\nlist_add(&op->list, &orangefs_request_list);\r\nspin_unlock(&op->lock);\r\nspin_unlock(&orangefs_request_list_lock);\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"Attempting ORANGEFS operation cancellation of tag %llu\n",\r\nllu(tag));\r\nreturn true;\r\n}\r\nstatic void\r\norangefs_clean_up_interrupted_operation(struct orangefs_kernel_op_s *op)\r\n{\r\nop->op_state |= OP_VFS_STATE_GIVEN_UP;\r\nif (list_empty(&op->list)) {\r\nBUG_ON(op_state_serviced(op));\r\nspin_unlock(&op->lock);\r\nwait_for_completion(&op->waitq);\r\n} else if (op_state_waiting(op)) {\r\nspin_unlock(&op->lock);\r\nspin_lock(&orangefs_request_list_lock);\r\nlist_del_init(&op->list);\r\nspin_unlock(&orangefs_request_list_lock);\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"Interrupted: Removed op %p from request_list\n",\r\nop);\r\n} else if (op_state_in_progress(op)) {\r\nspin_unlock(&op->lock);\r\nspin_lock(&htable_ops_in_progress_lock);\r\nlist_del_init(&op->list);\r\nspin_unlock(&htable_ops_in_progress_lock);\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"Interrupted: Removed op %p"\r\n" from htable_ops_in_progress\n",\r\nop);\r\n} else {\r\nspin_unlock(&op->lock);\r\ngossip_err("interrupted operation is in a weird state 0x%x\n",\r\nop->op_state);\r\n}\r\nreinit_completion(&op->waitq);\r\n}\r\nstatic int wait_for_matching_downcall(struct orangefs_kernel_op_s *op,\r\nlong timeout,\r\nbool interruptible)\r\n{\r\nlong n;\r\nif (interruptible)\r\nn = wait_for_completion_interruptible_timeout(&op->waitq,\r\ntimeout);\r\nelse\r\nn = wait_for_completion_killable_timeout(&op->waitq, timeout);\r\nspin_lock(&op->lock);\r\nif (op_state_serviced(op))\r\nreturn 0;\r\nif (unlikely(n < 0)) {\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: operation interrupted, tag %llu, %p\n",\r\n__func__,\r\nllu(op->tag),\r\nop);\r\nreturn -EINTR;\r\n}\r\nif (op_state_purged(op)) {\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: operation purged, tag %llu, %p, %d\n",\r\n__func__,\r\nllu(op->tag),\r\nop,\r\nop->attempts);\r\nreturn (op->attempts < ORANGEFS_PURGE_RETRY_COUNT) ?\r\n-EAGAIN :\r\n-EIO;\r\n}\r\ngossip_debug(GOSSIP_WAIT_DEBUG,\r\n"%s: operation timed out, tag %llu, %p, %d)\n",\r\n__func__,\r\nllu(op->tag),\r\nop,\r\nop->attempts);\r\nreturn -ETIMEDOUT;\r\n}

static void save_raw_context_stack(struct stack_trace *trace,\r\nunsigned long reg29, int savesched)\r\n{\r\nunsigned long *sp = (unsigned long *)reg29;\r\nunsigned long addr;\r\nwhile (!kstack_end(sp)) {\r\naddr = *sp++;\r\nif (__kernel_text_address(addr) &&\r\n(savesched || !in_sched_functions(addr))) {\r\nif (trace->skip > 0)\r\ntrace->skip--;\r\nelse\r\ntrace->entries[trace->nr_entries++] = addr;\r\nif (trace->nr_entries >= trace->max_entries)\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void save_context_stack(struct stack_trace *trace,\r\nstruct task_struct *tsk, struct pt_regs *regs, int savesched)\r\n{\r\nunsigned long sp = regs->regs[29];\r\n#ifdef CONFIG_KALLSYMS\r\nunsigned long ra = regs->regs[31];\r\nunsigned long pc = regs->cp0_epc;\r\nif (raw_show_trace || !__kernel_text_address(pc)) {\r\nunsigned long stack_page =\r\n(unsigned long)task_stack_page(tsk);\r\nif (stack_page && sp >= stack_page &&\r\nsp <= stack_page + THREAD_SIZE - 32)\r\nsave_raw_context_stack(trace, sp, savesched);\r\nreturn;\r\n}\r\ndo {\r\nif (savesched || !in_sched_functions(pc)) {\r\nif (trace->skip > 0)\r\ntrace->skip--;\r\nelse\r\ntrace->entries[trace->nr_entries++] = pc;\r\nif (trace->nr_entries >= trace->max_entries)\r\nbreak;\r\n}\r\npc = unwind_stack(tsk, &sp, pc, &ra);\r\n} while (pc);\r\n#else\r\nsave_raw_context_stack(trace, sp, savesched);\r\n#endif\r\n}\r\nvoid save_stack_trace(struct stack_trace *trace)\r\n{\r\nsave_stack_trace_tsk(current, trace);\r\n}\r\nvoid save_stack_trace_tsk(struct task_struct *tsk, struct stack_trace *trace)\r\n{\r\nstruct pt_regs dummyregs;\r\nstruct pt_regs *regs = &dummyregs;\r\nWARN_ON(trace->nr_entries || !trace->max_entries);\r\nif (tsk != current) {\r\nregs->regs[29] = tsk->thread.reg29;\r\nregs->regs[31] = 0;\r\nregs->cp0_epc = tsk->thread.reg31;\r\n} else\r\nprepare_frametrace(regs);\r\nsave_context_stack(trace, tsk, regs, tsk == current);\r\n}

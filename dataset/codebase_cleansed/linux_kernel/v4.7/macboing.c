static void mac_init_asc( void )\r\n{\r\nint i;\r\nswitch ( macintosh_config->ident )\r\n{\r\ncase MAC_MODEL_IIFX:\r\nmac_asc_regs = ( void* )0x50010000;\r\nbreak;\r\ncase MAC_MODEL_Q630:\r\ncase MAC_MODEL_P475:\r\nmac_special_bell = mac_quadra_start_bell;\r\nmac_asc_samplespersec = 22150;\r\nbreak;\r\ncase MAC_MODEL_C660:\r\ncase MAC_MODEL_Q840:\r\nmac_special_bell = mac_av_start_bell;\r\nbreak;\r\ncase MAC_MODEL_Q650:\r\ncase MAC_MODEL_Q700:\r\ncase MAC_MODEL_Q800:\r\ncase MAC_MODEL_Q900:\r\ncase MAC_MODEL_Q950:\r\nmac_special_bell = NULL;\r\nbreak;\r\ndefault:\r\nmac_special_bell = NULL;\r\nbreak;\r\n}\r\nfor ( i = 0; i < 0x400; i++ )\r\n{\r\nmac_asc_wave_tab[ i ] = i / 4;\r\nmac_asc_wave_tab[ i + 0x400 ] = 0xFF - i / 4;\r\n}\r\nmac_asc_inited = 1;\r\n}\r\nvoid mac_mksound( unsigned int freq, unsigned int length )\r\n{\r\n__u32 cfreq = ( freq << 5 ) / 468;\r\nunsigned long flags;\r\nint i;\r\nif ( mac_special_bell == NULL )\r\n{\r\nreturn;\r\n}\r\nif ( !mac_asc_inited )\r\nmac_init_asc();\r\nif ( mac_special_bell )\r\n{\r\nmac_special_bell( freq, length, 128 );\r\nreturn;\r\n}\r\nif ( freq < 20 || freq > 20000 || length == 0 )\r\n{\r\nmac_nosound( 0 );\r\nreturn;\r\n}\r\nlocal_irq_save(flags);\r\ndel_timer( &mac_sound_timer );\r\nfor ( i = 0; i < 0x800; i++ )\r\nmac_asc_regs[ i ] = 0;\r\nfor ( i = 0; i < 0x800; i++ )\r\nmac_asc_regs[ i ] = mac_asc_wave_tab[ i ];\r\nfor ( i = 0; i < 8; i++ )\r\n*( __u32* )( ( __u32 )mac_asc_regs + ASC_CONTROL + 0x814 + 8 * i ) = cfreq;\r\nmac_asc_regs[ 0x807 ] = 0;\r\nmac_asc_regs[ ASC_VOLUME ] = 128;\r\nmac_asc_regs[ 0x805 ] = 0;\r\nmac_asc_regs[ 0x80F ] = 0;\r\nmac_asc_regs[ ASC_MODE ] = ASC_MODE_SAMPLE;\r\nmac_asc_regs[ ASC_ENABLE ] = ASC_ENABLE_SAMPLE;\r\nmac_sound_timer.expires = jiffies + length;\r\nadd_timer( &mac_sound_timer );\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void mac_nosound( unsigned long ignored )\r\n{\r\nmac_asc_regs[ ASC_ENABLE ] = 0;\r\n}\r\nstatic void mac_quadra_start_bell( unsigned int freq, unsigned int length, unsigned int volume )\r\n{\r\nunsigned long flags;\r\nif ( mac_bell_duration > 0 )\r\n{\r\nmac_bell_duration += length;\r\nreturn;\r\n}\r\nmac_bell_duration = length;\r\nmac_bell_phase = 0;\r\nmac_bell_phasepersample = ( freq * sizeof( mac_asc_wave_tab ) ) / mac_asc_samplespersec;\r\nlocal_irq_save(flags);\r\nmac_asc_regs[ 0x806 ] = volume;\r\nif ( mac_asc_regs[ 0x801 ] != 1 )\r\n{\r\nmac_asc_regs[ 0x807 ] = 0;\r\nmac_asc_regs[ 0x802 ] = 0;\r\nmac_asc_regs[ 0x801 ] = 1;\r\nmac_asc_regs[ 0x803 ] |= 0x80;\r\nmac_asc_regs[ 0x803 ] &= 0x7F;\r\n}\r\nmac_sound_timer.function = mac_quadra_ring_bell;\r\nmac_sound_timer.expires = jiffies + 1;\r\nadd_timer( &mac_sound_timer );\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void mac_quadra_ring_bell( unsigned long ignored )\r\n{\r\nint i, count = mac_asc_samplespersec / HZ;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\ndel_timer( &mac_sound_timer );\r\nif ( mac_bell_duration-- > 0 )\r\n{\r\nfor ( i = 0; i < count; i++ )\r\n{\r\nmac_bell_phase += mac_bell_phasepersample;\r\nmac_asc_regs[ 0 ] = mac_asc_wave_tab[ mac_bell_phase & ( sizeof( mac_asc_wave_tab ) - 1 ) ];\r\n}\r\nmac_sound_timer.expires = jiffies + 1;\r\nadd_timer( &mac_sound_timer );\r\n}\r\nelse\r\nmac_asc_regs[ 0x801 ] = 0;\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void mac_av_start_bell( unsigned int freq, unsigned int length, unsigned int volume )\r\n{\r\n}

static void micro_ts_receive(void *data, int len, unsigned char *msg)\r\n{\r\nstruct touchscreen_data *ts = data;\r\nif (len == 4) {\r\ninput_report_abs(ts->input, ABS_X,\r\nbe16_to_cpup((__be16 *) &msg[2]));\r\ninput_report_abs(ts->input, ABS_Y,\r\nbe16_to_cpup((__be16 *) &msg[0]));\r\ninput_report_key(ts->input, BTN_TOUCH, 1);\r\ninput_sync(ts->input);\r\n} else if (len == 0) {\r\ninput_report_abs(ts->input, ABS_X, 0);\r\ninput_report_abs(ts->input, ABS_Y, 0);\r\ninput_report_key(ts->input, BTN_TOUCH, 0);\r\ninput_sync(ts->input);\r\n}\r\n}\r\nstatic void micro_ts_toggle_receive(struct touchscreen_data *ts, bool enable)\r\n{\r\nstruct ipaq_micro *micro = ts->micro;\r\nspin_lock_irq(&micro->lock);\r\nif (enable) {\r\nmicro->ts = micro_ts_receive;\r\nmicro->ts_data = ts;\r\n} else {\r\nmicro->ts = NULL;\r\nmicro->ts_data = NULL;\r\n}\r\nspin_unlock_irq(&ts->micro->lock);\r\n}\r\nstatic int micro_ts_open(struct input_dev *input)\r\n{\r\nstruct touchscreen_data *ts = input_get_drvdata(input);\r\nmicro_ts_toggle_receive(ts, true);\r\nreturn 0;\r\n}\r\nstatic void micro_ts_close(struct input_dev *input)\r\n{\r\nstruct touchscreen_data *ts = input_get_drvdata(input);\r\nmicro_ts_toggle_receive(ts, false);\r\n}\r\nstatic int micro_ts_probe(struct platform_device *pdev)\r\n{\r\nstruct ipaq_micro *micro = dev_get_drvdata(pdev->dev.parent);\r\nstruct touchscreen_data *ts;\r\nint error;\r\nts = devm_kzalloc(&pdev->dev, sizeof(*ts), GFP_KERNEL);\r\nif (!ts)\r\nreturn -ENOMEM;\r\nts->micro = micro;\r\nts->input = devm_input_allocate_device(&pdev->dev);\r\nif (!ts->input) {\r\ndev_err(&pdev->dev, "failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\nts->input->name = "ipaq micro ts";\r\nts->input->open = micro_ts_open;\r\nts->input->close = micro_ts_close;\r\ninput_set_drvdata(ts->input, ts);\r\ninput_set_capability(ts->input, EV_KEY, BTN_TOUCH);\r\ninput_set_capability(ts->input, EV_ABS, ABS_X);\r\ninput_set_capability(ts->input, EV_ABS, ABS_Y);\r\ninput_set_abs_params(ts->input, ABS_X, 0, 1023, 0, 0);\r\ninput_set_abs_params(ts->input, ABS_Y, 0, 1023, 0, 0);\r\nerror = input_register_device(ts->input);\r\nif (error) {\r\ndev_err(&pdev->dev, "error registering touch input\n");\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, ts);\r\ndev_info(&pdev->dev, "iPAQ micro touchscreen\n");\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_ts_suspend(struct device *dev)\r\n{\r\nstruct touchscreen_data *ts = dev_get_drvdata(dev);\r\nmicro_ts_toggle_receive(ts, false);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_ts_resume(struct device *dev)\r\n{\r\nstruct touchscreen_data *ts = dev_get_drvdata(dev);\r\nstruct input_dev *input = ts->input;\r\nmutex_lock(&input->mutex);\r\nif (input->users)\r\nmicro_ts_toggle_receive(ts, true);\r\nmutex_unlock(&input->mutex);\r\nreturn 0;\r\n}

int wilc_mq_create(struct message_queue *mq)\r\n{\r\nspin_lock_init(&mq->lock);\r\nsema_init(&mq->sem, 0);\r\nINIT_LIST_HEAD(&mq->msg_list);\r\nmq->recv_count = 0;\r\nmq->exiting = false;\r\nreturn 0;\r\n}\r\nint wilc_mq_destroy(struct message_queue *mq)\r\n{\r\nstruct message *msg;\r\nmq->exiting = true;\r\nwhile (mq->recv_count > 0) {\r\nup(&mq->sem);\r\nmq->recv_count--;\r\n}\r\nwhile (!list_empty(&mq->msg_list)) {\r\nmsg = list_first_entry(&mq->msg_list, struct message, list);\r\nlist_del(&msg->list);\r\nkfree(msg->buf);\r\n}\r\nreturn 0;\r\n}\r\nint wilc_mq_send(struct message_queue *mq,\r\nconst void *send_buf, u32 send_buf_size)\r\n{\r\nunsigned long flags;\r\nstruct message *new_msg = NULL;\r\nif (!mq || (send_buf_size == 0) || !send_buf)\r\nreturn -EINVAL;\r\nif (mq->exiting)\r\nreturn -EFAULT;\r\nnew_msg = kmalloc(sizeof(*new_msg), GFP_ATOMIC);\r\nif (!new_msg)\r\nreturn -ENOMEM;\r\nnew_msg->len = send_buf_size;\r\nINIT_LIST_HEAD(&new_msg->list);\r\nnew_msg->buf = kmemdup(send_buf, send_buf_size, GFP_ATOMIC);\r\nif (!new_msg->buf) {\r\nkfree(new_msg);\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_irqsave(&mq->lock, flags);\r\nlist_add_tail(&new_msg->list, &mq->msg_list);\r\nspin_unlock_irqrestore(&mq->lock, flags);\r\nup(&mq->sem);\r\nreturn 0;\r\n}\r\nint wilc_mq_recv(struct message_queue *mq,\r\nvoid *recv_buf, u32 recv_buf_size, u32 *recv_len)\r\n{\r\nstruct message *msg;\r\nunsigned long flags;\r\nif (!mq || (recv_buf_size == 0) || !recv_buf || !recv_len)\r\nreturn -EINVAL;\r\nif (mq->exiting)\r\nreturn -EFAULT;\r\nspin_lock_irqsave(&mq->lock, flags);\r\nmq->recv_count++;\r\nspin_unlock_irqrestore(&mq->lock, flags);\r\ndown(&mq->sem);\r\nspin_lock_irqsave(&mq->lock, flags);\r\nif (list_empty(&mq->msg_list)) {\r\nspin_unlock_irqrestore(&mq->lock, flags);\r\nup(&mq->sem);\r\nreturn -EFAULT;\r\n}\r\nmsg = list_first_entry(&mq->msg_list, struct message, list);\r\nif (recv_buf_size < msg->len) {\r\nspin_unlock_irqrestore(&mq->lock, flags);\r\nup(&mq->sem);\r\nreturn -EOVERFLOW;\r\n}\r\nmq->recv_count--;\r\nmemcpy(recv_buf, msg->buf, msg->len);\r\n*recv_len = msg->len;\r\nlist_del(&msg->list);\r\nkfree(msg->buf);\r\nkfree(msg);\r\nspin_unlock_irqrestore(&mq->lock, flags);\r\nreturn 0;\r\n}

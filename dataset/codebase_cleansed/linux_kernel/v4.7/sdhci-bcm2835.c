static void bcm2835_sdhci_writel(struct sdhci_host *host, u32 val, int reg)\r\n{\r\nwritel(val, host->ioaddr + reg);\r\nudelay(BCM2835_SDHCI_WRITE_DELAY);\r\n}\r\nstatic inline u32 bcm2835_sdhci_readl(struct sdhci_host *host, int reg)\r\n{\r\nu32 val = readl(host->ioaddr + reg);\r\nif (reg == SDHCI_CAPABILITIES)\r\nval |= SDHCI_CAN_VDD_330;\r\nreturn val;\r\n}\r\nstatic void bcm2835_sdhci_writew(struct sdhci_host *host, u16 val, int reg)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct bcm2835_sdhci *bcm2835_host = sdhci_pltfm_priv(pltfm_host);\r\nu32 oldval = (reg == SDHCI_COMMAND) ? bcm2835_host->shadow :\r\nbcm2835_sdhci_readl(host, reg & ~3);\r\nu32 word_num = (reg >> 1) & 1;\r\nu32 word_shift = word_num * 16;\r\nu32 mask = 0xffff << word_shift;\r\nu32 newval = (oldval & ~mask) | (val << word_shift);\r\nif (reg == SDHCI_TRANSFER_MODE)\r\nbcm2835_host->shadow = newval;\r\nelse\r\nbcm2835_sdhci_writel(host, newval, reg & ~3);\r\n}\r\nstatic u16 bcm2835_sdhci_readw(struct sdhci_host *host, int reg)\r\n{\r\nu32 val = bcm2835_sdhci_readl(host, (reg & ~3));\r\nu32 word_num = (reg >> 1) & 1;\r\nu32 word_shift = word_num * 16;\r\nu32 word = (val >> word_shift) & 0xffff;\r\nreturn word;\r\n}\r\nstatic void bcm2835_sdhci_writeb(struct sdhci_host *host, u8 val, int reg)\r\n{\r\nu32 oldval = bcm2835_sdhci_readl(host, reg & ~3);\r\nu32 byte_num = reg & 3;\r\nu32 byte_shift = byte_num * 8;\r\nu32 mask = 0xff << byte_shift;\r\nu32 newval = (oldval & ~mask) | (val << byte_shift);\r\nbcm2835_sdhci_writel(host, newval, reg & ~3);\r\n}\r\nstatic u8 bcm2835_sdhci_readb(struct sdhci_host *host, int reg)\r\n{\r\nu32 val = bcm2835_sdhci_readl(host, (reg & ~3));\r\nu32 byte_num = reg & 3;\r\nu32 byte_shift = byte_num * 8;\r\nu32 byte = (val >> byte_shift) & 0xff;\r\nreturn byte;\r\n}\r\nstatic unsigned int bcm2835_sdhci_get_min_clock(struct sdhci_host *host)\r\n{\r\nreturn MIN_FREQ;\r\n}\r\nstatic int bcm2835_sdhci_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct bcm2835_sdhci *bcm2835_host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nint ret;\r\nhost = sdhci_pltfm_init(pdev, &bcm2835_sdhci_pdata,\r\nsizeof(*bcm2835_host));\r\nif (IS_ERR(host))\r\nreturn PTR_ERR(host);\r\npltfm_host = sdhci_priv(host);\r\npltfm_host->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(pltfm_host->clk)) {\r\nret = PTR_ERR(pltfm_host->clk);\r\ngoto err;\r\n}\r\nret = clk_prepare_enable(pltfm_host->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to enable host clk\n");\r\ngoto err;\r\n}\r\nret = sdhci_add_host(host);\r\nif (ret)\r\ngoto err_clk;\r\nreturn 0;\r\nerr_clk:\r\nclk_disable_unprepare(pltfm_host->clk);\r\nerr:\r\nsdhci_pltfm_free(pdev);\r\nreturn ret;\r\n}

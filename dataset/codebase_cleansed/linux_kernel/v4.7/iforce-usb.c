void iforce_usb_xmit(struct iforce *iforce)\r\n{\r\nint n, c;\r\nunsigned long flags;\r\nspin_lock_irqsave(&iforce->xmit_lock, flags);\r\nif (iforce->xmit.head == iforce->xmit.tail) {\r\nclear_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags);\r\nspin_unlock_irqrestore(&iforce->xmit_lock, flags);\r\nreturn;\r\n}\r\n((char *)iforce->out->transfer_buffer)[0] = iforce->xmit.buf[iforce->xmit.tail];\r\nXMIT_INC(iforce->xmit.tail, 1);\r\nn = iforce->xmit.buf[iforce->xmit.tail];\r\nXMIT_INC(iforce->xmit.tail, 1);\r\niforce->out->transfer_buffer_length = n + 1;\r\niforce->out->dev = iforce->usbdev;\r\nc = CIRC_CNT_TO_END(iforce->xmit.head, iforce->xmit.tail, XMIT_SIZE);\r\nif (n < c) c=n;\r\nmemcpy(iforce->out->transfer_buffer + 1,\r\n&iforce->xmit.buf[iforce->xmit.tail],\r\nc);\r\nif (n != c) {\r\nmemcpy(iforce->out->transfer_buffer + 1 + c,\r\n&iforce->xmit.buf[0],\r\nn-c);\r\n}\r\nXMIT_INC(iforce->xmit.tail, n);\r\nif ( (n=usb_submit_urb(iforce->out, GFP_ATOMIC)) ) {\r\nclear_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags);\r\ndev_warn(&iforce->intf->dev, "usb_submit_urb failed %d\n", n);\r\n}\r\nspin_unlock_irqrestore(&iforce->xmit_lock, flags);\r\n}\r\nstatic void iforce_usb_irq(struct urb *urb)\r\n{\r\nstruct iforce *iforce = urb->context;\r\nstruct device *dev = &iforce->intf->dev;\r\nint status;\r\nswitch (urb->status) {\r\ncase 0:\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ndev_dbg(dev, "%s - urb shutting down with status: %d\n",\r\n__func__, urb->status);\r\nreturn;\r\ndefault:\r\ndev_dbg(dev, "%s - urb has status of: %d\n",\r\n__func__, urb->status);\r\ngoto exit;\r\n}\r\niforce_process_packet(iforce,\r\n(iforce->data[0] << 8) | (urb->actual_length - 1), iforce->data + 1);\r\nexit:\r\nstatus = usb_submit_urb (urb, GFP_ATOMIC);\r\nif (status)\r\ndev_err(dev, "%s - usb_submit_urb failed with result %d\n",\r\n__func__, status);\r\n}\r\nstatic void iforce_usb_out(struct urb *urb)\r\n{\r\nstruct iforce *iforce = urb->context;\r\nif (urb->status) {\r\nclear_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags);\r\ndev_dbg(&iforce->intf->dev, "urb->status %d, exiting\n",\r\nurb->status);\r\nreturn;\r\n}\r\niforce_usb_xmit(iforce);\r\nwake_up(&iforce->wait);\r\n}\r\nstatic void iforce_usb_ctrl(struct urb *urb)\r\n{\r\nstruct iforce *iforce = urb->context;\r\nif (urb->status) return;\r\niforce->ecmd = 0xff00 | urb->actual_length;\r\nwake_up(&iforce->wait);\r\n}\r\nstatic int iforce_usb_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct usb_host_interface *interface;\r\nstruct usb_endpoint_descriptor *epirq, *epout;\r\nstruct iforce *iforce;\r\nint err = -ENOMEM;\r\ninterface = intf->cur_altsetting;\r\nepirq = &interface->endpoint[0].desc;\r\nepout = &interface->endpoint[1].desc;\r\nif (!(iforce = kzalloc(sizeof(struct iforce) + 32, GFP_KERNEL)))\r\ngoto fail;\r\nif (!(iforce->irq = usb_alloc_urb(0, GFP_KERNEL)))\r\ngoto fail;\r\nif (!(iforce->out = usb_alloc_urb(0, GFP_KERNEL)))\r\ngoto fail;\r\nif (!(iforce->ctrl = usb_alloc_urb(0, GFP_KERNEL)))\r\ngoto fail;\r\niforce->bus = IFORCE_USB;\r\niforce->usbdev = dev;\r\niforce->intf = intf;\r\niforce->cr.bRequestType = USB_TYPE_VENDOR | USB_DIR_IN | USB_RECIP_INTERFACE;\r\niforce->cr.wIndex = 0;\r\niforce->cr.wLength = cpu_to_le16(16);\r\nusb_fill_int_urb(iforce->irq, dev, usb_rcvintpipe(dev, epirq->bEndpointAddress),\r\niforce->data, 16, iforce_usb_irq, iforce, epirq->bInterval);\r\nusb_fill_int_urb(iforce->out, dev, usb_sndintpipe(dev, epout->bEndpointAddress),\r\niforce + 1, 32, iforce_usb_out, iforce, epout->bInterval);\r\nusb_fill_control_urb(iforce->ctrl, dev, usb_rcvctrlpipe(dev, 0),\r\n(void*) &iforce->cr, iforce->edata, 16, iforce_usb_ctrl, iforce);\r\nerr = iforce_init_device(iforce);\r\nif (err)\r\ngoto fail;\r\nusb_set_intfdata(intf, iforce);\r\nreturn 0;\r\nfail:\r\nif (iforce) {\r\nusb_free_urb(iforce->irq);\r\nusb_free_urb(iforce->out);\r\nusb_free_urb(iforce->ctrl);\r\nkfree(iforce);\r\n}\r\nreturn err;\r\n}\r\nstatic void iforce_usb_disconnect(struct usb_interface *intf)\r\n{\r\nstruct iforce *iforce = usb_get_intfdata(intf);\r\nusb_set_intfdata(intf, NULL);\r\ninput_unregister_device(iforce->dev);\r\nusb_free_urb(iforce->irq);\r\nusb_free_urb(iforce->out);\r\nusb_free_urb(iforce->ctrl);\r\nkfree(iforce);\r\n}

static void hns_gmac_enable(void *mac_drv, enum mac_commom_mode mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nif ((mode == MAC_COMM_MODE_TX) || (mode == MAC_COMM_MODE_RX_AND_TX))\r\ndsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_TX_EN_B, 1);\r\nif ((mode == MAC_COMM_MODE_RX) || (mode == MAC_COMM_MODE_RX_AND_TX))\r\ndsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_RX_EN_B, 1);\r\n}\r\nstatic void hns_gmac_disable(void *mac_drv, enum mac_commom_mode mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nif ((mode == MAC_COMM_MODE_TX) || (mode == MAC_COMM_MODE_RX_AND_TX))\r\ndsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_TX_EN_B, 0);\r\nif ((mode == MAC_COMM_MODE_RX) || (mode == MAC_COMM_MODE_RX_AND_TX))\r\ndsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_RX_EN_B, 0);\r\n}\r\nstatic void hns_gmac_get_en(void *mac_drv, u32 *rx, u32 *tx)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 porten;\r\nporten = dsaf_read_dev(drv, GMAC_PORT_EN_REG);\r\n*tx = dsaf_get_bit(porten, GMAC_PORT_TX_EN_B);\r\n*rx = dsaf_get_bit(porten, GMAC_PORT_RX_EN_B);\r\n}\r\nstatic void hns_gmac_free(void *mac_drv)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct dsaf_device *dsaf_dev\r\n= (struct dsaf_device *)dev_get_drvdata(drv->dev);\r\nu32 mac_id = drv->mac_id;\r\nhns_dsaf_ge_srst_by_port(dsaf_dev, mac_id, 0);\r\n}\r\nstatic void hns_gmac_set_tx_auto_pause_frames(void *mac_drv, u16 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_field(drv, GMAC_FC_TX_TIMER_REG, GMAC_FC_TX_TIMER_M,\r\nGMAC_FC_TX_TIMER_S, newval);\r\n}\r\nstatic void hns_gmac_get_tx_auto_pause_frames(void *mac_drv, u16 *newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*newval = dsaf_get_dev_field(drv, GMAC_FC_TX_TIMER_REG,\r\nGMAC_FC_TX_TIMER_M, GMAC_FC_TX_TIMER_S);\r\n}\r\nstatic void hns_gmac_set_rx_auto_pause_frames(void *mac_drv, u32 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, GMAC_PAUSE_EN_REG,\r\nGMAC_PAUSE_EN_RX_FDFC_B, !!newval);\r\n}\r\nstatic void hns_gmac_config_max_frame_length(void *mac_drv, u16 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_field(drv, GMAC_MAX_FRM_SIZE_REG, GMAC_MAX_FRM_SIZE_M,\r\nGMAC_MAX_FRM_SIZE_S, newval);\r\ndsaf_set_dev_field(drv, GAMC_RX_MAX_FRAME, GMAC_MAX_FRM_SIZE_M,\r\nGMAC_MAX_FRM_SIZE_S, newval);\r\n}\r\nstatic void hns_gmac_config_an_mode(void *mac_drv, u8 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, GMAC_TRANSMIT_CONTROL_REG,\r\nGMAC_TX_AN_EN_B, !!newval);\r\n}\r\nstatic void hns_gmac_tx_loop_pkt_dis(void *mac_drv)\r\n{\r\nu32 tx_loop_pkt_pri;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ntx_loop_pkt_pri = dsaf_read_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG);\r\ndsaf_set_bit(tx_loop_pkt_pri, GMAC_TX_LOOP_PKT_EN_B, 1);\r\ndsaf_set_bit(tx_loop_pkt_pri, GMAC_TX_LOOP_PKT_HIG_PRI_B, 0);\r\ndsaf_write_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG, tx_loop_pkt_pri);\r\n}\r\nstatic void hns_gmac_set_duplex_type(void *mac_drv, u8 newval)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, GMAC_DUPLEX_TYPE_REG,\r\nGMAC_DUPLEX_TYPE_B, !!newval);\r\n}\r\nstatic void hns_gmac_get_duplex_type(void *mac_drv,\r\nenum hns_gmac_duplex_mdoe *duplex_mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*duplex_mode = (enum hns_gmac_duplex_mdoe)dsaf_get_dev_bit(\r\ndrv, GMAC_DUPLEX_TYPE_REG, GMAC_DUPLEX_TYPE_B);\r\n}\r\nstatic void hns_gmac_get_port_mode(void *mac_drv, enum hns_port_mode *port_mode)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*port_mode = (enum hns_port_mode)dsaf_get_dev_field(\r\ndrv, GMAC_PORT_MODE_REG, GMAC_PORT_MODE_M, GMAC_PORT_MODE_S);\r\n}\r\nstatic void hns_gmac_port_mode_get(void *mac_drv,\r\nstruct hns_gmac_port_mode_cfg *port_mode)\r\n{\r\nu32 tx_ctrl;\r\nu32 recv_ctrl;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nport_mode->port_mode = (enum hns_port_mode)dsaf_get_dev_field(\r\ndrv, GMAC_PORT_MODE_REG, GMAC_PORT_MODE_M, GMAC_PORT_MODE_S);\r\ntx_ctrl = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\r\nrecv_ctrl = dsaf_read_dev(drv, GMAC_RECV_CONTROL_REG);\r\nport_mode->max_frm_size =\r\ndsaf_get_dev_field(drv, GMAC_MAX_FRM_SIZE_REG,\r\nGMAC_MAX_FRM_SIZE_M, GMAC_MAX_FRM_SIZE_S);\r\nport_mode->short_runts_thr =\r\ndsaf_get_dev_field(drv, GMAC_SHORT_RUNTS_THR_REG,\r\nGMAC_SHORT_RUNTS_THR_M,\r\nGMAC_SHORT_RUNTS_THR_S);\r\nport_mode->pad_enable = dsaf_get_bit(tx_ctrl, GMAC_TX_PAD_EN_B);\r\nport_mode->crc_add = dsaf_get_bit(tx_ctrl, GMAC_TX_CRC_ADD_B);\r\nport_mode->an_enable = dsaf_get_bit(tx_ctrl, GMAC_TX_AN_EN_B);\r\nport_mode->runt_pkt_en =\r\ndsaf_get_bit(recv_ctrl, GMAC_RECV_CTRL_RUNT_PKT_EN_B);\r\nport_mode->strip_pad_en =\r\ndsaf_get_bit(recv_ctrl, GMAC_RECV_CTRL_STRIP_PAD_EN_B);\r\n}\r\nstatic void hns_gmac_pause_frm_cfg(void *mac_drv, u32 rx_pause_en,\r\nu32 tx_pause_en)\r\n{\r\nu32 pause_en;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\npause_en = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\r\ndsaf_set_bit(pause_en, GMAC_PAUSE_EN_RX_FDFC_B, !!rx_pause_en);\r\ndsaf_set_bit(pause_en, GMAC_PAUSE_EN_TX_FDFC_B, !!tx_pause_en);\r\ndsaf_write_dev(drv, GMAC_PAUSE_EN_REG, pause_en);\r\n}\r\nstatic void hns_gmac_get_pausefrm_cfg(void *mac_drv, u32 *rx_pause_en,\r\nu32 *tx_pause_en)\r\n{\r\nu32 pause_en;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\npause_en = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\r\n*rx_pause_en = dsaf_get_bit(pause_en, GMAC_PAUSE_EN_RX_FDFC_B);\r\n*tx_pause_en = dsaf_get_bit(pause_en, GMAC_PAUSE_EN_TX_FDFC_B);\r\n}\r\nstatic int hns_gmac_adjust_link(void *mac_drv, enum mac_speed speed,\r\nu32 full_duplex)\r\n{\r\nu32 tx_ctrl;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ndsaf_set_dev_bit(drv, GMAC_DUPLEX_TYPE_REG,\r\nGMAC_DUPLEX_TYPE_B, !!full_duplex);\r\nswitch (speed) {\r\ncase MAC_SPEED_10:\r\ndsaf_set_dev_field(\r\ndrv, GMAC_PORT_MODE_REG,\r\nGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x6);\r\nbreak;\r\ncase MAC_SPEED_100:\r\ndsaf_set_dev_field(\r\ndrv, GMAC_PORT_MODE_REG,\r\nGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x7);\r\nbreak;\r\ncase MAC_SPEED_1000:\r\ndsaf_set_dev_field(\r\ndrv, GMAC_PORT_MODE_REG,\r\nGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x8);\r\nbreak;\r\ndefault:\r\ndev_err(drv->dev,\r\n"hns_gmac_adjust_link fail, speed%d mac%d\n",\r\nspeed, drv->mac_id);\r\nreturn -EINVAL;\r\n}\r\ntx_ctrl = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\r\ndsaf_set_bit(tx_ctrl, GMAC_TX_PAD_EN_B, 1);\r\ndsaf_set_bit(tx_ctrl, GMAC_TX_CRC_ADD_B, 1);\r\ndsaf_write_dev(drv, GMAC_TRANSMIT_CONTROL_REG, tx_ctrl);\r\ndsaf_set_dev_bit(drv, GMAC_MODE_CHANGE_EN_REG,\r\nGMAC_MODE_CHANGE_EB_B, 1);\r\nreturn 0;\r\n}\r\nstatic void hns_gmac_set_uc_match(void *mac_drv, u16 en)\r\n{\r\nstruct mac_driver *drv = mac_drv;\r\ndsaf_set_dev_bit(drv, GMAC_REC_FILT_CONTROL_REG,\r\nGMAC_UC_MATCH_EN_B, !en);\r\ndsaf_set_dev_bit(drv, GMAC_STATION_ADDR_HIGH_2_REG,\r\nGMAC_ADDR_EN_B, !en);\r\n}\r\nstatic void hns_gmac_set_promisc(void *mac_drv, u8 en)\r\n{\r\nstruct mac_driver *drv = mac_drv;\r\nif (drv->mac_cb->mac_type == HNAE_PORT_DEBUG)\r\nhns_gmac_set_uc_match(mac_drv, en);\r\n}\r\nstatic void hns_gmac_init(void *mac_drv)\r\n{\r\nu32 port;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct dsaf_device *dsaf_dev\r\n= (struct dsaf_device *)dev_get_drvdata(drv->dev);\r\nport = drv->mac_id;\r\nhns_dsaf_ge_srst_by_port(dsaf_dev, port, 0);\r\nmdelay(10);\r\nhns_dsaf_ge_srst_by_port(dsaf_dev, port, 1);\r\nmdelay(10);\r\nhns_gmac_disable(mac_drv, MAC_COMM_MODE_RX_AND_TX);\r\nhns_gmac_tx_loop_pkt_dis(mac_drv);\r\nif (drv->mac_cb->mac_type == HNAE_PORT_DEBUG)\r\nhns_gmac_set_uc_match(mac_drv, 0);\r\n}\r\nvoid hns_gmac_update_stats(void *mac_drv)\r\n{\r\nstruct mac_hw_stats *hw_stats = NULL;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nhw_stats = &drv->mac_cb->hw_stats;\r\nhw_stats->rx_good_bytes\r\n+= dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_OK_REG);\r\nhw_stats->rx_bad_bytes\r\n+= dsaf_read_dev(drv, GMAC_RX_OCTETS_BAD_REG);\r\nhw_stats->rx_uc_pkts += dsaf_read_dev(drv, GMAC_RX_UC_PKTS_REG);\r\nhw_stats->rx_mc_pkts += dsaf_read_dev(drv, GMAC_RX_MC_PKTS_REG);\r\nhw_stats->rx_bc_pkts += dsaf_read_dev(drv, GMAC_RX_BC_PKTS_REG);\r\nhw_stats->rx_64bytes\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_64OCTETS_REG);\r\nhw_stats->rx_65to127\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_65TO127OCTETS_REG);\r\nhw_stats->rx_128to255\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_128TO255OCTETS_REG);\r\nhw_stats->rx_256to511\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_255TO511OCTETS_REG);\r\nhw_stats->rx_512to1023\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_512TO1023OCTETS_REG);\r\nhw_stats->rx_1024to1518\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_1024TO1518OCTETS_REG);\r\nhw_stats->rx_1519tomax\r\n+= dsaf_read_dev(drv, GMAC_RX_PKTS_1519TOMAXOCTETS_REG);\r\nhw_stats->rx_fcs_err += dsaf_read_dev(drv, GMAC_RX_FCS_ERRORS_REG);\r\nhw_stats->rx_vlan_pkts += dsaf_read_dev(drv, GMAC_RX_TAGGED_REG);\r\nhw_stats->rx_data_err += dsaf_read_dev(drv, GMAC_RX_DATA_ERR_REG);\r\nhw_stats->rx_align_err\r\n+= dsaf_read_dev(drv, GMAC_RX_ALIGN_ERRORS_REG);\r\nhw_stats->rx_oversize\r\n+= dsaf_read_dev(drv, GMAC_RX_LONG_ERRORS_REG);\r\nhw_stats->rx_jabber_err\r\n+= dsaf_read_dev(drv, GMAC_RX_JABBER_ERRORS_REG);\r\nhw_stats->rx_pfc_tc0\r\n+= dsaf_read_dev(drv, GMAC_RX_PAUSE_MACCTRL_FRAM_REG);\r\nhw_stats->rx_unknown_ctrl\r\n+= dsaf_read_dev(drv, GMAC_RX_UNKNOWN_MACCTRL_FRAM_REG);\r\nhw_stats->rx_long_err\r\n+= dsaf_read_dev(drv, GMAC_RX_VERY_LONG_ERR_CNT_REG);\r\nhw_stats->rx_minto64\r\n+= dsaf_read_dev(drv, GMAC_RX_RUNT_ERR_CNT_REG);\r\nhw_stats->rx_under_min\r\n+= dsaf_read_dev(drv, GMAC_RX_SHORT_ERR_CNT_REG);\r\nhw_stats->rx_filter_pkts\r\n+= dsaf_read_dev(drv, GMAC_RX_FILT_PKT_CNT_REG);\r\nhw_stats->rx_filter_bytes\r\n+= dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_FILT_REG);\r\nhw_stats->rx_fifo_overrun_err\r\n+= dsaf_read_dev(drv, GMAC_RX_OVERRUN_CNT_REG);\r\nhw_stats->rx_len_err\r\n+= dsaf_read_dev(drv, GMAC_RX_LENGTHFIELD_ERR_CNT_REG);\r\nhw_stats->rx_comma_err\r\n+= dsaf_read_dev(drv, GMAC_RX_FAIL_COMMA_CNT_REG);\r\nhw_stats->tx_good_bytes\r\n+= dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_OK_REG);\r\nhw_stats->tx_bad_bytes\r\n+= dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_BAD_REG);\r\nhw_stats->tx_uc_pkts += dsaf_read_dev(drv, GMAC_TX_UC_PKTS_REG);\r\nhw_stats->tx_mc_pkts += dsaf_read_dev(drv, GMAC_TX_MC_PKTS_REG);\r\nhw_stats->tx_bc_pkts += dsaf_read_dev(drv, GMAC_TX_BC_PKTS_REG);\r\nhw_stats->tx_64bytes\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_64OCTETS_REG);\r\nhw_stats->tx_65to127\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_65TO127OCTETS_REG);\r\nhw_stats->tx_128to255\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_128TO255OCTETS_REG);\r\nhw_stats->tx_256to511\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_255TO511OCTETS_REG);\r\nhw_stats->tx_512to1023\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_512TO1023OCTETS_REG);\r\nhw_stats->tx_1024to1518\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_1024TO1518OCTETS_REG);\r\nhw_stats->tx_1519tomax\r\n+= dsaf_read_dev(drv, GMAC_TX_PKTS_1519TOMAXOCTETS_REG);\r\nhw_stats->tx_jabber_err\r\n+= dsaf_read_dev(drv, GMAC_TX_EXCESSIVE_LENGTH_DROP_REG);\r\nhw_stats->tx_underrun_err\r\n+= dsaf_read_dev(drv, GMAC_TX_UNDERRUN_REG);\r\nhw_stats->tx_vlan += dsaf_read_dev(drv, GMAC_TX_TAGGED_REG);\r\nhw_stats->tx_crc_err += dsaf_read_dev(drv, GMAC_TX_CRC_ERROR_REG);\r\nhw_stats->tx_pfc_tc0\r\n+= dsaf_read_dev(drv, GMAC_TX_PAUSE_FRAMES_REG);\r\n}\r\nstatic void hns_gmac_set_mac_addr(void *mac_drv, char *mac_addr)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nu32 high_val = mac_addr[1] | (mac_addr[0] << 8);\r\nu32 low_val = mac_addr[5] | (mac_addr[4] << 8)\r\n| (mac_addr[3] << 16) | (mac_addr[2] << 24);\r\nu32 val = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG);\r\nu32 sta_addr_en = dsaf_get_bit(val, GMAC_ADDR_EN_B);\r\ndsaf_write_dev(drv, GMAC_STATION_ADDR_LOW_2_REG, low_val);\r\ndsaf_write_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG,\r\nhigh_val | (sta_addr_en << GMAC_ADDR_EN_B));\r\n}\r\nstatic int hns_gmac_config_loopback(void *mac_drv, enum hnae_loop loop_mode,\r\nu8 enable)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nswitch (loop_mode) {\r\ncase MAC_INTERNALLOOP_MAC:\r\ndsaf_set_dev_bit(drv, GMAC_LOOP_REG, GMAC_LP_REG_CF2MI_LP_EN_B,\r\n!!enable);\r\nbreak;\r\ndefault:\r\ndev_err(drv->dev, "loop_mode error\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hns_gmac_config_pad_and_crc(void *mac_drv, u8 newval)\r\n{\r\nu32 tx_ctrl;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\ntx_ctrl = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\r\ndsaf_set_bit(tx_ctrl, GMAC_TX_PAD_EN_B, !!newval);\r\ndsaf_set_bit(tx_ctrl, GMAC_TX_CRC_ADD_B, !!newval);\r\ndsaf_write_dev(drv, GMAC_TRANSMIT_CONTROL_REG, tx_ctrl);\r\n}\r\nstatic void hns_gmac_get_id(void *mac_drv, u8 *mac_id)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*mac_id = drv->mac_id;\r\n}\r\nstatic void hns_gmac_get_info(void *mac_drv, struct mac_info *mac_info)\r\n{\r\nenum hns_gmac_duplex_mdoe duplex;\r\nenum hns_port_mode speed;\r\nu32 rx_pause;\r\nu32 tx_pause;\r\nu32 rx;\r\nu32 tx;\r\nu16 fc_tx_timer;\r\nstruct hns_gmac_port_mode_cfg port_mode = { GMAC_10M_MII, 0 };\r\nhns_gmac_port_mode_get(mac_drv, &port_mode);\r\nmac_info->pad_and_crc_en = port_mode.crc_add && port_mode.pad_enable;\r\nmac_info->auto_neg = port_mode.an_enable;\r\nhns_gmac_get_tx_auto_pause_frames(mac_drv, &fc_tx_timer);\r\nmac_info->tx_pause_time = fc_tx_timer;\r\nhns_gmac_get_en(mac_drv, &rx, &tx);\r\nmac_info->port_en = rx && tx;\r\nhns_gmac_get_duplex_type(mac_drv, &duplex);\r\nmac_info->duplex = duplex;\r\nhns_gmac_get_port_mode(mac_drv, &speed);\r\nswitch (speed) {\r\ncase GMAC_10M_SGMII:\r\nmac_info->speed = MAC_SPEED_10;\r\nbreak;\r\ncase GMAC_100M_SGMII:\r\nmac_info->speed = MAC_SPEED_100;\r\nbreak;\r\ncase GMAC_1000M_SGMII:\r\nmac_info->speed = MAC_SPEED_1000;\r\nbreak;\r\ndefault:\r\nmac_info->speed = 0;\r\nbreak;\r\n}\r\nhns_gmac_get_pausefrm_cfg(mac_drv, &rx_pause, &tx_pause);\r\nmac_info->rx_pause_en = rx_pause;\r\nmac_info->tx_pause_en = tx_pause;\r\n}\r\nstatic void hns_gmac_autoneg_stat(void *mac_drv, u32 *enable)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*enable = dsaf_get_dev_bit(drv, GMAC_TRANSMIT_CONTROL_REG,\r\nGMAC_TX_AN_EN_B);\r\n}\r\nstatic void hns_gmac_get_link_status(void *mac_drv, u32 *link_stat)\r\n{\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\n*link_stat = dsaf_get_dev_bit(drv, GMAC_AN_NEG_STATE_REG,\r\nGMAC_AN_NEG_STAT_RX_SYNC_OK_B);\r\n}\r\nstatic void hns_gmac_get_regs(void *mac_drv, void *data)\r\n{\r\nu32 *regs = data;\r\nint i;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nregs[0] = dsaf_read_dev(drv, GMAC_DUPLEX_TYPE_REG);\r\nregs[1] = dsaf_read_dev(drv, GMAC_FD_FC_TYPE_REG);\r\nregs[2] = dsaf_read_dev(drv, GMAC_FC_TX_TIMER_REG);\r\nregs[3] = dsaf_read_dev(drv, GMAC_FD_FC_ADDR_LOW_REG);\r\nregs[4] = dsaf_read_dev(drv, GMAC_FD_FC_ADDR_HIGH_REG);\r\nregs[5] = dsaf_read_dev(drv, GMAC_IPG_TX_TIMER_REG);\r\nregs[6] = dsaf_read_dev(drv, GMAC_PAUSE_THR_REG);\r\nregs[7] = dsaf_read_dev(drv, GMAC_MAX_FRM_SIZE_REG);\r\nregs[8] = dsaf_read_dev(drv, GMAC_PORT_MODE_REG);\r\nregs[9] = dsaf_read_dev(drv, GMAC_PORT_EN_REG);\r\nregs[10] = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\r\nregs[11] = dsaf_read_dev(drv, GMAC_SHORT_RUNTS_THR_REG);\r\nregs[12] = dsaf_read_dev(drv, GMAC_AN_NEG_STATE_REG);\r\nregs[13] = dsaf_read_dev(drv, GMAC_TX_LOCAL_PAGE_REG);\r\nregs[14] = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\r\nregs[15] = dsaf_read_dev(drv, GMAC_REC_FILT_CONTROL_REG);\r\nregs[16] = dsaf_read_dev(drv, GMAC_PTP_CONFIG_REG);\r\nregs[17] = dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_OK_REG);\r\nregs[18] = dsaf_read_dev(drv, GMAC_RX_OCTETS_BAD_REG);\r\nregs[19] = dsaf_read_dev(drv, GMAC_RX_UC_PKTS_REG);\r\nregs[20] = dsaf_read_dev(drv, GMAC_RX_MC_PKTS_REG);\r\nregs[21] = dsaf_read_dev(drv, GMAC_RX_BC_PKTS_REG);\r\nregs[22] = dsaf_read_dev(drv, GMAC_RX_PKTS_64OCTETS_REG);\r\nregs[23] = dsaf_read_dev(drv, GMAC_RX_PKTS_65TO127OCTETS_REG);\r\nregs[24] = dsaf_read_dev(drv, GMAC_RX_PKTS_128TO255OCTETS_REG);\r\nregs[25] = dsaf_read_dev(drv, GMAC_RX_PKTS_255TO511OCTETS_REG);\r\nregs[26] = dsaf_read_dev(drv, GMAC_RX_PKTS_512TO1023OCTETS_REG);\r\nregs[27] = dsaf_read_dev(drv, GMAC_RX_PKTS_1024TO1518OCTETS_REG);\r\nregs[28] = dsaf_read_dev(drv, GMAC_RX_PKTS_1519TOMAXOCTETS_REG);\r\nregs[29] = dsaf_read_dev(drv, GMAC_RX_FCS_ERRORS_REG);\r\nregs[30] = dsaf_read_dev(drv, GMAC_RX_TAGGED_REG);\r\nregs[31] = dsaf_read_dev(drv, GMAC_RX_DATA_ERR_REG);\r\nregs[32] = dsaf_read_dev(drv, GMAC_RX_ALIGN_ERRORS_REG);\r\nregs[33] = dsaf_read_dev(drv, GMAC_RX_LONG_ERRORS_REG);\r\nregs[34] = dsaf_read_dev(drv, GMAC_RX_JABBER_ERRORS_REG);\r\nregs[35] = dsaf_read_dev(drv, GMAC_RX_PAUSE_MACCTRL_FRAM_REG);\r\nregs[36] = dsaf_read_dev(drv, GMAC_RX_UNKNOWN_MACCTRL_FRAM_REG);\r\nregs[37] = dsaf_read_dev(drv, GMAC_RX_VERY_LONG_ERR_CNT_REG);\r\nregs[38] = dsaf_read_dev(drv, GMAC_RX_RUNT_ERR_CNT_REG);\r\nregs[39] = dsaf_read_dev(drv, GMAC_RX_SHORT_ERR_CNT_REG);\r\nregs[40] = dsaf_read_dev(drv, GMAC_RX_FILT_PKT_CNT_REG);\r\nregs[41] = dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_FILT_REG);\r\nregs[42] = dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_OK_REG);\r\nregs[43] = dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_BAD_REG);\r\nregs[44] = dsaf_read_dev(drv, GMAC_TX_UC_PKTS_REG);\r\nregs[45] = dsaf_read_dev(drv, GMAC_TX_MC_PKTS_REG);\r\nregs[46] = dsaf_read_dev(drv, GMAC_TX_BC_PKTS_REG);\r\nregs[47] = dsaf_read_dev(drv, GMAC_TX_PKTS_64OCTETS_REG);\r\nregs[48] = dsaf_read_dev(drv, GMAC_TX_PKTS_65TO127OCTETS_REG);\r\nregs[49] = dsaf_read_dev(drv, GMAC_TX_PKTS_128TO255OCTETS_REG);\r\nregs[50] = dsaf_read_dev(drv, GMAC_TX_PKTS_255TO511OCTETS_REG);\r\nregs[51] = dsaf_read_dev(drv, GMAC_TX_PKTS_512TO1023OCTETS_REG);\r\nregs[52] = dsaf_read_dev(drv, GMAC_TX_PKTS_1024TO1518OCTETS_REG);\r\nregs[53] = dsaf_read_dev(drv, GMAC_TX_PKTS_1519TOMAXOCTETS_REG);\r\nregs[54] = dsaf_read_dev(drv, GMAC_TX_EXCESSIVE_LENGTH_DROP_REG);\r\nregs[55] = dsaf_read_dev(drv, GMAC_TX_UNDERRUN_REG);\r\nregs[56] = dsaf_read_dev(drv, GMAC_TX_TAGGED_REG);\r\nregs[57] = dsaf_read_dev(drv, GMAC_TX_CRC_ERROR_REG);\r\nregs[58] = dsaf_read_dev(drv, GMAC_TX_PAUSE_FRAMES_REG);\r\nregs[59] = dsaf_read_dev(drv, GAMC_RX_MAX_FRAME);\r\nregs[60] = dsaf_read_dev(drv, GMAC_LINE_LOOP_BACK_REG);\r\nregs[61] = dsaf_read_dev(drv, GMAC_CF_CRC_STRIP_REG);\r\nregs[62] = dsaf_read_dev(drv, GMAC_MODE_CHANGE_EN_REG);\r\nregs[63] = dsaf_read_dev(drv, GMAC_SIXTEEN_BIT_CNTR_REG);\r\nregs[64] = dsaf_read_dev(drv, GMAC_LD_LINK_COUNTER_REG);\r\nregs[65] = dsaf_read_dev(drv, GMAC_LOOP_REG);\r\nregs[66] = dsaf_read_dev(drv, GMAC_RECV_CONTROL_REG);\r\nregs[67] = dsaf_read_dev(drv, GMAC_VLAN_CODE_REG);\r\nregs[68] = dsaf_read_dev(drv, GMAC_RX_OVERRUN_CNT_REG);\r\nregs[69] = dsaf_read_dev(drv, GMAC_RX_LENGTHFIELD_ERR_CNT_REG);\r\nregs[70] = dsaf_read_dev(drv, GMAC_RX_FAIL_COMMA_CNT_REG);\r\nregs[71] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_0_REG);\r\nregs[72] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_0_REG);\r\nregs[73] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_1_REG);\r\nregs[74] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_1_REG);\r\nregs[75] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_2_REG);\r\nregs[76] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG);\r\nregs[77] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_3_REG);\r\nregs[78] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_3_REG);\r\nregs[79] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_4_REG);\r\nregs[80] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_4_REG);\r\nregs[81] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_5_REG);\r\nregs[82] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_5_REG);\r\nregs[83] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_MSK_0_REG);\r\nregs[84] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_MSK_0_REG);\r\nregs[85] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_MSK_1_REG);\r\nregs[86] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_MSK_1_REG);\r\nregs[87] = dsaf_read_dev(drv, GMAC_MAC_SKIP_LEN_REG);\r\nregs[88] = dsaf_read_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG);\r\nfor (i = 89; i < 96; i++)\r\nregs[i] = 0xaaaaaaaa;\r\n}\r\nstatic void hns_gmac_get_stats(void *mac_drv, u64 *data)\r\n{\r\nu32 i;\r\nu64 *buf = data;\r\nstruct mac_driver *drv = (struct mac_driver *)mac_drv;\r\nstruct mac_hw_stats *hw_stats = NULL;\r\nhw_stats = &drv->mac_cb->hw_stats;\r\nfor (i = 0; i < ARRAY_SIZE(g_gmac_stats_string); i++) {\r\nbuf[i] = DSAF_STATS_READ(hw_stats,\r\ng_gmac_stats_string[i].offset);\r\n}\r\n}\r\nstatic void hns_gmac_get_strings(u32 stringset, u8 *data)\r\n{\r\nchar *buff = (char *)data;\r\nu32 i;\r\nif (stringset != ETH_SS_STATS)\r\nreturn;\r\nfor (i = 0; i < ARRAY_SIZE(g_gmac_stats_string); i++) {\r\nsnprintf(buff, ETH_GSTRING_LEN, "%s",\r\ng_gmac_stats_string[i].desc);\r\nbuff = buff + ETH_GSTRING_LEN;\r\n}\r\n}\r\nstatic int hns_gmac_get_sset_count(int stringset)\r\n{\r\nif (stringset == ETH_SS_STATS)\r\nreturn ARRAY_SIZE(g_gmac_stats_string);\r\nreturn 0;\r\n}\r\nstatic int hns_gmac_get_regs_count(void)\r\n{\r\nreturn ETH_GMAC_DUMP_NUM;\r\n}\r\nvoid *hns_gmac_config(struct hns_mac_cb *mac_cb, struct mac_params *mac_param)\r\n{\r\nstruct mac_driver *mac_drv;\r\nmac_drv = devm_kzalloc(mac_cb->dev, sizeof(*mac_drv), GFP_KERNEL);\r\nif (!mac_drv)\r\nreturn NULL;\r\nmac_drv->mac_init = hns_gmac_init;\r\nmac_drv->mac_enable = hns_gmac_enable;\r\nmac_drv->mac_disable = hns_gmac_disable;\r\nmac_drv->mac_free = hns_gmac_free;\r\nmac_drv->adjust_link = hns_gmac_adjust_link;\r\nmac_drv->set_tx_auto_pause_frames = hns_gmac_set_tx_auto_pause_frames;\r\nmac_drv->config_max_frame_length = hns_gmac_config_max_frame_length;\r\nmac_drv->mac_pausefrm_cfg = hns_gmac_pause_frm_cfg;\r\nmac_drv->mac_id = mac_param->mac_id;\r\nmac_drv->mac_mode = mac_param->mac_mode;\r\nmac_drv->io_base = mac_param->vaddr;\r\nmac_drv->dev = mac_param->dev;\r\nmac_drv->mac_cb = mac_cb;\r\nmac_drv->set_mac_addr = hns_gmac_set_mac_addr;\r\nmac_drv->set_an_mode = hns_gmac_config_an_mode;\r\nmac_drv->config_loopback = hns_gmac_config_loopback;\r\nmac_drv->config_pad_and_crc = hns_gmac_config_pad_and_crc;\r\nmac_drv->config_half_duplex = hns_gmac_set_duplex_type;\r\nmac_drv->set_rx_ignore_pause_frames = hns_gmac_set_rx_auto_pause_frames;\r\nmac_drv->mac_get_id = hns_gmac_get_id;\r\nmac_drv->get_info = hns_gmac_get_info;\r\nmac_drv->autoneg_stat = hns_gmac_autoneg_stat;\r\nmac_drv->get_pause_enable = hns_gmac_get_pausefrm_cfg;\r\nmac_drv->get_link_status = hns_gmac_get_link_status;\r\nmac_drv->get_regs = hns_gmac_get_regs;\r\nmac_drv->get_regs_count = hns_gmac_get_regs_count;\r\nmac_drv->get_ethtool_stats = hns_gmac_get_stats;\r\nmac_drv->get_sset_count = hns_gmac_get_sset_count;\r\nmac_drv->get_strings = hns_gmac_get_strings;\r\nmac_drv->update_stats = hns_gmac_update_stats;\r\nmac_drv->set_promiscuous = hns_gmac_set_promisc;\r\nreturn (void *)mac_drv;\r\n}

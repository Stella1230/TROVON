static void set_trace_idt_ctr(int val)\r\n{\r\natomic_set(&trace_idt_ctr, val);\r\nwmb();\r\n}\r\nstatic void switch_idt(void *arg)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nload_current_idt();\r\nlocal_irq_restore(flags);\r\n}\r\nvoid trace_irq_vector_regfunc(void)\r\n{\r\nmutex_lock(&irq_vector_mutex);\r\nif (!trace_irq_vector_refcount) {\r\nset_trace_idt_ctr(1);\r\nsmp_call_function(switch_idt, NULL, 0);\r\nswitch_idt(NULL);\r\n}\r\ntrace_irq_vector_refcount++;\r\nmutex_unlock(&irq_vector_mutex);\r\n}\r\nvoid trace_irq_vector_unregfunc(void)\r\n{\r\nmutex_lock(&irq_vector_mutex);\r\ntrace_irq_vector_refcount--;\r\nif (!trace_irq_vector_refcount) {\r\nset_trace_idt_ctr(0);\r\nsmp_call_function(switch_idt, NULL, 0);\r\nswitch_idt(NULL);\r\n}\r\nmutex_unlock(&irq_vector_mutex);\r\n}

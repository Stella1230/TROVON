void __init efi_bgrt_init(void)\r\n{\r\nacpi_status status;\r\nvoid *image;\r\nstruct bmp_header bmp_header;\r\nif (acpi_disabled)\r\nreturn;\r\nstatus = acpi_get_table("BGRT", 0,\r\n(struct acpi_table_header **)&bgrt_tab);\r\nif (ACPI_FAILURE(status))\r\nreturn;\r\nif (bgrt_tab->header.length < sizeof(*bgrt_tab)) {\r\npr_notice("Ignoring BGRT: invalid length %u (expected %zu)\n",\r\nbgrt_tab->header.length, sizeof(*bgrt_tab));\r\nreturn;\r\n}\r\nif (bgrt_tab->version != 1) {\r\npr_notice("Ignoring BGRT: invalid version %u (expected 1)\n",\r\nbgrt_tab->version);\r\nreturn;\r\n}\r\nif (bgrt_tab->status & 0xfe) {\r\npr_notice("Ignoring BGRT: reserved status bits are non-zero %u\n",\r\nbgrt_tab->status);\r\nreturn;\r\n}\r\nif (bgrt_tab->image_type != 0) {\r\npr_notice("Ignoring BGRT: invalid image type %u (expected 0)\n",\r\nbgrt_tab->image_type);\r\nreturn;\r\n}\r\nif (!bgrt_tab->image_address) {\r\npr_notice("Ignoring BGRT: null image address\n");\r\nreturn;\r\n}\r\nimage = memremap(bgrt_tab->image_address, sizeof(bmp_header), MEMREMAP_WB);\r\nif (!image) {\r\npr_notice("Ignoring BGRT: failed to map image header memory\n");\r\nreturn;\r\n}\r\nmemcpy(&bmp_header, image, sizeof(bmp_header));\r\nmemunmap(image);\r\nif (bmp_header.id != 0x4d42) {\r\npr_notice("Ignoring BGRT: Incorrect BMP magic number 0x%x (expected 0x4d42)\n",\r\nbmp_header.id);\r\nreturn;\r\n}\r\nbgrt_image_size = bmp_header.size;\r\nbgrt_image = kmalloc(bgrt_image_size, GFP_KERNEL | __GFP_NOWARN);\r\nif (!bgrt_image) {\r\npr_notice("Ignoring BGRT: failed to allocate memory for image (wanted %zu bytes)\n",\r\nbgrt_image_size);\r\nreturn;\r\n}\r\nimage = memremap(bgrt_tab->image_address, bmp_header.size, MEMREMAP_WB);\r\nif (!image) {\r\npr_notice("Ignoring BGRT: failed to map image memory\n");\r\nkfree(bgrt_image);\r\nbgrt_image = NULL;\r\nreturn;\r\n}\r\nmemcpy(bgrt_image, image, bgrt_image_size);\r\nmemunmap(image);\r\n}

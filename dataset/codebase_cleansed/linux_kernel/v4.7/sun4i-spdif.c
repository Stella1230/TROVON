static void sun4i_spdif_configure(struct sun4i_spdif_dev *host)\r\n{\r\nregmap_write(host->regmap, SUN4I_SPDIF_CTL, SUN4I_SPDIF_CTL_RESET);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_FCTL,\r\nSUN4I_SPDIF_FCTL_FTX, SUN4I_SPDIF_FCTL_FTX);\r\nregmap_write(host->regmap, SUN4I_SPDIF_TXCNT, 0);\r\n}\r\nstatic void sun4i_snd_txctrl_on(struct snd_pcm_substream *substream,\r\nstruct sun4i_spdif_dev *host)\r\n{\r\nif (substream->runtime->channels == 1)\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\r\nSUN4I_SPDIF_TXCFG_SINGLEMOD,\r\nSUN4I_SPDIF_TXCFG_SINGLEMOD);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\r\nSUN4I_SPDIF_TXCFG_TXEN, SUN4I_SPDIF_TXCFG_TXEN);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_INT,\r\nSUN4I_SPDIF_INT_TXDRQEN, SUN4I_SPDIF_INT_TXDRQEN);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_CTL,\r\nSUN4I_SPDIF_CTL_GEN, SUN4I_SPDIF_CTL_GEN);\r\n}\r\nstatic void sun4i_snd_txctrl_off(struct snd_pcm_substream *substream,\r\nstruct sun4i_spdif_dev *host)\r\n{\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_TXCFG,\r\nSUN4I_SPDIF_TXCFG_TXEN, 0);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_INT,\r\nSUN4I_SPDIF_INT_TXDRQEN, 0);\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_CTL,\r\nSUN4I_SPDIF_CTL_GEN, 0);\r\n}\r\nstatic int sun4i_spdif_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(rtd->cpu_dai);\r\nif (substream->stream != SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn -EINVAL;\r\nsun4i_spdif_configure(host);\r\nreturn 0;\r\n}\r\nstatic int sun4i_spdif_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nint ret = 0;\r\nint fmt;\r\nunsigned long rate = params_rate(params);\r\nu32 mclk_div = 0;\r\nunsigned int mclk = 0;\r\nu32 reg_val;\r\nstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct platform_device *pdev = host->pdev;\r\nswitch (params_channels(params)) {\r\ncase 1:\r\ncase 2:\r\nfmt = 0;\r\nbreak;\r\ncase 4:\r\nfmt = SUN4I_SPDIF_TXCFG_NONAUDIO;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nfmt |= SUN4I_SPDIF_TXCFG_FMT16BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S20_3LE:\r\nfmt |= SUN4I_SPDIF_TXCFG_FMT20BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\nfmt |= SUN4I_SPDIF_TXCFG_FMT24BIT;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (rate) {\r\ncase 22050:\r\ncase 44100:\r\ncase 88200:\r\ncase 176400:\r\nmclk = 22579200;\r\nbreak;\r\ncase 24000:\r\ncase 32000:\r\ncase 48000:\r\ncase 96000:\r\ncase 192000:\r\nmclk = 24576000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = clk_set_rate(host->spdif_clk, mclk);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"Setting SPDIF clock rate for %d Hz failed!\n", mclk);\r\nreturn ret;\r\n}\r\nregmap_update_bits(host->regmap, SUN4I_SPDIF_FCTL,\r\nSUN4I_SPDIF_FCTL_TXIM, SUN4I_SPDIF_FCTL_TXIM);\r\nswitch (rate) {\r\ncase 22050:\r\ncase 24000:\r\nmclk_div = 8;\r\nbreak;\r\ncase 32000:\r\nmclk_div = 6;\r\nbreak;\r\ncase 44100:\r\ncase 48000:\r\nmclk_div = 4;\r\nbreak;\r\ncase 88200:\r\ncase 96000:\r\nmclk_div = 2;\r\nbreak;\r\ncase 176400:\r\ncase 192000:\r\nmclk_div = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreg_val = 0;\r\nreg_val |= SUN4I_SPDIF_TXCFG_ASS;\r\nreg_val |= fmt;\r\nreg_val |= SUN4I_SPDIF_TXCFG_CHSTMODE;\r\nreg_val |= SUN4I_SPDIF_TXCFG_TXRATIO(mclk_div - 1);\r\nregmap_write(host->regmap, SUN4I_SPDIF_TXCFG, reg_val);\r\nreturn 0;\r\n}\r\nstatic int sun4i_spdif_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nint ret = 0;\r\nstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(dai);\r\nif (substream->stream != SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn -EINVAL;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nsun4i_snd_txctrl_on(substream, host);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nsun4i_snd_txctrl_off(substream, host);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int sun4i_spdif_soc_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_spdif_dev *host = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_init_dma_data(dai, &host->dma_params_tx, NULL);\r\nreturn 0;\r\n}\r\nstatic int sun4i_spdif_runtime_suspend(struct device *dev)\r\n{\r\nstruct sun4i_spdif_dev *host = dev_get_drvdata(dev);\r\nclk_disable_unprepare(host->spdif_clk);\r\nclk_disable_unprepare(host->apb_clk);\r\nreturn 0;\r\n}\r\nstatic int sun4i_spdif_runtime_resume(struct device *dev)\r\n{\r\nstruct sun4i_spdif_dev *host = dev_get_drvdata(dev);\r\nclk_prepare_enable(host->spdif_clk);\r\nclk_prepare_enable(host->apb_clk);\r\nreturn 0;\r\n}\r\nstatic int sun4i_spdif_probe(struct platform_device *pdev)\r\n{\r\nstruct sun4i_spdif_dev *host;\r\nstruct resource *res;\r\nint ret;\r\nvoid __iomem *base;\r\ndev_dbg(&pdev->dev, "Entered %s\n", __func__);\r\nhost = devm_kzalloc(&pdev->dev, sizeof(*host), GFP_KERNEL);\r\nif (!host)\r\nreturn -ENOMEM;\r\nhost->pdev = pdev;\r\nmemcpy(&host->cpu_dai_drv, &sun4i_spdif_dai, sizeof(sun4i_spdif_dai));\r\nhost->cpu_dai_drv.name = dev_name(&pdev->dev);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nhost->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&sun4i_spdif_regmap_config);\r\nhost->apb_clk = devm_clk_get(&pdev->dev, "apb");\r\nif (IS_ERR(host->apb_clk)) {\r\ndev_err(&pdev->dev, "failed to get a apb clock.\n");\r\nreturn PTR_ERR(host->apb_clk);\r\n}\r\nhost->spdif_clk = devm_clk_get(&pdev->dev, "spdif");\r\nif (IS_ERR(host->spdif_clk)) {\r\ndev_err(&pdev->dev, "failed to get a spdif clock.\n");\r\nret = PTR_ERR(host->spdif_clk);\r\ngoto err_disable_apb_clk;\r\n}\r\nhost->dma_params_tx.addr = res->start + SUN4I_SPDIF_TXFIFO;\r\nhost->dma_params_tx.maxburst = 4;\r\nhost->dma_params_tx.addr_width = DMA_SLAVE_BUSWIDTH_2_BYTES;\r\nplatform_set_drvdata(pdev, host);\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&sun4i_spdif_component, &sun4i_spdif_dai, 1);\r\nif (ret)\r\ngoto err_disable_apb_clk;\r\npm_runtime_enable(&pdev->dev);\r\nif (!pm_runtime_enabled(&pdev->dev)) {\r\nret = sun4i_spdif_runtime_resume(&pdev->dev);\r\nif (ret)\r\ngoto err_unregister;\r\n}\r\nret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret)\r\ngoto err_suspend;\r\nreturn 0;\r\nerr_suspend:\r\nif (!pm_runtime_status_suspended(&pdev->dev))\r\nsun4i_spdif_runtime_suspend(&pdev->dev);\r\nerr_unregister:\r\npm_runtime_disable(&pdev->dev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nerr_disable_apb_clk:\r\nclk_disable_unprepare(host->apb_clk);\r\nreturn ret;\r\n}\r\nstatic int sun4i_spdif_remove(struct platform_device *pdev)\r\n{\r\npm_runtime_disable(&pdev->dev);\r\nif (!pm_runtime_status_suspended(&pdev->dev))\r\nsun4i_spdif_runtime_suspend(&pdev->dev);\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nreturn 0;\r\n}

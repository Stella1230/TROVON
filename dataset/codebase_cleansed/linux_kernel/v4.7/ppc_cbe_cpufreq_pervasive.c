int cbe_cpufreq_set_pmode(int cpu, unsigned int pmode)\r\n{\r\nstruct cbe_pmd_regs __iomem *pmd_regs;\r\nstruct cbe_mic_tm_regs __iomem *mic_tm_regs;\r\nunsigned long flags;\r\nu64 value;\r\n#ifdef DEBUG\r\nlong time;\r\n#endif\r\nlocal_irq_save(flags);\r\nmic_tm_regs = cbe_get_cpu_mic_tm_regs(cpu);\r\npmd_regs = cbe_get_cpu_pmd_regs(cpu);\r\n#ifdef DEBUG\r\ntime = jiffies;\r\n#endif\r\nout_be64(&mic_tm_regs->slow_fast_timer_0, MIC_Slow_Fast_Timer_table[pmode]);\r\nout_be64(&mic_tm_regs->slow_fast_timer_1, MIC_Slow_Fast_Timer_table[pmode]);\r\nout_be64(&mic_tm_regs->slow_next_timer_0, MIC_Slow_Next_Timer_table[pmode]);\r\nout_be64(&mic_tm_regs->slow_next_timer_1, MIC_Slow_Next_Timer_table[pmode]);\r\nvalue = in_be64(&pmd_regs->pmcr);\r\nvalue &= 0xFFFFFFFFFFFFFFF8ull;\r\nvalue |= pmode;\r\nout_be64(&pmd_regs->pmcr, value);\r\n#ifdef DEBUG\r\nvalue = in_be64(&pmd_regs->pmsr) & 0x07;\r\nwhile (value != pmode) {\r\ncpu_relax();\r\nvalue = in_be64(&pmd_regs->pmsr) & 0x07;\r\n}\r\ntime = jiffies - time;\r\ntime = jiffies_to_msecs(time);\r\npr_debug("had to wait %lu ms for a transition using " \\r\n"pervasive unit\n", time);\r\n#endif\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nint cbe_cpufreq_get_pmode(int cpu)\r\n{\r\nint ret;\r\nstruct cbe_pmd_regs __iomem *pmd_regs;\r\npmd_regs = cbe_get_cpu_pmd_regs(cpu);\r\nret = in_be64(&pmd_regs->pmsr) & 0x07;\r\nreturn ret;\r\n}

static inline struct ptn3460_bridge *\r\nbridge_to_ptn3460(struct drm_bridge *bridge)\r\n{\r\nreturn container_of(bridge, struct ptn3460_bridge, bridge);\r\n}\r\nstatic inline struct ptn3460_bridge *\r\nconnector_to_ptn3460(struct drm_connector *connector)\r\n{\r\nreturn container_of(connector, struct ptn3460_bridge, connector);\r\n}\r\nstatic int ptn3460_read_bytes(struct ptn3460_bridge *ptn_bridge, char addr,\r\nu8 *buf, int len)\r\n{\r\nint ret;\r\nret = i2c_master_send(ptn_bridge->client, &addr, 1);\r\nif (ret <= 0) {\r\nDRM_ERROR("Failed to send i2c command, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nret = i2c_master_recv(ptn_bridge->client, buf, len);\r\nif (ret <= 0) {\r\nDRM_ERROR("Failed to recv i2c data, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ptn3460_write_byte(struct ptn3460_bridge *ptn_bridge, char addr,\r\nchar val)\r\n{\r\nint ret;\r\nchar buf[2];\r\nbuf[0] = addr;\r\nbuf[1] = val;\r\nret = i2c_master_send(ptn_bridge->client, buf, ARRAY_SIZE(buf));\r\nif (ret <= 0) {\r\nDRM_ERROR("Failed to send i2c command, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ptn3460_select_edid(struct ptn3460_bridge *ptn_bridge)\r\n{\r\nint ret;\r\nchar val;\r\nret = ptn3460_write_byte(ptn_bridge, PTN3460_EDID_SRAM_LOAD_ADDR,\r\nptn_bridge->edid_emulation);\r\nif (ret) {\r\nDRM_ERROR("Failed to transfer EDID to sram, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nval = 1 << PTN3460_EDID_ENABLE_EMULATION |\r\nptn_bridge->edid_emulation << PTN3460_EDID_EMULATION_SELECTION;\r\nret = ptn3460_write_byte(ptn_bridge, PTN3460_EDID_EMULATION_ADDR, val);\r\nif (ret) {\r\nDRM_ERROR("Failed to write EDID value, ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ptn3460_pre_enable(struct drm_bridge *bridge)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = bridge_to_ptn3460(bridge);\r\nint ret;\r\nif (ptn_bridge->enabled)\r\nreturn;\r\ngpiod_set_value(ptn_bridge->gpio_pd_n, 1);\r\ngpiod_set_value(ptn_bridge->gpio_rst_n, 0);\r\nusleep_range(10, 20);\r\ngpiod_set_value(ptn_bridge->gpio_rst_n, 1);\r\nif (drm_panel_prepare(ptn_bridge->panel)) {\r\nDRM_ERROR("failed to prepare panel\n");\r\nreturn;\r\n}\r\nmsleep(90);\r\nret = ptn3460_select_edid(ptn_bridge);\r\nif (ret)\r\nDRM_ERROR("Select EDID failed ret=%d\n", ret);\r\nptn_bridge->enabled = true;\r\n}\r\nstatic void ptn3460_enable(struct drm_bridge *bridge)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = bridge_to_ptn3460(bridge);\r\nif (drm_panel_enable(ptn_bridge->panel)) {\r\nDRM_ERROR("failed to enable panel\n");\r\nreturn;\r\n}\r\n}\r\nstatic void ptn3460_disable(struct drm_bridge *bridge)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = bridge_to_ptn3460(bridge);\r\nif (!ptn_bridge->enabled)\r\nreturn;\r\nptn_bridge->enabled = false;\r\nif (drm_panel_disable(ptn_bridge->panel)) {\r\nDRM_ERROR("failed to disable panel\n");\r\nreturn;\r\n}\r\ngpiod_set_value(ptn_bridge->gpio_rst_n, 1);\r\ngpiod_set_value(ptn_bridge->gpio_pd_n, 0);\r\n}\r\nstatic void ptn3460_post_disable(struct drm_bridge *bridge)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = bridge_to_ptn3460(bridge);\r\nif (drm_panel_unprepare(ptn_bridge->panel)) {\r\nDRM_ERROR("failed to unprepare panel\n");\r\nreturn;\r\n}\r\n}\r\nstatic int ptn3460_get_modes(struct drm_connector *connector)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge;\r\nu8 *edid;\r\nint ret, num_modes = 0;\r\nbool power_off;\r\nptn_bridge = connector_to_ptn3460(connector);\r\nif (ptn_bridge->edid)\r\nreturn drm_add_edid_modes(connector, ptn_bridge->edid);\r\npower_off = !ptn_bridge->enabled;\r\nptn3460_pre_enable(&ptn_bridge->bridge);\r\nedid = kmalloc(EDID_LENGTH, GFP_KERNEL);\r\nif (!edid) {\r\nDRM_ERROR("Failed to allocate EDID\n");\r\nreturn 0;\r\n}\r\nret = ptn3460_read_bytes(ptn_bridge, PTN3460_EDID_ADDR, edid,\r\nEDID_LENGTH);\r\nif (ret) {\r\nkfree(edid);\r\ngoto out;\r\n}\r\nptn_bridge->edid = (struct edid *)edid;\r\ndrm_mode_connector_update_edid_property(connector, ptn_bridge->edid);\r\nnum_modes = drm_add_edid_modes(connector, ptn_bridge->edid);\r\nout:\r\nif (power_off)\r\nptn3460_disable(&ptn_bridge->bridge);\r\nreturn num_modes;\r\n}\r\nstatic struct drm_encoder *ptn3460_best_encoder(struct drm_connector *connector)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = connector_to_ptn3460(connector);\r\nreturn ptn_bridge->bridge.encoder;\r\n}\r\nstatic enum drm_connector_status ptn3460_detect(struct drm_connector *connector,\r\nbool force)\r\n{\r\nreturn connector_status_connected;\r\n}\r\nstatic void ptn3460_connector_destroy(struct drm_connector *connector)\r\n{\r\ndrm_connector_cleanup(connector);\r\n}\r\nstatic int ptn3460_bridge_attach(struct drm_bridge *bridge)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = bridge_to_ptn3460(bridge);\r\nint ret;\r\nif (!bridge->encoder) {\r\nDRM_ERROR("Parent encoder object not found");\r\nreturn -ENODEV;\r\n}\r\nptn_bridge->connector.polled = DRM_CONNECTOR_POLL_HPD;\r\nret = drm_connector_init(bridge->dev, &ptn_bridge->connector,\r\n&ptn3460_connector_funcs, DRM_MODE_CONNECTOR_LVDS);\r\nif (ret) {\r\nDRM_ERROR("Failed to initialize connector with drm\n");\r\nreturn ret;\r\n}\r\ndrm_connector_helper_add(&ptn_bridge->connector,\r\n&ptn3460_connector_helper_funcs);\r\ndrm_connector_register(&ptn_bridge->connector);\r\ndrm_mode_connector_attach_encoder(&ptn_bridge->connector,\r\nbridge->encoder);\r\nif (ptn_bridge->panel)\r\ndrm_panel_attach(ptn_bridge->panel, &ptn_bridge->connector);\r\ndrm_helper_hpd_irq_event(ptn_bridge->connector.dev);\r\nreturn ret;\r\n}\r\nstatic int ptn3460_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct ptn3460_bridge *ptn_bridge;\r\nstruct device_node *endpoint, *panel_node;\r\nint ret;\r\nptn_bridge = devm_kzalloc(dev, sizeof(*ptn_bridge), GFP_KERNEL);\r\nif (!ptn_bridge) {\r\nreturn -ENOMEM;\r\n}\r\nendpoint = of_graph_get_next_endpoint(dev->of_node, NULL);\r\nif (endpoint) {\r\npanel_node = of_graph_get_remote_port_parent(endpoint);\r\nif (panel_node) {\r\nptn_bridge->panel = of_drm_find_panel(panel_node);\r\nof_node_put(panel_node);\r\nif (!ptn_bridge->panel)\r\nreturn -EPROBE_DEFER;\r\n}\r\n}\r\nptn_bridge->client = client;\r\nptn_bridge->gpio_pd_n = devm_gpiod_get(&client->dev, "powerdown",\r\nGPIOD_OUT_HIGH);\r\nif (IS_ERR(ptn_bridge->gpio_pd_n)) {\r\nret = PTR_ERR(ptn_bridge->gpio_pd_n);\r\ndev_err(dev, "cannot get gpio_pd_n %d\n", ret);\r\nreturn ret;\r\n}\r\nptn_bridge->gpio_rst_n = devm_gpiod_get(&client->dev, "reset",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(ptn_bridge->gpio_rst_n)) {\r\nret = PTR_ERR(ptn_bridge->gpio_rst_n);\r\nDRM_ERROR("cannot get gpio_rst_n %d\n", ret);\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(dev->of_node, "edid-emulation",\r\n&ptn_bridge->edid_emulation);\r\nif (ret) {\r\ndev_err(dev, "Can't read EDID emulation value\n");\r\nreturn ret;\r\n}\r\nptn_bridge->bridge.funcs = &ptn3460_bridge_funcs;\r\nptn_bridge->bridge.of_node = dev->of_node;\r\nret = drm_bridge_add(&ptn_bridge->bridge);\r\nif (ret) {\r\nDRM_ERROR("Failed to add bridge\n");\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, ptn_bridge);\r\nreturn 0;\r\n}\r\nstatic int ptn3460_remove(struct i2c_client *client)\r\n{\r\nstruct ptn3460_bridge *ptn_bridge = i2c_get_clientdata(client);\r\ndrm_bridge_remove(&ptn_bridge->bridge);\r\nreturn 0;\r\n}

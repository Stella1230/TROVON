static int tps80031_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 buff[TPS80031_RTC_TIME_NUM_REGS];\r\nint ret;\r\nret = tps80031_reads(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_SECONDS_REG, TPS80031_RTC_TIME_NUM_REGS, buff);\r\nif (ret < 0) {\r\ndev_err(dev, "reading RTC_SECONDS_REG failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(buff[0]);\r\ntm->tm_min = bcd2bin(buff[1]);\r\ntm->tm_hour = bcd2bin(buff[2]);\r\ntm->tm_mday = bcd2bin(buff[3]);\r\ntm->tm_mon = bcd2bin(buff[4]) - 1;\r\ntm->tm_year = bcd2bin(buff[5]) + RTC_YEAR_OFFSET;\r\ntm->tm_wday = bcd2bin(buff[6]);\r\nreturn 0;\r\n}\r\nstatic int tps80031_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 buff[7];\r\nint ret;\r\nbuff[0] = bin2bcd(tm->tm_sec);\r\nbuff[1] = bin2bcd(tm->tm_min);\r\nbuff[2] = bin2bcd(tm->tm_hour);\r\nbuff[3] = bin2bcd(tm->tm_mday);\r\nbuff[4] = bin2bcd(tm->tm_mon + 1);\r\nbuff[5] = bin2bcd(tm->tm_year % RTC_YEAR_OFFSET);\r\nbuff[6] = bin2bcd(tm->tm_wday);\r\nret = tps80031_clr_bits(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_CTRL_REG, STOP_RTC);\r\nif (ret < 0) {\r\ndev_err(dev->parent, "Stop RTC failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = tps80031_writes(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_SECONDS_REG,\r\nTPS80031_RTC_TIME_NUM_REGS, buff);\r\nif (ret < 0) {\r\ndev_err(dev, "writing RTC_SECONDS_REG failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nret = tps80031_set_bits(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_CTRL_REG, STOP_RTC);\r\nif (ret < 0)\r\ndev_err(dev->parent, "Start RTC failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int tps80031_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enable)\r\n{\r\nint ret;\r\nif (enable)\r\nret = tps80031_set_bits(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_INTERRUPTS_REG, ENABLE_ALARM_INT);\r\nelse\r\nret = tps80031_clr_bits(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_INTERRUPTS_REG, ENABLE_ALARM_INT);\r\nif (ret < 0) {\r\ndev_err(dev, "Update on RTC_INT failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps80031_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nu8 buff[TPS80031_RTC_ALARM_NUM_REGS];\r\nint ret;\r\nbuff[0] = bin2bcd(alrm->time.tm_sec);\r\nbuff[1] = bin2bcd(alrm->time.tm_min);\r\nbuff[2] = bin2bcd(alrm->time.tm_hour);\r\nbuff[3] = bin2bcd(alrm->time.tm_mday);\r\nbuff[4] = bin2bcd(alrm->time.tm_mon + 1);\r\nbuff[5] = bin2bcd(alrm->time.tm_year % RTC_YEAR_OFFSET);\r\nret = tps80031_writes(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_ALARM_SECONDS_REG,\r\nTPS80031_RTC_ALARM_NUM_REGS, buff);\r\nif (ret < 0) {\r\ndev_err(dev, "Writing RTC_ALARM failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn tps80031_rtc_alarm_irq_enable(dev, alrm->enabled);\r\n}\r\nstatic int tps80031_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nu8 buff[6];\r\nint ret;\r\nret = tps80031_reads(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_ALARM_SECONDS_REG,\r\nTPS80031_RTC_ALARM_NUM_REGS, buff);\r\nif (ret < 0) {\r\ndev_err(dev->parent,\r\n"reading RTC_ALARM failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nalrm->time.tm_sec = bcd2bin(buff[0]);\r\nalrm->time.tm_min = bcd2bin(buff[1]);\r\nalrm->time.tm_hour = bcd2bin(buff[2]);\r\nalrm->time.tm_mday = bcd2bin(buff[3]);\r\nalrm->time.tm_mon = bcd2bin(buff[4]) - 1;\r\nalrm->time.tm_year = bcd2bin(buff[5]) + RTC_YEAR_OFFSET;\r\nreturn 0;\r\n}\r\nstatic int clear_alarm_int_status(struct device *dev, struct tps80031_rtc *rtc)\r\n{\r\nint ret;\r\nu8 buf;\r\nret = tps80031_read(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_STATUS_REG, &buf);\r\nif (ret < 0) {\r\ndev_err(dev, "reading RTC_STATUS failed. err = %d\n", ret);\r\nreturn ret;\r\n}\r\nret = tps80031_set_bits(dev->parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_STATUS_REG, ALARM_INT_STATUS);\r\nif (ret < 0) {\r\ndev_err(dev, "clear Alarm INT failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t tps80031_rtc_irq(int irq, void *data)\r\n{\r\nstruct device *dev = data;\r\nstruct tps80031_rtc *rtc = dev_get_drvdata(dev);\r\nint ret;\r\nret = clear_alarm_int_status(dev, rtc);\r\nif (ret < 0)\r\nreturn ret;\r\nrtc_update_irq(rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tps80031_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct tps80031_rtc *rtc;\r\nstruct rtc_time tm;\r\nint ret;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->irq = platform_get_irq(pdev, 0);\r\nplatform_set_drvdata(pdev, rtc);\r\nret = tps80031_set_bits(pdev->dev.parent, TPS80031_SLAVE_ID1,\r\nTPS80031_RTC_CTRL_REG, STOP_RTC);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to start RTC. err = %d\n", ret);\r\nreturn ret;\r\n}\r\ntps80031_rtc_read_time(&pdev->dev, &tm);\r\nif ((tm.tm_year == RTC_YEAR_OFFSET + TPS80031_RTC_POR_YEAR) &&\r\n(tm.tm_mon == (TPS80031_RTC_POR_MONTH - 1)) &&\r\n(tm.tm_mday == TPS80031_RTC_POR_DAY)) {\r\ntm.tm_year = 2000;\r\ntm.tm_mday = 1;\r\ntm.tm_mon = 1;\r\nret = tps80031_rtc_set_time(&pdev->dev, &tm);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"RTC set time failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = clear_alarm_int_status(&pdev->dev, rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Clear alarm int failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&tps80031_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc)) {\r\nret = PTR_ERR(rtc->rtc);\r\ndev_err(&pdev->dev, "RTC registration failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, rtc->irq, NULL,\r\ntps80031_rtc_irq,\r\nIRQF_ONESHOT,\r\ndev_name(&pdev->dev), rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "request IRQ:%d failed, err = %d\n",\r\nrtc->irq, ret);\r\nreturn ret;\r\n}\r\ndevice_set_wakeup_capable(&pdev->dev, 1);\r\nreturn 0;\r\n}\r\nstatic int tps80031_rtc_suspend(struct device *dev)\r\n{\r\nstruct tps80031_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int tps80031_rtc_resume(struct device *dev)\r\n{\r\nstruct tps80031_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}

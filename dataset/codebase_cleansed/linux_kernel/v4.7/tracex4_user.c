static __u64 time_get_ns(void)\r\n{\r\nstruct timespec ts;\r\nclock_gettime(CLOCK_MONOTONIC, &ts);\r\nreturn ts.tv_sec * 1000000000ull + ts.tv_nsec;\r\n}\r\nstatic void print_old_objects(int fd)\r\n{\r\nlong long val = time_get_ns();\r\n__u64 key, next_key;\r\nstruct pair v;\r\nkey = write(1, "\e[1;1H\e[2J", 12);\r\nkey = -1;\r\nwhile (bpf_get_next_key(map_fd[0], &key, &next_key) == 0) {\r\nbpf_lookup_elem(map_fd[0], &next_key, &v);\r\nkey = next_key;\r\nif (val - v.val < 1000000000ll)\r\ncontinue;\r\nprintf("obj 0x%llx is %2lldsec old was allocated at ip %llx\n",\r\nnext_key, (val - v.val) / 1000000000ll, v.ip);\r\n}\r\n}\r\nint main(int ac, char **argv)\r\n{\r\nchar filename[256];\r\nint i;\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nfor (i = 0; ; i++) {\r\nprint_old_objects(map_fd[1]);\r\nsleep(1);\r\n}\r\nreturn 0;\r\n}

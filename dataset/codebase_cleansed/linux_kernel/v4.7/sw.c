static void rtl8821ae_init_aspm_vars(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\r\nrtlpci->const_amdpci_aspm = 0;\r\nrtlpci->const_pci_aspm = 3;\r\nrtlpci->const_devicepci_aspm_setting = 0x03;\r\nrtlpci->const_hostpci_aspm_setting = 0x02;\r\nrtlpci->const_hwsw_rfoff_d3 = 0;\r\nrtlpci->const_support_pciaspm = 1;\r\n}\r\nint rtl8821ae_init_sw_vars(struct ieee80211_hw *hw)\r\n{\r\nint err = 0;\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nrtl8821ae_bt_reg_init(hw);\r\nrtlpriv->btcoexist.btc_ops = rtl_btc_get_ops_pointer();\r\nrtlpriv->dm.dm_initialgain_enable = 1;\r\nrtlpriv->dm.dm_flag = 0;\r\nrtlpriv->dm.disable_framebursting = 0;\r\nrtlpriv->dm.thermalvalue = 0;\r\nrtlpci->transmit_config = CFENDFORM | BIT(15) | BIT(24) | BIT(25);\r\nmac->ht_enable = true;\r\nmac->ht_cur_stbc = 0;\r\nmac->ht_stbc_cap = 0;\r\nmac->vht_cur_ldpc = 0;\r\nmac->vht_ldpc_cap = 0;\r\nmac->vht_cur_stbc = 0;\r\nmac->vht_stbc_cap = 0;\r\nrtlpriv->rtlhal.current_bandtype = BAND_ON_2_4G;\r\nrtlpriv->rtlhal.bandset = BAND_ON_BOTH;\r\nrtlpriv->rtlhal.macphymode = SINGLEMAC_SINGLEPHY;\r\nrtlpci->receive_config = (RCR_APPFCS |\r\nRCR_APP_MIC |\r\nRCR_APP_ICV |\r\nRCR_APP_PHYST_RXFF |\r\nRCR_NONQOS_VHT |\r\nRCR_HTC_LOC_CTRL |\r\nRCR_AMF |\r\nRCR_ACF |\r\nRCR_ADF |\r\nRCR_AICV |\r\nRCR_ACRC32 |\r\nRCR_AB |\r\nRCR_AM |\r\nRCR_APM |\r\n0);\r\nrtlpci->irq_mask[0] =\r\n(u32)(IMR_PSTIMEOUT |\r\nIMR_GTINT3 |\r\nIMR_HSISR_IND_ON_INT |\r\nIMR_C2HCMD |\r\nIMR_HIGHDOK |\r\nIMR_MGNTDOK |\r\nIMR_BKDOK |\r\nIMR_BEDOK |\r\nIMR_VIDOK |\r\nIMR_VODOK |\r\nIMR_RDU |\r\nIMR_ROK |\r\n0);\r\nrtlpci->irq_mask[1] =\r\n(u32)(IMR_RXFOVW |\r\nIMR_TXFOVW |\r\n0);\r\nrtlpci->sys_irq_mask = (u32)(HSIMR_PDN_INT_EN |\r\nHSIMR_RON_INT_EN |\r\n0);\r\nrtlpriv->psc.wo_wlan_mode = WAKE_ON_MAGIC_PACKET |\r\nWAKE_ON_PATTERN_MATCH;\r\nrtlpriv->dbg.global_debuglevel = rtlpriv->cfg->mod_params->debug;\r\nrtlpriv->psc.inactiveps = rtlpriv->cfg->mod_params->inactiveps;\r\nrtlpriv->psc.swctrl_lps = rtlpriv->cfg->mod_params->swctrl_lps;\r\nrtlpriv->psc.fwctrl_lps = rtlpriv->cfg->mod_params->fwctrl_lps;\r\nrtlpci->msi_support = rtlpriv->cfg->mod_params->msi_support;\r\nrtlpci->int_clear = rtlpriv->cfg->mod_params->int_clear;\r\nrtlpriv->cfg->mod_params->sw_crypto =\r\nrtlpriv->cfg->mod_params->sw_crypto;\r\nrtlpriv->cfg->mod_params->disable_watchdog =\r\nrtlpriv->cfg->mod_params->disable_watchdog;\r\nif (rtlpriv->cfg->mod_params->disable_watchdog)\r\npr_info("watchdog disabled\n");\r\nrtlpriv->psc.reg_fwctrl_lps = 3;\r\nrtlpriv->psc.reg_max_lps_awakeintvl = 5;\r\nrtl8821ae_init_aspm_vars(hw);\r\nif (rtlpriv->psc.reg_fwctrl_lps == 1)\r\nrtlpriv->psc.fwctrl_psmode = FW_PS_MIN_MODE;\r\nelse if (rtlpriv->psc.reg_fwctrl_lps == 2)\r\nrtlpriv->psc.fwctrl_psmode = FW_PS_MAX_MODE;\r\nelse if (rtlpriv->psc.reg_fwctrl_lps == 3)\r\nrtlpriv->psc.fwctrl_psmode = FW_PS_DTIM_MODE;\r\nrtlpriv->rtlhal.pfirmware = vzalloc(0x8000);\r\nif (!rtlpriv->rtlhal.pfirmware) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG,\r\n"Can't alloc buffer for fw.\n");\r\nreturn 1;\r\n}\r\nrtlpriv->rtlhal.wowlan_firmware = vzalloc(0x8000);\r\nif (!rtlpriv->rtlhal.wowlan_firmware) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG,\r\n"Can't alloc buffer for wowlan fw.\n");\r\nreturn 1;\r\n}\r\nif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\r\nrtlpriv->cfg->fw_name = "rtlwifi/rtl8812aefw.bin";\r\nrtlpriv->cfg->wowlan_fw_name = "rtlwifi/rtl8812aefw_wowlan.bin";\r\n} else {\r\nrtlpriv->cfg->fw_name = "rtlwifi/rtl8821aefw.bin";\r\nrtlpriv->cfg->wowlan_fw_name = "rtlwifi/rtl8821aefw_wowlan.bin";\r\n}\r\nrtlpriv->max_fw_size = 0x8000;\r\npr_info("Using firmware %s\n", rtlpriv->cfg->fw_name);\r\nerr = request_firmware_nowait(THIS_MODULE, 1, rtlpriv->cfg->fw_name,\r\nrtlpriv->io.dev, GFP_KERNEL, hw,\r\nrtl_fw_cb);\r\nif (err) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG,\r\n"Failed to request normal firmware!\n");\r\nreturn 1;\r\n}\r\npr_info("Using firmware %s\n", rtlpriv->cfg->wowlan_fw_name);\r\nerr = request_firmware_nowait(THIS_MODULE, 1,\r\nrtlpriv->cfg->wowlan_fw_name,\r\nrtlpriv->io.dev, GFP_KERNEL, hw,\r\nrtl_wowlan_fw_cb);\r\nif (err) {\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG,\r\n"Failed to request wowlan firmware!\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid rtl8821ae_deinit_sw_vars(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (rtlpriv->rtlhal.pfirmware) {\r\nvfree(rtlpriv->rtlhal.pfirmware);\r\nrtlpriv->rtlhal.pfirmware = NULL;\r\n}\r\n#if (USE_SPECIFIC_FW_TO_SUPPORT_WOWLAN == 1)\r\nif (rtlpriv->rtlhal.wowlan_firmware) {\r\nvfree(rtlpriv->rtlhal.wowlan_firmware);\r\nrtlpriv->rtlhal.wowlan_firmware = NULL;\r\n}\r\n#endif\r\n}\r\nbool rtl8821ae_get_btc_status(void)\r\n{\r\nreturn true;\r\n}

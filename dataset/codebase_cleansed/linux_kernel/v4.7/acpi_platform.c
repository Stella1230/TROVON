struct platform_device *acpi_create_platform_device(struct acpi_device *adev)\r\n{\r\nstruct platform_device *pdev = NULL;\r\nstruct platform_device_info pdevinfo;\r\nstruct resource_entry *rentry;\r\nstruct list_head resource_list;\r\nstruct resource *resources = NULL;\r\nint count;\r\nif (adev->physical_node_count)\r\nreturn NULL;\r\nif (!acpi_match_device_ids(adev, forbidden_id_list))\r\nreturn ERR_PTR(-EINVAL);\r\nINIT_LIST_HEAD(&resource_list);\r\ncount = acpi_dev_get_resources(adev, &resource_list, NULL, NULL);\r\nif (count < 0) {\r\nreturn NULL;\r\n} else if (count > 0) {\r\nresources = kzalloc(count * sizeof(struct resource),\r\nGFP_KERNEL);\r\nif (!resources) {\r\ndev_err(&adev->dev, "No memory for resources\n");\r\nacpi_dev_free_resource_list(&resource_list);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ncount = 0;\r\nlist_for_each_entry(rentry, &resource_list, node)\r\nresources[count++] = *rentry->res;\r\nacpi_dev_free_resource_list(&resource_list);\r\n}\r\nmemset(&pdevinfo, 0, sizeof(pdevinfo));\r\npdevinfo.parent = adev->parent ?\r\nacpi_get_first_physical_node(adev->parent) : NULL;\r\npdevinfo.name = dev_name(&adev->dev);\r\npdevinfo.id = -1;\r\npdevinfo.res = resources;\r\npdevinfo.num_res = count;\r\npdevinfo.fwnode = acpi_fwnode_handle(adev);\r\nif (acpi_dma_supported(adev))\r\npdevinfo.dma_mask = DMA_BIT_MASK(32);\r\nelse\r\npdevinfo.dma_mask = 0;\r\npdev = platform_device_register_full(&pdevinfo);\r\nif (IS_ERR(pdev))\r\ndev_err(&adev->dev, "platform device creation failed: %ld\n",\r\nPTR_ERR(pdev));\r\nelse\r\ndev_dbg(&adev->dev, "created platform device %s\n",\r\ndev_name(&pdev->dev));\r\nkfree(resources);\r\nreturn pdev;\r\n}

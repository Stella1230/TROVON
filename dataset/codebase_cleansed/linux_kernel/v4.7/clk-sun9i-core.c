static void sun9i_a80_get_pll4_factors(struct factors_request *req)\r\n{\r\nint n;\r\nint m = 1;\r\nint p = 1;\r\nn = DIV_ROUND_UP(req->rate, 6000000);\r\nif (n > 255) {\r\nm = 0;\r\nn = (n + 1) / 2;\r\n}\r\nif (n > 255) {\r\np = 0;\r\nn = (n + 1) / 2;\r\n}\r\nif (n > 255)\r\nn = 255;\r\nelse if (n < 12)\r\nn = 12;\r\nreq->rate = ((24000000 * n) >> p) / (m + 1);\r\nreq->n = n;\r\nreq->m = m;\r\nreq->p = p;\r\n}\r\nstatic void __init sun9i_a80_pll4_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("Could not get registers for a80-pll4-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_pll4_data,\r\n&sun9i_a80_pll4_lock, reg);\r\n}\r\nstatic void sun9i_a80_get_gt_factors(struct factors_request *req)\r\n{\r\nu32 div;\r\nif (req->parent_rate < req->rate)\r\nreq->rate = req->parent_rate;\r\ndiv = DIV_ROUND_UP(req->parent_rate, req->rate);\r\nif (div > 4)\r\ndiv = 4;\r\nreq->rate = req->parent_rate / div;\r\nreq->m = div;\r\n}\r\nstatic void __init sun9i_a80_gt_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nstruct clk *gt;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("Could not get registers for a80-gt-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\ngt = sunxi_factors_register(node, &sun9i_a80_gt_data,\r\n&sun9i_a80_gt_lock, reg);\r\n__clk_get(gt);\r\nclk_prepare_enable(gt);\r\n}\r\nstatic void sun9i_a80_get_ahb_factors(struct factors_request *req)\r\n{\r\nu32 _p;\r\nif (req->parent_rate < req->rate)\r\nreq->rate = req->parent_rate;\r\n_p = order_base_2(DIV_ROUND_UP(req->parent_rate, req->rate));\r\nif (_p > 3)\r\n_p = 3;\r\nreq->rate = req->parent_rate >> _p;\r\nreq->p = _p;\r\n}\r\nstatic void __init sun9i_a80_ahb_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("Could not get registers for a80-ahb-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_ahb_data,\r\n&sun9i_a80_ahb_lock, reg);\r\n}\r\nstatic void __init sun9i_a80_apb0_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("Could not get registers for a80-apb0-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_apb0_data,\r\n&sun9i_a80_apb0_lock, reg);\r\n}\r\nstatic void sun9i_a80_get_apb1_factors(struct factors_request *req)\r\n{\r\nu32 div;\r\nif (req->parent_rate < req->rate)\r\nreq->rate = req->parent_rate;\r\ndiv = DIV_ROUND_UP(req->parent_rate, req->rate);\r\nif (div > 256)\r\ndiv = 256;\r\nreq->p = order_base_2(div);\r\nreq->m = (req->parent_rate >> req->p) - 1;\r\nreq->rate = (req->parent_rate >> req->p) / (req->m + 1);\r\n}\r\nstatic void __init sun9i_a80_apb1_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg)) {\r\npr_err("Could not get registers for a80-apb1-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_apb1_data,\r\n&sun9i_a80_apb1_lock, reg);\r\n}

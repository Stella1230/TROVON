static void gpio_line_config(int line, int direction)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nlocal_irq_save(flags);\r\nval = readl(IOP3XX_GPOE);\r\nif (direction == GPIO_IN) {\r\nval |= BIT(line);\r\n} else if (direction == GPIO_OUT) {\r\nval &= ~BIT(line);\r\n}\r\nwritel(val, IOP3XX_GPOE);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int gpio_line_get(int line)\r\n{\r\nreturn !!(readl(IOP3XX_GPID) & BIT(line));\r\n}\r\nstatic void gpio_line_set(int line, int value)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nlocal_irq_save(flags);\r\nval = readl(IOP3XX_GPOD);\r\nif (value == GPIO_LOW) {\r\nval &= ~BIT(line);\r\n} else if (value == GPIO_HIGH) {\r\nval |= BIT(line);\r\n}\r\nwritel(val, IOP3XX_GPOD);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int iop3xx_gpio_direction_input(struct gpio_chip *chip, unsigned gpio)\r\n{\r\ngpio_line_config(gpio, GPIO_IN);\r\nreturn 0;\r\n}\r\nstatic int iop3xx_gpio_direction_output(struct gpio_chip *chip, unsigned gpio, int level)\r\n{\r\ngpio_line_set(gpio, level);\r\ngpio_line_config(gpio, GPIO_OUT);\r\nreturn 0;\r\n}\r\nstatic int iop3xx_gpio_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nreturn gpio_line_get(gpio);\r\n}\r\nstatic void iop3xx_gpio_set_value(struct gpio_chip *chip, unsigned gpio, int value)\r\n{\r\ngpio_line_set(gpio, value);\r\n}\r\nstatic int iop3xx_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nreturn devm_gpiochip_add_data(&pdev->dev, &iop3xx_chip, NULL);\r\n}\r\nstatic int __init iop3xx_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&iop3xx_gpio_driver);\r\n}

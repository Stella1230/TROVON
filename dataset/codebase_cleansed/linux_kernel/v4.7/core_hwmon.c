static ssize_t mlxsw_hwmon_temp_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mtmp_pl[MLXSW_REG_MTMP_LEN];\r\nunsigned int temp;\r\nint err;\r\nmlxsw_reg_mtmp_pack(mtmp_pl, mlwsw_hwmon_attr->type_index,\r\nfalse, false);\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to query temp sensor\n");\r\nreturn err;\r\n}\r\nmlxsw_reg_mtmp_unpack(mtmp_pl, &temp, NULL, NULL);\r\nreturn sprintf(buf, "%u\n", temp);\r\n}\r\nstatic ssize_t mlxsw_hwmon_temp_max_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mtmp_pl[MLXSW_REG_MTMP_LEN];\r\nunsigned int temp_max;\r\nint err;\r\nmlxsw_reg_mtmp_pack(mtmp_pl, mlwsw_hwmon_attr->type_index,\r\nfalse, false);\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to query temp sensor\n");\r\nreturn err;\r\n}\r\nmlxsw_reg_mtmp_unpack(mtmp_pl, NULL, &temp_max, NULL);\r\nreturn sprintf(buf, "%u\n", temp_max);\r\n}\r\nstatic ssize_t mlxsw_hwmon_temp_rst_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mtmp_pl[MLXSW_REG_MTMP_LEN];\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nif (val != 1)\r\nreturn -EINVAL;\r\nmlxsw_reg_mtmp_pack(mtmp_pl, mlwsw_hwmon_attr->type_index, true, true);\r\nerr = mlxsw_reg_write(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to reset temp sensor history\n");\r\nreturn err;\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t mlxsw_hwmon_fan_rpm_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mfsm_pl[MLXSW_REG_MFSM_LEN];\r\nint err;\r\nmlxsw_reg_mfsm_pack(mfsm_pl, mlwsw_hwmon_attr->type_index);\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfsm), mfsm_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to query fan\n");\r\nreturn err;\r\n}\r\nreturn sprintf(buf, "%u\n", mlxsw_reg_mfsm_rpm_get(mfsm_pl));\r\n}\r\nstatic ssize_t mlxsw_hwmon_pwm_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mfsc_pl[MLXSW_REG_MFSC_LEN];\r\nint err;\r\nmlxsw_reg_mfsc_pack(mfsc_pl, mlwsw_hwmon_attr->type_index, 0);\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfsc), mfsc_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to query PWM\n");\r\nreturn err;\r\n}\r\nreturn sprintf(buf, "%u\n",\r\nmlxsw_reg_mfsc_pwm_duty_cycle_get(mfsc_pl));\r\n}\r\nstatic ssize_t mlxsw_hwmon_pwm_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct mlxsw_hwmon_attr *mlwsw_hwmon_attr =\r\ncontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\r\nstruct mlxsw_hwmon *mlxsw_hwmon = mlwsw_hwmon_attr->hwmon;\r\nchar mfsc_pl[MLXSW_REG_MFSC_LEN];\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nif (val > 255)\r\nreturn -EINVAL;\r\nmlxsw_reg_mfsc_pack(mfsc_pl, mlwsw_hwmon_attr->type_index, val);\r\nerr = mlxsw_reg_write(mlxsw_hwmon->core, MLXSW_REG(mfsc), mfsc_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to write PWM\n");\r\nreturn err;\r\n}\r\nreturn len;\r\n}\r\nstatic void mlxsw_hwmon_attr_add(struct mlxsw_hwmon *mlxsw_hwmon,\r\nenum mlxsw_hwmon_attr_type attr_type,\r\nunsigned int type_index, unsigned int num) {\r\nstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr;\r\nunsigned int attr_index;\r\nattr_index = mlxsw_hwmon->attrs_count;\r\nmlxsw_hwmon_attr = &mlxsw_hwmon->hwmon_attrs[attr_index];\r\nswitch (attr_type) {\r\ncase MLXSW_HWMON_ATTR_TYPE_TEMP:\r\nmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_temp_show;\r\nmlxsw_hwmon_attr->dev_attr.attr.mode = S_IRUGO;\r\nsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\r\n"temp%u_input", num + 1);\r\nbreak;\r\ncase MLXSW_HWMON_ATTR_TYPE_TEMP_MAX:\r\nmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_temp_max_show;\r\nmlxsw_hwmon_attr->dev_attr.attr.mode = S_IRUGO;\r\nsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\r\n"temp%u_highest", num + 1);\r\nbreak;\r\ncase MLXSW_HWMON_ATTR_TYPE_TEMP_RST:\r\nmlxsw_hwmon_attr->dev_attr.store = mlxsw_hwmon_temp_rst_store;\r\nmlxsw_hwmon_attr->dev_attr.attr.mode = S_IWUSR;\r\nsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\r\n"temp%u_reset_history", num + 1);\r\nbreak;\r\ncase MLXSW_HWMON_ATTR_TYPE_FAN_RPM:\r\nmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_fan_rpm_show;\r\nmlxsw_hwmon_attr->dev_attr.attr.mode = S_IRUGO;\r\nsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\r\n"fan%u_input", num + 1);\r\nbreak;\r\ncase MLXSW_HWMON_ATTR_TYPE_PWM:\r\nmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_pwm_show;\r\nmlxsw_hwmon_attr->dev_attr.store = mlxsw_hwmon_pwm_store;\r\nmlxsw_hwmon_attr->dev_attr.attr.mode = S_IWUSR | S_IRUGO;\r\nsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\r\n"pwm%u", num + 1);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nmlxsw_hwmon_attr->type_index = type_index;\r\nmlxsw_hwmon_attr->hwmon = mlxsw_hwmon;\r\nmlxsw_hwmon_attr->dev_attr.attr.name = mlxsw_hwmon_attr->name;\r\nsysfs_attr_init(&mlxsw_hwmon_attr->dev_attr.attr);\r\nmlxsw_hwmon->attrs[attr_index] = &mlxsw_hwmon_attr->dev_attr.attr;\r\nmlxsw_hwmon->attrs_count++;\r\n}\r\nstatic int mlxsw_hwmon_temp_init(struct mlxsw_hwmon *mlxsw_hwmon)\r\n{\r\nchar mtcap_pl[MLXSW_REG_MTCAP_LEN];\r\nchar mtmp_pl[MLXSW_REG_MTMP_LEN];\r\nu8 sensor_count;\r\nint i;\r\nint err;\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtcap), mtcap_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to get number of temp sensors\n");\r\nreturn err;\r\n}\r\nsensor_count = mlxsw_reg_mtcap_sensor_count_get(mtcap_pl);\r\nfor (i = 0; i < sensor_count; i++) {\r\nmlxsw_reg_mtmp_pack(mtmp_pl, i, true, true);\r\nerr = mlxsw_reg_write(mlxsw_hwmon->core,\r\nMLXSW_REG(mtmp), mtmp_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to setup temp sensor number %d\n",\r\ni);\r\nreturn err;\r\n}\r\nmlxsw_hwmon_attr_add(mlxsw_hwmon,\r\nMLXSW_HWMON_ATTR_TYPE_TEMP, i, i);\r\nmlxsw_hwmon_attr_add(mlxsw_hwmon,\r\nMLXSW_HWMON_ATTR_TYPE_TEMP_MAX, i, i);\r\nmlxsw_hwmon_attr_add(mlxsw_hwmon,\r\nMLXSW_HWMON_ATTR_TYPE_TEMP_RST, i, i);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_hwmon_fans_init(struct mlxsw_hwmon *mlxsw_hwmon)\r\n{\r\nchar mfcr_pl[MLXSW_REG_MFCR_LEN];\r\nenum mlxsw_reg_mfcr_pwm_frequency freq;\r\nunsigned int type_index;\r\nunsigned int num;\r\nu16 tacho_active;\r\nu8 pwm_active;\r\nint err;\r\nerr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfcr), mfcr_pl);\r\nif (err) {\r\ndev_err(mlxsw_hwmon->bus_info->dev, "Failed to get to probe PWMs and Tachometers\n");\r\nreturn err;\r\n}\r\nmlxsw_reg_mfcr_unpack(mfcr_pl, &freq, &tacho_active, &pwm_active);\r\nnum = 0;\r\nfor (type_index = 0; type_index < MLXSW_MFCR_TACHOS_MAX; type_index++) {\r\nif (tacho_active & BIT(type_index))\r\nmlxsw_hwmon_attr_add(mlxsw_hwmon,\r\nMLXSW_HWMON_ATTR_TYPE_FAN_RPM,\r\ntype_index, num++);\r\n}\r\nnum = 0;\r\nfor (type_index = 0; type_index < MLXSW_MFCR_PWMS_MAX; type_index++) {\r\nif (pwm_active & BIT(type_index))\r\nmlxsw_hwmon_attr_add(mlxsw_hwmon,\r\nMLXSW_HWMON_ATTR_TYPE_PWM,\r\ntype_index, num++);\r\n}\r\nreturn 0;\r\n}\r\nint mlxsw_hwmon_init(struct mlxsw_core *mlxsw_core,\r\nconst struct mlxsw_bus_info *mlxsw_bus_info,\r\nstruct mlxsw_hwmon **p_hwmon)\r\n{\r\nstruct mlxsw_hwmon *mlxsw_hwmon;\r\nstruct device *hwmon_dev;\r\nint err;\r\nmlxsw_hwmon = devm_kzalloc(mlxsw_bus_info->dev, sizeof(*mlxsw_hwmon),\r\nGFP_KERNEL);\r\nif (!mlxsw_hwmon)\r\nreturn -ENOMEM;\r\nmlxsw_hwmon->core = mlxsw_core;\r\nmlxsw_hwmon->bus_info = mlxsw_bus_info;\r\nerr = mlxsw_hwmon_temp_init(mlxsw_hwmon);\r\nif (err)\r\ngoto err_temp_init;\r\nerr = mlxsw_hwmon_fans_init(mlxsw_hwmon);\r\nif (err)\r\ngoto err_fans_init;\r\nmlxsw_hwmon->groups[0] = &mlxsw_hwmon->group;\r\nmlxsw_hwmon->group.attrs = mlxsw_hwmon->attrs;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(mlxsw_bus_info->dev,\r\n"mlxsw",\r\nmlxsw_hwmon,\r\nmlxsw_hwmon->groups);\r\nif (IS_ERR(hwmon_dev)) {\r\nerr = PTR_ERR(hwmon_dev);\r\ngoto err_hwmon_register;\r\n}\r\nmlxsw_hwmon->hwmon_dev = hwmon_dev;\r\n*p_hwmon = mlxsw_hwmon;\r\nreturn 0;\r\nerr_hwmon_register:\r\nerr_fans_init:\r\nerr_temp_init:\r\nreturn err;\r\n}

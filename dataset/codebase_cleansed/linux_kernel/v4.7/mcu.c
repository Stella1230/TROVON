static inline int firmware_running(struct mt7601u_dev *dev)\r\n{\r\nreturn mt7601u_rr(dev, MT_MCU_COM_REG0) == 1;\r\n}\r\nstatic inline void skb_put_le32(struct sk_buff *skb, u32 val)\r\n{\r\nput_unaligned_le32(val, skb_put(skb, 4));\r\n}\r\nstatic inline void mt7601u_dma_skb_wrap_cmd(struct sk_buff *skb,\r\nu8 seq, enum mcu_cmd cmd)\r\n{\r\nWARN_ON(mt7601u_dma_skb_wrap(skb, CPU_TX_PORT, DMA_COMMAND,\r\nMT76_SET(MT_TXD_CMD_INFO_SEQ, seq) |\r\nMT76_SET(MT_TXD_CMD_INFO_TYPE, cmd)));\r\n}\r\nstatic inline void trace_mt_mcu_msg_send_cs(struct mt7601u_dev *dev,\r\nstruct sk_buff *skb, bool need_resp)\r\n{\r\nu32 i, csum = 0;\r\nfor (i = 0; i < skb->len / 4; i++)\r\ncsum ^= get_unaligned_le32(skb->data + i * 4);\r\ntrace_mt_mcu_msg_send(dev, skb, csum, need_resp);\r\n}\r\nstatic struct sk_buff *\r\nmt7601u_mcu_msg_alloc(struct mt7601u_dev *dev, const void *data, int len)\r\n{\r\nstruct sk_buff *skb;\r\nWARN_ON(len % 4);\r\nskb = alloc_skb(len + MT_DMA_HDR_LEN + 4, GFP_KERNEL);\r\nskb_reserve(skb, MT_DMA_HDR_LEN);\r\nmemcpy(skb_put(skb, len), data, len);\r\nreturn skb;\r\n}\r\nstatic int mt7601u_mcu_wait_resp(struct mt7601u_dev *dev, u8 seq)\r\n{\r\nstruct urb *urb = dev->mcu.resp.urb;\r\nu32 rxfce;\r\nint urb_status, ret, i = 5;\r\nwhile (i--) {\r\nif (!wait_for_completion_timeout(&dev->mcu.resp_cmpl,\r\nmsecs_to_jiffies(300))) {\r\ndev_warn(dev->dev, "Warning: %s retrying\n", __func__);\r\ncontinue;\r\n}\r\nrxfce = get_unaligned_le32(dev->mcu.resp.buf);\r\nurb_status = urb->status * mt7601u_urb_has_error(urb);\r\nret = mt7601u_usb_submit_buf(dev, USB_DIR_IN, MT_EP_IN_CMD_RESP,\r\n&dev->mcu.resp, GFP_KERNEL,\r\nmt7601u_complete_urb,\r\n&dev->mcu.resp_cmpl);\r\nif (ret)\r\nreturn ret;\r\nif (urb_status)\r\ndev_err(dev->dev, "Error: MCU resp urb failed:%d\n",\r\nurb_status);\r\nif (MT76_GET(MT_RXD_CMD_INFO_CMD_SEQ, rxfce) == seq &&\r\nMT76_GET(MT_RXD_CMD_INFO_EVT_TYPE, rxfce) == CMD_DONE)\r\nreturn 0;\r\ndev_err(dev->dev, "Error: MCU resp evt:%hhx seq:%hhx-%hhx!\n",\r\nMT76_GET(MT_RXD_CMD_INFO_EVT_TYPE, rxfce),\r\nseq, MT76_GET(MT_RXD_CMD_INFO_CMD_SEQ, rxfce));\r\n}\r\ndev_err(dev->dev, "Error: %s timed out\n", __func__);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int\r\nmt7601u_mcu_msg_send(struct mt7601u_dev *dev, struct sk_buff *skb,\r\nenum mcu_cmd cmd, bool wait_resp)\r\n{\r\nstruct usb_device *usb_dev = mt7601u_to_usb_dev(dev);\r\nunsigned cmd_pipe = usb_sndbulkpipe(usb_dev,\r\ndev->out_eps[MT_EP_OUT_INBAND_CMD]);\r\nint sent, ret;\r\nu8 seq = 0;\r\nif (test_bit(MT7601U_STATE_REMOVED, &dev->state))\r\nreturn 0;\r\nmutex_lock(&dev->mcu.mutex);\r\nif (wait_resp)\r\nwhile (!seq)\r\nseq = ++dev->mcu.msg_seq & 0xf;\r\nmt7601u_dma_skb_wrap_cmd(skb, seq, cmd);\r\nif (dev->mcu.resp_cmpl.done)\r\ndev_err(dev->dev, "Error: MCU response pre-completed!\n");\r\ntrace_mt_mcu_msg_send_cs(dev, skb, wait_resp);\r\ntrace_mt_submit_urb_sync(dev, cmd_pipe, skb->len);\r\nret = usb_bulk_msg(usb_dev, cmd_pipe, skb->data, skb->len, &sent, 500);\r\nif (ret) {\r\ndev_err(dev->dev, "Error: send MCU cmd failed:%d\n", ret);\r\ngoto out;\r\n}\r\nif (sent != skb->len)\r\ndev_err(dev->dev, "Error: %s sent != skb->len\n", __func__);\r\nif (wait_resp)\r\nret = mt7601u_mcu_wait_resp(dev, seq);\r\nout:\r\nmutex_unlock(&dev->mcu.mutex);\r\nconsume_skb(skb);\r\nreturn ret;\r\n}\r\nstatic int mt7601u_mcu_function_select(struct mt7601u_dev *dev,\r\nenum mcu_function func, u32 val)\r\n{\r\nstruct sk_buff *skb;\r\nstruct {\r\n__le32 id;\r\n__le32 value;\r\n} __packed __aligned(4) msg = {\r\n.id = cpu_to_le32(func),\r\n.value = cpu_to_le32(val),\r\n};\r\nskb = mt7601u_mcu_msg_alloc(dev, &msg, sizeof(msg));\r\nreturn mt7601u_mcu_msg_send(dev, skb, CMD_FUN_SET_OP, func == 5);\r\n}\r\nint mt7601u_mcu_tssi_read_kick(struct mt7601u_dev *dev, int use_hvga)\r\n{\r\nint ret;\r\nif (!test_bit(MT7601U_STATE_MCU_RUNNING, &dev->state))\r\nreturn 0;\r\nret = mt7601u_mcu_function_select(dev, ATOMIC_TSSI_SETTING,\r\nuse_hvga);\r\nif (ret) {\r\ndev_warn(dev->dev, "Warning: MCU TSSI read kick failed\n");\r\nreturn ret;\r\n}\r\ndev->tssi_read_trig = true;\r\nreturn 0;\r\n}\r\nint\r\nmt7601u_mcu_calibrate(struct mt7601u_dev *dev, enum mcu_calibrate cal, u32 val)\r\n{\r\nstruct sk_buff *skb;\r\nstruct {\r\n__le32 id;\r\n__le32 value;\r\n} __packed __aligned(4) msg = {\r\n.id = cpu_to_le32(cal),\r\n.value = cpu_to_le32(val),\r\n};\r\nskb = mt7601u_mcu_msg_alloc(dev, &msg, sizeof(msg));\r\nreturn mt7601u_mcu_msg_send(dev, skb, CMD_CALIBRATION_OP, true);\r\n}\r\nint mt7601u_write_reg_pairs(struct mt7601u_dev *dev, u32 base,\r\nconst struct mt76_reg_pair *data, int n)\r\n{\r\nconst int max_vals_per_cmd = INBAND_PACKET_MAX_LEN / 8;\r\nstruct sk_buff *skb;\r\nint cnt, i, ret;\r\nif (!n)\r\nreturn 0;\r\ncnt = min(max_vals_per_cmd, n);\r\nskb = alloc_skb(cnt * 8 + MT_DMA_HDR_LEN + 4, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_reserve(skb, MT_DMA_HDR_LEN);\r\nfor (i = 0; i < cnt; i++) {\r\nskb_put_le32(skb, base + data[i].reg);\r\nskb_put_le32(skb, data[i].value);\r\n}\r\nret = mt7601u_mcu_msg_send(dev, skb, CMD_RANDOM_WRITE, cnt == n);\r\nif (ret)\r\nreturn ret;\r\nreturn mt7601u_write_reg_pairs(dev, base, data + cnt, n - cnt);\r\n}\r\nint mt7601u_burst_write_regs(struct mt7601u_dev *dev, u32 offset,\r\nconst u32 *data, int n)\r\n{\r\nconst int max_regs_per_cmd = INBAND_PACKET_MAX_LEN / 4 - 1;\r\nstruct sk_buff *skb;\r\nint cnt, i, ret;\r\nif (!n)\r\nreturn 0;\r\ncnt = min(max_regs_per_cmd, n);\r\nskb = alloc_skb(cnt * 4 + MT_DMA_HDR_LEN + 4, GFP_KERNEL);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_reserve(skb, MT_DMA_HDR_LEN);\r\nskb_put_le32(skb, MT_MCU_MEMMAP_WLAN + offset);\r\nfor (i = 0; i < cnt; i++)\r\nskb_put_le32(skb, data[i]);\r\nret = mt7601u_mcu_msg_send(dev, skb, CMD_BURST_WRITE, cnt == n);\r\nif (ret)\r\nreturn ret;\r\nreturn mt7601u_burst_write_regs(dev, offset + cnt * 4,\r\ndata + cnt, n - cnt);\r\n}\r\nstatic int __mt7601u_dma_fw(struct mt7601u_dev *dev,\r\nconst struct mt7601u_dma_buf *dma_buf,\r\nconst void *data, u32 len, u32 dst_addr)\r\n{\r\nDECLARE_COMPLETION_ONSTACK(cmpl);\r\nstruct mt7601u_dma_buf buf = *dma_buf;\r\n__le32 reg;\r\nu32 val;\r\nint ret;\r\nreg = cpu_to_le32(MT76_SET(MT_TXD_INFO_TYPE, DMA_PACKET) |\r\nMT76_SET(MT_TXD_INFO_D_PORT, CPU_TX_PORT) |\r\nMT76_SET(MT_TXD_INFO_LEN, len));\r\nmemcpy(buf.buf, &reg, sizeof(reg));\r\nmemcpy(buf.buf + sizeof(reg), data, len);\r\nmemset(buf.buf + sizeof(reg) + len, 0, 8);\r\nret = mt7601u_vendor_single_wr(dev, MT_VEND_WRITE_FCE,\r\nMT_FCE_DMA_ADDR, dst_addr);\r\nif (ret)\r\nreturn ret;\r\nlen = roundup(len, 4);\r\nret = mt7601u_vendor_single_wr(dev, MT_VEND_WRITE_FCE,\r\nMT_FCE_DMA_LEN, len << 16);\r\nif (ret)\r\nreturn ret;\r\nbuf.len = MT_DMA_HDR_LEN + len + 4;\r\nret = mt7601u_usb_submit_buf(dev, USB_DIR_OUT, MT_EP_OUT_INBAND_CMD,\r\n&buf, GFP_KERNEL,\r\nmt7601u_complete_urb, &cmpl);\r\nif (ret)\r\nreturn ret;\r\nif (!wait_for_completion_timeout(&cmpl, msecs_to_jiffies(1000))) {\r\ndev_err(dev->dev, "Error: firmware upload timed out\n");\r\nusb_kill_urb(buf.urb);\r\nreturn -ETIMEDOUT;\r\n}\r\nif (mt7601u_urb_has_error(buf.urb)) {\r\ndev_err(dev->dev, "Error: firmware upload urb failed:%d\n",\r\nbuf.urb->status);\r\nreturn buf.urb->status;\r\n}\r\nval = mt7601u_rr(dev, MT_TX_CPU_FROM_FCE_CPU_DESC_IDX);\r\nval++;\r\nmt7601u_wr(dev, MT_TX_CPU_FROM_FCE_CPU_DESC_IDX, val);\r\nreturn 0;\r\n}\r\nstatic int\r\nmt7601u_dma_fw(struct mt7601u_dev *dev, struct mt7601u_dma_buf *dma_buf,\r\nconst void *data, int len, u32 dst_addr)\r\n{\r\nint n, ret;\r\nif (len == 0)\r\nreturn 0;\r\nn = min(MCU_FW_URB_MAX_PAYLOAD, len);\r\nret = __mt7601u_dma_fw(dev, dma_buf, data, n, dst_addr);\r\nif (ret)\r\nreturn ret;\r\nif (!mt76_poll_msec(dev, MT_MCU_COM_REG1, BIT(31), BIT(31), 500))\r\nreturn -ETIMEDOUT;\r\nreturn mt7601u_dma_fw(dev, dma_buf, data + n, len - n, dst_addr + n);\r\n}\r\nstatic int\r\nmt7601u_upload_firmware(struct mt7601u_dev *dev, const struct mt76_fw *fw)\r\n{\r\nstruct mt7601u_dma_buf dma_buf;\r\nvoid *ivb;\r\nu32 ilm_len, dlm_len;\r\nint i, ret;\r\nivb = kmemdup(fw->ivb, sizeof(fw->ivb), GFP_KERNEL);\r\nif (!ivb)\r\nreturn -ENOMEM;\r\nif (mt7601u_usb_alloc_buf(dev, MCU_FW_URB_SIZE, &dma_buf)) {\r\nret = -ENOMEM;\r\ngoto error;\r\n}\r\nilm_len = le32_to_cpu(fw->hdr.ilm_len) - sizeof(fw->ivb);\r\ndev_dbg(dev->dev, "loading FW - ILM %u + IVB %zu\n",\r\nilm_len, sizeof(fw->ivb));\r\nret = mt7601u_dma_fw(dev, &dma_buf, fw->ilm, ilm_len, sizeof(fw->ivb));\r\nif (ret)\r\ngoto error;\r\ndlm_len = le32_to_cpu(fw->hdr.dlm_len);\r\ndev_dbg(dev->dev, "loading FW - DLM %u\n", dlm_len);\r\nret = mt7601u_dma_fw(dev, &dma_buf, fw->ilm + ilm_len,\r\ndlm_len, MT_MCU_DLM_OFFSET);\r\nif (ret)\r\ngoto error;\r\nret = mt7601u_vendor_request(dev, MT_VEND_DEV_MODE, USB_DIR_OUT,\r\n0x12, 0, ivb, sizeof(fw->ivb));\r\nif (ret < 0)\r\ngoto error;\r\nret = 0;\r\nfor (i = 100; i && !firmware_running(dev); i--)\r\nmsleep(10);\r\nif (!i) {\r\nret = -ETIMEDOUT;\r\ngoto error;\r\n}\r\ndev_dbg(dev->dev, "Firmware running!\n");\r\nerror:\r\nkfree(ivb);\r\nmt7601u_usb_free_buf(dev, &dma_buf);\r\nreturn ret;\r\n}\r\nstatic int mt7601u_load_firmware(struct mt7601u_dev *dev)\r\n{\r\nconst struct firmware *fw;\r\nconst struct mt76_fw_header *hdr;\r\nint len, ret;\r\nu32 val;\r\nmt7601u_wr(dev, MT_USB_DMA_CFG, (MT_USB_DMA_CFG_RX_BULK_EN |\r\nMT_USB_DMA_CFG_TX_BULK_EN));\r\nif (firmware_running(dev))\r\nreturn 0;\r\nret = request_firmware(&fw, MT7601U_FIRMWARE, dev->dev);\r\nif (ret)\r\nreturn ret;\r\nif (!fw || !fw->data || fw->size < sizeof(*hdr))\r\ngoto err_inv_fw;\r\nhdr = (const struct mt76_fw_header *) fw->data;\r\nif (le32_to_cpu(hdr->ilm_len) <= MT_MCU_IVB_SIZE)\r\ngoto err_inv_fw;\r\nlen = sizeof(*hdr);\r\nlen += le32_to_cpu(hdr->ilm_len);\r\nlen += le32_to_cpu(hdr->dlm_len);\r\nif (fw->size != len)\r\ngoto err_inv_fw;\r\nval = le16_to_cpu(hdr->fw_ver);\r\ndev_info(dev->dev,\r\n"Firmware Version: %d.%d.%02d Build: %x Build time: %.16s\n",\r\n(val >> 12) & 0xf, (val >> 8) & 0xf, val & 0xf,\r\nle16_to_cpu(hdr->build_ver), hdr->build_time);\r\nlen = le32_to_cpu(hdr->ilm_len);\r\nmt7601u_wr(dev, 0x94c, 0);\r\nmt7601u_wr(dev, MT_FCE_PSE_CTRL, 0);\r\nmt7601u_vendor_reset(dev);\r\nmsleep(5);\r\nmt7601u_wr(dev, 0xa44, 0);\r\nmt7601u_wr(dev, 0x230, 0x84210);\r\nmt7601u_wr(dev, 0x400, 0x80c00);\r\nmt7601u_wr(dev, 0x800, 1);\r\nmt7601u_rmw(dev, MT_PBF_CFG, 0, (MT_PBF_CFG_TX0Q_EN |\r\nMT_PBF_CFG_TX1Q_EN |\r\nMT_PBF_CFG_TX2Q_EN |\r\nMT_PBF_CFG_TX3Q_EN));\r\nmt7601u_wr(dev, MT_FCE_PSE_CTRL, 1);\r\nmt7601u_wr(dev, MT_USB_DMA_CFG, (MT_USB_DMA_CFG_RX_BULK_EN |\r\nMT_USB_DMA_CFG_TX_BULK_EN));\r\nval = mt76_set(dev, MT_USB_DMA_CFG, MT_USB_DMA_CFG_TX_CLR);\r\nval &= ~MT_USB_DMA_CFG_TX_CLR;\r\nmt7601u_wr(dev, MT_USB_DMA_CFG, val);\r\nmt7601u_wr(dev, MT_TX_CPU_FROM_FCE_BASE_PTR, 0x400230);\r\nmt7601u_wr(dev, MT_TX_CPU_FROM_FCE_MAX_COUNT, 1);\r\nmt7601u_wr(dev, MT_FCE_PDMA_GLOBAL_CONF, 0x44);\r\nmt7601u_wr(dev, MT_FCE_SKIP_FS, 3);\r\nret = mt7601u_upload_firmware(dev, (const struct mt76_fw *)fw->data);\r\nrelease_firmware(fw);\r\nreturn ret;\r\nerr_inv_fw:\r\ndev_err(dev->dev, "Invalid firmware image\n");\r\nrelease_firmware(fw);\r\nreturn -ENOENT;\r\n}\r\nint mt7601u_mcu_init(struct mt7601u_dev *dev)\r\n{\r\nint ret;\r\nmutex_init(&dev->mcu.mutex);\r\nret = mt7601u_load_firmware(dev);\r\nif (ret)\r\nreturn ret;\r\nset_bit(MT7601U_STATE_MCU_RUNNING, &dev->state);\r\nreturn 0;\r\n}\r\nint mt7601u_mcu_cmd_init(struct mt7601u_dev *dev)\r\n{\r\nint ret;\r\nret = mt7601u_mcu_function_select(dev, Q_SELECT, 1);\r\nif (ret)\r\nreturn ret;\r\ninit_completion(&dev->mcu.resp_cmpl);\r\nif (mt7601u_usb_alloc_buf(dev, MCU_RESP_URB_SIZE, &dev->mcu.resp)) {\r\nmt7601u_usb_free_buf(dev, &dev->mcu.resp);\r\nreturn -ENOMEM;\r\n}\r\nret = mt7601u_usb_submit_buf(dev, USB_DIR_IN, MT_EP_IN_CMD_RESP,\r\n&dev->mcu.resp, GFP_KERNEL,\r\nmt7601u_complete_urb, &dev->mcu.resp_cmpl);\r\nif (ret) {\r\nmt7601u_usb_free_buf(dev, &dev->mcu.resp);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid mt7601u_mcu_cmd_deinit(struct mt7601u_dev *dev)\r\n{\r\nusb_kill_urb(dev->mcu.resp.urb);\r\nmt7601u_usb_free_buf(dev, &dev->mcu.resp);\r\n}

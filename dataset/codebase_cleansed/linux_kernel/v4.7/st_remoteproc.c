static int st_rproc_start(struct rproc *rproc)\r\n{\r\nstruct st_rproc *ddata = rproc->priv;\r\nint err;\r\nregmap_update_bits(ddata->boot_base, ddata->boot_offset,\r\nddata->config->bootaddr_mask, rproc->bootaddr);\r\nerr = clk_enable(ddata->clk);\r\nif (err) {\r\ndev_err(&rproc->dev, "Failed to enable clock\n");\r\nreturn err;\r\n}\r\nif (ddata->config->sw_reset) {\r\nerr = reset_control_deassert(ddata->sw_reset);\r\nif (err) {\r\ndev_err(&rproc->dev, "Failed to deassert S/W Reset\n");\r\ngoto sw_reset_fail;\r\n}\r\n}\r\nif (ddata->config->pwr_reset) {\r\nerr = reset_control_deassert(ddata->pwr_reset);\r\nif (err) {\r\ndev_err(&rproc->dev, "Failed to deassert Power Reset\n");\r\ngoto pwr_reset_fail;\r\n}\r\n}\r\ndev_info(&rproc->dev, "Started from 0x%x\n", rproc->bootaddr);\r\nreturn 0;\r\npwr_reset_fail:\r\nif (ddata->config->pwr_reset)\r\nreset_control_assert(ddata->sw_reset);\r\nsw_reset_fail:\r\nclk_disable(ddata->clk);\r\nreturn err;\r\n}\r\nstatic int st_rproc_stop(struct rproc *rproc)\r\n{\r\nstruct st_rproc *ddata = rproc->priv;\r\nint sw_err = 0, pwr_err = 0;\r\nif (ddata->config->sw_reset) {\r\nsw_err = reset_control_assert(ddata->sw_reset);\r\nif (sw_err)\r\ndev_err(&rproc->dev, "Failed to assert S/W Reset\n");\r\n}\r\nif (ddata->config->pwr_reset) {\r\npwr_err = reset_control_assert(ddata->pwr_reset);\r\nif (pwr_err)\r\ndev_err(&rproc->dev, "Failed to assert Power Reset\n");\r\n}\r\nclk_disable(ddata->clk);\r\nreturn sw_err ?: pwr_err;\r\n}\r\nstatic int st_rproc_state(struct platform_device *pdev)\r\n{\r\nstruct rproc *rproc = platform_get_drvdata(pdev);\r\nstruct st_rproc *ddata = rproc->priv;\r\nint reset_sw = 0, reset_pwr = 0;\r\nif (ddata->config->sw_reset)\r\nreset_sw = reset_control_status(ddata->sw_reset);\r\nif (ddata->config->pwr_reset)\r\nreset_pwr = reset_control_status(ddata->pwr_reset);\r\nif (reset_sw < 0 || reset_pwr < 0)\r\nreturn -EINVAL;\r\nreturn !reset_sw && !reset_pwr;\r\n}\r\nstatic int st_rproc_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct rproc *rproc = platform_get_drvdata(pdev);\r\nstruct st_rproc *ddata = rproc->priv;\r\nstruct device_node *np = dev->of_node;\r\nint err;\r\nif (ddata->config->sw_reset) {\r\nddata->sw_reset = devm_reset_control_get(dev, "sw_reset");\r\nif (IS_ERR(ddata->sw_reset)) {\r\ndev_err(dev, "Failed to get S/W Reset\n");\r\nreturn PTR_ERR(ddata->sw_reset);\r\n}\r\n}\r\nif (ddata->config->pwr_reset) {\r\nddata->pwr_reset = devm_reset_control_get(dev, "pwr_reset");\r\nif (IS_ERR(ddata->pwr_reset)) {\r\ndev_err(dev, "Failed to get Power Reset\n");\r\nreturn PTR_ERR(ddata->pwr_reset);\r\n}\r\n}\r\nddata->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(ddata->clk)) {\r\ndev_err(dev, "Failed to get clock\n");\r\nreturn PTR_ERR(ddata->clk);\r\n}\r\nerr = of_property_read_u32(np, "clock-frequency", &ddata->clk_rate);\r\nif (err) {\r\ndev_err(dev, "failed to get clock frequency\n");\r\nreturn err;\r\n}\r\nddata->boot_base = syscon_regmap_lookup_by_phandle(np, "st,syscfg");\r\nif (IS_ERR(ddata->boot_base)) {\r\ndev_err(dev, "Boot base not found\n");\r\nreturn PTR_ERR(ddata->boot_base);\r\n}\r\nerr = of_property_read_u32_index(np, "st,syscfg", 1,\r\n&ddata->boot_offset);\r\nif (err) {\r\ndev_err(dev, "Boot offset not found\n");\r\nreturn -EINVAL;\r\n}\r\nerr = of_reserved_mem_device_init(dev);\r\nif (err) {\r\ndev_err(dev, "Failed to obtain shared memory\n");\r\nreturn err;\r\n}\r\nerr = clk_prepare(ddata->clk);\r\nif (err)\r\ndev_err(dev, "failed to get clock\n");\r\nreturn err;\r\n}\r\nstatic int st_rproc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nconst struct of_device_id *match;\r\nstruct st_rproc *ddata;\r\nstruct device_node *np = dev->of_node;\r\nstruct rproc *rproc;\r\nint enabled;\r\nint ret;\r\nmatch = of_match_device(st_rproc_match, dev);\r\nif (!match || !match->data) {\r\ndev_err(dev, "No device match found\n");\r\nreturn -ENODEV;\r\n}\r\nrproc = rproc_alloc(dev, np->name, &st_rproc_ops, NULL, sizeof(*ddata));\r\nif (!rproc)\r\nreturn -ENOMEM;\r\nrproc->has_iommu = false;\r\nddata = rproc->priv;\r\nddata->config = (struct st_rproc_config *)match->data;\r\nplatform_set_drvdata(pdev, rproc);\r\nret = st_rproc_parse_dt(pdev);\r\nif (ret)\r\ngoto free_rproc;\r\nenabled = st_rproc_state(pdev);\r\nif (enabled < 0)\r\ngoto free_rproc;\r\nif (enabled) {\r\natomic_inc(&rproc->power);\r\nrproc->state = RPROC_RUNNING;\r\n} else {\r\nclk_set_rate(ddata->clk, ddata->clk_rate);\r\n}\r\nret = rproc_add(rproc);\r\nif (ret)\r\ngoto free_rproc;\r\nreturn 0;\r\nfree_rproc:\r\nrproc_put(rproc);\r\nreturn ret;\r\n}\r\nstatic int st_rproc_remove(struct platform_device *pdev)\r\n{\r\nstruct rproc *rproc = platform_get_drvdata(pdev);\r\nstruct st_rproc *ddata = rproc->priv;\r\nrproc_del(rproc);\r\nclk_disable_unprepare(ddata->clk);\r\nof_reserved_mem_device_release(&pdev->dev);\r\nrproc_put(rproc);\r\nreturn 0;\r\n}

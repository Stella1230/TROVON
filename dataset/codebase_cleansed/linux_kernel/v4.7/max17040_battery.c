static int max17040_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max17040_chip *chip = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = chip->status;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = chip->online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = chip->vcell;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = chip->soc;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max17040_write_reg(struct i2c_client *client, int reg, u8 value)\r\n{\r\nint ret;\r\nret = i2c_smbus_write_byte_data(client, reg, value);\r\nif (ret < 0)\r\ndev_err(&client->dev, "%s: err %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic int max17040_read_reg(struct i2c_client *client, int reg)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_byte_data(client, reg);\r\nif (ret < 0)\r\ndev_err(&client->dev, "%s: err %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic void max17040_reset(struct i2c_client *client)\r\n{\r\nmax17040_write_reg(client, MAX17040_CMD_MSB, 0x54);\r\nmax17040_write_reg(client, MAX17040_CMD_LSB, 0x00);\r\n}\r\nstatic void max17040_get_vcell(struct i2c_client *client)\r\n{\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\nu8 msb;\r\nu8 lsb;\r\nmsb = max17040_read_reg(client, MAX17040_VCELL_MSB);\r\nlsb = max17040_read_reg(client, MAX17040_VCELL_LSB);\r\nchip->vcell = (msb << 4) + (lsb >> 4);\r\n}\r\nstatic void max17040_get_soc(struct i2c_client *client)\r\n{\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\nu8 msb;\r\nu8 lsb;\r\nmsb = max17040_read_reg(client, MAX17040_SOC_MSB);\r\nlsb = max17040_read_reg(client, MAX17040_SOC_LSB);\r\nchip->soc = msb;\r\n}\r\nstatic void max17040_get_version(struct i2c_client *client)\r\n{\r\nu8 msb;\r\nu8 lsb;\r\nmsb = max17040_read_reg(client, MAX17040_VER_MSB);\r\nlsb = max17040_read_reg(client, MAX17040_VER_LSB);\r\ndev_info(&client->dev, "MAX17040 Fuel-Gauge Ver %d%d\n", msb, lsb);\r\n}\r\nstatic void max17040_get_online(struct i2c_client *client)\r\n{\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\nif (chip->pdata && chip->pdata->battery_online)\r\nchip->online = chip->pdata->battery_online();\r\nelse\r\nchip->online = 1;\r\n}\r\nstatic void max17040_get_status(struct i2c_client *client)\r\n{\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\nif (!chip->pdata || !chip->pdata->charger_online\r\n|| !chip->pdata->charger_enable) {\r\nchip->status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nreturn;\r\n}\r\nif (chip->pdata->charger_online()) {\r\nif (chip->pdata->charger_enable())\r\nchip->status = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nchip->status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\n} else {\r\nchip->status = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nif (chip->soc > MAX17040_BATTERY_FULL)\r\nchip->status = POWER_SUPPLY_STATUS_FULL;\r\n}\r\nstatic void max17040_work(struct work_struct *work)\r\n{\r\nstruct max17040_chip *chip;\r\nchip = container_of(work, struct max17040_chip, work.work);\r\nmax17040_get_vcell(chip->client);\r\nmax17040_get_soc(chip->client);\r\nmax17040_get_online(chip->client);\r\nmax17040_get_status(chip->client);\r\nqueue_delayed_work(system_power_efficient_wq, &chip->work,\r\nMAX17040_DELAY);\r\n}\r\nstatic int max17040_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nstruct power_supply_config psy_cfg = {};\r\nstruct max17040_chip *chip;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE))\r\nreturn -EIO;\r\nchip = devm_kzalloc(&client->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nchip->client = client;\r\nchip->pdata = client->dev.platform_data;\r\ni2c_set_clientdata(client, chip);\r\npsy_cfg.drv_data = chip;\r\nchip->battery = power_supply_register(&client->dev,\r\n&max17040_battery_desc, &psy_cfg);\r\nif (IS_ERR(chip->battery)) {\r\ndev_err(&client->dev, "failed: power supply register\n");\r\nreturn PTR_ERR(chip->battery);\r\n}\r\nmax17040_reset(client);\r\nmax17040_get_version(client);\r\nINIT_DEFERRABLE_WORK(&chip->work, max17040_work);\r\nqueue_delayed_work(system_power_efficient_wq, &chip->work,\r\nMAX17040_DELAY);\r\nreturn 0;\r\n}\r\nstatic int max17040_remove(struct i2c_client *client)\r\n{\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\npower_supply_unregister(chip->battery);\r\ncancel_delayed_work(&chip->work);\r\nreturn 0;\r\n}\r\nstatic int max17040_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\ncancel_delayed_work(&chip->work);\r\nreturn 0;\r\n}\r\nstatic int max17040_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct max17040_chip *chip = i2c_get_clientdata(client);\r\nqueue_delayed_work(system_power_efficient_wq, &chip->work,\r\nMAX17040_DELAY);\r\nreturn 0;\r\n}

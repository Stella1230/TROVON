static unsigned long __get_mult(struct clk_multiplier *mult,\r\nunsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nif (mult->flags & CLK_MULTIPLIER_ROUND_CLOSEST)\r\nreturn DIV_ROUND_CLOSEST(rate, parent_rate);\r\nreturn rate / parent_rate;\r\n}\r\nstatic unsigned long clk_multiplier_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_multiplier *mult = to_clk_multiplier(hw);\r\nunsigned long val;\r\nval = clk_readl(mult->reg) >> mult->shift;\r\nval &= GENMASK(mult->width - 1, 0);\r\nif (!val && mult->flags & CLK_MULTIPLIER_ZERO_BYPASS)\r\nval = 1;\r\nreturn parent_rate * val;\r\n}\r\nstatic bool __is_best_rate(unsigned long rate, unsigned long new,\r\nunsigned long best, unsigned long flags)\r\n{\r\nif (flags & CLK_MULTIPLIER_ROUND_CLOSEST)\r\nreturn abs(rate - new) < abs(rate - best);\r\nreturn new >= rate && new < best;\r\n}\r\nstatic unsigned long __bestmult(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *best_parent_rate,\r\nu8 width, unsigned long flags)\r\n{\r\nunsigned long orig_parent_rate = *best_parent_rate;\r\nunsigned long parent_rate, current_rate, best_rate = ~0;\r\nunsigned int i, bestmult = 0;\r\nif (!(clk_hw_get_flags(hw) & CLK_SET_RATE_PARENT))\r\nreturn rate / *best_parent_rate;\r\nfor (i = 1; i < ((1 << width) - 1); i++) {\r\nif (rate == orig_parent_rate * i) {\r\n*best_parent_rate = orig_parent_rate;\r\nreturn i;\r\n}\r\nparent_rate = clk_hw_round_rate(clk_hw_get_parent(hw),\r\nrate / i);\r\ncurrent_rate = parent_rate * i;\r\nif (__is_best_rate(rate, current_rate, best_rate, flags)) {\r\nbestmult = i;\r\nbest_rate = current_rate;\r\n*best_parent_rate = parent_rate;\r\n}\r\n}\r\nreturn bestmult;\r\n}\r\nstatic long clk_multiplier_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct clk_multiplier *mult = to_clk_multiplier(hw);\r\nunsigned long factor = __bestmult(hw, rate, parent_rate,\r\nmult->width, mult->flags);\r\nreturn *parent_rate * factor;\r\n}\r\nstatic int clk_multiplier_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_multiplier *mult = to_clk_multiplier(hw);\r\nunsigned long factor = __get_mult(mult, rate, parent_rate);\r\nunsigned long flags = 0;\r\nunsigned long val;\r\nif (mult->lock)\r\nspin_lock_irqsave(mult->lock, flags);\r\nelse\r\n__acquire(mult->lock);\r\nval = clk_readl(mult->reg);\r\nval &= ~GENMASK(mult->width + mult->shift - 1, mult->shift);\r\nval |= factor << mult->shift;\r\nclk_writel(val, mult->reg);\r\nif (mult->lock)\r\nspin_unlock_irqrestore(mult->lock, flags);\r\nelse\r\n__release(mult->lock);\r\nreturn 0;\r\n}

void\r\nlnet_build_unlink_event(lnet_libmd_t *md, lnet_event_t *ev)\r\n{\r\nmemset(ev, 0, sizeof(*ev));\r\nev->status = 0;\r\nev->unlinked = 1;\r\nev->type = LNET_EVENT_UNLINK;\r\nlnet_md_deconstruct(md, &ev->md);\r\nlnet_md2handle(&ev->md_handle, md);\r\n}\r\nvoid\r\nlnet_build_msg_event(lnet_msg_t *msg, lnet_event_kind_t ev_type)\r\n{\r\nlnet_hdr_t *hdr = &msg->msg_hdr;\r\nlnet_event_t *ev = &msg->msg_ev;\r\nLASSERT(!msg->msg_routing);\r\nev->type = ev_type;\r\nif (ev_type == LNET_EVENT_SEND) {\r\nev->target.nid = le64_to_cpu(hdr->dest_nid);\r\nev->target.pid = le32_to_cpu(hdr->dest_pid);\r\nev->initiator.nid = LNET_NID_ANY;\r\nev->initiator.pid = the_lnet.ln_pid;\r\nev->sender = LNET_NID_ANY;\r\n} else {\r\nev->target.pid = hdr->dest_pid;\r\nev->target.nid = hdr->dest_nid;\r\nev->initiator.pid = hdr->src_pid;\r\nev->initiator.nid = hdr->src_nid;\r\nev->rlength = hdr->payload_length;\r\nev->sender = msg->msg_from;\r\nev->mlength = msg->msg_wanted;\r\nev->offset = msg->msg_offset;\r\n}\r\nswitch (ev_type) {\r\ndefault:\r\nLBUG();\r\ncase LNET_EVENT_PUT:\r\nev->pt_index = hdr->msg.put.ptl_index;\r\nev->match_bits = hdr->msg.put.match_bits;\r\nev->hdr_data = hdr->msg.put.hdr_data;\r\nreturn;\r\ncase LNET_EVENT_GET:\r\nev->pt_index = hdr->msg.get.ptl_index;\r\nev->match_bits = hdr->msg.get.match_bits;\r\nev->hdr_data = 0;\r\nreturn;\r\ncase LNET_EVENT_ACK:\r\nev->match_bits = hdr->msg.ack.match_bits;\r\nev->mlength = hdr->msg.ack.mlength;\r\nreturn;\r\ncase LNET_EVENT_REPLY:\r\nreturn;\r\ncase LNET_EVENT_SEND:\r\nif (msg->msg_type == LNET_MSG_PUT) {\r\nev->pt_index = le32_to_cpu(hdr->msg.put.ptl_index);\r\nev->match_bits = le64_to_cpu(hdr->msg.put.match_bits);\r\nev->offset = le32_to_cpu(hdr->msg.put.offset);\r\nev->mlength =\r\nev->rlength = le32_to_cpu(hdr->payload_length);\r\nev->hdr_data = le64_to_cpu(hdr->msg.put.hdr_data);\r\n} else {\r\nLASSERT(msg->msg_type == LNET_MSG_GET);\r\nev->pt_index = le32_to_cpu(hdr->msg.get.ptl_index);\r\nev->match_bits = le64_to_cpu(hdr->msg.get.match_bits);\r\nev->mlength =\r\nev->rlength = le32_to_cpu(hdr->msg.get.sink_length);\r\nev->offset = le32_to_cpu(hdr->msg.get.src_offset);\r\nev->hdr_data = 0;\r\n}\r\nreturn;\r\n}\r\n}\r\nvoid\r\nlnet_msg_commit(lnet_msg_t *msg, int cpt)\r\n{\r\nstruct lnet_msg_container *container = the_lnet.ln_msg_containers[cpt];\r\nlnet_counters_t *counters = the_lnet.ln_counters[cpt];\r\nLASSERT(!msg->msg_tx_committed);\r\nif (msg->msg_sending) {\r\nLASSERT(!msg->msg_receiving);\r\nmsg->msg_tx_cpt = cpt;\r\nmsg->msg_tx_committed = 1;\r\nif (msg->msg_rx_committed) {\r\nLASSERT(msg->msg_onactivelist);\r\nreturn;\r\n}\r\n} else {\r\nLASSERT(!msg->msg_sending);\r\nmsg->msg_rx_cpt = cpt;\r\nmsg->msg_rx_committed = 1;\r\n}\r\nLASSERT(!msg->msg_onactivelist);\r\nmsg->msg_onactivelist = 1;\r\nlist_add(&msg->msg_activelist, &container->msc_active);\r\ncounters->msgs_alloc++;\r\nif (counters->msgs_alloc > counters->msgs_max)\r\ncounters->msgs_max = counters->msgs_alloc;\r\n}\r\nstatic void\r\nlnet_msg_decommit_tx(lnet_msg_t *msg, int status)\r\n{\r\nlnet_counters_t *counters;\r\nlnet_event_t *ev = &msg->msg_ev;\r\nLASSERT(msg->msg_tx_committed);\r\nif (status)\r\ngoto out;\r\ncounters = the_lnet.ln_counters[msg->msg_tx_cpt];\r\nswitch (ev->type) {\r\ndefault:\r\nLASSERT(msg->msg_routing);\r\nLASSERT(msg->msg_rx_committed);\r\nLASSERT(!ev->type);\r\ncounters->route_length += msg->msg_len;\r\ncounters->route_count++;\r\ngoto out;\r\ncase LNET_EVENT_PUT:\r\nLASSERT(!msg->msg_rx_committed);\r\nLASSERT(msg->msg_type == LNET_MSG_ACK);\r\nmsg->msg_type = LNET_MSG_PUT;\r\nbreak;\r\ncase LNET_EVENT_SEND:\r\nLASSERT(!msg->msg_rx_committed);\r\nif (msg->msg_type == LNET_MSG_PUT)\r\ncounters->send_length += msg->msg_len;\r\nbreak;\r\ncase LNET_EVENT_GET:\r\nLASSERT(msg->msg_rx_committed);\r\nLASSERT(msg->msg_type == LNET_MSG_REPLY);\r\nmsg->msg_type = LNET_MSG_GET;\r\nbreak;\r\n}\r\ncounters->send_count++;\r\nout:\r\nlnet_return_tx_credits_locked(msg);\r\nmsg->msg_tx_committed = 0;\r\n}\r\nstatic void\r\nlnet_msg_decommit_rx(lnet_msg_t *msg, int status)\r\n{\r\nlnet_counters_t *counters;\r\nlnet_event_t *ev = &msg->msg_ev;\r\nLASSERT(!msg->msg_tx_committed);\r\nLASSERT(msg->msg_rx_committed);\r\nif (status)\r\ngoto out;\r\ncounters = the_lnet.ln_counters[msg->msg_rx_cpt];\r\nswitch (ev->type) {\r\ndefault:\r\nLASSERT(!ev->type);\r\nLASSERT(msg->msg_routing);\r\ngoto out;\r\ncase LNET_EVENT_ACK:\r\nLASSERT(msg->msg_type == LNET_MSG_ACK);\r\nbreak;\r\ncase LNET_EVENT_GET:\r\nLASSERT(msg->msg_type == LNET_MSG_REPLY ||\r\nmsg->msg_type == LNET_MSG_GET);\r\ncounters->send_length += msg->msg_wanted;\r\nbreak;\r\ncase LNET_EVENT_PUT:\r\nLASSERT(msg->msg_type == LNET_MSG_PUT);\r\nbreak;\r\ncase LNET_EVENT_REPLY:\r\nLASSERT(msg->msg_type == LNET_MSG_GET ||\r\nmsg->msg_type == LNET_MSG_REPLY);\r\nbreak;\r\n}\r\ncounters->recv_count++;\r\nif (ev->type == LNET_EVENT_PUT || ev->type == LNET_EVENT_REPLY)\r\ncounters->recv_length += msg->msg_wanted;\r\nout:\r\nlnet_return_rx_credits_locked(msg);\r\nmsg->msg_rx_committed = 0;\r\n}\r\nvoid\r\nlnet_msg_decommit(lnet_msg_t *msg, int cpt, int status)\r\n{\r\nint cpt2 = cpt;\r\nLASSERT(msg->msg_tx_committed || msg->msg_rx_committed);\r\nLASSERT(msg->msg_onactivelist);\r\nif (msg->msg_tx_committed) {\r\nLASSERT(cpt == msg->msg_tx_cpt);\r\nlnet_msg_decommit_tx(msg, status);\r\n}\r\nif (msg->msg_rx_committed) {\r\nif (cpt != msg->msg_rx_cpt) {\r\nlnet_net_unlock(cpt);\r\ncpt2 = msg->msg_rx_cpt;\r\nlnet_net_lock(cpt2);\r\n}\r\nlnet_msg_decommit_rx(msg, status);\r\n}\r\nlist_del(&msg->msg_activelist);\r\nmsg->msg_onactivelist = 0;\r\nthe_lnet.ln_counters[cpt2]->msgs_alloc--;\r\nif (cpt2 != cpt) {\r\nlnet_net_unlock(cpt2);\r\nlnet_net_lock(cpt);\r\n}\r\n}\r\nvoid\r\nlnet_msg_attach_md(lnet_msg_t *msg, lnet_libmd_t *md,\r\nunsigned int offset, unsigned int mlen)\r\n{\r\nLASSERT(!msg->msg_routing);\r\nmsg->msg_md = md;\r\nif (msg->msg_receiving) {\r\nmsg->msg_offset = offset;\r\nmsg->msg_wanted = mlen;\r\n}\r\nmd->md_refcount++;\r\nif (md->md_threshold != LNET_MD_THRESH_INF) {\r\nLASSERT(md->md_threshold > 0);\r\nmd->md_threshold--;\r\n}\r\nlnet_md2handle(&msg->msg_ev.md_handle, md);\r\nlnet_md_deconstruct(md, &msg->msg_ev.md);\r\n}\r\nvoid\r\nlnet_msg_detach_md(lnet_msg_t *msg, int status)\r\n{\r\nlnet_libmd_t *md = msg->msg_md;\r\nint unlink;\r\nmd->md_refcount--;\r\nLASSERT(md->md_refcount >= 0);\r\nunlink = lnet_md_unlinkable(md);\r\nif (md->md_eq) {\r\nmsg->msg_ev.status = status;\r\nmsg->msg_ev.unlinked = unlink;\r\nlnet_eq_enqueue_event(md->md_eq, &msg->msg_ev);\r\n}\r\nif (unlink)\r\nlnet_md_unlink(md);\r\nmsg->msg_md = NULL;\r\n}\r\nstatic int\r\nlnet_complete_msg_locked(lnet_msg_t *msg, int cpt)\r\n{\r\nlnet_handle_wire_t ack_wmd;\r\nint rc;\r\nint status = msg->msg_ev.status;\r\nLASSERT(msg->msg_onactivelist);\r\nif (!status && msg->msg_ack) {\r\nlnet_msg_decommit(msg, cpt, 0);\r\nmsg->msg_ack = 0;\r\nlnet_net_unlock(cpt);\r\nLASSERT(msg->msg_ev.type == LNET_EVENT_PUT);\r\nLASSERT(!msg->msg_routing);\r\nack_wmd = msg->msg_hdr.msg.put.ack_wmd;\r\nlnet_prep_send(msg, LNET_MSG_ACK, msg->msg_ev.initiator, 0, 0);\r\nmsg->msg_hdr.msg.ack.dst_wmd = ack_wmd;\r\nmsg->msg_hdr.msg.ack.match_bits = msg->msg_ev.match_bits;\r\nmsg->msg_hdr.msg.ack.mlength = cpu_to_le32(msg->msg_ev.mlength);\r\nrc = lnet_send(msg->msg_ev.target.nid, msg, LNET_NID_ANY);\r\nlnet_net_lock(cpt);\r\nreturn rc;\r\n} else if (!status &&\r\n(msg->msg_routing && !msg->msg_sending)) {\r\nLASSERT(!msg->msg_receiving);\r\nlnet_net_unlock(cpt);\r\nrc = lnet_send(LNET_NID_ANY, msg, LNET_NID_ANY);\r\nlnet_net_lock(cpt);\r\nreturn rc;\r\n}\r\nlnet_msg_decommit(msg, cpt, status);\r\nlnet_msg_free(msg);\r\nreturn 0;\r\n}\r\nvoid\r\nlnet_finalize(lnet_ni_t *ni, lnet_msg_t *msg, int status)\r\n{\r\nstruct lnet_msg_container *container;\r\nint my_slot;\r\nint cpt;\r\nint rc;\r\nint i;\r\nLASSERT(!in_interrupt());\r\nif (!msg)\r\nreturn;\r\n#if 0\r\nCDEBUG(D_WARNING, "%s msg->%s Flags:%s%s%s%s%s%s%s%s%s%s%s txp %s rxp %s\n",\r\nlnet_msgtyp2str(msg->msg_type), libcfs_id2str(msg->msg_target),\r\nmsg->msg_target_is_router ? "t" : "",\r\nmsg->msg_routing ? "X" : "",\r\nmsg->msg_ack ? "A" : "",\r\nmsg->msg_sending ? "S" : "",\r\nmsg->msg_receiving ? "R" : "",\r\nmsg->msg_delayed ? "d" : "",\r\nmsg->msg_txcredit ? "C" : "",\r\nmsg->msg_peertxcredit ? "c" : "",\r\nmsg->msg_rtrcredit ? "F" : "",\r\nmsg->msg_peerrtrcredit ? "f" : "",\r\nmsg->msg_onactivelist ? "!" : "",\r\n!msg->msg_txpeer ? "<none>" : libcfs_nid2str(msg->msg_txpeer->lp_nid),\r\n!msg->msg_rxpeer ? "<none>" : libcfs_nid2str(msg->msg_rxpeer->lp_nid));\r\n#endif\r\nmsg->msg_ev.status = status;\r\nif (msg->msg_md) {\r\ncpt = lnet_cpt_of_cookie(msg->msg_md->md_lh.lh_cookie);\r\nlnet_res_lock(cpt);\r\nlnet_msg_detach_md(msg, status);\r\nlnet_res_unlock(cpt);\r\n}\r\nagain:\r\nrc = 0;\r\nif (!msg->msg_tx_committed && !msg->msg_rx_committed) {\r\nLASSERT(!msg->msg_onactivelist);\r\nlnet_msg_free(msg);\r\nreturn;\r\n}\r\ncpt = msg->msg_tx_committed ? msg->msg_tx_cpt : msg->msg_rx_cpt;\r\nlnet_net_lock(cpt);\r\ncontainer = the_lnet.ln_msg_containers[cpt];\r\nlist_add_tail(&msg->msg_list, &container->msc_finalizing);\r\nmy_slot = -1;\r\nfor (i = 0; i < container->msc_nfinalizers; i++) {\r\nif (container->msc_finalizers[i] == current)\r\nbreak;\r\nif (my_slot < 0 && !container->msc_finalizers[i])\r\nmy_slot = i;\r\n}\r\nif (i < container->msc_nfinalizers || my_slot < 0) {\r\nlnet_net_unlock(cpt);\r\nreturn;\r\n}\r\ncontainer->msc_finalizers[my_slot] = current;\r\nwhile (!list_empty(&container->msc_finalizing)) {\r\nmsg = list_entry(container->msc_finalizing.next,\r\nlnet_msg_t, msg_list);\r\nlist_del(&msg->msg_list);\r\nrc = lnet_complete_msg_locked(msg, cpt);\r\nif (rc)\r\nbreak;\r\n}\r\nif (unlikely(!list_empty(&the_lnet.ln_delay_rules))) {\r\nlnet_net_unlock(cpt);\r\nlnet_delay_rule_check();\r\nlnet_net_lock(cpt);\r\n}\r\ncontainer->msc_finalizers[my_slot] = NULL;\r\nlnet_net_unlock(cpt);\r\nif (rc)\r\ngoto again;\r\n}\r\nvoid\r\nlnet_msg_container_cleanup(struct lnet_msg_container *container)\r\n{\r\nint count = 0;\r\nif (!container->msc_init)\r\nreturn;\r\nwhile (!list_empty(&container->msc_active)) {\r\nlnet_msg_t *msg = list_entry(container->msc_active.next,\r\nlnet_msg_t, msg_activelist);\r\nLASSERT(msg->msg_onactivelist);\r\nmsg->msg_onactivelist = 0;\r\nlist_del(&msg->msg_activelist);\r\nlnet_msg_free(msg);\r\ncount++;\r\n}\r\nif (count > 0)\r\nCERROR("%d active msg on exit\n", count);\r\nif (container->msc_finalizers) {\r\nLIBCFS_FREE(container->msc_finalizers,\r\ncontainer->msc_nfinalizers *\r\nsizeof(*container->msc_finalizers));\r\ncontainer->msc_finalizers = NULL;\r\n}\r\ncontainer->msc_init = 0;\r\n}\r\nint\r\nlnet_msg_container_setup(struct lnet_msg_container *container, int cpt)\r\n{\r\ncontainer->msc_init = 1;\r\nINIT_LIST_HEAD(&container->msc_active);\r\nINIT_LIST_HEAD(&container->msc_finalizing);\r\ncontainer->msc_nfinalizers = cfs_cpt_weight(lnet_cpt_table(), cpt);\r\nLIBCFS_CPT_ALLOC(container->msc_finalizers, lnet_cpt_table(), cpt,\r\ncontainer->msc_nfinalizers *\r\nsizeof(*container->msc_finalizers));\r\nif (!container->msc_finalizers) {\r\nCERROR("Failed to allocate message finalizers\n");\r\nlnet_msg_container_cleanup(container);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nlnet_msg_containers_destroy(void)\r\n{\r\nstruct lnet_msg_container *container;\r\nint i;\r\nif (!the_lnet.ln_msg_containers)\r\nreturn;\r\ncfs_percpt_for_each(container, i, the_lnet.ln_msg_containers)\r\nlnet_msg_container_cleanup(container);\r\ncfs_percpt_free(the_lnet.ln_msg_containers);\r\nthe_lnet.ln_msg_containers = NULL;\r\n}\r\nint\r\nlnet_msg_containers_create(void)\r\n{\r\nstruct lnet_msg_container *container;\r\nint rc;\r\nint i;\r\nthe_lnet.ln_msg_containers = cfs_percpt_alloc(lnet_cpt_table(),\r\nsizeof(*container));\r\nif (!the_lnet.ln_msg_containers) {\r\nCERROR("Failed to allocate cpu-partition data for network\n");\r\nreturn -ENOMEM;\r\n}\r\ncfs_percpt_for_each(container, i, the_lnet.ln_msg_containers) {\r\nrc = lnet_msg_container_setup(container, i);\r\nif (rc) {\r\nlnet_msg_containers_destroy();\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}

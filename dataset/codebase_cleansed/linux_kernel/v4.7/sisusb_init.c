static void SiSUSB_InitPtr(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_Pr->SiS_ModeResInfo = SiSUSB_ModeResInfo;\r\nSiS_Pr->SiS_StandTable = SiSUSB_StandTable;\r\nSiS_Pr->SiS_SModeIDTable = SiSUSB_SModeIDTable;\r\nSiS_Pr->SiS_EModeIDTable = SiSUSB_EModeIDTable;\r\nSiS_Pr->SiS_RefIndex = SiSUSB_RefIndex;\r\nSiS_Pr->SiS_CRT1Table = SiSUSB_CRT1Table;\r\nSiS_Pr->SiS_VCLKData = SiSUSB_VCLKData;\r\n}\r\nstatic void\r\nSiS_SetReg(struct SiS_Private *SiS_Pr, unsigned long port,\r\nunsigned short index, unsigned short data)\r\n{\r\nsisusb_setidxreg(SiS_Pr->sisusb, port, index, data);\r\n}\r\nstatic void\r\nSiS_SetRegByte(struct SiS_Private *SiS_Pr, unsigned long port,\r\nunsigned short data)\r\n{\r\nsisusb_setreg(SiS_Pr->sisusb, port, data);\r\n}\r\nstatic unsigned char\r\nSiS_GetReg(struct SiS_Private *SiS_Pr, unsigned long port, unsigned short index)\r\n{\r\nu8 data;\r\nsisusb_getidxreg(SiS_Pr->sisusb, port, index, &data);\r\nreturn data;\r\n}\r\nstatic unsigned char\r\nSiS_GetRegByte(struct SiS_Private *SiS_Pr, unsigned long port)\r\n{\r\nu8 data;\r\nsisusb_getreg(SiS_Pr->sisusb, port, &data);\r\nreturn data;\r\n}\r\nstatic void\r\nSiS_SetRegANDOR(struct SiS_Private *SiS_Pr, unsigned long port,\r\nunsigned short index, unsigned short DataAND,\r\nunsigned short DataOR)\r\n{\r\nsisusb_setidxregandor(SiS_Pr->sisusb, port, index, DataAND, DataOR);\r\n}\r\nstatic void\r\nSiS_SetRegAND(struct SiS_Private *SiS_Pr, unsigned long port,\r\nunsigned short index, unsigned short DataAND)\r\n{\r\nsisusb_setidxregand(SiS_Pr->sisusb, port, index, DataAND);\r\n}\r\nstatic void\r\nSiS_SetRegOR(struct SiS_Private *SiS_Pr, unsigned long port,\r\nunsigned short index, unsigned short DataOR)\r\n{\r\nsisusb_setidxregor(SiS_Pr->sisusb, port, index, DataOR);\r\n}\r\nstatic void SiS_DisplayOn(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x01, 0xDF);\r\n}\r\nstatic void SiSUSBRegInit(struct SiS_Private *SiS_Pr, unsigned long BaseAddr)\r\n{\r\nSiS_Pr->SiS_P3c4 = BaseAddr + 0x14;\r\nSiS_Pr->SiS_P3d4 = BaseAddr + 0x24;\r\nSiS_Pr->SiS_P3c0 = BaseAddr + 0x10;\r\nSiS_Pr->SiS_P3ce = BaseAddr + 0x1e;\r\nSiS_Pr->SiS_P3c2 = BaseAddr + 0x12;\r\nSiS_Pr->SiS_P3ca = BaseAddr + 0x1a;\r\nSiS_Pr->SiS_P3c6 = BaseAddr + 0x16;\r\nSiS_Pr->SiS_P3c7 = BaseAddr + 0x17;\r\nSiS_Pr->SiS_P3c8 = BaseAddr + 0x18;\r\nSiS_Pr->SiS_P3c9 = BaseAddr + 0x19;\r\nSiS_Pr->SiS_P3cb = BaseAddr + 0x1b;\r\nSiS_Pr->SiS_P3cc = BaseAddr + 0x1c;\r\nSiS_Pr->SiS_P3cd = BaseAddr + 0x1d;\r\nSiS_Pr->SiS_P3da = BaseAddr + 0x2a;\r\nSiS_Pr->SiS_Part1Port = BaseAddr + SIS_CRT2_PORT_04;\r\n}\r\nstatic void SiS_GetSysFlags(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_Pr->SiS_MyCR63 = 0x63;\r\n}\r\nstatic void SiSInitPCIetc(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x20, 0xa1);\r\nSiS_SetRegOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x1E, 0xDA);\r\n}\r\nstatic void SiS_SetSegRegLower(struct SiS_Private *SiS_Pr, unsigned short value)\r\n{\r\nunsigned short temp;\r\nvalue &= 0x00ff;\r\ntemp = SiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3cb) & 0xf0;\r\ntemp |= (value >> 4);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3cb, temp);\r\ntemp = SiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3cd) & 0xf0;\r\ntemp |= (value & 0x0f);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3cd, temp);\r\n}\r\nstatic void SiS_SetSegRegUpper(struct SiS_Private *SiS_Pr, unsigned short value)\r\n{\r\nunsigned short temp;\r\nvalue &= 0x00ff;\r\ntemp = SiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3cb) & 0x0f;\r\ntemp |= (value & 0xf0);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3cb, temp);\r\ntemp = SiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3cd) & 0x0f;\r\ntemp |= (value << 4);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3cd, temp);\r\n}\r\nstatic void SiS_SetSegmentReg(struct SiS_Private *SiS_Pr, unsigned short value)\r\n{\r\nSiS_SetSegRegLower(SiS_Pr, value);\r\nSiS_SetSegRegUpper(SiS_Pr, value);\r\n}\r\nstatic void SiS_ResetSegmentReg(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetSegmentReg(SiS_Pr, 0);\r\n}\r\nstatic void\r\nSiS_SetSegmentRegOver(struct SiS_Private *SiS_Pr, unsigned short value)\r\n{\r\nunsigned short temp = value >> 8;\r\ntemp &= 0x07;\r\ntemp |= (temp << 4);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x1d, temp);\r\nSiS_SetSegmentReg(SiS_Pr, value);\r\n}\r\nstatic void SiS_ResetSegmentRegOver(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetSegmentRegOver(SiS_Pr, 0);\r\n}\r\nstatic void SiS_ResetSegmentRegisters(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_ResetSegmentReg(SiS_Pr);\r\nSiS_ResetSegmentRegOver(SiS_Pr);\r\n}\r\nstatic int\r\nSiS_SearchModeID(struct SiS_Private *SiS_Pr, unsigned short *ModeNo,\r\nunsigned short *ModeIdIndex)\r\n{\r\nif ((*ModeNo) <= 0x13) {\r\nif ((*ModeNo) != 0x03)\r\nreturn 0;\r\n(*ModeIdIndex) = 0;\r\n} else {\r\nfor (*ModeIdIndex = 0;; (*ModeIdIndex)++) {\r\nif (SiS_Pr->SiS_EModeIDTable[*ModeIdIndex].Ext_ModeID ==\r\n(*ModeNo))\r\nbreak;\r\nif (SiS_Pr->SiS_EModeIDTable[*ModeIdIndex].Ext_ModeID ==\r\n0xFF)\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic void SiS_HandleCRT1(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3d4, SiS_Pr->SiS_MyCR63, 0xbf);\r\n}\r\nstatic unsigned short\r\nSiS_GetColorDepth(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex)\r\n{\r\nstatic const unsigned short ColorDepth[6] = { 1, 2, 4, 4, 6, 8 };\r\nunsigned short modeflag;\r\nshort index;\r\nif (ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n}\r\nindex = (modeflag & ModeTypeMask) - ModeEGA;\r\nif (index < 0)\r\nindex = 0;\r\nreturn ColorDepth[index];\r\n}\r\nstatic unsigned short\r\nSiS_GetOffset(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short rrti)\r\n{\r\nunsigned short xres, temp, colordepth, infoflag;\r\ninfoflag = SiS_Pr->SiS_RefIndex[rrti].Ext_InfoFlag;\r\nxres = SiS_Pr->SiS_RefIndex[rrti].XRes;\r\ncolordepth = SiS_GetColorDepth(SiS_Pr, ModeNo, ModeIdIndex);\r\ntemp = xres / 16;\r\nif (infoflag & InterlaceMode)\r\ntemp <<= 1;\r\ntemp *= colordepth;\r\nif (xres % 16)\r\ntemp += (colordepth >> 1);\r\nreturn temp;\r\n}\r\nstatic void\r\nSiS_SetSeqRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\r\n{\r\nunsigned char SRdata;\r\nint i;\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x00, 0x03);\r\nSRdata = SiS_Pr->SiS_StandTable[StandTableIndex].SR[0] | 0x20;\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x01, SRdata);\r\nfor (i = 2; i <= 4; i++) {\r\nSRdata = SiS_Pr->SiS_StandTable[StandTableIndex].SR[i - 1];\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, i, SRdata);\r\n}\r\n}\r\nstatic void\r\nSiS_SetMiscRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\r\n{\r\nunsigned char Miscdata = SiS_Pr->SiS_StandTable[StandTableIndex].MISC;\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c2, Miscdata);\r\n}\r\nstatic void\r\nSiS_SetCRTCRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\r\n{\r\nunsigned char CRTCdata;\r\nunsigned short i;\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3d4, 0x11, 0x7f);\r\nfor (i = 0; i <= 0x18; i++) {\r\nCRTCdata = SiS_Pr->SiS_StandTable[StandTableIndex].CRTC[i];\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, i, CRTCdata);\r\n}\r\n}\r\nstatic void\r\nSiS_SetATTRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\r\n{\r\nunsigned char ARdata;\r\nunsigned short i;\r\nfor (i = 0; i <= 0x13; i++) {\r\nARdata = SiS_Pr->SiS_StandTable[StandTableIndex].ATTR[i];\r\nSiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3da);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c0, i);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c0, ARdata);\r\n}\r\nSiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3da);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c0, 0x14);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c0, 0x00);\r\nSiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3da);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c0, 0x20);\r\nSiS_GetRegByte(SiS_Pr, SiS_Pr->SiS_P3da);\r\n}\r\nstatic void\r\nSiS_SetGRCRegs(struct SiS_Private *SiS_Pr, unsigned short StandTableIndex)\r\n{\r\nunsigned char GRdata;\r\nunsigned short i;\r\nfor (i = 0; i <= 0x08; i++) {\r\nGRdata = SiS_Pr->SiS_StandTable[StandTableIndex].GRC[i];\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3ce, i, GRdata);\r\n}\r\nif (SiS_Pr->SiS_ModeType > ModeVGA) {\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3ce, 0x05, 0xBF);\r\n}\r\n}\r\nstatic void SiS_ClearExt1Regs(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nint i;\r\nfor (i = 0x0A; i <= 0x0E; i++) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, i, 0x00);\r\n}\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x37, 0xFE);\r\n}\r\nstatic unsigned short\r\nSiS_GetRatePtr(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex)\r\n{\r\nunsigned short rrti, i, index, temp;\r\nif (ModeNo <= 0x13)\r\nreturn 0xFFFF;\r\nindex = SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x33) & 0x0F;\r\nif (index > 0)\r\nindex--;\r\nrrti = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].REFindex;\r\nModeNo = SiS_Pr->SiS_RefIndex[rrti].ModeID;\r\ni = 0;\r\ndo {\r\nif (SiS_Pr->SiS_RefIndex[rrti + i].ModeID != ModeNo)\r\nbreak;\r\ntemp =\r\nSiS_Pr->SiS_RefIndex[rrti + i].Ext_InfoFlag & ModeTypeMask;\r\nif (temp < SiS_Pr->SiS_ModeType)\r\nbreak;\r\ni++;\r\nindex--;\r\n} while (index != 0xFFFF);\r\ni--;\r\nreturn (rrti + i);\r\n}\r\nstatic void SiS_SetCRT1Sync(struct SiS_Private *SiS_Pr, unsigned short rrti)\r\n{\r\nunsigned short sync = SiS_Pr->SiS_RefIndex[rrti].Ext_InfoFlag >> 8;\r\nsync &= 0xC0;\r\nsync |= 0x2f;\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c2, sync);\r\n}\r\nstatic void\r\nSiS_SetCRT1CRTC(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short rrti)\r\n{\r\nunsigned char index;\r\nunsigned short temp, i, j, modeflag;\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3d4, 0x11, 0x7f);\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nindex = SiS_Pr->SiS_RefIndex[rrti].Ext_CRT1CRTC;\r\nfor (i = 0, j = 0; i <= 7; i++, j++) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, j,\r\nSiS_Pr->SiS_CRT1Table[index].CR[i]);\r\n}\r\nfor (j = 0x10; i <= 10; i++, j++) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, j,\r\nSiS_Pr->SiS_CRT1Table[index].CR[i]);\r\n}\r\nfor (j = 0x15; i <= 12; i++, j++) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, j,\r\nSiS_Pr->SiS_CRT1Table[index].CR[i]);\r\n}\r\nfor (j = 0x0A; i <= 15; i++, j++) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, j,\r\nSiS_Pr->SiS_CRT1Table[index].CR[i]);\r\n}\r\ntemp = SiS_Pr->SiS_CRT1Table[index].CR[16] & 0xE0;\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0E, temp);\r\ntemp = ((SiS_Pr->SiS_CRT1Table[index].CR[16]) & 0x01) << 5;\r\nif (modeflag & DoubleScanMode)\r\ntemp |= 0x80;\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3d4, 0x09, 0x5F, temp);\r\nif (SiS_Pr->SiS_ModeType > ModeVGA)\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x14, 0x4F);\r\n}\r\nstatic void\r\nSiS_SetCRT1Offset(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short rrti)\r\n{\r\nunsigned short du = SiS_GetOffset(SiS_Pr, ModeNo, ModeIdIndex, rrti);\r\nunsigned short infoflag = SiS_Pr->SiS_RefIndex[rrti].Ext_InfoFlag;\r\nunsigned short temp;\r\ntemp = (du >> 8) & 0x0f;\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0E, 0xF0, temp);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x13, (du & 0xFF));\r\nif (infoflag & InterlaceMode)\r\ndu >>= 1;\r\ndu <<= 5;\r\ntemp = (du >> 8) & 0xff;\r\nif (du & 0xff)\r\ntemp++;\r\ntemp++;\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x10, temp);\r\n}\r\nstatic void\r\nSiS_SetCRT1VCLK(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short rrti)\r\n{\r\nunsigned short index = SiS_Pr->SiS_RefIndex[rrti].Ext_CRTVCLK;\r\nunsigned short clka = SiS_Pr->SiS_VCLKData[index].SR2B;\r\nunsigned short clkb = SiS_Pr->SiS_VCLKData[index].SR2C;\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x31, 0xCF);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x2B, clka);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x2C, clkb);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x2D, 0x01);\r\n}\r\nstatic void\r\nSiS_SetCRT1FIFO_310(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short mi)\r\n{\r\nunsigned short modeflag = SiS_Pr->SiS_EModeIDTable[mi].Ext_ModeFlag;\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x3D, 0xFE);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x08, 0xAE);\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x09, 0xF0);\r\nif (ModeNo <= 0x13)\r\nreturn;\r\nif ((!(modeflag & DoubleScanMode)) || (!(modeflag & HalfDCLK))) {\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x08, 0x34);\r\nSiS_SetRegOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x3D, 0x01);\r\n}\r\n}\r\nstatic void\r\nSiS_SetVCLKState(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short rrti)\r\n{\r\nunsigned short data = 0, VCLK = 0, index = 0;\r\nif (ModeNo > 0x13) {\r\nindex = SiS_Pr->SiS_RefIndex[rrti].Ext_CRTVCLK;\r\nVCLK = SiS_Pr->SiS_VCLKData[index].CLOCK;\r\n}\r\nif (VCLK >= 166)\r\ndata |= 0x0c;\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x32, 0xf3, data);\r\nif (VCLK >= 166)\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x1f, 0xe7);\r\ndata = 0x03;\r\nif (VCLK >= 260)\r\ndata = 0x00;\r\nelse if (VCLK >= 160)\r\ndata = 0x01;\r\nelse if (VCLK >= 135)\r\ndata = 0x02;\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x07, 0xF8, data);\r\n}\r\nstatic void\r\nSiS_SetCRT1ModeRegs(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short rrti)\r\n{\r\nunsigned short data, infoflag = 0, modeflag;\r\nif (ModeNo <= 0x13)\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nelse {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ninfoflag = SiS_Pr->SiS_RefIndex[rrti].Ext_InfoFlag;\r\n}\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x1F, 0x3F);\r\ndata = 0;\r\nif (ModeNo > 0x13) {\r\nif (SiS_Pr->SiS_ModeType > ModeEGA) {\r\ndata |= 0x02;\r\ndata |= ((SiS_Pr->SiS_ModeType - ModeVGA) << 2);\r\n}\r\nif (infoflag & InterlaceMode)\r\ndata |= 0x20;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x06, 0xC0, data);\r\ndata = 0;\r\nif (infoflag & InterlaceMode) {\r\nunsigned short hrs =\r\n(SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x04) |\r\n((SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0b) & 0xc0) << 2))\r\n- 3;\r\nunsigned short hto =\r\n(SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x00) |\r\n((SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0b) & 0x03) << 8))\r\n+ 5;\r\ndata = hrs - (hto >> 1) + 3;\r\n}\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x19, (data & 0xFF));\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3d4, 0x1a, 0xFC, (data >> 8));\r\nif (modeflag & HalfDCLK)\r\nSiS_SetRegOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x01, 0x08);\r\ndata = 0;\r\nif (modeflag & LineCompareOff)\r\ndata = 0x08;\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0F, 0xB7, data);\r\nif ((SiS_Pr->SiS_ModeType == ModeEGA) && (ModeNo > 0x13))\r\nSiS_SetRegOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x0F, 0x40);\r\nSiS_SetRegAND(SiS_Pr, SiS_Pr->SiS_P3c4, 0x31, 0xfb);\r\ndata = 0x60;\r\nif (SiS_Pr->SiS_ModeType != ModeText) {\r\ndata ^= 0x60;\r\nif (SiS_Pr->SiS_ModeType != ModeEGA)\r\ndata ^= 0xA0;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr, SiS_Pr->SiS_P3c4, 0x21, 0x1F, data);\r\nSiS_SetVCLKState(SiS_Pr, ModeNo, rrti);\r\nif (SiS_GetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x31) & 0x40)\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x52, 0x2c);\r\nelse\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x52, 0x6c);\r\n}\r\nstatic void\r\nSiS_WriteDAC(struct SiS_Private *SiS_Pr, unsigned long DACData,\r\nunsigned short shiftflag, unsigned short dl, unsigned short ah,\r\nunsigned short al, unsigned short dh)\r\n{\r\nunsigned short d1, d2, d3;\r\nswitch (dl) {\r\ncase 0:\r\nd1 = dh;\r\nd2 = ah;\r\nd3 = al;\r\nbreak;\r\ncase 1:\r\nd1 = ah;\r\nd2 = al;\r\nd3 = dh;\r\nbreak;\r\ndefault:\r\nd1 = al;\r\nd2 = dh;\r\nd3 = ah;\r\n}\r\nSiS_SetRegByte(SiS_Pr, DACData, (d1 << shiftflag));\r\nSiS_SetRegByte(SiS_Pr, DACData, (d2 << shiftflag));\r\nSiS_SetRegByte(SiS_Pr, DACData, (d3 << shiftflag));\r\n}\r\nstatic void\r\nSiS_LoadDAC(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short mi)\r\n{\r\nunsigned short data, data2, time, i, j, k, m, n, o;\r\nunsigned short si, di, bx, sf;\r\nunsigned long DACAddr, DACData;\r\nconst unsigned char *table = NULL;\r\nif (ModeNo < 0x13)\r\ndata = SiS_Pr->SiS_SModeIDTable[mi].St_ModeFlag;\r\nelse\r\ndata = SiS_Pr->SiS_EModeIDTable[mi].Ext_ModeFlag;\r\ndata &= DACInfoFlag;\r\nj = time = 64;\r\nif (data == 0x00)\r\ntable = SiS_MDA_DAC;\r\nelse if (data == 0x08)\r\ntable = SiS_CGA_DAC;\r\nelse if (data == 0x10)\r\ntable = SiS_EGA_DAC;\r\nelse {\r\nj = 16;\r\ntime = 256;\r\ntable = SiS_VGA_DAC;\r\n}\r\nDACAddr = SiS_Pr->SiS_P3c8;\r\nDACData = SiS_Pr->SiS_P3c9;\r\nsf = 0;\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c6, 0xFF);\r\nSiS_SetRegByte(SiS_Pr, DACAddr, 0x00);\r\nfor (i = 0; i < j; i++) {\r\ndata = table[i];\r\nfor (k = 0; k < 3; k++) {\r\ndata2 = 0;\r\nif (data & 0x01)\r\ndata2 += 0x2A;\r\nif (data & 0x02)\r\ndata2 += 0x15;\r\nSiS_SetRegByte(SiS_Pr, DACData, (data2 << sf));\r\ndata >>= 2;\r\n}\r\n}\r\nif (time == 256) {\r\nfor (i = 16; i < 32; i++) {\r\ndata = table[i] << sf;\r\nfor (k = 0; k < 3; k++)\r\nSiS_SetRegByte(SiS_Pr, DACData, data);\r\n}\r\nsi = 32;\r\nfor (m = 0; m < 9; m++) {\r\ndi = si;\r\nbx = si + 4;\r\nfor (n = 0; n < 3; n++) {\r\nfor (o = 0; o < 5; o++) {\r\nSiS_WriteDAC(SiS_Pr, DACData, sf, n,\r\ntable[di], table[bx],\r\ntable[si]);\r\nsi++;\r\n}\r\nsi -= 2;\r\nfor (o = 0; o < 3; o++) {\r\nSiS_WriteDAC(SiS_Pr, DACData, sf, n,\r\ntable[di], table[si],\r\ntable[bx]);\r\nsi--;\r\n}\r\n}\r\nsi += 5;\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT1Group(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex)\r\n{\r\nunsigned short StandTableIndex, rrti;\r\nSiS_Pr->SiS_CRT1Mode = ModeNo;\r\nif (ModeNo <= 0x13)\r\nStandTableIndex = 0;\r\nelse\r\nStandTableIndex = 1;\r\nSiS_ResetSegmentRegisters(SiS_Pr);\r\nSiS_SetSeqRegs(SiS_Pr, StandTableIndex);\r\nSiS_SetMiscRegs(SiS_Pr, StandTableIndex);\r\nSiS_SetCRTCRegs(SiS_Pr, StandTableIndex);\r\nSiS_SetATTRegs(SiS_Pr, StandTableIndex);\r\nSiS_SetGRCRegs(SiS_Pr, StandTableIndex);\r\nSiS_ClearExt1Regs(SiS_Pr, ModeNo);\r\nrrti = SiS_GetRatePtr(SiS_Pr, ModeNo, ModeIdIndex);\r\nif (rrti != 0xFFFF) {\r\nSiS_SetCRT1Sync(SiS_Pr, rrti);\r\nSiS_SetCRT1CRTC(SiS_Pr, ModeNo, ModeIdIndex, rrti);\r\nSiS_SetCRT1Offset(SiS_Pr, ModeNo, ModeIdIndex, rrti);\r\nSiS_SetCRT1VCLK(SiS_Pr, ModeNo, rrti);\r\n}\r\nSiS_SetCRT1FIFO_310(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_SetCRT1ModeRegs(SiS_Pr, ModeNo, ModeIdIndex, rrti);\r\nSiS_LoadDAC(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_DisplayOn(SiS_Pr);\r\n}\r\nint SiSUSBSetMode(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nunsigned short ModeIdIndex;\r\nunsigned long BaseAddr = SiS_Pr->IOAddress;\r\nSiSUSB_InitPtr(SiS_Pr);\r\nSiSUSBRegInit(SiS_Pr, BaseAddr);\r\nSiS_GetSysFlags(SiS_Pr);\r\nif (!(SiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex)))\r\nreturn 0;\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3c4, 0x05, 0x86);\r\nSiSInitPCIetc(SiS_Pr);\r\nModeNo &= 0x7f;\r\nSiS_Pr->SiS_ModeType =\r\nSiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag & ModeTypeMask;\r\nSiS_Pr->SiS_SetFlag = LowModeTests;\r\nSiS_SetCRT1Group(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_HandleCRT1(SiS_Pr);\r\nSiS_DisplayOn(SiS_Pr);\r\nSiS_SetRegByte(SiS_Pr, SiS_Pr->SiS_P3c6, 0xFF);\r\nSiS_SetReg(SiS_Pr, SiS_Pr->SiS_P3d4, 0x34, ModeNo);\r\nreturn 1;\r\n}\r\nint SiSUSBSetVESAMode(struct SiS_Private *SiS_Pr, unsigned short VModeNo)\r\n{\r\nunsigned short ModeNo = 0;\r\nint i;\r\nSiSUSB_InitPtr(SiS_Pr);\r\nif (VModeNo == 0x03) {\r\nModeNo = 0x03;\r\n} else {\r\ni = 0;\r\ndo {\r\nif (SiS_Pr->SiS_EModeIDTable[i].Ext_VESAID == VModeNo) {\r\nModeNo = SiS_Pr->SiS_EModeIDTable[i].Ext_ModeID;\r\nbreak;\r\n}\r\n} while (SiS_Pr->SiS_EModeIDTable[i++].Ext_ModeID != 0xff);\r\n}\r\nif (!ModeNo)\r\nreturn 0;\r\nreturn SiSUSBSetMode(SiS_Pr, ModeNo);\r\n}

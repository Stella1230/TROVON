static void ar9002_hw_rx_enable(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_CR, AR_CR_RXE);\r\n}\r\nstatic void ar9002_hw_set_desc_link(void *ds, u32 ds_link)\r\n{\r\n((struct ath_desc*) ds)->ds_link = ds_link;\r\n}\r\nstatic bool ar9002_hw_get_isr(struct ath_hw *ah, enum ath9k_int *masked,\r\nu32 *sync_cause_p)\r\n{\r\nu32 isr = 0;\r\nu32 mask2 = 0;\r\nstruct ath9k_hw_capabilities *pCap = &ah->caps;\r\nu32 sync_cause = 0;\r\nbool fatal_int = false;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif (!AR_SREV_9100(ah)) {\r\nif (REG_READ(ah, AR_INTR_ASYNC_CAUSE) & AR_INTR_MAC_IRQ) {\r\nif ((REG_READ(ah, AR_RTC_STATUS) & AR_RTC_STATUS_M)\r\n== AR_RTC_STATUS_ON) {\r\nisr = REG_READ(ah, AR_ISR);\r\n}\r\n}\r\nsync_cause = REG_READ(ah, AR_INTR_SYNC_CAUSE) &\r\nAR_INTR_SYNC_DEFAULT;\r\n*masked = 0;\r\nif (!isr && !sync_cause)\r\nreturn false;\r\n} else {\r\n*masked = 0;\r\nisr = REG_READ(ah, AR_ISR);\r\n}\r\nif (isr) {\r\nif (isr & AR_ISR_BCNMISC) {\r\nu32 isr2;\r\nisr2 = REG_READ(ah, AR_ISR_S2);\r\nif (isr2 & AR_ISR_S2_TIM)\r\nmask2 |= ATH9K_INT_TIM;\r\nif (isr2 & AR_ISR_S2_DTIM)\r\nmask2 |= ATH9K_INT_DTIM;\r\nif (isr2 & AR_ISR_S2_DTIMSYNC)\r\nmask2 |= ATH9K_INT_DTIMSYNC;\r\nif (isr2 & (AR_ISR_S2_CABEND))\r\nmask2 |= ATH9K_INT_CABEND;\r\nif (isr2 & AR_ISR_S2_GTT)\r\nmask2 |= ATH9K_INT_GTT;\r\nif (isr2 & AR_ISR_S2_CST)\r\nmask2 |= ATH9K_INT_CST;\r\nif (isr2 & AR_ISR_S2_TSFOOR)\r\nmask2 |= ATH9K_INT_TSFOOR;\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR_S2, isr2);\r\nisr &= ~AR_ISR_BCNMISC;\r\n}\r\n}\r\nif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)\r\nisr = REG_READ(ah, AR_ISR_RAC);\r\nif (isr == 0xffffffff) {\r\n*masked = 0;\r\nreturn false;\r\n}\r\n*masked = isr & ATH9K_INT_COMMON;\r\nif (isr & (AR_ISR_RXMINTR | AR_ISR_RXINTM |\r\nAR_ISR_RXOK | AR_ISR_RXERR))\r\n*masked |= ATH9K_INT_RX;\r\nif (isr &\r\n(AR_ISR_TXOK | AR_ISR_TXDESC | AR_ISR_TXERR |\r\nAR_ISR_TXEOL)) {\r\nu32 s0_s, s1_s;\r\n*masked |= ATH9K_INT_TX;\r\nif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED) {\r\ns0_s = REG_READ(ah, AR_ISR_S0_S);\r\ns1_s = REG_READ(ah, AR_ISR_S1_S);\r\n} else {\r\ns0_s = REG_READ(ah, AR_ISR_S0);\r\nREG_WRITE(ah, AR_ISR_S0, s0_s);\r\ns1_s = REG_READ(ah, AR_ISR_S1);\r\nREG_WRITE(ah, AR_ISR_S1, s1_s);\r\nisr &= ~(AR_ISR_TXOK |\r\nAR_ISR_TXDESC |\r\nAR_ISR_TXERR |\r\nAR_ISR_TXEOL);\r\n}\r\nah->intr_txqs |= MS(s0_s, AR_ISR_S0_QCU_TXOK);\r\nah->intr_txqs |= MS(s0_s, AR_ISR_S0_QCU_TXDESC);\r\nah->intr_txqs |= MS(s1_s, AR_ISR_S1_QCU_TXERR);\r\nah->intr_txqs |= MS(s1_s, AR_ISR_S1_QCU_TXEOL);\r\n}\r\nif (isr & AR_ISR_RXORN) {\r\nath_dbg(common, INTERRUPT,\r\n"receive FIFO overrun interrupt\n");\r\n}\r\n*masked |= mask2;\r\n}\r\nif (!AR_SREV_9100(ah) && (isr & AR_ISR_GENTMR)) {\r\nu32 s5_s;\r\nif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED) {\r\ns5_s = REG_READ(ah, AR_ISR_S5_S);\r\n} else {\r\ns5_s = REG_READ(ah, AR_ISR_S5);\r\n}\r\nah->intr_gen_timer_trigger =\r\nMS(s5_s, AR_ISR_S5_GENTIMER_TRIG);\r\nah->intr_gen_timer_thresh =\r\nMS(s5_s, AR_ISR_S5_GENTIMER_THRESH);\r\nif (ah->intr_gen_timer_trigger)\r\n*masked |= ATH9K_INT_GENTIMER;\r\nif ((s5_s & AR_ISR_S5_TIM_TIMER) &&\r\n!(pCap->hw_caps & ATH9K_HW_CAP_AUTOSLEEP))\r\n*masked |= ATH9K_INT_TIM_TIMER;\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR_S5, s5_s);\r\nisr &= ~AR_ISR_GENTMR;\r\n}\r\n}\r\nif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\r\nREG_WRITE(ah, AR_ISR, isr);\r\nREG_READ(ah, AR_ISR);\r\n}\r\nif (AR_SREV_9100(ah))\r\nreturn true;\r\nif (sync_cause) {\r\nif (sync_cause_p)\r\n*sync_cause_p = sync_cause;\r\nfatal_int =\r\n(sync_cause &\r\n(AR_INTR_SYNC_HOST1_FATAL | AR_INTR_SYNC_HOST1_PERR))\r\n? true : false;\r\nif (fatal_int) {\r\nif (sync_cause & AR_INTR_SYNC_HOST1_FATAL) {\r\nath_dbg(common, ANY,\r\n"received PCI FATAL interrupt\n");\r\n}\r\nif (sync_cause & AR_INTR_SYNC_HOST1_PERR) {\r\nath_dbg(common, ANY,\r\n"received PCI PERR interrupt\n");\r\n}\r\n*masked |= ATH9K_INT_FATAL;\r\n}\r\nif (sync_cause & AR_INTR_SYNC_RADM_CPL_TIMEOUT) {\r\nath_dbg(common, INTERRUPT,\r\n"AR_INTR_SYNC_RADM_CPL_TIMEOUT\n");\r\nREG_WRITE(ah, AR_RC, AR_RC_HOSTIF);\r\nREG_WRITE(ah, AR_RC, 0);\r\n*masked |= ATH9K_INT_FATAL;\r\n}\r\nif (sync_cause & AR_INTR_SYNC_LOCAL_TIMEOUT) {\r\nath_dbg(common, INTERRUPT,\r\n"AR_INTR_SYNC_LOCAL_TIMEOUT\n");\r\n}\r\nREG_WRITE(ah, AR_INTR_SYNC_CAUSE_CLR, sync_cause);\r\n(void) REG_READ(ah, AR_INTR_SYNC_CAUSE_CLR);\r\n}\r\nreturn true;\r\n}\r\nstatic void\r\nar9002_set_txdesc(struct ath_hw *ah, void *ds, struct ath_tx_info *i)\r\n{\r\nstruct ar5416_desc *ads = AR5416DESC(ds);\r\nu32 ctl1, ctl6;\r\nads->ds_txstatus0 = ads->ds_txstatus1 = 0;\r\nads->ds_txstatus2 = ads->ds_txstatus3 = 0;\r\nads->ds_txstatus4 = ads->ds_txstatus5 = 0;\r\nads->ds_txstatus6 = ads->ds_txstatus7 = 0;\r\nads->ds_txstatus8 = ads->ds_txstatus9 = 0;\r\nACCESS_ONCE(ads->ds_link) = i->link;\r\nACCESS_ONCE(ads->ds_data) = i->buf_addr[0];\r\nctl1 = i->buf_len[0] | (i->is_last ? 0 : AR_TxMore);\r\nctl6 = SM(i->keytype, AR_EncrType);\r\nif (AR_SREV_9285(ah)) {\r\nads->ds_ctl8 = 0;\r\nads->ds_ctl9 = 0;\r\nads->ds_ctl10 = 0;\r\nads->ds_ctl11 = 0;\r\n}\r\nif ((i->is_first || i->is_last) &&\r\ni->aggr != AGGR_BUF_MIDDLE && i->aggr != AGGR_BUF_LAST) {\r\nACCESS_ONCE(ads->ds_ctl2) = set11nTries(i->rates, 0)\r\n| set11nTries(i->rates, 1)\r\n| set11nTries(i->rates, 2)\r\n| set11nTries(i->rates, 3)\r\n| (i->dur_update ? AR_DurUpdateEna : 0)\r\n| SM(0, AR_BurstDur);\r\nACCESS_ONCE(ads->ds_ctl3) = set11nRate(i->rates, 0)\r\n| set11nRate(i->rates, 1)\r\n| set11nRate(i->rates, 2)\r\n| set11nRate(i->rates, 3);\r\n} else {\r\nACCESS_ONCE(ads->ds_ctl2) = 0;\r\nACCESS_ONCE(ads->ds_ctl3) = 0;\r\n}\r\nif (!i->is_first) {\r\nACCESS_ONCE(ads->ds_ctl0) = 0;\r\nACCESS_ONCE(ads->ds_ctl1) = ctl1;\r\nACCESS_ONCE(ads->ds_ctl6) = ctl6;\r\nreturn;\r\n}\r\nctl1 |= (i->keyix != ATH9K_TXKEYIX_INVALID ? SM(i->keyix, AR_DestIdx) : 0)\r\n| SM(i->type, AR_FrameType)\r\n| (i->flags & ATH9K_TXDESC_NOACK ? AR_NoAck : 0)\r\n| (i->flags & ATH9K_TXDESC_EXT_ONLY ? AR_ExtOnly : 0)\r\n| (i->flags & ATH9K_TXDESC_EXT_AND_CTL ? AR_ExtAndCtl : 0);\r\nswitch (i->aggr) {\r\ncase AGGR_BUF_FIRST:\r\nctl6 |= SM(i->aggr_len, AR_AggrLen);\r\ncase AGGR_BUF_MIDDLE:\r\nctl1 |= AR_IsAggr | AR_MoreAggr;\r\nctl6 |= SM(i->ndelim, AR_PadDelim);\r\nbreak;\r\ncase AGGR_BUF_LAST:\r\nctl1 |= AR_IsAggr;\r\nbreak;\r\ncase AGGR_BUF_NONE:\r\nbreak;\r\n}\r\nACCESS_ONCE(ads->ds_ctl0) = (i->pkt_len & AR_FrameLen)\r\n| (i->flags & ATH9K_TXDESC_VMF ? AR_VirtMoreFrag : 0)\r\n| SM(i->txpower[0], AR_XmitPower0)\r\n| (i->flags & ATH9K_TXDESC_VEOL ? AR_VEOL : 0)\r\n| (i->flags & ATH9K_TXDESC_INTREQ ? AR_TxIntrReq : 0)\r\n| (i->keyix != ATH9K_TXKEYIX_INVALID ? AR_DestIdxValid : 0)\r\n| (i->flags & ATH9K_TXDESC_CLRDMASK ? AR_ClrDestMask : 0)\r\n| (i->flags & ATH9K_TXDESC_RTSENA ? AR_RTSEnable :\r\n(i->flags & ATH9K_TXDESC_CTSENA ? AR_CTSEnable : 0));\r\nACCESS_ONCE(ads->ds_ctl1) = ctl1;\r\nACCESS_ONCE(ads->ds_ctl6) = ctl6;\r\nif (i->aggr == AGGR_BUF_MIDDLE || i->aggr == AGGR_BUF_LAST)\r\nreturn;\r\nACCESS_ONCE(ads->ds_ctl4) = set11nPktDurRTSCTS(i->rates, 0)\r\n| set11nPktDurRTSCTS(i->rates, 1);\r\nACCESS_ONCE(ads->ds_ctl5) = set11nPktDurRTSCTS(i->rates, 2)\r\n| set11nPktDurRTSCTS(i->rates, 3);\r\nACCESS_ONCE(ads->ds_ctl7) = set11nRateFlags(i->rates, 0)\r\n| set11nRateFlags(i->rates, 1)\r\n| set11nRateFlags(i->rates, 2)\r\n| set11nRateFlags(i->rates, 3)\r\n| SM(i->rtscts_rate, AR_RTSCTSRate);\r\nACCESS_ONCE(ads->ds_ctl9) = SM(i->txpower[1], AR_XmitPower1);\r\nACCESS_ONCE(ads->ds_ctl10) = SM(i->txpower[2], AR_XmitPower2);\r\nACCESS_ONCE(ads->ds_ctl11) = SM(i->txpower[3], AR_XmitPower3);\r\n}\r\nstatic int ar9002_hw_proc_txdesc(struct ath_hw *ah, void *ds,\r\nstruct ath_tx_status *ts)\r\n{\r\nstruct ar5416_desc *ads = AR5416DESC(ds);\r\nu32 status;\r\nstatus = ACCESS_ONCE(ads->ds_txstatus9);\r\nif ((status & AR_TxDone) == 0)\r\nreturn -EINPROGRESS;\r\nts->ts_tstamp = ads->AR_SendTimestamp;\r\nts->ts_status = 0;\r\nts->ts_flags = 0;\r\nif (status & AR_TxOpExceeded)\r\nts->ts_status |= ATH9K_TXERR_XTXOP;\r\nts->tid = MS(status, AR_TxTid);\r\nts->ts_rateindex = MS(status, AR_FinalTxIdx);\r\nts->ts_seqnum = MS(status, AR_SeqNum);\r\nstatus = ACCESS_ONCE(ads->ds_txstatus0);\r\nts->ts_rssi_ctl0 = MS(status, AR_TxRSSIAnt00);\r\nts->ts_rssi_ctl1 = MS(status, AR_TxRSSIAnt01);\r\nts->ts_rssi_ctl2 = MS(status, AR_TxRSSIAnt02);\r\nif (status & AR_TxBaStatus) {\r\nts->ts_flags |= ATH9K_TX_BA;\r\nts->ba_low = ads->AR_BaBitmapLow;\r\nts->ba_high = ads->AR_BaBitmapHigh;\r\n}\r\nstatus = ACCESS_ONCE(ads->ds_txstatus1);\r\nif (status & AR_FrmXmitOK)\r\nts->ts_status |= ATH9K_TX_ACKED;\r\nelse {\r\nif (status & AR_ExcessiveRetries)\r\nts->ts_status |= ATH9K_TXERR_XRETRY;\r\nif (status & AR_Filtered)\r\nts->ts_status |= ATH9K_TXERR_FILT;\r\nif (status & AR_FIFOUnderrun) {\r\nts->ts_status |= ATH9K_TXERR_FIFO;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\n}\r\nif (status & AR_TxTimerExpired)\r\nts->ts_status |= ATH9K_TXERR_TIMER_EXPIRED;\r\nif (status & AR_DescCfgErr)\r\nts->ts_flags |= ATH9K_TX_DESC_CFG_ERR;\r\nif (status & AR_TxDataUnderrun) {\r\nts->ts_flags |= ATH9K_TX_DATA_UNDERRUN;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\nif (status & AR_TxDelimUnderrun) {\r\nts->ts_flags |= ATH9K_TX_DELIM_UNDERRUN;\r\nath9k_hw_updatetxtriglevel(ah, true);\r\n}\r\nts->ts_shortretry = MS(status, AR_RTSFailCnt);\r\nts->ts_longretry = MS(status, AR_DataFailCnt);\r\nts->ts_virtcol = MS(status, AR_VirtRetryCnt);\r\nstatus = ACCESS_ONCE(ads->ds_txstatus5);\r\nts->ts_rssi = MS(status, AR_TxRSSICombined);\r\nts->ts_rssi_ext0 = MS(status, AR_TxRSSIAnt10);\r\nts->ts_rssi_ext1 = MS(status, AR_TxRSSIAnt11);\r\nts->ts_rssi_ext2 = MS(status, AR_TxRSSIAnt12);\r\nts->evm0 = ads->AR_TxEVM0;\r\nts->evm1 = ads->AR_TxEVM1;\r\nts->evm2 = ads->AR_TxEVM2;\r\nreturn 0;\r\n}\r\nstatic int ar9002_hw_get_duration(struct ath_hw *ah, const void *ds, int index)\r\n{\r\nstruct ar5416_desc *ads = AR5416DESC(ds);\r\nswitch (index) {\r\ncase 0:\r\nreturn MS(ACCESS_ONCE(ads->ds_ctl4), AR_PacketDur0);\r\ncase 1:\r\nreturn MS(ACCESS_ONCE(ads->ds_ctl4), AR_PacketDur1);\r\ncase 2:\r\nreturn MS(ACCESS_ONCE(ads->ds_ctl5), AR_PacketDur2);\r\ncase 3:\r\nreturn MS(ACCESS_ONCE(ads->ds_ctl5), AR_PacketDur3);\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\nvoid ath9k_hw_setuprxdesc(struct ath_hw *ah, struct ath_desc *ds,\r\nu32 size, u32 flags)\r\n{\r\nstruct ar5416_desc *ads = AR5416DESC(ds);\r\nads->ds_ctl1 = size & AR_BufLen;\r\nif (flags & ATH9K_RXDESC_INTREQ)\r\nads->ds_ctl1 |= AR_RxIntrReq;\r\nmemset(&ads->u.rx, 0, sizeof(ads->u.rx));\r\n}\r\nvoid ar9002_hw_attach_mac_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\r\nops->rx_enable = ar9002_hw_rx_enable;\r\nops->set_desc_link = ar9002_hw_set_desc_link;\r\nops->get_isr = ar9002_hw_get_isr;\r\nops->set_txdesc = ar9002_set_txdesc;\r\nops->proc_txdesc = ar9002_hw_proc_txdesc;\r\nops->get_duration = ar9002_hw_get_duration;\r\n}

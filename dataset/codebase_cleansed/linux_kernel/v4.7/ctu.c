static void rsnd_ctu_activation(struct rsnd_mod *mod)\r\n{\r\nrsnd_mod_write(mod, CTU_SWRSR, 0);\r\nrsnd_mod_write(mod, CTU_SWRSR, 1);\r\n}\r\nstatic void rsnd_ctu_halt(struct rsnd_mod *mod)\r\n{\r\nrsnd_mod_write(mod, CTU_CTUIR, 1);\r\nrsnd_mod_write(mod, CTU_SWRSR, 0);\r\n}\r\nint rsnd_ctu_converted_channel(struct rsnd_mod *mod)\r\n{\r\nstruct rsnd_ctu *ctu = rsnd_mod_to_ctu(mod);\r\nreturn ctu->channels;\r\n}\r\nstatic int rsnd_ctu_probe_(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nreturn rsnd_cmd_attach(io, rsnd_mod_id(mod) / 4);\r\n}\r\nstatic void rsnd_ctu_value_init(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_ctu *ctu = rsnd_mod_to_ctu(mod);\r\nu32 cpmdr = 0;\r\nu32 scmdr = 0;\r\nint i;\r\nfor (i = 0; i < RSND_MAX_CHANNELS; i++) {\r\nu32 val = ctu->pass.val[i];\r\ncpmdr |= val << (28 - (i * 4));\r\nif ((val > 0x8) && (scmdr < (val - 0x8)))\r\nscmdr = val - 0x8;\r\n}\r\nrsnd_mod_write(mod, CTU_CTUIR, 1);\r\nrsnd_mod_write(mod, CTU_ADINR, rsnd_runtime_channel_original(io));\r\nrsnd_mod_write(mod, CTU_CPMDR, cpmdr);\r\nrsnd_mod_write(mod, CTU_SCMDR, scmdr);\r\nif (scmdr > 0) {\r\nrsnd_mod_write(mod, CTU_SV00R, ctu->sv0.val[0]);\r\nrsnd_mod_write(mod, CTU_SV01R, ctu->sv0.val[1]);\r\nrsnd_mod_write(mod, CTU_SV02R, ctu->sv0.val[2]);\r\nrsnd_mod_write(mod, CTU_SV03R, ctu->sv0.val[3]);\r\nrsnd_mod_write(mod, CTU_SV04R, ctu->sv0.val[4]);\r\nrsnd_mod_write(mod, CTU_SV05R, ctu->sv0.val[5]);\r\nrsnd_mod_write(mod, CTU_SV06R, ctu->sv0.val[6]);\r\nrsnd_mod_write(mod, CTU_SV07R, ctu->sv0.val[7]);\r\n}\r\nif (scmdr > 1) {\r\nrsnd_mod_write(mod, CTU_SV10R, ctu->sv1.val[0]);\r\nrsnd_mod_write(mod, CTU_SV11R, ctu->sv1.val[1]);\r\nrsnd_mod_write(mod, CTU_SV12R, ctu->sv1.val[2]);\r\nrsnd_mod_write(mod, CTU_SV13R, ctu->sv1.val[3]);\r\nrsnd_mod_write(mod, CTU_SV14R, ctu->sv1.val[4]);\r\nrsnd_mod_write(mod, CTU_SV15R, ctu->sv1.val[5]);\r\nrsnd_mod_write(mod, CTU_SV16R, ctu->sv1.val[6]);\r\nrsnd_mod_write(mod, CTU_SV17R, ctu->sv1.val[7]);\r\n}\r\nif (scmdr > 2) {\r\nrsnd_mod_write(mod, CTU_SV20R, ctu->sv2.val[0]);\r\nrsnd_mod_write(mod, CTU_SV21R, ctu->sv2.val[1]);\r\nrsnd_mod_write(mod, CTU_SV22R, ctu->sv2.val[2]);\r\nrsnd_mod_write(mod, CTU_SV23R, ctu->sv2.val[3]);\r\nrsnd_mod_write(mod, CTU_SV24R, ctu->sv2.val[4]);\r\nrsnd_mod_write(mod, CTU_SV25R, ctu->sv2.val[5]);\r\nrsnd_mod_write(mod, CTU_SV26R, ctu->sv2.val[6]);\r\nrsnd_mod_write(mod, CTU_SV27R, ctu->sv2.val[7]);\r\n}\r\nif (scmdr > 3) {\r\nrsnd_mod_write(mod, CTU_SV30R, ctu->sv3.val[0]);\r\nrsnd_mod_write(mod, CTU_SV31R, ctu->sv3.val[1]);\r\nrsnd_mod_write(mod, CTU_SV32R, ctu->sv3.val[2]);\r\nrsnd_mod_write(mod, CTU_SV33R, ctu->sv3.val[3]);\r\nrsnd_mod_write(mod, CTU_SV34R, ctu->sv3.val[4]);\r\nrsnd_mod_write(mod, CTU_SV35R, ctu->sv3.val[5]);\r\nrsnd_mod_write(mod, CTU_SV36R, ctu->sv3.val[6]);\r\nrsnd_mod_write(mod, CTU_SV37R, ctu->sv3.val[7]);\r\n}\r\nrsnd_mod_write(mod, CTU_CTUIR, 0);\r\n}\r\nstatic void rsnd_ctu_value_reset(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_ctu *ctu = rsnd_mod_to_ctu(mod);\r\nint i;\r\nif (!ctu->reset.val)\r\nreturn;\r\nfor (i = 0; i < RSND_MAX_CHANNELS; i++) {\r\nctu->pass.val[i] = 0;\r\nctu->sv0.val[i] = 0;\r\nctu->sv1.val[i] = 0;\r\nctu->sv2.val[i] = 0;\r\nctu->sv3.val[i] = 0;\r\n}\r\nctu->reset.val = 0;\r\n}\r\nstatic int rsnd_ctu_init(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nrsnd_mod_power_on(mod);\r\nrsnd_ctu_activation(mod);\r\nrsnd_ctu_value_init(io, mod);\r\nreturn 0;\r\n}\r\nstatic int rsnd_ctu_quit(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nrsnd_ctu_halt(mod);\r\nrsnd_mod_power_off(mod);\r\nreturn 0;\r\n}\r\nstatic int rsnd_ctu_hw_params(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *fe_params)\r\n{\r\nstruct rsnd_ctu *ctu = rsnd_mod_to_ctu(mod);\r\nstruct snd_soc_pcm_runtime *fe = substream->private_data;\r\nctu->channels = 0;\r\nif (fe->dai_link->dynamic) {\r\nstruct rsnd_priv *priv = rsnd_mod_to_priv(mod);\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct snd_soc_dpcm *dpcm;\r\nstruct snd_pcm_hw_params *be_params;\r\nint stream = substream->stream;\r\nlist_for_each_entry(dpcm, &fe->dpcm[stream].be_clients, list_be) {\r\nbe_params = &dpcm->hw_params;\r\nif (params_channels(fe_params) != params_channels(be_params))\r\nctu->channels = params_channels(be_params);\r\n}\r\ndev_dbg(dev, "CTU convert channels %d\n", ctu->channels);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rsnd_ctu_pcm_new(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct rsnd_ctu *ctu = rsnd_mod_to_ctu(mod);\r\nint ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd, "CTU Pass",\r\nNULL,\r\n&ctu->pass, RSND_MAX_CHANNELS,\r\n0xC);\r\nret = rsnd_kctrl_new_m(mod, io, rtd, "CTU SV0",\r\nNULL,\r\n&ctu->sv0, RSND_MAX_CHANNELS,\r\n0x00FFFFFF);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd, "CTU SV1",\r\nNULL,\r\n&ctu->sv1, RSND_MAX_CHANNELS,\r\n0x00FFFFFF);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd, "CTU SV2",\r\nNULL,\r\n&ctu->sv2, RSND_MAX_CHANNELS,\r\n0x00FFFFFF);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd, "CTU SV3",\r\nNULL,\r\n&ctu->sv3, RSND_MAX_CHANNELS,\r\n0x00FFFFFF);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_s(mod, io, rtd, "CTU Reset",\r\nrsnd_ctu_value_reset,\r\n&ctu->reset, 1);\r\nreturn ret;\r\n}\r\nstruct rsnd_mod *rsnd_ctu_mod_get(struct rsnd_priv *priv, int id)\r\n{\r\nif (WARN_ON(id < 0 || id >= rsnd_ctu_nr(priv)))\r\nid = 0;\r\nreturn rsnd_mod_get(rsnd_ctu_get(priv, id));\r\n}\r\nint rsnd_ctu_probe(struct rsnd_priv *priv)\r\n{\r\nstruct device_node *node;\r\nstruct device_node *np;\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_ctu *ctu;\r\nstruct clk *clk;\r\nchar name[CTU_NAME_SIZE];\r\nint i, nr, ret;\r\nif (rsnd_is_gen1(priv))\r\nreturn 0;\r\nnode = rsnd_ctu_of_node(priv);\r\nif (!node)\r\nreturn 0;\r\nnr = of_get_child_count(node);\r\nif (!nr) {\r\nret = -EINVAL;\r\ngoto rsnd_ctu_probe_done;\r\n}\r\nctu = devm_kzalloc(dev, sizeof(*ctu) * nr, GFP_KERNEL);\r\nif (!ctu) {\r\nret = -ENOMEM;\r\ngoto rsnd_ctu_probe_done;\r\n}\r\npriv->ctu_nr = nr;\r\npriv->ctu = ctu;\r\ni = 0;\r\nret = 0;\r\nfor_each_child_of_node(node, np) {\r\nctu = rsnd_ctu_get(priv, i);\r\nsnprintf(name, CTU_NAME_SIZE, "%s.%d",\r\nCTU_NAME, i / 4);\r\nclk = devm_clk_get(dev, name);\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto rsnd_ctu_probe_done;\r\n}\r\nret = rsnd_mod_init(priv, rsnd_mod_get(ctu), &rsnd_ctu_ops,\r\nclk, rsnd_mod_get_status, RSND_MOD_CTU, i);\r\nif (ret)\r\ngoto rsnd_ctu_probe_done;\r\ni++;\r\n}\r\nrsnd_ctu_probe_done:\r\nof_node_put(node);\r\nreturn ret;\r\n}\r\nvoid rsnd_ctu_remove(struct rsnd_priv *priv)\r\n{\r\nstruct rsnd_ctu *ctu;\r\nint i;\r\nfor_each_rsnd_ctu(ctu, priv, i) {\r\nrsnd_mod_quit(rsnd_mod_get(ctu));\r\n}\r\n}

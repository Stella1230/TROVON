struct cflayer *cfvei_create(u8 channel_id, struct dev_info *dev_info)\r\n{\r\nstruct cfsrvl *vei = kzalloc(sizeof(struct cfsrvl), GFP_ATOMIC);\r\nif (!vei)\r\nreturn NULL;\r\ncaif_assert(offsetof(struct cfsrvl, layer) == 0);\r\ncfsrvl_init(vei, channel_id, dev_info, true);\r\nvei->layer.receive = cfvei_receive;\r\nvei->layer.transmit = cfvei_transmit;\r\nsnprintf(vei->layer.name, CAIF_LAYER_NAME_SZ - 1, "vei%d", channel_id);\r\nreturn &vei->layer;\r\n}\r\nstatic int cfvei_receive(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 cmd;\r\nint ret;\r\ncaif_assert(layr->up != NULL);\r\ncaif_assert(layr->receive != NULL);\r\ncaif_assert(layr->ctrlcmd != NULL);\r\nif (cfpkt_extr_head(pkt, &cmd, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\nswitch (cmd) {\r\ncase VEI_PAYLOAD:\r\nret = layr->up->receive(layr->up, pkt);\r\nreturn ret;\r\ncase VEI_FLOW_OFF:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_OFF_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ncase VEI_FLOW_ON:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_ON_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ncase VEI_SET_PIN:\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ndefault:\r\npr_warn("Unknown VEI control packet %d (0x%x)!\n", cmd, cmd);\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\n}\r\nstatic int cfvei_transmit(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 tmp = 0;\r\nstruct caif_payload_info *info;\r\nint ret;\r\nstruct cfsrvl *service = container_obj(layr);\r\nif (!cfsrvl_ready(service, &ret))\r\ngoto err;\r\ncaif_assert(layr->dn != NULL);\r\ncaif_assert(layr->dn->transmit != NULL);\r\nif (cfpkt_add_head(pkt, &tmp, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\nret = -EPROTO;\r\ngoto err;\r\n}\r\ninfo = cfpkt_info(pkt);\r\ninfo->channel_id = service->layer.id;\r\ninfo->hdr_len = 1;\r\ninfo->dev_info = &service->dev_info;\r\nreturn layr->dn->transmit(layr->dn, pkt);\r\nerr:\r\ncfpkt_destroy(pkt);\r\nreturn ret;\r\n}

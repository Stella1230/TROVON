static unsigned int labpc_suggest_transfer_size(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nunsigned int maxbytes)\r\n{\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nunsigned int sample_size = comedi_bytes_per_sample(s);\r\nunsigned int size;\r\nunsigned int freq;\r\nif (cmd->convert_src == TRIG_TIMER)\r\nfreq = 1000000000 / cmd->convert_arg;\r\nelse\r\nfreq = 0xffffffff;\r\nsize = (freq / 3) * sample_size;\r\nif (size > maxbytes)\r\nsize = maxbytes;\r\nelse if (size < sample_size)\r\nsize = sample_size;\r\nreturn size;\r\n}\r\nvoid labpc_setup_dma(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nstruct labpc_private *devpriv = dev->private;\r\nstruct comedi_isadma_desc *desc = &devpriv->dma->desc[0];\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nunsigned int sample_size = comedi_bytes_per_sample(s);\r\ndesc->size = labpc_suggest_transfer_size(dev, s, desc->maxsize);\r\nif (cmd->stop_src == TRIG_COUNT &&\r\ndevpriv->count * sample_size < desc->size)\r\ndesc->size = devpriv->count * sample_size;\r\ncomedi_isadma_program(desc);\r\ndevpriv->cmd3 |= (CMD3_DMAEN | CMD3_DMATCINTEN);\r\n}\r\nvoid labpc_drain_dma(struct comedi_device *dev)\r\n{\r\nstruct labpc_private *devpriv = dev->private;\r\nstruct comedi_isadma_desc *desc = &devpriv->dma->desc[0];\r\nstruct comedi_subdevice *s = dev->read_subdev;\r\nstruct comedi_async *async = s->async;\r\nstruct comedi_cmd *cmd = &async->cmd;\r\nunsigned int max_samples = comedi_bytes_to_samples(s, desc->size);\r\nunsigned int residue;\r\nunsigned int nsamples;\r\nunsigned int leftover;\r\nresidue = comedi_isadma_disable(desc->chan);\r\nnsamples = max_samples - comedi_bytes_to_samples(s, residue);\r\nif (cmd->stop_src == TRIG_COUNT) {\r\nif (devpriv->count <= nsamples) {\r\nnsamples = devpriv->count;\r\nleftover = 0;\r\n} else {\r\nleftover = devpriv->count - nsamples;\r\nif (leftover > max_samples)\r\nleftover = max_samples;\r\n}\r\ndevpriv->count -= nsamples;\r\n} else {\r\nleftover = max_samples;\r\n}\r\ndesc->size = comedi_samples_to_bytes(s, leftover);\r\ncomedi_buf_write_samples(s, desc->virt_addr, nsamples);\r\n}\r\nstatic void handle_isa_dma(struct comedi_device *dev)\r\n{\r\nstruct labpc_private *devpriv = dev->private;\r\nstruct comedi_isadma_desc *desc = &devpriv->dma->desc[0];\r\nlabpc_drain_dma(dev);\r\nif (desc->size)\r\ncomedi_isadma_program(desc);\r\ndevpriv->write_byte(dev, 0x1, DMATC_CLEAR_REG);\r\n}\r\nvoid labpc_handle_dma_status(struct comedi_device *dev)\r\n{\r\nconst struct labpc_boardinfo *board = dev->board_ptr;\r\nstruct labpc_private *devpriv = dev->private;\r\nif (devpriv->stat1 & STAT1_GATA0 ||\r\n(board->is_labpc1200 && devpriv->stat2 & STAT2_OUTA1))\r\nhandle_isa_dma(dev);\r\n}\r\nvoid labpc_init_dma_chan(struct comedi_device *dev, unsigned int dma_chan)\r\n{\r\nstruct labpc_private *devpriv = dev->private;\r\nif (dma_chan != 1 && dma_chan != 3)\r\nreturn;\r\ndevpriv->dma = comedi_isadma_alloc(dev, 1, dma_chan, dma_chan,\r\nLABPC_ISADMA_BUFFER_SIZE,\r\nCOMEDI_ISADMA_READ);\r\n}\r\nvoid labpc_free_dma_chan(struct comedi_device *dev)\r\n{\r\nstruct labpc_private *devpriv = dev->private;\r\nif (devpriv)\r\ncomedi_isadma_free(devpriv->dma);\r\n}\r\nstatic int __init ni_labpc_isadma_init_module(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit ni_labpc_isadma_cleanup_module(void)\r\n{\r\n}

int register_pppox_proto(int proto_num, const struct pppox_proto *pp)\r\n{\r\nif (proto_num < 0 || proto_num > PX_MAX_PROTO)\r\nreturn -EINVAL;\r\nif (pppox_protos[proto_num])\r\nreturn -EALREADY;\r\npppox_protos[proto_num] = pp;\r\nreturn 0;\r\n}\r\nvoid unregister_pppox_proto(int proto_num)\r\n{\r\nif (proto_num >= 0 && proto_num <= PX_MAX_PROTO)\r\npppox_protos[proto_num] = NULL;\r\n}\r\nvoid pppox_unbind_sock(struct sock *sk)\r\n{\r\nif (sk->sk_state & (PPPOX_BOUND | PPPOX_CONNECTED)) {\r\nppp_unregister_channel(&pppox_sk(sk)->chan);\r\nsk->sk_state = PPPOX_DEAD;\r\n}\r\n}\r\nint pppox_ioctl(struct socket *sock, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nint rc;\r\nlock_sock(sk);\r\nswitch (cmd) {\r\ncase PPPIOCGCHAN: {\r\nint index;\r\nrc = -ENOTCONN;\r\nif (!(sk->sk_state & PPPOX_CONNECTED))\r\nbreak;\r\nrc = -EINVAL;\r\nindex = ppp_channel_index(&po->chan);\r\nif (put_user(index , (int __user *) arg))\r\nbreak;\r\nrc = 0;\r\nsk->sk_state |= PPPOX_BOUND;\r\nbreak;\r\n}\r\ndefault:\r\nrc = pppox_protos[sk->sk_protocol]->ioctl ?\r\npppox_protos[sk->sk_protocol]->ioctl(sock, cmd, arg) : -ENOTTY;\r\n}\r\nrelease_sock(sk);\r\nreturn rc;\r\n}\r\nstatic int pppox_create(struct net *net, struct socket *sock, int protocol,\r\nint kern)\r\n{\r\nint rc = -EPROTOTYPE;\r\nif (protocol < 0 || protocol > PX_MAX_PROTO)\r\ngoto out;\r\nrc = -EPROTONOSUPPORT;\r\nif (!pppox_protos[protocol])\r\nrequest_module("net-pf-%d-proto-%d", PF_PPPOX, protocol);\r\nif (!pppox_protos[protocol] ||\r\n!try_module_get(pppox_protos[protocol]->owner))\r\ngoto out;\r\nrc = pppox_protos[protocol]->create(net, sock, kern);\r\nmodule_put(pppox_protos[protocol]->owner);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int __init pppox_init(void)\r\n{\r\nreturn sock_register(&pppox_proto_family);\r\n}\r\nstatic void __exit pppox_exit(void)\r\n{\r\nsock_unregister(PF_PPPOX);\r\n}

static irqreturn_t snd_sb8_interrupt(int irq, void *dev_id)\r\n{\r\nstruct snd_sb *chip = dev_id;\r\nif (chip->open & SB_OPEN_PCM) {\r\nreturn snd_sb8dsp_interrupt(chip);\r\n} else {\r\nreturn snd_sb8dsp_midi_interrupt(chip);\r\n}\r\n}\r\nstatic void snd_sb8_free(struct snd_card *card)\r\n{\r\nstruct snd_sb8 *acard = card->private_data;\r\nif (acard == NULL)\r\nreturn;\r\nrelease_and_free_resource(acard->fm_res);\r\n}\r\nstatic int snd_sb8_match(struct device *pdev, unsigned int dev)\r\n{\r\nif (!enable[dev])\r\nreturn 0;\r\nif (irq[dev] == SNDRV_AUTO_IRQ) {\r\ndev_err(pdev, "please specify irq\n");\r\nreturn 0;\r\n}\r\nif (dma8[dev] == SNDRV_AUTO_DMA) {\r\ndev_err(pdev, "please specify dma8\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int snd_sb8_probe(struct device *pdev, unsigned int dev)\r\n{\r\nstruct snd_sb *chip;\r\nstruct snd_card *card;\r\nstruct snd_sb8 *acard;\r\nstruct snd_opl3 *opl3;\r\nint err;\r\nerr = snd_card_new(pdev, index[dev], id[dev], THIS_MODULE,\r\nsizeof(struct snd_sb8), &card);\r\nif (err < 0)\r\nreturn err;\r\nacard = card->private_data;\r\ncard->private_free = snd_sb8_free;\r\nacard->fm_res = request_region(0x388, 4, "SoundBlaster FM");\r\nif (port[dev] != SNDRV_AUTO_PORT) {\r\nif ((err = snd_sbdsp_create(card, port[dev], irq[dev],\r\nsnd_sb8_interrupt,\r\ndma8[dev],\r\n-1,\r\nSB_HW_AUTO,\r\n&chip)) < 0)\r\ngoto _err;\r\n} else {\r\nstatic unsigned long possible_ports[] = {\r\n0x220, 0x240, 0x260,\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(possible_ports); i++) {\r\nerr = snd_sbdsp_create(card, possible_ports[i],\r\nirq[dev],\r\nsnd_sb8_interrupt,\r\ndma8[dev],\r\n-1,\r\nSB_HW_AUTO,\r\n&chip);\r\nif (err >= 0) {\r\nport[dev] = possible_ports[i];\r\nbreak;\r\n}\r\n}\r\nif (i >= ARRAY_SIZE(possible_ports)) {\r\nerr = -EINVAL;\r\ngoto _err;\r\n}\r\n}\r\nacard->chip = chip;\r\nif (chip->hardware >= SB_HW_16) {\r\nif (chip->hardware == SB_HW_ALS100)\r\nsnd_printk(KERN_WARNING "ALS100 chip detected at 0x%lx, try snd-als100 module\n",\r\nport[dev]);\r\nelse\r\nsnd_printk(KERN_WARNING "SB 16 chip detected at 0x%lx, try snd-sb16 module\n",\r\nport[dev]);\r\nerr = -ENODEV;\r\ngoto _err;\r\n}\r\nif ((err = snd_sb8dsp_pcm(chip, 0)) < 0)\r\ngoto _err;\r\nif ((err = snd_sbmixer_new(chip)) < 0)\r\ngoto _err;\r\nif (chip->hardware == SB_HW_10 || chip->hardware == SB_HW_20) {\r\nif ((err = snd_opl3_create(card, chip->port + 8, 0,\r\nOPL3_HW_AUTO, 1,\r\n&opl3)) < 0) {\r\nsnd_printk(KERN_WARNING "sb8: no OPL device at 0x%lx\n", chip->port + 8);\r\n}\r\n} else {\r\nif ((err = snd_opl3_create(card, chip->port, chip->port + 2,\r\nOPL3_HW_AUTO, 1,\r\n&opl3)) < 0) {\r\nsnd_printk(KERN_WARNING "sb8: no OPL device at 0x%lx-0x%lx\n",\r\nchip->port, chip->port + 2);\r\n}\r\n}\r\nif (err >= 0) {\r\nif ((err = snd_opl3_hwdep_new(opl3, 0, 1, NULL)) < 0)\r\ngoto _err;\r\n}\r\nif ((err = snd_sb8dsp_midi(chip, 0)) < 0)\r\ngoto _err;\r\nstrcpy(card->driver, chip->hardware == SB_HW_PRO ? "SB Pro" : "SB8");\r\nstrcpy(card->shortname, chip->name);\r\nsprintf(card->longname, "%s at 0x%lx, irq %d, dma %d",\r\nchip->name,\r\nchip->port,\r\nirq[dev], dma8[dev]);\r\nif ((err = snd_card_register(card)) < 0)\r\ngoto _err;\r\ndev_set_drvdata(pdev, card);\r\nreturn 0;\r\n_err:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int snd_sb8_remove(struct device *pdev, unsigned int dev)\r\n{\r\nsnd_card_free(dev_get_drvdata(pdev));\r\nreturn 0;\r\n}\r\nstatic int snd_sb8_suspend(struct device *dev, unsigned int n,\r\npm_message_t state)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_sb8 *acard = card->private_data;\r\nstruct snd_sb *chip = acard->chip;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nsnd_pcm_suspend_all(chip->pcm);\r\nsnd_sbmixer_suspend(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_sb8_resume(struct device *dev, unsigned int n)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_sb8 *acard = card->private_data;\r\nstruct snd_sb *chip = acard->chip;\r\nsnd_sbdsp_reset(chip);\r\nsnd_sbmixer_resume(chip);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}\r\nstatic int __init alsa_card_sb8_init(void)\r\n{\r\nreturn isa_register_driver(&snd_sb8_driver, SNDRV_CARDS);\r\n}\r\nstatic void __exit alsa_card_sb8_exit(void)\r\n{\r\nisa_unregister_driver(&snd_sb8_driver);\r\n}

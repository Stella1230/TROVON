static int sg2_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nskt->stat[SOC_STAT_CD].gpio = SG2_S0_GPIO_DETECT;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA0 CD";\r\nskt->stat[SOC_STAT_RDY].gpio = SG2_S0_GPIO_READY;\r\nskt->stat[SOC_STAT_RDY].name = "PCMCIA0 RDY";\r\nreturn 0;\r\n}\r\nstatic void sg2_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nstate->bvd1 = 0;\r\nstate->bvd2 = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int sg2_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nswitch (state->Vcc) {\r\ncase 0:\r\ngpio_set_value(SG2_S0_POWER_CTL, 1);\r\nbreak;\r\ncase 33:\r\ncase 50:\r\ngpio_set_value(SG2_S0_POWER_CTL, 0);\r\nmsleep(100);\r\nbreak;\r\ndefault:\r\npr_err("%s(): bad Vcc %u\n",\r\n__func__, state->Vcc);\r\nreturn -1;\r\n}\r\ngpio_set_value(SG2_S0_GPIO_RESET, !!(state->flags & SS_RESET));\r\nreturn 0;\r\n}\r\nstatic int __init sg2_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_stargate2())\r\nreturn -ENODEV;\r\nsg2_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!sg2_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = gpio_request_array(sg2_pcmcia_gpios, ARRAY_SIZE(sg2_pcmcia_gpios));\r\nif (ret)\r\ngoto error_put_platform_device;\r\nret = platform_device_add_data(sg2_pcmcia_device,\r\n&sg2_pcmcia_ops,\r\nsizeof(sg2_pcmcia_ops));\r\nif (ret)\r\ngoto error_free_gpios;\r\nret = platform_device_add(sg2_pcmcia_device);\r\nif (ret)\r\ngoto error_free_gpios;\r\nreturn 0;\r\nerror_free_gpios:\r\ngpio_free_array(sg2_pcmcia_gpios, ARRAY_SIZE(sg2_pcmcia_gpios));\r\nerror_put_platform_device:\r\nplatform_device_put(sg2_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit sg2_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(sg2_pcmcia_device);\r\ngpio_free_array(sg2_pcmcia_gpios, ARRAY_SIZE(sg2_pcmcia_gpios));\r\n}

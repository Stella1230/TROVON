static int rockchip_fbdev_mmap(struct fb_info *info,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct drm_fb_helper *helper = info->par;\r\nstruct rockchip_drm_private *private = to_drm_private(helper);\r\nreturn rockchip_gem_mmap_buf(private->fbdev_bo, vma);\r\n}\r\nstatic int rockchip_drm_fbdev_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct rockchip_drm_private *private = to_drm_private(helper);\r\nstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\r\nstruct drm_device *dev = helper->dev;\r\nstruct rockchip_gem_object *rk_obj;\r\nstruct drm_framebuffer *fb;\r\nunsigned int bytes_per_pixel;\r\nunsigned long offset;\r\nstruct fb_info *fbi;\r\nsize_t size;\r\nint ret;\r\nbytes_per_pixel = DIV_ROUND_UP(sizes->surface_bpp, 8);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = sizes->surface_width * bytes_per_pixel;\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nrk_obj = rockchip_gem_create_object(dev, size, true);\r\nif (IS_ERR(rk_obj))\r\nreturn -ENOMEM;\r\nprivate->fbdev_bo = &rk_obj->base;\r\nfbi = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(fbi)) {\r\ndev_err(dev->dev, "Failed to create framebuffer info.\n");\r\nret = PTR_ERR(fbi);\r\ngoto err_rockchip_gem_free_object;\r\n}\r\nhelper->fb = rockchip_drm_framebuffer_init(dev, &mode_cmd,\r\nprivate->fbdev_bo);\r\nif (IS_ERR(helper->fb)) {\r\ndev_err(dev->dev, "Failed to allocate DRM framebuffer.\n");\r\nret = PTR_ERR(helper->fb);\r\ngoto err_release_fbi;\r\n}\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_FLAG_DEFAULT;\r\nfbi->fbops = &rockchip_drm_fbdev_ops;\r\nfb = helper->fb;\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, sizes->fb_width, sizes->fb_height);\r\noffset = fbi->var.xoffset * bytes_per_pixel;\r\noffset += fbi->var.yoffset * fb->pitches[0];\r\ndev->mode_config.fb_base = 0;\r\nfbi->screen_base = rk_obj->kvaddr + offset;\r\nfbi->screen_size = rk_obj->base.size;\r\nfbi->fix.smem_len = rk_obj->base.size;\r\nDRM_DEBUG_KMS("FB [%dx%d]-%d kvaddr=%p offset=%ld size=%d\n",\r\nfb->width, fb->height, fb->depth, rk_obj->kvaddr,\r\noffset, size);\r\nfbi->skip_vt_switch = true;\r\nreturn 0;\r\nerr_release_fbi:\r\ndrm_fb_helper_release_fbi(helper);\r\nerr_rockchip_gem_free_object:\r\nrockchip_gem_free_object(&rk_obj->base);\r\nreturn ret;\r\n}\r\nint rockchip_drm_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct rockchip_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *helper;\r\nunsigned int num_crtc;\r\nint ret;\r\nif (!dev->mode_config.num_crtc || !dev->mode_config.num_connector)\r\nreturn -EINVAL;\r\nnum_crtc = dev->mode_config.num_crtc;\r\nhelper = &private->fbdev_helper;\r\ndrm_fb_helper_prepare(dev, helper, &rockchip_drm_fb_helper_funcs);\r\nret = drm_fb_helper_init(dev, helper, num_crtc, ROCKCHIP_MAX_CONNECTOR);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to initialize drm fb helper - %d.\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(helper);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to add connectors - %d.\n", ret);\r\ngoto err_drm_fb_helper_fini;\r\n}\r\ndrm_helper_disable_unused_functions(dev);\r\nret = drm_fb_helper_initial_config(helper, PREFERRED_BPP);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to set initial hw config - %d.\n",\r\nret);\r\ngoto err_drm_fb_helper_fini;\r\n}\r\nreturn 0;\r\nerr_drm_fb_helper_fini:\r\ndrm_fb_helper_fini(helper);\r\nreturn ret;\r\n}\r\nvoid rockchip_drm_fbdev_fini(struct drm_device *dev)\r\n{\r\nstruct rockchip_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *helper;\r\nhelper = &private->fbdev_helper;\r\ndrm_fb_helper_unregister_fbi(helper);\r\ndrm_fb_helper_release_fbi(helper);\r\nif (helper->fb)\r\ndrm_framebuffer_unreference(helper->fb);\r\ndrm_fb_helper_fini(helper);\r\n}

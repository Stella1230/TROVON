static unsigned int __init serial8250_early_in(struct uart_port *port, int offset)\r\n{\r\noffset <<= port->regshift;\r\nswitch (port->iotype) {\r\ncase UPIO_MEM:\r\nreturn readb(port->membase + offset);\r\ncase UPIO_MEM16:\r\nreturn readw(port->membase + offset);\r\ncase UPIO_MEM32:\r\nreturn readl(port->membase + offset);\r\ncase UPIO_MEM32BE:\r\nreturn ioread32be(port->membase + offset);\r\ncase UPIO_PORT:\r\nreturn inb(port->iobase + offset);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic void __init serial8250_early_out(struct uart_port *port, int offset, int value)\r\n{\r\noffset <<= port->regshift;\r\nswitch (port->iotype) {\r\ncase UPIO_MEM:\r\nwriteb(value, port->membase + offset);\r\nbreak;\r\ncase UPIO_MEM16:\r\nwritew(value, port->membase + offset);\r\nbreak;\r\ncase UPIO_MEM32:\r\nwritel(value, port->membase + offset);\r\nbreak;\r\ncase UPIO_MEM32BE:\r\niowrite32be(value, port->membase + offset);\r\nbreak;\r\ncase UPIO_PORT:\r\noutb(value, port->iobase + offset);\r\nbreak;\r\n}\r\n}\r\nstatic void __init serial_putc(struct uart_port *port, int c)\r\n{\r\nunsigned int status;\r\nserial8250_early_out(port, UART_TX, c);\r\nfor (;;) {\r\nstatus = serial8250_early_in(port, UART_LSR);\r\nif ((status & BOTH_EMPTY) == BOTH_EMPTY)\r\nbreak;\r\ncpu_relax();\r\n}\r\n}\r\nstatic void __init early_serial8250_write(struct console *console,\r\nconst char *s, unsigned int count)\r\n{\r\nstruct earlycon_device *device = console->data;\r\nstruct uart_port *port = &device->port;\r\nuart_console_write(port, s, count, serial_putc);\r\n}\r\nstatic void __init init_port(struct earlycon_device *device)\r\n{\r\nstruct uart_port *port = &device->port;\r\nunsigned int divisor;\r\nunsigned char c;\r\nunsigned int ier;\r\nserial8250_early_out(port, UART_LCR, 0x3);\r\nier = serial8250_early_in(port, UART_IER);\r\nserial8250_early_out(port, UART_IER, ier & UART_IER_UUE);\r\nserial8250_early_out(port, UART_FCR, 0);\r\nserial8250_early_out(port, UART_MCR, 0x3);\r\ndivisor = DIV_ROUND_CLOSEST(port->uartclk, 16 * device->baud);\r\nc = serial8250_early_in(port, UART_LCR);\r\nserial8250_early_out(port, UART_LCR, c | UART_LCR_DLAB);\r\nserial8250_early_out(port, UART_DLL, divisor & 0xff);\r\nserial8250_early_out(port, UART_DLM, (divisor >> 8) & 0xff);\r\nserial8250_early_out(port, UART_LCR, c & ~UART_LCR_DLAB);\r\n}\r\nint __init early_serial8250_setup(struct earlycon_device *device,\r\nconst char *options)\r\n{\r\nif (!(device->port.membase || device->port.iobase))\r\nreturn -ENODEV;\r\nif (!device->baud) {\r\nstruct uart_port *port = &device->port;\r\nunsigned int ier;\r\nier = serial8250_early_in(port, UART_IER);\r\nserial8250_early_out(port, UART_IER, ier & UART_IER_UUE);\r\n} else\r\ninit_port(device);\r\ndevice->con->write = early_serial8250_write;\r\nreturn 0;\r\n}\r\nstatic int __init early_omap8250_setup(struct earlycon_device *device,\r\nconst char *options)\r\n{\r\nstruct uart_port *port = &device->port;\r\nif (!(device->port.membase || device->port.iobase))\r\nreturn -ENODEV;\r\nport->regshift = 2;\r\ndevice->con->write = early_serial8250_write;\r\nreturn 0;\r\n}

static const char *cx2341x_get_name(u32 id)\r\n{\r\nswitch (id) {\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\nreturn "Spatial Filter Mode";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\nreturn "Spatial Filter";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\nreturn "Spatial Luma Filter Type";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\nreturn "Spatial Chroma Filter Type";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\nreturn "Temporal Filter Mode";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\nreturn "Temporal Filter";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nreturn "Median Filter Type";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\nreturn "Median Luma Filter Maximum";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\nreturn "Median Luma Filter Minimum";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\nreturn "Median Chroma Filter Maximum";\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\nreturn "Median Chroma Filter Minimum";\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\nreturn "Insert Navigation Packets";\r\n}\r\nreturn NULL;\r\n}\r\nstatic const char **cx2341x_get_menu(u32 id)\r\n{\r\nstatic const char *cx2341x_video_spatial_filter_mode_menu[] = {\r\n"Manual",\r\n"Auto",\r\nNULL\r\n};\r\nstatic const char *cx2341x_video_luma_spatial_filter_type_menu[] = {\r\n"Off",\r\n"1D Horizontal",\r\n"1D Vertical",\r\n"2D H/V Separable",\r\n"2D Symmetric non-separable",\r\nNULL\r\n};\r\nstatic const char *cx2341x_video_chroma_spatial_filter_type_menu[] = {\r\n"Off",\r\n"1D Horizontal",\r\nNULL\r\n};\r\nstatic const char *cx2341x_video_temporal_filter_mode_menu[] = {\r\n"Manual",\r\n"Auto",\r\nNULL\r\n};\r\nstatic const char *cx2341x_video_median_filter_type_menu[] = {\r\n"Off",\r\n"Horizontal",\r\n"Vertical",\r\n"Horizontal/Vertical",\r\n"Diagonal",\r\nNULL\r\n};\r\nswitch (id) {\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\nreturn cx2341x_video_spatial_filter_mode_menu;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\nreturn cx2341x_video_luma_spatial_filter_type_menu;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\nreturn cx2341x_video_chroma_spatial_filter_type_menu;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\nreturn cx2341x_video_temporal_filter_mode_menu;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nreturn cx2341x_video_median_filter_type_menu;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void cx2341x_ctrl_fill(u32 id, const char **name, enum v4l2_ctrl_type *type,\r\ns32 *min, s32 *max, s32 *step, s32 *def, u32 *flags)\r\n{\r\n*name = cx2341x_get_name(id);\r\n*flags = 0;\r\nswitch (id) {\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\n*type = V4L2_CTRL_TYPE_MENU;\r\n*min = 0;\r\n*step = 0;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\n*type = V4L2_CTRL_TYPE_BOOLEAN;\r\n*min = 0;\r\n*max = *step = 1;\r\nbreak;\r\ndefault:\r\n*type = V4L2_CTRL_TYPE_INTEGER;\r\nbreak;\r\n}\r\nswitch (id) {\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\n*flags |= V4L2_CTRL_FLAG_UPDATE;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\n*flags |= V4L2_CTRL_FLAG_SLIDER;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_ENCODING:\r\n*flags |= V4L2_CTRL_FLAG_READ_ONLY;\r\nbreak;\r\n}\r\n}\r\nstatic int cx2341x_get_ctrl(const struct cx2341x_mpeg_params *params,\r\nstruct v4l2_ext_control *ctrl)\r\n{\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\r\nctrl->value = params->audio_sampling_freq;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_ENCODING:\r\nctrl->value = params->audio_encoding;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\r\nctrl->value = params->audio_l2_bitrate;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\r\nctrl->value = params->audio_ac3_bitrate;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MODE:\r\nctrl->value = params->audio_mode;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\r\nctrl->value = params->audio_mode_extension;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_EMPHASIS:\r\nctrl->value = params->audio_emphasis;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_CRC:\r\nctrl->value = params->audio_crc;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MUTE:\r\nctrl->value = params->audio_mute;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_ENCODING:\r\nctrl->value = params->video_encoding;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_ASPECT:\r\nctrl->value = params->video_aspect;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES:\r\nctrl->value = params->video_b_frames;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_GOP_SIZE:\r\nctrl->value = params->video_gop_size;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\r\nctrl->value = params->video_gop_closure;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\r\nctrl->value = params->video_bitrate_mode;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE:\r\nctrl->value = params->video_bitrate;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\r\nctrl->value = params->video_bitrate_peak;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\r\nctrl->value = params->video_temporal_decimation;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MUTE:\r\nctrl->value = params->video_mute;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MUTE_YUV:\r\nctrl->value = params->video_mute_yuv;\r\nbreak;\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nctrl->value = params->stream_type;\r\nbreak;\r\ncase V4L2_CID_MPEG_STREAM_VBI_FMT:\r\nctrl->value = params->stream_vbi_fmt;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\nctrl->value = params->video_spatial_filter_mode;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\nctrl->value = params->video_spatial_filter;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\nctrl->value = params->video_luma_spatial_filter_type;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\nctrl->value = params->video_chroma_spatial_filter_type;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\nctrl->value = params->video_temporal_filter_mode;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\nctrl->value = params->video_temporal_filter;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nctrl->value = params->video_median_filter_type;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\nctrl->value = params->video_luma_median_filter_top;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\nctrl->value = params->video_luma_median_filter_bottom;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\nctrl->value = params->video_chroma_median_filter_top;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\nctrl->value = params->video_chroma_median_filter_bottom;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\nctrl->value = params->stream_insert_nav_packets;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx2341x_set_ctrl(struct cx2341x_mpeg_params *params, int busy,\r\nstruct v4l2_ext_control *ctrl)\r\n{\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\r\nif (busy)\r\nreturn -EBUSY;\r\nparams->audio_sampling_freq = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_ENCODING:\r\nif (busy)\r\nreturn -EBUSY;\r\nif (params->capabilities & CX2341X_CAP_HAS_AC3)\r\nif (ctrl->value != V4L2_MPEG_AUDIO_ENCODING_LAYER_2 &&\r\nctrl->value != V4L2_MPEG_AUDIO_ENCODING_AC3)\r\nreturn -ERANGE;\r\nparams->audio_encoding = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\r\nif (busy)\r\nreturn -EBUSY;\r\nparams->audio_l2_bitrate = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\r\nif (busy)\r\nreturn -EBUSY;\r\nif (!(params->capabilities & CX2341X_CAP_HAS_AC3))\r\nreturn -EINVAL;\r\nparams->audio_ac3_bitrate = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MODE:\r\nparams->audio_mode = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\r\nparams->audio_mode_extension = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_EMPHASIS:\r\nparams->audio_emphasis = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_CRC:\r\nparams->audio_crc = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_AUDIO_MUTE:\r\nparams->audio_mute = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_ASPECT:\r\nparams->video_aspect = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES: {\r\nint b = ctrl->value + 1;\r\nint gop = params->video_gop_size;\r\nparams->video_b_frames = ctrl->value;\r\nparams->video_gop_size = b * ((gop + b - 1) / b);\r\nwhile (params->video_gop_size > 34)\r\nparams->video_gop_size -= b;\r\nbreak;\r\n}\r\ncase V4L2_CID_MPEG_VIDEO_GOP_SIZE: {\r\nint b = params->video_b_frames + 1;\r\nint gop = ctrl->value;\r\nparams->video_gop_size = b * ((gop + b - 1) / b);\r\nwhile (params->video_gop_size > 34)\r\nparams->video_gop_size -= b;\r\nctrl->value = params->video_gop_size;\r\nbreak;\r\n}\r\ncase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\r\nparams->video_gop_closure = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\r\nif (busy)\r\nreturn -EBUSY;\r\nif (params->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1 &&\r\nctrl->value != V4L2_MPEG_VIDEO_BITRATE_MODE_CBR)\r\nreturn -EINVAL;\r\nparams->video_bitrate_mode = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE:\r\nif (busy)\r\nreturn -EBUSY;\r\nparams->video_bitrate = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\r\nif (busy)\r\nreturn -EBUSY;\r\nparams->video_bitrate_peak = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\r\nparams->video_temporal_decimation = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MUTE:\r\nparams->video_mute = (ctrl->value != 0);\r\nbreak;\r\ncase V4L2_CID_MPEG_VIDEO_MUTE_YUV:\r\nparams->video_mute_yuv = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nif (busy)\r\nreturn -EBUSY;\r\nparams->stream_type = ctrl->value;\r\nparams->video_encoding =\r\n(params->stream_type == V4L2_MPEG_STREAM_TYPE_MPEG1_SS ||\r\nparams->stream_type == V4L2_MPEG_STREAM_TYPE_MPEG1_VCD) ?\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_1 :\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2;\r\nif (params->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\r\nparams->video_bitrate_mode =\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR;\r\nbreak;\r\ncase V4L2_CID_MPEG_STREAM_VBI_FMT:\r\nparams->stream_vbi_fmt = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\nparams->video_spatial_filter_mode = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\nparams->video_spatial_filter = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\nparams->video_luma_spatial_filter_type = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\nparams->video_chroma_spatial_filter_type = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\nparams->video_temporal_filter_mode = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\nparams->video_temporal_filter = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nparams->video_median_filter_type = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\nparams->video_luma_median_filter_top = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\nparams->video_luma_median_filter_bottom = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\nparams->video_chroma_median_filter_top = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\nparams->video_chroma_median_filter_bottom = ctrl->value;\r\nbreak;\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\nparams->stream_insert_nav_packets = ctrl->value;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx2341x_ctrl_query_fill(struct v4l2_queryctrl *qctrl,\r\ns32 min, s32 max, s32 step, s32 def)\r\n{\r\nconst char *name;\r\nswitch (qctrl->id) {\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\ncx2341x_ctrl_fill(qctrl->id, &name, &qctrl->type,\r\n&min, &max, &step, &def, &qctrl->flags);\r\nqctrl->minimum = min;\r\nqctrl->maximum = max;\r\nqctrl->step = step;\r\nqctrl->default_value = def;\r\nqctrl->reserved[0] = qctrl->reserved[1] = 0;\r\nstrlcpy(qctrl->name, name, sizeof(qctrl->name));\r\nreturn 0;\r\ndefault:\r\nreturn v4l2_ctrl_query_fill(qctrl, min, max, step, def);\r\n}\r\n}\r\nint cx2341x_ctrl_query(const struct cx2341x_mpeg_params *params,\r\nstruct v4l2_queryctrl *qctrl)\r\n{\r\nint err;\r\nswitch (qctrl->id) {\r\ncase V4L2_CID_MPEG_CLASS:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 0, 0, 0);\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_STREAM_TYPE_MPEG2_PS,\r\nV4L2_MPEG_STREAM_TYPE_MPEG2_SVCD, 1,\r\nV4L2_MPEG_STREAM_TYPE_MPEG2_PS);\r\ncase V4L2_CID_MPEG_STREAM_VBI_FMT:\r\nif (params->capabilities & CX2341X_CAP_HAS_SLICED_VBI)\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_STREAM_VBI_FMT_NONE,\r\nV4L2_MPEG_STREAM_VBI_FMT_IVTV, 1,\r\nV4L2_MPEG_STREAM_VBI_FMT_NONE);\r\nreturn cx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_STREAM_VBI_FMT_NONE,\r\nV4L2_MPEG_STREAM_VBI_FMT_NONE, 1,\r\ndefault_params.stream_vbi_fmt);\r\ncase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_SAMPLING_FREQ_44100,\r\nV4L2_MPEG_AUDIO_SAMPLING_FREQ_32000, 1,\r\nV4L2_MPEG_AUDIO_SAMPLING_FREQ_48000);\r\ncase V4L2_CID_MPEG_AUDIO_ENCODING:\r\nif (params->capabilities & CX2341X_CAP_HAS_AC3) {\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_ENCODING_LAYER_2,\r\nV4L2_MPEG_AUDIO_ENCODING_AC3, 1,\r\ndefault_params.audio_encoding);\r\n}\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_ENCODING_LAYER_2,\r\nV4L2_MPEG_AUDIO_ENCODING_LAYER_2, 1,\r\ndefault_params.audio_encoding);\r\ncase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\r\nerr = v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_L2_BITRATE_192K,\r\nV4L2_MPEG_AUDIO_L2_BITRATE_384K, 1,\r\ndefault_params.audio_l2_bitrate);\r\nif (err)\r\nreturn err;\r\nif (params->capabilities & CX2341X_CAP_HAS_AC3 &&\r\nparams->audio_encoding != V4L2_MPEG_AUDIO_ENCODING_LAYER_2)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_AUDIO_MODE:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_MODE_STEREO,\r\nV4L2_MPEG_AUDIO_MODE_MONO, 1,\r\nV4L2_MPEG_AUDIO_MODE_STEREO);\r\ncase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\r\nerr = v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4,\r\nV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_16, 1,\r\nV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4);\r\nif (err == 0 &&\r\nparams->audio_mode != V4L2_MPEG_AUDIO_MODE_JOINT_STEREO)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn err;\r\ncase V4L2_CID_MPEG_AUDIO_EMPHASIS:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_EMPHASIS_NONE,\r\nV4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17, 1,\r\nV4L2_MPEG_AUDIO_EMPHASIS_NONE);\r\ncase V4L2_CID_MPEG_AUDIO_CRC:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_CRC_NONE,\r\nV4L2_MPEG_AUDIO_CRC_CRC16, 1,\r\nV4L2_MPEG_AUDIO_CRC_NONE);\r\ncase V4L2_CID_MPEG_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 0);\r\ncase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\r\nerr = v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_AUDIO_AC3_BITRATE_48K,\r\nV4L2_MPEG_AUDIO_AC3_BITRATE_448K, 1,\r\ndefault_params.audio_ac3_bitrate);\r\nif (err)\r\nreturn err;\r\nif (params->capabilities & CX2341X_CAP_HAS_AC3) {\r\nif (params->audio_encoding !=\r\nV4L2_MPEG_AUDIO_ENCODING_AC3)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\n} else\r\nqctrl->flags |= V4L2_CTRL_FLAG_DISABLED;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_VIDEO_ENCODING:\r\nerr = v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_1,\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2, 1,\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2);\r\nif (err == 0)\r\nqctrl->flags |= V4L2_CTRL_FLAG_READ_ONLY;\r\nreturn err;\r\ncase V4L2_CID_MPEG_VIDEO_ASPECT:\r\nreturn v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_VIDEO_ASPECT_1x1,\r\nV4L2_MPEG_VIDEO_ASPECT_221x100, 1,\r\nV4L2_MPEG_VIDEO_ASPECT_4x3);\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 33, 1, 2);\r\ncase V4L2_CID_MPEG_VIDEO_GOP_SIZE:\r\nreturn v4l2_ctrl_query_fill(qctrl, 1, 34, 1,\r\nparams->is_50hz ? 12 : 15);\r\ncase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 1);\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\r\nerr = v4l2_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_VBR,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR, 1,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_VBR);\r\nif (err == 0 &&\r\nparams->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn err;\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 27000000, 1, 6000000);\r\ncase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\r\nerr = v4l2_ctrl_query_fill(qctrl, 0, 27000000, 1, 8000000);\r\nif (err == 0 &&\r\nparams->video_bitrate_mode ==\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn err;\r\ncase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 255, 1, 0);\r\ncase V4L2_CID_MPEG_VIDEO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 0);\r\ncase V4L2_CID_MPEG_VIDEO_MUTE_YUV:\r\nreturn v4l2_ctrl_query_fill(qctrl, 0, 0xffffff, 1, 0x008080);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\nreturn cx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL,\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO, 1,\r\ndefault_params.video_spatial_filter_mode);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 15, 1,\r\ndefault_params.video_spatial_filter);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_spatial_filter_mode ==\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\ncx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_SYM_NON_SEPARABLE,\r\n1,\r\ndefault_params.video_luma_spatial_filter_type);\r\nif (params->video_spatial_filter_mode ==\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\ncx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR,\r\n1,\r\ndefault_params.video_chroma_spatial_filter_type);\r\nif (params->video_spatial_filter_mode ==\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\nreturn cx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL,\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO, 1,\r\ndefault_params.video_temporal_filter_mode);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 31, 1,\r\ndefault_params.video_temporal_filter);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_temporal_filter_mode ==\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nreturn cx2341x_ctrl_query_fill(qctrl,\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_DIAG, 1,\r\ndefault_params.video_median_filter_type);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\r\ndefault_params.video_luma_median_filter_top);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_median_filter_type ==\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\r\ndefault_params.video_luma_median_filter_bottom);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_median_filter_type ==\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\r\ndefault_params.video_chroma_median_filter_top);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_median_filter_type ==\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\r\ncx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\r\ndefault_params.video_chroma_median_filter_bottom);\r\nqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\r\nif (params->video_median_filter_type ==\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\r\nqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\r\nreturn 0;\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\nreturn cx2341x_ctrl_query_fill(qctrl, 0, 1, 1,\r\ndefault_params.stream_insert_nav_packets);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nconst char * const *cx2341x_ctrl_get_menu(const struct cx2341x_mpeg_params *p, u32 id)\r\n{\r\nstatic const char * const mpeg_stream_type_without_ts[] = {\r\n"MPEG-2 Program Stream",\r\n"",\r\n"MPEG-1 System Stream",\r\n"MPEG-2 DVD-compatible Stream",\r\n"MPEG-1 VCD-compatible Stream",\r\n"MPEG-2 SVCD-compatible Stream",\r\nNULL\r\n};\r\nstatic const char *mpeg_stream_type_with_ts[] = {\r\n"MPEG-2 Program Stream",\r\n"MPEG-2 Transport Stream",\r\n"MPEG-1 System Stream",\r\n"MPEG-2 DVD-compatible Stream",\r\n"MPEG-1 VCD-compatible Stream",\r\n"MPEG-2 SVCD-compatible Stream",\r\nNULL\r\n};\r\nstatic const char *mpeg_audio_encoding_l2_ac3[] = {\r\n"",\r\n"MPEG-1/2 Layer II",\r\n"",\r\n"",\r\n"AC-3",\r\nNULL\r\n};\r\nswitch (id) {\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nreturn (p->capabilities & CX2341X_CAP_HAS_TS) ?\r\nmpeg_stream_type_with_ts : mpeg_stream_type_without_ts;\r\ncase V4L2_CID_MPEG_AUDIO_ENCODING:\r\nreturn (p->capabilities & CX2341X_CAP_HAS_AC3) ?\r\nmpeg_audio_encoding_l2_ac3 : v4l2_ctrl_get_menu(id);\r\ncase V4L2_CID_MPEG_AUDIO_L1_BITRATE:\r\ncase V4L2_CID_MPEG_AUDIO_L3_BITRATE:\r\nreturn NULL;\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\r\nreturn cx2341x_get_menu(id);\r\ndefault:\r\nreturn v4l2_ctrl_get_menu(id);\r\n}\r\n}\r\nstatic void cx2341x_calc_audio_properties(struct cx2341x_mpeg_params *params)\r\n{\r\nparams->audio_properties =\r\n(params->audio_sampling_freq << 0) |\r\n(params->audio_mode << 8) |\r\n(params->audio_mode_extension << 10) |\r\n(((params->audio_emphasis == V4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17)\r\n? 3 : params->audio_emphasis) << 12) |\r\n(params->audio_crc << 14);\r\nif ((params->capabilities & CX2341X_CAP_HAS_AC3) &&\r\nparams->audio_encoding == V4L2_MPEG_AUDIO_ENCODING_AC3) {\r\nparams->audio_properties |=\r\n((3 - V4L2_MPEG_AUDIO_ENCODING_LAYER_2) << 2) |\r\n(params->audio_ac3_bitrate << 4) |\r\n(CX2341X_AUDIO_ENCODING_METHOD_AC3 << 28);\r\n} else {\r\nparams->audio_properties |=\r\n((3 - params->audio_encoding) << 2) |\r\n((1 + params->audio_l2_bitrate) << 4);\r\n}\r\n}\r\nstatic int v4l2_ctrl_check(struct v4l2_ext_control *ctrl, struct v4l2_queryctrl *qctrl,\r\nconst char * const *menu_items)\r\n{\r\nif (qctrl->flags & V4L2_CTRL_FLAG_DISABLED)\r\nreturn -EINVAL;\r\nif (qctrl->flags & V4L2_CTRL_FLAG_GRABBED)\r\nreturn -EBUSY;\r\nif (qctrl->type == V4L2_CTRL_TYPE_STRING)\r\nreturn 0;\r\nif (qctrl->type == V4L2_CTRL_TYPE_BUTTON ||\r\nqctrl->type == V4L2_CTRL_TYPE_INTEGER64 ||\r\nqctrl->type == V4L2_CTRL_TYPE_CTRL_CLASS)\r\nreturn 0;\r\nif (ctrl->value < qctrl->minimum || ctrl->value > qctrl->maximum)\r\nreturn -ERANGE;\r\nif (qctrl->type == V4L2_CTRL_TYPE_MENU && menu_items != NULL) {\r\nif (menu_items[ctrl->value] == NULL ||\r\nmenu_items[ctrl->value][0] == '\0')\r\nreturn -EINVAL;\r\n}\r\nif (qctrl->type == V4L2_CTRL_TYPE_BITMASK &&\r\n(ctrl->value & ~qctrl->maximum))\r\nreturn -ERANGE;\r\nreturn 0;\r\n}\r\nint cx2341x_ext_ctrls(struct cx2341x_mpeg_params *params, int busy,\r\nstruct v4l2_ext_controls *ctrls, unsigned int cmd)\r\n{\r\nint err = 0;\r\nint i;\r\nif (cmd == VIDIOC_G_EXT_CTRLS) {\r\nfor (i = 0; i < ctrls->count; i++) {\r\nstruct v4l2_ext_control *ctrl = ctrls->controls + i;\r\nerr = cx2341x_get_ctrl(params, ctrl);\r\nif (err) {\r\nctrls->error_idx = i;\r\nbreak;\r\n}\r\n}\r\nreturn err;\r\n}\r\nfor (i = 0; i < ctrls->count; i++) {\r\nstruct v4l2_ext_control *ctrl = ctrls->controls + i;\r\nstruct v4l2_queryctrl qctrl;\r\nconst char * const *menu_items = NULL;\r\nqctrl.id = ctrl->id;\r\nerr = cx2341x_ctrl_query(params, &qctrl);\r\nif (err)\r\nbreak;\r\nif (qctrl.type == V4L2_CTRL_TYPE_MENU)\r\nmenu_items = cx2341x_ctrl_get_menu(params, qctrl.id);\r\nerr = v4l2_ctrl_check(ctrl, &qctrl, menu_items);\r\nif (err)\r\nbreak;\r\nerr = cx2341x_set_ctrl(params, busy, ctrl);\r\nif (err)\r\nbreak;\r\n}\r\nif (err == 0 &&\r\nparams->video_bitrate_mode == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR &&\r\nparams->video_bitrate_peak < params->video_bitrate) {\r\nerr = -ERANGE;\r\nctrls->error_idx = ctrls->count;\r\n}\r\nif (err)\r\nctrls->error_idx = i;\r\nelse\r\ncx2341x_calc_audio_properties(params);\r\nreturn err;\r\n}\r\nvoid cx2341x_fill_defaults(struct cx2341x_mpeg_params *p)\r\n{\r\n*p = default_params;\r\ncx2341x_calc_audio_properties(p);\r\n}\r\nstatic int cx2341x_api(void *priv, cx2341x_mbox_func func,\r\nu32 cmd, int args, ...)\r\n{\r\nu32 data[CX2341X_MBOX_MAX_DATA];\r\nva_list vargs;\r\nint i;\r\nva_start(vargs, args);\r\nfor (i = 0; i < args; i++)\r\ndata[i] = va_arg(vargs, int);\r\nva_end(vargs);\r\nreturn func(priv, cmd, args, 0, data);\r\n}\r\nint cx2341x_update(void *priv, cx2341x_mbox_func func,\r\nconst struct cx2341x_mpeg_params *old,\r\nconst struct cx2341x_mpeg_params *new)\r\n{\r\nstatic int mpeg_stream_type[] = {\r\n0,\r\n1,\r\n2,\r\n14,\r\n11,\r\n12,\r\n};\r\nint err = 0;\r\nint force = (old == NULL);\r\nu16 temporal = new->video_temporal_filter;\r\ncx2341x_api(priv, func, CX2341X_ENC_SET_OUTPUT_PORT, 2, new->port, 0);\r\nif (force || NEQ(is_50hz)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_RATE, 1,\r\nnew->is_50hz);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(width) || NEQ(height) || NEQ(video_encoding)) {\r\nu16 w = new->width;\r\nu16 h = new->height;\r\nif (new->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1) {\r\nw /= 2;\r\nh /= 2;\r\n}\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_SIZE, 2,\r\nh, w);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(stream_type)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_STREAM_TYPE, 1,\r\nmpeg_stream_type[new->stream_type]);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_aspect)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_ASPECT_RATIO, 1,\r\n1 + new->video_aspect);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_b_frames) || NEQ(video_gop_size)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_GOP_PROPERTIES, 2,\r\nnew->video_gop_size, new->video_b_frames + 1);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_gop_closure)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_GOP_CLOSURE, 1,\r\nnew->video_gop_closure);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(audio_properties)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_AUDIO_PROPERTIES,\r\n1, new->audio_properties);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(audio_mute)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_MUTE_AUDIO, 1,\r\nnew->audio_mute);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_bitrate_mode) || NEQ(video_bitrate) ||\r\nNEQ(video_bitrate_peak)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_BIT_RATE, 5,\r\nnew->video_bitrate_mode, new->video_bitrate,\r\nnew->video_bitrate_peak / 400, 0, 0);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_spatial_filter_mode) ||\r\nNEQ(video_temporal_filter_mode) ||\r\nNEQ(video_median_filter_type)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_DNR_FILTER_MODE,\r\n2, new->video_spatial_filter_mode |\r\n(new->video_temporal_filter_mode << 1),\r\nnew->video_median_filter_type);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_luma_median_filter_bottom) ||\r\nNEQ(video_luma_median_filter_top) ||\r\nNEQ(video_chroma_median_filter_bottom) ||\r\nNEQ(video_chroma_median_filter_top)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_CORING_LEVELS, 4,\r\nnew->video_luma_median_filter_bottom,\r\nnew->video_luma_median_filter_top,\r\nnew->video_chroma_median_filter_bottom,\r\nnew->video_chroma_median_filter_top);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_luma_spatial_filter_type) ||\r\nNEQ(video_chroma_spatial_filter_type)) {\r\nerr = cx2341x_api(priv, func,\r\nCX2341X_ENC_SET_SPATIAL_FILTER_TYPE,\r\n2, new->video_luma_spatial_filter_type,\r\nnew->video_chroma_spatial_filter_type);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_spatial_filter) ||\r\nold->video_temporal_filter != temporal) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_DNR_FILTER_PROPS,\r\n2, new->video_spatial_filter, temporal);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_temporal_decimation)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_DROP_RATE,\r\n1, new->video_temporal_decimation);\r\nif (err) return err;\r\n}\r\nif (force || NEQ(video_mute) ||\r\n(new->video_mute && NEQ(video_mute_yuv))) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_MUTE_VIDEO, 1,\r\nnew->video_mute | (new->video_mute_yuv << 8));\r\nif (err) return err;\r\n}\r\nif (force || NEQ(stream_insert_nav_packets)) {\r\nerr = cx2341x_api(priv, func, CX2341X_ENC_MISC, 2,\r\n7, new->stream_insert_nav_packets);\r\nif (err) return err;\r\n}\r\nreturn 0;\r\n}\r\nstatic const char *cx2341x_menu_item(const struct cx2341x_mpeg_params *p, u32 id)\r\n{\r\nconst char * const *menu = cx2341x_ctrl_get_menu(p, id);\r\nstruct v4l2_ext_control ctrl;\r\nif (menu == NULL)\r\ngoto invalid;\r\nctrl.id = id;\r\nif (cx2341x_get_ctrl(p, &ctrl))\r\ngoto invalid;\r\nwhile (ctrl.value-- && *menu) menu++;\r\nif (*menu == NULL)\r\ngoto invalid;\r\nreturn *menu;\r\ninvalid:\r\nreturn "<invalid>";\r\n}\r\nvoid cx2341x_log_status(const struct cx2341x_mpeg_params *p, const char *prefix)\r\n{\r\nint is_mpeg1 = p->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1;\r\nprintk(KERN_INFO "%s: Stream: %s",\r\nprefix,\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_STREAM_TYPE));\r\nif (p->stream_insert_nav_packets)\r\nprintk(" (with navigation packets)");\r\nprintk("\n");\r\nprintk(KERN_INFO "%s: VBI Format: %s\n",\r\nprefix,\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_STREAM_VBI_FMT));\r\nprintk(KERN_INFO "%s: Video: %dx%d, %d fps%s\n",\r\nprefix,\r\np->width / (is_mpeg1 ? 2 : 1), p->height / (is_mpeg1 ? 2 : 1),\r\np->is_50hz ? 25 : 30,\r\n(p->video_mute) ? " (muted)" : "");\r\nprintk(KERN_INFO "%s: Video: %s, %s, %s, %d",\r\nprefix,\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_ENCODING),\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_ASPECT),\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_BITRATE_MODE),\r\np->video_bitrate);\r\nif (p->video_bitrate_mode == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR)\r\nprintk(", Peak %d", p->video_bitrate_peak);\r\nprintk("\n");\r\nprintk(KERN_INFO\r\n"%s: Video: GOP Size %d, %d B-Frames, %sGOP Closure\n",\r\nprefix,\r\np->video_gop_size, p->video_b_frames,\r\np->video_gop_closure ? "" : "No ");\r\nif (p->video_temporal_decimation)\r\nprintk(KERN_INFO "%s: Video: Temporal Decimation %d\n",\r\nprefix, p->video_temporal_decimation);\r\nprintk(KERN_INFO "%s: Audio: %s, %s, %s, %s%s",\r\nprefix,\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ),\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_ENCODING),\r\ncx2341x_menu_item(p,\r\np->audio_encoding == V4L2_MPEG_AUDIO_ENCODING_AC3\r\n? V4L2_CID_MPEG_AUDIO_AC3_BITRATE\r\n: V4L2_CID_MPEG_AUDIO_L2_BITRATE),\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_MODE),\r\np->audio_mute ? " (muted)" : "");\r\nif (p->audio_mode == V4L2_MPEG_AUDIO_MODE_JOINT_STEREO)\r\nprintk(", %s", cx2341x_menu_item(p,\r\nV4L2_CID_MPEG_AUDIO_MODE_EXTENSION));\r\nprintk(", %s, %s\n",\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_EMPHASIS),\r\ncx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_CRC));\r\nprintk(KERN_INFO "%s: Spatial Filter: %s, Luma %s, Chroma %s, %d\n",\r\nprefix,\r\ncx2341x_menu_item(p,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE),\r\ncx2341x_menu_item(p,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE),\r\ncx2341x_menu_item(p,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE),\r\np->video_spatial_filter);\r\nprintk(KERN_INFO "%s: Temporal Filter: %s, %d\n",\r\nprefix,\r\ncx2341x_menu_item(p,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE),\r\np->video_temporal_filter);\r\nprintk(KERN_INFO\r\n"%s: Median Filter: %s, Luma [%d, %d], Chroma [%d, %d]\n",\r\nprefix,\r\ncx2341x_menu_item(p,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE),\r\np->video_luma_median_filter_bottom,\r\np->video_luma_median_filter_top,\r\np->video_chroma_median_filter_bottom,\r\np->video_chroma_median_filter_top);\r\n}\r\nstatic inline struct cx2341x_handler *to_cxhdl(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn container_of(ctrl->handler, struct cx2341x_handler, hdl);\r\n}\r\nstatic int cx2341x_hdl_api(struct cx2341x_handler *hdl,\r\nu32 cmd, int args, ...)\r\n{\r\nu32 data[CX2341X_MBOX_MAX_DATA];\r\nva_list vargs;\r\nint i;\r\nva_start(vargs, args);\r\nfor (i = 0; i < args; i++)\r\ndata[i] = va_arg(vargs, int);\r\nva_end(vargs);\r\nreturn hdl->func(hdl->priv, cmd, args, 0, data);\r\n}\r\nstatic inline int cx2341x_neq(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn ctrl && ctrl->val != ctrl->cur.val;\r\n}\r\nstatic int cx2341x_try_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct cx2341x_handler *hdl = to_cxhdl(ctrl);\r\ns32 val = ctrl->val;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES: {\r\nint b = val + 1;\r\nint gop = hdl->video_gop_size->val;\r\ngop = b * ((gop + b - 1) / b);\r\nwhile (gop > 34)\r\ngop -= b;\r\nhdl->video_gop_size->val = gop;\r\nbreak;\r\n}\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nhdl->video_encoding->val =\r\n(hdl->stream_type->val == V4L2_MPEG_STREAM_TYPE_MPEG1_SS ||\r\nhdl->stream_type->val == V4L2_MPEG_STREAM_TYPE_MPEG1_VCD) ?\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_1 :\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2;\r\nif (hdl->video_encoding->val == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\r\nhdl->video_bitrate_mode->val =\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR;\r\nif (hdl->video_bitrate_mode->val == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR &&\r\nhdl->video_bitrate_peak->val < hdl->video_bitrate->val)\r\nhdl->video_bitrate_peak->val = hdl->video_bitrate->val;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx2341x_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstatic const int mpeg_stream_type[] = {\r\n0,\r\n1,\r\n2,\r\n14,\r\n11,\r\n12,\r\n};\r\nstruct cx2341x_handler *hdl = to_cxhdl(ctrl);\r\ns32 val = ctrl->val;\r\nu32 props;\r\nint err;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_MPEG_STREAM_VBI_FMT:\r\nif (hdl->ops && hdl->ops->s_stream_vbi_fmt)\r\nreturn hdl->ops->s_stream_vbi_fmt(hdl, val);\r\nreturn 0;\r\ncase V4L2_CID_MPEG_VIDEO_ASPECT:\r\nreturn cx2341x_hdl_api(hdl,\r\nCX2341X_ENC_SET_ASPECT_RATIO, 1, val + 1);\r\ncase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_GOP_CLOSURE, 1, val);\r\ncase V4L2_CID_MPEG_AUDIO_MUTE:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_MUTE_AUDIO, 1, val);\r\ncase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\r\nreturn cx2341x_hdl_api(hdl,\r\nCX2341X_ENC_SET_FRAME_DROP_RATE, 1, val);\r\ncase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_MISC, 2, 7, val);\r\ncase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\r\nprops = (hdl->audio_sampling_freq->val << 0) |\r\n(hdl->audio_mode->val << 8) |\r\n(hdl->audio_mode_extension->val << 10) |\r\n(hdl->audio_crc->val << 14);\r\nif (hdl->audio_emphasis->val == V4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17)\r\nprops |= 3 << 12;\r\nelse\r\nprops |= hdl->audio_emphasis->val << 12;\r\nif (hdl->audio_encoding->val == V4L2_MPEG_AUDIO_ENCODING_AC3) {\r\nprops |=\r\n#if 1\r\n((3 - V4L2_MPEG_AUDIO_ENCODING_LAYER_2) << 2) |\r\n#endif\r\n(hdl->audio_ac3_bitrate->val << 4) |\r\n(CX2341X_AUDIO_ENCODING_METHOD_AC3 << 28);\r\n} else {\r\nprops |=\r\n((3 - hdl->audio_encoding->val) << 2) |\r\n((1 + hdl->audio_l2_bitrate->val) << 4);\r\n}\r\nerr = cx2341x_hdl_api(hdl,\r\nCX2341X_ENC_SET_AUDIO_PROPERTIES, 1, props);\r\nif (err)\r\nreturn err;\r\nhdl->audio_properties = props;\r\nif (hdl->audio_ac3_bitrate) {\r\nint is_ac3 = hdl->audio_encoding->val ==\r\nV4L2_MPEG_AUDIO_ENCODING_AC3;\r\nv4l2_ctrl_activate(hdl->audio_ac3_bitrate, is_ac3);\r\nv4l2_ctrl_activate(hdl->audio_l2_bitrate, !is_ac3);\r\n}\r\nv4l2_ctrl_activate(hdl->audio_mode_extension,\r\nhdl->audio_mode->val == V4L2_MPEG_AUDIO_MODE_JOINT_STEREO);\r\nif (cx2341x_neq(hdl->audio_sampling_freq) &&\r\nhdl->ops && hdl->ops->s_audio_sampling_freq)\r\nreturn hdl->ops->s_audio_sampling_freq(hdl, hdl->audio_sampling_freq->val);\r\nif (cx2341x_neq(hdl->audio_mode) &&\r\nhdl->ops && hdl->ops->s_audio_mode)\r\nreturn hdl->ops->s_audio_mode(hdl, hdl->audio_mode->val);\r\nreturn 0;\r\ncase V4L2_CID_MPEG_VIDEO_B_FRAMES:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_GOP_PROPERTIES, 2,\r\nhdl->video_gop_size->val,\r\nhdl->video_b_frames->val + 1);\r\ncase V4L2_CID_MPEG_STREAM_TYPE:\r\nerr = cx2341x_hdl_api(hdl,\r\nCX2341X_ENC_SET_STREAM_TYPE, 1, mpeg_stream_type[val]);\r\nif (err)\r\nreturn err;\r\nerr = cx2341x_hdl_api(hdl, CX2341X_ENC_SET_BIT_RATE, 5,\r\nhdl->video_bitrate_mode->val,\r\nhdl->video_bitrate->val,\r\nhdl->video_bitrate_peak->val / 400, 0, 0);\r\nif (err)\r\nreturn err;\r\nv4l2_ctrl_activate(hdl->video_bitrate_mode,\r\nhdl->video_encoding->val != V4L2_MPEG_VIDEO_ENCODING_MPEG_1);\r\nv4l2_ctrl_activate(hdl->video_bitrate_peak,\r\nhdl->video_bitrate_mode->val != V4L2_MPEG_VIDEO_BITRATE_MODE_CBR);\r\nif (cx2341x_neq(hdl->video_encoding) &&\r\nhdl->ops && hdl->ops->s_video_encoding)\r\nreturn hdl->ops->s_video_encoding(hdl, hdl->video_encoding->val);\r\nreturn 0;\r\ncase V4L2_CID_MPEG_VIDEO_MUTE:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_MUTE_VIDEO, 1,\r\nhdl->video_mute->val |\r\n(hdl->video_mute_yuv->val << 8));\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE: {\r\nint active_filter;\r\nerr = cx2341x_hdl_api(hdl, CX2341X_ENC_SET_DNR_FILTER_MODE, 2,\r\nhdl->video_spatial_filter_mode->val |\r\n(hdl->video_temporal_filter_mode->val << 1),\r\nhdl->video_median_filter_type->val);\r\nif (err)\r\nreturn err;\r\nactive_filter = hdl->video_spatial_filter_mode->val !=\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO;\r\nv4l2_ctrl_activate(hdl->video_spatial_filter, active_filter);\r\nv4l2_ctrl_activate(hdl->video_luma_spatial_filter_type, active_filter);\r\nv4l2_ctrl_activate(hdl->video_chroma_spatial_filter_type, active_filter);\r\nactive_filter = hdl->video_temporal_filter_mode->val !=\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO;\r\nv4l2_ctrl_activate(hdl->video_temporal_filter, active_filter);\r\nactive_filter = hdl->video_median_filter_type->val !=\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF;\r\nv4l2_ctrl_activate(hdl->video_luma_median_filter_bottom, active_filter);\r\nv4l2_ctrl_activate(hdl->video_luma_median_filter_top, active_filter);\r\nv4l2_ctrl_activate(hdl->video_chroma_median_filter_bottom, active_filter);\r\nv4l2_ctrl_activate(hdl->video_chroma_median_filter_top, active_filter);\r\nreturn 0;\r\n}\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\r\nreturn cx2341x_hdl_api(hdl,\r\nCX2341X_ENC_SET_SPATIAL_FILTER_TYPE, 2,\r\nhdl->video_luma_spatial_filter_type->val,\r\nhdl->video_chroma_spatial_filter_type->val);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_DNR_FILTER_PROPS, 2,\r\nhdl->video_spatial_filter->val,\r\nhdl->video_temporal_filter->val);\r\ncase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\r\nreturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_CORING_LEVELS, 4,\r\nhdl->video_luma_median_filter_bottom->val,\r\nhdl->video_luma_median_filter_top->val,\r\nhdl->video_chroma_median_filter_bottom->val,\r\nhdl->video_chroma_median_filter_top->val);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_custom(struct v4l2_ctrl_handler *hdl,\r\nu32 id, s32 min, s32 max, s32 step, s32 def)\r\n{\r\nstruct v4l2_ctrl_config cfg;\r\nmemset(&cfg, 0, sizeof(cfg));\r\ncx2341x_ctrl_fill(id, &cfg.name, &cfg.type, &min, &max, &step, &def, &cfg.flags);\r\ncfg.ops = &cx2341x_ops;\r\ncfg.id = id;\r\ncfg.min = min;\r\ncfg.max = max;\r\ncfg.def = def;\r\nif (cfg.type == V4L2_CTRL_TYPE_MENU) {\r\ncfg.step = 0;\r\ncfg.menu_skip_mask = step;\r\ncfg.qmenu = cx2341x_get_menu(id);\r\n} else {\r\ncfg.step = step;\r\ncfg.menu_skip_mask = 0;\r\n}\r\nreturn v4l2_ctrl_new_custom(hdl, &cfg, NULL);\r\n}\r\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_std(struct v4l2_ctrl_handler *hdl,\r\nu32 id, s32 min, s32 max, s32 step, s32 def)\r\n{\r\nreturn v4l2_ctrl_new_std(hdl, &cx2341x_ops, id, min, max, step, def);\r\n}\r\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_menu(struct v4l2_ctrl_handler *hdl,\r\nu32 id, s32 max, s32 mask, s32 def)\r\n{\r\nreturn v4l2_ctrl_new_std_menu(hdl, &cx2341x_ops, id, max, mask, def);\r\n}\r\nint cx2341x_handler_init(struct cx2341x_handler *cxhdl,\r\nunsigned nr_of_controls_hint)\r\n{\r\nstruct v4l2_ctrl_handler *hdl = &cxhdl->hdl;\r\nu32 caps = cxhdl->capabilities;\r\nint has_sliced_vbi = caps & CX2341X_CAP_HAS_SLICED_VBI;\r\nint has_ac3 = caps & CX2341X_CAP_HAS_AC3;\r\nint has_ts = caps & CX2341X_CAP_HAS_TS;\r\ncxhdl->width = 720;\r\ncxhdl->height = 480;\r\nv4l2_ctrl_handler_init(hdl, nr_of_controls_hint);\r\ncxhdl->stream_type = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_STREAM_TYPE,\r\nV4L2_MPEG_STREAM_TYPE_MPEG2_SVCD, has_ts ? 0 : 2,\r\nV4L2_MPEG_STREAM_TYPE_MPEG2_PS);\r\ncxhdl->stream_vbi_fmt = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_STREAM_VBI_FMT,\r\nV4L2_MPEG_STREAM_VBI_FMT_IVTV, has_sliced_vbi ? 0 : 2,\r\nV4L2_MPEG_STREAM_VBI_FMT_NONE);\r\ncxhdl->audio_sampling_freq = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_SAMPLING_FREQ,\r\nV4L2_MPEG_AUDIO_SAMPLING_FREQ_32000, 0,\r\nV4L2_MPEG_AUDIO_SAMPLING_FREQ_48000);\r\ncxhdl->audio_encoding = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_ENCODING,\r\nV4L2_MPEG_AUDIO_ENCODING_AC3, has_ac3 ? ~0x12 : ~0x2,\r\nV4L2_MPEG_AUDIO_ENCODING_LAYER_2);\r\ncxhdl->audio_l2_bitrate = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_L2_BITRATE,\r\nV4L2_MPEG_AUDIO_L2_BITRATE_384K, 0x1ff,\r\nV4L2_MPEG_AUDIO_L2_BITRATE_224K);\r\ncxhdl->audio_mode = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_MODE,\r\nV4L2_MPEG_AUDIO_MODE_MONO, 0,\r\nV4L2_MPEG_AUDIO_MODE_STEREO);\r\ncxhdl->audio_mode_extension = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_MODE_EXTENSION,\r\nV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_16, 0,\r\nV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4);\r\ncxhdl->audio_emphasis = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_EMPHASIS,\r\nV4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17, 0,\r\nV4L2_MPEG_AUDIO_EMPHASIS_NONE);\r\ncxhdl->audio_crc = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_CRC,\r\nV4L2_MPEG_AUDIO_CRC_CRC16, 0,\r\nV4L2_MPEG_AUDIO_CRC_NONE);\r\ncx2341x_ctrl_new_std(hdl, V4L2_CID_MPEG_AUDIO_MUTE, 0, 1, 1, 0);\r\nif (has_ac3)\r\ncxhdl->audio_ac3_bitrate = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_AUDIO_AC3_BITRATE,\r\nV4L2_MPEG_AUDIO_AC3_BITRATE_448K, 0x03,\r\nV4L2_MPEG_AUDIO_AC3_BITRATE_224K);\r\ncxhdl->video_encoding = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_VIDEO_ENCODING,\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2, 0,\r\nV4L2_MPEG_VIDEO_ENCODING_MPEG_2);\r\ncx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_VIDEO_ASPECT,\r\nV4L2_MPEG_VIDEO_ASPECT_221x100, 0,\r\nV4L2_MPEG_VIDEO_ASPECT_4x3);\r\ncxhdl->video_b_frames = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_B_FRAMES, 0, 33, 1, 2);\r\ncxhdl->video_gop_size = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_GOP_SIZE,\r\n1, 34, 1, cxhdl->is_50hz ? 12 : 15);\r\ncx2341x_ctrl_new_std(hdl, V4L2_CID_MPEG_VIDEO_GOP_CLOSURE, 0, 1, 1, 1);\r\ncxhdl->video_bitrate_mode = cx2341x_ctrl_new_menu(hdl,\r\nV4L2_CID_MPEG_VIDEO_BITRATE_MODE,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_CBR, 0,\r\nV4L2_MPEG_VIDEO_BITRATE_MODE_VBR);\r\ncxhdl->video_bitrate = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_BITRATE,\r\n0, 27000000, 1, 6000000);\r\ncxhdl->video_bitrate_peak = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_BITRATE_PEAK,\r\n0, 27000000, 1, 8000000);\r\ncx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION, 0, 255, 1, 0);\r\ncxhdl->video_mute = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_MUTE, 0, 1, 1, 0);\r\ncxhdl->video_mute_yuv = cx2341x_ctrl_new_std(hdl,\r\nV4L2_CID_MPEG_VIDEO_MUTE_YUV, 0, 0xffffff, 1, 0x008080);\r\ncxhdl->video_spatial_filter_mode = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE,\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL,\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO, 0,\r\nV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL);\r\ncxhdl->video_spatial_filter = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER,\r\n0, 15, 1, 0);\r\ncxhdl->video_luma_spatial_filter_type = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE,\r\nV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_SYM_NON_SEPARABLE,\r\n0,\r\nV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_1D_HOR);\r\ncxhdl->video_chroma_spatial_filter_type = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE,\r\nV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR,\r\n0,\r\nV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR);\r\ncxhdl->video_temporal_filter_mode = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE,\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL,\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO,\r\n0,\r\nV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL);\r\ncxhdl->video_temporal_filter = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER,\r\n0, 31, 1, 8);\r\ncxhdl->video_median_filter_type = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE,\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF,\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_DIAG,\r\n0,\r\nV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF);\r\ncxhdl->video_luma_median_filter_bottom = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM,\r\n0, 255, 1, 0);\r\ncxhdl->video_luma_median_filter_top = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP,\r\n0, 255, 1, 255);\r\ncxhdl->video_chroma_median_filter_bottom = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM,\r\n0, 255, 1, 0);\r\ncxhdl->video_chroma_median_filter_top = cx2341x_ctrl_new_custom(hdl,\r\nV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP,\r\n0, 255, 1, 255);\r\ncx2341x_ctrl_new_custom(hdl, V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS,\r\n0, 1, 1, 0);\r\nif (hdl->error) {\r\nint err = hdl->error;\r\nv4l2_ctrl_handler_free(hdl);\r\nreturn err;\r\n}\r\nv4l2_ctrl_cluster(8, &cxhdl->audio_sampling_freq);\r\nv4l2_ctrl_cluster(2, &cxhdl->video_b_frames);\r\nv4l2_ctrl_cluster(5, &cxhdl->stream_type);\r\nv4l2_ctrl_cluster(2, &cxhdl->video_mute);\r\nv4l2_ctrl_cluster(3, &cxhdl->video_spatial_filter_mode);\r\nv4l2_ctrl_cluster(2, &cxhdl->video_luma_spatial_filter_type);\r\nv4l2_ctrl_cluster(2, &cxhdl->video_spatial_filter);\r\nv4l2_ctrl_cluster(4, &cxhdl->video_luma_median_filter_top);\r\nreturn 0;\r\n}\r\nvoid cx2341x_handler_set_50hz(struct cx2341x_handler *cxhdl, int is_50hz)\r\n{\r\ncxhdl->is_50hz = is_50hz;\r\ncxhdl->video_gop_size->default_value = cxhdl->is_50hz ? 12 : 15;\r\n}\r\nint cx2341x_handler_setup(struct cx2341x_handler *cxhdl)\r\n{\r\nint h = cxhdl->height;\r\nint w = cxhdl->width;\r\nint err;\r\nerr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_OUTPUT_PORT, 2, cxhdl->port, 0);\r\nif (err)\r\nreturn err;\r\nerr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_FRAME_RATE, 1, cxhdl->is_50hz);\r\nif (err)\r\nreturn err;\r\nif (v4l2_ctrl_g_ctrl(cxhdl->video_encoding) == V4L2_MPEG_VIDEO_ENCODING_MPEG_1) {\r\nw /= 2;\r\nh /= 2;\r\n}\r\nerr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_FRAME_SIZE, 2, h, w);\r\nif (err)\r\nreturn err;\r\nreturn v4l2_ctrl_handler_setup(&cxhdl->hdl);\r\n}\r\nvoid cx2341x_handler_set_busy(struct cx2341x_handler *cxhdl, int busy)\r\n{\r\nv4l2_ctrl_grab(cxhdl->audio_sampling_freq, busy);\r\nv4l2_ctrl_grab(cxhdl->audio_encoding, busy);\r\nv4l2_ctrl_grab(cxhdl->audio_l2_bitrate, busy);\r\nv4l2_ctrl_grab(cxhdl->audio_ac3_bitrate, busy);\r\nv4l2_ctrl_grab(cxhdl->stream_vbi_fmt, busy);\r\nv4l2_ctrl_grab(cxhdl->stream_type, busy);\r\nv4l2_ctrl_grab(cxhdl->video_bitrate_mode, busy);\r\nv4l2_ctrl_grab(cxhdl->video_bitrate, busy);\r\nv4l2_ctrl_grab(cxhdl->video_bitrate_peak, busy);\r\n}

static u16\r\nnvbios_iccsense_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt,\r\nu8 *len)\r\n{\r\nstruct bit_entry bit_P;\r\nu16 iccsense;\r\nif (bit_entry(bios, 'P', &bit_P) || bit_P.version != 2 ||\r\nbit_P.length < 0x2c)\r\nreturn 0;\r\niccsense = nvbios_rd16(bios, bit_P.offset + 0x28);\r\nif (!iccsense)\r\nreturn 0;\r\n*ver = nvbios_rd08(bios, iccsense + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\ncase 0x20:\r\n*hdr = nvbios_rd08(bios, iccsense + 1);\r\n*len = nvbios_rd08(bios, iccsense + 2);\r\n*cnt = nvbios_rd08(bios, iccsense + 3);\r\nreturn iccsense;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nnvbios_iccsense_parse(struct nvkm_bios *bios, struct nvbios_iccsense *iccsense)\r\n{\r\nstruct nvkm_subdev *subdev = &bios->subdev;\r\nu8 ver, hdr, cnt, len, i;\r\nu16 table, entry;\r\ntable = nvbios_iccsense_table(bios, &ver, &hdr, &cnt, &len);\r\nif (!table || !cnt)\r\nreturn -EINVAL;\r\nif (ver != 0x10 && ver != 0x20) {\r\nnvkm_error(subdev, "ICCSENSE version 0x%02x unknown\n", ver);\r\nreturn -EINVAL;\r\n}\r\niccsense->nr_entry = cnt;\r\niccsense->rail = kmalloc(sizeof(struct pwr_rail_t) * cnt, GFP_KERNEL);\r\nif (!iccsense->rail)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < cnt; ++i) {\r\nstruct pwr_rail_t *rail = &iccsense->rail[i];\r\nentry = table + hdr + i * len;\r\nswitch(ver) {\r\ncase 0x10:\r\nrail->mode = nvbios_rd08(bios, entry + 0x1);\r\nrail->extdev_id = nvbios_rd08(bios, entry + 0x2);\r\nrail->resistor_mohm = nvbios_rd08(bios, entry + 0x3);\r\nrail->rail = nvbios_rd08(bios, entry + 0x4);\r\nbreak;\r\ncase 0x20:\r\nrail->mode = nvbios_rd08(bios, entry);\r\nrail->extdev_id = nvbios_rd08(bios, entry + 0x1);\r\nrail->resistor_mohm = nvbios_rd08(bios, entry + 0x5);\r\nrail->rail = nvbios_rd08(bios, entry + 0x6);\r\nbreak;\r\n};\r\n}\r\nreturn 0;\r\n}

static void regdump(struct net_device *dev)\r\n{\r\n#ifdef DEBUG\r\nint ioaddr = dev->base_addr;\r\nint count;\r\nnetdev_dbg(dev, "register dump:\n");\r\nfor (count = 0; count < 16; count++) {\r\nif (!(count % 16))\r\npr_cont("%04X:", ioaddr + count);\r\npr_cont(" %02X", arcnet_inb(ioaddr, count));\r\n}\r\npr_cont("\n");\r\nnetdev_dbg(dev, "buffer0 dump:\n");\r\ncount = 0;\r\narcnet_outb((count >> 8) | RDDATAflag | AUTOINCflag,\r\nioaddr, com20020_REG_W_ADDR_HI);\r\narcnet_outb(count & 0xff, ioaddr, COM20020_REG_W_ADDR_LO);\r\nfor (count = 0; count < 256 + 32; count++) {\r\nif (!(count % 16))\r\npr_cont("%04X:", count);\r\npr_cont(" %02X", arcnet_inb(ioaddr, COM20020_REG_RW_MEMDATA));\r\n}\r\npr_cont("\n");\r\n#endif\r\n}\r\nstatic int com20020_probe(struct pcmcia_device *p_dev)\r\n{\r\nstruct com20020_dev *info;\r\nstruct net_device *dev;\r\nstruct arcnet_local *lp;\r\ndev_dbg(&p_dev->dev, "com20020_attach()\n");\r\ninfo = kzalloc(sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\ngoto fail_alloc_info;\r\ndev = alloc_arcdev("");\r\nif (!dev)\r\ngoto fail_alloc_dev;\r\nlp = netdev_priv(dev);\r\nlp->timeout = timeout;\r\nlp->backplane = backplane;\r\nlp->clockp = clockp;\r\nlp->clockm = clockm & 3;\r\nlp->hw.owner = THIS_MODULE;\r\ndev->dev_addr[0] = node;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\np_dev->resource[0]->end = 16;\r\np_dev->config_flags |= CONF_ENABLE_IRQ;\r\ninfo->dev = dev;\r\np_dev->priv = info;\r\nreturn com20020_config(p_dev);\r\nfail_alloc_dev:\r\nkfree(info);\r\nfail_alloc_info:\r\nreturn -ENOMEM;\r\n}\r\nstatic void com20020_detach(struct pcmcia_device *link)\r\n{\r\nstruct com20020_dev *info = link->priv;\r\nstruct net_device *dev = info->dev;\r\ndev_dbg(&link->dev, "detach...\n");\r\ndev_dbg(&link->dev, "com20020_detach\n");\r\ndev_dbg(&link->dev, "unregister...\n");\r\nunregister_netdev(dev);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\ncom20020_release(link);\r\ndev_dbg(&link->dev, "unlinking...\n");\r\nif (link->priv) {\r\ndev = info->dev;\r\nif (dev) {\r\ndev_dbg(&link->dev, "kfree...\n");\r\nfree_netdev(dev);\r\n}\r\ndev_dbg(&link->dev, "kfree2...\n");\r\nkfree(info);\r\n}\r\n}\r\nstatic int com20020_config(struct pcmcia_device *link)\r\n{\r\nstruct arcnet_local *lp;\r\nstruct com20020_dev *info;\r\nstruct net_device *dev;\r\nint i, ret;\r\nint ioaddr;\r\ninfo = link->priv;\r\ndev = info->dev;\r\ndev_dbg(&link->dev, "config...\n");\r\ndev_dbg(&link->dev, "com20020_config\n");\r\ndev_dbg(&link->dev, "baseport1 is %Xh\n",\r\n(unsigned int)link->resource[0]->start);\r\ni = -ENODEV;\r\nlink->io_lines = 16;\r\nif (!link->resource[0]->start) {\r\nfor (ioaddr = 0x100; ioaddr < 0x400; ioaddr += 0x10) {\r\nlink->resource[0]->start = ioaddr;\r\ni = pcmcia_request_io(link);\r\nif (i == 0)\r\nbreak;\r\n}\r\n} else {\r\ni = pcmcia_request_io(link);\r\n}\r\nif (i != 0) {\r\ndev_dbg(&link->dev, "requestIO failed totally!\n");\r\ngoto failed;\r\n}\r\nioaddr = dev->base_addr = link->resource[0]->start;\r\ndev_dbg(&link->dev, "got ioaddr %Xh\n", ioaddr);\r\ndev_dbg(&link->dev, "request IRQ %d\n",\r\nlink->irq);\r\nif (!link->irq) {\r\ndev_dbg(&link->dev, "requestIRQ failed totally!\n");\r\ngoto failed;\r\n}\r\ndev->irq = link->irq;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nif (com20020_check(dev)) {\r\nregdump(dev);\r\ngoto failed;\r\n}\r\nlp = netdev_priv(dev);\r\nlp->card_name = "PCMCIA COM20020";\r\nlp->card_flags = ARC_CAN_10MBIT;\r\nSET_NETDEV_DEV(dev, &link->dev);\r\ni = com20020_found(dev, 0);\r\nif (i != 0) {\r\ndev_notice(&link->dev,\r\n"com20020_found() failed\n");\r\ngoto failed;\r\n}\r\nnetdev_dbg(dev, "port %#3lx, irq %d\n",\r\ndev->base_addr, dev->irq);\r\nreturn 0;\r\nfailed:\r\ndev_dbg(&link->dev, "com20020_config failed...\n");\r\ncom20020_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void com20020_release(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "com20020_release\n");\r\npcmcia_disable_device(link);\r\n}\r\nstatic int com20020_suspend(struct pcmcia_device *link)\r\n{\r\nstruct com20020_dev *info = link->priv;\r\nstruct net_device *dev = info->dev;\r\nif (link->open)\r\nnetif_device_detach(dev);\r\nreturn 0;\r\n}\r\nstatic int com20020_resume(struct pcmcia_device *link)\r\n{\r\nstruct com20020_dev *info = link->priv;\r\nstruct net_device *dev = info->dev;\r\nif (link->open) {\r\nint ioaddr = dev->base_addr;\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\narcnet_outb(lp->config | 0x80, ioaddr, COM20020_REG_W_CONFIG);\r\nudelay(5);\r\narcnet_outb(lp->config, ioaddr, COM20020_REG_W_CONFIG);\r\n}\r\nreturn 0;\r\n}

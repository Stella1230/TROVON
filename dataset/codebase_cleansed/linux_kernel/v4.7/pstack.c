struct pstack *pstack__new(unsigned short max_nr_entries)\r\n{\r\nstruct pstack *pstack = zalloc((sizeof(*pstack) +\r\nmax_nr_entries * sizeof(void *)));\r\nif (pstack != NULL)\r\npstack->max_nr_entries = max_nr_entries;\r\nreturn pstack;\r\n}\r\nvoid pstack__delete(struct pstack *pstack)\r\n{\r\nfree(pstack);\r\n}\r\nbool pstack__empty(const struct pstack *pstack)\r\n{\r\nreturn pstack->top == 0;\r\n}\r\nvoid pstack__remove(struct pstack *pstack, void *key)\r\n{\r\nunsigned short i = pstack->top, last_index = pstack->top - 1;\r\nwhile (i-- != 0) {\r\nif (pstack->entries[i] == key) {\r\nif (i < last_index)\r\nmemmove(pstack->entries + i,\r\npstack->entries + i + 1,\r\n(last_index - i) * sizeof(void *));\r\n--pstack->top;\r\nreturn;\r\n}\r\n}\r\npr_err("%s: %p not on the pstack!\n", __func__, key);\r\n}\r\nvoid pstack__push(struct pstack *pstack, void *key)\r\n{\r\nif (pstack->top == pstack->max_nr_entries) {\r\npr_err("%s: top=%d, overflow!\n", __func__, pstack->top);\r\nreturn;\r\n}\r\npstack->entries[pstack->top++] = key;\r\n}\r\nvoid *pstack__pop(struct pstack *pstack)\r\n{\r\nvoid *ret;\r\nif (pstack->top == 0) {\r\npr_err("%s: underflow!\n", __func__);\r\nreturn NULL;\r\n}\r\nret = pstack->entries[--pstack->top];\r\npstack->entries[pstack->top] = NULL;\r\nreturn ret;\r\n}\r\nvoid *pstack__peek(struct pstack *pstack)\r\n{\r\nif (pstack->top == 0)\r\nreturn NULL;\r\nreturn pstack->entries[pstack->top - 1];\r\n}

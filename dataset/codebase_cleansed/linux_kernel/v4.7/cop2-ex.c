void nlm_cop2_save(struct nlm_cop2_state *r)\r\n{\r\nasm volatile(\r\n".set push\n"\r\n".set noat\n"\r\n"dmfc2 $1, $0, 0\n"\r\n"sd $1, 0(%1)\n"\r\n"dmfc2 $1, $0, 1\n"\r\n"sd $1, 8(%1)\n"\r\n"dmfc2 $1, $0, 2\n"\r\n"sd $1, 16(%1)\n"\r\n"dmfc2 $1, $0, 3\n"\r\n"sd $1, 24(%1)\n"\r\n"dmfc2 $1, $1, 0\n"\r\n"sd $1, 0(%2)\n"\r\n"dmfc2 $1, $1, 1\n"\r\n"sd $1, 8(%2)\n"\r\n"dmfc2 $1, $1, 2\n"\r\n"sd $1, 16(%2)\n"\r\n"dmfc2 $1, $1, 3\n"\r\n"sd $1, 24(%2)\n"\r\n".set pop\n"\r\n: "=m"(*r)\r\n: "r"(r->tx), "r"(r->rx));\r\nr->tx_msg_status = __read_32bit_c2_register($2, 0);\r\nr->rx_msg_status = __read_32bit_c2_register($3, 0) & 0x0fffffff;\r\n}\r\nvoid nlm_cop2_restore(struct nlm_cop2_state *r)\r\n{\r\nu32 rstat;\r\nasm volatile(\r\n".set push\n"\r\n".set noat\n"\r\n"ld $1, 0(%1)\n"\r\n"dmtc2 $1, $0, 0\n"\r\n"ld $1, 8(%1)\n"\r\n"dmtc2 $1, $0, 1\n"\r\n"ld $1, 16(%1)\n"\r\n"dmtc2 $1, $0, 2\n"\r\n"ld $1, 24(%1)\n"\r\n"dmtc2 $1, $0, 3\n"\r\n"ld $1, 0(%2)\n"\r\n"dmtc2 $1, $1, 0\n"\r\n"ld $1, 8(%2)\n"\r\n"dmtc2 $1, $1, 1\n"\r\n"ld $1, 16(%2)\n"\r\n"dmtc2 $1, $1, 2\n"\r\n"ld $1, 24(%2)\n"\r\n"dmtc2 $1, $1, 3\n"\r\n".set pop\n"\r\n: : "m"(*r), "r"(r->tx), "r"(r->rx));\r\n__write_32bit_c2_register($2, 0, r->tx_msg_status);\r\nrstat = __read_32bit_c2_register($3, 0) & 0xf0000000u;\r\n__write_32bit_c2_register($3, 0, r->rx_msg_status | rstat);\r\n}\r\nstatic int nlm_cu2_call(struct notifier_block *nfb, unsigned long action,\r\nvoid *data)\r\n{\r\nunsigned long flags;\r\nunsigned int status;\r\nswitch (action) {\r\ncase CU2_EXCEPTION:\r\nif (!capable(CAP_SYS_ADMIN) || !capable(CAP_SYS_RAWIO))\r\nbreak;\r\nlocal_irq_save(flags);\r\nKSTK_STATUS(current) |= ST0_CU2;\r\nstatus = read_c0_status();\r\nwrite_c0_status(status | ST0_CU2);\r\nnlm_cop2_restore(&(current->thread.cp2));\r\nwrite_c0_status(status & ~ST0_CU2);\r\nlocal_irq_restore(flags);\r\npr_info("COP2 access enabled for pid %d (%s)\n",\r\ncurrent->pid, current->comm);\r\nreturn NOTIFY_BAD;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init nlm_cu2_setup(void)\r\n{\r\nreturn cu2_notifier(nlm_cu2_call, 0);\r\n}

static irqreturn_t dw_plat_pcie_msi_irq_handler(int irq, void *arg)\r\n{\r\nstruct pcie_port *pp = arg;\r\nreturn dw_handle_msi_irq(pp);\r\n}\r\nstatic void dw_plat_pcie_host_init(struct pcie_port *pp)\r\n{\r\ndw_pcie_setup_rc(pp);\r\ndw_pcie_wait_for_link(pp);\r\nif (IS_ENABLED(CONFIG_PCI_MSI))\r\ndw_pcie_msi_init(pp);\r\n}\r\nstatic int dw_plat_add_pcie_port(struct pcie_port *pp,\r\nstruct platform_device *pdev)\r\n{\r\nint ret;\r\npp->irq = platform_get_irq(pdev, 1);\r\nif (pp->irq < 0)\r\nreturn pp->irq;\r\nif (IS_ENABLED(CONFIG_PCI_MSI)) {\r\npp->msi_irq = platform_get_irq(pdev, 0);\r\nif (pp->msi_irq < 0)\r\nreturn pp->msi_irq;\r\nret = devm_request_irq(&pdev->dev, pp->msi_irq,\r\ndw_plat_pcie_msi_irq_handler,\r\nIRQF_SHARED, "dw-plat-pcie-msi", pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request MSI IRQ\n");\r\nreturn ret;\r\n}\r\n}\r\npp->root_bus_nr = -1;\r\npp->ops = &dw_plat_pcie_host_ops;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dw_plat_pcie_probe(struct platform_device *pdev)\r\n{\r\nstruct dw_plat_pcie *dw_plat_pcie;\r\nstruct pcie_port *pp;\r\nstruct resource *res;\r\nint ret;\r\ndw_plat_pcie = devm_kzalloc(&pdev->dev, sizeof(*dw_plat_pcie),\r\nGFP_KERNEL);\r\nif (!dw_plat_pcie)\r\nreturn -ENOMEM;\r\npp = &dw_plat_pcie->pp;\r\npp->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ndw_plat_pcie->mem_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dw_plat_pcie->mem_base))\r\nreturn PTR_ERR(dw_plat_pcie->mem_base);\r\npp->dbi_base = dw_plat_pcie->mem_base;\r\nret = dw_plat_add_pcie_port(pp, pdev);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, dw_plat_pcie);\r\nreturn 0;\r\n}

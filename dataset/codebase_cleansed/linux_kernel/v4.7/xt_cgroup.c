static int cgroup_mt_check_v0(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_cgroup_info_v0 *info = par->matchinfo;\r\nif (info->invert & ~1)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cgroup_mt_check_v1(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_cgroup_info_v1 *info = par->matchinfo;\r\nstruct cgroup *cgrp;\r\nif ((info->invert_path & ~1) || (info->invert_classid & ~1))\r\nreturn -EINVAL;\r\nif (!info->has_path && !info->has_classid) {\r\npr_info("xt_cgroup: no path or classid specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->has_path && info->has_classid) {\r\npr_info("xt_cgroup: both path and classid specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->has_path) {\r\ncgrp = cgroup_get_from_path(info->path);\r\nif (IS_ERR(cgrp)) {\r\npr_info("xt_cgroup: invalid path, errno=%ld\n",\r\nPTR_ERR(cgrp));\r\nreturn -EINVAL;\r\n}\r\ninfo->priv = cgrp;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool\r\ncgroup_mt_v0(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_cgroup_info_v0 *info = par->matchinfo;\r\nif (skb->sk == NULL || !sk_fullsock(skb->sk))\r\nreturn false;\r\nreturn (info->id == sock_cgroup_classid(&skb->sk->sk_cgrp_data)) ^\r\ninfo->invert;\r\n}\r\nstatic bool cgroup_mt_v1(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_cgroup_info_v1 *info = par->matchinfo;\r\nstruct sock_cgroup_data *skcd = &skb->sk->sk_cgrp_data;\r\nstruct cgroup *ancestor = info->priv;\r\nif (!skb->sk || !sk_fullsock(skb->sk))\r\nreturn false;\r\nif (ancestor)\r\nreturn cgroup_is_descendant(sock_cgroup_ptr(skcd), ancestor) ^\r\ninfo->invert_path;\r\nelse\r\nreturn (info->classid == sock_cgroup_classid(skcd)) ^\r\ninfo->invert_classid;\r\n}\r\nstatic void cgroup_mt_destroy_v1(const struct xt_mtdtor_param *par)\r\n{\r\nstruct xt_cgroup_info_v1 *info = par->matchinfo;\r\nif (info->priv)\r\ncgroup_put(info->priv);\r\n}\r\nstatic int __init cgroup_mt_init(void)\r\n{\r\nreturn xt_register_matches(cgroup_mt_reg, ARRAY_SIZE(cgroup_mt_reg));\r\n}\r\nstatic void __exit cgroup_mt_exit(void)\r\n{\r\nxt_unregister_matches(cgroup_mt_reg, ARRAY_SIZE(cgroup_mt_reg));\r\n}

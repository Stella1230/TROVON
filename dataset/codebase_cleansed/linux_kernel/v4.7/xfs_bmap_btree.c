STATIC xfs_exntst_t\r\nxfs_extent_state(\r\nxfs_filblks_t blks,\r\nint extent_flag)\r\n{\r\nif (extent_flag) {\r\nASSERT(blks != 0);\r\nreturn XFS_EXT_UNWRITTEN;\r\n}\r\nreturn XFS_EXT_NORM;\r\n}\r\nvoid\r\nxfs_bmdr_to_bmbt(\r\nstruct xfs_inode *ip,\r\nxfs_bmdr_block_t *dblock,\r\nint dblocklen,\r\nstruct xfs_btree_block *rblock,\r\nint rblocklen)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nint dmxr;\r\nxfs_bmbt_key_t *fkp;\r\n__be64 *fpp;\r\nxfs_bmbt_key_t *tkp;\r\n__be64 *tpp;\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\nxfs_btree_init_block_int(mp, rblock, XFS_BUF_DADDR_NULL,\r\nXFS_BMAP_CRC_MAGIC, 0, 0, ip->i_ino,\r\nXFS_BTREE_LONG_PTRS | XFS_BTREE_CRC_BLOCKS);\r\nelse\r\nxfs_btree_init_block_int(mp, rblock, XFS_BUF_DADDR_NULL,\r\nXFS_BMAP_MAGIC, 0, 0, ip->i_ino,\r\nXFS_BTREE_LONG_PTRS);\r\nrblock->bb_level = dblock->bb_level;\r\nASSERT(be16_to_cpu(rblock->bb_level) > 0);\r\nrblock->bb_numrecs = dblock->bb_numrecs;\r\ndmxr = xfs_bmdr_maxrecs(dblocklen, 0);\r\nfkp = XFS_BMDR_KEY_ADDR(dblock, 1);\r\ntkp = XFS_BMBT_KEY_ADDR(mp, rblock, 1);\r\nfpp = XFS_BMDR_PTR_ADDR(dblock, 1, dmxr);\r\ntpp = XFS_BMAP_BROOT_PTR_ADDR(mp, rblock, 1, rblocklen);\r\ndmxr = be16_to_cpu(dblock->bb_numrecs);\r\nmemcpy(tkp, fkp, sizeof(*fkp) * dmxr);\r\nmemcpy(tpp, fpp, sizeof(*fpp) * dmxr);\r\n}\r\nSTATIC void\r\n__xfs_bmbt_get_all(\r\n__uint64_t l0,\r\n__uint64_t l1,\r\nxfs_bmbt_irec_t *s)\r\n{\r\nint ext_flag;\r\nxfs_exntst_t st;\r\next_flag = (int)(l0 >> (64 - BMBT_EXNTFLAG_BITLEN));\r\ns->br_startoff = ((xfs_fileoff_t)l0 &\r\nxfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN)) >> 9;\r\ns->br_startblock = (((xfs_fsblock_t)l0 & xfs_mask64lo(9)) << 43) |\r\n(((xfs_fsblock_t)l1) >> 21);\r\ns->br_blockcount = (xfs_filblks_t)(l1 & xfs_mask64lo(21));\r\nif (ext_flag) {\r\nASSERT(s->br_blockcount != 0);\r\nst = XFS_EXT_UNWRITTEN;\r\n} else\r\nst = XFS_EXT_NORM;\r\ns->br_state = st;\r\n}\r\nvoid\r\nxfs_bmbt_get_all(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_bmbt_irec_t *s)\r\n{\r\n__xfs_bmbt_get_all(r->l0, r->l1, s);\r\n}\r\nxfs_filblks_t\r\nxfs_bmbt_get_blockcount(\r\nxfs_bmbt_rec_host_t *r)\r\n{\r\nreturn (xfs_filblks_t)(r->l1 & xfs_mask64lo(21));\r\n}\r\nxfs_fsblock_t\r\nxfs_bmbt_get_startblock(\r\nxfs_bmbt_rec_host_t *r)\r\n{\r\nreturn (((xfs_fsblock_t)r->l0 & xfs_mask64lo(9)) << 43) |\r\n(((xfs_fsblock_t)r->l1) >> 21);\r\n}\r\nxfs_fileoff_t\r\nxfs_bmbt_get_startoff(\r\nxfs_bmbt_rec_host_t *r)\r\n{\r\nreturn ((xfs_fileoff_t)r->l0 &\r\nxfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN)) >> 9;\r\n}\r\nxfs_exntst_t\r\nxfs_bmbt_get_state(\r\nxfs_bmbt_rec_host_t *r)\r\n{\r\nint ext_flag;\r\next_flag = (int)((r->l0) >> (64 - BMBT_EXNTFLAG_BITLEN));\r\nreturn xfs_extent_state(xfs_bmbt_get_blockcount(r),\r\next_flag);\r\n}\r\nxfs_filblks_t\r\nxfs_bmbt_disk_get_blockcount(\r\nxfs_bmbt_rec_t *r)\r\n{\r\nreturn (xfs_filblks_t)(be64_to_cpu(r->l1) & xfs_mask64lo(21));\r\n}\r\nxfs_fileoff_t\r\nxfs_bmbt_disk_get_startoff(\r\nxfs_bmbt_rec_t *r)\r\n{\r\nreturn ((xfs_fileoff_t)be64_to_cpu(r->l0) &\r\nxfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN)) >> 9;\r\n}\r\nvoid\r\nxfs_bmbt_set_allf(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_fileoff_t startoff,\r\nxfs_fsblock_t startblock,\r\nxfs_filblks_t blockcount,\r\nxfs_exntst_t state)\r\n{\r\nint extent_flag = (state == XFS_EXT_NORM) ? 0 : 1;\r\nASSERT(state == XFS_EXT_NORM || state == XFS_EXT_UNWRITTEN);\r\nASSERT((startoff & xfs_mask64hi(64-BMBT_STARTOFF_BITLEN)) == 0);\r\nASSERT((blockcount & xfs_mask64hi(64-BMBT_BLOCKCOUNT_BITLEN)) == 0);\r\nASSERT((startblock & xfs_mask64hi(64-BMBT_STARTBLOCK_BITLEN)) == 0);\r\nr->l0 = ((xfs_bmbt_rec_base_t)extent_flag << 63) |\r\n((xfs_bmbt_rec_base_t)startoff << 9) |\r\n((xfs_bmbt_rec_base_t)startblock >> 43);\r\nr->l1 = ((xfs_bmbt_rec_base_t)startblock << 21) |\r\n((xfs_bmbt_rec_base_t)blockcount &\r\n(xfs_bmbt_rec_base_t)xfs_mask64lo(21));\r\n}\r\nvoid\r\nxfs_bmbt_set_all(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_bmbt_irec_t *s)\r\n{\r\nxfs_bmbt_set_allf(r, s->br_startoff, s->br_startblock,\r\ns->br_blockcount, s->br_state);\r\n}\r\nvoid\r\nxfs_bmbt_disk_set_allf(\r\nxfs_bmbt_rec_t *r,\r\nxfs_fileoff_t startoff,\r\nxfs_fsblock_t startblock,\r\nxfs_filblks_t blockcount,\r\nxfs_exntst_t state)\r\n{\r\nint extent_flag = (state == XFS_EXT_NORM) ? 0 : 1;\r\nASSERT(state == XFS_EXT_NORM || state == XFS_EXT_UNWRITTEN);\r\nASSERT((startoff & xfs_mask64hi(64-BMBT_STARTOFF_BITLEN)) == 0);\r\nASSERT((blockcount & xfs_mask64hi(64-BMBT_BLOCKCOUNT_BITLEN)) == 0);\r\nASSERT((startblock & xfs_mask64hi(64-BMBT_STARTBLOCK_BITLEN)) == 0);\r\nr->l0 = cpu_to_be64(\r\n((xfs_bmbt_rec_base_t)extent_flag << 63) |\r\n((xfs_bmbt_rec_base_t)startoff << 9) |\r\n((xfs_bmbt_rec_base_t)startblock >> 43));\r\nr->l1 = cpu_to_be64(\r\n((xfs_bmbt_rec_base_t)startblock << 21) |\r\n((xfs_bmbt_rec_base_t)blockcount &\r\n(xfs_bmbt_rec_base_t)xfs_mask64lo(21)));\r\n}\r\nSTATIC void\r\nxfs_bmbt_disk_set_all(\r\nxfs_bmbt_rec_t *r,\r\nxfs_bmbt_irec_t *s)\r\n{\r\nxfs_bmbt_disk_set_allf(r, s->br_startoff, s->br_startblock,\r\ns->br_blockcount, s->br_state);\r\n}\r\nvoid\r\nxfs_bmbt_set_blockcount(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_filblks_t v)\r\n{\r\nASSERT((v & xfs_mask64hi(43)) == 0);\r\nr->l1 = (r->l1 & (xfs_bmbt_rec_base_t)xfs_mask64hi(43)) |\r\n(xfs_bmbt_rec_base_t)(v & xfs_mask64lo(21));\r\n}\r\nvoid\r\nxfs_bmbt_set_startblock(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_fsblock_t v)\r\n{\r\nASSERT((v & xfs_mask64hi(12)) == 0);\r\nr->l0 = (r->l0 & (xfs_bmbt_rec_base_t)xfs_mask64hi(55)) |\r\n(xfs_bmbt_rec_base_t)(v >> 43);\r\nr->l1 = (r->l1 & (xfs_bmbt_rec_base_t)xfs_mask64lo(21)) |\r\n(xfs_bmbt_rec_base_t)(v << 21);\r\n}\r\nvoid\r\nxfs_bmbt_set_startoff(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_fileoff_t v)\r\n{\r\nASSERT((v & xfs_mask64hi(9)) == 0);\r\nr->l0 = (r->l0 & (xfs_bmbt_rec_base_t) xfs_mask64hi(1)) |\r\n((xfs_bmbt_rec_base_t)v << 9) |\r\n(r->l0 & (xfs_bmbt_rec_base_t)xfs_mask64lo(9));\r\n}\r\nvoid\r\nxfs_bmbt_set_state(\r\nxfs_bmbt_rec_host_t *r,\r\nxfs_exntst_t v)\r\n{\r\nASSERT(v == XFS_EXT_NORM || v == XFS_EXT_UNWRITTEN);\r\nif (v == XFS_EXT_NORM)\r\nr->l0 &= xfs_mask64lo(64 - BMBT_EXNTFLAG_BITLEN);\r\nelse\r\nr->l0 |= xfs_mask64hi(BMBT_EXNTFLAG_BITLEN);\r\n}\r\nvoid\r\nxfs_bmbt_to_bmdr(\r\nstruct xfs_mount *mp,\r\nstruct xfs_btree_block *rblock,\r\nint rblocklen,\r\nxfs_bmdr_block_t *dblock,\r\nint dblocklen)\r\n{\r\nint dmxr;\r\nxfs_bmbt_key_t *fkp;\r\n__be64 *fpp;\r\nxfs_bmbt_key_t *tkp;\r\n__be64 *tpp;\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nASSERT(rblock->bb_magic == cpu_to_be32(XFS_BMAP_CRC_MAGIC));\r\nASSERT(uuid_equal(&rblock->bb_u.l.bb_uuid,\r\n&mp->m_sb.sb_meta_uuid));\r\nASSERT(rblock->bb_u.l.bb_blkno ==\r\ncpu_to_be64(XFS_BUF_DADDR_NULL));\r\n} else\r\nASSERT(rblock->bb_magic == cpu_to_be32(XFS_BMAP_MAGIC));\r\nASSERT(rblock->bb_u.l.bb_leftsib == cpu_to_be64(NULLFSBLOCK));\r\nASSERT(rblock->bb_u.l.bb_rightsib == cpu_to_be64(NULLFSBLOCK));\r\nASSERT(rblock->bb_level != 0);\r\ndblock->bb_level = rblock->bb_level;\r\ndblock->bb_numrecs = rblock->bb_numrecs;\r\ndmxr = xfs_bmdr_maxrecs(dblocklen, 0);\r\nfkp = XFS_BMBT_KEY_ADDR(mp, rblock, 1);\r\ntkp = XFS_BMDR_KEY_ADDR(dblock, 1);\r\nfpp = XFS_BMAP_BROOT_PTR_ADDR(mp, rblock, 1, rblocklen);\r\ntpp = XFS_BMDR_PTR_ADDR(dblock, 1, dmxr);\r\ndmxr = be16_to_cpu(dblock->bb_numrecs);\r\nmemcpy(tkp, fkp, sizeof(*fkp) * dmxr);\r\nmemcpy(tpp, fpp, sizeof(*fpp) * dmxr);\r\n}\r\nint\r\nxfs_check_nostate_extents(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx,\r\nxfs_extnum_t num)\r\n{\r\nfor (; num > 0; num--, idx++) {\r\nxfs_bmbt_rec_host_t *ep = xfs_iext_get_ext(ifp, idx);\r\nif ((ep->l0 >>\r\n(64 - BMBT_EXNTFLAG_BITLEN)) != 0) {\r\nASSERT(0);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nSTATIC struct xfs_btree_cur *\r\nxfs_bmbt_dup_cursor(\r\nstruct xfs_btree_cur *cur)\r\n{\r\nstruct xfs_btree_cur *new;\r\nnew = xfs_bmbt_init_cursor(cur->bc_mp, cur->bc_tp,\r\ncur->bc_private.b.ip, cur->bc_private.b.whichfork);\r\nnew->bc_private.b.firstblock = cur->bc_private.b.firstblock;\r\nnew->bc_private.b.flist = cur->bc_private.b.flist;\r\nnew->bc_private.b.flags = cur->bc_private.b.flags;\r\nreturn new;\r\n}\r\nSTATIC void\r\nxfs_bmbt_update_cursor(\r\nstruct xfs_btree_cur *src,\r\nstruct xfs_btree_cur *dst)\r\n{\r\nASSERT((dst->bc_private.b.firstblock != NULLFSBLOCK) ||\r\n(dst->bc_private.b.ip->i_d.di_flags & XFS_DIFLAG_REALTIME));\r\nASSERT(dst->bc_private.b.flist == src->bc_private.b.flist);\r\ndst->bc_private.b.allocated += src->bc_private.b.allocated;\r\ndst->bc_private.b.firstblock = src->bc_private.b.firstblock;\r\nsrc->bc_private.b.allocated = 0;\r\n}\r\nSTATIC int\r\nxfs_bmbt_alloc_block(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *start,\r\nunion xfs_btree_ptr *new,\r\nint *stat)\r\n{\r\nxfs_alloc_arg_t args;\r\nint error;\r\nmemset(&args, 0, sizeof(args));\r\nargs.tp = cur->bc_tp;\r\nargs.mp = cur->bc_mp;\r\nargs.fsbno = cur->bc_private.b.firstblock;\r\nargs.firstblock = args.fsbno;\r\nif (args.fsbno == NULLFSBLOCK) {\r\nargs.fsbno = be64_to_cpu(start->l);\r\nargs.type = XFS_ALLOCTYPE_START_BNO;\r\nargs.minleft = args.tp->t_blk_res;\r\n} else if (cur->bc_private.b.flist->xbf_low) {\r\nargs.type = XFS_ALLOCTYPE_START_BNO;\r\n} else {\r\nargs.type = XFS_ALLOCTYPE_NEAR_BNO;\r\n}\r\nargs.minlen = args.maxlen = args.prod = 1;\r\nargs.wasdel = cur->bc_private.b.flags & XFS_BTCUR_BPRV_WASDEL;\r\nif (!args.wasdel && args.tp->t_blk_res == 0) {\r\nerror = -ENOSPC;\r\ngoto error0;\r\n}\r\nerror = xfs_alloc_vextent(&args);\r\nif (error)\r\ngoto error0;\r\nif (args.fsbno == NULLFSBLOCK && args.minleft) {\r\nargs.fsbno = 0;\r\nargs.type = XFS_ALLOCTYPE_FIRST_AG;\r\nargs.minleft = 0;\r\nerror = xfs_alloc_vextent(&args);\r\nif (error)\r\ngoto error0;\r\ncur->bc_private.b.flist->xbf_low = 1;\r\n}\r\nif (args.fsbno == NULLFSBLOCK) {\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 0;\r\nreturn 0;\r\n}\r\nASSERT(args.len == 1);\r\ncur->bc_private.b.firstblock = args.fsbno;\r\ncur->bc_private.b.allocated++;\r\ncur->bc_private.b.ip->i_d.di_nblocks++;\r\nxfs_trans_log_inode(args.tp, cur->bc_private.b.ip, XFS_ILOG_CORE);\r\nxfs_trans_mod_dquot_byino(args.tp, cur->bc_private.b.ip,\r\nXFS_TRANS_DQ_BCOUNT, 1L);\r\nnew->l = cpu_to_be64(args.fsbno);\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_EXIT);\r\n*stat = 1;\r\nreturn 0;\r\nerror0:\r\nXFS_BTREE_TRACE_CURSOR(cur, XBT_ERROR);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_bmbt_free_block(\r\nstruct xfs_btree_cur *cur,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = cur->bc_mp;\r\nstruct xfs_inode *ip = cur->bc_private.b.ip;\r\nstruct xfs_trans *tp = cur->bc_tp;\r\nxfs_fsblock_t fsbno = XFS_DADDR_TO_FSB(mp, XFS_BUF_ADDR(bp));\r\nxfs_bmap_add_free(fsbno, 1, cur->bc_private.b.flist, mp);\r\nip->i_d.di_nblocks--;\r\nxfs_trans_log_inode(tp, ip, XFS_ILOG_CORE);\r\nxfs_trans_mod_dquot_byino(tp, ip, XFS_TRANS_DQ_BCOUNT, -1L);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_bmbt_get_minrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nif (level == cur->bc_nlevels - 1) {\r\nstruct xfs_ifork *ifp;\r\nifp = XFS_IFORK_PTR(cur->bc_private.b.ip,\r\ncur->bc_private.b.whichfork);\r\nreturn xfs_bmbt_maxrecs(cur->bc_mp,\r\nifp->if_broot_bytes, level == 0) / 2;\r\n}\r\nreturn cur->bc_mp->m_bmap_dmnr[level != 0];\r\n}\r\nint\r\nxfs_bmbt_get_maxrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nif (level == cur->bc_nlevels - 1) {\r\nstruct xfs_ifork *ifp;\r\nifp = XFS_IFORK_PTR(cur->bc_private.b.ip,\r\ncur->bc_private.b.whichfork);\r\nreturn xfs_bmbt_maxrecs(cur->bc_mp,\r\nifp->if_broot_bytes, level == 0);\r\n}\r\nreturn cur->bc_mp->m_bmap_dmxr[level != 0];\r\n}\r\nSTATIC int\r\nxfs_bmbt_get_dmaxrecs(\r\nstruct xfs_btree_cur *cur,\r\nint level)\r\n{\r\nif (level != cur->bc_nlevels - 1)\r\nreturn cur->bc_mp->m_bmap_dmxr[level != 0];\r\nreturn xfs_bmdr_maxrecs(cur->bc_private.b.forksize, level == 0);\r\n}\r\nSTATIC void\r\nxfs_bmbt_init_key_from_rec(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nkey->bmbt.br_startoff =\r\ncpu_to_be64(xfs_bmbt_disk_get_startoff(&rec->bmbt));\r\n}\r\nSTATIC void\r\nxfs_bmbt_init_rec_from_key(\r\nunion xfs_btree_key *key,\r\nunion xfs_btree_rec *rec)\r\n{\r\nASSERT(key->bmbt.br_startoff != 0);\r\nxfs_bmbt_disk_set_allf(&rec->bmbt, be64_to_cpu(key->bmbt.br_startoff),\r\n0, 0, XFS_EXT_NORM);\r\n}\r\nSTATIC void\r\nxfs_bmbt_init_rec_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *rec)\r\n{\r\nxfs_bmbt_disk_set_all(&rec->bmbt, &cur->bc_rec.b);\r\n}\r\nSTATIC void\r\nxfs_bmbt_init_ptr_from_cur(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_ptr *ptr)\r\n{\r\nptr->l = 0;\r\n}\r\nSTATIC __int64_t\r\nxfs_bmbt_key_diff(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *key)\r\n{\r\nreturn (__int64_t)be64_to_cpu(key->bmbt.br_startoff) -\r\ncur->bc_rec.b.br_startoff;\r\n}\r\nstatic bool\r\nxfs_bmbt_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_btree_block *block = XFS_BUF_TO_BLOCK(bp);\r\nunsigned int level;\r\nswitch (block->bb_magic) {\r\ncase cpu_to_be32(XFS_BMAP_CRC_MAGIC):\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn false;\r\nif (!uuid_equal(&block->bb_u.l.bb_uuid, &mp->m_sb.sb_meta_uuid))\r\nreturn false;\r\nif (be64_to_cpu(block->bb_u.l.bb_blkno) != bp->b_bn)\r\nreturn false;\r\nif (be64_to_cpu(block->bb_u.l.bb_owner) == 0)\r\nreturn false;\r\ncase cpu_to_be32(XFS_BMAP_MAGIC):\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nlevel = be16_to_cpu(block->bb_level);\r\nif (level > max(mp->m_bm_maxlevels[0], mp->m_bm_maxlevels[1]))\r\nreturn false;\r\nif (be16_to_cpu(block->bb_numrecs) > mp->m_bmap_dmxr[level != 0])\r\nreturn false;\r\nif (!block->bb_u.l.bb_leftsib ||\r\n(block->bb_u.l.bb_leftsib != cpu_to_be64(NULLFSBLOCK) &&\r\n!XFS_FSB_SANITY_CHECK(mp, be64_to_cpu(block->bb_u.l.bb_leftsib))))\r\nreturn false;\r\nif (!block->bb_u.l.bb_rightsib ||\r\n(block->bb_u.l.bb_rightsib != cpu_to_be64(NULLFSBLOCK) &&\r\n!XFS_FSB_SANITY_CHECK(mp, be64_to_cpu(block->bb_u.l.bb_rightsib))))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_bmbt_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_btree_lblock_verify_crc(bp))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_bmbt_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_verifier_error(bp);\r\n}\r\n}\r\nstatic void\r\nxfs_bmbt_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nif (!xfs_bmbt_verify(bp)) {\r\ntrace_xfs_btree_corrupt(bp, _RET_IP_);\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nxfs_btree_lblock_calc_crc(bp);\r\n}\r\nSTATIC int\r\nxfs_bmbt_keys_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_key *k1,\r\nunion xfs_btree_key *k2)\r\n{\r\nreturn be64_to_cpu(k1->bmbt.br_startoff) <\r\nbe64_to_cpu(k2->bmbt.br_startoff);\r\n}\r\nSTATIC int\r\nxfs_bmbt_recs_inorder(\r\nstruct xfs_btree_cur *cur,\r\nunion xfs_btree_rec *r1,\r\nunion xfs_btree_rec *r2)\r\n{\r\nreturn xfs_bmbt_disk_get_startoff(&r1->bmbt) +\r\nxfs_bmbt_disk_get_blockcount(&r1->bmbt) <=\r\nxfs_bmbt_disk_get_startoff(&r2->bmbt);\r\n}\r\nstruct xfs_btree_cur *\r\nxfs_bmbt_init_cursor(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *ip,\r\nint whichfork)\r\n{\r\nstruct xfs_ifork *ifp = XFS_IFORK_PTR(ip, whichfork);\r\nstruct xfs_btree_cur *cur;\r\ncur = kmem_zone_zalloc(xfs_btree_cur_zone, KM_SLEEP);\r\ncur->bc_tp = tp;\r\ncur->bc_mp = mp;\r\ncur->bc_nlevels = be16_to_cpu(ifp->if_broot->bb_level) + 1;\r\ncur->bc_btnum = XFS_BTNUM_BMAP;\r\ncur->bc_blocklog = mp->m_sb.sb_blocklog;\r\ncur->bc_ops = &xfs_bmbt_ops;\r\ncur->bc_flags = XFS_BTREE_LONG_PTRS | XFS_BTREE_ROOT_IN_INODE;\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\ncur->bc_flags |= XFS_BTREE_CRC_BLOCKS;\r\ncur->bc_private.b.forksize = XFS_IFORK_SIZE(ip, whichfork);\r\ncur->bc_private.b.ip = ip;\r\ncur->bc_private.b.firstblock = NULLFSBLOCK;\r\ncur->bc_private.b.flist = NULL;\r\ncur->bc_private.b.allocated = 0;\r\ncur->bc_private.b.flags = 0;\r\ncur->bc_private.b.whichfork = whichfork;\r\nreturn cur;\r\n}\r\nint\r\nxfs_bmbt_maxrecs(\r\nstruct xfs_mount *mp,\r\nint blocklen,\r\nint leaf)\r\n{\r\nblocklen -= XFS_BMBT_BLOCK_LEN(mp);\r\nif (leaf)\r\nreturn blocklen / sizeof(xfs_bmbt_rec_t);\r\nreturn blocklen / (sizeof(xfs_bmbt_key_t) + sizeof(xfs_bmbt_ptr_t));\r\n}\r\nint\r\nxfs_bmdr_maxrecs(\r\nint blocklen,\r\nint leaf)\r\n{\r\nblocklen -= sizeof(xfs_bmdr_block_t);\r\nif (leaf)\r\nreturn blocklen / sizeof(xfs_bmdr_rec_t);\r\nreturn blocklen / (sizeof(xfs_bmdr_key_t) + sizeof(xfs_bmdr_ptr_t));\r\n}\r\nint\r\nxfs_bmbt_change_owner(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *ip,\r\nint whichfork,\r\nxfs_ino_t new_owner,\r\nstruct list_head *buffer_list)\r\n{\r\nstruct xfs_btree_cur *cur;\r\nint error;\r\nASSERT(tp || buffer_list);\r\nASSERT(!(tp && buffer_list));\r\nif (whichfork == XFS_DATA_FORK)\r\nASSERT(ip->i_d.di_format == XFS_DINODE_FMT_BTREE);\r\nelse\r\nASSERT(ip->i_d.di_aformat == XFS_DINODE_FMT_BTREE);\r\ncur = xfs_bmbt_init_cursor(ip->i_mount, tp, ip, whichfork);\r\nif (!cur)\r\nreturn -ENOMEM;\r\nerror = xfs_btree_change_owner(cur, new_owner, buffer_list);\r\nxfs_btree_del_cursor(cur, error ? XFS_BTREE_ERROR : XFS_BTREE_NOERROR);\r\nreturn error;\r\n}

static ssize_t speakup_file_write(struct file *fp, const char __user *buffer,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nsize_t count = nbytes;\r\nconst char __user *ptr = buffer;\r\nsize_t bytes;\r\nunsigned long flags;\r\nu_char buf[256];\r\nif (!synth)\r\nreturn -ENODEV;\r\nwhile (count > 0) {\r\nbytes = min(count, sizeof(buf));\r\nif (copy_from_user(buf, ptr, bytes))\r\nreturn -EFAULT;\r\ncount -= bytes;\r\nptr += bytes;\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nsynth_write(buf, bytes);\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\n}\r\nreturn (ssize_t) nbytes;\r\n}\r\nstatic ssize_t speakup_file_read(struct file *fp, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nreturn 0;\r\n}\r\nstatic int speakup_file_open(struct inode *ip, struct file *fp)\r\n{\r\nif (!synth)\r\nreturn -ENODEV;\r\nif (xchg(&dev_opened, 1))\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic int speakup_file_release(struct inode *ip, struct file *fp)\r\n{\r\ndev_opened = 0;\r\nreturn 0;\r\n}\r\nvoid speakup_register_devsynth(void)\r\n{\r\nif (misc_registered != 0)\r\nreturn;\r\nif (misc_register(&synth_device)) {\r\npr_warn("Couldn't initialize miscdevice /dev/synth.\n");\r\n} else {\r\npr_info("initialized device: /dev/synth, node (MAJOR %d, MINOR %d)\n",\r\nMISC_MAJOR, SYNTH_MINOR);\r\nmisc_registered = 1;\r\n}\r\n}\r\nvoid speakup_unregister_devsynth(void)\r\n{\r\nif (!misc_registered)\r\nreturn;\r\npr_info("speakup: unregistering synth device /dev/synth\n");\r\nmisc_deregister(&synth_device);\r\nmisc_registered = 0;\r\n}

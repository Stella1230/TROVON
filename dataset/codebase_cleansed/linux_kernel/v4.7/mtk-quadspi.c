static void mt8173_nor_set_read_mode(struct mt8173_nor *mt8173_nor)\r\n{\r\nstruct spi_nor *nor = &mt8173_nor->nor;\r\nswitch (nor->flash_read) {\r\ncase SPI_NOR_FAST:\r\nwriteb(nor->read_opcode, mt8173_nor->base +\r\nMTK_NOR_PRGDATA3_REG);\r\nwriteb(MTK_NOR_FAST_READ, mt8173_nor->base +\r\nMTK_NOR_CFG1_REG);\r\nbreak;\r\ncase SPI_NOR_DUAL:\r\nwriteb(nor->read_opcode, mt8173_nor->base +\r\nMTK_NOR_PRGDATA3_REG);\r\nwriteb(MTK_NOR_DUAL_READ_EN, mt8173_nor->base +\r\nMTK_NOR_DUAL_REG);\r\nbreak;\r\ncase SPI_NOR_QUAD:\r\nwriteb(nor->read_opcode, mt8173_nor->base +\r\nMTK_NOR_PRGDATA4_REG);\r\nwriteb(MTK_NOR_QUAD_READ_EN, mt8173_nor->base +\r\nMTK_NOR_DUAL_REG);\r\nbreak;\r\ndefault:\r\nwriteb(MTK_NOR_DUAL_DISABLE, mt8173_nor->base +\r\nMTK_NOR_DUAL_REG);\r\nbreak;\r\n}\r\n}\r\nstatic int mt8173_nor_execute_cmd(struct mt8173_nor *mt8173_nor, u8 cmdval)\r\n{\r\nint reg;\r\nu8 val = cmdval & 0x1f;\r\nwriteb(cmdval, mt8173_nor->base + MTK_NOR_CMD_REG);\r\nreturn readl_poll_timeout(mt8173_nor->base + MTK_NOR_CMD_REG, reg,\r\n!(reg & val), 100, 10000);\r\n}\r\nstatic int mt8173_nor_do_tx_rx(struct mt8173_nor *mt8173_nor, u8 op,\r\nu8 *tx, int txlen, u8 *rx, int rxlen)\r\n{\r\nint len = 1 + txlen + rxlen;\r\nint i, ret, idx;\r\nif (len > MTK_NOR_MAX_SHIFT)\r\nreturn -EINVAL;\r\nwriteb(len * 8, mt8173_nor->base + MTK_NOR_CNT_REG);\r\nidx = MTK_NOR_MAX_RX_TX_SHIFT - 1;\r\nwriteb(op, mt8173_nor->base + MTK_NOR_PRG_REG(idx));\r\nidx--;\r\nfor (i = 0; i < txlen; i++, idx--)\r\nwriteb(tx[i], mt8173_nor->base + MTK_NOR_PRG_REG(idx));\r\nwhile (idx >= 0) {\r\nwriteb(0, mt8173_nor->base + MTK_NOR_PRG_REG(idx));\r\nidx--;\r\n}\r\nret = mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_PRG_CMD);\r\nif (ret)\r\nreturn ret;\r\nidx = rxlen - 1;\r\nfor (i = 0; i < rxlen; i++, idx--)\r\nrx[i] = readb(mt8173_nor->base + MTK_NOR_SHREG(idx));\r\nreturn 0;\r\n}\r\nstatic int mt8173_nor_wr_sr(struct mt8173_nor *mt8173_nor, u8 sr)\r\n{\r\nwriteb(sr, mt8173_nor->base + MTK_NOR_PRGDATA5_REG);\r\nwriteb(8, mt8173_nor->base + MTK_NOR_CNT_REG);\r\nreturn mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_WRSR_CMD);\r\n}\r\nstatic int mt8173_nor_write_buffer_enable(struct mt8173_nor *mt8173_nor)\r\n{\r\nu8 reg;\r\nwritel(MTK_NOR_WR_BUF_ENABLE, mt8173_nor->base + MTK_NOR_CFG2_REG);\r\nreturn readb_poll_timeout(mt8173_nor->base + MTK_NOR_CFG2_REG, reg,\r\n0x01 == (reg & 0x01), 100, 10000);\r\n}\r\nstatic int mt8173_nor_write_buffer_disable(struct mt8173_nor *mt8173_nor)\r\n{\r\nu8 reg;\r\nwritel(MTK_NOR_WR_BUF_DISABLE, mt8173_nor->base + MTK_NOR_CFG2_REG);\r\nreturn readb_poll_timeout(mt8173_nor->base + MTK_NOR_CFG2_REG, reg,\r\nMTK_NOR_WR_BUF_DISABLE == (reg & 0x1), 100,\r\n10000);\r\n}\r\nstatic void mt8173_nor_set_addr(struct mt8173_nor *mt8173_nor, u32 addr)\r\n{\r\nint i;\r\nfor (i = 0; i < 3; i++) {\r\nwriteb(addr & 0xff, mt8173_nor->base + MTK_NOR_RADR0_REG + i * 4);\r\naddr >>= 8;\r\n}\r\nwriteb(addr & 0xff, mt8173_nor->base + MTK_NOR_RADR3_REG);\r\n}\r\nstatic int mt8173_nor_read(struct spi_nor *nor, loff_t from, size_t length,\r\nsize_t *retlen, u_char *buffer)\r\n{\r\nint i, ret;\r\nint addr = (int)from;\r\nu8 *buf = (u8 *)buffer;\r\nstruct mt8173_nor *mt8173_nor = nor->priv;\r\nmt8173_nor_set_read_mode(mt8173_nor);\r\nmt8173_nor_set_addr(mt8173_nor, addr);\r\nfor (i = 0; i < length; i++, (*retlen)++) {\r\nret = mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_PIO_READ_CMD);\r\nif (ret < 0)\r\nreturn ret;\r\nbuf[i] = readb(mt8173_nor->base + MTK_NOR_RDATA_REG);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt8173_nor_write_single_byte(struct mt8173_nor *mt8173_nor,\r\nint addr, int length, u8 *data)\r\n{\r\nint i, ret;\r\nmt8173_nor_set_addr(mt8173_nor, addr);\r\nfor (i = 0; i < length; i++) {\r\nwriteb(*data++, mt8173_nor->base + MTK_NOR_WDATA_REG);\r\nret = mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_PIO_WR_CMD);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt8173_nor_write_buffer(struct mt8173_nor *mt8173_nor, int addr,\r\nconst u8 *buf)\r\n{\r\nint i, bufidx, data;\r\nmt8173_nor_set_addr(mt8173_nor, addr);\r\nbufidx = 0;\r\nfor (i = 0; i < SFLASH_WRBUF_SIZE; i += 4) {\r\ndata = buf[bufidx + 3]<<24 | buf[bufidx + 2]<<16 |\r\nbuf[bufidx + 1]<<8 | buf[bufidx];\r\nbufidx += 4;\r\nwritel(data, mt8173_nor->base + MTK_NOR_PP_DATA_REG);\r\n}\r\nreturn mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_WR_CMD);\r\n}\r\nstatic void mt8173_nor_write(struct spi_nor *nor, loff_t to, size_t len,\r\nsize_t *retlen, const u_char *buf)\r\n{\r\nint ret;\r\nstruct mt8173_nor *mt8173_nor = nor->priv;\r\nret = mt8173_nor_write_buffer_enable(mt8173_nor);\r\nif (ret < 0)\r\ndev_warn(mt8173_nor->dev, "write buffer enable failed!\n");\r\nwhile (len >= SFLASH_WRBUF_SIZE) {\r\nret = mt8173_nor_write_buffer(mt8173_nor, to, buf);\r\nif (ret < 0)\r\ndev_err(mt8173_nor->dev, "write buffer failed!\n");\r\nlen -= SFLASH_WRBUF_SIZE;\r\nto += SFLASH_WRBUF_SIZE;\r\nbuf += SFLASH_WRBUF_SIZE;\r\n(*retlen) += SFLASH_WRBUF_SIZE;\r\n}\r\nret = mt8173_nor_write_buffer_disable(mt8173_nor);\r\nif (ret < 0)\r\ndev_warn(mt8173_nor->dev, "write buffer disable failed!\n");\r\nif (len) {\r\nret = mt8173_nor_write_single_byte(mt8173_nor, to, (int)len,\r\n(u8 *)buf);\r\nif (ret < 0)\r\ndev_err(mt8173_nor->dev, "write single byte failed!\n");\r\n(*retlen) += len;\r\n}\r\n}\r\nstatic int mt8173_nor_read_reg(struct spi_nor *nor, u8 opcode, u8 *buf, int len)\r\n{\r\nint ret;\r\nstruct mt8173_nor *mt8173_nor = nor->priv;\r\nswitch (opcode) {\r\ncase SPINOR_OP_RDSR:\r\nret = mt8173_nor_execute_cmd(mt8173_nor, MTK_NOR_RDSR_CMD);\r\nif (ret < 0)\r\nreturn ret;\r\nif (len == 1)\r\n*buf = readb(mt8173_nor->base + MTK_NOR_RDSR_REG);\r\nelse\r\ndev_err(mt8173_nor->dev, "len should be 1 for read status!\n");\r\nbreak;\r\ndefault:\r\nret = mt8173_nor_do_tx_rx(mt8173_nor, opcode, NULL, 0, buf, len);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int mt8173_nor_write_reg(struct spi_nor *nor, u8 opcode, u8 *buf,\r\nint len)\r\n{\r\nint ret;\r\nstruct mt8173_nor *mt8173_nor = nor->priv;\r\nswitch (opcode) {\r\ncase SPINOR_OP_WRSR:\r\nret = mt8173_nor_wr_sr(mt8173_nor, *buf);\r\nbreak;\r\ndefault:\r\nret = mt8173_nor_do_tx_rx(mt8173_nor, opcode, buf, len, NULL, 0);\r\nif (ret)\r\ndev_warn(mt8173_nor->dev, "write reg failure!\n");\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int mtk_nor_init(struct mt8173_nor *mt8173_nor,\r\nstruct device_node *flash_node)\r\n{\r\nint ret;\r\nstruct spi_nor *nor;\r\nwritel(MTK_NOR_ENABLE_SF_CMD, mt8173_nor->base + MTK_NOR_WRPROT_REG);\r\nnor = &mt8173_nor->nor;\r\nnor->dev = mt8173_nor->dev;\r\nnor->priv = mt8173_nor;\r\nspi_nor_set_flash_node(nor, flash_node);\r\nnor->read = mt8173_nor_read;\r\nnor->read_reg = mt8173_nor_read_reg;\r\nnor->write = mt8173_nor_write;\r\nnor->write_reg = mt8173_nor_write_reg;\r\nnor->mtd.name = "mtk_nor";\r\nret = spi_nor_scan(nor, NULL, SPI_NOR_DUAL);\r\nif (ret)\r\nreturn ret;\r\nreturn mtd_device_register(&nor->mtd, NULL, 0);\r\n}\r\nstatic int mtk_nor_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *flash_np;\r\nstruct resource *res;\r\nint ret;\r\nstruct mt8173_nor *mt8173_nor;\r\nif (!pdev->dev.of_node) {\r\ndev_err(&pdev->dev, "No DT found\n");\r\nreturn -EINVAL;\r\n}\r\nmt8173_nor = devm_kzalloc(&pdev->dev, sizeof(*mt8173_nor), GFP_KERNEL);\r\nif (!mt8173_nor)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, mt8173_nor);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmt8173_nor->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mt8173_nor->base))\r\nreturn PTR_ERR(mt8173_nor->base);\r\nmt8173_nor->spi_clk = devm_clk_get(&pdev->dev, "spi");\r\nif (IS_ERR(mt8173_nor->spi_clk))\r\nreturn PTR_ERR(mt8173_nor->spi_clk);\r\nmt8173_nor->nor_clk = devm_clk_get(&pdev->dev, "sf");\r\nif (IS_ERR(mt8173_nor->nor_clk))\r\nreturn PTR_ERR(mt8173_nor->nor_clk);\r\nmt8173_nor->dev = &pdev->dev;\r\nret = clk_prepare_enable(mt8173_nor->spi_clk);\r\nif (ret)\r\nreturn ret;\r\nret = clk_prepare_enable(mt8173_nor->nor_clk);\r\nif (ret) {\r\nclk_disable_unprepare(mt8173_nor->spi_clk);\r\nreturn ret;\r\n}\r\nflash_np = of_get_next_available_child(pdev->dev.of_node, NULL);\r\nif (!flash_np) {\r\ndev_err(&pdev->dev, "no SPI flash device to configure\n");\r\nret = -ENODEV;\r\ngoto nor_free;\r\n}\r\nret = mtk_nor_init(mt8173_nor, flash_np);\r\nnor_free:\r\nif (ret) {\r\nclk_disable_unprepare(mt8173_nor->spi_clk);\r\nclk_disable_unprepare(mt8173_nor->nor_clk);\r\n}\r\nreturn ret;\r\n}\r\nstatic int mtk_nor_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct mt8173_nor *mt8173_nor = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(mt8173_nor->spi_clk);\r\nclk_disable_unprepare(mt8173_nor->nor_clk);\r\nreturn 0;\r\n}

static int nile4_pcibios_config_access(unsigned char access_type,\r\nstruct pci_bus *bus, unsigned int devfn, int where, u32 *val)\r\n{\r\nunsigned char busnum = bus->number;\r\nu32 adr, mask, err;\r\nif ((busnum == 0) && (PCI_SLOT(devfn) > 8))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif ((busnum == 0) && (devfn == PCI_DEVFN(0, 0))) {\r\nif (access_type == PCI_ACCESS_WRITE) {\r\nvrc_pciregs[(0x200 + where) >> 2] = *val;\r\n} else {\r\n*val = vrc_pciregs[(0x200 + where) >> 2];\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nmask = vrc_pciregs[LO(NILE4_PCIINIT1)];\r\nvrc_pciregs[LO(NILE4_PCIINIT1)] = 0x0000001a | (busnum ? 0x200 : 0);\r\nvrc_pciregs[LO(NILE4_PCIERR)] = 0;\r\nvrc_pciregs[HI(NILE4_PCIERR)] = 0;\r\nif (busnum == 0)\r\nadr =\r\nKSEG1ADDR(PCI_WINDOW1) +\r\n((1 << (PCI_SLOT(devfn) + 15)) | (PCI_FUNC(devfn) << 8)\r\n| (where & ~3));\r\nelse\r\nadr = KSEG1ADDR(PCI_WINDOW1) | (busnum << 16) | (devfn << 8) |\r\n(where & ~3);\r\nif (access_type == PCI_ACCESS_WRITE)\r\n*(u32 *) adr = *val;\r\nelse\r\n*val = *(u32 *) adr;\r\nerr = (vrc_pciregs[HI(NILE4_PCICTRL)] >> 5) & 0x7;\r\nvrc_pciregs[LO(NILE4_PCIINIT1)] = mask;\r\nif (err)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int nile4_pcibios_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nu32 data = 0;\r\nint err;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nerr = nile4_pcibios_config_access(PCI_ACCESS_READ, bus, devfn, where,\r\n&data);\r\nif (err)\r\nreturn err;\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int nile4_pcibios_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data = 0;\r\nint err;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nerr = nile4_pcibios_config_access(PCI_ACCESS_READ, bus, devfn, where,\r\n&data);\r\nif (err)\r\nreturn err;\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse\r\ndata = val;\r\nif (nile4_pcibios_config_access\r\n(PCI_ACCESS_WRITE, bus, devfn, where, &data))\r\nreturn -1;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

static unsigned long long ibm_currituck_detect_memsize(void)\r\n{\r\nu32 reg;\r\nunsigned i;\r\nunsigned long long memsize = 0;\r\nfor(i = 0; i < MAX_RANKS; i++){\r\nreg = mfdcrx(DDR3_MR0CF + i);\r\nif (!(reg & 1))\r\ncontinue;\r\nreg &= 0x0000f000;\r\nreg >>= 12;\r\nmemsize += (0x800000ULL << reg);\r\n}\r\nreturn memsize;\r\n}\r\nstatic void ibm_currituck_fixups(void)\r\n{\r\nvoid *devp = finddevice("/");\r\nu32 dma_ranges[7];\r\ndt_fixup_memory(0x0ULL, ibm_currituck_memsize);\r\nwhile ((devp = find_node_by_devtype(devp, "pci"))) {\r\nif (getprop(devp, "dma-ranges", dma_ranges, sizeof(dma_ranges)) < 0) {\r\nprintf("%s: Failed to get dma-ranges\r\n", __func__);\r\ncontinue;\r\n}\r\ndma_ranges[5] = ibm_currituck_memsize >> 32;\r\ndma_ranges[6] = ibm_currituck_memsize & 0xffffffffUL;\r\nsetprop(devp, "dma-ranges", dma_ranges, sizeof(dma_ranges));\r\n}\r\n}\r\nvoid platform_init(void)\r\n{\r\nunsigned long end_of_ram, avail_ram;\r\nu32 pir_reg;\r\nint node, size;\r\nconst u32 *timebase;\r\nibm_currituck_memsize = ibm_currituck_detect_memsize();\r\nif (ibm_currituck_memsize >> 32)\r\nend_of_ram = ~0UL;\r\nelse\r\nend_of_ram = ibm_currituck_memsize;\r\navail_ram = end_of_ram - (unsigned long)_end;\r\nsimple_alloc_init(_end, avail_ram, 128, 64);\r\nplatform_ops.fixups = ibm_currituck_fixups;\r\nplatform_ops.exit = ibm44x_dbcr_reset;\r\npir_reg = mfspr(SPRN_PIR);\r\nif (fdt_check_header(_dtb_start) != 0)\r\nfatal("Invalid device tree blob\n");\r\nnode = fdt_node_offset_by_prop_value(_dtb_start, -1, "device_type",\r\n"cpu", sizeof("cpu"));\r\nif (!node)\r\nfatal("Cannot find cpu node\n");\r\ntimebase = fdt_getprop(_dtb_start, node, "timebase-frequency", &size);\r\nif (timebase && (size == 4))\r\ntimebase_period_ns = 1000000000 / *timebase;\r\nfdt_set_boot_cpuid_phys(_dtb_start, pir_reg);\r\nfdt_init(_dtb_start);\r\nserial_console_init();\r\n}

static void pci_free_resources(struct pci_dev *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < PCI_NUM_RESOURCES; i++) {\r\nstruct resource *res = dev->resource + i;\r\nif (res->parent)\r\nrelease_resource(res);\r\n}\r\n}\r\nstatic void pci_stop_dev(struct pci_dev *dev)\r\n{\r\npci_pme_active(dev, false);\r\nif (dev->is_added) {\r\npci_proc_detach_device(dev);\r\npci_remove_sysfs_dev_files(dev);\r\ndevice_release_driver(&dev->dev);\r\ndev->is_added = 0;\r\n}\r\nif (dev->bus->self)\r\npcie_aspm_exit_link_state(dev);\r\n}\r\nstatic void pci_destroy_dev(struct pci_dev *dev)\r\n{\r\nif (!dev->dev.kobj.parent)\r\nreturn;\r\ndevice_del(&dev->dev);\r\ndown_write(&pci_bus_sem);\r\nlist_del(&dev->bus_list);\r\nup_write(&pci_bus_sem);\r\npci_free_resources(dev);\r\nput_device(&dev->dev);\r\n}\r\nvoid pci_remove_bus(struct pci_bus *bus)\r\n{\r\npci_proc_detach_bus(bus);\r\ndown_write(&pci_bus_sem);\r\nlist_del(&bus->node);\r\npci_bus_release_busn_res(bus);\r\nup_write(&pci_bus_sem);\r\npci_remove_legacy_files(bus);\r\nif (bus->ops->remove_bus)\r\nbus->ops->remove_bus(bus);\r\npcibios_remove_bus(bus);\r\ndevice_unregister(&bus->dev);\r\n}\r\nstatic void pci_stop_bus_device(struct pci_dev *dev)\r\n{\r\nstruct pci_bus *bus = dev->subordinate;\r\nstruct pci_dev *child, *tmp;\r\nif (bus) {\r\nlist_for_each_entry_safe_reverse(child, tmp,\r\n&bus->devices, bus_list)\r\npci_stop_bus_device(child);\r\n}\r\npci_stop_dev(dev);\r\n}\r\nstatic void pci_remove_bus_device(struct pci_dev *dev)\r\n{\r\nstruct pci_bus *bus = dev->subordinate;\r\nstruct pci_dev *child, *tmp;\r\nif (bus) {\r\nlist_for_each_entry_safe(child, tmp,\r\n&bus->devices, bus_list)\r\npci_remove_bus_device(child);\r\npci_remove_bus(bus);\r\ndev->subordinate = NULL;\r\n}\r\npci_destroy_dev(dev);\r\n}\r\nvoid pci_stop_and_remove_bus_device(struct pci_dev *dev)\r\n{\r\npci_stop_bus_device(dev);\r\npci_remove_bus_device(dev);\r\n}\r\nvoid pci_stop_and_remove_bus_device_locked(struct pci_dev *dev)\r\n{\r\npci_lock_rescan_remove();\r\npci_stop_and_remove_bus_device(dev);\r\npci_unlock_rescan_remove();\r\n}\r\nvoid pci_stop_root_bus(struct pci_bus *bus)\r\n{\r\nstruct pci_dev *child, *tmp;\r\nstruct pci_host_bridge *host_bridge;\r\nif (!pci_is_root_bus(bus))\r\nreturn;\r\nhost_bridge = to_pci_host_bridge(bus->bridge);\r\nlist_for_each_entry_safe_reverse(child, tmp,\r\n&bus->devices, bus_list)\r\npci_stop_bus_device(child);\r\ndevice_release_driver(&host_bridge->dev);\r\n}\r\nvoid pci_remove_root_bus(struct pci_bus *bus)\r\n{\r\nstruct pci_dev *child, *tmp;\r\nstruct pci_host_bridge *host_bridge;\r\nif (!pci_is_root_bus(bus))\r\nreturn;\r\nhost_bridge = to_pci_host_bridge(bus->bridge);\r\nlist_for_each_entry_safe(child, tmp,\r\n&bus->devices, bus_list)\r\npci_remove_bus_device(child);\r\npci_remove_bus(bus);\r\nhost_bridge->bus = NULL;\r\ndevice_unregister(&host_bridge->dev);\r\n}

static int toshiba_bluetooth_present(acpi_handle handle)\r\n{\r\nacpi_status result;\r\nu64 bt_present;\r\nresult = acpi_evaluate_integer(handle, "_STA", NULL, &bt_present);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("ACPI call to query Bluetooth presence failed\n");\r\nreturn -ENXIO;\r\n} else if (!bt_present) {\r\npr_info("Bluetooth device not present\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int toshiba_bluetooth_status(acpi_handle handle)\r\n{\r\nacpi_status result;\r\nu64 status;\r\nresult = acpi_evaluate_integer(handle, "BTST", NULL, &status);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("Could not get Bluetooth device status\n");\r\nreturn -ENXIO;\r\n}\r\nreturn status;\r\n}\r\nstatic int toshiba_bluetooth_enable(acpi_handle handle)\r\n{\r\nacpi_status result;\r\nresult = acpi_evaluate_object(handle, "AUSB", NULL, NULL);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("Could not attach USB Bluetooth device\n");\r\nreturn -ENXIO;\r\n}\r\nresult = acpi_evaluate_object(handle, "BTPO", NULL, NULL);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("Could not power ON Bluetooth device\n");\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int toshiba_bluetooth_disable(acpi_handle handle)\r\n{\r\nacpi_status result;\r\nresult = acpi_evaluate_object(handle, "BTPF", NULL, NULL);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("Could not power OFF Bluetooth device\n");\r\nreturn -ENXIO;\r\n}\r\nresult = acpi_evaluate_object(handle, "DUSB", NULL, NULL);\r\nif (ACPI_FAILURE(result)) {\r\npr_err("Could not detach USB Bluetooth device\n");\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int toshiba_bluetooth_sync_status(struct toshiba_bluetooth_dev *bt_dev)\r\n{\r\nint status;\r\nstatus = toshiba_bluetooth_status(bt_dev->acpi_dev->handle);\r\nif (status < 0) {\r\npr_err("Could not sync bluetooth device status\n");\r\nreturn status;\r\n}\r\nbt_dev->killswitch = (status & BT_KILLSWITCH_MASK) ? true : false;\r\nbt_dev->plugged = (status & BT_PLUGGED_MASK) ? true : false;\r\nbt_dev->powered = (status & BT_POWER_MASK) ? true : false;\r\npr_debug("Bluetooth status %d killswitch %d plugged %d powered %d\n",\r\nstatus, bt_dev->killswitch, bt_dev->plugged, bt_dev->powered);\r\nreturn 0;\r\n}\r\nstatic int bt_rfkill_set_block(void *data, bool blocked)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev = data;\r\nint ret;\r\nret = toshiba_bluetooth_sync_status(bt_dev);\r\nif (ret)\r\nreturn ret;\r\nif (!bt_dev->killswitch)\r\nreturn 0;\r\nif (blocked)\r\nret = toshiba_bluetooth_disable(bt_dev->acpi_dev->handle);\r\nelse\r\nret = toshiba_bluetooth_enable(bt_dev->acpi_dev->handle);\r\nreturn ret;\r\n}\r\nstatic void bt_rfkill_poll(struct rfkill *rfkill, void *data)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev = data;\r\nif (toshiba_bluetooth_sync_status(bt_dev))\r\nreturn;\r\nrfkill_set_hw_state(bt_dev->rfk, !bt_dev->killswitch);\r\n}\r\nstatic void toshiba_bt_rfkill_notify(struct acpi_device *device, u32 event)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev = acpi_driver_data(device);\r\nif (toshiba_bluetooth_sync_status(bt_dev))\r\nreturn;\r\nrfkill_set_hw_state(bt_dev->rfk, !bt_dev->killswitch);\r\n}\r\nstatic int toshiba_bt_resume(struct device *dev)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev;\r\nint ret;\r\nbt_dev = acpi_driver_data(to_acpi_device(dev));\r\nret = toshiba_bluetooth_sync_status(bt_dev);\r\nif (ret)\r\nreturn ret;\r\nrfkill_set_hw_state(bt_dev->rfk, !bt_dev->killswitch);\r\nreturn 0;\r\n}\r\nstatic int toshiba_bt_rfkill_add(struct acpi_device *device)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev;\r\nint result;\r\nresult = toshiba_bluetooth_present(device->handle);\r\nif (result)\r\nreturn result;\r\npr_info("Toshiba ACPI Bluetooth device driver\n");\r\nbt_dev = kzalloc(sizeof(*bt_dev), GFP_KERNEL);\r\nif (!bt_dev)\r\nreturn -ENOMEM;\r\nbt_dev->acpi_dev = device;\r\ndevice->driver_data = bt_dev;\r\ndev_set_drvdata(&device->dev, bt_dev);\r\nresult = toshiba_bluetooth_sync_status(bt_dev);\r\nif (result) {\r\nkfree(bt_dev);\r\nreturn result;\r\n}\r\nbt_dev->rfk = rfkill_alloc("Toshiba Bluetooth",\r\n&device->dev,\r\nRFKILL_TYPE_BLUETOOTH,\r\n&rfk_ops,\r\nbt_dev);\r\nif (!bt_dev->rfk) {\r\npr_err("Unable to allocate rfkill device\n");\r\nkfree(bt_dev);\r\nreturn -ENOMEM;\r\n}\r\nrfkill_set_hw_state(bt_dev->rfk, !bt_dev->killswitch);\r\nresult = rfkill_register(bt_dev->rfk);\r\nif (result) {\r\npr_err("Unable to register rfkill device\n");\r\nrfkill_destroy(bt_dev->rfk);\r\nkfree(bt_dev);\r\n}\r\nreturn result;\r\n}\r\nstatic int toshiba_bt_rfkill_remove(struct acpi_device *device)\r\n{\r\nstruct toshiba_bluetooth_dev *bt_dev = acpi_driver_data(device);\r\nif (bt_dev->rfk) {\r\nrfkill_unregister(bt_dev->rfk);\r\nrfkill_destroy(bt_dev->rfk);\r\n}\r\nkfree(bt_dev);\r\nreturn toshiba_bluetooth_disable(device->handle);\r\n}

void DisableVGA(volatile STG4000REG __iomem *pSTGReg)\r\n{\r\nu32 tmp;\r\nvolatile u32 count = 0, i;\r\ntmp = STG_READ_REG(SoftwareReset);\r\nCLEAR_BIT(8);\r\nSTG_WRITE_REG(SoftwareReset, tmp);\r\nfor (i = 0; i < 1000; i++) {\r\ncount++;\r\n}\r\ntmp = STG_READ_REG(SoftwareReset);\r\ntmp |= SET_BIT(8);\r\nSTG_WRITE_REG(SoftwareReset, tmp);\r\n}\r\nvoid StopVTG(volatile STG4000REG __iomem *pSTGReg)\r\n{\r\nu32 tmp = 0;\r\ntmp = (STG_READ_REG(DACSyncCtrl)) | SET_BIT(0) | SET_BIT(2);\r\nCLEAR_BIT(31);\r\nSTG_WRITE_REG(DACSyncCtrl, tmp);\r\n}\r\nvoid StartVTG(volatile STG4000REG __iomem *pSTGReg)\r\n{\r\nu32 tmp = 0;\r\ntmp = ((STG_READ_REG(DACSyncCtrl)) | SET_BIT(31));\r\nCLEAR_BIT(0);\r\nCLEAR_BIT(2);\r\nSTG_WRITE_REG(DACSyncCtrl, tmp);\r\n}\r\nvoid SetupVTG(volatile STG4000REG __iomem *pSTGReg,\r\nconst struct kyrofb_info * pTiming)\r\n{\r\nu32 tmp = 0;\r\nu32 margins = 0;\r\nu32 ulBorder;\r\nu32 xRes = pTiming->XRES;\r\nu32 yRes = pTiming->YRES;\r\nu32 HAddrTime, HRightBorder, HLeftBorder;\r\nu32 HBackPorcStrt, HFrontPorchStrt, HTotal,\r\nHLeftBorderStrt, HRightBorderStrt, HDisplayStrt;\r\nu32 VDisplayStrt, VBottomBorder, VTopBorder;\r\nu32 VBackPorchStrt, VTotal, VTopBorderStrt,\r\nVFrontPorchStrt, VBottomBorderStrt, VAddrTime;\r\nif ((xRes == 640) && (yRes == 480)) {\r\nif ((pTiming->VFREQ == 60) || (pTiming->VFREQ == 72)) {\r\nmargins = 8;\r\n}\r\n}\r\nulBorder =\r\n(pTiming->HTot -\r\n(pTiming->HST + (pTiming->HBP - margins) + xRes +\r\n(pTiming->HFP - margins))) >> 1;\r\nVBottomBorder = HLeftBorder = VTopBorder = HRightBorder = ulBorder;\r\nHAddrTime = xRes;\r\nHBackPorcStrt = pTiming->HST;\r\nHTotal = pTiming->HTot;\r\nHDisplayStrt =\r\npTiming->HST + (pTiming->HBP - margins) + HLeftBorder;\r\nHLeftBorderStrt = HDisplayStrt - HLeftBorder;\r\nHFrontPorchStrt =\r\npTiming->HST + (pTiming->HBP - margins) + HLeftBorder +\r\nHAddrTime + HRightBorder;\r\nHRightBorderStrt = HFrontPorchStrt - HRightBorder;\r\nVAddrTime = yRes;\r\nVBackPorchStrt = pTiming->VST;\r\nVTotal = pTiming->VTot;\r\nVDisplayStrt =\r\npTiming->VST + (pTiming->VBP - margins) + VTopBorder;\r\nVTopBorderStrt = VDisplayStrt - VTopBorder;\r\nVFrontPorchStrt =\r\npTiming->VST + (pTiming->VBP - margins) + VTopBorder +\r\nVAddrTime + VBottomBorder;\r\nVBottomBorderStrt = VFrontPorchStrt - VBottomBorder;\r\ntmp = STG_READ_REG(DACHorTim1);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (HTotal) | (HBackPorcStrt << 16);\r\nSTG_WRITE_REG(DACHorTim1, tmp);\r\ntmp = STG_READ_REG(DACHorTim2);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (HDisplayStrt << 16) | HLeftBorderStrt;\r\nSTG_WRITE_REG(DACHorTim2, tmp);\r\ntmp = STG_READ_REG(DACHorTim3);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (HFrontPorchStrt << 16) | HRightBorderStrt;\r\nSTG_WRITE_REG(DACHorTim3, tmp);\r\ntmp = STG_READ_REG(DACVerTim1);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (VBackPorchStrt << 16) | (VTotal);\r\nSTG_WRITE_REG(DACVerTim1, tmp);\r\ntmp = STG_READ_REG(DACVerTim2);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (VDisplayStrt << 16) | VTopBorderStrt;\r\nSTG_WRITE_REG(DACVerTim2, tmp);\r\ntmp = STG_READ_REG(DACVerTim3);\r\nCLEAR_BITS_FRM_TO(0, 11);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\ntmp |= (VFrontPorchStrt << 16) | VBottomBorderStrt;\r\nSTG_WRITE_REG(DACVerTim3, tmp);\r\ntmp = STG_READ_REG(DACSyncCtrl) | SET_BIT(3) | SET_BIT(1);\r\nif ((pTiming->HSP > 0) && (pTiming->VSP < 0)) {\r\ntmp &= ~0x8;\r\n} else if ((pTiming->HSP < 0) && (pTiming->VSP > 0)) {\r\ntmp &= ~0x2;\r\n} else if ((pTiming->HSP < 0) && (pTiming->VSP < 0)) {\r\ntmp &= ~0xA;\r\n} else if ((pTiming->HSP > 0) && (pTiming->VSP > 0)) {\r\ntmp &= ~0x0;\r\n}\r\nSTG_WRITE_REG(DACSyncCtrl, tmp);\r\n}

static inline bool stage_session(__be16 sid)\r\n{\r\nreturn sid != 0;\r\n}\r\nstatic inline struct pppoe_net *pppoe_pernet(struct net *net)\r\n{\r\nBUG_ON(!net);\r\nreturn net_generic(net, pppoe_net_id);\r\n}\r\nstatic inline int cmp_2_addr(struct pppoe_addr *a, struct pppoe_addr *b)\r\n{\r\nreturn a->sid == b->sid && ether_addr_equal(a->remote, b->remote);\r\n}\r\nstatic inline int cmp_addr(struct pppoe_addr *a, __be16 sid, char *addr)\r\n{\r\nreturn a->sid == sid && ether_addr_equal(a->remote, addr);\r\n}\r\nstatic int hash_item(__be16 sid, unsigned char *addr)\r\n{\r\nunsigned char hash = 0;\r\nunsigned int i;\r\nfor (i = 0; i < ETH_ALEN; i++)\r\nhash ^= addr[i];\r\nfor (i = 0; i < sizeof(sid_t) * 8; i += 8)\r\nhash ^= (__force __u32)sid >> i;\r\nfor (i = 8; (i >>= 1) >= PPPOE_HASH_BITS;)\r\nhash ^= hash >> i;\r\nreturn hash & PPPOE_HASH_MASK;\r\n}\r\nstatic struct pppox_sock *__get_item(struct pppoe_net *pn, __be16 sid,\r\nunsigned char *addr, int ifindex)\r\n{\r\nint hash = hash_item(sid, addr);\r\nstruct pppox_sock *ret;\r\nret = pn->hash_table[hash];\r\nwhile (ret) {\r\nif (cmp_addr(&ret->pppoe_pa, sid, addr) &&\r\nret->pppoe_ifindex == ifindex)\r\nreturn ret;\r\nret = ret->next;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __set_item(struct pppoe_net *pn, struct pppox_sock *po)\r\n{\r\nint hash = hash_item(po->pppoe_pa.sid, po->pppoe_pa.remote);\r\nstruct pppox_sock *ret;\r\nret = pn->hash_table[hash];\r\nwhile (ret) {\r\nif (cmp_2_addr(&ret->pppoe_pa, &po->pppoe_pa) &&\r\nret->pppoe_ifindex == po->pppoe_ifindex)\r\nreturn -EALREADY;\r\nret = ret->next;\r\n}\r\npo->next = pn->hash_table[hash];\r\npn->hash_table[hash] = po;\r\nreturn 0;\r\n}\r\nstatic void __delete_item(struct pppoe_net *pn, __be16 sid,\r\nchar *addr, int ifindex)\r\n{\r\nint hash = hash_item(sid, addr);\r\nstruct pppox_sock *ret, **src;\r\nret = pn->hash_table[hash];\r\nsrc = &pn->hash_table[hash];\r\nwhile (ret) {\r\nif (cmp_addr(&ret->pppoe_pa, sid, addr) &&\r\nret->pppoe_ifindex == ifindex) {\r\n*src = ret->next;\r\nbreak;\r\n}\r\nsrc = &ret->next;\r\nret = ret->next;\r\n}\r\n}\r\nstatic inline struct pppox_sock *get_item(struct pppoe_net *pn, __be16 sid,\r\nunsigned char *addr, int ifindex)\r\n{\r\nstruct pppox_sock *po;\r\nread_lock_bh(&pn->hash_lock);\r\npo = __get_item(pn, sid, addr, ifindex);\r\nif (po)\r\nsock_hold(sk_pppox(po));\r\nread_unlock_bh(&pn->hash_lock);\r\nreturn po;\r\n}\r\nstatic inline struct pppox_sock *get_item_by_addr(struct net *net,\r\nstruct sockaddr_pppox *sp)\r\n{\r\nstruct net_device *dev;\r\nstruct pppoe_net *pn;\r\nstruct pppox_sock *pppox_sock = NULL;\r\nint ifindex;\r\nrcu_read_lock();\r\ndev = dev_get_by_name_rcu(net, sp->sa_addr.pppoe.dev);\r\nif (dev) {\r\nifindex = dev->ifindex;\r\npn = pppoe_pernet(net);\r\npppox_sock = get_item(pn, sp->sa_addr.pppoe.sid,\r\nsp->sa_addr.pppoe.remote, ifindex);\r\n}\r\nrcu_read_unlock();\r\nreturn pppox_sock;\r\n}\r\nstatic inline void delete_item(struct pppoe_net *pn, __be16 sid,\r\nchar *addr, int ifindex)\r\n{\r\nwrite_lock_bh(&pn->hash_lock);\r\n__delete_item(pn, sid, addr, ifindex);\r\nwrite_unlock_bh(&pn->hash_lock);\r\n}\r\nstatic void pppoe_flush_dev(struct net_device *dev)\r\n{\r\nstruct pppoe_net *pn;\r\nint i;\r\npn = pppoe_pernet(dev_net(dev));\r\nwrite_lock_bh(&pn->hash_lock);\r\nfor (i = 0; i < PPPOE_HASH_SIZE; i++) {\r\nstruct pppox_sock *po = pn->hash_table[i];\r\nstruct sock *sk;\r\nwhile (po) {\r\nwhile (po && po->pppoe_dev != dev) {\r\npo = po->next;\r\n}\r\nif (!po)\r\nbreak;\r\nsk = sk_pppox(po);\r\nsock_hold(sk);\r\nwrite_unlock_bh(&pn->hash_lock);\r\nlock_sock(sk);\r\nif (po->pppoe_dev == dev &&\r\nsk->sk_state & (PPPOX_CONNECTED | PPPOX_BOUND)) {\r\npppox_unbind_sock(sk);\r\nsk->sk_state_change(sk);\r\npo->pppoe_dev = NULL;\r\ndev_put(dev);\r\n}\r\nrelease_sock(sk);\r\nsock_put(sk);\r\nBUG_ON(pppoe_pernet(dev_net(dev)) == NULL);\r\nwrite_lock_bh(&pn->hash_lock);\r\npo = pn->hash_table[i];\r\n}\r\n}\r\nwrite_unlock_bh(&pn->hash_lock);\r\n}\r\nstatic int pppoe_device_event(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nswitch (event) {\r\ncase NETDEV_CHANGEADDR:\r\ncase NETDEV_CHANGEMTU:\r\ncase NETDEV_GOING_DOWN:\r\ncase NETDEV_DOWN:\r\npppoe_flush_dev(dev);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int pppoe_rcv_core(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nstruct pppox_sock *relay_po;\r\nif (skb->pkt_type == PACKET_OTHERHOST)\r\ngoto abort_kfree;\r\nif (sk->sk_state & PPPOX_BOUND) {\r\nppp_input(&po->chan, skb);\r\n} else if (sk->sk_state & PPPOX_RELAY) {\r\nrelay_po = get_item_by_addr(sock_net(sk),\r\n&po->pppoe_relay);\r\nif (relay_po == NULL)\r\ngoto abort_kfree;\r\nif ((sk_pppox(relay_po)->sk_state & PPPOX_CONNECTED) == 0)\r\ngoto abort_put;\r\nif (!__pppoe_xmit(sk_pppox(relay_po), skb))\r\ngoto abort_put;\r\nsock_put(sk_pppox(relay_po));\r\n} else {\r\nif (sock_queue_rcv_skb(sk, skb))\r\ngoto abort_kfree;\r\n}\r\nreturn NET_RX_SUCCESS;\r\nabort_put:\r\nsock_put(sk_pppox(relay_po));\r\nabort_kfree:\r\nkfree_skb(skb);\r\nreturn NET_RX_DROP;\r\n}\r\nstatic int pppoe_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct pppoe_hdr *ph;\r\nstruct pppox_sock *po;\r\nstruct pppoe_net *pn;\r\nint len;\r\nskb = skb_share_check(skb, GFP_ATOMIC);\r\nif (!skb)\r\ngoto out;\r\nif (!pskb_may_pull(skb, sizeof(struct pppoe_hdr)))\r\ngoto drop;\r\nph = pppoe_hdr(skb);\r\nlen = ntohs(ph->length);\r\nskb_pull_rcsum(skb, sizeof(*ph));\r\nif (skb->len < len)\r\ngoto drop;\r\nif (pskb_trim_rcsum(skb, len))\r\ngoto drop;\r\npn = pppoe_pernet(dev_net(dev));\r\npo = get_item(pn, ph->sid, eth_hdr(skb)->h_source, dev->ifindex);\r\nif (!po)\r\ngoto drop;\r\nreturn sk_receive_skb(sk_pppox(po), skb, 0);\r\ndrop:\r\nkfree_skb(skb);\r\nout:\r\nreturn NET_RX_DROP;\r\n}\r\nstatic void pppoe_unbind_sock_work(struct work_struct *work)\r\n{\r\nstruct pppox_sock *po = container_of(work, struct pppox_sock,\r\nproto.pppoe.padt_work);\r\nstruct sock *sk = sk_pppox(po);\r\nlock_sock(sk);\r\nif (po->pppoe_dev) {\r\ndev_put(po->pppoe_dev);\r\npo->pppoe_dev = NULL;\r\n}\r\npppox_unbind_sock(sk);\r\nrelease_sock(sk);\r\nsock_put(sk);\r\n}\r\nstatic int pppoe_disc_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct pppoe_hdr *ph;\r\nstruct pppox_sock *po;\r\nstruct pppoe_net *pn;\r\nskb = skb_share_check(skb, GFP_ATOMIC);\r\nif (!skb)\r\ngoto out;\r\nif (!pskb_may_pull(skb, sizeof(struct pppoe_hdr)))\r\ngoto abort;\r\nph = pppoe_hdr(skb);\r\nif (ph->code != PADT_CODE)\r\ngoto abort;\r\npn = pppoe_pernet(dev_net(dev));\r\npo = get_item(pn, ph->sid, eth_hdr(skb)->h_source, dev->ifindex);\r\nif (po)\r\nif (!schedule_work(&po->proto.pppoe.padt_work))\r\nsock_put(sk_pppox(po));\r\nabort:\r\nkfree_skb(skb);\r\nout:\r\nreturn NET_RX_SUCCESS;\r\n}\r\nstatic int pppoe_create(struct net *net, struct socket *sock, int kern)\r\n{\r\nstruct sock *sk;\r\nsk = sk_alloc(net, PF_PPPOX, GFP_KERNEL, &pppoe_sk_proto, kern);\r\nif (!sk)\r\nreturn -ENOMEM;\r\nsock_init_data(sock, sk);\r\nsock->state = SS_UNCONNECTED;\r\nsock->ops = &pppoe_ops;\r\nsk->sk_backlog_rcv = pppoe_rcv_core;\r\nsk->sk_state = PPPOX_NONE;\r\nsk->sk_type = SOCK_STREAM;\r\nsk->sk_family = PF_PPPOX;\r\nsk->sk_protocol = PX_PROTO_OE;\r\nINIT_WORK(&pppox_sk(sk)->proto.pppoe.padt_work,\r\npppoe_unbind_sock_work);\r\nreturn 0;\r\n}\r\nstatic int pppoe_release(struct socket *sock)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct pppox_sock *po;\r\nstruct pppoe_net *pn;\r\nstruct net *net = NULL;\r\nif (!sk)\r\nreturn 0;\r\nlock_sock(sk);\r\nif (sock_flag(sk, SOCK_DEAD)) {\r\nrelease_sock(sk);\r\nreturn -EBADF;\r\n}\r\npo = pppox_sk(sk);\r\nif (po->pppoe_dev) {\r\ndev_put(po->pppoe_dev);\r\npo->pppoe_dev = NULL;\r\n}\r\npppox_unbind_sock(sk);\r\nsk->sk_state = PPPOX_DEAD;\r\nnet = sock_net(sk);\r\npn = pppoe_pernet(net);\r\ndelete_item(pn, po->pppoe_pa.sid, po->pppoe_pa.remote,\r\npo->pppoe_ifindex);\r\nsock_orphan(sk);\r\nsock->sk = NULL;\r\nskb_queue_purge(&sk->sk_receive_queue);\r\nrelease_sock(sk);\r\nsock_put(sk);\r\nreturn 0;\r\n}\r\nstatic int pppoe_connect(struct socket *sock, struct sockaddr *uservaddr,\r\nint sockaddr_len, int flags)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct sockaddr_pppox *sp = (struct sockaddr_pppox *)uservaddr;\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nstruct net_device *dev = NULL;\r\nstruct pppoe_net *pn;\r\nstruct net *net = NULL;\r\nint error;\r\nlock_sock(sk);\r\nerror = -EINVAL;\r\nif (sp->sa_protocol != PX_PROTO_OE)\r\ngoto end;\r\nerror = -EBUSY;\r\nif ((sk->sk_state & PPPOX_CONNECTED) &&\r\nstage_session(sp->sa_addr.pppoe.sid))\r\ngoto end;\r\nerror = -EALREADY;\r\nif ((sk->sk_state & PPPOX_DEAD) &&\r\n!stage_session(sp->sa_addr.pppoe.sid))\r\ngoto end;\r\nerror = 0;\r\nif (stage_session(po->pppoe_pa.sid)) {\r\npppox_unbind_sock(sk);\r\npn = pppoe_pernet(sock_net(sk));\r\ndelete_item(pn, po->pppoe_pa.sid,\r\npo->pppoe_pa.remote, po->pppoe_ifindex);\r\nif (po->pppoe_dev) {\r\ndev_put(po->pppoe_dev);\r\npo->pppoe_dev = NULL;\r\n}\r\npo->pppoe_ifindex = 0;\r\nmemset(&po->pppoe_pa, 0, sizeof(po->pppoe_pa));\r\nmemset(&po->pppoe_relay, 0, sizeof(po->pppoe_relay));\r\nmemset(&po->chan, 0, sizeof(po->chan));\r\npo->next = NULL;\r\npo->num = 0;\r\nsk->sk_state = PPPOX_NONE;\r\n}\r\nif (stage_session(sp->sa_addr.pppoe.sid)) {\r\nerror = -ENODEV;\r\nnet = sock_net(sk);\r\ndev = dev_get_by_name(net, sp->sa_addr.pppoe.dev);\r\nif (!dev)\r\ngoto err_put;\r\npo->pppoe_dev = dev;\r\npo->pppoe_ifindex = dev->ifindex;\r\npn = pppoe_pernet(net);\r\nif (!(dev->flags & IFF_UP)) {\r\ngoto err_put;\r\n}\r\nmemcpy(&po->pppoe_pa,\r\n&sp->sa_addr.pppoe,\r\nsizeof(struct pppoe_addr));\r\nwrite_lock_bh(&pn->hash_lock);\r\nerror = __set_item(pn, po);\r\nwrite_unlock_bh(&pn->hash_lock);\r\nif (error < 0)\r\ngoto err_put;\r\npo->chan.hdrlen = (sizeof(struct pppoe_hdr) +\r\ndev->hard_header_len);\r\npo->chan.mtu = dev->mtu - sizeof(struct pppoe_hdr) - 2;\r\npo->chan.private = sk;\r\npo->chan.ops = &pppoe_chan_ops;\r\nerror = ppp_register_net_channel(dev_net(dev), &po->chan);\r\nif (error) {\r\ndelete_item(pn, po->pppoe_pa.sid,\r\npo->pppoe_pa.remote, po->pppoe_ifindex);\r\ngoto err_put;\r\n}\r\nsk->sk_state = PPPOX_CONNECTED;\r\n}\r\npo->num = sp->sa_addr.pppoe.sid;\r\nend:\r\nrelease_sock(sk);\r\nreturn error;\r\nerr_put:\r\nif (po->pppoe_dev) {\r\ndev_put(po->pppoe_dev);\r\npo->pppoe_dev = NULL;\r\n}\r\ngoto end;\r\n}\r\nstatic int pppoe_getname(struct socket *sock, struct sockaddr *uaddr,\r\nint *usockaddr_len, int peer)\r\n{\r\nint len = sizeof(struct sockaddr_pppox);\r\nstruct sockaddr_pppox sp;\r\nsp.sa_family = AF_PPPOX;\r\nsp.sa_protocol = PX_PROTO_OE;\r\nmemcpy(&sp.sa_addr.pppoe, &pppox_sk(sock->sk)->pppoe_pa,\r\nsizeof(struct pppoe_addr));\r\nmemcpy(uaddr, &sp, len);\r\n*usockaddr_len = len;\r\nreturn 0;\r\n}\r\nstatic int pppoe_ioctl(struct socket *sock, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nint val;\r\nint err;\r\nswitch (cmd) {\r\ncase PPPIOCGMRU:\r\nerr = -ENXIO;\r\nif (!(sk->sk_state & PPPOX_CONNECTED))\r\nbreak;\r\nerr = -EFAULT;\r\nif (put_user(po->pppoe_dev->mtu -\r\nsizeof(struct pppoe_hdr) -\r\nPPP_HDRLEN,\r\n(int __user *)arg))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPIOCSMRU:\r\nerr = -ENXIO;\r\nif (!(sk->sk_state & PPPOX_CONNECTED))\r\nbreak;\r\nerr = -EFAULT;\r\nif (get_user(val, (int __user *)arg))\r\nbreak;\r\nif (val < (po->pppoe_dev->mtu\r\n- sizeof(struct pppoe_hdr)\r\n- PPP_HDRLEN))\r\nerr = 0;\r\nelse\r\nerr = -EINVAL;\r\nbreak;\r\ncase PPPIOCSFLAGS:\r\nerr = -EFAULT;\r\nif (get_user(val, (int __user *)arg))\r\nbreak;\r\nerr = 0;\r\nbreak;\r\ncase PPPOEIOCSFWD:\r\n{\r\nstruct pppox_sock *relay_po;\r\nerr = -EBUSY;\r\nif (sk->sk_state & (PPPOX_BOUND | PPPOX_DEAD))\r\nbreak;\r\nerr = -ENOTCONN;\r\nif (!(sk->sk_state & PPPOX_CONNECTED))\r\nbreak;\r\nerr = -EFAULT;\r\nif (copy_from_user(&po->pppoe_relay,\r\n(void __user *)arg,\r\nsizeof(struct sockaddr_pppox)))\r\nbreak;\r\nerr = -EINVAL;\r\nif (po->pppoe_relay.sa_family != AF_PPPOX ||\r\npo->pppoe_relay.sa_protocol != PX_PROTO_OE)\r\nbreak;\r\nrelay_po = get_item_by_addr(sock_net(sk), &po->pppoe_relay);\r\nif (!relay_po)\r\nbreak;\r\nsock_put(sk_pppox(relay_po));\r\nsk->sk_state |= PPPOX_RELAY;\r\nerr = 0;\r\nbreak;\r\n}\r\ncase PPPOEIOCDFWD:\r\nerr = -EALREADY;\r\nif (!(sk->sk_state & PPPOX_RELAY))\r\nbreak;\r\nsk->sk_state &= ~PPPOX_RELAY;\r\nerr = 0;\r\nbreak;\r\ndefault:\r\nerr = -ENOTTY;\r\n}\r\nreturn err;\r\n}\r\nstatic int pppoe_sendmsg(struct socket *sock, struct msghdr *m,\r\nsize_t total_len)\r\n{\r\nstruct sk_buff *skb;\r\nstruct sock *sk = sock->sk;\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nint error;\r\nstruct pppoe_hdr hdr;\r\nstruct pppoe_hdr *ph;\r\nstruct net_device *dev;\r\nchar *start;\r\nlock_sock(sk);\r\nif (sock_flag(sk, SOCK_DEAD) || !(sk->sk_state & PPPOX_CONNECTED)) {\r\nerror = -ENOTCONN;\r\ngoto end;\r\n}\r\nhdr.ver = 1;\r\nhdr.type = 1;\r\nhdr.code = 0;\r\nhdr.sid = po->num;\r\ndev = po->pppoe_dev;\r\nerror = -EMSGSIZE;\r\nif (total_len > (dev->mtu + dev->hard_header_len))\r\ngoto end;\r\nskb = sock_wmalloc(sk, total_len + dev->hard_header_len + 32,\r\n0, GFP_KERNEL);\r\nif (!skb) {\r\nerror = -ENOMEM;\r\ngoto end;\r\n}\r\nskb_reserve(skb, dev->hard_header_len);\r\nskb_reset_network_header(skb);\r\nskb->dev = dev;\r\nskb->priority = sk->sk_priority;\r\nskb->protocol = cpu_to_be16(ETH_P_PPP_SES);\r\nph = (struct pppoe_hdr *)skb_put(skb, total_len + sizeof(struct pppoe_hdr));\r\nstart = (char *)&ph->tag[0];\r\nerror = memcpy_from_msg(start, m, total_len);\r\nif (error < 0) {\r\nkfree_skb(skb);\r\ngoto end;\r\n}\r\nerror = total_len;\r\ndev_hard_header(skb, dev, ETH_P_PPP_SES,\r\npo->pppoe_pa.remote, NULL, total_len);\r\nmemcpy(ph, &hdr, sizeof(struct pppoe_hdr));\r\nph->length = htons(total_len);\r\ndev_queue_xmit(skb);\r\nend:\r\nrelease_sock(sk);\r\nreturn error;\r\n}\r\nstatic int __pppoe_xmit(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct pppox_sock *po = pppox_sk(sk);\r\nstruct net_device *dev = po->pppoe_dev;\r\nstruct pppoe_hdr *ph;\r\nint data_len = skb->len;\r\nif (sock_flag(sk, SOCK_DEAD) || !(sk->sk_state & PPPOX_CONNECTED))\r\ngoto abort;\r\nif (!dev)\r\ngoto abort;\r\nif (skb_cow_head(skb, sizeof(*ph) + dev->hard_header_len))\r\ngoto abort;\r\n__skb_push(skb, sizeof(*ph));\r\nskb_reset_network_header(skb);\r\nph = pppoe_hdr(skb);\r\nph->ver = 1;\r\nph->type = 1;\r\nph->code = 0;\r\nph->sid = po->num;\r\nph->length = htons(data_len);\r\nskb->protocol = cpu_to_be16(ETH_P_PPP_SES);\r\nskb->dev = dev;\r\ndev_hard_header(skb, dev, ETH_P_PPP_SES,\r\npo->pppoe_pa.remote, NULL, data_len);\r\ndev_queue_xmit(skb);\r\nreturn 1;\r\nabort:\r\nkfree_skb(skb);\r\nreturn 1;\r\n}\r\nstatic int pppoe_xmit(struct ppp_channel *chan, struct sk_buff *skb)\r\n{\r\nstruct sock *sk = (struct sock *)chan->private;\r\nreturn __pppoe_xmit(sk, skb);\r\n}\r\nstatic int pppoe_recvmsg(struct socket *sock, struct msghdr *m,\r\nsize_t total_len, int flags)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct sk_buff *skb;\r\nint error = 0;\r\nif (sk->sk_state & PPPOX_BOUND) {\r\nerror = -EIO;\r\ngoto end;\r\n}\r\nskb = skb_recv_datagram(sk, flags & ~MSG_DONTWAIT,\r\nflags & MSG_DONTWAIT, &error);\r\nif (error < 0)\r\ngoto end;\r\nif (skb) {\r\ntotal_len = min_t(size_t, total_len, skb->len);\r\nerror = skb_copy_datagram_msg(skb, 0, m, total_len);\r\nif (error == 0) {\r\nconsume_skb(skb);\r\nreturn total_len;\r\n}\r\n}\r\nkfree_skb(skb);\r\nend:\r\nreturn error;\r\n}\r\nstatic int pppoe_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct pppox_sock *po;\r\nchar *dev_name;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(seq, "Id Address Device\n");\r\ngoto out;\r\n}\r\npo = v;\r\ndev_name = po->pppoe_pa.dev;\r\nseq_printf(seq, "%08X %pM %8s\n",\r\npo->pppoe_pa.sid, po->pppoe_pa.remote, dev_name);\r\nout:\r\nreturn 0;\r\n}\r\nstatic inline struct pppox_sock *pppoe_get_idx(struct pppoe_net *pn, loff_t pos)\r\n{\r\nstruct pppox_sock *po;\r\nint i;\r\nfor (i = 0; i < PPPOE_HASH_SIZE; i++) {\r\npo = pn->hash_table[i];\r\nwhile (po) {\r\nif (!pos--)\r\ngoto out;\r\npo = po->next;\r\n}\r\n}\r\nout:\r\nreturn po;\r\n}\r\nstatic void *pppoe_seq_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(pn->hash_lock)\r\n{\r\nstruct pppoe_net *pn = pppoe_pernet(seq_file_net(seq));\r\nloff_t l = *pos;\r\nread_lock_bh(&pn->hash_lock);\r\nreturn l ? pppoe_get_idx(pn, --l) : SEQ_START_TOKEN;\r\n}\r\nstatic void *pppoe_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct pppoe_net *pn = pppoe_pernet(seq_file_net(seq));\r\nstruct pppox_sock *po;\r\n++*pos;\r\nif (v == SEQ_START_TOKEN) {\r\npo = pppoe_get_idx(pn, 0);\r\ngoto out;\r\n}\r\npo = v;\r\nif (po->next)\r\npo = po->next;\r\nelse {\r\nint hash = hash_item(po->pppoe_pa.sid, po->pppoe_pa.remote);\r\npo = NULL;\r\nwhile (++hash < PPPOE_HASH_SIZE) {\r\npo = pn->hash_table[hash];\r\nif (po)\r\nbreak;\r\n}\r\n}\r\nout:\r\nreturn po;\r\n}\r\nstatic void pppoe_seq_stop(struct seq_file *seq, void *v)\r\n__releases(pn->hash_lock)\r\n{\r\nstruct pppoe_net *pn = pppoe_pernet(seq_file_net(seq));\r\nread_unlock_bh(&pn->hash_lock);\r\n}\r\nstatic int pppoe_seq_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open_net(inode, file, &pppoe_seq_ops,\r\nsizeof(struct seq_net_private));\r\n}\r\nstatic __net_init int pppoe_init_net(struct net *net)\r\n{\r\nstruct pppoe_net *pn = pppoe_pernet(net);\r\nstruct proc_dir_entry *pde;\r\nrwlock_init(&pn->hash_lock);\r\npde = proc_create("pppoe", S_IRUGO, net->proc_net, &pppoe_seq_fops);\r\n#ifdef CONFIG_PROC_FS\r\nif (!pde)\r\nreturn -ENOMEM;\r\n#endif\r\nreturn 0;\r\n}\r\nstatic __net_exit void pppoe_exit_net(struct net *net)\r\n{\r\nremove_proc_entry("pppoe", net->proc_net);\r\n}\r\nstatic int __init pppoe_init(void)\r\n{\r\nint err;\r\nerr = register_pernet_device(&pppoe_net_ops);\r\nif (err)\r\ngoto out;\r\nerr = proto_register(&pppoe_sk_proto, 0);\r\nif (err)\r\ngoto out_unregister_net_ops;\r\nerr = register_pppox_proto(PX_PROTO_OE, &pppoe_proto);\r\nif (err)\r\ngoto out_unregister_pppoe_proto;\r\ndev_add_pack(&pppoes_ptype);\r\ndev_add_pack(&pppoed_ptype);\r\nregister_netdevice_notifier(&pppoe_notifier);\r\nreturn 0;\r\nout_unregister_pppoe_proto:\r\nproto_unregister(&pppoe_sk_proto);\r\nout_unregister_net_ops:\r\nunregister_pernet_device(&pppoe_net_ops);\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit pppoe_exit(void)\r\n{\r\nunregister_netdevice_notifier(&pppoe_notifier);\r\ndev_remove_pack(&pppoed_ptype);\r\ndev_remove_pack(&pppoes_ptype);\r\nunregister_pppox_proto(PX_PROTO_OE);\r\nproto_unregister(&pppoe_sk_proto);\r\nunregister_pernet_device(&pppoe_net_ops);\r\n}

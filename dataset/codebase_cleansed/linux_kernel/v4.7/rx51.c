static void rx51_ext_control(struct snd_soc_dapm_context *dapm)\r\n{\r\nstruct snd_soc_card *card = dapm->card;\r\nstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\r\nint hp = 0, hs = 0, tvout = 0;\r\nswitch (rx51_jack_func) {\r\ncase RX51_JACK_TVOUT:\r\ntvout = 1;\r\nhp = 1;\r\nbreak;\r\ncase RX51_JACK_HS:\r\nhs = 1;\r\ncase RX51_JACK_HP:\r\nhp = 1;\r\nbreak;\r\n}\r\nsnd_soc_dapm_mutex_lock(dapm);\r\nif (rx51_spk_func)\r\nsnd_soc_dapm_enable_pin_unlocked(dapm, "Ext Spk");\r\nelse\r\nsnd_soc_dapm_disable_pin_unlocked(dapm, "Ext Spk");\r\nif (rx51_dmic_func)\r\nsnd_soc_dapm_enable_pin_unlocked(dapm, "DMic");\r\nelse\r\nsnd_soc_dapm_disable_pin_unlocked(dapm, "DMic");\r\nif (hp)\r\nsnd_soc_dapm_enable_pin_unlocked(dapm, "Headphone Jack");\r\nelse\r\nsnd_soc_dapm_disable_pin_unlocked(dapm, "Headphone Jack");\r\nif (hs)\r\nsnd_soc_dapm_enable_pin_unlocked(dapm, "HS Mic");\r\nelse\r\nsnd_soc_dapm_disable_pin_unlocked(dapm, "HS Mic");\r\ngpiod_set_value(pdata->tvout_selection_gpio, tvout);\r\nsnd_soc_dapm_sync_unlocked(dapm);\r\nsnd_soc_dapm_mutex_unlock(dapm);\r\n}\r\nstatic int rx51_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_card *card = rtd->card;\r\nsnd_pcm_hw_constraint_single(runtime, SNDRV_PCM_HW_PARAM_CHANNELS, 2);\r\nrx51_ext_control(&card->dapm);\r\nreturn 0;\r\n}\r\nstatic int rx51_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nreturn snd_soc_dai_set_sysclk(codec_dai, 0, 19200000,\r\nSND_SOC_CLOCK_IN);\r\n}\r\nstatic int rx51_get_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.enumerated.item[0] = rx51_spk_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_spk_func == ucontrol->value.enumerated.item[0])\r\nreturn 0;\r\nrx51_spk_func = ucontrol->value.enumerated.item[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_spk_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct snd_soc_dapm_context *dapm = w->dapm;\r\nstruct snd_soc_card *card = dapm->card;\r\nstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\r\ngpiod_set_raw_value_cansleep(pdata->speaker_amp_gpio,\r\n!!SND_SOC_DAPM_EVENT_ON(event));\r\nreturn 0;\r\n}\r\nstatic int rx51_hp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ntpa6130a2_stereo_enable(codec, 1);\r\nelse\r\ntpa6130a2_stereo_enable(codec, 0);\r\nreturn 0;\r\n}\r\nstatic int rx51_get_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.enumerated.item[0] = rx51_dmic_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_dmic_func == ucontrol->value.enumerated.item[0])\r\nreturn 0;\r\nrx51_dmic_func = ucontrol->value.enumerated.item[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_get_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.enumerated.item[0] = rx51_jack_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_jack_func == ucontrol->value.enumerated.item[0])\r\nreturn 0;\r\nrx51_jack_func = ucontrol->value.enumerated.item[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_aic34_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_card *card = rtd->card;\r\nstruct rx51_audio_pdata *pdata = snd_soc_card_get_drvdata(card);\r\nint err;\r\nerr = tpa6130a2_add_controls(codec);\r\nif (err < 0) {\r\ndev_err(card->dev, "Failed to add TPA6130A2 controls\n");\r\nreturn err;\r\n}\r\nsnd_soc_limit_volume(card, "TPA6130A2 Headphone Playback Volume", 42);\r\nerr = omap_mcbsp_st_add_controls(rtd, 2);\r\nif (err < 0) {\r\ndev_err(card->dev, "Failed to add MCBSP controls\n");\r\nreturn err;\r\n}\r\nerr = snd_soc_card_jack_new(rtd->card, "AV Jack",\r\nSND_JACK_HEADSET | SND_JACK_VIDEOOUT,\r\n&rx51_av_jack, NULL, 0);\r\nif (err) {\r\ndev_err(card->dev, "Failed to add AV Jack\n");\r\nreturn err;\r\n}\r\nrx51_av_jack_gpios[0].gpio = desc_to_gpio(pdata->jack_detection_gpio);\r\ndevm_gpiod_put(card->dev, pdata->jack_detection_gpio);\r\nerr = snd_soc_jack_add_gpios(&rx51_av_jack,\r\nARRAY_SIZE(rx51_av_jack_gpios),\r\nrx51_av_jack_gpios);\r\nif (err) {\r\ndev_err(card->dev, "Failed to add GPIOs\n");\r\nreturn err;\r\n}\r\nreturn err;\r\n}\r\nstatic int rx51_card_remove(struct snd_soc_card *card)\r\n{\r\nsnd_soc_jack_free_gpios(&rx51_av_jack, ARRAY_SIZE(rx51_av_jack_gpios),\r\nrx51_av_jack_gpios);\r\nreturn 0;\r\n}\r\nstatic int rx51_soc_probe(struct platform_device *pdev)\r\n{\r\nstruct rx51_audio_pdata *pdata;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct snd_soc_card *card = &rx51_sound_card;\r\nint err;\r\nif (!machine_is_nokia_rx51() && !of_machine_is_compatible("nokia,omap3-n900"))\r\nreturn -ENODEV;\r\ncard->dev = &pdev->dev;\r\nif (np) {\r\nstruct device_node *dai_node;\r\ndai_node = of_parse_phandle(np, "nokia,cpu-dai", 0);\r\nif (!dai_node) {\r\ndev_err(&pdev->dev, "McBSP node is not provided\n");\r\nreturn -EINVAL;\r\n}\r\nrx51_dai[0].cpu_dai_name = NULL;\r\nrx51_dai[0].platform_name = NULL;\r\nrx51_dai[0].cpu_of_node = dai_node;\r\nrx51_dai[0].platform_of_node = dai_node;\r\ndai_node = of_parse_phandle(np, "nokia,audio-codec", 0);\r\nif (!dai_node) {\r\ndev_err(&pdev->dev, "Codec node is not provided\n");\r\nreturn -EINVAL;\r\n}\r\nrx51_dai[0].codec_name = NULL;\r\nrx51_dai[0].codec_of_node = dai_node;\r\ndai_node = of_parse_phandle(np, "nokia,audio-codec", 1);\r\nif (!dai_node) {\r\ndev_err(&pdev->dev, "Auxiliary Codec node is not provided\n");\r\nreturn -EINVAL;\r\n}\r\nrx51_aux_dev[0].codec_name = NULL;\r\nrx51_aux_dev[0].codec_of_node = dai_node;\r\nrx51_codec_conf[0].dev_name = NULL;\r\nrx51_codec_conf[0].of_node = dai_node;\r\ndai_node = of_parse_phandle(np, "nokia,headphone-amplifier", 0);\r\nif (!dai_node) {\r\ndev_err(&pdev->dev, "Headphone amplifier node is not provided\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (pdata == NULL) {\r\ndev_err(card->dev, "failed to create private data\n");\r\nreturn -ENOMEM;\r\n}\r\nsnd_soc_card_set_drvdata(card, pdata);\r\npdata->tvout_selection_gpio = devm_gpiod_get(card->dev,\r\n"tvout-selection",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(pdata->tvout_selection_gpio)) {\r\ndev_err(card->dev, "could not get tvout selection gpio\n");\r\nreturn PTR_ERR(pdata->tvout_selection_gpio);\r\n}\r\npdata->jack_detection_gpio = devm_gpiod_get(card->dev,\r\n"jack-detection",\r\nGPIOD_ASIS);\r\nif (IS_ERR(pdata->jack_detection_gpio)) {\r\ndev_err(card->dev, "could not get jack detection gpio\n");\r\nreturn PTR_ERR(pdata->jack_detection_gpio);\r\n}\r\npdata->eci_sw_gpio = devm_gpiod_get(card->dev, "eci-switch",\r\nGPIOD_OUT_HIGH);\r\nif (IS_ERR(pdata->eci_sw_gpio)) {\r\ndev_err(card->dev, "could not get eci switch gpio\n");\r\nreturn PTR_ERR(pdata->eci_sw_gpio);\r\n}\r\npdata->speaker_amp_gpio = devm_gpiod_get(card->dev,\r\n"speaker-amplifier",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(pdata->speaker_amp_gpio)) {\r\ndev_err(card->dev, "could not get speaker enable gpio\n");\r\nreturn PTR_ERR(pdata->speaker_amp_gpio);\r\n}\r\nerr = devm_snd_soc_register_card(card->dev, card);\r\nif (err) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed (%d)\n", err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

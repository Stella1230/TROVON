static\r\nstruct rb_node *strlist__node_new(struct rblist *rblist, const void *entry)\r\n{\r\nconst char *s = entry;\r\nstruct rb_node *rc = NULL;\r\nstruct strlist *strlist = container_of(rblist, struct strlist, rblist);\r\nstruct str_node *snode = malloc(sizeof(*snode));\r\nif (snode != NULL) {\r\nif (strlist->dupstr) {\r\ns = strdup(s);\r\nif (s == NULL)\r\ngoto out_delete;\r\n}\r\nsnode->s = s;\r\nrc = &snode->rb_node;\r\n}\r\nreturn rc;\r\nout_delete:\r\nfree(snode);\r\nreturn NULL;\r\n}\r\nstatic void str_node__delete(struct str_node *snode, bool dupstr)\r\n{\r\nif (dupstr)\r\nzfree((char **)&snode->s);\r\nfree(snode);\r\n}\r\nstatic\r\nvoid strlist__node_delete(struct rblist *rblist, struct rb_node *rb_node)\r\n{\r\nstruct strlist *slist = container_of(rblist, struct strlist, rblist);\r\nstruct str_node *snode = container_of(rb_node, struct str_node, rb_node);\r\nstr_node__delete(snode, slist->dupstr);\r\n}\r\nstatic int strlist__node_cmp(struct rb_node *rb_node, const void *entry)\r\n{\r\nconst char *str = entry;\r\nstruct str_node *snode = container_of(rb_node, struct str_node, rb_node);\r\nreturn strcmp(snode->s, str);\r\n}\r\nint strlist__add(struct strlist *slist, const char *new_entry)\r\n{\r\nreturn rblist__add_node(&slist->rblist, new_entry);\r\n}\r\nint strlist__load(struct strlist *slist, const char *filename)\r\n{\r\nchar entry[1024];\r\nint err;\r\nFILE *fp = fopen(filename, "r");\r\nif (fp == NULL)\r\nreturn -errno;\r\nwhile (fgets(entry, sizeof(entry), fp) != NULL) {\r\nconst size_t len = strlen(entry);\r\nif (len == 0)\r\ncontinue;\r\nentry[len - 1] = '\0';\r\nerr = strlist__add(slist, entry);\r\nif (err != 0)\r\ngoto out;\r\n}\r\nerr = 0;\r\nout:\r\nfclose(fp);\r\nreturn err;\r\n}\r\nvoid strlist__remove(struct strlist *slist, struct str_node *snode)\r\n{\r\nrblist__remove_node(&slist->rblist, &snode->rb_node);\r\n}\r\nstruct str_node *strlist__find(struct strlist *slist, const char *entry)\r\n{\r\nstruct str_node *snode = NULL;\r\nstruct rb_node *rb_node = rblist__find(&slist->rblist, entry);\r\nif (rb_node)\r\nsnode = container_of(rb_node, struct str_node, rb_node);\r\nreturn snode;\r\n}\r\nstatic int strlist__parse_list_entry(struct strlist *slist, const char *s,\r\nconst char *subst_dir)\r\n{\r\nint err;\r\nchar *subst = NULL;\r\nif (strncmp(s, "file://", 7) == 0)\r\nreturn strlist__load(slist, s + 7);\r\nif (subst_dir) {\r\nerr = -ENOMEM;\r\nif (asprintf(&subst, "%s/%s", subst_dir, s) < 0)\r\ngoto out;\r\nif (access(subst, F_OK) == 0) {\r\nerr = strlist__load(slist, subst);\r\ngoto out;\r\n}\r\nif (slist->file_only) {\r\nerr = -ENOENT;\r\ngoto out;\r\n}\r\n}\r\nerr = strlist__add(slist, s);\r\nout:\r\nfree(subst);\r\nreturn err;\r\n}\r\nstatic int strlist__parse_list(struct strlist *slist, const char *s, const char *subst_dir)\r\n{\r\nchar *sep;\r\nint err;\r\nwhile ((sep = strchr(s, ',')) != NULL) {\r\n*sep = '\0';\r\nerr = strlist__parse_list_entry(slist, s, subst_dir);\r\n*sep = ',';\r\nif (err != 0)\r\nreturn err;\r\ns = sep + 1;\r\n}\r\nreturn *s ? strlist__parse_list_entry(slist, s, subst_dir) : 0;\r\n}\r\nstruct strlist *strlist__new(const char *list, const struct strlist_config *config)\r\n{\r\nstruct strlist *slist = malloc(sizeof(*slist));\r\nif (slist != NULL) {\r\nbool dupstr = true;\r\nbool file_only = false;\r\nconst char *dirname = NULL;\r\nif (config) {\r\ndupstr = !config->dont_dupstr;\r\ndirname = config->dirname;\r\nfile_only = config->file_only;\r\n}\r\nrblist__init(&slist->rblist);\r\nslist->rblist.node_cmp = strlist__node_cmp;\r\nslist->rblist.node_new = strlist__node_new;\r\nslist->rblist.node_delete = strlist__node_delete;\r\nslist->dupstr = dupstr;\r\nslist->file_only = file_only;\r\nif (list && strlist__parse_list(slist, list, dirname) != 0)\r\ngoto out_error;\r\n}\r\nreturn slist;\r\nout_error:\r\nfree(slist);\r\nreturn NULL;\r\n}\r\nvoid strlist__delete(struct strlist *slist)\r\n{\r\nif (slist != NULL)\r\nrblist__delete(&slist->rblist);\r\n}\r\nstruct str_node *strlist__entry(const struct strlist *slist, unsigned int idx)\r\n{\r\nstruct str_node *snode = NULL;\r\nstruct rb_node *rb_node;\r\nrb_node = rblist__entry(&slist->rblist, idx);\r\nif (rb_node)\r\nsnode = container_of(rb_node, struct str_node, rb_node);\r\nreturn snode;\r\n}

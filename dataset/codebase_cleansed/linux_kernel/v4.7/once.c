static void once_deferred(struct work_struct *w)\r\n{\r\nstruct once_work *work;\r\nwork = container_of(w, struct once_work, work);\r\nBUG_ON(!static_key_enabled(work->key));\r\nstatic_key_slow_dec(work->key);\r\nkfree(work);\r\n}\r\nstatic void once_disable_jump(struct static_key *key)\r\n{\r\nstruct once_work *w;\r\nw = kmalloc(sizeof(*w), GFP_ATOMIC);\r\nif (!w)\r\nreturn;\r\nINIT_WORK(&w->work, once_deferred);\r\nw->key = key;\r\nschedule_work(&w->work);\r\n}\r\nbool __do_once_start(bool *done, unsigned long *flags)\r\n__acquires(once_lock)\r\n{\r\nspin_lock_irqsave(&once_lock, *flags);\r\nif (*done) {\r\nspin_unlock_irqrestore(&once_lock, *flags);\r\n__acquire(once_lock);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nvoid __do_once_done(bool *done, struct static_key *once_key,\r\nunsigned long *flags)\r\n__releases(once_lock)\r\n{\r\n*done = true;\r\nspin_unlock_irqrestore(&once_lock, *flags);\r\nonce_disable_jump(once_key);\r\n}

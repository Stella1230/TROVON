static inline void xlp9xx_write_i2c_reg(struct xlp9xx_i2c_dev *priv,\r\nunsigned long reg, u32 val)\r\n{\r\nwritel(val, priv->base + reg);\r\n}\r\nstatic inline u32 xlp9xx_read_i2c_reg(struct xlp9xx_i2c_dev *priv,\r\nunsigned long reg)\r\n{\r\nreturn readl(priv->base + reg);\r\n}\r\nstatic void xlp9xx_i2c_mask_irq(struct xlp9xx_i2c_dev *priv, u32 mask)\r\n{\r\nu32 inten;\r\ninten = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_INTEN) & ~mask;\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTEN, inten);\r\n}\r\nstatic void xlp9xx_i2c_unmask_irq(struct xlp9xx_i2c_dev *priv, u32 mask)\r\n{\r\nu32 inten;\r\ninten = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_INTEN) | mask;\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTEN, inten);\r\n}\r\nstatic void xlp9xx_i2c_update_rx_fifo_thres(struct xlp9xx_i2c_dev *priv)\r\n{\r\nu32 thres;\r\nthres = min(priv->msg_buf_remaining, XLP9XX_I2C_FIFO_SIZE);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_MFIFOCTRL,\r\nthres << XLP9XX_I2C_MFIFOCTRL_HITH_SHIFT);\r\n}\r\nstatic void xlp9xx_i2c_fill_tx_fifo(struct xlp9xx_i2c_dev *priv)\r\n{\r\nu32 len, i;\r\nu8 *buf = priv->msg_buf;\r\nlen = min(priv->msg_buf_remaining, XLP9XX_I2C_FIFO_SIZE);\r\nfor (i = 0; i < len; i++)\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_MTXFIFO, buf[i]);\r\npriv->msg_buf_remaining -= len;\r\npriv->msg_buf += len;\r\n}\r\nstatic void xlp9xx_i2c_drain_rx_fifo(struct xlp9xx_i2c_dev *priv)\r\n{\r\nu32 len, i;\r\nu8 *buf = priv->msg_buf;\r\nlen = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_FIFOWCNT) &\r\nXLP9XX_I2C_FIFO_WCNT_MASK;\r\nlen = min(priv->msg_buf_remaining, len);\r\nfor (i = 0; i < len; i++, buf++)\r\n*buf = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_MRXFIFO);\r\npriv->msg_buf_remaining -= len;\r\npriv->msg_buf = buf;\r\nif (priv->msg_buf_remaining)\r\nxlp9xx_i2c_update_rx_fifo_thres(priv);\r\n}\r\nstatic irqreturn_t xlp9xx_i2c_isr(int irq, void *dev_id)\r\n{\r\nstruct xlp9xx_i2c_dev *priv = dev_id;\r\nu32 status;\r\nstatus = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_INTST);\r\nif (status == 0)\r\nreturn IRQ_NONE;\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTST, status);\r\nif (status & XLP9XX_I2C_STATUS_ERRMASK) {\r\npriv->msg_err = status;\r\ngoto xfer_done;\r\n}\r\nif ((status & XLP9XX_I2C_INTEN_SADDR) && (priv->msg_len == 0))\r\ngoto xfer_done;\r\nif (!priv->msg_read) {\r\nif (status & XLP9XX_I2C_INTEN_MFIFOEMTY) {\r\nif (priv->msg_buf_remaining)\r\nxlp9xx_i2c_fill_tx_fifo(priv);\r\nelse\r\nxlp9xx_i2c_mask_irq(priv,\r\nXLP9XX_I2C_INTEN_MFIFOEMTY);\r\n}\r\n} else {\r\nif (status & (XLP9XX_I2C_INTEN_DATADONE |\r\nXLP9XX_I2C_INTEN_MFIFOHI)) {\r\nif (priv->msg_buf_remaining)\r\nxlp9xx_i2c_drain_rx_fifo(priv);\r\n}\r\n}\r\nif (status & XLP9XX_I2C_INTEN_DATADONE)\r\ngoto xfer_done;\r\nreturn IRQ_HANDLED;\r\nxfer_done:\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTEN, 0);\r\ncomplete(&priv->msg_complete);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xlp9xx_i2c_init(struct xlp9xx_i2c_dev *priv)\r\n{\r\nu32 prescale;\r\nprescale = DIV_ROUND_UP(XLP9XX_I2C_IP_CLK_FREQ, priv->clk_hz);\r\nprescale = ((prescale - 8) / 5) - 1;\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_CTRL, XLP9XX_I2C_CTRL_RST);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_CTRL, XLP9XX_I2C_CTRL_EN |\r\nXLP9XX_I2C_CTRL_MASTER);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_DIV, prescale);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTEN, 0);\r\nreturn 0;\r\n}\r\nstatic int xlp9xx_i2c_xfer_msg(struct xlp9xx_i2c_dev *priv, struct i2c_msg *msg,\r\nint last_msg)\r\n{\r\nunsigned long timeleft;\r\nu32 intr_mask, cmd, val;\r\npriv->msg_buf = msg->buf;\r\npriv->msg_buf_remaining = priv->msg_len = msg->len;\r\npriv->msg_err = 0;\r\npriv->msg_read = (msg->flags & I2C_M_RD);\r\nreinit_completion(&priv->msg_complete);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_MFIFOCTRL,\r\nXLP9XX_I2C_MFIFOCTRL_RST);\r\nif (priv->msg_read)\r\nxlp9xx_i2c_update_rx_fifo_thres(priv);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_SLAVEADDR,\r\n(msg->addr << XLP9XX_I2C_SLAVEADDR_ADDR_SHIFT) |\r\n(priv->msg_read ? XLP9XX_I2C_SLAVEADDR_RW : 0));\r\nval = xlp9xx_read_i2c_reg(priv, XLP9XX_I2C_CTRL);\r\nif (!priv->msg_read)\r\nval &= ~XLP9XX_I2C_CTRL_FIFORD;\r\nelse\r\nval |= XLP9XX_I2C_CTRL_FIFORD;\r\nif (msg->flags & I2C_M_TEN)\r\nval |= XLP9XX_I2C_CTRL_ADDMODE;\r\nelse\r\nval &= ~XLP9XX_I2C_CTRL_ADDMODE;\r\nval = (val & ~XLP9XX_I2C_CTRL_MCTLEN_MASK) |\r\n(msg->len << XLP9XX_I2C_CTRL_MCTLEN_SHIFT);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_CTRL, val);\r\nif (!priv->msg_read)\r\nxlp9xx_i2c_fill_tx_fifo(priv);\r\nintr_mask = (XLP9XX_I2C_INTEN_ARLOST | XLP9XX_I2C_INTEN_BUSERR |\r\nXLP9XX_I2C_INTEN_NACKADDR | XLP9XX_I2C_INTEN_DATADONE);\r\nif (priv->msg_read) {\r\nintr_mask |= XLP9XX_I2C_INTEN_MFIFOHI;\r\nif (msg->len == 0)\r\nintr_mask |= XLP9XX_I2C_INTEN_SADDR;\r\n} else {\r\nif (msg->len == 0)\r\nintr_mask |= XLP9XX_I2C_INTEN_SADDR;\r\nelse\r\nintr_mask |= XLP9XX_I2C_INTEN_MFIFOEMTY;\r\n}\r\nxlp9xx_i2c_unmask_irq(priv, intr_mask);\r\ncmd = XLP9XX_I2C_CMD_START;\r\ncmd |= (priv->msg_read ? XLP9XX_I2C_CMD_READ : XLP9XX_I2C_CMD_WRITE);\r\nif (last_msg)\r\ncmd |= XLP9XX_I2C_CMD_STOP;\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_CMD, cmd);\r\ntimeleft = msecs_to_jiffies(XLP9XX_I2C_TIMEOUT_MS);\r\ntimeleft = wait_for_completion_timeout(&priv->msg_complete, timeleft);\r\nif (priv->msg_err) {\r\ndev_dbg(priv->dev, "transfer error %x!\n", priv->msg_err);\r\nif (priv->msg_err & XLP9XX_I2C_INTEN_BUSERR)\r\nxlp9xx_i2c_init(priv);\r\nreturn -EIO;\r\n}\r\nif (timeleft == 0) {\r\ndev_dbg(priv->dev, "i2c transfer timed out!\n");\r\nxlp9xx_i2c_init(priv);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xlp9xx_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nint i, ret;\r\nstruct xlp9xx_i2c_dev *priv = i2c_get_adapdata(adap);\r\nfor (i = 0; i < num; i++) {\r\nret = xlp9xx_i2c_xfer_msg(priv, &msgs[i], i == num - 1);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nreturn num;\r\n}\r\nstatic u32 xlp9xx_i2c_functionality(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL | I2C_FUNC_I2C |\r\nI2C_FUNC_10BIT_ADDR;\r\n}\r\nstatic int xlp9xx_i2c_get_frequency(struct platform_device *pdev,\r\nstruct xlp9xx_i2c_dev *priv)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nu32 freq;\r\nint err;\r\nerr = of_property_read_u32(np, "clock-frequency", &freq);\r\nif (err) {\r\nfreq = XLP9XX_I2C_DEFAULT_FREQ;\r\ndev_dbg(&pdev->dev, "using default frequency %u\n", freq);\r\n} else if (freq == 0 || freq > XLP9XX_I2C_HIGH_FREQ) {\r\ndev_warn(&pdev->dev, "invalid frequency %u, using default\n",\r\nfreq);\r\nfreq = XLP9XX_I2C_DEFAULT_FREQ;\r\n}\r\npriv->clk_hz = freq;\r\nreturn 0;\r\n}\r\nstatic int xlp9xx_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct xlp9xx_i2c_dev *priv;\r\nstruct resource *res;\r\nint err = 0;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->base))\r\nreturn PTR_ERR(priv->base);\r\npriv->irq = platform_get_irq(pdev, 0);\r\nif (priv->irq <= 0) {\r\ndev_err(&pdev->dev, "invalid irq!\n");\r\nreturn priv->irq;\r\n}\r\nxlp9xx_i2c_get_frequency(pdev, priv);\r\nxlp9xx_i2c_init(priv);\r\nerr = devm_request_irq(&pdev->dev, priv->irq, xlp9xx_i2c_isr, 0,\r\npdev->name, priv);\r\nif (err) {\r\ndev_err(&pdev->dev, "IRQ request failed!\n");\r\nreturn err;\r\n}\r\ninit_completion(&priv->msg_complete);\r\npriv->adapter.dev.parent = &pdev->dev;\r\npriv->adapter.algo = &xlp9xx_i2c_algo;\r\npriv->adapter.dev.of_node = pdev->dev.of_node;\r\npriv->dev = &pdev->dev;\r\nsnprintf(priv->adapter.name, sizeof(priv->adapter.name), "xlp9xx-i2c");\r\ni2c_set_adapdata(&priv->adapter, priv);\r\nerr = i2c_add_adapter(&priv->adapter);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to add I2C adapter!\n");\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\ndev_dbg(&pdev->dev, "I2C bus:%d added\n", priv->adapter.nr);\r\nreturn 0;\r\n}\r\nstatic int xlp9xx_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct xlp9xx_i2c_dev *priv;\r\npriv = platform_get_drvdata(pdev);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_INTEN, 0);\r\nsynchronize_irq(priv->irq);\r\ni2c_del_adapter(&priv->adapter);\r\nxlp9xx_write_i2c_reg(priv, XLP9XX_I2C_CTRL, 0);\r\nreturn 0;\r\n}

static void cbe_powerbutton_handle_pmi(pmi_message_t pmi_msg)\r\n{\r\nBUG_ON(pmi_msg.type != PMI_TYPE_POWER_BUTTON);\r\ninput_report_key(button_dev, KEY_POWER, 1);\r\ninput_sync(button_dev);\r\ninput_report_key(button_dev, KEY_POWER, 0);\r\ninput_sync(button_dev);\r\n}\r\nstatic int __init cbe_powerbutton_init(void)\r\n{\r\nint ret = 0;\r\nstruct input_dev *dev;\r\nif (!of_machine_is_compatible("IBM,CBPLUS-1.0")) {\r\nprintk(KERN_ERR "%s: Not a cell blade.\n", __func__);\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\ndev = input_allocate_device();\r\nif (!dev) {\r\nret = -ENOMEM;\r\nprintk(KERN_ERR "%s: Not enough memory.\n", __func__);\r\ngoto out;\r\n}\r\nset_bit(EV_KEY, dev->evbit);\r\nset_bit(KEY_POWER, dev->keybit);\r\ndev->name = "Power Button";\r\ndev->id.bustype = BUS_HOST;\r\ndev->id.product = 0x02;\r\ndev->phys = "LNXPWRBN/button/input0";\r\nbutton_pdev = platform_device_register_simple("power_button", 0, NULL, 0);\r\nif (IS_ERR(button_pdev)) {\r\nret = PTR_ERR(button_pdev);\r\ngoto out_free_input;\r\n}\r\ndev->dev.parent = &button_pdev->dev;\r\nret = input_register_device(dev);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: Failed to register device\n", __func__);\r\ngoto out_free_pdev;\r\n}\r\nbutton_dev = dev;\r\nret = pmi_register_handler(&cbe_pmi_handler);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: Failed to register with pmi.\n", __func__);\r\ngoto out_free_pdev;\r\n}\r\ngoto out;\r\nout_free_pdev:\r\nplatform_device_unregister(button_pdev);\r\nout_free_input:\r\ninput_free_device(dev);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void __exit cbe_powerbutton_exit(void)\r\n{\r\npmi_unregister_handler(&cbe_pmi_handler);\r\nplatform_device_unregister(button_pdev);\r\ninput_free_device(button_dev);\r\n}

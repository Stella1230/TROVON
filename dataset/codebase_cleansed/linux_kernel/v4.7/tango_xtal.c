static unsigned long notrace read_xtal_counter(void)\r\n{\r\nreturn readl_relaxed(xtal_in_cnt);\r\n}\r\nstatic u64 notrace read_sched_clock(void)\r\n{\r\nreturn read_xtal_counter();\r\n}\r\nstatic void __init tango_clocksource_init(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nint xtal_freq, ret;\r\nxtal_in_cnt = of_iomap(np, 0);\r\nif (xtal_in_cnt == NULL) {\r\npr_err("%s: invalid address\n", np->full_name);\r\nreturn;\r\n}\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("%s: invalid clock\n", np->full_name);\r\nreturn;\r\n}\r\nxtal_freq = clk_get_rate(clk);\r\ndelay_timer.freq = xtal_freq;\r\ndelay_timer.read_current_timer = read_xtal_counter;\r\nret = clocksource_mmio_init(xtal_in_cnt, "tango-xtal", xtal_freq, 350,\r\n32, clocksource_mmio_readl_up);\r\nif (ret) {\r\npr_err("%s: registration failed\n", np->full_name);\r\nreturn;\r\n}\r\nsched_clock_register(read_sched_clock, 32, xtal_freq);\r\nregister_current_timer_delay(&delay_timer);\r\n}

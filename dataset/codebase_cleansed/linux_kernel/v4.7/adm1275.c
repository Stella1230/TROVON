static int adm1275_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct adm1275_data *data = to_adm1275_data(info);\r\nint ret = 0;\r\nif (page)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_UC_FAULT_LIMIT:\r\nif (!data->have_uc_fault)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT);\r\nbreak;\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\nif (!data->have_oc_fault)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT);\r\nbreak;\r\ncase PMBUS_VOUT_OV_WARN_LIMIT:\r\nif (data->have_vout)\r\nreturn -ENODATA;\r\nret = pmbus_read_word_data(client, 0,\r\nADM1075_VAUX_OV_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_VOUT_UV_WARN_LIMIT:\r\nif (data->have_vout)\r\nreturn -ENODATA;\r\nret = pmbus_read_word_data(client, 0,\r\nADM1075_VAUX_UV_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_READ_VOUT:\r\nif (data->have_vout)\r\nreturn -ENODATA;\r\nret = pmbus_read_word_data(client, 0, ADM1075_READ_VAUX);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IOUT_MIN:\r\nif (!data->have_iout_min)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1293_IOUT_MIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IOUT_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_IOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_VOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_VIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_MIN:\r\nif (!data->have_pin_min)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1293_PIN_MIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_MAX:\r\nif (!data->have_pin_max)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1276_PEAK_PIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_TEMP_MAX:\r\nif (!data->have_temp_max)\r\nreturn -ENXIO;\r\nret = pmbus_read_word_data(client, 0, ADM1278_PEAK_TEMP);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_IOUT_HISTORY:\r\ncase PMBUS_VIRT_RESET_VOUT_HISTORY:\r\ncase PMBUS_VIRT_RESET_VIN_HISTORY:\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nif (!data->have_pin_max)\r\nreturn -ENXIO;\r\nbreak;\r\ncase PMBUS_VIRT_RESET_TEMP_HISTORY:\r\nif (!data->have_temp_max)\r\nreturn -ENXIO;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct adm1275_data *data = to_adm1275_data(info);\r\nint ret;\r\nif (page)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_UC_FAULT_LIMIT:\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\nret = pmbus_write_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT,\r\nword);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_IOUT_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_IOUT, 0);\r\nif (!ret && data->have_iout_min)\r\nret = pmbus_write_word_data(client, 0,\r\nADM1293_IOUT_MIN, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_VOUT_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_VOUT, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_VIN_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_VIN, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1276_PEAK_PIN, 0);\r\nif (!ret && data->have_pin_min)\r\nret = pmbus_write_word_data(client, 0,\r\nADM1293_PIN_MIN, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_TEMP_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1278_PEAK_TEMP, 0);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_read_byte_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct adm1275_data *data = to_adm1275_data(info);\r\nint mfr_status, ret;\r\nif (page > 0)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_STATUS_IOUT:\r\nret = pmbus_read_byte_data(client, page, PMBUS_STATUS_IOUT);\r\nif (ret < 0)\r\nbreak;\r\nif (!data->have_oc_fault && !data->have_uc_fault)\r\nbreak;\r\nmfr_status = pmbus_read_byte_data(client, page,\r\nPMBUS_STATUS_MFR_SPECIFIC);\r\nif (mfr_status < 0)\r\nreturn mfr_status;\r\nif (mfr_status & ADM1275_MFR_STATUS_IOUT_WARN2) {\r\nret |= data->have_oc_fault ?\r\nPB_IOUT_OC_FAULT : PB_IOUT_UC_FAULT;\r\n}\r\nbreak;\r\ncase PMBUS_STATUS_VOUT:\r\nif (data->have_vout)\r\nreturn -ENODATA;\r\nret = 0;\r\nif (data->have_vaux_status) {\r\nmfr_status = pmbus_read_byte_data(client, 0,\r\nADM1075_VAUX_STATUS);\r\nif (mfr_status < 0)\r\nreturn mfr_status;\r\nif (mfr_status & ADM1075_VAUX_OV_WARN)\r\nret |= PB_VOLTAGE_OV_WARNING;\r\nif (mfr_status & ADM1075_VAUX_UV_WARN)\r\nret |= PB_VOLTAGE_UV_WARNING;\r\n} else if (data->have_mfr_vaux_status) {\r\nmfr_status = pmbus_read_byte_data(client, page,\r\nPMBUS_STATUS_MFR_SPECIFIC);\r\nif (mfr_status < 0)\r\nreturn mfr_status;\r\nif (mfr_status & ADM1293_MFR_STATUS_VAUX_OV_WARN)\r\nret |= PB_VOLTAGE_OV_WARNING;\r\nif (mfr_status & ADM1293_MFR_STATUS_VAUX_UV_WARN)\r\nret |= PB_VOLTAGE_UV_WARNING;\r\n}\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nu8 block_buffer[I2C_SMBUS_BLOCK_MAX + 1];\r\nint config, device_config;\r\nint ret;\r\nstruct pmbus_driver_info *info;\r\nstruct adm1275_data *data;\r\nconst struct i2c_device_id *mid;\r\nconst struct coefficients *coefficients;\r\nint vindex = -1, voindex = -1, cindex = -1, pindex = -1;\r\nint tindex = -1;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_BYTE_DATA\r\n| I2C_FUNC_SMBUS_BLOCK_DATA))\r\nreturn -ENODEV;\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_ID, block_buffer);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read Manufacturer ID\n");\r\nreturn ret;\r\n}\r\nif (ret != 3 || strncmp(block_buffer, "ADI", 3)) {\r\ndev_err(&client->dev, "Unsupported Manufacturer ID\n");\r\nreturn -ENODEV;\r\n}\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_MODEL, block_buffer);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read Manufacturer Model\n");\r\nreturn ret;\r\n}\r\nfor (mid = adm1275_id; mid->name[0]; mid++) {\r\nif (!strncasecmp(mid->name, block_buffer, strlen(mid->name)))\r\nbreak;\r\n}\r\nif (!mid->name[0]) {\r\ndev_err(&client->dev, "Unsupported device\n");\r\nreturn -ENODEV;\r\n}\r\nif (id->driver_data != mid->driver_data)\r\ndev_notice(&client->dev,\r\n"Device mismatch: Configured %s, detected %s\n",\r\nid->name, mid->name);\r\nconfig = i2c_smbus_read_byte_data(client, ADM1275_PMON_CONFIG);\r\nif (config < 0)\r\nreturn config;\r\ndevice_config = i2c_smbus_read_byte_data(client, ADM1275_DEVICE_CONFIG);\r\nif (device_config < 0)\r\nreturn device_config;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct adm1275_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->id = mid->driver_data;\r\ninfo = &data->info;\r\ninfo->pages = 1;\r\ninfo->format[PSC_VOLTAGE_IN] = direct;\r\ninfo->format[PSC_VOLTAGE_OUT] = direct;\r\ninfo->format[PSC_CURRENT_OUT] = direct;\r\ninfo->format[PSC_POWER] = direct;\r\ninfo->format[PSC_TEMPERATURE] = direct;\r\ninfo->func[0] = PMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT;\r\ninfo->read_word_data = adm1275_read_word_data;\r\ninfo->read_byte_data = adm1275_read_byte_data;\r\ninfo->write_word_data = adm1275_write_word_data;\r\nswitch (data->id) {\r\ncase adm1075:\r\nif (device_config & ADM1275_IOUT_WARN2_SELECT)\r\ndata->have_oc_fault = true;\r\nelse\r\ndata->have_uc_fault = true;\r\ndata->have_pin_max = true;\r\ndata->have_vaux_status = true;\r\ncoefficients = adm1075_coefficients;\r\nvindex = 0;\r\nswitch (config & ADM1075_IRANGE_MASK) {\r\ncase ADM1075_IRANGE_25:\r\ncindex = 1;\r\npindex = 3;\r\nbreak;\r\ncase ADM1075_IRANGE_50:\r\ncindex = 2;\r\npindex = 4;\r\nbreak;\r\ndefault:\r\ndev_err(&client->dev, "Invalid input current range");\r\nbreak;\r\n}\r\ninfo->func[0] |= PMBUS_HAVE_VIN | PMBUS_HAVE_PIN\r\n| PMBUS_HAVE_STATUS_INPUT;\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nbreak;\r\ncase adm1275:\r\nif (device_config & ADM1275_IOUT_WARN2_SELECT)\r\ndata->have_oc_fault = true;\r\nelse\r\ndata->have_uc_fault = true;\r\ndata->have_vout = true;\r\ncoefficients = adm1275_coefficients;\r\nvindex = (config & ADM1275_VRANGE) ? 0 : 1;\r\ncindex = 2;\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nelse\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VIN | PMBUS_HAVE_STATUS_INPUT;\r\nbreak;\r\ncase adm1276:\r\nif (device_config & ADM1275_IOUT_WARN2_SELECT)\r\ndata->have_oc_fault = true;\r\nelse\r\ndata->have_uc_fault = true;\r\ndata->have_vout = true;\r\ndata->have_pin_max = true;\r\ncoefficients = adm1276_coefficients;\r\nvindex = (config & ADM1275_VRANGE) ? 0 : 1;\r\ncindex = 2;\r\npindex = (config & ADM1275_VRANGE) ? 3 : 4;\r\ninfo->func[0] |= PMBUS_HAVE_VIN | PMBUS_HAVE_PIN\r\n| PMBUS_HAVE_STATUS_INPUT;\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nbreak;\r\ncase adm1278:\r\ndata->have_vout = true;\r\ndata->have_pin_max = true;\r\ndata->have_temp_max = true;\r\ncoefficients = adm1278_coefficients;\r\nvindex = 0;\r\ncindex = 1;\r\npindex = 2;\r\ntindex = 3;\r\ninfo->func[0] |= PMBUS_HAVE_PIN | PMBUS_HAVE_STATUS_INPUT;\r\nif (config & ADM1278_TEMP1_EN)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP;\r\nif (config & ADM1278_VIN_EN)\r\ninfo->func[0] |= PMBUS_HAVE_VIN;\r\nif (config & ADM1278_VOUT_EN)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nbreak;\r\ncase adm1293:\r\ncase adm1294:\r\ndata->have_iout_min = true;\r\ndata->have_pin_min = true;\r\ndata->have_pin_max = true;\r\ndata->have_mfr_vaux_status = true;\r\ncoefficients = adm1293_coefficients;\r\nvoindex = 0;\r\nswitch (config & ADM1293_VIN_SEL_MASK) {\r\ncase ADM1293_VIN_SEL_012:\r\nvindex = 0;\r\nbreak;\r\ncase ADM1293_VIN_SEL_074:\r\nvindex = 1;\r\nbreak;\r\ncase ADM1293_VIN_SEL_210:\r\nvindex = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (config & ADM1293_IRANGE_MASK) {\r\ncase ADM1293_IRANGE_25:\r\ncindex = 3;\r\nbreak;\r\ncase ADM1293_IRANGE_50:\r\ncindex = 4;\r\nbreak;\r\ncase ADM1293_IRANGE_100:\r\ncindex = 5;\r\nbreak;\r\ncase ADM1293_IRANGE_200:\r\ncindex = 6;\r\nbreak;\r\n}\r\nif (vindex >= 0)\r\npindex = 7 + vindex * 4 + (cindex - 3);\r\nif (config & ADM1293_VAUX_EN)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\ninfo->func[0] |= PMBUS_HAVE_PIN |\r\nPMBUS_HAVE_VIN | PMBUS_HAVE_STATUS_INPUT;\r\nbreak;\r\ndefault:\r\ndev_err(&client->dev, "Unsupported device\n");\r\nreturn -ENODEV;\r\n}\r\nif (voindex < 0)\r\nvoindex = vindex;\r\nif (vindex >= 0) {\r\ninfo->m[PSC_VOLTAGE_IN] = coefficients[vindex].m;\r\ninfo->b[PSC_VOLTAGE_IN] = coefficients[vindex].b;\r\ninfo->R[PSC_VOLTAGE_IN] = coefficients[vindex].R;\r\n}\r\nif (voindex >= 0) {\r\ninfo->m[PSC_VOLTAGE_OUT] = coefficients[voindex].m;\r\ninfo->b[PSC_VOLTAGE_OUT] = coefficients[voindex].b;\r\ninfo->R[PSC_VOLTAGE_OUT] = coefficients[voindex].R;\r\n}\r\nif (cindex >= 0) {\r\ninfo->m[PSC_CURRENT_OUT] = coefficients[cindex].m;\r\ninfo->b[PSC_CURRENT_OUT] = coefficients[cindex].b;\r\ninfo->R[PSC_CURRENT_OUT] = coefficients[cindex].R;\r\n}\r\nif (pindex >= 0) {\r\ninfo->m[PSC_POWER] = coefficients[pindex].m;\r\ninfo->b[PSC_POWER] = coefficients[pindex].b;\r\ninfo->R[PSC_POWER] = coefficients[pindex].R;\r\n}\r\nif (tindex >= 0) {\r\ninfo->m[PSC_TEMPERATURE] = coefficients[tindex].m;\r\ninfo->b[PSC_TEMPERATURE] = coefficients[tindex].b;\r\ninfo->R[PSC_TEMPERATURE] = coefficients[tindex].R;\r\n}\r\nreturn pmbus_do_probe(client, id, info);\r\n}

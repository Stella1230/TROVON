static void slimpro_i2c_rx_cb(struct mbox_client *cl, void *mssg)\r\n{\r\nstruct slimpro_i2c_dev *ctx = to_slimpro_i2c_dev(cl);\r\nif (ctx->resp_msg)\r\n*ctx->resp_msg = ((u32 *)mssg)[1];\r\nif (ctx->mbox_client.tx_block)\r\ncomplete(&ctx->rd_complete);\r\n}\r\nstatic int start_i2c_msg_xfer(struct slimpro_i2c_dev *ctx)\r\n{\r\nif (ctx->mbox_client.tx_block) {\r\nif (!wait_for_completion_timeout(&ctx->rd_complete,\r\nmsecs_to_jiffies(MAILBOX_OP_TIMEOUT)))\r\nreturn -ETIMEDOUT;\r\n}\r\nif (*ctx->resp_msg == 0xffffffff)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int slimpro_i2c_rd(struct slimpro_i2c_dev *ctx, u32 chip,\r\nu32 addr, u32 addrlen, u32 protocol,\r\nu32 readlen, u32 *data)\r\n{\r\nu32 msg[3];\r\nint rc;\r\nmsg[0] = SLIMPRO_IIC_ENCODE_MSG(SLIMPRO_IIC_BUS, chip,\r\nSLIMPRO_IIC_READ, protocol, addrlen, readlen);\r\nmsg[1] = SLIMPRO_IIC_ENCODE_ADDR(addr);\r\nmsg[2] = 0;\r\nctx->resp_msg = data;\r\nrc = mbox_send_message(ctx->mbox_chan, &msg);\r\nif (rc < 0)\r\ngoto err;\r\nrc = start_i2c_msg_xfer(ctx);\r\nerr:\r\nctx->resp_msg = NULL;\r\nreturn rc;\r\n}\r\nstatic int slimpro_i2c_wr(struct slimpro_i2c_dev *ctx, u32 chip,\r\nu32 addr, u32 addrlen, u32 protocol, u32 writelen,\r\nu32 data)\r\n{\r\nu32 msg[3];\r\nint rc;\r\nmsg[0] = SLIMPRO_IIC_ENCODE_MSG(SLIMPRO_IIC_BUS, chip,\r\nSLIMPRO_IIC_WRITE, protocol, addrlen, writelen);\r\nmsg[1] = SLIMPRO_IIC_ENCODE_ADDR(addr);\r\nmsg[2] = data;\r\nctx->resp_msg = msg;\r\nrc = mbox_send_message(ctx->mbox_chan, &msg);\r\nif (rc < 0)\r\ngoto err;\r\nrc = start_i2c_msg_xfer(ctx);\r\nerr:\r\nctx->resp_msg = NULL;\r\nreturn rc;\r\n}\r\nstatic int slimpro_i2c_blkrd(struct slimpro_i2c_dev *ctx, u32 chip, u32 addr,\r\nu32 addrlen, u32 protocol, u32 readlen,\r\nu32 with_data_len, void *data)\r\n{\r\ndma_addr_t paddr;\r\nu32 msg[3];\r\nint rc;\r\npaddr = dma_map_single(ctx->dev, ctx->dma_buffer, readlen, DMA_FROM_DEVICE);\r\nif (dma_mapping_error(ctx->dev, paddr)) {\r\ndev_err(&ctx->adapter.dev, "Error in mapping dma buffer %p\n",\r\nctx->dma_buffer);\r\nrc = -ENOMEM;\r\ngoto err;\r\n}\r\nmsg[0] = SLIMPRO_IIC_ENCODE_MSG(SLIMPRO_IIC_BUS, chip, SLIMPRO_IIC_READ,\r\nprotocol, addrlen, readlen);\r\nmsg[1] = SLIMPRO_IIC_ENCODE_FLAG_BUFADDR |\r\nSLIMPRO_IIC_ENCODE_FLAG_WITH_DATA_LEN(with_data_len) |\r\nSLIMPRO_IIC_ENCODE_UPPER_BUFADDR(paddr) |\r\nSLIMPRO_IIC_ENCODE_ADDR(addr);\r\nmsg[2] = (u32)paddr;\r\nctx->resp_msg = msg;\r\nrc = mbox_send_message(ctx->mbox_chan, &msg);\r\nif (rc < 0)\r\ngoto err_unmap;\r\nrc = start_i2c_msg_xfer(ctx);\r\nmemcpy(data, ctx->dma_buffer, readlen);\r\nerr_unmap:\r\ndma_unmap_single(ctx->dev, paddr, readlen, DMA_FROM_DEVICE);\r\nerr:\r\nctx->resp_msg = NULL;\r\nreturn rc;\r\n}\r\nstatic int slimpro_i2c_blkwr(struct slimpro_i2c_dev *ctx, u32 chip,\r\nu32 addr, u32 addrlen, u32 protocol, u32 writelen,\r\nvoid *data)\r\n{\r\ndma_addr_t paddr;\r\nu32 msg[3];\r\nint rc;\r\nmemcpy(ctx->dma_buffer, data, writelen);\r\npaddr = dma_map_single(ctx->dev, ctx->dma_buffer, writelen,\r\nDMA_TO_DEVICE);\r\nif (dma_mapping_error(ctx->dev, paddr)) {\r\ndev_err(&ctx->adapter.dev, "Error in mapping dma buffer %p\n",\r\nctx->dma_buffer);\r\nrc = -ENOMEM;\r\ngoto err;\r\n}\r\nmsg[0] = SLIMPRO_IIC_ENCODE_MSG(SLIMPRO_IIC_BUS, chip, SLIMPRO_IIC_WRITE,\r\nprotocol, addrlen, writelen);\r\nmsg[1] = SLIMPRO_IIC_ENCODE_FLAG_BUFADDR |\r\nSLIMPRO_IIC_ENCODE_UPPER_BUFADDR(paddr) |\r\nSLIMPRO_IIC_ENCODE_ADDR(addr);\r\nmsg[2] = (u32)paddr;\r\nctx->resp_msg = msg;\r\nif (ctx->mbox_client.tx_block)\r\nreinit_completion(&ctx->rd_complete);\r\nrc = mbox_send_message(ctx->mbox_chan, &msg);\r\nif (rc < 0)\r\ngoto err_unmap;\r\nrc = start_i2c_msg_xfer(ctx);\r\nerr_unmap:\r\ndma_unmap_single(ctx->dev, paddr, writelen, DMA_TO_DEVICE);\r\nerr:\r\nctx->resp_msg = NULL;\r\nreturn rc;\r\n}\r\nstatic int xgene_slimpro_i2c_xfer(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data *data)\r\n{\r\nstruct slimpro_i2c_dev *ctx = i2c_get_adapdata(adap);\r\nint ret = -EOPNOTSUPP;\r\nu32 val;\r\nswitch (size) {\r\ncase I2C_SMBUS_BYTE:\r\nif (read_write == I2C_SMBUS_READ) {\r\nret = slimpro_i2c_rd(ctx, addr, 0, 0,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nBYTE_DATA, &val);\r\ndata->byte = val;\r\n} else {\r\nret = slimpro_i2c_wr(ctx, addr, command, SMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\n0, 0);\r\n}\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\nif (read_write == I2C_SMBUS_READ) {\r\nret = slimpro_i2c_rd(ctx, addr, command, SMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nBYTE_DATA, &val);\r\ndata->byte = val;\r\n} else {\r\nval = data->byte;\r\nret = slimpro_i2c_wr(ctx, addr, command, SMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nBYTE_DATA, val);\r\n}\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\nif (read_write == I2C_SMBUS_READ) {\r\nret = slimpro_i2c_rd(ctx, addr, command, SMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nWORD_DATA, &val);\r\ndata->word = val;\r\n} else {\r\nval = data->word;\r\nret = slimpro_i2c_wr(ctx, addr, command, SMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nWORD_DATA, val);\r\n}\r\nbreak;\r\ncase I2C_SMBUS_BLOCK_DATA:\r\nif (read_write == I2C_SMBUS_READ) {\r\nret = slimpro_i2c_blkrd(ctx, addr, command,\r\nSMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\nI2C_SMBUS_BLOCK_MAX + 1,\r\nIIC_SMB_WITH_DATA_LEN,\r\n&data->block[0]);\r\n} else {\r\nret = slimpro_i2c_blkwr(ctx, addr, command,\r\nSMBUS_CMD_LEN,\r\nSLIMPRO_IIC_SMB_PROTOCOL,\r\ndata->block[0] + 1,\r\n&data->block[0]);\r\n}\r\nbreak;\r\ncase I2C_SMBUS_I2C_BLOCK_DATA:\r\nif (read_write == I2C_SMBUS_READ) {\r\nret = slimpro_i2c_blkrd(ctx, addr,\r\ncommand,\r\nSMBUS_CMD_LEN,\r\nSLIMPRO_IIC_I2C_PROTOCOL,\r\nI2C_SMBUS_BLOCK_MAX,\r\nIIC_SMB_WITHOUT_DATA_LEN,\r\n&data->block[1]);\r\n} else {\r\nret = slimpro_i2c_blkwr(ctx, addr, command,\r\nSMBUS_CMD_LEN,\r\nSLIMPRO_IIC_I2C_PROTOCOL,\r\ndata->block[0],\r\n&data->block[1]);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic u32 xgene_slimpro_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_DATA |\r\nI2C_FUNC_SMBUS_I2C_BLOCK;\r\n}\r\nstatic int xgene_slimpro_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct slimpro_i2c_dev *ctx;\r\nstruct i2c_adapter *adapter;\r\nstruct mbox_client *cl;\r\nint rc;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, ctx);\r\ncl = &ctx->mbox_client;\r\ncl->dev = &pdev->dev;\r\ncl->rx_callback = slimpro_i2c_rx_cb;\r\ncl->tx_block = true;\r\ninit_completion(&ctx->rd_complete);\r\ncl->tx_tout = MAILBOX_OP_TIMEOUT;\r\ncl->knows_txdone = false;\r\nctx->mbox_chan = mbox_request_channel(cl, MAILBOX_I2C_INDEX);\r\nif (IS_ERR(ctx->mbox_chan)) {\r\ndev_err(&pdev->dev, "i2c mailbox channel request failed\n");\r\nreturn PTR_ERR(ctx->mbox_chan);\r\n}\r\nrc = dma_set_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(64));\r\nif (rc)\r\ndev_warn(&pdev->dev, "Unable to set dma mask\n");\r\nadapter = &ctx->adapter;\r\nsnprintf(adapter->name, sizeof(adapter->name), "MAILBOX I2C");\r\nadapter->algo = &xgene_slimpro_i2c_algorithm;\r\nadapter->class = I2C_CLASS_HWMON;\r\nadapter->dev.parent = &pdev->dev;\r\ni2c_set_adapdata(adapter, ctx);\r\nrc = i2c_add_adapter(adapter);\r\nif (rc) {\r\ndev_err(&pdev->dev, "Adapter registeration failed\n");\r\nmbox_free_channel(ctx->mbox_chan);\r\nreturn rc;\r\n}\r\ndev_info(&pdev->dev, "Mailbox I2C Adapter registered\n");\r\nreturn 0;\r\n}\r\nstatic int xgene_slimpro_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct slimpro_i2c_dev *ctx = platform_get_drvdata(pdev);\r\ni2c_del_adapter(&ctx->adapter);\r\nmbox_free_channel(ctx->mbox_chan);\r\nreturn 0;\r\n}

static void nvidia_gpio_setscl(void *data, int state)\r\n{\r\nstruct nvidia_i2c_chan *chan = data;\r\nstruct nvidia_par *par = chan->par;\r\nu32 val;\r\nval = NVReadCrtc(par, chan->ddc_base + 1) & 0xf0;\r\nif (state)\r\nval |= 0x20;\r\nelse\r\nval &= ~0x20;\r\nNVWriteCrtc(par, chan->ddc_base + 1, val | 0x01);\r\n}\r\nstatic void nvidia_gpio_setsda(void *data, int state)\r\n{\r\nstruct nvidia_i2c_chan *chan = data;\r\nstruct nvidia_par *par = chan->par;\r\nu32 val;\r\nval = NVReadCrtc(par, chan->ddc_base + 1) & 0xf0;\r\nif (state)\r\nval |= 0x10;\r\nelse\r\nval &= ~0x10;\r\nNVWriteCrtc(par, chan->ddc_base + 1, val | 0x01);\r\n}\r\nstatic int nvidia_gpio_getscl(void *data)\r\n{\r\nstruct nvidia_i2c_chan *chan = data;\r\nstruct nvidia_par *par = chan->par;\r\nu32 val = 0;\r\nif (NVReadCrtc(par, chan->ddc_base) & 0x04)\r\nval = 1;\r\nreturn val;\r\n}\r\nstatic int nvidia_gpio_getsda(void *data)\r\n{\r\nstruct nvidia_i2c_chan *chan = data;\r\nstruct nvidia_par *par = chan->par;\r\nu32 val = 0;\r\nif (NVReadCrtc(par, chan->ddc_base) & 0x08)\r\nval = 1;\r\nreturn val;\r\n}\r\nstatic int nvidia_setup_i2c_bus(struct nvidia_i2c_chan *chan, const char *name,\r\nunsigned int i2c_class)\r\n{\r\nint rc;\r\nstrcpy(chan->adapter.name, name);\r\nchan->adapter.owner = THIS_MODULE;\r\nchan->adapter.class = i2c_class;\r\nchan->adapter.algo_data = &chan->algo;\r\nchan->adapter.dev.parent = &chan->par->pci_dev->dev;\r\nchan->algo.setsda = nvidia_gpio_setsda;\r\nchan->algo.setscl = nvidia_gpio_setscl;\r\nchan->algo.getsda = nvidia_gpio_getsda;\r\nchan->algo.getscl = nvidia_gpio_getscl;\r\nchan->algo.udelay = 40;\r\nchan->algo.timeout = msecs_to_jiffies(2);\r\nchan->algo.data = chan;\r\ni2c_set_adapdata(&chan->adapter, chan);\r\nnvidia_gpio_setsda(chan, 1);\r\nnvidia_gpio_setscl(chan, 1);\r\nudelay(20);\r\nrc = i2c_bit_add_bus(&chan->adapter);\r\nif (rc == 0)\r\ndev_dbg(&chan->par->pci_dev->dev,\r\n"I2C bus %s registered.\n", name);\r\nelse {\r\ndev_warn(&chan->par->pci_dev->dev,\r\n"Failed to register I2C bus %s.\n", name);\r\nchan->par = NULL;\r\n}\r\nreturn rc;\r\n}\r\nvoid nvidia_create_i2c_busses(struct nvidia_par *par)\r\n{\r\npar->chan[0].par = par;\r\npar->chan[1].par = par;\r\npar->chan[2].par = par;\r\npar->chan[0].ddc_base = (par->reverse_i2c) ? 0x36 : 0x3e;\r\nnvidia_setup_i2c_bus(&par->chan[0], "nvidia #0",\r\n(par->reverse_i2c) ? I2C_CLASS_HWMON : 0);\r\npar->chan[1].ddc_base = (par->reverse_i2c) ? 0x3e : 0x36;\r\nnvidia_setup_i2c_bus(&par->chan[1], "nvidia #1",\r\n(par->reverse_i2c) ? 0 : I2C_CLASS_HWMON);\r\npar->chan[2].ddc_base = 0x50;\r\nnvidia_setup_i2c_bus(&par->chan[2], "nvidia #2", 0);\r\n}\r\nvoid nvidia_delete_i2c_busses(struct nvidia_par *par)\r\n{\r\nint i;\r\nfor (i = 0; i < 3; i++) {\r\nif (!par->chan[i].par)\r\ncontinue;\r\ni2c_del_adapter(&par->chan[i].adapter);\r\npar->chan[i].par = NULL;\r\n}\r\n}\r\nint nvidia_probe_i2c_connector(struct fb_info *info, int conn, u8 **out_edid)\r\n{\r\nstruct nvidia_par *par = info->par;\r\nu8 *edid = NULL;\r\nif (par->chan[conn - 1].par)\r\nedid = fb_ddc_read(&par->chan[conn - 1].adapter);\r\nif (!edid && conn == 1) {\r\nconst u8 *e = fb_firmware_edid(info->device);\r\nif (e != NULL)\r\nedid = kmemdup(e, EDID_LENGTH, GFP_KERNEL);\r\n}\r\n*out_edid = edid;\r\nreturn (edid) ? 0 : 1;\r\n}

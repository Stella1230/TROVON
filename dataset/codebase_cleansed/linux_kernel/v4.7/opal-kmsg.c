static void force_opal_console_flush(struct kmsg_dumper *dumper,\r\nenum kmsg_dump_reason reason)\r\n{\r\nint i;\r\nint64_t ret;\r\nif (reason != KMSG_DUMP_PANIC)\r\nreturn;\r\nif (opal_check_token(OPAL_CONSOLE_FLUSH)) {\r\nret = opal_console_flush(0);\r\nif (ret == OPAL_UNSUPPORTED || ret == OPAL_PARAMETER)\r\nreturn;\r\nwhile (opal_console_flush(0) != OPAL_SUCCESS);\r\n} else {\r\nprintk(KERN_NOTICE "opal: OPAL_CONSOLE_FLUSH missing.\n");\r\nfor (i = 0; i < 1024; i++) {\r\nopal_poll_events(NULL);\r\n}\r\n}\r\n}\r\nvoid __init opal_kmsg_init(void)\r\n{\r\nint rc;\r\nrc = kmsg_dump_register(&opal_kmsg_dumper);\r\nif (rc != 0)\r\npr_err("opal: kmsg_dump_register failed; returned %d\n", rc);\r\n}

int ntfs_cluster_free_from_rl_nolock(ntfs_volume *vol,\r\nconst runlist_element *rl)\r\n{\r\nstruct inode *lcnbmp_vi = vol->lcnbmp_ino;\r\nint ret = 0;\r\nntfs_debug("Entering.");\r\nif (!rl)\r\nreturn 0;\r\nfor (; rl->length; rl++) {\r\nint err;\r\nif (rl->lcn < 0)\r\ncontinue;\r\nerr = ntfs_bitmap_clear_run(lcnbmp_vi, rl->lcn, rl->length);\r\nif (unlikely(err && (!ret || ret == -ENOMEM) && ret != err))\r\nret = err;\r\n}\r\nntfs_debug("Done.");\r\nreturn ret;\r\n}\r\nrunlist_element *ntfs_cluster_alloc(ntfs_volume *vol, const VCN start_vcn,\r\nconst s64 count, const LCN start_lcn,\r\nconst NTFS_CLUSTER_ALLOCATION_ZONES zone,\r\nconst bool is_extension)\r\n{\r\nLCN zone_start, zone_end, bmp_pos, bmp_initial_pos, last_read_pos, lcn;\r\nLCN prev_lcn = 0, prev_run_len = 0, mft_zone_size;\r\ns64 clusters;\r\nloff_t i_size;\r\nstruct inode *lcnbmp_vi;\r\nrunlist_element *rl = NULL;\r\nstruct address_space *mapping;\r\nstruct page *page = NULL;\r\nu8 *buf, *byte;\r\nint err = 0, rlpos, rlsize, buf_size;\r\nu8 pass, done_zones, search_zone, need_writeback = 0, bit;\r\nntfs_debug("Entering for start_vcn 0x%llx, count 0x%llx, start_lcn "\r\n"0x%llx, zone %s_ZONE.", (unsigned long long)start_vcn,\r\n(unsigned long long)count,\r\n(unsigned long long)start_lcn,\r\nzone == MFT_ZONE ? "MFT" : "DATA");\r\nBUG_ON(!vol);\r\nlcnbmp_vi = vol->lcnbmp_ino;\r\nBUG_ON(!lcnbmp_vi);\r\nBUG_ON(start_vcn < 0);\r\nBUG_ON(count < 0);\r\nBUG_ON(start_lcn < -1);\r\nBUG_ON(zone < FIRST_ZONE);\r\nBUG_ON(zone > LAST_ZONE);\r\nif (!count)\r\nreturn NULL;\r\ndown_write(&vol->lcnbmp_lock);\r\ndone_zones = 0;\r\npass = 1;\r\nzone_start = start_lcn;\r\nif (zone_start < 0) {\r\nif (zone == DATA_ZONE)\r\nzone_start = vol->data1_zone_pos;\r\nelse\r\nzone_start = vol->mft_zone_pos;\r\nif (!zone_start) {\r\npass = 2;\r\n}\r\n} else if (zone == DATA_ZONE && zone_start >= vol->mft_zone_start &&\r\nzone_start < vol->mft_zone_end) {\r\nzone_start = vol->mft_zone_end;\r\npass = 2;\r\n} else if (zone == MFT_ZONE && (zone_start < vol->mft_zone_start ||\r\nzone_start >= vol->mft_zone_end)) {\r\nzone_start = vol->mft_lcn;\r\nif (!vol->mft_zone_end)\r\nzone_start = 0;\r\npass = 2;\r\n}\r\nif (zone == MFT_ZONE) {\r\nzone_end = vol->mft_zone_end;\r\nsearch_zone = 1;\r\n} else {\r\ndone_zones |= 1;\r\nif (zone_start >= vol->mft_zone_end) {\r\nzone_end = vol->nr_clusters;\r\nsearch_zone = 2;\r\n} else {\r\nzone_end = vol->mft_zone_start;\r\nsearch_zone = 4;\r\n}\r\n}\r\nbmp_pos = bmp_initial_pos = zone_start;\r\nclusters = count;\r\nrlpos = rlsize = 0;\r\nmapping = lcnbmp_vi->i_mapping;\r\ni_size = i_size_read(lcnbmp_vi);\r\nwhile (1) {\r\nntfs_debug("Start of outer while loop: done_zones 0x%x, "\r\n"search_zone %i, pass %i, zone_start 0x%llx, "\r\n"zone_end 0x%llx, bmp_initial_pos 0x%llx, "\r\n"bmp_pos 0x%llx, rlpos %i, rlsize %i.",\r\ndone_zones, search_zone, pass,\r\n(unsigned long long)zone_start,\r\n(unsigned long long)zone_end,\r\n(unsigned long long)bmp_initial_pos,\r\n(unsigned long long)bmp_pos, rlpos, rlsize);\r\nlast_read_pos = bmp_pos >> 3;\r\nntfs_debug("last_read_pos 0x%llx.",\r\n(unsigned long long)last_read_pos);\r\nif (last_read_pos > i_size) {\r\nntfs_debug("End of attribute reached. "\r\n"Skipping to zone_pass_done.");\r\ngoto zone_pass_done;\r\n}\r\nif (likely(page)) {\r\nif (need_writeback) {\r\nntfs_debug("Marking page dirty.");\r\nflush_dcache_page(page);\r\nset_page_dirty(page);\r\nneed_writeback = 0;\r\n}\r\nntfs_unmap_page(page);\r\n}\r\npage = ntfs_map_page(mapping, last_read_pos >>\r\nPAGE_SHIFT);\r\nif (IS_ERR(page)) {\r\nerr = PTR_ERR(page);\r\nntfs_error(vol->sb, "Failed to map page.");\r\ngoto out;\r\n}\r\nbuf_size = last_read_pos & ~PAGE_MASK;\r\nbuf = page_address(page) + buf_size;\r\nbuf_size = PAGE_SIZE - buf_size;\r\nif (unlikely(last_read_pos + buf_size > i_size))\r\nbuf_size = i_size - last_read_pos;\r\nbuf_size <<= 3;\r\nlcn = bmp_pos & 7;\r\nbmp_pos &= ~(LCN)7;\r\nntfs_debug("Before inner while loop: buf_size %i, lcn 0x%llx, "\r\n"bmp_pos 0x%llx, need_writeback %i.", buf_size,\r\n(unsigned long long)lcn,\r\n(unsigned long long)bmp_pos, need_writeback);\r\nwhile (lcn < buf_size && lcn + bmp_pos < zone_end) {\r\nbyte = buf + (lcn >> 3);\r\nntfs_debug("In inner while loop: buf_size %i, "\r\n"lcn 0x%llx, bmp_pos 0x%llx, "\r\n"need_writeback %i, byte ofs 0x%x, "\r\n"*byte 0x%x.", buf_size,\r\n(unsigned long long)lcn,\r\n(unsigned long long)bmp_pos,\r\nneed_writeback,\r\n(unsigned int)(lcn >> 3),\r\n(unsigned int)*byte);\r\nif (*byte == 0xff) {\r\nlcn = (lcn + 8) & ~(LCN)7;\r\nntfs_debug("Continuing while loop 1.");\r\ncontinue;\r\n}\r\nbit = 1 << (lcn & 7);\r\nntfs_debug("bit 0x%x.", bit);\r\nif (*byte & bit) {\r\nlcn++;\r\nntfs_debug("Continuing while loop 2.");\r\ncontinue;\r\n}\r\nif ((rlpos + 2) * sizeof(*rl) > rlsize) {\r\nrunlist_element *rl2;\r\nntfs_debug("Reallocating memory.");\r\nif (!rl)\r\nntfs_debug("First free bit is at LCN "\r\n"0x%llx.",\r\n(unsigned long long)\r\n(lcn + bmp_pos));\r\nrl2 = ntfs_malloc_nofs(rlsize + (int)PAGE_SIZE);\r\nif (unlikely(!rl2)) {\r\nerr = -ENOMEM;\r\nntfs_error(vol->sb, "Failed to "\r\n"allocate memory.");\r\ngoto out;\r\n}\r\nmemcpy(rl2, rl, rlsize);\r\nntfs_free(rl);\r\nrl = rl2;\r\nrlsize += PAGE_SIZE;\r\nntfs_debug("Reallocated memory, rlsize 0x%x.",\r\nrlsize);\r\n}\r\n*byte |= bit;\r\nneed_writeback = 1;\r\nntfs_debug("*byte 0x%x, need_writeback is set.",\r\n(unsigned int)*byte);\r\nntfs_debug("Adding run (lcn 0x%llx, len 0x%llx), "\r\n"prev_lcn 0x%llx, lcn 0x%llx, "\r\n"bmp_pos 0x%llx, prev_run_len 0x%llx, "\r\n"rlpos %i.",\r\n(unsigned long long)(lcn + bmp_pos),\r\n1ULL, (unsigned long long)prev_lcn,\r\n(unsigned long long)lcn,\r\n(unsigned long long)bmp_pos,\r\n(unsigned long long)prev_run_len,\r\nrlpos);\r\nif (prev_lcn == lcn + bmp_pos - prev_run_len && rlpos) {\r\nntfs_debug("Coalescing to run (lcn 0x%llx, "\r\n"len 0x%llx).",\r\n(unsigned long long)\r\nrl[rlpos - 1].lcn,\r\n(unsigned long long)\r\nrl[rlpos - 1].length);\r\nrl[rlpos - 1].length = ++prev_run_len;\r\nntfs_debug("Run now (lcn 0x%llx, len 0x%llx), "\r\n"prev_run_len 0x%llx.",\r\n(unsigned long long)\r\nrl[rlpos - 1].lcn,\r\n(unsigned long long)\r\nrl[rlpos - 1].length,\r\n(unsigned long long)\r\nprev_run_len);\r\n} else {\r\nif (likely(rlpos)) {\r\nntfs_debug("Adding new run, (previous "\r\n"run lcn 0x%llx, "\r\n"len 0x%llx).",\r\n(unsigned long long)\r\nrl[rlpos - 1].lcn,\r\n(unsigned long long)\r\nrl[rlpos - 1].length);\r\nrl[rlpos].vcn = rl[rlpos - 1].vcn +\r\nprev_run_len;\r\n} else {\r\nntfs_debug("Adding new run, is first "\r\n"run.");\r\nrl[rlpos].vcn = start_vcn;\r\n}\r\nrl[rlpos].lcn = prev_lcn = lcn + bmp_pos;\r\nrl[rlpos].length = prev_run_len = 1;\r\nrlpos++;\r\n}\r\nif (!--clusters) {\r\nLCN tc;\r\ntc = lcn + bmp_pos + 1;\r\nntfs_debug("Done. Updating current zone "\r\n"position, tc 0x%llx, "\r\n"search_zone %i.",\r\n(unsigned long long)tc,\r\nsearch_zone);\r\nswitch (search_zone) {\r\ncase 1:\r\nntfs_debug("Before checks, "\r\n"vol->mft_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->mft_zone_pos);\r\nif (tc >= vol->mft_zone_end) {\r\nvol->mft_zone_pos =\r\nvol->mft_lcn;\r\nif (!vol->mft_zone_end)\r\nvol->mft_zone_pos = 0;\r\n} else if ((bmp_initial_pos >=\r\nvol->mft_zone_pos ||\r\ntc > vol->mft_zone_pos)\r\n&& tc >= vol->mft_lcn)\r\nvol->mft_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->mft_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->mft_zone_pos);\r\nbreak;\r\ncase 2:\r\nntfs_debug("Before checks, "\r\n"vol->data1_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data1_zone_pos);\r\nif (tc >= vol->nr_clusters)\r\nvol->data1_zone_pos =\r\nvol->mft_zone_end;\r\nelse if ((bmp_initial_pos >=\r\nvol->data1_zone_pos ||\r\ntc > vol->data1_zone_pos)\r\n&& tc >= vol->mft_zone_end)\r\nvol->data1_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->data1_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data1_zone_pos);\r\nbreak;\r\ncase 4:\r\nntfs_debug("Before checks, "\r\n"vol->data2_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data2_zone_pos);\r\nif (tc >= vol->mft_zone_start)\r\nvol->data2_zone_pos = 0;\r\nelse if (bmp_initial_pos >=\r\nvol->data2_zone_pos ||\r\ntc > vol->data2_zone_pos)\r\nvol->data2_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->data2_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data2_zone_pos);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nntfs_debug("Finished. Going to out.");\r\ngoto out;\r\n}\r\nlcn++;\r\n}\r\nbmp_pos += buf_size;\r\nntfs_debug("After inner while loop: buf_size 0x%x, lcn "\r\n"0x%llx, bmp_pos 0x%llx, need_writeback %i.",\r\nbuf_size, (unsigned long long)lcn,\r\n(unsigned long long)bmp_pos, need_writeback);\r\nif (bmp_pos < zone_end) {\r\nntfs_debug("Continuing outer while loop, "\r\n"bmp_pos 0x%llx, zone_end 0x%llx.",\r\n(unsigned long long)bmp_pos,\r\n(unsigned long long)zone_end);\r\ncontinue;\r\n}\r\nzone_pass_done:\r\nntfs_debug("At zone_pass_done, pass %i.", pass);\r\nif (pass == 1) {\r\npass = 2;\r\nzone_end = zone_start;\r\nswitch (search_zone) {\r\ncase 1:\r\nzone_start = vol->mft_zone_start;\r\nbreak;\r\ncase 2:\r\nzone_start = vol->mft_zone_end;\r\nbreak;\r\ncase 4:\r\nzone_start = 0;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nif (zone_end < zone_start)\r\nzone_end = zone_start;\r\nbmp_pos = zone_start;\r\nntfs_debug("Continuing outer while loop, pass 2, "\r\n"zone_start 0x%llx, zone_end 0x%llx, "\r\n"bmp_pos 0x%llx.",\r\n(unsigned long long)zone_start,\r\n(unsigned long long)zone_end,\r\n(unsigned long long)bmp_pos);\r\ncontinue;\r\n}\r\ndone_zones_check:\r\nntfs_debug("At done_zones_check, search_zone %i, done_zones "\r\n"before 0x%x, done_zones after 0x%x.",\r\nsearch_zone, done_zones,\r\ndone_zones | search_zone);\r\ndone_zones |= search_zone;\r\nif (done_zones < 7) {\r\nntfs_debug("Switching zone.");\r\npass = 1;\r\nswitch (search_zone) {\r\ncase 1:\r\nntfs_debug("Switching from mft zone to data1 "\r\n"zone.");\r\nif (rlpos) {\r\nLCN tc;\r\nntfs_debug("Before checks, "\r\n"vol->mft_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->mft_zone_pos);\r\ntc = rl[rlpos - 1].lcn +\r\nrl[rlpos - 1].length;\r\nif (tc >= vol->mft_zone_end) {\r\nvol->mft_zone_pos =\r\nvol->mft_lcn;\r\nif (!vol->mft_zone_end)\r\nvol->mft_zone_pos = 0;\r\n} else if ((bmp_initial_pos >=\r\nvol->mft_zone_pos ||\r\ntc > vol->mft_zone_pos)\r\n&& tc >= vol->mft_lcn)\r\nvol->mft_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->mft_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->mft_zone_pos);\r\n}\r\nswitch_to_data1_zone: search_zone = 2;\r\nzone_start = bmp_initial_pos =\r\nvol->data1_zone_pos;\r\nzone_end = vol->nr_clusters;\r\nif (zone_start == vol->mft_zone_end)\r\npass = 2;\r\nif (zone_start >= zone_end) {\r\nvol->data1_zone_pos = zone_start =\r\nvol->mft_zone_end;\r\npass = 2;\r\n}\r\nbreak;\r\ncase 2:\r\nntfs_debug("Switching from data1 zone to "\r\n"data2 zone.");\r\nif (rlpos) {\r\nLCN tc;\r\nntfs_debug("Before checks, "\r\n"vol->data1_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data1_zone_pos);\r\ntc = rl[rlpos - 1].lcn +\r\nrl[rlpos - 1].length;\r\nif (tc >= vol->nr_clusters)\r\nvol->data1_zone_pos =\r\nvol->mft_zone_end;\r\nelse if ((bmp_initial_pos >=\r\nvol->data1_zone_pos ||\r\ntc > vol->data1_zone_pos)\r\n&& tc >= vol->mft_zone_end)\r\nvol->data1_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->data1_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data1_zone_pos);\r\n}\r\nsearch_zone = 4;\r\nzone_start = bmp_initial_pos =\r\nvol->data2_zone_pos;\r\nzone_end = vol->mft_zone_start;\r\nif (!zone_start)\r\npass = 2;\r\nif (zone_start >= zone_end) {\r\nvol->data2_zone_pos = zone_start =\r\nbmp_initial_pos = 0;\r\npass = 2;\r\n}\r\nbreak;\r\ncase 4:\r\nntfs_debug("Switching from data2 zone to "\r\n"data1 zone.");\r\nif (rlpos) {\r\nLCN tc;\r\nntfs_debug("Before checks, "\r\n"vol->data2_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data2_zone_pos);\r\ntc = rl[rlpos - 1].lcn +\r\nrl[rlpos - 1].length;\r\nif (tc >= vol->mft_zone_start)\r\nvol->data2_zone_pos = 0;\r\nelse if (bmp_initial_pos >=\r\nvol->data2_zone_pos ||\r\ntc > vol->data2_zone_pos)\r\nvol->data2_zone_pos = tc;\r\nntfs_debug("After checks, "\r\n"vol->data2_zone_pos "\r\n"0x%llx.",\r\n(unsigned long long)\r\nvol->data2_zone_pos);\r\n}\r\ngoto switch_to_data1_zone;\r\ndefault:\r\nBUG();\r\n}\r\nntfs_debug("After zone switch, search_zone %i, "\r\n"pass %i, bmp_initial_pos 0x%llx, "\r\n"zone_start 0x%llx, zone_end 0x%llx.",\r\nsearch_zone, pass,\r\n(unsigned long long)bmp_initial_pos,\r\n(unsigned long long)zone_start,\r\n(unsigned long long)zone_end);\r\nbmp_pos = zone_start;\r\nif (zone_start == zone_end) {\r\nntfs_debug("Empty zone, going to "\r\n"done_zones_check.");\r\ngoto done_zones_check;\r\n}\r\nntfs_debug("Continuing outer while loop.");\r\ncontinue;\r\n}\r\nntfs_debug("All zones are finished.");\r\nmft_zone_size = vol->mft_zone_end - vol->mft_zone_start;\r\nntfs_debug("vol->mft_zone_start 0x%llx, vol->mft_zone_end "\r\n"0x%llx, mft_zone_size 0x%llx.",\r\n(unsigned long long)vol->mft_zone_start,\r\n(unsigned long long)vol->mft_zone_end,\r\n(unsigned long long)mft_zone_size);\r\nif (zone == MFT_ZONE || mft_zone_size <= 0) {\r\nntfs_debug("No free clusters left, going to out.");\r\nerr = -ENOSPC;\r\ngoto out;\r\n}\r\nntfs_debug("Shrinking mft zone.");\r\nzone_end = vol->mft_zone_end;\r\nmft_zone_size >>= 1;\r\nif (mft_zone_size > 0)\r\nvol->mft_zone_end = vol->mft_zone_start + mft_zone_size;\r\nelse\r\nvol->data2_zone_pos = vol->mft_zone_start =\r\nvol->mft_zone_end = 0;\r\nif (vol->mft_zone_pos >= vol->mft_zone_end) {\r\nvol->mft_zone_pos = vol->mft_lcn;\r\nif (!vol->mft_zone_end)\r\nvol->mft_zone_pos = 0;\r\n}\r\nbmp_pos = zone_start = bmp_initial_pos =\r\nvol->data1_zone_pos = vol->mft_zone_end;\r\nsearch_zone = 2;\r\npass = 2;\r\ndone_zones &= ~2;\r\nntfs_debug("After shrinking mft zone, mft_zone_size 0x%llx, "\r\n"vol->mft_zone_start 0x%llx, "\r\n"vol->mft_zone_end 0x%llx, "\r\n"vol->mft_zone_pos 0x%llx, search_zone 2, "\r\n"pass 2, dones_zones 0x%x, zone_start 0x%llx, "\r\n"zone_end 0x%llx, vol->data1_zone_pos 0x%llx, "\r\n"continuing outer while loop.",\r\n(unsigned long long)mft_zone_size,\r\n(unsigned long long)vol->mft_zone_start,\r\n(unsigned long long)vol->mft_zone_end,\r\n(unsigned long long)vol->mft_zone_pos,\r\ndone_zones, (unsigned long long)zone_start,\r\n(unsigned long long)zone_end,\r\n(unsigned long long)vol->data1_zone_pos);\r\n}\r\nntfs_debug("After outer while loop.");\r\nout:\r\nntfs_debug("At out.");\r\nif (likely(rl)) {\r\nrl[rlpos].vcn = rl[rlpos - 1].vcn + rl[rlpos - 1].length;\r\nrl[rlpos].lcn = is_extension ? LCN_ENOENT : LCN_RL_NOT_MAPPED;\r\nrl[rlpos].length = 0;\r\n}\r\nif (likely(page && !IS_ERR(page))) {\r\nif (need_writeback) {\r\nntfs_debug("Marking page dirty.");\r\nflush_dcache_page(page);\r\nset_page_dirty(page);\r\nneed_writeback = 0;\r\n}\r\nntfs_unmap_page(page);\r\n}\r\nif (likely(!err)) {\r\nup_write(&vol->lcnbmp_lock);\r\nntfs_debug("Done.");\r\nreturn rl;\r\n}\r\nntfs_error(vol->sb, "Failed to allocate clusters, aborting "\r\n"(error %i).", err);\r\nif (rl) {\r\nint err2;\r\nif (err == -ENOSPC)\r\nntfs_debug("Not enough space to complete allocation, "\r\n"err -ENOSPC, first free lcn 0x%llx, "\r\n"could allocate up to 0x%llx "\r\n"clusters.",\r\n(unsigned long long)rl[0].lcn,\r\n(unsigned long long)(count - clusters));\r\nntfs_debug("Attempting rollback...");\r\nerr2 = ntfs_cluster_free_from_rl_nolock(vol, rl);\r\nif (err2) {\r\nntfs_error(vol->sb, "Failed to rollback (error %i). "\r\n"Leaving inconsistent metadata! "\r\n"Unmount and run chkdsk.", err2);\r\nNVolSetErrors(vol);\r\n}\r\nntfs_free(rl);\r\n} else if (err == -ENOSPC)\r\nntfs_debug("No space left at all, err = -ENOSPC, first free "\r\n"lcn = 0x%llx.",\r\n(long long)vol->data1_zone_pos);\r\nup_write(&vol->lcnbmp_lock);\r\nreturn ERR_PTR(err);\r\n}\r\ns64 __ntfs_cluster_free(ntfs_inode *ni, const VCN start_vcn, s64 count,\r\nntfs_attr_search_ctx *ctx, const bool is_rollback)\r\n{\r\ns64 delta, to_free, total_freed, real_freed;\r\nntfs_volume *vol;\r\nstruct inode *lcnbmp_vi;\r\nrunlist_element *rl;\r\nint err;\r\nBUG_ON(!ni);\r\nntfs_debug("Entering for i_ino 0x%lx, start_vcn 0x%llx, count "\r\n"0x%llx.%s", ni->mft_no, (unsigned long long)start_vcn,\r\n(unsigned long long)count,\r\nis_rollback ? " (rollback)" : "");\r\nvol = ni->vol;\r\nlcnbmp_vi = vol->lcnbmp_ino;\r\nBUG_ON(!lcnbmp_vi);\r\nBUG_ON(start_vcn < 0);\r\nBUG_ON(count < -1);\r\nif (likely(!is_rollback))\r\ndown_write(&vol->lcnbmp_lock);\r\ntotal_freed = real_freed = 0;\r\nrl = ntfs_attr_find_vcn_nolock(ni, start_vcn, ctx);\r\nif (IS_ERR(rl)) {\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "Failed to find first runlist "\r\n"element (error %li), aborting.",\r\nPTR_ERR(rl));\r\nerr = PTR_ERR(rl);\r\ngoto err_out;\r\n}\r\nif (unlikely(rl->lcn < LCN_HOLE)) {\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "First runlist element has "\r\n"invalid lcn, aborting.");\r\nerr = -EIO;\r\ngoto err_out;\r\n}\r\ndelta = start_vcn - rl->vcn;\r\nto_free = rl->length - delta;\r\nif (count >= 0 && to_free > count)\r\nto_free = count;\r\nif (likely(rl->lcn >= 0)) {\r\nerr = ntfs_bitmap_set_bits_in_run(lcnbmp_vi, rl->lcn + delta,\r\nto_free, likely(!is_rollback) ? 0 : 1);\r\nif (unlikely(err)) {\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "Failed to clear first run "\r\n"(error %i), aborting.", err);\r\ngoto err_out;\r\n}\r\nreal_freed = to_free;\r\n};\r\n++rl;\r\nif (count >= 0)\r\ncount -= to_free;\r\ntotal_freed = to_free;\r\nfor (; rl->length && count != 0; ++rl) {\r\nif (unlikely(rl->lcn < LCN_HOLE)) {\r\nVCN vcn;\r\nvcn = rl->vcn;\r\nrl = ntfs_attr_find_vcn_nolock(ni, vcn, ctx);\r\nif (IS_ERR(rl)) {\r\nerr = PTR_ERR(rl);\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "Failed to map "\r\n"runlist fragment or "\r\n"failed to find "\r\n"subsequent runlist "\r\n"element.");\r\ngoto err_out;\r\n}\r\nif (unlikely(rl->lcn < LCN_HOLE)) {\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "Runlist element "\r\n"has invalid lcn "\r\n"(0x%llx).",\r\n(unsigned long long)\r\nrl->lcn);\r\nerr = -EIO;\r\ngoto err_out;\r\n}\r\n}\r\nto_free = rl->length;\r\nif (count >= 0 && to_free > count)\r\nto_free = count;\r\nif (likely(rl->lcn >= 0)) {\r\nerr = ntfs_bitmap_set_bits_in_run(lcnbmp_vi, rl->lcn,\r\nto_free, likely(!is_rollback) ? 0 : 1);\r\nif (unlikely(err)) {\r\nif (!is_rollback)\r\nntfs_error(vol->sb, "Failed to clear "\r\n"subsequent run.");\r\ngoto err_out;\r\n}\r\nreal_freed += to_free;\r\n}\r\nif (count >= 0)\r\ncount -= to_free;\r\ntotal_freed += to_free;\r\n}\r\nif (likely(!is_rollback))\r\nup_write(&vol->lcnbmp_lock);\r\nBUG_ON(count > 0);\r\nntfs_debug("Done.");\r\nreturn real_freed;\r\nerr_out:\r\nif (is_rollback)\r\nreturn err;\r\nif (!real_freed) {\r\nup_write(&vol->lcnbmp_lock);\r\nreturn err;\r\n}\r\ndelta = __ntfs_cluster_free(ni, start_vcn, total_freed, ctx, true);\r\nif (delta < 0) {\r\nntfs_error(vol->sb, "Failed to rollback (error %i). Leaving "\r\n"inconsistent metadata! Unmount and run "\r\n"chkdsk.", (int)delta);\r\nNVolSetErrors(vol);\r\n}\r\nup_write(&vol->lcnbmp_lock);\r\nntfs_error(vol->sb, "Aborting (error %i).", err);\r\nreturn err;\r\n}

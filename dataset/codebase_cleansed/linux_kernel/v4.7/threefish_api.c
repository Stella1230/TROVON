void threefish_set_key(struct threefish_key *key_ctx,\r\nenum threefish_size state_size,\r\nu64 *key_data, u64 *tweak)\r\n{\r\nint key_words = state_size / 64;\r\nint i;\r\nu64 parity = KEY_SCHEDULE_CONST;\r\nkey_ctx->tweak[0] = tweak[0];\r\nkey_ctx->tweak[1] = tweak[1];\r\nkey_ctx->tweak[2] = tweak[0] ^ tweak[1];\r\nfor (i = 0; i < key_words; i++) {\r\nkey_ctx->key[i] = key_data[i];\r\nparity ^= key_data[i];\r\n}\r\nkey_ctx->key[i] = parity;\r\nkey_ctx->state_size = state_size;\r\n}\r\nvoid threefish_encrypt_block_bytes(struct threefish_key *key_ctx, u8 *in,\r\nu8 *out)\r\n{\r\nu64 plain[SKEIN_MAX_STATE_WORDS];\r\nu64 cipher[SKEIN_MAX_STATE_WORDS];\r\nskein_get64_lsb_first(plain, in, key_ctx->state_size / 64);\r\nthreefish_encrypt_block_words(key_ctx, plain, cipher);\r\nskein_put64_lsb_first(out, cipher, key_ctx->state_size / 8);\r\n}\r\nvoid threefish_encrypt_block_words(struct threefish_key *key_ctx, u64 *in,\r\nu64 *out)\r\n{\r\nswitch (key_ctx->state_size) {\r\ncase THREEFISH_256:\r\nthreefish_encrypt_256(key_ctx, in, out);\r\nbreak;\r\ncase THREEFISH_512:\r\nthreefish_encrypt_512(key_ctx, in, out);\r\nbreak;\r\ncase THREEFISH_1024:\r\nthreefish_encrypt_1024(key_ctx, in, out);\r\nbreak;\r\n}\r\n}\r\nvoid threefish_decrypt_block_bytes(struct threefish_key *key_ctx, u8 *in,\r\nu8 *out)\r\n{\r\nu64 plain[SKEIN_MAX_STATE_WORDS];\r\nu64 cipher[SKEIN_MAX_STATE_WORDS];\r\nskein_get64_lsb_first(cipher, in, key_ctx->state_size / 64);\r\nthreefish_decrypt_block_words(key_ctx, cipher, plain);\r\nskein_put64_lsb_first(out, plain, key_ctx->state_size / 8);\r\n}\r\nvoid threefish_decrypt_block_words(struct threefish_key *key_ctx, u64 *in,\r\nu64 *out)\r\n{\r\nswitch (key_ctx->state_size) {\r\ncase THREEFISH_256:\r\nthreefish_decrypt_256(key_ctx, in, out);\r\nbreak;\r\ncase THREEFISH_512:\r\nthreefish_decrypt_512(key_ctx, in, out);\r\nbreak;\r\ncase THREEFISH_1024:\r\nthreefish_decrypt_1024(key_ctx, in, out);\r\nbreak;\r\n}\r\n}

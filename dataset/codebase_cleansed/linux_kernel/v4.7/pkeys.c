int __execute_only_pkey(struct mm_struct *mm)\r\n{\r\nint ret;\r\npreempt_disable();\r\nif (fpregs_active() &&\r\n!__pkru_allows_read(read_pkru(), PKEY_DEDICATED_EXECUTE_ONLY)) {\r\npreempt_enable();\r\nreturn PKEY_DEDICATED_EXECUTE_ONLY;\r\n}\r\npreempt_enable();\r\nret = arch_set_user_pkey_access(current, PKEY_DEDICATED_EXECUTE_ONLY,\r\nPKEY_DISABLE_ACCESS);\r\nif (ret)\r\nreturn 0;\r\nreturn PKEY_DEDICATED_EXECUTE_ONLY;\r\n}\r\nstatic inline bool vma_is_pkey_exec_only(struct vm_area_struct *vma)\r\n{\r\nif ((vma->vm_flags & (VM_READ | VM_WRITE | VM_EXEC)) != VM_EXEC)\r\nreturn false;\r\nif (vma_pkey(vma) != PKEY_DEDICATED_EXECUTE_ONLY)\r\nreturn false;\r\nreturn true;\r\n}\r\nint __arch_override_mprotect_pkey(struct vm_area_struct *vma, int prot, int pkey)\r\n{\r\nif (pkey != -1)\r\nreturn pkey;\r\nif (vma_is_pkey_exec_only(vma) &&\r\n(prot & (PROT_READ|PROT_WRITE))) {\r\nreturn 0;\r\n}\r\nif (prot == PROT_EXEC) {\r\npkey = execute_only_pkey(vma->vm_mm);\r\nif (pkey > 0)\r\nreturn pkey;\r\n}\r\nreturn vma_pkey(vma);\r\n}

static __always_inline int do_realtime_coarse(struct timespec *ts,\r\nconst union mips_vdso_data *data)\r\n{\r\nu32 start_seq;\r\ndo {\r\nstart_seq = vdso_data_read_begin(data);\r\nts->tv_sec = data->xtime_sec;\r\nts->tv_nsec = data->xtime_nsec >> data->cs_shift;\r\n} while (vdso_data_read_retry(data, start_seq));\r\nreturn 0;\r\n}\r\nstatic __always_inline int do_monotonic_coarse(struct timespec *ts,\r\nconst union mips_vdso_data *data)\r\n{\r\nu32 start_seq;\r\nu32 to_mono_sec;\r\nu32 to_mono_nsec;\r\ndo {\r\nstart_seq = vdso_data_read_begin(data);\r\nts->tv_sec = data->xtime_sec;\r\nts->tv_nsec = data->xtime_nsec >> data->cs_shift;\r\nto_mono_sec = data->wall_to_mono_sec;\r\nto_mono_nsec = data->wall_to_mono_nsec;\r\n} while (vdso_data_read_retry(data, start_seq));\r\nts->tv_sec += to_mono_sec;\r\ntimespec_add_ns(ts, to_mono_nsec);\r\nreturn 0;\r\n}\r\nstatic __always_inline u64 read_r4k_count(void)\r\n{\r\nunsigned int count;\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set mips32r2\n"\r\n" rdhwr %0, $2\n"\r\n" .set pop\n"\r\n: "=r" (count));\r\nreturn count;\r\n}\r\nstatic __always_inline u64 read_gic_count(const union mips_vdso_data *data)\r\n{\r\nvoid __iomem *gic = get_gic(data);\r\nu32 hi, hi2, lo;\r\ndo {\r\nhi = __raw_readl(gic + GIC_UMV_SH_COUNTER_63_32_OFS);\r\nlo = __raw_readl(gic + GIC_UMV_SH_COUNTER_31_00_OFS);\r\nhi2 = __raw_readl(gic + GIC_UMV_SH_COUNTER_63_32_OFS);\r\n} while (hi2 != hi);\r\nreturn (((u64)hi) << 32) + lo;\r\n}\r\nstatic __always_inline u64 get_ns(const union mips_vdso_data *data)\r\n{\r\nu64 cycle_now, delta, nsec;\r\nswitch (data->clock_mode) {\r\n#ifdef CONFIG_CSRC_R4K\r\ncase VDSO_CLOCK_R4K:\r\ncycle_now = read_r4k_count();\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_CLKSRC_MIPS_GIC\r\ncase VDSO_CLOCK_GIC:\r\ncycle_now = read_gic_count(data);\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn 0;\r\n}\r\ndelta = (cycle_now - data->cs_cycle_last) & data->cs_mask;\r\nnsec = (delta * data->cs_mult) + data->xtime_nsec;\r\nnsec >>= data->cs_shift;\r\nreturn nsec;\r\n}\r\nstatic __always_inline int do_realtime(struct timespec *ts,\r\nconst union mips_vdso_data *data)\r\n{\r\nu32 start_seq;\r\nu64 ns;\r\ndo {\r\nstart_seq = vdso_data_read_begin(data);\r\nif (data->clock_mode == VDSO_CLOCK_NONE)\r\nreturn -ENOSYS;\r\nts->tv_sec = data->xtime_sec;\r\nns = get_ns(data);\r\n} while (vdso_data_read_retry(data, start_seq));\r\nts->tv_nsec = 0;\r\ntimespec_add_ns(ts, ns);\r\nreturn 0;\r\n}\r\nstatic __always_inline int do_monotonic(struct timespec *ts,\r\nconst union mips_vdso_data *data)\r\n{\r\nu32 start_seq;\r\nu64 ns;\r\nu32 to_mono_sec;\r\nu32 to_mono_nsec;\r\ndo {\r\nstart_seq = vdso_data_read_begin(data);\r\nif (data->clock_mode == VDSO_CLOCK_NONE)\r\nreturn -ENOSYS;\r\nts->tv_sec = data->xtime_sec;\r\nns = get_ns(data);\r\nto_mono_sec = data->wall_to_mono_sec;\r\nto_mono_nsec = data->wall_to_mono_nsec;\r\n} while (vdso_data_read_retry(data, start_seq));\r\nts->tv_sec += to_mono_sec;\r\nts->tv_nsec = 0;\r\ntimespec_add_ns(ts, ns + to_mono_nsec);\r\nreturn 0;\r\n}\r\nint __vdso_gettimeofday(struct timeval *tv, struct timezone *tz)\r\n{\r\nconst union mips_vdso_data *data = get_vdso_data();\r\nstruct timespec ts;\r\nint ret;\r\nret = do_realtime(&ts, data);\r\nif (ret)\r\nreturn ret;\r\nif (tv) {\r\ntv->tv_sec = ts.tv_sec;\r\ntv->tv_usec = ts.tv_nsec / 1000;\r\n}\r\nif (tz) {\r\ntz->tz_minuteswest = data->tz_minuteswest;\r\ntz->tz_dsttime = data->tz_dsttime;\r\n}\r\nreturn 0;\r\n}\r\nint __vdso_clock_gettime(clockid_t clkid, struct timespec *ts)\r\n{\r\nconst union mips_vdso_data *data = get_vdso_data();\r\nint ret;\r\nswitch (clkid) {\r\ncase CLOCK_REALTIME_COARSE:\r\nret = do_realtime_coarse(ts, data);\r\nbreak;\r\ncase CLOCK_MONOTONIC_COARSE:\r\nret = do_monotonic_coarse(ts, data);\r\nbreak;\r\ncase CLOCK_REALTIME:\r\nret = do_realtime(ts, data);\r\nbreak;\r\ncase CLOCK_MONOTONIC:\r\nret = do_monotonic(ts, data);\r\nbreak;\r\ndefault:\r\nret = -ENOSYS;\r\nbreak;\r\n}\r\nreturn ret;\r\n}

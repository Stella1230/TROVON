static void\r\nprom_adjust_regs(struct linux_prom_registers *regp, int nregs,\r\nstruct linux_prom_ranges *rangep, int nranges)\r\n{\r\nint regc, rngc;\r\nfor (regc = 0; regc < nregs; regc++) {\r\nfor (rngc = 0; rngc < nranges; rngc++)\r\nif (regp[regc].which_io == rangep[rngc].ot_child_space)\r\nbreak;\r\nif (rngc == nranges)\r\nprom_printf("adjust_regs: Could not find range with matching bus type...\n");\r\nregp[regc].which_io = rangep[rngc].ot_parent_space;\r\nregp[regc].phys_addr -= rangep[rngc].ot_child_base;\r\nregp[regc].phys_addr += rangep[rngc].ot_parent_base;\r\n}\r\n}\r\nstatic void\r\nprom_adjust_ranges(struct linux_prom_ranges *ranges1, int nranges1,\r\nstruct linux_prom_ranges *ranges2, int nranges2)\r\n{\r\nint rng1c, rng2c;\r\nfor(rng1c=0; rng1c < nranges1; rng1c++) {\r\nfor(rng2c=0; rng2c < nranges2; rng2c++)\r\nif(ranges1[rng1c].ot_parent_space == ranges2[rng2c].ot_child_space &&\r\nranges1[rng1c].ot_parent_base >= ranges2[rng2c].ot_child_base &&\r\nranges2[rng2c].ot_child_base + ranges2[rng2c].or_size - ranges1[rng1c].ot_parent_base > 0U)\r\nbreak;\r\nif(rng2c == nranges2)\r\nprom_printf("adjust_ranges: Could not find matching bus type...\n");\r\nelse if (ranges1[rng1c].ot_parent_base + ranges1[rng1c].or_size > ranges2[rng2c].ot_child_base + ranges2[rng2c].or_size)\r\nranges1[rng1c].or_size =\r\nranges2[rng2c].ot_child_base + ranges2[rng2c].or_size - ranges1[rng1c].ot_parent_base;\r\nranges1[rng1c].ot_parent_space = ranges2[rng2c].ot_parent_space;\r\nranges1[rng1c].ot_parent_base += ranges2[rng2c].ot_parent_base;\r\n}\r\n}\r\nvoid\r\nprom_apply_obio_ranges(struct linux_prom_registers *regs, int nregs)\r\n{\r\nif(num_obio_ranges)\r\nprom_adjust_regs(regs, nregs, promlib_obio_ranges, num_obio_ranges);\r\n}\r\nvoid __init prom_ranges_init(void)\r\n{\r\nphandle node, obio_node;\r\nint success;\r\nnum_obio_ranges = 0;\r\nnode = prom_getchild(prom_root_node);\r\nobio_node = prom_searchsiblings(node, "obio");\r\nif(obio_node) {\r\nsuccess = prom_getproperty(obio_node, "ranges",\r\n(char *) promlib_obio_ranges,\r\nsizeof(promlib_obio_ranges));\r\nif(success != -1)\r\nnum_obio_ranges = (success/sizeof(struct linux_prom_ranges));\r\n}\r\nif(num_obio_ranges)\r\nprom_printf("PROMLIB: obio_ranges %d\n", num_obio_ranges);\r\n}\r\nvoid prom_apply_generic_ranges(phandle node, phandle parent,\r\nstruct linux_prom_registers *regs, int nregs)\r\n{\r\nint success;\r\nint num_ranges;\r\nstruct linux_prom_ranges ranges[PROMREG_MAX];\r\nsuccess = prom_getproperty(node, "ranges",\r\n(char *) ranges,\r\nsizeof (ranges));\r\nif (success != -1) {\r\nnum_ranges = (success/sizeof(struct linux_prom_ranges));\r\nif (parent) {\r\nstruct linux_prom_ranges parent_ranges[PROMREG_MAX];\r\nint num_parent_ranges;\r\nsuccess = prom_getproperty(parent, "ranges",\r\n(char *) parent_ranges,\r\nsizeof (parent_ranges));\r\nif (success != -1) {\r\nnum_parent_ranges = (success/sizeof(struct linux_prom_ranges));\r\nprom_adjust_ranges (ranges, num_ranges, parent_ranges, num_parent_ranges);\r\n}\r\n}\r\nprom_adjust_regs(regs, nregs, ranges, num_ranges);\r\n}\r\n}

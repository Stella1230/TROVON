static inline struct sharp_panel *to_sharp_panel(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct sharp_panel, base);\r\n}\r\nstatic void sharp_wait_frames(struct sharp_panel *sharp, unsigned int frames)\r\n{\r\nunsigned int refresh = drm_mode_vrefresh(sharp->mode);\r\nif (WARN_ON(frames > refresh))\r\nreturn;\r\nmsleep(1000 / (refresh / frames));\r\n}\r\nstatic int sharp_panel_write(struct sharp_panel *sharp, u16 offset, u8 value)\r\n{\r\nu8 payload[3] = { offset >> 8, offset & 0xff, value };\r\nstruct mipi_dsi_device *dsi = sharp->link1;\r\nssize_t err;\r\nerr = mipi_dsi_generic_write(dsi, payload, sizeof(payload));\r\nif (err < 0) {\r\ndev_err(&dsi->dev, "failed to write %02x to %04x: %zd\n",\r\nvalue, offset, err);\r\nreturn err;\r\n}\r\nerr = mipi_dsi_dcs_nop(dsi);\r\nif (err < 0) {\r\ndev_err(&dsi->dev, "failed to send DCS nop: %zd\n", err);\r\nreturn err;\r\n}\r\nusleep_range(10, 20);\r\nreturn 0;\r\n}\r\nstatic __maybe_unused int sharp_panel_read(struct sharp_panel *sharp,\r\nu16 offset, u8 *value)\r\n{\r\nssize_t err;\r\ncpu_to_be16s(&offset);\r\nerr = mipi_dsi_generic_read(sharp->link1, &offset, sizeof(offset),\r\nvalue, sizeof(*value));\r\nif (err < 0)\r\ndev_err(&sharp->link1->dev, "failed to read from %04x: %zd\n",\r\noffset, err);\r\nreturn err;\r\n}\r\nstatic int sharp_panel_disable(struct drm_panel *panel)\r\n{\r\nstruct sharp_panel *sharp = to_sharp_panel(panel);\r\nif (!sharp->enabled)\r\nreturn 0;\r\nif (sharp->backlight) {\r\nsharp->backlight->props.power = FB_BLANK_POWERDOWN;\r\nbacklight_update_status(sharp->backlight);\r\n}\r\nsharp->enabled = false;\r\nreturn 0;\r\n}\r\nstatic int sharp_panel_unprepare(struct drm_panel *panel)\r\n{\r\nstruct sharp_panel *sharp = to_sharp_panel(panel);\r\nint err;\r\nif (!sharp->prepared)\r\nreturn 0;\r\nsharp_wait_frames(sharp, 4);\r\nerr = mipi_dsi_dcs_set_display_off(sharp->link1);\r\nif (err < 0)\r\ndev_err(panel->dev, "failed to set display off: %d\n", err);\r\nerr = mipi_dsi_dcs_enter_sleep_mode(sharp->link1);\r\nif (err < 0)\r\ndev_err(panel->dev, "failed to enter sleep mode: %d\n", err);\r\nmsleep(120);\r\nregulator_disable(sharp->supply);\r\nsharp->prepared = false;\r\nreturn 0;\r\n}\r\nstatic int sharp_setup_symmetrical_split(struct mipi_dsi_device *left,\r\nstruct mipi_dsi_device *right,\r\nconst struct drm_display_mode *mode)\r\n{\r\nint err;\r\nerr = mipi_dsi_dcs_set_column_address(left, 0, mode->hdisplay / 2 - 1);\r\nif (err < 0) {\r\ndev_err(&left->dev, "failed to set column address: %d\n", err);\r\nreturn err;\r\n}\r\nerr = mipi_dsi_dcs_set_page_address(left, 0, mode->vdisplay - 1);\r\nif (err < 0) {\r\ndev_err(&left->dev, "failed to set page address: %d\n", err);\r\nreturn err;\r\n}\r\nerr = mipi_dsi_dcs_set_column_address(right, mode->hdisplay / 2,\r\nmode->hdisplay - 1);\r\nif (err < 0) {\r\ndev_err(&right->dev, "failed to set column address: %d\n", err);\r\nreturn err;\r\n}\r\nerr = mipi_dsi_dcs_set_page_address(right, 0, mode->vdisplay - 1);\r\nif (err < 0) {\r\ndev_err(&right->dev, "failed to set page address: %d\n", err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sharp_panel_prepare(struct drm_panel *panel)\r\n{\r\nstruct sharp_panel *sharp = to_sharp_panel(panel);\r\nu8 format = MIPI_DCS_PIXEL_FMT_24BIT;\r\nint err;\r\nif (sharp->prepared)\r\nreturn 0;\r\nerr = regulator_enable(sharp->supply);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(150);\r\nerr = mipi_dsi_dcs_exit_sleep_mode(sharp->link1);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to exit sleep mode: %d\n", err);\r\ngoto poweroff;\r\n}\r\nerr = sharp_panel_write(sharp, 0x1000, 0x2a);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to set left-right mode: %d\n", err);\r\ngoto poweroff;\r\n}\r\nerr = sharp_panel_write(sharp, 0x1001, 0x01);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to enable command mode: %d\n", err);\r\ngoto poweroff;\r\n}\r\nerr = mipi_dsi_dcs_set_pixel_format(sharp->link1, format);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to set pixel format: %d\n", err);\r\ngoto poweroff;\r\n}\r\nerr = sharp_setup_symmetrical_split(sharp->link1, sharp->link2,\r\nsharp->mode);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to set up symmetrical split: %d\n",\r\nerr);\r\ngoto poweroff;\r\n}\r\nerr = mipi_dsi_dcs_set_display_on(sharp->link1);\r\nif (err < 0) {\r\ndev_err(panel->dev, "failed to set display on: %d\n", err);\r\ngoto poweroff;\r\n}\r\nsharp->prepared = true;\r\nsharp_wait_frames(sharp, 6);\r\nreturn 0;\r\npoweroff:\r\nregulator_disable(sharp->supply);\r\nreturn err;\r\n}\r\nstatic int sharp_panel_enable(struct drm_panel *panel)\r\n{\r\nstruct sharp_panel *sharp = to_sharp_panel(panel);\r\nif (sharp->enabled)\r\nreturn 0;\r\nif (sharp->backlight) {\r\nsharp->backlight->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(sharp->backlight);\r\n}\r\nsharp->enabled = true;\r\nreturn 0;\r\n}\r\nstatic int sharp_panel_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(panel->drm->dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\ndrm_mode_probed_add(panel->connector, mode);\r\npanel->connector->display_info.width_mm = 217;\r\npanel->connector->display_info.height_mm = 136;\r\nreturn 1;\r\n}\r\nstatic int sharp_panel_add(struct sharp_panel *sharp)\r\n{\r\nstruct device_node *np;\r\nint err;\r\nsharp->mode = &default_mode;\r\nsharp->supply = devm_regulator_get(&sharp->link1->dev, "power");\r\nif (IS_ERR(sharp->supply))\r\nreturn PTR_ERR(sharp->supply);\r\nnp = of_parse_phandle(sharp->link1->dev.of_node, "backlight", 0);\r\nif (np) {\r\nsharp->backlight = of_find_backlight_by_node(np);\r\nof_node_put(np);\r\nif (!sharp->backlight)\r\nreturn -EPROBE_DEFER;\r\n}\r\ndrm_panel_init(&sharp->base);\r\nsharp->base.funcs = &sharp_panel_funcs;\r\nsharp->base.dev = &sharp->link1->dev;\r\nerr = drm_panel_add(&sharp->base);\r\nif (err < 0)\r\ngoto put_backlight;\r\nreturn 0;\r\nput_backlight:\r\nif (sharp->backlight)\r\nput_device(&sharp->backlight->dev);\r\nreturn err;\r\n}\r\nstatic void sharp_panel_del(struct sharp_panel *sharp)\r\n{\r\nif (sharp->base.dev)\r\ndrm_panel_remove(&sharp->base);\r\nif (sharp->backlight)\r\nput_device(&sharp->backlight->dev);\r\nif (sharp->link2)\r\nput_device(&sharp->link2->dev);\r\n}\r\nstatic int sharp_panel_probe(struct mipi_dsi_device *dsi)\r\n{\r\nstruct mipi_dsi_device *secondary = NULL;\r\nstruct sharp_panel *sharp;\r\nstruct device_node *np;\r\nint err;\r\ndsi->lanes = 4;\r\ndsi->format = MIPI_DSI_FMT_RGB888;\r\ndsi->mode_flags = MIPI_DSI_MODE_LPM;\r\nnp = of_parse_phandle(dsi->dev.of_node, "link2", 0);\r\nif (np) {\r\nsecondary = of_find_mipi_dsi_device_by_node(np);\r\nof_node_put(np);\r\nif (!secondary)\r\nreturn -EPROBE_DEFER;\r\n}\r\nif (secondary) {\r\nsharp = devm_kzalloc(&dsi->dev, sizeof(*sharp), GFP_KERNEL);\r\nif (!sharp) {\r\nput_device(&secondary->dev);\r\nreturn -ENOMEM;\r\n}\r\nmipi_dsi_set_drvdata(dsi, sharp);\r\nsharp->link2 = secondary;\r\nsharp->link1 = dsi;\r\nerr = sharp_panel_add(sharp);\r\nif (err < 0) {\r\nput_device(&secondary->dev);\r\nreturn err;\r\n}\r\n}\r\nerr = mipi_dsi_attach(dsi);\r\nif (err < 0) {\r\nif (secondary)\r\nsharp_panel_del(sharp);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sharp_panel_remove(struct mipi_dsi_device *dsi)\r\n{\r\nstruct sharp_panel *sharp = mipi_dsi_get_drvdata(dsi);\r\nint err;\r\nif (!sharp) {\r\nmipi_dsi_detach(dsi);\r\nreturn 0;\r\n}\r\nerr = sharp_panel_disable(&sharp->base);\r\nif (err < 0)\r\ndev_err(&dsi->dev, "failed to disable panel: %d\n", err);\r\nerr = mipi_dsi_detach(dsi);\r\nif (err < 0)\r\ndev_err(&dsi->dev, "failed to detach from DSI host: %d\n", err);\r\ndrm_panel_detach(&sharp->base);\r\nsharp_panel_del(sharp);\r\nreturn 0;\r\n}\r\nstatic void sharp_panel_shutdown(struct mipi_dsi_device *dsi)\r\n{\r\nstruct sharp_panel *sharp = mipi_dsi_get_drvdata(dsi);\r\nif (!sharp)\r\nreturn;\r\nsharp_panel_disable(&sharp->base);\r\n}

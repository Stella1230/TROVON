static void\r\nctrlchar_handle_sysrq(struct work_struct *work)\r\n{\r\nstruct sysrq_work *sysrq = container_of(work, struct sysrq_work, work);\r\nhandle_sysrq(sysrq->key);\r\n}\r\nvoid schedule_sysrq_work(struct sysrq_work *sw)\r\n{\r\nINIT_WORK(&sw->work, ctrlchar_handle_sysrq);\r\nschedule_work(&sw->work);\r\n}\r\nunsigned int\r\nctrlchar_handle(const unsigned char *buf, int len, struct tty_struct *tty)\r\n{\r\nif ((len < 2) || (len > 3))\r\nreturn CTRLCHAR_NONE;\r\nif ((buf[0] != '^') && (buf[0] != '\252'))\r\nreturn CTRLCHAR_NONE;\r\n#ifdef CONFIG_MAGIC_SYSRQ\r\nif (len == 3 && buf[1] == '-') {\r\nctrlchar_sysrq.key = buf[2];\r\nschedule_sysrq_work(&ctrlchar_sysrq);\r\nreturn CTRLCHAR_SYSRQ;\r\n}\r\n#endif\r\nif (len != 2)\r\nreturn CTRLCHAR_NONE;\r\nswitch (tolower(buf[1])) {\r\ncase 'c':\r\nreturn INTR_CHAR(tty) | CTRLCHAR_CTRL;\r\ncase 'd':\r\nreturn EOF_CHAR(tty) | CTRLCHAR_CTRL;\r\ncase 'z':\r\nreturn SUSP_CHAR(tty) | CTRLCHAR_CTRL;\r\n}\r\nreturn CTRLCHAR_NONE;\r\n}

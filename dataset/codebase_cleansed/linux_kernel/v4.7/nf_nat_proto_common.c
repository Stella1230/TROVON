bool nf_nat_l4proto_in_range(const struct nf_conntrack_tuple *tuple,\r\nenum nf_nat_manip_type maniptype,\r\nconst union nf_conntrack_man_proto *min,\r\nconst union nf_conntrack_man_proto *max)\r\n{\r\n__be16 port;\r\nif (maniptype == NF_NAT_MANIP_SRC)\r\nport = tuple->src.u.all;\r\nelse\r\nport = tuple->dst.u.all;\r\nreturn ntohs(port) >= ntohs(min->all) &&\r\nntohs(port) <= ntohs(max->all);\r\n}\r\nvoid nf_nat_l4proto_unique_tuple(const struct nf_nat_l3proto *l3proto,\r\nstruct nf_conntrack_tuple *tuple,\r\nconst struct nf_nat_range *range,\r\nenum nf_nat_manip_type maniptype,\r\nconst struct nf_conn *ct,\r\nu16 *rover)\r\n{\r\nunsigned int range_size, min, i;\r\n__be16 *portptr;\r\nu_int16_t off;\r\nif (maniptype == NF_NAT_MANIP_SRC)\r\nportptr = &tuple->src.u.all;\r\nelse\r\nportptr = &tuple->dst.u.all;\r\nif (!(range->flags & NF_NAT_RANGE_PROTO_SPECIFIED)) {\r\nif (maniptype == NF_NAT_MANIP_DST)\r\nreturn;\r\nif (ntohs(*portptr) < 1024) {\r\nif (ntohs(*portptr) < 512) {\r\nmin = 1;\r\nrange_size = 511 - min + 1;\r\n} else {\r\nmin = 600;\r\nrange_size = 1023 - min + 1;\r\n}\r\n} else {\r\nmin = 1024;\r\nrange_size = 65535 - 1024 + 1;\r\n}\r\n} else {\r\nmin = ntohs(range->min_proto.all);\r\nrange_size = ntohs(range->max_proto.all) - min + 1;\r\n}\r\nif (range->flags & NF_NAT_RANGE_PROTO_RANDOM) {\r\noff = l3proto->secure_port(tuple, maniptype == NF_NAT_MANIP_SRC\r\n? tuple->dst.u.all\r\n: tuple->src.u.all);\r\n} else if (range->flags & NF_NAT_RANGE_PROTO_RANDOM_FULLY) {\r\noff = prandom_u32();\r\n} else {\r\noff = *rover;\r\n}\r\nfor (i = 0; ; ++off) {\r\n*portptr = htons(min + off % range_size);\r\nif (++i != range_size && nf_nat_used_tuple(tuple, ct))\r\ncontinue;\r\nif (!(range->flags & NF_NAT_RANGE_PROTO_RANDOM_ALL))\r\n*rover = off;\r\nreturn;\r\n}\r\n}\r\nint nf_nat_l4proto_nlattr_to_range(struct nlattr *tb[],\r\nstruct nf_nat_range *range)\r\n{\r\nif (tb[CTA_PROTONAT_PORT_MIN]) {\r\nrange->min_proto.all = nla_get_be16(tb[CTA_PROTONAT_PORT_MIN]);\r\nrange->max_proto.all = range->min_proto.all;\r\nrange->flags |= NF_NAT_RANGE_PROTO_SPECIFIED;\r\n}\r\nif (tb[CTA_PROTONAT_PORT_MAX]) {\r\nrange->max_proto.all = nla_get_be16(tb[CTA_PROTONAT_PORT_MAX]);\r\nrange->flags |= NF_NAT_RANGE_PROTO_SPECIFIED;\r\n}\r\nreturn 0;\r\n}

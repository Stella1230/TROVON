static int palmtc_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint ret;\r\nret = gpio_request_array(palmtc_pcmcia_gpios,\r\nARRAY_SIZE(palmtc_pcmcia_gpios));\r\nskt->stat[SOC_STAT_RDY].gpio = GPIO_NR_PALMTC_PCMCIA_READY;\r\nskt->stat[SOC_STAT_RDY].name = "PCMCIA Ready";\r\nreturn ret;\r\n}\r\nstatic void palmtc_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\ngpio_free_array(palmtc_pcmcia_gpios, ARRAY_SIZE(palmtc_pcmcia_gpios));\r\n}\r\nstatic void palmtc_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nstate->detect = 1;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int palmtc_wifi_powerdown(void)\r\n{\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_RESET, 1);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER2, 0);\r\nmdelay(40);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER1, 0);\r\nreturn 0;\r\n}\r\nstatic int palmtc_wifi_powerup(void)\r\n{\r\nint timeout = 50;\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER3, 1);\r\nmdelay(50);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER1, 1);\r\nmdelay(100);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER2, 1);\r\nwhile (!gpio_get_value(GPIO_NR_PALMTC_PCMCIA_PWRREADY) &&\r\ntimeout) {\r\nmdelay(1);\r\ntimeout--;\r\n}\r\nif (!timeout) {\r\npalmtc_wifi_powerdown();\r\nreturn 1;\r\n}\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_RESET, 1);\r\nmdelay(20);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_RESET, 0);\r\nmdelay(25);\r\ngpio_set_value(GPIO_NR_PALMTC_PCMCIA_POWER3, 0);\r\nreturn 0;\r\n}\r\nstatic int palmtc_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nint ret = 1;\r\nif (state->Vcc == 0)\r\nret = palmtc_wifi_powerdown();\r\nelse if (state->Vcc == 33)\r\nret = palmtc_wifi_powerup();\r\nreturn ret;\r\n}\r\nstatic int __init palmtc_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_palmtc())\r\nreturn -ENODEV;\r\npalmtc_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!palmtc_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(palmtc_pcmcia_device, &palmtc_pcmcia_ops,\r\nsizeof(palmtc_pcmcia_ops));\r\nif (!ret)\r\nret = platform_device_add(palmtc_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(palmtc_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit palmtc_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(palmtc_pcmcia_device);\r\n}

static void nfcsim_cleanup_dev(struct nfcsim *dev, u8 shutdown)\r\n{\r\nDEV_DBG(dev, "shutdown=%d\n", shutdown);\r\nmutex_lock(&dev->lock);\r\ndev->polling_mode = NFCSIM_POLL_NONE;\r\ndev->shutting_down = shutdown;\r\ndev->cb = NULL;\r\ndev_kfree_skb(dev->clone_skb);\r\ndev->clone_skb = NULL;\r\nmutex_unlock(&dev->lock);\r\ncancel_delayed_work_sync(&dev->poll_work);\r\ncancel_delayed_work_sync(&dev->recv_work);\r\n}\r\nstatic int nfcsim_target_found(struct nfcsim *dev)\r\n{\r\nstruct nfc_target nfc_tgt;\r\nDEV_DBG(dev, "\n");\r\nmemset(&nfc_tgt, 0, sizeof(struct nfc_target));\r\nnfc_tgt.supported_protocols = NFC_PROTO_NFC_DEP_MASK;\r\nnfc_targets_found(dev->nfc_dev, &nfc_tgt, 1);\r\nreturn 0;\r\n}\r\nstatic int nfcsim_dev_up(struct nfc_dev *nfc_dev)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "\n");\r\nmutex_lock(&dev->lock);\r\ndev->up = 1;\r\nmutex_unlock(&dev->lock);\r\nreturn 0;\r\n}\r\nstatic int nfcsim_dev_down(struct nfc_dev *nfc_dev)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "\n");\r\nmutex_lock(&dev->lock);\r\ndev->up = 0;\r\nmutex_unlock(&dev->lock);\r\nreturn 0;\r\n}\r\nstatic int nfcsim_dep_link_up(struct nfc_dev *nfc_dev,\r\nstruct nfc_target *target,\r\nu8 comm_mode, u8 *gb, size_t gb_len)\r\n{\r\nint rc;\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nstruct nfcsim *peer = dev->peer_dev;\r\nu8 *remote_gb;\r\nsize_t remote_gb_len;\r\nDEV_DBG(dev, "target_idx: %d, comm_mode: %d\n", target->idx, comm_mode);\r\nmutex_lock(&peer->lock);\r\nnfc_tm_activated(peer->nfc_dev, NFC_PROTO_NFC_DEP_MASK,\r\nNFC_COMM_ACTIVE, gb, gb_len);\r\nremote_gb = nfc_get_local_general_bytes(peer->nfc_dev, &remote_gb_len);\r\nif (!remote_gb) {\r\nDEV_ERR(peer, "Can't get remote general bytes\n");\r\nmutex_unlock(&peer->lock);\r\nreturn -EINVAL;\r\n}\r\nmutex_unlock(&peer->lock);\r\nmutex_lock(&dev->lock);\r\nrc = nfc_set_remote_general_bytes(nfc_dev, remote_gb, remote_gb_len);\r\nif (rc) {\r\nDEV_ERR(dev, "Can't set remote general bytes\n");\r\nmutex_unlock(&dev->lock);\r\nreturn rc;\r\n}\r\nrc = nfc_dep_link_is_up(nfc_dev, target->idx, NFC_COMM_ACTIVE,\r\nNFC_RF_INITIATOR);\r\nmutex_unlock(&dev->lock);\r\nreturn rc;\r\n}\r\nstatic int nfcsim_dep_link_down(struct nfc_dev *nfc_dev)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "\n");\r\nnfcsim_cleanup_dev(dev, 0);\r\nreturn 0;\r\n}\r\nstatic int nfcsim_start_poll(struct nfc_dev *nfc_dev,\r\nu32 im_protocols, u32 tm_protocols)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nint rc;\r\nmutex_lock(&dev->lock);\r\nif (dev->polling_mode != NFCSIM_POLL_NONE) {\r\nDEV_ERR(dev, "Already in polling mode\n");\r\nrc = -EBUSY;\r\ngoto exit;\r\n}\r\nif (im_protocols & NFC_PROTO_NFC_DEP_MASK)\r\ndev->polling_mode |= NFCSIM_POLL_INITIATOR;\r\nif (tm_protocols & NFC_PROTO_NFC_DEP_MASK)\r\ndev->polling_mode |= NFCSIM_POLL_TARGET;\r\nif (dev->polling_mode == NFCSIM_POLL_NONE) {\r\nDEV_ERR(dev, "Unsupported polling mode\n");\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\ndev->initiator = 0;\r\ndev->curr_polling_mode = NFCSIM_POLL_NONE;\r\nqueue_delayed_work(wq, &dev->poll_work, 0);\r\nDEV_DBG(dev, "Start polling: im: 0x%X, tm: 0x%X\n", im_protocols,\r\ntm_protocols);\r\nrc = 0;\r\nexit:\r\nmutex_unlock(&dev->lock);\r\nreturn rc;\r\n}\r\nstatic void nfcsim_stop_poll(struct nfc_dev *nfc_dev)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "Stop poll\n");\r\nmutex_lock(&dev->lock);\r\ndev->polling_mode = NFCSIM_POLL_NONE;\r\nmutex_unlock(&dev->lock);\r\ncancel_delayed_work_sync(&dev->poll_work);\r\n}\r\nstatic int nfcsim_activate_target(struct nfc_dev *nfc_dev,\r\nstruct nfc_target *target, u32 protocol)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "\n");\r\nreturn -ENOTSUPP;\r\n}\r\nstatic void nfcsim_deactivate_target(struct nfc_dev *nfc_dev,\r\nstruct nfc_target *target, u8 mode)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nDEV_DBG(dev, "\n");\r\n}\r\nstatic void nfcsim_wq_recv(struct work_struct *work)\r\n{\r\nstruct nfcsim *dev = container_of(work, struct nfcsim,\r\nrecv_work.work);\r\nmutex_lock(&dev->lock);\r\nif (dev->shutting_down || !dev->up || !dev->clone_skb) {\r\ndev_kfree_skb(dev->clone_skb);\r\ngoto exit;\r\n}\r\nif (dev->initiator) {\r\nif (!dev->cb) {\r\nDEV_ERR(dev, "Null recv callback\n");\r\ndev_kfree_skb(dev->clone_skb);\r\ngoto exit;\r\n}\r\ndev->cb(dev->cb_context, dev->clone_skb, 0);\r\ndev->cb = NULL;\r\n} else {\r\nnfc_tm_data_received(dev->nfc_dev, dev->clone_skb);\r\n}\r\nexit:\r\ndev->clone_skb = NULL;\r\nmutex_unlock(&dev->lock);\r\n}\r\nstatic int nfcsim_tx(struct nfc_dev *nfc_dev, struct nfc_target *target,\r\nstruct sk_buff *skb, data_exchange_cb_t cb,\r\nvoid *cb_context)\r\n{\r\nstruct nfcsim *dev = nfc_get_drvdata(nfc_dev);\r\nstruct nfcsim *peer = dev->peer_dev;\r\nint err;\r\nmutex_lock(&dev->lock);\r\nif (dev->shutting_down || !dev->up) {\r\nmutex_unlock(&dev->lock);\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\ndev->cb = cb;\r\ndev->cb_context = cb_context;\r\nmutex_unlock(&dev->lock);\r\nmutex_lock(&peer->lock);\r\npeer->clone_skb = skb_clone(skb, GFP_KERNEL);\r\nif (!peer->clone_skb) {\r\nDEV_ERR(dev, "skb_clone failed\n");\r\nmutex_unlock(&peer->lock);\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\nqueue_delayed_work(wq, &peer->recv_work,\r\nmsecs_to_jiffies(dev->rx_delay));\r\nmutex_unlock(&peer->lock);\r\nerr = 0;\r\nexit:\r\ndev_kfree_skb(skb);\r\nreturn err;\r\n}\r\nstatic int nfcsim_im_transceive(struct nfc_dev *nfc_dev,\r\nstruct nfc_target *target, struct sk_buff *skb,\r\ndata_exchange_cb_t cb, void *cb_context)\r\n{\r\nreturn nfcsim_tx(nfc_dev, target, skb, cb, cb_context);\r\n}\r\nstatic int nfcsim_tm_send(struct nfc_dev *nfc_dev, struct sk_buff *skb)\r\n{\r\nreturn nfcsim_tx(nfc_dev, NULL, skb, NULL, NULL);\r\n}\r\nstatic void nfcsim_set_polling_mode(struct nfcsim *dev)\r\n{\r\nif (dev->polling_mode == NFCSIM_POLL_NONE) {\r\ndev->curr_polling_mode = NFCSIM_POLL_NONE;\r\nreturn;\r\n}\r\nif (dev->curr_polling_mode == NFCSIM_POLL_NONE) {\r\nif (dev->polling_mode & NFCSIM_POLL_INITIATOR)\r\ndev->curr_polling_mode = NFCSIM_POLL_INITIATOR;\r\nelse\r\ndev->curr_polling_mode = NFCSIM_POLL_TARGET;\r\nreturn;\r\n}\r\nif (dev->polling_mode == NFCSIM_POLL_DUAL) {\r\nif (dev->curr_polling_mode == NFCSIM_POLL_TARGET)\r\ndev->curr_polling_mode = NFCSIM_POLL_INITIATOR;\r\nelse\r\ndev->curr_polling_mode = NFCSIM_POLL_TARGET;\r\n}\r\n}\r\nstatic void nfcsim_wq_poll(struct work_struct *work)\r\n{\r\nstruct nfcsim *dev = container_of(work, struct nfcsim, poll_work.work);\r\nstruct nfcsim *peer = dev->peer_dev;\r\nmutex_lock(&dev->lock);\r\nmutex_lock(&peer->lock);\r\nnfcsim_set_polling_mode(dev);\r\nif (dev->curr_polling_mode == NFCSIM_POLL_NONE) {\r\nDEV_DBG(dev, "Not polling\n");\r\ngoto unlock;\r\n}\r\nDEV_DBG(dev, "Polling as %s",\r\ndev->curr_polling_mode == NFCSIM_POLL_INITIATOR ?\r\n"initiator\n" : "target\n");\r\nif (dev->curr_polling_mode == NFCSIM_POLL_TARGET)\r\ngoto sched_work;\r\nif (peer->curr_polling_mode == NFCSIM_POLL_TARGET) {\r\npeer->polling_mode = NFCSIM_POLL_NONE;\r\ndev->polling_mode = NFCSIM_POLL_NONE;\r\ndev->initiator = 1;\r\nnfcsim_target_found(dev);\r\ngoto unlock;\r\n}\r\nsched_work:\r\nqueue_delayed_work(wq, &dev->poll_work, msecs_to_jiffies(200));\r\nunlock:\r\nmutex_unlock(&peer->lock);\r\nmutex_unlock(&dev->lock);\r\n}\r\nstatic struct nfcsim *nfcsim_init_dev(void)\r\n{\r\nstruct nfcsim *dev;\r\nint rc = -ENOMEM;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (dev == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nmutex_init(&dev->lock);\r\nINIT_DELAYED_WORK(&dev->recv_work, nfcsim_wq_recv);\r\nINIT_DELAYED_WORK(&dev->poll_work, nfcsim_wq_poll);\r\ndev->nfc_dev = nfc_allocate_device(&nfcsim_nfc_ops,\r\nNFC_PROTO_NFC_DEP_MASK,\r\n0, 0);\r\nif (!dev->nfc_dev)\r\ngoto error;\r\nnfc_set_drvdata(dev->nfc_dev, dev);\r\nrc = nfc_register_device(dev->nfc_dev);\r\nif (rc)\r\ngoto free_nfc_dev;\r\ndev->rx_delay = RX_DEFAULT_DELAY;\r\nreturn dev;\r\nfree_nfc_dev:\r\nnfc_free_device(dev->nfc_dev);\r\nerror:\r\nkfree(dev);\r\nreturn ERR_PTR(rc);\r\n}\r\nstatic void nfcsim_free_device(struct nfcsim *dev)\r\n{\r\nnfc_unregister_device(dev->nfc_dev);\r\nnfc_free_device(dev->nfc_dev);\r\nkfree(dev);\r\n}\r\nstatic int __init nfcsim_init(void)\r\n{\r\nint rc;\r\nwq = alloc_ordered_workqueue("nfcsim", 0);\r\nif (!wq) {\r\nrc = -ENOMEM;\r\ngoto exit;\r\n}\r\ndev0 = nfcsim_init_dev();\r\nif (IS_ERR(dev0)) {\r\nrc = PTR_ERR(dev0);\r\ngoto exit;\r\n}\r\ndev1 = nfcsim_init_dev();\r\nif (IS_ERR(dev1)) {\r\nkfree(dev0);\r\nrc = PTR_ERR(dev1);\r\ngoto exit;\r\n}\r\ndev0->peer_dev = dev1;\r\ndev1->peer_dev = dev0;\r\npr_debug("NFCsim " NFCSIM_VERSION " initialized\n");\r\nrc = 0;\r\nexit:\r\nif (rc)\r\npr_err("Failed to initialize nfcsim driver (%d)\n",\r\nrc);\r\nreturn rc;\r\n}\r\nstatic void __exit nfcsim_exit(void)\r\n{\r\nnfcsim_cleanup_dev(dev0, 1);\r\nnfcsim_cleanup_dev(dev1, 1);\r\nnfcsim_free_device(dev0);\r\nnfcsim_free_device(dev1);\r\ndestroy_workqueue(wq);\r\n}

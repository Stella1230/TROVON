static ssize_t orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct orangefs_attribute *attribute;\r\nstruct orangefs_obj *orangefs_obj;\r\nint rc;\r\nattribute = container_of(attr, struct orangefs_attribute, attr);\r\norangefs_obj = container_of(kobj, struct orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct orangefs_attribute *attribute;\r\nstruct orangefs_obj *orangefs_obj;\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"orangefs_attr_store: start\n");\r\nattribute = container_of(attr, struct orangefs_attribute, attr);\r\norangefs_obj = container_of(kobj, struct orangefs_obj, kobj);\r\nif (!attribute->store) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->store(orangefs_obj, attribute, buf, len);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t acache_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct acache_orangefs_attribute *attribute;\r\nstruct acache_orangefs_obj *acache_orangefs_obj;\r\nint rc;\r\nattribute = container_of(attr, struct acache_orangefs_attribute, attr);\r\nacache_orangefs_obj =\r\ncontainer_of(kobj, struct acache_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(acache_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t acache_orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct acache_orangefs_attribute *attribute;\r\nstruct acache_orangefs_obj *acache_orangefs_obj;\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"acache_orangefs_attr_store: start\n");\r\nattribute = container_of(attr, struct acache_orangefs_attribute, attr);\r\nacache_orangefs_obj =\r\ncontainer_of(kobj, struct acache_orangefs_obj, kobj);\r\nif (!attribute->store) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->store(acache_orangefs_obj, attribute, buf, len);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t capcache_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct capcache_orangefs_attribute *attribute;\r\nstruct capcache_orangefs_obj *capcache_orangefs_obj;\r\nint rc;\r\nattribute =\r\ncontainer_of(attr, struct capcache_orangefs_attribute, attr);\r\ncapcache_orangefs_obj =\r\ncontainer_of(kobj, struct capcache_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(capcache_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t capcache_orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct capcache_orangefs_attribute *attribute;\r\nstruct capcache_orangefs_obj *capcache_orangefs_obj;\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"capcache_orangefs_attr_store: start\n");\r\nattribute =\r\ncontainer_of(attr, struct capcache_orangefs_attribute, attr);\r\ncapcache_orangefs_obj =\r\ncontainer_of(kobj, struct capcache_orangefs_obj, kobj);\r\nif (!attribute->store) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->store(capcache_orangefs_obj, attribute, buf, len);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t ccache_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct ccache_orangefs_attribute *attribute;\r\nstruct ccache_orangefs_obj *ccache_orangefs_obj;\r\nint rc;\r\nattribute =\r\ncontainer_of(attr, struct ccache_orangefs_attribute, attr);\r\nccache_orangefs_obj =\r\ncontainer_of(kobj, struct ccache_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(ccache_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t ccache_orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct ccache_orangefs_attribute *attribute;\r\nstruct ccache_orangefs_obj *ccache_orangefs_obj;\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"ccache_orangefs_attr_store: start\n");\r\nattribute =\r\ncontainer_of(attr, struct ccache_orangefs_attribute, attr);\r\nccache_orangefs_obj =\r\ncontainer_of(kobj, struct ccache_orangefs_obj, kobj);\r\nif (!attribute->store) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->store(ccache_orangefs_obj, attribute, buf, len);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t ncache_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct ncache_orangefs_attribute *attribute;\r\nstruct ncache_orangefs_obj *ncache_orangefs_obj;\r\nint rc;\r\nattribute = container_of(attr, struct ncache_orangefs_attribute, attr);\r\nncache_orangefs_obj =\r\ncontainer_of(kobj, struct ncache_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(ncache_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t ncache_orangefs_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct ncache_orangefs_attribute *attribute;\r\nstruct ncache_orangefs_obj *ncache_orangefs_obj;\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"ncache_orangefs_attr_store: start\n");\r\nattribute = container_of(attr, struct ncache_orangefs_attribute, attr);\r\nncache_orangefs_obj =\r\ncontainer_of(kobj, struct ncache_orangefs_obj, kobj);\r\nif (!attribute->store) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->store(ncache_orangefs_obj, attribute, buf, len);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t pc_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pc_orangefs_attribute *attribute;\r\nstruct pc_orangefs_obj *pc_orangefs_obj;\r\nint rc;\r\nattribute = container_of(attr, struct pc_orangefs_attribute, attr);\r\npc_orangefs_obj =\r\ncontainer_of(kobj, struct pc_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(pc_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t stats_orangefs_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct stats_orangefs_attribute *attribute;\r\nstruct stats_orangefs_obj *stats_orangefs_obj;\r\nint rc;\r\nattribute = container_of(attr, struct stats_orangefs_attribute, attr);\r\nstats_orangefs_obj =\r\ncontainer_of(kobj, struct stats_orangefs_obj, kobj);\r\nif (!attribute->show) {\r\nrc = -EIO;\r\ngoto out;\r\n}\r\nrc = attribute->show(stats_orangefs_obj, attribute, buf);\r\nout:\r\nreturn rc;\r\n}\r\nstatic void orangefs_release(struct kobject *kobj)\r\n{\r\nstruct orangefs_obj *orangefs_obj;\r\norangefs_obj = container_of(kobj, struct orangefs_obj, kobj);\r\nkfree(orangefs_obj);\r\n}\r\nstatic void acache_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct acache_orangefs_obj *acache_orangefs_obj;\r\nacache_orangefs_obj =\r\ncontainer_of(kobj, struct acache_orangefs_obj, kobj);\r\nkfree(acache_orangefs_obj);\r\n}\r\nstatic void capcache_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct capcache_orangefs_obj *capcache_orangefs_obj;\r\ncapcache_orangefs_obj =\r\ncontainer_of(kobj, struct capcache_orangefs_obj, kobj);\r\nkfree(capcache_orangefs_obj);\r\n}\r\nstatic void ccache_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct ccache_orangefs_obj *ccache_orangefs_obj;\r\nccache_orangefs_obj =\r\ncontainer_of(kobj, struct ccache_orangefs_obj, kobj);\r\nkfree(ccache_orangefs_obj);\r\n}\r\nstatic void ncache_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct ncache_orangefs_obj *ncache_orangefs_obj;\r\nncache_orangefs_obj =\r\ncontainer_of(kobj, struct ncache_orangefs_obj, kobj);\r\nkfree(ncache_orangefs_obj);\r\n}\r\nstatic void pc_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct pc_orangefs_obj *pc_orangefs_obj;\r\npc_orangefs_obj =\r\ncontainer_of(kobj, struct pc_orangefs_obj, kobj);\r\nkfree(pc_orangefs_obj);\r\n}\r\nstatic void stats_orangefs_release(struct kobject *kobj)\r\n{\r\nstruct stats_orangefs_obj *stats_orangefs_obj;\r\nstats_orangefs_obj =\r\ncontainer_of(kobj, struct stats_orangefs_obj, kobj);\r\nkfree(stats_orangefs_obj);\r\n}\r\nstatic ssize_t sysfs_int_show(char *kobj_id, char *buf, void *attr)\r\n{\r\nint rc = -EIO;\r\nstruct orangefs_attribute *orangefs_attr;\r\nstruct stats_orangefs_attribute *stats_orangefs_attr;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "sysfs_int_show: id:%s:\n", kobj_id);\r\nif (!strcmp(kobj_id, ORANGEFS_KOBJ_ID)) {\r\norangefs_attr = (struct orangefs_attribute *)attr;\r\nif (!strcmp(orangefs_attr->attr.name, "op_timeout_secs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\nop_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(orangefs_attr->attr.name,\r\n"slot_timeout_secs")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\nslot_timeout_secs);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\n} else if (!strcmp(kobj_id, STATS_KOBJ_ID)) {\r\nstats_orangefs_attr = (struct stats_orangefs_attribute *)attr;\r\nif (!strcmp(stats_orangefs_attr->attr.name, "reads")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%lu\n",\r\ng_orangefs_stats.reads);\r\ngoto out;\r\n} else if (!strcmp(stats_orangefs_attr->attr.name, "writes")) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%lu\n",\r\ng_orangefs_stats.writes);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\n}\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t int_orangefs_show(struct orangefs_obj *orangefs_obj,\r\nstruct orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"int_orangefs_show:start attr->attr.name:%s:\n",\r\nattr->attr.name);\r\nrc = sysfs_int_show(ORANGEFS_KOBJ_ID, buf, (void *) attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t int_stats_show(struct stats_orangefs_obj *stats_orangefs_obj,\r\nstruct stats_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"int_stats_show:start attr->attr.name:%s:\n",\r\nattr->attr.name);\r\nrc = sysfs_int_show(STATS_KOBJ_ID, buf, (void *) attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t int_store(struct orangefs_obj *orangefs_obj,\r\nstruct orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"int_store: start attr->attr.name:%s: buf:%s:\n",\r\nattr->attr.name, buf);\r\nif (!strcmp(attr->attr.name, "op_timeout_secs")) {\r\nrc = kstrtoint(buf, 0, &op_timeout_secs);\r\ngoto out;\r\n} else if (!strcmp(attr->attr.name, "slot_timeout_secs")) {\r\nrc = kstrtoint(buf, 0, &slot_timeout_secs);\r\ngoto out;\r\n} else {\r\ngoto out;\r\n}\r\nout:\r\nif (rc)\r\nrc = -EINVAL;\r\nelse\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic int sysfs_service_op_show(char *kobj_id, char *buf, void *attr)\r\n{\r\nstruct orangefs_kernel_op_s *new_op = NULL;\r\nint rc = 0;\r\nchar *ser_op_type = NULL;\r\nstruct orangefs_attribute *orangefs_attr;\r\nstruct acache_orangefs_attribute *acache_attr;\r\nstruct capcache_orangefs_attribute *capcache_attr;\r\nstruct ccache_orangefs_attribute *ccache_attr;\r\nstruct ncache_orangefs_attribute *ncache_attr;\r\nstruct pc_orangefs_attribute *pc_attr;\r\n__u32 op_alloc_type;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"sysfs_service_op_show: id:%s:\n",\r\nkobj_id);\r\nif (strcmp(kobj_id, PC_KOBJ_ID))\r\nop_alloc_type = ORANGEFS_VFS_OP_PARAM;\r\nelse\r\nop_alloc_type = ORANGEFS_VFS_OP_PERF_COUNT;\r\nnew_op = op_alloc(op_alloc_type);\r\nif (!new_op)\r\nreturn -ENOMEM;\r\nrc = is_daemon_in_service();\r\nif (rc) {\r\npr_info("%s: Client not running :%d:\n",\r\n__func__,\r\nis_daemon_in_service());\r\ngoto out;\r\n}\r\nif (strcmp(kobj_id, PC_KOBJ_ID))\r\nnew_op->upcall.req.param.type = ORANGEFS_PARAM_REQUEST_GET;\r\nif (!strcmp(kobj_id, ORANGEFS_KOBJ_ID)) {\r\norangefs_attr = (struct orangefs_attribute *)attr;\r\nif (!strcmp(orangefs_attr->attr.name, "perf_history_size"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_HISTORY_SIZE;\r\nelse if (!strcmp(orangefs_attr->attr.name,\r\n"perf_time_interval_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_TIME_INTERVAL_SECS;\r\nelse if (!strcmp(orangefs_attr->attr.name,\r\n"perf_counter_reset"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_RESET;\r\n} else if (!strcmp(kobj_id, ACACHE_KOBJ_ID)) {\r\nacache_attr = (struct acache_orangefs_attribute *)attr;\r\nif (!strcmp(acache_attr->attr.name, "timeout_msecs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_TIMEOUT_MSECS;\r\nif (!strcmp(acache_attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_HARD_LIMIT;\r\nif (!strcmp(acache_attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_SOFT_LIMIT;\r\nif (!strcmp(acache_attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj_id, CAPCACHE_KOBJ_ID)) {\r\ncapcache_attr = (struct capcache_orangefs_attribute *)attr;\r\nif (!strcmp(capcache_attr->attr.name, "timeout_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_TIMEOUT_SECS;\r\nif (!strcmp(capcache_attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_HARD_LIMIT;\r\nif (!strcmp(capcache_attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_SOFT_LIMIT;\r\nif (!strcmp(capcache_attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj_id, CCACHE_KOBJ_ID)) {\r\nccache_attr = (struct ccache_orangefs_attribute *)attr;\r\nif (!strcmp(ccache_attr->attr.name, "timeout_secs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_TIMEOUT_SECS;\r\nif (!strcmp(ccache_attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_HARD_LIMIT;\r\nif (!strcmp(ccache_attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_SOFT_LIMIT;\r\nif (!strcmp(ccache_attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj_id, NCACHE_KOBJ_ID)) {\r\nncache_attr = (struct ncache_orangefs_attribute *)attr;\r\nif (!strcmp(ncache_attr->attr.name, "timeout_msecs"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_TIMEOUT_MSECS;\r\nif (!strcmp(ncache_attr->attr.name, "hard_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_HARD_LIMIT;\r\nif (!strcmp(ncache_attr->attr.name, "soft_limit"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_SOFT_LIMIT;\r\nif (!strcmp(ncache_attr->attr.name, "reclaim_percentage"))\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_RECLAIM_PERCENTAGE;\r\n} else if (!strcmp(kobj_id, PC_KOBJ_ID)) {\r\npc_attr = (struct pc_orangefs_attribute *)attr;\r\nif (!strcmp(pc_attr->attr.name, ACACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_ACACHE;\r\nif (!strcmp(pc_attr->attr.name, CAPCACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_CAPCACHE;\r\nif (!strcmp(pc_attr->attr.name, NCACHE_KOBJ_ID))\r\nnew_op->upcall.req.perf_count.type =\r\nORANGEFS_PERF_COUNT_REQUEST_NCACHE;\r\n} else {\r\ngossip_err("sysfs_service_op_show: unknown kobj_id:%s:\n",\r\nkobj_id);\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nif (strcmp(kobj_id, PC_KOBJ_ID))\r\nser_op_type = "orangefs_param";\r\nelse\r\nser_op_type = "orangefs_perf_count";\r\nrc = service_operation(new_op, ser_op_type, ORANGEFS_OP_INTERRUPTIBLE);\r\nout:\r\nif (!rc) {\r\nif (strcmp(kobj_id, PC_KOBJ_ID)) {\r\nrc = scnprintf(buf,\r\nPAGE_SIZE,\r\n"%d\n",\r\n(int)new_op->downcall.resp.param.value);\r\n} else {\r\nrc = scnprintf(\r\nbuf,\r\nPAGE_SIZE,\r\n"%s",\r\nnew_op->downcall.resp.perf_count.buffer);\r\n}\r\n}\r\nop_release(new_op);\r\nreturn rc;\r\n}\r\nstatic ssize_t service_orangefs_show(struct orangefs_obj *orangefs_obj,\r\nstruct orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(ORANGEFS_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_acache_show(struct acache_orangefs_obj *acache_orangefs_obj,\r\nstruct acache_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(ACACHE_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t service_capcache_show(struct capcache_orangefs_obj\r\n*capcache_orangefs_obj,\r\nstruct capcache_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(CAPCACHE_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t service_ccache_show(struct ccache_orangefs_obj\r\n*ccache_orangefs_obj,\r\nstruct ccache_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(CCACHE_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_ncache_show(struct ncache_orangefs_obj *ncache_orangefs_obj,\r\nstruct ncache_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(NCACHE_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_pc_show(struct pc_orangefs_obj *pc_orangefs_obj,\r\nstruct pc_orangefs_attribute *attr,\r\nchar *buf)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_show(PC_KOBJ_ID, buf, (void *)attr);\r\nreturn rc;\r\n}\r\nstatic int sysfs_service_op_store(char *kobj_id, const char *buf, void *attr)\r\n{\r\nstruct orangefs_kernel_op_s *new_op = NULL;\r\nint val = 0;\r\nint rc = 0;\r\nstruct orangefs_attribute *orangefs_attr;\r\nstruct acache_orangefs_attribute *acache_attr;\r\nstruct capcache_orangefs_attribute *capcache_attr;\r\nstruct ccache_orangefs_attribute *ccache_attr;\r\nstruct ncache_orangefs_attribute *ncache_attr;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG,\r\n"sysfs_service_op_store: id:%s:\n",\r\nkobj_id);\r\nnew_op = op_alloc(ORANGEFS_VFS_OP_PARAM);\r\nif (!new_op)\r\nreturn -EINVAL;\r\nrc = is_daemon_in_service();\r\nif (rc) {\r\npr_info("%s: Client not running :%d:\n",\r\n__func__,\r\nis_daemon_in_service());\r\ngoto out;\r\n}\r\nrc = kstrtoint(buf, 0, &val);\r\nif (rc)\r\ngoto out;\r\nif (!strcmp(kobj_id, ORANGEFS_KOBJ_ID)) {\r\norangefs_attr = (struct orangefs_attribute *)attr;\r\nif (!strcmp(orangefs_attr->attr.name, "perf_history_size")) {\r\nif (val > 0) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_HISTORY_SIZE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(orangefs_attr->attr.name,\r\n"perf_time_interval_secs")) {\r\nif (val > 0) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_TIME_INTERVAL_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(orangefs_attr->attr.name,\r\n"perf_counter_reset")) {\r\nif ((val == 0) || (val == 1)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_PERF_RESET;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj_id, ACACHE_KOBJ_ID)) {\r\nacache_attr = (struct acache_orangefs_attribute *)attr;\r\nif (!strcmp(acache_attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(acache_attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(acache_attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(acache_attr->attr.name, "timeout_msecs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_ACACHE_TIMEOUT_MSECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj_id, CAPCACHE_KOBJ_ID)) {\r\ncapcache_attr = (struct capcache_orangefs_attribute *)attr;\r\nif (!strcmp(capcache_attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(capcache_attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(capcache_attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(capcache_attr->attr.name, "timeout_secs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CAPCACHE_TIMEOUT_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj_id, CCACHE_KOBJ_ID)) {\r\nccache_attr = (struct ccache_orangefs_attribute *)attr;\r\nif (!strcmp(ccache_attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ccache_attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ccache_attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ccache_attr->attr.name, "timeout_secs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_CCACHE_TIMEOUT_SECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else if (!strcmp(kobj_id, NCACHE_KOBJ_ID)) {\r\nncache_attr = (struct ncache_orangefs_attribute *)attr;\r\nif (!strcmp(ncache_attr->attr.name, "hard_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_HARD_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ncache_attr->attr.name, "soft_limit")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_SOFT_LIMIT;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ncache_attr->attr.name,\r\n"reclaim_percentage")) {\r\nif ((val > -1) && (val < 101)) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_RECLAIM_PERCENTAGE;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n} else if (!strcmp(ncache_attr->attr.name, "timeout_msecs")) {\r\nif (val > -1) {\r\nnew_op->upcall.req.param.op =\r\nORANGEFS_PARAM_REQUEST_OP_NCACHE_TIMEOUT_MSECS;\r\n} else {\r\nrc = 0;\r\ngoto out;\r\n}\r\n}\r\n} else {\r\ngossip_err("sysfs_service_op_store: unknown kobj_id:%s:\n",\r\nkobj_id);\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nnew_op->upcall.req.param.type = ORANGEFS_PARAM_REQUEST_SET;\r\nnew_op->upcall.req.param.value = val;\r\nrc = service_operation(new_op, "orangefs_param", ORANGEFS_OP_INTERRUPTIBLE);\r\nif (rc < 0) {\r\ngossip_err("sysfs_service_op_store: service op returned:%d:\n",\r\nrc);\r\nrc = 0;\r\n} else {\r\nrc = 1;\r\n}\r\nout:\r\nop_release(new_op);\r\nif (rc == -ENOMEM || rc == 0)\r\nrc = -EINVAL;\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_orangefs_store(struct orangefs_obj *orangefs_obj,\r\nstruct orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_store(ORANGEFS_KOBJ_ID, buf, (void *) attr);\r\nif (rc == 1)\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_acache_store(struct acache_orangefs_obj *acache_orangefs_obj,\r\nstruct acache_orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_store(ACACHE_KOBJ_ID, buf, (void *) attr);\r\nif (rc == 1)\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_capcache_store(struct capcache_orangefs_obj\r\n*capcache_orangefs_obj,\r\nstruct capcache_orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_store(CAPCACHE_KOBJ_ID, buf, (void *) attr);\r\nif (rc == 1)\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t service_ccache_store(struct ccache_orangefs_obj\r\n*ccache_orangefs_obj,\r\nstruct ccache_orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_store(CCACHE_KOBJ_ID, buf, (void *) attr);\r\nif (rc == 1)\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nservice_ncache_store(struct ncache_orangefs_obj *ncache_orangefs_obj,\r\nstruct ncache_orangefs_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc = 0;\r\nrc = sysfs_service_op_store(NCACHE_KOBJ_ID, buf, (void *) attr);\r\nif (rc == 1)\r\nrc = count;\r\nreturn rc;\r\n}\r\nint orangefs_sysfs_init(void)\r\n{\r\nint rc = -EINVAL;\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "orangefs_sysfs_init: start\n");\r\norangefs_obj = kzalloc(sizeof(*orangefs_obj), GFP_KERNEL);\r\nif (!orangefs_obj)\r\ngoto out;\r\nrc = kobject_init_and_add(&orangefs_obj->kobj,\r\n&orangefs_ktype,\r\nfs_kobj,\r\nORANGEFS_KOBJ_ID);\r\nif (rc)\r\ngoto ofs_obj_bail;\r\nkobject_uevent(&orangefs_obj->kobj, KOBJ_ADD);\r\nacache_orangefs_obj = kzalloc(sizeof(*acache_orangefs_obj), GFP_KERNEL);\r\nif (!acache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ofs_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&acache_orangefs_obj->kobj,\r\n&acache_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\nACACHE_KOBJ_ID);\r\nif (rc)\r\ngoto acache_obj_bail;\r\nkobject_uevent(&acache_orangefs_obj->kobj, KOBJ_ADD);\r\ncapcache_orangefs_obj =\r\nkzalloc(sizeof(*capcache_orangefs_obj), GFP_KERNEL);\r\nif (!capcache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto acache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&capcache_orangefs_obj->kobj,\r\n&capcache_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\nCAPCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto capcache_obj_bail;\r\nkobject_uevent(&capcache_orangefs_obj->kobj, KOBJ_ADD);\r\nccache_orangefs_obj =\r\nkzalloc(sizeof(*ccache_orangefs_obj), GFP_KERNEL);\r\nif (!ccache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto capcache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&ccache_orangefs_obj->kobj,\r\n&ccache_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\nCCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto ccache_obj_bail;\r\nkobject_uevent(&ccache_orangefs_obj->kobj, KOBJ_ADD);\r\nncache_orangefs_obj = kzalloc(sizeof(*ncache_orangefs_obj), GFP_KERNEL);\r\nif (!ncache_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ccache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&ncache_orangefs_obj->kobj,\r\n&ncache_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\nNCACHE_KOBJ_ID);\r\nif (rc)\r\ngoto ncache_obj_bail;\r\nkobject_uevent(&ncache_orangefs_obj->kobj, KOBJ_ADD);\r\npc_orangefs_obj = kzalloc(sizeof(*pc_orangefs_obj), GFP_KERNEL);\r\nif (!pc_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto ncache_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&pc_orangefs_obj->kobj,\r\n&pc_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\n"perf_counters");\r\nif (rc)\r\ngoto pc_obj_bail;\r\nkobject_uevent(&pc_orangefs_obj->kobj, KOBJ_ADD);\r\nstats_orangefs_obj = kzalloc(sizeof(*stats_orangefs_obj), GFP_KERNEL);\r\nif (!stats_orangefs_obj) {\r\nrc = -EINVAL;\r\ngoto pc_obj_bail;\r\n}\r\nrc = kobject_init_and_add(&stats_orangefs_obj->kobj,\r\n&stats_orangefs_ktype,\r\n&orangefs_obj->kobj,\r\nSTATS_KOBJ_ID);\r\nif (rc)\r\ngoto stats_obj_bail;\r\nkobject_uevent(&stats_orangefs_obj->kobj, KOBJ_ADD);\r\ngoto out;\r\nstats_obj_bail:\r\nkobject_put(&stats_orangefs_obj->kobj);\r\npc_obj_bail:\r\nkobject_put(&pc_orangefs_obj->kobj);\r\nncache_obj_bail:\r\nkobject_put(&ncache_orangefs_obj->kobj);\r\nccache_obj_bail:\r\nkobject_put(&ccache_orangefs_obj->kobj);\r\ncapcache_obj_bail:\r\nkobject_put(&capcache_orangefs_obj->kobj);\r\nacache_obj_bail:\r\nkobject_put(&acache_orangefs_obj->kobj);\r\nofs_obj_bail:\r\nkobject_put(&orangefs_obj->kobj);\r\nout:\r\nreturn rc;\r\n}\r\nvoid orangefs_sysfs_exit(void)\r\n{\r\ngossip_debug(GOSSIP_SYSFS_DEBUG, "orangefs_sysfs_exit: start\n");\r\nkobject_put(&acache_orangefs_obj->kobj);\r\nkobject_put(&capcache_orangefs_obj->kobj);\r\nkobject_put(&ccache_orangefs_obj->kobj);\r\nkobject_put(&ncache_orangefs_obj->kobj);\r\nkobject_put(&pc_orangefs_obj->kobj);\r\nkobject_put(&stats_orangefs_obj->kobj);\r\nkobject_put(&orangefs_obj->kobj);\r\n}

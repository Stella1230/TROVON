static inline void hisi_pcie_apb_writel(struct hisi_pcie *pcie,\r\nu32 val, u32 reg)\r\n{\r\nwritel(val, pcie->reg_base + reg);\r\n}\r\nstatic inline u32 hisi_pcie_apb_readl(struct hisi_pcie *pcie, u32 reg)\r\n{\r\nreturn readl(pcie->reg_base + reg);\r\n}\r\nstatic int hisi_pcie_cfg_read(struct pcie_port *pp, int where, int size,\r\nu32 *val)\r\n{\r\nu32 reg;\r\nu32 reg_val;\r\nstruct hisi_pcie *pcie = to_hisi_pcie(pp);\r\nvoid *walker = &reg_val;\r\nwalker += (where & 0x3);\r\nreg = where & ~0x3;\r\nreg_val = hisi_pcie_apb_readl(pcie, reg);\r\nif (size == 1)\r\n*val = *(u8 __force *) walker;\r\nelse if (size == 2)\r\n*val = *(u16 __force *) walker;\r\nelse if (size == 4)\r\n*val = reg_val;\r\nelse\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int hisi_pcie_cfg_write(struct pcie_port *pp, int where, int size,\r\nu32 val)\r\n{\r\nu32 reg_val;\r\nu32 reg;\r\nstruct hisi_pcie *pcie = to_hisi_pcie(pp);\r\nvoid *walker = &reg_val;\r\nwalker += (where & 0x3);\r\nreg = where & ~0x3;\r\nif (size == 4)\r\nhisi_pcie_apb_writel(pcie, val, reg);\r\nelse if (size == 2) {\r\nreg_val = hisi_pcie_apb_readl(pcie, reg);\r\n*(u16 __force *) walker = val;\r\nhisi_pcie_apb_writel(pcie, reg_val, reg);\r\n} else if (size == 1) {\r\nreg_val = hisi_pcie_apb_readl(pcie, reg);\r\n*(u8 __force *) walker = val;\r\nhisi_pcie_apb_writel(pcie, reg_val, reg);\r\n} else\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int hisi_pcie_link_up_hip05(struct hisi_pcie *hisi_pcie)\r\n{\r\nu32 val;\r\nregmap_read(hisi_pcie->subctrl, PCIE_SUBCTRL_SYS_STATE4_REG +\r\n0x100 * hisi_pcie->port_id, &val);\r\nreturn ((val & PCIE_LTSSM_STATE_MASK) == PCIE_LTSSM_LINKUP_STATE);\r\n}\r\nstatic int hisi_pcie_link_up_hip06(struct hisi_pcie *hisi_pcie)\r\n{\r\nu32 val;\r\nval = hisi_pcie_apb_readl(hisi_pcie, PCIE_HIP06_CTRL_OFF +\r\nPCIE_SYS_STATE4);\r\nreturn ((val & PCIE_LTSSM_STATE_MASK) == PCIE_LTSSM_LINKUP_STATE);\r\n}\r\nstatic int hisi_pcie_link_up(struct pcie_port *pp)\r\n{\r\nstruct hisi_pcie *hisi_pcie = to_hisi_pcie(pp);\r\nreturn hisi_pcie->soc_ops->hisi_pcie_link_up(hisi_pcie);\r\n}\r\nstatic int hisi_add_pcie_port(struct pcie_port *pp,\r\nstruct platform_device *pdev)\r\n{\r\nint ret;\r\nu32 port_id;\r\nstruct hisi_pcie *hisi_pcie = to_hisi_pcie(pp);\r\nif (of_property_read_u32(pdev->dev.of_node, "port-id", &port_id)) {\r\ndev_err(&pdev->dev, "failed to read port-id\n");\r\nreturn -EINVAL;\r\n}\r\nif (port_id > 3) {\r\ndev_err(&pdev->dev, "Invalid port-id: %d\n", port_id);\r\nreturn -EINVAL;\r\n}\r\nhisi_pcie->port_id = port_id;\r\npp->ops = &hisi_pcie_host_ops;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hisi_pcie_probe(struct platform_device *pdev)\r\n{\r\nstruct hisi_pcie *hisi_pcie;\r\nstruct pcie_port *pp;\r\nconst struct of_device_id *match;\r\nstruct resource *reg;\r\nstruct device_driver *driver;\r\nint ret;\r\nhisi_pcie = devm_kzalloc(&pdev->dev, sizeof(*hisi_pcie), GFP_KERNEL);\r\nif (!hisi_pcie)\r\nreturn -ENOMEM;\r\npp = &hisi_pcie->pp;\r\npp->dev = &pdev->dev;\r\ndriver = (pdev->dev).driver;\r\nmatch = of_match_device(driver->of_match_table, &pdev->dev);\r\nhisi_pcie->soc_ops = (struct pcie_soc_ops *) match->data;\r\nhisi_pcie->subctrl =\r\nsyscon_regmap_lookup_by_compatible("hisilicon,pcie-sas-subctrl");\r\nif (IS_ERR(hisi_pcie->subctrl)) {\r\ndev_err(pp->dev, "cannot get subctrl base\n");\r\nreturn PTR_ERR(hisi_pcie->subctrl);\r\n}\r\nreg = platform_get_resource_byname(pdev, IORESOURCE_MEM, "rc_dbi");\r\nhisi_pcie->reg_base = devm_ioremap_resource(&pdev->dev, reg);\r\nif (IS_ERR(hisi_pcie->reg_base)) {\r\ndev_err(pp->dev, "cannot get rc_dbi base\n");\r\nreturn PTR_ERR(hisi_pcie->reg_base);\r\n}\r\nhisi_pcie->pp.dbi_base = hisi_pcie->reg_base;\r\nret = hisi_add_pcie_port(pp, pdev);\r\nif (ret)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, hisi_pcie);\r\ndev_warn(pp->dev, "only 32-bit config accesses supported; smaller writes may corrupt adjacent RW1C fields\n");\r\nreturn 0;\r\n}

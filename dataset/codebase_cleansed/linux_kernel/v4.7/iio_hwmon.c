static ssize_t iio_hwmon_read_val(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint result;\r\nint ret;\r\nstruct sensor_device_attribute *sattr = to_sensor_dev_attr(attr);\r\nstruct iio_hwmon_state *state = dev_get_drvdata(dev);\r\nret = iio_read_channel_processed(&state->channels[sattr->index],\r\n&result);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", result);\r\n}\r\nstatic int iio_hwmon_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct iio_hwmon_state *st;\r\nstruct sensor_device_attribute *a;\r\nint ret, i;\r\nint in_i = 1, temp_i = 1, curr_i = 1, humidity_i = 1;\r\nenum iio_chan_type type;\r\nstruct iio_channel *channels;\r\nconst char *name = "iio_hwmon";\r\nchar *sname;\r\nif (dev->of_node && dev->of_node->name)\r\nname = dev->of_node->name;\r\nchannels = iio_channel_get_all(dev);\r\nif (IS_ERR(channels))\r\nreturn PTR_ERR(channels);\r\nst = devm_kzalloc(dev, sizeof(*st), GFP_KERNEL);\r\nif (st == NULL) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\nst->channels = channels;\r\nwhile (st->channels[st->num_channels].indio_dev)\r\nst->num_channels++;\r\nst->attrs = devm_kzalloc(dev,\r\nsizeof(*st->attrs) * (st->num_channels + 1),\r\nGFP_KERNEL);\r\nif (st->attrs == NULL) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\nfor (i = 0; i < st->num_channels; i++) {\r\na = devm_kzalloc(dev, sizeof(*a), GFP_KERNEL);\r\nif (a == NULL) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\nsysfs_attr_init(&a->dev_attr.attr);\r\nret = iio_get_channel_type(&st->channels[i], &type);\r\nif (ret < 0)\r\ngoto error_release_channels;\r\nswitch (type) {\r\ncase IIO_VOLTAGE:\r\na->dev_attr.attr.name = kasprintf(GFP_KERNEL,\r\n"in%d_input",\r\nin_i++);\r\nbreak;\r\ncase IIO_TEMP:\r\na->dev_attr.attr.name = kasprintf(GFP_KERNEL,\r\n"temp%d_input",\r\ntemp_i++);\r\nbreak;\r\ncase IIO_CURRENT:\r\na->dev_attr.attr.name = kasprintf(GFP_KERNEL,\r\n"curr%d_input",\r\ncurr_i++);\r\nbreak;\r\ncase IIO_HUMIDITYRELATIVE:\r\na->dev_attr.attr.name = kasprintf(GFP_KERNEL,\r\n"humidity%d_input",\r\nhumidity_i++);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto error_release_channels;\r\n}\r\nif (a->dev_attr.attr.name == NULL) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\na->dev_attr.show = iio_hwmon_read_val;\r\na->dev_attr.attr.mode = S_IRUGO;\r\na->index = i;\r\nst->attrs[i] = &a->dev_attr.attr;\r\n}\r\nst->attr_group.attrs = st->attrs;\r\nst->groups[0] = &st->attr_group;\r\nsname = devm_kstrdup(dev, name, GFP_KERNEL);\r\nif (!sname) {\r\nret = -ENOMEM;\r\ngoto error_release_channels;\r\n}\r\nstrreplace(sname, '-', '_');\r\nst->hwmon_dev = hwmon_device_register_with_groups(dev, sname, st,\r\nst->groups);\r\nif (IS_ERR(st->hwmon_dev)) {\r\nret = PTR_ERR(st->hwmon_dev);\r\ngoto error_release_channels;\r\n}\r\nplatform_set_drvdata(pdev, st);\r\nreturn 0;\r\nerror_release_channels:\r\niio_channel_release_all(channels);\r\nreturn ret;\r\n}\r\nstatic int iio_hwmon_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_hwmon_state *st = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(st->hwmon_dev);\r\niio_channel_release_all(st->channels);\r\nreturn 0;\r\n}

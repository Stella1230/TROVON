static\r\nssize_t i2400m_tlv_match(const struct i2400m_tlv_hdr *tlv,\r\nenum i2400m_tlv tlv_type, ssize_t tlv_size)\r\n{\r\nif (le16_to_cpu(tlv->type) != tlv_type)\r\nreturn -1;\r\nif (tlv_size != -1\r\n&& le16_to_cpu(tlv->length) + sizeof(*tlv) != tlv_size) {\r\nsize_t size = le16_to_cpu(tlv->length) + sizeof(*tlv);\r\nprintk(KERN_WARNING "W: tlv type 0x%x mismatched because of "\r\n"size (got %zu vs %zd expected)\n",\r\ntlv_type, size, tlv_size);\r\nreturn size;\r\n}\r\nreturn 0;\r\n}\r\nstatic\r\nconst struct i2400m_tlv_hdr *i2400m_tlv_buffer_walk(\r\nstruct i2400m *i2400m,\r\nconst void *tlv_buf, size_t buf_size,\r\nconst struct i2400m_tlv_hdr *tlv_pos)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nconst struct i2400m_tlv_hdr *tlv_top = tlv_buf + buf_size;\r\nsize_t offset, length, avail_size;\r\nunsigned type;\r\nif (tlv_pos == NULL)\r\ntlv_pos = tlv_buf;\r\nelse\r\ntlv_pos = (void *) tlv_pos\r\n+ le16_to_cpu(tlv_pos->length) + sizeof(*tlv_pos);\r\nif (tlv_pos == tlv_top) {\r\ntlv_pos = NULL;\r\ngoto error_beyond_end;\r\n}\r\nif (tlv_pos > tlv_top) {\r\ntlv_pos = NULL;\r\nWARN_ON(1);\r\ngoto error_beyond_end;\r\n}\r\noffset = (void *) tlv_pos - (void *) tlv_buf;\r\navail_size = buf_size - offset;\r\nif (avail_size < sizeof(*tlv_pos)) {\r\ndev_err(dev, "HW BUG? tlv_buf %p [%zu bytes], tlv @%zu: "\r\n"short header\n", tlv_buf, buf_size, offset);\r\ngoto error_short_header;\r\n}\r\ntype = le16_to_cpu(tlv_pos->type);\r\nlength = le16_to_cpu(tlv_pos->length);\r\nif (avail_size < sizeof(*tlv_pos) + length) {\r\ndev_err(dev, "HW BUG? tlv_buf %p [%zu bytes], "\r\n"tlv type 0x%04x @%zu: "\r\n"short data (%zu bytes vs %zu needed)\n",\r\ntlv_buf, buf_size, type, offset, avail_size,\r\nsizeof(*tlv_pos) + length);\r\ngoto error_short_header;\r\n}\r\nerror_short_header:\r\nerror_beyond_end:\r\nreturn tlv_pos;\r\n}\r\nstatic\r\nconst struct i2400m_tlv_hdr *i2400m_tlv_find(\r\nstruct i2400m *i2400m,\r\nconst struct i2400m_tlv_hdr *tlv_hdr, size_t size,\r\nenum i2400m_tlv tlv_type, ssize_t tlv_size)\r\n{\r\nssize_t match;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nconst struct i2400m_tlv_hdr *tlv = NULL;\r\nwhile ((tlv = i2400m_tlv_buffer_walk(i2400m, tlv_hdr, size, tlv))) {\r\nmatch = i2400m_tlv_match(tlv, tlv_type, tlv_size);\r\nif (match == 0)\r\nbreak;\r\nif (match > 0)\r\ndev_warn(dev, "TLV type 0x%04x found with size "\r\n"mismatch (%zu vs %zd needed)\n",\r\ntlv_type, match, tlv_size);\r\n}\r\nreturn tlv;\r\n}\r\nint i2400m_msg_check_status(const struct i2400m_l3l4_hdr *l3l4_hdr,\r\nchar *strbuf, size_t strbuf_size)\r\n{\r\nint result;\r\nenum i2400m_ms status = le16_to_cpu(l3l4_hdr->status);\r\nconst char *str;\r\nif (status == 0)\r\nreturn 0;\r\nif (status >= ARRAY_SIZE(ms_to_errno)) {\r\nstr = "unknown status code";\r\nresult = -EBADR;\r\n} else {\r\nstr = ms_to_errno[status].msg;\r\nresult = ms_to_errno[status].errno;\r\n}\r\nif (strbuf)\r\nsnprintf(strbuf, strbuf_size, "%s (%d)", str, status);\r\nreturn result;\r\n}\r\nstatic\r\nvoid i2400m_report_tlv_system_state(struct i2400m *i2400m,\r\nconst struct i2400m_tlv_system_state *ss)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct wimax_dev *wimax_dev = &i2400m->wimax_dev;\r\nenum i2400m_system_state i2400m_state = le32_to_cpu(ss->state);\r\nd_fnstart(3, dev, "(i2400m %p ss %p [%u])\n", i2400m, ss, i2400m_state);\r\nif (i2400m->state != i2400m_state) {\r\ni2400m->state = i2400m_state;\r\nwake_up_all(&i2400m->state_wq);\r\n}\r\nswitch (i2400m_state) {\r\ncase I2400M_SS_UNINITIALIZED:\r\ncase I2400M_SS_INIT:\r\ncase I2400M_SS_CONFIG:\r\ncase I2400M_SS_PRODUCTION:\r\nwimax_state_change(wimax_dev, WIMAX_ST_UNINITIALIZED);\r\nbreak;\r\ncase I2400M_SS_RF_OFF:\r\ncase I2400M_SS_RF_SHUTDOWN:\r\nwimax_state_change(wimax_dev, WIMAX_ST_RADIO_OFF);\r\nbreak;\r\ncase I2400M_SS_READY:\r\ncase I2400M_SS_STANDBY:\r\ncase I2400M_SS_SLEEPACTIVE:\r\nwimax_state_change(wimax_dev, WIMAX_ST_READY);\r\nbreak;\r\ncase I2400M_SS_CONNECTING:\r\ncase I2400M_SS_WIMAX_CONNECTED:\r\nwimax_state_change(wimax_dev, WIMAX_ST_READY);\r\nbreak;\r\ncase I2400M_SS_SCAN:\r\ncase I2400M_SS_OUT_OF_ZONE:\r\nwimax_state_change(wimax_dev, WIMAX_ST_SCANNING);\r\nbreak;\r\ncase I2400M_SS_IDLE:\r\nd_printf(1, dev, "entering BS-negotiated idle mode\n");\r\ncase I2400M_SS_DISCONNECTING:\r\ncase I2400M_SS_DATA_PATH_CONNECTED:\r\nwimax_state_change(wimax_dev, WIMAX_ST_CONNECTED);\r\nbreak;\r\ndefault:\r\ndev_err(dev, "HW BUG? unknown state %u: shutting down\n",\r\ni2400m_state);\r\ni2400m_reset(i2400m, I2400M_RT_WARM);\r\nbreak;\r\n}\r\nd_fnend(3, dev, "(i2400m %p ss %p [%u]) = void\n",\r\ni2400m, ss, i2400m_state);\r\n}\r\nstatic\r\nvoid i2400m_report_tlv_media_status(struct i2400m *i2400m,\r\nconst struct i2400m_tlv_media_status *ms)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct wimax_dev *wimax_dev = &i2400m->wimax_dev;\r\nstruct net_device *net_dev = wimax_dev->net_dev;\r\nenum i2400m_media_status status = le32_to_cpu(ms->media_status);\r\nd_fnstart(3, dev, "(i2400m %p ms %p [%u])\n", i2400m, ms, status);\r\nswitch (status) {\r\ncase I2400M_MEDIA_STATUS_LINK_UP:\r\nnetif_carrier_on(net_dev);\r\nbreak;\r\ncase I2400M_MEDIA_STATUS_LINK_DOWN:\r\nnetif_carrier_off(net_dev);\r\nbreak;\r\ncase I2400M_MEDIA_STATUS_LINK_RENEW:\r\nnetif_carrier_on(net_dev);\r\nbreak;\r\ndefault:\r\ndev_err(dev, "HW BUG? unknown media status %u\n",\r\nstatus);\r\n}\r\nd_fnend(3, dev, "(i2400m %p ms %p [%u]) = void\n",\r\ni2400m, ms, status);\r\n}\r\nstatic\r\nvoid i2400m_report_state_parse_tlv(struct i2400m *i2400m,\r\nconst struct i2400m_tlv_hdr *tlv,\r\nconst char *tag)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nconst struct i2400m_tlv_media_status *ms;\r\nconst struct i2400m_tlv_system_state *ss;\r\nconst struct i2400m_tlv_rf_switches_status *rfss;\r\nif (0 == i2400m_tlv_match(tlv, I2400M_TLV_SYSTEM_STATE, sizeof(*ss))) {\r\nss = container_of(tlv, typeof(*ss), hdr);\r\nd_printf(2, dev, "%s: system state TLV "\r\n"found (0x%04x), state 0x%08x\n",\r\ntag, I2400M_TLV_SYSTEM_STATE,\r\nle32_to_cpu(ss->state));\r\ni2400m_report_tlv_system_state(i2400m, ss);\r\n}\r\nif (0 == i2400m_tlv_match(tlv, I2400M_TLV_RF_STATUS, sizeof(*rfss))) {\r\nrfss = container_of(tlv, typeof(*rfss), hdr);\r\nd_printf(2, dev, "%s: RF status TLV "\r\n"found (0x%04x), sw 0x%02x hw 0x%02x\n",\r\ntag, I2400M_TLV_RF_STATUS,\r\nle32_to_cpu(rfss->sw_rf_switch),\r\nle32_to_cpu(rfss->hw_rf_switch));\r\ni2400m_report_tlv_rf_switches_status(i2400m, rfss);\r\n}\r\nif (0 == i2400m_tlv_match(tlv, I2400M_TLV_MEDIA_STATUS, sizeof(*ms))) {\r\nms = container_of(tlv, typeof(*ms), hdr);\r\nd_printf(2, dev, "%s: Media Status TLV: %u\n",\r\ntag, le32_to_cpu(ms->media_status));\r\ni2400m_report_tlv_media_status(i2400m, ms);\r\n}\r\n}\r\nstatic\r\nvoid i2400m_report_state_hook(struct i2400m *i2400m,\r\nconst struct i2400m_l3l4_hdr *l3l4_hdr,\r\nsize_t size, const char *tag)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nconst struct i2400m_tlv_hdr *tlv;\r\nsize_t tlv_size = le16_to_cpu(l3l4_hdr->length);\r\nd_fnstart(4, dev, "(i2400m %p, l3l4_hdr %p, size %zu, %s)\n",\r\ni2400m, l3l4_hdr, size, tag);\r\ntlv = NULL;\r\nwhile ((tlv = i2400m_tlv_buffer_walk(i2400m, &l3l4_hdr->pl,\r\ntlv_size, tlv)))\r\ni2400m_report_state_parse_tlv(i2400m, tlv, tag);\r\nd_fnend(4, dev, "(i2400m %p, l3l4_hdr %p, size %zu, %s) = void\n",\r\ni2400m, l3l4_hdr, size, tag);\r\n}\r\nvoid i2400m_report_hook(struct i2400m *i2400m,\r\nconst struct i2400m_l3l4_hdr *l3l4_hdr, size_t size)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nunsigned msg_type;\r\nd_fnstart(3, dev, "(i2400m %p l3l4_hdr %p size %zu)\n",\r\ni2400m, l3l4_hdr, size);\r\nmsg_type = le16_to_cpu(l3l4_hdr->type);\r\nswitch (msg_type) {\r\ncase I2400M_MT_REPORT_STATE:\r\ni2400m_report_state_hook(i2400m,\r\nl3l4_hdr, size, "REPORT STATE");\r\nbreak;\r\ncase I2400M_MT_REPORT_POWERSAVE_READY:\r\nif (l3l4_hdr->status == cpu_to_le16(I2400M_MS_DONE_OK)) {\r\nif (i2400m_power_save_disabled)\r\nd_printf(1, dev, "ready for powersave, "\r\n"not requesting (disabled by module "\r\n"parameter)\n");\r\nelse {\r\nd_printf(1, dev, "ready for powersave, "\r\n"requesting\n");\r\ni2400m_cmd_enter_powersave(i2400m);\r\n}\r\n}\r\nbreak;\r\n}\r\nd_fnend(3, dev, "(i2400m %p l3l4_hdr %p size %zu) = void\n",\r\ni2400m, l3l4_hdr, size);\r\n}\r\nstatic void i2400m_msg_ack_hook(struct i2400m *i2400m,\r\nconst struct i2400m_l3l4_hdr *l3l4_hdr,\r\nsize_t size)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nunsigned ack_type, ack_status;\r\nchar strerr[32];\r\nack_type = le16_to_cpu(l3l4_hdr->type);\r\nack_status = le16_to_cpu(l3l4_hdr->status);\r\nswitch (ack_type) {\r\ncase I2400M_MT_CMD_ENTER_POWERSAVE:\r\nif (0) {\r\nresult = i2400m_msg_check_status(\r\nl3l4_hdr, strerr, sizeof(strerr));\r\nif (result >= 0)\r\nd_printf(1, dev, "ready for power save: %zd\n",\r\nsize);\r\n}\r\nbreak;\r\n}\r\n}\r\nint i2400m_msg_size_check(struct i2400m *i2400m,\r\nconst struct i2400m_l3l4_hdr *l3l4_hdr,\r\nsize_t msg_size)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nsize_t expected_size;\r\nd_fnstart(4, dev, "(i2400m %p l3l4_hdr %p msg_size %zu)\n",\r\ni2400m, l3l4_hdr, msg_size);\r\nif (msg_size < sizeof(*l3l4_hdr)) {\r\ndev_err(dev, "bad size for message header "\r\n"(expected at least %zu, got %zu)\n",\r\n(size_t) sizeof(*l3l4_hdr), msg_size);\r\nresult = -EIO;\r\ngoto error_hdr_size;\r\n}\r\nexpected_size = le16_to_cpu(l3l4_hdr->length) + sizeof(*l3l4_hdr);\r\nif (msg_size < expected_size) {\r\ndev_err(dev, "bad size for message code 0x%04x (expected %zu, "\r\n"got %zu)\n", le16_to_cpu(l3l4_hdr->type),\r\nexpected_size, msg_size);\r\nresult = -EIO;\r\n} else\r\nresult = 0;\r\nerror_hdr_size:\r\nd_fnend(4, dev,\r\n"(i2400m %p l3l4_hdr %p msg_size %zu) = %d\n",\r\ni2400m, l3l4_hdr, msg_size, result);\r\nreturn result;\r\n}\r\nvoid i2400m_msg_to_dev_cancel_wait(struct i2400m *i2400m, int code)\r\n{\r\nstruct sk_buff *ack_skb;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\nack_skb = i2400m->ack_skb;\r\nif (ack_skb && !IS_ERR(ack_skb))\r\nkfree_skb(ack_skb);\r\ni2400m->ack_skb = ERR_PTR(code);\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\n}\r\nstruct sk_buff *i2400m_msg_to_dev(struct i2400m *i2400m,\r\nconst void *buf, size_t buf_len)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nconst struct i2400m_l3l4_hdr *msg_l3l4_hdr;\r\nstruct sk_buff *ack_skb;\r\nconst struct i2400m_l3l4_hdr *ack_l3l4_hdr;\r\nsize_t ack_len;\r\nint ack_timeout;\r\nunsigned msg_type;\r\nunsigned long flags;\r\nd_fnstart(3, dev, "(i2400m %p buf %p len %zu)\n",\r\ni2400m, buf, buf_len);\r\nrmb();\r\nif (i2400m->boot_mode)\r\nreturn ERR_PTR(-EL3RST);\r\nmsg_l3l4_hdr = buf;\r\nresult = i2400m_msg_size_check(i2400m, msg_l3l4_hdr, buf_len);\r\nif (result < 0)\r\ngoto error_bad_msg;\r\nmsg_type = le16_to_cpu(msg_l3l4_hdr->type);\r\nd_printf(1, dev, "CMD/GET/SET 0x%04x %zu bytes\n",\r\nmsg_type, buf_len);\r\nd_dump(2, dev, buf, buf_len);\r\nmutex_lock(&i2400m->msg_mutex);\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\ni2400m->ack_skb = ERR_PTR(-EINPROGRESS);\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\ninit_completion(&i2400m->msg_completion);\r\nresult = i2400m_tx(i2400m, buf, buf_len, I2400M_PT_CTRL);\r\nif (result < 0) {\r\ndev_err(dev, "can't send message 0x%04x: %d\n",\r\nle16_to_cpu(msg_l3l4_hdr->type), result);\r\ngoto error_tx;\r\n}\r\nswitch (msg_type) {\r\ncase I2400M_MT_GET_TLS_OPERATION_RESULT:\r\ncase I2400M_MT_CMD_SEND_EAP_RESPONSE:\r\nack_timeout = 5 * HZ;\r\nbreak;\r\ndefault:\r\nack_timeout = HZ;\r\n}\r\nif (unlikely(i2400m->trace_msg_from_user))\r\nwimax_msg(&i2400m->wimax_dev, "echo", buf, buf_len, GFP_KERNEL);\r\nresult = wait_for_completion_interruptible_timeout(\r\n&i2400m->msg_completion, ack_timeout);\r\nif (result == 0) {\r\ndev_err(dev, "timeout waiting for reply to message 0x%04x\n",\r\nmsg_type);\r\nresult = -ETIMEDOUT;\r\ni2400m_msg_to_dev_cancel_wait(i2400m, result);\r\ngoto error_wait_for_completion;\r\n} else if (result < 0) {\r\ndev_err(dev, "error waiting for reply to message 0x%04x: %d\n",\r\nmsg_type, result);\r\ni2400m_msg_to_dev_cancel_wait(i2400m, result);\r\ngoto error_wait_for_completion;\r\n}\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\nack_skb = i2400m->ack_skb;\r\nif (IS_ERR(ack_skb))\r\nresult = PTR_ERR(ack_skb);\r\nelse\r\nresult = 0;\r\ni2400m->ack_skb = NULL;\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\nif (result < 0)\r\ngoto error_ack_status;\r\nack_l3l4_hdr = wimax_msg_data_len(ack_skb, &ack_len);\r\nif (unlikely(i2400m->trace_msg_from_user))\r\nwimax_msg(&i2400m->wimax_dev, "echo",\r\nack_l3l4_hdr, ack_len, GFP_KERNEL);\r\nresult = i2400m_msg_size_check(i2400m, ack_l3l4_hdr, ack_len);\r\nif (result < 0) {\r\ndev_err(dev, "HW BUG? reply to message 0x%04x: %d\n",\r\nmsg_type, result);\r\ngoto error_bad_ack_len;\r\n}\r\nif (msg_type != le16_to_cpu(ack_l3l4_hdr->type)) {\r\ndev_err(dev, "HW BUG? bad reply 0x%04x to message 0x%04x\n",\r\nle16_to_cpu(ack_l3l4_hdr->type), msg_type);\r\nresult = -EIO;\r\ngoto error_bad_ack_type;\r\n}\r\ni2400m_msg_ack_hook(i2400m, ack_l3l4_hdr, ack_len);\r\nmutex_unlock(&i2400m->msg_mutex);\r\nd_fnend(3, dev, "(i2400m %p buf %p len %zu) = %p\n",\r\ni2400m, buf, buf_len, ack_skb);\r\nreturn ack_skb;\r\nerror_bad_ack_type:\r\nerror_bad_ack_len:\r\nkfree_skb(ack_skb);\r\nerror_ack_status:\r\nerror_wait_for_completion:\r\nerror_tx:\r\nmutex_unlock(&i2400m->msg_mutex);\r\nerror_bad_msg:\r\nd_fnend(3, dev, "(i2400m %p buf %p len %zu) = %d\n",\r\ni2400m, buf, buf_len, result);\r\nreturn ERR_PTR(result);\r\n}\r\nint i2400m_cmd_enter_powersave(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_cmd_enter_power_save *cmd;\r\nchar strerr[32];\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->hdr.type = cpu_to_le16(I2400M_MT_CMD_ENTER_POWERSAVE);\r\ncmd->hdr.length = cpu_to_le16(sizeof(*cmd) - sizeof(cmd->hdr));\r\ncmd->hdr.version = cpu_to_le16(I2400M_L3L4_VERSION);\r\ncmd->tlv.type = cpu_to_le16(I2400M_TLV_TYPE_WAKEUP_MODE);\r\ncmd->tlv.length = cpu_to_le16(sizeof(cmd->val));\r\ncmd->val = cpu_to_le32(I2400M_WAKEUP_ENABLED);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nresult = PTR_ERR(ack_skb);\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'Enter power save' command: %d\n",\r\nresult);\r\ngoto error_msg_to_dev;\r\n}\r\nresult = i2400m_msg_check_status(wimax_msg_data(ack_skb),\r\nstrerr, sizeof(strerr));\r\nif (result == -EACCES)\r\nd_printf(1, dev, "Cannot enter power save mode\n");\r\nelse if (result < 0)\r\ndev_err(dev, "'Enter power save' (0x%04x) command failed: "\r\n"%d - %s\n", I2400M_MT_CMD_ENTER_POWERSAVE,\r\nresult, strerr);\r\nelse\r\nd_printf(1, dev, "device ready to power save\n");\r\nkfree_skb(ack_skb);\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn result;\r\n}\r\nstruct sk_buff *i2400m_get_device_info(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_l3l4_hdr *cmd;\r\nconst struct i2400m_l3l4_hdr *ack;\r\nsize_t ack_len;\r\nconst struct i2400m_tlv_hdr *tlv;\r\nconst struct i2400m_tlv_detailed_device_info *ddi;\r\nchar strerr[32];\r\nack_skb = ERR_PTR(-ENOMEM);\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->type = cpu_to_le16(I2400M_MT_GET_DEVICE_INFO);\r\ncmd->length = 0;\r\ncmd->version = cpu_to_le16(I2400M_L3L4_VERSION);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'get device info' command: %ld\n",\r\nPTR_ERR(ack_skb));\r\ngoto error_msg_to_dev;\r\n}\r\nack = wimax_msg_data_len(ack_skb, &ack_len);\r\nresult = i2400m_msg_check_status(ack, strerr, sizeof(strerr));\r\nif (result < 0) {\r\ndev_err(dev, "'get device info' (0x%04x) command failed: "\r\n"%d - %s\n", I2400M_MT_GET_DEVICE_INFO, result,\r\nstrerr);\r\ngoto error_cmd_failed;\r\n}\r\ntlv = i2400m_tlv_find(i2400m, ack->pl, ack_len - sizeof(*ack),\r\nI2400M_TLV_DETAILED_DEVICE_INFO, sizeof(*ddi));\r\nif (tlv == NULL) {\r\ndev_err(dev, "GET DEVICE INFO: "\r\n"detailed device info TLV not found (0x%04x)\n",\r\nI2400M_TLV_DETAILED_DEVICE_INFO);\r\nresult = -EIO;\r\ngoto error_no_tlv;\r\n}\r\nskb_pull(ack_skb, (void *) tlv - (void *) ack_skb->data);\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn ack_skb;\r\nerror_no_tlv:\r\nerror_cmd_failed:\r\nkfree_skb(ack_skb);\r\nkfree(cmd);\r\nreturn ERR_PTR(result);\r\n}\r\nint i2400m_firmware_check(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_l3l4_hdr *cmd;\r\nconst struct i2400m_l3l4_hdr *ack;\r\nsize_t ack_len;\r\nconst struct i2400m_tlv_hdr *tlv;\r\nconst struct i2400m_tlv_l4_message_versions *l4mv;\r\nchar strerr[32];\r\nunsigned major, minor, branch;\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->type = cpu_to_le16(I2400M_MT_GET_LM_VERSION);\r\ncmd->length = 0;\r\ncmd->version = cpu_to_le16(I2400M_L3L4_VERSION);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nif (IS_ERR(ack_skb)) {\r\nresult = PTR_ERR(ack_skb);\r\ndev_err(dev, "Failed to issue 'get lm version' command: %-d\n",\r\nresult);\r\ngoto error_msg_to_dev;\r\n}\r\nack = wimax_msg_data_len(ack_skb, &ack_len);\r\nresult = i2400m_msg_check_status(ack, strerr, sizeof(strerr));\r\nif (result < 0) {\r\ndev_err(dev, "'get lm version' (0x%04x) command failed: "\r\n"%d - %s\n", I2400M_MT_GET_LM_VERSION, result,\r\nstrerr);\r\ngoto error_cmd_failed;\r\n}\r\ntlv = i2400m_tlv_find(i2400m, ack->pl, ack_len - sizeof(*ack),\r\nI2400M_TLV_L4_MESSAGE_VERSIONS, sizeof(*l4mv));\r\nif (tlv == NULL) {\r\ndev_err(dev, "get lm version: TLV not found (0x%04x)\n",\r\nI2400M_TLV_L4_MESSAGE_VERSIONS);\r\nresult = -EIO;\r\ngoto error_no_tlv;\r\n}\r\nl4mv = container_of(tlv, typeof(*l4mv), hdr);\r\nmajor = le16_to_cpu(l4mv->major);\r\nminor = le16_to_cpu(l4mv->minor);\r\nbranch = le16_to_cpu(l4mv->branch);\r\nresult = -EINVAL;\r\nif (major != I2400M_HDIv_MAJOR) {\r\ndev_err(dev, "unsupported major fw version "\r\n"%u.%u.%u\n", major, minor, branch);\r\ngoto error_bad_major;\r\n}\r\nresult = 0;\r\nif (minor > I2400M_HDIv_MINOR_2 || minor < I2400M_HDIv_MINOR)\r\ndev_warn(dev, "untested minor fw version %u.%u.%u\n",\r\nmajor, minor, branch);\r\ni2400m->fw_version = major << 16 | minor;\r\ndev_info(dev, "firmware interface version %u.%u.%u\n",\r\nmajor, minor, branch);\r\nerror_bad_major:\r\nerror_no_tlv:\r\nerror_cmd_failed:\r\nkfree_skb(ack_skb);\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn result;\r\n}\r\nint i2400m_cmd_exit_idle(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_l3l4_hdr *cmd;\r\nchar strerr[32];\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->type = cpu_to_le16(I2400M_MT_CMD_EXIT_IDLE);\r\ncmd->length = 0;\r\ncmd->version = cpu_to_le16(I2400M_L3L4_VERSION);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nresult = PTR_ERR(ack_skb);\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'exit idle' command: %d\n",\r\nresult);\r\ngoto error_msg_to_dev;\r\n}\r\nresult = i2400m_msg_check_status(wimax_msg_data(ack_skb),\r\nstrerr, sizeof(strerr));\r\nkfree_skb(ack_skb);\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn result;\r\n}\r\nstatic int i2400m_cmd_get_state(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_l3l4_hdr *cmd;\r\nconst struct i2400m_l3l4_hdr *ack;\r\nsize_t ack_len;\r\nchar strerr[32];\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->type = cpu_to_le16(I2400M_MT_GET_STATE);\r\ncmd->length = 0;\r\ncmd->version = cpu_to_le16(I2400M_L3L4_VERSION);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'get state' command: %ld\n",\r\nPTR_ERR(ack_skb));\r\nresult = PTR_ERR(ack_skb);\r\ngoto error_msg_to_dev;\r\n}\r\nack = wimax_msg_data_len(ack_skb, &ack_len);\r\nresult = i2400m_msg_check_status(ack, strerr, sizeof(strerr));\r\nif (result < 0) {\r\ndev_err(dev, "'get state' (0x%04x) command failed: "\r\n"%d - %s\n", I2400M_MT_GET_STATE, result, strerr);\r\ngoto error_cmd_failed;\r\n}\r\ni2400m_report_state_hook(i2400m, ack, ack_len - sizeof(*ack),\r\n"GET STATE");\r\nresult = 0;\r\nkfree_skb(ack_skb);\r\nerror_cmd_failed:\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn result;\r\n}\r\nstatic int i2400m_set_init_config(struct i2400m *i2400m,\r\nconst struct i2400m_tlv_hdr **arg,\r\nsize_t args)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct i2400m_l3l4_hdr *cmd;\r\nchar strerr[32];\r\nunsigned argc, argsize, tlv_size;\r\nconst struct i2400m_tlv_hdr *tlv_hdr;\r\nvoid *buf, *itr;\r\nd_fnstart(3, dev, "(i2400m %p arg %p args %zu)\n", i2400m, arg, args);\r\nresult = 0;\r\nif (args == 0)\r\ngoto none;\r\nargsize = 0;\r\nfor (argc = 0; argc < args; argc++) {\r\ntlv_hdr = arg[argc];\r\nargsize += sizeof(*tlv_hdr) + le16_to_cpu(tlv_hdr->length);\r\n}\r\nWARN_ON(argc >= 9);\r\nresult = -ENOMEM;\r\nbuf = kzalloc(sizeof(*cmd) + argsize, GFP_KERNEL);\r\nif (buf == NULL)\r\ngoto error_alloc;\r\ncmd = buf;\r\ncmd->type = cpu_to_le16(I2400M_MT_SET_INIT_CONFIG);\r\ncmd->length = cpu_to_le16(argsize);\r\ncmd->version = cpu_to_le16(I2400M_L3L4_VERSION);\r\nitr = buf + sizeof(*cmd);\r\nfor (argc = 0; argc < args; argc++) {\r\ntlv_hdr = arg[argc];\r\ntlv_size = sizeof(*tlv_hdr) + le16_to_cpu(tlv_hdr->length);\r\nmemcpy(itr, tlv_hdr, tlv_size);\r\nitr += tlv_size;\r\n}\r\nack_skb = i2400m_msg_to_dev(i2400m, buf, sizeof(*cmd) + argsize);\r\nresult = PTR_ERR(ack_skb);\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'init config' command: %d\n",\r\nresult);\r\ngoto error_msg_to_dev;\r\n}\r\nresult = i2400m_msg_check_status(wimax_msg_data(ack_skb),\r\nstrerr, sizeof(strerr));\r\nif (result < 0)\r\ndev_err(dev, "'init config' (0x%04x) command failed: %d - %s\n",\r\nI2400M_MT_SET_INIT_CONFIG, result, strerr);\r\nkfree_skb(ack_skb);\r\nerror_msg_to_dev:\r\nkfree(buf);\r\nerror_alloc:\r\nnone:\r\nd_fnend(3, dev, "(i2400m %p arg %p args %zu) = %d\n",\r\ni2400m, arg, args, result);\r\nreturn result;\r\n}\r\nint i2400m_set_idle_timeout(struct i2400m *i2400m, unsigned msecs)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct sk_buff *ack_skb;\r\nstruct {\r\nstruct i2400m_l3l4_hdr hdr;\r\nstruct i2400m_tlv_config_idle_timeout cit;\r\n} *cmd;\r\nconst struct i2400m_l3l4_hdr *ack;\r\nsize_t ack_len;\r\nchar strerr[32];\r\nresult = -ENOSYS;\r\nif (i2400m_le_v1_3(i2400m))\r\ngoto error_alloc;\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_alloc;\r\ncmd->hdr.type = cpu_to_le16(I2400M_MT_GET_STATE);\r\ncmd->hdr.length = cpu_to_le16(sizeof(*cmd) - sizeof(cmd->hdr));\r\ncmd->hdr.version = cpu_to_le16(I2400M_L3L4_VERSION);\r\ncmd->cit.hdr.type =\r\ncpu_to_le16(I2400M_TLV_CONFIG_IDLE_TIMEOUT);\r\ncmd->cit.hdr.length = cpu_to_le16(sizeof(cmd->cit.timeout));\r\ncmd->cit.timeout = cpu_to_le32(msecs);\r\nack_skb = i2400m_msg_to_dev(i2400m, cmd, sizeof(*cmd));\r\nif (IS_ERR(ack_skb)) {\r\ndev_err(dev, "Failed to issue 'set idle timeout' command: "\r\n"%ld\n", PTR_ERR(ack_skb));\r\nresult = PTR_ERR(ack_skb);\r\ngoto error_msg_to_dev;\r\n}\r\nack = wimax_msg_data_len(ack_skb, &ack_len);\r\nresult = i2400m_msg_check_status(ack, strerr, sizeof(strerr));\r\nif (result < 0) {\r\ndev_err(dev, "'set idle timeout' (0x%04x) command failed: "\r\n"%d - %s\n", I2400M_MT_GET_STATE, result, strerr);\r\ngoto error_cmd_failed;\r\n}\r\nresult = 0;\r\nkfree_skb(ack_skb);\r\nerror_cmd_failed:\r\nerror_msg_to_dev:\r\nkfree(cmd);\r\nerror_alloc:\r\nreturn result;\r\n}\r\nint i2400m_dev_initialize(struct i2400m *i2400m)\r\n{\r\nint result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct i2400m_tlv_config_idle_parameters idle_params;\r\nstruct i2400m_tlv_config_idle_timeout idle_timeout;\r\nstruct i2400m_tlv_config_d2h_data_format df;\r\nstruct i2400m_tlv_config_dl_host_reorder dlhr;\r\nconst struct i2400m_tlv_hdr *args[9];\r\nunsigned argc = 0;\r\nd_fnstart(3, dev, "(i2400m %p)\n", i2400m);\r\nif (i2400m_passive_mode)\r\ngoto out_passive;\r\nif (i2400m_idle_mode_disabled) {\r\nif (i2400m_le_v1_3(i2400m)) {\r\nidle_params.hdr.type =\r\ncpu_to_le16(I2400M_TLV_CONFIG_IDLE_PARAMETERS);\r\nidle_params.hdr.length = cpu_to_le16(\r\nsizeof(idle_params) - sizeof(idle_params.hdr));\r\nidle_params.idle_timeout = 0;\r\nidle_params.idle_paging_interval = 0;\r\nargs[argc++] = &idle_params.hdr;\r\n} else {\r\nidle_timeout.hdr.type =\r\ncpu_to_le16(I2400M_TLV_CONFIG_IDLE_TIMEOUT);\r\nidle_timeout.hdr.length = cpu_to_le16(\r\nsizeof(idle_timeout) - sizeof(idle_timeout.hdr));\r\nidle_timeout.timeout = 0;\r\nargs[argc++] = &idle_timeout.hdr;\r\n}\r\n}\r\nif (i2400m_ge_v1_4(i2400m)) {\r\ndf.hdr.type =\r\ncpu_to_le16(I2400M_TLV_CONFIG_D2H_DATA_FORMAT);\r\ndf.hdr.length = cpu_to_le16(\r\nsizeof(df) - sizeof(df.hdr));\r\ndf.format = 1;\r\nargs[argc++] = &df.hdr;\r\nif (i2400m->rx_reorder) {\r\ndlhr.hdr.type =\r\ncpu_to_le16(I2400M_TLV_CONFIG_DL_HOST_REORDER);\r\ndlhr.hdr.length = cpu_to_le16(\r\nsizeof(dlhr) - sizeof(dlhr.hdr));\r\ndlhr.reorder = 1;\r\nargs[argc++] = &dlhr.hdr;\r\n}\r\n}\r\nresult = i2400m_set_init_config(i2400m, args, argc);\r\nif (result < 0)\r\ngoto error;\r\nout_passive:\r\nresult = i2400m_cmd_get_state(i2400m);\r\nerror:\r\nif (result < 0)\r\ndev_err(dev, "failed to initialize the device: %d\n", result);\r\nd_fnend(3, dev, "(i2400m %p) = %d\n", i2400m, result);\r\nreturn result;\r\n}\r\nvoid i2400m_dev_shutdown(struct i2400m *i2400m)\r\n{\r\nstruct device *dev = i2400m_dev(i2400m);\r\nd_fnstart(3, dev, "(i2400m %p)\n", i2400m);\r\nd_fnend(3, dev, "(i2400m %p) = void\n", i2400m);\r\n}

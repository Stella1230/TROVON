u_int\r\ndecode_fpu(unsigned int Fpu_register[], unsigned int trap_counts[])\r\n{\r\nunsigned int current_ir, excp;\r\nint target, exception_index = 1;\r\nboolean inexact;\r\nunsigned int aflags;\r\nunsigned int bflags;\r\nunsigned int excptype;\r\nbflags=(Fpu_register[0] & 0xf8000000);\r\nFpu_register[0] &= 0x07ffffff;\r\nif (!Is_tbit_set()) {\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nreturn SIGNALCODE(SIGILL, ILL_COPROC);\r\n}\r\nfor (exception_index=1; exception_index<=MAX_EXCP_REG; exception_index++) {\r\ncurrent_ir = Excp_instr(exception_index);\r\nexcptype = Excp_type(exception_index);\r\nif (excptype & UNIMPLEMENTEDEXCEPTION) {\r\nClear_tbit();\r\nClear_excp_register(exception_index);\r\nexcp = fpudispatch(current_ir,excptype,0,Fpu_register);\r\nif (excp) {\r\nSet_tbit();\r\nSet_exceptiontype_and_instr_field(excp,current_ir,\r\nFpu_register[exception_index]);\r\nif (excp == UNIMPLEMENTEDEXCEPTION) {\r\nexcp = excptype;\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nreturn SIGNALCODE(SIGILL, ILL_COPROC);\r\n}\r\nexcptype = excp;\r\n}\r\nif (excp == NOEXCEPTION)\r\nbreak;\r\n}\r\nif (excptype & UNDERFLOWEXCEPTION) {\r\nif (Is_underflowtrap_enabled()) {\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTUND);\r\n} else {\r\ntarget = current_ir & fivebits;\r\n#ifndef lint\r\nif (Ibit(Fpu_register[exception_index])) inexact = TRUE;\r\nelse inexact = FALSE;\r\n#endif\r\nswitch (Excp_format()) {\r\ncase SGL:\r\nif (Rabit(Fpu_register[exception_index]))\r\nSgl_decrement(Fpu_sgl(target));\r\nsgl_denormalize(&Fpu_sgl(target),&inexact,Rounding_mode());\r\nbreak;\r\ncase DBL:\r\nif (Rabit(Fpu_register[exception_index]))\r\nDbl_decrement(Fpu_dblp1(target),Fpu_dblp2(target));\r\ndbl_denormalize(&Fpu_dblp1(target),&Fpu_dblp2(target),\r\n&inexact,Rounding_mode());\r\nbreak;\r\n}\r\nif (inexact) Set_underflowflag();\r\nif (inexact && Is_inexacttrap_enabled()) {\r\nSet_exceptiontype(Fpu_register[exception_index],\r\nINEXACTEXCEPTION);\r\nSet_parmfield(Fpu_register[exception_index],0);\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTRES);\r\n}\r\nelse {\r\nClear_excp_register(exception_index);\r\nif (inexact) Set_inexactflag();\r\n}\r\n}\r\ncontinue;\r\n}\r\nswitch(Excp_type(exception_index)) {\r\ncase OVERFLOWEXCEPTION:\r\ncase OVERFLOWEXCEPTION | INEXACTEXCEPTION:\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nif (Is_overflowtrap_enabled()) {\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTOVF);\r\n} else {\r\ntarget = current_ir & fivebits;\r\nswitch (Excp_format()) {\r\ncase SGL:\r\nSgl_setoverflow(Fpu_sgl(target));\r\nbreak;\r\ncase DBL:\r\nDbl_setoverflow(Fpu_dblp1(target),Fpu_dblp2(target));\r\nbreak;\r\n}\r\nSet_overflowflag();\r\nif (Is_inexacttrap_enabled()) {\r\nSet_exceptiontype(Fpu_register[exception_index],\r\nINEXACTEXCEPTION);\r\nupdate_trap_counts(Fpu_register, aflags, bflags,\r\ntrap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTRES);\r\n}\r\nelse {\r\nClear_excp_register(exception_index);\r\nSet_inexactflag();\r\n}\r\n}\r\nbreak;\r\ncase INVALIDEXCEPTION:\r\ncase OPC_2E_INVALIDEXCEPTION:\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTINV);\r\ncase DIVISIONBYZEROEXCEPTION:\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nClear_excp_register(exception_index);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTDIV);\r\ncase INEXACTEXCEPTION:\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nreturn SIGNALCODE(SIGFPE, FPE_FLTRES);\r\ndefault:\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nprintk("%s(%d) Unknown FPU exception 0x%x\n", __FILE__,\r\n__LINE__, Excp_type(exception_index));\r\nreturn SIGNALCODE(SIGILL, ILL_COPROC);\r\ncase NOEXCEPTION:\r\nClear_excp_register(exception_index);\r\nbreak;\r\n}\r\n}\r\nClear_tbit();\r\nupdate_trap_counts(Fpu_register, aflags, bflags, trap_counts);\r\nreturn(NOTRAP);\r\n}

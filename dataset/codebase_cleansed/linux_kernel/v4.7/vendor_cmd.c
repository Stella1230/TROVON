static int\r\nwlcore_vendor_cmd_smart_config_start(struct wiphy *wiphy,\r\nstruct wireless_dev *wdev,\r\nconst void *data, int data_len)\r\n{\r\nstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\r\nstruct wl1271 *wl = hw->priv;\r\nstruct nlattr *tb[NUM_WLCORE_VENDOR_ATTR];\r\nint ret;\r\nwl1271_debug(DEBUG_CMD, "vendor cmd smart config start");\r\nif (!data)\r\nreturn -EINVAL;\r\nret = nla_parse(tb, MAX_WLCORE_VENDOR_ATTR, data, data_len,\r\nwlcore_vendor_attr_policy);\r\nif (ret)\r\nreturn ret;\r\nif (!tb[WLCORE_VENDOR_ATTR_GROUP_ID])\r\nreturn -EINVAL;\r\nmutex_lock(&wl->mutex);\r\nif (unlikely(wl->state != WLCORE_STATE_ON)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = wl1271_ps_elp_wakeup(wl);\r\nif (ret < 0)\r\ngoto out;\r\nret = wlcore_smart_config_start(wl,\r\nnla_get_u32(tb[WLCORE_VENDOR_ATTR_GROUP_ID]));\r\nwl1271_ps_elp_sleep(wl);\r\nout:\r\nmutex_unlock(&wl->mutex);\r\nreturn 0;\r\n}\r\nstatic int\r\nwlcore_vendor_cmd_smart_config_stop(struct wiphy *wiphy,\r\nstruct wireless_dev *wdev,\r\nconst void *data, int data_len)\r\n{\r\nstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\r\nstruct wl1271 *wl = hw->priv;\r\nint ret;\r\nwl1271_debug(DEBUG_CMD, "testmode cmd smart config stop");\r\nmutex_lock(&wl->mutex);\r\nif (unlikely(wl->state != WLCORE_STATE_ON)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = wl1271_ps_elp_wakeup(wl);\r\nif (ret < 0)\r\ngoto out;\r\nret = wlcore_smart_config_stop(wl);\r\nwl1271_ps_elp_sleep(wl);\r\nout:\r\nmutex_unlock(&wl->mutex);\r\nreturn ret;\r\n}\r\nstatic int\r\nwlcore_vendor_cmd_smart_config_set_group_key(struct wiphy *wiphy,\r\nstruct wireless_dev *wdev,\r\nconst void *data, int data_len)\r\n{\r\nstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\r\nstruct wl1271 *wl = hw->priv;\r\nstruct nlattr *tb[NUM_WLCORE_VENDOR_ATTR];\r\nint ret;\r\nwl1271_debug(DEBUG_CMD, "testmode cmd smart config set group key");\r\nif (!data)\r\nreturn -EINVAL;\r\nret = nla_parse(tb, MAX_WLCORE_VENDOR_ATTR, data, data_len,\r\nwlcore_vendor_attr_policy);\r\nif (ret)\r\nreturn ret;\r\nif (!tb[WLCORE_VENDOR_ATTR_GROUP_ID] ||\r\n!tb[WLCORE_VENDOR_ATTR_GROUP_KEY])\r\nreturn -EINVAL;\r\nmutex_lock(&wl->mutex);\r\nif (unlikely(wl->state != WLCORE_STATE_ON)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = wl1271_ps_elp_wakeup(wl);\r\nif (ret < 0)\r\ngoto out;\r\nret = wlcore_smart_config_set_group_key(wl,\r\nnla_get_u32(tb[WLCORE_VENDOR_ATTR_GROUP_ID]),\r\nnla_len(tb[WLCORE_VENDOR_ATTR_GROUP_KEY]),\r\nnla_data(tb[WLCORE_VENDOR_ATTR_GROUP_KEY]));\r\nwl1271_ps_elp_sleep(wl);\r\nout:\r\nmutex_unlock(&wl->mutex);\r\nreturn ret;\r\n}\r\nvoid wlcore_set_vendor_commands(struct wiphy *wiphy)\r\n{\r\nwiphy->vendor_commands = wlcore_vendor_commands;\r\nwiphy->n_vendor_commands = ARRAY_SIZE(wlcore_vendor_commands);\r\nwiphy->vendor_events = wlcore_vendor_events;\r\nwiphy->n_vendor_events = ARRAY_SIZE(wlcore_vendor_events);\r\n}

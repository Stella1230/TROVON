static int __init ptlrpc_init(void)\r\n{\r\nint rc, cleanup_phase = 0;\r\nlustre_assert_wire_constants();\r\n#if RS_DEBUG\r\nspin_lock_init(&ptlrpc_rs_debug_lock);\r\n#endif\r\nmutex_init(&ptlrpc_all_services_mutex);\r\nmutex_init(&pinger_mutex);\r\nmutex_init(&ptlrpcd_mutex);\r\nptlrpc_init_xid();\r\nrc = req_layout_init();\r\nif (rc)\r\nreturn rc;\r\nrc = ptlrpc_hr_init();\r\nif (rc)\r\nreturn rc;\r\ncleanup_phase = 1;\r\nrc = ptlrpc_request_cache_init();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 2;\r\nrc = ptlrpc_init_portals();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 3;\r\nrc = ptlrpc_connection_init();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 4;\r\nptlrpc_put_connection_superhack = ptlrpc_connection_put;\r\nrc = ptlrpc_start_pinger();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 5;\r\nrc = ldlm_init();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 6;\r\nrc = sptlrpc_init();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 7;\r\nrc = ptlrpc_nrs_init();\r\nif (rc)\r\ngoto cleanup;\r\ncleanup_phase = 8;\r\nrc = tgt_mod_init();\r\nif (rc)\r\ngoto cleanup;\r\nreturn 0;\r\ncleanup:\r\nswitch (cleanup_phase) {\r\ncase 8:\r\nptlrpc_nrs_fini();\r\ncase 7:\r\nsptlrpc_fini();\r\ncase 6:\r\nldlm_exit();\r\ncase 5:\r\nptlrpc_stop_pinger();\r\ncase 4:\r\nptlrpc_connection_fini();\r\ncase 3:\r\nptlrpc_exit_portals();\r\ncase 2:\r\nptlrpc_request_cache_fini();\r\ncase 1:\r\nptlrpc_hr_fini();\r\nreq_layout_fini();\r\ndefault:\r\n;\r\n}\r\nreturn rc;\r\n}\r\nstatic void __exit ptlrpc_exit(void)\r\n{\r\ntgt_mod_exit();\r\nptlrpc_nrs_fini();\r\nsptlrpc_fini();\r\nldlm_exit();\r\nptlrpc_stop_pinger();\r\nptlrpc_exit_portals();\r\nptlrpc_request_cache_fini();\r\nptlrpc_hr_fini();\r\nptlrpc_connection_fini();\r\n}

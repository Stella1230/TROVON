static inline u32 stb0899_do_div(u64 n, u32 d)\r\n{\r\ndo_div(n, d);\r\nreturn n;\r\n}\r\nstatic u32 stb0899_set_srate(struct stb0899_state *state, u32 master_clk, u32 srate)\r\n{\r\nu32 tmp;\r\nu8 sfr[3];\r\ndprintk(state->verbose, FE_DEBUG, 1, "-->");\r\ntmp = stb0899_do_div((((u64)srate) << 21) + master_clk, 2 * master_clk);\r\ntmp <<= 4;\r\nsfr[0] = tmp >> 16;\r\nsfr[1] = tmp >> 8;\r\nsfr[2] = tmp;\r\nstb0899_write_regs(state, STB0899_SFRH, sfr, 3);\r\nreturn srate;\r\n}\r\nstatic long stb0899_calc_derot_time(long srate)\r\n{\r\nif (srate > 0)\r\nreturn (100000 / (srate / 1000));\r\nelse\r\nreturn 0;\r\n}\r\nlong stb0899_carr_width(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nreturn (internal->srate + (internal->srate * internal->rolloff) / 100);\r\n}\r\nstatic void stb0899_first_subrange(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nstruct stb0899_config *config = state->config;\r\nint range = 0;\r\nu32 bandwidth = 0;\r\nif (config->tuner_get_bandwidth) {\r\nstb0899_i2c_gate_ctrl(&state->frontend, 1);\r\nconfig->tuner_get_bandwidth(&state->frontend, &bandwidth);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 0);\r\nrange = bandwidth - stb0899_carr_width(state) / 2;\r\n}\r\nif (range > 0)\r\ninternal->sub_range = min(internal->srch_range, range);\r\nelse\r\ninternal->sub_range = 0;\r\ninternal->freq = params->freq;\r\ninternal->tuner_offst = 0L;\r\ninternal->sub_dir = 1;\r\n}\r\nstatic enum stb0899_status stb0899_check_tmg(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nint lock;\r\nu8 reg;\r\ns8 timing;\r\nmsleep(internal->t_derot);\r\nstb0899_write_reg(state, STB0899_RTF, 0xf2);\r\nreg = stb0899_read_reg(state, STB0899_TLIR);\r\nlock = STB0899_GETFIELD(TLIR_TMG_LOCK_IND, reg);\r\ntiming = stb0899_read_reg(state, STB0899_RTF);\r\nif (lock >= 42) {\r\nif ((lock > 48) && (abs(timing) >= 110)) {\r\ninternal->status = ANALOGCARRIER;\r\ndprintk(state->verbose, FE_DEBUG, 1, "-->ANALOG Carrier !");\r\n} else {\r\ninternal->status = TIMINGOK;\r\ndprintk(state->verbose, FE_DEBUG, 1, "------->TIMING OK !");\r\n}\r\n} else {\r\ninternal->status = NOTIMING;\r\ndprintk(state->verbose, FE_DEBUG, 1, "-->NO TIMING !");\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_search_tmg(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nshort int derot_step, derot_freq = 0, derot_limit, next_loop = 3;\r\nint index = 0;\r\nu8 cfr[2];\r\ninternal->status = NOTIMING;\r\nderot_limit = (internal->sub_range / 2L) / internal->mclk;\r\nderot_step = (params->srate / 2L) / internal->mclk;\r\nwhile ((stb0899_check_tmg(state) != TIMINGOK) && next_loop) {\r\nindex++;\r\nderot_freq += index * internal->direction * derot_step;\r\nif (abs(derot_freq) > derot_limit)\r\nnext_loop--;\r\nif (next_loop) {\r\nSTB0899_SETFIELD_VAL(CFRM, cfr[0], MSB(internal->inversion * derot_freq));\r\nSTB0899_SETFIELD_VAL(CFRL, cfr[1], LSB(internal->inversion * derot_freq));\r\nstb0899_write_regs(state, STB0899_CFRM, cfr, 2);\r\n}\r\ninternal->direction = -internal->direction;\r\n}\r\nif (internal->status == TIMINGOK) {\r\nstb0899_read_regs(state, STB0899_CFRM, cfr, 2);\r\ninternal->derot_freq = internal->inversion * MAKEWORD16(cfr[0], cfr[1]);\r\ndprintk(state->verbose, FE_DEBUG, 1, "------->TIMING OK ! Derot Freq = %d", internal->derot_freq);\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_check_carrier(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nu8 reg;\r\nmsleep(internal->t_derot);\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\nreg = stb0899_read_reg(state, STB0899_DSTATUS);\r\ndprintk(state->verbose, FE_DEBUG, 1, "--------------------> STB0899_DSTATUS=[0x%02x]", reg);\r\nif (STB0899_GETFIELD(CARRIER_FOUND, reg)) {\r\ninternal->status = CARRIEROK;\r\ndprintk(state->verbose, FE_DEBUG, 1, "-------------> CARRIEROK !");\r\n} else {\r\ninternal->status = NOCARRIER;\r\ndprintk(state->verbose, FE_DEBUG, 1, "-------------> NOCARRIER !");\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_search_carrier(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nshort int derot_freq = 0, last_derot_freq = 0, derot_limit, next_loop = 3;\r\nint index = 0;\r\nu8 cfr[2];\r\nu8 reg;\r\ninternal->status = NOCARRIER;\r\nderot_limit = (internal->sub_range / 2L) / internal->mclk;\r\nderot_freq = internal->derot_freq;\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\ndo {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Derot Freq=%d, mclk=%d", derot_freq, internal->mclk);\r\nif (stb0899_check_carrier(state) == NOCARRIER) {\r\nindex++;\r\nlast_derot_freq = derot_freq;\r\nderot_freq += index * internal->direction * internal->derot_step;\r\nif(abs(derot_freq) > derot_limit)\r\nnext_loop--;\r\nif (next_loop) {\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\nSTB0899_SETFIELD_VAL(CFRM, cfr[0], MSB(internal->inversion * derot_freq));\r\nSTB0899_SETFIELD_VAL(CFRL, cfr[1], LSB(internal->inversion * derot_freq));\r\nstb0899_write_regs(state, STB0899_CFRM, cfr, 2);\r\n}\r\n}\r\ninternal->direction = -internal->direction;\r\n} while ((internal->status != CARRIEROK) && next_loop);\r\nif (internal->status == CARRIEROK) {\r\nstb0899_read_regs(state, STB0899_CFRM, cfr, 2);\r\ninternal->derot_freq = internal->inversion * MAKEWORD16(cfr[0], cfr[1]);\r\ndprintk(state->verbose, FE_DEBUG, 1, "----> CARRIER OK !, Derot Freq=%d", internal->derot_freq);\r\n} else {\r\ninternal->derot_freq = last_derot_freq;\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_check_data(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nint lock = 0, index = 0, dataTime = 500, loop;\r\nu8 reg;\r\ninternal->status = NODATA;\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESACS, reg, 1);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nmsleep(1);\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESACS, reg, 0);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nif (params->srate <= 2000000)\r\ndataTime = 2000;\r\nelse if (params->srate <= 5000000)\r\ndataTime = 1500;\r\nelse if (params->srate <= 15000000)\r\ndataTime = 1000;\r\nelse\r\ndataTime = 500;\r\nstb0899_read_reg(state, STB0899_VSTATUS);\r\nstb0899_write_reg(state, STB0899_DSTATUS2, 0x00);\r\nwhile (1) {\r\nreg = stb0899_read_reg(state, STB0899_VSTATUS);\r\nlock = STB0899_GETFIELD(VSTATUS_LOCKEDVIT, reg);\r\nloop = STB0899_GETFIELD(VSTATUS_END_LOOPVIT, reg);\r\nif (lock || loop || (index > dataTime))\r\nbreak;\r\nindex++;\r\n}\r\nif (lock) {\r\ninternal->status = DATAOK;\r\ndprintk(state->verbose, FE_DEBUG, 1, "-----------------> DATA OK !");\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_search_data(struct stb0899_state *state)\r\n{\r\nshort int derot_freq, derot_step, derot_limit, next_loop = 3;\r\nu8 cfr[2];\r\nu8 reg;\r\nint index = 1;\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nderot_step = (params->srate / 4L) / internal->mclk;\r\nderot_limit = (internal->sub_range / 2L) / internal->mclk;\r\nderot_freq = internal->derot_freq;\r\ndo {\r\nif ((internal->status != CARRIEROK) || (stb0899_check_data(state) != DATAOK)) {\r\nderot_freq += index * internal->direction * derot_step;\r\nif (abs(derot_freq) > derot_limit)\r\nnext_loop--;\r\nif (next_loop) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Derot freq=%d, mclk=%d", derot_freq, internal->mclk);\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\nSTB0899_SETFIELD_VAL(CFRM, cfr[0], MSB(internal->inversion * derot_freq));\r\nSTB0899_SETFIELD_VAL(CFRL, cfr[1], LSB(internal->inversion * derot_freq));\r\nstb0899_write_regs(state, STB0899_CFRM, cfr, 2);\r\nstb0899_check_carrier(state);\r\nindex++;\r\n}\r\n}\r\ninternal->direction = -internal->direction;\r\n} while ((internal->status != DATAOK) && next_loop);\r\nif (internal->status == DATAOK) {\r\nstb0899_read_regs(state, STB0899_CFRM, cfr, 2);\r\nreg = stb0899_read_reg(state, STB0899_IQSWAP);\r\nif (STB0899_GETFIELD(SYM, reg))\r\ninternal->inversion = IQ_SWAP_ON;\r\nelse\r\ninternal->inversion = IQ_SWAP_OFF;\r\ninternal->derot_freq = internal->inversion * MAKEWORD16(cfr[0], cfr[1]);\r\ndprintk(state->verbose, FE_DEBUG, 1, "------> DATAOK ! Derot Freq=%d", internal->derot_freq);\r\n}\r\nreturn internal->status;\r\n}\r\nstatic enum stb0899_status stb0899_check_range(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nint range_offst, tp_freq;\r\nrange_offst = internal->srch_range / 2000;\r\ntp_freq = internal->freq - (internal->derot_freq * internal->mclk) / 1000;\r\nif ((tp_freq >= params->freq - range_offst) && (tp_freq <= params->freq + range_offst)) {\r\ninternal->status = RANGEOK;\r\ndprintk(state->verbose, FE_DEBUG, 1, "----> RANGEOK !");\r\n} else {\r\ninternal->status = OUTOFRANGE;\r\ndprintk(state->verbose, FE_DEBUG, 1, "----> OUT OF RANGE !");\r\n}\r\nreturn internal->status;\r\n}\r\nstatic void next_sub_range(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_params *params = &state->params;\r\nlong old_sub_range;\r\nif (internal->sub_dir > 0) {\r\nold_sub_range = internal->sub_range;\r\ninternal->sub_range = min((internal->srch_range / 2) -\r\n(internal->tuner_offst + internal->sub_range / 2),\r\ninternal->sub_range);\r\nif (internal->sub_range < 0)\r\ninternal->sub_range = 0;\r\ninternal->tuner_offst += (old_sub_range + internal->sub_range) / 2;\r\n}\r\ninternal->freq = params->freq + (internal->sub_dir * internal->tuner_offst) / 1000;\r\ninternal->sub_dir = -internal->sub_dir;\r\n}\r\nenum stb0899_status stb0899_dvbs_algo(struct stb0899_state *state)\r\n{\r\nstruct stb0899_params *params = &state->params;\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nu8 bclc, reg;\r\nu8 cfr[2];\r\nu8 eq_const[10];\r\ns32 clnI = 3;\r\nu32 bandwidth = 0;\r\ns32 betaTab[5][4] = {\r\n{ 37, 34, 32, 31 },\r\n{ 37, 35, 33, 31 },\r\n{ 37, 35, 33, 31 },\r\n{ 37, 36, 33, 32 },\r\n{ 37, 36, 33, 32 }\r\n};\r\ninternal->direction = 1;\r\nstb0899_set_srate(state, internal->master_clk, params->srate);\r\nif (params->srate <= 5000000) {\r\nstb0899_write_reg(state, STB0899_ACLC, 0x89);\r\nbclc = stb0899_read_reg(state, STB0899_BCLC);\r\nSTB0899_SETFIELD_VAL(BETA, bclc, 0x1c);\r\nstb0899_write_reg(state, STB0899_BCLC, bclc);\r\nclnI = 0;\r\n} else if (params->srate <= 15000000) {\r\nstb0899_write_reg(state, STB0899_ACLC, 0xc9);\r\nbclc = stb0899_read_reg(state, STB0899_BCLC);\r\nSTB0899_SETFIELD_VAL(BETA, bclc, 0x22);\r\nstb0899_write_reg(state, STB0899_BCLC, bclc);\r\nclnI = 1;\r\n} else if(params->srate <= 25000000) {\r\nstb0899_write_reg(state, STB0899_ACLC, 0x89);\r\nbclc = stb0899_read_reg(state, STB0899_BCLC);\r\nSTB0899_SETFIELD_VAL(BETA, bclc, 0x27);\r\nstb0899_write_reg(state, STB0899_BCLC, bclc);\r\nclnI = 2;\r\n} else {\r\nstb0899_write_reg(state, STB0899_ACLC, 0xc8);\r\nbclc = stb0899_read_reg(state, STB0899_BCLC);\r\nSTB0899_SETFIELD_VAL(BETA, bclc, 0x29);\r\nstb0899_write_reg(state, STB0899_BCLC, bclc);\r\nclnI = 3;\r\n}\r\ndprintk(state->verbose, FE_DEBUG, 1, "Set the timing loop to acquisition");\r\nstb0899_write_reg(state, STB0899_RTC, 0x46);\r\nstb0899_write_reg(state, STB0899_CFD, 0xee);\r\ndprintk(state->verbose, FE_DEBUG, 1, "Derot Percent=%d Srate=%d mclk=%d",\r\ninternal->derot_percent, params->srate, internal->mclk);\r\ninternal->derot_step = internal->derot_percent * (params->srate / 1000L) / internal->mclk;\r\ninternal->t_derot = stb0899_calc_derot_time(params->srate);\r\ninternal->t_data = 500;\r\ndprintk(state->verbose, FE_DEBUG, 1, "RESET stream merger");\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESRS, reg, 1);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nreg = stb0899_read_reg(state, STB0899_DEMAPVIT);\r\nSTB0899_SETFIELD_VAL(DEMAPVIT_KDIVIDER, reg, 60);\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, reg);\r\nstb0899_write_reg(state, STB0899_EQON, 0x01);\r\nstb0899_write_reg(state, STB0899_VITSYNC, 0x19);\r\nstb0899_first_subrange(state);\r\ndo {\r\ncfr[0] = cfr[1] = 0;\r\nstb0899_write_regs(state, STB0899_CFRM, cfr, 2);\r\nstb0899_write_reg(state, STB0899_RTF, 0);\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 1);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\ninternal->derot_freq = 0;\r\ninternal->status = NOAGC1;\r\nstb0899_i2c_gate_ctrl(&state->frontend, 1);\r\ndprintk(state->verbose, FE_DEBUG, 1, "Tuner set frequency");\r\nif (state->config->tuner_set_frequency)\r\nstate->config->tuner_set_frequency(&state->frontend, internal->freq);\r\nif (state->config->tuner_get_frequency)\r\nstate->config->tuner_get_frequency(&state->frontend, &internal->freq);\r\nmsleep(internal->t_agc1 + internal->t_agc2 + internal->t_derot);\r\ndprintk(state->verbose, FE_DEBUG, 1, "current derot freq=%d", internal->derot_freq);\r\ninternal->status = AGC1OK;\r\nif (config->tuner_get_bandwidth)\r\nconfig->tuner_get_bandwidth(&state->frontend, &bandwidth);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 0);\r\nif (params->srate <= bandwidth / 2)\r\nstb0899_search_tmg(state);\r\nelse\r\nstb0899_check_tmg(state);\r\nif (internal->status == TIMINGOK) {\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"TIMING OK ! Derot freq=%d, mclk=%d",\r\ninternal->derot_freq, internal->mclk);\r\nif (stb0899_search_carrier(state) == CARRIEROK) {\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"CARRIER OK ! Derot freq=%d, mclk=%d",\r\ninternal->derot_freq, internal->mclk);\r\nif (stb0899_search_data(state) == DATAOK) {\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"DATA OK ! Derot freq=%d, mclk=%d",\r\ninternal->derot_freq, internal->mclk);\r\nif (stb0899_check_range(state) == RANGEOK) {\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"RANGE OK ! derot freq=%d, mclk=%d",\r\ninternal->derot_freq, internal->mclk);\r\ninternal->freq = params->freq - ((internal->derot_freq * internal->mclk) / 1000);\r\nreg = stb0899_read_reg(state, STB0899_PLPARM);\r\ninternal->fecrate = STB0899_GETFIELD(VITCURPUN, reg);\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"freq=%d, internal resultant freq=%d",\r\nparams->freq, internal->freq);\r\ndprintk(state->verbose, FE_DEBUG, 1,\r\n"internal puncture rate=%d",\r\ninternal->fecrate);\r\n}\r\n}\r\n}\r\n}\r\nif (internal->status != RANGEOK)\r\nnext_sub_range(state);\r\n} while (internal->sub_range && internal->status != RANGEOK);\r\nstb0899_write_reg(state, STB0899_RTC, 0x33);\r\nstb0899_write_reg(state, STB0899_CFD, 0xf7);\r\nif (internal->status == RANGEOK) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "Locked & Range OK !");\r\nstb0899_write_reg(state, STB0899_EQON, 0x41);\r\nstb0899_write_reg(state, STB0899_VITSYNC, 0x39);\r\nreg = stb0899_read_reg(state, STB0899_BCLC);\r\nswitch (internal->fecrate) {\r\ncase STB0899_FEC_1_2:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 0x1a);\r\nSTB0899_SETFIELD_VAL(BETA, reg, betaTab[0][clnI]);\r\nstb0899_write_reg(state, STB0899_BCLC, reg);\r\nbreak;\r\ncase STB0899_FEC_2_3:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 44);\r\nSTB0899_SETFIELD_VAL(BETA, reg, betaTab[1][clnI]);\r\nstb0899_write_reg(state, STB0899_BCLC, reg);\r\nbreak;\r\ncase STB0899_FEC_3_4:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 60);\r\nSTB0899_SETFIELD_VAL(BETA, reg, betaTab[2][clnI]);\r\nstb0899_write_reg(state, STB0899_BCLC, reg);\r\nbreak;\r\ncase STB0899_FEC_5_6:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 75);\r\nSTB0899_SETFIELD_VAL(BETA, reg, betaTab[3][clnI]);\r\nstb0899_write_reg(state, STB0899_BCLC, reg);\r\nbreak;\r\ncase STB0899_FEC_6_7:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 88);\r\nstb0899_write_reg(state, STB0899_ACLC, 0x88);\r\nstb0899_write_reg(state, STB0899_BCLC, 0x9a);\r\nbreak;\r\ncase STB0899_FEC_7_8:\r\nstb0899_write_reg(state, STB0899_DEMAPVIT, 94);\r\nSTB0899_SETFIELD_VAL(BETA, reg, betaTab[4][clnI]);\r\nstb0899_write_reg(state, STB0899_BCLC, reg);\r\nbreak;\r\ndefault:\r\ndprintk(state->verbose, FE_DEBUG, 1, "Unsupported Puncture Rate");\r\nbreak;\r\n}\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESRS, reg, 0);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nreg = stb0899_read_reg(state, STB0899_CFD);\r\nSTB0899_SETFIELD_VAL(CFD_ON, reg, 0);\r\nstb0899_write_reg(state, STB0899_CFD, reg);\r\nstb0899_read_regs(state, STB0899_EQUAI1, eq_const, 10);\r\n}\r\nreturn internal->status;\r\n}\r\nstatic void stb0899_dvbs2_config_uwp(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nu32 uwp1, uwp2, uwp3, reg;\r\nuwp1 = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_CNTRL1);\r\nuwp2 = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_CNTRL2);\r\nuwp3 = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_CNTRL3);\r\nSTB0899_SETFIELD_VAL(UWP_ESN0_AVE, uwp1, config->esno_ave);\r\nSTB0899_SETFIELD_VAL(UWP_ESN0_QUANT, uwp1, config->esno_quant);\r\nSTB0899_SETFIELD_VAL(UWP_TH_SOF, uwp1, config->uwp_threshold_sof);\r\nSTB0899_SETFIELD_VAL(FE_COARSE_TRK, uwp2, internal->av_frame_coarse);\r\nSTB0899_SETFIELD_VAL(FE_FINE_TRK, uwp2, internal->av_frame_fine);\r\nSTB0899_SETFIELD_VAL(UWP_MISS_TH, uwp2, config->miss_threshold);\r\nSTB0899_SETFIELD_VAL(UWP_TH_ACQ, uwp3, config->uwp_threshold_acq);\r\nSTB0899_SETFIELD_VAL(UWP_TH_TRACK, uwp3, config->uwp_threshold_track);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_UWP_CNTRL1, STB0899_OFF0_UWP_CNTRL1, uwp1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_UWP_CNTRL2, STB0899_OFF0_UWP_CNTRL2, uwp2);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_UWP_CNTRL3, STB0899_OFF0_UWP_CNTRL3, uwp3);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, SOF_SRCH_TO);\r\nSTB0899_SETFIELD_VAL(SOF_SEARCH_TIMEOUT, reg, config->sof_search_timeout);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_SOF_SRCH_TO, STB0899_OFF0_SOF_SRCH_TO, reg);\r\n}\r\nstatic void stb0899_dvbs2_config_csm_auto(struct stb0899_state *state)\r\n{\r\nu32 reg;\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL1);\r\nSTB0899_SETFIELD_VAL(CSM_AUTO_PARAM, reg, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL1, STB0899_OFF0_CSM_CNTRL1, reg);\r\n}\r\nstatic long Log2Int(int number)\r\n{\r\nint i;\r\ni = 0;\r\nwhile ((1 << i) <= abs(number))\r\ni++;\r\nif (number == 0)\r\ni = 1;\r\nreturn i - 1;\r\n}\r\nstatic u32 stb0899_dvbs2_calc_srate(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nu32 dec_ratio, dec_rate, decim, remain, intval, btr_nom_freq;\r\nu32 master_clk, srate;\r\ndec_ratio = (internal->master_clk * 2) / (5 * internal->srate);\r\ndec_ratio = (dec_ratio == 0) ? 1 : dec_ratio;\r\ndec_rate = Log2Int(dec_ratio);\r\ndecim = 1 << dec_rate;\r\nmaster_clk = internal->master_clk / 1000;\r\nsrate = internal->srate / 1000;\r\nif (decim <= 4) {\r\nintval = (decim * (1 << (config->btr_nco_bits - 1))) / master_clk;\r\nremain = (decim * (1 << (config->btr_nco_bits - 1))) % master_clk;\r\n} else {\r\nintval = (1 << (config->btr_nco_bits - 1)) / (master_clk / 100) * decim / 100;\r\nremain = (decim * (1 << (config->btr_nco_bits - 1))) % master_clk;\r\n}\r\nbtr_nom_freq = (intval * srate) + ((remain * srate) / master_clk);\r\nreturn btr_nom_freq;\r\n}\r\nstatic u32 stb0899_dvbs2_calc_dev(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nu32 dec_ratio, correction, master_clk, srate;\r\ndec_ratio = (internal->master_clk * 2) / (5 * internal->srate);\r\ndec_ratio = (dec_ratio == 0) ? 1 : dec_ratio;\r\nmaster_clk = internal->master_clk / 1000;\r\nsrate = internal->srate / 1000;\r\ncorrection = (512 * master_clk) / (2 * dec_ratio * srate);\r\nreturn correction;\r\n}\r\nstatic void stb0899_dvbs2_set_srate(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nu32 dec_ratio, dec_rate, win_sel, decim, f_sym, btr_nom_freq;\r\nu32 correction, freq_adj, band_lim, decim_cntrl, reg;\r\nu8 anti_alias;\r\ndec_ratio = (internal->master_clk * 2) / (5 * internal->srate);\r\ndec_ratio = (dec_ratio == 0) ? 1 : dec_ratio;\r\ndec_rate = Log2Int(dec_ratio);\r\nwin_sel = 0;\r\nif (dec_rate >= 5)\r\nwin_sel = dec_rate - 4;\r\ndecim = (1 << dec_rate);\r\nf_sym = internal->master_clk / ((decim * internal->srate) / 1000);\r\nif (f_sym <= 2250)\r\nband_lim = 1;\r\nelse\r\nband_lim = 0;\r\ndecim_cntrl = ((win_sel << 3) & 0x18) + ((band_lim << 5) & 0x20) + (dec_rate & 0x7);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_DECIM_CNTRL, STB0899_OFF0_DECIM_CNTRL, decim_cntrl);\r\nif (f_sym <= 3450)\r\nanti_alias = 0;\r\nelse if (f_sym <= 4250)\r\nanti_alias = 1;\r\nelse\r\nanti_alias = 2;\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_ANTI_ALIAS_SEL, STB0899_OFF0_ANTI_ALIAS_SEL, anti_alias);\r\nbtr_nom_freq = stb0899_dvbs2_calc_srate(state);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_NOM_FREQ, STB0899_OFF0_BTR_NOM_FREQ, btr_nom_freq);\r\ncorrection = stb0899_dvbs2_calc_dev(state);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, BTR_CNTRL);\r\nSTB0899_SETFIELD_VAL(BTR_FREQ_CORR, reg, correction);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_CNTRL, STB0899_OFF0_BTR_CNTRL, reg);\r\nfreq_adj = internal->srate / (internal->master_clk / 4096);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_FREQ_ADJ_SCALE, STB0899_OFF0_FREQ_ADJ_SCALE, freq_adj);\r\n}\r\nstatic void stb0899_dvbs2_set_btr_loopbw(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nu32 sym_peak = 23, zeta = 707, loopbw_percent = 60;\r\ns32 dec_ratio, dec_rate, k_btr1_rshft, k_btr1, k_btr0_rshft;\r\ns32 k_btr0, k_btr2_rshft, k_direct_shift, k_indirect_shift;\r\nu32 decim, K, wn, k_direct, k_indirect;\r\nu32 reg;\r\ndec_ratio = (internal->master_clk * 2) / (5 * internal->srate);\r\ndec_ratio = (dec_ratio == 0) ? 1 : dec_ratio;\r\ndec_rate = Log2Int(dec_ratio);\r\ndecim = (1 << dec_rate);\r\nsym_peak *= 576000;\r\nK = (1 << config->btr_nco_bits) / (internal->master_clk / 1000);\r\nK *= (internal->srate / 1000000) * decim;\r\nif (K != 0) {\r\nK = sym_peak / K;\r\nwn = (4 * zeta * zeta) + 1000000;\r\nwn = (2 * (loopbw_percent * 1000) * 40 * zeta) /wn;\r\nk_indirect = (wn * wn) / K;\r\nk_indirect = k_indirect;\r\nk_direct = (2 * wn * zeta) / K;\r\nk_direct *= 100;\r\nk_direct_shift = Log2Int(k_direct) - Log2Int(10000) - 2;\r\nk_btr1_rshft = (-1 * k_direct_shift) + config->btr_gain_shift_offset;\r\nk_btr1 = k_direct / (1 << k_direct_shift);\r\nk_btr1 /= 10000;\r\nk_indirect_shift = Log2Int(k_indirect + 15) - 20 ;\r\nk_btr0_rshft = (-1 * k_indirect_shift) + config->btr_gain_shift_offset;\r\nk_btr0 = k_indirect * (1 << (-k_indirect_shift));\r\nk_btr0 /= 1000000;\r\nk_btr2_rshft = 0;\r\nif (k_btr0_rshft > 15) {\r\nk_btr2_rshft = k_btr0_rshft - 15;\r\nk_btr0_rshft = 15;\r\n}\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, BTR_LOOP_GAIN);\r\nSTB0899_SETFIELD_VAL(KBTR0_RSHFT, reg, k_btr0_rshft);\r\nSTB0899_SETFIELD_VAL(KBTR0, reg, k_btr0);\r\nSTB0899_SETFIELD_VAL(KBTR1_RSHFT, reg, k_btr1_rshft);\r\nSTB0899_SETFIELD_VAL(KBTR1, reg, k_btr1);\r\nSTB0899_SETFIELD_VAL(KBTR2_RSHFT, reg, k_btr2_rshft);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_LOOP_GAIN, STB0899_OFF0_BTR_LOOP_GAIN, reg);\r\n} else\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_LOOP_GAIN, STB0899_OFF0_BTR_LOOP_GAIN, 0xc4c4f);\r\n}\r\nstatic void stb0899_dvbs2_set_carr_freq(struct stb0899_state *state, s32 carr_freq, u32 master_clk)\r\n{\r\nstruct stb0899_config *config = state->config;\r\ns32 crl_nom_freq;\r\nu32 reg;\r\ncrl_nom_freq = (1 << config->crl_nco_bits) / master_clk;\r\ncrl_nom_freq *= carr_freq;\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_NOM_FREQ);\r\nSTB0899_SETFIELD_VAL(CRL_NOM_FREQ, reg, crl_nom_freq);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_NOM_FREQ, STB0899_OFF0_CRL_NOM_FREQ, reg);\r\n}\r\nstatic void stb0899_dvbs2_init_calc(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\ns32 steps, step_size;\r\nu32 range, reg;\r\nstb0899_dvbs2_config_uwp(state);\r\nstb0899_dvbs2_config_csm_auto(state);\r\nstb0899_dvbs2_set_srate(state);\r\nstb0899_dvbs2_set_btr_loopbw(state);\r\nif (internal->srate / 1000000 >= 15)\r\nstep_size = (1 << 17) / 5;\r\nelse if (internal->srate / 1000000 >= 10)\r\nstep_size = (1 << 17) / 7;\r\nelse if (internal->srate / 1000000 >= 5)\r\nstep_size = (1 << 17) / 10;\r\nelse\r\nstep_size = (1 << 17) / 4;\r\nrange = internal->srch_range / 1000000;\r\nsteps = (10 * range * (1 << 17)) / (step_size * (internal->srate / 1000000));\r\nsteps = (steps + 6) / 10;\r\nsteps = (steps == 0) ? 1 : steps;\r\nif (steps % 2 == 0)\r\nstb0899_dvbs2_set_carr_freq(state, internal->center_freq -\r\n(internal->step_size * (internal->srate / 20000000)),\r\n(internal->master_clk) / 1000000);\r\nelse\r\nstb0899_dvbs2_set_carr_freq(state, internal->center_freq, (internal->master_clk) / 1000000);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, ACQ_CNTRL2);\r\nSTB0899_SETFIELD_VAL(ZIGZAG, reg, 1);\r\nSTB0899_SETFIELD_VAL(NUM_STEPS, reg, steps);\r\nSTB0899_SETFIELD_VAL(FREQ_STEPSIZE, reg, step_size);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_ACQ_CNTRL2, STB0899_OFF0_ACQ_CNTRL2, reg);\r\n}\r\nstatic void stb0899_dvbs2_btr_init(struct stb0899_state *state)\r\n{\r\nu32 reg;\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, BTR_CNTRL);\r\nSTB0899_SETFIELD_VAL(INTRP_PHS_SENSE, reg, 1);\r\nSTB0899_SETFIELD_VAL(BTR_ERR_ENA, reg, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_CNTRL, STB0899_OFF0_BTR_CNTRL, reg);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_FREQ_INIT, STB0899_OFF0_BTR_FREQ_INIT, 0x10000000);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_FREQ_INIT, STB0899_OFF0_BTR_FREQ_INIT, 0x00000000);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_PHS_INIT, STB0899_OFF0_BTR_PHS_INIT, 0x10000000);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_BTR_PHS_INIT, STB0899_OFF0_BTR_PHS_INIT, 0x00000000);\r\n}\r\nstatic void stb0899_dvbs2_reacquire(struct stb0899_state *state)\r\n{\r\nu32 reg = 0;\r\nSTB0899_SETFIELD_VAL(DVBS2_RESET, reg, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_RESET_CNTRL, STB0899_OFF0_RESET_CNTRL, reg);\r\nstb0899_dvbs2_btr_init(state);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_FREQ_INIT, STB0899_OFF0_CRL_FREQ_INIT, (1 << 30));\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_FREQ_INIT, STB0899_OFF0_CRL_FREQ_INIT, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_LOOP_GAIN, STB0899_OFF0_CRL_LOOP_GAIN, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_PHS_INIT, STB0899_OFF0_CRL_PHS_INIT, (1 << 30));\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_PHS_INIT, STB0899_OFF0_CRL_PHS_INIT, 0);\r\nreg = 0;\r\nSTB0899_SETFIELD_VAL(DVBS2_RESET, reg, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_RESET_CNTRL, STB0899_OFF0_RESET_CNTRL, reg);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_ACQUIRE_TRIG, STB0899_OFF0_ACQUIRE_TRIG, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_LOCK_LOST, STB0899_OFF0_LOCK_LOST, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_EQUALIZER_INIT, STB0899_OFF0_EQUALIZER_INIT, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_EQUALIZER_INIT, STB0899_OFF0_EQUALIZER_INIT, 0);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, EQ_CNTRL);\r\nSTB0899_SETFIELD_VAL(EQ_SHIFT, reg, 0);\r\nSTB0899_SETFIELD_VAL(EQ_DISABLE_UPDATE, reg, 0);\r\nSTB0899_SETFIELD_VAL(EQ_DELAY, reg, 0x05);\r\nSTB0899_SETFIELD_VAL(EQ_ADAPT_MODE, reg, 0x01);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_EQ_CNTRL, STB0899_OFF0_EQ_CNTRL, reg);\r\nstb0899_write_reg(state, STB0899_PDELCTRL, 0x4a);\r\n}\r\nstatic enum stb0899_status stb0899_dvbs2_get_dmd_status(struct stb0899_state *state, int timeout)\r\n{\r\nint time = -10, lock = 0, uwp, csm;\r\nu32 reg;\r\ndo {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_STATUS);\r\ndprintk(state->verbose, FE_DEBUG, 1, "DMD_STATUS=[0x%02x]", reg);\r\nif (STB0899_GETFIELD(IF_AGC_LOCK, reg))\r\ndprintk(state->verbose, FE_DEBUG, 1, "------------->IF AGC LOCKED !");\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_STAT2);\r\ndprintk(state->verbose, FE_DEBUG, 1, "----------->DMD STAT2=[0x%02x]", reg);\r\nuwp = STB0899_GETFIELD(UWP_LOCK, reg);\r\ncsm = STB0899_GETFIELD(CSM_LOCK, reg);\r\nif (uwp && csm)\r\nlock = 1;\r\ntime += 10;\r\nmsleep(10);\r\n} while ((!lock) && (time <= timeout));\r\nif (lock) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "----------------> DVB-S2 LOCK !");\r\nreturn DVBS2_DEMOD_LOCK;\r\n} else {\r\nreturn DVBS2_DEMOD_NOLOCK;\r\n}\r\n}\r\nstatic int stb0899_dvbs2_get_data_lock(struct stb0899_state *state, int timeout)\r\n{\r\nint time = 0, lock = 0;\r\nu8 reg;\r\nwhile ((!lock) && (time < timeout)) {\r\nreg = stb0899_read_reg(state, STB0899_CFGPDELSTATUS1);\r\ndprintk(state->verbose, FE_DEBUG, 1, "---------> CFGPDELSTATUS=[0x%02x]", reg);\r\nlock = STB0899_GETFIELD(CFGPDELSTATUS_LOCK, reg);\r\ntime++;\r\n}\r\nreturn lock;\r\n}\r\nstatic enum stb0899_status stb0899_dvbs2_get_fec_status(struct stb0899_state *state, int timeout)\r\n{\r\nint time = 0, Locked;\r\ndo {\r\nLocked = stb0899_dvbs2_get_data_lock(state, 1);\r\ntime++;\r\nmsleep(1);\r\n} while ((!Locked) && (time < timeout));\r\nif (Locked) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "---------->DVB-S2 FEC LOCK !");\r\nreturn DVBS2_FEC_LOCK;\r\n} else {\r\nreturn DVBS2_FEC_NOLOCK;\r\n}\r\n}\r\nstatic void stb0899_dvbs2_init_csm(struct stb0899_state *state, int pilots, enum stb0899_modcod modcod)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\ns32 dvt_tbl = 1, two_pass = 0, agc_gain = 6, agc_shift = 0, loop_shift = 0, phs_diff_thr = 0x80;\r\ns32 gamma_acq, gamma_rho_acq, gamma_trk, gamma_rho_trk, lock_count_thr;\r\nu32 csm1, csm2, csm3, csm4;\r\nif (((internal->master_clk / internal->srate) <= 4) && (modcod <= 11) && (pilots == 1)) {\r\nswitch (modcod) {\r\ncase STB0899_QPSK_12:\r\ngamma_acq = 25;\r\ngamma_rho_acq = 2700;\r\ngamma_trk = 12;\r\ngamma_rho_trk = 180;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_35:\r\ngamma_acq = 38;\r\ngamma_rho_acq = 7182;\r\ngamma_trk = 14;\r\ngamma_rho_trk = 308;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_23:\r\ngamma_acq = 42;\r\ngamma_rho_acq = 9408;\r\ngamma_trk = 17;\r\ngamma_rho_trk = 476;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_34:\r\ngamma_acq = 53;\r\ngamma_rho_acq = 16642;\r\ngamma_trk = 19;\r\ngamma_rho_trk = 646;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_45:\r\ngamma_acq = 53;\r\ngamma_rho_acq = 17119;\r\ngamma_trk = 22;\r\ngamma_rho_trk = 880;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_56:\r\ngamma_acq = 55;\r\ngamma_rho_acq = 19250;\r\ngamma_trk = 23;\r\ngamma_rho_trk = 989;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_89:\r\ngamma_acq = 60;\r\ngamma_rho_acq = 24240;\r\ngamma_trk = 24;\r\ngamma_rho_trk = 1176;\r\nlock_count_thr = 8;\r\nbreak;\r\ncase STB0899_QPSK_910:\r\ngamma_acq = 66;\r\ngamma_rho_acq = 29634;\r\ngamma_trk = 24;\r\ngamma_rho_trk = 1176;\r\nlock_count_thr = 8;\r\nbreak;\r\ndefault:\r\ngamma_acq = 66;\r\ngamma_rho_acq = 29634;\r\ngamma_trk = 24;\r\ngamma_rho_trk = 1176;\r\nlock_count_thr = 8;\r\nbreak;\r\n}\r\ncsm1 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL1);\r\nSTB0899_SETFIELD_VAL(CSM_AUTO_PARAM, csm1, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL1, STB0899_OFF0_CSM_CNTRL1, csm1);\r\ncsm1 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL1);\r\ncsm2 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL2);\r\ncsm3 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL3);\r\ncsm4 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL4);\r\nSTB0899_SETFIELD_VAL(CSM_DVT_TABLE, csm1, dvt_tbl);\r\nSTB0899_SETFIELD_VAL(CSM_TWO_PASS, csm1, two_pass);\r\nSTB0899_SETFIELD_VAL(CSM_AGC_GAIN, csm1, agc_gain);\r\nSTB0899_SETFIELD_VAL(CSM_AGC_SHIFT, csm1, agc_shift);\r\nSTB0899_SETFIELD_VAL(FE_LOOP_SHIFT, csm1, loop_shift);\r\nSTB0899_SETFIELD_VAL(CSM_GAMMA_ACQ, csm2, gamma_acq);\r\nSTB0899_SETFIELD_VAL(CSM_GAMMA_RHOACQ, csm2, gamma_rho_acq);\r\nSTB0899_SETFIELD_VAL(CSM_GAMMA_TRACK, csm3, gamma_trk);\r\nSTB0899_SETFIELD_VAL(CSM_GAMMA_RHOTRACK, csm3, gamma_rho_trk);\r\nSTB0899_SETFIELD_VAL(CSM_LOCKCOUNT_THRESH, csm4, lock_count_thr);\r\nSTB0899_SETFIELD_VAL(CSM_PHASEDIFF_THRESH, csm4, phs_diff_thr);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL1, STB0899_OFF0_CSM_CNTRL1, csm1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL2, STB0899_OFF0_CSM_CNTRL2, csm2);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL3, STB0899_OFF0_CSM_CNTRL3, csm3);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL4, STB0899_OFF0_CSM_CNTRL4, csm4);\r\n}\r\n}\r\nstatic u32 stb0899_dvbs2_get_srate(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nstruct stb0899_config *config = state->config;\r\nu32 bTrNomFreq, srate, decimRate, intval1, intval2, reg;\r\nint div1, div2, rem1, rem2;\r\ndiv1 = config->btr_nco_bits / 2;\r\ndiv2 = config->btr_nco_bits - div1 - 1;\r\nbTrNomFreq = STB0899_READ_S2REG(STB0899_S2DEMOD, BTR_NOM_FREQ);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DECIM_CNTRL);\r\ndecimRate = STB0899_GETFIELD(DECIM_RATE, reg);\r\ndecimRate = (1 << decimRate);\r\nintval1 = internal->master_clk / (1 << div1);\r\nintval2 = bTrNomFreq / (1 << div2);\r\nrem1 = internal->master_clk % (1 << div1);\r\nrem2 = bTrNomFreq % (1 << div2);\r\nsrate = (intval1 * intval2) + ((intval1 * rem2) / (1 << div2)) + ((intval2 * rem1) / (1 << div1));\r\nsrate /= decimRate;\r\nreturn srate;\r\n}\r\nenum stb0899_status stb0899_dvbs2_algo(struct stb0899_state *state)\r\n{\r\nstruct stb0899_internal *internal = &state->internal;\r\nenum stb0899_modcod modcod;\r\ns32 offsetfreq, searchTime, FecLockTime, pilots, iqSpectrum;\r\nint i = 0;\r\nu32 reg, csm1;\r\nif (internal->srate <= 2000000) {\r\nsearchTime = 5000;\r\nFecLockTime = 350;\r\n} else if (internal->srate <= 5000000) {\r\nsearchTime = 2500;\r\nFecLockTime = 170;\r\n} else if (internal->srate <= 10000000) {\r\nsearchTime = 1500;\r\nFecLockTime = 80;\r\n} else if (internal->srate <= 15000000) {\r\nsearchTime = 500;\r\nFecLockTime = 50;\r\n} else if (internal->srate <= 20000000) {\r\nsearchTime = 300;\r\nFecLockTime = 30;\r\n} else if (internal->srate <= 25000000) {\r\nsearchTime = 250;\r\nFecLockTime = 25;\r\n} else {\r\nsearchTime = 150;\r\nFecLockTime = 20;\r\n}\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESRS, reg, 1);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 1);\r\nif (state->config->tuner_set_frequency)\r\nstate->config->tuner_set_frequency(&state->frontend, internal->freq);\r\nif (state->config->tuner_get_frequency)\r\nstate->config->tuner_get_frequency(&state->frontend, &internal->freq);\r\nstb0899_i2c_gate_ctrl(&state->frontend, 0);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_CNTRL);\r\nSTB0899_SETFIELD_VAL(IF_LOOP_GAIN, reg, 4);\r\nSTB0899_SETFIELD_VAL(IF_AGC_REF, reg, 32);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_IF_AGC_CNTRL, STB0899_OFF0_IF_AGC_CNTRL, reg);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_CNTRL2);\r\nSTB0899_SETFIELD_VAL(IF_AGC_DUMP_PER, reg, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_IF_AGC_CNTRL2, STB0899_OFF0_IF_AGC_CNTRL2, reg);\r\nstb0899_dvbs2_init_calc(state);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_CNTRL2);\r\nswitch (internal->inversion) {\r\ncase IQ_SWAP_OFF:\r\nSTB0899_SETFIELD_VAL(SPECTRUM_INVERT, reg, 0);\r\nbreak;\r\ncase IQ_SWAP_ON:\r\nSTB0899_SETFIELD_VAL(SPECTRUM_INVERT, reg, 1);\r\nbreak;\r\n}\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_DMD_CNTRL2, STB0899_OFF0_DMD_CNTRL2, reg);\r\nstb0899_dvbs2_reacquire(state);\r\ninternal->status = stb0899_dvbs2_get_dmd_status(state, searchTime);\r\nif (internal->status == DVBS2_DEMOD_LOCK) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "------------> DVB-S2 DEMOD LOCK !");\r\ni = 0;\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, FecLockTime);\r\nwhile ((internal->status != DVBS2_FEC_LOCK) && (i < 3)) {\r\noffsetfreq = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_FREQ);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_NOM_FREQ);\r\nSTB0899_SETFIELD_VAL(CRL_NOM_FREQ, reg, offsetfreq);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_NOM_FREQ, STB0899_OFF0_CRL_NOM_FREQ, reg);\r\nstb0899_dvbs2_reacquire(state);\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, searchTime);\r\ni++;\r\n}\r\n}\r\nif (internal->status != DVBS2_FEC_LOCK) {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_CNTRL2);\r\niqSpectrum = STB0899_GETFIELD(SPECTRUM_INVERT, reg);\r\nSTB0899_SETFIELD_VAL(SPECTRUM_INVERT, reg, !iqSpectrum);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_DMD_CNTRL2, STB0899_OFF0_DMD_CNTRL2, reg);\r\nstb0899_dvbs2_reacquire(state);\r\ninternal->status = stb0899_dvbs2_get_dmd_status(state, searchTime);\r\nif (internal->status == DVBS2_DEMOD_LOCK) {\r\ni = 0;\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, FecLockTime);\r\nwhile ((internal->status != DVBS2_FEC_LOCK) && (i < 3)) {\r\noffsetfreq = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_FREQ);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_NOM_FREQ);\r\nSTB0899_SETFIELD_VAL(CRL_NOM_FREQ, reg, offsetfreq);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CRL_NOM_FREQ, STB0899_OFF0_CRL_NOM_FREQ, reg);\r\nstb0899_dvbs2_reacquire(state);\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, searchTime);\r\ni++;\r\n}\r\n}\r\n}\r\nif (internal->status == DVBS2_FEC_LOCK) {\r\ndprintk(state->verbose, FE_DEBUG, 1, "----------------> DVB-S2 FEC Lock !");\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_STAT2);\r\nmodcod = STB0899_GETFIELD(UWP_DECODE_MOD, reg) >> 2;\r\npilots = STB0899_GETFIELD(UWP_DECODE_MOD, reg) & 0x01;\r\nif ((((10 * internal->master_clk) / (internal->srate / 10)) <= 410) &&\r\n(INRANGE(STB0899_QPSK_23, modcod, STB0899_QPSK_910)) &&\r\n(pilots == 1)) {\r\nstb0899_dvbs2_init_csm(state, pilots, modcod);\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, FecLockTime);\r\ni = 0;\r\nwhile ((internal->status != DVBS2_FEC_LOCK) && (i < 3)) {\r\ncsm1 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL1);\r\nSTB0899_SETFIELD_VAL(CSM_TWO_PASS, csm1, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL1, STB0899_OFF0_CSM_CNTRL1, csm1);\r\ncsm1 = STB0899_READ_S2REG(STB0899_S2DEMOD, CSM_CNTRL1);\r\nSTB0899_SETFIELD_VAL(CSM_TWO_PASS, csm1, 0);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_CSM_CNTRL1, STB0899_OFF0_CSM_CNTRL1, csm1);\r\ninternal->status = stb0899_dvbs2_get_fec_status(state, FecLockTime);\r\ni++;\r\n}\r\n}\r\nif ((((10 * internal->master_clk) / (internal->srate / 10)) <= 410) &&\r\n(INRANGE(STB0899_QPSK_12, modcod, STB0899_QPSK_35)) &&\r\n(pilots == 1)) {\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, EQ_CNTRL);\r\nSTB0899_SETFIELD_VAL(EQ_DISABLE_UPDATE, reg, 1);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_EQ_CNTRL, STB0899_OFF0_EQ_CNTRL, reg);\r\n}\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, EQ_CNTRL);\r\nSTB0899_SETFIELD_VAL(EQ_SHIFT, reg, 0x02);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_EQ_CNTRL, STB0899_OFF0_EQ_CNTRL, reg);\r\noffsetfreq = STB0899_READ_S2REG(STB0899_S2DEMOD, CRL_FREQ);\r\noffsetfreq = sign_extend32(offsetfreq, 29);\r\noffsetfreq = offsetfreq / ((1 << 30) / 1000);\r\noffsetfreq *= (internal->master_clk / 1000000);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, DMD_CNTRL2);\r\nif (STB0899_GETFIELD(SPECTRUM_INVERT, reg))\r\ninternal->inversion = IQ_SWAP_ON;\r\nelse\r\ninternal->inversion = IQ_SWAP_OFF;\r\ninternal->freq = internal->freq + offsetfreq;\r\ninternal->srate = stb0899_dvbs2_get_srate(state);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, UWP_STAT2);\r\ninternal->modcod = STB0899_GETFIELD(UWP_DECODE_MOD, reg) >> 2;\r\ninternal->pilots = STB0899_GETFIELD(UWP_DECODE_MOD, reg) & 0x01;\r\ninternal->frame_length = (STB0899_GETFIELD(UWP_DECODE_MOD, reg) >> 1) & 0x01;\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_CNTRL);\r\nSTB0899_SETFIELD_VAL(IF_LOOP_GAIN, reg, 3);\r\nif (INRANGE(STB0899_QPSK_12, internal->modcod, STB0899_QPSK_23))\r\nSTB0899_SETFIELD_VAL(IF_AGC_REF, reg, 16);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_IF_AGC_CNTRL, STB0899_OFF0_IF_AGC_CNTRL, reg);\r\nreg = STB0899_READ_S2REG(STB0899_S2DEMOD, IF_AGC_CNTRL2);\r\nSTB0899_SETFIELD_VAL(IF_AGC_DUMP_PER, reg, 7);\r\nstb0899_write_s2reg(state, STB0899_S2DEMOD, STB0899_BASE_IF_AGC_CNTRL2, STB0899_OFF0_IF_AGC_CNTRL2, reg);\r\n}\r\nreg = stb0899_read_reg(state, STB0899_TSTRES);\r\nSTB0899_SETFIELD_VAL(FRESRS, reg, 0);\r\nstb0899_write_reg(state, STB0899_TSTRES, reg);\r\nreturn internal->status;\r\n}

static irqreturn_t logibm_interrupt(int irq, void *dev_id)\r\n{\r\nchar dx, dy;\r\nunsigned char buttons;\r\noutb(LOGIBM_READ_X_LOW, LOGIBM_CONTROL_PORT);\r\ndx = (inb(LOGIBM_DATA_PORT) & 0xf);\r\noutb(LOGIBM_READ_X_HIGH, LOGIBM_CONTROL_PORT);\r\ndx |= (inb(LOGIBM_DATA_PORT) & 0xf) << 4;\r\noutb(LOGIBM_READ_Y_LOW, LOGIBM_CONTROL_PORT);\r\ndy = (inb(LOGIBM_DATA_PORT) & 0xf);\r\noutb(LOGIBM_READ_Y_HIGH, LOGIBM_CONTROL_PORT);\r\nbuttons = inb(LOGIBM_DATA_PORT);\r\ndy |= (buttons & 0xf) << 4;\r\nbuttons = ~buttons >> 5;\r\ninput_report_rel(logibm_dev, REL_X, dx);\r\ninput_report_rel(logibm_dev, REL_Y, dy);\r\ninput_report_key(logibm_dev, BTN_RIGHT, buttons & 1);\r\ninput_report_key(logibm_dev, BTN_MIDDLE, buttons & 2);\r\ninput_report_key(logibm_dev, BTN_LEFT, buttons & 4);\r\ninput_sync(logibm_dev);\r\noutb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int logibm_open(struct input_dev *dev)\r\n{\r\nif (request_irq(logibm_irq, logibm_interrupt, 0, "logibm", NULL)) {\r\nprintk(KERN_ERR "logibm.c: Can't allocate irq %d\n", logibm_irq);\r\nreturn -EBUSY;\r\n}\r\noutb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);\r\nreturn 0;\r\n}\r\nstatic void logibm_close(struct input_dev *dev)\r\n{\r\noutb(LOGIBM_DISABLE_IRQ, LOGIBM_CONTROL_PORT);\r\nfree_irq(logibm_irq, NULL);\r\n}\r\nstatic int __init logibm_init(void)\r\n{\r\nint err;\r\nif (!request_region(LOGIBM_BASE, LOGIBM_EXTENT, "logibm")) {\r\nprintk(KERN_ERR "logibm.c: Can't allocate ports at %#x\n", LOGIBM_BASE);\r\nreturn -EBUSY;\r\n}\r\noutb(LOGIBM_CONFIG_BYTE, LOGIBM_CONFIG_PORT);\r\noutb(LOGIBM_SIGNATURE_BYTE, LOGIBM_SIGNATURE_PORT);\r\nudelay(100);\r\nif (inb(LOGIBM_SIGNATURE_PORT) != LOGIBM_SIGNATURE_BYTE) {\r\nprintk(KERN_INFO "logibm.c: Didn't find Logitech busmouse at %#x\n", LOGIBM_BASE);\r\nerr = -ENODEV;\r\ngoto err_release_region;\r\n}\r\noutb(LOGIBM_DEFAULT_MODE, LOGIBM_CONFIG_PORT);\r\noutb(LOGIBM_DISABLE_IRQ, LOGIBM_CONTROL_PORT);\r\nlogibm_dev = input_allocate_device();\r\nif (!logibm_dev) {\r\nprintk(KERN_ERR "logibm.c: Not enough memory for input device\n");\r\nerr = -ENOMEM;\r\ngoto err_release_region;\r\n}\r\nlogibm_dev->name = "Logitech bus mouse";\r\nlogibm_dev->phys = "isa023c/input0";\r\nlogibm_dev->id.bustype = BUS_ISA;\r\nlogibm_dev->id.vendor = 0x0003;\r\nlogibm_dev->id.product = 0x0001;\r\nlogibm_dev->id.version = 0x0100;\r\nlogibm_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\nlogibm_dev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\r\nlogibm_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\nlogibm_dev->open = logibm_open;\r\nlogibm_dev->close = logibm_close;\r\nerr = input_register_device(logibm_dev);\r\nif (err)\r\ngoto err_free_dev;\r\nreturn 0;\r\nerr_free_dev:\r\ninput_free_device(logibm_dev);\r\nerr_release_region:\r\nrelease_region(LOGIBM_BASE, LOGIBM_EXTENT);\r\nreturn err;\r\n}\r\nstatic void __exit logibm_exit(void)\r\n{\r\ninput_unregister_device(logibm_dev);\r\nrelease_region(LOGIBM_BASE, LOGIBM_EXTENT);\r\n}

static void _sclp_wait_int(void)\r\n{\r\nunsigned long cr0, cr0_new, psw_mask, addr;\r\npsw_t psw_ext_save, psw_wait;\r\n__ctl_store(cr0, 0, 0);\r\ncr0_new = cr0 | 0x200;\r\n__ctl_load(cr0_new, 0, 0);\r\npsw_ext_save = S390_lowcore.external_new_psw;\r\npsw_mask = __extract_psw();\r\nS390_lowcore.external_new_psw.mask = psw_mask;\r\npsw_wait.mask = psw_mask | PSW_MASK_EXT | PSW_MASK_WAIT;\r\nS390_lowcore.ext_int_code = 0;\r\ndo {\r\nasm volatile(\r\n" larl %[addr],0f\n"\r\n" stg %[addr],%[psw_wait_addr]\n"\r\n" stg %[addr],%[psw_ext_addr]\n"\r\n" lpswe %[psw_wait]\n"\r\n"0:\n"\r\n: [addr] "=&d" (addr),\r\n[psw_wait_addr] "=Q" (psw_wait.addr),\r\n[psw_ext_addr] "=Q" (S390_lowcore.external_new_psw.addr)\r\n: [psw_wait] "Q" (psw_wait)\r\n: "cc", "memory");\r\n} while (S390_lowcore.ext_int_code != EXT_IRQ_SERVICE_SIG);\r\n__ctl_load(cr0, 0, 0);\r\nS390_lowcore.external_new_psw = psw_ext_save;\r\n}\r\nstatic int _sclp_servc(unsigned int cmd, char *sccb)\r\n{\r\nunsigned int cc;\r\ndo {\r\nasm volatile(\r\n" .insn rre,0xb2200000,%1,%2\n"\r\n" ipm %0\n"\r\n: "=d" (cc) : "d" (cmd), "a" (sccb)\r\n: "cc", "memory");\r\ncc >>= 28;\r\nif (cc == 3)\r\nreturn -EINVAL;\r\n_sclp_wait_int();\r\n} while (cc != 0);\r\nreturn (*(unsigned short *)(sccb + 6) == 0x20) ? 0 : -EIO;\r\n}\r\nstatic int _sclp_setup(int disable)\r\n{\r\nstatic unsigned char init_sccb[] = {\r\n0x00, 0x1c,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x04,\r\n0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x40,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nunsigned int *masks;\r\nint rc;\r\nmemcpy(_sclp_work_area, init_sccb, 28);\r\nmasks = (unsigned int *)(_sclp_work_area + 12);\r\nif (disable)\r\nmemset(masks, 0, 16);\r\nrc = _sclp_servc(0x00780005, _sclp_work_area);\r\nif (rc)\r\nreturn rc;\r\nhave_vt220 = masks[2] & EVTYP_VT220MSG_MASK;\r\nhave_linemode = masks[2] & EVTYP_MSG_MASK;\r\nreturn 0;\r\n}\r\nstatic void _sclp_print_lm(const char *str)\r\n{\r\nstatic unsigned char write_head[] = {\r\n0x00, 0x52,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x4a,\r\n0x02, 0x00, 0x00, 0x00,\r\n0x00, 0x44,\r\n0x00, 0x01,\r\n0xd4, 0xc4, 0xc2, 0x40,\r\n0x00, 0x00, 0x00, 0x01,\r\n0x00, 0x38,\r\n0x00, 0x01,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00,\r\n};\r\nstatic unsigned char write_mto[] = {\r\n0x00, 0x0a,\r\n0x00, 0x04,\r\n0x10, 0x00,\r\n0x00, 0x00, 0x00, 0x00\r\n};\r\nunsigned char *ptr, ch;\r\nunsigned int count;\r\nmemcpy(_sclp_work_area, write_head, sizeof(write_head));\r\nptr = _sclp_work_area + sizeof(write_head);\r\ndo {\r\nmemcpy(ptr, write_mto, sizeof(write_mto));\r\nfor (count = sizeof(write_mto); (ch = *str++) != 0; count++) {\r\nif (ch == 0x0a)\r\nbreak;\r\nptr[count] = _ascebc[ch];\r\n}\r\n*(unsigned short *) ptr = count;\r\n*(unsigned short *)(_sclp_work_area + 14) += count;\r\n*(unsigned short *)(_sclp_work_area + 8) += count;\r\n*(unsigned short *)(_sclp_work_area + 0) += count;\r\nptr += count;\r\n} while (ch != 0);\r\n_sclp_servc(0x00760005, _sclp_work_area);\r\n}\r\nstatic void _sclp_print_vt220(const char *str)\r\n{\r\nstatic unsigned char const write_head[] = {\r\n0x00, 0x0e,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x06,\r\n0x1a, 0x00, 0x00, 0x00,\r\n};\r\nsize_t len = strlen(str);\r\nif (sizeof(write_head) + len >= sizeof(_sclp_work_area))\r\nlen = sizeof(_sclp_work_area) - sizeof(write_head) - 1;\r\nmemcpy(_sclp_work_area, write_head, sizeof(write_head));\r\nmemcpy(_sclp_work_area + sizeof(write_head), str, len);\r\n_sclp_work_area[sizeof(write_head) + len] = '\n';\r\n*(unsigned short *)(_sclp_work_area + 8) += len + 1;\r\n*(unsigned short *)(_sclp_work_area + 0) += len + 1;\r\n(void)_sclp_servc(0x00760005, _sclp_work_area);\r\n}\r\nvoid _sclp_print_early(const char *str)\r\n{\r\nif (_sclp_setup(0) != 0)\r\nreturn;\r\nif (have_linemode)\r\n_sclp_print_lm(str);\r\nif (have_vt220)\r\n_sclp_print_vt220(str);\r\n_sclp_setup(1);\r\n}

static int amdgpu_atombios_dp_process_aux_ch(struct amdgpu_i2c_chan *chan,\r\nu8 *send, int send_bytes,\r\nu8 *recv, int recv_size,\r\nu8 delay, u8 *ack)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nunion aux_channel_transaction args;\r\nint index = GetIndexIntoMasterTable(COMMAND, ProcessAuxChannelTransaction);\r\nunsigned char *base;\r\nint recv_bytes;\r\nint r = 0;\r\nmemset(&args, 0, sizeof(args));\r\nmutex_lock(&chan->mutex);\r\nbase = (unsigned char *)(adev->mode_info.atom_context->scratch + 1);\r\namdgpu_atombios_copy_swap(base, send, send_bytes, true);\r\nargs.v2.lpAuxRequest = cpu_to_le16((u16)(0 + 4));\r\nargs.v2.lpDataOut = cpu_to_le16((u16)(16 + 4));\r\nargs.v2.ucDataOutLen = 0;\r\nargs.v2.ucChannelID = chan->rec.i2c_id;\r\nargs.v2.ucDelay = delay / 10;\r\nargs.v2.ucHPD_ID = chan->rec.hpd;\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n*ack = args.v2.ucReplyStatus;\r\nif (args.v2.ucReplyStatus == 1) {\r\nDRM_DEBUG_KMS("dp_aux_ch timeout\n");\r\nr = -ETIMEDOUT;\r\ngoto done;\r\n}\r\nif (args.v2.ucReplyStatus == 2) {\r\nDRM_DEBUG_KMS("dp_aux_ch flags not zero\n");\r\nr = -EIO;\r\ngoto done;\r\n}\r\nif (args.v2.ucReplyStatus == 3) {\r\nDRM_DEBUG_KMS("dp_aux_ch error\n");\r\nr = -EIO;\r\ngoto done;\r\n}\r\nrecv_bytes = args.v1.ucDataOutLen;\r\nif (recv_bytes > recv_size)\r\nrecv_bytes = recv_size;\r\nif (recv && recv_size)\r\namdgpu_atombios_copy_swap(recv, base + 16, recv_bytes, false);\r\nr = recv_bytes;\r\ndone:\r\nmutex_unlock(&chan->mutex);\r\nreturn r;\r\n}\r\nstatic ssize_t\r\namdgpu_atombios_dp_aux_transfer(struct drm_dp_aux *aux, struct drm_dp_aux_msg *msg)\r\n{\r\nstruct amdgpu_i2c_chan *chan =\r\ncontainer_of(aux, struct amdgpu_i2c_chan, aux);\r\nint ret;\r\nu8 tx_buf[20];\r\nsize_t tx_size;\r\nu8 ack, delay = 0;\r\nif (WARN_ON(msg->size > 16))\r\nreturn -E2BIG;\r\ntx_buf[0] = msg->address & 0xff;\r\ntx_buf[1] = msg->address >> 8;\r\ntx_buf[2] = (msg->request << 4) |\r\n((msg->address >> 16) & 0xf);\r\ntx_buf[3] = msg->size ? (msg->size - 1) : 0;\r\nswitch (msg->request & ~DP_AUX_I2C_MOT) {\r\ncase DP_AUX_NATIVE_WRITE:\r\ncase DP_AUX_I2C_WRITE:\r\ntx_size = HEADER_SIZE + msg->size;\r\nif (msg->size == 0)\r\ntx_buf[3] |= BARE_ADDRESS_SIZE << 4;\r\nelse\r\ntx_buf[3] |= tx_size << 4;\r\nmemcpy(tx_buf + HEADER_SIZE, msg->buffer, msg->size);\r\nret = amdgpu_atombios_dp_process_aux_ch(chan,\r\ntx_buf, tx_size, NULL, 0, delay, &ack);\r\nif (ret >= 0)\r\nret = msg->size;\r\nbreak;\r\ncase DP_AUX_NATIVE_READ:\r\ncase DP_AUX_I2C_READ:\r\ntx_size = HEADER_SIZE;\r\nif (msg->size == 0)\r\ntx_buf[3] |= BARE_ADDRESS_SIZE << 4;\r\nelse\r\ntx_buf[3] |= tx_size << 4;\r\nret = amdgpu_atombios_dp_process_aux_ch(chan,\r\ntx_buf, tx_size, msg->buffer, msg->size, delay, &ack);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (ret >= 0)\r\nmsg->reply = ack >> 4;\r\nreturn ret;\r\n}\r\nvoid amdgpu_atombios_dp_aux_init(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nint ret;\r\namdgpu_connector->ddc_bus->rec.hpd = amdgpu_connector->hpd.hpd;\r\namdgpu_connector->ddc_bus->aux.dev = amdgpu_connector->base.kdev;\r\namdgpu_connector->ddc_bus->aux.transfer = amdgpu_atombios_dp_aux_transfer;\r\nret = drm_dp_aux_register(&amdgpu_connector->ddc_bus->aux);\r\nif (!ret)\r\namdgpu_connector->ddc_bus->has_aux = true;\r\nWARN(ret, "drm_dp_aux_register_i2c_bus() failed with error %d\n", ret);\r\n}\r\nstatic void amdgpu_atombios_dp_get_adjust_train(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane_count,\r\nu8 train_set[4])\r\n{\r\nu8 v = 0;\r\nu8 p = 0;\r\nint lane;\r\nfor (lane = 0; lane < lane_count; lane++) {\r\nu8 this_v = drm_dp_get_adjust_request_voltage(link_status, lane);\r\nu8 this_p = drm_dp_get_adjust_request_pre_emphasis(link_status, lane);\r\nDRM_DEBUG_KMS("requested signal parameters: lane %d voltage %s pre_emph %s\n",\r\nlane,\r\nvoltage_names[this_v >> DP_TRAIN_VOLTAGE_SWING_SHIFT],\r\npre_emph_names[this_p >> DP_TRAIN_PRE_EMPHASIS_SHIFT]);\r\nif (this_v > v)\r\nv = this_v;\r\nif (this_p > p)\r\np = this_p;\r\n}\r\nif (v >= DP_VOLTAGE_MAX)\r\nv |= DP_TRAIN_MAX_SWING_REACHED;\r\nif (p >= DP_PRE_EMPHASIS_MAX)\r\np |= DP_TRAIN_MAX_PRE_EMPHASIS_REACHED;\r\nDRM_DEBUG_KMS("using signal parameters: voltage %s pre_emph %s\n",\r\nvoltage_names[(v & DP_TRAIN_VOLTAGE_SWING_MASK) >> DP_TRAIN_VOLTAGE_SWING_SHIFT],\r\npre_emph_names[(p & DP_TRAIN_PRE_EMPHASIS_MASK) >> DP_TRAIN_PRE_EMPHASIS_SHIFT]);\r\nfor (lane = 0; lane < 4; lane++)\r\ntrain_set[lane] = v | p;\r\n}\r\nstatic unsigned amdgpu_atombios_dp_convert_bpc_to_bpp(int bpc)\r\n{\r\nif (bpc == 0)\r\nreturn 24;\r\nelse\r\nreturn bpc * 3;\r\n}\r\nstatic int amdgpu_atombios_dp_get_dp_link_config(struct drm_connector *connector,\r\nconst u8 dpcd[DP_DPCD_SIZE],\r\nunsigned pix_clock,\r\nunsigned *dp_lanes, unsigned *dp_rate)\r\n{\r\nunsigned bpp =\r\namdgpu_atombios_dp_convert_bpc_to_bpp(amdgpu_connector_get_monitor_bpc(connector));\r\nstatic const unsigned link_rates[3] = { 162000, 270000, 540000 };\r\nunsigned max_link_rate = drm_dp_max_link_rate(dpcd);\r\nunsigned max_lane_num = drm_dp_max_lane_count(dpcd);\r\nunsigned lane_num, i, max_pix_clock;\r\nif (amdgpu_connector_encoder_get_dp_bridge_encoder_id(connector) ==\r\nENCODER_OBJECT_ID_NUTMEG) {\r\nfor (lane_num = 1; lane_num <= max_lane_num; lane_num <<= 1) {\r\nmax_pix_clock = (lane_num * 270000 * 8) / bpp;\r\nif (max_pix_clock >= pix_clock) {\r\n*dp_lanes = lane_num;\r\n*dp_rate = 270000;\r\nreturn 0;\r\n}\r\n}\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(link_rates) && link_rates[i] <= max_link_rate; i++) {\r\nfor (lane_num = 1; lane_num <= max_lane_num; lane_num <<= 1) {\r\nmax_pix_clock = (lane_num * link_rates[i] * 8) / bpp;\r\nif (max_pix_clock >= pix_clock) {\r\n*dp_lanes = lane_num;\r\n*dp_rate = link_rates[i];\r\nreturn 0;\r\n}\r\n}\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic u8 amdgpu_atombios_dp_encoder_service(struct amdgpu_device *adev,\r\nint action, int dp_clock,\r\nu8 ucconfig, u8 lane_num)\r\n{\r\nDP_ENCODER_SERVICE_PARAMETERS args;\r\nint index = GetIndexIntoMasterTable(COMMAND, DPEncoderService);\r\nmemset(&args, 0, sizeof(args));\r\nargs.ucLinkClock = dp_clock / 10;\r\nargs.ucConfig = ucconfig;\r\nargs.ucAction = action;\r\nargs.ucLaneNum = lane_num;\r\nargs.ucStatus = 0;\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\nreturn args.ucStatus;\r\n}\r\nu8 amdgpu_atombios_dp_get_sinktype(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nstruct drm_device *dev = amdgpu_connector->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nreturn amdgpu_atombios_dp_encoder_service(adev, ATOM_DP_ACTION_GET_SINK_TYPE, 0,\r\namdgpu_connector->ddc_bus->rec.i2c_id, 0);\r\n}\r\nstatic void amdgpu_atombios_dp_probe_oui(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nstruct amdgpu_connector_atom_dig *dig_connector = amdgpu_connector->con_priv;\r\nu8 buf[3];\r\nif (!(dig_connector->dpcd[DP_DOWN_STREAM_PORT_COUNT] & DP_OUI_SUPPORT))\r\nreturn;\r\nif (drm_dp_dpcd_read(&amdgpu_connector->ddc_bus->aux, DP_SINK_OUI, buf, 3) == 3)\r\nDRM_DEBUG_KMS("Sink OUI: %02hx%02hx%02hx\n",\r\nbuf[0], buf[1], buf[2]);\r\nif (drm_dp_dpcd_read(&amdgpu_connector->ddc_bus->aux, DP_BRANCH_OUI, buf, 3) == 3)\r\nDRM_DEBUG_KMS("Branch OUI: %02hx%02hx%02hx\n",\r\nbuf[0], buf[1], buf[2]);\r\n}\r\nint amdgpu_atombios_dp_get_dpcd(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nstruct amdgpu_connector_atom_dig *dig_connector = amdgpu_connector->con_priv;\r\nu8 msg[DP_DPCD_SIZE];\r\nint ret, i;\r\nfor (i = 0; i < 7; i++) {\r\nret = drm_dp_dpcd_read(&amdgpu_connector->ddc_bus->aux, DP_DPCD_REV, msg,\r\nDP_DPCD_SIZE);\r\nif (ret == DP_DPCD_SIZE) {\r\nmemcpy(dig_connector->dpcd, msg, DP_DPCD_SIZE);\r\nDRM_DEBUG_KMS("DPCD: %*ph\n", (int)sizeof(dig_connector->dpcd),\r\ndig_connector->dpcd);\r\namdgpu_atombios_dp_probe_oui(amdgpu_connector);\r\nreturn 0;\r\n}\r\n}\r\ndig_connector->dpcd[0] = 0;\r\nreturn -EINVAL;\r\n}\r\nint amdgpu_atombios_dp_get_panel_mode(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nint panel_mode = DP_PANEL_MODE_EXTERNAL_DP_MODE;\r\nu16 dp_bridge = amdgpu_connector_encoder_get_dp_bridge_encoder_id(connector);\r\nu8 tmp;\r\nif (!amdgpu_connector->con_priv)\r\nreturn panel_mode;\r\ndig_connector = amdgpu_connector->con_priv;\r\nif (dp_bridge != ENCODER_OBJECT_ID_NONE) {\r\nif (drm_dp_dpcd_readb(&amdgpu_connector->ddc_bus->aux,\r\nDP_EDP_CONFIGURATION_CAP, &tmp) == 1) {\r\nif (tmp & 1)\r\npanel_mode = DP_PANEL_MODE_INTERNAL_DP2_MODE;\r\nelse if ((dp_bridge == ENCODER_OBJECT_ID_NUTMEG) ||\r\n(dp_bridge == ENCODER_OBJECT_ID_TRAVIS))\r\npanel_mode = DP_PANEL_MODE_INTERNAL_DP1_MODE;\r\nelse\r\npanel_mode = DP_PANEL_MODE_EXTERNAL_DP_MODE;\r\n}\r\n} else if (connector->connector_type == DRM_MODE_CONNECTOR_eDP) {\r\nif (drm_dp_dpcd_readb(&amdgpu_connector->ddc_bus->aux,\r\nDP_EDP_CONFIGURATION_CAP, &tmp) == 1) {\r\nif (tmp & 1)\r\npanel_mode = DP_PANEL_MODE_INTERNAL_DP2_MODE;\r\n}\r\n}\r\nreturn panel_mode;\r\n}\r\nvoid amdgpu_atombios_dp_set_link_config(struct drm_connector *connector,\r\nconst struct drm_display_mode *mode)\r\n{\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nint ret;\r\nif (!amdgpu_connector->con_priv)\r\nreturn;\r\ndig_connector = amdgpu_connector->con_priv;\r\nif ((dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT) ||\r\n(dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_eDP)) {\r\nret = amdgpu_atombios_dp_get_dp_link_config(connector, dig_connector->dpcd,\r\nmode->clock,\r\n&dig_connector->dp_lane_count,\r\n&dig_connector->dp_clock);\r\nif (ret) {\r\ndig_connector->dp_clock = 0;\r\ndig_connector->dp_lane_count = 0;\r\n}\r\n}\r\n}\r\nint amdgpu_atombios_dp_mode_valid_helper(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nunsigned dp_lanes, dp_clock;\r\nint ret;\r\nif (!amdgpu_connector->con_priv)\r\nreturn MODE_CLOCK_HIGH;\r\ndig_connector = amdgpu_connector->con_priv;\r\nret = amdgpu_atombios_dp_get_dp_link_config(connector, dig_connector->dpcd,\r\nmode->clock, &dp_lanes, &dp_clock);\r\nif (ret)\r\nreturn MODE_CLOCK_HIGH;\r\nif ((dp_clock == 540000) &&\r\n(!amdgpu_connector_is_dp12_capable(connector)))\r\nreturn MODE_CLOCK_HIGH;\r\nreturn MODE_OK;\r\n}\r\nbool amdgpu_atombios_dp_needs_link_train(struct amdgpu_connector *amdgpu_connector)\r\n{\r\nu8 link_status[DP_LINK_STATUS_SIZE];\r\nstruct amdgpu_connector_atom_dig *dig = amdgpu_connector->con_priv;\r\nif (drm_dp_dpcd_read_link_status(&amdgpu_connector->ddc_bus->aux, link_status)\r\n<= 0)\r\nreturn false;\r\nif (drm_dp_channel_eq_ok(link_status, dig->dp_lane_count))\r\nreturn false;\r\nreturn true;\r\n}\r\nvoid amdgpu_atombios_dp_set_rx_power_state(struct drm_connector *connector,\r\nu8 power_state)\r\n{\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nif (!amdgpu_connector->con_priv)\r\nreturn;\r\ndig_connector = amdgpu_connector->con_priv;\r\nif (dig_connector->dpcd[0] >= 0x11) {\r\ndrm_dp_dpcd_writeb(&amdgpu_connector->ddc_bus->aux,\r\nDP_SET_POWER, power_state);\r\nusleep_range(1000, 2000);\r\n}\r\n}\r\nstatic void\r\namdgpu_atombios_dp_update_vs_emph(struct amdgpu_atombios_dp_link_train_info *dp_info)\r\n{\r\namdgpu_atombios_encoder_setup_dig_transmitter(dp_info->encoder,\r\nATOM_TRANSMITTER_ACTION_SETUP_VSEMPH,\r\n0, dp_info->train_set[0]);\r\ndrm_dp_dpcd_write(dp_info->aux, DP_TRAINING_LANE0_SET,\r\ndp_info->train_set, dp_info->dp_lane_count);\r\n}\r\nstatic void\r\namdgpu_atombios_dp_set_tp(struct amdgpu_atombios_dp_link_train_info *dp_info, int tp)\r\n{\r\nint rtp = 0;\r\nswitch (tp) {\r\ncase DP_TRAINING_PATTERN_1:\r\nrtp = ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN1;\r\nbreak;\r\ncase DP_TRAINING_PATTERN_2:\r\nrtp = ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN2;\r\nbreak;\r\ncase DP_TRAINING_PATTERN_3:\r\nrtp = ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN3;\r\nbreak;\r\n}\r\namdgpu_atombios_encoder_setup_dig_encoder(dp_info->encoder, rtp, 0);\r\ndrm_dp_dpcd_writeb(dp_info->aux, DP_TRAINING_PATTERN_SET, tp);\r\n}\r\nstatic int\r\namdgpu_atombios_dp_link_train_init(struct amdgpu_atombios_dp_link_train_info *dp_info)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(dp_info->encoder);\r\nstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\r\nu8 tmp;\r\namdgpu_atombios_dp_set_rx_power_state(dp_info->connector, DP_SET_POWER_D0);\r\nif (dp_info->dpcd[3] & 0x1)\r\ndrm_dp_dpcd_writeb(dp_info->aux,\r\nDP_DOWNSPREAD_CTRL, DP_SPREAD_AMP_0_5);\r\nelse\r\ndrm_dp_dpcd_writeb(dp_info->aux,\r\nDP_DOWNSPREAD_CTRL, 0);\r\nif (dig->panel_mode == DP_PANEL_MODE_INTERNAL_DP2_MODE)\r\ndrm_dp_dpcd_writeb(dp_info->aux, DP_EDP_CONFIGURATION_SET, 1);\r\ntmp = dp_info->dp_lane_count;\r\nif (drm_dp_enhanced_frame_cap(dp_info->dpcd))\r\ntmp |= DP_LANE_COUNT_ENHANCED_FRAME_EN;\r\ndrm_dp_dpcd_writeb(dp_info->aux, DP_LANE_COUNT_SET, tmp);\r\ntmp = drm_dp_link_rate_to_bw_code(dp_info->dp_clock);\r\ndrm_dp_dpcd_writeb(dp_info->aux, DP_LINK_BW_SET, tmp);\r\namdgpu_atombios_encoder_setup_dig_encoder(dp_info->encoder,\r\nATOM_ENCODER_CMD_DP_LINK_TRAINING_START, 0);\r\ndrm_dp_dpcd_writeb(dp_info->aux,\r\nDP_TRAINING_PATTERN_SET,\r\nDP_TRAINING_PATTERN_DISABLE);\r\nreturn 0;\r\n}\r\nstatic int\r\namdgpu_atombios_dp_link_train_finish(struct amdgpu_atombios_dp_link_train_info *dp_info)\r\n{\r\nudelay(400);\r\ndrm_dp_dpcd_writeb(dp_info->aux,\r\nDP_TRAINING_PATTERN_SET,\r\nDP_TRAINING_PATTERN_DISABLE);\r\namdgpu_atombios_encoder_setup_dig_encoder(dp_info->encoder,\r\nATOM_ENCODER_CMD_DP_LINK_TRAINING_COMPLETE, 0);\r\nreturn 0;\r\n}\r\nstatic int\r\namdgpu_atombios_dp_link_train_cr(struct amdgpu_atombios_dp_link_train_info *dp_info)\r\n{\r\nbool clock_recovery;\r\nu8 voltage;\r\nint i;\r\namdgpu_atombios_dp_set_tp(dp_info, DP_TRAINING_PATTERN_1);\r\nmemset(dp_info->train_set, 0, 4);\r\namdgpu_atombios_dp_update_vs_emph(dp_info);\r\nudelay(400);\r\nclock_recovery = false;\r\ndp_info->tries = 0;\r\nvoltage = 0xff;\r\nwhile (1) {\r\ndrm_dp_link_train_clock_recovery_delay(dp_info->dpcd);\r\nif (drm_dp_dpcd_read_link_status(dp_info->aux,\r\ndp_info->link_status) <= 0) {\r\nDRM_ERROR("displayport link status failed\n");\r\nbreak;\r\n}\r\nif (drm_dp_clock_recovery_ok(dp_info->link_status, dp_info->dp_lane_count)) {\r\nclock_recovery = true;\r\nbreak;\r\n}\r\nfor (i = 0; i < dp_info->dp_lane_count; i++) {\r\nif ((dp_info->train_set[i] & DP_TRAIN_MAX_SWING_REACHED) == 0)\r\nbreak;\r\n}\r\nif (i == dp_info->dp_lane_count) {\r\nDRM_ERROR("clock recovery reached max voltage\n");\r\nbreak;\r\n}\r\nif ((dp_info->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK) == voltage) {\r\n++dp_info->tries;\r\nif (dp_info->tries == 5) {\r\nDRM_ERROR("clock recovery tried 5 times\n");\r\nbreak;\r\n}\r\n} else\r\ndp_info->tries = 0;\r\nvoltage = dp_info->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK;\r\namdgpu_atombios_dp_get_adjust_train(dp_info->link_status, dp_info->dp_lane_count,\r\ndp_info->train_set);\r\namdgpu_atombios_dp_update_vs_emph(dp_info);\r\n}\r\nif (!clock_recovery) {\r\nDRM_ERROR("clock recovery failed\n");\r\nreturn -1;\r\n} else {\r\nDRM_DEBUG_KMS("clock recovery at voltage %d pre-emphasis %d\n",\r\ndp_info->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK,\r\n(dp_info->train_set[0] & DP_TRAIN_PRE_EMPHASIS_MASK) >>\r\nDP_TRAIN_PRE_EMPHASIS_SHIFT);\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\namdgpu_atombios_dp_link_train_ce(struct amdgpu_atombios_dp_link_train_info *dp_info)\r\n{\r\nbool channel_eq;\r\nif (dp_info->tp3_supported)\r\namdgpu_atombios_dp_set_tp(dp_info, DP_TRAINING_PATTERN_3);\r\nelse\r\namdgpu_atombios_dp_set_tp(dp_info, DP_TRAINING_PATTERN_2);\r\ndp_info->tries = 0;\r\nchannel_eq = false;\r\nwhile (1) {\r\ndrm_dp_link_train_channel_eq_delay(dp_info->dpcd);\r\nif (drm_dp_dpcd_read_link_status(dp_info->aux,\r\ndp_info->link_status) <= 0) {\r\nDRM_ERROR("displayport link status failed\n");\r\nbreak;\r\n}\r\nif (drm_dp_channel_eq_ok(dp_info->link_status, dp_info->dp_lane_count)) {\r\nchannel_eq = true;\r\nbreak;\r\n}\r\nif (dp_info->tries > 5) {\r\nDRM_ERROR("channel eq failed: 5 tries\n");\r\nbreak;\r\n}\r\namdgpu_atombios_dp_get_adjust_train(dp_info->link_status, dp_info->dp_lane_count,\r\ndp_info->train_set);\r\namdgpu_atombios_dp_update_vs_emph(dp_info);\r\ndp_info->tries++;\r\n}\r\nif (!channel_eq) {\r\nDRM_ERROR("channel eq failed\n");\r\nreturn -1;\r\n} else {\r\nDRM_DEBUG_KMS("channel eq at voltage %d pre-emphasis %d\n",\r\ndp_info->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK,\r\n(dp_info->train_set[0] & DP_TRAIN_PRE_EMPHASIS_MASK)\r\n>> DP_TRAIN_PRE_EMPHASIS_SHIFT);\r\nreturn 0;\r\n}\r\n}\r\nvoid amdgpu_atombios_dp_link_train(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_encoder_atom_dig *dig;\r\nstruct amdgpu_connector *amdgpu_connector;\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nstruct amdgpu_atombios_dp_link_train_info dp_info;\r\nu8 tmp;\r\nif (!amdgpu_encoder->enc_priv)\r\nreturn;\r\ndig = amdgpu_encoder->enc_priv;\r\namdgpu_connector = to_amdgpu_connector(connector);\r\nif (!amdgpu_connector->con_priv)\r\nreturn;\r\ndig_connector = amdgpu_connector->con_priv;\r\nif ((dig_connector->dp_sink_type != CONNECTOR_OBJECT_ID_DISPLAYPORT) &&\r\n(dig_connector->dp_sink_type != CONNECTOR_OBJECT_ID_eDP))\r\nreturn;\r\nif (drm_dp_dpcd_readb(&amdgpu_connector->ddc_bus->aux, DP_MAX_LANE_COUNT, &tmp)\r\n== 1) {\r\nif (tmp & DP_TPS3_SUPPORTED)\r\ndp_info.tp3_supported = true;\r\nelse\r\ndp_info.tp3_supported = false;\r\n} else {\r\ndp_info.tp3_supported = false;\r\n}\r\nmemcpy(dp_info.dpcd, dig_connector->dpcd, DP_RECEIVER_CAP_SIZE);\r\ndp_info.adev = adev;\r\ndp_info.encoder = encoder;\r\ndp_info.connector = connector;\r\ndp_info.dp_lane_count = dig_connector->dp_lane_count;\r\ndp_info.dp_clock = dig_connector->dp_clock;\r\ndp_info.aux = &amdgpu_connector->ddc_bus->aux;\r\nif (amdgpu_atombios_dp_link_train_init(&dp_info))\r\ngoto done;\r\nif (amdgpu_atombios_dp_link_train_cr(&dp_info))\r\ngoto done;\r\nif (amdgpu_atombios_dp_link_train_ce(&dp_info))\r\ngoto done;\r\ndone:\r\nif (amdgpu_atombios_dp_link_train_finish(&dp_info))\r\nreturn;\r\n}

void tty_lock(struct tty_struct *tty)\r\n{\r\nif (WARN(tty->magic != TTY_MAGIC, "L Bad %p\n", tty))\r\nreturn;\r\ntty_kref_get(tty);\r\nmutex_lock(&tty->legacy_mutex);\r\n}\r\nint tty_lock_interruptible(struct tty_struct *tty)\r\n{\r\nint ret;\r\nif (WARN(tty->magic != TTY_MAGIC, "L Bad %p\n", tty))\r\nreturn -EIO;\r\ntty_kref_get(tty);\r\nret = mutex_lock_interruptible(&tty->legacy_mutex);\r\nif (ret)\r\ntty_kref_put(tty);\r\nreturn ret;\r\n}\r\nvoid tty_unlock(struct tty_struct *tty)\r\n{\r\nif (WARN(tty->magic != TTY_MAGIC, "U Bad %p\n", tty))\r\nreturn;\r\nmutex_unlock(&tty->legacy_mutex);\r\ntty_kref_put(tty);\r\n}\r\nvoid tty_lock_slave(struct tty_struct *tty)\r\n{\r\nif (tty && tty != tty->link)\r\ntty_lock(tty);\r\n}\r\nvoid tty_unlock_slave(struct tty_struct *tty)\r\n{\r\nif (tty && tty != tty->link)\r\ntty_unlock(tty);\r\n}\r\nvoid tty_set_lock_subclass(struct tty_struct *tty)\r\n{\r\nlockdep_set_subclass(&tty->legacy_mutex, TTY_LOCK_SLAVE);\r\n}

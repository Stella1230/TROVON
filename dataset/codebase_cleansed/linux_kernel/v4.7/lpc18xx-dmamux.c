static void lpc18xx_dmamux_free(struct device *dev, void *route_data)\r\n{\r\nstruct lpc18xx_dmamux_data *dmamux = dev_get_drvdata(dev);\r\nstruct lpc18xx_dmamux *mux = route_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dmamux->lock, flags);\r\nmux->busy = false;\r\nspin_unlock_irqrestore(&dmamux->lock, flags);\r\n}\r\nstatic void *lpc18xx_dmamux_reserve(struct of_phandle_args *dma_spec,\r\nstruct of_dma *ofdma)\r\n{\r\nstruct platform_device *pdev = of_find_device_by_node(ofdma->of_node);\r\nstruct lpc18xx_dmamux_data *dmamux = platform_get_drvdata(pdev);\r\nunsigned long flags;\r\nunsigned mux;\r\nif (dma_spec->args_count != 3) {\r\ndev_err(&pdev->dev, "invalid number of dma mux args\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nmux = dma_spec->args[0];\r\nif (mux >= dmamux->dma_master_requests) {\r\ndev_err(&pdev->dev, "invalid mux number: %d\n",\r\ndma_spec->args[0]);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (dma_spec->args[1] > LPC18XX_DMAMUX_MAX_VAL) {\r\ndev_err(&pdev->dev, "invalid dma mux value: %d\n",\r\ndma_spec->args[1]);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ndma_spec->np = of_parse_phandle(ofdma->of_node, "dma-masters", 0);\r\nif (!dma_spec->np) {\r\ndev_err(&pdev->dev, "can't get dma master\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nspin_lock_irqsave(&dmamux->lock, flags);\r\nif (dmamux->muxes[mux].busy) {\r\nspin_unlock_irqrestore(&dmamux->lock, flags);\r\ndev_err(&pdev->dev, "dma request %u busy with %u.%u\n",\r\nmux, mux, dmamux->muxes[mux].value);\r\nof_node_put(dma_spec->np);\r\nreturn ERR_PTR(-EBUSY);\r\n}\r\ndmamux->muxes[mux].busy = true;\r\ndmamux->muxes[mux].value = dma_spec->args[1];\r\nregmap_update_bits(dmamux->reg, LPC18XX_CREG_DMAMUX,\r\nLPC18XX_DMAMUX_MASK(mux),\r\nLPC18XX_DMAMUX_VAL(dmamux->muxes[mux].value, mux));\r\nspin_unlock_irqrestore(&dmamux->lock, flags);\r\ndma_spec->args[1] = dma_spec->args[2];\r\ndma_spec->args_count = 2;\r\ndev_dbg(&pdev->dev, "mapping dmamux %u.%u to dma request %u\n", mux,\r\ndmamux->muxes[mux].value, mux);\r\nreturn &dmamux->muxes[mux];\r\n}\r\nstatic int lpc18xx_dmamux_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *dma_np, *np = pdev->dev.of_node;\r\nstruct lpc18xx_dmamux_data *dmamux;\r\nint ret;\r\ndmamux = devm_kzalloc(&pdev->dev, sizeof(*dmamux), GFP_KERNEL);\r\nif (!dmamux)\r\nreturn -ENOMEM;\r\ndmamux->reg = syscon_regmap_lookup_by_compatible("nxp,lpc1850-creg");\r\nif (IS_ERR(dmamux->reg)) {\r\ndev_err(&pdev->dev, "syscon lookup failed\n");\r\nreturn PTR_ERR(dmamux->reg);\r\n}\r\nret = of_property_read_u32(np, "dma-requests",\r\n&dmamux->dma_mux_requests);\r\nif (ret) {\r\ndev_err(&pdev->dev, "missing dma-requests property\n");\r\nreturn ret;\r\n}\r\ndma_np = of_parse_phandle(np, "dma-masters", 0);\r\nif (!dma_np) {\r\ndev_err(&pdev->dev, "can't get dma master\n");\r\nreturn -ENODEV;\r\n}\r\nret = of_property_read_u32(dma_np, "dma-requests",\r\n&dmamux->dma_master_requests);\r\nof_node_put(dma_np);\r\nif (ret) {\r\ndev_err(&pdev->dev, "missing master dma-requests property\n");\r\nreturn ret;\r\n}\r\ndmamux->muxes = devm_kcalloc(&pdev->dev, dmamux->dma_master_requests,\r\nsizeof(struct lpc18xx_dmamux),\r\nGFP_KERNEL);\r\nif (!dmamux->muxes)\r\nreturn -ENOMEM;\r\nspin_lock_init(&dmamux->lock);\r\nplatform_set_drvdata(pdev, dmamux);\r\ndmamux->dmarouter.dev = &pdev->dev;\r\ndmamux->dmarouter.route_free = lpc18xx_dmamux_free;\r\nreturn of_dma_router_register(np, lpc18xx_dmamux_reserve,\r\n&dmamux->dmarouter);\r\n}\r\nstatic int __init lpc18xx_dmamux_init(void)\r\n{\r\nreturn platform_driver_register(&lpc18xx_dmamux_driver);\r\n}

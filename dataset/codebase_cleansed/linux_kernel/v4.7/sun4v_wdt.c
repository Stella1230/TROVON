static int sun4v_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nsun4v_mach_set_watchdog(0, NULL);\r\nreturn 0;\r\n}\r\nstatic int sun4v_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nint hverr;\r\nhverr = sun4v_mach_set_watchdog(wdd->timeout * 1000, NULL);\r\nif (hverr == HV_EINVAL)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int sun4v_wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int timeout)\r\n{\r\nwdd->timeout = timeout;\r\nreturn 0;\r\n}\r\nstatic int __init sun4v_wdt_init(void)\r\n{\r\nstruct mdesc_handle *handle;\r\nu64 node;\r\nconst u64 *value;\r\nint err = 0;\r\nunsigned long major = 1, minor = 1;\r\nhandle = mdesc_grab();\r\nif (!handle)\r\nreturn -ENODEV;\r\nnode = mdesc_node_by_name(handle, MDESC_NODE_NULL, "platform");\r\nerr = -ENODEV;\r\nif (node == MDESC_NODE_NULL)\r\ngoto out_release;\r\nif (sun4v_hvapi_register(HV_GRP_CORE, major, &minor))\r\ngoto out_hv_unreg;\r\nvalue = mdesc_get_property(handle, node, "watchdog-resolution", NULL);\r\nerr = -EINVAL;\r\nif (value) {\r\nif (*value == 0 ||\r\n*value > WDT_DEFAULT_RESOLUTION_MS)\r\ngoto out_hv_unreg;\r\n}\r\nvalue = mdesc_get_property(handle, node, "watchdog-max-timeout", NULL);\r\nif (value) {\r\nif (*value < wdd.min_timeout * 1000)\r\ngoto out_hv_unreg;\r\nif (*value < wdd.max_timeout * 1000)\r\nwdd.max_timeout = *value / 1000;\r\n}\r\nwatchdog_init_timeout(&wdd, timeout, NULL);\r\nwatchdog_set_nowayout(&wdd, nowayout);\r\nerr = watchdog_register_device(&wdd);\r\nif (err)\r\ngoto out_hv_unreg;\r\npr_info("initialized (timeout=%ds, nowayout=%d)\n",\r\nwdd.timeout, nowayout);\r\nmdesc_release(handle);\r\nreturn 0;\r\nout_hv_unreg:\r\nsun4v_hvapi_unregister(HV_GRP_CORE);\r\nout_release:\r\nmdesc_release(handle);\r\nreturn err;\r\n}\r\nstatic void __exit sun4v_wdt_exit(void)\r\n{\r\nsun4v_hvapi_unregister(HV_GRP_CORE);\r\nwatchdog_unregister_device(&wdd);\r\n}

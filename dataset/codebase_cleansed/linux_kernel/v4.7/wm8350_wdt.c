static int wm8350_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\r\nint ret, i;\r\nu16 reg;\r\nfor (i = 0; i < ARRAY_SIZE(wm8350_wdt_cfgs); i++)\r\nif (wm8350_wdt_cfgs[i].time == timeout)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm8350_wdt_cfgs))\r\nreturn -EINVAL;\r\nmutex_lock(&wdt_mutex);\r\nwm8350_reg_unlock(wm8350);\r\nreg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\r\nreg &= ~WM8350_WDOG_TO_MASK;\r\nreg |= wm8350_wdt_cfgs[i].val;\r\nret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\r\nwm8350_reg_lock(wm8350);\r\nmutex_unlock(&wdt_mutex);\r\nwdt_dev->timeout = timeout;\r\nreturn ret;\r\n}\r\nstatic int wm8350_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\r\nint ret;\r\nu16 reg;\r\nmutex_lock(&wdt_mutex);\r\nwm8350_reg_unlock(wm8350);\r\nreg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\r\nreg &= ~WM8350_WDOG_MODE_MASK;\r\nreg |= 0x20;\r\nret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\r\nwm8350_reg_lock(wm8350);\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm8350_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\r\nint ret;\r\nu16 reg;\r\nmutex_lock(&wdt_mutex);\r\nwm8350_reg_unlock(wm8350);\r\nreg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\r\nreg &= ~WM8350_WDOG_MODE_MASK;\r\nret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\r\nwm8350_reg_lock(wm8350);\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm8350_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\r\nint ret;\r\nu16 reg;\r\nmutex_lock(&wdt_mutex);\r\nreg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\r\nret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm8350_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\r\nif (!wm8350) {\r\npr_err("No driver data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nwatchdog_set_nowayout(&wm8350_wdt, nowayout);\r\nwatchdog_set_drvdata(&wm8350_wdt, wm8350);\r\nwm8350_wdt.parent = &pdev->dev;\r\nwm8350_wdt_set_timeout(&wm8350_wdt, 4);\r\nreturn watchdog_register_device(&wm8350_wdt);\r\n}\r\nstatic int wm8350_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&wm8350_wdt);\r\nreturn 0;\r\n}

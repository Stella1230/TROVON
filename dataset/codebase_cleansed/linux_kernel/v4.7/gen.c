static int rsnd_is_accessible_reg(struct rsnd_priv *priv,\r\nstruct rsnd_gen *gen, enum rsnd_reg reg)\r\n{\r\nif (!gen->regs[reg]) {\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\ndev_err(dev, "unsupported register access %x\n", reg);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nu32 rsnd_read(struct rsnd_priv *priv,\r\nstruct rsnd_mod *mod, enum rsnd_reg reg)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nu32 val;\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn 0;\r\nregmap_fields_read(gen->regs[reg], rsnd_mod_id(mod), &val);\r\ndev_dbg(dev, "r %s[%d] - %-18s (%4d) : %08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod),\r\nrsnd_reg_name(gen, reg), reg, val);\r\nreturn val;\r\n}\r\nvoid rsnd_write(struct rsnd_priv *priv,\r\nstruct rsnd_mod *mod,\r\nenum rsnd_reg reg, u32 data)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn;\r\nregmap_fields_force_write(gen->regs[reg], rsnd_mod_id(mod), data);\r\ndev_dbg(dev, "w %s[%d] - %-18s (%4d) : %08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod),\r\nrsnd_reg_name(gen, reg), reg, data);\r\n}\r\nvoid rsnd_bset(struct rsnd_priv *priv, struct rsnd_mod *mod,\r\nenum rsnd_reg reg, u32 mask, u32 data)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn;\r\nregmap_fields_force_update_bits(gen->regs[reg],\r\nrsnd_mod_id(mod), mask, data);\r\ndev_dbg(dev, "b %s[%d] - %-18s (%4d) : %08x/%08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod),\r\nrsnd_reg_name(gen, reg), reg, data, mask);\r\n}\r\nphys_addr_t rsnd_gen_get_phy_addr(struct rsnd_priv *priv, int reg_id)\r\n{\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nreturn gen->res[reg_id];\r\n}\r\nstatic int _rsnd_gen_regmap_init(struct rsnd_priv *priv,\r\nint id_size,\r\nint reg_id,\r\nconst char *name,\r\nconst struct rsnd_regmap_field_conf *conf,\r\nint conf_size)\r\n{\r\nstruct platform_device *pdev = rsnd_priv_to_pdev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct resource *res;\r\nstruct regmap_config regc;\r\nstruct regmap_field *regs;\r\nstruct regmap *regmap;\r\nstruct reg_field regf;\r\nvoid __iomem *base;\r\nint i;\r\nmemset(&regc, 0, sizeof(regc));\r\nregc.reg_bits = 32;\r\nregc.val_bits = 32;\r\nregc.reg_stride = 4;\r\nregc.name = name;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, name);\r\nif (!res)\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, reg_id);\r\nif (!res)\r\nreturn -ENODEV;\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nregmap = devm_regmap_init_mmio(dev, base, &regc);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\ngen->base[reg_id] = base;\r\ngen->regmap[reg_id] = regmap;\r\ngen->res[reg_id] = res->start;\r\nfor (i = 0; i < conf_size; i++) {\r\nregf.reg = conf[i].reg_offset;\r\nregf.id_offset = conf[i].id_offset;\r\nregf.lsb = 0;\r\nregf.msb = 31;\r\nregf.id_size = id_size;\r\nregs = devm_regmap_field_alloc(dev, regmap, regf);\r\nif (IS_ERR(regs))\r\nreturn PTR_ERR(regs);\r\ngen->regs[conf[i].idx] = regs;\r\ngen->reg_name[conf[i].idx] = conf[i].reg_name;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rsnd_gen2_probe(struct rsnd_priv *priv)\r\n{\r\nconst static struct rsnd_regmap_field_conf conf_ssiu[] = {\r\nRSND_GEN_S_REG(SSI_MODE0, 0x800),\r\nRSND_GEN_S_REG(SSI_MODE1, 0x804),\r\nRSND_GEN_S_REG(SSI_MODE2, 0x808),\r\nRSND_GEN_S_REG(SSI_CONTROL, 0x810),\r\nRSND_GEN_M_REG(SSI_BUSIF_MODE, 0x0, 0x80),\r\nRSND_GEN_M_REG(SSI_BUSIF_ADINR, 0x4, 0x80),\r\nRSND_GEN_M_REG(SSI_BUSIF_DALIGN,0x8, 0x80),\r\nRSND_GEN_M_REG(SSI_MODE, 0xc, 0x80),\r\nRSND_GEN_M_REG(SSI_CTRL, 0x10, 0x80),\r\nRSND_GEN_M_REG(SSI_INT_ENABLE, 0x18, 0x80),\r\n};\r\nconst static struct rsnd_regmap_field_conf conf_scu[] = {\r\nRSND_GEN_M_REG(SRC_I_BUSIF_MODE,0x0, 0x20),\r\nRSND_GEN_M_REG(SRC_O_BUSIF_MODE,0x4, 0x20),\r\nRSND_GEN_M_REG(SRC_BUSIF_DALIGN,0x8, 0x20),\r\nRSND_GEN_M_REG(SRC_ROUTE_MODE0, 0xc, 0x20),\r\nRSND_GEN_M_REG(SRC_CTRL, 0x10, 0x20),\r\nRSND_GEN_M_REG(SRC_INT_ENABLE0, 0x18, 0x20),\r\nRSND_GEN_M_REG(CMD_BUSIF_DALIGN,0x188, 0x20),\r\nRSND_GEN_M_REG(CMD_ROUTE_SLCT, 0x18c, 0x20),\r\nRSND_GEN_M_REG(CMD_CTRL, 0x190, 0x20),\r\nRSND_GEN_S_REG(SCU_SYS_STATUS0, 0x1c8),\r\nRSND_GEN_S_REG(SCU_SYS_INT_EN0, 0x1cc),\r\nRSND_GEN_S_REG(SCU_SYS_STATUS1, 0x1d0),\r\nRSND_GEN_S_REG(SCU_SYS_INT_EN1, 0x1d4),\r\nRSND_GEN_M_REG(SRC_SWRSR, 0x200, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCIR, 0x204, 0x40),\r\nRSND_GEN_M_REG(SRC_ADINR, 0x214, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSCR, 0x21c, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSVR, 0x220, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCCR, 0x224, 0x40),\r\nRSND_GEN_M_REG(SRC_BSDSR, 0x22c, 0x40),\r\nRSND_GEN_M_REG(SRC_BSISR, 0x238, 0x40),\r\nRSND_GEN_M_REG(CTU_SWRSR, 0x500, 0x100),\r\nRSND_GEN_M_REG(CTU_CTUIR, 0x504, 0x100),\r\nRSND_GEN_M_REG(CTU_ADINR, 0x508, 0x100),\r\nRSND_GEN_M_REG(CTU_CPMDR, 0x510, 0x100),\r\nRSND_GEN_M_REG(CTU_SCMDR, 0x514, 0x100),\r\nRSND_GEN_M_REG(CTU_SV00R, 0x518, 0x100),\r\nRSND_GEN_M_REG(CTU_SV01R, 0x51c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV02R, 0x520, 0x100),\r\nRSND_GEN_M_REG(CTU_SV03R, 0x524, 0x100),\r\nRSND_GEN_M_REG(CTU_SV04R, 0x528, 0x100),\r\nRSND_GEN_M_REG(CTU_SV05R, 0x52c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV06R, 0x530, 0x100),\r\nRSND_GEN_M_REG(CTU_SV07R, 0x534, 0x100),\r\nRSND_GEN_M_REG(CTU_SV10R, 0x538, 0x100),\r\nRSND_GEN_M_REG(CTU_SV11R, 0x53c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV12R, 0x540, 0x100),\r\nRSND_GEN_M_REG(CTU_SV13R, 0x544, 0x100),\r\nRSND_GEN_M_REG(CTU_SV14R, 0x548, 0x100),\r\nRSND_GEN_M_REG(CTU_SV15R, 0x54c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV16R, 0x550, 0x100),\r\nRSND_GEN_M_REG(CTU_SV17R, 0x554, 0x100),\r\nRSND_GEN_M_REG(CTU_SV20R, 0x558, 0x100),\r\nRSND_GEN_M_REG(CTU_SV21R, 0x55c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV22R, 0x560, 0x100),\r\nRSND_GEN_M_REG(CTU_SV23R, 0x564, 0x100),\r\nRSND_GEN_M_REG(CTU_SV24R, 0x568, 0x100),\r\nRSND_GEN_M_REG(CTU_SV25R, 0x56c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV26R, 0x570, 0x100),\r\nRSND_GEN_M_REG(CTU_SV27R, 0x574, 0x100),\r\nRSND_GEN_M_REG(CTU_SV30R, 0x578, 0x100),\r\nRSND_GEN_M_REG(CTU_SV31R, 0x57c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV32R, 0x580, 0x100),\r\nRSND_GEN_M_REG(CTU_SV33R, 0x584, 0x100),\r\nRSND_GEN_M_REG(CTU_SV34R, 0x588, 0x100),\r\nRSND_GEN_M_REG(CTU_SV35R, 0x58c, 0x100),\r\nRSND_GEN_M_REG(CTU_SV36R, 0x590, 0x100),\r\nRSND_GEN_M_REG(CTU_SV37R, 0x594, 0x100),\r\nRSND_GEN_M_REG(MIX_SWRSR, 0xd00, 0x40),\r\nRSND_GEN_M_REG(MIX_MIXIR, 0xd04, 0x40),\r\nRSND_GEN_M_REG(MIX_ADINR, 0xd08, 0x40),\r\nRSND_GEN_M_REG(MIX_MIXMR, 0xd10, 0x40),\r\nRSND_GEN_M_REG(MIX_MVPDR, 0xd14, 0x40),\r\nRSND_GEN_M_REG(MIX_MDBAR, 0xd18, 0x40),\r\nRSND_GEN_M_REG(MIX_MDBBR, 0xd1c, 0x40),\r\nRSND_GEN_M_REG(MIX_MDBCR, 0xd20, 0x40),\r\nRSND_GEN_M_REG(MIX_MDBDR, 0xd24, 0x40),\r\nRSND_GEN_M_REG(MIX_MDBER, 0xd28, 0x40),\r\nRSND_GEN_M_REG(DVC_SWRSR, 0xe00, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUIR, 0xe04, 0x100),\r\nRSND_GEN_M_REG(DVC_ADINR, 0xe08, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUCR, 0xe10, 0x100),\r\nRSND_GEN_M_REG(DVC_ZCMCR, 0xe14, 0x100),\r\nRSND_GEN_M_REG(DVC_VRCTR, 0xe18, 0x100),\r\nRSND_GEN_M_REG(DVC_VRPDR, 0xe1c, 0x100),\r\nRSND_GEN_M_REG(DVC_VRDBR, 0xe20, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL0R, 0xe28, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL1R, 0xe2c, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL2R, 0xe30, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL3R, 0xe34, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL4R, 0xe38, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL5R, 0xe3c, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL6R, 0xe40, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL7R, 0xe44, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUER, 0xe48, 0x100),\r\n};\r\nconst static struct rsnd_regmap_field_conf conf_adg[] = {\r\nRSND_GEN_S_REG(BRRA, 0x00),\r\nRSND_GEN_S_REG(BRRB, 0x04),\r\nRSND_GEN_S_REG(SSICKR, 0x08),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL0, 0x0c),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL1, 0x10),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL2, 0x14),\r\nRSND_GEN_S_REG(DIV_EN, 0x30),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL0, 0x34),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL1, 0x38),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL2, 0x3c),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL3, 0x40),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL4, 0x44),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL0, 0x48),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL1, 0x4c),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL2, 0x50),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL3, 0x54),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL4, 0x58),\r\nRSND_GEN_S_REG(CMDOUT_TIMSEL, 0x5c),\r\n};\r\nconst static struct rsnd_regmap_field_conf conf_ssi[] = {\r\nRSND_GEN_M_REG(SSICR, 0x00, 0x40),\r\nRSND_GEN_M_REG(SSISR, 0x04, 0x40),\r\nRSND_GEN_M_REG(SSITDR, 0x08, 0x40),\r\nRSND_GEN_M_REG(SSIRDR, 0x0c, 0x40),\r\nRSND_GEN_M_REG(SSIWSR, 0x20, 0x40),\r\n};\r\nint ret_ssiu;\r\nint ret_scu;\r\nint ret_adg;\r\nint ret_ssi;\r\nret_ssiu = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SSIU, "ssiu", conf_ssiu);\r\nret_scu = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SCU, "scu", conf_scu);\r\nret_adg = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_ADG, "adg", conf_adg);\r\nret_ssi = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SSI, "ssi", conf_ssi);\r\nif (ret_ssiu < 0 ||\r\nret_scu < 0 ||\r\nret_adg < 0 ||\r\nret_ssi < 0)\r\nreturn ret_ssiu | ret_scu | ret_adg | ret_ssi;\r\nreturn 0;\r\n}\r\nstatic int rsnd_gen1_probe(struct rsnd_priv *priv)\r\n{\r\nconst static struct rsnd_regmap_field_conf conf_adg[] = {\r\nRSND_GEN_S_REG(BRRA, 0x00),\r\nRSND_GEN_S_REG(BRRB, 0x04),\r\nRSND_GEN_S_REG(SSICKR, 0x08),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL0, 0x0c),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL1, 0x10),\r\n};\r\nconst static struct rsnd_regmap_field_conf conf_ssi[] = {\r\nRSND_GEN_M_REG(SSICR, 0x00, 0x40),\r\nRSND_GEN_M_REG(SSISR, 0x04, 0x40),\r\nRSND_GEN_M_REG(SSITDR, 0x08, 0x40),\r\nRSND_GEN_M_REG(SSIRDR, 0x0c, 0x40),\r\nRSND_GEN_M_REG(SSIWSR, 0x20, 0x40),\r\n};\r\nint ret_adg;\r\nint ret_ssi;\r\nret_adg = rsnd_gen_regmap_init(priv, 9, RSND_GEN1_ADG, "adg", conf_adg);\r\nret_ssi = rsnd_gen_regmap_init(priv, 9, RSND_GEN1_SSI, "ssi", conf_ssi);\r\nif (ret_adg < 0 ||\r\nret_ssi < 0)\r\nreturn ret_adg | ret_ssi;\r\nreturn 0;\r\n}\r\nint rsnd_gen_probe(struct rsnd_priv *priv)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen;\r\nint ret;\r\ngen = devm_kzalloc(dev, sizeof(*gen), GFP_KERNEL);\r\nif (!gen) {\r\ndev_err(dev, "GEN allocate failed\n");\r\nreturn -ENOMEM;\r\n}\r\npriv->gen = gen;\r\nret = -ENODEV;\r\nif (rsnd_is_gen1(priv))\r\nret = rsnd_gen1_probe(priv);\r\nelse if (rsnd_is_gen2(priv))\r\nret = rsnd_gen2_probe(priv);\r\nif (ret < 0)\r\ndev_err(dev, "unknown generation R-Car sound device\n");\r\nreturn ret;\r\n}

static int intel_hid_set_enable(struct device *device, int enable)\r\n{\r\nunion acpi_object arg0 = { ACPI_TYPE_INTEGER };\r\nstruct acpi_object_list args = { 1, &arg0 };\r\nacpi_status status;\r\narg0.integer.value = enable;\r\nstatus = acpi_evaluate_object(ACPI_HANDLE(device), "HDSM", &args, NULL);\r\nif (!ACPI_SUCCESS(status)) {\r\ndev_warn(device, "failed to %sable hotkeys\n",\r\nenable ? "en" : "dis");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int intel_hid_pl_suspend_handler(struct device *device)\r\n{\r\nintel_hid_set_enable(device, 0);\r\nreturn 0;\r\n}\r\nstatic int intel_hid_pl_resume_handler(struct device *device)\r\n{\r\nintel_hid_set_enable(device, 1);\r\nreturn 0;\r\n}\r\nstatic int intel_hid_input_setup(struct platform_device *device)\r\n{\r\nstruct intel_hid_priv *priv = dev_get_drvdata(&device->dev);\r\nint ret;\r\npriv->input_dev = input_allocate_device();\r\nif (!priv->input_dev)\r\nreturn -ENOMEM;\r\nret = sparse_keymap_setup(priv->input_dev, intel_hid_keymap, NULL);\r\nif (ret)\r\ngoto err_free_device;\r\npriv->input_dev->dev.parent = &device->dev;\r\npriv->input_dev->name = "Intel HID events";\r\npriv->input_dev->id.bustype = BUS_HOST;\r\nset_bit(KEY_RFKILL, priv->input_dev->keybit);\r\nret = input_register_device(priv->input_dev);\r\nif (ret)\r\ngoto err_free_device;\r\nreturn 0;\r\nerr_free_device:\r\ninput_free_device(priv->input_dev);\r\nreturn ret;\r\n}\r\nstatic void intel_hid_input_destroy(struct platform_device *device)\r\n{\r\nstruct intel_hid_priv *priv = dev_get_drvdata(&device->dev);\r\ninput_unregister_device(priv->input_dev);\r\n}\r\nstatic void notify_handler(acpi_handle handle, u32 event, void *context)\r\n{\r\nstruct platform_device *device = context;\r\nstruct intel_hid_priv *priv = dev_get_drvdata(&device->dev);\r\nunsigned long long ev_index;\r\nacpi_status status;\r\nif (event != 0xc0) {\r\ndev_warn(&device->dev, "received unknown event (0x%x)\n",\r\nevent);\r\nreturn;\r\n}\r\nstatus = acpi_evaluate_integer(handle, "HDEM", NULL, &ev_index);\r\nif (!ACPI_SUCCESS(status)) {\r\ndev_warn(&device->dev, "failed to get event index\n");\r\nreturn;\r\n}\r\nif (!sparse_keymap_report_event(priv->input_dev, ev_index, 1, true))\r\ndev_info(&device->dev, "unknown event index 0x%llx\n",\r\nev_index);\r\n}\r\nstatic int intel_hid_probe(struct platform_device *device)\r\n{\r\nacpi_handle handle = ACPI_HANDLE(&device->dev);\r\nstruct intel_hid_priv *priv;\r\nunsigned long long mode;\r\nacpi_status status;\r\nint err;\r\nstatus = acpi_evaluate_integer(handle, "HDMM", NULL, &mode);\r\nif (!ACPI_SUCCESS(status)) {\r\ndev_warn(&device->dev, "failed to read mode\n");\r\nreturn -ENODEV;\r\n}\r\nif (mode != 0) {\r\ndev_info(&device->dev, "platform is not in simple mode\n");\r\nreturn -ENODEV;\r\n}\r\npriv = devm_kzalloc(&device->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&device->dev, priv);\r\nerr = intel_hid_input_setup(device);\r\nif (err) {\r\npr_err("Failed to setup Intel HID hotkeys\n");\r\nreturn err;\r\n}\r\nstatus = acpi_install_notify_handler(handle,\r\nACPI_DEVICE_NOTIFY,\r\nnotify_handler,\r\ndevice);\r\nif (ACPI_FAILURE(status)) {\r\nerr = -EBUSY;\r\ngoto err_remove_input;\r\n}\r\nerr = intel_hid_set_enable(&device->dev, 1);\r\nif (err)\r\ngoto err_remove_notify;\r\nreturn 0;\r\nerr_remove_notify:\r\nacpi_remove_notify_handler(handle, ACPI_DEVICE_NOTIFY, notify_handler);\r\nerr_remove_input:\r\nintel_hid_input_destroy(device);\r\nreturn err;\r\n}\r\nstatic int intel_hid_remove(struct platform_device *device)\r\n{\r\nacpi_handle handle = ACPI_HANDLE(&device->dev);\r\nacpi_remove_notify_handler(handle, ACPI_DEVICE_NOTIFY, notify_handler);\r\nintel_hid_input_destroy(device);\r\nintel_hid_set_enable(&device->dev, 0);\r\nacpi_remove_notify_handler(handle, ACPI_DEVICE_NOTIFY, notify_handler);\r\nreturn 0;\r\n}\r\nstatic acpi_status __init\r\ncheck_acpi_dev(acpi_handle handle, u32 lvl, void *context, void **rv)\r\n{\r\nconst struct acpi_device_id *ids = context;\r\nstruct acpi_device *dev;\r\nif (acpi_bus_get_device(handle, &dev) != 0)\r\nreturn AE_OK;\r\nif (acpi_match_device_ids(dev, ids) == 0)\r\nif (acpi_create_platform_device(dev))\r\ndev_info(&dev->dev,\r\n"intel-hid: created platform device\n");\r\nreturn AE_OK;\r\n}\r\nstatic int __init intel_hid_init(void)\r\n{\r\nacpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX, check_acpi_dev, NULL,\r\n(void *)intel_hid_ids, NULL);\r\nreturn platform_driver_register(&intel_hid_pl_driver);\r\n}\r\nstatic void __exit intel_hid_exit(void)\r\n{\r\nplatform_driver_unregister(&intel_hid_pl_driver);\r\n}

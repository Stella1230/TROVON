static int gpio_restart_notify(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct gpio_restart *gpio_restart =\r\ncontainer_of(this, struct gpio_restart, restart_handler);\r\ngpiod_direction_output(gpio_restart->reset_gpio, 1);\r\nmdelay(gpio_restart->active_delay_ms);\r\ngpiod_set_value(gpio_restart->reset_gpio, 0);\r\nmdelay(gpio_restart->inactive_delay_ms);\r\ngpiod_set_value(gpio_restart->reset_gpio, 1);\r\nmdelay(gpio_restart->wait_delay_ms);\r\nWARN_ON(1);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int gpio_restart_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_restart *gpio_restart;\r\nbool open_source = false;\r\nu32 property;\r\nint ret;\r\ngpio_restart = devm_kzalloc(&pdev->dev, sizeof(*gpio_restart),\r\nGFP_KERNEL);\r\nif (!gpio_restart)\r\nreturn -ENOMEM;\r\nopen_source = of_property_read_bool(pdev->dev.of_node, "open-source");\r\ngpio_restart->reset_gpio = devm_gpiod_get(&pdev->dev, NULL,\r\nopen_source ? GPIOD_IN : GPIOD_OUT_LOW);\r\nif (IS_ERR(gpio_restart->reset_gpio)) {\r\ndev_err(&pdev->dev, "Could net get reset GPIO\n");\r\nreturn PTR_ERR(gpio_restart->reset_gpio);\r\n}\r\ngpio_restart->restart_handler.notifier_call = gpio_restart_notify;\r\ngpio_restart->restart_handler.priority = 129;\r\ngpio_restart->active_delay_ms = 100;\r\ngpio_restart->inactive_delay_ms = 100;\r\ngpio_restart->wait_delay_ms = 3000;\r\nret = of_property_read_u32(pdev->dev.of_node, "priority", &property);\r\nif (!ret) {\r\nif (property > 255)\r\ndev_err(&pdev->dev, "Invalid priority property: %u\n",\r\nproperty);\r\nelse\r\ngpio_restart->restart_handler.priority = property;\r\n}\r\nof_property_read_u32(pdev->dev.of_node, "active-delay",\r\n&gpio_restart->active_delay_ms);\r\nof_property_read_u32(pdev->dev.of_node, "inactive-delay",\r\n&gpio_restart->inactive_delay_ms);\r\nof_property_read_u32(pdev->dev.of_node, "wait-delay",\r\n&gpio_restart->wait_delay_ms);\r\nplatform_set_drvdata(pdev, gpio_restart);\r\nret = register_restart_handler(&gpio_restart->restart_handler);\r\nif (ret) {\r\ndev_err(&pdev->dev, "%s: cannot register restart handler, %d\n",\r\n__func__, ret);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gpio_restart_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_restart *gpio_restart = platform_get_drvdata(pdev);\r\nint ret;\r\nret = unregister_restart_handler(&gpio_restart->restart_handler);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"%s: cannot unregister restart handler, %d\n",\r\n__func__, ret);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}

static void __naked tf_generic_smc(u32 type, u32 arg1, u32 arg2)\r\n{\r\nasm volatile(\r\n".arch_extension sec\n\t"\r\n"stmfd sp!, {r4 - r11, lr}\n\t"\r\n__asmeq("%0", "r0")\r\n__asmeq("%1", "r1")\r\n__asmeq("%2", "r2")\r\n"mov r3, #0\n\t"\r\n"mov r4, #0\n\t"\r\n"smc #0\n\t"\r\n"ldmfd sp!, {r4 - r11, pc}"\r\n:\r\n: "r" (type), "r" (arg1), "r" (arg2)\r\n: "memory");\r\n}\r\nstatic int tf_set_cpu_boot_addr(int cpu, unsigned long boot_addr)\r\n{\r\ncpu_boot_addr = boot_addr;\r\ntf_generic_smc(TF_SET_CPU_BOOT_ADDR_SMC, cpu_boot_addr, 0);\r\nreturn 0;\r\n}\r\nstatic int tf_prepare_idle(void)\r\n{\r\ntf_generic_smc(TF_CPU_PM, TF_CPU_PM_S1_NOFLUSH_L2, cpu_boot_addr);\r\nreturn 0;\r\n}\r\nvoid register_trusted_foundations(struct trusted_foundations_platform_data *pd)\r\n{\r\nregister_firmware_ops(&trusted_foundations_ops);\r\n}\r\nvoid of_register_trusted_foundations(void)\r\n{\r\nstruct device_node *node;\r\nstruct trusted_foundations_platform_data pdata;\r\nint err;\r\nnode = of_find_compatible_node(NULL, NULL, "tlm,trusted-foundations");\r\nif (!node)\r\nreturn;\r\nerr = of_property_read_u32(node, "tlm,version-major",\r\n&pdata.version_major);\r\nif (err != 0)\r\npanic("Trusted Foundation: missing version-major property\n");\r\nerr = of_property_read_u32(node, "tlm,version-minor",\r\n&pdata.version_minor);\r\nif (err != 0)\r\npanic("Trusted Foundation: missing version-minor property\n");\r\nregister_trusted_foundations(&pdata);\r\n}

static int midi_phys_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nint err;\r\nerr = snd_dg00x_stream_lock_try(dg00x);\r\nif (err < 0)\r\nreturn err;\r\nmutex_lock(&dg00x->mutex);\r\ndg00x->substreams_counter++;\r\nerr = snd_dg00x_stream_start_duplex(dg00x, 0);\r\nmutex_unlock(&dg00x->mutex);\r\nif (err < 0)\r\nsnd_dg00x_stream_lock_release(dg00x);\r\nreturn err;\r\n}\r\nstatic int midi_phys_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nmutex_lock(&dg00x->mutex);\r\ndg00x->substreams_counter--;\r\nsnd_dg00x_stream_stop_duplex(dg00x);\r\nmutex_unlock(&dg00x->mutex);\r\nsnd_dg00x_stream_lock_release(dg00x);\r\nreturn 0;\r\n}\r\nstatic void midi_phys_capture_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\namdtp_dot_midi_trigger(&dg00x->tx_stream, substream->number,\r\nsubstream);\r\nelse\r\namdtp_dot_midi_trigger(&dg00x->tx_stream, substream->number,\r\nNULL);\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic void midi_phys_playback_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\namdtp_dot_midi_trigger(&dg00x->rx_stream, substream->number,\r\nsubstream);\r\nelse\r\namdtp_dot_midi_trigger(&dg00x->rx_stream, substream->number,\r\nNULL);\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic int midi_ctl_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_ctl_capture_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int midi_ctl_playback_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nsnd_fw_async_midi_port_finish(&dg00x->out_control);\r\nreturn 0;\r\n}\r\nstatic void midi_ctl_capture_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\ndg00x->in_control = substream;\r\nelse\r\ndg00x->in_control = NULL;\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic void midi_ctl_playback_trigger(struct snd_rawmidi_substream *substream,\r\nint up)\r\n{\r\nstruct snd_dg00x *dg00x = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dg00x->lock, flags);\r\nif (up)\r\nsnd_fw_async_midi_port_run(&dg00x->out_control, substream);\r\nspin_unlock_irqrestore(&dg00x->lock, flags);\r\n}\r\nstatic void set_midi_substream_names(struct snd_dg00x *dg00x,\r\nstruct snd_rawmidi_str *str,\r\nbool is_ctl)\r\n{\r\nstruct snd_rawmidi_substream *subs;\r\nlist_for_each_entry(subs, &str->substreams, list) {\r\nif (!is_ctl)\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s MIDI %d",\r\ndg00x->card->shortname, subs->number + 1);\r\nelse\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s control",\r\ndg00x->card->shortname);\r\n}\r\n}\r\nint snd_dg00x_create_midi_devices(struct snd_dg00x *dg00x)\r\n{\r\nstruct snd_rawmidi *rmidi[2];\r\nstruct snd_rawmidi_str *str;\r\nunsigned int i;\r\nint err;\r\nerr = snd_rawmidi_new(dg00x->card, dg00x->card->driver, 0,\r\nDOT_MIDI_OUT_PORTS, DOT_MIDI_IN_PORTS, &rmidi[0]);\r\nif (err < 0)\r\nreturn err;\r\nsnprintf(rmidi[0]->name, sizeof(rmidi[0]->name),\r\n"%s MIDI", dg00x->card->shortname);\r\nsnd_rawmidi_set_ops(rmidi[0], SNDRV_RAWMIDI_STREAM_INPUT,\r\n&midi_phys_capture_ops);\r\nsnd_rawmidi_set_ops(rmidi[0], SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&midi_phys_playback_ops);\r\nerr = snd_rawmidi_new(dg00x->card, dg00x->card->driver, 1,\r\n1, 1, &rmidi[1]);\r\nif (err < 0)\r\nreturn err;\r\nsnprintf(rmidi[1]->name, sizeof(rmidi[1]->name),\r\n"%s control", dg00x->card->shortname);\r\nsnd_rawmidi_set_ops(rmidi[1], SNDRV_RAWMIDI_STREAM_INPUT,\r\n&midi_ctl_capture_ops);\r\nsnd_rawmidi_set_ops(rmidi[1], SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&midi_ctl_playback_ops);\r\nfor (i = 0; i < ARRAY_SIZE(rmidi); i++) {\r\nrmidi[i]->private_data = dg00x;\r\nrmidi[i]->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nstr = &rmidi[i]->streams[SNDRV_RAWMIDI_STREAM_INPUT];\r\nset_midi_substream_names(dg00x, str, i);\r\nrmidi[i]->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\r\nstr = &rmidi[i]->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\r\nset_midi_substream_names(dg00x, str, i);\r\nrmidi[i]->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\r\n}\r\nreturn 0;\r\n}

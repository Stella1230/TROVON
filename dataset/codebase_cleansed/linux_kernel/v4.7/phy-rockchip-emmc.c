static int rockchip_emmc_phy_power(struct rockchip_emmc_phy *rk_phy,\r\nbool on_off)\r\n{\r\nunsigned int caldone;\r\nunsigned int dllrdy;\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_PDB_PWR_OFF,\r\nPHYCTRL_PDB_MASK,\r\nPHYCTRL_PDB_SHIFT));\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_ENDLL_DISABLE,\r\nPHYCTRL_ENDLL_MASK,\r\nPHYCTRL_ENDLL_SHIFT));\r\nif (on_off == PHYCTRL_PDB_PWR_OFF)\r\nreturn 0;\r\nudelay(3);\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_PDB_PWR_ON,\r\nPHYCTRL_PDB_MASK,\r\nPHYCTRL_PDB_SHIFT));\r\nudelay(5);\r\nregmap_read(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_STATUS,\r\n&caldone);\r\ncaldone = (caldone >> PHYCTRL_CALDONE_SHIFT) & PHYCTRL_CALDONE_MASK;\r\nif (caldone != PHYCTRL_CALDONE_DONE) {\r\npr_err("rockchip_emmc_phy_power: caldone timeout.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_ENDLL_ENABLE,\r\nPHYCTRL_ENDLL_MASK,\r\nPHYCTRL_ENDLL_SHIFT));\r\nudelay(11);\r\nregmap_read(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_STATUS,\r\n&dllrdy);\r\ndllrdy = (dllrdy >> PHYCTRL_DLLRDY_SHIFT) & PHYCTRL_DLLRDY_MASK;\r\nif (dllrdy != PHYCTRL_DLLRDY_DONE) {\r\npr_err("rockchip_emmc_phy_power: dllrdy timeout.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_emmc_phy_power_off(struct phy *phy)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nint ret = 0;\r\nret = rockchip_emmc_phy_power(rk_phy, PHYCTRL_PDB_PWR_OFF);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int rockchip_emmc_phy_power_on(struct phy *phy)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nint ret = 0;\r\nret = rockchip_emmc_phy_power(rk_phy, PHYCTRL_PDB_PWR_ON);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int rockchip_emmc_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct rockchip_emmc_phy *rk_phy;\r\nstruct phy *generic_phy;\r\nstruct phy_provider *phy_provider;\r\nstruct regmap *grf;\r\nunsigned int reg_offset;\r\nif (!dev->parent || !dev->parent->of_node)\r\nreturn -ENODEV;\r\ngrf = syscon_node_to_regmap(dev->parent->of_node);\r\nif (IS_ERR(grf)) {\r\ndev_err(dev, "Missing rockchip,grf property\n");\r\nreturn PTR_ERR(grf);\r\n}\r\nrk_phy = devm_kzalloc(dev, sizeof(*rk_phy), GFP_KERNEL);\r\nif (!rk_phy)\r\nreturn -ENOMEM;\r\nif (of_property_read_u32(dev->of_node, "reg", &reg_offset)) {\r\ndev_err(dev, "missing reg property in node %s\n",\r\ndev->of_node->name);\r\nreturn -EINVAL;\r\n}\r\nrk_phy->reg_offset = reg_offset;\r\nrk_phy->reg_base = grf;\r\ngeneric_phy = devm_phy_create(dev, dev->of_node, &ops);\r\nif (IS_ERR(generic_phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(generic_phy);\r\n}\r\nphy_set_drvdata(generic_phy, rk_phy);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

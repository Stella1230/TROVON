static int bpcm_wr_rd_mask(void __iomem *master,\r\nunsigned int addr, u32 off, u32 *val,\r\nu32 shift, u32 mask, u32 cond)\r\n{\r\nint ret;\r\nret = bpcm_wr(master, addr, off, *val);\r\nif (ret)\r\nreturn ret;\r\ndo {\r\nret = bpcm_rd(master, addr, off, val);\r\nif (ret)\r\nreturn ret;\r\ncpu_relax();\r\n} while (((*val >> shift) & mask) != cond);\r\nreturn ret;\r\n}\r\nstatic int bcm63xx_pmb_get_resources(struct device_node *dn,\r\nvoid __iomem **base,\r\nunsigned int *cpu,\r\nunsigned int *addr)\r\n{\r\nstruct of_phandle_args args;\r\nint ret;\r\nret = of_property_read_u32(dn, "reg", cpu);\r\nif (ret) {\r\npr_err("CPU is missing a reg node\n");\r\nreturn ret;\r\n}\r\nret = of_parse_phandle_with_args(dn, "resets", "#reset-cells",\r\n0, &args);\r\nif (ret) {\r\npr_err("CPU is missing a resets phandle\n");\r\nreturn ret;\r\n}\r\nif (args.args_count != 2) {\r\npr_err("reset-controller does not conform to reset-cells\n");\r\nreturn -EINVAL;\r\n}\r\n*base = of_iomap(args.np, 0);\r\nif (!*base) {\r\npr_err("failed remapping PMB register\n");\r\nreturn -ENOMEM;\r\n}\r\n*addr = args.args[0];\r\nreturn 0;\r\n}\r\nint bcm63xx_pmb_power_on_cpu(struct device_node *dn)\r\n{\r\nvoid __iomem *base;\r\nunsigned int cpu, addr;\r\nunsigned long flags;\r\nu32 val, ctrl;\r\nint ret;\r\nret = bcm63xx_pmb_get_resources(dn, &base, &cpu, &addr);\r\nif (ret)\r\nreturn ret;\r\nWARN_ON(cpu > 1);\r\nspin_lock_irqsave(&pmb_lock, flags);\r\nret = bpcm_rd(base, addr, ARM_CONTROL, &ctrl);\r\nif (ret)\r\ngoto out;\r\nif (ctrl & CPU_RESET_N(cpu)) {\r\npr_info("PMB: CPU%d is already powered on\n", cpu);\r\nret = 0;\r\ngoto out;\r\n}\r\nret = bpcm_rd(base, addr, ARM_PWR_CONTROL(cpu), &val);\r\nif (ret)\r\ngoto out;\r\nval |= (PWR_CPU_MASK << PWR_ON_SHIFT);\r\nret = bpcm_wr_rd_mask(base, addr, ARM_PWR_CONTROL(cpu), &val,\r\nPWR_ON_STATUS_SHIFT, PWR_CPU_MASK, PWR_CPU_MASK);\r\nif (ret)\r\ngoto out;\r\nval |= (PWR_CPU_MASK << PWR_OK_SHIFT);\r\nret = bpcm_wr_rd_mask(base, addr, ARM_PWR_CONTROL(cpu), &val,\r\nPWR_OK_STATUS_SHIFT, PWR_CPU_MASK, PWR_CPU_MASK);\r\nif (ret)\r\ngoto out;\r\nval &= ~CLAMP_ON;\r\nret = bpcm_wr(base, addr, ARM_PWR_CONTROL(cpu), val);\r\nif (ret)\r\ngoto out;\r\nval &= ~(MEM_PDA_MASK << MEM_PDA_SHIFT);\r\nret = bpcm_wr(base, addr, ARM_PWR_CONTROL(cpu), val);\r\nif (ret)\r\ngoto out;\r\nval |= MEM_PWR_ON;\r\nret = bpcm_wr_rd_mask(base, addr, ARM_PWR_CONTROL(cpu), &val,\r\n0, MEM_PWR_ON_STATUS, MEM_PWR_ON_STATUS);\r\nif (ret)\r\ngoto out;\r\nval |= MEM_PWR_OK;\r\nret = bpcm_wr_rd_mask(base, addr, ARM_PWR_CONTROL(cpu), &val,\r\n0, MEM_PWR_OK_STATUS, MEM_PWR_OK_STATUS);\r\nif (ret)\r\ngoto out;\r\nval &= ~MEM_CLAMP_ON;\r\nret = bpcm_wr(base, addr, ARM_PWR_CONTROL(cpu), val);\r\nif (ret)\r\ngoto out;\r\nctrl |= CPU_RESET_N(cpu);\r\nret = bpcm_wr(base, addr, ARM_CONTROL, ctrl);\r\nout:\r\nspin_unlock_irqrestore(&pmb_lock, flags);\r\niounmap(base);\r\nreturn ret;\r\n}

static int printer_do_config(struct usb_configuration *c)\r\n{\r\nstruct usb_gadget *gadget = c->cdev->gadget;\r\nint status = 0;\r\nusb_ep_autoconfig_reset(gadget);\r\nusb_gadget_set_selfpowered(gadget);\r\nif (gadget_is_otg(gadget)) {\r\nprinter_cfg_driver.descriptors = otg_desc;\r\nprinter_cfg_driver.bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_printer = usb_get_function(fi_printer);\r\nif (IS_ERR(f_printer))\r\nreturn PTR_ERR(f_printer);\r\nstatus = usb_add_function(c, f_printer);\r\nif (status < 0)\r\nusb_put_function(f_printer);\r\nreturn status;\r\n}\r\nstatic int printer_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct f_printer_opts *opts;\r\nint ret, len;\r\nfi_printer = usb_get_function_instance("printer");\r\nif (IS_ERR(fi_printer))\r\nreturn PTR_ERR(fi_printer);\r\nif (iPNPstring)\r\nstrlcpy(&pnp_string[2], iPNPstring, PNP_STRING_LEN - 2);\r\nlen = strlen(pnp_string);\r\npnp_string[0] = (len >> 8) & 0xFF;\r\npnp_string[1] = len & 0xFF;\r\nopts = container_of(fi_printer, struct f_printer_opts, func_inst);\r\nopts->minor = 0;\r\nmemcpy(opts->pnp_string, pnp_string, PNP_STRING_LEN);\r\nopts->q_len = QLEN;\r\nret = usb_string_ids_tab(cdev, strings);\r\nif (ret < 0)\r\ngoto fail_put_func_inst;\r\ndevice_desc.iManufacturer = strings[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings[USB_GADGET_PRODUCT_IDX].id;\r\ndevice_desc.iSerialNumber = strings[USB_GADGET_SERIAL_IDX].id;\r\nif (gadget_is_otg(cdev->gadget) && !otg_desc[0]) {\r\nstruct usb_descriptor_header *usb_desc;\r\nusb_desc = usb_otg_descriptor_alloc(cdev->gadget);\r\nif (!usb_desc) {\r\nret = -ENOMEM;\r\ngoto fail_put_func_inst;\r\n}\r\nusb_otg_descriptor_init(cdev->gadget, usb_desc);\r\notg_desc[0] = usb_desc;\r\notg_desc[1] = NULL;\r\n}\r\nret = usb_add_config(cdev, &printer_cfg_driver, printer_do_config);\r\nif (ret)\r\ngoto fail_free_otg_desc;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\nreturn ret;\r\nfail_free_otg_desc:\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nfail_put_func_inst:\r\nusb_put_function_instance(fi_printer);\r\nreturn ret;\r\n}\r\nstatic int printer_unbind(struct usb_composite_dev *cdev)\r\n{\r\nusb_put_function(f_printer);\r\nusb_put_function_instance(fi_printer);\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nreturn 0;\r\n}

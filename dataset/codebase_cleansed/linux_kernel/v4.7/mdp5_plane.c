static struct mdp5_kms *get_kms(struct drm_plane *plane)\r\n{\r\nstruct msm_drm_private *priv = plane->dev->dev_private;\r\nreturn to_mdp5_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic bool plane_enabled(struct drm_plane_state *state)\r\n{\r\nreturn state->fb && state->crtc;\r\n}\r\nstatic void mdp5_plane_destroy(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\ndrm_plane_helper_disable(plane);\r\ndrm_plane_cleanup(plane);\r\nkfree(mdp5_plane);\r\n}\r\nstatic void mdp5_plane_install_rotation_property(struct drm_device *dev,\r\nstruct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nif (!(mdp5_plane->caps & MDP_PIPE_CAP_HFLIP) &&\r\n!(mdp5_plane->caps & MDP_PIPE_CAP_VFLIP))\r\nreturn;\r\nif (!dev->mode_config.rotation_property)\r\ndev->mode_config.rotation_property =\r\ndrm_mode_create_rotation_property(dev,\r\nBIT(DRM_REFLECT_X) | BIT(DRM_REFLECT_Y));\r\nif (dev->mode_config.rotation_property)\r\ndrm_object_attach_property(&plane->base,\r\ndev->mode_config.rotation_property,\r\n0);\r\n}\r\nstatic void mdp5_plane_install_properties(struct drm_plane *plane,\r\nstruct drm_mode_object *obj)\r\n{\r\nstruct drm_device *dev = plane->dev;\r\nstruct msm_drm_private *dev_priv = dev->dev_private;\r\nstruct drm_property *prop;\r\n#define INSTALL_PROPERTY(name, NAME, init_val, fnc, ...) do { \\r\nprop = dev_priv->plane_property[PLANE_PROP_##NAME]; \\r\nif (!prop) { \\r\nprop = drm_property_##fnc(dev, 0, #name, \\r\n##__VA_ARGS__); \\r\nif (!prop) { \\r\ndev_warn(dev->dev, \\r\n"Create property %s failed\n", \\r\n#name); \\r\nreturn; \\r\n} \\r\ndev_priv->plane_property[PLANE_PROP_##NAME] = prop; \\r\n} \\r\ndrm_object_attach_property(&plane->base, prop, init_val); \\r\n} while (0)\r\n#define INSTALL_RANGE_PROPERTY(name, NAME, min, max, init_val) \\r\nINSTALL_PROPERTY(name, NAME, init_val, \\r\ncreate_range, min, max)\r\n#define INSTALL_ENUM_PROPERTY(name, NAME, init_val) \\r\nINSTALL_PROPERTY(name, NAME, init_val, \\r\ncreate_enum, name##_prop_enum_list, \\r\nARRAY_SIZE(name##_prop_enum_list))\r\nINSTALL_RANGE_PROPERTY(zpos, ZPOS, 1, 255, 1);\r\nmdp5_plane_install_rotation_property(dev, plane);\r\n#undef INSTALL_RANGE_PROPERTY\r\n#undef INSTALL_ENUM_PROPERTY\r\n#undef INSTALL_PROPERTY\r\n}\r\nstatic int mdp5_plane_atomic_set_property(struct drm_plane *plane,\r\nstruct drm_plane_state *state, struct drm_property *property,\r\nuint64_t val)\r\n{\r\nstruct drm_device *dev = plane->dev;\r\nstruct mdp5_plane_state *pstate;\r\nstruct msm_drm_private *dev_priv = dev->dev_private;\r\nint ret = 0;\r\npstate = to_mdp5_plane_state(state);\r\n#define SET_PROPERTY(name, NAME, type) do { \\r\nif (dev_priv->plane_property[PLANE_PROP_##NAME] == property) { \\r\npstate->name = (type)val; \\r\nDBG("Set property %s %d", #name, (type)val); \\r\ngoto done; \\r\n} \\r\n} while (0)\r\nSET_PROPERTY(zpos, ZPOS, uint8_t);\r\ndev_err(dev->dev, "Invalid property\n");\r\nret = -EINVAL;\r\ndone:\r\nreturn ret;\r\n#undef SET_PROPERTY\r\n}\r\nstatic int mdp5_plane_atomic_get_property(struct drm_plane *plane,\r\nconst struct drm_plane_state *state,\r\nstruct drm_property *property, uint64_t *val)\r\n{\r\nstruct drm_device *dev = plane->dev;\r\nstruct mdp5_plane_state *pstate;\r\nstruct msm_drm_private *dev_priv = dev->dev_private;\r\nint ret = 0;\r\npstate = to_mdp5_plane_state(state);\r\n#define GET_PROPERTY(name, NAME, type) do { \\r\nif (dev_priv->plane_property[PLANE_PROP_##NAME] == property) { \\r\n*val = pstate->name; \\r\nDBG("Get property %s %lld", #name, *val); \\r\ngoto done; \\r\n} \\r\n} while (0)\r\nGET_PROPERTY(zpos, ZPOS, uint8_t);\r\ndev_err(dev->dev, "Invalid property\n");\r\nret = -EINVAL;\r\ndone:\r\nreturn ret;\r\n#undef SET_PROPERTY\r\n}\r\nstatic void mdp5_plane_reset(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane_state *mdp5_state;\r\nif (plane->state && plane->state->fb)\r\ndrm_framebuffer_unreference(plane->state->fb);\r\nkfree(to_mdp5_plane_state(plane->state));\r\nmdp5_state = kzalloc(sizeof(*mdp5_state), GFP_KERNEL);\r\nmdp5_state->alpha = 255;\r\nmdp5_state->premultiplied = 0;\r\nif (plane->type == DRM_PLANE_TYPE_PRIMARY)\r\nmdp5_state->zpos = STAGE_BASE;\r\nelse\r\nmdp5_state->zpos = STAGE0 + drm_plane_index(plane);\r\nmdp5_state->base.plane = plane;\r\nplane->state = &mdp5_state->base;\r\n}\r\nstatic struct drm_plane_state *\r\nmdp5_plane_duplicate_state(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane_state *mdp5_state;\r\nif (WARN_ON(!plane->state))\r\nreturn NULL;\r\nmdp5_state = kmemdup(to_mdp5_plane_state(plane->state),\r\nsizeof(*mdp5_state), GFP_KERNEL);\r\nif (mdp5_state && mdp5_state->base.fb)\r\ndrm_framebuffer_reference(mdp5_state->base.fb);\r\nmdp5_state->mode_changed = false;\r\nmdp5_state->pending = false;\r\nreturn &mdp5_state->base;\r\n}\r\nstatic void mdp5_plane_destroy_state(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nif (state->fb)\r\ndrm_framebuffer_unreference(state->fb);\r\nkfree(to_mdp5_plane_state(state));\r\n}\r\nstatic int mdp5_plane_prepare_fb(struct drm_plane *plane,\r\nconst struct drm_plane_state *new_state)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct drm_framebuffer *fb = new_state->fb;\r\nif (!new_state->fb)\r\nreturn 0;\r\nDBG("%s: prepare: FB[%u]", mdp5_plane->name, fb->base.id);\r\nreturn msm_framebuffer_prepare(fb, mdp5_kms->id);\r\n}\r\nstatic void mdp5_plane_cleanup_fb(struct drm_plane *plane,\r\nconst struct drm_plane_state *old_state)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct drm_framebuffer *fb = old_state->fb;\r\nif (!fb)\r\nreturn;\r\nDBG("%s: cleanup: FB[%u]", mdp5_plane->name, fb->base.id);\r\nmsm_framebuffer_cleanup(fb, mdp5_kms->id);\r\n}\r\nstatic int mdp5_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct drm_plane_state *old_state = plane->state;\r\nconst struct mdp_format *format;\r\nbool vflip, hflip;\r\nDBG("%s: check (%d -> %d)", mdp5_plane->name,\r\nplane_enabled(old_state), plane_enabled(state));\r\nif (plane_enabled(state)) {\r\nformat = to_mdp_format(msm_framebuffer_format(state->fb));\r\nif (MDP_FORMAT_IS_YUV(format) &&\r\n!pipe_supports_yuv(mdp5_plane->caps)) {\r\ndev_err(plane->dev->dev,\r\n"Pipe doesn't support YUV\n");\r\nreturn -EINVAL;\r\n}\r\nif (!(mdp5_plane->caps & MDP_PIPE_CAP_SCALE) &&\r\n(((state->src_w >> 16) != state->crtc_w) ||\r\n((state->src_h >> 16) != state->crtc_h))) {\r\ndev_err(plane->dev->dev,\r\n"Pipe doesn't support scaling (%dx%d -> %dx%d)\n",\r\nstate->src_w >> 16, state->src_h >> 16,\r\nstate->crtc_w, state->crtc_h);\r\nreturn -EINVAL;\r\n}\r\nhflip = !!(state->rotation & BIT(DRM_REFLECT_X));\r\nvflip = !!(state->rotation & BIT(DRM_REFLECT_Y));\r\nif ((vflip && !(mdp5_plane->caps & MDP_PIPE_CAP_VFLIP)) ||\r\n(hflip && !(mdp5_plane->caps & MDP_PIPE_CAP_HFLIP))) {\r\ndev_err(plane->dev->dev,\r\n"Pipe doesn't support flip\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (plane_enabled(state) && plane_enabled(old_state)) {\r\nbool full_modeset = false;\r\nif (state->fb->pixel_format != old_state->fb->pixel_format) {\r\nDBG("%s: pixel_format change!", mdp5_plane->name);\r\nfull_modeset = true;\r\n}\r\nif (state->src_w != old_state->src_w) {\r\nDBG("%s: src_w change!", mdp5_plane->name);\r\nfull_modeset = true;\r\n}\r\nif (to_mdp5_plane_state(old_state)->pending) {\r\nDBG("%s: still pending!", mdp5_plane->name);\r\nfull_modeset = true;\r\n}\r\nif (full_modeset) {\r\nstruct drm_crtc_state *crtc_state =\r\ndrm_atomic_get_crtc_state(state->state, state->crtc);\r\ncrtc_state->mode_changed = true;\r\nto_mdp5_plane_state(state)->mode_changed = true;\r\n}\r\n} else {\r\nto_mdp5_plane_state(state)->mode_changed = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mdp5_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct drm_plane_state *state = plane->state;\r\nDBG("%s: update", mdp5_plane->name);\r\nif (!plane_enabled(state)) {\r\nto_mdp5_plane_state(state)->pending = true;\r\n} else if (to_mdp5_plane_state(state)->mode_changed) {\r\nint ret;\r\nto_mdp5_plane_state(state)->pending = true;\r\nret = mdp5_plane_mode_set(plane,\r\nstate->crtc, state->fb,\r\nstate->crtc_x, state->crtc_y,\r\nstate->crtc_w, state->crtc_h,\r\nstate->src_x, state->src_y,\r\nstate->src_w, state->src_h);\r\nWARN_ON(ret < 0);\r\n} else {\r\nunsigned long flags;\r\nspin_lock_irqsave(&mdp5_plane->pipe_lock, flags);\r\nset_scanout_locked(plane, state->fb);\r\nspin_unlock_irqrestore(&mdp5_plane->pipe_lock, flags);\r\n}\r\n}\r\nstatic void set_scanout_locked(struct drm_plane *plane,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_STRIDE_A(pipe),\r\nMDP5_PIPE_SRC_STRIDE_A_P0(fb->pitches[0]) |\r\nMDP5_PIPE_SRC_STRIDE_A_P1(fb->pitches[1]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_STRIDE_B(pipe),\r\nMDP5_PIPE_SRC_STRIDE_B_P2(fb->pitches[2]) |\r\nMDP5_PIPE_SRC_STRIDE_B_P3(fb->pitches[3]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC0_ADDR(pipe),\r\nmsm_framebuffer_iova(fb, mdp5_kms->id, 0));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC1_ADDR(pipe),\r\nmsm_framebuffer_iova(fb, mdp5_kms->id, 1));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC2_ADDR(pipe),\r\nmsm_framebuffer_iova(fb, mdp5_kms->id, 2));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC3_ADDR(pipe),\r\nmsm_framebuffer_iova(fb, mdp5_kms->id, 3));\r\nplane->fb = fb;\r\n}\r\nstatic void csc_disable(struct mdp5_kms *mdp5_kms, enum mdp5_pipe pipe)\r\n{\r\nuint32_t value = mdp5_read(mdp5_kms, REG_MDP5_PIPE_OP_MODE(pipe)) &\r\n~MDP5_PIPE_OP_MODE_CSC_1_EN;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OP_MODE(pipe), value);\r\n}\r\nstatic void csc_enable(struct mdp5_kms *mdp5_kms, enum mdp5_pipe pipe,\r\nstruct csc_cfg *csc)\r\n{\r\nuint32_t i, mode = 0;\r\nuint32_t *matrix;\r\nif (unlikely(!csc))\r\nreturn;\r\nif ((csc->type == CSC_YUV2RGB) || (CSC_YUV2YUV == csc->type))\r\nmode |= MDP5_PIPE_OP_MODE_CSC_SRC_DATA_FORMAT(DATA_FORMAT_YUV);\r\nif ((csc->type == CSC_RGB2YUV) || (CSC_YUV2YUV == csc->type))\r\nmode |= MDP5_PIPE_OP_MODE_CSC_DST_DATA_FORMAT(DATA_FORMAT_YUV);\r\nmode |= MDP5_PIPE_OP_MODE_CSC_1_EN;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OP_MODE(pipe), mode);\r\nmatrix = csc->matrix;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_MATRIX_COEFF_0(pipe),\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_0_COEFF_11(matrix[0]) |\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_0_COEFF_12(matrix[1]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_MATRIX_COEFF_1(pipe),\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_1_COEFF_13(matrix[2]) |\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_1_COEFF_21(matrix[3]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_MATRIX_COEFF_2(pipe),\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_2_COEFF_22(matrix[4]) |\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_2_COEFF_23(matrix[5]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_MATRIX_COEFF_3(pipe),\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_3_COEFF_31(matrix[6]) |\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_3_COEFF_32(matrix[7]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_MATRIX_COEFF_4(pipe),\r\nMDP5_PIPE_CSC_1_MATRIX_COEFF_4_COEFF_33(matrix[8]));\r\nfor (i = 0; i < ARRAY_SIZE(csc->pre_bias); i++) {\r\nuint32_t *pre_clamp = csc->pre_clamp;\r\nuint32_t *post_clamp = csc->post_clamp;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_PRE_CLAMP(pipe, i),\r\nMDP5_PIPE_CSC_1_PRE_CLAMP_REG_HIGH(pre_clamp[2*i+1]) |\r\nMDP5_PIPE_CSC_1_PRE_CLAMP_REG_LOW(pre_clamp[2*i]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_POST_CLAMP(pipe, i),\r\nMDP5_PIPE_CSC_1_POST_CLAMP_REG_HIGH(post_clamp[2*i+1]) |\r\nMDP5_PIPE_CSC_1_POST_CLAMP_REG_LOW(post_clamp[2*i]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_PRE_BIAS(pipe, i),\r\nMDP5_PIPE_CSC_1_PRE_BIAS_REG_VALUE(csc->pre_bias[i]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_CSC_1_POST_BIAS(pipe, i),\r\nMDP5_PIPE_CSC_1_POST_BIAS_REG_VALUE(csc->post_bias[i]));\r\n}\r\n}\r\nstatic int calc_phase_step(uint32_t src, uint32_t dst, uint32_t *out_phase)\r\n{\r\nuint32_t unit;\r\nif (src == 0 || dst == 0)\r\nreturn -EINVAL;\r\nif (src > (dst * DOWN_SCALE_RATIO_MAX))\r\nreturn -EOVERFLOW;\r\nunit = 1 << PHASE_STEP_SHIFT;\r\n*out_phase = mult_frac(unit, src, dst);\r\nreturn 0;\r\n}\r\nstatic int calc_scalex_steps(struct drm_plane *plane,\r\nuint32_t pixel_format, uint32_t src, uint32_t dest,\r\nuint32_t phasex_steps[COMP_MAX])\r\n{\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct device *dev = mdp5_kms->dev->dev;\r\nuint32_t phasex_step;\r\nunsigned int hsub;\r\nint ret;\r\nret = calc_phase_step(src, dest, &phasex_step);\r\nif (ret) {\r\ndev_err(dev, "X scaling (%d->%d) failed: %d\n", src, dest, ret);\r\nreturn ret;\r\n}\r\nhsub = drm_format_horz_chroma_subsampling(pixel_format);\r\nphasex_steps[COMP_0] = phasex_step;\r\nphasex_steps[COMP_3] = phasex_step;\r\nphasex_steps[COMP_1_2] = phasex_step / hsub;\r\nreturn 0;\r\n}\r\nstatic int calc_scaley_steps(struct drm_plane *plane,\r\nuint32_t pixel_format, uint32_t src, uint32_t dest,\r\nuint32_t phasey_steps[COMP_MAX])\r\n{\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct device *dev = mdp5_kms->dev->dev;\r\nuint32_t phasey_step;\r\nunsigned int vsub;\r\nint ret;\r\nret = calc_phase_step(src, dest, &phasey_step);\r\nif (ret) {\r\ndev_err(dev, "Y scaling (%d->%d) failed: %d\n", src, dest, ret);\r\nreturn ret;\r\n}\r\nvsub = drm_format_vert_chroma_subsampling(pixel_format);\r\nphasey_steps[COMP_0] = phasey_step;\r\nphasey_steps[COMP_3] = phasey_step;\r\nphasey_steps[COMP_1_2] = phasey_step / vsub;\r\nreturn 0;\r\n}\r\nstatic uint32_t get_scale_config(const struct mdp_format *format,\r\nuint32_t src, uint32_t dst, bool horz)\r\n{\r\nbool scaling = format->is_yuv ? true : (src != dst);\r\nuint32_t sub, pix_fmt = format->base.pixel_format;\r\nuint32_t ya_filter, uv_filter;\r\nbool yuv = format->is_yuv;\r\nif (!scaling)\r\nreturn 0;\r\nif (yuv) {\r\nsub = horz ? drm_format_horz_chroma_subsampling(pix_fmt) :\r\ndrm_format_vert_chroma_subsampling(pix_fmt);\r\nuv_filter = ((src / sub) <= dst) ?\r\nSCALE_FILTER_BIL : SCALE_FILTER_PCMN;\r\n}\r\nya_filter = (src <= dst) ? SCALE_FILTER_BIL : SCALE_FILTER_PCMN;\r\nif (horz)\r\nreturn MDP5_PIPE_SCALE_CONFIG_SCALEX_EN |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEX_FILTER_COMP_0(ya_filter) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEX_FILTER_COMP_3(ya_filter) |\r\nCOND(yuv, MDP5_PIPE_SCALE_CONFIG_SCALEX_FILTER_COMP_1_2(uv_filter));\r\nelse\r\nreturn MDP5_PIPE_SCALE_CONFIG_SCALEY_EN |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEY_FILTER_COMP_0(ya_filter) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEY_FILTER_COMP_3(ya_filter) |\r\nCOND(yuv, MDP5_PIPE_SCALE_CONFIG_SCALEY_FILTER_COMP_1_2(uv_filter));\r\n}\r\nstatic void calc_pixel_ext(const struct mdp_format *format,\r\nuint32_t src, uint32_t dst, uint32_t phase_step[2],\r\nint pix_ext_edge1[COMP_MAX], int pix_ext_edge2[COMP_MAX],\r\nbool horz)\r\n{\r\nbool scaling = format->is_yuv ? true : (src != dst);\r\nint i;\r\nfor (i = 0; i < COMP_MAX; i++) {\r\npix_ext_edge1[i] = 0;\r\npix_ext_edge2[i] = scaling ? 1 : 0;\r\n}\r\n}\r\nstatic void mdp5_write_pixel_ext(struct mdp5_kms *mdp5_kms, enum mdp5_pipe pipe,\r\nconst struct mdp_format *format,\r\nuint32_t src_w, int pe_left[COMP_MAX], int pe_right[COMP_MAX],\r\nuint32_t src_h, int pe_top[COMP_MAX], int pe_bottom[COMP_MAX])\r\n{\r\nuint32_t pix_fmt = format->base.pixel_format;\r\nuint32_t lr, tb, req;\r\nint i;\r\nfor (i = 0; i < COMP_MAX; i++) {\r\nuint32_t roi_w = src_w;\r\nuint32_t roi_h = src_h;\r\nif (format->is_yuv && i == COMP_1_2) {\r\nroi_w /= drm_format_horz_chroma_subsampling(pix_fmt);\r\nroi_h /= drm_format_vert_chroma_subsampling(pix_fmt);\r\n}\r\nlr = (pe_left[i] >= 0) ?\r\nMDP5_PIPE_SW_PIX_EXT_LR_LEFT_RPT(pe_left[i]) :\r\nMDP5_PIPE_SW_PIX_EXT_LR_LEFT_OVF(pe_left[i]);\r\nlr |= (pe_right[i] >= 0) ?\r\nMDP5_PIPE_SW_PIX_EXT_LR_RIGHT_RPT(pe_right[i]) :\r\nMDP5_PIPE_SW_PIX_EXT_LR_RIGHT_OVF(pe_right[i]);\r\ntb = (pe_top[i] >= 0) ?\r\nMDP5_PIPE_SW_PIX_EXT_TB_TOP_RPT(pe_top[i]) :\r\nMDP5_PIPE_SW_PIX_EXT_TB_TOP_OVF(pe_top[i]);\r\ntb |= (pe_bottom[i] >= 0) ?\r\nMDP5_PIPE_SW_PIX_EXT_TB_BOTTOM_RPT(pe_bottom[i]) :\r\nMDP5_PIPE_SW_PIX_EXT_TB_BOTTOM_OVF(pe_bottom[i]);\r\nreq = MDP5_PIPE_SW_PIX_EXT_REQ_PIXELS_LEFT_RIGHT(roi_w +\r\npe_left[i] + pe_right[i]);\r\nreq |= MDP5_PIPE_SW_PIX_EXT_REQ_PIXELS_TOP_BOTTOM(roi_h +\r\npe_top[i] + pe_bottom[i]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SW_PIX_EXT_LR(pipe, i), lr);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SW_PIX_EXT_TB(pipe, i), tb);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SW_PIX_EXT_REQ_PIXELS(pipe, i), req);\r\nDBG("comp-%d (L/R): rpt=%d/%d, ovf=%d/%d, req=%d", i,\r\nFIELD(lr, MDP5_PIPE_SW_PIX_EXT_LR_LEFT_RPT),\r\nFIELD(lr, MDP5_PIPE_SW_PIX_EXT_LR_RIGHT_RPT),\r\nFIELD(lr, MDP5_PIPE_SW_PIX_EXT_LR_LEFT_OVF),\r\nFIELD(lr, MDP5_PIPE_SW_PIX_EXT_LR_RIGHT_OVF),\r\nFIELD(req, MDP5_PIPE_SW_PIX_EXT_REQ_PIXELS_LEFT_RIGHT));\r\nDBG("comp-%d (T/B): rpt=%d/%d, ovf=%d/%d, req=%d", i,\r\nFIELD(tb, MDP5_PIPE_SW_PIX_EXT_TB_TOP_RPT),\r\nFIELD(tb, MDP5_PIPE_SW_PIX_EXT_TB_BOTTOM_RPT),\r\nFIELD(tb, MDP5_PIPE_SW_PIX_EXT_TB_TOP_OVF),\r\nFIELD(tb, MDP5_PIPE_SW_PIX_EXT_TB_BOTTOM_OVF),\r\nFIELD(req, MDP5_PIPE_SW_PIX_EXT_REQ_PIXELS_TOP_BOTTOM));\r\n}\r\n}\r\nstatic int mdp5_plane_mode_set(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct drm_plane_state *pstate = plane->state;\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nconst struct mdp_format *format;\r\nuint32_t nplanes, config = 0;\r\nuint32_t phasex_step[COMP_MAX] = {0,}, phasey_step[COMP_MAX] = {0,};\r\nbool pe = mdp5_plane->caps & MDP_PIPE_CAP_SW_PIX_EXT;\r\nint pe_left[COMP_MAX], pe_right[COMP_MAX];\r\nint pe_top[COMP_MAX], pe_bottom[COMP_MAX];\r\nuint32_t hdecm = 0, vdecm = 0;\r\nuint32_t pix_format;\r\nbool vflip, hflip;\r\nunsigned long flags;\r\nint ret;\r\nnplanes = drm_format_num_planes(fb->pixel_format);\r\nif (WARN_ON(nplanes > pipe2nclients(pipe)))\r\nreturn -EINVAL;\r\nformat = to_mdp_format(msm_framebuffer_format(fb));\r\npix_format = format->base.pixel_format;\r\nsrc_x = src_x >> 16;\r\nsrc_y = src_y >> 16;\r\nsrc_w = src_w >> 16;\r\nsrc_h = src_h >> 16;\r\nDBG("%s: FB[%u] %u,%u,%u,%u -> CRTC[%u] %d,%d,%u,%u", mdp5_plane->name,\r\nfb->base.id, src_x, src_y, src_w, src_h,\r\ncrtc->base.id, crtc_x, crtc_y, crtc_w, crtc_h);\r\nif (mdp5_kms->smp) {\r\nret = mdp5_smp_request(mdp5_kms->smp,\r\nmdp5_plane->pipe, format, src_w, false);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (mdp5_kms->smp)\r\nmdp5_smp_configure(mdp5_kms->smp, pipe);\r\nret = calc_scalex_steps(plane, pix_format, src_w, crtc_w, phasex_step);\r\nif (ret)\r\nreturn ret;\r\nret = calc_scaley_steps(plane, pix_format, src_h, crtc_h, phasey_step);\r\nif (ret)\r\nreturn ret;\r\nif (mdp5_plane->caps & MDP_PIPE_CAP_SW_PIX_EXT) {\r\ncalc_pixel_ext(format, src_w, crtc_w, phasex_step,\r\npe_left, pe_right, true);\r\ncalc_pixel_ext(format, src_h, crtc_h, phasey_step,\r\npe_top, pe_bottom, false);\r\n}\r\nconfig |= get_scale_config(format, src_w, crtc_w, true);\r\nconfig |= get_scale_config(format, src_h, crtc_h, false);\r\nDBG("scale config = %x", config);\r\nhflip = !!(pstate->rotation & BIT(DRM_REFLECT_X));\r\nvflip = !!(pstate->rotation & BIT(DRM_REFLECT_Y));\r\nspin_lock_irqsave(&mdp5_plane->pipe_lock, flags);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_IMG_SIZE(pipe),\r\nMDP5_PIPE_SRC_IMG_SIZE_WIDTH(fb->width) |\r\nMDP5_PIPE_SRC_IMG_SIZE_HEIGHT(fb->height));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_SIZE(pipe),\r\nMDP5_PIPE_SRC_SIZE_WIDTH(src_w) |\r\nMDP5_PIPE_SRC_SIZE_HEIGHT(src_h));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_XY(pipe),\r\nMDP5_PIPE_SRC_XY_X(src_x) |\r\nMDP5_PIPE_SRC_XY_Y(src_y));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OUT_SIZE(pipe),\r\nMDP5_PIPE_OUT_SIZE_WIDTH(crtc_w) |\r\nMDP5_PIPE_OUT_SIZE_HEIGHT(crtc_h));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OUT_XY(pipe),\r\nMDP5_PIPE_OUT_XY_X(crtc_x) |\r\nMDP5_PIPE_OUT_XY_Y(crtc_y));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_FORMAT(pipe),\r\nMDP5_PIPE_SRC_FORMAT_A_BPC(format->bpc_a) |\r\nMDP5_PIPE_SRC_FORMAT_R_BPC(format->bpc_r) |\r\nMDP5_PIPE_SRC_FORMAT_G_BPC(format->bpc_g) |\r\nMDP5_PIPE_SRC_FORMAT_B_BPC(format->bpc_b) |\r\nCOND(format->alpha_enable, MDP5_PIPE_SRC_FORMAT_ALPHA_ENABLE) |\r\nMDP5_PIPE_SRC_FORMAT_CPP(format->cpp - 1) |\r\nMDP5_PIPE_SRC_FORMAT_UNPACK_COUNT(format->unpack_count - 1) |\r\nCOND(format->unpack_tight, MDP5_PIPE_SRC_FORMAT_UNPACK_TIGHT) |\r\nMDP5_PIPE_SRC_FORMAT_FETCH_TYPE(format->fetch_type) |\r\nMDP5_PIPE_SRC_FORMAT_CHROMA_SAMP(format->chroma_sample));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_UNPACK(pipe),\r\nMDP5_PIPE_SRC_UNPACK_ELEM0(format->unpack[0]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM1(format->unpack[1]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM2(format->unpack[2]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM3(format->unpack[3]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_OP_MODE(pipe),\r\n(hflip ? MDP5_PIPE_SRC_OP_MODE_FLIP_LR : 0) |\r\n(vflip ? MDP5_PIPE_SRC_OP_MODE_FLIP_UD : 0) |\r\nCOND(pe, MDP5_PIPE_SRC_OP_MODE_SW_PIX_EXT_OVERRIDE) |\r\nMDP5_PIPE_SRC_OP_MODE_BWC(BWC_LOSSLESS));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_ADDR_SW_STATUS(pipe), 0);\r\nif (mdp5_plane->caps & MDP_PIPE_CAP_SW_PIX_EXT)\r\nmdp5_write_pixel_ext(mdp5_kms, pipe, format,\r\nsrc_w, pe_left, pe_right,\r\nsrc_h, pe_top, pe_bottom);\r\nif (mdp5_plane->caps & MDP_PIPE_CAP_SCALE) {\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_PHASE_STEP_X(pipe),\r\nphasex_step[COMP_0]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_PHASE_STEP_Y(pipe),\r\nphasey_step[COMP_0]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_CR_PHASE_STEP_X(pipe),\r\nphasex_step[COMP_1_2]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_CR_PHASE_STEP_Y(pipe),\r\nphasey_step[COMP_1_2]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_DECIMATION(pipe),\r\nMDP5_PIPE_DECIMATION_VERT(vdecm) |\r\nMDP5_PIPE_DECIMATION_HORZ(hdecm));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_CONFIG(pipe), config);\r\n}\r\nif (mdp5_plane->caps & MDP_PIPE_CAP_CSC) {\r\nif (MDP_FORMAT_IS_YUV(format))\r\ncsc_enable(mdp5_kms, pipe,\r\nmdp_get_default_csc_cfg(CSC_YUV2RGB));\r\nelse\r\ncsc_disable(mdp5_kms, pipe);\r\n}\r\nset_scanout_locked(plane, fb);\r\nspin_unlock_irqrestore(&mdp5_plane->pipe_lock, flags);\r\nreturn ret;\r\n}\r\nvoid mdp5_plane_complete_flip(struct drm_plane *plane)\r\n{\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nDBG("%s: complete flip", mdp5_plane->name);\r\nif (mdp5_kms->smp)\r\nmdp5_smp_commit(mdp5_kms->smp, pipe);\r\nto_mdp5_plane_state(plane->state)->pending = false;\r\n}\r\nenum mdp5_pipe mdp5_plane_pipe(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nreturn mdp5_plane->pipe;\r\n}\r\nuint32_t mdp5_plane_get_flush(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nreturn mdp5_plane->flush_mask;\r\n}\r\nvoid mdp5_plane_complete_commit(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nif (!plane_enabled(plane->state) && mdp5_kms->smp) {\r\nDBG("%s: free SMP", mdp5_plane->name);\r\nmdp5_smp_release(mdp5_kms->smp, pipe);\r\n}\r\n}\r\nstruct drm_plane *mdp5_plane_init(struct drm_device *dev,\r\nenum mdp5_pipe pipe, bool private_plane, uint32_t reg_offset,\r\nuint32_t caps)\r\n{\r\nstruct drm_plane *plane = NULL;\r\nstruct mdp5_plane *mdp5_plane;\r\nint ret;\r\nenum drm_plane_type type;\r\nmdp5_plane = kzalloc(sizeof(*mdp5_plane), GFP_KERNEL);\r\nif (!mdp5_plane) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nplane = &mdp5_plane->base;\r\nmdp5_plane->pipe = pipe;\r\nmdp5_plane->name = pipe2name(pipe);\r\nmdp5_plane->caps = caps;\r\nmdp5_plane->nformats = mdp_get_formats(mdp5_plane->formats,\r\nARRAY_SIZE(mdp5_plane->formats),\r\n!pipe_supports_yuv(mdp5_plane->caps));\r\nmdp5_plane->flush_mask = mdp_ctl_flush_mask_pipe(pipe);\r\nmdp5_plane->reg_offset = reg_offset;\r\nspin_lock_init(&mdp5_plane->pipe_lock);\r\ntype = private_plane ? DRM_PLANE_TYPE_PRIMARY : DRM_PLANE_TYPE_OVERLAY;\r\nret = drm_universal_plane_init(dev, plane, 0xff, &mdp5_plane_funcs,\r\nmdp5_plane->formats, mdp5_plane->nformats,\r\ntype, NULL);\r\nif (ret)\r\ngoto fail;\r\ndrm_plane_helper_add(plane, &mdp5_plane_helper_funcs);\r\nmdp5_plane_install_properties(plane, &plane->base);\r\nreturn plane;\r\nfail:\r\nif (plane)\r\nmdp5_plane_destroy(plane);\r\nreturn ERR_PTR(ret);\r\n}

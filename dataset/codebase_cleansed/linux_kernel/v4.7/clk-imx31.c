static void __init _mx31_clocks_init(unsigned long fref)\r\n{\r\nvoid __iomem *base;\r\nstruct device_node *np;\r\nbase = ioremap(MX31_CCM_BASE_ADDR, SZ_4K);\r\nBUG_ON(!base);\r\nclk[dummy] = imx_clk_fixed("dummy", 0);\r\nclk[ckih] = imx_clk_fixed("ckih", fref);\r\nclk[ckil] = imx_clk_fixed("ckil", 32768);\r\nclk[mpll] = imx_clk_pllv1(IMX_PLLV1_IMX31, "mpll", "ckih", base + MXC_CCM_MPCTL);\r\nclk[spll] = imx_clk_pllv1(IMX_PLLV1_IMX31, "spll", "ckih", base + MXC_CCM_SRPCTL);\r\nclk[upll] = imx_clk_pllv1(IMX_PLLV1_IMX31, "upll", "ckih", base + MXC_CCM_UPCTL);\r\nclk[mcu_main] = imx_clk_mux("mcu_main", base + MXC_CCM_PMCR0, 31, 1, mcu_main_sel, ARRAY_SIZE(mcu_main_sel));\r\nclk[hsp] = imx_clk_divider("hsp", "mcu_main", base + MXC_CCM_PDR0, 11, 3);\r\nclk[ahb] = imx_clk_divider("ahb", "mcu_main", base + MXC_CCM_PDR0, 3, 3);\r\nclk[nfc] = imx_clk_divider("nfc", "ahb", base + MXC_CCM_PDR0, 8, 3);\r\nclk[ipg] = imx_clk_divider("ipg", "ahb", base + MXC_CCM_PDR0, 6, 2);\r\nclk[per_div] = imx_clk_divider("per_div", "upll", base + MXC_CCM_PDR0, 16, 5);\r\nclk[per] = imx_clk_mux("per", base + MXC_CCM_CCMR, 24, 1, per_sel, ARRAY_SIZE(per_sel));\r\nclk[csi] = imx_clk_mux("csi_sel", base + MXC_CCM_CCMR, 25, 1, csi_sel, ARRAY_SIZE(csi_sel));\r\nclk[fir] = imx_clk_mux("fir_sel", base + MXC_CCM_CCMR, 11, 2, fir_sel, ARRAY_SIZE(fir_sel));\r\nclk[csi_div] = imx_clk_divider("csi_div", "csi_sel", base + MXC_CCM_PDR0, 23, 9);\r\nclk[usb_div_pre] = imx_clk_divider("usb_div_pre", "upll", base + MXC_CCM_PDR1, 30, 2);\r\nclk[usb_div_post] = imx_clk_divider("usb_div_post", "usb_div_pre", base + MXC_CCM_PDR1, 27, 3);\r\nclk[fir_div_pre] = imx_clk_divider("fir_div_pre", "fir_sel", base + MXC_CCM_PDR1, 24, 3);\r\nclk[fir_div_post] = imx_clk_divider("fir_div_post", "fir_div_pre", base + MXC_CCM_PDR1, 23, 6);\r\nclk[sdhc1_gate] = imx_clk_gate2("sdhc1_gate", "per", base + MXC_CCM_CGR0, 0);\r\nclk[sdhc2_gate] = imx_clk_gate2("sdhc2_gate", "per", base + MXC_CCM_CGR0, 2);\r\nclk[gpt_gate] = imx_clk_gate2("gpt_gate", "per", base + MXC_CCM_CGR0, 4);\r\nclk[epit1_gate] = imx_clk_gate2("epit1_gate", "per", base + MXC_CCM_CGR0, 6);\r\nclk[epit2_gate] = imx_clk_gate2("epit2_gate", "per", base + MXC_CCM_CGR0, 8);\r\nclk[iim_gate] = imx_clk_gate2("iim_gate", "ipg", base + MXC_CCM_CGR0, 10);\r\nclk[ata_gate] = imx_clk_gate2("ata_gate", "ipg", base + MXC_CCM_CGR0, 12);\r\nclk[sdma_gate] = imx_clk_gate2("sdma_gate", "ahb", base + MXC_CCM_CGR0, 14);\r\nclk[cspi3_gate] = imx_clk_gate2("cspi3_gate", "ipg", base + MXC_CCM_CGR0, 16);\r\nclk[rng_gate] = imx_clk_gate2("rng_gate", "ipg", base + MXC_CCM_CGR0, 18);\r\nclk[uart1_gate] = imx_clk_gate2("uart1_gate", "per", base + MXC_CCM_CGR0, 20);\r\nclk[uart2_gate] = imx_clk_gate2("uart2_gate", "per", base + MXC_CCM_CGR0, 22);\r\nclk[ssi1_gate] = imx_clk_gate2("ssi1_gate", "spll", base + MXC_CCM_CGR0, 24);\r\nclk[i2c1_gate] = imx_clk_gate2("i2c1_gate", "per", base + MXC_CCM_CGR0, 26);\r\nclk[i2c2_gate] = imx_clk_gate2("i2c2_gate", "per", base + MXC_CCM_CGR0, 28);\r\nclk[i2c3_gate] = imx_clk_gate2("i2c3_gate", "per", base + MXC_CCM_CGR0, 30);\r\nclk[hantro_gate] = imx_clk_gate2("hantro_gate", "per", base + MXC_CCM_CGR1, 0);\r\nclk[mstick1_gate] = imx_clk_gate2("mstick1_gate", "per", base + MXC_CCM_CGR1, 2);\r\nclk[mstick2_gate] = imx_clk_gate2("mstick2_gate", "per", base + MXC_CCM_CGR1, 4);\r\nclk[csi_gate] = imx_clk_gate2("csi_gate", "csi_div", base + MXC_CCM_CGR1, 6);\r\nclk[rtc_gate] = imx_clk_gate2("rtc_gate", "ipg", base + MXC_CCM_CGR1, 8);\r\nclk[wdog_gate] = imx_clk_gate2("wdog_gate", "ipg", base + MXC_CCM_CGR1, 10);\r\nclk[pwm_gate] = imx_clk_gate2("pwm_gate", "per", base + MXC_CCM_CGR1, 12);\r\nclk[sim_gate] = imx_clk_gate2("sim_gate", "per", base + MXC_CCM_CGR1, 14);\r\nclk[ect_gate] = imx_clk_gate2("ect_gate", "per", base + MXC_CCM_CGR1, 16);\r\nclk[usb_gate] = imx_clk_gate2("usb_gate", "ahb", base + MXC_CCM_CGR1, 18);\r\nclk[kpp_gate] = imx_clk_gate2("kpp_gate", "ipg", base + MXC_CCM_CGR1, 20);\r\nclk[ipu_gate] = imx_clk_gate2("ipu_gate", "hsp", base + MXC_CCM_CGR1, 22);\r\nclk[uart3_gate] = imx_clk_gate2("uart3_gate", "per", base + MXC_CCM_CGR1, 24);\r\nclk[uart4_gate] = imx_clk_gate2("uart4_gate", "per", base + MXC_CCM_CGR1, 26);\r\nclk[uart5_gate] = imx_clk_gate2("uart5_gate", "per", base + MXC_CCM_CGR1, 28);\r\nclk[owire_gate] = imx_clk_gate2("owire_gate", "per", base + MXC_CCM_CGR1, 30);\r\nclk[ssi2_gate] = imx_clk_gate2("ssi2_gate", "spll", base + MXC_CCM_CGR2, 0);\r\nclk[cspi1_gate] = imx_clk_gate2("cspi1_gate", "ipg", base + MXC_CCM_CGR2, 2);\r\nclk[cspi2_gate] = imx_clk_gate2("cspi2_gate", "ipg", base + MXC_CCM_CGR2, 4);\r\nclk[gacc_gate] = imx_clk_gate2("gacc_gate", "per", base + MXC_CCM_CGR2, 6);\r\nclk[emi_gate] = imx_clk_gate2("emi_gate", "ahb", base + MXC_CCM_CGR2, 8);\r\nclk[rtic_gate] = imx_clk_gate2("rtic_gate", "ahb", base + MXC_CCM_CGR2, 10);\r\nclk[firi_gate] = imx_clk_gate2("firi_gate", "upll", base+MXC_CCM_CGR2, 12);\r\nimx_check_clocks(clk, ARRAY_SIZE(clk));\r\nclk_set_parent(clk[csi], clk[upll]);\r\nclk_prepare_enable(clk[emi_gate]);\r\nclk_prepare_enable(clk[iim_gate]);\r\nmx31_revision();\r\nclk_disable_unprepare(clk[iim_gate]);\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,imx31-ccm");\r\nif (np) {\r\nclk_data.clks = clk;\r\nclk_data.clk_num = ARRAY_SIZE(clk);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\n}\r\n}\r\nint __init mx31_clocks_init(void)\r\n{\r\nu32 fref = 26000000;\r\n_mx31_clocks_init(fref);\r\nclk_register_clkdev(clk[gpt_gate], "per", "imx-gpt.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx-gpt.0");\r\nclk_register_clkdev(clk[cspi1_gate], NULL, "imx31-cspi.0");\r\nclk_register_clkdev(clk[cspi2_gate], NULL, "imx31-cspi.1");\r\nclk_register_clkdev(clk[cspi3_gate], NULL, "imx31-cspi.2");\r\nclk_register_clkdev(clk[pwm_gate], "pwm", NULL);\r\nclk_register_clkdev(clk[wdog_gate], NULL, "imx2-wdt.0");\r\nclk_register_clkdev(clk[ckil], "ref", "imx21-rtc");\r\nclk_register_clkdev(clk[rtc_gate], "ipg", "imx21-rtc");\r\nclk_register_clkdev(clk[epit1_gate], "epit", NULL);\r\nclk_register_clkdev(clk[epit2_gate], "epit", NULL);\r\nclk_register_clkdev(clk[nfc], NULL, "imx27-nand.0");\r\nclk_register_clkdev(clk[ipu_gate], NULL, "ipu-core");\r\nclk_register_clkdev(clk[ipu_gate], NULL, "mx3_sdc_fb");\r\nclk_register_clkdev(clk[kpp_gate], NULL, "imx-keypad");\r\nclk_register_clkdev(clk[usb_div_post], "per", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_gate], "ahb", "mxc-ehci.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_div_post], "per", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_gate], "ahb", "mxc-ehci.1");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_div_post], "per", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usb_gate], "ahb", "mxc-ehci.2");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usb_div_post], "per", "imx-udc-mx27");\r\nclk_register_clkdev(clk[usb_gate], "ahb", "imx-udc-mx27");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx-udc-mx27");\r\nclk_register_clkdev(clk[csi_gate], NULL, "mx3-camera.0");\r\nclk_register_clkdev(clk[uart1_gate], "per", "imx21-uart.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.0");\r\nclk_register_clkdev(clk[uart2_gate], "per", "imx21-uart.1");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.1");\r\nclk_register_clkdev(clk[uart3_gate], "per", "imx21-uart.2");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.2");\r\nclk_register_clkdev(clk[uart4_gate], "per", "imx21-uart.3");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.3");\r\nclk_register_clkdev(clk[uart5_gate], "per", "imx21-uart.4");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.4");\r\nclk_register_clkdev(clk[i2c1_gate], NULL, "imx21-i2c.0");\r\nclk_register_clkdev(clk[i2c2_gate], NULL, "imx21-i2c.1");\r\nclk_register_clkdev(clk[i2c3_gate], NULL, "imx21-i2c.2");\r\nclk_register_clkdev(clk[owire_gate], NULL, "mxc_w1.0");\r\nclk_register_clkdev(clk[sdhc1_gate], NULL, "imx31-mmc.0");\r\nclk_register_clkdev(clk[sdhc2_gate], NULL, "imx31-mmc.1");\r\nclk_register_clkdev(clk[ssi1_gate], NULL, "imx-ssi.0");\r\nclk_register_clkdev(clk[ssi2_gate], NULL, "imx-ssi.1");\r\nclk_register_clkdev(clk[firi_gate], "firi", NULL);\r\nclk_register_clkdev(clk[ata_gate], NULL, "pata_imx");\r\nclk_register_clkdev(clk[rtic_gate], "rtic", NULL);\r\nclk_register_clkdev(clk[rng_gate], NULL, "mxc_rnga");\r\nclk_register_clkdev(clk[sdma_gate], NULL, "imx31-sdma");\r\nclk_register_clkdev(clk[iim_gate], "iim", NULL);\r\nimx_register_uart_clocks(uart_clks);\r\nmxc_timer_init(MX31_GPT1_BASE_ADDR, MX31_INT_GPT, GPT_TYPE_IMX31);\r\nreturn 0;\r\n}\r\nint __init mx31_clocks_init_dt(void)\r\n{\r\nstruct device_node *np;\r\nu32 fref = 26000000;\r\nfor_each_compatible_node(np, NULL, "fixed-clock") {\r\nif (!of_device_is_compatible(np, "fsl,imx-osc26m"))\r\ncontinue;\r\nif (!of_property_read_u32(np, "clock-frequency", &fref)) {\r\nof_node_put(np);\r\nbreak;\r\n}\r\n}\r\n_mx31_clocks_init(fref);\r\nreturn 0;\r\n}

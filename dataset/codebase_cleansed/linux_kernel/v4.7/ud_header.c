__sum16 ib_ud_ip4_csum(struct ib_ud_header *header)\r\n{\r\nstruct iphdr iph;\r\niph.ihl = 5;\r\niph.version = 4;\r\niph.tos = header->ip4.tos;\r\niph.tot_len = header->ip4.tot_len;\r\niph.id = header->ip4.id;\r\niph.frag_off = header->ip4.frag_off;\r\niph.ttl = header->ip4.ttl;\r\niph.protocol = header->ip4.protocol;\r\niph.check = 0;\r\niph.saddr = header->ip4.saddr;\r\niph.daddr = header->ip4.daddr;\r\nreturn ip_fast_csum((u8 *)&iph, iph.ihl);\r\n}\r\nint ib_ud_header_init(int payload_bytes,\r\nint lrh_present,\r\nint eth_present,\r\nint vlan_present,\r\nint grh_present,\r\nint ip_version,\r\nint udp_present,\r\nint immediate_present,\r\nstruct ib_ud_header *header)\r\n{\r\nsize_t udp_bytes = udp_present ? IB_UDP_BYTES : 0;\r\ngrh_present = grh_present && !ip_version;\r\nmemset(header, 0, sizeof *header);\r\nif (udp_present && ip_version != 4 && ip_version != 6)\r\nreturn -EINVAL;\r\nif (lrh_present) {\r\nu16 packet_length;\r\nheader->lrh.link_version = 0;\r\nheader->lrh.link_next_header =\r\ngrh_present ? IB_LNH_IBA_GLOBAL : IB_LNH_IBA_LOCAL;\r\npacket_length = (IB_LRH_BYTES +\r\nIB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\n(grh_present ? IB_GRH_BYTES : 0) +\r\npayload_bytes +\r\n4 +\r\n3) / 4;\r\nheader->lrh.packet_length = cpu_to_be16(packet_length);\r\n}\r\nif (vlan_present)\r\nheader->eth.type = cpu_to_be16(ETH_P_8021Q);\r\nif (ip_version == 6 || grh_present) {\r\nheader->grh.ip_version = 6;\r\nheader->grh.payload_length =\r\ncpu_to_be16((udp_bytes +\r\nIB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\npayload_bytes +\r\n4 +\r\n3) & ~3);\r\nheader->grh.next_header = udp_present ? IPPROTO_UDP : 0x1b;\r\n}\r\nif (ip_version == 4) {\r\nheader->ip4.ver = 4;\r\nheader->ip4.hdr_len = 5;\r\nheader->ip4.tot_len =\r\ncpu_to_be16(IB_IP4_BYTES +\r\nudp_bytes +\r\nIB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\npayload_bytes +\r\n4);\r\nheader->ip4.protocol = IPPROTO_UDP;\r\n}\r\nif (udp_present && ip_version)\r\nheader->udp.length =\r\ncpu_to_be16(IB_UDP_BYTES +\r\nIB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\npayload_bytes +\r\n4);\r\nif (immediate_present)\r\nheader->bth.opcode = IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE;\r\nelse\r\nheader->bth.opcode = IB_OPCODE_UD_SEND_ONLY;\r\nheader->bth.pad_count = (4 - payload_bytes) & 3;\r\nheader->bth.transport_header_version = 0;\r\nheader->lrh_present = lrh_present;\r\nheader->eth_present = eth_present;\r\nheader->vlan_present = vlan_present;\r\nheader->grh_present = grh_present || (ip_version == 6);\r\nheader->ipv4_present = ip_version == 4;\r\nheader->udp_present = udp_present;\r\nheader->immediate_present = immediate_present;\r\nreturn 0;\r\n}\r\nint ib_ud_header_pack(struct ib_ud_header *header,\r\nvoid *buf)\r\n{\r\nint len = 0;\r\nif (header->lrh_present) {\r\nib_pack(lrh_table, ARRAY_SIZE(lrh_table),\r\n&header->lrh, buf + len);\r\nlen += IB_LRH_BYTES;\r\n}\r\nif (header->eth_present) {\r\nib_pack(eth_table, ARRAY_SIZE(eth_table),\r\n&header->eth, buf + len);\r\nlen += IB_ETH_BYTES;\r\n}\r\nif (header->vlan_present) {\r\nib_pack(vlan_table, ARRAY_SIZE(vlan_table),\r\n&header->vlan, buf + len);\r\nlen += IB_VLAN_BYTES;\r\n}\r\nif (header->grh_present) {\r\nib_pack(grh_table, ARRAY_SIZE(grh_table),\r\n&header->grh, buf + len);\r\nlen += IB_GRH_BYTES;\r\n}\r\nif (header->ipv4_present) {\r\nib_pack(ip4_table, ARRAY_SIZE(ip4_table),\r\n&header->ip4, buf + len);\r\nlen += IB_IP4_BYTES;\r\n}\r\nif (header->udp_present) {\r\nib_pack(udp_table, ARRAY_SIZE(udp_table),\r\n&header->udp, buf + len);\r\nlen += IB_UDP_BYTES;\r\n}\r\nib_pack(bth_table, ARRAY_SIZE(bth_table),\r\n&header->bth, buf + len);\r\nlen += IB_BTH_BYTES;\r\nib_pack(deth_table, ARRAY_SIZE(deth_table),\r\n&header->deth, buf + len);\r\nlen += IB_DETH_BYTES;\r\nif (header->immediate_present) {\r\nmemcpy(buf + len, &header->immediate_data, sizeof header->immediate_data);\r\nlen += sizeof header->immediate_data;\r\n}\r\nreturn len;\r\n}\r\nint ib_ud_header_unpack(void *buf,\r\nstruct ib_ud_header *header)\r\n{\r\nib_unpack(lrh_table, ARRAY_SIZE(lrh_table),\r\nbuf, &header->lrh);\r\nbuf += IB_LRH_BYTES;\r\nif (header->lrh.link_version != 0) {\r\npr_warn("Invalid LRH.link_version %d\n",\r\nheader->lrh.link_version);\r\nreturn -EINVAL;\r\n}\r\nswitch (header->lrh.link_next_header) {\r\ncase IB_LNH_IBA_LOCAL:\r\nheader->grh_present = 0;\r\nbreak;\r\ncase IB_LNH_IBA_GLOBAL:\r\nheader->grh_present = 1;\r\nib_unpack(grh_table, ARRAY_SIZE(grh_table),\r\nbuf, &header->grh);\r\nbuf += IB_GRH_BYTES;\r\nif (header->grh.ip_version != 6) {\r\npr_warn("Invalid GRH.ip_version %d\n",\r\nheader->grh.ip_version);\r\nreturn -EINVAL;\r\n}\r\nif (header->grh.next_header != 0x1b) {\r\npr_warn("Invalid GRH.next_header 0x%02x\n",\r\nheader->grh.next_header);\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\npr_warn("Invalid LRH.link_next_header %d\n",\r\nheader->lrh.link_next_header);\r\nreturn -EINVAL;\r\n}\r\nib_unpack(bth_table, ARRAY_SIZE(bth_table),\r\nbuf, &header->bth);\r\nbuf += IB_BTH_BYTES;\r\nswitch (header->bth.opcode) {\r\ncase IB_OPCODE_UD_SEND_ONLY:\r\nheader->immediate_present = 0;\r\nbreak;\r\ncase IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE:\r\nheader->immediate_present = 1;\r\nbreak;\r\ndefault:\r\npr_warn("Invalid BTH.opcode 0x%02x\n", header->bth.opcode);\r\nreturn -EINVAL;\r\n}\r\nif (header->bth.transport_header_version != 0) {\r\npr_warn("Invalid BTH.transport_header_version %d\n",\r\nheader->bth.transport_header_version);\r\nreturn -EINVAL;\r\n}\r\nib_unpack(deth_table, ARRAY_SIZE(deth_table),\r\nbuf, &header->deth);\r\nbuf += IB_DETH_BYTES;\r\nif (header->immediate_present)\r\nmemcpy(&header->immediate_data, buf, sizeof header->immediate_data);\r\nreturn 0;\r\n}

static inline unsigned long clkc_readl(unsigned reg)\r\n{\r\nreturn readl(sirfsoc_clk_vbase + reg);\r\n}\r\nstatic inline void clkc_writel(u32 val, unsigned reg)\r\n{\r\nwritel(val, sirfsoc_clk_vbase + reg);\r\n}\r\nstatic unsigned long pll_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long fin = parent_rate;\r\nstruct clk_pll *clk = to_pllclk(hw);\r\nu64 rate;\r\nu32 regctrl0 = clkc_readl(clk->regofs + SIRFSOC_CLKC_MEMPLL_AB_CTRL0 -\r\nSIRFSOC_CLKC_MEMPLL_AB_FREQ);\r\nu32 regfreq = clkc_readl(clk->regofs);\r\nu32 regssc = clkc_readl(clk->regofs + SIRFSOC_CLKC_MEMPLL_AB_SSC -\r\nSIRFSOC_CLKC_MEMPLL_AB_FREQ);\r\nu32 nr = (regfreq >> 16 & (BIT(3) - 1)) + 1;\r\nu32 nf = (regfreq & (BIT(9) - 1)) + 1;\r\nu32 ssdiv = regssc >> 8 & (BIT(12) - 1);\r\nu32 ssdepth = regssc >> 20 & (BIT(2) - 1);\r\nu32 ssmod = regssc & (BIT(8) - 1);\r\nif (regctrl0 & SIRFSOC_ABPLL_CTRL0_BYPASS)\r\nreturn fin;\r\nif (regctrl0 & SIRFSOC_ABPLL_CTRL0_SSEN) {\r\nrate = fin;\r\nrate *= 1 << 24;\r\ndo_div(rate, nr);\r\ndo_div(rate, (256 * ((ssdiv >> ssdepth) << ssdepth)\r\n+ (ssmod << ssdepth)));\r\n} else {\r\nrate = 2 * fin;\r\nrate *= nf;\r\ndo_div(rate, nr);\r\n}\r\nreturn rate;\r\n}\r\nstatic int dto_clk_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nint reg;\r\nreg = clk->src_offset + SIRFSOC_CLKC_AUDIO_DTO_ENA - SIRFSOC_CLKC_AUDIO_DTO_SRC;\r\nreturn !!(clkc_readl(reg) & BIT(0));\r\n}\r\nstatic int dto_clk_enable(struct clk_hw *hw)\r\n{\r\nu32 val, reg;\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nreg = clk->src_offset + SIRFSOC_CLKC_AUDIO_DTO_ENA - SIRFSOC_CLKC_AUDIO_DTO_SRC;\r\nval = clkc_readl(reg) | BIT(0);\r\nclkc_writel(val, reg);\r\nreturn 0;\r\n}\r\nstatic void dto_clk_disable(struct clk_hw *hw)\r\n{\r\nu32 val, reg;\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nreg = clk->src_offset + SIRFSOC_CLKC_AUDIO_DTO_ENA - SIRFSOC_CLKC_AUDIO_DTO_SRC;\r\nval = clkc_readl(reg) & ~BIT(0);\r\nclkc_writel(val, reg);\r\n}\r\nstatic unsigned long dto_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu64 rate = parent_rate;\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nu32 finc = clkc_readl(clk->inc_offset);\r\nu32 droff = clkc_readl(clk->src_offset + SIRFSOC_CLKC_AUDIO_DTO_DROFF - SIRFSOC_CLKC_AUDIO_DTO_SRC);\r\nrate *= finc;\r\nif (droff & BIT(0))\r\ndo_div(rate, DTO_RESL_NORMAL);\r\nelse\r\ndo_div(rate, DTO_RESL_DOUBLE);\r\nreturn rate;\r\n}\r\nstatic long dto_clk_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nu64 dividend = rate * DTO_RESL_DOUBLE;\r\ndo_div(dividend, *parent_rate);\r\ndividend *= *parent_rate;\r\ndo_div(dividend, DTO_RESL_DOUBLE);\r\nreturn dividend;\r\n}\r\nstatic int dto_clk_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nu64 dividend = rate * DTO_RESL_DOUBLE;\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\ndo_div(dividend, parent_rate);\r\nclkc_writel(0, clk->src_offset + SIRFSOC_CLKC_AUDIO_DTO_DROFF - SIRFSOC_CLKC_AUDIO_DTO_SRC);\r\nclkc_writel(dividend, clk->inc_offset);\r\nreturn 0;\r\n}\r\nstatic u8 dto_clk_get_parent(struct clk_hw *hw)\r\n{\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nreturn clkc_readl(clk->src_offset);\r\n}\r\nstatic int dto_clk_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct clk_dto *clk = to_dtoclk(hw);\r\nclkc_writel(index, clk->src_offset);\r\nreturn 0;\r\n}\r\nstatic int unit_clk_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_unit *clk = to_unitclk(hw);\r\nu32 reg;\r\nreg = clk->regofs + SIRFSOC_CLKC_ROOT_CLK_EN0_STAT - SIRFSOC_CLKC_ROOT_CLK_EN0_SET;\r\nreturn !!(clkc_readl(reg) & BIT(clk->bit));\r\n}\r\nstatic int unit_clk_enable(struct clk_hw *hw)\r\n{\r\nu32 reg;\r\nstruct clk_unit *clk = to_unitclk(hw);\r\nunsigned long flags;\r\nreg = clk->regofs;\r\nspin_lock_irqsave(clk->lock, flags);\r\nclkc_writel(BIT(clk->bit), reg);\r\nif (clk->type == CLK_UNIT_NOC_CLOCK)\r\nclkc_writel(BIT(clk->idle_bit), SIRFSOC_NOC_CLK_IDLEREQ_CLR);\r\nelse if (clk->type == CLK_UNIT_NOC_SOCKET)\r\nclkc_writel(BIT(clk->idle_bit), SIRFSOC_NOC_CLK_SLVRDY_SET);\r\nspin_unlock_irqrestore(clk->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void unit_clk_disable(struct clk_hw *hw)\r\n{\r\nu32 reg;\r\nu32 i = 0;\r\nstruct clk_unit *clk = to_unitclk(hw);\r\nunsigned long flags;\r\nreg = clk->regofs + SIRFSOC_CLKC_ROOT_CLK_EN0_CLR - SIRFSOC_CLKC_ROOT_CLK_EN0_SET;\r\nspin_lock_irqsave(clk->lock, flags);\r\nif (clk->type == CLK_UNIT_NOC_CLOCK) {\r\nclkc_writel(BIT(clk->idle_bit), SIRFSOC_NOC_CLK_IDLEREQ_SET);\r\nwhile (!(clkc_readl(SIRFSOC_NOC_CLK_IDLE_STATUS) &\r\nBIT(clk->idle_bit)) && (i++ < 100)) {\r\ncpu_relax();\r\nudelay(10);\r\n}\r\nif (i == 100) {\r\npr_err("unit NoC Clock disconnect Error:timeout\n");\r\nclkc_writel(BIT(clk->idle_bit), SIRFSOC_NOC_CLK_IDLEREQ_CLR);\r\ngoto err;\r\n}\r\n} else if (clk->type == CLK_UNIT_NOC_SOCKET)\r\nclkc_writel(BIT(clk->idle_bit), SIRFSOC_NOC_CLK_SLVRDY_CLR);\r\nclkc_writel(BIT(clk->bit), reg);\r\nerr:\r\nspin_unlock_irqrestore(clk->lock, flags);\r\n}\r\nstatic struct clk * __init\r\natlas7_unit_clk_register(struct device *dev, const char *name,\r\nconst char * const parent_name, unsigned long flags,\r\nu32 regofs, u8 bit, u32 type, u8 idle_bit, spinlock_t *lock)\r\n{\r\nstruct clk *clk;\r\nstruct clk_unit *unit;\r\nstruct clk_init_data init;\r\nunit = kzalloc(sizeof(*unit), GFP_KERNEL);\r\nif (!unit)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.ops = &unit_clk_ops;\r\ninit.flags = flags;\r\nunit->hw.init = &init;\r\nunit->regofs = regofs;\r\nunit->bit = bit;\r\nunit->type = type;\r\nunit->idle_bit = idle_bit;\r\nunit->lock = lock;\r\nclk = clk_register(dev, &unit->hw);\r\nif (IS_ERR(clk))\r\nkfree(unit);\r\nreturn clk;\r\n}\r\nstatic int atlas7_reset_module(struct reset_controller_dev *rcdev,\r\nunsigned long reset_idx)\r\n{\r\nstruct atlas7_reset_desc *reset = &atlas7_reset_unit[reset_idx];\r\nunsigned long flags;\r\nspin_lock_irqsave(reset->lock, flags);\r\nif (clkc_readl(reset->clk_ofs + 8) & (1 << reset->clk_bit)) {\r\nclkc_writel(1 << reset->rst_bit, reset->rst_ofs + 4);\r\nudelay(2);\r\nclkc_writel(1 << reset->clk_bit, reset->clk_ofs + 4);\r\nclkc_writel(1 << reset->rst_bit, reset->rst_ofs);\r\nclkc_writel(1 << reset->clk_bit, reset->clk_ofs);\r\n} else {\r\nclkc_writel(1 << reset->rst_bit, reset->rst_ofs + 4);\r\nclkc_writel(1 << reset->clk_bit, reset->clk_ofs);\r\nudelay(2);\r\nclkc_writel(1 << reset->clk_bit, reset->clk_ofs + 4);\r\nclkc_writel(1 << reset->rst_bit, reset->rst_ofs);\r\n}\r\nspin_unlock_irqrestore(reset->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void __init atlas7_clk_init(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nstruct atlas7_div_init_data *div;\r\nstruct atlas7_mux_init_data *mux;\r\nstruct atlas7_unit_init_data *unit;\r\nint i;\r\nint ret;\r\nsirfsoc_clk_vbase = of_iomap(np, 0);\r\nif (!sirfsoc_clk_vbase)\r\npanic("unable to map clkc registers\n");\r\nof_node_put(np);\r\nclk = clk_register(NULL, &clk_cpupll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_mempll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_sys0pll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_sys1pll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_sys2pll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_sys3pll.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "cpupll_div1", "cpupll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "cpupll_div2", "cpupll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "cpupll_div3", "cpupll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "mempll_div1", "mempll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "mempll_div2", "mempll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "mempll_div3", "mempll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys0pll_div1", "sys0pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys0pll_div2", "sys0pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys0pll_div3", "sys0pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_fixed_factor(NULL, "sys0pll_fixdiv", "sys0pll_vco",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk = clk_register_divider_table(NULL, "sys1pll_div1", "sys1pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys1pll_div2", "sys1pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys1pll_div3", "sys1pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_fixed_factor(NULL, "sys1pll_fixdiv", "sys1pll_vco",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk = clk_register_divider_table(NULL, "sys2pll_div1", "sys2pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys2pll_div2", "sys2pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys2pll_div3", "sys2pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_fixed_factor(NULL, "sys2pll_fixdiv", "sys2pll_vco",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk = clk_register_divider_table(NULL, "sys3pll_div1", "sys3pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1, 0, 3, 0,\r\npll_div_table, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys3pll_div2", "sys3pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1, 4, 3, 0,\r\npll_div_table, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_divider_table(NULL, "sys3pll_div3", "sys3pll_vco", 0,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1, 8, 3, 0,\r\npll_div_table, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_fixed_factor(NULL, "sys3pll_fixdiv", "sys3pll_vco",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nBUG_ON(!clk);\r\nclk = clk_register_fixed_factor(NULL, "xinw_fixdiv_btslow", "xinw",\r\nCLK_SET_RATE_PARENT, 1, 4);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "cpupll_clk1", "cpupll_div1",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1,\r\n12, 0, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "cpupll_clk2", "cpupll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1,\r\n13, 0, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "cpupll_clk3", "cpupll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_CPUPLL_AB_CTRL1,\r\n14, 0, &cpupll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "mempll_clk1", "mempll_div1",\r\nCLK_SET_RATE_PARENT | CLK_IGNORE_UNUSED,\r\nsirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1,\r\n12, 0, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "mempll_clk2", "mempll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1,\r\n13, 0, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "mempll_clk3", "mempll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_MEMPLL_AB_CTRL1,\r\n14, 0, &mempll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys0pll_clk1", "sys0pll_div1",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1,\r\n12, 0, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys0pll_clk2", "sys0pll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1,\r\n13, 0, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys0pll_clk3", "sys0pll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS0PLL_AB_CTRL1,\r\n14, 0, &sys0pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys1pll_clk1", "sys1pll_div1",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1,\r\n12, 0, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys1pll_clk2", "sys1pll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1,\r\n13, 0, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys1pll_clk3", "sys1pll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS1PLL_AB_CTRL1,\r\n14, 0, &sys1pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys2pll_clk1", "sys2pll_div1",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1,\r\n12, 0, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys2pll_clk2", "sys2pll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1,\r\n13, 0, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys2pll_clk3", "sys2pll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS2PLL_AB_CTRL1,\r\n14, 0, &sys2pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys3pll_clk1", "sys3pll_div1",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1,\r\n12, 0, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys3pll_clk2", "sys3pll_div2",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1,\r\n13, 0, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, "sys3pll_clk3", "sys3pll_div3",\r\nCLK_SET_RATE_PARENT, sirfsoc_clk_vbase + SIRFSOC_CLKC_SYS3PLL_AB_CTRL1,\r\n14, 0, &sys3pll_ctrl1_lock);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_audio_dto.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_disp0_dto.hw);\r\nBUG_ON(!clk);\r\nclk = clk_register(NULL, &clk_disp1_dto.hw);\r\nBUG_ON(!clk);\r\nfor (i = 0; i < ARRAY_SIZE(divider_list); i++) {\r\ndiv = &divider_list[i];\r\nclk = clk_register_divider(NULL, div->div_name,\r\ndiv->parent_name, div->divider_flags, sirfsoc_clk_vbase + div->div_offset,\r\ndiv->shift, div->width, 0, div->lock);\r\nBUG_ON(!clk);\r\nclk = clk_register_gate(NULL, div->gate_name, div->div_name,\r\ndiv->gate_flags, sirfsoc_clk_vbase + div->gate_offset,\r\ndiv->gate_bit, 0, div->lock);\r\nBUG_ON(!clk);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(mux_list); i++) {\r\nmux = &mux_list[i];\r\nclk = clk_register_mux(NULL, mux->mux_name, mux->parent_names,\r\nmux->parent_num, mux->flags,\r\nsirfsoc_clk_vbase + mux->mux_offset,\r\nmux->shift, mux->width,\r\nmux->mux_flags, NULL);\r\natlas7_clks[ARRAY_SIZE(unit_list) + i] = clk;\r\nBUG_ON(!clk);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(unit_list); i++) {\r\nunit = &unit_list[i];\r\natlas7_clks[i] = atlas7_unit_clk_register(NULL, unit->unit_name, unit->parent_name,\r\nunit->flags, unit->regofs, unit->bit, unit->type, unit->idle_bit, unit->lock);\r\nBUG_ON(!atlas7_clks[i]);\r\n}\r\nclk_data.clks = atlas7_clks;\r\nclk_data.clk_num = ARRAY_SIZE(unit_list) + ARRAY_SIZE(mux_list);\r\nret = of_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\nBUG_ON(ret);\r\natlas7_rst_ctlr.of_node = np;\r\natlas7_rst_ctlr.nr_resets = ARRAY_SIZE(atlas7_reset_unit);\r\nreset_controller_register(&atlas7_rst_ctlr);\r\n}

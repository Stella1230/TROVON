static int fm2fb_blank(int blank, struct fb_info *info)\r\n{\r\nunsigned char t = FRAMEMASTER_ROM;\r\nif (!blank)\r\nt |= FRAMEMASTER_ENABLE | FRAMEMASTER_NOLACE;\r\nfm2fb_reg[0] = t;\r\nreturn 0;\r\n}\r\nstatic int fm2fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nif (regno < 16) {\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\n((u32*)(info->pseudo_palette))[regno] = (red << 16) |\r\n(green << 8) | blue;\r\n}\r\nreturn 0;\r\n}\r\nstatic int fm2fb_probe(struct zorro_dev *z, const struct zorro_device_id *id)\r\n{\r\nstruct fb_info *info;\r\nunsigned long *ptr;\r\nint is_fm;\r\nint x, y;\r\nis_fm = z->id == ZORRO_PROD_BSC_FRAMEMASTER_II;\r\nif (!zorro_request_device(z,"fm2fb"))\r\nreturn -ENXIO;\r\ninfo = framebuffer_alloc(16 * sizeof(u32), &z->dev);\r\nif (!info) {\r\nzorro_release_device(z);\r\nreturn -ENOMEM;\r\n}\r\nif (fb_alloc_cmap(&info->cmap, 256, 0) < 0) {\r\nframebuffer_release(info);\r\nzorro_release_device(z);\r\nreturn -ENOMEM;\r\n}\r\nfb_fix.smem_start = zorro_resource_start(z);\r\ninfo->screen_base = ioremap(fb_fix.smem_start, FRAMEMASTER_SIZE);\r\nfb_fix.mmio_start = fb_fix.smem_start + FRAMEMASTER_REG;\r\nfm2fb_reg = (unsigned char *)(info->screen_base+FRAMEMASTER_REG);\r\nstrcpy(fb_fix.id, is_fm ? "FrameMaster II" : "Rainbow II");\r\nptr = (unsigned long *)fb_fix.smem_start;\r\nfor (y = 0; y < 576; y++) {\r\nfor (x = 0; x < 96; x++) *ptr++ = 0xffffff;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0xffff00;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0x00ffff;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0x00ff00;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0xff00ff;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0xff0000;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0x0000ff;\r\nfor (x = 0; x < 96; x++) *ptr++ = 0x000000;\r\n}\r\nfm2fb_blank(0, info);\r\nif (fm2fb_mode == -1)\r\nfm2fb_mode = FM2FB_MODE_PAL;\r\ninfo->fbops = &fm2fb_ops;\r\ninfo->var = fb_var_modes[fm2fb_mode];\r\ninfo->pseudo_palette = info->par;\r\ninfo->par = NULL;\r\ninfo->fix = fb_fix;\r\ninfo->flags = FBINFO_DEFAULT;\r\nif (register_framebuffer(info) < 0) {\r\nfb_dealloc_cmap(&info->cmap);\r\niounmap(info->screen_base);\r\nframebuffer_release(info);\r\nzorro_release_device(z);\r\nreturn -EINVAL;\r\n}\r\nfb_info(info, "%s frame buffer device\n", fb_fix.id);\r\nreturn 0;\r\n}\r\nint __init fm2fb_setup(char *options)\r\n{\r\nchar *this_opt;\r\nif (!options || !*options)\r\nreturn 0;\r\nwhile ((this_opt = strsep(&options, ",")) != NULL) {\r\nif (!strncmp(this_opt, "pal", 3))\r\nfm2fb_mode = FM2FB_MODE_PAL;\r\nelse if (!strncmp(this_opt, "ntsc", 4))\r\nfm2fb_mode = FM2FB_MODE_NTSC;\r\n}\r\nreturn 0;\r\n}\r\nint __init fm2fb_init(void)\r\n{\r\nchar *option = NULL;\r\nif (fb_get_options("fm2fb", &option))\r\nreturn -ENODEV;\r\nfm2fb_setup(option);\r\nreturn zorro_register_driver(&fm2fb_driver);\r\n}

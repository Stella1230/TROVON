const struct squashfs_decompressor *squashfs_lookup_decompressor(int id)\r\n{\r\nint i;\r\nfor (i = 0; decompressor[i]->id; i++)\r\nif (id == decompressor[i]->id)\r\nbreak;\r\nreturn decompressor[i];\r\n}\r\nstatic void *get_comp_opts(struct super_block *sb, unsigned short flags)\r\n{\r\nstruct squashfs_sb_info *msblk = sb->s_fs_info;\r\nvoid *buffer = NULL, *comp_opts;\r\nstruct squashfs_page_actor *actor = NULL;\r\nint length = 0;\r\nif (SQUASHFS_COMP_OPTS(flags)) {\r\nbuffer = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (buffer == NULL) {\r\ncomp_opts = ERR_PTR(-ENOMEM);\r\ngoto out;\r\n}\r\nactor = squashfs_page_actor_init(&buffer, 1, 0);\r\nif (actor == NULL) {\r\ncomp_opts = ERR_PTR(-ENOMEM);\r\ngoto out;\r\n}\r\nlength = squashfs_read_data(sb,\r\nsizeof(struct squashfs_super_block), 0, NULL, actor);\r\nif (length < 0) {\r\ncomp_opts = ERR_PTR(length);\r\ngoto out;\r\n}\r\n}\r\ncomp_opts = squashfs_comp_opts(msblk, buffer, length);\r\nout:\r\nkfree(actor);\r\nkfree(buffer);\r\nreturn comp_opts;\r\n}\r\nvoid *squashfs_decompressor_setup(struct super_block *sb, unsigned short flags)\r\n{\r\nstruct squashfs_sb_info *msblk = sb->s_fs_info;\r\nvoid *stream, *comp_opts = get_comp_opts(sb, flags);\r\nif (IS_ERR(comp_opts))\r\nreturn comp_opts;\r\nstream = squashfs_decompressor_create(msblk, comp_opts);\r\nif (IS_ERR(stream))\r\nkfree(comp_opts);\r\nreturn stream;\r\n}

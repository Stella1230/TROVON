static unsigned long displayControlAdjust_SM750LE(mode_parameter_t *pModeParam, unsigned long dispControl)\r\n{\r\nunsigned long x, y;\r\nx = pModeParam->horizontal_display_end;\r\ny = pModeParam->vertical_display_end;\r\nPOKE32(CRT_AUTO_CENTERING_TL, 0);\r\nPOKE32(CRT_AUTO_CENTERING_BR,\r\n(((y - 1) << CRT_AUTO_CENTERING_BR_BOTTOM_SHIFT) &\r\nCRT_AUTO_CENTERING_BR_BOTTOM_MASK) |\r\n((x - 1) & CRT_AUTO_CENTERING_BR_RIGHT_MASK));\r\ndispControl &= ~CRT_DISPLAY_CTRL_CLK_MASK;\r\nif (x == 800 && y == 600)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL41;\r\nelse if (x == 1024 && y == 768)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL65;\r\nelse if (x == 1152 && y == 864)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL80;\r\nelse if (x == 1280 && y == 768)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL80;\r\nelse if (x == 1280 && y == 720)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL74;\r\nelse if (x == 1280 && y == 960)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL108;\r\nelse if (x == 1280 && y == 1024)\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL108;\r\nelse\r\ndispControl |= CRT_DISPLAY_CTRL_CLK_PLL25;\r\ndispControl |= (CRT_DISPLAY_CTRL_CRTSELECT | CRT_DISPLAY_CTRL_RGBBIT);\r\ndispControl = DISPLAY_CTRL_CLOCK_PHASE;\r\nPOKE32(CRT_DISPLAY_CTRL, dispControl);\r\nreturn dispControl;\r\n}\r\nstatic int programModeRegisters(mode_parameter_t *pModeParam, pll_value_t *pll)\r\n{\r\nint ret = 0;\r\nint cnt = 0;\r\nunsigned int tmp, reg;\r\nif (pll->clockType == SECONDARY_PLL) {\r\nPOKE32(CRT_PLL_CTRL, formatPllReg(pll));\r\nPOKE32(CRT_HORIZONTAL_TOTAL,\r\n(((pModeParam->horizontal_total - 1) <<\r\nCRT_HORIZONTAL_TOTAL_TOTAL_SHIFT) &\r\nCRT_HORIZONTAL_TOTAL_TOTAL_MASK) |\r\n((pModeParam->horizontal_display_end - 1) &\r\nCRT_HORIZONTAL_TOTAL_DISPLAY_END_MASK));\r\nPOKE32(CRT_HORIZONTAL_SYNC,\r\n((pModeParam->horizontal_sync_width <<\r\nCRT_HORIZONTAL_SYNC_WIDTH_SHIFT) &\r\nCRT_HORIZONTAL_SYNC_WIDTH_MASK) |\r\n((pModeParam->horizontal_sync_start - 1) &\r\nCRT_HORIZONTAL_SYNC_START_MASK));\r\nPOKE32(CRT_VERTICAL_TOTAL,\r\n(((pModeParam->vertical_total - 1) <<\r\nCRT_VERTICAL_TOTAL_TOTAL_SHIFT) &\r\nCRT_VERTICAL_TOTAL_TOTAL_MASK) |\r\n((pModeParam->vertical_display_end - 1) &\r\nCRT_VERTICAL_TOTAL_DISPLAY_END_MASK));\r\nPOKE32(CRT_VERTICAL_SYNC,\r\n((pModeParam->vertical_sync_height <<\r\nCRT_VERTICAL_SYNC_HEIGHT_SHIFT) &\r\nCRT_VERTICAL_SYNC_HEIGHT_MASK) |\r\n((pModeParam->vertical_sync_start - 1) &\r\nCRT_VERTICAL_SYNC_START_MASK));\r\ntmp = DISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE;\r\nif (pModeParam->vertical_sync_polarity)\r\ntmp |= DISPLAY_CTRL_VSYNC_PHASE;\r\nif (pModeParam->horizontal_sync_polarity)\r\ntmp |= DISPLAY_CTRL_HSYNC_PHASE;\r\nif (getChipType() == SM750LE) {\r\ndisplayControlAdjust_SM750LE(pModeParam, tmp);\r\n} else {\r\nreg = PEEK32(CRT_DISPLAY_CTRL) &\r\n~(DISPLAY_CTRL_VSYNC_PHASE |\r\nDISPLAY_CTRL_HSYNC_PHASE |\r\nDISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE);\r\nPOKE32(CRT_DISPLAY_CTRL, tmp | reg);\r\n}\r\n} else if (pll->clockType == PRIMARY_PLL) {\r\nunsigned int reserved;\r\nPOKE32(PANEL_PLL_CTRL, formatPllReg(pll));\r\nreg = ((pModeParam->horizontal_total - 1) <<\r\nPANEL_HORIZONTAL_TOTAL_TOTAL_SHIFT) &\r\nPANEL_HORIZONTAL_TOTAL_TOTAL_MASK;\r\nreg |= ((pModeParam->horizontal_display_end - 1) &\r\nPANEL_HORIZONTAL_TOTAL_DISPLAY_END_MASK);\r\nPOKE32(PANEL_HORIZONTAL_TOTAL, reg);\r\nPOKE32(PANEL_HORIZONTAL_SYNC,\r\n((pModeParam->horizontal_sync_width <<\r\nPANEL_HORIZONTAL_SYNC_WIDTH_SHIFT) &\r\nPANEL_HORIZONTAL_SYNC_WIDTH_MASK) |\r\n((pModeParam->horizontal_sync_start - 1) &\r\nPANEL_HORIZONTAL_SYNC_START_MASK));\r\nPOKE32(PANEL_VERTICAL_TOTAL,\r\n(((pModeParam->vertical_total - 1) <<\r\nPANEL_VERTICAL_TOTAL_TOTAL_SHIFT) &\r\nPANEL_VERTICAL_TOTAL_TOTAL_MASK) |\r\n((pModeParam->vertical_display_end - 1) &\r\nPANEL_VERTICAL_TOTAL_DISPLAY_END_MASK));\r\nPOKE32(PANEL_VERTICAL_SYNC,\r\n((pModeParam->vertical_sync_height <<\r\nPANEL_VERTICAL_SYNC_HEIGHT_SHIFT) &\r\nPANEL_VERTICAL_SYNC_HEIGHT_MASK) |\r\n((pModeParam->vertical_sync_start - 1) &\r\nPANEL_VERTICAL_SYNC_START_MASK));\r\ntmp = DISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE;\r\nif (pModeParam->vertical_sync_polarity)\r\ntmp |= DISPLAY_CTRL_VSYNC_PHASE;\r\nif (pModeParam->horizontal_sync_polarity)\r\ntmp |= DISPLAY_CTRL_HSYNC_PHASE;\r\nif (pModeParam->clock_phase_polarity)\r\ntmp |= DISPLAY_CTRL_CLOCK_PHASE;\r\nreserved = PANEL_DISPLAY_CTRL_RESERVED_MASK |\r\nPANEL_DISPLAY_CTRL_VSYNC;\r\nreg = (PEEK32(PANEL_DISPLAY_CTRL) & ~reserved) &\r\n~(DISPLAY_CTRL_CLOCK_PHASE | DISPLAY_CTRL_VSYNC_PHASE |\r\nDISPLAY_CTRL_HSYNC_PHASE | DISPLAY_CTRL_TIMING |\r\nDISPLAY_CTRL_PLANE);\r\nPOKE32(PANEL_DISPLAY_CTRL, tmp | reg);\r\nwhile ((PEEK32(PANEL_DISPLAY_CTRL) & ~reserved) !=\r\n(tmp | reg)) {\r\ncnt++;\r\nif (cnt > 1000)\r\nbreak;\r\nPOKE32(PANEL_DISPLAY_CTRL, tmp | reg);\r\n}\r\n} else {\r\nret = -1;\r\n}\r\nreturn ret;\r\n}\r\nint ddk750_setModeTiming(mode_parameter_t *parm, clock_type_t clock)\r\n{\r\npll_value_t pll;\r\nunsigned int uiActualPixelClk;\r\npll.inputFreq = DEFAULT_INPUT_CLOCK;\r\npll.clockType = clock;\r\nuiActualPixelClk = calcPllValue(parm->pixel_clock, &pll);\r\nif (getChipType() == SM750LE) {\r\noutb_p(0x88, 0x3d4);\r\noutb_p(0x06, 0x3d5);\r\n}\r\nprogramModeRegisters(parm, &pll);\r\nreturn 0;\r\n}

static void sun6i_get_ar100_factors(struct factors_request *req)\r\n{\r\nunsigned long div;\r\nint shift;\r\nif (req->rate > req->parent_rate)\r\nreq->rate = req->parent_rate;\r\ndiv = DIV_ROUND_UP(req->parent_rate, req->rate);\r\nif (div < 32)\r\nshift = 0;\r\nelse if (div >> 1 < 32)\r\nshift = 1;\r\nelse if (div >> 2 < 32)\r\nshift = 2;\r\nelse\r\nshift = 3;\r\ndiv >>= shift;\r\nif (div > 32)\r\ndiv = 32;\r\nreq->rate = (req->parent_rate >> shift) / div;\r\nreq->m = div - 1;\r\nreq->p = shift;\r\n}\r\nstatic int sun6i_a31_ar100_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *r;\r\nvoid __iomem *reg;\r\nstruct clk *clk;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nreg = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(reg))\r\nreturn PTR_ERR(reg);\r\nclk = sunxi_factors_register(np, &sun6i_ar100_data, &sun6i_ar100_lock,\r\nreg);\r\nif (!clk)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, clk);\r\nreturn 0;\r\n}\r\nstatic int sun6i_a31_ar100_clk_remove(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct clk *clk = platform_get_drvdata(pdev);\r\nsunxi_factors_unregister(np, clk);\r\nreturn 0;\r\n}

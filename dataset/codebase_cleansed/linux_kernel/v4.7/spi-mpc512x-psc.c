static int mpc512x_psc_spi_transfer_setup(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct mpc512x_psc_spi_cs *cs = spi->controller_state;\r\ncs->speed_hz = (t && t->speed_hz)\r\n? t->speed_hz : spi->max_speed_hz;\r\ncs->bits_per_word = (t && t->bits_per_word)\r\n? t->bits_per_word : spi->bits_per_word;\r\ncs->bits_per_word = ((cs->bits_per_word + 7) / 8) * 8;\r\nreturn 0;\r\n}\r\nstatic void mpc512x_psc_spi_activate_cs(struct spi_device *spi)\r\n{\r\nstruct mpc512x_psc_spi_cs *cs = spi->controller_state;\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(spi->master);\r\nu32 sicr;\r\nu32 ccr;\r\nint speed;\r\nu16 bclkdiv;\r\nsicr = in_be32(psc_addr(mps, sicr));\r\nif (spi->mode & SPI_CPHA)\r\nsicr |= 0x00001000;\r\nelse\r\nsicr &= ~0x00001000;\r\nif (spi->mode & SPI_CPOL)\r\nsicr |= 0x00002000;\r\nelse\r\nsicr &= ~0x00002000;\r\nif (spi->mode & SPI_LSB_FIRST)\r\nsicr |= 0x10000000;\r\nelse\r\nsicr &= ~0x10000000;\r\nout_be32(psc_addr(mps, sicr), sicr);\r\nccr = in_be32(psc_addr(mps, ccr));\r\nccr &= 0xFF000000;\r\nspeed = cs->speed_hz;\r\nif (!speed)\r\nspeed = 1000000;\r\nbclkdiv = (mps->mclk_rate / speed) - 1;\r\nccr |= (((bclkdiv & 0xff) << 16) | (((bclkdiv >> 8) & 0xff) << 8));\r\nout_be32(psc_addr(mps, ccr), ccr);\r\nmps->bits_per_word = cs->bits_per_word;\r\nif (mps->cs_control && gpio_is_valid(spi->cs_gpio))\r\nmps->cs_control(spi, (spi->mode & SPI_CS_HIGH) ? 1 : 0);\r\n}\r\nstatic void mpc512x_psc_spi_deactivate_cs(struct spi_device *spi)\r\n{\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(spi->master);\r\nif (mps->cs_control && gpio_is_valid(spi->cs_gpio))\r\nmps->cs_control(spi, (spi->mode & SPI_CS_HIGH) ? 0 : 1);\r\n}\r\nstatic int mpc512x_psc_spi_transfer_rxtx(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(spi->master);\r\nstruct mpc512x_psc_fifo __iomem *fifo = mps->fifo;\r\nsize_t tx_len = t->len;\r\nsize_t rx_len = t->len;\r\nu8 *tx_buf = (u8 *)t->tx_buf;\r\nu8 *rx_buf = (u8 *)t->rx_buf;\r\nif (!tx_buf && !rx_buf && t->len)\r\nreturn -EINVAL;\r\nwhile (rx_len || tx_len) {\r\nsize_t txcount;\r\nu8 data;\r\nsize_t fifosz;\r\nsize_t rxcount;\r\nint rxtries;\r\nfifosz = MPC512x_PSC_FIFO_SZ(in_be32(&fifo->txsz));\r\ntxcount = min(fifosz, tx_len);\r\nfifosz = MPC512x_PSC_FIFO_SZ(in_be32(&fifo->rxsz));\r\nfifosz -= in_be32(&fifo->rxcnt) + 1;\r\ntxcount = min(fifosz, txcount);\r\nif (txcount) {\r\nwhile (txcount-- > 0) {\r\ndata = tx_buf ? *tx_buf++ : 0;\r\nif (tx_len == EOFBYTE && t->cs_change)\r\nsetbits32(&fifo->txcmd,\r\nMPC512x_PSC_FIFO_EOF);\r\nout_8(&fifo->txdata_8, data);\r\ntx_len--;\r\n}\r\nreinit_completion(&mps->txisrdone);\r\nout_be32(&fifo->txisr, MPC512x_PSC_FIFO_EMPTY);\r\nout_be32(&fifo->tximr, MPC512x_PSC_FIFO_EMPTY);\r\nwait_for_completion(&mps->txisrdone);\r\n}\r\nrxtries = 50;\r\ndo {\r\nfifosz = in_be32(&fifo->rxcnt);\r\nrxcount = min(fifosz, rx_len);\r\nwhile (rxcount-- > 0) {\r\ndata = in_8(&fifo->rxdata_8);\r\nif (rx_buf)\r\n*rx_buf++ = data;\r\nrx_len--;\r\n}\r\nif (tx_len)\r\nbreak;\r\nif (!rx_len)\r\nbreak;\r\nusleep_range(10, 100);\r\n} while (--rxtries > 0);\r\nif (!tx_len && rx_len && !rxtries) {\r\nrxcount = in_be32(&fifo->rxcnt);\r\ndev_warn(&spi->dev,\r\n"short xfer, missing %zd RX bytes, FIFO level %zd\n",\r\nrx_len, rxcount);\r\n}\r\nif (!tx_len && !rx_len) {\r\nwhile (in_be32(&fifo->rxcnt))\r\nin_8(&fifo->rxdata_8);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mpc512x_psc_spi_msg_xfer(struct spi_master *master,\r\nstruct spi_message *m)\r\n{\r\nstruct spi_device *spi;\r\nunsigned cs_change;\r\nint status;\r\nstruct spi_transfer *t;\r\nspi = m->spi;\r\ncs_change = 1;\r\nstatus = 0;\r\nlist_for_each_entry(t, &m->transfers, transfer_list) {\r\nstatus = mpc512x_psc_spi_transfer_setup(spi, t);\r\nif (status < 0)\r\nbreak;\r\nif (cs_change)\r\nmpc512x_psc_spi_activate_cs(spi);\r\ncs_change = t->cs_change;\r\nstatus = mpc512x_psc_spi_transfer_rxtx(spi, t);\r\nif (status)\r\nbreak;\r\nm->actual_length += t->len;\r\nif (t->delay_usecs)\r\nudelay(t->delay_usecs);\r\nif (cs_change)\r\nmpc512x_psc_spi_deactivate_cs(spi);\r\n}\r\nm->status = status;\r\nif (m->complete)\r\nm->complete(m->context);\r\nif (status || !cs_change)\r\nmpc512x_psc_spi_deactivate_cs(spi);\r\nmpc512x_psc_spi_transfer_setup(spi, NULL);\r\nspi_finalize_current_message(master);\r\nreturn status;\r\n}\r\nstatic int mpc512x_psc_spi_prep_xfer_hw(struct spi_master *master)\r\n{\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(master);\r\ndev_dbg(&master->dev, "%s()\n", __func__);\r\nin_8(psc_addr(mps, mr2));\r\nout_8(psc_addr(mps, mr2), 0x0);\r\nout_8(psc_addr(mps, command), MPC52xx_PSC_TX_ENABLE | MPC52xx_PSC_RX_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int mpc512x_psc_spi_unprep_xfer_hw(struct spi_master *master)\r\n{\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(master);\r\nstruct mpc512x_psc_fifo __iomem *fifo = mps->fifo;\r\ndev_dbg(&master->dev, "%s()\n", __func__);\r\nout_8(psc_addr(mps, command), MPC52xx_PSC_TX_DISABLE | MPC52xx_PSC_RX_DISABLE);\r\nout_be32(&fifo->tximr, 0);\r\nreturn 0;\r\n}\r\nstatic int mpc512x_psc_spi_setup(struct spi_device *spi)\r\n{\r\nstruct mpc512x_psc_spi_cs *cs = spi->controller_state;\r\nint ret;\r\nif (spi->bits_per_word % 8)\r\nreturn -EINVAL;\r\nif (!cs) {\r\ncs = kzalloc(sizeof *cs, GFP_KERNEL);\r\nif (!cs)\r\nreturn -ENOMEM;\r\nif (gpio_is_valid(spi->cs_gpio)) {\r\nret = gpio_request(spi->cs_gpio, dev_name(&spi->dev));\r\nif (ret) {\r\ndev_err(&spi->dev, "can't get CS gpio: %d\n",\r\nret);\r\nkfree(cs);\r\nreturn ret;\r\n}\r\ngpio_direction_output(spi->cs_gpio,\r\nspi->mode & SPI_CS_HIGH ? 0 : 1);\r\n}\r\nspi->controller_state = cs;\r\n}\r\ncs->bits_per_word = spi->bits_per_word;\r\ncs->speed_hz = spi->max_speed_hz;\r\nreturn 0;\r\n}\r\nstatic void mpc512x_psc_spi_cleanup(struct spi_device *spi)\r\n{\r\nif (gpio_is_valid(spi->cs_gpio))\r\ngpio_free(spi->cs_gpio);\r\nkfree(spi->controller_state);\r\n}\r\nstatic int mpc512x_psc_spi_port_config(struct spi_master *master,\r\nstruct mpc512x_psc_spi *mps)\r\n{\r\nstruct mpc512x_psc_fifo __iomem *fifo = mps->fifo;\r\nu32 sicr;\r\nu32 ccr;\r\nint speed;\r\nu16 bclkdiv;\r\nout_8(psc_addr(mps, command), MPC52xx_PSC_RST_RX);\r\nout_8(psc_addr(mps, command), MPC52xx_PSC_RST_TX);\r\nout_8(psc_addr(mps, command), MPC52xx_PSC_TX_DISABLE | MPC52xx_PSC_RX_DISABLE);\r\nout_be16(psc_addr(mps, isr_imr.imr), 0);\r\nout_be32(&fifo->tximr, 0);\r\nout_be32(&fifo->rximr, 0);\r\nsicr = 0x01000000 |\r\n0x00800000 |\r\n0x00008000 |\r\n0x00004000 |\r\n0x00000800;\r\nout_be32(psc_addr(mps, sicr), sicr);\r\nccr = in_be32(psc_addr(mps, ccr));\r\nccr &= 0xFF000000;\r\nspeed = 1000000;\r\nbclkdiv = (mps->mclk_rate / speed) - 1;\r\nccr |= (((bclkdiv & 0xff) << 16) | (((bclkdiv >> 8) & 0xff) << 8));\r\nout_be32(psc_addr(mps, ccr), ccr);\r\nout_8(psc_addr(mps, ctur), 0x00);\r\nout_8(psc_addr(mps, ctlr), 0x82);\r\nout_be32(&fifo->rxalarm, 0xfff);\r\nout_be32(&fifo->txalarm, 0);\r\nout_be32(&fifo->rxcmd,\r\nMPC512x_PSC_FIFO_ENABLE_SLICE | MPC512x_PSC_FIFO_ENABLE_DMA);\r\nout_be32(&fifo->txcmd,\r\nMPC512x_PSC_FIFO_ENABLE_SLICE | MPC512x_PSC_FIFO_ENABLE_DMA);\r\nmps->bits_per_word = 8;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t mpc512x_psc_spi_isr(int irq, void *dev_id)\r\n{\r\nstruct mpc512x_psc_spi *mps = (struct mpc512x_psc_spi *)dev_id;\r\nstruct mpc512x_psc_fifo __iomem *fifo = mps->fifo;\r\nif (in_be32(&fifo->txisr) &\r\nin_be32(&fifo->tximr) & MPC512x_PSC_FIFO_EMPTY) {\r\nout_be32(&fifo->txisr, MPC512x_PSC_FIFO_EMPTY);\r\nout_be32(&fifo->tximr, 0);\r\ncomplete(&mps->txisrdone);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic void mpc512x_spi_cs_control(struct spi_device *spi, bool onoff)\r\n{\r\ngpio_set_value(spi->cs_gpio, onoff);\r\n}\r\nstatic int mpc512x_psc_spi_do_probe(struct device *dev, u32 regaddr,\r\nu32 size, unsigned int irq)\r\n{\r\nstruct fsl_spi_platform_data *pdata = dev_get_platdata(dev);\r\nstruct mpc512x_psc_spi *mps;\r\nstruct spi_master *master;\r\nint ret;\r\nvoid *tempp;\r\nstruct clk *clk;\r\nmaster = spi_alloc_master(dev, sizeof *mps);\r\nif (master == NULL)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(dev, master);\r\nmps = spi_master_get_devdata(master);\r\nmps->type = (int)of_device_get_match_data(dev);\r\nmps->irq = irq;\r\nif (pdata == NULL) {\r\nmps->cs_control = mpc512x_spi_cs_control;\r\n} else {\r\nmps->cs_control = pdata->cs_control;\r\nmaster->bus_num = pdata->bus_num;\r\nmaster->num_chipselect = pdata->max_chipselect;\r\n}\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH | SPI_LSB_FIRST;\r\nmaster->setup = mpc512x_psc_spi_setup;\r\nmaster->prepare_transfer_hardware = mpc512x_psc_spi_prep_xfer_hw;\r\nmaster->transfer_one_message = mpc512x_psc_spi_msg_xfer;\r\nmaster->unprepare_transfer_hardware = mpc512x_psc_spi_unprep_xfer_hw;\r\nmaster->cleanup = mpc512x_psc_spi_cleanup;\r\nmaster->dev.of_node = dev->of_node;\r\ntempp = devm_ioremap(dev, regaddr, size);\r\nif (!tempp) {\r\ndev_err(dev, "could not ioremap I/O port range\n");\r\nret = -EFAULT;\r\ngoto free_master;\r\n}\r\nmps->psc = tempp;\r\nmps->fifo =\r\n(struct mpc512x_psc_fifo *)(tempp + sizeof(struct mpc52xx_psc));\r\nret = devm_request_irq(dev, mps->irq, mpc512x_psc_spi_isr, IRQF_SHARED,\r\n"mpc512x-psc-spi", mps);\r\nif (ret)\r\ngoto free_master;\r\ninit_completion(&mps->txisrdone);\r\nclk = devm_clk_get(dev, "mclk");\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto free_master;\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\ngoto free_master;\r\nmps->clk_mclk = clk;\r\nmps->mclk_rate = clk_get_rate(clk);\r\nclk = devm_clk_get(dev, "ipg");\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto free_mclk_clock;\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\ngoto free_mclk_clock;\r\nmps->clk_ipg = clk;\r\nret = mpc512x_psc_spi_port_config(master, mps);\r\nif (ret < 0)\r\ngoto free_ipg_clock;\r\nret = devm_spi_register_master(dev, master);\r\nif (ret < 0)\r\ngoto free_ipg_clock;\r\nreturn ret;\r\nfree_ipg_clock:\r\nclk_disable_unprepare(mps->clk_ipg);\r\nfree_mclk_clock:\r\nclk_disable_unprepare(mps->clk_mclk);\r\nfree_master:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int mpc512x_psc_spi_do_remove(struct device *dev)\r\n{\r\nstruct spi_master *master = dev_get_drvdata(dev);\r\nstruct mpc512x_psc_spi *mps = spi_master_get_devdata(master);\r\nclk_disable_unprepare(mps->clk_mclk);\r\nclk_disable_unprepare(mps->clk_ipg);\r\nreturn 0;\r\n}\r\nstatic int mpc512x_psc_spi_of_probe(struct platform_device *op)\r\n{\r\nconst u32 *regaddr_p;\r\nu64 regaddr64, size64;\r\nregaddr_p = of_get_address(op->dev.of_node, 0, &size64, NULL);\r\nif (!regaddr_p) {\r\ndev_err(&op->dev, "Invalid PSC address\n");\r\nreturn -EINVAL;\r\n}\r\nregaddr64 = of_translate_address(op->dev.of_node, regaddr_p);\r\nreturn mpc512x_psc_spi_do_probe(&op->dev, (u32) regaddr64, (u32) size64,\r\nirq_of_parse_and_map(op->dev.of_node, 0));\r\n}\r\nstatic int mpc512x_psc_spi_of_remove(struct platform_device *op)\r\n{\r\nreturn mpc512x_psc_spi_do_remove(&op->dev);\r\n}

static inline bool clk_utmi_ready(struct regmap *regmap)\r\n{\r\nunsigned int status;\r\nregmap_read(regmap, AT91_PMC_SR, &status);\r\nreturn status & AT91_PMC_LOCKU;\r\n}\r\nstatic int clk_utmi_prepare(struct clk_hw *hw)\r\n{\r\nstruct clk_utmi *utmi = to_clk_utmi(hw);\r\nunsigned int uckr = AT91_PMC_UPLLEN | AT91_PMC_UPLLCOUNT |\r\nAT91_PMC_BIASEN;\r\nregmap_update_bits(utmi->regmap, AT91_CKGR_UCKR, uckr, uckr);\r\nwhile (!clk_utmi_ready(utmi->regmap))\r\ncpu_relax();\r\nreturn 0;\r\n}\r\nstatic int clk_utmi_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct clk_utmi *utmi = to_clk_utmi(hw);\r\nreturn clk_utmi_ready(utmi->regmap);\r\n}\r\nstatic void clk_utmi_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_utmi *utmi = to_clk_utmi(hw);\r\nregmap_update_bits(utmi->regmap, AT91_CKGR_UCKR, AT91_PMC_UPLLEN, 0);\r\n}\r\nstatic unsigned long clk_utmi_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn parent_rate * UTMI_FIXED_MUL;\r\n}\r\nstatic struct clk * __init\r\nat91_clk_register_utmi(struct regmap *regmap,\r\nconst char *name, const char *parent_name)\r\n{\r\nstruct clk_utmi *utmi;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nutmi = kzalloc(sizeof(*utmi), GFP_KERNEL);\r\nif (!utmi)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &utmi_ops;\r\ninit.parent_names = parent_name ? &parent_name : NULL;\r\ninit.num_parents = parent_name ? 1 : 0;\r\ninit.flags = CLK_SET_RATE_GATE;\r\nutmi->hw.init = &init;\r\nutmi->regmap = regmap;\r\nclk = clk_register(NULL, &utmi->hw);\r\nif (IS_ERR(clk))\r\nkfree(utmi);\r\nreturn clk;\r\n}\r\nstatic void __init of_at91sam9x5_clk_utmi_setup(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nconst char *name = np->name;\r\nstruct regmap *regmap;\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nof_property_read_string(np, "clock-output-names", &name);\r\nregmap = syscon_node_to_regmap(of_get_parent(np));\r\nif (IS_ERR(regmap))\r\nreturn;\r\nclk = at91_clk_register_utmi(regmap, name, parent_name);\r\nif (IS_ERR(clk))\r\nreturn;\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\nreturn;\r\n}

static inline struct wuxga_nt_panel *to_wuxga_nt_panel(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct wuxga_nt_panel, base);\r\n}\r\nstatic int wuxga_nt_panel_on(struct wuxga_nt_panel *wuxga_nt)\r\n{\r\nstruct mipi_dsi_device *dsi = wuxga_nt->dsi;\r\nint ret;\r\nret = mipi_dsi_turn_on_peripheral(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int wuxga_nt_panel_disable(struct drm_panel *panel)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = to_wuxga_nt_panel(panel);\r\nif (!wuxga_nt->enabled)\r\nreturn 0;\r\nmipi_dsi_shutdown_peripheral(wuxga_nt->dsi);\r\nif (wuxga_nt->backlight) {\r\nwuxga_nt->backlight->props.power = FB_BLANK_POWERDOWN;\r\nwuxga_nt->backlight->props.state |= BL_CORE_FBBLANK;\r\nbacklight_update_status(wuxga_nt->backlight);\r\n}\r\nwuxga_nt->enabled = false;\r\nreturn 0;\r\n}\r\nstatic int wuxga_nt_panel_unprepare(struct drm_panel *panel)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = to_wuxga_nt_panel(panel);\r\nif (!wuxga_nt->prepared)\r\nreturn 0;\r\nregulator_disable(wuxga_nt->supply);\r\nwuxga_nt->earliest_wake = ktime_add_ms(ktime_get_real(), MIN_POFF_MS);\r\nwuxga_nt->prepared = false;\r\nreturn 0;\r\n}\r\nstatic int wuxga_nt_panel_prepare(struct drm_panel *panel)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = to_wuxga_nt_panel(panel);\r\nint ret;\r\ns64 enablewait;\r\nif (wuxga_nt->prepared)\r\nreturn 0;\r\nenablewait = ktime_ms_delta(wuxga_nt->earliest_wake, ktime_get_real());\r\nif (enablewait > MIN_POFF_MS)\r\nenablewait = MIN_POFF_MS;\r\nif (enablewait > 0)\r\nmsleep(enablewait);\r\nret = regulator_enable(wuxga_nt->supply);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(250);\r\nret = wuxga_nt_panel_on(wuxga_nt);\r\nif (ret < 0) {\r\ndev_err(panel->dev, "failed to set panel on: %d\n", ret);\r\ngoto poweroff;\r\n}\r\nwuxga_nt->prepared = true;\r\nreturn 0;\r\npoweroff:\r\nregulator_disable(wuxga_nt->supply);\r\nreturn ret;\r\n}\r\nstatic int wuxga_nt_panel_enable(struct drm_panel *panel)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = to_wuxga_nt_panel(panel);\r\nif (wuxga_nt->enabled)\r\nreturn 0;\r\nif (wuxga_nt->backlight) {\r\nwuxga_nt->backlight->props.power = FB_BLANK_UNBLANK;\r\nwuxga_nt->backlight->props.state &= ~BL_CORE_FBBLANK;\r\nbacklight_update_status(wuxga_nt->backlight);\r\n}\r\nwuxga_nt->enabled = true;\r\nreturn 0;\r\n}\r\nstatic int wuxga_nt_panel_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(panel->drm->dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\ndrm_mode_probed_add(panel->connector, mode);\r\npanel->connector->display_info.width_mm = 217;\r\npanel->connector->display_info.height_mm = 136;\r\nreturn 1;\r\n}\r\nstatic int wuxga_nt_panel_add(struct wuxga_nt_panel *wuxga_nt)\r\n{\r\nstruct device *dev = &wuxga_nt->dsi->dev;\r\nstruct device_node *np;\r\nint ret;\r\nwuxga_nt->mode = &default_mode;\r\nwuxga_nt->supply = devm_regulator_get(dev, "power");\r\nif (IS_ERR(wuxga_nt->supply))\r\nreturn PTR_ERR(wuxga_nt->supply);\r\nnp = of_parse_phandle(dev->of_node, "backlight", 0);\r\nif (np) {\r\nwuxga_nt->backlight = of_find_backlight_by_node(np);\r\nof_node_put(np);\r\nif (!wuxga_nt->backlight)\r\nreturn -EPROBE_DEFER;\r\n}\r\ndrm_panel_init(&wuxga_nt->base);\r\nwuxga_nt->base.funcs = &wuxga_nt_panel_funcs;\r\nwuxga_nt->base.dev = &wuxga_nt->dsi->dev;\r\nret = drm_panel_add(&wuxga_nt->base);\r\nif (ret < 0)\r\ngoto put_backlight;\r\nreturn 0;\r\nput_backlight:\r\nif (wuxga_nt->backlight)\r\nput_device(&wuxga_nt->backlight->dev);\r\nreturn ret;\r\n}\r\nstatic void wuxga_nt_panel_del(struct wuxga_nt_panel *wuxga_nt)\r\n{\r\nif (wuxga_nt->base.dev)\r\ndrm_panel_remove(&wuxga_nt->base);\r\nif (wuxga_nt->backlight)\r\nput_device(&wuxga_nt->backlight->dev);\r\n}\r\nstatic int wuxga_nt_panel_probe(struct mipi_dsi_device *dsi)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt;\r\nint ret;\r\ndsi->lanes = 4;\r\ndsi->format = MIPI_DSI_FMT_RGB888;\r\ndsi->mode_flags = MIPI_DSI_MODE_VIDEO |\r\nMIPI_DSI_MODE_VIDEO_HSE |\r\nMIPI_DSI_CLOCK_NON_CONTINUOUS |\r\nMIPI_DSI_MODE_LPM;\r\nwuxga_nt = devm_kzalloc(&dsi->dev, sizeof(*wuxga_nt), GFP_KERNEL);\r\nif (!wuxga_nt)\r\nreturn -ENOMEM;\r\nmipi_dsi_set_drvdata(dsi, wuxga_nt);\r\nwuxga_nt->dsi = dsi;\r\nret = wuxga_nt_panel_add(wuxga_nt);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn mipi_dsi_attach(dsi);\r\n}\r\nstatic int wuxga_nt_panel_remove(struct mipi_dsi_device *dsi)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = mipi_dsi_get_drvdata(dsi);\r\nint ret;\r\nret = wuxga_nt_panel_disable(&wuxga_nt->base);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to disable panel: %d\n", ret);\r\nret = mipi_dsi_detach(dsi);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to detach from DSI host: %d\n", ret);\r\ndrm_panel_detach(&wuxga_nt->base);\r\nwuxga_nt_panel_del(wuxga_nt);\r\nreturn 0;\r\n}\r\nstatic void wuxga_nt_panel_shutdown(struct mipi_dsi_device *dsi)\r\n{\r\nstruct wuxga_nt_panel *wuxga_nt = mipi_dsi_get_drvdata(dsi);\r\nwuxga_nt_panel_disable(&wuxga_nt->base);\r\n}

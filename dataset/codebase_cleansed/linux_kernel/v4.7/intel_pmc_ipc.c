static inline void ipc_send_command(u32 cmd)\r\n{\r\nipcdev.cmd = cmd;\r\nif (ipcdev.irq_mode) {\r\nreinit_completion(&ipcdev.cmd_complete);\r\ncmd |= IPC_CMD_MSI;\r\n}\r\nwritel(cmd, ipcdev.ipc_base + IPC_CMD);\r\n}\r\nstatic inline u32 ipc_read_status(void)\r\n{\r\nreturn readl(ipcdev.ipc_base + IPC_STATUS);\r\n}\r\nstatic inline void ipc_data_writel(u32 data, u32 offset)\r\n{\r\nwritel(data, ipcdev.ipc_base + IPC_WRITE_BUFFER + offset);\r\n}\r\nstatic inline u8 ipc_data_readb(u32 offset)\r\n{\r\nreturn readb(ipcdev.ipc_base + IPC_READ_BUFFER + offset);\r\n}\r\nstatic inline u32 ipc_data_readl(u32 offset)\r\n{\r\nreturn readl(ipcdev.ipc_base + IPC_READ_BUFFER + offset);\r\n}\r\nstatic int intel_pmc_ipc_check_status(void)\r\n{\r\nint status;\r\nint ret = 0;\r\nif (ipcdev.irq_mode) {\r\nif (0 == wait_for_completion_timeout(\r\n&ipcdev.cmd_complete, IPC_MAX_SEC * HZ))\r\nret = -ETIMEDOUT;\r\n} else {\r\nint loop_count = IPC_LOOP_CNT;\r\nwhile ((ipc_read_status() & IPC_STATUS_BUSY) && --loop_count)\r\nudelay(1);\r\nif (loop_count == 0)\r\nret = -ETIMEDOUT;\r\n}\r\nstatus = ipc_read_status();\r\nif (ret == -ETIMEDOUT) {\r\ndev_err(ipcdev.dev,\r\n"IPC timed out, TS=0x%x, CMD=0x%x\n",\r\nstatus, ipcdev.cmd);\r\nreturn ret;\r\n}\r\nif (status & IPC_STATUS_ERR) {\r\nint i;\r\nret = -EIO;\r\ni = (status >> IPC_CMD_SIZE) & 0xFF;\r\nif (i < ARRAY_SIZE(ipc_err_sources))\r\ndev_err(ipcdev.dev,\r\n"IPC failed: %s, STS=0x%x, CMD=0x%x\n",\r\nipc_err_sources[i], status, ipcdev.cmd);\r\nelse\r\ndev_err(ipcdev.dev,\r\n"IPC failed: unknown, STS=0x%x, CMD=0x%x\n",\r\nstatus, ipcdev.cmd);\r\nif ((i == IPC_ERR_UNSIGNEDKERNEL) || (i == IPC_ERR_EMSECURITY))\r\nret = -EACCES;\r\n}\r\nreturn ret;\r\n}\r\nint intel_pmc_ipc_simple_command(int cmd, int sub)\r\n{\r\nint ret;\r\nmutex_lock(&ipclock);\r\nif (ipcdev.dev == NULL) {\r\nmutex_unlock(&ipclock);\r\nreturn -ENODEV;\r\n}\r\nipc_send_command(sub << IPC_CMD_SUBCMD | cmd);\r\nret = intel_pmc_ipc_check_status();\r\nmutex_unlock(&ipclock);\r\nreturn ret;\r\n}\r\nint intel_pmc_ipc_raw_cmd(u32 cmd, u32 sub, u8 *in, u32 inlen, u32 *out,\r\nu32 outlen, u32 dptr, u32 sptr)\r\n{\r\nu32 wbuf[4] = { 0 };\r\nint ret;\r\nint i;\r\nif (inlen > IPC_DATA_BUFFER_SIZE || outlen > IPC_DATA_BUFFER_SIZE / 4)\r\nreturn -EINVAL;\r\nmutex_lock(&ipclock);\r\nif (ipcdev.dev == NULL) {\r\nmutex_unlock(&ipclock);\r\nreturn -ENODEV;\r\n}\r\nmemcpy(wbuf, in, inlen);\r\nwritel(dptr, ipcdev.ipc_base + IPC_DPTR);\r\nwritel(sptr, ipcdev.ipc_base + IPC_SPTR);\r\nfor (i = 0; i < ((inlen + 3) / 4); i++)\r\nipc_data_writel(wbuf[i], 4 * i);\r\nipc_send_command((inlen << IPC_CMD_SIZE) |\r\n(sub << IPC_CMD_SUBCMD) | cmd);\r\nret = intel_pmc_ipc_check_status();\r\nif (!ret) {\r\nfor (i = 0; i < outlen; i++)\r\n*out++ = ipc_data_readl(4 * i);\r\n}\r\nmutex_unlock(&ipclock);\r\nreturn ret;\r\n}\r\nint intel_pmc_ipc_command(u32 cmd, u32 sub, u8 *in, u32 inlen,\r\nu32 *out, u32 outlen)\r\n{\r\nreturn intel_pmc_ipc_raw_cmd(cmd, sub, in, inlen, out, outlen, 0, 0);\r\n}\r\nstatic irqreturn_t ioc(int irq, void *dev_id)\r\n{\r\nint status;\r\nif (ipcdev.irq_mode) {\r\nstatus = ipc_read_status();\r\nwritel(status | IPC_STATUS_IRQ, ipcdev.ipc_base + IPC_STATUS);\r\n}\r\ncomplete(&ipcdev.cmd_complete);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ipc_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nresource_size_t pci_resource;\r\nint ret;\r\nint len;\r\nipcdev.dev = &pci_dev_get(pdev)->dev;\r\nipcdev.irq_mode = IPC_TRIGGER_MODE_IRQ;\r\nret = pci_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nret = pci_request_regions(pdev, "intel_pmc_ipc");\r\nif (ret)\r\nreturn ret;\r\npci_resource = pci_resource_start(pdev, 0);\r\nlen = pci_resource_len(pdev, 0);\r\nif (!pci_resource || !len) {\r\ndev_err(&pdev->dev, "Failed to get resource\n");\r\nreturn -ENOMEM;\r\n}\r\ninit_completion(&ipcdev.cmd_complete);\r\nif (request_irq(pdev->irq, ioc, 0, "intel_pmc_ipc", &ipcdev)) {\r\ndev_err(&pdev->dev, "Failed to request irq\n");\r\nreturn -EBUSY;\r\n}\r\nipcdev.ipc_base = ioremap_nocache(pci_resource, len);\r\nif (!ipcdev.ipc_base) {\r\ndev_err(&pdev->dev, "Failed to ioremap ipc base\n");\r\nfree_irq(pdev->irq, &ipcdev);\r\nret = -ENOMEM;\r\n}\r\nreturn ret;\r\n}\r\nstatic void ipc_pci_remove(struct pci_dev *pdev)\r\n{\r\nfree_irq(pdev->irq, &ipcdev);\r\npci_release_regions(pdev);\r\npci_dev_put(pdev);\r\niounmap(ipcdev.ipc_base);\r\nipcdev.dev = NULL;\r\n}\r\nstatic ssize_t intel_pmc_ipc_simple_cmd_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint subcmd;\r\nint cmd;\r\nint ret;\r\nret = sscanf(buf, "%d %d", &cmd, &subcmd);\r\nif (ret != 2) {\r\ndev_err(dev, "Error args\n");\r\nreturn -EINVAL;\r\n}\r\nret = intel_pmc_ipc_simple_command(cmd, subcmd);\r\nif (ret) {\r\ndev_err(dev, "command %d error with %d\n", cmd, ret);\r\nreturn ret;\r\n}\r\nreturn (ssize_t)count;\r\n}\r\nstatic ssize_t intel_pmc_ipc_northpeak_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned long val;\r\nint subcmd;\r\nint ret;\r\nif (kstrtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val)\r\nsubcmd = 1;\r\nelse\r\nsubcmd = 0;\r\nret = intel_pmc_ipc_simple_command(PMC_IPC_NORTHPEAK_CTRL, subcmd);\r\nif (ret) {\r\ndev_err(dev, "command north %d error with %d\n", subcmd, ret);\r\nreturn ret;\r\n}\r\nreturn (ssize_t)count;\r\n}\r\nstatic int ipc_create_punit_device(void)\r\n{\r\nstruct platform_device *pdev;\r\nint ret;\r\npdev = platform_device_alloc(PUNIT_DEVICE_NAME, -1);\r\nif (!pdev) {\r\ndev_err(ipcdev.dev, "Failed to alloc punit platform device\n");\r\nreturn -ENOMEM;\r\n}\r\npdev->dev.parent = ipcdev.dev;\r\nret = platform_device_add_resources(pdev, punit_res_array,\r\nARRAY_SIZE(punit_res_array));\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add platform punit resources\n");\r\ngoto err;\r\n}\r\nret = platform_device_add(pdev);\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add punit platform device\n");\r\ngoto err;\r\n}\r\nipcdev.punit_dev = pdev;\r\nreturn 0;\r\nerr:\r\nplatform_device_put(pdev);\r\nreturn ret;\r\n}\r\nstatic int ipc_create_tco_device(void)\r\n{\r\nstruct platform_device *pdev;\r\nstruct resource *res;\r\nint ret;\r\npdev = platform_device_alloc(TCO_DEVICE_NAME, -1);\r\nif (!pdev) {\r\ndev_err(ipcdev.dev, "Failed to alloc tco platform device\n");\r\nreturn -ENOMEM;\r\n}\r\npdev->dev.parent = ipcdev.dev;\r\nres = tco_res + TCO_RESOURCE_ACPI_IO;\r\nres->start = ipcdev.acpi_io_base + TCO_BASE_OFFSET;\r\nres->end = res->start + TCO_REGS_SIZE - 1;\r\nres = tco_res + TCO_RESOURCE_SMI_EN_IO;\r\nres->start = ipcdev.acpi_io_base + SMI_EN_OFFSET;\r\nres->end = res->start + SMI_EN_SIZE - 1;\r\nres = tco_res + TCO_RESOURCE_GCR_MEM;\r\nres->start = ipcdev.gcr_base;\r\nres->end = res->start + ipcdev.gcr_size - 1;\r\nret = platform_device_add_resources(pdev, tco_res, ARRAY_SIZE(tco_res));\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add tco platform resources\n");\r\ngoto err;\r\n}\r\nret = platform_device_add_data(pdev, &tco_info, sizeof(tco_info));\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add tco platform data\n");\r\ngoto err;\r\n}\r\nret = platform_device_add(pdev);\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add tco platform device\n");\r\ngoto err;\r\n}\r\nipcdev.tco_dev = pdev;\r\nreturn 0;\r\nerr:\r\nplatform_device_put(pdev);\r\nreturn ret;\r\n}\r\nstatic int ipc_create_telemetry_device(void)\r\n{\r\nstruct platform_device *pdev;\r\nstruct resource *res;\r\nint ret;\r\npdev = platform_device_alloc(TELEMETRY_DEVICE_NAME, -1);\r\nif (!pdev) {\r\ndev_err(ipcdev.dev,\r\n"Failed to allocate telemetry platform device\n");\r\nreturn -ENOMEM;\r\n}\r\npdev->dev.parent = ipcdev.dev;\r\nres = telemetry_res + TELEMETRY_RESOURCE_PUNIT_SSRAM;\r\nres->start = ipcdev.telem_punit_ssram_base;\r\nres->end = res->start + ipcdev.telem_punit_ssram_size - 1;\r\nres = telemetry_res + TELEMETRY_RESOURCE_PMC_SSRAM;\r\nres->start = ipcdev.telem_pmc_ssram_base;\r\nres->end = res->start + ipcdev.telem_pmc_ssram_size - 1;\r\nret = platform_device_add_resources(pdev, telemetry_res,\r\nARRAY_SIZE(telemetry_res));\r\nif (ret) {\r\ndev_err(ipcdev.dev,\r\n"Failed to add telemetry platform resources\n");\r\ngoto err;\r\n}\r\nret = platform_device_add(pdev);\r\nif (ret) {\r\ndev_err(ipcdev.dev,\r\n"Failed to add telemetry platform device\n");\r\ngoto err;\r\n}\r\nipcdev.telemetry_dev = pdev;\r\nreturn 0;\r\nerr:\r\nplatform_device_put(pdev);\r\nreturn ret;\r\n}\r\nstatic int ipc_create_pmc_devices(void)\r\n{\r\nint ret;\r\nret = ipc_create_tco_device();\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add tco platform device\n");\r\nreturn ret;\r\n}\r\nret = ipc_create_punit_device();\r\nif (ret) {\r\ndev_err(ipcdev.dev, "Failed to add punit platform device\n");\r\nplatform_device_unregister(ipcdev.tco_dev);\r\n}\r\nif (!ipcdev.telem_res_inval) {\r\nret = ipc_create_telemetry_device();\r\nif (ret)\r\ndev_warn(ipcdev.dev,\r\n"Failed to add telemetry platform device\n");\r\n}\r\nreturn ret;\r\n}\r\nstatic int ipc_plat_get_res(struct platform_device *pdev)\r\n{\r\nstruct resource *res, *punit_res;\r\nvoid __iomem *addr;\r\nint size;\r\nres = platform_get_resource(pdev, IORESOURCE_IO,\r\nPLAT_RESOURCE_ACPI_IO_INDEX);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get io resource\n");\r\nreturn -ENXIO;\r\n}\r\nsize = resource_size(res);\r\nipcdev.acpi_io_base = res->start;\r\nipcdev.acpi_io_size = size;\r\ndev_info(&pdev->dev, "io res: %pR\n", res);\r\npunit_res = punit_res_array;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_BIOS_DATA_INDEX);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get res of punit BIOS data\n");\r\nreturn -ENXIO;\r\n}\r\n*punit_res = *res;\r\ndev_info(&pdev->dev, "punit BIOS data res: %pR\n", res);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_BIOS_IFACE_INDEX);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get res of punit BIOS iface\n");\r\nreturn -ENXIO;\r\n}\r\n*++punit_res = *res;\r\ndev_info(&pdev->dev, "punit BIOS interface res: %pR\n", res);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_ISP_DATA_INDEX);\r\n++punit_res;\r\nif (res) {\r\n*punit_res = *res;\r\ndev_info(&pdev->dev, "punit ISP data res: %pR\n", res);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_ISP_IFACE_INDEX);\r\n++punit_res;\r\nif (res) {\r\n*punit_res = *res;\r\ndev_info(&pdev->dev, "punit ISP interface res: %pR\n", res);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_GTD_DATA_INDEX);\r\n++punit_res;\r\nif (res) {\r\n*punit_res = *res;\r\ndev_info(&pdev->dev, "punit GTD data res: %pR\n", res);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_GTD_IFACE_INDEX);\r\n++punit_res;\r\nif (res) {\r\n*punit_res = *res;\r\ndev_info(&pdev->dev, "punit GTD interface res: %pR\n", res);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_IPC_INDEX);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get ipc resource\n");\r\nreturn -ENXIO;\r\n}\r\nsize = PLAT_RESOURCE_IPC_SIZE;\r\nif (!request_mem_region(res->start, size, pdev->name)) {\r\ndev_err(&pdev->dev, "Failed to request ipc resource\n");\r\nreturn -EBUSY;\r\n}\r\naddr = ioremap_nocache(res->start, size);\r\nif (!addr) {\r\ndev_err(&pdev->dev, "I/O memory remapping failed\n");\r\nrelease_mem_region(res->start, size);\r\nreturn -ENOMEM;\r\n}\r\nipcdev.ipc_base = addr;\r\nipcdev.gcr_base = res->start + PLAT_RESOURCE_GCR_OFFSET;\r\nipcdev.gcr_size = PLAT_RESOURCE_GCR_SIZE;\r\ndev_info(&pdev->dev, "ipc res: %pR\n", res);\r\nipcdev.telem_res_inval = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_TELEM_SSRAM_INDEX);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get telemetry ssram resource\n");\r\nipcdev.telem_res_inval = 1;\r\n} else {\r\nipcdev.telem_punit_ssram_base = res->start +\r\nTELEM_PUNIT_SSRAM_OFFSET;\r\nipcdev.telem_punit_ssram_size = TELEM_SSRAM_SIZE;\r\nipcdev.telem_pmc_ssram_base = res->start +\r\nTELEM_PMC_SSRAM_OFFSET;\r\nipcdev.telem_pmc_ssram_size = TELEM_SSRAM_SIZE;\r\ndev_info(&pdev->dev, "telemetry ssram res: %pR\n", res);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ipc_plat_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nipcdev.dev = &pdev->dev;\r\nipcdev.irq_mode = IPC_TRIGGER_MODE_IRQ;\r\ninit_completion(&ipcdev.cmd_complete);\r\nipcdev.irq = platform_get_irq(pdev, 0);\r\nif (ipcdev.irq < 0) {\r\ndev_err(&pdev->dev, "Failed to get irq\n");\r\nreturn -EINVAL;\r\n}\r\nret = ipc_plat_get_res(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request resource\n");\r\nreturn ret;\r\n}\r\nret = ipc_create_pmc_devices();\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to create pmc devices\n");\r\ngoto err_device;\r\n}\r\nif (request_irq(ipcdev.irq, ioc, IRQF_NO_SUSPEND,\r\n"intel_pmc_ipc", &ipcdev)) {\r\ndev_err(&pdev->dev, "Failed to request irq\n");\r\nret = -EBUSY;\r\ngoto err_irq;\r\n}\r\nret = sysfs_create_group(&pdev->dev.kobj, &intel_ipc_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to create sysfs group %d\n",\r\nret);\r\ngoto err_sys;\r\n}\r\nreturn 0;\r\nerr_sys:\r\nfree_irq(ipcdev.irq, &ipcdev);\r\nerr_irq:\r\nplatform_device_unregister(ipcdev.tco_dev);\r\nplatform_device_unregister(ipcdev.punit_dev);\r\nplatform_device_unregister(ipcdev.telemetry_dev);\r\nerr_device:\r\niounmap(ipcdev.ipc_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_IPC_INDEX);\r\nif (res)\r\nrelease_mem_region(res->start, PLAT_RESOURCE_IPC_SIZE);\r\nreturn ret;\r\n}\r\nstatic int ipc_plat_remove(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nsysfs_remove_group(&pdev->dev.kobj, &intel_ipc_group);\r\nfree_irq(ipcdev.irq, &ipcdev);\r\nplatform_device_unregister(ipcdev.tco_dev);\r\nplatform_device_unregister(ipcdev.punit_dev);\r\nplatform_device_unregister(ipcdev.telemetry_dev);\r\niounmap(ipcdev.ipc_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM,\r\nPLAT_RESOURCE_IPC_INDEX);\r\nif (res)\r\nrelease_mem_region(res->start, PLAT_RESOURCE_IPC_SIZE);\r\nipcdev.dev = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init intel_pmc_ipc_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&ipc_plat_driver);\r\nif (ret) {\r\npr_err("Failed to register PMC ipc platform driver\n");\r\nreturn ret;\r\n}\r\nret = pci_register_driver(&ipc_pci_driver);\r\nif (ret) {\r\npr_err("Failed to register PMC ipc pci driver\n");\r\nplatform_driver_unregister(&ipc_plat_driver);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit intel_pmc_ipc_exit(void)\r\n{\r\npci_unregister_driver(&ipc_pci_driver);\r\nplatform_driver_unregister(&ipc_plat_driver);\r\n}

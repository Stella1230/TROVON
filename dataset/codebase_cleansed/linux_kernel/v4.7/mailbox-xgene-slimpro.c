static void mb_chan_send_msg(struct slimpro_mbox_chan *mb_chan, u32 *msg)\r\n{\r\nwritel(msg[1], mb_chan->reg + REG_DB_DOUT0);\r\nwritel(msg[2], mb_chan->reg + REG_DB_DOUT1);\r\nwritel(msg[0], mb_chan->reg + REG_DB_OUT);\r\n}\r\nstatic void mb_chan_recv_msg(struct slimpro_mbox_chan *mb_chan)\r\n{\r\nmb_chan->rx_msg[1] = readl(mb_chan->reg + REG_DB_DIN0);\r\nmb_chan->rx_msg[2] = readl(mb_chan->reg + REG_DB_DIN1);\r\nmb_chan->rx_msg[0] = readl(mb_chan->reg + REG_DB_IN);\r\n}\r\nstatic int mb_chan_status_ack(struct slimpro_mbox_chan *mb_chan)\r\n{\r\nu32 val = readl(mb_chan->reg + REG_DB_STAT);\r\nif (val & MBOX_STATUS_ACK_MASK) {\r\nwritel(MBOX_STATUS_ACK_MASK, mb_chan->reg + REG_DB_STAT);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mb_chan_status_avail(struct slimpro_mbox_chan *mb_chan)\r\n{\r\nu32 val = readl(mb_chan->reg + REG_DB_STAT);\r\nif (val & MBOX_STATUS_AVAIL_MASK) {\r\nmb_chan_recv_msg(mb_chan);\r\nwritel(MBOX_STATUS_AVAIL_MASK, mb_chan->reg + REG_DB_STAT);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t slimpro_mbox_irq(int irq, void *id)\r\n{\r\nstruct slimpro_mbox_chan *mb_chan = id;\r\nif (mb_chan_status_ack(mb_chan))\r\nmbox_chan_txdone(mb_chan->chan, 0);\r\nif (mb_chan_status_avail(mb_chan))\r\nmbox_chan_received_data(mb_chan->chan, mb_chan->rx_msg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int slimpro_mbox_send_data(struct mbox_chan *chan, void *msg)\r\n{\r\nstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\r\nmb_chan_send_msg(mb_chan, msg);\r\nreturn 0;\r\n}\r\nstatic int slimpro_mbox_startup(struct mbox_chan *chan)\r\n{\r\nstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\r\nint rc;\r\nu32 val;\r\nrc = devm_request_irq(mb_chan->dev, mb_chan->irq, slimpro_mbox_irq, 0,\r\nMBOX_CON_NAME, mb_chan);\r\nif (unlikely(rc)) {\r\ndev_err(mb_chan->dev, "failed to register mailbox interrupt %d\n",\r\nmb_chan->irq);\r\nreturn rc;\r\n}\r\nwritel(MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK,\r\nmb_chan->reg + REG_DB_STAT);\r\nval = readl(mb_chan->reg + REG_DB_STATMASK);\r\nval &= ~(MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK);\r\nwritel(val, mb_chan->reg + REG_DB_STATMASK);\r\nreturn 0;\r\n}\r\nstatic void slimpro_mbox_shutdown(struct mbox_chan *chan)\r\n{\r\nstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\r\nu32 val;\r\nval = readl(mb_chan->reg + REG_DB_STATMASK);\r\nval |= (MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK);\r\nwritel(val, mb_chan->reg + REG_DB_STATMASK);\r\ndevm_free_irq(mb_chan->dev, mb_chan->irq, mb_chan);\r\n}\r\nstatic int slimpro_mbox_probe(struct platform_device *pdev)\r\n{\r\nstruct slimpro_mbox *ctx;\r\nstruct resource *regs;\r\nvoid __iomem *mb_base;\r\nint rc;\r\nint i;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(struct slimpro_mbox), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, ctx);\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmb_base = devm_ioremap(&pdev->dev, regs->start, resource_size(regs));\r\nif (!mb_base)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < MBOX_CNT; i++) {\r\nctx->mc[i].irq = platform_get_irq(pdev, i);\r\nif (ctx->mc[i].irq < 0) {\r\nif (i == 0) {\r\ndev_err(&pdev->dev, "no available IRQ\n");\r\nreturn -EINVAL;\r\n}\r\ndev_info(&pdev->dev, "no IRQ for channel %d\n", i);\r\nbreak;\r\n}\r\nctx->mc[i].dev = &pdev->dev;\r\nctx->mc[i].reg = mb_base + i * MBOX_REG_SET_OFFSET;\r\nctx->mc[i].chan = &ctx->chans[i];\r\nctx->chans[i].con_priv = &ctx->mc[i];\r\n}\r\nctx->mb_ctrl.dev = &pdev->dev;\r\nctx->mb_ctrl.chans = ctx->chans;\r\nctx->mb_ctrl.txdone_irq = true;\r\nctx->mb_ctrl.ops = &slimpro_mbox_ops;\r\nctx->mb_ctrl.num_chans = i;\r\nrc = mbox_controller_register(&ctx->mb_ctrl);\r\nif (rc) {\r\ndev_err(&pdev->dev,\r\n"APM X-Gene SLIMpro MailBox register failed:%d\n", rc);\r\nreturn rc;\r\n}\r\ndev_info(&pdev->dev, "APM X-Gene SLIMpro MailBox registered\n");\r\nreturn 0;\r\n}\r\nstatic int slimpro_mbox_remove(struct platform_device *pdev)\r\n{\r\nstruct slimpro_mbox *smb = platform_get_drvdata(pdev);\r\nmbox_controller_unregister(&smb->mb_ctrl);\r\nreturn 0;\r\n}\r\nstatic int __init slimpro_mbox_init(void)\r\n{\r\nreturn platform_driver_register(&slimpro_mbox_driver);\r\n}\r\nstatic void __exit slimpro_mbox_exit(void)\r\n{\r\nplatform_driver_unregister(&slimpro_mbox_driver);\r\n}

static int adt7x10_read_byte(struct device *dev, u8 reg)\r\n{\r\nstruct adt7x10_data *d = dev_get_drvdata(dev);\r\nreturn d->ops->read_byte(dev, reg);\r\n}\r\nstatic int adt7x10_write_byte(struct device *dev, u8 reg, u8 data)\r\n{\r\nstruct adt7x10_data *d = dev_get_drvdata(dev);\r\nreturn d->ops->write_byte(dev, reg, data);\r\n}\r\nstatic int adt7x10_read_word(struct device *dev, u8 reg)\r\n{\r\nstruct adt7x10_data *d = dev_get_drvdata(dev);\r\nreturn d->ops->read_word(dev, reg);\r\n}\r\nstatic int adt7x10_write_word(struct device *dev, u8 reg, u16 data)\r\n{\r\nstruct adt7x10_data *d = dev_get_drvdata(dev);\r\nreturn d->ops->write_word(dev, reg, data);\r\n}\r\nstatic irqreturn_t adt7x10_irq_handler(int irq, void *private)\r\n{\r\nstruct device *dev = private;\r\nint status;\r\nstatus = adt7x10_read_byte(dev, ADT7X10_STATUS);\r\nif (status < 0)\r\nreturn IRQ_HANDLED;\r\nif (status & ADT7X10_STAT_T_HIGH)\r\nsysfs_notify(&dev->kobj, NULL, "temp1_max_alarm");\r\nif (status & ADT7X10_STAT_T_LOW)\r\nsysfs_notify(&dev->kobj, NULL, "temp1_min_alarm");\r\nif (status & ADT7X10_STAT_T_CRIT)\r\nsysfs_notify(&dev->kobj, NULL, "temp1_crit_alarm");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int adt7x10_temp_ready(struct device *dev)\r\n{\r\nint i, status;\r\nfor (i = 0; i < 6; i++) {\r\nstatus = adt7x10_read_byte(dev, ADT7X10_STATUS);\r\nif (status < 0)\r\nreturn status;\r\nif (!(status & ADT7X10_STAT_NOT_RDY))\r\nreturn 0;\r\nmsleep(60);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int adt7x10_update_temp(struct device *dev)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nint ret = 0;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nint temp;\r\ndev_dbg(dev, "Starting update\n");\r\nret = adt7x10_temp_ready(dev);\r\nif (ret)\r\ngoto abort;\r\ntemp = adt7x10_read_word(dev, ADT7X10_REG_TEMP[0]);\r\nif (temp < 0) {\r\nret = temp;\r\ndev_dbg(dev, "Failed to read value: reg %d, error %d\n",\r\nADT7X10_REG_TEMP[0], ret);\r\ngoto abort;\r\n}\r\ndata->temp[0] = temp;\r\ndata->last_updated = jiffies;\r\ndata->valid = true;\r\n}\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int adt7x10_fill_cache(struct device *dev)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nint ret;\r\nint i;\r\nfor (i = 1; i < ARRAY_SIZE(data->temp); i++) {\r\nret = adt7x10_read_word(dev, ADT7X10_REG_TEMP[i]);\r\nif (ret < 0) {\r\ndev_dbg(dev, "Failed to read value: reg %d, error %d\n",\r\nADT7X10_REG_TEMP[i], ret);\r\nreturn ret;\r\n}\r\ndata->temp[i] = ret;\r\n}\r\nret = adt7x10_read_byte(dev, ADT7X10_T_HYST);\r\nif (ret < 0) {\r\ndev_dbg(dev, "Failed to read value: reg %d, error %d\n",\r\nADT7X10_T_HYST, ret);\r\nreturn ret;\r\n}\r\ndata->hyst = ret;\r\nreturn 0;\r\n}\r\nstatic s16 ADT7X10_TEMP_TO_REG(long temp)\r\n{\r\nreturn DIV_ROUND_CLOSEST(clamp_val(temp, ADT7X10_TEMP_MIN,\r\nADT7X10_TEMP_MAX) * 128, 1000);\r\n}\r\nstatic int ADT7X10_REG_TO_TEMP(struct adt7x10_data *data, s16 reg)\r\n{\r\nif (!(data->config & ADT7X10_RESOLUTION))\r\nreg &= ADT7X10_T13_VALUE_MASK;\r\nreturn DIV_ROUND_CLOSEST(reg * 1000, 128);\r\n}\r\nstatic ssize_t adt7x10_show_temp(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nif (attr->index == 0) {\r\nint ret;\r\nret = adt7x10_update_temp(dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn sprintf(buf, "%d\n", ADT7X10_REG_TO_TEMP(data,\r\ndata->temp[attr->index]));\r\n}\r\nstatic ssize_t adt7x10_set_temp(struct device *dev,\r\nstruct device_attribute *da,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nint nr = attr->index;\r\nlong temp;\r\nint ret;\r\nret = kstrtol(buf, 10, &temp);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&data->update_lock);\r\ndata->temp[nr] = ADT7X10_TEMP_TO_REG(temp);\r\nret = adt7x10_write_word(dev, ADT7X10_REG_TEMP[nr], data->temp[nr]);\r\nif (ret)\r\ncount = ret;\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t adt7x10_show_t_hyst(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nint nr = attr->index;\r\nint hyst;\r\nhyst = (data->hyst & ADT7X10_T_HYST_MASK) * 1000;\r\nif (nr == 2)\r\nhyst = -hyst;\r\nreturn sprintf(buf, "%d\n",\r\nADT7X10_REG_TO_TEMP(data, data->temp[nr]) - hyst);\r\n}\r\nstatic ssize_t adt7x10_set_t_hyst(struct device *dev,\r\nstruct device_attribute *da,\r\nconst char *buf, size_t count)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nint limit, ret;\r\nlong hyst;\r\nret = kstrtol(buf, 10, &hyst);\r\nif (ret)\r\nreturn ret;\r\nlimit = ADT7X10_REG_TO_TEMP(data, data->temp[1]);\r\nhyst = clamp_val(hyst, ADT7X10_TEMP_MIN, ADT7X10_TEMP_MAX);\r\ndata->hyst = clamp_val(DIV_ROUND_CLOSEST(limit - hyst, 1000),\r\n0, ADT7X10_T_HYST_MASK);\r\nret = adt7x10_write_byte(dev, ADT7X10_T_HYST, data->hyst);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t adt7x10_show_alarm(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nint ret;\r\nret = adt7x10_read_byte(dev, ADT7X10_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", !!(ret & attr->index));\r\n}\r\nstatic ssize_t adt7x10_show_name(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->name);\r\n}\r\nint adt7x10_probe(struct device *dev, const char *name, int irq,\r\nconst struct adt7x10_ops *ops)\r\n{\r\nstruct adt7x10_data *data;\r\nint ret;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->ops = ops;\r\ndata->name = name;\r\ndev_set_drvdata(dev, data);\r\nmutex_init(&data->update_lock);\r\nret = adt7x10_read_byte(dev, ADT7X10_CONFIG);\r\nif (ret < 0) {\r\ndev_dbg(dev, "Can't read config? %d\n", ret);\r\nreturn ret;\r\n}\r\ndata->oldconfig = ret;\r\ndata->config = data->oldconfig;\r\ndata->config &= ~(ADT7X10_MODE_MASK | ADT7X10_CT_POLARITY |\r\nADT7X10_INT_POLARITY);\r\ndata->config |= ADT7X10_FULL | ADT7X10_RESOLUTION | ADT7X10_EVENT_MODE;\r\nif (data->config != data->oldconfig) {\r\nret = adt7x10_write_byte(dev, ADT7X10_CONFIG, data->config);\r\nif (ret)\r\nreturn ret;\r\n}\r\ndev_dbg(dev, "Config %02x\n", data->config);\r\nret = adt7x10_fill_cache(dev);\r\nif (ret)\r\ngoto exit_restore;\r\nret = sysfs_create_group(&dev->kobj, &adt7x10_group);\r\nif (ret)\r\ngoto exit_restore;\r\nif (name) {\r\nret = device_create_file(dev, &dev_attr_name);\r\nif (ret)\r\ngoto exit_remove;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nret = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove_name;\r\n}\r\nif (irq > 0) {\r\nret = request_threaded_irq(irq, NULL, adt7x10_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\ndev_name(dev), dev);\r\nif (ret)\r\ngoto exit_hwmon_device_unregister;\r\n}\r\nreturn 0;\r\nexit_hwmon_device_unregister:\r\nhwmon_device_unregister(data->hwmon_dev);\r\nexit_remove_name:\r\nif (name)\r\ndevice_remove_file(dev, &dev_attr_name);\r\nexit_remove:\r\nsysfs_remove_group(&dev->kobj, &adt7x10_group);\r\nexit_restore:\r\nadt7x10_write_byte(dev, ADT7X10_CONFIG, data->oldconfig);\r\nreturn ret;\r\n}\r\nint adt7x10_remove(struct device *dev, int irq)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nif (irq > 0)\r\nfree_irq(irq, dev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nif (data->name)\r\ndevice_remove_file(dev, &dev_attr_name);\r\nsysfs_remove_group(&dev->kobj, &adt7x10_group);\r\nif (data->oldconfig != data->config)\r\nadt7x10_write_byte(dev, ADT7X10_CONFIG, data->oldconfig);\r\nreturn 0;\r\n}\r\nstatic int adt7x10_suspend(struct device *dev)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nreturn adt7x10_write_byte(dev, ADT7X10_CONFIG,\r\ndata->config | ADT7X10_PD);\r\n}\r\nstatic int adt7x10_resume(struct device *dev)\r\n{\r\nstruct adt7x10_data *data = dev_get_drvdata(dev);\r\nreturn adt7x10_write_byte(dev, ADT7X10_CONFIG, data->config);\r\n}

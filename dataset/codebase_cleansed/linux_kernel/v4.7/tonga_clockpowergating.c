int tonga_phm_powerdown_uvd(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_uvd_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerOFF);\r\nreturn 0;\r\n}\r\nint tonga_phm_powerup_uvd(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_uvd_power_gating(hwmgr)) {\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_UVDDynamicPowerGating)) {\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerON, 1);\r\n} else {\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_UVDPowerON, 0);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint tonga_phm_powerdown_vce(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_vce_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_VCEPowerOFF);\r\nreturn 0;\r\n}\r\nint tonga_phm_powerup_vce(struct pp_hwmgr *hwmgr)\r\n{\r\nif (phm_cf_want_vce_power_gating(hwmgr))\r\nreturn smum_send_msg_to_smc(hwmgr->smumgr,\r\nPPSMC_MSG_VCEPowerON);\r\nreturn 0;\r\n}\r\nint tonga_phm_set_asic_block_gating(struct pp_hwmgr *hwmgr, enum PHM_AsicBlock block, enum PHM_ClockGateSetting gating)\r\n{\r\nint ret = 0;\r\nswitch (block) {\r\ncase PHM_AsicBlock_UVD_MVC:\r\ncase PHM_AsicBlock_UVD:\r\ncase PHM_AsicBlock_UVD_HD:\r\ncase PHM_AsicBlock_UVD_SD:\r\nif (gating == PHM_ClockGateSetting_StaticOff)\r\nret = tonga_phm_powerdown_uvd(hwmgr);\r\nelse\r\nret = tonga_phm_powerup_uvd(hwmgr);\r\nbreak;\r\ncase PHM_AsicBlock_GFX:\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nint tonga_phm_disable_clock_power_gating(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct tonga_hwmgr *data = (struct tonga_hwmgr *)(hwmgr->backend);\r\ndata->uvd_power_gated = false;\r\ndata->vce_power_gated = false;\r\ntonga_phm_powerup_uvd(hwmgr);\r\ntonga_phm_powerup_vce(hwmgr);\r\nreturn 0;\r\n}\r\nint tonga_phm_powergate_uvd(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nstruct tonga_hwmgr *data = (struct tonga_hwmgr *)(hwmgr->backend);\r\nif (data->uvd_power_gated == bgate)\r\nreturn 0;\r\ndata->uvd_power_gated = bgate;\r\nif (bgate) {\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_CG_STATE_UNGATE);\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_PG_STATE_GATE);\r\ntonga_update_uvd_dpm(hwmgr, true);\r\ntonga_phm_powerdown_uvd(hwmgr);\r\n} else {\r\ntonga_phm_powerup_uvd(hwmgr);\r\ncgs_set_powergating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_PG_STATE_UNGATE);\r\ncgs_set_clockgating_state(hwmgr->device,\r\nAMD_IP_BLOCK_TYPE_UVD,\r\nAMD_PG_STATE_GATE);\r\ntonga_update_uvd_dpm(hwmgr, false);\r\n}\r\nreturn 0;\r\n}\r\nint tonga_phm_powergate_vce(struct pp_hwmgr *hwmgr, bool bgate)\r\n{\r\nstruct tonga_hwmgr *data = (struct tonga_hwmgr *)(hwmgr->backend);\r\nstruct phm_set_power_state_input states;\r\nconst struct pp_power_state *pcurrent;\r\nstruct pp_power_state *requested;\r\npcurrent = hwmgr->current_ps;\r\nrequested = hwmgr->request_ps;\r\nstates.pcurrent_state = &(pcurrent->hardware);\r\nstates.pnew_state = &(requested->hardware);\r\nif (phm_cf_want_vce_power_gating(hwmgr)) {\r\nif (data->vce_power_gated != bgate) {\r\nif (bgate) {\r\ncgs_set_clockgating_state(\r\nhwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_CG_STATE_UNGATE);\r\ncgs_set_powergating_state(\r\nhwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_PG_STATE_GATE);\r\ntonga_enable_disable_vce_dpm(hwmgr, false);\r\ndata->vce_power_gated = true;\r\n} else {\r\ntonga_phm_powerup_vce(hwmgr);\r\ndata->vce_power_gated = false;\r\ncgs_set_powergating_state(\r\nhwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_PG_STATE_UNGATE);\r\ncgs_set_clockgating_state(\r\nhwmgr->device,\r\nAMD_IP_BLOCK_TYPE_VCE,\r\nAMD_PG_STATE_GATE);\r\ntonga_update_vce_dpm(hwmgr, &states);\r\ntonga_enable_disable_vce_dpm(hwmgr, true);\r\nreturn 0;\r\n}\r\n}\r\n} else {\r\ntonga_update_vce_dpm(hwmgr, &states);\r\ntonga_enable_disable_vce_dpm(hwmgr, true);\r\nreturn 0;\r\n}\r\nif (!data->vce_power_gated)\r\ntonga_update_vce_dpm(hwmgr, &states);\r\nreturn 0;\r\n}\r\nint tonga_phm_update_clock_gatings(struct pp_hwmgr *hwmgr,\r\nconst uint32_t *msg_id)\r\n{\r\nPPSMC_Msg msg;\r\nuint32_t value;\r\nswitch ((*msg_id & PP_GROUP_MASK) >> PP_GROUP_SHIFT) {\r\ncase PP_GROUP_GFX:\r\nswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\r\ncase PP_BLOCK_GFX_CG:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_CGCG_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_GFX_CGLS_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_BLOCK_GFX_MG:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = (CG_RLC_MGCG_MASK | CG_GFX_OTHERS_MGCG_MASK);\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_GROUP_SYS:\r\nswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\r\ncase PP_BLOCK_SYS_BIF:\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_BIF_MGLS_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_MC:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_MC_MGCG_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_MC_MGLS_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_HDP:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_HDP_MGCG_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_HDP_MGLS_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_SDMA:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_SDMA_MGCG_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nif (PP_STATE_SUPPORT_LS & *msg_id) {\r\nmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_SDMA_MGLS_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ncase PP_BLOCK_SYS_ROM:\r\nif (PP_STATE_SUPPORT_CG & *msg_id) {\r\nmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\r\n? PPSMC_MSG_EnableClockGatingFeature\r\n: PPSMC_MSG_DisableClockGatingFeature;\r\nvalue = CG_SYS_ROM_MASK;\r\nif (0 != smum_send_msg_to_smc_with_parameter(hwmgr->smumgr, msg, value))\r\nreturn -1;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}

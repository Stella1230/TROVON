static inline uint8_t exca_readb(vrc4173_socket_t *socket, uint16_t offset)\r\n{\r\nreturn readb(socket->base + EXCA_REGS_BASE + offset);\r\n}\r\nstatic inline uint16_t exca_readw(vrc4173_socket_t *socket, uint16_t offset)\r\n{\r\nuint16_t val;\r\nval = readb(socket->base + EXCA_REGS_BASE + offset);\r\nval |= (u16)readb(socket->base + EXCA_REGS_BASE + offset + 1) << 8;\r\nreturn val;\r\n}\r\nstatic inline void exca_writeb(vrc4173_socket_t *socket, uint16_t offset, uint8_t val)\r\n{\r\nwriteb(val, socket->base + EXCA_REGS_BASE + offset);\r\n}\r\nstatic inline void exca_writew(vrc4173_socket_t *socket, uint8_t offset, uint16_t val)\r\n{\r\nwriteb((u8)val, socket->base + EXCA_REGS_BASE + offset);\r\nwriteb((u8)(val >> 8), socket->base + EXCA_REGS_BASE + offset + 1);\r\n}\r\nstatic inline uint32_t cardbus_socket_readl(vrc4173_socket_t *socket, u16 offset)\r\n{\r\nreturn readl(socket->base + CARDBUS_SOCKET_REGS_BASE + offset);\r\n}\r\nstatic inline void cardbus_socket_writel(vrc4173_socket_t *socket, u16 offset, uint32_t val)\r\n{\r\nwritel(val, socket->base + CARDBUS_SOCKET_REGS_BASE + offset);\r\n}\r\nstatic void cardu_pciregs_init(struct pci_dev *dev)\r\n{\r\nu32 syscnt;\r\nu16 brgcnt;\r\nu8 devcnt;\r\npci_write_config_dword(dev, 0x1c, 0x10000000);\r\npci_write_config_dword(dev, 0x20, 0x17fff000);\r\npci_write_config_dword(dev, 0x2c, 0);\r\npci_write_config_dword(dev, 0x30, 0xfffc);\r\npci_read_config_word(dev, BRGCNT, &brgcnt);\r\nbrgcnt &= ~IREQ_INT;\r\npci_write_config_word(dev, BRGCNT, brgcnt);\r\npci_read_config_dword(dev, SYSCNT, &syscnt);\r\nsyscnt &= ~(BAD_VCC_REQ_DISB|PCPCI_EN|CH_ASSIGN_MASK|SUB_ID_WR_EN|PCI_CLK_RIN);\r\nsyscnt |= (CH_ASSIGN_NODMA|ASYN_INT_MODE);\r\npci_write_config_dword(dev, SYSCNT, syscnt);\r\npci_read_config_byte(dev, DEVCNT, &devcnt);\r\ndevcnt &= ~(ZOOM_VIDEO_EN|SR_PCI_INT_SEL_MASK|PCI_INT_MODE|IRQ_MODE);\r\ndevcnt |= (SR_PCI_INT_SEL_NONE|IFG);\r\npci_write_config_byte(dev, DEVCNT, devcnt);\r\npci_write_config_byte(dev, CHIPCNT, S_PREF_DISB);\r\npci_write_config_byte(dev, SERRDIS, 0);\r\n}\r\nstatic int cardu_init(unsigned int slot)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[slot];\r\ncardu_pciregs_init(socket->dev);\r\nexca_writeb(socket, GLO_CNT, 0);\r\nsocket->cap.features |= SS_CAP_PCCARD | SS_CAP_PAGE_REGS;\r\nsocket->cap.irq_mask = 0;\r\nsocket->cap.map_size = 0x1000;\r\nsocket->cap.pci_irq = socket->dev->irq;\r\nsocket->events = 0;\r\nspin_lock_init(socket->event_lock);\r\nexca_writeb(socket, CARD_SCI, CARD_DT_EN|RDY_EN|BAT_WAR_EN|BAT_DEAD_EN);\r\nreturn 0;\r\n}\r\nstatic int cardu_register_callback(unsigned int sock,\r\nvoid (*handler)(void *, unsigned int),\r\nvoid * info)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nsocket->handler = handler;\r\nsocket->info = info;\r\nreturn 0;\r\n}\r\nstatic int cardu_inquire_socket(unsigned int sock, socket_cap_t *cap)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\n*cap = socket->cap;\r\nreturn 0;\r\n}\r\nstatic int cardu_get_status(unsigned int sock, u_int *value)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint32_t state;\r\nuint8_t status;\r\nu_int val = 0;\r\nstatus = exca_readb(socket, IF_STATUS);\r\nif (status & CARD_PWR) val |= SS_POWERON;\r\nif (status & READY) val |= SS_READY;\r\nif (status & CARD_WP) val |= SS_WRPROT;\r\nif ((status & (CARD_DETECT1|CARD_DETECT2)) == (CARD_DETECT1|CARD_DETECT2))\r\nval |= SS_DETECT;\r\nif (exca_readb(socket, INT_GEN_CNT) & CARD_TYPE_IO) {\r\nif (status & STSCHG) val |= SS_STSCHG;\r\n} else {\r\nstatus &= BV_DETECT_MASK;\r\nif (status != BV_DETECT_GOOD) {\r\nif (status == BV_DETECT_WARN) val |= SS_BATWARN;\r\nelse val |= SS_BATDEAD;\r\n}\r\n}\r\nstate = cardbus_socket_readl(socket, SKT_PRE_STATE);\r\nif (state & VOL_3V_CARD_DT) val |= SS_3VCARD;\r\nif (state & VOL_XV_CARD_DT) val |= SS_XVCARD;\r\nif (state & CB_CARD_DT) val |= SS_CARDBUS;\r\nif (!(state &\r\n(VOL_YV_CARD_DT|VOL_XV_CARD_DT|VOL_3V_CARD_DT|VOL_5V_CARD_DT|CCD20|CCD10)))\r\nval |= SS_PENDING;\r\n*value = val;\r\nreturn 0;\r\n}\r\nstatic inline uint8_t set_Vcc_value(u_char Vcc)\r\n{\r\nswitch (Vcc) {\r\ncase 33:\r\nreturn VCC_3V;\r\ncase 50:\r\nreturn VCC_5V;\r\n}\r\nreturn VCC_0V;\r\n}\r\nstatic inline uint8_t set_Vpp_value(u_char Vpp)\r\n{\r\nswitch (Vpp) {\r\ncase 33:\r\ncase 50:\r\nreturn VPP_VCC;\r\ncase 120:\r\nreturn VPP_12V;\r\n}\r\nreturn VPP_0V;\r\n}\r\nstatic int cardu_set_socket(unsigned int sock, socket_state_t *state)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint8_t val;\r\nif (((state->Vpp == 33) || (state->Vpp == 50)) && (state->Vpp != state->Vcc))\r\nreturn -EINVAL;\r\nval = set_Vcc_value(state->Vcc);\r\nval |= set_Vpp_value(state->Vpp);\r\nif (state->flags & SS_OUTPUT_ENA) val |= CARD_OUT_EN;\r\nexca_writeb(socket, PWR_CNT, val);\r\nval = exca_readb(socket, INT_GEN_CNT) & CARD_REST0;\r\nif (state->flags & SS_RESET) val &= ~CARD_REST0;\r\nelse val |= CARD_REST0;\r\nif (state->flags & SS_IOCARD) val |= CARD_TYPE_IO;\r\nexca_writeb(socket, INT_GEN_CNT, val);\r\nreturn 0;\r\n}\r\nstatic int cardu_get_io_map(unsigned int sock, struct pccard_io_map *io)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint8_t ioctl, window;\r\nu_char map;\r\nmap = io->map;\r\nif (map > 1)\r\nreturn -EINVAL;\r\nio->start = exca_readw(socket, IO_WIN_SA(map));\r\nio->stop = exca_readw(socket, IO_WIN_EA(map));\r\nioctl = exca_readb(socket, IO_WIN_CNT);\r\nwindow = exca_readb(socket, ADR_WIN_EN);\r\nio->flags = (window & IO_WIN_EN(map)) ? MAP_ACTIVE : 0;\r\nif (ioctl & IO_WIN_DATA_AUTOSZ(map))\r\nio->flags |= MAP_AUTOSZ;\r\nelse if (ioctl & IO_WIN_DATA_16BIT(map))\r\nio->flags |= MAP_16BIT;\r\nreturn 0;\r\n}\r\nstatic int cardu_set_io_map(unsigned int sock, struct pccard_io_map *io)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint16_t ioctl;\r\nuint8_t window, enable;\r\nu_char map;\r\nmap = io->map;\r\nif (map > 1)\r\nreturn -EINVAL;\r\nwindow = exca_readb(socket, ADR_WIN_EN);\r\nenable = IO_WIN_EN(map);\r\nif (window & enable) {\r\nwindow &= ~enable;\r\nexca_writeb(socket, ADR_WIN_EN, window);\r\n}\r\nexca_writew(socket, IO_WIN_SA(map), io->start);\r\nexca_writew(socket, IO_WIN_EA(map), io->stop);\r\nioctl = exca_readb(socket, IO_WIN_CNT) & ~IO_WIN_CNT_MASK(map);\r\nif (io->flags & MAP_AUTOSZ) ioctl |= IO_WIN_DATA_AUTOSZ(map);\r\nelse if (io->flags & MAP_16BIT) ioctl |= IO_WIN_DATA_16BIT(map);\r\nexca_writeb(socket, IO_WIN_CNT, ioctl);\r\nif (io->flags & MAP_ACTIVE)\r\nexca_writeb(socket, ADR_WIN_EN, window | enable);\r\nreturn 0;\r\n}\r\nstatic int cardu_get_mem_map(unsigned int sock, struct pccard_mem_map *mem)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint32_t start, stop, offset, page;\r\nuint8_t window;\r\nu_char map;\r\nmap = mem->map;\r\nif (map > 4)\r\nreturn -EINVAL;\r\nwindow = exca_readb(socket, ADR_WIN_EN);\r\nmem->flags = (window & MEM_WIN_EN(map)) ? MAP_ACTIVE : 0;\r\nstart = exca_readw(socket, MEM_WIN_SA(map));\r\nmem->flags |= (start & MEM_WIN_DSIZE) ? MAP_16BIT : 0;\r\nstart = (start & 0x0fff) << 12;\r\nstop = exca_readw(socket, MEM_WIN_EA(map));\r\nstop = ((stop & 0x0fff) << 12) + 0x0fff;\r\noffset = exca_readw(socket, MEM_WIN_OA(map));\r\nmem->flags |= (offset & MEM_WIN_WP) ? MAP_WRPROT : 0;\r\nmem->flags |= (offset & MEM_WIN_REGSET) ? MAP_ATTRIB : 0;\r\noffset = ((offset & 0x3fff) << 12) + start;\r\nmem->card_start = offset & 0x03ffffff;\r\npage = exca_readb(socket, MEM_WIN_SAU(map)) << 24;\r\nmem->sys_start = start + page;\r\nmem->sys_stop = start + page;\r\nreturn 0;\r\n}\r\nstatic int cardu_set_mem_map(unsigned int sock, struct pccard_mem_map *mem)\r\n{\r\nvrc4173_socket_t *socket = &cardu_sockets[sock];\r\nuint16_t value;\r\nuint8_t window, enable;\r\nu_long sys_start, sys_stop, card_start;\r\nu_char map;\r\nmap = mem->map;\r\nsys_start = mem->sys_start;\r\nsys_stop = mem->sys_stop;\r\ncard_start = mem->card_start;\r\nif (map > 4 || sys_start > sys_stop || ((sys_start ^ sys_stop) >> 24) ||\r\n(card_start >> 26))\r\nreturn -EINVAL;\r\nwindow = exca_readb(socket, ADR_WIN_EN);\r\nenable = MEM_WIN_EN(map);\r\nif (window & enable) {\r\nwindow &= ~enable;\r\nexca_writeb(socket, ADR_WIN_EN, window);\r\n}\r\nexca_writeb(socket, MEM_WIN_SAU(map), sys_start >> 24);\r\nvalue = (sys_start >> 12) & 0x0fff;\r\nif (mem->flags & MAP_16BIT) value |= MEM_WIN_DSIZE;\r\nexca_writew(socket, MEM_WIN_SA(map), value);\r\nvalue = (sys_stop >> 12) & 0x0fff;\r\nexca_writew(socket, MEM_WIN_EA(map), value);\r\nvalue = ((card_start - sys_start) >> 12) & 0x3fff;\r\nif (mem->flags & MAP_WRPROT) value |= MEM_WIN_WP;\r\nif (mem->flags & MAP_ATTRIB) value |= MEM_WIN_REGSET;\r\nexca_writew(socket, MEM_WIN_OA(map), value);\r\nif (mem->flags & MAP_ACTIVE)\r\nexca_writeb(socket, ADR_WIN_EN, window | enable);\r\nreturn 0;\r\n}\r\nstatic void cardu_proc_setup(unsigned int sock, struct proc_dir_entry *base)\r\n{\r\n}\r\nstatic void cardu_bh(void *data)\r\n{\r\nvrc4173_socket_t *socket = (vrc4173_socket_t *)data;\r\nuint16_t events;\r\nspin_lock_irq(&socket->event_lock);\r\nevents = socket->events;\r\nsocket->events = 0;\r\nspin_unlock_irq(&socket->event_lock);\r\nif (socket->handler)\r\nsocket->handler(socket->info, events);\r\n}\r\nstatic uint16_t get_events(vrc4173_socket_t *socket)\r\n{\r\nuint16_t events = 0;\r\nuint8_t csc, status;\r\nstatus = exca_readb(socket, IF_STATUS);\r\ncsc = exca_readb(socket, CARD_SC);\r\nif ((csc & CARD_DT_CHG) &&\r\n((status & (CARD_DETECT1|CARD_DETECT2)) == (CARD_DETECT1|CARD_DETECT2)))\r\nevents |= SS_DETECT;\r\nif ((csc & RDY_CHG) && (status & READY))\r\nevents |= SS_READY;\r\nif (exca_readb(socket, INT_GEN_CNT) & CARD_TYPE_IO) {\r\nif ((csc & BAT_DEAD_ST_CHG) && (status & STSCHG))\r\nevents |= SS_STSCHG;\r\n} else {\r\nif (csc & (BAT_WAR_CHG|BAT_DEAD_ST_CHG)) {\r\nif ((status & BV_DETECT_MASK) != BV_DETECT_GOOD) {\r\nif (status == BV_DETECT_WARN) events |= SS_BATWARN;\r\nelse events |= SS_BATDEAD;\r\n}\r\n}\r\n}\r\nreturn events;\r\n}\r\nstatic void cardu_interrupt(int irq, void *dev_id)\r\n{\r\nvrc4173_socket_t *socket = (vrc4173_socket_t *)dev_id;\r\nuint16_t events;\r\nINIT_WORK(&socket->tq_work, cardu_bh, socket);\r\nevents = get_events(socket);\r\nif (events) {\r\nspin_lock(&socket->event_lock);\r\nsocket->events |= events;\r\nspin_unlock(&socket->event_lock);\r\nschedule_work(&socket->tq_work);\r\n}\r\n}\r\nstatic int vrc4173_cardu_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nvrc4173_socket_t *socket;\r\nunsigned long start, len, flags;\r\nint slot, err, ret;\r\nslot = vrc4173_cardu_slots++;\r\nsocket = &cardu_sockets[slot];\r\nif (socket->noprobe != 0)\r\nreturn -EBUSY;\r\nsprintf(socket->name, "NEC VRC4173 CARDU%1d", slot+1);\r\nif ((err = pci_enable_device(dev)) < 0)\r\nreturn err;\r\nstart = pci_resource_start(dev, 0);\r\nif (start == 0) {\r\nret = -ENODEV;\r\ngoto disable;\r\n}\r\nlen = pci_resource_len(dev, 0);\r\nif (len == 0) {\r\nret = -ENODEV;\r\ngoto disable;\r\n}\r\nflags = pci_resource_flags(dev, 0);\r\nif ((flags & IORESOURCE_MEM) == 0) {\r\nret = -EBUSY;\r\ngoto disable;\r\n}\r\nerr = pci_request_regions(dev, socket->name);\r\nif (err < 0) {\r\nret = err;\r\ngoto disable;\r\n}\r\nsocket->base = ioremap(start, len);\r\nif (socket->base == NULL) {\r\nret = -ENODEV;\r\ngoto release;\r\n}\r\nsocket->dev = dev;\r\nsocket->pcmcia_socket = pcmcia_register_socket(slot, &cardu_operations, 1);\r\nif (socket->pcmcia_socket == NULL) {\r\nret = -ENOMEM;\r\ngoto unmap;\r\n}\r\nif (request_irq(dev->irq, cardu_interrupt, IRQF_SHARED, socket->name, socket) < 0) {\r\nret = -EBUSY;\r\ngoto unregister;\r\n}\r\nprintk(KERN_INFO "%s at %#08lx, IRQ %d\n", socket->name, start, dev->irq);\r\nreturn 0;\r\nunregister:\r\npcmcia_unregister_socket(socket->pcmcia_socket);\r\nsocket->pcmcia_socket = NULL;\r\nunmap:\r\niounmap(socket->base);\r\nsocket->base = NULL;\r\nrelease:\r\npci_release_regions(dev);\r\ndisable:\r\npci_disable_device(dev);\r\nreturn ret;\r\n}\r\nstatic int vrc4173_cardu_setup(char *options)\r\n{\r\nif (options == NULL || *options == '\0')\r\nreturn 1;\r\nif (strncmp(options, "cardu1:", 7) == 0) {\r\noptions += 7;\r\nif (*options != '\0') {\r\nif (strncmp(options, "noprobe", 7) == 0) {\r\ncardu_sockets[CARDU1].noprobe = 1;\r\noptions += 7;\r\n}\r\nif (*options != ',')\r\nreturn 1;\r\n} else\r\nreturn 1;\r\n}\r\nif (strncmp(options, "cardu2:", 7) == 0) {\r\noptions += 7;\r\nif ((*options != '\0') && (strncmp(options, "noprobe", 7) == 0))\r\ncardu_sockets[CARDU2].noprobe = 1;\r\n}\r\nreturn 1;\r\n}\r\nstatic int vrc4173_cardu_init(void)\r\n{\r\nvrc4173_cardu_slots = 0;\r\nreturn pci_register_driver(&vrc4173_cardu_driver);\r\n}\r\nstatic void vrc4173_cardu_exit(void)\r\n{\r\npci_unregister_driver(&vrc4173_cardu_driver);\r\n}

static inline u32 sossi_read_reg(int reg)\r\n{\r\nreturn readl(sossi.base + reg);\r\n}\r\nstatic inline u16 sossi_read_reg16(int reg)\r\n{\r\nreturn readw(sossi.base + reg);\r\n}\r\nstatic inline u8 sossi_read_reg8(int reg)\r\n{\r\nreturn readb(sossi.base + reg);\r\n}\r\nstatic inline void sossi_write_reg(int reg, u32 value)\r\n{\r\nwritel(value, sossi.base + reg);\r\n}\r\nstatic inline void sossi_write_reg16(int reg, u16 value)\r\n{\r\nwritew(value, sossi.base + reg);\r\n}\r\nstatic inline void sossi_write_reg8(int reg, u8 value)\r\n{\r\nwriteb(value, sossi.base + reg);\r\n}\r\nstatic void sossi_set_bits(int reg, u32 bits)\r\n{\r\nsossi_write_reg(reg, sossi_read_reg(reg) | bits);\r\n}\r\nstatic void sossi_clear_bits(int reg, u32 bits)\r\n{\r\nsossi_write_reg(reg, sossi_read_reg(reg) & ~bits);\r\n}\r\nstatic u32 ps_to_sossi_ticks(u32 ps, int div)\r\n{\r\nu32 clk_period = HZ_TO_PS(sossi.fck_hz) * div;\r\nreturn (clk_period + ps - 1) / clk_period;\r\n}\r\nstatic int calc_rd_timings(struct extif_timings *t)\r\n{\r\nu32 tw0, tw1;\r\nint reon, reoff, recyc, actim;\r\nint div = t->clk_div;\r\nreon = ps_to_sossi_ticks(t->re_on_time, div);\r\nif (reon > 1)\r\nreturn -1;\r\nreoff = ps_to_sossi_ticks(t->re_off_time, div);\r\nif (reoff <= reon)\r\nreoff = reon + 1;\r\ntw0 = reoff - reon;\r\nif (tw0 > 0x10)\r\nreturn -1;\r\nrecyc = ps_to_sossi_ticks(t->re_cycle_time, div);\r\nif (recyc <= reoff)\r\nrecyc = reoff + 1;\r\ntw1 = recyc - tw0;\r\nif (tw1 < 3)\r\ntw1 = 3;\r\nif (tw1 > 0x40)\r\nreturn -1;\r\nactim = ps_to_sossi_ticks(t->access_time, div);\r\nif (actim < reoff)\r\nactim++;\r\nif (actim - reoff > 1)\r\nreturn -1;\r\nt->tim[0] = tw0 - 1;\r\nt->tim[1] = tw1 - 1;\r\nreturn 0;\r\n}\r\nstatic int calc_wr_timings(struct extif_timings *t)\r\n{\r\nu32 tw0, tw1;\r\nint weon, weoff, wecyc;\r\nint div = t->clk_div;\r\nweon = ps_to_sossi_ticks(t->we_on_time, div);\r\nif (weon > 1)\r\nreturn -1;\r\nweoff = ps_to_sossi_ticks(t->we_off_time, div);\r\nif (weoff <= weon)\r\nweoff = weon + 1;\r\ntw0 = weoff - weon;\r\nif (tw0 > 0x10)\r\nreturn -1;\r\nwecyc = ps_to_sossi_ticks(t->we_cycle_time, div);\r\nif (wecyc <= weoff)\r\nwecyc = weoff + 1;\r\ntw1 = wecyc - tw0;\r\nif (tw1 < 3)\r\ntw1 = 3;\r\nif (tw1 > 0x40)\r\nreturn -1;\r\nt->tim[2] = tw0 - 1;\r\nt->tim[3] = tw1 - 1;\r\nreturn 0;\r\n}\r\nstatic void _set_timing(int div, int tw0, int tw1)\r\n{\r\nu32 l;\r\n#ifdef VERBOSE\r\ndev_dbg(sossi.fbdev->dev, "Using TW0 = %d, TW1 = %d, div = %d\n",\r\ntw0 + 1, tw1 + 1, div);\r\n#endif\r\nclk_set_rate(sossi.fck, sossi.fck_hz / div);\r\nclk_enable(sossi.fck);\r\nl = sossi_read_reg(SOSSI_INIT1_REG);\r\nl &= ~((0x0f << 20) | (0x3f << 24));\r\nl |= (tw0 << 20) | (tw1 << 24);\r\nsossi_write_reg(SOSSI_INIT1_REG, l);\r\nclk_disable(sossi.fck);\r\n}\r\nstatic void _set_bits_per_cycle(int bus_pick_count, int bus_pick_width)\r\n{\r\nu32 l;\r\nl = sossi_read_reg(SOSSI_INIT3_REG);\r\nl &= ~0x3ff;\r\nl |= ((bus_pick_count - 1) << 5) | ((bus_pick_width - 1) & 0x1f);\r\nsossi_write_reg(SOSSI_INIT3_REG, l);\r\n}\r\nstatic void _set_tearsync_mode(int mode, unsigned line)\r\n{\r\nu32 l;\r\nl = sossi_read_reg(SOSSI_TEARING_REG);\r\nl &= ~(((1 << 11) - 1) << 15);\r\nl |= line << 15;\r\nl &= ~(0x3 << 26);\r\nl |= mode << 26;\r\nsossi_write_reg(SOSSI_TEARING_REG, l);\r\nif (mode)\r\nsossi_set_bits(SOSSI_INIT2_REG, 1 << 6);\r\nelse\r\nsossi_clear_bits(SOSSI_INIT2_REG, 1 << 6);\r\n}\r\nstatic inline void set_timing(int access)\r\n{\r\nif (access != sossi.last_access) {\r\nsossi.last_access = access;\r\n_set_timing(sossi.clk_div,\r\nsossi.clk_tw0[access], sossi.clk_tw1[access]);\r\n}\r\n}\r\nstatic void sossi_start_transfer(void)\r\n{\r\nsossi_clear_bits(SOSSI_INIT2_REG, 1 << 4);\r\nsossi_clear_bits(SOSSI_INIT1_REG, 1 << 30);\r\n}\r\nstatic void sossi_stop_transfer(void)\r\n{\r\nsossi_set_bits(SOSSI_INIT2_REG, 1 << 4);\r\nsossi_set_bits(SOSSI_INIT1_REG, 1 << 30);\r\n}\r\nstatic void wait_end_of_write(void)\r\n{\r\nwhile (!(sossi_read_reg(SOSSI_INIT2_REG) & (1 << 3)));\r\n}\r\nstatic void send_data(const void *data, unsigned int len)\r\n{\r\nwhile (len >= 4) {\r\nsossi_write_reg(SOSSI_FIFO_REG, *(const u32 *) data);\r\nlen -= 4;\r\ndata += 4;\r\n}\r\nwhile (len >= 2) {\r\nsossi_write_reg16(SOSSI_FIFO_REG, *(const u16 *) data);\r\nlen -= 2;\r\ndata += 2;\r\n}\r\nwhile (len) {\r\nsossi_write_reg8(SOSSI_FIFO_REG, *(const u8 *) data);\r\nlen--;\r\ndata++;\r\n}\r\n}\r\nstatic void set_cycles(unsigned int len)\r\n{\r\nunsigned long nr_cycles = len / (sossi.bus_pick_width / 8);\r\nBUG_ON((nr_cycles - 1) & ~0x3ffff);\r\nsossi_clear_bits(SOSSI_INIT1_REG, 0x3ffff);\r\nsossi_set_bits(SOSSI_INIT1_REG, (nr_cycles - 1) & 0x3ffff);\r\n}\r\nstatic int sossi_convert_timings(struct extif_timings *t)\r\n{\r\nint r = 0;\r\nint div = t->clk_div;\r\nt->converted = 0;\r\nif (div <= 0 || div > 8)\r\nreturn -1;\r\nif ((r = calc_rd_timings(t)) < 0)\r\nreturn r;\r\nif ((r = calc_wr_timings(t)) < 0)\r\nreturn r;\r\nt->tim[4] = div;\r\nt->converted = 1;\r\nreturn 0;\r\n}\r\nstatic void sossi_set_timings(const struct extif_timings *t)\r\n{\r\nBUG_ON(!t->converted);\r\nsossi.clk_tw0[RD_ACCESS] = t->tim[0];\r\nsossi.clk_tw1[RD_ACCESS] = t->tim[1];\r\nsossi.clk_tw0[WR_ACCESS] = t->tim[2];\r\nsossi.clk_tw1[WR_ACCESS] = t->tim[3];\r\nsossi.clk_div = t->tim[4];\r\n}\r\nstatic void sossi_get_clk_info(u32 *clk_period, u32 *max_clk_div)\r\n{\r\n*clk_period = HZ_TO_PS(sossi.fck_hz);\r\n*max_clk_div = 8;\r\n}\r\nstatic void sossi_set_bits_per_cycle(int bpc)\r\n{\r\nint bus_pick_count, bus_pick_width;\r\nswitch (bpc) {\r\ncase 8:\r\nbus_pick_count = 4;\r\nbus_pick_width = 8;\r\nbreak;\r\ncase 16:\r\nbus_pick_count = 2;\r\nbus_pick_width = 16;\r\nbreak;\r\ndefault:\r\nBUG();\r\nreturn;\r\n}\r\nsossi.bus_pick_width = bus_pick_width;\r\nsossi.bus_pick_count = bus_pick_count;\r\n}\r\nstatic int sossi_setup_tearsync(unsigned pin_cnt,\r\nunsigned hs_pulse_time, unsigned vs_pulse_time,\r\nint hs_pol_inv, int vs_pol_inv, int div)\r\n{\r\nint hs, vs;\r\nu32 l;\r\nif (pin_cnt != 1 || div < 1 || div > 8)\r\nreturn -EINVAL;\r\nhs = ps_to_sossi_ticks(hs_pulse_time, div);\r\nvs = ps_to_sossi_ticks(vs_pulse_time, div);\r\nif (vs < 8 || vs <= hs || vs >= (1 << 12))\r\nreturn -EDOM;\r\nvs /= 8;\r\nvs--;\r\nif (hs > 8)\r\nhs = 8;\r\nif (hs)\r\nhs--;\r\ndev_dbg(sossi.fbdev->dev,\r\n"setup_tearsync: hs %d vs %d hs_inv %d vs_inv %d\n",\r\nhs, vs, hs_pol_inv, vs_pol_inv);\r\nclk_enable(sossi.fck);\r\nl = sossi_read_reg(SOSSI_TEARING_REG);\r\nl &= ~((1 << 15) - 1);\r\nl |= vs << 3;\r\nl |= hs;\r\nif (hs_pol_inv)\r\nl |= 1 << 29;\r\nelse\r\nl &= ~(1 << 29);\r\nif (vs_pol_inv)\r\nl |= 1 << 28;\r\nelse\r\nl &= ~(1 << 28);\r\nsossi_write_reg(SOSSI_TEARING_REG, l);\r\nclk_disable(sossi.fck);\r\nreturn 0;\r\n}\r\nstatic int sossi_enable_tearsync(int enable, unsigned line)\r\n{\r\nint mode;\r\ndev_dbg(sossi.fbdev->dev, "tearsync %d line %d\n", enable, line);\r\nif (line >= 1 << 11)\r\nreturn -EINVAL;\r\nif (enable) {\r\nif (line)\r\nmode = 2;\r\nelse\r\nmode = 3;\r\n} else\r\nmode = 0;\r\nsossi.tearsync_line = line;\r\nsossi.tearsync_mode = mode;\r\nreturn 0;\r\n}\r\nstatic void sossi_write_command(const void *data, unsigned int len)\r\n{\r\nclk_enable(sossi.fck);\r\nset_timing(WR_ACCESS);\r\n_set_bits_per_cycle(sossi.bus_pick_count, sossi.bus_pick_width);\r\nsossi_clear_bits(SOSSI_INIT1_REG, 1 << 18);\r\nset_cycles(len);\r\nsossi_start_transfer();\r\nsend_data(data, len);\r\nsossi_stop_transfer();\r\nwait_end_of_write();\r\nclk_disable(sossi.fck);\r\n}\r\nstatic void sossi_write_data(const void *data, unsigned int len)\r\n{\r\nclk_enable(sossi.fck);\r\nset_timing(WR_ACCESS);\r\n_set_bits_per_cycle(sossi.bus_pick_count, sossi.bus_pick_width);\r\nsossi_set_bits(SOSSI_INIT1_REG, 1 << 18);\r\nset_cycles(len);\r\nsossi_start_transfer();\r\nsend_data(data, len);\r\nsossi_stop_transfer();\r\nwait_end_of_write();\r\nclk_disable(sossi.fck);\r\n}\r\nstatic void sossi_transfer_area(int width, int height,\r\nvoid (callback)(void *data), void *data)\r\n{\r\nBUG_ON(callback == NULL);\r\nsossi.lcdc_callback = callback;\r\nsossi.lcdc_callback_data = data;\r\nclk_enable(sossi.fck);\r\nset_timing(WR_ACCESS);\r\n_set_bits_per_cycle(sossi.bus_pick_count, sossi.bus_pick_width);\r\n_set_tearsync_mode(sossi.tearsync_mode, sossi.tearsync_line);\r\nsossi_set_bits(SOSSI_INIT1_REG, 1 << 18);\r\nset_cycles(width * height * sossi.bus_pick_width / 8);\r\nsossi_start_transfer();\r\nif (sossi.tearsync_mode) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&sossi.lock, flags);\r\nsossi.vsync_dma_pending++;\r\nspin_unlock_irqrestore(&sossi.lock, flags);\r\n} else\r\nomap_enable_lcd_dma();\r\n}\r\nstatic void sossi_dma_callback(void *data)\r\n{\r\nomap_stop_lcd_dma();\r\nsossi_stop_transfer();\r\nclk_disable(sossi.fck);\r\nsossi.lcdc_callback(sossi.lcdc_callback_data);\r\n}\r\nstatic void sossi_read_data(void *data, unsigned int len)\r\n{\r\nclk_enable(sossi.fck);\r\nset_timing(RD_ACCESS);\r\n_set_bits_per_cycle(sossi.bus_pick_count, sossi.bus_pick_width);\r\nsossi_set_bits(SOSSI_INIT1_REG, 1 << 18);\r\nset_cycles(len);\r\nsossi_start_transfer();\r\nwhile (len >= 4) {\r\n*(u32 *) data = sossi_read_reg(SOSSI_FIFO_REG);\r\nlen -= 4;\r\ndata += 4;\r\n}\r\nwhile (len >= 2) {\r\n*(u16 *) data = sossi_read_reg16(SOSSI_FIFO_REG);\r\nlen -= 2;\r\ndata += 2;\r\n}\r\nwhile (len) {\r\n*(u8 *) data = sossi_read_reg8(SOSSI_FIFO_REG);\r\nlen--;\r\ndata++;\r\n}\r\nsossi_stop_transfer();\r\nclk_disable(sossi.fck);\r\n}\r\nstatic irqreturn_t sossi_match_irq(int irq, void *data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&sossi.lock, flags);\r\nif (sossi.vsync_dma_pending) {\r\nsossi.vsync_dma_pending--;\r\nomap_enable_lcd_dma();\r\n}\r\nspin_unlock_irqrestore(&sossi.lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sossi_init(struct omapfb_device *fbdev)\r\n{\r\nu32 l, k;\r\nstruct clk *fck;\r\nstruct clk *dpll1out_ck;\r\nint r;\r\nsossi.base = ioremap(OMAP_SOSSI_BASE, SZ_1K);\r\nif (!sossi.base) {\r\ndev_err(fbdev->dev, "can't ioremap SoSSI\n");\r\nreturn -ENOMEM;\r\n}\r\nsossi.fbdev = fbdev;\r\nspin_lock_init(&sossi.lock);\r\ndpll1out_ck = clk_get(fbdev->dev, "ck_dpll1out");\r\nif (IS_ERR(dpll1out_ck)) {\r\ndev_err(fbdev->dev, "can't get DPLL1OUT clock\n");\r\nreturn PTR_ERR(dpll1out_ck);\r\n}\r\nsossi.fck_hz = clk_get_rate(dpll1out_ck);\r\nclk_put(dpll1out_ck);\r\nfck = clk_get(fbdev->dev, "ck_sossi");\r\nif (IS_ERR(fck)) {\r\ndev_err(fbdev->dev, "can't get SoSSI functional clock\n");\r\nreturn PTR_ERR(fck);\r\n}\r\nsossi.fck = fck;\r\nl = omap_readl(MOD_CONF_CTRL_1);\r\nl |= CONF_SOSSI_RESET_R;\r\nomap_writel(l, MOD_CONF_CTRL_1);\r\nl &= ~CONF_SOSSI_RESET_R;\r\nomap_writel(l, MOD_CONF_CTRL_1);\r\nclk_enable(sossi.fck);\r\nl = omap_readl(ARM_IDLECT2);\r\nl &= ~(1 << 8);\r\nomap_writel(l, ARM_IDLECT2);\r\nl = sossi_read_reg(SOSSI_INIT2_REG);\r\nl |= (1 << 0) | (1 << 1);\r\nsossi_write_reg(SOSSI_INIT2_REG, l);\r\nl &= ~(1 << 1);\r\nsossi_write_reg(SOSSI_INIT2_REG, l);\r\nsossi_write_reg(SOSSI_ID_REG, 0);\r\nl = sossi_read_reg(SOSSI_ID_REG);\r\nk = sossi_read_reg(SOSSI_ID_REG);\r\nif (l != 0x55555555 || k != 0xaaaaaaaa) {\r\ndev_err(fbdev->dev,\r\n"invalid SoSSI sync pattern: %08x, %08x\n", l, k);\r\nr = -ENODEV;\r\ngoto err;\r\n}\r\nif ((r = omap_lcdc_set_dma_callback(sossi_dma_callback, NULL)) < 0) {\r\ndev_err(fbdev->dev, "can't get LCDC IRQ\n");\r\nr = -ENODEV;\r\ngoto err;\r\n}\r\nl = sossi_read_reg(SOSSI_ID_REG);\r\nl = sossi_read_reg(SOSSI_ID_REG);\r\ndev_info(fbdev->dev, "SoSSI version %d.%d initialized\n",\r\nl >> 16, l & 0xffff);\r\nl = sossi_read_reg(SOSSI_INIT1_REG);\r\nl |= (1 << 19);\r\nl &= ~(1 << 31);\r\nsossi_write_reg(SOSSI_INIT1_REG, l);\r\nif ((r = request_irq(INT_1610_SoSSI_MATCH, sossi_match_irq,\r\nIRQ_TYPE_EDGE_FALLING,\r\n"sossi_match", sossi.fbdev->dev)) < 0) {\r\ndev_err(sossi.fbdev->dev, "can't get SoSSI match IRQ\n");\r\ngoto err;\r\n}\r\nclk_disable(sossi.fck);\r\nreturn 0;\r\nerr:\r\nclk_disable(sossi.fck);\r\nclk_put(sossi.fck);\r\nreturn r;\r\n}\r\nstatic void sossi_cleanup(void)\r\n{\r\nomap_lcdc_free_dma_callback();\r\nclk_put(sossi.fck);\r\niounmap(sossi.base);\r\n}

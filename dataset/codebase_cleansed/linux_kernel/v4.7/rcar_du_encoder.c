struct drm_encoder *\r\nrcar_du_connector_best_encoder(struct drm_connector *connector)\r\n{\r\nstruct rcar_du_connector *rcon = to_rcar_connector(connector);\r\nreturn rcar_encoder_to_drm_encoder(rcon->encoder);\r\n}\r\nstatic void rcar_du_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_encoder *renc = to_rcar_encoder(encoder);\r\nif (renc->lvds)\r\nrcar_du_lvdsenc_enable(renc->lvds, encoder->crtc, false);\r\n}\r\nstatic void rcar_du_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_encoder *renc = to_rcar_encoder(encoder);\r\nif (renc->lvds)\r\nrcar_du_lvdsenc_enable(renc->lvds, encoder->crtc, true);\r\n}\r\nstatic int rcar_du_encoder_atomic_check(struct drm_encoder *encoder,\r\nstruct drm_crtc_state *crtc_state,\r\nstruct drm_connector_state *conn_state)\r\n{\r\nstruct rcar_du_encoder *renc = to_rcar_encoder(encoder);\r\nstruct drm_display_mode *adjusted_mode = &crtc_state->adjusted_mode;\r\nconst struct drm_display_mode *mode = &crtc_state->mode;\r\nconst struct drm_display_mode *panel_mode;\r\nstruct drm_connector *connector = conn_state->connector;\r\nstruct drm_device *dev = encoder->dev;\r\nif (encoder->encoder_type == DRM_MODE_ENCODER_DAC)\r\nreturn 0;\r\nif (list_empty(&connector->modes)) {\r\ndev_dbg(dev->dev, "encoder: empty modes list\n");\r\nreturn -EINVAL;\r\n}\r\npanel_mode = list_first_entry(&connector->modes,\r\nstruct drm_display_mode, head);\r\nif (mode->hdisplay != panel_mode->hdisplay ||\r\nmode->vdisplay != panel_mode->vdisplay)\r\nreturn -EINVAL;\r\ndrm_mode_copy(adjusted_mode, panel_mode);\r\nif (renc->lvds)\r\nrcar_du_lvdsenc_atomic_check(renc->lvds, adjusted_mode);\r\nreturn 0;\r\n}\r\nstatic void rcar_du_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct rcar_du_encoder *renc = to_rcar_encoder(encoder);\r\nrcar_du_crtc_route_output(encoder->crtc, renc->output);\r\n}\r\nint rcar_du_encoder_init(struct rcar_du_device *rcdu,\r\nenum rcar_du_encoder_type type,\r\nenum rcar_du_output output,\r\nstruct device_node *enc_node,\r\nstruct device_node *con_node)\r\n{\r\nstruct rcar_du_encoder *renc;\r\nstruct drm_encoder *encoder;\r\nunsigned int encoder_type;\r\nint ret;\r\nrenc = devm_kzalloc(rcdu->dev, sizeof(*renc), GFP_KERNEL);\r\nif (renc == NULL)\r\nreturn -ENOMEM;\r\nrenc->output = output;\r\nencoder = rcar_encoder_to_drm_encoder(renc);\r\nswitch (output) {\r\ncase RCAR_DU_OUTPUT_LVDS0:\r\nrenc->lvds = rcdu->lvds[0];\r\nbreak;\r\ncase RCAR_DU_OUTPUT_LVDS1:\r\nrenc->lvds = rcdu->lvds[1];\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (type) {\r\ncase RCAR_DU_ENCODER_VGA:\r\nencoder_type = DRM_MODE_ENCODER_DAC;\r\nbreak;\r\ncase RCAR_DU_ENCODER_LVDS:\r\nencoder_type = DRM_MODE_ENCODER_LVDS;\r\nbreak;\r\ncase RCAR_DU_ENCODER_HDMI:\r\nencoder_type = DRM_MODE_ENCODER_TMDS;\r\nbreak;\r\ncase RCAR_DU_ENCODER_NONE:\r\ndefault:\r\nencoder_type = rcdu->info->routes[output].encoder_type;\r\nbreak;\r\n}\r\nif (type == RCAR_DU_ENCODER_HDMI) {\r\nret = rcar_du_hdmienc_init(rcdu, renc, enc_node);\r\nif (ret < 0)\r\ngoto done;\r\n} else {\r\nret = drm_encoder_init(rcdu->ddev, encoder, &encoder_funcs,\r\nencoder_type, NULL);\r\nif (ret < 0)\r\ngoto done;\r\ndrm_encoder_helper_add(encoder, &encoder_helper_funcs);\r\n}\r\nswitch (encoder_type) {\r\ncase DRM_MODE_ENCODER_LVDS:\r\nret = rcar_du_lvds_connector_init(rcdu, renc, con_node);\r\nbreak;\r\ncase DRM_MODE_ENCODER_DAC:\r\nret = rcar_du_vga_connector_init(rcdu, renc);\r\nbreak;\r\ncase DRM_MODE_ENCODER_TMDS:\r\nret = rcar_du_hdmi_connector_init(rcdu, renc);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ndone:\r\nif (ret < 0) {\r\nif (encoder->name)\r\nencoder->funcs->destroy(encoder);\r\ndevm_kfree(rcdu->dev, renc);\r\n}\r\nreturn ret;\r\n}

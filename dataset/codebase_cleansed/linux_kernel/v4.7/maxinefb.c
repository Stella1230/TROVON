void maxinefb_ims332_write_register(int regno, register unsigned int val)\r\n{\r\nregister unsigned char *regs = (char *) MAXINEFB_IMS332_ADDRESS;\r\nunsigned char *wptr;\r\nwptr = regs + 0xa0000 + (regno << 4);\r\n*((volatile unsigned int *) (regs)) = (val >> 8) & 0xff00;\r\n*((volatile unsigned short *) (wptr)) = val;\r\n}\r\nunsigned int maxinefb_ims332_read_register(int regno)\r\n{\r\nregister unsigned char *regs = (char *) MAXINEFB_IMS332_ADDRESS;\r\nunsigned char *rptr;\r\nregister unsigned int j, k;\r\nrptr = regs + 0x80000 + (regno << 4);\r\nj = *((volatile unsigned short *) rptr);\r\nk = *((volatile unsigned short *) regs);\r\nreturn (j & 0xffff) | ((k & 0xff00) << 8);\r\n}\r\nstatic int maxinefb_setcolreg(unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp, struct fb_info *info)\r\n{\r\nunsigned long hw_colorvalue = 0;\r\nif (regno > 255)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nhw_colorvalue = (blue << 16) + (green << 8) + (red);\r\nmaxinefb_ims332_write_register(IMS332_REG_COLOR_PALETTE + regno,\r\nhw_colorvalue);\r\nreturn 0;\r\n}\r\nint __init maxinefb_init(void)\r\n{\r\nunsigned long fboff;\r\nunsigned long fb_start;\r\nint i;\r\nif (fb_get_options("maxinefb", NULL))\r\nreturn -ENODEV;\r\nif (mips_machtype != MACH_DS5000_XX) {\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_INFO "Maxinefb: Personal DECstation detected\n");\r\nprintk(KERN_INFO "Maxinefb: initializing onboard framebuffer\n");\r\nfb_start = DS5000_xx_ONBOARD_FBMEM_START;\r\nfor (fboff = fb_start; fboff < fb_start + 0x1ffff; fboff++)\r\n*(volatile unsigned char *)fboff = 0x0;\r\nmaxinefb_fix.smem_start = fb_start;\r\nfor (i = 0; i < 512; i++) {\r\nmaxinefb_ims332_write_register(IMS332_REG_CURSOR_RAM + i,\r\n0);\r\n}\r\nfb_info.fbops = &maxinefb_ops;\r\nfb_info.screen_base = (char *)maxinefb_fix.smem_start;\r\nfb_info.var = maxinefb_defined;\r\nfb_info.fix = maxinefb_fix;\r\nfb_info.flags = FBINFO_DEFAULT;\r\nfb_alloc_cmap(&fb_info.cmap, 256, 0);\r\nif (register_framebuffer(&fb_info) < 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void __exit maxinefb_exit(void)\r\n{\r\nunregister_framebuffer(&fb_info);\r\n}

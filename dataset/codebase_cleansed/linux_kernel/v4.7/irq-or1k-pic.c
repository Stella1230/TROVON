static void or1k_pic_mask(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICMR, mfspr(SPR_PICMR) & ~(1UL << data->hwirq));\r\n}\r\nstatic void or1k_pic_unmask(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICMR, mfspr(SPR_PICMR) | (1UL << data->hwirq));\r\n}\r\nstatic void or1k_pic_ack(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICSR, (1UL << data->hwirq));\r\n}\r\nstatic void or1k_pic_mask_ack(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICMR, mfspr(SPR_PICMR) & ~(1UL << data->hwirq));\r\nmtspr(SPR_PICSR, (1UL << data->hwirq));\r\n}\r\nstatic void or1k_pic_or1200_ack(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICSR, mfspr(SPR_PICSR) & ~(1UL << data->hwirq));\r\n}\r\nstatic void or1k_pic_or1200_mask_ack(struct irq_data *data)\r\n{\r\nmtspr(SPR_PICMR, mfspr(SPR_PICMR) & ~(1UL << data->hwirq));\r\nmtspr(SPR_PICSR, mfspr(SPR_PICSR) & ~(1UL << data->hwirq));\r\n}\r\nstatic inline int pic_get_irq(int first)\r\n{\r\nint hwirq;\r\nhwirq = ffs(mfspr(SPR_PICSR) >> first);\r\nif (!hwirq)\r\nreturn NO_IRQ;\r\nelse\r\nhwirq = hwirq + first - 1;\r\nreturn hwirq;\r\n}\r\nstatic void or1k_pic_handle_irq(struct pt_regs *regs)\r\n{\r\nint irq = -1;\r\nwhile ((irq = pic_get_irq(irq + 1)) != NO_IRQ)\r\nhandle_domain_irq(root_domain, irq, regs);\r\n}\r\nstatic int or1k_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hw)\r\n{\r\nstruct or1k_pic_dev *pic = d->host_data;\r\nirq_set_chip_and_handler(irq, &pic->chip, pic->handle);\r\nirq_set_status_flags(irq, pic->flags);\r\nreturn 0;\r\n}\r\nstatic int __init or1k_pic_init(struct device_node *node,\r\nstruct or1k_pic_dev *pic)\r\n{\r\nmtspr(SPR_PICMR, (0UL));\r\nroot_domain = irq_domain_add_linear(node, 32, &or1k_irq_domain_ops,\r\npic);\r\nset_handle_irq(or1k_pic_handle_irq);\r\nreturn 0;\r\n}\r\nstatic int __init or1k_pic_or1200_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nreturn or1k_pic_init(node, &or1k_pic_or1200);\r\n}\r\nstatic int __init or1k_pic_level_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nreturn or1k_pic_init(node, &or1k_pic_level);\r\n}\r\nstatic int __init or1k_pic_edge_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nreturn or1k_pic_init(node, &or1k_pic_edge);\r\n}

static void cvm_oct_set_hw_preamble(struct octeon_ethernet *priv, bool enable)\r\n{\r\nunion cvmx_gmxx_rxx_frm_ctl gmxx_rxx_frm_ctl;\r\nunion cvmx_ipd_sub_port_fcs ipd_sub_port_fcs;\r\nunion cvmx_gmxx_rxx_int_reg gmxx_rxx_int_reg;\r\nint interface = INTERFACE(priv->port);\r\nint index = INDEX(priv->port);\r\ngmxx_rxx_frm_ctl.u64 = cvmx_read_csr(CVMX_GMXX_RXX_FRM_CTL(index,\r\ninterface));\r\ngmxx_rxx_frm_ctl.s.pre_chk = enable;\r\ncvmx_write_csr(CVMX_GMXX_RXX_FRM_CTL(index, interface),\r\ngmxx_rxx_frm_ctl.u64);\r\nipd_sub_port_fcs.u64 = cvmx_read_csr(CVMX_IPD_SUB_PORT_FCS);\r\nif (enable)\r\nipd_sub_port_fcs.s.port_bit |= 1ull << priv->port;\r\nelse\r\nipd_sub_port_fcs.s.port_bit &=\r\n0xffffffffull ^ (1ull << priv->port);\r\ncvmx_write_csr(CVMX_IPD_SUB_PORT_FCS, ipd_sub_port_fcs.u64);\r\ngmxx_rxx_int_reg.u64 = cvmx_read_csr(CVMX_GMXX_RXX_INT_REG(index,\r\ninterface));\r\ncvmx_write_csr(CVMX_GMXX_RXX_INT_REG(index, interface),\r\ngmxx_rxx_int_reg.u64);\r\n}\r\nstatic void cvm_oct_check_preamble_errors(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\ncvmx_helper_link_info_t link_info;\r\nunsigned long flags;\r\nlink_info.u64 = priv->link_info;\r\nspin_lock_irqsave(&global_register_lock, flags);\r\nif (link_info.s.speed == 10 && priv->last_speed == 10) {\r\nint interface = INTERFACE(priv->port);\r\nint index = INDEX(priv->port);\r\nunion cvmx_gmxx_rxx_int_reg gmxx_rxx_int_reg;\r\ngmxx_rxx_int_reg.u64 = cvmx_read_csr(CVMX_GMXX_RXX_INT_REG\r\n(index, interface));\r\nif (gmxx_rxx_int_reg.s.pcterr) {\r\ncvm_oct_set_hw_preamble(priv, false);\r\nprintk_ratelimited("%s: Using 10Mbps with software preamble removal\n",\r\ndev->name);\r\n}\r\n} else {\r\nif (priv->last_speed != link_info.s.speed)\r\ncvm_oct_set_hw_preamble(priv, true);\r\npriv->last_speed = link_info.s.speed;\r\n}\r\nspin_unlock_irqrestore(&global_register_lock, flags);\r\n}\r\nstatic void cvm_oct_rgmii_poll(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\ncvmx_helper_link_info_t link_info;\r\nbool status_change;\r\nlink_info = cvmx_helper_link_autoconf(priv->port);\r\nstatus_change = priv->link_info != link_info.u64;\r\npriv->link_info = link_info.u64;\r\ncvm_oct_check_preamble_errors(dev);\r\nif (likely(!status_change))\r\nreturn;\r\nif (link_info.s.link_up) {\r\nif (!netif_carrier_ok(dev))\r\nnetif_carrier_on(dev);\r\n} else if (netif_carrier_ok(dev)) {\r\nnetif_carrier_off(dev);\r\n}\r\ncvm_oct_note_carrier(priv, link_info);\r\n}\r\nint cvm_oct_rgmii_open(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint ret;\r\nret = cvm_oct_common_open(dev, cvm_oct_rgmii_poll);\r\nif (ret)\r\nreturn ret;\r\nif (priv->phydev) {\r\nif ((priv->imode == CVMX_HELPER_INTERFACE_MODE_GMII &&\r\npriv->port == 0) ||\r\n(priv->imode == CVMX_HELPER_INTERFACE_MODE_RGMII)) {\r\npriv->poll = cvm_oct_check_preamble_errors;\r\ncvm_oct_check_preamble_errors(dev);\r\n}\r\n}\r\nreturn 0;\r\n}

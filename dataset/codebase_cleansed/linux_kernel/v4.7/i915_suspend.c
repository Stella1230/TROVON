static void i915_save_display(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nif (INTEL_INFO(dev)->gen <= 4)\r\ndev_priv->regfile.saveDSPARB = I915_READ(DSPARB);\r\nif (HAS_PCH_IBX(dev) || HAS_PCH_CPT(dev))\r\ndev_priv->regfile.saveLVDS = I915_READ(PCH_LVDS);\r\nelse if (INTEL_INFO(dev)->gen <= 4 && IS_MOBILE(dev) && !IS_I830(dev))\r\ndev_priv->regfile.saveLVDS = I915_READ(LVDS);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->regfile.savePP_CONTROL = I915_READ(PCH_PP_CONTROL);\r\ndev_priv->regfile.savePP_ON_DELAYS = I915_READ(PCH_PP_ON_DELAYS);\r\ndev_priv->regfile.savePP_OFF_DELAYS = I915_READ(PCH_PP_OFF_DELAYS);\r\ndev_priv->regfile.savePP_DIVISOR = I915_READ(PCH_PP_DIVISOR);\r\n} else if (INTEL_INFO(dev)->gen <= 4) {\r\ndev_priv->regfile.savePP_CONTROL = I915_READ(PP_CONTROL);\r\ndev_priv->regfile.savePP_ON_DELAYS = I915_READ(PP_ON_DELAYS);\r\ndev_priv->regfile.savePP_OFF_DELAYS = I915_READ(PP_OFF_DELAYS);\r\ndev_priv->regfile.savePP_DIVISOR = I915_READ(PP_DIVISOR);\r\n}\r\nif (HAS_FBC(dev) && INTEL_INFO(dev)->gen <= 4 && !IS_G4X(dev))\r\ndev_priv->regfile.saveFBC_CONTROL = I915_READ(FBC_CONTROL);\r\n}\r\nstatic void i915_restore_display(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nu32 mask = 0xffffffff;\r\nif (INTEL_INFO(dev)->gen <= 4)\r\nI915_WRITE(DSPARB, dev_priv->regfile.saveDSPARB);\r\nmask = ~LVDS_PORT_EN;\r\nif (HAS_PCH_IBX(dev) || HAS_PCH_CPT(dev))\r\nI915_WRITE(PCH_LVDS, dev_priv->regfile.saveLVDS & mask);\r\nelse if (INTEL_INFO(dev)->gen <= 4 && IS_MOBILE(dev) && !IS_I830(dev))\r\nI915_WRITE(LVDS, dev_priv->regfile.saveLVDS & mask);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(PCH_PP_ON_DELAYS, dev_priv->regfile.savePP_ON_DELAYS);\r\nI915_WRITE(PCH_PP_OFF_DELAYS, dev_priv->regfile.savePP_OFF_DELAYS);\r\nI915_WRITE(PCH_PP_DIVISOR, dev_priv->regfile.savePP_DIVISOR);\r\nI915_WRITE(PCH_PP_CONTROL, dev_priv->regfile.savePP_CONTROL);\r\n} else if (INTEL_INFO(dev)->gen <= 4) {\r\nI915_WRITE(PP_ON_DELAYS, dev_priv->regfile.savePP_ON_DELAYS);\r\nI915_WRITE(PP_OFF_DELAYS, dev_priv->regfile.savePP_OFF_DELAYS);\r\nI915_WRITE(PP_DIVISOR, dev_priv->regfile.savePP_DIVISOR);\r\nI915_WRITE(PP_CONTROL, dev_priv->regfile.savePP_CONTROL);\r\n}\r\nintel_fbc_global_disable(dev_priv);\r\nif (HAS_FBC(dev) && INTEL_INFO(dev)->gen <= 4 && !IS_G4X(dev))\r\nI915_WRITE(FBC_CONTROL, dev_priv->regfile.saveFBC_CONTROL);\r\ni915_redisable_vga(dev);\r\n}\r\nint i915_save_state(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\nmutex_lock(&dev->struct_mutex);\r\ni915_save_display(dev);\r\nif (IS_GEN4(dev))\r\npci_read_config_word(dev->pdev, GCDGMBUS,\r\n&dev_priv->regfile.saveGCDGMBUS);\r\nif (INTEL_INFO(dev)->gen < 7)\r\ndev_priv->regfile.saveCACHE_MODE_0 = I915_READ(CACHE_MODE_0);\r\ndev_priv->regfile.saveMI_ARB_STATE = I915_READ(MI_ARB_STATE);\r\nif (IS_GEN2(dev_priv) && IS_MOBILE(dev_priv)) {\r\nfor (i = 0; i < 7; i++) {\r\ndev_priv->regfile.saveSWF0[i] = I915_READ(SWF0(i));\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n}\r\nfor (i = 0; i < 3; i++)\r\ndev_priv->regfile.saveSWF3[i] = I915_READ(SWF3(i));\r\n} else if (IS_GEN2(dev_priv)) {\r\nfor (i = 0; i < 7; i++)\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n} else if (HAS_GMCH_DISPLAY(dev_priv)) {\r\nfor (i = 0; i < 16; i++) {\r\ndev_priv->regfile.saveSWF0[i] = I915_READ(SWF0(i));\r\ndev_priv->regfile.saveSWF1[i] = I915_READ(SWF1(i));\r\n}\r\nfor (i = 0; i < 3; i++)\r\ndev_priv->regfile.saveSWF3[i] = I915_READ(SWF3(i));\r\n}\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn 0;\r\n}\r\nint i915_restore_state(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\nmutex_lock(&dev->struct_mutex);\r\ni915_gem_restore_fences(dev);\r\nif (IS_GEN4(dev))\r\npci_write_config_word(dev->pdev, GCDGMBUS,\r\ndev_priv->regfile.saveGCDGMBUS);\r\ni915_restore_display(dev);\r\nif (INTEL_INFO(dev)->gen < 7)\r\nI915_WRITE(CACHE_MODE_0, dev_priv->regfile.saveCACHE_MODE_0 |\r\n0xffff0000);\r\nI915_WRITE(MI_ARB_STATE, dev_priv->regfile.saveMI_ARB_STATE | 0xffff0000);\r\nif (IS_GEN2(dev_priv) && IS_MOBILE(dev_priv)) {\r\nfor (i = 0; i < 7; i++) {\r\nI915_WRITE(SWF0(i), dev_priv->regfile.saveSWF0[i]);\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n}\r\nfor (i = 0; i < 3; i++)\r\nI915_WRITE(SWF3(i), dev_priv->regfile.saveSWF3[i]);\r\n} else if (IS_GEN2(dev_priv)) {\r\nfor (i = 0; i < 7; i++)\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n} else if (HAS_GMCH_DISPLAY(dev_priv)) {\r\nfor (i = 0; i < 16; i++) {\r\nI915_WRITE(SWF0(i), dev_priv->regfile.saveSWF0[i]);\r\nI915_WRITE(SWF1(i), dev_priv->regfile.saveSWF1[i]);\r\n}\r\nfor (i = 0; i < 3; i++)\r\nI915_WRITE(SWF3(i), dev_priv->regfile.saveSWF3[i]);\r\n}\r\nmutex_unlock(&dev->struct_mutex);\r\nintel_i2c_reset(dev);\r\nreturn 0;\r\n}

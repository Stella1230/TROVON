static struct ics932s401_data *ics932s401_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ics932s401_data *data = i2c_get_clientdata(client);\r\nunsigned long local_jiffies = jiffies;\r\nint i, temp;\r\nmutex_lock(&data->lock);\r\nif (time_before(local_jiffies, data->sensors_last_updated +\r\nSENSOR_REFRESH_INTERVAL)\r\n&& data->sensors_valid)\r\ngoto out;\r\nfor (i = 0; i < NUM_MIRRORED_REGS; i++) {\r\ntemp = i2c_smbus_read_word_data(client, regs_to_copy[i]);\r\ndata->regs[regs_to_copy[i]] = temp >> 8;\r\n}\r\ndata->sensors_last_updated = local_jiffies;\r\ndata->sensors_valid = 1;\r\nout:\r\nmutex_unlock(&data->lock);\r\nreturn data;\r\n}\r\nstatic ssize_t show_spread_enabled(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nif (data->regs[ICS932S401_REG_CFG2] & ICS932S401_CFG1_SPREAD)\r\nreturn sprintf(buf, "1\n");\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic int calculate_cpu_freq(struct ics932s401_data *data)\r\n{\r\nint m, n, freq;\r\nm = data->regs[ICS932S401_REG_CPU_M_CTRL] & ICS932S401_M_MASK;\r\nn = data->regs[ICS932S401_REG_CPU_N_CTRL];\r\nn |= ((int)data->regs[ICS932S401_REG_CPU_M_CTRL] & 0x80) << 1;\r\nn |= ((int)data->regs[ICS932S401_REG_CPU_M_CTRL] & 0x40) << 3;\r\nfreq = BASE_CLOCK * (n + 8) / (m + 2);\r\nfreq /= divisors[data->regs[ICS932S401_REG_CPU_DIVISOR] >>\r\nICS932S401_CPU_DIVISOR_SHIFT];\r\nreturn freq;\r\n}\r\nstatic ssize_t show_cpu_clock(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nreturn sprintf(buf, "%d\n", calculate_cpu_freq(data));\r\n}\r\nstatic ssize_t show_cpu_clock_sel(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nint freq;\r\nif (data->regs[ICS932S401_REG_CTRL] & ICS932S401_MN_ENABLED)\r\nfreq = calculate_cpu_freq(data);\r\nelse {\r\nint fid = data->regs[ICS932S401_REG_CFG7] & ICS932S401_FS_MASK;\r\nfreq = fs_speeds[fid];\r\nif (data->regs[ICS932S401_REG_CTRL] & ICS932S401_CPU_ALT) {\r\nswitch (freq) {\r\ncase 166666:\r\nfreq = 160000;\r\nbreak;\r\ncase 333333:\r\nfreq = 320000;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn sprintf(buf, "%d\n", freq);\r\n}\r\nstatic int calculate_src_freq(struct ics932s401_data *data)\r\n{\r\nint m, n, freq;\r\nm = data->regs[ICS932S401_REG_SRC_M_CTRL] & ICS932S401_M_MASK;\r\nn = data->regs[ICS932S401_REG_SRC_N_CTRL];\r\nn |= ((int)data->regs[ICS932S401_REG_SRC_M_CTRL] & 0x80) << 1;\r\nn |= ((int)data->regs[ICS932S401_REG_SRC_M_CTRL] & 0x40) << 3;\r\nfreq = BASE_CLOCK * (n + 8) / (m + 2);\r\nfreq /= divisors[data->regs[ICS932S401_REG_PCISRC_DIVISOR] &\r\nICS932S401_SRC_DIVISOR_MASK];\r\nreturn freq;\r\n}\r\nstatic ssize_t show_src_clock(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nreturn sprintf(buf, "%d\n", calculate_src_freq(data));\r\n}\r\nstatic ssize_t show_src_clock_sel(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nint freq;\r\nif (data->regs[ICS932S401_REG_CTRL] & ICS932S401_MN_ENABLED)\r\nfreq = calculate_src_freq(data);\r\nelse\r\nif (data->regs[ICS932S401_REG_CTRL] & ICS932S401_CPU_ALT &&\r\ndata->regs[ICS932S401_REG_CTRL] & ICS932S401_SRC_ALT)\r\nfreq = 96000;\r\nelse\r\nfreq = 100000;\r\nreturn sprintf(buf, "%d\n", freq);\r\n}\r\nstatic int calculate_pci_freq(struct ics932s401_data *data)\r\n{\r\nint m, n, freq;\r\nm = data->regs[ICS932S401_REG_SRC_M_CTRL] & ICS932S401_M_MASK;\r\nn = data->regs[ICS932S401_REG_SRC_N_CTRL];\r\nn |= ((int)data->regs[ICS932S401_REG_SRC_M_CTRL] & 0x80) << 1;\r\nn |= ((int)data->regs[ICS932S401_REG_SRC_M_CTRL] & 0x40) << 3;\r\nfreq = BASE_CLOCK * (n + 8) / (m + 2);\r\nfreq /= divisors[data->regs[ICS932S401_REG_PCISRC_DIVISOR] >>\r\nICS932S401_PCI_DIVISOR_SHIFT];\r\nreturn freq;\r\n}\r\nstatic ssize_t show_pci_clock(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nreturn sprintf(buf, "%d\n", calculate_pci_freq(data));\r\n}\r\nstatic ssize_t show_pci_clock_sel(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nint freq;\r\nif (data->regs[ICS932S401_REG_CTRL] & ICS932S401_MN_ENABLED)\r\nfreq = calculate_pci_freq(data);\r\nelse\r\nfreq = 33333;\r\nreturn sprintf(buf, "%d\n", freq);\r\n}\r\nstatic ssize_t show_value(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint x;\r\nif (devattr == &dev_attr_usb_clock)\r\nx = 48000;\r\nelse if (devattr == &dev_attr_ref_clock)\r\nx = BASE_CLOCK;\r\nelse\r\nBUG();\r\nreturn sprintf(buf, "%d\n", x);\r\n}\r\nstatic ssize_t show_spread(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct ics932s401_data *data = ics932s401_update_device(dev);\r\nint reg;\r\nunsigned long val;\r\nif (!(data->regs[ICS932S401_REG_CFG2] & ICS932S401_CFG1_SPREAD))\r\nreturn sprintf(buf, "0%%\n");\r\nif (devattr == &dev_attr_src_spread)\r\nreg = ICS932S401_REG_SRC_SPREAD1;\r\nelse if (devattr == &dev_attr_cpu_spread)\r\nreg = ICS932S401_REG_CPU_SPREAD1;\r\nelse\r\nBUG();\r\nval = data->regs[reg] | (data->regs[reg + 1] << 8);\r\nval &= ICS932S401_SPREAD_MASK;\r\nval = 500000 * val / 16384;\r\nreturn sprintf(buf, "-0.%lu%%\n", val);\r\n}\r\nstatic int ics932s401_detect(struct i2c_client *client,\r\nstruct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nint vendor, device, revision;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nvendor = i2c_smbus_read_word_data(client, ICS932S401_REG_VENDOR_REV);\r\nvendor >>= 8;\r\nrevision = vendor >> ICS932S401_REV_SHIFT;\r\nvendor &= ICS932S401_VENDOR_MASK;\r\nif (vendor != ICS932S401_VENDOR)\r\nreturn -ENODEV;\r\ndevice = i2c_smbus_read_word_data(client, ICS932S401_REG_DEVICE);\r\ndevice >>= 8;\r\nif (device != ICS932S401_DEVICE)\r\nreturn -ENODEV;\r\nif (revision != ICS932S401_REV)\r\ndev_info(&adapter->dev, "Unknown revision %d\n", revision);\r\nstrlcpy(info->type, "ics932s401", I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic int ics932s401_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ics932s401_data *data;\r\nint err;\r\ndata = kzalloc(sizeof(struct ics932s401_data), GFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->lock);\r\ndev_info(&client->dev, "%s chip found\n", client->name);\r\ndata->attrs.attrs = ics932s401_attr;\r\nerr = sysfs_create_group(&client->dev.kobj, &data->attrs);\r\nif (err)\r\ngoto exit_free;\r\nreturn 0;\r\nexit_free:\r\nkfree(data);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int ics932s401_remove(struct i2c_client *client)\r\n{\r\nstruct ics932s401_data *data = i2c_get_clientdata(client);\r\nsysfs_remove_group(&client->dev.kobj, &data->attrs);\r\nkfree(data);\r\nreturn 0;\r\n}

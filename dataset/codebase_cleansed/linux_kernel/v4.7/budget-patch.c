static void gpio_Set22K (struct budget *budget, int state)\r\n{\r\nstruct saa7146_dev *dev=budget->dev;\r\ndprintk(2, "budget: %p\n", budget);\r\nsaa7146_setgpio(dev, 3, (state ? SAA7146_GPIO_OUTHI : SAA7146_GPIO_OUTLO));\r\n}\r\nstatic void DiseqcSendBit (struct budget *budget, int data)\r\n{\r\nstruct saa7146_dev *dev=budget->dev;\r\ndprintk(2, "budget: %p\n", budget);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\r\nudelay(data ? 500 : 1000);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\r\nudelay(data ? 1000 : 500);\r\n}\r\nstatic void DiseqcSendByte (struct budget *budget, int data)\r\n{\r\nint i, par=1, d;\r\ndprintk(2, "budget: %p\n", budget);\r\nfor (i=7; i>=0; i--) {\r\nd = (data>>i)&1;\r\npar ^= d;\r\nDiseqcSendBit(budget, d);\r\n}\r\nDiseqcSendBit(budget, par);\r\n}\r\nstatic int SendDiSEqCMsg (struct budget *budget, int len, u8 *msg, unsigned long burst)\r\n{\r\nstruct saa7146_dev *dev=budget->dev;\r\nint i;\r\ndprintk(2, "budget: %p\n", budget);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\r\nmdelay(16);\r\nfor (i=0; i<len; i++)\r\nDiseqcSendByte(budget, msg[i]);\r\nmdelay(16);\r\nif (burst!=-1) {\r\nif (burst)\r\nDiseqcSendByte(budget, 0xff);\r\nelse {\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\r\nmdelay(12);\r\nudelay(500);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\r\n}\r\nmsleep(20);\r\n}\r\nreturn 0;\r\n}\r\nstatic int budget_set_tone(struct dvb_frontend *fe,\r\nenum fe_sec_tone_mode tone)\r\n{\r\nstruct budget* budget = (struct budget*) fe->dvb->priv;\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\ngpio_Set22K (budget, 1);\r\nbreak;\r\ncase SEC_TONE_OFF:\r\ngpio_Set22K (budget, 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int budget_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd* cmd)\r\n{\r\nstruct budget* budget = (struct budget*) fe->dvb->priv;\r\nSendDiSEqCMsg (budget, cmd->msg_len, cmd->msg, 0);\r\nreturn 0;\r\n}\r\nstatic int budget_diseqc_send_burst(struct dvb_frontend *fe,\r\nenum fe_sec_mini_cmd minicmd)\r\n{\r\nstruct budget* budget = (struct budget*) fe->dvb->priv;\r\nSendDiSEqCMsg (budget, 0, NULL, minicmd);\r\nreturn 0;\r\n}\r\nstatic int budget_av7110_send_fw_cmd(struct budget_patch *budget, u16* buf, int length)\r\n{\r\nint i;\r\ndprintk(2, "budget: %p\n", budget);\r\nfor (i = 2; i < length; i++)\r\n{\r\nttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2*i, 2, (u32) buf[i], 0,0);\r\nmsleep(5);\r\n}\r\nif (length)\r\nttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2, 2, (u32) buf[1], 0,0);\r\nelse\r\nttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2, 2, 0, 0,0);\r\nmsleep(5);\r\nttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND, 2, (u32) buf[0], 0,0);\r\nmsleep(5);\r\nreturn 0;\r\n}\r\nstatic void av7110_set22k(struct budget_patch *budget, int state)\r\n{\r\nu16 buf[2] = {( COMTYPE_AUDIODAC << 8) | (state ? ON22K : OFF22K), 0};\r\ndprintk(2, "budget: %p\n", budget);\r\nbudget_av7110_send_fw_cmd(budget, buf, 2);\r\n}\r\nstatic int av7110_send_diseqc_msg(struct budget_patch *budget, int len, u8 *msg, int burst)\r\n{\r\nint i;\r\nu16 buf[18] = { ((COMTYPE_AUDIODAC << 8) | SendDiSEqC),\r\n16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };\r\ndprintk(2, "budget: %p\n", budget);\r\nif (len>10)\r\nlen=10;\r\nbuf[1] = len+2;\r\nbuf[2] = len;\r\nif (burst != -1)\r\nbuf[3]=burst ? 0x01 : 0x00;\r\nelse\r\nbuf[3]=0xffff;\r\nfor (i=0; i<len; i++)\r\nbuf[i+4]=msg[i];\r\nbudget_av7110_send_fw_cmd(budget, buf, 18);\r\nreturn 0;\r\n}\r\nstatic int budget_patch_set_tone(struct dvb_frontend *fe,\r\nenum fe_sec_tone_mode tone)\r\n{\r\nstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\nav7110_set22k (budget, 1);\r\nbreak;\r\ncase SEC_TONE_OFF:\r\nav7110_set22k (budget, 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int budget_patch_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd* cmd)\r\n{\r\nstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\r\nav7110_send_diseqc_msg (budget, cmd->msg_len, cmd->msg, 0);\r\nreturn 0;\r\n}\r\nstatic int budget_patch_diseqc_send_burst(struct dvb_frontend *fe,\r\nenum fe_sec_mini_cmd minicmd)\r\n{\r\nstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\r\nav7110_send_diseqc_msg (budget, 0, NULL, minicmd);\r\nreturn 0;\r\n}\r\nstatic int alps_bsrv2_tuner_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\r\nu8 pwr = 0;\r\nu8 buf[4];\r\nstruct i2c_msg msg = { .addr = 0x61, .flags = 0, .buf = buf, .len = sizeof(buf) };\r\nu32 div = (p->frequency + 479500) / 125;\r\nif (p->frequency > 2000000)\r\npwr = 3;\r\nelse if (p->frequency > 1800000)\r\npwr = 2;\r\nelse if (p->frequency > 1600000)\r\npwr = 1;\r\nelse if (p->frequency > 1200000)\r\npwr = 0;\r\nelse if (p->frequency >= 1100000)\r\npwr = 1;\r\nelse pwr = 2;\r\nbuf[0] = (div >> 8) & 0x7f;\r\nbuf[1] = div & 0xff;\r\nbuf[2] = ((div & 0x18000) >> 10) | 0x95;\r\nbuf[3] = (pwr << 6) | 0x30;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int grundig_29504_451_tuner_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\r\nu32 div;\r\nu8 data[4];\r\nstruct i2c_msg msg = { .addr = 0x61, .flags = 0, .buf = data, .len = sizeof(data) };\r\ndiv = p->frequency / 125;\r\ndata[0] = (div >> 8) & 0x7f;\r\ndata[1] = div & 0xff;\r\ndata[2] = 0x8e;\r\ndata[3] = 0x00;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void frontend_init(struct budget_patch* budget)\r\n{\r\nswitch(budget->dev->pci->subsystem_device) {\r\ncase 0x0000:\r\ncase 0x1013:\r\nbudget->dvb_frontend = dvb_attach(ves1x93_attach, &alps_bsrv2_config, &budget->i2c_adap);\r\nif (budget->dvb_frontend) {\r\nbudget->dvb_frontend->ops.tuner_ops.set_params = alps_bsrv2_tuner_set_params;\r\nbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_patch_diseqc_send_master_cmd;\r\nbudget->dvb_frontend->ops.diseqc_send_burst = budget_patch_diseqc_send_burst;\r\nbudget->dvb_frontend->ops.set_tone = budget_patch_set_tone;\r\nbreak;\r\n}\r\nbudget->dvb_frontend = dvb_attach(stv0299_attach, &alps_bsru6_config, &budget->i2c_adap);\r\nif (budget->dvb_frontend) {\r\nbudget->dvb_frontend->ops.tuner_ops.set_params = alps_bsru6_tuner_set_params;\r\nbudget->dvb_frontend->tuner_priv = &budget->i2c_adap;\r\nbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;\r\nbudget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;\r\nbudget->dvb_frontend->ops.set_tone = budget_set_tone;\r\nbreak;\r\n}\r\nbudget->dvb_frontend = dvb_attach(tda8083_attach, &grundig_29504_451_config, &budget->i2c_adap);\r\nif (budget->dvb_frontend) {\r\nbudget->dvb_frontend->ops.tuner_ops.set_params = grundig_29504_451_tuner_set_params;\r\nbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;\r\nbudget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;\r\nbudget->dvb_frontend->ops.set_tone = budget_set_tone;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nif (budget->dvb_frontend == NULL) {\r\nprintk("dvb-ttpci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]\n",\r\nbudget->dev->pci->vendor,\r\nbudget->dev->pci->device,\r\nbudget->dev->pci->subsystem_vendor,\r\nbudget->dev->pci->subsystem_device);\r\n} else {\r\nif (dvb_register_frontend(&budget->dvb_adapter, budget->dvb_frontend)) {\r\nprintk("budget-av: Frontend registration failed!\n");\r\ndvb_frontend_detach(budget->dvb_frontend);\r\nbudget->dvb_frontend = NULL;\r\n}\r\n}\r\n}\r\nstatic int budget_patch_attach (struct saa7146_dev* dev, struct saa7146_pci_extension_data *info)\r\n{\r\nstruct budget_patch *budget;\r\nint err;\r\nint count = 0;\r\nint detected = 0;\r\n#define PATCH_RESET 0\r\n#define RPS_IRQ 0\r\n#define HPS_SETUP 0\r\n#if PATCH_RESET\r\nsaa7146_write(dev, MC1, MASK_31);\r\nmsleep(40);\r\n#endif\r\n#if HPS_SETUP\r\nsaa7146_write(dev, DD1_STREAM_B, 0);\r\nsaa7146_write(dev, DD1_INIT, 0x00000200);\r\nsaa7146_write(dev, BRS_CTRL, 0x00000000);\r\nsaa7146_write(dev, HPS_H_PRESCALE, 0);\r\nsaa7146_write(dev, HPS_H_SCALE, 0);\r\nsaa7146_write(dev, BCS_CTRL, 0);\r\nsaa7146_write(dev, HPS_V_SCALE, 0);\r\nsaa7146_write(dev, HPS_V_GAIN, 0);\r\nsaa7146_write(dev, CHROMA_KEY_RANGE, 0);\r\nsaa7146_write(dev, CLIP_FORMAT_CTRL, 0);\r\nsaa7146_write(dev, HPS_CTRL, (1<<30) | (0<<29) | (1<<28) | (0<<12) );\r\nsaa7146_write(dev, MC2,\r\n0 * (MASK_08 | MASK_24) |\r\n0 * (MASK_09 | MASK_25) |\r\n0 * (MASK_10 | MASK_26) |\r\n1 * (MASK_06 | MASK_22) |\r\n1 * (MASK_05 | MASK_21) |\r\n0 * (MASK_01 | MASK_15)\r\n);\r\n#endif\r\nsaa7146_write(dev, MC1, ( MASK_29 | MASK_28));\r\nsaa7146_write(dev, RPS_TOV1, 0);\r\ncount = 0;\r\n#if 0\r\nWRITE_RPS1(CMD_UPLOAD |\r\nMASK_10 | MASK_09 | MASK_08 | MASK_06 | MASK_05 | MASK_04 | MASK_03 | MASK_02 );\r\n#endif\r\nWRITE_RPS1(CMD_PAUSE | EVT_VBI_B);\r\nWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\r\nWRITE_RPS1(GPIO3_MSK);\r\nWRITE_RPS1(SAA7146_GPIO_OUTLO<<24);\r\n#if RPS_IRQ\r\nWRITE_RPS1(CMD_INTERRUPT);\r\nWRITE_RPS1(CMD_NOP);\r\nWRITE_RPS1(CMD_INTERRUPT);\r\n#endif\r\nWRITE_RPS1(CMD_STOP);\r\n#if RPS_IRQ\r\nsaa7146_write(dev, EC1SSR, (0x03<<2) | 3 );\r\nsaa7146_write(dev, ECT1R, 0x3fff );\r\n#endif\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\r\nsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\r\nsaa7146_write(dev, MC1, (MASK_13 | MASK_29 ));\r\nmdelay(50);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\r\nmdelay(150);\r\nif( (saa7146_read(dev, GPIO_CTRL) & 0x10000000) == 0)\r\ndetected = 1;\r\n#if RPS_IRQ\r\nprintk("Event Counter 1 0x%04x\n", saa7146_read(dev, EC1R) & 0x3fff );\r\n#endif\r\nsaa7146_write(dev, MC1, ( MASK_29 ));\r\nif(detected == 0)\r\nprintk("budget-patch not detected or saa7146 in non-default state.\n"\r\n"try enabling resetting of 7146 with MASK_31 in MC1 register\n");\r\nelse\r\nprintk("BUDGET-PATCH DETECTED.\n");\r\ncount = 0;\r\nWRITE_RPS1(CMD_PAUSE | EVT_HS);\r\nWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\r\nWRITE_RPS1(GPIO3_MSK);\r\nWRITE_RPS1(SAA7146_GPIO_OUTHI<<24);\r\n#if RPS_IRQ\r\nWRITE_RPS1(CMD_INTERRUPT);\r\n#endif\r\nWRITE_RPS1(CMD_PAUSE | RPS_INV | EVT_HS);\r\nWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\r\nWRITE_RPS1(GPIO3_MSK);\r\nWRITE_RPS1(SAA7146_GPIO_OUTLO<<24);\r\n#if RPS_IRQ\r\nWRITE_RPS1(CMD_INTERRUPT);\r\n#endif\r\nWRITE_RPS1(CMD_JUMP);\r\nWRITE_RPS1(dev->d_rps1.dma_handle);\r\nsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\r\nsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\r\nif (!(budget = kmalloc (sizeof(struct budget_patch), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\ndprintk(2, "budget: %p\n", budget);\r\nerr = ttpci_budget_init(budget, dev, info, THIS_MODULE, adapter_nr);\r\nif (err) {\r\nkfree(budget);\r\nreturn err;\r\n}\r\nsaa7146_write(dev, RPS_THRESH1, budget->buffer_height | MASK_12 );\r\nsaa7146_write(dev, MC1, (MASK_13 | MASK_29));\r\ndev->ext_priv = budget;\r\nbudget->dvb_adapter.priv = budget;\r\nfrontend_init(budget);\r\nttpci_budget_init_hooks(budget);\r\nreturn 0;\r\n}\r\nstatic int budget_patch_detach (struct saa7146_dev* dev)\r\n{\r\nstruct budget_patch *budget = (struct budget_patch*) dev->ext_priv;\r\nint err;\r\nif (budget->dvb_frontend) {\r\ndvb_unregister_frontend(budget->dvb_frontend);\r\ndvb_frontend_detach(budget->dvb_frontend);\r\n}\r\nerr = ttpci_budget_deinit (budget);\r\nkfree (budget);\r\nreturn err;\r\n}\r\nstatic int __init budget_patch_init(void)\r\n{\r\nreturn saa7146_register_extension(&budget_extension);\r\n}\r\nstatic void __exit budget_patch_exit(void)\r\n{\r\nsaa7146_unregister_extension(&budget_extension);\r\n}

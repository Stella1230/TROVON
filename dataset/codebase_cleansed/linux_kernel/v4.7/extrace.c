static u8 acpi_ex_interpreter_trace_enabled(char *name)\r\n{\r\nif (!(acpi_gbl_trace_flags & ACPI_TRACE_ENABLED)) {\r\nreturn (FALSE);\r\n}\r\nif (acpi_gbl_trace_method_object) {\r\nreturn (TRUE);\r\n}\r\nif (name &&\r\n(acpi_gbl_trace_method_name &&\r\nstrcmp(acpi_gbl_trace_method_name, name))) {\r\nreturn (FALSE);\r\n}\r\nif ((acpi_gbl_trace_flags & ACPI_TRACE_ONESHOT) &&\r\n!acpi_gbl_trace_method_name) {\r\nreturn (FALSE);\r\n}\r\nreturn (TRUE);\r\n}\r\nstatic const char *acpi_ex_get_trace_event_name(acpi_trace_event_type type)\r\n{\r\nswitch (type) {\r\ncase ACPI_TRACE_AML_METHOD:\r\nreturn "Method";\r\ncase ACPI_TRACE_AML_OPCODE:\r\nreturn "Opcode";\r\ncase ACPI_TRACE_AML_REGION:\r\nreturn "Region";\r\ndefault:\r\nreturn "";\r\n}\r\n}\r\nvoid\r\nacpi_ex_trace_point(acpi_trace_event_type type,\r\nu8 begin, u8 *aml, char *pathname)\r\n{\r\nACPI_FUNCTION_NAME(ex_trace_point);\r\nif (pathname) {\r\nACPI_DEBUG_PRINT((ACPI_DB_TRACE_POINT,\r\n"%s %s [0x%p:%s] execution.\n",\r\nacpi_ex_get_trace_event_name(type),\r\nbegin ? "Begin" : "End", aml, pathname));\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_TRACE_POINT,\r\n"%s %s [0x%p] execution.\n",\r\nacpi_ex_get_trace_event_name(type),\r\nbegin ? "Begin" : "End", aml));\r\n}\r\n}\r\nvoid\r\nacpi_ex_start_trace_method(struct acpi_namespace_node *method_node,\r\nunion acpi_operand_object *obj_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nchar *pathname = NULL;\r\nu8 enabled = FALSE;\r\nACPI_FUNCTION_NAME(ex_start_trace_method);\r\nif (method_node) {\r\npathname = acpi_ns_get_normalized_pathname(method_node, TRUE);\r\n}\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nenabled = acpi_ex_interpreter_trace_enabled(pathname);\r\nif (enabled && !acpi_gbl_trace_method_object) {\r\nacpi_gbl_trace_method_object = obj_desc;\r\nacpi_gbl_original_dbg_level = acpi_dbg_level;\r\nacpi_gbl_original_dbg_layer = acpi_dbg_layer;\r\nacpi_dbg_level = ACPI_TRACE_LEVEL_ALL;\r\nacpi_dbg_layer = ACPI_TRACE_LAYER_ALL;\r\nif (acpi_gbl_trace_dbg_level) {\r\nacpi_dbg_level = acpi_gbl_trace_dbg_level;\r\n}\r\nif (acpi_gbl_trace_dbg_layer) {\r\nacpi_dbg_layer = acpi_gbl_trace_dbg_layer;\r\n}\r\n}\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\nexit:\r\nif (enabled) {\r\nACPI_TRACE_POINT(ACPI_TRACE_AML_METHOD, TRUE,\r\nobj_desc ? obj_desc->method.aml_start : NULL,\r\npathname);\r\n}\r\nif (pathname) {\r\nACPI_FREE(pathname);\r\n}\r\n}\r\nvoid\r\nacpi_ex_stop_trace_method(struct acpi_namespace_node *method_node,\r\nunion acpi_operand_object *obj_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nchar *pathname = NULL;\r\nu8 enabled;\r\nACPI_FUNCTION_NAME(ex_stop_trace_method);\r\nif (method_node) {\r\npathname = acpi_ns_get_normalized_pathname(method_node, TRUE);\r\n}\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit_path;\r\n}\r\nenabled = acpi_ex_interpreter_trace_enabled(NULL);\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\nif (enabled) {\r\nACPI_TRACE_POINT(ACPI_TRACE_AML_METHOD, FALSE,\r\nobj_desc ? obj_desc->method.aml_start : NULL,\r\npathname);\r\n}\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit_path;\r\n}\r\nif (acpi_gbl_trace_method_object == obj_desc) {\r\nif (acpi_gbl_trace_flags & ACPI_TRACE_ONESHOT) {\r\nacpi_gbl_trace_method_name = NULL;\r\n}\r\nacpi_dbg_level = acpi_gbl_original_dbg_level;\r\nacpi_dbg_layer = acpi_gbl_original_dbg_layer;\r\nacpi_gbl_trace_method_object = NULL;\r\n}\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\nexit_path:\r\nif (pathname) {\r\nACPI_FREE(pathname);\r\n}\r\n}\r\nvoid\r\nacpi_ex_start_trace_opcode(union acpi_parse_object *op,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nACPI_FUNCTION_NAME(ex_start_trace_opcode);\r\nif (acpi_ex_interpreter_trace_enabled(NULL) &&\r\n(acpi_gbl_trace_flags & ACPI_TRACE_OPCODE)) {\r\nACPI_TRACE_POINT(ACPI_TRACE_AML_OPCODE, TRUE,\r\nop->common.aml, op->common.aml_op_name);\r\n}\r\n}\r\nvoid\r\nacpi_ex_stop_trace_opcode(union acpi_parse_object *op,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nACPI_FUNCTION_NAME(ex_stop_trace_opcode);\r\nif (acpi_ex_interpreter_trace_enabled(NULL) &&\r\n(acpi_gbl_trace_flags & ACPI_TRACE_OPCODE)) {\r\nACPI_TRACE_POINT(ACPI_TRACE_AML_OPCODE, FALSE,\r\nop->common.aml, op->common.aml_op_name);\r\n}\r\n}

static ssize_t bootinfo_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nreturn simple_read_from_buffer(buf, count, ppos, bootinfo_copy,\r\nbootinfo_size);\r\n}\r\nvoid __init save_bootinfo(const struct bi_record *bi)\r\n{\r\nconst void *start = bi;\r\nsize_t size = sizeof(bi->tag);\r\nwhile (be16_to_cpu(bi->tag) != BI_LAST) {\r\nuint16_t n = be16_to_cpu(bi->size);\r\nsize += n;\r\nbi = (struct bi_record *)((unsigned long)bi + n);\r\n}\r\nif (size > sizeof(bootinfo_tmp)) {\r\npr_err("Cannot save %zu bytes of bootinfo\n", size);\r\nreturn;\r\n}\r\npr_info("Saving %zu bytes of bootinfo\n", size);\r\nmemcpy(bootinfo_tmp, start, size);\r\nbootinfo_size = size;\r\n}\r\nstatic int __init init_bootinfo_procfs(void)\r\n{\r\nstruct proc_dir_entry *pde;\r\nif (!bootinfo_size)\r\nreturn -EINVAL;\r\nbootinfo_copy = kmemdup(bootinfo_tmp, bootinfo_size, GFP_KERNEL);\r\nif (!bootinfo_copy)\r\nreturn -ENOMEM;\r\npde = proc_create_data("bootinfo", 0400, NULL, &bootinfo_fops, NULL);\r\nif (!pde) {\r\nkfree(bootinfo_copy);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

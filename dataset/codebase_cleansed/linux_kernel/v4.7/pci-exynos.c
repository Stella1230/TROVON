static inline void exynos_elb_writel(struct exynos_pcie *pcie, u32 val, u32 reg)\r\n{\r\nwritel(val, pcie->elbi_base + reg);\r\n}\r\nstatic inline u32 exynos_elb_readl(struct exynos_pcie *pcie, u32 reg)\r\n{\r\nreturn readl(pcie->elbi_base + reg);\r\n}\r\nstatic inline void exynos_phy_writel(struct exynos_pcie *pcie, u32 val, u32 reg)\r\n{\r\nwritel(val, pcie->phy_base + reg);\r\n}\r\nstatic inline u32 exynos_phy_readl(struct exynos_pcie *pcie, u32 reg)\r\n{\r\nreturn readl(pcie->phy_base + reg);\r\n}\r\nstatic inline void exynos_blk_writel(struct exynos_pcie *pcie, u32 val, u32 reg)\r\n{\r\nwritel(val, pcie->block_base + reg);\r\n}\r\nstatic inline u32 exynos_blk_readl(struct exynos_pcie *pcie, u32 reg)\r\n{\r\nreturn readl(pcie->block_base + reg);\r\n}\r\nstatic void exynos_pcie_sideband_dbi_w_mode(struct pcie_port *pp, bool on)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nif (on) {\r\nval = exynos_elb_readl(exynos_pcie, PCIE_ELBI_SLV_AWMISC);\r\nval |= PCIE_ELBI_SLV_DBI_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_ELBI_SLV_AWMISC);\r\n} else {\r\nval = exynos_elb_readl(exynos_pcie, PCIE_ELBI_SLV_AWMISC);\r\nval &= ~PCIE_ELBI_SLV_DBI_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_ELBI_SLV_AWMISC);\r\n}\r\n}\r\nstatic void exynos_pcie_sideband_dbi_r_mode(struct pcie_port *pp, bool on)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nif (on) {\r\nval = exynos_elb_readl(exynos_pcie, PCIE_ELBI_SLV_ARMISC);\r\nval |= PCIE_ELBI_SLV_DBI_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_ELBI_SLV_ARMISC);\r\n} else {\r\nval = exynos_elb_readl(exynos_pcie, PCIE_ELBI_SLV_ARMISC);\r\nval &= ~PCIE_ELBI_SLV_DBI_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_ELBI_SLV_ARMISC);\r\n}\r\n}\r\nstatic void exynos_pcie_assert_core_reset(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = exynos_elb_readl(exynos_pcie, PCIE_CORE_RESET);\r\nval &= ~PCIE_CORE_RESET_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_CORE_RESET);\r\nexynos_elb_writel(exynos_pcie, 0, PCIE_PWR_RESET);\r\nexynos_elb_writel(exynos_pcie, 0, PCIE_STICKY_RESET);\r\nexynos_elb_writel(exynos_pcie, 0, PCIE_NONSTICKY_RESET);\r\n}\r\nstatic void exynos_pcie_deassert_core_reset(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = exynos_elb_readl(exynos_pcie, PCIE_CORE_RESET);\r\nval |= PCIE_CORE_RESET_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_CORE_RESET);\r\nexynos_elb_writel(exynos_pcie, 1, PCIE_STICKY_RESET);\r\nexynos_elb_writel(exynos_pcie, 1, PCIE_NONSTICKY_RESET);\r\nexynos_elb_writel(exynos_pcie, 1, PCIE_APP_INIT_RESET);\r\nexynos_elb_writel(exynos_pcie, 0, PCIE_APP_INIT_RESET);\r\nexynos_blk_writel(exynos_pcie, 1, PCIE_PHY_MAC_RESET);\r\n}\r\nstatic void exynos_pcie_assert_phy_reset(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_MAC_RESET);\r\nexynos_blk_writel(exynos_pcie, 1, PCIE_PHY_GLOBAL_RESET);\r\n}\r\nstatic void exynos_pcie_deassert_phy_reset(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_GLOBAL_RESET);\r\nexynos_elb_writel(exynos_pcie, 1, PCIE_PWR_RESET);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_COMMON_RESET);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_CMN_REG);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_TRSVREG_RESET);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_TRSV_RESET);\r\n}\r\nstatic void exynos_pcie_power_on_phy(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_COMMON_POWER);\r\nval &= ~PCIE_PHY_COMMON_PD_CMN;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_COMMON_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV0_POWER);\r\nval &= ~PCIE_PHY_TRSV0_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV0_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV1_POWER);\r\nval &= ~PCIE_PHY_TRSV1_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV1_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV2_POWER);\r\nval &= ~PCIE_PHY_TRSV2_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV2_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV3_POWER);\r\nval &= ~PCIE_PHY_TRSV3_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV3_POWER);\r\n}\r\nstatic void exynos_pcie_power_off_phy(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_COMMON_POWER);\r\nval |= PCIE_PHY_COMMON_PD_CMN;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_COMMON_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV0_POWER);\r\nval |= PCIE_PHY_TRSV0_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV0_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV1_POWER);\r\nval |= PCIE_PHY_TRSV1_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV1_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV2_POWER);\r\nval |= PCIE_PHY_TRSV2_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV2_POWER);\r\nval = exynos_phy_readl(exynos_pcie, PCIE_PHY_TRSV3_POWER);\r\nval |= PCIE_PHY_TRSV3_PD_TSV;\r\nexynos_phy_writel(exynos_pcie, val, PCIE_PHY_TRSV3_POWER);\r\n}\r\nstatic void exynos_pcie_init_phy(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nexynos_phy_writel(exynos_pcie, 0x29, PCIE_PHY_DCC_FEEDBACK);\r\nexynos_phy_writel(exynos_pcie, 0xd5, PCIE_PHY_IMPEDANCE);\r\nexynos_phy_writel(exynos_pcie, 0x14, PCIE_PHY_PLL_DIV_0);\r\nexynos_phy_writel(exynos_pcie, 0x12, PCIE_PHY_PLL_DIV_1);\r\nexynos_phy_writel(exynos_pcie, 0x7f, PCIE_PHY_TRSV0_DRV_LVL);\r\nexynos_phy_writel(exynos_pcie, 0x0, PCIE_PHY_TRSV0_EMP_LVL);\r\nexynos_phy_writel(exynos_pcie, 0xe7, PCIE_PHY_PLL_BIAS);\r\nexynos_phy_writel(exynos_pcie, 0x82, PCIE_PHY_TRSV0_RXCDR);\r\nexynos_phy_writel(exynos_pcie, 0x82, PCIE_PHY_TRSV1_RXCDR);\r\nexynos_phy_writel(exynos_pcie, 0x82, PCIE_PHY_TRSV2_RXCDR);\r\nexynos_phy_writel(exynos_pcie, 0x82, PCIE_PHY_TRSV3_RXCDR);\r\nexynos_phy_writel(exynos_pcie, 0x39, PCIE_PHY_TRSV0_EMP_LVL);\r\nexynos_phy_writel(exynos_pcie, 0x39, PCIE_PHY_TRSV1_EMP_LVL);\r\nexynos_phy_writel(exynos_pcie, 0x39, PCIE_PHY_TRSV2_EMP_LVL);\r\nexynos_phy_writel(exynos_pcie, 0x39, PCIE_PHY_TRSV3_EMP_LVL);\r\nexynos_phy_writel(exynos_pcie, 0x20, PCIE_PHY_TRSV0_LVCC);\r\nexynos_phy_writel(exynos_pcie, 0xa0, PCIE_PHY_TRSV1_LVCC);\r\nexynos_phy_writel(exynos_pcie, 0xa0, PCIE_PHY_TRSV2_LVCC);\r\nexynos_phy_writel(exynos_pcie, 0xa0, PCIE_PHY_TRSV3_LVCC);\r\n}\r\nstatic void exynos_pcie_assert_reset(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nif (exynos_pcie->reset_gpio >= 0)\r\ndevm_gpio_request_one(pp->dev, exynos_pcie->reset_gpio,\r\nGPIOF_OUT_INIT_HIGH, "RESET");\r\n}\r\nstatic int exynos_pcie_establish_link(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nu32 val;\r\nif (dw_pcie_link_up(pp)) {\r\ndev_err(pp->dev, "Link already up\n");\r\nreturn 0;\r\n}\r\nexynos_pcie_assert_core_reset(pp);\r\nexynos_pcie_assert_phy_reset(pp);\r\nexynos_pcie_deassert_phy_reset(pp);\r\nexynos_pcie_power_on_phy(pp);\r\nexynos_pcie_init_phy(pp);\r\nexynos_blk_writel(exynos_pcie, 1, PCIE_PHY_COMMON_RESET);\r\nudelay(500);\r\nexynos_blk_writel(exynos_pcie, 0, PCIE_PHY_COMMON_RESET);\r\nexynos_pcie_deassert_core_reset(pp);\r\ndw_pcie_setup_rc(pp);\r\nexynos_pcie_assert_reset(pp);\r\nexynos_elb_writel(exynos_pcie, PCIE_ELBI_LTSSM_ENABLE,\r\nPCIE_APP_LTSSM_ENABLE);\r\nif (!dw_pcie_wait_for_link(pp))\r\nreturn 0;\r\nwhile (exynos_phy_readl(exynos_pcie, PCIE_PHY_PLL_LOCKED) == 0) {\r\nval = exynos_blk_readl(exynos_pcie, PCIE_PHY_PLL_LOCKED);\r\ndev_info(pp->dev, "PLL Locked: 0x%x\n", val);\r\n}\r\nexynos_pcie_power_off_phy(pp);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void exynos_pcie_clear_irq_pulse(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = exynos_elb_readl(exynos_pcie, PCIE_IRQ_PULSE);\r\nexynos_elb_writel(exynos_pcie, val, PCIE_IRQ_PULSE);\r\n}\r\nstatic void exynos_pcie_enable_irq_pulse(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nval = IRQ_INTA_ASSERT | IRQ_INTB_ASSERT |\r\nIRQ_INTC_ASSERT | IRQ_INTD_ASSERT;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_IRQ_EN_PULSE);\r\n}\r\nstatic irqreturn_t exynos_pcie_irq_handler(int irq, void *arg)\r\n{\r\nstruct pcie_port *pp = arg;\r\nexynos_pcie_clear_irq_pulse(pp);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t exynos_pcie_msi_irq_handler(int irq, void *arg)\r\n{\r\nstruct pcie_port *pp = arg;\r\nreturn dw_handle_msi_irq(pp);\r\n}\r\nstatic void exynos_pcie_msi_init(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\ndw_pcie_msi_init(pp);\r\nval = exynos_elb_readl(exynos_pcie, PCIE_IRQ_EN_LEVEL);\r\nval |= IRQ_MSI_ENABLE;\r\nexynos_elb_writel(exynos_pcie, val, PCIE_IRQ_EN_LEVEL);\r\n}\r\nstatic void exynos_pcie_enable_interrupts(struct pcie_port *pp)\r\n{\r\nexynos_pcie_enable_irq_pulse(pp);\r\nif (IS_ENABLED(CONFIG_PCI_MSI))\r\nexynos_pcie_msi_init(pp);\r\n}\r\nstatic inline void exynos_pcie_readl_rc(struct pcie_port *pp,\r\nvoid __iomem *dbi_base, u32 *val)\r\n{\r\nexynos_pcie_sideband_dbi_r_mode(pp, true);\r\n*val = readl(dbi_base);\r\nexynos_pcie_sideband_dbi_r_mode(pp, false);\r\n}\r\nstatic inline void exynos_pcie_writel_rc(struct pcie_port *pp,\r\nu32 val, void __iomem *dbi_base)\r\n{\r\nexynos_pcie_sideband_dbi_w_mode(pp, true);\r\nwritel(val, dbi_base);\r\nexynos_pcie_sideband_dbi_w_mode(pp, false);\r\n}\r\nstatic int exynos_pcie_rd_own_conf(struct pcie_port *pp, int where, int size,\r\nu32 *val)\r\n{\r\nint ret;\r\nexynos_pcie_sideband_dbi_r_mode(pp, true);\r\nret = dw_pcie_cfg_read(pp->dbi_base + where, size, val);\r\nexynos_pcie_sideband_dbi_r_mode(pp, false);\r\nreturn ret;\r\n}\r\nstatic int exynos_pcie_wr_own_conf(struct pcie_port *pp, int where, int size,\r\nu32 val)\r\n{\r\nint ret;\r\nexynos_pcie_sideband_dbi_w_mode(pp, true);\r\nret = dw_pcie_cfg_write(pp->dbi_base + where, size, val);\r\nexynos_pcie_sideband_dbi_w_mode(pp, false);\r\nreturn ret;\r\n}\r\nstatic int exynos_pcie_link_up(struct pcie_port *pp)\r\n{\r\nstruct exynos_pcie *exynos_pcie = to_exynos_pcie(pp);\r\nu32 val = exynos_elb_readl(exynos_pcie, PCIE_ELBI_RDLH_LINKUP);\r\nif (val == PCIE_ELBI_LTSSM_ENABLE)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void exynos_pcie_host_init(struct pcie_port *pp)\r\n{\r\nexynos_pcie_establish_link(pp);\r\nexynos_pcie_enable_interrupts(pp);\r\n}\r\nstatic int __init exynos_add_pcie_port(struct pcie_port *pp,\r\nstruct platform_device *pdev)\r\n{\r\nint ret;\r\npp->irq = platform_get_irq(pdev, 1);\r\nif (!pp->irq) {\r\ndev_err(&pdev->dev, "failed to get irq\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_request_irq(&pdev->dev, pp->irq, exynos_pcie_irq_handler,\r\nIRQF_SHARED, "exynos-pcie", pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request irq\n");\r\nreturn ret;\r\n}\r\nif (IS_ENABLED(CONFIG_PCI_MSI)) {\r\npp->msi_irq = platform_get_irq(pdev, 0);\r\nif (!pp->msi_irq) {\r\ndev_err(&pdev->dev, "failed to get msi irq\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_request_irq(&pdev->dev, pp->msi_irq,\r\nexynos_pcie_msi_irq_handler,\r\nIRQF_SHARED | IRQF_NO_THREAD,\r\n"exynos-pcie", pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request msi irq\n");\r\nreturn ret;\r\n}\r\n}\r\npp->root_bus_nr = -1;\r\npp->ops = &exynos_pcie_host_ops;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init exynos_pcie_probe(struct platform_device *pdev)\r\n{\r\nstruct exynos_pcie *exynos_pcie;\r\nstruct pcie_port *pp;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *elbi_base;\r\nstruct resource *phy_base;\r\nstruct resource *block_base;\r\nint ret;\r\nexynos_pcie = devm_kzalloc(&pdev->dev, sizeof(*exynos_pcie),\r\nGFP_KERNEL);\r\nif (!exynos_pcie)\r\nreturn -ENOMEM;\r\npp = &exynos_pcie->pp;\r\npp->dev = &pdev->dev;\r\nexynos_pcie->reset_gpio = of_get_named_gpio(np, "reset-gpio", 0);\r\nexynos_pcie->clk = devm_clk_get(&pdev->dev, "pcie");\r\nif (IS_ERR(exynos_pcie->clk)) {\r\ndev_err(&pdev->dev, "Failed to get pcie rc clock\n");\r\nreturn PTR_ERR(exynos_pcie->clk);\r\n}\r\nret = clk_prepare_enable(exynos_pcie->clk);\r\nif (ret)\r\nreturn ret;\r\nexynos_pcie->bus_clk = devm_clk_get(&pdev->dev, "pcie_bus");\r\nif (IS_ERR(exynos_pcie->bus_clk)) {\r\ndev_err(&pdev->dev, "Failed to get pcie bus clock\n");\r\nret = PTR_ERR(exynos_pcie->bus_clk);\r\ngoto fail_clk;\r\n}\r\nret = clk_prepare_enable(exynos_pcie->bus_clk);\r\nif (ret)\r\ngoto fail_clk;\r\nelbi_base = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nexynos_pcie->elbi_base = devm_ioremap_resource(&pdev->dev, elbi_base);\r\nif (IS_ERR(exynos_pcie->elbi_base)) {\r\nret = PTR_ERR(exynos_pcie->elbi_base);\r\ngoto fail_bus_clk;\r\n}\r\nphy_base = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nexynos_pcie->phy_base = devm_ioremap_resource(&pdev->dev, phy_base);\r\nif (IS_ERR(exynos_pcie->phy_base)) {\r\nret = PTR_ERR(exynos_pcie->phy_base);\r\ngoto fail_bus_clk;\r\n}\r\nblock_base = platform_get_resource(pdev, IORESOURCE_MEM, 2);\r\nexynos_pcie->block_base = devm_ioremap_resource(&pdev->dev, block_base);\r\nif (IS_ERR(exynos_pcie->block_base)) {\r\nret = PTR_ERR(exynos_pcie->block_base);\r\ngoto fail_bus_clk;\r\n}\r\nret = exynos_add_pcie_port(pp, pdev);\r\nif (ret < 0)\r\ngoto fail_bus_clk;\r\nplatform_set_drvdata(pdev, exynos_pcie);\r\nreturn 0;\r\nfail_bus_clk:\r\nclk_disable_unprepare(exynos_pcie->bus_clk);\r\nfail_clk:\r\nclk_disable_unprepare(exynos_pcie->clk);\r\nreturn ret;\r\n}\r\nstatic int __exit exynos_pcie_remove(struct platform_device *pdev)\r\n{\r\nstruct exynos_pcie *exynos_pcie = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(exynos_pcie->bus_clk);\r\nclk_disable_unprepare(exynos_pcie->clk);\r\nreturn 0;\r\n}\r\nstatic int __init exynos_pcie_init(void)\r\n{\r\nreturn platform_driver_probe(&exynos_pcie_driver, exynos_pcie_probe);\r\n}

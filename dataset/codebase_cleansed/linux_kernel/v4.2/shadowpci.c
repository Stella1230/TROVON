static u32\r\npcirom_read(void *data, u32 offset, u32 length, struct nvkm_bios *bios)\r\n{\r\nstruct priv *priv = data;\r\nif (offset + length <= priv->size) {\r\nmemcpy_fromio(bios->data + offset, priv->rom + offset, length);\r\nreturn length;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\npcirom_fini(void *data)\r\n{\r\nstruct priv *priv = data;\r\npci_unmap_rom(priv->pdev, priv->rom);\r\npci_disable_rom(priv->pdev);\r\nkfree(priv);\r\n}\r\nstatic void *\r\npcirom_init(struct nvkm_bios *bios, const char *name)\r\n{\r\nstruct pci_dev *pdev = nv_device(bios)->pdev;\r\nstruct priv *priv = NULL;\r\nint ret;\r\nif (!(ret = pci_enable_rom(pdev))) {\r\nif (ret = -ENOMEM,\r\n(priv = kmalloc(sizeof(*priv), GFP_KERNEL))) {\r\nif (ret = -EFAULT,\r\n(priv->rom = pci_map_rom(pdev, &priv->size))) {\r\npriv->pdev = pdev;\r\nreturn priv;\r\n}\r\nkfree(priv);\r\n}\r\npci_disable_rom(pdev);\r\n}\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void *\r\nplatform_init(struct nvkm_bios *bios, const char *name)\r\n{\r\nstruct pci_dev *pdev = nv_device(bios)->pdev;\r\nstruct priv *priv;\r\nint ret = -ENOMEM;\r\nif ((priv = kmalloc(sizeof(*priv), GFP_KERNEL))) {\r\nif (ret = -ENODEV,\r\n(priv->rom = pci_platform_rom(pdev, &priv->size)))\r\nreturn priv;\r\nkfree(priv);\r\n}\r\nreturn ERR_PTR(ret);\r\n}

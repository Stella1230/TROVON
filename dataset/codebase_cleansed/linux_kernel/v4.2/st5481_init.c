static int probe_st5481(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct st5481_adapter *adapter;\r\nstruct hisax_b_if *b_if[2];\r\nint retval, i;\r\nprintk(KERN_INFO "st541: found adapter VendorId %04x, ProductId %04x, LEDs %d\n",\r\nle16_to_cpu(dev->descriptor.idVendor),\r\nle16_to_cpu(dev->descriptor.idProduct),\r\nnumber_of_leds);\r\nadapter = kzalloc(sizeof(struct st5481_adapter), GFP_KERNEL);\r\nif (!adapter)\r\nreturn -ENOMEM;\r\nadapter->number_of_leds = number_of_leds;\r\nadapter->usb_dev = dev;\r\nadapter->hisax_d_if.owner = THIS_MODULE;\r\nadapter->hisax_d_if.ifc.priv = adapter;\r\nadapter->hisax_d_if.ifc.l2l1 = st5481_d_l2l1;\r\nfor (i = 0; i < 2; i++) {\r\nadapter->bcs[i].adapter = adapter;\r\nadapter->bcs[i].channel = i;\r\nadapter->bcs[i].b_if.ifc.priv = &adapter->bcs[i];\r\nadapter->bcs[i].b_if.ifc.l2l1 = st5481_b_l2l1;\r\n}\r\nretval = st5481_setup_usb(adapter);\r\nif (retval < 0)\r\ngoto err;\r\nretval = st5481_setup_d(adapter);\r\nif (retval < 0)\r\ngoto err_usb;\r\nretval = st5481_setup_b(&adapter->bcs[0]);\r\nif (retval < 0)\r\ngoto err_d;\r\nretval = st5481_setup_b(&adapter->bcs[1]);\r\nif (retval < 0)\r\ngoto err_b;\r\nfor (i = 0; i < 2; i++)\r\nb_if[i] = &adapter->bcs[i].b_if;\r\nif (hisax_register(&adapter->hisax_d_if, b_if, "st5481_usb",\r\nprotocol) != 0)\r\ngoto err_b1;\r\nst5481_start(adapter);\r\nusb_set_intfdata(intf, adapter);\r\nreturn 0;\r\nerr_b1:\r\nst5481_release_b(&adapter->bcs[1]);\r\nerr_b:\r\nst5481_release_b(&adapter->bcs[0]);\r\nerr_d:\r\nst5481_release_d(adapter);\r\nerr_usb:\r\nst5481_release_usb(adapter);\r\nerr:\r\nkfree(adapter);\r\nreturn -EIO;\r\n}\r\nstatic void disconnect_st5481(struct usb_interface *intf)\r\n{\r\nstruct st5481_adapter *adapter = usb_get_intfdata(intf);\r\nDBG(1, "");\r\nusb_set_intfdata(intf, NULL);\r\nif (!adapter)\r\nreturn;\r\nst5481_stop(adapter);\r\nst5481_release_b(&adapter->bcs[1]);\r\nst5481_release_b(&adapter->bcs[0]);\r\nst5481_release_d(adapter);\r\nmdelay(2);\r\nst5481_release_usb(adapter);\r\nhisax_unregister(&adapter->hisax_d_if);\r\nkfree(adapter);\r\n}\r\nstatic int __init st5481_usb_init(void)\r\n{\r\nint retval;\r\n#ifdef CONFIG_HISAX_DEBUG\r\nst5481_debug = debug;\r\n#endif\r\nprintk(KERN_INFO "hisax_st5481: ST5481 USB ISDN driver $Revision: 2.4.2.3 $\n");\r\nretval = st5481_d_init();\r\nif (retval < 0)\r\ngoto out;\r\nretval = usb_register(&st5481_usb_driver);\r\nif (retval < 0)\r\ngoto out_d_exit;\r\nreturn 0;\r\nout_d_exit:\r\nst5481_d_exit();\r\nout:\r\nreturn retval;\r\n}\r\nstatic void __exit st5481_usb_exit(void)\r\n{\r\nusb_deregister(&st5481_usb_driver);\r\nst5481_d_exit();\r\n}

static void\r\nprobe_sched_switch(void *ignore, struct task_struct *prev, struct task_struct *next)\r\n{\r\nif (unlikely(!sched_ref))\r\nreturn;\r\ntracing_record_cmdline(prev);\r\ntracing_record_cmdline(next);\r\n}\r\nstatic void\r\nprobe_sched_wakeup(void *ignore, struct task_struct *wakee, int success)\r\n{\r\nif (unlikely(!sched_ref))\r\nreturn;\r\ntracing_record_cmdline(current);\r\n}\r\nstatic int tracing_sched_register(void)\r\n{\r\nint ret;\r\nret = register_trace_sched_wakeup(probe_sched_wakeup, NULL);\r\nif (ret) {\r\npr_info("wakeup trace: Couldn't activate tracepoint"\r\n" probe to kernel_sched_wakeup\n");\r\nreturn ret;\r\n}\r\nret = register_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\r\nif (ret) {\r\npr_info("wakeup trace: Couldn't activate tracepoint"\r\n" probe to kernel_sched_wakeup_new\n");\r\ngoto fail_deprobe;\r\n}\r\nret = register_trace_sched_switch(probe_sched_switch, NULL);\r\nif (ret) {\r\npr_info("sched trace: Couldn't activate tracepoint"\r\n" probe to kernel_sched_switch\n");\r\ngoto fail_deprobe_wake_new;\r\n}\r\nreturn ret;\r\nfail_deprobe_wake_new:\r\nunregister_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\r\nfail_deprobe:\r\nunregister_trace_sched_wakeup(probe_sched_wakeup, NULL);\r\nreturn ret;\r\n}\r\nstatic void tracing_sched_unregister(void)\r\n{\r\nunregister_trace_sched_switch(probe_sched_switch, NULL);\r\nunregister_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\r\nunregister_trace_sched_wakeup(probe_sched_wakeup, NULL);\r\n}\r\nstatic void tracing_start_sched_switch(void)\r\n{\r\nmutex_lock(&sched_register_mutex);\r\nif (!(sched_ref++))\r\ntracing_sched_register();\r\nmutex_unlock(&sched_register_mutex);\r\n}\r\nstatic void tracing_stop_sched_switch(void)\r\n{\r\nmutex_lock(&sched_register_mutex);\r\nif (!(--sched_ref))\r\ntracing_sched_unregister();\r\nmutex_unlock(&sched_register_mutex);\r\n}\r\nvoid tracing_start_cmdline_record(void)\r\n{\r\ntracing_start_sched_switch();\r\n}\r\nvoid tracing_stop_cmdline_record(void)\r\n{\r\ntracing_stop_sched_switch();\r\n}

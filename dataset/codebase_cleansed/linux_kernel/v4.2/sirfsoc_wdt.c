static unsigned int sirfsoc_wdt_gettimeleft(struct watchdog_device *wdd)\r\n{\r\nu32 counter, match;\r\nvoid __iomem *wdt_base;\r\nint time_left;\r\nwdt_base = watchdog_get_drvdata(wdd);\r\ncounter = readl(wdt_base + SIRFSOC_TIMER_COUNTER_LO);\r\nmatch = readl(wdt_base +\r\nSIRFSOC_TIMER_MATCH_0 + (SIRFSOC_TIMER_WDT_INDEX << 2));\r\ntime_left = match - counter;\r\nreturn time_left / CLOCK_FREQ;\r\n}\r\nstatic int sirfsoc_wdt_updatetimeout(struct watchdog_device *wdd)\r\n{\r\nu32 counter, timeout_ticks;\r\nvoid __iomem *wdt_base;\r\ntimeout_ticks = wdd->timeout * CLOCK_FREQ;\r\nwdt_base = watchdog_get_drvdata(wdd);\r\nwritel(1, wdt_base + SIRFSOC_TIMER_LATCH);\r\ncounter = readl(wdt_base + SIRFSOC_TIMER_LATCHED_LO);\r\ncounter += timeout_ticks;\r\nwritel(counter, wdt_base +\r\nSIRFSOC_TIMER_MATCH_0 + (SIRFSOC_TIMER_WDT_INDEX << 2));\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_enable(struct watchdog_device *wdd)\r\n{\r\nvoid __iomem *wdt_base = watchdog_get_drvdata(wdd);\r\nsirfsoc_wdt_updatetimeout(wdd);\r\nwritel(readl(wdt_base + SIRFSOC_TIMER_INT_EN)\r\n| (1 << SIRFSOC_TIMER_WDT_INDEX),\r\nwdt_base + SIRFSOC_TIMER_INT_EN);\r\nwritel(1, wdt_base + SIRFSOC_TIMER_WATCHDOG_EN);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_disable(struct watchdog_device *wdd)\r\n{\r\nvoid __iomem *wdt_base = watchdog_get_drvdata(wdd);\r\nwritel(0, wdt_base + SIRFSOC_TIMER_WATCHDOG_EN);\r\nwritel(readl(wdt_base + SIRFSOC_TIMER_INT_EN)\r\n& (~(1 << SIRFSOC_TIMER_WDT_INDEX)),\r\nwdt_base + SIRFSOC_TIMER_INT_EN);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_settimeout(struct watchdog_device *wdd, unsigned int to)\r\n{\r\nwdd->timeout = to;\r\nsirfsoc_wdt_updatetimeout(wdd);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nvoid __iomem *base;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nwatchdog_set_drvdata(&sirfsoc_wdd, base);\r\nwatchdog_init_timeout(&sirfsoc_wdd, timeout, &pdev->dev);\r\nwatchdog_set_nowayout(&sirfsoc_wdd, nowayout);\r\nret = watchdog_register_device(&sirfsoc_wdd);\r\nif (ret)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, &sirfsoc_wdd);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdd = platform_get_drvdata(pdev);\r\nsirfsoc_wdt_disable(wdd);\r\n}\r\nstatic int sirfsoc_wdt_remove(struct platform_device *pdev)\r\n{\r\nsirfsoc_wdt_shutdown(pdev);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_suspend(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_wdt_resume(struct device *dev)\r\n{\r\nstruct watchdog_device *wdd = dev_get_drvdata(dev);\r\nsirfsoc_wdt_updatetimeout(wdd);\r\nreturn 0;\r\n}

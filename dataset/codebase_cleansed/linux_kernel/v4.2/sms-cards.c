struct sms_board *sms_get_board(unsigned id)\r\n{\r\nBUG_ON(id >= ARRAY_SIZE(sms_boards));\r\nreturn &sms_boards[id];\r\n}\r\nstatic inline void sms_gpio_assign_11xx_default_led_config(\r\nstruct smscore_config_gpio *p_gpio_config) {\r\np_gpio_config->direction = SMS_GPIO_DIRECTION_OUTPUT;\r\np_gpio_config->inputcharacteristics =\r\nSMS_GPIO_INPUTCHARACTERISTICS_NORMAL;\r\np_gpio_config->outputdriving = SMS_GPIO_OUTPUTDRIVING_4mA;\r\np_gpio_config->outputslewrate = SMS_GPIO_OUTPUT_SLEW_RATE_0_45_V_NS;\r\np_gpio_config->pullupdown = SMS_GPIO_PULLUPDOWN_NONE;\r\n}\r\nint sms_board_event(struct smscore_device_t *coredev,\r\nenum SMS_BOARD_EVENTS gevent)\r\n{\r\nstruct smscore_config_gpio my_gpio_config;\r\nsms_gpio_assign_11xx_default_led_config(&my_gpio_config);\r\nswitch (gevent) {\r\ncase BOARD_EVENT_POWER_INIT:\r\nbreak;\r\ncase BOARD_EVENT_POWER_SUSPEND:\r\nbreak;\r\ncase BOARD_EVENT_POWER_RESUME:\r\nbreak;\r\ncase BOARD_EVENT_BIND:\r\nbreak;\r\ncase BOARD_EVENT_SCAN_PROG:\r\nbreak;\r\ncase BOARD_EVENT_SCAN_COMP:\r\nbreak;\r\ncase BOARD_EVENT_EMERGENCY_WARNING_SIGNAL:\r\nbreak;\r\ncase BOARD_EVENT_FE_LOCK:\r\nbreak;\r\ncase BOARD_EVENT_FE_UNLOCK:\r\nbreak;\r\ncase BOARD_EVENT_DEMOD_LOCK:\r\nbreak;\r\ncase BOARD_EVENT_DEMOD_UNLOCK:\r\nbreak;\r\ncase BOARD_EVENT_RECEPTION_MAX_4:\r\nbreak;\r\ncase BOARD_EVENT_RECEPTION_3:\r\nbreak;\r\ncase BOARD_EVENT_RECEPTION_2:\r\nbreak;\r\ncase BOARD_EVENT_RECEPTION_1:\r\nbreak;\r\ncase BOARD_EVENT_RECEPTION_LOST_0:\r\nbreak;\r\ncase BOARD_EVENT_MULTIPLEX_OK:\r\nbreak;\r\ncase BOARD_EVENT_MULTIPLEX_ERRORS:\r\nbreak;\r\ndefault:\r\npr_err("Unknown SMS board event\n");\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sms_set_gpio(struct smscore_device_t *coredev, int pin, int enable)\r\n{\r\nint lvl, ret;\r\nu32 gpio;\r\nstruct smscore_config_gpio gpioconfig = {\r\n.direction = SMS_GPIO_DIRECTION_OUTPUT,\r\n.pullupdown = SMS_GPIO_PULLUPDOWN_NONE,\r\n.inputcharacteristics = SMS_GPIO_INPUTCHARACTERISTICS_NORMAL,\r\n.outputslewrate = SMS_GPIO_OUTPUT_SLEW_RATE_FAST,\r\n.outputdriving = SMS_GPIO_OUTPUTDRIVING_S_4mA,\r\n};\r\nif (pin == 0)\r\nreturn -EINVAL;\r\nif (pin < 0) {\r\ngpio = pin * -1;\r\nlvl = enable ? 0 : 1;\r\n} else {\r\ngpio = pin;\r\nlvl = enable ? 1 : 0;\r\n}\r\nret = smscore_configure_gpio(coredev, gpio, &gpioconfig);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn smscore_set_gpio(coredev, gpio, lvl);\r\n}\r\nint sms_board_setup(struct smscore_device_t *coredev)\r\n{\r\nint board_id = smscore_get_board_id(coredev);\r\nstruct sms_board *board = sms_get_board(board_id);\r\nswitch (board_id) {\r\ncase SMS1XXX_BOARD_HAUPPAUGE_WINDHAM:\r\nsms_set_gpio(coredev, board->led_power, 0);\r\nsms_set_gpio(coredev, board->led_hi, 0);\r\nsms_set_gpio(coredev, board->led_lo, 0);\r\nbreak;\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD_R2:\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD:\r\nsms_set_gpio(coredev, board->lna_ctrl, 0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint sms_board_power(struct smscore_device_t *coredev, int onoff)\r\n{\r\nint board_id = smscore_get_board_id(coredev);\r\nstruct sms_board *board = sms_get_board(board_id);\r\nswitch (board_id) {\r\ncase SMS1XXX_BOARD_HAUPPAUGE_WINDHAM:\r\nsms_set_gpio(coredev,\r\nboard->led_power, onoff ? 1 : 0);\r\nbreak;\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD_R2:\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD:\r\nif (!onoff)\r\nsms_set_gpio(coredev, board->lna_ctrl, 0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint sms_board_led_feedback(struct smscore_device_t *coredev, int led)\r\n{\r\nint board_id = smscore_get_board_id(coredev);\r\nstruct sms_board *board = sms_get_board(board_id);\r\nif (smscore_led_state(coredev, -1) == led)\r\nreturn 0;\r\nswitch (board_id) {\r\ncase SMS1XXX_BOARD_HAUPPAUGE_WINDHAM:\r\nsms_set_gpio(coredev,\r\nboard->led_lo, (led & SMS_LED_LO) ? 1 : 0);\r\nsms_set_gpio(coredev,\r\nboard->led_hi, (led & SMS_LED_HI) ? 1 : 0);\r\nsmscore_led_state(coredev, led);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint sms_board_lna_control(struct smscore_device_t *coredev, int onoff)\r\n{\r\nint board_id = smscore_get_board_id(coredev);\r\nstruct sms_board *board = sms_get_board(board_id);\r\npr_debug("%s: LNA %s\n", __func__, onoff ? "enabled" : "disabled");\r\nswitch (board_id) {\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD_R2:\r\ncase SMS1XXX_BOARD_HAUPPAUGE_TIGER_MINICARD:\r\nsms_set_gpio(coredev,\r\nboard->rf_switch, onoff ? 1 : 0);\r\nreturn sms_set_gpio(coredev,\r\nboard->lna_ctrl, onoff ? 1 : 0);\r\n}\r\nreturn -EINVAL;\r\n}\r\nint sms_board_load_modules(int id)\r\n{\r\nrequest_module("smsdvb");\r\nreturn 0;\r\n}

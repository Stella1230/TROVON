static void\r\nnv05_devinit_meminit(struct nvkm_devinit *devinit)\r\n{\r\nstatic const u8 default_config_tab[][2] = {\r\n{ 0x24, 0x00 },\r\n{ 0x28, 0x00 },\r\n{ 0x24, 0x01 },\r\n{ 0x1f, 0x00 },\r\n{ 0x0f, 0x00 },\r\n{ 0x17, 0x00 },\r\n{ 0x06, 0x00 },\r\n{ 0x00, 0x00 }\r\n};\r\nstruct nv04_devinit_priv *priv = (void *)devinit;\r\nstruct nvkm_bios *bios = nvkm_bios(priv);\r\nstruct io_mapping *fb;\r\nu32 patt = 0xdeadbeef;\r\nu16 data;\r\nu8 strap, ramcfg[2];\r\nint i, v;\r\nfb = fbmem_init(nv_device(priv));\r\nif (!fb) {\r\nnv_error(priv, "failed to map fb\n");\r\nreturn;\r\n}\r\nstrap = (nv_rd32(priv, 0x101000) & 0x0000003c) >> 2;\r\nif ((data = bmp_mem_init_table(bios))) {\r\nramcfg[0] = nv_ro08(bios, data + 2 * strap + 0);\r\nramcfg[1] = nv_ro08(bios, data + 2 * strap + 1);\r\n} else {\r\nramcfg[0] = default_config_tab[strap][0];\r\nramcfg[1] = default_config_tab[strap][1];\r\n}\r\nnv_wrvgas(priv, 0, 1, nv_rdvgas(priv, 0, 1) | 0x20);\r\nif (nv_rd32(priv, NV04_PFB_BOOT_0) & NV04_PFB_BOOT_0_UMA_ENABLE)\r\ngoto out;\r\nnv_mask(priv, NV04_PFB_DEBUG_0, NV04_PFB_DEBUG_0_REFRESH_OFF, 0);\r\nif (data) {\r\nfor (i = 0, data += 0x10; i < 8; i++, data += 4) {\r\nu32 scramble = nv_ro32(bios, data);\r\nnv_wr32(priv, NV04_PFB_SCRAMBLE(i), scramble);\r\n}\r\n}\r\nnv_mask(priv, NV04_PFB_BOOT_0, 0x3f, ramcfg[0]);\r\nif (ramcfg[1] & 0x80)\r\nnv_mask(priv, NV04_PFB_CFG0, 0, NV04_PFB_CFG0_SCRAMBLE);\r\nnv_mask(priv, NV04_PFB_CFG1, 0x700001, (ramcfg[1] & 1) << 20);\r\nnv_mask(priv, NV04_PFB_CFG1, 0, 1);\r\nfor (i = 0; i < 4; i++)\r\nfbmem_poke(fb, 4 * i, patt);\r\nif (fbmem_peek(fb, 0xc) != patt)\r\nnv_mask(priv, NV04_PFB_BOOT_0,\r\nNV04_PFB_BOOT_0_RAM_WIDTH_128, 0);\r\nv = nv_rd32(priv, NV04_PFB_BOOT_0) & NV04_PFB_BOOT_0_RAM_AMOUNT;\r\nif (v == NV04_PFB_BOOT_0_RAM_AMOUNT_32MB &&\r\n(!fbmem_readback(fb, 0x1000000, ++patt) ||\r\n!fbmem_readback(fb, 0, ++patt)))\r\nnv_mask(priv, NV04_PFB_BOOT_0, NV04_PFB_BOOT_0_RAM_AMOUNT,\r\nNV04_PFB_BOOT_0_RAM_AMOUNT_16MB);\r\nif (v == NV04_PFB_BOOT_0_RAM_AMOUNT_16MB &&\r\n!fbmem_readback(fb, 0x800000, ++patt))\r\nnv_mask(priv, NV04_PFB_BOOT_0, NV04_PFB_BOOT_0_RAM_AMOUNT,\r\nNV04_PFB_BOOT_0_RAM_AMOUNT_8MB);\r\nif (!fbmem_readback(fb, 0x400000, ++patt))\r\nnv_mask(priv, NV04_PFB_BOOT_0, NV04_PFB_BOOT_0_RAM_AMOUNT,\r\nNV04_PFB_BOOT_0_RAM_AMOUNT_4MB);\r\nout:\r\nnv_wrvgas(priv, 0, 1, nv_rdvgas(priv, 0, 1) & ~0x20);\r\nfbmem_fini(fb);\r\n}

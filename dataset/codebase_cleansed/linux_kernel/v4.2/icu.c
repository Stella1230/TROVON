static inline uint16_t icu1_set(uint8_t offset, uint16_t set)\r\n{\r\nuint16_t data;\r\ndata = icu1_read(offset);\r\ndata |= set;\r\nicu1_write(offset, data);\r\nreturn data;\r\n}\r\nstatic inline uint16_t icu1_clear(uint8_t offset, uint16_t clear)\r\n{\r\nuint16_t data;\r\ndata = icu1_read(offset);\r\ndata &= ~clear;\r\nicu1_write(offset, data);\r\nreturn data;\r\n}\r\nstatic inline uint16_t icu2_set(uint8_t offset, uint16_t set)\r\n{\r\nuint16_t data;\r\ndata = icu2_read(offset);\r\ndata |= set;\r\nicu2_write(offset, data);\r\nreturn data;\r\n}\r\nstatic inline uint16_t icu2_clear(uint8_t offset, uint16_t clear)\r\n{\r\nuint16_t data;\r\ndata = icu2_read(offset);\r\ndata &= ~clear;\r\nicu2_write(offset, data);\r\nreturn data;\r\n}\r\nvoid vr41xx_enable_piuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(PIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_set(MPIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_piuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(PIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_clear(MPIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_aiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(AIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_set(MAIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_aiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(AIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_clear(MAIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_kiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(KIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_set(MKIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_kiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(KIU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4111 ||\r\ncurrent_cpu_type() == CPU_VR4121) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_clear(MKIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_macint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(ETHERNET_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_set(MMACINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_disable_macint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(ETHERNET_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_clear(MMACINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_enable_dsiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(DSIU_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_set(MDSIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_disable_dsiuint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(DSIU_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu1_clear(MDSIUINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_enable_firint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(FIR_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_set(MFIRINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_disable_firint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(FIR_IRQ);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_clear(MFIRINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nvoid vr41xx_enable_pciint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(PCI_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MPCIINTREG, PCIINT0);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_pciint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(PCI_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MPCIINTREG, 0);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_scuint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(SCU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MSCUINTREG, SCUINT0);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_scuint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(SCU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MSCUINTREG, 0);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_csiint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(CSI_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_set(MCSIINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_csiint(uint16_t mask)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(CSI_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_clear(MCSIINTREG, mask);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_enable_bcuint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(BCU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MBCUINTREG, BCUINTR);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nvoid vr41xx_disable_bcuint(void)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(BCU_IRQ);\r\nunsigned long flags;\r\nif (current_cpu_type() == CPU_VR4122 ||\r\ncurrent_cpu_type() == CPU_VR4131 ||\r\ncurrent_cpu_type() == CPU_VR4133) {\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\nicu2_write(MBCUINTREG, 0);\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\n}\r\nstatic void disable_sysint1_irq(struct irq_data *d)\r\n{\r\nicu1_clear(MSYSINT1REG, 1 << SYSINT1_IRQ_TO_PIN(d->irq));\r\n}\r\nstatic void enable_sysint1_irq(struct irq_data *d)\r\n{\r\nicu1_set(MSYSINT1REG, 1 << SYSINT1_IRQ_TO_PIN(d->irq));\r\n}\r\nstatic void disable_sysint2_irq(struct irq_data *d)\r\n{\r\nicu2_clear(MSYSINT2REG, 1 << SYSINT2_IRQ_TO_PIN(d->irq));\r\n}\r\nstatic void enable_sysint2_irq(struct irq_data *d)\r\n{\r\nicu2_set(MSYSINT2REG, 1 << SYSINT2_IRQ_TO_PIN(d->irq));\r\n}\r\nstatic inline int set_sysint1_assign(unsigned int irq, unsigned char assign)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(irq);\r\nuint16_t intassign0, intassign1;\r\nunsigned int pin;\r\npin = SYSINT1_IRQ_TO_PIN(irq);\r\nraw_spin_lock_irq(&desc->lock);\r\nintassign0 = icu1_read(INTASSIGN0);\r\nintassign1 = icu1_read(INTASSIGN1);\r\nswitch (pin) {\r\ncase 0:\r\nintassign0 &= ~INTASSIGN_MASK;\r\nintassign0 |= (uint16_t)assign;\r\nbreak;\r\ncase 1:\r\nintassign0 &= ~(INTASSIGN_MASK << 3);\r\nintassign0 |= (uint16_t)assign << 3;\r\nbreak;\r\ncase 2:\r\nintassign0 &= ~(INTASSIGN_MASK << 6);\r\nintassign0 |= (uint16_t)assign << 6;\r\nbreak;\r\ncase 3:\r\nintassign0 &= ~(INTASSIGN_MASK << 9);\r\nintassign0 |= (uint16_t)assign << 9;\r\nbreak;\r\ncase 8:\r\nintassign0 &= ~(INTASSIGN_MASK << 12);\r\nintassign0 |= (uint16_t)assign << 12;\r\nbreak;\r\ncase 9:\r\nintassign1 &= ~INTASSIGN_MASK;\r\nintassign1 |= (uint16_t)assign;\r\nbreak;\r\ncase 11:\r\nintassign1 &= ~(INTASSIGN_MASK << 6);\r\nintassign1 |= (uint16_t)assign << 6;\r\nbreak;\r\ncase 12:\r\nintassign1 &= ~(INTASSIGN_MASK << 9);\r\nintassign1 |= (uint16_t)assign << 9;\r\nbreak;\r\ndefault:\r\nraw_spin_unlock_irq(&desc->lock);\r\nreturn -EINVAL;\r\n}\r\nsysint1_assign[pin] = assign;\r\nicu1_write(INTASSIGN0, intassign0);\r\nicu1_write(INTASSIGN1, intassign1);\r\nraw_spin_unlock_irq(&desc->lock);\r\nreturn 0;\r\n}\r\nstatic inline int set_sysint2_assign(unsigned int irq, unsigned char assign)\r\n{\r\nstruct irq_desc *desc = irq_to_desc(irq);\r\nuint16_t intassign2, intassign3;\r\nunsigned int pin;\r\npin = SYSINT2_IRQ_TO_PIN(irq);\r\nraw_spin_lock_irq(&desc->lock);\r\nintassign2 = icu1_read(INTASSIGN2);\r\nintassign3 = icu1_read(INTASSIGN3);\r\nswitch (pin) {\r\ncase 0:\r\nintassign2 &= ~INTASSIGN_MASK;\r\nintassign2 |= (uint16_t)assign;\r\nbreak;\r\ncase 1:\r\nintassign2 &= ~(INTASSIGN_MASK << 3);\r\nintassign2 |= (uint16_t)assign << 3;\r\nbreak;\r\ncase 3:\r\nintassign2 &= ~(INTASSIGN_MASK << 6);\r\nintassign2 |= (uint16_t)assign << 6;\r\nbreak;\r\ncase 4:\r\nintassign2 &= ~(INTASSIGN_MASK << 9);\r\nintassign2 |= (uint16_t)assign << 9;\r\nbreak;\r\ncase 5:\r\nintassign2 &= ~(INTASSIGN_MASK << 12);\r\nintassign2 |= (uint16_t)assign << 12;\r\nbreak;\r\ncase 6:\r\nintassign3 &= ~INTASSIGN_MASK;\r\nintassign3 |= (uint16_t)assign;\r\nbreak;\r\ncase 7:\r\nintassign3 &= ~(INTASSIGN_MASK << 3);\r\nintassign3 |= (uint16_t)assign << 3;\r\nbreak;\r\ncase 8:\r\nintassign3 &= ~(INTASSIGN_MASK << 6);\r\nintassign3 |= (uint16_t)assign << 6;\r\nbreak;\r\ncase 9:\r\nintassign3 &= ~(INTASSIGN_MASK << 9);\r\nintassign3 |= (uint16_t)assign << 9;\r\nbreak;\r\ncase 10:\r\nintassign3 &= ~(INTASSIGN_MASK << 12);\r\nintassign3 |= (uint16_t)assign << 12;\r\nbreak;\r\ndefault:\r\nraw_spin_unlock_irq(&desc->lock);\r\nreturn -EINVAL;\r\n}\r\nsysint2_assign[pin] = assign;\r\nicu1_write(INTASSIGN2, intassign2);\r\nicu1_write(INTASSIGN3, intassign3);\r\nraw_spin_unlock_irq(&desc->lock);\r\nreturn 0;\r\n}\r\nint vr41xx_set_intassign(unsigned int irq, unsigned char intassign)\r\n{\r\nint retval = -EINVAL;\r\nif (current_cpu_type() != CPU_VR4133)\r\nreturn -EINVAL;\r\nif (intassign > INTASSIGN_MAX)\r\nreturn -EINVAL;\r\nif (irq >= SYSINT1_IRQ_BASE && irq <= SYSINT1_IRQ_LAST)\r\nretval = set_sysint1_assign(irq, intassign);\r\nelse if (irq >= SYSINT2_IRQ_BASE && irq <= SYSINT2_IRQ_LAST)\r\nretval = set_sysint2_assign(irq, intassign);\r\nreturn retval;\r\n}\r\nstatic int icu_get_irq(unsigned int irq)\r\n{\r\nuint16_t pend1, pend2;\r\nuint16_t mask1, mask2;\r\nint i;\r\npend1 = icu1_read(SYSINT1REG);\r\nmask1 = icu1_read(MSYSINT1REG);\r\npend2 = icu2_read(SYSINT2REG);\r\nmask2 = icu2_read(MSYSINT2REG);\r\nmask1 &= pend1;\r\nmask2 &= pend2;\r\nif (mask1) {\r\nfor (i = 0; i < 16; i++) {\r\nif (irq == INT_TO_IRQ(sysint1_assign[i]) && (mask1 & (1 << i)))\r\nreturn SYSINT1_IRQ(i);\r\n}\r\n}\r\nif (mask2) {\r\nfor (i = 0; i < 16; i++) {\r\nif (irq == INT_TO_IRQ(sysint2_assign[i]) && (mask2 & (1 << i)))\r\nreturn SYSINT2_IRQ(i);\r\n}\r\n}\r\nprintk(KERN_ERR "spurious ICU interrupt: %04x,%04x\n", pend1, pend2);\r\natomic_inc(&irq_err_count);\r\nreturn -1;\r\n}\r\nstatic int __init vr41xx_icu_init(void)\r\n{\r\nunsigned long icu1_start, icu2_start;\r\nint i;\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\ncase CPU_VR4121:\r\nicu1_start = ICU1_TYPE1_BASE;\r\nicu2_start = ICU2_TYPE1_BASE;\r\nbreak;\r\ncase CPU_VR4122:\r\ncase CPU_VR4131:\r\ncase CPU_VR4133:\r\nicu1_start = ICU1_TYPE2_BASE;\r\nicu2_start = ICU2_TYPE2_BASE;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "ICU: Unexpected CPU of NEC VR4100 series\n");\r\nreturn -ENODEV;\r\n}\r\nif (request_mem_region(icu1_start, ICU1_SIZE, "ICU") == NULL)\r\nreturn -EBUSY;\r\nif (request_mem_region(icu2_start, ICU2_SIZE, "ICU") == NULL) {\r\nrelease_mem_region(icu1_start, ICU1_SIZE);\r\nreturn -EBUSY;\r\n}\r\nicu1_base = ioremap(icu1_start, ICU1_SIZE);\r\nif (icu1_base == NULL) {\r\nrelease_mem_region(icu1_start, ICU1_SIZE);\r\nrelease_mem_region(icu2_start, ICU2_SIZE);\r\nreturn -ENOMEM;\r\n}\r\nicu2_base = ioremap(icu2_start, ICU2_SIZE);\r\nif (icu2_base == NULL) {\r\niounmap(icu1_base);\r\nrelease_mem_region(icu1_start, ICU1_SIZE);\r\nrelease_mem_region(icu2_start, ICU2_SIZE);\r\nreturn -ENOMEM;\r\n}\r\nicu1_write(MSYSINT1REG, 0);\r\nicu1_write(MGIUINTLREG, 0xffff);\r\nicu2_write(MSYSINT2REG, 0);\r\nicu2_write(MGIUINTHREG, 0xffff);\r\nfor (i = SYSINT1_IRQ_BASE; i <= SYSINT1_IRQ_LAST; i++)\r\nirq_set_chip_and_handler(i, &sysint1_irq_type,\r\nhandle_level_irq);\r\nfor (i = SYSINT2_IRQ_BASE; i <= SYSINT2_IRQ_LAST; i++)\r\nirq_set_chip_and_handler(i, &sysint2_irq_type,\r\nhandle_level_irq);\r\ncascade_irq(INT0_IRQ, icu_get_irq);\r\ncascade_irq(INT1_IRQ, icu_get_irq);\r\ncascade_irq(INT2_IRQ, icu_get_irq);\r\ncascade_irq(INT3_IRQ, icu_get_irq);\r\ncascade_irq(INT4_IRQ, icu_get_irq);\r\nreturn 0;\r\n}

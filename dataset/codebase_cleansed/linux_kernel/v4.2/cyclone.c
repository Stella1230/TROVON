void __init cyclone_setup(void)\r\n{\r\nuse_cyclone = 1;\r\n}\r\nstatic cycle_t read_cyclone(struct clocksource *cs)\r\n{\r\nreturn (cycle_t)readq((void __iomem *)cyclone_mc);\r\n}\r\nint __init init_cyclone_clock(void)\r\n{\r\nu64 __iomem *reg;\r\nu64 base;\r\nu64 offset;\r\nint i;\r\nu32 __iomem *cyclone_timer;\r\nif (!use_cyclone)\r\nreturn 0;\r\nprintk(KERN_INFO "Summit chipset: Starting Cyclone Counter.\n");\r\noffset = (CYCLONE_CBAR_ADDR);\r\nreg = ioremap_nocache(offset, sizeof(u64));\r\nif(!reg){\r\nprintk(KERN_ERR "Summit chipset: Could not find valid CBAR"\r\n" register.\n");\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\nbase = readq(reg);\r\niounmap(reg);\r\nif(!base){\r\nprintk(KERN_ERR "Summit chipset: Could not find valid CBAR"\r\n" value.\n");\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\noffset = (base + CYCLONE_PMCC_OFFSET);\r\nreg = ioremap_nocache(offset, sizeof(u64));\r\nif(!reg){\r\nprintk(KERN_ERR "Summit chipset: Could not find valid PMCC"\r\n" register.\n");\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\nwritel(0x00000001,reg);\r\niounmap(reg);\r\noffset = (base + CYCLONE_MPCS_OFFSET);\r\nreg = ioremap_nocache(offset, sizeof(u64));\r\nif(!reg){\r\nprintk(KERN_ERR "Summit chipset: Could not find valid MPCS"\r\n" register.\n");\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\nwritel(0x00000001,reg);\r\niounmap(reg);\r\noffset = (base + CYCLONE_MPMC_OFFSET);\r\ncyclone_timer = ioremap_nocache(offset, sizeof(u32));\r\nif(!cyclone_timer){\r\nprintk(KERN_ERR "Summit chipset: Could not find valid MPMC"\r\n" register.\n");\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\nfor(i=0; i<3; i++){\r\nu32 old = readl(cyclone_timer);\r\nint stall = 100;\r\nwhile(stall--) barrier();\r\nif(readl(cyclone_timer) == old){\r\nprintk(KERN_ERR "Summit chipset: Counter not counting!"\r\n" DISABLED\n");\r\niounmap(cyclone_timer);\r\ncyclone_timer = NULL;\r\nuse_cyclone = 0;\r\nreturn -ENODEV;\r\n}\r\n}\r\ncyclone_mc = cyclone_timer;\r\nclocksource_cyclone.archdata.fsys_mmio = cyclone_timer;\r\nclocksource_register_hz(&clocksource_cyclone, CYCLONE_TIMER_FREQ);\r\nreturn 0;\r\n}

static void iris_power_off(void)\r\n{\r\noutb(IRIS_GIO_PULSE, IRIS_GIO_OUTPUT);\r\nmsleep(850);\r\noutb(IRIS_GIO_REST, IRIS_GIO_OUTPUT);\r\n}\r\nstatic int iris_probe(struct platform_device *pdev)\r\n{\r\nunsigned char status = inb(IRIS_GIO_INPUT);\r\nif (status == IRIS_GIO_NODEV) {\r\nprintk(KERN_ERR "This machine does not seem to be an Iris. "\r\n"Power off handler not installed.\n");\r\nreturn -ENODEV;\r\n}\r\nold_pm_power_off = pm_power_off;\r\npm_power_off = &iris_power_off;\r\nprintk(KERN_INFO "Iris power_off handler installed.\n");\r\nreturn 0;\r\n}\r\nstatic int iris_remove(struct platform_device *pdev)\r\n{\r\npm_power_off = old_pm_power_off;\r\nprintk(KERN_INFO "Iris power_off handler uninstalled.\n");\r\nreturn 0;\r\n}\r\nstatic int iris_init(void)\r\n{\r\nint ret;\r\nif (force != 1) {\r\nprintk(KERN_ERR "The force parameter has not been set to 1."\r\n" The Iris poweroff handler will not be installed.\n");\r\nreturn -ENODEV;\r\n}\r\nret = platform_driver_register(&iris_driver);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Failed to register iris platform driver: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\niris_device = platform_device_register_simple("iris", (-1),\r\niris_resources, ARRAY_SIZE(iris_resources));\r\nif (IS_ERR(iris_device)) {\r\nprintk(KERN_ERR "Failed to register iris platform device\n");\r\nplatform_driver_unregister(&iris_driver);\r\nreturn PTR_ERR(iris_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void iris_exit(void)\r\n{\r\nplatform_device_unregister(iris_device);\r\nplatform_driver_unregister(&iris_driver);\r\n}

static int fintek_8250_enter_key(void){\r\nif (!request_muxed_region(ADDR_PORT, 2, DRIVER_NAME))\r\nreturn -EBUSY;\r\noutb(ENTRY_KEY, ADDR_PORT);\r\noutb(ENTRY_KEY, ADDR_PORT);\r\nreturn 0;\r\n}\r\nstatic void fintek_8250_exit_key(void){\r\noutb(EXIT_KEY, ADDR_PORT);\r\nrelease_region(ADDR_PORT, 2);\r\n}\r\nstatic int fintek_8250_get_index(resource_size_t base_addr)\r\n{\r\nresource_size_t base[] = {0x3f8, 0x2f8, 0x3e8, 0x2e8};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(base); i++)\r\nif (base_addr == base[i])\r\nreturn i;\r\nreturn -ENODEV;\r\n}\r\nstatic int fintek_8250_check_id(void)\r\n{\r\noutb(CHIP_ID1, ADDR_PORT);\r\nif (inb(DATA_PORT) != CHIP_ID1_VAL)\r\nreturn -ENODEV;\r\noutb(CHIP_ID2, ADDR_PORT);\r\nif (inb(DATA_PORT) != CHIP_ID2_VAL)\r\nreturn -ENODEV;\r\noutb(VENDOR_ID1, ADDR_PORT);\r\nif (inb(DATA_PORT) != VENDOR_ID1_VAL)\r\nreturn -ENODEV;\r\noutb(VENDOR_ID2, ADDR_PORT);\r\nif (inb(DATA_PORT) != VENDOR_ID2_VAL)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int fintek_8250_rs485_config(struct uart_port *port,\r\nstruct serial_rs485 *rs485)\r\n{\r\nuint8_t config = 0;\r\nint index = fintek_8250_get_index(port->iobase);\r\nif (index < 0)\r\nreturn -EINVAL;\r\nif (rs485->flags & SER_RS485_ENABLED)\r\nmemset(rs485->padding, 0, sizeof(rs485->padding));\r\nelse\r\nmemset(rs485, 0, sizeof(*rs485));\r\nrs485->flags &= SER_RS485_ENABLED | SER_RS485_RTS_ON_SEND |\r\nSER_RS485_RTS_AFTER_SEND;\r\nif (rs485->delay_rts_before_send) {\r\nrs485->delay_rts_before_send = 1;\r\nconfig |= TXW4C_IRA;\r\n}\r\nif (rs485->delay_rts_after_send) {\r\nrs485->delay_rts_after_send = 1;\r\nconfig |= RXW4C_IRA;\r\n}\r\nif ((!!(rs485->flags & SER_RS485_RTS_ON_SEND)) ==\r\n(!!(rs485->flags & SER_RS485_RTS_AFTER_SEND)))\r\nrs485->flags &= SER_RS485_ENABLED;\r\nelse\r\nconfig |= RS485_URA;\r\nif (rs485->flags & SER_RS485_RTS_ON_SEND)\r\nconfig |= RTS_INVERT;\r\nif (fintek_8250_enter_key())\r\nreturn -EBUSY;\r\noutb(LDN, ADDR_PORT);\r\noutb(index, DATA_PORT);\r\noutb(RS485, ADDR_PORT);\r\noutb(config, DATA_PORT);\r\nfintek_8250_exit_key();\r\nport->rs485 = *rs485;\r\nreturn 0;\r\n}\r\nstatic int\r\nfintek_8250_probe(struct pnp_dev *dev, const struct pnp_device_id *dev_id)\r\n{\r\nint line;\r\nstruct uart_8250_port uart;\r\nint ret;\r\nif (!pnp_port_valid(dev, 0))\r\nreturn -ENODEV;\r\nif (fintek_8250_get_index(pnp_port_start(dev, 0)) < 0)\r\nreturn -ENODEV;\r\nif (fintek_8250_enter_key())\r\nreturn -EBUSY;\r\nret = fintek_8250_check_id();\r\nfintek_8250_exit_key();\r\nif (ret)\r\nreturn ret;\r\nmemset(&uart, 0, sizeof(uart));\r\nif (!pnp_irq_valid(dev, 0))\r\nreturn -ENODEV;\r\nuart.port.irq = pnp_irq(dev, 0);\r\nuart.port.iobase = pnp_port_start(dev, 0);\r\nuart.port.iotype = UPIO_PORT;\r\nuart.port.rs485_config = fintek_8250_rs485_config;\r\nuart.port.flags |= UPF_SKIP_TEST | UPF_BOOT_AUTOCONF;\r\nif (pnp_irq_flags(dev, 0) & IORESOURCE_IRQ_SHAREABLE)\r\nuart.port.flags |= UPF_SHARE_IRQ;\r\nuart.port.uartclk = 1843200;\r\nuart.port.dev = &dev->dev;\r\nline = serial8250_register_8250_port(&uart);\r\nif (line < 0)\r\nreturn -ENODEV;\r\npnp_set_drvdata(dev, (void *)((long)line + 1));\r\nreturn 0;\r\n}\r\nstatic void fintek_8250_remove(struct pnp_dev *dev)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (line)\r\nserial8250_unregister_port(line - 1);\r\n}\r\nstatic int fintek_8250_suspend(struct pnp_dev *dev, pm_message_t state)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (!line)\r\nreturn -ENODEV;\r\nserial8250_suspend_port(line - 1);\r\nreturn 0;\r\n}\r\nstatic int fintek_8250_resume(struct pnp_dev *dev)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (!line)\r\nreturn -ENODEV;\r\nserial8250_resume_port(line - 1);\r\nreturn 0;\r\n}

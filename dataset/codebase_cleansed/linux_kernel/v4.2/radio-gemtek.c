static void gemtek_bu2614_transmit(struct gemtek *gt)\r\n{\r\nstruct radio_isa_card *isa = &gt->isa;\r\nint i, bit, q, mute;\r\nmute = gt->muted ? GEMTEK_MT : 0x00;\r\noutb_p(mute | GEMTEK_CE | GEMTEK_DA | GEMTEK_CK, isa->io);\r\nudelay(LONG_DELAY);\r\nfor (i = 0, q = gt->bu2614data; i < 32; i++, q >>= 1) {\r\nbit = (q & 1) ? GEMTEK_DA : 0;\r\noutb_p(mute | GEMTEK_CE | bit, isa->io);\r\nudelay(SHORT_DELAY);\r\noutb_p(mute | GEMTEK_CE | bit | GEMTEK_CK, isa->io);\r\nudelay(SHORT_DELAY);\r\n}\r\noutb_p(mute | GEMTEK_DA | GEMTEK_CK, isa->io);\r\nudelay(SHORT_DELAY);\r\n}\r\nstatic unsigned long gemtek_convfreq(unsigned long freq)\r\n{\r\nreturn ((freq << FSCALE) + IF_OFFSET + REF_FREQ / 2) / REF_FREQ;\r\n}\r\nstatic struct radio_isa_card *gemtek_alloc(void)\r\n{\r\nstruct gemtek *gt = kzalloc(sizeof(*gt), GFP_KERNEL);\r\nif (gt)\r\ngt->muted = true;\r\nreturn gt ? &gt->isa : NULL;\r\n}\r\nstatic int gemtek_s_frequency(struct radio_isa_card *isa, u32 freq)\r\n{\r\nstruct gemtek *gt = container_of(isa, struct gemtek, isa);\r\nif (hardmute && gt->muted)\r\nreturn 0;\r\ngemtek_bu2614_set(gt, BU2614_PORT, 0);\r\ngemtek_bu2614_set(gt, BU2614_FMES, 0);\r\ngemtek_bu2614_set(gt, BU2614_SWIN, 0);\r\ngemtek_bu2614_set(gt, BU2614_SWAL, 0);\r\ngemtek_bu2614_set(gt, BU2614_FMUN, 1);\r\ngemtek_bu2614_set(gt, BU2614_TEST, 0);\r\ngemtek_bu2614_set(gt, BU2614_STDF, GEMTEK_STDF_3_125_KHZ);\r\ngemtek_bu2614_set(gt, BU2614_FREQ, gemtek_convfreq(freq));\r\ngemtek_bu2614_transmit(gt);\r\nreturn 0;\r\n}\r\nstatic int gemtek_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\r\n{\r\nstruct gemtek *gt = container_of(isa, struct gemtek, isa);\r\nint i;\r\ngt->muted = mute;\r\nif (hardmute) {\r\nif (!mute)\r\nreturn gemtek_s_frequency(isa, isa->freq);\r\ngemtek_bu2614_set(gt, BU2614_PORT, 0);\r\ngemtek_bu2614_set(gt, BU2614_FMES, 0);\r\ngemtek_bu2614_set(gt, BU2614_SWIN, 0);\r\ngemtek_bu2614_set(gt, BU2614_SWAL, 0);\r\ngemtek_bu2614_set(gt, BU2614_FMUN, 0);\r\ngemtek_bu2614_set(gt, BU2614_TEST, 0);\r\ngemtek_bu2614_set(gt, BU2614_STDF, GEMTEK_PLL_OFF);\r\ngemtek_bu2614_set(gt, BU2614_FREQ, 0);\r\ngemtek_bu2614_transmit(gt);\r\nreturn 0;\r\n}\r\ni = inb_p(isa->io);\r\noutb_p((i >> 5) | (mute ? GEMTEK_MT : 0), isa->io);\r\nudelay(SHORT_DELAY);\r\nreturn 0;\r\n}\r\nstatic u32 gemtek_g_rxsubchans(struct radio_isa_card *isa)\r\n{\r\nif (inb_p(isa->io) & GEMTEK_NS)\r\nreturn V4L2_TUNER_SUB_MONO;\r\nreturn V4L2_TUNER_SUB_STEREO;\r\n}\r\nstatic bool gemtek_probe(struct radio_isa_card *isa, int io)\r\n{\r\nint i, q;\r\nq = inb_p(io);\r\nfor (i = 0; i < 3; ++i) {\r\noutb_p(1 << i, io);\r\nudelay(SHORT_DELAY);\r\nif ((inb_p(io) & ~GEMTEK_NS) != (0x17 | (1 << (i + 5))))\r\nreturn false;\r\n}\r\noutb_p(q >> 5, io);\r\nudelay(SHORT_DELAY);\r\nreturn true;\r\n}\r\nstatic int __init gemtek_init(void)\r\n{\r\ngemtek_driver.probe = probe;\r\n#ifdef CONFIG_PNP\r\npnp_register_driver(&gemtek_driver.pnp_driver);\r\n#endif\r\nreturn isa_register_driver(&gemtek_driver.driver, GEMTEK_MAX);\r\n}\r\nstatic void __exit gemtek_exit(void)\r\n{\r\nhardmute = true;\r\n#ifdef CONFIG_PNP\r\npnp_unregister_driver(&gemtek_driver.pnp_driver);\r\n#endif\r\nisa_unregister_driver(&gemtek_driver.driver);\r\n}

static int list_scripts(char *script_name)\r\n{\r\nchar *buf, *names[SCRIPT_MAX_NO], *paths[SCRIPT_MAX_NO];\r\nint i, num, choice, ret = -1;\r\nbuf = malloc(SCRIPT_MAX_NO * (SCRIPT_NAMELEN + SCRIPT_FULLPATH_LEN));\r\nif (!buf)\r\nreturn ret;\r\nfor (i = 0; i < SCRIPT_MAX_NO; i++) {\r\nnames[i] = buf + i * (SCRIPT_NAMELEN + SCRIPT_FULLPATH_LEN);\r\npaths[i] = names[i] + SCRIPT_NAMELEN;\r\n}\r\nnum = find_scripts(names, paths);\r\nif (num > 0) {\r\nchoice = ui__popup_menu(num, names);\r\nif (choice < num && choice >= 0) {\r\nstrcpy(script_name, paths[choice]);\r\nret = 0;\r\n}\r\n}\r\nfree(buf);\r\nreturn ret;\r\n}\r\nstatic void script_browser__write(struct ui_browser *browser,\r\nvoid *entry, int row)\r\n{\r\nstruct script_line *sline = list_entry(entry, struct script_line, node);\r\nbool current_entry = ui_browser__is_current_entry(browser, row);\r\nui_browser__set_color(browser, current_entry ? HE_COLORSET_SELECTED :\r\nHE_COLORSET_NORMAL);\r\nslsmg_write_nstring(sline->line, browser->width);\r\n}\r\nstatic int script_browser__run(struct perf_script_browser *browser)\r\n{\r\nint key;\r\nif (ui_browser__show(&browser->b, browser->script_name,\r\n"Press <- or ESC to exit") < 0)\r\nreturn -1;\r\nwhile (1) {\r\nkey = ui_browser__run(&browser->b, 0);\r\nbreak;\r\n}\r\nui_browser__hide(&browser->b);\r\nreturn key;\r\n}\r\nint script_browse(const char *script_opt)\r\n{\r\nchar cmd[SCRIPT_FULLPATH_LEN*2], script_name[SCRIPT_FULLPATH_LEN];\r\nchar *line = NULL;\r\nsize_t len = 0;\r\nssize_t retlen;\r\nint ret = -1, nr_entries = 0;\r\nFILE *fp;\r\nvoid *buf;\r\nstruct script_line *sline;\r\nstruct perf_script_browser script = {\r\n.b = {\r\n.refresh = ui_browser__list_head_refresh,\r\n.seek = ui_browser__list_head_seek,\r\n.write = script_browser__write,\r\n},\r\n.script_name = script_name,\r\n};\r\nINIT_LIST_HEAD(&script.entries);\r\nbuf = zalloc((sizeof(*sline)) * MAX_LINES);\r\nif (!buf)\r\nreturn -1;\r\nsline = buf;\r\nmemset(script_name, 0, SCRIPT_FULLPATH_LEN);\r\nif (list_scripts(script_name))\r\ngoto exit;\r\nsprintf(cmd, "perf script -s %s ", script_name);\r\nif (script_opt)\r\nstrcat(cmd, script_opt);\r\nif (input_name) {\r\nstrcat(cmd, " -i ");\r\nstrcat(cmd, input_name);\r\n}\r\nstrcat(cmd, " 2>&1");\r\nfp = popen(cmd, "r");\r\nif (!fp)\r\ngoto exit;\r\nwhile ((retlen = getline(&line, &len, fp)) != -1) {\r\nstrncpy(sline->line, line, AVERAGE_LINE_LEN);\r\nif (retlen >= AVERAGE_LINE_LEN) {\r\nsline->line[AVERAGE_LINE_LEN - 1] = '\0';\r\nsline->line[AVERAGE_LINE_LEN - 2] = '\n';\r\n}\r\nlist_add_tail(&sline->node, &script.entries);\r\nif (script.b.width < retlen)\r\nscript.b.width = retlen;\r\nif (nr_entries++ >= MAX_LINES - 1)\r\nbreak;\r\nsline++;\r\n}\r\nif (script.b.width > AVERAGE_LINE_LEN)\r\nscript.b.width = AVERAGE_LINE_LEN;\r\nfree(line);\r\npclose(fp);\r\nscript.nr_lines = nr_entries;\r\nscript.b.nr_entries = nr_entries;\r\nscript.b.entries = &script.entries;\r\nret = script_browser__run(&script);\r\nexit:\r\nfree(buf);\r\nreturn ret;\r\n}

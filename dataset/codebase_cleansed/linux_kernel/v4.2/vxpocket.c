static void vxpocket_release(struct pcmcia_device *link)\r\n{\r\nfree_irq(link->irq, link->priv);\r\npcmcia_disable_device(link);\r\n}\r\nstatic int snd_vxpocket_dev_free(struct snd_device *device)\r\n{\r\nstruct vx_core *chip = device->device_data;\r\nsnd_vx_free_firmware(chip);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_vxpocket_new(struct snd_card *card, int ibl,\r\nstruct pcmcia_device *link,\r\nstruct snd_vxpocket **chip_ret)\r\n{\r\nstruct vx_core *chip;\r\nstruct snd_vxpocket *vxp;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_vxpocket_dev_free,\r\n};\r\nint err;\r\nchip = snd_vx_create(card, &vxpocket_hw, &snd_vxpocket_ops,\r\nsizeof(struct snd_vxpocket) - sizeof(struct vx_core));\r\nif (!chip)\r\nreturn -ENOMEM;\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops);\r\nif (err < 0) {\r\nkfree(chip);\r\nreturn err;\r\n}\r\nchip->ibl.size = ibl;\r\nvxp = (struct snd_vxpocket *)chip;\r\nvxp->p_dev = link;\r\nlink->priv = chip;\r\nlink->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\r\nlink->resource[0]->end = 16;\r\nlink->config_flags |= CONF_ENABLE_IRQ;\r\nlink->config_index = 1;\r\nlink->config_regs = PRESENT_OPTION;\r\n*chip_ret = vxp;\r\nreturn 0;\r\n}\r\nstatic int snd_vxpocket_assign_resources(struct vx_core *chip, int port, int irq)\r\n{\r\nint err;\r\nstruct snd_card *card = chip->card;\r\nstruct snd_vxpocket *vxp = (struct snd_vxpocket *)chip;\r\nsnd_printdd(KERN_DEBUG "vxpocket assign resources: port = 0x%x, irq = %d\n", port, irq);\r\nvxp->port = port;\r\nsprintf(card->shortname, "Digigram %s", card->driver);\r\nsprintf(card->longname, "%s at 0x%x, irq %i",\r\ncard->shortname, port, irq);\r\nchip->irq = irq;\r\nif ((err = snd_vx_setup_firmware(chip)) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int vxpocket_config(struct pcmcia_device *link)\r\n{\r\nstruct vx_core *chip = link->priv;\r\nint ret;\r\nsnd_printdd(KERN_DEBUG "vxpocket_config called\n");\r\nif (!strcmp(link->prod_id[1], "VX-POCKET")) {\r\nsnd_printdd("VX-pocket is detected\n");\r\n} else {\r\nsnd_printdd("VX-pocket 440 is detected\n");\r\nchip->hw = &vxp440_hw;\r\nchip->type = vxp440_hw.type;\r\nstrcpy(chip->card->driver, vxp440_hw.name);\r\n}\r\nret = pcmcia_request_io(link);\r\nif (ret)\r\ngoto failed_preirq;\r\nret = request_threaded_irq(link->irq, snd_vx_irq_handler,\r\nsnd_vx_threaded_irq_handler,\r\nIRQF_SHARED, link->devname, link->priv);\r\nif (ret)\r\ngoto failed_preirq;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nchip->dev = &link->dev;\r\nif (snd_vxpocket_assign_resources(chip, link->resource[0]->start,\r\nlink->irq) < 0)\r\ngoto failed;\r\nreturn 0;\r\nfailed:\r\nfree_irq(link->irq, link->priv);\r\nfailed_preirq:\r\npcmcia_disable_device(link);\r\nreturn -ENODEV;\r\n}\r\nstatic int vxp_suspend(struct pcmcia_device *link)\r\n{\r\nstruct vx_core *chip = link->priv;\r\nsnd_printdd(KERN_DEBUG "SUSPEND\n");\r\nif (chip) {\r\nsnd_printdd(KERN_DEBUG "snd_vx_suspend calling\n");\r\nsnd_vx_suspend(chip);\r\n}\r\nreturn 0;\r\n}\r\nstatic int vxp_resume(struct pcmcia_device *link)\r\n{\r\nstruct vx_core *chip = link->priv;\r\nsnd_printdd(KERN_DEBUG "RESUME\n");\r\nif (pcmcia_dev_present(link)) {\r\nif (chip) {\r\nsnd_printdd(KERN_DEBUG "calling snd_vx_resume\n");\r\nsnd_vx_resume(chip);\r\n}\r\n}\r\nsnd_printdd(KERN_DEBUG "resume done!\n");\r\nreturn 0;\r\n}\r\nstatic int vxpocket_probe(struct pcmcia_device *p_dev)\r\n{\r\nstruct snd_card *card;\r\nstruct snd_vxpocket *vxp;\r\nint i, err;\r\nfor (i = 0; i < SNDRV_CARDS; i++) {\r\nif (!(card_alloc & (1 << i)))\r\nbreak;\r\n}\r\nif (i >= SNDRV_CARDS) {\r\nsnd_printk(KERN_ERR "vxpocket: too many cards found\n");\r\nreturn -EINVAL;\r\n}\r\nif (! enable[i])\r\nreturn -ENODEV;\r\nerr = snd_card_new(&p_dev->dev, index[i], id[i], THIS_MODULE,\r\n0, &card);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "vxpocket: cannot create a card instance\n");\r\nreturn err;\r\n}\r\nerr = snd_vxpocket_new(card, ibl[i], p_dev, &vxp);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\ncard->private_data = vxp;\r\nvxp->index = i;\r\ncard_alloc |= 1 << i;\r\nvxp->p_dev = p_dev;\r\nreturn vxpocket_config(p_dev);\r\n}\r\nstatic void vxpocket_detach(struct pcmcia_device *link)\r\n{\r\nstruct snd_vxpocket *vxp;\r\nstruct vx_core *chip;\r\nif (! link)\r\nreturn;\r\nvxp = link->priv;\r\nchip = (struct vx_core *)vxp;\r\ncard_alloc &= ~(1 << vxp->index);\r\nchip->chip_status |= VX_STAT_IS_STALE;\r\nsnd_card_disconnect(chip->card);\r\nvxpocket_release(link);\r\nsnd_card_free_when_closed(chip->card);\r\n}

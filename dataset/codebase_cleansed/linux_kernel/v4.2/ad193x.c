static int ad193x_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(dai->codec);\r\nif (mute)\r\nregmap_update_bits(ad193x->regmap, AD193X_DAC_CTRL2,\r\nAD193X_DAC_MASTER_MUTE,\r\nAD193X_DAC_MASTER_MUTE);\r\nelse\r\nregmap_update_bits(ad193x->regmap, AD193X_DAC_CTRL2,\r\nAD193X_DAC_MASTER_MUTE, 0);\r\nreturn 0;\r\n}\r\nstatic int ad193x_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\r\nunsigned int rx_mask, int slots, int width)\r\n{\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(dai->codec);\r\nunsigned int channels;\r\nswitch (slots) {\r\ncase 2:\r\nchannels = AD193X_2_CHANNELS;\r\nbreak;\r\ncase 4:\r\nchannels = AD193X_4_CHANNELS;\r\nbreak;\r\ncase 8:\r\nchannels = AD193X_8_CHANNELS;\r\nbreak;\r\ncase 16:\r\nchannels = AD193X_16_CHANNELS;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(ad193x->regmap, AD193X_DAC_CTRL1,\r\nAD193X_DAC_CHAN_MASK, channels << AD193X_DAC_CHAN_SHFT);\r\nregmap_update_bits(ad193x->regmap, AD193X_ADC_CTRL2,\r\nAD193X_ADC_CHAN_MASK, channels << AD193X_ADC_CHAN_SHFT);\r\nreturn 0;\r\n}\r\nstatic int ad193x_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int fmt)\r\n{\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(codec_dai->codec);\r\nunsigned int adc_serfmt = 0;\r\nunsigned int adc_fmt = 0;\r\nunsigned int dac_fmt = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nadc_serfmt |= AD193X_ADC_SERFMT_TDM;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nadc_serfmt |= AD193X_ADC_SERFMT_AUX;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\nadc_fmt |= AD193X_ADC_LEFT_HIGH;\r\ndac_fmt |= AD193X_DAC_LEFT_HIGH;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nadc_fmt |= AD193X_ADC_BCLK_INV;\r\ndac_fmt |= AD193X_DAC_BCLK_INV;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\nadc_fmt |= AD193X_ADC_LEFT_HIGH;\r\nadc_fmt |= AD193X_ADC_BCLK_INV;\r\ndac_fmt |= AD193X_DAC_LEFT_HIGH;\r\ndac_fmt |= AD193X_DAC_BCLK_INV;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nadc_fmt |= AD193X_ADC_LCR_MASTER;\r\nadc_fmt |= AD193X_ADC_BCLK_MASTER;\r\ndac_fmt |= AD193X_DAC_LCR_MASTER;\r\ndac_fmt |= AD193X_DAC_BCLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nadc_fmt |= AD193X_ADC_LCR_MASTER;\r\ndac_fmt |= AD193X_DAC_LCR_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nadc_fmt |= AD193X_ADC_BCLK_MASTER;\r\ndac_fmt |= AD193X_DAC_BCLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(ad193x->regmap, AD193X_ADC_CTRL1,\r\nAD193X_ADC_SERFMT_MASK, adc_serfmt);\r\nregmap_update_bits(ad193x->regmap, AD193X_ADC_CTRL2,\r\nAD193X_ADC_FMT_MASK, adc_fmt);\r\nregmap_update_bits(ad193x->regmap, AD193X_DAC_CTRL1,\r\nAD193X_DAC_FMT_MASK, dac_fmt);\r\nreturn 0;\r\n}\r\nstatic int ad193x_set_dai_sysclk(struct snd_soc_dai *codec_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(codec);\r\nswitch (freq) {\r\ncase 12288000:\r\ncase 18432000:\r\ncase 24576000:\r\ncase 36864000:\r\nad193x->sysclk = freq;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ad193x_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nint word_len = 0, master_rate = 0;\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(codec);\r\nswitch (params_width(params)) {\r\ncase 16:\r\nword_len = 3;\r\nbreak;\r\ncase 20:\r\nword_len = 1;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nword_len = 0;\r\nbreak;\r\n}\r\nswitch (ad193x->sysclk) {\r\ncase 12288000:\r\nmaster_rate = AD193X_PLL_INPUT_256;\r\nbreak;\r\ncase 18432000:\r\nmaster_rate = AD193X_PLL_INPUT_384;\r\nbreak;\r\ncase 24576000:\r\nmaster_rate = AD193X_PLL_INPUT_512;\r\nbreak;\r\ncase 36864000:\r\nmaster_rate = AD193X_PLL_INPUT_768;\r\nbreak;\r\n}\r\nregmap_update_bits(ad193x->regmap, AD193X_PLL_CLK_CTRL0,\r\nAD193X_PLL_INPUT_MASK, master_rate);\r\nregmap_update_bits(ad193x->regmap, AD193X_DAC_CTRL2,\r\nAD193X_DAC_WORD_LEN_MASK,\r\nword_len << AD193X_DAC_WORD_LEN_SHFT);\r\nregmap_update_bits(ad193x->regmap, AD193X_ADC_CTRL1,\r\nAD193X_ADC_WORD_LEN_MASK, word_len);\r\nreturn 0;\r\n}\r\nstatic int ad193x_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct ad193x_priv *ad193x = snd_soc_codec_get_drvdata(codec);\r\nregmap_write(ad193x->regmap, AD193X_DAC_CHNL_MUTE, 0x0);\r\nregmap_write(ad193x->regmap, AD193X_DAC_CTRL2, 0x1A);\r\nregmap_write(ad193x->regmap, AD193X_DAC_CTRL0, 0x40);\r\nregmap_write(ad193x->regmap, AD193X_ADC_CTRL0, 0x3);\r\nregmap_write(ad193x->regmap, AD193X_ADC_CTRL1, 0x43);\r\nregmap_write(ad193x->regmap, AD193X_PLL_CLK_CTRL0, 0x99);\r\nregmap_write(ad193x->regmap, AD193X_PLL_CLK_CTRL1, 0x04);\r\nreturn 0;\r\n}\r\nstatic bool adau193x_reg_volatile(struct device *dev, unsigned int reg)\r\n{\r\nreturn false;\r\n}\r\nint ad193x_probe(struct device *dev, struct regmap *regmap)\r\n{\r\nstruct ad193x_priv *ad193x;\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nad193x = devm_kzalloc(dev, sizeof(*ad193x), GFP_KERNEL);\r\nif (ad193x == NULL)\r\nreturn -ENOMEM;\r\nad193x->regmap = regmap;\r\ndev_set_drvdata(dev, ad193x);\r\nreturn snd_soc_register_codec(dev, &soc_codec_dev_ad193x,\r\n&ad193x_dai, 1);\r\n}

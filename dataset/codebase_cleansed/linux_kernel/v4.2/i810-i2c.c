static void i810i2c_setscl(void *data, int state)\r\n{\r\nstruct i810fb_i2c_chan *chan = data;\r\nstruct i810fb_par *par = chan->par;\r\nu8 __iomem *mmio = par->mmio_start_virtual;\r\nif (state)\r\ni810_writel(mmio, chan->ddc_base, SCL_DIR_MASK | SCL_VAL_MASK);\r\nelse\r\ni810_writel(mmio, chan->ddc_base, SCL_DIR | SCL_DIR_MASK | SCL_VAL_MASK);\r\ni810_readl(mmio, chan->ddc_base);\r\n}\r\nstatic void i810i2c_setsda(void *data, int state)\r\n{\r\nstruct i810fb_i2c_chan *chan = data;\r\nstruct i810fb_par *par = chan->par;\r\nu8 __iomem *mmio = par->mmio_start_virtual;\r\nif (state)\r\ni810_writel(mmio, chan->ddc_base, SDA_DIR_MASK | SDA_VAL_MASK);\r\nelse\r\ni810_writel(mmio, chan->ddc_base, SDA_DIR | SDA_DIR_MASK | SDA_VAL_MASK);\r\ni810_readl(mmio, chan->ddc_base);\r\n}\r\nstatic int i810i2c_getscl(void *data)\r\n{\r\nstruct i810fb_i2c_chan *chan = data;\r\nstruct i810fb_par *par = chan->par;\r\nu8 __iomem *mmio = par->mmio_start_virtual;\r\ni810_writel(mmio, chan->ddc_base, SCL_DIR_MASK);\r\ni810_writel(mmio, chan->ddc_base, 0);\r\nreturn ((i810_readl(mmio, chan->ddc_base) & SCL_VAL_IN) != 0);\r\n}\r\nstatic int i810i2c_getsda(void *data)\r\n{\r\nstruct i810fb_i2c_chan *chan = data;\r\nstruct i810fb_par *par = chan->par;\r\nu8 __iomem *mmio = par->mmio_start_virtual;\r\ni810_writel(mmio, chan->ddc_base, SDA_DIR_MASK);\r\ni810_writel(mmio, chan->ddc_base, 0);\r\nreturn ((i810_readl(mmio, chan->ddc_base) & SDA_VAL_IN) != 0);\r\n}\r\nstatic int i810_setup_i2c_bus(struct i810fb_i2c_chan *chan, const char *name)\r\n{\r\nint rc;\r\nstrcpy(chan->adapter.name, name);\r\nchan->adapter.owner = THIS_MODULE;\r\nchan->adapter.algo_data = &chan->algo;\r\nchan->adapter.dev.parent = &chan->par->dev->dev;\r\nchan->algo.setsda = i810i2c_setsda;\r\nchan->algo.setscl = i810i2c_setscl;\r\nchan->algo.getsda = i810i2c_getsda;\r\nchan->algo.getscl = i810i2c_getscl;\r\nchan->algo.udelay = 10;\r\nchan->algo.timeout = (HZ/2);\r\nchan->algo.data = chan;\r\ni2c_set_adapdata(&chan->adapter, chan);\r\nchan->algo.setsda(chan, 1);\r\nchan->algo.setscl(chan, 1);\r\nudelay(20);\r\nrc = i2c_bit_add_bus(&chan->adapter);\r\nif (rc == 0)\r\ndev_dbg(&chan->par->dev->dev, "I2C bus %s registered.\n",name);\r\nelse {\r\ndev_warn(&chan->par->dev->dev, "Failed to register I2C bus "\r\n"%s.\n", name);\r\nchan->par = NULL;\r\n}\r\nreturn rc;\r\n}\r\nvoid i810_create_i2c_busses(struct i810fb_par *par)\r\n{\r\npar->chan[0].par = par;\r\npar->chan[1].par = par;\r\npar->chan[2].par = par;\r\npar->chan[0].ddc_base = GPIOA;\r\ni810_setup_i2c_bus(&par->chan[0], "I810-DDC");\r\npar->chan[1].ddc_base = GPIOB;\r\ni810_setup_i2c_bus(&par->chan[1], "I810-I2C");\r\npar->chan[2].ddc_base = GPIOC;\r\ni810_setup_i2c_bus(&par->chan[2], "I810-GPIOC");\r\n}\r\nvoid i810_delete_i2c_busses(struct i810fb_par *par)\r\n{\r\nif (par->chan[0].par)\r\ni2c_del_adapter(&par->chan[0].adapter);\r\npar->chan[0].par = NULL;\r\nif (par->chan[1].par)\r\ni2c_del_adapter(&par->chan[1].adapter);\r\npar->chan[1].par = NULL;\r\nif (par->chan[2].par)\r\ni2c_del_adapter(&par->chan[2].adapter);\r\npar->chan[2].par = NULL;\r\n}\r\nint i810_probe_i2c_connector(struct fb_info *info, u8 **out_edid, int conn)\r\n{\r\nstruct i810fb_par *par = info->par;\r\nu8 *edid = NULL;\r\nDPRINTK("i810-i2c: Probe DDC%i Bus\n", conn+1);\r\nif (conn < par->ddc_num) {\r\nedid = fb_ddc_read(&par->chan[conn].adapter);\r\n} else {\r\nconst u8 *e = fb_firmware_edid(info->device);\r\nif (e != NULL) {\r\nDPRINTK("i810-i2c: Getting EDID from BIOS\n");\r\nedid = kmemdup(e, EDID_LENGTH, GFP_KERNEL);\r\n}\r\n}\r\n*out_edid = edid;\r\nreturn (edid) ? 0 : 1;\r\n}

static void pkcs7_free_signed_info(struct pkcs7_signed_info *sinfo)\r\n{\r\nif (sinfo) {\r\nmpi_free(sinfo->sig.mpi[0]);\r\nkfree(sinfo->sig.digest);\r\nkfree(sinfo->signing_cert_id);\r\nkfree(sinfo);\r\n}\r\n}\r\nvoid pkcs7_free_message(struct pkcs7_message *pkcs7)\r\n{\r\nstruct x509_certificate *cert;\r\nstruct pkcs7_signed_info *sinfo;\r\nif (pkcs7) {\r\nwhile (pkcs7->certs) {\r\ncert = pkcs7->certs;\r\npkcs7->certs = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\nwhile (pkcs7->crl) {\r\ncert = pkcs7->crl;\r\npkcs7->crl = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\nwhile (pkcs7->signed_infos) {\r\nsinfo = pkcs7->signed_infos;\r\npkcs7->signed_infos = sinfo->next;\r\npkcs7_free_signed_info(sinfo);\r\n}\r\nkfree(pkcs7);\r\n}\r\n}\r\nstruct pkcs7_message *pkcs7_parse_message(const void *data, size_t datalen)\r\n{\r\nstruct pkcs7_parse_context *ctx;\r\nstruct pkcs7_message *msg = ERR_PTR(-ENOMEM);\r\nint ret;\r\nctx = kzalloc(sizeof(struct pkcs7_parse_context), GFP_KERNEL);\r\nif (!ctx)\r\ngoto out_no_ctx;\r\nctx->msg = kzalloc(sizeof(struct pkcs7_message), GFP_KERNEL);\r\nif (!ctx->msg)\r\ngoto out_no_msg;\r\nctx->sinfo = kzalloc(sizeof(struct pkcs7_signed_info), GFP_KERNEL);\r\nif (!ctx->sinfo)\r\ngoto out_no_sinfo;\r\nctx->data = (unsigned long)data;\r\nctx->ppcerts = &ctx->certs;\r\nctx->ppsinfo = &ctx->msg->signed_infos;\r\nret = asn1_ber_decoder(&pkcs7_decoder, ctx, data, datalen);\r\nif (ret < 0) {\r\nmsg = ERR_PTR(ret);\r\ngoto out;\r\n}\r\nmsg = ctx->msg;\r\nctx->msg = NULL;\r\nout:\r\nwhile (ctx->certs) {\r\nstruct x509_certificate *cert = ctx->certs;\r\nctx->certs = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\npkcs7_free_signed_info(ctx->sinfo);\r\nout_no_sinfo:\r\npkcs7_free_message(ctx->msg);\r\nout_no_msg:\r\nkfree(ctx);\r\nout_no_ctx:\r\nreturn msg;\r\n}\r\nint pkcs7_get_content_data(const struct pkcs7_message *pkcs7,\r\nconst void **_data, size_t *_data_len,\r\nbool want_wrapper)\r\n{\r\nsize_t wrapper;\r\nif (!pkcs7->data)\r\nreturn -ENODATA;\r\nwrapper = want_wrapper ? pkcs7->data_hdrlen : 0;\r\n*_data = pkcs7->data - wrapper;\r\n*_data_len = pkcs7->data_len + wrapper;\r\nreturn 0;\r\n}\r\nint pkcs7_note_OID(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->last_oid = look_up_OID(value, vlen);\r\nif (ctx->last_oid == OID__NR) {\r\nchar buffer[50];\r\nsprint_oid(value, vlen, buffer, sizeof(buffer));\r\nprintk("PKCS7: Unknown OID: [%lu] %s\n",\r\n(unsigned long)value - ctx->data, buffer);\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_digest_algo(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nswitch (ctx->last_oid) {\r\ncase OID_md4:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_MD4;\r\nbreak;\r\ncase OID_md5:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_MD5;\r\nbreak;\r\ncase OID_sha1:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA1;\r\nbreak;\r\ncase OID_sha256:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA256;\r\nbreak;\r\ndefault:\r\nprintk("Unsupported digest algo: %u\n", ctx->last_oid);\r\nreturn -ENOPKG;\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_pkey_algo(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nswitch (ctx->last_oid) {\r\ncase OID_rsaEncryption:\r\nctx->sinfo->sig.pkey_algo = PKEY_ALGO_RSA;\r\nbreak;\r\ndefault:\r\nprintk("Unsupported pkey algo: %u\n", ctx->last_oid);\r\nreturn -ENOPKG;\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_extract_cert(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct x509_certificate *x509;\r\nif (tag != ((ASN1_UNIV << 6) | ASN1_CONS_BIT | ASN1_SEQ)) {\r\npr_debug("Cert began with tag %02x at %lu\n",\r\ntag, (unsigned long)ctx - ctx->data);\r\nreturn -EBADMSG;\r\n}\r\nvalue -= hdrlen;\r\nvlen += hdrlen;\r\nif (((u8*)value)[1] == 0x80)\r\nvlen += 2;\r\nx509 = x509_cert_parse(value, vlen);\r\nif (IS_ERR(x509))\r\nreturn PTR_ERR(x509);\r\nx509->index = ++ctx->x509_index;\r\npr_debug("Got cert %u for %s\n", x509->index, x509->subject);\r\npr_debug("- fingerprint %*phN\n", x509->id->len, x509->id->data);\r\n*ctx->ppcerts = x509;\r\nctx->ppcerts = &x509->next;\r\nreturn 0;\r\n}\r\nint pkcs7_note_certificate_list(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_devel("Got cert list (%02x)\n", tag);\r\n*ctx->ppcerts = ctx->msg->certs;\r\nctx->msg->certs = ctx->certs;\r\nctx->certs = NULL;\r\nctx->ppcerts = &ctx->certs;\r\nreturn 0;\r\n}\r\nint pkcs7_note_data(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_debug("Got data\n");\r\nctx->msg->data = value;\r\nctx->msg->data_len = vlen;\r\nctx->msg->data_hdrlen = hdrlen;\r\nctx->msg->data_type = ctx->last_oid;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_authenticated_attr(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_devel("AuthAttr: %02x %zu [%*ph]\n", tag, vlen, (unsigned)vlen, value);\r\nswitch (ctx->last_oid) {\r\ncase OID_messageDigest:\r\nif (tag != ASN1_OTS)\r\nreturn -EBADMSG;\r\nctx->sinfo->msgdigest = value;\r\nctx->sinfo->msgdigest_len = vlen;\r\nreturn 0;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nint pkcs7_sig_note_set_of_authattrs(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->sinfo->authattrs = value - (hdrlen - 1);\r\nctx->sinfo->authattrs_len = vlen + (hdrlen - 1);\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_serial(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->raw_serial = value;\r\nctx->raw_serial_size = vlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_issuer(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->raw_issuer = value;\r\nctx->raw_issuer_size = vlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_signature(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nMPI mpi;\r\nBUG_ON(ctx->sinfo->sig.pkey_algo != PKEY_ALGO_RSA);\r\nmpi = mpi_read_raw_data(value, vlen);\r\nif (!mpi)\r\nreturn -ENOMEM;\r\nctx->sinfo->sig.mpi[0] = mpi;\r\nctx->sinfo->sig.nr_mpi = 1;\r\nreturn 0;\r\n}\r\nint pkcs7_note_signed_info(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct pkcs7_signed_info *sinfo = ctx->sinfo;\r\nstruct asymmetric_key_id *kid;\r\nkid = asymmetric_key_generate_id(ctx->raw_serial,\r\nctx->raw_serial_size,\r\nctx->raw_issuer,\r\nctx->raw_issuer_size);\r\nif (IS_ERR(kid))\r\nreturn PTR_ERR(kid);\r\nsinfo->signing_cert_id = kid;\r\nsinfo->index = ++ctx->sinfo_index;\r\n*ctx->ppsinfo = sinfo;\r\nctx->ppsinfo = &sinfo->next;\r\nctx->sinfo = kzalloc(sizeof(struct pkcs7_signed_info), GFP_KERNEL);\r\nif (!ctx->sinfo)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

static void doublefault_fn(void)\r\n{\r\nstruct desc_ptr gdt_desc = {0, 0};\r\nunsigned long gdt, tss;\r\nnative_store_gdt(&gdt_desc);\r\ngdt = gdt_desc.address;\r\nprintk(KERN_EMERG "PANIC: double fault, gdt at %08lx [%d bytes]\n", gdt, gdt_desc.size);\r\nif (ptr_ok(gdt)) {\r\ngdt += GDT_ENTRY_TSS << 3;\r\ntss = get_desc_base((struct desc_struct *)gdt);\r\nprintk(KERN_EMERG "double fault, tss at %08lx\n", tss);\r\nif (ptr_ok(tss)) {\r\nstruct x86_hw_tss *t = (struct x86_hw_tss *)tss;\r\nprintk(KERN_EMERG "eip = %08lx, esp = %08lx\n",\r\nt->ip, t->sp);\r\nprintk(KERN_EMERG "eax = %08lx, ebx = %08lx, ecx = %08lx, edx = %08lx\n",\r\nt->ax, t->bx, t->cx, t->dx);\r\nprintk(KERN_EMERG "esi = %08lx, edi = %08lx\n",\r\nt->si, t->di);\r\n}\r\n}\r\nfor (;;)\r\ncpu_relax();\r\n}\r\nvoid df_debug(struct pt_regs *regs, long error_code) {}\r\nvoid df_debug(struct pt_regs *regs, long error_code)\r\n{\r\npr_emerg("PANIC: double fault, error_code: 0x%lx\n", error_code);\r\nshow_regs(regs);\r\npanic("Machine halted.");\r\n}

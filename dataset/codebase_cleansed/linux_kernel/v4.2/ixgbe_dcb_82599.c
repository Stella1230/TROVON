s32 ixgbe_dcb_config_rx_arbiter_82599(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *bwg_id,\r\nu8 *prio_type,\r\nu8 *prio_tc)\r\n{\r\nu32 reg = 0;\r\nu32 credit_refill = 0;\r\nu32 credit_max = 0;\r\nu8 i = 0;\r\nreg = IXGBE_RTRPCS_RRM | IXGBE_RTRPCS_RAC | IXGBE_RTRPCS_ARBDIS;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTRPCS, reg);\r\nreg = 0;\r\nfor (i = 0; i < MAX_USER_PRIORITY; i++)\r\nreg |= (prio_tc[i] << (i * IXGBE_RTRUP2TC_UP_SHIFT));\r\nIXGBE_WRITE_REG(hw, IXGBE_RTRUP2TC, reg);\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\ncredit_refill = refill[i];\r\ncredit_max = max[i];\r\nreg = credit_refill | (credit_max << IXGBE_RTRPT4C_MCL_SHIFT);\r\nreg |= (u32)(bwg_id[i]) << IXGBE_RTRPT4C_BWG_SHIFT;\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_RTRPT4C_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTRPT4C(i), reg);\r\n}\r\nreg = IXGBE_RTRPCS_RRM | IXGBE_RTRPCS_RAC;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTRPCS, reg);\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_tx_desc_arbiter_82599(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *bwg_id,\r\nu8 *prio_type)\r\n{\r\nu32 reg, max_credits;\r\nu8 i;\r\nfor (i = 0; i < 128; i++) {\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTDQSEL, i);\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTDT1C, 0);\r\n}\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nmax_credits = max[i];\r\nreg = max_credits << IXGBE_RTTDT2C_MCL_SHIFT;\r\nreg |= refill[i];\r\nreg |= (u32)(bwg_id[i]) << IXGBE_RTTDT2C_BWG_SHIFT;\r\nif (prio_type[i] == prio_group)\r\nreg |= IXGBE_RTTDT2C_GSP;\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_RTTDT2C_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTDT2C(i), reg);\r\n}\r\nreg = IXGBE_RTTDCS_TDPAC | IXGBE_RTTDCS_TDRM;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTDCS, reg);\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_tx_data_arbiter_82599(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *bwg_id,\r\nu8 *prio_type,\r\nu8 *prio_tc)\r\n{\r\nu32 reg;\r\nu8 i;\r\nreg = IXGBE_RTTPCS_TPPAC | IXGBE_RTTPCS_TPRM |\r\n(IXGBE_RTTPCS_ARBD_DCB << IXGBE_RTTPCS_ARBD_SHIFT) |\r\nIXGBE_RTTPCS_ARBDIS;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTPCS, reg);\r\nreg = 0;\r\nfor (i = 0; i < MAX_USER_PRIORITY; i++)\r\nreg |= (prio_tc[i] << (i * IXGBE_RTTUP2TC_UP_SHIFT));\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTUP2TC, reg);\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nreg = refill[i];\r\nreg |= (u32)(max[i]) << IXGBE_RTTPT2C_MCL_SHIFT;\r\nreg |= (u32)(bwg_id[i]) << IXGBE_RTTPT2C_BWG_SHIFT;\r\nif (prio_type[i] == prio_group)\r\nreg |= IXGBE_RTTPT2C_GSP;\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_RTTPT2C_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTPT2C(i), reg);\r\n}\r\nreg = IXGBE_RTTPCS_TPPAC | IXGBE_RTTPCS_TPRM |\r\n(IXGBE_RTTPCS_ARBD_DCB << IXGBE_RTTPCS_ARBD_SHIFT);\r\nIXGBE_WRITE_REG(hw, IXGBE_RTTPCS, reg);\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_pfc_82599(struct ixgbe_hw *hw, u8 pfc_en, u8 *prio_tc)\r\n{\r\nu32 i, j, fcrtl, reg;\r\nu8 max_tc = 0;\r\nIXGBE_WRITE_REG(hw, IXGBE_FCCFG, IXGBE_FCCFG_TFCE_PRIORITY);\r\nreg = IXGBE_READ_REG(hw, IXGBE_MFLCN);\r\nreg |= IXGBE_MFLCN_DPF;\r\nreg &= ~(IXGBE_MFLCN_RPFCE_MASK | IXGBE_MFLCN_RFCE);\r\nif (hw->mac.type == ixgbe_mac_X540)\r\nreg |= pfc_en << IXGBE_MFLCN_RPFCE_SHIFT;\r\nif (pfc_en)\r\nreg |= IXGBE_MFLCN_RPFCE;\r\nIXGBE_WRITE_REG(hw, IXGBE_MFLCN, reg);\r\nfor (i = 0; i < MAX_USER_PRIORITY; i++) {\r\nif (prio_tc[i] > max_tc)\r\nmax_tc = prio_tc[i];\r\n}\r\nfor (i = 0; i <= max_tc; i++) {\r\nint enabled = 0;\r\nfor (j = 0; j < MAX_USER_PRIORITY; j++) {\r\nif ((prio_tc[j] == i) && (pfc_en & (1 << j))) {\r\nenabled = 1;\r\nbreak;\r\n}\r\n}\r\nif (enabled) {\r\nreg = (hw->fc.high_water[i] << 10) | IXGBE_FCRTH_FCEN;\r\nfcrtl = (hw->fc.low_water[i] << 10) | IXGBE_FCRTL_XONE;\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTL_82599(i), fcrtl);\r\n} else {\r\nreg = IXGBE_READ_REG(hw, IXGBE_RXPBSIZE(i)) - 32;\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTL_82599(i), 0);\r\n}\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTH_82599(i), reg);\r\n}\r\nfor (; i < MAX_TRAFFIC_CLASS; i++) {\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTL_82599(i), 0);\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTH_82599(i), 0);\r\n}\r\nreg = hw->fc.pause_time * 0x00010001;\r\nfor (i = 0; i < (MAX_TRAFFIC_CLASS / 2); i++)\r\nIXGBE_WRITE_REG(hw, IXGBE_FCTTV(i), reg);\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTV, hw->fc.pause_time / 2);\r\nreturn 0;\r\n}\r\nstatic s32 ixgbe_dcb_config_tc_stats_82599(struct ixgbe_hw *hw)\r\n{\r\nu32 reg = 0;\r\nu8 i = 0;\r\nfor (i = 0; i < 32; i++) {\r\nreg = 0x01010101 * (i / 4);\r\nIXGBE_WRITE_REG(hw, IXGBE_RQSMR(i), reg);\r\n}\r\nfor (i = 0; i < 32; i++) {\r\nif (i < 8)\r\nreg = 0x00000000;\r\nelse if (i < 16)\r\nreg = 0x01010101;\r\nelse if (i < 20)\r\nreg = 0x02020202;\r\nelse if (i < 24)\r\nreg = 0x03030303;\r\nelse if (i < 26)\r\nreg = 0x04040404;\r\nelse if (i < 28)\r\nreg = 0x05050505;\r\nelse if (i < 30)\r\nreg = 0x06060606;\r\nelse\r\nreg = 0x07070707;\r\nIXGBE_WRITE_REG(hw, IXGBE_TQSM(i), reg);\r\n}\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_hw_config_82599(struct ixgbe_hw *hw, u8 pfc_en, u16 *refill,\r\nu16 *max, u8 *bwg_id, u8 *prio_type, u8 *prio_tc)\r\n{\r\nixgbe_dcb_config_rx_arbiter_82599(hw, refill, max, bwg_id,\r\nprio_type, prio_tc);\r\nixgbe_dcb_config_tx_desc_arbiter_82599(hw, refill, max,\r\nbwg_id, prio_type);\r\nixgbe_dcb_config_tx_data_arbiter_82599(hw, refill, max,\r\nbwg_id, prio_type, prio_tc);\r\nixgbe_dcb_config_pfc_82599(hw, pfc_en, prio_tc);\r\nixgbe_dcb_config_tc_stats_82599(hw);\r\nreturn 0;\r\n}

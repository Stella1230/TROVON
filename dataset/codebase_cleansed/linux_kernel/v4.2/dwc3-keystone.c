static inline u32 kdwc3_readl(void __iomem *base, u32 offset)\r\n{\r\nreturn readl(base + offset);\r\n}\r\nstatic inline void kdwc3_writel(void __iomem *base, u32 offset, u32 value)\r\n{\r\nwritel(value, base + offset);\r\n}\r\nstatic void kdwc3_enable_irqs(struct dwc3_keystone *kdwc)\r\n{\r\nu32 val;\r\nval = kdwc3_readl(kdwc->usbss, USBSS_IRQENABLE_SET_0);\r\nval |= USBSS_IRQ_COREIRQ_EN;\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, val);\r\n}\r\nstatic void kdwc3_disable_irqs(struct dwc3_keystone *kdwc)\r\n{\r\nu32 val;\r\nval = kdwc3_readl(kdwc->usbss, USBSS_IRQENABLE_SET_0);\r\nval &= ~USBSS_IRQ_COREIRQ_EN;\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, val);\r\n}\r\nstatic irqreturn_t dwc3_keystone_interrupt(int irq, void *_kdwc)\r\n{\r\nstruct dwc3_keystone *kdwc = _kdwc;\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_CLR_0, USBSS_IRQ_COREIRQ_CLR);\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQSTATUS_0, USBSS_IRQ_EVENT_ST);\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, USBSS_IRQ_COREIRQ_EN);\r\nkdwc3_writel(kdwc->usbss, USBSS_IRQ_EOI, USBSS_IRQ_EOI_LINE(0));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int kdwc3_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct dwc3_keystone *kdwc;\r\nstruct resource *res;\r\nint error, irq;\r\nkdwc = devm_kzalloc(dev, sizeof(*kdwc), GFP_KERNEL);\r\nif (!kdwc)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, kdwc);\r\nkdwc->dev = dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nkdwc->usbss = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(kdwc->usbss))\r\nreturn PTR_ERR(kdwc->usbss);\r\nkdwc3_dma_mask = dma_get_mask(dev);\r\ndev->dma_mask = &kdwc3_dma_mask;\r\nkdwc->clk = devm_clk_get(kdwc->dev, "usb");\r\nerror = clk_prepare_enable(kdwc->clk);\r\nif (error < 0) {\r\ndev_dbg(kdwc->dev, "unable to enable usb clock, err %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "missing irq\n");\r\nerror = irq;\r\ngoto err_irq;\r\n}\r\nerror = devm_request_irq(dev, irq, dwc3_keystone_interrupt, IRQF_SHARED,\r\ndev_name(dev), kdwc);\r\nif (error) {\r\ndev_err(dev, "failed to request IRQ #%d --> %d\n",\r\nirq, error);\r\ngoto err_irq;\r\n}\r\nkdwc3_enable_irqs(kdwc);\r\nerror = of_platform_populate(node, NULL, NULL, dev);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to create dwc3 core\n");\r\ngoto err_core;\r\n}\r\nreturn 0;\r\nerr_core:\r\nkdwc3_disable_irqs(kdwc);\r\nerr_irq:\r\nclk_disable_unprepare(kdwc->clk);\r\nreturn error;\r\n}\r\nstatic int kdwc3_remove_core(struct device *dev, void *c)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nplatform_device_unregister(pdev);\r\nreturn 0;\r\n}\r\nstatic int kdwc3_remove(struct platform_device *pdev)\r\n{\r\nstruct dwc3_keystone *kdwc = platform_get_drvdata(pdev);\r\nkdwc3_disable_irqs(kdwc);\r\ndevice_for_each_child(&pdev->dev, NULL, kdwc3_remove_core);\r\nclk_disable_unprepare(kdwc->clk);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

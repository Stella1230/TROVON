static int cdc_do_config(struct usb_configuration *c)\r\n{\r\nint status;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_ecm = usb_get_function(fi_ecm);\r\nif (IS_ERR(f_ecm)) {\r\nstatus = PTR_ERR(f_ecm);\r\ngoto err_get_ecm;\r\n}\r\nstatus = usb_add_function(c, f_ecm);\r\nif (status)\r\ngoto err_add_ecm;\r\nf_acm = usb_get_function(fi_serial);\r\nif (IS_ERR(f_acm)) {\r\nstatus = PTR_ERR(f_acm);\r\ngoto err_get_acm;\r\n}\r\nstatus = usb_add_function(c, f_acm);\r\nif (status)\r\ngoto err_add_acm;\r\nreturn 0;\r\nerr_add_acm:\r\nusb_put_function(f_acm);\r\nerr_get_acm:\r\nusb_remove_function(c, f_ecm);\r\nerr_add_ecm:\r\nusb_put_function(f_ecm);\r\nerr_get_ecm:\r\nreturn status;\r\n}\r\nstatic int cdc_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nstruct f_ecm_opts *ecm_opts;\r\nint status;\r\nif (!can_support_ecm(cdev->gadget)) {\r\ndev_err(&gadget->dev, "controller '%s' not usable\n",\r\ngadget->name);\r\nreturn -EINVAL;\r\n}\r\nfi_ecm = usb_get_function_instance("ecm");\r\nif (IS_ERR(fi_ecm))\r\nreturn PTR_ERR(fi_ecm);\r\necm_opts = container_of(fi_ecm, struct f_ecm_opts, func_inst);\r\ngether_set_qmult(ecm_opts->net, qmult);\r\nif (!gether_set_host_addr(ecm_opts->net, host_addr))\r\npr_info("using host ethernet address: %s", host_addr);\r\nif (!gether_set_dev_addr(ecm_opts->net, dev_addr))\r\npr_info("using self ethernet address: %s", dev_addr);\r\nfi_serial = usb_get_function_instance("acm");\r\nif (IS_ERR(fi_serial)) {\r\nstatus = PTR_ERR(fi_serial);\r\ngoto fail;\r\n}\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto fail1;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nstatus = usb_add_config(cdev, &cdc_config_driver, cdc_do_config);\r\nif (status < 0)\r\ngoto fail1;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s, version: " DRIVER_VERSION "\n",\r\nDRIVER_DESC);\r\nreturn 0;\r\nfail1:\r\nusb_put_function_instance(fi_serial);\r\nfail:\r\nusb_put_function_instance(fi_ecm);\r\nreturn status;\r\n}\r\nstatic int cdc_unbind(struct usb_composite_dev *cdev)\r\n{\r\nusb_put_function(f_acm);\r\nusb_put_function_instance(fi_serial);\r\nif (!IS_ERR_OR_NULL(f_ecm))\r\nusb_put_function(f_ecm);\r\nif (!IS_ERR_OR_NULL(fi_ecm))\r\nusb_put_function_instance(fi_ecm);\r\nreturn 0;\r\n}

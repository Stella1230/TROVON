static unsigned long long ibm_akebono_detect_memsize(void)\r\n{\r\nu32 reg;\r\nunsigned i;\r\nunsigned long long memsize = 0;\r\nfor (i = 0; i < MAX_RANKS; i++) {\r\nreg = mfdcrx(DDR3_MR0CF + i);\r\nif (!(reg & 1))\r\ncontinue;\r\nreg &= 0x0000f000;\r\nreg >>= 12;\r\nmemsize += (0x800000ULL << reg);\r\n}\r\nreturn memsize;\r\n}\r\nstatic void ibm_akebono_fixups(void)\r\n{\r\nvoid *emac;\r\nu32 reg;\r\ndt_fixup_memory(0x0ULL, ibm_akebono_memsize);\r\nmtdcrx(CCTL0_MCO4, 0x1);\r\nreg = mfdcrx(CCTL0_MCO2) & ~0x2;\r\nmtdcrx(CCTL0_MCO2, reg);\r\nemac = finddevice("/plb/opb/ethernet");\r\nif (emac > 0) {\r\nif (mac_addr)\r\nsetprop(emac, "local-mac-address",\r\n((u8 *) &mac_addr) + 2 , 6);\r\n}\r\n}\r\nvoid platform_init(char *userdata)\r\n{\r\nunsigned long end_of_ram, avail_ram;\r\nu32 pir_reg;\r\nint node, size;\r\nconst u32 *timebase;\r\nint len, i, userdata_len;\r\nchar *end;\r\nuserdata[USERDATA_LEN - 1] = '\0';\r\nuserdata_len = strlen(userdata);\r\nfor (i = 0; i < userdata_len - 15; i++) {\r\nif (strncmp(&userdata[i], "local-mac-addr=", 15) == 0) {\r\nif (i > 0 && userdata[i - 1] != ' ') {\r\ncontinue;\r\n}\r\nmac_addr = strtoull(&userdata[i + 15], &end, 16);\r\nif (*end == ' ')\r\nend++;\r\nlen = ((int) end) - ((int) &userdata[i]);\r\nmemmove(&userdata[i], end,\r\nuserdata_len - (len + i) + 1);\r\nbreak;\r\n}\r\n}\r\nloader_info.cmdline = userdata;\r\nloader_info.cmdline_len = 256;\r\nibm_akebono_memsize = ibm_akebono_detect_memsize();\r\nif (ibm_akebono_memsize >> 32)\r\nend_of_ram = ~0UL;\r\nelse\r\nend_of_ram = ibm_akebono_memsize;\r\navail_ram = end_of_ram - (unsigned long)_end;\r\nsimple_alloc_init(_end, avail_ram, 128, 64);\r\nplatform_ops.fixups = ibm_akebono_fixups;\r\nplatform_ops.exit = ibm44x_dbcr_reset;\r\npir_reg = mfspr(SPRN_PIR);\r\nif (fdt_check_header(_dtb_start) != 0)\r\nfatal("Invalid device tree blob\n");\r\nnode = fdt_node_offset_by_prop_value(_dtb_start, -1, "device_type",\r\n"cpu", sizeof("cpu"));\r\nif (!node)\r\nfatal("Cannot find cpu node\n");\r\ntimebase = fdt_getprop(_dtb_start, node, "timebase-frequency", &size);\r\nif (timebase && (size == 4))\r\ntimebase_period_ns = 1000000000 / *timebase;\r\nfdt_set_boot_cpuid_phys(_dtb_start, pir_reg);\r\nfdt_init(_dtb_start);\r\nserial_console_init();\r\n}

static int txx9aclc_regready(struct txx9aclc_plat_drvdata *drvdata)\r\n{\r\nreturn __raw_readl(drvdata->base + ACINTSTS) & ACINT_REGACCRDY;\r\n}\r\nstatic unsigned short txx9aclc_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata = txx9aclc_drvdata;\r\nvoid __iomem *base = drvdata->base;\r\nu32 dat;\r\nif (!(__raw_readl(base + ACINTSTS) & ACINT_CODECRDY(ac97->num)))\r\nreturn 0xffff;\r\nreg |= ac97->num << 7;\r\ndat = (reg << ACREGACC_REG_SHIFT) | ACREGACC_READ;\r\n__raw_writel(dat, base + ACREGACC);\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTEN);\r\nif (!wait_event_timeout(ac97_waitq, txx9aclc_regready(txx9aclc_drvdata), HZ)) {\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTDIS);\r\nprintk(KERN_ERR "ac97 read timeout (reg %#x)\n", reg);\r\ndat = 0xffff;\r\ngoto done;\r\n}\r\ndat = __raw_readl(base + ACREGACC);\r\nif (((dat >> ACREGACC_REG_SHIFT) & 0xff) != reg) {\r\nprintk(KERN_ERR "reg mismatch %x with %x\n",\r\ndat, reg);\r\ndat = 0xffff;\r\ngoto done;\r\n}\r\ndat = (dat >> ACREGACC_DAT_SHIFT) & 0xffff;\r\ndone:\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTDIS);\r\nreturn dat;\r\n}\r\nstatic void txx9aclc_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata = txx9aclc_drvdata;\r\nvoid __iomem *base = drvdata->base;\r\n__raw_writel(((reg | (ac97->num << 7)) << ACREGACC_REG_SHIFT) |\r\n(val << ACREGACC_DAT_SHIFT),\r\nbase + ACREGACC);\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTEN);\r\nif (!wait_event_timeout(ac97_waitq, txx9aclc_regready(txx9aclc_drvdata), HZ)) {\r\nprintk(KERN_ERR\r\n"ac97 write timeout (reg %#x)\n", reg);\r\n}\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTDIS);\r\n}\r\nstatic void txx9aclc_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata = txx9aclc_drvdata;\r\nvoid __iomem *base = drvdata->base;\r\nu32 ready = ACINT_CODECRDY(ac97->num) | ACINT_REGACCRDY;\r\n__raw_writel(ACCTL_ENLINK, base + ACCTLDIS);\r\nmmiowb();\r\nudelay(1);\r\n__raw_writel(ACCTL_ENLINK, base + ACCTLEN);\r\n__raw_writel(ready, base + ACINTEN);\r\nif (!wait_event_timeout(ac97_waitq,\r\n(__raw_readl(base + ACINTSTS) & ready) == ready,\r\nHZ)) {\r\ndev_err(&ac97->dev, "primary codec is not ready "\r\n"(status %#x)\n",\r\n__raw_readl(base + ACINTSTS));\r\n}\r\n__raw_writel(ACINT_REGACCRDY, base + ACINTSTS);\r\n__raw_writel(ready, base + ACINTDIS);\r\n}\r\nstatic irqreturn_t txx9aclc_ac97_irq(int irq, void *dev_id)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata = dev_id;\r\nvoid __iomem *base = drvdata->base;\r\n__raw_writel(__raw_readl(base + ACINTMSTS), base + ACINTDIS);\r\nwake_up(&ac97_waitq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int txx9aclc_ac97_probe(struct snd_soc_dai *dai)\r\n{\r\ntxx9aclc_drvdata = snd_soc_dai_get_drvdata(dai);\r\nreturn 0;\r\n}\r\nstatic int txx9aclc_ac97_remove(struct snd_soc_dai *dai)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata = snd_soc_dai_get_drvdata(dai);\r\n__raw_writel(ACCTL_ENLINK, drvdata->base + ACCTLDIS);\r\ntxx9aclc_drvdata = NULL;\r\nreturn 0;\r\n}\r\nstatic int txx9aclc_ac97_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct txx9aclc_plat_drvdata *drvdata;\r\nstruct resource *r;\r\nint err;\r\nint irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndrvdata->base = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(drvdata->base))\r\nreturn PTR_ERR(drvdata->base);\r\nplatform_set_drvdata(pdev, drvdata);\r\ndrvdata->physbase = r->start;\r\nif (sizeof(drvdata->physbase) > sizeof(r->start) &&\r\nr->start >= TXX9_DIRECTMAP_BASE &&\r\nr->start < TXX9_DIRECTMAP_BASE + 0x400000)\r\ndrvdata->physbase |= 0xf00000000ull;\r\nerr = devm_request_irq(&pdev->dev, irq, txx9aclc_ac97_irq,\r\n0, dev_name(&pdev->dev), drvdata);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_soc_set_ac97_ops(&txx9aclc_ac97_ops);\r\nif (err < 0)\r\nreturn err;\r\nreturn snd_soc_register_component(&pdev->dev, &txx9aclc_ac97_component,\r\n&txx9aclc_ac97_dai, 1);\r\n}\r\nstatic int txx9aclc_ac97_dev_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_component(&pdev->dev);\r\nsnd_soc_set_ac97_ops(NULL);\r\nreturn 0;\r\n}

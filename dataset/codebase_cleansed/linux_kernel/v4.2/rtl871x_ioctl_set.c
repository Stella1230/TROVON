static u8 validate_ssid(struct ndis_802_11_ssid *ssid)\r\n{\r\nu8 i;\r\nif (ssid->SsidLength > 32)\r\nreturn false;\r\nfor (i = 0; i < ssid->SsidLength; i++) {\r\nif (!((ssid->Ssid[i] >= 0x20) && (ssid->Ssid[i] <= 0x7e)))\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic u8 do_join(struct _adapter *padapter)\r\n{\r\nstruct list_head *plist, *phead;\r\nu8 *pibss = NULL;\r\nstruct mlme_priv *pmlmepriv = &(padapter->mlmepriv);\r\nstruct __queue *queue = &(pmlmepriv->scanned_queue);\r\nphead = &queue->queue;\r\nplist = phead->next;\r\npmlmepriv->cur_network.join_res = -2;\r\npmlmepriv->fw_state |= _FW_UNDER_LINKING;\r\npmlmepriv->pscanned = plist;\r\npmlmepriv->to_join = true;\r\nif (!check_fwstate(pmlmepriv, WIFI_ADHOC_STATE) &&\r\nlist_empty(&queue->queue)) {\r\nif (pmlmepriv->fw_state & _FW_UNDER_LINKING)\r\npmlmepriv->fw_state ^= _FW_UNDER_LINKING;\r\nif (!pmlmepriv->sitesurveyctrl.traffic_busy)\r\nr8712_sitesurvey_cmd(padapter, &pmlmepriv->assoc_ssid);\r\nreturn true;\r\n} else {\r\nint ret;\r\nret = r8712_select_and_join_from_scan(pmlmepriv);\r\nif (ret == _SUCCESS)\r\nmod_timer(&pmlmepriv->assoc_timer,\r\njiffies + msecs_to_jiffies(MAX_JOIN_TIMEOUT));\r\nelse {\r\nif (check_fwstate(pmlmepriv, WIFI_ADHOC_STATE)) {\r\nstruct wlan_bssid_ex *pdev_network =\r\n&(padapter->registrypriv.dev_network);\r\npmlmepriv->fw_state = WIFI_ADHOC_MASTER_STATE;\r\npibss = padapter->registrypriv.dev_network.\r\nMacAddress;\r\nmemcpy(&pdev_network->Ssid,\r\n&pmlmepriv->assoc_ssid,\r\nsizeof(struct ndis_802_11_ssid));\r\nr8712_update_registrypriv_dev_network(padapter);\r\nr8712_generate_random_ibss(pibss);\r\nif (r8712_createbss_cmd(padapter) != _SUCCESS)\r\nreturn false;\r\npmlmepriv->to_join = false;\r\n} else {\r\nif (pmlmepriv->fw_state & _FW_UNDER_LINKING)\r\npmlmepriv->fw_state ^=\r\n_FW_UNDER_LINKING;\r\nif (!pmlmepriv->sitesurveyctrl.traffic_busy)\r\nr8712_sitesurvey_cmd(padapter,\r\n&pmlmepriv->assoc_ssid);\r\n}\r\n}\r\n}\r\nreturn true;\r\n}\r\nu8 r8712_set_802_11_bssid(struct _adapter *padapter, u8 *bssid)\r\n{\r\nunsigned long irqL;\r\nu8 status = true;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nif (is_zero_ether_addr(bssid) || is_broadcast_ether_addr(bssid)) {\r\nstatus = false;\r\nreturn status;\r\n}\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY |\r\n_FW_UNDER_LINKING) == true) {\r\nstatus = check_fwstate(pmlmepriv, _FW_UNDER_LINKING);\r\ngoto _Abort_Set_BSSID;\r\n}\r\nif (check_fwstate(pmlmepriv,\r\n_FW_LINKED|WIFI_ADHOC_MASTER_STATE) == true) {\r\nif (!memcmp(&pmlmepriv->cur_network.network.MacAddress, bssid,\r\nETH_ALEN)) {\r\nif (!check_fwstate(pmlmepriv, WIFI_STATION_STATE))\r\ngoto _Abort_Set_BSSID;\r\n} else {\r\nr8712_disassoc_cmd(padapter);\r\nif (check_fwstate(pmlmepriv, _FW_LINKED) == true)\r\nr8712_ind_disconnect(padapter);\r\nr8712_free_assoc_resources(padapter);\r\nif ((check_fwstate(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE))) {\r\n_clr_fwstate_(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE);\r\nset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\r\n}\r\n}\r\n}\r\nmemcpy(&pmlmepriv->assoc_bssid, bssid, ETH_ALEN);\r\npmlmepriv->assoc_by_bssid = true;\r\nstatus = do_join(padapter);\r\ngoto done;\r\n_Abort_Set_BSSID:\r\ndone:\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nreturn status;\r\n}\r\nvoid r8712_set_802_11_ssid(struct _adapter *padapter,\r\nstruct ndis_802_11_ssid *ssid)\r\n{\r\nunsigned long irqL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct wlan_network *pnetwork = &pmlmepriv->cur_network;\r\nif (!padapter->hw_init_completed)\r\nreturn;\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY|_FW_UNDER_LINKING)) {\r\ncheck_fwstate(pmlmepriv, _FW_UNDER_LINKING);\r\ngoto _Abort_Set_SSID;\r\n}\r\nif (check_fwstate(pmlmepriv, _FW_LINKED|WIFI_ADHOC_MASTER_STATE)) {\r\nif ((pmlmepriv->assoc_ssid.SsidLength == ssid->SsidLength) &&\r\n(!memcmp(&pmlmepriv->assoc_ssid.Ssid, ssid->Ssid,\r\nssid->SsidLength))) {\r\nif (!check_fwstate(pmlmepriv, WIFI_STATION_STATE)) {\r\nif (!r8712_is_same_ibss(padapter,\r\npnetwork)) {\r\nr8712_disassoc_cmd(padapter);\r\nif (check_fwstate(pmlmepriv,\r\n_FW_LINKED) == true)\r\nr8712_ind_disconnect(padapter);\r\nr8712_free_assoc_resources(padapter);\r\nif (check_fwstate(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE)) {\r\n_clr_fwstate_(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE);\r\nset_fwstate(pmlmepriv,\r\nWIFI_ADHOC_STATE);\r\n}\r\n} else\r\ngoto _Abort_Set_SSID;\r\n}\r\n} else {\r\nr8712_disassoc_cmd(padapter);\r\nif (check_fwstate(pmlmepriv, _FW_LINKED) == true)\r\nr8712_ind_disconnect(padapter);\r\nr8712_free_assoc_resources(padapter);\r\nif (check_fwstate(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE) == true) {\r\n_clr_fwstate_(pmlmepriv,\r\nWIFI_ADHOC_MASTER_STATE);\r\nset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\r\n}\r\n}\r\n}\r\nif (padapter->securitypriv.btkip_countermeasure == true)\r\ngoto _Abort_Set_SSID;\r\nif (!validate_ssid(ssid))\r\ngoto _Abort_Set_SSID;\r\nmemcpy(&pmlmepriv->assoc_ssid, ssid, sizeof(struct ndis_802_11_ssid));\r\npmlmepriv->assoc_by_bssid = false;\r\ndo_join(padapter);\r\ngoto done;\r\n_Abort_Set_SSID:\r\ndone:\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\n}\r\nvoid r8712_set_802_11_infrastructure_mode(struct _adapter *padapter,\r\nenum NDIS_802_11_NETWORK_INFRASTRUCTURE networktype)\r\n{\r\nunsigned long irqL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct wlan_network *cur_network = &pmlmepriv->cur_network;\r\nenum NDIS_802_11_NETWORK_INFRASTRUCTURE *pold_state =\r\n&(cur_network->network.InfrastructureMode);\r\nif (*pold_state != networktype) {\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif ((check_fwstate(pmlmepriv, _FW_LINKED) == true) ||\r\n(*pold_state == Ndis802_11IBSS))\r\nr8712_disassoc_cmd(padapter);\r\nif (check_fwstate(pmlmepriv,\r\n_FW_LINKED|WIFI_ADHOC_MASTER_STATE) == true)\r\nr8712_free_assoc_resources(padapter);\r\nif ((check_fwstate(pmlmepriv, _FW_LINKED) == true) ||\r\n(*pold_state == Ndis802_11Infrastructure) ||\r\n(*pold_state == Ndis802_11IBSS)) {\r\nr8712_ind_disconnect(padapter);\r\n}\r\n*pold_state = networktype;\r\n_clr_fwstate_(pmlmepriv, WIFI_STATION_STATE | WIFI_AP_STATE |\r\nWIFI_ADHOC_STATE | WIFI_ADHOC_MASTER_STATE);\r\nswitch (networktype) {\r\ncase Ndis802_11IBSS:\r\nset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\r\nbreak;\r\ncase Ndis802_11Infrastructure:\r\nset_fwstate(pmlmepriv, WIFI_STATION_STATE);\r\nbreak;\r\ncase Ndis802_11APMode:\r\nset_fwstate(pmlmepriv, WIFI_AP_STATE);\r\nbreak;\r\ncase Ndis802_11AutoUnknown:\r\ncase Ndis802_11InfrastructureMax:\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\n}\r\n}\r\nu8 r8712_set_802_11_disassociate(struct _adapter *padapter)\r\n{\r\nunsigned long irqL;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif (check_fwstate(pmlmepriv, _FW_LINKED) == true) {\r\nr8712_disassoc_cmd(padapter);\r\nr8712_ind_disconnect(padapter);\r\nr8712_free_assoc_resources(padapter);\r\n}\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nreturn true;\r\n}\r\nu8 r8712_set_802_11_bssid_list_scan(struct _adapter *padapter)\r\n{\r\nstruct mlme_priv *pmlmepriv = NULL;\r\nunsigned long irqL;\r\nu8 ret = true;\r\nif (!padapter)\r\nreturn false;\r\npmlmepriv = &padapter->mlmepriv;\r\nif (!padapter->hw_init_completed)\r\nreturn false;\r\nspin_lock_irqsave(&pmlmepriv->lock, irqL);\r\nif ((check_fwstate(pmlmepriv, _FW_UNDER_SURVEY|_FW_UNDER_LINKING)) ||\r\n(pmlmepriv->sitesurveyctrl.traffic_busy == true)) {\r\nret = (u8)check_fwstate(pmlmepriv, _FW_UNDER_SURVEY);\r\n} else {\r\nr8712_free_network_queue(padapter);\r\nret = r8712_sitesurvey_cmd(padapter, NULL);\r\n}\r\nspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\r\nreturn ret;\r\n}\r\nu8 r8712_set_802_11_authentication_mode(struct _adapter *padapter,\r\nenum NDIS_802_11_AUTHENTICATION_MODE authmode)\r\n{\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\nu8 ret;\r\npsecuritypriv->ndisauthtype = authmode;\r\nif (psecuritypriv->ndisauthtype > 3)\r\npsecuritypriv->AuthAlgrthm = 2;\r\nif (r8712_set_auth(padapter, psecuritypriv) == _SUCCESS)\r\nret = true;\r\nelse\r\nret = false;\r\nreturn ret;\r\n}\r\nu8 r8712_set_802_11_add_wep(struct _adapter *padapter,\r\nstruct NDIS_802_11_WEP *wep)\r\n{\r\nsint keyid;\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\nkeyid = wep->KeyIndex & 0x3fffffff;\r\nif (keyid >= WEP_KEYS)\r\nreturn false;\r\nswitch (wep->KeyLength) {\r\ncase 5:\r\npsecuritypriv->PrivacyAlgrthm = _WEP40_;\r\nbreak;\r\ncase 13:\r\npsecuritypriv->PrivacyAlgrthm = _WEP104_;\r\nbreak;\r\ndefault:\r\npsecuritypriv->PrivacyAlgrthm = _NO_PRIVACY_;\r\nbreak;\r\n}\r\nmemcpy(psecuritypriv->DefKey[keyid].skey, &wep->KeyMaterial,\r\nwep->KeyLength);\r\npsecuritypriv->DefKeylen[keyid] = wep->KeyLength;\r\npsecuritypriv->PrivacyKeyIndex = keyid;\r\nif (r8712_set_key(padapter, psecuritypriv, keyid) == _FAIL)\r\nreturn false;\r\nreturn _SUCCESS;\r\n}

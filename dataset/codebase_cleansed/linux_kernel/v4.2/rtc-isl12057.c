static void isl12057_rtc_regs_to_tm(struct rtc_time *tm, u8 *regs)\r\n{\r\ntm->tm_sec = bcd2bin(regs[ISL12057_REG_RTC_SC]);\r\ntm->tm_min = bcd2bin(regs[ISL12057_REG_RTC_MN]);\r\nif (regs[ISL12057_REG_RTC_HR] & ISL12057_REG_RTC_HR_MIL) {\r\ntm->tm_hour = bcd2bin(regs[ISL12057_REG_RTC_HR] & 0x1f);\r\nif (regs[ISL12057_REG_RTC_HR] & ISL12057_REG_RTC_HR_PM)\r\ntm->tm_hour += 12;\r\n} else {\r\ntm->tm_hour = bcd2bin(regs[ISL12057_REG_RTC_HR] & 0x3f);\r\n}\r\ntm->tm_mday = bcd2bin(regs[ISL12057_REG_RTC_DT]);\r\ntm->tm_wday = bcd2bin(regs[ISL12057_REG_RTC_DW]) - 1;\r\ntm->tm_mon = bcd2bin(regs[ISL12057_REG_RTC_MO] & 0x1f) - 1;\r\ntm->tm_year = bcd2bin(regs[ISL12057_REG_RTC_YR]) + 100;\r\nif (regs[ISL12057_REG_RTC_MO] & ISL12057_REG_RTC_MO_CEN)\r\ntm->tm_year += 100;\r\n}\r\nstatic int isl12057_rtc_tm_to_regs(u8 *regs, struct rtc_time *tm)\r\n{\r\nu8 century_bit;\r\nif (tm->tm_year < 100 || tm->tm_year > 299)\r\nreturn -EINVAL;\r\ncentury_bit = (tm->tm_year > 199) ? ISL12057_REG_RTC_MO_CEN : 0;\r\nregs[ISL12057_REG_RTC_SC] = bin2bcd(tm->tm_sec);\r\nregs[ISL12057_REG_RTC_MN] = bin2bcd(tm->tm_min);\r\nregs[ISL12057_REG_RTC_HR] = bin2bcd(tm->tm_hour);\r\nregs[ISL12057_REG_RTC_DT] = bin2bcd(tm->tm_mday);\r\nregs[ISL12057_REG_RTC_MO] = bin2bcd(tm->tm_mon + 1) | century_bit;\r\nregs[ISL12057_REG_RTC_YR] = bin2bcd(tm->tm_year % 100);\r\nregs[ISL12057_REG_RTC_DW] = bin2bcd(tm->tm_wday + 1);\r\nreturn 0;\r\n}\r\nstatic int isl12057_i2c_validate_chip(struct regmap *regmap)\r\n{\r\nu8 regs[ISL12057_MEM_MAP_LEN];\r\nstatic const u8 mask[ISL12057_MEM_MAP_LEN] = { 0x80, 0x80, 0x80, 0xf8,\r\n0xc0, 0x60, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x60, 0x7c };\r\nint ret, i;\r\nret = regmap_bulk_read(regmap, 0, regs, ISL12057_MEM_MAP_LEN);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < ISL12057_MEM_MAP_LEN; ++i) {\r\nif (regs[i] & mask[i])\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int _isl12057_rtc_clear_alarm(struct device *dev)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nint ret;\r\nret = regmap_update_bits(data->regmap, ISL12057_REG_SR,\r\nISL12057_REG_SR_A1F, 0);\r\nif (ret)\r\ndev_err(dev, "%s: clearing alarm failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic int _isl12057_rtc_update_alarm(struct device *dev, int enable)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nint ret;\r\nret = regmap_update_bits(data->regmap, ISL12057_REG_INT,\r\nISL12057_REG_INT_A1IE,\r\nenable ? ISL12057_REG_INT_A1IE : 0);\r\nif (ret)\r\ndev_err(dev, "%s: changing alarm interrupt flag failed (%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nstatic int _isl12057_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nu8 regs[ISL12057_RTC_SEC_LEN];\r\nunsigned int sr;\r\nint ret;\r\nret = regmap_read(data->regmap, ISL12057_REG_SR, &sr);\r\nif (ret) {\r\ndev_err(dev, "%s: unable to read oscillator status flag (%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n} else {\r\nif (sr & ISL12057_REG_SR_OSF) {\r\nret = -ENODATA;\r\ngoto out;\r\n}\r\n}\r\nret = regmap_bulk_read(data->regmap, ISL12057_REG_RTC_SC, regs,\r\nISL12057_RTC_SEC_LEN);\r\nif (ret)\r\ndev_err(dev, "%s: unable to read RTC time section (%d)\n",\r\n__func__, ret);\r\nout:\r\nif (ret)\r\nreturn ret;\r\nisl12057_rtc_regs_to_tm(tm, regs);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int isl12057_rtc_update_alarm(struct device *dev, int enable)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nint ret;\r\nmutex_lock(&data->lock);\r\nret = _isl12057_rtc_update_alarm(dev, enable);\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic int isl12057_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nstruct rtc_time rtc_tm, *alarm_tm = &alarm->time;\r\nunsigned long rtc_secs, alarm_secs;\r\nu8 regs[ISL12057_A1_SEC_LEN];\r\nunsigned int ir;\r\nint ret;\r\nmutex_lock(&data->lock);\r\nret = regmap_bulk_read(data->regmap, ISL12057_REG_A1_SC, regs,\r\nISL12057_A1_SEC_LEN);\r\nif (ret) {\r\ndev_err(dev, "%s: reading alarm section failed (%d)\n",\r\n__func__, ret);\r\ngoto err_unlock;\r\n}\r\nalarm_tm->tm_sec = bcd2bin(regs[0] & 0x7f);\r\nalarm_tm->tm_min = bcd2bin(regs[1] & 0x7f);\r\nalarm_tm->tm_hour = bcd2bin(regs[2] & 0x3f);\r\nalarm_tm->tm_mday = bcd2bin(regs[3] & 0x3f);\r\nalarm_tm->tm_wday = -1;\r\nret = _isl12057_rtc_read_time(dev, &rtc_tm);\r\nif (ret)\r\ngoto err_unlock;\r\nalarm_tm->tm_year = rtc_tm.tm_year;\r\nalarm_tm->tm_mon = rtc_tm.tm_mon;\r\nret = rtc_tm_to_time(&rtc_tm, &rtc_secs);\r\nif (ret)\r\ngoto err_unlock;\r\nret = rtc_tm_to_time(alarm_tm, &alarm_secs);\r\nif (ret)\r\ngoto err_unlock;\r\nif (alarm_secs < rtc_secs) {\r\nif (alarm_tm->tm_mon == 11) {\r\nalarm_tm->tm_mon = 0;\r\nalarm_tm->tm_year += 1;\r\n} else {\r\nalarm_tm->tm_mon += 1;\r\n}\r\n}\r\nret = regmap_read(data->regmap, ISL12057_REG_INT, &ir);\r\nif (ret) {\r\ndev_err(dev, "%s: reading alarm interrupt flag failed (%d)\n",\r\n__func__, ret);\r\ngoto err_unlock;\r\n}\r\nalarm->enabled = !!(ir & ISL12057_REG_INT_A1IE);\r\nerr_unlock:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic int isl12057_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nstruct rtc_time *alarm_tm = &alarm->time;\r\nunsigned long rtc_secs, alarm_secs;\r\nu8 regs[ISL12057_A1_SEC_LEN];\r\nstruct rtc_time rtc_tm;\r\nint ret, enable = 1;\r\nmutex_lock(&data->lock);\r\nret = _isl12057_rtc_read_time(dev, &rtc_tm);\r\nif (ret)\r\ngoto err_unlock;\r\nret = rtc_tm_to_time(&rtc_tm, &rtc_secs);\r\nif (ret)\r\ngoto err_unlock;\r\nret = rtc_tm_to_time(alarm_tm, &alarm_secs);\r\nif (ret)\r\ngoto err_unlock;\r\nif (!alarm->enabled || alarm_secs <= rtc_secs) {\r\nenable = 0;\r\n} else {\r\nif (rtc_tm.tm_mon == 11) {\r\nrtc_tm.tm_mon = 0;\r\nrtc_tm.tm_year += 1;\r\n} else {\r\nrtc_tm.tm_mon += 1;\r\n}\r\nret = rtc_tm_to_time(&rtc_tm, &rtc_secs);\r\nif (ret)\r\ngoto err_unlock;\r\nif (alarm_secs > rtc_secs) {\r\ndev_err(dev, "%s: max for alarm is one month (%d)\n",\r\n__func__, ret);\r\nret = -EINVAL;\r\ngoto err_unlock;\r\n}\r\n}\r\nret = _isl12057_rtc_update_alarm(dev, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: unable to disable the alarm (%d)\n",\r\n__func__, ret);\r\ngoto err_unlock;\r\n}\r\nregs[0] = bin2bcd(alarm_tm->tm_sec) & 0x7f;\r\nregs[1] = bin2bcd(alarm_tm->tm_min) & 0x7f;\r\nregs[2] = bin2bcd(alarm_tm->tm_hour) & 0x3f;\r\nregs[3] = bin2bcd(alarm_tm->tm_mday) & 0x3f;\r\nret = regmap_bulk_write(data->regmap, ISL12057_REG_A1_SC, regs,\r\nISL12057_A1_SEC_LEN);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: writing alarm section failed (%d)\n",\r\n__func__, ret);\r\ngoto err_unlock;\r\n}\r\nret = _isl12057_rtc_update_alarm(dev, enable);\r\nerr_unlock:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic int isl12057_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nu8 regs[ISL12057_RTC_SEC_LEN];\r\nint ret;\r\nret = isl12057_rtc_tm_to_regs(regs, tm);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&data->lock);\r\nret = regmap_bulk_write(data->regmap, ISL12057_REG_RTC_SC, regs,\r\nISL12057_RTC_SEC_LEN);\r\nif (ret) {\r\ndev_err(dev, "%s: unable to write RTC time section (%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\nret = regmap_update_bits(data->regmap, ISL12057_REG_SR,\r\nISL12057_REG_SR_OSF, 0);\r\nif (ret < 0)\r\ndev_err(dev, "%s: unable to clear osc. failure bit (%d)\n",\r\n__func__, ret);\r\nout:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic int isl12057_check_rtc_status(struct device *dev, struct regmap *regmap)\r\n{\r\nint ret;\r\nret = regmap_update_bits(regmap, ISL12057_REG_INT,\r\nISL12057_REG_INT_EOSC, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: unable to enable oscillator (%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(regmap, ISL12057_REG_SR,\r\nISL12057_REG_SR_A1F, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: unable to clear alarm bit (%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool isl12057_can_wakeup_machine(struct device *dev)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nreturn (data->irq || of_property_read_bool(dev->of_node,\r\n"isil,irq2-can-wakeup-machine"));\r\n}\r\nstatic bool isl12057_can_wakeup_machine(struct device *dev)\r\n{\r\nstruct isl12057_rtc_data *data = dev_get_drvdata(dev);\r\nreturn !!data->irq;\r\n}\r\nstatic int isl12057_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enable)\r\n{\r\nstruct isl12057_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nint ret = -ENOTTY;\r\nif (rtc_data->irq)\r\nret = isl12057_rtc_update_alarm(dev, enable);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t isl12057_rtc_interrupt(int irq, void *data)\r\n{\r\nstruct i2c_client *client = data;\r\nstruct isl12057_rtc_data *rtc_data = dev_get_drvdata(&client->dev);\r\nstruct rtc_device *rtc = rtc_data->rtc;\r\nint ret, handled = IRQ_NONE;\r\nunsigned int sr;\r\nret = regmap_read(rtc_data->regmap, ISL12057_REG_SR, &sr);\r\nif (!ret && (sr & ISL12057_REG_SR_A1F)) {\r\ndev_dbg(&client->dev, "RTC alarm!\n");\r\nrtc_update_irq(rtc, 1, RTC_IRQF | RTC_AF);\r\n_isl12057_rtc_clear_alarm(&client->dev);\r\n_isl12057_rtc_update_alarm(&client->dev, 0);\r\nhandled = IRQ_HANDLED;\r\n}\r\nreturn handled;\r\n}\r\nstatic int isl12057_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct isl12057_rtc_data *data;\r\nstruct regmap *regmap;\r\nint ret;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C |\r\nI2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_I2C_BLOCK))\r\nreturn -ENODEV;\r\nregmap = devm_regmap_init_i2c(client, &isl12057_rtc_regmap_config);\r\nif (IS_ERR(regmap)) {\r\nret = PTR_ERR(regmap);\r\ndev_err(dev, "%s: regmap allocation failed (%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = isl12057_i2c_validate_chip(regmap);\r\nif (ret)\r\nreturn ret;\r\nret = isl12057_check_rtc_status(dev, regmap);\r\nif (ret)\r\nreturn ret;\r\ndata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nmutex_init(&data->lock);\r\ndata->regmap = regmap;\r\ndev_set_drvdata(dev, data);\r\nif (client->irq > 0) {\r\nret = devm_request_threaded_irq(dev, client->irq, NULL,\r\nisl12057_rtc_interrupt,\r\nIRQF_SHARED|IRQF_ONESHOT,\r\nDRV_NAME, client);\r\nif (!ret)\r\ndata->irq = client->irq;\r\nelse\r\ndev_err(dev, "%s: irq %d unavailable (%d)\n", __func__,\r\nclient->irq, ret);\r\n}\r\nif (isl12057_can_wakeup_machine(dev))\r\ndevice_init_wakeup(dev, true);\r\ndata->rtc = devm_rtc_device_register(dev, DRV_NAME, &rtc_ops,\r\nTHIS_MODULE);\r\nret = PTR_ERR_OR_ZERO(data->rtc);\r\nif (ret) {\r\ndev_err(dev, "%s: unable to register RTC device (%d)\n",\r\n__func__, ret);\r\ngoto err;\r\n}\r\nif (!data->irq)\r\ndata->rtc->uie_unsupported = 1;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int isl12057_remove(struct i2c_client *client)\r\n{\r\nif (isl12057_can_wakeup_machine(&client->dev))\r\ndevice_init_wakeup(&client->dev, false);\r\nreturn 0;\r\n}\r\nstatic int isl12057_rtc_suspend(struct device *dev)\r\n{\r\nstruct isl12057_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nif (rtc_data->irq && device_may_wakeup(dev))\r\nreturn enable_irq_wake(rtc_data->irq);\r\nreturn 0;\r\n}\r\nstatic int isl12057_rtc_resume(struct device *dev)\r\n{\r\nstruct isl12057_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nif (rtc_data->irq && device_may_wakeup(dev))\r\nreturn disable_irq_wake(rtc_data->irq);\r\nreturn 0;\r\n}

static irqreturn_t rpcmouse_irq(int irq, void *dev_id)\r\n{\r\nstruct input_dev *dev = dev_id;\r\nshort x, y, dx, dy, b;\r\nx = (short) iomd_readl(IOMD_MOUSEX);\r\ny = (short) iomd_readl(IOMD_MOUSEY);\r\nb = (short) (__raw_readl(IOMEM(0xe0310000)) ^ 0x70);\r\ndx = x - rpcmouse_lastx;\r\ndy = y - rpcmouse_lasty;\r\nrpcmouse_lastx = x;\r\nrpcmouse_lasty = y;\r\ninput_report_rel(dev, REL_X, dx);\r\ninput_report_rel(dev, REL_Y, -dy);\r\ninput_report_key(dev, BTN_LEFT, b & 0x40);\r\ninput_report_key(dev, BTN_MIDDLE, b & 0x20);\r\ninput_report_key(dev, BTN_RIGHT, b & 0x10);\r\ninput_sync(dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init rpcmouse_init(void)\r\n{\r\nint err;\r\nrpcmouse_dev = input_allocate_device();\r\nif (!rpcmouse_dev)\r\nreturn -ENOMEM;\r\nrpcmouse_dev->name = "Acorn RiscPC Mouse";\r\nrpcmouse_dev->phys = "rpcmouse/input0";\r\nrpcmouse_dev->id.bustype = BUS_HOST;\r\nrpcmouse_dev->id.vendor = 0x0005;\r\nrpcmouse_dev->id.product = 0x0001;\r\nrpcmouse_dev->id.version = 0x0100;\r\nrpcmouse_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\nrpcmouse_dev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\r\nrpcmouse_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\nrpcmouse_lastx = (short) iomd_readl(IOMD_MOUSEX);\r\nrpcmouse_lasty = (short) iomd_readl(IOMD_MOUSEY);\r\nif (request_irq(IRQ_VSYNCPULSE, rpcmouse_irq, IRQF_SHARED, "rpcmouse", rpcmouse_dev)) {\r\nprintk(KERN_ERR "rpcmouse: unable to allocate VSYNC interrupt\n");\r\nerr = -EBUSY;\r\ngoto err_free_dev;\r\n}\r\nerr = input_register_device(rpcmouse_dev);\r\nif (err)\r\ngoto err_free_irq;\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(IRQ_VSYNCPULSE, rpcmouse_dev);\r\nerr_free_dev:\r\ninput_free_device(rpcmouse_dev);\r\nreturn err;\r\n}\r\nstatic void __exit rpcmouse_exit(void)\r\n{\r\nfree_irq(IRQ_VSYNCPULSE, rpcmouse_dev);\r\ninput_unregister_device(rpcmouse_dev);\r\n}

void mdp5_set_irqmask(struct mdp_kms *mdp_kms, uint32_t irqmask)\r\n{\r\nmdp5_write(to_mdp5_kms(mdp_kms), REG_MDP5_MDP_INTR_EN(0), irqmask);\r\n}\r\nstatic void mdp5_irq_error_handler(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nDRM_ERROR("errors: %08x\n", irqstatus);\r\n}\r\nvoid mdp5_irq_preinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_INTR_CLEAR(0), 0xffffffff);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_INTR_EN(0), 0x00000000);\r\nmdp5_disable(mdp5_kms);\r\n}\r\nint mdp5_irq_postinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(mdp_kms);\r\nstruct mdp_irq *error_handler = &mdp5_kms->error_handler;\r\nerror_handler->irq = mdp5_irq_error_handler;\r\nerror_handler->irqmask = MDP5_IRQ_INTF0_UNDER_RUN |\r\nMDP5_IRQ_INTF1_UNDER_RUN |\r\nMDP5_IRQ_INTF2_UNDER_RUN |\r\nMDP5_IRQ_INTF3_UNDER_RUN;\r\nmdp_irq_register(mdp_kms, error_handler);\r\nreturn 0;\r\n}\r\nvoid mdp5_irq_uninstall(struct msm_kms *kms)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_INTR_EN(0), 0x00000000);\r\nmdp5_disable(mdp5_kms);\r\n}\r\nstatic void mdp5_irq_mdp(struct mdp_kms *mdp_kms)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(mdp_kms);\r\nstruct drm_device *dev = mdp5_kms->dev;\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nunsigned int id;\r\nuint32_t status;\r\nstatus = mdp5_read(mdp5_kms, REG_MDP5_MDP_INTR_STATUS(0));\r\nmdp5_write(mdp5_kms, REG_MDP5_MDP_INTR_CLEAR(0), status);\r\nVERB("status=%08x", status);\r\nmdp_dispatch_irqs(mdp_kms, status);\r\nfor (id = 0; id < priv->num_crtcs; id++)\r\nif (status & mdp5_crtc_vblank(priv->crtcs[id]))\r\ndrm_handle_vblank(dev, id);\r\n}\r\nirqreturn_t mdp5_irq(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(mdp_kms);\r\nuint32_t intr;\r\nintr = mdp5_read(mdp5_kms, REG_MDSS_HW_INTR_STATUS);\r\nVERB("intr=%08x", intr);\r\nif (intr & MDSS_HW_INTR_STATUS_INTR_MDP) {\r\nmdp5_irq_mdp(mdp_kms);\r\nintr &= ~MDSS_HW_INTR_STATUS_INTR_MDP;\r\n}\r\nwhile (intr) {\r\nirq_hw_number_t hwirq = fls(intr) - 1;\r\ngeneric_handle_irq(irq_find_mapping(\r\nmdp5_kms->irqcontroller.domain, hwirq));\r\nintr &= ~(1 << hwirq);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint mdp5_enable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp5_crtc_vblank(crtc), true);\r\nreturn 0;\r\n}\r\nvoid mdp5_disable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp5_crtc_vblank(crtc), false);\r\n}\r\nstatic void mdp5_hw_mask_irq(struct irq_data *irqd)\r\n{\r\nstruct mdp5_kms *mdp5_kms = irq_data_get_irq_chip_data(irqd);\r\nsmp_mb__before_atomic();\r\nclear_bit(irqd->hwirq, &mdp5_kms->irqcontroller.enabled_mask);\r\nsmp_mb__after_atomic();\r\n}\r\nstatic void mdp5_hw_unmask_irq(struct irq_data *irqd)\r\n{\r\nstruct mdp5_kms *mdp5_kms = irq_data_get_irq_chip_data(irqd);\r\nsmp_mb__before_atomic();\r\nset_bit(irqd->hwirq, &mdp5_kms->irqcontroller.enabled_mask);\r\nsmp_mb__after_atomic();\r\n}\r\nstatic int mdp5_hw_irqdomain_map(struct irq_domain *d,\r\nunsigned int irq, irq_hw_number_t hwirq)\r\n{\r\nstruct mdp5_kms *mdp5_kms = d->host_data;\r\nif (!(VALID_IRQS & (1 << hwirq)))\r\nreturn -EPERM;\r\nirq_set_chip_and_handler(irq, &mdp5_hw_irq_chip, handle_level_irq);\r\nirq_set_chip_data(irq, mdp5_kms);\r\nset_irq_flags(irq, IRQF_VALID);\r\nreturn 0;\r\n}\r\nint mdp5_irq_domain_init(struct mdp5_kms *mdp5_kms)\r\n{\r\nstruct device *dev = mdp5_kms->dev->dev;\r\nstruct irq_domain *d;\r\nd = irq_domain_add_linear(dev->of_node, 32,\r\n&mdp5_hw_irqdomain_ops, mdp5_kms);\r\nif (!d) {\r\ndev_err(dev, "mdp5 irq domain add failed\n");\r\nreturn -ENXIO;\r\n}\r\nmdp5_kms->irqcontroller.enabled_mask = 0;\r\nmdp5_kms->irqcontroller.domain = d;\r\nreturn 0;\r\n}\r\nvoid mdp5_irq_domain_fini(struct mdp5_kms *mdp5_kms)\r\n{\r\nif (mdp5_kms->irqcontroller.domain) {\r\nirq_domain_remove(mdp5_kms->irqcontroller.domain);\r\nmdp5_kms->irqcontroller.domain = NULL;\r\n}\r\n}

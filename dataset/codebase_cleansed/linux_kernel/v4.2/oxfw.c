static bool detect_loud_models(struct fw_unit *unit)\r\n{\r\nconst char *const models[] = {\r\n"Onyxi",\r\n"Onyx-i",\r\n"d.Pro",\r\n"Mackie Onyx Satellite",\r\n"Tapco LINK.firewire 4x6",\r\n"U.420"};\r\nchar model[32];\r\nunsigned int i;\r\nint err;\r\nerr = fw_csr_string(unit->directory, CSR_MODEL,\r\nmodel, sizeof(model));\r\nif (err < 0)\r\nreturn false;\r\nfor (i = 0; i < ARRAY_SIZE(models); i++) {\r\nif (strcmp(models[i], model) == 0)\r\nbreak;\r\n}\r\nreturn (i < ARRAY_SIZE(models));\r\n}\r\nstatic int name_card(struct snd_oxfw *oxfw)\r\n{\r\nstruct fw_device *fw_dev = fw_parent_device(oxfw->unit);\r\nchar vendor[24];\r\nchar model[32];\r\nconst char *d, *v, *m;\r\nu32 firmware;\r\nint err;\r\nerr = fw_csr_string(fw_dev->config_rom + 5, CSR_VENDOR,\r\nvendor, sizeof(vendor));\r\nif (err < 0)\r\ngoto end;\r\nerr = fw_csr_string(oxfw->unit->directory, CSR_MODEL,\r\nmodel, sizeof(model));\r\nif (err < 0)\r\ngoto end;\r\nerr = snd_fw_transaction(oxfw->unit, TCODE_READ_QUADLET_REQUEST,\r\nOXFORD_FIRMWARE_ID_ADDRESS, &firmware, 4, 0);\r\nif (err < 0)\r\ngoto end;\r\nbe32_to_cpus(&firmware);\r\nif (oxfw->device_info) {\r\nd = oxfw->device_info->driver_name;\r\nv = oxfw->device_info->vendor_name;\r\nm = oxfw->device_info->model_name;\r\n} else {\r\nd = "OXFW";\r\nv = vendor;\r\nm = model;\r\n}\r\nstrcpy(oxfw->card->driver, d);\r\nstrcpy(oxfw->card->mixername, m);\r\nstrcpy(oxfw->card->shortname, m);\r\nsnprintf(oxfw->card->longname, sizeof(oxfw->card->longname),\r\n"%s %s (OXFW%x %04x), GUID %08x%08x at %s, S%d",\r\nv, m, firmware >> 20, firmware & 0xffff,\r\nfw_dev->config_rom[3], fw_dev->config_rom[4],\r\ndev_name(&oxfw->unit->device), 100 << fw_dev->max_speed);\r\nend:\r\nreturn err;\r\n}\r\nstatic void oxfw_card_free(struct snd_card *card)\r\n{\r\nstruct snd_oxfw *oxfw = card->private_data;\r\nunsigned int i;\r\nsnd_oxfw_stream_destroy_simplex(oxfw, &oxfw->rx_stream);\r\nif (oxfw->has_output)\r\nsnd_oxfw_stream_destroy_simplex(oxfw, &oxfw->tx_stream);\r\nfw_unit_put(oxfw->unit);\r\nfor (i = 0; i < SND_OXFW_STREAM_FORMAT_ENTRIES; i++) {\r\nkfree(oxfw->tx_stream_formats[i]);\r\nkfree(oxfw->rx_stream_formats[i]);\r\n}\r\nmutex_destroy(&oxfw->mutex);\r\n}\r\nstatic int oxfw_probe(struct fw_unit *unit,\r\nconst struct ieee1394_device_id *id)\r\n{\r\nstruct snd_card *card;\r\nstruct snd_oxfw *oxfw;\r\nint err;\r\nif ((id->vendor_id == VENDOR_LOUD) && !detect_loud_models(unit))\r\nreturn -ENODEV;\r\nerr = snd_card_new(&unit->device, -1, NULL, THIS_MODULE,\r\nsizeof(*oxfw), &card);\r\nif (err < 0)\r\nreturn err;\r\ncard->private_free = oxfw_card_free;\r\noxfw = card->private_data;\r\noxfw->card = card;\r\nmutex_init(&oxfw->mutex);\r\noxfw->unit = fw_unit_get(unit);\r\noxfw->device_info = (const struct device_info *)id->driver_data;\r\nspin_lock_init(&oxfw->lock);\r\ninit_waitqueue_head(&oxfw->hwdep_wait);\r\nerr = snd_oxfw_stream_discover(oxfw);\r\nif (err < 0)\r\ngoto error;\r\nerr = name_card(oxfw);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_oxfw_create_pcm(oxfw);\r\nif (err < 0)\r\ngoto error;\r\nif (oxfw->device_info) {\r\nerr = snd_oxfw_create_mixer(oxfw);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nsnd_oxfw_proc_init(oxfw);\r\nerr = snd_oxfw_create_midi(oxfw);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_oxfw_create_hwdep(oxfw);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_oxfw_stream_init_simplex(oxfw, &oxfw->rx_stream);\r\nif (err < 0)\r\ngoto error;\r\nif (oxfw->has_output) {\r\nerr = snd_oxfw_stream_init_simplex(oxfw, &oxfw->tx_stream);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nerr = snd_card_register(card);\r\nif (err < 0) {\r\nsnd_oxfw_stream_destroy_simplex(oxfw, &oxfw->rx_stream);\r\nif (oxfw->has_output)\r\nsnd_oxfw_stream_destroy_simplex(oxfw, &oxfw->tx_stream);\r\ngoto error;\r\n}\r\ndev_set_drvdata(&unit->device, oxfw);\r\nreturn 0;\r\nerror:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic void oxfw_bus_reset(struct fw_unit *unit)\r\n{\r\nstruct snd_oxfw *oxfw = dev_get_drvdata(&unit->device);\r\nfcp_bus_reset(oxfw->unit);\r\nmutex_lock(&oxfw->mutex);\r\nsnd_oxfw_stream_update_simplex(oxfw, &oxfw->rx_stream);\r\nif (oxfw->has_output)\r\nsnd_oxfw_stream_update_simplex(oxfw, &oxfw->tx_stream);\r\nmutex_unlock(&oxfw->mutex);\r\n}\r\nstatic void oxfw_remove(struct fw_unit *unit)\r\n{\r\nstruct snd_oxfw *oxfw = dev_get_drvdata(&unit->device);\r\nsnd_card_free_when_closed(oxfw->card);\r\n}\r\nstatic int __init snd_oxfw_init(void)\r\n{\r\nreturn driver_register(&oxfw_driver.driver);\r\n}\r\nstatic void __exit snd_oxfw_exit(void)\r\n{\r\ndriver_unregister(&oxfw_driver.driver);\r\n}

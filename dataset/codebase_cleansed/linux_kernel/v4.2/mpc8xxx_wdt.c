static void mpc8xxx_wdt_keepalive(void)\r\n{\r\nspin_lock(&wdt_spinlock);\r\nout_be16(&wd_base->swsrr, 0x556c);\r\nout_be16(&wd_base->swsrr, 0xaa39);\r\nspin_unlock(&wdt_spinlock);\r\n}\r\nstatic void mpc8xxx_wdt_timer_ping(unsigned long arg)\r\n{\r\nstruct watchdog_device *w = (struct watchdog_device *)arg;\r\nmpc8xxx_wdt_keepalive();\r\nmod_timer(&wdt_timer, jiffies + HZ * w->timeout / 2);\r\n}\r\nstatic int mpc8xxx_wdt_start(struct watchdog_device *w)\r\n{\r\nu32 tmp = SWCRR_SWEN;\r\nif (prescale)\r\ntmp |= SWCRR_SWPR;\r\nif (reset)\r\ntmp |= SWCRR_SWRI;\r\ntmp |= timeout << 16;\r\nout_be32(&wd_base->swcrr, tmp);\r\ndel_timer_sync(&wdt_timer);\r\nreturn 0;\r\n}\r\nstatic int mpc8xxx_wdt_ping(struct watchdog_device *w)\r\n{\r\nmpc8xxx_wdt_keepalive();\r\nreturn 0;\r\n}\r\nstatic int mpc8xxx_wdt_stop(struct watchdog_device *w)\r\n{\r\nmod_timer(&wdt_timer, jiffies);\r\nreturn 0;\r\n}\r\nstatic int mpc8xxx_wdt_probe(struct platform_device *ofdev)\r\n{\r\nint ret;\r\nconst struct of_device_id *match;\r\nstruct device_node *np = ofdev->dev.of_node;\r\nconst struct mpc8xxx_wdt_type *wdt_type;\r\nu32 freq = fsl_get_sys_freq();\r\nbool enabled;\r\nunsigned int timeout_sec;\r\nmatch = of_match_device(mpc8xxx_wdt_match, &ofdev->dev);\r\nif (!match)\r\nreturn -EINVAL;\r\nwdt_type = match->data;\r\nif (!freq || freq == -1)\r\nreturn -EINVAL;\r\nwd_base = of_iomap(np, 0);\r\nif (!wd_base)\r\nreturn -ENOMEM;\r\nenabled = in_be32(&wd_base->swcrr) & SWCRR_SWEN;\r\nif (!enabled && wdt_type->hw_enabled) {\r\npr_info("could not be enabled in software\n");\r\nret = -ENOSYS;\r\ngoto err_unmap;\r\n}\r\nif (prescale)\r\ntimeout_sec = (timeout * wdt_type->prescaler) / freq;\r\nelse\r\ntimeout_sec = timeout / freq;\r\nmpc8xxx_wdt_dev.timeout = timeout_sec;\r\n#ifdef MODULE\r\nret = mpc8xxx_wdt_init_late();\r\nif (ret)\r\ngoto err_unmap;\r\n#endif\r\npr_info("WDT driver for MPC8xxx initialized. mode:%s timeout=%d (%d seconds)\n",\r\nreset ? "reset" : "interrupt", timeout, timeout_sec);\r\nif (enabled)\r\nmod_timer(&wdt_timer, jiffies);\r\nreturn 0;\r\nerr_unmap:\r\niounmap(wd_base);\r\nwd_base = NULL;\r\nreturn ret;\r\n}\r\nstatic int mpc8xxx_wdt_remove(struct platform_device *ofdev)\r\n{\r\npr_crit("Watchdog removed, expect the %s soon!\n",\r\nreset ? "reset" : "machine check exception");\r\ndel_timer_sync(&wdt_timer);\r\nwatchdog_unregister_device(&mpc8xxx_wdt_dev);\r\niounmap(wd_base);\r\nreturn 0;\r\n}\r\nstatic int mpc8xxx_wdt_init_late(void)\r\n{\r\nint ret;\r\nif (!wd_base)\r\nreturn -ENODEV;\r\nwatchdog_set_nowayout(&mpc8xxx_wdt_dev, nowayout);\r\nret = watchdog_register_device(&mpc8xxx_wdt_dev);\r\nif (ret) {\r\npr_err("cannot register watchdog device (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init mpc8xxx_wdt_init(void)\r\n{\r\nreturn platform_driver_register(&mpc8xxx_wdt_driver);\r\n}\r\nstatic void __exit mpc8xxx_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&mpc8xxx_wdt_driver);\r\n}

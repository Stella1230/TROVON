void ks0108_writedata(unsigned char byte)\r\n{\r\nparport_write_data(ks0108_parport, byte);\r\n}\r\nvoid ks0108_writecontrol(unsigned char byte)\r\n{\r\nudelay(ks0108_delay);\r\nparport_write_control(ks0108_parport, byte ^ (bit(0) | bit(1) | bit(3)));\r\n}\r\nvoid ks0108_displaystate(unsigned char state)\r\n{\r\nks0108_writedata((state ? bit(0) : 0) | bit(1) | bit(2) | bit(3) | bit(4) | bit(5));\r\n}\r\nvoid ks0108_startline(unsigned char startline)\r\n{\r\nks0108_writedata(min(startline,(unsigned char)63) | bit(6) | bit(7));\r\n}\r\nvoid ks0108_address(unsigned char address)\r\n{\r\nks0108_writedata(min(address,(unsigned char)63) | bit(6));\r\n}\r\nvoid ks0108_page(unsigned char page)\r\n{\r\nks0108_writedata(min(page,(unsigned char)7) | bit(3) | bit(4) | bit(5) | bit(7));\r\n}\r\nunsigned char ks0108_isinited(void)\r\n{\r\nreturn ks0108_inited;\r\n}\r\nstatic int __init ks0108_init(void)\r\n{\r\nint result;\r\nint ret = -EINVAL;\r\nks0108_parport = parport_find_base(ks0108_port);\r\nif (ks0108_parport == NULL) {\r\nprintk(KERN_ERR KS0108_NAME ": ERROR: "\r\n"parport didn't find %i port\n", ks0108_port);\r\ngoto none;\r\n}\r\nks0108_pardevice = parport_register_device(ks0108_parport, KS0108_NAME,\r\nNULL, NULL, NULL, PARPORT_DEV_EXCL, NULL);\r\nif (ks0108_pardevice == NULL) {\r\nprintk(KERN_ERR KS0108_NAME ": ERROR: "\r\n"parport didn't register new device\n");\r\ngoto none;\r\n}\r\nresult = parport_claim(ks0108_pardevice);\r\nif (result != 0) {\r\nprintk(KERN_ERR KS0108_NAME ": ERROR: "\r\n"can't claim %i parport, maybe in use\n", ks0108_port);\r\nret = result;\r\ngoto registered;\r\n}\r\nks0108_inited = 1;\r\nreturn 0;\r\nregistered:\r\nparport_unregister_device(ks0108_pardevice);\r\nnone:\r\nreturn ret;\r\n}\r\nstatic void __exit ks0108_exit(void)\r\n{\r\nparport_release(ks0108_pardevice);\r\nparport_unregister_device(ks0108_pardevice);\r\n}

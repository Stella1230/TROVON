static char *scsi_log_reserve_buffer(size_t *len)\r\n{\r\nstruct scsi_log_buf *buf;\r\nunsigned long map_bits = sizeof(buf->buffer) / SCSI_LOG_BUFSIZE;\r\nunsigned long idx = 0;\r\npreempt_disable();\r\nbuf = this_cpu_ptr(&scsi_format_log);\r\nidx = find_first_zero_bit(&buf->map, map_bits);\r\nif (likely(idx < map_bits)) {\r\nwhile (test_and_set_bit(idx, &buf->map)) {\r\nidx = find_next_zero_bit(&buf->map, map_bits, idx);\r\nif (idx >= map_bits)\r\nbreak;\r\n}\r\n}\r\nif (WARN_ON(idx >= map_bits)) {\r\npreempt_enable();\r\nreturn NULL;\r\n}\r\n*len = SCSI_LOG_BUFSIZE;\r\nreturn buf->buffer + idx * SCSI_LOG_BUFSIZE;\r\n}\r\nstatic void scsi_log_release_buffer(char *bufptr)\r\n{\r\nstruct scsi_log_buf *buf;\r\nunsigned long idx;\r\nint ret;\r\nbuf = this_cpu_ptr(&scsi_format_log);\r\nif (bufptr >= buf->buffer &&\r\nbufptr < buf->buffer + SCSI_LOG_SPOOLSIZE) {\r\nidx = (bufptr - buf->buffer) / SCSI_LOG_BUFSIZE;\r\nret = test_and_clear_bit(idx, &buf->map);\r\nWARN_ON(!ret);\r\n}\r\npreempt_enable();\r\n}\r\nstatic inline const char *scmd_name(const struct scsi_cmnd *scmd)\r\n{\r\nreturn scmd->request->rq_disk ?\r\nscmd->request->rq_disk->disk_name : NULL;\r\n}\r\nstatic size_t sdev_format_header(char *logbuf, size_t logbuf_len,\r\nconst char *name, int tag)\r\n{\r\nsize_t off = 0;\r\nif (name)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"[%s] ", name);\r\nif (WARN_ON(off >= logbuf_len))\r\nreturn off;\r\nif (tag >= 0)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"tag#%d ", tag);\r\nreturn off;\r\n}\r\nvoid sdev_prefix_printk(const char *level, const struct scsi_device *sdev,\r\nconst char *name, const char *fmt, ...)\r\n{\r\nva_list args;\r\nchar *logbuf;\r\nsize_t off = 0, logbuf_len;\r\nif (!sdev)\r\nreturn;\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\nif (name)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"[%s] ", name);\r\nif (!WARN_ON(off >= logbuf_len)) {\r\nva_start(args, fmt);\r\noff += vscnprintf(logbuf + off, logbuf_len - off, fmt, args);\r\nva_end(args);\r\n}\r\ndev_printk(level, &sdev->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nvoid scmd_printk(const char *level, const struct scsi_cmnd *scmd,\r\nconst char *fmt, ...)\r\n{\r\nva_list args;\r\nchar *logbuf;\r\nsize_t off = 0, logbuf_len;\r\nif (!scmd || !scmd->cmnd)\r\nreturn;\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\noff = sdev_format_header(logbuf, logbuf_len, scmd_name(scmd),\r\nscmd->request->tag);\r\nif (off < logbuf_len) {\r\nva_start(args, fmt);\r\noff += vscnprintf(logbuf + off, logbuf_len - off, fmt, args);\r\nva_end(args);\r\n}\r\ndev_printk(level, &scmd->device->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nstatic size_t scsi_format_opcode_name(char *buffer, size_t buf_len,\r\nconst unsigned char *cdbp)\r\n{\r\nint sa, cdb0;\r\nconst char *cdb_name = NULL, *sa_name = NULL;\r\nsize_t off;\r\ncdb0 = cdbp[0];\r\nif (cdb0 == VARIABLE_LENGTH_CMD) {\r\nint len = scsi_varlen_cdb_length(cdbp);\r\nif (len < 10) {\r\noff = scnprintf(buffer, buf_len,\r\n"short variable length command, len=%d",\r\nlen);\r\nreturn off;\r\n}\r\nsa = (cdbp[8] << 8) + cdbp[9];\r\n} else\r\nsa = cdbp[1] & 0x1f;\r\nif (!scsi_opcode_sa_name(cdb0, sa, &cdb_name, &sa_name)) {\r\nif (cdb_name)\r\noff = scnprintf(buffer, buf_len, "%s", cdb_name);\r\nelse {\r\noff = scnprintf(buffer, buf_len, "opcode=0x%x", cdb0);\r\nif (WARN_ON(off >= buf_len))\r\nreturn off;\r\nif (cdb0 >= VENDOR_SPECIFIC_CDB)\r\noff += scnprintf(buffer + off, buf_len - off,\r\n" (vendor)");\r\nelse if (cdb0 >= 0x60 && cdb0 < 0x7e)\r\noff += scnprintf(buffer + off, buf_len - off,\r\n" (reserved)");\r\n}\r\n} else {\r\nif (sa_name)\r\noff = scnprintf(buffer, buf_len, "%s", sa_name);\r\nelse if (cdb_name)\r\noff = scnprintf(buffer, buf_len, "%s, sa=0x%x",\r\ncdb_name, sa);\r\nelse\r\noff = scnprintf(buffer, buf_len,\r\n"opcode=0x%x, sa=0x%x", cdb0, sa);\r\n}\r\nWARN_ON(off >= buf_len);\r\nreturn off;\r\n}\r\nsize_t __scsi_format_command(char *logbuf, size_t logbuf_len,\r\nconst unsigned char *cdb, size_t cdb_len)\r\n{\r\nint len, k;\r\nsize_t off;\r\noff = scsi_format_opcode_name(logbuf, logbuf_len, cdb);\r\nif (off >= logbuf_len)\r\nreturn off;\r\nlen = scsi_command_size(cdb);\r\nif (cdb_len < len)\r\nlen = cdb_len;\r\nfor (k = 0; k < len; ++k) {\r\nif (off > logbuf_len - 3)\r\nbreak;\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n" %02x", cdb[k]);\r\n}\r\nreturn off;\r\n}\r\nvoid scsi_print_command(struct scsi_cmnd *cmd)\r\n{\r\nint k;\r\nchar *logbuf;\r\nsize_t off, logbuf_len;\r\nif (!cmd->cmnd)\r\nreturn;\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\noff = sdev_format_header(logbuf, logbuf_len,\r\nscmd_name(cmd), cmd->request->tag);\r\nif (off >= logbuf_len)\r\ngoto out_printk;\r\noff += scnprintf(logbuf + off, logbuf_len - off, "CDB: ");\r\nif (WARN_ON(off >= logbuf_len))\r\ngoto out_printk;\r\noff += scsi_format_opcode_name(logbuf + off, logbuf_len - off,\r\ncmd->cmnd);\r\nif (off >= logbuf_len)\r\ngoto out_printk;\r\nif (cmd->cmd_len > 16) {\r\noff += scnprintf(logbuf + off, logbuf_len - off, "\n");\r\ndev_printk(KERN_INFO, &cmd->device->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\nfor (k = 0; k < cmd->cmd_len; k += 16) {\r\nsize_t linelen = min(cmd->cmd_len - k, 16);\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nbreak;\r\noff = sdev_format_header(logbuf, logbuf_len,\r\nscmd_name(cmd),\r\ncmd->request->tag);\r\nif (!WARN_ON(off > logbuf_len - 58)) {\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"CDB[%02x]: ", k);\r\nhex_dump_to_buffer(&cmd->cmnd[k], linelen,\r\n16, 1, logbuf + off,\r\nlogbuf_len - off, false);\r\n}\r\ndev_printk(KERN_INFO, &cmd->device->sdev_gendev, "%s",\r\nlogbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nreturn;\r\n}\r\nif (!WARN_ON(off > logbuf_len - 49)) {\r\noff += scnprintf(logbuf + off, logbuf_len - off, " ");\r\nhex_dump_to_buffer(cmd->cmnd, cmd->cmd_len, 16, 1,\r\nlogbuf + off, logbuf_len - off,\r\nfalse);\r\n}\r\nout_printk:\r\ndev_printk(KERN_INFO, &cmd->device->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nstatic size_t\r\nscsi_format_extd_sense(char *buffer, size_t buf_len,\r\nunsigned char asc, unsigned char ascq)\r\n{\r\nsize_t off = 0;\r\nconst char *extd_sense_fmt = NULL;\r\nconst char *extd_sense_str = scsi_extd_sense_format(asc, ascq,\r\n&extd_sense_fmt);\r\nif (extd_sense_str) {\r\noff = scnprintf(buffer, buf_len, "Add. Sense: %s",\r\nextd_sense_str);\r\nif (extd_sense_fmt)\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"(%s%x)", extd_sense_fmt, ascq);\r\n} else {\r\nif (asc >= 0x80)\r\noff = scnprintf(buffer, buf_len, "<<vendor>>");\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"ASC=0x%x ", asc);\r\nif (ascq >= 0x80)\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"<<vendor>>");\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"ASCQ=0x%x ", ascq);\r\n}\r\nreturn off;\r\n}\r\nstatic size_t\r\nscsi_format_sense_hdr(char *buffer, size_t buf_len,\r\nconst struct scsi_sense_hdr *sshdr)\r\n{\r\nconst char *sense_txt;\r\nsize_t off;\r\noff = scnprintf(buffer, buf_len, "Sense Key : ");\r\nsense_txt = scsi_sense_key_string(sshdr->sense_key);\r\nif (sense_txt)\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"%s ", sense_txt);\r\nelse\r\noff += scnprintf(buffer + off, buf_len - off,\r\n"0x%x ", sshdr->sense_key);\r\noff += scnprintf(buffer + off, buf_len - off,\r\nscsi_sense_is_deferred(sshdr) ? "[deferred] " : "[current] ");\r\nif (sshdr->response_code >= 0x72)\r\noff += scnprintf(buffer + off, buf_len - off, "[descriptor] ");\r\nreturn off;\r\n}\r\nstatic void\r\nscsi_log_dump_sense(const struct scsi_device *sdev, const char *name, int tag,\r\nconst unsigned char *sense_buffer, int sense_len)\r\n{\r\nchar *logbuf;\r\nsize_t logbuf_len;\r\nint i;\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\nfor (i = 0; i < sense_len; i += 16) {\r\nint len = min(sense_len - i, 16);\r\nsize_t off;\r\noff = sdev_format_header(logbuf, logbuf_len,\r\nname, tag);\r\nhex_dump_to_buffer(&sense_buffer[i], len, 16, 1,\r\nlogbuf + off, logbuf_len - off,\r\nfalse);\r\ndev_printk(KERN_INFO, &sdev->sdev_gendev, "%s", logbuf);\r\n}\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nstatic void\r\nscsi_log_print_sense_hdr(const struct scsi_device *sdev, const char *name,\r\nint tag, const struct scsi_sense_hdr *sshdr)\r\n{\r\nchar *logbuf;\r\nsize_t off, logbuf_len;\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\noff = sdev_format_header(logbuf, logbuf_len, name, tag);\r\noff += scsi_format_sense_hdr(logbuf + off, logbuf_len - off, sshdr);\r\ndev_printk(KERN_INFO, &sdev->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\noff = sdev_format_header(logbuf, logbuf_len, name, tag);\r\noff += scsi_format_extd_sense(logbuf + off, logbuf_len - off,\r\nsshdr->asc, sshdr->ascq);\r\ndev_printk(KERN_INFO, &sdev->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}\r\nstatic void\r\nscsi_log_print_sense(const struct scsi_device *sdev, const char *name, int tag,\r\nconst unsigned char *sense_buffer, int sense_len)\r\n{\r\nstruct scsi_sense_hdr sshdr;\r\nif (scsi_normalize_sense(sense_buffer, sense_len, &sshdr))\r\nscsi_log_print_sense_hdr(sdev, name, tag, &sshdr);\r\nelse\r\nscsi_log_dump_sense(sdev, name, tag, sense_buffer, sense_len);\r\n}\r\nvoid\r\nscsi_print_sense_hdr(const struct scsi_device *sdev, const char *name,\r\nconst struct scsi_sense_hdr *sshdr)\r\n{\r\nscsi_log_print_sense_hdr(sdev, name, -1, sshdr);\r\n}\r\nvoid __scsi_print_sense(const struct scsi_device *sdev, const char *name,\r\nconst unsigned char *sense_buffer, int sense_len)\r\n{\r\nscsi_log_print_sense(sdev, name, -1, sense_buffer, sense_len);\r\n}\r\nvoid scsi_print_sense(const struct scsi_cmnd *cmd)\r\n{\r\nscsi_log_print_sense(cmd->device, scmd_name(cmd), cmd->request->tag,\r\ncmd->sense_buffer, SCSI_SENSE_BUFFERSIZE);\r\n}\r\nvoid scsi_print_result(const struct scsi_cmnd *cmd, const char *msg,\r\nint disposition)\r\n{\r\nchar *logbuf;\r\nsize_t off, logbuf_len;\r\nconst char *mlret_string = scsi_mlreturn_string(disposition);\r\nconst char *hb_string = scsi_hostbyte_string(cmd->result);\r\nconst char *db_string = scsi_driverbyte_string(cmd->result);\r\nlogbuf = scsi_log_reserve_buffer(&logbuf_len);\r\nif (!logbuf)\r\nreturn;\r\noff = sdev_format_header(logbuf, logbuf_len,\r\nscmd_name(cmd), cmd->request->tag);\r\nif (off >= logbuf_len)\r\ngoto out_printk;\r\nif (msg) {\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"%s: ", msg);\r\nif (WARN_ON(off >= logbuf_len))\r\ngoto out_printk;\r\n}\r\nif (mlret_string)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"%s ", mlret_string);\r\nelse\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"UNKNOWN(0x%02x) ", disposition);\r\nif (WARN_ON(off >= logbuf_len))\r\ngoto out_printk;\r\noff += scnprintf(logbuf + off, logbuf_len - off, "Result: ");\r\nif (WARN_ON(off >= logbuf_len))\r\ngoto out_printk;\r\nif (hb_string)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"hostbyte=%s ", hb_string);\r\nelse\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"hostbyte=0x%02x ", host_byte(cmd->result));\r\nif (WARN_ON(off >= logbuf_len))\r\ngoto out_printk;\r\nif (db_string)\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"driverbyte=%s", db_string);\r\nelse\r\noff += scnprintf(logbuf + off, logbuf_len - off,\r\n"driverbyte=0x%02x", driver_byte(cmd->result));\r\nout_printk:\r\ndev_printk(KERN_INFO, &cmd->device->sdev_gendev, "%s", logbuf);\r\nscsi_log_release_buffer(logbuf);\r\n}

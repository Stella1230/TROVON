static int diag8_noresponse(int cmdlen)\r\n{\r\nregister unsigned long reg2 asm ("2") = (addr_t) cpcmd_buf;\r\nregister unsigned long reg3 asm ("3") = cmdlen;\r\nasm volatile(\r\n" sam31\n"\r\n" diag %1,%0,0x8\n"\r\n" sam64\n"\r\n: "+d" (reg3) : "d" (reg2) : "cc");\r\nreturn reg3;\r\n}\r\nstatic int diag8_response(int cmdlen, char *response, int *rlen)\r\n{\r\nregister unsigned long reg2 asm ("2") = (addr_t) cpcmd_buf;\r\nregister unsigned long reg3 asm ("3") = (addr_t) response;\r\nregister unsigned long reg4 asm ("4") = cmdlen | 0x40000000L;\r\nregister unsigned long reg5 asm ("5") = *rlen;\r\nasm volatile(\r\n" sam31\n"\r\n" diag %2,%0,0x8\n"\r\n" sam64\n"\r\n" brc 8,1f\n"\r\n" agr %1,%4\n"\r\n"1:\n"\r\n: "+d" (reg4), "+d" (reg5)\r\n: "d" (reg2), "d" (reg3), "d" (*rlen) : "cc");\r\n*rlen = reg5;\r\nreturn reg4;\r\n}\r\nint __cpcmd(const char *cmd, char *response, int rlen, int *response_code)\r\n{\r\nint cmdlen;\r\nint rc;\r\nint response_len;\r\ncmdlen = strlen(cmd);\r\nBUG_ON(cmdlen > 240);\r\nmemcpy(cpcmd_buf, cmd, cmdlen);\r\nASCEBC(cpcmd_buf, cmdlen);\r\nif (response) {\r\nmemset(response, 0, rlen);\r\nresponse_len = rlen;\r\nrc = diag8_response(cmdlen, response, &rlen);\r\nEBCASC(response, response_len);\r\n} else {\r\nrc = diag8_noresponse(cmdlen);\r\n}\r\nif (response_code)\r\n*response_code = rc;\r\nreturn rlen;\r\n}\r\nint cpcmd(const char *cmd, char *response, int rlen, int *response_code)\r\n{\r\nchar *lowbuf;\r\nint len;\r\nunsigned long flags;\r\nif ((virt_to_phys(response) != (unsigned long) response) ||\r\n(((unsigned long)response + rlen) >> 31)) {\r\nlowbuf = kmalloc(rlen, GFP_KERNEL | GFP_DMA);\r\nif (!lowbuf) {\r\npr_warning("The cpcmd kernel function failed to "\r\n"allocate a response buffer\n");\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_irqsave(&cpcmd_lock, flags);\r\nlen = __cpcmd(cmd, lowbuf, rlen, response_code);\r\nspin_unlock_irqrestore(&cpcmd_lock, flags);\r\nmemcpy(response, lowbuf, rlen);\r\nkfree(lowbuf);\r\n} else {\r\nspin_lock_irqsave(&cpcmd_lock, flags);\r\nlen = __cpcmd(cmd, response, rlen, response_code);\r\nspin_unlock_irqrestore(&cpcmd_lock, flags);\r\n}\r\nreturn len;\r\n}

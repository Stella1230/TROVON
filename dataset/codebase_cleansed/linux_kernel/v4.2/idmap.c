static void idmap_add_pmd(pud_t *pud, unsigned long addr, unsigned long end,\r\nunsigned long prot)\r\n{\r\npmd_t *pmd;\r\nunsigned long next;\r\nif (pud_none_or_clear_bad(pud) || (pud_val(*pud) & L_PGD_SWAPPER)) {\r\npmd = pmd_alloc_one(&init_mm, addr);\r\nif (!pmd) {\r\npr_warn("Failed to allocate identity pmd.\n");\r\nreturn;\r\n}\r\nif (!pud_none(*pud))\r\nmemcpy(pmd, pmd_offset(pud, 0),\r\nPTRS_PER_PMD * sizeof(pmd_t));\r\npud_populate(&init_mm, pud, pmd);\r\npmd += pmd_index(addr);\r\n} else\r\npmd = pmd_offset(pud, addr);\r\ndo {\r\nnext = pmd_addr_end(addr, end);\r\n*pmd = __pmd((addr & PMD_MASK) | prot);\r\nflush_pmd_entry(pmd);\r\n} while (pmd++, addr = next, addr != end);\r\n}\r\nstatic void idmap_add_pmd(pud_t *pud, unsigned long addr, unsigned long end,\r\nunsigned long prot)\r\n{\r\npmd_t *pmd = pmd_offset(pud, addr);\r\naddr = (addr & PMD_MASK) | prot;\r\npmd[0] = __pmd(addr);\r\naddr += SECTION_SIZE;\r\npmd[1] = __pmd(addr);\r\nflush_pmd_entry(pmd);\r\n}\r\nstatic void idmap_add_pud(pgd_t *pgd, unsigned long addr, unsigned long end,\r\nunsigned long prot)\r\n{\r\npud_t *pud = pud_offset(pgd, addr);\r\nunsigned long next;\r\ndo {\r\nnext = pud_addr_end(addr, end);\r\nidmap_add_pmd(pud, addr, next, prot);\r\n} while (pud++, addr = next, addr != end);\r\n}\r\nstatic void identity_mapping_add(pgd_t *pgd, const char *text_start,\r\nconst char *text_end, unsigned long prot)\r\n{\r\nunsigned long addr, end;\r\nunsigned long next;\r\naddr = virt_to_idmap(text_start);\r\nend = virt_to_idmap(text_end);\r\npr_info("Setting up static identity map for 0x%lx - 0x%lx\n", addr, end);\r\nprot |= PMD_TYPE_SECT | PMD_SECT_AP_WRITE | PMD_SECT_AF;\r\nif (cpu_architecture() <= CPU_ARCH_ARMv5TEJ && !cpu_is_xscale())\r\nprot |= PMD_BIT4;\r\npgd += pgd_index(addr);\r\ndo {\r\nnext = pgd_addr_end(addr, end);\r\nidmap_add_pud(pgd, addr, next, prot);\r\n} while (pgd++, addr = next, addr != end);\r\n}\r\nstatic int __init init_static_idmap(void)\r\n{\r\nidmap_pgd = pgd_alloc(&init_mm);\r\nif (!idmap_pgd)\r\nreturn -ENOMEM;\r\nidentity_mapping_add(idmap_pgd, __idmap_text_start,\r\n__idmap_text_end, 0);\r\nflush_cache_louis();\r\nreturn 0;\r\n}\r\nvoid setup_mm_for_reboot(void)\r\n{\r\ncpu_switch_mm(idmap_pgd, &init_mm);\r\nlocal_flush_bp_all();\r\n#ifdef CONFIG_CPU_HAS_ASID\r\nlocal_flush_tlb_all();\r\n#endif\r\n}

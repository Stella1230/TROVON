static int __isp1301_write(struct isp1301 *isp, u8 reg, u8 value, u8 clear)\r\n{\r\nreturn i2c_smbus_write_byte_data(isp->client, reg | clear, value);\r\n}\r\nstatic int isp1301_write(struct isp1301 *isp, u8 reg, u8 value)\r\n{\r\nreturn __isp1301_write(isp, reg, value, 0);\r\n}\r\nstatic int isp1301_clear(struct isp1301 *isp, u8 reg, u8 value)\r\n{\r\nreturn __isp1301_write(isp, reg, value, ISP1301_I2C_REG_CLEAR_ADDR);\r\n}\r\nstatic int isp1301_phy_init(struct usb_phy *phy)\r\n{\r\nstruct isp1301 *isp = phy_to_isp(phy);\r\nisp1301_clear(isp, ISP1301_I2C_MODE_CONTROL_1, MC1_UART_EN);\r\nisp1301_clear(isp, ISP1301_I2C_MODE_CONTROL_1, ~MC1_SPEED_REG);\r\nisp1301_write(isp, ISP1301_I2C_MODE_CONTROL_1, MC1_SPEED_REG);\r\nisp1301_clear(isp, ISP1301_I2C_MODE_CONTROL_2, ~0);\r\nisp1301_write(isp, ISP1301_I2C_MODE_CONTROL_2, (MC2_BI_DI | MC2_PSW_EN\r\n| MC2_SPD_SUSP_CTRL));\r\nisp1301_clear(isp, ISP1301_I2C_OTG_CONTROL_1, ~0);\r\nisp1301_write(isp, ISP1301_I2C_MODE_CONTROL_1, MC1_DAT_SE0);\r\nisp1301_write(isp, ISP1301_I2C_OTG_CONTROL_1, (OTG1_DM_PULLDOWN\r\n| OTG1_DP_PULLDOWN));\r\nisp1301_clear(isp, ISP1301_I2C_OTG_CONTROL_1, (OTG1_DM_PULLUP\r\n| OTG1_DP_PULLUP));\r\nisp1301_clear(isp, ISP1301_I2C_INTERRUPT_LATCH, ~0);\r\nisp1301_clear(isp, ISP1301_I2C_INTERRUPT_FALLING, ~0);\r\nisp1301_clear(isp, ISP1301_I2C_INTERRUPT_RISING, ~0);\r\nreturn 0;\r\n}\r\nstatic int isp1301_phy_set_vbus(struct usb_phy *phy, int on)\r\n{\r\nstruct isp1301 *isp = phy_to_isp(phy);\r\nif (on)\r\nisp1301_write(isp, ISP1301_I2C_OTG_CONTROL_1, OTG1_VBUS_DRV);\r\nelse\r\nisp1301_clear(isp, ISP1301_I2C_OTG_CONTROL_1, OTG1_VBUS_DRV);\r\nreturn 0;\r\n}\r\nstatic int isp1301_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct isp1301 *isp;\r\nstruct usb_phy *phy;\r\nisp = devm_kzalloc(&client->dev, sizeof(*isp), GFP_KERNEL);\r\nif (!isp)\r\nreturn -ENOMEM;\r\nisp->client = client;\r\nmutex_init(&isp->mutex);\r\nphy = &isp->phy;\r\nphy->dev = &client->dev;\r\nphy->label = DRV_NAME;\r\nphy->init = isp1301_phy_init;\r\nphy->set_vbus = isp1301_phy_set_vbus;\r\nphy->type = USB_PHY_TYPE_USB2;\r\ni2c_set_clientdata(client, isp);\r\nusb_add_phy_dev(phy);\r\nisp1301_i2c_client = client;\r\nreturn 0;\r\n}\r\nstatic int isp1301_remove(struct i2c_client *client)\r\n{\r\nstruct isp1301 *isp = i2c_get_clientdata(client);\r\nusb_remove_phy(&isp->phy);\r\nisp1301_i2c_client = NULL;\r\nreturn 0;\r\n}\r\nstatic int match(struct device *dev, void *data)\r\n{\r\nstruct device_node *node = (struct device_node *)data;\r\nreturn (dev->of_node == node) &&\r\n(dev->driver == &isp1301_driver.driver);\r\n}\r\nstruct i2c_client *isp1301_get_client(struct device_node *node)\r\n{\r\nif (node) {\r\nstruct device *dev = bus_find_device(&i2c_bus_type, NULL,\r\nnode, match);\r\nif (!dev)\r\nreturn NULL;\r\nreturn to_i2c_client(dev);\r\n} else {\r\nreturn isp1301_i2c_client;\r\n}\r\n}

static int intel_quark_register_i2c_clk(struct intel_quark_mfd *quark_mfd)\r\n{\r\nstruct pci_dev *pdev = quark_mfd->pdev;\r\nstruct clk_lookup *i2c_clk_lookup;\r\nstruct clk *i2c_clk;\r\nint ret;\r\ni2c_clk_lookup = devm_kcalloc(&pdev->dev, INTEL_QUARK_I2C_NCLK,\r\nsizeof(*i2c_clk_lookup), GFP_KERNEL);\r\nif (!i2c_clk_lookup)\r\nreturn -ENOMEM;\r\ni2c_clk_lookup[0].dev_id = INTEL_QUARK_I2C_CONTROLLER_CLK;\r\ni2c_clk = clk_register_fixed_rate(&pdev->dev,\r\nINTEL_QUARK_I2C_CONTROLLER_CLK, NULL,\r\nCLK_IS_ROOT, INTEL_QUARK_I2C_CLK_HZ);\r\nquark_mfd->i2c_clk_lookup = i2c_clk_lookup;\r\nquark_mfd->i2c_clk = i2c_clk;\r\nret = clk_register_clkdevs(i2c_clk, i2c_clk_lookup,\r\nINTEL_QUARK_I2C_NCLK);\r\nif (ret)\r\ndev_err(&pdev->dev, "Fixed clk register failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void intel_quark_unregister_i2c_clk(struct pci_dev *pdev)\r\n{\r\nstruct intel_quark_mfd *quark_mfd = dev_get_drvdata(&pdev->dev);\r\nif (!quark_mfd->i2c_clk || !quark_mfd->i2c_clk_lookup)\r\nreturn;\r\nclkdev_drop(quark_mfd->i2c_clk_lookup);\r\nclk_unregister(quark_mfd->i2c_clk);\r\n}\r\nstatic int intel_quark_i2c_setup(struct pci_dev *pdev, struct mfd_cell *cell)\r\n{\r\nconst char *board_name = dmi_get_system_info(DMI_BOARD_NAME);\r\nconst struct i2c_mode_info *info;\r\nstruct dw_i2c_platform_data *pdata;\r\nstruct resource *res = (struct resource *)cell->resources;\r\nstruct device *dev = &pdev->dev;\r\nres[INTEL_QUARK_IORES_MEM].start =\r\npci_resource_start(pdev, MFD_I2C_BAR);\r\nres[INTEL_QUARK_IORES_MEM].end =\r\npci_resource_end(pdev, MFD_I2C_BAR);\r\nres[INTEL_QUARK_IORES_IRQ].start = pdev->irq;\r\nres[INTEL_QUARK_IORES_IRQ].end = pdev->irq;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\npdata->i2c_scl_freq = 100000;\r\nif (board_name) {\r\nfor (info = platform_i2c_mode_info; info->name; info++) {\r\nif (!strcmp(board_name, info->name)) {\r\npdata->i2c_scl_freq = info->i2c_scl_freq;\r\nbreak;\r\n}\r\n}\r\n}\r\ncell->platform_data = pdata;\r\ncell->pdata_size = sizeof(*pdata);\r\nreturn 0;\r\n}\r\nstatic int intel_quark_gpio_setup(struct pci_dev *pdev, struct mfd_cell *cell)\r\n{\r\nstruct dwapb_platform_data *pdata;\r\nstruct resource *res = (struct resource *)cell->resources;\r\nstruct device *dev = &pdev->dev;\r\nres[INTEL_QUARK_IORES_MEM].start =\r\npci_resource_start(pdev, MFD_GPIO_BAR);\r\nres[INTEL_QUARK_IORES_MEM].end =\r\npci_resource_end(pdev, MFD_GPIO_BAR);\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\npdata->nports = INTEL_QUARK_GPIO_NPORTS;\r\npdata->properties = devm_kcalloc(dev, pdata->nports,\r\nsizeof(*pdata->properties),\r\nGFP_KERNEL);\r\nif (!pdata->properties)\r\nreturn -ENOMEM;\r\npdata->properties->node = NULL;\r\npdata->properties->name = "intel-quark-x1000-gpio-portA";\r\npdata->properties->idx = 0;\r\npdata->properties->ngpio = INTEL_QUARK_MFD_NGPIO;\r\npdata->properties->gpio_base = INTEL_QUARK_MFD_GPIO_BASE;\r\npdata->properties->irq = pdev->irq;\r\npdata->properties->irq_shared = true;\r\ncell->platform_data = pdata;\r\ncell->pdata_size = sizeof(*pdata);\r\nreturn 0;\r\n}\r\nstatic int intel_quark_mfd_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct intel_quark_mfd *quark_mfd;\r\nint ret;\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nquark_mfd = devm_kzalloc(&pdev->dev, sizeof(*quark_mfd), GFP_KERNEL);\r\nif (!quark_mfd)\r\nreturn -ENOMEM;\r\nquark_mfd->pdev = pdev;\r\nret = intel_quark_register_i2c_clk(quark_mfd);\r\nif (ret)\r\nreturn ret;\r\ndev_set_drvdata(&pdev->dev, quark_mfd);\r\nret = intel_quark_i2c_setup(pdev, &intel_quark_mfd_cells[MFD_I2C_BAR]);\r\nif (ret)\r\nreturn ret;\r\nret = intel_quark_gpio_setup(pdev,\r\n&intel_quark_mfd_cells[MFD_GPIO_BAR]);\r\nif (ret)\r\nreturn ret;\r\nreturn mfd_add_devices(&pdev->dev, 0, intel_quark_mfd_cells,\r\nARRAY_SIZE(intel_quark_mfd_cells), NULL, 0,\r\nNULL);\r\n}\r\nstatic void intel_quark_mfd_remove(struct pci_dev *pdev)\r\n{\r\nintel_quark_unregister_i2c_clk(pdev);\r\nmfd_remove_devices(&pdev->dev);\r\n}

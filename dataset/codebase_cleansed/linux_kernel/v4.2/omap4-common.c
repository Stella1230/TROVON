void gic_dist_disable(void)\r\n{\r\nif (gic_dist_base_addr)\r\nwritel_relaxed(0x0, gic_dist_base_addr + GIC_DIST_CTRL);\r\n}\r\nvoid gic_dist_enable(void)\r\n{\r\nif (gic_dist_base_addr)\r\nwritel_relaxed(0x1, gic_dist_base_addr + GIC_DIST_CTRL);\r\n}\r\nbool gic_dist_disabled(void)\r\n{\r\nreturn !(readl_relaxed(gic_dist_base_addr + GIC_DIST_CTRL) & 0x1);\r\n}\r\nvoid gic_timer_retrigger(void)\r\n{\r\nu32 twd_int = readl_relaxed(twd_base + TWD_TIMER_INTSTAT);\r\nu32 gic_int = readl_relaxed(gic_dist_base_addr + GIC_DIST_PENDING_SET);\r\nu32 twd_ctrl = readl_relaxed(twd_base + TWD_TIMER_CONTROL);\r\nif (twd_int && !(gic_int & BIT(IRQ_LOCALTIMER))) {\r\npr_warn("%s: lost localtimer interrupt\n", __func__);\r\nwritel_relaxed(1, twd_base + TWD_TIMER_INTSTAT);\r\nif (!(twd_ctrl & TWD_TIMER_CONTROL_PERIODIC)) {\r\nwritel_relaxed(1, twd_base + TWD_TIMER_COUNTER);\r\ntwd_ctrl |= TWD_TIMER_CONTROL_ENABLE;\r\nwritel_relaxed(twd_ctrl, twd_base + TWD_TIMER_CONTROL);\r\n}\r\n}\r\n}\r\nvoid __iomem *omap4_get_l2cache_base(void)\r\n{\r\nreturn l2cache_base;\r\n}\r\nvoid omap4_l2c310_write_sec(unsigned long val, unsigned reg)\r\n{\r\nunsigned smc_op;\r\nswitch (reg) {\r\ncase L2X0_CTRL:\r\nsmc_op = OMAP4_MON_L2X0_CTRL_INDEX;\r\nbreak;\r\ncase L2X0_AUX_CTRL:\r\nsmc_op = OMAP4_MON_L2X0_AUXCTRL_INDEX;\r\nbreak;\r\ncase L2X0_DEBUG_CTRL:\r\nsmc_op = OMAP4_MON_L2X0_DBG_CTRL_INDEX;\r\nbreak;\r\ncase L310_PREFETCH_CTRL:\r\nsmc_op = OMAP4_MON_L2X0_PREFETCH_INDEX;\r\nbreak;\r\ncase L310_POWER_CTRL:\r\npr_info_once("OMAP L2C310: ROM does not support power control setting\n");\r\nreturn;\r\ndefault:\r\nWARN_ONCE(1, "OMAP L2C310: ignoring write to reg 0x%x\n", reg);\r\nreturn;\r\n}\r\nomap_smc1(smc_op, val);\r\n}\r\nint __init omap_l2_cache_init(void)\r\n{\r\nl2cache_base = ioremap(OMAP44XX_L2CACHE_BASE, SZ_4K);\r\nif (WARN_ON(!l2cache_base))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid __iomem *omap4_get_sar_ram_base(void)\r\n{\r\nreturn sar_ram_base;\r\n}\r\nstatic int __init omap4_sar_ram_init(void)\r\n{\r\nunsigned long sar_base;\r\nif (cpu_is_omap44xx())\r\nsar_base = OMAP44XX_SAR_RAM_BASE;\r\nelse if (soc_is_omap54xx())\r\nsar_base = OMAP54XX_SAR_RAM_BASE;\r\nelse\r\nreturn -ENOMEM;\r\nsar_ram_base = ioremap(sar_base, SZ_16K);\r\nif (WARN_ON(!sar_ram_base))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nunsigned int omap4_xlate_irq(unsigned int hwirq)\r\n{\r\nstruct of_phandle_args irq_data;\r\nunsigned int irq;\r\nif (!intc_node)\r\nintc_node = of_find_matching_node(NULL, intc_match);\r\nif (WARN_ON(!intc_node))\r\nreturn hwirq;\r\nirq_data.np = intc_node;\r\nirq_data.args_count = 3;\r\nirq_data.args[0] = 0;\r\nirq_data.args[1] = hwirq - OMAP44XX_IRQ_GIC_START;\r\nirq_data.args[2] = IRQ_TYPE_LEVEL_HIGH;\r\nirq = irq_create_of_mapping(&irq_data);\r\nif (WARN_ON(!irq))\r\nirq = hwirq;\r\nreturn irq;\r\n}\r\nvoid __init omap_gic_of_init(void)\r\n{\r\nstruct device_node *np;\r\nintc_node = of_find_matching_node(NULL, intc_match);\r\nif (WARN_ON(!intc_node)) {\r\npr_err("No WUGEN found in DT, system will misbehave.\n");\r\npr_err("UPDATE YOUR DEVICE TREE!\n");\r\n}\r\nif (!cpu_is_omap446x())\r\ngoto skip_errata_init;\r\nnp = of_find_compatible_node(NULL, NULL, "arm,cortex-a9-gic");\r\ngic_dist_base_addr = of_iomap(np, 0);\r\nWARN_ON(!gic_dist_base_addr);\r\nnp = of_find_compatible_node(NULL, NULL, "arm,cortex-a9-twd-timer");\r\ntwd_base = of_iomap(np, 0);\r\nWARN_ON(!twd_base);\r\nskip_errata_init:\r\nirqchip_init();\r\n}

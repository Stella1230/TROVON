static unsigned char\r\nparport_atari_read_data(struct parport *p)\r\n{\r\nunsigned long flags;\r\nunsigned char data;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 15;\r\ndata = sound_ym.rd_data_reg_sel;\r\nlocal_irq_restore(flags);\r\nreturn data;\r\n}\r\nstatic void\r\nparport_atari_write_data(struct parport *p, unsigned char data)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 15;\r\nsound_ym.wd_data = data;\r\nlocal_irq_restore(flags);\r\n}\r\nstatic unsigned char\r\nparport_atari_read_control(struct parport *p)\r\n{\r\nunsigned long flags;\r\nunsigned char control = 0;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 14;\r\nif (!(sound_ym.rd_data_reg_sel & (1 << 5)))\r\ncontrol = PARPORT_CONTROL_STROBE;\r\nlocal_irq_restore(flags);\r\nreturn control;\r\n}\r\nstatic void\r\nparport_atari_write_control(struct parport *p, unsigned char control)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 14;\r\nif (control & PARPORT_CONTROL_STROBE)\r\nsound_ym.wd_data = sound_ym.rd_data_reg_sel & ~(1 << 5);\r\nelse\r\nsound_ym.wd_data = sound_ym.rd_data_reg_sel | (1 << 5);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic unsigned char\r\nparport_atari_frob_control(struct parport *p, unsigned char mask,\r\nunsigned char val)\r\n{\r\nunsigned char old = parport_atari_read_control(p);\r\nparport_atari_write_control(p, (old & ~mask) ^ val);\r\nreturn old;\r\n}\r\nstatic unsigned char\r\nparport_atari_read_status(struct parport *p)\r\n{\r\nreturn ((st_mfp.par_dt_reg & 1 ? 0 : PARPORT_STATUS_BUSY) |\r\nPARPORT_STATUS_SELECT | PARPORT_STATUS_ERROR);\r\n}\r\nstatic void\r\nparport_atari_init_state(struct pardevice *d, struct parport_state *s)\r\n{\r\n}\r\nstatic void\r\nparport_atari_save_state(struct parport *p, struct parport_state *s)\r\n{\r\n}\r\nstatic void\r\nparport_atari_restore_state(struct parport *p, struct parport_state *s)\r\n{\r\n}\r\nstatic void\r\nparport_atari_enable_irq(struct parport *p)\r\n{\r\nenable_irq(IRQ_MFP_BUSY);\r\n}\r\nstatic void\r\nparport_atari_disable_irq(struct parport *p)\r\n{\r\ndisable_irq(IRQ_MFP_BUSY);\r\n}\r\nstatic void\r\nparport_atari_data_forward(struct parport *p)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 7;\r\nsound_ym.wd_data = sound_ym.rd_data_reg_sel | 0x40;\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void\r\nparport_atari_data_reverse(struct parport *p)\r\n{\r\n}\r\nstatic int __init parport_atari_init(void)\r\n{\r\nstruct parport *p;\r\nunsigned long flags;\r\nif (MACH_IS_ATARI) {\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 7;\r\nsound_ym.wd_data = (sound_ym.rd_data_reg_sel & 0x3f) | 0xc0;\r\nsound_ym.rd_data_reg_sel = 14;\r\nsound_ym.wd_data = sound_ym.rd_data_reg_sel | (1 << 5);\r\nlocal_irq_restore(flags);\r\nst_mfp.data_dir &= ~1;\r\nst_mfp.active_edge &= ~1;\r\np = parport_register_port((unsigned long)&sound_ym.wd_data,\r\nIRQ_MFP_BUSY, PARPORT_DMA_NONE,\r\n&parport_atari_ops);\r\nif (!p)\r\nreturn -ENODEV;\r\nif (request_irq(IRQ_MFP_BUSY, parport_irq_handler, 0, p->name,\r\np)) {\r\nparport_put_port (p);\r\nreturn -ENODEV;\r\n}\r\nthis_port = p;\r\nprintk(KERN_INFO "%s: Atari built-in port using irq\n", p->name);\r\nparport_announce_port (p);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic void __exit parport_atari_exit(void)\r\n{\r\nparport_remove_port(this_port);\r\nif (this_port->irq != PARPORT_IRQ_NONE)\r\nfree_irq(IRQ_MFP_BUSY, this_port);\r\nparport_put_port(this_port);\r\n}

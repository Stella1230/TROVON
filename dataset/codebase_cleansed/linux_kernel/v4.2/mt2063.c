static int mt2063_write(struct mt2063_state *state, u8 reg, u8 *data, u32 len)\r\n{\r\nstruct dvb_frontend *fe = state->frontend;\r\nint ret;\r\nu8 buf[60];\r\nstruct i2c_msg msg = {\r\n.addr = state->config->tuner_address,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = len + 1\r\n};\r\ndprintk(2, "\n");\r\nmsg.buf[0] = reg;\r\nmemcpy(msg.buf + 1, data, len);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nret = i2c_transfer(state->i2c, &msg, 1);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nif (ret < 0)\r\nprintk(KERN_ERR "%s error ret=%d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic int mt2063_setreg(struct mt2063_state *state, u8 reg, u8 val)\r\n{\r\nint status;\r\ndprintk(2, "\n");\r\nif (reg >= MT2063_REG_END_REGS)\r\nreturn -ERANGE;\r\nstatus = mt2063_write(state, reg, &val, 1);\r\nif (status < 0)\r\nreturn status;\r\nstate->reg[reg] = val;\r\nreturn 0;\r\n}\r\nstatic int mt2063_read(struct mt2063_state *state,\r\nu8 subAddress, u8 *pData, u32 cnt)\r\n{\r\nint status = 0;\r\nstruct dvb_frontend *fe = state->frontend;\r\nu32 i = 0;\r\ndprintk(2, "addr 0x%02x, cnt %d\n", subAddress, cnt);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nfor (i = 0; i < cnt; i++) {\r\nu8 b0[] = { subAddress + i };\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->tuner_address,\r\n.flags = 0,\r\n.buf = b0,\r\n.len = 1\r\n}, {\r\n.addr = state->config->tuner_address,\r\n.flags = I2C_M_RD,\r\n.buf = pData + i,\r\n.len = 1\r\n}\r\n};\r\nstatus = i2c_transfer(state->i2c, msg, 2);\r\ndprintk(2, "addr 0x%02x, ret = %d, val = 0x%02x\n",\r\nsubAddress + i, status, *(pData + i));\r\nif (status < 0)\r\nbreak;\r\n}\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nif (status < 0)\r\nprintk(KERN_ERR "Can't read from address 0x%02x,\n",\r\nsubAddress + i);\r\nreturn status;\r\n}\r\nstatic int MT2063_Sleep(struct dvb_frontend *fe)\r\n{\r\nmsleep(100);\r\nreturn 0;\r\n}\r\nstatic struct MT2063_ExclZone_t *InsertNode(struct MT2063_AvoidSpursData_t\r\n*pAS_Info,\r\nstruct MT2063_ExclZone_t *pPrevNode)\r\n{\r\nstruct MT2063_ExclZone_t *pNode;\r\ndprintk(2, "\n");\r\nif (pAS_Info->freeZones != NULL) {\r\npNode = pAS_Info->freeZones;\r\npAS_Info->freeZones = pNode->next_;\r\n} else {\r\npNode = &pAS_Info->MT2063_ExclZones[pAS_Info->nZones];\r\n}\r\nif (pPrevNode != NULL) {\r\npNode->next_ = pPrevNode->next_;\r\npPrevNode->next_ = pNode;\r\n} else {\r\npNode->next_ = pAS_Info->usedZones;\r\npAS_Info->usedZones = pNode;\r\n}\r\npAS_Info->nZones++;\r\nreturn pNode;\r\n}\r\nstatic struct MT2063_ExclZone_t *RemoveNode(struct MT2063_AvoidSpursData_t\r\n*pAS_Info,\r\nstruct MT2063_ExclZone_t *pPrevNode,\r\nstruct MT2063_ExclZone_t\r\n*pNodeToRemove)\r\n{\r\nstruct MT2063_ExclZone_t *pNext = pNodeToRemove->next_;\r\ndprintk(2, "\n");\r\nif (pPrevNode != NULL)\r\npPrevNode->next_ = pNext;\r\npNodeToRemove->next_ = pAS_Info->freeZones;\r\npAS_Info->freeZones = pNodeToRemove;\r\npAS_Info->nZones--;\r\nreturn pNext;\r\n}\r\nstatic void MT2063_AddExclZone(struct MT2063_AvoidSpursData_t *pAS_Info,\r\nu32 f_min, u32 f_max)\r\n{\r\nstruct MT2063_ExclZone_t *pNode = pAS_Info->usedZones;\r\nstruct MT2063_ExclZone_t *pPrev = NULL;\r\nstruct MT2063_ExclZone_t *pNext = NULL;\r\ndprintk(2, "\n");\r\nif ((f_max > (pAS_Info->f_if1_Center - (pAS_Info->f_if1_bw / 2)))\r\n&& (f_min < (pAS_Info->f_if1_Center + (pAS_Info->f_if1_bw / 2)))\r\n&& (f_min < f_max)) {\r\nwhile ((pNode != NULL) && (pNode->max_ < f_min)) {\r\npPrev = pNode;\r\npNode = pNode->next_;\r\n}\r\nif ((pNode != NULL) && (pNode->min_ < f_max)) {\r\nif (f_min < pNode->min_)\r\npNode->min_ = f_min;\r\nif (f_max > pNode->max_)\r\npNode->max_ = f_max;\r\n} else {\r\npNode = InsertNode(pAS_Info, pPrev);\r\npNode->min_ = f_min;\r\npNode->max_ = f_max;\r\n}\r\npNext = pNode->next_;\r\nwhile ((pNext != NULL) && (pNext->min_ < pNode->max_)) {\r\nif (pNext->max_ > pNode->max_)\r\npNode->max_ = pNext->max_;\r\npNext = RemoveNode(pAS_Info, pNode, pNext);\r\n}\r\n}\r\n}\r\nstatic void MT2063_ResetExclZones(struct MT2063_AvoidSpursData_t *pAS_Info)\r\n{\r\nu32 center;\r\ndprintk(2, "\n");\r\npAS_Info->nZones = 0;\r\npAS_Info->usedZones = NULL;\r\npAS_Info->freeZones = NULL;\r\ncenter =\r\npAS_Info->f_ref *\r\n((pAS_Info->f_if1_Center - pAS_Info->f_if1_bw / 2 +\r\npAS_Info->f_in) / pAS_Info->f_ref) - pAS_Info->f_in;\r\nwhile (center <\r\npAS_Info->f_if1_Center + pAS_Info->f_if1_bw / 2 +\r\npAS_Info->f_LO1_FracN_Avoid) {\r\nMT2063_AddExclZone(pAS_Info,\r\ncenter - pAS_Info->f_LO1_FracN_Avoid,\r\ncenter - 1);\r\nMT2063_AddExclZone(pAS_Info, center + 1,\r\ncenter + pAS_Info->f_LO1_FracN_Avoid);\r\ncenter += pAS_Info->f_ref;\r\n}\r\ncenter =\r\npAS_Info->f_ref *\r\n((pAS_Info->f_if1_Center - pAS_Info->f_if1_bw / 2 -\r\npAS_Info->f_out) / pAS_Info->f_ref) + pAS_Info->f_out;\r\nwhile (center <\r\npAS_Info->f_if1_Center + pAS_Info->f_if1_bw / 2 +\r\npAS_Info->f_LO2_FracN_Avoid) {\r\nMT2063_AddExclZone(pAS_Info,\r\ncenter - pAS_Info->f_LO2_FracN_Avoid,\r\ncenter - 1);\r\nMT2063_AddExclZone(pAS_Info, center + 1,\r\ncenter + pAS_Info->f_LO2_FracN_Avoid);\r\ncenter += pAS_Info->f_ref;\r\n}\r\nif (MT2063_EXCLUDE_US_DECT_FREQUENCIES(pAS_Info->avoidDECT)) {\r\nMT2063_AddExclZone(pAS_Info, 1920836000 - pAS_Info->f_in, 1922236000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1922564000 - pAS_Info->f_in, 1923964000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1924292000 - pAS_Info->f_in, 1925692000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1926020000 - pAS_Info->f_in, 1927420000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1927748000 - pAS_Info->f_in, 1929148000 - pAS_Info->f_in);\r\n}\r\nif (MT2063_EXCLUDE_EURO_DECT_FREQUENCIES(pAS_Info->avoidDECT)) {\r\nMT2063_AddExclZone(pAS_Info, 1896644000 - pAS_Info->f_in, 1898044000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1894916000 - pAS_Info->f_in, 1896316000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1893188000 - pAS_Info->f_in, 1894588000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1891460000 - pAS_Info->f_in, 1892860000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1889732000 - pAS_Info->f_in, 1891132000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1888004000 - pAS_Info->f_in, 1889404000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1886276000 - pAS_Info->f_in, 1887676000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1884548000 - pAS_Info->f_in, 1885948000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1882820000 - pAS_Info->f_in, 1884220000 - pAS_Info->f_in);\r\nMT2063_AddExclZone(pAS_Info, 1881092000 - pAS_Info->f_in, 1882492000 - pAS_Info->f_in);\r\n}\r\n}\r\nstatic u32 MT2063_ChooseFirstIF(struct MT2063_AvoidSpursData_t *pAS_Info)\r\n{\r\nconst u32 f_Desired =\r\npAS_Info->f_LO1_Step *\r\n((pAS_Info->f_if1_Request + pAS_Info->f_in +\r\npAS_Info->f_LO1_Step / 2) / pAS_Info->f_LO1_Step) -\r\npAS_Info->f_in;\r\nconst u32 f_Step =\r\n(pAS_Info->f_LO1_Step >\r\npAS_Info->f_LO2_Step) ? pAS_Info->f_LO1_Step : pAS_Info->\r\nf_LO2_Step;\r\nu32 f_Center;\r\ns32 i;\r\ns32 j = 0;\r\nu32 bDesiredExcluded = 0;\r\nu32 bZeroExcluded = 0;\r\ns32 tmpMin, tmpMax;\r\ns32 bestDiff;\r\nstruct MT2063_ExclZone_t *pNode = pAS_Info->usedZones;\r\nstruct MT2063_FIFZone_t zones[MT2063_MAX_ZONES];\r\ndprintk(2, "\n");\r\nif (pAS_Info->nZones == 0)\r\nreturn f_Desired;\r\nif (pAS_Info->f_if1_Center > f_Desired)\r\nf_Center =\r\nf_Desired +\r\nf_Step *\r\n((pAS_Info->f_if1_Center - f_Desired +\r\nf_Step / 2) / f_Step);\r\nelse\r\nf_Center =\r\nf_Desired -\r\nf_Step *\r\n((f_Desired - pAS_Info->f_if1_Center +\r\nf_Step / 2) / f_Step);\r\nwhile (pNode != NULL) {\r\ntmpMin =\r\nfloor((s32) (pNode->min_ - f_Center), (s32) f_Step);\r\ntmpMax =\r\nceil((s32) (pNode->max_ - f_Center), (s32) f_Step);\r\nif ((pNode->min_ < f_Desired) && (pNode->max_ > f_Desired))\r\nbDesiredExcluded = 1;\r\nif ((tmpMin < 0) && (tmpMax > 0))\r\nbZeroExcluded = 1;\r\nif ((j > 0) && (tmpMin < zones[j - 1].max_))\r\nzones[j - 1].max_ = tmpMax;\r\nelse {\r\nzones[j].min_ = tmpMin;\r\nzones[j].max_ = tmpMax;\r\nj++;\r\n}\r\npNode = pNode->next_;\r\n}\r\nif (bDesiredExcluded == 0)\r\nreturn f_Desired;\r\nif (bZeroExcluded == 0)\r\nreturn f_Center;\r\nbestDiff = zones[0].min_;\r\nfor (i = 0; i < j; i++) {\r\nif (abs(zones[i].min_) < abs(bestDiff))\r\nbestDiff = zones[i].min_;\r\nif (abs(zones[i].max_) < abs(bestDiff))\r\nbestDiff = zones[i].max_;\r\n}\r\nif (bestDiff < 0)\r\nreturn f_Center - ((u32) (-bestDiff) * f_Step);\r\nreturn f_Center + (bestDiff * f_Step);\r\n}\r\nstatic u32 MT2063_gcd(u32 u, u32 v)\r\n{\r\nu32 r;\r\nwhile (v != 0) {\r\nr = u % v;\r\nu = v;\r\nv = r;\r\n}\r\nreturn u;\r\n}\r\nstatic u32 IsSpurInBand(struct MT2063_AvoidSpursData_t *pAS_Info,\r\nu32 *fm, u32 * fp)\r\n{\r\nu32 n, n0;\r\nconst u32 f_LO1 = pAS_Info->f_LO1;\r\nconst u32 f_LO2 = pAS_Info->f_LO2;\r\nconst u32 d = pAS_Info->f_out + pAS_Info->f_out_bw / 2;\r\nconst u32 c = d - pAS_Info->f_out_bw;\r\nconst u32 f = pAS_Info->f_zif_bw / 2;\r\nconst u32 f_Scale = (f_LO1 / (UINT_MAX / 2 / pAS_Info->maxH1)) + 1;\r\ns32 f_nsLO1, f_nsLO2;\r\ns32 f_Spur;\r\nu32 ma, mb, mc, md, me, mf;\r\nu32 lo_gcd, gd_Scale, gc_Scale, gf_Scale, hgds, hgfs, hgcs;\r\ndprintk(2, "\n");\r\n*fm = 0;\r\nlo_gcd = MT2063_gcd(f_LO1, f_LO2);\r\ngd_Scale = max((u32) MT2063_gcd(lo_gcd, d), f_Scale);\r\nhgds = gd_Scale / 2;\r\ngc_Scale = max((u32) MT2063_gcd(lo_gcd, c), f_Scale);\r\nhgcs = gc_Scale / 2;\r\ngf_Scale = max((u32) MT2063_gcd(lo_gcd, f), f_Scale);\r\nhgfs = gf_Scale / 2;\r\nn0 = DIV_ROUND_UP(f_LO2 - d, f_LO1 - f_LO2);\r\nfor (n = n0; n <= pAS_Info->maxH1; ++n) {\r\nmd = (n * ((f_LO1 + hgds) / gd_Scale) -\r\n((d + hgds) / gd_Scale)) / ((f_LO2 + hgds) / gd_Scale);\r\nif (md >= pAS_Info->maxH1)\r\nbreak;\r\nma = (n * ((f_LO1 + hgds) / gd_Scale) +\r\n((d + hgds) / gd_Scale)) / ((f_LO2 + hgds) / gd_Scale);\r\nif (md == ma)\r\ncontinue;\r\nmc = (n * ((f_LO1 + hgcs) / gc_Scale) -\r\n((c + hgcs) / gc_Scale)) / ((f_LO2 + hgcs) / gc_Scale);\r\nif (mc != md) {\r\nf_nsLO1 = (s32) (n * (f_LO1 / gc_Scale));\r\nf_nsLO2 = (s32) (mc * (f_LO2 / gc_Scale));\r\nf_Spur =\r\n(gc_Scale * (f_nsLO1 - f_nsLO2)) +\r\nn * (f_LO1 % gc_Scale) - mc * (f_LO2 % gc_Scale);\r\n*fp = ((f_Spur - (s32) c) / (mc - n)) + 1;\r\n*fm = (((s32) d - f_Spur) / (mc - n)) + 1;\r\nreturn 1;\r\n}\r\nme = (n * ((f_LO1 + hgfs) / gf_Scale) +\r\n((f + hgfs) / gf_Scale)) / ((f_LO2 + hgfs) / gf_Scale);\r\nmf = (n * ((f_LO1 + hgfs) / gf_Scale) -\r\n((f + hgfs) / gf_Scale)) / ((f_LO2 + hgfs) / gf_Scale);\r\nif (me != mf) {\r\nf_nsLO1 = n * (f_LO1 / gf_Scale);\r\nf_nsLO2 = me * (f_LO2 / gf_Scale);\r\nf_Spur =\r\n(gf_Scale * (f_nsLO1 - f_nsLO2)) +\r\nn * (f_LO1 % gf_Scale) - me * (f_LO2 % gf_Scale);\r\n*fp = ((f_Spur + (s32) f) / (me - n)) + 1;\r\n*fm = (((s32) f - f_Spur) / (me - n)) + 1;\r\nreturn 1;\r\n}\r\nmb = (n * ((f_LO1 + hgcs) / gc_Scale) +\r\n((c + hgcs) / gc_Scale)) / ((f_LO2 + hgcs) / gc_Scale);\r\nif (ma != mb) {\r\nf_nsLO1 = n * (f_LO1 / gc_Scale);\r\nf_nsLO2 = ma * (f_LO2 / gc_Scale);\r\nf_Spur =\r\n(gc_Scale * (f_nsLO1 - f_nsLO2)) +\r\nn * (f_LO1 % gc_Scale) - ma * (f_LO2 % gc_Scale);\r\n*fp = (((s32) d + f_Spur) / (ma - n)) + 1;\r\n*fm = (-(f_Spur + (s32) c) / (ma - n)) + 1;\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 MT2063_AvoidSpurs(struct MT2063_AvoidSpursData_t *pAS_Info)\r\n{\r\nint status = 0;\r\nu32 fm, fp;\r\npAS_Info->bSpurAvoided = 0;\r\npAS_Info->nSpursFound = 0;\r\ndprintk(2, "\n");\r\nif (pAS_Info->maxH1 == 0)\r\nreturn 0;\r\npAS_Info->bSpurPresent = IsSpurInBand(pAS_Info, &fm, &fp);\r\nif (pAS_Info->bSpurPresent) {\r\nu32 zfIF1 = pAS_Info->f_LO1 - pAS_Info->f_in;\r\nu32 zfLO1 = pAS_Info->f_LO1;\r\nu32 zfLO2 = pAS_Info->f_LO2;\r\nu32 delta_IF1;\r\nu32 new_IF1;\r\ndo {\r\npAS_Info->nSpursFound++;\r\nMT2063_AddExclZone(pAS_Info, zfIF1 - fm, zfIF1 + fp);\r\nnew_IF1 = MT2063_ChooseFirstIF(pAS_Info);\r\nif (new_IF1 > zfIF1) {\r\npAS_Info->f_LO1 += (new_IF1 - zfIF1);\r\npAS_Info->f_LO2 += (new_IF1 - zfIF1);\r\n} else {\r\npAS_Info->f_LO1 -= (zfIF1 - new_IF1);\r\npAS_Info->f_LO2 -= (zfIF1 - new_IF1);\r\n}\r\nzfIF1 = new_IF1;\r\nif (zfIF1 > pAS_Info->f_if1_Center)\r\ndelta_IF1 = zfIF1 - pAS_Info->f_if1_Center;\r\nelse\r\ndelta_IF1 = pAS_Info->f_if1_Center - zfIF1;\r\npAS_Info->bSpurPresent = IsSpurInBand(pAS_Info, &fm, &fp);\r\n} while ((2 * delta_IF1 + pAS_Info->f_out_bw <= pAS_Info->f_if1_bw) && pAS_Info->bSpurPresent);\r\nif (pAS_Info->bSpurPresent == 1) {\r\nstatus |= MT2063_SPUR_PRESENT_ERR;\r\npAS_Info->f_LO1 = zfLO1;\r\npAS_Info->f_LO2 = zfLO2;\r\n} else\r\npAS_Info->bSpurAvoided = 1;\r\n}\r\nstatus |=\r\n((pAS_Info->\r\nnSpursFound << MT2063_SPUR_SHIFT) & MT2063_SPUR_CNT_MASK);\r\nreturn status;\r\n}\r\nstatic int mt2063_lockStatus(struct mt2063_state *state)\r\n{\r\nconst u32 nMaxWait = 100;\r\nconst u32 nPollRate = 2;\r\nconst u32 nMaxLoops = nMaxWait / nPollRate;\r\nconst u8 LO1LK = 0x80;\r\nu8 LO2LK = 0x08;\r\nint status;\r\nu32 nDelays = 0;\r\ndprintk(2, "\n");\r\nif (state->tuner_id == MT2063_B0)\r\nLO2LK = 0x40;\r\ndo {\r\nstatus = mt2063_read(state, MT2063_REG_LO_STATUS,\r\n&state->reg[MT2063_REG_LO_STATUS], 1);\r\nif (status < 0)\r\nreturn status;\r\nif ((state->reg[MT2063_REG_LO_STATUS] & (LO1LK | LO2LK)) ==\r\n(LO1LK | LO2LK)) {\r\nreturn TUNER_STATUS_LOCKED | TUNER_STATUS_STEREO;\r\n}\r\nmsleep(nPollRate);\r\n} while (++nDelays < nMaxLoops);\r\nreturn 0;\r\n}\r\nstatic u32 mt2063_get_dnc_output_enable(struct mt2063_state *state,\r\nenum MT2063_DNC_Output_Enable *pValue)\r\n{\r\ndprintk(2, "\n");\r\nif ((state->reg[MT2063_REG_DNC_GAIN] & 0x03) == 0x03) {\r\nif ((state->reg[MT2063_REG_VGA_GAIN] & 0x03) == 0x03)\r\n*pValue = MT2063_DNC_NONE;\r\nelse\r\n*pValue = MT2063_DNC_2;\r\n} else {\r\nif ((state->reg[MT2063_REG_VGA_GAIN] & 0x03) == 0x03)\r\n*pValue = MT2063_DNC_1;\r\nelse\r\n*pValue = MT2063_DNC_BOTH;\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 mt2063_set_dnc_output_enable(struct mt2063_state *state,\r\nenum MT2063_DNC_Output_Enable nValue)\r\n{\r\nint status = 0;\r\nu8 val = 0;\r\ndprintk(2, "\n");\r\nswitch (nValue) {\r\ncase MT2063_DNC_NONE:\r\nval = (state->reg[MT2063_REG_DNC_GAIN] & 0xFC) | 0x03;\r\nif (state->reg[MT2063_REG_DNC_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_DNC_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_VGA_GAIN] & 0xFC) | 0x03;\r\nif (state->reg[MT2063_REG_VGA_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_VGA_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_RSVD_20] & ~0x40);\r\nif (state->reg[MT2063_REG_RSVD_20] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_RSVD_20,\r\nval);\r\nbreak;\r\ncase MT2063_DNC_1:\r\nval = (state->reg[MT2063_REG_DNC_GAIN] & 0xFC) | (DNC1GC[state->rcvr_mode] & 0x03);\r\nif (state->reg[MT2063_REG_DNC_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_DNC_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_VGA_GAIN] & 0xFC) | 0x03;\r\nif (state->reg[MT2063_REG_VGA_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_VGA_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_RSVD_20] & ~0x40);\r\nif (state->reg[MT2063_REG_RSVD_20] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_RSVD_20,\r\nval);\r\nbreak;\r\ncase MT2063_DNC_2:\r\nval = (state->reg[MT2063_REG_DNC_GAIN] & 0xFC) | 0x03;\r\nif (state->reg[MT2063_REG_DNC_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_DNC_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_VGA_GAIN] & 0xFC) | (DNC2GC[state->rcvr_mode] & 0x03);\r\nif (state->reg[MT2063_REG_VGA_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_VGA_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_RSVD_20] | 0x40);\r\nif (state->reg[MT2063_REG_RSVD_20] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_RSVD_20,\r\nval);\r\nbreak;\r\ncase MT2063_DNC_BOTH:\r\nval = (state->reg[MT2063_REG_DNC_GAIN] & 0xFC) | (DNC1GC[state->rcvr_mode] & 0x03);\r\nif (state->reg[MT2063_REG_DNC_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_DNC_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_VGA_GAIN] & 0xFC) | (DNC2GC[state->rcvr_mode] & 0x03);\r\nif (state->reg[MT2063_REG_VGA_GAIN] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_VGA_GAIN,\r\nval);\r\nval = (state->reg[MT2063_REG_RSVD_20] | 0x40);\r\nif (state->reg[MT2063_REG_RSVD_20] !=\r\nval)\r\nstatus |=\r\nmt2063_setreg(state,\r\nMT2063_REG_RSVD_20,\r\nval);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn status;\r\n}\r\nstatic u32 MT2063_SetReceiverMode(struct mt2063_state *state,\r\nenum mt2063_delivery_sys Mode)\r\n{\r\nint status = 0;\r\nu8 val;\r\nu32 longval;\r\ndprintk(2, "\n");\r\nif (Mode >= MT2063_NUM_RCVR_MODES)\r\nstatus = -ERANGE;\r\nif (status >= 0) {\r\nval =\r\n(state->\r\nreg[MT2063_REG_PD1_TGT] & ~0x40) | (RFAGCEN[Mode]\r\n? 0x40 :\r\n0x00);\r\nif (state->reg[MT2063_REG_PD1_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_PD1_TGT, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_CTRL_2C] & ~0x03) |\r\n(LNARIN[Mode] & 0x03);\r\nif (state->reg[MT2063_REG_CTRL_2C] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_CTRL_2C, val);\r\n}\r\nif (status >= 0) {\r\nval =\r\n(state->\r\nreg[MT2063_REG_FIFF_CTRL2] & ~0xF0) |\r\n(FIFFQEN[Mode] << 7) | (FIFFQ[Mode] << 4);\r\nif (state->reg[MT2063_REG_FIFF_CTRL2] != val) {\r\nstatus |=\r\nmt2063_setreg(state, MT2063_REG_FIFF_CTRL2, val);\r\nval =\r\n(state->reg[MT2063_REG_FIFF_CTRL] | 0x01);\r\nstatus |=\r\nmt2063_setreg(state, MT2063_REG_FIFF_CTRL, val);\r\nval =\r\n(state->\r\nreg[MT2063_REG_FIFF_CTRL] & ~0x01);\r\nstatus |=\r\nmt2063_setreg(state, MT2063_REG_FIFF_CTRL, val);\r\n}\r\n}\r\nstatus |= mt2063_get_dnc_output_enable(state, &longval);\r\nstatus |= mt2063_set_dnc_output_enable(state, longval);\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_LNA_OV] & ~0x1F) |\r\n(ACLNAMAX[Mode] & 0x1F);\r\nif (state->reg[MT2063_REG_LNA_OV] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_LNA_OV, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_LNA_TGT] & ~0x3F) |\r\n(LNATGT[Mode] & 0x3F);\r\nif (state->reg[MT2063_REG_LNA_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_LNA_TGT, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_RF_OV] & ~0x1F) |\r\n(ACRFMAX[Mode] & 0x1F);\r\nif (state->reg[MT2063_REG_RF_OV] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_RF_OV, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_PD1_TGT] & ~0x3F) |\r\n(PD1TGT[Mode] & 0x3F);\r\nif (state->reg[MT2063_REG_PD1_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_PD1_TGT, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = ACFIFMAX[Mode];\r\nif (state->reg[MT2063_REG_PART_REV] != MT2063_B3 && val > 5)\r\nval = 5;\r\nval = (state->reg[MT2063_REG_FIF_OV] & ~0x1F) |\r\n(val & 0x1F);\r\nif (state->reg[MT2063_REG_FIF_OV] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_FIF_OV, val);\r\n}\r\nif (status >= 0) {\r\nu8 val = (state->reg[MT2063_REG_PD2_TGT] & ~0x3F) |\r\n(PD2TGT[Mode] & 0x3F);\r\nif (state->reg[MT2063_REG_PD2_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_PD2_TGT, val);\r\n}\r\nif (status >= 0) {\r\nval = (state->reg[MT2063_REG_LNA_TGT] & ~0x80) |\r\n(RFOVDIS[Mode] ? 0x80 : 0x00);\r\nif (state->reg[MT2063_REG_LNA_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_LNA_TGT, val);\r\n}\r\nif (status >= 0) {\r\nval = (state->reg[MT2063_REG_PD1_TGT] & ~0x80) |\r\n(FIFOVDIS[Mode] ? 0x80 : 0x00);\r\nif (state->reg[MT2063_REG_PD1_TGT] != val)\r\nstatus |= mt2063_setreg(state, MT2063_REG_PD1_TGT, val);\r\n}\r\nif (status >= 0) {\r\nstate->rcvr_mode = Mode;\r\ndprintk(1, "mt2063 mode changed to %s\n",\r\nmt2063_mode_name[state->rcvr_mode]);\r\n}\r\nreturn status;\r\n}\r\nstatic u32 MT2063_ClearPowerMaskBits(struct mt2063_state *state,\r\nenum MT2063_Mask_Bits Bits)\r\n{\r\nint status = 0;\r\ndprintk(2, "\n");\r\nBits = (enum MT2063_Mask_Bits)(Bits & MT2063_ALL_SD);\r\nif ((Bits & 0xFF00) != 0) {\r\nstate->reg[MT2063_REG_PWR_2] &= ~(u8) (Bits >> 8);\r\nstatus |=\r\nmt2063_write(state,\r\nMT2063_REG_PWR_2,\r\n&state->reg[MT2063_REG_PWR_2], 1);\r\n}\r\nif ((Bits & 0xFF) != 0) {\r\nstate->reg[MT2063_REG_PWR_1] &= ~(u8) (Bits & 0xFF);\r\nstatus |=\r\nmt2063_write(state,\r\nMT2063_REG_PWR_1,\r\n&state->reg[MT2063_REG_PWR_1], 1);\r\n}\r\nreturn status;\r\n}\r\nstatic u32 MT2063_SoftwareShutdown(struct mt2063_state *state, u8 Shutdown)\r\n{\r\nint status;\r\ndprintk(2, "\n");\r\nif (Shutdown == 1)\r\nstate->reg[MT2063_REG_PWR_1] |= 0x04;\r\nelse\r\nstate->reg[MT2063_REG_PWR_1] &= ~0x04;\r\nstatus = mt2063_write(state,\r\nMT2063_REG_PWR_1,\r\n&state->reg[MT2063_REG_PWR_1], 1);\r\nif (Shutdown != 1) {\r\nstate->reg[MT2063_REG_BYP_CTRL] =\r\n(state->reg[MT2063_REG_BYP_CTRL] & 0x9F) | 0x40;\r\nstatus |=\r\nmt2063_write(state,\r\nMT2063_REG_BYP_CTRL,\r\n&state->reg[MT2063_REG_BYP_CTRL],\r\n1);\r\nstate->reg[MT2063_REG_BYP_CTRL] =\r\n(state->reg[MT2063_REG_BYP_CTRL] & 0x9F);\r\nstatus |=\r\nmt2063_write(state,\r\nMT2063_REG_BYP_CTRL,\r\n&state->reg[MT2063_REG_BYP_CTRL],\r\n1);\r\n}\r\nreturn status;\r\n}\r\nstatic u32 MT2063_Round_fLO(u32 f_LO, u32 f_LO_Step, u32 f_ref)\r\n{\r\nreturn f_ref * (f_LO / f_ref)\r\n+ f_LO_Step * (((f_LO % f_ref) + (f_LO_Step / 2)) / f_LO_Step);\r\n}\r\nstatic u32 MT2063_fLO_FractionalTerm(u32 f_ref, u32 num, u32 denom)\r\n{\r\nu32 t1 = (f_ref >> 14) * num;\r\nu32 term1 = t1 / denom;\r\nu32 loss = t1 % denom;\r\nu32 term2 =\r\n(((f_ref & 0x00003FFF) * num + (loss << 14)) + (denom / 2)) / denom;\r\nreturn (term1 << 14) + term2;\r\n}\r\nstatic u32 MT2063_CalcLO1Mult(u32 *Div,\r\nu32 *FracN,\r\nu32 f_LO,\r\nu32 f_LO_Step, u32 f_Ref)\r\n{\r\n*Div = f_LO / f_Ref;\r\n*FracN =\r\n(64 * (((f_LO % f_Ref) + (f_LO_Step / 2)) / f_LO_Step) +\r\n(f_Ref / f_LO_Step / 2)) / (f_Ref / f_LO_Step);\r\nreturn (f_Ref * (*Div)) + MT2063_fLO_FractionalTerm(f_Ref, *FracN, 64);\r\n}\r\nstatic u32 MT2063_CalcLO2Mult(u32 *Div,\r\nu32 *FracN,\r\nu32 f_LO,\r\nu32 f_LO_Step, u32 f_Ref)\r\n{\r\n*Div = f_LO / f_Ref;\r\n*FracN =\r\n(8191 * (((f_LO % f_Ref) + (f_LO_Step / 2)) / f_LO_Step) +\r\n(f_Ref / f_LO_Step / 2)) / (f_Ref / f_LO_Step);\r\nreturn (f_Ref * (*Div)) + MT2063_fLO_FractionalTerm(f_Ref, *FracN,\r\n8191);\r\n}\r\nstatic u32 FindClearTuneFilter(struct mt2063_state *state, u32 f_in)\r\n{\r\nu32 RFBand;\r\nu32 idx;\r\nRFBand = 31;\r\nfor (idx = 0; idx < 31; ++idx) {\r\nif (state->CTFiltMax[idx] >= f_in) {\r\nRFBand = idx;\r\nbreak;\r\n}\r\n}\r\nreturn RFBand;\r\n}\r\nstatic u32 MT2063_Tune(struct mt2063_state *state, u32 f_in)\r\n{\r\nint status = 0;\r\nu32 LO1;\r\nu32 Num1;\r\nu32 f_IF1;\r\nu32 LO2;\r\nu32 Num2;\r\nu32 ofLO1, ofLO2;\r\nu8 fiffc = 0x80;\r\nu32 fiffof;\r\nconst u8 LO1LK = 0x80;\r\nu8 LO2LK = 0x08;\r\nu8 val;\r\nu32 RFBand;\r\ndprintk(2, "\n");\r\nif ((f_in < MT2063_MIN_FIN_FREQ) || (f_in > MT2063_MAX_FIN_FREQ))\r\nreturn -EINVAL;\r\nif ((state->AS_Data.f_out < MT2063_MIN_FOUT_FREQ)\r\n|| (state->AS_Data.f_out > MT2063_MAX_FOUT_FREQ))\r\nreturn -EINVAL;\r\nofLO1 = state->AS_Data.f_LO1;\r\nofLO2 = state->AS_Data.f_LO2;\r\nif (state->ctfilt_sw == 1) {\r\nval = (state->reg[MT2063_REG_CTUNE_CTRL] | 0x08);\r\nif (state->reg[MT2063_REG_CTUNE_CTRL] != val) {\r\nstatus |=\r\nmt2063_setreg(state, MT2063_REG_CTUNE_CTRL, val);\r\n}\r\nval = state->reg[MT2063_REG_CTUNE_OV];\r\nRFBand = FindClearTuneFilter(state, f_in);\r\nstate->reg[MT2063_REG_CTUNE_OV] =\r\n(u8) ((state->reg[MT2063_REG_CTUNE_OV] & ~0x1F)\r\n| RFBand);\r\nif (state->reg[MT2063_REG_CTUNE_OV] != val) {\r\nstatus |=\r\nmt2063_setreg(state, MT2063_REG_CTUNE_OV, val);\r\n}\r\n}\r\nif (status >= 0) {\r\nstatus |=\r\nmt2063_read(state,\r\nMT2063_REG_FIFFC,\r\n&state->reg[MT2063_REG_FIFFC], 1);\r\nfiffc = state->reg[MT2063_REG_FIFFC];\r\n}\r\nstate->AS_Data.f_in = f_in;\r\nstate->AS_Data.f_if1_Request =\r\nMT2063_Round_fLO(state->AS_Data.f_if1_Request + f_in,\r\nstate->AS_Data.f_LO1_Step,\r\nstate->AS_Data.f_ref) - f_in;\r\nMT2063_ResetExclZones(&state->AS_Data);\r\nf_IF1 = MT2063_ChooseFirstIF(&state->AS_Data);\r\nstate->AS_Data.f_LO1 =\r\nMT2063_Round_fLO(f_IF1 + f_in, state->AS_Data.f_LO1_Step,\r\nstate->AS_Data.f_ref);\r\nstate->AS_Data.f_LO2 =\r\nMT2063_Round_fLO(state->AS_Data.f_LO1 - state->AS_Data.f_out - f_in,\r\nstate->AS_Data.f_LO2_Step, state->AS_Data.f_ref);\r\nstatus |= MT2063_AvoidSpurs(&state->AS_Data);\r\nstate->AS_Data.f_LO1 =\r\nMT2063_CalcLO1Mult(&LO1, &Num1, state->AS_Data.f_LO1,\r\nstate->AS_Data.f_LO1_Step, state->AS_Data.f_ref);\r\nstate->AS_Data.f_LO2 =\r\nMT2063_Round_fLO(state->AS_Data.f_LO1 - state->AS_Data.f_out - f_in,\r\nstate->AS_Data.f_LO2_Step, state->AS_Data.f_ref);\r\nstate->AS_Data.f_LO2 =\r\nMT2063_CalcLO2Mult(&LO2, &Num2, state->AS_Data.f_LO2,\r\nstate->AS_Data.f_LO2_Step, state->AS_Data.f_ref);\r\nif ((state->AS_Data.f_LO1 < MT2063_MIN_UPC_FREQ)\r\n|| (state->AS_Data.f_LO1 > MT2063_MAX_UPC_FREQ))\r\nstatus |= MT2063_UPC_RANGE;\r\nif ((state->AS_Data.f_LO2 < MT2063_MIN_DNC_FREQ)\r\n|| (state->AS_Data.f_LO2 > MT2063_MAX_DNC_FREQ))\r\nstatus |= MT2063_DNC_RANGE;\r\nif (state->tuner_id == MT2063_B0)\r\nLO2LK = 0x40;\r\nif ((ofLO1 != state->AS_Data.f_LO1)\r\n|| (ofLO2 != state->AS_Data.f_LO2)\r\n|| ((state->reg[MT2063_REG_LO_STATUS] & (LO1LK | LO2LK)) !=\r\n(LO1LK | LO2LK))) {\r\nfiffof =\r\n(state->AS_Data.f_LO1 -\r\nf_in) / (state->AS_Data.f_ref / 64) - 8 * (u32) fiffc -\r\n4992;\r\nif (fiffof > 0xFF)\r\nfiffof = 0xFF;\r\nif (status >= 0) {\r\nstate->reg[MT2063_REG_LO1CQ_1] = (u8) (LO1 & 0xFF);\r\nstate->reg[MT2063_REG_LO1CQ_2] = (u8) (Num1 & 0x3F);\r\nstate->reg[MT2063_REG_LO2CQ_1] = (u8) (((LO2 & 0x7F) << 1)\r\n|(Num2 >> 12));\r\nstate->reg[MT2063_REG_LO2CQ_2] = (u8) ((Num2 & 0x0FF0) >> 4);\r\nstate->reg[MT2063_REG_LO2CQ_3] = (u8) (0xE0 | (Num2 & 0x000F));\r\nstatus |= mt2063_write(state, MT2063_REG_LO1CQ_1, &state->reg[MT2063_REG_LO1CQ_1], 5);\r\nif (state->tuner_id == MT2063_B0) {\r\nstatus |= mt2063_write(state, MT2063_REG_LO2CQ_3, &state->reg[MT2063_REG_LO2CQ_3], 1);\r\n}\r\nif (state->reg[MT2063_REG_FIFF_OFFSET] !=\r\n(u8) fiffof) {\r\nstate->reg[MT2063_REG_FIFF_OFFSET] =\r\n(u8) fiffof;\r\nstatus |=\r\nmt2063_write(state,\r\nMT2063_REG_FIFF_OFFSET,\r\n&state->\r\nreg[MT2063_REG_FIFF_OFFSET],\r\n1);\r\n}\r\n}\r\nif (status < 0)\r\nreturn status;\r\nstatus = mt2063_lockStatus(state);\r\nif (status < 0)\r\nreturn status;\r\nif (!status)\r\nreturn -EINVAL;\r\nstate->f_IF1_actual = state->AS_Data.f_LO1 - f_in;\r\n}\r\nreturn status;\r\n}\r\nstatic int mt2063_init(struct dvb_frontend *fe)\r\n{\r\nint status;\r\nstruct mt2063_state *state = fe->tuner_priv;\r\nu8 all_resets = 0xF0;\r\nconst u8 *def = NULL;\r\nchar *step;\r\nu32 FCRUN;\r\ns32 maxReads;\r\nu32 fcu_osc;\r\nu32 i;\r\ndprintk(2, "\n");\r\nstate->rcvr_mode = MT2063_CABLE_QAM;\r\nstatus = mt2063_read(state, MT2063_REG_PART_REV,\r\n&state->reg[MT2063_REG_PART_REV], 1);\r\nif (status < 0) {\r\nprintk(KERN_ERR "Can't read mt2063 part ID\n");\r\nreturn status;\r\n}\r\nswitch (state->reg[MT2063_REG_PART_REV]) {\r\ncase MT2063_B0:\r\nstep = "B0";\r\nbreak;\r\ncase MT2063_B1:\r\nstep = "B1";\r\nbreak;\r\ncase MT2063_B2:\r\nstep = "B2";\r\nbreak;\r\ncase MT2063_B3:\r\nstep = "B3";\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "mt2063: Unknown mt2063 device ID (0x%02x)\n",\r\nstate->reg[MT2063_REG_PART_REV]);\r\nreturn -ENODEV;\r\n}\r\nstatus = mt2063_read(state, MT2063_REG_RSVD_3B,\r\n&state->reg[MT2063_REG_RSVD_3B], 1);\r\nif (status < 0 || ((state->reg[MT2063_REG_RSVD_3B] & 0x80) != 0x00)) {\r\nprintk(KERN_ERR "mt2063: Unknown part ID (0x%02x%02x)\n",\r\nstate->reg[MT2063_REG_PART_REV],\r\nstate->reg[MT2063_REG_RSVD_3B]);\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "mt2063: detected a mt2063 %s\n", step);\r\nstatus = mt2063_write(state, MT2063_REG_LO2CQ_3, &all_resets, 1);\r\nif (status < 0)\r\nreturn status;\r\nswitch (state->reg[MT2063_REG_PART_REV]) {\r\ncase MT2063_B3:\r\ndef = MT2063B3_defaults;\r\nbreak;\r\ncase MT2063_B1:\r\ndef = MT2063B1_defaults;\r\nbreak;\r\ncase MT2063_B0:\r\ndef = MT2063B0_defaults;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\nbreak;\r\n}\r\nwhile (status >= 0 && *def) {\r\nu8 reg = *def++;\r\nu8 val = *def++;\r\nstatus = mt2063_write(state, reg, &val, 1);\r\n}\r\nif (status < 0)\r\nreturn status;\r\nFCRUN = 1;\r\nmaxReads = 10;\r\nwhile (status >= 0 && (FCRUN != 0) && (maxReads-- > 0)) {\r\nmsleep(2);\r\nstatus = mt2063_read(state,\r\nMT2063_REG_XO_STATUS,\r\n&state->\r\nreg[MT2063_REG_XO_STATUS], 1);\r\nFCRUN = (state->reg[MT2063_REG_XO_STATUS] & 0x40) >> 6;\r\n}\r\nif (FCRUN != 0 || status < 0)\r\nreturn -ENODEV;\r\nstatus = mt2063_read(state,\r\nMT2063_REG_FIFFC,\r\n&state->reg[MT2063_REG_FIFFC], 1);\r\nif (status < 0)\r\nreturn status;\r\nstatus = mt2063_read(state,\r\nMT2063_REG_PART_REV,\r\nstate->reg, MT2063_REG_END_REGS);\r\nif (status < 0)\r\nreturn status;\r\nstate->tuner_id = state->reg[MT2063_REG_PART_REV];\r\nstate->AS_Data.f_ref = MT2063_REF_FREQ;\r\nstate->AS_Data.f_if1_Center = (state->AS_Data.f_ref / 8) *\r\n((u32) state->reg[MT2063_REG_FIFFC] + 640);\r\nstate->AS_Data.f_if1_bw = MT2063_IF1_BW;\r\nstate->AS_Data.f_out = 43750000UL;\r\nstate->AS_Data.f_out_bw = 6750000UL;\r\nstate->AS_Data.f_zif_bw = MT2063_ZIF_BW;\r\nstate->AS_Data.f_LO1_Step = state->AS_Data.f_ref / 64;\r\nstate->AS_Data.f_LO2_Step = MT2063_TUNE_STEP_SIZE;\r\nstate->AS_Data.maxH1 = MT2063_MAX_HARMONICS_1;\r\nstate->AS_Data.maxH2 = MT2063_MAX_HARMONICS_2;\r\nstate->AS_Data.f_min_LO_Separation = MT2063_MIN_LO_SEP;\r\nstate->AS_Data.f_if1_Request = state->AS_Data.f_if1_Center;\r\nstate->AS_Data.f_LO1 = 2181000000UL;\r\nstate->AS_Data.f_LO2 = 1486249786UL;\r\nstate->f_IF1_actual = state->AS_Data.f_if1_Center;\r\nstate->AS_Data.f_in = state->AS_Data.f_LO1 - state->f_IF1_actual;\r\nstate->AS_Data.f_LO1_FracN_Avoid = MT2063_LO1_FRACN_AVOID;\r\nstate->AS_Data.f_LO2_FracN_Avoid = MT2063_LO2_FRACN_AVOID;\r\nstate->num_regs = MT2063_REG_END_REGS;\r\nstate->AS_Data.avoidDECT = MT2063_AVOID_BOTH;\r\nstate->ctfilt_sw = 0;\r\nstate->CTFiltMax[0] = 69230000;\r\nstate->CTFiltMax[1] = 105770000;\r\nstate->CTFiltMax[2] = 140350000;\r\nstate->CTFiltMax[3] = 177110000;\r\nstate->CTFiltMax[4] = 212860000;\r\nstate->CTFiltMax[5] = 241130000;\r\nstate->CTFiltMax[6] = 274370000;\r\nstate->CTFiltMax[7] = 309820000;\r\nstate->CTFiltMax[8] = 342450000;\r\nstate->CTFiltMax[9] = 378870000;\r\nstate->CTFiltMax[10] = 416210000;\r\nstate->CTFiltMax[11] = 456500000;\r\nstate->CTFiltMax[12] = 495790000;\r\nstate->CTFiltMax[13] = 534530000;\r\nstate->CTFiltMax[14] = 572610000;\r\nstate->CTFiltMax[15] = 598970000;\r\nstate->CTFiltMax[16] = 635910000;\r\nstate->CTFiltMax[17] = 672130000;\r\nstate->CTFiltMax[18] = 714840000;\r\nstate->CTFiltMax[19] = 739660000;\r\nstate->CTFiltMax[20] = 770410000;\r\nstate->CTFiltMax[21] = 814660000;\r\nstate->CTFiltMax[22] = 846950000;\r\nstate->CTFiltMax[23] = 867820000;\r\nstate->CTFiltMax[24] = 915980000;\r\nstate->CTFiltMax[25] = 947450000;\r\nstate->CTFiltMax[26] = 983110000;\r\nstate->CTFiltMax[27] = 1021630000;\r\nstate->CTFiltMax[28] = 1061870000;\r\nstate->CTFiltMax[29] = 1098330000;\r\nstate->CTFiltMax[30] = 1138990000;\r\nstate->reg[MT2063_REG_CTUNE_CTRL] = 0x0A;\r\nstatus = mt2063_write(state, MT2063_REG_CTUNE_CTRL,\r\n&state->reg[MT2063_REG_CTUNE_CTRL], 1);\r\nif (status < 0)\r\nreturn status;\r\nstatus = mt2063_read(state, MT2063_REG_FIFFC,\r\n&state->reg[MT2063_REG_FIFFC], 1);\r\nif (status < 0)\r\nreturn status;\r\nfcu_osc = state->reg[MT2063_REG_FIFFC];\r\nstate->reg[MT2063_REG_CTUNE_CTRL] = 0x00;\r\nstatus = mt2063_write(state, MT2063_REG_CTUNE_CTRL,\r\n&state->reg[MT2063_REG_CTUNE_CTRL], 1);\r\nif (status < 0)\r\nreturn status;\r\nfor (i = 0; i < 31; i++)\r\nstate->CTFiltMax[i] = (state->CTFiltMax[i] / 768) * (fcu_osc + 640);\r\nstatus = MT2063_SoftwareShutdown(state, 1);\r\nif (status < 0)\r\nreturn status;\r\nstatus = MT2063_ClearPowerMaskBits(state, MT2063_ALL_SD);\r\nif (status < 0)\r\nreturn status;\r\nstate->init = true;\r\nreturn 0;\r\n}\r\nstatic int mt2063_get_status(struct dvb_frontend *fe, u32 *tuner_status)\r\n{\r\nstruct mt2063_state *state = fe->tuner_priv;\r\nint status;\r\ndprintk(2, "\n");\r\nif (!state->init)\r\nreturn -ENODEV;\r\n*tuner_status = 0;\r\nstatus = mt2063_lockStatus(state);\r\nif (status < 0)\r\nreturn status;\r\nif (status)\r\n*tuner_status = TUNER_STATUS_LOCKED;\r\ndprintk(1, "Tuner status: %d", *tuner_status);\r\nreturn 0;\r\n}\r\nstatic int mt2063_release(struct dvb_frontend *fe)\r\n{\r\nstruct mt2063_state *state = fe->tuner_priv;\r\ndprintk(2, "\n");\r\nfe->tuner_priv = NULL;\r\nkfree(state);\r\nreturn 0;\r\n}\r\nstatic int mt2063_set_analog_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct mt2063_state *state = fe->tuner_priv;\r\ns32 pict_car;\r\ns32 pict2chanb_vsb;\r\ns32 ch_bw;\r\ns32 if_mid;\r\ns32 rcvr_mode;\r\nint status;\r\ndprintk(2, "\n");\r\nif (!state->init) {\r\nstatus = mt2063_init(fe);\r\nif (status < 0)\r\nreturn status;\r\n}\r\nswitch (params->mode) {\r\ncase V4L2_TUNER_RADIO:\r\npict_car = 38900000;\r\nch_bw = 8000000;\r\npict2chanb_vsb = -(ch_bw / 2);\r\nrcvr_mode = MT2063_OFFAIR_ANALOG;\r\nbreak;\r\ncase V4L2_TUNER_ANALOG_TV:\r\nrcvr_mode = MT2063_CABLE_ANALOG;\r\nif (params->std & ~V4L2_STD_MN) {\r\npict_car = 38900000;\r\nch_bw = 6000000;\r\npict2chanb_vsb = -1250000;\r\n} else if (params->std & V4L2_STD_PAL_G) {\r\npict_car = 38900000;\r\nch_bw = 7000000;\r\npict2chanb_vsb = -1250000;\r\n} else {\r\npict_car = 38900000;\r\nch_bw = 8000000;\r\npict2chanb_vsb = -1250000;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif_mid = pict_car - (pict2chanb_vsb + (ch_bw / 2));\r\nstate->AS_Data.f_LO2_Step = 125000;\r\nstate->AS_Data.f_out = if_mid;\r\nstate->AS_Data.f_out_bw = ch_bw + 750000;\r\nstatus = MT2063_SetReceiverMode(state, rcvr_mode);\r\nif (status < 0)\r\nreturn status;\r\ndprintk(1, "Tuning to frequency: %d, bandwidth %d, foffset %d\n",\r\nparams->frequency, ch_bw, pict2chanb_vsb);\r\nstatus = MT2063_Tune(state, (params->frequency + (pict2chanb_vsb + (ch_bw / 2))));\r\nif (status < 0)\r\nreturn status;\r\nstate->frequency = params->frequency;\r\nreturn 0;\r\n}\r\nstatic int mt2063_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct mt2063_state *state = fe->tuner_priv;\r\nint status;\r\ns32 pict_car;\r\ns32 pict2chanb_vsb;\r\ns32 ch_bw;\r\ns32 if_mid;\r\ns32 rcvr_mode;\r\nif (!state->init) {\r\nstatus = mt2063_init(fe);\r\nif (status < 0)\r\nreturn status;\r\n}\r\ndprintk(2, "\n");\r\nif (c->bandwidth_hz == 0)\r\nreturn -EINVAL;\r\nif (c->bandwidth_hz <= 6000000)\r\nch_bw = 6000000;\r\nelse if (c->bandwidth_hz <= 7000000)\r\nch_bw = 7000000;\r\nelse\r\nch_bw = 8000000;\r\nswitch (c->delivery_system) {\r\ncase SYS_DVBT:\r\nrcvr_mode = MT2063_OFFAIR_COFDM;\r\npict_car = 36125000;\r\npict2chanb_vsb = -(ch_bw / 2);\r\nbreak;\r\ncase SYS_DVBC_ANNEX_A:\r\ncase SYS_DVBC_ANNEX_C:\r\nrcvr_mode = MT2063_CABLE_QAM;\r\npict_car = 36125000;\r\npict2chanb_vsb = -(ch_bw / 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif_mid = pict_car - (pict2chanb_vsb + (ch_bw / 2));\r\nstate->AS_Data.f_LO2_Step = 125000;\r\nstate->AS_Data.f_out = if_mid;\r\nstate->AS_Data.f_out_bw = ch_bw + 750000;\r\nstatus = MT2063_SetReceiverMode(state, rcvr_mode);\r\nif (status < 0)\r\nreturn status;\r\ndprintk(1, "Tuning to frequency: %d, bandwidth %d, foffset %d\n",\r\nc->frequency, ch_bw, pict2chanb_vsb);\r\nstatus = MT2063_Tune(state, (c->frequency + (pict2chanb_vsb + (ch_bw / 2))));\r\nif (status < 0)\r\nreturn status;\r\nstate->frequency = c->frequency;\r\nreturn 0;\r\n}\r\nstatic int mt2063_get_if_frequency(struct dvb_frontend *fe, u32 *freq)\r\n{\r\nstruct mt2063_state *state = fe->tuner_priv;\r\ndprintk(2, "\n");\r\nif (!state->init)\r\nreturn -ENODEV;\r\n*freq = state->AS_Data.f_out;\r\ndprintk(1, "IF frequency: %d\n", *freq);\r\nreturn 0;\r\n}\r\nstatic int mt2063_get_bandwidth(struct dvb_frontend *fe, u32 *bw)\r\n{\r\nstruct mt2063_state *state = fe->tuner_priv;\r\ndprintk(2, "\n");\r\nif (!state->init)\r\nreturn -ENODEV;\r\n*bw = state->AS_Data.f_out_bw - 750000;\r\ndprintk(1, "bandwidth: %d\n", *bw);\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *mt2063_attach(struct dvb_frontend *fe,\r\nstruct mt2063_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct mt2063_state *state = NULL;\r\ndprintk(2, "\n");\r\nstate = kzalloc(sizeof(struct mt2063_state), GFP_KERNEL);\r\nif (!state)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->frontend = fe;\r\nstate->reference = config->refclock / 1000;\r\nfe->tuner_priv = state;\r\nfe->ops.tuner_ops = mt2063_ops;\r\nprintk(KERN_INFO "%s: Attaching MT2063\n", __func__);\r\nreturn fe;\r\n}

static void h3a_aewb_setup_regs(struct ispstat *aewb, void *priv)\r\n{\r\nstruct omap3isp_h3a_aewb_config *conf = priv;\r\nu32 pcr;\r\nu32 win1;\r\nu32 start;\r\nu32 blk;\r\nu32 subwin;\r\nif (aewb->state == ISPSTAT_DISABLED)\r\nreturn;\r\nisp_reg_writel(aewb->isp, aewb->active_buf->dma_addr,\r\nOMAP3_ISP_IOMEM_H3A, ISPH3A_AEWBUFST);\r\nif (!aewb->update)\r\nreturn;\r\npcr = conf->saturation_limit << ISPH3A_PCR_AEW_AVE2LMT_SHIFT;\r\npcr |= !!conf->alaw_enable << ISPH3A_PCR_AEW_ALAW_EN_SHIFT;\r\nwin1 = ((conf->win_height >> 1) - 1) << ISPH3A_AEWWIN1_WINH_SHIFT;\r\nwin1 |= ((conf->win_width >> 1) - 1) << ISPH3A_AEWWIN1_WINW_SHIFT;\r\nwin1 |= (conf->ver_win_count - 1) << ISPH3A_AEWWIN1_WINVC_SHIFT;\r\nwin1 |= (conf->hor_win_count - 1) << ISPH3A_AEWWIN1_WINHC_SHIFT;\r\nstart = conf->hor_win_start << ISPH3A_AEWINSTART_WINSH_SHIFT;\r\nstart |= conf->ver_win_start << ISPH3A_AEWINSTART_WINSV_SHIFT;\r\nblk = conf->blk_ver_win_start << ISPH3A_AEWINBLK_WINSV_SHIFT;\r\nblk |= ((conf->blk_win_height >> 1) - 1) << ISPH3A_AEWINBLK_WINH_SHIFT;\r\nsubwin = ((conf->subsample_ver_inc >> 1) - 1) <<\r\nISPH3A_AEWSUBWIN_AEWINCV_SHIFT;\r\nsubwin |= ((conf->subsample_hor_inc >> 1) - 1) <<\r\nISPH3A_AEWSUBWIN_AEWINCH_SHIFT;\r\nisp_reg_writel(aewb->isp, win1, OMAP3_ISP_IOMEM_H3A, ISPH3A_AEWWIN1);\r\nisp_reg_writel(aewb->isp, start, OMAP3_ISP_IOMEM_H3A,\r\nISPH3A_AEWINSTART);\r\nisp_reg_writel(aewb->isp, blk, OMAP3_ISP_IOMEM_H3A, ISPH3A_AEWINBLK);\r\nisp_reg_writel(aewb->isp, subwin, OMAP3_ISP_IOMEM_H3A,\r\nISPH3A_AEWSUBWIN);\r\nisp_reg_clr_set(aewb->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nISPH3A_PCR_AEW_MASK, pcr);\r\naewb->update = 0;\r\naewb->config_counter += aewb->inc_config;\r\naewb->inc_config = 0;\r\naewb->buf_size = conf->buf_size;\r\n}\r\nstatic void h3a_aewb_enable(struct ispstat *aewb, int enable)\r\n{\r\nif (enable) {\r\nisp_reg_set(aewb->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nISPH3A_PCR_AEW_EN);\r\nomap3isp_subclk_enable(aewb->isp, OMAP3_ISP_SUBCLK_AEWB);\r\n} else {\r\nisp_reg_clr(aewb->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nISPH3A_PCR_AEW_EN);\r\nomap3isp_subclk_disable(aewb->isp, OMAP3_ISP_SUBCLK_AEWB);\r\n}\r\n}\r\nstatic int h3a_aewb_busy(struct ispstat *aewb)\r\n{\r\nreturn isp_reg_readl(aewb->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR)\r\n& ISPH3A_PCR_BUSYAEAWB;\r\n}\r\nstatic u32 h3a_aewb_get_buf_size(struct omap3isp_h3a_aewb_config *conf)\r\n{\r\nu32 win_count = (conf->ver_win_count + 1) * conf->hor_win_count;\r\nwin_count += (win_count + 7) / 8;\r\nreturn win_count * AEWB_PACKET_SIZE;\r\n}\r\nstatic int h3a_aewb_validate_params(struct ispstat *aewb, void *new_conf)\r\n{\r\nstruct omap3isp_h3a_aewb_config *user_cfg = new_conf;\r\nu32 buf_size;\r\nif (unlikely(user_cfg->saturation_limit >\r\nOMAP3ISP_AEWB_MAX_SATURATION_LIM))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->win_height < OMAP3ISP_AEWB_MIN_WIN_H ||\r\nuser_cfg->win_height > OMAP3ISP_AEWB_MAX_WIN_H ||\r\nuser_cfg->win_height & 0x01))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->win_width < OMAP3ISP_AEWB_MIN_WIN_W ||\r\nuser_cfg->win_width > OMAP3ISP_AEWB_MAX_WIN_W ||\r\nuser_cfg->win_width & 0x01))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->ver_win_count < OMAP3ISP_AEWB_MIN_WINVC ||\r\nuser_cfg->ver_win_count > OMAP3ISP_AEWB_MAX_WINVC))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->hor_win_count < OMAP3ISP_AEWB_MIN_WINHC ||\r\nuser_cfg->hor_win_count > OMAP3ISP_AEWB_MAX_WINHC))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->ver_win_start > OMAP3ISP_AEWB_MAX_WINSTART))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->hor_win_start > OMAP3ISP_AEWB_MAX_WINSTART))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->blk_ver_win_start > OMAP3ISP_AEWB_MAX_WINSTART))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->blk_win_height < OMAP3ISP_AEWB_MIN_WIN_H ||\r\nuser_cfg->blk_win_height > OMAP3ISP_AEWB_MAX_WIN_H ||\r\nuser_cfg->blk_win_height & 0x01))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->subsample_ver_inc < OMAP3ISP_AEWB_MIN_SUB_INC ||\r\nuser_cfg->subsample_ver_inc > OMAP3ISP_AEWB_MAX_SUB_INC ||\r\nuser_cfg->subsample_ver_inc & 0x01))\r\nreturn -EINVAL;\r\nif (unlikely(user_cfg->subsample_hor_inc < OMAP3ISP_AEWB_MIN_SUB_INC ||\r\nuser_cfg->subsample_hor_inc > OMAP3ISP_AEWB_MAX_SUB_INC ||\r\nuser_cfg->subsample_hor_inc & 0x01))\r\nreturn -EINVAL;\r\nbuf_size = h3a_aewb_get_buf_size(user_cfg);\r\nif (buf_size > user_cfg->buf_size)\r\nuser_cfg->buf_size = buf_size;\r\nelse if (user_cfg->buf_size > OMAP3ISP_AEWB_MAX_BUF_SIZE)\r\nuser_cfg->buf_size = OMAP3ISP_AEWB_MAX_BUF_SIZE;\r\nreturn 0;\r\n}\r\nstatic void h3a_aewb_set_params(struct ispstat *aewb, void *new_conf)\r\n{\r\nstruct omap3isp_h3a_aewb_config *user_cfg = new_conf;\r\nstruct omap3isp_h3a_aewb_config *cur_cfg = aewb->priv;\r\nint update = 0;\r\nif (cur_cfg->saturation_limit != user_cfg->saturation_limit) {\r\ncur_cfg->saturation_limit = user_cfg->saturation_limit;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->alaw_enable != user_cfg->alaw_enable) {\r\ncur_cfg->alaw_enable = user_cfg->alaw_enable;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->win_height != user_cfg->win_height) {\r\ncur_cfg->win_height = user_cfg->win_height;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->win_width != user_cfg->win_width) {\r\ncur_cfg->win_width = user_cfg->win_width;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->ver_win_count != user_cfg->ver_win_count) {\r\ncur_cfg->ver_win_count = user_cfg->ver_win_count;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->hor_win_count != user_cfg->hor_win_count) {\r\ncur_cfg->hor_win_count = user_cfg->hor_win_count;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->ver_win_start != user_cfg->ver_win_start) {\r\ncur_cfg->ver_win_start = user_cfg->ver_win_start;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->hor_win_start != user_cfg->hor_win_start) {\r\ncur_cfg->hor_win_start = user_cfg->hor_win_start;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->blk_ver_win_start != user_cfg->blk_ver_win_start) {\r\ncur_cfg->blk_ver_win_start = user_cfg->blk_ver_win_start;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->blk_win_height != user_cfg->blk_win_height) {\r\ncur_cfg->blk_win_height = user_cfg->blk_win_height;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->subsample_ver_inc != user_cfg->subsample_ver_inc) {\r\ncur_cfg->subsample_ver_inc = user_cfg->subsample_ver_inc;\r\nupdate = 1;\r\n}\r\nif (cur_cfg->subsample_hor_inc != user_cfg->subsample_hor_inc) {\r\ncur_cfg->subsample_hor_inc = user_cfg->subsample_hor_inc;\r\nupdate = 1;\r\n}\r\nif (update || !aewb->configured) {\r\naewb->inc_config++;\r\naewb->update = 1;\r\ncur_cfg->buf_size = h3a_aewb_get_buf_size(cur_cfg);\r\n}\r\n}\r\nstatic long h3a_aewb_ioctl(struct v4l2_subdev *sd, unsigned int cmd, void *arg)\r\n{\r\nstruct ispstat *stat = v4l2_get_subdevdata(sd);\r\nswitch (cmd) {\r\ncase VIDIOC_OMAP3ISP_AEWB_CFG:\r\nreturn omap3isp_stat_config(stat, arg);\r\ncase VIDIOC_OMAP3ISP_STAT_REQ:\r\nreturn omap3isp_stat_request_statistics(stat, arg);\r\ncase VIDIOC_OMAP3ISP_STAT_EN: {\r\nunsigned long *en = arg;\r\nreturn omap3isp_stat_enable(stat, !!*en);\r\n}\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}\r\nint omap3isp_h3a_aewb_init(struct isp_device *isp)\r\n{\r\nstruct ispstat *aewb = &isp->isp_aewb;\r\nstruct omap3isp_h3a_aewb_config *aewb_cfg;\r\nstruct omap3isp_h3a_aewb_config *aewb_recover_cfg;\r\naewb_cfg = devm_kzalloc(isp->dev, sizeof(*aewb_cfg), GFP_KERNEL);\r\nif (!aewb_cfg)\r\nreturn -ENOMEM;\r\naewb->ops = &h3a_aewb_ops;\r\naewb->priv = aewb_cfg;\r\naewb->event_type = V4L2_EVENT_OMAP3ISP_AEWB;\r\naewb->isp = isp;\r\naewb_recover_cfg = devm_kzalloc(isp->dev, sizeof(*aewb_recover_cfg),\r\nGFP_KERNEL);\r\nif (!aewb_recover_cfg) {\r\ndev_err(aewb->isp->dev, "AEWB: cannot allocate memory for "\r\n"recover configuration.\n");\r\nreturn -ENOMEM;\r\n}\r\naewb_recover_cfg->saturation_limit = OMAP3ISP_AEWB_MAX_SATURATION_LIM;\r\naewb_recover_cfg->win_height = OMAP3ISP_AEWB_MIN_WIN_H;\r\naewb_recover_cfg->win_width = OMAP3ISP_AEWB_MIN_WIN_W;\r\naewb_recover_cfg->ver_win_count = OMAP3ISP_AEWB_MIN_WINVC;\r\naewb_recover_cfg->hor_win_count = OMAP3ISP_AEWB_MIN_WINHC;\r\naewb_recover_cfg->blk_ver_win_start = aewb_recover_cfg->ver_win_start +\r\naewb_recover_cfg->win_height * aewb_recover_cfg->ver_win_count;\r\naewb_recover_cfg->blk_win_height = OMAP3ISP_AEWB_MIN_WIN_H;\r\naewb_recover_cfg->subsample_ver_inc = OMAP3ISP_AEWB_MIN_SUB_INC;\r\naewb_recover_cfg->subsample_hor_inc = OMAP3ISP_AEWB_MIN_SUB_INC;\r\nif (h3a_aewb_validate_params(aewb, aewb_recover_cfg)) {\r\ndev_err(aewb->isp->dev, "AEWB: recover configuration is "\r\n"invalid.\n");\r\nreturn -EINVAL;\r\n}\r\naewb_recover_cfg->buf_size = h3a_aewb_get_buf_size(aewb_recover_cfg);\r\naewb->recover_priv = aewb_recover_cfg;\r\nreturn omap3isp_stat_init(aewb, "AEWB", &h3a_aewb_subdev_ops);\r\n}\r\nvoid omap3isp_h3a_aewb_cleanup(struct isp_device *isp)\r\n{\r\nomap3isp_stat_cleanup(&isp->isp_aewb);\r\n}

static irqreturn_t pps_gpio_irq_handler(int irq, void *data)\r\n{\r\nconst struct pps_gpio_device_data *info;\r\nstruct pps_event_time ts;\r\nint rising_edge;\r\npps_get_ts(&ts);\r\ninfo = data;\r\nrising_edge = gpio_get_value(info->gpio_pin);\r\nif ((rising_edge && !info->assert_falling_edge) ||\r\n(!rising_edge && info->assert_falling_edge))\r\npps_event(info->pps, &ts, PPS_CAPTUREASSERT, NULL);\r\nelse if (info->capture_clear &&\r\n((rising_edge && info->assert_falling_edge) ||\r\n(!rising_edge && !info->assert_falling_edge)))\r\npps_event(info->pps, &ts, PPS_CAPTURECLEAR, NULL);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic unsigned long\r\nget_irqf_trigger_flags(const struct pps_gpio_device_data *data)\r\n{\r\nunsigned long flags = data->assert_falling_edge ?\r\nIRQF_TRIGGER_FALLING : IRQF_TRIGGER_RISING;\r\nif (data->capture_clear) {\r\nflags |= ((flags & IRQF_TRIGGER_RISING) ?\r\nIRQF_TRIGGER_FALLING : IRQF_TRIGGER_RISING);\r\n}\r\nreturn flags;\r\n}\r\nstatic int pps_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct pps_gpio_device_data *data;\r\nconst char *gpio_label;\r\nint ret;\r\nint pps_default_params;\r\nconst struct pps_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nstruct device_node *np = pdev->dev.of_node;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct pps_gpio_device_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (pdata) {\r\ndata->gpio_pin = pdata->gpio_pin;\r\ngpio_label = pdata->gpio_label;\r\ndata->assert_falling_edge = pdata->assert_falling_edge;\r\ndata->capture_clear = pdata->capture_clear;\r\n} else {\r\nret = of_get_gpio(np, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to get GPIO from device tree\n");\r\nreturn ret;\r\n}\r\ndata->gpio_pin = ret;\r\ngpio_label = PPS_GPIO_NAME;\r\nif (of_get_property(np, "assert-falling-edge", NULL))\r\ndata->assert_falling_edge = true;\r\n}\r\nret = devm_gpio_request(&pdev->dev, data->gpio_pin, gpio_label);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to request GPIO %u\n",\r\ndata->gpio_pin);\r\nreturn ret;\r\n}\r\nret = gpio_direction_input(data->gpio_pin);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to set pin direction\n");\r\nreturn -EINVAL;\r\n}\r\nret = gpio_to_irq(data->gpio_pin);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to map GPIO to IRQ: %d\n", ret);\r\nreturn -EINVAL;\r\n}\r\ndata->irq = ret;\r\ndata->info.mode = PPS_CAPTUREASSERT | PPS_OFFSETASSERT |\r\nPPS_ECHOASSERT | PPS_CANWAIT | PPS_TSFMT_TSPEC;\r\nif (data->capture_clear)\r\ndata->info.mode |= PPS_CAPTURECLEAR | PPS_OFFSETCLEAR |\r\nPPS_ECHOCLEAR;\r\ndata->info.owner = THIS_MODULE;\r\nsnprintf(data->info.name, PPS_MAX_NAME_LEN - 1, "%s.%d",\r\npdev->name, pdev->id);\r\npps_default_params = PPS_CAPTUREASSERT | PPS_OFFSETASSERT;\r\nif (data->capture_clear)\r\npps_default_params |= PPS_CAPTURECLEAR | PPS_OFFSETCLEAR;\r\ndata->pps = pps_register_source(&data->info, pps_default_params);\r\nif (data->pps == NULL) {\r\ndev_err(&pdev->dev, "failed to register IRQ %d as PPS source\n",\r\ndata->irq);\r\nreturn -EINVAL;\r\n}\r\nret = devm_request_irq(&pdev->dev, data->irq, pps_gpio_irq_handler,\r\nget_irqf_trigger_flags(data), data->info.name, data);\r\nif (ret) {\r\npps_unregister_source(data->pps);\r\ndev_err(&pdev->dev, "failed to acquire IRQ %d\n", data->irq);\r\nreturn -EINVAL;\r\n}\r\nplatform_set_drvdata(pdev, data);\r\ndev_info(data->pps->dev, "Registered IRQ %d as PPS source\n",\r\ndata->irq);\r\nreturn 0;\r\n}\r\nstatic int pps_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct pps_gpio_device_data *data = platform_get_drvdata(pdev);\r\npps_unregister_source(data->pps);\r\ndev_info(&pdev->dev, "removed IRQ %d as PPS source\n", data->irq);\r\nreturn 0;\r\n}

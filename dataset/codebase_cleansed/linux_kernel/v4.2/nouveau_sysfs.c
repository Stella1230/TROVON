static inline struct drm_device *\r\ndrm_device(struct device *d)\r\n{\r\nreturn dev_get_drvdata(d);\r\n}\r\nstatic ssize_t\r\nnouveau_sysfs_pstate_get(struct device *d, struct device_attribute *a, char *b)\r\n{\r\nstruct nouveau_sysfs *sysfs = nouveau_sysfs(drm_device(d));\r\nstruct nvif_control_pstate_info_v0 info = {};\r\nsize_t cnt = PAGE_SIZE;\r\nchar *buf = b;\r\nint ret, i;\r\nret = nvif_mthd(&sysfs->ctrl, NVIF_CONTROL_PSTATE_INFO,\r\n&info, sizeof(info));\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < info.count + 1; i++) {\r\nconst s32 state = i < info.count ? i :\r\nNVIF_CONTROL_PSTATE_ATTR_V0_STATE_CURRENT;\r\nstruct nvif_control_pstate_attr_v0 attr = {\r\n.state = state,\r\n.index = 0,\r\n};\r\nret = nvif_mthd(&sysfs->ctrl, NVIF_CONTROL_PSTATE_ATTR,\r\n&attr, sizeof(attr));\r\nif (ret)\r\nreturn ret;\r\nif (i < info.count)\r\nsnappendf(buf, cnt, "%02x:", attr.state);\r\nelse\r\nsnappendf(buf, cnt, "%s:", info.pwrsrc == 0 ? "DC" :\r\ninfo.pwrsrc == 1 ? "AC" :\r\n"--");\r\nattr.index = 0;\r\ndo {\r\nattr.state = state;\r\nret = nvif_mthd(&sysfs->ctrl,\r\nNVIF_CONTROL_PSTATE_ATTR,\r\n&attr, sizeof(attr));\r\nif (ret)\r\nreturn ret;\r\nsnappendf(buf, cnt, " %s %d", attr.name, attr.min);\r\nif (attr.min != attr.max)\r\nsnappendf(buf, cnt, "-%d", attr.max);\r\nsnappendf(buf, cnt, " %s", attr.unit);\r\n} while (attr.index);\r\nif (state >= 0) {\r\nif (info.ustate_ac == state)\r\nsnappendf(buf, cnt, " AC");\r\nif (info.ustate_dc == state)\r\nsnappendf(buf, cnt, " DC");\r\nif (info.pstate == state)\r\nsnappendf(buf, cnt, " *");\r\n} else {\r\nif (info.ustate_ac < -1)\r\nsnappendf(buf, cnt, " AC");\r\nif (info.ustate_dc < -1)\r\nsnappendf(buf, cnt, " DC");\r\n}\r\nsnappendf(buf, cnt, "\n");\r\n}\r\nreturn strlen(b);\r\n}\r\nstatic ssize_t\r\nnouveau_sysfs_pstate_set(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct nouveau_sysfs *sysfs = nouveau_sysfs(drm_device(d));\r\nstruct nvif_control_pstate_user_v0 args = { .pwrsrc = -EINVAL };\r\nlong value, ret;\r\nchar *tmp;\r\nif ((tmp = strchr(buf, '\n')))\r\n*tmp = '\0';\r\nif (!strncasecmp(buf, "dc:", 3)) {\r\nargs.pwrsrc = 0;\r\nbuf += 3;\r\n} else\r\nif (!strncasecmp(buf, "ac:", 3)) {\r\nargs.pwrsrc = 1;\r\nbuf += 3;\r\n}\r\nif (!strcasecmp(buf, "none"))\r\nargs.ustate = NVIF_CONTROL_PSTATE_USER_V0_STATE_UNKNOWN;\r\nelse\r\nif (!strcasecmp(buf, "auto"))\r\nargs.ustate = NVIF_CONTROL_PSTATE_USER_V0_STATE_PERFMON;\r\nelse {\r\nret = kstrtol(buf, 16, &value);\r\nif (ret)\r\nreturn ret;\r\nargs.ustate = value;\r\n}\r\nret = nvif_mthd(&sysfs->ctrl, NVIF_CONTROL_PSTATE_USER,\r\n&args, sizeof(args));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nvoid\r\nnouveau_sysfs_fini(struct drm_device *dev)\r\n{\r\nstruct nouveau_sysfs *sysfs = nouveau_sysfs(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvif_device *device = &drm->device;\r\nif (sysfs && sysfs->ctrl.priv) {\r\ndevice_remove_file(nv_device_base(nvxx_device(device)), &dev_attr_pstate);\r\nnvif_object_fini(&sysfs->ctrl);\r\n}\r\ndrm->sysfs = NULL;\r\nkfree(sysfs);\r\n}\r\nint\r\nnouveau_sysfs_init(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvif_device *device = &drm->device;\r\nstruct nouveau_sysfs *sysfs;\r\nint ret;\r\nif (!nouveau_pstate)\r\nreturn 0;\r\nsysfs = drm->sysfs = kzalloc(sizeof(*sysfs), GFP_KERNEL);\r\nif (!sysfs)\r\nreturn -ENOMEM;\r\nret = nvif_object_init(nvif_object(device), NULL, NVDRM_CONTROL,\r\nNVIF_IOCTL_NEW_V0_CONTROL, NULL, 0,\r\n&sysfs->ctrl);\r\nif (ret == 0)\r\ndevice_create_file(nv_device_base(nvxx_device(device)), &dev_attr_pstate);\r\nreturn 0;\r\n}

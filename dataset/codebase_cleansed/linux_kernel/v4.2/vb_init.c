static unsigned char\r\nXGINew_GetXG20DRAMType(struct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char data, temp;\r\nif (HwDeviceExtension->jChipType < XG20) {\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x39) & 0x02;\r\nif (data == 0)\r\ndata = (xgifb_reg_get(pVBInfo->P3c4, 0x3A) &\r\n0x02) >> 1;\r\nreturn data;\r\n} else if (HwDeviceExtension->jChipType == XG27) {\r\ntemp = xgifb_reg_get(pVBInfo->P3c4, 0x3B);\r\nif (((temp & 0x88) == 0x80) || ((temp & 0x88) == 0x08))\r\ndata = 0;\r\nelse\r\ndata = 1;\r\nreturn data;\r\n} else if (HwDeviceExtension->jChipType == XG21) {\r\nxgifb_reg_and(pVBInfo->P3d4, 0xB4, ~0x02);\r\nudelay(800);\r\nxgifb_reg_or(pVBInfo->P3d4, 0x4A, 0x80);\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\ndata &= 0x01;\r\nxgifb_reg_or(pVBInfo->P3d4, 0xB4, 0x02);\r\nreturn data;\r\n}\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x97) & 0x01;\r\nif (data == 1)\r\ndata++;\r\nreturn data;\r\n}\r\nstatic void XGINew_DDR1x_MRS_340(unsigned long P3c4,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_set(P3c4, 0x18, 0x01);\r\nxgifb_reg_set(P3c4, 0x19, 0x20);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x80);\r\nmdelay(3);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x20);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x80);\r\nudelay(60);\r\nxgifb_reg_set(P3c4, 0x18, pVBInfo->SR18[pVBInfo->ram_type]);\r\nxgifb_reg_set(P3c4, 0x19, 0x01);\r\nxgifb_reg_set(P3c4, 0x16, 0x03);\r\nxgifb_reg_set(P3c4, 0x16, 0x83);\r\nmdelay(1);\r\nxgifb_reg_set(P3c4, 0x1B, 0x03);\r\nudelay(500);\r\nxgifb_reg_set(P3c4, 0x18, pVBInfo->SR18[pVBInfo->ram_type]);\r\nxgifb_reg_set(P3c4, 0x19, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x03);\r\nxgifb_reg_set(P3c4, 0x16, 0x83);\r\nxgifb_reg_set(P3c4, 0x1B, 0x00);\r\n}\r\nstatic void XGINew_SetMemoryClock(struct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x28,\r\npVBInfo->MCLKData[pVBInfo->ram_type].SR28);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x29,\r\npVBInfo->MCLKData[pVBInfo->ram_type].SR29);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x2A,\r\npVBInfo->MCLKData[pVBInfo->ram_type].SR2A);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x2E,\r\nXGI340_ECLKData[pVBInfo->ram_type].SR2E);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x2F,\r\nXGI340_ECLKData[pVBInfo->ram_type].SR2F);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x30,\r\nXGI340_ECLKData[pVBInfo->ram_type].SR30);\r\n}\r\nstatic void XGINew_DDRII_Bootup_XG27(\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned long P3c4, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned long P3d4 = P3c4 + 0x10;\r\npVBInfo->ram_type = XGINew_GetXG20DRAMType(HwDeviceExtension, pVBInfo);\r\nXGINew_SetMemoryClock(pVBInfo);\r\nxgifb_reg_set(P3d4, 0x97, pVBInfo->XGINew_CR97);\r\nudelay(200);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x80);\r\nxgifb_reg_set(P3c4, 0x16, 0x20);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x16, 0xA0);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0xC0);\r\nxgifb_reg_set(P3c4, 0x16, 0x20);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x16, 0xA0);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x40);\r\nxgifb_reg_set(P3c4, 0x16, 0x20);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x16, 0xA0);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x18, 0x42);\r\nxgifb_reg_set(P3c4, 0x19, 0x0A);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x80);\r\nxgifb_reg_set(P3c4, 0x1B, 0x04);\r\nudelay(60);\r\nxgifb_reg_set(P3c4, 0x1B, 0x00);\r\nxgifb_reg_set(P3c4, 0x18, 0x42);\r\nxgifb_reg_set(P3c4, 0x19, 0x08);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x16, 0x83);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x18, 0x80);\r\nxgifb_reg_set(P3c4, 0x19, 0x46);\r\nxgifb_reg_set(P3c4, 0x16, 0x20);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x16, 0xA0);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x40);\r\nxgifb_reg_set(P3c4, 0x16, 0x20);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x16, 0xA0);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x1B, 0x04);\r\nudelay(200);\r\n}\r\nstatic void XGINew_DDR2_MRS_XG20(struct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned long P3c4, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned long P3d4 = P3c4 + 0x10;\r\npVBInfo->ram_type = XGINew_GetXG20DRAMType(HwDeviceExtension, pVBInfo);\r\nXGINew_SetMemoryClock(pVBInfo);\r\nxgifb_reg_set(P3d4, 0x97, 0x11);\r\nudelay(200);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x80);\r\nxgifb_reg_set(P3c4, 0x16, 0x05);\r\nxgifb_reg_set(P3c4, 0x16, 0x85);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0xC0);\r\nxgifb_reg_set(P3c4, 0x16, 0x05);\r\nxgifb_reg_set(P3c4, 0x16, 0x85);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x40);\r\nxgifb_reg_set(P3c4, 0x16, 0x05);\r\nxgifb_reg_set(P3c4, 0x16, 0x85);\r\nxgifb_reg_set(P3c4, 0x18, 0x42);\r\nxgifb_reg_set(P3c4, 0x19, 0x02);\r\nxgifb_reg_set(P3c4, 0x16, 0x05);\r\nxgifb_reg_set(P3c4, 0x16, 0x85);\r\nudelay(15);\r\nxgifb_reg_set(P3c4, 0x1B, 0x04);\r\nudelay(30);\r\nxgifb_reg_set(P3c4, 0x1B, 0x00);\r\nudelay(100);\r\nxgifb_reg_set(P3c4, 0x18, 0x42);\r\nxgifb_reg_set(P3c4, 0x19, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x05);\r\nxgifb_reg_set(P3c4, 0x16, 0x85);\r\nudelay(200);\r\n}\r\nstatic void XGINew_DDR1x_MRS_XG20(unsigned long P3c4,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nxgifb_reg_set(P3c4, 0x18, 0x01);\r\nxgifb_reg_set(P3c4, 0x19, 0x40);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x80);\r\nudelay(60);\r\nxgifb_reg_set(P3c4, 0x18, 0x00);\r\nxgifb_reg_set(P3c4, 0x19, 0x40);\r\nxgifb_reg_set(P3c4, 0x16, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x80);\r\nudelay(60);\r\nxgifb_reg_set(P3c4, 0x18, pVBInfo->SR18[pVBInfo->ram_type]);\r\nxgifb_reg_set(P3c4, 0x19, 0x01);\r\nxgifb_reg_set(P3c4, 0x16, 0x03);\r\nxgifb_reg_set(P3c4, 0x16, 0x83);\r\nmdelay(1);\r\nxgifb_reg_set(P3c4, 0x1B, 0x03);\r\nudelay(500);\r\nxgifb_reg_set(P3c4, 0x18, pVBInfo->SR18[pVBInfo->ram_type]);\r\nxgifb_reg_set(P3c4, 0x19, 0x00);\r\nxgifb_reg_set(P3c4, 0x16, 0x03);\r\nxgifb_reg_set(P3c4, 0x16, 0x83);\r\nxgifb_reg_set(P3c4, 0x1B, 0x00);\r\n}\r\nstatic void XGINew_DDR1x_DefaultRegister(\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned long Port, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned long P3d4 = Port, P3c4 = Port - 0x10;\r\nif (HwDeviceExtension->jChipType >= XG20) {\r\nXGINew_SetMemoryClock(pVBInfo);\r\nxgifb_reg_set(P3d4,\r\n0x82,\r\npVBInfo->CR40[11][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x85,\r\npVBInfo->CR40[12][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x86,\r\npVBInfo->CR40[13][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x98, 0x01);\r\nxgifb_reg_set(P3d4, 0x9A, 0x02);\r\nXGINew_DDR1x_MRS_XG20(P3c4, pVBInfo);\r\n} else {\r\nXGINew_SetMemoryClock(pVBInfo);\r\nswitch (HwDeviceExtension->jChipType) {\r\ncase XG42:\r\nxgifb_reg_set(P3d4,\r\n0x82,\r\npVBInfo->CR40[11][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x85,\r\npVBInfo->CR40[12][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x86,\r\npVBInfo->CR40[13][pVBInfo->ram_type]);\r\nbreak;\r\ndefault:\r\nxgifb_reg_set(P3d4, 0x82, 0x88);\r\nxgifb_reg_set(P3d4, 0x86, 0x00);\r\nxgifb_reg_get(P3d4, 0x86);\r\nxgifb_reg_set(P3d4, 0x86, 0x88);\r\nxgifb_reg_get(P3d4, 0x86);\r\nxgifb_reg_set(P3d4,\r\n0x86,\r\npVBInfo->CR40[13][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x82, 0x77);\r\nxgifb_reg_set(P3d4, 0x85, 0x00);\r\nxgifb_reg_get(P3d4, 0x85);\r\nxgifb_reg_set(P3d4, 0x85, 0x88);\r\nxgifb_reg_get(P3d4, 0x85);\r\nxgifb_reg_set(P3d4,\r\n0x85,\r\npVBInfo->CR40[12][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x82,\r\npVBInfo->CR40[11][pVBInfo->ram_type]);\r\nbreak;\r\n}\r\nxgifb_reg_set(P3d4, 0x97, 0x00);\r\nxgifb_reg_set(P3d4, 0x98, 0x01);\r\nxgifb_reg_set(P3d4, 0x9A, 0x02);\r\nXGINew_DDR1x_MRS_340(P3c4, pVBInfo);\r\n}\r\n}\r\nstatic void XGINew_DDR2_DefaultRegister(\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned long Port, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned long P3d4 = Port, P3c4 = Port - 0x10;\r\nxgifb_reg_set(P3d4, 0x82, 0x77);\r\nxgifb_reg_set(P3d4, 0x86, 0x00);\r\nxgifb_reg_get(P3d4, 0x86);\r\nxgifb_reg_set(P3d4, 0x86, 0x88);\r\nxgifb_reg_get(P3d4, 0x86);\r\nxgifb_reg_set(P3d4, 0x86, pVBInfo->CR40[13][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x82, 0x77);\r\nxgifb_reg_set(P3d4, 0x85, 0x00);\r\nxgifb_reg_get(P3d4, 0x85);\r\nxgifb_reg_set(P3d4, 0x85, 0x88);\r\nxgifb_reg_get(P3d4, 0x85);\r\nxgifb_reg_set(P3d4,\r\n0x85,\r\npVBInfo->CR40[12][pVBInfo->ram_type]);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nxgifb_reg_set(P3d4, 0x82, pVBInfo->CR40[11][pVBInfo->ram_type]);\r\nelse\r\nxgifb_reg_set(P3d4, 0x82, 0xA8);\r\nxgifb_reg_set(P3d4, 0x98, 0x01);\r\nxgifb_reg_set(P3d4, 0x9A, 0x02);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nXGINew_DDRII_Bootup_XG27(HwDeviceExtension, P3c4, pVBInfo);\r\nelse\r\nXGINew_DDR2_MRS_XG20(HwDeviceExtension, P3c4, pVBInfo);\r\n}\r\nstatic void XGI_SetDRAM_Helper(unsigned long P3d4, u8 seed, u8 temp2, u8 reg,\r\nu8 shift_factor, u8 mask1, u8 mask2)\r\n{\r\nu8 j;\r\nfor (j = 0; j < 4; j++) {\r\ntemp2 |= (((seed >> (2 * j)) & 0x03) << shift_factor);\r\nxgifb_reg_set(P3d4, reg, temp2);\r\nxgifb_reg_get(P3d4, reg);\r\ntemp2 &= mask1;\r\ntemp2 += mask2;\r\n}\r\n}\r\nstatic void XGINew_SetDRAMDefaultRegister340(\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nunsigned long Port, struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char temp, temp1, temp2, temp3, j, k;\r\nunsigned long P3d4 = Port, P3c4 = Port - 0x10;\r\nxgifb_reg_set(P3d4, 0x6D, pVBInfo->CR40[8][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x68, pVBInfo->CR40[5][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x69, pVBInfo->CR40[6][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x6A, pVBInfo->CR40[7][pVBInfo->ram_type]);\r\ntemp = 0xaa;\r\nXGI_SetDRAM_Helper(P3d4, temp, 0, 0x6B, 2, 0xF0, 0x10);\r\nXGI_SetDRAM_Helper(P3d4, 0, 0, 0x6E, 2, 0xF0, 0x10);\r\ntemp3 = 0;\r\nfor (k = 0; k < 4; k++) {\r\nxgifb_reg_and_or(P3d4, 0x6E, 0xFC, temp3);\r\nXGI_SetDRAM_Helper(P3d4, 0, 0, 0x6F, 0, 0xF8, 0x08);\r\ntemp3 += 0x01;\r\n}\r\nxgifb_reg_set(P3d4,\r\n0x80,\r\npVBInfo->CR40[9][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4,\r\n0x81,\r\npVBInfo->CR40[10][pVBInfo->ram_type]);\r\ntemp2 = 0x80;\r\nXGI_SetDRAM_Helper(P3d4, 0, temp2, 0x89, 0, 0xF0, 0x10);\r\ntemp = 0;\r\ntemp1 = temp & 0x03;\r\ntemp2 |= temp1;\r\nxgifb_reg_set(P3d4, 0x89, temp2);\r\ntemp = pVBInfo->CR40[3][pVBInfo->ram_type];\r\ntemp1 = temp & 0x0F;\r\ntemp2 = (temp >> 4) & 0x07;\r\ntemp3 = temp & 0x80;\r\nxgifb_reg_set(P3d4, 0x45, temp1);\r\nxgifb_reg_set(P3d4, 0x99, temp2);\r\nxgifb_reg_or(P3d4, 0x40, temp3);\r\nxgifb_reg_set(P3d4,\r\n0x41,\r\npVBInfo->CR40[0][pVBInfo->ram_type]);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nxgifb_reg_set(P3d4, 0x8F, XG27_CR8F);\r\nfor (j = 0; j <= 6; j++)\r\nxgifb_reg_set(P3d4, (0x90 + j),\r\npVBInfo->CR40[14 + j][pVBInfo->ram_type]);\r\nfor (j = 0; j <= 2; j++)\r\nxgifb_reg_set(P3d4, (0xC3 + j),\r\npVBInfo->CR40[21 + j][pVBInfo->ram_type]);\r\nfor (j = 0; j < 2; j++)\r\nxgifb_reg_set(P3d4, (0x8A + j),\r\npVBInfo->CR40[1 + j][pVBInfo->ram_type]);\r\nif (HwDeviceExtension->jChipType == XG42)\r\nxgifb_reg_set(P3d4, 0x8C, 0x87);\r\nxgifb_reg_set(P3d4,\r\n0x59,\r\npVBInfo->CR40[4][pVBInfo->ram_type]);\r\nxgifb_reg_set(P3d4, 0x83, 0x09);\r\nxgifb_reg_set(P3d4, 0x87, 0x00);\r\nxgifb_reg_set(P3d4, 0xCF, XG40_CRCF);\r\nif (pVBInfo->ram_type) {\r\nxgifb_reg_set(P3c4, 0x17, 0x80);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nxgifb_reg_set(P3c4, 0x17, 0x02);\r\n} else {\r\nxgifb_reg_set(P3c4, 0x17, 0x00);\r\n}\r\nxgifb_reg_set(P3c4, 0x1A, 0x87);\r\ntemp = XGINew_GetXG20DRAMType(HwDeviceExtension, pVBInfo);\r\nif (temp == 0) {\r\nXGINew_DDR1x_DefaultRegister(HwDeviceExtension, P3d4, pVBInfo);\r\n} else {\r\nxgifb_reg_set(P3d4, 0xB0, 0x80);\r\nXGINew_DDR2_DefaultRegister(HwDeviceExtension, P3d4, pVBInfo);\r\n}\r\nxgifb_reg_set(P3c4, 0x1B, 0x03);\r\n}\r\nstatic unsigned short XGINew_SetDRAMSize20Reg(\r\nunsigned short dram_size,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data = 0, memsize = 0;\r\nint RankSize;\r\nunsigned char ChannelNo;\r\nRankSize = dram_size * pVBInfo->ram_bus / 8;\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x13);\r\ndata &= 0x80;\r\nif (data == 0x80)\r\nRankSize *= 2;\r\ndata = 0;\r\nif (pVBInfo->ram_channel == 3)\r\nChannelNo = 4;\r\nelse\r\nChannelNo = pVBInfo->ram_channel;\r\nif (ChannelNo * RankSize <= 256) {\r\nwhile ((RankSize >>= 1) > 0)\r\ndata += 0x10;\r\nmemsize = data >> 4;\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x14,\r\n(xgifb_reg_get(pVBInfo->P3c4, 0x14) & 0x0F) |\r\n(data & 0xF0));\r\nudelay(15);\r\n}\r\nreturn memsize;\r\n}\r\nstatic int XGINew_ReadWriteRest(unsigned short StopAddr,\r\nunsigned short StartAddr, struct vb_device_info *pVBInfo)\r\n{\r\nint i;\r\nunsigned long Position = 0;\r\nvoid __iomem *fbaddr = pVBInfo->FBAddr;\r\nwritel(Position, fbaddr + Position);\r\nfor (i = StartAddr; i <= StopAddr; i++) {\r\nPosition = 1 << i;\r\nwritel(Position, fbaddr + Position);\r\n}\r\nudelay(500);\r\nPosition = 0;\r\nif (readl(fbaddr + Position) != Position)\r\nreturn 0;\r\nfor (i = StartAddr; i <= StopAddr; i++) {\r\nPosition = 1 << i;\r\nif (readl(fbaddr + Position) != Position)\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic unsigned char XGINew_CheckFrequence(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char data;\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x97);\r\nif ((data & 0x10) == 0) {\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x39);\r\ndata = (data & 0x02) >> 1;\r\nreturn data;\r\n}\r\nreturn data & 0x01;\r\n}\r\nstatic void XGINew_CheckChannel(struct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned char data;\r\nswitch (HwDeviceExtension->jChipType) {\r\ncase XG20:\r\ncase XG21:\r\ndata = xgifb_reg_get(pVBInfo->P3d4, 0x97);\r\ndata = data & 0x01;\r\npVBInfo->ram_channel = 1;\r\nif (data == 0) {\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1)\r\n> 0x1000000) {\r\npVBInfo->ram_bus = 32;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xB1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x52);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(24, 23, pVBInfo) == 1)\r\nreturn;\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) >\r\n0x800000) {\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x13,\r\n0x31);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x14,\r\n0x42);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(23,\r\n23,\r\npVBInfo) == 1)\r\nreturn;\r\n}\r\n}\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) >\r\n0x800000) {\r\npVBInfo->ram_bus = 16;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xB1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x41);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(23, 22, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x13,\r\n0x31);\r\nudelay(15);\r\n}\r\n} else {\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) >\r\n0x800000) {\r\npVBInfo->ram_bus = 16;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xB1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x41);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(23, 22, pVBInfo) == 1)\r\nreturn;\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) >\r\n0x400000) {\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x13,\r\n0x31);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x14,\r\n0x31);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(22,\r\n22,\r\npVBInfo) == 1)\r\nreturn;\r\n}\r\n}\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) >\r\n0x400000) {\r\npVBInfo->ram_bus = 8;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xB1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x30);\r\nudelay(15);\r\nif (XGINew_ReadWriteRest(22, 21, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x13,\r\n0x31);\r\nudelay(15);\r\n}\r\n}\r\nbreak;\r\ncase XG27:\r\npVBInfo->ram_bus = 16;\r\npVBInfo->ram_channel = 1;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x51);\r\nbreak;\r\ncase XG42:\r\nif (XGINew_CheckFrequence(pVBInfo) == 1) {\r\npVBInfo->ram_bus = 32;\r\npVBInfo->ram_channel = 2;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xA1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x44);\r\nif (XGINew_ReadWriteRest(24, 23, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x34);\r\nif (XGINew_ReadWriteRest(23, 22, pVBInfo) == 1)\r\nreturn;\r\npVBInfo->ram_channel = 1;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xA1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x40);\r\nif (XGINew_ReadWriteRest(23, 22, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x30);\r\n} else {\r\npVBInfo->ram_bus = 64;\r\npVBInfo->ram_channel = 1;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xA1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x52);\r\nif (XGINew_ReadWriteRest(24, 23, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x42);\r\n}\r\nbreak;\r\ndefault:\r\nif (XGINew_CheckFrequence(pVBInfo) == 1) {\r\npVBInfo->ram_bus = 32;\r\npVBInfo->ram_channel = 3;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xA1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x4C);\r\nif (XGINew_ReadWriteRest(25, 23, pVBInfo) == 1)\r\nreturn;\r\npVBInfo->ram_channel = 2;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x48);\r\nif (XGINew_ReadWriteRest(24, 23, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x3C);\r\nif (XGINew_ReadWriteRest(24, 23, pVBInfo) == 1) {\r\npVBInfo->ram_channel = 3;\r\n} else {\r\npVBInfo->ram_channel = 2;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x38);\r\n}\r\n} else {\r\npVBInfo->ram_bus = 64;\r\npVBInfo->ram_channel = 2;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0xA1);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x5A);\r\nif (XGINew_ReadWriteRest(25, 24, pVBInfo) == 1)\r\nreturn;\r\nxgifb_reg_set(pVBInfo->P3c4, 0x13, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x14, 0x4A);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int XGINew_DDRSizing340(struct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nu8 i, size;\r\nunsigned short memsize, start_addr;\r\nconst unsigned short (*dram_table)[2];\r\nxgifb_reg_set(pVBInfo->P3c4, 0x15, 0x00);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x1C, 0x00);\r\nXGINew_CheckChannel(HwDeviceExtension, pVBInfo);\r\nif (HwDeviceExtension->jChipType >= XG20) {\r\ndram_table = XGINew_DDRDRAM_TYPE20;\r\nsize = ARRAY_SIZE(XGINew_DDRDRAM_TYPE20);\r\nstart_addr = 5;\r\n} else {\r\ndram_table = XGINew_DDRDRAM_TYPE340;\r\nsize = ARRAY_SIZE(XGINew_DDRDRAM_TYPE340);\r\nstart_addr = 9;\r\n}\r\nfor (i = 0; i < size; i++) {\r\nxgifb_reg_and_or(pVBInfo->P3c4, 0x13, 0x80, dram_table[i][1]);\r\nudelay(15);\r\nmemsize = XGINew_SetDRAMSize20Reg(dram_table[i][0], pVBInfo);\r\nif (memsize == 0)\r\ncontinue;\r\nmemsize += (pVBInfo->ram_channel - 2) + 20;\r\nif ((HwDeviceExtension->ulVideoMemorySize - 1) <\r\n(unsigned long) (1 << memsize))\r\ncontinue;\r\nif (XGINew_ReadWriteRest(memsize, start_addr, pVBInfo) == 1)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void XGINew_SetDRAMSize_340(struct xgifb_video_info *xgifb_info,\r\nstruct xgi_hw_device_info *HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short data;\r\npVBInfo->FBAddr = HwDeviceExtension->pjVideoMemoryAddress;\r\nXGISetModeNew(xgifb_info, HwDeviceExtension, 0x2e);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x21, (unsigned short) (data & 0xDF));\r\nXGI_DisplayOff(xgifb_info, HwDeviceExtension, pVBInfo);\r\nXGINew_DDRSizing340(HwDeviceExtension, pVBInfo);\r\ndata = xgifb_reg_get(pVBInfo->P3c4, 0x21);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x21, (unsigned short) (data | 0x20));\r\n}\r\nstatic u8 *xgifb_copy_rom(struct pci_dev *dev, size_t *rom_size)\r\n{\r\nvoid __iomem *rom_address;\r\nu8 *rom_copy;\r\nrom_address = pci_map_rom(dev, rom_size);\r\nif (rom_address == NULL)\r\nreturn NULL;\r\nrom_copy = vzalloc(XGIFB_ROM_SIZE);\r\nif (rom_copy == NULL)\r\ngoto done;\r\n*rom_size = min_t(size_t, *rom_size, XGIFB_ROM_SIZE);\r\nmemcpy_fromio(rom_copy, rom_address, *rom_size);\r\ndone:\r\npci_unmap_rom(dev, rom_address);\r\nreturn rom_copy;\r\n}\r\nstatic bool xgifb_read_vbios(struct pci_dev *pdev)\r\n{\r\nstruct xgifb_video_info *xgifb_info = pci_get_drvdata(pdev);\r\nu8 *vbios;\r\nunsigned long i;\r\nunsigned char j;\r\nstruct XGI21_LVDSCapStruct *lvds;\r\nsize_t vbios_size;\r\nint entry;\r\nvbios = xgifb_copy_rom(pdev, &vbios_size);\r\nif (vbios == NULL) {\r\ndev_err(&pdev->dev, "Video BIOS not available\n");\r\nreturn false;\r\n}\r\nif (vbios_size <= 0x65)\r\ngoto error;\r\nif (!(vbios[0x65] & 0x1) &&\r\n(!xgifb_info->display2_force ||\r\nxgifb_info->display2 != XGIFB_DISP_LCD)) {\r\nvfree(vbios);\r\nreturn false;\r\n}\r\nif (vbios_size <= 0x317)\r\ngoto error;\r\ni = vbios[0x316] | (vbios[0x317] << 8);\r\nif (vbios_size <= i - 1)\r\ngoto error;\r\nj = vbios[i - 1];\r\nif (j == 0)\r\ngoto error;\r\nif (j == 0xff)\r\nj = 1;\r\nentry = xgifb_reg_get(xgifb_info->dev_info.P3d4, 0x36);\r\nif (entry >= j)\r\nentry = 0;\r\ni += entry * 25;\r\nlvds = &xgifb_info->lvds_data;\r\nif (vbios_size <= i + 24)\r\ngoto error;\r\nlvds->LVDS_Capability = vbios[i] | (vbios[i + 1] << 8);\r\nlvds->LVDSHT = vbios[i + 2] | (vbios[i + 3] << 8);\r\nlvds->LVDSVT = vbios[i + 4] | (vbios[i + 5] << 8);\r\nlvds->LVDSHDE = vbios[i + 6] | (vbios[i + 7] << 8);\r\nlvds->LVDSVDE = vbios[i + 8] | (vbios[i + 9] << 8);\r\nlvds->LVDSHFP = vbios[i + 10] | (vbios[i + 11] << 8);\r\nlvds->LVDSVFP = vbios[i + 12] | (vbios[i + 13] << 8);\r\nlvds->LVDSHSYNC = vbios[i + 14] | (vbios[i + 15] << 8);\r\nlvds->LVDSVSYNC = vbios[i + 16] | (vbios[i + 17] << 8);\r\nlvds->VCLKData1 = vbios[i + 18];\r\nlvds->VCLKData2 = vbios[i + 19];\r\nlvds->PSC_S1 = vbios[i + 20];\r\nlvds->PSC_S2 = vbios[i + 21];\r\nlvds->PSC_S3 = vbios[i + 22];\r\nlvds->PSC_S4 = vbios[i + 23];\r\nlvds->PSC_S5 = vbios[i + 24];\r\nvfree(vbios);\r\nreturn true;\r\nerror:\r\ndev_err(&pdev->dev, "Video BIOS corrupted\n");\r\nvfree(vbios);\r\nreturn false;\r\n}\r\nstatic void XGINew_ChkSenseStatus(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short tempbx = 0, temp, tempcx, CR3CData;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x32);\r\nif (temp & Monitor1Sense)\r\ntempbx |= ActiveCRT1;\r\nif (temp & LCDSense)\r\ntempbx |= ActiveLCD;\r\nif (temp & Monitor2Sense)\r\ntempbx |= ActiveCRT2;\r\nif (temp & TVSense) {\r\ntempbx |= ActiveTV;\r\nif (temp & AVIDEOSense)\r\ntempbx |= (ActiveAVideo << 8);\r\nif (temp & SVIDEOSense)\r\ntempbx |= (ActiveSVideo << 8);\r\nif (temp & SCARTSense)\r\ntempbx |= (ActiveSCART << 8);\r\nif (temp & HiTVSense)\r\ntempbx |= (ActiveHiTV << 8);\r\nif (temp & YPbPrSense)\r\ntempbx |= (ActiveYPbPr << 8);\r\n}\r\ntempcx = xgifb_reg_get(pVBInfo->P3d4, 0x3d);\r\ntempcx |= (xgifb_reg_get(pVBInfo->P3d4, 0x3e) << 8);\r\nif (tempbx & tempcx) {\r\nCR3CData = xgifb_reg_get(pVBInfo->P3d4, 0x3c);\r\nif (!(CR3CData & DisplayDeviceFromCMOS))\r\ntempcx = 0x1FF0;\r\n} else {\r\ntempcx = 0x1FF0;\r\n}\r\ntempbx &= tempcx;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x3d, (tempbx & 0x00FF));\r\nxgifb_reg_set(pVBInfo->P3d4, 0x3e, ((tempbx & 0xFF00) >> 8));\r\n}\r\nstatic void XGINew_SetModeScratch(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp, tempcl = 0, tempch = 0, CR31Data, CR38Data;\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x3d);\r\ntemp |= xgifb_reg_get(pVBInfo->P3d4, 0x3e) << 8;\r\ntemp |= (xgifb_reg_get(pVBInfo->P3d4, 0x31) & (DriverMode >> 8)) << 8;\r\nif (pVBInfo->IF_DEF_CRT2Monitor == 1) {\r\nif (temp & ActiveCRT2)\r\ntempcl = SetCRT2ToRAMDAC;\r\n}\r\nif (temp & ActiveLCD) {\r\ntempcl |= SetCRT2ToLCD;\r\nif (temp & DriverMode) {\r\nif (temp & ActiveTV) {\r\ntempch = SetToLCDA | EnableDualEdge;\r\ntemp ^= SetCRT2ToLCD;\r\nif ((temp >> 8) & ActiveAVideo)\r\ntempcl |= SetCRT2ToAVIDEO;\r\nif ((temp >> 8) & ActiveSVideo)\r\ntempcl |= SetCRT2ToSVIDEO;\r\nif ((temp >> 8) & ActiveSCART)\r\ntempcl |= SetCRT2ToSCART;\r\nif (pVBInfo->IF_DEF_HiVision == 1) {\r\nif ((temp >> 8) & ActiveHiTV)\r\ntempcl |= SetCRT2ToHiVision;\r\n}\r\nif (pVBInfo->IF_DEF_YPbPr == 1) {\r\nif ((temp >> 8) & ActiveYPbPr)\r\ntempch |= SetYPbPr;\r\n}\r\n}\r\n}\r\n} else {\r\nif ((temp >> 8) & ActiveAVideo)\r\ntempcl |= SetCRT2ToAVIDEO;\r\nif ((temp >> 8) & ActiveSVideo)\r\ntempcl |= SetCRT2ToSVIDEO;\r\nif ((temp >> 8) & ActiveSCART)\r\ntempcl |= SetCRT2ToSCART;\r\nif (pVBInfo->IF_DEF_HiVision == 1) {\r\nif ((temp >> 8) & ActiveHiTV)\r\ntempcl |= SetCRT2ToHiVision;\r\n}\r\nif (pVBInfo->IF_DEF_YPbPr == 1) {\r\nif ((temp >> 8) & ActiveYPbPr)\r\ntempch |= SetYPbPr;\r\n}\r\n}\r\ntempcl |= SetSimuScanMode;\r\nif ((!(temp & ActiveCRT1)) && ((temp & ActiveLCD) || (temp & ActiveTV)\r\n|| (temp & ActiveCRT2)))\r\ntempcl ^= (SetSimuScanMode | SwitchCRT2);\r\nif ((temp & ActiveLCD) && (temp & ActiveTV))\r\ntempcl ^= (SetSimuScanMode | SwitchCRT2);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x30, tempcl);\r\nCR31Data = xgifb_reg_get(pVBInfo->P3d4, 0x31);\r\nCR31Data &= ~(SetNotSimuMode >> 8);\r\nif (!(temp & ActiveCRT1))\r\nCR31Data |= (SetNotSimuMode >> 8);\r\nCR31Data &= ~(DisableCRT2Display >> 8);\r\nif (!((temp & ActiveLCD) || (temp & ActiveTV) || (temp & ActiveCRT2)))\r\nCR31Data |= (DisableCRT2Display >> 8);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x31, CR31Data);\r\nCR38Data = xgifb_reg_get(pVBInfo->P3d4, 0x38);\r\nCR38Data &= ~SetYPbPr;\r\nCR38Data |= tempch;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x38, CR38Data);\r\n}\r\nstatic unsigned short XGINew_SenseLCD(struct xgi_hw_device_info\r\n*HwDeviceExtension,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nunsigned short temp = HwDeviceExtension->ulCRT2LCDType;\r\nswitch (HwDeviceExtension->ulCRT2LCDType) {\r\ncase LCD_640x480:\r\ncase LCD_1024x600:\r\ncase LCD_1152x864:\r\ncase LCD_1280x960:\r\ncase LCD_1152x768:\r\ncase LCD_1920x1440:\r\ncase LCD_2048x1536:\r\ntemp = 0;\r\nbreak;\r\ncase LCD_UNKNOWN:\r\nreturn 0;\r\n}\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x36, 0xF0, temp);\r\nreturn 1;\r\n}\r\nstatic void XGINew_GetXG21Sense(struct pci_dev *pdev,\r\nstruct vb_device_info *pVBInfo)\r\n{\r\nstruct xgifb_video_info *xgifb_info = pci_get_drvdata(pdev);\r\nunsigned char Temp;\r\nif (xgifb_read_vbios(pdev)) {\r\nxgifb_reg_or(pVBInfo->P3d4, 0x32, LCDSense);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x38, ~0xE0, 0xC0);\r\n} else {\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x4A, ~0x03, 0x03);\r\nTemp = xgifb_reg_get(pVBInfo->P3d4, 0x48) & 0xC0;\r\nif (Temp == 0xC0) {\r\nXGINew_SenseLCD(&xgifb_info->hw_info, pVBInfo);\r\nxgifb_reg_or(pVBInfo->P3d4, 0x32, LCDSense);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x4A, ~0x20, 0x20);\r\nif (xgifb_reg_get(pVBInfo->P3d4, 0x48) & 0x04)\r\nTemp = 0xA0;\r\nelse\r\nTemp = 0x80;\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x38, ~0xE0, Temp);\r\nxgifb_reg_and(pVBInfo->P3d4, 0x4A, ~0x20);\r\n}\r\n}\r\n}\r\nstatic void XGINew_GetXG27Sense(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char Temp, bCR4A;\r\nbCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x4A, ~0x07, 0x07);\r\nTemp = xgifb_reg_get(pVBInfo->P3d4, 0x48) & 0x07;\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4A, bCR4A);\r\nif (Temp <= 0x02) {\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x38, ~0xE0, 0xC0);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x30, 0x21);\r\n} else {\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x38, ~0xE0, 0xA0);\r\n}\r\nxgifb_reg_or(pVBInfo->P3d4, 0x32, LCDSense);\r\n}\r\nstatic unsigned char GetXG21FPBits(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR38, CR4A, temp;\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x4A, ~0x10, 0x10);\r\nCR38 = xgifb_reg_get(pVBInfo->P3d4, 0x38);\r\ntemp = 0;\r\nif ((CR38 & 0xE0) > 0x80) {\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\ntemp &= 0x08;\r\ntemp >>= 3;\r\n}\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4A, CR4A);\r\nreturn temp;\r\n}\r\nstatic unsigned char GetXG27FPBits(struct vb_device_info *pVBInfo)\r\n{\r\nunsigned char CR4A, temp;\r\nCR4A = xgifb_reg_get(pVBInfo->P3d4, 0x4A);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x4A, ~0x03, 0x03);\r\ntemp = xgifb_reg_get(pVBInfo->P3d4, 0x48);\r\nif (temp > 2)\r\ntemp = ((temp & 0x04) >> 1) | ((~temp) & 0x01);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x4A, CR4A);\r\nreturn temp;\r\n}\r\nstatic bool xgifb_bridge_is_on(struct vb_device_info *vb_info)\r\n{\r\nu8 flag;\r\nflag = xgifb_reg_get(vb_info->Part4Port, 0x00);\r\nreturn flag == 1 || flag == 2;\r\n}\r\nunsigned char XGIInitNew(struct pci_dev *pdev)\r\n{\r\nstruct xgifb_video_info *xgifb_info = pci_get_drvdata(pdev);\r\nstruct xgi_hw_device_info *HwDeviceExtension = &xgifb_info->hw_info;\r\nstruct vb_device_info VBINF;\r\nstruct vb_device_info *pVBInfo = &VBINF;\r\nunsigned char i, temp = 0, temp1;\r\npVBInfo->FBAddr = HwDeviceExtension->pjVideoMemoryAddress;\r\nif (pVBInfo->FBAddr == NULL) {\r\ndev_dbg(&pdev->dev, "pVBInfo->FBAddr == 0\n");\r\nreturn 0;\r\n}\r\nXGIRegInit(pVBInfo, xgifb_info->vga_base);\r\noutb(0x67, pVBInfo->P3c2);\r\nInitTo330Pointer(HwDeviceExtension->jChipType, pVBInfo);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x05, 0x86);\r\nif (HwDeviceExtension->jChipType == XG21)\r\nXGINew_GetXG21Sense(pdev, pVBInfo);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nXGINew_GetXG27Sense(pVBInfo);\r\nfor (i = 0x06; i < 0x20; i++)\r\nxgifb_reg_set(pVBInfo->P3c4, i, 0);\r\nfor (i = 0x21; i <= 0x27; i++)\r\nxgifb_reg_set(pVBInfo->P3c4, i, 0);\r\nfor (i = 0x31; i <= 0x3B; i++)\r\nxgifb_reg_set(pVBInfo->P3c4, i, 0);\r\nif (HwDeviceExtension->jChipType == XG42)\r\nxgifb_reg_set(pVBInfo->P3c4, 0x3B, 0xC0);\r\nfor (i = 0x79; i <= 0x7C; i++)\r\nxgifb_reg_set(pVBInfo->P3d4, i, 0);\r\nif (HwDeviceExtension->jChipType >= XG20)\r\nxgifb_reg_set(pVBInfo->P3d4, 0x97, pVBInfo->XGINew_CR97);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x07, XGI330_SR07);\r\nif (HwDeviceExtension->jChipType == XG27) {\r\nxgifb_reg_set(pVBInfo->P3c4, 0x40, XG27_SR40);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x41, XG27_SR41);\r\n}\r\nxgifb_reg_set(pVBInfo->P3c4, 0x11, 0x0F);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x1F, XGI330_SR1F);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x20, 0xA0);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x36, 0x70);\r\nif (HwDeviceExtension->jChipType == XG27)\r\nxgifb_reg_set(pVBInfo->P3c4, 0x36, XG27_SR36);\r\nif (HwDeviceExtension->jChipType < XG20) {\r\nu32 Temp;\r\nfor (i = 0x47; i <= 0x4C; i++)\r\nxgifb_reg_set(pVBInfo->P3d4,\r\ni,\r\nXGI340_AGPReg[i - 0x47]);\r\nfor (i = 0x70; i <= 0x71; i++)\r\nxgifb_reg_set(pVBInfo->P3d4,\r\ni,\r\nXGI340_AGPReg[6 + i - 0x70]);\r\nfor (i = 0x74; i <= 0x77; i++)\r\nxgifb_reg_set(pVBInfo->P3d4,\r\ni,\r\nXGI340_AGPReg[8 + i - 0x74]);\r\npci_read_config_dword(pdev, 0x50, &Temp);\r\nTemp >>= 20;\r\nTemp &= 0xF;\r\nif (Temp == 1)\r\nxgifb_reg_set(pVBInfo->P3d4, 0x48, 0x20);\r\n}\r\nxgifb_reg_set(pVBInfo->P3c4, 0x23, XGI330_SR23);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x24, XGI330_SR24);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x25, 0);\r\nif (HwDeviceExtension->jChipType < XG20) {\r\nXGI_UnLockCRT2(pVBInfo);\r\nxgifb_reg_and_or(pVBInfo->Part0Port, 0x3F, 0xEF, 0x00);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x00, 0x00);\r\ntemp1 = xgifb_reg_get(pVBInfo->P3d4, 0x7B);\r\nxgifb_reg_set(pVBInfo->Part1Port,\r\n0x02, XGI330_CRT2Data_1_2);\r\nxgifb_reg_set(pVBInfo->Part1Port, 0x2E, 0x08);\r\n}\r\nxgifb_reg_set(pVBInfo->P3c4, 0x27, 0x1F);\r\nif ((HwDeviceExtension->jChipType == XG42) &&\r\nXGINew_GetXG20DRAMType(HwDeviceExtension, pVBInfo) != 0) {\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x31,\r\n(XGI330_SR31 & 0x3F) | 0x40);\r\nxgifb_reg_set(pVBInfo->P3c4,\r\n0x32,\r\n(XGI330_SR32 & 0xFC) | 0x01);\r\n} else {\r\nxgifb_reg_set(pVBInfo->P3c4, 0x31, XGI330_SR31);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x32, XGI330_SR32);\r\n}\r\nxgifb_reg_set(pVBInfo->P3c4, 0x33, XGI330_SR33);\r\nif (HwDeviceExtension->jChipType < XG20) {\r\nif (xgifb_bridge_is_on(pVBInfo)) {\r\nxgifb_reg_set(pVBInfo->Part2Port, 0x00, 0x1C);\r\nxgifb_reg_set(pVBInfo->Part4Port,\r\n0x0D, XGI330_CRT2Data_4_D);\r\nxgifb_reg_set(pVBInfo->Part4Port,\r\n0x0E, XGI330_CRT2Data_4_E);\r\nxgifb_reg_set(pVBInfo->Part4Port,\r\n0x10, XGI330_CRT2Data_4_10);\r\nxgifb_reg_set(pVBInfo->Part4Port, 0x0F, 0x3F);\r\nXGI_LockCRT2(pVBInfo);\r\n}\r\n}\r\nXGI_SenseCRT1(pVBInfo);\r\nif (HwDeviceExtension->jChipType == XG21) {\r\nxgifb_reg_and_or(pVBInfo->P3d4,\r\n0x32,\r\n~Monitor1Sense,\r\nMonitor1Sense);\r\ntemp = GetXG21FPBits(pVBInfo);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x37, ~0x01, temp);\r\n}\r\nif (HwDeviceExtension->jChipType == XG27) {\r\nxgifb_reg_and_or(pVBInfo->P3d4,\r\n0x32,\r\n~Monitor1Sense,\r\nMonitor1Sense);\r\ntemp = GetXG27FPBits(pVBInfo);\r\nxgifb_reg_and_or(pVBInfo->P3d4, 0x37, ~0x03, temp);\r\n}\r\npVBInfo->ram_type = XGINew_GetXG20DRAMType(HwDeviceExtension, pVBInfo);\r\nXGINew_SetDRAMDefaultRegister340(HwDeviceExtension,\r\npVBInfo->P3d4,\r\npVBInfo);\r\nXGINew_SetDRAMSize_340(xgifb_info, HwDeviceExtension, pVBInfo);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x22, 0xfa);\r\nxgifb_reg_set(pVBInfo->P3c4, 0x21, 0xa3);\r\nXGINew_ChkSenseStatus(pVBInfo);\r\nXGINew_SetModeScratch(pVBInfo);\r\nxgifb_reg_set(pVBInfo->P3d4, 0x8c, 0x87);\r\nreturn 1;\r\n}

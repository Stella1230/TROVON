static inline struct sfi_table_header *acpi_to_sfi_th(\r\nstruct acpi_table_header *th)\r\n{\r\nreturn (struct sfi_table_header *)th;\r\n}\r\nstatic inline struct acpi_table_header *sfi_to_acpi_th(\r\nstruct sfi_table_header *th)\r\n{\r\nreturn (struct acpi_table_header *)th;\r\n}\r\nstatic int __init sfi_acpi_parse_xsdt(struct sfi_table_header *th)\r\n{\r\nstruct sfi_table_key key = SFI_ANY_KEY;\r\nint tbl_cnt, i;\r\nvoid *ret;\r\nxsdt_va = (struct acpi_table_xsdt *)th;\r\ntbl_cnt = XSDT_GET_NUM_ENTRIES(xsdt_va, u64);\r\nfor (i = 0; i < tbl_cnt; i++) {\r\nret = sfi_check_table(xsdt_va->table_offset_entry[i], &key);\r\nif (IS_ERR(ret)) {\r\ndisable_sfi();\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint __init sfi_acpi_init(void)\r\n{\r\nstruct sfi_table_key xsdt_key = { .sig = SFI_SIG_XSDT };\r\nsfi_table_parse(SFI_SIG_XSDT, NULL, NULL, sfi_acpi_parse_xsdt);\r\nxsdt_va = (struct acpi_table_xsdt *)sfi_get_table(&xsdt_key);\r\nreturn 0;\r\n}\r\nstatic struct acpi_table_header *sfi_acpi_get_table(struct sfi_table_key *key)\r\n{\r\nu32 tbl_cnt, i;\r\nvoid *ret;\r\ntbl_cnt = XSDT_GET_NUM_ENTRIES(xsdt_va, u64);\r\nfor (i = 0; i < tbl_cnt; i++) {\r\nret = sfi_check_table(xsdt_va->table_offset_entry[i], key);\r\nif (!IS_ERR(ret) && ret)\r\nreturn sfi_to_acpi_th(ret);\r\n}\r\nreturn NULL;\r\n}\r\nstatic void sfi_acpi_put_table(struct acpi_table_header *table)\r\n{\r\nsfi_put_table(acpi_to_sfi_th(table));\r\n}\r\nint sfi_acpi_table_parse(char *signature, char *oem_id, char *oem_table_id,\r\nint(*handler)(struct acpi_table_header *))\r\n{\r\nstruct acpi_table_header *table = NULL;\r\nstruct sfi_table_key key;\r\nint ret = 0;\r\nif (sfi_disabled)\r\nreturn -1;\r\nkey.sig = signature;\r\nkey.oem_id = oem_id;\r\nkey.oem_table_id = oem_table_id;\r\ntable = sfi_acpi_get_table(&key);\r\nif (!table)\r\nreturn -EINVAL;\r\nret = handler(table);\r\nsfi_acpi_put_table(table);\r\nreturn ret;\r\n}\r\nstatic ssize_t sfi_acpi_table_show(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr, char *buf,\r\nloff_t offset, size_t count)\r\n{\r\nstruct sfi_table_attr *tbl_attr =\r\ncontainer_of(bin_attr, struct sfi_table_attr, attr);\r\nstruct acpi_table_header *th = NULL;\r\nstruct sfi_table_key key;\r\nssize_t cnt;\r\nkey.sig = tbl_attr->name;\r\nkey.oem_id = NULL;\r\nkey.oem_table_id = NULL;\r\nth = sfi_acpi_get_table(&key);\r\nif (!th)\r\nreturn 0;\r\ncnt = memory_read_from_buffer(buf, count, &offset,\r\nth, th->length);\r\nsfi_acpi_put_table(th);\r\nreturn cnt;\r\n}\r\nvoid __init sfi_acpi_sysfs_init(void)\r\n{\r\nu32 tbl_cnt, i;\r\nstruct sfi_table_attr *tbl_attr;\r\ntbl_cnt = XSDT_GET_NUM_ENTRIES(xsdt_va, u64);\r\nfor (i = 0; i < tbl_cnt; i++) {\r\ntbl_attr =\r\nsfi_sysfs_install_table(xsdt_va->table_offset_entry[i]);\r\ntbl_attr->attr.read = sfi_acpi_table_show;\r\n}\r\nreturn;\r\n}

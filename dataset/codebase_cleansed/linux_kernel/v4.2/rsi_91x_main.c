void rsi_dbg(u32 zone, const char *fmt, ...)\r\n{\r\nstruct va_format vaf;\r\nva_list args;\r\nva_start(args, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &args;\r\nif (zone & rsi_zone_enabled)\r\npr_info("%pV", &vaf);\r\nva_end(args);\r\n}\r\nstatic struct sk_buff *rsi_prepare_skb(struct rsi_common *common,\r\nu8 *buffer,\r\nu32 pkt_len,\r\nu8 extended_desc)\r\n{\r\nstruct ieee80211_tx_info *info;\r\nstruct skb_info *rx_params;\r\nstruct sk_buff *skb = NULL;\r\nu8 payload_offset;\r\nif (WARN(!pkt_len, "%s: Dummy pkt received", __func__))\r\nreturn NULL;\r\nif (pkt_len > (RSI_RCV_BUFFER_LEN * 4)) {\r\nrsi_dbg(ERR_ZONE, "%s: Pkt size > max rx buf size %d\n",\r\n__func__, pkt_len);\r\npkt_len = RSI_RCV_BUFFER_LEN * 4;\r\n}\r\npkt_len -= extended_desc;\r\nskb = dev_alloc_skb(pkt_len + FRAME_DESC_SZ);\r\nif (skb == NULL)\r\nreturn NULL;\r\npayload_offset = (extended_desc + FRAME_DESC_SZ);\r\nskb_put(skb, pkt_len);\r\nmemcpy((skb->data), (buffer + payload_offset), skb->len);\r\ninfo = IEEE80211_SKB_CB(skb);\r\nrx_params = (struct skb_info *)info->driver_data;\r\nrx_params->rssi = rsi_get_rssi(buffer);\r\nrx_params->channel = rsi_get_connected_channel(common->priv);\r\nreturn skb;\r\n}\r\nint rsi_read_pkt(struct rsi_common *common, s32 rcv_pkt_len)\r\n{\r\nu8 *frame_desc = NULL, extended_desc = 0;\r\nu32 index, length = 0, queueno = 0;\r\nu16 actual_length = 0, offset;\r\nstruct sk_buff *skb = NULL;\r\nindex = 0;\r\ndo {\r\nframe_desc = &common->rx_data_pkt[index];\r\nactual_length = *(u16 *)&frame_desc[0];\r\noffset = *(u16 *)&frame_desc[2];\r\nqueueno = rsi_get_queueno(frame_desc, offset);\r\nlength = rsi_get_length(frame_desc, offset);\r\nextended_desc = rsi_get_extended_desc(frame_desc, offset);\r\nswitch (queueno) {\r\ncase RSI_WIFI_DATA_Q:\r\nskb = rsi_prepare_skb(common,\r\n(frame_desc + offset),\r\nlength,\r\nextended_desc);\r\nif (skb == NULL)\r\ngoto fail;\r\nrsi_indicate_pkt_to_os(common, skb);\r\nbreak;\r\ncase RSI_WIFI_MGMT_Q:\r\nrsi_mgmt_pkt_recv(common, (frame_desc + offset));\r\nbreak;\r\ndefault:\r\nrsi_dbg(ERR_ZONE, "%s: pkt from invalid queue: %d\n",\r\n__func__, queueno);\r\ngoto fail;\r\n}\r\nindex += actual_length;\r\nrcv_pkt_len -= actual_length;\r\n} while (rcv_pkt_len > 0);\r\nreturn 0;\r\nfail:\r\nreturn -EINVAL;\r\n}\r\nstatic void rsi_tx_scheduler_thread(struct rsi_common *common)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nu32 timeout = EVENT_WAIT_FOREVER;\r\ndo {\r\nif (adapter->determine_event_timeout)\r\ntimeout = adapter->determine_event_timeout(adapter);\r\nrsi_wait_event(&common->tx_thread.event, timeout);\r\nrsi_reset_event(&common->tx_thread.event);\r\nif (common->init_done)\r\nrsi_core_qos_processor(common);\r\n} while (atomic_read(&common->tx_thread.thread_done) == 0);\r\ncomplete_and_exit(&common->tx_thread.completion, 0);\r\n}\r\nstruct rsi_hw *rsi_91x_init(void)\r\n{\r\nstruct rsi_hw *adapter = NULL;\r\nstruct rsi_common *common = NULL;\r\nu8 ii = 0;\r\nadapter = kzalloc(sizeof(*adapter), GFP_KERNEL);\r\nif (!adapter)\r\nreturn NULL;\r\nadapter->priv = kzalloc(sizeof(*common), GFP_KERNEL);\r\nif (adapter->priv == NULL) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed in allocation of memory\n",\r\n__func__);\r\nkfree(adapter);\r\nreturn NULL;\r\n} else {\r\ncommon = adapter->priv;\r\ncommon->priv = adapter;\r\n}\r\nfor (ii = 0; ii < NUM_SOFT_QUEUES; ii++)\r\nskb_queue_head_init(&common->tx_queue[ii]);\r\nrsi_init_event(&common->tx_thread.event);\r\nmutex_init(&common->mutex);\r\nmutex_init(&common->tx_rxlock);\r\nif (rsi_create_kthread(common,\r\n&common->tx_thread,\r\nrsi_tx_scheduler_thread,\r\n"Tx-Thread")) {\r\nrsi_dbg(ERR_ZONE, "%s: Unable to init tx thrd\n", __func__);\r\ngoto err;\r\n}\r\ncommon->init_done = true;\r\nreturn adapter;\r\nerr:\r\nkfree(common);\r\nkfree(adapter);\r\nreturn NULL;\r\n}\r\nvoid rsi_91x_deinit(struct rsi_hw *adapter)\r\n{\r\nstruct rsi_common *common = adapter->priv;\r\nu8 ii;\r\nrsi_dbg(INFO_ZONE, "%s: Performing deinit os ops\n", __func__);\r\nrsi_kill_thread(&common->tx_thread);\r\nfor (ii = 0; ii < NUM_SOFT_QUEUES; ii++)\r\nskb_queue_purge(&common->tx_queue[ii]);\r\ncommon->init_done = false;\r\nkfree(common);\r\nkfree(adapter->rsi_dev);\r\nkfree(adapter);\r\n}\r\nstatic int rsi_91x_hal_module_init(void)\r\n{\r\nrsi_dbg(INIT_ZONE, "%s: Module init called\n", __func__);\r\nreturn 0;\r\n}\r\nstatic void rsi_91x_hal_module_exit(void)\r\n{\r\nrsi_dbg(INIT_ZONE, "%s: Module exit called\n", __func__);\r\n}

static int max8998_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max8998_battery_data *max8998 = power_supply_get_drvdata(psy);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint ret;\r\nu8 reg;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nret = max8998_read_reg(i2c, MAX8998_REG_STATUS2, &reg);\r\nif (ret)\r\nreturn ret;\r\nif (reg & (1 << 4))\r\nval->intval = 0;\r\nelse\r\nval->intval = 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = max8998_read_reg(i2c, MAX8998_REG_STATUS2, &reg);\r\nif (ret)\r\nreturn ret;\r\nif (reg & (1 << 3))\r\nval->intval = 0;\r\nelse\r\nval->intval = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8998_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct max8998_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8998_platform_data *pdata = dev_get_platdata(iodev->dev);\r\nstruct power_supply_config psy_cfg = {};\r\nstruct max8998_battery_data *max8998;\r\nstruct i2c_client *i2c;\r\nint ret = 0;\r\nif (!pdata) {\r\ndev_err(pdev->dev.parent, "No platform init data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nmax8998 = devm_kzalloc(&pdev->dev, sizeof(struct max8998_battery_data),\r\nGFP_KERNEL);\r\nif (!max8998)\r\nreturn -ENOMEM;\r\nmax8998->dev = &pdev->dev;\r\nmax8998->iodev = iodev;\r\nplatform_set_drvdata(pdev, max8998);\r\ni2c = max8998->iodev->i2c;\r\nif (pdata->eoc >= 10 && pdata->eoc <= 45) {\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR1,\r\n(pdata->eoc / 5 - 2) << 5, 0x7 << 5);\r\n} else if (pdata->eoc == 0) {\r\ndev_dbg(max8998->dev,\r\n"EOC value not set: leave it unchanged.\n");\r\n} else {\r\ndev_err(max8998->dev, "Invalid EOC value\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nswitch (pdata->restart) {\r\ncase 100:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR1, 0x1 << 3, 0x3 << 3);\r\nbreak;\r\ncase 150:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR1, 0x0 << 3, 0x3 << 3);\r\nbreak;\r\ncase 200:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR1, 0x2 << 3, 0x3 << 3);\r\nbreak;\r\ncase -1:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR1, 0x3 << 3, 0x3 << 3);\r\nbreak;\r\ncase 0:\r\ndev_dbg(max8998->dev,\r\n"Restart Level not set: leave it unchanged.\n");\r\nbreak;\r\ndefault:\r\ndev_err(max8998->dev, "Invalid Restart Level\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nswitch (pdata->timeout) {\r\ncase 5:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR2, 0x0 << 4, 0x3 << 4);\r\nbreak;\r\ncase 6:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR2, 0x1 << 4, 0x3 << 4);\r\nbreak;\r\ncase 7:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR2, 0x2 << 4, 0x3 << 4);\r\nbreak;\r\ncase -1:\r\nmax8998_update_reg(i2c, MAX8998_REG_CHGR2, 0x3 << 4, 0x3 << 4);\r\nbreak;\r\ncase 0:\r\ndev_dbg(max8998->dev,\r\n"Full Timeout not set: leave it unchanged.\n");\r\nbreak;\r\ndefault:\r\ndev_err(max8998->dev, "Invalid Full Timeout value\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\npsy_cfg.drv_data = max8998;\r\nmax8998->battery = power_supply_register(max8998->dev,\r\n&max8998_battery_desc,\r\n&psy_cfg);\r\nif (IS_ERR(max8998->battery)) {\r\nret = PTR_ERR(max8998->battery);\r\ndev_err(max8998->dev, "failed: power supply register: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int max8998_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct max8998_battery_data *max8998 = platform_get_drvdata(pdev);\r\npower_supply_unregister(max8998->battery);\r\nreturn 0;\r\n}

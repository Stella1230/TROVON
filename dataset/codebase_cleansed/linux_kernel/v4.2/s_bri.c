static void bri_cpu_trapped(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *addrHi, *addrLo, *ioaddr;\r\nword *Xlog;\r\ndword regs[4], i, size;\r\nXdesc xlogDesc;\r\nbyte __iomem *Port;\r\nif (!(Xlog = (word *)diva_os_malloc(0, MAX_XLOG_SIZE)))\r\nreturn;\r\nPort = DIVA_OS_MEM_ATTACH_PORT(IoAdapter);\r\naddrHi = Port + ((IoAdapter->Properties.Bus == BUS_PCI) ? M_PCI_ADDRH : ADDRH);\r\naddrLo = Port + ADDR;\r\nioaddr = Port + DATA;\r\noutpp(addrHi, 0);\r\noutppw(addrLo, 0);\r\nfor (i = 0; i < 0x100; Xlog[i++] = inppw(ioaddr));\r\nif (GET_DWORD(&Xlog[0x80 / sizeof(Xlog[0])]) == 0x99999999)\r\n{\r\ndump_trap_frame(IoAdapter, &((byte *)Xlog)[0x90]);\r\nIoAdapter->trapped = 1;\r\n}\r\nregs[0] = GET_DWORD(&((byte *)Xlog)[0x70]);\r\nregs[1] = GET_DWORD(&((byte *)Xlog)[0x74]);\r\nregs[2] = GET_DWORD(&((byte *)Xlog)[0x78]);\r\nregs[3] = GET_DWORD(&((byte *)Xlog)[0x7c]);\r\noutpp(addrHi, (regs[1] >> 16) & 0x7F);\r\noutppw(addrLo, regs[1] & 0xFFFF);\r\nxlogDesc.cnt = inppw(ioaddr);\r\noutpp(addrHi, (regs[2] >> 16) & 0x7F);\r\noutppw(addrLo, regs[2] & 0xFFFF);\r\nxlogDesc.out = inppw(ioaddr);\r\nxlogDesc.buf = Xlog;\r\nregs[0] &= IoAdapter->MemorySize - 1;\r\nif ((regs[0] < IoAdapter->MemorySize - 1))\r\n{\r\nsize = IoAdapter->MemorySize - regs[0];\r\nif (size > MAX_XLOG_SIZE)\r\nsize = MAX_XLOG_SIZE;\r\nfor (i = 0; i < (size / sizeof(*Xlog)); regs[0] += 2)\r\n{\r\noutpp(addrHi, (regs[0] >> 16) & 0x7F);\r\noutppw(addrLo, regs[0] & 0xFFFF);\r\nXlog[i++] = inppw(ioaddr);\r\n}\r\ndump_xlog_buffer(IoAdapter, &xlogDesc);\r\ndiva_os_free(0, Xlog);\r\nIoAdapter->trapped = 2;\r\n}\r\noutpp(addrHi, (byte)((BRI_UNCACHED_ADDR(IoAdapter->MemoryBase + IoAdapter->MemorySize -\r\nBRI_SHARED_RAM_SIZE)) >> 16));\r\noutppw(addrLo, 0x00);\r\nDIVA_OS_MEM_DETACH_PORT(IoAdapter, Port);\r\n}\r\nstatic void reset_bri_hardware(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *p = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\noutpp(p, 0x00);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\n}\r\nstatic void stop_bri_hardware(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *p = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nif (p) {\r\noutpp(p, 0x00);\r\n}\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\noutpp(p, 0x00);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\n}\r\nstatic int load_bri_hardware(PISDN_ADAPTER IoAdapter) {\r\nreturn (0);\r\n}\r\nstatic int bri_ISR(struct _ISDN_ADAPTER *IoAdapter) {\r\nbyte __iomem *p;\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nif (!(inpp(p) & 0x01)) {\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\nreturn (0);\r\n}\r\noutpp(p, 0x08);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\nIoAdapter->IrqCount++;\r\nif (IoAdapter->Initialized) {\r\ndiva_os_schedule_soft_isr(&IoAdapter->isr_soft_isr);\r\n}\r\nreturn (1);\r\n}\r\nstatic void disable_bri_interrupt(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *p;\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nif (p)\r\n{\r\noutpp(p, 0x00);\r\n}\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\noutpp(p, 0x00);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\n}\r\nvoid prepare_maestra_functions(PISDN_ADAPTER IoAdapter) {\r\nADAPTER *a = &IoAdapter->a;\r\na->ram_in = io_in;\r\na->ram_inw = io_inw;\r\na->ram_in_buffer = io_in_buffer;\r\na->ram_look_ahead = io_look_ahead;\r\na->ram_out = io_out;\r\na->ram_outw = io_outw;\r\na->ram_out_buffer = io_out_buffer;\r\na->ram_inc = io_inc;\r\nIoAdapter->MemoryBase = BRI_MEMORY_BASE;\r\nIoAdapter->MemorySize = BRI_MEMORY_SIZE;\r\nIoAdapter->out = pr_out;\r\nIoAdapter->dpc = pr_dpc;\r\nIoAdapter->tst_irq = scom_test_int;\r\nIoAdapter->clr_irq = scom_clear_int;\r\nIoAdapter->pcm = (struct pc_maint *)MIPS_MAINT_OFFS;\r\nIoAdapter->load = load_bri_hardware;\r\nIoAdapter->disIrq = disable_bri_interrupt;\r\nIoAdapter->rstFnc = reset_bri_hardware;\r\nIoAdapter->stop = stop_bri_hardware;\r\nIoAdapter->trapFnc = bri_cpu_trapped;\r\nIoAdapter->diva_isr_handler = bri_ISR;\r\ndiva_os_prepare_maestra_functions(IoAdapter);\r\n}

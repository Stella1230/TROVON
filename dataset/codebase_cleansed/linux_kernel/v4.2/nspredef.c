acpi_status\r\nacpi_ns_check_return_value(struct acpi_namespace_node *node,\r\nstruct acpi_evaluate_info *info,\r\nu32 user_param_count,\r\nacpi_status return_status,\r\nunion acpi_operand_object **return_object_ptr)\r\n{\r\nacpi_status status;\r\nconst union acpi_predefined_info *predefined;\r\npredefined = info->predefined;\r\nif (!predefined) {\r\nreturn (AE_OK);\r\n}\r\nif ((return_status != AE_OK) && (return_status != AE_CTRL_RETURN_VALUE)) {\r\nreturn (AE_OK);\r\n}\r\nif (acpi_gbl_disable_auto_repair ||\r\n(!predefined->info.expected_btypes) ||\r\n(predefined->info.expected_btypes == ACPI_RTYPE_ALL)) {\r\nreturn (AE_OK);\r\n}\r\nstatus = acpi_ns_check_object_type(info, return_object_ptr,\r\npredefined->info.expected_btypes,\r\nACPI_NOT_PACKAGE_ELEMENT);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nif (!(*return_object_ptr)) {\r\ngoto exit;\r\n}\r\nif ((*return_object_ptr)->common.type == ACPI_TYPE_PACKAGE) {\r\ninfo->parent_package = *return_object_ptr;\r\nstatus = acpi_ns_check_package(info, return_object_ptr);\r\nif (ACPI_FAILURE(status)) {\r\nif ((status != AE_AML_OPERAND_TYPE) &&\r\n(status != AE_AML_OPERAND_VALUE)) {\r\ngoto exit;\r\n}\r\n}\r\n}\r\nstatus = acpi_ns_complex_repairs(info, node, status, return_object_ptr);\r\nexit:\r\nif (ACPI_FAILURE(status) || (info->return_flags & ACPI_OBJECT_REPAIRED)) {\r\nnode->flags |= ANOBJ_EVALUATED;\r\n}\r\nreturn (status);\r\n}\r\nacpi_status\r\nacpi_ns_check_object_type(struct acpi_evaluate_info *info,\r\nunion acpi_operand_object **return_object_ptr,\r\nu32 expected_btypes, u32 package_index)\r\n{\r\nunion acpi_operand_object *return_object = *return_object_ptr;\r\nacpi_status status = AE_OK;\r\nchar type_buffer[48];\r\nif (return_object &&\r\nACPI_GET_DESCRIPTOR_TYPE(return_object) == ACPI_DESC_TYPE_NAMED) {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\ninfo->node_flags,\r\n"Invalid return type - Found a Namespace node [%4.4s] type %s",\r\nreturn_object->node.name.ascii,\r\nacpi_ut_get_type_name(return_object->node.\r\ntype)));\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\ninfo->return_btype = acpi_ns_get_bitmapped_type(return_object);\r\nif (info->return_btype == ACPI_RTYPE_ANY) {\r\ngoto type_error_exit;\r\n}\r\nif ((info->return_btype & expected_btypes) == ACPI_RTYPE_REFERENCE) {\r\nstatus = acpi_ns_check_reference(info, return_object);\r\nreturn (status);\r\n}\r\nstatus = acpi_ns_simple_repair(info, expected_btypes,\r\npackage_index, return_object_ptr);\r\nif (ACPI_SUCCESS(status)) {\r\nreturn (AE_OK);\r\n}\r\ntype_error_exit:\r\nacpi_ut_get_expected_return_types(type_buffer, expected_btypes);\r\nif (!return_object) {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\ninfo->node_flags,\r\n"Expected return object of type %s",\r\ntype_buffer));\r\n} else if (package_index == ACPI_NOT_PACKAGE_ELEMENT) {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\ninfo->node_flags,\r\n"Return type mismatch - found %s, expected %s",\r\nacpi_ut_get_object_type_name\r\n(return_object), type_buffer));\r\n} else {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\ninfo->node_flags,\r\n"Return Package type mismatch at index %u - "\r\n"found %s, expected %s", package_index,\r\nacpi_ut_get_object_type_name\r\n(return_object), type_buffer));\r\n}\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\nstatic acpi_status\r\nacpi_ns_check_reference(struct acpi_evaluate_info *info,\r\nunion acpi_operand_object *return_object)\r\n{\r\nif (return_object->reference.class == ACPI_REFCLASS_NAME) {\r\nreturn (AE_OK);\r\n}\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname, info->node_flags,\r\n"Return type mismatch - unexpected reference object type [%s] %2.2X",\r\nacpi_ut_get_reference_name(return_object),\r\nreturn_object->reference.class));\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\nstatic u32 acpi_ns_get_bitmapped_type(union acpi_operand_object *return_object)\r\n{\r\nu32 return_btype;\r\nif (!return_object) {\r\nreturn (ACPI_RTYPE_NONE);\r\n}\r\nswitch (return_object->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\nreturn_btype = ACPI_RTYPE_INTEGER;\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nreturn_btype = ACPI_RTYPE_BUFFER;\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nreturn_btype = ACPI_RTYPE_STRING;\r\nbreak;\r\ncase ACPI_TYPE_PACKAGE:\r\nreturn_btype = ACPI_RTYPE_PACKAGE;\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nreturn_btype = ACPI_RTYPE_REFERENCE;\r\nbreak;\r\ndefault:\r\nreturn_btype = ACPI_RTYPE_ANY;\r\nbreak;\r\n}\r\nreturn (return_btype);\r\n}

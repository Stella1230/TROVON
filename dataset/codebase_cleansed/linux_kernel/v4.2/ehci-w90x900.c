static int usb_w90x900_probe(const struct hc_driver *driver,\r\nstruct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nstruct resource *res;\r\nint retval = 0, irq;\r\nunsigned long val;\r\nhcd = usb_create_hcd(driver, &pdev->dev, "w90x900 EHCI");\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto err1;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(hcd->regs)) {\r\nretval = PTR_ERR(hcd->regs);\r\ngoto err2;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nehci->regs = hcd->regs +\r\nHC_LENGTH(ehci, ehci_readl(ehci, &ehci->caps->hc_capbase));\r\nval = __raw_readl(ehci->regs+PHY0_CTR);\r\nval |= ENPHY;\r\n__raw_writel(val, ehci->regs+PHY0_CTR);\r\nval = __raw_readl(ehci->regs+PHY1_CTR);\r\nval |= ENPHY;\r\n__raw_writel(val, ehci->regs+PHY1_CTR);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nretval = irq;\r\ngoto err2;\r\n}\r\nretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (retval != 0)\r\ngoto err2;\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn retval;\r\nerr2:\r\nusb_put_hcd(hcd);\r\nerr1:\r\nreturn retval;\r\n}\r\nstatic void usb_w90x900_remove(struct usb_hcd *hcd,\r\nstruct platform_device *pdev)\r\n{\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int ehci_w90x900_probe(struct platform_device *pdev)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nreturn usb_w90x900_probe(&ehci_w90x900_hc_driver, pdev);\r\n}\r\nstatic int ehci_w90x900_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_w90x900_remove(hcd, pdev);\r\nreturn 0;\r\n}\r\nstatic int __init ehci_w90X900_init(void)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_info("%s: " DRIVER_DESC "\n", hcd_name);\r\nehci_init_driver(&ehci_w90x900_hc_driver, NULL);\r\nreturn platform_driver_register(&ehci_hcd_w90x900_driver);\r\n}\r\nstatic void __exit ehci_w90X900_cleanup(void)\r\n{\r\nplatform_driver_unregister(&ehci_hcd_w90x900_driver);\r\n}

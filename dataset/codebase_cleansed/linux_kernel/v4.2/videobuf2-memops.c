struct vm_area_struct *vb2_get_vma(struct vm_area_struct *vma)\r\n{\r\nstruct vm_area_struct *vma_copy;\r\nvma_copy = kmalloc(sizeof(*vma_copy), GFP_KERNEL);\r\nif (vma_copy == NULL)\r\nreturn NULL;\r\nif (vma->vm_ops && vma->vm_ops->open)\r\nvma->vm_ops->open(vma);\r\nif (vma->vm_file)\r\nget_file(vma->vm_file);\r\nmemcpy(vma_copy, vma, sizeof(*vma));\r\nvma_copy->vm_mm = NULL;\r\nvma_copy->vm_next = NULL;\r\nvma_copy->vm_prev = NULL;\r\nreturn vma_copy;\r\n}\r\nvoid vb2_put_vma(struct vm_area_struct *vma)\r\n{\r\nif (!vma)\r\nreturn;\r\nif (vma->vm_ops && vma->vm_ops->close)\r\nvma->vm_ops->close(vma);\r\nif (vma->vm_file)\r\nfput(vma->vm_file);\r\nkfree(vma);\r\n}\r\nint vb2_get_contig_userptr(unsigned long vaddr, unsigned long size,\r\nstruct vm_area_struct **res_vma, dma_addr_t *res_pa)\r\n{\r\nstruct mm_struct *mm = current->mm;\r\nstruct vm_area_struct *vma;\r\nunsigned long offset, start, end;\r\nunsigned long this_pfn, prev_pfn;\r\ndma_addr_t pa = 0;\r\nstart = vaddr;\r\noffset = start & ~PAGE_MASK;\r\nend = start + size;\r\nvma = find_vma(mm, start);\r\nif (vma == NULL || vma->vm_end < end)\r\nreturn -EFAULT;\r\nfor (prev_pfn = 0; start < end; start += PAGE_SIZE) {\r\nint ret = follow_pfn(vma, start, &this_pfn);\r\nif (ret)\r\nreturn ret;\r\nif (prev_pfn == 0)\r\npa = this_pfn << PAGE_SHIFT;\r\nelse if (this_pfn != prev_pfn + 1)\r\nreturn -EFAULT;\r\nprev_pfn = this_pfn;\r\n}\r\n*res_vma = vb2_get_vma(vma);\r\nif (*res_vma == NULL)\r\nreturn -ENOMEM;\r\n*res_pa = pa + offset;\r\nreturn 0;\r\n}\r\nstatic void vb2_common_vm_open(struct vm_area_struct *vma)\r\n{\r\nstruct vb2_vmarea_handler *h = vma->vm_private_data;\r\npr_debug("%s: %p, refcount: %d, vma: %08lx-%08lx\n",\r\n__func__, h, atomic_read(h->refcount), vma->vm_start,\r\nvma->vm_end);\r\natomic_inc(h->refcount);\r\n}\r\nstatic void vb2_common_vm_close(struct vm_area_struct *vma)\r\n{\r\nstruct vb2_vmarea_handler *h = vma->vm_private_data;\r\npr_debug("%s: %p, refcount: %d, vma: %08lx-%08lx\n",\r\n__func__, h, atomic_read(h->refcount), vma->vm_start,\r\nvma->vm_end);\r\nh->put(h->arg);\r\n}

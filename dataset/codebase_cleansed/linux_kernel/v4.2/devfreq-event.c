int devfreq_event_enable_edev(struct devfreq_event_dev *edev)\r\n{\r\nint ret = 0;\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nmutex_lock(&edev->lock);\r\nif (edev->desc->ops && edev->desc->ops->enable\r\n&& edev->enable_count == 0) {\r\nret = edev->desc->ops->enable(edev);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nedev->enable_count++;\r\nerr:\r\nmutex_unlock(&edev->lock);\r\nreturn ret;\r\n}\r\nint devfreq_event_disable_edev(struct devfreq_event_dev *edev)\r\n{\r\nint ret = 0;\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nmutex_lock(&edev->lock);\r\nif (edev->enable_count <= 0) {\r\ndev_warn(&edev->dev, "unbalanced enable_count\n");\r\nret = -EIO;\r\ngoto err;\r\n}\r\nif (edev->desc->ops && edev->desc->ops->disable\r\n&& edev->enable_count == 1) {\r\nret = edev->desc->ops->disable(edev);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nedev->enable_count--;\r\nerr:\r\nmutex_unlock(&edev->lock);\r\nreturn ret;\r\n}\r\nbool devfreq_event_is_enabled(struct devfreq_event_dev *edev)\r\n{\r\nbool enabled = false;\r\nif (!edev || !edev->desc)\r\nreturn enabled;\r\nmutex_lock(&edev->lock);\r\nif (edev->enable_count > 0)\r\nenabled = true;\r\nmutex_unlock(&edev->lock);\r\nreturn enabled;\r\n}\r\nint devfreq_event_set_event(struct devfreq_event_dev *edev)\r\n{\r\nint ret;\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nif (!edev->desc->ops || !edev->desc->ops->set_event)\r\nreturn -EINVAL;\r\nif (!devfreq_event_is_enabled(edev))\r\nreturn -EPERM;\r\nmutex_lock(&edev->lock);\r\nret = edev->desc->ops->set_event(edev);\r\nmutex_unlock(&edev->lock);\r\nreturn ret;\r\n}\r\nint devfreq_event_get_event(struct devfreq_event_dev *edev,\r\nstruct devfreq_event_data *edata)\r\n{\r\nint ret;\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nif (!edev->desc->ops || !edev->desc->ops->get_event)\r\nreturn -EINVAL;\r\nif (!devfreq_event_is_enabled(edev))\r\nreturn -EINVAL;\r\nedata->total_count = edata->load_count = 0;\r\nmutex_lock(&edev->lock);\r\nret = edev->desc->ops->get_event(edev, edata);\r\nif (ret < 0)\r\nedata->total_count = edata->load_count = 0;\r\nmutex_unlock(&edev->lock);\r\nreturn ret;\r\n}\r\nint devfreq_event_reset_event(struct devfreq_event_dev *edev)\r\n{\r\nint ret = 0;\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nif (!devfreq_event_is_enabled(edev))\r\nreturn -EPERM;\r\nmutex_lock(&edev->lock);\r\nif (edev->desc->ops && edev->desc->ops->reset)\r\nret = edev->desc->ops->reset(edev);\r\nmutex_unlock(&edev->lock);\r\nreturn ret;\r\n}\r\nstruct devfreq_event_dev *devfreq_event_get_edev_by_phandle(struct device *dev,\r\nint index)\r\n{\r\nstruct device_node *node;\r\nstruct devfreq_event_dev *edev;\r\nif (!dev->of_node) {\r\ndev_err(dev, "device does not have a device node entry\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nnode = of_parse_phandle(dev->of_node, "devfreq-events", index);\r\nif (!node) {\r\ndev_err(dev, "failed to get phandle in %s node\n",\r\ndev->of_node->full_name);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nmutex_lock(&devfreq_event_list_lock);\r\nlist_for_each_entry(edev, &devfreq_event_list, node) {\r\nif (!strcmp(edev->desc->name, node->name))\r\ngoto out;\r\n}\r\nedev = NULL;\r\nout:\r\nmutex_unlock(&devfreq_event_list_lock);\r\nif (!edev) {\r\ndev_err(dev, "unable to get devfreq-event device : %s\n",\r\nnode->name);\r\nof_node_put(node);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nof_node_put(node);\r\nreturn edev;\r\n}\r\nint devfreq_event_get_edev_count(struct device *dev)\r\n{\r\nint count;\r\nif (!dev->of_node) {\r\ndev_err(dev, "device does not have a device node entry\n");\r\nreturn -EINVAL;\r\n}\r\ncount = of_property_count_elems_of_size(dev->of_node, "devfreq-events",\r\nsizeof(u32));\r\nif (count < 0 ) {\r\ndev_err(dev,\r\n"failed to get the count of devfreq-event in %s node\n",\r\ndev->of_node->full_name);\r\nreturn count;\r\n}\r\nreturn count;\r\n}\r\nstatic void devfreq_event_release_edev(struct device *dev)\r\n{\r\nstruct devfreq_event_dev *edev = to_devfreq_event(dev);\r\nkfree(edev);\r\n}\r\nstruct devfreq_event_dev *devfreq_event_add_edev(struct device *dev,\r\nstruct devfreq_event_desc *desc)\r\n{\r\nstruct devfreq_event_dev *edev;\r\nstatic atomic_t event_no = ATOMIC_INIT(0);\r\nint ret;\r\nif (!dev || !desc)\r\nreturn ERR_PTR(-EINVAL);\r\nif (!desc->name || !desc->ops)\r\nreturn ERR_PTR(-EINVAL);\r\nif (!desc->ops->set_event || !desc->ops->get_event)\r\nreturn ERR_PTR(-EINVAL);\r\nedev = kzalloc(sizeof(struct devfreq_event_dev), GFP_KERNEL);\r\nif (!edev)\r\nreturn ERR_PTR(-ENOMEM);\r\nmutex_init(&edev->lock);\r\nedev->desc = desc;\r\nedev->enable_count = 0;\r\nedev->dev.parent = dev;\r\nedev->dev.class = devfreq_event_class;\r\nedev->dev.release = devfreq_event_release_edev;\r\ndev_set_name(&edev->dev, "event.%d", atomic_inc_return(&event_no) - 1);\r\nret = device_register(&edev->dev);\r\nif (ret < 0) {\r\nput_device(&edev->dev);\r\nreturn ERR_PTR(ret);\r\n}\r\ndev_set_drvdata(&edev->dev, edev);\r\nINIT_LIST_HEAD(&edev->node);\r\nmutex_lock(&devfreq_event_list_lock);\r\nlist_add(&edev->node, &devfreq_event_list);\r\nmutex_unlock(&devfreq_event_list_lock);\r\nreturn edev;\r\n}\r\nint devfreq_event_remove_edev(struct devfreq_event_dev *edev)\r\n{\r\nif (!edev)\r\nreturn -EINVAL;\r\nWARN_ON(edev->enable_count);\r\nmutex_lock(&devfreq_event_list_lock);\r\nlist_del(&edev->node);\r\nmutex_unlock(&devfreq_event_list_lock);\r\ndevice_unregister(&edev->dev);\r\nreturn 0;\r\n}\r\nstatic int devm_devfreq_event_match(struct device *dev, void *res, void *data)\r\n{\r\nstruct devfreq_event_dev **r = res;\r\nif (WARN_ON(!r || !*r))\r\nreturn 0;\r\nreturn *r == data;\r\n}\r\nstatic void devm_devfreq_event_release(struct device *dev, void *res)\r\n{\r\ndevfreq_event_remove_edev(*(struct devfreq_event_dev **)res);\r\n}\r\nstruct devfreq_event_dev *devm_devfreq_event_add_edev(struct device *dev,\r\nstruct devfreq_event_desc *desc)\r\n{\r\nstruct devfreq_event_dev **ptr, *edev;\r\nptr = devres_alloc(devm_devfreq_event_release, sizeof(*ptr), GFP_KERNEL);\r\nif (!ptr)\r\nreturn ERR_PTR(-ENOMEM);\r\nedev = devfreq_event_add_edev(dev, desc);\r\nif (IS_ERR(edev)) {\r\ndevres_free(ptr);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\n*ptr = edev;\r\ndevres_add(dev, ptr);\r\nreturn edev;\r\n}\r\nvoid devm_devfreq_event_remove_edev(struct device *dev,\r\nstruct devfreq_event_dev *edev)\r\n{\r\nWARN_ON(devres_release(dev, devm_devfreq_event_release,\r\ndevm_devfreq_event_match, edev));\r\n}\r\nstatic ssize_t name_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct devfreq_event_dev *edev = to_devfreq_event(dev);\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%s\n", edev->desc->name);\r\n}\r\nstatic ssize_t enable_count_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct devfreq_event_dev *edev = to_devfreq_event(dev);\r\nif (!edev || !edev->desc)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", edev->enable_count);\r\n}\r\nstatic int __init devfreq_event_init(void)\r\n{\r\ndevfreq_event_class = class_create(THIS_MODULE, "devfreq-event");\r\nif (IS_ERR(devfreq_event_class)) {\r\npr_err("%s: couldn't create class\n", __FILE__);\r\nreturn PTR_ERR(devfreq_event_class);\r\n}\r\ndevfreq_event_class->dev_groups = devfreq_event_groups;\r\nreturn 0;\r\n}\r\nstatic void __exit devfreq_event_exit(void)\r\n{\r\nclass_destroy(devfreq_event_class);\r\n}

static int __init maxvpes(char *str)\r\n{\r\nget_option(&str, &vpelimit);\r\nreturn 1;\r\n}\r\nstatic int __init maxtcs(char *str)\r\n{\r\nget_option(&str, &tclimit);\r\nreturn 1;\r\n}\r\nvoid mips_mt_regdump(unsigned long mvpctl)\r\n{\r\nunsigned long flags;\r\nunsigned long vpflags;\r\nunsigned long mvpconf0;\r\nint nvpe;\r\nint ntc;\r\nint i;\r\nint tc;\r\nunsigned long haltval;\r\nunsigned long tcstatval;\r\nlocal_irq_save(flags);\r\nvpflags = dvpe();\r\nprintk("=== MIPS MT State Dump ===\n");\r\nprintk("-- Global State --\n");\r\nprintk(" MVPControl Passed: %08lx\n", mvpctl);\r\nprintk(" MVPControl Read: %08lx\n", vpflags);\r\nprintk(" MVPConf0 : %08lx\n", (mvpconf0 = read_c0_mvpconf0()));\r\nnvpe = ((mvpconf0 & MVPCONF0_PVPE) >> MVPCONF0_PVPE_SHIFT) + 1;\r\nntc = ((mvpconf0 & MVPCONF0_PTC) >> MVPCONF0_PTC_SHIFT) + 1;\r\nprintk("-- per-VPE State --\n");\r\nfor (i = 0; i < nvpe; i++) {\r\nfor (tc = 0; tc < ntc; tc++) {\r\nsettc(tc);\r\nif ((read_tc_c0_tcbind() & TCBIND_CURVPE) == i) {\r\nprintk(" VPE %d\n", i);\r\nprintk(" VPEControl : %08lx\n",\r\nread_vpe_c0_vpecontrol());\r\nprintk(" VPEConf0 : %08lx\n",\r\nread_vpe_c0_vpeconf0());\r\nprintk(" VPE%d.Status : %08lx\n",\r\ni, read_vpe_c0_status());\r\nprintk(" VPE%d.EPC : %08lx %pS\n",\r\ni, read_vpe_c0_epc(),\r\n(void *) read_vpe_c0_epc());\r\nprintk(" VPE%d.Cause : %08lx\n",\r\ni, read_vpe_c0_cause());\r\nprintk(" VPE%d.Config7 : %08lx\n",\r\ni, read_vpe_c0_config7());\r\nbreak;\r\n}\r\n}\r\n}\r\nprintk("-- per-TC State --\n");\r\nfor (tc = 0; tc < ntc; tc++) {\r\nsettc(tc);\r\nif (read_tc_c0_tcbind() == read_c0_tcbind()) {\r\nhaltval = 0;\r\ntcstatval = flags;\r\nprintk(" TC %d (current TC with VPE EPC above)\n", tc);\r\n} else {\r\nhaltval = read_tc_c0_tchalt();\r\nwrite_tc_c0_tchalt(1);\r\ntcstatval = read_tc_c0_tcstatus();\r\nprintk(" TC %d\n", tc);\r\n}\r\nprintk(" TCStatus : %08lx\n", tcstatval);\r\nprintk(" TCBind : %08lx\n", read_tc_c0_tcbind());\r\nprintk(" TCRestart : %08lx %pS\n",\r\nread_tc_c0_tcrestart(), (void *) read_tc_c0_tcrestart());\r\nprintk(" TCHalt : %08lx\n", haltval);\r\nprintk(" TCContext : %08lx\n", read_tc_c0_tccontext());\r\nif (!haltval)\r\nwrite_tc_c0_tchalt(0);\r\n}\r\nprintk("===========================\n");\r\nevpe(vpflags);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int __init rps_disable(char *s)\r\n{\r\nmt_opt_norps = 1;\r\nreturn 1;\r\n}\r\nstatic int __init rpsctl_set(char *str)\r\n{\r\nget_option(&str, &mt_opt_rpsctl);\r\nreturn 1;\r\n}\r\nstatic int __init nblsu_set(char *str)\r\n{\r\nget_option(&str, &mt_opt_nblsu);\r\nreturn 1;\r\n}\r\nstatic int __init config7_set(char *str)\r\n{\r\nget_option(&str, &mt_opt_config7);\r\nmt_opt_forceconfig7 = 1;\r\nreturn 1;\r\n}\r\nstatic int __init set_protiflush(char *s)\r\n{\r\nmt_protiflush = 1;\r\nreturn 1;\r\n}\r\nstatic int __init set_protdflush(char *s)\r\n{\r\nmt_protdflush = 1;\r\nreturn 1;\r\n}\r\nstatic int __init niflush(char *s)\r\n{\r\nget_option(&s, &mt_n_iflushes);\r\nreturn 1;\r\n}\r\nstatic int __init ndflush(char *s)\r\n{\r\nget_option(&s, &mt_n_dflushes);\r\nreturn 1;\r\n}\r\nstatic int __init set_itc_base(char *str)\r\n{\r\nget_option(&str, &itc_base);\r\nreturn 1;\r\n}\r\nvoid mips_mt_set_cpuoptions(void)\r\n{\r\nunsigned int oconfig7 = read_c0_config7();\r\nunsigned int nconfig7 = oconfig7;\r\nif (mt_opt_norps) {\r\nprintk("\"norps\" option deprecated: use \"rpsctl=\"\n");\r\n}\r\nif (mt_opt_rpsctl >= 0) {\r\nprintk("34K return prediction stack override set to %d.\n",\r\nmt_opt_rpsctl);\r\nif (mt_opt_rpsctl)\r\nnconfig7 |= (1 << 2);\r\nelse\r\nnconfig7 &= ~(1 << 2);\r\n}\r\nif (mt_opt_nblsu >= 0) {\r\nprintk("34K ALU/LSU sync override set to %d.\n", mt_opt_nblsu);\r\nif (mt_opt_nblsu)\r\nnconfig7 |= (1 << 5);\r\nelse\r\nnconfig7 &= ~(1 << 5);\r\n}\r\nif (mt_opt_forceconfig7) {\r\nprintk("CP0.Config7 forced to 0x%08x.\n", mt_opt_config7);\r\nnconfig7 = mt_opt_config7;\r\n}\r\nif (oconfig7 != nconfig7) {\r\n__asm__ __volatile("sync");\r\nwrite_c0_config7(nconfig7);\r\nehb();\r\nprintk("Config7: 0x%08x\n", read_c0_config7());\r\n}\r\nif (mt_protiflush)\r\nprintk("I-cache flushes single-threaded\n");\r\nif (mt_protdflush)\r\nprintk("D-cache flushes single-threaded\n");\r\nif (mt_n_iflushes != 1)\r\nprintk("I-Cache Flushes Repeated %d times\n", mt_n_iflushes);\r\nif (mt_n_dflushes != 1)\r\nprintk("D-Cache Flushes Repeated %d times\n", mt_n_dflushes);\r\nif (itc_base != 0) {\r\nunsigned long ectlval;\r\nunsigned long itcblkgrn;\r\nectlval = read_c0_ecc();\r\nwrite_c0_ecc(ectlval | (0x1 << 26));\r\nehb();\r\n#define INDEX_0 (0x80000000)\r\n#define INDEX_8 (0x80000008)\r\ncache_op(Index_Load_Tag_D, INDEX_8);\r\nehb();\r\nitcblkgrn = read_c0_dtaglo();\r\nitcblkgrn &= 0xfffe0000;\r\nitcblkgrn |= 0x00000c00;\r\nwrite_c0_dtaglo(itcblkgrn);\r\nehb();\r\ncache_op(Index_Store_Tag_D, INDEX_8);\r\nwrite_c0_dtaglo((itc_base & 0xfffffc00) | 0x1 );\r\nehb();\r\ncache_op(Index_Store_Tag_D, INDEX_0);\r\nwrite_c0_ecc(ectlval);\r\nehb();\r\nprintk("Mapped %ld ITC cells starting at 0x%08x\n",\r\n((itcblkgrn & 0x7fe00000) >> 20), itc_base);\r\n}\r\n}\r\nvoid mt_cflush_lockdown(void)\r\n{\r\n}\r\nvoid mt_cflush_release(void)\r\n{\r\n}\r\nstatic int __init mt_init(void)\r\n{\r\nstruct class *mtc;\r\nmtc = class_create(THIS_MODULE, "mt");\r\nif (IS_ERR(mtc))\r\nreturn PTR_ERR(mtc);\r\nmt_class = mtc;\r\nreturn 0;\r\n}

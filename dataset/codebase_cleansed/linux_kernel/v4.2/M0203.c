u32\r\nnvbios_M0203Te(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct bit_entry bit_M;\r\nu32 data = 0x00000000;\r\nif (!bit_entry(bios, 'M', &bit_M)) {\r\nif (bit_M.version == 2 && bit_M.length > 0x04)\r\ndata = nv_ro16(bios, bit_M.offset + 0x03);\r\nif (data) {\r\n*ver = nv_ro08(bios, data + 0x00);\r\nswitch (*ver) {\r\ncase 0x10:\r\n*hdr = nv_ro08(bios, data + 0x01);\r\n*len = nv_ro08(bios, data + 0x02);\r\n*cnt = nv_ro08(bios, data + 0x03);\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0203Tp(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_M0203T *info)\r\n{\r\nu32 data = nvbios_M0203Te(bios, ver, hdr, cnt, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\ninfo->type = nv_ro08(bios, data + 0x04);\r\ninfo->pointer = nv_ro16(bios, data + 0x05);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_M0203Ee(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr)\r\n{\r\nu8 cnt, len;\r\nu32 data = nvbios_M0203Te(bios, ver, hdr, &cnt, &len);\r\nif (data && idx < cnt) {\r\ndata = data + *hdr + idx * len;\r\n*hdr = len;\r\nreturn data;\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0203Ep(struct nvkm_bios *bios, int idx, u8 *ver, u8 *hdr,\r\nstruct nvbios_M0203E *info)\r\n{\r\nu32 data = nvbios_M0203Ee(bios, idx, ver, hdr);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\ninfo->type = (nv_ro08(bios, data + 0x00) & 0x0f) >> 0;\r\ninfo->strap = (nv_ro08(bios, data + 0x00) & 0xf0) >> 4;\r\ninfo->group = (nv_ro08(bios, data + 0x01) & 0x0f) >> 0;\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0203Em(struct nvkm_bios *bios, u8 ramcfg, u8 *ver, u8 *hdr,\r\nstruct nvbios_M0203E *info)\r\n{\r\nstruct nvbios_M0203T M0203T;\r\nu8 cnt, len, idx = 0xff;\r\nu32 data;\r\nif (!nvbios_M0203Tp(bios, ver, hdr, &cnt, &len, &M0203T)) {\r\nnv_warn(bios, "M0203T not found\n");\r\nreturn 0x00000000;\r\n}\r\nwhile ((data = nvbios_M0203Ep(bios, ++idx, ver, hdr, info))) {\r\nswitch (M0203T.type) {\r\ncase M0203T_TYPE_RAMCFG:\r\nif (info->strap != ramcfg)\r\ncontinue;\r\nreturn data;\r\ndefault:\r\nnv_warn(bios, "M0203T type %02x\n", M0203T.type);\r\nreturn 0x00000000;\r\n}\r\n}\r\nreturn data;\r\n}

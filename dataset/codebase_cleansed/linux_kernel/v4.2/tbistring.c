const TBISTR *__TBIFindStr(const TBISTR *start,\r\nconst char *str, int match_len)\r\n{\r\nconst TBISTR *search = start;\r\nbool exact = true;\r\nconst TBISEG *seg;\r\nif (match_len < 0) {\r\nmatch_len = -match_len;\r\nexact = false;\r\n} else {\r\nif (match_len && str[match_len-1] == '\0')\r\nmatch_len--;\r\n}\r\nif (!search) {\r\nseg = __TBIFindSeg(NULL, TBID_SEG(TBID_THREAD_GLOBAL,\r\nTBID_SEGSCOPE_GLOBAL,\r\nTBID_SEGTYPE_STRING));\r\nif (!seg || seg->Bytes < sizeof(TBISTR))\r\nreturn NULL;\r\nsearch = seg->pGAddr;\r\n}\r\nfor (;;) {\r\nwhile (!search->Tag)\r\nsearch = (const TBISTR *)((const char *)search + 8);\r\nif (search->Tag == METAG_TBI_STRE) {\r\nsearch = NULL;\r\nbreak;\r\n}\r\nif ((search->Len >= match_len) &&\r\n(!exact || (search->Len == match_len + 1)) &&\r\n(search->Tag != METAG_TBI_STRG)) {\r\nif (!strncmp(str, (const char *)search->String,\r\nmatch_len))\r\nbreak;\r\n}\r\nsearch = (const TBISTR *)((const char *)search + search->Bytes);\r\n}\r\nreturn search;\r\n}\r\nconst void *__TBITransStr(const char *str, int len)\r\n{\r\nconst TBISTR *search = NULL;\r\nconst void *res = NULL;\r\nfor (;;) {\r\nsearch = __TBIFindStr(search, str, len);\r\nif (!search)\r\nbreak;\r\nif (search->TransLen != METAG_TBI_STRX) {\r\nres = (const char *)search->String +\r\n((search->Len + 7) & ~7);\r\nbreak;\r\n}\r\nsearch = (const TBISTR *)((const char *)search + search->Bytes);\r\n}\r\nreturn res;\r\n}

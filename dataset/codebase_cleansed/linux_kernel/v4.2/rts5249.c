static u8 rts5249_get_ic_version(struct rtsx_pcr *pcr)\r\n{\r\nu8 val;\r\nrtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\r\nreturn val & 0x0F;\r\n}\r\nstatic void rts5249_fill_driving(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nu8 driving_3v3[4][3] = {\r\n{0x11, 0x11, 0x18},\r\n{0x55, 0x55, 0x5C},\r\n{0xFF, 0xFF, 0xFF},\r\n{0x96, 0x96, 0x96},\r\n};\r\nu8 driving_1v8[4][3] = {\r\n{0xC4, 0xC4, 0xC4},\r\n{0x3C, 0x3C, 0x3C},\r\n{0xFE, 0xFE, 0xFE},\r\n{0xB3, 0xB3, 0xB3},\r\n};\r\nu8 (*driving)[3], drive_sel;\r\nif (voltage == OUTPUT_3V3) {\r\ndriving = driving_3v3;\r\ndrive_sel = pcr->sd30_drive_sel_3v3;\r\n} else {\r\ndriving = driving_1v8;\r\ndrive_sel = pcr->sd30_drive_sel_1v8;\r\n}\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CLK_DRIVE_SEL,\r\n0xFF, driving[drive_sel][0]);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CMD_DRIVE_SEL,\r\n0xFF, driving[drive_sel][1]);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DAT_DRIVE_SEL,\r\n0xFF, driving[drive_sel][2]);\r\n}\r\nstatic void rtsx_base_fetch_vendor_settings(struct rtsx_pcr *pcr)\r\n{\r\nu32 reg;\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG1, &reg);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG1, reg);\r\nif (!rtsx_vendor_setting_valid(reg)) {\r\npcr_dbg(pcr, "skip fetch vendor setting\n");\r\nreturn;\r\n}\r\npcr->aspm_en = rtsx_reg_to_aspm(reg);\r\npcr->sd30_drive_sel_1v8 = rtsx_reg_to_sd30_drive_sel_1v8(reg);\r\npcr->card_drive_sel &= 0x3F;\r\npcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG2, &reg);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG2, reg);\r\npcr->sd30_drive_sel_3v3 = rtsx_reg_to_sd30_drive_sel_3v3(reg);\r\nif (rtsx_reg_check_reverse_socket(reg))\r\npcr->flags |= PCR_REVERSE_SOCKET;\r\n}\r\nstatic void rtsx_base_force_power_down(struct rtsx_pcr *pcr, u8 pm_state)\r\n{\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 1, 0xFF, 0);\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 2, 0xFF, 0);\r\nrtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 3, 0x01, 0);\r\nif (pm_state == HOST_ENTER_S3)\r\nrtsx_pci_write_register(pcr, pcr->reg_pm_ctrl3,\r\nD3_DELINK_MODE_EN, D3_DELINK_MODE_EN);\r\nrtsx_pci_write_register(pcr, FPDCTL, 0x03, 0x03);\r\n}\r\nstatic int rts5249_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, L1SUB_CONFIG3, 0xFF, 0x00);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\r\nrts5249_fill_driving(pcr, OUTPUT_3V3);\r\nif (pcr->flags & PCR_REVERSE_SOCKET)\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0xB0);\r\nelse\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0x80);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5249_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nint err;\r\nerr = rtsx_pci_write_register(pcr, PM_CTRL3, D3_DELINK_MODE_EN, 0x00);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_REV,\r\nPHY_REV_RESV | PHY_REV_RXIDLE_LATCHED |\r\nPHY_REV_P1_EN | PHY_REV_RXIDLE_EN |\r\nPHY_REV_CLKREQ_TX_EN | PHY_REV_RX_PWST |\r\nPHY_REV_CLKREQ_DT_1_0 | PHY_REV_STOP_CLKRD |\r\nPHY_REV_STOP_CLKWR);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(1);\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_BPCR,\r\nPHY_BPCR_IBRXSEL | PHY_BPCR_IBTXSEL |\r\nPHY_BPCR_IB_FILTER | PHY_BPCR_CMIRROR_EN);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_PCR,\r\nPHY_PCR_FORCE_CODE | PHY_PCR_OOBS_CALI_50 |\r\nPHY_PCR_OOBS_VCM_08 | PHY_PCR_OOBS_SEN_90 |\r\nPHY_PCR_RSSI_EN | PHY_PCR_RX10K);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_RCR2,\r\nPHY_RCR2_EMPHASE_EN | PHY_RCR2_NADJR |\r\nPHY_RCR2_CDR_SR_2 | PHY_RCR2_FREQSEL_12 |\r\nPHY_RCR2_CDR_SC_12P | PHY_RCR2_CALIB_LATE);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_FLD4,\r\nPHY_FLD4_FLDEN_SEL | PHY_FLD4_REQ_REF |\r\nPHY_FLD4_RXAMP_OFF | PHY_FLD4_REQ_ADDA |\r\nPHY_FLD4_BER_COUNT | PHY_FLD4_BER_TIMER |\r\nPHY_FLD4_BER_CHK_EN);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_RDR,\r\nPHY_RDR_RXDSEL_1_9 | PHY_SSC_AUTO_PWD);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_RCR1,\r\nPHY_RCR1_ADP_TIME_4 | PHY_RCR1_VCO_COARSE);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_FLD3,\r\nPHY_FLD3_TIMER_4 | PHY_FLD3_TIMER_6 |\r\nPHY_FLD3_RXDELINK);\r\nif (err < 0)\r\nreturn err;\r\nreturn rtsx_pci_write_phy_register(pcr, PHY_TUNE,\r\nPHY_TUNE_TUNEREF_1_0 | PHY_TUNE_VBGSEL_1252 |\r\nPHY_TUNE_SDBUS_33 | PHY_TUNE_TUNED18 |\r\nPHY_TUNE_TUNED12 | PHY_TUNE_TUNEA12);\r\n}\r\nstatic int rtsx_base_turn_on_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\r\n}\r\nstatic int rtsx_base_turn_off_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\r\n}\r\nstatic int rtsx_base_enable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\r\n}\r\nstatic int rtsx_base_disable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\r\n}\r\nstatic int rtsx_base_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_VCC_PARTIAL_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x02);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(5);\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_VCC_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x06);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int rtsx_base_card_power_off(struct rtsx_pcr *pcr, int card)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_POWER_OFF);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rtsx_base_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nint err;\r\nu16 append;\r\nswitch (voltage) {\r\ncase OUTPUT_3V3:\r\nerr = rtsx_pci_update_phy(pcr, PHY_TUNE, PHY_TUNE_VOLTAGE_MASK,\r\nPHY_TUNE_VOLTAGE_3V3);\r\nif (err < 0)\r\nreturn err;\r\nbreak;\r\ncase OUTPUT_1V8:\r\nappend = PHY_TUNE_D18_1V8;\r\nif (CHK_PCI_PID(pcr, 0x5249)) {\r\nerr = rtsx_pci_update_phy(pcr, PHY_BACR,\r\nPHY_BACR_BASIC_MASK, 0);\r\nif (err < 0)\r\nreturn err;\r\nappend = PHY_TUNE_D18_1V7;\r\n}\r\nerr = rtsx_pci_update_phy(pcr, PHY_TUNE, PHY_TUNE_VOLTAGE_MASK,\r\nappend);\r\nif (err < 0)\r\nreturn err;\r\nbreak;\r\ndefault:\r\npcr_dbg(pcr, "unknown output voltage %d\n", voltage);\r\nreturn -EINVAL;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrts5249_fill_driving(pcr, voltage);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nvoid rts5249_init_params(struct rtsx_pcr *pcr)\r\n{\r\npcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\r\npcr->num_slots = 2;\r\npcr->ops = &rts5249_pcr_ops;\r\npcr->flags = 0;\r\npcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\r\npcr->sd30_drive_sel_1v8 = CFG_DRIVER_TYPE_B;\r\npcr->sd30_drive_sel_3v3 = CFG_DRIVER_TYPE_B;\r\npcr->aspm_en = ASPM_L1_EN;\r\npcr->tx_initial_phase = SET_CLOCK_PHASE(1, 29, 16);\r\npcr->rx_initial_phase = SET_CLOCK_PHASE(24, 6, 5);\r\npcr->ic_version = rts5249_get_ic_version(pcr);\r\npcr->sd_pull_ctl_enable_tbl = rts5249_sd_pull_ctl_enable_tbl;\r\npcr->sd_pull_ctl_disable_tbl = rts5249_sd_pull_ctl_disable_tbl;\r\npcr->ms_pull_ctl_enable_tbl = rts5249_ms_pull_ctl_enable_tbl;\r\npcr->ms_pull_ctl_disable_tbl = rts5249_ms_pull_ctl_disable_tbl;\r\npcr->reg_pm_ctrl3 = PM_CTRL3;\r\n}\r\nstatic int rts524a_write_phy(struct rtsx_pcr *pcr, u8 addr, u16 val)\r\n{\r\naddr = addr & 0x80 ? (addr & 0x7F) | 0x40 : addr;\r\nreturn __rtsx_pci_write_phy_register(pcr, addr, val);\r\n}\r\nstatic int rts524a_read_phy(struct rtsx_pcr *pcr, u8 addr, u16 *val)\r\n{\r\naddr = addr & 0x80 ? (addr & 0x7F) | 0x40 : addr;\r\nreturn __rtsx_pci_read_phy_register(pcr, addr, val);\r\n}\r\nstatic int rts524a_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nint err;\r\nerr = rtsx_pci_write_register(pcr, RTS524A_PM_CTRL3,\r\nD3_DELINK_MODE_EN, 0x00);\r\nif (err < 0)\r\nreturn err;\r\nrtsx_pci_write_phy_register(pcr, PHY_PCR,\r\nPHY_PCR_FORCE_CODE | PHY_PCR_OOBS_CALI_50 |\r\nPHY_PCR_OOBS_VCM_08 | PHY_PCR_OOBS_SEN_90 | PHY_PCR_RSSI_EN);\r\nrtsx_pci_write_phy_register(pcr, PHY_SSCCR3,\r\nPHY_SSCCR3_STEP_IN | PHY_SSCCR3_CHECK_DELAY);\r\nif (is_version(pcr, 0x524A, IC_VER_A)) {\r\nrtsx_pci_write_phy_register(pcr, PHY_SSCCR3,\r\nPHY_SSCCR3_STEP_IN | PHY_SSCCR3_CHECK_DELAY);\r\nrtsx_pci_write_phy_register(pcr, PHY_SSCCR2,\r\nPHY_SSCCR2_PLL_NCODE | PHY_SSCCR2_TIME0 |\r\nPHY_SSCCR2_TIME2_WIDTH);\r\nrtsx_pci_write_phy_register(pcr, PHY_ANA1A,\r\nPHY_ANA1A_TXR_LOOPBACK | PHY_ANA1A_RXT_BIST |\r\nPHY_ANA1A_TXR_BIST | PHY_ANA1A_REV);\r\nrtsx_pci_write_phy_register(pcr, PHY_ANA1D,\r\nPHY_ANA1D_DEBUG_ADDR);\r\nrtsx_pci_write_phy_register(pcr, PHY_DIG1E,\r\nPHY_DIG1E_REV | PHY_DIG1E_D0_X_D1 |\r\nPHY_DIG1E_RX_ON_HOST | PHY_DIG1E_RCLK_REF_HOST |\r\nPHY_DIG1E_RCLK_TX_EN_KEEP |\r\nPHY_DIG1E_RCLK_TX_TERM_KEEP |\r\nPHY_DIG1E_RCLK_RX_EIDLE_ON | PHY_DIG1E_TX_TERM_KEEP |\r\nPHY_DIG1E_RX_TERM_KEEP | PHY_DIG1E_TX_EN_KEEP |\r\nPHY_DIG1E_RX_EN_KEEP);\r\n}\r\nrtsx_pci_write_phy_register(pcr, PHY_ANA08,\r\nPHY_ANA08_RX_EQ_DCGAIN | PHY_ANA08_SEL_RX_EN |\r\nPHY_ANA08_RX_EQ_VAL | PHY_ANA08_SCP | PHY_ANA08_SEL_IPI);\r\nreturn 0;\r\n}\r\nstatic int rts524a_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrts5249_extra_init_hw(pcr);\r\nrtsx_pci_write_register(pcr, FUNC_FORCE_CTL,\r\nFORCE_ASPM_L1_EN, FORCE_ASPM_L1_EN);\r\nrtsx_pci_write_register(pcr, PM_EVENT_DEBUG, PME_DEBUG_0, PME_DEBUG_0);\r\nrtsx_pci_write_register(pcr, LDO_VCC_CFG1, LDO_VCC_LMT_EN,\r\nLDO_VCC_LMT_EN);\r\nrtsx_pci_write_register(pcr, PCLK_CTL, PCLK_MODE_SEL, PCLK_MODE_SEL);\r\nif (is_version(pcr, 0x524A, IC_VER_A)) {\r\nrtsx_pci_write_register(pcr, LDO_DV18_CFG,\r\nLDO_DV18_SR_MASK, LDO_DV18_SR_DF);\r\nrtsx_pci_write_register(pcr, LDO_VCC_CFG1,\r\nLDO_VCC_REF_TUNE_MASK, LDO_VCC_REF_1V2);\r\nrtsx_pci_write_register(pcr, LDO_VIO_CFG,\r\nLDO_VIO_REF_TUNE_MASK, LDO_VIO_REF_1V2);\r\nrtsx_pci_write_register(pcr, LDO_VIO_CFG,\r\nLDO_VIO_SR_MASK, LDO_VIO_SR_DF);\r\nrtsx_pci_write_register(pcr, LDO_DV12S_CFG,\r\nLDO_REF12_TUNE_MASK, LDO_REF12_TUNE_DF);\r\nrtsx_pci_write_register(pcr, SD40_LDO_CTL1,\r\nSD40_VIO_TUNE_MASK, SD40_VIO_TUNE_1V7);\r\n}\r\nreturn 0;\r\n}\r\nvoid rts524a_init_params(struct rtsx_pcr *pcr)\r\n{\r\nrts5249_init_params(pcr);\r\npcr->reg_pm_ctrl3 = RTS524A_PM_CTRL3;\r\npcr->ops = &rts524a_pcr_ops;\r\n}\r\nstatic int rts525a_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nrtsx_pci_write_register(pcr, LDO_VCC_CFG1,\r\nLDO_VCC_TUNE_MASK, LDO_VCC_3V3);\r\nreturn rtsx_base_card_power_on(pcr, card);\r\n}\r\nstatic int rts525a_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nswitch (voltage) {\r\ncase OUTPUT_3V3:\r\nrtsx_pci_write_register(pcr, LDO_CONFIG2,\r\nLDO_D3318_MASK, LDO_D3318_33V);\r\nrtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8, 0);\r\nbreak;\r\ncase OUTPUT_1V8:\r\nrtsx_pci_write_register(pcr, LDO_CONFIG2,\r\nLDO_D3318_MASK, LDO_D3318_18V);\r\nrtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8,\r\nSD_IO_USING_1V8);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrts5249_fill_driving(pcr, voltage);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts525a_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nint err;\r\nerr = rtsx_pci_write_register(pcr, RTS524A_PM_CTRL3,\r\nD3_DELINK_MODE_EN, 0x00);\r\nif (err < 0)\r\nreturn err;\r\nrtsx_pci_write_phy_register(pcr, _PHY_FLD0,\r\n_PHY_FLD0_CLK_REQ_20C | _PHY_FLD0_RX_IDLE_EN |\r\n_PHY_FLD0_BIT_ERR_RSTN | _PHY_FLD0_BER_COUNT |\r\n_PHY_FLD0_BER_TIMER | _PHY_FLD0_CHECK_EN);\r\nrtsx_pci_write_phy_register(pcr, _PHY_ANA03,\r\n_PHY_ANA03_TIMER_MAX | _PHY_ANA03_OOBS_DEB_EN |\r\n_PHY_CMU_DEBUG_EN);\r\nif (is_version(pcr, 0x525A, IC_VER_A))\r\nrtsx_pci_write_phy_register(pcr, _PHY_REV0,\r\n_PHY_REV0_FILTER_OUT | _PHY_REV0_CDR_BYPASS_PFD |\r\n_PHY_REV0_CDR_RX_IDLE_BYPASS);\r\nreturn 0;\r\n}\r\nstatic int rts525a_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrts5249_extra_init_hw(pcr);\r\nrtsx_pci_write_register(pcr, PCLK_CTL, PCLK_MODE_SEL, PCLK_MODE_SEL);\r\nif (is_version(pcr, 0x525A, IC_VER_A)) {\r\nrtsx_pci_write_register(pcr, L1SUB_CONFIG2,\r\nL1SUB_AUTO_CFG, L1SUB_AUTO_CFG);\r\nrtsx_pci_write_register(pcr, RREF_CFG,\r\nRREF_VBGSEL_MASK, RREF_VBGSEL_1V25);\r\nrtsx_pci_write_register(pcr, LDO_VIO_CFG,\r\nLDO_VIO_TUNE_MASK, LDO_VIO_1V7);\r\nrtsx_pci_write_register(pcr, LDO_DV12S_CFG,\r\nLDO_D12_TUNE_MASK, LDO_D12_TUNE_DF);\r\nrtsx_pci_write_register(pcr, LDO_AV12S_CFG,\r\nLDO_AV12S_TUNE_MASK, LDO_AV12S_TUNE_DF);\r\nrtsx_pci_write_register(pcr, LDO_VCC_CFG0,\r\nLDO_VCC_LMTVTH_MASK, LDO_VCC_LMTVTH_2A);\r\nrtsx_pci_write_register(pcr, OOBS_CONFIG,\r\nOOBS_AUTOK_DIS | OOBS_VAL_MASK, 0x89);\r\n}\r\nreturn 0;\r\n}\r\nvoid rts525a_init_params(struct rtsx_pcr *pcr)\r\n{\r\nrts5249_init_params(pcr);\r\npcr->reg_pm_ctrl3 = RTS524A_PM_CTRL3;\r\npcr->ops = &rts525a_pcr_ops;\r\n}

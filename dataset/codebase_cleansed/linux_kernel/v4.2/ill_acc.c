static irqreturn_t ill_acc_irq_handler(int irq, void *_priv)\r\n{\r\nstruct device *dev = (struct device *) _priv;\r\nu32 addr = rt_memc_r32(REG_ILL_ACC_ADDR);\r\nu32 type = rt_memc_r32(REG_ILL_ACC_TYPE);\r\ndev_err(dev, "illegal %s access from %s - addr:0x%08x offset:%d len:%d\n",\r\n(type & ILL_ACC_WRITE) ? ("write") : ("read"),\r\nill_acc_ids[(type >> ILL_ACC_ID_S) & ILL_ACC_ID_M],\r\naddr, (type >> ILL_ACC_OFF_S) & ILL_ACC_OFF_M,\r\ntype & ILL_ACC_LEN_M);\r\nrt_memc_w32(ILL_INT_STATUS, REG_ILL_ACC_TYPE);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init ill_acc_of_setup(void)\r\n{\r\nstruct platform_device *pdev;\r\nstruct device_node *np;\r\nint irq;\r\nif (of_machine_is_compatible("ralink,rt5350-soc"))\r\nreturn -EINVAL;\r\nnp = of_find_compatible_node(NULL, NULL, "ralink,rt3050-memc");\r\nif (!np)\r\nreturn -EINVAL;\r\npdev = of_find_device_by_node(np);\r\nif (!pdev) {\r\npr_err("%s: failed to lookup pdev\n", np->name);\r\nreturn -EINVAL;\r\n}\r\nirq = irq_of_parse_and_map(np, 0);\r\nif (!irq) {\r\ndev_err(&pdev->dev, "failed to get irq\n");\r\nreturn -EINVAL;\r\n}\r\nif (request_irq(irq, ill_acc_irq_handler, 0, "ill_acc", &pdev->dev)) {\r\ndev_err(&pdev->dev, "failed to request irq\n");\r\nreturn -EINVAL;\r\n}\r\nrt_memc_w32(ILL_INT_STATUS, REG_ILL_ACC_TYPE);\r\ndev_info(&pdev->dev, "irq registered\n");\r\nreturn 0;\r\n}

static struct mdp4_kms *get_kms(struct mdp4_lvds_pll *lvds_pll)\r\n{\r\nstruct msm_drm_private *priv = lvds_pll->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic const struct pll_rate *find_rate(unsigned long rate)\r\n{\r\nint i;\r\nfor (i = 1; i < ARRAY_SIZE(freqtbl); i++)\r\nif (rate > freqtbl[i].rate)\r\nreturn &freqtbl[i-1];\r\nreturn &freqtbl[i-1];\r\n}\r\nstatic int mpd4_lvds_pll_enable(struct clk_hw *hw)\r\n{\r\nstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\r\nstruct mdp4_kms *mdp4_kms = get_kms(lvds_pll);\r\nconst struct pll_rate *pll_rate = find_rate(lvds_pll->pixclk);\r\nint i;\r\nDBG("pixclk=%lu (%lu)", lvds_pll->pixclk, pll_rate->rate);\r\nif (WARN_ON(!pll_rate))\r\nreturn -EINVAL;\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_PHY_RESET, 0x33);\r\nfor (i = 0; pll_rate->conf[i].reg; i++)\r\nmdp4_write(mdp4_kms, pll_rate->conf[i].reg, pll_rate->conf[i].val);\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_CTRL_0, 0x01);\r\nwhile (!mdp4_read(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_LOCKED))\r\ncpu_relax();\r\nreturn 0;\r\n}\r\nstatic void mpd4_lvds_pll_disable(struct clk_hw *hw)\r\n{\r\nstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\r\nstruct mdp4_kms *mdp4_kms = get_kms(lvds_pll);\r\nDBG("");\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_CFG0, 0x0);\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_CTRL_0, 0x0);\r\n}\r\nstatic unsigned long mpd4_lvds_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\r\nreturn lvds_pll->pixclk;\r\n}\r\nstatic long mpd4_lvds_pll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nconst struct pll_rate *pll_rate = find_rate(rate);\r\nreturn pll_rate->rate;\r\n}\r\nstatic int mpd4_lvds_pll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\r\nlvds_pll->pixclk = rate;\r\nreturn 0;\r\n}\r\nstruct clk *mpd4_lvds_pll_init(struct drm_device *dev)\r\n{\r\nstruct mdp4_lvds_pll *lvds_pll;\r\nstruct clk *clk;\r\nint ret;\r\nlvds_pll = devm_kzalloc(dev->dev, sizeof(*lvds_pll), GFP_KERNEL);\r\nif (!lvds_pll) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nlvds_pll->dev = dev;\r\nlvds_pll->pll_hw.init = &pll_init;\r\nclk = devm_clk_register(dev->dev, &lvds_pll->pll_hw);\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto fail;\r\n}\r\nreturn clk;\r\nfail:\r\nreturn ERR_PTR(ret);\r\n}

int pinctrl_utils_reserve_map(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_map **map, unsigned *reserved_maps,\r\nunsigned *num_maps, unsigned reserve)\r\n{\r\nunsigned old_num = *reserved_maps;\r\nunsigned new_num = *num_maps + reserve;\r\nstruct pinctrl_map *new_map;\r\nif (old_num >= new_num)\r\nreturn 0;\r\nnew_map = krealloc(*map, sizeof(*new_map) * new_num, GFP_KERNEL);\r\nif (!new_map) {\r\ndev_err(pctldev->dev, "krealloc(map) failed\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(new_map + old_num, 0, (new_num - old_num) * sizeof(*new_map));\r\n*map = new_map;\r\n*reserved_maps = new_num;\r\nreturn 0;\r\n}\r\nint pinctrl_utils_add_map_mux(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_map **map, unsigned *reserved_maps,\r\nunsigned *num_maps, const char *group,\r\nconst char *function)\r\n{\r\nif (WARN_ON(*num_maps == *reserved_maps))\r\nreturn -ENOSPC;\r\n(*map)[*num_maps].type = PIN_MAP_TYPE_MUX_GROUP;\r\n(*map)[*num_maps].data.mux.group = group;\r\n(*map)[*num_maps].data.mux.function = function;\r\n(*num_maps)++;\r\nreturn 0;\r\n}\r\nint pinctrl_utils_add_map_configs(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_map **map, unsigned *reserved_maps,\r\nunsigned *num_maps, const char *group,\r\nunsigned long *configs, unsigned num_configs,\r\nenum pinctrl_map_type type)\r\n{\r\nunsigned long *dup_configs;\r\nif (WARN_ON(*num_maps == *reserved_maps))\r\nreturn -ENOSPC;\r\ndup_configs = kmemdup(configs, num_configs * sizeof(*dup_configs),\r\nGFP_KERNEL);\r\nif (!dup_configs) {\r\ndev_err(pctldev->dev, "kmemdup(configs) failed\n");\r\nreturn -ENOMEM;\r\n}\r\n(*map)[*num_maps].type = type;\r\n(*map)[*num_maps].data.configs.group_or_pin = group;\r\n(*map)[*num_maps].data.configs.configs = dup_configs;\r\n(*map)[*num_maps].data.configs.num_configs = num_configs;\r\n(*num_maps)++;\r\nreturn 0;\r\n}\r\nint pinctrl_utils_add_config(struct pinctrl_dev *pctldev,\r\nunsigned long **configs, unsigned *num_configs,\r\nunsigned long config)\r\n{\r\nunsigned old_num = *num_configs;\r\nunsigned new_num = old_num + 1;\r\nunsigned long *new_configs;\r\nnew_configs = krealloc(*configs, sizeof(*new_configs) * new_num,\r\nGFP_KERNEL);\r\nif (!new_configs) {\r\ndev_err(pctldev->dev, "krealloc(configs) failed\n");\r\nreturn -ENOMEM;\r\n}\r\nnew_configs[old_num] = config;\r\n*configs = new_configs;\r\n*num_configs = new_num;\r\nreturn 0;\r\n}\r\nvoid pinctrl_utils_dt_free_map(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_map *map, unsigned num_maps)\r\n{\r\nint i;\r\nfor (i = 0; i < num_maps; i++) {\r\nswitch (map[i].type) {\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\nkfree(map[i].data.configs.configs);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nkfree(map);\r\n}

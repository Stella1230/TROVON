static inline int da9030_reg_to_mV(int reg)\r\n{\r\nreturn ((reg * 2650) >> 8) + 2650;\r\n}\r\nstatic inline int da9030_millivolt_to_reg(int mV)\r\n{\r\nreturn ((mV - 2650) << 8) / 2650;\r\n}\r\nstatic inline int da9030_reg_to_mA(int reg)\r\n{\r\nreturn ((reg * 24000) >> 8) / 15;\r\n}\r\nstatic int bat_debug_show(struct seq_file *s, void *data)\r\n{\r\nstruct da9030_charger *charger = s->private;\r\nseq_printf(s, "charger is %s\n", charger->is_on ? "on" : "off");\r\nif (charger->chdet) {\r\nseq_printf(s, "iset = %dmA, vset = %dmV\n",\r\ncharger->mA, charger->mV);\r\n}\r\nseq_printf(s, "vbat_res = %d (%dmV)\n",\r\ncharger->adc.vbat_res,\r\nda9030_reg_to_mV(charger->adc.vbat_res));\r\nseq_printf(s, "vbatmin_res = %d (%dmV)\n",\r\ncharger->adc.vbatmin_res,\r\nda9030_reg_to_mV(charger->adc.vbatmin_res));\r\nseq_printf(s, "vbatmintxon = %d (%dmV)\n",\r\ncharger->adc.vbatmintxon,\r\nda9030_reg_to_mV(charger->adc.vbatmintxon));\r\nseq_printf(s, "ichmax_res = %d (%dmA)\n",\r\ncharger->adc.ichmax_res,\r\nda9030_reg_to_mV(charger->adc.ichmax_res));\r\nseq_printf(s, "ichmin_res = %d (%dmA)\n",\r\ncharger->adc.ichmin_res,\r\nda9030_reg_to_mA(charger->adc.ichmin_res));\r\nseq_printf(s, "ichaverage_res = %d (%dmA)\n",\r\ncharger->adc.ichaverage_res,\r\nda9030_reg_to_mA(charger->adc.ichaverage_res));\r\nseq_printf(s, "vchmax_res = %d (%dmV)\n",\r\ncharger->adc.vchmax_res,\r\nda9030_reg_to_mA(charger->adc.vchmax_res));\r\nseq_printf(s, "vchmin_res = %d (%dmV)\n",\r\ncharger->adc.vchmin_res,\r\nda9030_reg_to_mV(charger->adc.vchmin_res));\r\nreturn 0;\r\n}\r\nstatic int debug_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, bat_debug_show, inode->i_private);\r\n}\r\nstatic struct dentry *da9030_bat_create_debugfs(struct da9030_charger *charger)\r\n{\r\ncharger->debug_file = debugfs_create_file("charger", 0666, NULL,\r\ncharger, &bat_debug_fops);\r\nreturn charger->debug_file;\r\n}\r\nstatic void da9030_bat_remove_debugfs(struct da9030_charger *charger)\r\n{\r\ndebugfs_remove(charger->debug_file);\r\n}\r\nstatic inline struct dentry *da9030_bat_create_debugfs(struct da9030_charger *charger)\r\n{\r\nreturn NULL;\r\n}\r\nstatic inline void da9030_bat_remove_debugfs(struct da9030_charger *charger)\r\n{\r\n}\r\nstatic inline void da9030_read_adc(struct da9030_charger *charger,\r\nstruct da9030_adc_res *adc)\r\n{\r\nda903x_reads(charger->master, DA9030_VBAT_RES,\r\nsizeof(*adc), (uint8_t *)adc);\r\n}\r\nstatic void da9030_charger_update_state(struct da9030_charger *charger)\r\n{\r\nuint8_t val;\r\nda903x_read(charger->master, DA9030_CHARGE_CONTROL, &val);\r\ncharger->is_on = (val & DA9030_CHRG_CHARGER_ENABLE) ? 1 : 0;\r\ncharger->mA = ((val >> 3) & 0xf) * 100;\r\ncharger->mV = (val & 0x7) * 50 + 4000;\r\nda9030_read_adc(charger, &charger->adc);\r\nda903x_read(charger->master, DA9030_FAULT_LOG, &charger->fault);\r\ncharger->chdet = da903x_query_status(charger->master,\r\nDA9030_STATUS_CHDET);\r\n}\r\nstatic void da9030_set_charge(struct da9030_charger *charger, int on)\r\n{\r\nuint8_t val;\r\nif (on) {\r\nval = DA9030_CHRG_CHARGER_ENABLE;\r\nval |= (charger->charge_milliamp / 100) << 3;\r\nval |= (charger->charge_millivolt - 4000) / 50;\r\ncharger->is_on = 1;\r\n} else {\r\nval = 0;\r\ncharger->is_on = 0;\r\n}\r\nda903x_write(charger->master, DA9030_CHARGE_CONTROL, val);\r\npower_supply_changed(charger->psy);\r\n}\r\nstatic void da9030_charger_check_state(struct da9030_charger *charger)\r\n{\r\nda9030_charger_update_state(charger);\r\nif (!charger->is_on) {\r\nif ((charger->chdet) &&\r\n(charger->adc.vbat_res <\r\ncharger->thresholds.vbat_charge_start)) {\r\nda9030_set_charge(charger, 1);\r\n}\r\n} else {\r\nif (!charger->chdet) {\r\nda9030_set_charge(charger, 0);\r\nreturn;\r\n}\r\nif (charger->adc.vbat_res >=\r\ncharger->thresholds.vbat_charge_stop) {\r\nda9030_set_charge(charger, 0);\r\nda903x_write(charger->master, DA9030_VBATMON,\r\ncharger->thresholds.vbat_charge_restart);\r\n} else if (charger->adc.vbat_res >\r\ncharger->thresholds.vbat_low) {\r\nda903x_write(charger->master, DA9030_VBATMON,\r\ncharger->thresholds.vbat_low);\r\n}\r\nif (charger->adc.vchmax_res > charger->thresholds.vcharge_max ||\r\ncharger->adc.vchmin_res < charger->thresholds.vcharge_min ||\r\ncharger->adc.tbat_res < charger->thresholds.tbat_high ||\r\ncharger->adc.tbat_res > charger->thresholds.tbat_low) {\r\nda9030_set_charge(charger, 0);\r\n}\r\n}\r\n}\r\nstatic void da9030_charging_monitor(struct work_struct *work)\r\n{\r\nstruct da9030_charger *charger;\r\ncharger = container_of(work, struct da9030_charger, work.work);\r\nda9030_charger_check_state(charger);\r\nschedule_delayed_work(&charger->work, charger->interval);\r\n}\r\nstatic void da9030_battery_check_status(struct da9030_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nif (charger->chdet) {\r\nif (charger->is_on)\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\n} else {\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\n}\r\nstatic void da9030_battery_check_health(struct da9030_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nif (charger->fault & DA9030_FAULT_LOG_OVER_TEMP)\r\nval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nelse if (charger->fault & DA9030_FAULT_LOG_VBAT_OVER)\r\nval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nelse\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\nstatic int da9030_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct da9030_charger *charger = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nda9030_battery_check_status(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nda9030_battery_check_health(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = charger->battery_info->technology;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nval->intval = charger->battery_info->voltage_max_design;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nval->intval = charger->battery_info->voltage_min_design;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = da9030_reg_to_mV(charger->adc.vbat_res) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_AVG:\r\nval->intval =\r\nda9030_reg_to_mA(charger->adc.ichaverage_res) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = charger->battery_info->name;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void da9030_battery_vbat_event(struct da9030_charger *charger)\r\n{\r\nda9030_read_adc(charger, &charger->adc);\r\nif (charger->is_on)\r\nreturn;\r\nif (charger->adc.vbat_res < charger->thresholds.vbat_low) {\r\nda903x_write(charger->master, DA9030_VBATMON,\r\ncharger->thresholds.vbat_crit);\r\nif (charger->battery_low)\r\ncharger->battery_low();\r\n} else if (charger->adc.vbat_res <\r\ncharger->thresholds.vbat_crit) {\r\nif (charger->battery_critical)\r\ncharger->battery_critical();\r\n}\r\n}\r\nstatic int da9030_battery_event(struct notifier_block *nb, unsigned long event,\r\nvoid *data)\r\n{\r\nstruct da9030_charger *charger =\r\ncontainer_of(nb, struct da9030_charger, nb);\r\nswitch (event) {\r\ncase DA9030_EVENT_CHDET:\r\ncancel_delayed_work_sync(&charger->work);\r\nschedule_work(&charger->work.work);\r\nbreak;\r\ncase DA9030_EVENT_VBATMON:\r\nda9030_battery_vbat_event(charger);\r\nbreak;\r\ncase DA9030_EVENT_CHIOVER:\r\ncase DA9030_EVENT_TBAT:\r\nda9030_set_charge(charger, 0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void da9030_battery_convert_thresholds(struct da9030_charger *charger,\r\nstruct da9030_battery_info *pdata)\r\n{\r\ncharger->thresholds.tbat_low = pdata->tbat_low;\r\ncharger->thresholds.tbat_high = pdata->tbat_high;\r\ncharger->thresholds.tbat_restart = pdata->tbat_restart;\r\ncharger->thresholds.vbat_low =\r\nda9030_millivolt_to_reg(pdata->vbat_low);\r\ncharger->thresholds.vbat_crit =\r\nda9030_millivolt_to_reg(pdata->vbat_crit);\r\ncharger->thresholds.vbat_charge_start =\r\nda9030_millivolt_to_reg(pdata->vbat_charge_start);\r\ncharger->thresholds.vbat_charge_stop =\r\nda9030_millivolt_to_reg(pdata->vbat_charge_stop);\r\ncharger->thresholds.vbat_charge_restart =\r\nda9030_millivolt_to_reg(pdata->vbat_charge_restart);\r\ncharger->thresholds.vcharge_min =\r\nda9030_millivolt_to_reg(pdata->vcharge_min);\r\ncharger->thresholds.vcharge_max =\r\nda9030_millivolt_to_reg(pdata->vcharge_max);\r\n}\r\nstatic void da9030_battery_setup_psy(struct da9030_charger *charger)\r\n{\r\nstruct power_supply_desc *psy_desc = &charger->psy_desc;\r\nstruct power_supply_info *info = charger->battery_info;\r\npsy_desc->name = info->name;\r\npsy_desc->use_for_apm = info->use_for_apm;\r\npsy_desc->type = POWER_SUPPLY_TYPE_BATTERY;\r\npsy_desc->get_property = da9030_battery_get_property;\r\npsy_desc->properties = da9030_battery_props;\r\npsy_desc->num_properties = ARRAY_SIZE(da9030_battery_props);\r\n}\r\nstatic int da9030_battery_charger_init(struct da9030_charger *charger)\r\n{\r\nchar v[5];\r\nint ret;\r\nv[0] = v[1] = charger->thresholds.vbat_low;\r\nv[2] = charger->thresholds.tbat_high;\r\nv[3] = charger->thresholds.tbat_restart;\r\nv[4] = charger->thresholds.tbat_low;\r\nret = da903x_writes(charger->master, DA9030_VBATMON, 5, v);\r\nif (ret)\r\nreturn ret;\r\nret = da903x_write(charger->master, DA9030_ADC_MAN_CONTROL,\r\nDA9030_ADC_LDO_INT_ENABLE |\r\nDA9030_ADC_TBATREF_ENABLE);\r\nif (ret)\r\nreturn ret;\r\nreturn da903x_write(charger->master, DA9030_ADC_AUTO_CONTROL,\r\nDA9030_ADC_TBAT_ENABLE | DA9030_ADC_VBAT_IN_TXON |\r\nDA9030_ADC_VCH_ENABLE | DA9030_ADC_ICH_ENABLE |\r\nDA9030_ADC_VBAT_ENABLE |\r\nDA9030_ADC_AUTO_SLEEP_ENABLE);\r\n}\r\nstatic int da9030_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct da9030_charger *charger;\r\nstruct power_supply_config psy_cfg = {};\r\nstruct da9030_battery_info *pdata = pdev->dev.platform_data;\r\nint ret;\r\nif (pdata == NULL)\r\nreturn -EINVAL;\r\nif (pdata->charge_milliamp >= 1500 ||\r\npdata->charge_millivolt < 4000 ||\r\npdata->charge_millivolt > 4350)\r\nreturn -EINVAL;\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\r\nif (charger == NULL)\r\nreturn -ENOMEM;\r\ncharger->master = pdev->dev.parent;\r\ncharger->interval = msecs_to_jiffies(\r\n(pdata->batmon_interval ? : 10) * 1000);\r\ncharger->charge_milliamp = pdata->charge_milliamp;\r\ncharger->charge_millivolt = pdata->charge_millivolt;\r\ncharger->battery_info = pdata->battery_info;\r\ncharger->battery_low = pdata->battery_low;\r\ncharger->battery_critical = pdata->battery_critical;\r\nda9030_battery_convert_thresholds(charger, pdata);\r\nret = da9030_battery_charger_init(charger);\r\nif (ret)\r\ngoto err_charger_init;\r\nINIT_DELAYED_WORK(&charger->work, da9030_charging_monitor);\r\nschedule_delayed_work(&charger->work, charger->interval);\r\ncharger->nb.notifier_call = da9030_battery_event;\r\nret = da903x_register_notifier(charger->master, &charger->nb,\r\nDA9030_EVENT_CHDET |\r\nDA9030_EVENT_VBATMON |\r\nDA9030_EVENT_CHIOVER |\r\nDA9030_EVENT_TBAT);\r\nif (ret)\r\ngoto err_notifier;\r\nda9030_battery_setup_psy(charger);\r\npsy_cfg.drv_data = charger;\r\ncharger->psy = power_supply_register(&pdev->dev, &charger->psy_desc,\r\n&psy_cfg);\r\nif (IS_ERR(charger->psy)) {\r\nret = PTR_ERR(charger->psy);\r\ngoto err_ps_register;\r\n}\r\ncharger->debug_file = da9030_bat_create_debugfs(charger);\r\nplatform_set_drvdata(pdev, charger);\r\nreturn 0;\r\nerr_ps_register:\r\nda903x_unregister_notifier(charger->master, &charger->nb,\r\nDA9030_EVENT_CHDET | DA9030_EVENT_VBATMON |\r\nDA9030_EVENT_CHIOVER | DA9030_EVENT_TBAT);\r\nerr_notifier:\r\ncancel_delayed_work(&charger->work);\r\nerr_charger_init:\r\nreturn ret;\r\n}\r\nstatic int da9030_battery_remove(struct platform_device *dev)\r\n{\r\nstruct da9030_charger *charger = platform_get_drvdata(dev);\r\nda9030_bat_remove_debugfs(charger);\r\nda903x_unregister_notifier(charger->master, &charger->nb,\r\nDA9030_EVENT_CHDET | DA9030_EVENT_VBATMON |\r\nDA9030_EVENT_CHIOVER | DA9030_EVENT_TBAT);\r\ncancel_delayed_work_sync(&charger->work);\r\nda9030_set_charge(charger, 0);\r\npower_supply_unregister(charger->psy);\r\nreturn 0;\r\n}

static int pasemi_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *)rng->priv;\r\nint data, i;\r\nfor (i = 0; i < 20; i++) {\r\ndata = (in_le32(rng_regs + SDCRNG_CTL_REG)\r\n& SDCRNG_CTL_FVLD_M) ? 1 : 0;\r\nif (data || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn data;\r\n}\r\nstatic int pasemi_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *)rng->priv;\r\n*data = in_le32(rng_regs + SDCRNG_VAL_REG);\r\nreturn 4;\r\n}\r\nstatic int pasemi_rng_init(struct hwrng *rng)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *)rng->priv;\r\nu32 ctl;\r\nctl = SDCRNG_CTL_DR | SDCRNG_CTL_SELECT_RRG_RNG | SDCRNG_CTL_KSZ;\r\nout_le32(rng_regs + SDCRNG_CTL_REG, ctl);\r\nout_le32(rng_regs + SDCRNG_CTL_REG, ctl & ~SDCRNG_CTL_DR);\r\nreturn 0;\r\n}\r\nstatic void pasemi_rng_cleanup(struct hwrng *rng)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *)rng->priv;\r\nu32 ctl;\r\nctl = SDCRNG_CTL_RE | SDCRNG_CTL_CE;\r\nout_le32(rng_regs + SDCRNG_CTL_REG,\r\nin_le32(rng_regs + SDCRNG_CTL_REG) & ~ctl);\r\n}\r\nstatic int rng_probe(struct platform_device *ofdev)\r\n{\r\nvoid __iomem *rng_regs;\r\nstruct device_node *rng_np = ofdev->dev.of_node;\r\nstruct resource res;\r\nint err = 0;\r\nerr = of_address_to_resource(rng_np, 0, &res);\r\nif (err)\r\nreturn -ENODEV;\r\nrng_regs = ioremap(res.start, 0x100);\r\nif (!rng_regs)\r\nreturn -ENOMEM;\r\npasemi_rng.priv = (unsigned long)rng_regs;\r\npr_info("Registering PA Semi RNG\n");\r\nerr = hwrng_register(&pasemi_rng);\r\nif (err)\r\niounmap(rng_regs);\r\nreturn err;\r\n}\r\nstatic int rng_remove(struct platform_device *dev)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *)pasemi_rng.priv;\r\nhwrng_unregister(&pasemi_rng);\r\niounmap(rng_regs);\r\nreturn 0;\r\n}

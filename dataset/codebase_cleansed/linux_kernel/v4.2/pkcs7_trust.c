static int pkcs7_validate_trust_one(struct pkcs7_message *pkcs7,\r\nstruct pkcs7_signed_info *sinfo,\r\nstruct key *trust_keyring)\r\n{\r\nstruct public_key_signature *sig = &sinfo->sig;\r\nstruct x509_certificate *x509, *last = NULL, *p;\r\nstruct key *key;\r\nbool trusted;\r\nint ret;\r\nkenter(",%u,", sinfo->index);\r\nif (sinfo->unsupported_crypto) {\r\nkleave(" = -ENOPKG [cached]");\r\nreturn -ENOPKG;\r\n}\r\nfor (x509 = sinfo->signer; x509; x509 = x509->signer) {\r\nif (x509->seen) {\r\nif (x509->verified) {\r\ntrusted = x509->trusted;\r\ngoto verified;\r\n}\r\nkleave(" = -ENOKEY [cached]");\r\nreturn -ENOKEY;\r\n}\r\nx509->seen = true;\r\nkey = x509_request_asymmetric_key(trust_keyring, x509->id,\r\nfalse);\r\nif (!IS_ERR(key)) {\r\npr_devel("sinfo %u: Cert %u as key %x\n",\r\nsinfo->index, x509->index, key_serial(key));\r\ngoto matched;\r\n}\r\nif (key == ERR_PTR(-ENOMEM))\r\nreturn -ENOMEM;\r\nif (x509->next == x509) {\r\nkleave(" = -ENOKEY [unknown self-signed]");\r\nreturn -ENOKEY;\r\n}\r\nmight_sleep();\r\nlast = x509;\r\nsig = &last->sig;\r\n}\r\nif (last && last->authority) {\r\nkey = x509_request_asymmetric_key(trust_keyring, last->authority,\r\nfalse);\r\nif (!IS_ERR(key)) {\r\nx509 = last;\r\npr_devel("sinfo %u: Root cert %u signer is key %x\n",\r\nsinfo->index, x509->index, key_serial(key));\r\ngoto matched;\r\n}\r\nif (PTR_ERR(key) != -ENOKEY)\r\nreturn PTR_ERR(key);\r\n}\r\nkey = x509_request_asymmetric_key(trust_keyring,\r\nsinfo->signing_cert_id,\r\nfalse);\r\nif (!IS_ERR(key)) {\r\npr_devel("sinfo %u: Direct signer is key %x\n",\r\nsinfo->index, key_serial(key));\r\nx509 = NULL;\r\ngoto matched;\r\n}\r\nif (PTR_ERR(key) != -ENOKEY)\r\nreturn PTR_ERR(key);\r\nkleave(" = -ENOKEY [no backref]");\r\nreturn -ENOKEY;\r\nmatched:\r\nret = verify_signature(key, sig);\r\ntrusted = test_bit(KEY_FLAG_TRUSTED, &key->flags);\r\nkey_put(key);\r\nif (ret < 0) {\r\nif (ret == -ENOMEM)\r\nreturn ret;\r\nkleave(" = -EKEYREJECTED [verify %d]", ret);\r\nreturn -EKEYREJECTED;\r\n}\r\nverified:\r\nif (x509) {\r\nx509->verified = true;\r\nfor (p = sinfo->signer; p != x509; p = p->signer) {\r\np->verified = true;\r\np->trusted = trusted;\r\n}\r\n}\r\nsinfo->trusted = trusted;\r\nkleave(" = 0");\r\nreturn 0;\r\n}\r\nint pkcs7_validate_trust(struct pkcs7_message *pkcs7,\r\nstruct key *trust_keyring,\r\nbool *_trusted)\r\n{\r\nstruct pkcs7_signed_info *sinfo;\r\nstruct x509_certificate *p;\r\nint cached_ret = -ENOKEY;\r\nint ret;\r\nfor (p = pkcs7->certs; p; p = p->next)\r\np->seen = false;\r\nfor (sinfo = pkcs7->signed_infos; sinfo; sinfo = sinfo->next) {\r\nret = pkcs7_validate_trust_one(pkcs7, sinfo, trust_keyring);\r\nswitch (ret) {\r\ncase -ENOKEY:\r\ncontinue;\r\ncase -ENOPKG:\r\nif (cached_ret == -ENOKEY)\r\ncached_ret = -ENOPKG;\r\ncontinue;\r\ncase 0:\r\n*_trusted |= sinfo->trusted;\r\ncached_ret = 0;\r\ncontinue;\r\ndefault:\r\nreturn ret;\r\n}\r\n}\r\nreturn cached_ret;\r\n}

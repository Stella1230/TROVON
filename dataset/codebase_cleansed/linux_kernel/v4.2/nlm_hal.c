void nlm_node_init(int node)\r\n{\r\nstruct nlm_soc_info *nodep;\r\nnodep = nlm_get_node(node);\r\nif (node == 0)\r\nnodep->coremask = 1;\r\nnodep->sysbase = nlm_get_sys_regbase(node);\r\nnodep->picbase = nlm_get_pic_regbase(node);\r\nnodep->ebase = read_c0_ebase() & (~((1 << 12) - 1));\r\nif (cpu_is_xlp9xx())\r\nnodep->socbus = xlp9xx_get_socbus(node);\r\nelse\r\nnodep->socbus = 0;\r\nspin_lock_init(&nodep->piclock);\r\n}\r\nstatic int xlp9xx_irq_to_irt(int irq)\r\n{\r\nswitch (irq) {\r\ncase PIC_GPIO_IRQ:\r\nreturn 12;\r\ncase PIC_I2C_0_IRQ:\r\nreturn 125;\r\ncase PIC_I2C_1_IRQ:\r\nreturn 126;\r\ncase PIC_I2C_2_IRQ:\r\nreturn 127;\r\ncase PIC_I2C_3_IRQ:\r\nreturn 128;\r\ncase PIC_9XX_XHCI_0_IRQ:\r\nreturn 114;\r\ncase PIC_9XX_XHCI_1_IRQ:\r\nreturn 115;\r\ncase PIC_9XX_XHCI_2_IRQ:\r\nreturn 116;\r\ncase PIC_UART_0_IRQ:\r\nreturn 133;\r\ncase PIC_UART_1_IRQ:\r\nreturn 134;\r\ncase PIC_SATA_IRQ:\r\nreturn 143;\r\ncase PIC_SPI_IRQ:\r\nreturn 152;\r\ncase PIC_MMC_IRQ:\r\nreturn 153;\r\ncase PIC_PCIE_LINK_LEGACY_IRQ(0):\r\ncase PIC_PCIE_LINK_LEGACY_IRQ(1):\r\ncase PIC_PCIE_LINK_LEGACY_IRQ(2):\r\ncase PIC_PCIE_LINK_LEGACY_IRQ(3):\r\nreturn 191 + irq - PIC_PCIE_LINK_LEGACY_IRQ_BASE;\r\n}\r\nreturn -1;\r\n}\r\nstatic int xlp_irq_to_irt(int irq)\r\n{\r\nuint64_t pcibase;\r\nint devoff, irt;\r\ndevoff = 0;\r\nswitch (irq) {\r\ncase PIC_UART_0_IRQ:\r\ndevoff = XLP_IO_UART0_OFFSET(0);\r\nbreak;\r\ncase PIC_UART_1_IRQ:\r\ndevoff = XLP_IO_UART1_OFFSET(0);\r\nbreak;\r\ncase PIC_MMC_IRQ:\r\ndevoff = XLP_IO_MMC_OFFSET(0);\r\nbreak;\r\ncase PIC_I2C_0_IRQ:\r\ncase PIC_I2C_1_IRQ:\r\ncase PIC_I2C_2_IRQ:\r\ncase PIC_I2C_3_IRQ:\r\nif (cpu_is_xlpii())\r\ndevoff = XLP2XX_IO_I2C_OFFSET(0);\r\nelse\r\ndevoff = XLP_IO_I2C0_OFFSET(0);\r\nbreak;\r\ncase PIC_SATA_IRQ:\r\ndevoff = XLP_IO_SATA_OFFSET(0);\r\nbreak;\r\ncase PIC_GPIO_IRQ:\r\ndevoff = XLP_IO_GPIO_OFFSET(0);\r\nbreak;\r\ncase PIC_NAND_IRQ:\r\ndevoff = XLP_IO_NAND_OFFSET(0);\r\nbreak;\r\ncase PIC_SPI_IRQ:\r\ndevoff = XLP_IO_SPI_OFFSET(0);\r\nbreak;\r\ndefault:\r\nif (cpu_is_xlpii()) {\r\nswitch (irq) {\r\ncase PIC_2XX_XHCI_0_IRQ:\r\ndevoff = XLP2XX_IO_USB_XHCI0_OFFSET(0);\r\nbreak;\r\ncase PIC_2XX_XHCI_1_IRQ:\r\ndevoff = XLP2XX_IO_USB_XHCI1_OFFSET(0);\r\nbreak;\r\ncase PIC_2XX_XHCI_2_IRQ:\r\ndevoff = XLP2XX_IO_USB_XHCI2_OFFSET(0);\r\nbreak;\r\n}\r\n} else {\r\nswitch (irq) {\r\ncase PIC_EHCI_0_IRQ:\r\ndevoff = XLP_IO_USB_EHCI0_OFFSET(0);\r\nbreak;\r\ncase PIC_EHCI_1_IRQ:\r\ndevoff = XLP_IO_USB_EHCI1_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_0_IRQ:\r\ndevoff = XLP_IO_USB_OHCI0_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_1_IRQ:\r\ndevoff = XLP_IO_USB_OHCI1_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_2_IRQ:\r\ndevoff = XLP_IO_USB_OHCI2_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_3_IRQ:\r\ndevoff = XLP_IO_USB_OHCI3_OFFSET(0);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (devoff != 0) {\r\nuint32_t val;\r\npcibase = nlm_pcicfg_base(devoff);\r\nval = nlm_read_reg(pcibase, XLP_PCI_IRTINFO_REG);\r\nif (val == 0xffffffff) {\r\nirt = -1;\r\n} else {\r\nirt = val & 0xffff;\r\nswitch (irq) {\r\ncase PIC_I2C_1_IRQ:\r\nirt = irt + 1; break;\r\ncase PIC_I2C_2_IRQ:\r\nirt = irt + 2; break;\r\ncase PIC_I2C_3_IRQ:\r\nirt = irt + 3; break;\r\n}\r\n}\r\n} else if (irq >= PIC_PCIE_LINK_LEGACY_IRQ(0) &&\r\nirq <= PIC_PCIE_LINK_LEGACY_IRQ(3)) {\r\nirt = PIC_IRT_PCIE_LINK_INDEX(irq -\r\nPIC_PCIE_LINK_LEGACY_IRQ_BASE);\r\n} else {\r\nirt = -1;\r\n}\r\nreturn irt;\r\n}\r\nint nlm_irq_to_irt(int irq)\r\n{\r\nif (irq >= PIC_PCIE_LINK_MSI_IRQ(0) && irq <= PIC_PCIE_LINK_MSI_IRQ(3))\r\nreturn -2;\r\nif (irq >= PIC_PCIE_MSIX_IRQ(0) && irq <= PIC_PCIE_MSIX_IRQ(3))\r\nreturn -2;\r\nif (cpu_is_xlp9xx())\r\nreturn xlp9xx_irq_to_irt(irq);\r\nelse\r\nreturn xlp_irq_to_irt(irq);\r\n}\r\nstatic unsigned int nlm_xlp2_get_core_frequency(int node, int core)\r\n{\r\nunsigned int pll_post_div, ctrl_val0, ctrl_val1, denom;\r\nuint64_t num, sysbase, clockbase;\r\nif (cpu_is_xlp9xx()) {\r\nclockbase = nlm_get_clock_regbase(node);\r\nctrl_val0 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_CPU_PLL_CTRL0(core));\r\nctrl_val1 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_CPU_PLL_CTRL1(core));\r\n} else {\r\nsysbase = nlm_get_node(node)->sysbase;\r\nctrl_val0 = nlm_read_sys_reg(sysbase,\r\nSYS_CPU_PLL_CTRL0(core));\r\nctrl_val1 = nlm_read_sys_reg(sysbase,\r\nSYS_CPU_PLL_CTRL1(core));\r\n}\r\nswitch ((ctrl_val0 >> 24) & 0x7) {\r\ncase 1:\r\npll_post_div = 2;\r\nbreak;\r\ncase 3:\r\npll_post_div = 4;\r\nbreak;\r\ncase 7:\r\npll_post_div = 8;\r\nbreak;\r\ncase 6:\r\npll_post_div = 16;\r\nbreak;\r\ncase 0:\r\ndefault:\r\npll_post_div = 1;\r\nbreak;\r\n}\r\nnum = 1000000ULL * (400 * 3 + 100 * (ctrl_val1 & 0x3f));\r\ndenom = 3 * pll_post_div;\r\ndo_div(num, denom);\r\nreturn (unsigned int)num;\r\n}\r\nstatic unsigned int nlm_xlp_get_core_frequency(int node, int core)\r\n{\r\nunsigned int pll_divf, pll_divr, dfs_div, ext_div;\r\nunsigned int rstval, dfsval, denom;\r\nuint64_t num, sysbase;\r\nsysbase = nlm_get_node(node)->sysbase;\r\nrstval = nlm_read_sys_reg(sysbase, SYS_POWER_ON_RESET_CFG);\r\ndfsval = nlm_read_sys_reg(sysbase, SYS_CORE_DFS_DIV_VALUE);\r\npll_divf = ((rstval >> 10) & 0x7f) + 1;\r\npll_divr = ((rstval >> 8) & 0x3) + 1;\r\next_div = ((rstval >> 30) & 0x3) + 1;\r\ndfs_div = ((dfsval >> (core * 4)) & 0xf) + 1;\r\nnum = 800000000ULL * pll_divf;\r\ndenom = 3 * pll_divr * ext_div * dfs_div;\r\ndo_div(num, denom);\r\nreturn (unsigned int)num;\r\n}\r\nunsigned int nlm_get_core_frequency(int node, int core)\r\n{\r\nif (cpu_is_xlpii())\r\nreturn nlm_xlp2_get_core_frequency(node, core);\r\nelse\r\nreturn nlm_xlp_get_core_frequency(node, core);\r\n}\r\nstatic unsigned int nlm_xlp2_get_pic_frequency(int node)\r\n{\r\nu32 ctrl_val0, ctrl_val2, vco_post_div, pll_post_div, cpu_xlp9xx;\r\nu32 mdiv, fdiv, pll_out_freq_den, reg_select, ref_div, pic_div;\r\nu64 sysbase, pll_out_freq_num, ref_clk_select, clockbase, ref_clk;\r\nsysbase = nlm_get_node(node)->sysbase;\r\nclockbase = nlm_get_clock_regbase(node);\r\ncpu_xlp9xx = cpu_is_xlp9xx();\r\nif (cpu_xlp9xx)\r\nref_clk_select = (nlm_read_sys_reg(sysbase,\r\nSYS_9XX_POWER_ON_RESET_CFG) >> 18) & 0x3;\r\nelse\r\nref_clk_select = (nlm_read_sys_reg(sysbase,\r\nSYS_POWER_ON_RESET_CFG) >> 18) & 0x3;\r\nswitch (ref_clk_select) {\r\ncase 0:\r\nref_clk = 200000000ULL;\r\nref_div = 3;\r\nbreak;\r\ncase 1:\r\nref_clk = 100000000ULL;\r\nref_div = 1;\r\nbreak;\r\ncase 2:\r\nref_clk = 125000000ULL;\r\nref_div = 1;\r\nbreak;\r\ncase 3:\r\nref_clk = 400000000ULL;\r\nref_div = 3;\r\nbreak;\r\n}\r\nif (cpu_xlp9xx) {\r\nreg_select = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_CLK_DEV_SEL_REG) & 0x3;\r\nswitch (reg_select) {\r\ncase 0:\r\nctrl_val0 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL0);\r\nctrl_val2 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL2);\r\nbreak;\r\ncase 1:\r\nctrl_val0 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL0_DEVX(0));\r\nctrl_val2 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL2_DEVX(0));\r\nbreak;\r\ncase 2:\r\nctrl_val0 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL0_DEVX(1));\r\nctrl_val2 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL2_DEVX(1));\r\nbreak;\r\ncase 3:\r\nctrl_val0 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL0_DEVX(2));\r\nctrl_val2 = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_PLL_CTRL2_DEVX(2));\r\nbreak;\r\n}\r\n} else {\r\nreg_select = (nlm_read_sys_reg(sysbase,\r\nSYS_CLK_DEV_SEL_REG) >> 22) & 0x3;\r\nswitch (reg_select) {\r\ncase 0:\r\nctrl_val0 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL0);\r\nctrl_val2 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL2);\r\nbreak;\r\ncase 1:\r\nctrl_val0 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL0_DEVX(0));\r\nctrl_val2 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL2_DEVX(0));\r\nbreak;\r\ncase 2:\r\nctrl_val0 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL0_DEVX(1));\r\nctrl_val2 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL2_DEVX(1));\r\nbreak;\r\ncase 3:\r\nctrl_val0 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL0_DEVX(2));\r\nctrl_val2 = nlm_read_sys_reg(sysbase,\r\nSYS_PLL_CTRL2_DEVX(2));\r\nbreak;\r\n}\r\n}\r\nvco_post_div = (ctrl_val0 >> 5) & 0x7;\r\npll_post_div = (ctrl_val0 >> 24) & 0x7;\r\nmdiv = ctrl_val2 & 0xff;\r\nfdiv = (ctrl_val2 >> 8) & 0x1fff;\r\nswitch (pll_post_div) {\r\ncase 1:\r\npll_post_div = 2;\r\nbreak;\r\ncase 3:\r\npll_post_div = 4;\r\nbreak;\r\ncase 7:\r\npll_post_div = 8;\r\nbreak;\r\ncase 6:\r\npll_post_div = 16;\r\nbreak;\r\ncase 0:\r\ndefault:\r\npll_post_div = 1;\r\nbreak;\r\n}\r\nfdiv = fdiv/(1 << 13);\r\npll_out_freq_num = ((ref_clk >> 1) * (6 + mdiv)) + fdiv;\r\npll_out_freq_den = (1 << vco_post_div) * pll_post_div * ref_div;\r\nif (pll_out_freq_den > 0)\r\ndo_div(pll_out_freq_num, pll_out_freq_den);\r\nif (cpu_xlp9xx)\r\npic_div = nlm_read_sys_reg(clockbase,\r\nSYS_9XX_CLK_DEV_DIV_REG) & 0x3;\r\nelse\r\npic_div = (nlm_read_sys_reg(sysbase,\r\nSYS_CLK_DEV_DIV_REG) >> 22) & 0x3;\r\ndo_div(pll_out_freq_num, 1 << pic_div);\r\nreturn pll_out_freq_num;\r\n}\r\nunsigned int nlm_get_pic_frequency(int node)\r\n{\r\nif (cpu_is_xlpii())\r\nreturn nlm_xlp2_get_pic_frequency(node);\r\nelse\r\nreturn 133333333;\r\n}\r\nunsigned int nlm_get_cpu_frequency(void)\r\n{\r\nreturn nlm_get_core_frequency(0, 0);\r\n}\r\nint nlm_get_dram_map(int node, uint64_t *dram_map, int nentries)\r\n{\r\nuint64_t bridgebase, base, lim;\r\nuint32_t val;\r\nunsigned int barreg, limreg, xlatreg;\r\nint i, n, rv;\r\nbridgebase = nlm_get_bridge_regbase(0);\r\nrv = 0;\r\nfor (i = 0; i < 8; i++) {\r\nif (rv + 1 >= nentries)\r\nbreak;\r\nif (cpu_is_xlp9xx()) {\r\nbarreg = BRIDGE_9XX_DRAM_BAR(i);\r\nlimreg = BRIDGE_9XX_DRAM_LIMIT(i);\r\nxlatreg = BRIDGE_9XX_DRAM_NODE_TRANSLN(i);\r\n} else {\r\nbarreg = BRIDGE_DRAM_BAR(i);\r\nlimreg = BRIDGE_DRAM_LIMIT(i);\r\nxlatreg = BRIDGE_DRAM_NODE_TRANSLN(i);\r\n}\r\nif (node >= 0) {\r\nval = nlm_read_bridge_reg(bridgebase, xlatreg);\r\nn = (val >> 1) & 0x3;\r\nif (n != node)\r\ncontinue;\r\n}\r\nval = nlm_read_bridge_reg(bridgebase, barreg);\r\nval = (val >> 12) & 0xfffff;\r\nbase = (uint64_t) val << 20;\r\nval = nlm_read_bridge_reg(bridgebase, limreg);\r\nval = (val >> 12) & 0xfffff;\r\nif (val == 0)\r\ncontinue;\r\nlim = ((uint64_t)val + 1) << 20;\r\ndram_map[rv] = base;\r\ndram_map[rv + 1] = lim;\r\nrv += 2;\r\n}\r\nreturn rv;\r\n}

void ieee80211_crypt_deinit_entries(struct ieee80211_device *ieee,\r\nint force)\r\n{\r\nstruct list_head *ptr, *n;\r\nstruct ieee80211_crypt_data *entry;\r\nfor (ptr = ieee->crypt_deinit_list.next, n = ptr->next;\r\nptr != &ieee->crypt_deinit_list; ptr = n, n = ptr->next) {\r\nentry = list_entry(ptr, struct ieee80211_crypt_data, list);\r\nif (atomic_read(&entry->refcnt) != 0 && !force)\r\ncontinue;\r\nlist_del(ptr);\r\nif (entry->ops)\r\nentry->ops->deinit(entry->priv);\r\nkfree(entry);\r\n}\r\n}\r\nvoid ieee80211_crypt_deinit_handler(unsigned long data)\r\n{\r\nstruct ieee80211_device *ieee = (struct ieee80211_device *)data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nieee80211_crypt_deinit_entries(ieee, 0);\r\nif (!list_empty(&ieee->crypt_deinit_list)) {\r\nnetdev_dbg(ieee->dev, "%s: entries remaining in delayed crypt deletion list\n",\r\nieee->dev->name);\r\nieee->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&ieee->crypt_deinit_timer);\r\n}\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\n}\r\nvoid ieee80211_crypt_delayed_deinit(struct ieee80211_device *ieee,\r\nstruct ieee80211_crypt_data **crypt)\r\n{\r\nstruct ieee80211_crypt_data *tmp;\r\nunsigned long flags;\r\nif (*crypt == NULL)\r\nreturn;\r\ntmp = *crypt;\r\n*crypt = NULL;\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nlist_add(&tmp->list, &ieee->crypt_deinit_list);\r\nif (!timer_pending(&ieee->crypt_deinit_timer)) {\r\nieee->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&ieee->crypt_deinit_timer);\r\n}\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\n}\r\nint ieee80211_register_crypto_ops(struct ieee80211_crypto_ops *ops)\r\n{\r\nunsigned long flags;\r\nstruct ieee80211_crypto_alg *alg;\r\nif (hcrypt == NULL)\r\nreturn -1;\r\nalg = kzalloc(sizeof(*alg), GFP_KERNEL);\r\nif (alg == NULL)\r\nreturn -ENOMEM;\r\nalg->ops = ops;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nlist_add(&alg->list, &hcrypt->algs);\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\npr_debug("ieee80211_crypt: registered algorithm '%s'\n",\r\nops->name);\r\nreturn 0;\r\n}\r\nint ieee80211_unregister_crypto_ops(struct ieee80211_crypto_ops *ops)\r\n{\r\nunsigned long flags;\r\nstruct list_head *ptr;\r\nstruct ieee80211_crypto_alg *del_alg = NULL;\r\nif (hcrypt == NULL)\r\nreturn -1;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nfor (ptr = hcrypt->algs.next; ptr != &hcrypt->algs; ptr = ptr->next) {\r\nstruct ieee80211_crypto_alg *alg =\r\n(struct ieee80211_crypto_alg *) ptr;\r\nif (alg->ops == ops) {\r\nlist_del(&alg->list);\r\ndel_alg = alg;\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\nif (del_alg) {\r\npr_debug("ieee80211_crypt: unregistered algorithm '%s'\n",\r\nops->name);\r\nkfree(del_alg);\r\n}\r\nreturn del_alg ? 0 : -1;\r\n}\r\nstruct ieee80211_crypto_ops *ieee80211_get_crypto_ops(const char *name)\r\n{\r\nunsigned long flags;\r\nstruct list_head *ptr;\r\nstruct ieee80211_crypto_alg *found_alg = NULL;\r\nif (hcrypt == NULL)\r\nreturn NULL;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nfor (ptr = hcrypt->algs.next; ptr != &hcrypt->algs; ptr = ptr->next) {\r\nstruct ieee80211_crypto_alg *alg =\r\n(struct ieee80211_crypto_alg *) ptr;\r\nif (strcmp(alg->ops->name, name) == 0) {\r\nfound_alg = alg;\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\nif (found_alg)\r\nreturn found_alg->ops;\r\nelse\r\nreturn NULL;\r\n}\r\nstatic void *ieee80211_crypt_null_init(int keyidx) { return (void *) 1; }\r\nstatic void ieee80211_crypt_null_deinit(void *priv) {}\r\nint __init ieee80211_crypto_init(void)\r\n{\r\nint ret = -ENOMEM;\r\nhcrypt = kzalloc(sizeof(*hcrypt), GFP_KERNEL);\r\nif (!hcrypt)\r\ngoto out;\r\nINIT_LIST_HEAD(&hcrypt->algs);\r\nspin_lock_init(&hcrypt->lock);\r\nret = ieee80211_register_crypto_ops(&ieee80211_crypt_null);\r\nif (ret < 0) {\r\nkfree(hcrypt);\r\nhcrypt = NULL;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nvoid __exit ieee80211_crypto_deinit(void)\r\n{\r\nstruct list_head *ptr, *n;\r\nif (hcrypt == NULL)\r\nreturn;\r\nfor (ptr = hcrypt->algs.next, n = ptr->next; ptr != &hcrypt->algs;\r\nptr = n, n = ptr->next) {\r\nstruct ieee80211_crypto_alg *alg =\r\n(struct ieee80211_crypto_alg *) ptr;\r\nlist_del(ptr);\r\npr_debug("ieee80211_crypt: unregistered algorithm '%s' (deinit)\n",\r\nalg->ops->name);\r\nkfree(alg);\r\n}\r\nkfree(hcrypt);\r\n}

acpi_status acpi_ds_initialize_region(acpi_handle obj_handle)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nobj_desc = acpi_ns_get_attached_object(obj_handle);\r\nstatus = acpi_ev_initialize_region(obj_desc, FALSE);\r\nreturn (status);\r\n}\r\nstatic acpi_status\r\nacpi_ds_init_buffer_field(u16 aml_opcode,\r\nunion acpi_operand_object *obj_desc,\r\nunion acpi_operand_object *buffer_desc,\r\nunion acpi_operand_object *offset_desc,\r\nunion acpi_operand_object *length_desc,\r\nunion acpi_operand_object *result_desc)\r\n{\r\nu32 offset;\r\nu32 bit_offset;\r\nu32 bit_count;\r\nu8 field_flags;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE_PTR(ds_init_buffer_field, obj_desc);\r\nif (buffer_desc->common.type != ACPI_TYPE_BUFFER) {\r\nACPI_ERROR((AE_INFO,\r\n"Target of Create Field is not a Buffer object - %s",\r\nacpi_ut_get_object_type_name(buffer_desc)));\r\nstatus = AE_AML_OPERAND_TYPE;\r\ngoto cleanup;\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(result_desc) != ACPI_DESC_TYPE_NAMED) {\r\nACPI_ERROR((AE_INFO,\r\n"(%s) destination not a NS Node [%s]",\r\nacpi_ps_get_opcode_name(aml_opcode),\r\nacpi_ut_get_descriptor_name(result_desc)));\r\nstatus = AE_AML_OPERAND_TYPE;\r\ngoto cleanup;\r\n}\r\noffset = (u32) offset_desc->integer.value;\r\nswitch (aml_opcode) {\r\ncase AML_CREATE_FIELD_OP:\r\nfield_flags = AML_FIELD_ACCESS_BYTE;\r\nbit_offset = offset;\r\nbit_count = (u32) length_desc->integer.value;\r\nif (bit_count == 0) {\r\nACPI_ERROR((AE_INFO,\r\n"Attempt to CreateField of length zero"));\r\nstatus = AE_AML_OPERAND_VALUE;\r\ngoto cleanup;\r\n}\r\nbreak;\r\ncase AML_CREATE_BIT_FIELD_OP:\r\nbit_offset = offset;\r\nbit_count = 1;\r\nfield_flags = AML_FIELD_ACCESS_BYTE;\r\nbreak;\r\ncase AML_CREATE_BYTE_FIELD_OP:\r\nbit_offset = 8 * offset;\r\nbit_count = 8;\r\nfield_flags = AML_FIELD_ACCESS_BYTE;\r\nbreak;\r\ncase AML_CREATE_WORD_FIELD_OP:\r\nbit_offset = 8 * offset;\r\nbit_count = 16;\r\nfield_flags = AML_FIELD_ACCESS_WORD;\r\nbreak;\r\ncase AML_CREATE_DWORD_FIELD_OP:\r\nbit_offset = 8 * offset;\r\nbit_count = 32;\r\nfield_flags = AML_FIELD_ACCESS_DWORD;\r\nbreak;\r\ncase AML_CREATE_QWORD_FIELD_OP:\r\nbit_offset = 8 * offset;\r\nbit_count = 64;\r\nfield_flags = AML_FIELD_ACCESS_QWORD;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown field creation opcode 0x%02X",\r\naml_opcode));\r\nstatus = AE_AML_BAD_OPCODE;\r\ngoto cleanup;\r\n}\r\nif ((bit_offset + bit_count) > (8 * (u32) buffer_desc->buffer.length)) {\r\nACPI_ERROR((AE_INFO,\r\n"Field [%4.4s] at %u exceeds Buffer [%4.4s] size %u (bits)",\r\nacpi_ut_get_node_name(result_desc),\r\nbit_offset + bit_count,\r\nacpi_ut_get_node_name(buffer_desc->buffer.node),\r\n8 * (u32) buffer_desc->buffer.length));\r\nstatus = AE_AML_BUFFER_LIMIT;\r\ngoto cleanup;\r\n}\r\nstatus = acpi_ex_prep_common_field_object(obj_desc, field_flags, 0,\r\nbit_offset, bit_count);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nobj_desc->buffer_field.buffer_obj = buffer_desc;\r\nbuffer_desc->common.reference_count = (u16)\r\n(buffer_desc->common.reference_count +\r\nobj_desc->common.reference_count);\r\ncleanup:\r\nacpi_ut_remove_reference(offset_desc);\r\nacpi_ut_remove_reference(buffer_desc);\r\nif (aml_opcode == AML_CREATE_FIELD_OP) {\r\nacpi_ut_remove_reference(length_desc);\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_remove_reference(result_desc);\r\n} else {\r\nobj_desc->buffer_field.flags |= AOPOBJ_DATA_VALID;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_eval_buffer_field_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_parse_object *next_op;\r\nACPI_FUNCTION_TRACE_PTR(ds_eval_buffer_field_operands, op);\r\nnode = op->common.node;\r\nnext_op = op->common.value.arg;\r\nstatus = acpi_ds_create_operands(walk_state, next_op);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}\r\nstatus = acpi_ex_resolve_operands(op->common.aml_opcode,\r\nACPI_WALK_OPERANDS, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR((AE_INFO, "(%s) bad operand(s), status 0x%X",\r\nacpi_ps_get_opcode_name(op->common.aml_opcode),\r\nstatus));\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (op->common.aml_opcode == AML_CREATE_FIELD_OP) {\r\nstatus =\r\nacpi_ds_init_buffer_field(op->common.aml_opcode, obj_desc,\r\nwalk_state->operands[0],\r\nwalk_state->operands[1],\r\nwalk_state->operands[2],\r\nwalk_state->operands[3]);\r\n} else {\r\nstatus =\r\nacpi_ds_init_buffer_field(op->common.aml_opcode, obj_desc,\r\nwalk_state->operands[0],\r\nwalk_state->operands[1], NULL,\r\nwalk_state->operands[2]);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_eval_region_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *operand_desc;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_parse_object *next_op;\r\nACPI_FUNCTION_TRACE_PTR(ds_eval_region_operands, op);\r\nnode = op->common.node;\r\nnext_op = op->common.value.arg;\r\nnext_op = next_op->common.next;\r\nstatus = acpi_ds_create_operands(walk_state, next_op);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ex_resolve_operands(op->common.aml_opcode,\r\nACPI_WALK_OPERANDS, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}\r\noperand_desc = walk_state->operands[walk_state->num_operands - 1];\r\nobj_desc->region.length = (u32) operand_desc->integer.value;\r\nacpi_ut_remove_reference(operand_desc);\r\noperand_desc = walk_state->operands[walk_state->num_operands - 2];\r\nobj_desc->region.address = (acpi_physical_address)\r\noperand_desc->integer.value;\r\nacpi_ut_remove_reference(operand_desc);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "RgnObj %p Addr %8.8X%8.8X Len %X\n",\r\nobj_desc,\r\nACPI_FORMAT_UINT64(obj_desc->region.address),\r\nobj_desc->region.length));\r\nobj_desc->region.flags |= AOPOBJ_DATA_VALID;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_eval_table_region_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object **operand;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_parse_object *next_op;\r\nu32 table_index;\r\nstruct acpi_table_header *table;\r\nACPI_FUNCTION_TRACE_PTR(ds_eval_table_region_operands, op);\r\nnode = op->common.node;\r\nnext_op = op->common.value.arg;\r\nstatus = acpi_ds_create_operands(walk_state, next_op);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ex_resolve_operands(op->common.aml_opcode,\r\nACPI_WALK_OPERANDS, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\noperand = &walk_state->operands[0];\r\nstatus = acpi_tb_find_table(operand[0]->string.pointer,\r\noperand[1]->string.pointer,\r\noperand[2]->string.pointer, &table_index);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_ut_remove_reference(operand[0]);\r\nacpi_ut_remove_reference(operand[1]);\r\nacpi_ut_remove_reference(operand[2]);\r\nstatus = acpi_get_table_by_index(table_index, &table);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}\r\nobj_desc->region.address = ACPI_PTR_TO_PHYSADDR(table);\r\nobj_desc->region.length = table->length;\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "RgnObj %p Addr %8.8X%8.8X Len %X\n",\r\nobj_desc,\r\nACPI_FORMAT_UINT64(obj_desc->region.address),\r\nobj_desc->region.length));\r\nobj_desc->region.flags |= AOPOBJ_DATA_VALID;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_eval_data_object_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op,\r\nunion acpi_operand_object *obj_desc)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *arg_desc;\r\nu32 length;\r\nACPI_FUNCTION_TRACE(ds_eval_data_object_operands);\r\nwalk_state->operand_index = walk_state->num_operands;\r\nstatus = acpi_ds_create_operand(walk_state, op->common.value.arg, 1);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ex_resolve_operands(walk_state->opcode,\r\n&(walk_state->\r\noperands[walk_state->num_operands -\r\n1]), walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\narg_desc = walk_state->operands[walk_state->num_operands - 1];\r\nlength = (u32) arg_desc->integer.value;\r\nstatus = acpi_ds_obj_stack_pop(1, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_ut_remove_reference(arg_desc);\r\nswitch (op->common.aml_opcode) {\r\ncase AML_BUFFER_OP:\r\nstatus =\r\nacpi_ds_build_internal_buffer_obj(walk_state, op, length,\r\n&obj_desc);\r\nbreak;\r\ncase AML_PACKAGE_OP:\r\ncase AML_VAR_PACKAGE_OP:\r\nstatus =\r\nacpi_ds_build_internal_package_obj(walk_state, op, length,\r\n&obj_desc);\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_AML_BAD_OPCODE);\r\n}\r\nif (ACPI_SUCCESS(status)) {\r\nif ((!op->common.parent) ||\r\n((op->common.parent->common.aml_opcode != AML_PACKAGE_OP) &&\r\n(op->common.parent->common.aml_opcode !=\r\nAML_VAR_PACKAGE_OP)\r\n&& (op->common.parent->common.aml_opcode !=\r\nAML_NAME_OP))) {\r\nwalk_state->result_obj = obj_desc;\r\n}\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_eval_bank_field_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *op)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *operand_desc;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_parse_object *next_op;\r\nunion acpi_parse_object *arg;\r\nACPI_FUNCTION_TRACE_PTR(ds_eval_bank_field_operands, op);\r\nnext_op = op->common.value.arg;\r\nnext_op = next_op->common.next;\r\nnext_op = next_op->common.next;\r\nwalk_state->operand_index = 0;\r\nstatus = acpi_ds_create_operand(walk_state, next_op, 0);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ex_resolve_to_value(&walk_state->operands[0], walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DUMP_OPERANDS(ACPI_WALK_OPERANDS,\r\nacpi_ps_get_opcode_name(op->common.aml_opcode), 1);\r\noperand_desc = walk_state->operands[0];\r\narg = acpi_ps_get_arg(op, 4);\r\nwhile (arg) {\r\nif (arg->common.aml_opcode == AML_INT_NAMEDFIELD_OP) {\r\nnode = arg->common.node;\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}\r\nobj_desc->bank_field.value =\r\n(u32) operand_desc->integer.value;\r\n}\r\narg = arg->common.next;\r\n}\r\nacpi_ut_remove_reference(operand_desc);\r\nreturn_ACPI_STATUS(status);\r\n}

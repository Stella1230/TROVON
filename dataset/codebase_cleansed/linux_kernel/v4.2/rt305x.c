static void rt305x_wdt_reset(void)\r\n{\r\nu32 t;\r\nt = rt_sysc_r32(SYSC_REG_SYSTEM_CONFIG);\r\nt |= RT305X_SYSCFG_SRAM_CS0_MODE_WDT <<\r\nRT305X_SYSCFG_SRAM_CS0_MODE_SHIFT;\r\nrt_sysc_w32(t, SYSC_REG_SYSTEM_CONFIG);\r\n}\r\nstatic unsigned long rt5350_get_mem_size(void)\r\n{\r\nvoid __iomem *sysc = (void __iomem *) KSEG1ADDR(RT305X_SYSC_BASE);\r\nunsigned long ret;\r\nu32 t;\r\nt = __raw_readl(sysc + SYSC_REG_SYSTEM_CONFIG);\r\nt = (t >> RT5350_SYSCFG0_DRAM_SIZE_SHIFT) &\r\nRT5350_SYSCFG0_DRAM_SIZE_MASK;\r\nswitch (t) {\r\ncase RT5350_SYSCFG0_DRAM_SIZE_2M:\r\nret = 2;\r\nbreak;\r\ncase RT5350_SYSCFG0_DRAM_SIZE_8M:\r\nret = 8;\r\nbreak;\r\ncase RT5350_SYSCFG0_DRAM_SIZE_16M:\r\nret = 16;\r\nbreak;\r\ncase RT5350_SYSCFG0_DRAM_SIZE_32M:\r\nret = 32;\r\nbreak;\r\ncase RT5350_SYSCFG0_DRAM_SIZE_64M:\r\nret = 64;\r\nbreak;\r\ndefault:\r\npanic("rt5350: invalid DRAM size: %u", t);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nvoid __init ralink_clk_init(void)\r\n{\r\nunsigned long cpu_rate, sys_rate, wdt_rate, uart_rate;\r\nunsigned long wmac_rate = 40000000;\r\nu32 t = rt_sysc_r32(SYSC_REG_SYSTEM_CONFIG);\r\nif (soc_is_rt305x() || soc_is_rt3350()) {\r\nt = (t >> RT305X_SYSCFG_CPUCLK_SHIFT) &\r\nRT305X_SYSCFG_CPUCLK_MASK;\r\nswitch (t) {\r\ncase RT305X_SYSCFG_CPUCLK_LOW:\r\ncpu_rate = 320000000;\r\nbreak;\r\ncase RT305X_SYSCFG_CPUCLK_HIGH:\r\ncpu_rate = 384000000;\r\nbreak;\r\n}\r\nsys_rate = uart_rate = wdt_rate = cpu_rate / 3;\r\n} else if (soc_is_rt3352()) {\r\nt = (t >> RT3352_SYSCFG0_CPUCLK_SHIFT) &\r\nRT3352_SYSCFG0_CPUCLK_MASK;\r\nswitch (t) {\r\ncase RT3352_SYSCFG0_CPUCLK_LOW:\r\ncpu_rate = 384000000;\r\nbreak;\r\ncase RT3352_SYSCFG0_CPUCLK_HIGH:\r\ncpu_rate = 400000000;\r\nbreak;\r\n}\r\nsys_rate = wdt_rate = cpu_rate / 3;\r\nuart_rate = 40000000;\r\n} else if (soc_is_rt5350()) {\r\nt = (t >> RT5350_SYSCFG0_CPUCLK_SHIFT) &\r\nRT5350_SYSCFG0_CPUCLK_MASK;\r\nswitch (t) {\r\ncase RT5350_SYSCFG0_CPUCLK_360:\r\ncpu_rate = 360000000;\r\nsys_rate = cpu_rate / 3;\r\nbreak;\r\ncase RT5350_SYSCFG0_CPUCLK_320:\r\ncpu_rate = 320000000;\r\nsys_rate = cpu_rate / 4;\r\nbreak;\r\ncase RT5350_SYSCFG0_CPUCLK_300:\r\ncpu_rate = 300000000;\r\nsys_rate = cpu_rate / 3;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nuart_rate = 40000000;\r\nwdt_rate = sys_rate;\r\n} else {\r\nBUG();\r\n}\r\nif (soc_is_rt3352() || soc_is_rt5350()) {\r\nu32 val = rt_sysc_r32(RT3352_SYSC_REG_SYSCFG0);\r\nif (!(val & RT3352_CLKCFG0_XTAL_SEL))\r\nwmac_rate = 20000000;\r\n}\r\nralink_clk_add("cpu", cpu_rate);\r\nralink_clk_add("10000b00.spi", sys_rate);\r\nralink_clk_add("10000100.timer", wdt_rate);\r\nralink_clk_add("10000120.watchdog", wdt_rate);\r\nralink_clk_add("10000500.uart", uart_rate);\r\nralink_clk_add("10000c00.uartlite", uart_rate);\r\nralink_clk_add("10100000.ethernet", sys_rate);\r\nralink_clk_add("10180000.wmac", wmac_rate);\r\n}\r\nvoid __init ralink_of_remap(void)\r\n{\r\nrt_sysc_membase = plat_of_remap_node("ralink,rt3050-sysc");\r\nrt_memc_membase = plat_of_remap_node("ralink,rt3050-memc");\r\nif (!rt_sysc_membase || !rt_memc_membase)\r\npanic("Failed to remap core resources");\r\n}\r\nvoid prom_soc_init(struct ralink_soc_info *soc_info)\r\n{\r\nvoid __iomem *sysc = (void __iomem *) KSEG1ADDR(RT305X_SYSC_BASE);\r\nunsigned char *name;\r\nu32 n0;\r\nu32 n1;\r\nu32 id;\r\nn0 = __raw_readl(sysc + SYSC_REG_CHIP_NAME0);\r\nn1 = __raw_readl(sysc + SYSC_REG_CHIP_NAME1);\r\nif (n0 == RT3052_CHIP_NAME0 && n1 == RT3052_CHIP_NAME1) {\r\nunsigned long icache_sets;\r\nicache_sets = (read_c0_config1() >> 22) & 7;\r\nif (icache_sets == 1) {\r\nrt305x_soc = RT305X_SOC_RT3050;\r\nname = "RT3050";\r\nsoc_info->compatible = "ralink,rt3050-soc";\r\n} else {\r\nrt305x_soc = RT305X_SOC_RT3052;\r\nname = "RT3052";\r\nsoc_info->compatible = "ralink,rt3052-soc";\r\n}\r\n} else if (n0 == RT3350_CHIP_NAME0 && n1 == RT3350_CHIP_NAME1) {\r\nrt305x_soc = RT305X_SOC_RT3350;\r\nname = "RT3350";\r\nsoc_info->compatible = "ralink,rt3350-soc";\r\n} else if (n0 == RT3352_CHIP_NAME0 && n1 == RT3352_CHIP_NAME1) {\r\nrt305x_soc = RT305X_SOC_RT3352;\r\nname = "RT3352";\r\nsoc_info->compatible = "ralink,rt3352-soc";\r\n} else if (n0 == RT5350_CHIP_NAME0 && n1 == RT5350_CHIP_NAME1) {\r\nrt305x_soc = RT305X_SOC_RT5350;\r\nname = "RT5350";\r\nsoc_info->compatible = "ralink,rt5350-soc";\r\n} else {\r\npanic("rt305x: unknown SoC, n0:%08x n1:%08x", n0, n1);\r\n}\r\nid = __raw_readl(sysc + SYSC_REG_CHIP_ID);\r\nsnprintf(soc_info->sys_type, RAMIPS_SYS_TYPE_LEN,\r\n"Ralink %s id:%u rev:%u",\r\nname,\r\n(id >> CHIP_ID_ID_SHIFT) & CHIP_ID_ID_MASK,\r\n(id & CHIP_ID_REV_MASK));\r\nsoc_info->mem_base = RT305X_SDRAM_BASE;\r\nif (soc_is_rt5350()) {\r\nsoc_info->mem_size = rt5350_get_mem_size();\r\nrt2880_pinmux_data = rt5350_pinmux_data;\r\n} else if (soc_is_rt305x() || soc_is_rt3350()) {\r\nsoc_info->mem_size_min = RT305X_MEM_SIZE_MIN;\r\nsoc_info->mem_size_max = RT305X_MEM_SIZE_MAX;\r\nrt2880_pinmux_data = rt3050_pinmux_data;\r\n} else if (soc_is_rt3352()) {\r\nsoc_info->mem_size_min = RT3352_MEM_SIZE_MIN;\r\nsoc_info->mem_size_max = RT3352_MEM_SIZE_MAX;\r\nrt2880_pinmux_data = rt3352_pinmux_data;\r\n}\r\n}

static int st21nfca_hci_load_session(struct nfc_hci_dev *hdev)\r\n{\r\nint i, j, r;\r\nstruct sk_buff *skb_pipe_list, *skb_pipe_info;\r\nstruct st21nfca_pipe_info *info;\r\nu8 pipe_list[] = { ST21NFCA_DM_GETINFO_PIPE_LIST,\r\nNFC_HCI_TERMINAL_HOST_ID\r\n};\r\nu8 pipe_info[] = { ST21NFCA_DM_GETINFO_PIPE_INFO,\r\nNFC_HCI_TERMINAL_HOST_ID, 0\r\n};\r\nr = nfc_hci_connect_gate(hdev, NFC_HCI_HOST_CONTROLLER_ID,\r\nST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_DEVICE_MGNT_PIPE);\r\nif (r < 0)\r\ngoto free_info;\r\nr = nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_DM_GETINFO, pipe_list, sizeof(pipe_list),\r\n&skb_pipe_list);\r\nif (r < 0)\r\ngoto free_info;\r\nfor (i = 0; i < skb_pipe_list->len; i++) {\r\npipe_info[2] = skb_pipe_list->data[i];\r\nr = nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_DM_GETINFO, pipe_info,\r\nsizeof(pipe_info), &skb_pipe_info);\r\nif (r)\r\ncontinue;\r\ninfo = (struct st21nfca_pipe_info *) skb_pipe_info->data;\r\nif (info->dst_gate_id == ST21NFCA_APDU_READER_GATE &&\r\ninfo->src_host_id != ST21NFCA_ESE_HOST_ID) {\r\npr_err("Unexpected apdu_reader pipe on host %x\n",\r\ninfo->src_host_id);\r\ncontinue;\r\n}\r\nfor (j = 0; (j < ARRAY_SIZE(st21nfca_gates)) &&\r\n(st21nfca_gates[j].gate != info->dst_gate_id) ; j++)\r\n;\r\nif (j < ARRAY_SIZE(st21nfca_gates) &&\r\nst21nfca_gates[j].gate == info->dst_gate_id &&\r\nST21NFCA_DM_IS_PIPE_OPEN(info->pipe_state)) {\r\nst21nfca_gates[j].pipe = pipe_info[2];\r\nhdev->gate2pipe[st21nfca_gates[j].gate] =\r\nst21nfca_gates[j].pipe;\r\nhdev->pipes[st21nfca_gates[j].pipe].gate =\r\nst21nfca_gates[j].gate;\r\nhdev->pipes[st21nfca_gates[j].pipe].dest_host =\r\ninfo->src_host_id;\r\n}\r\n}\r\nif (skb_pipe_list->len + 3 < ARRAY_SIZE(st21nfca_gates)) {\r\nfor (i = skb_pipe_list->len + 3;\r\ni < ARRAY_SIZE(st21nfca_gates) - 2; i++) {\r\nr = nfc_hci_connect_gate(hdev,\r\nNFC_HCI_HOST_CONTROLLER_ID,\r\nst21nfca_gates[i].gate,\r\nst21nfca_gates[i].pipe);\r\nif (r < 0)\r\ngoto free_info;\r\n}\r\n}\r\nmemcpy(hdev->init_data.gates, st21nfca_gates, sizeof(st21nfca_gates));\r\nfree_info:\r\nkfree_skb(skb_pipe_info);\r\nkfree_skb(skb_pipe_list);\r\nreturn r;\r\n}\r\nstatic int st21nfca_hci_open(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nint r;\r\nmutex_lock(&info->info_lock);\r\nif (info->state != ST21NFCA_ST_COLD) {\r\nr = -EBUSY;\r\ngoto out;\r\n}\r\nr = info->phy_ops->enable(info->phy_id);\r\nif (r == 0)\r\ninfo->state = ST21NFCA_ST_READY;\r\nout:\r\nmutex_unlock(&info->info_lock);\r\nreturn r;\r\n}\r\nstatic void st21nfca_hci_close(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nmutex_lock(&info->info_lock);\r\nif (info->state == ST21NFCA_ST_COLD)\r\ngoto out;\r\ninfo->phy_ops->disable(info->phy_id);\r\ninfo->state = ST21NFCA_ST_COLD;\r\nout:\r\nmutex_unlock(&info->info_lock);\r\n}\r\nstatic int st21nfca_hci_ready(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nstruct sk_buff *skb;\r\nu8 param;\r\nu8 white_list[2];\r\nint wl_size = 0;\r\nint r;\r\nif (info->se_status->is_ese_present &&\r\ninfo->se_status->is_uicc_present) {\r\nwhite_list[wl_size++] = NFC_HCI_UICC_HOST_ID;\r\nwhite_list[wl_size++] = ST21NFCA_ESE_HOST_ID;\r\n} else if (!info->se_status->is_ese_present &&\r\ninfo->se_status->is_uicc_present) {\r\nwhite_list[wl_size++] = NFC_HCI_UICC_HOST_ID;\r\n} else if (info->se_status->is_ese_present &&\r\n!info->se_status->is_uicc_present) {\r\nwhite_list[wl_size++] = ST21NFCA_ESE_HOST_ID;\r\n}\r\nif (wl_size) {\r\nr = nfc_hci_set_param(hdev, NFC_HCI_ADMIN_GATE,\r\nNFC_HCI_ADMIN_WHITELIST,\r\n(u8 *) &white_list, wl_size);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nr = nfc_hci_get_param(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_NFC_MODE, &skb);\r\nif (r < 0)\r\nreturn r;\r\nparam = skb->data[0];\r\nkfree_skb(skb);\r\nif (param == 0) {\r\nparam = 1;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_NFC_MODE, &param, 1);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\r\nNFC_HCI_EVT_END_OPERATION, NULL, 0);\r\nif (r < 0)\r\nreturn r;\r\nr = nfc_hci_get_param(hdev, NFC_HCI_ID_MGMT_GATE,\r\nNFC_HCI_ID_MGMT_VERSION_SW, &skb);\r\nif (r < 0)\r\nreturn r;\r\nif (skb->len != FULL_VERSION_LEN) {\r\nkfree_skb(skb);\r\nreturn -EINVAL;\r\n}\r\nprint_hex_dump(KERN_DEBUG, "FULL VERSION SOFTWARE INFO: ",\r\nDUMP_PREFIX_NONE, 16, 1,\r\nskb->data, FULL_VERSION_LEN, false);\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic int st21nfca_hci_xmit(struct nfc_hci_dev *hdev, struct sk_buff *skb)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nreturn info->phy_ops->write(info->phy_id, skb);\r\n}\r\nstatic int st21nfca_hci_start_poll(struct nfc_hci_dev *hdev,\r\nu32 im_protocols, u32 tm_protocols)\r\n{\r\nint r;\r\nu32 pol_req;\r\nu8 param[19];\r\nstruct sk_buff *datarate_skb;\r\npr_info(DRIVER_DESC ": %s protocols 0x%x 0x%x\n",\r\n__func__, im_protocols, tm_protocols);\r\nr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\r\nNFC_HCI_EVT_END_OPERATION, NULL, 0);\r\nif (r < 0)\r\nreturn r;\r\nif (im_protocols) {\r\nif ((NFC_HCI_RF_READER_B_GATE & im_protocols) == 0) {\r\nr = nfc_hci_disconnect_gate(hdev,\r\nNFC_HCI_RF_READER_B_GATE);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nif ((NFC_HCI_RF_READER_A_GATE & im_protocols) == 0) {\r\nr = nfc_hci_disconnect_gate(hdev,\r\nNFC_HCI_RF_READER_A_GATE);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nif ((ST21NFCA_RF_READER_F_GATE & im_protocols) == 0) {\r\nr = nfc_hci_disconnect_gate(hdev,\r\nST21NFCA_RF_READER_F_GATE);\r\nif (r < 0)\r\nreturn r;\r\n} else {\r\nhdev->gb = nfc_get_local_general_bytes(hdev->ndev,\r\n&hdev->gb_len);\r\nif (hdev->gb == NULL || hdev->gb_len == 0) {\r\nim_protocols &= ~NFC_PROTO_NFC_DEP_MASK;\r\ntm_protocols &= ~NFC_PROTO_NFC_DEP_MASK;\r\n}\r\nparam[0] = ST21NFCA_RF_READER_F_DATARATE_106 |\r\nST21NFCA_RF_READER_F_DATARATE_212 |\r\nST21NFCA_RF_READER_F_DATARATE_424;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_RF_READER_F_DATARATE,\r\nparam, 1);\r\nif (r < 0)\r\nreturn r;\r\npol_req = be32_to_cpu((__force __be32)\r\nST21NFCA_RF_READER_F_POL_REQ_DEFAULT);\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_RF_READER_F_POL_REQ,\r\n(u8 *) &pol_req, 4);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nif ((ST21NFCA_RF_READER_14443_3_A_GATE & im_protocols) == 0) {\r\nr = nfc_hci_disconnect_gate(hdev,\r\nST21NFCA_RF_READER_14443_3_A_GATE);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nif ((ST21NFCA_RF_READER_ISO15693_GATE & im_protocols) == 0) {\r\nr = nfc_hci_disconnect_gate(hdev,\r\nST21NFCA_RF_READER_ISO15693_GATE);\r\nif (r < 0)\r\nreturn r;\r\n}\r\nr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\r\nNFC_HCI_EVT_READER_REQUESTED, NULL, 0);\r\nif (r < 0)\r\nnfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\r\nNFC_HCI_EVT_END_OPERATION, NULL, 0);\r\n}\r\nif (tm_protocols & NFC_PROTO_NFC_DEP_MASK) {\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_DATARATE,\r\n&datarate_skb);\r\nif (r < 0)\r\nreturn r;\r\nif (datarate_skb->len > 0 &&\r\ndatarate_skb->data[0] !=\r\nST21NFCA_RF_CARD_F_DATARATE_212_424) {\r\nparam[0] = ST21NFCA_RF_CARD_F_DATARATE_212_424;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_DATARATE,\r\nparam, 1);\r\nif (r < 0) {\r\nkfree_skb(datarate_skb);\r\nreturn r;\r\n}\r\n}\r\nkfree_skb(datarate_skb);\r\nparam[0] = 0x00;\r\nparam[1] = 0x08;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_SENS_RES, param, 2);\r\nif (r < 0)\r\nreturn r;\r\nparam[0] = 0x40;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_SEL_RES, param, 1);\r\nif (r < 0)\r\nreturn r;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_NFCID1, NULL, 0);\r\nif (r < 0)\r\nreturn r;\r\nparam[0] = 0x00;\r\nparam[1] = 0x00;\r\nparam[2] = 0x01;\r\nparam[3] = 0xfe;\r\nparam[4] = 'S';\r\nparam[5] = 'T';\r\nparam[6] = 'M';\r\nparam[7] = 'i';\r\nparam[8] = 'c';\r\nparam[9] = 'r';\r\nparam[18] = 0x01;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_NFCID2_LIST, param,\r\n19);\r\nif (r < 0)\r\nreturn r;\r\nparam[0] = 0x02;\r\nr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\r\nST21NFCA_RF_CARD_F_MODE, param, 1);\r\n}\r\nreturn r;\r\n}\r\nstatic void st21nfca_hci_stop_poll(struct nfc_hci_dev *hdev)\r\n{\r\nnfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_DM_DISCONNECT, NULL, 0, NULL);\r\n}\r\nstatic int st21nfca_get_iso14443_3_atqa(struct nfc_hci_dev *hdev, u16 *atqa)\r\n{\r\nint r;\r\nstruct sk_buff *atqa_skb = NULL;\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\r\nST21NFCA_RF_READER_14443_3_A_ATQA, &atqa_skb);\r\nif (r < 0)\r\ngoto exit;\r\nif (atqa_skb->len != 2) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\n*atqa = be16_to_cpu(*(__be16 *) atqa_skb->data);\r\nexit:\r\nkfree_skb(atqa_skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_get_iso14443_3_sak(struct nfc_hci_dev *hdev, u8 *sak)\r\n{\r\nint r;\r\nstruct sk_buff *sak_skb = NULL;\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\r\nST21NFCA_RF_READER_14443_3_A_SAK, &sak_skb);\r\nif (r < 0)\r\ngoto exit;\r\nif (sak_skb->len != 1) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\n*sak = sak_skb->data[0];\r\nexit:\r\nkfree_skb(sak_skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_get_iso14443_3_uid(struct nfc_hci_dev *hdev, u8 *uid,\r\nint *len)\r\n{\r\nint r;\r\nstruct sk_buff *uid_skb = NULL;\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\r\nST21NFCA_RF_READER_14443_3_A_UID, &uid_skb);\r\nif (r < 0)\r\ngoto exit;\r\nif (uid_skb->len == 0 || uid_skb->len > NFC_NFCID1_MAXSIZE) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nmemcpy(uid, uid_skb->data, uid_skb->len);\r\n*len = uid_skb->len;\r\nexit:\r\nkfree_skb(uid_skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_get_iso15693_inventory(struct nfc_hci_dev *hdev,\r\nstruct nfc_target *target)\r\n{\r\nint r;\r\nstruct sk_buff *inventory_skb = NULL;\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_ISO15693_GATE,\r\nST21NFCA_RF_READER_ISO15693_INVENTORY,\r\n&inventory_skb);\r\nif (r < 0)\r\ngoto exit;\r\nskb_pull(inventory_skb, 2);\r\nif (inventory_skb->len == 0 ||\r\ninventory_skb->len > NFC_ISO15693_UID_MAXSIZE) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nmemcpy(target->iso15693_uid, inventory_skb->data, inventory_skb->len);\r\ntarget->iso15693_dsfid = inventory_skb->data[1];\r\ntarget->is_iso15693 = 1;\r\nexit:\r\nkfree_skb(inventory_skb);\r\nreturn r;\r\n}\r\nstatic int st21nfca_hci_dep_link_up(struct nfc_hci_dev *hdev,\r\nstruct nfc_target *target, u8 comm_mode,\r\nu8 *gb, size_t gb_len)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ninfo->dep_info.idx = target->idx;\r\nreturn st21nfca_im_send_atr_req(hdev, gb, gb_len);\r\n}\r\nstatic int st21nfca_hci_dep_link_down(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ninfo->state = ST21NFCA_ST_READY;\r\nreturn nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_DM_DISCONNECT, NULL, 0, NULL);\r\n}\r\nstatic int st21nfca_hci_target_from_gate(struct nfc_hci_dev *hdev, u8 gate,\r\nstruct nfc_target *target)\r\n{\r\nint r, len;\r\nu16 atqa;\r\nu8 sak;\r\nu8 uid[NFC_NFCID1_MAXSIZE];\r\nswitch (gate) {\r\ncase ST21NFCA_RF_READER_F_GATE:\r\ntarget->supported_protocols = NFC_PROTO_FELICA_MASK;\r\nbreak;\r\ncase ST21NFCA_RF_READER_14443_3_A_GATE:\r\nr = st21nfca_get_iso14443_3_atqa(hdev, &atqa);\r\nif (r < 0)\r\nreturn r;\r\nif (atqa == 0x000c) {\r\ntarget->supported_protocols = NFC_PROTO_JEWEL_MASK;\r\ntarget->sens_res = 0x0c00;\r\n} else {\r\nr = st21nfca_get_iso14443_3_sak(hdev, &sak);\r\nif (r < 0)\r\nreturn r;\r\nr = st21nfca_get_iso14443_3_uid(hdev, uid, &len);\r\nif (r < 0)\r\nreturn r;\r\ntarget->supported_protocols =\r\nnfc_hci_sak_to_protocol(sak);\r\nif (target->supported_protocols == 0xffffffff)\r\nreturn -EPROTO;\r\ntarget->sens_res = atqa;\r\ntarget->sel_res = sak;\r\nmemcpy(target->nfcid1, uid, len);\r\ntarget->nfcid1_len = len;\r\n}\r\nbreak;\r\ncase ST21NFCA_RF_READER_ISO15693_GATE:\r\ntarget->supported_protocols = NFC_PROTO_ISO15693_MASK;\r\nr = st21nfca_get_iso15693_inventory(hdev, target);\r\nif (r < 0)\r\nreturn r;\r\nbreak;\r\ndefault:\r\nreturn -EPROTO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st21nfca_hci_complete_target_discovered(struct nfc_hci_dev *hdev,\r\nu8 gate,\r\nstruct nfc_target *target)\r\n{\r\nint r;\r\nstruct sk_buff *nfcid_skb = NULL;\r\nif (gate == ST21NFCA_RF_READER_F_GATE) {\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_RF_READER_F_NFCID2, &nfcid_skb);\r\nif (r < 0)\r\ngoto exit;\r\nif (nfcid_skb->len > NFC_SENSF_RES_MAXSIZE) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nif (nfcid_skb->len > 0) {\r\nmemcpy(target->sensf_res, nfcid_skb->data,\r\nnfcid_skb->len);\r\ntarget->sensf_res_len = nfcid_skb->len;\r\nif (target->sensf_res[0] == 0x01 &&\r\ntarget->sensf_res[1] == 0xfe)\r\ntarget->supported_protocols =\r\nNFC_PROTO_NFC_DEP_MASK;\r\nelse\r\ntarget->supported_protocols =\r\nNFC_PROTO_FELICA_MASK;\r\n} else {\r\nkfree_skb(nfcid_skb);\r\nr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_F_GATE,\r\nST21NFCA_RF_READER_F_NFCID1,\r\n&nfcid_skb);\r\nif (r < 0)\r\ngoto exit;\r\nif (nfcid_skb->len > NFC_NFCID1_MAXSIZE) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nmemcpy(target->sensf_res, nfcid_skb->data,\r\nnfcid_skb->len);\r\ntarget->sensf_res_len = nfcid_skb->len;\r\ntarget->supported_protocols = NFC_PROTO_NFC_DEP_MASK;\r\n}\r\ntarget->hci_reader_gate = ST21NFCA_RF_READER_F_GATE;\r\n}\r\nr = 1;\r\nexit:\r\nkfree_skb(nfcid_skb);\r\nreturn r;\r\n}\r\nstatic void st21nfca_hci_data_exchange_cb(void *context, struct sk_buff *skb,\r\nint err)\r\n{\r\nstruct st21nfca_hci_info *info = context;\r\nswitch (info->async_cb_type) {\r\ncase ST21NFCA_CB_TYPE_READER_ISO15693:\r\nif (err == 0)\r\nskb_trim(skb, skb->len - 1);\r\ninfo->async_cb(info->async_cb_context, skb, err);\r\nbreak;\r\ndefault:\r\nif (err == 0)\r\nkfree_skb(skb);\r\nbreak;\r\n}\r\n}\r\nstatic int st21nfca_hci_im_transceive(struct nfc_hci_dev *hdev,\r\nstruct nfc_target *target,\r\nstruct sk_buff *skb,\r\ndata_exchange_cb_t cb, void *cb_context)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\npr_info(DRIVER_DESC ": %s for gate=%d len=%d\n", __func__,\r\ntarget->hci_reader_gate, skb->len);\r\nswitch (target->hci_reader_gate) {\r\ncase ST21NFCA_RF_READER_F_GATE:\r\nif (target->supported_protocols == NFC_PROTO_NFC_DEP_MASK)\r\nreturn st21nfca_im_send_dep_req(hdev, skb);\r\n*skb_push(skb, 1) = 0x1a;\r\nreturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\r\nST21NFCA_WR_XCHG_DATA, skb->data,\r\nskb->len, cb, cb_context);\r\ncase ST21NFCA_RF_READER_14443_3_A_GATE:\r\n*skb_push(skb, 1) = 0x1a;\r\nreturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\r\nST21NFCA_WR_XCHG_DATA, skb->data,\r\nskb->len, cb, cb_context);\r\ncase ST21NFCA_RF_READER_ISO15693_GATE:\r\ninfo->async_cb_type = ST21NFCA_CB_TYPE_READER_ISO15693;\r\ninfo->async_cb = cb;\r\ninfo->async_cb_context = cb_context;\r\n*skb_push(skb, 1) = 0x17;\r\nreturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\r\nST21NFCA_WR_XCHG_DATA, skb->data,\r\nskb->len,\r\nst21nfca_hci_data_exchange_cb,\r\ninfo);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\n}\r\nstatic int st21nfca_hci_tm_send(struct nfc_hci_dev *hdev, struct sk_buff *skb)\r\n{\r\nreturn st21nfca_tm_send_dep_res(hdev, skb);\r\n}\r\nstatic int st21nfca_hci_check_presence(struct nfc_hci_dev *hdev,\r\nstruct nfc_target *target)\r\n{\r\nu8 fwi = 0x11;\r\nswitch (target->hci_reader_gate) {\r\ncase NFC_HCI_RF_READER_A_GATE:\r\ncase NFC_HCI_RF_READER_B_GATE:\r\nreturn nfc_hci_send_cmd(hdev, target->hci_reader_gate,\r\nST21NFCA_WR_XCHG_DATA, &fwi, 1, NULL);\r\ncase ST21NFCA_RF_READER_14443_3_A_GATE:\r\nreturn nfc_hci_send_cmd(hdev, target->hci_reader_gate,\r\nST21NFCA_RF_READER_CMD_PRESENCE_CHECK,\r\nNULL, 0, NULL);\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic void st21nfca_hci_cmd_received(struct nfc_hci_dev *hdev, u8 pipe, u8 cmd,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nu8 gate = hdev->pipes[pipe].gate;\r\npr_debug("cmd: %x\n", cmd);\r\nswitch (cmd) {\r\ncase NFC_HCI_ANY_OPEN_PIPE:\r\nif (gate != ST21NFCA_APDU_READER_GATE &&\r\nhdev->pipes[pipe].dest_host != NFC_HCI_UICC_HOST_ID)\r\ninfo->se_info.count_pipes++;\r\nif (info->se_info.count_pipes == info->se_info.expected_pipes) {\r\ndel_timer_sync(&info->se_info.se_active_timer);\r\ninfo->se_info.se_active = false;\r\ninfo->se_info.count_pipes = 0;\r\ncomplete(&info->se_info.req_completion);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int st21nfca_admin_event_received(struct nfc_hci_dev *hdev, u8 event,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\npr_debug("admin event: %x\n", event);\r\nswitch (event) {\r\ncase ST21NFCA_EVT_HOT_PLUG:\r\nif (info->se_info.se_active) {\r\nif (!ST21NFCA_EVT_HOT_PLUG_IS_INHIBITED(skb)) {\r\ndel_timer_sync(&info->se_info.se_active_timer);\r\ninfo->se_info.se_active = false;\r\ncomplete(&info->se_info.req_completion);\r\n} else {\r\nmod_timer(&info->se_info.se_active_timer,\r\njiffies +\r\nmsecs_to_jiffies(ST21NFCA_SE_TO_PIPES));\r\n}\r\n}\r\nbreak;\r\n}\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic int st21nfca_hci_event_received(struct nfc_hci_dev *hdev, u8 pipe,\r\nu8 event, struct sk_buff *skb)\r\n{\r\nu8 gate = hdev->pipes[pipe].gate;\r\nu8 host = hdev->pipes[pipe].dest_host;\r\npr_debug("hci event: %d gate: %x\n", event, gate);\r\nswitch (gate) {\r\ncase NFC_HCI_ADMIN_GATE:\r\nreturn st21nfca_admin_event_received(hdev, event, skb);\r\ncase ST21NFCA_RF_CARD_F_GATE:\r\nreturn st21nfca_dep_event_received(hdev, event, skb);\r\ncase ST21NFCA_CONNECTIVITY_GATE:\r\nreturn st21nfca_connectivity_event_received(hdev, host,\r\nevent, skb);\r\ncase ST21NFCA_APDU_READER_GATE:\r\nreturn st21nfca_apdu_reader_event_received(hdev, event, skb);\r\ndefault:\r\nreturn 1;\r\n}\r\n}\r\nint st21nfca_hci_probe(void *phy_id, struct nfc_phy_ops *phy_ops,\r\nchar *llc_name, int phy_headroom, int phy_tailroom,\r\nint phy_payload, struct nfc_hci_dev **hdev,\r\nstruct st21nfca_se_status *se_status)\r\n{\r\nstruct st21nfca_hci_info *info;\r\nint r = 0;\r\nint dev_num;\r\nu32 protocols;\r\nstruct nfc_hci_init_data init_data;\r\nunsigned long quirks = 0;\r\ninfo = kzalloc(sizeof(struct st21nfca_hci_info), GFP_KERNEL);\r\nif (!info) {\r\nr = -ENOMEM;\r\ngoto err_alloc_hdev;\r\n}\r\ninfo->phy_ops = phy_ops;\r\ninfo->phy_id = phy_id;\r\ninfo->state = ST21NFCA_ST_COLD;\r\nmutex_init(&info->info_lock);\r\ninit_data.gate_count = ARRAY_SIZE(st21nfca_gates);\r\nmemcpy(init_data.gates, st21nfca_gates, sizeof(st21nfca_gates));\r\ndev_num = find_first_zero_bit(dev_mask, ST21NFCA_NUM_DEVICES);\r\nif (dev_num >= ST21NFCA_NUM_DEVICES)\r\nreturn -ENODEV;\r\nset_bit(dev_num, dev_mask);\r\nscnprintf(init_data.session_id, sizeof(init_data.session_id), "%s%2x",\r\n"ST21AH", dev_num);\r\nprotocols = NFC_PROTO_JEWEL_MASK |\r\nNFC_PROTO_MIFARE_MASK |\r\nNFC_PROTO_FELICA_MASK |\r\nNFC_PROTO_ISO14443_MASK |\r\nNFC_PROTO_ISO14443_B_MASK |\r\nNFC_PROTO_ISO15693_MASK |\r\nNFC_PROTO_NFC_DEP_MASK;\r\nset_bit(NFC_HCI_QUIRK_SHORT_CLEAR, &quirks);\r\ninfo->hdev =\r\nnfc_hci_allocate_device(&st21nfca_hci_ops, &init_data, quirks,\r\nprotocols, llc_name,\r\nphy_headroom + ST21NFCA_CMDS_HEADROOM,\r\nphy_tailroom, phy_payload);\r\nif (!info->hdev) {\r\npr_err("Cannot allocate nfc hdev.\n");\r\nr = -ENOMEM;\r\ngoto err_alloc_hdev;\r\n}\r\ninfo->se_status = se_status;\r\nnfc_hci_set_clientdata(info->hdev, info);\r\nr = nfc_hci_register_device(info->hdev);\r\nif (r)\r\ngoto err_regdev;\r\n*hdev = info->hdev;\r\nst21nfca_dep_init(info->hdev);\r\nst21nfca_se_init(info->hdev);\r\nreturn 0;\r\nerr_regdev:\r\nnfc_hci_free_device(info->hdev);\r\nerr_alloc_hdev:\r\nkfree(info);\r\nreturn r;\r\n}\r\nvoid st21nfca_hci_remove(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nst21nfca_dep_deinit(hdev);\r\nst21nfca_se_deinit(hdev);\r\nnfc_hci_unregister_device(hdev);\r\nnfc_hci_free_device(hdev);\r\nkfree(info);\r\n}

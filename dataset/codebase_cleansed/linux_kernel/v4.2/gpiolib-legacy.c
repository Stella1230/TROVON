void gpio_free(unsigned gpio)\r\n{\r\ngpiod_free(gpio_to_desc(gpio));\r\n}\r\nint gpio_request_one(unsigned gpio, unsigned long flags, const char *label)\r\n{\r\nstruct gpio_desc *desc;\r\nint err;\r\ndesc = gpio_to_desc(gpio);\r\nif (!desc && gpio_is_valid(gpio))\r\nreturn -EPROBE_DEFER;\r\nerr = gpiod_request(desc, label);\r\nif (err)\r\nreturn err;\r\nif (flags & GPIOF_OPEN_DRAIN)\r\nset_bit(FLAG_OPEN_DRAIN, &desc->flags);\r\nif (flags & GPIOF_OPEN_SOURCE)\r\nset_bit(FLAG_OPEN_SOURCE, &desc->flags);\r\nif (flags & GPIOF_ACTIVE_LOW)\r\nset_bit(FLAG_ACTIVE_LOW, &desc->flags);\r\nif (flags & GPIOF_DIR_IN)\r\nerr = gpiod_direction_input(desc);\r\nelse\r\nerr = gpiod_direction_output_raw(desc,\r\n(flags & GPIOF_INIT_HIGH) ? 1 : 0);\r\nif (err)\r\ngoto free_gpio;\r\nif (flags & GPIOF_EXPORT) {\r\nerr = gpiod_export(desc, flags & GPIOF_EXPORT_CHANGEABLE);\r\nif (err)\r\ngoto free_gpio;\r\n}\r\nreturn 0;\r\nfree_gpio:\r\ngpiod_free(desc);\r\nreturn err;\r\n}\r\nint gpio_request(unsigned gpio, const char *label)\r\n{\r\nstruct gpio_desc *desc = gpio_to_desc(gpio);\r\nif (!desc && gpio_is_valid(gpio))\r\nreturn -EPROBE_DEFER;\r\nreturn gpiod_request(desc, label);\r\n}\r\nint gpio_request_array(const struct gpio *array, size_t num)\r\n{\r\nint i, err;\r\nfor (i = 0; i < num; i++, array++) {\r\nerr = gpio_request_one(array->gpio, array->flags, array->label);\r\nif (err)\r\ngoto err_free;\r\n}\r\nreturn 0;\r\nerr_free:\r\nwhile (i--)\r\ngpio_free((--array)->gpio);\r\nreturn err;\r\n}\r\nvoid gpio_free_array(const struct gpio *array, size_t num)\r\n{\r\nwhile (num--)\r\ngpio_free((array++)->gpio);\r\n}

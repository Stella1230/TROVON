static int usbhsf_get_id(struct platform_device *pdev)\r\n{\r\nreturn USBHS_GADGET;\r\n}\r\nstatic int usbhsf_power_ctrl(struct platform_device *pdev,\r\nvoid __iomem *base, int enable)\r\n{\r\nenable = !!enable;\r\nr8a7778_usb_phy_power(enable);\r\niowrite16(enable << 14, base + SUSPMODE);\r\nreturn 0;\r\n}\r\nstatic int rsnd_codec_power(int id, int enable)\r\n{\r\nstatic int sound_user[SOUND_MAX] = {0, 0, 0};\r\nint *usr = NULL;\r\nu32 bit;\r\nswitch (id) {\r\ncase 3:\r\ncase 4:\r\nusr = sound_user + AK4554_34;\r\nbit = (1 << 10);\r\nbreak;\r\ncase 5:\r\ncase 6:\r\nusr = sound_user + AK4643_56;\r\nbit = (1 << 6);\r\nbreak;\r\ncase 7:\r\ncase 8:\r\nusr = sound_user + AK4554_78;\r\nbit = (1 << 7);\r\nbreak;\r\n}\r\nif (!usr)\r\nreturn -EIO;\r\nif (enable) {\r\nif (*usr == 0) {\r\nu32 val = ioread16(fpga + COMCTLR);\r\nval &= ~bit;\r\niowrite16(val, fpga + COMCTLR);\r\n}\r\n(*usr)++;\r\n} else {\r\nif (*usr == 0)\r\nreturn 0;\r\n(*usr)--;\r\nif (*usr == 0) {\r\nu32 val = ioread16(fpga + COMCTLR);\r\nval |= bit;\r\niowrite16(val, fpga + COMCTLR);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int rsnd_start(int id)\r\n{\r\nreturn rsnd_codec_power(id, 1);\r\n}\r\nstatic int rsnd_stop(int id)\r\n{\r\nreturn rsnd_codec_power(id, 0);\r\n}\r\nstatic void __init bockw_init(void)\r\n{\r\nvoid __iomem *base;\r\nstruct clk *clk;\r\nstruct platform_device *pdev;\r\nint i;\r\nr8a7778_clock_init();\r\nr8a7778_init_irq_extpin(1);\r\nr8a7778_add_standard_devices();\r\nplatform_device_register_full(&ether_info);\r\nplatform_device_register_full(&vin0_info);\r\nif (!IS_ENABLED(CONFIG_SH_ETH))\r\nplatform_device_register_full(&vin1_info);\r\nplatform_device_register_data(NULL, "soc-camera-pdrv", 0,\r\n&iclink0_ml86v7667,\r\nsizeof(iclink0_ml86v7667));\r\nplatform_device_register_data(NULL, "soc-camera-pdrv", 1,\r\n&iclink1_ml86v7667,\r\nsizeof(iclink1_ml86v7667));\r\ni2c_register_board_info(0, i2c0_devices,\r\nARRAY_SIZE(i2c0_devices));\r\nspi_register_board_info(spi_board_info,\r\nARRAY_SIZE(spi_board_info));\r\npinctrl_register_mappings(bockw_pinctrl_map,\r\nARRAY_SIZE(bockw_pinctrl_map));\r\nr8a7778_pinmux_init();\r\nplatform_device_register_resndata(\r\nNULL, "sh_mmcif", -1,\r\nmmc_resources, ARRAY_SIZE(mmc_resources),\r\n&sh_mmcif_plat, sizeof(struct sh_mmcif_plat_data));\r\nplatform_device_register_resndata(\r\nNULL, "rcar_usb_phy", -1,\r\nusb_phy_resources,\r\nARRAY_SIZE(usb_phy_resources),\r\n&usb_phy_platform_data,\r\nsizeof(struct rcar_phy_platform_data));\r\nregulator_register_fixed(0, dummy_supplies,\r\nARRAY_SIZE(dummy_supplies));\r\nregulator_register_always_on(1, "fixed-3.3V", fixed3v3_power_consumers,\r\nARRAY_SIZE(fixed3v3_power_consumers), 3300000);\r\nfpga = ioremap_nocache(FPGA, SZ_1M);\r\nif (fpga) {\r\nu16 val = ioread16(fpga + IRQ0MR);\r\nval &= ~(1 << 4);\r\niowrite16(val, fpga + IRQ0MR);\r\nplatform_device_register_resndata(\r\nNULL, "smsc911x", -1,\r\nsmsc911x_resources, ARRAY_SIZE(smsc911x_resources),\r\n&smsc911x_data, sizeof(smsc911x_data));\r\n}\r\nbase = ioremap_nocache(PFC, 0x200);\r\nif (base) {\r\niowrite32(ioread32(base + PUPR4) | (3 << 26), base + PUPR4);\r\niounmap(base);\r\nplatform_device_register_resndata(\r\nNULL, "sh_mobile_sdhi", 0,\r\nsdhi0_resources, ARRAY_SIZE(sdhi0_resources),\r\n&sdhi0_info, sizeof(struct tmio_mmc_data));\r\n}\r\nrsnd_codec_power(5, 1);\r\nplatform_device_register_simple(\r\n"ak4554-adc-dac", 0, NULL, 0);\r\nplatform_device_register_simple(\r\n"ak4554-adc-dac", 1, NULL, 0);\r\npdev = platform_device_register_resndata(\r\nNULL, "rcar_sound", -1,\r\nrsnd_resources, ARRAY_SIZE(rsnd_resources),\r\n&rsnd_info, sizeof(rsnd_info));\r\nclk = clk_get(&pdev->dev, "clk_b");\r\nclk_set_rate(clk, 24576000);\r\nclk_put(clk);\r\nfor (i = 0; i < ARRAY_SIZE(rsnd_card_info); i++) {\r\nstruct platform_device_info cardinfo = {\r\n.name = "asoc-simple-card",\r\n.id = i,\r\n.data = &rsnd_card_info[i],\r\n.size_data = sizeof(struct asoc_simple_card_info),\r\n.dma_mask = DMA_BIT_MASK(32),\r\n};\r\nplatform_device_register_full(&cardinfo);\r\n}\r\n}\r\nstatic void __init bockw_init_late(void)\r\n{\r\nr8a7778_init_late();\r\nADD_USB_FUNC_DEVICE_IF_POSSIBLE();\r\n}
